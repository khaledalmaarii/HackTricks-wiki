# WWW2Exec - \_\_malloc\_hook & \_\_free\_hook

<details>

<summary><strong>htARTE (HackTricks AWS Red Team ì „ë¬¸ê°€)ë¡œë¶€í„° AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ìš°ì„¸ìš”!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ê°€ HackTricksì— ê´‘ê³ ë˜ê¸¸ ì›í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ê³  ì‹¶ë‹¤ë©´ [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™œê·¸**](https://peass.creator-spring.com)ë¥¼ êµ¬ë§¤í•˜ì„¸ìš”
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ë‹¹ì‚¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
* **ğŸ’¬ [Discord ê·¸ë£¹](https://discord.gg/hRep4RUj7f)** ë˜ëŠ” [í…”ë ˆê·¸ë¨ ê·¸ë£¹](https://t.me/peass)ì— **ê°€ì…**í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ë¥¼ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **HackTricks** ë° **HackTricks Cloud** github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ **í•˜ì„¸ìš”.

</details>

## **Malloc Hook**

[GNU ê³µì‹ ì‚¬ì´íŠ¸](https://www.gnu.org/software/libc/manual/html\_node/Hooks-for-Malloc.html)ì— ë”°ë¥´ë©´ **`__malloc_hook`** ë³€ìˆ˜ëŠ” `malloc()`ì´ í˜¸ì¶œë  ë•Œ **í˜¸ì¶œë  í•¨ìˆ˜ì˜ ì£¼ì†Œë¥¼ ê°€ë¦¬í‚¤ëŠ” í¬ì¸í„°**ë¡œ, **libc ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ ë°ì´í„° ì„¹ì…˜ì— ì €ì¥**ë©ë‹ˆë‹¤. ë”°ë¼ì„œ ì´ ì£¼ì†Œê°€ ë®ì–´ì“°ì—¬ì§€ê³  `malloc`ì´ í˜¸ì¶œë˜ë©´, ì˜ˆë¥¼ ë“¤ì–´ **One Gadget**ì´ í˜¸ì¶œë©ë‹ˆë‹¤.

mallocì„ í˜¸ì¶œí•˜ëŠ” ë°©ë²•ì€ í”„ë¡œê·¸ë¨ì´ í˜¸ì¶œí•  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ê±°ë‚˜, **`printf("%10000$c")`ë¥¼ í˜¸ì¶œ**í•˜ì—¬ `libc`ê°€ ë§ì€ ë°”ì´íŠ¸ë¥¼ í• ë‹¹í•˜ë„ë¡ ë§Œë“¤ì–´ í™ì— í• ë‹¹í•˜ë„ë¡ í•˜ëŠ” ê²ƒì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.

One Gadgetì— ëŒ€í•œ ìì„¸í•œ ì •ë³´ëŠ”:

{% content-ref url="../rop-return-oriented-programing/ret2lib/one-gadget.md" %}
[one-gadget.md](../rop-return-oriented-programing/ret2lib/one-gadget.md)
{% endcontent-ref %}

{% hint style="warning" %}
í›…ì€ **GLIBC >= 2.34**ì—ì„œ **ë¹„í™œì„±í™”**ë©ë‹ˆë‹¤. ìµœì‹  GLIBC ë²„ì „ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë‹¤ë¥¸ ê¸°ìˆ ì´ ìˆìŠµë‹ˆë‹¤. ì°¸ì¡°: [https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md).
{% endhint %}

## Free Hook

ì´ê²ƒì€ í˜ì´ì§€ì—ì„œ ë¹ ë¥¸ ë°”ì´ë„ˆë¦¬ ê³µê²©ì„ ë‚¨ìš©í•œ í›„ ì •ë ¬ë˜ì§€ ì•Šì€ ë°”ì´ë„ˆë¦¬ ê³µê²©ì„ ë‚¨ìš©í•œ ì˜ˆì œ ì¤‘ í•˜ë‚˜ì—ì„œ ë‚¨ìš©ë˜ì—ˆìŠµë‹ˆë‹¤:

{% content-ref url="../libc-heap/unsorted-bin-attack.md" %}
[unsorted-bin-attack.md](../libc-heap/unsorted-bin-attack.md)
{% endcontent-ref %}

ì‹¬ë³¼ì´ ìˆëŠ” ê²½ìš° ì´ì§„ íŒŒì¼ì˜ free hook ìœ„ì¹˜ë¥¼ ì°¾ëŠ” ì¢‹ì€ íŠ¸ë¦­ì€ **ë‹¤ìŒê³¼ ê°™ì´** í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤:
```
gefâ¤  set __free_hook = 0xfacade
gefâ¤  search-pattern 0xfacade
```
ë™ì¼í•œ ê²Œì‹œë¬¼ì—ì„œ ì‹¬ë³¼ ì—†ì´ free í›„í¬ì˜ ì£¼ì†Œë¥¼ ì°¾ëŠ” ë°©ë²•ì— ëŒ€í•œ ë‹¨ê³„ë³„ ê°€ì´ë“œë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìš”ì•½í•˜ë©´, free í•¨ìˆ˜ì—ì„œ:

<pre class="language-armasm"><code class="lang-armasm">gefâ¤  x/20i free
0xf75dedc0 &#x3C;free>: push   ebx
0xf75dedc1 &#x3C;free+1>: call   0xf768f625
0xf75dedc6 &#x3C;free+6>: add    ebx,0x14323a
0xf75dedcc &#x3C;free+12>:  sub    esp,0x8
0xf75dedcf &#x3C;free+15>:  mov    eax,DWORD PTR [ebx-0x98]
0xf75dedd5 &#x3C;free+21>:  mov    ecx,DWORD PTR [esp+0x10]
0xf75dedd9 &#x3C;free+25>:  mov    eax,DWORD PTR [eax]
<strong>0xf75deddb &#x3C;free+27>:  test   eax,eax ;&#x3C;--- ì—¬ê¸°ì„œ ì¤‘ë‹¨
</strong>0xf75deddd &#x3C;free+29>:  jne    0xf75dee50 &#x3C;free+144>
</code></pre>

ì´ì „ ì½”ë“œì˜ ì¤‘ë‹¨ì ì—ì„œ `$eax`ì— free í›„í¬ì˜ ì£¼ì†Œê°€ ìœ„ì¹˜í•©ë‹ˆë‹¤.

ì´ì œ **ë¹ ë¥¸ bin ê³µê²©**ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤:

* ë¨¼ì € **`__free_hook`** ìœ„ì¹˜ì—ì„œ í¬ê¸°ê°€ 200ì¸ ë¹ ë¥¸ **ì²­í¬**ë¥¼ ì‘ì—…í•  ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤:
* <pre class="language-c"><code class="lang-c">gefâ¤  p &#x26;__free_hook
$1 = (void (**)(void *, const void *)) 0x7ff1e9e607a8 &#x3C;__free_hook>
gefâ¤  x/60gx 0x7ff1e9e607a8 - 0x59
<strong>0x7ff1e9e6074f: 0x0000000000000000      0x0000000000000200
</strong>0x7ff1e9e6075f: 0x0000000000000000      0x0000000000000000
0x7ff1e9e6076f &#x3C;list_all_lock+15>:      0x0000000000000000      0x0000000000000000
0x7ff1e9e6077f &#x3C;_IO_stdfile_2_lock+15>: 0x0000000000000000      0x0000000000000000
</code></pre>
* ì´ ìœ„ì¹˜ì— í¬ê¸°ê°€ 0x200ì¸ ë¹ ë¥¸ ì²­í¬ë¥¼ ì–»ìœ¼ë©´ ì‹¤í–‰ë  í•¨ìˆ˜ í¬ì¸í„°ë¥¼ ë®ì–´ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* ì´ë¥¼ ìœ„í•´ í¬ê¸°ê°€ `0xfc`ì¸ ìƒˆë¡œìš´ ì²­í¬ë¥¼ ë§Œë“¤ê³  í•´ë‹¹ í¬ì¸í„°ë¡œ ë‘ ë²ˆ í˜¸ì¶œí•˜ì—¬ í¬ê¸°ê°€ `0xfc*2 = 0x1f8`ì¸ í•´ì œëœ ì²­í¬ì— ëŒ€í•œ í¬ì¸í„°ë¥¼ ì–»ìŠµë‹ˆë‹¤.
* ê·¸ëŸ° ë‹¤ìŒ, ì´ ì²­í¬ì—ì„œ **`fd`** ì£¼ì†Œë¥¼ ìˆ˜ì •í•˜ê¸° ìœ„í•´ í¸ì§‘ í•¨ìˆ˜ê°€ í˜¸ì¶œë©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ë¹ ë¥¸ binì˜ ì´ì „ **`__free_hook`** í•¨ìˆ˜ë¥¼ ê°€ë¦¬í‚¤ë„ë¡ í•©ë‹ˆë‹¤.
* ê·¸ëŸ° ë‹¤ìŒ, í¬ê¸°ê°€ `0x1f8`ì¸ ì²­í¬ë¥¼ ë§Œë“¤ì–´ ë¹ ë¥¸ binì—ì„œ ì´ì „ì— ì‚¬ìš©í•˜ì§€ ì•Šì•˜ë˜ ì²­í¬ë¥¼ ê²€ìƒ‰í•˜ì—¬ **`__free_hook`**ì— ë¹ ë¥¸ bin ì²­í¬ë¥¼ ì–»ìŠµë‹ˆë‹¤. ì´ ìœ„ì¹˜ì— **`system`** í•¨ìˆ˜ì˜ ì£¼ì†Œë¡œ ë®ì–´ì“°ê¸°í•©ë‹ˆë‹¤.
* ë§ˆì§€ë§‰ìœ¼ë¡œ `/bin/sh\x00` ë¬¸ìì—´ì„ í¬í•¨í•˜ëŠ” ì²­í¬ë¥¼ í•´ì œí•˜ì—¬ ì‚­ì œ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ê³ , **`__free_hook`** í•¨ìˆ˜ë¥¼ íŠ¸ë¦¬ê±°í•˜ì—¬ `/bin/sh\x00`ì„ ë§¤ê°œë³€ìˆ˜ë¡œ ì‚¬ìš©í•˜ì—¬ systemì„ ê°€ë¦¬í‚¤ê²Œ í•©ë‹ˆë‹¤.

## ì°¸ê³  ìë£Œ

* [https://ir0nstone.gitbook.io/notes/types/stack/one-gadgets-and-malloc-hook](https://ir0nstone.gitbook.io/notes/types/stack/one-gadgets-and-malloc-hook)
* [https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md).

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ **ì œë¡œë¶€í„° ì˜ì›…ê¹Œì§€ AWS í•´í‚¹ì„ ë°°ìš°ì„¸ìš”</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™œê·¸**](https://peass.creator-spring.com)ë¥¼ êµ¬ì…í•˜ì„¸ìš”
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ë‹¹ì‚¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
* **ğŸ’¬ [ë””ìŠ¤ì½”ë“œ ê·¸ë£¹](https://discord.gg/hRep4RUj7f)ì— ê°€ì…í•˜ê±°ë‚˜ [í…”ë ˆê·¸ë¨ ê·¸ë£¹](https://t.me/peass)ì— ê°€ì…í•˜ê±°ë‚˜** **íŠ¸ìœ„í„°** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **HackTricks ë° HackTricks Cloud** ê¹ƒí—ˆë¸Œ ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”**.

</details>
