# WWW2Exec - \_\_malloc\_hook & \_\_free\_hook

<details>

<summary><strong>AWS hackleme konusunda sÄ±fÄ±rdan kahramana Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini alÄ±n**](https://peass.creator-spring.com)
* [**PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **KatÄ±lÄ±n** ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± gÃ¶ndererek HackTricks ve HackTricks Cloud github depolarÄ±na PR gÃ¶ndererek paylaÅŸÄ±n.**

</details>

## **Malloc Hook**

[Resmi GNU sitesinde](https://www.gnu.org/software/libc/manual/html\_node/Hooks-for-Malloc.html) belirtildiÄŸi gibi, **`__malloc_hook`** deÄŸiÅŸkeni, `malloc()` Ã§aÄŸrÄ±ldÄ±ÄŸÄ±nda **libc kÃ¼tÃ¼phanesinin veri bÃ¶lÃ¼mÃ¼nde depolanan bir iÅŸlevin adresine iÅŸaret eden bir iÅŸaretÃ§idir**. Bu nedenle, bu adres Ã¶rneÄŸin bir **One Gadget** ile Ã¼zerine yazÄ±lÄ±rsa ve `malloc` Ã§aÄŸrÄ±lÄ±rsa, **One Gadget Ã§aÄŸrÄ±lacaktÄ±r**.

Malloc'Ä± Ã§aÄŸÄ±rmak iÃ§in programÄ±n onu Ã§aÄŸÄ±rmasÄ±nÄ± beklemek mÃ¼mkÃ¼ndÃ¼r veya **`printf("%10000$c")`** Ã§aÄŸrÄ±larak da mÃ¼mkÃ¼ndÃ¼r, bu da Ã§ok fazla bayt ayÄ±rarak `libc`'in bunlarÄ± yÄ±ÄŸÄ±nda ayÄ±rmak iÃ§in malloc Ã§aÄŸÄ±rmasÄ±nÄ± saÄŸlar.

One Gadget hakkÄ±nda daha fazla bilgi iÃ§in:

{% content-ref url="../rop-return-oriented-programing/ret2lib/one-gadget.md" %}
[one-gadget.md](../rop-return-oriented-programing/ret2lib/one-gadget.md)
{% endcontent-ref %}

{% hint style="warning" %}
KancalarÄ±n **GLIBC >= 2.34** iÃ§in **devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±ÄŸÄ±nÄ±** unutmayÄ±n. Modern GLIBC sÃ¼rÃ¼mlerinde kullanÄ±labilecek diÄŸer teknikler bulunmaktadÄ±r. BakÄ±nÄ±z: [https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md).
{% endhint %}

## Free Hook

Bu, bir sÄ±ralÄ± olmayan bin saldÄ±rÄ±sÄ±nÄ± kÃ¶tÃ¼ye kullanÄ±p hÄ±zlÄ± bir bin saldÄ±rÄ±sÄ±nÄ± kÃ¶tÃ¼ye kullanan sayfadan bir Ã¶rnekte kÃ¶tÃ¼ye kullanÄ±lmÄ±ÅŸtÄ±r:

{% content-ref url="../heap/unsorted-bin-attack.md" %}
[unsorted-bin-attack.md](../heap/unsorted-bin-attack.md)
{% endcontent-ref %}

Åimdi bir **hÄ±zlÄ± bin saldÄ±rÄ±sÄ±** gerÃ§ekleÅŸtiriliyor:

* Ä°lk olarak, **`__free_hook`** konumunda **200 boyutunda hÄ±zlÄ± parÃ§alarla Ã§alÄ±ÅŸmanÄ±n mÃ¼mkÃ¼n olduÄŸu keÅŸfedilir**:
* <pre class="language-c"><code class="lang-c">gefâ¤  p &#x26;__free_hook
$1 = (void (**)(void *, const void *)) 0x7ff1e9e607a8 &#x3C;__free_hook>
gefâ¤  x/60gx 0x7ff1e9e607a8 - 0x59
<strong>0x7ff1e9e6074f: 0x0000000000000000      0x0000000000000200
</strong>0x7ff1e9e6075f: 0x0000000000000000      0x0000000000000000
0x7ff1e9e6076f &#x3C;list_all_lock+15>:      0x0000000000000000      0x0000000000000000
0x7ff1e9e6077f &#x3C;_IO_stdfile_2_lock+15>: 0x0000000000000000      0x0000000000000000
</code></pre>
* EÄŸer bu konumda 0x200 boyutunda hÄ±zlÄ± bir parÃ§a elde edilirse, **yÃ¼rÃ¼tÃ¼lecek bir iÅŸlev iÅŸaretÃ§isini Ã¼zerine yazmak mÃ¼mkÃ¼n olacaktÄ±r**
* Bunun iÃ§in, boyutu `0xfc` olan yeni bir parÃ§a oluÅŸturulur ve birleÅŸtirilmiÅŸ iÅŸlev bu iÅŸaretÃ§iyle iki kez Ã§aÄŸrÄ±lÄ±r, bu ÅŸekilde hÄ±zlÄ± bir parÃ§anÄ±n boyutu `0xfc*2 = 0x1f8` olan bir serbest bÄ±rakÄ±lmÄ±ÅŸ parÃ§anÄ±n iÅŸaretÃ§isine ulaÅŸÄ±lÄ±r.
* ArdÄ±ndan, bu hÄ±zlÄ± parÃ§anÄ±n **`fd`** adresini Ã¶nceki **`__free_hook`** iÅŸlevine iÅŸaret etmesi iÃ§in bu parÃ§ada dÃ¼zenleme iÅŸlevi Ã§aÄŸrÄ±lÄ±r.
* Daha sonra, hÄ±zlÄ± bir parÃ§adan Ã¶nceki gereksiz parÃ§ayÄ± almak iÃ§in boyutu `0x1f8` olan bir parÃ§a oluÅŸturulur, bÃ¶ylece **`__free_hook`**'ta hÄ±zlÄ± bir parÃ§a parÃ§asÄ± alÄ±nÄ±r ve Ã¼zerine **`system`** iÅŸlevinin adresiyle Ã¼zerine yazÄ±lÄ±r.
* Ve son olarak, `/bin/sh\x00` dizesini iÃ§eren bir parÃ§a serbest bÄ±rakÄ±larak silme iÅŸlevi Ã§aÄŸrÄ±lÄ±r, **`__free_hook`** iÅŸlevi tetiklenir ve `/bin/sh\x00` parametresiyle sistem iÅŸlevine iÅŸaret eder.

## Referanslar

* [https://ir0nstone.gitbook.io/notes/types/stack/one-gadgets-and-malloc-hook](https://ir0nstone.gitbook.io/notes/types/stack/one-gadgets-and-malloc-hook)
* [https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md).

<details>

<summary><strong>AWS hackleme konusunda sÄ±fÄ±rdan kahramana Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini alÄ±n**](https://peass.creator-spring.com)
* [**PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **KatÄ±lÄ±n** ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± gÃ¶ndererek HackTricks ve HackTricks Cloud github depolarÄ±na PR gÃ¶ndererek paylaÅŸÄ±n.**

</details>
