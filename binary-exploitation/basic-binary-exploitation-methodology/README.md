# Podstawowa Metodologia Eksploatacji Binarnych

<details>

<summary><strong>Dowiedz si, jak hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>

## Podstawowe Informacje o ELF

Zanim zaczniesz eksploatowa cokolwiek, warto zrozumie cz struktury **binarnego pliku ELF**:

{% content-ref url="elf-tricks.md" %}
[elf-tricks.md](elf-tricks.md)
{% endcontent-ref %}

## Narzdzia Eksploatacji

{% content-ref url="tools/" %}
[narzdzia](tools/)
{% endcontent-ref %}

## Metodologia Przepenienia Stosu

Z tak wieloma technikami dobrze jest mie schemat, kiedy ka偶da technika bdzie przydatna. Zauwa偶, 偶e te same zabezpieczenia bd wpywa na r贸偶ne techniki. Mo偶esz znale藕 sposoby na obejcie zabezpiecze w ka偶dej sekcji zabezpiecze, ale nie w tej metodologii.

## Kontrolowanie Przepywu

Istnieje kilka sposob贸w, w jaki mo偶na kontrolowa przepyw programu:

* [**Przepenienia Stosu**](../stack-overflow/) nadpisywanie wska藕nika powrotu ze stosu lub EBP -> ESP -> EIP.
* Mo偶e by konieczne nadu偶ycie [**Przepenie Liczb Cakowitych**](../integer-overflow.md), aby spowodowa przepenienie.
* Lub za pomoc **Arbitrary Writes + Write What Where to Execution**
* [**Formatowanie acuch贸w**](../format-strings/)**:** Nadu偶yj `printf`, aby zapisa dowolne treci pod dowolnymi adresami.
* [**Indeksowanie Tablic**](../array-indexing.md): Nadu偶yj 藕le zaprojektowane indeksowanie, aby m贸c kontrolowa niekt贸re tablice i uzyska dowolny zapis.
* Mo偶e by konieczne nadu偶ycie [**Przepenie Liczb Cakowitych**](../integer-overflow.md), aby spowodowa przepenienie
* **bof to WWW via ROP**: Nadu偶yj przepenienie bufora, aby skonstruowa ROP i m贸c uzyska WWW.

Techniki **Write What Where to Execution** znajdziesz w:

{% content-ref url="../arbitrary-write-2-exec/" %}
[arbitrary-write-2-exec](../arbitrary-write-2-exec/)
{% endcontent-ref %}

## Wieczne Ptle

Co nale偶y wzi pod uwag, to 偶e zazwyczaj **jedna eksploatacja podatnoci mo偶e nie wystarczy**, aby wykona udany atak, zwaszcza gdy niekt贸re zabezpieczenia musz zosta obejcia. Dlatego wa偶ne jest om贸wienie kilku opcji, aby **umo偶liwi wielokrotne wykorzystanie jednej podatnoci** w tym samym wykonaniu binarnym:

* Zapisz w acuchu **ROP** adres funkcji **`main`** lub adres, gdzie wystpuje **podatno**.
* Kontrolujc odpowiedni acuch ROP, mo偶esz wykona wszystkie dziaania w tym acuchu.
* Zapisz adres **`exit` w GOT** (lub dowolnej innej funkcji u偶ywanej przez binarny przed zakoczeniem) adres, aby wr贸ci **do podatnoci**.
* Jak wyjaniono w [**.fini\_array**](../arbitrary-write-2-exec/www2exec-.dtors-and-.fini\_array.md#eternal-loop)**,** przechowuj tutaj 2 funkcje, jedn do ponownego wywoania podatnoci i drug do wywoania**`__libc_csu_fini`**, kt贸ra ponownie wywoa funkcj z `.fini_array`.

## Cele Eksploatacji

### Cel: Wywoanie Istniejcej Funkcji

* [**ret2win**](./#ret2win): Istnieje funkcja w kodzie, kt贸r musisz wywoa (by mo偶e z okrelonymi parametrami), aby uzyska flag.
* W zwykym przepenieniu bufora bez [**PIE**](../common-binary-protections-and-bypasses/pie/) **i** [**canary**](../common-binary-protections-and-bypasses/stack-canaries/), wystarczy zapisa adres w adresie powrotu przechowywanym na stosie.
* W przypadku przepenienia bufora z [**PIE**](../common-binary-protections-and-bypasses/pie/), bdziesz musia je omin.
* W przypadku przepenienia bufora z [**canary**](../common-binary-protections-and-bypasses/stack-canaries/), bdziesz musia je omin.
* Jeli musisz ustawi kilka parametr贸w, aby poprawnie wywoa funkcj **ret2win**, mo偶esz u偶y:
* acucha [**ROP**](./#rop-and-ret2...-techniques) **jeli istnieje wystarczajco wiele gad偶et贸w**, aby przygotowa wszystkie parametry
* [**SROP**](../rop-return-oriented-programing/srop-sigreturn-oriented-programming/) (jeli mo偶esz wywoa ten syscall) do kontrolowania wielu rejestr贸w
* Gad偶et贸w z [**ret2csu**](../rop-return-oriented-programing/ret2csu.md) i [**ret2vdso**](../rop-return-oriented-programing/ret2vdso.md) do kontrolowania kilku rejestr贸w
* Za pomoc [**Write What Where**](../arbitrary-write-2-exec/) mo偶esz nadu偶y inne podatnoci (nie przepenienie bufora), aby wywoa funkcj **`win`**.
* [**Przekierowywanie Wska藕nik贸w**](../stack-overflow/pointer-redirecting.md): W przypadku, gdy stos zawiera wska藕niki do funkcji, kt贸ra ma zosta wywoana lub do cigu znak贸w, kt贸ry ma by u偶yty przez interesujc funkcj (system lub printf), mo偶na nadpisa ten adres.
* [**ASLR**](../common-binary-protections-and-bypasses/aslr/) lub [**PIE**](../common-binary-protections-and-bypasses/pie/) mog wpyn na adresy.
* [**Nie zainicjowane zmienne**](../stack-overflow/uninitialized-variables.md): Nigdy nie wiesz.

### Cel: RCE

#### Za pomoc shellcode, jeli nx jest wyczone lub czenie shellcode z ROP:

* [**(Stack) Shellcode**](./#stack-shellcode): Jest to przydatne do przechowywania shellcode'u na stosie przed lub po nadpisaniu wska藕nika powrotu, a nastpnie **skok do niego** w celu wykonania:
* **W ka偶dym przypadku, jeli jest** [**canary**](../common-binary-protections-and-bypasses/stack-canaries/), w zwykym przepenieniu bufora, bdziesz musia je omin (wyciek).
* **Bez** [**ASLR**](../common-binary-protections-and-bypasses/aslr/) **i** [**nx**](../common-binary-protections-and-bypasses/no-exec-nx.md) mo偶liwe jest skok do adresu stosu, poniewa偶 nigdy si nie zmieni
* **Z** [**ASLR**](../common-binary-protections-and-bypasses/aslr/) bdziesz musia u偶y technik takich jak [**ret2esp/ret2reg**](../rop-return-oriented-programing/ret2esp-ret2reg.md), aby skoczy do niego
* **Z** [**nx**](../common-binary-protections-and-bypasses/no-exec-nx.md), bdziesz musia u偶y niekt贸rych [**ROP**](../rop-return-oriented-programing/) **do wywoania `memprotect`** i uczynienia pewnej strony `rwx`, aby nastpnie **przechowa tam shellcode** (wywoujc na przykad read) i potem skoczy tam.
* To poczy shellcode z acuchem ROP.
#### Za pomoc wywoa systemowych

* [**Ret2syscall**](../rop-return-oriented-programing/rop-syscall-execv/): Przydatne do wywoania `execve` w celu uruchomienia dowolnych polece. Musisz by w stanie znale藕 **gad偶ety do wywoania okrelonego wywoania systemowego z parametrami**.
* Jeli s wczone [**ASLR**](../common-binary-protections-and-bypasses/aslr/) lub [**PIE**](../common-binary-protections-and-bypasses/pie/), bdziesz musia je pokona, **aby u偶y gad偶et贸w ROP** z binari贸w lub bibliotek.
* [**SROP**](../rop-return-oriented-programing/srop-sigreturn-oriented-programming/) mo偶e by przydatne do przygotowania **ret2execve**.
* Gad偶ety z [**ret2csu**](../rop-return-oriented-programing/ret2csu.md) i [**ret2vdso**](../rop-return-oriented-programing/ret2vdso.md) do kontrolowania kilku rejestr贸w.

#### Za pomoc biblioteki libc

* [**Ret2lib**](../rop-return-oriented-programing/ret2lib/): Przydatne do wywoania funkcji z biblioteki (zazwyczaj z **`libc`**) jak **`system`** z przygotowanymi argumentami (np. `'/bin/sh'`). Potrzebujesz, aby binarny **zaadowa bibliotek** z funkcj, kt贸r chcesz wywoa (zazwyczaj libc).
* Jeli jest **skompilowany statycznie i brak** [**PIE**](../common-binary-protections-and-bypasses/pie/), **adres** `system` i `/bin/sh` nie zmieni si, wic mo偶na ich u偶y statycznie.
* **Bez** [**ASLR**](../common-binary-protections-and-bypasses/aslr/) **i znajc wersj libc** zaadowan, **adres** `system` i `/bin/sh` nie zmieni si, wic mo偶na ich u偶y statycznie.
* Z [**ASLR**](../common-binary-protections-and-bypasses/aslr/) **ale bez** [**PIE**](../common-binary-protections-and-bypasses/pie/), znajc libc i z binarnym u偶ywajcym funkcji `system`, mo偶na **`ret` do adresu systemu w GOT** z adresem `'/bin/sh'` w parametrze (trzeba to ustali).
* Z [ASLR](../common-binary-protections-and-bypasses/aslr/) ale bez [PIE](../common-binary-protections-and-bypasses/pie/), znajc libc i **bez u偶ycia binarnego `system`**:
* U偶yj [**`ret2dlresolve`**](../rop-return-oriented-programing/ret2dlresolve.md), aby rozwiza adres `system` i go wywoa&#x20;
* **Ominicie** [**ASLR**](../common-binary-protections-and-bypasses/aslr/) i obliczenie adresu `system` i `'/bin/sh'` w pamici.
* **Z** [**ASLR**](../common-binary-protections-and-bypasses/aslr/) **i** [**PIE**](../common-binary-protections-and-bypasses/pie/) **i nie znajc wersji libc**: Musisz:
* Omin [**PIE**](../common-binary-protections-and-bypasses/pie/)
* Znale藕 u偶ywan **wersj libc** (wyciek kilku adres贸w funkcji)
* Sprawd藕 **poprzednie scenariusze z ASLR**, aby kontynuowa.

#### Za pomoc EBP/RBP

* [**Stack Pivoting / EBP2Ret / EBP Chaining**](../stack-overflow/stack-pivoting-ebp2ret-ebp-chaining.md): Kontroluj ESP, aby kontrolowa RET poprzez przechowywane EBP na stosie.
* Przydatne dla przepenie stosu **off-by-one**
* Przydatne jako alternatywny spos贸b na kontrolowanie EIP, wykorzystujc EIP do konstruowania adunku w pamici, a nastpnie skakania do niego za pomoc EBP

#### R贸偶ne

* [**Przekierowywanie wska藕nik贸w**](../stack-overflow/pointer-redirecting.md): W przypadku, gdy stos zawiera wska藕niki do funkcji, kt贸ra ma zosta wywoana lub do cigu znak贸w, kt贸ry ma by u偶yty przez interesujc funkcj (system lub printf), mo偶na nadpisa ten adres.
* [**ASLR**](../common-binary-protections-and-bypasses/aslr/) lub [**PIE**](../common-binary-protections-and-bypasses/pie/) mog wpyn na adresy.
* [**Nie zainicjowane zmienne**](../stack-overflow/uninitialized-variables.md): Nigdy nie wiesz
