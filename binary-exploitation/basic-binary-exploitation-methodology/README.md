# M√©thodologie de base pour l'exploitation binaire

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## Informations de base sur ELF

Avant de commencer √† exploiter quoi que ce soit, il est int√©ressant de comprendre une partie de la structure d'un **binaire ELF** :

{% content-ref url="elf-tricks.md" %}
[elf-tricks.md](elf-tricks.md)
{% endcontent-ref %}

## Outils d'exploitation

{% content-ref url="tools/" %}
[tools](tools/)
{% endcontent-ref %}

## M√©thodologie du d√©bordement de pile

Avec autant de techniques, il est bon d'avoir un sch√©ma indiquant quand chaque technique sera utile. Notez que les m√™mes protections affecteront diff√©rentes techniques. Vous pouvez trouver des moyens de contourner les protections dans chaque section de protection mais pas dans cette m√©thodologie.

## Contr√¥ler le flux

Il existe diff√©rentes fa√ßons de contr√¥ler le flux d'un programme :

* [**D√©bordements de pile**](../stack-overflow/) en √©crasant le pointeur de retour de la pile ou l'EBP -> ESP -> EIP.
* Pourrait n√©cessiter d'abuser des [**D√©bordements d'entiers**](../integer-overflow.md) pour provoquer le d√©bordement
* Ou via **√âcritures arbitraires + √âcrire quoi o√π √† l'ex√©cution**
* [**Chaines de format**](../format-strings/)**:** Abuser de `printf` pour √©crire un contenu arbitraire √† des adresses arbitraires.
* [**Indexation de tableaux**](../array-indexing.md) : Abuser d'une indexation mal con√ßue pour pouvoir contr√¥ler certains tableaux et obtenir une √©criture arbitraire.
* Pourrait n√©cessiter d'abuser des [**D√©bordements d'entiers**](../integer-overflow.md) pour provoquer le d√©bordement
* **bof vers WWW via ROP** : Abuser d'un d√©bordement de tampon pour construire un ROP et pouvoir obtenir un WWW.

Vous pouvez trouver les techniques d'**√âcrire quoi o√π √† l'ex√©cution** dans :

{% content-ref url="../arbitrary-write-2-exec/" %}
[arbitrary-write-2-exec](../arbitrary-write-2-exec/)
{% endcontent-ref %}

## Boucles √©ternelles

Il est important de prendre en compte que g√©n√©ralement **une seule exploitation d'une vuln√©rabilit√© pourrait ne pas suffire** pour ex√©cuter avec succ√®s une exploitation, en particulier si certaines protections doivent √™tre contourn√©es. Par cons√©quent, il est int√©ressant de discuter de certaines options pour **rendre une seule vuln√©rabilit√© exploitable plusieurs fois** dans l'ex√©cution du binaire :

* √âcrire dans une cha√Æne **ROP** l'adresse de la fonction **`main`** ou √† l'adresse o√π la **vuln√©rabilit√©** se produit.
* En contr√¥lant une cha√Æne ROP appropri√©e, vous pourriez √™tre capable d'effectuer toutes les actions dans cette cha√Æne
* √âcrire dans l'adresse **`exit` dans GOT** (ou toute autre fonction utilis√©e par le binaire avant la fin) l'adresse pour revenir √† la **vuln√©rabilit√©**
* Comme expliqu√© dans [**.fini\_array**](../arbitrary-write-2-exec/www2exec-.dtors-and-.fini\_array.md#eternal-loop)**,** stockez 2 fonctions ici, une pour appeler √† nouveau la vuln√©rabilit√© et une autre pour appeler **`__libc_csu_fini`** qui appellera √† nouveau la fonction de `.fini_array`.

## Objectifs d'exploitation

### Objectif : Appeler une fonction existante

* [**ret2win**](./#ret2win) : Il y a une fonction dans le code que vous devez appeler (peut-√™tre avec des param√®tres sp√©cifiques) pour obtenir le drapeau.
* Dans un **bof r√©gulier sans** [**PIE**](../common-binary-protections-and-bypasses/pie/) **et** [**canary**](../common-binary-protections-and-bypasses/stack-canaries/), vous devez simplement √©crire l'adresse dans l'adresse de retour stock√©e dans la pile.
* Dans un bof avec [**PIE**](../common-binary-protections-and-bypasses/pie/), vous devrez le contourner
* Dans un bof avec [**canary**](../common-binary-protections-and-bypasses/stack-canaries/), vous devrez le contourner
* Si vous devez d√©finir plusieurs param√®tres pour appeler correctement la fonction **ret2win**, vous pouvez utiliser :
* Une cha√Æne [**ROP**](./#rop-and-ret2...-techniques) **si vous avez suffisamment de gadgets** pour pr√©parer tous les param√®tres
* [**SROP**](../rop-return-oriented-programing/srop-sigreturn-oriented-programming.md) (au cas o√π vous pourriez appeler cet appel syst√®me) pour contr√¥ler de nombreux registres
* Gadgets de [**ret2csu**](../rop-return-oriented-programing/ret2csu.md) et [**ret2vdso**](../rop-return-oriented-programing/ret2vdso.md) pour contr√¥ler plusieurs registres
* Via un [**√âcrire quoi o√π**](../arbitrary-write-2-exec/), vous pourriez abuser d'autres vuln√©rabilit√©s (pas de bof) pour appeler la fonction **`win`**.
* [**Redirection de pointeurs**](../stack-overflow/pointer-redirecting.md) : Si la pile contient des pointeurs vers une fonction qui va √™tre appel√©e ou vers une cha√Æne qui va √™tre utilis√©e par une fonction int√©ressante (system ou printf), il est possible de remplacer cette adresse.
* [**ASLR**](../common-binary-protections-and-bypasses/aslr/) ou [**PIE**](../common-binary-protections-and-bypasses/pie/) pourraient affecter les adresses.
* [**Variables non initialis√©es**](../stack-overflow/uninitialized-variables.md) : On ne sait jamais.

### Objectif : RCE

#### Via shellcode, si nx est d√©sactiv√© ou en m√©langeant shellcode avec ROP :

* [**(Stack) Shellcode**](./#stack-shellcode) : Cela est utile pour stocker un shellcode dans la pile avant ou apr√®s avoir √©cras√© le pointeur de retour, puis **sauter dessus** pour l'ex√©cuter :
* **Dans tous les cas, s'il y a un** [**canary**](../common-binary-protections-and-bypasses/stack-canaries/)**,** dans un bof r√©gulier, vous devrez le contourner (leak)
* **Sans** [**ASLR**](../common-binary-protections-and-bypasses/aslr/) **et** [**nx**](../common-binary-protections-and-bypasses/no-exec-nx.md), il est possible de sauter √† l'adresse de la pile car elle ne changera jamais
* **Avec** [**ASLR**](../common-binary-protections-and-bypasses/aslr/), vous aurez besoin de techniques telles que [**ret2esp/ret2reg**](../rop-return-oriented-programing/ret2esp-ret2reg.md) pour y sauter
* **Avec** [**nx**](../common-binary-protections-and-bypasses/no-exec-nx.md), vous devrez utiliser un peu de [**ROP**](../rop-return-oriented-programing/) **pour appeler `memprotect`** et rendre certaines pages `rwx`, afin de **stocker ensuite le shellcode l√†-dedans** (en appelant read par exemple) et ensuite sauter l√†-bas.
* Cela m√©lange le shellcode avec une cha√Æne ROP.
#### Via syscalls

* [**Ret2syscall**](../rop-return-oriented-programing/rop-syscall-execv.md): Utile pour appeler `execve` afin d'ex√©cuter des commandes arbitraires. Vous devez √™tre capable de trouver les **gadgets pour appeler le syscall sp√©cifique avec les param√®tres**.
* Si [**ASLR**](../common-binary-protections-and-bypasses/aslr/) ou [**PIE**](../common-binary-protections-and-bypasses/pie/) sont activ√©s, vous devrez les contourner **pour utiliser les gadgets ROP** du binaire ou des biblioth√®ques.
* [**SROP**](../rop-return-oriented-programing/srop-sigreturn-oriented-programming.md) peut √™tre utile pour pr√©parer le **ret2execve**
* Des gadgets de [**ret2csu**](../rop-return-oriented-programing/ret2csu.md) et [**ret2vdso**](../rop-return-oriented-programing/ret2vdso.md) pour contr√¥ler plusieurs registres

#### Via libc

* [**Ret2lib**](../rop-return-oriented-programing/ret2lib/): Utile pour appeler une fonction d'une biblioth√®que (g√©n√©ralement de **`libc`**) comme **`system`** avec certains arguments pr√©par√©s (par exemple, `'/bin/sh'`). Vous avez besoin que le binaire **charge la biblioth√®que** avec la fonction que vous souhaitez appeler (g√©n√©ralement libc).
* Si **compil√© statiquement et sans** [**PIE**](../common-binary-protections-and-bypasses/pie/), l'**adresse** de `system` et `/bin/sh` ne va pas changer, il est donc possible de les utiliser statiquement.
* **Sans** [**ASLR**](../common-binary-protections-and-bypasses/aslr/) **et en connaissant la version de libc** charg√©e, l'**adresse** de `system` et `/bin/sh` ne va pas changer, il est donc possible de les utiliser statiquement.
* Avec [**ASLR**](../common-binary-protections-and-bypasses/aslr/) **mais sans** [**PIE**](../common-binary-protections-and-bypasses/pie/)**, en connaissant la libc et en utilisant la fonction `system`** du binaire, il est possible de **`ret` √† l'adresse de system dans le GOT** avec l'adresse de `'/bin/sh'` en param√®tre (vous devrez r√©soudre cela).
* Avec [ASLR](../common-binary-protections-and-bypasses/aslr/) mais sans [PIE](../common-binary-protections-and-bypasses/pie/), en connaissant la libc et **sans que le binaire utilise le `system`** :
* Utilisez [**`ret2dlresolve`**](../rop-return-oriented-programing/ret2dlresolve.md) pour r√©soudre l'adresse de `system` et l'appeler&#x20;
* **Contournez** [**ASLR**](../common-binary-protections-and-bypasses/aslr/) et calculez l'adresse de `system` et `'/bin/sh'` en m√©moire.
* **Avec** [**ASLR**](../common-binary-protections-and-bypasses/aslr/) **et** [**PIE**](../common-binary-protections-and-bypasses/pie/) **et sans conna√Ætre la libc**: Vous devez :
* Contourner [**PIE**](../common-binary-protections-and-bypasses/pie/)
* Trouver la **version de la libc** utilis√©e (fuite de quelques adresses de fonctions)
* V√©rifiez les **sc√©narios pr√©c√©dents avec ASLR** pour continuer.

#### Via EBP/RBP

* [**Stack Pivoting / EBP2Ret / EBP Chaining**](../stack-overflow/stack-pivoting-ebp2ret-ebp-chaining.md): Contr√¥lez l'ESP pour contr√¥ler RET √† travers l'EBP stock√© dans la pile.
* Utile pour les d√©bordements de pile **d'un octet**
* Utile comme moyen alternatif de contr√¥ler l'EIP tout en abusant de l'EIP pour construire la charge utile en m√©moire, puis y sauter via l'EBP

#### Misc

* [**Redirection des pointeurs**](../stack-overflow/pointer-redirecting.md): Dans le cas o√π la pile contient des pointeurs vers une fonction qui va √™tre appel√©e ou vers une cha√Æne qui va √™tre utilis√©e par une fonction int√©ressante (system ou printf), il est possible de remplacer cette adresse.
* [**ASLR**](../common-binary-protections-and-bypasses/aslr/) ou [**PIE**](../common-binary-protections-and-bypasses/pie/) peuvent affecter les adresses.
* [**Variables non initialis√©es**](../stack-overflow/uninitialized-variables.md): On ne sait jamais
