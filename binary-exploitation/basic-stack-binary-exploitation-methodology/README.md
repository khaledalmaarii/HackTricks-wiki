# Osnovna metodologija binarne eksploatacije

{% hint style="success" %}
Nau캜ite i ve쬭ajte hakovanje AWS-a:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Obuka AWS Crveni Tim Ekspert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Nau캜ite i ve쬭ajte hakovanje GCP-a: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Obuka GCP Crveni Tim Ekspert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr쬴te HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## Osnovne informacije o ELF-u

Pre nego 코to po캜nete eksploatisati bilo 코ta, korisno je razumeti deo strukture **ELF binarnog fajla**:

{% content-ref url="elf-tricks.md" %}
[elf-tricks.md](elf-tricks.md)
{% endcontent-ref %}

## Alati za eksploataciju

{% content-ref url="tools/" %}
[alati](tools/)
{% endcontent-ref %}

## Metodologija preplavljivanja steka

S obzirom na toliko tehnika, dobro je imati 코emu kada 캖e svaka tehnika biti korisna. Imajte na umu da 캖e iste za코tite uticati na razli캜ite tehnike. Mo쬰te prona캖i na캜ine zaobila쬰nja za코tita u svakom delu za코tite, ali ne u ovoj metodologiji.

## Kontrolisanje toka

Postoje razli캜iti na캜ini na koje mo쬰te kontrolisati tok programa:

* [**Preplavljivanje steka**](../stack-overflow/) prepisivanjem pokaziva캜a povratka sa steka ili EBP -> ESP -> EIP.
* Mo쬯a 캖e biti potrebno zloupotrebiti [**Prekora캜enje celih brojeva**](../integer-overflow.md) da biste izazvali prekora캜enje
* Ili putem **Proizvoljnog Pisanja + Pisanja Gde 맚a ka Izvr코enju**
* [**Formatiranje stringova**](../format-strings/)**:** Zloupotreba `printf` za pisanje proizvoljnog sadr쬬ja na proizvoljne adrese.
* [**Indeksiranje nizova**](../array-indexing.md): Zloupotreba lo코e dizajniranog indeksiranja kako biste mogli kontrolisati neke nizove i dobiti proizvoljno pisanje.
* Mo쬯a 캖e biti potrebno zloupotrebiti [**Prekora캜enje celih brojeva**](../integer-overflow.md) da biste izazvali prekora캜enje
* **bof do WWW putem ROP-a**: Zloupotreba prekora캜enja bafera za konstruisanje ROP-a i mogu캖nost dobijanja WWW.

Tehnike **Pisanja Gde 맚a ka Izvr코enju** mo쬰te prona캖i u:

{% content-ref url="../arbitrary-write-2-exec/" %}
[arbitrary-write-2-exec](../arbitrary-write-2-exec/)
{% endcontent-ref %}

## Ve캜ne petlje

Ne코to 코to treba uzeti u obzir je da obi캜no **samo jedna eksploatacija ranjivosti mo쬯a ne캖e biti dovoljna** da se izvr코i uspe코an eksploatacija, posebno ako neke za코tite treba zaobi캖i. Stoga je interesantno razmotriti neke opcije kako **u캜initi jednu ranjivost eksploatabilnom vi코e puta** u istom izvr코avanju binarnog fajla:

* Upisati adresu **`main` funkcije** u **ROP** lanac ili adresu gde se doga캠a **ranjivost**.
* Kontrolisanjem odgovaraju캖eg ROP lanca mo쬯a 캖ete mo캖i izvr코iti sve radnje u tom lancu
* Upisati adresu **`exit` funkcije u GOT** (ili bilo koje druge funkcije koje koristi binarni fajl pre zavr코etka) adresu za povratak na **ranjivost**
* Kao 코to je obja코njeno u [**.fini\_array**](../arbitrary-write-2-exec/www2exec-.dtors-and-.fini\_array.md#eternal-loop)**,** ovde 캜uvajte 2 funkcije, jednu za ponovno pozivanje ranjivosti i drugu za pozivanje **`__libc_csu_fini`** koja 캖e ponovo pozvati funkciju iz `.fini_array`.

## Ciljevi eksploatacije

### Cilj: Pozvati postoje캖u funkciju

* [**ret2win**](./#ret2win): Postoji funkcija u kodu koju treba pozvati (mo쬯a sa odre캠enim parametrima) kako biste dobili zastavu.
* U **obi캜nom bof-u bez** [**PIE**](../common-binary-protections-and-bypasses/pie/) **i** [**canary**](../common-binary-protections-and-bypasses/stack-canaries/) samo treba upisati adresu u adresu povratka koja je sa캜uvana na steku.
* U bof-u sa [**PIE**](../common-binary-protections-and-bypasses/pie/), mora캖ete da je zaobi캠ete
* U bof-u sa [**canary**](../common-binary-protections-and-bypasses/stack-canaries/), mora캖ete da je zaobi캠ete
* Ako treba postaviti vi코e parametara da biste pravilno pozvali funkciju **ret2win** mo쬰te koristiti:
* [**ROP**](./#rop-and-ret2...-techniques) **lanac ako postoji dovoljno ged쬰ta** za pripremu svih parametara
* [**SROP**](../rop-return-oriented-programing/srop-sigreturn-oriented-programming/) (u slu캜aju da mo쬰te pozvati ovaj sistemski poziv) da kontroli코ete mnoge registre
* Ged쬰ti iz [**ret2csu**](../rop-return-oriented-programing/ret2csu.md) i [**ret2vdso**](../rop-return-oriented-programing/ret2vdso.md) da kontroli코ete nekoliko registara
* Putem [**Pisanja Gde 맚a ka Izvr코enju**](../arbitrary-write-2-exec/) mo쬰te zloupotrebiti druge ranjivosti (ne bof) da biste pozvali funkciju **`win`**.
* [**Preusmeravanje pokaziva캜a**](../stack-overflow/pointer-redirecting.md): Ukoliko stek sadr쬴 pokaziva캜e ka funkciji koja 캖e biti pozvana ili ka stringu koji 캖e biti kori코캖en od strane zanimljive funkcije (system ili printf), mogu캖e je prepisati tu adresu.
* [**ASLR**](../common-binary-protections-and-bypasses/aslr/) ili [**PIE**](../common-binary-protections-and-bypasses/pie/) mogu uticati na adrese.
* [**Neinicijalizovane promenljive**](../stack-overflow/uninitialized-variables.md): Nikad ne znate.

### Cilj: RCE

#### Putem shell koda, ako je nx onemogu캖en ili me코anje shell koda sa ROP-om:

* [**(Stack) Shell kod**](./#stack-shellcode): Ovo je korisno za sme코tanje shell koda na stek pre ili posle prepisivanja pokaziva캜a povratka, a zatim **sko캜iti na njega** da ga izvr코ite:
* **U svakom slu캜aju, ako postoji** [**canary**](../common-binary-protections-and-bypasses/stack-canaries/)**,** u obi캜nom bof-u mora캖ete da je zaobi캠ete (procurite)
* **Bez** [**ASLR**](../common-binary-protections-and-bypasses/aslr/) **i** [**nx**](../common-binary-protections-and-bypasses/no-exec-nx.md) mogu캖e je sko캜iti na adresu steka jer se nikada ne캖e promeniti
* **Sa** [**ASLR**](../common-binary-protections-and-bypasses/aslr/) mora캖ete koristiti tehnike poput [**ret2esp/ret2reg**](../rop-return-oriented-programing/ret2esp-ret2reg.md) da biste sko캜ili na nju
* **Sa** [**nx**](../common-binary-protections-and-bypasses/no-exec-nx.md), mora캖ete koristiti neki [**ROP**](../rop-return-oriented-programing/) **da biste pozvali `memprotect`** i napravili neku stranicu `rwx`, kako biste zatim **sme코tali shell kod tamo** (pozivanjem read na primer) i zatim sko캜ili tamo.
* Ovo 캖e me코ati shell kod sa ROP lancem.
#### Putem syscalls-a

* [**Ret2syscall**](../rop-return-oriented-programing/rop-syscall-execv/): Korisno za pozivanje `execve` kako bi se pokrenule proizvoljne komande. Potrebno je prona캖i **gadgete za pozivanje odre캠enog syscall-a sa parametrima**.
* Ako su [**ASLR**](../common-binary-protections-and-bypasses/aslr/) ili [**PIE**](../common-binary-protections-and-bypasses/pie/) omogu캖eni, mora캖ete ih pobediti **kako biste koristili ROP gadgete** iz binarnog koda ili biblioteka.
* [**SROP**](../rop-return-oriented-programing/srop-sigreturn-oriented-programming/) mo쬰 biti koristan za pripremu **ret2execve**
* Gadgeti iz [**ret2csu**](../rop-return-oriented-programing/ret2csu.md) i [**ret2vdso**](../rop-return-oriented-programing/ret2vdso.md) za kontrolu vi코e registara

#### Putem libc-a

* [**Ret2lib**](../rop-return-oriented-programing/ret2lib/): Korisno za pozivanje funkcije iz biblioteke (obi캜no iz **`libc`**) poput **`system`** sa nekim pripremljenim argumentima (npr. `'/bin/sh'`). Potrebno je da binarni fajl **u캜ita biblioteku** sa funkcijom koju 쬰lite da pozovete (obi캜no libc).
* Ako je **stati캜ki kompajliran i nema** [**PIE**](../common-binary-protections-and-bypasses/pie/), **adresa** `system`-a i `/bin/sh` se ne캖e promeniti, pa je mogu캖e stati캜ki ih koristiti.
* **Bez** [**ASLR**](../common-binary-protections-and-bypasses/aslr/) **i poznavanja verzije libc-a** koja je u캜itana, **adresa** `system`-a i `/bin/sh` se ne캖e promeniti, pa je mogu캖e stati캜ki ih koristiti.
* Sa [**ASLR**](../common-binary-protections-and-bypasses/aslr/) **ali bez** [**PIE**](../common-binary-protections-and-bypasses/pie/), znaju캖i libc i sa binarnim fajlom koji koristi funkciju `system`, mogu캖e je **`ret` na adresu system-a u GOT-u** sa adresom `'/bin/sh'` u parametru (morate ovo da otkrijete).
* Sa [ASLR](../common-binary-protections-and-bypasses/aslr/) ali bez [PIE](../common-binary-protections-and-bypasses/pie/), znaju캖i libc i **bez binarnog fajla koji koristi `system`**:
* Koristite [**`ret2dlresolve`**](../rop-return-oriented-programing/ret2dlresolve.md) da re코ite adresu `system`-a i pozovete je&#x20;
* **Pobedite** [**ASLR**](../common-binary-protections-and-bypasses/aslr/) i izra캜unajte adresu `system`-a i `'/bin/sh'` u memoriji.
* **Sa** [**ASLR**](../common-binary-protections-and-bypasses/aslr/) **i** [**PIE**](../common-binary-protections-and-bypasses/pie/) **i bez poznavanja libc-a**: Potrebno je:
* Pobediti [**PIE**](../common-binary-protections-and-bypasses/pie/)
* Prona캖i kori코캖enu **verziju libc-a** (procureti nekoliko adresa funkcija)
* Proveriti **prethodne scenarije sa ASLR-om** kako biste nastavili.

#### Putem EBP/RBP

* [**Stack Pivoting / EBP2Ret / EBP Chaining**](../stack-overflow/stack-pivoting-ebp2ret-ebp-chaining.md): Kontroli코ite ESP kako biste kontrolisali RET putem sa캜uvanog EBP-a na steku.
* Korisno za **off-by-one** preplavljivanje steka
* Korisno kao alternativni na캜in za zavr코etak kontrole EIP-a dok zloupotrebljavate EIP za konstruisanje payload-a u memoriji, a zatim skakanje na njega putem EBP-a

#### Razno

* [**Preusmeravanje pokaziva캜a**](../stack-overflow/pointer-redirecting.md): U slu캜aju da stek sadr쬴 pokaziva캜e ka funkciji koja 캖e biti pozvana ili ka stringu koji 캖e biti kori코캖en od strane zanimljive funkcije (system ili printf), mogu캖e je prepisati tu adresu.
* [**ASLR**](../common-binary-protections-and-bypasses/aslr/) ili [**PIE**](../common-binary-protections-and-bypasses/pie/) mogu uticati na adrese.
* [**Neinicijalizovane promenljive**](../stack-overflow/uninitialized-variables.md): Nikad ne znate
