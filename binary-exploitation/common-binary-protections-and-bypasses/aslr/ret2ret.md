# Ret2ret & Ret2pop

{% hint style="success" %}
Ucz si i praktykuj Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i praktykuj Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na GitHubie.

</details>
{% endhint %}

## Ret2ret

G贸wnym **celem** tej techniki jest pr贸ba **obejcia ASLR poprzez nadu偶ycie istniejcego wska藕nika na stosie**.

W skr贸cie, przepenienia stosu zazwyczaj s spowodowane cigami znak贸w, a **cigi kocz si bajtem null na kocu** w pamici. Pozwala to spr贸bowa zmniejszy miejsce wskazywane przez istniejcy ju偶 wska藕nik na stosie. Jeli stos zawiera `0xbfffffdd`, to przepenienie mogoby przeksztaci go w `0xbfffff00` (zauwa偶 ostatni zerowy bajt).

Jeli ten adres wskazuje na nasz kod powoki na stosie, mo偶liwe jest skierowanie przepywu do tego adresu poprzez **dodawanie adres贸w do instrukcji `ret`** a偶 do momentu ich osignicia.

Atak wygldaby wic nastpujco:

* NOP sled
* Kod powoki
* Nadpisanie stosu z EIP za pomoc **adres贸w do `ret`** (RET sled)
* 0x00 dodane przez cig znak贸w modyfikujce adres ze stosu, powodujc, 偶e wskazuje on na NOP sled

Klikajc [**ten link**](https://github.com/florianhofhammer/stack-buffer-overflow-internship/blob/master/ASLR%20Smack%20and%20Laugh%20reference%20-%20Tilo%20Mueller/ret2ret.c) mo偶esz zobaczy przykad podatnego pliku binarnego, a [**w tym**](https://github.com/florianhofhammer/stack-buffer-overflow-internship/blob/master/ASLR%20Smack%20and%20Laugh%20reference%20-%20Tilo%20Mueller/ret2retexploit.c) exploit.

## Ret2pop

W przypadku znalezienia **idealnego wska藕nika na stosie, kt贸rego nie chcesz modyfikowa** (w `ret2ret` zmienialimy ostatni najni偶szy bajt na `0x00`), mo偶na przeprowadzi ten sam atak `ret2ret`, ale **dugo RET sled musi by skr贸cona o 1** (aby finalne `0x00` nadpisao dane tu偶 przed idealnym wska藕nikiem), a **ostatni** adres RET sled musi wskazywa na **`pop <reg>; ret`**.\
W ten spos贸b **dane przed idealnym wska藕nikiem zostan usunite** ze stosu (s to dane dotknite przez `0x00`) i **ostatni `ret` wska偶e na idealny adres** na stosie bez 偶adnych zmian.

Klikajc [**ten link**](https://github.com/florianhofhammer/stack-buffer-overflow-internship/blob/master/ASLR%20Smack%20and%20Laugh%20reference%20-%20Tilo%20Mueller/ret2pop.c) mo偶esz zobaczy przykad podatnego pliku binarnego, a [**w tym**](https://github.com/florianhofhammer/stack-buffer-overflow-internship/blob/master/ASLR%20Smack%20and%20Laugh%20reference%20-%20Tilo%20Mueller/ret2popexploit.c) exploit.

## Referencje

* [https://github.com/florianhofhammer/stack-buffer-overflow-internship/blob/master/NOTES.md](https://github.com/florianhofhammer/stack-buffer-overflow-internship/blob/master/NOTES.md)

{% hint style="success" %}
Ucz si i praktykuj Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i praktykuj Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na GitHubie.

</details>
{% endhint %}
