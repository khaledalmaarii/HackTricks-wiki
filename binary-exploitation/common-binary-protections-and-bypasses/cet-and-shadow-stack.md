# CET & Shadow Stack

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci贸n**](https://github.com/sponsors/carlospolop)!
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Tecnolog铆a de Aplicaci贸n del Flujo de Control (CET)

**CET** es una caracter铆stica de seguridad implementada a nivel de hardware, dise帽ada para frustrar ataques comunes de secuestro de flujo de control como **Programaci贸n Orientada a Retorno (ROP)** y **Programaci贸n Orientada a Salto (JOP)**. Estos tipos de ataques manipulan el flujo de ejecuci贸n de un programa para ejecutar c贸digo malicioso o encadenar piezas de c贸digo benigno de una manera que realiza una acci贸n maliciosa.

CET introduce dos caracter铆sticas principales: **Seguimiento de Ramas Indirectas (IBT)** y **Shadow Stack**.

* **IBT** asegura que los saltos y llamadas indirectas se realicen a destinos v谩lidos, que est谩n marcados expl铆citamente como destinos legales para ramas indirectas. Esto se logra mediante el uso de un nuevo conjunto de instrucciones que marca los destinos v谩lidos, evitando as铆 que los atacantes desv铆en el flujo de control a ubicaciones arbitrarias.
* **Shadow Stack** es un mecanismo que proporciona integridad para las direcciones de retorno. Mantiene una copia segura y oculta de las direcciones de retorno separada de la pila de llamadas regular. Cuando una funci贸n retorna, la direcci贸n de retorno se valida con el shadow stack, evitando que los atacantes sobrescriban las direcciones de retorno en la pila para secuestrar el flujo de control.

## Shadow Stack

El **shadow stack** es una **pila dedicada utilizada 煤nicamente para almacenar direcciones de retorno**. Trabaja junto con la pila regular pero est谩 protegida y oculta de la ejecuci贸n normal del programa, lo que dificulta que los atacantes manipulen. El objetivo principal del shadow stack es garantizar que se detecten cualquier modificaci贸n de las direcciones de retorno en la pila convencional antes de que puedan ser utilizadas, mitigando efectivamente los ataques ROP.

## C贸mo CET y Shadow Stack Previenen Ataques

Los ataques **ROP y JOP** dependen de la capacidad de secuestrar el flujo de control de una aplicaci贸n aprovechando vulnerabilidades que les permiten sobrescribir punteros o direcciones de retorno en la pila. Al dirigir el flujo a secuencias de gadgets de c贸digo existentes o gadgets de programaci贸n orientada a retorno, los atacantes pueden ejecutar c贸digo arbitrario.

* La caracter铆stica **IBT de CET** dificulta significativamente estos ataques al garantizar que las ramas indirectas solo puedan saltar a direcciones que han sido marcadas expl铆citamente como destinos v谩lidos. Esto hace imposible que los atacantes ejecuten gadgets arbitrarios dispersos en el binario.
* Por otro lado, el **shadow stack** asegura que incluso si un atacante puede sobrescribir una direcci贸n de retorno en la pila normal, la **discrepancia ser谩 detectada** al comparar la direcci贸n corrupta con la copia segura almacenada en el shadow stack al retornar de una funci贸n. Si las direcciones no coinciden, el programa puede terminar o tomar otras medidas de seguridad, evitando que el ataque tenga 茅xito.

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci贸n**](https://github.com/sponsors/carlospolop)!
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
