# Ochrona libc

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) albo **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>

## Egzekwowanie Wyr贸wnania Kawak贸w

**Malloc** alokuje pami w grupach **8 bajt贸w (32-bitowych) lub 16 bajt贸w (64-bitowych)**. Oznacza to, 偶e koniec kawak贸w w systemach 32-bitowych powinien by wyr贸wnany z **0x8**, a w systemach 64-bitowych z **0x0**. Funkcja zabezpiecze sprawdza, czy ka偶dy kawaek **jest poprawnie wyr贸wnany** na tych konkretnych lokalizacjach przed u偶yciem wska藕nika z pojemnika.

### Korzyci dla Bezpieczestwa

Egzekwowanie wyr贸wnania kawak贸w w systemach 64-bitowych znaczco zwiksza bezpieczestwo Malloc poprzez **ograniczenie umieszczania faszywych kawak贸w tylko na 1 z ka偶dych 16 adres贸w**. Sprawia to, 偶e wysiki eksploatacyjne s bardziej skomplikowane, zwaszcza w scenariuszach, gdzie u偶ytkownik ma ograniczon kontrol nad wartociami wejciowymi, co sprawia, 偶e ataki s bardziej zo偶one i trudniejsze do wykonania z sukcesem.

* **Atak Fastbin na \_\_malloc\_hook**

Nowe zasady wyr贸wnania w Malloc r贸wnie偶 udaremniaj klasyczny atak polegajcy na `__malloc_hook`. Wczeniej atakujcy mogli manipulowa rozmiarami kawak贸w, aby **nadpisa ten wska藕nik funkcji** i uzyska **wykonanie kodu**. Teraz surowe wymagania wyr贸wnania zapewniaj, 偶e takie manipulacje nie s ju偶 mo偶liwe, zamykajc powszechn drog eksploatacji i zwikszajc og贸lne bezpieczestwo.

## Mieszanie Wska藕nik贸w na fastbinach i tcache

**Mieszanie Wska藕nik贸w** to zabezpieczenie u偶ywane do ochrony **szybkich pojemnik贸w i wska藕nik贸w Fd tcache** w operacjach zarzdzania pamici. Ta technika pomaga zapobiega pewnym rodzajom taktyk eksploatacji pamici, zwaszcza tym, kt贸re nie wymagaj wycieku informacji o pamici ani manipulowania lokalizacjami pamici bezporednio wzgldem znanych pozycji (nadpisywanie **wzgldne**).

Rdzeniem tej techniki jest wz贸r obfuskacji:

**`Nowy_Wska藕nik = (L >> 12) XOR P`**

* **L** to **Lokalizacja Przechowywania** wska藕nika.
* **P** to rzeczywisty **Wska藕nik Fd szybkiego pojemnika/tcache**.

Pow贸d przesunicia bitowego lokalizacji przechowywania (L) o 12 bit贸w w prawo przed operacj XOR jest kluczowy. Ta manipulacja adresuje podatno wynikajc z deterministycznej natury najmniej znaczcych 12 bit贸w adres贸w pamici, kt贸re zazwyczaj s przewidywalne ze wzgldu na ograniczenia architektury systemu. Przesunicie bit贸w przenosi przewidywaln cz z r贸wnania, zwikszajc losowo nowego, zmieszanego wska藕nika i tym samym zabezpieczajc przed atakami polegajcymi na przewidywalnoci tych bit贸w.

Ten zmieszany wska藕nik wykorzystuje istniejc losowo zapewnian przez **Losow Ukadank Przestrzeni Adresowej (ASLR)**, kt贸ra losuje adresy u偶ywane przez programy, aby utrudni atakujcym przewidywanie ukadu pamici procesu.

**Demiksowanie** wska藕nika w celu odzyskania oryginalnego adresu polega na u偶yciu tej samej operacji XOR. Tutaj zmieszany wska藕nik jest traktowany jako P w formule, a gdy jest XORowany z niezmienion lokalizacj przechowywania (L), odsania oryginalny wska藕nik. Ta symetria w mieszaniu i demiksowaniu zapewnia, 偶e system mo偶e efektywnie kodowa i dekodowa wska藕niki bez znaczcego narzutu, jednoczenie znacznie zwikszajc bezpieczestwo przed atakami manipulujcymi wska藕nikami pamici.

### Korzyci dla Bezpieczestwa

Mieszanie wska藕nik贸w ma na celu **zapobieganie nadpisywaniu czciowego i penego wska藕nika w stercie**, co stanowi znaczce wzmocnienie bezpieczestwa. Ta funkcja wpywa na techniki eksploatacji w kilku aspektach:

1. **Zapobieganie Nadpisywaniu Wska藕nik贸w Wzgldnych Bye Byte**: Wczeniej atakujcy mogli zmieni cz wska藕nika, aby **przekierowa kawaki sterty na inne lokalizacje bez znajomoci dokadnych adres贸w**, technika widoczna w eksploacie **House of Roman** bez wycieku pamici. Dziki mieszaniu wska藕nik贸w, takie nadpisywanie wzgldne **bez wycieku sterty teraz wymaga brutalnej siy**, drastycznie zmniejszajc szanse na sukces.
2. **Zwikszenie Trudnoci Atak贸w na Pojemniki Tcache/Fastbin**: Powszechne ataki, kt贸re nadpisuj wska藕niki funkcji (jak `__malloc_hook`) poprzez manipulowanie wpisami szybkich pojemnik贸w lub tcache, s utrudnione. Na przykad atak mo偶e polega na wycieku adresu LibC, zwolnieniu kawaka do pojemnika tcache, a nastpnie nadpisaniu wska藕nika Fd, aby przekierowa go do `__malloc_hook` w celu wykonania arbitralnego kodu. Dziki mieszaniu wska藕nik贸w, te wska藕niki musz by poprawnie zmieszane, **wymagajc wycieku sterty dla dokadnej manipulacji**, podnoszc tym samym barier eksploatacji.
3. **Wymaganie Wycieku Sterty w Lokacjach Poza Stert**: Utworzenie faszywego kawaka w obszarach poza stert (jak stos, sekcja .bss lub PLT/GOT) teraz r贸wnie偶 **wymaga wycieku sterty** ze wzgldu na konieczno mieszania wska藕nik贸w. To zwiksza zo偶ono eksploatowania tych obszar贸w, podobnie jak wymaganie manipulowania adresami LibC.
4. **Wyciek Adres贸w Sterty Staje Si Trudniejszy**: Mieszanie wska藕nik贸w ogranicza przydatno wska藕nik贸w Fd w szybkich pojemnikach i pojemnikach tcache jako 藕r贸de wyciek贸w adres贸w sterty. Jednak wska藕niki w nieuporzdkowanych, maych i du偶ych pojemnikach pozostaj niezmieszane, nadal wic nadaj si do wyciek贸w adres贸w. Ten przesunity nacisk zmusza atakujcych do eksplorowania tych pojemnik贸w w poszukiwaniu informacji podatnych na eksploatacj, chocia偶 niekt贸re techniki mog nadal pozwala na demiksowanie wska藕nik贸w przed wyciekiem, cho z ograniczeniami.

### **Demiksowanie Wska藕nik贸w z Wyciekiem Sterty**

{% hint style="danger" %}
Dla lepszego wyjanienia procesu [**sprawd藕 oryginalny post tutaj**](https://maxwelldulin.com/BlogPost?post=5445977088).
{% endhint %}

### Przegld Algorytmu

Wz贸r u偶ywany do mieszania i demiksowania wska藕nik贸w to:&#x20;

**`Nowy_Wska藕nik = (L >> 12) XOR P`**

Gdzie **L** to lokalizacja przechowywania, a **P** to wska藕nik Fd. Gdy **L** jest przesuwane w prawo o 12 bit贸w, odsania najbardziej znaczce bity **P**, ze wzgldu na natur **XOR**, kt贸ra zwraca 0, gdy bity s XORowane ze sob.

**Kluczowe Kroki w Algorytmie:**

1. **Pocztkowe Wycieki Najbardziej Znaczcych Bit贸w**: Poprzez XORowanie przesunitego **L** z **P**, efektywnie otrzymujesz 12 najbardziej znaczcych bit贸w **P**, poniewa偶 przesunita cz **L** bdzie zerem, pozostawiajc niezmienione bity odpowiadajce **P**.
2. **Odzyskiwanie Bit贸w Wska藕nika**: Poniewa偶 XOR jest odwracalny, znajc wynik i jeden z operand贸w, mo偶esz obliczy drugi operand. Ta waciwo jest wykorzystywana do wydedukowania caego zestawu bit贸w dla **P**, poprzez sukcesywne XORowanie znanych zestaw贸w bit贸w z czciami zmieszanego wska藕nika.
3. **Iteracyjne Demiksowanie**: Proces jest powtarzany, za ka偶dym razem u偶ywajc nowo odkrytych bit贸w **P** z poprzedniego kroku do dekodowania kolejnego segmentu zmieszanego wska藕nika, a偶 wszystkie bity zostan odzyskane.
4. **Obsuga Deterministycznych Bit贸w**: Ostatnie 12 bit贸w **L** jest tracone z powodu przesunicia, ale s one deterministyczne i mog by odtworzone po procesie.

Mo偶esz znale藕 implementacj tego algorytmu tutaj: [https://github.com/mdulin2/mangle](https://github.com/mdulin2/mangle)
## Ochrona wska藕nika

Ochrona wska藕nika to technika zabezpiecze wykorzystywana w bibliotece glibc do ochrony przechowywanych wska藕nik贸w funkcji, zwaszcza tych zarejestrowanych przez wywoania biblioteczne, takie jak `atexit()`. Ochrona ta polega na przemieszaniu wska藕nik贸w poprzez XORowanie ich z sekretem przechowywanym w danych wtku (`fs:0x30`) i zastosowaniu bitowej rotacji. Mechanizm ten ma na celu zapobieganie atakom polegajcym na przejciu kontroli poprzez nadpisanie wska藕nik贸w funkcji.

### **Ominicie ochrony wska藕nika za pomoc wycieku**

1. **Zrozumienie operacji ochrony wska藕nika:** Przemieszanie wska藕nik贸w jest wykonywane za pomoc makra `PTR_MANGLE`, kt贸re XORuje wska藕nik z 64-bitowym tajnym kluczem, a nastpnie wykonuje lew rotacj o 0x11 bit贸w. Operacja odwrotna, czyli odzyskanie pierwotnego wska藕nika, jest obsugiwana przez `PTR_DEMANGLE`.
2. **Strategia ataku:** Atak opiera si na podejciu znanych tekst贸w jawnie, gdzie atakujcy musi zna zar贸wno oryginaln, jak i przemieszan wersj wska藕nika, aby wydedukowa u偶yty do przemieszania sekret.
3. **Wykorzystanie znanych tekst贸w jawnie:**
* **Identyfikacja staych wska藕nik贸w funkcji:** Poprzez analiz kodu 藕r贸dowego glibc lub zainicjowanych tabel wska藕nik贸w funkcji (np. `__libc_pthread_functions`), atakujcy mo偶e znale藕 przewidywalne wska藕niki funkcji.
* **Obliczanie sekretu:** Korzystajc z znanego wska藕nika funkcji, takiego jak `__pthread_attr_destroy` i jego przemieszanej wersji z tabeli wska藕nik贸w funkcji, sekret mo偶na obliczy poprzez odwr贸cenie rotacji (rotacja w prawo) przemieszanego wska藕nika, a nastpnie XORowanie go z adresem funkcji.
4. **Alternatywne teksty jawnie:** Atakujcy mo偶e r贸wnie偶 eksperymentowa z przemieszaniem wska藕nik贸w znanymi wartociami, takimi jak 0 lub -1, aby sprawdzi, czy powoduj one rozpoznawalne wzorce w pamici, potencjalnie ujawniajc sekret, gdy te wzorce zostan znalezione w zrzutach pamici.
5. **Zastosowanie praktyczne:** Po obliczeniu sekretu atakujcy mo偶e manipulowa wska藕nikami w kontrolowany spos贸b, w zasadzie omijajc ochron wska藕nika w aplikacji wielowtkowej z wiedz o adresie bazowym libc i mo偶liwoci odczytu dowolnych lokalizacji pamici.

## Odnoniki

* [https://maxwelldulin.com/BlogPost?post=5445977088](https://maxwelldulin.com/BlogPost?post=5445977088)
* [https://blog.infosectcbr.com.au/2020/04/bypassing-pointer-guard-in-linuxs-glibc.html?m=1](https://blog.infosectcbr.com.au/2020/04/bypassing-pointer-guard-in-linuxs-glibc.html?m=1)
