# Libc KorumalarÄ±

<details>

<summary><strong>AWS hackleme konusunda sÄ±fÄ±rdan kahraman olmaya kadar Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> ile!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**]'na gÃ¶z atÄ±n (https://github.com/sponsors/carlospolop)!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) koleksiyonumuzu keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family)
* **KatÄ±lÄ±n** ğŸ’¬ [**Discord grubumuza**](https://discord.gg/hRep4RUj7f) veya [**telegram grubumuza**](https://t.me/peass) veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>

## ParÃ§a HizalamasÄ± ZorlamasÄ±

**Malloc**, belleÄŸi **8 bayt (32 bit) veya 16 bayt (64 bit) gruplarÄ±nda** ayÄ±rÄ±r. Bu, 32 bit sistemlerde parÃ§alarÄ±n sonunun **0x8** ile, 64 bit sistemlerde ise **0x0** ile hizalanmasÄ± gerektiÄŸi anlamÄ±na gelir. GÃ¼venlik Ã¶zelliÄŸi, bir kutudan bir iÅŸaretÃ§i kullanmadan Ã¶nce her parÃ§anÄ±n bu belirli konumlarda **doÄŸru ÅŸekilde hizalandÄ±ÄŸÄ±nÄ±** kontrol eder.

### GÃ¼venlik AvantajlarÄ±

64 bit sistemlerde parÃ§a hizalamasÄ±nÄ±n zorunlu olmasÄ±, Malloc'un gÃ¼venliÄŸini Ã¶nemli Ã¶lÃ§Ã¼de artÄ±rÄ±r Ã§Ã¼nkÃ¼ sahte parÃ§alarÄ±n yerleÅŸtirilmesini sadece **her 16 adresin 1'inde** sÄ±nÄ±rlar. Bu, Ã¶zellikle kullanÄ±cÄ±nÄ±n giriÅŸ deÄŸerleri Ã¼zerinde sÄ±nÄ±rlÄ± kontrolÃ¼ olduÄŸu senaryolarda saldÄ±rÄ±larÄ± daha karmaÅŸÄ±k ve baÅŸarÄ±lÄ± bir ÅŸekilde gerÃ§ekleÅŸtirmeyi zorlaÅŸtÄ±rÄ±r.

* **\_\_malloc\_hook Ãœzerindeki Fastbin SaldÄ±rÄ±sÄ±**

Malloc'daki yeni hizalama kurallarÄ±, `__malloc_hook`'u iÃ§eren klasik bir saldÄ±rÄ±yÄ± da engeller. Ã–nceden saldÄ±rganlar, parÃ§a boyutlarÄ±nÄ± manipÃ¼le ederek bu fonksiyon iÅŸaretÃ§isini **Ã¼zerine yazabilir** ve **kod yÃ¼rÃ¼tme** elde edebilirdi. Åimdi, sÄ±kÄ± hizalama gereksinimi, bÃ¶yle manipÃ¼lasyonlarÄ±n artÄ±k mÃ¼mkÃ¼n olmadÄ±ÄŸÄ±ndan emin olur, yaygÄ±n bir sÃ¶mÃ¼rÃ¼ yolunu kapatÄ±r ve genel gÃ¼venliÄŸi artÄ±rÄ±r.

## Fastbin ve tcache Ãœzerinde Ä°ÅŸaretÃ§i KarÄ±ÅŸtÄ±rma

**Ä°ÅŸaretÃ§i KarÄ±ÅŸtÄ±rma**, bellek yÃ¶netimi iÅŸlemlerinde **fastbin ve tcache Fd iÅŸaretÃ§ilerini korumak iÃ§in kullanÄ±lan bir gÃ¼venlik artÄ±ÅŸÄ±dÄ±r**. Bu teknik, sÄ±zdÄ±rÄ±lmÄ±ÅŸ bellek bilgilerini gerektirmeyen veya bilinen konumlara doÄŸrudan bellek konumlarÄ±nÄ± manipÃ¼le eden belirli tÃ¼rde bellek sÃ¶mÃ¼rÃ¼ taktiklerini Ã¶nlemeye yardÄ±mcÄ± olur (gÃ¶receli **Ã¼zerine yazmalar**).

Bu tekniÄŸin Ã§ekirdeÄŸi bir karÄ±ÅŸtÄ±rma formÃ¼lÃ¼dÃ¼r:

**`Yeni_Ptr = (L >> 12) XOR P`**

* **L**, iÅŸaretÃ§inin **Depolama Konumu**'dur.
* **P**, gerÃ§ek **fastbin/tcache Fd Ä°ÅŸaretÃ§isi**'dir.

Depolama konumunun (L) XOR iÅŸleminden Ã¶nce 12 bit saÄŸa kaydÄ±rÄ±lmasÄ±nÄ±n nedeni kritiktir. Bu manipÃ¼lasyon, bellek adreslerinin en az anlamlÄ± 12 bitinin belirlenmiÅŸ doÄŸasÄ±yla ilgili bir zayÄ±flÄ±ÄŸÄ± ele alÄ±r. Bitleri kaydÄ±rarak, tahmin edilebilir kÄ±smÄ±n denklem dÄ±ÅŸÄ±na Ã§Ä±karÄ±lmasÄ±, yeni, karÄ±ÅŸÄ±k iÅŸaretÃ§inin rastgeleliÄŸini artÄ±rÄ±r ve bu sayede bu bitlerin tahmin edilebilirliÄŸine dayanan saldÄ±rÄ±lara karÅŸÄ± koruma saÄŸlar.

Bu karÄ±ÅŸÄ±k iÅŸaretÃ§i, programlarÄ±n kullandÄ±ÄŸÄ± adresleri rastgele hale getiren **Adres AlanÄ± DÃ¼zeni RastgeleleÅŸtirme (ASLR)** tarafÄ±ndan saÄŸlanan mevcut rastgeleliÄŸi kullanÄ±r.

Ä°ÅŸaretÃ§iyi orijinal adresi almak iÃ§in **karÄ±ÅŸtÄ±rma iÅŸlemi** aynÄ± XOR iÅŸlemi kullanÄ±larak gerÃ§ekleÅŸtirilir. Burada, karÄ±ÅŸÄ±k iÅŸaretÃ§i formÃ¼lde P olarak iÅŸlem gÃ¶rÃ¼r ve deÄŸiÅŸmeyen depolama konumu (L) ile XOR iÅŸlemine tabi tutulduÄŸunda orijinal iÅŸaretÃ§i ortaya Ã§Ä±kar. Bu karÄ±ÅŸtÄ±rma ve Ã§Ã¶zme simetrisi, sistemin bellek iÅŸaretÃ§ilerini etkili bir ÅŸekilde kodlamasÄ±na ve kodlamasÄ±na olanak tanÄ±rken, bellek iÅŸaretÃ§ilerini manipÃ¼le eden saldÄ±rÄ±lara karÅŸÄ± gÃ¼venliÄŸi Ã¶nemli Ã¶lÃ§Ã¼de artÄ±rÄ±r.

### GÃ¼venlik AvantajlarÄ±

Ä°ÅŸaretÃ§i karÄ±ÅŸtÄ±rma, heap yÃ¶netiminde **kÄ±smi ve tam iÅŸaretÃ§i Ã¼zerine yazmalarÄ± Ã¶nlemeyi amaÃ§lar**, gÃ¼venlik aÃ§Ä±sÄ±ndan Ã¶nemli bir artÄ±ÅŸ saÄŸlar. Bu Ã¶zellik, sÃ¶mÃ¼rÃ¼ tekniklerini birkaÃ§ ÅŸekilde etkiler:

1. **Bye Byte GÃ¶receli Ãœzerine YazmalarÄ±n Ã–nlenmesi**: Ã–nceden, saldÄ±rganlar, **kesin adresleri bilmeden** heap parÃ§alarÄ±nÄ± farklÄ± konumlara yÃ¶nlendirmek iÃ§in iÅŸaretÃ§inin bir kÄ±smÄ±nÄ± deÄŸiÅŸtirebilirdi, bu teknik, sÄ±zÄ±ntÄ±sÄ±z **House of Roman** sÃ¶mÃ¼rÃ¼sÃ¼nde aÃ§Ä±kÃ§a gÃ¶rÃ¼lebilir. Ä°ÅŸaretÃ§i karÄ±ÅŸtÄ±rma ile, bu tÃ¼r gÃ¶receli Ã¼zerine yazmalar **bir heap sÄ±zÄ±ntÄ±sÄ± olmadan artÄ±k kaba kuvvet gerektirir**, baÅŸarÄ±lÄ± olma olasÄ±lÄ±klarÄ±nÄ± bÃ¼yÃ¼k Ã¶lÃ§Ã¼de azaltÄ±r.
2. **Tcache Bin/Fastbin SaldÄ±rÄ±larÄ±nÄ±n ZorlaÅŸtÄ±rÄ±lmasÄ±**: Fastbin veya tcache giriÅŸlerini manipÃ¼le ederek iÅŸlev iÅŸaretÃ§ilerini (Ã¶rneÄŸin, `__malloc_hook`) Ã¼zerine yazan yaygÄ±n saldÄ±rÄ±lar engellenir. Ã–rneÄŸin, bir saldÄ±rÄ±, bir LibC adresi sÄ±zdÄ±rmayÄ±, bir parÃ§ayÄ± tcache binine serbest bÄ±rakmayÄ± ve ardÄ±ndan Fd iÅŸaretÃ§isini `__malloc_hook`'a yÃ¶nlendirmek iÃ§in Ã¼zerine yazmayÄ± iÃ§erebilir. Ä°ÅŸaretÃ§i karÄ±ÅŸtÄ±rma ile, bu iÅŸaretÃ§ilerin doÄŸru ÅŸekilde karÄ±ÅŸtÄ±rÄ±lmasÄ± gerekmektedir, **doÄŸru manipÃ¼lasyon iÃ§in bir heap sÄ±zÄ±ntÄ±sÄ± gerektirir**, bÃ¶ylece sÃ¶mÃ¼rÃ¼ engeli yÃ¼kseltilir.
3. **Heap SÄ±zÄ±ntÄ±larÄ± Ä°Ã§in Heap SÄ±zÄ±ntÄ±larÄ± GerekliliÄŸi**: Sahte bir parÃ§a oluÅŸturmak artÄ±k heap sÄ±zÄ±ntÄ±sÄ± gerektiren non-heap alanlarda (Ã¶rneÄŸin, yÄ±ÄŸÄ±n, .bss bÃ¶lÃ¼mÃ¼ veya PLT/GOT) da **gereklidir**. Bu, bu alanlarÄ±n sÃ¶mÃ¼rÃ¼lmesinin karmaÅŸÄ±klÄ±ÄŸÄ±nÄ± artÄ±rÄ±r, LibC adreslerini manipÃ¼le etme gereksinimi gibi.
4. **Heap Adreslerinin SÄ±zdÄ±rÄ±lmasÄ± Daha Zor Hale Gelir**: Ä°ÅŸaretÃ§i karÄ±ÅŸtÄ±rma, fastbin ve tcache kutularÄ±ndaki Fd iÅŸaretÃ§ilerinin heap adres sÄ±zÄ±ntÄ±larÄ± iÃ§in kullanÄ±ÅŸlÄ±lÄ±ÄŸÄ±nÄ± kÄ±sÄ±tlar. Bununla birlikte, sÄ±ralanmamÄ±ÅŸ, kÃ¼Ã§Ã¼k ve bÃ¼yÃ¼k kutulardaki iÅŸaretÃ§iler karÄ±ÅŸtÄ±rÄ±lmamÄ±ÅŸ olarak kalÄ±r, bu nedenle hala adres sÄ±zÄ±ntÄ±larÄ± iÃ§in kullanÄ±labilirler. Bu deÄŸiÅŸiklik, saldÄ±rganlarÄ± bu kutularda sÃ¶mÃ¼rÃ¼lebilir bilgileri keÅŸfetmeye zorlar, ancak bazÄ± teknikler hala bir sÄ±zÄ±ntÄ±dan Ã¶nce iÅŸaretÃ§ilerin Ã§Ã¶zÃ¼lmesine izin verebilir, ancak kÄ±sÄ±tlamalarla.

### **Heap SÄ±zÄ±ntÄ±sÄ± ile Ä°ÅŸaretÃ§ilerin Ã‡Ã¶zÃ¼lmesi**

{% hint style="danger" %}
Ä°ÅŸlemi daha iyi aÃ§Ä±klamak iÃ§in [**buradan orijinal gÃ¶nderiyi kontrol edin**](https://maxwelldulin.com/BlogPost?post=5445977088).
{% endhint %}

### Algoritma Genel BakÄ±ÅŸ

Ä°ÅŸaretÃ§ilerin karÄ±ÅŸtÄ±rÄ±lmasÄ± ve Ã§Ã¶zÃ¼lmesi iÃ§in kullanÄ±lan formÃ¼l:&#x20;

**`Yeni_Ptr = (L >> 12) XOR P`**

Burada **L**, depolama konumu ve **P**, Fd iÅŸaretÃ§isidir. **L**'nin 12 bit saÄŸa kaydÄ±rÄ±lmasÄ±yla, **XOR**'un doÄŸasÄ± gereÄŸi, kendisiyle XOR iÅŸlemi yapÄ±ldÄ±ÄŸÄ±nda 0 Ã§Ä±ktÄ±ÄŸÄ±ndan dolayÄ±, **P**'nin en Ã¼st 12 bitini elde edersiniz.

**Algoritmadaki Ana AdÄ±mlar:**

1. **En Ã–nemli Bitlerin BaÅŸlangÄ±Ã§ SÄ±zÄ±ntÄ±sÄ±**: KaydÄ±rÄ±lmÄ±ÅŸ **L**'yi **P** ile XORladÄ±ÄŸÄ±nÄ±zda, kaydÄ±rÄ±lmÄ±ÅŸ **L**'nin sÄ±fÄ±r olacaÄŸÄ±ndan dolayÄ±, **P**'nin ilgili bitleri deÄŸiÅŸmeden kalÄ±r ve **P**'nin en Ã¼st 12 bitini elde edersiniz.
2. **Ä°ÅŸaretÃ§i Bitlerinin KurtarÄ±lmasÄ±**: XOR tersine Ã§evrilebilir olduÄŸundan, sonucu ve bir operatÃ¶rÃ¼ bildiÄŸinizde diÄŸer operatÃ¶rÃ¼ hesaplayabilirsiniz. Bu Ã¶zellik, karÄ±ÅŸÄ±k iÅŸaretÃ§inin parÃ§alarÄ±nÄ± sÄ±rayla XORlayarak **P**'nin tam kÃ¼mesini Ã§Ä±karmak iÃ§in kullanÄ±lÄ±r.
3. **Ä°teratif KarÄ±ÅŸtÄ±rma Ã‡Ã¶zme**: Ä°ÅŸlem, her seferinde Ã¶nceki adÄ±mdan elde edilen **P**'nin yeni keÅŸfedilen bitlerini kullanarak tekrarlanÄ±r, tÃ¼m bitler kurtarÄ±ldÄ±ÄŸÄ±nda.
4. **Belirlenen Bitlerin Ä°ÅŸlenmesi**: KaydÄ±rma nedeniyle **L**'nin son 12 biti kaybolur, ancak bunlar belirlidir ve iÅŸlem sonrasÄ± yeniden oluÅŸturulabilir.

Bu algoritmanÄ±n bir uygulamasÄ±nÄ± burada bulabilirsiniz: [https://github.com/mdulin2/mangle](https://github.com/mdulin2/mangle)
## Pointer Guard

Pointer guard, glibc'de kullanÄ±lan bir sÃ¶mÃ¼rÃ¼ koruma tekniÄŸidir ve Ã¶zellikle `atexit()` gibi kÃ¼tÃ¼phane Ã§aÄŸrÄ±larÄ± tarafÄ±ndan kaydedilen iÅŸlev iÅŸaretÃ§ilerini korumak iÃ§in kullanÄ±lÄ±r. Bu koruma, iÅŸaretÃ§ileri `fs:0x30` konumundaki bir gizli deÄŸerle XOR iÅŸlemine tabi tutarak ve bit dÃ¼zeyinde bir dÃ¶ndÃ¼rme iÅŸlemi uygulayarak karÄ±ÅŸtÄ±rarak gerÃ§ekleÅŸtirilir. Bu mekanizma, saldÄ±rganlarÄ±n iÅŸlev iÅŸaretÃ§ilerini Ã¼zerine yazarak kontrol akÄ±ÅŸÄ±nÄ± ele geÃ§irmesini engellemeyi amaÃ§lar.

### **Pointer Guard'Ä± Bir SÄ±zÄ±ntÄ± ile Atlatma**

1. **Pointer Guard Ä°ÅŸlemlerini Anlama:** Ä°ÅŸaretÃ§ilerin karÄ±ÅŸtÄ±rÄ±lmasÄ± `PTR_MANGLE` makrosu kullanÄ±larak yapÄ±lÄ±r. Bu makro iÅŸaretÃ§iyi bir 64 bitlik gizli deÄŸerle XOR'lar ve ardÄ±ndan 0x11 bitlik bir sola dÃ¶ndÃ¼rme iÅŸlemi gerÃ§ekleÅŸtirir. Orijinal iÅŸaretÃ§iyi kurtarmak iÃ§in ters iÅŸlem `PTR_DEMANGLE` tarafÄ±ndan gerÃ§ekleÅŸtirilir.
2. **SaldÄ±rÄ± Stratejisi:** SaldÄ±rÄ±, bilinen-metin yaklaÅŸÄ±mÄ±na dayanÄ±r, saldÄ±rganÄ±n karÄ±ÅŸtÄ±rma iÃ§in kullanÄ±lan gizli deÄŸeri Ã§Ä±karmak iÃ§in bir iÅŸaretÃ§inin hem orijinal hem de karÄ±ÅŸtÄ±rÄ±lmÄ±ÅŸ sÃ¼rÃ¼mlerini bilmelidir.
3. **Bilinen Metinlerin SÃ¶mÃ¼rÃ¼lmesi:**
* **Sabit Ä°ÅŸlev Ä°ÅŸaretÃ§ilerini TanÄ±mlama:** glibc kaynak kodunu inceleyerek veya `__libc_pthread_functions` gibi baÅŸlatÄ±lmÄ±ÅŸ iÅŸlev iÅŸaretÃ§isi tablolarÄ±nÄ± inceleyerek, saldÄ±rgan Ã¶ngÃ¶rÃ¼lebilir iÅŸlev iÅŸaretÃ§ileri bulabilir.
* **Gizli DeÄŸeri Hesaplama:** `__pthread_attr_destroy` gibi bilinen bir iÅŸlev iÅŸaretÃ§isi ve iÅŸlev iÅŸaretÃ§isi tablosundan karÄ±ÅŸtÄ±rÄ±lmÄ±ÅŸ sÃ¼rÃ¼mÃ¼ kullanarak, gizli deÄŸer, karÄ±ÅŸtÄ±rÄ±lmÄ±ÅŸ iÅŸaretÃ§iyi ters dÃ¶ndÃ¼rerek (saÄŸa dÃ¶ndÃ¼rme) ve ardÄ±ndan iÅŸlevin adresiyle XOR iÅŸlemi yaparak hesaplanabilir.
4. **Alternatif Metinler:** SaldÄ±rgan, bellekte tanÄ±nabilir desenler oluÅŸturup oluÅŸturmadÄ±ÄŸÄ±nÄ± gÃ¶rmek iÃ§in bilinen deÄŸerlerle (Ã¶rneÄŸin 0 veya -1) iÅŸaretÃ§ileri karÄ±ÅŸtÄ±rmayÄ± deneyebilir; bu desenler bellek dÃ¶kÃ¼mlerinde bulunduÄŸunda gizli deÄŸeri ortaya Ã§Ä±karabilir.
5. **Pratik Uygulama:** Gizli deÄŸeri hesapladÄ±ktan sonra, bir saldÄ±rgan libc taban adresini ve keyfi bellek konumlarÄ±nÄ± okuma yeteneÄŸi ile Ã§oklu iÅŸ parÃ§acÄ±klÄ± bir uygulamada Pointer Guard korumasÄ±nÄ± atlayabilir, iÅŸaretÃ§ileri kontrol edilmiÅŸ bir ÅŸekilde manipÃ¼le edebilir.

## Referanslar

* [https://maxwelldulin.com/BlogPost?post=5445977088](https://maxwelldulin.com/BlogPost?post=5445977088)
* [https://blog.infosectcbr.com.au/2020/04/bypassing-pointer-guard-in-linuxs-glibc.html?m=1](https://blog.infosectcbr.com.au/2020/04/bypassing-pointer-guard-in-linuxs-glibc.html?m=1)
