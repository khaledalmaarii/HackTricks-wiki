# Ochrona libc

{% hint style="success" %}
Dowiedz si i wicz hakowanie AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Dowiedz si i wicz hakowanie GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) albo **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na githubie.

</details>
{% endhint %}

## Egzekwowanie Wyr贸wnania Chunk贸w

**Malloc** alokuje pami w grupach **8 bajt贸w (32-bit) lub 16 bajt贸w (64-bit)**. Oznacza to, 偶e koniec chunk贸w w systemach 32-bitowych powinien by wyr贸wnany do **0x8**, a w systemach 64-bitowych do **0x0**. Funkcja bezpieczestwa sprawdza, czy ka偶dy chunk **jest poprawnie wyr贸wnany** na tych konkretnych lokalizacjach przed u偶yciem wska藕nika z pojemnika.

### Korzyci dla Bezpieczestwa

Egzekwowanie wyr贸wnania chunk贸w w systemach 64-bitowych znaczco zwiksza bezpieczestwo Malloc poprzez **ograniczenie umieszczania faszywych chunk贸w tylko na 1 z ka偶dych 16 adres贸w**. Sprawia to, 偶e wysiki eksploatacyjne s bardziej skomplikowane, zwaszcza w scenariuszach, gdzie u偶ytkownik ma ograniczon kontrol nad wartociami wejciowymi, co sprawia, 偶e ataki s bardziej zo偶one i trudniejsze do wykonania pomylnie.

* **Atak Fastbin na \_\_malloc\_hook**

Nowe zasady wyr贸wnania w Malloc uniemo偶liwiaj r贸wnie偶 klasyczny atak polegajcy na manipulowaniu `__malloc_hook`. Wczeniej atakujcy mogli manipulowa rozmiarami chunk贸w, aby **nadpisa ten wska藕nik funkcji** i uzyska **wykonanie kodu**. Teraz surowe wymagania co do wyr贸wnania zapewniaj, 偶e takie manipulacje nie s ju偶 mo偶liwe, zamykajc powszechn drog eksploatacji i zwikszajc og贸lne bezpieczestwo.

## Mieszanie Wska藕nik贸w na fastbinach i tcache

**Mieszanie Wska藕nik贸w** to zabezpieczenie u偶ywane do ochrony **wska藕nik贸w Fd fastbin贸w i tcache** w operacjach zarzdzania pamici. Ta technika pomaga zapobiega pewnym rodzajom taktyk eksploatacji pamici, zwaszcza tym, kt贸re nie wymagaj wycieku informacji o pamici lub manipulowania lokalizacjami pamici bezporednio wzgldem znanych pozycji (nadpisywanie **wzgldne**).

Rdzeniem tej techniki jest wz贸r obfuskacji:

**`Nowy_Wska藕nik = (L >> 12) XOR P`**

* **L** to **Lokalizacja Przechowywania** wska藕nika.
* **P** to rzeczywisty **Wska藕nik Fd fastbinu/tcache**.

Pow贸d przesunicia bitowego lokalizacji przechowywania (L) o 12 bit贸w w prawo przed operacj XOR jest kluczowy. Ta manipulacja adresuje podatno wynikajc z deterministycznej natury najmniej znaczcych 12 bit贸w adres贸w pamici, kt贸re zazwyczaj s przewidywalne ze wzgldu na ograniczenia architektury systemu. Przesunicie bit贸w przenosi przewidywaln cz z r贸wnania, zwikszajc losowo nowego, zmieszanego wska藕nika i tym samym zabezpieczajc przed atakami polegajcymi na przewidywalnoci tych bit贸w.

Ten zmieszany wska藕nik wykorzystuje istniejc losowo zapewnian przez **Losow Ukadank Przestrzeni Adresowej (ASLR)**, kt贸ra losowo ustala adresy u偶ywane przez programy, aby utrudni atakujcym przewidywanie ukadu pamici procesu.

**Demiksowanie** wska藕nika w celu odzyskania oryginalnego adresu polega na u偶yciu tej samej operacji XOR. Tutaj zmieszany wska藕nik jest traktowany jako P w formule, a gdy jest XORowany z niezmienion lokalizacj przechowywania (L), odsania oryginalny wska藕nik. Ta symetria w mieszaniu i demiksowaniu zapewnia, 偶e system mo偶e efektywnie kodowa i dekodowa wska藕niki bez znaczcego narzutu, jednoczenie znacznie zwikszajc bezpieczestwo przed atakami manipulujcymi wska藕nikami pamici.

### Korzyci dla Bezpieczestwa

Mieszanie wska藕nik贸w ma na celu **zapobieganie nadpisywaniu czciowego i penego wska藕nika w stercie**, co stanowi znaczce wzmocnienie bezpieczestwa. Ta funkcja wpywa na techniki eksploatacji w kilku aspektach:

1. **Zapobieganie Nadpisywaniu Wska藕nik贸w Wzgldnych Bye Byte**: Wczeniej atakujcy mogli zmieni cz wska藕nika, aby **przekierowa chunki sterty na inne lokalizacje bez znajomoci dokadnych adres贸w**, technika widoczna w eksploacie **House of Roman** bez wycieku sterty. Dziki mieszaniu wska藕nik贸w, takie nadpisywanie wzgldne **bez wycieku sterty teraz wymaga ataku brute force**, drastycznie zmniejszajc szanse na sukces.
2. **Zwikszenie Trudnoci Atak贸w na Tcache Bin/Fastbin**: Powszechne ataki, kt贸re nadpisuj wska藕niki funkcji (jak `__malloc_hook`) poprzez manipulowanie wpisami fastbin贸w lub tcache, s utrudnione. Na przykad atak mo偶e polega na wycieku adresu LibC, zwolnieniu chunka do tcache binu, a nastpnie nadpisaniu wska藕nika Fd, aby przekierowa go do `__malloc_hook` w celu wykonania arbitralnego kodu. Dziki mieszaniu wska藕nik贸w, te wska藕niki musz by poprawnie zmieszane, **wymagajc wycieku sterty do dokadnej manipulacji**, podnoszc tym samym barier eksploatacji.
3. **Wymaganie Wycieku Sterty w Lokacjach Spoza Sterty**: Utworzenie faszywego chunka w obszarach spoza sterty (jak stos, sekcja .bss lub PLT/GOT) teraz r贸wnie偶 **wymaga wycieku sterty** ze wzgldu na konieczno mieszania wska藕nik贸w. To zwiksza zo偶ono eksploatowania tych obszar贸w, podobnie jak wymaganie manipulowania adresami LibC.
4. **Wyciek Adres贸w Sterty Staje Si Trudniejszy**: Mieszanie wska藕nik贸w ogranicza przydatno wska藕nik贸w Fd w fastbinach i tcache binach jako 藕r贸de wyciek贸w adres贸w sterty. Jednak wska藕niki w nieuporzdkowanych, maych i du偶ych binach pozostaj niezmieszane, nadal nadaj si do wyciek贸w adres贸w. Ten przesunicie zmusza atakujcych do eksplorowania tych bin贸w w poszukiwaniu informacji podatnych na eksploatacj, chocia偶 niekt贸re techniki mog nadal pozwala na demiksowanie wska藕nik贸w przed wyciekiem, cho z ograniczeniami.

### **Demiksowanie Wska藕nik贸w z Wyciekiem Sterty**

{% hint style="danger" %}
Dla lepszego wyjanienia procesu [**sprawd藕 oryginalny post tutaj**](https://maxwelldulin.com/BlogPost?post=5445977088).
{% endhint %}

### Przegld Algorytmu

Wz贸r u偶ywany do mieszania i demiksowania wska藕nik贸w to:&#x20;

**`Nowy_Wska藕nik = (L >> 12) XOR P`**

Gdzie **L** to lokalizacja przechowywania, a **P** to wska藕nik Fd. Przesunicie **L** w prawo o 12 bit贸w pozwala uzyska najbardziej znaczce bity **P**, ze wzgldu na natur operacji **XOR**, kt贸ra zwraca 0, gdy bity s XORowane ze sob.

**Kluczowe Kroki w Algorytmie:**

1. **Pocztkowe Wycieki Najbardziej Znaczcych Bit贸w**: Poprzez XORowanie przesunitego **L** z **P**, efektywnie otrzymujesz 12 najbardziej znaczcych bit贸w **P**, poniewa偶 przesunita cz **L** bdzie zerem, pozostawiajc niezmienione bity odpowiadajce **P**.
2. **Odzyskiwanie Bit贸w Wska藕nika**: Poniewa偶 XOR jest odwracalny, znajomo wyniku i jednego z operand贸w pozwala obliczy drugi operand. Ta waciwo jest wykorzystywana do wydedukowania caego zestawu bit贸w dla **P**, poprzez sukcesywne XORowanie znanych zestaw贸w bit贸w z czciami zmieszanego wska藕nika.
3. **Iteracyjne Demiksowanie**: Proces jest powtarzany, za ka偶dym razem u偶ywajc nowo odkrytych bit贸w **P** z poprzedniego kroku do dekodowania kolejnego segmentu zmieszanego wska藕nika, a偶 wszystkie bity zostan odzyskane.
4. **Obsuga Deterministycznych Bit贸w**: Ostatnie 12 bit贸w **L** s tracone z powodu przesunicia, ale s one deterministyczne i mog by odtworzone po procesie.

Mo偶esz znale藕 implementacj tego algorytmu tutaj: [https://github.com/mdulin2/mangle](https://github.com/mdulin2/mangle)
## Ochrona wska藕nika

Ochrona wska藕nika to technika zabezpiecze wykorzystywana w bibliotece glibc do ochrony przechowywanych wska藕nik贸w funkcji, zwaszcza tych zarejestrowanych przez wywoania biblioteczne, takie jak `atexit()`. Ochrona ta polega na przemieszaniu wska藕nik贸w poprzez operacj XOR z sekretem przechowywanym w danych wtku (`fs:0x30`) i zastosowaniu bitowej rotacji. Mechanizm ten ma na celu zapobieganie atakom polegajcym na przejciu kontroli poprzez nadpisanie wska藕nik贸w funkcji.

### **Ominicie ochrony wska藕nika za pomoc wycieku**

1. **Zrozumienie operacji ochrony wska藕nika:** Przemieszanie wska藕nik贸w jest wykonywane za pomoc makra `PTR_MANGLE`, kt贸re wykonuje operacj XOR na wska藕niku z 64-bitowym tajnym kluczem, a nastpnie wykonuje lew rotacj o 0x11 bit贸w. Operacja odwrotna do odzyskania pierwotnego wska藕nika jest obsugiwana przez `PTR_DEMANGLE`.
2. **Strategia ataku:** Atak opiera si na podejciu znanych tekst贸w jawnie, gdzie atakujcy musi zna zar贸wno oryginaln, jak i przemieszan wersj wska藕nika, aby wydedukowa u偶yty do przemieszania sekret.
3. **Wykorzystanie znanych tekst贸w jawnie:**
* **Identyfikacja staych wska藕nik贸w funkcji:** Poprzez analiz kodu 藕r贸dowego glibc lub zainicjowanych tabel wska藕nik贸w funkcji (np. `__libc_pthread_functions`), atakujcy mo偶e znale藕 przewidywalne wska藕niki funkcji.
* **Obliczanie sekretu:** Korzystajc z znanego wska藕nika funkcji, takiego jak `__pthread_attr_destroy` i jego przemieszanej wersji z tabeli wska藕nik贸w funkcji, sekret mo偶na obliczy poprzez odwr贸cenie rotacji (prawej rotacji) przemieszanego wska藕nika, a nastpnie wykonanie operacji XOR z adresem funkcji.
4. **Alternatywne teksty jawnie:** Atakujcy mo偶e r贸wnie偶 eksperymentowa z przemieszaniem wska藕nik贸w znanymi wartociami, takimi jak 0 lub -1, aby sprawdzi, czy powoduj one rozpoznawalne wzorce w pamici, potencjalnie ujawniajc sekret, gdy te wzorce zostan znalezione w zrzutach pamici.
5. **Zastosowanie praktyczne:** Po obliczeniu sekretu atakujcy mo偶e manipulowa wska藕nikami w kontrolowany spos贸b, w zasadzie omijajc ochron wska藕nika w aplikacji wielowtkowej z znajomoci adresu bazowego libc i mo偶liwoci odczytu dowolnych lokalizacji pamici.

## Odnoniki

* [https://maxwelldulin.com/BlogPost?post=5445977088](https://maxwelldulin.com/BlogPost?post=5445977088)
* [https://blog.infosectcbr.com.au/2020/04/bypassing-pointer-guard-in-linuxs-glibc.html?m=1](https://blog.infosectcbr.com.au/2020/04/bypassing-pointer-guard-in-linuxs-glibc.html?m=1)
