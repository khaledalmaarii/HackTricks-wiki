# Bellek Etiketleme UzantÄ±sÄ± (MTE)

<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan ileri seviyeye Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong> ile!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **ğŸ’¬ [Discord grubumuza](https://discord.gg/hRep4RUj7f) katÄ±lÄ±n veya [telegram grubuna](https://t.me/peass) katÄ±lÄ±n veya bizi Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR'lar gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>

## Temel Bilgiler

Bellek Etiketleme UzantÄ±sÄ± (MTE), **bellek ile ilgili hatalarÄ± tespit ederek ve Ã¶nleyerek** yazÄ±lÄ±m gÃ¼venilirliÄŸini ve gÃ¼venliÄŸini artÄ±rmak amacÄ±yla tasarlanmÄ±ÅŸtÄ±r, Ã¶rneÄŸin tampon taÅŸmalarÄ± ve kullanÄ±mdan sonra serbest bÄ±rakÄ±lan gÃ¼venlik aÃ§Ä±klarÄ±nÄ±. MTE, **ARM** mimarisinin bir parÃ§asÄ± olarak, her bellek tahsisine bir **kÃ¼Ã§Ã¼k etiket eklemek** ve o belleÄŸi referans alan her bir iÅŸaretÃ§iye **ilgili bir etiket eklemek** iÃ§in bir mekanizma saÄŸlar. Bu yaklaÅŸÄ±m, yasadÄ±ÅŸÄ± bellek eriÅŸimlerini Ã§alÄ±ÅŸma zamanÄ±nda tespit etmeyi saÄŸlar ve bu tÃ¼r gÃ¼venlik aÃ§Ä±klarÄ±nÄ± kÃ¶tÃ¼ amaÃ§lÄ± kod yÃ¼rÃ¼tmek iÃ§in kullanma riskini Ã¶nemli Ã¶lÃ§Ã¼de azaltÄ±r.

### **Bellek Etiketleme UzantÄ±sÄ± NasÄ±l Ã‡alÄ±ÅŸÄ±r**

MTE, belleÄŸi **kÃ¼Ã§Ã¼k, sabit boyutlu bloklara bÃ¶ler ve her bloÄŸa bir etiket atar**, genellikle birkaÃ§ bit boyutunda.&#x20;

Bir iÅŸaretÃ§i o belleÄŸi iÅŸaret etmek Ã¼zere oluÅŸturulduÄŸunda, aynÄ± etiketi alÄ±r. Bu etiket, bir bellek iÅŸaretÃ§isinin **kullanÄ±lmayan bitlerinde** saklanÄ±r ve etiketi, karÅŸÄ±lÄ±k gelen bellek bloÄŸuna baÄŸlar.

<figure><img src="../../.gitbook/assets/image (1199).png" alt=""><figcaption><p><a href="https://www.youtube.com/watch?v=UwMt0e_dC_Q">https://www.youtube.com/watch?v=UwMt0e_dC_Q</a></p></figcaption></figure>

Bir program bir iÅŸaretÃ§i aracÄ±lÄ±ÄŸÄ±yla belleÄŸe eriÅŸtiÄŸinde, MTE donanÄ±mÄ± **iÅŸaretÃ§inin etiketinin bellek bloÄŸunun etiketiyle eÅŸleÅŸip eÅŸleÅŸmediÄŸini** kontrol eder. Etiketler **eÅŸleÅŸmiyorsa**, yasadÄ±ÅŸÄ± bellek eriÅŸimini gÃ¶sterir.

### MTE Ä°ÅŸaretÃ§i Etiketleri

Ä°ÅŸaretÃ§i iÃ§indeki etiketler, en Ã¼st baytÄ±n iÃ§indeki 4 bit iÃ§inde saklanÄ±r:

<figure><img src="../../.gitbook/assets/image (1200).png" alt=""><figcaption><p><a href="https://www.youtube.com/watch?v=UwMt0e_dC_Q">https://www.youtube.com/watch?v=UwMt0e_dC_Q</a></p></figcaption></figure>

Bu nedenle, bu, **16 farklÄ± etiket deÄŸerine** kadar olanak tanÄ±r.

### MTE Bellek Etiketleri

Her **16B fiziksel belleÄŸin** karÅŸÄ±lÄ±k gelen bir **bellek etiketi** vardÄ±r.

Bellek etiketleri, **Ã¶zel bir RAM bÃ¶lgesinde** saklanÄ±r (normal kullanÄ±m iÃ§in eriÅŸilemez). 16B bellek etiketleri iÃ§in 4 bit etiketlere kadar RAM'Ä±n %3'Ã¼ne kadar.

ARM, bu etiketleri Ã¶zel RAM belleÄŸinde iÅŸlemek iÃ§in aÅŸaÄŸÄ±daki talimatlarÄ± tanÄ±tÄ±r:
```
STG [<Xn/SP>], #<simm>    Store Allocation (memory) Tag
LDG <Xt>, [<Xn/SP>]       Load Allocatoin (memory) Tag
IRG <Xd/SP>, <Xn/SP>      Insert Random [pointer] Tag
...
```
## Kontrol ModlarÄ±

### Senkron

CPU, etiketleri **komut yÃ¼rÃ¼tÃ¼lÃ¼rken** kontrol eder, eÅŸleÅŸme olursa bir istisna oluÅŸturur.\
Bu en yavaÅŸ ve en gÃ¼venlidir.

### Asenkron

CPU etiketleri **asenkron olarak** kontrol eder ve bir eÅŸleÅŸme bulunduÄŸunda bir istisna bitini bir sistem kaydÄ±nda ayarlar. Bu Ã¶ncekinden **daha hÄ±zlÄ±**dÄ±r ancak eÅŸleÅŸmeye neden olan tam komutu belirleyemez ve istisnayÄ± hemen oluÅŸturmaz, saldÄ±rganÄ±n saldÄ±rÄ±sÄ±nÄ± tamamlamasÄ± iÃ§in bir sÃ¼re verir.

### KarÄ±ÅŸÄ±k

???

## Uygulama ve Tespit Ã–rnekleri

DonanÄ±m Etiket TabanlÄ± KASAN olarak adlandÄ±rÄ±lan MTE tabanlÄ± KASAN veya Ã§ekirdek MTE.\
Ã‡ekirdek tahsis edicileri (`kmalloc` gibi) bu modÃ¼lÃ¼ **Ã§aÄŸÄ±racak** ve kullanÄ±lacak etiketi (rastgele) hazÄ±rlayacak ve ayrÄ±lan Ã§ekirdek alanÄ±na ekleyecek ve dÃ¶ndÃ¼rÃ¼len iÅŸaretÃ§iye ekleyecektir.

Talep edilen boyut iÃ§in yeterli bellek granÃ¼lÃ¼ **yalnÄ±zca iÅŸaretleyecektir** (her biri 16B). Bu nedenle, talep edilen boyut 35 ise ve 60B'lik bir plak verildiyse, ilk 16\*3 = 48B'yi bu etiketle iÅŸaretleyecek ve **geri kalanÄ±** sÃ¶zde **geÃ§ersiz bir etiketle (0xE)** iÅŸaretleyecektir.

Etiket **0xF**, **tÃ¼m iÅŸaretÃ§iyi eÅŸleÅŸtirir**. Bu iÅŸaretÃ§iye sahip bir bellek, belleÄŸine eriÅŸmek iÃ§in **herhangi bir etiketin kullanÄ±lmasÄ±na izin verir** (eÅŸleÅŸmeler yok). Bu, saldÄ±rÄ±yÄ± algÄ±lamasÄ±nÄ± Ã¶nleyebilir. 

Bu nedenle, yalnÄ±zca **14 deÄŸer** kullanÄ±labilir, 0xE ve 0xF ayrÄ±lmÄ±ÅŸ olduÄŸundan, etiketleri **yeniden kullanma olasÄ±lÄ±ÄŸÄ±** 1/17 -> yaklaÅŸÄ±k **%7**.

Ã‡ekirdek **geÃ§ersiz etiket granÃ¼lÃ¼ne** eriÅŸirse, **uyumsuzluk** algÄ±lanÄ±r. BaÅŸka bir bellek konumuna eriÅŸirse, belleÄŸin farklÄ± bir etikete sahip olmasÄ± durumunda (veya geÃ§ersiz etiket), uyumsuzluk algÄ±lanÄ±r. SaldÄ±rgan ÅŸanslÄ±ysa ve bellek aynÄ± etiketi kullanÄ±yorsa, algÄ±lanmaz. Åanslar yaklaÅŸÄ±k %7'dir.

BaÅŸka bir hata, ayrÄ±lan belleÄŸin **son granÃ¼lÃ¼nde** meydana gelir. Uygulama 35B istediÄŸinde, 32 ila 48 arasÄ±ndan granÃ¼l verildi. Bu nedenle, 36 ila 47 arasÄ±ndaki baytlar aynÄ± etiketi kullanÄ±yor ancak istenmedi. SaldÄ±rgan bu ekstra baytlara eriÅŸirse, bu **algÄ±lanmaz**.

**`kfree()`** Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda, bellek geÃ§ersiz bellek etiketiyle tekrar etiketlenir, bu nedenle bir **serbest bÄ±rakma sonrasÄ± kullanÄ±mda**, belleÄŸe tekrar eriÅŸildiÄŸinde, **uyumsuzluk algÄ±lanÄ±r**.

Ancak, bir serbest bÄ±rakma sonrasÄ± kullanÄ±mda, aynÄ± **parÃ§a Ã¶ncekiyle AYNI etiketle** yeniden tahsis edilirse, bir saldÄ±rgan bu eriÅŸimi kullanabilir ve bu algÄ±lanmaz (yaklaÅŸÄ±k %7 ÅŸans).

AyrÄ±ca, yalnÄ±zca **`slab` ve `page_alloc`** etiketli bellek kullanÄ±r ancak gelecekte bu, `vmalloc`, `stack` ve `globals`da da kullanÄ±lacaktÄ±r (videonun Ã§ekildiÄŸi sÄ±rada bunlar hala kÃ¶tÃ¼ye kullanÄ±labilir).

Bir **uyumsuzluk algÄ±landÄ±ÄŸÄ±nda**, Ã§ekirdek **panik yapar** ve daha fazla kÃ¶tÃ¼ye kullanÄ±m ve saldÄ±rÄ± denemesini Ã¶nlemek iÃ§in (MTE yanlÄ±ÅŸ pozitiflere sahip deÄŸildir).

## Referanslar

* [https://www.youtube.com/watch?v=UwMt0e\_dC\_Q](https://www.youtube.com/watch?v=UwMt0e\_dC\_Q)
