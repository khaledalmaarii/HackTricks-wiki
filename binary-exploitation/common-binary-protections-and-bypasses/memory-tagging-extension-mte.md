# Bellek Etiketleme UzantÄ±sÄ± (MTE)

<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan ileri seviyeye Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong> ile!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ±zÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katÄ±lÄ±n veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)'da takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>

## Temel Bilgiler

**Bellek Etiketleme UzantÄ±sÄ± (MTE)**, **Ã¶nbellek taÅŸmalarÄ± ve kullanÄ±mdan sonra serbest bÄ±rakÄ±lan gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit ederek ve Ã¶nleyerek**, yazÄ±lÄ±m gÃ¼venilirliÄŸini ve gÃ¼venliÄŸini artÄ±rmak amacÄ±yla tasarlanmÄ±ÅŸtÄ±r. MTE, **ARM** mimarisinin bir parÃ§asÄ± olarak, her bellek tahsisine **kÃ¼Ã§Ã¼k bir etiket eklemek** ve o belleÄŸi iÅŸaretleyen her iÅŸaretÃ§iye **ilgili bir etiket eklemek** iÃ§in bir mekanizma saÄŸlar. Bu yaklaÅŸÄ±m, Ã§alÄ±ÅŸma zamanÄ±nda yasadÄ±ÅŸÄ± bellek eriÅŸimlerinin tespitine olanak tanÄ±r ve bu tÃ¼r gÃ¼venlik aÃ§Ä±klarÄ±nÄ±n kÃ¶tÃ¼ amaÃ§lÄ± kod yÃ¼rÃ¼tmek iÃ§in kullanÄ±lma riskini Ã¶nemli Ã¶lÃ§Ã¼de azaltÄ±r.

### **Bellek Etiketleme UzantÄ±sÄ± NasÄ±l Ã‡alÄ±ÅŸÄ±r**

MTE, belleÄŸi **kÃ¼Ã§Ã¼k, sabit boyutlu bloklara bÃ¶ler ve her bloÄŸa bir etiket atar**, genellikle birkaÃ§ bit boyutunda.

Bir iÅŸaretÃ§i o belleÄŸi iÅŸaretlemek Ã¼zere oluÅŸturulduÄŸunda, aynÄ± etiketi alÄ±r. Bu etiket, bir bellek iÅŸaretÃ§isinin **kullanÄ±lmayan bitlerinde** saklanÄ±r ve etiketi ilgili bellek bloÄŸuna baÄŸlar.

<figure><img src="../../.gitbook/assets/image (1202).png" alt=""><figcaption><p><a href="https://www.youtube.com/watch?v=UwMt0e_dC_Q">https://www.youtube.com/watch?v=UwMt0e_dC_Q</a></p></figcaption></figure>

Bir program bir iÅŸaretÃ§i aracÄ±lÄ±ÄŸÄ±yla belleÄŸe eriÅŸtiÄŸinde, MTE donanÄ±mÄ± **iÅŸaretÃ§inin etiketinin bellek bloÄŸunun etiketiyle eÅŸleÅŸip eÅŸleÅŸmediÄŸini** kontrol eder. Etiketler **eÅŸleÅŸmiyorsa**, yasadÄ±ÅŸÄ± bellek eriÅŸimini gÃ¶sterir.

### MTE Ä°ÅŸaretÃ§i Etiketleri

Ä°ÅŸaretÃ§i iÃ§indeki etiketler, en Ã¼st baytÄ±n iÃ§indeki 4 bit iÃ§inde saklanÄ±r:

<figure><img src="../../.gitbook/assets/image (1203).png" alt=""><figcaption><p><a href="https://www.youtube.com/watch?v=UwMt0e_dC_Q">https://www.youtube.com/watch?v=UwMt0e_dC_Q</a></p></figcaption></figure>

Bu nedenle, bu, **16 farklÄ± etiket deÄŸerine** kadar olanak tanÄ±r.

### MTE Bellek Etiketleri

Her **16B fiziksel belleÄŸin** karÅŸÄ±lÄ±k gelen bir **bellek etiketi** vardÄ±r.

Bellek etiketleri, **Ã¶zel bir RAM bÃ¶lgesinde** saklanÄ±r (normal kullanÄ±m iÃ§in eriÅŸilemez). 16B bellek etiketleri iÃ§in 4 bit etiketlere kadar RAM'Ä±n %3'Ã¼ne kadar. 

ARM, bu etiketleri Ã¶zel RAM bellekte manipÃ¼le etmek iÃ§in aÅŸaÄŸÄ±daki talimatlarÄ± tanÄ±tÄ±r:
```
STG [<Xn/SP>], #<simm>    Store Allocation (memory) Tag
LDG <Xt>, [<Xn/SP>]       Load Allocatoin (memory) Tag
IRG <Xd/SP>, <Xn/SP>      Insert Random [pointer] Tag
...
```
## Kontrol ModlarÄ±

### Senkron

CPU, etiketleri **talimatÄ± yÃ¼rÃ¼tÃ¼rken** kontrol eder, eÅŸleÅŸme olursa bir istisna oluÅŸturur.\
Bu en yavaÅŸ ve en gÃ¼venlidir.

### Asenkron

CPU etiketleri **asenkron olarak** kontrol eder ve bir eÅŸleÅŸme bulunduÄŸunda bir istisna bitini bir sistem kaydÄ±nda ayarlar. Bu Ã¶ncekinden **daha hÄ±zlÄ±**dÄ±r ancak eÅŸleÅŸmeye neden olan tam talimatÄ± belirleyemez ve istisnayÄ± hemen oluÅŸturmaz, saldÄ±rganÄ±n saldÄ±rÄ±sÄ±nÄ± tamamlamasÄ± iÃ§in bir sÃ¼re verir.

### KarÄ±ÅŸÄ±k

???

## Uygulama ve Tespit Ã–rnekleri

DonanÄ±m Etiket TabanlÄ± KASAN olarak adlandÄ±rÄ±lan, MTE tabanlÄ± KASAN veya Ã§ekirdek MTE.\
Ã‡ekirdek tahsis edicileri (`kmalloc` gibi) bu modÃ¼lÃ¼ **Ã§aÄŸÄ±racak** ve kullanÄ±lacak etiketi (rastgele) hazÄ±rlayacak ve ayrÄ±lan Ã§ekirdek alanÄ±na ekleyecek ve dÃ¶ndÃ¼rÃ¼len iÅŸaretÃ§iye ekleyecektir.

Talep edilen boyut iÃ§in yeterli bellek granÃ¼lÃ¼ **yalnÄ±zca iÅŸaretleyecektir** (her biri 16B). Bu nedenle, talep edilen boyut 35 ise ve 60B'lik bir plak verildiyse, ilk 16\*3 = 48B'yi bu etiketle iÅŸaretleyecek ve **geri kalanÄ±** sÃ¶zde **geÃ§ersiz bir etiketle (0xE)** iÅŸaretleyecektir.

Etiket **0xF**, **tÃ¼m iÅŸaretÃ§iyi eÅŸleÅŸtirir**. Bu iÅŸaretÃ§iye sahip bir bellek, belleÄŸine eriÅŸmek iÃ§in **herhangi bir etiketin kullanÄ±lmasÄ±na izin verir** (eÅŸleÅŸmeler yok). Bu, saldÄ±rÄ±yÄ± algÄ±lamasÄ±nÄ± Ã¶nleyebilir. EÄŸer bu etiket saldÄ±rÄ±lan bellekte kullanÄ±lÄ±yorsa, MET'in saldÄ±rÄ±yÄ± algÄ±lamasÄ±nÄ± Ã¶nleyebilir.

Bu nedenle, yalnÄ±zca **0xE ve 0xF** ayrÄ±lmÄ±ÅŸ olduÄŸundan, etiket oluÅŸturmak iÃ§in kullanÄ±labilecek **14 deÄŸer** vardÄ±r ve etiketlerin **yeniden kullanÄ±lma olasÄ±lÄ±ÄŸÄ±** 1/17 -> yaklaÅŸÄ±k **%7**'dir.

Ã‡ekirdek **geÃ§ersiz etiket granÃ¼lÃ¼ne** eriÅŸirse, **uyumsuzluk** algÄ±lanÄ±r. BaÅŸka bir bellek konumuna eriÅŸirse, belleÄŸin **farklÄ± bir etikete** (veya geÃ§ersiz etikete) sahip olmasÄ± durumunda uyumsuzluk algÄ±lanÄ±r. SaldÄ±rgan ÅŸanslÄ±ysa ve bellek aynÄ± etiketi kullanÄ±yorsa, algÄ±lanmaz. OlasÄ±lÄ±klar yaklaÅŸÄ±k %7'dir.

BaÅŸka bir hata, ayrÄ±lan belleÄŸin **son granÃ¼lÃ¼nde** meydana gelir. Uygulama 35B istediÄŸinde, 32 ile 48 arasÄ±ndaki granÃ¼l verilir. Bu nedenle, 36 ile 47 arasÄ±ndaki baytlar aynÄ± etiketi kullanÄ±yor olabilir ancak istenmemiÅŸtir. SaldÄ±rgan bu ekstra baytlara eriÅŸirse, bu algÄ±lanmaz.

**`kfree()`** Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda, bellek geÃ§ersiz bellek etiketiyle tekrar etiketlenir, bu nedenle bir **kullanÄ±mdan sonra tekrar kullanÄ±m** durumunda belleÄŸe eriÅŸildiÄŸinde, **uyumsuzluk algÄ±lanÄ±r**.

Ancak, bir kullanÄ±mdan sonra tekrar kullanÄ±m durumunda, aynÄ± **parÃ§a Ã–NCEKÄ°SÄ°YLE AYNI etiketle** yeniden tahsis edilirse, bir saldÄ±rgan bu eriÅŸimi kullanabilir ve bu algÄ±lanmaz (yaklaÅŸÄ±k %7 olasÄ±lÄ±k).

AyrÄ±ca, yalnÄ±zca **`slab` ve `page_alloc`** etiketli belleÄŸi kullanÄ±r, ancak gelecekte bu, `vmalloc`, `stack` ve `globals`da da kullanÄ±lacaktÄ±r (videonun Ã§ekildiÄŸi sÄ±rada bunlar hala kÃ¶tÃ¼ye kullanÄ±labilir).

Bir **uyumsuzluk algÄ±landÄ±ÄŸÄ±nda**, Ã§ekirdek **Ã§Ã¶kme yapacak** ve daha fazla kÃ¶tÃ¼ye kullanÄ±m ve saldÄ±rÄ± denemesini Ã¶nlemek iÃ§in (MTE yanlÄ±ÅŸ pozitiflere sahip deÄŸildir).

## Referanslar

* [https://www.youtube.com/watch?v=UwMt0e\_dC\_Q](https://www.youtube.com/watch?v=UwMt0e\_dC\_Q)

<details>

<summary><strong>SÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek veya HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi Twitter'da takip edin ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak HackTricks ve HackTricks Cloud github depolarÄ±na PR gÃ¶ndererek destekleyin.**

</details>
