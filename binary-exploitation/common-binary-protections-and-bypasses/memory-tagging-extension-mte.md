# Bellek Etiketleme UzantÄ±sÄ± (MTE)

<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan kahramana Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong> ile!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **ğŸ’¬ [Discord grubuna](https://discord.gg/hRep4RUj7f) veya [telegram grubuna](https://t.me/peass) katÄ±lÄ±n veya bizi Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR'ler gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>

## Temel Bilgiler

**Bellek Etiketleme UzantÄ±sÄ± (MTE)**, **Ã¶nbellek taÅŸmalarÄ± ve kullanÄ±mdan sonra serbest bÄ±rakma gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit edip Ã¶nleyerek**, yazÄ±lÄ±m gÃ¼venilirliÄŸini ve gÃ¼venliÄŸini artÄ±rmak amacÄ±yla tasarlanmÄ±ÅŸtÄ±r. MTE, **ARM** mimarisinin bir parÃ§asÄ± olarak, her bellek tahsisine **kÃ¼Ã§Ã¼k bir etiket eklemek** ve o belleÄŸi iÅŸaretleyen her iÅŸaretÃ§iye **ilgili etiketi eklemek** iÃ§in bir mekanizma saÄŸlar. Bu yaklaÅŸÄ±m, yasadÄ±ÅŸÄ± bellek eriÅŸimlerini Ã§alÄ±ÅŸma zamanÄ±nda tespit etmeyi saÄŸlar ve bu tÃ¼r gÃ¼venlik aÃ§Ä±klarÄ±nÄ± kÃ¶tÃ¼ amaÃ§lÄ± kod yÃ¼rÃ¼tmek iÃ§in kullanma riskini Ã¶nemli Ã¶lÃ§Ã¼de azaltÄ±r.

### **Bellek Etiketleme UzantÄ±sÄ±nÄ±n Ã‡alÄ±ÅŸma Åekli**

MTE, belleÄŸi **kÃ¼Ã§Ã¼k, sabit boyutlu bloklara bÃ¶ler ve her bloÄŸa bir etiket atar**, genellikle birkaÃ§ bit boyutunda.

Bir iÅŸaretÃ§i o belleÄŸi iÅŸaret etmek Ã¼zere oluÅŸturulduÄŸunda, aynÄ± etiketi alÄ±r. Bu etiket, iÅŸaretÃ§inin **kullanÄ±lmayan bitlerinde** saklanÄ±r ve etkili bir ÅŸekilde iÅŸaretÃ§iyi ilgili bellek bloÄŸuna baÄŸlar.

<figure><img src="../../.gitbook/assets/image (1199).png" alt=""><figcaption><p><a href="https://www.youtube.com/watch?v=UwMt0e_dC_Q">https://www.youtube.com/watch?v=UwMt0e_dC_Q</a></p></figcaption></figure>

Bir program bir iÅŸaretÃ§i aracÄ±lÄ±ÄŸÄ±yla belleÄŸe eriÅŸtiÄŸinde, MTE donanÄ±mÄ± **iÅŸaretÃ§inin etiketinin bellek bloÄŸunun etiketiyle eÅŸleÅŸip eÅŸleÅŸmediÄŸini** kontrol eder. Etiketler **eÅŸleÅŸmiyorsa**, yasadÄ±ÅŸÄ± bellek eriÅŸimini gÃ¶sterir.

### MTE Ä°ÅŸaretÃ§i Etiketleri

Ä°ÅŸaretÃ§i iÃ§indeki etiketler, en Ã¼st baytÄ±n iÃ§indeki 4 bitte saklanÄ±r:

<figure><img src="../../.gitbook/assets/image (1200).png" alt=""><figcaption><p><a href="https://www.youtube.com/watch?v=UwMt0e_dC_Q">https://www.youtube.com/watch?v=UwMt0e_dC_Q</a></p></figcaption></figure>

Bu nedenle, bu, **16 farklÄ± etiket deÄŸerine** kadar olanak tanÄ±r.

### MTE Bellek Etiketleri

Her **16B fiziksel belleÄŸin** karÅŸÄ±lÄ±k gelen bir **bellek etiketi** vardÄ±r.

Bellek etiketleri, **Ã¶zel bir RAM bÃ¶lgesinde** saklanÄ±r (normal kullanÄ±m iÃ§in eriÅŸilemez). 16B bellek etiketleri iÃ§in 4 bit etiketlere kadar RAM'Ä±n %3'Ã¼ne kadar.

ARM, bu etiketleri Ã¶zel RAM bellekte iÅŸlemek iÃ§in aÅŸaÄŸÄ±daki talimatlarÄ± tanÄ±tÄ±r:
```
STG [<Xn/SP>], #<simm>    Store Allocation (memory) Tag
LDG <Xt>, [<Xn/SP>]       Load Allocatoin (memory) Tag
IRG <Xd/SP>, <Xn/SP>      Insert Random [pointer] Tag
...
```
## Kontrol ModlarÄ±

### Senkron

CPU, etiketleri **komut yÃ¼rÃ¼tÃ¼lÃ¼rken** kontrol eder, eÅŸleÅŸme olursa istisna oluÅŸturur.\
Bu en yavaÅŸ ve en gÃ¼venlidir.

### Asenkron

CPU etiketleri **asenkron olarak** kontrol eder, eÅŸleÅŸme bulunduÄŸunda bir istisna bitini bir sistem kaydÄ±nda ayarlar. Ã–ncekine gÃ¶re **daha hÄ±zlÄ±**dÄ±r ancak eÅŸleÅŸmeye neden olan tam komutu belirleyemez ve istisnayÄ± hemen oluÅŸturmaz, saldÄ±rganÄ±n saldÄ±rÄ±sÄ±nÄ± tamamlamasÄ± iÃ§in zaman verir.

### KarÄ±ÅŸÄ±k

???

## Uygulama ve Tespit Ã–rnekleri

DonanÄ±m Etiket TabanlÄ± KASAN olarak adlandÄ±rÄ±lan, MTE tabanlÄ± KASAN veya Ã§ekirdek MTE.\
Ã‡ekirdek tahsis edicileri (`kmalloc` gibi) **bu modÃ¼lÃ¼ Ã§aÄŸÄ±racak** ve kullanÄ±lacak etiketi (rastgele) hazÄ±rlayacak ve ayrÄ±lan Ã§ekirdek alanÄ±na ekleyecek ve dÃ¶ndÃ¼rÃ¼len iÅŸaretÃ§iye ekleyecektir.

Talep edilen boyut iÃ§in yeterli bellek granÃ¼lÃ¼nÃ¼ (her biri 16B) **yalnÄ±zca iÅŸaretleyeceÄŸini** unutmayÄ±n. Bu nedenle, talep edilen boyut 35 ise ve 60B'lik bir yonga verildiyse, ilk 16\*3 = 48B'yi bu etiketle iÅŸaretleyecek ve **geri kalanÄ±** sÃ¶zde **geÃ§ersiz etiketle (0xE)** iÅŸaretleyecektir.

Etiket **0xF**, **tÃ¼m iÅŸaretÃ§ileri eÅŸleÅŸtirir**. Bu iÅŸaretÃ§iye sahip bir bellek, belleÄŸine eriÅŸmek iÃ§in **herhangi bir etiketi kullanmaya izin verir** (eÅŸleÅŸmeler yok). Bu, saldÄ±rÄ±yÄ± algÄ±lamasÄ±nÄ± Ã¶nleyebilir.

Bu nedenle, 0xE ve 0xF'nin ayrÄ±lmÄ±ÅŸ olduÄŸu **14 deÄŸer** kullanÄ±labilir, etiketlerin **yeniden kullanÄ±lma olasÄ±lÄ±ÄŸÄ±** 1/17 -> yaklaÅŸÄ±k **%7**.

Ã‡ekirdek **geÃ§ersiz etiket granÃ¼lÃ¼ne** eriÅŸirse, **uyumsuzluk algÄ±lanÄ±r**. BaÅŸka bir bellek konumuna eriÅŸirse, belleÄŸin **farklÄ± bir etikete** (veya geÃ§ersiz etikete) sahip olmasÄ± durumunda uyumsuzluk algÄ±lanÄ±r. SaldÄ±rgan ÅŸanslÄ±ysa ve bellek aynÄ± etiketi kullanÄ±yorsa, algÄ±lanmaz. Åanslar yaklaÅŸÄ±k %7'dir.

BaÅŸka bir hata, ayrÄ±lan belleÄŸin **son granÃ¼lÃ¼nde** meydana gelir. Uygulama 35B istediÄŸinde, 32 ile 48 arasÄ±ndan granÃ¼l verildi. Bu nedenle, 36 ile 47 arasÄ±ndaki baytlar aynÄ± etiketi kullanÄ±yor ancak istenmedi. SaldÄ±rgan bu ekstra baytlara eriÅŸirse, bu algÄ±lanmaz.

**`kfree()`** Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda, bellek geÃ§ersiz bellek etiketiyle tekrar etiketlenir, bu nedenle bir **kullanÄ±mdan sonra serbest bÄ±rakma** durumunda, belleÄŸe tekrar eriÅŸildiÄŸinde **uyumsuzluk algÄ±lanÄ±r**.

Ancak, bir kullanÄ±mdan sonra serbest bÄ±rakma durumunda, aynÄ± **yonga Ã¶ncekiyle AYNI etiketle** tekrar tahsis edilirse, saldÄ±rgan bu eriÅŸimi kullanabilir ve bu algÄ±lanmaz (%7'lik bir ÅŸans).

AyrÄ±ca, yalnÄ±zca **`slab` ve `page_alloc`** etiketli bellek kullanÄ±r, ancak gelecekte bu, `vmalloc`, `stack` ve `globals`da da kullanÄ±lacaktÄ±r (videonun Ã§ekildiÄŸi sÄ±rada bunlar hala kÃ¶tÃ¼ye kullanÄ±labilir).

Bir **uyumsuzluk algÄ±landÄ±ÄŸÄ±nda**, Ã§ekirdek **panik yapar** ve daha fazla kÃ¶tÃ¼ye kullanÄ±m ve saldÄ±rÄ± denemesini Ã¶nlemek iÃ§in (MTE yanlÄ±ÅŸ pozitiflere sahip deÄŸildir).

## Referanslar

* [https://www.youtube.com/watch?v=UwMt0e\_dC\_Q](https://www.youtube.com/watch?v=UwMt0e\_dC\_Q)
