# Pro코irenje oznake memorije (MTE)

{% hint style="success" %}
Nau캜ite i ve쬭ajte hakovanje AWS-a:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Nau캜ite i ve쬭ajte hakovanje GCP-a: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr쬴te HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## Osnovne informacije

**Pro코irenje oznake memorije (MTE)** dizajnirano je da pobolj코a pouzdanost i sigurnost softvera **detektovanjem i spre캜avanjem gre코aka povezanih sa memorijom**, poput prelivanja bafera i ranjivosti nakon osloba캠anja. MTE, kao deo arhitekture **ARM**, pru쬬 mehanizam za pri캜vr코캖ivanje **male oznake na svaku alokaciju memorije** i **odgovaraju캖u oznaku na svaki pokaziva캜** koji se odnosi na tu memoriju. Ovaj pristup omogu캖ava detekciju nelegalnih pristupa memoriji u toku izvr코avanja, zna캜ajno smanjuju캖i rizik od iskori코캖avanja takvih ranjivosti za izvr코avanje proizvoljnog koda.

### **Kako radi pro코irenje oznake memorije**

MTE funkcioni코e tako 코to **deli memoriju na male blokove fiksne veli캜ine, pri 캜emu se svakom bloku dodeljuje oznaka**, obi캜no nekoliko bitova u veli캜ini.&#x20;

Kada se kreira pokaziva캜 koji pokazuje na tu memoriju, dobija istu oznaku. Ova oznaka se 캜uva u **neiskori코캖enim bitovima pokaziva캜a memorije**, efikasno povezuju캖i pokaziva캜 sa odgovaraju캖im blokom memorije.

<figure><img src="../../.gitbook/assets/image (1202).png" alt=""><figcaption><p><a href="https://www.youtube.com/watch?v=UwMt0e_dC_Q">https://www.youtube.com/watch?v=UwMt0e_dC_Q</a></p></figcaption></figure>

Kada program pristupa memoriji putem pokaziva캜a, MTE hardver proverava da li **oznaka pokaziva캜a odgovara oznaci bloka memorije**. Ako se oznake **ne podudaraju**, to ukazuje na **nelegalan pristup memoriji**.

### Oznake pokaziva캜a MTE

Oznake unutar pokaziva캜a 캜uvaju se u 4 bita unutar gornjeg bajta:

<figure><img src="../../.gitbook/assets/image (1203).png" alt=""><figcaption><p><a href="https://www.youtube.com/watch?v=UwMt0e_dC_Q">https://www.youtube.com/watch?v=UwMt0e_dC_Q</a></p></figcaption></figure>

Stoga, ovo omogu캖ava do **16 razli캜itih vrednosti oznaka**.

### Oznake memorije MTE

Svaka **16B fizi캜ke memorije** ima odgovaraju캖u **oznaku memorije**.

Oznake memorije 캜uvaju se u **dedikovanom RAM regionu** (nije dostupan za normalnu upotrebu). Imaju캖i 4-bitne oznake za svakih 16B oznaka memorije do 3% RAM-a.

ARM uvodi slede캖e instrukcije za manipulisanje ovim oznakama u dedikovanom RAM-u:
```
STG [<Xn/SP>], #<simm>    Store Allocation (memory) Tag
LDG <Xt>, [<Xn/SP>]       Load Allocatoin (memory) Tag
IRG <Xd/SP>, <Xn/SP>      Insert Random [pointer] Tag
...
```
## Provera re쬴ma

### Sinkrono

CPU proverava oznake **tokom izvr코avanja instrukcija**, ako postoji neslaganje, podi쬰 izuzetak.\
Ovo je najsporije i najsigurnije.

### Asinkrono

CPU proverava oznake **asinhrono**, i kada se prona캠e neslaganje, postavlja bit izuzetka u jedan od registara sistema. Br쬰 je od prethodnog, ali **nije u mogu캖nosti da poka쬰** ta캜nu instrukciju koja je uzrokovala neslaganje i ne podi쬰 izuzetak odmah, pru쬬ju캖i vremena napada캜u da zavr코i svoj napad.

### Me코ovito

???

## Primeri implementacije i detekcije

Nazvan Hardverski Tag-Based KASAN, MTE-based KASAN ili in-kernel MTE.\
Kernel alokatori (poput `kmalloc`) 캖e **pozvati ovaj modul** koji 캖e pripremiti oznaku za kori코캖enje (nasumi캜no) i prilo쬴ti je na alocirani kernel prostor i na vra캖eni pokaziva캜.

Imajte na umu da 캖e ozna캜iti **samo dovoljno memorijskih granula** (svaka 16B) za tra쬰nu veli캜inu. Dakle, ako je tra쬰na veli캜ina bila 35 i dodeljen je blok od 60B, ozna캜i캖e prvih 16\*3 = 48B ovom oznakom, a **ostatak** 캖e biti **ozna캜en** tzv. **neva쬰캖om oznakom (0xE)**.

Oznaka **0xF** je **poklapanje svih pokaziva캜a**. Memorija sa ovim pokaziva캜em dozvoljava **bilo koju oznaku za pristup** svojoj memoriji (bez neslaganja). Ovo bi moglo spre캜iti MET da otkrije napad ako se ove oznake koriste u napadnutoj memoriji.

Stoga postoji samo **14 vrednosti** koje se mogu koristiti za generisanje oznaka jer su 0xE i 0xF rezervisani, daju캖i verovatno캖u **ponovne upotrebe oznaka** od 1/17 -> oko **7%**.

Ako kernel pristupi **neva쬰캖oj memorijskoj granuli**, **neslaganje** 캖e biti **detektovano**. Ako pristupi drugoj memorijskoj lokaciji, ako **memorija ima druga캜iju oznaku** (ili neva쬰캖u oznaku), neslaganje 캖e biti **detektovano**. Ako napada캜 ima sre캖e i memorija koristi istu oznaku, ne캖e biti detektovano. Verovatno캖a je oko 7%.

Jo코 jedan problem se javlja u **poslednjoj granuli** alocirane memorije. Ako je aplikacija zatra쬴la 35B, dodeljena je granula od 32 do 48. Stoga, **bajtovi od 36 do 47 koriste istu oznaku** ali nisu bili tra쬰ni. Ako napada캜 pristupi **ovim dodatnim bajtovima, to ne캖e biti detektovano**.

Kada se izvr코i **`kfree()`**, memorija se ponovo ozna캜ava neva쬰캖om oznakom, tako da u slu캜aju **ponovnog kori코캖enja nakon osloba캠anja**, kada se memorija ponovo pristupi, **neslaganje se detektuje**.

Me캠utim, u slu캜aju ponovnog kori코캖enja nakon osloba캠anja, ako je isti **blok ponovo alociran sa ISTOM oznakom** kao prethodno, napada캜 캖e mo캖i da koristi ovaj pristup i to ne캖e biti detektovano (oko 7% 코anse).

Osim toga, samo **`slab` i `page_alloc`** koriste ozna캜enu memoriju, ali u budu캖nosti 캖e se ovo koristiti i u `vmalloc`, `stack` i `globals` (u trenutku videa ovo jo코 uvek mo쬰 biti zloupotrebljeno).

Kada se **detektuje neslaganje**, kernel 캖e **pani캜iti** kako bi spre캜io dalje iskori코캖avanje i poku코aje eksploatacije (MTE nema la쬹ih pozitiva).

## Reference

* [https://www.youtube.com/watch?v=UwMt0e\_dC\_Q](https://www.youtube.com/watch?v=UwMt0e\_dC\_Q)
