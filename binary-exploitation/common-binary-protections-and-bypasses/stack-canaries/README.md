# æ ˆä¿æŠ¤

{% hint style="success" %}
å­¦ä¹ å¹¶ç»ƒä¹  AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å¹¶ç»ƒä¹  GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## **StackGuard å’Œ StackShield**

**StackGuard** åœ¨ **EIP (Extended Instruction Pointer)** å‰æ’å…¥ä¸€ä¸ªç‰¹æ®Šå€¼ï¼Œç§°ä¸º **canary**ï¼Œå…·ä½“ä¸º `0x000aff0d`ï¼ˆè¡¨ç¤ºç©ºå€¼ã€æ¢è¡Œç¬¦ã€EOFã€å›è½¦ï¼‰ï¼Œä»¥é˜²æ­¢ç¼“å†²åŒºæº¢å‡ºã€‚ç„¶è€Œï¼Œåƒ `recv()`ã€`memcpy()`ã€`read()` å’Œ `bcopy()` è¿™æ ·çš„å‡½æ•°ä»ç„¶å®¹æ˜“å—åˆ°æ”»å‡»ï¼Œè€Œä¸”å®ƒä¸ä¿æŠ¤ **EBP (Base Pointer)**ã€‚

**StackShield** æ¯” StackGuard é‡‡å–äº†æ›´å¤æ‚çš„æ–¹æ³•ï¼Œå®ƒç»´æŠ¤ä¸€ä¸ª**å…¨å±€è¿”å›æ ˆ**ï¼Œç”¨äºå­˜å‚¨æ‰€æœ‰è¿”å›åœ°å€ï¼ˆ**EIPs**ï¼‰ã€‚è¿™ç§è®¾ç½®ç¡®ä¿ä»»ä½•æº¢å‡ºéƒ½ä¸ä¼šé€ æˆä¼¤å®³ï¼Œå› ä¸ºå®ƒå…è®¸å¯¹å­˜å‚¨çš„å’Œå®é™…çš„è¿”å›åœ°å€è¿›è¡Œæ¯”è¾ƒï¼Œä»¥æ£€æµ‹æº¢å‡ºäº‹ä»¶ã€‚æ­¤å¤–ï¼ŒStackShield å¯ä»¥å°†è¿”å›åœ°å€ä¸è¾¹ç•Œå€¼è¿›è¡Œæ¯”è¾ƒï¼Œä»¥æ£€æµ‹ **EIP** æ˜¯å¦æŒ‡å‘é¢„æœŸæ•°æ®ç©ºé—´ä¹‹å¤–ã€‚ç„¶è€Œï¼Œè¿™ç§ä¿æŠ¤å¯ä»¥é€šè¿‡ Return-to-libcã€ROP (Return-Oriented Programming) æˆ– ret2ret ç­‰æŠ€æœ¯ç»•è¿‡ï¼Œè¿™è¡¨æ˜ StackShield ä¹Ÿæ— æ³•ä¿æŠ¤æœ¬åœ°å˜é‡ã€‚

## **æ ˆæº¢å‡ºä¿æŠ¤å™¨ (ProPolice) `-fstack-protector`:**

è¿™ç§æœºåˆ¶åœ¨ **EBP** å‰æ”¾ç½®ä¸€ä¸ª **canary**ï¼Œå¹¶é‡æ–°ç»„ç»‡æœ¬åœ°å˜é‡ï¼Œå°†ç¼“å†²åŒºæ”¾ç½®åœ¨æ›´é«˜çš„å†…å­˜åœ°å€ï¼Œä»¥é˜²æ­¢å®ƒä»¬è¦†ç›–å…¶ä»–å˜é‡ã€‚å®ƒè¿˜å®‰å…¨åœ°å¤åˆ¶ä¼ é€’ç»™æ ˆä¸Šçš„å‚æ•°ï¼Œå°†è¿™äº›å‰¯æœ¬ç”¨ä½œå‚æ•°ã€‚ç„¶è€Œï¼Œå®ƒä¸ä¿æŠ¤å°‘äº 8 ä¸ªå…ƒç´ çš„æ•°ç»„æˆ–ç”¨æˆ·ç»“æ„ä¸­çš„ç¼“å†²åŒºã€‚

**canary** æ˜¯ä» `/dev/urandom` æ´¾ç”Ÿçš„éšæœºæ•°ï¼Œæˆ–è€…é»˜è®¤å€¼ä¸º `0xff0a0000`ã€‚å®ƒå­˜å‚¨åœ¨ **TLS (Thread Local Storage)** ä¸­ï¼Œå…è®¸è·¨çº¿ç¨‹å…±äº«å†…å­˜ç©ºé—´å…·æœ‰çº¿ç¨‹ç‰¹å®šçš„å…¨å±€æˆ–é™æ€å˜é‡ã€‚è¿™äº›å˜é‡æœ€åˆä»çˆ¶è¿›ç¨‹å¤åˆ¶ï¼Œå­è¿›ç¨‹å¯ä»¥ä¿®æ”¹å®ƒä»¬çš„æ•°æ®è€Œä¸å½±å“çˆ¶è¿›ç¨‹æˆ–åŒçº§è¿›ç¨‹ã€‚ç„¶è€Œï¼Œå¦‚æœåœ¨ä¸åˆ›å»ºæ–° canary çš„æƒ…å†µä¸‹ä½¿ç”¨ **`fork()`**ï¼Œæ‰€æœ‰è¿›ç¨‹ï¼ˆçˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹ï¼‰å°†å…±äº«ç›¸åŒçš„ canaryï¼Œä½¿å…¶å®¹æ˜“å—åˆ°æ”»å‡»ã€‚åœ¨ **i386** æ¶æ„ä¸Šï¼Œcanary å­˜å‚¨åœ¨ `gs:0x14`ï¼Œåœ¨ **x86\_64** ä¸Šå­˜å‚¨åœ¨ `fs:0x28`ã€‚

è¿™ç§æœ¬åœ°ä¿æŠ¤è¯†åˆ«å®¹æ˜“å—æ”»å‡»çš„å¸¦æœ‰ç¼“å†²åŒºçš„å‡½æ•°ï¼Œå¹¶åœ¨è¿™äº›å‡½æ•°çš„å¼€å¤´æ³¨å…¥ä»£ç ä»¥æ”¾ç½® canaryï¼Œåœ¨ç»“å°¾éªŒè¯å…¶å®Œæ•´æ€§ã€‚

å½“ Web æœåŠ¡å™¨ä½¿ç”¨ `fork()` æ—¶ï¼Œå¯ä»¥é€šè¿‡é€å­—èŠ‚çŒœæµ‹ canary è¿›è¡Œæš´åŠ›æ”»å‡»ã€‚ç„¶è€Œï¼Œåœ¨ `fork()` åä½¿ç”¨ `execve()` è¦†ç›–å†…å­˜ç©ºé—´ï¼Œä»è€Œæ¶ˆé™¤æ”»å‡»ã€‚`vfork()` å…è®¸å­è¿›ç¨‹æ‰§è¡Œè€Œä¸å¤åˆ¶ï¼Œç›´åˆ°å°è¯•å†™å…¥æ—¶åˆ›å»ºå‰¯æœ¬ï¼Œæä¾›äº†ä¸€ç§ä¸åŒçš„è¿›ç¨‹åˆ›å»ºå’Œå†…å­˜å¤„ç†æ–¹æ³•ã€‚

### é•¿åº¦

åœ¨ `x64` äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œcanary cookie æ˜¯ä¸€ä¸ª **`0x8`** å­—èŠ‚çš„ qwordã€‚**å‰ä¸ƒä¸ªå­—èŠ‚æ˜¯éšæœºçš„**ï¼Œæœ€åä¸€ä¸ªå­—èŠ‚æ˜¯ä¸€ä¸ª **ç©ºå­—èŠ‚**ã€‚

åœ¨ `x86` äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œcanary cookie æ˜¯ä¸€ä¸ª **`0x4`** å­—èŠ‚çš„ dwordã€‚**å‰ä¸‰ä¸ªå­—èŠ‚æ˜¯éšæœºçš„**ï¼Œæœ€åä¸€ä¸ªå­—èŠ‚æ˜¯ä¸€ä¸ª **ç©ºå­—èŠ‚**ã€‚

{% hint style="danger" %}
ä¸¤ä¸ª canary çš„æœ€ä½æœ‰æ•ˆå­—èŠ‚æ˜¯ç©ºå­—èŠ‚ï¼Œå› ä¸ºå®ƒå°†æ˜¯æ¥è‡ªè¾ƒä½åœ°å€çš„æ ˆä¸­çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼Œå› æ­¤**è¯»å–å­—ç¬¦ä¸²çš„å‡½æ•°å°†åœ¨è¯»å–å®ƒä¹‹å‰åœæ­¢**ã€‚
{% endhint %}

## ç»•è¿‡

**æ³„éœ² canary**ï¼Œç„¶åç”¨å…¶è‡ªèº«å€¼è¦†ç›–å®ƒï¼ˆä¾‹å¦‚ç¼“å†²åŒºæº¢å‡ºï¼‰ã€‚

* å¦‚æœ **canary åœ¨å­è¿›ç¨‹ä¸­è¢« fork**ï¼Œå¯èƒ½å¯ä»¥é€å­—èŠ‚è¿›è¡Œ **æš´åŠ›ç ´è§£**ï¼š

{% content-ref url="bf-forked-stack-canaries.md" %}
[bf-forked-stack-canaries.md](bf-forked-stack-canaries.md)
{% endcontent-ref %}

* å¦‚æœäºŒè¿›åˆ¶æ–‡ä»¶ä¸­å­˜åœ¨ä¸€äº›æœ‰è¶£çš„ **æ³„æ¼æˆ–ä»»æ„è¯»å–æ¼æ´**ï¼Œå¯èƒ½å¯ä»¥æ³„æ¼å®ƒï¼š

{% content-ref url="print-stack-canary.md" %}
[print-stack-canary.md](print-stack-canary.md)
{% endcontent-ref %}

* **è¦†ç›–æ ˆä¸­å­˜å‚¨çš„æŒ‡é’ˆ**

æ ˆæ˜“å—æ ˆæº¢å‡ºæ”»å‡»çš„æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼š **åŒ…å«å¯è¢«è¦†ç›–çš„å­—ç¬¦ä¸²æˆ–å‡½æ•°åœ°å€**ï¼Œä»¥ä¾¿åˆ©ç”¨æ¼æ´è€Œæ— éœ€åˆ°è¾¾æ ˆ canaryã€‚æŸ¥çœ‹ï¼š

{% content-ref url="../../stack-overflow/pointer-redirecting.md" %}
[pointer-redirecting.md](../../stack-overflow/pointer-redirecting.md)
{% endcontent-ref %}

* **ä¿®æ”¹ä¸» canary å’Œçº¿ç¨‹ canary**

å— canary ä¿æŠ¤çš„çº¿ç¨‹å‡½æ•°ä¸­çš„ç¼“å†²åŒº **æº¢å‡º** å¯ç”¨äº **ä¿®æ”¹çº¿ç¨‹çš„ä¸» canary**ã€‚ç»“æœï¼Œè¯¥é˜²æŠ¤æªæ–½æ— æ•ˆï¼Œå› ä¸ºæ£€æŸ¥ä½¿ç”¨äº†ä¸¤ä¸ªç›¸åŒçš„ canaryï¼ˆå°½ç®¡å·²ä¿®æ”¹ï¼‰ã€‚

æ­¤å¤–ï¼Œå— canary ä¿æŠ¤çš„çº¿ç¨‹å‡½æ•°ä¸­çš„ç¼“å†²åŒº **æº¢å‡º** å¯ç”¨äº **ä¿®æ”¹å­˜å‚¨åœ¨ TLS ä¸­çš„ä¸» canary**ã€‚è¿™æ˜¯å› ä¸ºå¯èƒ½å¯ä»¥é€šè¿‡çº¿ç¨‹çš„æ ˆä¸­çš„ **ç¼“å†²åŒºæº¢å‡º** è¾¾åˆ°å­˜å‚¨ TLS çš„å†…å­˜ä½ç½®ã€‚\
ç»“æœï¼Œè¯¥é˜²æŠ¤æªæ–½æ— æ•ˆï¼Œå› ä¸ºæ£€æŸ¥ä½¿ç”¨äº†ä¸¤ä¸ªç›¸åŒçš„ canaryï¼ˆå°½ç®¡å·²ä¿®æ”¹ï¼‰ã€‚\
æ­¤æ”»å‡»åœ¨ä»¥ä¸‹ writeup ä¸­æ‰§è¡Œï¼š[http://7rocky.github.io/en/ctf/htb-challenges/pwn/robot-factory/#canaries-and-threads](http://7rocky.github.io/en/ctf/htb-challenges/pwn/robot-factory/#canaries-and-threads)

è¿˜è¯·æŸ¥çœ‹ [https://www.slideshare.net/codeblue\_jp/master-canary-forging-by-yuki-koike-code-blue-2015](https://www.slideshare.net/codeblue\_jp/master-canary-forging-by-yuki-koike-code-blue-2015) çš„æ¼”ç¤ºï¼Œå…¶ä¸­æåˆ°é€šå¸¸ **TLS** ç”± **`mmap`** å­˜å‚¨ï¼Œå½“åˆ›å»º **çº¿ç¨‹** çš„ **æ ˆ** æ—¶ä¹Ÿæ˜¯ç”± `mmap` ç”Ÿæˆçš„ï¼Œæ ¹æ®è¿™ä¸€ç‚¹ï¼Œå¯èƒ½å…è®¸å¦‚å‰è¿° writeup ä¸­æ‰€ç¤ºçš„æº¢å‡ºã€‚

* **ä¿®æ”¹ `__stack_chk_fail` çš„ GOT æ¡ç›®**

å¦‚æœäºŒè¿›åˆ¶æ–‡ä»¶å…·æœ‰ Partial RELROï¼Œåˆ™å¯ä»¥ä½¿ç”¨ä»»æ„å†™å…¥æ¥ä¿®æ”¹ **`__stack_chk_fail` çš„ GOT æ¡ç›®**ï¼Œä½¿å…¶æˆä¸ºä¸€ä¸ªä¸ä¼šé˜»æ­¢ç¨‹åºçš„è™šæ‹Ÿå‡½æ•°ï¼Œå³ä½¿ canary è¢«ä¿®æ”¹ã€‚

æ­¤æ”»å‡»åœ¨ä»¥ä¸‹ writeup ä¸­æ‰§è¡Œï¼š[https://7rocky.github.io/en/ctf/other/securinets-ctf/scrambler/](https://7rocky.github.io/en/ctf/other/securinets-ctf/scrambler/)
## å‚è€ƒèµ„æ–™

* [https://guyinatuxedo.github.io/7.1-mitigation\_canary/index.html](https://guyinatuxedo.github.io/7.1-mitigation\_canary/index.html)
* [http://7rocky.github.io/en/ctf/htb-challenges/pwn/robot-factory/#canaries-and-threads](http://7rocky.github.io/en/ctf/htb-challenges/pwn/robot-factory/#canaries-and-threads)
* [https://7rocky.github.io/en/ctf/other/securinets-ctf/scrambler/](https://7rocky.github.io/en/ctf/other/securinets-ctf/scrambler/)

{% hint style="success" %}
å­¦ä¹ å¹¶ç»ƒä¹  AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å¹¶ç»ƒä¹  GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
