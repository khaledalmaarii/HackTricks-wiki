# Stack Canaries

{% hint style="success" %}
AWS Hacking Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin**.
* **HackTricks** ve **HackTricks Cloud** github depolarÄ±na PR gÃ¶ndererek hacking pÃ¼f noktalarÄ±nÄ± paylaÅŸÄ±n.

</details>
{% endhint %}

## **StackGuard ve StackShield**

**StackGuard**, aÅŸÄ±rÄ± taÅŸmalarÄ± Ã¶nlemek iÃ§in **EIP (GeniÅŸletilmiÅŸ Komut Ä°ÅŸaretÃ§isi)**'den Ã¶nce Ã¶zel bir deÄŸer olan **canary**'yi ekler, Ã¶zellikle `0x000aff0d` (null, newline, EOF, carriage return'Ã¼ temsil eder). Ancak, `recv()`, `memcpy()`, `read()`, ve `bcopy()` gibi fonksiyonlar hala savunmasÄ±zdÄ±r ve **EBP (Taban Ä°ÅŸaretÃ§isi)**'ni korumaz.

**StackShield**, StackGuard'dan daha sofistike bir yaklaÅŸÄ±m benimseyerek **Global Return Stack**'i korur, tÃ¼m dÃ¶nÃ¼ÅŸ adreslerini (**EIP'ler**) depolar. Bu yapÄ±, taÅŸmanÄ±n zarar vermemesini saÄŸlar, Ã§Ã¼nkÃ¼ depolanan ve gerÃ§ek dÃ¶nÃ¼ÅŸ adresleri arasÄ±nda karÅŸÄ±laÅŸtÄ±rma yaparak taÅŸma olaylarÄ±nÄ± tespit etmeyi saÄŸlar. AyrÄ±ca, StackShield, **EIP**'nin beklenen veri alanÄ±nÄ±n dÄ±ÅŸÄ±na iÅŸaret ettiÄŸini tespit etmek iÃ§in dÃ¶nÃ¼ÅŸ adresini bir sÄ±nÄ±r deÄŸeriyle karÅŸÄ±laÅŸtÄ±rabilir. Bununla birlikte, Return-to-libc, ROP (Return-Oriented Programming) veya ret2ret gibi tekniklerle bu koruma atlatÄ±labilir, bu da StackShield'Ä±n yerel deÄŸiÅŸkenleri korumadÄ±ÄŸÄ±nÄ± gÃ¶sterir.

## **Stack Smash Koruyucu (ProPolice) `-fstack-protector`:**

Bu mekanizma, **EBP**'den Ã¶nce bir **canary** yerleÅŸtirir ve yerel deÄŸiÅŸkenleri yeniden dÃ¼zenleyerek tamponlarÄ± daha yÃ¼ksek bellek adreslerine yerleÅŸtirir, bÃ¶ylece diÄŸer deÄŸiÅŸkenleri Ã¼zerine yazmalarÄ±nÄ± Ã¶nler. AyrÄ±ca, yÄ±ÄŸÄ±na geÃ§irilen argÃ¼manlarÄ± gÃ¼venli bir ÅŸekilde kopyalar ve bu kopyalarÄ± argÃ¼man olarak kullanÄ±r. Bununla birlikte, 8'den az Ã¶ÄŸeye sahip dizileri veya kullanÄ±cÄ±nÄ±n yapÄ±sÄ±ndaki tamponlarÄ± korumaz.

**Canary**, `/dev/urandom`'dan tÃ¼retilen rastgele bir sayÄ± veya varsayÄ±lan bir deÄŸer olan `0xff0a0000`'den gelir. **TLS (Ä°ÅŸ ParÃ§acÄ±ÄŸÄ± Yerel Depolama)**'da saklanÄ±r ve iÅŸ parÃ§acÄ±klarÄ± arasÄ±nda paylaÅŸÄ±lan bellek alanlarÄ±na iÅŸ parÃ§acÄ±ÄŸÄ± Ã¶zgÃ¼ kÃ¼resel veya statik deÄŸiÅŸkenlerin olmasÄ±nÄ± saÄŸlar. Bu deÄŸiÅŸkenler baÅŸlangÄ±Ã§ta ebeveyn sÃ¼reÃ§ten kopyalanÄ±r ve Ã§ocuk sÃ¼reÃ§ler verilerini deÄŸiÅŸtirebilir ancak ebeveyni veya kardeÅŸleri etkilemez. Bununla birlikte, **`fork()` kullanÄ±larak yeni bir canary oluÅŸturulmadan kullanÄ±ldÄ±ÄŸÄ±nda, tÃ¼m sÃ¼reÃ§ler (ebeveyn ve Ã§ocuklar) aynÄ± canary'yi paylaÅŸÄ±r**, bu da onu savunmasÄ±z hale getirir. **i386** mimarisinde, canary `gs:0x14`'te saklanÄ±r ve **x86\_64**'te `fs:0x28`'de saklanÄ±r.

Bu yerel koruma, saldÄ±rÄ±lara aÃ§Ä±k tamponlara sahip iÅŸlevleri tanÄ±mlar ve bu iÅŸlevlerin baÅŸlangÄ±cÄ±na canary yerleÅŸtirmek ve bÃ¼tÃ¼nlÃ¼ÄŸÃ¼nÃ¼ doÄŸrulamak iÃ§in bu iÅŸlevlerin sonuna kod enjekte eder.

Bir web sunucusu `fork()` kullandÄ±ÄŸÄ±nda, canary'yi byte byte tahmin etmek iÃ§in bir brute-force saldÄ±rÄ±sÄ±nÄ± etkinleÅŸtirir. Ancak, `fork()`'ten sonra `execve()` kullanarak hafÄ±za alanÄ±nÄ± Ã¼zerine yazarak saldÄ±rÄ±yÄ± etkisiz hale getirebilirsiniz. `vfork()`, Ã§ocuk sÃ¼recin yazmaya Ã§alÄ±ÅŸana kadar Ã§oÄŸaltÄ±lmadan Ã§alÄ±ÅŸmasÄ±na izin verir, bu noktada bir kopya oluÅŸturulur, iÅŸlem oluÅŸturma ve bellek iÅŸleme iÃ§in farklÄ± bir yaklaÅŸÄ±m sunar.

### Uzunluklar

`x64` ikili dosyalarÄ±nda, canary Ã§erezi bir **`0x8`** bayt qword'dÃ¼r. **Ä°lk yedi bayt rastgele** ve son bayt bir **null bayttÄ±r**.

`x86` ikili dosyalarÄ±nda, canary Ã§erezi bir **`0x4`** bayt dword'dÃ¼r. **Ä°lk Ã¼Ã§ bayt rastgele** ve son bayt bir **null bayttÄ±r**.

{% hint style="danger" %}
Her iki canary'nin en anlamsÄ±z baytÄ± bir null bayttÄ±r Ã§Ã¼nkÃ¼ daha dÃ¼ÅŸÃ¼k adreslerden gelen yÄ±ÄŸÄ±ndaki ilk bayt olacak ve bu nedenle **dizeleri okuyan iÅŸlevler onu okumadan duracak**.
{% endhint %}

## Atlatmalar

**Canary'yi sÄ±zdÄ±rmak** ve ardÄ±ndan Ã¼zerine yazmak (Ã¶rneÄŸin tampon taÅŸmasÄ±) (Ã¶rneÄŸin tampon taÅŸmasÄ±) kendi deÄŸeriyle.

* **Ã‡ocuk sÃ¼reÃ§lerde canary Ã§atallanÄ±rsa**, bir byte'Ä± bir seferde **brute-force** etmek mÃ¼mkÃ¼n olabilir:

{% content-ref url="bf-forked-stack-canaries.md" %}
[bf-forked-stack-canaries.md](bf-forked-stack-canaries.md)
{% endcontent-ref %}

* Ä°kili dosyada ilginÃ§ bir **sÄ±zÄ±ntÄ± veya keyfi okuma aÃ§Ä±ÄŸÄ±** varsa, sÄ±zdÄ±rmak mÃ¼mkÃ¼n olabilir:

{% content-ref url="print-stack-canary.md" %}
[print-stack-canary.md](print-stack-canary.md)
{% endcontent-ref %}

* **YÄ±ÄŸÄ±na depolanan iÅŸaretÃ§ileri Ã¼zerine yazma**

YÄ±ÄŸÄ±na taÅŸma aÃ§Ä±ÄŸÄ± olan yÄ±ÄŸÄ±n, yÄ±ÄŸÄ±n canary'sine ulaÅŸmadan da kullanÄ±labilecek ÅŸekilde **dizelerin veya iÅŸlevlerin adreslerini iÃ§erebilir**. YÄ±ÄŸÄ±n canary'sine ulaÅŸmadan zafiyeti sÃ¶mÃ¼rmek iÃ§in bu adreslerin Ã¼zerine yazÄ±labilir. Kontrol edin:

{% content-ref url="../../stack-overflow/pointer-redirecting.md" %}
[pointer-redirecting.md](../../stack-overflow/pointer-redirecting.md)
{% endcontent-ref %}

* **Hem ana hem de iÅŸ parÃ§acÄ±ÄŸÄ± canary'sini deÄŸiÅŸtirme**

Canary ile korunan bir iÅŸ parÃ§acÄ±ÄŸÄ± iÅŸlevinde bir tampon **taÅŸmasÄ±, iÅŸ parÃ§acÄ±ÄŸÄ±nÄ±n ana canary'sini deÄŸiÅŸtirmek** iÃ§in kullanÄ±labilir. SonuÃ§ olarak, denetim, aynÄ± olan iki canary ile kullanÄ±lan bir denetim olduÄŸundan iÅŸe yaramaz hale gelir (ancak deÄŸiÅŸtirilmiÅŸ).

AyrÄ±ca, canary ile korunan bir iÅŸ parÃ§acÄ±ÄŸÄ± iÅŸlevinde bir tampon **taÅŸmasÄ±, TLS'de depolanan ana canary'yi deÄŸiÅŸtirmek** iÃ§in kullanÄ±labilir. Bu, bir iÅŸ parÃ§acÄ±ÄŸÄ±nÄ±n yÄ±ÄŸÄ±nÄ±nÄ±n bir bof aracÄ±lÄ±ÄŸÄ±yla ulaÅŸÄ±labilir olabileceÄŸi bellek konumuna ulaÅŸmak mÃ¼mkÃ¼n olduÄŸundan mÃ¼mkÃ¼ndÃ¼r. SonuÃ§ olarak, denetim, aynÄ± olan iki canary ile kullanÄ±lan bir denetim olduÄŸundan iÅŸe yaramaz hale gelir.\
Bu saldÄ±rÄ±, [http://7rocky.github.io/en/ctf/htb-challenges/pwn/robot-factory/#canaries-and-threads](http://7rocky.github.io/en/ctf/htb-challenges/pwn/robot-factory/#canaries-and-threads) yazÄ±sÄ±nda gerÃ§ekleÅŸtirilir.

AyrÄ±ca, genellikle **TLS**'nin **`mmap`** tarafÄ±ndan saklandÄ±ÄŸÄ±nÄ± ve bir **iÅŸ parÃ§acÄ±ÄŸÄ±nÄ±n yÄ±ÄŸÄ±nÄ±** oluÅŸturulduÄŸunda bunun da `mmap` tarafÄ±ndan oluÅŸturulduÄŸunu belirten [https://www.slideshare.net/codeblue\_jp/master-canary-forging-by-yuki-koike-code-blue-2015](https://www.slideshare.net/codeblue\_jp/master-canary-forging-by-yuki-koike-code-blue-2015) sunumunu kontrol edin, bu da Ã¶nceki yazÄ±da gÃ¶sterildiÄŸi gibi taÅŸmaya izin verebilir.

* **`__stack_chk_fail`'in GOT giriÅŸini deÄŸiÅŸtirme**

EÄŸer ikili dosyanÄ±n Partial RELRO'su varsa, o zaman **GOT giriÅŸini `__stack_chk_fail`'in** bir programÄ± engellemeyen sahte bir iÅŸlev olacak ÅŸekilde deÄŸiÅŸtirmek iÃ§in keyfi yazma kullanabilirsiniz.

Bu saldÄ±rÄ±, [https://7rocky.github.io/en/ctf/other/securinets-ctf/scrambler/](https://7rocky.github.io/en/ctf/other/securinets-ctf/scrambler/) yazÄ±sÄ±nda gerÃ§ekleÅŸtirilir.
## Referanslar

* [https://guyinatuxedo.github.io/7.1-mitigation\_canary/index.html](https://guyinatuxedo.github.io/7.1-mitigation\_canary/index.html)
* [http://7rocky.github.io/en/ctf/htb-challenges/pwn/robot-factory/#canaries-and-threads](http://7rocky.github.io/en/ctf/htb-challenges/pwn/robot-factory/#canaries-and-threads)
* [https://7rocky.github.io/en/ctf/other/securinets-ctf/scrambler/](https://7rocky.github.io/en/ctf/other/securinets-ctf/scrambler/)

{% hint style="success" %}
AWS Hacking'ini Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks EÄŸitimi AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'ini Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks EÄŸitimi GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'Ä± takip edin.**
* Hacking pÃ¼f noktalarÄ±nÄ± paylaÅŸarak PR'ler gÃ¶ndererek **HackTricks** ve **HackTricks Cloud** github depolarÄ±na katkÄ±da bulunun.

</details>
{% endhint %}
