# æ ˆä¿æŠ¤

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[NFT](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ–**å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## **StackGuardå’ŒStackShield**

**StackGuard**åœ¨**EIPï¼ˆæ‰©å±•æŒ‡ä»¤æŒ‡é’ˆï¼‰**ä¹‹å‰æ’å…¥ä¸€ä¸ªç‰¹æ®Šå€¼ï¼Œç§°ä¸º**canary**ï¼Œå…·ä½“ä¸º`0x000aff0d`ï¼ˆè¡¨ç¤ºç©ºå€¼ã€æ¢è¡Œç¬¦ã€EOFã€å›è½¦ï¼‰ï¼Œä»¥é˜²æ­¢ç¼“å†²åŒºæº¢å‡ºã€‚ç„¶è€Œï¼Œåƒ`recv()`ã€`memcpy()`ã€`read()`å’Œ`bcopy()`è¿™æ ·çš„å‡½æ•°ä»ç„¶å®¹æ˜“å—åˆ°æ”»å‡»ï¼Œå®ƒä¸ä¿æŠ¤**EBPï¼ˆåŸºæŒ‡é’ˆï¼‰**ã€‚

**StackShield**é‡‡ç”¨æ¯”StackGuardæ›´å¤æ‚çš„æ–¹æ³•ï¼Œç»´æŠ¤ä¸€ä¸ª**å…¨å±€è¿”å›å †æ ˆ**ï¼Œå­˜å‚¨æ‰€æœ‰è¿”å›åœ°å€ï¼ˆ**EIPs**ï¼‰ã€‚è¿™ç§è®¾ç½®ç¡®ä¿ä»»ä½•æº¢å‡ºéƒ½ä¸ä¼šé€ æˆä¼¤å®³ï¼Œå› ä¸ºå®ƒå…è®¸å¯¹å­˜å‚¨çš„å’Œå®é™…çš„è¿”å›åœ°å€è¿›è¡Œæ¯”è¾ƒï¼Œä»¥æ£€æµ‹æº¢å‡ºäº‹ä»¶ã€‚æ­¤å¤–ï¼ŒStackShieldå¯ä»¥å°†è¿”å›åœ°å€ä¸è¾¹ç•Œå€¼è¿›è¡Œæ¯”è¾ƒï¼Œä»¥æ£€æµ‹**EIP**æ˜¯å¦æŒ‡å‘é¢„æœŸæ•°æ®ç©ºé—´ä¹‹å¤–ã€‚ç„¶è€Œï¼Œè¿™ç§ä¿æŠ¤å¯ä»¥é€šè¿‡Return-to-libcã€ROPï¼ˆReturn-Oriented Programmingï¼‰æˆ–ret2retç­‰æŠ€æœ¯ç»•è¿‡ï¼Œè¿™è¡¨æ˜StackShieldä¹Ÿä¸ä¿æŠ¤æœ¬åœ°å˜é‡ã€‚

## **æ ˆç ´åä¿æŠ¤å™¨ï¼ˆProPoliceï¼‰`-fstack-protector`ï¼š**

æ­¤æœºåˆ¶åœ¨**EBP**ä¹‹å‰æ”¾ç½®ä¸€ä¸ª**canary**ï¼Œå¹¶é‡æ–°ç»„ç»‡æœ¬åœ°å˜é‡ï¼Œå°†ç¼“å†²åŒºå®šä½åœ¨æ›´é«˜çš„å†…å­˜åœ°å€ï¼Œé˜²æ­¢å®ƒä»¬è¦†ç›–å…¶ä»–å˜é‡ã€‚å®ƒè¿˜å®‰å…¨åœ°å¤åˆ¶ä¼ é€’åœ¨æœ¬åœ°å˜é‡ä¸Šæ–¹å †æ ˆä¸Šä¼ é€’çš„å‚æ•°ï¼Œå¹¶ä½¿ç”¨è¿™äº›å‰¯æœ¬ä½œä¸ºå‚æ•°ã€‚ç„¶è€Œï¼Œå®ƒä¸ä¿æŠ¤å°‘äº8ä¸ªå…ƒç´ çš„æ•°ç»„æˆ–ç”¨æˆ·ç»“æ„ä¸­çš„ç¼“å†²åŒºã€‚

**canary**æ˜¯ä»`/dev/urandom`æ´¾ç”Ÿçš„éšæœºæ•°ï¼Œæˆ–è€…é»˜è®¤å€¼ä¸º`0xff0a0000`ã€‚å®ƒå­˜å‚¨åœ¨**TLSï¼ˆçº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼‰**ä¸­ï¼Œå…è®¸è·¨çº¿ç¨‹å…±äº«å†…å­˜ç©ºé—´å…·æœ‰çº¿ç¨‹ç‰¹å®šçš„å…¨å±€æˆ–é™æ€å˜é‡ã€‚è¿™äº›å˜é‡æœ€åˆä»çˆ¶è¿›ç¨‹å¤åˆ¶ï¼Œå­è¿›ç¨‹å¯ä»¥ä¿®æ”¹å®ƒä»¬çš„æ•°æ®è€Œä¸å½±å“çˆ¶è¿›ç¨‹æˆ–åŒçº§è¿›ç¨‹ã€‚ç„¶è€Œï¼Œå¦‚æœåœ¨ä¸åˆ›å»ºæ–°canaryçš„æƒ…å†µä¸‹ä½¿ç”¨**`fork()`**ï¼Œæ‰€æœ‰è¿›ç¨‹ï¼ˆçˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹ï¼‰å…±äº«ç›¸åŒçš„canaryï¼Œä½¿å…¶å®¹æ˜“å—åˆ°æ”»å‡»ã€‚åœ¨**i386**æ¶æ„ä¸Šï¼Œcanaryå­˜å‚¨åœ¨`gs:0x14`ï¼Œåœ¨**x86\_64**ä¸Šå­˜å‚¨åœ¨`fs:0x28`ã€‚

æ­¤æœ¬åœ°ä¿æŠ¤è¯†åˆ«å®¹æ˜“å—æ”»å‡»çš„ç¼“å†²åŒºçš„å‡½æ•°ï¼Œå¹¶åœ¨è¿™äº›å‡½æ•°çš„å¼€å¤´æ³¨å…¥ä»£ç ä»¥æ”¾ç½®canaryï¼Œå¹¶åœ¨ç»“å°¾éªŒè¯å…¶å®Œæ•´æ€§ã€‚

å½“WebæœåŠ¡å™¨ä½¿ç”¨`fork()`æ—¶ï¼Œå¯ä»¥é€šè¿‡é€å­—èŠ‚çŒœæµ‹canaryæ¥è¿›è¡Œæš´åŠ›æ”»å‡»ã€‚ç„¶è€Œï¼Œåœ¨`fork()`åä½¿ç”¨`execve()`ä¼šè¦†ç›–å†…å­˜ç©ºé—´ï¼Œä»è€ŒæŠµæ¶ˆæ”»å‡»ã€‚`vfork()`å…è®¸å­è¿›ç¨‹æ‰§è¡Œè€Œä¸å¤åˆ¶ï¼Œç›´åˆ°å°è¯•å†™å…¥æ—¶åˆ›å»ºå‰¯æœ¬ï¼Œæä¾›äº†ä¸€ç§ä¸åŒçš„è¿›ç¨‹åˆ›å»ºå’Œå†…å­˜å¤„ç†æ–¹æ³•ã€‚

### é•¿åº¦

åœ¨`x64`äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œcanary cookieæ˜¯ä¸€ä¸ª**`0x8`**å­—èŠ‚qwordã€‚**å‰ä¸ƒä¸ªå­—èŠ‚æ˜¯éšæœºçš„**ï¼Œæœ€åä¸€ä¸ªå­—èŠ‚æ˜¯**ç©ºå­—èŠ‚**ã€‚

åœ¨`x86`äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œcanary cookieæ˜¯ä¸€ä¸ª**`0x4`**å­—èŠ‚dwordã€‚**å‰ä¸‰ä¸ªå­—èŠ‚æ˜¯éšæœºçš„**ï¼Œæœ€åä¸€ä¸ªå­—èŠ‚æ˜¯**ç©ºå­—èŠ‚**ã€‚

{% hint style="danger" %}
ä¸¤ä¸ªcanaryçš„æœ€ä½æœ‰æ•ˆå­—èŠ‚æ˜¯ç©ºå­—èŠ‚ï¼Œå› ä¸ºå®ƒå°†æ˜¯æ¥è‡ªè¾ƒä½åœ°å€çš„æ ˆä¸­çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼Œå› æ­¤**è¯»å–å­—ç¬¦ä¸²çš„å‡½æ•°å°†åœ¨è¯»å–å®ƒä¹‹å‰åœæ­¢**ã€‚
{% endhint %}

## ç»•è¿‡

**æ³„éœ²canary**ï¼Œç„¶åç”¨å…¶è‡ªèº«çš„å€¼è¦†ç›–å®ƒï¼ˆä¾‹å¦‚ç¼“å†²åŒºæº¢å‡ºï¼‰ã€‚

* å¦‚æœ**canaryåœ¨å­è¿›ç¨‹ä¸­è¢«fork**ï¼Œå¯èƒ½å¯ä»¥**é€å­—èŠ‚æš´åŠ›ç ´è§£**ï¼š

{% content-ref url="bf-forked-stack-canaries.md" %}
[bf-forked-stack-canaries.md](bf-forked-stack-canaries.md)
{% endcontent-ref %}

* å¦‚æœäºŒè¿›åˆ¶æ–‡ä»¶ä¸­å­˜åœ¨ä¸€äº›æœ‰è¶£çš„**æ³„æ¼æˆ–ä»»æ„è¯»å–æ¼æ´**ï¼Œå¯èƒ½å¯ä»¥æ³„æ¼å®ƒï¼š

{% content-ref url="print-stack-canary.md" %}
[print-stack-canary.md](print-stack-canary.md)
{% endcontent-ref %}

* **è¦†ç›–å­˜å‚¨åœ¨æ ˆä¸­çš„æŒ‡é’ˆ**

æ˜“å—æ ˆæº¢å‡ºæ”»å‡»çš„æ ˆå¯èƒ½**åŒ…å«å¯ä»¥è¢«è¦†ç›–çš„å­—ç¬¦ä¸²æˆ–å‡½æ•°åœ°å€**ï¼Œä»¥ä¾¿åˆ©ç”¨æ¼æ´è€Œæ— éœ€è¾¾åˆ°æ ˆcanaryã€‚æŸ¥çœ‹ï¼š

{% content-ref url="../../stack-overflow/pointer-redirecting.md" %}
[pointer-redirecting.md](../../stack-overflow/pointer-redirecting.md)
{% endcontent-ref %}

* **ä¿®æ”¹ä¸»canaryå’Œçº¿ç¨‹canary**

å—canaryä¿æŠ¤çš„çº¿ç¨‹å‡½æ•°ä¸­çš„ç¼“å†²åŒº**æº¢å‡º**å¯ç”¨äº**ä¿®æ”¹çº¿ç¨‹çš„ä¸»canary**ã€‚ç»“æœï¼Œè¯¥ç¼“è§£æªæ–½æ— æ•ˆï¼Œå› ä¸ºæ£€æŸ¥ä½¿ç”¨ä¸¤ä¸ªç›¸åŒçš„canaryï¼ˆå°½ç®¡å·²ä¿®æ”¹ï¼‰ã€‚

æ­¤å¤–ï¼Œå—canaryä¿æŠ¤çš„çº¿ç¨‹å‡½æ•°ä¸­çš„ç¼“å†²åŒº**æº¢å‡º**å¯ç”¨äº**ä¿®æ”¹å­˜å‚¨åœ¨TLSä¸­çš„ä¸»canary**ã€‚è¿™æ˜¯å› ä¸ºå¯èƒ½å¯ä»¥é€šè¿‡çº¿ç¨‹çš„æ ˆä¸­çš„**ç¼“å†²åŒºæº¢å‡º**åˆ°è¾¾å­˜å‚¨TLSçš„å†…å­˜ä½ç½®ï¼ˆå› æ­¤ï¼Œcanaryï¼‰ã€‚\
ç»“æœï¼Œè¯¥ç¼“è§£æªæ–½æ— æ•ˆï¼Œå› ä¸ºæ£€æŸ¥ä½¿ç”¨ä¸¤ä¸ªç›¸åŒçš„canaryï¼ˆå°½ç®¡å·²ä¿®æ”¹ï¼‰ã€‚\
æ­¤æ”»å‡»åœ¨ä»¥ä¸‹æ–‡æ¡£ä¸­æ‰§è¡Œï¼š[http://7rocky.github.io/en/ctf/htb-challenges/pwn/robot-factory/#canaries-and-threads](http://7rocky.github.io/en/ctf/htb-challenges/pwn/robot-factory/#canaries-and-threads)

è¿˜è¯·æŸ¥çœ‹[https://www.slideshare.net/codeblue\_jp/master-canary-forging-by-yuki-koike-code-blue-2015](https://www.slideshare.net/codeblue\_jp/master-canary-forging-by-yuki-koike-code-blue-2015)çš„æ¼”ç¤ºæ–‡ç¨¿ï¼Œå…¶ä¸­æåˆ°é€šå¸¸**TLS**ç”±**`mmap`**å­˜å‚¨ï¼Œå½“åˆ›å»º**çº¿ç¨‹**çš„**æ ˆ**æ—¶ä¹Ÿæ˜¯ç”±`mmap`ç”Ÿæˆçš„ï¼Œæ ¹æ®è¿™ä¸€ç‚¹ï¼Œå¯èƒ½å…è®¸å¦‚å‰è¿°æ–‡æ¡£ä¸­æ‰€ç¤ºçš„æº¢å‡ºã€‚

* **ä¿®æ”¹`__stack_chk_fail`çš„GOTè¡¨é¡¹**

å¦‚æœäºŒè¿›åˆ¶æ–‡ä»¶å…·æœ‰Partial RELROï¼Œåˆ™å¯ä»¥ä½¿ç”¨ä»»æ„å†™å…¥æ¥ä¿®æ”¹**`__stack_chk_fail`çš„GOTè¡¨é¡¹**ï¼Œä½¿å…¶æˆä¸ºä¸€ä¸ªè™šæ‹Ÿå‡½æ•°ï¼Œå¦‚æœcanaryè¢«ä¿®æ”¹ï¼Œåˆ™ä¸ä¼šé˜»æ­¢ç¨‹åºã€‚

æ­¤æ”»å‡»åœ¨ä»¥ä¸‹æ–‡æ¡£ä¸­æ‰§è¡Œï¼š[https://7rocky.github.io/en/ctf/other/securinets-ctf/scrambler/](https://7rocky.github.io/en/ctf/other/securinets-ctf/scrambler/)
## å‚è€ƒèµ„æ–™

* [https://guyinatuxedo.github.io/7.1-mitigation\_canary/index.html](https://guyinatuxedo.github.io/7.1-mitigation\_canary/index.html)
* [http://7rocky.github.io/en/ctf/htb-challenges/pwn/robot-factory/#canaries-and-threads](http://7rocky.github.io/en/ctf/htb-challenges/pwn/robot-factory/#canaries-and-threads)
* [https://7rocky.github.io/en/ctf/other/securinets-ctf/scrambler/](https://7rocky.github.io/en/ctf/other/securinets-ctf/scrambler/)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
