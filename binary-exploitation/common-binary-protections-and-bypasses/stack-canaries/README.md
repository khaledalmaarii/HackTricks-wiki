# Ochrona stosu

<details>

<summary><strong>Nauka hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**

</details>

## **StackGuard i StackShield**

**StackGuard** wstawia specjaln warto znan jako **kanarka** przed **EIP (Extended Instruction Pointer)**, konkretnie `0x000aff0d` (reprezentujc null, znak nowej linii, EOF, powr贸t karetki) w celu ochrony przed przepenieniem bufora. Jednak funkcje takie jak `recv()`, `memcpy()`, `read()` i `bcopy()` pozostaj podatne, a tak偶e nie chroni **EBP (Base Pointer)**.

**StackShield** stosuje bardziej zaawansowane podejcie ni偶 StackGuard, utrzymujc **Globalny Stos Powrotu**, kt贸ry przechowuje wszystkie adresy powrotu (**EIP**). Ten ukad zapewnia, 偶e przepenienie nie spowoduje szk贸d, poniewa偶 umo偶liwia por贸wnanie przechowywanych i rzeczywistych adres贸w powrotu w celu wykrycia wystpienia przepenienia. Dodatkowo, StackShield mo偶e sprawdzi adres powrotu wzgldem wartoci granicznej, aby wykry, czy **EIP** wskazuje poza oczekiwan przestrze danych. Jednak ta ochrona mo偶e by obejcia za pomoc technik takich jak Return-to-libc, ROP (Return-Oriented Programming) lub ret2ret, co oznacza, 偶e StackShield r贸wnie偶 nie chroni zmiennych lokalnych.

## **Protector Stack Smash (ProPolice) `-fstack-protector`:**

Ten mechanizm umieszcza **kanark** przed **EBP** i przestawia zmienne lokalne w taki spos贸b, aby bufory znajdoway si na wy偶szych adresach pamici, uniemo偶liwiajc nadpisywanie innych zmiennych. Bezpiecznie kopiuje r贸wnie偶 argumenty przekazane na stosie powy偶ej zmiennych lokalnych i u偶ywa tych kopii jako argument贸w. Jednak nie chroni tablic o mniej ni偶 8 elementach ani bufor贸w w strukturze u偶ytkownika.

**Kanarka** to losowa liczba pochodzca z `/dev/urandom` lub domylna warto `0xff0a0000`. Jest przechowywana w **TLS (Thread Local Storage)**, co pozwala na wsp贸dzielone przestrzenie pamici midzy wtkami, aby miay wtkowo specyficzne zmienne globalne lub statyczne. Te zmienne s pocztkowo kopiowane z procesu nadrzdnego, a procesy potomne mog zmienia swoje dane bez wpywu na proces nadrzdny lub rodzestwo. Niemniej jednak, jeli u偶ywane jest **`fork()` bez tworzenia nowej kanarki, wszystkie procesy (rodzic i dzieci) dziel t sam kanark**, co czyni j podatn. Na architekturze **i386**, kanarka jest przechowywana pod adresem `gs:0x14`, a na **x86\_64** pod adresem `fs:0x28`.

Ta lokalna ochrona identyfikuje funkcje z buforami podatnymi na ataki i wstrzykuje kod na pocztku tych funkcji, aby umieci kanark, a na kocu weryfikuje jej integralno.

Gdy serwer WWW u偶ywa `fork()`, umo偶liwia atak brutalnej siy, aby zgadywa bajt kanarki po jednym bajcie. Jednak u偶ywajc `execve()` po `fork()` nadpisuje przestrze pamici, uniewa偶niajc atak. `vfork()` pozwala procesowi potomnemu wykonywa si bez duplikacji, a偶 spr贸buje zapisa, wtedy tworzony jest duplikat, oferujc inny spos贸b tworzenia proces贸w i obsugi pamici.

### Dugoci

W binariach `x64`, ciasteczko kanarki to **`0x8`** bajt贸w qword. **Pierwsze siedem bajt贸w jest losowe**, a ostatni bajt to **bajt null**.

W binariach `x86`, ciasteczko kanarki to **`0x4`** bajty dword. **Pierwsze trzy bajty s losowe**, a ostatni bajt to **bajt null**.

{% hint style="danger" %}
Najmniej znaczcy bajt obu kanark贸w to bajt null, poniewa偶 bdzie pierwszy na stosie pochodzcy z ni偶szych adres贸w i dlatego **funkcje czytajce cigi znak贸w zatrzymaj si przed jego odczytaniem**.
{% endhint %}

## Ominicia

**Ujawnienie kanarki** a nastpnie nadpisanie jej (np. przepenienie bufora) wasn wartoci.

* Jeli **kanarka jest klonowana w procesach potomnych**, mo偶e by mo偶liwe **brutalne siowe** jej zgadywanie po jednym bajcie:

{% content-ref url="bf-forked-stack-canaries.md" %}
[bf-forked-stack-canaries.md](bf-forked-stack-canaries.md)
{% endcontent-ref %}

* Jeli w binarnym pliku istnieje jaka interesujca **luka lub podatno na arbitralne odczytywanie**, mo偶e by mo偶liwe jej ujawnienie:

{% content-ref url="print-stack-canary.md" %}
[print-stack-canary.md](print-stack-canary.md)
{% endcontent-ref %}

* **Nadpisywanie wska藕nik贸w przechowywanych na stosie**

Stos podatny na przepenienie stosu mo偶e **zawiera adresy do cig贸w znak贸w lub funkcji, kt贸re mo偶na nadpisa**, aby wykorzysta podatno bez koniecznoci dotarcia do kanarki stosu. Sprawd藕:

{% content-ref url="../../stack-overflow/pointer-redirecting.md" %}
[pointer-redirecting.md](../../stack-overflow/pointer-redirecting.md)
{% endcontent-ref %}

* **Modyfikacja zar贸wno kanarki g贸wnej, jak i wtkowej**

Przepenienie bufora w funkcji wtkowej chronionej kanark mo偶e by wykorzystane do **modyfikacji kanarki g贸wnej wtku**. W rezultacie zastosowanie jest bezu偶yteczne, poniewa偶 sprawdzanie jest wykonywane z dwiema kanarkami, kt贸re s identyczne (cho zmodyfikowane).

Ten atak jest przeprowadzany w opisie: [http://7rocky.github.io/en/ctf/htb-challenges/pwn/robot-factory/#canaries-and-threads](http://7rocky.github.io/en/ctf/htb-challenges/pwn/robot-factory/#canaries-and-threads)

* **Modyfikacja wpisu GOT `__stack_chk_fail`**

Jeli binarny plik ma Partial RELRO, mo偶na u偶y zapisu arbitralnego do zmodyfikowania **wpisu GOT `__stack_chk_fail`** na funkcj-dummy, kt贸ra nie blokuje programu, jeli kanarka zostanie zmodyfikowana.

Ten atak jest przeprowadzany w opisie: [https://7rocky.github.io/en/ctf/other/securinets-ctf/scrambler/](https://7rocky.github.io/en/ctf/other/securinets-ctf/scrambler/)

## Odwoania

* [https://guyinatuxedo.github.io/7.1-mitigation\_canary/index.html](https://guyinatuxedo.github.io/7.1-mitigation\_canary/index.html)
* [http://7rocky.github.io/en/ctf/htb-challenges/pwn/robot-factory/#canaries-and-threads](http://7rocky.github.io/en/ctf/htb-challenges/pwn/robot-factory/#canaries-and-threads)
* [https://7rocky.github.io/en/ctf/other/securinets-ctf/scrambler/](https://7rocky.github.io/en/ctf/other/securinets-ctf/scrambler/) 

<details>

<summary><strong>Nauka hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Udostpnij swoje sztuczki hakerskie, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) **i** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **na githubie.**
