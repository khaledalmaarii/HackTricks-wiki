# Stack Canaries

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sÄ±fÄ±rdan kahramana kadar AWS hacklemeyi Ã¶ÄŸrenin!</summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

- **Åirketinizi HackTricks'te reklamÄ±nÄ±zÄ± gÃ¶rmek** veya **HackTricks'i PDF olarak indirmek** iÃ§in [ABONELÄ°K PLANLARI](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
- [Resmi PEASS & HackTricks Ã¼rÃ¼nlerini](https://peass.creator-spring.com) edinin
- [The PEASS Family](https://opensea.io/collection/the-peass-family)'i keÅŸfedin, Ã¶zel [NFT'lerimiz](https://opensea.io/collection/the-peass-family) koleksiyonumuz
- ğŸ’¬ [Discord grubuna](https://discord.gg/hRep4RUj7f) veya [telegram grubuna](https://t.me/peass) katÄ±lÄ±n veya bizi Twitter'da ğŸ¦ [@hacktricks\_live](https://twitter.com/hacktricks\_live)'Ä± takip edin.
- Hacking pÃ¼f noktalarÄ±nÄ±zÄ± gÃ¶ndererek HackTricks ve HackTricks Cloud github depolarÄ±na PR gÃ¶ndererek paylaÅŸÄ±n.

</details>

## StackGuard ve StackShield

**StackGuard**, tampon taÅŸmalarÄ±na karÅŸÄ± koruma saÄŸlamak iÃ§in **EIP (GeniÅŸletilmiÅŸ Komut Ä°ÅŸaretÃ§isi)**'den Ã¶nce Ã¶zel bir deÄŸer olan **canary** ekler. Ã–zellikle `0x000aff0d` (null, newline, EOF, carriage return'Ã¼ temsil eder). Ancak, `recv()`, `memcpy()`, `read()` ve `bcopy()` gibi iÅŸlevler savunmasÄ±z kalÄ±r ve **EBP (Taban Ä°ÅŸaretÃ§isi)**'ni korumaz.

**StackShield**, tÃ¼m dÃ¶nÃ¼ÅŸ adreslerini (**EIP'ler**) depolayan bir **Global Return Stack**'i koruyarak StackGuard'dan daha sofistike bir yaklaÅŸÄ±m benimser. Bu yapÄ±, taÅŸmalarÄ±n zarar vermemesini saÄŸlar, Ã§Ã¼nkÃ¼ depolanan ve gerÃ§ek dÃ¶nÃ¼ÅŸ adresleri arasÄ±nda karÅŸÄ±laÅŸtÄ±rma yaparak taÅŸma olaylarÄ±nÄ± tespit etmeyi saÄŸlar. AyrÄ±ca, StackShield, **EIP**'nin beklenen veri alanÄ±nÄ±n dÄ±ÅŸÄ±na iÅŸaret ettiÄŸini tespit etmek iÃ§in dÃ¶nÃ¼ÅŸ adresini bir sÄ±nÄ±r deÄŸeriyle karÅŸÄ±laÅŸtÄ±rabilir. Bununla birlikte, Return-to-libc, ROP (Return-Oriented Programming) veya ret2ret gibi tekniklerle bu koruma atlatÄ±labilir, bu da StackShield'Ä±n yerel deÄŸiÅŸkenleri korumadÄ±ÄŸÄ±nÄ± gÃ¶sterir.

## Stack Smash Koruyucu (ProPolice) `-fstack-protector`:

Bu mekanizma, **EBP**'den Ã¶nce bir **canary** yerleÅŸtirir ve tamponlarÄ±n diÄŸer deÄŸiÅŸkenleri Ã¼zerine yazmasÄ±nÄ± Ã¶nlemek iÃ§in yerel deÄŸiÅŸkenleri yeniden dÃ¼zenler, tamponlarÄ± daha yÃ¼ksek bellek adreslerine yerleÅŸtirir. AyrÄ±ca, yÄ±ÄŸÄ±na geÃ§irilen argÃ¼manlarÄ± gÃ¼venli bir ÅŸekilde kopyalar ve bu kopyalarÄ± argÃ¼man olarak kullanÄ±r. Bununla birlikte, 8'den az Ã¶ÄŸeye sahip dizileri veya kullanÄ±cÄ±nÄ±n yapÄ±sÄ±ndaki tamponlarÄ± korumaz.

**Canary**, `/dev/urandom` kaynaklÄ± rastgele bir sayÄ± veya varsayÄ±lan deÄŸeri olan `0xff0a0000`'den tÃ¼retilen rastgele bir sayÄ±dÄ±r. **TLS (Ä°ÅŸ ParÃ§acÄ±ÄŸÄ± Yerel Depolama)**'da saklanÄ±r ve iÅŸ parÃ§acÄ±klarÄ± arasÄ±nda paylaÅŸÄ±lan bellek alanlarÄ±nÄ±n iÅŸ parÃ§acÄ±ÄŸÄ±na Ã¶zgÃ¼ kÃ¼resel veya statik deÄŸiÅŸkenlere sahip olmasÄ±nÄ± saÄŸlar. Bu deÄŸiÅŸkenler baÅŸlangÄ±Ã§ta ebeveyn sÃ¼reÃ§ten kopyalanÄ±r ve Ã§ocuk sÃ¼reÃ§ler verilerini deÄŸiÅŸtirebilir ancak ebeveyni veya kardeÅŸleri etkilemez. Bununla birlikte, yeni bir canary oluÅŸturmadan **`fork()`** kullanÄ±lÄ±rsa, tÃ¼m sÃ¼reÃ§ler (ebeveyn ve Ã§ocuklar) aynÄ± canary'yi paylaÅŸÄ±r, bu da onu savunmasÄ±z hale getirir. **i386** mimarisinde canary `gs:0x14`'te, **x86\_64**'te ise `fs:0x28`'de saklanÄ±r.

Bu yerel koruma, saldÄ±rÄ±lara aÃ§Ä±k tamponlara sahip iÅŸlevleri tanÄ±mlar ve bu iÅŸlevlerin baÅŸÄ±na canary yerleÅŸtirmek ve bÃ¼tÃ¼nlÃ¼ÄŸÃ¼nÃ¼ doÄŸrulamak iÃ§in bu iÅŸlevlerin baÅŸÄ±na kod enjekte eder.

Bir web sunucusu `fork()` kullandÄ±ÄŸÄ±nda, canary'yi byte byte tahmin etmek iÃ§in kaba kuvvet saldÄ±rÄ±sÄ±nÄ± etkinleÅŸtirir. Ancak, `fork()`'ten sonra `execve()` kullanarak hafÄ±za alanÄ±nÄ± Ã¼zerine yazarak saldÄ±rÄ±yÄ± etkisiz hale getirebilirsiniz. `vfork()`, Ã§ocuk sÃ¼recin yazma giriÅŸiminde bulunana kadar Ã§oÄŸaltma yapmadan Ã§alÄ±ÅŸmasÄ±na izin verir, bu noktada bir kopya oluÅŸturulur ve iÅŸlem oluÅŸturma ve bellek iÅŸleme iÃ§in farklÄ± bir yaklaÅŸÄ±m sunar.

### Uzunluklar

`x64` ikili dosyalarÄ±nda, canary Ã§erezi bir **`0x8`** bayt qword'dÃ¼r. **Ä°lk yedi bayt rastgele** ve son bayt bir **null bayttÄ±r**.

`x86` ikili dosyalarÄ±nda, canary Ã§erezi bir **`0x4`** bayt dword'dÃ¼r. **Ä°lk Ã¼Ã§ bayt rastgele** ve son bayt bir **null bayttÄ±r**.

{% hint style="danger" %}
Her iki canary'nin en anlamlÄ± baytÄ± bir null bayttÄ±r Ã§Ã¼nkÃ¼ daha dÃ¼ÅŸÃ¼k adreslerden gelen yÄ±ÄŸÄ±ndaki ilk bayt olacak ve bu nedenle **dizeleri okuyan iÅŸlevler onu okumadan duracak**.
{% endhint %}

## Atlatmalar

**Canary'yi sÄ±zdÄ±rmak** ve ardÄ±ndan (Ã¶rneÄŸin tampon taÅŸmasÄ± ile) kendi deÄŸeriyle Ã¼zerine yazmak.

- **Ã‡ocuk sÃ¼reÃ§lerde canary Ã§atallanÄ±rsa**, bir byte'Ä± bir seferde **kaba kuvvetle** tahmin etmek mÃ¼mkÃ¼n olabilir:

{% content-ref url="bf-forked-stack-canaries.md" %}
[bf-forked-stack-canaries.md](bf-forked-stack-canaries.md)
{% endcontent-ref %}

- Ä°kili dosyada ilginÃ§ bir **sÄ±zÄ±ntÄ± veya keyfi okuma aÃ§Ä±ÄŸÄ±** varsa, sÄ±zdÄ±rmak mÃ¼mkÃ¼n olabilir:

{% content-ref url="print-stack-canary.md" %}
[print-stack-canary.md](print-stack-canary.md)
{% endcontent-ref %}

- **YÄ±ÄŸÄ±na depolanan iÅŸaretÃ§ileri Ã¼zerine yazma**

YÄ±ÄŸÄ±na taÅŸma aÃ§Ä±ÄŸÄ± olan yÄ±ÄŸÄ±n, yÄ±ÄŸÄ±n canary'sine ulaÅŸmadan zafiyeti sÃ¶mÃ¼rmek iÃ§in **Ã¼zerine yazÄ±labilecek dize veya iÅŸlev adresleri iÃ§erebilir**. Kontrol edin:

{% content-ref url="../../stack-overflow/pointer-redirecting.md" %}
[pointer-redirecting.md](../../stack-overflow/pointer-redirecting.md)
{% endcontent-ref %}

- **Hem ana hem de iÅŸ parÃ§acÄ±ÄŸÄ± canary'sini deÄŸiÅŸtirme**

Canary ile korunan bir iÅŸ parÃ§acÄ±ÄŸÄ±nda tampon taÅŸmasÄ±, iÅŸ parÃ§acÄ±ÄŸÄ±nÄ±n ana canary'sini deÄŸiÅŸtirmek iÃ§in kullanÄ±labilir. SonuÃ§ olarak, denetim iki deÄŸiÅŸtirilmiÅŸ canary ile yapÄ±ldÄ±ÄŸÄ±ndan koruma iÅŸe yaramaz.

AyrÄ±ca, canary ile korunan bir iÅŸlevde tampon taÅŸmasÄ±, TLS'de saklanan ana canary'yi deÄŸiÅŸtirmek iÃ§in kullanÄ±labilir. Bu, iÅŸ parÃ§acÄ±ÄŸÄ±nÄ±n yÄ±ÄŸÄ±nÄ±nda bir taÅŸma aracÄ±lÄ±ÄŸÄ±yla TLS'nin saklandÄ±ÄŸÄ± bellek konumuna ulaÅŸmak mÃ¼mkÃ¼n olabileceÄŸi iÃ§in mÃ¼mkÃ¼ndÃ¼r. SonuÃ§ olarak, denetim iki deÄŸiÅŸtirilmiÅŸ canary ile yapÄ±ldÄ±ÄŸÄ±ndan koruma iÅŸe yaramaz. Bu saldÄ±rÄ±, [http://7rocky.github.io/en/ctf/htb-challenges/pwn/robot-factory/#canaries-and-threads](http://7rocky.github.io/en/ctf/htb-challenges/pwn/robot-factory/#canaries-and-threads) yazÄ±sÄ±nda gerÃ§ekleÅŸtirilir.

AyrÄ±ca, genellikle **TLS**'nin **`mmap`** tarafÄ±ndan saklandÄ±ÄŸÄ±nÄ± ve bir **iÅŸ parÃ§acÄ±ÄŸÄ±nÄ±n yÄ±ÄŸÄ±nÄ±** oluÅŸturulduÄŸunda bunun da `mmap` tarafÄ±ndan oluÅŸturulduÄŸunu belirten [https://www.slideshare.net/codeblue\_jp/master-canary-forging-by-yuki-koike-code-blue-2015](https://www.slideshare.net/codeblue\_jp/master-canary-forging-by-yuki-koike-code-blue-2015) sunumuna bakÄ±n, bu da Ã¶nceki yazÄ±da gÃ¶sterildiÄŸi gibi taÅŸmaya izin verebilir.

- **`__stack_chk_fail`'in GOT giriÅŸini deÄŸiÅŸtirme**

Ä°kili dosyanÄ±n KÄ±smi RELRO'ya sahip olmasÄ± durumunda, **GOT giriÅŸini `__stack_chk_fail`'in** bir programÄ± engellemediÄŸi sahte bir iÅŸlev olacak ÅŸekilde deÄŸiÅŸtirmek iÃ§in keyfi yazma kullanabilirsiniz.

Bu saldÄ±rÄ±, [https://7rocky.github.io/en/ctf/other/securinets-ctf/scrambler/](https://7rocky.github.io/en/ctf/other/securinets-ctf/scrambler/) yazÄ±sÄ±nda gerÃ§ekleÅŸtirilir.
## Referanslar

* [https://guyinatuxedo.github.io/7.1-mitigation\_canary/index.html](https://guyinatuxedo.github.io/7.1-mitigation\_canary/index.html)
* [http://7rocky.github.io/en/ctf/htb-challenges/pwn/robot-factory/#canaries-and-threads](http://7rocky.github.io/en/ctf/htb-challenges/pwn/robot-factory/#canaries-and-threads)
* [https://7rocky.github.io/en/ctf/other/securinets-ctf/scrambler/](https://7rocky.github.io/en/ctf/other/securinets-ctf/scrambler/)

<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan kahraman seviyesine Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> ile!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ±zÄ± gÃ¶rmek veya HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuzu
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)'da takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR'ler gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>
