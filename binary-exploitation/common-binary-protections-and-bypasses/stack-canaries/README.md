# YÄ±ÄŸÄ±n KanaryalarÄ±

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sÄ±fÄ±rdan kahramana kadar AWS hacklemeyi Ã¶ÄŸrenin!</summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

- Åirketinizi **HackTricks'te reklamÄ±nÄ± gÃ¶rmek** veya **HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
- [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
- Ã–zel [**NFT'lerimizden oluÅŸan The PEASS Family'yi**](https://opensea.io/collection/the-peass-family) keÅŸfedin
- ğŸ’¬ **Discord grubuna** katÄ±lÄ±n veya [**telegram grubuna**](https://t.me/peass) veya **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)'Ä± takip edin.
- Hacking pÃ¼f noktalarÄ±nÄ±zÄ± **HackTricks** ve **HackTricks Cloud** github depolarÄ±na PR gÃ¶ndererek paylaÅŸÄ±n.

</details>

## **StackGuard ve StackShield**

**StackGuard**, aÅŸÄ±rÄ± taÅŸmalarÄ± Ã¶nlemek iÃ§in **EIP (Extended Instruction Pointer)**'den Ã¶nce Ã¶zel bir deÄŸer olan **kanarya** ekler, Ã¶zellikle `0x000aff0d` (null, newline, EOF, carriage return'Ã¼ temsil eder). Ancak, `recv()`, `memcpy()`, `read()` ve `bcopy()` gibi iÅŸlevler savunmasÄ±z kalÄ±r ve **EBP (Base Pointer)**'Ä± korumaz.

**StackShield**, tÃ¼m dÃ¶nÃ¼ÅŸ adreslerini (**EIP'ler**) depolayan bir **Global Return Stack**'e sahip olan StackGuard'dan daha sofistike bir yaklaÅŸÄ±m benimser. Bu kurulum, taÅŸmanÄ±n zarar vermemesini saÄŸlar, Ã§Ã¼nkÃ¼ depolanan ve gerÃ§ek dÃ¶nÃ¼ÅŸ adresleri arasÄ±nda karÅŸÄ±laÅŸtÄ±rma yaparak taÅŸma olaylarÄ±nÄ± tespit etmeyi saÄŸlar. AyrÄ±ca, StackShield, **EIP**'nin beklenen veri alanÄ±nÄ±n dÄ±ÅŸÄ±na iÅŸaret ettiÄŸini tespit etmek iÃ§in dÃ¶nÃ¼ÅŸ adresini bir sÄ±nÄ±r deÄŸeriyle karÅŸÄ±laÅŸtÄ±rabilir. Bununla birlikte, Return-to-libc, ROP (Return-Oriented Programming) veya ret2ret gibi tekniklerle bu koruma atlanabilir, bu da StackShield'Ä±n yerel deÄŸiÅŸkenleri korumadÄ±ÄŸÄ±nÄ± gÃ¶sterir.

## **YÄ±ÄŸÄ±n SaldÄ±rÄ± Koruyucusu (ProPolice) `-fstack-protector`:**

Bu mekanizma, **EBP**'den Ã¶nce bir **kanarya** yerleÅŸtirir ve yerel deÄŸiÅŸkenleri yeniden dÃ¼zenleyerek tamponlarÄ± diÄŸer deÄŸiÅŸkenleri Ã¼zerine yazmaktan koruyacak ÅŸekilde daha yÃ¼ksek bellek adreslerine yerleÅŸtirir. AyrÄ±ca, yÄ±ÄŸÄ±na geÃ§irilen argÃ¼manlarÄ± gÃ¼venli bir ÅŸekilde kopyalar ve bu kopyalarÄ± argÃ¼man olarak kullanÄ±r. Bununla birlikte, 8'den az Ã¶ÄŸeye sahip dizileri veya kullanÄ±cÄ±nÄ±n yapÄ±sÄ±ndaki tamponlarÄ± korumaz.

**Kanarya**, `/dev/urandom`'dan tÃ¼retilen rastgele bir sayÄ± veya varsayÄ±lan bir deÄŸer olan `0xff0a0000`'den gelir. **TLS (Thread Local Storage)**'de depolanÄ±r ve bu, iplikler arasÄ±nda paylaÅŸÄ±lan bellek alanlarÄ±nÄ±n iplik Ã¶zel genel veya statik deÄŸiÅŸkenlere sahip olmasÄ±na olanak tanÄ±r. Bu deÄŸiÅŸkenler baÅŸlangÄ±Ã§ta ebeveyn sÃ¼reÃ§ten kopyalanÄ±r ve Ã§ocuk sÃ¼reÃ§ler verilerini deÄŸiÅŸtirebilir ancak ebeveyni veya kardeÅŸleri etkilemez. Bununla birlikte, **`fork()` kullanÄ±larak yeni bir kanarya oluÅŸturulmadan kullanÄ±ldÄ±ÄŸÄ±nda, tÃ¼m sÃ¼reÃ§ler (ebeveyn ve Ã§ocuklar) aynÄ± kanaryayÄ± paylaÅŸÄ±r**, bu da onu savunmasÄ±z hale getirir. **i386** mimarisinde kanarya `gs:0x14`'te, **x86\_64**'te ise `fs:0x28`'de saklanÄ±r.

Bu yerel koruma, saldÄ±rÄ±lara aÃ§Ä±k tamponlara sahip iÅŸlevleri tanÄ±mlar ve bu iÅŸlevlerin baÅŸÄ±na kanaryayÄ± yerleÅŸtirmek ve bÃ¼tÃ¼nlÃ¼ÄŸÃ¼nÃ¼ doÄŸrulamak iÃ§in bu iÅŸlevlerin baÅŸÄ±na kod enjekte eder.

Bir web sunucusu `fork()` kullandÄ±ÄŸÄ±nda, kanaryayÄ± byte byte tahmin etmek iÃ§in bir brute-force saldÄ±rÄ±sÄ±nÄ± etkinleÅŸtirir. Ancak, `fork()`'ten sonra `execve()` kullanmak bellek alanÄ±nÄ± Ã¼zerine yazar ve saldÄ±rÄ±yÄ± geÃ§ersiz kÄ±lar. `vfork()`, Ã§ocuk sÃ¼recin yazmaya Ã§alÄ±ÅŸana kadar Ã§oÄŸaltÄ±lmadan Ã§alÄ±ÅŸmasÄ±na izin verir, bu noktada bir kopya oluÅŸturulur ve farklÄ± bir iÅŸlem oluÅŸturma ve bellek iÅŸleme yaklaÅŸÄ±mÄ± sunar.

### Uzunluklar

`x64` ikili dosyalarÄ±nda, kanarya Ã§erezi bir **`0x8`** bayt qword'dÃ¼r. **Ä°lk yedi bayt rastgele** ve son bayt bir **null bayttÄ±r**.

`x86` ikili dosyalarÄ±nda, kanarya Ã§erezi bir **`0x4`** bayt dword'dÃ¼r. **Ä°lk Ã¼Ã§ bayt rastgele** ve son bayt bir **null bayttÄ±r**.

{% hint style="danger" %}
Her iki kanaryanÄ±n en anlamlÄ± baytÄ± bir null bayttÄ±r Ã§Ã¼nkÃ¼ daha dÃ¼ÅŸÃ¼k adreslerden gelen yÄ±ÄŸÄ±ndan ilk olacak ve bu nedenle **dizeleri okuyan iÅŸlevler onu okumadan duracak**.
{% endhint %}

## Atlamalar

**KanaryayÄ± sÄ±zdÄ±rmak** ve ardÄ±ndan (Ã¶rneÄŸin tampon taÅŸmasÄ±yla) kendi deÄŸeriyle Ã¼zerine yazmak.

* **Ã‡ocuk sÃ¼reÃ§lerde kanarya Ã§atallandÄ±ÄŸÄ±nda** bir byte'Ä± bir seferde **brute-force** etmek mÃ¼mkÃ¼n olabilir:

{% content-ref url="bf-forked-stack-canaries.md" %}
[bf-forked-stack-canaries.md](bf-forked-stack-canaries.md)
{% endcontent-ref %}

* Ä°kili dosyada ilginÃ§ bir **sÄ±zÄ±ntÄ± veya keyfi okuma aÃ§Ä±ÄŸÄ±** varsa, sÄ±zdÄ±rmak mÃ¼mkÃ¼n olabilir:

{% content-ref url="print-stack-canary.md" %}
[print-stack-canary.md](print-stack-canary.md)
{% endcontent-ref %}

* **YÄ±ÄŸÄ±nda depolanan iÅŸaretÃ§ileri Ã¼zerine yazma**

YÄ±ÄŸÄ±n, yÄ±ÄŸÄ±n taÅŸmasÄ± iÃ§in savunmasÄ±z olabilir ve bu, yÄ±ÄŸÄ±n kanaryasÄ±na ulaÅŸmadan zafiyeti sÃ¶mÃ¼rmek iÃ§in Ã¼zerine yazÄ±labilecek dize veya iÅŸlev adreslerini iÃ§erebilir. Kontrol edin:

{% content-ref url="../../stack-overflow/pointer-redirecting.md" %}
[pointer-redirecting.md](../../stack-overflow/pointer-redirecting.md)
{% endcontent-ref %}

## Referanslar

* [https://guyinatuxedo.github.io/7.1-mitigation\_canary/index.html](https://guyinatuxedo.github.io/7.1-mitigation\_canary/index.html)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sÄ±fÄ±rdan kahramana kadar AWS hacklemeyi Ã¶ÄŸrenin!</summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

- Åirketinizi **HackTricks'te reklamÄ±nÄ± gÃ¶rmek** veya **HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
- [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
- Ã–zel [**NFT'lerimizden oluÅŸan The PEASS Family'yi**](https://opensea.io/collection/the-peass-family) keÅŸfedin
- ğŸ’¬ **Discord grubuna** katÄ±lÄ±n veya [**telegram grubuna**](https://t.me/peass) veya **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)'Ä± takip edin.
- Hacking pÃ¼f noktalarÄ±nÄ±zÄ± **HackTricks** ve **HackTricks Cloud** github depolarÄ±na PR gÃ¶ndererek paylaÅŸÄ±n.

</details>
