# Bins & å†…å­˜åˆ†é…

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS çº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨ HackTricks ä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½ HackTricks çš„ PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** ä¸Šå…³æ³¨**æˆ‘ä»¬ã€‚
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## åŸºæœ¬ä¿¡æ¯

ä¸ºäº†æé«˜å—å­˜å‚¨çš„æ•ˆç‡ï¼Œæ¯ä¸ªå—ä¸ä»…ä»…åœ¨ä¸€ä¸ªé“¾æ¥åˆ—è¡¨ä¸­ï¼Œè€Œæ˜¯æœ‰å‡ ç§ç±»å‹ã€‚è¿™äº›æ˜¯ binsï¼Œæœ‰ 5 ç§ç±»å‹çš„ binsï¼š[62](https://sourceware.org/git/gitweb.cgi?p=glibc.git;a=blob;f=malloc/malloc.c;h=6e766d11bc85b6480fa5c9f2a76559f8acf9deb5;hb=HEAD#l1407) å°å‹ binsï¼Œ63 å¤§å‹ binsï¼Œ1 æœªæ’åº binï¼Œ10 å¿«é€Ÿ bins å’Œæ¯ä¸ªçº¿ç¨‹ 64 ä¸ª tcache binsã€‚

æ¯ä¸ªæœªæ’åºã€å°å‹å’Œå¤§å‹ bins çš„åˆå§‹åœ°å€éƒ½åœ¨åŒä¸€ä¸ªæ•°ç»„å†…ã€‚ç´¢å¼• 0 æœªä½¿ç”¨ï¼Œ1 æ˜¯æœªæ’åº binï¼Œbins 2-64 æ˜¯å°å‹ binsï¼Œbins 65-127 æ˜¯å¤§å‹ binsã€‚

### å°å‹ Bins

å°å‹ bins æ¯”å¤§å‹ bins æ›´å¿«ï¼Œä½†æ¯”å¿«é€Ÿ bins æ›´æ…¢ã€‚

62 ä¸ª bins ä¸­çš„æ¯ä¸ª bin å°†å…·æœ‰**ç›¸åŒå¤§å°çš„å—**ï¼š16ã€24ã€...ï¼ˆåœ¨ 32 ä½ç³»ç»Ÿä¸­æœ€å¤§å¤§å°ä¸º 504 å­—èŠ‚ï¼Œåœ¨ 64 ä½ç³»ç»Ÿä¸­ä¸º 1024 å­—èŠ‚ï¼‰ã€‚è¿™æœ‰åŠ©äºåŠ å¿«æŸ¥æ‰¾åº”åˆ†é…ç©ºé—´çš„ binã€æ’å…¥å’Œåˆ é™¤è¿™äº›åˆ—è¡¨ä¸­çš„æ¡ç›®çš„é€Ÿåº¦ã€‚

### å¤§å‹ Bins

ä¸ç®¡ç†å›ºå®šå¤§å°å—çš„å°å‹ bins ä¸åŒï¼Œæ¯ä¸ª**å¤§å‹ bin å¤„ç†ä¸€ç³»åˆ—å—å¤§å°**ã€‚è¿™æ›´åŠ çµæ´»ï¼Œå…è®¸ç³»ç»Ÿ**å®¹çº³å„ç§å¤§å°**è€Œæ— éœ€ä¸ºæ¯ä¸ªå¤§å°å•ç‹¬è®¾ç½® binã€‚

åœ¨å†…å­˜åˆ†é…å™¨ä¸­ï¼Œå¤§å‹ bins ä»å°å‹ bins ç»“æŸçš„åœ°æ–¹å¼€å§‹ã€‚å¤§å‹ bins çš„èŒƒå›´é€æ¸å˜å¤§ï¼Œæ„å‘³ç€ç¬¬ä¸€ä¸ª bin å¯èƒ½è¦†ç›–ä» 512 åˆ° 576 å­—èŠ‚çš„å—ï¼Œè€Œä¸‹ä¸€ä¸ªè¦†ç›–ä» 576 åˆ° 640 å­—èŠ‚çš„å—ã€‚è¿™ç§æ¨¡å¼ç»§ç»­ä¸‹å»ï¼Œæœ€å¤§çš„ bin åŒ…å«æ‰€æœ‰å¤§äº 1MB çš„å—ã€‚

ä¸å°å‹ bins ç›¸æ¯”ï¼Œå¤§å‹ bins æ“ä½œé€Ÿåº¦è¾ƒæ…¢ï¼Œå› ä¸ºå®ƒä»¬å¿…é¡»**å¯¹åŒ…å«ä¸åŒå—å¤§å°çš„åˆ—è¡¨è¿›è¡Œæ’åºå’Œæœç´¢**ï¼Œä»¥æ‰¾åˆ°æœ€ä½³åŒ¹é…çš„åˆ†é…ã€‚å½“å°†å—æ’å…¥å¤§å‹ bin æ—¶ï¼Œå¿…é¡»å¯¹å…¶è¿›è¡Œæ’åºï¼Œå½“åˆ†é…å†…å­˜æ—¶ï¼Œç³»ç»Ÿå¿…é¡»æ‰¾åˆ°æ­£ç¡®çš„å—ã€‚è¿™é¢å¤–çš„å·¥ä½œä½¿å®ƒä»¬**æ›´æ…¢**ï¼Œä½†ç”±äºå¤§å‹åˆ†é…æ¯”å°å‹åˆ†é…æ›´å°‘è§ï¼Œè¿™æ˜¯ä¸€ä¸ªå¯ä»¥æ¥å—çš„æŠ˜è¡·ã€‚

æœ‰ï¼š

* 32 ä¸ª 64B èŒƒå›´çš„ bins
* 16 ä¸ª 512B èŒƒå›´çš„ bins
* 8 ä¸ª 4096B èŒƒå›´çš„ bins
* 4 ä¸ª 32768B èŒƒå›´çš„ bins
* 2 ä¸ª 262144B èŒƒå›´çš„ bins
* 1 ä¸ªç”¨äºå‰©ä½™å¤§å°çš„ bins

### æœªæ’åº Bin

æœªæ’åº bin æ˜¯å †ç®¡ç†å™¨ç”¨äºåŠ å¿«å†…å­˜åˆ†é…çš„**å¿«é€Ÿç¼“å­˜**ã€‚å®ƒçš„å·¥ä½œåŸç†æ˜¯ï¼šå½“ç¨‹åºé‡Šæ”¾å†…å­˜æ—¶ï¼Œå †ç®¡ç†å™¨ä¸ä¼šç«‹å³å°†å…¶æ”¾å…¥ç‰¹å®šçš„ bin ä¸­ã€‚ç›¸åï¼Œå®ƒé¦–å…ˆå°è¯•**å°†å…¶ä¸ä»»ä½•ç›¸é‚»çš„ç©ºé—²å—åˆå¹¶**ï¼Œä»¥åˆ›å»ºä¸€ä¸ªæ›´å¤§çš„ç©ºé—²å†…å­˜å—ã€‚ç„¶åï¼Œå®ƒå°†è¿™ä¸ªæ–°å—æ”¾å…¥ä¸€ä¸ªç§°ä¸ºâ€œæœªæ’åº binâ€çš„é€šç”¨ bin ä¸­ã€‚

å½“ç¨‹åº**è¯·æ±‚å†…å­˜**æ—¶ï¼Œå †ç®¡ç†å™¨**æ£€æŸ¥æœªæ’åº bin**ï¼Œçœ‹çœ‹æ˜¯å¦æœ‰è¶³å¤Ÿå¤§å°çš„å—ã€‚å¦‚æœæ‰¾åˆ°ä¸€ä¸ªï¼Œå®ƒç«‹å³ä½¿ç”¨ã€‚å¦‚æœæ‰¾ä¸åˆ°åˆé€‚çš„å—ï¼Œå®ƒå°†é‡Šæ”¾çš„å—ç§»åŠ¨åˆ°å…¶ç›¸åº”çš„ bins ä¸­ï¼Œæ— è®ºæ˜¯å°å‹è¿˜æ˜¯å¤§å‹ï¼ŒåŸºäºå®ƒä»¬çš„å¤§å°ã€‚

å› æ­¤ï¼Œæœªæ’åº bin æ˜¯é€šè¿‡å¿«é€Ÿé‡ç”¨æœ€è¿‘é‡Šæ”¾çš„å†…å­˜æ¥åŠ é€Ÿå†…å­˜åˆ†é…ï¼Œå¹¶å‡å°‘è€—æ—¶çš„æœç´¢å’Œåˆå¹¶çš„éœ€æ±‚ã€‚

{% hint style="danger" %}
è¯·æ³¨æ„ï¼Œå³ä½¿å—å±äºä¸åŒçš„ç±»åˆ«ï¼Œå¦‚æœä¸€ä¸ªå¯ç”¨å—ä¸å¦ä¸€ä¸ªå¯ç”¨å—å‘ç”Ÿå†²çªï¼ˆå³ä½¿å®ƒä»¬å±äºä¸åŒçš„ç±»åˆ«ï¼‰ï¼Œå®ƒä»¬å°†è¢«åˆå¹¶ã€‚
{% endhint %}

### å¿«é€Ÿ Bins

å¿«é€Ÿ bins æ—¨åœ¨é€šè¿‡å°†æœ€è¿‘é‡Šæ”¾çš„å—ä¿ç•™åœ¨å¿«é€Ÿè®¿é—®ç»“æ„ä¸­æ¥**åŠ é€Ÿå°å—çš„å†…å­˜åˆ†é…**ã€‚è¿™äº› bins ä½¿ç”¨åè¿›å…ˆå‡ºï¼ˆLIFOï¼‰æ–¹æ³•ï¼Œè¿™æ„å‘³ç€**æœ€è¿‘é‡Šæ”¾çš„å—æ˜¯**åœ¨æœ‰æ–°çš„åˆ†é…è¯·æ±‚æ—¶**é¦–å…ˆè¢«é‡ç”¨**ã€‚è¿™ç§è¡Œä¸ºå¯¹é€Ÿåº¦æœ‰åˆ©ï¼Œå› ä¸ºä¸é˜Ÿåˆ—ï¼ˆFIFOï¼‰ç›¸æ¯”ï¼Œä»æ ˆé¡¶ï¼ˆLIFOï¼‰æ’å…¥å’Œåˆ é™¤æ›´å¿«ã€‚

æ­¤å¤–ï¼Œ**å¿«é€Ÿ bins ä½¿ç”¨å•é“¾è¡¨**ï¼Œè€Œä¸æ˜¯åŒé“¾è¡¨ï¼Œè¿™è¿›ä¸€æ­¥æé«˜äº†é€Ÿåº¦ã€‚ç”±äºå¿«é€Ÿ bins ä¸­çš„å—ä¸ä¼šä¸ç›¸é‚»å—åˆå¹¶ï¼Œå› æ­¤ä¸éœ€è¦å…è®¸ä»ä¸­é—´åˆ é™¤çš„å¤æ‚ç»“æ„ã€‚å•é“¾è¡¨å¯¹äºè¿™äº›æ“ä½œæ›´ç®€å•ã€æ›´å¿«ã€‚

åŸºæœ¬ä¸Šï¼Œè¿™é‡Œå‘ç”Ÿçš„æ˜¯ï¼Œå¤´éƒ¨ï¼ˆæŒ‡å‘è¦æ£€æŸ¥çš„ç¬¬ä¸€ä¸ªå—çš„æŒ‡é’ˆï¼‰å§‹ç»ˆæŒ‡å‘è¯¥å¤§å°çš„æœ€æ–°é‡Šæ”¾å—ã€‚å› æ­¤ï¼š

* å½“åˆ†é…è¯¥å¤§å°çš„æ–°å—æ—¶ï¼Œå¤´éƒ¨æŒ‡å‘ä¸€ä¸ªå¯ç”¨çš„ç©ºé—²å—ä»¥ä¾›ä½¿ç”¨ã€‚ç”±äºæ­¤ç©ºé—²å—æŒ‡å‘ä¸‹ä¸€ä¸ªè¦ä½¿ç”¨çš„å—ï¼Œå› æ­¤å°†æ­¤åœ°å€å­˜å‚¨åœ¨å¤´éƒ¨ä¸­ï¼Œä»¥ä¾¿ä¸‹ä¸€ä¸ªåˆ†é…çŸ¥é“ä»å“ªé‡Œè·å–å¯ç”¨å—
* å½“é‡Šæ”¾å—æ—¶ï¼Œç©ºé—²å—å°†ä¿å­˜å½“å‰å¯ç”¨å—çš„åœ°å€ï¼Œå¹¶å°†è¿™ä¸ªæ–°é‡Šæ”¾å—çš„åœ°å€æ”¾å…¥å¤´éƒ¨

{% hint style="danger" %}
å¿«é€Ÿ bins ä¸­çš„å—ä¸ä¼šè‡ªåŠ¨è®¾ç½®ä¸ºå¯ç”¨ï¼Œå› æ­¤å®ƒä»¬ä¼šä¿æŒä¸€æ®µæ—¶é—´ä½œä¸ºå¿«é€Ÿ bin å—ï¼Œè€Œä¸æ˜¯èƒ½å¤Ÿä¸å…¶ä»–å—åˆå¹¶ã€‚
{% endhint %}

### Tcacheï¼ˆæ¯çº¿ç¨‹ç¼“å­˜ï¼‰Bins

å°½ç®¡çº¿ç¨‹å°è¯•æ‹¥æœ‰è‡ªå·±çš„å †ï¼ˆå‚è§[ç«æŠ€åœº](bins-and-memory-allocations.md#arenas)å’Œ[å­å †](bins-and-memory-allocations.md#subheaps)ï¼‰ï¼Œä½†å­˜åœ¨ä¸€ä¸ªå¯èƒ½æ€§ï¼Œå³å…·æœ‰å¤§é‡çº¿ç¨‹çš„è¿›ç¨‹ï¼ˆå¦‚ Web æœåŠ¡å™¨ï¼‰**æœ€ç»ˆä¼šä¸å…¶ä»–çº¿ç¨‹å…±äº«å †**ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸»è¦è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨**é”**ï¼Œè¿™å¯èƒ½**æ˜¾è‘—å‡æ…¢çº¿ç¨‹**ã€‚

å› æ­¤ï¼Œtcache ç±»ä¼¼äºæ¯ä¸ªçº¿ç¨‹çš„å¿«é€Ÿ binï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ª**å•é“¾è¡¨**ï¼Œä¸åˆå¹¶å—ã€‚æ¯ä¸ªçº¿ç¨‹æœ‰**64 ä¸ªå•é“¾å¼ tcache bins**ã€‚æ¯ä¸ª bin å¯ä»¥æ‹¥æœ‰æœ€å¤š[7 ä¸ªç›¸åŒå¤§å°çš„å—](https://sourceware.org/git/?p=glibc.git;a=blob;f=malloc/malloc.c;h=2527e2504761744df2bdb1abdc02d936ff907ad2;hb=d5c3fafc4307c9b7a4c7d5cb381fcdbfad340bcc#l323)ï¼ŒèŒƒå›´ä»[24 åˆ° 1032Bï¼ˆ64 ä½ç³»ç»Ÿï¼‰å’Œ 12 åˆ° 516Bï¼ˆ32 ä½ç³»ç»Ÿï¼‰](https://sourceware.org/git/?p=glibc.git;a=blob;f=malloc/malloc.c;h=2527e2504761744df2bdb1abdc02d936ff907ad2;hb=d5c3fafc4307c9b7a4c7d5cb381fcdbfad340bcc#l315)ã€‚

å½“ä¸€ä¸ªçº¿ç¨‹**é‡Šæ”¾**ä¸€ä¸ªå—æ—¶ï¼Œ**å¦‚æœå®ƒä¸å¤ªå¤§**ä»¥è‡³äºæ— æ³•åœ¨ tcache ä¸­åˆ†é…ï¼Œå¹¶ä¸”ç›¸åº”çš„ tcache bin **ä¸æ»¡**ï¼ˆå·²æœ‰ 7 ä¸ªå—ï¼‰ï¼Œ**å®ƒå°†è¢«åˆ†é…åˆ°é‚£é‡Œ**ã€‚å¦‚æœæ— æ³•è¿›å…¥ tcacheï¼Œå®ƒå°†éœ€è¦ç­‰å¾…å †é”ä»¥èƒ½å¤Ÿåœ¨å…¨å±€ bins ä¸­æ‰§è¡Œé‡Šæ”¾æ“ä½œã€‚

å½“**åˆ†é…å—**æ—¶ï¼Œå¦‚æœåœ¨**Tcache ä¸­æœ‰æ‰€éœ€å¤§å°çš„ç©ºé—²å—ï¼Œå®ƒå°†ä½¿ç”¨å®ƒ**ï¼Œå¦åˆ™ï¼Œå®ƒå°†éœ€è¦ç­‰å¾…å †é”ä»¥èƒ½å¤Ÿåœ¨å…¨å±€ bins ä¸­æ‰¾åˆ°ä¸€ä¸ªæˆ–åˆ›å»ºä¸€ä¸ªæ–°çš„ã€‚\
è¿˜æœ‰ä¸€ä¸ªä¼˜åŒ–ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒæŒæœ‰å †é”æ—¶ï¼Œçº¿ç¨‹**å°†ç”¨è¯·æ±‚å¤§å°çš„å †å—ï¼ˆ7 ä¸ªï¼‰å¡«å……å…¶ Tcache**ï¼Œå› æ­¤å¦‚æœéœ€è¦æ›´å¤šï¼Œå®ƒå°†åœ¨ Tcache ä¸­æ‰¾åˆ°å®ƒä»¬ã€‚
## åˆ†é…æµç¨‹

{% hint style="success" %}
(æ­¤å½“å‰è§£é‡Šæ¥è‡ª[https://heap-exploitation.dhavalkapil.com/diving\_into\_glibc\_heap/core\_functions](https://heap-exploitation.dhavalkapil.com/diving\_into\_glibc\_heap/core\_functions). TODO: æ£€æŸ¥æœ€æ–°ç‰ˆæœ¬å¹¶æ›´æ–°)
{% endhint %}

åˆ†é…æœ€ç»ˆé€šè¿‡å‡½æ•°æ‰§è¡Œï¼š`void * _int_malloc (mstate av, size_t bytes)`ï¼Œå¹¶æŒ‰ç…§ä»¥ä¸‹é¡ºåºè¿›è¡Œï¼š

1. æ›´æ–° `bytes` ä»¥å¤„ç†**å¯¹é½**ç­‰é—®é¢˜ã€‚
2. æ£€æŸ¥ `av` æ˜¯å¦ä¸º**NULL**ã€‚
3. åœ¨**å¯ç”¨çš„åŒºåŸŸ**ç¼ºå¤±çš„æƒ…å†µä¸‹ï¼ˆå½“ `av` ä¸º NULL æ—¶ï¼‰ï¼Œè°ƒç”¨ `sysmalloc` ä½¿ç”¨ mmap è·å–å—ã€‚å¦‚æœæˆåŠŸï¼Œè°ƒç”¨ `alloc_perturb`ã€‚è¿”å›æŒ‡é’ˆã€‚
4. æ ¹æ®å¤§å°ä¸åŒï¼š
* \[åŸæ–‡æ·»åŠ ] åœ¨æ£€æŸ¥ä¸‹ä¸€ä¸ª fastbin ä¹‹å‰ä½¿ç”¨ tcacheã€‚
* \[åŸæ–‡æ·»åŠ ] å¦‚æœæ²¡æœ‰ tcache ä½†ä½¿ç”¨äº†ä¸åŒçš„ binï¼ˆè§åç»­æ­¥éª¤ï¼‰ï¼Œå°è¯•ä»è¯¥ bin å¡«å…… tcacheã€‚
* å¦‚æœå¤§å°åœ¨**fastbin**èŒƒå›´å†…ï¼š
1. è·å–ç´¢å¼•ä»¥è®¿é—®é€‚å½“çš„ bin ä¸­çš„ç¬¬ä¸€ä¸ªå—ã€‚
2. ç§»é™¤è¯¥ bin ä¸­çš„ç¬¬ä¸€ä¸ªå—ï¼Œå¹¶ä½¿ `victim` æŒ‡å‘å®ƒã€‚
3. å¦‚æœ `victim` ä¸º NULLï¼Œåˆ™è½¬åˆ°ä¸‹ä¸€ä¸ªæƒ…å†µï¼ˆsmallbinï¼‰ã€‚
4. å¦‚æœ `victim` ä¸ä¸º NULLï¼Œåˆ™æ£€æŸ¥å—çš„å¤§å°ä»¥ç¡®ä¿å®ƒå±äºè¯¥ç‰¹å®š binã€‚å¦åˆ™ä¼šæŠ›å‡ºé”™è¯¯ï¼ˆ"malloc(): memory corruption (fast)"ï¼‰ã€‚
5. è°ƒç”¨ `alloc_perturb`ï¼Œç„¶åè¿”å›æŒ‡é’ˆã€‚
* å¦‚æœå¤§å°åœ¨**smallbin**èŒƒå›´å†…ï¼š
1. è·å–ç´¢å¼•ä»¥è®¿é—®é€‚å½“çš„ bin ä¸­çš„ç¬¬ä¸€ä¸ªå—ã€‚
2. å¦‚æœè¯¥ bin ä¸­æ²¡æœ‰å—ï¼Œåˆ™è½¬åˆ°ä¸‹ä¸€ä¸ªæƒ…å†µã€‚é€šè¿‡æ¯”è¾ƒæŒ‡é’ˆ `bin` å’Œ `bin->bk` æ¥æ£€æŸ¥ã€‚
3. ä½¿ `victim` ç­‰äº `bin->bk`ï¼ˆè¯¥ bin ä¸­çš„æœ€åä¸€ä¸ªå—ï¼‰ã€‚å¦‚æœå®ƒä¸º NULLï¼ˆåœ¨ `åˆå§‹åŒ–` æœŸé—´å‘ç”Ÿï¼‰ï¼Œåˆ™è°ƒç”¨ `malloc_consolidate` å¹¶è·³è¿‡æ£€æŸ¥ä¸åŒ bin çš„å®Œæ•´æ­¥éª¤ã€‚
4. å¦åˆ™ï¼Œå½“ `victim` ä¸ä¸º NULL æ—¶ï¼Œæ£€æŸ¥ `victim->bk->fd` å’Œ `victim` æ˜¯å¦ç›¸ç­‰ã€‚å¦‚æœå®ƒä»¬ä¸ç›¸ç­‰ï¼Œåˆ™æŠ›å‡ºé”™è¯¯ï¼ˆ"malloc(): smallbin double linked list corrupted"ï¼‰ã€‚
5. ä¸ºä¸‹ä¸€ä¸ªå—ï¼ˆåœ¨å†…å­˜ä¸­ï¼Œè€Œä¸æ˜¯åœ¨åŒå‘é“¾è¡¨ä¸­ï¼‰è®¾ç½® PREV\_INSUSE ä½ã€‚
6. ä» bin åˆ—è¡¨ä¸­ç§»é™¤æ­¤å—ã€‚
7. æ ¹æ® `av` è®¾ç½®æ­¤å—çš„é€‚å½“åŒºåŸŸä½ã€‚
8. è°ƒç”¨ `alloc_perturb`ï¼Œç„¶åè¿”å›æŒ‡é’ˆã€‚
* å¦‚æœå¤§å°ä¸åœ¨ smallbin èŒƒå›´å†…ï¼š
1. è·å–ç´¢å¼•ä»¥è®¿é—®é€‚å½“çš„ bin ä¸­çš„ç¬¬ä¸€ä¸ªå—ã€‚
2. æŸ¥çœ‹ `av` æ˜¯å¦æœ‰ fastchunksã€‚é€šè¿‡æ£€æŸ¥ `av->flags` ä¸­çš„ `FASTCHUNKS_BIT` æ¥å®Œæˆã€‚å¦‚æœæ˜¯ï¼Œåˆ™åœ¨ `av` ä¸Šè°ƒç”¨ `malloc_consolidate`ã€‚
5. å¦‚æœå°šæœªè¿”å›æŒ‡é’ˆï¼Œåˆ™è¡¨ç¤ºä»¥ä¸‹ä¸€ç§æˆ–å¤šç§æƒ…å†µï¼š
1. å¤§å°åœ¨ 'fastbin' èŒƒå›´å†…ï¼Œä½†æ²¡æœ‰å¯ç”¨çš„ fastchunkã€‚
2. å¤§å°åœ¨ 'smallbin' èŒƒå›´å†…ï¼Œä½†æ²¡æœ‰å¯ç”¨çš„ smallchunkï¼ˆåœ¨åˆå§‹åŒ–æœŸé—´è°ƒç”¨ `malloc_consolidate`ï¼‰ã€‚
3. å¤§å°åœ¨ 'largbin' èŒƒå›´å†…ã€‚
6. æ¥ä¸‹æ¥ï¼Œæ£€æŸ¥**æœªæ’åºçš„å—**ï¼Œå¹¶å°†éå†çš„å—æ”¾å…¥ bin ä¸­ã€‚è¿™æ˜¯å”¯ä¸€å°†å—æ”¾å…¥ bin ä¸­çš„åœ°æ–¹ã€‚ä» 'TAIL' è¿­ä»£æœªæ’åºçš„ binã€‚
1. `victim` æŒ‡å‘å½“å‰è€ƒè™‘çš„å—ã€‚
2. æ£€æŸ¥ `victim` çš„å—å¤§å°æ˜¯å¦åœ¨æœ€å°å€¼ï¼ˆ`2*SIZE_SZ`ï¼‰å’Œæœ€å¤§å€¼ï¼ˆ`av->system_mem`ï¼‰èŒƒå›´å†…ã€‚å¦åˆ™æŠ›å‡ºé”™è¯¯ï¼ˆ"malloc(): memory corruption"ï¼‰ã€‚
3. å¦‚æœï¼ˆè¯·æ±‚çš„å—å¤§å°åœ¨ smallbin èŒƒå›´å†…ï¼‰ä¸”ï¼ˆ`victim` æ˜¯æœ€åçš„å‰©ä½™å—ï¼‰ä¸”ï¼ˆå®ƒæ˜¯æœªæ’åº bin ä¸­çš„å”¯ä¸€å—ï¼‰ä¸”ï¼ˆå—å¤§å° >= è¯·æ±‚çš„å¤§å°ï¼‰ï¼š**å°†å—åˆ†æˆ 2 ä¸ªå—**ï¼š
* ç¬¬ä¸€ä¸ªå—åŒ¹é…è¯·æ±‚çš„å¤§å°å¹¶è¿”å›ã€‚
* å‰©ä½™å—æˆä¸ºæ–°çš„æœ€åå‰©ä½™å—ã€‚å°†å…¶æ’å…¥æœªæ’åºçš„ bin ä¸­ã€‚
1. é€‚å½“è®¾ç½®è¿™ä¸¤ä¸ªå—çš„ `chunk_size` å’Œ `chunk_prev_size` å­—æ®µã€‚
2. åœ¨è°ƒç”¨ `alloc_perturb` åè¿”å›ç¬¬ä¸€ä¸ªå—ã€‚
3. å¦‚æœä¸Šè¿°æ¡ä»¶ä¸ºå‡ï¼Œåˆ™æ§åˆ¶åˆ°æ­¤å¤„ã€‚ä»æœªæ’åºçš„ bin ä¸­ç§»é™¤ `victim`ã€‚å¦‚æœ `victim` çš„å¤§å°ä¸è¯·æ±‚çš„å¤§å°å®Œå…¨åŒ¹é…ï¼Œåˆ™åœ¨è°ƒç”¨ `alloc_perturb` åè¿”å›æ­¤å—ã€‚
4. å¦‚æœ `victim` çš„å¤§å°åœ¨ smallbin èŒƒå›´å†…ï¼Œåˆ™å°†å—æ·»åŠ åˆ°é€‚å½“çš„ smallbin ä¸­çš„ `HEAD`ã€‚
5. å¦åˆ™ï¼Œæ’å…¥åˆ°é€‚å½“çš„ largebin ä¸­å¹¶ä¿æŒæ’åºé¡ºåºï¼š
6. é¦–å…ˆæ£€æŸ¥æœ€åä¸€ä¸ªå—ï¼ˆæœ€å°çš„ï¼‰ã€‚å¦‚æœ `victim` å°äºæœ€åä¸€ä¸ªå—ï¼Œåˆ™å°†å…¶æ’å…¥åˆ°æœ€åã€‚
7. å¦åˆ™ï¼Œå¾ªç¯æŸ¥æ‰¾å¤§å° >= `victim` å¤§å°çš„å—ã€‚å¦‚æœå¤§å°å®Œå…¨ç›¸åŒï¼Œåˆ™å§‹ç»ˆæ’å…¥åˆ°ç¬¬äºŒä¸ªä½ç½®ã€‚
8. æœ€å¤šé‡å¤æ­¤æ•´ä¸ªæ­¥éª¤ `MAX_ITERS`ï¼ˆ10000 æ¬¡ï¼‰æˆ–ç›´åˆ°æœªæ’åº bin ä¸­çš„æ‰€æœ‰å—ç”¨å°½ã€‚
7. æ£€æŸ¥æœªæ’åºå—åï¼Œæ£€æŸ¥è¯·æ±‚çš„å¤§å°æ˜¯å¦ä¸åœ¨ smallbin èŒƒå›´å†…ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™æ£€æŸ¥**largebins**ã€‚
1. è·å–ç´¢å¼•ä»¥è®¿é—®é€‚å½“çš„ bin ä¸­çš„ç¬¬ä¸€ä¸ªå—ã€‚
2. å¦‚æœæœ€å¤§å—çš„å¤§å°ï¼ˆbin ä¸­çš„ç¬¬ä¸€ä¸ªå—ï¼‰å¤§äºè¯·æ±‚çš„å¤§å°ï¼š
1. ä» 'TAIL' å¼€å§‹è¿­ä»£ä»¥æ‰¾åˆ°ä¸€ä¸ªå¤§å° >= è¯·æ±‚å¤§å°çš„å—ï¼ˆ`victim`ï¼‰ã€‚
2. è°ƒç”¨ `unlink` ä»¥ä» bin ä¸­ç§»é™¤ `victim` å—ã€‚
3. ä¸º `victim` çš„å—è®¡ç®— `remainder_size`ï¼ˆè¿™å°†æ˜¯ `victim` çš„å—å¤§å° - è¯·æ±‚çš„å¤§å°ï¼‰ã€‚
4. å¦‚æœæ­¤ `remainder_size` >= `MINSIZE`ï¼ˆåŒ…æ‹¬å¤´éƒ¨çš„æœ€å°å—å¤§å°ï¼‰ï¼Œåˆ™å°†å—åˆ†æˆä¸¤ä¸ªå—ã€‚å¦åˆ™ï¼Œæ•´ä¸ª `victim` å—å°†è¢«è¿”å›ã€‚å°†å‰©ä½™å—æ’å…¥æœªæ’åºçš„ bin ä¸­ï¼ˆåœ¨ 'TAIL' æœ«å°¾ï¼‰ã€‚åœ¨æœªæ’åºçš„ bin ä¸­æ£€æŸ¥æ˜¯å¦ `unsorted_chunks(av)->fd->bk == unsorted_chunks(av)`ã€‚å¦åˆ™æŠ›å‡ºé”™è¯¯ï¼ˆ"malloc(): corrupted unsorted chunks"ï¼‰ã€‚
5. åœ¨è°ƒç”¨ `alloc_perturb` åè¿”å› `victim` å—ã€‚
8. åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»æ£€æŸ¥äº†æœªæ’åº bin ä»¥åŠç›¸åº”çš„ fastã€small æˆ– large binã€‚è¯·æ³¨æ„ï¼Œä½¿ç”¨**ç¡®åˆ‡**è¯·æ±‚å—å¤§å°æ£€æŸ¥äº†å•ä¸ª binï¼ˆfast æˆ– smallï¼‰ã€‚é‡å¤ä»¥ä¸‹æ­¥éª¤ç›´åˆ°æ‰€æœ‰ bin è¢«ç”¨å°½ï¼š
1. é€’å¢ bin æ•°ç»„çš„ç´¢å¼•ä»¥æ£€æŸ¥ä¸‹ä¸€ä¸ª binã€‚
2. ä½¿ç”¨ `av->binmap` æ˜ å°„è·³è¿‡ç©ºçš„ binã€‚
3. `victim` æŒ‡å‘å½“å‰ bin çš„ 'TAIL'ã€‚
4. ä½¿ç”¨ binmap ç¡®ä¿å¦‚æœè·³è¿‡äº†ä¸€ä¸ª binï¼ˆåœ¨ä¸Šè¿°ç¬¬ 2 æ­¥ä¸­ï¼‰ï¼Œåˆ™å®ƒè‚¯å®šæ˜¯ç©ºçš„ã€‚ä½†è¿™å¹¶ä¸ä¿è¯æ‰€æœ‰ç©ºçš„ bin éƒ½ä¼šè¢«è·³è¿‡ã€‚æ£€æŸ¥ victim æ˜¯å¦ä¸ºç©ºã€‚å¦‚æœä¸ºç©ºï¼Œåˆ™å†æ¬¡è·³è¿‡è¯¥ bin å¹¶é‡å¤ä¸Šè¿°è¿‡ç¨‹ï¼ˆæˆ–â€œç»§ç»­â€æ­¤å¾ªç¯ï¼‰ï¼Œç›´åˆ°åˆ°è¾¾éç©º binã€‚
5. å°†å—åˆ†å‰²ä¸ºä¸¤ä¸ªå—ï¼ˆ`victim` æŒ‡å‘éç©º bin çš„æœ€åä¸€ä¸ªå—ï¼‰ã€‚å°†å‰©ä½™å—æ’å…¥æœªæ’åºçš„ bin ä¸­ï¼ˆåœ¨ 'TAIL' æœ«å°¾ï¼‰ã€‚åœ¨æœªæ’åºçš„ bin ä¸­æ£€æŸ¥æ˜¯å¦ `unsorted_chunks(av)->fd->bk == unsorted_chunks(av)`ã€‚å¦åˆ™æŠ›å‡ºé”™è¯¯ï¼ˆ"malloc(): corrupted unsorted chunks 2"ï¼‰ã€‚
6. åœ¨è°ƒç”¨ `alloc_perturb` åè¿”å› `victim` å—ã€‚
9. å¦‚æœä»æœªæ‰¾åˆ°ç©ºçš„ binï¼Œåˆ™å°†ä½¿ç”¨ 'top' å—æ¥å¤„ç†è¯·æ±‚ï¼š
1. `victim` æŒ‡å‘ `av->top`ã€‚
2. å¦‚æœ 'top' å—çš„å¤§å° >= 'è¯·æ±‚çš„å¤§å°' + `MINSIZE`ï¼Œåˆ™å°†å…¶åˆ†æˆä¸¤ä¸ªå—ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå‰©ä½™å—æˆä¸ºæ–°çš„ 'top' å—ï¼Œå¹¶åœ¨è°ƒç”¨ `alloc_perturb` åå°†å¦ä¸€ä¸ªå—è¿”å›ç»™ç”¨æˆ·ã€‚
3. æŸ¥çœ‹ `av` æ˜¯å¦æœ‰ fastchunksã€‚é€šè¿‡æ£€æŸ¥ `av->flags` ä¸­çš„ `FASTCHUNKS_BIT` æ¥å®Œæˆã€‚å¦‚æœæ˜¯ï¼Œåˆ™åœ¨ `av` ä¸Šè°ƒç”¨ `malloc_consolidate`ã€‚è¿”å›åˆ°æ­¥éª¤ 6ï¼ˆæ£€æŸ¥æœªæ’åº binï¼‰ã€‚
4. å¦‚æœ `av` æ²¡æœ‰ fastchunksï¼Œåˆ™è°ƒç”¨ `sysmalloc` å¹¶åœ¨è°ƒç”¨ `alloc_perturb` åè¿”å›è·å¾—çš„æŒ‡é’ˆã€‚
## è‡ªç”±æµåŠ¨

{% hint style="success" %}
(æ­¤å½“å‰è§£é‡Šæ¥è‡ª[https://heap-exploitation.dhavalkapil.com/diving\_into\_glibc\_heap/core\_functions](https://heap-exploitation.dhavalkapil.com/diving_into_glibc_heap/core_functions). TODO: æ£€æŸ¥æœ€æ–°ç‰ˆæœ¬å¹¶æ›´æ–°)
{% endhint %}

é‡Šæ”¾å†…å­˜å—çš„æœ€ç»ˆå‡½æ•°æ˜¯ `_int_free (mstate av, mchunkptr p, int have_lock)`ï¼š

1. æ£€æŸ¥ `p` æ˜¯å¦åœ¨å†…å­˜ä¸­çš„ `p + chunksize(p)` ä¹‹å‰ï¼ˆé¿å…åŒ…è£…ï¼‰ã€‚å¦åˆ™ä¼šæŠ›å‡ºé”™è¯¯ (`free(): invalid pointer`)ã€‚
2. æ£€æŸ¥å†…å­˜å—çš„å¤§å°æ˜¯å¦è‡³å°‘ä¸º `MINSIZE` æˆ– `MALLOC_ALIGNMENT` çš„å€æ•°ã€‚å¦åˆ™ä¼šæŠ›å‡ºé”™è¯¯ (`free(): invalid size`)ã€‚
3. å¦‚æœå†…å­˜å—çš„å¤§å°åœ¨ fastbin åˆ—è¡¨ä¸­ï¼š
   1. æ£€æŸ¥ä¸‹ä¸€ä¸ªå†…å­˜å—çš„å¤§å°æ˜¯å¦åœ¨æœ€å°å’Œæœ€å¤§å¤§å° (`av->system_mem`) ä¹‹é—´ï¼Œå¦åˆ™æŠ›å‡ºé”™è¯¯ (`free(): invalid next size (fast)`)ã€‚
   2. å¯¹å†…å­˜å—è°ƒç”¨ `free_perturb`ã€‚
   3. ä¸º `av` è®¾ç½® `FASTCHUNKS_BIT`ã€‚
   4. æ ¹æ®å†…å­˜å—å¤§å°è·å– fastbin æ•°ç»„ä¸­çš„ç´¢å¼•ã€‚
   5. æ£€æŸ¥ bin é¡¶éƒ¨æ˜¯å¦ä¸æ˜¯æˆ‘ä»¬è¦æ·»åŠ çš„å†…å­˜å—ã€‚å¦åˆ™æŠ›å‡ºé”™è¯¯ (`double free or corruption (fasttop)`)ã€‚
   6. æ£€æŸ¥é¡¶éƒ¨çš„ fastbin å†…å­˜å—å¤§å°æ˜¯å¦ä¸æˆ‘ä»¬è¦æ·»åŠ çš„å†…å­˜å—å¤§å°ç›¸åŒã€‚å¦åˆ™æŠ›å‡ºé”™è¯¯ (`invalid fastbin entry (free)`)ã€‚
   7. å°†å†…å­˜å—æ’å…¥åˆ° fastbin åˆ—è¡¨çš„é¡¶éƒ¨å¹¶è¿”å›ã€‚
4. å¦‚æœå†…å­˜å—æœªè¢«æ˜ å°„ï¼š
   1. æ£€æŸ¥å†…å­˜å—æ˜¯å¦ä¸ºé¡¶éƒ¨å—ã€‚å¦‚æœæ˜¯ï¼Œåˆ™æŠ›å‡ºé”™è¯¯ (`double free or corruption (top)`)ã€‚
   2. æ£€æŸ¥ä¸‹ä¸€ä¸ªå†…å­˜å—ï¼ˆæŒ‰å†…å­˜ï¼‰æ˜¯å¦åœ¨åŒºåŸŸçš„è¾¹ç•Œå†…ã€‚å¦‚æœä¸æ˜¯ï¼Œåˆ™æŠ›å‡ºé”™è¯¯ (`double free or corruption (out)`)ã€‚
   3. æ£€æŸ¥ä¸‹ä¸€ä¸ªå†…å­˜å—ï¼ˆæŒ‰å†…å­˜ï¼‰çš„å‰ä¸€ä¸ªä½¿ç”¨ä½æ˜¯å¦æ ‡è®°ã€‚å¦‚æœæ²¡æœ‰ï¼Œåˆ™æŠ›å‡ºé”™è¯¯ (`double free or corruption (!prev)`)ã€‚
   4. æ£€æŸ¥ä¸‹ä¸€ä¸ªå†…å­˜å—çš„å¤§å°æ˜¯å¦åœ¨æœ€å°å’Œæœ€å¤§å¤§å° (`av->system_mem`) ä¹‹é—´ã€‚å¦‚æœä¸æ˜¯ï¼Œåˆ™æŠ›å‡ºé”™è¯¯ (`free(): invalid next size (normal)`)ã€‚
   5. å¯¹å†…å­˜å—è°ƒç”¨ `free_perturb`ã€‚
   6. å¦‚æœå‰ä¸€ä¸ªå†…å­˜å—ï¼ˆæŒ‰å†…å­˜ï¼‰æœªè¢«ä½¿ç”¨ï¼Œåˆ™å¯¹å‰ä¸€ä¸ªå†…å­˜å—è°ƒç”¨ `unlink`ã€‚
   7. å¦‚æœä¸‹ä¸€ä¸ªå†…å­˜å—ï¼ˆæŒ‰å†…å­˜ï¼‰ä¸æ˜¯é¡¶éƒ¨å—ï¼š
      1. å¦‚æœä¸‹ä¸€ä¸ªå†…å­˜å—æœªè¢«ä½¿ç”¨ï¼Œåˆ™å¯¹ä¸‹ä¸€ä¸ªå†…å­˜å—è°ƒç”¨ `unlink`ã€‚
      2. åˆå¹¶å‰ä¸€ä¸ªã€ä¸‹ä¸€ä¸ªå†…å­˜å—ï¼ˆæŒ‰å†…å­˜ï¼‰ä¸­çš„ç©ºé—²å—ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°æœªæ’åº bin çš„å¤´éƒ¨ã€‚åœ¨æ’å…¥ä¹‹å‰ï¼Œæ£€æŸ¥ `unsorted_chunks(av)->fd->bk == unsorted_chunks(av)` æ˜¯å¦æˆç«‹ã€‚å¦‚æœä¸æˆç«‹ï¼Œåˆ™æŠ›å‡ºé”™è¯¯ ("free(): corrupted unsorted chunks")ã€‚
   8. å¦‚æœä¸‹ä¸€ä¸ªå†…å­˜å—ï¼ˆæŒ‰å†…å­˜ï¼‰æ˜¯é¡¶éƒ¨å—ï¼Œåˆ™å°†å†…å­˜å—é€‚å½“åœ°åˆå¹¶ä¸ºå•ä¸ªé¡¶éƒ¨å—ã€‚
5. å¦‚æœå†…å­˜å—å·²è¢«æ˜ å°„ï¼Œåˆ™è°ƒç”¨ `munmap_chunk`ã€‚

## å †å‡½æ•°å®‰å…¨æ£€æŸ¥

æŸ¥çœ‹å †ä¸­å¸¸ç”¨å‡½æ•°æ‰§è¡Œçš„å®‰å…¨æ£€æŸ¥ï¼š

{% content-ref url="heap-functions-security-checks.md" %}
[heap-functions-security-checks.md](heap-functions-security-checks.md)
{% endcontent-ref %}

## å‚è€ƒèµ„æ–™

* [https://azeria-labs.com/heap-exploitation-part-1-understanding-the-glibc-heap-implementation/](https://azeria-labs.com/heap-exploitation-part-1-understanding-the-glibc-heap-implementation/)
* [https://azeria-labs.com/heap-exploitation-part-2-glibc-heap-free-bins/](https://azeria-labs.com/heap-exploitation-part-2-glibc-heap-free-bins/)
* [https://heap-exploitation.dhavalkapil.com/diving\_into\_glibc\_heap/core\_functions](https://heap-exploitation.dhavalkapil.com/diving_into_glibc_heap/core_functions)
