# Bins & Memory Allocations

<details>

<summary><strong>htARTE (HackTricks AWS Red Team ì „ë¬¸ê°€)ë¡œë¶€í„° AWS í•´í‚¹ì„ ì œë¡œë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ìš°ì„¸ìš”</strong></a><strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™œê·¸**](https://peass.creator-spring.com)ë¥¼ êµ¬ì…í•˜ì„¸ìš”
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ë‹¹ì‚¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
* **ğŸ’¬ [Discord ê·¸ë£¹](https://discord.gg/hRep4RUj7f)** ë˜ëŠ” [í…”ë ˆê·¸ë¨ ê·¸ë£¹](https://t.me/peass)ì— **ê°€ì…**í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **HackTricks** ë° **HackTricks Cloud** ê¹ƒí—ˆë¸Œ ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ **í•˜ì„¸ìš”.

</details>

## ê¸°ë³¸ ì •ë³´

ì²­í¬ê°€ ì €ì¥ë˜ëŠ” íš¨ìœ¨ì„±ì„ í–¥ìƒì‹œí‚¤ê¸° ìœ„í•´ ê° ì²­í¬ëŠ” í•˜ë‚˜ì˜ ì—°ê²°ëœ ëª©ë¡ì—ë§Œ ìˆì§€ ì•Šê³  ì—¬ëŸ¬ ìœ í˜•ì˜ binì´ ìˆìŠµë‹ˆë‹¤. ì´ë“¤ì€ binsì´ë©° 5 ì¢…ë¥˜ì˜ binsì´ ìˆìŠµë‹ˆë‹¤: [62](https://sourceware.org/git/gitweb.cgi?p=glibc.git;a=blob;f=malloc/malloc.c;h=6e766d11bc85b6480fa5c9f2a76559f8acf9deb5;hb=HEAD#l1407) small bins, 63 large bins, 1 unsorted bin, 10 fast bins, ê·¸ë¦¬ê³  ìŠ¤ë ˆë“œ ë‹¹ 64ê°œì˜ tcache binsì´ ìˆìŠµë‹ˆë‹¤.

ê° unsorted, small, large binsì˜ ì´ˆê¸° ì£¼ì†ŒëŠ” ë™ì¼í•œ ë°°ì—´ ë‚´ì— ìˆìŠµë‹ˆë‹¤. ì¸ë±ìŠ¤ 0ì€ ì‚¬ìš©ë˜ì§€ ì•Šìœ¼ë©°, 1ì€ unsorted binì´ê³ , 2-64ëŠ” small binsì´ë©°, 65-127ëŠ” large binsì…ë‹ˆë‹¤.

### Small Bins

Small binsì€ large binsë³´ë‹¤ ë¹ ë¥´ì§€ë§Œ fast binsë³´ë‹¤ ëŠë¦½ë‹ˆë‹¤.

62ê°œì˜ ê° binì€ **ë™ì¼í•œ í¬ê¸°ì˜ ì²­í¬**ë¥¼ ê°€ì§‘ë‹ˆë‹¤: 16, 24, ... (32ë¹„íŠ¸ ì‹œìŠ¤í…œì—ì„œ ìµœëŒ€ í¬ê¸°ëŠ” 504ë°”ì´íŠ¸ì´ë©°, 64ë¹„íŠ¸ ì‹œìŠ¤í…œì—ì„œëŠ” 1024ë°”ì´íŠ¸). ì´ëŠ” ê³µê°„ì„ í• ë‹¹í•  binì„ ì°¾ê³  ì´ëŸ¬í•œ ëª©ë¡ì— í•­ëª©ì„ ì‚½ì…í•˜ê³  ì œê±°í•˜ëŠ” ì†ë„ë¥¼ ë•ìŠµë‹ˆë‹¤.

### Large Bins

ê³ ì •ëœ í¬ê¸°ì˜ ì²­í¬ë¥¼ ê´€ë¦¬í•˜ëŠ” small binsê³¼ ë‹¬ë¦¬, **ê° large binì€ ì²­í¬ í¬ê¸° ë²”ìœ„ë¥¼ ì²˜ë¦¬**í•©ë‹ˆë‹¤. ì´ëŠ” ì‹œìŠ¤í…œì´ **ë‹¤ì–‘í•œ í¬ê¸°ë¥¼ ìˆ˜ìš©**í•  ìˆ˜ ìˆë„ë¡ í•˜ì—¬ ê° í¬ê¸°ì— ëŒ€í•´ ë³„ë„ì˜ binì´ í•„ìš”í•˜ì§€ ì•Šê²Œ í•©ë‹ˆë‹¤.

ë©”ëª¨ë¦¬ í• ë‹¹ê¸°ì—ì„œ large binsëŠ” small binsê°€ ëë‚˜ëŠ” ê³³ì—ì„œ ì‹œì‘í•©ë‹ˆë‹¤. large binsì˜ ë²”ìœ„ëŠ” ì ì§„ì ìœ¼ë¡œ ì»¤ì§€ë©°, ì²« ë²ˆì§¸ binì€ 512ì—ì„œ 576ë°”ì´íŠ¸ì˜ ì²­í¬ë¥¼ í¬í•¨í•˜ê³ , ë‹¤ìŒ binì€ 576ì—ì„œ 640ë°”ì´íŠ¸ì˜ ì²­í¬ë¥¼ í¬í•¨í•©ë‹ˆë‹¤. ì´ íŒ¨í„´ì€ ê³„ì†ë˜ë©°, ê°€ì¥ í° binì—ëŠ” 1MB ì´ìƒì˜ ëª¨ë“  ì²­í¬ê°€ í¬í•¨ë©ë‹ˆë‹¤.

Large binsëŠ” ì‘ì€ binsë³´ë‹¤ **ì²­í¬ í¬ê¸°ê°€ ë‹¤ì–‘í•œ ëª©ë¡ì„ ì •ë ¬í•˜ê³  ê²€ìƒ‰**í•´ì•¼ í•˜ê¸° ë•Œë¬¸ì— ì‘ì—… ì†ë„ê°€ ëŠë¦½ë‹ˆë‹¤. ì²­í¬ê°€ large binì— ì‚½ì…ë˜ë©´ ì •ë ¬ë˜ì–´ì•¼ í•˜ë©°, ë©”ëª¨ë¦¬ê°€ í• ë‹¹ë  ë•Œ ì‹œìŠ¤í…œì€ ì ì ˆí•œ ì²­í¬ë¥¼ ì°¾ì•„ì•¼ í•©ë‹ˆë‹¤. ì´ ì¶”ê°€ ì‘ì—…ìœ¼ë¡œ ì¸í•´ ì†ë„ê°€ **ëŠë ¤ì§€ì§€ë§Œ**, ëŒ€ë¶€ë¶„ì˜ ì‘ì€ í• ë‹¹ì´ ì‘ì€ ê²ƒë³´ë‹¤ ì ê¸° ë•Œë¬¸ì— í—ˆìš©í•  ìˆ˜ ìˆëŠ” êµí™˜ì…ë‹ˆë‹¤.

ë‹¤ìŒê³¼ ê°™ì€ large binsì´ ìˆìŠµë‹ˆë‹¤:

* 64B ë²”ìœ„ì˜ 32ê°œ bins
* 512B ë²”ìœ„ì˜ 16ê°œ bins
* 4096B ë²”ìœ„ì˜ 8ê°œ bins
* 32768B ë²”ìœ„ì˜ 4ê°œ bins
* 262144B ë²”ìœ„ì˜ 2ê°œ bins
* ë‚˜ë¨¸ì§€ í¬ê¸°ë¥¼ ìœ„í•œ 1ê°œ bins

### Unsorted bin

unsorted binì€ ë©”ëª¨ë¦¬ í• ë‹¹ì„ ë¹ ë¥´ê²Œ ë§Œë“¤ê¸° ìœ„í•´ í™ ê´€ë¦¬ìê°€ ì‚¬ìš©í•˜ëŠ” **ë¹ ë¥¸ ìºì‹œ**ì…ë‹ˆë‹¤. ì‘ë™ ë°©ì‹ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤: í”„ë¡œê·¸ë¨ì´ ë©”ëª¨ë¦¬ë¥¼ í•´ì œí•˜ë©´ í™ ê´€ë¦¬ìëŠ” ì¦‰ì‹œ íŠ¹ì • binì— ë„£ì§€ ì•ŠìŠµë‹ˆë‹¤. ëŒ€ì‹ , ì£¼ë³€ì˜ ë¹ˆ ì²­í¬ì™€ ë³‘í•©í•˜ì—¬ ë” í° ë¹ˆ ë©”ëª¨ë¦¬ ë¸”ë¡ì„ ë§Œë“­ë‹ˆë‹¤. ê·¸ëŸ° ë‹¤ìŒ,ì´ ìƒˆë¡œìš´ ì²­í¬ë¥¼ "unsorted bin"ì´ë¼ê³  ë¶ˆë¦¬ëŠ” ì¼ë°˜ binì— ë°°ì¹˜í•©ë‹ˆë‹¤.

í”„ë¡œê·¸ë¨ì´ **ë©”ëª¨ë¦¬ë¥¼ ìš”ì²­**í•˜ë©´ í™ ê´€ë¦¬ìëŠ” unsorted binì„ **ê²€ì‚¬í•˜ì—¬ ì¶©ë¶„í•œ í¬ê¸°ì˜ ì²­í¬ê°€ ìˆëŠ”ì§€ í™•ì¸**í•©ë‹ˆë‹¤. ì í•©í•œ ì²­í¬ë¥¼ ì°¾ìœ¼ë©´ ì¦‰ì‹œ ì‚¬ìš©í•©ë‹ˆë‹¤. ì í•©í•œ ì²­í¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìœ¼ë©´ í•´ì œëœ ì²­í¬ë¥¼ í•´ë‹¹ í¬ê¸°ì— ë”°ë¼ ì‘ì€ bins ë˜ëŠ” large binsë¡œ ì´ë™í•©ë‹ˆë‹¤.

ë”°ë¼ì„œ unsorted binì€ ìµœê·¼ì— í•´ì œëœ ë©”ëª¨ë¦¬ë¥¼ ë¹ ë¥´ê²Œ ì¬ì‚¬ìš©í•˜ì—¬ ë©”ëª¨ë¦¬ í• ë‹¹ì„ ê°€ì†í™”í•˜ê³  ì‹œê°„ ì†Œëª¨ì ì¸ ê²€ìƒ‰ ë° ë³‘í•©ì„ ì¤„ì´ëŠ” ë°©ë²•ì…ë‹ˆë‹¤.

{% hint style="danger" %}
ë‹¤ë¥¸ ì¹´í…Œê³ ë¦¬ì˜ ì²­í¬ì´ë”ë¼ë„ ì‚¬ìš© ê°€ëŠ¥í•œ ì²­í¬ê°€ ì¶©ëŒí•˜ëŠ” ê²½ìš° ë³‘í•©ë©ë‹ˆë‹¤.
{% endhint %}

### Fast bins

Fast binsì€ ìµœê·¼ì— í•´ì œëœ ì²­í¬ë¥¼ ë¹ ë¥´ê²Œ ì•¡ì„¸ìŠ¤í•˜ëŠ” êµ¬ì¡°ì— ìœ ì§€í•˜ì—¬ ì‘ì€ ì²­í¬ì— ëŒ€í•œ ë©”ëª¨ë¦¬ í• ë‹¹ì„ ê°€ì†í™”í•˜ê¸° ìœ„í•´ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ëŸ¬í•œ binsì€ í›„ì…ì„ ì¶œ (LIFO) ì ‘ê·¼ ë°©ì‹ì„ ì‚¬ìš©í•˜ì—¬, ìƒˆë¡œìš´ í• ë‹¹ ìš”ì²­ì´ ìˆì„ ë•Œ **ê°€ì¥ ìµœê·¼ì— í•´ì œëœ ì²­í¬ê°€ ë¨¼ì €** ì¬ì‚¬ìš©ë©ë‹ˆë‹¤. ì´ ë™ì‘ì€ ì†ë„ ì¸¡ë©´ì—ì„œ ìœ ë¦¬í•©ë‹ˆë‹¤. LIFO ìŠ¤íƒì˜ ë§¨ ìœ„ì—ì„œ ì‚½ì… ë° ì œê±°í•˜ëŠ” ê²ƒì´ í (FIFO)ë³´ë‹¤ ë¹ ë¦…ë‹ˆë‹¤.

ë˜í•œ, **fast binsì€ ë‹¨ì¼ ì—°ê²° ëª©ë¡**ì„ ì‚¬ìš©í•˜ë©° ì´ëŠ” ì†ë„ë¥¼ ë” í–¥ìƒì‹œí‚µë‹ˆë‹¤. fast binsì˜ ì²­í¬ëŠ” ì´ì›ƒê³¼ ë³‘í•©ë˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ì¤‘ê°„ì—ì„œ ì œê±°ë¥¼ í—ˆìš©í•˜ëŠ” ë³µì¡í•œ êµ¬ì¡°ê°€ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¨ì¼ ì—°ê²° ëª©ë¡ì€ ì´ëŸ¬í•œ ì‘ì—…ì— ëŒ€í•´ ë” ê°„ë‹¨í•˜ê³  ë¹ ë¦…ë‹ˆë‹¤.

ê¸°ë³¸ì ìœ¼ë¡œ ì—¬ê¸°ì„œ ë°œìƒí•˜ëŠ” ì¼ì€ í—¤ë”(ì‚¬ìš©í•  ì²« ë²ˆì§¸ ì²­í¬ë¥¼ ê°€ë¦¬í‚¤ëŠ” í¬ì¸í„°)ê°€ í•­ìƒ í•´ë‹¹ í¬ê¸°ì˜ ìµœì‹  í•´ì œëœ ì²­í¬ë¥¼ ê°€ë¦¬í‚¤ë„ë¡ í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ë”°ë¼ì„œ:

* í•´ë‹¹ í¬ê¸°ì˜ ìƒˆë¡œìš´ ì²­í¬ê°€ í• ë‹¹ë˜ë©´ í—¤ë”ëŠ” ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë¹ˆ ì²­í¬ë¥¼ ê°€ë¦¬í‚µë‹ˆë‹¤. ì´ ë¹ˆ ì²­í¬ê°€ ì‚¬ìš©í•  ë‹¤ìŒ ì²­í¬ë¥¼ ê°€ë¦¬í‚¤ê³  ìˆìœ¼ë¯€ë¡œ ì´ ì£¼ì†ŒëŠ” í—¤ë”ì— ì €ì¥ë˜ì–´ ë‹¤ìŒ í• ë‹¹ì´ ì–´ë””ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ì²­í¬ë¥¼ ê°€ì ¸ì˜¬ì§€ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* ì²­í¬ê°€ í•´ì œë˜ë©´ ë¹ˆ ì²­í¬ëŠ” í˜„ì¬ ì‚¬ìš© ê°€ëŠ¥í•œ ì²­í¬ì˜ ì£¼ì†Œë¥¼ ì €ì¥í•˜ê³  ì´ ìƒˆë¡œ í•´ì œëœ ì²­í¬ì˜ ì£¼ì†Œê°€ í—¤ë”ì— ì €ì¥ë©ë‹ˆë‹¤.

{% hint style="danger" %}
fast binsì˜ ì²­í¬ëŠ” ìë™ìœ¼ë¡œ ì‚¬ìš© ê°€ëŠ¥í•œ ìƒíƒœë¡œ ì„¤ì •ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ ë‹¤ë¥¸ ì²­í¬ì™€ ë³‘í•©í•  ìˆ˜ ìˆëŠ” ëŒ€ì‹  ì–´ëŠ ì •ë„ì˜ ì‹œê°„ ë™ì•ˆ fast bin ì²­í¬ë¡œ ìœ ì§€ë©ë‹ˆë‹¤.
{% endhint %}

### Tcache (ìŠ¤ë ˆë“œë³„ ìºì‹œ) Bins

ìŠ¤ë ˆë“œê°€ ìì²´ í™ì„ ê°€ì§€ë ¤ê³  ë…¸ë ¥í•˜ë”ë¼ë„ (Arenas](bins-and-memory-allocations.md#arenas) ë° [Subheaps](bins-and-memory-allocations.md#subheaps) ì°¸ì¡°), ë§ì€ ìŠ¤ë ˆë“œ(ì˜ˆ: ì›¹ ì„œë²„)ë¥¼ ê°€ì§„ í”„ë¡œì„¸ìŠ¤ê°€ ë‹¤ë¥¸ ìŠ¤ë ˆë“œì™€ í™ì„ ê³µìœ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ê²½ìš°, ì£¼ìš” ì†”ë£¨ì…˜ì€ **ë½**ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ë©°, ì´ëŠ” **ìŠ¤ë ˆë“œì˜ ì†ë„ë¥¼ ìƒë‹¹íˆ ëŠ¦ì¶œ ìˆ˜ ìˆìŠµë‹ˆë‹¤**.

ë”°ë¼ì„œ tcacheëŠ” ê° ìŠ¤ë ˆë“œ ë‹¹ fast binê³¼ ìœ ì‚¬í•œ ë°©ì‹ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤. ì´ëŠ” ë³‘í•©ëœ ì²­í¬ë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” **ë‹¨ì¼ ì—°ê²° ëª©ë¡**ì…ë‹ˆë‹¤. ê° ìŠ¤ë ˆë“œì—ëŠ” **64ê°œì˜ ë‹¨ì¼ ì—°ê²° tcache bins**ê°€ ìˆìŠµë‹ˆë‹¤. ê° binì€ [64ë¹„íŠ¸ ì‹œìŠ¤í…œì—ì„œ 24ì—ì„œ 1032B, 32ë¹„íŠ¸ ì‹œìŠ¤í…œì—ì„œ 12ì—ì„œ 516B](https://sourceware.org/git/?p=glibc.git;a=blob;f=malloc/malloc.c;h=2527e2504761744df2bdb1abdc02d936ff907ad2;hb=d5c3fafc4307c9b7a4c7d5cb381fcdbfad340bcc#l315) ë²”ìœ„ì˜ ìµœëŒ€ [7ê°œì˜ ë™ì¼í•œ í¬ê¸° ì²­í¬](https://sourceware.org/git/?p=glibc.git;a=blob;f=malloc/malloc.c;h=2527e2504761744df2bdb1abdc02d936ff907ad2;hb=d5c3fafc4307c9b7a4c7d5cb381fcdbfad340bcc#l323)ë¥¼ ê°€ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**ìŠ¤ë ˆë“œê°€ ì²­í¬ë¥¼ í•´ì œ**í•˜ë©´, **tcacheì— í• ë‹¹í•  í¬ê¸°ê°€ ë„ˆë¬´ í¬ì§€ ì•Šê³ ** í•´ë‹¹ tcache bin **ì´ë¯¸ ê°€ë“ ì°¨ì§€ ì•Šì•˜ë‹¤ë©´**, **í•´ë‹¹ tcacheì— í• ë‹¹**ë©ë‹ˆë‹¤. tcacheë¡œ ì´ë™í•  ìˆ˜ ì—†ëŠ” ê²½ìš° ì „ì—­ binsì—ì„œ ì°¾ê±°ë‚˜ ìƒˆë¡œìš´ ê²ƒì„ ë§Œë“¤ê¸° ìœ„í•´ í™ ë½ì„ ê¸°ë‹¤ë ¤ì•¼ í•©ë‹ˆë‹¤.\
**ì²­í¬ê°€ í• ë‹¹**ë  ë•Œ, **Tcacheì— í•„ìš”í•œ í¬ê¸°ì˜ ë¹ˆ ì²­í¬ê°€ ìˆëŠ” ê²½ìš° ì‚¬ìš©**í•˜ê³ , ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì „ì—­ binsì—ì„œ ì°¾ê±°ë‚˜ ìƒˆë¡œìš´ ê²ƒì„ ë§Œë“¤ê¸° ìœ„í•´ í™ ë½ì„ ê¸°ë‹¤ë ¤ì•¼ í•©ë‹ˆë‹¤.\
ë˜í•œ ìµœì í™”ê°€ ìˆìœ¼ë©°, ì´ ê²½ìš° í™ ë½ì„ ì‚¬ìš©í•˜ëŠ” ë™ì•ˆ ìŠ¤ë ˆë“œëŠ” ìš”ì²­ëœ í¬ê¸°ì˜ í™ ì²­í¬(7ê°œ)ë¡œ Tcacheë¥¼ ì±„ìš°ë¯€ë¡œ í•„ìš”í•œ ê²½ìš° Tcacheì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
## í• ë‹¹ íë¦„

{% hint style="success" %}
(í˜„ì¬ ì„¤ëª…ì€ [https://heap-exploitation.dhavalkapil.com/diving\_into\_glibc\_heap/core\_functions](https://heap-exploitation.dhavalkapil.com/diving\_into\_glibc\_heap/core\_functions)ì—ì„œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤. TODO: ìµœì‹  ë²„ì „ì„ í™•ì¸í•˜ê³  ì—…ë°ì´íŠ¸í•˜ì„¸ìš”)
{% endhint %}

í• ë‹¹ì€ ìµœì¢…ì ìœ¼ë¡œ í•¨ìˆ˜ `void * _int_malloc (mstate av, size_t bytes)`ë¥¼ ì‚¬ìš©í•˜ì—¬ ìˆ˜í–‰ë˜ë©° ë‹¤ìŒê³¼ ê°™ì€ ìˆœì„œë¡œ ì§„í–‰ë©ë‹ˆë‹¤:

1. **ì •ë ¬** ë“±ì„ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ `bytes`ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
2. `av`ê°€ **NULL**ì¸ì§€ ì—¬ë¶€ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
3. **ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ë ˆë‚˜**ê°€ ì—†ëŠ” ê²½ìš° (`av`ê°€ NULLì¸ ê²½ìš°), mmapì„ ì‚¬ìš©í•˜ì—¬ ì²­í¬ë¥¼ ì–»ê¸° ìœ„í•´ `sysmalloc`ì„ í˜¸ì¶œí•©ë‹ˆë‹¤. ì„±ê³µí•˜ë©´ `alloc_perturb`ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤. í¬ì¸í„°ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
4. í¬ê¸°ì— ë”°ë¼:
* \[ì›ë³¸ì— ì¶”ê°€] ë‹¤ìŒ fastbinì„ í™•ì¸í•˜ê¸° ì „ì— tcacheë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
* \[ì›ë³¸ì— ì¶”ê°€] tcacheê°€ ì—†ì§€ë§Œ ë‹¤ë¥¸ binì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš° (ë‚˜ì¤‘ì— ì„¤ëª…), í•´ë‹¹ binì—ì„œ tcacheë¥¼ ì±„ìš°ë ¤ê³  ì‹œë„í•©ë‹ˆë‹¤.
* í¬ê¸°ê°€ **fastbin** ë²”ìœ„ì— ì†í•˜ëŠ” ê²½ìš°:&#x20;
1. ìš”ì²­ í¬ê¸°ì— ë”°ë¼ ì ì ˆí•œ binì— ì•¡ì„¸ìŠ¤í•˜ê¸° ìœ„í•´ fastbin ë°°ì—´ì— ì¸ë±ìŠ¤ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.&#x20;
2. í•´ë‹¹ binì—ì„œ ì²« ë²ˆì§¸ ì²­í¬ë¥¼ ì œê±°í•˜ê³  `victim`ì„ í•´ë‹¹ ì²­í¬ë¥¼ ê°€ë¦¬í‚¤ë„ë¡ ë§Œë“­ë‹ˆë‹¤.
3. `victim`ì´ NULLì¸ ê²½ìš° ë‹¤ìŒ ê²½ìš°ë¡œ ì´ë™í•©ë‹ˆë‹¤ (smallbin).
4. `victim`ì´ NULLì´ ì•„ë‹Œ ê²½ìš° ì²­í¬ì˜ í¬ê¸°ë¥¼ í™•ì¸í•˜ì—¬ í•´ë‹¹ íŠ¹ì • binì— ì†í•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì˜¤ë¥˜("malloc(): memory corruption (fast)")ê°€ ë°œìƒí•©ë‹ˆë‹¤.
5. `alloc_perturb`ë¥¼ í˜¸ì¶œí•œ ë‹¤ìŒ í¬ì¸í„°ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
* í¬ê¸°ê°€ **smallbin** ë²”ìœ„ì— ì†í•˜ëŠ” ê²½ìš°:
1. ìš”ì²­ í¬ê¸°ì— ë”°ë¼ ì ì ˆí•œ binì— ì•¡ì„¸ìŠ¤í•˜ê¸° ìœ„í•´ smallbin ë°°ì—´ì— ì¸ë±ìŠ¤ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
2. ì´ binì— ì²­í¬ê°€ ì—†ëŠ” ê²½ìš° ë‹¤ìŒ ê²½ìš°ë¡œ ì´ë™í•©ë‹ˆë‹¤. ì´ëŠ” í¬ì¸í„° `bin`ê³¼ `bin->bk`ë¥¼ ë¹„êµí•˜ì—¬ í™•ì¸ë©ë‹ˆë‹¤.
3. `victim`ì€ `bin->bk` (binì˜ ë§ˆì§€ë§‰ ì²­í¬)ë¡œ ë§Œë“­ë‹ˆë‹¤. ì´ ê°’ì´ NULLì¸ ê²½ìš° (`ì´ˆê¸°í™”` ì¤‘ì— ë°œìƒ), `malloc_consolidate`ë¥¼ í˜¸ì¶œí•˜ê³  ë‹¤ë¥¸ binì„ í™•ì¸í•˜ëŠ” ì´ ë‹¨ê³„ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.
4. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´, `victim`ì´ NULLì´ ì•„ë‹Œ ê²½ìš° `victim->bk->fd`ì™€ `victim`ì´ ë™ì¼í•œì§€ í™•ì¸í•©ë‹ˆë‹¤. ë™ì¼í•˜ì§€ ì•Šìœ¼ë©´ ì˜¤ë¥˜(`malloc(): smallbin double linked list corrupted`)ê°€ ë°œìƒí•©ë‹ˆë‹¤.
5. `victim`ì— ëŒ€í•´ ë‹¤ìŒ ì²­í¬ì— ëŒ€í•´ PREV\_INSUSE ë¹„íŠ¸ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤ (`victim`ì´ ì´ì¤‘ ì—°ê²° ëª©ë¡ì´ ì•„ë‹Œ ë©”ëª¨ë¦¬ì—ì„œ).
6. ì´ ì²­í¬ë¥¼ bin ëª©ë¡ì—ì„œ ì œê±°í•©ë‹ˆë‹¤.
7. `av`ì— ë”°ë¼ ì´ ì²­í¬ì— ëŒ€í•œ ì ì ˆí•œ ì•„ë ˆë‚˜ ë¹„íŠ¸ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
8. `alloc_perturb`ë¥¼ í˜¸ì¶œí•œ ë‹¤ìŒ í¬ì¸í„°ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
* í¬ê¸°ê°€ smallbin ë²”ìœ„ì— ì†í•˜ì§€ ì•ŠëŠ” ê²½ìš°:
1. ìš”ì²­ í¬ê¸°ì— ë”°ë¼ ì ì ˆí•œ binì— ì•¡ì„¸ìŠ¤í•˜ê¸° ìœ„í•´ largebin ë°°ì—´ì— ì¸ë±ìŠ¤ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
2. `av`ì— fastchunksê°€ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤. ì´ëŠ” `av->flags`ì—ì„œ `FASTCHUNKS_BIT`ë¥¼ í™•ì¸í•˜ì—¬ ìˆ˜í–‰ë©ë‹ˆë‹¤. ê·¸ë ‡ë‹¤ë©´ `av`ì—ì„œ `malloc_consolidate`ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
5. ì•„ì§ í¬ì¸í„°ê°€ ë°˜í™˜ë˜ì§€ ì•Šì€ ê²½ìš° í•˜ë‚˜ ì´ìƒì˜ ë‹¤ìŒ ê²½ìš° ì¤‘ í•˜ë‚˜ ì´ìƒì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤:
1. í¬ê¸°ê°€ 'fastbin' ë²”ìœ„ì— ì†í•˜ì§€ë§Œ fastchunkê°€ ì—†ëŠ” ê²½ìš°.
2. í¬ê¸°ê°€ 'smallbin' ë²”ìœ„ì— ì†í•˜ì§€ë§Œ smallchunkê°€ ì—†ëŠ” ê²½ìš° (`ì´ˆê¸°í™”` ì¤‘ì— `malloc_consolidate`ë¥¼ í˜¸ì¶œ).
3. í¬ê¸°ê°€ 'largbin' ë²”ìœ„ì— ì†í•˜ëŠ” ê²½ìš°.
6. ë‹¤ìŒìœ¼ë¡œ **ì •ë ¬ë˜ì§€ ì•Šì€ ì²­í¬**ë¥¼ í™•ì¸í•˜ê³  ìˆœíšŒëœ ì²­í¬ë¥¼ binì— ë°°ì¹˜í•©ë‹ˆë‹¤. ì—¬ê¸°ì„œë§Œ ì²­í¬ê°€ binì— ë°°ì¹˜ë©ë‹ˆë‹¤. 'TAIL'ì—ì„œ ì •ë ¬ë˜ì§€ ì•Šì€ binì„ ë°˜ë³µí•©ë‹ˆë‹¤.
1. `victim`ì€ ê³ ë ¤ ì¤‘ì¸ í˜„ì¬ ì²­í¬ë¥¼ ê°€ë¦¬í‚µë‹ˆë‹¤.
2. `victim`ì˜ ì²­í¬ í¬ê¸°ê°€ ìµœì†Œ (`2*SIZE_SZ`) ë° ìµœëŒ€ (`av->system_mem`) ë²”ìœ„ ë‚´ì— ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì˜¤ë¥˜(`malloc(): memory corruption`)ê°€ ë°œìƒí•©ë‹ˆë‹¤.
3. (ìš”ì²­ëœ ì²­í¬ì˜ í¬ê¸°ê°€ smallbin ë²”ìœ„ì— ì†í•˜ê³ ) (`victim`ì´ ë§ˆì§€ë§‰ ë‚˜ë¨¸ì§€ ì²­í¬ì´ê³ ) (ì •ë ¬ë˜ì§€ ì•Šì€ binì— ìˆëŠ” ìœ ì¼í•œ ì²­í¬ì´ê³ ) (ì²­í¬ í¬ê¸° >= ìš”ì²­ëœ í¬ê¸°ì¸ ê²½ìš°): **ì²­í¬ë¥¼ 2ê°œë¡œ ë¶„í• **í•©ë‹ˆë‹¤:
* ì²« ë²ˆì§¸ ì²­í¬ëŠ” ìš”ì²­ëœ í¬ê¸°ì™€ ì¼ì¹˜í•˜ë©° ë°˜í™˜ë©ë‹ˆë‹¤.
* ë‚¨ì€ ì²­í¬ëŠ” ìƒˆë¡œìš´ ë§ˆì§€ë§‰ ë‚˜ë¨¸ì§€ ì²­í¬ê°€ ë©ë‹ˆë‹¤. ì´ê²ƒì€ ì •ë ¬ë˜ì§€ ì•Šì€ binì— ë‹¤ì‹œ ì‚½ì…ë©ë‹ˆë‹¤.
1. ë‘ ì²­í¬ì— ëŒ€í•´ `chunk_size` ë° `chunk_prev_size` í•„ë“œë¥¼ ì ì ˆí•˜ê²Œ ì„¤ì •í•©ë‹ˆë‹¤.
2. `alloc_perturb`ë¥¼ í˜¸ì¶œí•œ ë‹¤ìŒ ì²« ë²ˆì§¸ ì²­í¬ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
3. ìœ„ì˜ ì¡°ê±´ì´ ê±°ì§“ì¸ ê²½ìš° ì—¬ê¸°ì— ë„ë‹¬í•©ë‹ˆë‹¤. `victim`ì„ ì •ë ¬ë˜ì§€ ì•Šì€ binì—ì„œ ì œê±°í•©ë‹ˆë‹¤. `victim`ì˜ í¬ê¸°ê°€ ì •í™•íˆ ìš”ì²­ëœ í¬ê¸°ì™€ ì¼ì¹˜í•˜ëŠ” ê²½ìš° `alloc_perturb`ë¥¼ í˜¸ì¶œí•œ í›„ ì´ ì²­í¬ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
4. `victim`ì˜ í¬ê¸°ê°€ smallbin ë²”ìœ„ì— ì†í•˜ëŠ” ê²½ìš° í•´ë‹¹ ì²­í¬ë¥¼ ì ì ˆí•œ smallbinì— `HEAD`ì— ì¶”ê°€í•©ë‹ˆë‹¤.
5. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì ì ˆí•œ largebinì— ì‚½ì…í•˜ë©´ì„œ ì •ë ¬ëœ ìˆœì„œë¥¼ ìœ ì§€í•©ë‹ˆë‹¤:
6. ë§ˆì§€ë§‰ ì²­í¬(ê°€ì¥ ì‘ì€)ë¥¼ ë¨¼ì € í™•ì¸í•©ë‹ˆë‹¤. `victim`ì´ ë§ˆì§€ë§‰ ì²­í¬ë³´ë‹¤ ì‘ìœ¼ë©´ ë§ˆì§€ë§‰ì— ì‚½ì…í•©ë‹ˆë‹¤.
7. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ `victim`ì˜ í¬ê¸°ë³´ë‹¤ í¬ê¸°ê°€ ê°™ê±°ë‚˜ í° ì²­í¬ë¥¼ ì°¾ê¸° ìœ„í•´ ë£¨í”„ë¥¼ ë°˜ë³µí•©ë‹ˆë‹¤. í¬ê¸°ê°€ ì •í™•íˆ ê°™ì€ ê²½ìš° í•­ìƒ ë‘ ë²ˆì§¸ ìœ„ì¹˜ì— ì‚½ì…í•©ë‹ˆë‹¤.
8. ì´ëŸ¬í•œ ë‹¨ê³„ë¥¼ ìµœëŒ€ `MAX_ITERS` (10000)ë²ˆ ë°˜ë³µí•˜ê±°ë‚˜ ì •ë ¬ë˜ì§€ ì•Šì€ binì˜ ëª¨ë“  ì²­í¬ê°€ ì†Œì§„ë  ë•Œê¹Œì§€ ë°˜ë³µí•©ë‹ˆë‹¤.
7. ì •ë ¬ë˜ì§€ ì•Šì€ ì²­í¬ë¥¼ í™•ì¸í•œ í›„ ìš”ì²­ëœ í¬ê¸°ê°€ smallbin ë²”ìœ„ì— ì†í•˜ì§€ ì•Šìœ¼ë©´ **largebins**ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
1. ìš”ì²­ëœ í¬ê¸°ì— ë”°ë¼ ì ì ˆí•œ binì— ì•¡ì„¸ìŠ¤í•˜ê¸° ìœ„í•´ largebin ë°°ì—´ì— ì¸ë±ìŠ¤ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
2. ì²­í¬ì˜ í¬ê¸°(ì²« ë²ˆì§¸ ì²­í¬)ê°€ ìš”ì²­ëœ í¬ê¸°ë³´ë‹¤ í° ê²½ìš°:
1. 'TAIL'ì—ì„œ ì‹œì‘í•˜ì—¬ ìš”ì²­ëœ í¬ê¸°ë³´ë‹¤ í¬ê±°ë‚˜ ê°™ì€ í¬ê¸°ì˜ ì²­í¬(`victim`)ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
2. `unlink`ë¥¼ í˜¸ì¶œí•˜ì—¬ binì—ì„œ `victim` ì²­í¬ë¥¼ ì œê±°í•©ë‹ˆë‹¤.
3. `victim`ì˜ ì²­í¬ì— ëŒ€í•œ `remainder_size`ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤(ì´ëŠ” `victim`ì˜ ì²­í¬ í¬ê¸° - ìš”ì²­ëœ í¬ê¸°ê°€ ë©ë‹ˆë‹¤).
4. ì´ `remainder_size`ê°€ `MINSIZE` (í—¤ë”ë¥¼ í¬í•¨í•œ ìµœì†Œ ì²­í¬ í¬ê¸°)ë³´ë‹¤ í¬ë©´ ì²­í¬ë¥¼ ë‘ ê°œë¡œ ë¶„í• í•©ë‹ˆë‹¤. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì „ì²´ `victim` ì²­í¬ê°€ ë°˜í™˜ë©ë‹ˆë‹¤. ë‚˜ë¨¸ì§€ ì²­í¬ë¥¼ ì •ë ¬ë˜ì§€ ì•Šì€ binì— ì‚½ì…í•©ë‹ˆë‹¤('TAIL' ë). ì •ë ¬ë˜ì§€ ì•Šì€ binì—ì„œ `unsorted_chunks(av)->fd->bk == unsorted_chunks(av)`ë¥¼ í™•ì¸í•©ë‹ˆë‹¤. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì˜¤ë¥˜ê°€ ë°œìƒí•©ë‹ˆë‹¤("malloc(): corrupted unsorted chunks").
5. `victim` ì²­í¬ë¥¼ `alloc_perturb`ë¥¼ í˜¸ì¶œí•œ í›„ ë°˜í™˜í•©ë‹ˆë‹¤.
8. ì§€ê¸ˆê¹Œì§€ ì •ë ¬ë˜ì§€ ì•Šì€ binê³¼ í•´ë‹¹ fast, small ë˜ëŠ” large binì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤. ìš”ì²­ëœ ì²­í¬ì˜ **ì •í™•í•œ** í¬ê¸°ë¥¼ ì‚¬ìš©í•˜ì—¬ ë‹¨ì¼ bin(fast ë˜ëŠ” small)ì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤. ëª¨ë“  binì´ ì†Œì§„ë  ë•Œê¹Œì§€ ë‹¤ìŒ ë‹¨ê³„ë¥¼ ë°˜ë³µí•©ë‹ˆë‹¤:
1. bin ë°°ì—´ì— ëŒ€í•œ ì¸ë±ìŠ¤ë¥¼ ì¦ê°€ì‹œì¼œ ë‹¤ìŒ binì„ í™•ì¸í•©ë‹ˆë‹¤.
2. ë¹ˆ binì„ ê±´ë„ˆë›°ê¸° ìœ„í•´ `av->binmap` ë§µì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
3. `victim`ì€ í˜„ì¬ binì˜ 'TAIL'ì„ ê°€ë¦¬í‚µë‹ˆë‹¤.
4. binmapì„ ì‚¬ìš©í•˜ë©´ binì´ ê±´ë„ˆë›°ì–´ì§„ ê²½ìš°(ìœ„ì˜ 2ë²ˆì§¸ ë‹¨ê³„ì—ì„œ), í•´ë‹¹ binì´ í™•ì‹¤íˆ ë¹„ì–´ ìˆëŠ” ê²ƒì„ ë³´ì¥í•©ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ëª¨ë“  ë¹ˆ binì´ ê±´ë„ˆë›°ì–´ì§€ëŠ” ê²ƒì„ ë³´ì¥í•˜ì§€ëŠ” ì•ŠìŠµë‹ˆë‹¤. `victim`ì´ ë¹„ì–´ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤. ë¹„ì–´ ìˆìœ¼ë©´ ë‹¤ì‹œ binì„ ê±´ë„ˆë›°ê³  ìœ„ì˜ í”„ë¡œì„¸ìŠ¤ë¥¼ ë°˜ë³µí•˜ê±°ë‚˜ ì´ ë£¨í”„ë¥¼ 'ê³„ì†'í•©ë‹ˆë‹¤. ë¹„ì–´ ìˆì§€ ì•Šì€ binì— ë„ë‹¬í•  ë•Œê¹Œì§€ ë°˜ë³µí•©ë‹ˆë‹¤.
5. ì²­í¬ë¥¼ ë¶„í• í•©ë‹ˆë‹¤(`victim`ì€ ë¹„ì–´ ìˆì§€ ì•Šì€ binì˜ ë§ˆì§€ë§‰ ì²­í¬ë¥¼ ê°€ë¦¬í‚µë‹ˆë‹¤). ë‚˜ë¨¸ì§€ ì²­í¬ë¥¼ ì •ë ¬ë˜ì§€ ì•Šì€ binì— ì‚½ì…í•©ë‹ˆë‹¤('TAIL'ì—). ì •ë ¬ë˜ì§€ ì•Šì€ binì—ì„œ `unsorted_chunks(av)->fd->bk == unsorted_chunks(av)`ë¥¼ í™•ì¸í•©ë‹ˆë‹¤. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì˜¤ë¥˜ê°€ ë°œìƒí•©ë‹ˆë‹¤("malloc(): corrupted unsorted chunks 2").
6. `victim` ì²­í¬ë¥¼ `alloc_perturb`ë¥¼ í˜¸ì¶œí•œ í›„ ë°˜í™˜í•©ë‹ˆë‹¤.
9. ì—¬ì „íˆ ë¹ˆ binì„ ì°¾ì„ ìˆ˜ ì—†ëŠ” ê²½ìš° 'top' ì²­í¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ìš”ì²­ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤:
1. `victim`ì€ `av->top`ì„ ê°€ë¦¬í‚µë‹ˆë‹¤.
2. 'top' ì²­í¬ì˜ í¬ê¸°ê°€ 'ìš”ì²­ëœ í¬ê¸°' + `MINSIZE`ë³´ë‹¤ í° ê²½ìš°, ë‘ ê°œì˜ ì²­í¬ë¡œ ë¶„í• í•©ë‹ˆë‹¤. ì´ ê²½ìš°, ë‚˜ë¨¸ì§€ ì²­í¬ê°€ ìƒˆ 'top' ì²­í¬ê°€ ë˜ê³  ë‹¤ë¥¸ ì²­í¬ëŠ” `alloc_perturb`ë¥¼ í˜¸ì¶œí•œ í›„ ì‚¬ìš©ìì—ê²Œ ë°˜í™˜ë©ë‹ˆë‹¤.
3. `av`ì— fastchunksê°€ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤. ì´ëŠ” `av->flags`ì—ì„œ `FASTCHUNKS_BIT`ë¥¼ í™•ì¸í•˜ì—¬ ìˆ˜í–‰ë©ë‹ˆë‹¤. ê·¸ë ‡ë‹¤ë©´ `av`ì—ì„œ `malloc_consolidate`ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤. ë‹¨ê³„ 6(ì •ë ¬ë˜ì§€ ì•Šì€ binì„ í™•ì¸í•˜ëŠ” ë‹¨ê³„)ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.
4. `av`ì— fastchunksê°€ ì—†ëŠ” ê²½ìš°, `sysmalloc`ì„ í˜¸ì¶œí•˜ê³  `alloc_perturb`ë¥¼ í˜¸ì¶œí•œ í›„ ì–»ì€ í¬ì¸í„°ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
## ììœ  íë¦„

{% hint style="success" %}
(í˜„ì¬ ì„¤ëª…ì€ [https://heap-exploitation.dhavalkapil.com/diving\_into\_glibc\_heap/core\_functions](https://heap-exploitation.dhavalkapil.com/diving\_into\_glibc\_heap/core\_functions)ì—ì„œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤. TODO: ìµœì‹  ë²„ì „ì„ í™•ì¸í•˜ê³  ì—…ë°ì´íŠ¸í•˜ì‹­ì‹œì˜¤)
{% endhint %}

ë©”ëª¨ë¦¬ ì¡°ê°ì„ í•´ì œí•˜ëŠ” ìµœì¢… í•¨ìˆ˜ëŠ” `_int_free (mstate av, mchunkptr p, int have_lock)` ì…ë‹ˆë‹¤:

1. `p`ê°€ ë©”ëª¨ë¦¬ì—ì„œ `p + chunksize(p)`ë³´ë‹¤ ì•ì— ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤ (wrapì„ í”¼í•˜ê¸° ìœ„í•¨). ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì˜¤ë¥˜ (`free(): invalid pointer`)ê°€ ë°œìƒí•©ë‹ˆë‹¤.
2. ì²­í¬ê°€ ì ì–´ë„ `MINSIZE` í¬ê¸°ì´ê±°ë‚˜ `MALLOC_ALIGNMENT`ì˜ ë°°ìˆ˜ì¸ì§€ í™•ì¸í•©ë‹ˆë‹¤. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì˜¤ë¥˜ (`free(): invalid size`)ê°€ ë°œìƒí•©ë‹ˆë‹¤.
3. ì²­í¬ì˜ í¬ê¸°ê°€ fastbin ëª©ë¡ì— ì†í•˜ëŠ” ê²½ìš°:
1. ë‹¤ìŒ ì²­í¬ì˜ í¬ê¸°ê°€ ìµœì†Œ í¬ê¸°ì™€ ìµœëŒ€ í¬ê¸° (`av->system_mem`) ì‚¬ì´ì— ìˆëŠ”ì§€ í™•ì¸í•˜ê³ , ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì˜¤ë¥˜ (`free(): invalid next size (fast)`)ê°€ ë°œìƒí•©ë‹ˆë‹¤.
2. ì²­í¬ì— `free_perturb`ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
3. `av`ì— `FASTCHUNKS_BIT`ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
4. ì²­í¬ í¬ê¸°ì— ë”°ë¼ fastbin ë°°ì—´ì— ì¸ë±ìŠ¤ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
5. ë°”ì¸ì˜ ë§¨ ìœ„ê°€ ì¶”ê°€í•  ì²­í¬ê°€ ì•„ë‹Œì§€ í™•ì¸í•©ë‹ˆë‹¤. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì˜¤ë¥˜ (`double free or corruption (fasttop)`)ê°€ ë°œìƒí•©ë‹ˆë‹¤.
6. ë§¨ ìœ„ì˜ fastbin ì²­í¬ì˜ í¬ê¸°ê°€ ì¶”ê°€í•˜ëŠ” ì²­í¬ì™€ ê°™ì€ì§€ í™•ì¸í•©ë‹ˆë‹¤. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì˜¤ë¥˜ (`invalid fastbin entry (free)`)ê°€ ë°œìƒí•©ë‹ˆë‹¤.
7. ì²­í¬ë¥¼ fastbin ëª©ë¡ ë§¨ ìœ„ì— ì‚½ì…í•˜ê³  ë°˜í™˜í•©ë‹ˆë‹¤.
4. ì²­í¬ê°€ mmappedê°€ ì•„ë‹Œ ê²½ìš°:
1. ì²­í¬ê°€ ë§¨ ìœ„ ì²­í¬ì¸ì§€ í™•ì¸í•©ë‹ˆë‹¤. ë§ë‹¤ë©´ ì˜¤ë¥˜ (`double free or corruption (top)`)ê°€ ë°œìƒí•©ë‹ˆë‹¤.
2. ë‹¤ìŒ ì²­í¬ (ë©”ëª¨ë¦¬ ìƒ)ê°€ ì•„ë ˆë‚˜ì˜ ê²½ê³„ ë‚´ì— ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì˜¤ë¥˜ (`double free or corruption (out)`)ê°€ ë°œìƒí•©ë‹ˆë‹¤.
3. ë‹¤ìŒ ì²­í¬ (ë©”ëª¨ë¦¬ ìƒ)ì˜ ì´ì „ ì‚¬ìš© ë¹„íŠ¸ê°€ í‘œì‹œë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì˜¤ë¥˜ (`double free or corruption (!prev)`)ê°€ ë°œìƒí•©ë‹ˆë‹¤.
4. ë‹¤ìŒ ì²­í¬ì˜ í¬ê¸°ê°€ ìµœì†Œ í¬ê¸°ì™€ ìµœëŒ€ í¬ê¸° (`av->system_mem`) ì‚¬ì´ì— ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì˜¤ë¥˜ (`free(): invalid next size (normal)`)ê°€ ë°œìƒí•©ë‹ˆë‹¤.
5. ì²­í¬ì— `free_perturb`ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
6. ì´ì „ ì²­í¬ (ë©”ëª¨ë¦¬ ìƒ)ê°€ ì‚¬ìš© ì¤‘ì´ ì•„ë‹ˆë¼ë©´, ì´ì „ ì²­í¬ì— `unlink`ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
7. ë‹¤ìŒ ì²­í¬ (ë©”ëª¨ë¦¬ ìƒ)ê°€ ë§¨ ìœ„ ì²­í¬ê°€ ì•„ë‹Œ ê²½ìš°:
1. ë‹¤ìŒ ì²­í¬ê°€ ì‚¬ìš© ì¤‘ì´ ì•„ë‹ˆë¼ë©´, ë‹¤ìŒ ì²­í¬ì— `unlink`ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
2. ì²­í¬ë¥¼ ì´ì „, ë‹¤ìŒ (ë©”ëª¨ë¦¬ ìƒ)ê³¼ ë³‘í•©í•˜ê³ , ë¬´ë£Œì¸ ê²½ìš° ë¯¸ë¶„ë¥˜ëœ ë°”ì¸ì˜ ë§¨ ìœ„ì— ì¶”ê°€í•©ë‹ˆë‹¤. ì‚½ì…í•˜ê¸° ì „ì— `unsorted_chunks(av)->fd->bk == unsorted_chunks(av)`ë¥¼ í™•ì¸í•©ë‹ˆë‹¤. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì˜¤ë¥˜ ("free(): corrupted unsorted chunks")ê°€ ë°œìƒí•©ë‹ˆë‹¤.
8. ë‹¤ìŒ ì²­í¬ (ë©”ëª¨ë¦¬ ìƒ)ê°€ ë§¨ ìœ„ ì²­í¬ì˜€ë‹¤ë©´, ì²­í¬ë¥¼ ì ì ˆí•˜ê²Œ ë³‘í•©í•˜ì—¬ ë‹¨ì¼ ë§¨ ìœ„ ì²­í¬ë¡œ ë³‘í•©í•©ë‹ˆë‹¤.
5. ì²­í¬ê°€ mmappedì¸ ê²½ìš°, `munmap_chunk`ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.

## í™ í•¨ìˆ˜ ë³´ì•ˆ ê²€ì‚¬

í™ì—ì„œ ìì£¼ ì‚¬ìš©ë˜ëŠ” í•¨ìˆ˜ë“¤ì´ ìˆ˜í–‰í•˜ëŠ” ë³´ì•ˆ ê²€ì‚¬ë¥¼ í™•ì¸í•˜ì‹­ì‹œì˜¤:

{% content-ref url="heap-functions-security-checks.md" %}
[heap-functions-security-checks.md](heap-functions-security-checks.md)
{% endcontent-ref %}

## ì°¸ê³  ìë£Œ

* [https://azeria-labs.com/heap-exploitation-part-1-understanding-the-glibc-heap-implementation/](https://azeria-labs.com/heap-exploitation-part-1-understanding-the-glibc-heap-implementation/)
* [https://azeria-labs.com/heap-exploitation-part-2-glibc-heap-free-bins/](https://azeria-labs.com/heap-exploitation-part-2-glibc-heap-free-bins/)
* [https://heap-exploitation.dhavalkapil.com/diving\_into\_glibc\_heap/core\_functions](https://heap-exploitation.dhavalkapil.com/diving\_into\_glibc\_heap/core\_functions)
