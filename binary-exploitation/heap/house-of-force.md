# Casa de la Fuerza



<details>

<summary><strong>Aprende hacking en AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Equipos Rojos de AWS de HackTricks)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informaci贸n B谩sica

### C贸digo

* Esta t茅cnica fue parcheada ([**aqu铆**](https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=30a17d8c95fbfb15c52d1115803b63aaa73a285c)) y produce este error: `malloc(): corrupted top size`
* Puedes probar el [**c贸digo desde aqu铆**](https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html) para probarlo si lo deseas.

### Objetivo

* El objetivo de este ataque es poder asignar un fragmento en una direcci贸n espec铆fica.

### Requisitos

* Un desbordamiento que permita sobrescribir el tama帽o del encabezado del fragmento superior (por ejemplo, -1).
* Ser capaz de controlar el tama帽o de la asignaci贸n del mont贸n

### Ataque

Si un atacante desea asignar un fragmento en la direcci贸n P para sobrescribir un valor aqu铆. Comienza sobrescribiendo el tama帽o del fragmento superior con `-1` (quiz谩s con un desbordamiento). Esto asegura que malloc no utilizar谩 mmap para ninguna asignaci贸n, ya que el fragmento superior siempre tendr谩 suficiente espacio.

Luego, calcula la distancia entre la direcci贸n del fragmento superior y el espacio objetivo para asignar. Esto se debe a que se realizar谩 una asignaci贸n malloc con ese tama帽o para mover el fragmento superior a esa posici贸n. As铆 es como se puede calcular f谩cilmente la diferencia/tama帽o:
```c
// From https://github.com/shellphish/how2heap/blob/master/glibc_2.27/house_of_force.c#L59C2-L67C5
/*
* The evil_size is calulcated as (nb is the number of bytes requested + space for metadata):
* new_top = old_top + nb
* nb = new_top - old_top
* req + 2sizeof(long) = new_top - old_top
* req = new_top - old_top - 2sizeof(long)
* req = target - 2sizeof(long) - old_top - 2sizeof(long)
* req = target - old_top - 4*sizeof(long)
*/
```
Por lo tanto, asignar un tama帽o de `objetivo - old_top - 4*sizeof(long)` (los 4 longs son debido a los metadatos del chunk superior y del nuevo chunk cuando se asigna) mover谩 el chunk superior a la direcci贸n que queremos sobrescribir.\
Luego, hacer otro malloc para obtener un chunk que contenga al principio los datos a escribir en la direcci贸n objetivo.

### Referencias y Otros Ejemplos

* [https://github.com/shellphish/how2heap/tree/master](https://github.com/shellphish/how2heap/tree/master?tab=readme-ov-file)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/)
* [https://heap-exploitation.dhavalkapil.com/attacks/house\_of\_force](https://heap-exploitation.dhavalkapil.com/attacks/house\_of\_force)
* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.27/house\_of\_force.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.27/house\_of\_force.c)
* [https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html](https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#hitcon-training-lab-11](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#hitcon-training-lab-11)
* El objetivo de este escenario es un ret2win donde necesitamos modificar la direcci贸n de una funci贸n que ser谩 llamada por la direcci贸n de la funci贸n ret2win
* El binario tiene un desbordamiento que puede ser abusado para modificar el tama帽o del chunk superior, que se modifica a -1 o p64(0xffffffffffffffff)
* Luego, se calcula la direcci贸n donde existe el puntero a sobrescribir, y la diferencia desde la posici贸n actual del chunk superior hasta all铆 se asigna con `malloc`
* Finalmente se asigna un nuevo chunk que contendr谩 este objetivo deseado en el que se sobrescribir谩 con la funci贸n ret2win
* [https://shift--crops-hatenablog-com.translate.goog/entry/2016/03/21/171249?\_x\_tr\_sl=es&\_x\_tr\_tl=en&\_x\_tr\_hl=en&\_x\_tr\_pto=wapp](https://shift--crops-hatenablog-com.translate.goog/entry/2016/03/21/171249?\_x\_tr\_sl=es&\_x\_tr\_tl=en&\_x\_tr\_hl=en&\_x\_tr\_pto=wapp)
* En `Input your name:` hay una vulnerabilidad inicial que permite filtrar una direcci贸n del heap
* Luego en la funcionalidad `Org:` y `Host:`, es posible llenar los 64B del puntero `s` cuando se solicita el **nombre de la organizaci贸n**, que en la pila es seguido por la direcci贸n de v2, que luego es seguido por el **nombre del host** indicado. Como entonces, strcpy va a copiar el contenido de s a un chunk de tama帽o 64B, es posible **sobrescribir el tama帽o del chunk superior** con los datos introducidos dentro del **nombre del host**.
* Ahora que es posible la escritura arbitraria, el GOT de `atoi` fue sobrescrito a la direcci贸n de printf. entonces fue posible filtrar la direcci贸n de `IO_2_1_stderr` _con_ `%24$p`. Y con esta filtraci贸n de libc fue posible sobrescribir nuevamente el GOT de `atoi` con la direcci贸n de `system` y llamarlo pasando como par谩metro `/bin/sh`
* Un m茅todo alternativo [propuesto en este otro writeup](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#2016-bctf-bcloud), es sobrescribir `free` con `puts`, y luego agregar la direcci贸n de `atoi@got`, en el puntero que luego ser谩 liberado para que se filtre y con esta filtraci贸n sobrescribir nuevamente `atoi@got` con `system` y llamarlo con `/bin/sh`.
* [https://guyinatuxedo.github.io/41-house\_of\_force/bkp16\_cookbook/index.html](https://guyinatuxedo.github.io/41-house\_of\_force/bkp16\_cookbook/index.html)
* Hay un UAF que permite reutilizar un chunk que fue liberado sin borrar el puntero. Debido a que hay algunos m茅todos de lectura, es posible filtrar una direcci贸n de libc escribiendo un puntero a la funci贸n free en el GOT aqu铆 y luego llamando a la funci贸n de lectura.
* Luego, se utiliz贸 House of force (abusando del UAF) para sobrescribir el tama帽o del espacio izquierdo con un -1, asignar un chunk lo suficientemente grande para llegar al hook de free, y luego asignar otro chunk que contendr谩 el hook de free. Luego, escribir en el hook la direcci贸n de `system`, escribir en un chunk `"/bin/sh"` y finalmente liberar el chunk con ese contenido de cadena.
