# Force Evi

<details>

<summary><strong>SÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* ğŸ’¬ **Discord grubuna** katÄ±lÄ±n](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>

## Temel Bilgiler

### Kod

* Bu teknik dÃ¼zeltildi ([**burada**](https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=30a17d8c95fbfb15c52d1115803b63aaa73a285c)) ve ÅŸu hatayÄ± Ã¼retir: `malloc(): corrupted top size`
* Test etmek isterseniz [**buradan kodu**](https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html) deneyebilirsiniz.

### AmaÃ§

* Bu saldÄ±rÄ±nÄ±n amacÄ± belirli bir adreste bir parÃ§a tahsis edebilmektir.

### Gereksinimler

* BaÅŸlÄ±k Ã¼st parÃ§asÄ±nÄ±n boyutunu Ã¼zerine yazmanÄ±za izin veren bir taÅŸma (Ã¶rneÄŸin -1).
* YÄ±ÄŸÄ±n tahsis boyutunu kontrol edebilme yeteneÄŸi

### SaldÄ±rÄ±

Bir saldÄ±rgan, bir parÃ§ayÄ± P adresine tahsis etmek iÃ§in burada bir deÄŸeri Ã¼zerine yazmak isterse. BaÅŸlangÄ±Ã§ta, baÅŸlÄ±k Ã¼st parÃ§asÄ±nÄ±n boyutunu `-1` ile Ã¼zerine yazarak baÅŸlar (belki bir taÅŸma ile). Bu, malloc'un herhangi bir tahsis iÃ§in mmap kullanmayacaÄŸÄ±ndan emin olur, Ã§Ã¼nkÃ¼ Ãœst parÃ§a her zaman yeterli alanÄ± olacaktÄ±r.

Daha sonra, baÅŸlÄ±k Ã¼st parÃ§asÄ±nÄ±n adresi ile hedef alan arasÄ±ndaki mesafeyi hesaplayÄ±n ve tahsis edilecek alanÄ±n boyutunu kontrol edin. Bu, baÅŸlÄ±k Ã¼st parÃ§asÄ±nÄ± o konuma taÅŸÄ±mak iÃ§in o boyutta bir malloc iÅŸlemi gerÃ§ekleÅŸtirileceÄŸinden fark/kapasite kolayca hesaplanabilir:
```c
// From https://github.com/shellphish/how2heap/blob/master/glibc_2.27/house_of_force.c#L59C2-L67C5
/*
* The evil_size is calulcated as (nb is the number of bytes requested + space for metadata):
* new_top = old_top + nb
* nb = new_top - old_top
* req + 2sizeof(long) = new_top - old_top
* req = new_top - old_top - 2sizeof(long)
* req = target - 2sizeof(long) - old_top - 2sizeof(long)
* req = target - old_top - 4*sizeof(long)
*/
```
Bu yÃ¼zden, `hedef - eski_Ã¼st - 4*sizeof(long)` boyutunda bir alan ayÄ±rmak (4 long, Ã¼st parÃ§anÄ±n ve ayrÄ±ldÄ±ÄŸÄ±nda yeni parÃ§anÄ±n meta verileri nedeniyle) Ã¼st parÃ§ayÄ± Ã¼zerine yazmak istediÄŸimiz adrese taÅŸÄ±yacaktÄ±r.\
Sonra, hedef adresi yazmak iÃ§in verinin baÅŸlangÄ±cÄ±nÄ± iÃ§eren bir parÃ§ayÄ± almak iÃ§in baÅŸka bir malloc yapÄ±n.

### Referanslar ve DiÄŸer Ã–rnekler

* [https://github.com/shellphish/how2heap/tree/master](https://github.com/shellphish/how2heap/tree/master?tab=readme-ov-file)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/)
* [https://heap-exploitation.dhavalkapil.com/attacks/house\_of\_force](https://heap-exploitation.dhavalkapil.com/attacks/house\_of\_force)
* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.27/house\_of\_force.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.27/house\_of\_force.c)
* [https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html](https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#hitcon-training-lab-11](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#hitcon-training-lab-11)
* Bu senaryonun amacÄ±, Ã§aÄŸrÄ±lacak bir iÅŸlevin adresini ret2win iÅŸlevinin adresine deÄŸiÅŸtirmemiz gereken bir ret2win'dir
* Binary, Ã¼st parÃ§anÄ±n boyutunu deÄŸiÅŸtirmek iÃ§in kÃ¶tÃ¼ye kullanÄ±labilecek bir taÅŸma iÃ§erir, bu boyut -1 veya p64(0xffffffffffffffff) olarak deÄŸiÅŸtirilir
* Daha sonra, Ã¼zerine yazÄ±lacak iÅŸaretÃ§inin bulunduÄŸu yere giden adres hesaplanÄ±r ve Ã¼st parÃ§anÄ±n mevcut konumundan oraya olan fark `malloc` ile ayrÄ±lÄ±r
* Son olarak, istenen hedefi iÃ§erecek yeni bir parÃ§a ayrÄ±lÄ±r ve bu parÃ§a ret2win iÅŸlevi tarafÄ±ndan Ã¼zerine yazÄ±lÄ±r
* [https://shift--crops-hatenablog-com.translate.goog/entry/2016/03/21/171249?\_x\_tr\_sl=es&\_x\_tr\_tl=en&\_x\_tr\_hl=en&\_x\_tr\_pto=wapp](https://shift--crops-hatenablog-com.translate.goog/entry/2016/03/21/171249?\_x\_tr\_sl=es&\_x\_tr\_tl=en&\_x\_tr\_hl=en&\_x\_tr\_pto=wapp)
* `AdÄ±nÄ±zÄ± girin:` kÄ±smÄ±nda, yÄ±ÄŸÄ±ndan bir adres sÄ±zdÄ±rmaya izin veren bir baÅŸlangÄ±Ã§ aÃ§Ä±ÄŸÄ± bulunmaktadÄ±r
* ArdÄ±ndan, `Org:` ve `Host:` iÅŸlevlerinde, **org adÄ±** istendiÄŸinde `s` iÅŸaretÃ§isinin 64B'sini doldurmak mÃ¼mkÃ¼ndÃ¼r, Ã§Ã¼nkÃ¼ yÄ±ÄŸÄ±nda v2 adresini takip eden ve daha sonra belirtilen **host adÄ±nÄ±** takip eden ÅŸeydir. Daha sonra, strcpy s'nin iÃ§eriÄŸini 64B boyutunda bir parÃ§aya kopyalayacak, bu nedenle **host adÄ±** iÃ§ine konulan veriyle **Ã¼st parÃ§anÄ±n boyutunu Ã¼zerine yazmak mÃ¼mkÃ¼ndÃ¼r**.
* ArtÄ±k keyfi yazma mÃ¼mkÃ¼n olduÄŸundan, `atoi`'nin GOT'u printf adresine Ã¼zerine yazÄ±ldÄ±. `IO_2_1_stderr` adresi `%24$p` ile sÄ±zdÄ±rÄ±labildi ve bu libc sÄ±zÄ±ntÄ±sÄ± ile `atoi`'nin GOT'u tekrar `system` adresiyle Ã¼zerine yazÄ±larak `/bin/sh` parametresiyle Ã§aÄŸrÄ±ldÄ±
* [Bu diÄŸer yazÄ±da Ã¶nerilen](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#2016-bctf-bcloud) alternatif bir yÃ¶ntem, `free`'yi `puts` ile Ã¼zerine yazmak ve daha sonra daha sonra serbest bÄ±rakÄ±lacak olan iÅŸaretÃ§iye `atoi@got` adresini eklemektir, bÃ¶ylece sÄ±zdÄ±rÄ±lÄ±r ve bu sÄ±zÄ±ntÄ± ile `atoi@got` tekrar `system` ile Ã¼zerine yazÄ±lÄ±r ve `/bin/sh` ile Ã§aÄŸrÄ±lÄ±r.
* [https://guyinatuxedo.github.io/41-house\_of\_force/bkp16\_cookbook/index.html](https://guyinatuxedo.github.io/41-house\_of\_force/bkp16\_cookbook/index.html)
* Burada, iÅŸaretÃ§i temizlenmeden serbest bÄ±rakÄ±lan bir parÃ§ayÄ± yeniden kullanmaya izin veren bir UAF bulunmaktadÄ±r. BazÄ± okuma yÃ¶ntemleri olduÄŸundan, buraya serbest iÅŸlevine bir iÅŸaretÃ§i yazarak bir libc adresi sÄ±zdÄ±rmak ve ardÄ±ndan okuma iÅŸlevini Ã§aÄŸÄ±rmak mÃ¼mkÃ¼ndÃ¼r.
* Daha sonra, (UAF'yi kÃ¶tÃ¼ye kullanarak) sol boÅŸluÄŸun boyutunu -1 ile Ã¼zerine yazmak, serbest kancaya ulaÅŸmak iÃ§in yeterince bÃ¼yÃ¼k bir parÃ§a ayÄ±rmak ve ardÄ±ndan serbest kancayÄ± iÃ§erecek baÅŸka bir parÃ§a ayÄ±rmak iÃ§in House of force kullanÄ±ldÄ±. Daha sonra, kancaya `system` adresini yazÄ±n, bir parÃ§aya `"/bin/sh"` yazÄ±n ve son olarak o dize iÃ§eriÄŸine sahip parÃ§ayÄ± serbest bÄ±rakÄ±n.
