# Dom Siy

<details>

<summary><strong>Nauka hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF** sprawd藕 [**PLAN SUBSKRYPCYJNY**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakowania, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Podstawowe Informacje

### Kod

* Ta technika zostaa zaatana ([**tutaj**](https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=30a17d8c95fbfb15c52d1115803b63aaa73a285c)) i powoduje ten bd: `malloc(): corrupted top size`
* Mo偶esz wypr贸bowa [**kod std**](https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html), jeli chcesz go przetestowa.

### Cel

* Celem tego ataku jest mo偶liwo alokacji fragmentu pamici w okrelonym adresie.

### Wymagania

* Przepenienie, kt贸re pozwala nadpisa rozmiar nag贸wka top chunk (np. -1).
* Mo偶liwo kontrolowania rozmiaru alokacji sterty

### Atak

Jeli atakujcy chce zaalokowa fragment pamici pod adresem P w celu nadpisania wartoci, zaczyna od nadpisania rozmiaru top chunk `-1` (mo偶e to by wykonane poprzez przepenienie). Zapewnia to, 偶e malloc nie bdzie u偶ywa mmap do 偶adnej alokacji, poniewa偶 Top chunk zawsze bdzie mia wystarczajco du偶o miejsca.

Nastpnie oblicz odlego midzy adresem top chunk a docelowym miejscem alokacji. Jest to konieczne, poniewa偶 alokacja malloc o takim rozmiarze zostanie wykonana w celu przeniesienia top chunk do tej pozycji. Tak mo偶na atwo obliczy r贸偶nic/rozmiar:
```c
// From https://github.com/shellphish/how2heap/blob/master/glibc_2.27/house_of_force.c#L59C2-L67C5
/*
* The evil_size is calulcated as (nb is the number of bytes requested + space for metadata):
* new_top = old_top + nb
* nb = new_top - old_top
* req + 2sizeof(long) = new_top - old_top
* req = new_top - old_top - 2sizeof(long)
* req = target - 2sizeof(long) - old_top - 2sizeof(long)
* req = target - old_top - 4*sizeof(long)
*/
```
Dlatego alokujc rozmiar `cel - old_top - 4*sizeof(long)` (4 longi, poniewa偶 metadane top chunk i nowego chunka po alokacji) przesunie top chunk na adres, kt贸ry chcemy nadpisa.\
Nastpnie wykonaj kolejne malloc, aby uzyska chunk zawierajcy na pocztku danych do zapisania docelowego adresu.

### Odnoniki i Inne Przykady

* [https://github.com/shellphish/how2heap/tree/master](https://github.com/shellphish/how2heap/tree/master?tab=readme-ov-file)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/)
* [https://heap-exploitation.dhavalkapil.com/attacks/house\_of\_force](https://heap-exploitation.dhavalkapil.com/attacks/house\_of\_force)
* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.27/house\_of\_force.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.27/house\_of\_force.c)
* [https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html](https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#hitcon-training-lab-11](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#hitcon-training-lab-11)
* Celem tego scenariusza jest ret2win, gdzie musimy zmodyfikowa adres funkcji, kt贸ra zostanie wywoana przez funkcj ret2win.
* Binarny plik ma przepenienie, kt贸re mo偶na wykorzysta do zmodyfikowania rozmiaru top chunk, kt贸ry jest zmieniony na -1 lub p64(0xffffffffffffffff).
* Nastpnie obliczany jest adres miejsca, gdzie istnieje wska藕nik do nadpisania, a r贸偶nica od bie偶cej pozycji top chunk do tego miejsca jest alokowana za pomoc `malloc`.
* Na koniec alokowany jest nowy chunk, kt贸ry bdzie zawiera ten po偶dany cel, w kt贸ry zostanie nadpisany przez funkcj ret2win.
* [https://shift--crops-hatenablog-com.translate.goog/entry/2016/03/21/171249?\_x\_tr\_sl=es&\_x\_tr\_tl=en&\_x\_tr\_hl=en&\_x\_tr\_pto=wapp](https://shift--crops-hatenablog-com.translate.goog/entry/2016/03/21/171249?\_x\_tr\_sl=es&\_x\_tr\_tl=en&\_x\_tr\_hl=en&\_x\_tr\_pto=wapp)
* W `Wprowad藕 swoje imi:` istnieje pocztkowa podatno, kt贸ra pozwala na wyciek adresu z heap.
* Nastpnie w funkcjonalnoci `Org:` i `Host:` mo偶na wypeni 64B wska藕nika `s`, gdy zostanie zapytane o **nazw org**, kt贸ra na stosie jest nastpnie ledzona przez adres v2, a nastpnie wskazan **nazw hosta**. Poniewa偶 strcpy bdzie kopiowa zawarto s do chunka o rozmiarze 64B, mo偶liwe jest **nadpisanie rozmiaru top chunk** danymi umieszczonymi w **nazwie hosta**.
* Teraz, gdy mo偶liwe jest dowolne zapisywanie, GOT `atoi` zosta nadpisany adresem printf. Nastpnie mo偶liwe byo wyciek adresu `IO_2_1_stderr` _z_ `%24$p`. I dziki temu wyciekowi libc mo偶liwe byo ponowne nadpisanie GOT `atoi` adresem `system` i wywoanie go, przekazujc jako parametr `/bin/sh`.
* Alternatywna metoda [zapropnowana w tym innym rozwizaniu](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#2016-bctf-bcloud), polega na nadpisaniu `free` z `puts`, a nastpnie dodaniu adresu `atoi@got` w wska藕niku, kt贸ry zostanie p贸藕niej zwolniony, aby zosta wycieknity, a dziki temu wyciekowi ponownie nadpisa `atoi@got` z `system` i wywoa go z `/bin/sh`.
* [https://guyinatuxedo.github.io/41-house\_of\_force/bkp16\_cookbook/index.html](https://guyinatuxedo.github.io/41-house\_of\_force/bkp16\_cookbook/index.html)
* Istnieje UAF, kt贸ry pozwala na ponowne u偶ycie zwolnionego chunka bez wyczyszczenia wska藕nika. Poniewa偶 s tu pewne metody odczytu, mo偶liwe jest wyciekanie adresu libc, zapisujc wska藕nik do funkcji free w GOT i nastpnie wywoujc funkcj odczytu.
* Nastpnie, u偶yto House of force (wykorzystujc UAF) do nadpisania rozmiaru pozostaej przestrzeni na -1, alokowania wystarczajco du偶ego chunka, aby dotrze do free hook, a nastpnie alokowania innego chunka, kt贸ry bdzie zawiera free hook. Nastpnie, w hooku zapisano adres `system`, w chunku zapisano `"/bin/sh"` i na koniec zwolniono chunk z tym zawartoci cigu znak贸w.
