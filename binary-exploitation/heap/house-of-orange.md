# Dom Pomaraczowy

<details>

<summary><strong>Nauka hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF** sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakowania, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na githubie.

</details>

## Podstawowe Informacje

### Kod

* Znajd藕 przykad w [https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_orange.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_orange.c)
* Technika eksploatacji zostaa naprawiona w tym [patchu](https://sourceware.org/git/?p=glibc.git;a=blobdiff;f=stdlib/abort.c;h=117a507ff88d862445551f2c07abb6e45a716b75;hp=19882f3e3dc1ab830431506329c94dcf1d7cc252;hb=91e7cf982d0104f0e71770f5ae8e3faf352dea9f;hpb=0c25125780083cbba22ed627756548efe282d1a0) wic ju偶 nie dziaa (dziaa w wersjach wczeniejszych ni偶 2.26)
* Ten sam przykad **z wiksz iloci komentarzy** w [https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)

### Cel

* Wykorzystanie funkcji `malloc_printerr`

### Wymagania

* Nadpisanie rozmiaru top chunk
* Wycieki libc i heap

### To

Potrzebne to z komentarzy z [**tego przykadu**](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)**:**

Rzecz w tym, 偶e w starszych wersjach libc, gdy wywoywana bya funkcja `malloc_printerr`, **iterowaa przez list struktur `_IO_FILE` przechowywanych w `_IO_list_all`**, i faktycznie **wykonywaa** wska藕nik instrukcji w tej strukturze.\
Ten atak sfaszuje **faszyw struktur `_IO_FILE`**, kt贸r zapiszemy do **`_IO_list_all`**, i spowoduje uruchomienie `malloc_printerr`.\
Nastpnie **wykona adres**, kt贸ry mamy zapisany w strukturach **`_IO_FILE`**, a nastpnie uzyskamy wykonanie kodu

### Atak

Atak rozpoczyna si od uzyskania **top chunk** wewntrz **unsorted bin**. Osiga si to poprzez wywoanie `malloc` z rozmiarem wikszym ni偶 aktualny rozmiar top chunk, ale mniejszym ni偶 **`mmp_.mmap_threshold`** (domylnie 128K), co w przeciwnym razie spowodowaoby alokacj `mmap`. Gdy rozmiar top chunk jest modyfikowany, wa偶ne jest zapewnienie, 偶e **top chunk + jego rozmiar** jest wyr贸wnany do strony i 偶e bit **prev\_inuse** top chunk zawsze jest ustawiony.

Aby uzyska top chunk wewntrz unsorted bin, alokuj kawaek, aby utworzy top chunk, zmie rozmiar top chunk (z przepenieniem w przydzielonym kawaku), aby **top chunk + rozmiar** by wyr贸wnany do strony z bitem **prev\_inuse** ustawionym. Nastpnie zaalokuj kawaek wikszy ni偶 nowy rozmiar top chunk. Nale偶y zauwa偶y, 偶e `free` nigdy nie jest wywoywane, aby umieci top chunk w unsorted bin.

Stary top chunk jest teraz w unsorted bin. Zakadajc, 偶e mo偶emy odczyta dane wewntrz niego (mo偶liwe z powodu podatnoci, kt贸ra r贸wnie偶 spowodowaa przepenienie), mo偶liwe jest wyciekanie adres贸w libc z niego i uzyskanie adresu **\_IO\_list\_all**.

Atak na unsorted bin jest wykonywany poprzez nadu偶ycie przepenienia, aby zapisa `topChunk->bk->fwd = _IO_list_all - 0x10`. Gdy zostanie przydzielony nowy kawaek, stary top chunk zostanie podzielony, a wska藕nik do unsorted bin zostanie zapisany do **`_IO_list_all`**.

Nastpnym krokiem jest zmniejszenie rozmiaru starego top chunk, aby pasowa do maego binu, ustawiajc specjalnie jego rozmiar na **0x61**. Su偶y to dw贸m celom:

1. **Wstawienie do Small Bin 4**: Gdy `malloc` przeglda unsorted bin i widzi ten kawaek, spr贸buje wstawi go do maego binu 4 ze wzgldu na jego may rozmiar. Powoduje to, 偶e kawaek trafia na pocztek listy maego binu 4, kt贸ry jest miejscem wska藕nika FD kawaka **`_IO_list_all`**, poniewa偶 zapisalimy bliski adres w **`_IO_list_all`** poprzez atak na unsorted bin.
2. **Wywoanie Malloc Check**: Manipulacja rozmiarem tego kawaka spowoduje, 偶e `malloc` wykona wewntrzne sprawdzenia. Gdy sprawdza rozmiar faszywego kawaka do przodu, kt贸ry bdzie wynosi zero, wywouje bd i wywouje `malloc_printerr`.

Manipulacja maym binem pozwoli ci kontrolowa wska藕nik do przodu kawaka. Nakadanie si z **\_IO\_list\_all** jest wykorzystywane do sfaszowania faszywej struktury **\_IO\_FILE**. Struktura jest starannie opracowana, aby zawiera kluczowe pola takie jak `_IO_write_base` i `_IO_write_ptr` ustawione na wartoci, kt贸re przechodz wewntrzne sprawdzenia w libc. Dodatkowo tworzona jest tablica skok贸w wewntrz faszywej struktury, gdzie wska藕nik instrukcji jest ustawiony na adres, w kt贸rym mo偶e by wykonany dowolny kod (np. funkcja `system`).

Podsumowujc pozosta cz techniki:

* **Zmniejsz stary top chunk**: Dostosuj rozmiar starego top chunk do **0x61**, aby pasowa do maego binu.
* **Ustaw faszyw struktur `_IO_FILE`**: Nakadaj stary top chunk na faszyw struktur **\_IO\_FILE** i ustaw pola odpowiednio, aby przej kontrol nad przepywem wykonania.

Nastpnym krokiem jest sfaszowanie faszywej struktury **\_IO\_FILE**, kt贸ra nakada si na stary top chunk obecnie w unsorted bin. Pierwsze bajty tej struktury s starannie opracowane, aby zawiera wska藕nik do polecenia (np. "/bin/sh"), kt贸re zostanie wykonane.

Kluczowe pola w faszywej strukturze **\_IO\_FILE**, takie jak `_IO_write_base` i `_IO_write_ptr`, s ustawione na wartoci, kt贸re przechodz wewntrzne sprawdzenia w libc. Dodatkowo tworzona jest tablica skok贸w wewntrz faszywej struktury, gdzie wska藕nik instrukcji jest ustawiony na adres, w kt贸rym mo偶e by wykonany dowolny kod. Zazwyczaj bdzie to adres funkcji `system` lub innej funkcji, kt贸ra mo偶e wykonywa polecenia powoki.

Atak kulminuje, gdy wywoanie `malloc` powoduje wykonanie kodu poprzez sfaszowan struktur **\_IO\_FILE**. Pozwala to efektywnie na wykonanie dowolnego kodu, zwykle prowadzc do uruchomienia powoki lub innego zoliwego adunku.

**Podsumowanie Ataku:**

1. **Ustaw top chunk**: Zaalokuj kawaek i zmodyfikuj rozmiar top chunk.
2. **Wymu top chunk do unsorted bin**: Zaalokuj wikszy kawaek.
3. **Wyciek adres贸w libc**: U偶yj podatnoci do odczytu z unsorted bin.
4. **Wykonaj atak na unsorted bin**: Zapisz do **\_IO\_list\_all** poprzez przepenienie.
5. **Zmniejsz stary top chunk**: Dostosuj jego rozmiar, aby pasowa do maego binu.
6. **Ustaw faszyw struktur \_IO\_FILE**: Sfaszuj faszyw struktur pliku, aby przej kontrol nad przepywem wykonania.
7. **Wywoaj wykonanie kodu**: Zaalokuj kawaek do wykonania ataku i uruchom dowolny kod.

Ta metoda wykorzystuje mechanizmy zarzdzania stosem, wycieki informacji libc i przepenienia sterty, aby osign wykonanie kodu bez bezporedniego wywoywania `free`. Staranne opracowanie faszywej struktury **\_IO\_FILE** i umieszczenie jej we waciwym miejscu pozwala na przejcie kontroli podczas standardowych operacji alokacji pamici. Umo偶liwia to wykonanie dowolnego kodu, potencjalnie prowadzc do uruchomienia powoki lub innych zoliwych dziaa.
## Odnoniki

* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_orange/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_orange/)
* [https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)

<details>

<summary><strong>Zacznij od zera i zosta mistrzem hakowania AWS dziki</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na githubie.

</details>
