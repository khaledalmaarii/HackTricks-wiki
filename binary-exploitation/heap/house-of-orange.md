# KuÄ‡a od narandÅ¾aste boje

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Osnovne informacije

### Kod

* PronaÄ‘ite primer na [https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_orange.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_orange.c)
* Tehnika eksploatacije je popravljena u ovom [patch-u](https://sourceware.org/git/?p=glibc.git;a=blobdiff;f=stdlib/abort.c;h=117a507ff88d862445551f2c07abb6e45a716b75;hp=19882f3e3dc1ab830431506329c94dcf1d7cc252;hb=91e7cf982d0104f0e71770f5ae8e3faf352dea9f;hpb=0c25125780083cbba22ed627756548efe282d1a0) tako da ovo viÅ¡e ne radi (radi u verzijama pre 2.26)
* Isti primer **sa viÅ¡e komentara** na [https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)

### Cilj

* Zloupotreba funkcije `malloc_printerr`

### Zahtevi

* Prepisivanje veliÄine vrha bloka
* Curenje libc-a i hipa

### Pozadina

Neophodne informacije iz komentara iz [**ovog primera**](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)**:**

Stvar je u tome da su u starijim verzijama libc-a, kada je pozvana funkcija `malloc_printerr`, ona bi **iterirala kroz listu `_IO_FILE` struktura smeÅ¡tenih u `_IO_list_all`**, i zapravo **izvrÅ¡ila** pokazivaÄ instrukcije u toj strukturi.\
Ovaj napad Ä‡e falsifikovati **laÅ¾nu `_IO_FILE` strukturu** koju Ä‡emo upisati u **`_IO_list_all`**, i izazvati pokretanje `malloc_printerr`.\
Zatim Ä‡e **izvrÅ¡iti bilo koju adresu** koju smo saÄuvali u **`_IO_FILE`** strukturama jump tabele, i dobiÄ‡emo izvrÅ¡enje koda

### Napad

Napad poÄinje tako Å¡to uspe da dobije **vrh bloka** unutar **neureÄ‘enog bin-a**. To se postiÅ¾e pozivom `malloc` sa veliÄinom veÄ‡om od trenutne veliÄine vrha bloka, ali manjom od **`mmp_.mmap_threshold`** (podrazumevano je 128K), Å¡to bi inaÄe pokrenulo alokaciju `mmap`. Kada se veliÄina vrha bloka izmeni, vaÅ¾no je osigurati da je **vrh bloka + njegova veliÄina** poravnata sa stranicom i da je bit **prev\_inuse** vrha bloka uvek postavljen.

Da biste dobili vrh bloka unutar neureÄ‘enog bin-a, alocirajte deo kako biste kreirali vrh bloka, promenite veliÄinu vrha bloka (sa prelivanjem u alociranom delu) tako da je **vrh bloka + veliÄina** poravnata sa stranicom sa postavljenim bitom **prev\_inuse**. Zatim alocirajte deo veÄ‡i od nove veliÄine vrha bloka. Imajte na umu da se `free` nikada ne poziva da bi se vrh bloka stavio u neureÄ‘eni bin.

Stari vrh bloka je sada u neureÄ‘enom bin-u. PretpostavljajuÄ‡i da moÅ¾emo Äitati podatke unutar njega (moÅ¾da zbog ranjivosti koja je takoÄ‘e uzrokovala prelivanje), moguÄ‡e je procuriti libc adrese iz njega i dobiti adresu **\_IO\_list\_all**.

Napad na neureÄ‘eni bin se izvodi zloupotrebom prelivanja kako bi se napisalo `topChunk->bk->fwd = _IO_list_all - 0x10`. Kada se alocira novi deo, stari vrh bloka Ä‡e biti podeljen, i pokazivaÄ na neureÄ‘eni bin Ä‡e biti upisan u **`_IO_list_all`**.

SledeÄ‡i korak ukljuÄuje smanjenje veliÄine starog vrha bloka kako bi se uklopio u mali bin, posebno postavljanjem njegove veliÄine na **0x61**. Ovo ima dva cilja:

1. **Umetanje u Mali Bin 4**: Kada `malloc` skenira kroz neureÄ‘eni bin i vidi ovaj deo, pokuÅ¡aÄ‡e da ga ubaci u mali bin 4 zbog njegove male veliÄine. To Ä‡e dovesti do toga da deo zavrÅ¡i na poÄetku liste malog bina 4, Å¡to je lokacija FD pokazivaÄa dela **`_IO_list_all`** jer smo napisali blisku adresu u **`_IO_list_all`** putem napada na neureÄ‘eni bin.
2. **Pokretanje Malloc Provere**: Ova manipulacija veliÄinom dela Ä‡e naterati `malloc` da izvrÅ¡i interne provere. Kada proveri veliÄinu laÅ¾nog naprednog dela, koji Ä‡e biti nula, izazvaÄ‡e greÅ¡ku i pozvati `malloc_printerr`.

Manipulacija malim binom Ä‡e vam omoguÄ‡iti kontrolu naprednog pokazivaÄa dela. Preklapanje sa **\_IO\_list\_all** se koristi za izradu laÅ¾ne **\_IO\_FILE** strukture. Struktura je paÅ¾ljivo oblikovana da ukljuÄi kljuÄna polja poput `_IO_write_base` i `_IO_write_ptr` postavljena na vrednosti koje prolaze interne provere u libc-u. Dodatno, unutar laÅ¾ne strukture se kreira jump tabela, gde je pokazivaÄ instrukcije postavljen na adresu gde se moÅ¾e izvrÅ¡iti proizvoljan kod (npr. funkcija `system`).

Da sumiramo preostali deo tehnike:

* **Smanjite Stari Vrh Bloka**: Prilagodite veliÄinu starog vrha bloka na **0x61** kako biste ga uklopili u mali bin.
* **Postavite LaÅ¾nu `_IO_FILE` Strukturu**: Preklopite stari vrh bloka sa laÅ¾nom **\_IO\_FILE** strukturom i postavite polja na odgovarajuÄ‡i naÄin da preuzmete kontrolu nad tokom izvrÅ¡enja.

SledeÄ‡i korak ukljuÄuje izradu laÅ¾ne **\_IO\_FILE** strukture koja se preklapa sa starim vrhom bloka koji se trenutno nalazi u neureÄ‘enom bin-u. Prvi bajtovi ove strukture paÅ¾ljivo su oblikovani da ukljuÄe pokazivaÄ na komandu (npr. "/bin/sh") koja Ä‡e biti izvrÅ¡ena.

KljuÄna polja u laÅ¾noj **\_IO\_FILE** strukturi, poput `_IO_write_base` i `_IO_write_ptr`, postavljaju se na vrednosti koje prolaze interne provere u libc-u. Dodatno, unutar laÅ¾ne strukture se kreira jump tabela, gde je pokazivaÄ instrukcije postavljen na adresu gde se moÅ¾e izvrÅ¡iti proizvoljan kod. TipiÄno, to bi bila adresa funkcije `system` ili neke druge funkcije koja moÅ¾e izvrÅ¡iti shell komande.

Napad kulminira kada poziv `malloc` pokrene izvrÅ¡enje koda putem manipulisane **\_IO\_FILE** strukture. Ovo efikasno omoguÄ‡ava izvrÅ¡enje proizvoljnog koda, Å¡to obiÄno rezultira spawnovanjem shell-a ili izvrÅ¡avanjem druge zlonamerne payload-a.

**Rezime Napada:**

1. **Postavite vrh bloka**: Alocirajte deo i promenite veliÄinu vrha bloka.
2. **Prisilite vrh bloka u neureÄ‘eni bin**: Alocirajte veÄ‡i deo.
3. **Curenje libc adresa**: Iskoristite ranjivost da Äitate iz neureÄ‘enog bin-a.
4. **IzvrÅ¡ite napad na neureÄ‘eni bin**: Upisujte u **\_IO\_list\_all** koriÅ¡Ä‡enjem prelivanja.
5. **Smanjite stari vrh bloka**: Prilagodite njegovu veliÄinu da se uklopi u mali bin.
6. **Postavite laÅ¾nu \_IO\_FILE strukturu**: Napravite laÅ¾nu strukturu fajla da preuzmete kontrolu nad tokom izvrÅ¡enja.
7. **Pokrenite izvrÅ¡enje koda**: Alocirajte deo da izvrÅ¡ite napad i pokrenete proizvoljan kod.

Ovaj pristup iskoriÅ¡Ä‡ava mehanizme upravljanja hipom, curenje informacija libc-a i prelivanje hipa kako bi se postiglo izvrÅ¡enje koda bez direktnog pozivanja `free`. PaÅ¾ljivim oblikovanjem laÅ¾ne **\_IO\_FILE** strukture i postavljanjem je na pravo mesto, napad moÅ¾e preuzeti kontrolu nad tokom izvrÅ¡enja tokom standardnih operacija alokacije memorije. Ovo omoguÄ‡ava izvrÅ¡enje proizvoljnog koda, Å¡to potencijalno rezultira shell-om ili drugim zlonamernim aktivnostima.
## Reference

* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_orange/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_orange/)
* [https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** Proverite [**PLANOVE ZA PRETPLATU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
