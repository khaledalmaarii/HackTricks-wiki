# Tcache Bin Attack

<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan kahraman yapmaya kadar Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini alÄ±n**](https://peass.creator-spring.com)
* [**PEASS Ailesi'ni keÅŸfedin**](https://opensea.io/collection/the-peass-family), Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuzu keÅŸfedin
* **KatÄ±lÄ±n** ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin**.
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± gÃ¶ndererek HackTricks** ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na PR gÃ¶nderin.

</details>

## Temel Bilgiler

Tcache bin nedir hakkÄ±nda daha fazla bilgi iÃ§in bu sayfaya bakÄ±n:

{% content-ref url="bins-and-memory-allocations.md" %}
[bins-and-memory-allocations.md](bins-and-memory-allocations.md)
{% endcontent-ref %}

Ä°lk olarak, Tcache glibc sÃ¼rÃ¼mÃ¼ 2.26'da tanÄ±tÄ±ldÄ±.

[**guyinatuxido sayfasÄ±nda**](https://guyinatuxedo.github.io/29-tcache/tcache\_explanation/index.html) Ã¶nerilen **Tcache** saldÄ±rÄ±sÄ±, hedeflenen amaÃ§Ä±n bir serbest bÄ±rakÄ±lmÄ±ÅŸ parÃ§ada bir sonraki parÃ§a iÅŸaretÃ§isini isteÄŸe baÄŸlÄ± bir adrese Ã¼zerine yazmak olduÄŸu hÄ±zlÄ± bin saldÄ±rÄ±sÄ±na Ã§ok benzerdir, bÃ¶ylece daha sonra **o belirli adrese tahsis edilebilir ve potansiyel olarak iÅŸaretÃ§iler Ã¼zerine yazÄ±labilir**.

Ancak, gÃ¼nÃ¼mÃ¼zde, bahsedilen kodu Ã§alÄ±ÅŸtÄ±rÄ±rsanÄ±z hata alÄ±rsÄ±nÄ±z: **`malloc(): hizalanmamÄ±ÅŸ tcache parÃ§asÄ± tespit edildi`**. Bu nedenle, yeni iÅŸaretÃ§iye hizalanmÄ±ÅŸ bir adres yazmak gereklidir (veya yazÄ±lan adresin gerÃ§ekten hizalandÄ±ÄŸÄ± binary'yi yeterince kez Ã§alÄ±ÅŸtÄ±rmak).

### Tcache indeksleri saldÄ±rÄ±sÄ±

Genellikle heap'in baÅŸlangÄ±cÄ±nda, tcache iÃ§indeki **her indeksteki parÃ§a sayÄ±sÄ±nÄ±** ve **her tcache indeksinin baÅŸ parÃ§a adresini** iÃ§eren bir parÃ§a bulunabilir. Bu bilgileri bir ÅŸekilde deÄŸiÅŸtirmek mÃ¼mkÃ¼n olursa, bir indeksin baÅŸ parÃ§asÄ±nÄ± istenen bir adrese (Ã¶rneÄŸin malloc hook) **iÅŸaret etmesi mÃ¼mkÃ¼n olacaktÄ±r** ve daha sonra bu durumda malloc hook iÃ§eriÄŸini Ã¼zerine yazmak mÃ¼mkÃ¼n olacaktÄ±r.

## Ã–rnekler

* CTF [https://guyinatuxedo.github.io/29-tcache/dcquals19\_babyheap/index.html](https://guyinatuxedo.github.io/29-tcache/dcquals19\_babyheap/index.html)
* **Libc bilgi sÄ±zÄ±ntÄ±sÄ±**: Tcache'leri doldurmak, bir parÃ§ayÄ± sÄ±ralanmamÄ±ÅŸ listeye eklemek, tcache'leri boÅŸaltmak ve ardÄ±ndan sadece ilk 8B'yi Ã¼zerine yazarak sÄ±ralanmamÄ±ÅŸ bÃ¶lgeden parÃ§ayÄ± **yeniden tahsis etmek mÃ¼mkÃ¼n olacak, ikinci adresi parÃ§adan libc'ye bÄ±rakarak okuyabileceÄŸiz**.
* **Tcache saldÄ±rÄ±sÄ±**: Binary, 1B heap taÅŸmasÄ±na karÅŸÄ± savunmasÄ±zdÄ±r. Bu, ayrÄ±lmÄ±ÅŸ bir parÃ§anÄ±n **boyut baÅŸlÄ±ÄŸÄ±nÄ±** deÄŸiÅŸtirmek iÃ§in kÃ¶tÃ¼ye kullanÄ±lacaktÄ±r. Daha sonra, bu parÃ§a **serbest bÄ±rakÄ±lacak**, sahte boyuttaki parÃ§alarÄ±n tcache'ine eklenir. ArdÄ±ndan, sahte boyuttaki bir parÃ§a tahsis edilecek ve Ã¶nceki parÃ§a **gerÃ§ekte daha kÃ¼Ã§Ã¼k olduÄŸu bilinerek geri dÃ¶necektir ve bu, bellekteki bir sonraki parÃ§ayÄ± Ã¼zerine yazma fÄ±rsatÄ± verir**.\
Bu, **bir sonraki parÃ§anÄ±n FD iÅŸaretÃ§isini Ã¼zerine yazmak** iÃ§in kÃ¶tÃ¼ye kullanÄ±lacaktÄ±r ve ardÄ±ndan 2 iÅŸaretÃ§i tahsis edilecektir: Ã¶nce deÄŸiÅŸtirdiÄŸimiz meÅŸru iÅŸaretÃ§i ve ardÄ±ndan ikinci tahsis, **`malloc_hook`**'a iÅŸaret eden bir parÃ§a dÃ¶ndÃ¼recektir ve bu, **bir gadget yazmak iÃ§in kÃ¶tÃ¼ye kullanÄ±labilir**.
* CTF [https://guyinatuxedo.github.io/29-tcache/plaid19\_cpp/index.html](https://guyinatuxedo.github.io/29-tcache/plaid19\_cpp/index.html)
* **Libc bilgi sÄ±zÄ±ntÄ±sÄ±**: Bir kullanÄ±m sonrasÄ± Ã¼cretsiz ve Ã§ift Ã¼cretsiz var. Bu yazÄ±da yazar, kÃ¼Ã§Ã¼k bir binaya yerleÅŸtirilen bir parÃ§anÄ±n adresini okuyarak libc'nin bir adresini sÄ±zdÄ±rdÄ± (sÄ±ralanmamÄ±ÅŸ bÃ¶lgeden deÄŸil, kÃ¼Ã§Ã¼k bir bÃ¶lgeden sÄ±zdÄ±rdÄ±).
* **Tcache saldÄ±rÄ±sÄ±**: Bir **Ã§ift Ã¼cretsiz** ile bir Tcache gerÃ§ekleÅŸtirilir. AynÄ± parÃ§a iki kez serbest bÄ±rakÄ±lÄ±r, bu nedenle Tcache iÃ§inde parÃ§a kendisine iÅŸaret eder. ArdÄ±ndan, tahsis edilir, FD iÅŸaretÃ§isi **free hook'a iÅŸaret etmek Ã¼zere deÄŸiÅŸtirilir ve ardÄ±ndan tekrar tahsis edilir, bÃ¶ylece listedeki bir sonraki parÃ§a free hook'ta olacaktÄ±r. ArdÄ±ndan, bu da tahsis edilir ve buraya `system`'in adresini yazmak mÃ¼mkÃ¼n olacak, bÃ¶ylece `"/bin/sh"` iÃ§eren bir malloc serbest bÄ±rakÄ±ldÄ±ÄŸÄ±nda bir shell alÄ±nÄ±r.
* CTF [https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps0/index.html](https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps0/index.html)
* **Tcache indeksleri saldÄ±rÄ±sÄ±**: Tcache bilgileri iÃ§inde depolanan bir boyutta bir parÃ§a tahsis edip serbest bÄ±rakmak, bu bilginin 0x100 deÄŸerine sahip bir konum oluÅŸturmasÄ±nÄ± saÄŸlar (Ã§Ã¼nkÃ¼ o indeksteki kaÃ§ parÃ§anÄ±n depolandÄ±ÄŸÄ±nÄ± gÃ¶steren bayt). Bu deÄŸeri kÃ¶tÃ¼ye kullanarak, 0x100 boyutunda bir parÃ§a tahsis edilerek diÄŸer tcache indekslerinin baÅŸlangÄ±Ã§ parÃ§a adresi Ã¼zerine yazÄ±labilir. Ã–rneÄŸin, malloc hook adresini birine koyarak ve o indeksin boyutunda bir parÃ§a tahsis ederek calloc hook'ta bir parÃ§a elde etmek, bir gadget yazmak iÃ§in kÃ¶tÃ¼ye kullanÄ±labilir ve bir shell alÄ±nabilir.
