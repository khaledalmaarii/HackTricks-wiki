# Tcache Bin Attack

<details>

<summary><strong>ÎœÎ¬Î¸ÎµÏ„Îµ Ï„Î¿ Ï‡Î¬ÎºÎ¹Î½Î³Îº ÏƒÏ„Î¿ AWS Î±Ï€ÏŒ Ï„Î¿ Î¼Î·Î´Î­Î½ Î¼Î­Ï‡ÏÎ¹ Ï„Î¿Î½ Î®ÏÏ‰Î± Î¼Îµ Ï„Î¿</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Î•Î¹Î´Î¹ÎºÏŒÏ‚ Red Team Ï„Î¿Ï… HackTricks AWS)</strong></a><strong>!</strong></summary>

Î†Î»Î»Î¿Î¹ Ï„ÏÏŒÏ€Î¿Î¹ Ï…Ï€Î¿ÏƒÏ„Î®ÏÎ¹Î¾Î·Ï‚ Ï„Î¿Ï… HackTricks:

* Î‘Î½ Î¸Î­Î»ÎµÏ„Îµ Î½Î± Î´ÎµÎ¯Ï„Îµ Ï„Î·Î½ **ÎµÏ„Î±Î¹ÏÎµÎ¯Î± ÏƒÎ±Ï‚ Î½Î± Î´Î¹Î±Ï†Î·Î¼Î¯Î¶ÎµÏ„Î±Î¹ ÏƒÏ„Î¿ HackTricks** Î® Î½Î± **ÎºÎ±Ï„ÎµÎ²Î¬ÏƒÎµÏ„Îµ Ï„Î¿ HackTricks ÏƒÎµ Î¼Î¿ÏÏ†Î® PDF** ÎµÎ»Î­Î³Î¾Ï„Îµ Ï„Î± [**Î£Î§Î•Î”Î™Î‘ Î£Î¥ÎÎ”Î¡ÎŸÎœÎ—Î£**](https://github.com/sponsors/carlospolop)!
* Î‘Ï€Î¿ÎºÏ„Î®ÏƒÏ„Îµ Ï„Î¿ [**ÎµÏ€Î¯ÏƒÎ·Î¼Î¿ PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Î‘Î½Î±ÎºÎ±Î»ÏÏˆÏ„Îµ [**Ï„Î·Î½ ÎŸÎ¹ÎºÎ¿Î³Î­Î½ÎµÎ¹Î± PEASS**](https://opensea.io/collection/the-peass-family), Ï„Î· ÏƒÏ…Î»Î»Î¿Î³Î® Î¼Î±Ï‚ Î±Ï€ÏŒ Î±Ï€Î¿ÎºÎ»ÎµÎ¹ÏƒÏ„Î¹ÎºÎ¬ [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Î•Î³Î³ÏÎ±Ï†ÎµÎ¯Ï„Îµ** ÏƒÏ„Î·Î½ ğŸ’¬ [**Î¿Î¼Î¬Î´Î± Discord**](https://discord.gg/hRep4RUj7f) Î® ÏƒÏ„Î·Î½ [**Î¿Î¼Î¬Î´Î± Ï„Î·Î»ÎµÎ³ÏÎ±Ï†Î®Î¼Î±Ï„Î¿Ï‚**](https://t.me/peass) Î® **Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÏ„Îµ** Î¼Î±Ï‚ ÏƒÏ„Î¿ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **ÎœÎ¿Î¹ÏÎ±ÏƒÏ„ÎµÎ¯Ï„Îµ Ï„Î± Ï‡Î¬ÎºÎ¹Î½Î³Îº ÎºÏŒÎ»Ï€Î± ÏƒÎ±Ï‚ Ï…Ï€Î¿Î²Î¬Î»Î»Î¿Î½Ï„Î±Ï‚ PRs** ÏƒÏ„Î± [**HackTricks**](https://github.com/carlospolop/hacktricks) ÎºÎ±Î¹ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Î±Ï€Î¿Î¸ÎµÏ„Î®ÏÎ¹Î± Ï„Î¿Ï… github.

</details>

## Î’Î±ÏƒÎ¹ÎºÎ­Ï‚ Î Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚

Î“Î¹Î± Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎµÏ‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ ÏƒÏ‡ÎµÏ„Î¹ÎºÎ¬ Î¼Îµ Ï„Î¿ Ï„Î¹ ÎµÎ¯Î½Î±Î¹ Î­Î½Î± tcache bin ÎµÎ»Î­Î³Î¾Ï„Îµ Î±Ï…Ï„Î®Î½ Ï„Î· ÏƒÎµÎ»Î¯Î´Î±:

{% content-ref url="bins-and-memory-allocations.md" %}
[bins-and-memory-allocations.md](bins-and-memory-allocations.md)
{% endcontent-ref %}

ÎšÎ±Ï„Î±ÏÏ‡Î¬Ï‚, ÏƒÎ·Î¼ÎµÎ¹ÏÏƒÏ„Îµ ÏŒÏ„Î¹ Ï„Î¿ Tcache ÎµÎ¹ÏƒÎ®Ï‡Î¸Î· ÏƒÏ„Î·Î½ Î­ÎºÎ´Î¿ÏƒÎ· glibc 2.26.

Î— ÎµÏ€Î¯Î¸ÎµÏƒÎ· **Tcache** Ï€Î¿Ï… Ï€ÏÎ¿Ï„Î¬Î¸Î·ÎºÎµ ÏƒÏ„Î· [**ÏƒÎµÎ»Î¯Î´Î± guyinatuxido**](https://guyinatuxedo.github.io/29-tcache/tcache\_explanation/index.html) ÎµÎ¯Î½Î±Î¹ Ï€Î¿Î»Ï Ï€Î±ÏÏŒÎ¼Î¿Î¹Î± Î¼Îµ Ï„Î·Î½ ÎµÏ€Î¯Î¸ÎµÏƒÎ· fast bin ÏŒÏ€Î¿Ï… Î¿ ÏƒÏ„ÏŒÏ‡Î¿Ï‚ ÎµÎ¯Î½Î±Î¹ Î½Î± Î±Î½Ï„Î¹ÎºÎ±Ï„Î±ÏƒÏ„Î±Î¸ÎµÎ¯ Î¿ Î´ÎµÎ¯ÎºÏ„Î·Ï‚ Ï€ÏÎ¿Ï‚ Ï„Î¿ ÎµÏ€ÏŒÎ¼ÎµÎ½Î¿ Ï„Î¼Î®Î¼Î± ÏƒÏ„Î¿ bin Î¼Î­ÏƒÎ± ÏƒÎµ Î­Î½Î± ÎµÎ»ÎµÏÎ¸ÎµÏÎ¿ Ï„Î¼Î®Î¼Î± Î¼Îµ Î¼Î¹Î± Ï„Ï…Ï‡Î±Î¯Î± Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·, Î­Ï„ÏƒÎ¹ ÏÏƒÏ„Îµ Î±ÏÎ³ÏŒÏ„ÎµÏÎ± Î½Î± ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„Î® Î· **ÎµÎºÏ‡ÏÏÎ·ÏƒÎ· Î±Ï…Ï„Î®Ï‚ Ï„Î·Ï‚ ÏƒÏ…Î³ÎºÎµÎºÏÎ¹Î¼Î­Î½Î·Ï‚ Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·Ï‚ ÎºÎ±Î¹ ÎµÎ½Î´ÎµÏ‡Î¿Î¼Î­Î½Ï‰Ï‚ Î· Î±Î½Ï„Î¹ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· Î´ÎµÎ¹ÎºÏ„ÏÎ½**.

Î©ÏƒÏ„ÏŒÏƒÎ¿, ÏƒÎ®Î¼ÎµÏÎ±, Î±Î½ ÎµÎºÏ„ÎµÎ»Î­ÏƒÎµÏ„Îµ Ï„Î¿Î½ Î±Î½Î±Ï†ÎµÏÏŒÎ¼ÎµÎ½Î¿ ÎºÏÎ´Î¹ÎºÎ±, Î¸Î± Î»Î¬Î²ÎµÏ„Îµ Ï„Î¿ ÏƒÏ†Î¬Î»Î¼Î±: **`malloc(): unaligned tcache chunk detected`**. ÎˆÏ„ÏƒÎ¹, ÎµÎ¯Î½Î±Î¹ Î±Ï€Î±ÏÎ±Î¯Ï„Î·Ï„Î¿ Î½Î± Î³ÏÎ¬ÏˆÎµÏ„Îµ Ï‰Ï‚ Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· ÏƒÏ„Î¿Î½ Î½Î­Î¿ Î´ÎµÎ¯ÎºÏ„Î· Î¼Î¹Î± ÎµÏ…Î¸Ï…Î³ÏÎ±Î¼Î¼Î¹ÏƒÎ¼Î­Î½Î· Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· (Î® Î½Î± ÎµÎºÏ„ÎµÎ»Î­ÏƒÎµÏ„Îµ Î±ÏÎºÎµÏ„Î­Ï‚ Ï†Î¿ÏÎ­Ï‚ Ï„Î¿ Î´Ï…Î±Î´Î¹ÎºÏŒ Î±ÏÏ‡ÎµÎ¯Î¿ ÏÏƒÏ„Îµ Î· Î³ÏÎ±Î¼Î¼Î­Î½Î· Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· Î½Î± ÎµÎ¯Î½Î±Î¹ Ï€ÏÎ¬Î³Î¼Î±Ï„Î¹ ÎµÏ…Î¸Ï…Î³ÏÎ±Î¼Î¼Î¹ÏƒÎ¼Î­Î½Î·).

### Î•Ï€Î¯Î¸ÎµÏƒÎ· Î´ÎµÎ¹ÎºÏ„ÏÎ½ tcache indexes

Î£Ï…Î½Î®Î¸Ï‰Ï‚ ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒÎ½ Î½Î± Î²ÏÎµÎ¸ÎµÎ¯ ÏƒÏ„Î·Î½ Î±ÏÏ‡Î® Ï„Î·Ï‚ ÏƒÏ„Î¿Î¯Î²Î±Ï‚ Î­Î½Î± Ï„Î¼Î®Î¼Î± Ï€Î¿Ï… Ï€ÎµÏÎ¹Î­Ï‡ÎµÎ¹ Ï„Î¿Î½ **Î±ÏÎ¹Î¸Î¼ÏŒ Ï„Ï‰Î½ Ï„Î¼Î·Î¼Î¬Ï„Ï‰Î½ Î±Î½Î¬ Î´ÎµÎ¯ÎºÏ„Î·** Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ tcache ÎºÎ±Î¹ Ï„Î· Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· Ï„Î¿Ï… **ÎºÎµÏ†Î±Î»Î±Î¯Î¿Ï… Ï„Î¼Î®Î¼Î±Ï„Î¿Ï‚ ÎºÎ¬Î¸Îµ Î´ÎµÎ¯ÎºÏ„Î· tcache**. Î‘Î½ Î³Î¹Î± ÎºÎ¬Ï€Î¿Î¹Î¿ Î»ÏŒÎ³Î¿ ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒÎ½ Î½Î± Ï„ÏÎ¿Ï€Î¿Ï€Î¿Î¹Î·Î¸Î¿ÏÎ½ Î±Ï…Ï„Î­Ï‚ Î¿Î¹ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚, Î¸Î± Î®Ï„Î±Î½ Î´Ï…Î½Î±Ï„ÏŒ Î½Î± **ÎºÎ¬Î½ÎµÏ„Îµ Ï„Î¿ ÎºÎµÏ†Î¬Î»Î±Î¹Î¿ Ï„Î¼Î®Î¼Î± ÎºÎ¬Ï€Î¿Î¹Î¿Ï… Î´ÎµÎ¯ÎºÏ„Î· Î½Î± Î´ÎµÎ¯Ï‡Î½ÎµÎ¹ ÏƒÎµ Î¼Î¹Î± ÎµÏ€Î¹Î¸Ï…Î¼Î·Ï„Î® Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·** (ÏŒÏ€Ï‰Ï‚ Ï„Î¿ malloc hook) Î³Î¹Î± Î½Î± ÎµÎºÏ‡Ï‰ÏÎ·Î¸ÎµÎ¯ ÏƒÏ„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î± Î­Î½Î± Ï„Î¼Î®Î¼Î± Î¼ÎµÎ³Î­Î¸Î¿Ï…Ï‚ Ï„Î¿Ï… Î´ÎµÎ¯ÎºÏ„Î· ÎºÎ±Î¹ Î½Î± Î±Î½Ï„Î¹ÎºÎ±Ï„Î±ÏƒÏ„Î±Î¸Î¿ÏÎ½ Ï„Î± Ï€ÎµÏÎ¹ÎµÏ‡ÏŒÎ¼ÎµÎ½Î± Ï„Î¿Ï… malloc hook ÏƒÎµ Î±Ï…Ï„Î®Î½ Ï„Î·Î½ Ï€ÎµÏÎ¯Ï€Ï„Ï‰ÏƒÎ·.

## Examples

* CTF [https://guyinatuxedo.github.io/29-tcache/dcquals19\_babyheap/index.html](https://guyinatuxedo.github.io/29-tcache/dcquals19\_babyheap/index.html)
* **Libc info leak**: It's possible to fill the tcaches, add a chunk into the unsorted list, empty the tcache and **re-allocate the chunk from the unsorted bin** only overwriting the first 8B, leaving the **second address to libc from the chunk intact so we can read it**.
* **Tcache attack**: The binary is vulnerable a 1B heap overflow. This will be abuse to change the **size header** of an allocated chunk making it bigger. Then, this chunk will be **freed**, adding it to the tcache of chunks of the fake size. Then, we will allocate a chunk with the faked size, and the previous chunk will be **returned knowing that this chunk was actually smaller** and this grants up the opportunity to **overwrite the next chunk in memory**.\
We will abuse this to **overwrite the next chunk's FD pointer** to point to **`malloc_hook`**, so then its possible to alloc 2 pointers: first the legit pointer we just modified, and then the second allocation will return a chunk in **`malloc_hook`** that it's possible to abuse to write a **one gadget**.
* CTF [https://guyinatuxedo.github.io/29-tcache/plaid19\_cpp/index.html](https://guyinatuxedo.github.io/29-tcache/plaid19\_cpp/index.html)
* **Libc info leak**: There is a use after free and a double free. In this writeup the author leaked an address of libc by readnig the address of a chunk placed in a small bin (like leaking it from the unsorted bin but from the small one)
* **Tcache attack**: A Tcache is performed via a **double free**. The same chunk is freed twice, so inside the Tcache the chunk will point to itself. Then, it's allocated, its FD pointer is modified to point to the **free hook** and then it's allocated again so the next chunk in the list is going to be in the free hook. Then, this is also allocated and it's possible to write a the address of `system` here so when a malloc containing `"/bin/sh"` is freed we get a shell.
* CTF [https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps0/index.html](https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps0/index.html)
* The main vuln here is the capacity to `free` any address in the heap by indicating its offset
* **Tcache indexes attack**: It's possible to allocate and free a chunk of a size that when stored inside the tcache chunk (the chunk with the info of the tcache bins) will generate an **address with the value 0x100**. This is because the tcache stores the amount of chunks on each bin in different bytes, therefore one chunk in one specific index generates the value 0x100.
* Then, this value looks like there is a chunk of size 0x100. Allowing to abuse it by `free` this address. This will **add that address to the index of chunks of size 0x100 in the tcache**.
* Then, **allocating** a chunk of size **0x100**, the previous address will be returned as a chunk, allowing to overwrite other tcache indexes.\
For example putting the address of malloc hook in one of them and allocating a chunk of the size of that index will grant a chunk in calloc hook, which allows for writing a one gadget to get a s shell.
* CTF [https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps1/index.html](https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps1/index.html)
* Same vulnerability as before with one extra restriction
* **Tcache indexes attack**: Similar attack to the previous one but using less steps by **freeing the chunk that contains the tcache info** so it's address is added to the tcache index of its size so it's possible to allocate that size and get the tcache chunk info as a chunk, which allows to add free hook as the address of one index, alloc it, and write a one gadget on it.

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
