# Atak na nieposortowany blok

<details>

<summary><strong>Zacznij od zera i staÅ„ siÄ™ ekspertem od hakowania AWS dziÄ™ki</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) albo **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>

## Podstawowe informacje

Aby uzyskaÄ‡ wiÄ™cej informacji na temat tego, co oznacza nieposortowany blok, sprawdÅº tÄ™ stronÄ™:

{% content-ref url="bins-and-memory-allocations.md" %}
[bins-and-memory-allocations.md](bins-and-memory-allocations.md)
{% endcontent-ref %}

Nieposortowane listy mogÄ… zapisaÄ‡ adres w `unsorted_chunks (av)` w adresie `bk` fragmentu. Dlatego jeÅ›li atakujÄ…cy moÅ¼e **zmodyfikowaÄ‡ adres wskaÅºnika bk** w fragmencie wewnÄ…trz nieposortowanego bloku, moÅ¼e **zapisaÄ‡ ten adres w dowolnym adresie**, co moÅ¼e pomÃ³c w ujawnieniu adresÃ³w libc lub obejÅ›ciu niektÃ³rych zabezpieczeÅ„.

W zasadzie ten atak pozwala **nadpisaÄ‡ dowolny adres duÅ¼Ä… liczbÄ…** (adres, ktÃ³ry moÅ¼e byÄ‡ adresem sterty lub adresem libc), na przykÅ‚ad adresem stosu, ktÃ³ry moÅ¼e byÄ‡ ujawniony, lub ograniczeniem, takim jak globalna zmienna **`global_max_fast`**, aby umoÅ¼liwiÄ‡ tworzenie blokÃ³w fast bin o wiÄ™kszych rozmiarach (i przejÅ›cie od ataku na nieposortowany blok do ataku na fast bin).

{% hint style="success" %}
Przyjrzyjmy siÄ™ przykÅ‚adowi podanemu w [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#principle](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#principle) i uÅ¼yjmy wartoÅ›ci 0x4000 i 0x5000 zamiast 0x400 i 0x500 jako rozmiarÃ³w fragmentÃ³w (aby uniknÄ…Ä‡ tcaches), moÅ¼na zobaczyÄ‡, Å¼e **obecnie** bÅ‚Ä…d **`malloc(): unsorted double linked list corrupted`** jest wywoÅ‚ywany.

Dlatego ten atak na nieposortowany blok teraz (oprÃ³cz innych sprawdzeÅ„) wymaga rÃ³wnieÅ¼ naprawienia zduplikowanej listy poÅ‚Ä…czonej, aby to ominÄ…Ä‡ `victim->bck->fd == victim` lub nie `victim->fd == av (arena)`. Oznacza to, Å¼e adres, w ktÃ³ry chcemy zapisaÄ‡, musi mieÄ‡ adres faÅ‚szywego fragmentu w swojej pozycji `fd`, a faÅ‚szywy fragment `fd` wskazuje na arenÄ™.
{% endhint %}

{% hint style="danger" %}
ZauwaÅ¼, Å¼e ten atak psuje nieposortowany blok (a takÅ¼e maÅ‚y i duÅ¼y). Dlatego teraz moÅ¼emy **korzystaÄ‡ tylko z alokacji z blokÃ³w fast bin** (bardziej zÅ‚oÅ¼ony program moÅ¼e wykonywaÄ‡ inne alokacje i siÄ™ zawiesiÄ‡), a aby to wywoÅ‚aÄ‡, musimy **zaalokowaÄ‡ ten sam rozmiar, inaczej program siÄ™ zawiesi.**

ZauwaÅ¼, Å¼e ustawienie **`global_max_fast`** moÅ¼e pomÃ³c w tym przypadku, zakÅ‚adajÄ…c, Å¼e fast bin bÄ™dzie w stanie obsÅ‚uÅ¼yÄ‡ wszystkie inne alokacje, dopÃ³ki exploit nie zostanie zakoÅ„czony.
{% endhint %}

Kod od [**guyinatuxedo**](https://guyinatuxedo.github.io/31-unsortedbin\_attack/unsorted\_explanation/index.html) dobrze to wyjaÅ›nia, chociaÅ¼ jeÅ›li zmodyfikujesz alokacje pamiÄ™ci tak, aby alokowaÄ‡ pamiÄ™Ä‡ wystarczajÄ…co duÅ¼Ä…, aby nie trafiÄ‡ do tcaches, zobaczysz, Å¼e wczeÅ›niej wspomniany bÅ‚Ä…d uniemoÅ¼liwia zastosowanie tej techniki: **`malloc(): unsorted double linked list corrupted`**

## Atak na nieposortowany blok wyciek informacji

To tak naprawdÄ™ bardzo podstawowe pojÄ™cie. Fragmenty w nieposortowanym bloku bÄ™dÄ… miaÅ‚y wskaÅºniki podwÃ³jne wskaÅºniki, aby utworzyÄ‡ blok. Pierwszy fragment w nieposortowanym bloku bÄ™dzie faktycznie mieÄ‡ **FD** i **BK** wskazujÄ…ce na czÄ™Å›Ä‡ gÅ‚Ã³wnej areny (libc).\
Dlatego jeÅ›li moÅ¼esz **umieÅ›ciÄ‡ fragment wewnÄ…trz nieposortowanego bloku i odczytaÄ‡ go** (uÅ¼yj po zwolnieniu) lub **ponownie go zaalokowaÄ‡ bez nadpisywania co najmniej 1 z wskaÅºnikÃ³w**, aby nastÄ™pnie go **odczytaÄ‡**, moÅ¼esz uzyskaÄ‡ **wyciek informacji z libc**.

Podobny [**atak uÅ¼yty w tym opisie**](https://guyinatuxedo.github.io/33-custom\_misc\_heap/csaw18\_alienVSsamurai/index.html), polegaÅ‚ na naduÅ¼yciu struktury 4 fragmentÃ³w (A, B, C i D - D sÅ‚uÅ¼yÅ‚ tylko do zapobieÅ¼enia konsolidacji z gÅ‚Ã³wnym fragmentem). NastÄ™pnie uÅ¼yto przepeÅ‚nienia bajtami zerowymi w B, aby sprawiÄ‡, Å¼e C wskaÅ¼e, Å¼e B jest nieuÅ¼ywany. Ponadto w B zmodyfikowano dane `prev_size`, wiÄ™c rozmiar zamiast byÄ‡ rozmiarem B, byÅ‚ A+B.\
NastÄ™pnie C zostaÅ‚ zwolniony i skonsolidowany z A+B (ale B nadal byÅ‚ uÅ¼ywany). Zaalokowano nowy fragment o rozmiarze A, a nastÄ™pnie wyciekÅ‚y adresy libc zostaÅ‚y zapisane do B, skÄ…d zostaÅ‚y wyciekniÄ™te.

## OdwoÅ‚ania i inne przykÅ‚ady

* [**https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#hitcon-training-lab14-magic-heap**](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#hitcon-training-lab14-magic-heap)
* Celem jest nadpisanie zmiennej globalnej wartoÅ›ciÄ… wiÄ™kszÄ… niÅ¼ 4869, aby uzyskaÄ‡ flagÄ™, a PIE nie jest wÅ‚Ä…czone.
* MoÅ¼liwe jest generowanie fragmentÃ³w o dowolnych rozmiarach i wystÄ™puje przepeÅ‚nienie sterty o poÅ¼Ä…danym rozmiarze.
* Atak rozpoczyna siÄ™ od utworzenia 3 fragmentÃ³w: fragmentu0 do naduÅ¼ycia przepeÅ‚nienia, fragmentu1 do przepeÅ‚nienia i fragmentu2, aby gÅ‚Ã³wny fragment nie konsolidowaÅ‚ poprzednich.
* NastÄ™pnie fragment1 jest zwalniany, a fragment0 jest przepeÅ‚niany, aby wskaÅºnik bk fragmentu1 wskazywaÅ‚ na: `bk = magic - 0x10`
* NastÄ™pnie zaalokowany jest fragment3 o tym samym rozmiarze co fragment1, co spowoduje atak na nieposortowany blok i zmodyfikuje wartoÅ›Ä‡ zmiennej globalnej, umoÅ¼liwiajÄ…c uzyskanie flagi.
* [**https://guyinatuxedo.github.io/31-unsortedbin\_attack/0ctf16\_zerostorage/index.html**](https://guyinatuxedo.github.io/31-unsortedbin\_attack/0ctf16\_zerostorage/index.html)
* Funkcja Å‚Ä…czenia jest podatna, poniewaÅ¼ jeÅ›li oba przekazane indeksy sÄ… takie same, to zrealokuje na nim i zwolni go, ale zwrÃ³ci wskaÅºnik do tego zwolnionego obszaru, ktÃ³ry moÅ¼na wykorzystaÄ‡.
* Dlatego **tworzone sÄ… 2 fragmenty**: **fragment0**, ktÃ³ry zostanie poÅ‚Ä…czony sam ze sobÄ… i fragment1, aby zapobiec konsolidacji z gÅ‚Ã³wnym fragmentem. NastÄ™pnie funkcja **merge jest wywoÅ‚ywana z fragmentem0** dwukrotnie, co spowoduje uÅ¼ycie po zwolnieniu.
* NastÄ™pnie wywoÅ‚ywana jest funkcja **`view`** z indeksem 2 (ktÃ³ry jest indeksem uÅ¼ytego po zwolnieniu fragmentu), co spowoduje **wyciek adresu libc**.
* PoniewaÅ¼ binarny ma zabezpieczenia, aby alokowaÄ‡ tylko rozmiary wiÄ™ksze niÅ¼ **`global_max_fast`**, wiÄ™c nie uÅ¼ywany jest fastbin, atak na nieposortowany blok zostanie wykorzystany do nadpisania zmiennej globalnej `global_max_fast`.
* NastÄ™pnie moÅ¼liwe jest wywoÅ‚anie funkcji edycji z indeksem 2 (wskaÅºnik uÅ¼yty po zwolnieniu) i nadpisanie wskaÅºnika `bk`, aby wskazywaÅ‚ na `p64(global_max_fast-0x10)`. NastÄ™pnie tworzÄ…c nowy fragment uÅ¼yje siÄ™ wczeÅ›niej skompromitowanego adresu zwolnienia (0x20), co **spowoduje atak na nieposortowany blok**, nadpisujÄ…c `global_max_fast` duÅ¼Ä… wartoÅ›ciÄ…, umoÅ¼liwiajÄ…c teraz tworzenie fragmentÃ³w w fast binach.
* Teraz wykonywany jest **atak na fast bin**:
* Po pierwsze odkryto, Å¼e moÅ¼liwe jest pracowanie z szybkimi **fragmentami o rozmiarze 200** w lokalizacji **`__free_hook`**:
* <pre class="language-c"><code class="lang-c">gefâ¤  p &#x26;__free_hook
$1 = (void (**)(void *, const void *)) 0x7ff1e9e607a8 &#x3C;__free_hook>
gefâ¤  x/60gx 0x7ff1e9e607a8 - 0x59
<strong>0x7ff1e9e6074f: 0x0000000000000000      0x0000000000000200
</strong>0x7ff1e9e6075f: 0x0000000000000000      0x0000000000000000
0x7ff1e9e6076f &#x3C;list_all_lock+15>:      0x0000000000000000      0x0000000000000000
0x7ff1e9e6077f &#x3C;_IO_stdfile_2_lock+15>: 0x0000000000000000      0x0000000000000000
</code></pre>
* JeÅ›li uda nam siÄ™ uzyskaÄ‡ szybki kawaÅ‚ek o rozmiarze 0x200 w tej lokalizacji, bÄ™dzie moÅ¼liwe nadpisanie wskaÅºnika funkcji, ktÃ³ry zostanie wykonany
* W tym celu tworzony jest nowy kawaÅ‚ek o rozmiarze `0xfc` i funkcja scalajÄ…ca jest wywoÅ‚ywana z tym wskaÅºnikiem dwukrotnie, w ten sposÃ³b uzyskujemy wskaÅºnik do zwolnionego kawaÅ‚ka o rozmiarze `0xfc*2 = 0x1f8` w szybkim binie.
* NastÄ™pnie funkcja edycji jest wywoÅ‚ywana w tym kawaÅ‚ku, aby zmodyfikowaÄ‡ adres **`fd`** tego szybkiego bina tak, aby wskazywaÅ‚ na poprzedniÄ… funkcjÄ™ **`__free_hook`**.
* NastÄ™pnie tworzony jest kawaÅ‚ek o rozmiarze `0x1f8`, aby pobraÄ‡ z szybkiego bina poprzedni nieuÅ¼yteczny kawaÅ‚ek, wiÄ™c tworzony jest kolejny kawaÅ‚ek o rozmiarze `0x1f8`, aby uzyskaÄ‡ kawaÅ‚ek z szybkiego bina w **`__free_hook`**, ktÃ³ry jest nadpisany adresem funkcji **`system`**.
* I wreszcie zwalniany jest kawaÅ‚ek zawierajÄ…cy ciÄ…g znakÃ³w `/bin/sh\x00`, wywoÅ‚ujÄ…c funkcjÄ™ usuwania, co powoduje wywoÅ‚anie funkcji **`__free_hook`**, ktÃ³ra wskazuje na system z `/bin/sh\x00` jako parametrem.
* **CTF** [**https://guyinatuxedo.github.io/33-custom\_misc\_heap/csaw19\_traveller/index.html**](https://guyinatuxedo.github.io/33-custom\_misc\_heap/csaw19\_traveller/index.html)
* Kolejny przykÅ‚ad naduÅ¼ycia przepeÅ‚nienia o 1B w celu skonsolidowania kawaÅ‚kÃ³w w nieuporzÄ…dkowanym binie, uzyskania wycieku informacji o libc, a nastÄ™pnie przeprowadzenia ataku na szybki bin w celu nadpisania haka malloc adresem jednego gadÅ¼etu

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF** SprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFTÃ³w**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**Grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
