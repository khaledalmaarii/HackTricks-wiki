# æœªæ’åº Bin æ”»å‡»

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS çº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨ HackTricks ä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½ PDF ç‰ˆæœ¬çš„ HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ä¸Šå…³æ³¨æˆ‘ä»¬ ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã€‚**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## åŸºæœ¬ä¿¡æ¯

æœ‰å…³æœªæ’åº Bin æ˜¯ä»€ä¹ˆçš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹æ­¤é¡µé¢ï¼š

{% content-ref url="bins-and-memory-allocations.md" %}
[bins-and-memory-allocations.md](bins-and-memory-allocations.md)
{% endcontent-ref %}

æœªæ’åºåˆ—è¡¨èƒ½å¤Ÿå°†åœ°å€å†™å…¥åˆ°å—çš„ `bk` åœ°å€ä¸­çš„ `unsorted_chunks (av)`ã€‚å› æ­¤ï¼Œå¦‚æœæ”»å‡»è€…èƒ½å¤Ÿ**ä¿®æ”¹æœªæ’åº Bin ä¸­å—å†…çš„ bk æŒ‡é’ˆçš„åœ°å€**ï¼Œä»–å°±èƒ½å¤Ÿ**å°†è¯¥åœ°å€å†™å…¥åˆ°ä»»æ„åœ°å€**ï¼Œè¿™æœ‰åŠ©äºæ³„æ¼ libc åœ°å€æˆ–ç»•è¿‡æŸäº›é˜²å¾¡ã€‚

å› æ­¤ï¼ŒåŸºæœ¬ä¸Šï¼Œè¿™ç§æ”»å‡»å…è®¸**ç”¨ä¸€ä¸ªå¤§æ•°å€¼è¦†ç›–ä¸€äº›ä»»æ„åœ°å€**ï¼ˆä¸€ä¸ªå¯èƒ½æ˜¯å †åœ°å€æˆ– libc åœ°å€çš„åœ°å€ï¼‰ï¼Œæ¯”å¦‚ä¸€äº›å¯èƒ½ä¼šæ³„æ¼çš„å †åœ°å€æˆ–ä¸€äº›é™åˆ¶ï¼Œæ¯”å¦‚å…¨å±€å˜é‡ **`global_max_fast`**ï¼Œä»¥å…è®¸åˆ›å»ºæ›´å¤§å°ºå¯¸çš„å¿«é€Ÿ Bin å—ï¼ˆä»æœªæ’åº Bin æ”»å‡»è½¬å˜ä¸ºå¿«é€Ÿ Bin æ”»å‡»ï¼‰ã€‚

{% hint style="success" %}
æŸ¥çœ‹ [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#principle](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#principle) ä¸­æä¾›çš„ç¤ºä¾‹ï¼Œå¹¶ä½¿ç”¨ 0x4000 å’Œ 0x5000 ä»£æ›¿ 0x400 å’Œ 0x500 ä½œä¸ºå—å¤§å°ï¼ˆä»¥é¿å… tcachesï¼‰ï¼Œå¯ä»¥çœ‹åˆ°**ç°åœ¨**è§¦å‘é”™è¯¯ **`malloc(): unsorted double linked list corrupted`**ã€‚

å› æ­¤ï¼Œè¿™ç§æœªæ’åº Bin æ”»å‡»ç°åœ¨ï¼ˆé™¤å…¶ä»–æ£€æŸ¥å¤–ï¼‰è¿˜éœ€è¦èƒ½å¤Ÿä¿®å¤åŒé‡é“¾æ¥åˆ—è¡¨ï¼Œä»¥ä¾¿ç»•è¿‡ `victim->bck->fd == victim` æˆ–ä¸æ˜¯ `victim->fd == av (arena)`ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬æƒ³è¦å†™å…¥çš„åœ°å€å¿…é¡»åœ¨å…¶ `fd` ä½ç½®å…·æœ‰ä¼ªé€ å—çš„åœ°å€ï¼Œå¹¶ä¸”ä¼ªé€ å—çš„ `fd` æŒ‡å‘ arenaã€‚
{% endhint %}

{% hint style="danger" %}
è¯·æ³¨æ„ï¼Œæ­¤æ”»å‡»ä¼šç ´åæœªæ’åº Binï¼ˆå› æ­¤ä¹Ÿä¼šç ´åå°å—å’Œå¤§å—ï¼‰ã€‚å› æ­¤ï¼Œæˆ‘ä»¬ç°åœ¨åªèƒ½**ä½¿ç”¨å¿«é€Ÿ Bin ä¸­çš„åˆ†é…**ï¼ˆæ›´å¤æ‚çš„ç¨‹åºå¯èƒ½ä¼šè¿›è¡Œå…¶ä»–åˆ†é…å¹¶å´©æºƒï¼‰ï¼Œè¦è§¦å‘æ­¤æ”»å‡»ï¼Œæˆ‘ä»¬å¿…é¡»**åˆ†é…ç›¸åŒå¤§å°çš„å—ï¼Œå¦åˆ™ç¨‹åºå°†å´©æºƒ**ã€‚

è¯·æ³¨æ„ï¼Œä½¿ **`global_max_fast`** å¯èƒ½ä¼šåœ¨è¿™ç§æƒ…å†µä¸‹æœ‰æ‰€å¸®åŠ©ï¼Œç›¸ä¿¡å¿«é€Ÿ Bin å°†èƒ½å¤Ÿå¤„ç†ç›´åˆ°åˆ©ç”¨å®Œæˆçš„æ‰€æœ‰å…¶ä»–åˆ†é…ã€‚
{% endhint %}

æ¥è‡ª [**guyinatuxedo**](https://guyinatuxedo.github.io/31-unsortedbin\_attack/unsorted\_explanation/index.html) çš„ä»£ç å¾ˆå¥½åœ°è§£é‡Šäº†è¿™ä¸€ç‚¹ï¼Œå°½ç®¡å¦‚æœæ‚¨ä¿®æ”¹ malloc åˆ†é…çš„å†…å­˜å¤§å°è¶³å¤Ÿå¤§ï¼Œä»¥é¿å… tcacheï¼Œæ‚¨ä¼šå‘ç°å…ˆå‰æåˆ°çš„é”™è¯¯å‡ºç°ï¼Œé˜»æ­¢äº†è¿™ç§æŠ€æœ¯ï¼š**`malloc(): unsorted double linked list corrupted`**

## å‚è€ƒèµ„æ–™å’Œå…¶ä»–ç¤ºä¾‹

* [**https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#hitcon-training-lab14-magic-heap**](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#hitcon-training-lab14-magic-heap)
* ç›®æ ‡æ˜¯ç”¨å¤§äº 4869 çš„å€¼è¦†ç›–ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œä»¥ä¾¿è·å–æ ‡å¿—ï¼Œä¸”æœªå¯ç”¨ PIEã€‚
* å¯ä»¥ç”Ÿæˆä»»æ„å¤§å°çš„å—ï¼Œå¹¶ä¸”æœ‰æ‰€éœ€å¤§å°çš„å †æº¢å‡ºã€‚
* æ”»å‡»å¼€å§‹åˆ›å»º 3 ä¸ªå—ï¼šchunk0 ç”¨äºåˆ©ç”¨æº¢å‡ºï¼Œchunk1 ç”¨äºæº¢å‡ºï¼Œchunk2 ä»¥é˜²æ­¢é¡¶éƒ¨å—åˆå¹¶å‰ä¸¤ä¸ªå—ã€‚
* ç„¶åï¼Œé‡Šæ”¾ chunk1ï¼Œå¹¶å°† chunk0 æº¢å‡ºåˆ° chunk1 çš„ `bk` æŒ‡é’ˆï¼Œä½¿å¾— `bk = magic - 0x10`ã€‚
* ç„¶åï¼Œåˆ†é…ä¸ chunk1 ç›¸åŒå¤§å°çš„ chunk3ï¼Œè¿™å°†è§¦å‘æœªæ’åº Bin æ”»å‡»ï¼Œå¹¶ä¿®æ”¹å…¨å±€å˜é‡çš„å€¼ï¼Œä»è€Œå¯èƒ½è·å–æ ‡å¿—ã€‚
* [**https://guyinatuxedo.github.io/31-unsortedbin\_attack/0ctf16\_zerostorage/index.html**](https://guyinatuxedo.github.io/31-unsortedbin\_attack/0ctf16\_zerostorage/index.html)
* åˆå¹¶å‡½æ•°å­˜åœ¨æ¼æ´ï¼Œå› ä¸ºå¦‚æœä¼ é€’çš„ä¸¤ä¸ªç´¢å¼•ç›¸åŒï¼Œå®ƒå°†å¯¹å…¶è¿›è¡Œé‡æ–°åˆ†é…ï¼Œç„¶åé‡Šæ”¾å®ƒï¼Œä½†è¿”å›ä¸€ä¸ªå¯ä»¥ä½¿ç”¨çš„å·²é‡Šæ”¾åŒºåŸŸçš„æŒ‡é’ˆã€‚
* å› æ­¤ï¼Œ**åˆ›å»º 2 ä¸ªå—**ï¼š**chunk0** å°†ä¸è‡ªèº«åˆå¹¶ï¼Œchunk1 ç”¨äºé˜²æ­¢ä¸é¡¶éƒ¨å—åˆå¹¶ã€‚ç„¶åï¼Œä¸¤æ¬¡è°ƒç”¨åˆå¹¶å‡½æ•°ä¸ chunk0ï¼Œè¿™å°†å¯¼è‡´ä½¿ç”¨åé‡Šæ”¾ã€‚
* ç„¶åï¼Œè°ƒç”¨ **`view`** å‡½æ•°ï¼Œç´¢å¼•ä¸º 2ï¼ˆä½¿ç”¨åé‡Šæ”¾å—çš„ç´¢å¼•ï¼‰ï¼Œè¿™å°†**æ³„æ¼ä¸€ä¸ª libc åœ°å€**ã€‚
* ç”±äºäºŒè¿›åˆ¶æ–‡ä»¶åªå…è®¸ malloc å¤§äº **`global_max_fast`** çš„å¤§å°ï¼Œå› æ­¤ä¸ä½¿ç”¨ fastbinï¼Œå°†ä½¿ç”¨æœªæ’åº Bin æ”»å‡»æ¥è¦†ç›–å…¨å±€å˜é‡ `global_max_fast`ã€‚
* ç„¶åï¼Œå¯ä»¥ä½¿ç”¨ç´¢å¼• 2ï¼ˆä½¿ç”¨åé‡Šæ”¾æŒ‡é’ˆï¼‰è°ƒç”¨ç¼–è¾‘å‡½æ•°ï¼Œå¹¶å°† `bk` æŒ‡é’ˆè¦†ç›–ä¸ºæŒ‡å‘ `p64(global_max_fast-0x10)`ã€‚ç„¶åï¼Œåˆ›å»ºä¸€ä¸ªæ–°å—å°†ä½¿ç”¨å…ˆå‰å—æŸçš„é‡Šæ”¾åœ°å€ï¼ˆ0x20ï¼‰å°†**è§¦å‘æœªæ’åº Bin æ”»å‡»**ï¼Œè¦†ç›– `global_max_fast` ä¸ºä¸€ä¸ªéå¸¸å¤§çš„å€¼ï¼Œç°åœ¨å¯ä»¥åœ¨å¿«é€Ÿ Bin ä¸­åˆ›å»ºå—ã€‚
* ç°åœ¨æ‰§è¡Œ**å¿«é€Ÿ Bin æ”»å‡»**ï¼š
* é¦–å…ˆå‘ç°å¯ä»¥åœ¨ **`__free_hook`** ä½ç½®ä½¿ç”¨å¤§å°ä¸º 200 çš„å¿«é€Ÿ **å—**ï¼š
* <pre class="language-c"><code class="lang-c">gefâ¤  p &#x26;__free_hook
$1 = (void (**)(void *, const void *)) 0x7ff1e9e607a8 &#x3C;__free_hook>
gefâ¤  x/60gx 0x7ff1e9e607a8 - 0x59
<strong>0x7ff1e9e6074f: 0x0000000000000000      0x0000000000000200
</strong>0x7ff1e9e6075f: 0x0000000000000000      0x0000000000000000
0x7ff1e9e6076f &#x3C;list_all_lock+15>:      0x0000000000000000      0x0000000000000000
0x7ff1e9e6077f &#x3C;_IO_stdfile_2_lock+15>: 0x0000000000000000      0x0000000000000000
</code></pre>
* å¦‚æœæˆ‘ä»¬è®¾æ³•åœ¨æ­¤ä½ç½®è·å¾—å¤§å°ä¸º 0x200 çš„å¿«é€Ÿå—ï¼Œå°±å¯ä»¥è¦†ç›–å°†æ‰§è¡Œçš„å‡½æ•°æŒ‡é’ˆ
* ä¸ºæ­¤ï¼Œåˆ›å»ºå¤§å°ä¸º `0xfc` çš„æ–°å—ï¼Œå¹¶ä¸¤æ¬¡è°ƒç”¨åˆå¹¶å‡½æ•°ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è·å¾—ä¸€ä¸ªå¤§å°ä¸º `0xfc*2 = 0x1f8` çš„å·²é‡Šæ”¾å—çš„æŒ‡é’ˆåœ¨å¿«é€Ÿ Bin ä¸­ã€‚
* ç„¶åï¼Œåœ¨æ­¤å—ä¸­è°ƒç”¨ç¼–è¾‘å‡½æ•°ä»¥ä¿®æ”¹æ­¤å¿«é€Ÿ Bin çš„ **`fd`** åœ°å€ï¼Œä½¿å…¶æŒ‡å‘å…ˆå‰çš„ **`__free_hook`** å‡½æ•°ã€‚
* ç„¶åï¼Œåˆ›å»ºä¸€ä¸ªå¤§å°ä¸º`0x1f8`çš„å—ï¼Œä»¥ä»å¿«é€Ÿåˆ†é…åŒºåŸŸä¸­æ£€ç´¢å…ˆå‰æ— ç”¨çš„å—ï¼Œç„¶ååˆ›å»ºå¦ä¸€ä¸ªå¤§å°ä¸º`0x1f8`çš„å—ï¼Œä»¥åœ¨**`__free_hook`**ä¸­è·å–ä¸€ä¸ªå¿«é€Ÿåˆ†é…åŒºåŸŸå—ï¼Œè¯¥å—è¢«è¦†ç›–ä¸º**`system`**å‡½æ•°çš„åœ°å€ã€‚
* æœ€åï¼Œé‡Šæ”¾ä¸€ä¸ªåŒ…å«å­—ç¬¦ä¸²`/bin/sh\x00`çš„å—ï¼Œè°ƒç”¨åˆ é™¤å‡½æ•°ï¼Œè§¦å‘æŒ‡å‘å¸¦æœ‰`/bin/sh\x00`ä½œä¸ºå‚æ•°çš„`system`çš„**`__free_hook`**å‡½æ•°ã€‚

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ–åœ¨**Twitter**ä¸Šå…³æ³¨æˆ‘ä»¬ ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
