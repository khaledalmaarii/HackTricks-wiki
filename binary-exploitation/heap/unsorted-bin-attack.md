# SÄ±ralanmamÄ±ÅŸ Bin SaldÄ±rÄ±sÄ±

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sÄ±fÄ±rdan kahramana kadar AWS hacklemeyi Ã¶ÄŸrenin!</summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)'da takip edin.
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na PR gÃ¶ndererek katkÄ±da bulunun.

</details>

## Temel Bilgiler

SÄ±ralanmamÄ±ÅŸ bir liste, bir parÃ§anÄ±n `bk` adresindeki `unsorted_chunks (av)` adresini yazabilmektedir. Bu nedenle, bir saldÄ±rgan bir parÃ§adaki `bk` iÅŸaretÃ§isinin adresini deÄŸiÅŸtirebilirse, bu adresi rastgele bir adrese yazabilir ve bu, bir libc adresini sÄ±zdÄ±rmak veya bazÄ± savunmalarÄ± atlamak iÃ§in yardÄ±mcÄ± olabilir.

Yani, temelde bu saldÄ±rÄ±, bir saldÄ±rganÄ±n **bazÄ± keyfi adresleri bÃ¼yÃ¼k bir sayÄ±yla** (bir heap adresi veya bir libc adresi olabilecek bir adres) Ã¼zerine yazmasÄ±na izin verir, bu da sÄ±zdÄ±rmak isteyebileceÄŸi bir yÄ±ÄŸÄ±n adresi veya global deÄŸiÅŸken **`global_max_fast`** gibi bir kÄ±sÄ±tlamayÄ± geÃ§mesine olanak tanÄ±r (ve sÄ±ralanmamÄ±ÅŸ bir bin saldÄ±rÄ±sÄ±ndan hÄ±zlÄ± bir bin saldÄ±rÄ±sÄ±na geÃ§mesine izin verir).

{% hint style="success" %}
[https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#principle](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#principle) adresinde saÄŸlanan Ã¶rneÄŸe bakarak ve 0x400 ve 0x500 yerine 0x4000 ve 0x5000'i kullanarak (tcaches'i Ã¶nlemek iÃ§in) **gÃ¼nÃ¼mÃ¼zde** artÄ±k hata **`malloc(): unsorted double linked list corrupted`** tetiklenmektedir.

Bu nedenle, bu sÄ±ralanmamÄ±ÅŸ bin saldÄ±rÄ±sÄ± artÄ±k (diÄŸer kontroller arasÄ±nda) Ã§ift baÄŸlÄ± listeyi dÃ¼zeltme yeteneÄŸine de sahip olmalÄ±dÄ±r, bÃ¶ylece bu, `victim->bck->fd == victim` veya `victim->fd == av (arena)` olmalÄ±dÄ±r. Bu, yazmak istediÄŸimiz adresin, sahte parÃ§anÄ±n `fd` konumunda olmasÄ± gerektiÄŸi ve sahte parÃ§anÄ±n `fd`nin arenaya iÅŸaret etmesi gerektiÄŸi anlamÄ±na gelir.
{% endhint %}

{% hint style="danger" %}
Bu saldÄ±rÄ±nÄ±n sÄ±ralanmamÄ±ÅŸ bin'i bozduÄŸunu (bu nedenle kÃ¼Ã§Ã¼k ve bÃ¼yÃ¼k de) unutmayÄ±n. Bu nedenle ÅŸimdi sadece **hÄ±zlÄ± binlerden tahsisler kullanabiliriz** (daha karmaÅŸÄ±k bir program baÅŸka tahsisler yapabilir ve Ã§Ã¶kebilir) ve bunu tetiklemek iÃ§in **aynÄ± boyutta tahsis yapmalÄ±yÄ±z veya program Ã§Ã¶kecektir.**

Bu durumda **`global_max_fast`** yapmak, hÄ±zlÄ± binin tÃ¼m diÄŸer tahsislerle ilgileneceÄŸine gÃ¼venmek bu durumda yardÄ±mcÄ± olabilir ve saldÄ±rÄ± tamamlandÄ±ÄŸÄ±nda.
{% endhint %}

[**guyinatuxedo**](https://guyinatuxedo.github.io/31-unsortedbin\_attack/unsorted\_explanation/index.html) tarafÄ±ndan saÄŸlanan kod bunu Ã§ok iyi aÃ§Ä±klÄ±yor, ancak malloc'larÄ± tcache'e sona ermeyecek kadar bÃ¼yÃ¼k bir bellek ayÄ±rmak iÃ§in deÄŸiÅŸtirirseniz, Ã¶nce bahsedilen hata ortaya Ã§Ä±kar ve bu tekniÄŸi engeller: **`malloc(): unsorted double linked list corrupted`**

## Referanslar ve DiÄŸer Ã–rnekler

* [**https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#hitcon-training-lab14-magic-heap**](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#hitcon-training-lab14-magic-heap)
* AmacÄ±, PIE etkin olmayan bir global deÄŸiÅŸkeni 4869'dan bÃ¼yÃ¼k bir deÄŸerle deÄŸiÅŸtirmektir, bÃ¶ylece bayraÄŸÄ± almak mÃ¼mkÃ¼n olur.
* Keyfi boyutlarda parÃ§alar oluÅŸturulabilir ve istenilen boyutta bir heap taÅŸmasÄ± vardÄ±r.
* SaldÄ±rÄ±, taÅŸmanÄ±n kÃ¶tÃ¼ye kullanÄ±lmasÄ± iÃ§in chunk0, taÅŸmanÄ±n gerÃ§ekleÅŸeceÄŸi chunk1 ve Ã¶nceki parÃ§alarÄ±n birleÅŸtirilmesini Ã¶nlemek iÃ§in chunk2 oluÅŸturularak baÅŸlar.
* ArdÄ±ndan, chunk1 serbest bÄ±rakÄ±lÄ±r ve chunk0 taÅŸmaya uÄŸratÄ±lÄ±r, bÃ¶ylece chunk1'in `bk` iÅŸaretÃ§isi ÅŸuna iÅŸaret eder: `bk = magic - 0x10`
* Daha sonra, chunk1 ile aynÄ± boyutta chunk3 tahsis edilir, bu da sÄ±ralanmamÄ±ÅŸ bin saldÄ±rÄ±sÄ±nÄ± tetikler ve global deÄŸiÅŸkenin deÄŸerini deÄŸiÅŸtirir, bayraÄŸÄ± almayÄ± mÃ¼mkÃ¼n kÄ±lar.
* [**https://guyinatuxedo.github.io/31-unsortedbin\_attack/0ctf16\_zerostorage/index.html**](https://guyinatuxedo.github.io/31-unsortedbin\_attack/0ctf16\_zerostorage/index.html)
* BirleÅŸtirme iÅŸlevi savunmasÄ±zdÄ±r Ã§Ã¼nkÃ¼ geÃ§ilen her iki dizin de aynÄ±ysa onu yeniden boyutlandÄ±rÄ±r ve ardÄ±ndan serbest bÄ±rakÄ±r ancak kullanÄ±labilecek bir serbest bÄ±rakÄ±lmÄ±ÅŸ bÃ¶lgeye bir iÅŸaretÃ§i dÃ¶ndÃ¼rÃ¼r.
* Bu nedenle, **2 parÃ§a oluÅŸturulur**: **chunk0** kendisiyle birleÅŸtirilecek ve Ã¼st parÃ§ayla birleÅŸmesini Ã¶nlemek iÃ§in chunk1. ArdÄ±ndan, **birleÅŸtirme iÅŸlevi chunk0 ile iki kez Ã§aÄŸrÄ±lÄ±r**, bu da bir kullanÄ±mdan sonra serbest bÄ±rakma hatasÄ±na neden olur.
* Daha sonra, **`view`** iÅŸlevi kullanÄ±mdan sonra serbest bÄ±rakÄ±lan parÃ§anÄ±n dizini olan 2 ile Ã§aÄŸrÄ±lÄ±r, bu da bir libc adresi sÄ±zdÄ±rÄ±r.
* Binary, sadece **`global_max_fast`**'tan bÃ¼yÃ¼k boyutlarda malloc yapmasÄ±na izin veren korumalara sahip olduÄŸundan hiÃ§bir fastbin kullanÄ±lmaz, bu nedenle sÄ±ralanmamÄ±ÅŸ bin saldÄ±rÄ±sÄ±, global deÄŸiÅŸken `global_max_fast`'Ä±n Ã¼zerine yazÄ±lmasÄ±nda kullanÄ±lacaktÄ±r.
* Daha sonra, kullanÄ±m hakkÄ± olan dizin 2 (kullanÄ±mdan sonra serbest bÄ±rakÄ±lan iÅŸaretÃ§i) ile edit iÅŸlevi Ã§aÄŸrÄ±lÄ±r ve `bk` iÅŸaretÃ§isinin `p64(global_max_fast-0x10)`'a iÅŸaret etmesi saÄŸlanÄ±r. ArdÄ±ndan, yeni bir parÃ§a oluÅŸturulduÄŸunda Ã¶nceki tehlikeye atÄ±fta bulunan serbest adresi (0x20) kullanÄ±lacak ve **sÄ±ralanmamÄ±ÅŸ bin saldÄ±rÄ±sÄ± tetiklenecek**, `global_max_fast`'Ä± Ã§ok bÃ¼yÃ¼k bir deÄŸerle Ã¼zerine yazarak artÄ±k hÄ±zlÄ± binlerde parÃ§alar oluÅŸturulabilir.
* Åimdi bir **hÄ±zlÄ± bin saldÄ±rÄ±sÄ±** gerÃ§ekleÅŸtirilir:
* Ä°lk olarak, **`__free_hook`** konumunda 200 boyutunda hÄ±zlÄ± **parÃ§alarla Ã§alÄ±ÅŸÄ±labileceÄŸi** keÅŸfedilir:
* <pre class="language-c"><code class="lang-c">gefâ¤  p &#x26;__free_hook
$1 = (void (**)(void *, const void *)) 0x7ff1e9e607a8 &#x3C;__free_hook>
gefâ¤  x/60gx 0x7ff1e9e607a8 - 0x59
<strong>0x7ff1e9e6074f: 0x0000000000000000      0x0000000000000200
</strong>0x7ff1e9e6075f: 0x0000000000000000      0x0000000000000000
0x7ff1e9e6076f &#x3C;list_all_lock+15>:      0x0000000000000000      0x0000000000000000
0x7ff1e9e6077f &#x3C;_IO_stdfile_2_lock+15>: 0x0000000000000000      0x0000000000000000
</code></pre>
* Bu konumda 0x200 boyutunda hÄ±zlÄ± bir parÃ§a almayÄ± baÅŸarÄ±rsak, yÃ¼rÃ¼tÃ¼lecek bir iÅŸaretÃ§iyi Ã¼zerine yazmak mÃ¼mkÃ¼n olacaktÄ±r.
* Bunun iÃ§in, boyutu `0xfc` olan yeni bir parÃ§a oluÅŸturulur ve birleÅŸtirme iÅŸlevi iki kez bu iÅŸaretÃ§iyle Ã§aÄŸrÄ±lÄ±r, bu ÅŸekilde hÄ±zlÄ± binde boyutu `0xfc*2 = 0x1f8` olan bir serbest bÄ±rakÄ±lmÄ±ÅŸ parÃ§aya bir iÅŸaretÃ§i elde edilir.
* ArdÄ±ndan, bu parÃ§ada `fd` adresini Ã¶nceki **`__free_hook`** iÅŸlevine iÅŸaret edecek ÅŸekilde deÄŸiÅŸtirmek iÃ§in edit iÅŸlevi Ã§aÄŸrÄ±lÄ±r.
* ArdÄ±ndan, boyutu `0x1f8` olan bir parÃ§a oluÅŸturulur ve hÄ±zlÄ± binlerden Ã¶nceki gereksiz parÃ§a alÄ±nÄ±r, bÃ¶ylece `0x1f8` boyutunda baÅŸka bir parÃ§a oluÅŸturulur ve **`__free_hook`** iÃ§inde **`system`** fonksiyonunun adresi ile Ã¼zerine yazÄ±lÄ±r.
* Ve son olarak, `/bin/sh\x00` dizesini iÃ§eren bir parÃ§a, silme fonksiyonunu Ã§aÄŸÄ±rarak serbest bÄ±rakÄ±lÄ±r, **`__free_hook`** fonksiyonunu tetikler ve bu fonksiyon `/bin/sh\x00` parametresi ile system fonksiyonuna iÅŸaret eder.

<details>

<summary><strong>SÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) koleksiyonumuzu keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family)
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'da takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>
