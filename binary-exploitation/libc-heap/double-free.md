# ãƒ€ãƒ–ãƒ«ãƒ•ãƒªãƒ¼

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã®å­¦ç¿’ã¨ç·´ç¿’ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã®å­¦ç¿’ã¨ç·´ç¿’ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã®ã‚µãƒãƒ¼ãƒˆ</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ï¼
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«å‚åŠ ã™ã‚‹ã‹ã€[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„ã€‚
* **HackTricks**ã¨**HackTricks Cloud**ã®githubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦**ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰**ã—ã¦ãã ã•ã„ã€‚

</details>
{% endhint %}

## åŸºæœ¬æƒ…å ±

ãƒ¡ãƒ¢ãƒªãƒ–ãƒ­ãƒƒã‚¯ã‚’è¤‡æ•°å›è§£æ”¾ã™ã‚‹ã¨ã€ã‚¢ãƒ­ã‚±ãƒ¼ã‚¿ã®ãƒ‡ãƒ¼ã‚¿ãŒç‹‚ã„ã€æ”»æ’ƒã®å¯èƒ½æ€§ãŒç”Ÿã˜ã¾ã™ã€‚ã“ã†ãªã‚‹ç†ç”±ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ï¼šãƒ¡ãƒ¢ãƒªãƒ–ãƒ­ãƒƒã‚¯ã‚’è§£æ”¾ã™ã‚‹ã¨ã€ãã‚Œã¯ç©ºããƒãƒ£ãƒ³ã‚¯ã®ãƒªã‚¹ãƒˆï¼ˆä¾‹ï¼šã€Œfast binã€ï¼‰ã«æˆ»ã‚Šã¾ã™ã€‚åŒã˜ãƒ–ãƒ­ãƒƒã‚¯ã‚’2å›é€£ç¶šã§è§£æ”¾ã™ã‚‹ã¨ã€ã‚¢ãƒ­ã‚±ãƒ¼ã‚¿ã¯ã“ã‚Œã‚’æ¤œå‡ºã—ã¦ã‚¨ãƒ©ãƒ¼ã‚’ã‚¹ãƒ­ãƒ¼ã—ã¾ã™ã€‚ã—ã‹ã—ã€**åˆ¥ã®ãƒãƒ£ãƒ³ã‚¯ã‚’è§£æ”¾ã—ã¦ã„ã‚‹é–“ã«ã€ãƒ€ãƒ–ãƒ«ãƒ•ãƒªãƒ¼ãƒã‚§ãƒƒã‚¯ãŒãƒã‚¤ãƒ‘ã‚¹**ã•ã‚Œã€ç ´æãŒç™ºç”Ÿã—ã¾ã™ã€‚

ãã—ã¦ã€æ–°ã—ã„ãƒ¡ãƒ¢ãƒªã‚’è¦æ±‚ã™ã‚‹ã¨ï¼ˆ`malloc`ã‚’ä½¿ç”¨ï¼‰ã€ã‚¢ãƒ­ã‚±ãƒ¼ã‚¿ã¯**2å›è§£æ”¾ã•ã‚ŒãŸãƒ–ãƒ­ãƒƒã‚¯**ã‚’è¿”ã™å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€2ã¤ã®ç•°ãªã‚‹ãƒã‚¤ãƒ³ã‚¿ãŒåŒã˜ãƒ¡ãƒ¢ãƒªä½ç½®ã‚’æŒ‡ã™ã“ã¨ã«ãªã‚Šã¾ã™ã€‚æ”»æ’ƒè€…ãŒãã®ã†ã¡ã®1ã¤ã®ãƒã‚¤ãƒ³ã‚¿ã‚’åˆ¶å¾¡ã—ã¦ã„ã‚‹å ´åˆã€ãã®ãƒ¡ãƒ¢ãƒªã®å†…å®¹ã‚’å¤‰æ›´ã§ãã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®å•é¡Œã‚’å¼•ãèµ·ã“ã—ãŸã‚Šã€ã‚³ãƒ¼ãƒ‰ã®å®Ÿè¡Œã‚’è¨±å¯ã—ãŸã‚Šã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

ä¾‹ï¼š
```c
#include <stdio.h>
#include <stdlib.h>

int main() {
// Allocate memory for three chunks
char *a = (char *)malloc(10);
char *b = (char *)malloc(10);
char *c = (char *)malloc(10);
char *d = (char *)malloc(10);
char *e = (char *)malloc(10);
char *f = (char *)malloc(10);
char *g = (char *)malloc(10);
char *h = (char *)malloc(10);
char *i = (char *)malloc(10);

// Print initial memory addresses
printf("Initial allocations:\n");
printf("a: %p\n", (void *)a);
printf("b: %p\n", (void *)b);
printf("c: %p\n", (void *)c);
printf("d: %p\n", (void *)d);
printf("e: %p\n", (void *)e);
printf("f: %p\n", (void *)f);
printf("g: %p\n", (void *)g);
printf("h: %p\n", (void *)h);
printf("i: %p\n", (void *)i);

// Fill tcache
free(a);
free(b);
free(c);
free(d);
free(e);
free(f);
free(g);

// Introduce double-free vulnerability in fast bin
free(h);
free(i);
free(h);


// Reallocate memory and print the addresses
char *a1 = (char *)malloc(10);
char *b1 = (char *)malloc(10);
char *c1 = (char *)malloc(10);
char *d1 = (char *)malloc(10);
char *e1 = (char *)malloc(10);
char *f1 = (char *)malloc(10);
char *g1 = (char *)malloc(10);
char *h1 = (char *)malloc(10);
char *i1 = (char *)malloc(10);
char *i2 = (char *)malloc(10);

// Print initial memory addresses
printf("After reallocations:\n");
printf("a1: %p\n", (void *)a1);
printf("b1: %p\n", (void *)b1);
printf("c1: %p\n", (void *)c1);
printf("d1: %p\n", (void *)d1);
printf("e1: %p\n", (void *)e1);
printf("f1: %p\n", (void *)f1);
printf("g1: %p\n", (void *)g1);
printf("h1: %p\n", (void *)h1);
printf("i1: %p\n", (void *)i1);
printf("i2: %p\n", (void *)i1);

return 0;
}
```
ã“ã®ä¾‹ã§ã¯ã€tcacheã‚’è¤‡æ•°ã®è§£æ”¾ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ï¼ˆ7ã¤ï¼‰ã§åŸ‹ã‚ãŸå¾Œã€**ã‚³ãƒ¼ãƒ‰ã¯ãƒãƒ£ãƒ³ã‚¯ `h`ã€æ¬¡ã«ãƒãƒ£ãƒ³ã‚¯ `i`ã€ãã—ã¦å†ã³ `h` ã‚’è§£æ”¾ã—ã€ãƒ€ãƒ–ãƒ«ãƒ•ãƒªãƒ¼ï¼ˆã¾ãŸã¯Fast Bin dupã¨ã—ã¦ã‚‚çŸ¥ã‚‰ã‚Œã‚‹ï¼‰**ã‚’å¼•ãèµ·ã“ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€å†å‰²ã‚Šå½“ã¦æ™‚ã«ãƒ¡ãƒ¢ãƒªã‚¢ãƒ‰ãƒ¬ã‚¹ãŒé‡è¤‡ã—ã¦å—ã‘å–ã‚‰ã‚Œã‚‹å¯èƒ½æ€§ãŒé–‹ã‹ã‚Œã€ã¤ã¾ã‚Š2ã¤ä»¥ä¸Šã®ãƒã‚¤ãƒ³ã‚¿ãŒåŒã˜ãƒ¡ãƒ¢ãƒªä½ç½®ã‚’æŒ‡ã™ã“ã¨ãŒã§ãã¾ã™ã€‚1ã¤ã®ãƒã‚¤ãƒ³ã‚¿ã‚’ä»‹ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’æ“ä½œã™ã‚‹ã“ã¨ã§ã€ä»–æ–¹ã«å½±éŸ¿ã‚’ä¸ãˆã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã€é‡å¤§ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ã¨æ‚ªç”¨ã®å¯èƒ½æ€§ãŒç”Ÿã˜ã¾ã™ã€‚

å®Ÿè¡Œã™ã‚‹ã¨ã€**`i1`ã¨`i2`ãŒåŒã˜ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—ã—ãŸ**ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ï¼š

<pre><code>åˆæœŸå‰²ã‚Šå½“ã¦ï¼š
a: 0xaaab0f0c22a0
b: 0xaaab0f0c22c0
c: 0xaaab0f0c22e0
d: 0xaaab0f0c2300
e: 0xaaab0f0c2320
f: 0xaaab0f0c2340
g: 0xaaab0f0c2360
h: 0xaaab0f0c2380
i: 0xaaab0f0c23a0
å†å‰²ã‚Šå½“ã¦å¾Œï¼š
a1: 0xaaab0f0c2360
b1: 0xaaab0f0c2340
c1: 0xaaab0f0c2320
d1: 0xaaab0f0c2300
e1: 0xaaab0f0c22e0
f1: 0xaaab0f0c22c0
g1: 0xaaab0f0c22a0
h1: 0xaaab0f0c2380
<strong>i1: 0xaaab0f0c23a0
</strong><strong>i2: 0xaaab0f0c23a0
</strong></code></pre>

## ä¾‹

* [**Dragon Army. Hack The Box**](https://7rocky.github.io/en/ctf/htb-challenges/pwn/dragon-army/)
* ã‚µã‚¤ã‚º`0x70`ä»¥å¤–ã®Fast Binã‚µã‚¤ã‚ºã®ãƒãƒ£ãƒ³ã‚¯ã—ã‹å‰²ã‚Šå½“ã¦ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚é€šå¸¸ã®`__malloc_hook`ã®ä¸Šæ›¸ãã‚’é˜²ãã¾ã™ã€‚
* ä»£ã‚ã‚Šã«ã€Fast Bin dupã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¨ã—ã¦`0x56`ã§å§‹ã¾ã‚‹PIEã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä½¿ç”¨ã—ã¾ã™ï¼ˆ1/2ã®ç¢ºç‡ï¼‰ã€‚
* PIEã‚¢ãƒ‰ãƒ¬ã‚¹ãŒæ ¼ç´ã•ã‚Œã¦ã„ã‚‹å ´æ‰€ã®1ã¤ã¯ã€`main_arena`å†…ã«ã‚ã‚Šã€Glibcå†…éƒ¨ã«ã‚ã‚Šã€`__malloc_hook`ã®è¿‘ãã«ã‚ã‚Šã¾ã™ã€‚
* ç‰¹å®šã®`main_arena`ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ã—ã¦ã€ãã“ã«ãƒãƒ£ãƒ³ã‚¯ã‚’å‰²ã‚Šå½“ã¦ã€`__malloc_hook`ã«åˆ°é”ã™ã‚‹ã¾ã§ãƒãƒ£ãƒ³ã‚¯ã‚’ç¶™ç¶šçš„ã«å‰²ã‚Šå½“ã¦ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œã‚’å–å¾—ã—ã¾ã™ã€‚
* [**zero_to_hero. PicoCTF**](https://7rocky.github.io/en/ctf/picoctf/binary-exploitation/zero_to_hero/)
* Tcache binsã¨ãƒŒãƒ«ãƒã‚¤ãƒˆã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ€ãƒ–ãƒ«ãƒ•ãƒªãƒ¼ã®çŠ¶æ³ã‚’é”æˆã§ãã¾ã™ï¼š
* ã‚µã‚¤ã‚º`0x110`ã®3ã¤ã®ãƒãƒ£ãƒ³ã‚¯ï¼ˆ`A`ã€`B`ã€`C`ï¼‰ã‚’å‰²ã‚Šå½“ã¦ã¾ã™
* `B`ã‚’è§£æ”¾ã—ã¾ã™
* `A`ã‚’è§£æ”¾ã—ã¦å†åº¦å‰²ã‚Šå½“ã¦ã€ãƒŒãƒ«ãƒã‚¤ãƒˆã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã‚’ä½¿ç”¨ã—ã¾ã™
* ã“ã‚Œã§`B`ã®ã‚µã‚¤ã‚ºãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯`0x111`ã§ã¯ãªã`0x100`ã«ãªã‚Šã¾ã™ã®ã§ã€å†åº¦è§£æ”¾ã§ãã¾ã™
* ã‚µã‚¤ã‚º`0x110`ã®Tcache-binã¨ã‚µã‚¤ã‚º`0x100`ã®Tcache-binãŒåŒã˜ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒ‡ã™ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€ãƒ€ãƒ–ãƒ«ãƒ•ãƒªãƒ¼ãŒç™ºç”Ÿã—ã¾ã™ã€‚
* [Tcache poisoning](tcache-bin-attack.md)ã‚’ä½¿ç”¨ã—ã¦ãƒ€ãƒ–ãƒ«ãƒ•ãƒªãƒ¼ã‚’æ´»ç”¨ã—ã¾ã™ã€‚

## å‚è€ƒæ–‡çŒ®

* [https://heap-exploitation.dhavalkapil.com/attacks/double\_free](https://heap-exploitation.dhavalkapil.com/attacks/double\_free)

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã®å­¦ç¿’ã¨å®Ÿè·µï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã®å­¦ç¿’ã¨å®Ÿè·µï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã®ã‚µãƒãƒ¼ãƒˆ</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã‚„[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„ã€‚
* **ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€**[**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚

</details>
{% endhint %}
