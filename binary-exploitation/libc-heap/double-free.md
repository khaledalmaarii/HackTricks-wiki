# Double Free

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

ë©”ëª¨ë¦¬ ë¸”ë¡ì„ í•œ ë²ˆ ì´ìƒ í•´ì œí•˜ë©´ í• ë‹¹ìì˜ ë°ì´í„°ê°€ ì—‰ë§ì´ ë˜ì–´ ê³µê²©ì˜ ë¬¸ì´ ì—´ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ë°œìƒí•©ë‹ˆë‹¤: ë©”ëª¨ë¦¬ ë¸”ë¡ì„ í•´ì œí•˜ë©´ ê·¸ê²ƒì€ ë¬´ë£Œ ì²­í¬ ëª©ë¡(ì˜ˆ: "ë¹ ë¥¸ ë¹ˆ")ìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤. ê°™ì€ ë¸”ë¡ì„ ì—°ì†ìœ¼ë¡œ ë‘ ë²ˆ í•´ì œí•˜ë©´ í• ë‹¹ìëŠ” ì´ë¥¼ ê°ì§€í•˜ê³  ì˜¤ë¥˜ë¥¼ ë°œìƒì‹œí‚µë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ **ê·¸ ì‚¬ì´ì— ë‹¤ë¥¸ ì²­í¬ë¥¼ í•´ì œí•˜ë©´ ì´ì¤‘ í•´ì œ ê²€ì‚¬ê°€ ìš°íšŒë˜ì–´** ì†ìƒì´ ë°œìƒí•©ë‹ˆë‹¤.

ì´ì œ ìƒˆë¡œìš´ ë©”ëª¨ë¦¬ë¥¼ ìš”ì²­í•  ë•Œ(`malloc` ì‚¬ìš©), í• ë‹¹ìëŠ” **ë‘ ë²ˆ í•´ì œëœ ë¸”ë¡**ì„ ì œê³µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¡œ ì¸í•´ ë‘ ê°œì˜ ì„œë¡œ ë‹¤ë¥¸ í¬ì¸í„°ê°€ ë™ì¼í•œ ë©”ëª¨ë¦¬ ìœ„ì¹˜ë¥¼ ê°€ë¦¬í‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê³µê²©ìê°€ ê·¸ í¬ì¸í„° ì¤‘ í•˜ë‚˜ë¥¼ ì œì–´í•˜ë©´, ê·¸ ë©”ëª¨ë¦¬ì˜ ë‚´ìš©ì„ ë³€ê²½í•  ìˆ˜ ìˆìœ¼ë©°, ì´ëŠ” ë³´ì•ˆ ë¬¸ì œë¥¼ ì¼ìœ¼í‚¤ê±°ë‚˜ ì‹¬ì§€ì–´ ì½”ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆê²Œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

Example:
```c
#include <stdio.h>
#include <stdlib.h>

int main() {
// Allocate memory for three chunks
char *a = (char *)malloc(10);
char *b = (char *)malloc(10);
char *c = (char *)malloc(10);
char *d = (char *)malloc(10);
char *e = (char *)malloc(10);
char *f = (char *)malloc(10);
char *g = (char *)malloc(10);
char *h = (char *)malloc(10);
char *i = (char *)malloc(10);

// Print initial memory addresses
printf("Initial allocations:\n");
printf("a: %p\n", (void *)a);
printf("b: %p\n", (void *)b);
printf("c: %p\n", (void *)c);
printf("d: %p\n", (void *)d);
printf("e: %p\n", (void *)e);
printf("f: %p\n", (void *)f);
printf("g: %p\n", (void *)g);
printf("h: %p\n", (void *)h);
printf("i: %p\n", (void *)i);

// Fill tcache
free(a);
free(b);
free(c);
free(d);
free(e);
free(f);
free(g);

// Introduce double-free vulnerability in fast bin
free(h);
free(i);
free(h);


// Reallocate memory and print the addresses
char *a1 = (char *)malloc(10);
char *b1 = (char *)malloc(10);
char *c1 = (char *)malloc(10);
char *d1 = (char *)malloc(10);
char *e1 = (char *)malloc(10);
char *f1 = (char *)malloc(10);
char *g1 = (char *)malloc(10);
char *h1 = (char *)malloc(10);
char *i1 = (char *)malloc(10);
char *i2 = (char *)malloc(10);

// Print initial memory addresses
printf("After reallocations:\n");
printf("a1: %p\n", (void *)a1);
printf("b1: %p\n", (void *)b1);
printf("c1: %p\n", (void *)c1);
printf("d1: %p\n", (void *)d1);
printf("e1: %p\n", (void *)e1);
printf("f1: %p\n", (void *)f1);
printf("g1: %p\n", (void *)g1);
printf("h1: %p\n", (void *)h1);
printf("i1: %p\n", (void *)i1);
printf("i2: %p\n", (void *)i2);

return 0;
}
```
ì´ ì˜ˆì œì—ì„œëŠ” tcacheë¥¼ ì—¬ëŸ¬ ê°œì˜ í•´ì œëœ ì²­í¬(7)ë¡œ ì±„ìš´ í›„, ì½”ë“œê°€ **ì²­í¬ `h`ë¥¼ í•´ì œí•œ ë‹¤ìŒ ì²­í¬ `i`ë¥¼ í•´ì œí•˜ê³  ë‹¤ì‹œ `h`ë¥¼ í•´ì œí•˜ì—¬ ì´ì¤‘ í•´ì œë¥¼ ë°œìƒì‹œí‚µë‹ˆë‹¤**(Fast Bin dupì´ë¼ê³ ë„ í•¨). ì´ëŠ” ì¬í• ë‹¹ ì‹œ ê²¹ì¹˜ëŠ” ë©”ëª¨ë¦¬ ì£¼ì†Œë¥¼ ë°›ì„ ê°€ëŠ¥ì„±ì„ ì—´ì–´ì£¼ë©°, ë‘ ê°œ ì´ìƒì˜ í¬ì¸í„°ê°€ ë™ì¼í•œ ë©”ëª¨ë¦¬ ìœ„ì¹˜ë¥¼ ê°€ë¦¬í‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•œ í¬ì¸í„°ë¥¼ í†µí•´ ë°ì´í„°ë¥¼ ì¡°ì‘í•˜ë©´ ë‹¤ë¥¸ í¬ì¸í„°ì— ì˜í–¥ì„ ë¯¸ì¹  ìˆ˜ ìˆì–´, ì´ëŠ” ì‹¬ê°í•œ ë³´ì•ˆ ìœ„í—˜ê³¼ ì•…ìš© ê°€ëŠ¥ì„±ì„ ì´ˆë˜í•©ë‹ˆë‹¤.

ì‹¤í–‰ ì‹œ, **`i1`ê³¼ `i2`ê°€ ë™ì¼í•œ ì£¼ì†Œë¥¼ ê°€ì¡ŒìŒì„ ì£¼ëª©í•˜ì„¸ìš”**:

<pre><code>ì´ˆê¸° í• ë‹¹:
a: 0xaaab0f0c22a0
b: 0xaaab0f0c22c0
c: 0xaaab0f0c22e0
d: 0xaaab0f0c2300
e: 0xaaab0f0c2320
f: 0xaaab0f0c2340
g: 0xaaab0f0c2360
h: 0xaaab0f0c2380
i: 0xaaab0f0c23a0
ì¬í• ë‹¹ í›„:
a1: 0xaaab0f0c2360
b1: 0xaaab0f0c2340
c1: 0xaaab0f0c2320
d1: 0xaaab0f0c2300
e1: 0xaaab0f0c22e0
f1: 0xaaab0f0c22c0
g1: 0xaaab0f0c22a0
h1: 0xaaab0f0c2380
<strong>i1: 0xaaab0f0c23a0
</strong><strong>i2: 0xaaab0f0c23a0
</strong></code></pre>

## ì˜ˆì œ

* [**Dragon Army. Hack The Box**](https://7rocky.github.io/en/ctf/htb-challenges/pwn/dragon-army/)
* ìš°ë¦¬ëŠ” `0x70` í¬ê¸°ë¥¼ ì œì™¸í•˜ê³ ëŠ” Fast-Bin í¬ê¸°ì˜ ì²­í¬ë§Œ í• ë‹¹í•  ìˆ˜ ìˆìœ¼ë©°, ì´ëŠ” ì¼ë°˜ì ì¸ `__malloc_hook` ë®ì–´ì“°ê¸°ë¥¼ ë°©ì§€í•©ë‹ˆë‹¤.
* ëŒ€ì‹ , Fast Bin dupì˜ ëŒ€ìƒìœ¼ë¡œ `0x56`ë¡œ ì‹œì‘í•˜ëŠ” PIE ì£¼ì†Œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤(1/2 í™•ë¥ ).
* PIE ì£¼ì†Œê°€ ì €ì¥ë˜ëŠ” í•œ ê³³ì€ Glibc ë‚´ë¶€ì˜ `main_arena`ì´ë©°, `__malloc_hook` ê·¼ì²˜ì— ìˆìŠµë‹ˆë‹¤.
* ìš°ë¦¬ëŠ” `main_arena`ì˜ íŠ¹ì • ì˜¤í”„ì…‹ì„ ëª©í‘œë¡œ í•˜ì—¬ ê·¸ê³³ì— ì²­í¬ë¥¼ í• ë‹¹í•˜ê³ , `__malloc_hook`ì— ë„ë‹¬í•  ë•Œê¹Œì§€ ì²­í¬ë¥¼ ê³„ì† í• ë‹¹í•˜ì—¬ ì½”ë“œ ì‹¤í–‰ì„ ì–»ìŠµë‹ˆë‹¤.
* [**zero_to_hero. PicoCTF**](https://7rocky.github.io/en/ctf/picoctf/binary-exploitation/zero_to_hero/)
* Tcache ë¹ˆê³¼ ë„ ë°”ì´íŠ¸ ì˜¤ë²„í”Œë¡œìš°ë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ì¤‘ í•´ì œ ìƒí™©ì„ ë‹¬ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
* ìš°ë¦¬ëŠ” í¬ê¸° `0x110`ì˜ ì²­í¬ ì„¸ ê°œ(`A`, `B`, `C`)ë¥¼ í• ë‹¹í•©ë‹ˆë‹¤.
* ìš°ë¦¬ëŠ” `B`ë¥¼ í•´ì œí•©ë‹ˆë‹¤.
* ìš°ë¦¬ëŠ” `A`ë¥¼ í•´ì œí•˜ê³  ë„ ë°”ì´íŠ¸ ì˜¤ë²„í”Œë¡œìš°ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ë‹¤ì‹œ í• ë‹¹í•©ë‹ˆë‹¤.
* ì´ì œ `B`ì˜ í¬ê¸° í•„ë“œëŠ” `0x100`ì´ë©°, `0x111`ì´ ì•„ë‹ˆë¯€ë¡œ ë‹¤ì‹œ í•´ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* ìš°ë¦¬ëŠ” ë™ì¼í•œ ì£¼ì†Œë¥¼ ê°€ë¦¬í‚¤ëŠ” í¬ê¸° `0x110`ì˜ Tcache-bin í•˜ë‚˜ì™€ í¬ê¸° `0x100`ì˜ Tcache-bin í•˜ë‚˜ë¥¼ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ìš°ë¦¬ëŠ” ì´ì¤‘ í•´ì œë¥¼ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.
* ìš°ë¦¬ëŠ” [Tcache poisoning](tcache-bin-attack.md)ì„ ì‚¬ìš©í•˜ì—¬ ì´ì¤‘ í•´ì œë¥¼ í™œìš©í•©ë‹ˆë‹¤.

## ì°¸ê³ ë¬¸í—Œ

* [https://heap-exploitation.dhavalkapil.com/attacks/double\_free](https://heap-exploitation.dhavalkapil.com/attacks/double\_free)

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter**ì—ì„œ **íŒ”ë¡œìš°**í•˜ì„¸ìš”** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŒì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}
