# Podw贸jne Zwolnienie

{% hint style="success" %}
Dowiedz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Dowiedz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Udostpnij sztuczki hakerskie, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na githubie.

</details>
{% endhint %}

## Podstawowe Informacje

Jeli zwolnisz blok pamici wicej ni偶 raz, mo偶e to zaburzy dane alokatora i otworzy drzwi do atak贸w. Oto jak to si dzieje: gdy zwalniasz blok pamici, wraca on do listy wolnych fragment贸w (np. "szybki blok"). Jeli zwolnisz ten sam blok dwa razy z rzdu, alokator wykrywa to i zgasza bd. Ale jeli **zwolnisz inny fragment pomidzy nimi, sprawdzenie podw贸jnego zwolnienia jest obejcione**, co powoduje uszkodzenie.

Teraz, gdy prosisz o now pami (u偶ywajc `malloc`), alokator mo偶e da ci **blok, kt贸ry zosta zwolniony dwukrotnie**. Mo偶e to prowadzi do dw贸ch r贸偶nych wska藕nik贸w wskazujcych na t sam lokalizacj pamici. Jeli atakujcy kontroluje jeden z tych wska藕nik贸w, mo偶e zmieni zawarto tej pamici, co mo偶e powodowa problemy z bezpieczestwem lub nawet umo偶liwi mu wykonanie kodu.

Przykad:
```c
#include <stdio.h>
#include <stdlib.h>

int main() {
// Allocate memory for three chunks
char *a = (char *)malloc(10);
char *b = (char *)malloc(10);
char *c = (char *)malloc(10);
char *d = (char *)malloc(10);
char *e = (char *)malloc(10);
char *f = (char *)malloc(10);
char *g = (char *)malloc(10);
char *h = (char *)malloc(10);
char *i = (char *)malloc(10);

// Print initial memory addresses
printf("Initial allocations:\n");
printf("a: %p\n", (void *)a);
printf("b: %p\n", (void *)b);
printf("c: %p\n", (void *)c);
printf("d: %p\n", (void *)d);
printf("e: %p\n", (void *)e);
printf("f: %p\n", (void *)f);
printf("g: %p\n", (void *)g);
printf("h: %p\n", (void *)h);
printf("i: %p\n", (void *)i);

// Fill tcache
free(a);
free(b);
free(c);
free(d);
free(e);
free(f);
free(g);

// Introduce double-free vulnerability in fast bin
free(h);
free(i);
free(h);


// Reallocate memory and print the addresses
char *a1 = (char *)malloc(10);
char *b1 = (char *)malloc(10);
char *c1 = (char *)malloc(10);
char *d1 = (char *)malloc(10);
char *e1 = (char *)malloc(10);
char *f1 = (char *)malloc(10);
char *g1 = (char *)malloc(10);
char *h1 = (char *)malloc(10);
char *i1 = (char *)malloc(10);
char *i2 = (char *)malloc(10);

// Print initial memory addresses
printf("After reallocations:\n");
printf("a1: %p\n", (void *)a1);
printf("b1: %p\n", (void *)b1);
printf("c1: %p\n", (void *)c1);
printf("d1: %p\n", (void *)d1);
printf("e1: %p\n", (void *)e1);
printf("f1: %p\n", (void *)f1);
printf("g1: %p\n", (void *)g1);
printf("h1: %p\n", (void *)h1);
printf("i1: %p\n", (void *)i1);
printf("i2: %p\n", (void *)i1);

return 0;
}
```
W tym przykadzie, po zapenieniu tcache kilkoma zwolnionymi kawakami (7), kod **zwalnia kawaek `h`, nastpnie kawaek `i`, a nastpnie ponownie `h`, powodujc podw贸jne zwolnienie** (znane r贸wnie偶 jako duplikat Fast Bin). Otwiera to mo偶liwo otrzymywania nakadajcych si adres贸w pamici podczas ponownego przydziau, co oznacza, 偶e dwa lub wicej wska藕nik贸w mog wskazywa na ten sam obszar pamici. Manipulowanie danymi za pomoc jednego wska藕nika mo偶e wpyn na drugi, tworzc powa偶ne ryzyko bezpieczestwa i potencja do eksploatacji.

Wykonujc to, zauwa偶, jak **`i1` i `i2` otrzymay ten sam adres**:

<pre><code>Alokacje pocztkowe:
a: 0xaaab0f0c22a0
b: 0xaaab0f0c22c0
c: 0xaaab0f0c22e0
d: 0xaaab0f0c2300
e: 0xaaab0f0c2320
f: 0xaaab0f0c2340
g: 0xaaab0f0c2360
h: 0xaaab0f0c2380
i: 0xaaab0f0c23a0
Po ponownych przydziaach:
a1: 0xaaab0f0c2360
b1: 0xaaab0f0c2340
c1: 0xaaab0f0c2320
d1: 0xaaab0f0c2300
e1: 0xaaab0f0c22e0
f1: 0xaaab0f0c22c0
g1: 0xaaab0f0c22a0
h1: 0xaaab0f0c2380
<strong>i1: 0xaaab0f0c23a0
</strong><strong>i2: 0xaaab0f0c23a0
</strong></code></pre>

## Przykady

* [**Dragon Army. Hack The Box**](https://7rocky.github.io/en/ctf/htb-challenges/pwn/dragon-army/)
* Mo偶emy tylko alokowa kawaki o rozmiarze Fast-Bin, z wyjtkiem rozmiaru `0x70`, co uniemo偶liwia standardowe nadpisanie `__malloc_hook`.
* Zamiast tego u偶ywamy adres贸w PIE zaczynajcych si od `0x56` jako cel dla Fast Bin dup (1/2 szansy).
* Jednym miejscem, gdzie przechowywane s adresy PIE, jest `main_arena`, kt贸ra znajduje si wewntrz Glibc i w pobli偶u `__malloc_hook`.
* Celujemy w okrelony offset `main_arena`, aby zaalokowa tam kawaek i kontynuowa alokowanie kawak贸w, a偶 dotrzemy do `__malloc_hook`, aby uzyska wykonanie kodu.
* [**zero_to_hero. PicoCTF**](https://7rocky.github.io/en/ctf/picoctf/binary-exploitation/zero_to_hero/)
* Korzystajc z pojemnik贸w Tcache i przepenienia bajtu zerowego, mo偶emy osign sytuacj podw贸jnego zwolnienia:
* Alokujemy trzy kawaki o rozmiarze `0x110` (`A`, `B`, `C`)
* Zwolniamy `B`
* Zwolniamy `A` i ponownie alokujemy, aby skorzysta z przepenienia bajtu zerowego
* Teraz pole rozmiaru `B` to `0x100`, zamiast `0x111`, wic mo偶emy ponownie go zwolni
* Mamy jeden pojemnik Tcache o rozmiarze `0x110` i jeden o rozmiarze `0x100`, kt贸re wskazuj na ten sam adres. Mamy wic podw贸jne zwolnienie.
* Wykorzystujemy podw贸jne zwolnienie za pomoc [zatruwania Tcache](tcache-bin-attack.md)

## Odnoniki

* [https://heap-exploitation.dhavalkapil.com/attacks/double\_free](https://heap-exploitation.dhavalkapil.com/attacks/double\_free)

{% hint style="success" %}
Dowiedz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Dowiedz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Udostpniaj sztuczki hakerskie, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
