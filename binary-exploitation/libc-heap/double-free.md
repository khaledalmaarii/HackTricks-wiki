# Double Free

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Podstawowe informacje

Jeli zwolnisz blok pamici wicej ni偶 raz, mo偶e to zepsu dane alokatora i otworzy drzwi do atak贸w. Oto jak to si dzieje: gdy zwalniasz blok pamici, wraca on do listy wolnych kawak贸w (np. "szybki bin"). Jeli zwolnisz ten sam blok dwa razy z rzdu, alokator to wykrywa i zgasza bd. Ale jeli **zwolnisz inny kawaek pomidzy, sprawdzenie podw贸jnego zwolnienia jest omijane**, co powoduje uszkodzenie.

Teraz, gdy poprosisz o now pami (u偶ywajc `malloc`), alokator mo偶e da ci **blok, kt贸ry zosta zwolniony dwa razy**. Mo偶e to prowadzi do dw贸ch r贸偶nych wska藕nik贸w wskazujcych na to samo miejsce w pamici. Jeli atakujcy kontroluje jeden z tych wska藕nik贸w, mo偶e zmieni zawarto tej pamici, co mo偶e powodowa problemy z bezpieczestwem lub nawet pozwoli im na wykonanie kodu.

Przykad:
```c
#include <stdio.h>
#include <stdlib.h>

int main() {
// Allocate memory for three chunks
char *a = (char *)malloc(10);
char *b = (char *)malloc(10);
char *c = (char *)malloc(10);
char *d = (char *)malloc(10);
char *e = (char *)malloc(10);
char *f = (char *)malloc(10);
char *g = (char *)malloc(10);
char *h = (char *)malloc(10);
char *i = (char *)malloc(10);

// Print initial memory addresses
printf("Initial allocations:\n");
printf("a: %p\n", (void *)a);
printf("b: %p\n", (void *)b);
printf("c: %p\n", (void *)c);
printf("d: %p\n", (void *)d);
printf("e: %p\n", (void *)e);
printf("f: %p\n", (void *)f);
printf("g: %p\n", (void *)g);
printf("h: %p\n", (void *)h);
printf("i: %p\n", (void *)i);

// Fill tcache
free(a);
free(b);
free(c);
free(d);
free(e);
free(f);
free(g);

// Introduce double-free vulnerability in fast bin
free(h);
free(i);
free(h);


// Reallocate memory and print the addresses
char *a1 = (char *)malloc(10);
char *b1 = (char *)malloc(10);
char *c1 = (char *)malloc(10);
char *d1 = (char *)malloc(10);
char *e1 = (char *)malloc(10);
char *f1 = (char *)malloc(10);
char *g1 = (char *)malloc(10);
char *h1 = (char *)malloc(10);
char *i1 = (char *)malloc(10);
char *i2 = (char *)malloc(10);

// Print initial memory addresses
printf("After reallocations:\n");
printf("a1: %p\n", (void *)a1);
printf("b1: %p\n", (void *)b1);
printf("c1: %p\n", (void *)c1);
printf("d1: %p\n", (void *)d1);
printf("e1: %p\n", (void *)e1);
printf("f1: %p\n", (void *)f1);
printf("g1: %p\n", (void *)g1);
printf("h1: %p\n", (void *)h1);
printf("i1: %p\n", (void *)i1);
printf("i2: %p\n", (void *)i2);

return 0;
}
```
W tym przykadzie, po wypenieniu tcache kilkoma zwolnionymi kawakami (7), kod **zwalnia kawaek `h`, nastpnie kawaek `i`, a potem `h` ponownie, co powoduje podw贸jne zwolnienie** (znane r贸wnie偶 jako Fast Bin dup). Otwiera to mo偶liwo uzyskania nakadajcych si adres贸w pamici podczas ponownej alokacji, co oznacza, 偶e dwa lub wicej wska藕nik贸w mo偶e wskazywa na t sam lokalizacj pamici. Manipulowanie danymi przez jeden wska藕nik mo偶e nastpnie wpyn na drugi, co stwarza krytyczne ryzyko bezpieczestwa i potencja do wykorzystania.

Wykonujc to, zauwa偶, jak **`i1` i `i2` uzyskay ten sam adres**:

<pre><code>Initial allocations:
a: 0xaaab0f0c22a0
b: 0xaaab0f0c22c0
c: 0xaaab0f0c22e0
d: 0xaaab0f0c2300
e: 0xaaab0f0c2320
f: 0xaaab0f0c2340
g: 0xaaab0f0c2360
h: 0xaaab0f0c2380
i: 0xaaab0f0c23a0
After reallocations:
a1: 0xaaab0f0c2360
b1: 0xaaab0f0c2340
c1: 0xaaab0f0c2320
d1: 0xaaab0f0c2300
e1: 0xaaab0f0c22e0
f1: 0xaaab0f0c22c0
g1: 0xaaab0f0c22a0
h1: 0xaaab0f0c2380
<strong>i1: 0xaaab0f0c23a0
</strong><strong>i2: 0xaaab0f0c23a0
</strong></code></pre>

## Przykady

* [**Dragon Army. Hack The Box**](https://7rocky.github.io/en/ctf/htb-challenges/pwn/dragon-army/)
* Mo偶emy alokowa tylko kawaki o rozmiarze Fast-Bin, z wyjtkiem rozmiaru `0x70`, co uniemo偶liwia zwyke nadpisanie `__malloc_hook`.
* Zamiast tego u偶ywamy adres贸w PIE, kt贸re zaczynaj si od `0x56` jako celu dla Fast Bin dup (1/2 szansy).
* Jednym z miejsc, w kt贸rych przechowywane s adresy PIE, jest `main_arena`, kt贸ry znajduje si w Glibc i blisko `__malloc_hook`.
* Celujemy w konkretny offset `main_arena`, aby alokowa kawaek tam i kontynuowa alokacj kawak贸w, a偶 dotrzemy do `__malloc_hook`, aby uzyska wykonanie kodu.
* [**zero_to_hero. PicoCTF**](https://7rocky.github.io/en/ctf/picoctf/binary-exploitation/zero_to_hero/)
* U偶ywajc pojemnik贸w Tcache i przepenienia null-byte, mo偶emy osign sytuacj podw贸jnego zwolnienia:
* Alokujemy trzy kawaki o rozmiarze `0x110` (`A`, `B`, `C`)
* Zwalniamy `B`
* Zwalniamy `A` i alokujemy ponownie, aby wykorzysta przepenienie null-byte
* Teraz pole rozmiaru `B` wynosi `0x100`, zamiast `0x111`, wic mo偶emy je zwolni ponownie
* Mamy jeden pojemnik Tcache o rozmiarze `0x110` i jeden o rozmiarze `0x100`, kt贸re wskazuj na ten sam adres. Mamy wic podw贸jne zwolnienie.
* Wykorzystujemy podw贸jne zwolnienie, u偶ywajc [Tcache poisoning](tcache-bin-attack.md)

## Odniesienia

* [https://heap-exploitation.dhavalkapil.com/attacks/double\_free](https://heap-exploitation.dhavalkapil.com/attacks/double\_free)

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si sztuczkami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
