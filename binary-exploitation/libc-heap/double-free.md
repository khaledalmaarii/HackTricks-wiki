# Podw贸jne Zwolnienie

<details>

<summary><strong>Nauka hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF** sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**Grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>

## Podstawowe Informacje

Jeli zwolnisz blok pamici wicej ni偶 raz, mo偶e to zaburzy dane alokatora i otworzy drzwi do atak贸w. Oto jak to si dzieje: gdy zwalniasz blok pamici, wraca on do listy wolnych fragment贸w (np. "szybki blok"). Jeli zwolnisz ten sam blok dwa razy z rzdu, alokator wykrywa to i zgasza bd. Ale jeli **zwolnisz inny fragment pomidzy nimi, sprawdzanie podw贸jnego zwolnienia jest obejcione**, co powoduje uszkodzenie.

Teraz, gdy poprosisz o now pami (u偶ywajc `malloc`), alokator mo偶e da ci **blok, kt贸ry zosta zwolniony dwukrotnie**. Mo偶e to prowadzi do dw贸ch r贸偶nych wska藕nik贸w wskazujcych na t sam lokalizacj pamici. Jeli atakujcy kontroluje jeden z tych wska藕nik贸w, mo偶e zmieni zawarto tej pamici, co mo偶e powodowa problemy z bezpieczestwem lub nawet umo偶liwi mu wykonanie kodu.

Przykad:
```c
#include <stdio.h>
#include <stdlib.h>

int main() {
// Allocate memory for three chunks
char *a = (char *)malloc(10);
char *b = (char *)malloc(10);
char *c = (char *)malloc(10);
char *d = (char *)malloc(10);
char *e = (char *)malloc(10);
char *f = (char *)malloc(10);
char *g = (char *)malloc(10);
char *h = (char *)malloc(10);
char *i = (char *)malloc(10);

// Print initial memory addresses
printf("Initial allocations:\n");
printf("a: %p\n", (void *)a);
printf("b: %p\n", (void *)b);
printf("c: %p\n", (void *)c);
printf("d: %p\n", (void *)d);
printf("e: %p\n", (void *)e);
printf("f: %p\n", (void *)f);
printf("g: %p\n", (void *)g);
printf("h: %p\n", (void *)h);
printf("i: %p\n", (void *)i);

// Fill tcache
free(a);
free(b);
free(c);
free(d);
free(e);
free(f);
free(g);

// Introduce double-free vulnerability in fast bin
free(h);
free(i);
free(h);


// Reallocate memory and print the addresses
char *a1 = (char *)malloc(10);
char *b1 = (char *)malloc(10);
char *c1 = (char *)malloc(10);
char *d1 = (char *)malloc(10);
char *e1 = (char *)malloc(10);
char *f1 = (char *)malloc(10);
char *g1 = (char *)malloc(10);
char *h1 = (char *)malloc(10);
char *i1 = (char *)malloc(10);
char *i2 = (char *)malloc(10);

// Print initial memory addresses
printf("After reallocations:\n");
printf("a1: %p\n", (void *)a1);
printf("b1: %p\n", (void *)b1);
printf("c1: %p\n", (void *)c1);
printf("d1: %p\n", (void *)d1);
printf("e1: %p\n", (void *)e1);
printf("f1: %p\n", (void *)f1);
printf("g1: %p\n", (void *)g1);
printf("h1: %p\n", (void *)h1);
printf("i1: %p\n", (void *)i1);
printf("i2: %p\n", (void *)i1);

return 0;
}
```
W tym przykadzie, po zapenieniu tcache kilkoma zwolnionymi fragmentami (7), kod **zwalnia fragment `h`, nastpnie fragment `i`, a nastpnie ponownie `h`, powodujc podw贸jne zwolnienie** (znane r贸wnie偶 jako duplikat Fast Bin). Otwiera to mo偶liwo otrzymywania nakadajcych si adres贸w pamici podczas ponownego przydzielania, co oznacza, 偶e dwa lub wicej wska藕nik贸w mog wskazywa na ten sam obszar pamici. Manipulowanie danymi za pomoc jednego wska藕nika mo偶e wpyn na drugi, tworzc powa偶ne ryzyko bezpieczestwa i potencja do eksploatacji.

Wykonujc to, zauwa偶, jak **`i1` i `i2` otrzymay ten sam adres**:

<pre><code>Alokacje pocztkowe:
a: 0xaaab0f0c22a0
b: 0xaaab0f0c22c0
c: 0xaaab0f0c22e0
d: 0xaaab0f0c2300
e: 0xaaab0f0c2320
f: 0xaaab0f0c2340
g: 0xaaab0f0c2360
h: 0xaaab0f0c2380
i: 0xaaab0f0c23a0
Po ponownych przydziaach:
a1: 0xaaab0f0c2360
b1: 0xaaab0f0c2340
c1: 0xaaab0f0c2320
d1: 0xaaab0f0c2300
e1: 0xaaab0f0c22e0
f1: 0xaaab0f0c22c0
g1: 0xaaab0f0c22a0
h1: 0xaaab0f0c2380
<strong>i1: 0xaaab0f0c23a0
</strong><strong>i2: 0xaaab0f0c23a0
</strong></code></pre>

## Przykady

* [**Dragon Army. Hack The Box**](https://7rocky.github.io/en/ctf/htb-challenges/pwn/dragon-army/)
* Mo偶emy przydziela tylko fragmenty o rozmiarze Fast-Bin, z wyjtkiem rozmiaru `0x70`, co uniemo偶liwia standardowe nadpisanie `__malloc_hook`.
* Zamiast tego u偶ywamy adres贸w PIE, kt贸re zaczynaj si od `0x56` jako celu dla Fast Bin dup (1/2 szansy).
* Jednym miejscem, gdzie przechowywane s adresy PIE, jest `main_arena`, kt贸ra znajduje si wewntrz Glibc i w pobli偶u `__malloc_hook`.
* Celujemy w okrelony offset `main_arena`, aby przydzieli tam fragment, a nastpnie kontynuujemy przydzielanie fragment贸w, a偶 dotrzemy do `__malloc_hook`, aby uzyska wykonanie kodu.
* [**zero_to_hero. PicoCTF**](https://7rocky.github.io/en/ctf/picoctf/binary-exploitation/zero_to_hero/)
* Korzystajc z pojemnik贸w Tcache i przepenienia bajtu zerowego, mo偶emy osign sytuacj podw贸jnego zwolnienia:
* Alokujemy trzy fragmenty o rozmiarze `0x110` (`A`, `B`, `C`)
* Zwalniamy `B`
* Zwalniamy `A` i ponownie przydzielamy, aby skorzysta z przepenienia bajtu zerowego
* Teraz pole rozmiaru `B` to `0x100`, zamiast `0x111`, wic mo偶emy go ponownie zwolni
* Mamy jeden pojemnik Tcache o rozmiarze `0x110` i jeden o rozmiarze `0x100`, kt贸re wskazuj na ten sam adres. Mamy wic podw贸jne zwolnienie.
* Wykorzystujemy podw贸jne zwolnienie za pomoc [zatruwania Tcache](tcache-bin-attack.md)

## Odnoniki

* [https://heap-exploitation.dhavalkapil.com/attacks/double\_free](https://heap-exploitation.dhavalkapil.com/attacks/double\_free)

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
