# åŒé‡é‡Šæ”¾

{% hint style="success" %}
å­¦ä¹ å¹¶ç»ƒä¹  AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å¹¶ç»ƒä¹  GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æ£€æŸ¥[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

å¦‚æœé‡Šæ”¾ä¸€å—å†…å­˜è¶…è¿‡ä¸€æ¬¡ï¼Œå¯èƒ½ä¼šç ´ååˆ†é…å™¨çš„æ•°æ®å¹¶æ‰“å¼€æ”»å‡»çš„å¤§é—¨ã€‚å…·ä½“æƒ…å†µå¦‚ä¸‹ï¼šå½“é‡Šæ”¾ä¸€å—å†…å­˜æ—¶ï¼Œå®ƒä¼šå›åˆ°ç©ºé—²å—åˆ—è¡¨ä¸­ï¼ˆä¾‹å¦‚â€œå¿«é€Ÿå—â€ï¼‰ã€‚å¦‚æœè¿ç»­ä¸¤æ¬¡é‡Šæ”¾ç›¸åŒçš„å†…å­˜å—ï¼Œåˆ†é…å™¨ä¼šæ£€æµ‹åˆ°å¹¶æŠ¥é”™ã€‚ä½†æ˜¯ï¼Œå¦‚æœ**åœ¨ä¸¤æ¬¡é‡Šæ”¾ä¹‹é—´é‡Šæ”¾å¦ä¸€å—å†…å­˜å—ï¼Œåˆ™ä¼šç»•è¿‡åŒé‡é‡Šæ”¾æ£€æŸ¥**ï¼Œå¯¼è‡´æ•°æ®æŸåã€‚

ç°åœ¨ï¼Œå½“æ‚¨è¯·æ±‚æ–°çš„å†…å­˜ï¼ˆä½¿ç”¨ `malloc`ï¼‰æ—¶ï¼Œåˆ†é…å™¨å¯èƒ½ä¼šç»™æ‚¨ä¸€ä¸ª**å·²ç»è¢«é‡Šæ”¾ä¸¤æ¬¡çš„å—**ã€‚è¿™å¯èƒ½å¯¼è‡´ä¸¤ä¸ªä¸åŒçš„æŒ‡é’ˆæŒ‡å‘ç›¸åŒçš„å†…å­˜ä½ç½®ã€‚å¦‚æœæ”»å‡»è€…æ§åˆ¶å…¶ä¸­ä¸€ä¸ªæŒ‡é’ˆï¼Œä»–ä»¬å¯ä»¥æ›´æ”¹è¯¥å†…å­˜çš„å†…å®¹ï¼Œè¿™å¯èƒ½å¯¼è‡´å®‰å…¨é—®é¢˜ï¼Œç”šè‡³å…è®¸ä»–ä»¬æ‰§è¡Œä»£ç ã€‚

ç¤ºä¾‹ï¼š
```c
#include <stdio.h>
#include <stdlib.h>

int main() {
// Allocate memory for three chunks
char *a = (char *)malloc(10);
char *b = (char *)malloc(10);
char *c = (char *)malloc(10);
char *d = (char *)malloc(10);
char *e = (char *)malloc(10);
char *f = (char *)malloc(10);
char *g = (char *)malloc(10);
char *h = (char *)malloc(10);
char *i = (char *)malloc(10);

// Print initial memory addresses
printf("Initial allocations:\n");
printf("a: %p\n", (void *)a);
printf("b: %p\n", (void *)b);
printf("c: %p\n", (void *)c);
printf("d: %p\n", (void *)d);
printf("e: %p\n", (void *)e);
printf("f: %p\n", (void *)f);
printf("g: %p\n", (void *)g);
printf("h: %p\n", (void *)h);
printf("i: %p\n", (void *)i);

// Fill tcache
free(a);
free(b);
free(c);
free(d);
free(e);
free(f);
free(g);

// Introduce double-free vulnerability in fast bin
free(h);
free(i);
free(h);


// Reallocate memory and print the addresses
char *a1 = (char *)malloc(10);
char *b1 = (char *)malloc(10);
char *c1 = (char *)malloc(10);
char *d1 = (char *)malloc(10);
char *e1 = (char *)malloc(10);
char *f1 = (char *)malloc(10);
char *g1 = (char *)malloc(10);
char *h1 = (char *)malloc(10);
char *i1 = (char *)malloc(10);
char *i2 = (char *)malloc(10);

// Print initial memory addresses
printf("After reallocations:\n");
printf("a1: %p\n", (void *)a1);
printf("b1: %p\n", (void *)b1);
printf("c1: %p\n", (void *)c1);
printf("d1: %p\n", (void *)d1);
printf("e1: %p\n", (void *)e1);
printf("f1: %p\n", (void *)f1);
printf("g1: %p\n", (void *)g1);
printf("h1: %p\n", (void *)h1);
printf("i1: %p\n", (void *)i1);
printf("i2: %p\n", (void *)i1);

return 0;
}
```
åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œåœ¨ç”¨å¤šä¸ªå·²é‡Šæ”¾çš„å—å¡«å……tcacheåï¼ˆ7ä¸ªï¼‰ï¼Œä»£ç **é‡Šæ”¾äº†å—`h`ï¼Œç„¶åæ˜¯å—`i`ï¼Œç„¶åå†æ¬¡é‡Šæ”¾`h`ï¼Œå¯¼è‡´åŒé‡é‡Šæ”¾**ï¼ˆä¹Ÿç§°ä¸ºFast Bin dupï¼‰ã€‚è¿™æ‰“å¼€äº†é‡æ–°åˆ†é…æ—¶æ¥æ”¶é‡å å†…å­˜åœ°å€çš„å¯èƒ½æ€§ï¼Œæ„å‘³ç€ä¸¤ä¸ªæˆ–æ›´å¤šæŒ‡é’ˆå¯ä»¥æŒ‡å‘åŒä¸€å†…å­˜ä½ç½®ã€‚é€šè¿‡ä¸€ä¸ªæŒ‡é’ˆæ“çºµæ•°æ®ç„¶åå¯ä»¥å½±å“å¦ä¸€ä¸ªï¼Œä»è€Œåˆ›å»ºäº†ä¸¥é‡çš„å®‰å…¨é£é™©å’Œæ½œåœ¨çš„åˆ©ç”¨å¯èƒ½æ€§ã€‚

æ‰§è¡Œåï¼Œæ³¨æ„**`i1`å’Œ`i2`è·å¾—äº†ç›¸åŒçš„åœ°å€**ï¼š

<pre><code>åˆå§‹åˆ†é…ï¼š
a: 0xaaab0f0c22a0
b: 0xaaab0f0c22c0
c: 0xaaab0f0c22e0
d: 0xaaab0f0c2300
e: 0xaaab0f0c2320
f: 0xaaab0f0c2340
g: 0xaaab0f0c2360
h: 0xaaab0f0c2380
i: 0xaaab0f0c23a0
é‡æ–°åˆ†é…åï¼š
a1: 0xaaab0f0c2360
b1: 0xaaab0f0c2340
c1: 0xaaab0f0c2320
d1: 0xaaab0f0c2300
e1: 0xaaab0f0c22e0
f1: 0xaaab0f0c22c0
g1: 0xaaab0f0c22a0
h1: 0xaaab0f0c2380
<strong>i1: 0xaaab0f0c23a0
</strong><strong>i2: 0xaaab0f0c23a0
</strong></code></pre>

## ç¤ºä¾‹

* [**Dragon Army. Hack The Box**](https://7rocky.github.io/en/ctf/htb-challenges/pwn/dragon-army/)
* æˆ‘ä»¬åªèƒ½åˆ†é…Fast Binå¤§å°çš„å—ï¼Œé™¤äº†å¤§å°ä¸º`0x70`çš„æƒ…å†µï¼Œè¿™å¯ä»¥é˜²æ­¢é€šå¸¸çš„`__malloc_hook`è¦†å†™ã€‚
* ç›¸åï¼Œæˆ‘ä»¬ä½¿ç”¨ä»¥`0x56`å¼€å¤´çš„PIEåœ°å€ä½œä¸ºFast Bin dupçš„ç›®æ ‡ï¼ˆ1/2çš„å‡ ç‡ï¼‰ã€‚
* å­˜å‚¨PIEåœ°å€çš„ä¸€ä¸ªåœ°æ–¹æ˜¯åœ¨`main_arena`ä¸­ï¼Œå®ƒä½äºGlibcå†…éƒ¨å¹¶é è¿‘`__malloc_hook`ã€‚
* æˆ‘ä»¬é’ˆå¯¹`main_arena`çš„ç‰¹å®šåç§»é‡æ¥åˆ†é…ä¸€ä¸ªå—ï¼Œå¹¶ç»§ç»­åˆ†é…å—ç›´åˆ°è¾¾åˆ°`__malloc_hook`ä»¥è·å–ä»£ç æ‰§è¡Œæƒé™ã€‚
* [**zero_to_hero. PicoCTF**](https://7rocky.github.io/en/ctf/picoctf/binary-exploitation/zero_to_hero/)
* ä½¿ç”¨Tcache binså’Œç©ºå­—èŠ‚æº¢å‡ºï¼Œæˆ‘ä»¬å¯ä»¥å®ç°åŒé‡é‡Šæ”¾æƒ…å†µï¼š
* æˆ‘ä»¬åˆ†é…ä¸‰ä¸ªå¤§å°ä¸º`0x110`çš„å—ï¼ˆ`A`ï¼Œ`B`ï¼Œ`C`ï¼‰
* æˆ‘ä»¬é‡Šæ”¾`B`
* æˆ‘ä»¬é‡Šæ”¾`A`å¹¶é‡æ–°åˆ†é…ä»¥ä½¿ç”¨ç©ºå­—èŠ‚æº¢å‡º
* ç°åœ¨`B`çš„å¤§å°å­—æ®µä¸º`0x100`ï¼Œè€Œä¸æ˜¯`0x111`ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å†æ¬¡é‡Šæ”¾å®ƒ
* æˆ‘ä»¬æœ‰ä¸€ä¸ªå¤§å°ä¸º`0x110`çš„Tcache-binå’Œä¸€ä¸ªå¤§å°ä¸º`0x100`çš„Tcache-binæŒ‡å‘åŒä¸€åœ°å€ã€‚æ‰€ä»¥æˆ‘ä»¬æœ‰ä¸€ä¸ªåŒé‡é‡Šæ”¾ã€‚
* æˆ‘ä»¬åˆ©ç”¨åŒé‡é‡Šæ”¾ä½¿ç”¨[Tcache poisoning](tcache-bin-attack.md)

## å‚è€ƒèµ„æ–™

* [https://heap-exploitation.dhavalkapil.com/attacks/double\_free](https://heap-exploitation.dhavalkapil.com/attacks/double\_free)

{% hint style="success" %}
å­¦ä¹ å¹¶ç»ƒä¹ AWS Hackingï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å¹¶ç»ƒä¹ GCP Hackingï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚**

</details>
{% endhint %}
