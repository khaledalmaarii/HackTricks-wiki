# Double Free

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Temel Bilgiler

EÄŸer bir bellek bloÄŸunu birden fazla kez serbest bÄ±rakÄ±rsanÄ±z, bu, ayÄ±rÄ±cÄ± verilerini bozabilir ve saldÄ±rÄ±lara kapÄ± aÃ§abilir. Ä°ÅŸte bu nasÄ±l olur: bir bellek bloÄŸunu serbest bÄ±raktÄ±ÄŸÄ±nÄ±zda, bu, serbest parÃ§alarÄ±n bir listesine geri dÃ¶ner (Ã¶rneÄŸin, "hÄ±zlÄ± kutu"). EÄŸer aynÄ± bloÄŸu ardÄ±ÅŸÄ±k olarak iki kez serbest bÄ±rakÄ±rsanÄ±z, ayÄ±rÄ±cÄ± bunu tespit eder ve bir hata fÄ±rlatÄ±r. Ancak eÄŸer **araya baÅŸka bir parÃ§ayÄ± serbest bÄ±rakÄ±rsanÄ±z, Ã§ift serbest bÄ±rakma kontrolÃ¼ atlanÄ±r**, bu da bozulmaya neden olur.

ArtÄ±k yeni bellek talep ettiÄŸinizde (`malloc` kullanarak), ayÄ±rÄ±cÄ± size **iki kez serbest bÄ±rakÄ±lmÄ±ÅŸ bir bloÄŸu** verebilir. Bu, iki farklÄ± iÅŸaretÃ§inin aynÄ± bellek konumuna iÅŸaret etmesine neden olabilir. EÄŸer bir saldÄ±rgan bu iÅŸaretÃ§ilerden birini kontrol ederse, o bellek iÃ§eriÄŸini deÄŸiÅŸtirebilir, bu da gÃ¼venlik sorunlarÄ±na yol aÃ§abilir veya hatta kod Ã§alÄ±ÅŸtÄ±rmalarÄ±na izin verebilir.

Ã–rnek:
```c
#include <stdio.h>
#include <stdlib.h>

int main() {
// Allocate memory for three chunks
char *a = (char *)malloc(10);
char *b = (char *)malloc(10);
char *c = (char *)malloc(10);
char *d = (char *)malloc(10);
char *e = (char *)malloc(10);
char *f = (char *)malloc(10);
char *g = (char *)malloc(10);
char *h = (char *)malloc(10);
char *i = (char *)malloc(10);

// Print initial memory addresses
printf("Initial allocations:\n");
printf("a: %p\n", (void *)a);
printf("b: %p\n", (void *)b);
printf("c: %p\n", (void *)c);
printf("d: %p\n", (void *)d);
printf("e: %p\n", (void *)e);
printf("f: %p\n", (void *)f);
printf("g: %p\n", (void *)g);
printf("h: %p\n", (void *)h);
printf("i: %p\n", (void *)i);

// Fill tcache
free(a);
free(b);
free(c);
free(d);
free(e);
free(f);
free(g);

// Introduce double-free vulnerability in fast bin
free(h);
free(i);
free(h);


// Reallocate memory and print the addresses
char *a1 = (char *)malloc(10);
char *b1 = (char *)malloc(10);
char *c1 = (char *)malloc(10);
char *d1 = (char *)malloc(10);
char *e1 = (char *)malloc(10);
char *f1 = (char *)malloc(10);
char *g1 = (char *)malloc(10);
char *h1 = (char *)malloc(10);
char *i1 = (char *)malloc(10);
char *i2 = (char *)malloc(10);

// Print initial memory addresses
printf("After reallocations:\n");
printf("a1: %p\n", (void *)a1);
printf("b1: %p\n", (void *)b1);
printf("c1: %p\n", (void *)c1);
printf("d1: %p\n", (void *)d1);
printf("e1: %p\n", (void *)e1);
printf("f1: %p\n", (void *)f1);
printf("g1: %p\n", (void *)g1);
printf("h1: %p\n", (void *)h1);
printf("i1: %p\n", (void *)i1);
printf("i2: %p\n", (void *)i2);

return 0;
}
```
Bu Ã¶rnekte, tcache'i birkaÃ§ serbest bÄ±rakÄ±lmÄ±ÅŸ parÃ§a (7) ile doldurduktan sonra, kod **`h` parÃ§asÄ±nÄ± serbest bÄ±rakÄ±r, ardÄ±ndan `i` parÃ§asÄ±nÄ± serbest bÄ±rakÄ±r ve sonra tekrar `h` parÃ§asÄ±nÄ± serbest bÄ±rakÄ±r, bu da bir double free'e neden olur** (aynÄ± zamanda Fast Bin dup olarak da bilinir). Bu, yeniden tahsis ederken Ã¼st Ã¼ste binen bellek adresleri alma olasÄ±lÄ±ÄŸÄ±nÄ± aÃ§ar, bu da iki veya daha fazla iÅŸaretÃ§inin aynÄ± bellek konumuna iÅŸaret edebileceÄŸi anlamÄ±na gelir. Bir iÅŸaretÃ§i aracÄ±lÄ±ÄŸÄ±yla verileri manipÃ¼le etmek, diÄŸerini etkileyebilir ve bu da kritik bir gÃ¼venlik riski ve potansiyel bir istismar olanaÄŸÄ± yaratÄ±r.

Bunu yÃ¼rÃ¼tÃ¼rken, **`i1` ve `i2`'nin aynÄ± adresi aldÄ±ÄŸÄ±nÄ±** not edin:

<pre><code>BaÅŸlangÄ±Ã§ tahsisleri:
a: 0xaaab0f0c22a0
b: 0xaaab0f0c22c0
c: 0xaaab0f0c22e0
d: 0xaaab0f0c2300
e: 0xaaab0f0c2320
f: 0xaaab0f0c2340
g: 0xaaab0f0c2360
h: 0xaaab0f0c2380
i: 0xaaab0f0c23a0
Yeniden tahsislerden sonra:
a1: 0xaaab0f0c2360
b1: 0xaaab0f0c2340
c1: 0xaaab0f0c2320
d1: 0xaaab0f0c2300
e1: 0xaaab0f0c22e0
f1: 0xaaab0f0c22c0
g1: 0xaaab0f0c22a0
h1: 0xaaab0f0c2380
<strong>i1: 0xaaab0f0c23a0
</strong><strong>i2: 0xaaab0f0c23a0
</strong></code></pre>

## Ã–rnekler

* [**Dragon Army. Hack The Box**](https://7rocky.github.io/en/ctf/htb-challenges/pwn/dragon-army/)
* Sadece `0x70` boyutunun dÄ±ÅŸÄ±nda Fast-Bin boyutunda parÃ§alar tahsis edebiliriz, bu da olaÄŸan `__malloc_hook` Ã¼zerine yazmayÄ± engeller.
* Bunun yerine, Fast Bin dup iÃ§in hedef olarak `0x56` ile baÅŸlayan PIE adreslerini kullanÄ±yoruz (1/2 ÅŸansÄ±).
* PIE adreslerinin saklandÄ±ÄŸÄ± yerlerden biri `main_arena`'dÄ±r, bu Glibc iÃ§inde ve `__malloc_hook`'a yakÄ±ndÄ±r.
* Orada bir parÃ§a tahsis etmek iÃ§in `main_arena`'nÄ±n belirli bir ofsetini hedef alÄ±yoruz ve `__malloc_hook`'a ulaÅŸana kadar parÃ§alar tahsis etmeye devam ediyoruz.
* [**zero_to_hero. PicoCTF**](https://7rocky.github.io/en/ctf/picoctf/binary-exploitation/zero_to_hero/)
* Tcache kutularÄ±nÄ± ve bir null-byte taÅŸmasÄ±nÄ± kullanarak bir double-free durumu elde edebiliriz:
* `0x110` boyutunda Ã¼Ã§ parÃ§a tahsis ediyoruz (`A`, `B`, `C`)
* `B`'yi serbest bÄ±rakÄ±yoruz
* `A`'yÄ± serbest bÄ±rakÄ±yoruz ve null-byte taÅŸmasÄ±nÄ± kullanmak iÃ§in tekrar tahsis ediyoruz
* ArtÄ±k `B`'nin boyut alanÄ± `0x100`, `0x111` yerine, bu yÃ¼zden tekrar serbest bÄ±rakabiliriz
* `0x110` boyutunda bir Tcache-bin ve aynÄ± adrese iÅŸaret eden `0x100` boyutunda bir tane var. Yani bir double free'imiz var.
* [Tcache poisoning](tcache-bin-attack.md) kullanarak double free'i deÄŸerlendiriyoruz.

## Referanslar

* [https://heap-exploitation.dhavalkapil.com/attacks/double\_free](https://heap-exploitation.dhavalkapil.com/attacks/double\_free)

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter**'da **bizi takip edin** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.**

</details>
{% endhint %}
