# Heap TaÅŸmasÄ±

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve uygulayÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve uygulayÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katÄ±lÄ±n veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ± paylaÅŸarak PR'ler gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>
{% endhint %}

## Temel Bilgiler

Bir heap taÅŸmasÄ±, heap'te bir [**yÄ±ÄŸÄ±n taÅŸmasÄ±**](../stack-overflow/) gibi. Temelde, heap'te belirli bir veriyi depolamak iÃ§in bir alan ayrÄ±lmÄ±ÅŸ ve **depolanan veri ayrÄ±lan alandan daha bÃ¼yÃ¼k olmuÅŸ.**

YÄ±ÄŸÄ±n taÅŸmalarÄ±nda, yÄ±ÄŸÄ±ndan bazÄ± kayÄ±tlarÄ±n (Ã¶rneÄŸin yÃ¶nlendirme iÅŸaretÃ§isi veya yÄ±ÄŸÄ±n Ã§erÃ§evesi) geri yÃ¼kleneceÄŸini ve bunun istismar edilebileceÄŸini biliyoruz. Heap taÅŸmalarÄ±nda ise, taÅŸÄ±nabilecek **varsayÄ±lan olarak hassas bilgi depolanan** bir heap parÃ§asÄ± yok. Bununla birlikte, hassas bilgi veya iÅŸaretÃ§iler olabilir, bu nedenle bu zafiyetin **kritikliÄŸi**, bu zafiyetin **hangi verilerin Ã¼zerine yazÄ±labileceÄŸine** ve bir saldÄ±rganÄ±n bunu nasÄ±l istismar edebileceÄŸine baÄŸlÄ±dÄ±r.

{% hint style="success" %}
TaÅŸma ofsetlerini bulmak iÃ§in [**yÄ±ÄŸÄ±n taÅŸmalarÄ±nda**](../stack-overflow/#finding-stack-overflows-offsets) olduÄŸu gibi aynÄ± desenleri kullanabilirsiniz.
{% endhint %}

### YÄ±ÄŸÄ±n TaÅŸmalarÄ± vs. Heap TaÅŸmalarÄ±

YÄ±ÄŸÄ±n taÅŸmalarÄ±nda, zafiyet tetiklendiÄŸinde yÄ±ÄŸÄ±nda bulunacak dÃ¼zen ve veri oldukÃ§a gÃ¼venilirdir. Bu, yÄ±ÄŸÄ±nÄ±n lineer olduÄŸu, hafÄ±zanÄ±n Ã§akÄ±ÅŸarak arttÄ±ÄŸÄ±, programÄ±n belirli yerlerinde yÄ±ÄŸÄ±n belleÄŸinin genellikle benzer tÃ¼rde verileri depoladÄ±ÄŸÄ± ve her iÅŸlev tarafÄ±ndan kullanÄ±lan yÄ±ÄŸÄ±n kÄ±smÄ±nÄ±n sonunda bazÄ± iÅŸaretÃ§ilerle belirli bir yapÄ±ya sahip olduÄŸu iÃ§in geÃ§erlidir.

Ancak, bir heap taÅŸmasÄ± durumunda, kullanÄ±lan bellek lineer deÄŸil, **ayrÄ±lmÄ±ÅŸ konumlarda genellikle ayrÄ±lmÄ±ÅŸ parÃ§alar** (yan yana deÄŸil) Ã§Ã¼nkÃ¼ boyuta gÃ¶re ayrÄ±mlarÄ± ayÄ±ran **kutular ve bÃ¶lgeler** ve **Ã¶nceki serbest bÄ±rakÄ±lan bellek kullanÄ±lÄ±r**. Bir heap taÅŸmasÄ±yla Ã§akÄ±ÅŸacak nesnenin hangisi olduÄŸunu bilmek **karmaÅŸÄ±ktÄ±r**. Bu nedenle, bir heap taÅŸmasÄ± bulunduÄŸunda, istenen nesnenin bellekteki bir sonraki olmasÄ±nÄ± saÄŸlamak iÃ§in **gÃ¼venilir bir yol bulunmasÄ± gerekir**.

Bunun iÃ§in kullanÄ±lan tekniklerden biri **Heap Grooming**'dir ve Ã¶rneÄŸin [**bu yazÄ±da**](https://azeria-labs.com/grooming-the-ios-kernel-heap/) kullanÄ±lmaktadÄ±r. YazÄ±da, iOS Ã§ekirdeÄŸinde bir bÃ¶lge belleÄŸi, bellek parÃ§alarÄ±nÄ± depolamak iÃ§in bellekten tÃ¼kendiÄŸinde, bir Ã§ekirdek sayfasÄ± ile geniÅŸletilir ve bu sayfa beklenen boyuttaki parÃ§alara bÃ¶lÃ¼nÃ¼r (iOS sÃ¼rÃ¼m 9.2'ye kadar, ardÄ±ndan bu parÃ§alarÄ±n bu saldÄ±rÄ±larÄ±n zorlaÅŸtÄ±rÄ±lmasÄ± iÃ§in rastgele bir ÅŸekilde kullanÄ±ldÄ±ÄŸÄ± belirtilir).

Bu nedenle, bir heap taÅŸmasÄ± gerÃ§ekleÅŸtiÄŸinde, taÅŸan nesnenin Ã§akÄ±ÅŸacak ÅŸekilde zorlanmasÄ± iÃ§in birkaÃ§ **`kalloc`'un** birkaÃ§ iÅŸ parÃ§asÄ± tarafÄ±ndan zorlanmasÄ± gerekmektedir ve tÃ¼m boÅŸ parÃ§alarÄ±n doldurulduÄŸundan ve yeni bir sayfa oluÅŸturulduÄŸundan emin olunmalÄ±dÄ±r.

Belirli bir boyuttaki nesnelerle bu doldurmayÄ± zorlamak iÃ§in, **iOS mach port ile iliÅŸkilendirilmiÅŸ dÄ±ÅŸ hattan tahsis** ideal bir adaydÄ±r. MesajÄ±n boyutunu ÅŸekillendirerek, `kalloc` tahsisinin boyutunu tam olarak belirlemek mÃ¼mkÃ¼ndÃ¼r ve karÅŸÄ±lÄ±k gelen mach portu yok edildiÄŸinde, karÅŸÄ±lÄ±k gelen tahsis hemen `kfree`'ye geri bÄ±rakÄ±lacaktÄ±r.

ArdÄ±ndan, bazÄ± bu yer tutucular **serbest bÄ±rakÄ±labilir**. **`kalloc.4096` serbest listesi elemanlarÄ± son giren ilk Ã§Ä±kan dÃ¼zeninde serbest bÄ±rakÄ±r**, bu da temelde bazÄ± yer tutucularÄ±n serbest bÄ±rakÄ±ldÄ±ÄŸÄ± ve saldÄ±rÄ±nÄ±n taÅŸma olabilecek nesneyi tahsis etmeye Ã§alÄ±ÅŸÄ±rken birkaÃ§ kurban nesne tahsis etmeye Ã§alÄ±ÅŸtÄ±ÄŸÄ± durumda, bu nesnenin bir kurban nesne tarafÄ±ndan takip edileceÄŸi olasÄ±lÄ±ÄŸÄ±nÄ±n yÃ¼ksek olduÄŸu anlamÄ±na gelir.

### Ã–rnek libc

[**Bu sayfada**](https://guyinatuxedo.github.io/27-edit\_free\_chunk/heap\_consolidation\_explanation/index.html) bir temel Heap taÅŸmasÄ± emÃ¼lasyonu bulunabilir. Bir sonraki parÃ§anÄ±n kullanÄ±lan Ã¶nceki bitini ve Ã¶nceki boyutun konumunu deÄŸiÅŸtirerek, **kullanÄ±lan bir parÃ§ayÄ± birleÅŸtirmek** (kullanÄ±lmadÄ±ÄŸÄ±na inandÄ±rarak) ve ardÄ±ndan tekrar tahsis ederek farklÄ± bir iÅŸaretÃ§ide kullanÄ±lan verileri Ã¼zerine yazmak mÃ¼mkÃ¼ndÃ¼r.

[**Protostar heap 0**](https://guyinatuxedo.github.io/24-heap\_overflow/protostar\_heap0/index.html) Ã¶rneÄŸinde, bir **heap taÅŸmasÄ±nÄ±n** bayraÄŸÄ± **almak iÃ§in** kazan fonksiyonunu Ã§aÄŸÄ±rmak iÃ§in **kullanÄ±labilecek** bir CTF'nin Ã§ok temel bir Ã¶rneÄŸi gÃ¶sterilmektedir.

[**Protostar heap 1**](https://guyinatuxedo.github.io/24-heap\_overflow/protostar\_heap1/index.html) Ã¶rneÄŸinde, bir tampon taÅŸmasÄ±nÄ±n **kullanÄ±cÄ±dan alÄ±nan keyfi verinin yazÄ±lacaÄŸÄ± yakÄ±n bir parÃ§ada bir adresi Ã¼zerine yazmak** mÃ¼mkÃ¼n olduÄŸu gÃ¶rÃ¼lebilir.

### Ã–rnek ARM64

[https://8ksec.io/arm64-reversing-and-exploitation-part-1-arm-instruction-set-simple-heap-overflow/](https://8ksec.io/arm64-reversing-and-exploitation-part-1-arm-instruction-set-simple-heap-overflow/) sayfasÄ±nda, yÄ±ÄŸÄ±n taÅŸmasÄ± Ã¶rneÄŸi bulunabilir, burada taÅŸan parÃ§adan sonraki parÃ§ada saklanacak bir komut bulunmaktadÄ±r. Bu nedenle, basit bir saldÄ±rÄ± ile komutu deÄŸiÅŸtirerek yÃ¼rÃ¼tÃ¼lecek komutu deÄŸiÅŸtirmek mÃ¼mkÃ¼ndÃ¼r.
```bash
python3 -c 'print("/"*0x400+"/bin/ls\x00")' > hax.txt
```
### DiÄŸer Ã¶rnekler

* [**Auth-or-out. Hack The Box**](https://7rocky.github.io/en/ctf/htb-challenges/pwn/auth-or-out/)
* Bir TamsayÄ± TaÅŸma zafiyetini kullanarak Bir Heap TaÅŸmasÄ± elde ediyoruz.
* TaÅŸan parÃ§anÄ±n iÃ§indeki bir `struct`'Ä±n iÅŸaretÃ§ilerini bozarak bir iÅŸlevi, Ã¶rneÄŸin `system` iÅŸlevini ayarlÄ±yoruz ve kod yÃ¼rÃ¼tme elde ediyoruz.

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve uygulayÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve uygulayÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katÄ±lÄ±n veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* Hacking pÃ¼f noktalarÄ±nÄ± paylaÅŸarak PR'lar gÃ¶ndererek **HackTricks** ve **HackTricks Cloud** github depolarÄ±na katkÄ±da bulunun.

</details>
{% endhint %}
