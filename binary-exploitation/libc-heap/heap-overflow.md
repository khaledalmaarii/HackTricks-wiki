# Desbordamiento de Mont贸n

<details>

<summary><strong>Aprende a hackear AWS desde cero hasta convertirte en un experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informaci贸n B谩sica

Un desbordamiento de mont贸n es como un [**desbordamiento de pila**](../stack-overflow/) pero en el mont贸n. B谩sicamente significa que se reserv贸 un espacio en el mont贸n para almacenar algunos datos y **los datos almacenados eran m谩s grandes que el espacio reservado**.

En los desbordamientos de pila sabemos que algunos registros como el puntero de instrucci贸n o el marco de pila se restaurar谩n desde la pila y podr铆a ser posible abusar de esto. En el caso de los desbordamientos de mont贸n, **no hay ninguna informaci贸n sensible almacenada por defecto** en el fragmento de mont贸n que puede ser desbordado. Sin embargo, podr铆a ser informaci贸n sensible o punteros, por lo que la **cr铆ticidad** de esta vulnerabilidad **depende** de **qu茅 datos podr铆an ser sobrescritos** y c贸mo un atacante podr铆a abusar de esto.

{% hint style="success" %}
Para encontrar los desbordamientos de desbordamiento, puedes usar los mismos patrones que en los [**desbordamientos de pila**](../stack-overflow/#finding-stack-overflows-offsets).
{% endhint %}

### Desbordamientos de Pila vs Desbordamientos de Mont贸n

En los desbordamientos de pila, la disposici贸n y los datos que van a estar presentes en la pila en el momento en que se pueda activar la vulnerabilidad son bastante confiables. Esto se debe a que la pila es lineal, siempre aumentando en memoria colisionante, en **lugares espec铆ficos de la ejecuci贸n del programa la memoria de la pila generalmente almacena un tipo de datos similar** y tiene una estructura espec铆fica con algunos punteros al final de la parte de la pila utilizada por cada funci贸n.

Sin embargo, en el caso de un desbordamiento de mont贸n, la memoria utilizada no es lineal, sino que **los fragmentos asignados suelen estar en posiciones separadas de memoria** (no uno al lado del otro) debido a **contenedores y zonas** que separan las asignaciones por tama帽o y porque **la memoria previamente liberada se utiliza** antes de asignar nuevos fragmentos. Es **complicado saber el objeto que va a colisionar con el vulnerable** a un desbordamiento de mont贸n. Por lo tanto, cuando se encuentra un desbordamiento de mont贸n, es necesario encontrar una **forma confiable de hacer que el objeto deseado est茅 a continuaci贸n en la memoria** del que puede ser desbordado.

Una de las t茅cnicas utilizadas para esto es el **Aseo de Mont贸n** que se utiliza, por ejemplo, [**en este post**](https://azeria-labs.com/grooming-the-ios-kernel-heap/). En el post se explica c贸mo en el n煤cleo de iOS, cuando una zona se queda sin memoria para almacenar fragmentos de memoria, la expande en una p谩gina de n煤cleo, y esta p谩gina se divide en fragmentos de los tama帽os esperados que se utilizar铆an en orden (hasta la versi贸n 9.2 de iOS, luego estos fragmentos se utilizan de manera aleatoria para dificultar la explotaci贸n de estos ataques).

Por lo tanto, en el post anterior donde ocurre un desbordamiento de mont贸n, para forzar que el objeto desbordado colisione con un orden de v铆ctimas, varios **`kallocs` son forzados por varios hilos para intentar asegurar que todos los fragmentos libres est茅n llenos y que se cree una nueva p谩gina**.

Para forzar este llenado con objetos de un tama帽o espec铆fico, la **asignaci贸n fuera de l铆nea asociada con un puerto mach iOS** es un candidato ideal. Al dise帽ar el tama帽o del mensaje, es posible especificar exactamente el tama帽o de la asignaci贸n de `kalloc` y cuando se destruye el puerto mach correspondiente, la asignaci贸n correspondiente se liberar谩 inmediatamente de vuelta a `kfree`.

Luego, algunos de estos marcadores de posici贸n pueden ser **liberados**. La lista de liberaci贸n de **`kalloc.4096` libera elementos en orden de 煤ltimo en entrar, primero en salir**, lo que b谩sicamente significa que si algunos marcadores de posici贸n son liberados y el exploit intenta asignar varios objetos v铆ctimas mientras intenta asignar el objeto vulnerable al desbordamiento, es probable que este objeto sea seguido por un objeto v铆ctima.

### Ejemplo libc

[**En esta p谩gina**](https://guyinatuxedo.github.io/27-edit\_free\_chunk/heap\_consolidation\_explanation/index.html) es posible encontrar una emulaci贸n b谩sica de desbordamiento de mont贸n que muestra c贸mo sobrescribir el bit previo en uso del siguiente fragmento y la posici贸n del tama帽o previo es posible **consolidar un fragmento utilizado** (haci茅ndolo creer que no se est谩 utilizando) y **luego asignarlo nuevamente** pudiendo sobrescribir datos que se est谩n utilizando en un puntero diferente tambi茅n.

Otro ejemplo de [**protostar heap 0**](https://guyinatuxedo.github.io/24-heap\_overflow/protostar\_heap0/index.html) muestra un ejemplo muy b谩sico de un CTF donde un **desbordamiento de mont贸n** puede ser abusado para llamar a la funci贸n ganadora y **obtener la bandera**.

En el ejemplo [**protostar heap 1**](https://guyinatuxedo.github.io/24-heap\_overflow/protostar\_heap1/index.html) es posible ver c贸mo abusar de un desbordamiento de b煤fer es posible **sobrescribir en un fragmento cercano una direcci贸n** donde se va a escribir **datos arbitrarios del usuario**.

### Ejemplo ARM64

En la p谩gina [https://8ksec.io/arm64-reversing-and-exploitation-part-1-arm-instruction-set-simple-heap-overflow/](https://8ksec.io/arm64-reversing-and-exploitation-part-1-arm-instruction-set-simple-heap-overflow/) puedes encontrar un ejemplo de desbordamiento de mont贸n donde un comando que se va a ejecutar se almacena en el siguiente fragmento al fragmento desbordado. Por lo tanto, es posible modificar el comando ejecutado sobrescribi茅ndolo con un exploit sencillo como:
```bash
python3 -c 'print("/"*0x400+"/bin/ls\x00")' > hax.txt
```
### Otros ejemplos

* [**Auth-or-out. Hack The Box**](https://7rocky.github.io/en/ctf/htb-challenges/pwn/auth-or-out/)
* Utilizamos una vulnerabilidad de Desbordamiento de Entero para obtener un Desbordamiento de Mont贸n.
* Corrompemos punteros a una funci贸n dentro de una `struct` del fragmento desbordado para establecer una funci贸n como `system` y lograr la ejecuci贸n de c贸digo.

<details>

<summary><strong>Aprende a hackear AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
