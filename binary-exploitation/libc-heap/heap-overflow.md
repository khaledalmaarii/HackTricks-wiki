# PrekoraÄenje hipa

{% hint style="success" %}
NauÄite i veÅ¾bajte hakovanje AWS-a:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
NauÄite i veÅ¾bajte hakovanje GCP-a: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## Osnovne informacije

PrekoraÄenje hipa je poput [**prekoraÄenja steka**](../stack-overflow/), ali u hipu. U osnovi to znaÄi da je neki prostor rezervisan u hipu za Äuvanje podataka i **Äuvani podaci su bili veÄ‡i od rezervisanog prostora.**

Kod prekoraÄenja steka znamo da Ä‡e neki registri poput pokazivaÄa instrukcija ili okvira steka biti obnovljeni sa steka i moguÄ‡e je zloupotrebiti to. U sluÄaju prekoraÄenja hipa, **nema podataka osetljivih po podrazumevanim postavkama** u hipu koji moÅ¾e biti prekoraÄen. MeÄ‘utim, mogu biti osetljivi podaci ili pokazivaÄi, pa **kritiÄnost** ove ranjivosti **zavisi** o **kojim podacima mogu biti prepisani** i kako napadaÄ moÅ¾e to zloupotrebiti.

{% hint style="success" %}
Da biste pronaÅ¡li prekoraÄenja ofseta, moÅ¾ete koristiti iste obrasce kao kod [**prekoraÄenja steka**](../stack-overflow/#finding-stack-overflows-offsets).
{% endhint %}

### PrekoraÄenje steka vs prekoraÄenje hipa

Kod prekoraÄenja steka, organizacija i podaci koji Ä‡e biti prisutni na steku u trenutku kada se moÅ¾e aktivirati ranjivost su priliÄno pouzdani. To je zato Å¡to je stek linearan, uvek se poveÄ‡ava u koliziji memorije, na **specifiÄnim mestima izvrÅ¡avanja programa stek memorija obiÄno Äuva sliÄne vrste podataka** i ima odreÄ‘enu strukturu sa nekim pokazivaÄima na kraju dela steka koji koristi svaka funkcija.

MeÄ‘utim, u sluÄaju prekoraÄenja hipa, koriÅ¡Ä‡ena memorija nije linearna veÄ‡ **dodeljeni blokovi obiÄno su na odvojenim pozicijama memorije** (ne jedan pored drugog) zbog **kanti i zona** koje razdvajaju alokacije po veliÄini i zbog toga Å¡to se **prethodno osloboÄ‘ena memorija koristi** pre nego Å¡to se dodele novi blokovi. **Komplikovano je znati koji objekat Ä‡e se sudariti sa onim koji je ranjiv** na prekoraÄenje hipa. Dakle, kada se pronaÄ‘e prekoraÄenje hipa, potrebno je pronaÄ‡i **pouzdan naÄin da se Å¾eljeni objekat naÄ‘e odmah u memoriji** pored onog koji moÅ¾e biti prekoraÄen.

Jedna od tehnika koriÅ¡Ä‡enih za to je **Gajenje hipa** koje se koristi na primer [**u ovom postu**](https://azeria-labs.com/grooming-the-ios-kernel-heap/). U postu je objaÅ¡njeno kako kada u iOS kernelu jedna zona ostane bez memorije za Äuvanje blokova memorije, proÅ¡iruje se za jednu stranicu kernela, a ova stranica se deli na blokove oÄekivanih veliÄina koji Ä‡e se koristiti redom (do verzije iOS 9.2, zatim se ovi blokovi koriste na nasumiÄan naÄin kako bi se oteÅ¾ala eksploatacija ovih napada).

Stoga, u prethodnom postu gde se deÅ¡ava prekoraÄenje hipa, kako bi se naterao prekoraÄeni objekat da se sudari sa Å¾rtvom, nekoliko **`kallocs` se forsira pomoÄ‡u nekoliko niti kako bi se osiguralo da su svi slobodni blokovi popunjeni i da je kreirana nova stranica**.

Da bi se prisililo ovo popunjavanje objektima odreÄ‘ene veliÄine, **alokacija van linije povezana sa iOS mach portom** je idealan kandidat. Oblikovanjem veliÄine poruke, moguÄ‡e je taÄno odrediti veliÄinu alokacije `kalloc` i kada odgovarajuÄ‡i mach port bude uniÅ¡ten, odgovarajuÄ‡a alokacija Ä‡e odmah biti osloboÄ‘ena natrag `kfree`.

Zatim, neki od ovih Äuvara mogu biti **osloboÄ‘eni**. Lista osloboÄ‘enih **`kalloc.4096`** elemenata oslobaÄ‘a elemente po principu poslednji unutra-prvi napolje, Å¡to u osnovi znaÄi da ako su neki Äuvari osloboÄ‘eni i eksploit pokuÅ¡a da alocira nekoliko Å¾rtvenih objekata dok pokuÅ¡ava da alocira objekat ranjiv na prekoraÄenje, verovatno je da Ä‡e ovaj objekat biti praÄ‡en Å¾rtvenim objektom.

### Primer libc-a

[**Na ovoj stranici**](https://guyinatuxedo.github.io/27-edit\_free\_chunk/heap\_consolidation\_explanation/index.html) moguÄ‡e je pronaÄ‡i osnovnu emulaciju prekoraÄenja hipa koja pokazuje kako prekoraÄenjem prethodnog bita u upotrebi sledeÄ‡eg bloka i pozicije prethodne veliÄine moguÄ‡e je **konsolidovati koriÅ¡Ä‡eni blok** (praveÄ‡i da misli da nije u upotrebi) i **zatim ga ponovo alocirati** kako bi se mogli prepisati podaci koji se koriste u drugom pokazivaÄu.

JoÅ¡ jedan primer iz [**protostar hipa 0**](https://guyinatuxedo.github.io/24-heap\_overflow/protostar\_heap0/index.html) pokazuje vrlo osnovan primer CTF-a gde se **prekoraÄenje hipa** moÅ¾e zloupotrebiti kako bi se pozvala funkcija pobednika i **dobio zastava**.

U [**protostar hipu 1**](https://guyinatuxedo.github.io/24-heap\_overflow/protostar\_heap1/index.html) primeru moguÄ‡e je videti kako zloupotrebom prekoraÄenja bafera moguÄ‡e je **prepisati u blizak blok adresu** gde Ä‡e **proizvoljni podaci od korisnika** biti upisani.

### Primer ARM64

Na stranici [https://8ksec.io/arm64-reversing-and-exploitation-part-1-arm-instruction-set-simple-heap-overflow/](https://8ksec.io/arm64-reversing-and-exploitation-part-1-arm-instruction-set-simple-heap-overflow/) moÅ¾ete pronaÄ‡i primer prekoraÄenja hipa gde je komanda koja Ä‡e biti izvrÅ¡ena smeÅ¡tena u sledeÄ‡em bloku od prekoraÄenog bloka. Dakle, moguÄ‡e je izmeniti izvrÅ¡enu komandu prepisivanjem je jednostavnim eksploatacijama kao Å¡to su:
```bash
python3 -c 'print("/"*0x400+"/bin/ls\x00")' > hax.txt
```
### Ostali primeri

* [**Auth-or-out. Hack The Box**](https://7rocky.github.io/en/ctf/htb-challenges/pwn/auth-or-out/)
* Koristimo ranjivost prelivanja celobrojne vrednosti da bismo dobili prelivanje hipa.
* Korumpiramo pokazivaÄe ka funkciji unutar `struct`-a prelivenog bloka da bismo postavili funkciju poput `system` i dobili izvrÅ¡enje koda.

{% hint style="success" %}
NauÄite i veÅ¾bajte hakovanje AWS-a:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
NauÄite i veÅ¾bajte hakovanje GCP-a: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
