# Heap TaÅŸmasÄ±

<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan kahraman seviyesine Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong> ile</strong>!</summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **KatÄ±lÄ±n** ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'da takip edin**.
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR'lar gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>

## Temel Bilgiler

Bir heap taÅŸmasÄ±, heap'te bir [**yÄ±ÄŸÄ±n taÅŸmasÄ±**](../stack-overflow/) gibi. Temelde, heap'te belirli bir veriyi depolamak iÃ§in bir alan ayrÄ±lmÄ±ÅŸ ve **depolanan veri ayrÄ±lan alandan daha bÃ¼yÃ¼k olmuÅŸ.**

YÄ±ÄŸÄ±n taÅŸmalarÄ±nda, yÄ±ÄŸÄ±ndan bazÄ± kayÄ±tlarÄ±n (Ã¶rneÄŸin yÃ¶nlendirme iÅŸaretÃ§isi veya yÄ±ÄŸÄ±n Ã§erÃ§evesi) geri yÃ¼kleneceÄŸini ve bunun istismar edilebileceÄŸini biliyoruz. Heap taÅŸmalarÄ±nda ise, taÅŸÄ±nabilecek bir **duyarlÄ± bilgi varsayÄ±lan olarak** heap parÃ§asÄ±nda depolanmaz. Bununla birlikte, hassas bilgi veya iÅŸaretÃ§iler olabilir, bu nedenle bu zafiyetin **kritikliÄŸi**, bu zafiyetten **hangi verilerin Ã¼zerine yazÄ±labileceÄŸine** ve bir saldÄ±rganÄ±n bunu nasÄ±l istismar edebileceÄŸine baÄŸlÄ±dÄ±r.

{% hint style="success" %}
TaÅŸma ofsetlerini bulmak iÃ§in [**yÄ±ÄŸÄ±n taÅŸmalarÄ±nda**](../stack-overflow/#finding-stack-overflows-offsets) olduÄŸu gibi aynÄ± desenleri kullanabilirsiniz.
{% endhint %}

### YÄ±ÄŸÄ±n TaÅŸmalarÄ± vs. Heap TaÅŸmalarÄ±

YÄ±ÄŸÄ±n taÅŸmalarÄ±nda, zafiyet tetiklendiÄŸinde yÄ±ÄŸÄ±nda bulunan dÃ¼zen ve veriler oldukÃ§a gÃ¼venilirdir. Bu, yÄ±ÄŸÄ±nÄ±n lineer olmasÄ±, her zaman Ã§arpÄ±ÅŸan bellekte artmasÄ±, programÄ±n belirli yerlerinde yÄ±ÄŸÄ±n belleÄŸinin genellikle benzer tÃ¼rde verileri depolamasÄ± ve her iÅŸlevin kullandÄ±ÄŸÄ± yÄ±ÄŸÄ±n kÄ±smÄ±nÄ±n sonunda bazÄ± iÅŸaretÃ§ilerle belirli bir yapÄ±ya sahip olmasÄ± nedeniyledir.

Ancak, bir heap taÅŸmasÄ± durumunda, kullanÄ±lan bellek lineer deÄŸildir, ancak **ayrÄ±lmÄ±ÅŸ pozisyonlarda genellikle ayrÄ±lmÄ±ÅŸ parÃ§alar** (yan yana olmayan) vardÄ±r Ã§Ã¼nkÃ¼ boyuta gÃ¶re ayrÄ±mlarÄ± ayÄ±ran **kutular ve bÃ¶lgeler** ve **Ã¶nceki serbest bÄ±rakÄ±lan bellek** yeni parÃ§alar ayrÄ±lmadan Ã¶nce kullanÄ±lÄ±r. Bir heap taÅŸmasÄ± bulunduÄŸunda, taÅŸan nesnenin hafÄ±zadaki istenen nesnenin yanÄ±nda olmasÄ±nÄ± saÄŸlayacak **gÃ¼venilir bir yol bulunmasÄ± gerekir**.

Bunun iÃ§in kullanÄ±lan tekniklerden biri **Heap Grooming**dir ve Ã¶rneÄŸin [**bu yazÄ±da**](https://azeria-labs.com/grooming-the-ios-kernel-heap/) kullanÄ±lmaktadÄ±r. YazÄ±da, iOS Ã§ekirdeÄŸinde bir bÃ¶lgenin bellekteki bellek parÃ§alarÄ±nÄ± depolamak iÃ§in hafÄ±zasÄ±nÄ±n tÃ¼kendiÄŸi durumda, bir Ã§ekirdek sayfasÄ±yla geniÅŸletildiÄŸi ve bu sayfanÄ±n beklenen boyutlardaki parÃ§alara bÃ¶lÃ¼ndÃ¼ÄŸÃ¼ ve bunlarÄ±n sÄ±rayla kullanÄ±lacaÄŸÄ± aÃ§Ä±klanmaktadÄ±r (iOS sÃ¼rÃ¼m 9.2'ye kadar, ardÄ±ndan bu parÃ§alarÄ±n bu saldÄ±rÄ±larÄ±n zorlaÅŸtÄ±rÄ±lmasÄ± iÃ§in rastgele bir ÅŸekilde kullanÄ±ldÄ±ÄŸÄ±).

Bu nedenle, bir heap taÅŸmasÄ± gerÃ§ekleÅŸtiÄŸinde, taÅŸan nesnenin bir kurban sÄ±rayla Ã§arpÄ±ÅŸmasÄ±nÄ± zorlamak iÃ§in birkaÃ§ **`kalloc`** tarafÄ±ndan zorlanÄ±r ve tÃ¼m boÅŸ parÃ§alarÄ±n doldurulduÄŸundan ve yeni bir sayfa oluÅŸturulduÄŸundan emin olunmaya Ã§alÄ±ÅŸÄ±lÄ±r.

Belirli bir boyuttaki nesnelerle bu doldurmayÄ± zorlamak iÃ§in, **iOS mach port ile iliÅŸkilendirilmiÅŸ dÄ±ÅŸ hattan tahsis** ideal bir adaydÄ±r. MesajÄ±n boyutunu ÅŸekillendirerek, `kalloc` tahsisinin boyutunu tam olarak belirlemek mÃ¼mkÃ¼ndÃ¼r ve karÅŸÄ±lÄ±k gelen mach portu yok edildiÄŸinde, karÅŸÄ±lÄ±k gelen tahsis hemen `kfree`'ye geri bÄ±rakÄ±lacaktÄ±r.

ArdÄ±ndan, bu yer tutuculardan bazÄ±larÄ± **serbest bÄ±rakÄ±labilir**. **`kalloc.4096` serbest listesi, Ã¶ÄŸeleri son giren ilk Ã§Ä±kan dÃ¼zeninde serbest bÄ±rakÄ±r**, bu da temelde bazÄ± yer tutucularÄ±n serbest bÄ±rakÄ±ldÄ±ÄŸÄ±nda ve saldÄ±rganÄ±n taÅŸmaya duyarlÄ± nesneyi ayÄ±rmaya Ã§alÄ±ÅŸÄ±rken birkaÃ§ kurban nesne tahsis etmeye Ã§alÄ±ÅŸÄ±rken, bu nesnenin bir kurban nesneyi takip edeceÄŸi olasÄ±lÄ±ÄŸÄ±nÄ±n yÃ¼ksek olduÄŸu anlamÄ±na gelir.

### Ã–rnek libc

[**Bu sayfada**](https://guyinatuxedo.github.io/27-edit\_free\_chunk/heap\_consolidation\_explanation/index.html) bir temel Heap taÅŸmasÄ± emÃ¼lasyonu bulunabilir. Bir sonraki parÃ§anÄ±n kullanÄ±mdaki Ã¶nceki bitini ve Ã¶nceki boyutun konumunu deÄŸiÅŸtirerek, kullanÄ±lan bir parÃ§ayÄ± **birleÅŸtirmek mÃ¼mkÃ¼ndÃ¼r** (kullanÄ±lmadÄ±ÄŸÄ±na inandÄ±rarak) ve ardÄ±ndan tekrar tahsis edilerek farklÄ± bir iÅŸaretÃ§ide kullanÄ±lan verilerin Ã¼zerine yazÄ±labilir.

[**Protostar heap 0**](https://guyinatuxedo.github.io/24-heap\_overflow/protostar\_heap0/index.html) Ã¶rneÄŸinde, bir **heap taÅŸmasÄ±nÄ±n** bayraÄŸÄ± **almak iÃ§in** kullanÄ±labileceÄŸi bir CTF'nin Ã§ok temel bir Ã¶rneÄŸi gÃ¶sterilir.

[**Protostar heap 1**](https://guyinatuxedo.github.io/24-heap\_overflow/protostar\_heap1/index.html) Ã¶rneÄŸinde, bir tampon taÅŸmasÄ±nÄ±n istismar edilerek, **kullanÄ±cÄ±nÄ±n gireceÄŸi keyfi verilerin yazÄ±lacaÄŸÄ± bir adrese** yakÄ±n bir parÃ§ada **Ã¼zerine yazÄ±lmasÄ± mÃ¼mkÃ¼n olabilir**.

### Ã–rnek ARM64

[https://8ksec.io/arm64-reversing-and-exploitation-part-1-arm-instruction-set-simple-heap-overflow/](https://8ksec.io/arm64-reversing-and-exploitation-part-1-arm-instruction-set-simple-heap-overflow/) sayfasÄ±nda, bir komutun taÅŸan parÃ§adan bir sonraki parÃ§ada depolandÄ±ÄŸÄ± bir heap taÅŸmasÄ± Ã¶rneÄŸi bulunabilir. Bu nedenle, basit bir saldÄ±rÄ± ile komutun Ã¼zerine yazÄ±larak yÃ¼rÃ¼tÃ¼lecek komut deÄŸiÅŸtirilebilir.
```bash
python3 -c 'print("/"*0x400+"/bin/ls\x00")' > hax.txt
```
### DiÄŸer Ã¶rnekler

* [**Auth-or-out. Hack The Box**](https://7rocky.github.io/en/ctf/htb-challenges/pwn/auth-or-out/)
* Bir TamsayÄ± TaÅŸma zafiyetini kullanarak Bir YÄ±ÄŸÄ±n TaÅŸmasÄ± elde ediyoruz.
* TaÅŸan parÃ§anÄ±n iÃ§indeki bir `struct`'Ä±n iÅŸaretÃ§ilerini bozarak bir iÅŸlevi `system` gibi bir iÅŸlev olarak ayarlÄ±yoruz ve kod yÃ¼rÃ¼tme elde ediyoruz.

<details>

<summary><strong>SÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family'yi**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **KatÄ±lÄ±n** ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>
