# Heap TaÅŸmasÄ±

<details>

<summary><strong>SÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nleri**](https://peass.creator-spring.com)'ni edinin
* [**PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **KatÄ±lÄ±n** ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)'da **takip edin**.
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR'lar gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>

## Temel Bilgiler

Bir heap taÅŸmasÄ±, heap'te bir [**yÄ±ÄŸÄ±n taÅŸmasÄ±**](../stack-overflow/) gibi. Temelde, heap'te belirli bir veriyi depolamak iÃ§in bir alan ayrÄ±lmÄ±ÅŸ ve **depolanan veri ayrÄ±lan alandan daha bÃ¼yÃ¼k olmuÅŸ.**

YÄ±ÄŸÄ±n taÅŸmalarÄ±nda, yÄ±ÄŸÄ±ndan bazÄ± kayÄ±tlarÄ±n (Ã¶rneÄŸin yÃ¶nerge iÅŸaretÃ§isi veya yÄ±ÄŸÄ±n Ã§erÃ§evesi) geri yÃ¼kleneceÄŸini ve bunun istismar edilebileceÄŸini biliyoruz. Heap taÅŸmalarÄ±nda ise, taÅŸÄ±nabilecek bir **duyarlÄ± bilgi varsayÄ±lan olarak heap parÃ§asÄ±nda depolanmaz.** Bununla birlikte, hassas bilgi veya iÅŸaretÃ§iler olabilir, bu nedenle bu zafiyetin **kritikliÄŸi**, bu zafiyetin **hangi verilerin Ã¼zerine yazÄ±labileceÄŸine** ve bir saldÄ±rganÄ±n bunu nasÄ±l istismar edebileceÄŸine baÄŸlÄ±dÄ±r.

{% hint style="success" %}
TaÅŸma ofsetlerini bulmak iÃ§in [**yÄ±ÄŸÄ±n taÅŸmalarÄ±nda**](../stack-overflow/#finding-stack-overflows-offsets) olduÄŸu gibi aynÄ± desenleri kullanabilirsiniz.
{% endhint %}

### YÄ±ÄŸÄ±n TaÅŸmalarÄ± vs. Heap TaÅŸmalarÄ±

YÄ±ÄŸÄ±n taÅŸmalarÄ±nda, zafiyet tetiklendiÄŸinde yÄ±ÄŸÄ±nda bulunacak dÃ¼zen ve veriler oldukÃ§a gÃ¼venilirdir. Bu, yÄ±ÄŸÄ±nÄ±n lineer olduÄŸu, belleÄŸin Ã§arpÄ±ÅŸma noktalarÄ±nda her zaman artan, programÄ±n belirli yerlerinde yÄ±ÄŸÄ±n belleÄŸinin genellikle benzer tÃ¼rde verileri depoladÄ±ÄŸÄ± ve her iÅŸlev tarafÄ±ndan kullanÄ±lan yÄ±ÄŸÄ±n kÄ±smÄ±nÄ±n sonunda bazÄ± iÅŸaretÃ§ilerle belirli bir yapÄ±ya sahip olduÄŸu iÃ§in geÃ§erlidir.

Ancak, bir heap taÅŸmasÄ± durumunda, kullanÄ±lan belleÄŸin lineer olmadÄ±ÄŸÄ±, **ayrÄ±lmÄ±ÅŸ bellek pozisyonlarÄ±nda genellikle ayrÄ±lmÄ±ÅŸ parÃ§alarÄ±n** (birbirine bitiÅŸik olmayan) olduÄŸu ve **Ã¶nceki serbest bÄ±rakÄ±lan belleÄŸin** yeni parÃ§alar ayrÄ±lmadan Ã¶nce kullanÄ±ldÄ±ÄŸÄ± iÃ§in **Ã§arpÄ±ÅŸacak nesnenin ne olduÄŸunu bilmek karmaÅŸÄ±ktÄ±r.** Bu nedenle, bir heap taÅŸmasÄ± bulunduÄŸunda, istenen nesnenin, taÅŸÄ±nabilecek nesnenin yanÄ±nda bellekte olmasÄ±nÄ± saÄŸlayacak **gÃ¼venilir bir yol bulunmasÄ± gerekir.**

Bunun iÃ§in kullanÄ±lan tekniklerden biri **Heap Grooming**dir ve Ã¶rneÄŸin [**bu yazÄ±da**](https://azeria-labs.com/grooming-the-ios-kernel-heap/) kullanÄ±lmaktadÄ±r. YazÄ±da, iOS Ã§ekirdeÄŸinde bir bÃ¶lgenin bellekteki bellek parÃ§alarÄ±nÄ± depolamak iÃ§in hafÄ±zasÄ±nÄ±n tÃ¼kendiÄŸi durumda, Ã§ekirdek sayfasÄ±yla geniÅŸletildiÄŸi ve bu sayfanÄ±n beklenen boyutlardaki parÃ§alara bÃ¶lÃ¼ndÃ¼ÄŸÃ¼ ve bu parÃ§alarÄ±n sÄ±rayla kullanÄ±lacaÄŸÄ± aÃ§Ä±klanmaktadÄ±r (iOS sÃ¼rÃ¼m 9.2'ye kadar, ardÄ±ndan bu parÃ§alarÄ±n bu saldÄ±rÄ±larÄ±n zorlaÅŸtÄ±rÄ±lmasÄ± iÃ§in rastgele bir ÅŸekilde kullanÄ±ldÄ±ÄŸÄ±).

Bu nedenle, bir heap taÅŸmasÄ± gerÃ§ekleÅŸtiÄŸinde, taÅŸan nesnenin Ã§arpÄ±ÅŸacaÄŸÄ± bir kurban sÄ±rayÄ± zorlamak iÃ§in birkaÃ§ **`kalloc`'un** birkaÃ§ iÅŸ parÃ§asÄ± tarafÄ±ndan zorlanmasÄ± gerekmektedir ve tÃ¼m boÅŸ parÃ§alarÄ±n doldurulduÄŸundan ve yeni bir sayfa oluÅŸturulduÄŸundan emin olunmalÄ±dÄ±r.

Belirli bir boyuttaki nesnelerle bu doldurmayÄ± zorlamak iÃ§in, **iOS mach port ile iliÅŸkilendirilmiÅŸ dÄ±ÅŸ hattan tahsis** ideal bir adaydÄ±r. MesajÄ±n boyutunu ÅŸekillendirerek, `kalloc` tahsisinin boyutunu tam olarak belirlemek mÃ¼mkÃ¼ndÃ¼r ve karÅŸÄ±lÄ±k gelen mach portu yok edildiÄŸinde, karÅŸÄ±lÄ±k gelen tahsis hemen `kfree`'ye geri bÄ±rakÄ±lacaktÄ±r.

ArdÄ±ndan, bu yer tutuculardan bazÄ±larÄ± **serbest bÄ±rakÄ±labilir.** **`kalloc.4096` serbest listesi, son giren ilk Ã§Ä±kan dÃ¼zeninde Ã¶ÄŸeleri serbest bÄ±rakÄ±r**, bu da temelde bazÄ± yer tutucularÄ±n serbest bÄ±rakÄ±ldÄ±ÄŸÄ± ve saldÄ±rÄ±nÄ±n taÅŸÄ±nabilir nesneyi tahsis etmeye Ã§alÄ±ÅŸÄ±rken taÅŸÄ±nabilir nesnenin bir kurban nesne tarafÄ±ndan takip edileceÄŸi olasÄ±lÄ±ÄŸÄ±nÄ±n yÃ¼ksek olduÄŸu anlamÄ±na gelir.

### Ã–rnek libc

[**Bu sayfada**](https://guyinatuxedo.github.io/27-edit\_free\_chunk/heap\_consolidation\_explanation/index.html) kullanÄ±lan temel bir Heap taÅŸmasÄ± emÃ¼lasyonunu bulabilirsiniz. Bir sonraki parÃ§anÄ±n kullanÄ±lan Ã¶nceki bitini ve Ã¶nceki boyutun konumunu deÄŸiÅŸtirerek **kullanÄ±lan bir parÃ§ayÄ± birleÅŸtirmek** (kullanÄ±lmadÄ±ÄŸÄ±na inandÄ±rarak) ve ardÄ±ndan tekrar tahsis ederek farklÄ± bir iÅŸaretÃ§ide kullanÄ±lan verileri Ã¼zerine yazmak mÃ¼mkÃ¼ndÃ¼r.

[**Protostar heap 0**](https://guyinatuxedo.github.io/24-heap\_overflow/protostar\_heap0/index.html) Ã¶rneÄŸinden baÅŸka bir Ã¶rnek, bir bayraÄŸÄ± **almak iÃ§in kazan fonksiyonunu Ã§aÄŸÄ±rmak iÃ§in bir CTF'de** bir **heap taÅŸmasÄ±nÄ±n** nasÄ±l istismar edilebileceÄŸini gÃ¶stermektedir.

[**Protostar heap 1**](https://guyinatuxedo.github.io/24-heap\_overflow/protostar\_heap1/index.html) Ã¶rneÄŸinde, bir tampon taÅŸmasÄ±nÄ±n istismar edilerek, **kullanÄ±cÄ±nÄ±n** yazacaÄŸÄ± **keyfi verilerin yazÄ±lacaÄŸÄ± yakÄ±n bir parÃ§ada bir adresi Ã¼zerine yazmak mÃ¼mkÃ¼ndÃ¼r.**

### Ã–rnek ARM64

[https://8ksec.io/arm64-reversing-and-exploitation-part-1-arm-instruction-set-simple-heap-overflow/](https://8ksec.io/arm64-reversing-and-exploitation-part-1-arm-instruction-set-simple-heap-overflow/) sayfasÄ±nda, bir komutun taÅŸan parÃ§adan bir sonraki parÃ§ada depolandÄ±ÄŸÄ± bir heap taÅŸmasÄ± Ã¶rneÄŸi bulabilirsiniz. Bu nedenle, basit bir saldÄ±rÄ± ile komutu deÄŸiÅŸtirerek yÃ¼rÃ¼tÃ¼lecek komutu deÄŸiÅŸtirmek mÃ¼mkÃ¼ndÃ¼r.
```bash
python3 -c 'print("/"*0x400+"/bin/ls\x00")' > hax.txt
```
<details>

<summary><strong>SÄ±fÄ±rdan kahraman olmaya kadar AWS hacklemeyi Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family'yi**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **KatÄ±lÄ±n** ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking hilelerinizi paylaÅŸarak PR'ler gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>
