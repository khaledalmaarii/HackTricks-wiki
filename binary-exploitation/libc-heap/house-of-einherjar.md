# Dom Einherjar

<details>

<summary><strong>Nauka hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCYJNY**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakowania, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na GitHubie.

</details>

## Podstawowe informacje

### Kod

* Sprawd藕 przykad z [https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c)
* Lub z [https://guyinatuxedo.github.io/42-house\_of\_einherjar/house\_einherjar\_exp/index.html#house-of-einherjar-explanation](https://guyinatuxedo.github.io/42-house\_of\_einherjar/house\_einherjar\_exp/index.html#house-of-einherjar-explanation) (mo偶e by konieczne uzupenienie tcache)

### Cel

* Celem jest alokacja pamici praktycznie w dowolnym okrelonym adresie.

### Wymagania

* Utw贸rz faszywy kawaek, gdy chcemy zaalokowa kawaek:
* Ustaw wska藕niki tak, aby wskazyway na siebie same, aby omin kontrole sp贸jnoci
* Przepenij jeden bajt z bajtem null z jednego kawaka do nastpnego, aby zmodyfikowa flag `PREV_INUSE`.
* Wska偶 w `prev_size` nadu偶ywanego kawaka off-by-null r贸偶nic midzy nim a faszywym kawakiem
* Rozmiar faszywego kawaka musi r贸wnie偶 by ustawiony na ten sam rozmiar, aby omin kontrole sp贸jnoci
* Do skonstruowania tych kawak贸w bdziesz potrzebowa wycieku sterty.

### Atak

* Utworzono `A` faszywy kawaek wewntrz kawaka kontrolowanego przez atakujcego, wskazujcy z `fd` i `bk` na oryginalny kawaek, aby omin zabezpieczenia
* Zaalokowano 2 inne kawaki (`B` i `C`)
* Wykorzystujc off by one w kawaku `B`, wyczy bit `prev in use` i nadpisz dane `prev_size` r贸偶nic midzy miejscem, w kt贸rym zaalokowany jest kawaek `C`, a faszywym kawakiem `A` wygenerowanym wczeniej
* Ten `prev_size` oraz rozmiar w faszywym kawaku `A` musz by takie same, aby omin kontrole.
* Nastpnie wypenij tcache
* Nastpnie zwolnij `C`, aby skonsolidowa si z faszywym kawakiem `A`
* Nastpnie utw贸rz nowy kawaek `D`, kt贸ry bdzie zaczyna si w faszywym kawaku `A` i pokrywa kawaek `B`
* Dom Einherjar koczy si tutaj
* Mo偶na kontynuowa to atakiem na fast bin lub zatruciem Tcache:
* Zwolnij `B`, aby doda go do fast bin / Tcache
* Nadpisz `fd` `B`, aby wskazywa na docelowy adres, nadu偶ywajc kawaka `D` (poniewa偶 zawiera w sobie `B`)&#x20;
* Nastpnie wykonaj 2 alokacje pamici i druga z nich bdzie **alokowa adres docelowy**

## Odwoania i inne przykady

* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c)
* **CTF** [**https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_einherjar/#2016-seccon-tinypad**](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_einherjar/#2016-seccon-tinypad)
* Po zwolnieniu wska藕nik贸w nie s one zerowane, wic wci偶 mo偶na uzyska do nich dostp. Dlatego kawaek jest umieszczany w kubeku nieuporzdkowanym i wyciekane s wska藕niki, kt贸re zawiera (wyciek libc), a nastpnie nowa sterta jest umieszczana w kubeku nieuporzdkowanym i wyciekany jest adres sterty z wska藕nika, kt贸ry otrzymuje.
* [**baby-talk. DiceCTF 2024**](https://7rocky.github.io/en/ctf/other/dicectf/baby-talk/)
* Bd przepenienia bajtem null w `strtok`.
* U偶yj Domu Einherjar, aby uzyska sytuacj nakadajcych si kawak贸w i zakocz zatruciem Tcache, aby uzyska arbitralne pisanie.
