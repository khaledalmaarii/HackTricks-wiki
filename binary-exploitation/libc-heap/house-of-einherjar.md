# Dom Einherjar

{% hint style="success" %}
Ucz si i praktykuj Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Szkolenie AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i praktykuj Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Szkolenie GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>
{% endhint %}

## Podstawowe informacje

### Kod

* Sprawd藕 przykad z [https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c)
* Lub z [https://guyinatuxedo.github.io/42-house\_of\_einherjar/house\_einherjar\_exp/index.html#house-of-einherjar-explanation](https://guyinatuxedo.github.io/42-house\_of\_einherjar/house\_einherjar\_exp/index.html#house-of-einherjar-explanation) (mo偶e by konieczne uzupenienie tcache)

### Cel

* Celem jest alokacja pamici praktycznie w dowolnym okrelonym adresie.

### Wymagania

* Utw贸rz faszywy kawaek, gdy chcemy zaalokowa kawaek:
* Ustaw wska藕niki tak, aby wskazyway na siebie same, aby omin kontrole sp贸jnoci
* Przepenij jeden bajt z bajtem null z jednego kawaka do nastpnego, aby zmodyfikowa flag `PREV_INUSE`.
* Wska偶 w `prev_size` nadu偶ywanego kawaka off-by-null r贸偶nic midzy nim a faszywym kawakiem
* Rozmiar faszywego kawaka musi r贸wnie偶 by ustawiony na ten sam rozmiar, aby omin kontrole sp贸jnoci
* Do skonstruowania tych kawak贸w bdziesz potrzebowa wycieku sterty.

### Atak

* `A` faszywy kawaek jest tworzony wewntrz kawaka kontrolowanego przez atakujcego, wskazujc z `fd` i `bk` na oryginalny kawaek, aby omin zabezpieczenia
* Allokowane s 2 inne kawaki (`B` i `C`)
* Wykorzystujc off by one w `B`, bit `prev in use` jest czyszczony, a dane `prev_size` s nadpisywane r贸偶nic midzy miejscem, w kt贸rym jest allokowany kawaek `C`, a faszywym kawakiem `A` wygenerowanym wczeniej
* Ten `prev_size` i rozmiar w faszywym kawaku `A` musz by takie same, aby omin kontrole.
* Nastpnie wypeniany jest tcache
* Nastpnie, `C` jest zwalniane, aby skonsolidowa si z faszywym kawakiem `A`
* Nastpnie tworzony jest nowy kawaek `D`, kt贸ry bdzie zaczyna si w faszywym kawaku `A` i pokrywa kawaek `B`
* Dom Einherjar koczy si tutaj
* Mo偶na kontynuowa to atakiem na fast bin lub zatruciem Tcache:
* Zwolnij `B`, aby doda go do fast bin / Tcache
* Nadpisz `fd` `B`, aby wskazywa na docelowy adres nadu偶ywajc kawaka `D` (poniewa偶 zawiera w sobie `B`)&#x20;
* Nastpnie wykonuje si 2 alokacje pamici i druga z nich bdzie **alokowa docelowy adres**

## Odwoania i inne przykady

* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c)
* **CTF** [**https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_einherjar/#2016-seccon-tinypad**](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_einherjar/#2016-seccon-tinypad)
* Po zwolnieniu wska藕nik贸w nie s one zerowane, wic wci偶 mo偶na uzyska do nich dostp. Dlatego kawaek jest umieszczany w nieuporzdkowanym pojemniku i wyciekane s wska藕niki, kt贸re zawiera (wyciek libc), a nastpnie nowa sterta jest umieszczana w nieuporzdkowanym pojemniku i wyciekany jest adres sterty z wska藕nika, kt贸ry otrzymuje.
* [**baby-talk. DiceCTF 2024**](https://7rocky.github.io/en/ctf/other/dicectf/baby-talk/)
* Bd przepenienia bajtem null w `strtok`.
* U偶yj Domu Einherjar, aby uzyska sytuacj nakadajcych si kawak贸w i zakocz zatruciem Tcache, aby uzyska arbitralne pisanie.
