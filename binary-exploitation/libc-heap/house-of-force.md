# í˜ì˜ ì§‘

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê³  ì‹¤ìŠµí•˜ê¸°:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê³  ì‹¤ìŠµí•˜ê¸°: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* ğŸ’¬ **ë””ìŠ¤ì½”ë“œ ê·¸ë£¹**ì— **ê°€ì…**í•˜ì„¸ìš”(https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **HackTricks** ë° **HackTricks Cloud** ê¹ƒí—ˆë¸Œ ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”.

</details>
{% endhint %}

## ê¸°ë³¸ ì •ë³´

### ì½”ë“œ

* ì´ ê¸°ë²•ì€ ([**ì—¬ê¸°**](https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=30a17d8c95fbfb15c52d1115803b63aaa73a285c))ì—ì„œ íŒ¨ì¹˜ë˜ì—ˆìœ¼ë©° ë‹¤ìŒ ì˜¤ë¥˜ë¥¼ ìƒì„±í•©ë‹ˆë‹¤: `malloc(): corrupted top size`
* í…ŒìŠ¤íŠ¸í•˜ë ¤ë©´ [**ì—¬ê¸°ì˜ ì½”ë“œ**](https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html)ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ëª©í‘œ

* ì´ ê³µê²©ì˜ ëª©í‘œëŠ” íŠ¹ì • ì£¼ì†Œì— ì²­í¬ë¥¼ í• ë‹¹í•  ìˆ˜ ìˆëŠ” ê²ƒì…ë‹ˆë‹¤.

### ìš”êµ¬ ì‚¬í•­

* í™ í• ë‹¹ì˜ í¬ê¸°ë¥¼ ì œì–´í•  ìˆ˜ ìˆëŠ” ì˜¤ë²„í”Œë¡œìš°ê°€ í•„ìš”í•©ë‹ˆë‹¤.
* í™ í• ë‹¹ì˜ í¬ê¸°ë¥¼ ì œì–´í•  ìˆ˜ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.

### ê³µê²©

ê³µê²©ìê°€ íŠ¹ì • ì£¼ì†Œ Pì— ì²­í¬ë¥¼ í• ë‹¹í•˜ì—¬ ì—¬ê¸°ì— ê°’ì„ ë®ì–´ì“°ë ¤ë©´ ë‹¤ìŒê³¼ ê°™ì´ ì‹œì‘í•©ë‹ˆë‹¤. ë¨¼ì € top ì²­í¬ í¬ê¸°ë¥¼ `-1`ë¡œ ë®ì–´ì”ë‹ˆë‹¤(ì˜¤ë²„í”Œë¡œìš°ë¥¼ ì‚¬ìš©í•  ìˆ˜ë„ ìˆìŒ). ì´ë ‡ê²Œ í•˜ë©´ mallocì´ Top ì²­í¬ë¥¼ í•­ìƒ ì¶©ë¶„í•œ ê³µê°„ì´ ìˆëŠ” ìƒíƒœë¡œ mmapë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê²Œ ë©ë‹ˆë‹¤.

ê·¸ëŸ° ë‹¤ìŒ top ì²­í¬ì˜ ì£¼ì†Œì™€ í• ë‹¹í•  ëŒ€ìƒ ê³µê°„ ì‚¬ì´ì˜ ê±°ë¦¬ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤. ì´ëŠ” í•´ë‹¹ í¬ê¸°ë¡œ mallocì´ ìˆ˜í–‰ë˜ì–´ top ì²­í¬ê°€ í•´ë‹¹ ìœ„ì¹˜ë¡œ ì´ë™í•˜ë„ë¡ í•˜ê¸° ìœ„í•¨ì…ë‹ˆë‹¤. ì´ ì°¨ì´/í¬ê¸°ëŠ” ì‰½ê²Œ ê³„ì‚°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```c
// From https://github.com/shellphish/how2heap/blob/master/glibc_2.27/house_of_force.c#L59C2-L67C5
/*
* The evil_size is calulcated as (nb is the number of bytes requested + space for metadata):
* new_top = old_top + nb
* nb = new_top - old_top
* req + 2sizeof(long) = new_top - old_top
* req = new_top - old_top - 2sizeof(long)
* req = target - 2sizeof(long) - old_top - 2sizeof(long)
* req = target - old_top - 4*sizeof(long)
*/
```
ë”°ë¼ì„œ `target - old_top - 4*sizeof(long)` í¬ê¸°ë¥¼ í• ë‹¹í•˜ë©´ (4ê°œì˜ longì€ ìƒë‹¨ ì²­í¬ì˜ ë©”íƒ€ë°ì´í„°ì™€ ìƒˆë¡œ í• ë‹¹ëœ ì²­í¬ì˜ ë©”íƒ€ë°ì´í„° ë•Œë¬¸ì…ë‹ˆë‹¤) ìƒë‹¨ ì²­í¬ë¥¼ ë®ì–´ì“°ê³ ì í•˜ëŠ” ì£¼ì†Œë¡œ ì´ë™ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ê·¸ëŸ° ë‹¤ìŒ, ëŒ€ìƒ ì£¼ì†Œì—ì„œ ì²­í¬ë¥¼ ì–»ê¸° ìœ„í•´ ë‹¤ë¥¸ mallocì„ ìˆ˜í–‰í•˜ì‹­ì‹œì˜¤.

### ì°¸ê³  ìë£Œ ë° ë‹¤ë¥¸ ì˜ˆì‹œ

* [https://github.com/shellphish/how2heap/tree/master](https://github.com/shellphish/how2heap/tree/master?tab=readme-ov-file)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/)
* [https://heap-exploitation.dhavalkapil.com/attacks/house\_of\_force](https://heap-exploitation.dhavalkapil.com/attacks/house\_of\_force)
* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.27/house\_of\_force.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.27/house\_of\_force.c)
* [https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html](https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#hitcon-training-lab-11](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#hitcon-training-lab-11)
* ì´ ì‹œë‚˜ë¦¬ì˜¤ì˜ ëª©í‘œëŠ” ret2winìœ¼ë¡œ, í˜¸ì¶œë  í•¨ìˆ˜ì˜ ì£¼ì†Œë¥¼ ret2win í•¨ìˆ˜ì˜ ì£¼ì†Œë¡œ ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤.
* ì´ì§„ íŒŒì¼ì—ëŠ” ìƒë‹¨ ì²­í¬ í¬ê¸°ë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆëŠ” ì˜¤ë²„í”Œë¡œìš°ê°€ ìˆìœ¼ë©°, ì´ë¥¼ -1 ë˜ëŠ” p64(0xffffffffffffffff)ë¡œ ìˆ˜ì •í•©ë‹ˆë‹¤.
* ê·¸ëŸ° ë‹¤ìŒ ë®ì–´ì“¸ í¬ì¸í„°ê°€ ì¡´ì¬í•˜ëŠ” ìœ„ì¹˜ë¡œ ì£¼ì†Œë¥¼ ê³„ì‚°í•˜ê³ , í˜„ì¬ ìƒë‹¨ ì²­í¬ ìœ„ì¹˜ë¶€í„° í•´ë‹¹ ìœ„ì¹˜ê¹Œì§€ì˜ ì°¨ì´ê°€ `malloc`ìœ¼ë¡œ í• ë‹¹ë©ë‹ˆë‹¤.
* ë§ˆì§€ë§‰ìœ¼ë¡œ ì›í•˜ëŠ” ëŒ€ìƒì„ í¬í•¨í•˜ëŠ” ìƒˆë¡œìš´ ì²­í¬ê°€ í• ë‹¹ë˜ë©°, ì´ ëŒ€ìƒì´ ret2win í•¨ìˆ˜ì— ì˜í•´ ë®ì–´ì“°ì…ë‹ˆë‹¤.
* [https://shift--crops-hatenablog-com.translate.goog/entry/2016/03/21/171249?\_x\_tr\_sl=es&\_x\_tr\_tl=en&\_x\_tr\_hl=en&\_x\_tr\_pto=wapp](https://shift--crops-hatenablog-com.translate.goog/entry/2016/03/21/171249?\_x\_tr\_sl=es&\_x\_tr\_tl=en&\_x\_tr\_hl=en&\_x\_tr\_pto=wapp)
* `Input your name:`ì—ëŠ” í™ì—ì„œ ì£¼ì†Œë¥¼ ëˆ„ì¶œí•  ìˆ˜ ìˆëŠ” ì´ˆê¸° ì·¨ì•½ì ì´ ìˆìŠµë‹ˆë‹¤.
* ê·¸ëŸ° ë‹¤ìŒ `Org:` ë° `Host:` ê¸°ëŠ¥ì—ì„œ **org name**ì„ ìš”ì²­í•  ë•Œ `s` í¬ì¸í„°ì˜ 64Bë¥¼ ì±„ìš¸ ìˆ˜ ìˆìœ¼ë©°, ì´ëŠ” ìŠ¤íƒì—ì„œ v2ì˜ ì£¼ì†Œ ë’¤ì— ë”°ë¥´ëŠ”ë°, ê·¸ ë‹¤ìŒì—ëŠ” ì§€ì •ëœ **host name**ì´ ë”°ë¦…ë‹ˆë‹¤. ê·¸ í›„ strcpyê°€ sì˜ ë‚´ìš©ì„ 64B í¬ê¸°ì˜ ì²­í¬ë¡œ ë³µì‚¬í•˜ê²Œ ë˜ë¯€ë¡œ **host name**ì— ì…ë ¥ëœ ë°ì´í„°ë¡œ **ìƒë‹¨ ì²­í¬ì˜ í¬ê¸°ë¥¼ ë®ì–´ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤**.
* ì´ì œ ì„ì˜ ì“°ê¸°ê°€ ê°€ëŠ¥í•˜ë¯€ë¡œ, `atoi`ì˜ GOTë¥¼ printfì˜ ì£¼ì†Œë¡œ ë®ì–´ì”ë‹ˆë‹¤. ê·¸ëŸ° ë‹¤ìŒ `%24$p`ë¡œ `IO_2_1_stderr`ì˜ ì£¼ì†Œë¥¼ ëˆ„ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ libc ëˆ„ì¶œë¡œ `atoi`ì˜ GOTë¥¼ ë‹¤ì‹œ `system` ì£¼ì†Œë¡œ ë®ì–´ì“°ê³  `/bin/sh`ë¥¼ ë§¤ê°œë³€ìˆ˜ë¡œ ì „ë‹¬í•˜ì—¬ í˜¸ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* [ì´ ë‹¤ë¥¸ writeupì—ì„œ ì œì•ˆëœ ëŒ€ì²´ ë°©ë²•](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#2016-bctf-bcloud)ì€ `free`ë¥¼ `puts`ë¡œ ë®ì–´ì“°ê³ , ë‚˜ì¤‘ì— í•´ì œë  í¬ì¸í„°ì— `atoi@got`ì˜ ì£¼ì†Œë¥¼ ì¶”ê°€í•˜ì—¬ ëˆ„ì¶œí•˜ê³  ì´ ëˆ„ì¶œë¡œ ë‹¤ì‹œ `atoi@got`ë¥¼ `system`ìœ¼ë¡œ ë®ì–´ì“°ê³  `/bin/sh`ë¡œ í˜¸ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* [https://guyinatuxedo.github.io/41-house\_of\_force/bkp16\_cookbook/index.html](https://guyinatuxedo.github.io/41-house\_of\_force/bkp16\_cookbook/index.html)
* í¬ì¸í„°ë¥¼ ì§€ìš°ì§€ ì•Šê³  í•´ì œëœ ì²­í¬ë¥¼ ì¬ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” UAFê°€ ìˆìŠµë‹ˆë‹¤. ì¼ë¶€ ì½ê¸° ë°©ë²•ì´ ìˆê¸° ë•Œë¬¸ì— GOTì— free í•¨ìˆ˜ì˜ í¬ì¸í„°ë¥¼ ì“°ê³  ë‚˜ì¤‘ì— read í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ libc ì£¼ì†Œë¥¼ ëˆ„ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* ê·¸ëŸ° ë‹¤ìŒ, UAFë¥¼ ì•…ìš©í•˜ì—¬ House of forceë¥¼ ì‚¬ìš©í•˜ì—¬ ì™¼ìª½ ê³µê°„ì˜ í¬ê¸°ë¥¼ -1ë¡œ ë®ì–´ì“°ê³ , free í›„í¬ì— ë„ë‹¬í•  ìˆ˜ ìˆëŠ” ì¶©ë¶„íˆ í° ì²­í¬ë¥¼ í• ë‹¹í•œ ë‹¤ìŒ, free í›„í¬ë¥¼ í¬í•¨í•˜ëŠ” ë‹¤ë¥¸ ì²­í¬ë¥¼ í• ë‹¹í•©ë‹ˆë‹¤. ê·¸ëŸ° ë‹¤ìŒ í›„í¬ì— `system`ì˜ ì£¼ì†Œë¥¼ ì“°ê³ , ì²­í¬ì— `"/bin/sh"`ë¥¼ ì“°ê³ , ê·¸ ë¬¸ìì—´ ë‚´ìš©ì„ í¬í•¨í•˜ëŠ” ì²­í¬ë¥¼ í•´ì œí•©ë‹ˆë‹¤.
