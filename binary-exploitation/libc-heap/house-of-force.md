# Dom Siy

{% hint style="success" %}
Dowiedz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Dowiedz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Udostpnij sztuczki hakerskie, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na githubie.

</details>
{% endhint %}

## Podstawowe Informacje

### Kod

* Ta technika zostaa zaatana ([**tutaj**](https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=30a17d8c95fbfb15c52d1115803b63aaa73a285c)) i powoduje ten bd: `malloc(): corrupted top size`
* Mo偶esz wypr贸bowa [**kod std**](https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html), jeli chcesz go przetestowa.

### Cel

* Celem tego ataku jest mo偶liwo alokacji fragmentu pamici w okrelonym adresie.

### Wymagania

* Przepenienie, kt贸re pozwala nadpisa rozmiar nag贸wka top chunk (np. -1).
* Mo偶liwo kontrolowania rozmiaru alokacji sterty

### Atak

Jeli atakujcy chce zaalokowa fragment pamici pod adresem P, aby nadpisa warto tutaj. Zaczyna od nadpisania rozmiaru top chunk `-1` (mo偶e to by z przepenieniem). Zapewnia to, 偶e malloc nie bdzie u偶ywa mmap do 偶adnej alokacji, poniewa偶 Top chunk zawsze bdzie mia wystarczajco du偶o miejsca.

Nastpnie oblicz odlego midzy adresem top chunk a docelow przestrzeni do alokacji. Jest to konieczne, poniewa偶 malloc o takim rozmiarze zostanie wykonany, aby przenie top chunk na t pozycj. Tak mo偶na atwo obliczy r贸偶nic/rozmiar:
```c
// From https://github.com/shellphish/how2heap/blob/master/glibc_2.27/house_of_force.c#L59C2-L67C5
/*
* The evil_size is calulcated as (nb is the number of bytes requested + space for metadata):
* new_top = old_top + nb
* nb = new_top - old_top
* req + 2sizeof(long) = new_top - old_top
* req = new_top - old_top - 2sizeof(long)
* req = target - 2sizeof(long) - old_top - 2sizeof(long)
* req = target - old_top - 4*sizeof(long)
*/
```
Dlatego przydzielenie rozmiaru `target - old_top - 4*sizeof(long)` (4 longi, poniewa偶 metadane top chunk i nowego chunka s przydzielane) spowoduje przeniesienie top chunka pod adres, kt贸ry chcemy nadpisa. Nastpnie wykonujemy kolejne malloc, aby uzyska chunka pod docelowym adresem.

### Referencje i Inne Przykady

* [https://github.com/shellphish/how2heap/tree/master](https://github.com/shellphish/how2heap/tree/master?tab=readme-ov-file)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/)
* [https://heap-exploitation.dhavalkapil.com/attacks/house\_of\_force](https://heap-exploitation.dhavalkapil.com/attacks/house\_of\_force)
* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.27/house\_of\_force.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.27/house\_of\_force.c)
* [https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html](https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#hitcon-training-lab-11](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#hitcon-training-lab-11)
* Celem tego scenariusza jest ret2win, gdzie musimy zmodyfikowa adres funkcji, kt贸ra zostanie wywoana przez funkcj ret2win.
* Binarny plik ma przepenienie, kt贸re mo偶na wykorzysta do zmodyfikowania rozmiaru top chunka, kt贸ry jest zmieniony na -1 lub p64(0xffffffffffffffff).
* Nastpnie obliczany jest adres miejsca, gdzie istnieje wska藕nik do nadpisania, a r贸偶nica midzy bie偶c pozycj top chunka a tam jest alokowana za pomoc `malloc`.
* W kocu alokowany jest nowy chunk, kt贸ry bdzie zawiera ten po偶dany cel, wewntrz kt贸rego zostanie nadpisany funkcj ret2win.
* [https://shift--crops-hatenablog-com.translate.goog/entry/2016/03/21/171249?\_x\_tr\_sl=es&\_x\_tr\_tl=en&\_x\_tr\_hl=en&\_x\_tr\_pto=wapp](https://shift--crops-hatenablog-com.translate.goog/entry/2016/03/21/171249?\_x\_tr\_sl=es&\_x\_tr\_tl=en&\_x\_tr\_hl=en&\_x\_tr\_pto=wapp)
* W `Wprowad藕 swoje imi:` istnieje pocztkowa podatno, kt贸ra pozwala na wyciek adresu z heapa.
* Nastpnie w funkcjonalnoci `Org:` i `Host:` mo偶na wypeni 64B wska藕nika `s`, gdy zostanie zapytane o **nazw org**, kt贸ra na stosie jest nastpnie ledzona przez adres v2, a nastpnie przez wskazan **nazw hosta**. Poniewa偶 strcpy bdzie kopiowa zawarto s do chunka o rozmiarze 64B, mo偶liwe jest **nadpisanie rozmiaru top chunka** danymi wprowadzonymi w **nazwie hosta**.
* Teraz, gdy mo偶liwe jest dowolne pisanie, GOT `atoi` zosta nadpisany adresem printf. Nastpnie mo偶liwe byo wyciekanie adresu `IO_2_1_stderr` _z_ `%24$p`. Dziki temu wyciekowi libc mo偶liwe byo ponowne nadpisanie GOT `atoi` adresem `system` i wywoanie go, przekazujc jako parametr `/bin/sh`.
* Alternatywna metoda [zapropnowana w tym innym rozwizaniu](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#2016-bctf-bcloud), polega na nadpisaniu `free` z `puts`, a nastpnie dodaniu adresu `atoi@got` do wska藕nika, kt贸ry zostanie p贸藕niej zwolniony, aby zosta wycieknity, a z tym wyciekiem ponowne nadpisanie `atoi@got` z `system` i wywoanie go z `/bin/sh`.
* [https://guyinatuxedo.github.io/41-house\_of\_force/bkp16\_cookbook/index.html](https://guyinatuxedo.github.io/41-house\_of\_force/bkp16\_cookbook/index.html)
* Istnieje UAF, kt贸ry pozwala na ponowne u偶ycie zwolnionego chunka bez wyczyszczenia wska藕nika. Poniewa偶 istniej pewne metody odczytu, mo偶liwe jest wyciekanie adresu libc, zapisujc wska藕nik do funkcji free w GOT i nastpnie wywoujc funkcj odczytu.
* Nastpnie, u偶yto House of force (wykorzystujc UAF) do nadpisania rozmiaru pozostaej przestrzeni na -1, zaalokowania wystarczajco du偶ego chunka, aby dotrze do free hook, a nastpnie zaalokowania innego chunka, kt贸ry bdzie zawiera free hook. Nastpnie, w hooku zapisano adres `system`, w chunku `"/bin/sh"` i ostatecznie zwolniono chunk z tym zawartoci cigu znak贸w.
