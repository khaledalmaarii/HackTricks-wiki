# KuÄ‡a sile



{% hint style="success" %}
NauÄite i veÅ¾bajte hakovanje AWS-a:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Obuka AWS Crveni Tim StruÄnjak (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
NauÄite i veÅ¾bajte hakovanje GCP-a: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Obuka GCP Crveni Tim StruÄnjak (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## Osnovne informacije

### Kod

* Ova tehnika je zakrpljena ([**ovde**](https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=30a17d8c95fbfb15c52d1115803b63aaa73a285c)) i proizvodi ovu greÅ¡ku: `malloc(): corrupted top size`
* MoÅ¾ete probati [**kod odavde**](https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html) da je testirate ako Å¾elite.

### Cilj

* Cilj ovog napada je da se moÅ¾e alocirati komad na odreÄ‘enoj adresi.

### Zahtevi

* PrekoraÄenje koje omoguÄ‡ava prepisivanje veliÄine zaglavlja vrha komada (npr. -1).
* Biti u moguÄ‡nosti da se kontroliÅ¡e veliÄina alociranja hipa

### Napad

Ako napadaÄ Å¾eli da alocira komad na adresi P da bi prepisao vrednost ovde. PoÄinje tako Å¡to prepisuje veliÄinu vrha komada sa `-1` (moÅ¾da prekoraÄenjem). Ovo osigurava da malloc neÄ‡e koristiti mmap za bilo koju alokaciju jer Ä‡e Vrh komada uvek imati dovoljno prostora.

Zatim, izraÄunajte udaljenost izmeÄ‘u adrese vrha komada i ciljnog prostora za alokaciju. Ovo je zato Å¡to Ä‡e se malloc sa tom veliÄinom izvrÅ¡iti kako bi se premestio vrh komada na tu poziciju. Na ovaj naÄin razlika/veliÄina se moÅ¾e lako izraÄunati:
```c
// From https://github.com/shellphish/how2heap/blob/master/glibc_2.27/house_of_force.c#L59C2-L67C5
/*
* The evil_size is calulcated as (nb is the number of bytes requested + space for metadata):
* new_top = old_top + nb
* nb = new_top - old_top
* req + 2sizeof(long) = new_top - old_top
* req = new_top - old_top - 2sizeof(long)
* req = target - 2sizeof(long) - old_top - 2sizeof(long)
* req = target - old_top - 4*sizeof(long)
*/
```
Dakle, dodeljivanje veliÄine `cilj - stari_vrh - 4*sizeof(long)` (4 long-a su zbog metapodataka vrhunskog bloka i novog bloka kada je alociran) Ä‡e premestiti vrhunski blok na adresu koju Å¾elimo da prepisujemo.\
Zatim, uradite joÅ¡ jedan malloc da biste dobili blok na ciljanoj adresi.

### Reference & Drugi Primeri

* [https://github.com/shellphish/how2heap/tree/master](https://github.com/shellphish/how2heap/tree/master?tab=readme-ov-file)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/)
* [https://heap-exploitation.dhavalkapil.com/attacks/house\_of\_force](https://heap-exploitation.dhavalkapil.com/attacks/house\_of\_force)
* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.27/house\_of\_force.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.27/house\_of\_force.c)
* [https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html](https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#hitcon-training-lab-11](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#hitcon-training-lab-11)
* Cilj ovog scenarija je ret2win gde treba izmeniti adresu funkcije koja Ä‡e biti pozvana adresom funkcije ret2win
* Binarni fajl ima prelivanje koje se moÅ¾e zloupotrebiti za izmenu veliÄine vrhunskog bloka, koji je izmenjen na -1 ili p64(0xffffffffffffffff)
* Zatim se izraÄunava adresa mesta gde postoji pokazivaÄ za prepisivanje, i razlika od trenutne pozicije vrhunskog bloka do tamo se alocira sa `malloc`
* Na kraju se alocira novi blok koji Ä‡e sadrÅ¾ati ovu Å¾eljenu metu unutar koje Ä‡e biti prepisana funkcija ret2win
* [https://shift--crops-hatenablog-com.translate.goog/entry/2016/03/21/171249?\_x\_tr\_sl=es&\_x\_tr\_tl=en&\_x\_tr\_hl=en&\_x\_tr\_pto=wapp](https://shift--crops-hatenablog-com.translate.goog/entry/2016/03/21/171249?\_x\_tr\_sl=es&\_x\_tr\_tl=en&\_x\_tr\_hl=en&\_x\_tr\_pto=wapp)
* U `Unesite svoje ime:` postoji poÄetna ranjivost koja omoguÄ‡ava otkrivanje adrese sa hipa
* Zatim u funkcionalnosti `Org:` i `Host:` moguÄ‡e je popuniti 64B pokazivaÄa kada se traÅ¾i **org ime**, koji na steku sledi adresa v2, koja se zatim prati navedenim **host imenom**. Kako Ä‡e strcpy kopirati sadrÅ¾aj s u blok veliÄine 64B, moguÄ‡e je **prepisanje veliÄine vrhunskog bloka** podacima unetim unutar **host imena**.
* Sada kada je moguÄ‡e proizvoljno pisanje, GOT `atoi` je prepisan na adresu printf-a. tada je moguÄ‡e otkriti adresu `IO_2_1_stderr` _sa_ `%24$p`. I sa ovim curenjem libc-a bilo je moguÄ‡e ponovo prepisati GOT `atoi` sa adresom `system` i pozvati je prosleÄ‘ujuÄ‡i kao parametar `/bin/sh`
* Alternativna metoda [predloÅ¾ena u ovom drugom writeup-u](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#2016-bctf-bcloud), je prepisati `free` sa `puts`, a zatim dodati adresu `atoi@got`, u pokazivaÄ koji Ä‡e kasnije biti osloboÄ‘en tako da se curenje i ovim curenjem ponovo prepisuje `atoi@got` sa `system` i poziva se sa `/bin/sh`.
* [https://guyinatuxedo.github.io/41-house\_of\_force/bkp16\_cookbook/index.html](https://guyinatuxedo.github.io/41-house\_of\_force/bkp16\_cookbook/index.html)
* Postoji UAF koji omoguÄ‡ava ponovnu upotrebu bloka koji je osloboÄ‘en bez brisanja pokazivaÄa. Zbog nekih metoda Äitanja, moguÄ‡e je otkriti libc adresu upisivanjem pokazivaÄa na funkciju free u GOT ovde, a zatim pozivanjem funkcije za Äitanje.
* Zatim je koriÅ¡Ä‡en House of force (zloupotreba UAF-a) da se prepisuje veliÄina preostalog prostora sa -1, alocira blok dovoljno velik da se doÄ‘e do slobodnog kuka, a zatim alocira joÅ¡ jedan blok koji Ä‡e sadrÅ¾ati slobodni kuk. Zatim, u kuk upisati adresu `system`, upisati u blok `"/bin/sh"` i na kraju osloboditi blok sa tim sadrÅ¾ajem stringa.
