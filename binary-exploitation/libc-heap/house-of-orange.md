# Casa de Orange

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci贸n**](https://github.com/sponsors/carlospolop)!
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en GitHub.

</details>
{% endhint %}

## Informaci贸n B谩sica

### C贸digo

* Encuentra un ejemplo en [https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_orange.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_orange.c)
* La t茅cnica de explotaci贸n fue corregida en este [parche](https://sourceware.org/git/?p=glibc.git;a=blobdiff;f=stdlib/abort.c;h=117a507ff88d862445551f2c07abb6e45a716b75;hp=19882f3e3dc1ab830431506329c94dcf1d7cc252;hb=91e7cf982d0104f0e71770f5ae8e3faf352dea9f;hpb=0c25125780083cbba22ed627756548efe282d1a0) por lo que ya no funciona (funciona en versiones anteriores a 2.26)
* Mismo ejemplo **con m谩s comentarios** en [https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)

### Objetivo

* Abusar de la funci贸n `malloc_printerr`

### Requisitos

* Sobrescribir el tama帽o del top chunk
* Fugas de informaci贸n de Libc y heap

### Antecedentes

Algunos antecedentes necesarios de los comentarios de [**este ejemplo**](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)**:**

La cuesti贸n es que, en versiones antiguas de libc, cuando se llamaba a la funci贸n `malloc_printerr`, **iteraba a trav茅s de una lista de estructuras `_IO_FILE` almacenadas en `_IO_list_all`**, y realmente **ejecutaba** un puntero de instrucci贸n en esa estructura.\
Este ataque forjar谩 una **estructura `_IO_FILE` falsa** que escribiremos en **`_IO_list_all`**, y provocar谩 que se ejecute `malloc_printerr`.\
Luego **ejecutar谩 cualquier direcci贸n** que tengamos almacenada en la tabla de saltos de las estructuras **`_IO_FILE`**, y obtendremos ejecuci贸n de c贸digo

### Ataque

El ataque comienza logrando obtener el **top chunk** dentro del **unsorted bin**. Esto se logra llamando a `malloc` con un tama帽o mayor al tama帽o actual del top chunk pero menor que **`mmp_.mmap_threshold`** (por defecto es 128K), lo cual de lo contrario activar铆a la asignaci贸n de `mmap`. Siempre que se modifique el tama帽o del top chunk, es importante asegurarse de que el **top chunk + su tama帽o** est茅 alineado a p谩gina y que el bit **prev\_inuse** del top chunk est茅 siempre establecido.

Para obtener el top chunk dentro del unsorted bin, asigna un chunk para crear el top chunk, cambia el tama帽o del top chunk (con un desbordamiento en el chunk asignado) de manera que **top chunk + tama帽o** est茅 alineado a p谩gina con el bit **prev\_inuse** establecido. Luego asigna un chunk m谩s grande que el nuevo tama帽o del top chunk. Ten en cuenta que `free` nunca se llama para colocar el top chunk en el unsorted bin.

El antiguo top chunk est谩 ahora en el unsorted bin. Suponiendo que podemos leer datos dentro de 茅l (posiblemente debido a una vulnerabilidad que tambi茅n caus贸 el desbordamiento), es posible filtrar direcciones de Libc desde 茅l y obtener la direcci贸n de **\_IO\_list\_all**.

Se realiza un ataque al unsorted bin abusando del desbordamiento para escribir `topChunk->bk->fwd = _IO_list_all - 0x10`. Cuando se asigna un nuevo chunk, el antiguo top chunk se dividir谩 y se escribir谩 un puntero al unsorted bin en **`_IO_list_all`**.

El siguiente paso implica reducir el tama帽o del antiguo top chunk para que quepa en un small bin, estableciendo espec铆ficamente su tama帽o en **0x61**. Esto sirve para dos prop贸sitos:

1. **Inserci贸n en Small Bin 4**: Cuando `malloc` escanea el unsorted bin y ve este chunk, intentar谩 insertarlo en el small bin 4 debido a su peque帽o tama帽o. Esto hace que el chunk termine en la cabeza de la lista del small bin 4 que es la ubicaci贸n del puntero FD del chunk de **`_IO_list_all`** ya que escribimos una direcci贸n cercana en **`_IO_list_all`** mediante el ataque al unsorted bin.
2. **Desencadenar una Verificaci贸n de Malloc**: Esta manipulaci贸n del tama帽o del chunk causar谩 que `malloc` realice verificaciones internas. Cuando verifica el tama帽o del chunk falso hacia adelante, que ser谩 cero, desencadena un error y llama a `malloc_printerr`.

La manipulaci贸n del small bin te permitir谩 controlar el puntero hacia adelante del chunk. La superposici贸n con **\_IO\_list\_all** se utiliza para forjar una estructura falsa de **\_IO\_FILE**. La estructura se crea cuidadosamente para incluir campos clave como `_IO_write_base` y `_IO_write_ptr` establecidos en valores que pasan las verificaciones internas en libc. Adem谩s, se crea una tabla de saltos dentro de la estructura falsa, donde se establece un puntero de instrucci贸n en la direcci贸n donde se puede ejecutar c贸digo arbitrario (por ejemplo, la funci贸n `system`).

Para resumir la parte restante de la t茅cnica:

* **Reducir el Antiguo Top Chunk**: Ajustar el tama帽o del antiguo top chunk a **0x61** para que quepa en un small bin.
* **Configurar la Estructura Falsa de `_IO_FILE`**: Superponer el antiguo top chunk con la falsa estructura de **\_IO\_FILE** y establecer los campos de manera adecuada para secuestrar el flujo de ejecuci贸n.

El siguiente paso implica forjar una falsa estructura de **\_IO\_FILE** que se superpone con el antiguo top chunk actualmente en el unsorted bin. Los primeros bytes de esta estructura se crean cuidadosamente para incluir un puntero a un comando (por ejemplo, "/bin/sh") que se ejecutar谩.

Los campos clave en la falsa estructura de **\_IO\_FILE**, como `_IO_write_base` y `_IO_write_ptr`, se establecen en valores que pasan las verificaciones internas en libc. Adem谩s, se crea una tabla de saltos dentro de la estructura falsa, donde se establece un puntero de instrucci贸n en la direcci贸n donde se puede ejecutar c贸digo arbitrario. T铆picamente, esta ser铆a la direcci贸n de la funci贸n `system` u otra funci贸n que pueda ejecutar comandos de shell.

El ataque culmina cuando una llamada a `malloc` desencadena la ejecuci贸n del c贸digo a trav茅s de la estructura manipulada de **\_IO\_FILE**. Esto permite la ejecuci贸n de c贸digo arbitrario, lo que generalmente resulta en el inicio de un shell u otra carga maliciosa.

**Resumen del Ataque:**

1. **Configurar el top chunk**: Asignar un chunk y modificar el tama帽o del top chunk.
2. **Forzar el top chunk en el unsorted bin**: Asignar un chunk m谩s grande.
3. **Filtrar direcciones de Libc**: Utilizar la vulnerabilidad para leer desde el unsorted bin.
4. **Realizar el ataque al unsorted bin**: Escribir en **\_IO\_list\_all** utilizando un desbordamiento.
5. **Reducir el antiguo top chunk**: Ajustar su tama帽o para que quepa en un small bin.
6. **Configurar una estructura falsa de \_IO\_FILE**: Forjar una estructura de archivo falsa para secuestrar el flujo de control.
7. **Desencadenar la ejecuci贸n de c贸digo**: Asignar un chunk para ejecutar el ataque y ejecutar c贸digo arbitrario.

Este enfoque explota los mecanismos de gesti贸n de heap, las fugas de informaci贸n de libc y los desbordamientos de heap para lograr la ejecuci贸n de c贸digo sin llamar directamente a `free`. Al crear cuidadosamente la falsa estructura de **\_IO\_FILE** y colocarla en la ubicaci贸n correcta, el ataque puede secuestrar el flujo de control durante las operaciones est谩ndar de asignaci贸n de memoria. Esto permite la ejecuci贸n de c贸digo arbitrario, lo que potencialmente resulta en un shell u otras actividades maliciosas.
## Referencias

* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_orange/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_orange/)
* [https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci贸n**](https://github.com/sponsors/carlospolop)!
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
