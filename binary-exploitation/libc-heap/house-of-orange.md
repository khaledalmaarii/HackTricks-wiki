# Ku캖a narand쬬sta

{% hint style="success" %}
Nau캜ite i ve쬭ajte hakovanje AWS-a:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Nau캜ite i ve쬭ajte hakovanje GCP-a: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr쬴te HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## Osnovne informacije

### Kod

* Prona캠ite primer na [https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_orange.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_orange.c)
* Tehnika eksploatacije je popravljena u ovom [patch-u](https://sourceware.org/git/?p=glibc.git;a=blobdiff;f=stdlib/abort.c;h=117a507ff88d862445551f2c07abb6e45a716b75;hp=19882f3e3dc1ab830431506329c94dcf1d7cc252;hb=91e7cf982d0104f0e71770f5ae8e3faf352dea9f;hpb=0c25125780083cbba22ed627756548efe282d1a0) tako da vi코e ne radi (radi u verzijama pre 2.26)
* Isti primer **sa vi코e komentara** na [https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)

### Cilj

* Zloupotreba funkcije `malloc_printerr`

### Zahtevi

* Prepisivanje veli캜ine vr코nog bloka
* Curenje libc-a i hipa

### Pozadina

Neophodne informacije iz komentara iz [**ovog primera**](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)**:**

Stvar je u tome da su u starijim verzijama libc-a, kada je pozvana funkcija `malloc_printerr`, ona bi **iterirala kroz listu `_IO_FILE` struktura sme코tenih u `_IO_list_all`**, i zapravo **izvr코ila** pokaziva캜 instrukcije u toj strukturi.\
Ovaj napad 캖e falsifikovati **la쬹u `_IO_FILE` strukturu** koju 캖emo pisati u **`_IO_list_all`**, i izazvati pokretanje `malloc_printerr`.\
Zatim 캖e **izvr코iti bilo koju adresu** koju smo sa캜uvali u **`_IO_FILE`** strukturama jump tabele, i dobi캖emo izvr코enje koda

### Napad

Napad po캜inje tako 코to se uspe da se dobije **vr코ni blok** unutar **nesortirane kante**. To se posti쬰 pozivom `malloc` sa veli캜inom ve캖om od trenutne veli캜ine vr코nog bloka, ali manjom od **`mmp_.mmap_threshold`** (podrazumevano je 128K), 코to bi ina캜e pokrenulo alokaciju `mmap`. Kada se modifikuje veli캜ina vr코nog bloka, va쬹o je osigurati da je **vr코ni blok + njegova veli캜ina** poravnata sa stranicom i da je bit **prev\_inuse** vr코nog bloka uvek postavljen.

Da biste dobili vr코ni blok unutar nesortirane kante, alocirajte deo kako biste kreirali vr코ni blok, promenite veli캜inu vr코nog bloka (sa prelivanjem u alociranom delu) tako da je **vr코ni blok + veli캜ina** poravnata sa stranicom sa postavljenim bitom **prev\_inuse**. Zatim alocirajte deo ve캖i od nove veli캜ine vr코nog bloka. Imajte na umu da se `free` nikada ne poziva da bi se vr코ni blok stavio u nesortiranu kantu.

Stari vr코ni blok je sada u nesortiranoj kanti. Pretpostavljaju캖i da mo쬰mo 캜itati podatke unutar njega (mo쬯a zbog ranjivosti koja je tako캠e uzrokovala prelivanje), mogu캖e je procuriti libc adrese iz njega i dobiti adresu **\_IO\_list\_all**.

Napad na nesortiranu kantu se izvodi zloupotrebom prelivanja kako bi se napisalo `topChunk->bk->fwd = _IO_list_all - 0x10`. Kada se alocira novi deo, stari vr코ni blok 캖e biti podeljen, i pokaziva캜 na nesortiranu kantu 캖e biti napisan u **`_IO_list_all`**.

Slede캖i korak uklju캜uje smanjenje veli캜ine starog vr코nog bloka kako bi se uklopio u malu kantu, posebno postavljanjem njegove veli캜ine na **0x61**. Ovo ima dva cilja:

1. **Umetanje u malu kantu 4**: Kada `malloc` skenira kroz nesortiranu kantu i vidi ovaj deo, poku코a캖e da ga ubaci u malu kantu 4 zbog njegove male veli캜ine. To dovodi do toga da deo zavr코i na vrhu liste male kante 4, 코to je lokacija pokaziva캜a FD dela **`_IO_list_all`** jer smo napisali blisku adresu u **`_IO_list_all`** putem napada na nesortiranu kantu.
2. **Pokretanje provere Malloc**: Ova manipulacija veli캜inom dela 캖e naterati `malloc` da izvr코i interne provere. Kada proveri veli캜inu la쬹og naprednog dela, koji 캖e biti nula, izazva캖e gre코ku i pozvati `malloc_printerr`.

Manipulacija malom kantom 캖e vam omogu캖iti kontrolu naprednog pokaziva캜a dela. Preklapanje sa **\_IO\_list\_all** se koristi za falsifikovanje la쬹e **\_IO\_FILE** strukture. Struktura je pa쬷jivo oblikovana da uklju캜i klju캜na polja poput `_IO_write_base` i `_IO_write_ptr` postavljena na vrednosti koje prolaze interne provere u libc-u. Dodatno, unutar la쬹e strukture se kreira jump tabela, gde se postavlja pokaziva캜 instrukcije na adresu gde se mo쬰 izvr코iti proizvoljan kod (npr. funkcija `system`).

Da sumiramo preostali deo tehnike:

* **Smanjite stari vr코ni blok**: Prilagodite veli캜inu starog vr코nog bloka na **0x61** kako biste ga uklopili u malu kantu.
* **Postavite la쬹u `_IO_FILE` strukturu**: Preklopite stari vr코ni blok sa la쬹om **\_IO\_FILE** strukturom i postavite polja na odgovaraju캖i na캜in da preuzmete kontrolu nad tokom izvr코enja.

Slede캖i korak uklju캜uje falsifikovanje la쬹e **\_IO\_FILE** strukture koja se preklapa sa starim vr코nim blokom koji se trenutno nalazi u nesortiranoj kanti. Prvi bajtovi ove strukture pa쬷jivo su oblikovani da uklju캜e pokaziva캜 na komandu (npr. "/bin/sh") koja 캖e biti izvr코ena.

Klju캜na polja u la쬹oj **\_IO\_FILE** strukturi, poput `_IO_write_base` i `_IO_write_ptr`, postavljena su na vrednosti koje prolaze interne provere u libc-u. Dodatno, unutar la쬹e strukture se kreira jump tabela, gde se postavlja pokaziva캜 instrukcije na adresu gde se mo쬰 izvr코iti proizvoljan kod. Tipi캜no, to bi bila adresa funkcije `system` ili neke druge funkcije koja mo쬰 izvr코iti shell komande.

Napad kulminira kada poziv `malloc` pokrene izvr코enje koda putem manipulisane **\_IO\_FILE** strukture. Ovo efikasno omogu캖ava izvr코enje proizvoljnog koda, 코to obi캜no rezultira spawnovanjem shell-a ili izvr코avanjem druge zlonamerne payload-a.

**Rezime napada:**

1. **Postavite vr코ni blok**: Alocirajte deo i modifikujte veli캜inu vr코nog bloka.
2. **Prisilite vr코ni blok u nesortiranu kantu**: Alocirajte ve캖i deo.
3. **Curenje libc adresa**: Iskoristite ranjivost da 캜itate iz nesortirane kante.
4. **Izvr코ite napad na nesortiranu kantu**: Napi코ite u **\_IO\_list\_all** kori코캖enjem prelivanja.
5. **Smanjite stari vr코ni blok**: Prilagodite njegovu veli캜inu da se uklopi u malu kantu.
6. **Postavite la쬹u \_IO\_FILE strukturu**: Falsifikujte la쬹u strukturu datoteke da preuzmete kontrolu nad tokom izvr코enja.
7. **Pokrenite izvr코enje koda**: Alocirajte deo da izvr코ite napad i pokrenete proizvoljan kod.

Ovaj pristup eksploati코e mehanizme upravljanja hipom, curenje informacija libc-a i prelivanje hipa kako bi se postiglo izvr코enje koda bez direktnog pozivanja `free`. Pa쬷jivim oblikovanjem la쬹e **\_IO\_FILE** strukture i postavljanjem je na pravo mesto, napad mo쬰 preuzeti kontrolu nad tokom izvr코enja tokom standardnih operacija alokacije memorije. Ovo omogu캖ava izvr코enje proizvoljnog koda, 코to potencijalno rezultira shell-om ili drugim zlonamernim aktivnostima.
## Reference

* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_orange/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_orange/)
* [https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)

{% hint style="success" %}
U캜ite i ve쬭ajte hakovanje AWS-a:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
U캜ite i ve쬭ajte hakovanje GCP-a: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr쬴te HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
