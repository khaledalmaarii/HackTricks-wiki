# House of Orange

{% hint style="success" %}
AWS Hacking Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katÄ±lÄ±n veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ± paylaÅŸarak PR'ler gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>
{% endhint %}

## Temel Bilgiler

### Kod

* Ã–rnek bulunabilir: [https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_orange.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_orange.c)
* SaldÄ±rÄ± tekniÄŸi bu [yamada](https://sourceware.org/git/?p=glibc.git;a=blobdiff;f=stdlib/abort.c;h=117a507ff88d862445551f2c07abb6e45a716b75;hp=19882f3e3dc1ab830431506329c94dcf1d7cc252;hb=91e7cf982d0104f0e71770f5ae8e3faf352dea9f;hpb=0c25125780083cbba22ed627756548efe282d1a0) dÃ¼zeltildi (2.26'dan Ã¶nce Ã§alÄ±ÅŸÄ±r)
* Daha fazla yorumla aynÄ± Ã¶rnek: [https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)

### AmaÃ§

* `malloc_printerr` fonksiyonunu kÃ¶tÃ¼ye kullanmak

### Gereksinimler

* Ãœst parÃ§a boyutunu Ã¼zerine yaz
* Libc ve heap sÄ±zÄ±ntÄ±larÄ±

### Arka Plan

Gerekli arka plan bilgileri [**bu Ã¶rneÄŸin**](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)** yorumlarÄ±ndan alÄ±nabilir:**

Ã–nceki libc sÃ¼rÃ¼mlerinde, `malloc_printerr` fonksiyonu Ã§aÄŸrÄ±ldÄ±ÄŸÄ±nda, `_IO_list_all` iÃ§inde depolanan `_IO_FILE` yapÄ±larÄ±nÄ±n listesini dolaÅŸÄ±r ve aslÄ±nda bu yapÄ±daki bir komut iÅŸaretÃ§isini **Ã§alÄ±ÅŸtÄ±rÄ±rdÄ±**.\
Bu saldÄ±rÄ±, **sahte bir `_IO_FILE` yapÄ±sÄ±** oluÅŸturacak ve bu yapÄ±nÄ±n `_IO_list_all`'a yazÄ±lmasÄ±na neden olacak ve `malloc_printerr`'Ä±n Ã§alÄ±ÅŸmasÄ±na neden olacak.\
Daha sonra, **`_IO_FILE`** yapÄ±larÄ±nÄ±n atlamalÄ± tablosunda depolanan herhangi bir adresi **Ã§alÄ±ÅŸtÄ±racak** ve kod yÃ¼rÃ¼teceÄŸiz.

### SaldÄ±rÄ±

SaldÄ±rÄ±, **sÄ±ralanmamÄ±ÅŸ parÃ§ada** **Ã¼st parÃ§ayÄ±** elde etmekle baÅŸlar. Bu, `malloc` Ã§aÄŸrÄ±larak baÅŸarÄ±lÄ±r; mevcut Ã¼st parÃ§a boyutundan daha bÃ¼yÃ¼k ancak **`mmp_.mmap_threshold`**'den (varsayÄ±lan olarak 128K) daha kÃ¼Ã§Ã¼k bir boyutta. Ãœst parÃ§a boyutu deÄŸiÅŸtirildiÄŸinde, **Ã¼st parÃ§a + boyutunun** sayfa hizalanmÄ±ÅŸ olmasÄ±nÄ± ve Ã¼st parÃ§a **prev\_inuse** bitinin her zaman ayarlÄ± olmasÄ±nÄ± saÄŸlamak Ã¶nemlidir.

Ãœst parÃ§ayÄ± sÄ±ralanmamÄ±ÅŸ parÃ§ada elde etmek iÃ§in, Ã¼st parÃ§ayÄ± oluÅŸturmak iÃ§in bir parÃ§a tahsis edilir, Ã¼st parÃ§a boyutu deÄŸiÅŸtirilir (tahsis edilen parÃ§ada taÅŸma ile) bÃ¶ylece **Ã¼st parÃ§a + boyut** sayfa hizalanmÄ±ÅŸ ve **prev\_inuse** biti ayarlÄ± olacak ÅŸekilde. Daha sonra, yeni Ã¼st parÃ§a boyutundan daha bÃ¼yÃ¼k bir parÃ§a tahsis edilir. Ãœst parÃ§ayÄ± sÄ±ralanmamÄ±ÅŸ parÃ§aya almak iÃ§in asla `free` Ã§aÄŸrÄ±lmaz.

Eski Ã¼st parÃ§a ÅŸimdi sÄ±ralanmamÄ±ÅŸ parÃ§ada. Ä°Ã§indeki verileri okuyabiliyorsak (muhtemelen taÅŸmaya neden olan bir zayÄ±flÄ±ktan dolayÄ±), libc adreslerini sÄ±zdÄ±rmak ve **\_IO\_list\_all** adresini almak mÃ¼mkÃ¼ndÃ¼r.

SÄ±ralanmamÄ±ÅŸ parÃ§a saldÄ±rÄ±sÄ±, taÅŸmayÄ± kÃ¶tÃ¼ye kullanarak `topChunk->bk->fwd = _IO_list_all - 0x10` yazarak gerÃ§ekleÅŸtirilir. Yeni bir parÃ§a tahsis edildiÄŸinde, eski Ã¼st parÃ§a bÃ¶lÃ¼necek ve sÄ±ralanmamÄ±ÅŸ parÃ§aya bir iÅŸaretÃ§i yazÄ±lacaktÄ±r **`_IO_list_all`**.

Bir sonraki adÄ±m, eski Ã¼st parÃ§a boyutunu kÃ¼Ã§Ã¼ltmek ve kÃ¼Ã§Ã¼k bir parÃ§a iÃ§ine sÄ±ÄŸacak ÅŸekilde ayarlamaktÄ±r, Ã¶zellikle boyutunu **0x61** olarak ayarlamaktÄ±r. Bu iki amaÃ§la hizmet eder:

1. **KÃ¼Ã§Ã¼k ParÃ§a 4'e Ekleme**: `malloc`, sÄ±ralanmamÄ±ÅŸ parÃ§ayÄ± taradÄ±ÄŸÄ±nda ve bu parÃ§ayÄ± gÃ¶rÃ¼rse, boyutu kÃ¼Ã§Ã¼k olduÄŸundan kÃ¼Ã§Ã¼k parÃ§a 4'e eklemeye Ã§alÄ±ÅŸacaktÄ±r. Bu, parÃ§anÄ±n, _IO_list_all'Ä±n bir yakÄ±n adresini **`_IO_list_all`** Ã¼zerinden yazdÄ±ÄŸÄ±mÄ±z iÃ§in kÃ¼Ã§Ã¼k parÃ§a 4 listesinin baÅŸÄ±na gelmesine neden olur.
2. **Malloc KontrolÃ¼nÃ¼ Tetikleme**: Bu parÃ§a boyutu manipÃ¼lasyonu, `malloc`'Ä±n iÃ§ kontrolleri yapmasÄ±na neden olacaktÄ±r. Sahte ileri parÃ§a boyutunu kontrol ettiÄŸinde, bu boyut sÄ±fÄ±r olacaÄŸÄ±ndan bir hata tetikler ve `malloc_printerr`'Ä± Ã§aÄŸÄ±rÄ±r.

KÃ¼Ã§Ã¼k parÃ§a manipÃ¼lasyonu, parÃ§anÄ±n ileri iÅŸaretÃ§isini kontrol etmenizi saÄŸlar. **\_IO\_list\_all** ile Ã§akÄ±ÅŸma, sahte bir **\_IO\_FILE** yapÄ±sÄ± oluÅŸturmak iÃ§in kullanÄ±lÄ±r. YapÄ±, libc'de iÃ§ kontrolleri geÃ§en `_IO_write_base` ve `_IO_write_ptr` gibi ana alanlarÄ± iÃ§erecek ÅŸekilde dikkatlice oluÅŸturulur. AyrÄ±ca, sahte yapÄ± iÃ§inde bir atlamalÄ± tablo oluÅŸturulur, burada bir komut iÅŸaretÃ§isi, keyfi kodun (Ã¶rneÄŸin, `system` iÅŸlevinin) yÃ¼rÃ¼tÃ¼lebileceÄŸi adres olarak ayarlanÄ±r.

TekniÄŸin geri kalanÄ±nÄ± Ã¶zetlemek gerekirse:

* **Eski Ãœst ParÃ§ayÄ± KÃ¼Ã§Ã¼lt**: Eski Ã¼st parÃ§anÄ±n boyutunu **0x61** olarak ayarlayarak kÃ¼Ã§Ã¼ltÃ¼n.
* **Sahte `_IO_FILE` YapÄ±sÄ±nÄ± Kur**: Eski Ã¼st parÃ§ayla Ã§akÄ±ÅŸan sahte **\_IO_FILE** yapÄ±sÄ±nÄ± oluÅŸturun ve akÄ±ÅŸ kontrolÃ¼nÃ¼ ele geÃ§irin.

Bir sonraki adÄ±m, ÅŸu anda sÄ±ralanmamÄ±ÅŸ parÃ§ada bulunan eski Ã¼st parÃ§ayla Ã§akÄ±ÅŸan sahte **\_IO_FILE** yapÄ±sÄ±nÄ± oluÅŸturmaktÄ±r. Bu yapÄ±nÄ±n ilk baytlarÄ± dikkatlice oluÅŸturulur ve yÃ¼rÃ¼tÃ¼lecek bir komuta (Ã¶rneÄŸin, "/bin/sh") bir iÅŸaretÃ§i iÃ§erir.

Sahte **\_IO_FILE** yapÄ±sÄ±ndaki ana alanlar, `_IO_write_base` ve `_IO_write_ptr` gibi, libc'de iÃ§ kontrolleri geÃ§en deÄŸerlere ayarlanÄ±r. AyrÄ±ca, sahte yapÄ± iÃ§inde bir atlamalÄ± tablo oluÅŸturulur, burada bir komut iÅŸaretÃ§isi, keyfi kodun yÃ¼rÃ¼tÃ¼lebileceÄŸi adres olarak ayarlanÄ±r. Genellikle, bu, `system` iÅŸlevinin adresi veya kabuk komutlarÄ±nÄ±n yÃ¼rÃ¼tÃ¼lebileceÄŸi baÅŸka bir iÅŸlevin adresi olacaktÄ±r.

SaldÄ±rÄ±, `malloc`'Ä±n bir Ã§aÄŸrÄ±sÄ±, manipÃ¼le edilmiÅŸ **\_IO\_FILE** yapÄ±sÄ± Ã¼zerinden kodun yÃ¼rÃ¼tÃ¼lmesini tetiklediÄŸinde doruÄŸa ulaÅŸÄ±r. Bu, genellikle bir kabukun baÅŸlatÄ±lmasÄ±na veya baÅŸka kÃ¶tÃ¼ amaÃ§lÄ± bir yÃ¼kÃ¼n yÃ¼rÃ¼tÃ¼lmesine neden olacak keyfi kod yÃ¼rÃ¼tÃ¼lmesine izin verir.

**SaldÄ±rÄ±nÄ±n Ã–zeti:**

1. **Ãœst parÃ§ayÄ± hazÄ±rlayÄ±n**: Bir parÃ§a tahsis edin ve Ã¼st parÃ§a boyutunu deÄŸiÅŸtirin.
2. **Ãœst parÃ§ayÄ± sÄ±ralanmamÄ±ÅŸ parÃ§aya zorla**: Daha bÃ¼yÃ¼k bir parÃ§a tahsis edin.
3. **Libc adreslerini sÄ±zdÄ±rÄ±n**: ZayÄ±flÄ±ktan yararlanarak sÄ±ralanmamÄ±ÅŸ parÃ§adan okuyun.
4. **SÄ±ralanmamÄ±ÅŸ parÃ§a saldÄ±rÄ±sÄ±nÄ± gerÃ§ekleÅŸtirin**: TaÅŸma kullanarak **\_IO\_list\_all**'a yazÄ±n.
5. **Eski Ã¼st parÃ§ayÄ± kÃ¼Ã§Ã¼ltÃ¼n**: KÃ¼Ã§Ã¼k bir parÃ§aya sÄ±ÄŸacak ÅŸekilde boyutunu ayarlayÄ±n.
6. **Sahte \_IO\_FILE yapÄ±sÄ±nÄ± kurun**: AkÄ±ÅŸ kontrolÃ¼nÃ¼ ele geÃ§irmek iÃ§in sahte bir dosya yapÄ±sÄ± oluÅŸturun.
7. **Kod yÃ¼rÃ¼tmesini tetikleyin**: SaldÄ±rÄ±yÄ± yÃ¼rÃ¼tmek ve keyfi kod Ã§alÄ±ÅŸtÄ±rmak iÃ§in bir parÃ§a tahsis edin.

Bu yaklaÅŸÄ±m, `free` doÄŸrudan Ã§aÄŸrÄ±lmadan kod yÃ¼rÃ¼tme saÄŸlamak iÃ§in heap yÃ¶netimi mekanizmalarÄ±nÄ±, libc bilgi sÄ±zÄ±ntÄ±larÄ±nÄ± ve heap taÅŸmalarÄ±nÄ± kÃ¶tÃ¼ye kullanÄ±r. Sahte **\_IO\_FILE** yapÄ±sÄ±nÄ± dikkatlice oluÅŸturarak ve doÄŸru konuma yerleÅŸtirerek, saldÄ±rÄ± standart bellek tahsis iÅŸlemleri sÄ±rasÄ±nda kontrol akÄ±ÅŸÄ±nÄ± ele geÃ§irebilir. Bu, keyfi kodun yÃ¼rÃ¼tÃ¼lmesine olanak tanÄ±r ve genellikle bir kabuk veya diÄŸer kÃ¶tÃ¼ amaÃ§lÄ± faaliyetlerin yÃ¼rÃ¼tÃ¼lmesine neden olabilir.
## Referanslar

* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_orange/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_orange/)
* [https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)

{% hint style="success" %}
AWS Hacking'Ä± Ã¶ÄŸrenin ve uygulayÄ±n: <img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'Ä± Ã¶ÄŸrenin ve uygulayÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katÄ±lÄ±n veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* Hacking pÃ¼f noktalarÄ±nÄ± paylaÅŸarak PR'ler gÃ¶ndererek **HackTricks** ve **HackTricks Cloud** github depolarÄ±na katkÄ±da bulunun.

</details>
{% endhint %}
