# House of Roman

<details>

<summary><strong>htARTE (HackTricks AWS Red Team ì „ë¬¸ê°€)ë¡œë¶€í„° AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ìš°ì„¸ìš”!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

- **íšŒì‚¬ê°€ HackTricksì— ê´‘ê³ ë˜ê¸¸ ì›í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œí•˜ê³  ì‹¶ë‹¤ë©´** [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
- [**ê³µì‹ PEASS & HackTricks êµ¿ì¦ˆ**](https://peass.creator-spring.com)ë¥¼ êµ¬ë§¤í•˜ì„¸ìš”
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ë‹¹ì‚¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
- ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ê°€ì…**í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ë¥¼ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
- **HackTricks** ë° **HackTricks Cloud** github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ ì—¬ëŸ¬ë¶„ì˜ í•´í‚¹ ê¸°ìˆ ì„ ê³µìœ í•˜ì„¸ìš”.

</details>

## ê¸°ë³¸ ì •ë³´

ì´ ê¸°ë²•ì€ ê°€ì§œ fastbins, unsorted\_bin ê³µê²© ë° ìƒëŒ€ì  ë®ì–´ì“°ê¸°ë¥¼ í†µí•´ ëˆ„ì¶œ ì—†ì´ RCEë¥¼ ê°€ëŠ¥ì¼€ í•˜ëŠ” ë§¤ìš° í¥ë¯¸ë¡œìš´ ê¸°ë²•ì´ì—ˆìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ [**íŒ¨ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤**](https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=b90ddd08f6dd688e651df9ee89ca3a69ff88cd0c).

### ì½”ë“œ

* ì˜ˆì œëŠ” [https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ëª©í‘œ

* ìƒëŒ€ì ì¸ í¬ì¸í„°ë¥¼ ì•…ìš©í•˜ì—¬ RCE

### ìš”êµ¬ ì‚¬í•­

* fastbin ë° unsorted bin í¬ì¸í„° í¸ì§‘
* ì‘ë™í•  í™•ë¥ ì´ 0.02%ì¸ 12ë¹„íŠ¸ì˜ ë¬´ì‘ìœ„ì„±ì„ ë¸Œë£¨íŠ¸ í¬ìŠ¤í•´ì•¼ í•¨

## ê³µê²© ë‹¨ê³„

### íŒŒíŠ¸ 1: Fastbin Chunkê°€ \_\_malloc\_hookì„ ê°€ë¦¬í‚¤ë„ë¡ í•¨

ì—¬ëŸ¬ ì²­í¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤:

* `fastbin_victim` (0x60, ì˜¤í”„ì…‹ 0): ë‚˜ì¤‘ì— í™ í¬ì¸í„°ë¥¼ LibC ê°’ìœ¼ë¡œ ê°€ë¦¬í‚¤ë„ë¡ ë‚˜ì¤‘ì— í¸ì§‘í•  UAF ì²­í¬
* `chunk2` (0x80, ì˜¤í”„ì…‹ 0x70): ì¢‹ì€ ì •ë ¬ì„ ìœ„í•´
* `main_arena_use` (0x80, ì˜¤í”„ì…‹ 0x100)
* `relative_offset_heap` (0x60, ì˜¤í”„ì…‹ 0x190): 'main\_arena\_use' ì²­í¬ì—ì„œì˜ ìƒëŒ€ì  ì˜¤í”„ì…‹

ê·¸ëŸ° ë‹¤ìŒ `free(main_arena_use)`ë¥¼ ìˆ˜í–‰í•˜ì—¬ ì´ ì²­í¬ë¥¼ unsorted ëª©ë¡ì— ë°°ì¹˜í•˜ê³  `fd` ë° `bk` í¬ì¸í„° ëª¨ë‘ì—ì„œ `main_arena + 0x68`ì„ ê°€ë¦¬í‚¤ëŠ” í¬ì¸í„°ë¥¼ ì–»ê²Œ ë©ë‹ˆë‹¤.

ì´ì œ `fd` ë° `bk` í¬ì¸í„°ì—ì„œ `main_arena + 0x68`ì„ ê°€ë¦¬í‚¤ëŠ” í¬ì¸í„°ë¥¼ í¬í•¨í•  ê²ƒì´ë¯€ë¡œ ìƒˆë¡œìš´ ì²­í¬ `fake_libc_chunk(0x60)`ê°€ í• ë‹¹ë©ë‹ˆë‹¤.

ê·¸ëŸ° ë‹¤ìŒ `relative_offset_heap` ë° `fastbin_victim`ì„ í•´ì œí•©ë‹ˆë‹¤.
```c
/*
Current heap layout:
0x0:   fastbin_victim       - size 0x70
0x70:  alignment_filler     - size 0x90
0x100: fake_libc_chunk      - size 0x70 (contains a fd ptr to main_arena + 0x68)
0x170: leftover_main        - size 0x20
0x190: relative_offset_heap - size 0x70

bin layout:
fastbin:  fastbin_victim -> relative_offset_heap
unsorted: leftover_main
*/
```
* &#x20;`fastbin_victim`ì€ `relative_offset_heap`ì„ ê°€ë¦¬í‚¤ëŠ” `fd`ë¥¼ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.
* &#x20;`relative_offset_heap`ì€ `fake_libc_chunk`ë¡œë¶€í„°ì˜ ê±°ë¦¬ ì˜¤í”„ì…‹ì´ë©°, `main_arena + 0x68`ì„ ê°€ë¦¬í‚¤ëŠ” í¬ì¸í„°ë¥¼ í¬í•¨í•©ë‹ˆë‹¤.
* `fastbin_victim.fd`ì˜ ë§ˆì§€ë§‰ ë°”ì´íŠ¸ë¥¼ ë³€ê²½í•¨ìœ¼ë¡œì¨ `fastbin_victim`ì´ `main_arena + 0x68`ì„ ê°€ë¦¬í‚¤ë„ë¡ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ì „ ë™ì‘ì„ ìœ„í•´ ê³µê²©ìëŠ” `fastbin_victim`ì˜ `fd` í¬ì¸í„°ë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.

ê·¸ëŸ° ë‹¤ìŒ, `main_arena + 0x68`ì€ ê·¸ë‹¤ì§€ í¥ë¯¸ë¡œìš´ ê²ƒì´ ì•„ë‹ˆë¯€ë¡œ í¬ì¸í„°ê°€ **`__malloc_hook`**ì„ ê°€ë¦¬í‚¤ë„ë¡ ìˆ˜ì •í•©ë‹ˆë‹¤.

`__memalign_hook`ì€ ì¼ë°˜ì ìœ¼ë¡œ `0x7f`ë¡œ ì‹œì‘í•˜ê³  ê·¸ ì•ì—ëŠ” 0ìœ¼ë¡œ ì±„ì›Œì§€ë¯€ë¡œ, `0x70` fast binì˜ ê°’ìœ¼ë¡œ ê°€ì§œë¡œ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì£¼ì†Œì˜ ë§ˆì§€ë§‰ 4ë¹„íŠ¸ëŠ” **ëœë¤**ì´ë¯€ë¡œ ì›í•˜ëŠ” ìœ„ì¹˜ë¥¼ ê°€ë¦¬í‚¤ë„ë¡ ëì„ ë§ì¶œ ìˆ˜ ìˆëŠ” ê°€ëŠ¥ì„±ì€ `2^4=16`ì…ë‹ˆë‹¤. ë”°ë¼ì„œ ì—¬ê¸°ì„œëŠ” BF ê³µê²©ì„ ìˆ˜í–‰í•˜ì—¬ ì²­í¬ê°€ ë‹¤ìŒê³¼ ê°™ì´ ëë‚˜ë„ë¡ í•©ë‹ˆë‹¤: **`0x70: fastbin_victim -> fake_libc_chunk -> (__malloc_hook - 0x23)`**.

(ë‚˜ë¨¸ì§€ ë°”ì´íŠ¸ì— ëŒ€í•œ ìì„¸í•œ ë‚´ìš©ì€ [how2heap](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)ì˜ ì„¤ëª…ì„ í™•ì¸í•˜ì‹­ì‹œì˜¤. BFê°€ ì‘ë™í•˜ì§€ ì•Šìœ¼ë©´ í”„ë¡œê·¸ë¨ì´ ì¤‘ë‹¨ë©ë‹ˆë‹¤ (ì‘ë™í•  ë•Œê¹Œì§€ ë‹¤ì‹œ ì‹œì‘í•˜ì‹­ì‹œì˜¤).

ê·¸ëŸ° ë‹¤ìŒ, ì²˜ìŒ 2ê°œì˜ fast bin ì²­í¬ë¥¼ ì œê±°í•˜ê¸° ìœ„í•´ 2ê°œì˜ mallocì´ ìˆ˜í–‰ë˜ê³ , ì„¸ ë²ˆì§¸ mallocì´ ìˆ˜í–‰ë˜ì–´ **`__malloc_hook:`**ì—ì„œ ì²­í¬ë¥¼ ì–»ìŠµë‹ˆë‹¤.
```c
malloc(0x60);
malloc(0x60);
uint8_t* malloc_hook_chunk = malloc(0x60);
```
### íŒŒíŠ¸ 2: Unsorted\_bin ê³µê²©

ë” ë§ì€ ì •ë³´ë¥¼ ì›í•˜ì‹œë©´ ì•„ë˜ë¥¼ í™•ì¸í•˜ì„¸ìš”:

{% content-ref url="unsorted-bin-attack.md" %}
[unsorted-bin-attack.md](unsorted-bin-attack.md)
{% endcontent-ref %}

ê¸°ë³¸ì ìœ¼ë¡œëŠ” `chunk->bk`ì— ì§€ì •ëœ ìœ„ì¹˜ë¡œ `main_arena + 0x68`ì„ ì“¸ ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤. ê·¸ë¦¬ê³  ìš°ë¦¬ëŠ” ê³µê²©ì— `__malloc_hook`ì„ ì„ íƒí•©ë‹ˆë‹¤. ê·¸ëŸ° ë‹¤ìŒ ë®ì–´ì“´ í›„ì— ìƒëŒ€ì  ë®ì–´ì“°ê¸°ë¥¼ ì‚¬ìš©í•˜ì—¬ `one_gadget`ì„ ê°€ë¦¬í‚¤ê²Œ í•  ê²ƒì…ë‹ˆë‹¤.

ì´ë¥¼ ìœ„í•´ ì²­í¬ë¥¼ ê°€ì ¸ì™€ì„œ **unsorted bin**ì— ë„£ê¸° ì‹œì‘í•©ë‹ˆë‹¤:
```c
uint8_t* unsorted_bin_ptr = malloc(0x80);
malloc(0x30); // Don't want to consolidate

puts("Put chunk into unsorted_bin\n");
// Free the chunk to create the UAF
free(unsorted_bin_ptr);
```
ì´ ì²­í¬ì—ì„œ UAFë¥¼ ì‚¬ìš©í•˜ì—¬ `unsorted_bin_ptr->bk`ë¥¼ `__malloc_hook` ì£¼ì†Œë¡œ ì§€ì •í•©ë‹ˆë‹¤ (ì´ì „ì— ìš°ë¦¬ëŠ” ì´ë¥¼ ë¬´ì°¨ë³„ ëŒ€ì…í–ˆìŠµë‹ˆë‹¤).

{% hint style="danger" %}
ì´ ê³µê²©ì€ unsorted binì„ ì†ìƒì‹œí‚¤ë¯€ë¡œ ì´ì œ **ë¹ ë¥¸ binì—ì„œ í• ë‹¹ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤** (ë” ë³µì¡í•œ í”„ë¡œê·¸ë¨ì€ ë‹¤ë¥¸ í• ë‹¹ì„ ìˆ˜í–‰í•˜ê³  ì¶©ëŒí•  ìˆ˜ ìˆìŒ), ì´ë¥¼ íŠ¸ë¦¬ê±°í•˜ê¸° ìœ„í•´ **ë™ì¼í•œ í¬ê¸°ë¡œ í• ë‹¹í•´ì•¼ í•©ë‹ˆë‹¤.**
{% endhint %}

ë”°ë¼ì„œ, `__malloc_hook`ì„ `unsorted_bin_ptr->bk`ì— ì„¤ì •í•œ í›„ì— `main_arena + 0x68`ì— ì“°ê¸°ë¥¼ íŠ¸ë¦¬ê±°í•˜ê¸° ìœ„í•´ ìš°ë¦¬ëŠ” ë‹¨ìˆœíˆ **`malloc(0x80)`**ì„ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤.

### ë‹¨ê³„ 3: \_\_malloc\_hookì„ ì‹œìŠ¤í…œìœ¼ë¡œ ì„¤ì •

ì²« ë²ˆì§¸ ë‹¨ê³„ì—ì„œ `__malloc_hook`ì„ í¬í•¨í•˜ëŠ” ì²­í¬ë¥¼ ì œì–´í•˜ê²Œ ë˜ì—ˆê³ (ë³€ìˆ˜ `malloc_hook_chunk`), ë‘ ë²ˆì§¸ ë‹¨ê³„ì—ì„œ ì—¬ê¸°ì— `main_arena + 0x68`ì„ ì“¸ ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.

ì´ì œ, `malloc_hook_chunk`ì—ì„œ ë¶€ë¶„ ë®ì–´ì“°ê¸°ë¥¼ ì•…ìš©í•˜ì—¬ ê±°ê¸°ì— ì“´ libc ì£¼ì†Œ(`main_arena + 0x68`)ë¥¼ ì‚¬ìš©í•˜ì—¬ **`one_gadget` ì£¼ì†Œë¥¼ ì§€ì •**í•©ë‹ˆë‹¤.

ì—¬ê¸°ì„œ **12ë¹„íŠ¸ì˜ ë¬´ì‘ìœ„ì„±ì„ ë¬´ì°¨ë³„ ëŒ€ì…í•´ì•¼** í•©ë‹ˆë‹¤([how2heap](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)ì˜ [ì˜ˆì‹œ](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)ì—ì„œ ìì„¸í•œ ì •ë³´ í™•ì¸).

ë§ˆì§€ë§‰ìœ¼ë¡œ, ì˜¬ë°”ë¥¸ ì£¼ì†Œê°€ ë®ì–´ì“°ì—¬ì§€ë©´ **`malloc`ì„ í˜¸ì¶œí•˜ê³  `one_gadget`ì„ íŠ¸ë¦¬ê±°**í•©ë‹ˆë‹¤.

## ì°¸ê³  ìë£Œ

* [https://github.com/shellphish/how2heap](https://github.com/shellphish/how2heap)
* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_roman/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_roman/)
