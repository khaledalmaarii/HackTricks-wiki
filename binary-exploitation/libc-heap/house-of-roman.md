# Romanä¹‹å®¶

{% hint style="success" %}
å­¦ä¹ å¹¶ç»ƒä¹ AWSé»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricksåŸ¹è®­AWSçº¢é˜Ÿä¸“å®¶ï¼ˆARTEï¼‰**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å¹¶ç»ƒä¹ GCPé»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricksåŸ¹è®­GCPçº¢é˜Ÿä¸“å®¶ï¼ˆGRTEï¼‰**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

è¿™æ˜¯ä¸€ç§éå¸¸æœ‰è¶£çš„æŠ€æœ¯ï¼Œé€šè¿‡ä¼ªé€ çš„fastbinsã€unsorted_binæ”»å‡»å’Œç›¸å¯¹è¦†å†™å®ç°RCEè€Œä¸æ³„æ¼ä¿¡æ¯ã€‚ç„¶è€Œï¼Œè¿™å·²ç»è¢«[**ä¿®å¤**](https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=b90ddd08f6dd688e651df9ee89ca3a69ff88cd0c)ã€‚

### ä»£ç 

* æ‚¨å¯ä»¥åœ¨[https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)æ‰¾åˆ°ä¸€ä¸ªç¤ºä¾‹ã€‚

### ç›®æ ‡

* é€šè¿‡æ»¥ç”¨ç›¸å¯¹æŒ‡é’ˆå®ç°RCE

### è¦æ±‚

* ç¼–è¾‘fastbinå’Œunsorted binæŒ‡é’ˆ
* å¿…é¡»æš´åŠ›ç ´è§£12ä½éšæœºæ•°ï¼ˆ0.02%çš„æˆåŠŸå‡ ç‡ï¼‰

## æ”»å‡»æ­¥éª¤

### ç¬¬ä¸€éƒ¨åˆ†ï¼šFastbinå—æŒ‡å‘\_\_malloc\_hook

åˆ›å»ºå‡ ä¸ªå—ï¼š

* `fastbin_victim`ï¼ˆ0x60ï¼Œåç§»0ï¼‰ï¼šç¨åç”¨äºç¼–è¾‘å †æŒ‡é’ˆï¼Œä½¿å…¶æŒ‡å‘LibCå€¼ã€‚
* `chunk2`ï¼ˆ0x80ï¼Œåç§»0x70ï¼‰ï¼šç”¨äºè‰¯å¥½çš„å¯¹é½
* `main_arena_use`ï¼ˆ0x80ï¼Œåç§»0x100ï¼‰
* `relative_offset_heap`ï¼ˆ0x60ï¼Œåç§»0x190ï¼‰ï¼šåœ¨'main\_arena\_use'å—ä¸Šçš„ç›¸å¯¹åç§»

ç„¶åé‡Šæ”¾`main_arena_use`ï¼Œè¿™å°†å°†æ­¤å—æ”¾å…¥æœªæ’åºåˆ—è¡¨ï¼Œå¹¶åœ¨`fd`å’Œ`bk`æŒ‡é’ˆä¸­è·å–æŒ‡å‘`main_arena + 0x68`çš„æŒ‡é’ˆã€‚

ç°åœ¨åˆ†é…ä¸€ä¸ªæ–°çš„å—`fake_libc_chunk(0x60)`ï¼Œå› ä¸ºå®ƒå°†åŒ…å«`fd`å’Œ`bk`ä¸­æŒ‡å‘`main_arena + 0x68`çš„æŒ‡é’ˆã€‚

ç„¶åé‡Šæ”¾`relative_offset_heap`å’Œ`fastbin_victim`ã€‚
```c
/*
Current heap layout:
0x0:   fastbin_victim       - size 0x70
0x70:  alignment_filler     - size 0x90
0x100: fake_libc_chunk      - size 0x70 (contains a fd ptr to main_arena + 0x68)
0x170: leftover_main        - size 0x20
0x190: relative_offset_heap - size 0x70

bin layout:
fastbin:  fastbin_victim -> relative_offset_heap
unsorted: leftover_main
*/
```
* &#x20;`fastbin_victim`æœ‰ä¸€ä¸ª`fd`æŒ‡å‘`relative_offset_heap`
* &#x20;`relative_offset_heap`æ˜¯ä»`fake_libc_chunk`çš„è·ç¦»åç§»é‡ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªæŒ‡å‘`main_arena + 0x68`çš„æŒ‡é’ˆ
* åªéœ€æ›´æ”¹`fastbin_victim.fd`çš„æœ€åä¸€ä¸ªå­—èŠ‚ï¼Œå°±å¯ä»¥ä½¿`fastbin_victim`æŒ‡å‘`main_arena + 0x68`

å¯¹äºå‰é¢çš„æ“ä½œï¼Œæ”»å‡»è€…éœ€è¦èƒ½å¤Ÿä¿®æ”¹`fastbin_victim`çš„`fd`æŒ‡é’ˆã€‚

ç„¶åï¼Œ`main_arena + 0x68`å¹¶ä¸é‚£ä¹ˆæœ‰è¶£ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬ä¿®æ”¹å®ƒï¼Œä½¿æŒ‡é’ˆæŒ‡å‘**`__malloc_hook`**ã€‚

è¯·æ³¨æ„ï¼Œ`__memalign_hook`é€šå¸¸ä»¥`0x7f`å¼€å¤´ï¼Œç„¶åæ˜¯é›¶ï¼Œå› æ­¤å¯ä»¥å°†å…¶ä¼ªè£…æˆ`0x70`å¿«é€Ÿåˆ†é…å—ä¸­çš„ä¸€ä¸ªå€¼ã€‚ç”±äºåœ°å€çš„æœ€å4ä½æ˜¯**éšæœº**çš„ï¼Œæœ‰`2^4=16`ç§å¯èƒ½æ€§ï¼Œä½¿å¾—å€¼æœ€ç»ˆæŒ‡å‘æˆ‘ä»¬æ„Ÿå…´è¶£çš„ä½ç½®ã€‚å› æ­¤ï¼Œåœ¨è¿™é‡Œæ‰§è¡ŒBFæ”»å‡»ï¼Œä½¿å¾—å—æœ€ç»ˆå¦‚ä¸‹ï¼š**`0x70: fastbin_victim -> fake_libc_chunk -> (__malloc_hook - 0x23)`ã€‚**

(æœ‰å…³å…¶ä½™å­—èŠ‚çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹[how2heap](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)ä¸­çš„è§£é‡Šã€‚å¦‚æœBFæ”»å‡»ä¸èµ·ä½œç”¨ï¼Œç¨‹åºå°†å´©æºƒï¼ˆå› æ­¤è¯·é‡æ–°å¼€å§‹ç›´åˆ°æˆåŠŸï¼‰ã€‚

ç„¶åï¼Œæ‰§è¡Œ2æ¬¡mallocä»¥ç§»é™¤å‰ä¸¤ä¸ªåˆå§‹å¿«é€Ÿåˆ†é…å—ï¼Œç„¶ååˆ†é…ç¬¬ä¸‰ä¸ªä»¥è·å¾—ä¸€ä¸ªä½äº**`__malloc_hook:`**çš„å—ã€‚
```c
malloc(0x60);
malloc(0x60);
uint8_t* malloc_hook_chunk = malloc(0x60);
```
### ç¬¬2éƒ¨åˆ†ï¼šæœªæ’åºå—æ”»å‡»

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="unsorted-bin-attack.md" %}
[unsorted-bin-attack.md](unsorted-bin-attack.md)
{% endcontent-ref %}

ä½†åŸºæœ¬ä¸Šå®ƒå…è®¸é€šè¿‡åœ¨`chunk->bk`ä¸­æŒ‡å®šçš„ä½ç½®å†™å…¥`main_arena + 0x68`ã€‚å¯¹äºæ”»å‡»ï¼Œæˆ‘ä»¬é€‰æ‹©`__malloc_hook`ã€‚ç„¶åï¼Œåœ¨è¦†ç›–å®ƒä¹‹åï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ç›¸å¯¹è¦†ç›–æ¥æŒ‡å‘ä¸€ä¸ª`one_gadget`ã€‚

ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¼€å§‹è·å–ä¸€ä¸ªå—å¹¶å°†å…¶æ”¾å…¥**æœªæ’åºå—**ä¸­ï¼š
```c
uint8_t* unsorted_bin_ptr = malloc(0x80);
malloc(0x30); // Don't want to consolidate

puts("Put chunk into unsorted_bin\n");
// Free the chunk to create the UAF
free(unsorted_bin_ptr);
```
åˆ©ç”¨æ­¤å—ä¸­çš„UAFæŒ‡å‘`unsorted_bin_ptr->bk`åˆ°`__malloc_hook`çš„åœ°å€ï¼ˆæˆ‘ä»¬ä¹‹å‰è¿›è¡Œäº†æš´åŠ›ç ´è§£ï¼‰ã€‚

{% hint style="danger" %}
è¯·æ³¨æ„ï¼Œæ­¤æ”»å‡»ä¼šç ´åæœªæ’åºçš„ binï¼ˆå› æ­¤ä¹Ÿä¼šå½±å“ small å’Œ largeï¼‰ã€‚å› æ­¤ï¼Œæˆ‘ä»¬ç°åœ¨åªèƒ½**ä½¿ç”¨æ¥è‡ª fast bin çš„åˆ†é…**ï¼ˆæ›´å¤æ‚çš„ç¨‹åºå¯èƒ½ä¼šè¿›è¡Œå…¶ä»–åˆ†é…å¹¶å´©æºƒï¼‰ï¼Œè¦è§¦å‘æ­¤æ“ä½œï¼Œæˆ‘ä»¬å¿…é¡»**åˆ†é…ç›¸åŒå¤§å°ï¼Œå¦åˆ™ç¨‹åºä¼šå´©æºƒ**ã€‚
{% endhint %}

å› æ­¤ï¼Œè¦è§¦å‘åœ¨ `__malloc_hook` ä¸­æ‰§è¡Œ `main_arena + 0x68` çš„å†™å…¥ï¼Œæˆ‘ä»¬åœ¨å°† `__malloc_hook` è®¾ç½®ä¸º `unsorted_bin_ptr->bk` åï¼Œåªéœ€è¦æ‰§è¡Œï¼š**`malloc(0x80)`**

### æ­¥éª¤ 3ï¼šå°† \_\_malloc\_hook è®¾ç½®ä¸º system

åœ¨ç¬¬ä¸€æ­¥ä¸­ï¼Œæˆ‘ä»¬æ§åˆ¶äº†ä¸€ä¸ªåŒ…å« `__malloc_hook` çš„å—ï¼ˆåœ¨å˜é‡ `malloc_hook_chunk` ä¸­ï¼‰ï¼Œåœ¨ç¬¬äºŒæ­¥ä¸­ï¼Œæˆ‘ä»¬æˆåŠŸå°† `main_arena + 0x68` å†™å…¥å…¶ä¸­ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬åˆ©ç”¨ `malloc_hook_chunk` ä¸­çš„éƒ¨åˆ†è¦†ç›–ï¼Œä½¿ç”¨æˆ‘ä»¬åœ¨é‚£é‡Œå†™å…¥çš„ libc åœ°å€ï¼ˆ`main_arena + 0x68`ï¼‰æ¥**æŒ‡å‘ä¸€ä¸ª `one_gadget` åœ°å€**ã€‚

è¿™å°±æ˜¯éœ€è¦**æš´åŠ›ç ´è§£ 12 ä½éšæœºæ€§**ï¼ˆæ›´å¤šä¿¡æ¯è¯·å‚è€ƒ [how2heap](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c) çš„[ç¤ºä¾‹](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c))ã€‚

æœ€åï¼Œä¸€æ—¦æ­£ç¡®çš„åœ°å€è¢«è¦†ç›–ï¼Œ**è°ƒç”¨ `malloc` å¹¶è§¦å‘ `one_gadget`**ã€‚

## å‚è€ƒèµ„æ–™

* [https://github.com/shellphish/how2heap](https://github.com/shellphish/how2heap)
* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_roman/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_roman/)

{% hint style="success" %}
å­¦ä¹ å¹¶ç»ƒä¹  AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å¹¶ç»ƒä¹  GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã€‚**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
