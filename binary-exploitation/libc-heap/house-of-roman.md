# Dom rzymski

{% hint style="success" %}
Naucz siÄ™ i praktykuj Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Naucz siÄ™ i praktykuj Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **UdostÄ™pnij sztuczki hakerskie, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na githubie.

</details>
{% endhint %}

## Podstawowe informacje

ByÅ‚a to bardzo interesujÄ…ca technika, ktÃ³ra umoÅ¼liwiaÅ‚a RCE bez wyciekÃ³w poprzez faÅ‚szywe fastbiny, atak na unsorted\_bin i wzglÄ™dne nadpisywanie. Jednak zostaÅ‚a [**zaÅ‚atana**](https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=b90ddd08f6dd688e651df9ee89ca3a69ff88cd0c).

### Kod

* MoÅ¼esz znaleÅºÄ‡ przykÅ‚ad w [https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)

### Cel

* RCE poprzez naduÅ¼ycie wzglÄ™dnych wskaÅºnikÃ³w

### Wymagania

* Edytuj wskaÅºniki fastbin i unsorted bin
* NaleÅ¼y brutalnie przeÅ‚amaÄ‡ 12 bitÃ³w losowoÅ›ci (0,02% szansy), aby zadziaÅ‚aÅ‚o

## Kroki ataku

### CzÄ™Å›Ä‡ 1: Fastbin Chunk wskazuje na \_\_malloc\_hook

UtwÃ³rz kilka chunkÃ³w:

* `fastbin_victim` (0x60, przesuniÄ™cie 0): Chunk UAF pÃ³Åºniej do edycji wskaÅºnika sterty, aby wskazywaÅ‚ na wartoÅ›Ä‡ LibC.
* `chunk2` (0x80, przesuniÄ™cie 0x70): Dla dobrego wyrÃ³wnania
* `main_arena_use` (0x80, przesuniÄ™cie 0x100)
* `relative_offset_heap` (0x60, przesuniÄ™cie 0x190): wzglÄ™dne przesuniÄ™cie na chunku 'main\_arena\_use'

NastÄ™pnie `zwolnij(main_arena_use)`, co umieÅ›ci ten chunk na liÅ›cie unsorted i otrzymasz wskaÅºnik do `main_arena + 0x68` zarÃ³wno w wskaÅºnikach `fd`, jak i `bk`.

Teraz alokowany jest nowy chunk `fake_libc_chunk(0x60)`, poniewaÅ¼ bÄ™dzie zawieraÅ‚ wskaÅºniki do `main_arena + 0x68` w `fd` i `bk`.

NastÄ™pnie zwolnij `relative_offset_heap` i `fastbin_victim`.
```c
/*
Current heap layout:
0x0:   fastbin_victim       - size 0x70
0x70:  alignment_filler     - size 0x90
0x100: fake_libc_chunk      - size 0x70 (contains a fd ptr to main_arena + 0x68)
0x170: leftover_main        - size 0x20
0x190: relative_offset_heap - size 0x70

bin layout:
fastbin:  fastbin_victim -> relative_offset_heap
unsorted: leftover_main
*/
```
* &#x20;`fastbin_victim` ma `fd` wskazujÄ…cy na `relative_offset_heap`
* &#x20;`relative_offset_heap` to przesuniÄ™cie odlegÅ‚oÅ›ci od `fake_libc_chunk`, ktÃ³ry zawiera wskaÅºnik do `main_arena + 0x68`
* ZmieniajÄ…c ostatni bajt `fastbin_victim.fd`, moÅ¼na sprawiÄ‡, Å¼e `fastbin_victim wskazuje` na `main_arena + 0x68`

Dla powyÅ¼szych dziaÅ‚aÅ„ atakujÄ…cy musi byÄ‡ w stanie modyfikowaÄ‡ wskaÅºnik fd `fastbin_victim`.

NastÄ™pnie, `main_arena + 0x68` nie jest tak interesujÄ…ce, wiÄ™c zmodyfikujmy go tak, aby wskaÅºnik wskazywaÅ‚ na **`__malloc_hook`**.

ZauwaÅ¼, Å¼e `__memalign_hook` zazwyczaj zaczyna siÄ™ od `0x7f` i zer przed nim, wiÄ™c moÅ¼na to sfaÅ‚szowaÄ‡ jako wartoÅ›Ä‡ w fast binie `0x70`. PoniewaÅ¼ ostatnie 4 bity adresu sÄ… **losowe**, istnieje `2^4=16` moÅ¼liwoÅ›ci, aby wartoÅ›Ä‡ wskazywaÅ‚a tam, gdzie jesteÅ›my zainteresowani. Dlatego tutaj wykonywany jest atak BF, aby kawaÅ‚ek koÅ„czyÅ‚ siÄ™ tak: **`0x70: fastbin_victim -> fake_libc_chunk -> (__malloc_hook - 0x23)`.**

(Dla wiÄ™cej informacji na temat pozostaÅ‚ych bajtÃ³w sprawdÅº wyjaÅ›nienie w [how2heap](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)[ przykÅ‚adzie](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)). JeÅ›li atak BF nie zadziaÅ‚a, program po prostu siÄ™ zawiesi (wiÄ™c zacznij ponownie, aÅ¼ zadziaÅ‚a).

NastÄ™pnie wykonywane sÄ… 2 alokacje pamiÄ™ci, aby usunÄ…Ä‡ 2 poczÄ…tkowe kawaÅ‚ki fast binÃ³w, a trzecia jest alokowana, aby uzyskaÄ‡ kawaÅ‚ek w **`__malloc_hook:`**
```c
malloc(0x60);
malloc(0x60);
uint8_t* malloc_hook_chunk = malloc(0x60);
```
### CzÄ™Å›Ä‡ 2: Atak na unsorted\_bin

WiÄ™cej informacji moÅ¼na znaleÅºÄ‡ tutaj:

{% content-ref url="unsorted-bin-attack.md" %}
[unsorted-bin-attack.md](unsorted-bin-attack.md)
{% endcontent-ref %}

Ale w skrÃ³cie pozwala to na zapisanie `main_arena + 0x68` w dowolnym miejscu okreÅ›lonym przez `chunk->bk`. A dla ataku wybieramy `__malloc_hook`. NastÄ™pnie, po nadpisaniu go, uÅ¼yjemy wzglÄ™dnego nadpisania, aby wskazaÄ‡ na `one_gadget`.

Aby to osiÄ…gnÄ…Ä‡, zaczynamy od uzyskania fragmentu i umieszczenia go w **unsorted bin**:
```c
uint8_t* unsorted_bin_ptr = malloc(0x80);
malloc(0x30); // Don't want to consolidate

puts("Put chunk into unsorted_bin\n");
// Free the chunk to create the UAF
free(unsorted_bin_ptr);
```
Wykorzystaj UAF w tym fragmencie, aby wskazaÄ‡ `unsorted_bin_ptr->bk` na adres `__malloc_hook` (wczeÅ›niej juÅ¼ to brutalnie obliczyliÅ›my).

{% hint style="danger" %}
ZauwaÅ¼, Å¼e ten atak narusza nieuporzÄ…dkowany blok (stÄ…d teÅ¼ maÅ‚y i duÅ¼y). Dlatego teraz moÅ¼emy **korzystaÄ‡ tylko z alokacji z szybkiego bloku** (bardziej zÅ‚oÅ¼ony program moÅ¼e wykonywaÄ‡ inne alokacje i siÄ™ zawiesiÄ‡), aby wywoÅ‚aÄ‡ to musimy **zaalokowaÄ‡ takÄ… samÄ… wielkoÅ›Ä‡, inaczej program siÄ™ zawiesi.**
{% endhint %}

WiÄ™c, aby wywoÅ‚aÄ‡ zapis `main_arena + 0x68` w `__malloc_hook`, po ustawieniu `__malloc_hook` w `unsorted_bin_ptr->bk`, musimy po prostu wykonaÄ‡: **`malloc(0x80)`**

### Krok 3: Ustawienie \_\_malloc\_hook na system

W kroku pierwszym kontrolowaliÅ›my kawaÅ‚ek zawierajÄ…cy `__malloc_hook` (w zmiennej `malloc_hook_chunk`) i w drugim kroku udaÅ‚o nam siÄ™ zapisaÄ‡ `main_arena + 0x68` tutaj.

Teraz wykorzystujemy czÄ™Å›ciowe nadpisanie w `malloc_hook_chunk`, aby uÅ¼yÄ‡ adresu libc, ktÃ³ry tam zapisaliÅ›my (`main_arena + 0x68`) do **wskazania adresu `one_gadget`**.

Tutaj konieczne jest **bruteforce'owanie 12 bitÃ³w losowoÅ›ci** (wiÄ™cej informacji w [how2heap](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)[ przykÅ‚adzie](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)).

Wreszcie, gdy poprawny adres zostanie nadpisany, **wywoÅ‚aj `malloc` i wywoÅ‚aj `one_gadget`**.

## Referencje

* [https://github.com/shellphish/how2heap](https://github.com/shellphish/how2heap)
* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_roman/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_roman/)

{% hint style="success" %}
Dowiedz siÄ™ i Ä‡wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Dowiedz siÄ™ i Ä‡wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel siÄ™ trikami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na githubie.

</details>
{% endhint %}
