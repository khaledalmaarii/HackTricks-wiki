# House of Roman

{% hint style="success" %}
AWS Hacking'Ä± Ã¶ÄŸrenin ve uygulayÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'ini Ã¶ÄŸrenin ve uygulayÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katÄ±lÄ±n veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ± paylaÅŸarak PR'ler gÃ¶ndererek HackTricks ve HackTricks Cloud github depolarÄ±na katkÄ±da bulunun.**

</details>
{% endhint %}

## Temel Bilgiler

Bu, sÄ±zÄ±ntÄ±sÄ±z RCE'ye olanak tanÄ±yan, sahte fastbins, sÄ±ralanmamÄ±ÅŸ\_bin saldÄ±rÄ±sÄ± ve gÃ¶receli Ã¼zerine yazma ile RCE saÄŸlayan Ã§ok ilginÃ§ bir teknikti. Ancak [**yamalandÄ±**](https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=b90ddd08f6dd688e651df9ee89ca3a69ff88cd0c).

### Kod

* Ã–rneÄŸi [https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c) adresinde bulabilirsiniz.

### AmaÃ§

* GÃ¶receli iÅŸaretÃ§ileri kÃ¶tÃ¼ye kullanarak RCE

### Gereksinimler

* Fastbin ve sÄ±ralanmamÄ±ÅŸ bin iÅŸaretÃ§ilerini dÃ¼zenleme
* 12 bitlik rastgelelik zorunlu olarak kaba kuvvet uygulanmalÄ±dÄ±r (%0.02 ÅŸansÄ± Ã§alÄ±ÅŸma)

## SaldÄ±rÄ± AdÄ±mlarÄ±

### AdÄ±m 1: Fastbin Chunk, \_\_malloc\_hook'a iÅŸaret eder

BirkaÃ§ parÃ§a oluÅŸturun:

* `fastbin_victim` (0x60, ofset 0): Daha sonra yÄ±ÄŸÄ±n iÅŸaretÃ§isini LibC deÄŸerine iÅŸaret etmek Ã¼zere dÃ¼zenlenecek UAF parÃ§asÄ±.
* `chunk2` (0x80, ofset 0x70): Ä°yi hizalamak iÃ§in
* `main_arena_use` (0x80, ofset 0x100)
* `relative_offset_heap` (0x60, ofset 0x190): 'main\_arena\_use' parÃ§asÄ±ndaki gÃ¶receli ofset

ArdÄ±ndan `main_arena_use` serbest bÄ±rakÄ±lÄ±r, bu parÃ§ayÄ± sÄ±ralanmamÄ±ÅŸ listeye yerleÅŸtirir ve hem `fd` hem de `bk` iÅŸaretÃ§ilerinde `main_arena + 0x68`'e bir iÅŸaretÃ§i alÄ±r.

Åimdi `fd` ve `bk` iÅŸaretÃ§ilerinde `main_arena + 0x68`'e iÅŸaretÃ§iler iÃ§ereceÄŸi iÃ§in yeni bir parÃ§a olan `fake_libc_chunk(0x60)` ayrÄ±lmÄ±ÅŸtÄ±r.

ArdÄ±ndan `relative_offset_heap` ve `fastbin_victim` serbest bÄ±rakÄ±lÄ±r.
```c
/*
Current heap layout:
0x0:   fastbin_victim       - size 0x70
0x70:  alignment_filler     - size 0x90
0x100: fake_libc_chunk      - size 0x70 (contains a fd ptr to main_arena + 0x68)
0x170: leftover_main        - size 0x20
0x190: relative_offset_heap - size 0x70

bin layout:
fastbin:  fastbin_victim -> relative_offset_heap
unsorted: leftover_main
*/
```
* `fastbin_victim` adlÄ± bir `fd`, `relative_offset_heap`'e iÅŸaret ediyor
* `relative_offset_heap`, `fake_libc_chunk`'tan uzaklÄ±k olarak bir ofsete sahiptir ve bu da `main_arena + 0x68`'i iÅŸaret eden bir iÅŸaretÃ§i iÃ§erir
* `fastbin_victim.fd`'nin son baytÄ±nÄ± deÄŸiÅŸtirerek `fastbin_victim`'Ä± `main_arena + 0x68`'i iÅŸaret edecek ÅŸekilde yapmak mÃ¼mkÃ¼ndÃ¼r

Ã–nceki eylemler iÃ§in saldÄ±rganÄ±n, `fastbin_victim`'Ä±n `fd` iÅŸaretÃ§isini deÄŸiÅŸtirebilme yeteneÄŸine sahip olmasÄ± gerekir.

ArdÄ±ndan, `main_arena + 0x68` Ã§ok ilginÃ§ deÄŸildir, bu yÃ¼zden iÅŸaretÃ§inin **`__malloc_hook`**'u iÅŸaret etmesini saÄŸlayacak ÅŸekilde deÄŸiÅŸtirelim.

`__memalign_hook` genellikle `0x7f` ile baÅŸlar ve ondan Ã¶nce sÄ±fÄ±rlar bulunur, bu nedenle `0x70` hÄ±zlÄ± binde bir deÄŸer olarak sahteleyebilir. Ã‡Ã¼nkÃ¼ adresin son 4 biti **rastgele** olduÄŸundan, adresin istediÄŸimiz yere iÅŸaret etmesi iÃ§in `2^4=16` olasÄ±lÄ±k vardÄ±r. Bu nedenle, bir BF saldÄ±rÄ±sÄ± burada gerÃ§ekleÅŸtirilir, bÃ¶ylece parÃ§a ÅŸu ÅŸekilde sonlanÄ±r: **`0x70: fastbin_victim -> fake_libc_chunk -> (__malloc_hook - 0x23)`.**

(Geri kalan baytlar hakkÄ±nda daha fazla bilgi iÃ§in [how2heap](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c) Ã¶rneÄŸindeki aÃ§Ä±klamaya bakÄ±n). BF Ã§alÄ±ÅŸmazsa program Ã§Ã¶ker (bu yÃ¼zden Ã§alÄ±ÅŸana kadar tekrar baÅŸlayÄ±n).

ArdÄ±ndan, 2 malloc iÅŸlemi gerÃ§ekleÅŸtirilir ve 2 baÅŸlangÄ±Ã§ â€‹â€‹hÄ±zlÄ± bin parÃ§asÄ± kaldÄ±rÄ±lÄ±r ve Ã¼Ã§Ã¼ncÃ¼sÃ¼, bir parÃ§ayÄ± **`__malloc_hook:`**'ta almak iÃ§in ayrÄ±lÄ±r.
```c
malloc(0x60);
malloc(0x60);
uint8_t* malloc_hook_chunk = malloc(0x60);
```
### BÃ¶lÃ¼m 2: SÄ±ralanmamÄ±ÅŸ\_bin saldÄ±rÄ±sÄ±

Daha fazla bilgi iÃ§in ÅŸu adrese bakabilirsiniz:

{% content-ref url="unsorted-bin-attack.md" %}
[unsorted-bin-attack.md](unsorted-bin-attack.md)
{% endcontent-ref %}

Ancak temelde, `chunk->bk` iÃ§inde belirtilen konuma `main_arena + 0x68` yazmamÄ±zÄ± saÄŸlar. SaldÄ±rÄ± iÃ§in `__malloc_hook`'u seÃ§iyoruz. Sonra, Ã¼zerine yazdÄ±ktan sonra bir `one_gadget`'a iÅŸaret etmek iÃ§in bir gÃ¶receli yazma iÅŸlemi kullanacaÄŸÄ±z.

Bunun iÃ§in bir parÃ§a alÄ±p onu **sÄ±ralanmamÄ±ÅŸ bin**'e koyarak baÅŸlarÄ±z:
```c
uint8_t* unsorted_bin_ptr = malloc(0x80);
malloc(0x30); // Don't want to consolidate

puts("Put chunk into unsorted_bin\n");
// Free the chunk to create the UAF
free(unsorted_bin_ptr);
```
Bu parÃ§ada bir UAF kullanarak `unsorted_bin_ptr->bk`'yi `__malloc_hook` adresine iÅŸaret etmek iÃ§in kullanÄ±yoruz (bu daha Ã¶nce brute force ile yapÄ±ldÄ±).

{% hint style="danger" %}
Bu saldÄ±rÄ±, unsorted bin'i bozar (bu nedenle kÃ¼Ã§Ã¼k ve bÃ¼yÃ¼k de). Bu nedenle ÅŸimdi sadece **hÄ±zlÄ± binlerden tahsisleri kullanabiliriz** (daha karmaÅŸÄ±k bir program baÅŸka tahsisler yapabilir ve Ã§Ã¶kebilir), bunu tetiklemek iÃ§in **aynÄ± boyutta tahsis yapmalÄ±yÄ±z ya da program Ã§Ã¶ker.**
{% endhint %}

Bu nedenle, `__malloc_hook`'u `unsorted_bin_ptr->bk`'ye ayarladÄ±ktan sonra `main_arena + 0x68`'e yazmayÄ± tetiklemek iÃ§in sadece **`malloc(0x80)`** yapmamÄ±z gerekiyor.

### AdÄ±m 3: \_\_malloc\_hook'u system'e ayarlayÄ±n

AdÄ±m birde `__malloc_hook` iÃ§eren bir parÃ§ayÄ± kontrol etmeyi bitirdik (deÄŸiÅŸken `malloc_hook_chunk` iÃ§inde) ve ikinci adÄ±mda buraya `main_arena + 0x68` yazmayÄ± baÅŸardÄ±k.

Åimdi, `malloc_hook_chunk` iÃ§indeki kÄ±smi bir yazmayÄ± kÃ¶tÃ¼ye kullanarak oraya yazdÄ±ÄŸÄ±mÄ±z libc adresini (`main_arena + 0x68`) kullanarak bir `one_gadget` adresine iÅŸaret etmek iÃ§in.

Ä°ÅŸte burada **12 bitlik rastgeleliÄŸi brute force etmek gerekiyor** (daha fazla bilgi iÃ§in [how2heap](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c) [Ã¶rneÄŸine](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c) bakÄ±n).

Son olarak, doÄŸru adres Ã¼zerine yazÄ±ldÄ±ÄŸÄ±nda, **`malloc`'Ä± Ã§aÄŸÄ±rÄ±n ve `one_gadget`'Ä± tetikleyin**.

## Referanslar

* [https://github.com/shellphish/how2heap](https://github.com/shellphish/how2heap)
* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_roman/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_roman/)

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve uygulayÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks EÄŸitimi AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve uygulayÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks EÄŸitimi GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [Discord grubuna](https://discord.gg/hRep4RUj7f) veya [telegram grubuna](https://t.me/peass) katÄ±lÄ±n veya** bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ± paylaÅŸarak HackTricks ve HackTricks Cloud github depolarÄ±na PR gÃ¶nderin.**

</details>
{% endhint %}
