# Romanä¹‹å®¶

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWSçº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨**Twitter**ä¸Šå…³æ³¨æˆ‘ä»¬ ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## åŸºæœ¬ä¿¡æ¯

è¿™æ˜¯ä¸€ç§éå¸¸æœ‰è¶£çš„æŠ€æœ¯ï¼Œé€šè¿‡ä¼ªé€ fastbinsã€unsorted_binæ”»å‡»å’Œç›¸å¯¹è¦†å†™å®ç°RCEè€Œæ— éœ€æ³„æ¼ã€‚ç„¶è€Œï¼Œè¿™å·²ç»è¢«[**ä¿®è¡¥**](https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=b90ddd08f6dd688e651df9ee89ca3a69ff88cd0c)ã€‚

### ä»£ç 

* æ‚¨å¯ä»¥åœ¨[https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)æ‰¾åˆ°ä¸€ä¸ªç¤ºä¾‹ã€‚

### ç›®æ ‡

* é€šè¿‡æ»¥ç”¨ç›¸å¯¹æŒ‡é’ˆå®ç°RCE

### è¦æ±‚

* ç¼–è¾‘fastbinå’Œunsorted binæŒ‡é’ˆ
* å¿…é¡»æš´åŠ›ç ´è§£12ä½éšæœºæ•°ï¼ˆæˆåŠŸå‡ ç‡ä¸º0.02%ï¼‰

## æ”»å‡»æ­¥éª¤

### ç¬¬ä¸€éƒ¨åˆ†ï¼šFastbinå—æŒ‡å‘\_\_malloc\_hook

åˆ›å»ºå‡ ä¸ªå—ï¼š

* `fastbin_victim`ï¼ˆ0x60ï¼Œåç§»0ï¼‰ï¼šç¨åç”¨äºç¼–è¾‘å †æŒ‡é’ˆï¼Œä½¿å…¶æŒ‡å‘LibCå€¼ã€‚
* `chunk2`ï¼ˆ0x80ï¼Œåç§»0x70ï¼‰ï¼šç”¨äºè‰¯å¥½çš„å¯¹é½
* `main_arena_use`ï¼ˆ0x80ï¼Œåç§»0x100ï¼‰
* `relative_offset_heap`ï¼ˆ0x60ï¼Œåç§»0x190ï¼‰ï¼šåœ¨'main\_arena\_use'å—ä¸Šçš„ç›¸å¯¹åç§»

ç„¶åé‡Šæ”¾`main_arena_use`ï¼Œè¿™å°†å°†æ­¤å—æ”¾å…¥æœªæ’åºåˆ—è¡¨ï¼Œå¹¶åœ¨`fd`å’Œ`bk`æŒ‡é’ˆä¸­è·å–æŒ‡å‘`main_arena + 0x68`çš„æŒ‡é’ˆã€‚

ç°åœ¨åˆ†é…ä¸€ä¸ªæ–°çš„å—`fake_libc_chunk(0x60)`ï¼Œå› ä¸ºå®ƒå°†åŒ…å«`fd`å’Œ`bk`ä¸­æŒ‡å‘`main_arena + 0x68`çš„æŒ‡é’ˆã€‚

ç„¶åé‡Šæ”¾`relative_offset_heap`å’Œ`fastbin_victim`ã€‚
```c
/*
Current heap layout:
0x0:   fastbin_victim       - size 0x70
0x70:  alignment_filler     - size 0x90
0x100: fake_libc_chunk      - size 0x70 (contains a fd ptr to main_arena + 0x68)
0x170: leftover_main        - size 0x20
0x190: relative_offset_heap - size 0x70

bin layout:
fastbin:  fastbin_victim -> relative_offset_heap
unsorted: leftover_main
*/
```
* &#x20;`fastbin_victim`æœ‰ä¸€ä¸ª`fd`æŒ‡å‘`relative_offset_heap`
* &#x20;`relative_offset_heap`æ˜¯ä»`fake_libc_chunk`çš„è·ç¦»åç§»é‡ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªæŒ‡å‘`main_arena + 0x68`çš„æŒ‡é’ˆ
* åªéœ€æ›´æ”¹`fastbin_victim.fd`çš„æœ€åä¸€ä¸ªå­—èŠ‚ï¼Œå°±å¯ä»¥ä½¿`fastbin_victim`æŒ‡å‘`main_arena + 0x68`

å¯¹äºå‰é¢çš„æ“ä½œï¼Œæ”»å‡»è€…éœ€è¦èƒ½å¤Ÿä¿®æ”¹`fastbin_victim`çš„`fd`æŒ‡é’ˆã€‚

ç„¶åï¼Œ`main_arena + 0x68`å¹¶ä¸é‚£ä¹ˆæœ‰è¶£ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬ä¿®æ”¹å®ƒï¼Œä½¿æŒ‡é’ˆæŒ‡å‘**`__malloc_hook`**ã€‚

è¯·æ³¨æ„ï¼Œ`__memalign_hook`é€šå¸¸ä»¥`0x7f`å¼€å¤´ï¼Œç„¶åæ˜¯é›¶ï¼Œå› æ­¤å¯ä»¥å°†å…¶ä¼ªè£…æˆ`0x70`å¿«é€Ÿåˆ†é…å—ä¸­çš„ä¸€ä¸ªå€¼ã€‚ç”±äºåœ°å€çš„æœ€å4ä½æ˜¯**éšæœº**çš„ï¼Œå› æ­¤æœ‰`2^4=16`ç§å¯èƒ½æ€§ï¼Œä½¿å¾—å€¼æœ€ç»ˆæŒ‡å‘æˆ‘ä»¬æ„Ÿå…´è¶£çš„ä½ç½®ã€‚å› æ­¤ï¼Œåœ¨è¿™é‡Œæ‰§è¡ŒBFæ”»å‡»ï¼Œä½¿å¾—å—æœ€ç»ˆå¦‚ä¸‹ï¼š**`0x70: fastbin_victim -> fake_libc_chunk -> (__malloc_hook - 0x23)`ã€‚**

(æœ‰å…³å…¶ä½™å­—èŠ‚çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹[how2heap](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)ä¸­çš„è§£é‡Š[ç¤ºä¾‹](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)ã€‚å¦‚æœBFæ”»å‡»ä¸èµ·ä½œç”¨ï¼Œç¨‹åºå°†å´©æºƒï¼ˆå› æ­¤è¯·é‡è¯•ç›´åˆ°æˆåŠŸï¼‰ã€‚

ç„¶åï¼Œæ‰§è¡Œ2æ¬¡mallocä»¥ç§»é™¤å‰ä¸¤ä¸ªå¿«é€Ÿåˆ†é…å—ï¼Œå¹¶åˆ†é…ç¬¬ä¸‰ä¸ªä»¥è·å¾—ä¸€ä¸ªä½äº**`__malloc_hook:`**çš„å—ã€‚
```c
malloc(0x60);
malloc(0x60);
uint8_t* malloc_hook_chunk = malloc(0x60);
```
### ç¬¬äºŒéƒ¨åˆ†ï¼šUnsorted\_bin æ”»å‡»

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="unsorted-bin-attack.md" %}
[unsorted-bin-attack.md](unsorted-bin-attack.md)
{% endcontent-ref %}

ä½†åŸºæœ¬ä¸Šå®ƒå…è®¸é€šè¿‡åœ¨ `chunk->bk` ä¸­æŒ‡å®šçš„ä½ç½®å†™å…¥ `main_arena + 0x68` åˆ°ä»»ä½•ä½ç½®ã€‚å¯¹äºæ”»å‡»ï¼Œæˆ‘ä»¬é€‰æ‹© `__malloc_hook`ã€‚ç„¶åï¼Œåœ¨è¦†ç›–å®ƒä¹‹åï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ç›¸å¯¹è¦†ç›–æ¥æŒ‡å‘ä¸€ä¸ª `one_gadget`ã€‚

ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¼€å§‹è·å–ä¸€ä¸ªå—å¹¶å°†å…¶æ”¾å…¥**æœªæ’åºçš„ bin**ä¸­ï¼š
```c
uint8_t* unsorted_bin_ptr = malloc(0x80);
malloc(0x30); // Don't want to consolidate

puts("Put chunk into unsorted_bin\n");
// Free the chunk to create the UAF
free(unsorted_bin_ptr);
```
åˆ©ç”¨è¿™ä¸ª UAF æ¼æ´ï¼Œå°† `unsorted_bin_ptr->bk` æŒ‡å‘ `__malloc_hook` çš„åœ°å€ï¼ˆæˆ‘ä»¬ä¹‹å‰è¿›è¡Œäº†æš´åŠ›ç ´è§£ï¼‰ã€‚

{% hint style="danger" %}
è¯·æ³¨æ„ï¼Œæ­¤æ”»å‡»ä¼šç ´åæœªæ’åºçš„ binï¼ˆå› æ­¤ä¹Ÿä¼šå½±å“åˆ° small å’Œ largeï¼‰ã€‚å› æ­¤ï¼Œæˆ‘ä»¬ç°åœ¨åªèƒ½**ä½¿ç”¨æ¥è‡ª fast bin çš„åˆ†é…**ï¼ˆæ›´å¤æ‚çš„ç¨‹åºå¯èƒ½ä¼šè¿›è¡Œå…¶ä»–åˆ†é…å¹¶å¯¼è‡´å´©æºƒï¼‰ï¼Œä¸ºäº†è§¦å‘æ­¤æ”»å‡»ï¼Œæˆ‘ä»¬å¿…é¡»**åˆ†é…ç›¸åŒå¤§å°çš„å†…å­˜ï¼Œå¦åˆ™ç¨‹åºä¼šå´©æºƒã€‚**
{% endhint %}

å› æ­¤ï¼Œè¦è§¦å‘å¯¹ `__malloc_hook` ä¸­ `main_arena + 0x68` çš„å†™å…¥ï¼Œæˆ‘ä»¬åªéœ€æ‰§è¡Œï¼š**`malloc(0x80)`**

### æ­¥éª¤ 3ï¼šå°† \_\_malloc\_hook è®¾ç½®ä¸º system

åœ¨ç¬¬ä¸€æ­¥ä¸­ï¼Œæˆ‘ä»¬æˆåŠŸæ§åˆ¶äº†ä¸€ä¸ªåŒ…å« `__malloc_hook` çš„å—ï¼ˆåœ¨å˜é‡ `malloc_hook_chunk` ä¸­ï¼‰ï¼Œåœ¨ç¬¬äºŒæ­¥ä¸­ï¼Œæˆ‘ä»¬æˆåŠŸå°† `main_arena + 0x68` å†™å…¥å…¶ä¸­ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬åˆ©ç”¨ `malloc_hook_chunk` ä¸­çš„éƒ¨åˆ†è¦†å†™ï¼Œä½¿ç”¨æˆ‘ä»¬åœ¨é‚£é‡Œå†™å…¥çš„ libc åœ°å€ï¼ˆ`main_arena + 0x68`ï¼‰æ¥**æŒ‡å‘ä¸€ä¸ª `one_gadget` åœ°å€**ã€‚

è¿™å°±æ˜¯éœ€è¦**æš´åŠ›ç ´è§£ 12 ä½éšæœºæ€§**çš„åœ°æ–¹ï¼ˆæ›´å¤šä¿¡æ¯è¯·å‚è€ƒ [how2heap](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c) çš„[ç¤ºä¾‹](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c))ã€‚

æœ€åï¼Œä¸€æ—¦æ­£ç¡®çš„åœ°å€è¢«è¦†å†™ï¼Œ**è°ƒç”¨ `malloc` å¹¶è§¦å‘ `one_gadget`**ã€‚

## å‚è€ƒèµ„æ–™

* [https://github.com/shellphish/how2heap](https://github.com/shellphish/how2heap)
* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_roman/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_roman/)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS çº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½ PDF ç‰ˆæœ¬çš„ HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
