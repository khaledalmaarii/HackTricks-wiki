# Ataque ao Large Bin

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

## Informa√ß√£o B√°sica

Para mais informa√ß√µes sobre o que √© um large bin, consulte esta p√°gina:

{% content-ref url="bins-and-memory-allocations.md" %}
[bins-and-memory-allocations.md](bins-and-memory-allocations.md)
{% endcontent-ref %}

√â poss√≠vel encontrar um √≥timo exemplo em [**how2heap - large bin attack**](https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/large\_bin\_attack.c).

Basicamente aqui voc√™ pode ver como, na √∫ltima vers√£o "atual" do glibc (2.35), n√£o √© verificado: **`P->bk_nextsize`** permitindo modificar um endere√ßo arbitr√°rio com o valor de um peda√ßo de large bin se certas condi√ß√µes forem atendidas.

Nesse exemplo, voc√™ pode encontrar as seguintes condi√ß√µes:

* Um grande peda√ßo √© alocado
* Um grande peda√ßo menor que o primeiro, mas no mesmo √≠ndice, √© alocado
* Deve ser menor para que no bin ele v√° primeiro
* (Um peda√ßo para evitar a fus√£o com o peda√ßo superior √© criado)
* Em seguida, o primeiro grande peda√ßo √© liberado e um novo peda√ßo maior do que ele √© alocado -> Chunk1 vai para o large bin
* Em seguida, o segundo grande peda√ßo √© liberado
* Agora, a vulnerabilidade: O atacante pode modificar `chunk1->bk_nextsize` para `[target-0x20]`
* Em seguida, um peda√ßo maior que o peda√ßo 2 √© alocado, ent√£o o peda√ßo 2 √© inserido no large bin sobrescrevendo o endere√ßo `chunk1->bk_nextsize->fd_nextsize` com o endere√ßo do peda√ßo 2

{% hint style="success" %}
Existem outros cen√°rios potenciais, a ideia √© adicionar ao large bin um peda√ßo que seja **menor** do que um peda√ßo X atual no bin, ent√£o ele precisa ser inserido logo antes dele no bin, e precisamos ser capazes de modificar o **`bk_nextsize`** do X, pois √© onde o endere√ßo do peda√ßo menor ser√° escrito.
{% endhint %}

Este √© o c√≥digo relevante do malloc. Coment√°rios foram adicionados para entender melhor como o endere√ßo foi sobrescrito:

{% code overflow="wrap" %}
```c
/* if smaller than smallest, bypass loop below */
assert (chunk_main_arena (bck->bk));
if ((unsigned long) (size) < (unsigned long) chunksize_nomask (bck->bk))
{
fwd = bck; // fwd = p1
bck = bck->bk; // bck = p1->bk

victim->fd_nextsize = fwd->fd; // p2->fd_nextsize = p1->fd (Note that p1->fd is p1 as it's the only chunk)
victim->bk_nextsize = fwd->fd->bk_nextsize; // p2->bk_nextsize = p1->fd->bk_nextsize
fwd->fd->bk_nextsize = victim->bk_nextsize->fd_nextsize = victim; // p1->fd->bk_nextsize->fd_nextsize = p2
}
```
{% endcode %}

Isso poderia ser usado para **sobrescrever a vari√°vel global `global_max_fast`** da libc para ent√£o explorar um ataque de fast bin com chunks maiores.

Voc√™ pode encontrar outra √≥tima explica√ß√£o desse ataque em [**guyinatuxedo**](https://guyinatuxedo.github.io/32-largebin\_attack/largebin\_explanation0/index.html).

### Outros exemplos

* [**La casa de papel. HackOn CTF 2024**](https://7rocky.github.io/en/ctf/other/hackon-ctf/la-casa-de-papel/)
* Ataque de large bin na mesma situa√ß√£o conforme aparece em [**how2heap**](https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/large\_bin\_attack.c).
* A primitiva de escrita √© mais complexa, porque `global_max_fast` √© in√∫til aqui.
* FSOP √© necess√°rio para concluir o exploit.

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
