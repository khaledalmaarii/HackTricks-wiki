# Off by one overflow

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWSçº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

å…¶ä»–æ”¯æŒHackTricksçš„æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## åŸºæœ¬ä¿¡æ¯

ä»…å…·æœ‰å¯¹1Bæº¢å‡ºçš„è®¿é—®æƒé™å°±å…è®¸æ”»å‡»è€…ä¿®æ”¹ä¸‹ä¸€ä¸ªå—çš„`pre_in_use`ä½ï¼Œç”±äºå½“å‰å—ä¸åœ¨ä½¿ç”¨ä¸­ï¼Œå—çš„æœ«å°¾æˆä¸ºäº†å‰ä¸€ä¸ªå—å¤§å°çš„å…ƒæ•°æ®ä¿¡æ¯ã€‚\
è¿™å…è®¸ç¯¡æ”¹å®é™…ä¸Šè¢«é‡Šæ”¾çš„å—ï¼Œå¯èƒ½ç”ŸæˆåŒ…å«å¦ä¸€ä¸ªåˆæ³•å—çš„å—ã€‚

æœ‰ä¸¤ç§ç±»å‹çš„off by oneæ¼æ´ï¼š

* ä»»æ„å­—èŠ‚ï¼šè¿™ç§ç±»å‹å…è®¸ç”¨ä»»ä½•å€¼è¦†ç›–è¯¥å­—èŠ‚
* ç©ºå­—èŠ‚åç§»ï¼šè¿™ç§ç±»å‹åªå…è®¸ç”¨0x00è¦†ç›–è¯¥å­—èŠ‚
* è¿™ç§æ¼æ´çš„ä¸€ä¸ªå¸¸è§ç¤ºä¾‹å¯ä»¥åœ¨ä»¥ä¸‹ä»£ç ä¸­çœ‹åˆ°ï¼Œå…¶ä¸­strlenå’Œstrcpyçš„è¡Œä¸ºä¸ä¸€è‡´ï¼Œè¿™å…è®¸åœ¨ä¸‹ä¸€ä¸ªå—çš„å¼€å¤´è®¾ç½®ä¸€ä¸ª0x00å­—èŠ‚ã€‚

<details>

<summary>ç©ºå­—èŠ‚åç§»</summary>
```c
// From https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/off_by_one/
int main(void)
{
char buffer[40]="";
void *chunk1;
chunk1 = malloc(24);
puts("Get Input");
gets(buffer);
if(strlen(buffer)==24)
{
strcpy(chunk1,buffer);
}
return 0;
}
```
</details>

### æ¼æ´åˆ©ç”¨

* é‡Šæ”¾ä¸€ä¸ªå—æ—¶ï¼Œä¼šå°†å‰ä¸€ä¸ªå¤§å°ä¸å…ƒæ•°æ®å—ä¸­é…ç½®çš„å¤§å°è¿›è¡Œæ¯”è¾ƒï¼Œä»2.28ç‰ˆæœ¬å¼€å§‹ï¼Œè¿™ç§æ”»å‡»å˜å¾—ç›¸å½“å¤æ‚ã€‚

### ä»£ç ç¤ºä¾‹:

* [https://github.com/DhavalKapil/heap-exploitation/blob/d778318b6a14edad18b20421f5a06fa1a6e6920e/assets/files/shrinking\_free\_chunks.c](https://github.com/DhavalKapil/heap-exploitation/blob/d778318b6a14edad18b20421f5a06fa1a6e6920e/assets/files/shrinking\_free\_chunks.c)
* ç”±äºä½¿ç”¨äº† Tcachesï¼Œæ­¤æ”»å‡»ä¸å†æœ‰æ•ˆã€‚
* æ­¤å¤–ï¼Œå¦‚æœå°è¯•ä½¿ç”¨æ›´å¤§çš„å—æ»¥ç”¨å®ƒï¼ˆå› æ­¤ä¸æ¶‰åŠ tcachesï¼‰ï¼Œå°†ä¼šæ”¶åˆ°é”™è¯¯ï¼š`malloc(): invalid next size (unsorted)`

### ç›®æ ‡

* ä½¿ä¸€ä¸ªå—åŒ…å«åœ¨å¦ä¸€ä¸ªå—ä¸­ï¼Œå› æ­¤å¯¹ç¬¬äºŒä¸ªå—çš„å†™è®¿é—®å…è®¸è¦†ç›–åŒ…å«çš„å—

### è¦æ±‚

* åˆ©ç”¨ off by one æº¢å‡ºæ¥ä¿®æ”¹å‰ä¸€ä¸ªå¤§å°çš„å…ƒæ•°æ®ä¿¡æ¯

### æ”»å‡»

* ä¸‰ä¸ªå†…å­˜å—ï¼ˆaã€bã€cï¼‰ä¾æ¬¡ä¿ç•™ã€‚ç„¶åé‡Šæ”¾ä¸­é—´çš„å—ã€‚ç¬¬ä¸€ä¸ªå—åŒ…å«ä¸€ä¸ª off by one æº¢å‡ºæ¼æ´ï¼Œæ”»å‡»è€…åˆ©ç”¨å®ƒæ¥å†™å…¥ 0x00ï¼ˆå¦‚æœå‰ä¸€ä¸ªå­—èŠ‚æ˜¯ 0x10ï¼Œåˆ™ä¼šä½¿ä¸­é—´å—æŒ‡ç¤ºå®ƒæ¯”å®é™…å° 0x10ï¼‰ã€‚
* ç„¶åï¼Œåœ¨ä¸­é—´é‡Šæ”¾çš„å—ï¼ˆbï¼‰ä¸­åˆ†é…äº†ä¸¤ä¸ªæ›´å°çš„å—ï¼Œä½†æ˜¯ç”±äº `b + b->size` ä»æœªæ›´æ–° c å—ï¼Œå› ä¸ºæŒ‡å‘çš„åœ°å€æ¯”åº”è¯¥å°ã€‚
* ç„¶åï¼Œé‡Šæ”¾äº† b1 å’Œ cã€‚ç”±äº `c - c->prev_size` ä»ç„¶æŒ‡å‘ bï¼ˆç°åœ¨æ˜¯ b1ï¼‰ï¼Œä¸¤è€…è¢«åˆå¹¶ä¸ºä¸€ä¸ªå—ã€‚ä½†æ˜¯ï¼Œb2 ä»ç„¶åœ¨ b1 å’Œ c ä¹‹é—´ã€‚
* æœ€åï¼Œæ‰§è¡Œæ–°çš„ malloc æ¥é‡æ–°è·å–è¿™å—å†…å­˜åŒºåŸŸï¼Œå®é™…ä¸Šå°†åŒ…å« b2ï¼Œä»è€Œå…è®¸æ–° malloc çš„æ‰€æœ‰è€…æ§åˆ¶ b2 çš„å†…å®¹ã€‚

è¿™å¼ å›¾ç‰‡å®Œç¾è§£é‡Šäº†æ”»å‡»è¿‡ç¨‹ï¼š

<figure><img src="../../.gitbook/assets/image (1247).png" alt=""><figcaption><p><a href="https://heap-exploitation.dhavalkapil.com/attacks/shrinking_free_chunks">https://heap-exploitation.dhavalkapil.com/attacks/shrinking_free_chunks</a></p></figcaption></figure>

## å…¶ä»–ç¤ºä¾‹å’Œå‚è€ƒèµ„æ–™

* [**https://heap-exploitation.dhavalkapil.com/attacks/shrinking\_free\_chunks**](https://heap-exploitation.dhavalkapil.com/attacks/shrinking\_free\_chunks)
* [**Asis CTF 2016 b00ks**](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/off\_by\_one/#1-asis-ctf-2016-b00ks)
* å¯ä»¥åˆ©ç”¨ off by one æ¼æ´æ³„æ¼å †ä¸­çš„åœ°å€ï¼Œå› ä¸ºå­—ç¬¦ä¸²æœ«å°¾çš„ 0x00 å­—èŠ‚è¢«ä¸‹ä¸€ä¸ªå­—æ®µè¦†ç›–ã€‚
* é€šè¿‡æ»¥ç”¨ off by one å†™å…¥æ¥è·å¾—ä»»æ„å†™å…¥ï¼Œä½¿æŒ‡é’ˆæŒ‡å‘å¦ä¸€ä¸ªä½ç½®ï¼Œæ„å»ºä¸€ä¸ªå¸¦æœ‰è™šå‡æŒ‡é’ˆçš„è™šå‡ç»“æ„ã€‚ç„¶åï¼Œå¯ä»¥è·Ÿéšæ­¤ç»“æ„çš„æŒ‡é’ˆä»¥è·å¾—ä»»æ„å†™å…¥ã€‚
* æ³„æ¼ libc åœ°å€ï¼Œå› ä¸ºå¦‚æœä½¿ç”¨ mmap æ‰©å±•å †ï¼Œåˆ™ç”± mmap åˆ†é…çš„å†…å­˜ä¸ libc æœ‰å›ºå®šçš„åç§»é‡ã€‚
* æœ€åï¼Œæ»¥ç”¨ä»»æ„å†™å…¥å°†åœ°å€å†™å…¥ \_\_free\_hookï¼Œä½¿ç”¨ä¸€ä¸ª gadgetã€‚
* [**plaidctf 2015 plaiddb**](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/off\_by\_one/#instance-2-plaidctf-2015-plaiddb)
* åœ¨è¯»å–ç”¨æˆ·è¾“å…¥è¡Œçš„ `getline` å‡½æ•°ä¸­å­˜åœ¨ä¸€ä¸ª NULL off by one æ¼æ´ã€‚æ­¤å‡½æ•°ç”¨äºè¯»å–å†…å®¹çš„â€œé”®â€ï¼Œè€Œä¸æ˜¯å†…å®¹ã€‚
* åœ¨ writeup ä¸­åˆ›å»ºäº† 5 ä¸ªåˆå§‹å—ï¼š
* chunk1ï¼ˆ0x200ï¼‰
* chunk2ï¼ˆ0x50ï¼‰
* chunk5ï¼ˆ0x68ï¼‰
* chunk3ï¼ˆ0x1f8ï¼‰
* chunk4ï¼ˆ0xf0ï¼‰
* chunk defenseï¼ˆ0x400ï¼‰ä»¥é¿å…ä¸é¡¶éƒ¨å—åˆå¹¶
* ç„¶åé‡Šæ”¾äº†å— 1ã€5 å’Œ 3ï¼Œå› æ­¤ï¼š
* ```python
[ 0x200 Chunk 1 (free) ] [ 0x50 Chunk 2 ] [ 0x68 Chunk 5 (free) ] [ 0x1f8 Chunk 3 (free) ] [ 0xf0 Chunk 4 ] [ 0x400 Chunk defense ]
```
* ç„¶åæ»¥ç”¨å— 3ï¼ˆ0x1f8ï¼‰ï¼Œæ»¥ç”¨ null off-by-one å°† prev\_size å†™å…¥ `0x4e0`ã€‚
* è¯·æ³¨æ„ï¼Œæœ€åˆåˆ†é…çš„å— 1ã€2ã€5 å’Œ 3 çš„å¤§å°åŠ ä¸Šè¿™äº›å—çš„ 4 ä¸ªå¤´éƒ¨ç­‰äº `0x4e0`ï¼š`hex(0x1f8 + 0x10 + 0x68 + 0x10 + 0x50 + 0x10 + 0x200) = 0x4e0`
* ç„¶åï¼Œé‡Šæ”¾å— 4ï¼Œç”Ÿæˆä¸€ä¸ªæ¶ˆè€—æ‰€æœ‰å—ç›´åˆ°å¼€å¤´çš„å—ï¼š
* ```python
[ 0x4e0 Chunk 1-2-5-3 (free) ] [ 0xf0 Chunk 4 (corrupted) ] [ 0x400 Chunk defense ]
```
* ```python
[ 0x200 Chunk 1 (free) ] [ 0x50 Chunk 2 ] [ 0x68 Chunk 5 (free) ] [ 0x1f8 Chunk 3 (free) ] [ 0xf0 Chunk 4 ] [ 0x400 Chunk defense ]
```
* ç„¶åï¼Œåˆ†é…äº† `0x200` å­—èŠ‚å¡«å……åŸå§‹å— 1
* å†åˆ†é…äº†å¦å¤– 0x200 å­—èŠ‚ï¼Œç ´åäº†å— 2ï¼Œå› æ­¤æ²¡æœ‰æ³„æ¼ï¼Œè¿™ä¸èµ·ä½œç”¨ï¼Ÿä¹Ÿè®¸ä¸åº”è¯¥è¿™æ ·åš
* ç„¶åï¼Œåˆ†é…äº†ä¸€ä¸ªåŒ…å« 0x58 ä¸ªâ€œaâ€çš„å—ï¼ˆè¦†ç›–äº†å— 2 å¹¶è¾¾åˆ°å— 5ï¼‰ï¼Œå¹¶ä¿®æ”¹äº†æŒ‡å‘ `__malloc_hook` çš„å¿«é€Ÿ bin å—çš„ `fd`
* ç„¶åï¼Œåˆ†é…äº†ä¸€ä¸ªå¤§å°ä¸º 0x68 çš„å—ï¼Œå› æ­¤ `__malloc_hook` ä¸­çš„è™šå‡å¿«é€Ÿ bin å—æ˜¯ä»¥ä¸‹å¿«é€Ÿ bin å—
* æœ€åï¼Œåˆ†é…äº†ä¸€ä¸ªå¤§å°ä¸º 0x68 çš„æ–°å¿«é€Ÿ bin å—ï¼Œå¹¶ç”¨ `one_gadget` åœ°å€è¦†ç›–äº† `__malloc_hook`

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS çº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„ **å…¬å¸å¹¿å‘Š** æˆ– **ä¸‹è½½ PDF ç‰ˆæœ¬çš„ HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶ [**NFTs**](https://opensea.io/collection/the-peass-family) æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
