# Bir birim aÅŸÄ±mÄ±

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sÄ±fÄ±rdan kahramana kadar AWS hacklemeyi Ã¶ÄŸrenin!</summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**]'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **KatÄ±lÄ±n** ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>

## Temel Bilgiler

YalnÄ±zca 1B birim aÅŸÄ±mÄ±na eriÅŸim saÄŸlamak, saldÄ±rganÄ±n bir sonraki parÃ§anÄ±n `pre_in_use` bitini deÄŸiÅŸtirmesine olanak tanÄ±r ve mevcut parÃ§a kullanÄ±mda olmadÄ±ÄŸÄ±ndan, parÃ§anÄ±n sonu Ã¶nceki parÃ§a boyutu meta bilgileri haline gelir.\
Bu, hangi parÃ§alarÄ±n gerÃ§ekten serbest bÄ±rakÄ±ldÄ±ÄŸÄ±nÄ± deÄŸiÅŸtirmeyi saÄŸlar, potansiyel olarak baÅŸka bir meÅŸru parÃ§ayÄ± iÃ§eren bir parÃ§a oluÅŸturabilir.

Bir birim aÅŸÄ±mÄ± zafiyetinin 2 tÃ¼rÃ¼ vardÄ±r:

* Keyfi byte: Bu tÃ¼r, o byte'Ä± herhangi bir deÄŸerle Ã¼zerine yazmaya olanak tanÄ±r
* Null birim aÅŸÄ±mÄ±: Bu tÃ¼r, o byte'Ä± yalnÄ±zca 0x00 ile Ã¼zerine yazmaya olanak tanÄ±r
* Bu zafiyetin yaygÄ±n bir Ã¶rneÄŸi, strlen ve strcpy davranÄ±ÅŸÄ±nÄ±n tutarsÄ±z olduÄŸu aÅŸaÄŸÄ±daki kodda gÃ¶rÃ¼lebilir, bu da bir sonraki parÃ§anÄ±n baÅŸlangÄ±cÄ±na 0x00 byte ayarlamayÄ± mÃ¼mkÃ¼n kÄ±lar.

<details>

<summary>Null birim aÅŸÄ±mÄ±</summary>
```c
// From https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/off_by_one/
int main(void)
{
char buffer[40]="";
void *chunk1;
chunk1 = malloc(24);
puts("Get Input");
gets(buffer);
if(strlen(buffer)==24)
{
strcpy(chunk1,buffer);
}
return 0;
}
```
</details>

DiÄŸer kontroller arasÄ±nda, artÄ±k bir parÃ§a serbest bÄ±rakÄ±ldÄ±ÄŸÄ±nda Ã¶nceki boyutun, metadatadaki parÃ§anÄ±n yapÄ±landÄ±rÄ±lan boyutuyla karÅŸÄ±laÅŸtÄ±rÄ±ldÄ±ÄŸÄ± kontrol edilir, bu saldÄ±rÄ± 2.28 sÃ¼rÃ¼mden itibaren oldukÃ§a karmaÅŸÄ±k hale getirir.

### Kod Ã–rneÄŸi:

* [https://github.com/DhavalKapil/heap-exploitation/blob/d778318b6a14edad18b20421f5a06fa1a6e6920e/assets/files/shrinking\_free\_chunks.c](https://github.com/DhavalKapil/heap-exploitation/blob/d778318b6a14edad18b20421f5a06fa1a6e6920e/assets/files/shrinking\_free\_chunks.c)
* Bu saldÄ±rÄ± artÄ±k Tcaches kullanÄ±ldÄ±ÄŸÄ±ndan Ã§alÄ±ÅŸmamaktadÄ±r.
* AyrÄ±ca, daha bÃ¼yÃ¼k parÃ§alar kullanarak (bu durumda tcaches devreye girmez), hata alÄ±rsÄ±nÄ±z: `malloc(): invalid next size (unsorted)`

### AmaÃ§

* Bir parÃ§anÄ±n baÅŸka bir parÃ§anÄ±n iÃ§inde bulunmasÄ±nÄ± saÄŸlamak, bÃ¶ylece ikinci parÃ§aya yazma eriÅŸimi, iÃ§erilen parÃ§ayÄ± Ã¼zerine yazmaya olanak tanÄ±r

### Gereksinimler

* Ã–nceki boyut metad veri bilgisini deÄŸiÅŸtirmek iÃ§in bir birim fazla taÅŸma

### SaldÄ±rÄ±

* Bellekte 3 parÃ§a (a, b, c) ardÄ±ÅŸÄ±k olarak ayrÄ±lmÄ±ÅŸtÄ±r. ArdÄ±ndan ortadaki parÃ§a serbest bÄ±rakÄ±lÄ±r. Ä°lk parÃ§a bir birim fazla taÅŸma aÃ§Ä±ÄŸÄ±na sahiptir ve saldÄ±rgan bunu 0x00 ile kÃ¶tÃ¼ye kullanÄ±r (Ã¶nceki bayt 0x10 ise, ortadaki parÃ§anÄ±n gerÃ§ekte olduÄŸundan 0x10 daha kÃ¼Ã§Ã¼k olduÄŸunu gÃ¶sterir).
* Daha sonra, ortadaki serbest bÄ±rakÄ±lan parÃ§aya (b) 2 daha kÃ¼Ã§Ã¼k parÃ§a ayrÄ±lÄ±r, ancak `b + b->size` c parÃ§asÄ±nÄ± gÃ¼ncellemez Ã§Ã¼nkÃ¼ iÅŸaret edilen adres olmasÄ± gereken adresten daha kÃ¼Ã§Ã¼ktÃ¼r.
* Daha sonra, b1 ve c serbest bÄ±rakÄ±lÄ±r. `c - c->prev_size` hala b'yi (ÅŸimdi b1) iÅŸaret ettiÄŸi iÃ§in, her ikisi de birleÅŸtirilir. Ancak, b2 hala b1 ve c arasÄ±nda iÃ§indedir.
* Son olarak, bu bellek alanÄ±nÄ± geri kazanmak iÃ§in yeni bir malloc iÅŸlemi gerÃ§ekleÅŸtirilir, bu da aslÄ±nda b2'yi iÃ§erecek ve yeni malloc'un sahibine b2'nin iÃ§eriÄŸini kontrol etme olanaÄŸÄ± tanÄ±r.

Bu resim saldÄ±rÄ±yÄ± mÃ¼kemmel bir ÅŸekilde aÃ§Ä±klar:

<figure><img src="../../.gitbook/assets/image (1247).png" alt=""><figcaption><p><a href="https://heap-exploitation.dhavalkapil.com/attacks/shrinking_free_chunks">https://heap-exploitation.dhavalkapil.com/attacks/shrinking_free_chunks</a></p></figcaption></figure>

## DiÄŸer Ã–rnekler ve Referanslar

* [**https://heap-exploitation.dhavalkapil.com/attacks/shrinking\_free\_chunks**](https://heap-exploitation.dhavalkapil.com/attacks/shrinking\_free\_chunks)
* [**Asis CTF 2016 b00ks**](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/off\_by\_one/#1-asis-ctf-2016-b00ks)
* Bir birim fazla taÅŸmayÄ± kullanarak yÄ±ÄŸÄ±n belleÄŸinden bir adres sÄ±zdÄ±rmak mÃ¼mkÃ¼ndÃ¼r Ã§Ã¼nkÃ¼ bir dizenin sonundaki 0x00 baytÄ± bir sonraki alan tarafÄ±ndan Ã¼zerine yazÄ±lÄ±r.
* Rastgele yazma, bir birim fazla taÅŸmayÄ± kÃ¶tÃ¼ye kullanarak elde edilir, bÃ¶ylece iÅŸaretÃ§i baÅŸka bir yere iÅŸaret edecek sahte bir yapÄ± oluÅŸturulur. ArdÄ±ndan, bu yapÄ±daki iÅŸaretÃ§iyi takip ederek rastgele yazma elde etmek mÃ¼mkÃ¼ndÃ¼r.
* Libc adresi sÄ±zdÄ±rÄ±lÄ±r Ã§Ã¼nkÃ¼ yÄ±ÄŸÄ±n mmap kullanÄ±larak geniÅŸletildiÄŸinde, mmap tarafÄ±ndan tahsis edilen belleÄŸin libc'ten sabit bir ofseti vardÄ±r.
* Son olarak, rastgele yazma, `__free_hook` adresine bir tek araÃ§la yazmak iÃ§in kÃ¶tÃ¼ye kullanÄ±lÄ±r.
* [**plaidctf 2015 plaiddb**](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/off\_by\_one/#instance-2-plaidctf-2015-plaiddb)
* KullanÄ±cÄ± giriÅŸ satÄ±rlarÄ±nÄ± okuyan `getline` iÅŸlevinde NULL bir birim fazla taÅŸma zafiyeti vardÄ±r. Bu iÅŸlev, iÃ§eriÄŸin "anahtarÄ±nÄ±" okumak iÃ§in kullanÄ±lÄ±r.
* YazÄ±m 5 baÅŸlangÄ±Ã§ parÃ§asÄ± oluÅŸturulur:
* parÃ§a1 (0x200)
* parÃ§a2 (0x50)
* parÃ§a5 (0x68)
* parÃ§a3 (0x1f8)
* parÃ§a4 (0xf0)
* parÃ§a savunmasÄ± (0x400), Ã¼st parÃ§ayla birleÅŸmesini Ã¶nlemek iÃ§in
* ArdÄ±ndan parÃ§a 1, 5 ve 3 serbest bÄ±rakÄ±lÄ±r, bÃ¶ylece:
* ```python
[ 0x200 ParÃ§a 1 (serbest) ] [ 0x50 ParÃ§a 2 ] [ 0x68 ParÃ§a 5 (serbest) ] [ 0x1f8 ParÃ§a 3 (serbest) ] [ 0xf0 ParÃ§a 4 ] [ 0x400 ParÃ§a savunmasÄ± ]
```
* ArdÄ±ndan, parÃ§a3 (0x1f8) kÃ¶tÃ¼ye kullanÄ±larak null bir birim fazla taÅŸma yazarak prev\_size `0x4e0` olarak yazÄ±lÄ±r.
* BaÅŸlangÄ±Ã§ta tahsis edilen parÃ§a1, 2, 5 ve 3'Ã¼n boyutlarÄ±nÄ±n ve bu parÃ§alarÄ±n baÅŸlÄ±klarÄ±nÄ±n toplamÄ±nÄ±n `0x4e0` olduÄŸuna dikkat edin: `hex(0x1f8 + 0x10 + 0x68 + 0x10 + 0x50 + 0x10 + 0x200) = 0x4e0`
* ArdÄ±ndan, parÃ§a 4 serbest bÄ±rakÄ±lÄ±r, tÃ¼m parÃ§alarÄ± baÅŸlangÄ±ca kadar tÃ¼keten bir parÃ§a oluÅŸturur:
* ```python
[ 0x4e0 ParÃ§a 1-2-5-3 (serbest) ] [ 0xf0 ParÃ§a 4 (bozuk) ] [ 0x400 ParÃ§a savunmasÄ± ]
```
* ```python
[ 0x200 ParÃ§a 1 (serbest) ] [ 0x50 ParÃ§a 2 ] [ 0x68 ParÃ§a 5 (serbest) ] [ 0x1f8 ParÃ§a 3 (serbest) ] [ 0xf0 ParÃ§a 4 ] [ 0x400 ParÃ§a savunmasÄ± ]
```
* ArdÄ±ndan, orijinal parÃ§a 1'i doldurmak iÃ§in `0x200` bayt tahsis edilir
* Ve baÅŸka 0x200 bayt tahsis edilir ve parÃ§a2 yok edilir ve bu nedenle hiÃ§bir sÄ±zÄ±ntÄ± yok ve bu iÅŸe yaramaz mÄ±? Belki bunun yapÄ±lmasÄ± gerekmeyebilir
* ArdÄ±ndan, 0x58 "a" ile baÅŸka bir parÃ§a tahsis edilir (parÃ§a2'yi Ã¼zerine yazarak parÃ§a5'e ulaÅŸÄ±r) ve chunk5'in hÄ±zlÄ± bin parÃ§asÄ±nÄ±n `__malloc_hook`'a iÅŸaret eden `fd`'si deÄŸiÅŸtirilir
* Son olarak, 0x68'lik bir parÃ§a tahsis edilir, bÃ¶ylece `__malloc_hook`'taki sahte hÄ±zlÄ± bin parÃ§asÄ±, takip edilecek sonraki hÄ±zlÄ± bin parÃ§asÄ± olur
* Son olarak, 0x68'lik yeni bir hÄ±zlÄ± bin parÃ§asÄ± tahsis edilir ve `__malloc_hook` bir `one_gadget` adresiyle Ã¼zerine yazÄ±lÄ±r

<details>

<summary><strong>SÄ±fÄ±rdan baÅŸlayarak AWS hacklemeyi</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> Ã¶ÄŸrenin!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) koleksiyonumuzdaki Ã¶zel [**NFT'leri**](https://opensea.io/collection/the-peass-family) keÅŸfedin
* ğŸ’¬ **Discord grubuna** katÄ±lÄ±n veya **telegram grubuna** veya **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)'Ä± takip edin.
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na PR gÃ¶ndererek paylaÅŸÄ±n.

</details>
