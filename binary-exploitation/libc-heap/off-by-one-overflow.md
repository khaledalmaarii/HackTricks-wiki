# PrekoraÄenje za jedan bajt

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRETPLATU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Osnovne informacije

ImajuÄ‡i samo pristup prekoraÄenju za jedan bajt, napadaÄ moÅ¾e da izmeni bit `pre_in_use` sledeÄ‡eg bloka, a kako trenutni blok neÄ‡e biti u upotrebi, kraj bloka postaje informacija o veliÄini prethodnog bloka.\
Ovo omoguÄ‡ava manipulisanje blokovima koji su zapravo osloboÄ‘eni, potencijalno generiÅ¡uÄ‡i blok koji sadrÅ¾i drugi legitimni blok.

Postoje 2 vrste ranjivosti prekoraÄenja za jedan bajt:

* Proizvoljan bajt: Ova vrsta omoguÄ‡ava prepisivanje tog bajta sa bilo kojom vrednoÅ¡Ä‡u
* Null prekoraÄenje za jedan bajt: Ova vrsta omoguÄ‡ava prepisivanje tog bajta samo sa 0x00
* ÄŒest primer ove ranjivosti moÅ¾e se videti u sledeÄ‡em kodu gde je ponaÅ¡anje funkcija strlen i strcpy nekonzistentno, Å¡to omoguÄ‡ava postavljanje bajta 0x00 na poÄetku sledeÄ‡eg bloka.

<details>

<summary>Null prekoraÄenje za jedan bajt</summary>
```c
// From https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/off_by_one/
int main(void)
{
char buffer[40]="";
void *chunk1;
chunk1 = malloc(24);
puts("Get Input");
gets(buffer);
if(strlen(buffer)==24)
{
strcpy(chunk1,buffer);
}
return 0;
}
```
</details>

MeÄ‘u ostalim proverama, sada kada je komad slobodan, prethodna veliÄina se uporeÄ‘uje sa veliÄinom konfigurisanom u metapodacima komada, ÄineÄ‡i ovaj napad priliÄno sloÅ¾enim od verzije 2.28.

### Primer koda:

* [https://github.com/DhavalKapil/heap-exploitation/blob/d778318b6a14edad18b20421f5a06fa1a6e6920e/assets/files/shrinking\_free\_chunks.c](https://github.com/DhavalKapil/heap-exploitation/blob/d778318b6a14edad18b20421f5a06fa1a6e6920e/assets/files/shrinking\_free\_chunks.c)
* Ovaj napad viÅ¡e ne funkcioniÅ¡e zbog koriÅ¡Ä‡enja Tcaches.
* Å taviÅ¡e, ako pokuÅ¡ate da ga zloupotrebite koristeÄ‡i veÄ‡e komade (tako da Tcaches nisu ukljuÄene), dobiÄ‡ete greÅ¡ku: `malloc(): invalid next size (unsorted)`

### Cilj

* Da se komad nalazi unutar drugog komada tako da pisanje pristupa nad tim drugim komadom omoguÄ‡ava prepisivanje sadrÅ¾aja sadrÅ¾anog komada

### Zahtevi

* PrekoraÄenje za jedan bajt kako bi se izmenile informacije o prethodnoj veliÄini metapodataka

### Napad

* Rezervisana su 3 komada memorije (a, b, c) jedan za drugim. Zatim se oslobaÄ‘a srednji komad. Prvi komad sadrÅ¾i ranjivost prekoraÄenja za jedan bajt i napadaÄ je zloupotrebljava sa 0x00 (ako je prethodni bajt bio 0x10, to bi navelo srednji komad da pokaÅ¾e da je za 0x10 manji nego Å¡to zaista jeste).
* Zatim se alociraju joÅ¡ 2 manja komada u oslobaÄ‘enom srednjem komadu (b), meÄ‘utim, poÅ¡to `b + b->size` nikada ne aÅ¾urira komad c jer je pokazana adresa manja nego Å¡to bi trebalo.&#x20;
* Zatim se b1 i c oslobaÄ‘aju. PoÅ¡to `c - c->prev_size` i dalje pokazuje na b (sada b1), oba se konsoliduju u jedan komad. MeÄ‘utim, b2 je i dalje unutar izmeÄ‘u b1 i c.
* Na kraju, vrÅ¡i se nova alokacija memorije koja Ä‡e zauzeti ovu oblast memorije koja Ä‡e zapravo sadrÅ¾ati b2, omoguÄ‡avajuÄ‡i vlasniku nove alokacije da kontroliÅ¡e sadrÅ¾aj b2.

Ova slika savrÅ¡eno objaÅ¡njava napad:

<figure><img src="../../.gitbook/assets/image (1247).png" alt=""><figcaption><p><a href="https://heap-exploitation.dhavalkapil.com/attacks/shrinking_free_chunks">https://heap-exploitation.dhavalkapil.com/attacks/shrinking_free_chunks</a></p></figcaption></figure>

## Ostali primeri i reference

* [**https://heap-exploitation.dhavalkapil.com/attacks/shrinking\_free\_chunks**](https://heap-exploitation.dhavalkapil.com/attacks/shrinking\_free\_chunks)
* [**Asis CTF 2016 b00ks**](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/off\_by\_one/#1-asis-ctf-2016-b00ks)
* MoguÄ‡e je zloupotrebiti prekoraÄenje za jedan bajt kako bi se procurela adresa iz hipa jer bajt 0x00 na kraju stringa biva prepisan sledeÄ‡im poljem.
* Proizvoljno pisanje se dobija zloupotrebom prekoraÄenja za jedan bajt kako bi se pokazivaÄ usmerio na drugo mesto gde Ä‡e biti izgraÄ‘ena laÅ¾na struktura sa laÅ¾nim pokazivaÄima. Zatim je moguÄ‡e pratiti pokazivaÄ ove strukture kako bi se dobilo proizvoljno pisanje.
* Adresa libc-a procuri jer ako se hip proÅ¡iri koriÅ¡Ä‡enjem mmap, memorija alocirana pomoÄ‡u mmap ima fiksni odmak od libc-a.
* Na kraju se zloupotrebljava proizvoljno pisanje kako bi se pisalo na adresu \_\_free\_hook sa jednim gedÅ¾etom.
* [**plaidctf 2015 plaiddb**](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/off\_by\_one/#instance-2-plaidctf-2015-plaiddb)
* Postoji NULL ranjivost za jedan bajt u funkciji `getline` koja Äita linije korisniÄkog unosa. Ova funkcija se koristi za Äitanje "kljuÄa" sadrÅ¾aja, a ne samog sadrÅ¾aja.
* U objaÅ¡njenju se stvaraju 5 poÄetnih komada:
* komad1 (0x200)
* komad2  (0x50)
* komad5 (0x68)
* komad3 (0x1f8)
* komad4 (0xf0)
* odbrambeni komad (0x400) kako bi se izbeglo konsolidovanje sa vrÅ¡nim komadom
* Zatim se oslobaÄ‘aju komadi 1, 5 i 3, tako da:
* ```python
[ 0x200 Komad 1 (slobodan) ] [ 0x50 Komad 2 ] [ 0x68 Komad 5 (slobodan) ] [ 0x1f8 Komad 3 (slobodan) ] [ 0xf0 Komad 4 ] [ 0x400 Odbrambeni komad ]
```
* Zatim se zloupotrebljava komad3 (0x1f8) zloupotrebom null prekoraÄenja za jedan bajt pisanjem prev\_size u `0x4e0`.
* Primetite kako veliÄine poÄetno alociranih komada1, 2, 5 i 3 plus zaglavlja 4 tih komada iznose `0x4e0`:  `hex(0x1f8 + 0x10 + 0x68 + 0x10 + 0x50 + 0x10 + 0x200) = 0x4e0`
* Zatim se oslobaÄ‘a komad 4, generiÅ¡uÄ‡i komad koji troÅ¡i sve komade do poÄetka:
* ```python
[ 0x4e0 Komad 1-2-5-3 (slobodan) ] [ 0xf0 Komad 4 (korumpiran) ] [ 0x400 Odbrambeni komad ]
```
* ```python
[ 0x200 Komad 1 (slobodan) ] [ 0x50 Komad 2 ] [ 0x68 Komad 5 (slobodan) ] [ 0x1f8 Komad 3 (slobodan) ] [ 0xf0 Komad 4 ] [ 0x400 Odbrambeni komad ]
```
* Zatim se alocira `0x200` bajtova popunjavajuÄ‡i originalni komad 1
* I alocira se joÅ¡ 0x200 bajtova i uniÅ¡tava se komad2 i stoga nema prokletog procurivanja i ovo ne funkcioniÅ¡e? MoÅ¾da ovo ne bi trebalo raditi
* Zatim se alocira joÅ¡ jedan komad sa 0x58 "a" (prepisanje komada2 i dostizanje komada5) i menja se `fd` brze binarne grupe komada komada5 usmeravajuÄ‡i ga ka `__malloc_hook`
* Zatim se alocira komad od 0x68 tako da je laÅ¾ni brzi binarni komad u `__malloc_hook` sledeÄ‡i brzi binarni komad
* Na kraju se alocira novi brzi binarni komad od 0x68 i `__malloc_hook` se prepisuje adresom `one_gadget`

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
