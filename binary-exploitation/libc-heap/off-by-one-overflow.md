# PrzepeÅ‚nienie o jeden

<details>

<summary><strong>Nauka hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakowania, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w na GitHubie.

</details>

## Podstawowe informacje

MajÄ…c dostÄ™p tylko do przepeÅ‚nienia o 1B, atakujÄ…cy moÅ¼e zmodyfikowaÄ‡ bit `pre_in_use` z nastÄ™pnego fragmentu, a poniewaÅ¼ bieÅ¼Ä…cy fragment nie jest w uÅ¼yciu, koniec fragmentu staje siÄ™ informacjÄ… o rozmiarze poprzedniego fragmentu.\
To pozwala manipulowaÄ‡, ktÃ³re fragmenty sÄ… faktycznie zwalniane, potencjalnie generujÄ…c fragment zawierajÄ…cy inny prawidÅ‚owy fragment.

IstniejÄ… 2 rodzaje podatnoÅ›ci na przepeÅ‚nienie o jeden:

* Dowolny bajt: Ten rodzaj pozwala nadpisaÄ‡ ten bajt dowolnÄ… wartoÅ›ciÄ…
* Null off by one: Ten rodzaj pozwala nadpisaÄ‡ ten bajt tylko wartoÅ›ciÄ… 0x00
* Powszechnym przykÅ‚adem tej podatnoÅ›ci moÅ¼e byÄ‡ kod, w ktÃ³rym zachowanie funkcji strlen i strcpy jest niekonsekwentne, co pozwala na ustawienie bajtu 0x00 na poczÄ…tku nastÄ™pnego fragmentu.

<details>

<summary>Null off by one</summary>
```c
// From https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/off_by_one/
int main(void)
{
char buffer[40]="";
void *chunk1;
chunk1 = malloc(24);
puts("Get Input");
gets(buffer);
if(strlen(buffer)==24)
{
strcpy(chunk1,buffer);
}
return 0;
}
```
</details>

WÅ›rÃ³d innych sprawdzeÅ„, teraz za kaÅ¼dym razem, gdy kawaÅ‚ek jest zwalniany, poprzedni rozmiar jest porÃ³wnywany z rozmiarem skonfigurowanym w metadanych kawaÅ‚ka, co sprawia, Å¼e ten atak jest doÅ›Ä‡ skomplikowany od wersji 2.28.

### PrzykÅ‚ad kodu:

* [https://github.com/DhavalKapil/heap-exploitation/blob/d778318b6a14edad18b20421f5a06fa1a6e6920e/assets/files/shrinking\_free\_chunks.c](https://github.com/DhavalKapil/heap-exploitation/blob/d778318b6a14edad18b20421f5a06fa1a6e6920e/assets/files/shrinking\_free\_chunks.c)
* Ten atak juÅ¼ nie dziaÅ‚a ze wzglÄ™du na uÅ¼ycie Tcaches.
* Ponadto, jeÅ›li sprÃ³bujesz go wykorzystaÄ‡, uÅ¼ywajÄ…c wiÄ™kszych kawaÅ‚kÃ³w (aby tcaches nie byÅ‚y zaangaÅ¼owane), otrzymasz bÅ‚Ä…d: `malloc(): invalid next size (unsorted)`

### Cel

* UmieÅ›ciÄ‡ kawaÅ‚ek wewnÄ…trz innego kawaÅ‚ka, dziÄ™ki czemu dostÄ™p do zapisu na ten drugi kawaÅ‚ek pozwala nadpisaÄ‡ zawarty w nim kawaÅ‚ek

### Wymagania

* PrzepeÅ‚nienie o jeden, aby zmodyfikowaÄ‡ informacje metadanych poprzedniego rozmiaru

### Atak

* Rezerwowane sÄ… 3 kawaÅ‚ki pamiÄ™ci (a, b, c) jeden po drugim. NastÄ™pnie Å›rodkowy jest zwalniany. Pierwszy zawiera podatnoÅ›Ä‡ na przepeÅ‚nienie o jeden bajt i atakujÄ…cy jÄ… wykorzystuje z uÅ¼yciem 0x00 (jeÅ›li poprzedni bajt byÅ‚ 0x10, sprawiÅ‚oby to, Å¼e Å›rodkowy kawaÅ‚ek wskazywaÅ‚by, Å¼e jest o 0x10 mniejszy niÅ¼ naprawdÄ™).
* NastÄ™pnie, w Å›rodkowym zwolnionym kawaÅ‚ku (b) alokowane sÄ… 2 mniejsze kawaÅ‚ki, jednakÅ¼e, poniewaÅ¼ `b + b->size` nigdy nie aktualizuje kawaÅ‚ka c, poniewaÅ¼ wskazany adres jest mniejszy niÅ¼ powinien.&#x20;
* NastÄ™pnie, b1 i c sÄ… zwalniane. PoniewaÅ¼ `c - c->prev_size` nadal wskazuje na b (teraz b1), oba sÄ… konsolidowane w jeden kawaÅ‚ek. JednakÅ¼e, b2 nadal znajduje siÄ™ w Å›rodku miÄ™dzy b1 i c.
* W koÅ„cu wykonywane jest nowe malloc odzyskujÄ…ce ten obszar pamiÄ™ci, ktÃ³ry faktycznie bÄ™dzie zawieraÅ‚ b2, pozwalajÄ…c wÅ‚aÅ›cicielowi nowego malloc kontrolowaÄ‡ zawartoÅ›Ä‡ b2.

To zdjÄ™cie doskonale wyjaÅ›nia atak:

<figure><img src="../../.gitbook/assets/image (1247).png" alt=""><figcaption><p><a href="https://heap-exploitation.dhavalkapil.com/attacks/shrinking_free_chunks">https://heap-exploitation.dhavalkapil.com/attacks/shrinking_free_chunks</a></p></figcaption></figure>

## Inne PrzykÅ‚ady i OdnoÅ›niki

* [**https://heap-exploitation.dhavalkapil.com/attacks/shrinking\_free\_chunks**](https://heap-exploitation.dhavalkapil.com/attacks/shrinking\_free\_chunks)
* [**Asis CTF 2016 b00ks**](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/off\_by\_one/#1-asis-ctf-2016-b00ks)
* MoÅ¼liwe jest wykorzystanie przepeÅ‚nienia o jeden do wycieku adresu z heap, poniewaÅ¼ bajt 0x00 na koÅ„cu Å‚aÅ„cucha zostaje nadpisany przez nastÄ™pne pole.
* Zapis dowolny jest uzyskiwany poprzez wykorzystanie przepeÅ‚nienia o jeden, aby sprawiÄ‡, Å¼e wskaÅºnik wskazuje na inne miejsce, gdzie zostanie zbudowana faÅ‚szywa struktura z faÅ‚szywymi wskaÅºnikami. NastÄ™pnie moÅ¼liwe jest Å›ledzenie wskaÅºnika tej struktury, aby uzyskaÄ‡ zapis dowolny.
* Adres libc jest wyciekany, poniewaÅ¼ jeÅ›li heap jest rozszerzany za pomocÄ… mmap, pamiÄ™Ä‡ przydzielona przez mmap ma staÅ‚y przesuniÄ™cie od libc.
* W koÅ„cu zapis dowolny jest wykorzystywany do zapisania adresu \_\_free\_hook za pomocÄ… one gadgeta.
* [**plaidctf 2015 plaiddb**](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/off\_by\_one/#instance-2-plaidctf-2015-plaiddb)
* Istnieje podatnoÅ›Ä‡ NULL off by one w funkcji `getline`, ktÃ³ra czyta linie wejÅ›ciowe uÅ¼ytkownika. Ta funkcja sÅ‚uÅ¼y do odczytywania "klucza" zawartoÅ›ci, a nie samej zawartoÅ›ci.
* W opisie 5 poczÄ…tkowych kawaÅ‚kÃ³w jest tworzonych:
* kawaÅ‚ek1 (0x200)
* kawaÅ‚ek2  (0x50)
* kawaÅ‚ek5 (0x68)
* kawaÅ‚ek3 (0x1f8)
* kawaÅ‚ek4 (0xf0)
* obrona kawaÅ‚ka (0x400) aby uniknÄ…Ä‡ konsolidacji z kawaÅ‚kiem gÃ³rnym
* NastÄ™pnie kawaÅ‚ki 1, 5 i 3 sÄ… zwalniane, wiÄ™c:
* ```python
[ 0x200 KawaÅ‚ek 1 (zwolniony) ] [ 0x50 KawaÅ‚ek 2 ] [ 0x68 KawaÅ‚ek 5 (zwolniony) ] [ 0x1f8 KawaÅ‚ek 3 (zwolniony) ] [ 0xf0 KawaÅ‚ek 4 ] [ 0x400 KawaÅ‚ek obrony ]
```
* NastÄ™pnie naduÅ¼ywajÄ…c kawaÅ‚ka3 (0x1f8) wykorzystywane jest null off-by-one, zapisujÄ…c prev\_size na `0x4e0`.
* ZauwaÅ¼, jak rozmiary poczÄ…tkowo przydzielonych kawaÅ‚kÃ³w1, 2, 5 i 3 plus nagÅ‚Ã³wki 4 tych kawaÅ‚kÃ³w rÃ³wnajÄ… siÄ™ `0x4e0`:  `hex(0x1f8 + 0x10 + 0x68 + 0x10 + 0x50 + 0x10 + 0x200) = 0x4e0`
* NastÄ™pnie, kawaÅ‚ek 4 jest zwalniany, generujÄ…c kawaÅ‚ek, ktÃ³ry zuÅ¼ywa wszystkie kawaÅ‚ki aÅ¼ do poczÄ…tku:
* ```python
[ 0x4e0 KawaÅ‚ek 1-2-5-3 (zwolniony) ] [ 0xf0 KawaÅ‚ek 4 (zepsuty) ] [ 0x400 KawaÅ‚ek obrony ]
```
* ```python
[ 0x200 KawaÅ‚ek 1 (zwolniony) ] [ 0x50 KawaÅ‚ek 2 ] [ 0x68 KawaÅ‚ek 5 (zwolniony) ] [ 0x1f8 KawaÅ‚ek 3 (zwolniony) ] [ 0xf0 KawaÅ‚ek 4 ] [ 0x400 KawaÅ‚ek obrony ]
```
* NastÄ™pnie, przydzielane sÄ… `0x200` bajtÃ³w wypeÅ‚niajÄ…c oryginalny kawaÅ‚ek 1
* I przydzielane sÄ… kolejne 0x200 bajtÃ³w i kawaÅ‚ek2 jest zniszczony i dlatego nie ma Å¼adnego wycieku i to nie dziaÅ‚a? MoÅ¼e tego nie naleÅ¼y robiÄ‡
* NastÄ™pnie przydzielany jest kolejny kawaÅ‚ek o dÅ‚ugoÅ›ci 0x58 "a" (nadpisujÄ…c kawaÅ‚ek2 i docierajÄ…c do kawaÅ‚ka5) i modyfikowany jest `fd` szybkiego kawaÅ‚ka binarnego kawaÅ‚ka5 wskazujÄ…c na `__malloc_hook`
* NastÄ™pnie, przydzielany jest kawaÅ‚ek o dÅ‚ugoÅ›ci 0x68, wiÄ™c faÅ‚szywy szybki kawaÅ‚ek binarny w `__malloc_hook` jest nastÄ™pnym szybkim kawaÅ‚kiem binarnym
* W koÅ„cu, przydzielany jest nowy szybki kawaÅ‚ek binarny o dÅ‚ugoÅ›ci 0x68 i `__malloc_hook` jest nadpisywany adresem `one_gadget`

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF** SprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**Grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakowania, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
