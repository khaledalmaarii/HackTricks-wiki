# Bir birim aÅŸÄ±mÄ±

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve uygulayÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve uygulayÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katÄ±lÄ±n veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ± paylaÅŸarak PR'ler gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>
{% endhint %}

## Temel Bilgiler

YalnÄ±zca 1B aÅŸÄ±mÄ±na eriÅŸim saÄŸlamak, saldÄ±rganÄ±n bir sonraki parÃ§anÄ±n `size` alanÄ±nÄ± deÄŸiÅŸtirmesine olanak tanÄ±r. Bu, hangi parÃ§alarÄ±n gerÃ§ekten serbest bÄ±rakÄ±ldÄ±ÄŸÄ±nÄ± deÄŸiÅŸtirmeyi saÄŸlar ve potansiyel olarak baÅŸka bir meÅŸru parÃ§ayÄ± iÃ§eren bir parÃ§a oluÅŸturabilir. SÃ¶mÃ¼rÃ¼, [Ã§ift serbest bÄ±rakma](double-free.md) veya parÃ§alarÄ±n Ã¼st Ã¼ste binmesiyle benzerdir.

Bir birim aÅŸÄ±mÄ± zafiyetinin 2 tÃ¼rÃ¼ vardÄ±r:

* Keyfi bayt: Bu tÃ¼r, o baytÄ± herhangi bir deÄŸerle Ã¼zerine yazmayÄ± saÄŸlar
* Null baytÄ± (off-by-null): Bu tÃ¼r, o baytÄ± yalnÄ±zca 0x00 ile Ã¼zerine yazmayÄ± saÄŸlar
* Bu zafiyetin yaygÄ±n bir Ã¶rneÄŸi, `strlen` ve `strcpy` iÅŸlevlerinin tutarsÄ±z davranÄ±ÅŸÄ±nÄ±n gÃ¶rÃ¼ldÃ¼ÄŸÃ¼ aÅŸaÄŸÄ±daki kodda gÃ¶rÃ¼lebilir, bu da bir sonraki parÃ§anÄ±n baÅŸÄ±nda 0x00 baytÄ±nÄ± ayarlamayÄ± mÃ¼mkÃ¼n kÄ±lar.
* Bu, [House of Einherjar](house-of-einherjar.md) ile sÃ¶mÃ¼rÃ¼lebilir.
* Tcache kullanÄ±lÄ±yorsa, bu [Ã§ift serbest bÄ±rakma](double-free.md) durumuna dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lebilir. 

<details>

<summary>Off-by-null</summary>
```c
// From https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/off_by_one/
int main(void)
{
char buffer[40]="";
void *chunk1;
chunk1 = malloc(24);
puts("Get Input");
gets(buffer);
if(strlen(buffer)==24)
{
strcpy(chunk1,buffer);
}
return 0;
}
```
</details>

DiÄŸer kontroller arasÄ±nda, artÄ±k bir parÃ§a serbest bÄ±rakÄ±ldÄ±ÄŸÄ±nda Ã¶nceki boyut, metadatadaki parÃ§anÄ±n yapÄ±landÄ±rÄ±lmÄ±ÅŸ boyutuyla karÅŸÄ±laÅŸtÄ±rÄ±lÄ±r, bu saldÄ±rÄ± 2.28 sÃ¼rÃ¼mden itibaren oldukÃ§a karmaÅŸÄ±k hale getirir.

### Kod Ã¶rneÄŸi:

* [https://github.com/DhavalKapil/heap-exploitation/blob/d778318b6a14edad18b20421f5a06fa1a6e6920e/assets/files/shrinking\_free\_chunks.c](https://github.com/DhavalKapil/heap-exploitation/blob/d778318b6a14edad18b20421f5a06fa1a6e6920e/assets/files/shrinking\_free\_chunks.c)
* Bu saldÄ±rÄ± artÄ±k Tcache'lerin kullanÄ±mÄ± nedeniyle Ã§alÄ±ÅŸmÄ±yor.
* AyrÄ±ca, daha bÃ¼yÃ¼k parÃ§alar kullanarak (bu durumda Tcache'lerin dahil olmadÄ±ÄŸÄ±) kÃ¶tÃ¼ye kullanmaya Ã§alÄ±ÅŸÄ±rsanÄ±z, hata alÄ±rsÄ±nÄ±z: `malloc(): invalid next size (unsorted)`

### AmaÃ§

* Bir parÃ§anÄ±n baÅŸka bir parÃ§anÄ±n iÃ§inde bulunmasÄ±nÄ± saÄŸlamak, bÃ¶ylece ikinci parÃ§anÄ±n Ã¼zerinde yazma eriÅŸimi, iÃ§erilen parÃ§ayÄ± Ã¼zerine yazmamÄ±za olanak tanÄ±r

### Gereksinimler

* Boyut metadatasÄ± bilgisini deÄŸiÅŸtirmek iÃ§in bir fazla bir taÅŸma

### Genel off-by-one saldÄ±rÄ±sÄ±

* ÃœÃ§ parÃ§a `A`, `B` ve `C` (Ã¶rneÄŸin boyutlarÄ± 0x20) tahsis edilir ve Ã¼st parÃ§ayla birleÅŸmeyi Ã¶nlemek iÃ§in baÅŸka bir parÃ§a tahsis edilir.
* `C` serbest bÄ±rakÄ±lÄ±r (0x20 Tcache serbest listesine eklendi).
* ParÃ§a `A`yÄ± `B` Ã¼zerine taÅŸÄ±r. `B`nin `size` alanÄ±nÄ± 0x21'den 0x41'e deÄŸiÅŸtirmek iÃ§in fazla bir taÅŸmayÄ± kÃ¶tÃ¼ye kullanÄ±n.
* Åimdi `B`, serbest parÃ§a `C`yi iÃ§eriyor
* `B`'yi serbest bÄ±rakÄ±n ve 0x40 parÃ§a tahsis edin (buraya tekrar yerleÅŸtirilecektir)
* Hala serbest olan `C`nin `fd` iÅŸaretÃ§isini deÄŸiÅŸtirebiliriz (Tcache zehirlenmesi)

### Off-by-null saldÄ±rÄ±sÄ±

* Bellekten Ã¼Ã§ parÃ§a (a, b, c) sÄ±rayla ayrÄ±lÄ±r. ArdÄ±ndan ortadaki parÃ§a serbest bÄ±rakÄ±lÄ±r. Ä°lk parÃ§a fazla bir taÅŸma aÃ§Ä±ÄŸÄ± iÃ§erir ve saldÄ±rgan bunu 0x00 ile kÃ¶tÃ¼ye kullanÄ±r (Ã¶nceki bayt 0x10 ise, ortadaki parÃ§anÄ±n gerÃ§ekten olduÄŸundan 0x10 daha kÃ¼Ã§Ã¼k olduÄŸunu gÃ¶sterir).
* Daha sonra, ortadaki serbest bÄ±rakÄ±lan parÃ§aya (b) 2 daha kÃ¼Ã§Ã¼k parÃ§a tahsis edilir, ancak `b + b->size` ifadesi c parÃ§asÄ±nÄ± gÃ¼ncellemez Ã§Ã¼nkÃ¼ iÅŸaret edilen adres olmasÄ± gereken adresten daha kÃ¼Ã§Ã¼ktÃ¼r.
* Daha sonra, b1 ve c serbest bÄ±rakÄ±lÄ±r. `c - c->prev_size` hala b'yi (ÅŸimdi b1) iÅŸaret ettiÄŸi iÃ§in, her ikisi de bir parÃ§ada birleÅŸtirilir. Ancak, b2 hala b1 ve c arasÄ±nda iÃ§indedir.
* Son olarak, bu bellek alanÄ±nÄ± geri kazanmak iÃ§in yeni bir malloc iÅŸlemi gerÃ§ekleÅŸtirilir ve bu aslÄ±nda b2'yi iÃ§erecek ÅŸekilde olacaktÄ±r, bu da yeni malloc sahibinin b2 iÃ§eriÄŸini kontrol etmesine olanak tanÄ±r.

Bu resim saldÄ±rÄ±yÄ± mÃ¼kemmel bir ÅŸekilde aÃ§Ä±klar:

<figure><img src="../../.gitbook/assets/image (1247).png" alt=""><figcaption><p><a href="https://heap-exploitation.dhavalkapil.com/attacks/shrinking_free_chunks">https://heap-exploitation.dhavalkapil.com/attacks/shrinking_free_chunks</a></p></figcaption></figure>

## DiÄŸer Ã–rnekler ve Referanslar

* [**https://heap-exploitation.dhavalkapil.com/attacks/shrinking\_free\_chunks**](https://heap-exploitation.dhavalkapil.com/attacks/shrinking\_free\_chunks)
* [**Bon-nie-appetit. HTB Cyber Apocalypse CTF 2022**](https://7rocky.github.io/en/ctf/htb-challenges/pwn/bon-nie-appetit/)
* `strlen`'in bir sonraki parÃ§anÄ±n `size` alanÄ±nÄ± dÃ¼ÅŸÃ¼nerek bir off-by-one hatasÄ± oluÅŸturmasÄ±.
* Tcache kullanÄ±lÄ±yor, bu nedenle genel off-by-one saldÄ±rÄ±larÄ±, Tcache zehirlenmesi ile keyfi yazma iÅŸlemine izin vermek iÃ§in Ã§alÄ±ÅŸÄ±r.
* [**Asis CTF 2016 b00ks**](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/off\_by\_one/#1-asis-ctf-2016-b00ks)
* Bir off-by-one'Ä± kÃ¶tÃ¼ye kullanarak bir adres sÄ±zdÄ±rmak mÃ¼mkÃ¼ndÃ¼r Ã§Ã¼nkÃ¼ bir dizenin sonundaki 0x00 baytÄ± bir sonraki alan tarafÄ±ndan Ã¼zerine yazÄ±lÄ±r.
* Keyfi yazma, iÅŸaretÃ§iyi baÅŸka bir yere iÅŸaret etmek iÃ§in off-by-one yazmayÄ± kÃ¶tÃ¼ye kullanarak yapÄ±lÄ±r ve sahte iÅŸaretÃ§ilerle sahte bir yapÄ± oluÅŸturulur. Daha sonra, bu yapÄ±nÄ±n iÅŸaretÃ§isini takip ederek keyfi yazma elde etmek mÃ¼mkÃ¼ndÃ¼r.
* Libc adresi sÄ±zdÄ±rÄ±lÄ±r Ã§Ã¼nkÃ¼ heap, mmap kullanÄ±larak geniÅŸletildiÄŸinde, mmap tarafÄ±ndan ayrÄ±lan belleÄŸin libc'ten sabit bir ofseti vardÄ±r.
* Son olarak, keyfi yazma, \_\_free\_hook adresine bir tane araÃ§la yazmak iÃ§in kÃ¶tÃ¼ye kullanÄ±lÄ±r.
* [**plaidctf 2015 plaiddb**](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/off\_by\_one/#instance-2-plaidctf-2015-plaiddb)
* KullanÄ±cÄ± giriÅŸ satÄ±rlarÄ±nÄ± okuyan `getline` iÅŸlevinde NULL off-by-one bir zafiyet bulunmaktadÄ±r. Bu iÅŸlev, iÃ§eriÄŸin "anahtarÄ±nÄ±" okumak iÃ§in kullanÄ±lÄ±r.
* 5 baÅŸlangÄ±Ã§ parÃ§asÄ± oluÅŸturulur:
* parÃ§a1 (0x200)
* parÃ§a2 (0x50)
* parÃ§a5 (0x68)
* parÃ§a3 (0x1f8)
* parÃ§a4 (0xf0)
* parÃ§a savunmasÄ± (0x400), Ã¼st parÃ§ayla birleÅŸmeyi Ã¶nlemek iÃ§in
* ArdÄ±ndan parÃ§a 1, 5 ve 3 serbest bÄ±rakÄ±lÄ±r, bÃ¶ylece:
* ```python
[ 0x200 ParÃ§a 1 (serbest) ] [ 0x50 ParÃ§a 2 ] [ 0x68 ParÃ§a 5 (serbest) ] [ 0x1f8 ParÃ§a 3 (serbest) ] [ 0xf0 ParÃ§a 4 ] [ 0x400 ParÃ§a savunmasÄ± ]
```
* Daha sonra, parÃ§a3 (0x1f8) kÃ¶tÃ¼ye kullanÄ±larak null off-by-one, prev\_size'Ä±n `0x4e0` olarak yazÄ±lmasÄ±nÄ± saÄŸlar.
* BaÅŸlangÄ±Ã§ta tahsis edilen parÃ§a1, 2, 5 ve 3'Ã¼n boyutlarÄ±nÄ±n ve bu parÃ§alarÄ±n baÅŸlÄ±klarÄ±nÄ±n toplamÄ±nÄ±n `0x4e0`'a eÅŸit olduÄŸuna dikkat edin: `hex(0x1f8 + 0x10 + 0x68 + 0x10 + 0x50 + 0x10 + 0x200) = 0x4e0`
* ArdÄ±ndan, parÃ§a 4 serbest bÄ±rakÄ±lÄ±r, tÃ¼m parÃ§alarÄ± baÅŸlangÄ±ca kadar tÃ¼keten bir parÃ§a oluÅŸturur:
* ```python
[ 0x4e0 ParÃ§a 1-2-5-3 (serbest) ] [ 0xf0 ParÃ§a 4 (bozuk) ] [ 0x400 ParÃ§a savunmasÄ± ]
```
* ```python
[ 0x200 ParÃ§a 1 (serbest) ] [ 0x50 ParÃ§a 2 ] [ 0x68 ParÃ§a 5 (serbest) ] [ 0x1f8 ParÃ§a 3 (serbest) ] [ 0xf0 ParÃ§a 4 ] [ 0x400 ParÃ§a savunmasÄ± ]
```
* Daha sonra, `0x200` bayt tahsis edilir ve orijinal parÃ§a 1 doldurulur
* Ve baÅŸka 0x200 bayt tahsis edilir ve parÃ§a2 yok edilir ve dolayÄ±sÄ±yla hiÃ§bir sÄ±zÄ±ntÄ± yok ve bu iÅŸe yaramaz mÄ±? Belki bunun yapÄ±lmasÄ± gerekmeyebilir
* Daha sonra, 0x58 "a" ile baÅŸka bir parÃ§a tahsis edilir (parÃ§a2'yi Ã¼zerine yazarak parÃ§a5'e ulaÅŸÄ±r) ve parÃ§a5'in hÄ±zlÄ± bin parÃ§asÄ±nÄ±n `__malloc_hook`'a iÅŸaret eden `fd`si deÄŸiÅŸtirilir
* Son olarak, 0x68'lik yeni bir hÄ±zlÄ± bin parÃ§asÄ± tahsis edilir ve `__malloc_hook` bir `one_gadget` adresiyle Ã¼zerine yazÄ±lÄ±r

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve uygulayÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks EÄŸitimi AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve uygulayÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks EÄŸitimi GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [Discord grubuna](https://discord.gg/hRep4RUj7f) veya [telegram grubuna](https://t.me/peass) katÄ±lÄ±n veya** bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacker hilelerini gÃ¶ndererek PR'ler aracÄ±lÄ±ÄŸÄ±yla paylaÅŸÄ±n** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na. 

</details>
{% endhint %}
