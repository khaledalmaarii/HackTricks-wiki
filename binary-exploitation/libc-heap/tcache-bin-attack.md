# Attaque Tcache Bin

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert Red Team AWS HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## Informations de base

Pour plus d'informations sur ce qu'est un tcache bin, consultez cette page :

{% content-ref url="bins-and-memory-allocations.md" %}
[bins-and-memory-allocations.md](bins-and-memory-allocations.md)
{% endcontent-ref %}

Tout d'abord, notez que le Tcache a √©t√© introduit dans la version 2.26 de glibc.

L'attaque **Tcache** propos√©e dans la [**page guyinatuxido**](https://guyinatuxedo.github.io/29-tcache/tcache\_explanation/index.html) est tr√®s similaire √† l'attaque fast bin o√π le but est de remplacer le pointeur vers le chunk suivant dans le bin √† l'int√©rieur d'un chunk lib√©r√© par une adresse arbitraire afin de **allouer cette adresse sp√©cifique et potentiellement √©craser des pointeurs** par la suite.

Cependant, de nos jours, si vous ex√©cutez le code mentionn√©, vous obtiendrez l'erreur : **`malloc(): unaligned tcache chunk detected`**. Il est donc n√©cessaire d'√©crire une adresse align√©e dans le nouveau pointeur (ou d'ex√©cuter suffisamment de fois le binaire pour que l'adresse √©crite soit effectivement align√©e).

### Attaque des index Tcache

Il est g√©n√©ralement possible de trouver au d√©but du tas un chunk contenant la **quantit√© de chunks par index** √† l'int√©rieur du tcache et l'adresse de la **t√™te du chunk de chaque index tcache**. Si, pour une raison quelconque, il est possible de modifier ces informations, il serait possible de **faire pointer la t√™te du chunk de certains index vers une adresse souhait√©e** (comme le crochet malloc) pour ensuite allouer un chunk de la taille de l'index et √©craser le contenu du crochet malloc dans ce cas.

## Exemples

* CTF [https://guyinatuxedo.github.io/29-tcache/dcquals19\_babyheap/index.html](https://guyinatuxedo.github.io/29-tcache/dcquals19\_babyheap/index.html)
* **Fuite d'informations libc** : Il est possible de remplir les tcaches, d'ajouter un chunk dans la liste non tri√©e, de vider le tcache et de **r√©-allouer le chunk de la liste non tri√©e** en ne rempla√ßant que les 8 premiers octets, laissant la **deuxi√®me adresse vers libc du chunk intacte pour que nous puissions la lire**.
* **Attaque Tcache** : Le binaire est vuln√©rable √† un d√©bordement de tas de 1B. Cela sera exploit√© pour modifier l'**en-t√™te de taille** d'un chunk allou√© pour le rendre plus grand. Ensuite, ce chunk sera **lib√©r√©**, ajout√© au tcache des chunks de la fausse taille. Ensuite, nous allouerons un chunk avec la taille falsifi√©e, et le chunk pr√©c√©dent sera **retourn√© en sachant que ce chunk √©tait en r√©alit√© plus petit** et cela ouvre la possibilit√© de **√©craser le chunk suivant en m√©moire**.\
Nous allons exploiter cela pour **√©craser le pointeur FD du chunk suivant** pour pointer vers **`malloc_hook`**, donc il est possible d'allouer 2 pointeurs : d'abord le pointeur l√©gitime que nous venons de modifier, puis la deuxi√®me allocation renverra un chunk dans **`malloc_hook`** qu'il est possible d'exploiter pour √©crire un **one gadget**.
* CTF [https://guyinatuxedo.github.io/29-tcache/plaid19\_cpp/index.html](https://guyinatuxedo.github.io/29-tcache/plaid19\_cpp/index.html)
* **Fuite d'informations libc** : Il y a une utilisation apr√®s la lib√©ration et une double lib√©ration. Dans ce compte rendu, l'auteur a divulgu√© une adresse de libc en lisant l'adresse d'un chunk plac√© dans un petit bin (comme en le fuyant du bin non tri√© mais du petit bin)
* **Attaque Tcache** : Un Tcache est effectu√© via une **double lib√©ration**. Le m√™me chunk est lib√©r√© deux fois, donc √† l'int√©rieur du Tcache, le chunk pointera vers lui-m√™me. Ensuite, il est allou√©, son pointeur FD est modifi√© pour pointer vers le **crochet free** et ensuite il est allou√© √† nouveau, de sorte que le chunk suivant dans la liste sera dans le crochet free. Ensuite, cela est √©galement allou√© et il est possible d'√©crire l'adresse de `system` ici, donc lorsqu'un malloc contenant `"/bin/sh"` est lib√©r√©, nous obtenons un shell.
* CTF [https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps0/index.html](https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps0/index.html)
* La principale vuln√©rabilit√© ici est la capacit√© de `lib√©rer` n'importe quelle adresse dans le tas en indiquant son d√©calage
* **Attaque des index Tcache** : Il est possible d'allouer et de lib√©rer un chunk d'une taille telle que lorsqu'il est stock√© √† l'int√©rieur du chunk tcache (le chunk avec les informations des bins tcache), il g√©n√©rera une **adresse avec la valeur 0x100**. Cela est d√ª au fait que le tcache stocke la quantit√© de chunks sur chaque bin dans des octets diff√©rents, donc un chunk dans un index sp√©cifique g√©n√®re la valeur 0x100.
* Ensuite, cette valeur ressemble √† un chunk de taille 0x100. Permettant de l'exploiter en le `lib√©rant`. Cela ajoutera cette adresse √† l'index des chunks de taille 0x100 dans le tcache.
* Ensuite, en **allouant** un chunk de taille **0x100**, l'adresse pr√©c√©dente sera renvoy√©e en tant que chunk, permettant d'√©craser d'autres index tcache.\
Par exemple, en mettant l'adresse du crochet malloc dans l'un d'eux et en allouant un chunk de la taille de cet index, cela permettra d'obtenir un chunk dans le crochet calloc, ce qui permet d'√©crire un one gadget pour obtenir un shell.
* CTF [https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps1/index.html](https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps1/index.html)
* M√™me vuln√©rabilit√© qu'auparavant avec une restriction suppl√©mentaire
* **Attaque des index Tcache** : Attaque similaire √† la pr√©c√©dente mais en utilisant moins d'√©tapes en **lib√©rant le chunk contenant les informations du tcache** afin que son adresse soit ajout√©e √† l'index tcache de sa taille, permettant d'allouer cette taille et d'obtenir les informations du chunk tcache en tant que chunk, ce qui permet d'ajouter le crochet free en tant qu'adresse d'un index, de l'allouer, et d'√©crire un one gadget dessus.

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert Red Team AWS HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
