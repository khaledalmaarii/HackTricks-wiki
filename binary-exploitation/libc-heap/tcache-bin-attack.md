# Napad na Tcache Bin

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Osnovne informacije

Za viÅ¡e informacija o tome Å¡ta je Tcache bin pogledajte ovu stranicu:

{% content-ref url="bins-and-memory-allocations.md" %}
[bins-and-memory-allocations.md](bins-and-memory-allocations.md)
{% endcontent-ref %}

Prvo, napomenimo da je Tcache uveden u Glibc verziji 2.26.

**Napad na Tcache** (poznat i kao **Tcache trovanje**) predloÅ¾en na [**guyinatuxido stranici**](https://guyinatuxedo.github.io/29-tcache/tcache\_explanation/index.html) veoma je sliÄan napadu na fast bin gde je cilj prepisati pokazivaÄ na sledeÄ‡i blok u binu unutar osloboÄ‘enog bloka na proizvoljnu adresu kako bi kasnije bilo moguÄ‡e **dodeliti tu specifiÄnu adresu i potencijalno prepisati pokazivaÄe**.

MeÄ‘utim, danas, ako pokrenete pomenuti kod, dobiÄ‡ete greÅ¡ku: **`malloc(): unaligned tcache chunk detected`**. Dakle, potrebno je upisati poravnatu adresu kao adresu u novom pokazivaÄu (ili dovoljno puta izvrÅ¡iti binarni fajl kako bi upisana adresa zapravo bila poravnata).

### Napadi na Tcache indekse

ObiÄno je moguÄ‡e naÄ‡i na poÄetku hipa blok koji sadrÅ¾i **broj blokova po indeksu** unutar tcache-a i adresu **glavnog bloka svakog indeksa tcache-a**. Ako iz nekog razloga bude moguÄ‡e izmeniti ove informacije, bilo bi moguÄ‡e **naterati glavni blok nekog indeksa da pokazuje na Å¾eljenu adresu** (kao Å¡to je `__malloc_hook`) kako bi se zatim dodelio blok veliÄine indeksa i prepisali sadrÅ¾aji `__malloc_hook` u ovom sluÄaju.

## Primeri

* CTF [https://guyinatuxedo.github.io/29-tcache/dcquals19\_babyheap/index.html](https://guyinatuxedo.github.io/29-tcache/dcquals19\_babyheap/index.html)
* **Libc informacije o curenju**: MoguÄ‡e je popuniti tcache-ove, dodati blok u nesortiranu listu, isprazniti tcache i **ponovo dodeliti blok iz nesortirane liste** samo prepisujuÄ‡i prvih 8B, ostavljajuÄ‡i **drugu adresu libc-a iz bloka netaknutu tako da je moÅ¾emo proÄitati**.
* **Napad na Tcache**: Binarni fajl je ranjiv na 1B prelivanje hipa. Ovo Ä‡e biti zloupotrebljeno da se promeni **veliÄina zaglavlja** dodeljenog bloka ÄineÄ‡i ga veÄ‡im. Zatim, ovaj blok Ä‡e biti **osloboÄ‘en**, dodajuÄ‡i ga u tcache blokove laÅ¾ne veliÄine. Zatim, dodeliÄ‡emo blok sa laÅ¾iranom veliÄinom, a prethodni blok Ä‡e biti **vraÄ‡en znajuÄ‡i da je ovaj blok zapravo bio manji** i to pruÅ¾a moguÄ‡nost da se **prepise sledeÄ‡i blok u memoriji**.\
IskoristiÄ‡emo ovo da **prepÅ¡emo pokazivaÄ FD sledeÄ‡eg bloka** da pokazuje na **`malloc_hook`**, tako da je moguÄ‡e alocirati 2 pokazivaÄa: prvo legitimni pokazivaÄ koji smo upravo izmenili, a zatim druga alokacija Ä‡e vratiti blok u **`malloc_hook`** koji je moguÄ‡e zloupotrebiti da se napiÅ¡e **one gadget**.
* CTF [https://guyinatuxedo.github.io/29-tcache/plaid19\_cpp/index.html](https://guyinatuxedo.github.io/29-tcache/plaid19\_cpp/index.html)
* **Libc informacije o curenju**: Postoji upotreba nakon osloboÄ‘enja i dvostruko osloboÄ‘avanje. U ovom writeup-u autor je otkrio adresu libc-a ÄitajuÄ‡i adresu bloka smeÅ¡tenog u malom binu (kao Å¡to je curenje iz nesortiranog bina ali iz malog).
* **Napad na Tcache**: Tcache je izvrÅ¡en putem **dvostrukog osloboÄ‘avanja**. Isti blok je osloboÄ‘en dva puta, tako da Ä‡e unutar Tcache-a blok pokazivati na sebe. Zatim, on se alocira, njegov FD pokazivaÄ se menja da pokazuje na **free hook** i zatim se ponovo alocira tako da Ä‡e sledeÄ‡i blok na listi biti u free hook-u. Zatim, i ovaj je alociran i moguÄ‡e je napisati adresu `system` ovde tako da kada se osloboÄ‘e malloc koji sadrÅ¾i `"/bin/sh"` dobijemo shell.
* CTF [https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps0/index.html](https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps0/index.html)
* Glavna ranjivost ovde je moguÄ‡nost `oslobaÄ‘anja` bilo koje adrese u hipu navoÄ‘enjem njenog ofseta
* **Napad na Tcache indekse**: MoguÄ‡e je alocirati i osloboditi blok odreÄ‘ene veliÄine koji kada se skladiÅ¡ti unutar tcache bloka (blok sa informacijama o binovima tcache-a) generisaÄ‡e **adresu sa vrednoÅ¡Ä‡u 0x100**. Ovo je zato Å¡to tcache Äuva broj blokova u svakom binu u razliÄitim bajtovima, stoga jedan blok u jednom odreÄ‘enom indeksu generiÅ¡e vrednost 0x100.
* Zatim, ova vrednost izgleda kao da postoji blok veliÄine 0x100. OmoguÄ‡ava zloupotrebu tako Å¡to se `oslobodi` ova adresa. Ovo Ä‡e **dodati tu adresu u indeks blokova veliÄine 0x100 u tcache-u**.
* Zatim, **alociranjem** bloka veliÄine **0x100**, prethodna adresa Ä‡e biti vraÄ‡ena kao blok, omoguÄ‡avajuÄ‡i prepisivanje drugih tcache indeksa.\
Na primer, postavljanje adrese malloc hook-a u jednom od njih i alokacija bloka veliÄine tog indeksa omoguÄ‡iÄ‡e blok u calloc hook-u, Å¡to omoguÄ‡ava pisanje one gadgeta za dobijanje shell-a.
* CTF [https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps1/index.html](https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps1/index.html)
* Isti ranjivost kao i prethodno sa jednim dodatnim ograniÄenjem
* **Napad na Tcache indekse**: SliÄan napad prethodnom ali sa manje koraka tako Å¡to se **oslobaÄ‘a blok koji sadrÅ¾i informacije o tcache-u** tako da se njegova adresa doda u tcache indeks njegove veliÄine tako da je moguÄ‡e alocirati tu veliÄinu i dobiti informacije o tcache bloku kao blok, Å¡to omoguÄ‡ava dodavanje free hook-a kao adrese jednog indeksa, alokacija toga, i pisanje one gadgeta na njemu.
* [**MatematiÄka Vrata. HTB Cyber Apocalypse CTF 2023**](https://7rocky.github.io/en/ctf/other/htb-cyber-apocalypse/math-door/)
* **Pisanje Nakon OsloboÄ‘enja** da se doda broj pokazivaÄu `fd`.
* Potrebno je puno **heap feng-shui**-a u ovom izazovu. Writeup pokazuje kako je **kontrolisanje glave Tcache** slobodne liste priliÄno korisno.
* **Glibc curenje** kroz `stdout` (FSOP).
* **Tcache trovanje** da se dobije proizvoljno pisanje primitive.
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.
