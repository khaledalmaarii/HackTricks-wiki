# Atak Unlink

<details>

<summary><strong>Nauka hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakowania, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>

## Podstawowe informacje

Kiedy ten atak zostaÅ‚ odkryty, gÅ‚Ã³wnie pozwalaÅ‚ na WWW (Write What Where), jednak dodano **sprawdzenia**, co sprawiÅ‚o, Å¼e nowa wersja ataku staÅ‚a siÄ™ bardziej interesujÄ…ca, bardziej zÅ‚oÅ¼ona i **bezuÅ¼yteczna**.

### PrzykÅ‚ad kodu:

<details>

<summary>Kod</summary>
```c
#include <unistd.h>
#include <stdlib.h>
#include <string.h>
#include <stdio.h>

// Altered from https://github.com/DhavalKapil/heap-exploitation/tree/d778318b6a14edad18b20421f5a06fa1a6e6920e/assets/files/unlink_exploit.c to make it work

struct chunk_structure {
size_t prev_size;
size_t size;
struct chunk_structure *fd;
struct chunk_structure *bk;
char buf[10];               // padding
};

int main() {
unsigned long long *chunk1, *chunk2;
struct chunk_structure *fake_chunk, *chunk2_hdr;
char data[20];

// First grab two chunks (non fast)
chunk1 = malloc(0x8000);
chunk2 = malloc(0x8000);
printf("Stack pointer to chunk1: %p\n", &chunk1);
printf("Chunk1: %p\n", chunk1);
printf("Chunk2: %p\n", chunk2);

// Assuming attacker has control over chunk1's contents
// Overflow the heap, override chunk2's header

// First forge a fake chunk starting at chunk1
// Need to setup fd and bk pointers to pass the unlink security check
fake_chunk = (struct chunk_structure *)chunk1;
fake_chunk->size = 0x8000;
fake_chunk->fd = (struct chunk_structure *)(&chunk1 - 3); // Ensures P->fd->bk == P
fake_chunk->bk = (struct chunk_structure *)(&chunk1 - 2); // Ensures P->bk->fd == P

// Next modify the header of chunk2 to pass all security checks
chunk2_hdr = (struct chunk_structure *)(chunk2 - 2);
chunk2_hdr->prev_size = 0x8000;  // chunk1's data region size
chunk2_hdr->size &= ~1;        // Unsetting prev_in_use bit

// Now, when chunk2 is freed, attacker's fake chunk is 'unlinked'
// This results in chunk1 pointer pointing to chunk1 - 3
// i.e. chunk1[3] now contains chunk1 itself.
// We then make chunk1 point to some victim's data
free(chunk2);
printf("Chunk1: %p\n", chunk1);
printf("Chunk1[3]: %x\n", chunk1[3]);

chunk1[3] = (unsigned long long)data;

strcpy(data, "Victim's data");

// Overwrite victim's data using chunk1
chunk1[0] = 0x002164656b636168LL;

printf("%s\n", data);

return 0;
}

```
</details>

* Atak nie dziaÅ‚a, jeÅ›li sÄ… uÅ¼ywane tcaches (po wersji 2.26)

### Cel

Ten atak pozwala **zmieniÄ‡ wskaÅºnik na blok tak, aby wskazywaÅ‚ 3 adresy przed samym sobÄ…**. JeÅ›li nowa lokalizacja (otoczenie, gdzie znajdowaÅ‚ siÄ™ wskaÅºnik) zawiera interesujÄ…ce informacje, takie jak inne kontrolowalne alokacje / stos..., moÅ¼liwe jest odczytanie/nadpisanie ich w celu spowodowania wiÄ™kszej szkody.

* JeÅ›li ten wskaÅºnik znajdowaÅ‚ siÄ™ na stosie, poniewaÅ¼ teraz wskazuje 3 adresy przed samym sobÄ…, a uÅ¼ytkownik potencjalnie moÅ¼e go odczytaÄ‡ i zmodyfikowaÄ‡, bÄ™dzie moÅ¼liwe wyciekanie poufnych informacji ze stosu lub nawet modyfikacja adresu powrotu (moÅ¼e) bez dotykania canary
* W przykÅ‚adach CTF ten wskaÅºnik znajduje siÄ™ w tablicy wskaÅºnikÃ³w do innych alokacji, dlatego, ustawiajÄ…c go 3 adresy przed i majÄ…c moÅ¼liwoÅ›Ä‡ odczytu i zapisu, moÅ¼na sprawiÄ‡, Å¼e inne wskaÅºniki wskazujÄ… na inne adresy.\
PoniewaÅ¼ potencjalnie uÅ¼ytkownik moÅ¼e rÃ³wnieÅ¼ odczytywaÄ‡/zapisywaÄ‡ inne alokacje, moÅ¼e wyciekaÄ‡ informacje lub nadpisywaÄ‡ nowe adresy w dowolnych lokalizacjach (np. w GOT).

### Wymagania

* Pewna kontrola pamiÄ™ci (np. stos) w celu utworzenia kilku blokÃ³w, przypisujÄ…c wartoÅ›ci do niektÃ³rych atrybutÃ³w.
* Wyciek stosu w celu ustawienia wskaÅºnikÃ³w faÅ‚szywego bloku.

### Atak

* IstniejÄ… dwa bloki (blok1 i blok2)
* AtakujÄ…cy kontroluje zawartoÅ›Ä‡ bloku1 i nagÅ‚Ã³wki bloku2.
* W bloku1 atakujÄ…cy tworzy strukturÄ™ faÅ‚szywego bloku:
* Aby ominÄ…Ä‡ zabezpieczenia, upewnia siÄ™, Å¼e pole `size` jest poprawne, aby uniknÄ…Ä‡ bÅ‚Ä™du: `corrupted size vs. prev_size while consolidating`
* a pola `fd` i `bk` faÅ‚szywego bloku wskazujÄ… tam, gdzie wskaÅºnik bloku1 jest przechowywany z przesuniÄ™ciami odpowiednio -3 i -2, wiÄ™c `fake_chunk->fd->bk` i `fake_chunk->bk->fd` wskazujÄ… na pozycjÄ™ w pamiÄ™ci (stosie), gdzie znajduje siÄ™ rzeczywisty adres bloku1:

<figure><img src="../../.gitbook/assets/image (1245).png" alt=""><figcaption><p><a href="https://heap-exploitation.dhavalkapil.com/attacks/unlink_exploit">https://heap-exploitation.dhavalkapil.com/attacks/unlink_exploit</a></p></figcaption></figure>

* NagÅ‚Ã³wki bloku2 sÄ… modyfikowane w taki sposÃ³b, aby wskazywaÅ‚y, Å¼e poprzedni blok nie jest uÅ¼ywany, a rozmiar to rozmiar zawartego faÅ‚szywego bloku.
* Gdy drugi blok zostanie zwolniony, to nastÄ™puje odÅ‚Ä…czenie tego faÅ‚szywego bloku:
* `fake_chunk->fd->bk` = `fake_chunk->bk`
* `fake_chunk->bk->fd` = `fake_chunk->fd`
* WczeÅ›niej sprawiono, Å¼e `fake_chunk->fd->bk` i `fake_chunk->bk->fd` wskazujÄ… na to samo miejsce (miejsce na stosie, gdzie przechowywany jest `blok1`, wiÄ™c byÅ‚ to poprawny lista poÅ‚Ä…czona). PoniewaÅ¼ **oba wskazujÄ… na to samo miejsce**, tylko ostatni (`fake_chunk->bk->fd = fake_chunk->fd`) bÄ™dzie **dziaÅ‚aÄ‡**.
* Spowoduje to **nadpisanie wskaÅºnika do bloku1 na stosie adresem (lub bajtami) przechowywanym 3 adresy wczeÅ›niej na stosie**.
* Dlatego jeÅ›li atakujÄ…cy mÃ³gÅ‚by ponownie kontrolowaÄ‡ zawartoÅ›Ä‡ bloku1, bÄ™dzie mÃ³gÅ‚ **pisaÄ‡ wewnÄ…trz stosu**, majÄ…c potencjalnie moÅ¼liwoÅ›Ä‡ nadpisania adresu powrotu, pomijajÄ…c canary, oraz modyfikacji wartoÅ›ci i wskaÅºnikÃ³w zmiennych lokalnych. Nawet ponownie modyfikujÄ…c adres bloku1 przechowywany na stosie na innej lokalizacji, jeÅ›li atakujÄ…cy mÃ³gÅ‚by ponownie kontrolowaÄ‡ zawartoÅ›Ä‡ bloku1, bÄ™dzie mÃ³gÅ‚ pisaÄ‡ w dowolnym miejscu.
* NaleÅ¼y zauwaÅ¼yÄ‡, Å¼e byÅ‚o to moÅ¼liwe, poniewaÅ¼ **adresy sÄ… przechowywane na stosie**. Ryzyko i eksploatacja mogÄ… zaleÅ¼eÄ‡ od **miejsca, gdzie sÄ… przechowywane adresy do faÅ‚szywego bloku**.

<figure><img src="../../.gitbook/assets/image (1246).png" alt=""><figcaption><p><a href="https://heap-exploitation.dhavalkapil.com/attacks/unlink_exploit">https://heap-exploitation.dhavalkapil.com/attacks/unlink_exploit</a></p></figcaption></figure>

## Referencje

* [https://heap-exploitation.dhavalkapil.com/attacks/unlink\_exploit](https://heap-exploitation.dhavalkapil.com/attacks/unlink\_exploit)
* ChociaÅ¼ byÅ‚oby dziwne znalezienie ataku unlink nawet w CTF, tutaj znajdziesz kilka rozwiÄ…zaÅ„, gdzie ten atak zostaÅ‚ uÅ¼yty:
* PrzykÅ‚ad CTF: [https://guyinatuxedo.github.io/30-unlink/hitcon14\_stkof/index.html](https://guyinatuxedo.github.io/30-unlink/hitcon14\_stkof/index.html)
* W tym przykÅ‚adzie zamiast stosu jest tablica adresÃ³w przydzielonych za pomocÄ… malloc. Atak unlink jest wykonywany, aby moÅ¼liwe byÅ‚o zaalokowanie bloku tutaj, umoÅ¼liwiajÄ…c kontrolowanie wskaÅºnikÃ³w tablicy adresÃ³w przydzielonych. NastÄ™pnie istnieje inna funkcjonalnoÅ›Ä‡, ktÃ³ra pozwala modyfikowaÄ‡ zawartoÅ›Ä‡ blokÃ³w w tych adresach, co pozwala wskazywaÄ‡ adresy na GOT, modyfikowaÄ‡ adresy funkcji w celu uzyskania wyciekÃ³w i RCE.
* Kolejny przykÅ‚ad CTF: [https://guyinatuxedo.github.io/30-unlink/zctf16\_note2/index.html](https://guyinatuxedo.github.io/30-unlink/zctf16\_note2/index.html)
* Podobnie jak w poprzednim przykÅ‚adzie, istnieje tablica adresÃ³w alokacji. MoÅ¼liwe jest wykonanie ataku unlink, aby sprawiÄ‡, Å¼e adres pierwszej alokacji wskazuje kilka pozycji przed rozpoczÄ™ciem tablicy, a nastÄ™pnie nadpisaÄ‡ tÄ™ alokacjÄ™ na nowej pozycji. DziÄ™ki temu moÅ¼liwe jest nadpisanie wskaÅºnikÃ³w innych alokacji, aby wskazywaÅ‚y na GOT atoi, uzyskaÄ‡ wyciek libc, a nastÄ™pnie nadpisaÄ‡ atoi GOT adresem do jednego gadÅ¼etu.
* PrzykÅ‚ad CTF z niestandardowymi funkcjami malloc i free, ktÃ³re wykorzystujÄ… podatnoÅ›Ä‡ bardzo podobnÄ… do ataku unlink: [https://guyinatuxedo.github.io/33-custom\_misc\_heap/csaw17\_minesweeper/index.html](https://guyinatuxedo.github.io/33-custom\_misc\_heap/csaw17\_minesweeper/index.html)
* Istnieje przepeÅ‚nienie, ktÃ³re pozwala kontrolowaÄ‡ wskaÅºniki FD i BK niestandardowego malloc, ktÃ³re zostanÄ… (niestandardowo) zwolnione. Ponadto sterta ma ustawiony bit exec, wiÄ™c moÅ¼liwe jest wyciek adresu sterty i wskazanie funkcji z GOT na kawaÅ‚ek sterty z shellcodem do wykonania.

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF** SprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**Grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
