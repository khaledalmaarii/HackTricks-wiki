# Napad na nesortiranu binarnu hrpu

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Osnovne informacije

Za viÅ¡e informacija o tome Å¡ta je nesortirana binarna provera, pogledajte ovu stranicu:

{% content-ref url="bins-and-memory-allocations.md" %}
[bins-and-memory-allocations.md](bins-and-memory-allocations.md)
{% endcontent-ref %}

Nesortirane liste mogu da upiÅ¡u adresu u `unsorted_chunks (av)` u adresu `bk` bloka. Dakle, ako napadaÄ moÅ¾e **izmeniti adresu pokazivaÄa bk** u bloku unutar nesortirane binarne hrpe, mogao bi **upisati tu adresu na proizvoljnu adresu** Å¡to bi moglo biti korisno za otkrivanje libc adresa ili zaobiÄ‡i neke odbrane.

Dakle, u osnovi, ovaj napad omoguÄ‡ava da se **prepiÅ¡e proizvoljna adresa velikim brojem** (adresa koja bi mogla biti adresa hrpe ili libc adresa) poput neke adrese steka koja bi mogla biti otkrivena ili neko ograniÄenje poput globalne promenljive **`global_max_fast`** kako bi se omoguÄ‡ilo kreiranje brzih bin binova veÄ‡ih veliÄina (i preÄ‡i sa napada na nesortiranu binarnu hrpu na napad na brzi bin).

{% hint style="success" %}
Pogledajte primer koji je dat na [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#principle](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#principle) i koristeÄ‡i 0x4000 i 0x5000 umesto 0x400 i 0x500 kao veliÄine blokova (kako bi se izbegli tcache-ovi), moguÄ‡e je videti da se **danas** pokreÄ‡e greÅ¡ka **`malloc(): unsorted double linked list corrupted`**.

Stoga, ovaj napad na nesortiranu binarnu hrpu sada (pored ostalih provera) takoÄ‘e zahteva da se moÅ¾e popraviti duplirana povezana lista tako da se zaobiÄ‘e `victim->bck->fd == victim` ili ne `victim->fd == av (arena)`. Å to znaÄi da adresa na koju Å¾elimo da piÅ¡emo mora imati adresu laÅ¾nog bloka na svojoj poziciji `fd` i da laÅ¾ni blok `fd` pokazuje na arenu.
{% endhint %}

{% hint style="danger" %}
Imajte na umu da ovaj napad korumpira nesortiranu binarnu hrpu (takoÄ‘e i male i velike). Zato sada moÅ¾emo **koristiti alokacije iz brzih binova** (kompleksniji program moÅ¾e vrÅ¡iti druge alokacije i ruÅ¡iti se), i da bismo pokrenuli ovo moramo **dodeliti istu veliÄinu ili Ä‡e program pasti**.

Imajte na umu da bi pravljenje **`global_max_fast`** moglo pomoÄ‡i u ovom sluÄaju verujuÄ‡i da Ä‡e brzi bin moÄ‡i da se brine o svim ostalim alokacijama dok se eksploatacija ne zavrÅ¡i.
{% endhint %}

Kod sa [**guyinatuxedo**](https://guyinatuxedo.github.io/31-unsortedbin\_attack/unsorted\_explanation/index.html) objaÅ¡njava to vrlo dobro, iako ako izmenite alokacije da alociraju memoriju dovoljno veliku da ne zavrÅ¡e u tcache-u, moÅ¾ete videti da se pomenuta greÅ¡ka pojavljuje spreÄavajuÄ‡i ovu tehniku: **`malloc(): unsorted double linked list corrupted`**

## Napad na nesortiranu binarnu hrpu za curenje informacija

Ovo je zapravo vrlo osnovan koncept. Blokovi u nesortiranoj binarnoj hrpi Ä‡e imati pokazivaÄe dvostruke pokazivaÄe za kreiranje binova. Prvi blok u nesortiranoj binarnoj hrpi zapravo Ä‡e imati **FD** i **BK** linkove **koji pokazuju na deo glavne arene (libc)**.\
Dakle, ako moÅ¾ete **ubaciti blok unutar nesortirane binarne hrpe i proÄitati ga** (koriÅ¡Ä‡enje nakon oslobaÄ‘anja) ili **ponovo ga alocirati bez prepisivanja bar 1 od pokazivaÄa** da biste ga zatim **proÄitali**, moÅ¾ete imati **curenje libc informacija**.

SliÄan [**napad koriÅ¡Ä‡en u ovom writeup-u**](https://guyinatuxedo.github.io/33-custom\_misc\_heap/csaw18\_alienVSsamurai/index.html), bio je da se zloupotrebi struktura od 4 bloka (A, B, C i D - D je samo da spreÄi konsolidaciju sa vrÅ¡nim blokom) tako da je prelivanje nula bajta u B koriÅ¡Ä‡eno da C pokaÅ¾e da B nije koriÅ¡Ä‡en. TakoÄ‘e, u B je modifikovan podatak `prev_size` tako da veliÄina umesto veliÄine B bude A+B.\
Zatim je C osloboÄ‘en, i konsolidovan sa A+B (ali B je i dalje bio u upotrebi). Alociran je novi blok veliÄine A i zatim su curenje libc adresa napisane u B odakle su procurele.

## Reference i drugi primeri

* [**https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#hitcon-training-lab14-magic-heap**](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#hitcon-training-lab14-magic-heap)
* Cilj je prepisati globalnu promenljivu sa vrednoÅ¡Ä‡u veÄ‡om od 4869 kako bi se mogla dobiti zastava i PIE nije omoguÄ‡en.
* MoguÄ‡e je generisati blokove proizvoljnih veliÄina i postoji prelivanje hrpe sa Å¾eljenom veliÄinom.
* Napad poÄinje kreiranjem 3 bloka: blok0 za zloupotrebu preliva, blok1 za prelivanje i blok2 kako vrÅ¡ni blok ne bi konsolidovao prethodne.
* Zatim, blok1 je osloboÄ‘en i blok0 je preliven tako da pokazivaÄ bk bloka1 pokazuje na: `bk = magic - 0x10`
* Zatim je alociran blok3 iste veliÄine kao blok1, Å¡to Ä‡e pokrenuti napad na nesortiranu binarnu hrpu i izmeniti vrednost globalne promenljive, omoguÄ‡avajuÄ‡i dobijanje zastave.
* [**https://guyinatuxedo.github.io/31-unsortedbin\_attack/0ctf16\_zerostorage/index.html**](https://guyinatuxedo.github.io/31-unsortedbin\_attack/0ctf16\_zerostorage/index.html)
* Funkcija spajanja je ranjiva jer ako su oba prosleÄ‘ena indeksa isti, ponovo Ä‡e alocirati na njemu, a zatim ga osloboditi ali Ä‡e vratiti pokazivaÄ na tu osloboÄ‘enu regiju koja moÅ¾e biti koriÅ¡Ä‡ena.
* Stoga, **kreirana su 2 bloka**: **blok0** koji Ä‡e biti spojen sa samim sobom i blok1 da spreÄi konsolidaciju sa vrÅ¡nim blokom. Zatim je **pozvana funkcija spajanja sa blokom0** dva puta Å¡to Ä‡e izazvati koriÅ¡Ä‡enje nakon oslobaÄ‘anja.
* Zatim je pozvana **`view`** funkcija sa indeksom 2 (koji je indeks bloka koriÅ¡Ä‡enja nakon oslobaÄ‘anja), Å¡to Ä‡e **procureti libc adresu**.
* PoÅ¡to binarni fajl ima zaÅ¡titu da alocira samo veliÄine veÄ‡e od **`global_max_fast`** tako da se ne koristi fastbin, napad na nesortiranu binarnu hrpu Ä‡e biti koriÅ¡Ä‡en da se prepise globalna promenljiva `global_max_fast`.
* Zatim je moguÄ‡e pozvati funkciju za izmenu sa indeksom 2 (pokazivaÄ koriÅ¡Ä‡enja nakon oslobaÄ‘anja) i prepisati pokazivaÄ `bk` da pokazuje na `p64(global_max_fast-0x10)`. Zatim, kreiranjem novog bloka Ä‡e se koristiti prethodno kompromitovana adresa osloboÄ‘enog mesta (0x20) Ä‡e **pokrenuti napad na nesortiranu binarnu hrpu** prepisivanjem `global_max_fast` sa veoma velikom vrednoÅ¡Ä‡u, omoguÄ‡avajuÄ‡i sada kreiranje blokova u brzim binovima.
* Sada se vrÅ¡i **napad na brze binove**:
* Prvo je otkriveno da je moguÄ‡e raditi sa brzim **blokovima veliÄine 200** na lokaciji **`__free_hook`**:
* <pre class="language-c"><code class="lang-c">gefâ¤  p &#x26;__free_hook
$1 = (void (**)(void *, const void *)) 0x7ff1e9e607a8 &#x3C;__free_hook>
gefâ¤  x/60gx 0x7ff1e9e607a8 - 0x59
<strong>0x7ff1e9e6074f: 0x0000000000000000      0x0000000000000200
</strong>0x7ff1e9e6075f: 0x0000000000000000      0x0000000000000000
0x7ff1e9e6076f &#x3C;list_all_lock+15>:      0x0000000000000000      0x0000000000000000
0x7ff1e9e6077f &#x3C;_IO_stdfile_2_lock+15>: 0x0000000000000000      0x0000000000000000
</code></pre>
* Ako uspemo da dobijemo brzi blok veliÄine 0x200 na ovoj lokaciji, biÄ‡e moguÄ‡e prepisati pokazivaÄ funkcije koji Ä‡e biti izvrÅ¡en
* Za to, kreira se novi blok veliÄine `0xfc` i poziva se spojena funkcija sa tim pokazivaÄem dva puta, na taj naÄin dobijamo pokazivaÄ na osloboÄ‘eni blok veliÄine `0xfc*2 = 0x1f8` u brzom binu.
* Zatim se poziva funkcija za ureÄ‘ivanje u ovom bloku kako bi se izmenila adresa **`fd`** ovog brzog bina da pokazuje na prethodnu funkciju **`__free_hook`**.
* Zatim se kreira blok veliÄine `0x1f8` kako bi se iz brzog bina povukao prethodni beskorisni blok, tako da se kreira joÅ¡ jedan blok veliÄine `0x1f8` kako bi se dobio brzi bin blok u **`__free_hook`** koji je prepisan adresom funkcije **`system`**.
* Na kraju se osloboÄ‘uje blok koji sadrÅ¾i string `/bin/sh\x00` pozivom funkcije za brisanje, pokreÄ‡uÄ‡i funkciju **`__free_hook`** koja pokazuje na sistem sa `/bin/sh\x00` kao parametrom.
* **CTF** [**https://guyinatuxedo.github.io/33-custom\_misc\_heap/csaw19\_traveller/index.html**](https://guyinatuxedo.github.io/33-custom\_misc\_heap/csaw19\_traveller/index.html)
* JoÅ¡ jedan primer zloupotrebe prelivanja od 1B kako bi se konsolidovali blokovi u nesortiranom binu i dobila informacija o libc curenju, a zatim izvrÅ¡io napad na brzi bin kako bi se prepisao malloc kuka sa adresom jednog alata
