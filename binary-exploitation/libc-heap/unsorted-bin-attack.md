# SÄ±ralanmamÄ±ÅŸ Bin SaldÄ±rÄ±sÄ±

<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan kahraman olmaya Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong> ile</strong>!</summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini alÄ±n**](https://peass.creator-spring.com)
* [**PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **KatÄ±lÄ±n** ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'da takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na PR gÃ¶ndererek destek olun.

</details>

## Temel Bilgiler

SÄ±ralanmamÄ±ÅŸ bir liste, bir parÃ§anÄ±n `bk` adresine `sÄ±ralanmamÄ±ÅŸ parÃ§alar (av)` adresini yazabilmektedir. Bu nedenle, bir saldÄ±rgan bir parÃ§anÄ±n iÃ§indeki `bk` iÅŸaretÃ§isinin adresini deÄŸiÅŸtirebilirse, bu adresi rastgele bir adrese yazabilir ve bu, bir Glibc adresini sÄ±zdÄ±rmak veya bazÄ± savunmalarÄ± atlamak iÃ§in faydalÄ± olabilir.

Bu saldÄ±rÄ± temelde, bir rastgele adreste bÃ¼yÃ¼k bir sayÄ± **ayarlamayÄ±** saÄŸlar. Bu bÃ¼yÃ¼k sayÄ±, bir heap adresi veya bir Glibc adresi olabilir. Tipik bir hedef, **`global_max_fast`**'Ä±n daha bÃ¼yÃ¼k boyutlarda hÄ±zlÄ± bin parÃ§alarÄ± oluÅŸturmasÄ±na izin vermek (ve sÄ±ralanmamÄ±ÅŸ bir bin saldÄ±rÄ±sÄ±ndan hÄ±zlÄ± bir bin saldÄ±rÄ±sÄ±na geÃ§mek).

{% hint style="success" %}
[https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#principle](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#principle) adresinde saÄŸlanan Ã¶rneÄŸe bakarak ve 0x400 ve 0x500 yerine 0x4000 ve 0x5000 kullanarak (Tcache'i Ã¶nlemek iÃ§in) **gÃ¼nÃ¼mÃ¼zde** hata **`malloc(): sÄ±ralanmamÄ±ÅŸ Ã§ift baÄŸlantÄ±lÄ± liste bozuldu`** tetiklenir.

Bu nedenle, bu sÄ±ralanmamÄ±ÅŸ bin saldÄ±rÄ±sÄ± artÄ±k (diÄŸer kontroller arasÄ±nda) Ã§ift baÄŸlantÄ±lÄ± listeyi dÃ¼zeltme yeteneÄŸine de sahip olmalÄ±dÄ±r, bÃ¶ylece bu, `victim->bk->fd == victim` veya `victim->fd == av (arena)` olmalÄ±dÄ±r, yani yazmak istediÄŸimiz adresin, sahte parÃ§anÄ±n `fd` konumunda olmasÄ± ve sahte parÃ§anÄ±n `fd`nin arenaya iÅŸaret etmesi gerekmektedir.
{% endhint %}

{% hint style="danger" %}
Bu saldÄ±rÄ± sÄ±ralanmamÄ±ÅŸ binleri bozar (bu nedenle kÃ¼Ã§Ã¼k ve bÃ¼yÃ¼kleri de). Bu nedenle ÅŸimdi sadece **hÄ±zlÄ± binlerden tahsisleri kullanabiliriz** (daha karmaÅŸÄ±k bir program baÅŸka tahsisler yapabilir ve Ã§Ã¶kebilir) ve bunu tetiklemek iÃ§in **aynÄ± boyutta tahsis yapmalÄ±yÄ±z veya program Ã§Ã¶ker.**

Bu durumda **`global_max_fast`**'Ä±n Ã¼zerine yazÄ±lmasÄ± bu durumda yardÄ±mcÄ± olabilir, hÄ±zlÄ± binin tÃ¼m diÄŸer tahsislerle ilgilenebileceÄŸine gÃ¼venerek, saldÄ±rÄ± tamamlandÄ±ÄŸÄ±nda.
{% endhint %}

[**guyinatuxedo**](https://guyinatuxedo.github.io/31-unsortedbin\_attack/unsorted\_explanation/index.html) tarafÄ±ndan saÄŸlanan kod bunu Ã§ok iyi aÃ§Ä±klar, ancak malloc'larÄ± Tcache'e sona ermeyecek kadar bÃ¼yÃ¼k bir bellek tahsis etmek iÃ§in deÄŸiÅŸtirirseniz, Ã¶nce bahsedilen hata ortaya Ã§Ä±kar ve bu teknik engellenir: **`malloc(): sÄ±ralanmamÄ±ÅŸ Ã§ift baÄŸlantÄ±lÄ± liste bozuldu`**

## SÄ±ralanmamÄ±ÅŸ Bin Bilgi SÄ±zdÄ±rma SaldÄ±rÄ±sÄ±

Bu aslÄ±nda Ã§ok temel bir kavramdÄ±r. SÄ±ralanmamÄ±ÅŸ binlerdeki parÃ§alarÄ±n iÅŸaretÃ§ilere sahip olacaÄŸÄ±. SÄ±ralanmamÄ±ÅŸ bindeki ilk parÃ§a aslÄ±nda **`fd`** ve **`bk`** baÄŸlantÄ±larÄ±nÄ± **ana arenanÄ±n bir kÄ±smÄ±na (Glibc)** iÅŸaret edecektir.\
Bu nedenle, bir parÃ§ayÄ± sÄ±ralanmamÄ±ÅŸ bir bine koyabilir ve onu okuyabilirsiniz (kullanÄ±mdan sonra serbest bÄ±rakma) veya **en azÄ±ndan iÅŸaretÃ§ilerden birini Ã¼zerine yazmadan tekrar tahsis edebilir** ve ardÄ±ndan **okuyabilirsiniz**, bir **Glibc bilgi sÄ±zÄ±ntÄ±sÄ±** elde edebilirsiniz.

Bu yazÄ±da kullanÄ±lan benzer bir [**saldÄ±rÄ±**](https://guyinatuxedo.github.io/33-custom\_misc\_heap/csaw18\_alienVSsamurai/index.html), 4 parÃ§alÄ± bir yapÄ±yÄ± (A, B, C ve D - D yalnÄ±zca Ã¼st parÃ§ayla birleÅŸmeyi Ã¶nlemek iÃ§in) kÃ¶tÃ¼ye kullanmaktÄ±, bÃ¶ylece B'de bir null bayt taÅŸmasÄ± kullanÄ±larak C'nin B'nin kullanÄ±lmadÄ±ÄŸÄ±nÄ± belirtmesi saÄŸlandÄ±. AyrÄ±ca, B'de `prev_size` verisi deÄŸiÅŸtirildi, bÃ¶ylece boyut, B'nin boyutu yerine A+B oldu.\
ArdÄ±ndan C serbest bÄ±rakÄ±ldÄ± ve A+B ile birleÅŸtirildi (ancak B hala kullanÄ±mda idi). A boyutunda yeni bir parÃ§a tahsis edildi ve ardÄ±ndan sÄ±zdÄ±rÄ±lan libc adresleri B'ye yazÄ±ldÄ± ve oradan sÄ±zdÄ±rÄ±ldÄ±.

## Referanslar ve DiÄŸer Ã–rnekler

* [**https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#hitcon-training-lab14-magic-heap**](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#hitcon-training-lab14-magic-heap)
* AmaÃ§, bir global deÄŸiÅŸkeni 4869'dan bÃ¼yÃ¼k bir deÄŸerle Ã¼zerine yazmaktÄ±r, bÃ¶ylece bayraÄŸÄ± almak mÃ¼mkÃ¼n olur ve PIE etkin deÄŸildir.
* Rastgele boyutlarda parÃ§alar oluÅŸturulabilir ve istenilen boyutta bir bellek taÅŸmasÄ± vardÄ±r.
* SaldÄ±rÄ±, 3 parÃ§a oluÅŸturarak baÅŸlar: taÅŸmayÄ± kÃ¶tÃ¼ye kullanmak iÃ§in chunk0, taÅŸmayla karÅŸÄ±laÅŸacak chunk1 ve Ã¶nceki parÃ§alarÄ±n birleÅŸmesini Ã¶nlemek iÃ§in chunk2.
* ArdÄ±ndan, chunk1 serbest bÄ±rakÄ±lÄ±r ve chunk0 taÅŸar, bÃ¶ylece chunk1'in `bk` iÅŸaretÃ§isi ÅŸuna iÅŸaret eder: `bk = magic - 0x10`
* ArdÄ±ndan, chunk1 ile aynÄ± boyutta chunk3 tahsis edilir, bu da sÄ±ralanmamÄ±ÅŸ bin saldÄ±rÄ±sÄ±nÄ± tetikler ve global deÄŸiÅŸkenin deÄŸerini deÄŸiÅŸtirir, bayraÄŸÄ± almayÄ± mÃ¼mkÃ¼n kÄ±lar.
* [**https://guyinatuxedo.github.io/31-unsortedbin\_attack/0ctf16\_zerostorage/index.html**](https://guyinatuxedo.github.io/31-unsortedbin\_attack/0ctf16\_zerostorage/index.html)
* BirleÅŸtirme iÅŸlevi, geÃ§ilen her iki dizin de aynÄ± olduÄŸunda onu yeniden boyutlandÄ±racaÄŸÄ± ve ardÄ±ndan serbest bÄ±rakacaÄŸÄ± ancak o serbest bÄ±rakÄ±lan bÃ¶lgeye bir iÅŸaretÃ§i dÃ¶ndÃ¼receÄŸi iÃ§in savunmasÄ±zdÄ±r.
* Bu nedenle, **2 parÃ§a oluÅŸturulur**: **chunk0** kendisiyle birleÅŸtirilecek ve Ã¼st parÃ§ayla birleÅŸmesini Ã¶nlemek iÃ§in chunk1. ArdÄ±ndan, **birleÅŸtirme iÅŸlevi chunk0 ile iki kez Ã§aÄŸrÄ±lÄ±r**, bu da kullanÄ±mdan sonra serbest bÄ±rakma hatasÄ±na neden olur.
* ArdÄ±ndan, **`view`** iÅŸlevi, kullanÄ±mdan sonra serbest bÄ±rakma parÃ§asÄ±nÄ±n dizini olan 2 ile Ã§aÄŸrÄ±lÄ±r, bu da bir libc adresi **sÄ±zdÄ±rÄ±r**.
* Binary, sadece **`global_max_fast`**'ten bÃ¼yÃ¼k malloc boyutlarÄ± yapmasÄ±na izin veren korumalara sahip olduÄŸundan, hÄ±zlÄ± bin kullanÄ±lmaz, bu nedenle sÄ±ralanmamÄ±ÅŸ bin saldÄ±rÄ±sÄ±, global deÄŸiÅŸken `global_max_fast`'Ä±n Ã¼zerine yazmak iÃ§in kullanÄ±lacaktÄ±r.
* ArdÄ±ndan, kullanÄ±mdan sonra serbest bÄ±rakma iÅŸaretÃ§isi olan dizin 2 ile edit iÅŸlevi Ã§aÄŸrÄ±labilir ve `bk` iÅŸaretÃ§isinin `p64(global_max_fast-0x10)`'a iÅŸaret etmesi saÄŸlanabilir. ArdÄ±ndan, yeni bir parÃ§a oluÅŸturulduÄŸunda Ã¶nceki tehlikeye atÄ±fta bulunan serbest bÄ±rakma adresi (0x20) kullanÄ±lacak ve **sÄ±ralanmamÄ±ÅŸ bin saldÄ±rÄ±sÄ± tetiklenecek**, `global_max_fast`'Ä± Ã§ok bÃ¼yÃ¼k bir deÄŸerle Ã¼zerine yazarak artÄ±k hÄ±zlÄ± binlerde parÃ§alar oluÅŸturulabilir.
* Åimdi bir **hÄ±zlÄ± bin saldÄ±rÄ±sÄ±** gerÃ§ekleÅŸtirilir:
* Ä°lk olarak, **`__free_hook`** konumunda **200 boyutunda hÄ±zlÄ± parÃ§alarla Ã§alÄ±ÅŸÄ±labileceÄŸi keÅŸfedilir**:
* <pre class="language-c"><code class="lang-c">gefâ¤  p &#x26;__free_hook
$1 = (void (**)(void *, const void *)) 0x7ff1e9e607a8 &#x3C;__free_hook>
gefâ¤  x/60gx 0x7ff1e9e607a8 - 0x59
<strong>0x7ff1e9e6074f: 0x0000000000000000      0x0000000000000200
</strong>0x7ff1e9e6075f: 0x0000000000000000      0x0000000000000000
0x7ff1e9e6076f &#x3C;list_all_lock+15>:      0x0000000000000000      0x0000000000000000
0x7ff1e9e6077f &#x3C;_IO_stdfile_2_lock+15>: 0x0000000000000000      0x0000000000000000
</code></pre>
* EÄŸer bu konumda 0x200 boyutunda hÄ±zlÄ± bir parÃ§a elde edebilirsek, Ã§alÄ±ÅŸtÄ±rÄ±lacak bir fonksiyon iÅŸaretÃ§isini Ã¼zerine yazmak mÃ¼mkÃ¼n olacaktÄ±r
* Bunun iÃ§in, `0xfc` boyutunda yeni bir parÃ§a oluÅŸturulur ve birleÅŸtirilmiÅŸ fonksiyon bu iÅŸaretÃ§iyle iki kez Ã§aÄŸrÄ±lÄ±r, bu ÅŸekilde hÄ±zlÄ± binde boyutu `0xfc*2 = 0x1f8` olan bir serbest bÄ±rakÄ±lmÄ±ÅŸ parÃ§anÄ±n iÅŸaretÃ§isine ulaÅŸÄ±lÄ±r.
* ArdÄ±ndan, bu parÃ§ada **`fd`** adresini Ã¶nceki **`__free_hook`** fonksiyonuna iÅŸaret etmek iÃ§in dÃ¼zenleme fonksiyonu Ã§aÄŸrÄ±lÄ±r.
* Daha sonra, hÄ±zlÄ± bindeki Ã¶nceki gereksiz parÃ§ayÄ± almak iÃ§in boyutu `0x1f8` olan bir parÃ§a oluÅŸturulur, bÃ¶ylece **`__free_hook`** iÃ§inde **`system`** fonksiyonunun adresiyle Ã¼zerine yazÄ±lmÄ±ÅŸ bir hÄ±zlÄ± bin parÃ§asÄ± alÄ±nÄ±r.
* Ve son olarak, `/bin/sh\x00` dizesini iÃ§eren bir parÃ§a serbest bÄ±rakÄ±larak silme fonksiyonu Ã§aÄŸrÄ±lÄ±r, **`__free_hook`** fonksiyonunu tetikleyerek `/bin/sh\x00` parametresiyle `system` fonksiyonuna iÅŸaret etmesi saÄŸlanÄ±r.
* **CTF** [**https://guyinatuxedo.github.io/33-custom\_misc\_heap/csaw19\_traveller/index.html**](https://guyinatuxedo.github.io/33-custom\_misc\_heap/csaw19\_traveller/index.html)
* Unsorted binde parÃ§alarÄ± birleÅŸtirmek iÃ§in 1B taÅŸma kullanarak libc bilgi sÄ±zdÄ±rma ve ardÄ±ndan malloc hook'u bir gadget adresiyle Ã¼zerine yazmak iÃ§in hÄ±zlÄ± bin saldÄ±rÄ±sÄ±nÄ± kÃ¶tÃ¼ye kullanmanÄ±n baÅŸka bir Ã¶rneÄŸi
* [**Robot Factory. BlackHat MEA CTF 2022**](https://7rocky.github.io/en/ctf/other/blackhat-ctf/robot-factory/)
* Sadece `0x100` boyutundan bÃ¼yÃ¼k parÃ§alar tahsis edebiliriz.
* Unsorted Bin saldÄ±rÄ±sÄ± kullanarak `global_max_fast` Ã¼zerine yazma (ASLR nedeniyle 1/16 kez Ã§alÄ±ÅŸÄ±r, Ã§Ã¼nkÃ¼ 12 biti deÄŸiÅŸtirmemiz gerekiyor, ancak 16 biti deÄŸiÅŸtirmemiz gerekiyor).
* Global bir parÃ§a dizisini deÄŸiÅŸtirmek iÃ§in HÄ±zlÄ± Bin saldÄ±rÄ±sÄ±. Bu, GOT'u deÄŸiÅŸtirmeye ve bazÄ± fonksiyonlarÄ± `system`'e iÅŸaret etmeye olanak tanÄ±yan bir keyfi okuma/yazma ilkesi saÄŸlar.
