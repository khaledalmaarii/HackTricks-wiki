# BROP - ç›²è¿”å›å¯¼å‘ç¼–ç¨‹

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

æ­¤æ”»å‡»çš„ç›®æ ‡æ˜¯èƒ½å¤Ÿ**åˆ©ç”¨ç¼“å†²åŒºæº¢å‡ºæ»¥ç”¨ ROPï¼Œè€Œæ— éœ€æœ‰å…³æ˜“å—æ”»å‡»çš„äºŒè¿›åˆ¶æ–‡ä»¶çš„ä»»ä½•ä¿¡æ¯**ã€‚\
æ­¤æ”»å‡»åŸºäºä»¥ä¸‹æƒ…æ™¯ï¼š

* ä¸€ä¸ªå †æ ˆæ¼æ´å’Œå¦‚ä½•è§¦å‘å®ƒçš„çŸ¥è¯†ã€‚
* ä¸€ä¸ªåœ¨å´©æºƒåé‡æ–°å¯åŠ¨çš„æœåŠ¡å™¨åº”ç”¨ç¨‹åºã€‚

## æ”»å‡»

### **1. æ‰¾åˆ°æ˜“å—æ”»å‡»çš„åç§»é‡**å‘é€ä¸€ä¸ªé¢å¤–å­—ç¬¦ï¼Œç›´åˆ°æ£€æµ‹åˆ°æœåŠ¡å™¨çš„æ•…éšœ

### **2. æš´åŠ›ç ´è§£ canary** ä»¥æ³„æ¼å®ƒ

### **3. æš´åŠ›ç ´è§£å­˜å‚¨çš„ RBP å’Œ RIP** åœ°å€ä»¥æ³„æ¼å®ƒä»¬

æ‚¨å¯ä»¥åœ¨[è¿™é‡Œï¼ˆBF åˆ†å‰å’Œçº¿ç¨‹åŒ–å †æ ˆ Canaryï¼‰](../common-binary-protections-and-bypasses/stack-canaries/bf-forked-stack-canaries.md)å’Œ[è¿™é‡Œï¼ˆBF åœ°å€åœ¨å †æ ˆä¸­ï¼‰](../common-binary-protections-and-bypasses/pie/bypassing-canary-and-pie.md)æ‰¾åˆ°æœ‰å…³è¿™äº›è¿‡ç¨‹çš„æ›´å¤šä¿¡æ¯ã€‚

### **4. æ‰¾åˆ°åœæ­¢å°å·¥å…·**

è¿™ä¸ªå°å·¥å…·åŸºæœ¬ä¸Šå…è®¸ç¡®è®¤é€šè¿‡ ROP å°å·¥å…·æ‰§è¡Œäº†ä¸€äº›æœ‰è¶£çš„å†…å®¹ï¼Œå› ä¸ºæ‰§è¡Œæ²¡æœ‰å´©æºƒã€‚é€šå¸¸ï¼Œè¿™ä¸ªå°å·¥å…·å°†æ˜¯**åœæ­¢æ‰§è¡Œ**çš„ä¸œè¥¿ï¼Œå¹¶ä¸”å½“å¯»æ‰¾ç”¨äºç¡®è®¤ç‰¹å®š ROP å°å·¥å…·æ˜¯å¦è¢«æ‰§è¡Œçš„ ROP å°å·¥å…·æ—¶ï¼Œå®ƒä½äº ROP é“¾çš„æœ«å°¾ã€‚

### **5. æ‰¾åˆ° BROP å°å·¥å…·**

æ­¤æŠ€æœ¯ä½¿ç”¨ [**ret2csu**](ret2csu.md) å°å·¥å…·ã€‚è¿™æ˜¯å› ä¸ºå¦‚æœåœ¨ä¸€äº›æŒ‡ä»¤ä¸­è®¿é—®æ­¤å°å·¥å…·ï¼Œæ‚¨å°†è·å¾—æ§åˆ¶ **`rsi`** å’Œ **`rdi`** çš„å°å·¥å…·ï¼š

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" width="278"><figcaption><p><a href="https://www.scs.stanford.edu/brop/bittau-brop.pdf">https://www.scs.stanford.edu/brop/bittau-brop.pdf</a></p></figcaption></figure>

è¿™äº›å°†æ˜¯å°å·¥å…·ï¼š

* `pop rsi; pop r15; ret`
* `pop rdi; ret`

è¯·æ³¨æ„ï¼Œä½¿ç”¨è¿™äº›å°å·¥å…·å¯ä»¥**æ§åˆ¶å‡½æ•°çš„ 2 ä¸ªå‚æ•°**ã€‚

è¿˜è¦æ³¨æ„ï¼Œret2csu å°å·¥å…·å…·æœ‰**éå¸¸ç‹¬ç‰¹çš„ç­¾å**ï¼Œå› ä¸ºå®ƒå°†ä»å †æ ˆä¸­å¼¹å‡º 6 ä¸ªå¯„å­˜å™¨ã€‚å› æ­¤ï¼Œå‘é€å¦‚ä¸‹é“¾ï¼š

`'A' * åç§»é‡ + canary + rbp + åœ°å€ + 0xdead * 6 + STOP`

å¦‚æœ**æ‰§è¡Œäº† STOP**ï¼Œè¿™åŸºæœ¬ä¸Šæ„å‘³ç€ä½¿ç”¨äº†ä¸€ä¸ª**ä»å †æ ˆä¸­å¼¹å‡º 6 ä¸ªå¯„å­˜å™¨**çš„åœ°å€ã€‚æˆ–è€…ä½¿ç”¨çš„åœ°å€ä¹Ÿæ˜¯ä¸€ä¸ª STOP åœ°å€ã€‚

ä¸ºäº†**æ¶ˆé™¤è¿™ç§å¯èƒ½æ€§**ï¼Œæ‰§è¡Œä¸€ä¸ªæ–°é“¾å¦‚ä¸‹ï¼Œå¹¶ä¸”å¿…é¡»ä¸æ‰§è¡Œ STOP å°å·¥å…·ä»¥ç¡®è®¤ä¹‹å‰çš„é“¾ç¡®å®å¼¹å‡ºäº† 6 ä¸ªå¯„å­˜å™¨ï¼š

`'A' * åç§»é‡ + canary + rbp + åœ°å€`

çŸ¥é“ ret2csu å°å·¥å…·çš„åœ°å€åï¼Œå°±å¯ä»¥**æ¨æ–­å‡ºæ§åˆ¶ `rsi` å’Œ `rdi` çš„å°å·¥å…·çš„åœ°å€**ã€‚

### 6. æ‰¾åˆ° PLT

PLT è¡¨å¯ä»¥ä» 0x400000 æˆ–ä»å †æ ˆä¸­çš„**æ³„æ¼ RIP åœ°å€**ï¼ˆå¦‚æœä½¿ç”¨äº† **PIE**ï¼‰å¼€å§‹æœç´¢ã€‚è¡¨çš„**æ¡ç›®**ä»¥ 16Bï¼ˆ0x10Bï¼‰åˆ†éš”ï¼Œå½“è°ƒç”¨ä¸€ä¸ªå‡½æ•°æ—¶ï¼Œå³ä½¿å‚æ•°ä¸æ­£ç¡®ï¼ŒæœåŠ¡å™¨ä¹Ÿä¸ä¼šå´©æºƒã€‚æ­¤å¤–ï¼Œæ£€æŸ¥ PLT ä¸­çš„ä¸€ä¸ªæ¡ç›®çš„åœ°å€ + 6B ä¹Ÿä¸ä¼šå´©æºƒï¼Œå› ä¸ºè¿™æ˜¯ç¬¬ä¸€ä¸ªæ‰§è¡Œçš„ä»£ç ã€‚

å› æ­¤ï¼Œå¯ä»¥é€šè¿‡æ£€æŸ¥ä»¥ä¸‹è¡Œä¸ºæ¥æ‰¾åˆ° PLT è¡¨ï¼š

* `'A' * åç§»é‡ + canary + rbp + åœ°å€ + STOP` -> æ— å´©æºƒ
* `'A' * åç§»é‡ + canary + rbp + (åœ°å€ + 0x6) + STOP` -> æ— å´©æºƒ
* `'A' * åç§»é‡ + canary + rbp + (åœ°å€ + 0x10) + STOP` -> æ— å´©æºƒ

### 7. æŸ¥æ‰¾ strcmp

**`strcmp`** å‡½æ•°å°†å¯„å­˜å™¨ **`rdx`** è®¾ç½®ä¸ºæ­£åœ¨æ¯”è¾ƒçš„å­—ç¬¦ä¸²çš„é•¿åº¦ã€‚è¯·æ³¨æ„ï¼Œ**`rdx`** æ˜¯ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œæˆ‘ä»¬éœ€è¦å®ƒå¤§äº 0ï¼Œä»¥ä¾¿ç¨åä½¿ç”¨ `write` æ³„æ¼ç¨‹åºã€‚

å¯ä»¥æ ¹æ®å…¶è¡Œä¸ºåœ¨ PLT ä¸­æ‰¾åˆ° **`strcmp`** çš„ä½ç½®ï¼Œåˆ©ç”¨æˆ‘ä»¬ç°åœ¨å¯ä»¥æ§åˆ¶å‡½æ•°çš„å‰ä¸¤ä¸ªå‚æ•°çš„äº‹å®ï¼š

* strcmp(\<éè¯»å–åœ°å€>, \<éè¯»å–åœ°å€>) -> å´©æºƒ
* strcmp(\<éè¯»å–åœ°å€>, \<è¯»å–åœ°å€>) -> å´©æºƒ
* strcmp(\<è¯»å–åœ°å€>, \<éè¯»å–åœ°å€>) -> å´©æºƒ
* strcmp(\<è¯»å–åœ°å€>, \<è¯»å–åœ°å€>) -> æ— å´©æºƒ

å¯ä»¥é€šè¿‡è°ƒç”¨ PLT è¡¨çš„æ¯ä¸ªæ¡ç›®æˆ–ä½¿ç”¨**PLT æ…¢è·¯å¾„**æ¥æ£€æŸ¥è¿™ä¸€ç‚¹ï¼Œè¯¥æ…¢è·¯å¾„åŸºæœ¬ä¸ŠåŒ…æ‹¬è°ƒç”¨ PLT è¡¨ä¸­çš„ä¸€ä¸ªæ¡ç›® + 0xbï¼ˆè°ƒç”¨åˆ° **`dlresolve`**ï¼‰ï¼Œç„¶ååœ¨å †æ ˆä¸­è·Ÿéšå¸Œæœ›æ¢æµ‹çš„æ¡ç›®å·ï¼ˆä»é›¶å¼€å§‹ï¼‰ä»¥æ‰«ææ‰€æœ‰ PLT æ¡ç›®ï¼š

* strcmp(\<éè¯»å–åœ°å€>, \<è¯»å–åœ°å€>) -> å´©æºƒ
* `b'A' * åç§»é‡ + canary + rbp + (BROP + 0x9) + RIP + (BROP + 0x7) + p64(0x300) + p64(0x0) + (PLT + 0xb ) + p64(ENTRY) + STOP` -> å°†å´©æºƒ
* strcmp(\<è¯»å–åœ°å€>, \<éè¯»å–åœ°å€>) -> å´©æºƒ
* `b'A' * åç§»é‡ + canary + rbp + (BROP + 0x9) + p64(0x300) + (BROP + 0x7) + RIP + p64(0x0) + (PLT + 0xb ) + p64(ENTRY) + STOP`&#x20;
* strcmp(\<è¯»å–åœ°å€>, \<è¯»å–åœ°å€>) -> æ— å´©æºƒ
* `b'A' * åç§»é‡ + canary + rbp + (BROP + 0x9) + RIP + (BROP + 0x7) + RIP + p64(0x0) + (PLT + 0xb ) + p64(ENTRY) + STOP`&#x20;

è¯·è®°ä½ï¼š

* BROP + 0x7 æŒ‡å‘ **`pop RSI; pop R15; ret;`**
* BROP + 0x9 æŒ‡å‘ **`pop RDI; ret;`**
* PLT + 0xb æŒ‡å‘è°ƒç”¨ **dl\_resolve**ã€‚

æ‰¾åˆ° `strcmp` åï¼Œå°±å¯ä»¥å°† **`rdx`** è®¾ç½®ä¸ºå¤§äº 0 çš„å€¼ã€‚

{% hint style="success" %}
è¯·æ³¨æ„ï¼Œé€šå¸¸ `rdx` å°†å·²ç»åŒ…å«ä¸€ä¸ªå¤§äº 0 çš„å€¼ï¼Œå› æ­¤æ­¤æ­¥éª¤å¯èƒ½ä¸æ˜¯å¿…è¦çš„ã€‚
{% endhint %}
### 8. å¯»æ‰¾Writeå‡½æ•°æˆ–ç­‰æ•ˆå‡½æ•°

æœ€åï¼Œéœ€è¦ä¸€ä¸ªç”¨äºå¤–æ³„æ•°æ®ä»¥å¤–æ³„äºŒè¿›åˆ¶æ–‡ä»¶çš„gadgetã€‚æ­¤æ—¶å¯ä»¥**æ§åˆ¶2ä¸ªå‚æ•°å¹¶è®¾ç½®`rdx`å¤§äº0**ã€‚

æœ‰3ä¸ªå¸¸è§çš„å‡½æ•°å¯ä»¥è¢«æ»¥ç”¨ï¼š

- `puts(data)`
- `dprintf(fd, data)`
- `write(fd, data, len(data)`

ç„¶è€Œï¼ŒåŸå§‹è®ºæ–‡åªæåˆ°äº†**`write`**å‡½æ•°ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬æ¥è°ˆè°ˆå®ƒï¼š

å½“å‰é—®é¢˜æ˜¯æˆ‘ä»¬ä¸çŸ¥é“**writeå‡½æ•°åœ¨PLTä¸­çš„ä½ç½®**ï¼Œä¹Ÿä¸çŸ¥é“**è¦å°†æ•°æ®å‘é€åˆ°æˆ‘ä»¬çš„å¥—æ¥å­—çš„fdå·**ã€‚

ä½†æ˜¯ï¼Œæˆ‘ä»¬çŸ¥é“**PLTè¡¨çš„ä½ç½®**ï¼Œå¯ä»¥æ ¹æ®å…¶**è¡Œä¸º**æ‰¾åˆ°writeã€‚æˆ‘ä»¬å¯ä»¥ä¸æœåŠ¡å™¨åˆ›å»º**å¤šä¸ªè¿æ¥**ï¼Œå¹¶ä½¿ç”¨**é«˜FD**ï¼Œå¸Œæœ›å®ƒä¸æˆ‘ä»¬çš„æŸäº›è¿æ¥åŒ¹é…ã€‚

æŸ¥æ‰¾è¿™äº›å‡½æ•°çš„è¡Œä¸ºç‰¹å¾ï¼š

- `'A' * offset + canary + rbp + (BROP + 0x9) + RIP + (BROP + 0x7) + p64(0) + p64(0) + (PLT + 0xb) + p64(ENTRY) + STOP`  -> å¦‚æœæœ‰æ•°æ®æ‰“å°å‡ºæ¥ï¼Œåˆ™æ‰¾åˆ°äº†puts
- `'A' * offset + canary + rbp + (BROP + 0x9) + FD + (BROP + 0x7) + RIP + p64(0x0) + (PLT + 0xb) + p64(ENTRY) + STOP`  -> å¦‚æœæœ‰æ•°æ®æ‰“å°å‡ºæ¥ï¼Œåˆ™æ‰¾åˆ°äº†dprintf
- `'A' * offset + canary + rbp + (BROP + 0x9) + RIP + (BROP + 0x7) + (RIP + 0x1) + p64(0x0) + (PLT + 0xb ) + p64(STRCMP ENTRY) + (BROP + 0x9) + FD + (BROP + 0x7) + RIP + p64(0x0) + (PLT + 0xb) + p64(ENTRY) + STOP`  -> å¦‚æœæœ‰æ•°æ®æ‰“å°å‡ºæ¥ï¼Œåˆ™æ‰¾åˆ°äº†write

## è‡ªåŠ¨åŒ–åˆ©ç”¨

* [https://github.com/Hakumarachi/Bropper](https://github.com/Hakumarachi/Bropper)

## å‚è€ƒèµ„æ–™

* åŸå§‹è®ºæ–‡: [https://www.scs.stanford.edu/brop/bittau-brop.pdf](https://www.scs.stanford.edu/brop/bittau-brop.pdf)
* [https://www.ctfrecipes.com/pwn/stack-exploitation/arbitrary-code-execution/code-reuse-attack/blind-return-oriented-programming-brop](https://www.ctfrecipes.com/pwn/stack-exploitation/arbitrary-code-execution/code-reuse-attack/blind-return-oriented-programming-brop)
