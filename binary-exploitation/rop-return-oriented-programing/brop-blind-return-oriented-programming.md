# BROP - ç›²è¿”å›å¯¼å‘ç¼–ç¨‹

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWSçº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[NFT](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## åŸºæœ¬ä¿¡æ¯

æ­¤æ”»å‡»çš„ç›®æ ‡æ˜¯èƒ½å¤Ÿ**åˆ©ç”¨ROPé€šè¿‡ç¼“å†²åŒºæº¢å‡ºè€Œæ— éœ€æœ‰å…³æ˜“å—æ”»å‡»çš„äºŒè¿›åˆ¶æ–‡ä»¶çš„ä»»ä½•ä¿¡æ¯**ã€‚\
æ­¤æ”»å‡»åŸºäºä»¥ä¸‹æƒ…æ™¯ï¼š

* å­˜åœ¨å †æ ˆæ¼æ´å¹¶ä¸”çŸ¥é“å¦‚ä½•è§¦å‘å®ƒã€‚
* ä¸€ä¸ªåœ¨å´©æºƒåé‡æ–°å¯åŠ¨çš„æœåŠ¡å™¨åº”ç”¨ç¨‹åºã€‚

## æ”»å‡»

### **1. æŸ¥æ‰¾æ˜“å—æ”»å‡»çš„åç§»é‡**ï¼Œå‘é€ä¸€ä¸ªé¢å¤–å­—ç¬¦ç›´åˆ°æ£€æµ‹åˆ°æœåŠ¡å™¨å‘ç”Ÿæ•…éšœ

### **2. æš´åŠ›ç ´è§£canary** ä»¥æ³„æ¼å®ƒ

### **3. æš´åŠ›ç ´è§£å­˜å‚¨çš„RBPå’ŒRIP**åœ°å€ä»¥æ³„æ¼å®ƒä»¬

æ‚¨å¯ä»¥åœ¨[è¿™é‡Œï¼ˆBFåˆ†å‰å’Œçº¿ç¨‹åŒ–å †æ ˆCanariesï¼‰](../common-binary-protections-and-bypasses/stack-canaries/bf-forked-stack-canaries.md)å’Œ[è¿™é‡Œï¼ˆBFåœ°å€åœ¨å †æ ˆä¸­ï¼‰](../common-binary-protections-and-bypasses/pie/bypassing-canary-and-pie.md)æ‰¾åˆ°æœ‰å…³è¿™äº›è¿‡ç¨‹çš„æ›´å¤šä¿¡æ¯ã€‚

### **4. æŸ¥æ‰¾åœæ­¢gadget**

è¿™ä¸ªgadgetåŸºæœ¬ä¸Šå…è®¸ç¡®è®¤é€šè¿‡ROP gadgetæ‰§è¡Œäº†ä¸€äº›æœ‰è¶£çš„æ“ä½œï¼Œå› ä¸ºæ‰§è¡Œæ²¡æœ‰å´©æºƒã€‚é€šå¸¸ï¼Œè¿™ä¸ªgadgetå°†æ˜¯ä¸€äº›**åœæ­¢æ‰§è¡Œ**çš„å†…å®¹ï¼Œå¹¶ä¸”å½“å¯»æ‰¾ROP gadgetä»¥ç¡®è®¤ç‰¹å®šROP gadgetå·²æ‰§è¡Œæ—¶ï¼Œå®ƒå°†ä½äºROPé“¾çš„æœ«å°¾ã€‚

### **5. æŸ¥æ‰¾BROP gadget**

æ­¤æŠ€æœ¯ä½¿ç”¨[**ret2csu**](ret2csu.md) gadgetã€‚è¿™æ˜¯å› ä¸ºå¦‚æœåœ¨ä¸€äº›æŒ‡ä»¤ä¸­è®¿é—®æ­¤gadgetï¼Œåˆ™å¯ä»¥è·å¾—æ§åˆ¶**`rsi`**å’Œ**`rdi`**çš„gadgetsï¼š

<figure><img src="../../.gitbook/assets/image (1).png" alt="" width="278"><figcaption><p><a href="https://www.scs.stanford.edu/brop/bittau-brop.pdf">https://www.scs.stanford.edu/brop/bittau-brop.pdf</a></p></figcaption></figure>

è¿™äº›å°†æ˜¯gadgetsï¼š

* `pop rsi; pop r15; ret`
* `pop rdi; ret`

è¯·æ³¨æ„ï¼Œä½¿ç”¨è¿™äº›gadgetså¯ä»¥**æ§åˆ¶å‡½æ•°çš„2ä¸ªå‚æ•°**ã€‚

è¿˜è¦æ³¨æ„ï¼Œret2csu gadgetå…·æœ‰**éå¸¸ç‹¬ç‰¹çš„ç­¾å**ï¼Œå› ä¸ºå®ƒå°†ä»å †æ ˆä¸­å¼¹å‡º6ä¸ªå¯„å­˜å™¨ã€‚å› æ­¤ï¼Œå‘é€å¦‚ä¸‹é“¾ï¼š

`'A' * åç§»é‡ + canary + rbp + ADDR + 0xdead * 6 + STOP`

å¦‚æœ**æ‰§è¡ŒSTOP**ï¼Œè¿™åŸºæœ¬ä¸Šæ„å‘³ç€ä½¿ç”¨äº†ä¸€ä¸ªä»å †æ ˆä¸­å¼¹å‡º6ä¸ªå¯„å­˜å™¨çš„åœ°å€ã€‚æˆ–è€…ä½¿ç”¨çš„åœ°å€ä¹Ÿæ˜¯ä¸€ä¸ªSTOPåœ°å€ã€‚

ä¸ºäº†**æ’é™¤è¿™ç§å¯èƒ½æ€§**ï¼Œæ‰§è¡Œä¸€ä¸ªæ–°é“¾å¦‚ä¸‹ï¼Œå®ƒä¸åº”æ‰§è¡ŒSTOP gadgetä»¥ç¡®è®¤å…ˆå‰çš„é“¾ç¡®å®å¼¹å‡ºäº†6ä¸ªå¯„å­˜å™¨ï¼š

`'A' * åç§»é‡ + canary + rbp + ADDR`

çŸ¥é“ret2csu gadgetçš„åœ°å€åï¼Œå°±å¯ä»¥**æ¨æ–­å‡ºæ§åˆ¶`rsi`å’Œ`rdi`çš„gadgetsçš„åœ°å€**ã€‚

### 6. æŸ¥æ‰¾PLT

PLTè¡¨å¯ä»¥ä»0x400000æˆ–ä»å †æ ˆä¸­çš„**æ³„æ¼çš„RIPåœ°å€**ï¼ˆå¦‚æœä½¿ç”¨**PIE**ï¼‰å¼€å§‹æœç´¢ã€‚è¡¨çš„**æ¡ç›®**ä»¥16Bï¼ˆ0x10Bï¼‰åˆ†éš”ï¼Œå½“è°ƒç”¨ä¸€ä¸ªå‡½æ•°æ—¶ï¼Œå³ä½¿å‚æ•°ä¸æ­£ç¡®ï¼ŒæœåŠ¡å™¨ä¹Ÿä¸ä¼šå´©æºƒã€‚æ­¤å¤–ï¼Œæ£€æŸ¥**PLT + 6Bä¸­çš„æ¡ç›®åœ°å€ä¹Ÿä¸ä¼šå´©æºƒ**ï¼Œå› ä¸ºè¿™æ˜¯ç¬¬ä¸€ä¸ªæ‰§è¡Œçš„ä»£ç ã€‚

å› æ­¤ï¼Œå¯ä»¥é€šè¿‡æ£€æŸ¥ä»¥ä¸‹è¡Œä¸ºæ¥æ‰¾åˆ°PLTè¡¨ï¼š

* `'A' * åç§»é‡ + canary + rbp + ADDR + STOP` -> æ— å´©æºƒ
* `'A' * åç§»é‡ + canary + rbp + (ADDR + 0x6) + STOP` -> æ— å´©æºƒ
* `'A' * åç§»é‡ + canary + rbp + (ADDR + 0x10) + STOP` -> æ— å´©æºƒ

### 7. æŸ¥æ‰¾strcmp

**`strcmp`**å‡½æ•°å°†å¯„å­˜å™¨**`rdx`**è®¾ç½®ä¸ºè¦æ¯”è¾ƒçš„å­—ç¬¦ä¸²çš„é•¿åº¦ã€‚è¯·æ³¨æ„ï¼Œ**`rdx`**æ˜¯ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œæˆ‘ä»¬éœ€è¦å®ƒ**å¤§äº0**ï¼Œä»¥ä¾¿ç¨åä½¿ç”¨`write`æ³„æ¼ç¨‹åºã€‚

å¯ä»¥æ ¹æ®å…¶è¡Œä¸ºåœ¨PLTä¸­æ‰¾åˆ°**`strcmp`**çš„ä½ç½®ï¼Œåˆ©ç”¨æˆ‘ä»¬ç°åœ¨å¯ä»¥æ§åˆ¶å‡½æ•°çš„å‰ä¸¤ä¸ªå‚æ•°çš„äº‹å®ï¼š

* strcmp(\<éè¯»å–åœ°å€>, \<éè¯»å–åœ°å€>) -> å´©æºƒ
* strcmp(\<éè¯»å–åœ°å€>, \<è¯»å–åœ°å€>) -> å´©æºƒ
* strcmp(\<è¯»å–åœ°å€>, \<éè¯»å–åœ°å€>) -> å´©æºƒ
* strcmp(\<è¯»å–åœ°å€>, \<è¯»å–åœ°å€>) -> æ— å´©æºƒ

å¯ä»¥é€šè¿‡è°ƒç”¨PLTè¡¨çš„æ¯ä¸ªæ¡ç›®æˆ–ä½¿ç”¨**PLTæ…¢è·¯å¾„**æ¥æ£€æŸ¥è¿™ä¸€ç‚¹ï¼Œè¯¥æ…¢è·¯å¾„åŸºæœ¬ä¸ŠåŒ…æ‹¬è°ƒç”¨PLTè¡¨ä¸­çš„ä¸€ä¸ªæ¡ç›® + 0xbï¼ˆè°ƒç”¨**`dlresolve`**ï¼‰ï¼Œç„¶ååœ¨å †æ ˆä¸­è·Ÿéšå¸Œæœ›æ¢æµ‹çš„**æ¡ç›®ç¼–å·**ï¼ˆä»é›¶å¼€å§‹ï¼‰ä»¥æ‰«ææ‰€æœ‰PLTæ¡ç›®ï¼š

* strcmp(\<éè¯»å–åœ°å€>, \<è¯»å–åœ°å€>) -> å´©æºƒ
* `b'A' * åç§»é‡ + canary + rbp + (BROP + 0x9) + RIP + (BROP + 0x7) + p64(0x300) + p64(0x0) + (PLT + 0xb ) + p64(ENTRY) + STOP` -> å°†å´©æºƒ
* strcmp(\<è¯»å–åœ°å€>, \<éè¯»å–åœ°å€>) -> å´©æºƒ
* `b'A' * åç§»é‡ + canary + rbp + (BROP + 0x9) + p64(0x300) + (BROP + 0x7) + RIP + p64(0x0) + (PLT + 0xb ) + p64(ENTRY) + STOP`&#x20;
* strcmp(\<è¯»å–åœ°å€>, \<è¯»å–åœ°å€>) -> æ— å´©æºƒ
* `b'A' * åç§»é‡ + canary + rbp + (BROP + 0x9) + RIP + (BROP + 0x7) + RIP + p64(0x0) + (PLT + 0xb ) + p64(ENTRY) + STOP`&#x20;

è¯·è®°ä½ï¼š

* BROP + 0x7æŒ‡å‘**`pop RSI; pop R15; ret;`**
* BROP + 0x9æŒ‡å‘**`pop RDI; ret;`**
* PLT + 0xbæŒ‡å‘è°ƒç”¨**dl\_resolve**ã€‚

æ‰¾åˆ°`strcmp`åï¼Œå°±å¯ä»¥å°†**`rdx`**è®¾ç½®ä¸ºå¤§äº0çš„å€¼ã€‚

{% hint style="success" %}
è¯·æ³¨æ„ï¼Œé€šå¸¸`rdx`å°†å·²ç»åŒ…å«å¤§äº0çš„å€¼ï¼Œå› æ­¤æ­¤æ­¥éª¤å¯èƒ½ä¸æ˜¯å¿…éœ€çš„ã€‚
{% endhint %}
### 8. å¯»æ‰¾Writeå‡½æ•°æˆ–ç­‰æ•ˆå‡½æ•°

æœ€åï¼Œéœ€è¦ä¸€ä¸ªç”¨äºå¤–æ³„æ•°æ®çš„gadgetï¼Œä»¥ä¾¿å¤–æ³„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚æ­¤æ—¶å¯ä»¥**æ§åˆ¶2ä¸ªå‚æ•°å¹¶è®¾ç½®`rdx`å¤§äº0**ã€‚

æœ‰3ä¸ªå¸¸è§çš„å‡½æ•°å¯ä»¥è¢«æ»¥ç”¨ï¼š

- `puts(data)`
- `dprintf(fd, data)`
- `write(fd, data, len(data)`

ç„¶è€Œï¼ŒåŸå§‹è®ºæ–‡åªæåˆ°äº†**`write`**å‡½æ•°ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬æ¥è®¨è®ºä¸€ä¸‹ï¼š

å½“å‰é—®é¢˜æ˜¯æˆ‘ä»¬ä¸çŸ¥é“**writeå‡½æ•°åœ¨PLTä¸­çš„ä½ç½®**ï¼Œä¹Ÿä¸çŸ¥é“**è¦å‘é€æ•°æ®åˆ°æˆ‘ä»¬çš„å¥—æ¥å­—çš„fdå·ç **ã€‚

ä½†æ˜¯ï¼Œæˆ‘ä»¬çŸ¥é“**PLTè¡¨çš„ä½ç½®**ï¼Œå¯ä»¥æ ¹æ®å…¶**è¡Œä¸º**æ‰¾åˆ°writeã€‚æˆ‘ä»¬å¯ä»¥ä¸æœåŠ¡å™¨åˆ›å»º**å¤šä¸ªè¿æ¥**ï¼Œå¹¶ä½¿ç”¨**é«˜FD**ï¼Œå¸Œæœ›å®ƒä¸æˆ‘ä»¬çš„æŸä¸ªè¿æ¥åŒ¹é…ã€‚

æŸ¥æ‰¾è¿™äº›å‡½æ•°çš„è¡Œä¸ºç‰¹å¾ï¼š

- `'A' * offset + canary + rbp + (BROP + 0x9) + RIP + (BROP + 0x7) + p64(0) + p64(0) + (PLT + 0xb) + p64(ENTRY) + STOP`  -> å¦‚æœæœ‰æ•°æ®æ‰“å°å‡ºæ¥ï¼Œåˆ™æ‰¾åˆ°äº†puts
- `'A' * offset + canary + rbp + (BROP + 0x9) + FD + (BROP + 0x7) + RIP + p64(0x0) + (PLT + 0xb) + p64(ENTRY) + STOP`  -> å¦‚æœæœ‰æ•°æ®æ‰“å°å‡ºæ¥ï¼Œåˆ™æ‰¾åˆ°äº†dprintf
- `'A' * offset + canary + rbp + (BROP + 0x9) + RIP + (BROP + 0x7) + (RIP + 0x1) + p64(0x0) + (PLT + 0xb ) + p64(STRCMP ENTRY) + (BROP + 0x9) + FD + (BROP + 0x7) + RIP + p64(0x0) + (PLT + 0xb) + p64(ENTRY) + STOP`  -> å¦‚æœæœ‰æ•°æ®æ‰“å°å‡ºæ¥ï¼Œåˆ™æ‰¾åˆ°äº†write

## è‡ªåŠ¨åŒ–åˆ©ç”¨

* [https://github.com/Hakumarachi/Bropper](https://github.com/Hakumarachi/Bropper)

## å‚è€ƒèµ„æ–™

* åŸå§‹è®ºæ–‡: [https://www.scs.stanford.edu/brop/bittau-brop.pdf](https://www.scs.stanford.edu/brop/bittau-brop.pdf)
* [https://www.ctfrecipes.com/pwn/stack-exploitation/arbitrary-code-execution/code-reuse-attack/blind-return-oriented-programming-brop](https://www.ctfrecipes.com/pwn/stack-exploitation/arbitrary-code-execution/code-reuse-attack/blind-return-oriented-programming-brop)
