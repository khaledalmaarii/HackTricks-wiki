# Desbordamiento de Pila

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}

## 쯈u칠 es un Desbordamiento de Pila?

Un **desbordamiento de pila** es una vulnerabilidad que ocurre cuando un programa escribe m치s datos en la pila de los que se le ha asignado para contener. Este exceso de datos **sobrescribir치 el espacio de memoria adyacente**, lo que llevar치 a la corrupci칩n de datos v치lidos, interrupci칩n del flujo de control y potencialmente a la ejecuci칩n de c칩digo malicioso. Este problema a menudo surge debido al uso de funciones inseguras que no realizan verificaci칩n de l칤mites en la entrada.

El principal problema de este sobrescritura es que el **puntero de instrucci칩n guardado (EIP/RIP)** y el **puntero base guardado (EBP/RBP)** para regresar a la funci칩n anterior est치n **almacenados en la pila**. Por lo tanto, un atacante podr치 sobrescribir esos y **controlar el flujo de ejecuci칩n del programa**.

La vulnerabilidad generalmente surge porque una funci칩n **copia dentro de la pila m치s bytes de los que se le han asignado**, pudiendo as칤 sobrescribir otras partes de la pila.

Algunas funciones comunes vulnerables a esto son: **`strcpy`, `strcat`, `sprintf`, `gets`**... Adem치s, funciones como **`fgets`**, **`read` & `memcpy`** que toman un **argumento de longitud**, podr칤an usarse de manera vulnerable si la longitud especificada es mayor que la asignada.

Por ejemplo, las siguientes funciones podr칤an ser vulnerables:
```c
void vulnerable() {
char buffer[128];
printf("Enter some text: ");
gets(buffer); // This is where the vulnerability lies
printf("You entered: %s\n", buffer);
}
```
### Encontrando los offsets de desbordamiento de pila

La forma m치s com칰n de encontrar desbordamientos de pila es dar una entrada muy grande de `A`s (por ejemplo, `python3 -c 'print("A"*1000)'`) y esperar un `Segmentation Fault` que indique que se intent칩 acceder a la **direcci칩n `0x41414141`**.

Adem치s, una vez que hayas encontrado que hay una vulnerabilidad de desbordamiento de pila, necesitar치s encontrar el offset hasta que sea posible **sobrescribir la direcci칩n de retorno**, para esto se suele utilizar una **secuencia de De Bruijn.** La cual, para un alfabeto dado de tama침o _k_ y subsecuencias de longitud _n_, es una **secuencia c칤clica en la que cada posible subsecuencia de longitud \_n**\_\*\* aparece exactamente una vez\*\* como una subsecuencia contigua.

De esta manera, en lugar de necesitar averiguar manualmente qu칠 offset se necesita para controlar el EIP, es posible usar como relleno una de estas secuencias y luego encontrar el offset de los bytes que terminaron sobrescribi칠ndola.

Es posible usar **pwntools** para esto:
```python
from pwn import *

# Generate a De Bruijn sequence of length 1000 with an alphabet size of 256 (byte values)
pattern = cyclic(1000)

# This is an example value that you'd have found in the EIP/IP register upon crash
eip_value = p32(0x6161616c)
offset = cyclic_find(eip_value)  # Finds the offset of the sequence in the De Bruijn pattern
print(f"The offset is: {offset}")
```
o **GEF**:
```bash
#Patterns
pattern create 200 #Generate length 200 pattern
pattern search "avaaawaa" #Search for the offset of that substring
pattern search $rsp #Search the offset given the content of $rsp
```
## Explotando Desbordamientos de Pila

Durante un desbordamiento (suponiendo que el tama침o del desbordamiento sea lo suficientemente grande) podr치s **sobrescribir** valores de variables locales dentro de la pila hasta alcanzar el **EBP/RBP y EIP/RIP guardados (o incluso m치s)**.\
La forma m치s com칰n de abusar de este tipo de vulnerabilidad es **modificando la direcci칩n de retorno** para que cuando la funci칩n termine, el **flujo de control se redirija a donde el usuario especific칩** en este puntero.

Sin embargo, en otros escenarios, tal vez solo **sobrescribir algunos valores de variables en la pila** podr칤a ser suficiente para la explotaci칩n (como en desaf칤os CTF f치ciles).

### Ret2win

En este tipo de desaf칤os CTF, hay una **funci칩n** **dentro** del binario que **nunca se llama** y que **necesitas llamar para ganar**. Para estos desaf칤os solo necesitas encontrar el **desplazamiento para sobrescribir la direcci칩n de retorno** y **encontrar la direcci칩n de la funci칩n** a llamar (generalmente [**ASLR**](../common-binary-protections-and-bypasses/aslr/) estar칤a deshabilitado) para que cuando la funci칩n vulnerable regrese, se llame a la funci칩n oculta:

{% content-ref url="ret2win/" %}
[ret2win](ret2win/)
{% endcontent-ref %}

### Shellcode en Pila

En este escenario, el atacante podr칤a colocar un shellcode en la pila y abusar del EIP/RIP controlado para saltar al shellcode y ejecutar c칩digo arbitrario:

{% content-ref url="stack-shellcode/" %}
[stack-shellcode](stack-shellcode/)
{% endcontent-ref %}

### T칠cnicas ROP & Ret2...

Esta t칠cnica es el marco fundamental para eludir la principal protecci칩n de la t칠cnica anterior: **Pila no ejecutable (NX)**. Y permite realizar varias otras t칠cnicas (ret2lib, ret2syscall...) que terminar치n ejecutando comandos arbitrarios al abusar de instrucciones existentes en el binario:

{% content-ref url="../rop-return-oriented-programing/" %}
[rop-return-oriented-programing](../rop-return-oriented-programing/)
{% endcontent-ref %}

## Desbordamientos de Heap

Un desbordamiento no siempre va a estar en la pila, tambi칠n podr칤a estar en el **heap**, por ejemplo:

{% content-ref url="../libc-heap/heap-overflow.md" %}
[heap-overflow.md](../libc-heap/heap-overflow.md)
{% endcontent-ref %}

## Tipos de protecciones

Hay varias protecciones tratando de prevenir la explotaci칩n de vulnerabilidades, rev칤salas en:

{% content-ref url="../common-binary-protections-and-bypasses/" %}
[common-binary-protections-and-bypasses](../common-binary-protections-and-bypasses/)
{% endcontent-ref %}

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
