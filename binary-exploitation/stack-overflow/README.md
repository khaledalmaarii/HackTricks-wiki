# Stack Overflow

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## O que √© um Stack Overflow

Um **stack overflow** √© uma vulnerabilidade que ocorre quando um programa escreve mais dados na pilha do que foi alocado para armazen√°-los. Esses dados em excesso ir√£o **sobrescrever o espa√ßo de mem√≥ria adjacente**, levando √† corrup√ß√£o de dados v√°lidos, interrup√ß√£o do fluxo de controle e potencialmente √† execu√ß√£o de c√≥digo malicioso. Esse problema geralmente surge devido ao uso de fun√ß√µes inseguras que n√£o realizam verifica√ß√£o de limites na entrada.

O principal problema dessa sobrescrita √© que o **ponteiro de instru√ß√£o salvo (EIP/RIP)** e o **ponteiro de base salvo (EBP/RBP)** para retornar √† fun√ß√£o anterior est√£o **armazenados na pilha**. Portanto, um atacante poder√° sobrescrever esses valores e **controlar o fluxo de execu√ß√£o do programa**.

A vulnerabilidade geralmente surge porque uma fun√ß√£o **copia na pilha mais bytes do que a quantidade alocada para ela**, podendo assim sobrescrever outras partes da pilha.

Algumas fun√ß√µes comuns vulner√°veis a isso s√£o: **`strcpy`, `strcat`, `sprintf`, `gets`**... Al√©m disso, fun√ß√µes como **`fgets`**, **`read` & `memcpy`** que aceitam um **argumento de comprimento**, podem ser usadas de maneira vulner√°vel se o comprimento especificado for maior do que o alocado.

Por exemplo, as seguintes fun√ß√µes poderiam ser vulner√°veis:
```c
void vulnerable() {
char buffer[128];
printf("Enter some text: ");
gets(buffer); // This is where the vulnerability lies
printf("You entered: %s\n", buffer);
}
```
### Encontrando os offsets de Stack Overflows

A maneira mais comum de encontrar stack overflows √© fornecer uma entrada muito grande de `A`s (por exemplo, `python3 -c 'print("A"*1000)'`) e esperar um `Segmentation Fault` indicando que o **endere√ßo `0x41414141` foi tentado acessar**.

Al√©m disso, uma vez que voc√™ encontrou que h√° uma vulnerabilidade de Stack Overflow, voc√™ precisar√° encontrar o offset at√© que seja poss√≠vel **sobrescrever o endere√ßo de retorno**, para isso geralmente √© usada uma **sequ√™ncia de De Bruijn.** Que para um alfabeto dado de tamanho _k_ e subsequ√™ncias de comprimento _n_ √© uma **sequ√™ncia c√≠clica na qual cada poss√≠vel subsequ√™ncia de comprimento \_n**\_\*\* aparece exatamente uma vez\*\* como uma subsequ√™ncia cont√≠gua.

Dessa forma, em vez de precisar descobrir manualmente qual offset √© necess√°rio para controlar o EIP, √© poss√≠vel usar como preenchimento uma dessas sequ√™ncias e, em seguida, encontrar o offset dos bytes que acabaram sobrescrevendo-o.

√â poss√≠vel usar **pwntools** para isso:
```python
from pwn import *

# Generate a De Bruijn sequence of length 1000 with an alphabet size of 256 (byte values)
pattern = cyclic(1000)

# This is an example value that you'd have found in the EIP/IP register upon crash
eip_value = p32(0x6161616c)
offset = cyclic_find(eip_value)  # Finds the offset of the sequence in the De Bruijn pattern
print(f"The offset is: {offset}")
```
ou **GEF**:
```bash
#Patterns
pattern create 200 #Generate length 200 pattern
pattern search "avaaawaa" #Search for the offset of that substring
pattern search $rsp #Search the offset given the content of $rsp
```
## Explorando Estouro de Pilha

Durante um estouro (supondo que o tamanho do estouro seja grande o suficiente) voc√™ poder√° **sobrescrever** valores de vari√°veis locais dentro da pilha at√© alcan√ßar o **EBP/RBP e EIP/RIP salvos (ou at√© mais)**.\
A maneira mais comum de abusar desse tipo de vulnerabilidade √© **modificando o endere√ßo de retorno** para que, quando a fun√ß√£o terminar, o **fluxo de controle seja redirecionado para onde o usu√°rio especificou** neste ponteiro.

No entanto, em outros cen√°rios, apenas **sobrescrever alguns valores de vari√°veis na pilha** pode ser suficiente para a explora√ß√£o (como em desafios CTF f√°ceis).

### Ret2win

Neste tipo de desafios CTF, h√° uma **fun√ß√£o** **dentro** do bin√°rio que **nunca √© chamada** e que **voc√™ precisa chamar para vencer**. Para esses desafios, voc√™ s√≥ precisa encontrar o **offset para sobrescrever o endere√ßo de retorno** e **encontrar o endere√ßo da fun√ß√£o** a ser chamada (geralmente [**ASLR**](../common-binary-protections-and-bypasses/aslr/) estaria desativado) para que, quando a fun√ß√£o vulner√°vel retornar, a fun√ß√£o oculta seja chamada:

{% content-ref url="ret2win/" %}
[ret2win](ret2win/)
{% endcontent-ref %}

### Shellcode na Pilha

Neste cen√°rio, o atacante poderia colocar um shellcode na pilha e abusar do EIP/RIP controlado para pular para o shellcode e executar c√≥digo arbitr√°rio:

{% content-ref url="stack-shellcode/" %}
[stack-shellcode](stack-shellcode/)
{% endcontent-ref %}

### T√©cnicas ROP & Ret2...

Esta t√©cnica √© a estrutura fundamental para contornar a principal prote√ß√£o da t√©cnica anterior: **Pilha n√£o execut√°vel (NX)**. E permite realizar v√°rias outras t√©cnicas (ret2lib, ret2syscall...) que acabar√£o executando comandos arbitr√°rios ao abusar de instru√ß√µes existentes no bin√°rio:

{% content-ref url="../rop-return-oriented-programing/" %}
[rop-return-oriented-programing](../rop-return-oriented-programing/)
{% endcontent-ref %}

## Estouro de Heap

Um estouro n√£o ocorrer√° sempre na pilha, ele tamb√©m pode ocorrer no **heap**, por exemplo:

{% content-ref url="../libc-heap/heap-overflow.md" %}
[heap-overflow.md](../libc-heap/heap-overflow.md)
{% endcontent-ref %}

## Tipos de Prote√ß√µes

Existem v√°rias prote√ß√µes tentando prevenir a explora√ß√£o de vulnerabilidades, confira-as em:

{% content-ref url="../common-binary-protections-and-bypasses/" %}
[common-binary-protections-and-bypasses](../common-binary-protections-and-bypasses/)
{% endcontent-ref %}

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte ao HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
