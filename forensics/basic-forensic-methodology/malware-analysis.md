# Analiza zoliwego oprogramowania

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Oszustwa dotyczce forensyki

[https://www.jaiminton.com/cheatsheet/DFIR/#](https://www.jaiminton.com/cheatsheet/DFIR/)

## Usugi online

* [VirusTotal](https://www.virustotal.com/gui/home/upload)
* [HybridAnalysis](https://www.hybrid-analysis.com)
* [Koodous](https://koodous.com)
* [Intezer](https://analyze.intezer.com)
* [Any.Run](https://any.run/)

## Narzdzia offline do wykrywania i usuwania wirus贸w

### Yara

#### Instalacja
```bash
sudo apt-get install -y yara
```
#### Przygotuj reguy

U偶yj tego skryptu do pobrania i poczenia wszystkich regu malware yara z githuba: [https://gist.github.com/andreafortuna/29c6ea48adf3d45a979a78763cdc7ce9](https://gist.github.com/andreafortuna/29c6ea48adf3d45a979a78763cdc7ce9)\
Utw贸rz katalog _**rules**_ i wykonaj go. Spowoduje to utworzenie pliku o nazwie _**malware\_rules.yar**_, kt贸ry zawiera wszystkie reguy yara dla malware.
```bash
wget https://gist.githubusercontent.com/andreafortuna/29c6ea48adf3d45a979a78763cdc7ce9/raw/4ec711d37f1b428b63bed1f786b26a0654aa2f31/malware_yara_rules.py
mkdir rules
python malware_yara_rules.py
```
#### Skanowanie

To begin the malware analysis process, the first step is to scan the suspicious file or system for any signs of malicious activity. This can be done using various tools and techniques, such as antivirus software, sandboxing, and network traffic analysis.

##### Antivirus Scan

Running an antivirus scan is a quick and easy way to check if a file or system is infected with known malware. Antivirus software uses a database of known malware signatures to identify and remove malicious files. It is important to keep the antivirus software up to date to ensure it can detect the latest threats.

##### Sandbox Analysis

Sandboxing involves running the suspicious file or program in a controlled environment to observe its behavior. This can help identify any malicious activities, such as file modifications, network connections, or system changes. Sandboxing tools provide a safe and isolated environment to analyze potentially dangerous files without risking the host system.

##### Network Traffic Analysis

Analyzing network traffic can provide valuable insights into the behavior of malware. By monitoring network connections and traffic patterns, it is possible to identify any suspicious or malicious activities. Tools like Wireshark can be used to capture and analyze network packets, allowing for the detection of communication with malicious servers or the exfiltration of sensitive data.

##### File Analysis

Analyzing the suspicious file itself can reveal important information about its nature and purpose. This can be done using various techniques, such as static analysis and dynamic analysis.

- Static Analysis: Involves examining the file's structure, metadata, and code without executing it. This can include analyzing file headers, strings, and embedded resources. Tools like PEiD and ExifTool can be used for static analysis.

- Dynamic Analysis: Involves executing the file in a controlled environment and monitoring its behavior. This can include observing system calls, file system modifications, and network connections. Tools like Process Monitor and Process Explorer can be used for dynamic analysis.

By performing these scans and analyses, it is possible to gather valuable information about the malware, such as its behavior, capabilities, and potential impact on the system. This information can then be used to develop appropriate mitigation strategies and countermeasures.
```bash
yara -w malware_rules.yar image  #Scan 1 file
yara -w malware_rules.yar folder #Scan the whole folder
```
#### YaraGen: Sprawdzanie zoliwego oprogramowania i tworzenie regu

Mo偶esz u偶y narzdzia [**YaraGen**](https://github.com/Neo23x0/yarGen), aby generowa reguy yara na podstawie pliku binarnego. Sprawd藕 te samouczki: [**Cz 1**](https://www.nextron-systems.com/2015/02/16/write-simple-sound-yara-rules/), [**Cz 2**](https://www.nextron-systems.com/2015/10/17/how-to-write-simple-but-sound-yara-rules-part-2/), [**Cz 3**](https://www.nextron-systems.com/2016/04/15/how-to-write-simple-but-sound-yara-rules-part-3/)
```bash
python3 yarGen.py --update
python3.exe yarGen.py --excludegood -m  ../../mals/
```
### ClamAV

#### Instalacja

Aby zainstalowa ClamAV, wykonaj nastpujce kroki:

1. Otw贸rz terminal i wpisz poni偶sz komend, aby zainstalowa ClamAV:

```
sudo apt-get install clamav
```

2. Po zakoczeniu instalacji, wykonaj poni偶sz komend, aby zaktualizowa bazy danych wirus贸w:

```
sudo freshclam
```

3. Teraz mo偶esz przeskanowa pliki na swoim systemie, u偶ywajc poni偶szej komendy:

```
clamscan -r /cie偶ka/do/katalogu
```

Gdzie `/cie偶ka/do/katalogu` to cie偶ka do katalogu, kt贸ry chcesz przeskanowa. Mo偶esz r贸wnie偶 u偶y opcji `-r` w celu przeskanowania wszystkich plik贸w rekursywnie.

Po zakoczeniu skanowania, ClamAV wywietli raport z wykrytymi wirusami lub oznaczy pliki jako bezpieczne.

#### Aktualizacja baz danych wirus贸w

Aby zaktualizowa bazy danych wirus贸w ClamAV, wykonaj poni偶sze kroki:

1. Otw贸rz terminal i wpisz poni偶sz komend, aby zaktualizowa bazy danych:

```
sudo freshclam
```

2. Po zakoczeniu aktualizacji, bazy danych wirus贸w bd zaktualizowane i gotowe do u偶ycia.

#### Automatyczna aktualizacja baz danych wirus贸w

Aby skonfigurowa automatyczn aktualizacj baz danych wirus贸w ClamAV, wykonaj poni偶sze kroki:

1. Otw贸rz terminal i wpisz poni偶sz komend, aby edytowa plik konfiguracyjny:

```
sudo nano /etc/clamav/freshclam.conf
```

2. Znajd藕 lini `#Example` i usu znak `#` na pocztku linii, aby odkomentowa t lini.

3. Zapisz plik i zamknij edytor.

4. Teraz mo偶esz skonfigurowa harmonogram automatycznej aktualizacji, wykonujc poni偶sz komend:

```
sudo systemctl enable --now clamav-freshclam
```

Po wykonaniu tych krok贸w, bazy danych wirus贸w ClamAV bd automatycznie aktualizowane zgodnie z harmonogramem.
```
sudo apt-get install -y clamav
```
#### Skanowanie

To begin the malware analysis process, the first step is to scan the suspicious file or system for any signs of malicious activity. This can be done using various tools and techniques, such as antivirus software, sandboxing, and network traffic analysis.

##### Antivirus Scan

Running an antivirus scan is a quick and easy way to check if a file or system is infected with known malware. Antivirus software uses a database of known malware signatures to identify and remove malicious files. It is important to keep the antivirus software up to date to ensure it can detect the latest threats.

##### Sandbox Analysis

Sandboxing involves running the suspicious file or program in a controlled environment to observe its behavior. This can help identify any malicious activities, such as file modifications, network connections, or system changes. Sandboxing tools provide a safe and isolated environment to analyze potentially dangerous files without risking the host system.

##### Network Traffic Analysis

Analyzing network traffic can provide valuable insights into the behavior of malware. By monitoring network connections and traffic patterns, it is possible to identify any suspicious or malicious activities. Tools like Wireshark can be used to capture and analyze network packets, allowing for the detection of communication with malicious servers or the exfiltration of sensitive data.

##### File Analysis

Analyzing the suspicious file itself can reveal important information about its nature and purpose. This can be done using various techniques, such as static analysis and dynamic analysis.

- Static Analysis: Involves examining the file's structure, metadata, and code without executing it. This can include checking file headers, strings, and embedded resources. Tools like PEiD and ExifTool can be used for static analysis.

- Dynamic Analysis: Involves executing the file in a controlled environment and monitoring its behavior. This can include observing system calls, file system modifications, and network connections. Tools like Process Monitor and Process Explorer can be used for dynamic analysis.

By performing a thorough scan of the suspicious file or system, it is possible to gather valuable information about the malware and its capabilities. This information can then be used to further analyze and mitigate the threat.
```bash
sudo freshclam      #Update rules
clamscan filepath   #Scan 1 file
clamscan folderpath #Scan the whole folder
```
### [Capa](https://github.com/mandiant/capa)

**Capa** wykrywa potencjalnie zoliwe **zdolnoci** w plikach wykonywalnych: PE, ELF, .NET. Znajdzie takie rzeczy jak taktyki Att\&ck lub podejrzane zdolnoci, takie jak:

* sprawdzanie bdu OutputDebugString
* uruchamianie jako usuga
* tworzenie procesu

Pobierz go z [**repozytorium Github**](https://github.com/mandiant/capa).

### IOC

IOC oznacza Indicator Of Compromise. IOC to zestaw **warunk贸w identyfikujcych** potencjalnie niechciane oprogramowanie lub potwierdzone **zoliwe oprogramowanie**. Zespoy Blue u偶ywaj tego rodzaju definicji do **wyszukiwania tego rodzaju zoliwych plik贸w** w swoich **systemach** i **sieciach**.\
Dzielenie si tymi definicjami jest bardzo przydatne, poniewa偶 gdy zoliwe oprogramowanie zostanie zidentyfikowane na komputerze i utworzony zostanie IOC dla tego zoliwego oprogramowania, inne zespoy Blue mog go u偶y do szybszego identyfikowania zoliwego oprogramowania.

Narzdzie do tworzenia lub modyfikowania IOC to [**Edytor IOC**](https://www.fireeye.com/services/freeware/ioc-editor.html)**.**\
Mo偶esz u偶y narzdzi takich jak [**Redline**](https://www.fireeye.com/services/freeware/redline.html), aby **wyszukiwa zdefiniowane IOCs na urzdzeniu**.

### Loki

[**Loki**](https://github.com/Neo23x0/Loki) to skaner dla prostych wska藕nik贸w kompromitacji.\
Wykrywanie opiera si na czterech metodach wykrywania:
```
1. File Name IOC
Regex match on full file path/name

2. Yara Rule Check
Yara signature matches on file data and process memory

3. Hash Check
Compares known malicious hashes (MD5, SHA1, SHA256) with scanned files

4. C2 Back Connect Check
Compares process connection endpoints with C2 IOCs (new since version v.10)
```
### Linux Malware Detect

[**Linux Malware Detect (LMD)**](https://www.rfxn.com/projects/linux-malware-detect/) to skaner zoliwego oprogramowania dla systemu Linux, wydany na licencji GNU GPLv2, kt贸ry zosta zaprojektowany w oparciu o zagro偶enia wystpujce w rodowiskach hostowanych wsp贸dzielonych. Wykorzystuje dane dotyczce zagro偶e z system贸w wykrywania wama na krawdzi sieci w celu wykrywania aktywnie wykorzystywanego zoliwego oprogramowania i generowania sygnatur do jego wykrywania. Dodatkowo, dane dotyczce zagro偶e s r贸wnie偶 pozyskiwane z zgosze u偶ytkownik贸w za pomoc funkcji sprawdzania LMD oraz z zasob贸w spoecznoci zajmujcej si zoliwym oprogramowaniem.

### rkhunter

Narzdzia takie jak [**rkhunter**](http://rkhunter.sourceforge.net) mog by u偶ywane do sprawdzania systemu plik贸w pod ktem mo偶liwych **rootkit贸w** i zoliwego oprogramowania.
```bash
sudo ./rkhunter --check -r / -l /tmp/rkhunter.log [--report-warnings-only] [--skip-keypress]
```
### FLOSS

[**FLOSS**](https://github.com/mandiant/flare-floss) to narzdzie, kt贸re pr贸buje znale藕 zaszyfrowane cigi wewntrz plik贸w wykonywalnych, u偶ywajc r贸偶nych technik.

### PEpper

[PEpper](https://github.com/Th3Hurrican3/PEpper) sprawdza podstawowe informacje wewntrz pliku wykonywalnego (dane binarne, entropia, adresy URL i IP, niekt贸re reguy yara).

### PEstudio

[PEstudio](https://www.winitor.com/download) to narzdzie, kt贸re pozwala uzyska informacje o plikach wykonywalnych systemu Windows, takie jak importy, eksporty, nag贸wki, ale tak偶e sprawdza VirusTotal i znajduje potencjalne techniki Att\&ck.

### Detect It Easy(DiE)

[**DiE**](https://github.com/horsicq/Detect-It-Easy/) to narzdzie do wykrywania, czy plik jest **zaszyfrowany**, a tak偶e znajduje **pakery**.

### NeoPI

[**NeoPI**](https://github.com/CiscoCXSecurity/NeoPI) to skrypt Pythona, kt贸ry u偶ywa r贸偶nych **metod statystycznych** do wykrywania **zaszyfrowanej** i **zaszyfrowanej** zawartoci w plikach tekstowych/skryptowych. NeoPI ma na celu pom贸c w **wykrywaniu ukrytego kodu web shell**.

### **php-malware-finder**

[**PHP-malware-finder**](https://github.com/nbs-system/php-malware-finder) robi wszystko, co w jego mocy, aby wykry **zaszyfrowany**/**podejrzany kod**, a tak偶e pliki u偶ywajce funkcji **PHP** czsto u偶ywanych w **malware**/webshellach.

### Sygnatury binarne Apple

Podczas sprawdzania pr贸bki **malware** zawsze powiniene **sprawdzi sygnatur** binarn, poniewa偶 **deweloper**, kt贸ry j podpisa, mo偶e by ju偶 **powizany** z **malware**.
```bash
#Get signer
codesign -vv -d /bin/ls 2>&1 | grep -E "Authority|TeamIdentifier"

#Check if the apps contents have been modified
codesign --verify --verbose /Applications/Safari.app

#Check if the signature is valid
spctl --assess --verbose /Applications/Safari.app
```
## Techniki wykrywania

### Skadanie plik贸w

Jeli wiesz, 偶e pewien folder zawierajcy **pliki** serwera internetowego by **ostatnio zaktualizowany w pewnej dacie**, **sprawd藕** dat utworzenia i modyfikacji wszystkich **plik贸w** na serwerze i jeli jakakolwiek data jest **podejrzana**, sprawd藕 ten plik.

### Punkty odniesienia

Jeli pliki w folderze **nie powinny by modyfikowane**, mo偶esz obliczy **skr贸t** **oryginalnych plik贸w** w folderze i **por贸wna** je z **aktualnymi**. Wszelkie zmodyfikowane pliki bd **podejrzane**.

### Analiza statystyczna

Jeli informacje s zapisywane w logach, mo偶esz **sprawdzi statystyki, takie jak ile razy ka偶dy plik serwera internetowego by odwiedzany, poniewa偶 jeden z nich mo偶e by web shell**.

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCYJNY**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
