# Analiza zoliwego oprogramowania

{% hint style="success" %}
Dowiedz si i praktykuj Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Dowiedz si i praktykuj Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Udostpniaj sztuczki hakerskie, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na githubie.

</details>
{% endhint %}

## Arkusze oszustw w dziedzinie ledztwa

[https://www.jaiminton.com/cheatsheet/DFIR/#](https://www.jaiminton.com/cheatsheet/DFIR/)

## Usugi online

* [VirusTotal](https://www.virustotal.com/gui/home/upload)
* [HybridAnalysis](https://www.hybrid-analysis.com)
* [Koodous](https://koodous.com)
* [Intezer](https://analyze.intezer.com)
* [Any.Run](https://any.run/)

## Narzdzia antywirusowe i wykrywajce offline

### Yara

#### Instalacja
```bash
sudo apt-get install -y yara
```
#### Przygotuj zasady

U偶yj tego skryptu do pobrania i scalenia wszystkich zasad malware Yara z github: [https://gist.github.com/andreafortuna/29c6ea48adf3d45a979a78763cdc7ce9](https://gist.github.com/andreafortuna/29c6ea48adf3d45a979a78763cdc7ce9)\
Utw贸rz katalog _**rules**_ i wykonaj go. Spowoduje to utworzenie pliku o nazwie _**malware\_rules.yar**_, kt贸ry zawiera wszystkie zasady Yara dla malware.
```bash
wget https://gist.githubusercontent.com/andreafortuna/29c6ea48adf3d45a979a78763cdc7ce9/raw/4ec711d37f1b428b63bed1f786b26a0654aa2f31/malware_yara_rules.py
mkdir rules
python malware_yara_rules.py
```
#### Skanowanie
```bash
yara -w malware_rules.yar image  #Scan 1 file
yara -w malware_rules.yar folder #Scan the whole folder
```
#### YaraGen: Sprawd藕 zoliwe oprogramowanie i Utw贸rz reguy

Mo偶esz u偶y narzdzia [**YaraGen**](https://github.com/Neo23x0/yarGen) do generowania regu yara z pliku binarnego. Sprawd藕 te samouczki: [**Cz 1**](https://www.nextron-systems.com/2015/02/16/write-simple-sound-yara-rules/), [**Cz 2**](https://www.nextron-systems.com/2015/10/17/how-to-write-simple-but-sound-yara-rules-part-2/), [**Cz 3**](https://www.nextron-systems.com/2016/04/15/how-to-write-simple-but-sound-yara-rules-part-3/)
```bash
python3 yarGen.py --update
python3.exe yarGen.py --excludegood -m  ../../mals/
```
### ClamAV

#### Instalacja
```
sudo apt-get install -y clamav
```
#### Skanowanie
```bash
sudo freshclam      #Update rules
clamscan filepath   #Scan 1 file
clamscan folderpath #Scan the whole folder
```
### [Capa](https://github.com/mandiant/capa)

**Capa** wykrywa potencjalnie zoliwe **zdolnoci** w plikach wykonywalnych: PE, ELF, .NET. Dlatego znajdzie rzeczy takie jak taktyki Att\&ck lub podejrzane zdolnoci, takie jak:

- sprawdzenie bdu OutputDebugString
- uruchomienie jako usuga
- utworzenie procesu

Pobierz to z [**repozytorium Github**](https://github.com/mandiant/capa).

### IOCs

IOC oznacza Indicator Of Compromise. IOC to zestaw **warunk贸w identyfikujcych** potencjalnie niechciane oprogramowanie lub potwierdzony **zoliwy oprogramowanie**. Zespoy Blue u偶ywaj tego rodzaju definicji do **wyszukiwania tego rodzaju zoliwych plik贸w** w swoich **systemach** i **sieciach**.\
Dzielenie si tymi definicjami jest bardzo przydatne, poniewa偶 gdy zoliwe oprogramowanie zostanie zidentyfikowane w komputerze i zostanie utworzony IOC dla tego zoliwego oprogramowania, inne zespoy Blue mog go u偶y, aby szybciej zidentyfikowa zoliwe oprogramowanie.

Narzdziem do tworzenia lub modyfikowania IOC jest [**Edytor IOC**](https://www.fireeye.com/services/freeware/ioc-editor.html)**.**\
Mo偶esz u偶y narzdzi takich jak [**Redline**](https://www.fireeye.com/services/freeware/redline.html) do **wyszukiwania zdefiniowanych IOC w urzdzeniu**.

### Loki

[**Loki**](https://github.com/Neo23x0/Loki) to skaner dla prostych wska藕nik贸w kompromitacji.\
Wykrywanie opiera si na czterech metodach wykrywania:
```
1. File Name IOC
Regex match on full file path/name

2. Yara Rule Check
Yara signature matches on file data and process memory

3. Hash Check
Compares known malicious hashes (MD5, SHA1, SHA256) with scanned files

4. C2 Back Connect Check
Compares process connection endpoints with C2 IOCs (new since version v.10)
```
### Linux Malware Detect

[**Linux Malware Detect (LMD)**](https://www.rfxn.com/projects/linux-malware-detect/) to skaner zoliwego oprogramowania dla systemu Linux wydany na licencji GNU GPLv2, kt贸ry zosta zaprojektowany wok贸 zagro偶e wystpujcych w rodowiskach hostowanych wsp贸dzielonych. Wykorzystuje dane dotyczce zagro偶e z system贸w wykrywania intruz贸w na krawdzi sieci do wyodrbniania zoliwego oprogramowania, kt贸re jest aktywnie wykorzystywane w atakach i generuje sygnatury do wykrywania. Ponadto dane dotyczce zagro偶e s r贸wnie偶 pochodne od zgosze u偶ytkownik贸w za pomoc funkcji sprawdzania LMD oraz z zasob贸w spoecznoci zwizanych z zoliwym oprogramowaniem.

### rkhunter

Narzdzia takie jak [**rkhunter**](http://rkhunter.sourceforge.net) mog by u偶ywane do sprawdzania systemu plik贸w pod ktem mo偶liwych **rootkit贸w** i zoliwego oprogramowania.
```bash
sudo ./rkhunter --check -r / -l /tmp/rkhunter.log [--report-warnings-only] [--skip-keypress]
```
### FLOSS

[**FLOSS**](https://github.com/mandiant/flare-floss) to narzdzie, kt贸re spr贸buje znale藕 zaszyfrowane cigi wewntrz plik贸w wykonywalnych, u偶ywajc r贸偶nych technik.

### PEpper

[PEpper ](https://github.com/Th3Hurrican3/PEpper)sprawdza podstawowe informacje wewntrz pliku wykonywalnego (dane binarne, entropia, adresy URL i IP, niekt贸re reguy yara).

### PEstudio

[PEstudio](https://www.winitor.com/download) to narzdzie, kt贸re pozwala uzyska informacje o plikach wykonywalnych systemu Windows, takie jak importy, eksporty, nag贸wki, ale tak偶e sprawdzi VirusTotal i znajdzie potencjalne techniki Att\&ck.

### Detect It Easy(DiE)

[**DiE**](https://github.com/horsicq/Detect-It-Easy/) to narzdzie do wykrywania, czy plik jest **zaszyfrowany**, a tak偶e znajdzie **pakowacze**.

### NeoPI

[**NeoPI** ](https://github.com/CiscoCXSecurity/NeoPI)to skrypt w jzyku Python, kt贸ry u偶ywa r贸偶norodnych **metod statystycznych** do wykrywania **zaszyfrowanych** i **zaszyfrowanych** treci w plikach tekstowych/skryptowych. Celem NeoPI jest pomoc w **wykrywaniu ukrytego kodu powoki internetowej**.

### **php-malware-finder**

[**PHP-malware-finder**](https://github.com/nbs-system/php-malware-finder) robi wszystko, co w jego mocy, aby wykry **zaszyfrowany**/** podejrzany kod**, a tak偶e pliki u偶ywajce funkcji **PHP** czsto u偶ywane w **malware**/powokach internetowych.

### Sygnatury binarne Apple

Podczas sprawdzania niekt贸rych **pr贸bek zoliwego oprogramowania** zawsze powiniene **sprawdzi sygnatur** binarn, poniewa偶 **deweloper**, kt贸ry j podpisa, mo偶e by ju偶 **powizany** z **zoliwym oprogramowaniem**.
```bash
#Get signer
codesign -vv -d /bin/ls 2>&1 | grep -E "Authority|TeamIdentifier"

#Check if the apps contents have been modified
codesign --verify --verbose /Applications/Safari.app

#Check if the signature is valid
spctl --assess --verbose /Applications/Safari.app
```
## Techniki Wykrywania

### Skadanie Plik贸w

Jeli wiesz, 偶e pewny folder zawierajcy **pliki** serwera internetowego zosta **ostatnio zaktualizowany w pewnej dacie**. **Sprawd藕** dat, kiedy wszystkie **pliki** w **serwerze internetowym** zostay utworzone i zmodyfikowane, a jeli kt贸ra data jest **podejrzana**, sprawd藕 ten plik.

### Punkty Odniesienia

Jeli pliki w folderze **nie powinny zosta zmodyfikowane**, mo偶esz obliczy **skr贸t** **oryginalnych plik贸w** z folderu i **por贸wna** je z **aktualnymi**. Wszelkie zmiany bd **podejrzane**.

### Analiza Statystyczna

Kiedy informacje s zapisywane w logach, mo偶esz **sprawdzi statystyki, takie jak ile razy ka偶dy plik serwera internetowego by odwiedzany, poniewa偶 web shell mo偶e by jednym z najczciej u偶ywanych**.
