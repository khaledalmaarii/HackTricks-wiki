# Ataki GLBP i HSRP

<details>

<summary><strong>Dowiedz si, jak hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>


## Przegld atak贸w FHRP Hijacking

### Wprowadzenie do FHRP
FHRP zosta zaprojektowany w celu zapewnienia niezawodnoci sieci poprzez poczenie wielu router贸w w jednostk wirtualn, co zwiksza rozo偶enie obci偶enia i odporno na awarie. Cisco Systems wprowadzi w tej grupie prominentne protokoy, takie jak GLBP i HSRP.

### Informacje o protokole GLBP
GLBP, stworzony przez Cisco, dziaa na stosie TCP/IP, wykorzystujc UDP na porcie 3222 do komunikacji. Routery w grupie GLBP wymieniaj pakiety "hello" co 3 sekundy. Jeli router nie wysya tych pakiet贸w przez 10 sekund, uwa偶a si go za offline. Jednak te timery nie s stae i mog by modyfikowane.

### Operacje i rozo偶enie obci偶enia w GLBP
GLBP wyr贸偶nia si umo偶liwieniem rozo偶enia obci偶enia midzy routerami za pomoc jednego wirtualnego adresu IP i wielu wirtualnych adres贸w MAC. W grupie GLBP ka偶dy router bierze udzia w przekazywaniu pakiet贸w. W odr贸偶nieniu od HSRP/VRRP, GLBP oferuje prawdziwe r贸wnowa偶enie obci偶enia za pomoc kilku mechanizm贸w:

- **R贸wnowa偶enie obci偶enia zale偶ne od hosta:** Utrzymuje stae przypisanie adresu MAC AVF do hosta, co jest istotne dla stabilnych konfiguracji NAT.
- **R贸wnowa偶enie obci偶enia typu Round-Robin:** Domylne podejcie, polegajce na naprzemiennym przypisywaniu adresu MAC AVF 偶dajcym hostom.
- **R贸wnowa偶enie obci偶enia typu Weighted Round-Robin:** Rozkada obci偶enie na podstawie predefiniowanych metryk "Weight".

### Kluczowe komponenty i terminologia w GLBP
- **AVG (Active Virtual Gateway):** G贸wny router odpowiedzialny za przydzielanie adres贸w MAC routerom r贸wnorzdnym.
- **AVF (Active Virtual Forwarder):** Router wyznaczony do zarzdzania ruchem sieciowym.
- **Priorytet GLBP:** Metryka okrelajca AVG, zaczynajca si od domylnej wartoci 100 i mieszczca si w zakresie od 1 do 255.
- **Waga GLBP:** Odzwierciedla obecne obci偶enie routera, kt贸re mo偶na dostosowa rcznie lub za pomoc ledzenia obiekt贸w.
- **Wirtualny adres IP GLBP:** Su偶y jako domylna brama sieciowa dla wszystkich podczonych urzdze.

Do interakcji GLBP wykorzystuje zarezerwowany adres multicastowy 224.0.0.102 i port UDP 3222. Routery wysyaj pakiety "hello" co 3 sekundy i s uwa偶ane za nieoperacyjne, jeli pakiet zostanie pominity przez okres 10 sekund.

### Mechanizm ataku GLBP
Atakujcy mo偶e sta si g贸wnym routerem, wysyajc pakiet GLBP z najwy偶sz wartoci priorytetu (255). Mo偶e to prowadzi do atak贸w typu DoS lub MITM, umo偶liwiajcych przechwytywanie lub przekierowywanie ruchu.

### Wykonanie ataku GLBP za pomoc Loki
[Loki](https://github.com/raizo62/loki_on_kali) mo偶e przeprowadzi atak GLBP poprzez wstrzyknicie pakietu z ustawionymi priorytetem i wag na 255. Kroki przed atakiem obejmuj zbieranie informacji, takich jak wirtualny adres IP, obecno uwierzytelniania i wartoci priorytetu routera za pomoc narzdzi takich jak Wireshark.

Kroki ataku:
1. Przecz si w tryb promiskuitywny i wcz przekazywanie IP.
2. Zidentyfikuj docelowy router i pobierz jego adres IP.
3. Wygeneruj Gratuitous ARP.
4. Wstrzyknij zoliwy pakiet GLBP, podszywajc si pod AVG.
5. Przypisz drugi adres IP do interfejsu sieciowego atakujcego, odzwierciedlajc wirtualny adres IP GLBP.
6. Wdro偶 SNAT dla penej widocznoci ruchu.
7. Dostosuj trasowanie, aby zapewni kontynuowany dostp do Internetu przez oryginalny router AVG.

Postpujc zgodnie z tymi krokami, atakujcy staje si "czowiekiem porednim", zdolnym do przechwytywania i analizowania ruchu sieciowego, w tym danych niezaszyfrowanych lub wra偶liwych.

Poni偶ej znajduj si wymagane fragmenty polece do demonstracji:
```bash
# Enable promiscuous mode and IP forwarding
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1

# Configure secondary IP and SNAT
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# Adjust routing
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
Monitorowanie i przechwytywanie ruchu mo偶na przeprowadzi za pomoc narzdzi takich jak net-creds.py w celu przechwycenia i analizy danych przepywajcych przez skompromitowan sie.

### Pasywne wyjanienie ataku HSRP Hijacking z szczeg贸ami polece

#### Przegld protokou HSRP (Hot Standby Router/Redundancy Protocol)
HSRP to protok贸 wasnociowy firmy Cisco, zaprojektowany do zapewnienia redundancji bramy sieciowej. Umo偶liwia konfiguracj wielu fizycznych router贸w w jednostk logiczn o wsp贸lnym adresie IP. Ta jednostka logiczna jest zarzdzana przez router g贸wny, kt贸ry odpowiada za kierowanie ruchem. W przeciwiestwie do GLBP, kt贸ry wykorzystuje metryki takie jak priorytet i waga do r贸wnowa偶enia obci偶enia, HSRP polega na pojedynczym aktywnym routerze do zarzdzania ruchem.

#### Role i terminologia w HSRP
- **Aktywny router HSRP**: Urzdzenie penice rol bramy, zarzdzajce przepywem ruchu.
- **Rezerwowy router HSRP**: Rezerwowy router gotowy do przejcia roli aktywnego routera w przypadku awarii.
- **Grupa HSRP**: Zbi贸r router贸w wsp贸pracujcych w celu utworzenia jednego odpornego wirtualnego routera.
- **Adres MAC HSRP**: Wirtualny adres MAC przypisany do logicznego routera w konfiguracji HSRP.
- **Wirtualny adres IP HSRP**: Wirtualny adres IP grupy HSRP, dziaajcy jako domylna brama dla podczonych urzdze.

#### Wersje HSRP
HSRP wystpuje w dw贸ch wersjach, HSRPv1 i HSRPv2, r贸偶nicych si g贸wnie pojemnoci grupy, wykorzystaniem adres贸w IP multicast oraz struktur wirtualnego adresu MAC. Protok贸 wykorzystuje okrelone adresy IP multicast do wymiany informacji o usudze, wysyajc pakiety Hello co 3 sekundy. Jeli w cigu 10 sekund nie zostanie odebrany 偶aden pakiet, router jest uwa偶any za nieaktywny.

#### Mechanizm ataku HSRP
Ataki HSRP polegaj na przymusowym przejciu roli Aktywnego Routera poprzez wstrzyknicie maksymalnej wartoci priorytetu. Mo偶e to prowadzi do ataku typu Man-In-The-Middle (MITM). Istotne kroki przed atakiem obejmuj zbieranie danych na temat konfiguracji HSRP, co mo偶na zrobi za pomoc programu Wireshark do analizy ruchu.

#### Kroki do obejcia uwierzytelniania HSRP
1. Zapisz ruch sieciowy zawierajcy dane HSRP jako plik .pcap.
```shell
tcpdump -w hsrp_traffic.pcap
```
2. Wyodrbnij skr贸ty MD5 z pliku .pcap za pomoc hsrp2john.py.
```shell
python2 hsrp2john.py hsrp_traffic.pcap > hsrp_hashes
```
3. Odszyfruj skr贸ty MD5 za pomoc programu John the Ripper.
```shell
john --wordlist=mywordlist.txt hsrp_hashes
```

**Wykonanie wstrzyknicia HSRP za pomoc Loki**

1. Uruchom Loki, aby zidentyfikowa reklamy HSRP.
2. Ustaw interfejs sieciowy w tryb promiskuitywny i wcz przekazywanie pakiet贸w IP.
```shell
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1
```
3. U偶yj Loki, aby zaatakowa okrelony router, wprowad藕 odszyfrowane haso HSRP i wykonaj niezbdne konfiguracje w celu podszywania si pod Aktywnego Routera.
4. Po przejciu roli Aktywnego Routera skonfiguruj interfejs sieciowy i tabele IP, aby przechwytywa prawidowy ruch.
```shell
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
5. Zmodyfikuj tablic routingu, aby kierowa ruch przez poprzedniego Aktywnego Routera.
```shell
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
6. U偶yj narzdzia net-creds.py lub podobnego, aby przechwyci dane uwierzytelniajce z przechwyconego ruchu.
```shell
sudo python2 net-creds.py -i eth0
```

Wykonanie tych krok贸w umieszcza atakujcego w pozycji do przechwytywania i manipulowania ruchem, podobnie jak w przypadku przejcia GLBP. Uwydatnia to podatno protoko贸w redundancji takich jak HSRP i konieczno stosowania solidnych rodk贸w bezpieczestwa.


## Odwoania
- [https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9](https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9)


<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy **reklam swojej firmy w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi trikami hakerskimi, przesyajc PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
