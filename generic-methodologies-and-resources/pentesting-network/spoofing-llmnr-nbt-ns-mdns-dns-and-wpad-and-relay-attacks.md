# La쬴ranje LLMNR, NBT-NS, mDNS/DNS i WPAD i napadi preusmeravanja

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Mre쬹i protokoli

### Protokoli lokalne rezolucije doma캖ina
- **LLMNR, NBT-NS i mDNS**:
- Microsoft i drugi operativni sistemi koriste LLMNR i NBT-NS za lokalnu rezoluciju imena kada DNS ne uspe. Sli캜no tome, Apple i Linux sistemi koriste mDNS.
- Ovi protokoli su podlo쬹i presretanju i la쬴ranju zbog svoje neautentifikovane, emitovane prirode preko UDP-a.
- [Responder](https://github.com/lgandx/Responder) se mo쬰 koristiti za la쬴ranje usluga slanjem la쬴ranih odgovora na upite ovih protokola.
- Dodatne informacije o la쬴ranju usluga pomo캖u Responder-a mogu se prona캖i [ovde](spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md).

### Protokol automatskog otkrivanja veb proksija (WPAD)
- WPAD omogu캖ava pregleda캜ima automatsko otkrivanje pode코avanja proksija.
- Otkrivanje se olak코ava putem DHCP-a, DNS-a ili prelaska na LLMNR i NBT-NS ako DNS ne uspe.
- Responder mo쬰 automatizovati napade na WPAD, usmeravaju캖i klijente ka zlonamernim WPAD serverima.

### Responder za trovanje protokola
- **Responder** je alat koji se koristi za trovanje LLMNR, NBT-NS i mDNS upita, selektivno odgovaraju캖i na osnovu tipova upita, uglavnom ciljaju캖i SMB usluge.
- Dolazi preinstaliran u Kali Linux-u, konfigurabilan na lokaciji `/etc/responder/Responder.conf`.
- Responder prikazuje uhva캖ene he코ove na ekranu i 캜uva ih u direktorijumu `/usr/share/responder/logs`.
- Podr쬬va IPv4 i IPv6.
- Windows verzija Responder-a je dostupna [ovde](https://github.com/lgandx/Responder-Windows).

#### Pokretanje Responder-a
- Za pokretanje Responder-a sa podrazumevanim pode코avanjima: `responder -I <Interfejs>`
- Za agresivnije ispitivanje (sa potencijalnim sporednim efektima): `responder -I <Interfejs> -P -r -v`
- Tehnike za hvatanje NTLMv1 izazova/odgovora radi lak코eg pucanja: `responder -I <Interfejs> --lm --disable-ess`
- La쬴ranje WPAD-a se mo쬰 aktivirati sa: `responder -I <Interfejs> --wpad`
- NetBIOS zahtevi mogu biti re코eni na IP napada캜a, a mo쬰 se postaviti i proksi za autentifikaciju: `responder.py -I <interfejs> -Pv`

### Trovanje DHCP-om pomo캖u Responder-a
- La쬴ranje DHCP odgovora mo쬰 trajno otrovati informacije o rutiranju rtve, nude캖i prikriveniju alternativu za trovanje ARP-om.
- Zahteva precizno poznavanje konfiguracije ciljne mre쬰.
- Pokretanje napada: `./Responder.py -I eth0 -Pdv`
- Ova metoda mo쬰 efikasno uhvatiti NTLMv1/2 he코ove, ali zahteva pa쬷jivo rukovanje kako bi se izbeglo ometanje mre쬰.

### Hvatanje akreditacija pomo캖u Responder-a
- Responder 캖e la쬴rati usluge koriste캖i gorenavedene protokole, hvataju캖i akreditacije (obi캜no NTLMv2 Izazov/Odgovor) kada korisnik poku코a da se autentifikuje protiv la쬴ranih usluga.
- Mogu se preduzeti poku코aji da se smanji na NetNTLMv1 ili onemogu캖i ESS radi lak코eg pucanja akreditacija.

Va쬹o je napomenuti da se ove tehnike trebaju primenjivati legalno i eti캜ki, uz obezbe캠ivanje odgovaraju캖e autorizacije i izbegavanje ometanja ili neovla코캖enog pristupa.

## Inveigh

Inveigh je alat namenjen penetracionim testiranjima i timovima za crveno hakovanje, dizajniran za Windows sisteme. Nudi funkcionalnosti sli캜ne Responder-u, izvode캖i la쬴ranje i napade 캜ovek-u-sredini. Alat se razvio iz PowerShell skripte u C# binarni fajl, sa [**Inveigh**](https://github.com/Kevin-Robertson/Inveigh) i [**InveighZero**](https://github.com/Kevin-Robertson/InveighZero) kao glavnim verzijama. Detaljni parametri i uputstva mogu se prona캖i u [**wiki-ju**](https://github.com/Kevin-Robertson/Inveigh/wiki/Parameters).

Inveigh se mo쬰 koristiti putem PowerShell-a:
```powershell
Invoke-Inveigh -NBNS Y -ConsoleOutput Y -FileOutput Y
```
Ili izvr코eno kao C# binarni fajl:
```bash
Inveigh.exe
```
### NTLM Relay Napad

Ovaj napad koristi SMB autentifikacijske sesije kako bi pristupio ciljnom ra캜unalu, pru쬬ju캖i sistemsku ljusku ako je uspje코an. Klju캜ni preduvjeti uklju캜uju:
- Autentificirani korisnik mora imati lokalni administratorski pristup na preusmjerenom ra캜unalu.
- Potrebno je onemogu캖iti SMB potpisivanje.

#### Preusmjeravanje i tuneliranje porta 445

U scenarijima gdje direktno umre쬬vanje nije izvedivo, promet na portu 445 treba biti preusmjeren i tuneliran. Alati poput [**PortBender**](https://github.com/praetorian-inc/PortBender) poma쬿 u preusmjeravanju prometa na portu 445 na drugi port, 코to je bitno kada je dostupan lokalni administratorski pristup za u캜itavanje upravlja캜kog programa.

Postavljanje i rad PortBendera u Cobalt Strike-u:
```bash
Cobalt Strike -> Script Manager -> Load (Select PortBender.cna)

beacon> cd C:\Windows\system32\drivers # Navigate to drivers directory
beacon> upload C:\PortBender\WinDivert64.sys # Upload driver
beacon> PortBender redirect 445 8445 # Redirect traffic from port 445 to 8445
beacon> rportfwd 8445 127.0.0.1 445 # Route traffic from port 8445 to Team Server
beacon> socks 1080 # Establish a SOCKS proxy on port 1080

# Termination commands
beacon> jobs
beacon> jobkill 0
beacon> rportfwd stop 8445
beacon> socks stop
```
### Ostali alati za NTLM Relay napad

- **Metasploit**: Podesite sa proxy-jima, lokalnim i udaljenim detaljima hosta.
- **smbrelayx**: Python skripta za preusmeravanje SMB sesija i izvr코avanje komandi ili postavljanje zadnjih vrata.
- **MultiRelay**: Alat iz Responder suite-a za preusmeravanje odre캠enih korisnika ili svih korisnika, izvr코avanje komandi ili ispisivanje he코eva.

Svaki alat se mo쬰 konfigurisati da radi preko SOCKS proxy-ja ako je potrebno, omogu캖avaju캖i napade 캜ak i sa indirektnim pristupom mre쬴.

### Rad MultiRelay-a

MultiRelay se pokre캖e iz direktorijuma _**/usr/share/responder/tools**_, ciljaju캖i odre캠ene IP adrese ili korisnike.
```bash
python MultiRelay.py -t <IP target> -u ALL # Relay all users
python MultiRelay.py -t <IP target> -u ALL -c whoami # Execute command
python MultiRelay.py -t <IP target> -u ALL -d # Dump hashes

# Proxychains for routing traffic
```
Ovi alati i tehnike 캜ine sveobuhvatan set za izvo캠enje NTLM Relay napada u razli캜itim mre쬹im okru쬰njima.

### Prisiljavanje NTLM prijava

U sustavu Windows **mo쬰te prisiliti neke privilegirane ra캜une da se autentificiraju na proizvoljnim ma코inama**. Pro캜itajte sljede캖u stranicu da biste saznali kako:

{% content-ref url="../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md" %}
[printers-spooler-service-abuse.md](../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md)
{% endcontent-ref %}

## Reference
* [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
* [https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/](https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/)
* [https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/](https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/)
* [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
* [https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html](https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html)


<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite vidjeti **va코u kompaniju ogla코enu na HackTricks-u** ili **preuzeti HackTricks u PDF formatu** Provjerite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podijelite svoje hakiraju캖e trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
