# FreeIPA Pentesting

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**PorodiÄnu PEASS**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Osnovne informacije

FreeIPA je open-source **alternativa** Microsoft Windows **Active Directory**-u, preteÅ¾no za **Unix** okruÅ¾enja. Kombinuje kompletan **LDAP direktorijum** sa MIT **Kerberos** centrom za distribuciju kljuÄeva za upravljanje sliÄno Active Directory-u. Koristi Dogtag **Certificate System** za upravljanje CA & RA sertifikatima, podrÅ¾ava **multi-faktorsku** autentikaciju, ukljuÄujuÄ‡i pametne kartice. SSSD je integrisan za Unix autentikacione procese.

## Otisci

### Fajlovi i promenljive okruÅ¾enja

* Fajl na lokaciji `/etc/krb5.conf` je gde se Äuvaju informacije o Kerberos klijentu, neophodne za upis u domen. To ukljuÄuje lokacije KDC-ova i admin servera, podrazumevane postavke i mapiranja.
* Podrazumevane postavke za IPA klijente i servere se postavljaju u fajlu na lokaciji `/etc/ipa/default.conf`.
* Hostovi unutar domena moraju imati fajl `krb5.keytab` na lokaciji `/etc/krb5.keytab` za autentikacione procese.
* RazliÄite promenljive okruÅ¾enja (`KRB5CCNAME`, `KRB5_KTNAME`, `KRB5_CONFIG`, `KRB5_KDC_PROFILE`, `KRB5RCACHETYPE`, `KRB5RCACHEDIR`, `KRB5_TRACE`, `KRB5_CLIENT_KTNAME`, `KPROP_PORT`) se koriste za pokazivanje specifiÄnih fajlova i postavki relevantnih za Kerberos autentikaciju.

### Binarni fajlovi

Alati poput `ipa`, `kdestroy`, `kinit`, `klist`, `kpasswd`, `ksu`, `kswitch` i `kvno` su centralni za upravljanje FreeIPA domenima, rukovanje Kerberos tiketima, menjanje lozinki i dobijanje servisnih tiketa, meÄ‘u ostalim funkcionalnostima.

### MreÅ¾a

Dostupna je ilustracija koja prikazuje tipiÄan FreeIPA server setup.

## Autentikacija

Autentikacija u FreeIPA, koristeÄ‡i **Kerberos**, odraÅ¾ava onu u **Active Directory**-u. Pristup resursima domena zahteva validan Kerberos tiket, koji se moÅ¾e Äuvati na razliÄitim lokacijama u zavisnosti od konfiguracije FreeIPA domena.

### **CCACHE Tiket fajlovi**

CCACHE fajlovi, obiÄno smeÅ¡teni u **`/tmp`** sa **600** dozvolama, su binarni formati za Äuvanje Kerberos akreditiva, vaÅ¾ni za autentikaciju bez korisnikove plaintext lozinke zbog njihove prenosivosti. Parsiranje CCACHE tiketa se moÅ¾e obaviti koriÅ¡Ä‡enjem `klist` komande, a ponovna upotreba validnog CCACHE Tiketa ukljuÄuje izvoz `KRB5CCNAME` na putanju fajla tiketa.

### **Unix Keyring**

Alternativno, CCACHE Tiketi se mogu Äuvati u Linux keyring-u, nudeÄ‡i viÅ¡e kontrole nad upravljanjem tiketima. Obim Äuvanja tiketa varira (`KEYRING:ime`, `KEYRING:proces:ime`, `KEYRING:nit:ime`, `KEYRING:sednica:ime`, `KEYRING:trajni:uidbroj`), pri Äemu je `klist` sposoban da parsira ove informacije za korisnika. MeÄ‘utim, ponovna upotreba CCACHE Tiketa iz Unix keyring-a moÅ¾e predstavljati izazove, sa alatima poput **Tickey** dostupnim za izvlaÄenje Kerberos tiketa.

### Keytab

Keytab fajlovi, koji sadrÅ¾e Kerberos principe i Å¡ifrovane kljuÄeve, su kljuÄni za dobijanje validnih tiketa za dodelu kljuÄeva (TGT) bez potrebe za korisnikovom lozinkom. Parsiranje i ponovna upotreba akreditiva iz keytab fajlova se lako moÅ¾e izvrÅ¡iti pomoÄ‡u alatki poput `klist` i skripti poput **KeytabParser**.

### Å ifarnik

ViÅ¡e informacija o koriÅ¡Ä‡enju tiketa u linuxu moÅ¾ete pronaÄ‡i na sledeÄ‡em linku:

{% content-ref url="privilege-escalation/linux-active-directory.md" %}
[linux-active-directory.md](privilege-escalation/linux-active-directory.md)
{% endcontent-ref %}

## Enumeracija

{% hint style="warning" %}
MoÅ¾ete izvrÅ¡iti **enumeraciju** putem **ldap-a** i drugih **binarnih** alata, ili **povezivanjem na veb stranicu na portu 443 FreeIPA servera**.
{% endhint %}

### Hostovi, Korisnici i Grupe <a href="#id-4b3b" id="id-4b3b"></a>

MoguÄ‡e je kreirati **hostove**, **korisnike** i **grupe**. Hostovi i korisnici su smeÅ¡teni u kontejnere nazvane â€œ**Host Grupe**â€ i â€œ**User Grupe**â€ respektivno. Ovi su sliÄni **Organizacionim Jedinicama** (OU).

Podrazumevano u FreeIPA, LDAP server dozvoljava **anonimne bindove**, i veliki deo podataka je enumerabilan **neautentifikovan**. Ovo moÅ¾e enumerisati sve dostupne podatke neautentifikovano:
```
ldapsearch -x
```
Da biste dobili **viÅ¡e informacija**, morate koristiti **autentifikovanu** sesiju (proverite odeljak o Autentifikaciji kako biste saznali kako da pripremite autentifikovanu sesiju).
```bash
# Get all users of domain
ldapsearch -Y gssapi -b "cn=users,cn=compat,dc=domain_name,dc=local"

# Get users groups
ldapsearch -Y gssapi -b "cn=groups,cn=accounts,dc=domain_name,dc=local"

# Get all the hosts
ldapsearch -Y gssapi -b "cn=computers,cn=accounts,dc=domain_name,dc=local"

# Get hosts groups
ldapsearch -Y gssapi -b "cn=hostgroups,cn=accounts,dc=domain_name,dc=local"
```
Sa raÄunara pridruÅ¾enog domenu moÄ‡i Ä‡ete koristiti **instalirane binarne datoteke** za enumeraciju domena:
```bash
ipa user-find
ipa usergroup-find
ipa host-find
ipa host-group-find

-------------------

ipa user-show <username> --all
ipa usergroup-show <user group> --all
ipa host-find <host> --all
ipa hostgroup-show <host group> --all
```
{% hint style="info" %}
Korisnik **admin** u **FreeIPA**-i je ekvivalentan **domain admin**-ima iz **AD**-a.
{% endhint %}

### Hesovi <a href="#id-482b" id="id-482b"></a>

Korisnik **root** sa **IPA servera** ima pristup hesovima lozinki.

* Hes lozinke korisnika je saÄuvan kao **base64** u atributu â€œ**userPassword**â€. Ovaj hes moÅ¾e biti **SSHA512** (stare verzije FreeIPA) ili **PBKDF2\_SHA256**.
* **Nthash** lozinke je saÄuvan kao **base64** u â€œ**ipaNTHash**â€ ako sistem ima **integraciju** sa **AD**-om.

Da biste probili ove hesove:

â€¢ Ako je FreeIPA integrisan sa AD-om, **ipaNTHash** je lako probiti: Treba da **dekodirate** **base64** -> ponovo kodirate kao **ASCII** heks -> John The Ripper ili **hashcat** vam mogu pomoÄ‡i da ga brzo probijete

â€¢ Ako se koristi stara verzija FreeIPA, pa se koristi **SSHA512**: Treba da dekodirate **base64** -> pronaÄ‘ete SSHA512 **hes** -> John The Ripper ili **hashcat** vam mogu pomoÄ‡i da ga probijete

â€¢ Ako se koristi nova verzija FreeIPA, pa se koristi **PBKDF2\_SHA256**: Treba da dekodirate **base64** -> pronaÄ‘ete PBKDF2\_SHA256 -> njegova **duÅ¾ina** je 256 bajtova. John moÅ¾e raditi sa 256 bita (32 bajta) -> SHA-265 se koristi kao pseudo-sluÄajna funkcija, veliÄina bloka je 32 bajta -> moÅ¾ete koristiti samo prvih 256 bita naÅ¡eg PBKDF2\_SHA256 hesa -> John The Ripper ili hashcat vam mogu pomoÄ‡i da ga probijete

<figure><img src="../.gitbook/assets/image (655).png" alt=""><figcaption></figcaption></figure>

Da biste izvukli hesove, morate biti **root na FreeIPA serveru**, tamo moÅ¾ete koristiti alatku **`dbscan`** da ih izvuÄete:

<figure><img src="../.gitbook/assets/image (293).png" alt=""><figcaption></figcaption></figure>

### HBAC-Pravila <a href="#id-482b" id="id-482b"></a>

Ovo su pravila koja dodeljuju specifiÄna ovlaÅ¡Ä‡enja korisnicima ili hostovima nad resursima (hostovi, servisi, grupe servisa...).
```bash
# Enumerate using ldap
ldapsearch -Y gssapi -b "cn=hbac,dc=domain_name,dc=local"
# Using ipa
ipa hbacrule-find
# Show info of rule
ipa hbacrule-show <hbacrule> --all
```
#### Sudo-pravila

FreeIPA omoguÄ‡ava centralizovanu kontrolu nad **sudo dozvolama** putem sudo-pravila. Ova pravila omoguÄ‡avaju ili ograniÄavaju izvrÅ¡avanje komandi sa sudo-om na hostovima unutar domena. NapadaÄ bi potencijalno mogao identifikovati primenljive hostove, korisnike i dozvoljene komande pregledom ovih setova pravila.
```bash
# Enumerate using ldap
ldapsearch -Y gssapi -b "cn=sudorules,cn=sudo,dc=domain_name,dc=local"
# Using ipa
ipa sudorule-find
# Show info of rule
ipa sudorule-show <sudorule> --all
```
### Kontrola pristupa zasnovana na ulogama

**Uloga** se sastoji od razliÄitih **privilegija**, od kojih svaka obuhvata kolekciju **dozvola**. Ove uloge mogu biti dodeljene korisnicima, korisniÄkim **grupama**, **raÄunarima**, grupama raÄunara i uslugama. Na primer, razmotrite podrazumevanu ulogu "Administrator korisnika" u sistemu FreeIPA da biste ilustrovali ovu strukturu.

Uloga `Administrator korisnika` ima sledeÄ‡e privilegije:

- **Administratori korisnika**
- **Administratori grupa**
- **Administratori faze korisnika**

PomoÄ‡u sledeÄ‡ih komandi moguÄ‡e je nabrojati uloge, privilegije i dozvole:
```bash
# Using ldap
ldapsearch -Y gssapi -b "cn=roles,cn=accounts,dc=westeros,dc=local"
# Using ipa binary
ipa role-find
ipa role-show <role> --all
ipa privilege-find
ipa privilege-show <privilege> --all
ipa permission-find
ipa permission-show <permission> --all
```
### Primer napadaÄkog scenarija

U [https://posts.specterops.io/attacking-freeipa-part-iii-finding-a-path-677405b5b95e](https://posts.specterops.io/attacking-freeipa-part-iii-finding-a-path-677405b5b95e) moÅ¾ete pronaÄ‡i jednostavan primer kako zloupotrebiti odreÄ‘ene dozvole da biste kompromitovali domen.

### Linikatz/LinikatzV2

* [https://github.com/Orange-Cyberdefense/LinikatzV2](https://github.com/Orange-Cyberdefense/LinikatzV2)
* [https://github.com/CiscoCXSecurity/linikatz](https://github.com/CiscoCXSecurity/linikatz)

## Eskalacija privilegija

### ~~kreiranje korisnika root~~

{% hint style="warning" %}
Ako moÅ¾ete **kreirati novog korisnika sa imenom `root`**, moÅ¾ete se predstaviti kao on i moÄ‡i Ä‡ete **SSH-ovati na bilo koju maÅ¡inu kao root.**

**OVO JE POPRAVLJENO.**
{% endhint %}

Detaljno objaÅ¡njenje moÅ¾ete pronaÄ‡i na [https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b](https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b)

## Reference

* [https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b](https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b)
* [https://posts.specterops.io/attacking-freeipa-part-i-authentication-77e73d837d6a](https://posts.specterops.io/attacking-freeipa-part-i-authentication-77e73d837d6a)
* [https://posts.specterops.io/attacking-freeipa-part-ii-enumeration-ad27224371e1](https://posts.specterops.io/attacking-freeipa-part-ii-enumeration-ad27224371e1)
* [https://www.youtube.com/watch?v=9dOu-7BTwPQ](https://www.youtube.com/watch?v=9dOu-7BTwPQ)

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili **telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
