# FreeIPA Pentesting

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Osnovne informacije

FreeIPA je open-source **alternativa** za Microsoft Windows **Active Directory**, uglavnom za **Unix** okru쬰nja. Kombinuje potpuni **LDAP direktorijum** sa MIT **Kerberos** Key Distribution Centrom za upravljanje sli캜no kao Active Directory. Koristi Dogtag **Certificate System** za upravljanje CA & RA sertifikatima, podr쬬va **multi-factor** autentifikaciju, uklju캜uju캖i pametne kartice. SSSD je integrisan za Unix autentifikacione procese.

## Fingerprintovi

### Fajlovi i Environment Promenljive

- Fajl na lokaciji `/etc/krb5.conf` je mesto gde se 캜uvaju informacije o Kerberos klijentu, neophodne za upis u domen. To uklju캜uje lokacije KDC-ova i admin servera, podrazumevane postavke i mapiranja.
- Sistemski podrazumevane vrednosti za IPA klijente i servere se pode코avaju u fajlu koji se nalazi na lokaciji `/etc/ipa/default.conf`.
- Hostovi unutar domena moraju imati `krb5.keytab` fajl na lokaciji `/etc/krb5.keytab` za autentifikacione procese.
- Razli캜ite environment promenljive (`KRB5CCNAME`, `KRB5_KTNAME`, `KRB5_CONFIG`, `KRB5_KDC_PROFILE`, `KRB5RCACHETYPE`, `KRB5RCACHEDIR`, `KRB5_TRACE`, `KRB5_CLIENT_KTNAME`, `KPROP_PORT`) se koriste za pokazivanje na odre캠ene fajlove i postavke relevantne za Kerberos autentifikaciju.

### Binarni fajlovi

Alati poput `ipa`, `kdestroy`, `kinit`, `klist`, `kpasswd`, `ksu`, `kswitch` i `kvno` su centralni za upravljanje FreeIPA domenima, rukovanje Kerberos karticama, menjanje lozinki i dobijanje servisnih karata, me캠u ostalim funkcionalnostima.

### Mre쬬

Prikazan je ilustracija tipi캜nog FreeIPA server setup-a.

## Autentifikacija

Autentifikacija u FreeIPA, koriste캖i **Kerberos**, sli캜na je autentifikaciji u **Active Directory**-ju. Pristup resursima domena zahteva validnu Kerberos karticu, koja se mo쬰 캜uvati na razli캜itim lokacijama u zavisnosti od konfiguracije FreeIPA domena.

### **CCACHE Ticket Fajlovi**

CCACHE fajlovi, obi캜no sme코teni u **`/tmp`** sa **600** dozvolama, su binarni formati za 캜uvanje Kerberos akreditiva, va쬹i za autentifikaciju bez korisnikove plaintext lozinke zbog njihove prenosivosti. Parsiranje CCACHE karte se mo쬰 obaviti pomo캖u `klist` komande, a ponovna upotreba validne CCACHE karte uklju캜uje izvoz `KRB5CCNAME` na putanju fajla sa kartom.

### **Unix Keyring**

Alternativno, CCACHE karte se mogu 캜uvati u Linux keyring-u, pru쬬ju캖i vi코e kontrole nad upravljanjem karata. Opseg 캜uvanja karata varira (`KEYRING:ime`, `KEYRING:proces:ime`, `KEYRING:nit:ime`, `KEYRING:sednica:ime`, `KEYRING:trajno:uidbroj`), pri 캜emu `klist` mo쬰 parsirati ove informacije za korisnika. Me캠utim, ponovna upotreba CCACHE karte iz Unix keyring-a mo쬰 predstavljati izazove, a dostupni su alati poput **Tickey** za izvla캜enje Kerberos karata.

### Keytab

Keytab fajlovi, koji sadr쬰 Kerberos principe i enkriptovane klju캜eve, su klju캜ni za dobijanje validnih kartica za dodelu karata (TGT) bez potrebe za lozinkom principala. Parsiranje i ponovna upotreba akreditiva iz keytab fajlova se mo쬰 lako izvr코iti pomo캖u alata poput `klist` i skripti kao 코to je **KeytabParser**.

### Cheat list

Vi코e informacija o tome kako koristiti karte u Linux-u mo쬰te prona캖i na slede캖em linku:

{% content-ref url="privilege-escalation/linux-active-directory.md" %}
[linux-active-directory.md](privilege-escalation/linux-active-directory.md)
{% endcontent-ref %}

## Enumeracija

{% hint style="warning" %}
Mo쬰te izvr코iti **enumeraciju** putem **ldap** i drugih **binarnih** alata, ili **povezivanjem na veb stranicu na portu 443 FreeIPA servera**.
{% endhint %}


### Hostovi, Korisnici i Grupe <a href="#4b3b" id="4b3b"></a>

Mogu캖e je kreirati **hostove**, **korisnike** i **grupe**. Hostovi i korisnici se sme코taju u kontejnere nazvane "**Host Grupe**" i "**Korisni캜ke Grupe**" respektivno. Ove grupe su sli캜ne **Organizacionim Jedinicama** (OU).

Podrazumevano u FreeIPA, LDAP server omogu캖ava **anonimne veze**, i veliki deo podataka je mogu캖e nabrojati **bez autentifikacije**. Ovo mo쬰 nabrojati sve dostupne podatke bez autentifikacije:
```
ldapsearch -x
```
Da biste dobili **vi코e informacija**, morate koristiti **autentifikovanu** sesiju (proverite odeljak o Autentifikaciji da biste nau캜ili kako da pripremite autentifikovanu sesiju).
```bash
# Get all users of domain
ldapsearch -Y gssapi -b "cn=users,cn=compat,dc=domain_name,dc=local"

# Get users groups
ldapsearch -Y gssapi -b "cn=groups,cn=accounts,dc=domain_name,dc=local"

# Get all the hosts
ldapsearch -Y gssapi -b "cn=computers,cn=accounts,dc=domain_name,dc=local"

# Get hosts groups
ldapsearch -Y gssapi -b "cn=hostgroups,cn=accounts,dc=domain_name,dc=local"
```
Sa ra캜unara koji je pridru쬰n domenu, mo쬰te koristiti **instalirane binarne datoteke** za enumeraciju domene:
```bash
ipa user-find
ipa usergroup-find
ipa host-find
ipa host-group-find

-------------------

ipa user-show <username> --all
ipa usergroup-show <user group> --all
ipa host-find <host> --all
ipa hostgroup-show <host group> --all
```
{% hint style="info" %}
Korisnik **admin** u **FreeIPA** je ekvivalentan **domain adminima** u **AD**-u.
{% endhint %}

### He코evi <a href="#482b" id="482b"></a>

Korisnik **root** sa **IPA servera** ima pristup he코evima lozinki.

- He코 lozinke korisnika je sa캜uvan kao **base64** u atributu "**userPassword**". Ovaj he코 mo쬰 biti **SSHA512** (starije verzije FreeIPA) ili **PBKDF2\_SHA256**.
- **Nthash** lozinke je sa캜uvan kao **base64** u atributu "**ipaNTHash**" ako sistem ima **integraciju** sa **AD**.

Da biste de코ifrovali ove he코e:

- Ako je FreeIPA integrisana sa AD-om, **ipaNTHash** je lako de코ifrovati: Treba da **dekodirate** **base64** -> ponovo kodirate kao **ASCII** heksadecimalno -> John The Ripper ili **hashcat** vam mogu pomo캖i da ga brzo de코ifrujete.

- Ako se koristi starija verzija FreeIPA, koristi se **SSHA512**: Treba da dekodirate **base64** -> prona캠ete SSHA512 **he코** -> John The Ripper ili **hashcat** vam mogu pomo캖i da ga de코ifrujete.

- Ako se koristi nova verzija FreeIPA, koristi se **PBKDF2\_SHA256**: Treba da dekodirate **base64** -> prona캠ete PBKDF2\_SHA256 -> njegova **du쬴na** je 256 bajtova. John mo쬰 raditi sa 256 bita (32 bajta) -> SHA-265 se koristi kao pseudo-slu캜ajna funkcija, veli캜ina bloka je 32 bajta -> mo쬰te koristiti samo prvih 256 bita na코eg PBKDF2\_SHA256 he코a -> John The Ripper ili hashcat vam mogu pomo캖i da ga de코ifrujete.

<figure><img src="../.gitbook/assets/image (33).png" alt=""><figcaption></figcaption></figure>

Da biste izvukli he코eve, morate biti **root na FreeIPA serveru**, tamo mo쬰te koristiti alat **`dbscan`** da ih izvu캜ete:

<figure><img src="../.gitbook/assets/image (196).png" alt=""><figcaption></figcaption></figure>

### HBAC pravila <a href="#482b" id="482b"></a>

Ovo su pravila koja dodeljuju odre캠ene dozvole korisnicima ili hostovima nad resursima (hostovi, servisi, grupe servisa...).
```bash
# Enumerate using ldap
ldapsearch -Y gssapi -b "cn=hbac,dc=domain_name,dc=local"
# Using ipa
ipa hbacrule-find
# Show info of rule
ipa hbacrule-show <hbacrule> --all
```
#### Sudo pravila

FreeIPA omogu캖ava centralizovanu kontrolu nad **sudo dozvolama** putem sudo pravila. Ova pravila omogu캖avaju ili ograni캜avaju izvr코avanje komandi sa sudo privilegijama na ra캜unarima unutar domene. Napada캜 bi potencijalno mogao identifikovati primenjive ra캜unare, korisnike i dozvoljene komande pregledanjem ovih pravila.
```bash
# Enumerate using ldap
ldapsearch -Y gssapi -b "cn=sudorules,cn=sudo,dc=domain_name,dc=local"
# Using ipa
ipa sudorule-find
# Show info of rule
ipa sudorule-show <sudorule> --all
```
### Kontrola pristupa zasnovana na ulogama

**Uloga** se sastoji od razli캜itih **privilegija**, pri 캜emu svaka privilegija obuhvata kolekciju **dozvola**. Ove uloge mogu biti dodeljene korisnicima, grupama korisnika, **hostovima**, grupama hostova i uslugama. Na primer, razmotrimo podrazumevanu ulogu "Administrator korisnika" u FreeIPA da bismo ilustrovali ovu strukturu.

Uloga `Administrator korisnika` ima slede캖e privilegije:

* **Administratori korisnika**
* **Administratori grupa**
* **Administratori korisnika na sceni**

Pomo캖u slede캖ih komandi mogu캖e je nabrojati uloge, privilegije i dozvole:
```bash
# Using ldap
ldapsearch -Y gssapi -b "cn=roles,cn=accounts,dc=westeros,dc=local"
# Using ipa binary
ipa role-find
ipa role-show <role> --all
ipa privilege-find
ipa privilege-show <privilege> --all
ipa permission-find
ipa permission-show <permission> --all
```
### Primer napada

U [https://posts.specterops.io/attacking-freeipa-part-iii-finding-a-path-677405b5b95e](https://posts.specterops.io/attacking-freeipa-part-iii-finding-a-path-677405b5b95e) mo쬰te prona캖i jednostavan primer kako zloupotrebiti odre캠ene dozvole da biste kompromitovali domen.

### Linikatz/LinikatzV2

* [https://github.com/Orange-Cyberdefense/LinikatzV2](https://github.com/Orange-Cyberdefense/LinikatzV2)
* [https://github.com/CiscoCXSecurity/linikatz](https://github.com/CiscoCXSecurity/linikatz)

## Pove캖anje privilegija

### ~~Kreiranje korisnika `root`~~

{% hint style="warning" %}
Ako mo쬰te **kreirati novog korisnika sa imenom `root`**, mo쬰te se predstaviti kao on i mo캖i 캖ete **SSH-ovati na bilo koju ma코inu kao root.**

**OVO JE POPRAVLJENO.**
{% endhint %}

Detaljno obja코njenje mo쬰te prona캖i na [https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b](https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b)

## Reference
* [https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b](https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b)
* [https://posts.specterops.io/attacking-freeipa-part-i-authentication-77e73d837d6a](https://posts.specterops.io/attacking-freeipa-part-i-authentication-77e73d837d6a)
* [https://posts.specterops.io/attacking-freeipa-part-ii-enumeration-ad27224371e1](https://posts.specterops.io/attacking-freeipa-part-ii-enumeration-ad27224371e1)
* [https://www.youtube.com/watch?v=9dOu-7BTwPQ](https://www.youtube.com/watch?v=9dOu-7BTwPQ)

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu**, proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
