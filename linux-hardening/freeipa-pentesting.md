# FreeIPA Pentesting

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

FreeIPA æ˜¯ä¸€ä¸ªå¼€æºçš„ **æ›¿ä»£å“**ï¼Œç”¨äº Microsoft Windows **Active Directory**ï¼Œä¸»è¦é’ˆå¯¹ **Unix** ç¯å¢ƒã€‚å®ƒç»“åˆäº†ä¸€ä¸ªå®Œæ•´çš„ **LDAP ç›®å½•** å’Œä¸€ä¸ª MIT **Kerberos** å¯†é’¥åˆ†å‘ä¸­å¿ƒï¼Œç®¡ç†æ–¹å¼ç±»ä¼¼äº Active Directoryã€‚åˆ©ç”¨ Dogtag **è¯ä¹¦ç³»ç»Ÿ** è¿›è¡Œ CA å’Œ RA è¯ä¹¦ç®¡ç†ï¼Œæ”¯æŒ **å¤šå› ç´ ** èº«ä»½éªŒè¯ï¼ŒåŒ…æ‹¬æ™ºèƒ½å¡ã€‚é›†æˆäº† SSSD ä»¥æ”¯æŒ Unix èº«ä»½éªŒè¯è¿‡ç¨‹ã€‚

## æŒ‡çº¹

### æ–‡ä»¶ä¸ç¯å¢ƒå˜é‡

* `/etc/krb5.conf` æ–‡ä»¶å­˜å‚¨ Kerberos å®¢æˆ·ç«¯ä¿¡æ¯ï¼Œè¿™æ˜¯åŠ å…¥åŸŸæ‰€å¿…éœ€çš„ï¼ŒåŒ…æ‹¬ KDC å’Œç®¡ç†å‘˜æœåŠ¡å™¨çš„ä½ç½®ã€é»˜è®¤è®¾ç½®å’Œæ˜ å°„ã€‚
* IPA å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨çš„ç³»ç»ŸèŒƒå›´é»˜è®¤è®¾ç½®åœ¨ `/etc/ipa/default.conf` æ–‡ä»¶ä¸­è®¾ç½®ã€‚
* åŸŸå†…çš„ä¸»æœºå¿…é¡»åœ¨ `/etc/krb5.keytab` å¤„æ‹¥æœ‰ `krb5.keytab` æ–‡ä»¶ä»¥è¿›è¡Œèº«ä»½éªŒè¯è¿‡ç¨‹ã€‚
* å„ç§ç¯å¢ƒå˜é‡ï¼ˆ`KRB5CCNAME`ã€`KRB5_KTNAME`ã€`KRB5_CONFIG`ã€`KRB5_KDC_PROFILE`ã€`KRB5RCACHETYPE`ã€`KRB5RCACHEDIR`ã€`KRB5_TRACE`ã€`KRB5_CLIENT_KTNAME`ã€`KPROP_PORT`ï¼‰ç”¨äºæŒ‡å‘ä¸ Kerberos èº«ä»½éªŒè¯ç›¸å…³çš„ç‰¹å®šæ–‡ä»¶å’Œè®¾ç½®ã€‚

### äºŒè¿›åˆ¶æ–‡ä»¶

å·¥å…·å¦‚ `ipa`ã€`kdestroy`ã€`kinit`ã€`klist`ã€`kpasswd`ã€`ksu`ã€`kswitch` å’Œ `kvno` æ˜¯ç®¡ç† FreeIPA åŸŸã€å¤„ç† Kerberos ç¥¨è¯ã€ä¿®æ”¹å¯†ç å’Œè·å–æœåŠ¡ç¥¨è¯ç­‰åŠŸèƒ½çš„æ ¸å¿ƒã€‚

### ç½‘ç»œ

æä¾›äº†ä¸€ä¸ªæ’å›¾æ¥æç»˜å…¸å‹çš„ FreeIPA æœåŠ¡å™¨è®¾ç½®ã€‚

## èº«ä»½éªŒè¯

FreeIPA ä¸­çš„èº«ä»½éªŒè¯åˆ©ç”¨ **Kerberos**ï¼Œä¸ **Active Directory** ä¸­çš„èº«ä»½éªŒè¯ç›¸ä¼¼ã€‚è®¿é—®åŸŸèµ„æºéœ€è¦æœ‰æ•ˆçš„ Kerberos ç¥¨è¯ï¼Œå…·ä½“å­˜å‚¨ä½ç½®å–å†³äº FreeIPA åŸŸé…ç½®ã€‚

### **CCACHE ç¥¨è¯æ–‡ä»¶**

CCACHE æ–‡ä»¶é€šå¸¸å­˜å‚¨åœ¨ **`/tmp`** ä¸­ï¼Œæƒé™ä¸º **600**ï¼Œæ˜¯ç”¨äºå­˜å‚¨ Kerberos å‡­æ®çš„äºŒè¿›åˆ¶æ ¼å¼ï¼Œé‡è¦çš„æ˜¯å¯ä»¥åœ¨æ²¡æœ‰ç”¨æˆ·æ˜æ–‡å¯†ç çš„æƒ…å†µä¸‹è¿›è¡Œèº«ä»½éªŒè¯ã€‚å¯ä»¥ä½¿ç”¨ `klist` å‘½ä»¤è§£æ CCACHE ç¥¨è¯ï¼Œé‡æ–°ä½¿ç”¨æœ‰æ•ˆçš„ CCACHE ç¥¨è¯æ¶‰åŠå°† `KRB5CCNAME` å¯¼å‡ºåˆ°ç¥¨è¯æ–‡ä»¶çš„è·¯å¾„ã€‚

### **Unix å¯†é’¥ç¯**

å¦å¤–ï¼ŒCCACHE ç¥¨è¯å¯ä»¥å­˜å‚¨åœ¨ Linux å¯†é’¥ç¯ä¸­ï¼Œæä¾›å¯¹ç¥¨è¯ç®¡ç†çš„æ›´å¤šæ§åˆ¶ã€‚ç¥¨è¯å­˜å‚¨çš„èŒƒå›´å„å¼‚ï¼ˆ`KEYRING:name`ã€`KEYRING:process:name`ã€`KEYRING:thread:name`ã€`KEYRING:session:name`ã€`KEYRING:persistent:uidnumber`ï¼‰ï¼Œ`klist` èƒ½å¤Ÿè§£æè¿™äº›ä¿¡æ¯ä¾›ç”¨æˆ·ä½¿ç”¨ã€‚ç„¶è€Œï¼Œä» Unix å¯†é’¥ç¯é‡æ–°ä½¿ç”¨ CCACHE ç¥¨è¯å¯èƒ½ä¼šé¢ä¸´æŒ‘æˆ˜ï¼Œåƒ **Tickey** è¿™æ ·çš„å·¥å…·å¯ç”¨äºæå– Kerberos ç¥¨è¯ã€‚

### Keytab

Keytab æ–‡ä»¶åŒ…å« Kerberos ä¸»ä½“å’ŒåŠ å¯†å¯†é’¥ï¼Œå¯¹äºåœ¨ä¸éœ€è¦ä¸»ä½“å¯†ç çš„æƒ…å†µä¸‹è·å–æœ‰æ•ˆçš„ç¥¨è¯æˆäºˆç¥¨ï¼ˆTGTï¼‰è‡³å…³é‡è¦ã€‚ä½¿ç”¨ `klist` ç­‰å®ç”¨ç¨‹åºå’Œ **KeytabParser** ç­‰è„šæœ¬å¯ä»¥è½»æ¾è§£æå’Œé‡æ–°ä½¿ç”¨ keytab æ–‡ä»¶ä¸­çš„å‡­æ®ã€‚

### å¤‡å¿˜å•

æ‚¨å¯ä»¥åœ¨ä»¥ä¸‹é“¾æ¥ä¸­æ‰¾åˆ°æœ‰å…³å¦‚ä½•åœ¨ Linux ä¸­ä½¿ç”¨ç¥¨è¯çš„æ›´å¤šä¿¡æ¯ï¼š

{% content-ref url="privilege-escalation/linux-active-directory.md" %}
[linux-active-directory.md](privilege-escalation/linux-active-directory.md)
{% endcontent-ref %}

## æšä¸¾

{% hint style="warning" %}
æ‚¨å¯ä»¥é€šè¿‡ **ldap** å’Œå…¶ä»– **äºŒè¿›åˆ¶** å·¥å…·è¿›è¡Œ **æšä¸¾**ï¼Œæˆ– **è¿æ¥åˆ° FreeIPA æœåŠ¡å™¨çš„ 443 ç«¯å£çš„ç½‘é¡µ**ã€‚
{% endhint %}

### ä¸»æœºã€ç”¨æˆ·å’Œç»„ <a href="#id-4b3b" id="id-4b3b"></a>

å¯ä»¥åˆ›å»º **ä¸»æœº**ã€**ç”¨æˆ·** å’Œ **ç»„**ã€‚ä¸»æœºå’Œç”¨æˆ·è¢«åˆ†ç±»åˆ°ç§°ä¸ºâ€œ**ä¸»æœºç»„**â€å’Œâ€œ**ç”¨æˆ·ç»„**â€çš„å®¹å™¨ä¸­ã€‚è¿™äº›ç±»ä¼¼äº **ç»„ç»‡å•ä½**ï¼ˆOUï¼‰ã€‚

åœ¨ FreeIPA ä¸­ï¼ŒLDAP æœåŠ¡å™¨é»˜è®¤å…è®¸ **åŒ¿åç»‘å®š**ï¼Œå¤§é‡æ•°æ®å¯ä»¥ **æœªç»èº«ä»½éªŒè¯** è¿›è¡Œæšä¸¾ã€‚è¿™å¯ä»¥æšä¸¾æ‰€æœ‰å¯ç”¨çš„æœªç»èº«ä»½éªŒè¯çš„æ•°æ®ï¼š
```
ldapsearch -x
```
è¦è·å–**æ›´å¤šä¿¡æ¯**ï¼Œæ‚¨éœ€è¦ä½¿ç”¨**ç»è¿‡èº«ä»½éªŒè¯**çš„ä¼šè¯ï¼ˆè¯·æŸ¥çœ‹èº«ä»½éªŒè¯éƒ¨åˆ†ä»¥äº†è§£å¦‚ä½•å‡†å¤‡ç»è¿‡èº«ä»½éªŒè¯çš„ä¼šè¯ï¼‰ã€‚
```bash
# Get all users of domain
ldapsearch -Y gssapi -b "cn=users,cn=compat,dc=domain_name,dc=local"

# Get users groups
ldapsearch -Y gssapi -b "cn=groups,cn=accounts,dc=domain_name,dc=local"

# Get all the hosts
ldapsearch -Y gssapi -b "cn=computers,cn=accounts,dc=domain_name,dc=local"

# Get hosts groups
ldapsearch -Y gssapi -b "cn=hostgroups,cn=accounts,dc=domain_name,dc=local"
```
ä»ä¸€ä¸ªå·²åŠ å…¥åŸŸçš„æœºå™¨ä¸Šï¼Œæ‚¨å°†èƒ½å¤Ÿä½¿ç”¨ **å·²å®‰è£…çš„äºŒè¿›åˆ¶æ–‡ä»¶** æ¥æšä¸¾åŸŸï¼š
```bash
ipa user-find
ipa usergroup-find
ipa host-find
ipa host-group-find

-------------------

ipa user-show <username> --all
ipa usergroup-show <user group> --all
ipa host-find <host> --all
ipa hostgroup-show <host group> --all
```
{% hint style="info" %}
**FreeIPA** çš„ **admin** ç”¨æˆ·ç›¸å½“äº **AD** ä¸­çš„ **domain admins**ã€‚
{% endhint %}

### Hashes <a href="#id-482b" id="id-482b"></a>

**IPA æœåŠ¡å™¨**ä¸­çš„ **root** ç”¨æˆ·å¯ä»¥è®¿é—®å¯†ç  **hashes**ã€‚

* ç”¨æˆ·çš„å¯†ç  hash å­˜å‚¨ä¸º **base64** åœ¨â€œ**userPassword**â€ **attribute** ä¸­ã€‚è¿™ä¸ª hash å¯èƒ½æ˜¯ **SSHA512**ï¼ˆæ—§ç‰ˆæœ¬çš„ FreeIPAï¼‰æˆ– **PBKDF2\_SHA256**ã€‚
* å¦‚æœç³»ç»Ÿä¸ **AD** æœ‰ **integration**ï¼Œåˆ™å¯†ç çš„ **Nthash** å­˜å‚¨ä¸º **base64** åœ¨â€œ**ipaNTHash**â€ä¸­ã€‚

ç ´è§£è¿™äº› hashesï¼š

â€¢ å¦‚æœ freeIPA ä¸ AD é›†æˆï¼Œ**ipaNTHash** å¾ˆå®¹æ˜“ç ´è§£ï¼šä½ åº”è¯¥ **decode** **base64** -> é‡æ–°ç¼–ç ä¸º **ASCII** hex -> John The Ripper æˆ– **hashcat** å¯ä»¥å¸®åŠ©ä½ å¿«é€Ÿç ´è§£

â€¢ å¦‚æœä½¿ç”¨çš„æ˜¯æ—§ç‰ˆæœ¬çš„ FreeIPAï¼Œåˆ™ä½¿ç”¨ **SSHA512**ï¼šä½ åº”è¯¥è§£ç  **base64** -> æ‰¾åˆ° SSHA512 **hash** -> John The Ripper æˆ– **hashcat** å¯ä»¥å¸®åŠ©ä½ ç ´è§£

â€¢ å¦‚æœä½¿ç”¨çš„æ˜¯æ–°ç‰ˆæœ¬çš„ FreeIPAï¼Œåˆ™ä½¿ç”¨ **PBKDF2\_SHA256**ï¼šä½ åº”è¯¥è§£ç  **base64** -> æ‰¾åˆ° PBKDF2\_SHA256 -> å®ƒçš„ **length** æ˜¯ 256 å­—èŠ‚ã€‚John å¯ä»¥å¤„ç† 256 ä½ï¼ˆ32 å­—èŠ‚ï¼‰-> SHA-265 ç”¨ä½œä¼ªéšæœºå‡½æ•°ï¼Œå—å¤§å°ä¸º 32 å­—èŠ‚ -> ä½ åªèƒ½ä½¿ç”¨æˆ‘ä»¬çš„ PBKDF2\_SHA256 hash çš„å‰ 256 ä½ -> John The Ripper æˆ– hashcat å¯ä»¥å¸®åŠ©ä½ ç ´è§£

<figure><img src="../.gitbook/assets/image (655).png" alt=""><figcaption></figcaption></figure>

è¦æå– hashesï¼Œä½ éœ€è¦åœ¨ **FreeIPA æœåŠ¡å™¨**ä¸­æ˜¯ **root**ï¼Œåœ¨é‚£é‡Œä½ å¯ä»¥ä½¿ç”¨å·¥å…· **`dbscan`** æ¥æå–å®ƒä»¬ï¼š

<figure><img src="../.gitbook/assets/image (293).png" alt=""><figcaption></figcaption></figure>

### HBAC-Rules <a href="#id-482b" id="id-482b"></a>

è¿™äº›è§„åˆ™æˆäºˆç”¨æˆ·æˆ–ä¸»æœºå¯¹èµ„æºï¼ˆä¸»æœºã€æœåŠ¡ã€æœåŠ¡ç»„ç­‰ï¼‰çš„ç‰¹å®šæƒé™ã€‚
```bash
# Enumerate using ldap
ldapsearch -Y gssapi -b "cn=hbac,dc=domain_name,dc=local"
# Using ipa
ipa hbacrule-find
# Show info of rule
ipa hbacrule-show <hbacrule> --all
```
#### Sudo-Rules

FreeIPA é€šè¿‡ sudo-rules å®ç°å¯¹ **sudo æƒé™** çš„é›†ä¸­æ§åˆ¶ã€‚è¿™äº›è§„åˆ™å…è®¸æˆ–é™åˆ¶åœ¨åŸŸå†…ä¸»æœºä¸Šä½¿ç”¨ sudo æ‰§è¡Œå‘½ä»¤ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡æ£€æŸ¥è¿™äº›è§„åˆ™é›†æ¥è¯†åˆ«é€‚ç”¨çš„ä¸»æœºã€ç”¨æˆ·å’Œå…è®¸çš„å‘½ä»¤ã€‚
```bash
# Enumerate using ldap
ldapsearch -Y gssapi -b "cn=sudorules,cn=sudo,dc=domain_name,dc=local"
# Using ipa
ipa sudorule-find
# Show info of rule
ipa sudorule-show <sudorule> --all
```
### åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶

ä¸€ä¸ª**è§’è‰²**ç”±å„ç§**ç‰¹æƒ**ç»„æˆï¼Œæ¯ä¸ªç‰¹æƒåŒ…å«ä¸€ç»„**æƒé™**ã€‚è¿™äº›è§’è‰²å¯ä»¥åˆ†é…ç»™ç”¨æˆ·ã€ç”¨æˆ·**ç»„**ã€**ä¸»æœº**ã€ä¸»æœºç»„å’ŒæœåŠ¡ã€‚ä¾‹å¦‚ï¼Œè€ƒè™‘FreeIPAä¸­çš„é»˜è®¤â€œç”¨æˆ·ç®¡ç†å‘˜â€è§’è‰²æ¥ä¸¾ä¾‹è¯´æ˜è¿™ä¸ªç»“æ„ã€‚

è§’è‰²`ç”¨æˆ·ç®¡ç†å‘˜`å…·æœ‰ä»¥ä¸‹ç‰¹æƒï¼š

* **ç”¨æˆ·ç®¡ç†å‘˜**
* **ç»„ç®¡ç†å‘˜**
* **é˜¶æ®µç”¨æˆ·ç®¡ç†å‘˜**

ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯ä»¥æšä¸¾è§’è‰²ã€ç‰¹æƒå’Œæƒé™ï¼š
```bash
# Using ldap
ldapsearch -Y gssapi -b "cn=roles,cn=accounts,dc=westeros,dc=local"
# Using ipa binary
ipa role-find
ipa role-show <role> --all
ipa privilege-find
ipa privilege-show <privilege> --all
ipa permission-find
ipa permission-show <permission> --all
```
### æ”»å‡»åœºæ™¯ç¤ºä¾‹

åœ¨ [https://posts.specterops.io/attacking-freeipa-part-iii-finding-a-path-677405b5b95e](https://posts.specterops.io/attacking-freeipa-part-iii-finding-a-path-677405b5b95e) ä¸­ï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œè¯´æ˜å¦‚ä½•æ»¥ç”¨æŸäº›æƒé™æ¥å¦¥ååŸŸã€‚

### Linikatz/LinikatzV2

* [https://github.com/Orange-Cyberdefense/LinikatzV2](https://github.com/Orange-Cyberdefense/LinikatzV2)
* [https://github.com/CiscoCXSecurity/linikatz](https://github.com/CiscoCXSecurity/linikatz)

## æƒé™æå‡

### ~~root ç”¨æˆ·åˆ›å»º~~

{% hint style="warning" %}
å¦‚æœæ‚¨å¯ä»¥ **åˆ›å»ºä¸€ä¸ªåä¸º `root` çš„æ–°ç”¨æˆ·**ï¼Œæ‚¨å¯ä»¥å†’å……ä»–å¹¶èƒ½å¤Ÿ **ä»¥ root èº«ä»½ SSH ç™»å½•ä»»ä½•æœºå™¨ã€‚**

**è¿™å·²ç»è¢«ä¿®è¡¥ã€‚**
{% endhint %}

æ‚¨å¯ä»¥åœ¨ [https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b](https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b) ä¸­æŸ¥çœ‹è¯¦ç»†è¯´æ˜ã€‚

## å‚è€ƒèµ„æ–™

* [https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b](https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b)
* [https://posts.specterops.io/attacking-freeipa-part-i-authentication-77e73d837d6a](https://posts.specterops.io/attacking-freeipa-part-i-authentication-77e73d837d6a)
* [https://posts.specterops.io/attacking-freeipa-part-ii-enumeration-ad27224371e1](https://posts.specterops.io/attacking-freeipa-part-ii-enumeration-ad27224371e1)
* [https://www.youtube.com/watch?v=9dOu-7BTwPQ](https://www.youtube.com/watch?v=9dOu-7BTwPQ)

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨ Twitter ä¸Šå…³æ³¨** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
