# FreeIPA Pentesting

<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan kahramana Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> ile!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

- **Åirketinizi HackTricks'te reklamÄ±nÄ±zÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
- [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuzu
- **ğŸ’¬ [Discord grubumuza](https://discord.gg/hRep4RUj7f) katÄ±lÄ±n veya [telegram grubuna](https://t.me/peass) katÄ±lÄ±n veya bizi Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
- **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± gÃ¶ndererek HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na PR gÃ¶ndererek paylaÅŸÄ±n.

</details>

## Temel Bilgiler

FreeIPA, genellikle **Unix** ortamlarÄ± iÃ§in Microsoft Windows **Active Directory**'ye bir aÃ§Ä±k kaynak **alternatif**tir. Active Directory'ye benzer ÅŸekilde yÃ¶netim iÃ§in bir MIT **Kerberos** Anahtar DaÄŸÄ±tÄ±m Merkezi ile tam bir **LDAP dizini** birleÅŸtirir. CA ve RA sertifika yÃ¶netimi iÃ§in Dogtag **Sertifika Sistemi**'ni kullanarak akÄ±llÄ± kartlar da dahil olmak Ã¼zere **Ã§ok faktÃ¶rlÃ¼** kimlik doÄŸrulamayÄ± destekler. Unix kimlik doÄŸrulama sÃ¼reÃ§leri iÃ§in SSSD entegre edilmiÅŸtir.

## Parmak Ä°zi

### Dosyalar ve Ortam DeÄŸiÅŸkenleri

- `/etc/krb5.conf` dosyasÄ±, etki alanÄ±na kaydolmak iÃ§in gerekli olan Kerberos istemci bilgilerini depolayan yerdir. Bu, KDC'lerin ve yÃ¶netici sunucularÄ±n konumlarÄ±nÄ±, varsayÄ±lan ayarlarÄ± ve eÅŸlemeleri iÃ§erir.
- IPA istemcileri ve sunucularÄ± iÃ§in sistem genelinde varsayÄ±lanlar, `/etc/ipa/default.conf` konumundaki dosyada ayarlanmÄ±ÅŸtÄ±r.
- Etki alanÄ±ndaki ana bilgisayarlar, kimlik doÄŸrulama sÃ¼reÃ§leri iÃ§in `/etc/krb5.keytab` konumunda bir `krb5.keytab` dosyasÄ±na sahip olmalÄ±dÄ±r.
- Ã‡eÅŸitli ortam deÄŸiÅŸkenleri (`KRB5CCNAME`, `KRB5_KTNAME`, `KRB5_CONFIG`, `KRB5_KDC_PROFILE`, `KRB5RCACHETYPE`, `KRB5RCACHEDIR`, `KRB5_TRACE`, `KRB5_CLIENT_KTNAME`, `KPROP_PORT`), Kerberos kimlik doÄŸrulamayla ilgili belirli dosyalara ve ayarlara iÅŸaret etmek iÃ§in kullanÄ±lÄ±r.

### Ä°kili Dosyalar

`ipa`, `kdestroy`, `kinit`, `klist`, `kpasswd`, `ksu`, `kswitch` ve `kvno` gibi araÃ§lar, FreeIPA etki alanlarÄ±nÄ± yÃ¶netmek, Kerberos biletlerini iÅŸlemek, ÅŸifreleri deÄŸiÅŸtirmek ve hizmet biletleri almak gibi iÅŸlevlerde merkezi rol oynar.

### AÄŸ

Tipik bir FreeIPA sunucusu kurulumunu tasvir etmek iÃ§in bir gÃ¶rsel saÄŸlanmÄ±ÅŸtÄ±r.

## Kimlik DoÄŸrulama

FreeIPA'da **Kerberos**'u kullanarak kimlik doÄŸrulama, **Active Directory**'dekiyle benzerdir. Etki alanÄ± kaynaklarÄ±na eriÅŸim iÃ§in geÃ§erli bir Kerberos biletine ihtiyaÃ§ vardÄ±r ve bu, FreeIPA etki alanÄ± yapÄ±landÄ±rmasÄ±na baÄŸlÄ± olarak Ã§eÅŸitli konumlarda depolanabilir.

### **CCACHE Bilet DosyalarÄ±**

Genellikle **`/tmp`** iÃ§inde **600** izinlerle depolanan CCACHE dosyalarÄ±, taÅŸÄ±nabilirlikleri nedeniyle kullanÄ±cÄ±larÄ±n dÃ¼z metin ÅŸifresi olmadan kimlik doÄŸrulama iÃ§in Ã¶nemli olan Kerberos kimlik bilgilerini depolamak iÃ§in kullanÄ±lan ikili formatlardÄ±r. Bir CCACHE biletini ayrÄ±ÅŸtÄ±rmak iÃ§in `klist` komutu kullanÄ±labilir ve geÃ§erli bir CCACHE Biletini yeniden kullanmak iÃ§in `KRB5CCNAME`'i bilet dosyasÄ±nÄ±n yoluna aktarmak gerekir.

### **Unix Anahtar Zinciri**

Alternatif olarak, CCACHE Biletleri Linux anahtar zincirinde depolanabilir ve bilet yÃ¶netimi Ã¼zerinde daha fazla kontrol saÄŸlar. Bilet depolama kapsamÄ± deÄŸiÅŸir (`KEYRING:ad`, `KEYRING:process:ad`, `KEYRING:thread:ad`, `KEYRING:session:ad`, `KEYRING:persistent:kullanÄ±cÄ±numarasÄ±`), `klist` bu bilgileri kullanÄ±cÄ± iÃ§in ayrÄ±ÅŸtÄ±rabilir. Ancak, Unix anahtar zincirinden bir CCACHE Biletini yeniden kullanmak zorluklar doÄŸurabilir, Kerberos biletlerini Ã§Ä±karmak iÃ§in **Tickey** gibi araÃ§lar mevcuttur.

### Keytab

Kerberos prensiplerini ve ÅŸifrelenmiÅŸ anahtarlarÄ± iÃ§eren Keytab dosyalarÄ±, prensibin ÅŸifresine ihtiyaÃ§ duymadan geÃ§erli bilet alma iÅŸlemi iÃ§in kritiktir. Keytab dosyalarÄ±ndan kimlik bilgilerini ayrÄ±ÅŸtÄ±rmak ve yeniden kullanmak, `klist` gibi yardÄ±mcÄ± programlar ve **KeytabParser** gibi betiklerle kolayca gerÃ§ekleÅŸtirilebilir.

### Hile KaÄŸÄ±dÄ±

Linux'te biletleri nasÄ±l kullanacaÄŸÄ±nÄ±z hakkÄ±nda daha fazla bilgiyi aÅŸaÄŸÄ±daki baÄŸlantÄ±da bulabilirsiniz:

{% content-ref url="privilege-escalation/linux-active-directory.md" %}
[linux-active-directory.md](privilege-escalation/linux-active-directory.md)
{% endcontent-ref %}

## NumaralandÄ±rma

{% hint style="warning" %}
**NumaralandÄ±rmayÄ±** **ldap** ve diÄŸer **ikili** araÃ§lar aracÄ±lÄ±ÄŸÄ±yla veya **FreeIPA sunucusunun 443 numaralÄ± baÄŸlantÄ± noktasÄ±na** baÄŸlanarak gerÃ§ekleÅŸtirebilirsiniz.
{% endhint %}

### Ana Bilgisayarlar, KullanÄ±cÄ±lar ve Gruplar <a href="#id-4b3b" id="id-4b3b"></a>

**Ana bilgisayarlar**, **kullanÄ±cÄ±lar** ve **gruplar** oluÅŸturmak mÃ¼mkÃ¼ndÃ¼r. Ana bilgisayarlar ve kullanÄ±cÄ±lar sÄ±rasÄ±yla â€œ**Ana Bilgisayar GruplarÄ±**â€ ve â€œ**KullanÄ±cÄ± GruplarÄ±**â€ olarak adlandÄ±rÄ±lan konteynerlere yerleÅŸtirilir. Bunlar **Organizasyon Birimleri** (OU) ile benzerdir.

FreeIPA'da varsayÄ±lan olarak, LDAP sunucusu **anonim baÄŸlantÄ±lara** izin verir ve kimlik doÄŸrulama yapÄ±lmadan bÃ¼yÃ¼k bir veri yelpazesi numaralandÄ±rÄ±labilir. Bu, kimlik doÄŸrulama yapÄ±lmadan mevcut tÃ¼m verilerin numaralandÄ±rÄ±lmasÄ±nÄ± saÄŸlar:
```
ldapsearch -x
```
Daha fazla bilgi edinmek iÃ§in bir **kimlik doÄŸrulama** oturumu kullanmanÄ±z gerekmektedir (kimlik doÄŸrulama bÃ¶lÃ¼mÃ¼ne bakarak nasÄ±l kimlik doÄŸrulama oturumu hazÄ±rlanacaÄŸÄ±nÄ± Ã¶ÄŸrenebilirsiniz).
```bash
# Get all users of domain
ldapsearch -Y gssapi -b "cn=users,cn=compat,dc=domain_name,dc=local"

# Get users groups
ldapsearch -Y gssapi -b "cn=groups,cn=accounts,dc=domain_name,dc=local"

# Get all the hosts
ldapsearch -Y gssapi -b "cn=computers,cn=accounts,dc=domain_name,dc=local"

# Get hosts groups
ldapsearch -Y gssapi -b "cn=hostgroups,cn=accounts,dc=domain_name,dc=local"
```
Bir etki alanÄ±na katÄ±lmÄ±ÅŸ makineden, etki alanÄ±nÄ± sÄ±ralamak iÃ§in **kurulu ikili dosyalarÄ±** kullanabilirsiniz:
```bash
ipa user-find
ipa usergroup-find
ipa host-find
ipa host-group-find

-------------------

ipa user-show <username> --all
ipa usergroup-show <user group> --all
ipa host-find <host> --all
ipa hostgroup-show <host group> --all
```
{% hint style="info" %}
**FreeIPA**'nÄ±n **admin** kullanÄ±cÄ±sÄ±, **AD**'den **domain adminleri**ne eÅŸdeÄŸerdir.
{% endhint %}

### Hash'ler <a href="#id-482b" id="id-482b"></a>

**IPA sunucusu**'ndaki **root** kullanÄ±cÄ±sÄ±, ÅŸifre **hash'lerine** eriÅŸime sahiptir.

- Bir kullanÄ±cÄ±nÄ±n ÅŸifre hash'i, "userPassword" **Ã¶zniteliÄŸinde** **base64** olarak saklanÄ±r. Bu hash, **SSHA512** (eski FreeIPA sÃ¼rÃ¼mleri) veya **PBKDF2\_SHA256** olabilir.
- Åifrenin **Nthash**'i, sistem **AD** ile **entegre** ise "ipaNTHash" iÃ§inde **base64** olarak saklanÄ±r.

Bu hash'leri kÄ±rmak iÃ§in:

- EÄŸer FreeIPA AD ile entegre edilmiÅŸse, **ipaNTHash** kolayca kÄ±rÄ±labilir: **base64**'Ã¼ **Ã§Ã¶zÃ¼mleyin** -> ASCII **hex** olarak yeniden kodlayÄ±n -> John The Ripper veya **hashcat** size hÄ±zlÄ±ca kÄ±rmak iÃ§in yardÄ±mcÄ± olabilir

- EÄŸer eski bir FreeIPA sÃ¼rÃ¼mÃ¼ kullanÄ±lÄ±yorsa, yani **SSHA512** kullanÄ±lÄ±yorsa: **base64**'Ã¼ Ã§Ã¶zÃ¼mleyin -> SSHA512 **hash**'ini bulun -> John The Ripper veya **hashcat** size kÄ±rmak iÃ§in yardÄ±mcÄ± olabilir

- EÄŸer yeni bir FreeIPA sÃ¼rÃ¼mÃ¼ kullanÄ±lÄ±yorsa, yani **PBKDF2\_SHA256** kullanÄ±lÄ±yorsa: **base64**'Ã¼ Ã§Ã¶zÃ¼mleyin -> PBKDF2\_SHA256'yi bulun -> uzunluÄŸu 256 bayt'tÄ±r. John, 256 bit (32 bayt) ile Ã§alÄ±ÅŸabilir -> Pseudo-rastgele fonksiyon olarak SHA-265 kullanÄ±lÄ±r, blok boyutu 32 bayttÄ±r -> PBKDF2\_SHA256 hash'inin sadece ilk 256 bit'ini kullanabilirsiniz -> John The Ripper veya hashcat size kÄ±rmak iÃ§in yardÄ±mcÄ± olabilir

<figure><img src="../.gitbook/assets/image (652).png" alt=""><figcaption></figcaption></figure>

Hash'leri Ã§Ä±karmak iÃ§in **FreeIPA sunucusunda root** olmanÄ±z gerekmektedir, burada **`dbscan`** aracÄ±nÄ± kullanarak bunlarÄ± Ã§Ä±karabilirsiniz:

<figure><img src="../.gitbook/assets/image (290).png" alt=""><figcaption></figcaption></figure>

### HBAC-KurallarÄ± <a href="#id-482b" id="id-482b"></a>

Bu kurallar, belirli izinleri kullanÄ±cÄ±lara veya kaynaklara (ana bilgisayarlar, hizmetler, hizmet gruplarÄ±...) saÄŸlar.
```bash
# Enumerate using ldap
ldapsearch -Y gssapi -b "cn=hbac,dc=domain_name,dc=local"
# Using ipa
ipa hbacrule-find
# Show info of rule
ipa hbacrule-show <hbacrule> --all
```
#### Sudo-KurallarÄ±

FreeIPA, sudo-kurallarÄ± aracÄ±lÄ±ÄŸÄ±yla **sudo izinleri** Ã¼zerinde merkezi kontrol saÄŸlar. Bu kurallar, etki alanÄ±ndaki ana bilgisayarlarda sudo ile komutlarÄ±n yÃ¼rÃ¼tÃ¼lmesine izin verir veya sÄ±nÄ±rlar. Bir saldÄ±rgan, bu kurallarÄ± inceleyerek ilgili ana bilgisayarlarÄ±, kullanÄ±cÄ±larÄ± ve izin verilen komutlarÄ± tespit edebilir.
```bash
# Enumerate using ldap
ldapsearch -Y gssapi -b "cn=sudorules,cn=sudo,dc=domain_name,dc=local"
# Using ipa
ipa sudorule-find
# Show info of rule
ipa sudorule-show <sudorule> --all
```
### Rol TabanlÄ± EriÅŸim KontrolÃ¼

Bir **rol**, Ã§eÅŸitli **ayrÄ±calÄ±klarÄ±** iÃ§eren ve her biri bir dizi **izin** iÃ§eren bir yapÄ±ya sahiptir. Bu roller, KullanÄ±cÄ±lara, KullanÄ±cÄ± **GruplarÄ±na**, **Ana Bilgisayarlara**, Ana Bilgisayar GruplarÄ±na ve Hizmetlere atanabilir. Ã–rneÄŸin, bu yapÄ±yÄ± aÃ§Ä±klamak iÃ§in FreeIPA'daki varsayÄ±lan "KullanÄ±cÄ± YÃ¶neticisi" rolÃ¼nÃ¼ dÃ¼ÅŸÃ¼nelim.

`KullanÄ±cÄ± YÃ¶neticisi` rolÃ¼ ÅŸu ayrÄ±calÄ±klara sahiptir:

* **KullanÄ±cÄ± YÃ¶neticileri**
* **Grup YÃ¶neticileri**
* **AÅŸama KullanÄ±cÄ± YÃ¶neticileri**

AÅŸaÄŸÄ±daki komutlarla rolleri, ayrÄ±calÄ±klarÄ± ve izinleri sÄ±ralamak mÃ¼mkÃ¼ndÃ¼r:
```bash
# Using ldap
ldapsearch -Y gssapi -b "cn=roles,cn=accounts,dc=westeros,dc=local"
# Using ipa binary
ipa role-find
ipa role-show <role> --all
ipa privilege-find
ipa privilege-show <privilege> --all
ipa permission-find
ipa permission-show <permission> --all
```
### SaldÄ±rÄ± Senaryosu Ã–rneÄŸi

[https://posts.specterops.io/attacking-freeipa-part-iii-finding-a-path-677405b5b95e](https://posts.specterops.io/attacking-freeipa-part-iii-finding-a-path-677405b5b95e) adresinde alanÄ± tehlikeye atmak iÃ§in bazÄ± izinleri nasÄ±l kÃ¶tÃ¼ye kullandÄ±ÄŸÄ±nÄ±zÄ± basit bir Ã¶rnek bulabilirsiniz.

### Linikatz/LinikatzV2

* [https://github.com/Orange-Cyberdefense/LinikatzV2](https://github.com/Orange-Cyberdefense/LinikatzV2)
* [https://github.com/CiscoCXSecurity/linikatz](https://github.com/CiscoCXSecurity/linikatz)

## Ä°st Privileges

### ~~root kullanÄ±cÄ±sÄ± oluÅŸturma~~

{% hint style="warning" %}
EÄŸer **`root`** adÄ±nda yeni bir kullanÄ±cÄ± oluÅŸturabilirseniz, onu taklit edebilir ve **herhangi bir makineye root olarak SSH yapabilirsiniz.**

**BU SORUN GÄ°DERÄ°LMÄ°ÅTÄ°R.**
{% endhint %}

DetaylÄ± aÃ§Ä±klamayÄ± [https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b](https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b) adresinde kontrol edebilirsiniz.

## Referanslar

* [https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b](https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b)
* [https://posts.specterops.io/attacking-freeipa-part-i-authentication-77e73d837d6a](https://posts.specterops.io/attacking-freeipa-part-i-authentication-77e73d837d6a)
* [https://posts.specterops.io/attacking-freeipa-part-ii-enumeration-ad27224371e1](https://posts.specterops.io/attacking-freeipa-part-ii-enumeration-ad27224371e1)
* [https://www.youtube.com/watch?v=9dOu-7BTwPQ](https://www.youtube.com/watch?v=9dOu-7BTwPQ)

<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan kahraman olmaya Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> ile!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) koleksiyonumuzu keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family)
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi Twitter'da ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR'lar gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>
