# FreeIPA Pentesting

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}

## Grundinformationen

FreeIPA ist eine Open-Source-**Alternative** zu Microsoft Windows **Active Directory**, haupts√§chlich f√ºr **Unix**-Umgebungen. Es kombiniert ein vollst√§ndiges **LDAP-Verzeichnis** mit einem MIT **Kerberos** Key Distribution Center f√ºr die Verwaltung √§hnlich wie Active Directory. Es nutzt das Dogtag **Zertifikatsystem** f√ºr CA- und RA-Zertifikatsverwaltung und unterst√ºtzt **Multi-Faktor**-Authentifizierung, einschlie√ülich Smartcards. SSSD ist f√ºr Unix-Authentifizierungsprozesse integriert.

## Fingerabdr√ºcke

### Dateien & Umgebungsvariablen

* Die Datei unter `/etc/krb5.conf` ist der Ort, an dem die Kerberos-Clientinformationen, die f√ºr die Anmeldung in der Dom√§ne erforderlich sind, gespeichert sind. Dazu geh√∂ren die Standorte der KDCs und Admin-Server, Standardeinstellungen und Zuordnungen.
* Systemweite Standardwerte f√ºr IPA-Clients und -Server werden in der Datei unter `/etc/ipa/default.conf` festgelegt.
* Hosts innerhalb der Dom√§ne m√ºssen eine `krb5.keytab`-Datei unter `/etc/krb5.keytab` f√ºr Authentifizierungsprozesse haben.
* Verschiedene Umgebungsvariablen (`KRB5CCNAME`, `KRB5_KTNAME`, `KRB5_CONFIG`, `KRB5_KDC_PROFILE`, `KRB5RCACHETYPE`, `KRB5RCACHEDIR`, `KRB5_TRACE`, `KRB5_CLIENT_KTNAME`, `KPROP_PORT`) werden verwendet, um auf spezifische Dateien und Einstellungen zu verweisen, die f√ºr die Kerberos-Authentifizierung relevant sind.

### Binaries

Werkzeuge wie `ipa`, `kdestroy`, `kinit`, `klist`, `kpasswd`, `ksu`, `kswitch` und `kvno` sind zentral f√ºr die Verwaltung von FreeIPA-Dom√§nen, die Handhabung von Kerberos-Tickets, das √Ñndern von Passw√∂rtern und das Erwerben von Servicetickets, unter anderem.

### Netzwerk

Eine Abbildung wird bereitgestellt, um eine typische FreeIPA-Serverkonfiguration darzustellen.

## Authentifizierung

Die Authentifizierung in FreeIPA, die **Kerberos** nutzt, spiegelt die in **Active Directory** wider. Der Zugriff auf Dom√§nenressourcen erfordert ein g√ºltiges Kerberos-Ticket, das je nach Konfiguration der FreeIPA-Dom√§ne an verschiedenen Orten gespeichert werden kann.

### **CCACHE Ticketdateien**

CCACHE-Dateien, die typischerweise in **`/tmp`** mit **600** Berechtigungen gespeichert werden, sind bin√§re Formate zur Speicherung von Kerberos-Anmeldeinformationen, die f√ºr die Authentifizierung ohne das Klartextpasswort des Benutzers wichtig sind, aufgrund ihrer Portabilit√§t. Das Parsen eines CCACHE-Tickets kann mit dem Befehl `klist` erfolgen, und die Wiederverwendung eines g√ºltigen CCACHE-Tickets erfordert das Exportieren von `KRB5CCNAME` auf den Pfad der Ticketdatei.

### **Unix Keyring**

Alternativ k√∂nnen CCACHE-Tickets im Linux-Keyring gespeichert werden, was mehr Kontrolle √ºber die Ticketverwaltung bietet. Der Umfang der Ticketablage variiert (`KEYRING:name`, `KEYRING:process:name`, `KEYRING:thread:name`, `KEYRING:session:name`, `KEYRING:persistent:uidnumber`), wobei `klist` in der Lage ist, diese Informationen f√ºr den Benutzer zu parsen. Die Wiederverwendung eines CCACHE-Tickets aus dem Unix-Keyring kann jedoch Herausforderungen mit sich bringen, wobei Werkzeuge wie **Tickey** verf√ºgbar sind, um Kerberos-Tickets zu extrahieren.

### Keytab

Keytab-Dateien, die Kerberos-Principals und verschl√ºsselte Schl√ºssel enthalten, sind entscheidend f√ºr den Erhalt g√ºltiger Ticket Granting Tickets (TGT), ohne das Passwort des Principals zu ben√∂tigen. Das Parsen und die Wiederverwendung von Anmeldeinformationen aus Keytab-Dateien k√∂nnen einfach mit Dienstprogrammen wie `klist` und Skripten wie **KeytabParser** durchgef√ºhrt werden.

### Cheatsheet

Sie finden weitere Informationen zur Verwendung von Tickets in Linux unter folgendem Link:

{% content-ref url="privilege-escalation/linux-active-directory.md" %}
[linux-active-directory.md](privilege-escalation/linux-active-directory.md)
{% endcontent-ref %}

## Enumeration

{% hint style="warning" %}
Sie k√∂nnen die **Enumeration** √ºber **ldap** und andere **bin√§re** Werkzeuge durchf√ºhren oder **eine Verbindung zur Webseite am Port 443 des FreeIPA-Servers herstellen**.
{% endhint %}

### Hosts, Benutzer und Gruppen <a href="#id-4b3b" id="id-4b3b"></a>

Es ist m√∂glich, **Hosts**, **Benutzer** und **Gruppen** zu erstellen. Hosts und Benutzer werden in Container unter dem Namen ‚Äû**Host-Gruppen**‚Äú und ‚Äû**Benutzergruppen**‚Äú sortiert. Diese sind √§hnlich wie **Organizational Units** (OU).

Standardm√§√üig erlaubt der LDAP-Server in FreeIPA **anonyme Bindungen**, und ein gro√üer Teil der Daten ist **unauthentifiziert** aufrufbar. Dies kann alle Daten auflisten, die unauthentifiziert verf√ºgbar sind:
```
ldapsearch -x
```
Um **mehr Informationen** zu erhalten, m√ºssen Sie eine **authentifizierte** Sitzung verwenden (√ºberpr√ºfen Sie den Abschnitt Authentifizierung, um zu erfahren, wie Sie eine authentifizierte Sitzung vorbereiten).
```bash
# Get all users of domain
ldapsearch -Y gssapi -b "cn=users,cn=compat,dc=domain_name,dc=local"

# Get users groups
ldapsearch -Y gssapi -b "cn=groups,cn=accounts,dc=domain_name,dc=local"

# Get all the hosts
ldapsearch -Y gssapi -b "cn=computers,cn=accounts,dc=domain_name,dc=local"

# Get hosts groups
ldapsearch -Y gssapi -b "cn=hostgroups,cn=accounts,dc=domain_name,dc=local"
```
Von einem mit der Dom√§ne verbundenen Rechner k√∂nnen Sie **installierte Bin√§rdateien** verwenden, um die Dom√§ne aufzulisten:
```bash
ipa user-find
ipa usergroup-find
ipa host-find
ipa host-group-find

-------------------

ipa user-show <username> --all
ipa usergroup-show <user group> --all
ipa host-find <host> --all
ipa hostgroup-show <host group> --all
```
{% hint style="info" %}
Der **admin** Benutzer von **FreeIPA** entspricht den **Domain-Admins** aus **AD**.
{% endhint %}

### Hashes <a href="#id-482b" id="id-482b"></a>

Der **root** Benutzer des **IPA-Servers** hat Zugriff auf die Passwort-**Hashes**.

* Der Passwort-Hash eines Benutzers wird als **base64** im Attribut ‚Äú**userPassword**‚Äù gespeichert. Dieser Hash kann **SSHA512** (alte Versionen von FreeIPA) oder **PBKDF2\_SHA256** sein.
* Der **Nthash** des Passworts wird als **base64** in ‚Äú**ipaNTHash**‚Äù gespeichert, wenn das System mit **AD** **integriert** ist.

Um diese Hashes zu knacken:

‚Ä¢ Wenn FreeIPA mit AD integriert ist, ist **ipaNTHash** leicht zu knacken: Sie sollten **base64** dekodieren -> es als **ASCII**-Hex neu kodieren -> John The Ripper oder **hashcat** k√∂nnen Ihnen helfen, es schnell zu knacken.

‚Ä¢ Wenn eine alte Version von FreeIPA verwendet wird, wird **SSHA512** verwendet: Sie sollten **base64** dekodieren -> SSHA512 **Hash** finden -> John The Ripper oder **hashcat** k√∂nnen Ihnen helfen, es zu knacken.

‚Ä¢ Wenn eine neue Version von FreeIPA verwendet wird, wird **PBKDF2\_SHA256** verwendet: Sie sollten **base64** dekodieren -> PBKDF2\_SHA256 finden -> seine **L√§nge** betr√§gt 256 Byte. John kann mit 256 Bits (32 Byte) arbeiten -> SHA-265 wird als Pseudo-Zufallsfunktion verwendet, die Blockgr√∂√üe betr√§gt 32 Byte -> Sie k√∂nnen nur die ersten 256 Bits unseres PBKDF2\_SHA256-Hashes verwenden -> John The Ripper oder hashcat k√∂nnen Ihnen helfen, es zu knacken.

<figure><img src="../.gitbook/assets/image (655).png" alt=""><figcaption></figcaption></figure>

Um die Hashes zu extrahieren, m√ºssen Sie **root im FreeIPA-Server** sein, dort k√∂nnen Sie das Tool **`dbscan`** verwenden, um sie zu extrahieren:

<figure><img src="../.gitbook/assets/image (293).png" alt=""><figcaption></figcaption></figure>

### HBAC-Rules <a href="#id-482b" id="id-482b"></a>

Dies sind die Regeln, die bestimmten Benutzern oder Hosts √ºber Ressourcen (Hosts, Dienste, Dienstgruppen...) spezifische Berechtigungen gew√§hren.
```bash
# Enumerate using ldap
ldapsearch -Y gssapi -b "cn=hbac,dc=domain_name,dc=local"
# Using ipa
ipa hbacrule-find
# Show info of rule
ipa hbacrule-show <hbacrule> --all
```
#### Sudo-Rules

FreeIPA erm√∂glicht die zentrale Kontrolle √ºber **sudo permissions** √ºber sudo-rules. Diese Regeln erlauben oder beschr√§nken die Ausf√ºhrung von Befehlen mit sudo auf Hosts innerhalb der Dom√§ne. Ein Angreifer k√∂nnte potenziell die anwendbaren Hosts, Benutzer und erlaubten Befehle identifizieren, indem er diese Regelsets untersucht.
```bash
# Enumerate using ldap
ldapsearch -Y gssapi -b "cn=sudorules,cn=sudo,dc=domain_name,dc=local"
# Using ipa
ipa sudorule-find
# Show info of rule
ipa sudorule-show <sudorule> --all
```
### Rollenbasierte Zugriffskontrolle

Eine **Rolle** besteht aus verschiedenen **Befugnissen**, von denen jedes eine Sammlung von **Berechtigungen** umfasst. Diese Rollen k√∂nnen Benutzern, Benutzer **Gruppen**, **Hosts**, Host-Gruppen und Diensten zugewiesen werden. Zum Beispiel kann die Standardrolle ‚ÄûBenutzeradministrator‚Äú in FreeIPA diese Struktur veranschaulichen.

Die Rolle `Benutzeradministrator` hat diese Befugnisse:

* **Benutzeradministratoren**
* **Gruppenadministratoren**
* **Stage-Benutzeradministratoren**

Mit den folgenden Befehlen ist es m√∂glich, die Rollen, Befugnisse und Berechtigungen aufzulisten:
```bash
# Using ldap
ldapsearch -Y gssapi -b "cn=roles,cn=accounts,dc=westeros,dc=local"
# Using ipa binary
ipa role-find
ipa role-show <role> --all
ipa privilege-find
ipa privilege-show <privilege> --all
ipa permission-find
ipa permission-show <permission> --all
```
### Angriffsszenario Beispiel

In [https://posts.specterops.io/attacking-freeipa-part-iii-finding-a-path-677405b5b95e](https://posts.specterops.io/attacking-freeipa-part-iii-finding-a-path-677405b5b95e) finden Sie ein einfaches Beispiel, wie man einige Berechtigungen ausnutzen kann, um die Domain zu kompromittieren.

### Linikatz/LinikatzV2

* [https://github.com/Orange-Cyberdefense/LinikatzV2](https://github.com/Orange-Cyberdefense/LinikatzV2)
* [https://github.com/CiscoCXSecurity/linikatz](https://github.com/CiscoCXSecurity/linikatz)

## Privesc

### ~~root Benutzererstellung~~

{% hint style="warning" %}
Wenn Sie **einen neuen Benutzer mit dem Namen `root` erstellen k√∂nnen**, k√∂nnen Sie ihn impersonifizieren und Sie werden in der Lage sein, **SSH als root auf jede Maschine zuzugreifen.**

**DAS WURDE BEHOBEN.**
{% endhint %}

Sie k√∂nnen eine detaillierte Erkl√§rung in [https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b](https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b) √ºberpr√ºfen.

## Referenzen

* [https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b](https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b)
* [https://posts.specterops.io/attacking-freeipa-part-i-authentication-77e73d837d6a](https://posts.specterops.io/attacking-freeipa-part-i-authentication-77e73d837d6a)
* [https://posts.specterops.io/attacking-freeipa-part-ii-enumeration-ad27224371e1](https://posts.specterops.io/attacking-freeipa-part-ii-enumeration-ad27224371e1)
* [https://www.youtube.com/watch?v=9dOu-7BTwPQ](https://www.youtube.com/watch?v=9dOu-7BTwPQ)

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
