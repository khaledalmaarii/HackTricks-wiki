# FreeIPA Pentesting

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Informaci√≥n B√°sica

FreeIPA es una **alternativa** de c√≥digo abierto a **Active Directory** de Microsoft, principalmente para entornos **Unix**. Combina un **directorio LDAP** completo con un Centro de Distribuci√≥n de Claves **Kerberos** de MIT para la gesti√≥n similar a Active Directory. Utilizando el **Sistema de Certificados** Dogtag para la gesti√≥n de certificados CA y RA, admite autenticaci√≥n **multifactor**, incluidas las tarjetas inteligentes. SSSD est√° integrado para procesos de autenticaci√≥n Unix.

## Huellas

### Archivos y Variables de Entorno

* El archivo en `/etc/krb5.conf` es donde se almacena la informaci√≥n del cliente Kerberos, necesaria para la inscripci√≥n en el dominio. Esto incluye las ubicaciones de los KDC y servidores administrativos, configuraciones predeterminadas y asignaciones.
* Los valores predeterminados a nivel de sistema para los clientes y servidores IPA se establecen en el archivo ubicado en `/etc/ipa/default.conf`.
* Los hosts dentro del dominio deben tener un archivo `krb5.keytab` en `/etc/krb5.keytab` para los procesos de autenticaci√≥n.
* Varias variables de entorno (`KRB5CCNAME`, `KRB5_KTNAME`, `KRB5_CONFIG`, `KRB5_KDC_PROFILE`, `KRB5RCACHETYPE`, `KRB5RCACHEDIR`, `KRB5_TRACE`, `KRB5_CLIENT_KTNAME`, `KPROP_PORT`) se utilizan para apuntar a archivos y configuraciones espec√≠ficas relevantes para la autenticaci√≥n Kerberos.

### Binarios

Herramientas como `ipa`, `kdestroy`, `kinit`, `klist`, `kpasswd`, `ksu`, `kswitch` y `kvno` son centrales para gestionar dominios FreeIPA, manejar tickets Kerberos, cambiar contrase√±as y adquirir tickets de servicio, entre otras funcionalidades.

### Red

Se proporciona una ilustraci√≥n para representar una configuraci√≥n t√≠pica de servidor FreeIPA.

## Autenticaci√≥n

La autenticaci√≥n en FreeIPA, aprovechando **Kerberos**, refleja la de **Active Directory**. El acceso a los recursos del dominio requiere un ticket Kerberos v√°lido, que puede almacenarse en varias ubicaciones dependiendo de la configuraci√≥n del dominio FreeIPA.

### **Archivos de Tickets CCACHE**

Los archivos CCACHE, almacenados t√≠picamente en **`/tmp`** con permisos **600**, son formatos binarios para almacenar credenciales Kerberos, importantes para la autenticaci√≥n sin la contrase√±a en texto plano del usuario debido a su portabilidad. El an√°lisis de un ticket CCACHE se puede realizar utilizando el comando `klist`, y reutilizar un Ticket CCACHE v√°lido implica exportar `KRB5CCNAME` a la ruta del archivo del ticket.

### **Unix Keyring**

Alternativamente, los Tickets CCACHE pueden almacenarse en el keyring de Linux, ofreciendo m√°s control sobre la gesti√≥n de tickets. El alcance del almacenamiento de tickets var√≠a (`KEYRING:name`, `KEYRING:process:name`, `KEYRING:thread:name`, `KEYRING:session:name`, `KEYRING:persistent:uidnumber`), siendo `klist` capaz de analizar esta informaci√≥n para el usuario. Sin embargo, reutilizar un Ticket CCACHE del keyring de Unix puede presentar desaf√≠os, con herramientas como **Tickey** disponibles para extraer tickets Kerberos.

### Keytab

Los archivos keytab, que contienen principios Kerberos y claves encriptadas, son cr√≠ticos para obtener tickets de concesi√≥n de tickets v√°lidos (TGT) sin necesidad de la contrase√±a del principio. El an√°lisis y la reutilizaci√≥n de credenciales de archivos keytab se pueden realizar f√°cilmente con utilidades como `klist` y scripts como **KeytabParser**.

### Cheatsheet

Puedes encontrar m√°s informaci√≥n sobre c√≥mo usar tickets en linux en el siguiente enlace:

{% content-ref url="privilege-escalation/linux-active-directory.md" %}
[linux-active-directory.md](privilege-escalation/linux-active-directory.md)
{% endcontent-ref %}

## Enumeraci√≥n

{% hint style="warning" %}
Puedes realizar la **enumeraci√≥n** a trav√©s de **ldap** y otras herramientas **binarias**, o **conect√°ndote a la p√°gina web en el puerto 443 del servidor FreeIPA**.
{% endhint %}

### Hosts, Usuarios y Grupos <a href="#id-4b3b" id="id-4b3b"></a>

Es posible crear **hosts**, **usuarios** y **grupos**. Los hosts y usuarios se organizan en contenedores llamados ‚Äú**Grupos de Hosts**‚Äù y ‚Äú**Grupos de Usuarios**‚Äù respectivamente. Estos son similares a las **Unidades Organizativas** (OU).

Por defecto en FreeIPA, el servidor LDAP permite **v√≠nculos an√≥nimos**, y una gran cantidad de datos es enumerable **no autenticada**. Esto puede enumerar todos los datos disponibles no autenticados:
```
ldapsearch -x
```
Para obtener **m√°s informaci√≥n** necesitas usar una sesi√≥n **autenticada** (consulta la secci√≥n de Autenticaci√≥n para aprender c√≥mo preparar una sesi√≥n autenticada).
```bash
# Get all users of domain
ldapsearch -Y gssapi -b "cn=users,cn=compat,dc=domain_name,dc=local"

# Get users groups
ldapsearch -Y gssapi -b "cn=groups,cn=accounts,dc=domain_name,dc=local"

# Get all the hosts
ldapsearch -Y gssapi -b "cn=computers,cn=accounts,dc=domain_name,dc=local"

# Get hosts groups
ldapsearch -Y gssapi -b "cn=hostgroups,cn=accounts,dc=domain_name,dc=local"
```
Desde una m√°quina unida al dominio, podr√°s usar **binarios instalados** para enumerar el dominio:
```bash
ipa user-find
ipa usergroup-find
ipa host-find
ipa host-group-find

-------------------

ipa user-show <username> --all
ipa usergroup-show <user group> --all
ipa host-find <host> --all
ipa hostgroup-show <host group> --all
```
{% hint style="info" %}
El usuario **admin** de **FreeIPA** es el equivalente a los **administradores de dominio** de **AD**.
{% endhint %}

### Hashes <a href="#id-482b" id="id-482b"></a>

El usuario **root** del servidor **IPA** tiene acceso a los **hashes** de contrase√±a.

* El hash de contrase√±a de un usuario se almacena como **base64** en el atributo ‚Äú**userPassword**‚Äù. Este hash puede ser **SSHA512** (versiones antiguas de FreeIPA) o **PBKDF2\_SHA256**.
* El **Nthash** de la contrase√±a se almacena como **base64** en ‚Äú**ipaNTHash**‚Äù si el sistema tiene **integraci√≥n** con **AD**.

Para romper estos hashes:

‚Ä¢ Si FreeIPA est√° integrado con AD, **ipaNTHash** es f√°cil de romper: Debes **decodificar** **base64** -> volver a codificarlo como **ASCII** hex -> John The Ripper o **hashcat** pueden ayudarte a romperlo r√°pidamente.

‚Ä¢ Si se utiliza una versi√≥n antigua de FreeIPA, entonces se usa **SSHA512**: Debes decodificar **base64** -> encontrar el **hash** SSHA512 -> John The Ripper o **hashcat** pueden ayudarte a romperlo.

‚Ä¢ Si se utiliza una nueva versi√≥n de FreeIPA, entonces se usa **PBKDF2\_SHA256**: Debes decodificar **base64** -> encontrar PBKDF2\_SHA256 -> su **longitud** es de 256 bytes. John puede trabajar con 256 bits (32 bytes) -> SHA-265 se utiliza como la funci√≥n pseudoaleatoria, el tama√±o del bloque es de 32 bytes -> solo puedes usar los primeros 256 bits de nuestro hash PBKDF2\_SHA256 -> John The Ripper o hashcat pueden ayudarte a romperlo.

<figure><img src="../.gitbook/assets/image (655).png" alt=""><figcaption></figcaption></figure>

Para extraer los hashes necesitas ser **root en el servidor FreeIPA**, all√≠ puedes usar la herramienta **`dbscan`** para extraerlos:

<figure><img src="../.gitbook/assets/image (293).png" alt=""><figcaption></figcaption></figure>

### HBAC-Rules <a href="#id-482b" id="id-482b"></a>

Son las reglas que otorgan permisos espec√≠ficos a usuarios o hosts sobre recursos (hosts, servicios, grupos de servicios...)
```bash
# Enumerate using ldap
ldapsearch -Y gssapi -b "cn=hbac,dc=domain_name,dc=local"
# Using ipa
ipa hbacrule-find
# Show info of rule
ipa hbacrule-show <hbacrule> --all
```
#### Sudo-Rules

FreeIPA permite el control centralizado sobre **sudo permissions** a trav√©s de sudo-rules. Estas reglas permiten o limitan la ejecuci√≥n de comandos con sudo en los hosts dentro del dominio. Un atacante podr√≠a identificar potencialmente los hosts aplicables, usuarios y comandos permitidos al examinar estos conjuntos de reglas.
```bash
# Enumerate using ldap
ldapsearch -Y gssapi -b "cn=sudorules,cn=sudo,dc=domain_name,dc=local"
# Using ipa
ipa sudorule-find
# Show info of rule
ipa sudorule-show <sudorule> --all
```
### Control de Acceso Basado en Roles

Un **rol** se compone de varios **privilegios**, cada uno de los cuales abarca una colecci√≥n de **permisos**. Estos roles pueden ser asignados a Usuarios, Grupos de Usuarios, **Hosts**, Grupos de Hosts y Servicios. Por ejemplo, considera el rol predeterminado ‚ÄúAdministrador de Usuarios‚Äù en FreeIPA para ejemplificar esta estructura.

El rol `Administrador de Usuarios` tiene estos privilegios:

* **Administradores de Usuarios**
* **Administradores de Grupos**
* **Administradores de Usuarios de Etapa**

Con los siguientes comandos es posible enumerar los roles, privilegios y permisos:
```bash
# Using ldap
ldapsearch -Y gssapi -b "cn=roles,cn=accounts,dc=westeros,dc=local"
# Using ipa binary
ipa role-find
ipa role-show <role> --all
ipa privilege-find
ipa privilege-show <privilege> --all
ipa permission-find
ipa permission-show <permission> --all
```
### Ejemplo de Escenario de Ataque

En [https://posts.specterops.io/attacking-freeipa-part-iii-finding-a-path-677405b5b95e](https://posts.specterops.io/attacking-freeipa-part-iii-finding-a-path-677405b5b95e) puedes encontrar un ejemplo simple de c√≥mo abusar de algunos permisos para comprometer el dominio.

### Linikatz/LinikatzV2

* [https://github.com/Orange-Cyberdefense/LinikatzV2](https://github.com/Orange-Cyberdefense/LinikatzV2)
* [https://github.com/CiscoCXSecurity/linikatz](https://github.com/CiscoCXSecurity/linikatz)

## Privesc

### ~~creaci√≥n de usuario root~~

{% hint style="warning" %}
Si puedes **crear un nuevo usuario con el nombre `root`**, puedes suplantarlo y podr√°s **SSH en cualquier m√°quina como root.**

**ESTO HA SIDO PARCHEADO.**
{% endhint %}

Puedes consultar una explicaci√≥n detallada en [https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b](https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b)

## Referencias

* [https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b](https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b)
* [https://posts.specterops.io/attacking-freeipa-part-i-authentication-77e73d837d6a](https://posts.specterops.io/attacking-freeipa-part-i-authentication-77e73d837d6a)
* [https://posts.specterops.io/attacking-freeipa-part-ii-enumeration-ad27224371e1](https://posts.specterops.io/attacking-freeipa-part-ii-enumeration-ad27224371e1)
* [https://www.youtube.com/watch?v=9dOu-7BTwPQ](https://www.youtube.com/watch?v=9dOu-7BTwPQ)

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
