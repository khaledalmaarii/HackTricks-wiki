# FreeIPA æ¸—é€æµ‹è¯•

<details>

<summary><strong>é€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æ”»å‡»ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨ **HackTricks** ä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½ HackTricks çš„ PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„ [**NFTs**](https://opensea.io/collection/the-peass-family) æ”¶è—
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

æ­¤ä¿¡æ¯å–è‡ªä»¥ä¸‹å¸–å­ï¼š

* [https://posts.specterops.io/attacking-freeipa-part-i-authentication-77e73d837d6a](https://posts.specterops.io/attacking-freeipa-part-i-authentication-77e73d837d6a)
* [https://posts.specterops.io/attacking-freeipa-part-ii-enumeration-ad27224371e1](https://posts.specterops.io/attacking-freeipa-part-ii-enumeration-ad27224371e1)
* [https://www.youtube.com/watch?v=9dOu-7BTwPQ\&feature=youtu.be](https://www.youtube.com/watch?v=9dOu-7BTwPQ\&feature=youtu.be)

## åŸºæœ¬ä¿¡æ¯

å®ƒæ˜¯ Microsoft Windows **Active Directory** çš„ä¸€ä¸ªå¼€æº**æ›¿ä»£å“**ï¼Œä¸»è¦ç”¨ä½œ**Unix**ç¯å¢ƒçš„é›†æˆç®¡ç†è§£å†³æ–¹æ¡ˆã€‚ä¸ Active Directory ç±»ä¼¼ï¼ŒFreeIPA å®ç°äº†å®Œæ•´çš„ **LDAP ç›®å½•**åŸºç¡€è®¾æ–½ï¼Œç”± MIT **Kerberos** å¯†é’¥åˆ†å‘ä¸­å¿ƒæ”¯æŒã€‚å®ƒä½¿ç”¨ Dogtag **è¯ä¹¦ç³»ç»Ÿ**è¿›è¡Œ CA å’Œ RA è¯ä¹¦ç®¡ç†ï¼Œä½¿å…¶èƒ½å¤Ÿå¤„ç†**å¤šå› ç´ **è®¤è¯ï¼ŒåŒ…æ‹¬æ™ºèƒ½å¡ã€‚SSSD ç”¨äºå°† FreeIPA é›†æˆåˆ°æ ‡å‡† Unix è®¤è¯è¿‡ç¨‹ä¸­ã€‚

## æŒ‡çº¹

### æ–‡ä»¶ & ç¯å¢ƒå˜é‡

* **`/etc/krb5.conf`:** `krb5.conf` æ–‡ä»¶åŒ…å« Kerberos å®¢æˆ·ç«¯ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯æ˜¯**åŠ å…¥åŸŸ**æ‰€å¿…éœ€çš„ã€‚è¿™åŒ…æ‹¬ Kerberos é¢†åŸŸçš„ KDC å’Œç®¡ç†å‘˜æœåŠ¡å™¨çš„**ä½ç½®**ï¼Œå½“å‰é¢†åŸŸå’Œ Kerberos åº”ç”¨ç¨‹åºçš„é»˜è®¤è®¾ç½®ï¼Œä»¥åŠä¸»æœºååˆ° Kerberos é¢†åŸŸçš„æ˜ å°„ã€‚
* **`/etc/ipa/default.conf`:** è¿™æ˜¯ IPA æœåŠ¡å™¨çš„**é»˜è®¤é…ç½®æ–‡ä»¶**ï¼Œç”¨äºè®¾ç½®åœ¨è¿è¡Œ IPA å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨æ—¶åº”ç”¨çš„ç³»ç»ŸèŒƒå›´çš„é»˜è®¤å€¼ã€‚
* **`/etc/krb5.keytab`:** `krb5.keytab` æ–‡ä»¶åœ¨**åŸŸ**å†…çš„æ‰€æœ‰ä¸»æœºä¸Šéƒ½æ˜¯**å¿…éœ€çš„**ã€‚å®ƒæ˜¯ KDC **è®¤è¯**è¿‡ç¨‹çš„ä¸€éƒ¨åˆ†ã€‚
* **`KRB5CCNAME`:** å¦‚æœè®¾ç½®ï¼Œæ­¤å˜é‡æŒ‡å‘ç”¨äºè®¤è¯çš„ **CCACHE ç¥¨æ®**çš„**ä½ç½®**ã€‚
* **`KRB5_KTNAME`:** å¦‚æœè®¾ç½®ï¼Œæ­¤å˜é‡æŒ‡å‘ç”¨äºè®¤è¯çš„**å¯†é’¥è¡¨**æ–‡ä»¶çš„**ä½ç½®**ã€‚
* **`KRB5_CONFIG`:** å¦‚æœè®¾ç½®ï¼Œæ­¤å˜é‡æŒ‡å‘ Kerberos é…ç½®æ–‡ä»¶çš„**ä½ç½®**ã€‚
* **`KRB5_KDC_PROFILE`:** å¦‚æœè®¾ç½®ï¼Œæ­¤å˜é‡æŒ‡å‘ KDC é…ç½®æ–‡ä»¶çš„**ä½ç½®**ï¼Œå…¶ä¸­åŒ…å«é’ˆå¯¹å¯†é’¥åˆ†å‘ä¸­å¿ƒå®ˆæŠ¤è¿›ç¨‹çš„é¢å¤–é…ç½®æŒ‡ä»¤ã€‚
* **`KRB5RCACHETYPE`:** æ­¤å˜é‡æŒ‡å®šæœåŠ¡å™¨ä½¿ç”¨çš„**é»˜è®¤é‡æ”¾ç¼“å­˜ç±»å‹**ã€‚
* **`KRB5RCACHEDIR`:** æ­¤å˜é‡æŒ‡å®šæœåŠ¡å™¨ä½¿ç”¨çš„**é»˜è®¤é‡æ”¾ç¼“å­˜ç›®å½•**ã€‚
* **`KRB5_TRACE`:** æ­¤å˜é‡æŒ‡å®šä¸€ä¸ª**æ–‡ä»¶åä»¥å†™å…¥è·Ÿè¸ªæ—¥å¿—è¾“å‡º**ã€‚è·Ÿè¸ªæ—¥å¿—å¯ä»¥å¸®åŠ©é˜æ˜ Kerberos åº“å†…éƒ¨åšå‡ºçš„å†³ç­–ã€‚
* **`KRB5_CLIENT_KTNAME`:** æ­¤å˜é‡è®¾ç½®**é»˜è®¤å®¢æˆ·ç«¯å¯†é’¥è¡¨**æ–‡ä»¶åã€‚
* **`KPROP_PORT`:** æ­¤å˜é‡è®¾ç½® kprop ä½¿ç”¨çš„**é»˜è®¤ç«¯å£**ã€‚

### äºŒè¿›åˆ¶æ–‡ä»¶

* **ipa:** æ­¤äºŒè¿›åˆ¶æ–‡ä»¶æ˜¯**ç®¡ç† FreeIPA åŸŸ**çš„æ ‡å‡†ã€‚å®ƒå¯ä»¥ç”¨æ¥ç®¡ç†ä¸»æœºã€ç”¨æˆ·ã€sudo è§„åˆ™ç­‰ç­‰ã€‚
* **kdestroy:** kdestroy äºŒè¿›åˆ¶æ–‡ä»¶ç”¨äº**é”€æ¯**ç”¨æˆ·ä¼šè¯ä¸­çš„ä»»ä½•å½“å‰**Kerberos ç¥¨æ®**ã€‚
* **kinit:** kinit äºŒè¿›åˆ¶æ–‡ä»¶ç”¨äº**å»ºç«‹**æˆ–**æ›´æ–°** **Kerberos ç¥¨æ®**ã€‚
* **klist:** klist äºŒè¿›åˆ¶æ–‡ä»¶**åˆ—å‡º**å½“å‰ä½¿ç”¨ä¸­çš„ä»»ä½•**Kerberos ç¥¨æ®**ï¼Œä»¥åŠè¿™äº›ç¥¨æ®æä¾›è®¿é—®æƒé™çš„ä¸»ä½“ã€‚
* **kpasswd:** kpasswd å‘½ä»¤ç”¨äº**æ›´æ”¹ Kerberos ä¸»ä½“çš„å¯†ç **ã€‚kpasswd é¦–å…ˆæç¤ºè¾“å…¥å½“å‰çš„ Kerberos å¯†ç ï¼Œç„¶åæç¤ºç”¨æˆ·ä¸¤æ¬¡è¾“å…¥æ–°å¯†ç ï¼Œå¹¶æ›´æ”¹å¯†ç ã€‚
* **ksu:** Ksu å¯ä»¥ç”¨ä½œ**su äºŒè¿›åˆ¶æ–‡ä»¶çš„æ›¿ä»£å“**ï¼Œä»¥åˆ‡æ¢å½“å‰çš„**ç”¨æˆ·ä¸Šä¸‹æ–‡**ã€‚
* **kswitch:** kswitch å‘½ä»¤å°†**åˆ‡æ¢**å½“å‰ä½¿ç”¨ä¸­çš„**å‡­è¯ç¼“å­˜**ã€‚
* **kvno:** kvno äºŒè¿›åˆ¶æ–‡ä»¶è·å–**æŒ‡å®š Kerberos** ä¸»ä½“çš„**æœåŠ¡ç¥¨æ®**å¹¶æ‰“å°å‡ºæ¯ä¸ªçš„å¯†é’¥ç‰ˆæœ¬å·ã€‚

### ç½‘ç»œ

è¿™æ˜¯ä¸€ä¸ª FreeIPA æœåŠ¡å™¨å¯èƒ½çš„æ ·å­ï¼š

<figure><img src="../.gitbook/assets/image (197).png" alt=""><figcaption></figcaption></figure>

## è®¤è¯

ç”±äº FreeIPA ä½¿ç”¨ **Kerberos è¿›è¡Œè®¤è¯**ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸ **Active Directory** ä¸­çš„**è®¤è¯**éå¸¸ç›¸ä¼¼ã€‚ä¸ºäº†**è®¿é—®**åŸŸä¸Šçš„èµ„æºï¼Œç”¨æˆ·å¿…é¡»æœ‰è¯¥èµ„æºçš„**æœ‰æ•ˆ Kerberos ç¥¨æ®**ã€‚è¿™äº›ç¥¨æ®å¯ä»¥æ ¹æ® FreeIPA åŸŸçš„é…ç½®å­˜å‚¨åœ¨ä¸åŒçš„ä½ç½®ã€‚

### **CCACHE ç¥¨æ®æ–‡ä»¶**

å½“ç¥¨æ®è®¾ç½®ä¸ºåœ¨**ç£ç›˜**ä¸Šä»¥**æ–‡ä»¶**å½¢å¼**å­˜å‚¨**æ—¶ï¼Œæ ‡å‡†æ ¼å¼å’Œç±»å‹æ˜¯ **CCACHE** æ–‡ä»¶ã€‚è¿™æ˜¯ä¸€ç§ç®€å•çš„äºŒè¿›åˆ¶æ–‡ä»¶æ ¼å¼ï¼Œç”¨äºå­˜å‚¨ Kerberos å‡­è¯ã€‚è¿™äº›æ–‡ä»¶é€šå¸¸å­˜å‚¨åœ¨ **`/tmp`** ä¸­ï¼Œå¹¶å…·æœ‰ **600** æƒé™ã€‚ä»æ”»å‡»è€…çš„è§’åº¦æ¥çœ‹ï¼Œè¿™å¾ˆé‡è¦ï¼ŒåŸå› å¦‚ä¸‹ï¼š

1. æœ‰æ•ˆç¥¨æ®å¯ä»¥è¢«**åˆ©ç”¨è¿›è¡Œè®¤è¯**ï¼Œ**æ— éœ€**ç›¸åº”ç”¨æˆ·çš„æ˜æ–‡**å¯†ç **ã€‚
2. **CCACHE** ç¥¨æ®éå¸¸**ä¾¿æº**ã€‚å®ƒä»¬å¯ä»¥ä¸‹è½½å¹¶åŠ è½½åˆ°å¦ä¸€å°ä¸»æœºä¸Šï¼Œæ— éœ€æ›´æ–°æˆ–éªŒè¯ç¥¨æ®ã€‚

**è§£æ** CCACHE ç¥¨æ®å¯ä»¥é€šè¿‡å¤šç§ä¸åŒçš„æ–¹å¼è½»æ¾å®Œæˆã€‚æœ€ç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨ klist äºŒè¿›åˆ¶æ–‡ä»¶è¿›è¡Œè§£æã€‚
```
klist /tmp/krb5cc_0
```
<figure><img src="../.gitbook/assets/image (70).png" alt=""><figcaption></figcaption></figure>

å¯¹äºæ”»å‡»è€…æ¥è¯´ï¼Œé‡ç”¨CCACHE Ticketéå¸¸å®¹æ˜“ã€‚è¦**é‡ç”¨**æœ‰æ•ˆçš„CCACHE Ticketï¼Œ**å¯¼å‡º** **KRB5CCNAME** åˆ°æœ‰æ•ˆç¥¨è¯æ–‡ä»¶çš„**è·¯å¾„**ã€‚ç³»ç»Ÿåº”è¯†åˆ«ç¯å¢ƒå˜é‡ï¼Œå¹¶åœ¨ä¸åŸŸäº¤äº’æ—¶å°è¯•ä½¿ç”¨è¯¥å‡­æ®ææ–™ã€‚
```bash
export KRB5CCNAME=/tmp/krb5cc_0
klist
```
### **Unix Keyring**

CCACHE Tickets **å¯ä»¥** **å­˜å‚¨** åœ¨ **Linux keyring** ä¸­ã€‚keyring å­˜åœ¨äº **å†…æ ¸** ä¸­ï¼Œå¹¶ä¸ºç®¡ç†å‘˜æä¾›äº† **æ›´å¤šæ§åˆ¶å­˜å‚¨ç¥¨æ®æ£€ç´¢å’Œä½¿ç”¨çš„æƒé™**ã€‚ç¥¨æ®å¯ä»¥æŒ‰ä»¥ä¸‹ä¸åŒæ–¹å¼é™å®šèŒƒå›´ï¼š

* **`KEYRING:name`ï¼š** ç¥¨æ®é™å®šåœ¨ç‰¹å®šå‘½åçš„ Keyring ä¸­ã€‚
* **`KEYRING:process:name`ï¼š** ç¥¨æ®é™å®šåœ¨ç‰¹å®šè¿›ç¨‹ id ä¸­ã€‚
* **`KEYRING:thread:name`ï¼š** ç¥¨æ®é™å®šåœ¨ç‰¹å®šçº¿ç¨‹ä¸­ã€‚
* **`KEYRING:session:name`ï¼š** ç¥¨æ®é™å®šåœ¨ç‰¹å®šç”¨æˆ·ä¼šè¯ä¸­ã€‚
* **`KEYRING:persistent:uidnumber`ï¼š** ç¥¨æ®é™å®šåœ¨ç‰¹å®šç”¨æˆ·ä¸­ï¼Œä¸è€ƒè™‘ä¼šè¯ï¼ˆé»˜è®¤ï¼‰ã€‚

æ ¹æ®ç®¡ç†å‘˜å¦‚ä½•é™å®š Unix keyring å†…å­˜å‚¨çš„ç¥¨æ®ï¼Œè§£æå®ƒå¯èƒ½ä¼šå¾ˆå›°éš¾ã€‚ç„¶è€Œï¼ŒUnix keyring ä¸­ CCACHE Tickets çš„ **é»˜è®¤** **èŒƒå›´** æ˜¯ **`KEYRING:persistent:uidnumber`**ã€‚å¹¸è¿çš„æ˜¯ï¼Œå¦‚æœä½ å¤„äº **ç”¨æˆ·** çš„ **ä¸Šä¸‹æ–‡** ä¸­ï¼Œ`klist` å¯ä»¥ä¸ºæˆ‘ä»¬ **è§£æ** è¿™äº›ä¿¡æ¯ã€‚

ä½œä¸ºæ”»å‡»è€…ï¼Œ**é‡ç”¨å­˜å‚¨åœ¨ Unix keyring ä¸­çš„ CCACHE** ç¥¨æ®å–å†³äºç¥¨æ®çš„é™å®šèŒƒå›´ï¼Œå¯èƒ½ä¼šç›¸å½“ **å›°éš¾**ã€‚å¹¸è¿çš„æ˜¯ï¼Œ[@Zer1t0](https://github.com/Zer1t0) ä» [@Tarlogic](https://twitter.com/Tarlogic) å¼€å‘äº†ä¸€ä¸ªå·¥å…·ï¼Œå¯ä»¥ä» Unix keyring æå– Kerberos ç¥¨æ®ã€‚è¿™ä¸ªå·¥å…·å«åš **Tickey**ï¼Œå¯ä»¥åœ¨[**è¿™é‡Œ**](https://github.com/TarlogicSecurity/tickey)æ‰¾åˆ°ã€‚

### Keytab <a href="#ff38" id="ff38"></a>

{% hint style="warning" %}
é€šå¸¸ï¼Œæ¯ä¸ªä¸»æœºéƒ½éƒ¨ç½²æœ‰ä¸€ä¸ª keytab å‡­è¯ï¼Œè¯¥å‡­è¯å¯ç”¨äºè·å–æœ‰æ•ˆçš„ Credential Cache(CCACHE) Ticket Granting Ticket(TGT) ä»¥ä¾›ä¸»æœºæœ¬èº«ä½¿ç”¨ã€‚
{% endhint %}

å®ƒç”± **Kerberos ä¸»ä½“å’ŒåŠ å¯†å¯†é’¥** å¯¹ç»„æˆï¼Œè¿™äº›å¯†é’¥æ˜¯ä»ä¸ä¸»ä½“å…³è”çš„ Kerberos å¯†ç æ´¾ç”Ÿçš„ã€‚ç”±äºè¿™äº›å¯†é’¥æ˜¯ä»ä¸»ä½“çš„å¯†ç æ´¾ç”Ÿçš„ï¼Œå¦‚æœè¯¥ **å¯†ç æ›´æ”¹ï¼Œkeytab å°†å¤±æ•ˆ**ã€‚

Keytab æ–‡ä»¶å¯ä»¥ç”¨æ¥ **è·å–æœ‰æ•ˆçš„ç¥¨æ®æˆäºˆç¥¨** (TGT)ï¼Œé€‚ç”¨äºå®ƒé™å®šçš„ä¸»ä½“ã€‚è¿™ä¸ªè®¤è¯è¿‡ç¨‹ **ä¸éœ€è¦å¯†ç **ï¼Œå› ä¸ºå®ƒåŒ…å«äº†ä»å¯†ç æ´¾ç”Ÿçš„å¯†é’¥ã€‚

è§£æ Keytab æ–‡ä»¶éå¸¸å®¹æ˜“ï¼Œå¯ä»¥é€šè¿‡å‡ ç§æ–¹å¼å®Œæˆã€‚è§£æ **keytab** æ–‡ä»¶æœ€ç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨ **klist**ã€‚ç¬¬äºŒç§æ–¹æ³•åˆ©ç”¨äº† [Cody Thomas](https://medium.com/u/645ffcef8682?source=post\_page-----77e73d837d6a--------------------------------) åˆ›å»ºçš„ä¸€ä¸ªå‡ºè‰²çš„ python å·¥å…·ã€‚ä»–çš„ **[KeytabParser](https://github.com/its-a-feature/KeytabParser)** é¡¹ç›®å°†è§£æå‡ºä¸»ä½“åŠå…¶ç›¸å…³çš„åŠ å¯†å¯†é’¥ã€‚

æ”»å‡»è€…å¯ä»¥é€šè¿‡ç”Ÿæˆ kinit äºŒè¿›åˆ¶æ–‡ä»¶çš„ CCACHE ç¥¨æ®ï¼Œ**é‡ç”¨å­˜å‚¨åœ¨ keytab æ–‡ä»¶ä¸­çš„å‡­è¯**ã€‚
```powershell
# Parse keytab
klist -k /rtc/krb5.keytab

# Get TGT
kinit -kt /etc/krb5.keytab host/bastion.westeros.local@WESTEROS.LOCAL
```
### é€ŸæŸ¥è¡¨

æ‚¨å¯ä»¥åœ¨ä»¥ä¸‹é“¾æ¥ä¸­æ‰¾åˆ°æœ‰å…³å¦‚ä½•åœ¨linuxä¸­ä½¿ç”¨ç¥¨æ®çš„æ›´å¤šä¿¡æ¯ï¼š

{% content-ref url="privilege-escalation/linux-active-directory.md" %}
[linux-active-directory.md](privilege-escalation/linux-active-directory.md)
{% endcontent-ref %}

## æšä¸¾

{% hint style="warning" %}
æ‚¨å¯ä»¥é€šè¿‡ **ldap** å’Œå…¶ä»– **äºŒè¿›åˆ¶** å·¥å…·æ‰§è¡Œ**æšä¸¾**ï¼Œæˆ–è€…**è¿æ¥åˆ° FreeIPA æœåŠ¡å™¨443ç«¯å£çš„ç½‘é¡µ**ã€‚
{% endhint %}

### ä¸»æœºã€ç”¨æˆ·å’Œç»„ <a href="#4b3b" id="4b3b"></a>

å¯ä»¥åˆ›å»º**ä¸»æœº**ã€**ç”¨æˆ·**å’Œ**ç»„**ã€‚ä¸»æœºå’Œç”¨æˆ·è¢«åˆ†é…åˆ°ç§°ä¸ºâ€œ**ä¸»æœºç»„**â€å’Œâ€œ**ç”¨æˆ·ç»„**â€çš„å®¹å™¨ä¸­ã€‚è¿™äº›ç±»ä¼¼äº**ç»„ç»‡å•ä½**ï¼ˆOUï¼‰ã€‚

åœ¨ FreeIPA ä¸­ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒLDAP æœåŠ¡å™¨å…è®¸**åŒ¿åç»‘å®š**ï¼Œå¹¶ä¸”å¤§é‡æ•°æ®å¯ä»¥**æœªç»è®¤è¯**åœ°æšä¸¾ã€‚è¿™å¯ä»¥æšä¸¾æ‰€æœ‰å¯æœªç»è®¤è¯è®¿é—®çš„æ•°æ®ï¼š
```
ldapsearch -x
```
è¦è·å–**æ›´å¤šä¿¡æ¯**ï¼Œæ‚¨éœ€è¦ä½¿ç”¨ä¸€ä¸ª**è®¤è¯**åçš„ä¼šè¯ï¼ˆæŸ¥çœ‹è®¤è¯éƒ¨åˆ†ä»¥äº†è§£å¦‚ä½•å‡†å¤‡ä¸€ä¸ªè®¤è¯ä¼šè¯ï¼‰ã€‚
```bash
# Get all users of domain
ldapsearch -Y gssapi -b "cn=users,cn=compat,dc=domain_name,dc=local"

# Get users groups
ldapsearch -Y gssapi -b "cn=groups,cn=accounts,dc=domain_name,dc=local"

# Get all the hosts
ldapsearch -Y gssapi -b "cn=computers,cn=accounts,dc=domain_name,dc=local"

# Get hosts groups
ldapsearch -Y gssapi -b "cn=hostgroups,cn=accounts,dc=domain_name,dc=local"
```
ä»åŠ å…¥åŸŸçš„æœºå™¨ä¸Šï¼Œæ‚¨å°†èƒ½å¤Ÿä½¿ç”¨**å·²å®‰è£…çš„äºŒè¿›åˆ¶æ–‡ä»¶**æ¥æšä¸¾åŸŸï¼š
```bash
ipa user-find
ipa usergroup-find
ipa host-find
ipa host-group-find

-------------------

ipa user-show <username> --all
ipa usergroup-show <user group> --all
ipa host-find <host> --all
ipa hostgroup-show <host group> --all
```
{% hint style="info" %}
**FreeIPA** çš„ **admin** ç”¨æˆ·ç›¸å½“äº **AD** ä¸­çš„ **domain admins**ã€‚
{% endhint %}

### å“ˆå¸Œ <a href="#482b" id="482b"></a>

**IPA æœåŠ¡å™¨**çš„ **root** ç”¨æˆ·å¯ä»¥è®¿é—®å¯†ç çš„**å“ˆå¸Œ**ã€‚

* ç”¨æˆ·çš„å¯†ç å“ˆå¸Œä»¥ **base64** å­˜å‚¨åœ¨â€œ**userPassword**â€**å±æ€§**ä¸­ã€‚è¿™ä¸ªå“ˆå¸Œå¯èƒ½æ˜¯ **SSHA512**ï¼ˆFreeIPAçš„æ—§ç‰ˆæœ¬ï¼‰æˆ– **PBKDF2_SHA256**ã€‚
* å¦‚æœç³»ç»Ÿä¸ **AD** æœ‰**é›†æˆ**ï¼Œå¯†ç çš„ **Nthash** ä»¥ **base64** å­˜å‚¨åœ¨â€œ**ipaNTHash**â€ä¸­ã€‚

è¦ç ´è§£è¿™äº›å“ˆå¸Œï¼š

â€¢ å¦‚æœ freeIPA ä¸ AD é›†æˆï¼Œ**ipaNTHash** å¾ˆå®¹æ˜“ç ´è§£ï¼šä½ åº”è¯¥**è§£ç ** **base64** -> é‡æ–°ç¼–ç ä¸º **ASCII** åå…­è¿›åˆ¶ -> John The Ripper æˆ– **hashcat** å¯ä»¥å¸®åŠ©ä½ å¿«é€Ÿç ´è§£

â€¢ å¦‚æœä½¿ç”¨çš„æ˜¯ FreeIPA çš„æ—§ç‰ˆæœ¬ï¼Œå› æ­¤ä½¿ç”¨ **SSHA512**ï¼šä½ åº”è¯¥è§£ç  **base64** -> æ‰¾åˆ° SSHA512 **å“ˆå¸Œ** -> John The Ripper æˆ– **hashcat** å¯ä»¥å¸®åŠ©ä½ ç ´è§£

â€¢ å¦‚æœä½¿ç”¨çš„æ˜¯ FreeIPA çš„æ–°ç‰ˆæœ¬ï¼Œå› æ­¤ä½¿ç”¨ **PBKDF2_SHA256**ï¼šä½ åº”è¯¥è§£ç  **base64** -> æ‰¾åˆ° PBKDF2_SHA256 -> å®ƒçš„**é•¿åº¦**æ˜¯ 256 å­—èŠ‚ã€‚John å¯ä»¥å¤„ç† 256 ä½ï¼ˆ32 å­—èŠ‚ï¼‰-> SHA-256 ç”¨ä½œä¼ªéšæœºå‡½æ•°ï¼Œå—å¤§å°æ˜¯ 32 å­—èŠ‚ -> ä½ åªèƒ½ä½¿ç”¨æˆ‘ä»¬çš„ PBKDF2_SHA256 å“ˆå¸Œçš„å‰ 256 ä½ -> John The Ripper æˆ– hashcat å¯ä»¥å¸®åŠ©ä½ ç ´è§£

<figure><img src="../.gitbook/assets/image (33).png" alt=""><figcaption></figcaption></figure>

è¦æå–å“ˆå¸Œï¼Œä½ éœ€è¦æˆä¸º **FreeIPA æœåŠ¡å™¨**ä¸­çš„ **root**ï¼Œåœ¨é‚£é‡Œä½ å¯ä»¥ä½¿ç”¨å·¥å…· **`dbscan`** æ¥æå–å®ƒä»¬ï¼š

<figure><img src="../.gitbook/assets/image (196).png" alt=""><figcaption></figcaption></figure>

### HBAC-Rules <a href="#482b" id="482b"></a>

è¿™äº›è§„åˆ™æˆäºˆç”¨æˆ·æˆ–ä¸»æœºå¯¹èµ„æºï¼ˆä¸»æœºã€æœåŠ¡ã€æœåŠ¡ç»„ç­‰ï¼‰çš„ç‰¹å®šæƒé™ã€‚
```bash
# Enumerate using ldap
ldapsearch -Y gssapi -b "cn=hbac,dc=domain_name,dc=local"
# Using ipa
ipa hbacrule-find
# Show info of rule
ipa hbacrule-show <hbacrule> --all
```
#### Sudo è§„åˆ™

FreeIPA æä¾›äº†ä»ä¸€ä¸ª**é›†ä¸­**æº**ç®¡ç† sudo æƒé™**çš„èƒ½åŠ›ï¼Œé€šè¿‡ sudo è§„åˆ™ã€‚è¿™äº›è§„åˆ™é›†å¯ä»¥ç”¨æ¥é™åˆ¶æˆ–å§”æ´¾åœ¨åŸŸä¸­æ³¨å†Œçš„ä¸»æœºä¸Š**ä½œä¸º sudo æ‰§è¡Œå‘½ä»¤**çš„èƒ½åŠ›ã€‚ä½œä¸ºæ”»å‡»è€…ï¼Œæˆ‘ä»¬å¯ä»¥æšä¸¾è¿™äº›è§„åˆ™é›†é€‚ç”¨äºå“ªäº›ä¸»æœºå’Œç”¨æˆ·ï¼Œä»¥åŠå“ªäº›å‘½ä»¤é€šè¿‡è§„åˆ™é›†è¢«å…è®¸ã€‚
```bash
# Enumerate using ldap
ldapsearch -Y gssapi -b "cn=sudorules,cn=sudo,dc=domain_name,dc=local"
# Using ipa
ipa sudorule-find
# Show info of rule
ipa sudorule-show <sudorule> --all
```
### åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶

æ¯ä¸ª**è§’è‰²**åŒ…å«ä¸€ç»„**æƒé™**ï¼Œè¿™äº›ç›¸åº”çš„æƒé™åŒ…å«ä¸€ç»„**æƒé™**ã€‚è§’è‰²å¯ä»¥**åº”ç”¨äºç”¨æˆ·**ã€ç”¨æˆ·**ç»„**ã€**ä¸»æœº**ã€ä¸»æœºç»„å’ŒæœåŠ¡ã€‚ä¸ºäº†è¯´æ˜è¿™ä¸ªæ¦‚å¿µï¼Œè®©æˆ‘ä»¬è®¨è®º FreeIPA ä¸­é»˜è®¤çš„â€œç”¨æˆ·ç®¡ç†å‘˜â€è§’è‰²ã€‚

<figure><img src="../.gitbook/assets/image (161).png" alt=""><figcaption></figcaption></figure>

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œâ€œç”¨æˆ·ç®¡ç†å‘˜â€è§’è‰²åŒ…å«ä»¥ä¸‹æƒé™ï¼š

* **ç”¨æˆ·ç®¡ç†å‘˜**
* **ç»„ç®¡ç†å‘˜**
* **é˜¶æ®µç”¨æˆ·ç®¡ç†å‘˜**

æˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥æ·±å…¥å¹¶åˆ—ä¸¾æ¯ä¸ª**æƒé™**æ‰€å§”æ‰˜çš„**æƒé™**ï¼š

<figure><img src="../.gitbook/assets/image (189).png" alt=""><figcaption></figcaption></figure>

å¦‚æˆ‘ä»¬æ‰€è§ï¼Œâ€œ**ç”¨æˆ·ç®¡ç†å‘˜**â€è§’è‰²åœ¨ç¯å¢ƒå†…åŒ…å«ç›¸å½“**å¤šçš„æƒé™**ã€‚ç†è§£**è§’è‰²**ã€**æƒé™**å’Œ**æƒé™**çš„ä¸€èˆ¬æ¦‚å¿µå’Œç»“æ„å¯¹äºè¯†åˆ«ç¯å¢ƒä¸­çš„æ”»å‡»è·¯å¾„è‡³å…³é‡è¦ã€‚
```bash
# Using ldap
ldapsearch -Y gssapi -b "cn=roles,cn=accounts,dc=westeros,dc=local"
# Using ipa binary
ipa role-find
ipa role-show <role> --all
ipa privilege-find
ipa privilege-show <privilege> --all
ipa permission-find
ipa permission-show <permission> --all
```
### æ”»å‡»åœºæ™¯ç¤ºä¾‹

åœ¨ [https://posts.specterops.io/attacking-freeipa-part-iii-finding-a-path-677405b5b95e](https://posts.specterops.io/attacking-freeipa-part-iii-finding-a-path-677405b5b95e) ä¸­ï¼Œä½ å¯ä»¥æ‰¾åˆ°ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œè¯´æ˜å¦‚ä½•æ»¥ç”¨æŸäº›æƒé™æ¥å±å®³åŸŸã€‚

### Linikatz/LinikatzV2

* [https://github.com/Orange-Cyberdefense/LinikatzV2](https://github.com/Orange-Cyberdefense/LinikatzV2)
* [https://github.com/CiscoCXSecurity/linikatz](https://github.com/CiscoCXSecurity/linikatz)

## æƒé™æå‡

### ~~åˆ›å»º root ç”¨æˆ·~~

{% hint style="warning" %}
å¦‚æœä½ èƒ½**åˆ›å»ºä¸€ä¸ªåä¸º `root` çš„æ–°ç”¨æˆ·**ï¼Œä½ å¯ä»¥å†’å……ä»–ï¼Œå¹¶ä¸”ä½ å°†èƒ½å¤Ÿ**ä½œä¸º root SSH è¿›å…¥ä»»ä½•æœºå™¨ã€‚**

**è¿™ä¸ªé—®é¢˜å·²ç»è¢«ä¿®å¤ã€‚**
{% endhint %}

"**ç”¨æˆ·ç®¡ç†å‘˜**"æƒé™éå¸¸å¼ºå¤§ï¼ˆæ­£å¦‚å…¶åç§°æ‰€ç¤ºï¼‰ï¼š

<figure><img src="../.gitbook/assets/image (182).png" alt=""><figcaption></figcaption></figure>

æ‹¥æœ‰è¿™ä¸ªæƒé™å¯ä»¥å¯¹ç¯å¢ƒå†…çš„ç”¨æˆ·äº§ç”Ÿå¾ˆå¤šä¸åŒçš„å½±å“ã€‚åˆ©ç”¨è¿™ä¸ªæƒé™ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ FreeIPA åŸŸå†…**åˆ›å»ºä¸€ä¸ªåä¸º \_root**\_ çš„æ–°ç”¨æˆ·ã€‚

<figure><img src="../.gitbook/assets/image (158).png" alt=""><figcaption></figcaption></figure>

ä¸€æ—¦åœ¨åŸŸä¸­åˆ›å»ºäº†ç”¨æˆ·ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºè¯¥è´¦æˆ·**è·å–ä¸€ä¸ªç¥¨æ®ï¼Œä½¿ç”¨ \_kinit**\_ã€‚

<figure><img src="../.gitbook/assets/image (178).png" alt=""><figcaption></figcaption></figure>

ç°åœ¨æˆ‘ä»¬å¯ä»¥å°è¯•ä½¿ç”¨æˆ‘ä»¬æ–°åˆ›å»ºçš„ root åŸŸè´¦æˆ·è¿›è¡Œ **SSH**ã€‚

<figure><img src="../.gitbook/assets/image (176).png" alt=""><figcaption></figcaption></figure>

å¦‚å›¾æ‰€ç¤ºï¼Œè¿™ä¼š**å°†ç”¨æˆ·å¸¦å…¥æœ¬åœ° root è´¦æˆ·**ï¼å› æ­¤ï¼Œä»…ä»…é€šè¿‡ä¸ºæœ¬åœ°ç”¨æˆ·åˆ›å»ºä¸€ä¸ªåŸŸç”¨æˆ·ï¼Œæˆ‘ä»¬å°±èƒ½ä½¿ç”¨ _root@WESTEROS.LOCAL_ è´¦æˆ·è¿›è¡Œè®¤è¯ï¼Œå¹¶è·å¾—**æœ¬åœ° root è´¦æˆ·çš„ç”¨æˆ·ä¸Šä¸‹æ–‡**_._

_æœ‰å…³æ­¤æ¼æ´çš„æ›´å¤šè¯¦æƒ…ï¼Œè¯·æŸ¥çœ‹_ [_https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b_](https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b)\\

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æ”»å‡»ç›´åˆ°æˆä¸ºä¸“å®¶ï¼Œé€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

å…¶ä»–æ”¯æŒ HackTricks çš„æ–¹å¼ï¼š

* å¦‚æœä½ æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½ HackTricks çš„ PDF**ï¼Œè¯·æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å– [**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç° [**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„ [**NFTs**](https://opensea.io/collection/the-peass-family) æ”¶è—
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚

</details>
