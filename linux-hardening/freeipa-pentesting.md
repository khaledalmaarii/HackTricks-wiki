# Testowanie penetracyjne FreeIPA

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) **i** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **repozytoriÃ³w GitHub**.

</details>

## Podstawowe informacje

FreeIPA to otwarte oprogramowanie **alternatywne** dla Microsoft Windows **Active Directory**, gÅ‚Ã³wnie dla Å›rodowisk **Unixowych**. ÅÄ…czy ono kompletny **katalog LDAP** z MIT **Kerberos** Key Distribution Center do zarzÄ…dzania podobnego do Active Directory. Wykorzystuje Dogtag **Certificate System** do zarzÄ…dzania certyfikatami CA i RA, obsÅ‚uguje **uwierzytelnianie wieloczynnikowe**, w tym karty inteligentne. SSSD jest zintegrowane do procesÃ³w uwierzytelniania Unix.

## Odciski palcÃ³w

### Pliki i zmienne Å›rodowiskowe

- Plik **`/etc/krb5.conf`** przechowuje informacje klienta Kerberos, niezbÄ™dne do zapisania w domenie. Zawiera on lokalizacje KDC i serwerÃ³w administracyjnych, domyÅ›lne ustawienia i mapowania.
- DomyÅ›lne ustawienia dla klientÃ³w i serwerÃ³w IPA sÄ… ustawiane w pliku **`/etc/ipa/default.conf`**.
- Hosty w domenie muszÄ… mieÄ‡ plik **`krb5.keytab`** w **`/etc/krb5.keytab`** do procesÃ³w uwierzytelniania.
- RÃ³Å¼ne zmienne Å›rodowiskowe (**`KRB5CCNAME`**, **`KRB5_KTNAME`**, **`KRB5_CONFIG`**, **`KRB5_KDC_PROFILE`**, **`KRB5RCACHETYPE`**, **`KRB5RCACHEDIR`**, **`KRB5_TRACE`**, **`KRB5_CLIENT_KTNAME`**, **`KPROP_PORT`**) sÄ… uÅ¼ywane do wskazywania konkretnych plikÃ³w i ustawieÅ„ zwiÄ…zanych z uwierzytelnianiem Kerberos.

### Binaria

NarzÄ™dzia takie jak **`ipa`**, **`kdestroy`**, **`kinit`**, **`klist`**, **`kpasswd`**, **`ksu`**, **`kswitch`** i **`kvno`** sÄ… kluczowe do zarzÄ…dzania domenami FreeIPA, obsÅ‚ugi biletÃ³w Kerberos, zmiany haseÅ‚ i uzyskiwania biletÃ³w usÅ‚ug, wÅ›rÃ³d innych funkcji.

### SieÄ‡

Przedstawiono ilustracjÄ™ typowego zestawienia serwera FreeIPA.

## Uwierzytelnianie

Uwierzytelnianie w FreeIPA, wykorzystujÄ…ce **Kerberos**, jest podobne do uwierzytelniania w **Active Directory**. DostÄ™p do zasobÃ³w domeny wymaga waÅ¼nego biletu Kerberos, ktÃ³ry moÅ¼e byÄ‡ przechowywany w rÃ³Å¼nych lokalizacjach w zaleÅ¼noÅ›ci od konfiguracji domeny FreeIPA.

### Pliki biletÃ³w CCACHE

Pliki CCACHE, przechowywane zwykle w **`/tmp`** z uprawnieniami **600**, sÄ… formatami binarnymi do przechowywania poÅ›wiadczeÅ„ Kerberos, waÅ¼nych dla uwierzytelniania bez hasÅ‚a tekstowego uÅ¼ytkownika ze wzglÄ™du na ich przenoÅ›noÅ›Ä‡. Parsowanie biletu CCACHE moÅ¼na wykonaÄ‡ za pomocÄ… polecenia **`klist`**, a ponowne uÅ¼ycie waÅ¼nego biletu CCACHE polega na wyeksportowaniu **`KRB5CCNAME`** do Å›cieÅ¼ki pliku biletu.

### Unix Keyring

Alternatywnie, biletÃ³w CCACHE moÅ¼na przechowywaÄ‡ w keyringu Linux, co daje wiÄ™kszÄ… kontrolÄ™ nad zarzÄ…dzaniem biletami. Zakres przechowywania biletÃ³w jest rÃ³Å¼ny (**`KEYRING:nazwa`**, **`KEYRING:proces:nazwa`**, **`KEYRING:wÄ…tek:nazwa`**, **`KEYRING:sesja:nazwa`**, **`KEYRING:trwaÅ‚y:uidnumber`**), a **`klist`** jest w stanie analizowaÄ‡ te informacje dla uÅ¼ytkownika. Jednak ponowne uÅ¼ycie biletu CCACHE z keyringu Unix moÅ¼e stanowiÄ‡ wyzwanie, a dostÄ™pne sÄ… narzÄ™dzia takie jak **Tickey** do wyodrÄ™bniania biletÃ³w Kerberos.

### Keytab

Pliki keytab zawierajÄ…ce podmioty Kerberos i zaszyfrowane klucze sÄ… kluczowe do uzyskiwania waÅ¼nych biletÃ³w TGT bez koniecznoÅ›ci podawania hasÅ‚a podmiotu. Parsowanie i ponowne uÅ¼ycie poÅ›wiadczeÅ„ z plikÃ³w keytab moÅ¼na Å‚atwo wykonaÄ‡ za pomocÄ… narzÄ™dzi takich jak **`klist`** i skryptÃ³w, na przykÅ‚ad **KeytabParser**.

### Cheatsheet

WiÄ™cej informacji na temat korzystania z biletÃ³w w systemie Linux znajdziesz pod poniÅ¼szym linkiem:

{% content-ref url="privilege-escalation/linux-active-directory.md" %}
[linux-active-directory.md](privilege-escalation/linux-active-directory.md)
{% endcontent-ref %}

## Wyliczanie

{% hint style="warning" %}
MoÅ¼esz przeprowadziÄ‡ **wyliczanie** za pomocÄ… narzÄ™dzi **ldap** i innych **binarnych**, lub **Å‚Ä…czÄ…c siÄ™ z stronÄ… internetowÄ… na porcie 443 serwera FreeIPA**.
{% endhint %}

### Hosty, UÅ¼ytkownicy i Grupy <a href="#4b3b" id="4b3b"></a>

MoÅ¼liwe jest tworzenie **hostÃ³w**, **uÅ¼ytkownikÃ³w** i **grup**. Hosty i uÅ¼ytkownicy sÄ… sortowani do kontenerÃ³w o nazwie "**Grupy HostÃ³w**" i "**Grupy UÅ¼ytkownikÃ³w**" odpowiednio. SÄ… one podobne do **Jednostek Organizacyjnych** (OU).

DomyÅ›lnie w FreeIPA serwer LDAP umoÅ¼liwia **anonimowe wiÄ…zanie**, a duÅ¼a iloÅ›Ä‡ danych jest wyliczalna **bez uwierzytelnienia**. MoÅ¼na to wyliczyÄ‡ wszystkie dostÄ™pne dane bez uwierzytelnienia:
```
ldapsearch -x
```
Aby uzyskaÄ‡ **wiÄ™cej informacji**, musisz uÅ¼yÄ‡ **uwierzytelnionej** sesji (sprawdÅº sekcjÄ™ uwierzytelniania, aby dowiedzieÄ‡ siÄ™, jak przygotowaÄ‡ uwierzytelnionÄ… sesjÄ™).
```bash
# Get all users of domain
ldapsearch -Y gssapi -b "cn=users,cn=compat,dc=domain_name,dc=local"

# Get users groups
ldapsearch -Y gssapi -b "cn=groups,cn=accounts,dc=domain_name,dc=local"

# Get all the hosts
ldapsearch -Y gssapi -b "cn=computers,cn=accounts,dc=domain_name,dc=local"

# Get hosts groups
ldapsearch -Y gssapi -b "cn=hostgroups,cn=accounts,dc=domain_name,dc=local"
```
Z poÅ‚Ä…czonego z domenÄ… komputera bÄ™dziesz mÃ³gÅ‚ uÅ¼yÄ‡ **zainstalowanych binariÃ³w** do wyliczenia domeny:
```bash
ipa user-find
ipa usergroup-find
ipa host-find
ipa host-group-find

-------------------

ipa user-show <username> --all
ipa usergroup-show <user group> --all
ipa host-find <host> --all
ipa hostgroup-show <host group> --all
```
{% hint style="info" %}
UÅ¼ytkownik **admin** w **FreeIPA** jest odpowiednikiem **administratorÃ³w domeny** w **AD**.
{% endhint %}

### SkrÃ³ty <a href="#482b" id="482b"></a>

UÅ¼ytkownik **root** z serwera **IPA** ma dostÄ™p do **skrÃ³tÃ³w** haseÅ‚.

* SkrÃ³t hasÅ‚a uÅ¼ytkownika jest przechowywany jako **base64** w atrybucie "**userPassword**". Ten skrÃ³t moÅ¼e byÄ‡ **SSHA512** (w starszych wersjach FreeIPA) lub **PBKDF2\_SHA256**.
* **Nthash** hasÅ‚a przechowywany jest jako **base64** w "ipaNTHash", jeÅ›li system ma **integracjÄ™** z **AD**.

Aby zÅ‚amaÄ‡ te skrÃ³ty:

â€¢ JeÅ›li FreeIPA jest zintegrowane z AD, **ipaNTHash** jest Å‚atwy do zÅ‚amania: NaleÅ¼y **zdekodowaÄ‡** **base64** -> przekodowaÄ‡ go jako **ASCII** hex -> John The Ripper lub **hashcat** mogÄ… pomÃ³c w szybkim zÅ‚amaniu go

â€¢ JeÅ›li uÅ¼ywana jest starsza wersja FreeIPA, uÅ¼ywany jest **SSHA512**: NaleÅ¼y zdekodowaÄ‡ **base64** -> znaleÅºÄ‡ skrÃ³t **SSHA512** -> John The Ripper lub **hashcat** mogÄ… pomÃ³c w zÅ‚amaniu go

â€¢ JeÅ›li uÅ¼ywana jest nowa wersja FreeIPA, uÅ¼ywany jest **PBKDF2\_SHA256**: NaleÅ¼y zdekodowaÄ‡ **base64** -> znaleÅºÄ‡ **PBKDF2\_SHA256** -> jego **dÅ‚ugoÅ›Ä‡** wynosi 256 bajtÃ³w. John moÅ¼e pracowaÄ‡ z 256 bitami (32 bajty) -> SHA-265 uÅ¼ywane jako funkcja pseudolosowa, rozmiar bloku wynosi 32 bajty -> moÅ¼na uÅ¼yÄ‡ tylko pierwszych 256 bitÃ³w naszego skrÃ³tu PBKDF2\_SHA256 -> John The Ripper lub hashcat mogÄ… pomÃ³c w zÅ‚amaniu go

<figure><img src="../.gitbook/assets/image (33).png" alt=""><figcaption></figcaption></figure>

Aby wyodrÄ™bniÄ‡ skrÃ³ty, musisz byÄ‡ **rootem na serwerze FreeIPA**, tam moÅ¼esz uÅ¼yÄ‡ narzÄ™dzia **`dbscan`** do ich wyodrÄ™bnienia:

<figure><img src="../.gitbook/assets/image (196).png" alt=""><figcaption></figcaption></figure>

### ReguÅ‚y HBAC <a href="#482b" id="482b"></a>

SÄ… to reguÅ‚y, ktÃ³re przyznajÄ… okreÅ›lone uprawnienia uÅ¼ytkownikom lub hostom w odniesieniu do zasobÃ³w (hostÃ³w, usÅ‚ug, grup usÅ‚ug...).
```bash
# Enumerate using ldap
ldapsearch -Y gssapi -b "cn=hbac,dc=domain_name,dc=local"
# Using ipa
ipa hbacrule-find
# Show info of rule
ipa hbacrule-show <hbacrule> --all
```
#### ReguÅ‚y Sudo

FreeIPA umoÅ¼liwia scentralizowanÄ… kontrolÄ™ nad uprawnieniami **sudo** za pomocÄ… reguÅ‚ sudo. Te reguÅ‚y pozwalajÄ… lub ograniczajÄ… wykonywanie poleceÅ„ z sudo na hostach w domenie. AtakujÄ…cy potencjalnie mÃ³gÅ‚by zidentyfikowaÄ‡ odpowiednie hosty, uÅ¼ytkownikÃ³w i dozwolone polecenia, analizujÄ…c te zestawy reguÅ‚.
```bash
# Enumerate using ldap
ldapsearch -Y gssapi -b "cn=sudorules,cn=sudo,dc=domain_name,dc=local"
# Using ipa
ipa sudorule-find
# Show info of rule
ipa sudorule-show <sudorule> --all
```
### Kontrola dostÄ™pu oparta na rolach

**Rola** skÅ‚ada siÄ™ z rÃ³Å¼nych **uprawnieÅ„**, z ktÃ³rych kaÅ¼de obejmuje zbiÃ³r **uprawnieÅ„**. Te role mogÄ… byÄ‡ przypisane do uÅ¼ytkownikÃ³w, **grup uÅ¼ytkownikÃ³w**, **hostÃ³w**, grup hostÃ³w i usÅ‚ug. Na przykÅ‚ad, rozwaÅ¼my domyÅ›lnÄ… rolÄ™ "Administratora uÅ¼ytkownika" w FreeIPA, aby zobrazowaÄ‡ tÄ™ strukturÄ™.

Rola `Administratora uÅ¼ytkownika` ma nastÄ™pujÄ…ce uprawnienia:

* **Administratorzy uÅ¼ytkownikÃ³w**
* **Administratorzy grup**
* **Administratorzy etapu uÅ¼ytkownikÃ³w**

Za pomocÄ… poniÅ¼szych poleceÅ„ moÅ¼na wyliczyÄ‡ role, uprawnienia i uprawnienia:
```bash
# Using ldap
ldapsearch -Y gssapi -b "cn=roles,cn=accounts,dc=westeros,dc=local"
# Using ipa binary
ipa role-find
ipa role-show <role> --all
ipa privilege-find
ipa privilege-show <privilege> --all
ipa permission-find
ipa permission-show <permission> --all
```
### PrzykÅ‚ad scenariusza ataku

W [https://posts.specterops.io/attacking-freeipa-part-iii-finding-a-path-677405b5b95e](https://posts.specterops.io/attacking-freeipa-part-iii-finding-a-path-677405b5b95e) znajdziesz prosty przykÅ‚ad, jak wykorzystaÄ‡ pewne uprawnienia do skompromitowania domeny.

### Linikatz/LinikatzV2

* [https://github.com/Orange-Cyberdefense/LinikatzV2](https://github.com/Orange-Cyberdefense/LinikatzV2)
* [https://github.com/CiscoCXSecurity/linikatz](https://github.com/CiscoCXSecurity/linikatz)

## PodwyÅ¼szanie uprawnieÅ„

### ~~Tworzenie uÅ¼ytkownika root~~

{% hint style="warning" %}
JeÅ›li moÅ¼esz **utworzyÄ‡ nowego uÅ¼ytkownika o nazwie `root`**, moÅ¼esz go podszyÄ‡ i bÄ™dziesz mÃ³gÅ‚ **SSH do dowolnej maszyny jako root**.

**TO ZOSTAÅO NAPRAWIONE.**
{% endhint %}

MoÅ¼esz sprawdziÄ‡ szczegÃ³Å‚owe wyjaÅ›nienie pod adresem [https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b](https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b)

## OdwoÅ‚ania
* [https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b](https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b)
* [https://posts.specterops.io/attacking-freeipa-part-i-authentication-77e73d837d6a](https://posts.specterops.io/attacking-freeipa-part-i-authentication-77e73d837d6a)
* [https://posts.specterops.io/attacking-freeipa-part-ii-enumeration-ad27224371e1](https://posts.specterops.io/attacking-freeipa-part-ii-enumeration-ad27224371e1)
* [https://www.youtube.com/watch?v=9dOu-7BTwPQ](https://www.youtube.com/watch?v=9dOu-7BTwPQ)

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
