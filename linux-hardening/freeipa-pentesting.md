# FreeIPA Pentesting

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **Bize katÄ±lÄ±n** ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya **Twitter'da** **bizi takip edin** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸarak** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

## Temel Bilgiler

FreeIPA, esasen **Unix** ortamlarÄ± iÃ§in Microsoft Windows **Active Directory**'ye aÃ§Ä±k kaynaklÄ± bir **alternatif**dir. Active Directory'ye benzer bir yÃ¶netim iÃ§in tam bir **LDAP dizini** ile MIT **Kerberos** Anahtar DaÄŸÄ±tÄ±m Merkezi'ni birleÅŸtirir. CA ve RA sertifika yÃ¶netimi iÃ§in Dogtag **Sertifika Sistemi**'ni kullanarak, akÄ±llÄ± kartlar da dahil olmak Ã¼zere **Ã§ok faktÃ¶rlÃ¼** kimlik doÄŸrulamayÄ± destekler. Unix kimlik doÄŸrulama sÃ¼reÃ§leri iÃ§in SSSD entegre edilmiÅŸtir.

## Parmak Ä°zi

### Dosyalar ve Ortam DeÄŸiÅŸkenleri

* `/etc/krb5.conf` dosyasÄ±, alan kaydÄ± iÃ§in gerekli Kerberos istemci bilgilerini saklar. Bu, KDC'lerin ve yÃ¶netici sunucularÄ±nÄ±n konumlarÄ±nÄ±, varsayÄ±lan ayarlarÄ± ve eÅŸlemeleri iÃ§erir.
* IPA istemcileri ve sunucularÄ± iÃ§in sistem genelindeki varsayÄ±lan ayarlar `/etc/ipa/default.conf` dosyasÄ±nda ayarlanÄ±r.
* Alan iÃ§indeki ana bilgisayarlarÄ±n kimlik doÄŸrulama sÃ¼reÃ§leri iÃ§in `/etc/krb5.keytab` konumunda bir `krb5.keytab` dosyasÄ±na sahip olmasÄ± gerekir.
* Kerberos kimlik doÄŸrulamasÄ±yla ilgili belirli dosyalara ve ayarlara iÅŸaret eden Ã§eÅŸitli ortam deÄŸiÅŸkenleri (`KRB5CCNAME`, `KRB5_KTNAME`, `KRB5_CONFIG`, `KRB5_KDC_PROFILE`, `KRB5RCACHETYPE`, `KRB5RCACHEDIR`, `KRB5_TRACE`, `KRB5_CLIENT_KTNAME`, `KPROP_PORT`) kullanÄ±lÄ±r.

### Ä°kili Dosyalar

`ipa`, `kdestroy`, `kinit`, `klist`, `kpasswd`, `ksu`, `kswitch` ve `kvno` gibi araÃ§lar, FreeIPA alanlarÄ±nÄ± yÃ¶netmek, Kerberos biletlerini iÅŸlemek, ÅŸifreleri deÄŸiÅŸtirmek ve hizmet biletleri almak gibi iÅŸlevler iÃ§in merkezi Ã¶neme sahiptir.

### AÄŸ

Tipik bir FreeIPA sunucu kurulumu gÃ¶steren bir illÃ¼strasyon saÄŸlanmÄ±ÅŸtÄ±r.

## Kimlik DoÄŸrulama

FreeIPA'daki kimlik doÄŸrulama, **Kerberos**'u kullanarak **Active Directory**'deki gibi Ã§alÄ±ÅŸÄ±r. Alan kaynaklarÄ±na eriÅŸim, FreeIPA alan yapÄ±landÄ±rmasÄ±na baÄŸlÄ± olarak Ã§eÅŸitli konumlarda saklanabilen geÃ§erli bir Kerberos biletini gerektirir.

### **CCACHE Bilet DosyalarÄ±**

CCACHE dosyalarÄ±, genellikle **`/tmp`** konumunda **600** izinleriyle saklanÄ±r ve Kerberos kimlik bilgilerini saklamak iÃ§in ikili formatlardÄ±r; bu, kullanÄ±cÄ±larÄ±n dÃ¼z metin ÅŸifreleri olmadan kimlik doÄŸrulama yapmalarÄ±nÄ± saÄŸlar. Bir CCACHE biletini ayrÄ±ÅŸtÄ±rmak iÃ§in `klist` komutu kullanÄ±labilir ve geÃ§erli bir CCACHE Biletini yeniden kullanmak, `KRB5CCNAME`'i bilet dosyasÄ±nÄ±n yoluna dÄ±ÅŸa aktarmayÄ± iÃ§erir.

### **Unix AnahtarÄ±**

Alternatif olarak, CCACHE Biletleri Linux anahtarÄ±nda saklanabilir ve bilet yÃ¶netimi Ã¼zerinde daha fazla kontrol saÄŸlar. Bilet saklama kapsamÄ± deÄŸiÅŸir (`KEYRING:name`, `KEYRING:process:name`, `KEYRING:thread:name`, `KEYRING:session:name`, `KEYRING:persistent:uidnumber`), `klist` bu bilgiyi kullanÄ±cÄ± iÃ§in ayrÄ±ÅŸtÄ±rabilir. Ancak, Unix anahtarÄ±ndan bir CCACHE Biletini yeniden kullanmak zorluklar Ã§Ä±karabilir; Kerberos biletlerini Ã§Ä±karmak iÃ§in **Tickey** gibi araÃ§lar mevcuttur.

### Keytab

Kerberos ilkelerini ve ÅŸifrelenmiÅŸ anahtarlarÄ± iÃ§eren keytab dosyalarÄ±, geÃ§erli bilet verme biletleri (TGT) almak iÃ§in kritik Ã¶neme sahiptir ve ilkenin ÅŸifresini gerektirmez. Keytab dosyalarÄ±ndan kimlik bilgilerini ayrÄ±ÅŸtÄ±rmak ve yeniden kullanmak, `klist` gibi yardÄ±mcÄ± programlar ve **KeytabParser** gibi betikler ile kolayca gerÃ§ekleÅŸtirilebilir.

### HÄ±zlÄ± Referans

Linux'ta biletleri nasÄ±l kullanacaÄŸÄ±nÄ±z hakkÄ±nda daha fazla bilgi bulabilirsiniz:

{% content-ref url="privilege-escalation/linux-active-directory.md" %}
[linux-active-directory.md](privilege-escalation/linux-active-directory.md)
{% endcontent-ref %}

## SayÄ±m

{% hint style="warning" %}
**sayÄ±m** iÅŸlemini **ldap** ve diÄŸer **ikili** araÃ§lar aracÄ±lÄ±ÄŸÄ±yla gerÃ§ekleÅŸtirebilir veya **FreeIPA sunucusunun 443 numaralÄ± portundaki web sayfasÄ±na baÄŸlanarak** yapabilirsiniz.
{% endhint %}

### Ana Bilgisayarlar, KullanÄ±cÄ±lar ve Gruplar <a href="#id-4b3b" id="id-4b3b"></a>

**ana bilgisayarlar**, **kullanÄ±cÄ±lar** ve **gruplar** oluÅŸturmak mÃ¼mkÃ¼ndÃ¼r. Ana bilgisayarlar ve kullanÄ±cÄ±lar, sÄ±rasÄ±yla â€œ**Ana Bilgisayar GruplarÄ±**â€ ve â€œ**KullanÄ±cÄ± GruplarÄ±**â€ olarak adlandÄ±rÄ±lan kapsayÄ±cÄ±lara ayrÄ±lÄ±r. Bunlar, **Organizasyonel Birimler** (OU) ile benzerdir.

FreeIPA'da varsayÄ±lan olarak, LDAP sunucusu **anonim baÄŸlamalara** izin verir ve bÃ¼yÃ¼k bir veri yelpazesi **kimlik doÄŸrulamasÄ±z** olarak sayÄ±labilir. Bu, kimlik doÄŸrulamasÄ±z olarak mevcut olan tÃ¼m verileri sayabilir:
```
ldapsearch -x
```
Daha **fazla bilgi** almak iÃ§in **kimlik doÄŸrulamalÄ±** bir oturum kullanmanÄ±z gerekir (kimlik doÄŸrulama bÃ¶lÃ¼mÃ¼nÃ¼ kontrol edin, kimlik doÄŸrulamalÄ± bir oturumun nasÄ±l hazÄ±rlanacaÄŸÄ±nÄ± Ã¶ÄŸrenin).
```bash
# Get all users of domain
ldapsearch -Y gssapi -b "cn=users,cn=compat,dc=domain_name,dc=local"

# Get users groups
ldapsearch -Y gssapi -b "cn=groups,cn=accounts,dc=domain_name,dc=local"

# Get all the hosts
ldapsearch -Y gssapi -b "cn=computers,cn=accounts,dc=domain_name,dc=local"

# Get hosts groups
ldapsearch -Y gssapi -b "cn=hostgroups,cn=accounts,dc=domain_name,dc=local"
```
Domain'a katÄ±lmÄ±ÅŸ bir makineden **kurulu ikilileri** kullanarak alanÄ± listeleyebilirsiniz:
```bash
ipa user-find
ipa usergroup-find
ipa host-find
ipa host-group-find

-------------------

ipa user-show <username> --all
ipa usergroup-show <user group> --all
ipa host-find <host> --all
ipa hostgroup-show <host group> --all
```
{% hint style="info" %}
**FreeIPA**'nÄ±n **admin** kullanÄ±cÄ±sÄ±, **AD**'den **domain admin**'lere eÅŸdeÄŸerdir.
{% endhint %}

### Hashes <a href="#id-482b" id="id-482b"></a>

**IPA sunucusundaki** **root** kullanÄ±cÄ±sÄ±, ÅŸifre **hash'lerine** eriÅŸime sahiptir.

* Bir kullanÄ±cÄ±nÄ±n ÅŸifre hash'i, â€œ**userPassword**â€ **Ã¶zelliÄŸi** iÃ§inde **base64** olarak saklanÄ±r. Bu hash **SSHA512** (eski FreeIPA sÃ¼rÃ¼mleri) veya **PBKDF2\_SHA256** olabilir.
* Sistem **AD** ile **entegrasyon** iÃ§indeyse, ÅŸifre **ipaNTHash** olarak **base64** iÃ§inde saklanÄ±r.

Bu hash'leri kÄ±rmak iÃ§in:

â€¢ EÄŸer freeIPA AD ile entegre ise, **ipaNTHash**'i kÄ±rmak kolaydÄ±r: **base64**'Ã¼ **decode** etmelisiniz -> **ASCII** hex olarak yeniden kodlayÄ±n -> John The Ripper veya **hashcat** hÄ±zlÄ± bir ÅŸekilde kÄ±rmanÄ±za yardÄ±mcÄ± olabilir.

â€¢ Eski bir FreeIPA sÃ¼rÃ¼mÃ¼ kullanÄ±lÄ±yorsa, **SSHA512** kullanÄ±lÄ±r: **base64**'Ã¼ decode etmelisiniz -> SSHA512 **hash**'ini bulmalÄ±sÄ±nÄ±z -> John The Ripper veya **hashcat** kÄ±rmanÄ±za yardÄ±mcÄ± olabilir.

â€¢ Yeni bir FreeIPA sÃ¼rÃ¼mÃ¼ kullanÄ±lÄ±yorsa, **PBKDF2\_SHA256** kullanÄ±lÄ±r: **base64**'Ã¼ decode etmelisiniz -> PBKDF2\_SHA256'yÄ± bulmalÄ±sÄ±nÄ±z -> **uzunluÄŸu** 256 byte'dÄ±r. John 256 bit (32 byte) ile Ã§alÄ±ÅŸabilir -> SHA-265, psÃ¶do-rastgele fonksiyon olarak kullanÄ±lÄ±r, blok boyutu 32 byte'dÄ±r -> PBKDF2\_SHA256 hash'imizin yalnÄ±zca ilk 256 bit'ini kullanabilirsiniz -> John The Ripper veya hashcat kÄ±rmanÄ±za yardÄ±mcÄ± olabilir.

<figure><img src="../.gitbook/assets/image (655).png" alt=""><figcaption></figcaption></figure>

Hash'leri Ã§Ä±karmak iÃ§in **FreeIPA sunucusunda root** olmanÄ±z gerekir, burada **`dbscan`** aracÄ±nÄ± kullanarak bunlarÄ± Ã§Ä±karabilirsiniz:

<figure><img src="../.gitbook/assets/image (293).png" alt=""><figcaption></figcaption></figure>

### HBAC-Rules <a href="#id-482b" id="id-482b"></a>

KullanÄ±cÄ±lara veya hostlara kaynaklar (hostlar, hizmetler, hizmet gruplarÄ±...) Ã¼zerinde belirli izinler veren kurallardÄ±r.
```bash
# Enumerate using ldap
ldapsearch -Y gssapi -b "cn=hbac,dc=domain_name,dc=local"
# Using ipa
ipa hbacrule-find
# Show info of rule
ipa hbacrule-show <hbacrule> --all
```
#### Sudo-Rules

FreeIPA, **sudo izinleri** Ã¼zerinde merkezi kontrol saÄŸlar. Bu kurallar, alan iÃ§indeki hostlarda sudo ile komutlarÄ±n yÃ¼rÃ¼tÃ¼lmesini saÄŸlar veya sÄ±nÄ±rlar. Bir saldÄ±rgan, bu kurallarÄ± inceleyerek geÃ§erli hostlarÄ±, kullanÄ±cÄ±larÄ± ve izin verilen komutlarÄ± belirleyebilir.
```bash
# Enumerate using ldap
ldapsearch -Y gssapi -b "cn=sudorules,cn=sudo,dc=domain_name,dc=local"
# Using ipa
ipa sudorule-find
# Show info of rule
ipa sudorule-show <sudorule> --all
```
### Rol TabanlÄ± EriÅŸim KontrolÃ¼

Bir **rol**, Ã§eÅŸitli **ayrÄ±calÄ±klardan** oluÅŸur; her biri bir dizi **izin** iÃ§erir. Bu roller KullanÄ±cÄ±lara, KullanÄ±cÄ± **GruplarÄ±na**, **Ana Bilgilere**, Ana Bilgi GruplarÄ±na ve Hizmetlere atanabilir. Ã–rneÄŸin, bu yapÄ±yÄ± Ã¶rneklendirmek iÃ§in FreeIPA'daki varsayÄ±lan â€œKullanÄ±cÄ± YÃ¶neticisiâ€ rolÃ¼nÃ¼ ele alalÄ±m.

`KullanÄ±cÄ± YÃ¶neticisi` rolÃ¼ bu ayrÄ±calÄ±klara sahiptir:

* **KullanÄ±cÄ± YÃ¶neticileri**
* **Grup YÃ¶neticileri**
* **AÅŸama KullanÄ±cÄ± YÃ¶neticileri**

AÅŸaÄŸÄ±daki komutlarla roller, ayrÄ±calÄ±klar ve izinler listelenebilir:
```bash
# Using ldap
ldapsearch -Y gssapi -b "cn=roles,cn=accounts,dc=westeros,dc=local"
# Using ipa binary
ipa role-find
ipa role-show <role> --all
ipa privilege-find
ipa privilege-show <privilege> --all
ipa permission-find
ipa permission-show <permission> --all
```
### SaldÄ±rÄ± Senaryosu Ã–rneÄŸi

[https://posts.specterops.io/attacking-freeipa-part-iii-finding-a-path-677405b5b95e](https://posts.specterops.io/attacking-freeipa-part-iii-finding-a-path-677405b5b95e) adresinde, alanÄ± tehlikeye atmak iÃ§in bazÄ± izinlerin nasÄ±l kÃ¶tÃ¼ye kullanÄ±lacaÄŸÄ±na dair basit bir Ã¶rnek bulabilirsiniz.

### Linikatz/LinikatzV2

* [https://github.com/Orange-Cyberdefense/LinikatzV2](https://github.com/Orange-Cyberdefense/LinikatzV2)
* [https://github.com/CiscoCXSecurity/linikatz](https://github.com/CiscoCXSecurity/linikatz)

## Privesc

### ~~root kullanÄ±cÄ± oluÅŸturma~~

{% hint style="warning" %}
EÄŸer **`root` adÄ±nda yeni bir kullanÄ±cÄ± oluÅŸturabiliyorsanÄ±z**, onu taklit edebilir ve **herhangi bir makineye root olarak SSH ile baÄŸlanabilirsiniz.**

**BU DÃœZENLENMÄ°ÅTÄ°R.**
{% endhint %}

DetaylÄ± bir aÃ§Ä±klamayÄ± [https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b](https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b) adresinde kontrol edebilirsiniz.

## Referanslar

* [https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b](https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b)
* [https://posts.specterops.io/attacking-freeipa-part-i-authentication-77e73d837d6a](https://posts.specterops.io/attacking-freeipa-part-i-authentication-77e73d837d6a)
* [https://posts.specterops.io/attacking-freeipa-part-ii-enumeration-ad27224371e1](https://posts.specterops.io/attacking-freeipa-part-ii-enumeration-ad27224371e1)
* [https://www.youtube.com/watch?v=9dOu-7BTwPQ](https://www.youtube.com/watch?v=9dOu-7BTwPQ)

{% hint style="success" %}
AWS Hacking Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
