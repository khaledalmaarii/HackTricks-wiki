# FreeIPA Pentesting

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

FreeIPA je open-source **alternativa** za Microsoft Windows **Active Directory**, uglavnom za **Unix** okruÅ¾enja. Kombinuje kompletnu **LDAP direktoriju** sa MIT **Kerberos** sistemom za distribuciju kljuÄeva za upravljanje sliÄnim Active Directory. Koristi Dogtag **Sistem sertifikata** za upravljanje CA i RA sertifikatima, podrÅ¾ava **multi-factor** autentifikaciju, ukljuÄujuÄ‡i pametne kartice. SSSD je integrisan za Unix procese autentifikacije.

## Fingerprints

### Files & Environment Variables

* Datoteka na `/etc/krb5.conf` je mesto gde se Äuvaju informacije o Kerberos klijentu, neophodne za upis u domen. Ovo ukljuÄuje lokacije KDC-a i admin servera, podrazumevane postavke i mape.
* Podrazumevane postavke za IPA klijente i servere su postavljene u datoteci koja se nalazi na `/etc/ipa/default.conf`.
* Hostovi unutar domena moraju imati `krb5.keytab` datoteku na `/etc/krb5.keytab` za procese autentifikacije.
* RazliÄite promenljive okruÅ¾enja (`KRB5CCNAME`, `KRB5_KTNAME`, `KRB5_CONFIG`, `KRB5_KDC_PROFILE`, `KRB5RCACHETYPE`, `KRB5RCACHEDIR`, `KRB5_TRACE`, `KRB5_CLIENT_KTNAME`, `KPROP_PORT`) se koriste za upuÄ‡ivanje na specifiÄne datoteke i postavke relevantne za Kerberos autentifikaciju.

### Binaries

Alati kao Å¡to su `ipa`, `kdestroy`, `kinit`, `klist`, `kpasswd`, `ksu`, `kswitch`, i `kvno` su centralni za upravljanje FreeIPA domenima, rukovanje Kerberos tiketima, menjanje lozinki i dobijanje servisnih tiketa, meÄ‘u ostalim funkcionalnostima.

### Network

Ilustracija je pruÅ¾ena da prikaÅ¾e tipiÄnu FreeIPA server konfiguraciju.

## Authentication

Autentifikacija u FreeIPA, koristeÄ‡i **Kerberos**, odraÅ¾ava onu u **Active Directory**. Pristup resursima domena zahteva vaÅ¾eÄ‡i Kerberos tiket, koji moÅ¾e biti smeÅ¡ten na razliÄitim mestima u zavisnosti od konfiguracije FreeIPA domena.

### **CCACHE Ticket Files**

CCACHE datoteke, obiÄno smeÅ¡tene u **`/tmp`** sa **600** dozvolama, su binarni formati za Äuvanje Kerberos kredencijala, vaÅ¾ni za autentifikaciju bez korisniÄke lozinke u obiÄnom tekstu zbog njihove prenosivosti. Parsiranje CCACHE tiketa moÅ¾e se izvrÅ¡iti koriÅ¡Ä‡enjem `klist` komande, a ponovna upotreba vaÅ¾eÄ‡eg CCACHE tiketa ukljuÄuje izvoz `KRB5CCNAME` na putanju datoteke tiketa.

### **Unix Keyring**

Alternativno, CCACHE tiketi mogu biti smeÅ¡teni u Linux keyring, nudeÄ‡i veÄ‡u kontrolu nad upravljanjem tiketima. Opseg skladiÅ¡tenja tiketa varira (`KEYRING:name`, `KEYRING:process:name`, `KEYRING:thread:name`, `KEYRING:session:name`, `KEYRING:persistent:uidnumber`), pri Äemu `klist` moÅ¾e parsirati ove informacije za korisnika. MeÄ‘utim, ponovna upotreba CCACHE tiketa iz Unix keyring-a moÅ¾e predstavljati izazove, a alati poput **Tickey** su dostupni za ekstrakciju Kerberos tiketa.

### Keytab

Keytab datoteke, koje sadrÅ¾e Kerberos principe i enkriptovane kljuÄeve, su kljuÄne za dobijanje vaÅ¾eÄ‡ih tiketa za dodelu (TGT) bez potrebe za lozinkom principa. Parsiranje i ponovna upotreba kredencijala iz keytab datoteka moÅ¾e se lako izvrÅ¡iti pomoÄ‡u alata kao Å¡to su `klist` i skripti kao Å¡to je **KeytabParser**.

### Cheatsheet

MoÅ¾ete pronaÄ‡i viÅ¡e informacija o tome kako koristiti tikete u linuxu na sledeÄ‡em linku:

{% content-ref url="privilege-escalation/linux-active-directory.md" %}
[linux-active-directory.md](privilege-escalation/linux-active-directory.md)
{% endcontent-ref %}

## Enumeration

{% hint style="warning" %}
MoÅ¾ete izvrÅ¡iti **enumeraciju** putem **ldap** i drugih **binarnih** alata, ili **povezivanjem na veb stranicu na portu 443 FreeIPA servera**.
{% endhint %}

### Hosts, Users, and Groups <a href="#id-4b3b" id="id-4b3b"></a>

MoguÄ‡e je kreirati **hostove**, **korisnike** i **grupe**. Hostovi i korisnici su rasporeÄ‘eni u kontejnere nazvane â€œ**Host Groups**â€ i â€œ**User Groups**â€ respektivno. Ovi su sliÄni **Organizacijskim jedinicama** (OU).

Podrazumevano u FreeIPA, LDAP server omoguÄ‡ava **anonimne veze**, a veliki deo podataka je enumerabilan **neautentifikovano**. Ovo moÅ¾e enumerisati sve dostupne podatke neautentifikovano:
```
ldapsearch -x
```
Da biste dobili **viÅ¡e informacija**, potrebno je da koristite **autentifikovanu** sesiju (proverite odeljak o autentifikaciji da biste saznali kako da pripremite autentifikovanu sesiju).
```bash
# Get all users of domain
ldapsearch -Y gssapi -b "cn=users,cn=compat,dc=domain_name,dc=local"

# Get users groups
ldapsearch -Y gssapi -b "cn=groups,cn=accounts,dc=domain_name,dc=local"

# Get all the hosts
ldapsearch -Y gssapi -b "cn=computers,cn=accounts,dc=domain_name,dc=local"

# Get hosts groups
ldapsearch -Y gssapi -b "cn=hostgroups,cn=accounts,dc=domain_name,dc=local"
```
Sa maÅ¡ine koja je pridruÅ¾ena domenu moÄ‡i Ä‡ete da koristite **instalirane binarne datoteke** za enumeraciju domena:
```bash
ipa user-find
ipa usergroup-find
ipa host-find
ipa host-group-find

-------------------

ipa user-show <username> --all
ipa usergroup-show <user group> --all
ipa host-find <host> --all
ipa hostgroup-show <host group> --all
```
{% hint style="info" %}
Korisnik **admin** u **FreeIPA** je ekvivalent **domenama admina** iz **AD**.
{% endhint %}

### Hashes <a href="#id-482b" id="id-482b"></a>

Korisnik **root** sa **IPA servera** ima pristup lozinkama **hash**.

* Hash lozinke korisnika se Äuva kao **base64** u atributu â€œ**userPassword**â€. Ovaj hash moÅ¾e biti **SSHA512** (stare verzije FreeIPA) ili **PBKDF2\_SHA256**.
* **Nthash** lozinke se Äuva kao **base64** u â€œ**ipaNTHash**â€ ako sistem ima **integraciju** sa **AD**.

Da biste probili ove hash:

â€¢ Ako je freeIPA integrisan sa AD, **ipaNTHash** je lako probiti: Trebalo bi da **dekodirate** **base64** -> ponovo kodirate kao **ASCII** hex -> John The Ripper ili **hashcat** vam mogu pomoÄ‡i da ga brzo probijete

â€¢ Ako se koristi stara verzija FreeIPA, onda se koristi **SSHA512**: Trebalo bi da dekodirate **base64** -> pronaÄ‘ete SSHA512 **hash** -> John The Ripper ili **hashcat** vam mogu pomoÄ‡i da ga probijete

â€¢ Ako se koristi nova verzija FreeIPA, onda se koristi **PBKDF2\_SHA256**: Trebalo bi da dekodirate **base64** -> pronaÄ‘ete PBKDF2\_SHA256 -> njegova **duÅ¾ina** je 256 bajta. John moÅ¾e raditi sa 256 bita (32 bajta) -> SHA-265 se koristi kao pseudo-random funkcija, veliÄina bloka je 32 bajta -> moÅ¾ete koristiti samo prvih 256 bita naÅ¡eg PBKDF2\_SHA256 hash -> John The Ripper ili hashcat vam mogu pomoÄ‡i da ga probijete

<figure><img src="../.gitbook/assets/image (655).png" alt=""><figcaption></figcaption></figure>

Da biste izvukli hash, morate biti **root na FreeIPA serveru**, tamo moÅ¾ete koristiti alat **`dbscan`** da ih izvuÄete:

<figure><img src="../.gitbook/assets/image (293).png" alt=""><figcaption></figcaption></figure>

### HBAC-Rules <a href="#id-482b" id="id-482b"></a>

To su pravila koja dodeljuju specifiÄne dozvole korisnicima ili hostovima nad resursima (hostovi, usluge, grupe usluga...)
```bash
# Enumerate using ldap
ldapsearch -Y gssapi -b "cn=hbac,dc=domain_name,dc=local"
# Using ipa
ipa hbacrule-find
# Show info of rule
ipa hbacrule-show <hbacrule> --all
```
#### Sudo-Rules

FreeIPA omoguÄ‡ava centralizovanu kontrolu nad **sudo dozvolama** putem sudo pravila. Ova pravila omoguÄ‡avaju ili ograniÄavaju izvrÅ¡avanje komandi sa sudo na hostovima unutar domena. NapadaÄ bi potencijalno mogao da identifikuje primenljive hostove, korisnike i dozvoljene komande ispitujuÄ‡i ove skupove pravila.
```bash
# Enumerate using ldap
ldapsearch -Y gssapi -b "cn=sudorules,cn=sudo,dc=domain_name,dc=local"
# Using ipa
ipa sudorule-find
# Show info of rule
ipa sudorule-show <sudorule> --all
```
### Kontrola pristupa zasnovana na rolama

**Uloga** se sastoji od razliÄitih **privilegija**, od kojih svaka obuhvata skup **dozvola**. Ove uloge mogu biti dodeljene korisnicima, grupama korisnika, **hostovima**, grupama hostova i uslugama. Na primer, uzmite u obzir podrazumevanu ulogu â€œAdministrator korisnikaâ€ u FreeIPA kao primer ove strukture.

Uloga `Administrator korisnika` ima sledeÄ‡e privilegije:

* **Administratori korisnika**
* **Administratori grupa**
* **Administratori korisnika na sceni**

PomoÄ‡u sledeÄ‡ih komandi moguÄ‡e je enumerisati uloge, privilegije i dozvole:
```bash
# Using ldap
ldapsearch -Y gssapi -b "cn=roles,cn=accounts,dc=westeros,dc=local"
# Using ipa binary
ipa role-find
ipa role-show <role> --all
ipa privilege-find
ipa privilege-show <privilege> --all
ipa permission-find
ipa permission-show <permission> --all
```
### Attack Scenario Example

U [https://posts.specterops.io/attacking-freeipa-part-iii-finding-a-path-677405b5b95e](https://posts.specterops.io/attacking-freeipa-part-iii-finding-a-path-677405b5b95e) moÅ¾ete pronaÄ‡i jednostavan primer kako zloupotrebiti neka prava da biste kompromitovali domen.

### Linikatz/LinikatzV2

* [https://github.com/Orange-Cyberdefense/LinikatzV2](https://github.com/Orange-Cyberdefense/LinikatzV2)
* [https://github.com/CiscoCXSecurity/linikatz](https://github.com/CiscoCXSecurity/linikatz)

## Privesc

### ~~kreiranje root korisnika~~

{% hint style="warning" %}
Ako moÅ¾ete **napraviti novog korisnika sa imenom `root`**, moÅ¾ete se pretvarati da ste on i moÄ‡i Ä‡ete da **SSH-ujete na bilo koju maÅ¡inu kao root.**

**OVO JE ISPRAVLJENO.**
{% endhint %}

MoÅ¾ete proveriti detaljno objaÅ¡njenje u [https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b](https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b)

## References

* [https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b](https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b)
* [https://posts.specterops.io/attacking-freeipa-part-i-authentication-77e73d837d6a](https://posts.specterops.io/attacking-freeipa-part-i-authentication-77e73d837d6a)
* [https://posts.specterops.io/attacking-freeipa-part-ii-enumeration-ad27224371e1](https://posts.specterops.io/attacking-freeipa-part-ii-enumeration-ad27224371e1)
* [https://www.youtube.com/watch?v=9dOu-7BTwPQ](https://www.youtube.com/watch?v=9dOu-7BTwPQ)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
