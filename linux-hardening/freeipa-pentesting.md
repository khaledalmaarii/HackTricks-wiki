# FreeIPA Pentesting

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Podstawowe informacje

FreeIPA to otwarte ÅºrÃ³dÅ‚o **alternatywa** dla Microsoft Windows **Active Directory**, gÅ‚Ã³wnie dla Å›rodowisk **Unix**. ÅÄ…czy kompletny **katalog LDAP** z MIT **Kerberos** Key Distribution Center do zarzÄ…dzania podobnego do Active Directory. WykorzystujÄ…c system **Dogtag Certificate System** do zarzÄ…dzania certyfikatami CA i RA, wspiera **uwierzytelnianie wieloskÅ‚adnikowe**, w tym karty inteligentne. SSSD jest zintegrowany z procesami uwierzytelniania Unix.

## Odciski

### Pliki i zmienne Å›rodowiskowe

* Plik w `/etc/krb5.conf` to miejsce, gdzie przechowywane sÄ… informacje klienta Kerberos, niezbÄ™dne do rejestracji w domenie. Obejmuje to lokalizacje KDC i serwerÃ³w administracyjnych, ustawienia domyÅ›lne i mapowania.
* DomyÅ›lne ustawienia dla klientÃ³w i serwerÃ³w IPA sÄ… ustawione w pliku znajdujÄ…cym siÄ™ w `/etc/ipa/default.conf`.
* Hosty w domenie muszÄ… mieÄ‡ plik `krb5.keytab` w `/etc/krb5.keytab` do procesÃ³w uwierzytelniania.
* RÃ³Å¼ne zmienne Å›rodowiskowe (`KRB5CCNAME`, `KRB5_KTNAME`, `KRB5_CONFIG`, `KRB5_KDC_PROFILE`, `KRB5RCACHETYPE`, `KRB5RCACHEDIR`, `KRB5_TRACE`, `KRB5_CLIENT_KTNAME`, `KPROP_PORT`) sÄ… uÅ¼ywane do wskazywania na konkretne pliki i ustawienia zwiÄ…zane z uwierzytelnianiem Kerberos.

### Binaries

NarzÄ™dzia takie jak `ipa`, `kdestroy`, `kinit`, `klist`, `kpasswd`, `ksu`, `kswitch` i `kvno` sÄ… kluczowe do zarzÄ…dzania domenami FreeIPA, obsÅ‚ugi biletÃ³w Kerberos, zmiany haseÅ‚ i uzyskiwania biletÃ³w serwisowych, wÅ›rÃ³d innych funkcji.

### SieÄ‡

Przedstawiono ilustracjÄ™, aby zobrazowaÄ‡ typowÄ… konfiguracjÄ™ serwera FreeIPA.

## Uwierzytelnianie

Uwierzytelnianie w FreeIPA, wykorzystujÄ…ce **Kerberos**, odzwierciedla to w **Active Directory**. DostÄ™p do zasobÃ³w domeny wymaga waÅ¼nego biletu Kerberos, ktÃ³ry moÅ¼e byÄ‡ przechowywany w rÃ³Å¼nych lokalizacjach w zaleÅ¼noÅ›ci od konfiguracji domeny FreeIPA.

### **Pliki biletÃ³w CCACHE**

Pliki CCACHE, zazwyczaj przechowywane w **`/tmp`** z uprawnieniami **600**, sÄ… formatami binarnymi do przechowywania poÅ›wiadczeÅ„ Kerberos, waÅ¼nymi dla uwierzytelniania bez hasÅ‚a w postaci tekstu jawnego uÅ¼ytkownika z powodu ich przenoÅ›noÅ›ci. Analizowanie biletu CCACHE moÅ¼na wykonaÄ‡ za pomocÄ… polecenia `klist`, a ponowne uÅ¼ycie waÅ¼nego biletu CCACHE polega na wyeksportowaniu `KRB5CCNAME` do Å›cieÅ¼ki pliku biletu.

### **Unix Keyring**

Alternatywnie, bilety CCACHE mogÄ… byÄ‡ przechowywane w kluczyku Linux, oferujÄ…c wiÄ™kszÄ… kontrolÄ™ nad zarzÄ…dzaniem biletami. Zakres przechowywania biletÃ³w rÃ³Å¼ni siÄ™ (`KEYRING:name`, `KEYRING:process:name`, `KEYRING:thread:name`, `KEYRING:session:name`, `KEYRING:persistent:uidnumber`), a `klist` jest w stanie analizowaÄ‡ te informacje dla uÅ¼ytkownika. Jednak ponowne uÅ¼ycie biletu CCACHE z kluczyka Unix moÅ¼e stwarzaÄ‡ wyzwania, a narzÄ™dzia takie jak **Tickey** sÄ… dostÄ™pne do ekstrakcji biletÃ³w Kerberos.

### Keytab

Pliki keytab, zawierajÄ…ce zasady Kerberos i zaszyfrowane klucze, sÄ… kluczowe do uzyskania waÅ¼nych biletÃ³w przyznawania biletÃ³w (TGT) bez potrzeby znajomoÅ›ci hasÅ‚a zasady. Analizowanie i ponowne uÅ¼ycie poÅ›wiadczeÅ„ z plikÃ³w keytab moÅ¼na Å‚atwo wykonaÄ‡ za pomocÄ… narzÄ™dzi takich jak `klist` i skryptÃ³w takich jak **KeytabParser**.

### Cheatsheet

MoÅ¼esz znaleÅºÄ‡ wiÄ™cej informacji na temat korzystania z biletÃ³w w systemie Linux w nastÄ™pujÄ…cym linku:

{% content-ref url="privilege-escalation/linux-active-directory.md" %}
[linux-active-directory.md](privilege-escalation/linux-active-directory.md)
{% endcontent-ref %}

## Enumeracja

{% hint style="warning" %}
MoÅ¼esz przeprowadziÄ‡ **enumeracjÄ™** za pomocÄ… **ldap** i innych **narzÄ™dzi binarnych**, lub **Å‚Ä…czÄ…c siÄ™ z stronÄ… internetowÄ… na porcie 443 serwera FreeIPA**.
{% endhint %}

### Hosty, UÅ¼ytkownicy i Grupy <a href="#id-4b3b" id="id-4b3b"></a>

MoÅ¼liwe jest tworzenie **hostÃ³w**, **uÅ¼ytkownikÃ³w** i **grup**. Hosty i uÅ¼ytkownicy sÄ… sortowani w kontenerach zwanych â€œ**Grupami HostÃ³w**â€ i â€œ**Grupami UÅ¼ytkownikÃ³w**â€ odpowiednio. SÄ… one podobne do **Jednostek Organizacyjnych** (OU).

DomyÅ›lnie w FreeIPA serwer LDAP pozwala na **anonimowe poÅ‚Ä…czenia**, a duÅ¼a czÄ™Å›Ä‡ danych jest enumerowana **bez uwierzytelnienia**. To moÅ¼e enumerowaÄ‡ wszystkie dane dostÄ™pne bez uwierzytelnienia:
```
ldapsearch -x
```
Aby uzyskaÄ‡ **wiÄ™cej informacji**, musisz uÅ¼yÄ‡ **uwierzytelnionej** sesji (sprawdÅº sekcjÄ™ Uwierzytelnianie, aby dowiedzieÄ‡ siÄ™, jak przygotowaÄ‡ uwierzytelnionÄ… sesjÄ™).
```bash
# Get all users of domain
ldapsearch -Y gssapi -b "cn=users,cn=compat,dc=domain_name,dc=local"

# Get users groups
ldapsearch -Y gssapi -b "cn=groups,cn=accounts,dc=domain_name,dc=local"

# Get all the hosts
ldapsearch -Y gssapi -b "cn=computers,cn=accounts,dc=domain_name,dc=local"

# Get hosts groups
ldapsearch -Y gssapi -b "cn=hostgroups,cn=accounts,dc=domain_name,dc=local"
```
Z maszyny doÅ‚Ä…czonej do domeny bÄ™dziesz mÃ³gÅ‚ uÅ¼yÄ‡ **zainstalowanych binarek** do enumeracji domeny:
```bash
ipa user-find
ipa usergroup-find
ipa host-find
ipa host-group-find

-------------------

ipa user-show <username> --all
ipa usergroup-show <user group> --all
ipa host-find <host> --all
ipa hostgroup-show <host group> --all
```
{% hint style="info" %}
UÅ¼ytkownik **admin** w **FreeIPA** jest odpowiednikiem **administratorÃ³w domeny** z **AD**.
{% endhint %}

### Hashes <a href="#id-482b" id="id-482b"></a>

UÅ¼ytkownik **root** z serwera **IPA** ma dostÄ™p do **hashy** haseÅ‚.

* Hash hasÅ‚a uÅ¼ytkownika jest przechowywany jako **base64** w atrybucie â€œ**userPassword**â€. Ten hash moÅ¼e byÄ‡ **SSHA512** (stare wersje FreeIPA) lub **PBKDF2\_SHA256**.
* **Nthash** hasÅ‚a jest przechowywany jako **base64** w â€œ**ipaNTHash**â€, jeÅ›li system ma **integracjÄ™** z **AD**.

Aby zÅ‚amaÄ‡ te hashe:

â€¢ JeÅ›li freeIPA jest zintegrowany z AD, **ipaNTHash** jest Å‚atwy do zÅ‚amania: NaleÅ¼y **dekodowaÄ‡** **base64** -> ponownie zakodowaÄ‡ jako **ASCII** hex -> John The Ripper lub **hashcat** mogÄ… pomÃ³c w szybkim zÅ‚amaniu

â€¢ JeÅ›li uÅ¼ywana jest stara wersja FreeIPA, to uÅ¼ywany jest **SSHA512**: NaleÅ¼y dekodowaÄ‡ **base64** -> znaleÅºÄ‡ hash SSHA512 -> John The Ripper lub **hashcat** mogÄ… pomÃ³c w zÅ‚amaniu

â€¢ JeÅ›li uÅ¼ywana jest nowa wersja FreeIPA, to uÅ¼ywany jest **PBKDF2\_SHA256**: NaleÅ¼y dekodowaÄ‡ **base64** -> znaleÅºÄ‡ PBKDF2\_SHA256 -> jego **dÅ‚ugoÅ›Ä‡** to 256 bajtÃ³w. John moÅ¼e pracowaÄ‡ z 256 bitami (32 bajty) -> SHA-265 uÅ¼ywane jako funkcja pseudolosowa, rozmiar bloku to 32 bajty -> moÅ¼na uÅ¼yÄ‡ tylko pierwszych 256 bitÃ³w naszego hasha PBKDF2\_SHA256 -> John The Ripper lub hashcat mogÄ… pomÃ³c w zÅ‚amaniu

<figure><img src="../.gitbook/assets/image (655).png" alt=""><figcaption></figcaption></figure>

Aby wyodrÄ™bniÄ‡ hashe, musisz byÄ‡ **rootem na serwerze FreeIPA**, tam moÅ¼esz uÅ¼yÄ‡ narzÄ™dzia **`dbscan`**, aby je wyodrÄ™bniÄ‡:

<figure><img src="../.gitbook/assets/image (293).png" alt=""><figcaption></figcaption></figure>

### HBAC-Rules <a href="#id-482b" id="id-482b"></a>

SÄ… to zasady, ktÃ³re przyznajÄ… okreÅ›lone uprawnienia uÅ¼ytkownikom lub hostom do zasobÃ³w (hosty, usÅ‚ugi, grupy usÅ‚ug...)
```bash
# Enumerate using ldap
ldapsearch -Y gssapi -b "cn=hbac,dc=domain_name,dc=local"
# Using ipa
ipa hbacrule-find
# Show info of rule
ipa hbacrule-show <hbacrule> --all
```
#### Sudo-Rules

FreeIPA umoÅ¼liwia centralne zarzÄ…dzanie **uprawnieniami sudo** za pomocÄ… reguÅ‚ sudo. ReguÅ‚y te pozwalajÄ… lub ograniczajÄ… wykonywanie poleceÅ„ z sudo na hostach w obrÄ™bie domeny. AtakujÄ…cy moÅ¼e potencjalnie zidentyfikowaÄ‡ odpowiednie hosty, uÅ¼ytkownikÃ³w i dozwolone polecenia, analizujÄ…c te zestawy reguÅ‚.
```bash
# Enumerate using ldap
ldapsearch -Y gssapi -b "cn=sudorules,cn=sudo,dc=domain_name,dc=local"
# Using ipa
ipa sudorule-find
# Show info of rule
ipa sudorule-show <sudorule> --all
```
### Kontrola dostÄ™pu oparta na rolach

**Rola** skÅ‚ada siÄ™ z rÃ³Å¼nych **uprawnieÅ„**, z ktÃ³rych kaÅ¼de obejmuje zbiÃ³r **zezwolenia**. Te role mogÄ… byÄ‡ przypisane do UÅ¼ytkownikÃ³w, Grup UÅ¼ytkownikÃ³w, **HostÃ³w**, Grup HostÃ³w i UsÅ‚ug. Na przykÅ‚ad, rozwaÅ¼my domyÅ›lnÄ… rolÄ™ â€Administrator UÅ¼ytkownikÃ³wâ€ w FreeIPA, aby zilustrowaÄ‡ tÄ™ strukturÄ™.

Rola `Administrator UÅ¼ytkownikÃ³w` ma te uprawnienia:

* **Administratorzy UÅ¼ytkownikÃ³w**
* **Administratorzy Grup**
* **Administratorzy UÅ¼ytkownikÃ³w Etapowych**

Za pomocÄ… nastÄ™pujÄ…cych poleceÅ„ moÅ¼na wyliczyÄ‡ role, uprawnienia i zezwolenia:
```bash
# Using ldap
ldapsearch -Y gssapi -b "cn=roles,cn=accounts,dc=westeros,dc=local"
# Using ipa binary
ipa role-find
ipa role-show <role> --all
ipa privilege-find
ipa privilege-show <privilege> --all
ipa permission-find
ipa permission-show <permission> --all
```
### PrzykÅ‚ad scenariusza ataku

W [https://posts.specterops.io/attacking-freeipa-part-iii-finding-a-path-677405b5b95e](https://posts.specterops.io/attacking-freeipa-part-iii-finding-a-path-677405b5b95e) moÅ¼na znaleÅºÄ‡ prosty przykÅ‚ad, jak naduÅ¼yÄ‡ niektÃ³re uprawnienia, aby skompromitowaÄ‡ domenÄ™.

### Linikatz/LinikatzV2

* [https://github.com/Orange-Cyberdefense/LinikatzV2](https://github.com/Orange-Cyberdefense/LinikatzV2)
* [https://github.com/CiscoCXSecurity/linikatz](https://github.com/CiscoCXSecurity/linikatz)

## Privesc

### ~~tworzenie uÅ¼ytkownika root~~

{% hint style="warning" %}
JeÅ›li moÅ¼esz **utworzyÄ‡ nowego uÅ¼ytkownika o nazwie `root`**, moÅ¼esz siÄ™ nim podszyÄ‡ i bÄ™dziesz mÃ³gÅ‚ **SSH do dowolnej maszyny jako root.**

**TO ZOSTAÅO POPRAWIONE.**
{% endhint %}

MoÅ¼esz sprawdziÄ‡ szczegÃ³Å‚owe wyjaÅ›nienie w [https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b](https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b)

## Odniesienia

* [https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b](https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b)
* [https://posts.specterops.io/attacking-freeipa-part-i-authentication-77e73d837d6a](https://posts.specterops.io/attacking-freeipa-part-i-authentication-77e73d837d6a)
* [https://posts.specterops.io/attacking-freeipa-part-ii-enumeration-ad27224371e1](https://posts.specterops.io/attacking-freeipa-part-ii-enumeration-ad27224371e1)
* [https://www.youtube.com/watch?v=9dOu-7BTwPQ](https://www.youtube.com/watch?v=9dOu-7BTwPQ)

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ trikami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>
{% endhint %}
