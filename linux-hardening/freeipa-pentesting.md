# FreeIPA Pentesting

<details>

<summary><strong>AWS hackleme becerilerinizi sÄ±fÄ±rdan kahraman seviyesine kadar Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong> ile</strong>!</summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **reklamÄ±nÄ±zÄ± gÃ¶rmek** veya **HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* Ã–zel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluÅŸan koleksiyonumuz olan [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)'Ä± **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na **PR gÃ¶ndererek** paylaÅŸÄ±n.

</details>

## Temel Bilgiler

FreeIPA, Ã¶ncelikle **Unix** ortamlarÄ± iÃ§in Microsoft Windows **Active Directory**'ye bir aÃ§Ä±k kaynaklÄ± **alternatif**tir. Active Directory'ye benzer ÅŸekilde, yÃ¶netim iÃ§in bir MIT **Kerberos** Anahtar DaÄŸÄ±tÄ±m Merkezi ile birlikte tam bir **LDAP dizini** birleÅŸtirir. CA ve RA sertifika yÃ¶netimi iÃ§in Dogtag **Certificate System** kullanarak, akÄ±llÄ± kartlar da dahil olmak Ã¼zere **Ã§ok faktÃ¶rlÃ¼** kimlik doÄŸrulama destekler. Unix kimlik doÄŸrulama sÃ¼reÃ§leri iÃ§in SSSD entegre edilmiÅŸtir.

## Parmak Ä°zi

### Dosyalar ve Ortam DeÄŸiÅŸkenleri

- `/etc/krb5.conf` dosyasÄ±, etki alanÄ±na kaydolmak iÃ§in gereken Kerberos istemci bilgilerini depolayan yerdir. Bu, KDC'lerin ve yÃ¶netici sunucularÄ±nÄ±n konumlarÄ±nÄ±, varsayÄ±lan ayarlarÄ± ve eÅŸlemeleri iÃ§erir.
- IPA istemcileri ve sunucularÄ± iÃ§in sistem genelinde varsayÄ±lanlar, `/etc/ipa/default.conf` konumunda bulunan dosyada ayarlanÄ±r.
- Etki alanÄ±ndaki ana bilgisayarlar, kimlik doÄŸrulama sÃ¼reÃ§leri iÃ§in `/etc/krb5.keytab` konumunda bir `krb5.keytab` dosyasÄ±na sahip olmalÄ±dÄ±r.
- Ã‡eÅŸitli ortam deÄŸiÅŸkenleri (`KRB5CCNAME`, `KRB5_KTNAME`, `KRB5_CONFIG`, `KRB5_KDC_PROFILE`, `KRB5RCACHETYPE`, `KRB5RCACHEDIR`, `KRB5_TRACE`, `KRB5_CLIENT_KTNAME`, `KPROP_PORT`), Kerberos kimlik doÄŸrulamasÄ±yla ilgili belirli dosyalara ve ayarlara iÅŸaret etmek iÃ§in kullanÄ±lÄ±r.

### Ä°kili Dosyalar

`ipa`, `kdestroy`, `kinit`, `klist`, `kpasswd`, `ksu`, `kswitch` ve `kvno` gibi araÃ§lar, FreeIPA etki alanlarÄ±nÄ± yÃ¶netme, Kerberos biletleriyle ilgili iÅŸlemler yapma, ÅŸifreleri deÄŸiÅŸtirme ve hizmet biletleri alma gibi iÅŸlevlerde merkezi bir rol oynar.

### AÄŸ

Tipik bir FreeIPA sunucusu kurulumunu gÃ¶stermek iÃ§in bir gÃ¶rsel saÄŸlanmaktadÄ±r.

## Kimlik DoÄŸrulama

FreeIPA'da **Kerberos** kullanarak kimlik doÄŸrulama, **Active Directory** ile benzerlik gÃ¶sterir. Etki alanÄ± kaynaklarÄ±na eriÅŸim iÃ§in geÃ§erli bir Kerberos bileti gereklidir ve bu bilet, FreeIPA etki alanÄ± yapÄ±landÄ±rmasÄ±na baÄŸlÄ± olarak Ã§eÅŸitli konumlarda depolanabilir.

### **CCACHE Bilet DosyalarÄ±**

CCACHE dosyalarÄ±, taÅŸÄ±nabilirlikleri nedeniyle kullanÄ±cÄ±nÄ±n dÃ¼z metin parolasÄ± olmadan kimlik doÄŸrulama iÃ§in Ã¶nemli olan Kerberos kimlik bilgilerini depolamak iÃ§in kullanÄ±lan **`/tmp`** gibi genellikle **600** izinli ikili formatlardÄ±r. Bir CCACHE bileti ayrÄ±ÅŸtÄ±rmak iÃ§in `klist` komutu kullanÄ±labilir ve geÃ§erli bir CCACHE Biletini yeniden kullanmak iÃ§in `KRB5CCNAME`'i bilet dosyasÄ±nÄ±n yoluna ihraÃ§ etmek gereklidir.

### **Unix Anahtar HalkasÄ±**

Alternatif olarak, CCACHE Biletleri Linux anahtar halkasÄ±nda depolanabilir ve bu, bilet yÃ¶netimi konusunda daha fazla kontrol saÄŸlar. Bilet depolama kapsamÄ± deÄŸiÅŸir (`KEYRING:ad`, `KEYRING:sÃ¼reÃ§:ad`, `KEYRING:iÅŸ parÃ§acÄ±ÄŸÄ±:ad`, `KEYRING:oturum:ad`, `KEYRING:kalÄ±cÄ±:uidnumarasÄ±`) ve kullanÄ±cÄ± iÃ§in bu bilgileri ayrÄ±ÅŸtÄ±rmak iÃ§in `klist` kullanÄ±labilir. Bununla birlikte, Unix anahtar halkasÄ±ndan bir CCACHE Biletini yeniden kullanmak zorluklar yaratabilir ve Kerberos biletlerini Ã§Ä±karmak iÃ§in **Tickey** gibi araÃ§lar mevcuttur.

### Keytab

Kerberos prensiplerini ve ÅŸifrelenmiÅŸ anahtarlarÄ± iÃ§eren keytab dosyalarÄ±, prensibin parolasÄ±na ihtiyaÃ§ duymadan geÃ§erli bir bilet alma iÅŸlemi iÃ§in kritiktir. Keytab dosyalarÄ±ndan kimlik bilgilerini ayrÄ±ÅŸtÄ±rmak ve yeniden kullanmak, `klist` gibi yardÄ±mcÄ± programlar ve **KeytabParser** gibi betiklerle kolayca gerÃ§ekleÅŸtirilebilir.

### Hile KaÄŸÄ±dÄ±

Linux'ta biletleri nasÄ±l kullanacaÄŸÄ±nÄ±z hakkÄ±nda daha fazla bilgiyi aÅŸaÄŸÄ±daki baÄŸlantÄ±da bulabilirsiniz:

{% content-ref url="privilege-escalation/linux-active-directory.md" %}
[linux-active-directory.md](privilege-escalation/linux-active-directory.md)
{% endcontent-ref %}

## NumaralandÄ±rma

{% hint style="warning" %}
NumaralandÄ±rmayÄ± **ldap** ve diÄŸer **ikili** araÃ§lar aracÄ±lÄ±ÄŸÄ±yla veya FreeIPA sunucusunun **443 numaralÄ± baÄŸlantÄ± noktasÄ±na** baÄŸlanarak gerÃ§ekleÅŸtirebilirsiniz.
{% endhint %}

### Ana Bilgisayarlar, KullanÄ±cÄ±lar ve Gruplar <a href="#4b3b" id="4b3b"></a>

**Ana bilgisayarlar**, **kullanÄ±cÄ±lar** ve **gruplar** oluÅŸturmak mÃ¼mkÃ¼ndÃ¼r. Ana bilgisayarlar ve kullanÄ±cÄ±lar sÄ±rasÄ±yla "Ana Bilgisayar GruplarÄ±" ve "KullanÄ±cÄ± GruplarÄ±" adÄ± verilen konteynerlara yerleÅŸtirilir. Bunlar, **Organizasyon Birimleri** (OU) ile benzerdir.

FreeIPA'da, LDAP sunucusu varsayÄ±lan olarak **anonim baÄŸlantÄ±lara** izin verir ve **kimlik doÄŸrulama yapÄ±lmadan** bÃ¼yÃ¼k bir veri yelpazesi numaralandÄ±rÄ±labilir. Bu, kimlik doÄŸrulamasÄ±z olarak mevcut olan tÃ¼m verileri numaralandÄ±rabilir:
```
ldapsearch -x
```
Daha fazla bilgi almak iÃ§in bir **kimlik doÄŸrulama** oturumu kullanmanÄ±z gerekmektedir (bir kimlik doÄŸrulama oturumu nasÄ±l hazÄ±rlanacaÄŸÄ±nÄ± Ã¶ÄŸrenmek iÃ§in Kimlik DoÄŸrulama bÃ¶lÃ¼mÃ¼ne bakÄ±n).
```bash
# Get all users of domain
ldapsearch -Y gssapi -b "cn=users,cn=compat,dc=domain_name,dc=local"

# Get users groups
ldapsearch -Y gssapi -b "cn=groups,cn=accounts,dc=domain_name,dc=local"

# Get all the hosts
ldapsearch -Y gssapi -b "cn=computers,cn=accounts,dc=domain_name,dc=local"

# Get hosts groups
ldapsearch -Y gssapi -b "cn=hostgroups,cn=accounts,dc=domain_name,dc=local"
```
Bir etki alanÄ±na katÄ±lmÄ±ÅŸ bir makineden, etki alanÄ±nÄ± sÄ±ralamak iÃ§in **kurulu ikili dosyalarÄ±** kullanabilirsiniz:
```bash
ipa user-find
ipa usergroup-find
ipa host-find
ipa host-group-find

-------------------

ipa user-show <username> --all
ipa usergroup-show <user group> --all
ipa host-find <host> --all
ipa hostgroup-show <host group> --all
```
{% hint style="info" %}
**FreeIPA**'nÄ±n **admin** kullanÄ±cÄ±sÄ±, **AD**'deki **domain adminleri**ne eÅŸdeÄŸerdir.
{% endhint %}

### Hashler <a href="#482b" id="482b"></a>

**IPA sunucusu**ndaki **root** kullanÄ±cÄ±sÄ±, ÅŸifre **hash'lerine** eriÅŸebilir.

- Bir kullanÄ±cÄ±nÄ±n ÅŸifre hash'i "userPassword" **Ã¶zniteliÄŸinde** **base64** olarak saklanÄ±r. Bu hash, **SSHA512** (eski FreeIPA sÃ¼rÃ¼mleri) veya **PBKDF2\_SHA256** olabilir.
- Åifrenin **Nthash**i, sistem **AD** ile **entegre** ise "ipaNTHash" olarak **base64** olarak saklanÄ±r.

Bu hash'leri kÄ±rmak iÃ§in:

- FreeIPA AD ile entegre ise, **ipaNTHash** kolayca kÄ±rÄ±labilir: **Base64**'Ã¼ **Ã§Ã¶zÃ¼mle** -> ASCII hex olarak **yeniden kodla** -> John The Ripper veya **hashcat** hÄ±zlÄ±ca kÄ±rmanÄ±za yardÄ±mcÄ± olabilir.

- Eski bir FreeIPA sÃ¼rÃ¼mÃ¼ kullanÄ±lÄ±yorsa, **SSHA512** kullanÄ±lÄ±r: **Base64**'Ã¼ **Ã§Ã¶zÃ¼mle** -> SSHA512 **hash'ini** bul -> John The Ripper veya **hashcat** kÄ±rmanÄ±za yardÄ±mcÄ± olabilir.

- Yeni bir FreeIPA sÃ¼rÃ¼mÃ¼ kullanÄ±lÄ±yorsa, **PBKDF2\_SHA256** kullanÄ±lÄ±r: **Base64**'Ã¼ **Ã§Ã¶zÃ¼mle** -> PBKDF2\_SHA256'yÄ± bul -> uzunluÄŸu 256 bayttÄ±r. John, 256 bit (32 bayt) ile Ã§alÄ±ÅŸabilir -> Pseudo-rastgele iÅŸlev olarak SHA-265 kullanÄ±lÄ±r, blok boyutu 32 bayttÄ±r -> PBKDF2\_SHA256 hash'inin sadece ilk 256 bitini kullanabilirsiniz -> John The Ripper veya hashcat kÄ±rmanÄ±za yardÄ±mcÄ± olabilir.

<figure><img src="../.gitbook/assets/image (33).png" alt=""><figcaption></figcaption></figure>

Hash'leri Ã§Ä±karmak iÃ§in **FreeIPA sunucusunda root** olmanÄ±z gerekmektedir, burada **`dbscan`** aracÄ±nÄ± kullanarak bunlarÄ± Ã§Ä±karabilirsiniz:

<figure><img src="../.gitbook/assets/image (196).png" alt=""><figcaption></figcaption></figure>

### HBAC-KurallarÄ± <a href="#482b" id="482b"></a>

Bu kurallar, kullanÄ±cÄ±lara veya kaynaklara (sunucular, hizmetler, hizmet gruplarÄ±...) belirli izinler veren kurallardÄ±r.
```bash
# Enumerate using ldap
ldapsearch -Y gssapi -b "cn=hbac,dc=domain_name,dc=local"
# Using ipa
ipa hbacrule-find
# Show info of rule
ipa hbacrule-show <hbacrule> --all
```
#### Sudo-KurallarÄ±

FreeIPA, sudo-kurallarÄ± aracÄ±lÄ±ÄŸÄ±yla merkezi kontrol saÄŸlayarak **sudo izinlerini** etkinleÅŸtirir. Bu kurallar, etki alanÄ± iÃ§indeki ana bilgisayarlarda sudo ile komutlarÄ±n yÃ¼rÃ¼tÃ¼lmesini izin verir veya sÄ±nÄ±rlar. Bir saldÄ±rgan, bu kurallarÄ± inceleyerek ilgili ana bilgisayarlarÄ±, kullanÄ±cÄ±larÄ± ve izin verilen komutlarÄ± tespit edebilir.
```bash
# Enumerate using ldap
ldapsearch -Y gssapi -b "cn=sudorules,cn=sudo,dc=domain_name,dc=local"
# Using ipa
ipa sudorule-find
# Show info of rule
ipa sudorule-show <sudorule> --all
```
### Rol TabanlÄ± EriÅŸim KontrolÃ¼

Bir **rol**, Ã§eÅŸitli **ayrÄ±calÄ±klarÄ±** iÃ§eren bir dizi **izin**i kapsar. Bu roller, KullanÄ±cÄ±lara, KullanÄ±cÄ± **GruplarÄ±na**, **Sunuculara**, Sunucu GruplarÄ±na ve Hizmetlere atanabilir. Ã–rneÄŸin, bu yapÄ±yÄ± aÃ§Ä±klamak iÃ§in FreeIPA'daki varsayÄ±lan "KullanÄ±cÄ± YÃ¶neticisi" rolÃ¼nÃ¼ dÃ¼ÅŸÃ¼nelim.

`KullanÄ±cÄ± YÃ¶neticisi` rolÃ¼ ÅŸu ayrÄ±calÄ±klara sahiptir:

* **KullanÄ±cÄ± YÃ¶neticileri**
* **Grup YÃ¶neticileri**
* **AÅŸama KullanÄ±cÄ± YÃ¶neticileri**

AÅŸaÄŸÄ±daki komutlarla rolleri, ayrÄ±calÄ±klarÄ± ve izinleri sÄ±ralamak mÃ¼mkÃ¼ndÃ¼r:
```bash
# Using ldap
ldapsearch -Y gssapi -b "cn=roles,cn=accounts,dc=westeros,dc=local"
# Using ipa binary
ipa role-find
ipa role-show <role> --all
ipa privilege-find
ipa privilege-show <privilege> --all
ipa permission-find
ipa permission-show <permission> --all
```
### SaldÄ±rÄ± Senaryo Ã–rneÄŸi

[https://posts.specterops.io/attacking-freeipa-part-iii-finding-a-path-677405b5b95e](https://posts.specterops.io/attacking-freeipa-part-iii-finding-a-path-677405b5b95e) adresinde, bir alanÄ± tehlikeye atmak iÃ§in bazÄ± izinleri kÃ¶tÃ¼ye nasÄ±l kullanacaÄŸÄ±nÄ±zÄ±n basit bir Ã¶rneÄŸini bulabilirsiniz.

### Linikatz/LinikatzV2

* [https://github.com/Orange-Cyberdefense/LinikatzV2](https://github.com/Orange-Cyberdefense/LinikatzV2)
* [https://github.com/CiscoCXSecurity/linikatz](https://github.com/CiscoCXSecurity/linikatz)

## Privilege Escalation (Privesc)

### ~~root kullanÄ±cÄ±sÄ± oluÅŸturma~~

{% hint style="warning" %}
EÄŸer **`root`** adÄ±nda yeni bir kullanÄ±cÄ± oluÅŸturabilirseniz, onun yerine geÃ§ebilir ve herhangi bir makineye **root olarak SSH** ile baÄŸlanabilirsiniz.

**BU DÃœZELTÄ°LDÄ°.**
{% endhint %}

DetaylÄ± bir aÃ§Ä±klamayÄ± [https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b](https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b) adresinde bulabilirsiniz.

## Referanslar
* [https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b](https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b)
* [https://posts.specterops.io/attacking-freeipa-part-i-authentication-77e73d837d6a](https://posts.specterops.io/attacking-freeipa-part-i-authentication-77e73d837d6a)
* [https://posts.specterops.io/attacking-freeipa-part-ii-enumeration-ad27224371e1](https://posts.specterops.io/attacking-freeipa-part-ii-enumeration-ad27224371e1)
* [https://www.youtube.com/watch?v=9dOu-7BTwPQ](https://www.youtube.com/watch?v=9dOu-7BTwPQ)

<details>

<summary><strong>AWS hackleme konusunda sÄ±fÄ±rdan kahraman olmak iÃ§in</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>'Ä± Ã¶ÄŸrenin!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **tanÄ±tmak veya HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* Ã–zel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluÅŸan koleksiyonumuz olan [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keÅŸfedin
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi Twitter'da ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)** takip edin.**
* Hacking hilelerinizi [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶ndererek paylaÅŸÄ±n.

</details>
