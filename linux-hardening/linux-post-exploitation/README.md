# P√≥s-Explora√ß√£o no Linux

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Capturando Senhas de Login com PAM

Vamos configurar um m√≥dulo PAM para registrar cada senha que cada usu√°rio utiliza para fazer login. Se voc√™ n√£o sabe o que √© PAM, confira:

{% content-ref url="pam-pluggable-authentication-modules.md" %}
[pam-pluggable-authentication-modules.md](pam-pluggable-authentication-modules.md)
{% endcontent-ref %}

**Para mais detalhes, confira o [post original](https://embracethered.com/blog/posts/2022/post-exploit-pam-ssh-password-grabbing/)**. Este √© apenas um resumo:

**Vis√£o Geral da T√©cnica:**
Os M√≥dulos de Autentica√ß√£o Pluggable (PAM) oferecem flexibilidade na gest√£o da autentica√ß√£o em sistemas baseados em Unix. Eles podem aumentar a seguran√ßa personalizando os processos de login, mas tamb√©m representam riscos se forem mal utilizados. Este resumo descreve uma t√©cnica para capturar credenciais de login usando o PAM, juntamente com estrat√©gias de mitiga√ß√£o.

**Capturando Credenciais:**
- Um script bash chamado `toomanysecrets.sh` √© criado para registrar tentativas de login, capturando a data, nome de usu√°rio (`$PAM_USER`), senha (via stdin) e IP do host remoto (`$PAM_RHOST`) em `/var/log/toomanysecrets.log`.
- O script √© tornando execut√°vel e integrado na configura√ß√£o do PAM (`common-auth`) usando o m√≥dulo `pam_exec.so` com op√ß√µes para ser executado silenciosamente e expor o token de autentica√ß√£o para o script.
- A abordagem demonstra como um host Linux comprometido pode ser explorado para registrar credenciais discretamente.
```bash
#!/bin/sh
echo " $(date) $PAM_USER, $(cat -), From: $PAM_RHOST" >> /var/log/toomanysecrets.log
sudo touch /var/log/toomanysecrets.sh
sudo chmod 770 /var/log/toomanysecrets.sh
sudo nano /etc/pam.d/common-auth
# Add: auth optional pam_exec.so quiet expose_authtok /usr/local/bin/toomanysecrets.sh
sudo chmod 700 /usr/local/bin/toomanysecrets.sh
```
### Instalando um Backdoor no PAM

**Para mais detalhes, consulte o [post original](https://infosecwriteups.com/creating-a-backdoor-in-pam-in-5-line-of-code-e23e99579cd9)**. Este √© apenas um resumo:

O M√≥dulo de Autentica√ß√£o Plug√°vel (PAM) √© um sistema usado no Linux para autentica√ß√£o de usu√°rios. Ele opera em tr√™s conceitos principais: **nome de usu√°rio**, **senha** e **servi√ßo**. Os arquivos de configura√ß√£o para cada servi√ßo est√£o localizados no diret√≥rio `/etc/pam.d/`, onde bibliotecas compartilhadas lidam com a autentica√ß√£o.

**Objetivo**: Modificar o PAM para permitir a autentica√ß√£o com uma senha espec√≠fica, contornando a senha real do usu√°rio. Isso √© especialmente focado na biblioteca compartilhada `pam_unix.so` usada pelo arquivo `common-auth`, que √© inclu√≠do por quase todos os servi√ßos para verifica√ß√£o de senha.

### Passos para Modificar o `pam_unix.so`:

1. **Localize a Diretiva de Autentica√ß√£o** no arquivo `common-auth`:
- A linha respons√°vel por verificar a senha de um usu√°rio chama `pam_unix.so`.
2. **Modifique o C√≥digo-Fonte**:
- Adicione uma declara√ß√£o condicional no arquivo de origem `pam_unix_auth.c` que concede acesso se uma senha predefinida for usada, caso contr√°rio, ele prossegue com o processo de autentica√ß√£o usual.
3. **Recompile e Substitua** a biblioteca `pam_unix.so` modificada no diret√≥rio apropriado.
4. **Teste**:
- O acesso √© concedido em v√°rios servi√ßos (login, ssh, sudo, su, protetor de tela) com a senha predefinida, enquanto os processos de autentica√ß√£o normais permanecem inalterados.

{% hint style="info" %}
Voc√™ pode automatizar esse processo com [https://github.com/zephrax/linux-pam-backdoor](https://github.com/zephrax/linux-pam-backdoor)
{% endhint %}
