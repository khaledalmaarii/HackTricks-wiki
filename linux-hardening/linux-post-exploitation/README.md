# Post-Explotaci贸n en Linux

{% hint style="success" %}
Aprende y practica Hacking en AWS: <img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* 隆Consulta los [**planes de suscripci贸n**](https://github.com/sponsors/carlospolop)!
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Capturando Contrase帽as de Inicio de Sesi贸n con PAM

Configuremos un m贸dulo PAM para registrar cada contrase帽a que cada usuario utiliza para iniciar sesi贸n. Si no sabes qu茅 es PAM, consulta:

{% content-ref url="pam-pluggable-authentication-modules.md" %}
[pam-pluggable-authentication-modules.md](pam-pluggable-authentication-modules.md)
{% endcontent-ref %}

**Para m谩s detalles consulta el [post original](https://embracethered.com/blog/posts/2022/post-exploit-pam-ssh-password-grabbing/)**. Esto es solo un resumen:

**Resumen de la T茅cnica:**
Los M贸dulos de Autenticaci贸n Enchufables (PAM) ofrecen flexibilidad en la gesti贸n de la autenticaci贸n en sistemas basados en Unix. Pueden mejorar la seguridad personalizando los procesos de inicio de sesi贸n, pero tambi茅n plantean riesgos si se utilizan incorrectamente. Este resumen describe una t茅cnica para capturar credenciales de inicio de sesi贸n utilizando PAM, junto con estrategias de mitigaci贸n.

**Capturando Credenciales:**
- Se crea un script bash llamado `toomanysecrets.sh` para registrar intentos de inicio de sesi贸n, capturando la fecha, nombre de usuario (`$PAM_USER`), contrase帽a (a trav茅s de stdin) y la IP del host remoto (`$PAM_RHOST`) en `/var/log/toomanysecrets.log`.
- Se hace ejecutable el script e se integra en la configuraci贸n de PAM (`common-auth`) utilizando el m贸dulo `pam_exec.so` con opciones para ejecutar en silencio y exponer el token de autenticaci贸n al script.
- El enfoque demuestra c贸mo un host Linux comprometido puede ser explotado para registrar credenciales discretamente.
```bash
#!/bin/sh
echo " $(date) $PAM_USER, $(cat -), From: $PAM_RHOST" >> /var/log/toomanysecrets.log
sudo touch /var/log/toomanysecrets.sh
sudo chmod 770 /var/log/toomanysecrets.sh
sudo nano /etc/pam.d/common-auth
# Add: auth optional pam_exec.so quiet expose_authtok /usr/local/bin/toomanysecrets.sh
sudo chmod 700 /usr/local/bin/toomanysecrets.sh
```
### Instalaci贸n de una puerta trasera en PAM

**Para m谩s detalles, consulta el [post original](https://infosecwriteups.com/creating-a-backdoor-in-pam-in-5-line-of-code-e23e99579cd9)**. Esto es solo un resumen:

El M贸dulo de Autenticaci贸n Enchufable (PAM) es un sistema utilizado en Linux para la autenticaci贸n de usuarios. Opera en tres conceptos principales: **nombre de usuario**, **contrase帽a** y **servicio**. Los archivos de configuraci贸n para cada servicio se encuentran en el directorio `/etc/pam.d/`, donde las bibliotecas compartidas manejan la autenticaci贸n.

**Objetivo**: Modificar PAM para permitir la autenticaci贸n con una contrase帽a espec铆fica, evitando la contrase帽a real del usuario. Esto se enfoca particularmente en la biblioteca compartida `pam_unix.so` utilizada por el archivo `common-auth`, que es incluido por casi todos los servicios para la verificaci贸n de contrase帽as.

### Pasos para Modificar `pam_unix.so`:

1. **Localiza la Directiva de Autenticaci贸n** en el archivo `common-auth`:
- La l铆nea responsable de verificar la contrase帽a de un usuario llama a `pam_unix.so`.
2. **Modifica el C贸digo Fuente**:
- Agrega una declaraci贸n condicional en el archivo fuente `pam_unix_auth.c` que otorga acceso si se utiliza una contrase帽a predefinida, de lo contrario, contin煤a con el proceso de autenticaci贸n habitual.
3. **Recompila y Reemplaza** la biblioteca `pam_unix.so` modificada en el directorio apropiado.
4. **Prueba**:
- Se otorga acceso a trav茅s de varios servicios (inicio de sesi贸n, ssh, sudo, su, protector de pantalla) con la contrase帽a predefinida, mientras que los procesos de autenticaci贸n normales permanecen sin cambios.

{% hint style="info" %}
Puedes automatizar este proceso con [https://github.com/zephrax/linux-pam-backdoor](https://github.com/zephrax/linux-pam-backdoor)
{% endhint %}

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* 隆Consulta los [**planes de suscripci贸n**](https://github.com/sponsors/carlospolop)!
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
