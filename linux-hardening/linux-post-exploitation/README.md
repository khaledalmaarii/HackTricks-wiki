# Post-Exploitation Linux

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Capture des mots de passe de connexion avec PAM

Configurons un module PAM pour enregistrer chaque mot de passe que chaque utilisateur utilise pour se connecter. Si vous ne savez pas ce qu'est PAM, consultez :

{% content-ref url="pam-pluggable-authentication-modules.md" %}
[pam-pluggable-authentication-modules.md](pam-pluggable-authentication-modules.md)
{% endcontent-ref %}

**Pour plus de d√©tails, consultez le [message original](https://embracethered.com/blog/posts/2022/post-exploit-pam-ssh-password-grabbing/)**. Ceci n'est qu'un r√©sum√© :

**Aper√ßu de la technique :**
Les modules d'authentification enfichables (PAM) offrent une flexibilit√© dans la gestion de l'authentification sur les syst√®mes Unix. Ils peuvent renforcer la s√©curit√© en personnalisant les processus de connexion, mais posent √©galement des risques s'ils sont mal utilis√©s. Ce r√©sum√© d√©crit une technique pour capturer les informations d'identification de connexion en utilisant PAM, ainsi que des strat√©gies d'att√©nuation.

**Capture des informations d'identification :**
- Un script bash nomm√© `toomanysecrets.sh` est cr√©√© pour enregistrer les tentatives de connexion, capturant la date, le nom d'utilisateur (`$PAM_USER`), le mot de passe (via stdin) et l'adresse IP de l'h√¥te distant (`$PAM_RHOST`) dans `/var/log/toomanysecrets.log`.
- Le script est rendu ex√©cutable et int√©gr√© dans la configuration PAM (`common-auth`) en utilisant le module `pam_exec.so` avec des options pour s'ex√©cuter discr√®tement et exposer le jeton d'authentification au script.
- Cette approche montre comment un h√¥te Linux compromis peut √™tre exploit√© pour enregistrer discr√®tement des informations d'identification.
```bash
#!/bin/sh
echo " $(date) $PAM_USER, $(cat -), From: $PAM_RHOST" >> /var/log/toomanysecrets.log
sudo touch /var/log/toomanysecrets.sh
sudo chmod 770 /var/log/toomanysecrets.sh
sudo nano /etc/pam.d/common-auth
# Add: auth optional pam_exec.so quiet expose_authtok /usr/local/bin/toomanysecrets.sh
sudo chmod 700 /usr/local/bin/toomanysecrets.sh
```
### Installation d'une porte d√©rob√©e dans PAM

**Pour plus de d√©tails, consultez le [post original](https://infosecwriteups.com/creating-a-backdoor-in-pam-in-5-line-of-code-e23e99579cd9)**. Ceci est juste un r√©sum√© :

Le Module d'Authentification Pluggable (PAM) est un syst√®me utilis√© sous Linux pour l'authentification des utilisateurs. Il repose sur trois concepts principaux : **nom d'utilisateur**, **mot de passe**, et **service**. Les fichiers de configuration pour chaque service se trouvent dans le r√©pertoire `/etc/pam.d/`, o√π des biblioth√®ques partag√©es g√®rent l'authentification.

**Objectif** : Modifier PAM pour permettre l'authentification avec un mot de passe sp√©cifique, contournant le mot de passe r√©el de l'utilisateur. Cela se concentre particuli√®rement sur la biblioth√®que partag√©e `pam_unix.so` utilis√©e par le fichier `common-auth`, inclus par presque tous les services pour la v√©rification des mots de passe.

### √âtapes pour modifier `pam_unix.so` :

1. **Localiser la Directive d'Authentification** dans le fichier `common-auth` :
- La ligne responsable de la v√©rification du mot de passe d'un utilisateur appelle `pam_unix.so`.
2. **Modifier le Code Source** :
- Ajouter une instruction conditionnelle dans le fichier source `pam_unix_auth.c` qui accorde l'acc√®s si un mot de passe pr√©d√©fini est utilis√©, sinon, il proc√®de avec le processus d'authentification habituel.
3. **Recompiler et Remplacer** la biblioth√®que `pam_unix.so` modifi√©e dans le r√©pertoire appropri√©.
4. **Test** :
- L'acc√®s est accord√© √† travers divers services (connexion, ssh, sudo, su, √©conomiseur d'√©cran) avec le mot de passe pr√©d√©fini, tandis que les processus d'authentification normaux restent inchang√©s.

{% hint style="info" %}
Vous pouvez automatiser ce processus avec [https://github.com/zephrax/linux-pam-backdoor](https://github.com/zephrax/linux-pam-backdoor)
{% endhint %}
