# AppArmor

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

AppArmor ‚Äî —Ü–µ **–ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è —è–¥—Ä–∞, –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–µ –¥–ª—è –æ–±–º–µ–∂–µ–Ω–Ω—è —Ä–µ—Å—É—Ä—Å—ñ–≤, –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –ø—Ä–æ–≥—Ä–∞–º–∞–º, —á–µ—Ä–µ–∑ –ø—Ä–æ—Ñ—ñ–ª—ñ –¥–ª—è –∫–æ–∂–Ω–æ—ó –ø—Ä–æ–≥—Ä–∞–º–∏**, –µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ —Ä–µ–∞–ª—ñ–∑—É—é—á–∏ –û–±–æ–≤'—è–∑–∫–æ–≤–∏–π –ö–æ–Ω—Ç—Ä–æ–ª—å –î–æ—Å—Ç—É–ø—É (MAC), –ø—Ä–∏–≤'—è–∑—É—é—á–∏ –∞—Ç—Ä–∏–±—É—Ç–∏ –∫–æ–Ω—Ç—Ä–æ–ª—é –¥–æ—Å—Ç—É–ø—É –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ –¥–æ –ø—Ä–æ–≥—Ä–∞–º, –∞ –Ω–µ –¥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤. –¶—è —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–∞—Ü—é—î —à–ª—è—Ö–æ–º **–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—ñ–≤ —É —è–¥—Ä–æ**, –∑–∞–∑–≤–∏—á–∞–π –ø—ñ–¥ —á–∞—Å –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è, —ñ —Ü—ñ –ø—Ä–æ—Ñ—ñ–ª—ñ –≤–∏–∑–Ω–∞—á–∞—é—Ç—å, –¥–æ —è–∫–∏—Ö —Ä–µ—Å—É—Ä—Å—ñ–≤ –ø—Ä–æ–≥—Ä–∞–º–∞ –º–æ–∂–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø, —Ç–∞–∫–∏—Ö —è–∫ –º–µ—Ä–µ–∂–µ–≤—ñ –∑'—î–¥–Ω–∞–Ω–Ω—è, –¥–æ—Å—Ç—É–ø –¥–æ —Å–∏—Ä–∏—Ö —Å–æ–∫–µ—Ç—ñ–≤ —ñ –¥–æ–∑–≤–æ–ª–∏ –Ω–∞ —Ñ–∞–π–ª–∏.

–Ü—Å–Ω—É—î –¥–≤–∞ —Ä–æ–±–æ—á–∏—Ö —Ä–µ–∂–∏–º–∏ –¥–ª—è –ø—Ä–æ—Ñ—ñ–ª—ñ–≤ AppArmor:

* **–†–µ–∂–∏–º –≤–∏–∫–æ–Ω–∞–Ω–Ω—è**: –¶–µ–π —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–Ω–æ –∑–∞–±–µ–∑–ø–µ—á—É—î –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –ø–æ–ª—ñ—Ç–∏–∫, –≤–∏–∑–Ω–∞—á–µ–Ω–∏—Ö —É –ø—Ä–æ—Ñ—ñ–ª—ñ, –±–ª–æ–∫—É—é—á–∏ –¥—ñ—ó, —è–∫—ñ –ø–æ—Ä—É—à—É—é—Ç—å —Ü—ñ –ø–æ–ª—ñ—Ç–∏–∫–∏, —ñ —Ä–µ—î—Å—Ç—Ä—É—é—á–∏ –±—É–¥—å-—è–∫—ñ —Å–ø—Ä–æ–±–∏ —ó—Ö –ø–æ—Ä—É—à–µ–Ω–Ω—è —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º–∏, —Ç–∞–∫—ñ —è–∫ syslog –∞–±–æ auditd.
* **–†–µ–∂–∏–º —Å–∫–∞—Ä–≥–∏**: –ù–∞ –≤—ñ–¥–º—ñ–Ω—É –≤—ñ–¥ —Ä–µ–∂–∏–º—É –≤–∏–∫–æ–Ω–∞–Ω–Ω—è, —Ä–µ–∂–∏–º —Å–∫–∞—Ä–≥–∏ –Ω–µ –±–ª–æ–∫—É—î –¥—ñ—ó, —è–∫—ñ —Å—É–ø–µ—Ä–µ—á–∞—Ç—å –ø–æ–ª—ñ—Ç–∏–∫–∞–º –ø—Ä–æ—Ñ—ñ–ª—é. –ù–∞—Ç–æ–º—ñ—Å—Ç—å –≤—ñ–Ω —Ä–µ—î—Å—Ç—Ä—É—î —Ü—ñ —Å–ø—Ä–æ–±–∏ —è–∫ –ø–æ—Ä—É—à–µ–Ω–Ω—è –ø–æ–ª—ñ—Ç–∏–∫–∏ –±–µ–∑ –Ω–∞–∫–ª–∞–¥–µ–Ω–Ω—è –æ–±–º–µ–∂–µ–Ω—å.

### Components of AppArmor

* **–ú–æ–¥—É–ª—å —è–¥—Ä–∞**: –í—ñ–¥–ø–æ–≤—ñ–¥–∞—î –∑–∞ –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –ø–æ–ª—ñ—Ç–∏–∫.
* **–ü–æ–ª—ñ—Ç–∏–∫–∏**: –í–∏–∑–Ω–∞—á–∞—é—Ç—å –ø—Ä–∞–≤–∏–ª–∞ —Ç–∞ –æ–±–º–µ–∂–µ–Ω–Ω—è –¥–ª—è –ø–æ–≤–µ–¥—ñ–Ω–∫–∏ –ø—Ä–æ–≥—Ä–∞–º–∏ —Ç–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ —Ä–µ—Å—É—Ä—Å—ñ–≤.
* **–ü–∞—Ä—Å–µ—Ä**: –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î –ø–æ–ª—ñ—Ç–∏–∫–∏ –≤ —è–¥—Ä–æ –¥–ª—è –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∞–±–æ –∑–≤—ñ—Ç—É–≤–∞–Ω–Ω—è.
* **–£—Ç–∏–ª—ñ—Ç–∏**: –¶–µ –ø—Ä–æ–≥—Ä–∞–º–∏ –≤ —Ä–µ–∂–∏–º—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, —è–∫—ñ –Ω–∞–¥–∞—é—Ç—å —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –≤–∑–∞—î–º–æ–¥—ñ—ó –∑ AppArmor —Ç–∞ –π–æ–≥–æ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è.

### Profiles path

–ü—Ä–æ—Ñ—ñ–ª—ñ AppArmor –∑–∞–∑–≤–∏—á–∞–π –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≤ _**/etc/apparmor.d/**_\
–ó–∞ –¥–æ–ø–æ–º–æ–≥–æ—é `sudo aa-status` –≤–∏ –∑–º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ—Ä–∞—Ö—É–≤–∞—Ç–∏ –¥–≤—ñ–π–∫–æ–≤—ñ —Ñ–∞–π–ª–∏, —è–∫—ñ –æ–±–º–µ–∂–µ–Ω—ñ —è–∫–∏–º–æ—Å—å –ø—Ä–æ—Ñ—ñ–ª–µ–º. –Ø–∫—â–æ –≤–∏ –º–æ–∂–µ—Ç–µ –∑–º—ñ–Ω–∏—Ç–∏ —Å–∏–º–≤–æ–ª "/" –Ω–∞ –∫—Ä–∞–ø–∫—É –≤ —à–ª—è—Ö—É –∫–æ–∂–Ω–æ–≥–æ –ø–µ—Ä–µ—Ä–∞—Ö–æ–≤–∞–Ω–æ–≥–æ –¥–≤—ñ–π–∫–æ–≤–æ–≥–æ —Ñ–∞–π–ª—É, –≤–∏ –æ—Ç—Ä–∏–º–∞—î—Ç–µ –Ω–∞–∑–≤—É –ø—Ä–æ—Ñ—ñ–ª—é apparmor —É –∑–≥–∞–¥–∞–Ω—ñ–π –ø–∞–ø—Ü—ñ.

–ù–∞–ø—Ä–∏–∫–ª–∞–¥, –ø—Ä–æ—Ñ—ñ–ª—å **apparmor** –¥–ª—è _/usr/bin/man_ –±—É–¥–µ —Ä–æ–∑—Ç–∞—à–æ–≤–∞–Ω–∏–π —É _/etc/apparmor.d/usr.bin.man_

### Commands
```bash
aa-status     #check the current status
aa-enforce    #set profile to enforce mode (from disable or complain)
aa-complain   #set profile to complain mode (from diable or enforcement)
apparmor_parser #to load/reload an altered policy
aa-genprof    #generate a new profile
aa-logprof    #used to change the policy when the binary/program is changed
aa-mergeprof  #used to merge the policies
```
## –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é

* –©–æ–± –≤–∫–∞–∑–∞—Ç–∏ –Ω–∞ —É—Ä–∞–∂–µ–Ω–∏–π –≤–∏–∫–æ–Ω—É–≤–∞–Ω–∏–π —Ñ–∞–π–ª, **–¥–æ–∑–≤–æ–ª–µ–Ω—ñ –∞–±—Å–æ–ª—é—Ç–Ω—ñ —à–ª—è—Ö–∏ —Ç–∞ —à–∞–±–ª–æ–Ω–∏** –¥–ª—è –≤–∫–∞–∑—É–≤–∞–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤.
* –©–æ–± –≤–∫–∞–∑–∞—Ç–∏ –¥–æ—Å—Ç—É–ø, —è–∫–∏–π –±—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–∞–π–ª –º–∞—Ç–∏–º–µ –¥–æ **—Ñ–∞–π–ª—ñ–≤**, –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Ç–∞–∫—ñ **–∫–æ–Ω—Ç—Ä–æ–ª—ñ –¥–æ—Å—Ç—É–ø—É**:
* **r** (—á–∏—Ç–∞–Ω–Ω—è)
* **w** (–∑–∞–ø–∏—Å)
* **m** (–≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–∞–º'—è—Ç—ñ —è–∫ –≤–∏–∫–æ–Ω—É–≤–∞–Ω–æ–≥–æ)
* **k** (–±–ª–æ–∫—É–≤–∞–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤)
* **l** (—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∂–æ—Ä—Å—Ç–∫–∏—Ö –ø–æ—Å–∏–ª–∞–Ω—å)
* **ix** (–≤–∏–∫–æ–Ω–∞—Ç–∏ —ñ–Ω—à—É –ø—Ä–æ–≥—Ä–∞–º—É –∑ –Ω–æ–≤–æ—é –ø—Ä–æ–≥—Ä–∞–º–æ—é, —â–æ —É—Å–ø–∞–¥–∫–æ–≤—É—î –ø–æ–ª—ñ—Ç–∏–∫—É)
* **Px** (–≤–∏–∫–æ–Ω–∞—Ç–∏ –ø—ñ–¥ —ñ–Ω—à–∏–º –ø—Ä–æ—Ñ—ñ–ª–µ–º, –ø—ñ—Å–ª—è –æ—á–∏—â–µ–Ω–Ω—è —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞)
* **Cx** (–≤–∏–∫–æ–Ω–∞—Ç–∏ –ø—ñ–¥ –¥–æ—á—ñ—Ä–Ω—ñ–º –ø—Ä–æ—Ñ—ñ–ª–µ–º, –ø—ñ—Å–ª—è –æ—á–∏—â–µ–Ω–Ω—è —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞)
* **Ux** (–≤–∏–∫–æ–Ω–∞—Ç–∏ –±–µ–∑ –æ–±–º–µ–∂–µ–Ω—å, –ø—ñ—Å–ª—è –æ—á–∏—â–µ–Ω–Ω—è —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞)
* **–ó–º—ñ–Ω–Ω—ñ** –º–æ–∂—É—Ç—å –±—É—Ç–∏ –≤–∏–∑–Ω–∞—á–µ–Ω—ñ –≤ –ø—Ä–æ—Ñ—ñ–ª—è—Ö —ñ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –∑–º—ñ–Ω–µ–Ω—ñ –∑–∑–æ–≤–Ω—ñ –ø—Ä–æ—Ñ—ñ–ª—é. –ù–∞–ø—Ä–∏–∫–ª–∞–¥: @{PROC} —Ç–∞ @{HOME} (–¥–æ–¥–∞–π—Ç–µ #include \<tunables/global> –¥–æ —Ñ–∞–π–ª—É –ø—Ä–æ—Ñ—ñ–ª—é)
* **–ü—Ä–∞–≤–∏–ª–∞ –∑–∞–±–æ—Ä–æ–Ω–∏ –ø—ñ–¥—Ç—Ä–∏–º—É—é—Ç—å—Å—è –¥–ª—è –ø–µ—Ä–µ–≤–∞–∂–∞–Ω–Ω—è –ø—Ä–∞–≤–∏–ª –¥–æ–∑–≤–æ–ª—É**.

### aa-genprof

–©–æ–± –ª–µ–≥–∫–æ –ø–æ—á–∞—Ç–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é, apparmor –º–æ–∂–µ –¥–æ–ø–æ–º–æ–≥—Ç–∏ –≤–∞–º. –ú–æ–∂–ª–∏–≤–æ, —â–æ–± **apparmor –ø–µ—Ä–µ–≤—ñ—Ä–∏–≤ –¥—ñ—ó, –≤–∏–∫–æ–Ω—É–≤–∞–Ω—ñ –±—ñ–Ω–∞—Ä–Ω–∏–º —Ñ–∞–π–ª–æ–º, –∞ –ø–æ—Ç—ñ–º –¥–æ–∑–≤–æ–ª–∏–≤ –≤–∞–º –≤–∏—Ä—ñ—à–∏—Ç–∏, —è–∫—ñ –¥—ñ—ó –≤–∏ —Ö–æ—á–µ—Ç–µ –¥–æ–∑–≤–æ–ª–∏—Ç–∏ –∞–±–æ –∑–∞–±–æ—Ä–æ–Ω–∏—Ç–∏**.\
–í–∞–º –ø—Ä–æ—Å—Ç–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤–∏–∫–æ–Ω–∞—Ç–∏:
```bash
sudo aa-genprof /path/to/binary
```
–¢–æ–¥—ñ –≤ —ñ–Ω—à—ñ–π –∫–æ–Ω—Å–æ–ª—ñ –≤–∏–∫–æ–Ω–∞–π—Ç–µ –≤—Å—ñ –¥—ñ—ó, —è–∫—ñ –∑–∞–∑–≤–∏—á–∞–π –≤–∏–∫–æ–Ω—É—î –¥–≤—ñ–π–∫–æ–≤–∏–π —Ñ–∞–π–ª:
```bash
/path/to/binary -a dosomething
```
–¢–æ–¥—ñ –≤ –ø–µ—Ä—à—ñ–π –∫–æ–Ω—Å–æ–ª—ñ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å "**s**", –∞ –ø–æ—Ç—ñ–º —É –∑–∞–ø–∏—Å–∞–Ω–∏—Ö –¥—ñ—è—Ö –≤–∫–∞–∂—ñ—Ç—å, —á–∏ —Ö–æ—á–µ—Ç–µ –≤–∏ —ñ–≥–Ω–æ—Ä—É–≤–∞—Ç–∏, –¥–æ–∑–≤–æ–ª–∏—Ç–∏ –∞–±–æ —â–æ—Å—å —ñ–Ω—à–µ. –ö–æ–ª–∏ –≤–∏ –∑–∞–∫—ñ–Ω—á–∏—Ç–µ, –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å "**f**", —ñ –Ω–æ–≤–∏–π –ø—Ä–æ—Ñ—ñ–ª—å –±—É–¥–µ —Å—Ç–≤–æ—Ä–µ–Ω–æ –≤ _/etc/apparmor.d/path.to.binary_

{% hint style="info" %}
–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –∫–ª–∞–≤—ñ—à—ñ —Å—Ç—Ä—ñ–ª–æ–∫, –≤–∏ –º–æ–∂–µ—Ç–µ –≤–∏–±—Ä–∞—Ç–∏, —â–æ —Ö–æ—á–µ—Ç–µ –¥–æ–∑–≤–æ–ª–∏—Ç–∏/–∑–∞–±–æ—Ä–æ–Ω–∏—Ç–∏/—â–æ—Å—å —ñ–Ω—à–µ
{% endhint %}

### aa-easyprof

–í–∏ —Ç–∞–∫–æ–∂ –º–æ–∂–µ—Ç–µ —Å—Ç–≤–æ—Ä–∏—Ç–∏ —à–∞–±–ª–æ–Ω –ø—Ä–æ—Ñ—ñ–ª—é apparmor –¥–ª—è –±—ñ–Ω–∞—Ä–Ω–æ–≥–æ —Ñ–∞–π–ª—É –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é:
```bash
sudo aa-easyprof /path/to/binary
# vim:syntax=apparmor
# AppArmor policy for binary
# ###AUTHOR###
# ###COPYRIGHT###
# ###COMMENT###

#include <tunables/global>

# No template variables specified

"/path/to/binary" {
#include <abstractions/base>

# No abstractions specified

# No policy groups specified

# No read paths specified

# No write paths specified
}
```
{% hint style="info" %}
–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º —É —Å—Ç–≤–æ—Ä–µ–Ω–æ–º—É –ø—Ä–æ—Ñ—ñ–ª—ñ –Ω—ñ—á–æ–≥–æ –Ω–µ –¥–æ–∑–≤–æ–ª–µ–Ω–æ, —Ç–æ–º—É –≤—Å–µ –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ. –í–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ –±—É–¥–µ –¥–æ–¥–∞—Ç–∏ —Ä—è–¥–∫–∏, —Ç–∞–∫—ñ —è–∫ `/etc/passwd r,`, —â–æ–± –¥–æ–∑–≤–æ–ª–∏—Ç–∏ –±—ñ–Ω–∞—Ä–Ω–æ–º—É —Ñ–∞–π–ª—É —á–∏—Ç–∞—Ç–∏ `/etc/passwd`, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥.
{% endhint %}

–í–∏ –º–æ–∂–µ—Ç–µ –ø–æ—Ç—ñ–º **–∑–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏** –Ω–æ–≤–∏–π –ø—Ä–æ—Ñ—ñ–ª—å –∑
```bash
sudo apparmor_parser -a /etc/apparmor.d/path.to.binary
```
### –ú–æ–¥–∏—Ñ—ñ–∫–∞—Ü—ñ—è –ø—Ä–æ—Ñ—ñ–ª—é –∑ –∂—É—Ä–Ω–∞–ª—ñ–≤

–ù–∞—Å—Ç—É–ø–Ω–∏–π —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø—Ä–æ—á–∏—Ç–∞—î –∂—É—Ä–Ω–∞–ª–∏ —Ç–∞ –∑–∞–ø–∏—Ç–∞—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, —á–∏ —Ö–æ—á–µ –≤—ñ–Ω –¥–æ–∑–≤–æ–ª–∏—Ç–∏ –¥–µ—è–∫—ñ –∑ –≤–∏—è–≤–ª–µ–Ω–∏—Ö –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–∏—Ö –¥—ñ–π:
```bash
sudo aa-logprof
```
{% hint style="info" %}
–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –∫–ª–∞–≤—ñ—à—ñ –∑—ñ —Å—Ç—Ä—ñ–ª–∫–∞–º–∏, –≤–∏ –º–æ–∂–µ—Ç–µ –≤–∏–±—Ä–∞—Ç–∏, —â–æ –≤–∏ —Ö–æ—á–µ—Ç–µ –¥–æ–∑–≤–æ–ª–∏—Ç–∏/–∑–∞–±–æ—Ä–æ–Ω–∏—Ç–∏/—â–æ –∑–∞–≤–≥–æ–¥–Ω–æ
{% endhint %}

### –ö–µ—Ä—É–≤–∞–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª–µ–º
```bash
#Main profile management commands
apparmor_parser -a /etc/apparmor.d/profile.name #Load a new profile in enforce mode
apparmor_parser -C /etc/apparmor.d/profile.name #Load a new profile in complain mode
apparmor_parser -r /etc/apparmor.d/profile.name #Replace existing profile
apparmor_parser -R /etc/apparmor.d/profile.name #Remove profile
```
## Logs

–ü—Ä–∏–∫–ª–∞–¥ **AUDIT** —Ç–∞ **DENIED** –∂—É—Ä–Ω–∞–ª—ñ–≤ –∑ _/var/log/audit/audit.log_ –≤–∏–∫–æ–Ω—É–≤–∞–Ω–æ–≥–æ —Ñ–∞–π–ª—É **`service_bin`**:
```bash
type=AVC msg=audit(1610061880.392:286): apparmor="AUDIT" operation="getattr" profile="/bin/rcat" name="/dev/pts/1" pid=954 comm="service_bin" requested_mask="r" fsuid=1000 ouid=1000
type=AVC msg=audit(1610061880.392:287): apparmor="DENIED" operation="open" profile="/bin/rcat" name="/etc/hosts" pid=954 comm="service_bin" requested_mask="r" denied_mask="r" fsuid=1000 ouid=0
```
–í–∏ —Ç–∞–∫–æ–∂ –º–æ–∂–µ—Ç–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ —Ü—é —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏:
```bash
sudo aa-notify -s 1 -v
Profile: /bin/service_bin
Operation: open
Name: /etc/passwd
Denied: r
Logfile: /var/log/audit/audit.log

Profile: /bin/service_bin
Operation: open
Name: /etc/hosts
Denied: r
Logfile: /var/log/audit/audit.log

AppArmor denials: 2 (since Wed Jan  6 23:51:08 2021)
For more information, please see: https://wiki.ubuntu.com/DebuggingApparmor
```
## Apparmor in Docker

–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —è–∫ –ø—Ä–æ—Ñ—ñ–ª—å **docker-profile** Docker –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î—Ç—å—Å—è –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º:
```bash
sudo aa-status
apparmor module is loaded.
50 profiles are loaded.
13 profiles are in enforce mode.
/sbin/dhclient
/usr/bin/lxc-start
/usr/lib/NetworkManager/nm-dhcp-client.action
/usr/lib/NetworkManager/nm-dhcp-helper
/usr/lib/chromium-browser/chromium-browser//browser_java
/usr/lib/chromium-browser/chromium-browser//browser_openjdk
/usr/lib/chromium-browser/chromium-browser//sanitized_helper
/usr/lib/connman/scripts/dhclient-script
docker-default
```
–ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º **–ø—Ä–æ—Ñ—ñ–ª—å docker-default Apparmor** –≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è –∑ [https://github.com/moby/moby/tree/master/profiles/apparmor](https://github.com/moby/moby/tree/master/profiles/apparmor)

**–†–µ–∑—é–º–µ –ø—Ä–æ—Ñ—ñ–ª—é docker-default**:

* **–î–æ—Å—Ç—É–ø** –¥–æ –≤—Å—ñ—Ö **–º–µ—Ä–µ–∂**
* **–ñ–æ–¥–Ω–∞ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å** –Ω–µ –≤–∏–∑–Ω–∞—á–µ–Ω–∞ (–û–¥–Ω–∞–∫ –¥–µ—è–∫—ñ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –±—É–¥—É—Ç—å –æ—Ç—Ä–∏–º–∞–Ω—ñ –∑ –≤–∫–ª—é—á–µ–Ω–Ω—è –±–∞–∑–æ–≤–∏—Ö –±–∞–∑–æ–≤–∏—Ö –ø—Ä–∞–≤–∏–ª, —Ç–æ–±—Ç–æ #include \<abstractions/base>)
* **–ó–∞–ø–∏—Å** —É –±—É–¥—å-—è–∫–∏–π **—Ñ–∞–π–ª /proc** **–Ω–µ –¥–æ–∑–≤–æ–ª–µ–Ω–æ**
* –Ü–Ω—à—ñ **–ø—ñ–¥–∫–∞—Ç–∞–ª–æ–≥–∏**/**—Ñ–∞–π–ª–∏** /**proc** —Ç–∞ /**sys** –º–∞—é—Ç—å **–∑–∞–±–æ—Ä–æ–Ω–µ–Ω–∏–π** –¥–æ—Å—Ç—É–ø –Ω–∞ —á–∏—Ç–∞–Ω–Ω—è/–∑–∞–ø–∏—Å/–±–ª–æ–∫—É–≤–∞–Ω–Ω—è/–ø–æ—Å–∏–ª–∞–Ω–Ω—è/–≤–∏–∫–æ–Ω–∞–Ω–Ω—è
* **–ú–æ–Ω—Ç—É–≤–∞–Ω–Ω—è** **–Ω–µ –¥–æ–∑–≤–æ–ª–µ–Ω–æ**
* **Ptrace** –º–æ–∂–µ –±—É—Ç–∏ –≤–∏–∫–æ–Ω–∞–Ω–æ –ª–∏—à–µ –Ω–∞ –ø—Ä–æ—Ü–µ—Å—ñ, —è–∫–∏–π –æ–±–º–µ–∂–µ–Ω–∏–π **—Ç–∏–º —Å–∞–º–∏–º –ø—Ä–æ—Ñ—ñ–ª–µ–º apparmor**

–Ø–∫—â–æ –≤–∏ **–∑–∞–ø—É—Å—Ç–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä docker**, –≤–∏ –ø–æ–≤–∏–Ω–Ω—ñ –ø–æ–±–∞—á–∏—Ç–∏ –Ω–∞—Å—Ç—É–ø–Ω–∏–π –≤–∏–≤—ñ–¥:
```bash
1 processes are in enforce mode.
docker-default (825)
```
–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ **apparmor –Ω–∞–≤—ñ—Ç—å –∑–∞–±–ª–æ–∫—É—î –ø—Ä–∏–≤—ñ–ª–µ—ó –º–æ–∂–ª–∏–≤–æ—Å—Ç–µ–π**, –Ω–∞–¥–∞–Ω—ñ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º. –ù–∞–ø—Ä–∏–∫–ª–∞–¥, –≤—ñ–Ω –∑–º–æ–∂–µ **–∑–∞–±–ª–æ–∫—É–≤–∞—Ç–∏ –¥–æ–∑–≤—ñ–ª –Ω–∞ –∑–∞–ø–∏—Å —É /proc, –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å SYS\_ADMIN –Ω–∞–¥–∞–Ω–∞**, –æ—Å–∫—ñ–ª—å–∫–∏ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –ø—Ä–æ—Ñ—ñ–ª—å apparmor docker –∑–∞–±–æ—Ä–æ–Ω—è—î —Ü–µ–π –¥–æ—Å—Ç—É–ø:
```bash
docker run -it --cap-add SYS_ADMIN --security-opt seccomp=unconfined ubuntu /bin/bash
echo "" > /proc/stat
sh: 1: cannot create /proc/stat: Permission denied
```
–í–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ **–≤–∏–º–∫–Ω—É—Ç–∏ apparmor**, —â–æ–± –æ–±—ñ–π—Ç–∏ –π–æ–≥–æ –æ–±–º–µ–∂–µ–Ω–Ω—è:
```bash
docker run -it --cap-add SYS_ADMIN --security-opt seccomp=unconfined --security-opt apparmor=unconfined ubuntu /bin/bash
```
–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º **AppArmor** —Ç–∞–∫–æ–∂ **–∑–∞–±–æ—Ä–æ–Ω–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É –º–æ–Ω—Ç—É–≤–∞—Ç–∏** –ø–∞–ø–∫–∏ –∑—Å–µ—Ä–µ–¥–∏–Ω–∏, –Ω–∞–≤—ñ—Ç—å –∑ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—é SYS\_ADMIN.

–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ –≤–∏ –º–æ–∂–µ—Ç–µ **–¥–æ–¥–∞—Ç–∏/–≤–∏–¥–∞–ª–∏—Ç–∏** **–º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ** –¥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ docker (—Ü–µ –≤—Å–µ —â–µ –±—É–¥–µ –æ–±–º–µ–∂–µ–Ω–æ –º–µ—Ç–æ–¥–∞–º–∏ –∑–∞—Ö–∏—Å—Ç—É, —Ç–∞–∫–∏–º–∏ —è–∫ **AppArmor** —Ç–∞ **Seccomp**):

* `--cap-add=SYS_ADMIN` –Ω–∞–¥–∞—î –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å `SYS_ADMIN`
* `--cap-add=ALL` –Ω–∞–¥–∞—î –≤—Å—ñ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ
* `--cap-drop=ALL --cap-add=SYS_PTRACE` —Å–∫–∏–¥–∞—î –≤—Å—ñ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ —Ç–∞ –Ω–∞–¥–∞—î –ª–∏—à–µ `SYS_PTRACE`

{% hint style="info" %}
–ó–∞–∑–≤–∏—á–∞–π, –∫–æ–ª–∏ –≤–∏ **–∑–Ω–∞—Ö–æ–¥–∏—Ç–µ**, —â–æ —É –≤–∞—Å —î **–ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω–∞ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å** –¥–æ—Å—Ç—É–ø–Ω–∞ **–≤—Å–µ—Ä–µ–¥–∏–Ω—ñ** –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ **docker**, **–∞–ª–µ** –¥–µ—è–∫–∞ —á–∞—Å—Ç–∏–Ω–∞ **–µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—ó –Ω–µ –ø—Ä–∞—Ü—é—î**, —Ü–µ –±—É–¥–µ —Ç–æ–º—É, —â–æ **apparmor docker –∑–∞–≤–∞–∂–∞—î —Ü—å–æ–º—É**.
{% endhint %}

### –ü—Ä–∏–∫–ª–∞–¥

(–ü—Ä–∏–∫–ª–∞–¥ –∑ [**—Ç—É—Ç**](https://sreeninet.wordpress.com/2016/03/06/docker-security-part-2docker-engine/))

–©–æ–± –ø—Ä–æ—ñ–ª—é—Å—Ç—Ä—É–≤–∞—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω—ñ—Å—Ç—å AppArmor, —è —Å—Ç–≤–æ—Ä–∏–≤ –Ω–æ–≤–∏–π –ø—Ä–æ—Ñ—ñ–ª—å Docker ‚Äúmydocker‚Äù –∑ –¥–æ–¥–∞–Ω–∏–º –Ω–∞—Å—Ç—É–ø–Ω–∏–º —Ä—è–¥–∫–æ–º:
```
deny /etc/* w,   # deny write for all files directly in /etc (not in a subdir)
```
–©–æ–± –∞–∫—Ç–∏–≤—É–≤–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å, –Ω–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑—Ä–æ–±–∏—Ç–∏ –Ω–∞—Å—Ç—É–ø–Ω–µ:
```
sudo apparmor_parser -r -W mydocker
```
–©–æ–± –ø–µ—Ä–µ—Ä–∞—Ö—É–≤–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—ñ, –º–∏ –º–æ–∂–µ–º–æ –≤–∏–∫–æ–Ω–∞—Ç–∏ –Ω–∞—Å—Ç—É–ø–Ω—É –∫–æ–º–∞–Ω–¥—É. –ù–∞–≤–µ–¥–µ–Ω–∞ –Ω–∏–∂—á–µ –∫–æ–º–∞–Ω–¥–∞ –ø–µ—Ä–µ—Ä–∞—Ö–æ–≤—É—î –º—ñ–π –Ω–æ–≤–∏–π –ø—Ä–æ—Ñ—ñ–ª—å AppArmor.
```
$ sudo apparmor_status  | grep mydocker
mydocker
```
–Ø–∫ –ø–æ–∫–∞–∑–∞–Ω–æ –Ω–∏–∂—á–µ, –º–∏ –æ—Ç—Ä–∏–º—É—î–º–æ –ø–æ–º–∏–ª–∫—É, –∫–æ–ª–∏ –Ω–∞–º–∞–≥–∞—î–º–æ—Å—è –∑–º—ñ–Ω–∏—Ç–∏ ‚Äú/etc/‚Äù, –æ—Å–∫—ñ–ª—å–∫–∏ –ø—Ä–æ—Ñ—ñ–ª—å AppArmor –∑–∞–≤–∞–∂–∞—î –∑–∞–ø–∏—Å—É –≤ ‚Äú/etc‚Äù.
```
$ docker run --rm -it --security-opt apparmor:mydocker -v ~/haproxy:/localhost busybox chmod 400 /etc/hostname
chmod: /etc/hostname: Permission denied
```
### AppArmor Docker Bypass1

–í–∏ –º–æ–∂–µ—Ç–µ –¥—ñ–∑–Ω–∞—Ç–∏—Å—è, —è–∫–∏–π **–ø—Ä–æ—Ñ—ñ–ª—å apparmor –≤–∏–∫–æ–Ω—É—î –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä**, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏:
```bash
docker inspect 9d622d73a614 | grep lowpriv
"AppArmorProfile": "lowpriv",
"apparmor=lowpriv"
```
–¢–æ–¥—ñ –≤–∏ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ–Ω–∞—Ç–∏ –Ω–∞—Å—Ç—É–ø–Ω–∏–π —Ä—è–¥–æ–∫, —â–æ–± **–∑–Ω–∞–π—Ç–∏ —Ç–æ—á–Ω–∏–π –ø—Ä–æ—Ñ—ñ–ª—å, —â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è**:
```bash
find /etc/apparmor.d/ -name "*lowpriv*" -maxdepth 1 2>/dev/null
```
–£ –¥–∏–≤–Ω–æ–º—É –≤–∏–ø–∞–¥–∫—É –≤–∏ –º–æ–∂–µ—Ç–µ **–∑–º—ñ–Ω–∏—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å apparmor docker —ñ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –π–æ–≥–æ.** –í–∏ –º–æ–≥–ª–∏ –± –≤–∏–¥–∞–ª–∏—Ç–∏ –æ–±–º–µ–∂–µ–Ω–Ω—è —ñ "–æ–±—ñ–π—Ç–∏" —ó—Ö.

### AppArmor Docker Bypass2

**AppArmor –±–∞–∑—É—î—Ç—å—Å—è –Ω–∞ —à–ª—è—Ö—É**, —Ü–µ –æ–∑–Ω–∞—á–∞—î, —â–æ –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –≤—ñ–Ω –º–æ–∂–µ **–∑–∞—Ö–∏—â–∞—Ç–∏** —Ñ–∞–π–ª–∏ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –∫–∞—Ç–∞–ª–æ–≥—É, —è–∫ **`/proc`**, —è–∫—â–æ –≤–∏ –º–æ–∂–µ—Ç–µ **–Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏, —è–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –±—É–¥–µ –∑–∞–ø—É—â–µ–Ω–æ**, –≤–∏ –º–æ–≥–ª–∏ –± **–º–æ–Ω—Ç—É–≤–∞—Ç–∏** –∫–∞—Ç–∞–ª–æ–≥ proc —Ö–æ—Å—Ç–∞ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ **`/host/proc`** —ñ –≤—ñ–Ω **–±—ñ–ª—å—à–µ –Ω–µ –±—É–¥–µ –∑–∞—Ö–∏—â–µ–Ω–∏–π AppArmor**.

### AppArmor Shebang Bypass

–£ [**—Ü—å–æ–º—É –±–∞–≥—É**](https://bugs.launchpad.net/apparmor/+bug/1911431) –≤–∏ –º–æ–∂–µ—Ç–µ –ø–æ–±–∞—á–∏—Ç–∏ –ø—Ä–∏–∫–ª–∞–¥ —Ç–æ–≥–æ, —è–∫ **–Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –≤–∏ –∑–∞–≤–∞–∂–∞—î—Ç–µ –≤–∏–∫–æ–Ω–∞–Ω–Ω—é perl –∑ –ø–µ–≤–Ω–∏–º–∏ —Ä–µ—Å—É—Ä—Å–∞–º–∏**, —è–∫—â–æ –≤–∏ –ø—Ä–æ—Å—Ç–æ —Å—Ç–≤–æ—Ä–∏—Ç–µ –æ–±–æ–ª–æ–Ω–∫–æ–≤–∏–π —Å–∫—Ä–∏–ø—Ç **–≤–∫–∞–∑—É—é—á–∏** –≤ –ø–µ—Ä—à–æ–º—É —Ä—è–¥–∫—É **`#!/usr/bin/perl`** —ñ –≤–∏ **–≤–∏–∫–æ–Ω–∞—î—Ç–µ —Ñ–∞–π–ª –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ**, –≤–∏ –∑–º–æ–∂–µ—Ç–µ –≤–∏–∫–æ–Ω–∞—Ç–∏ —â–æ –∑–∞–≤–≥–æ–¥–Ω–æ. –ù–∞–ø—Ä–∏–∫–ª–∞–¥:
```perl
echo '#!/usr/bin/perl
use POSIX qw(strftime);
use POSIX qw(setuid);
POSIX::setuid(0);
exec "/bin/sh"' > /tmp/test.pl
chmod +x /tmp/test.pl
/tmp/test.pl
```
{% hint style="success" %}
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>–ü—ñ–¥—Ç—Ä–∏–º–∞–π—Ç–µ HackTricks</summary>

* –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ø–ª–∞–Ω–∏ –ø—ñ–¥–ø–∏—Å–∫–∏**](https://github.com/sponsors/carlospolop)!
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –≤ **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **–î—ñ–ª—ñ—Ç—å—Å—è —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –Ω–∞–¥—Å–∏–ª–∞—é—á–∏ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ –Ω–∞ github.

</details>
{% endhint %}
