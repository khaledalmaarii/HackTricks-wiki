# macOS Red Teaming

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## MDM рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ

* JAMF Pro: `jamf checkJSSConnection`
* Kandji

рдпрджрд┐ рдЖрдк рдкреНрд░рдмрдВрдзрди рдкреНрд▓реЗрдЯрдлрд╝реЙрд░реНрдо рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХреЗ рд▓рд┐рдП **рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рд╕реЗ рд╕рдордЭреМрддрд╛ рдХрд░рдиреЗ** рдореЗрдВ рд╕рдлрд▓ рд╣реЛрддреЗ рд╣реИрдВ, рддреЛ рдЖрдк рдорд╢реАрдиреЛрдВ рдореЗрдВ рдЕрдкрдиреЗ рдореИрд▓рд╡реЗрдпрд░ рдХреЛ рд╡рд┐рддрд░рд┐рдд рдХрд░рдХреЗ **рд╕рднреА рдХрдВрдкреНрдпреВрдЯрд░реЛрдВ рд╕реЗ рд╕рдордЭреМрддрд╛ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**ред

MacOS рд╡рд╛рддрд╛рд╡рд░рдг рдореЗрдВ рд░реЗрдб рдЯреАрдорд┐рдВрдЧ рдХреЗ рд▓рд┐рдП MDMs рдХреЗ рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рддрд░реАрдХреЗ рдХреА рдХреБрдЫ рд╕рдордЭ рд╣реЛрдирд╛ рдЕрддреНрдпрдзрд┐рдХ рдЕрдиреБрд╢рдВрд╕рд┐рдд рд╣реИ:

{% content-ref url="macos-mdm/" %}
[macos-mdm](macos-mdm/)
{% endcontent-ref %}

### C2 рдХреЗ рд░реВрдк рдореЗрдВ MDM рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛

рдПрдХ MDM рдХреЗ рдкрд╛рд╕ рдкреНрд░реЛрдлрд╛рдЗрд▓ рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдиреЗ, рдХреНрд╡реЗрд░реА рдХрд░рдиреЗ рдпрд╛ рд╣рдЯрд╛рдиреЗ, рдПрдкреНрд▓рд┐рдХреЗрд╢рди рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдиреЗ, рд╕реНрдерд╛рдиреАрдп рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ рдЦрд╛рддреЗ рдмрдирд╛рдиреЗ, рдлрд░реНрдорд╡реЗрдпрд░ рдкрд╛рд╕рд╡рд░реНрдб рд╕реЗрдЯ рдХрд░рдиреЗ, FileVault рдХреБрдВрдЬреА рдмрджрд▓рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реЛрдЧреА...

рдЕрдкрдиреЗ рд╕реНрд╡рдпрдВ рдХреЗ MDM рдХреЛ рдЪрд▓рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ **рдЕрдкрдиреЗ CSR рдХреЛ рдПрдХ рд╡рд┐рдХреНрд░реЗрддрд╛ рджреНрд╡рд╛рд░рд╛ рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд** рдХрд░рд╛рдирд╛ рд╣реЛрдЧрд╛, рдЬрд┐рд╕реЗ рдЖрдк [**https://mdmcert.download/**](https://mdmcert.download/) рдХреЗ рд╕рд╛рде рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдФрд░ Apple рдЙрдкрдХрд░рдгреЛрдВ рдХреЗ рд▓рд┐рдП рдЕрдкрдиреЗ рд╕реНрд╡рдпрдВ рдХреЗ MDM рдХреЛ рдЪрд▓рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдк [**MicroMDM**](https://github.com/micromdm/micromdm) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

рд╣рд╛рд▓рд╛рдВрдХрд┐, рдПрдХ рдирд╛рдорд╛рдВрдХрд┐рдд рдЙрдкрдХрд░рдг рдореЗрдВ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдЖрдкрдХреЛ рдЗрд╕реЗ рдПрдХ рдбреЗрд╡рд▓рдкрд░ рдЦрд╛рддреЗ рджреНрд╡рд╛рд░рд╛ рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ... рд╣рд╛рд▓рд╛рдБрдХрд┐, MDM рдирд╛рдорд╛рдВрдХрди рдХреЗ рджреМрд░рд╛рди **рдЙрдкрдХрд░рдг MDM рдХреЗ SSL рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреЛ рдПрдХ рд╡рд┐рд╢реНрд╡рд╕рдиреАрдп CA рдХреЗ рд░реВрдк рдореЗрдВ рдЬреЛрдбрд╝рддрд╛ рд╣реИ**, рдЗрд╕рд▓рд┐рдП рдЖрдк рдЕрдм рдХреБрдЫ рднреА рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

рдЙрдкрдХрд░рдг рдХреЛ MDM рдореЗрдВ рдирд╛рдорд╛рдВрдХрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдЖрдкрдХреЛ рдПрдХ **`mobileconfig`** рдлрд╝рд╛рдЗрд▓ рдХреЛ рд░реВрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдирд╛ рд╣реЛрдЧрд╛, рдЬрд┐рд╕реЗ рдПрдХ **pkg** рдлрд╝рд╛рдЗрд▓ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╡рд┐рддрд░рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ (рдЖрдк рдЗрд╕реЗ рдЬрд╝рд┐рдк рдореЗрдВ рд╕рдВрдХреБрдЪрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЬрдм рдЗрд╕реЗ рд╕рдлрд╛рд░реА рд╕реЗ рдбрд╛рдЙрдирд▓реЛрдб рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ рддреЛ рдпрд╣ рдЕрдирдЬрд┐рдк рд╣реЛ рдЬрд╛рдПрдЧрд╛)ред

**Mythic рдПрдЬреЗрдВрдЯ Orthrus** рдЗрд╕ рддрдХрдиреАрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИред

### JAMF PRO рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ

JAMF **рдХрд╕реНрдЯрдо рд╕реНрдХреНрд░рд┐рдкреНрдЯ** (рд╕рд┐рд╕реНрдЯрдо рдкреНрд░рд╢рд╛рд╕рдХ рджреНрд╡рд╛рд░рд╛ рд╡рд┐рдХрд╕рд┐рдд рд╕реНрдХреНрд░рд┐рдкреНрдЯ), **рд╕реНрдерд╛рдиреАрдп рдкреЗрд▓реЛрдб** (рд╕реНрдерд╛рдиреАрдп рдЦрд╛рддрд╛ рдирд┐рд░реНрдорд╛рдг, EFI рдкрд╛рд╕рд╡рд░реНрдб рд╕реЗрдЯ рдХрд░рдирд╛, рдлрд╝рд╛рдЗрд▓/рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдирд┐рдЧрд░рд╛рдиреА...) рдФрд░ **MDM** (рдЙрдкрдХрд░рдг рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди, рдЙрдкрдХрд░рдг рдкреНрд░рдорд╛рдгрдкрддреНрд░...) рдЪрд▓рд╛ рд╕рдХрддрд╛ рд╣реИред

#### JAMF рд╕реНрд╡-рдирд╛рдорд╛рдВрдХрди

рдЬрд╛рдВрдЪреЗрдВ рдХрд┐ рдХреНрдпрд╛ рдЙрдирдХреЗ рдкрд╛рд╕ **рд╕реНрд╡-рдирд╛рдорд╛рдВрдХрди рд╕рдХреНрд╖рдо** рд╣реИ, рдЗрд╕рдХреЗ рд▓рд┐рдП `https://<company-name>.jamfcloud.com/enroll/` рдЬреИрд╕реЗ рдкреГрд╖реНрда рдкрд░ рдЬрд╛рдПрдВред рдпрджрд┐ рдЙрдирдХреЗ рдкрд╛рд╕ рд╣реИ, рддреЛ рдпрд╣ **рдкрд╣реБрдБрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕** рдорд╛рдВрдЧ рд╕рдХрддрд╛ рд╣реИред

рдЖрдк рдкрд╛рд╕рд╡рд░реНрдб рд╕реНрдкреНрд░реЗрдЗрдВрдЧ рд╣рдорд▓реЗ рдХреЛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕реНрдХреНрд░рд┐рдкреНрдЯ [**JamfSniper.py**](https://github.com/WithSecureLabs/Jamf-Attack-Toolkit/blob/master/JamfSniper.py) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдЙрдЪрд┐рдд рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдЦреЛрдЬрдиреЗ рдХреЗ рдмрд╛рдж, рдЖрдк рдЕрдЧрд▓реЗ рдлреЙрд░реНрдо рдХреЗ рд╕рд╛рде рдЕрдиреНрдп рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдореЛрдВ рдХреЛ рдмреНрд░реВрдЯ-рдлреЛрд░реНрд╕ рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ:

![](<../../.gitbook/assets/image (107).png>)

#### JAMF рдЙрдкрдХрд░рдг рдкреНрд░рдорд╛рдгреАрдХрд░рдг

<figure><img src="../../.gitbook/assets/image (167).png" alt=""><figcaption></figcaption></figure>

**`jamf`** рдмрд╛рдЗрдирд░реА рдореЗрдВ рдХреАрдЪреЗрди рдХреЛ рдЦреЛрд▓рдиреЗ рдХрд╛ рд░рд╣рд╕реНрдп рдерд╛ рдЬреЛ рдЦреЛрдЬ рдХреЗ рд╕рдордп рд╕рднреА рдХреЗ рдмреАрдЪ **рд╕рд╛рдЭрд╛** рдерд╛ рдФрд░ рдпрд╣ рдерд╛: **`jk23ucnq91jfu9aj`**ред\
рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, jamf **`/Library/LaunchAgents/com.jamf.management.agent.plist`** рдореЗрдВ **LaunchDaemon** рдХреЗ рд░реВрдк рдореЗрдВ **рд╕реНрдерд╛рдпреА** рд░рд╣рддрд╛ рд╣реИред

#### JAMF рдЙрдкрдХрд░рдг рдЕрдзрд┐рдЧреНрд░рд╣рдг

**JSS** (Jamf рд╕реЙрдлрд╝реНрдЯрд╡реЗрдпрд░ рд╕рд░реНрд╡рд░) **URL** рдЬреЛ **`jamf`** рдЙрдкрдпреЛрдЧ рдХрд░реЗрдЧрд╛, рд╡рд╣ **`/Library/Preferences/com.jamfsoftware.jamf.plist`** рдореЗрдВ рд╕реНрдерд┐рдд рд╣реИред\
рдпрд╣ рдлрд╝рд╛рдЗрд▓ рдореВрд▓ рд░реВрдк рд╕реЗ URL рдХреЛ рд╕рдорд╛рд╣рд┐рдд рдХрд░рддреА рд╣реИ:

{% code overflow="wrap" %}
```bash
plutil -convert xml1 -o - /Library/Preferences/com.jamfsoftware.jamf.plist

[...]
<key>is_virtual_machine</key>
<false/>
<key>jss_url</key>
<string>https://halbornasd.jamfcloud.com/</string>
<key>last_management_framework_change_id</key>
<integer>4</integer>
[...]
```
{% endcode %}

рддреЛ, рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдПрдХ рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг рдкреИрдХреЗрдЬ (`pkg`) рдЫреЛрдбрд╝ рд╕рдХрддрд╛ рд╣реИ рдЬреЛ рд╕реНрдерд╛рдкрд┐рдд рд╣реЛрдиреЗ рдкрд░ **рдЗрд╕ рдлрд╝рд╛рдЗрд▓ рдХреЛ рдЕрдзрд┐рд▓реЗрдЦрд┐рдд рдХрд░рддрд╛ рд╣реИ** рдФрд░ **URL рдХреЛ рдПрдХ Mythic C2 рд╢реНрд░реЛрддрд╛ рд╕реЗ Typhon рдПрдЬреЗрдВрдЯ** рдХреЗ рд░реВрдк рдореЗрдВ рд╕реЗрдЯ рдХрд░рддрд╛ рд╣реИ рддрд╛рдХрд┐ рдЕрдм JAMF рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ C2 рдХреЗ рд░реВрдк рдореЗрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред

{% code overflow="wrap" %}
```bash
# After changing the URL you could wait for it to be reloaded or execute:
sudo jamf policy -id 0

# TODO: There is an ID, maybe it's possible to have the real jamf connection and another one to the C2
```
{% endcode %}

#### JAMF рдзреЛрдЦрд╛рдзрдбрд╝реА

рдПрдХ рдбрд┐рд╡рд╛рдЗрд╕ рдФрд░ JMF рдХреЗ рдмреАрдЪ **рдзреЛрдЦрд╛рдзрдбрд╝реА рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП** рдЖрдкрдХреЛ рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ:

* рдбрд┐рд╡рд╛рдЗрд╕ рдХрд╛ **UUID**: `ioreg -d2 -c IOPlatformExpertDevice | awk -F" '/IOPlatformUUID/{print $(NF-1)}'`
* **JAMF рдХреАрдЪреЗрди**: `/Library/Application\ Support/Jamf/JAMF.keychain` рдЬрд┐рд╕рдореЗрдВ рдбрд┐рд╡рд╛рдЗрд╕ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рд╣реЛрддрд╛ рд╣реИ

рдЗрд╕ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд╕рд╛рде, **рдПрдХ VM рдмрдирд╛рдПрдВ** рдЬрд┐рд╕рдореЗрдВ **рдЪреБрд░рд╛рдпрд╛ рдЧрдпрд╛** рд╣рд╛рд░реНрдбрд╡реЗрдпрд░ **UUID** рд╣реЛ рдФрд░ **SIP рдЕрдХреНрд╖рдо** рд╣реЛ, **JAMF рдХреАрдЪреЗрди** рдбрд╛рд▓реЗрдВ, **рдЬрд╛рдореНрдл рдПрдЬреЗрдВрдЯ** рдХреЛ **рд╣реБрдХ** рдХрд░реЗрдВ рдФрд░ рдЗрд╕рдХреА рдЬрд╛рдирдХрд╛рд░реА рдЪреБрд░рд╛рдПрдВред

#### рд░рд╣рд╕реНрдпреЛрдВ рдХреА рдЪреЛрд░реА

<figure><img src="../../.gitbook/assets/image (1025).png" alt=""><figcaption><p>a</p></figcaption></figure>

рдЖрдк `/Library/Application Support/Jamf/tmp/` рд╕реНрдерд╛рди рдХреА рдирд┐рдЧрд░рд╛рдиреА рднреА рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд╣рд╛рдБ **рдХрд╕реНрдЯрдо рд╕реНрдХреНрд░рд┐рдкреНрдЯ** рд╣реЛ рд╕рдХрддреА рд╣реИрдВ рдЬрд┐рдиреНрд╣реЗрдВ рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ Jamf рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХреНрдпреЛрдВрдХрд┐ рдпреЗ **рдпрд╣рд╛рдБ рд░рдЦреА рдЬрд╛рддреА рд╣реИрдВ, рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХреА рдЬрд╛рддреА рд╣реИрдВ рдФрд░ рд╣рдЯрд╛ рджреА рдЬрд╛рддреА рд╣реИрдВ**ред рдпреЗ рд╕реНрдХреНрд░рд┐рдкреНрдЯ **рдкреНрд░рдорд╛рдг рдкрддреНрд░** рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВред

рд╣рд╛рд▓рд╛рдВрдХрд┐, **рдкреНрд░рдорд╛рдг рдкрддреНрд░** рдЗрди рд╕реНрдХреНрд░рд┐рдкреНрдЯреЛрдВ рдореЗрдВ **рдкреИрд░рд╛рдореАрдЯрд░** рдХреЗ рд░реВрдк рдореЗрдВ рдкрд╛рд╕ рдХрд┐рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП рдЖрдкрдХреЛ `ps aux | grep -i jamf` рдХреА рдирд┐рдЧрд░рд╛рдиреА рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрдЧреА (рдмрд┐рдирд╛ рд░реВрдЯ рдмрдиреЗ)ред

рд╕реНрдХреНрд░рд┐рдкреНрдЯ [**JamfExplorer.py**](https://github.com/WithSecureLabs/Jamf-Attack-Toolkit/blob/master/JamfExplorer.py) рдирдП рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЛ рдЬреЛрдбрд╝реЗ рдЬрд╛рдиреЗ рдФрд░ рдирдП рдкреНрд░рдХреНрд░рд┐рдпрд╛ рддрд░реНрдХреЛрдВ рдХреЗ рд▓рд┐рдП рд╕реБрди рд╕рдХрддреА рд╣реИред

### macOS рджреВрд░рд╕реНрде рдкрд╣реБрдВрдЪ

рдФрд░ **MacOS** "рд╡рд┐рд╢реЗрд╖" **рдиреЗрдЯрд╡рд░реНрдХ** **рдкреНрд░реЛрдЯреЛрдХреЙрд▓** рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ:

{% content-ref url="../macos-security-and-privilege-escalation/macos-protocols.md" %}
[macos-protocols.md](../macos-security-and-privilege-escalation/macos-protocols.md)
{% endcontent-ref %}

## рд╕рдХреНрд░рд┐рдп рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛

рдХреБрдЫ рдЕрд╡рд╕рд░реЛрдВ рдкрд░ рдЖрдк рдкрд╛рдПрдВрдЧреЗ рдХрд┐ **MacOS рдХрдВрдкреНрдпреВрдЯрд░ рдПрдХ AD рд╕реЗ рдЬреБрдбрд╝рд╛ рд╣реБрдЖ рд╣реИ**ред рдЗрд╕ рдкрд░рд┐рджреГрд╢реНрдп рдореЗрдВ, рдЖрдкрдХреЛ рд╕рдХреНрд░рд┐рдп рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдХреЛ **рдЧрдгрдирд╛** рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП рдЬреИрд╕рд╛ рдХрд┐ рдЖрдк рдЗрд╕рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВред рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдкреГрд╖реНрдареЛрдВ рдореЗрдВ рдХреБрдЫ **рд╕рд╣рд╛рдпрддрд╛** рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ:

{% content-ref url="../../network-services-pentesting/pentesting-ldap.md" %}
[pentesting-ldap.md](../../network-services-pentesting/pentesting-ldap.md)
{% endcontent-ref %}

{% content-ref url="../../windows-hardening/active-directory-methodology/" %}
[active-directory-methodology](../../windows-hardening/active-directory-methodology/)
{% endcontent-ref %}

{% content-ref url="../../network-services-pentesting/pentesting-kerberos-88/" %}
[pentesting-kerberos-88](../../network-services-pentesting/pentesting-kerberos-88/)
{% endcontent-ref %}

рдХреБрдЫ **рд╕реНрдерд╛рдиреАрдп MacOS рдЙрдкрдХрд░рдг** рдЬреЛ рдЖрдкрдХреА рдорджрдж рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рд╡рд╣ рд╣реИ `dscl`:
```bash
dscl "/Active Directory/[Domain]/All Domains" ls /
```
Also there are some tools prepared for MacOS to automatically enumerate the AD and play with kerberos:

* [**Machound**](https://github.com/XMCyber/MacHound): MacHound рдПрдХ Bloodhound рдСрдбрд┐рдЯрд┐рдВрдЧ рдЯреВрд▓ рдХрд╛ рдПрдХреНрд╕рдЯреЗрдВрд╢рди рд╣реИ рдЬреЛ MacOS рд╣реЛрд╕реНрдЯ рдкрд░ Active Directory рд╕рдВрдмрдВрдзреЛрдВ рдХреЛ рдЗрдХрдЯреНрдард╛ рдХрд░рдиреЗ рдФрд░ рдЧреНрд░рд╣рдг рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред
* [**Bifrost**](https://github.com/its-a-feature/bifrost): Bifrost рдПрдХ Objective-C рдкреНрд░реЛрдЬреЗрдХреНрдЯ рд╣реИ рдЬрд┐рд╕реЗ macOS рдкрд░ Heimdal krb5 APIs рдХреЗ рд╕рд╛рде рдЗрдВрдЯрд░реИрдХреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдбрд┐рдЬрд╝рд╛рдЗрди рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред рдЗрд╕ рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдХрд╛ рд▓рдХреНрд╖реНрдп macOS рдЙрдкрдХрд░рдгреЛрдВ рдкрд░ Kerberos рдХреЗ рдЪрд╛рд░реЛрдВ рдУрд░ рдмреЗрд╣рддрд░ рд╕реБрд░рдХреНрд╖рд╛ рдкрд░реАрдХреНрд╖рдг рд╕рдХреНрд╖рдо рдХрд░рдирд╛ рд╣реИ, рдЬреЛ рдХрд┐ рдХрд┐рд╕реА рдЕрдиреНрдп рдлреНрд░реЗрдорд╡рд░реНрдХ рдпрд╛ рдкреИрдХреЗрдЬ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдХреЗ рдмрд┐рдирд╛ рдореВрд▓ APIs рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИред
* [**Orchard**](https://github.com/its-a-feature/Orchard): Active Directory рдПрдиреНрдпреВрдорд░реЗрд╢рди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП Automation (JXA) рдЯреВрд▓ред

### Domain Information
```bash
echo show com.apple.opendirectoryd.ActiveDirectory | scutil
```
### Users

MacOS рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЗ рддреАрди рдкреНрд░рдХрд╛рд░ рд╣реИрдВ:

* **рд╕реНрдерд╛рдиреАрдп рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛** тАФ рд╕реНрдерд╛рдиреАрдп OpenDirectory рд╕реЗрд╡рд╛ рджреНрд╡рд╛рд░рд╛ рдкреНрд░рдмрдВрдзрд┐рдд, рдпреЗ рдХрд┐рд╕реА рднреА рддрд░рд╣ рд╕реЗ Active Directory рд╕реЗ рдЬреБрдбрд╝реЗ рдирд╣реАрдВ рд╣реИрдВред
* **рдиреЗрдЯрд╡рд░реНрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛** тАФ рдЕрд╕реНрдерд╛рдпреА Active Directory рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЬрд┐рдиреНрд╣реЗрдВ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рд▓рд┐рдП DC рд╕рд░реНрд╡рд░ рд╕реЗ рдХрдиреЗрдХреНрд╢рди рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред
* **рдореЛрдмрд╛рдЗрд▓ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛** тАФ Active Directory рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЬрд┐рдирдХреЗ рдкрд╛рд╕ рдЙрдирдХреЗ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдФрд░ рдлрд╝рд╛рдЗрд▓реЛрдВ рдХрд╛ рд╕реНрдерд╛рдиреАрдп рдмреИрдХрдЕрдк рд╣реЛрддрд╛ рд╣реИред

рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдФрд░ рд╕рдореВрд╣реЛрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рд╕реНрдерд╛рдиреАрдп рдЬрд╛рдирдХрд╛рд░реА рдлрд╝реЛрд▓реНрдбрд░ _/var/db/dslocal/nodes/Default._ рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рд╣реЛрддреА рд╣реИред\
рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, _mark_ рдирд╛рдо рдХреЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА рдЬрд╛рдирдХрд╛рд░реА _/var/db/dslocal/nodes/Default/users/mark.plist_ рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рд╣реЛрддреА рд╣реИ рдФрд░ рд╕рдореВрд╣ _admin_ рдХреА рдЬрд╛рдирдХрд╛рд░реА _/var/db/dslocal/nodes/Default/groups/admin.plist_ рдореЗрдВ рд╣реЛрддреА рд╣реИред

HasSession рдФрд░ AdminTo рдХрд┐рдирд╛рд░реЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рдЕрд▓рд╛рд╡рд╛, **MacHound Bloodhound рдбреЗрдЯрд╛рдмреЗрд╕ рдореЗрдВ рддреАрди рдирдП рдХрд┐рдирд╛рд░реЗ рдЬреЛрдбрд╝рддрд╛ рд╣реИ**:

* **CanSSH** - рдЗрдХрд╛рдИ рдХреЛ рд╣реЛрд╕реНрдЯ рдкрд░ SSH рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реИ
* **CanVNC** - рдЗрдХрд╛рдИ рдХреЛ рд╣реЛрд╕реНрдЯ рдкрд░ VNC рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реИ
* **CanAE** - рдЗрдХрд╛рдИ рдХреЛ рд╣реЛрд╕реНрдЯ рдкрд░ AppleEvent рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реИ
```bash
#User enumeration
dscl . ls /Users
dscl . read /Users/[username]
dscl "/Active Directory/TEST/All Domains" ls /Users
dscl "/Active Directory/TEST/All Domains" read /Users/[username]
dscacheutil -q user

#Computer enumeration
dscl "/Active Directory/TEST/All Domains" ls /Computers
dscl "/Active Directory/TEST/All Domains" read "/Computers/[compname]$"

#Group enumeration
dscl . ls /Groups
dscl . read "/Groups/[groupname]"
dscl "/Active Directory/TEST/All Domains" ls /Groups
dscl "/Active Directory/TEST/All Domains" read "/Groups/[groupname]"

#Domain Information
dsconfigad -show
```
рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП [https://its-a-feature.github.io/posts/2018/01/Active-Directory-Discovery-with-a-Mac/](https://its-a-feature.github.io/posts/2018/01/Active-Directory-Discovery-with-a-Mac/)

### Computer$ рдкрд╛рд╕рд╡рд░реНрдб

рдкрд╛рд╕рд╡рд░реНрдб рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП:
```bash
bifrost --action askhash --username [name] --password [password] --domain [domain]
```
рдпрд╣ **`Computer$`** рдкрд╛рд╕рд╡рд░реНрдб рдХреЛ рд╕рд┐рд╕реНрдЯрдо рдХреАрдЪреЗрди рдХреЗ рдЕрдВрджрд░ рдПрдХреНрд╕реЗрд╕ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИред

### рдУрд╡рд░-рдкрд╛рд╕-рджреА-рд╣реИрд╢

рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдФрд░ рд╕реЗрд╡рд╛ рдХреЗ рд▓рд┐рдП TGT рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ:
```bash
bifrost --action asktgt --username [user] --domain [domain.com] \
--hash [hash] --enctype [enctype] --keytab [/path/to/keytab]
```
рдПрдХ рдмрд╛рд░ TGT рдЗрдХрдЯреНрдард╛ рд╣реЛ рдЬрд╛рдиреЗ рдХреЗ рдмрд╛рдж, рдЗрд╕реЗ рд╡рд░реНрддрдорд╛рди рд╕рддреНрд░ рдореЗрдВ рдЗрдВрдЬреЗрдХреНрдЯ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ:
```bash
bifrost --action asktgt --username test_lab_admin \
--hash CF59D3256B62EE655F6430B0F80701EE05A0885B8B52E9C2480154AFA62E78 \
--enctype aes256 --domain test.lab.local
```
### Kerberoasting
```bash
bifrost --action asktgs --spn [service] --domain [domain.com] \
--username [user] --hash [hash] --enctype [enctype]
```
рдкреНрд░рд╛рдкреНрдд рд╕реЗрд╡рд╛ рдЯрд┐рдХрдЯреЛрдВ рдХреЗ рд╕рд╛рде рдЕрдиреНрдп рдХрдВрдкреНрдпреВрдЯрд░реЛрдВ рдореЗрдВ рд╢реЗрдпрд░реЛрдВ рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ:
```bash
smbutil view //computer.fqdn
mount -t smbfs //server/folder /local/mount/point
```
## Keychain рддрдХ рдкрд╣реБрдБрдЪ

Keychain рдореЗрдВ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдЬрд╛рдирдХрд╛рд░реА рд╣реЛ рд╕рдХрддреА рд╣реИ рдЬреЛ рдмрд┐рдирд╛ рдкреНрд░реЙрдореНрдкреНрдЯ рдЙрддреНрдкрдиреНрди рдХрд┐рдП рдкрд╣реБрдБрдЪрдиреЗ рдкрд░ рдПрдХ рд░реЗрдб рдЯреАрдо рдЕрднреНрдпрд╛рд╕ рдХреЛ рдЖрдЧреЗ рдмрдврд╝рд╛рдиреЗ рдореЗрдВ рдорджрдж рдХрд░ рд╕рдХрддреА рд╣реИ:

{% content-ref url="macos-keychain.md" %}
[macos-keychain.md](macos-keychain.md)
{% endcontent-ref %}

## рдмрд╛рд╣рд░реА рд╕реЗрд╡рд╛рдПрдБ

MacOS рд░реЗрдб рдЯреАрдорд┐рдВрдЧ рд╕рд╛рдорд╛рдиреНрдп Windows рд░реЗрдб рдЯреАрдорд┐рдВрдЧ рд╕реЗ рдЕрд▓рдЧ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдЖрдорддреМрд░ рдкрд░ **MacOS рдХрдИ рдмрд╛рд╣рд░реА рдкреНрд▓реЗрдЯрдлрд╛рд░реНрдореЛрдВ рдХреЗ рд╕рд╛рде рд╕реАрдзреЗ рдПрдХреАрдХреГрдд рд╣реЛрддрд╛ рд╣реИ**ред MacOS рдХреА рдПрдХ рд╕рд╛рдорд╛рдиреНрдп рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рд╣реИ **OneLogin рд╕рдордиреНрд╡рдпрд┐рдд рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХрдВрдкреНрдпреВрдЯрд░ рддрдХ рдкрд╣реБрдБрдЪ рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛, рдФрд░ OneLogin рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдХрдИ рдмрд╛рд╣рд░реА рд╕реЗрд╡рд╛рдУрдВ (рдЬреИрд╕реЗ github, aws...) рддрдХ рдкрд╣реБрдБрдЪ рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛**ред

## рд╡рд┐рд╡рд┐рдз рд░реЗрдб рдЯреАрдо рддрдХрдиреАрдХреЗрдВ

### рд╕рдлрд╛рд░реА

рдЬрдм рд╕рдлрд╛рд░реА рдореЗрдВ рдПрдХ рдлрд╝рд╛рдЗрд▓ рдбрд╛рдЙрдирд▓реЛрдб рдХреА рдЬрд╛рддреА рд╣реИ, рдпрджрд┐ рдпрд╣ рдПрдХ "рд╕реБрд░рдХреНрд╖рд┐рдд" рдлрд╝рд╛рдЗрд▓ рд╣реИ, рддреЛ рдпрд╣ **рд╕реНрд╡рддрдГ рдЦреЛрд▓реА рдЬрд╛рдПрдЧреА**ред рддреЛ рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдпрджрд┐ рдЖрдк **рдПрдХ рдЬрд╝рд┐рдк рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рддреЗ рд╣реИрдВ**, рддреЛ рдпрд╣ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рдЕрдирдЬрд╝рд┐рдк рд╣реЛ рдЬрд╛рдПрдЧреА:

<figure><img src="../../.gitbook/assets/image (226).png" alt=""><figcaption></figcaption></figure>

## рд╕рдВрджрд░реНрдн

* [**https://www.youtube.com/watch?v=IiMladUbL6E**](https://www.youtube.com/watch?v=IiMladUbL6E)
* [**https://medium.com/xm-cyber/introducing-machound-a-solution-to-macos-active-directory-based-attacks-2a425f0a22b6**](https://medium.com/xm-cyber/introducing-machound-a-solution-to-macos-active-directory-based-attacks-2a425f0a22b6)
* [**https://gist.github.com/its-a-feature/1a34f597fb30985a2742bb16116e74e0**](https://gist.github.com/its-a-feature/1a34f597fb30985a2742bb16116e74e0)
* [**Come to the Dark Side, We Have Apples: Turning macOS Management Evil**](https://www.youtube.com/watch?v=pOQOh07eMxY)
* [**OBTS v3.0: "An Attackers Perspective on Jamf Configurations" - Luke Roberts / Calum Hall**](https://www.youtube.com/watch?v=ju1IYWUv4ZA)

{% hint style="success" %}
AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
GCP рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдБ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* **рд╣рдорд╛рд░реЗ** ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ **Twitter** ЁЯРж рдкрд░ рд╣рдореЗрдВ **рдлреЙрд▓реЛ рдХрд░реЗрдВ** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ рдФрд░** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдЧрд┐рдЯрд╣рдм рд░рд┐рдкреЛрдЬрд┐рдЯрд░реА рдореЗрдВ PR рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВред

</details>
{% endhint %}
