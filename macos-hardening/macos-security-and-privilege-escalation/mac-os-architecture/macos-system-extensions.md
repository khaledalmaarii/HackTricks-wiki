# macOS μ‹μ¤ν… ν™•μ¥

{% hint style="success" %}
AWS ν•΄ν‚Ή ν•™μµ λ° μ‹¤μµ:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP ν•΄ν‚Ή ν•™μµ λ° μ‹¤μµ: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks μ§€μ›</summary>

* [**κµ¬λ… μ”κΈμ **](https://github.com/sponsors/carlospolop)λ¥Ό ν™•μΈν•μ„Έμ”!
* π’¬ [**λ””μ¤μ½”λ“ κ·Έλ£Ή**](https://discord.gg/hRep4RUj7f) λλ” [**ν…”λ κ·Έλ¨ κ·Έλ£Ή**](https://t.me/peass)μ— **μ°Έμ—¬**ν•κ±°λ‚ **νΈμ„ν„°** π¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**λ¥Ό ν”λ΅μ°**ν•μ„Έμ”.
* [**HackTricks**](https://github.com/carlospolop/hacktricks) λ° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) κΉƒν—™ μ €μ¥μ†μ— PRμ„ μ μ¶ν•μ—¬ ν•΄ν‚Ή νΈλ¦­μ„ κ³µμ ν•μ„Έμ”.

</details>
{% endhint %}

## μ‹μ¤ν… ν™•μ¥ / μ—”λ“ν¬μΈνΈ λ³΄μ• ν”„λ μ„μ›ν¬

**μ‹μ¤ν… ν™•μ¥**μ€ **μ»¤λ„ κ³µκ°„μ΄ μ•„λ‹ μ‚¬μ©μ κ³µκ°„μ—μ„ μ‹¤ν–‰**λλ―€λ΅ ν™•μ¥ κΈ°λ¥μ μ¤μ‘λ™μΌλ΅ μΈν• μ‹μ¤ν… μ¶©λ μ„ν—μ„ μ¤„μ…λ‹λ‹¤.

<figure><img src="../../../.gitbook/assets/image (606).png" alt="https://knight.sc/images/system-extension-internals-1.png"><figcaption></figcaption></figure>

μ‹μ¤ν… ν™•μ¥μ—λ” **DriverKit** ν™•μ¥, **Network** ν™•μ¥ λ° **Endpoint Security** ν™•μ¥ μ„Έ κ°€μ§€ μ ν•μ΄ μμµλ‹λ‹¤.

### **DriverKit ν™•μ¥**

DriverKitμ€ **ν•λ“μ›¨μ–΄ μ§€μ›μ„ μ κ³µ**ν•λ” μ»¤λ„ ν™•μ¥μ λ€μ²΄λ¬Όμ…λ‹λ‹¤. μ΄λ¥Ό ν†µν•΄ μ¥μΉ λ“λΌμ΄λ²„(USB, μ‹λ¦¬μ–Ό, NIC λ° HID λ“λΌμ΄λ²„μ™€ κ°™μ€)κ°€ μ»¤λ„ κ³µκ°„μ΄ μ•„λ‹ μ‚¬μ©μ κ³µκ°„μ—μ„ μ‹¤ν–‰λ  μ μμµλ‹λ‹¤. DriverKit ν”„λ μ„μ›ν¬μ—λ” μΌλ¶€ I/O Kit ν΄λμ¤μ μ‚¬μ©μ κ³µκ°„ λ²„μ „μ΄ ν¬ν•¨λμ–΄ μμΌλ©°, μ»¤λ„μ€ μΌλ° I/O Kit μ΄λ²¤νΈλ¥Ό μ‚¬μ©μ κ³µκ°„μΌλ΅ μ „λ‹¬ν•μ—¬ μ΄λ¬ν• λ“λΌμ΄λ²„κ°€ μ‹¤ν–‰λλ” λ³΄λ‹¤ μ•μ „ν• ν™κ²½μ„ μ κ³µν•©λ‹λ‹¤.

### **Network ν™•μ¥**

Network ν™•μ¥μ€ λ„¤νΈμ›ν¬ λ™μ‘μ„ μ‚¬μ©μ μ •μν•λ” κΈ°λ¥μ„ μ κ³µν•©λ‹λ‹¤. λ‹¤μκ³Ό κ°™μ€ μ—¬λ¬ μ ν•μ Network ν™•μ¥μ΄ μμµλ‹λ‹¤:

* **App Proxy**: μ—°κ²°(λλ” νλ¦„)μ— κΈ°λ°ν• μ‚¬μ©μ μ •μ VPN ν”„λ΅ν† μ½μ„ κµ¬ν„ν•λ” VPN ν΄λΌμ΄μ–ΈνΈλ¥Ό λ§λ“λ” λ° μ‚¬μ©λ©λ‹λ‹¤. μ΄λ” κ°λ³„ ν¨ν‚·μ΄ μ•„λ‹ μ—°κ²°(λλ” νλ¦„)μ— κΈ°λ°ν•μ—¬ λ„¤νΈμ›ν¬ νΈλν”½μ„ μ²λ¦¬ν•©λ‹λ‹¤.
* **Packet Tunnel**: κ°λ³„ ν¨ν‚·μ— κΈ°λ°ν• μ‚¬μ©μ μ •μ VPN ν”„λ΅ν† μ½μ„ κµ¬ν„ν•λ” VPN ν΄λΌμ΄μ–ΈνΈλ¥Ό λ§λ“λ” λ° μ‚¬μ©λ©λ‹λ‹¤. μ΄λ” κ°λ³„ ν¨ν‚·μ— κΈ°λ°ν•μ—¬ λ„¤νΈμ›ν¬ νΈλν”½μ„ μ²λ¦¬ν•©λ‹λ‹¤.
* **Filter Data**: λ„¤νΈμ›ν¬ "νλ¦„"μ„ ν•„ν„°λ§ν•λ” λ° μ‚¬μ©λ©λ‹λ‹¤. λ„¤νΈμ›ν¬ λ°μ΄ν„°λ¥Ό νλ¦„ μμ¤€μ—μ„ λ¨λ‹ν„°λ§ν•κ±°λ‚ μμ •ν•  μ μμµλ‹λ‹¤.
* **Filter Packet**: κ°λ³„ λ„¤νΈμ›ν¬ ν¨ν‚·μ„ ν•„ν„°λ§ν•λ” λ° μ‚¬μ©λ©λ‹λ‹¤. λ„¤νΈμ›ν¬ λ°μ΄ν„°λ¥Ό ν¨ν‚· μμ¤€μ—μ„ λ¨λ‹ν„°λ§ν•κ±°λ‚ μμ •ν•  μ μμµλ‹λ‹¤.
* **DNS Proxy**: μ‚¬μ©μ μ •μ DNS μ κ³µμλ¥Ό λ§λ“λ” λ° μ‚¬μ©λ©λ‹λ‹¤. DNS μ”μ²­ λ° μ‘λ‹µμ„ λ¨λ‹ν„°λ§ν•κ±°λ‚ μμ •ν•λ” λ° μ‚¬μ©ν•  μ μμµλ‹λ‹¤.

## μ—”λ“ν¬μΈνΈ λ³΄μ• ν”„λ μ„μ›ν¬

macOSμ—μ„ μ κ³µν•λ” μ—”λ“ν¬μΈνΈ λ³΄μ•μ€ μ‹μ¤ν… λ³΄μ•μ„ μ„ν• μΌλ ¨μ APIλ¥Ό μ κ³µν•©λ‹λ‹¤. μ΄λ” **μ•…μ„± ν™λ™μ„ μ‹λ³„ν•κ³  λ°©μ§€ν•κΈ° μ„ν•΄ μ‹μ¤ν… ν™λ™μ„ λ¨λ‹ν„°λ§ν•κ³  μ μ–΄ν•λ” μ ν’μ„ κ°λ°ν•κΈ° μ„ν•΄ λ³΄μ• μ—…μ²΄ λ° κ°λ°μμ— μν•΄ μ‚¬μ©**λλ„λ΅ μλ„λμ—μµλ‹λ‹¤.

μ΄ ν”„λ μ„μ›ν¬λ” ν”„λ΅μ„Έμ¤ μ‹¤ν–‰, νμΌ μ‹μ¤ν… μ΄λ²¤νΈ, λ„¤νΈμ›ν¬ λ° μ»¤λ„ μ΄λ²¤νΈμ™€ κ°™μ€ μ‹μ¤ν… ν™λ™μ„ λ¨λ‹ν„°λ§ν•κ³  μ μ–΄ν•κΈ° μ„ν• **μΌλ ¨μ API λ¨μ**μ„ μ κ³µν•©λ‹λ‹¤.

μ΄ ν”„λ μ„μ›ν¬μ ν•µμ‹¬μ€ μ»¤λ„μ— κµ¬ν„λ μ»¤λ„ ν™•μ¥(KEXT)μΈ **`/System/Library/Extensions/EndpointSecurity.kext`**μ— μ„μΉν•©λ‹λ‹¤. μ΄ KEXTλ” λ‹¤μκ³Ό κ°™μ€ μ—¬λ¬ μ£Όμ” κµ¬μ„± μ”μ†λ΅ κµ¬μ„±λ©λ‹λ‹¤:

* **EndpointSecurityDriver**: μ΄λ” μ»¤λ„ ν™•μ¥μ "μ§„μ…μ "μΌλ΅ μ‘λ™ν•©λ‹λ‹¤. μ΄λ” OSμ™€ Endpoint Security ν”„λ μ„μ›ν¬ κ°„μ μ£Όμ” μƒνΈ μ‘μ© μ§€μ μ…λ‹λ‹¤.
* **EndpointSecurityEventManager**: μ΄ κµ¬μ„± μ”μ†λ” μ»¤λ„ ν›„ν‚Ήμ„ κµ¬ν„ν•λ” λ° μ±…μ„μ΄ μμµλ‹λ‹¤. μ»¤λ„ ν›„ν‚Ήμ„ ν†µν•΄ ν”„λ μ„μ›ν¬λ” μ‹μ¤ν… νΈμ¶μ„ κ°€λ΅μ±„μ–΄ μ‹μ¤ν… μ΄λ²¤νΈλ¥Ό λ¨λ‹ν„°λ§ν•  μ μμµλ‹λ‹¤.
* **EndpointSecurityClientManager**: μ΄λ” μ‚¬μ©μ κ³µκ°„ ν΄λΌμ΄μ–ΈνΈμ™€μ ν†µμ‹ μ„ κ΄€λ¦¬ν•λ©° μ—°κ²°λ ν΄λΌμ΄μ–ΈνΈ λ° μ΄λ²¤νΈ μ•λ¦Όμ„ λ°›μ•„μ•Ό ν•λ” ν΄λΌμ΄μ–ΈνΈλ¥Ό μ¶”μ ν•©λ‹λ‹¤.
* **EndpointSecurityMessageManager**: μ΄λ” λ©”μ‹μ§€ λ° μ΄λ²¤νΈ μ•λ¦Όμ„ μ‚¬μ©μ κ³µκ°„ ν΄λΌμ΄μ–ΈνΈλ΅ λ³΄λƒ…λ‹λ‹¤.

Endpoint Security ν”„λ μ„μ›ν¬κ°€ λ¨λ‹ν„°λ§ν•  μ μλ” μ΄λ²¤νΈλ” λ‹¤μκ³Ό κ°™μ΄ λ¶„λ¥λ©λ‹λ‹¤:

* νμΌ μ΄λ²¤νΈ
* ν”„λ΅μ„Έμ¤ μ΄λ²¤νΈ
* μ†μΌ“ μ΄λ²¤νΈ
* μ»¤λ„ μ΄λ²¤νΈ(μ»¤λ„ ν™•μ¥ λ΅λ“/μ–Έλ΅λ“ λλ” I/O Kit μ¥μΉ μ¤ν”κ³Ό κ°™μ€)

### μ—”λ“ν¬μΈνΈ λ³΄μ• ν”„λ μ„μ›ν¬ μ•„ν‚¤ν…μ²

<figure><img src="../../../.gitbook/assets/image (1068).png" alt="https://www.youtube.com/watch?v=jaVkpM1UqOs"><figcaption></figcaption></figure>

**μ—”λ“ν¬μΈνΈ λ³΄μ• ν”„λ μ„μ›ν¬**μ™€μ **μ‚¬μ©μ κ³µκ°„ ν†µμ‹ **μ€ IOUserClient ν΄λμ¤λ¥Ό ν†µν•΄ μ΄λ£¨μ–΄μ§‘λ‹λ‹¤. νΈμ¶μ μ ν•μ— λ”°λΌ λ‘ κ°€μ§€ λ‹¤λ¥Έ ν•μ„ ν΄λμ¤κ°€ μ‚¬μ©λ©λ‹λ‹¤:

* **EndpointSecurityDriverClient**: μ΄λ” `com.apple.private.endpoint-security.manager` κ¶ν•μ΄ ν•„μ”ν•λ©°, μ‹μ¤ν… ν”„λ΅μ„Έμ¤μΈ `endpointsecurityd`λ§μ΄ ν•΄λ‹Ή κ¶ν•μ„ μ†μ ν•©λ‹λ‹¤.
* **EndpointSecurityExternalClient**: μ΄λ” `com.apple.developer.endpoint-security.client` κ¶ν•μ΄ ν•„μ”ν•©λ‹λ‹¤. μ΄λ” μΌλ°μ μΌλ΅ μ—”λ“ν¬μΈνΈ λ³΄μ• ν”„λ μ„μ›ν¬μ™€ μƒνΈ μ‘μ©ν•΄μ•Ό ν•λ” νƒ€μ‚¬ λ³΄μ• μ†ν”„νΈμ›¨μ–΄μ—μ„ μ‚¬μ©λ©λ‹λ‹¤.

μ—”λ“ν¬μΈνΈ λ³΄μ• ν™•μ¥:**`libEndpointSecurity.dylib`**λ” μ‹μ¤ν… ν™•μ¥μ΄ μ»¤λ„κ³Ό ν†µμ‹ ν•λ” λ° μ‚¬μ©ν•λ” C λΌμ΄λΈλ¬λ¦¬μ…λ‹λ‹¤. μ΄ λΌμ΄λΈλ¬λ¦¬λ” I/O Kit(`IOKit`)μ„ μ‚¬μ©ν•μ—¬ Endpoint Security KEXTμ™€ ν†µμ‹ ν•©λ‹λ‹¤.

**`endpointsecurityd`**λ” μ΄κΈ° λ¶€ν… ν”„λ΅μ„Έμ¤ μ¤‘μ— μ—”λ“ν¬μΈνΈ λ³΄μ• μ‹μ¤ν… ν™•μ¥μ„ κ΄€λ¦¬ν•κ³  μ‹μ‘ν•λ” λ° κ΄€μ—¬ν•λ” μ£Όμ” μ‹μ¤ν… λ°λ¬μ…λ‹λ‹¤. **`Info.plist`** νμΌμ—μ„ **`NSEndpointSecurityEarlyBoot`**λ΅ ν‘μ‹λ μ‹μ¤ν… ν™•μ¥λ§μ΄ μ΄ μ΄κΈ° λ¶€ν… μ²λ¦¬λ¥Ό λ°›μµλ‹λ‹¤.

λ‹¤λ¥Έ μ‹μ¤ν… λ°λ¬μΈ **`sysextd`**λ” μ‹μ¤ν… ν™•μ¥μ„ μ ν¨μ„± κ²€μ‚¬ν•κ³  μ μ ν• μ‹μ¤ν… μ„μΉλ΅ μ΄λ™μ‹ν‚µλ‹λ‹¤. κ·Έλ° λ‹¤μ ν•΄λ‹Ή λ°λ¬μ— ν™•μ¥μ„ λ΅λ“ν•λ„λ΅ μ”μ²­ν•©λ‹λ‹¤. **`SystemExtensions.framework`**λ” μ‹μ¤ν… ν™•μ¥μ„ ν™μ„±ν™”ν•κ³  λΉ„ν™μ„±ν™”ν•λ” λ° μ±…μ„μ΄ μμµλ‹λ‹¤.

## ESF μ°ν

ESFλ” λ λ“ ν€μ„ κ°μ§€ν•λ ¤λ” λ³΄μ• λ„κµ¬μ—μ„ μ‚¬μ©λλ―€λ΅ μ΄λ¥Ό ν”Όν•  μ μλ” λ°©λ²•μ— λ€ν• μ •λ³΄λ” ν¥λ―Έλ΅μΈ μ μμµλ‹λ‹¤.

### CVE-2021-30965

λ³΄μ• μ• ν”λ¦¬μΌ€μ΄μ…μ€ **μ „μ²΄ λ””μ¤ν¬ μ•΅μ„Έμ¤ κ¶ν•**μ΄ μμ–΄μ•Ό ν•©λ‹λ‹¤. λ”°λΌμ„ κ³µκ²©μκ°€ ν•΄λ‹Ή κ¶ν•μ„ μ κ±°ν•  κ²½μ° μ†ν”„νΈμ›¨μ–΄κ°€ μ‹¤ν–‰λμ§€ μ•λ„λ΅ λ°©μ§€ν•  μ μμµλ‹λ‹¤:
```bash
tccutil reset All
```
**λ” λ§μ€ μ •λ³΄**λ¥Ό μ›ν•μ‹λ©΄ μ΄ μ°ν λ° κ΄€λ ¨ μ°ν κΈ°λ²•μ„ ν™•μΈν•μ‹­μ‹μ¤. [#OBTS v5.0: "EndpointSecurityμ μ•½μ " - Fitzl Csaba](https://www.youtube.com/watch?v=lQO7tvNCoTI)

κ²°κµ­ μ΄ λ¬Έμ λ” **`tccd`**μ— μν•΄ κ΄€λ¦¬λλ” λ³΄μ• μ•±μ— μƒ κ¶ν• **`kTCCServiceEndpointSecurityClient`**μ„ λ¶€μ—¬ν•¨μΌλ΅μ¨ ν•΄κ²°λμ—μΌλ©°, μ΄λ¥Ό ν†µν•΄ `tccutil`μ΄ κ¶ν•μ„ μ§€μ°μ§€ μ•μ•„ μ‹¤ν–‰μ„ λ°©ν•΄ν•μ§€ μ•λ„λ΅ ν–μµλ‹λ‹¤.

## μ°Έκ³  μλ£

* [**OBTS v3.0: "Endpoint Security & Insecurity" - Scott Knight**](https://www.youtube.com/watch?v=jaVkpM1UqOs)
* [**https://knight.sc/reverse%20engineering/2019/08/24/system-extension-internals.html**](https://knight.sc/reverse%20engineering/2019/08/24/system-extension-internals.html)
