# macOSè¿›ç¨‹æ»¥ç”¨

{% hint style="success" %}
å­¦ä¹ å¹¶ç»ƒä¹ AWSé»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricksåŸ¹è®­AWSçº¢é˜Ÿä¸“å®¶ï¼ˆARTEï¼‰**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å¹¶ç»ƒä¹ GCPé»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricksåŸ¹è®­GCPçº¢é˜Ÿä¸“å®¶ï¼ˆGRTEï¼‰**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## è¿›ç¨‹åŸºæœ¬ä¿¡æ¯

è¿›ç¨‹æ˜¯è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶çš„å®ä¾‹ï¼Œä½†è¿›ç¨‹ä¸è¿è¡Œä»£ç ï¼Œè¿™äº›æ˜¯çº¿ç¨‹ã€‚å› æ­¤ï¼Œ**è¿›ç¨‹åªæ˜¯è¿è¡Œçº¿ç¨‹çš„å®¹å™¨**ï¼Œæä¾›å†…å­˜ã€æè¿°ç¬¦ã€ç«¯å£ã€æƒé™ç­‰ã€‚

ä¼ ç»Ÿä¸Šï¼Œè¿›ç¨‹æ˜¯åœ¨å…¶ä»–è¿›ç¨‹ï¼ˆé™¤äº†PID 1ï¼‰å†…å¯åŠ¨çš„ï¼Œé€šè¿‡è°ƒç”¨**`fork`**æ¥åˆ›å»ºå½“å‰è¿›ç¨‹çš„ç²¾ç¡®å‰¯æœ¬ï¼Œç„¶å**å­è¿›ç¨‹**é€šå¸¸ä¼šè°ƒç”¨**`execve`**æ¥åŠ è½½æ–°çš„å¯æ‰§è¡Œæ–‡ä»¶å¹¶è¿è¡Œå®ƒã€‚ç„¶åï¼Œå¼•å…¥äº†**`vfork`**æ¥åŠ å¿«æ­¤è¿‡ç¨‹ï¼Œè€Œæ— éœ€è¿›è¡Œä»»ä½•å†…å­˜å¤åˆ¶ã€‚\
ç„¶åå¼•å…¥äº†**`posix_spawn`**ï¼Œå°†**`vfork`**å’Œ**`execve`**ç»“åˆåœ¨ä¸€ä¸ªè°ƒç”¨ä¸­ï¼Œå¹¶æ¥å—æ ‡å¿—ï¼š

- `POSIX_SPAWN_RESETIDS`ï¼šå°†æœ‰æ•ˆIDé‡ç½®ä¸ºçœŸå®ID
- `POSIX_SPAWN_SETPGROUP`ï¼šè®¾ç½®è¿›ç¨‹ç»„å…³è”
- `POSUX_SPAWN_SETSIGDEF`ï¼šè®¾ç½®ä¿¡å·çš„é»˜è®¤è¡Œä¸º
- `POSIX_SPAWN_SETSIGMASK`ï¼šè®¾ç½®ä¿¡å·æ©ç 
- `POSIX_SPAWN_SETEXEC`ï¼šåœ¨åŒä¸€è¿›ç¨‹ä¸­æ‰§è¡Œï¼ˆç±»ä¼¼äºå…·æœ‰æ›´å¤šé€‰é¡¹çš„`execve`ï¼‰
- `POSIX_SPAWN_START_SUSPENDED`ï¼šå¯åŠ¨æ—¶æŒ‚èµ·
- `_POSIX_SPAWN_DISABLE_ASLR`ï¼šæ— ASLRå¯åŠ¨
- `_POSIX_SPAWN_NANO_ALLOCATOR:` ä½¿ç”¨libmallocçš„Nanoåˆ†é…å™¨
- `_POSIX_SPAWN_ALLOW_DATA_EXEC:` å…è®¸æ•°æ®æ®µä¸Šçš„`rwx`
- `POSIX_SPAWN_CLOEXEC_DEFAULT`ï¼šé»˜è®¤æƒ…å†µä¸‹åœ¨exec(2)ä¸Šå…³é—­æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦
- `_POSIX_SPAWN_HIGH_BITS_ASLR:` éšæœºåŒ–ASLRå¹»æ•°ä½

æ­¤å¤–ï¼Œ`posix_spawn`å…è®¸æŒ‡å®šä¸€ä¸ªæ§åˆ¶ç”Ÿæˆè¿›ç¨‹æŸäº›æ–¹é¢çš„**`posix_spawnattr`**æ•°ç»„ï¼Œä»¥åŠ**`posix_spawn_file_actions`**æ¥ä¿®æ”¹æè¿°ç¬¦çš„çŠ¶æ€ã€‚

å½“è¿›ç¨‹ç»ˆæ­¢æ—¶ï¼Œå®ƒä¼šå‘çˆ¶è¿›ç¨‹å‘é€**è¿”å›ä»£ç **ï¼ˆå¦‚æœçˆ¶è¿›ç¨‹å·²ç»ç»ˆæ­¢ï¼Œåˆ™æ–°çˆ¶è¿›ç¨‹æ˜¯PID 1ï¼‰ï¼Œä½¿ç”¨ä¿¡å·`SIGCHLD`ã€‚çˆ¶è¿›ç¨‹éœ€è¦è°ƒç”¨`wait4()`æˆ–`waitid()`æ¥è·å–æ­¤å€¼ï¼Œç›´åˆ°å‘ç”Ÿè¿™ç§æƒ…å†µï¼Œå­è¿›ç¨‹å°†ä¿æŒåƒµå°¸çŠ¶æ€ï¼Œä»ç„¶åˆ—å‡ºä½†ä¸ä¼šæ¶ˆè€—èµ„æºã€‚

### è¿›ç¨‹ID

è¿›ç¨‹IDï¼ˆPIDï¼ŒProcess Identifiersï¼‰æ ‡è¯†å”¯ä¸€è¿›ç¨‹ã€‚åœ¨XNUä¸­ï¼Œ**PID**æ˜¯**64ä½**çš„ï¼Œå•è°ƒé€’å¢ï¼Œ**æ°¸ä¸å›ç»•**ï¼ˆä»¥é¿å…æ»¥ç”¨ï¼‰ã€‚

### è¿›ç¨‹ç»„ã€ä¼šè¯å’Œè”åˆ

**è¿›ç¨‹**å¯ä»¥è¢«æ”¾å…¥**ç»„**ä¸­ä»¥ä¾¿æ›´å®¹æ˜“å¤„ç†å®ƒä»¬ã€‚ä¾‹å¦‚ï¼Œshellè„šæœ¬ä¸­çš„å‘½ä»¤å°†ä½äºåŒä¸€è¿›ç¨‹ç»„ä¸­ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨killç­‰å‘½ä»¤**ä¸€èµ·å‘å®ƒä»¬å‘é€ä¿¡å·**ã€‚\
è¿˜å¯ä»¥å°†è¿›ç¨‹**åˆ†ç»„åˆ°ä¼šè¯**ä¸­ã€‚å½“è¿›ç¨‹å¯åŠ¨ä¼šè¯ï¼ˆ`setsid(2)`ï¼‰æ—¶ï¼Œå­è¿›ç¨‹å°†è¢«æ”¾å…¥ä¼šè¯ä¸­ï¼Œé™¤éå®ƒä»¬å¯åŠ¨è‡ªå·±çš„ä¼šè¯ã€‚

Coalitionæ˜¯åœ¨Darwinä¸­å°†è¿›ç¨‹åˆ†ç»„çš„å¦ä¸€ç§æ–¹å¼ã€‚åŠ å…¥è”åˆçš„è¿›ç¨‹å…è®¸è®¿é—®æ± èµ„æºï¼Œå…±äº«è´¦æœ¬æˆ–é¢å¯¹Jetsamã€‚è”åˆæœ‰ä¸åŒçš„è§’è‰²ï¼šé¢†å¯¼è€…ã€XPCæœåŠ¡ã€æ‰©å±•ã€‚

### å‡­è¯å’Œèº«ä»½

æ¯ä¸ªè¿›ç¨‹éƒ½æŒæœ‰**å‡­è¯**ï¼Œç”¨äº**æ ‡è¯†å…¶åœ¨ç³»ç»Ÿä¸­çš„ç‰¹æƒ**ã€‚æ¯ä¸ªè¿›ç¨‹å°†æœ‰ä¸€ä¸ªä¸»è¦çš„`uid`å’Œä¸€ä¸ªä¸»è¦çš„`gid`ï¼ˆå°½ç®¡å¯èƒ½å±äºå¤šä¸ªç»„ï¼‰ã€‚\
å¦‚æœäºŒè¿›åˆ¶æ–‡ä»¶å…·æœ‰`setuid/setgid`ä½ï¼Œåˆ™è¿˜å¯ä»¥æ›´æ”¹ç”¨æˆ·å’Œç»„IDã€‚\
æœ‰å‡ ä¸ªå‡½æ•°å¯ç”¨äº**è®¾ç½®æ–°çš„uid/gid**ã€‚

ç³»ç»Ÿè°ƒç”¨**`persona`**æä¾›äº†**å¤‡ç”¨**ä¸€ç»„**å‡­è¯**ã€‚é‡‡ç”¨äººç‰©æ„å‘³ç€åœ¨ä¸€æ¬¡æ€§åœ°å‡å®šå…¶uidã€gidå’Œç»„æˆå‘˜èº«ä»½ã€‚åœ¨[**æºä»£ç **](https://github.com/apple/darwin-xnu/blob/main/bsd/sys/persona.h)ä¸­å¯ä»¥æ‰¾åˆ°è¯¥ç»“æ„ï¼š
```c
struct kpersona_info { uint32_t persona_info_version;
uid_t    persona_id; /* overlaps with UID */
int      persona_type;
gid_t    persona_gid;
uint32_t persona_ngroups;
gid_t    persona_groups[NGROUPS];
uid_t    persona_gmuid;
char     persona_name[MAXLOGNAME + 1];

/* TODO: MAC policies?! */
}
```
## çº¿ç¨‹åŸºæœ¬ä¿¡æ¯

1. **POSIX çº¿ç¨‹ (pthreads):** macOS æ”¯æŒ POSIX çº¿ç¨‹ (`pthreads`), è¿™æ˜¯ C/C++ çš„æ ‡å‡†çº¿ç¨‹ API çš„ä¸€éƒ¨åˆ†ã€‚macOS ä¸­çš„ pthreads å®ç°ä½äº `/usr/lib/system/libsystem_pthread.dylib`ï¼Œè¿™æ¥è‡ªå…¬å¼€å¯ç”¨çš„ `libpthread` é¡¹ç›®ã€‚è¯¥åº“æä¾›äº†åˆ›å»ºå’Œç®¡ç†çº¿ç¨‹æ‰€éœ€çš„å‡½æ•°ã€‚
2. **åˆ›å»ºçº¿ç¨‹:** ä½¿ç”¨ `pthread_create()` å‡½æ•°æ¥åˆ›å»ºæ–°çº¿ç¨‹ã€‚åœ¨å†…éƒ¨ï¼Œæ­¤å‡½æ•°è°ƒç”¨ `bsdthread_create()`ï¼Œè¿™æ˜¯ä¸€ä¸ªç‰¹å®šäº XNU å†…æ ¸ï¼ˆmacOS åŸºäºçš„å†…æ ¸ï¼‰çš„è¾ƒä½çº§ç³»ç»Ÿè°ƒç”¨ã€‚æ­¤ç³»ç»Ÿè°ƒç”¨æ¥å—ä» `pthread_attr`ï¼ˆå±æ€§ï¼‰æ´¾ç”Ÿçš„å„ç§æ ‡å¿—ï¼ŒæŒ‡å®šçº¿ç¨‹è¡Œä¸ºï¼ŒåŒ…æ‹¬è°ƒåº¦ç­–ç•¥å’Œå †æ ˆå¤§å°ã€‚
* **é»˜è®¤å †æ ˆå¤§å°:** æ–°çº¿ç¨‹çš„é»˜è®¤å †æ ˆå¤§å°ä¸º 512 KBï¼Œå¯¹äºå…¸å‹æ“ä½œæ¥è¯´è¶³å¤Ÿäº†ï¼Œä½†å¦‚æœéœ€è¦æ›´å¤šæˆ–æ›´å°‘çš„ç©ºé—´ï¼Œå¯ä»¥é€šè¿‡çº¿ç¨‹å±æ€§è¿›è¡Œè°ƒæ•´ã€‚
3. **çº¿ç¨‹åˆå§‹åŒ–:** `__pthread_init()` å‡½æ•°åœ¨çº¿ç¨‹è®¾ç½®æœŸé—´è‡³å…³é‡è¦ï¼Œåˆ©ç”¨ `env[]` å‚æ•°æ¥è§£æç¯å¢ƒå˜é‡ï¼Œè¿™äº›å˜é‡å¯ä»¥åŒ…å«æœ‰å…³å †æ ˆä½ç½®å’Œå¤§å°çš„è¯¦ç»†ä¿¡æ¯ã€‚

#### macOS ä¸­çš„çº¿ç¨‹ç»ˆæ­¢

1. **é€€å‡ºçº¿ç¨‹:** é€šå¸¸é€šè¿‡è°ƒç”¨ `pthread_exit()` æ¥ç»ˆæ­¢çº¿ç¨‹ã€‚æ­¤å‡½æ•°å…è®¸çº¿ç¨‹æ¸…ç†é€€å‡ºï¼Œæ‰§è¡Œå¿…è¦çš„æ¸…ç†æ“ä½œï¼Œå¹¶å…è®¸çº¿ç¨‹å‘ä»»ä½•åŠ å…¥è€…å‘é€è¿”å›å€¼ã€‚
2. **çº¿ç¨‹æ¸…ç†:** è°ƒç”¨ `pthread_exit()` åï¼Œå°†è°ƒç”¨ `pthread_terminate()` å‡½æ•°ï¼Œè¯¥å‡½æ•°å¤„ç†æ‰€æœ‰ç›¸å…³çº¿ç¨‹ç»“æ„çš„ç§»é™¤ã€‚å®ƒé‡Šæ”¾ Mach çº¿ç¨‹ç«¯å£ï¼ˆMach æ˜¯ XNU å†…æ ¸ä¸­çš„é€šä¿¡å­ç³»ç»Ÿï¼‰å¹¶è°ƒç”¨ `bsdthread_terminate`ï¼Œè¿™æ˜¯ä¸€ä¸ªåˆ é™¤ä¸çº¿ç¨‹ç›¸å…³çš„å†…æ ¸çº§ç»“æ„çš„ç³»ç»Ÿè°ƒç”¨ã€‚

#### åŒæ­¥æœºåˆ¶

ä¸ºäº†ç®¡ç†å¯¹å…±äº«èµ„æºçš„è®¿é—®å¹¶é¿å…ç«æ€æ¡ä»¶ï¼ŒmacOS æä¾›äº†å‡ ç§åŒæ­¥åŸè¯­ã€‚åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼Œè¿™äº›åŒæ­¥åŸè¯­è‡³å…³é‡è¦ï¼Œä»¥ç¡®ä¿æ•°æ®å®Œæ•´æ€§å’Œç³»ç»Ÿç¨³å®šæ€§ï¼š

1. **äº’æ–¥é” (Mutexes):**
* **å¸¸è§„äº’æ–¥é” (Signature: 0x4D555458):** å…·æœ‰ 60 å­—èŠ‚çš„å†…å­˜å ç”¨çš„æ ‡å‡†äº’æ–¥é”ï¼ˆ56 å­—èŠ‚ç”¨äºäº’æ–¥é”ï¼Œ4 å­—èŠ‚ç”¨äºç­¾åï¼‰ã€‚
* **å¿«é€Ÿäº’æ–¥é” (Signature: 0x4d55545A):** ç±»ä¼¼äºå¸¸è§„äº’æ–¥é”ï¼Œä½†é’ˆå¯¹æ›´å¿«çš„æ“ä½œè¿›è¡Œäº†ä¼˜åŒ–ï¼Œå¤§å°ä¹Ÿä¸º 60 å­—èŠ‚ã€‚
2. **æ¡ä»¶å˜é‡ (Condition Variables):**
* ç”¨äºç­‰å¾…ç‰¹å®šæ¡ä»¶å‘ç”Ÿï¼Œå¤§å°ä¸º 44 å­—èŠ‚ï¼ˆ40 å­—èŠ‚åŠ ä¸Š 4 å­—èŠ‚çš„ç­¾åï¼‰ã€‚
* **æ¡ä»¶å˜é‡å±æ€§ (Signature: 0x434e4441):** æ¡ä»¶å˜é‡çš„é…ç½®å±æ€§ï¼Œå¤§å°ä¸º 12 å­—èŠ‚ã€‚
3. **ä¸€æ¬¡æ€§å˜é‡ (Once Variable) (Signature: 0x4f4e4345):**
* ç¡®ä¿åˆå§‹åŒ–ä»£ç ä»…æ‰§è¡Œä¸€æ¬¡ã€‚å¤§å°ä¸º 12 å­—èŠ‚ã€‚
4. **è¯»å†™é” (Read-Write Locks):**
* ä¸€æ¬¡å…è®¸å¤šä¸ªè¯»å–è€…æˆ–ä¸€ä¸ªå†™å…¥è€…ï¼Œä¿ƒè¿›å¯¹å…±äº«æ•°æ®çš„é«˜æ•ˆè®¿é—®ã€‚
* **è¯»å†™é” (Signature: 0x52574c4b):** å¤§å°ä¸º 196 å­—èŠ‚ã€‚
* **è¯»å†™é”å±æ€§ (Signature: 0x52574c41):** è¯»å†™é”çš„å±æ€§ï¼Œå¤§å°ä¸º 20 å­—èŠ‚ã€‚

{% hint style="success" %}
è¿™äº›å¯¹è±¡çš„æœ€å 4 ä¸ªå­—èŠ‚ç”¨äºæ£€æµ‹æº¢å‡ºã€‚
{% endhint %}

### çº¿ç¨‹æœ¬åœ°å˜é‡ (TLV)

**çº¿ç¨‹æœ¬åœ°å˜é‡ (TLV)** åœ¨ Mach-O æ–‡ä»¶çš„ä¸Šä¸‹æ–‡ä¸­ï¼ˆmacOS ä¸­å¯æ‰§è¡Œæ–‡ä»¶çš„æ ¼å¼ï¼‰ç”¨äºå£°æ˜ç‰¹å®šäº**æ¯ä¸ªçº¿ç¨‹**çš„å˜é‡ï¼Œç¡®ä¿æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„å˜é‡å®ä¾‹ï¼Œæä¾›ä¸€ç§é¿å…å†²çªå¹¶ä¿æŒæ•°æ®å®Œæ•´æ€§çš„æ–¹æ³•ï¼Œè€Œæ— éœ€åƒäº’æ–¥é”é‚£æ ·æ˜¾å¼åŒæ­¥æœºåˆ¶ã€‚

åœ¨ C å’Œç›¸å…³è¯­è¨€ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ **`__thread`** å…³é”®å­—å£°æ˜çº¿ç¨‹æœ¬åœ°å˜é‡ã€‚ä»¥ä¸‹æ˜¯åœ¨æ‚¨çš„ç¤ºä¾‹ä¸­çš„å·¥ä½œæ–¹å¼ï¼š
```c
cCopy code__thread int tlv_var;

void main (int argc, char **argv){
tlv_var = 10;
}
```
è¿™ä¸ªç‰‡æ®µå°†`tlv_var`å®šä¹‰ä¸ºçº¿ç¨‹æœ¬åœ°å˜é‡ã€‚è¿è¡Œæ­¤ä»£ç çš„æ¯ä¸ªçº¿ç¨‹éƒ½å°†æ‹¥æœ‰è‡ªå·±çš„`tlv_var`ï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹`tlv_var`æ‰€åšçš„æ›´æ”¹ä¸ä¼šå½±å“å¦ä¸€ä¸ªçº¿ç¨‹ä¸­çš„`tlv_var`ã€‚

åœ¨Mach-OäºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œä¸çº¿ç¨‹æœ¬åœ°å˜é‡ç›¸å…³çš„æ•°æ®è¢«ç»„ç»‡åˆ°ç‰¹å®šçš„éƒ¨åˆ†ä¸­ï¼š

- **`__DATA.__thread_vars`**ï¼šæ­¤éƒ¨åˆ†åŒ…å«æœ‰å…³çº¿ç¨‹æœ¬åœ°å˜é‡çš„å…ƒæ•°æ®ï¼Œå¦‚å®ƒä»¬çš„ç±»å‹å’Œåˆå§‹åŒ–çŠ¶æ€ã€‚
- **`__DATA.__thread_bss`**ï¼šæ­¤éƒ¨åˆ†ç”¨äºæœªæ˜¾å¼åˆå§‹åŒ–çš„çº¿ç¨‹æœ¬åœ°å˜é‡ã€‚è¿™æ˜¯ä¸ºé›¶åˆå§‹åŒ–æ•°æ®ä¿ç•™çš„ä¸€éƒ¨åˆ†å†…å­˜ã€‚

Mach-Oè¿˜æä¾›äº†ä¸€ä¸ªåä¸º**`tlv_atexit`**çš„ç‰¹å®šAPIï¼Œç”¨äºåœ¨çº¿ç¨‹é€€å‡ºæ—¶ç®¡ç†çº¿ç¨‹æœ¬åœ°å˜é‡ã€‚æ­¤APIå…è®¸æ‚¨**æ³¨å†Œææ„å‡½æ•°** - åœ¨çº¿ç¨‹ç»ˆæ­¢æ—¶æ¸…ç†çº¿ç¨‹æœ¬åœ°æ•°æ®çš„ç‰¹æ®Šå‡½æ•°ã€‚

### çº¿ç¨‹ä¼˜å…ˆçº§

äº†è§£çº¿ç¨‹ä¼˜å…ˆçº§æ¶‰åŠæŸ¥çœ‹æ“ä½œç³»ç»Ÿå¦‚ä½•å†³å®šè¿è¡Œå“ªäº›çº¿ç¨‹ä»¥åŠä½•æ—¶è¿è¡Œçš„æ–¹å¼ã€‚è¿™ä¸ªå†³å®šå—æ¯ä¸ªçº¿ç¨‹åˆ†é…çš„ä¼˜å…ˆçº§çº§åˆ«çš„å½±å“ã€‚åœ¨macOSå’Œç±»Unixç³»ç»Ÿä¸­ï¼Œä½¿ç”¨`nice`ã€`renice`å’ŒæœåŠ¡è´¨é‡ï¼ˆQoSï¼‰ç±»ç­‰æ¦‚å¿µæ¥å¤„ç†è¿™ä¸ªé—®é¢˜ã€‚

#### Niceå’ŒRenice

1. **Nice:**
   - è¿›ç¨‹çš„`nice`å€¼æ˜¯å½±å“å…¶ä¼˜å…ˆçº§çš„æ•°å­—ã€‚æ¯ä¸ªè¿›ç¨‹çš„niceå€¼èŒƒå›´ä»-20ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰åˆ°19ï¼ˆæœ€ä½ä¼˜å…ˆçº§ï¼‰ã€‚è¿›ç¨‹åˆ›å»ºæ—¶çš„é»˜è®¤niceå€¼é€šå¸¸ä¸º0ã€‚
   - è¾ƒä½çš„niceå€¼ï¼ˆæ¥è¿‘-20ï¼‰ä½¿è¿›ç¨‹æ›´â€œè‡ªç§â€ï¼Œç›¸å¯¹äºå…·æœ‰è¾ƒé«˜niceå€¼çš„å…¶ä»–è¿›ç¨‹ï¼Œå®ƒè·å¾—æ›´å¤šçš„CPUæ—¶é—´ã€‚
2. **Renice:**
   - `renice`æ˜¯ä¸€ä¸ªç”¨äºæ›´æ”¹å·²è¿è¡Œè¿›ç¨‹niceå€¼çš„å‘½ä»¤ã€‚è¿™å¯ç”¨äºæ ¹æ®æ–°çš„niceå€¼åŠ¨æ€è°ƒæ•´è¿›ç¨‹çš„ä¼˜å…ˆçº§ï¼Œå¢åŠ æˆ–å‡å°‘å®ƒä»¬çš„CPUæ—¶é—´åˆ†é…ã€‚
   - ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªè¿›ç¨‹æš‚æ—¶éœ€è¦æ›´å¤šçš„CPUèµ„æºï¼Œæ‚¨å¯ä»¥ä½¿ç”¨`renice`é™ä½å…¶niceå€¼ã€‚

#### æœåŠ¡è´¨é‡ï¼ˆQoSï¼‰ç±»

QoSç±»æ˜¯å¤„ç†çº¿ç¨‹ä¼˜å…ˆçº§çš„ä¸€ç§æ›´ç°ä»£æ–¹æ³•ï¼Œç‰¹åˆ«æ˜¯åœ¨æ”¯æŒ**Grand Central Dispatch (GCD)**çš„macOSç­‰ç³»ç»Ÿä¸­ã€‚QoSç±»å…è®¸å¼€å‘äººå‘˜æ ¹æ®ä»»åŠ¡çš„é‡è¦æ€§æˆ–ç´§æ€¥æ€§å°†å·¥ä½œåˆ†ç±»åˆ°ä¸åŒçº§åˆ«ã€‚macOSæ ¹æ®è¿™äº›QoSç±»è‡ªåŠ¨ç®¡ç†çº¿ç¨‹ä¼˜å…ˆçº§ï¼š

1. **ç”¨æˆ·äº¤äº’ï¼š**
   - æ­¤ç±»ç”¨äºå½“å‰æ­£åœ¨ä¸ç”¨æˆ·äº¤äº’æˆ–éœ€è¦ç«‹å³æä¾›è‰¯å¥½ç”¨æˆ·ä½“éªŒæ‰€éœ€çš„å³æ—¶ç»“æœçš„ä»»åŠ¡ã€‚ä¸ºä¿æŒç•Œé¢å“åº”ï¼ˆä¾‹å¦‚åŠ¨ç”»æˆ–äº‹ä»¶å¤„ç†ï¼‰ï¼Œè¿™äº›ä»»åŠ¡è¢«èµ‹äºˆæœ€é«˜ä¼˜å…ˆçº§ã€‚
2. **ç”¨æˆ·å¯åŠ¨ï¼š**
   - ç”¨æˆ·å¯åŠ¨çš„ä»»åŠ¡éœ€è¦ç”¨æˆ·å¯åŠ¨å¹¶æœŸæœ›ç«‹å³è·å¾—ç»“æœï¼Œä¾‹å¦‚æ‰“å¼€æ–‡æ¡£æˆ–å•å‡»éœ€è¦è®¡ç®—çš„æŒ‰é’®ã€‚è¿™äº›ä»»åŠ¡å…·æœ‰è¾ƒé«˜çš„ä¼˜å…ˆçº§ï¼Œä½†ä½äºç”¨æˆ·äº¤äº’ã€‚
3. **å®ç”¨ç¨‹åºï¼š**
   - è¿™äº›ä»»åŠ¡è¿è¡Œæ—¶é—´è¾ƒé•¿ï¼Œé€šå¸¸æ˜¾ç¤ºè¿›åº¦æŒ‡ç¤ºå™¨ï¼ˆä¾‹å¦‚ä¸‹è½½æ–‡ä»¶ã€å¯¼å…¥æ•°æ®ï¼‰ã€‚å®ƒä»¬çš„ä¼˜å…ˆçº§ä½äºç”¨æˆ·å¯åŠ¨çš„ä»»åŠ¡ï¼Œä¸éœ€è¦ç«‹å³å®Œæˆã€‚
4. **åå°ï¼š**
   - æ­¤ç±»ç”¨äºåœ¨åå°è¿è¡Œä¸”å¯¹ç”¨æˆ·ä¸å¯è§çš„ä»»åŠ¡ã€‚è¿™äº›ä»»åŠ¡å¯ä»¥æ˜¯ç´¢å¼•ã€åŒæ­¥æˆ–å¤‡ä»½ç­‰ä»»åŠ¡ã€‚å®ƒä»¬å…·æœ‰æœ€ä½çš„ä¼˜å…ˆçº§ï¼Œå¯¹ç³»ç»Ÿæ€§èƒ½å½±å“æœ€å°ã€‚

ä½¿ç”¨QoSç±»ï¼Œå¼€å‘äººå‘˜æ— éœ€ç®¡ç†ç¡®åˆ‡çš„ä¼˜å…ˆçº§æ•°å­—ï¼Œè€Œæ˜¯ä¸“æ³¨äºä»»åŠ¡çš„æ€§è´¨ï¼Œç³»ç»Ÿä¼šç›¸åº”åœ°ä¼˜åŒ–CPUèµ„æºã€‚

æ­¤å¤–ï¼Œè¿˜æœ‰ä¸åŒçš„**çº¿ç¨‹è°ƒåº¦ç­–ç•¥**ï¼Œç”¨äºæŒ‡å®šè°ƒåº¦å™¨å°†è€ƒè™‘çš„ä¸€ç»„è°ƒåº¦å‚æ•°ã€‚è¿™å¯ä»¥ä½¿ç”¨`thread_policy_[set/get]`æ¥å®Œæˆã€‚è¿™åœ¨ç«äº‰æ¡ä»¶æ”»å‡»ä¸­å¯èƒ½å¾ˆæœ‰ç”¨ã€‚
### Pythonæ³¨å…¥

å¦‚æœç¯å¢ƒå˜é‡**`PYTHONINSPECT`**è¢«è®¾ç½®ï¼ŒPythonè¿›ç¨‹åœ¨å®Œæˆåå°†è¿›å…¥Pythonå‘½ä»¤è¡Œç•Œé¢ã€‚è¿˜å¯ä»¥ä½¿ç”¨**`PYTHONSTARTUP`**æŒ‡å®šåœ¨äº¤äº’ä¼šè¯å¼€å§‹æ—¶è¦æ‰§è¡Œçš„Pythonè„šæœ¬ã€‚\
ä½†æ˜¯ï¼Œè¯·æ³¨æ„ï¼Œå½“**`PYTHONINSPECT`**åˆ›å»ºäº¤äº’ä¼šè¯æ—¶ï¼Œ**`PYTHONSTARTUP`**è„šæœ¬ä¸ä¼šè¢«æ‰§è¡Œã€‚

å…¶ä»–ç¯å¢ƒå˜é‡å¦‚**`PYTHONPATH`**å’Œ**`PYTHONHOME`**ä¹Ÿå¯èƒ½å¯¹ä½¿Pythonå‘½ä»¤æ‰§è¡Œä»»æ„ä»£ç æœ‰ç”¨ã€‚

è¯·æ³¨æ„ï¼Œä½¿ç”¨**`pyinstaller`**ç¼–è¯‘çš„å¯æ‰§è¡Œæ–‡ä»¶å³ä½¿ä½¿ç”¨åµŒå…¥å¼Pythonè¿è¡Œï¼Œä¹Ÿä¸ä¼šä½¿ç”¨è¿™äº›ç¯å¢ƒå˜é‡ã€‚

{% hint style="danger" %}
æ€»çš„æ¥è¯´ï¼Œæˆ‘æ‰¾ä¸åˆ°ä¸€ç§åˆ©ç”¨ç¯å¢ƒå˜é‡æ¥ä½¿Pythonæ‰§è¡Œä»»æ„ä»£ç çš„æ–¹æ³•ã€‚\
ç„¶è€Œï¼Œå¤§å¤šæ•°äººä½¿ç”¨**Hombrew**å®‰è£…Pythonï¼Œè¿™å°†åœ¨é»˜è®¤ç®¡ç†å‘˜ç”¨æˆ·çš„**å¯å†™ä½ç½®**å®‰è£…Pythonã€‚æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼åŠ«æŒå®ƒï¼š
```bash
mv /opt/homebrew/bin/python3 /opt/homebrew/bin/python3.old
cat > /opt/homebrew/bin/python3 <<EOF
#!/bin/bash
# Extra hijack code
/opt/homebrew/bin/python3.old "$@"
EOF
chmod +x /opt/homebrew/bin/python3
```
å³ä½¿æ˜¯**root**åœ¨è¿è¡ŒPythonæ—¶ä¹Ÿä¼šè¿è¡Œæ­¤ä»£ç ã€‚
{% endhint %}

## æ£€æµ‹

### Shield

[**Shield**](https://theevilbit.github.io/shield/) ([**Github**](https://github.com/theevilbit/Shield)) æ˜¯ä¸€ä¸ªå¼€æºåº”ç”¨ç¨‹åºï¼Œå¯ä»¥**æ£€æµ‹å’Œé˜»æ­¢è¿›ç¨‹æ³¨å…¥**æ“ä½œï¼š

* ä½¿ç”¨**ç¯å¢ƒå˜é‡**ï¼šå®ƒå°†ç›‘è§†ä»¥ä¸‹ä»»ä½•ç¯å¢ƒå˜é‡çš„å­˜åœ¨ï¼š**`DYLD_INSERT_LIBRARIES`**ã€**`CFNETWORK_LIBRARY_PATH`**ã€**`RAWCAMERA_BUNDLE_PATH`** å’Œ **`ELECTRON_RUN_AS_NODE`**
* ä½¿ç”¨**`task_for_pid`** è°ƒç”¨ï¼šæŸ¥æ‰¾ä¸€ä¸ªè¿›ç¨‹æƒ³è¦è·å–å¦ä¸€ä¸ªè¿›ç¨‹çš„**ä»»åŠ¡ç«¯å£**ï¼Œä»è€Œå…è®¸åœ¨è¿›ç¨‹ä¸­æ³¨å…¥ä»£ç ã€‚
* **Electron åº”ç”¨ç¨‹åºå‚æ•°**ï¼šæŸäººå¯ä»¥ä½¿ç”¨**`--inspect`**ã€**`--inspect-brk`** å’Œ **`--remote-debugging-port`** å‘½ä»¤è¡Œå‚æ•°ä»¥è°ƒè¯•æ¨¡å¼å¯åŠ¨ Electron åº”ç”¨ç¨‹åºï¼Œä»è€Œå‘å…¶æ³¨å…¥ä»£ç ã€‚
* ä½¿ç”¨**ç¬¦å·é“¾æ¥**æˆ–**ç¡¬é“¾æ¥**ï¼šé€šå¸¸æœ€å¸¸è§çš„æ»¥ç”¨æ˜¯**ä½¿ç”¨æˆ‘ä»¬çš„ç”¨æˆ·æƒé™æ”¾ç½®ä¸€ä¸ªé“¾æ¥**ï¼Œå¹¶**å°†å…¶æŒ‡å‘æ›´é«˜æƒé™**çš„ä½ç½®ã€‚å¯¹äºç¡¬é“¾æ¥å’Œç¬¦å·é“¾æ¥ï¼Œæ£€æµ‹éå¸¸ç®€å•ã€‚å¦‚æœåˆ›å»ºé“¾æ¥çš„è¿›ç¨‹å…·æœ‰**ä¸åŒçš„æƒé™çº§åˆ«**ï¼Œåˆ™æˆ‘ä»¬ä¼šåˆ›å»ºä¸€ä¸ª**è­¦æŠ¥**ã€‚ä¸å¹¸çš„æ˜¯ï¼Œåœ¨ç¬¦å·é“¾æ¥çš„æƒ…å†µä¸‹ï¼Œé˜»æ­¢æ˜¯ä¸å¯èƒ½çš„ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨åˆ›å»ºé“¾æ¥ä¹‹å‰æ²¡æœ‰å…³äºé“¾æ¥ç›®æ ‡çš„ä¿¡æ¯ã€‚è¿™æ˜¯è‹¹æœ EndpointSecuriy æ¡†æ¶çš„ä¸€ä¸ªé™åˆ¶ã€‚

### å…¶ä»–è¿›ç¨‹å‘å‡ºçš„è°ƒç”¨

åœ¨[**è¿™ç¯‡åšæ–‡**](https://knight.sc/reverse%20engineering/2019/04/15/detecting-task-modifications.html)ä¸­ï¼Œæ‚¨å¯ä»¥äº†è§£å¦‚ä½•ä½¿ç”¨å‡½æ•°**`task_name_for_pid`**è·å–æœ‰å…³å…¶ä»–**åœ¨è¿›ç¨‹ä¸­æ³¨å…¥ä»£ç çš„è¿›ç¨‹**çš„ä¿¡æ¯ï¼Œç„¶åè·å–æœ‰å…³è¯¥å…¶ä»–è¿›ç¨‹çš„ä¿¡æ¯ã€‚

è¯·æ³¨æ„ï¼Œè¦è°ƒç”¨è¯¥å‡½æ•°ï¼Œæ‚¨éœ€è¦ä¸è¿è¡Œè¿›ç¨‹çš„ç”¨æˆ·ç›¸åŒçš„uidæˆ–**root**ï¼ˆå®ƒè¿”å›æœ‰å…³è¿›ç¨‹çš„ä¿¡æ¯ï¼Œè€Œä¸æ˜¯æ³¨å…¥ä»£ç çš„æ–¹æ³•ï¼‰ã€‚

## å‚è€ƒèµ„æ–™

* [https://theevilbit.github.io/shield/](https://theevilbit.github.io/shield/)
* [https://medium.com/@metnew/why-electron-apps-cant-store-your-secrets-confidentially-inspect-option-a49950d6d51f](https://medium.com/@metnew/why-electron-apps-cant-store-your-secrets-confidentially-inspect-option-a49950d6d51f)

{% hint style="success" %}
å­¦ä¹ å¹¶ç»ƒä¹  AWS é»‘å®¢æŠ€èƒ½ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å¹¶ç»ƒä¹  GCP é»‘å®¢æŠ€èƒ½ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** ä¸Šå…³æ³¨æˆ‘ä»¬**ã€‚
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
