# macOS xpc\_connection\_get\_audit\_token Attack

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

**For further information check the original post:** [**https://sector7.computest.nl/post/2023-10-xpc-audit-token-spoofing/**](https://sector7.computest.nl/post/2023-10-xpc-audit-token-spoofing/). This is a summary:

## Mach Messages Basic Info

рдпрджрд┐ рдЖрдк рдирд╣реАрдВ рдЬрд╛рдирддреЗ рдХрд┐ Mach Messages рдХреНрдпрд╛ рд╣реИрдВ, рддреЛ рдЗрд╕ рдкреГрд╖реНрда рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ:

{% content-ref url="../../" %}
[..](../../)
{% endcontent-ref %}

рдЗрд╕ рд╕рдордп рдпрд╛рдж рд░рдЦреЗрдВ рдХрд┐ ([рдпрд╣рд╛рдБ рд╕реЗ рдкрд░рд┐рднрд╛рд╖рд╛](https://sector7.computest.nl/post/2023-10-xpc-audit-token-spoofing)):\
Mach рд╕рдВрджреЗрд╢ рдПрдХ _mach рдкреЛрд░реНрдЯ_ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рднреЗрдЬреЗ рдЬрд╛рддреЗ рд╣реИрдВ, рдЬреЛ mach рдХрд░реНрдиреЗрд▓ рдореЗрдВ рдирд┐рд░реНрдорд┐рдд рдПрдХ **рдПрдХрд▓ рд░рд┐рд╕реАрд╡рд░, рдХрдИ рдкреНрд░реЗрд╖рдХ рд╕рдВрдЪрд╛рд░** рдЪреИрдирд▓ рд╣реИред **рдХрдИ рдкреНрд░рдХреНрд░рд┐рдпрд╛рдПрдБ рд╕рдВрджреЗрд╢ рднреЗрдЬ рд╕рдХрддреА рд╣реИрдВ** рдПрдХ mach рдкреЛрд░реНрдЯ рдкрд░, рд▓реЗрдХрд┐рди рдХрд┐рд╕реА рднреА рд╕рдордп **рдХреЗрд╡рд▓ рдПрдХрд▓ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рд╣реА рдЗрд╕реЗ рдкрдврд╝ рд╕рдХрддреА рд╣реИ**ред рдлрд╝рд╛рдЗрд▓ рд╡рд░реНрдгрдирдХрд░реНрддрд╛рдУрдВ рдФрд░ рд╕реЙрдХреЗрдЯ рдХреА рддрд░рд╣, mach рдкреЛрд░реНрдЯ рдХрд░реНрдиреЗрд▓ рджреНрд╡рд╛рд░рд╛ рдЖрд╡рдВрдЯрд┐рдд рдФрд░ рдкреНрд░рдмрдВрдзрд┐рдд рд╣реЛрддреЗ рд╣реИрдВ рдФрд░ рдкреНрд░рдХреНрд░рд┐рдпрд╛рдПрдБ рдХреЗрд╡рд▓ рдПрдХ рдкреВрд░реНрдгрд╛рдВрдХ рджреЗрдЦрддреА рд╣реИрдВ, рдЬрд┐рд╕рдХрд╛ рд╡реЗ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХрд░реНрдиреЗрд▓ рдХреЛ рдпрд╣ рд╕рдВрдХреЗрдд рджреЗ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рд╡реЗ рдЕрдкрдиреЗ рдХрд┐рд╕ mach рдкреЛрд░реНрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВред

## XPC Connection

рдпрджрд┐ рдЖрдк рдирд╣реАрдВ рдЬрд╛рдирддреЗ рдХрд┐ XPC рдХрдиреЗрдХреНрд╢рди рдХреИрд╕реЗ рд╕реНрдерд╛рдкрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдЬрд╛рдВрдЪреЗрдВ:

{% content-ref url="../" %}
[..](../)
{% endcontent-ref %}

## Vuln Summary

рдЖрдкрдХреЗ рд▓рд┐рдП рдЬрд╛рдирдирд╛ рджрд┐рд▓рдЪрд╕реНрдк рд╣реИ рдХрд┐ **XPC рдХрд╛ рдЕрдореВрд░реНрддрддрд╛ рдПрдХ-рд╕реЗ-рдПрдХ рдХрдиреЗрдХреНрд╢рди рд╣реИ**, рд▓реЗрдХрд┐рди рдпрд╣ рдПрдХ рдРрд╕реА рддрдХрдиреАрдХ рдХреЗ рд╢реАрд░реНрд╖ рдкрд░ рдЖрдзрд╛рд░рд┐рдд рд╣реИ рдЬрд┐рд╕рдореЗрдВ **рдХрдИ рдкреНрд░реЗрд╖рдХ рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП:**

* Mach рдкреЛрд░реНрдЯ рдПрдХрд▓ рд░рд┐рд╕реАрд╡рд░, **рдХрдИ рдкреНрд░реЗрд╖рдХ** рд╣реИрдВред
* рдПрдХ XPC рдХрдиреЗрдХреНрд╢рди рдХрд╛ рдСрдбрд┐рдЯ рдЯреЛрдХрди **рд╣рд╛рд▓ рд╣реА рдореЗрдВ рдкреНрд░рд╛рдкреНрдд рд╕рдВрджреЗрд╢ рд╕реЗ рдХреЙрдкреА рдХрд┐рдпрд╛ рдЧрдпрд╛ рдСрдбрд┐рдЯ рдЯреЛрдХрди** рд╣реИред
* рдПрдХ XPC рдХрдиреЗрдХреНрд╢рди рдХрд╛ **рдСрдбрд┐рдЯ рдЯреЛрдХрди** рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ рдХрдИ **рд╕реБрд░рдХреНрд╖рд╛ рдЬрд╛рдВрдЪреЛрдВ** рдХреЗ рд▓рд┐рдП рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИред

рд╣рд╛рд▓рд╛рдВрдХрд┐ рдкрд┐рдЫрд▓реА рд╕реНрдерд┐рддрд┐ рдЖрд╢рд╛рдЬрдирдХ рд▓рдЧрддреА рд╣реИ, рдХреБрдЫ рдкрд░рд┐рджреГрд╢реНрдп рд╣реИрдВ рдЬрд╣рд╛рдБ рдпрд╣ рд╕рдорд╕реНрдпрд╛рдПрдБ рдЙрддреНрдкрдиреНрди рдирд╣реАрдВ рдХрд░реЗрдЧрд╛ ([рдпрд╣рд╛рдБ рд╕реЗ](https://sector7.computest.nl/post/2023-10-xpc-audit-token-spoofing)):

* рдСрдбрд┐рдЯ рдЯреЛрдХрди рдЕрдХреНрд╕рд░ рдПрдХ рдкреНрд░рд╛рдзрд┐рдХрд░рдг рдЬрд╛рдВрдЪ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВ рдпрд╣ рддрдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐ рдХрдиреЗрдХреНрд╢рди рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рдирд╛ рд╣реИ рдпрд╛ рдирд╣реАрдВред рдЪреВрдВрдХрд┐ рдпрд╣ рд╕реЗрд╡рд╛ рдкреЛрд░реНрдЯ рдкрд░ рдПрдХ рд╕рдВрджреЗрд╢ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╣реЛрддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП **рдЕрднреА рддрдХ рдХреЛрдИ рдХрдиреЗрдХреНрд╢рди рд╕реНрдерд╛рдкрд┐рдд рдирд╣реАрдВ рд╣реБрдЖ рд╣реИ**ред рдЗрд╕ рдкреЛрд░реНрдЯ рдкрд░ рдЕрдзрд┐рдХ рд╕рдВрджреЗрд╢ рдХреЗрд╡рд▓ рдЕрддрд┐рд░рд┐рдХреНрдд рдХрдиреЗрдХреНрд╢рди рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЗ рд░реВрдк рдореЗрдВ рд╕рдВрднрд╛рд▓реЗ рдЬрд╛рдПрдВрдЧреЗред рдЗрд╕рд▓рд┐рдП рдХрдиреЗрдХреНрд╢рди рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рдХреЛрдИ рднреА **рдЬрд╛рдВрдЪреЗрдВ рдХрдордЬреЛрд░ рдирд╣реАрдВ рд╣реИрдВ** (рдЗрд╕рдХрд╛ рдорддрд▓рдм рдпрд╣ рднреА рд╣реИ рдХрд┐ `-listener:shouldAcceptNewConnection:` рдХреЗ рднреАрддрд░ рдСрдбрд┐рдЯ рдЯреЛрдХрди рд╕реБрд░рдХреНрд╖рд┐рдд рд╣реИ)ред рдЗрд╕рд▓рд┐рдП рд╣рдо **рд╡рд┐рд╢рд┐рд╖реНрдЯ рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреА рдкреБрд╖реНрдЯрд┐ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ XPC рдХрдиреЗрдХреНрд╢рдиреЛрдВ рдХреА рддрд▓рд╛рд╢ рдХрд░ рд░рд╣реЗ рд╣реИрдВ**ред
* XPC рдЗрд╡реЗрдВрдЯ рд╣реИрдВрдбрд▓рд░ рд╕рдордХрд╛рд▓рд┐рдХ рд░реВрдк рд╕реЗ рд╕рдВрднрд╛рд▓реЗ рдЬрд╛рддреЗ рд╣реИрдВред рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдПрдХ рд╕рдВрджреЗрд╢ рдХреЗ рд▓рд┐рдП рдЗрд╡реЗрдВрдЯ рд╣реИрдВрдбрд▓рд░ рдХреЛ рдЕрдЧрд▓реЗ рдХреЗ рд▓рд┐рдП рдХреЙрд▓ рдХрд░рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рдкреВрд░рд╛ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП, рдпрд╣рд╛рдВ рддрдХ рдХрд┐ рд╕рдорд╡рд░реНрддреА рдбрд┐рд╕реНрдкреИрдЪ рдХрддрд╛рд░реЛрдВ рдкрд░ рднреАред рдЗрд╕рд▓рд┐рдП рдПрдХ **XPC рдЗрд╡реЗрдВрдЯ рд╣реИрдВрдбрд▓рд░ рдХреЗ рднреАрддрд░ рдСрдбрд┐рдЯ рдЯреЛрдХрди рдХреЛ рдЕрдиреНрдп рд╕рд╛рдорд╛рдиреНрдп (рдЧреИрд░-рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛!) рд╕рдВрджреЗрд╢реЛрдВ рджреНрд╡рд╛рд░рд╛ рдЕрдзрд┐рд▓реЗрдЦрд┐рдд рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ**ред

рдпрд╣ рджреЛ рдЕрд▓рдЧ-рдЕрд▓рдЧ рддрд░реАрдХреЛрдВ рд╕реЗ рд╢реЛрд╖рдг рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:

1. Variant1:
* **рд╢реЛрд╖рдг** **рд╕реЗрд╡рд╛** **A** рдФрд░ рд╕реЗрд╡рд╛ **B** рд╕реЗ **рдЬреБрдбрд╝рддрд╛ рд╣реИ**
* рд╕реЗрд╡рд╛ **B** рд╕реЗрд╡рд╛ A рдореЗрдВ рдПрдХ **рд╡рд┐рд╢рд┐рд╖реНрдЯ рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛** рдХреЛ рдХреЙрд▓ рдХрд░ рд╕рдХрддреА рд╣реИ рдЬрд┐рд╕реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╣реАрдВ рдХрд░ рд╕рдХрддрд╛
* рд╕реЗрд╡рд╛ **A** **`xpc_connection_get_audit_token`** рдХреЛ рдХреЙрд▓ рдХрд░рддреА рд╣реИ рдЬрдмрдХрд┐ _**рдирд╣реАрдВ**_ рдПрдХ рдХрдиреЗрдХреНрд╢рди рдХреЗ рд▓рд┐рдП **рдЗрд╡реЗрдВрдЯ рд╣реИрдВрдбрд▓рд░** рдХреЗ рднреАрддрд░ рдПрдХ **`dispatch_async`** рдореЗрдВред
* рдЗрд╕рд▓рд┐рдП рдПрдХ **рдЕрд▓рдЧ** рд╕рдВрджреЗрд╢ **рдСрдбрд┐рдЯ рдЯреЛрдХрди рдХреЛ рдЕрдзрд┐рд▓реЗрдЦрд┐рдд рдХрд░ рд╕рдХрддрд╛ рд╣реИ** рдХреНрдпреЛрдВрдХрд┐ рдЗрд╕реЗ рдЗрд╡реЗрдВрдЯ рд╣реИрдВрдбрд▓рд░ рдХреЗ рдмрд╛рд╣рд░ рдЕрд╕рд┐рдВрдХреНрд░реЛрдирд╕ рд░реВрдк рд╕реЗ рднреЗрдЬрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИред
* рд╢реЛрд╖рдг **рд╕реЗрд╡рд╛ B рдХреЛ рд╕реЗрд╡рд╛ A рдХреЗ рд▓рд┐рдП SEND рдЕрдзрд┐рдХрд╛рд░** рджреЗрддрд╛ рд╣реИред
* рдЗрд╕рд▓рд┐рдП svc **B** рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рд╕реЗрд╡рд╛ **A** рдХреЛ **рд╕рдВрджреЗрд╢ рднреЗрдЬреЗрдЧрд╛**ред
* **рд╢реЛрд╖рдг** **рд╡рд┐рд╢рд┐рд╖реНрдЯ рдХреНрд░рд┐рдпрд╛ рдХреЛ рдХреЙрд▓ рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░рддрд╛ рд╣реИред** рдПрдХ RC svc **A** рдЗрд╕ **рдХреНрд░рд┐рдпрд╛** рдХреЗ рдкреНрд░рд╛рдзрд┐рдХрд░рдг рдХреА **рдЬрд╛рдВрдЪ** рдХрд░рддрд╛ рд╣реИ рдЬрдмрдХрд┐ **svc B рдиреЗ рдСрдбрд┐рдЯ рдЯреЛрдХрди рдХреЛ рдЕрдзрд┐рд▓реЗрдЦрд┐рдд рдХрд┐рдпрд╛** (рд╢реЛрд╖рдг рдХреЛ рд╡рд┐рд╢реЗрд╖ рдХреНрд░рд┐рдпрд╛ рдХреЛ рдХреЙрд▓ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ)ред
2. Variant 2:
* рд╕реЗрд╡рд╛ **B** рд╕реЗрд╡рд╛ A рдореЗрдВ рдПрдХ **рд╡рд┐рд╢рд┐рд╖реНрдЯ рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛** рдХреЛ рдХреЙрд▓ рдХрд░ рд╕рдХрддреА рд╣реИ рдЬрд┐рд╕реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╣реАрдВ рдХрд░ рд╕рдХрддрд╛
* рд╢реЛрд╖рдг **рд╕реЗрд╡рд╛ A** рд╕реЗ рдЬреБрдбрд╝рддрд╛ рд╣реИ рдЬреЛ рд╢реЛрд╖рдг рдХреЛ рдПрдХ **рд╕рдВрджреЗрд╢ рднреЗрдЬрддрд╛ рд╣реИ рдЬреЛ рдПрдХ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХреА рдЕрдкреЗрдХреНрд╖рд╛ рдХрд░рддрд╛ рд╣реИ** рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ **рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛** **рдкреЛрд░реНрдЯ** рдореЗрдВред
* рд╢реЛрд╖рдг **рд╕реЗрд╡рд╛** B рдХреЛ рдПрдХ рд╕рдВрджреЗрд╢ рднреЗрдЬрддрд╛ рд╣реИ рдЬреЛ **рдЙрд╕ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдкреЛрд░реНрдЯ** рдХреЛ рдкрд╛рд╕ рдХрд░рддрд╛ рд╣реИред
* рдЬрдм рд╕реЗрд╡рд╛ **B рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рджреЗрддреА рд╣реИ**, рдпрд╣ рд╕реЗрд╡рд╛ A рдХреЛ рд╕рдВрджреЗрд╢ рднреЗрдЬрддреА рд╣реИ, **рдЬрдмрдХрд┐** **рд╢реЛрд╖рдг** рд╕реЗрд╡рд╛ A рдХреЛ рдПрдХ рдЕрд▓рдЧ **рд╕рдВрджреЗрд╢ рднреЗрдЬрддрд╛ рд╣реИ** рдЬреЛ рдПрдХ **рд╡рд┐рд╢рд┐рд╖реНрдЯ рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛** рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░ рд░рд╣рд╛ рд╣реИ рдФрд░ рдЙрдореНрдореАрдж рдХрд░ рд░рд╣рд╛ рд╣реИ рдХрд┐ рд╕реЗрд╡рд╛ B рд╕реЗ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдСрдбрд┐рдЯ рдЯреЛрдХрди рдХреЛ рд╕рд╣реА рд╕рдордп рдкрд░ рдЕрдзрд┐рд▓реЗрдЦрд┐рдд рдХрд░реЗрдЧреА (рд░реЗрд╕ рдХрдВрдбреАрд╢рди)ред

## Variant 1: calling xpc\_connection\_get\_audit\_token outside of an event handler <a href="#variant-1-calling-xpc_connection_get_audit_token-outside-of-an-event-handler" id="variant-1-calling-xpc_connection_get_audit_token-outside-of-an-event-handler"></a>

рдкрд░рд┐рджреГрд╢реНрдп:

* рджреЛ mach рд╕реЗрд╡рд╛рдПрдБ **`A`** рдФрд░ **`B`** рдЬрд┐рдирд╕реЗ рд╣рдо рджреЛрдиреЛрдВ рдХрдиреЗрдХреНрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ (рд╕реИрдВрдбрдмреЙрдХреНрд╕ рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рдФрд░ рдХрдиреЗрдХреНрд╢рди рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рдкреНрд░рд╛рдзрд┐рдХрд░рдг рдЬрд╛рдВрдЪ рдХреЗ рдЖрдзрд╛рд░ рдкрд░)ред
* _**A**_ рдХреЛ рдПрдХ **рдкреНрд░рд╛рдзрд┐рдХрд░рдг рдЬрд╛рдВрдЪ** рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдП рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдХреНрд░рд┐рдпрд╛ рдХреЗ рд▓рд┐рдП рдЬрд┐рд╕реЗ **`B`** рдкрд╛рд╕ рдХрд░ рд╕рдХрддрд╛ рд╣реИ (рд▓реЗрдХрд┐рди рд╣рдорд╛рд░рд╛ рдРрдк рдирд╣реАрдВ)ред
* рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдпрджрд┐ B рдХреЗ рдкрд╛рд╕ рдХреБрдЫ **рдЕрдзрд┐рдХрд╛рд░** рд╣реИрдВ рдпрд╛ рдпрд╣ **рд░реВрдЯ** рдХреЗ рд░реВрдк рдореЗрдВ рдЪрд▓ рд░рд╣рд╛ рд╣реИ, рддреЛ рдпрд╣ рдЙрд╕реЗ A рд╕реЗ рдПрдХ рд╡рд┐рд╢реЗрд╖ рдХреНрд░рд┐рдпрд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╣рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗ рд╕рдХрддрд╛ рд╣реИред
* рдЗрд╕ рдкреНрд░рд╛рдзрд┐рдХрд░рдг рдЬрд╛рдВрдЪ рдХреЗ рд▓рд┐рдП, **`A`** рдЕрд╕рд┐рдВрдХреНрд░реЛрдирд╕ рд░реВрдк рд╕реЗ рдСрдбрд┐рдЯ рдЯреЛрдХрди рдкреНрд░рд╛рдкреНрдд рдХрд░рддрд╛ рд╣реИ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП `dispatch_async` рд╕реЗ **`xpc_connection_get_audit_token`** рдХреЛ рдХреЙрд▓ рдХрд░рдХреЗред

{% hint style="danger" %}
рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдПрдХ **рд░реЗрд╕ рдХрдВрдбреАрд╢рди** рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдЬрд┐рд╕рд╕реЗ рдПрдХ **рд╢реЛрд╖рдг** рд╣реЛрддрд╛ рд╣реИ рдЬреЛ **A рд╕реЗ рдПрдХ рдХреНрд░рд┐рдпрд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╣рддрд╛ рд╣реИ** рдХрдИ рдмрд╛рд░ рдЬрдмрдХрд┐ **B `A` рдХреЛ рд╕рдВрджреЗрд╢ рднреЗрдЬрддрд╛ рд╣реИ**ред рдЬрдм RC **рд╕рдлрд▓** рд╣реЛрддрд╛ рд╣реИ, рддреЛ **B** рдХрд╛ **рдСрдбрд┐рдЯ рдЯреЛрдХрди** рдореЗрдореЛрд░реА рдореЗрдВ рдХреЙрдкреА рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ **рдЬрдмрдХрд┐** рд╣рдорд╛рд░реЗ **рд╢реЛрд╖рдг** рдХрд╛ рдЕрдиреБрд░реЛрдз A рджреНрд╡рд╛рд░рд╛ **рд╕рдВрднрд╛рд▓рд╛** рдЬрд╛ рд░рд╣рд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдЗрд╕реЗ **рд╡рд┐рд╢реЗрд╖ рдХреНрд░рд┐рдпрд╛ рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдорд┐рд▓рддреА рд╣реИ рдЬрд┐рд╕реЗ рдХреЗрд╡рд▓ B рдЕрдиреБрд░реЛрдз рдХрд░ рд╕рдХрддрд╛ рдерд╛**ред
{% endhint %}

рдпрд╣ **`A`** рдХреЗ рд░реВрдк рдореЗрдВ `smd` рдФрд░ **`B`** рдХреЗ рд░реВрдк рдореЗрдВ `diagnosticd` рдХреЗ рд╕рд╛рде рд╣реБрдЖред рдлрд╝рдВрдХреНрд╢рди [`SMJobBless`](https://developer.apple.com/documentation/servicemanagement/1431078-smjobbless?language=objc) рдХреЛ рдПрдХ рдирдпрд╛ рд╡рд┐рд╢реЗрд╖ рд╕рд╣рд╛рдпрдХ рдЯреВрд▓ рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП (рдЬреИрд╕реЗ **рд░реВрдЯ** рдХреЗ рд░реВрдк рдореЗрдВ) рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдпрджрд┐ рдХреЛрдИ **рд░реВрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рдЪрд▓рдиреЗ рд╡рд╛рд▓реА рдкреНрд░рдХреНрд░рд┐рдпрд╛** **smd** рд╕реЗ рд╕рдВрдкрд░реНрдХ рдХрд░рддреА рд╣реИ, рддреЛ рдХреЛрдИ рдЕрдиреНрдп рдЬрд╛рдВрдЪ рдирд╣реАрдВ рдХреА рдЬрд╛рдПрдЧреАред

рдЗрд╕рд▓рд┐рдП, рд╕реЗрд╡рд╛ **B** **`diagnosticd`** рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ **рд░реВрдЯ** рдХреЗ рд░реВрдк рдореЗрдВ рдЪрд▓рддреА рд╣реИ рдФрд░ рдПрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреА **рдирд┐рдЧрд░рд╛рдиреА** рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИ, рдЗрд╕рд▓рд┐рдП рдПрдХ рдмрд╛рд░ рдирд┐рдЧрд░рд╛рдиреА рд╢реБрд░реВ рд╣реЛрдиреЗ рдкрд░, рдпрд╣ **рдкреНрд░рддрд┐ рд╕реЗрдХрдВрдб рдХрдИ рд╕рдВрджреЗрд╢ рднреЗрдЬреЗрдЧреАред**

рд╣рдорд▓реЗ рдХреЛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП:

1. рдорд╛рдирдХ XPC рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ `smd` рдирд╛рдордХ рд╕реЗрд╡рд╛ рд╕реЗ рдПрдХ **рдХрдиреЗрдХреНрд╢рди** рдкреНрд░рд╛рд░рдВрдн рдХрд░реЗрдВред
2. `diagnosticd` рд╕реЗ рдПрдХ рджреНрд╡рд┐рддреАрдпрдХ **рдХрдиреЗрдХреНрд╢рди** рдмрдирд╛рдПрдВред рд╕рд╛рдорд╛рдиреНрдп рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рд╡рд┐рдкрд░реАрдд, рджреЛ рдирдП mach рдкреЛрд░реНрдЯ рдмрдирд╛рдиреЗ рдФрд░ рднреЗрдЬрдиреЗ рдХреЗ рдмрдЬрд╛рдп, рдХреНрд▓рд╛рдЗрдВрдЯ рдкреЛрд░реНрдЯ рднреЗрдЬрдиреЗ рдХрд╛ рдЕрдзрд┐рдХрд╛рд░ `smd` рдХрдиреЗрдХреНрд╢рди рд╕реЗ рдЬреБрдбрд╝реЗ **send right** рдХреА рдПрдХ рдбреБрдкреНрд▓рд┐рдХреЗрдЯ рдХреЗ рд╕рд╛рде рдкреНрд░рддрд┐рд╕реНрдерд╛рдкрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред
3. рдкрд░рд┐рдгрд╛рдорд╕реНрд╡рд░реВрдк, XPC рд╕рдВрджреЗрд╢ `diagnosticd` рдХреЛ рднреЗрдЬреЗ рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди `diagnosticd` рд╕реЗ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛рдПрдБ `smd` рдкрд░ рдкреБрдирдГ рдорд╛рд░реНрдЧрд┐рдд рдХреА рдЬрд╛рддреА рд╣реИрдВред `smd` рдХреЗ рд▓рд┐рдП, рдРрд╕рд╛ рдкреНрд░рддреАрдд рд╣реЛрддрд╛ рд╣реИ рдХрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдФрд░ `diagnosticd` рджреЛрдиреЛрдВ рд╕реЗ рд╕рдВрджреЗрд╢ рдПрдХ рд╣реА рдХрдиреЗрдХреНрд╢рди рд╕реЗ рдЙрддреНрдкрдиреНрди рд╣реЛ рд░рд╣реЗ рд╣реИрдВред

![Image depicting the exploit process](https://sector7.computest.nl/post/2023-10-xpc-audit-token-spoofing/exploit.png)

4. рдЕрдЧрд▓рд╛ рдХрджрдо `diagnosticd` рдХреЛ рдПрдХ рдЪреБрдиреА рд╣реБрдИ рдкреНрд░рдХреНрд░рд┐рдпрд╛ (рд╕рдВрднрд╡рддрдГ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА рдЕрдкрдиреА) рдХреА рдирд┐рдЧрд░рд╛рдиреА рд╢реБрд░реВ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдирд┐рд░реНрджреЗрд╢рд┐рдд рдХрд░рдирд╛ рд╣реИред рд╕рд╛рде рд╣реА, `smd` рдХреЛ рдирд┐рдпрдорд┐рдд 1004 рд╕рдВрджреЗрд╢реЛрдВ рдХреА рдмрд╛рдврд╝ рднреЗрдЬреА рдЬрд╛рддреА рд╣реИред рдпрд╣рд╛рдБ рдЙрджреНрджреЗрд╢реНрдп рдПрдХ рдЙрдЪреНрдЪ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдХреЗ рд╕рд╛рде рдПрдХ рдЯреВрд▓ рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдирд╛ рд╣реИред
5. рдпрд╣ рдХреНрд░рд┐рдпрд╛ `handle_bless` рдлрд╝рдВрдХреНрд╢рди рдХреЗ рднреАрддрд░ рдПрдХ рд░реЗрд╕ рдХрдВрдбреАрд╢рди рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд░рддреА рд╣реИред рд╕рдордп рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИ: `xpc_connection_get_pid` рдлрд╝рдВрдХреНрд╢рди рдХреЙрд▓ рдХреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХрд╛ PID рд▓реМрдЯрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП (рдХреНрдпреЛрдВрдХрд┐ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдЯреВрд▓ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдРрдк рдмрдВрдбрд▓ рдореЗрдВ рд╕реНрдерд┐рдд рд╣реИ)ред рд╣рд╛рд▓рд╛рдБрдХрд┐, `xpc_connection_get_audit_token` рдлрд╝рдВрдХреНрд╢рди, рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ `connection_is_authorized` рдЙрдкрд░реВрдЯреАрди рдХреЗ рднреАрддрд░, рдХреЛ `diagnosticd` рдХреЗ рдСрдбрд┐рдЯ рдЯреЛрдХрди рдХрд╛ рд╕рдВрджрд░реНрдн рджреЗрдирд╛ рдЪрд╛рд╣рд┐рдПред

## Variant 2: reply forwarding

рдПрдХ XPC (рдХреНрд░реЙрд╕-рдкреНрд░реЛрд╕реЗрд╕ рд╕рдВрдЪрд╛рд░) рд╡рд╛рддрд╛рд╡рд░рдг рдореЗрдВ, рд╣рд╛рд▓рд╛рдВрдХрд┐ рдЗрд╡реЗрдВрдЯ рд╣реИрдВрдбрд▓рд░ рд╕рдорд╡рд░реНрддреА рд░реВрдк рд╕реЗ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдирд╣реАрдВ рд╣реЛрддреЗ рд╣реИрдВ, рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рд╕рдВрджреЗрд╢реЛрдВ рдХреЛ рд╕рдВрднрд╛рд▓рдиреЗ рдХрд╛ рдПрдХ рдЕрдиреВрдард╛ рд╡реНрдпрд╡рд╣рд╛рд░ рд╣реЛрддрд╛ рд╣реИред рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ, рд╕рдВрджреЗрд╢ рднреЗрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рджреЛ рдЕрд▓рдЧ-рдЕрд▓рдЧ рддрд░реАрдХреЗ рд╣реИрдВ рдЬреЛ рдПрдХ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХреА рдЕрдкреЗрдХреНрд╖рд╛ рдХрд░рддреЗ рд╣реИрдВ:

1. **`xpc_connection_send_message_with_reply`**: рдпрд╣рд╛рдБ, XPC рд╕рдВрджреЗрд╢ рдХреЛ рдПрдХ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрддрд╛рд░ рдкрд░ рдкреНрд░рд╛рдкреНрдд рдФрд░ рд╕рдВрд╕рд╛рдзрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред
2. **`xpc_connection_send_message_with_reply_sync`**: рдЗрд╕рдХреЗ рд╡рд┐рдкрд░реАрдд, рдЗрд╕ рд╡рд┐рдзрд┐ рдореЗрдВ, XPC рд╕рдВрджреЗрд╢ рдХреЛ рд╡рд░реНрддрдорд╛рди рдбрд┐рд╕реНрдкреИрдЪ рдХрддрд╛рд░ рдкрд░ рдкреНрд░рд╛рдкреНрдд рдФрд░ рд╕рдВрд╕рд╛рдзрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

рдпрд╣ рднреЗрдж рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ **рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдкреИрдХреЗрдЯреЛрдВ рдХреЗ XPC рдЗрд╡реЗрдВрдЯ рд╣реИрдВрдбрд▓рд░ рдХреЗ рдирд┐рд╖реНрдкрд╛рджрди рдХреЗ рд╕рд╛рде рд╕рдорд╡рд░реНрддреА рд░реВрдк рд╕реЗ рдкрд╛рд░реНрд╕ рд╣реЛрдиреЗ рдХреА рд╕рдВрднрд╛рд╡рдирд╛** рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ, рдЬрдмрдХрд┐ `_xpc_connection_set_creds` рдЖрдВрд╢рд┐рдХ рд░реВрдк рд╕реЗ рдСрдбрд┐рдЯ рдЯреЛрдХрди рдХреЗ рдЕрдзрд┐рд▓реЗрдЦрди рд╕реЗ рдмрдЪрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рд▓реЙрдХрд┐рдВрдЧ рд▓рд╛рдЧреВ рдХрд░рддрд╛ рд╣реИ, рдпрд╣ рдкреВрд░реЗ рдХрдиреЗрдХреНрд╢рди рдСрдмреНрдЬреЗрдХреНрдЯ рдХреЗ рд▓рд┐рдП рдЗрд╕ рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ рдмрдврд╝рд╛рддрд╛ рдирд╣реАрдВ рд╣реИред рдкрд░рд┐рдгрд╛рдорд╕реНрд╡рд░реВрдк, рдпрд╣ рдПрдХ рдХрдордЬреЛрд░ рд╕реНрдерд┐рддрд┐ рдЙрддреНрдкрдиреНрди рдХрд░рддрд╛ рд╣реИ рдЬрд╣рд╛рдБ рдСрдбрд┐рдЯ рдЯреЛрдХрди рдХреЛ рдПрдХ рдкреИрдХреЗрдЯ рдХреЗ рдкрд╛рд░реНрд╕рд┐рдВрдЧ рдФрд░ рдЗрд╕рдХреЗ рдЗрд╡реЗрдВрдЯ рд╣реИрдВрдбрд▓рд░ рдХреЗ рдирд┐рд╖реНрдкрд╛рджрди рдХреЗ рдмреАрдЪ рдХреЗ рдЕрдВрддрд░рд╛рд▓ рдХреЗ рджреМрд░рд╛рди рдкреНрд░рддрд┐рд╕реНрдерд╛рдкрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

рдЗрд╕ рдХрдордЬреЛрд░ рд╕реНрдерд┐рддрд┐ рдХрд╛ рд╢реЛрд╖рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕реЗрдЯрдЕрдк рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ:

* рджреЛ mach рд╕реЗрд╡рд╛рдПрдБ, рдЬрд┐рдиреНрд╣реЗрдВ **`A`** рдФрд░ **`B`** рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬрд┐рдирд╕реЗ рдХрдиреЗрдХреНрд╢рди рд╕реНрдерд╛рдкрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред
* рд╕реЗрд╡рд╛ **`A`** рдХреЛ рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдХреНрд░рд┐рдпрд╛ рдХреЗ рд▓рд┐рдП рдПрдХ рдкреНрд░рд╛рдзрд┐рдХрд░рдг рдЬрд╛рдВрдЪ рд╢рд╛рдорд┐рд▓ рдХрд░рдиреА рдЪрд╛рд╣рд┐рдП рдЬрд┐рд╕реЗ рдХреЗрд╡рд▓ **`B`** рдХрд░ рд╕рдХрддрд╛ рд╣реИ (рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдирд╣реАрдВ рдХрд░ рд╕рдХрддрд╛)ред
* рд╕реЗрд╡рд╛ **`A`** рдХреЛ рдПрдХ рд╕рдВрджреЗрд╢ рднреЗрдЬрдирд╛ рдЪрд╛рд╣рд┐рдП рдЬреЛ рдПрдХ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХреА рдЕрдкреЗрдХреНрд╖рд╛ рдХрд░рддрд╛ рд╣реИред
* рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ **`B`** рдХреЛ рдПрдХ рд╕рдВрджреЗрд╢ рднреЗрдЬ рд╕рдХрддрд╛ рд╣реИ рдЬрд┐рд╕рдХрд╛ рд╡рд╣ рдЙрддреНрддрд░ рджреЗрдЧрд╛ред

рд╢реЛрд╖рдг рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдореЗрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЪрд░рдг рд╢рд╛рдорд┐рд▓ рд╣реИрдВ:

1. рд╕реЗрд╡рд╛ **`A`** рдХреЗ рдПрдХ рд╕рдВрджреЗрд╢ рдХрд╛ рдЗрдВрддрдЬрд╝рд╛рд░ рдХрд░реЗрдВ рдЬреЛ рдПрдХ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХреА рдЕрдкреЗрдХреНрд╖рд╛ рдХрд░рддрд╛ рд╣реИред
2. **`A`** рдХреЛ рд╕реАрдзреЗ рдЙрддреНрддрд░ рджреЗрдиреЗ рдХреЗ рдмрдЬрд╛рдп, рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдкреЛрд░реНрдЯ рдХреЛ рд╣рд╛рдИрдЬреИрдХ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рд╕реЗрд╡рд╛ **`B`** рдХреЛ рдПрдХ рд╕рдВрджреЗрд╢ рднреЗрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред
3. рдЗрд╕рдХреЗ рдмрд╛рдж, рдПрдХ рд╕рдВрджреЗрд╢ рдЬреЛ рдирд┐рд╖рд┐рджреНрдз рдХреНрд░рд┐рдпрд╛ рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рд╣реИ, рднреЗрдЬрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдпрд╣ рдЕрдкреЗрдХреНрд╖рд╛ рдХрд░рддреЗ рд╣реБрдП рдХрд┐ рдЗрд╕реЗ **`B`** рд╕реЗ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХреЗ рд╕рд╛рде рд╕рдорд╡рд░реНрддреА рд░реВрдк рд╕реЗ рд╕рдВрд╕рд╛рдзрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред

рдиреАрдЪреЗ рд╡рд░реНрдгрд┐рдд рд╣рдорд▓реЗ рдХреЗ рдкрд░рд┐рджреГрд╢реНрдп рдХрд╛ рдПрдХ рджреГрд╢реНрдп рдкреНрд░рддрд┐рдирд┐рдзрд┐рддреНрд╡ рд╣реИ:

!\[https://sector7.computest.nl/post/2023-10-xpc-audit-token-spoofing/variant2.png]\(../../../../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1).png)

<figure><img src="../../../../../../.gitbook/assets/image (33).png" alt="https://sector7.computest.nl/post/2023-10-xpc-audit-token-spoofing/variant2.png" width="563"><figcaption></figcaption></figure>

## Discovery Problems

* **Instances рдХреЛ рдЦреЛрдЬрдиреЗ рдореЗрдВ рдХрдард┐рдирд╛рдЗрдпрд╛рдБ**: `xpc_connection_get_audit_token` рдХреЗ рдЙрдкрдпреЛрдЧ рдХреЗ рдЙрджрд╛рд╣рд░рдгреЛрдВ рдХреЛ рдЦреЛрдЬрдиреЗ рдореЗрдВ рдЪреБрдиреМрддреА рдереА, рджреЛрдиреЛрдВ рд╕реНрдереИрддрд┐рдХ рдФрд░ рдЧрддрд┐рд╢реАрд▓ рд░реВрдк рд╕реЗред
* **рдкрджреНрдзрддрд┐**: Frida рдХрд╛ рдЙрдкрдпреЛрдЧ `xpc_connection_get_audit_token` рдлрд╝рдВрдХреНрд╢рди рдХреЛ рд╣реБрдХ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЧрдпрд╛, рдЬреЛ рдЗрд╡реЗрдВрдЯ рд╣реИрдВрдбрд▓рд░реЛрдВ рд╕реЗ рдЙрддреНрдкрдиреНрди рдирд╣реАрдВ рд╣реЛрдиреЗ рд╡рд╛рд▓реЗ рдХреЙрд▓ рдХреЛ рдлрд╝рд┐рд▓реНрдЯрд░ рдХрд░рддрд╛ рд╣реИред рд╣рд╛рд▓рд╛рдБрдХрд┐, рдпрд╣ рд╡рд┐рдзрд┐ рд╣реБрдХ рдХреА рдЧрдИ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рддрдХ рд╕реАрдорд┐рдд рдереА рдФрд░ рд╕рдХреНрд░рд┐рдп рдЙрдкрдпреЛрдЧ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдереАред
* **рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдЙрдкрдХрд░рдг**: IDA/Ghidra рдЬреИрд╕реЗ рдЙрдкрдХрд░рдгреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдкрд╣реБрдВрдЪ рдпреЛрдЧреНрдп mach рд╕реЗрд╡рд╛рдУрдВ рдХреА рдЬрд╛рдВрдЪ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЧрдпрд╛, рд▓реЗрдХрд┐рди рдпрд╣ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рд╕рдордп рд▓реЗрдиреЗ рд╡рд╛рд▓реА рдереА, рдЬреЛ dyld рд╕рд╛рдЭрд╛ рдХреИрд╢ рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рдХреЙрд▓ рдХреЗ рдХрд╛рд░рдг рдЬрдЯрд┐рд▓ рдереАред
* **рд╕реНрдХреНрд░рд┐рдкреНрдЯрд┐рдВрдЧ рд╕реАрдорд╛рдПрдБ**: `dispatch_async` рдмреНрд▓реЙрдХреЛрдВ рд╕реЗ `xpc_connection_get_audit_token` рдХреЗ рд▓рд┐рдП рдХреЙрд▓ рдХреЗ рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХреЗ рд▓рд┐рдП рд╕реНрдХреНрд░рд┐рдкреНрдЯрд┐рдВрдЧ рдХрд░рдиреЗ рдХреЗ рдкреНрд░рдпрд╛рд╕реЛрдВ рдХреЛ рдмреНрд▓реЙрдХреЛрдВ рдХреЗ рдкрд╛рд░реНрд╕рд┐рдВрдЧ рдФрд░ dyld рд╕рд╛рдЭрд╛ рдХреИрд╢ рдХреЗ рд╕рд╛рде рдЗрдВрдЯрд░реИрдХреНрд╢рди рдореЗрдВ рдЬрдЯрд┐рд▓рддрд╛рдУрдВ рдХреЗ рдХрд╛рд░рдг рдмрд╛рдзрд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ред

## The fix <a href="#the-fix" id="the-fix"></a>

* **рд░рд┐рдкреЛрд░реНрдЯ рдХреА рдЧрдИ рд╕рдорд╕реНрдпрд╛рдПрдБ**: Apple рдХреЛ `smd` рдХреЗ рднреАрддрд░ рдкрд╛рдП рдЧрдП рд╕рд╛рдорд╛рдиреНрдп рдФрд░ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдореБрджреНрджреЛрдВ рдХрд╛ рд╡рд┐рд╡рд░рдг рджреЗрдиреЗ рд╡рд╛рд▓реА рдПрдХ рд░рд┐рдкреЛрд░реНрдЯ рдкреНрд░рд╕реНрддреБрдд рдХреА рдЧрдИред
* **Apple рдХреА рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛**: Apple рдиреЗ `smd` рдореЗрдВ рд╕рдорд╕реНрдпрд╛ рдХреЛ рд╕рдВрдмреЛрдзрд┐рдд рдХрд┐рдпрд╛, `xpc_connection_get_audit_token` рдХреЛ `xpc_dictionary_get_audit_token` рд╕реЗ рдкреНрд░рддрд┐рд╕реНрдерд╛рдкрд┐рдд рдХрд┐рдпрд╛ред
* **рдлрд┐рдХреНрд╕ рдХреА рдкреНрд░рдХреГрддрд┐**: `xpc_dictionary_get_audit_token` рдлрд╝рдВрдХреНрд╢рди рдХреЛ рд╕реБрд░рдХреНрд╖рд┐рдд рдорд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рдкреНрд░рд╛рдкреНрдд XPC рд╕рдВрджреЗрд╢ рд╕реЗ рдЬреБрдбрд╝реЗ mach рд╕рдВрджреЗрд╢ рд╕реЗ рд╕реАрдзреЗ рдСрдбрд┐рдЯ рдЯреЛрдХрди рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░рддрд╛ рд╣реИред рд╣рд╛рд▓рд╛рдБрдХрд┐, рдпрд╣ рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ API рдХрд╛ рд╣рд┐рд╕реНрд╕рд╛ рдирд╣реАрдВ рд╣реИ, рдЬреИрд╕реЗ `xpc_connection_get_audit_token`ред
* **рд╡реНрдпрд╛рдкрдХ рдлрд┐рдХреНрд╕ рдХреА рдЕрдиреБрдкрд╕реНрдерд┐рддрд┐**: рдпрд╣ рд╕реНрдкрд╖реНрдЯ рдирд╣реАрдВ рд╣реИ рдХрд┐ Apple рдиреЗ рдХрдиреЗрдХреНрд╢рди рдХреЗ рд╕рд╣реЗрдЬреЗ рдЧрдП рдСрдбрд┐рдЯ рдЯреЛрдХрди рдХреЗ рд╕рд╛рде рдореЗрд▓ рди рдЦрд╛рдиреЗ рд╡рд╛рд▓реЗ рд╕рдВрджреЗрд╢реЛрдВ рдХреЛ рдЕрд╕реНрд╡реАрдХрд╛рд░ рдХрд░рдиреЗ рдЬреИрд╕реЗ рдЕрдзрд┐рдХ рд╡реНрдпрд╛рдкрдХ рдлрд┐рдХреНрд╕ рдХреЛ рд▓рд╛рдЧреВ рдХреНрдпреЛрдВ рдирд╣реАрдВ рдХрд┐рдпрд╛ред рдХреБрдЫ рдкрд░рд┐рджреГрд╢реНрдпреЛрдВ (рдЬреИрд╕реЗ, `setuid` рдХрд╛ рдЙрдкрдпреЛрдЧ) рдореЗрдВ рд╡реИрдз рдСрдбрд┐рдЯ рдЯреЛрдХрди рдкрд░рд┐рд╡рд░реНрддрдиреЛрдВ рдХреА рд╕рдВрднрд╛рд╡рдирд╛ рдПрдХ рдХрд╛рд░рдХ рд╣реЛ рд╕рдХрддреА рд╣реИред
* **рд╡рд░реНрддрдорд╛рди рд╕реНрдерд┐рддрд┐**: рдпрд╣ рд╕рдорд╕реНрдпрд╛ iOS 17 рдФрд░ macOS 14 рдореЗрдВ рдмрдиреА рд╣реБрдИ рд╣реИ, рдЬреЛ рдЗрд╕реЗ рдкрд╣рдЪрд╛рдирдиреЗ рдФрд░ рд╕рдордЭрдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░рдиреЗ рд╡рд╛рд▓реЛрдВ рдХреЗ рд▓рд┐рдП рдПрдХ рдЪреБрдиреМрддреА рдкреНрд░рд╕реНрддреБрдд рдХрд░рддреА рд╣реИред

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
