# macOSå®‰å…¨ä¿æŠ¤

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWSçº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

- å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
- è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
- æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[NFT](https://opensea.io/collection/the-peass-family)æ”¶è—å“
- **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
- é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## Gatekeeper

Gatekeeperé€šå¸¸ç”¨äºæŒ‡ä»£**Quarantine + Gatekeeper + XProtect**çš„ç»„åˆï¼Œè¿™æ˜¯3ä¸ªmacOSå®‰å…¨æ¨¡å—ï¼Œæ—¨åœ¨**é˜»æ­¢ç”¨æˆ·æ‰§è¡Œæ½œåœ¨æ¶æ„è½¯ä»¶ä¸‹è½½**ã€‚

æ›´å¤šä¿¡æ¯ï¼š

{% content-ref url="macos-gatekeeper.md" %}
[macos-gatekeeper.md](macos-gatekeeper.md)
{% endcontent-ref %}

## è¿›ç¨‹é™åˆ¶

### SIP - ç³»ç»Ÿå®Œæ•´æ€§ä¿æŠ¤

{% content-ref url="macos-sip.md" %}
[macos-sip.md](macos-sip.md)
{% endcontent-ref %}

### æ²™ç›’

macOSæ²™ç›’**é™åˆ¶åœ¨æ²™ç›’å†…è¿è¡Œçš„åº”ç”¨ç¨‹åº**æ‰§è¡Œæ²™ç›’é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šçš„**å…è®¸æ“ä½œ**ã€‚è¿™æœ‰åŠ©äºç¡®ä¿**åº”ç”¨ç¨‹åºä»…è®¿é—®é¢„æœŸèµ„æº**ã€‚

{% content-ref url="macos-sandbox/" %}
[macos-sandbox](macos-sandbox/)
{% endcontent-ref %}

### TCC - **é€æ˜åº¦ã€åŒæ„å’Œæ§åˆ¶**

**TCCï¼ˆé€æ˜åº¦ã€åŒæ„å’Œæ§åˆ¶ï¼‰**æ˜¯ä¸€ä¸ªå®‰å…¨æ¡†æ¶ã€‚å®ƒæ—¨åœ¨**ç®¡ç†åº”ç”¨ç¨‹åºçš„æƒé™**ï¼Œç‰¹åˆ«æ˜¯é€šè¿‡è§„èŒƒå®ƒä»¬å¯¹æ•æ„ŸåŠŸèƒ½çš„è®¿é—®ã€‚è¿™åŒ…æ‹¬è¯¸å¦‚**ä½ç½®æœåŠ¡ã€è”ç³»äººã€ç…§ç‰‡ã€éº¦å…‹é£ã€æ‘„åƒå¤´ã€è¾…åŠ©åŠŸèƒ½å’Œå®Œå…¨ç£ç›˜è®¿é—®**ç­‰å…ƒç´ ã€‚TCCç¡®ä¿åº”ç”¨ç¨‹åºåªèƒ½åœ¨è·å¾—æ˜ç¡®ç”¨æˆ·åŒæ„åè®¿é—®è¿™äº›åŠŸèƒ½ï¼Œä»è€Œå¢å¼ºéšç§å’Œå¯¹ä¸ªäººæ•°æ®çš„æ§åˆ¶ã€‚

{% content-ref url="macos-tcc/" %}
[macos-tcc](macos-tcc/)
{% endcontent-ref %}

### å¯åŠ¨/ç¯å¢ƒçº¦æŸå’Œä¿¡ä»»ç¼“å­˜

macOSä¸­çš„å¯åŠ¨çº¦æŸæ˜¯ä¸€é¡¹å®‰å…¨åŠŸèƒ½ï¼Œé€šè¿‡å°†ç³»ç»ŸäºŒè¿›åˆ¶æ–‡ä»¶åˆ†ç±»åˆ°**ä¿¡ä»»ç¼“å­˜**ä¸­çš„çº¦æŸç±»åˆ«ï¼Œæ¥**è§„èŒƒè¿›ç¨‹å¯åŠ¨**ï¼Œå®šä¹‰**è°å¯ä»¥å¯åŠ¨**è¿›ç¨‹ï¼Œ**å¦‚ä½•å¯åŠ¨**ä»¥åŠ**ä»ä½•å¤„å¯åŠ¨**ã€‚åœ¨macOS Venturaä¸­å¼•å…¥ï¼Œæ¯ä¸ªå¯æ‰§è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶éƒ½æœ‰å…¶**å¯åŠ¨**è§„åˆ™ï¼ŒåŒ…æ‹¬**è‡ªèº«**ã€**çˆ¶çº§**å’Œ**è´Ÿè´£**çº¦æŸã€‚åœ¨macOS Sonomaä¸­æ‰©å±•åˆ°ç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åºä½œä¸º**ç¯å¢ƒ**çº¦æŸï¼Œè¿™äº›åŠŸèƒ½æœ‰åŠ©äºé€šè¿‡ç®¡ç†è¿›ç¨‹å¯åŠ¨æ¡ä»¶æ¥å‡è½»æ½œåœ¨çš„ç³»ç»Ÿåˆ©ç”¨ã€‚

{% content-ref url="macos-launch-environment-constraints.md" %}
[macos-launch-environment-constraints.md](macos-launch-environment-constraints.md)
{% endcontent-ref %}

## MRT - æ¶æ„è½¯ä»¶ç§»é™¤å·¥å…·

æ¶æ„è½¯ä»¶ç§»é™¤å·¥å…·ï¼ˆMRTï¼‰æ˜¯macOSå®‰å…¨åŸºç¡€è®¾æ–½çš„å¦ä¸€éƒ¨åˆ†ã€‚é¡¾åæ€ä¹‰ï¼ŒMRTçš„ä¸»è¦åŠŸèƒ½æ˜¯**ä»å—æ„ŸæŸ“ç³»ç»Ÿä¸­åˆ é™¤å·²çŸ¥çš„æ¶æ„è½¯ä»¶**ã€‚

ä¸€æ—¦åœ¨Macä¸Šæ£€æµ‹åˆ°æ¶æ„è½¯ä»¶ï¼ˆæ— è®ºæ˜¯é€šè¿‡XProtectè¿˜æ˜¯å…¶ä»–æ–¹å¼ï¼‰ï¼ŒMRTå¯ç”¨äºè‡ªåŠ¨**åˆ é™¤æ¶æ„è½¯ä»¶**ã€‚MRTåœ¨åå°é™é»˜è¿è¡Œï¼Œé€šå¸¸åœ¨ç³»ç»Ÿæ›´æ–°æ—¶è¿è¡Œï¼Œæˆ–è€…åœ¨ä¸‹è½½æ–°çš„æ¶æ„è½¯ä»¶å®šä¹‰æ—¶è¿è¡Œï¼ˆçœ‹èµ·æ¥MRTç”¨äºæ£€æµ‹æ¶æ„è½¯ä»¶çš„è§„åˆ™åœ¨äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼‰ã€‚

è™½ç„¶XProtectå’ŒMRTéƒ½æ˜¯macOSå®‰å…¨æªæ–½çš„ä¸€éƒ¨åˆ†ï¼Œä½†å®ƒä»¬æ‰§è¡Œä¸åŒçš„åŠŸèƒ½ï¼š

- **XProtect**æ˜¯ä¸€ç§é¢„é˜²å·¥å…·ã€‚å®ƒä¼šåœ¨æ–‡ä»¶ä¸‹è½½æ—¶ï¼ˆé€šè¿‡æŸäº›åº”ç”¨ç¨‹åºï¼‰**æ£€æŸ¥æ–‡ä»¶**ï¼Œå¦‚æœæ£€æµ‹åˆ°ä»»ä½•å·²çŸ¥ç±»å‹çš„æ¶æ„è½¯ä»¶ï¼Œå®ƒä¼š**é˜»æ­¢æ–‡ä»¶æ‰“å¼€**ï¼Œä»è€Œé˜²æ­¢æ¶æ„è½¯ä»¶é¦–æ¬¡æ„ŸæŸ“æ‚¨çš„ç³»ç»Ÿã€‚
- å¦ä¸€æ–¹é¢ï¼Œ**MRT**æ˜¯ä¸€ç§**å“åº”å¼å·¥å…·**ã€‚å®ƒåœ¨ç³»ç»Ÿä¸Šæ£€æµ‹åˆ°æ¶æ„è½¯ä»¶åè¿è¡Œï¼Œç›®çš„æ˜¯åˆ é™¤æœ‰é—®é¢˜çš„è½¯ä»¶ä»¥æ¸…ç†ç³»ç»Ÿã€‚

MRTåº”ç”¨ç¨‹åºä½äº**`/Library/Apple/System/Library/CoreServices/MRT.app`**

## åå°ä»»åŠ¡ç®¡ç†

**macOS**ç°åœ¨ä¼š**è­¦å‘Š**æ¯å½“å·¥å…·ä½¿ç”¨å·²çŸ¥çš„**æŒä¹…ä»£ç æ‰§è¡ŒæŠ€æœ¯**ï¼ˆå¦‚ç™»å½•é¡¹ã€å®ˆæŠ¤ç¨‹åºç­‰ï¼‰æ—¶ï¼Œå› æ­¤ç”¨æˆ·æ›´æ¸…æ¥š**å“ªäº›è½¯ä»¶æ˜¯æŒä¹…çš„**ã€‚

<figure><img src="../../../.gitbook/assets/image (711).png" alt=""><figcaption></figcaption></figure>

è¿™æ˜¯é€šè¿‡ä½äº`/System/Library/PrivateFrameworks/BackgroundTaskManagement.framework/Versions/A/Resources/backgroundtaskmanagementd`çš„**å®ˆæŠ¤ç¨‹åº**å’Œä½äº`/System/Library/PrivateFrameworks/BackgroundTaskManagement.framework/Support/BackgroundTaskManagementAgent.app`çš„**ä»£ç†**æ¥è¿è¡Œçš„ã€‚

**`backgroundtaskmanagementd`**çŸ¥é“æŸä¸ªä¸œè¥¿å®‰è£…åœ¨æŒä¹…æ–‡ä»¶å¤¹ä¸­çš„æ–¹å¼æ˜¯é€šè¿‡**è·å–FSEvents**å¹¶ä¸ºå…¶åˆ›å»ºä¸€äº›**å¤„ç†ç¨‹åº**ã€‚

æ­¤å¤–ï¼Œæœ‰ä¸€ä¸ªåŒ…å«ç”±è‹¹æœç»´æŠ¤çš„**å¸¸è§åº”ç”¨ç¨‹åº**çš„å±æ€§åˆ—è¡¨æ–‡ä»¶ï¼Œä½äºï¼š`/System/Library/PrivateFrameworks/BackgroundTaskManagement.framework/Versions/A/Resources/attributions.plist`
```json
[...]
"us.zoom.ZoomDaemon" => {
"AssociatedBundleIdentifiers" => [
0 => "us.zoom.xos"
]
"Attribution" => "Zoom"
"Program" => "/Library/PrivilegedHelperTools/us.zoom.ZoomDaemon"
"ProgramArguments" => [
0 => "/Library/PrivilegedHelperTools/us.zoom.ZoomDaemon"
]
"TeamIdentifier" => "BJ4HAAB9B3"
}
[...]
```
### æšä¸¾

å¯ä»¥ä½¿ç”¨Appleçš„cliå·¥å…·**æšä¸¾æ‰€æœ‰**é…ç½®çš„åå°é¡¹ç›®ï¼š
```bash
# The tool will always ask for the users password
sfltool dumpbtm
```
æ­¤å¤–ï¼Œæ‚¨è¿˜å¯ä»¥ä½¿ç”¨[**DumpBTM**](https://github.com/objective-see/DumpBTM)åˆ—å‡ºè¿™äº›ä¿¡æ¯ã€‚
```bash
# You need to grant the Terminal Full Disk Access for this to work
chmod +x dumpBTM
xattr -rc dumpBTM # Remove quarantine attr
./dumpBTM
```
è¿™äº›ä¿¡æ¯è¢«å­˜å‚¨åœ¨ **`/private/var/db/com.apple.backgroundtaskmanagement/BackgroundItems-v4.btm`** ä¸­ï¼Œç»ˆç«¯éœ€è¦ FDAã€‚

### æ“çºµ BTM

å½“å‘ç°æ–°çš„æŒä¹…æ€§æ—¶ï¼Œä¼šè§¦å‘ä¸€ä¸ªç±»å‹ä¸º **`ES_EVENT_TYPE_NOTIFY_BTM_LAUNCH_ITEM_ADD`** çš„äº‹ä»¶ã€‚å› æ­¤ï¼Œä»»ä½•ä¸€ç§**é˜»æ­¢**å‘é€æ­¤**äº‹ä»¶**æˆ–**ä»£ç†è­¦å‘Š**ç”¨æˆ·çš„æ–¹æ³•éƒ½å°†å¸®åŠ©æ”»å‡»è€…_**ç»•è¿‡**_ BTMã€‚

* **é‡ç½®æ•°æ®åº“**ï¼šè¿è¡Œä»¥ä¸‹å‘½ä»¤å°†é‡ç½®æ•°æ®åº“ï¼ˆåº”è¯¥ä»å¤´å¼€å§‹é‡å»ºï¼‰ï¼Œä½†æ˜¯å‡ºäºæŸç§åŸå› ï¼Œåœ¨è¿è¡Œæ­¤å‘½ä»¤åï¼Œ**ç›´åˆ°ç³»ç»Ÿé‡æ–°å¯åŠ¨ä¹‹å‰ï¼Œä¸ä¼šè­¦å‘Šä»»ä½•æ–°çš„æŒä¹…æ€§**ã€‚
* éœ€è¦**root**æƒé™ã€‚
```bash
# Reset the database
sfltool resettbtm
```
* **åœæ­¢ä»£ç†ç¨‹åº**ï¼šå¯ä»¥å‘ä»£ç†ç¨‹åºå‘é€åœæ­¢ä¿¡å·ï¼Œè¿™æ ·å½“å‘ç°æ–°çš„æ£€æµ‹æ—¶ï¼Œ**å°±ä¸ä¼šæé†’ç”¨æˆ·**ã€‚
```bash
# Get PID
pgrep BackgroundTaskManagementAgent
1011

# Stop it
kill -SIGSTOP 1011

# Check it's stopped (a T means it's stopped)
ps -o state 1011
T
```
* **æ¼æ´**: å¦‚æœ**åˆ›å»ºæŒä¹…æ€§çš„è¿›ç¨‹**åœ¨å…¶åç«‹å³å¿«é€Ÿå­˜åœ¨ï¼Œå®ˆæŠ¤ç¨‹åºå°†å°è¯•**è·å–æœ‰å…³å…¶ä¿¡æ¯**ï¼Œ**å¤±è´¥**ï¼Œå¹¶ä¸”**æ— æ³•å‘é€äº‹ä»¶**æŒ‡ç¤ºæœ‰æ–°çš„æŒä¹…æ€§äº‹ç‰©å­˜åœ¨ã€‚

æœ‰å…³BTMçš„**æ›´å¤šä¿¡æ¯**å’Œ**å‚è€ƒèµ„æ–™**ï¼š

* [https://youtu.be/9hjUmT031tc?t=26481](https://youtu.be/9hjUmT031tc?t=26481)
* [https://www.patreon.com/posts/new-developer-77420730?l=fr](https://www.patreon.com/posts/new-developer-77420730?l=fr)
* [https://support.apple.com/en-gb/guide/deployment/depdca572563/web](https://support.apple.com/en-gb/guide/deployment/depdca572563/web)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ–åœ¨**Twitter**ä¸Šå…³æ³¨æˆ‘ ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
