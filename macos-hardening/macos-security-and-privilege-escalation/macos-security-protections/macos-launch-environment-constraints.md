# macOS Launch/Environment Constraints & Trust Cache

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

macOS рдореЗрдВ рд▓реЙрдиреНрдЪ рдкреНрд░рддрд┐рдмрдВрдз рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ рдмрдврд╝рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдкреЗрд╢ рдХрд┐рдП рдЧрдП рдереЗ **рдпрд╣ рд╡рд┐рдирд┐рдпрдорд┐рдд рдХрд░рдХреЗ рдХрд┐ рдПрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреИрд╕реЗ, рдХреМрди рдФрд░ рдХрд╣рд╛рдБ рд╕реЗ рд╢реБрд░реВ рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИ**ред macOS рд╡реЗрдВрдЪреБрд░рд╛ рдореЗрдВ рд╢реБрд░реВ рдХрд┐рдП рдЧрдП, рдпреЗ рдПрдХ рдврд╛рдВрдЪрд╛ рдкреНрд░рджрд╛рди рдХрд░рддреЗ рд╣реИрдВ рдЬреЛ **рдкреНрд░рддреНрдпреЗрдХ рд╕рд┐рд╕реНрдЯрдо рдмрд╛рдЗрдирд░реА рдХреЛ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдкреНрд░рддрд┐рдмрдВрдз рд╢реНрд░реЗрдгрд┐рдпреЛрдВ рдореЗрдВ рд╡рд░реНрдЧреАрдХреГрдд рдХрд░рддрд╛ рд╣реИ**, рдЬреЛ **рдЯреНрд░рд╕реНрдЯ рдХреИрд╢** рдХреЗ рднреАрддрд░ рдкрд░рд┐рднрд╛рд╖рд┐рдд рд╣реИрдВ, рдЬреЛ рд╕рд┐рд╕реНрдЯрдо рдмрд╛рдЗрдирд░реА рдФрд░ рдЙрдирдХреЗ рд╕рдВрдмрдВрдзрд┐рдд рд╣реИрд╢ рдХрд╛ рдПрдХ рд╕реВрдЪреА рд╣реИред рдпреЗ рдкреНрд░рддрд┐рдмрдВрдз рд╕рд┐рд╕реНрдЯрдо рдХреЗ рднреАрддрд░ рд╣рд░ рдирд┐рд╖реНрдкрд╛рджрди рдпреЛрдЧреНрдп рдмрд╛рдЗрдирд░реА рдкрд░ рд▓рд╛рдЧреВ рд╣реЛрддреЗ рд╣реИрдВ, рдЬрд┐рд╕рдореЗрдВ **рд╡рд┐рд╢рд┐рд╖реНрдЯ рдмрд╛рдЗрдирд░реА рдХреЛ рд▓реЙрдиреНрдЪ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХрддрд╛рдУрдВ** рдХреЛ рд░реЗрдЦрд╛рдВрдХрд┐рдд рдХрд░рдиреЗ рд╡рд╛рд▓реЗ **рдирд┐рдпрдореЛрдВ** рдХрд╛ рдПрдХ рд╕реЗрдЯ рд╢рд╛рдорд┐рд▓ рд╣реЛрддрд╛ рд╣реИред рдирд┐рдпрдореЛрдВ рдореЗрдВ рд╕реНрд╡рдпрдВ рдкреНрд░рддрд┐рдмрдВрдз рд╢рд╛рдорд┐рд▓ рд╣реЛрддреЗ рд╣реИрдВ рдЬрд┐рдиреНрд╣реЗрдВ рдПрдХ рдмрд╛рдЗрдирд░реА рдХреЛ рд╕рдВрддреБрд╖реНрдЯ рдХрд░рдирд╛ рд╣реЛрддрд╛ рд╣реИ, рдорд╛рддрд╛-рдкрд┐рддрд╛ рдХреЗ рдкреНрд░рддрд┐рдмрдВрдз рдЬреЛ рдЗрд╕рдХреЗ рдорд╛рддрд╛-рдкрд┐рддрд╛ рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рджреНрд╡рд╛рд░рд╛ рдкреВрд░рд╛ рдХрд┐рдП рдЬрд╛рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ, рдФрд░ рдЬрд┐рдореНрдореЗрджрд╛рд░ рдкреНрд░рддрд┐рдмрдВрдз рдЬреЛ рдЕрдиреНрдп рд╕рдВрдмрдВрдзрд┐рдд рд╕рдВрд╕реНрдерд╛рдУрдВ рджреНрд╡рд╛рд░рд╛ рдкрд╛рд▓рди рдХрд┐рдП рдЬрд╛рдиреЗ рдЪрд╛рд╣рд┐рдПред

рдпрд╣ рддрдВрддреНрд░ рддреАрд╕рд░реЗ рдкрдХреНрд╖ рдХреЗ рдРрдкреНрд╕ рдкрд░ **рдкрд░реНрдпрд╛рд╡рд░рдг рдкреНрд░рддрд┐рдмрдВрдзреЛрдВ** рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╡рд┐рд╕реНрддрд╛рд░рд┐рдд рд╣реЛрддрд╛ рд╣реИ, рдЬреЛ macOS рд╕реЛрдиреЛрдорд╛ рд╕реЗ рд╢реБрд░реВ рд╣реЛрддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдбреЗрд╡рд▓рдкрд░реНрд╕ рдХреЛ рдЕрдкрдиреЗ рдРрдкреНрд╕ рдХреА рд╕реБрд░рдХреНрд╖рд╛ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдорд┐рд▓рддреА рд╣реИ, рдЬреЛ рдХрд┐ **рдкрд░реНрдпрд╛рд╡рд░рдг рдкреНрд░рддрд┐рдмрдВрдзреЛрдВ рдХреЗ рд▓рд┐рдП рдХреБрдВрдЬреА рдФрд░ рдорд╛рдиреЛрдВ рдХрд╛ рдПрдХ рд╕реЗрдЯ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рддреЗ рд╣реИрдВред**

рдЖрдк **рд▓реЙрдиреНрдЪ рд╡рд╛рддрд╛рд╡рд░рдг рдФрд░ рдкреБрд╕реНрддрдХрд╛рд▓рдп рдкреНрд░рддрд┐рдмрдВрдзреЛрдВ** рдХреЛ рдкреНрд░рддрд┐рдмрдВрдз рд╢рдмреНрджрдХреЛрд╢реЛрдВ рдореЗрдВ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░рддреЗ рд╣реИрдВ рдЬрд┐рдиреНрд╣реЗрдВ рдЖрдк рдпрд╛ рддреЛ **`launchd` рдкреНрд░реЙрдкрд░реНрдЯреА рд▓рд┐рд╕реНрдЯ рдлрд╝рд╛рдЗрд▓реЛрдВ** рдореЗрдВ рд╕рд╣реЗрдЬрддреЗ рд╣реИрдВ, рдпрд╛ **рдЕрд▓рдЧ рдкреНрд░реЙрдкрд░реНрдЯреА рд▓рд┐рд╕реНрдЯ** рдлрд╝рд╛рдЗрд▓реЛрдВ рдореЗрдВ рдЬреЛ рдЖрдк рдХреЛрдб рд╕рд╛рдЗрдирд┐рдВрдЧ рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВред

рдкреНрд░рддрд┐рдмрдВрдзреЛрдВ рдХреЗ 4 рдкреНрд░рдХрд╛рд░ рд╣реИрдВ:

* **рд╕реНрд╡рдпрдВ рдкреНрд░рддрд┐рдмрдВрдз**: рд▓рд╛рдЧреВ рдкреНрд░рддрд┐рдмрдВрдз **рдЪрд▓ рд░рд╣реЗ** рдмрд╛рдЗрдирд░реА рдкрд░ред
* **рдорд╛рддрд╛-рдкрд┐рддрд╛ рдкреНрд░рдХреНрд░рд┐рдпрд╛**: рд▓рд╛рдЧреВ рдкреНрд░рддрд┐рдмрдВрдз **рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рдорд╛рддрд╛-рдкрд┐рддрд╛** рдкрд░ (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП **`launchd`** рдПрдХ XP рд╕реЗрд╡рд╛ рдЪрд▓рд╛ рд░рд╣рд╛ рд╣реИ)
* **рдЬрд┐рдореНрдореЗрджрд╛рд░ рдкреНрд░рддрд┐рдмрдВрдз**: рд▓рд╛рдЧреВ рдкреНрд░рддрд┐рдмрдВрдз **рд╕реЗрд╡рд╛ рдХреЛ рдХреЙрд▓ рдХрд░рдиреЗ рд╡рд╛рд▓реА рдкреНрд░рдХреНрд░рд┐рдпрд╛** рдкрд░ XPC рд╕рдВрдЪрд╛рд░ рдореЗрдВ
* **рдкреБрд╕реНрддрдХрд╛рд▓рдп рд▓реЛрдб рдкреНрд░рддрд┐рдмрдВрдз**: рдЪрдпрдирд╛рддреНрдордХ рд░реВрдк рд╕реЗ рдХреЛрдб рдХрд╛ рд╡рд░реНрдгрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреБрд╕реНрддрдХрд╛рд▓рдп рд▓реЛрдб рдкреНрд░рддрд┐рдмрдВрдзреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ рдЬрд┐рд╕реЗ рд▓реЛрдб рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ

рддреЛ рдЬрдм рдПрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рджреВрд╕рд░реА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рд▓реЙрдиреНрдЪ рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░рддреА рд╣реИ тАФ `execve(_:_:_:)` рдпрд╛ `posix_spawn(_:_:_:_:_:_:)` рдХреЛ рдХреЙрд▓ рдХрд░рдХреЗ тАФ рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо рдпрд╣ рдЬрд╛рдВрдЪрддрд╛ рд╣реИ рдХрд┐ **рдирд┐рд╖реНрдкрд╛рджрди рдпреЛрдЧреНрдп** рдлрд╝рд╛рдЗрд▓ **рдЕрдкрдиреА рд╕реНрд╡рдпрдВ рдХреА рдкреНрд░рддрд┐рдмрдВрдз** рдХреЛ **рд╕рдВрддреБрд╖реНрдЯ рдХрд░рддреА рд╣реИ**ред рдпрд╣ рдпрд╣ рднреА рдЬрд╛рдВрдЪрддрд╛ рд╣реИ рдХрд┐ **рдорд╛рддрд╛-рдкрд┐рддрд╛** **рдкреНрд░рдХреНрд░рд┐рдпрд╛** рдХрд╛ рдирд┐рд╖реНрдкрд╛рджрди рдпреЛрдЧреНрдп **рдирд┐рд╖реНрдкрд╛рджрди рдпреЛрдЧреНрдп рдХреЗ рдорд╛рддрд╛-рдкрд┐рддрд╛ рдХреЗ рдкреНрд░рддрд┐рдмрдВрдз** рдХреЛ **рд╕рдВрддреБрд╖реНрдЯ рдХрд░рддрд╛ рд╣реИ**, рдФрд░ рдХрд┐ **рдЬрд┐рдореНрдореЗрджрд╛рд░** **рдкреНрд░рдХреНрд░рд┐рдпрд╛** рдХрд╛ рдирд┐рд╖реНрдкрд╛рджрди рдпреЛрдЧреНрдп **рдирд┐рд╖реНрдкрд╛рджрди рдпреЛрдЧреНрдп рдХреЗ рдЬрд┐рдореНрдореЗрджрд╛рд░ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рдкреНрд░рддрд┐рдмрдВрдз** рдХреЛ **рд╕рдВрддреБрд╖реНрдЯ рдХрд░рддрд╛ рд╣реИ**ред рдпрджрд┐ рдЗрдирдореЗрдВ рд╕реЗ рдХреЛрдИ рднреА рд▓реЙрдиреНрдЪ рдкреНрд░рддрд┐рдмрдВрдз рд╕рдВрддреБрд╖реНрдЯ рдирд╣реАрдВ рд╣реЛрддреЗ рд╣реИрдВ, рддреЛ рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо рдкреНрд░реЛрдЧреНрд░рд╛рдо рдХреЛ рдирд╣реАрдВ рдЪрд▓рд╛рддрд╛ред

рдпрджрд┐ рдХрд┐рд╕реА рдкреБрд╕реНрддрдХрд╛рд▓рдп рдХреЛ рд▓реЛрдб рдХрд░рддреЗ рд╕рдордп **рдкреБрд╕реНрддрдХрд╛рд▓рдп рдкреНрд░рддрд┐рдмрдВрдз рдХрд╛ рдХреЛрдИ рднрд╛рдЧ рд╕рддреНрдп рдирд╣реАрдВ рд╣реИ**, рддреЛ рдЖрдкрдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ **рдкреБрд╕реНрддрдХрд╛рд▓рдп рдХреЛ рд▓реЛрдб рдирд╣реАрдВ рдХрд░рддреА**ред

## LC Categories

рдПрдХ LC **рддрдереНрдпреЛрдВ** рдФрд░ **рддрд╛рд░реНрдХрд┐рдХ рд╕рдВрдЪрд╛рд▓рди** (рдФрд░, рдпрд╛..) рд╕реЗ рдмрдирд╛ рд╣реЛрддрд╛ рд╣реИ рдЬреЛ рддрдереНрдпреЛрдВ рдХреЛ рдЬреЛрдбрд╝рддрд╛ рд╣реИред

[**рддрдереНрдп рдЬреЛ рдПрдХ LC рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рджрд╕реНрддрд╛рд╡реЗрдЬреАрдХреГрдд рд╣реИрдВ**](https://developer.apple.com/documentation/security/defining\_launch\_environment\_and\_library\_constraints)ред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП:

* is-init-proc: рдПрдХ рдмреВрд▓рд┐рдпрди рдорд╛рди рдЬреЛ рдпрд╣ рд╕рдВрдХреЗрдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдХреНрдпрд╛ рдирд┐рд╖реНрдкрд╛рджрди рдпреЛрдЧреНрдп рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо рдХреА рдкреНрд░рд╛рд░рдВрднрд┐рдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ (`launchd`) рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдПред
* is-sip-protected: рдПрдХ рдмреВрд▓рд┐рдпрди рдорд╛рди рдЬреЛ рдпрд╣ рд╕рдВрдХреЗрдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдХреНрдпрд╛ рдирд┐рд╖реНрдкрд╛рджрди рдпреЛрдЧреНрдп рдПрдХ рдлрд╝рд╛рдЗрд▓ рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдП рдЬреЛ рд╕рд┐рд╕реНрдЯрдо рдЗрдВрдЯреАрдЧреНрд░рд┐рдЯреА рдкреНрд░реЛрдЯреЗрдХреНрд╢рди (SIP) рджреНрд╡рд╛рд░рд╛ рд╕реБрд░рдХреНрд╖рд┐рдд рд╣реИред
* `on-authorized-authapfs-volume:` рдПрдХ рдмреВрд▓рд┐рдпрди рдорд╛рди рдЬреЛ рдпрд╣ рд╕рдВрдХреЗрдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдХреНрдпрд╛ рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо рдиреЗ рдирд┐рд╖реНрдкрд╛рджрди рдпреЛрдЧреНрдп рдХреЛ рдПрдХ рдЕрдзрд┐рдХреГрдд, рдкреНрд░рдорд╛рдгрд┐рдд APFS рд╡реЙрд▓реНрдпреВрдо рд╕реЗ рд▓реЛрдб рдХрд┐рдпрд╛ред
* `on-authorized-authapfs-volume`: рдПрдХ рдмреВрд▓рд┐рдпрди рдорд╛рди рдЬреЛ рдпрд╣ рд╕рдВрдХреЗрдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдХреНрдпрд╛ рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо рдиреЗ рдирд┐рд╖реНрдкрд╛рджрди рдпреЛрдЧреНрдп рдХреЛ рдПрдХ рдЕрдзрд┐рдХреГрдд, рдкреНрд░рдорд╛рдгрд┐рдд APFS рд╡реЙрд▓реНрдпреВрдо рд╕реЗ рд▓реЛрдб рдХрд┐рдпрд╛ред
* Cryptexes рд╡реЙрд▓реНрдпреВрдо
* `on-system-volume:` рдПрдХ рдмреВрд▓рд┐рдпрди рдорд╛рди рдЬреЛ рдпрд╣ рд╕рдВрдХреЗрдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдХреНрдпрд╛ рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо рдиреЗ рдирд┐рд╖реНрдкрд╛рджрди рдпреЛрдЧреНрдп рдХреЛ рд╡рд░реНрддрдорд╛рди рдореЗрдВ рдмреВрдЯ рдХрд┐рдП рдЧрдП рд╕рд┐рд╕реНрдЯрдо рд╡реЙрд▓реНрдпреВрдо рд╕реЗ рд▓реЛрдб рдХрд┐рдпрд╛ред
* /System рдХреЗ рдЕрдВрджрд░...
* ...

рдЬрдм рдПрдХ Apple рдмрд╛рдЗрдирд░реА рдкрд░ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдпрд╣ **рдЗрд╕реЗ рдПрдХ LC рд╢реНрд░реЗрдгреА** рдореЗрдВ **рдЯреНрд░рд╕реНрдЯ рдХреИрд╢** рдХреЗ рднреАрддрд░ рдЕрд╕рд╛рдЗрди рдХрд░рддрд╛ рд╣реИред

* **iOS 16 LC рд╢реНрд░реЗрдгрд┐рдпрд╛рдБ** [**рдпрд╣рд╛рдБ рдЙрд▓рдЯ рджреА рдЧрдИ рд╣реИрдВ рдФрд░ рджрд╕реНрддрд╛рд╡реЗрдЬреАрдХреГрдд рдХреА рдЧрдИ рд╣реИрдВ**](https://gist.github.com/LinusHenze/4cd5d7ef057a144cda7234e2c247c056)ред
* рд╡рд░реНрддрдорд╛рди **LC рд╢реНрд░реЗрдгрд┐рдпрд╛рдБ (macOS 14** - рд╕реЛрдиреЛрдорд╛) рдЙрд▓рдЯ рджреА рдЧрдИ рд╣реИрдВ рдФрд░ рдЙрдирдХреЗ [**рд╡рд┐рд╡рд░рдг рдпрд╣рд╛рдБ рдкрд╛рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ**](https://gist.github.com/theevilbit/a6fef1e0397425a334d064f7b6e1be53)ред

рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП рд╢реНрд░реЗрдгреА 1 рд╣реИ:
```
Category 1:
Self Constraint: (on-authorized-authapfs-volume || on-system-volume) && launch-type == 1 && validation-category == 1
Parent Constraint: is-init-proc
```
* `(on-authorized-authapfs-volume || on-system-volume)`: рд╕рд┐рд╕реНрдЯрдо рдпрд╛ рдХреНрд░рд┐рдкреНрдЯреЗрдХреНрд╕ рд╡реЙрд▓реНрдпреВрдо рдореЗрдВ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред
* `launch-type == 1`: рдПрдХ рд╕рд┐рд╕реНрдЯрдо рд╕реЗрд╡рд╛ рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдП (LaunchDaemons рдореЗрдВ plist)ред
* `validation-category == 1`: рдПрдХ рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо рдирд┐рд╖реНрдкрд╛рджрди рдпреЛрдЧреНрдпред
* `is-init-proc`: Launchd

### LC рд╢реНрд░реЗрдгрд┐рдпреЛрдВ рдХреЛ рдЙрд▓рдЯрдирд╛

рдЖрдкрдХреЗ рдкрд╛рд╕ рдЗрд╕рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА [**рдпрд╣рд╛рдВ**](https://theevilbit.github.io/posts/launch\_constraints\_deep\_dive/#reversing-constraints) рд╣реИ, рд▓реЗрдХрд┐рди рдореВрд▓ рд░реВрдк рд╕реЗ, рдЗрдиреНрд╣реЗрдВ **AMFI (AppleMobileFileIntegrity)** рдореЗрдВ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЖрдкрдХреЛ **KEXT** рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд░реНрдиреЗрд▓ рдбреЗрд╡рд▓рдкрдореЗрдВрдЯ рдХрд┐рдЯ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред **`kConstraintCategory`** рд╕реЗ рд╢реБрд░реВ рд╣реЛрдиреЗ рд╡рд╛рд▓реЗ рдкреНрд░рддреАрдХ **рджрд┐рд▓рдЪрд╕реНрдк** рд╣реЛрддреЗ рд╣реИрдВред рдЗрдиреНрд╣реЗрдВ рдирд┐рдХрд╛рд▓рдиреЗ рдкрд░ рдЖрдкрдХреЛ рдПрдХ DER (ASN.1) рдПрдиреНрдХреЛрдбреЗрдб рд╕реНрдЯреНрд░реАрдо рдорд┐рд▓реЗрдЧреА рдЬрд┐рд╕реЗ рдЖрдкрдХреЛ [ASN.1 Decoder](https://holtstrom.com/michael/tools/asn1decoder.php) рдпрд╛ python-asn1 рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдФрд░ рдЗрд╕рдХреЗ `dump.py` рд╕реНрдХреНрд░рд┐рдкреНрдЯ, [andrivet/python-asn1](https://github.com/andrivet/python-asn1/tree/master) рдХреЗ рд╕рд╛рде рдбрд┐рдХреЛрдб рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрдЧреА, рдЬреЛ рдЖрдкрдХреЛ рдПрдХ рдЕрдзрд┐рдХ рд╕рдордЭрдиреЗ рдпреЛрдЧреНрдп рд╕реНрдЯреНрд░рд┐рдВрдЧ рджреЗрдЧрд╛ред

## рдкрд░реНрдпрд╛рд╡рд░рдг рдкреНрд░рддрд┐рдмрдВрдз

рдпреЗ **рддреАрд╕рд░реЗ рдкрдХреНрд╖ рдХреЗ рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ** рдореЗрдВ рд╕реЗрдЯ рдХрд┐рдП рдЧрдП рд▓реЙрдиреНрдЪ рдкреНрд░рддрд┐рдмрдВрдз рд╣реИрдВред рдбреЗрд╡рд▓рдкрд░ рдЕрдкрдиреЗ рдЕрдиреБрдкреНрд░рдпреЛрдЧ рдореЗрдВ **рддрдереНрдпреЛрдВ** рдФрд░ **рддрд╛рд░реНрдХрд┐рдХ рдСрдкрд░реЗрдЯрд░реЛрдВ рдХрд╛ рдЪрдпрди рдХрд░ рд╕рдХрддрд╛ рд╣реИ** рддрд╛рдХрд┐ рд╕реНрд╡рдпрдВ рддрдХ рдкрд╣реБрдВрдЪ рдХреЛ рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред

рдПрдХ рдЕрдиреБрдкреНрд░рдпреЛрдЧ рдХреЗ рдкрд░реНрдпрд╛рд╡рд░рдг рдкреНрд░рддрд┐рдмрдВрдзреЛрдВ рдХреЛ рд╕реВрдЪреАрдмрджреНрдз рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ:
```bash
codesign -d -vvvv app.app
```
## Trust Caches

In **macOS** рдореЗрдВ рдХреБрдЫ рдЯреНрд░рд╕реНрдЯ рдХреИрд╢ рд╣реИрдВ:

* **`/System/Volumes/Preboot/*/boot/*/usr/standalone/firmware/FUD/BaseSystemTrustCache.img4`**
* **`/System/Volumes/Preboot/*/boot/*/usr/standalone/firmware/FUD/StaticTrustCache.img4`**
* **`/System/Library/Security/OSLaunchPolicyData`**

рдФрд░ iOS рдореЗрдВ рдпрд╣ **`/usr/standalone/firmware/FUD/StaticTrustCache.img4`** рдореЗрдВ рд╣реИред

{% hint style="warning" %}
macOS рдкрд░ Apple Silicon рдЙрдкрдХрд░рдгреЛрдВ рдкрд░, рдпрджрд┐ рдХреЛрдИ Apple рджреНрд╡рд╛рд░рд╛ рд╕рд╛рдЗрди рдХрд┐рдпрд╛ рдЧрдпрд╛ рдмрд╛рдЗрдирд░реА рдЯреНрд░рд╕реНрдЯ рдХреИрд╢ рдореЗрдВ рдирд╣реАрдВ рд╣реИ, рддреЛ AMFI рдЗрд╕реЗ рд▓реЛрдб рдХрд░рдиреЗ рд╕реЗ рдЗрдирдХрд╛рд░ рдХрд░ рджреЗрдЧрд╛ред
{% endhint %}

### Enumerating Trust Caches

рдкрд┐рдЫрд▓реЗ рдЯреНрд░рд╕реНрдЯ рдХреИрд╢ рдлрд╝рд╛рдЗрд▓реЗрдВ **IMG4** рдФрд░ **IM4P** рдкреНрд░рд╛рд░реВрдк рдореЗрдВ рд╣реИрдВ, IM4P IMG4 рдкреНрд░рд╛рд░реВрдк рдХрд╛ рдкреЗрд▓реЛрдб рд╕реЗрдХреНрд╢рди рд╣реИред

рдЖрдк рдбреЗрдЯрд╛рдмреЗрд╕ рдХреЗ рдкреЗрд▓реЛрдб рдХреЛ рдирд┐рдХрд╛рд▓рдиреЗ рдХреЗ рд▓рд┐рдП [**pyimg4**](https://github.com/m1stadev/PyIMG4) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

{% code overflow="wrap" %}
```bash
# Installation
python3 -m pip install pyimg4

# Extract payloads data
cp /System/Volumes/Preboot/*/boot/*/usr/standalone/firmware/FUD/BaseSystemTrustCache.img4 /tmp
pyimg4 img4 extract -i /tmp/BaseSystemTrustCache.img4 -p /tmp/BaseSystemTrustCache.im4p
pyimg4 im4p extract -i /tmp/BaseSystemTrustCache.im4p -o /tmp/BaseSystemTrustCache.data

cp /System/Volumes/Preboot/*/boot/*/usr/standalone/firmware/FUD/StaticTrustCache.img4 /tmp
pyimg4 img4 extract -i /tmp/StaticTrustCache.img4 -p /tmp/StaticTrustCache.im4p
pyimg4 im4p extract -i /tmp/StaticTrustCache.im4p -o /tmp/StaticTrustCache.data

pyimg4 im4p extract -i /System/Library/Security/OSLaunchPolicyData -o /tmp/OSLaunchPolicyData.data
```
{% endcode %}

(рдПрдХ рдФрд░ рд╡рд┐рдХрд▓реНрдк [**img4tool**](https://github.com/tihmstar/img4tool) рдЯреВрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ, рдЬреЛ M1 рдкрд░ рднреА рдЪрд▓реЗрдЧрд╛, рднрд▓реЗ рд╣реА рд░рд┐рд▓реАрдЬрд╝ рдкреБрд░рд╛рдиреА рд╣реЛ рдФрд░ x86\_64 рдХреЗ рд▓рд┐рдП рдпрджрд┐ рдЖрдк рдЗрд╕реЗ рд╕рд╣реА рд╕реНрдерд╛рдиреЛрдВ рдкрд░ рд╕реНрдерд╛рдкрд┐рдд рдХрд░рддреЗ рд╣реИрдВ)ред

рдЕрдм рдЖрдк рдЯреВрд▓ [**trustcache**](https://github.com/CRKatri/trustcache) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЬрд╛рдирдХрд╛рд░реА рдХреЛ рдкрдврд╝рдиреЗ рдпреЛрдЧреНрдп рдкреНрд░рд╛рд░реВрдк рдореЗрдВ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
# Install
wget https://github.com/CRKatri/trustcache/releases/download/v2.0/trustcache_macos_arm64
sudo mv ./trustcache_macos_arm64 /usr/local/bin/trustcache
xattr -rc /usr/local/bin/trustcache
chmod +x /usr/local/bin/trustcache

# Run
trustcache info /tmp/OSLaunchPolicyData.data | head
trustcache info /tmp/StaticTrustCache.data | head
trustcache info /tmp/BaseSystemTrustCache.data | head

version = 2
uuid = 35EB5284-FD1E-4A5A-9EFB-4F79402BA6C0
entry count = 969
0065fc3204c9f0765049b82022e4aa5b44f3a9c8 [none] [2] [1]
00aab02b28f99a5da9b267910177c09a9bf488a2 [none] [2] [1]
0186a480beeee93050c6c4699520706729b63eff [none] [2] [2]
0191be4c08426793ff3658ee59138e70441fc98a [none] [2] [3]
01b57a71112235fc6241194058cea5c2c7be3eb1 [none] [2] [2]
01e6934cb8833314ea29640c3f633d740fc187f2 [none] [2] [2]
020bf8c388deaef2740d98223f3d2238b08bab56 [none] [2] [3]
```
рд╡рд┐рд╢реНрд╡рд╛рд╕ рдХреИрд╢ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕рдВрд░рдЪрдирд╛ рдХрд╛ рдкрд╛рд▓рди рдХрд░рддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП **LC рд╢реНрд░реЗрдгреА рдЪреМрдерд╛ рдХреЙрд▓рдо рд╣реИ**
```c
struct trust_cache_entry2 {
uint8_t cdhash[CS_CDHASH_LEN];
uint8_t hash_type;
uint8_t flags;
uint8_t constraintCategory;
uint8_t reserved0;
} __attribute__((__packed__));
```
Then, you could use a script such as [**this one**](https://gist.github.com/xpn/66dc3597acd48a4c31f5f77c3cc62f30) to extract data.

From that data you can check the Apps with a **launch constraints value of `0`**, which are the ones that aren't constrained ([**check here**](https://gist.github.com/LinusHenze/4cd5d7ef057a144cda7234e2c247c056) for what each value is).

## Attack Mitigations

Launch Constrains рдХрдИ рдкреБрд░рд╛рдиреЗ рд╣рдорд▓реЛрдВ рдХреЛ **рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рдХреЗ рдХрдо рдХрд░ рджреЗрддреЗ рд╣реИрдВ рдХрд┐ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЕрдкреНрд░рддреНрдпрд╛рд╢рд┐рдд рдкрд░рд┐рд╕реНрдерд┐рддрд┐рдпреЛрдВ рдореЗрдВ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдирд╣реАрдВ рд╣реЛрдЧреА:** рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП рдЕрдкреНрд░рддреНрдпрд╛рд╢рд┐рдд рд╕реНрдерд╛рдиреЛрдВ рд╕реЗ рдпрд╛ рдЕрдкреНрд░рддреНрдпрд╛рд╢рд┐рдд рдорд╛рддрд╛-рдкрд┐рддрд╛ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рджреНрд╡рд╛рд░рд╛ рд╕рдХреНрд░рд┐рдп рд╣реЛрдиреЗ рдкрд░ (рдпрджрд┐ рдХреЗрд╡рд▓ launchd рдЗрд╕реЗ рд▓реЙрдиреНрдЪ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП)

рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, Launch Constraints рднреА **рдбрд╛рдЙрдирдЧреНрд░реЗрдб рд╣рдорд▓реЛрдВ рдХреЛ рдХрдо рдХрд░рддрд╛ рд╣реИред**

рд╣рд╛рд▓рд╛рдВрдХрд┐, рд╡реЗ **рд╕рд╛рдорд╛рдиреНрдп XPC** рджреБрд░реБрдкрдпреЛрдЧ, **Electron** рдХреЛрдб рдЗрдВрдЬреЗрдХреНрд╢рди рдпрд╛ **dylib рдЗрдВрдЬреЗрдХреНрд╢рди** рдХреЛ рдмрд┐рдирд╛ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рд╕рддреНрдпрд╛рдкрди рдХреЗ рдХрдо рдирд╣реАрдВ рдХрд░рддреЗ (рдЬрдм рддрдХ рдХрд┐ рдЙрди рдЯреАрдо рдЖрдИрдбреА рдХреЛ рдирд╣реАрдВ рдЬрд╛рдирд╛ рдЬрд╛рддрд╛ рдЬреЛ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рд▓реЛрдб рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ)ред

### XPC Daemon Protection

Sonoma рд░рд┐рд▓реАрдЬрд╝ рдореЗрдВ, рдПрдХ рдорд╣рддреНрд╡рдкреВрд░реНрдг рдмрд┐рдВрджреБ рд╣реИ рдбреЗрдорди XPC рд╕реЗрд╡рд╛ рдХреА **рдЬрд┐рдореНрдореЗрджрд╛рд░реА рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди**ред XPC рд╕реЗрд╡рд╛ рдЕрдкрдиреА рдЬрд┐рдореНрдореЗрджрд╛рд░реА рдХреЗ рд▓рд┐рдП рдЙрддреНрддрд░рджрд╛рдпреА рд╣реИ, рдЬрдмрдХрд┐ рдХрдиреЗрдХреНрдЯрд┐рдВрдЧ рдХреНрд▓рд╛рдЗрдВрдЯ рдЬрд┐рдореНрдореЗрджрд╛рд░ рдирд╣реАрдВ рд╣реИред рдпрд╣ рдлреАрдбрдмреИрдХ рд░рд┐рдкреЛрд░реНрдЯ FB13206884 рдореЗрдВ рджрд╕реНрддрд╛рд╡реЗрдЬрд┐рдд рд╣реИред рдпрд╣ рд╕реЗрдЯрдЕрдк рджреЛрд╖рдкреВрд░реНрдг рд▓рдЧ рд╕рдХрддрд╛ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ XPC рд╕реЗрд╡рд╛ рдХреЗ рд╕рд╛рде рдХреБрдЫ рдЗрдВрдЯрд░реИрдХреНрд╢рди рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ:

- **XPC рд╕реЗрд╡рд╛ рд▓реЙрдиреНрдЪ рдХрд░рдирд╛**: рдпрджрд┐ рдЗрд╕реЗ рдПрдХ рдмрдЧ рдорд╛рдирд╛ рдЬрд╛рдП, рддреЛ рдпрд╣ рд╕реЗрдЯрдЕрдк рд╣рдорд▓рд╛рд╡рд░ рдХреЛрдб рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ XPC рд╕реЗрд╡рд╛ рдХреЛ рдкреНрд░рд╛рд░рдВрдн рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ рджреЗрддрд╛ред
- **рд╕рдХреНрд░рд┐рдп рд╕реЗрд╡рд╛ рд╕реЗ рдХрдиреЗрдХреНрдЯ рдХрд░рдирд╛**: рдпрджрд┐ XPC рд╕реЗрд╡рд╛ рдкрд╣рд▓реЗ рд╕реЗ рдЪрд▓ рд░рд╣реА рд╣реИ (рд╕рдВрднрд╡рддрдГ рдЗрд╕рдХреЗ рдореВрд▓ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рджреНрд╡рд╛рд░рд╛ рд╕рдХреНрд░рд┐рдп), рддреЛ рдЗрд╕рд╕реЗ рдХрдиреЗрдХреНрдЯ рдХрд░рдиреЗ рдореЗрдВ рдХреЛрдИ рдмрд╛рдзрд╛ рдирд╣реАрдВ рд╣реИред

XPC рд╕реЗрд╡рд╛ рдкрд░ рдкреНрд░рддрд┐рдмрдВрдз рд▓рд╛рдЧреВ рдХрд░рдирд╛ **рд╕рдВрднрд╛рд╡рд┐рдд рд╣рдорд▓реЛрдВ рдХреЗ рд▓рд┐рдП рдЦрд┐рдбрд╝рдХреА рдХреЛ рд╕рдВрдХреАрд░реНрдг рдХрд░рдХреЗ** рдлрд╛рдпрджреЗрдордВрдж рд╣реЛ рд╕рдХрддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдпрд╣ рдкреНрд░рд╛рдердорд┐рдХ рдЪрд┐рдВрддрд╛ рдХреЛ рд╕рдВрдмреЛрдзрд┐рдд рдирд╣реАрдВ рдХрд░рддрд╛ред XPC рд╕реЗрд╡рд╛ рдХреА рд╕реБрд░рдХреНрд╖рд╛ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдореВрд▓ рд░реВрдк рд╕реЗ **рдХрдиреЗрдХреНрдЯрд┐рдВрдЧ рдХреНрд▓рд╛рдЗрдВрдЯ рдХреЛ рдкреНрд░рднрд╛рд╡реА рдврдВрдЧ рд╕реЗ рдорд╛рдиреНрдп рдХрд░рдирд╛** рдЖрд╡рд╢реНрдпрдХ рд╣реИред рдпрд╣ рд╕реЗрд╡рд╛ рдХреА рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ рдордЬрдмреВрдд рдХрд░рдиреЗ рдХрд╛ рдПрдХрдорд╛рддреНрд░ рддрд░реАрдХрд╛ рдмрдирд╛ рд╣реБрдЖ рд╣реИред рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдпрд╣ рдзреНрдпрд╛рди рджреЗрдиреЗ рдпреЛрдЧреНрдп рд╣реИ рдХрд┐ рдЙрд▓реНрд▓реЗрдЦрд┐рдд рдЬрд┐рдореНрдореЗрджрд╛рд░реА рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рд╡рд░реНрддрдорд╛рди рдореЗрдВ рдХрд╛рд░реНрдпрд╛рддреНрдордХ рд╣реИ, рдЬреЛ рдХрд┐ рдЗрдЪреНрдЫрд┐рдд рдбрд┐рдЬрд╝рд╛рдЗрди рдХреЗ рд╕рд╛рде рдореЗрд▓ рдирд╣реАрдВ рдЦрд╛ рд╕рдХрддрд╛ рд╣реИред

### Electron Protection

рдпрд╣ рдЖрд╡рд╢реНрдпрдХ рд╣реИ рдХрд┐ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЛ **LaunchService рджреНрд╡рд╛рд░рд╛ рдЦреЛрд▓рд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП** (рдорд╛рддрд╛-рдкрд┐рддрд╛ рдХреЗ рдкреНрд░рддрд┐рдмрдВрдзреЛрдВ рдореЗрдВ)ред рдЗрд╕реЗ **`open`** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ (рдЬреЛ env рд╡реЗрд░рд┐рдПрдмрд▓ рд╕реЗрдЯ рдХрд░ рд╕рдХрддрд╛ рд╣реИ) рдпрд╛ **Launch Services API** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ (рдЬрд╣рд╛рдВ env рд╡реЗрд░рд┐рдПрдмрд▓ рдХреЛ рдЗрдВрдЧрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ) рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

## References

* [https://youtu.be/f1HA5QhLQ7Y?t=24146](https://youtu.be/f1HA5QhLQ7Y?t=24146)
* [https://theevilbit.github.io/posts/launch\_constraints\_deep\_dive/](https://theevilbit.github.io/posts/launch\_constraints\_deep\_dive/)
* [https://eclecticlight.co/2023/06/13/why-wont-a-system-app-or-command-tool-run-launch-constraints-and-trust-caches/](https://eclecticlight.co/2023/06/13/why-wont-a-system-app-or-command-tool-run-launch-constraints-and-trust-caches/)
* [https://developer.apple.com/videos/play/wwdc2023/10266/](https://developer.apple.com/videos/play/wwdc2023/10266/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
