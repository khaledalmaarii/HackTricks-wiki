# macOS SIP

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}


## **–û—Å–Ω–æ–≤–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è**

**–ó–∞—Ö–∏—Å—Ç —Ü—ñ–ª—ñ—Å–Ω–æ—Å—Ç—ñ —Å–∏—Å—Ç–µ–º–∏ (SIP)** –≤ macOS —î –º–µ—Ö–∞–Ω—ñ–∑–º–æ–º, –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–∏–º –¥–ª—è –∑–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è –Ω–∞–≤—ñ—Ç—å –Ω–∞–π–±—ñ–ª—å—à –ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω–∏–º –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º –≤–Ω–æ—Å–∏—Ç–∏ –Ω–µ—Å–∞–Ω–∫—Ü—ñ–æ–Ω–æ–≤–∞–Ω—ñ –∑–º—ñ–Ω–∏ –¥–æ –∫–ª—é—á–æ–≤–∏—Ö —Å–∏—Å—Ç–µ–º–Ω–∏—Ö –ø–∞–ø–æ–∫. –¶—è —Ñ—É–Ω–∫—Ü—ñ—è –≤—ñ–¥—ñ–≥—Ä–∞—î –≤–∞–∂–ª–∏–≤—É —Ä–æ–ª—å —É –ø—ñ–¥—Ç—Ä–∏–º—Ü—ñ —Ü—ñ–ª—ñ—Å–Ω–æ—Å—Ç—ñ —Å–∏—Å—Ç–µ–º–∏, –æ–±–º–µ–∂—É—é—á–∏ –¥—ñ—ó, —Ç–∞–∫—ñ —è–∫ –¥–æ–¥–∞–≤–∞–Ω–Ω—è, –º–æ–¥–∏—Ñ—ñ–∫–∞—Ü—ñ—è –∞–±–æ –≤–∏–¥–∞–ª–µ–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤ —É –∑–∞—Ö–∏—â–µ–Ω–∏—Ö –∑–æ–Ω–∞—Ö. –û—Å–Ω–æ–≤–Ω—ñ –ø–∞–ø–∫–∏, –∑–∞—Ö–∏—â–µ–Ω—ñ SIP, –≤–∫–ª—é—á–∞—é—Ç—å:

* **/System**
* **/bin**
* **/sbin**
* **/usr**

–ü—Ä–∞–≤–∏–ª–∞, —è–∫—ñ —Ä–µ–≥—É–ª—é—é—Ç—å –ø–æ–≤–µ–¥—ñ–Ω–∫—É SIP, –≤–∏–∑–Ω–∞—á–µ–Ω—ñ –≤ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω–æ–º—É —Ñ–∞–π–ª—ñ, —Ä–æ–∑—Ç–∞—à–æ–≤–∞–Ω–æ–º—É –∑–∞ –∞–¥—Ä–µ—Å–æ—é **`/System/Library/Sandbox/rootless.conf`**. –£ —Ü—å–æ–º—É —Ñ–∞–π–ª—ñ —à–ª—è—Ö–∏, —è–∫—ñ –ø–æ—á–∏–Ω–∞—é—Ç—å—Å—è –∑ –∑—ñ—Ä–æ—á–∫–∏ (\*), –ø–æ–∑–Ω–∞—á–∞—é—Ç—å—Å—è —è–∫ –≤–∏–Ω—è—Ç–∫–∏ –∑ —ñ–Ω–∞–∫—à–µ —Å—É–≤–æ—Ä–∏—Ö –æ–±–º–µ–∂–µ–Ω—å SIP.

–†–æ–∑–≥–ª—è–Ω—å—Ç–µ –Ω–∞–≤–µ–¥–µ–Ω—É –Ω–∏–∂—á–µ —ñ–ª—é—Å—Ç—Ä–∞—Ü—ñ—é:
```javascript
/usr
* /usr/libexec/cups
* /usr/local
* /usr/share/man
```
–¶–µ–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç –≤–∫–∞–∑—É—î –Ω–∞ —Ç–µ, —â–æ —Ö–æ—á–∞ SIP –∑–∞–∑–≤–∏—á–∞–π –∑–∞—Ö–∏—â–∞—î **`/usr`** –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é, —î —Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω—ñ –ø—ñ–¥–∫–∞—Ç–∞–ª–æ–≥–∏ (`/usr/libexec/cups`, `/usr/local`, —ñ `/usr/share/man`), –¥–µ –∑–º—ñ–Ω–∏ –¥–æ–∑–≤–æ–ª–µ–Ω—ñ, —è–∫ –≤–∫–∞–∑–∞–Ω–æ –∑—ñ—Ä–æ—á–∫–æ—é (\*) –ø–µ—Ä–µ–¥ —ó—Ö–Ω—ñ–º–∏ —à–ª—è—Ö–∞–º–∏.

–©–æ–± –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏, —á–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—è –∞–±–æ —Ñ–∞–π–ª –∑–∞—Ö–∏—â–µ–Ω—ñ SIP, –≤–∏ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –∫–æ–º–∞–Ω–¥—É **`ls -lOd`** –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ –ø—Ä–∞–ø–æ—Ä—Ü—è **`restricted`** –∞–±–æ **`sunlnk`**. –ù–∞–ø—Ä–∏–∫–ª–∞–¥:
```bash
ls -lOd /usr/libexec/cups
drwxr-xr-x  11 root  wheel  sunlnk 352 May 13 00:29 /usr/libexec/cups
```
–£ —Ü—å–æ–º—É –≤–∏–ø–∞–¥–∫—É –ø—Ä–∞–ø–æ—Ä–µ—Ü—å **`sunlnk`** –æ–∑–Ω–∞—á–∞—î, —â–æ –∫–∞—Ç–∞–ª–æ–≥ `/usr/libexec/cups` —Å–∞–º –ø–æ —Å–æ–±—ñ **–Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –≤–∏–¥–∞–ª–µ–Ω–∏–π**, —Ö–æ—á–∞ —Ñ–∞–π–ª–∏ –≤ –Ω—å–æ–º—É –º–æ–∂—É—Ç—å –±—É—Ç–∏ —Å—Ç–≤–æ—Ä–µ–Ω—ñ, –∑–º—ñ–Ω–µ–Ω—ñ –∞–±–æ –≤–∏–¥–∞–ª–µ–Ω—ñ.

–ó —ñ–Ω—à–æ–≥–æ –±–æ–∫—É:
```bash
ls -lOd /usr/libexec
drwxr-xr-x  338 root  wheel  restricted 10816 May 13 00:29 /usr/libexec
```
–¢—É—Ç **`restricted`** –ø—Ä–∞–ø–æ—Ä–µ—Ü—å –≤–∫–∞–∑—É—î –Ω–∞ —Ç–µ, —â–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—è `/usr/libexec` –∑–∞—Ö–∏—â–µ–Ω–∞ SIP. –£ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó, –∑–∞—Ö–∏—â–µ–Ω—ñ–π SIP, —Ñ–∞–π–ª–∏ –Ω–µ –º–æ–∂—É—Ç—å –±—É—Ç–∏ —Å—Ç–≤–æ—Ä–µ–Ω—ñ, –∑–º—ñ–Ω–µ–Ω—ñ –∞–±–æ –≤–∏–¥–∞–ª–µ–Ω—ñ.

–ë—ñ–ª—å—à–µ —Ç–æ–≥–æ, —è–∫—â–æ —Ñ–∞–π–ª –º—ñ—Å—Ç–∏—Ç—å –∞—Ç—Ä–∏–±—É—Ç **`com.apple.rootless`** —Ä–æ–∑—à–∏—Ä–µ–Ω–∏–π **–∞—Ç—Ä–∏–±—É—Ç**, —Ü–µ–π —Ñ–∞–π–ª —Ç–∞–∫–æ–∂ –±—É–¥–µ **–∑–∞—Ö–∏—â–µ–Ω–∏–π SIP**.

**SIP —Ç–∞–∫–æ–∂ –æ–±–º–µ–∂—É—î —ñ–Ω—à—ñ –¥—ñ—ó root**, —Ç–∞–∫—ñ —è–∫:

* –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–µ–Ω–∞–¥—ñ–π–Ω–∏—Ö —Ä–æ–∑—à–∏—Ä–µ–Ω—å —è–¥—Ä–∞
* –û—Ç—Ä–∏–º–∞–Ω–Ω—è task-ports –¥–ª—è –ø—Ä–æ—Ü–µ—Å—ñ–≤, –ø—ñ–¥–ø–∏—Å–∞–Ω–∏—Ö Apple
* –ú–æ–¥–∏—Ñ—ñ–∫–∞—Ü—ñ—è –∑–º—ñ–Ω–Ω–∏—Ö NVRAM
* –î–æ–∑–≤—ñ–ª –Ω–∞ –Ω–∞–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—è —è–¥—Ä–∞

–û–ø—Ü—ñ—ó –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è —É –∑–º—ñ–Ω–Ω—ñ–π nvram —è–∫ –±—ñ—Ç–æ–≤–∏–π –ø—Ä–∞–ø–æ—Ä–µ—Ü—å (`csr-active-config` –Ω–∞ Intel —ñ `lp-sip0` —á–∏—Ç–∞—î—Ç—å—Å—è –∑ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ–≥–æ Device Tree –¥–ª—è ARM). –í–∏ –º–æ–∂–µ—Ç–µ –∑–Ω–∞–π—Ç–∏ –ø—Ä–∞–ø–æ—Ä—Ü—ñ –≤ –≤–∏—Ö—ñ–¥–Ω–æ–º—É –∫–æ–¥—ñ XNU —É `csr.sh`:

<figure><img src="../../../.gitbook/assets/image (1192).png" alt=""><figcaption></figcaption></figure>

### –°—Ç–∞—Ç—É—Å SIP

–í–∏ –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏, —á–∏ —É–≤—ñ–º–∫–Ω–µ–Ω–æ SIP –Ω–∞ –≤–∞—à—ñ–π —Å–∏—Å—Ç–µ–º—ñ, –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –Ω–∞—Å—Ç—É–ø–Ω–æ—ó –∫–æ–º–∞–Ω–¥–∏:
```bash
csrutil status
```
–Ø–∫—â–æ –≤–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤–∏–º–∫–Ω—É—Ç–∏ SIP, –≤–∏ –ø–æ–≤–∏–Ω–Ω—ñ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∫–æ–º–ø'—é—Ç–µ—Ä —É —Ä–µ–∂–∏–º—ñ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è (–Ω–∞—Ç–∏—Å–∫–∞—é—á–∏ Command+R –ø—ñ–¥ —á–∞—Å –∑–∞–ø—É—Å–∫—É), –∞ –ø–æ—Ç—ñ–º –≤–∏–∫–æ–Ω–∞—Ç–∏ –Ω–∞—Å—Ç—É–ø–Ω—É –∫–æ–º–∞–Ω–¥—É:
```bash
csrutil disable
```
–Ø–∫—â–æ –≤–∏ —Ö–æ—á–µ—Ç–µ –∑–±–µ—Ä–µ–≥—Ç–∏ SIP —É–≤—ñ–º–∫–Ω–µ–Ω–∏–º, –∞–ª–µ –≤–∏–¥–∞–ª–∏—Ç–∏ –∑–∞—Ö–∏—Å—Ç–∏ –≤—ñ–¥ –Ω–∞–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—è, –≤–∏ –º–æ–∂–µ—Ç–µ –∑—Ä–æ–±–∏—Ç–∏ —Ü–µ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é:
```bash
csrutil enable --without debug
```
### –Ü–Ω—à—ñ –æ–±–º–µ–∂–µ–Ω–Ω—è

* **–ó–∞–±–æ—Ä–æ–Ω—è—î –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–µ–ø—ñ–¥–ø–∏—Å–∞–Ω–∏—Ö —Ä–æ–∑—à–∏—Ä–µ–Ω—å —è–¥—Ä–∞** (kexts), –∑–∞–±–µ–∑–ø–µ—á—É—é—á–∏, —â–æ–± –ª–∏—à–µ –ø–µ—Ä–µ–≤—ñ—Ä–µ–Ω—ñ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è –≤–∑–∞—î–º–æ–¥—ñ—è–ª–∏ –∑ —è–¥—Ä–æ–º —Å–∏—Å—Ç–µ–º–∏.
* **–ó–∞–ø–æ–±—ñ–≥–∞—î –Ω–∞–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—é** –ø—Ä–æ—Ü–µ—Å—ñ–≤ —Å–∏—Å—Ç–µ–º–∏ macOS, –∑–∞—Ö–∏—â–∞—é—á–∏ –æ—Å–Ω–æ–≤–Ω—ñ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏ —Å–∏—Å—Ç–µ–º–∏ –≤—ñ–¥ –Ω–µ—Å–∞–Ω–∫—Ü—ñ–æ–Ω–æ–≤–∞–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø—É —Ç–∞ –º–æ–¥–∏—Ñ—ñ–∫–∞—Ü—ñ—ó.
* **–ì–∞–ª—å–º—É—î —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏** –Ω–∞ –∫—à—Ç–∞–ª—Ç dtrace –≤—ñ–¥ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Å–∏—Å—Ç–µ–º–Ω–∏—Ö –ø—Ä–æ—Ü–µ—Å—ñ–≤, —â–µ –±—ñ–ª—å—à–µ –∑–∞—Ö–∏—â–∞—é—á–∏ —Ü—ñ–ª—ñ—Å–Ω—ñ—Å—Ç—å —Ä–æ–±–æ—Ç–∏ —Å–∏—Å—Ç–µ–º–∏.

[**–î—ñ–∑–Ω–∞–π—Ç–µ—Å—è –±—ñ–ª—å—à–µ –ø—Ä–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é SIP —É —Ü—ñ–π –¥–æ–ø–æ–≤—ñ–¥—ñ**](https://www.slideshare.net/i0n1c/syscan360-stefan-esser-os-x-el-capitan-sinking-the-ship)**.**

## –û–±—Ö—ñ–¥ SIP

–û–±—Ö—ñ–¥ SIP –¥–æ–∑–≤–æ–ª—è—î –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫—É:

* **–û—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ –¥–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞**: –ß–∏—Ç–∞—Ç–∏ —á—É—Ç–ª–∏–≤—ñ –¥–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, —Ç–∞–∫—ñ —è–∫ –µ–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞ –ø–æ—à—Ç–∞, –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —Ç–∞ —ñ—Å—Ç–æ—Ä—ñ—è Safari –∑ —É—Å—ñ—Ö –æ–±–ª—ñ–∫–æ–≤–∏—Ö –∑–∞–ø–∏—Å—ñ–≤ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤.
* **–û–±—Ö—ñ–¥ TCC**: –ü—Ä—è–º–æ –º–∞–Ω—ñ–ø—É–ª—é–≤–∞—Ç–∏ –±–∞–∑–æ—é –¥–∞–Ω–∏—Ö TCC (–ü—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å, –ó–≥–æ–¥–∞ —Ç–∞ –ö–æ–Ω—Ç—Ä–æ–ª—å), —â–æ–± –Ω–∞–¥–∞—Ç–∏ –Ω–µ—Å–∞–Ω–∫—Ü—ñ–æ–Ω–æ–≤–∞–Ω–∏–π –¥–æ—Å—Ç—É–ø –¥–æ –≤–µ–±-–∫–∞–º–µ—Ä–∏, –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞ —Ç–∞ —ñ–Ω—à–∏—Ö —Ä–µ—Å—É—Ä—Å—ñ–≤.
* **–í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –ø–æ—Å—Ç—ñ–π–Ω—ñ—Å—Ç—å**: –†–æ–∑–º—ñ—Å—Ç–∏—Ç–∏ —à–∫—ñ–¥–ª–∏–≤–µ –ü–ó –≤ –∑–∞—Ö–∏—â–µ–Ω–∏—Ö SIP –º—ñ—Å—Ü—è—Ö, —Ä–æ–±–ª—è—á–∏ –π–æ–≥–æ —Å—Ç—ñ–π–∫–∏–º –¥–æ –≤–∏–¥–∞–ª–µ–Ω–Ω—è, –Ω–∞–≤—ñ—Ç—å –∑ –ø—Ä–∞–≤–∞–º–∏ root. –¶–µ —Ç–∞–∫–æ–∂ –≤–∫–ª—é—á–∞—î –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –ø—ñ–¥—Ä–æ–±–∫–∏ –Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É –≤–∏–¥–∞–ª–µ–Ω–Ω—è —à–∫—ñ–¥–ª–∏–≤–æ–≥–æ –ü–ó (MRT).
* **–ó–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—Ç–∏ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è —è–¥—Ä–∞**: –•–æ—á–∞ —î –¥–æ–¥–∞—Ç–∫–æ–≤—ñ –∑–∞–ø–æ–±—ñ–∂–Ω–∏–∫–∏, –æ–±—Ö—ñ–¥ SIP —Å–ø—Ä–æ—â—É—î –ø—Ä–æ—Ü–µ—Å –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–µ–ø—ñ–¥–ø–∏—Å–∞–Ω–∏—Ö —Ä–æ–∑—à–∏—Ä–µ–Ω—å —è–¥—Ä–∞.

### –ü–∞–∫–µ—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–Ω–∏–∫—ñ–≤

**–ü–∞–∫–µ—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–Ω–∏–∫—ñ–≤, –ø—ñ–¥–ø–∏—Å–∞–Ω—ñ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–æ–º Apple**, –º–æ–∂—É—Ç—å –æ–±—ñ–π—Ç–∏ –π–æ–≥–æ –∑–∞—Ö–∏—Å—Ç. –¶–µ –æ–∑–Ω–∞—á–∞—î, —â–æ –Ω–∞–≤—ñ—Ç—å –ø–∞–∫–µ—Ç–∏, –ø—ñ–¥–ø–∏—Å–∞–Ω—ñ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–º–∏ —Ä–æ–∑—Ä–æ–±–Ω–∏–∫–∞–º–∏, –±—É–¥—É—Ç—å –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω—ñ, —è–∫—â–æ –≤–æ–Ω–∏ –Ω–∞–º–∞–≥–∞—Ç–∏–º—É—Ç—å—Å—è –∑–º—ñ–Ω–∏—Ç–∏ –∫–∞—Ç–∞–ª–æ–≥–∏, –∑–∞—Ö–∏—â–µ–Ω—ñ SIP.

### –ù–µ–≤—ñ–¥–æ–º–∏–π —Ñ–∞–π–ª SIP

–û–¥–Ω—ñ—î—é –∑ –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏—Ö –ª–∞–∑—ñ–≤–æ–∫ —î —Ç–µ, —â–æ —è–∫—â–æ —Ñ–∞–π–ª –≤–∫–∞–∑–∞–Ω–æ –≤ **`rootless.conf`, –∞–ª–µ –Ω–∞—Ä–∞–∑—ñ –Ω–µ —ñ—Å–Ω—É—î**, –π–æ–≥–æ –º–æ–∂–Ω–∞ —Å—Ç–≤–æ—Ä–∏—Ç–∏. –®–∫—ñ–¥–ª–∏–≤–µ –ü–ó –º–æ–∂–µ —Å–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏—Å—è —Ü–∏–º, —â–æ–± **–≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –ø–æ—Å—Ç—ñ–π–Ω—ñ—Å—Ç—å** –≤ —Å–∏—Å—Ç–µ–º—ñ. –ù–∞–ø—Ä–∏–∫–ª–∞–¥, —à–∫—ñ–¥–ª–∏–≤–∞ –ø—Ä–æ–≥—Ä–∞–º–∞ –º–æ–∂–µ —Å—Ç–≤–æ—Ä–∏—Ç–∏ —Ñ–∞–π–ª .plist —É `/System/Library/LaunchDaemons`, —è–∫—â–æ –≤—ñ–Ω –≤–∫–∞–∑–∞–Ω–∏–π —É `rootless.conf`, –∞–ª–µ –Ω–µ –ø—Ä–∏—Å—É—Ç–Ω—ñ–π.

### com.apple.rootless.install.heritable

{% hint style="danger" %}
–ü—Ä–∞–≤–æ **`com.apple.rootless.install.heritable`** –¥–æ–∑–≤–æ–ª—è—î –æ–±—ñ–π—Ç–∏ SIP
{% endhint %}

#### [CVE-2019-8561](https://objective-see.org/blog/blog\_0x42.html) <a href="#cve" id="cve"></a>

–ë—É–ª–æ –≤–∏—è–≤–ª–µ–Ω–æ, —â–æ –º–æ–∂–ª–∏–≤–æ **–ø–æ–º—ñ–Ω—è—Ç–∏ –ø–∞–∫–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–Ω–∏–∫–∞ –ø—ñ—Å–ª—è —Ç–æ–≥–æ, —è–∫ —Å–∏—Å—Ç–µ–º–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∏–ª–∞ –π–æ–≥–æ –∫–æ–¥** –ø—ñ–¥–ø–∏—Å—É, —ñ —Ç–æ–¥—ñ —Å–∏—Å—Ç–µ–º–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª—é–≤–∞–ª–∞ –± —à–∫—ñ–¥–ª–∏–≤–∏–π –ø–∞–∫–µ—Ç –∑–∞–º—ñ—Å—Ç—å –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–æ–≥–æ. –û—Å–∫—ñ–ª—å–∫–∏ —Ü—ñ –¥—ñ—ó –≤–∏–∫–æ–Ω—É–≤–∞–ª–∏—Å—è **`system_installd`**, —Ü–µ –¥–æ–∑–≤–æ–ª—è–ª–æ –æ–±—ñ–π—Ç–∏ SIP.

#### [CVE-2020‚Äì9854](https://objective-see.org/blog/blog\_0x4D.html) <a href="#cve-unauthd-chain" id="cve-unauthd-chain"></a>

–Ø–∫—â–æ –ø–∞–∫–µ—Ç –±—É–ª–æ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∑ –∑–º–æ–Ω—Ç–æ–≤–∞–Ω–æ–≥–æ –æ–±—Ä–∞–∑—É –∞–±–æ –∑–æ–≤–Ω—ñ—à–Ω—å–æ–≥–æ –¥–∏—Å–∫–∞, **—É—Å—Ç–∞–Ω–æ–≤–Ω–∏–∫** **–≤–∏–∫–æ–Ω—É–≤–∞–≤** –¥–≤—ñ–π–∫–æ–≤–∏–π —Ñ–∞–π–ª –∑ **—Ü—å–æ–≥–æ —Ñ–∞–π–ª–æ–≤–æ–≥–æ —Å–∏—Å—Ç–µ–º–∏** (–∑–∞–º—ñ—Å—Ç—å –∑–∞—Ö–∏—â–µ–Ω–æ–≥–æ –º—ñ—Å—Ü—è SIP), –∑–º—É—à—É—é—á–∏ **`system_installd`** –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –¥–æ–≤—ñ–ª—å–Ω–∏–π –¥–≤—ñ–π–∫–æ–≤–∏–π —Ñ–∞–π–ª.

#### CVE-2021-30892 - Shrootless

[**–î–æ—Å–ª—ñ–¥–Ω–∏–∫–∏ –∑ —Ü—å–æ–≥–æ –±–ª–æ–≥—É**](https://www.microsoft.com/en-us/security/blog/2021/10/28/microsoft-finds-new-macos-vulnerability-shrootless-that-could-bypass-system-integrity-protection/) –≤–∏—è–≤–∏–ª–∏ –≤—Ä–∞–∑–ª–∏–≤—ñ—Å—Ç—å —É –º–µ—Ö–∞–Ω—ñ–∑–º—ñ –∑–∞—Ö–∏—Å—Ç—É —Ü—ñ–ª—ñ—Å–Ω–æ—Å—Ç—ñ —Å–∏—Å—Ç–µ–º–∏ (SIP) macOS, –Ω–∞–∑–≤–∞–Ω—É –≤—Ä–∞–∑–ª–∏–≤—ñ—Å—Ç—é 'Shrootless'. –¶—è –≤—Ä–∞–∑–ª–∏–≤—ñ—Å—Ç—å –∑–æ—Å–µ—Ä–µ–¥–∂–µ–Ω–∞ –Ω–∞–≤–∫–æ–ª–æ –¥–µ–º–æ–Ω–∞ **`system_installd`**, —è–∫–∏–π –º–∞—î –ø—Ä–∞–≤–æ **`com.apple.rootless.install.heritable`**, —â–æ –¥–æ–∑–≤–æ–ª—è—î –±—É–¥—å-—è–∫–æ–º—É –∑ –π–æ–≥–æ –¥–æ—á—ñ—Ä–Ω—ñ—Ö –ø—Ä–æ—Ü–µ—Å—ñ–≤ –æ–±—ñ–π—Ç–∏ –æ–±–º–µ–∂–µ–Ω–Ω—è —Ñ–∞–π–ª–æ–≤–æ—ó —Å–∏—Å—Ç–µ–º–∏ SIP.

–î–µ–º–æ–Ω **`system_installd`** –±—É–¥–µ –≤—Å—Ç–∞–Ω–æ–≤–ª—é–≤–∞—Ç–∏ –ø–∞–∫–µ—Ç–∏, —è–∫—ñ –±—É–ª–∏ –ø—ñ–¥–ø–∏—Å–∞–Ω—ñ **Apple**.

–î–æ—Å–ª—ñ–¥–Ω–∏–∫–∏ –≤–∏—è–≤–∏–ª–∏, —â–æ –ø—ñ–¥ —á–∞—Å —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–∞–∫–µ—Ç–∞, –ø—ñ–¥–ø–∏—Å–∞–Ω–æ–≥–æ Apple (.pkg —Ñ–∞–π–ª), **`system_installd`** **–≤–∏–∫–æ–Ω—É—î** –±—É–¥—å-—è–∫—ñ **—Å–∫—Ä–∏–ø—Ç–∏ –ø—ñ—Å–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏**, –≤–∫–ª—é—á–µ–Ω—ñ –≤ –ø–∞–∫–µ—Ç. –¶—ñ —Å–∫—Ä–∏–ø—Ç–∏ –≤–∏–∫–æ–Ω—É—é—Ç—å—Å—è –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ—ó –æ–±–æ–ª–æ–Ω–∫–∏, **`zsh`**, —è–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ **–≤–∏–∫–æ–Ω—É—î** –∫–æ–º–∞–Ω–¥–∏ –∑ —Ñ–∞–π–ª—É **`/etc/zshenv`**, —è–∫—â–æ –≤—ñ–Ω —ñ—Å–Ω—É—î, –Ω–∞–≤—ñ—Ç—å —É –Ω–µ—ñ–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–º—É —Ä–µ–∂–∏–º—ñ. –¶—é –ø–æ–≤–µ–¥—ñ–Ω–∫—É –º–æ–∂—É—Ç—å –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫–∏: —Å—Ç–≤–æ—Ä–∏–≤—à–∏ —à–∫—ñ–¥–ª–∏–≤–∏–π —Ñ–∞–π–ª `/etc/zshenv` —ñ —á–µ–∫–∞—é—á–∏, –ø–æ–∫–∏ **`system_installd` –≤–∏–∫–ª–∏—á–µ `zsh`**, –≤–æ–Ω–∏ –º–æ–∂—É—Ç—å –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –¥–æ–≤—ñ–ª—å–Ω—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó –Ω–∞ –ø—Ä–∏—Å—Ç—Ä–æ—ó.

–ë—ñ–ª—å—à–µ —Ç–æ–≥–æ, –±—É–ª–æ –≤–∏—è–≤–ª–µ–Ω–æ, —â–æ **`/etc/zshenv` –º–æ–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏—Å—è —è–∫ –∑–∞–≥–∞–ª—å–Ω–∞ —Ç–µ—Ö–Ω—ñ–∫–∞ –∞—Ç–∞–∫–∏**, –Ω–µ –ª–∏—à–µ –¥–ª—è –æ–±—Ö–æ–¥—É SIP. –ö–æ–∂–µ–Ω –ø—Ä–æ—Ñ—ñ–ª—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –º–∞—î —Ñ–∞–π–ª `~/.zshenv`, —è–∫–∏–π –ø–æ–≤–æ–¥–∏—Ç—å—Å—è —Ç–∞–∫ —Å–∞–º–æ, —è–∫ `/etc/zshenv`, –∞–ª–µ –Ω–µ –≤–∏–º–∞–≥–∞—î –ø—Ä–∞–≤ root. –¶–µ–π —Ñ–∞–π–ª –º–æ–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏—Å—è —è–∫ –º–µ—Ö–∞–Ω—ñ–∑–º –ø–æ—Å—Ç—ñ–π–Ω–æ—Å—Ç—ñ, —Å–ø—Ä–∞—Ü—å–æ–≤—É—é—á–∏ —â–æ—Ä–∞–∑—É, –∫–æ–ª–∏ –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è `zsh`, –∞–±–æ —è–∫ –º–µ—Ö–∞–Ω—ñ–∑–º –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤. –Ø–∫—â–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä –ø—ñ–¥–≤–∏—â—É—î –ø—Ä–∏–≤—ñ–ª–µ—ó –¥–æ root, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ `sudo -s` –∞–±–æ `sudo <command>`, —Ñ–∞–π–ª `~/.zshenv` –±—É–¥–µ —Å–ø—Ä–∞—Ü—å–æ–≤—É–≤–∞—Ç–∏, –µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –ø—ñ–¥–≤–∏—â—É—é—á–∏ –ø—Ä–∏–≤—ñ–ª–µ—ó –¥–æ root.

#### [**CVE-2022-22583**](https://perception-point.io/blog/technical-analysis-cve-2022-22583/)

–£ [**CVE-2022-22583**](https://perception-point.io/blog/technical-analysis-cve-2022-22583/) –±—É–ª–æ –≤–∏—è–≤–ª–µ–Ω–æ, —â–æ —Ç–æ–π –∂–µ –ø—Ä–æ—Ü–µ—Å **`system_installd`** –≤—Å–µ —â–µ –º–æ–∂–Ω–∞ –∑–ª–æ–≤–∂–∏–≤–∞—Ç–∏, –æ—Å–∫—ñ–ª—å–∫–∏ –≤—ñ–Ω –ø–æ–º—ñ—â–∞–≤ **—Å–∫—Ä–∏–ø—Ç –ø—ñ—Å–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ –ø–∞–ø–∫—É –∑ –≤–∏–ø–∞–¥–∫–æ–≤–æ—é –Ω–∞–∑–≤–æ—é, –∑–∞—Ö–∏—â–µ–Ω—É SIP —É `/tmp`**. –°–ø—Ä–∞–≤–∞ –≤ —Ç–æ–º—É, —â–æ **`/tmp` —Å–∞–º –ø–æ —Å–æ–±—ñ –Ω–µ –∑–∞—Ö–∏—â–µ–Ω–∏–π SIP**, —Ç–æ–º—É –±—É–ª–æ –º–æ–∂–ª–∏–≤–∏–º **–∑–º–æ–Ω—Ç—É–≤–∞—Ç–∏** **–≤—ñ—Ä—Ç—É–∞–ª—å–Ω–∏–π –æ–±—Ä–∞–∑ –Ω–∞ –Ω—å–æ–º—É**, –ø–æ—Ç—ñ–º **—É—Å—Ç–∞–Ω–æ–≤–Ω–∏–∫** –ø–æ–º—ñ—Å—Ç–∏–≤ –±–∏ —Ç—É–¥–∏ **—Å–∫—Ä–∏–ø—Ç –ø—ñ—Å–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏**, **–∑–Ω—è–≤ –±–∏** –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–∏–π –æ–±—Ä–∞–∑, **–≤—ñ–¥—Ç–≤–æ—Ä–∏–≤ –±–∏** –≤—Å—ñ **–ø–∞–ø–∫–∏** —Ç–∞ **–¥–æ–¥–∞–≤ –±–∏** **—Å–∫—Ä–∏–ø—Ç –ø—ñ—Å–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏** –∑ **payload** –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è.

#### [fsck\_cs utility](https://www.theregister.com/2016/03/30/apple\_os\_x\_rootless/)

–í–∏—è–≤–ª–µ–Ω–æ –≤—Ä–∞–∑–ª–∏–≤—ñ—Å—Ç—å, –ø—Ä–∏ —è–∫—ñ–π **`fsck_cs`** –±—É–≤ –≤–≤–µ–¥–µ–Ω–∏–π –≤ –æ–º–∞–Ω—É, —â–æ –ø—Ä–∏–∑–≤–µ–ª–æ –¥–æ –ø–æ—à–∫–æ–¥–∂–µ–Ω–Ω—è –≤–∞–∂–ª–∏–≤–æ–≥–æ —Ñ–∞–π–ª—É, —á–µ—Ä–µ–∑ –π–æ–≥–æ –∑–¥–∞—Ç–Ω—ñ—Å—Ç—å —Å–ª—ñ–¥—É–≤–∞—Ç–∏ **—Å–∏–º–≤–æ–ª—ñ—á–Ω–∏–º –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º**. –ó–æ–∫—Ä–µ–º–∞, –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫–∏ —Å—Ç–≤–æ—Ä–∏–ª–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –∑ _`/dev/diskX`_ –Ω–∞ —Ñ–∞–π–ª `/System/Library/Extensions/AppleKextExcludeList.kext/Contents/Info.plist`. –í–∏–∫–æ–Ω–∞–Ω–Ω—è **`fsck_cs`** –Ω–∞ _`/dev/diskX`_ –ø—Ä–∏–∑–≤–µ–ª–æ –¥–æ –ø–æ—à–∫–æ–¥–∂–µ–Ω–Ω—è `Info.plist`. –¶—ñ–ª—ñ—Å–Ω—ñ—Å—Ç—å —Ü—å–æ–≥–æ —Ñ–∞–π–ª—É —î –≤–∞–∂–ª–∏–≤–æ—é –¥–ª—è SIP (–ó–∞—Ö–∏—Å—Ç —Ü—ñ–ª—ñ—Å–Ω–æ—Å—Ç—ñ —Å–∏—Å—Ç–µ–º–∏) –æ–ø–µ—Ä–∞—Ü—ñ–π–Ω–æ—ó —Å–∏—Å—Ç–µ–º–∏, —è–∫–∞ –∫–æ–Ω—Ç—Ä–æ–ª—é—î –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä–æ–∑—à–∏—Ä–µ–Ω—å —è–¥—Ä–∞. –ü—ñ—Å–ª—è –ø–æ—à–∫–æ–¥–∂–µ–Ω–Ω—è –∑–¥–∞—Ç–Ω—ñ—Å—Ç—å SIP —É–ø—Ä–∞–≤–ª—è—Ç–∏ –≤–∏–∫–ª—é—á–µ–Ω–Ω—è–º–∏ —è–¥—Ä–∞ –ø–æ—Ä—É—à—É—î—Ç—å—Å—è.

–ö–æ–º–∞–Ω–¥–∏ –¥–ª—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —Ü—ñ—î—ó –≤—Ä–∞–∑–ª–∏–≤–æ—Å—Ç—ñ:
```bash
ln -s /System/Library/Extensions/AppleKextExcludeList.kext/Contents/Info.plist /dev/diskX
fsck_cs /dev/diskX 1>&-
touch /Library/Extensions/
reboot
```
The exploitation of this vulnerability has severe implications. The `Info.plist` file, normally responsible for managing permissions for kernel extensions, becomes ineffective. This includes the inability to blacklist certain extensions, such as `AppleHWAccess.kext`. Consequently, with the SIP's control mechanism out of order, this extension can be loaded, granting unauthorized read and write access to the system's RAM.

#### [–ú–æ–Ω—Ç—É–≤–∞–Ω–Ω—è —á–µ—Ä–µ–∑ –∑–∞—Ö–∏—â–µ–Ω—ñ –ø–∞–ø–∫–∏ SIP](https://www.slideshare.net/i0n1c/syscan360-stefan-esser-os-x-el-capitan-sinking-the-ship)

–ë—É–ª–æ –º–æ–∂–ª–∏–≤–∏–º –∑–º–æ–Ω—Ç—É–≤–∞—Ç–∏ –Ω–æ–≤—É —Ñ–∞–π–ª–æ–≤—É —Å–∏—Å—Ç–µ–º—É —á–µ—Ä–µ–∑ **–∑–∞—Ö–∏—â–µ–Ω—ñ –ø–∞–ø–∫–∏ SIP, —â–æ–± –æ–±—ñ–π—Ç–∏ –∑–∞—Ö–∏—Å—Ç**.
```bash
mkdir evil
# Add contento to the folder
hdiutil create -srcfolder evil evil.dmg
hdiutil attach -mountpoint /System/Library/Snadbox/ evil.dmg
```
#### [Upgrader bypass (2016)](https://objective-see.org/blog/blog\_0x14.html)

–°–∏—Å—Ç–µ–º–∞ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∞ –Ω–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑ –≤–±—É–¥–æ–≤–∞–Ω–æ–≥–æ –æ–±—Ä–∞–∑—É –¥–∏—Å–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–Ω–∏–∫–∞ –≤ `Install macOS Sierra.app` –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –û–°, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ —É—Ç–∏–ª—ñ—Ç—É `bless`. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –Ω–∞—Å—Ç—É–ø–Ω–∞ –∫–æ–º–∞–Ω–¥–∞:
```bash
/usr/sbin/bless -setBoot -folder /Volumes/Macintosh HD/macOS Install Data -bootefi /Volumes/Macintosh HD/macOS Install Data/boot.efi -options config="\macOS Install Data\com.apple.Boot" -label macOS Installer
```
–ë–µ–∑–ø–µ–∫–∞ —Ü—å–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—É –º–æ–∂–µ –±—É—Ç–∏ —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–æ–≤–∞–Ω–∞, —è–∫—â–æ –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –∑–º—ñ–Ω—é—î –æ–±—Ä–∞–∑ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è (`InstallESD.dmg`) –ø–µ—Ä–µ–¥ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è–º. –°—Ç—Ä–∞—Ç–µ–≥—ñ—è –ø–æ–ª—è–≥–∞—î –≤ –∑–∞–º—ñ–Ω—ñ –¥–∏–Ω–∞–º—ñ—á–Ω–æ–≥–æ –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—á–∞ (dyld) –Ω–∞ —à–∫—ñ–¥–ª–∏–≤—É –≤–µ—Ä—Å—ñ—é (`libBaseIA.dylib`). –¶—è –∑–∞–º—ñ–Ω–∞ –ø—Ä–∏–∑–≤–æ–¥–∏—Ç—å –¥–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∫–æ–¥—É –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫–∞, –∫–æ–ª–∏ —ñ–Ω—ñ—Ü—ñ—é—î—Ç—å—Å—è —ñ–Ω—Å—Ç–∞–ª—è—Ç–æ—Ä.

–ö–æ–¥ –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫–∞ –æ—Ç—Ä–∏–º—É—î –∫–æ–Ω—Ç—Ä–æ–ª—å –ø—ñ–¥ —á–∞—Å –ø—Ä–æ—Ü–µ—Å—É –æ–Ω–æ–≤–ª–µ–Ω–Ω—è, –µ–∫—Å–ø–ª—É–∞—Ç—É—é—á–∏ –¥–æ–≤—ñ—Ä—É —Å–∏—Å—Ç–µ–º–∏ –¥–æ —ñ–Ω—Å—Ç–∞–ª—è—Ç–æ—Ä–∞. –ê—Ç–∞–∫–∞ –ø—Ä–æ–¥–æ–≤–∂—É—î—Ç—å—Å—è —à–ª—è—Ö–æ–º –∑–º—ñ–Ω–∏ –æ–±—Ä–∞–∑—É `InstallESD.dmg` –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –º–µ—Ç–æ–¥—É swizzling, –æ—Å–æ–±–ª–∏–≤–æ –Ω–∞—Ü—ñ–ª—é—é—á–∏—Å—å –Ω–∞ –º–µ—Ç–æ–¥ `extractBootBits`. –¶–µ –¥–æ–∑–≤–æ–ª—è—î —ñ–Ω–∂–µ–∫—Ç—É–≤–∞—Ç–∏ —à–∫—ñ–¥–ª–∏–≤–∏–π –∫–æ–¥ –ø–µ—Ä–µ–¥ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º –æ–±—Ä–∞–∑—É –¥–∏—Å–∫–∞.

–ë—ñ–ª—å—à–µ —Ç–æ–≥–æ, –≤ `InstallESD.dmg` —î `BaseSystem.dmg`, —è–∫–∏–π —Å–ª—É–≥—É—î –∫–æ—Ä–µ–Ω–µ–≤–æ—é —Ñ–∞–π–ª–æ–≤–æ—é —Å–∏—Å—Ç–µ–º–æ—é –∫–æ–¥—É –æ–Ω–æ–≤–ª–µ–Ω–Ω—è. –Ü–Ω–∂–µ–∫—Ü—ñ—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ—ó –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ –≤ —Ü–µ–π —Ñ–∞–π–ª –¥–æ–∑–≤–æ–ª—è—î —à–∫—ñ–¥–ª–∏–≤–æ–º—É –∫–æ–¥—É –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –≤ –ø—Ä–æ—Ü–µ—Å—ñ, –∑–¥–∞—Ç–Ω–æ–º—É –∑–º—ñ–Ω—é–≤–∞—Ç–∏ —Ñ–∞–π–ª–∏ –Ω–∞ —Ä—ñ–≤–Ω—ñ –û–°, —â–æ –∑–Ω–∞—á–Ω–æ –ø—ñ–¥–≤–∏—â—É—î –ø–æ—Ç–µ–Ω—Ü—ñ–∞–ª –¥–ª—è –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü—ñ—ó —Å–∏—Å—Ç–µ–º–∏.

#### [systemmigrationd (2023)](https://www.youtube.com/watch?v=zxZesAN-TEk)

–£ —Ü—ñ–π –¥–æ–ø–æ–≤—ñ–¥—ñ –∑ [**DEF CON 31**](https://www.youtube.com/watch?v=zxZesAN-TEk) –ø–æ–∫–∞–∑–∞–Ω–æ, —è–∫ **`systemmigrationd`** (—è–∫–∏–π –º–æ–∂–µ –æ–±—ñ–π—Ç–∏ SIP) –≤–∏–∫–æ–Ω—É—î **bash** —Ç–∞ **perl** —Å–∫—Ä–∏–ø—Ç–∏, —è–∫—ñ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –∑–ª–æ–≤–∂–∏–≤–∞–Ω—ñ —á–µ—Ä–µ–∑ –∑–º—ñ–Ω–Ω—ñ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ **`BASH_ENV`** —Ç–∞ **`PERL5OPT`**.

#### CVE-2023-42860 <a href="#cve-a-detailed-look" id="cve-a-detailed-look"></a>

–Ø–∫ [**–¥–µ—Ç–∞–ª—å–Ω–æ –æ–ø–∏—Å–∞–Ω–æ –≤ —Ü—å–æ–º—É –±–ª–æ–∑—ñ**](https://blog.kandji.io/apple-mitigates-vulnerabilities-installer-scripts), —Å–∫—Ä–∏–ø—Ç `postinstall` –∑ –ø–∞–∫–µ—Ç—ñ–≤ `InstallAssistant.pkg` –¥–æ–∑–≤–æ–ª—è–≤ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è:
```bash
/usr/bin/chflags¬†-h¬†norestricted¬†"${SHARED_SUPPORT_PATH}/SharedSupport.dmg"
```
and it was possible to create a symlink in `${SHARED_SUPPORT_PATH}/SharedSupport.dmg` that would allow a user to **unrestrict any file, bypassing SIP protection**.

### **com.apple.rootless.install**

{% hint style="danger" %}
The entitlement **`com.apple.rootless.install`** allows to bypass SIP
{% endhint %}

The entitlement `com.apple.rootless.install` is known to bypass System Integrity Protection (SIP) on macOS. This was notably mentioned in relation to [**CVE-2022-26712**](https://jhftss.github.io/CVE-2022-26712-The-POC-For-SIP-Bypass-Is-Even-Tweetable/).

In this specific case, the system XPC service located at `/System/Library/PrivateFrameworks/ShoveService.framework/Versions/A/XPCServices/SystemShoveService.xpc` possesses this entitlement. This allows the related process to circumvent SIP constraints. Furthermore, this service notably presents a method that permits the movement of files without enforcing any security measures.

## Sealed System Snapshots

Sealed System Snapshots are a feature introduced by Apple in **macOS Big Sur (macOS 11)** as a part of its **System Integrity Protection (SIP)** mechanism to provide an additional layer of security and system stability. They are essentially read-only versions of the system volume.

Here's a more detailed look:

1. **–ù–µ–∑–º—ñ–Ω–Ω–∞ —Å–∏—Å—Ç–µ–º–∞**: Sealed System Snapshots —Ä–æ–±–ª—è—Ç—å –æ–±'—î–º —Å–∏—Å—Ç–µ–º–∏ macOS "–Ω–µ–∑–º—ñ–Ω–Ω–∏–º", —â–æ –æ–∑–Ω–∞—á–∞—î, —â–æ –π–æ–≥–æ –Ω–µ –º–æ–∂–Ω–∞ –∑–º—ñ–Ω—é–≤–∞—Ç–∏. –¶–µ –∑–∞–ø–æ–±—ñ–≥–∞—î –±—É–¥—å-—è–∫–∏–º –Ω–µ—Å–∞–Ω–∫—Ü—ñ–æ–Ω–æ–≤–∞–Ω–∏–º –∞–±–æ –≤–∏–ø–∞–¥–∫–æ–≤–∏–º –∑–º—ñ–Ω–∞–º —Å–∏—Å—Ç–µ–º–∏, —è–∫—ñ –º–æ–∂—É—Ç—å –∑–∞–≥—Ä–æ–∂—É–≤–∞—Ç–∏ –±–µ–∑–ø–µ—Ü—ñ –∞–±–æ —Å—Ç–∞–±—ñ–ª—å–Ω–æ—Å—Ç—ñ —Å–∏—Å—Ç–µ–º–∏.
2. **–û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–∞–º–Ω–æ–≥–æ –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è**: –ö–æ–ª–∏ –≤–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î—Ç–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∞–±–æ –∞–ø–≥—Ä–µ–π–¥–∏ macOS, macOS —Å—Ç–≤–æ—Ä—é—î –Ω–æ–≤–∏–π –∑–Ω—ñ–º–æ–∫ —Å–∏—Å—Ç–µ–º–∏. –û–±'—î–º –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è macOS –ø–æ—Ç—ñ–º –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î **APFS (Apple File System)** –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥—É –Ω–∞ —Ü–µ–π –Ω–æ–≤–∏–π –∑–Ω—ñ–º–æ–∫. –£–≤–µ—Å—å –ø—Ä–æ—Ü–µ—Å –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –æ–Ω–æ–≤–ª–µ–Ω—å —Å—Ç–∞—î –±–µ–∑–ø–µ—á–Ω—ñ—à–∏–º —ñ –Ω–∞–¥—ñ–π–Ω—ñ—à–∏–º, –æ—Å–∫—ñ–ª—å–∫–∏ —Å–∏—Å—Ç–µ–º–∞ –∑–∞–≤–∂–¥–∏ –º–æ–∂–µ –ø–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –∑–Ω—ñ–º–∫–∞, —è–∫—â–æ —â–æ—Å—å –ø—ñ–¥–µ –Ω–µ —Ç–∞–∫ –ø—ñ–¥ —á–∞—Å –æ–Ω–æ–≤–ª–µ–Ω–Ω—è.
3. **–†–æ–∑–¥—ñ–ª–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö**: –£ –ø–æ—î–¥–Ω–∞–Ω–Ω—ñ –∑ –∫–æ–Ω—Ü–µ–ø—Ü—ñ—î—é —Ä–æ–∑–¥—ñ–ª–µ–Ω–Ω—è –æ–±'—î–º—ñ–≤ –¥–∞–Ω–∏—Ö —ñ —Å–∏—Å—Ç–µ–º–∏, –≤–≤–µ–¥–µ–Ω–æ—é –≤ macOS Catalina, —Ñ—É–Ω–∫—Ü—ñ—è Sealed System Snapshot –∑–∞–±–µ–∑–ø–µ—á—É—î –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –≤—Å—ñ—Ö –≤–∞—à–∏—Ö –¥–∞–Ω–∏—Ö —ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å –Ω–∞ –æ–∫—Ä–µ–º–æ–º—É –æ–±'—î–º—ñ "**–î–∞–Ω—ñ**". –¶–µ —Ä–æ–∑–¥—ñ–ª–µ–Ω–Ω—è —Ä–æ–±–∏—Ç—å –≤–∞—à—ñ –¥–∞–Ω—ñ –Ω–µ–∑–∞–ª–µ–∂–Ω–∏–º–∏ –≤—ñ–¥ —Å–∏—Å—Ç–µ–º–∏, —â–æ —Å–ø—Ä–æ—â—É—î –ø—Ä–æ—Ü–µ—Å –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–∏—Å—Ç–µ–º–∏ —Ç–∞ –ø—ñ–¥–≤–∏—â—É—î –±–µ–∑–ø–µ–∫—É —Å–∏—Å—Ç–µ–º–∏.

–ü–∞–º'—è—Ç–∞–π—Ç–µ, —â–æ —Ü—ñ –∑–Ω—ñ–º–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∫–µ—Ä—É—é—Ç—å—Å—è macOS —ñ –Ω–µ –∑–∞–π–º–∞—é—Ç—å –¥–æ–¥–∞—Ç–∫–æ–≤–æ–≥–æ –º—ñ—Å—Ü—è –Ω–∞ –≤–∞—à–æ–º—É –¥–∏—Å–∫—É –∑–∞–≤–¥—è–∫–∏ –º–æ–∂–ª–∏–≤–æ—Å—Ç—è–º —Å–ø—ñ–ª—å–Ω–æ–≥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –ø—Ä–æ—Å—Ç–æ—Ä—É APFS. –¢–∞–∫–æ–∂ –≤–∞–∂–ª–∏–≤–æ –∑–∞–∑–Ω–∞—á–∏—Ç–∏, —â–æ —Ü—ñ –∑–Ω—ñ–º–∫–∏ –≤—ñ–¥—Ä—ñ–∑–Ω—è—é—Ç—å—Å—è –≤—ñ–¥ **–∑–Ω—ñ–º–∫—ñ–≤ Time Machine**, —è–∫—ñ —î —Ä–µ–∑–µ—Ä–≤–Ω–∏–º–∏ –∫–æ–ø—ñ—è–º–∏ –≤—Å—ñ—î—ó —Å–∏—Å—Ç–µ–º–∏, –¥–æ—Å—Ç—É–ø–Ω–∏–º–∏ –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞.

### Check Snapshots

The command **`diskutil apfs list`** lists the **details of the APFS volumes** and their layout:

<pre><code>+-- Container disk3 966B902E-EDBA-4775-B743-CF97A0556A13
|   ====================================================
|   APFS Container Reference:     disk3
|   Size (Capacity Ceiling):      494384795648 B (494.4 GB)
|   Capacity In Use By Volumes:   219214536704 B (219.2 GB) (44.3% used)
|   Capacity Not Allocated:       275170258944 B (275.2 GB) (55.7% free)
|   |
|   +-&#x3C; Physical Store disk0s2 86D4B7EC-6FA5-4042-93A7-D3766A222EBE
|   |   -----------------------------------------------------------
|   |   APFS Physical Store Disk:   disk0s2
|   |   Size:                       494384795648 B (494.4 GB)
|   |
|   +-> Volume disk3s1 7A27E734-880F-4D91-A703-FB55861D49B7
|   |   ---------------------------------------------------
<strong>|   |   APFS Volume Disk (Role):   disk3s1 (System)
</strong>|   |   Name:                      Macintosh HD (Case-insensitive)
<strong>|   |   Mount Point:               /System/Volumes/Update/mnt1
</strong>|   |   Capacity Consumed:         12819210240 B (12.8 GB)
|   |   Sealed:                    Broken
|   |   FileVault:                 Yes (Unlocked)
|   |   Encrypted:                 No
|   |   |
|   |   Snapshot:                  FAA23E0C-791C-43FF-B0E7-0E1C0810AC61
|   |   Snapshot Disk:             disk3s1s1
<strong>|   |   Snapshot Mount Point:      /
</strong><strong>|   |   Snapshot Sealed:           Yes
</strong>[...]
+-> Volume disk3s5 281959B7-07A1-4940-BDDF-6419360F3327
|   ---------------------------------------------------
|   APFS Volume Disk (Role):   disk3s5 (Data)
|   Name:                      Macintosh HD - Data (Case-insensitive)
<strong>    |   Mount Point:               /System/Volumes/Data
</strong><strong>    |   Capacity Consumed:         412071784448 B (412.1 GB)
</strong>    |   Sealed:                    No
|   FileVault:                 Yes (Unlocked)
</code></pre>

In the previous output it's possible to see that **user-accessible locations** are mounted under `/System/Volumes/Data`.

Moreover, **macOS System volume snapshot** is mounted in `/` and it's **sealed** (cryptographically signed by the OS). So, if SIP is bypassed and modifies it, the **OS won't boot anymore**.

It's also possible to **verify that seal is enabled** by running:
```bash
csrutil authenticated-root status
Authenticated Root status: enabled
```
–ö—Ä—ñ–º —Ç–æ–≥–æ, –∑–Ω—ñ–º–æ–∫ –¥–∏—Å–∫–∞ —Ç–∞–∫–æ–∂ –∑–º–æ–Ω—Ç–æ–≤–∞–Ω–æ —è–∫ **—Ç—ñ–ª—å–∫–∏ –¥–ª—è —á–∏—Ç–∞–Ω–Ω—è**:
```bash
mount
/dev/disk3s1s1 on / (apfs, sealed, local, read-only, journaled)
```
{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
</details>
