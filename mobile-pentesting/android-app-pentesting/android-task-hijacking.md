# Android Task Hijacking

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* VocÃª trabalha em uma **empresa de seguranÃ§a cibernÃ©tica**? VocÃª quer ver sua **empresa anunciada no HackTricks**? ou vocÃª quer ter acesso Ã  **Ãºltima versÃ£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A FamÃ­lia PEASS**](https://opensea.io/collection/the-peass-family), nossa coleÃ§Ã£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**repositÃ³rio hacktricks**](https://github.com/carlospolop/hacktricks) **e** [**repositÃ³rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Encontre vulnerabilidades que sÃ£o mais importantes para que vocÃª possa corrigi-las mais rapidamente. O Intruder rastreia sua superfÃ­cie de ataque, executa varreduras proativas de ameaÃ§as, encontra problemas em toda a sua pilha de tecnologia, desde APIs atÃ© aplicativos da web e sistemas em nuvem. [**Experimente gratuitamente**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) hoje.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Tarefa, Back Stack e Atividades em Primeiro Plano

Uma tarefa Ã© uma coleÃ§Ã£o de atividades com as quais os usuÃ¡rios interagem ao realizar um determinado trabalho. As atividades sÃ£o organizadas em uma pilha - o _**back stack**_ - na ordem em que cada atividade Ã© aberta.

A atividade que estÃ¡ **exibida** na tela Ã© chamada de **atividade em primeiro plano** e sua **tarefa** Ã© chamada de **tarefa em primeiro plano**. Em um determinado momento, apenas **uma tarefa em primeiro plano Ã© visÃ­vel na tela**.

Aqui estÃ¡ um fluxo de atividade simples:

* HÃ¡ apenas a Atividade 1 em primeiro plano.
* A Atividade 2 Ã© iniciada, o que empurra a Atividade 1 para o Back Stack. Agora a Atividade 2 estÃ¡ em primeiro plano.
* A Atividade 3 Ã© iniciada, o que empurra tanto a Atividade 1 quanto a 2 para o Back Stack.
* Agora, quando a Atividade 3 Ã© fechada, a atividade anterior, ou seja, 2, Ã© trazida automaticamente para o primeiro plano. Ã‰ assim que a navegaÃ§Ã£o de tarefas funciona no Android.

![](<../../.gitbook/assets/image (548).png>)

### Multitarefa no Android - Uma Tarefa

Uma tarefa Ã© composta por vÃ¡rias atividades

![](<../../.gitbook/assets/image (549).png>)

### Multitarefa no Android - VÃ¡rias Tarefas

O Android geralmente gerencia vÃ¡rias tarefas

![](<../../.gitbook/assets/image (550).png>)

## Controles de Tarefa

![](<../../.gitbook/assets/image (551).png>)

## Ataque de afinidade de tarefa

### Afinidade de tarefa e Modos de InicializaÃ§Ã£o

**Afinidade de tarefa** Ã© um atributo definido em cada tag `<activity>` no arquivo `AndroidManifest.xml`. Ele descreve a qual tarefa uma atividade prefere se juntar.\
Por padrÃ£o, cada atividade tem a mesma afinidade que o nome do **pacote**.

Vamos usar isso ao criar nosso aplicativo PoC.
```markup
<activity android:taskAffinity=""/>
```
**Modos de lanÃ§amento** permitem definir como uma nova instÃ¢ncia de uma atividade estÃ¡ associada Ã  tarefa atual. O atributo [`launchMode`](https://developer.android.com/guide/topics/manifest/activity-element#lmode) especifica uma instruÃ§Ã£o sobre como a atividade deve ser lanÃ§ada em uma tarefa.\
Existem quatro modos de lanÃ§amento diferentes:

1. padrÃ£o (PadrÃ£o)
2. singleTop
3. **singleTask**
4. singleInstance

Quando o `launchMode` Ã© definido como `singleTask`, o sistema Android avalia trÃªs possibilidades e uma delas Ã© a razÃ£o pela qual nosso ataque Ã© possÃ­vel. Aqui estÃ£o elas -

* **Se a instÃ¢ncia da atividade jÃ¡ existe**:\
O Android retoma a instÃ¢ncia existente em vez de criar uma nova. Isso significa que hÃ¡ no mÃ¡ximo uma instÃ¢ncia de atividade no sistema sob este modo.
* **Se for necessÃ¡rio criar uma nova instÃ¢ncia da atividade**:\
O ServiÃ§o de Gerenciador de Atividades (AMS) seleciona uma tarefa para hospedar a nova instÃ¢ncia criada encontrando uma tarefa "correspondente" em todas as tarefas existentes. **Uma atividade "corresponde" a uma tarefa se elas tÃªm a mesma afinidade de tarefa**. Esta Ã© a razÃ£o pela qual podemos **especificar a mesma afinidade de tarefa do aplicativo vulnerÃ¡vel em nosso aplicativo de malware/atacante para que ele seja lanÃ§ado em sua tarefa em vez de criar sua prÃ³pria**.
* **Sem encontrar uma tarefa "correspondente"**:\
O AMS cria uma nova tarefa e torna a nova instÃ¢ncia da atividade a atividade raiz da tarefa recÃ©m-criada.

### Ataque

A vÃ­tima precisa ter o **aplicativo malicioso** **instalado** em seu dispositivo. Em seguida, ele precisa **abri-lo** **antes** de abrir o **aplicativo vulnerÃ¡vel**. EntÃ£o, quando o **aplicativo vulnerÃ¡vel** Ã© **aberto**, o **aplicativo malicioso** serÃ¡ **aberto** **em seu lugar**. Se este aplicativo malicioso apresentar o **mesmo** **login** que o aplicativo vulnerÃ¡vel, o **usuÃ¡rio nÃ£o terÃ¡ meios de saber que estÃ¡ inserindo suas credenciais em um aplicativo malicioso**.

**VocÃª pode encontrar um ataque implementado aqui:** [**https://github.com/az0mb13/Task\_Hijacking\_Strandhogg**](https://github.com/az0mb13/Task\_Hijacking\_Strandhogg)

## Prevenindo o sequestro de tarefas

Definir **`taskAffinity=""`** pode ser uma soluÃ§Ã£o rÃ¡pida para esse problema. O modo de lanÃ§amento tambÃ©m pode ser definido como **singleInstance** se o aplicativo nÃ£o quiser que outras atividades se juntem Ã s tarefas a que pertence. Uma funÃ§Ã£o personalizada **onBackPressed()** tambÃ©m pode ser adicionada para substituir o comportamento padrÃ£o.

## **ReferÃªncias**

* [**https://blog.dixitaditya.com/android-task-hijacking/**](https://blog.dixitaditya.com/android-task-hijacking/)
* [**https://blog.takemyhand.xyz/2021/02/android-task-hijacking-with.html**](https://blog.takemyhand.xyz/2021/02/android-task-hijacking-with.html)

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Encontre vulnerabilidades que sÃ£o mais importantes para que vocÃª possa corrigi-las mais rapidamente. O Intruder rastreia sua superfÃ­cie de ataque, executa varreduras proativas de ameaÃ§as, encontra problemas em toda a sua pilha de tecnologia, desde APIs atÃ© aplicativos da web e sistemas em nuvem. [**Experimente gratuitamente**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) hoje.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* VocÃª trabalha em uma **empresa de ciberseguranÃ§a**? VocÃª quer ver sua **empresa anunciada no HackTricks**? ou vocÃª quer ter acesso Ã  **Ãºltima versÃ£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa coleÃ§Ã£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe suas tÃ©cnicas de hacking enviando PRs para o** [**repositÃ³rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**repositÃ³rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
