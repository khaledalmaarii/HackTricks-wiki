# Drozer Tutorial

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

<img src="../../../.gitbook/assets/i3.png" alt="" data-size="original">

**Wskaz贸wka dotyczca bug bounty**: **zarejestruj si** na platformie **Intigriti**, premium **platformie bug bounty stworzonej przez haker贸w, dla haker贸w**! Docz do nas na [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) ju偶 dzi i zacznij zarabia nagrody do **100 000 USD**!

{% embed url="https://go.intigriti.com/hacktricks" %}

## APK do testowania

* [Sieve](https://github.com/mwrlabs/drozer/releases/download/2.3.4/sieve.apk) (od mrwlabs)
* [DIVA](https://payatu.com/wp-content/uploads/2016/01/diva-beta.tar.gz)

**Czci tego samouczka zostay wyjte z** [**Drozer documentation pdf**](https://labs.withsecure.com/content/dam/labs/docs/mwri-drozer-user-guide-2015-03-23.pdf)**.**

## Instalacja

Zainstaluj klienta Drozer w swoim hocie. Pobierz go z [najnowszych wyda](https://github.com/mwrlabs/drozer/releases).

```bash
pip install drozer-2.4.4-py2-none-any.whl
pip install twisted
pip install service_identity
```

Pobierz i zainstaluj plik APK drozer z [najnowszych wyda](https://github.com/mwrlabs/drozer/releases). W tym momencie jest to [ten](https://github.com/mwrlabs/drozer/releases/download/2.3.4/drozer-agent-2.3.4.apk).

```bash
adb install drozer.apk
```

### Uruchamianie serwera

Agent dziaa na porcie 31415, musimy [przekierowa port](https://pl.wikipedia.org/wiki/Przekierowanie\_port%C3%B3w) w celu nawizania komunikacji midzy klientem Drozer a Agentem. Oto polecenie, kt贸re nale偶y wykona:

```bash
adb forward tcp:31415 tcp:31415
```

W kocu, **uruchom** **aplikacj** i nacinij przycisk "**ON**"

![](<../../../.gitbook/assets/image (63).png>)

Nastpnie pocz si z ni:

```bash
drozer console connect
```

## Interesujce polecenia

| **Polecenia**   | **Opis**                                                                                                                                       |
| --------------- | ---------------------------------------------------------------------------------------------------------------------------------------------- |
| **Help MODULE** | Wywietla pomoc dla wybranego moduu                                                                                                           |
| **list**        | Wywietla list wszystkich modu贸w drozera, kt贸re mo偶na uruchomi w bie偶cej sesji. Ukrywa moduy, do kt贸rych nie masz odpowiednich uprawnie. |
| **shell**       | Uruchamia interaktywn powok Linux na urzdzeniu, w kontekcie agenta.                                                                       |
| **clean**       | Usuwa tymczasowe pliki przechowywane przez drozera na urzdzeniu Android.                                                                      |
| **load**        | Wczytuje plik zawierajcy polecenia drozera i wykonuje je sekwencyjnie.                                                                        |
| **module**      | Znajduje i instaluje dodatkowe moduy drozera z Internetu.                                                                                     |
| **unset**       | Usuwa nazwan zmienn, kt贸r drozer przekazuje do ka偶dej powoki Linux, kt贸r uruchamia.                                                       |
| **set**         | Przechowuje warto w zmiennej, kt贸ra zostanie przekazana jako zmienna rodowiskowa do ka偶dej powoki Linux uruchamianej przez drozera.        |
| **shell**       | Uruchamia interaktywn powok Linux na urzdzeniu, w kontekcie agenta.                                                                       |
| **run MODULE**  | Wykonuje modu drozera                                                                                                                         |
| **exploit**     | Drozer mo偶e tworzy exploity do wykonania na urzdzeniu. `drozer exploit list`                                                                 |
| **payload**     | Exploity wymagaj payloadu. `drozer payload list`                                                                                              |

### Pakiet

Znajd藕 **nazw** pakietu, filtrowanie po czci nazwy:

```bash
dz> run app.package.list -f sieve
com.mwr.example.sieve
```

**Podstawowe informacje** o pakiecie:

```bash
dz> run app.package.info -a com.mwr.example.sieve
Package: com.mwr.example.sieve
Process Name: com.mwr.example.sieve
Version: 1.0
Data Directory: /data/data/com.mwr.example.sieve
APK Path: /data/app/com.mwr.example.sieve-2.apk
UID: 10056
GID: [1028, 1015, 3003]
Shared Libraries: null
Shared User ID: null
Uses Permissions:
- android.permission.READ_EXTERNAL_STORAGE
- android.permission.WRITE_EXTERNAL_STORAGE
- android.permission.INTERNET
Defines Permissions:
- com.mwr.example.sieve.READ_KEYS
- com.mwr.example.sieve.WRITE_KEYS
```

Przeczytaj **Manifest**:

```bash
run app.package.manifest jakhar.aseem.diva
```

**Powierzchnia ataku** pakietu:

```bash
dz> run app.package.attacksurface com.mwr.example.sieve
Attack Surface:
3 activities exported
0 broadcast receivers exported
2 content providers exported
2 services exported
is debuggable
```

* **Aktywnoci**: Mo偶e mo偶na uruchomi aktywno i omin pewnego rodzaju autoryzacj, kt贸ra powinna Ci powstrzyma przed jej uruchomieniem.
* **Dostawcy treci**: Mo偶e mo偶na uzyska dostp do prywatnych danych lub wykorzysta jak podatno (wstrzyknicie SQL lub przechodzenie cie偶ek).
* **Usugi**:
* **is debuggable**: [Dowiedz si wicej](./#is-debuggeable)

### Aktywnoci

Warto "android:exported" skadnika aktywnoci jest ustawiona na **"true"** w pliku AndroidManifest.xml:

```markup
<activity android:name="com.my.app.Initial" android:exported="true">
</activity>
```

**Lista wyeksportowanych aktywnoci**:

Aby wywietli list wyeksportowanych aktywnoci w aplikacji Android, wykonaj nastpujce kroki:

1. Uruchom narzdzie drozer, wpisujc polecenie `drozer console connect`.
2. Po poczeniu z urzdzeniem, wpisz polecenie `run app.package.exported_activities -a <nazwa_pakietu>`, gdzie `<nazwa_pakietu>` to nazwa pakietu aplikacji, kt贸rej aktywnoci chcesz sprawdzi.
3. Po wykonaniu polecenia, zostanie wywietlona lista wszystkich wyeksportowanych aktywnoci w podanej aplikacji.

Przykad u偶ycia:

```
run app.package.exported_activities -a com.example.app
```

Wynik:

```
Exported Activities:
- com.example.app.MainActivity
- com.example.app.SecondActivity
- com.example.app.SettingsActivity
```

Pamitaj, 偶e wyeksportowane aktywnoci mog stanowi potencjalne zagro偶enie dla bezpieczestwa aplikacji, dlatego wa偶ne jest, aby odpowiednio zabezpieczy je przed nieautoryzowanym dostpem.

```bash
dz> run app.activity.info -a com.mwr.example.sieve
Package: com.mwr.example.sieve
com.mwr.example.sieve.FileSelectActivity
com.mwr.example.sieve.MainLoginActivity
com.mwr.example.sieve.PWList
```

**Rozpoczcie aktywnoci**:

Mo偶esz spr贸bowa rozpocz aktywno i omin pewnego rodzaju autoryzacj, kt贸ra powinna Ci powstrzyma przed jej uruchomieniem.

{% code overflow="wrap" %}
```bash
dz> run app.activity.start --component com.mwr.example.sieve com.mwr.example.sieve.PWList
```
{% endcode %}

Mo偶esz r贸wnie偶 uruchomi wyeksportowan aktywno za pomoc **adb**:

* Nazwa pakietu to com.example.demo
* Nazwa wyeksportowanej aktywnoci to com.example.test.MainActivity

```bash
adb shell am start -n com.example.demo/com.example.test.MainActivity
```

### Dostawcy treci

Ten post jest tak du偶y, 偶e **mo偶esz** [**uzyska do niego dostp na osobnej stronie tutaj**](exploiting-content-providers.md).

### Usugi

Usuga eksportowana jest deklarowana w pliku Manifest.xml:

{% code overflow="wrap" %}
```markup
<service android:name=".AuthService" android:exported="true" android:process=":remote"/>
```
{% endcode %}

Wewntrz kodu **sprawd藕** funkcj \*\*`handleMessage`\*\*, kt贸ra bdzie **odbiera** **wiadomo**:

![](<../../../.gitbook/assets/image (194).png>)

#### Lista usug

```bash
dz> run app.service.info -a com.mwr.example.sieve
Package: com.mwr.example.sieve
com.mwr.example.sieve.AuthService
Permission: null
com.mwr.example.sieve.CryptoService
Permission: null
```

#### **Komunikacja** z usug

To interact with a service, you need to establish a connection and send requests to it. In the case of Android app pentesting, you can use drozer to interact with the app's services.

A service is a component of an Android app that runs in the background without a user interface. It performs long-running operations or handles remote requests. By interacting with a service, you can gather information, manipulate data, or even exploit vulnerabilities.

Drozer provides a command-line interface to interact with Android app services. You can use the `run` command to execute drozer modules that interact with the app's services. These modules are designed to perform specific tasks, such as listing services, invoking methods, or querying content providers.

To interact with a service using drozer, follow these steps:

1. Start drozer by running the command `drozer console connect`.
2. Connect to the target device by running the command `run app.package.list -f <package_name>`.
3. List the services available in the app by running the command `run app.service.list -f <package_name>`.
4. Choose a service to interact with and gather information about it by running the command `run app.service.info -f <package_name> -u <service_name>`.
5. Invoke methods on the service by running the command `run app.service.send <package_name> <service_name> <method_name> <arguments>`.
6. Analyze the responses and gather any relevant information.

By interacting with an app's services, you can gain a deeper understanding of its functionality and identify potential security vulnerabilities. This knowledge can be used to enhance your pentesting efforts and ensure the app's security.

```bash
app.service.send            Send a Message to a service, and display the reply
app.service.start           Start Service
app.service.stop            Stop Service
```

#### Przykad

Zajrzyj do pomocy **drozera** dla `app.service.send`:

![](<../../../.gitbook/assets/image (196) (1).png>)

Zauwa偶, 偶e najpierw wysyasz dane wewntrz "_msg.what_", nastpnie "_msg.arg1_" i "_msg.arg2_", powiniene sprawdzi w kodzie **jakie informacje s u偶ywane** i gdzie.\
U偶ywajc opcji `--extra` mo偶esz wysa co, co zostanie zinterpretowane jako "_msg.replyTo"_, a u偶ywajc `--bundle-as-obj` tworzysz obiekt z podanymi szczeg贸ami.

W poni偶szym przykadzie:

* `what == 2354`
* `arg1 == 9234`
* `arg2 == 1`
* `replyTo == object(string com.mwr.example.sieve.PIN 1337)`

```bash
run app.service.send com.mwr.example.sieve com.mwr.example.sieve.AuthService --msg 2354 9234 1 --extra string com.mwr.example.sieve.PIN 1337 --bundle-as-obj
```

![](<../../../.gitbook/assets/image (195).png>)

### Odbiorniki transmisji

**W sekcji podstawowych informacji o Androidzie mo偶esz zobaczy, czym jest odbiornik transmisji**.

Po odkryciu tych odbiornik贸w transmisji powiniene **sprawdzi ich kod**. Zwr贸 szczeg贸ln uwag na funkcj **`onReceive`**, poniewa偶 to wanie ona bdzie obsugiwa otrzymane wiadomoci.

#### Wykrywanie wszystkich odbiornik贸w transmisji

```bash
run app.broadcast.info #Detects all
```

#### Sprawd藕 odbiorniki nadawcze aplikacji

Aby sprawdzi odbiorniki nadawcze aplikacji, mo偶esz u偶y narzdzia `drozer`. `drozer` to framework do testowania penetracyjnego aplikacji mobilnych na platformie Android. Poni偶ej przedstawiono kroki, kt贸re nale偶y podj, aby sprawdzi odbiorniki nadawcze aplikacji przy u偶yciu `drozera`:

1. Uruchom `drozera` na swoim urzdzeniu lub emulatorze Android.
2. Pocz si z urzdzeniem za pomoc polecenia `connect <adres IP urzdzenia>`.
3. Wywietl list zainstalowanych aplikacji za pomoc polecenia `run app.package.list`.
4. Wybierz aplikacj, kt贸rej odbiorniki nadawcze chcesz sprawdzi, za pomoc polecenia `run app.package.info -a <nazwa pakietu aplikacji>`.
5. Wywietl list odbiornik贸w nadawczych aplikacji za pomoc polecenia `run app.broadcast.info -a <nazwa pakietu aplikacji>`.

Dziki tym krokom bdziesz m贸g sprawdzi odbiorniki nadawcze aplikacji przy u偶yciu narzdzia `drozer`.

```bash
#Check one negative
run app.broadcast.info -a jakhar.aseem.diva
Package: jakhar.aseem.diva
No matching receivers.

# Check one positive
run app.broadcast.info -a com.google.android.youtube
Package: com.google.android.youtube
com.google.android.libraries.youtube.player.PlayerUiModule$LegacyMediaButtonIntentReceiver
Permission: null
com.google.android.apps.youtube.app.common.notification.GcmBroadcastReceiver
Permission: com.google.android.c2dm.permission.SEND
com.google.android.apps.youtube.app.PackageReplacedReceiver
Permission: null
com.google.android.libraries.youtube.account.AccountsChangedReceiver
Permission: null
com.google.android.apps.youtube.app.application.system.LocaleUpdatedReceiver
Permission: null
```

#### Interakcje **Broadcast贸w**

```bash
app.broadcast.info          Get information about broadcast receivers
app.broadcast.send          Send broadcast using an intent
app.broadcast.sniff         Register a broadcast receiver that can sniff particular intents
```

#### Wylij wiadomo

W tym przykadzie, wykorzystujc apk [FourGoats](https://github.com/linkedin/qark/blob/master/tests/goatdroid.apk) i dostawc treci, mo偶esz **wysa dowoln wiadomo SMS** do dowolnego niepremiumowego celu **bez pytania** u偶ytkownika o zgod.

![](<../../../.gitbook/assets/image (199).png>)

![](<../../../.gitbook/assets/image (197) (1).png>)

Jeli przeczytasz kod, parametry "_phoneNumber_" i "_message_" musz zosta przesane do dostawcy treci.

```bash
run app.broadcast.send --action org.owasp.goatdroid.fourgoats.SOCIAL_SMS --component org.owasp.goatdroid.fourgoats.broadcastreceivers SendSMSNowReceiver --extra string phoneNumber 123456789 --extra string message "Hello mate!"
```

### Czy jest mo偶liwe debugowanie

Produkcyjne pliki APK nigdy nie powinny by debugowalne.\
Oznacza to, 偶e mo偶na **podczy debugger javy** do dziaajcej aplikacji, przeglda j w czasie rzeczywistym, ustawia punkty przerwania, krok po kroku analizowa, zbiera wartoci zmiennych, a nawet je zmienia. [InfoSec institute ma doskonay artyku](https://github.com/carlospolop/hacktricks/blob/pl/mobile-pentesting/android-app-pentesting/exploiting-a-debuggeable-application.md) na temat zagbiania si w aplikacj, gdy jest ona debugowalna i wstrzykiwania kodu w czasie wykonania.

Gdy aplikacja jest debugowalna, pojawi si to w Manifest:

```xml
<application theme="@2131296387" debuggable="true"
```

Mo偶esz znale藕 wszystkie aplikacje, kt贸re mo偶na debugowa za pomoc **Drozera**:

```bash
run app.package.debuggable
```

## Samouczki

* [https://resources.infosecinstitute.com/android-penetration-tools-walkthrough-series-drozer/#gref](https://resources.infosecinstitute.com/android-penetration-tools-walkthrough-series-drozer/#gref)
* [https://github.com/mgcfish/mobiletools/blob/master/\_posts/2016-08-01-Using-Drozer-for-application-security-assessments.md](https://github.com/mgcfish/mobiletools/blob/master/\_posts/2016-08-01-Using-Drozer-for-application-security-assessments.md)
* [https://www.hackingarticles.in/android-penetration-testing-drozer/](https://www.hackingarticles.in/android-penetration-testing-drozer/)
* [https://medium.com/@ashrafrizvi3006/how-to-test-android-application-security-using-drozer-edc002c5dcac](https://medium.com/@ashrafrizvi3006/how-to-test-android-application-security-using-drozer-edc002c5dcac)

## Wicej informacji

* [https://blog.dixitaditya.com/android-pentesting-cheatsheet/](https://blog.dixitaditya.com/android-pentesting-cheatsheet/)

<img src="../../../.gitbook/assets/i3.png" alt="" data-size="original">

**Wskaz贸wka dotyczca nagrody za bd**: **zarejestruj si** na platformie **Intigriti**, premium **platformie nagr贸d za bdy stworzonej przez haker贸w, dla haker贸w**! Docz do nas na [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) ju偶 dzi i zacznij zarabia nagrody do **100 000 USD**!

{% embed url="https://go.intigriti.com/hacktricks" %}

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
