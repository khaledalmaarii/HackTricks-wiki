# Tutorial Drozer

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<img src="../../../.gitbook/assets/i3.png" alt="" data-size="original">

**Dica para bug bounty**: **inscreva-se** no **Intigriti**, uma plataforma premium de **bug bounty criada por hackers, para hackers**! Junte-se a n√≥s em [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) hoje mesmo e comece a ganhar recompensas de at√© **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

## APKs para testar

* [Sieve](https://github.com/mwrlabs/drozer/releases/download/2.3.4/sieve.apk) (da mrwlabs)
* [DIVA](https://payatu.com/wp-content/uploads/2016/01/diva-beta.tar.gz)

## Instala√ß√£o

Instale o Cliente Drozer no seu host. Baixe-o a partir das [√∫ltimas vers√µes](https://github.com/mwrlabs/drozer/releases).
```bash
pip install drozer-2.4.4-py2-none-any.whl
pip install twisted
pip install service_identity
```
Baixe e instale o APK do drozer a partir dos [√∫ltimos lan√ßamentos](https://github.com/mwrlabs/drozer/releases). No momento, √© [este](https://github.com/mwrlabs/drozer/releases/download/2.3.4/drozer-agent-2.3.4.apk).
```
adb install drozer.apk
```
### Iniciando o Servidor

O Agent est√° rodando na porta 31415, precisamos fazer o [encaminhamento de porta](https://en.wikipedia.org/wiki/Port\_forwarding) para estabelecer a comunica√ß√£o entre o Cliente Drozer e o Agent, aqui est√° o comando para fazer isso:
```
adb forward tcp:31415 tcp:31415
```
Finalmente, **inicie** o **aplicativo** e pressione o bot√£o "**ON**"

![](<../../../.gitbook/assets/image (63).png>)

E conecte-se a ele:
```
drozer console connect
```
## Comandos Interessantes

| **Comandos**    | **Descri√ß√£o**                                                                                                                                        |
| --------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Help MODULE** | Mostra a ajuda do m√≥dulo selecionado                                                                                                                  |
| **list**        | Exibe uma lista de todos os m√≥dulos drozer que podem ser executados na sess√£o atual. Isso oculta m√≥dulos que voc√™ n√£o tem permiss√µes adequadas para executar. |
| **shell**       | Inicia um shell Linux interativo no dispositivo, no contexto do Agente.                                                                               |
| **clean**       | Remove arquivos tempor√°rios armazenados pelo drozer no dispositivo Android.                                                                           |
| **load**        | Carrega um arquivo contendo comandos drozer e executa-os em sequ√™ncia.                                                                                 |
| **module**      | Encontra e instala m√≥dulos drozer adicionais da Internet.                                                                                             |
| **unset**       | Remove uma vari√°vel nomeada que o drozer passa para quaisquer shells Linux que ele inicia.                                                            |
| **set**         | Armazena um valor em uma vari√°vel que ser√° passada como uma vari√°vel de ambiente para quaisquer shells Linux iniciados pelo drozer.                    |
| **shell**       | Inicia um shell Linux interativo no dispositivo, no contexto do Agente                                                                                 |
| **run MODULE**  | Executa um m√≥dulo drozer                                                                                                                               |
| **exploit**     | O drozer pode criar exploits para executar no dispositivo. `drozer exploit list`                                                                      |
| **payload**     | Os exploits precisam de um payload. `drozer payload list`                                                                                              |

### Pacote

Encontre o **nome** do pacote filtrando por parte do nome:
```
dz> run app.package.list -f sieve
com.mwr.example.sieve
```
**Informa√ß√µes B√°sicas** do pacote:
```
dz> run app.package.info -a com.mwr.example.sieve
Package: com.mwr.example.sieve
Process Name: com.mwr.example.sieve
Version: 1.0
Data Directory: /data/data/com.mwr.example.sieve
APK Path: /data/app/com.mwr.example.sieve-2.apk
UID: 10056
GID: [1028, 1015, 3003]
Shared Libraries: null
Shared User ID: null
Uses Permissions:
- android.permission.READ_EXTERNAL_STORAGE
- android.permission.WRITE_EXTERNAL_STORAGE
- android.permission.INTERNET
Defines Permissions:
- com.mwr.example.sieve.READ_KEYS
- com.mwr.example.sieve.WRITE_KEYS
```
Ler **Manifest**:
```
run app.package.manifest jakhar.aseem.diva
```
**Superf√≠cie de ataque** do pacote:
```
dz> run app.package.attacksurface com.mwr.example.sieve
Attack Surface:
3 activities exported
0 broadcast receivers exported
2 content providers exported
2 services exported
is debuggable
```
* **Activities**: Talvez voc√™ possa iniciar uma atividade e contornar algum tipo de autoriza√ß√£o que deveria impedir o lan√ßamento dela.
* **Content providers**: Talvez voc√™ possa acessar dados privados ou explorar alguma vulnerabilidade (SQL Injection ou Path Traversal).
* **Services**:
* **is debuggable**: [Saiba mais](./#is-debuggeable)

### Activities

O valor "android:exported" de um componente de atividade exportado est√° definido como **"true"** no arquivo AndroidManifest.xml:
```markup
<activity android:name="com.my.app.Initial" android:exported="true">
</activity>
```
**Listar atividades exportadas**:
```bash
dz> run app.activity.info -a com.mwr.example.sieve
Package: com.mwr.example.sieve
com.mwr.example.sieve.FileSelectActivity
com.mwr.example.sieve.MainLoginActivity
com.mwr.example.sieve.PWList
```
**Iniciar atividade**:

Talvez voc√™ possa iniciar uma atividade e contornar algum tipo de autoriza√ß√£o que deveria impedir o lan√ßamento dela.

{% code overflow="wrap" %}
```bash
dz> run app.activity.start --component com.mwr.example.sieve com.mwr.example.sieve.PWList
```
{% endcode %}

Voc√™ tamb√©m pode iniciar uma atividade exportada a partir do **adb**:

* PackageName √© com.example.demo
* Exported ActivityName √© com.example.test.MainActivity
```bash
adb shell am start -n com.example.demo/com.example.test.MainActivity
```
### Provedores de Conte√∫do

Este post era t√£o grande para estar aqui que **voc√™ pode** [**acess√°-lo em sua pr√≥pria p√°gina aqui**](exploiting-content-providers.md).

### Servi√ßos

Um servi√ßo exportado √© declarado dentro do Manifest.xml:

{% code overflow="wrap" %}
```markup
<service android:name=".AuthService" android:exported="true" android:process=":remote"/>
```
{% endcode %}

Dentro do c√≥digo, **verifique** a fun√ß√£o \*\*`handleMessage`\*\* que ir√° **receber** a **mensagem**:

![](<../../../.gitbook/assets/image (194).png>)

#### Listar servi√ßo
```bash
dz> run app.service.info -a com.mwr.example.sieve
Package: com.mwr.example.sieve
com.mwr.example.sieve.AuthService
Permission: null
com.mwr.example.sieve.CryptoService
Permission: null
```
#### **Interagir** com um servi√ßo
```
app.service.send            Send a Message to a service, and display the reply
app.service.start           Start Service
app.service.stop            Stop Service
```
#### Exemplo

D√™ uma olhada na ajuda do **drozer** para `app.service.send`:

![](<../../../.gitbook/assets/image (196) (1).png>)

Note que voc√™ estar√° enviando primeiro os dados dentro de "_msg.what_", depois "_msg.arg1_" e "_msg.arg2_". Voc√™ deve verificar dentro do c√≥digo **quais informa√ß√µes est√£o sendo usadas** e onde.\
Usando a op√ß√£o `--extra`, voc√™ pode enviar algo interpretado por "_msg.replyTo"_, e usando `--bundle-as-obj`, voc√™ cria um objeto com os detalhes fornecidos.

No exemplo a seguir:

* `what == 2354`
* `arg1 == 9234`
* `arg2 == 1`
* `replyTo == object(string com.mwr.example.sieve.PIN 1337)`
```
run app.service.send com.mwr.example.sieve com.mwr.example.sieve.AuthService --msg 2354 9234 1 --extra string com.mwr.example.sieve.PIN 1337 --bundle-as-obj
```
```markdown
![](<../../../.gitbook/assets/image (195).png>)

### Receptores de Broadcast

Aplicativos Android podem enviar ou receber mensagens broadcast do sistema Android e de outros aplicativos Android, similar ao padr√£o de design [publish-subscribe](https://en.wikipedia.org/wiki/Publish%E2%80%93subscribe\_pattern). Esses broadcasts s√£o enviados quando um evento de interesse ocorre. Por exemplo, o sistema Android envia broadcasts quando v√°rios eventos do sistema ocorrem, como quando o sistema √© iniciado ou o dispositivo come√ßa a carregar. Aplicativos tamb√©m podem enviar broadcasts personalizados, por exemplo, para notificar outros aplicativos sobre algo que possa ser do interesse deles (por exemplo, novos dados foram baixados).

Aplicativos podem se registrar para receber broadcasts espec√≠ficos. Quando um broadcast √© enviado, o sistema automaticamente encaminha os broadcasts para os aplicativos que se inscreveram para receber aquele tipo particular de broadcast.

Isso poderia aparecer dentro do arquivo Manifest.xml:
```
```markup
<receiver android:name=".MyBroadcastReceiver"  android:exported="true">
<intent-filter>
<action android:name="android.intent.action.BOOT_COMPLETED"/>
<action android:name="android.intent.action.INPUT_METHOD_CHANGED" />
</intent-filter>
</receiver>
```
De: [https://developer.android.com/guide/components/broadcasts](https://developer.android.com/guide/components/broadcasts)

Ap√≥s descobrir estes Broadcast Receivers, voc√™ deve **verificar o c√≥digo** deles. Preste aten√ß√£o especial √† fun√ß√£o **`onReceive`**, pois ela ser√° respons√°vel por lidar com as mensagens recebidas.

#### **Detectar todos** os broadcast receivers
```bash
run app.broadcast.info #Detects all
```
#### Verificar os receptores de transmiss√£o de um app
```bash
#Check one negative
run app.broadcast.info -a jakhar.aseem.diva
Package: jakhar.aseem.diva
No matching receivers.

# Check one positive
run app.broadcast.info -a com.google.android.youtube
Package: com.google.android.youtube
com.google.android.libraries.youtube.player.PlayerUiModule$LegacyMediaButtonIntentReceiver
Permission: null
com.google.android.apps.youtube.app.common.notification.GcmBroadcastReceiver
Permission: com.google.android.c2dm.permission.SEND
com.google.android.apps.youtube.app.PackageReplacedReceiver
Permission: null
com.google.android.libraries.youtube.account.AccountsChangedReceiver
Permission: null
com.google.android.apps.youtube.app.application.system.LocaleUpdatedReceiver
Permission: null
```
#### Intera√ß√µes de **Broadcast**
```
app.broadcast.info          Get information about broadcast receivers
app.broadcast.send          Send broadcast using an intent
app.broadcast.sniff         Register a broadcast receiver that can sniff particular intents
```
#### Enviar uma mensagem

Neste exemplo, abusando do Content Provider do [FourGoats apk](https://github.com/linkedin/qark/blob/master/tests/goatdroid.apk), voc√™ pode **enviar um SMS arbitr√°rio** para qualquer destino n√£o-premium **sem pedir** permiss√£o ao usu√°rio.

![](<../../../.gitbook/assets/image (199).png>)

![](<../../../.gitbook/assets/image (197) (1).png>)

Se voc√™ ler o c√≥digo, os par√¢metros "_phoneNumber_" e "_message_" devem ser enviados para o Content Provider.
```
run app.broadcast.send --action org.owasp.goatdroid.fourgoats.SOCIAL_SMS --component org.owasp.goatdroid.fourgoats.broadcastreceivers SendSMSNowReceiver --extra string phoneNumber 123456789 --extra string message "Hello mate!"
```
### √â depur√°vel

Um APK de produ√ß√£o nunca deve ser depur√°vel.\
Isso significa que voc√™ pode **anexar um depurador Java** √† aplica√ß√£o em execu√ß√£o, inspecion√°-la em tempo real, definir pontos de interrup√ß√£o, avan√ßar passo a passo, coletar valores de vari√°veis e at√© mesmo alter√°-los. [O InfoSec Institute tem um excelente artigo](../exploiting-a-debuggeable-applciation.md) sobre aprofundamento quando sua aplica√ß√£o √© depur√°vel e injetando c√≥digo em tempo de execu√ß√£o.

Quando uma aplica√ß√£o √© depur√°vel, isso aparecer√° no Manifest:
```html
<application theme="@2131296387" debuggable="true"
```
Voc√™ pode encontrar todos os aplicativos depur√°veis com **Drozer**:
```bash
run app.package.debuggable
```
## Tutoriais

* [https://resources.infosecinstitute.com/android-penetration-tools-walkthrough-series-drozer/#gref](https://resources.infosecinstitute.com/android-penetration-tools-walkthrough-series-drozer/#gref)
* [https://github.com/mgcfish/mobiletools/blob/master/_posts/2016-08-01-Using-Drozer-for-application-security-assessments.md](https://github.com/mgcfish/mobiletools/blob/master/_posts/2016-08-01-Using-Drozer-for-application-security-assessments.md)
* [https://www.hackingarticles.in/android-penetration-testing-drozer/](https://www.hackingarticles.in/android-penetration-testing-drozer/)
* [https://medium.com/@ashrafrizvi3006/how-to-test-android-application-security-using-drozer-edc002c5dcac](https://medium.com/@ashrafrizvi3006/how-to-test-android-application-security-using-drozer-edc002c5dcac)

## Mais informa√ß√µes

* [https://blog.dixitaditya.com/android-pentesting-cheatsheet/](https://blog.dixitaditya.com/android-pentesting-cheatsheet/)

<img src="../../../.gitbook/assets/i3.png" alt="" data-size="original">

**Dica de bug bounty**: **inscreva-se** no **Intigriti**, uma plataforma premium de bug bounty criada por hackers, para hackers! Junte-se a n√≥s em [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) hoje e comece a ganhar recompensas de at√© **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
