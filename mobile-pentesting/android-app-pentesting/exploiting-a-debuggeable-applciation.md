# Explotando una aplicaci√≥n depurable

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos de github.

</details>
{% endhint %}

# **Evitando verificaciones de root y depurables**

Esta secci√≥n de la publicaci√≥n es un resumen de la publicaci√≥n [**https://medium.com/@shubhamsonani/hacking-with-precision-bypass-techniques-via-debugger-in-android-apps-27fd562b2cc0**](https://medium.com/@shubhamsonani/hacking-with-precision-bypass-techniques-via-debugger-in-android-apps-27fd562b2cc0)

## Pasos para hacer que una aplicaci√≥n de Android sea depurable y evitar verificaciones

### **Haciendo la aplicaci√≥n depurable**

Contenido basado en https://medium.com/@shubhamsonani/hacking-with-precision-bypass-techniques-via-debugger-in-android-apps-27fd562b2cc0

1. **Descompilar el APK:**
- Utiliza la herramienta APK-GUI para descompilar el APK.
- En el archivo _android-manifest_, inserta `android:debuggable=true` para habilitar el modo de depuraci√≥n.
- Vuelve a compilar, firmar y zipalign la aplicaci√≥n modificada.

2. **Instalar la aplicaci√≥n modificada:**
- Usa el comando: `adb install <application_name>`.

3. **Recuperar el nombre del paquete:**
- Ejecuta `adb shell pm list packages ‚Äì3` para listar aplicaciones de terceros y encontrar el nombre del paquete.

4. **Configurar la aplicaci√≥n para esperar la conexi√≥n del depurador:**
- Comando: `adb shell am setup-debug-app ‚Äìw <package_name>`.
- **Nota:** Este comando debe ejecutarse cada vez antes de iniciar la aplicaci√≥n para asegurarse de que espera al depurador.
- Para persistencia, usa `adb shell am setup-debug-app ‚Äìw -‚Äìpersistent <package_name>`.
- Para eliminar todas las banderas, usa `adb shell am clear-debug-app <package_name>`.

5. **Preparar para la depuraci√≥n en Android Studio:**
- Navega en Android Studio a _File -> Open Profile or APK_.
- Abre el APK recompilado.

6. **Establecer puntos de interrupci√≥n en archivos Java clave:**
- Coloca puntos de interrupci√≥n en `MainActivity.java` (espec√≠ficamente en el m√©todo `onCreate`), `b.java` y `ContextWrapper.java`.

### **Evitando verificaciones**

La aplicaci√≥n, en ciertos puntos, verificar√° si es depurable y tambi√©n comprobar√° los binarios que indican un dispositivo rooteado. El depurador se puede usar para modificar la informaci√≥n de la aplicaci√≥n, desactivar el bit depurable y alterar los nombres de los binarios buscados para evitar estas verificaciones.

Para la verificaci√≥n depurable:

1. **Modificar la configuraci√≥n de la bandera:**
- En la secci√≥n de variables de la consola del depurador, navega a: `this mLoadedAPK -> mApplicationInfo -> flags = 814267974`.
- **Nota:** La representaci√≥n binaria de `flags = 814267974` es `11000011100111011110`, lo que indica que la "Flag_debuggable" est√° activa.

![https://miro.medium.com/v2/resize:fit:1400/1*-ckiSbWGSoc1beuxxpKbow.png](https://miro.medium.com/v2/resize:fit:1400/1*-ckiSbWGSoc1beuxxpKbow.png)

Estos pasos aseguran colectivamente que la aplicaci√≥n se pueda depurar y que ciertas verificaciones de seguridad se puedan evitar utilizando el depurador, facilitando un an√°lisis o modificaci√≥n m√°s profundo del comportamiento de la aplicaci√≥n.

El paso 2 implica cambiar un valor de bandera a 814267972, que se representa en binario como 110000101101000000100010100.

# **Explotando una vulnerabilidad**

Se proporcion√≥ una demostraci√≥n utilizando una aplicaci√≥n vulnerable que contiene un bot√≥n y un textview. Inicialmente, la aplicaci√≥n muestra "Crack Me". El objetivo es alterar el mensaje de "Try Again" a "Hacked" en tiempo de ejecuci√≥n, sin modificar el c√≥digo fuente.

## **Verificando la vulnerabilidad**
- La aplicaci√≥n fue descompilada usando `apktool` para acceder al archivo `AndroidManifest.xml`.
- La presencia de `android_debuggable="true"` en el AndroidManifest.xml indica que la aplicaci√≥n es depurable y susceptible a explotaci√≥n.
- Vale la pena se√±alar que `apktool` se emplea √∫nicamente para verificar el estado depurable sin alterar ning√∫n c√≥digo.

## **Preparando la configuraci√≥n**
- El proceso implic√≥ iniciar un emulador, instalar la aplicaci√≥n vulnerable y usar `adb jdwp` para identificar los puertos de Dalvik VM que est√°n escuchando.
- El JDWP (Java Debug Wire Protocol) permite depurar una aplicaci√≥n que se ejecuta en una VM al exponer un puerto √∫nico.
- Se necesit√≥ el reenv√≠o de puertos para la depuraci√≥n remota, seguido de la conexi√≥n de JDB a la aplicaci√≥n objetivo.

## **Inyectando c√≥digo en tiempo de ejecuci√≥n**
- La explotaci√≥n se llev√≥ a cabo estableciendo puntos de interrupci√≥n y controlando el flujo de la aplicaci√≥n.
- Se utilizaron comandos como `classes` y `methods <class_name>` para descubrir la estructura de la aplicaci√≥n.
- Se estableci√≥ un punto de interrupci√≥n en el m√©todo `onClick`, y se control√≥ su ejecuci√≥n.
- Se utilizaron los comandos `locals`, `next` y `set` para inspeccionar y modificar variables locales, particularmente cambiando el mensaje "Try Again" a "Hacked".
- El c√≥digo modificado se ejecut√≥ utilizando el comando `run`, alterando con √©xito la salida de la aplicaci√≥n en tiempo real.

Este ejemplo demostr√≥ c√≥mo se puede manipular el comportamiento de una aplicaci√≥n depurable, destacando el potencial para explotaciones m√°s complejas, como obtener acceso a la shell en el dispositivo en el contexto de la aplicaci√≥n.

## Referencias
* [https://medium.com/@shubhamsonani/hacking-with-precision-bypass-techniques-via-debugger-in-android-apps-27fd562b2cc0](https://medium.com/@shubhamsonani/hacking-with-precision-bypass-techniques-via-debugger-in-android-apps-27fd562b2cc0)
* [https://resources.infosecinstitute.com/android-hacking-security-part-6-exploiting-debuggable-android-applications](https://resources.infosecinstitute.com/android-hacking-security-part-6-exploiting-debuggable-android-applications)

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos de github.

</details>
{% endhint %}
