# Installer le certificat Burp

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Vous travaillez dans une **entreprise de cybers√©curit√©** ? Vous souhaitez voir votre **entreprise promue dans HackTricks** ? ou souhaitez-vous acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez**-moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de hacking en soumettant des PR au** [**d√©p√¥t hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**d√©p√¥t hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Sur une machine virtuelle

Tout d'abord, vous devez t√©l√©charger le certificat Der depuis Burp. Vous pouvez le faire dans _**Proxy**_ --> _**Options**_ --> _**Importer / Exporter le certificat CA**_

![](<../../.gitbook/assets/image (367).png>)

**Exportez le certificat au format Der** et transformons-le en un format que **Android** pourra **comprendre**. Notez que **pour configurer le certificat Burp sur la machine Android dans AVD**, vous devez **ex√©cuter** cette machine **avec** l'option **`-writable-system`**.\
Par exemple, vous pouvez l'ex√©cuter comme suit :

{% code overflow="wrap" %}
```bash
C:\Users\<UserName>\AppData\Local\Android\Sdk\tools\emulator.exe -avd "AVD9" -http-proxy 192.168.1.12:8080 -writable-system
```
{% endcode %}

Ensuite, pour **configurer le certificat de Burp, faites** :

{% code overflow="wrap" %}
```bash
openssl x509 -inform DER -in burp_cacert.der -out burp_cacert.pem
CERTHASHNAME="`openssl x509 -inform PEM -subject_hash_old -in burp_cacert.pem | head -1`.0"
mv burp_cacert.pem $CERTHASHNAME #Correct name
adb root && sleep 2 && adb remount #Allow to write on /syste
adb push $CERTHASHNAME /sdcard/ #Upload certificate
adb shell mv /sdcard/$CERTHASHNAME /system/etc/security/cacerts/ #Move to correct location
adb shell chmod 644 /system/etc/security/cacerts/$CERTHASHNAME #Assign privileges
adb reboot #Now, reboot the machine
```
{% endcode %}

Une fois que la **machine a red√©marr√©**, le certificat Burp sera utilis√© par celle-ci !

## Utilisation de Magisc

Si vous avez **root√© votre appareil avec Magisc** (peut-√™tre un √©mulateur), et que vous **ne pouvez pas suivre** les **√©tapes** pr√©c√©dentes pour installer le certificat Burp parce que le **syst√®me de fichiers est en lecture seule** et que vous ne pouvez pas le remonter en √©criture, il existe une autre m√©thode.

Expliqu√©e dans [**cette vid√©o**](https://www.youtube.com/watch?v=qQicUW0svB8), vous devez :

1. **Installer un certificat CA** : Il suffit de **glisser-d√©poser** le certificat Burp DER en **changeant l'extension** en `.crt` sur le mobile pour qu'il soit stock√© dans le dossier T√©l√©chargements et aller dans `Installer un certificat` -> `Certificat CA`

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" width="164"><figcaption></figcaption></figure>

* V√©rifiez que le certificat a √©t√© correctement stock√© en allant dans `Certificats de confiance` -> `UTILISATEUR`

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" width="334"><figcaption></figcaption></figure>

2. **Le rendre de confiance Syst√®me** : T√©l√©chargez le module Magisc [MagiskTrustUserCerts](https://github.com/NVISOsecurity/MagiskTrustUserCerts) (un fichier .zip), **glissez-d√©posez-le** sur le t√©l√©phone, allez dans l'application **Magics** sur le t√©l√©phone dans la section **`Modules`**, cliquez sur **`Installer depuis le stockage`**, s√©lectionnez le module `.zip` et une fois install√©, **red√©marrez** le t√©l√©phone :

<figure><img src="../../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1) (1).png" alt="" width="345"><figcaption></figcaption></figure>

* Apr√®s le red√©marrage, allez dans `Certificats de confiance` -> `SYST√àME` et v√©rifiez que le certificat Postswigger est l√†

<figure><img src="../../.gitbook/assets/image (3) (1) (1) (1).png" alt="" width="314"><figcaption></figcaption></figure>

## Post Android 14

Changements :

* Jusqu'√† pr√©sent, les certificats CA de confiance syst√®me se trouvaient dans **`/system/etc/security/cacerts/`**. Sur un √©mulateur AOSP standard, ceux-ci pouvaient √™tre **modifi√©s directement avec un acc√®s root** avec une configuration minimale, prenant effet **imm√©diatement partout**.
* Dans Android 14, les certificats CA de confiance syst√®me se trouveront g√©n√©ralement dans **`/apex/com.android.conscrypt/cacerts`**, et tout **`/apex` est immuable**.
* Ce chemin **APEX cacerts ne peut pas √™tre remont√© en r√©√©criture** - les remontages √©chouent simplement. En fait, m√™me si vous d√©montez enti√®rement le chemin depuis un shell root, les applications peuvent toujours lire vos certificats sans probl√®me.
* La technique alternative de **montage d'un r√©pertoire tmpfs par-dessus ne fonctionne pas non plus** - m√™me si cela signifie que `ls /apex/com.android.conscrypt/cacerts` pourrait ne rien retourner (ou tout ce que vous voulez), les applications verront toujours les m√™mes donn√©es originales.
* Parce que le montage `/apex` est [explicitement mont√©](https://cs.android.com/android/platform/superproject/main/+/main:system/core/init/mount\_namespace.cpp;l=97;drc=566c65239f1cf3fcb0d8745715e5ef1083d4bd3a) **avec une propagation PRIV√âE**, de sorte que tous les changements de montages √† l'int√©rieur du chemin `/apex` ne sont jamais partag√©s entre les processus.

Cela est fait par le processus `init` qui d√©marre le syst√®me d'exploitation, qui lance ensuite le [processus Zygote](https://en.wikipedia.org/wiki/Booting\_process\_of\_Android\_devices#Zygote) (avec un nouvel espace de montage copi√© du parent, incluant donc son propre montage `/apex` priv√©), qui √† son tour **d√©marre chaque processus d'application** chaque fois qu'une application est lanc√©e sur l'appareil (qui √† leur tour copient ce m√™me montage `/apex` priv√©).

### Remontage r√©cursif des points de montage

* Vous pouvez remonter `/apex` manuellement, en supprimant la propagation PRIV√âE et en le rendant modifiable (ironiquement, il semble que la suppression compl√®te de la propagation priv√©e se propage partout)
* Vous copiez l'int√©gralit√© du contenu de `/apex/com.android.conscrypt` ailleurs
* Ensuite, vous d√©montez compl√®tement `/apex/com.android.conscrypt` - en supprimant le montage en lecture seule qui fournit immuablement ce module
* Ensuite, vous recopiez le contenu, de sorte qu'il vive directement dans le montage `/apex`, o√π il peut √™tre modifi√© (vous devez faire cela rapidement, car [apparemment](https://infosec.exchange/@g1a55er/111069489513139531) vous pouvez voir des plantages sinon)
* Cela devrait prendre effet imm√©diatement, mais ils recommandent de tuer `system_server` (red√©marrant toutes les applications) pour remettre tout dans un √©tat coh√©rent
```bash
# Create a separate temp directory, to hold the current certificates
# Otherwise, when we add the mount we can't read the current certs anymore.
mkdir -p -m 700 /data/local/tmp/tmp-ca-copy

# Copy out the existing certificates
cp /apex/com.android.conscrypt/cacerts/* /data/local/tmp/tmp-ca-copy/

# Create the in-memory mount on top of the system certs folder
mount -t tmpfs tmpfs /system/etc/security/cacerts

# Copy the existing certs back into the tmpfs, so we keep trusting them
mv /data/local/tmp/tmp-ca-copy/* /system/etc/security/cacerts/

# Copy our new cert in, so we trust that too
mv $CERTIFICATE_PATH /system/etc/security/cacerts/

# Update the perms & selinux context labels
chown root:root /system/etc/security/cacerts/*
chmod 644 /system/etc/security/cacerts/*
chcon u:object_r:system_file:s0 /system/etc/security/cacerts/*

# Deal with the APEX overrides, which need injecting into each namespace:

# First we get the Zygote process(es), which launch each app
ZYGOTE_PID=$(pidof zygote || true)
ZYGOTE64_PID=$(pidof zygote64 || true)
# N.b. some devices appear to have both!

# Apps inherit the Zygote's mounts at startup, so we inject here to ensure
# all newly started apps will see these certs straight away:
for Z_PID in "$ZYGOTE_PID" "$ZYGOTE64_PID"; do
if [ -n "$Z_PID" ]; then
nsenter --mount=/proc/$Z_PID/ns/mnt -- \
/bin/mount --bind /system/etc/security/cacerts /apex/com.android.conscrypt/cacerts
fi
done

# Then we inject the mount into all already running apps, so they
# too see these CA certs immediately:

# Get the PID of every process whose parent is one of the Zygotes:
APP_PIDS=$(
echo "$ZYGOTE_PID $ZYGOTE64_PID" | \
xargs -n1 ps -o 'PID' -P | \
grep -v PID
)

# Inject into the mount namespace of each of those apps:
for PID in $APP_PIDS; do
nsenter --mount=/proc/$PID/ns/mnt -- \
/bin/mount --bind /system/etc/security/cacerts /apex/com.android.conscrypt/cacerts &
done
wait # Launched in parallel - wait for completion here

echo "System certificate injected"
```
### Montage en liaison via NSEnter

*   Tout d'abord, nous devons configurer un r√©pertoire accessible en √©criture quelque part. Pour une compatibilit√© facile avec l'approche existante, je fais cela avec un montage `tmpfs` sur le r√©pertoire des certificats syst√®me non-APEX (toujours pr√©sent) :

```bash
mount -t tmpfs tmpfs /system/etc/security/cacerts
```
* Ensuite, vous placez les certificats CA qui vous int√©ressent dans ce r√©pertoire (par exemple, vous pourriez vouloir copier tous les certificats par d√©faut du r√©pertoire existant `/apex/com.android.conscrypt/cacerts/`) et d√©finir les permissions et les √©tiquettes SELinux de mani√®re appropri√©e.
*   Ensuite, utilisez `nsenter` pour entrer dans l'espace de noms de montage du processus Zygote, et montez en liaison ce r√©pertoire sur le r√©pertoire APEX :

```bash
nsenter --mount=/proc/$ZYGOTE_PID/ns/mnt -- \
/bin/mount --bind /system/etc/security/cacerts /apex/com.android.conscrypt/cacerts
```

Le processus Zygote g√©n√®re chaque application, en copiant son espace de noms de montage pour ce faire, ce qui garantit que toutes les applications nouvellement lanc√©es (tout ce qui est d√©marr√© √† partir de maintenant) utiliseront cela.
*   Ensuite, utilisez `nsenter` pour entrer dans l'espace de noms de montage de chaque application d√©j√† en cours d'ex√©cution, et faites de m√™me :

```bash
nsenter --mount=/proc/$APP_PID/ns/mnt -- \
/bin/mount --bind /system/etc/security/cacerts /apex/com.android.conscrypt/cacerts
```

Alternativement, si cela ne vous d√©range pas d'avoir une exp√©rience utilisateur maladroite, vous devriez pouvoir effectuer le montage en liaison sur `init` lui-m√™me (PID 1) puis ex√©cuter `stop && start` pour red√©marrer doucement le syst√®me d'exploitation, en recr√©ant tous les espaces de noms et en propageant vos modifications partout (mais personnellement, le red√©marrage maladroit me d√©range, donc j'ignore compl√®tement cette m√©thode).

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Vous travaillez dans une **entreprise de cybers√©curit√©** ? Vous voulez voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous acc√©der √† la **derni√®re version du PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de hacking en soumettant des PRs au** [**r√©pertoire hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**r√©pertoire hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
