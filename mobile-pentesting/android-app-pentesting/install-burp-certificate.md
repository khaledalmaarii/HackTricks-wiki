# Burp SertifikasÄ±nÄ± YÃ¼kle

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± Ekip UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± Ekip UzmanÄ± (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter**'da **bizi takip edin** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

## Sanal Makinede

Ã–ncelikle Burp'tan Der sertifikasÄ±nÄ± indirmeniz gerekiyor. Bunu _**Proxy**_ --> _**Options**_ --> _**Import / Export CA certificate**_ kÄ±smÄ±ndan yapabilirsiniz.

![](<../../.gitbook/assets/image (367).png>)

**SertifikayÄ± Der formatÄ±nda dÄ±ÅŸa aktarÄ±n** ve **Android**'in **anlayabileceÄŸi** bir forma **dÃ¶nÃ¼ÅŸtÃ¼relim.** **Burp sertifikasÄ±nÄ± AVD'deki Android makinesinde yapÄ±landÄ±rmak iÃ§in** bu makineyi **`-writable-system`** seÃ§eneÄŸi ile **Ã§alÄ±ÅŸtÄ±rmanÄ±z** gerektiÄŸini unutmayÄ±n.\
Ã–rneÄŸin, ÅŸu ÅŸekilde Ã§alÄ±ÅŸtÄ±rabilirsiniz:

{% code overflow="wrap" %}
```bash
C:\Users\<UserName>\AppData\Local\Android\Sdk\tools\emulator.exe -avd "AVD9" -http-proxy 192.168.1.12:8080 -writable-system
```
{% endcode %}

Sonra, **burp sertifikasÄ±nÄ± yapÄ±landÄ±rmak iÃ§in**:

{% code overflow="wrap" %}
```bash
openssl x509 -inform DER -in burp_cacert.der -out burp_cacert.pem
CERTHASHNAME="`openssl x509 -inform PEM -subject_hash_old -in burp_cacert.pem | head -1`.0"
mv burp_cacert.pem $CERTHASHNAME #Correct name
adb root && sleep 2 && adb remount #Allow to write on /syste
adb push $CERTHASHNAME /sdcard/ #Upload certificate
adb shell mv /sdcard/$CERTHASHNAME /system/etc/security/cacerts/ #Move to correct location
adb shell chmod 644 /system/etc/security/cacerts/$CERTHASHNAME #Assign privileges
adb reboot #Now, reboot the machine
```
{% endcode %}

Makine **yeniden baÅŸlatmayÄ± tamamladÄ±ktan sonra** burp sertifikasÄ± kullanÄ±lmaya baÅŸlanacaktÄ±r!

## Magisc KullanÄ±mÄ±

EÄŸer cihazÄ±nÄ±zÄ± **Magisc ile rootladÄ±ysanÄ±z** (belki bir emÃ¼latÃ¶r), ve Burp sertifikasÄ±nÄ± yÃ¼klemek iÃ§in Ã¶nceki **adÄ±mlarÄ±** takip edemiyorsanÄ±z Ã§Ã¼nkÃ¼ **dosya sistemi salt okunur** ve yazÄ±labilir olarak yeniden baÄŸlayamÄ±yorsanÄ±z, baÅŸka bir yol vardÄ±r.

[**Bu videoda**](https://www.youtube.com/watch?v=qQicUW0svB8) aÃ§Ä±klandÄ±ÄŸÄ± gibi:

1. **Bir CA sertifikasÄ± yÃ¼kleyin**: Sadece **sÃ¼rÃ¼kleyip bÄ±rakÄ±n** DER Burp sertifikasÄ±nÄ± **uzantÄ±sÄ±nÄ±** `.crt` olarak deÄŸiÅŸtirerek mobil cihazda Ä°ndirilenler klasÃ¶rÃ¼ne kaydedin ve `Sertifika yÃ¼kle` -> `CA sertifikasÄ±` kÄ±smÄ±na gidin.

<figure><img src="../../.gitbook/assets/image (53).png" alt="" width="164"><figcaption></figcaption></figure>

* SertifikanÄ±n doÄŸru bir ÅŸekilde kaydedildiÄŸini kontrol etmek iÃ§in `GÃ¼venilir kimlik bilgileri` -> `KULLANICI` kÄ±smÄ±na gidin.

<figure><img src="../../.gitbook/assets/image (54).png" alt="" width="334"><figcaption></figcaption></figure>

2. **Sistem gÃ¼venilir hale getirin**: Magisc modÃ¼lÃ¼nÃ¼ [MagiskTrustUserCerts](https://github.com/NVISOsecurity/MagiskTrustUserCerts) (bir .zip dosyasÄ±) indirin, **sÃ¼rÃ¼kleyip bÄ±rakÄ±n** telefonunuza, telefonunuzdaki **Magics uygulamasÄ±na** gidin ve **`ModÃ¼ller`** bÃ¶lÃ¼mÃ¼ne geÃ§in, **`Depodan yÃ¼kle`** seÃ§eneÄŸine tÄ±klayÄ±n, `.zip` modÃ¼lÃ¼nÃ¼ seÃ§in ve yÃ¼klendikten sonra **yeniden baÅŸlatÄ±n**:

<figure><img src="../../.gitbook/assets/image (55).png" alt="" width="345"><figcaption></figcaption></figure>

* Yeniden baÅŸlatmadan sonra, `GÃ¼venilir kimlik bilgileri` -> `SÄ°STEM` kÄ±smÄ±na gidin ve Postswigger sertifikasÄ±nÄ±n orada olduÄŸunu kontrol edin.

<figure><img src="../../.gitbook/assets/image (56).png" alt="" width="314"><figcaption></figcaption></figure>

## Android 14 SonrasÄ±

Son Android 14 sÃ¼rÃ¼mÃ¼nde, sistem gÃ¼venilir Sertifika Otoritesi (CA) sertifikalarÄ±nÄ±n yÃ¶netiminde Ã¶nemli bir deÄŸiÅŸiklik gÃ¶zlemlenmiÅŸtir. Ã–nceden, bu sertifikalar **`/system/etc/security/cacerts/`** dizininde bulunuyordu ve root ayrÄ±calÄ±klarÄ±na sahip kullanÄ±cÄ±lar tarafÄ±ndan eriÅŸilebilir ve deÄŸiÅŸtirilebilir durumdaydÄ±, bu da sistem genelinde anÄ±nda uygulama saÄŸlÄ±yordu. Ancak, Android 14 ile birlikte, depolama yeri **`/apex/com.android.conscrypt/cacerts`** dizinine taÅŸÄ±nmÄ±ÅŸtÄ±r; bu dizin **`/apex`** yolunun iÃ§inde yer almakta olup, doÄŸasÄ± gereÄŸi deÄŸiÅŸtirilemezdir.

**APEX cacerts yolu**'nu yazÄ±labilir olarak yeniden baÄŸlama giriÅŸimleri baÅŸarÄ±sÄ±zlÄ±kla sonuÃ§lanmaktadÄ±r, Ã§Ã¼nkÃ¼ sistem bÃ¶yle iÅŸlemlere izin vermemektedir. GeÃ§ici bir dosya sistemi (tmpfs) ile dizini ayÄ±rma veya Ã¼stÃ¼ne yazma giriÅŸimleri de deÄŸiÅŸtirilemezliÄŸi aÅŸmamaktadÄ±r; uygulamalar dosya sistemi dÃ¼zeyindeki deÄŸiÅŸikliklere bakÄ±lmaksÄ±zÄ±n orijinal sertifika verilerine eriÅŸmeye devam etmektedir. Bu dayanÄ±klÄ±lÄ±k, **`/apex`** montajÄ±nÄ±n Ã–ZEL yayÄ±lma ile yapÄ±landÄ±rÄ±lmasÄ±ndan kaynaklanmaktadÄ±r; bu, **`/apex`** dizinindeki herhangi bir deÄŸiÅŸikliÄŸin diÄŸer sÃ¼reÃ§leri etkilemediÄŸini garanti eder.

Android'in baÅŸlatÄ±lmasÄ±, iÅŸletim sistemini baÅŸlatÄ±rken `init` sÃ¼recini iÃ§erir ve bu sÃ¼reÃ§ aynÄ± zamanda Zygote sÃ¼recini de baÅŸlatÄ±r. Bu sÃ¼reÃ§, Ã¶zel bir **`/apex`** montajÄ±nÄ± iÃ§eren yeni bir montaj ad alanÄ± ile uygulama sÃ¼reÃ§lerini baÅŸlatmaktan sorumludur ve bÃ¶ylece bu dizindeki deÄŸiÅŸikliklerin diÄŸer sÃ¼reÃ§lerden izole edilmesini saÄŸlar.

Yine de, **`/apex`** dizinindeki sistem gÃ¼venilir CA sertifikalarÄ±nÄ± deÄŸiÅŸtirmek isteyenler iÃ§in bir Ã§Ã¶zÃ¼m bulunmaktadÄ±r. Bu, **`/apex`**'i Ã¶zel yayÄ±lmayÄ± kaldÄ±racak ÅŸekilde manuel olarak yeniden baÄŸlamayÄ± iÃ§erir ve bÃ¶ylece yazÄ±labilir hale getirir. SÃ¼reÃ§, **`/apex/com.android.conscrypt`** iÃ§eriÄŸini baÅŸka bir yere kopyalamayÄ±, **`/apex/com.android.conscrypt`** dizinini salt okunur kÄ±sÄ±tlamasÄ±nÄ± ortadan kaldÄ±rmak iÃ§in ayÄ±rmayÄ± ve ardÄ±ndan iÃ§eriÄŸi **`/apex`** iÃ§indeki orijinal konumuna geri yÃ¼klemeyi iÃ§erir. Bu yaklaÅŸÄ±m, sistem Ã§Ã¶kÃ¼ÅŸlerini Ã¶nlemek iÃ§in hÄ±zlÄ± hareket etmeyi gerektirir. Bu deÄŸiÅŸikliklerin sistem genelinde uygulanmasÄ±nÄ± saÄŸlamak iÃ§in, `system_server`'Ä± yeniden baÅŸlatmak Ã¶nerilir; bu, tÃ¼m uygulamalarÄ± etkili bir ÅŸekilde yeniden baÅŸlatÄ±r ve sistemi tutarlÄ± bir duruma getirir.
```bash
# Create a separate temp directory, to hold the current certificates
# Otherwise, when we add the mount we can't read the current certs anymore.
mkdir -p -m 700 /data/local/tmp/tmp-ca-copy

# Copy out the existing certificates
cp /apex/com.android.conscrypt/cacerts/* /data/local/tmp/tmp-ca-copy/

# Create the in-memory mount on top of the system certs folder
mount -t tmpfs tmpfs /system/etc/security/cacerts

# Copy the existing certs back into the tmpfs, so we keep trusting them
mv /data/local/tmp/tmp-ca-copy/* /system/etc/security/cacerts/

# Copy our new cert in, so we trust that too
mv $CERTIFICATE_PATH /system/etc/security/cacerts/

# Update the perms & selinux context labels
chown root:root /system/etc/security/cacerts/*
chmod 644 /system/etc/security/cacerts/*
chcon u:object_r:system_file:s0 /system/etc/security/cacerts/*

# Deal with the APEX overrides, which need injecting into each namespace:

# First we get the Zygote process(es), which launch each app
ZYGOTE_PID=$(pidof zygote || true)
ZYGOTE64_PID=$(pidof zygote64 || true)
# N.b. some devices appear to have both!

# Apps inherit the Zygote's mounts at startup, so we inject here to ensure
# all newly started apps will see these certs straight away:
for Z_PID in "$ZYGOTE_PID" "$ZYGOTE64_PID"; do
if [ -n "$Z_PID" ]; then
nsenter --mount=/proc/$Z_PID/ns/mnt -- \
/bin/mount --bind /system/etc/security/cacerts /apex/com.android.conscrypt/cacerts
fi
done

# Then we inject the mount into all already running apps, so they
# too see these CA certs immediately:

# Get the PID of every process whose parent is one of the Zygotes:
APP_PIDS=$(
echo "$ZYGOTE_PID $ZYGOTE64_PID" | \
xargs -n1 ps -o 'PID' -P | \
grep -v PID
)

# Inject into the mount namespace of each of those apps:
for PID in $APP_PIDS; do
nsenter --mount=/proc/$PID/ns/mnt -- \
/bin/mount --bind /system/etc/security/cacerts /apex/com.android.conscrypt/cacerts &
done
wait # Launched in parallel - wait for completion here

echo "System certificate injected"
```
### Bind-mounting through NSEnter

1. **YazÄ±labilir Bir Dizin Kurma**: Ä°lk olarak, mevcut olmayan APEX sistem sertifika dizininin Ã¼zerine bir `tmpfs` monte edilerek yazÄ±labilir bir dizin oluÅŸturulur. Bu, aÅŸaÄŸÄ±daki komut ile gerÃ§ekleÅŸtirilir:
```bash
mount -t tmpfs tmpfs /system/etc/security/cacerts
```
2. **CA SertifikalarÄ±nÄ± HazÄ±rlama**: YazÄ±labilir dizinin kurulumu sonrasÄ±nda, kullanÄ±lmak istenen CA sertifikalarÄ± bu dizine kopyalanmalÄ±dÄ±r. Bu, `/apex/com.android.conscrypt/cacerts/` dizininden varsayÄ±lan sertifikalarÄ±n kopyalanmasÄ±nÄ± iÃ§erebilir. Bu sertifikalarÄ±n izinlerinin ve SELinux etiketlerinin uygun ÅŸekilde ayarlanmasÄ± Ã¶nemlidir.
3. **Zygote iÃ§in BaÄŸlama MontajÄ±**: `nsenter` kullanarak, Zygote'un montaj ad alanÄ±na girilir. Zygote, Android uygulamalarÄ±nÄ± baÅŸlatmaktan sorumlu olan sÃ¼reÃ§tir ve bundan sonraki tÃ¼m baÅŸlatÄ±lan uygulamalarÄ±n yeni yapÄ±landÄ±rÄ±lmÄ±ÅŸ CA sertifikalarÄ±nÄ± kullanmasÄ±nÄ± saÄŸlamak iÃ§in bu adÄ±m gereklidir. KullanÄ±lan komut:
```bash
nsenter --mount=/proc/$ZYGOTE_PID/ns/mnt -- /bin/mount --bind /system/etc/security/cacerts /apex/com.android.conscrypt/cacerts
```
Bu, baÅŸlatÄ±lan her yeni uygulamanÄ±n gÃ¼ncellenmiÅŸ CA sertifikalarÄ± ayarlarÄ±na uyacaÄŸÄ±nÄ± garanti eder.

4. **Ã‡alÄ±ÅŸan Uygulamalara DeÄŸiÅŸiklik Uygulama**: Zaten Ã§alÄ±ÅŸan uygulamalara deÄŸiÅŸiklikleri uygulamak iÃ§in, `nsenter` tekrar kullanÄ±larak her uygulamanÄ±n ad alanÄ±na ayrÄ± ayrÄ± girilir ve benzer bir baÄŸlama montajÄ± gerÃ§ekleÅŸtirilir. Gerekli komut ÅŸudur:
```bash
nsenter --mount=/proc/$APP_PID/ns/mnt -- /bin/mount --bind /system/etc/security/cacerts /apex/com.android.conscrypt/cacerts
```
5. **Alternatif YaklaÅŸÄ±m - YumuÅŸak Yeniden BaÅŸlatma**: Alternatif bir yÃ¶ntem, `init` sÃ¼recinde (PID 1) bind mount iÅŸlemi gerÃ§ekleÅŸtirmek ve ardÄ±ndan iÅŸletim sistemini `stop && start` komutlarÄ±yla yumuÅŸak bir ÅŸekilde yeniden baÅŸlatmaktÄ±r. Bu yaklaÅŸÄ±m, deÄŸiÅŸikliklerin tÃ¼m ad alanlarÄ±na yayÄ±lmasÄ±nÄ± saÄŸlar ve her bir Ã§alÄ±ÅŸan uygulamayÄ± ayrÄ± ayrÄ± ele alma ihtiyacÄ±nÄ± ortadan kaldÄ±rÄ±r. Ancak, bu yÃ¶ntem genellikle yeniden baÅŸlatmanÄ±n getirdiÄŸi rahatsÄ±zlÄ±k nedeniyle daha az tercih edilmektedir.

## Referanslar

* [https://httptoolkit.com/blog/android-14-install-system-ca-certificate/](https://httptoolkit.com/blog/android-14-install-system-ca-certificate/)

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
