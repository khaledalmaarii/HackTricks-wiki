# å®‰è£…Burpè¯ä¹¦

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## åœ¨è™šæ‹Ÿæœºä¸Š

é¦–å…ˆï¼Œæ‚¨éœ€è¦ä»Burpä¸­ä¸‹è½½Derè¯ä¹¦ã€‚æ‚¨å¯ä»¥åœ¨_**Proxy**_ --> _**Options**_ --> _**Import / Export CA certificate**_ ä¸­æ‰§è¡Œæ­¤æ“ä½œ

![](<../../.gitbook/assets/image (367).png>)

**ä»¥Deræ ¼å¼å¯¼å‡ºè¯ä¹¦**ï¼Œç„¶åå°†å…¶**è½¬æ¢**ä¸º**Android**èƒ½å¤Ÿ**ç†è§£**çš„å½¢å¼ã€‚è¯·æ³¨æ„ï¼Œ**ä¸ºäº†åœ¨AVDä¸­é…ç½®Burpè¯ä¹¦**ï¼Œæ‚¨éœ€è¦ä½¿ç”¨**`-writable-system`**é€‰é¡¹**è¿è¡Œ**æ­¤è™šæ‹Ÿæœºã€‚\
ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥è¿™æ ·è¿è¡Œå®ƒï¼š

{% code overflow="wrap" %}
```bash
C:\Users\<UserName>\AppData\Local\Android\Sdk\tools\emulator.exe -avd "AVD9" -http-proxy 192.168.1.12:8080 -writable-system
```
{% endcode %}

ç„¶åï¼Œ**é…ç½®Burpè¯ä¹¦**ï¼š 

{% code overflow="wrap" %}
```bash
openssl x509 -inform DER -in burp_cacert.der -out burp_cacert.pem
CERTHASHNAME="`openssl x509 -inform PEM -subject_hash_old -in burp_cacert.pem | head -1`.0"
mv burp_cacert.pem $CERTHASHNAME #Correct name
adb root && sleep 2 && adb remount #Allow to write on /syste
adb push $CERTHASHNAME /sdcard/ #Upload certificate
adb shell mv /sdcard/$CERTHASHNAME /system/etc/security/cacerts/ #Move to correct location
adb shell chmod 644 /system/etc/security/cacerts/$CERTHASHNAME #Assign privileges
adb reboot #Now, reboot the machine
```
{% endcode %}

ä¸€æ—¦**æœºå™¨å®Œæˆé‡æ–°å¯åŠ¨**ï¼ŒBurp è¯ä¹¦å°†è¢«å…¶ä½¿ç”¨ï¼

## ä½¿ç”¨ Magisc

å¦‚æœæ‚¨ä½¿ç”¨ Magiscï¼ˆå¯èƒ½æ˜¯æ¨¡æ‹Ÿå™¨ï¼‰**å¯¹è®¾å¤‡è¿›è¡Œäº† root å¤„ç†**ï¼Œå¹¶ä¸”ç”±äº**æ–‡ä»¶ç³»ç»Ÿæ˜¯åªè¯»çš„**ä¸”æ— æ³•å°†å…¶é‡æ–°æŒ‚è½½ä¸ºå¯å†™çŠ¶æ€ï¼Œå› æ­¤æ— æ³•æŒ‰ç…§ä¹‹å‰çš„**æ­¥éª¤**å®‰è£… Burp è¯ä¹¦ï¼Œé‚£ä¹ˆè¿˜æœ‰å¦ä¸€ç§æ–¹æ³•ã€‚

åœ¨[**æ­¤è§†é¢‘**](https://www.youtube.com/watch?v=qQicUW0svB8)ä¸­æœ‰è§£é‡Šï¼Œæ‚¨éœ€è¦ï¼š

1. **å®‰è£… CA è¯ä¹¦**ï¼šåªéœ€å°† DER Burp è¯ä¹¦**æ‹–æ”¾**åˆ°ç§»åŠ¨è®¾å¤‡ä¸Šï¼Œå°†æ‰©å±•åæ›´æ”¹ä¸º`.crt`ï¼Œä»¥ä¾¿å°†å…¶å­˜å‚¨åœ¨ä¸‹è½½æ–‡ä»¶å¤¹ä¸­ï¼Œç„¶åè½¬åˆ°`å®‰è£…è¯ä¹¦` -> `CA è¯ä¹¦`

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" width="164"><figcaption></figcaption></figure>

* æ£€æŸ¥è¯ä¹¦æ˜¯å¦æ­£ç¡®å­˜å‚¨ï¼Œè½¬åˆ°`å—ä¿¡ä»»çš„å‡­æ®` -> `ç”¨æˆ·`

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" width="334"><figcaption></figcaption></figure>

2. **ä½¿å…¶æˆä¸ºç³»ç»Ÿä¿¡ä»»çš„è¯ä¹¦**ï¼šä¸‹è½½ Magisc æ¨¡å—[MagiskTrustUserCerts](https://github.com/NVISOsecurity/MagiskTrustUserCerts)ï¼ˆä¸€ä¸ª.zip æ–‡ä»¶ï¼‰ï¼Œå°†å…¶**æ‹–æ”¾**åˆ°æ‰‹æœºä¸­ï¼Œåœ¨æ‰‹æœºä¸­æ‰“å¼€ Magics åº”ç”¨ç¨‹åºï¼Œè½¬åˆ°**`æ¨¡å—`**éƒ¨åˆ†ï¼Œç‚¹å‡»**`ä»å­˜å‚¨å®‰è£…`**ï¼Œé€‰æ‹©`.zip` æ¨¡å—ï¼Œå®‰è£…å**é‡æ–°å¯åŠ¨**æ‰‹æœºï¼š

<figure><img src="../../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" width="345"><figcaption></figcaption></figure>

* é‡æ–°å¯åŠ¨åï¼Œè½¬åˆ°`å—ä¿¡ä»»çš„å‡­æ®` -> `ç³»ç»Ÿ`ï¼Œæ£€æŸ¥ Postswigger è¯ä¹¦æ˜¯å¦å­˜åœ¨

<figure><img src="../../.gitbook/assets/image (3) (1) (1) (1) (1) (1) (1).png" alt="" width="314"><figcaption></figcaption></figure>

## Android 14 ä¹‹å

åœ¨æœ€æ–°çš„ Android 14 å‘å¸ƒä¸­ï¼Œè§‚å¯Ÿåˆ°äº†ç³»ç»Ÿä¿¡ä»»çš„è¯ä¹¦é¢å‘æœºæ„ï¼ˆCAï¼‰è¯ä¹¦å¤„ç†æ–¹å¼çš„é‡å¤§å˜åŒ–ã€‚ä»¥å‰ï¼Œè¿™äº›è¯ä¹¦å­˜å‚¨åœ¨**`/system/etc/security/cacerts/`**ä¸­ï¼Œå¯ä¾›å…·æœ‰ root æƒé™çš„ç”¨æˆ·è®¿é—®å’Œä¿®æ”¹ï¼Œä»è€Œå¯ä»¥ç«‹å³åº”ç”¨äºæ•´ä¸ªç³»ç»Ÿã€‚ç„¶è€Œï¼Œéšç€ Android 14 çš„æ¨å‡ºï¼Œå­˜å‚¨ä½ç½®å·²ç»ç§»è‡³**`/apex/com.android.conscrypt/cacerts`**ï¼Œè¿™æ˜¯**`/apex`**è·¯å¾„å†…çš„ä¸€ä¸ªç›®å½•ï¼Œå…¶ç‰¹æ€§æ˜¯ä¸å¯å˜çš„ã€‚

å°è¯•å°†**APEX cacerts è·¯å¾„**é‡æ–°æŒ‚è½½ä¸ºå¯å†™ä¼šå¤±è´¥ï¼Œå› ä¸ºç³»ç»Ÿä¸å…è®¸æ­¤ç±»æ“ä½œã€‚å³ä½¿å°è¯•å¸è½½æˆ–ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿï¼ˆtmpfsï¼‰è¦†ç›–è¯¥ç›®å½•ï¼Œä¹Ÿæ— æ³•ç»•è¿‡ä¸å¯å˜æ€§ï¼›åº”ç”¨ç¨‹åºç»§ç»­è®¿é—®åŸå§‹è¯ä¹¦æ•°æ®ï¼Œè€Œä¸è€ƒè™‘æ–‡ä»¶ç³»ç»Ÿçº§åˆ«çš„æ›´æ”¹ã€‚è¿™ç§éŸ§æ€§æ˜¯ç”±äº**`/apex`** æŒ‚è½½é…ç½®ä¸ºç§æœ‰ä¼ æ’­ï¼Œç¡®ä¿**`/apex`** ç›®å½•å†…çš„ä»»ä½•ä¿®æ”¹ä¸ä¼šå½±å“å…¶ä»–è¿›ç¨‹ã€‚

Android çš„åˆå§‹åŒ–æ¶‰åŠ`init` è¿›ç¨‹ï¼Œè¯¥è¿›ç¨‹åœ¨å¯åŠ¨æ“ä½œç³»ç»Ÿæ—¶è¿˜ä¼šå¯åŠ¨ Zygote è¿›ç¨‹ã€‚è¯¥è¿›ç¨‹è´Ÿè´£ä½¿ç”¨åŒ…å«ç§æœ‰**`/apex`** æŒ‚è½½çš„æ–°æŒ‚è½½å‘½åç©ºé—´å¯åŠ¨åº”ç”¨ç¨‹åºè¿›ç¨‹ï¼Œä»è€Œå°†å¯¹è¯¥ç›®å½•çš„æ›´æ”¹ä¸å…¶ä»–è¿›ç¨‹éš”ç¦»å¼€æ¥ã€‚

ç„¶è€Œï¼Œå¯¹äºéœ€è¦ä¿®æ”¹**`/apex`** ç›®å½•å†…ç³»ç»Ÿä¿¡ä»»çš„ CA è¯ä¹¦çš„äººæ¥è¯´ï¼Œå­˜åœ¨ä¸€ç§è§£å†³æ–¹æ³•ã€‚è¿™æ¶‰åŠæ‰‹åŠ¨é‡æ–°æŒ‚è½½**`/apex`** ä»¥å»é™¤ç§æœ‰ä¼ æ’­ï¼Œä»è€Œä½¿å…¶å¯å†™ã€‚è¯¥è¿‡ç¨‹åŒ…æ‹¬å°†**`/apex/com.android.conscrypt`** çš„å†…å®¹å¤åˆ¶åˆ°å¦ä¸€ä¸ªä½ç½®ï¼Œå¸è½½**`/apex/com.android.conscrypt`** ç›®å½•ä»¥æ¶ˆé™¤åªè¯»çº¦æŸï¼Œç„¶åå°†å†…å®¹æ¢å¤åˆ°**`/apex`** çš„åŸå§‹ä½ç½®ã€‚è¿™ç§æ–¹æ³•éœ€è¦è¿…é€Ÿè¡ŒåŠ¨ä»¥é¿å…ç³»ç»Ÿå´©æºƒã€‚ä¸ºäº†ç¡®ä¿è¿™äº›æ›´æ”¹åœ¨æ•´ä¸ªç³»ç»ŸèŒƒå›´å†…åº”ç”¨ï¼Œå»ºè®®é‡æ–°å¯åŠ¨`system_server`ï¼Œè¿™å°†æœ‰æ•ˆåœ°é‡æ–°å¯åŠ¨æ‰€æœ‰åº”ç”¨ç¨‹åºå¹¶ä½¿ç³»ç»Ÿå¤„äºä¸€è‡´çŠ¶æ€ã€‚
```bash
# Create a separate temp directory, to hold the current certificates
# Otherwise, when we add the mount we can't read the current certs anymore.
mkdir -p -m 700 /data/local/tmp/tmp-ca-copy

# Copy out the existing certificates
cp /apex/com.android.conscrypt/cacerts/* /data/local/tmp/tmp-ca-copy/

# Create the in-memory mount on top of the system certs folder
mount -t tmpfs tmpfs /system/etc/security/cacerts

# Copy the existing certs back into the tmpfs, so we keep trusting them
mv /data/local/tmp/tmp-ca-copy/* /system/etc/security/cacerts/

# Copy our new cert in, so we trust that too
mv $CERTIFICATE_PATH /system/etc/security/cacerts/

# Update the perms & selinux context labels
chown root:root /system/etc/security/cacerts/*
chmod 644 /system/etc/security/cacerts/*
chcon u:object_r:system_file:s0 /system/etc/security/cacerts/*

# Deal with the APEX overrides, which need injecting into each namespace:

# First we get the Zygote process(es), which launch each app
ZYGOTE_PID=$(pidof zygote || true)
ZYGOTE64_PID=$(pidof zygote64 || true)
# N.b. some devices appear to have both!

# Apps inherit the Zygote's mounts at startup, so we inject here to ensure
# all newly started apps will see these certs straight away:
for Z_PID in "$ZYGOTE_PID" "$ZYGOTE64_PID"; do
if [ -n "$Z_PID" ]; then
nsenter --mount=/proc/$Z_PID/ns/mnt -- \
/bin/mount --bind /system/etc/security/cacerts /apex/com.android.conscrypt/cacerts
fi
done

# Then we inject the mount into all already running apps, so they
# too see these CA certs immediately:

# Get the PID of every process whose parent is one of the Zygotes:
APP_PIDS=$(
echo "$ZYGOTE_PID $ZYGOTE64_PID" | \
xargs -n1 ps -o 'PID' -P | \
grep -v PID
)

# Inject into the mount namespace of each of those apps:
for PID in $APP_PIDS; do
nsenter --mount=/proc/$PID/ns/mnt -- \
/bin/mount --bind /system/etc/security/cacerts /apex/com.android.conscrypt/cacerts &
done
wait # Launched in parallel - wait for completion here

echo "System certificate injected"
```
### é€šè¿‡ NSEnter è¿›è¡Œç»‘å®šæŒ‚è½½

1. **è®¾ç½®å¯å†™ç›®å½•**ï¼šé¦–å…ˆï¼Œé€šè¿‡åœ¨ç°æœ‰é APEX ç³»ç»Ÿè¯ä¹¦ç›®å½•ä¸ŠæŒ‚è½½ `tmpfs` æ¥å»ºç«‹ä¸€ä¸ªå¯å†™ç›®å½•ã€‚ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å®ç°ï¼š
```bash
mount -t tmpfs tmpfs /system/etc/security/cacerts
```
2. **å‡†å¤‡ CA è¯ä¹¦**ï¼šåœ¨è®¾ç½®å¯å†™ç›®å½•ä¹‹åï¼Œåº”å°†æ‰“ç®—ä½¿ç”¨çš„ CA è¯ä¹¦å¤åˆ¶åˆ°è¯¥ç›®å½•ä¸­ã€‚è¿™å¯èƒ½æ¶‰åŠä» `/apex/com.android.conscrypt/cacerts/` å¤åˆ¶é»˜è®¤è¯ä¹¦ã€‚å¿…é¡»ç›¸åº”åœ°è°ƒæ•´è¿™äº›è¯ä¹¦çš„æƒé™å’Œ SELinux æ ‡ç­¾ã€‚
3. **ä¸º Zygote è¿›è¡Œç»‘å®šæŒ‚è½½**ï¼šåˆ©ç”¨ `nsenter`ï¼Œè¿›å…¥ Zygote çš„æŒ‚è½½å‘½åç©ºé—´ã€‚Zygote æ˜¯è´Ÿè´£å¯åŠ¨ Android åº”ç”¨ç¨‹åºçš„è¿›ç¨‹ï¼Œéœ€è¦æ‰§è¡Œæ­¤æ­¥éª¤ä»¥ç¡®ä¿æ­¤åå¯åŠ¨çš„æ‰€æœ‰åº”ç”¨ç¨‹åºéƒ½ä½¿ç”¨æ–°é…ç½®çš„ CA è¯ä¹¦ã€‚ä½¿ç”¨çš„å‘½ä»¤å¦‚ä¸‹ï¼š
```bash
nsenter --mount=/proc/$ZYGOTE_PID/ns/mnt -- /bin/mount --bind /system/etc/security/cacerts /apex/com.android.conscrypt/cacerts
```
è¿™å°†ç¡®ä¿æ¯ä¸ªæ–°å¯åŠ¨çš„åº”ç”¨ç¨‹åºéƒ½éµå®ˆæ›´æ–°åçš„ CA è¯ä¹¦è®¾ç½®ã€‚

4. **å°†æ›´æ”¹åº”ç”¨äºæ­£åœ¨è¿è¡Œçš„åº”ç”¨ç¨‹åº**ï¼šè¦å°†æ›´æ”¹åº”ç”¨äºå·²ç»è¿è¡Œçš„åº”ç”¨ç¨‹åºï¼Œå†æ¬¡ä½¿ç”¨ `nsenter` é€ä¸ªè¿›å…¥æ¯ä¸ªåº”ç”¨ç¨‹åºçš„å‘½åç©ºé—´ï¼Œå¹¶æ‰§è¡Œç±»ä¼¼çš„ç»‘å®šæŒ‚è½½ã€‚å¿…è¦çš„å‘½ä»¤æ˜¯ï¼š
```bash
nsenter --mount=/proc/$APP_PID/ns/mnt -- /bin/mount --bind /system/etc/security/cacerts /apex/com.android.conscrypt/cacerts
```
5. **æ›¿ä»£æ–¹æ³• - è½¯é‡å¯**ï¼šå¦ä¸€ç§æ–¹æ³•æ¶‰åŠåœ¨`init`è¿›ç¨‹ï¼ˆPID 1ï¼‰ä¸Šæ‰§è¡Œç»‘å®šæŒ‚è½½ï¼Œç„¶åä½¿ç”¨`stop && start`å‘½ä»¤å¯¹æ“ä½œç³»ç»Ÿè¿›è¡Œè½¯é‡å¯ã€‚è¿™ç§æ–¹æ³•å°†åœ¨æ‰€æœ‰å‘½åç©ºé—´ä¸­ä¼ æ’­æ›´æ”¹ï¼Œé¿å…äº†éœ€è¦å•ç‹¬å¤„ç†æ¯ä¸ªè¿è¡Œä¸­åº”ç”¨ç¨‹åºçš„éœ€æ±‚ã€‚ç„¶è€Œï¼Œç”±äºé‡æ–°å¯åŠ¨çš„ä¸ä¾¿ï¼Œé€šå¸¸è¾ƒå°‘é€‰æ‹©æ­¤æ–¹æ³•ã€‚

## å‚è€ƒ

* [https://httptoolkit.com/blog/android-14-install-system-ca-certificate/](https://httptoolkit.com/blog/android-14-install-system-ca-certificate/)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
