# Installer le certificat Burp

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

## Sur une machine virtuelle

Tout d'abord, vous devez t√©l√©charger le certificat Der de Burp. Vous pouvez le faire dans _**Proxy**_ --> _**Options**_ --> _**Importer / Exporter le certificat CA**_

![](<../../.gitbook/assets/image (367).png>)

**Exportez le certificat au format Der** et **transformons-le** en une forme que **Android** pourra **comprendre.** Notez que **pour configurer le certificat burp sur la machine Android dans AVD**, vous devez **ex√©cuter** cette machine **avec** l'option **`-writable-system`**.\
Par exemple, vous pouvez l'ex√©cuter comme : 

{% code overflow="wrap" %}
```bash
C:\Users\<UserName>\AppData\Local\Android\Sdk\tools\emulator.exe -avd "AVD9" -http-proxy 192.168.1.12:8080 -writable-system
```
{% endcode %}

Ensuite, pour **configurer le certificat de burp** :

{% code overflow="wrap" %}
```bash
openssl x509 -inform DER -in burp_cacert.der -out burp_cacert.pem
CERTHASHNAME="`openssl x509 -inform PEM -subject_hash_old -in burp_cacert.pem | head -1`.0"
mv burp_cacert.pem $CERTHASHNAME #Correct name
adb root && sleep 2 && adb remount #Allow to write on /syste
adb push $CERTHASHNAME /sdcard/ #Upload certificate
adb shell mv /sdcard/$CERTHASHNAME /system/etc/security/cacerts/ #Move to correct location
adb shell chmod 644 /system/etc/security/cacerts/$CERTHASHNAME #Assign privileges
adb reboot #Now, reboot the machine
```
{% endcode %}

Une fois que la **machine a fini de red√©marrer**, le certificat burp sera en cours d'utilisation par elle !

## Utiliser Magisc

Si vous **avez root√© votre appareil avec Magisc** (peut-√™tre un √©mulateur), et que vous **ne pouvez pas suivre** les **√©tapes** pr√©c√©dentes pour installer le certificat Burp parce que le **syst√®me de fichiers est en lecture seule** et que vous ne pouvez pas le remonter en √©criture, il existe une autre m√©thode.

Expliqu√© dans [**cette vid√©o**](https://www.youtube.com/watch?v=qQicUW0svB8), vous devez :

1. **Installer un certificat CA** : Il suffit de **glisser-d√©poser** le certificat Burp DER **en changeant l'extension** en `.crt` sur le mobile afin qu'il soit stock√© dans le dossier T√©l√©chargements et d'aller √† `Installer un certificat` -> `Certificat CA`

<figure><img src="../../.gitbook/assets/image (53).png" alt="" width="164"><figcaption></figcaption></figure>

* V√©rifiez que le certificat a √©t√© correctement stock√© en allant √† `Informations d'identification de confiance` -> `UTILISATEUR`

<figure><img src="../../.gitbook/assets/image (54).png" alt="" width="334"><figcaption></figcaption></figure>

2. **Le rendre de confiance pour le syst√®me** : T√©l√©chargez le module Magisc [MagiskTrustUserCerts](https://github.com/NVISOsecurity/MagiskTrustUserCerts) (un fichier .zip), **glissez-d√©posez-le** dans le t√©l√©phone, allez √† l'application **Magics** sur le t√©l√©phone dans la section **`Modules`**, cliquez sur **`Installer depuis le stockage`**, s√©lectionnez le module `.zip` et une fois install√©, **red√©marrez** le t√©l√©phone :

<figure><img src="../../.gitbook/assets/image (55).png" alt="" width="345"><figcaption></figcaption></figure>

* Apr√®s le red√©marrage, allez √† `Informations d'identification de confiance` -> `SYST√àME` et v√©rifiez que le certificat Postswigger est l√†

<figure><img src="../../.gitbook/assets/image (56).png" alt="" width="314"><figcaption></figcaption></figure>

## Post Android 14

Dans la derni√®re version d'Android 14, un changement significatif a √©t√© observ√© dans la gestion des certificats d'autorit√© de certification (CA) de confiance par le syst√®me. Auparavant, ces certificats √©taient log√©s dans **`/system/etc/security/cacerts/`**, accessibles et modifiables par les utilisateurs ayant des privil√®ges root, ce qui permettait une application imm√©diate √† travers le syst√®me. Cependant, avec Android 14, l'emplacement de stockage a √©t√© d√©plac√© vers **`/apex/com.android.conscrypt/cacerts`**, un r√©pertoire dans le chemin **`/apex`**, qui est immuable par nature.

Les tentatives de remonter le **chemin APEX cacerts** en √©criture √©chouent, car le syst√®me n'autorise pas de telles op√©rations. M√™me les tentatives de d√©monter ou de superposer le r√©pertoire avec un syst√®me de fichiers temporaire (tmpfs) ne contournent pas l'immuabilit√© ; les applications continuent d'acc√©der aux donn√©es de certificat originales, quelles que soient les modifications au niveau du syst√®me de fichiers. Cette r√©silience est due au montage **`/apex`** √©tant configur√© avec une propagation PRIV√âE, garantissant que toute modification dans le r√©pertoire **`/apex`** n'affecte pas d'autres processus.

L'initialisation d'Android implique le processus `init`, qui, lors du d√©marrage du syst√®me d'exploitation, initie √©galement le processus Zygote. Ce processus est responsable du lancement des processus d'application avec un nouvel espace de montage qui inclut un montage **`/apex`** priv√©, isolant ainsi les modifications apport√©es √† ce r√©pertoire des autres processus.

N√©anmoins, une solution de contournement existe pour ceux qui ont besoin de modifier les certificats CA de confiance pour le syst√®me dans le r√©pertoire **`/apex`**. Cela implique de remonter manuellement **`/apex`** pour supprimer la propagation PRIV√âE, le rendant ainsi √©crivable. Le processus comprend la copie du contenu de **`/apex/com.android.conscrypt`** vers un autre emplacement, le d√©montage du r√©pertoire **`/apex/com.android.conscrypt`** pour √©liminer la contrainte de lecture seule, puis la restauration du contenu √† son emplacement d'origine dans **`/apex`**. Cette approche n√©cessite une action rapide pour √©viter les plantages du syst√®me. Pour garantir l'application syst√©mique de ces modifications, il est recommand√© de red√©marrer le `system_server`, ce qui red√©marre effectivement toutes les applications et ram√®ne le syst√®me √† un √©tat coh√©rent.
```bash
# Create a separate temp directory, to hold the current certificates
# Otherwise, when we add the mount we can't read the current certs anymore.
mkdir -p -m 700 /data/local/tmp/tmp-ca-copy

# Copy out the existing certificates
cp /apex/com.android.conscrypt/cacerts/* /data/local/tmp/tmp-ca-copy/

# Create the in-memory mount on top of the system certs folder
mount -t tmpfs tmpfs /system/etc/security/cacerts

# Copy the existing certs back into the tmpfs, so we keep trusting them
mv /data/local/tmp/tmp-ca-copy/* /system/etc/security/cacerts/

# Copy our new cert in, so we trust that too
mv $CERTIFICATE_PATH /system/etc/security/cacerts/

# Update the perms & selinux context labels
chown root:root /system/etc/security/cacerts/*
chmod 644 /system/etc/security/cacerts/*
chcon u:object_r:system_file:s0 /system/etc/security/cacerts/*

# Deal with the APEX overrides, which need injecting into each namespace:

# First we get the Zygote process(es), which launch each app
ZYGOTE_PID=$(pidof zygote || true)
ZYGOTE64_PID=$(pidof zygote64 || true)
# N.b. some devices appear to have both!

# Apps inherit the Zygote's mounts at startup, so we inject here to ensure
# all newly started apps will see these certs straight away:
for Z_PID in "$ZYGOTE_PID" "$ZYGOTE64_PID"; do
if [ -n "$Z_PID" ]; then
nsenter --mount=/proc/$Z_PID/ns/mnt -- \
/bin/mount --bind /system/etc/security/cacerts /apex/com.android.conscrypt/cacerts
fi
done

# Then we inject the mount into all already running apps, so they
# too see these CA certs immediately:

# Get the PID of every process whose parent is one of the Zygotes:
APP_PIDS=$(
echo "$ZYGOTE_PID $ZYGOTE64_PID" | \
xargs -n1 ps -o 'PID' -P | \
grep -v PID
)

# Inject into the mount namespace of each of those apps:
for PID in $APP_PIDS; do
nsenter --mount=/proc/$PID/ns/mnt -- \
/bin/mount --bind /system/etc/security/cacerts /apex/com.android.conscrypt/cacerts &
done
wait # Launched in parallel - wait for completion here

echo "System certificate injected"
```
### Bind-mounting through NSEnter

1. **Configuration d'un r√©pertoire √©crivable** : Initialement, un r√©pertoire √©crivable est √©tabli en montant un `tmpfs` sur le r√©pertoire de certificats syst√®me non-APEX existant. Cela est r√©alis√© avec la commande suivante :
```bash
mount -t tmpfs tmpfs /system/etc/security/cacerts
```
2. **Pr√©paration des certificats CA** : Apr√®s la configuration du r√©pertoire accessible en √©criture, les certificats CA que l'on souhaite utiliser doivent √™tre copi√©s dans ce r√©pertoire. Cela peut impliquer de copier les certificats par d√©faut depuis `/apex/com.android.conscrypt/cacerts/`. Il est essentiel d'ajuster les permissions et les √©tiquettes SELinux de ces certificats en cons√©quence.  
3. **Montage li√© pour Zygote** : En utilisant `nsenter`, on entre dans l'espace de noms de montage de Zygote. Zygote, √©tant le processus responsable du lancement des applications Android, n√©cessite cette √©tape pour s'assurer que toutes les applications lanc√©es par la suite utilisent les certificats CA nouvellement configur√©s. La commande utilis√©e est :
```bash
nsenter --mount=/proc/$ZYGOTE_PID/ns/mnt -- /bin/mount --bind /system/etc/security/cacerts /apex/com.android.conscrypt/cacerts
```
Cela garantit que chaque nouvelle application d√©marr√©e respectera la configuration mise √† jour des certificats CA.

4. **Appliquer les modifications aux applications en cours d'ex√©cution** : Pour appliquer les modifications aux applications d√©j√† en cours d'ex√©cution, `nsenter` est √† nouveau utilis√© pour entrer dans l'espace de noms de chaque application individuellement et effectuer un montage de liaison similaire. La commande n√©cessaire est :
```bash
nsenter --mount=/proc/$APP_PID/ns/mnt -- /bin/mount --bind /system/etc/security/cacerts /apex/com.android.conscrypt/cacerts
```
5. **Approche alternative - Red√©marrage doux** : Une m√©thode alternative consiste √† effectuer le montage de liaison sur le processus `init` (PID 1) suivi d'un red√©marrage doux du syst√®me d'exploitation avec les commandes `stop && start`. Cette approche propagerait les changements √† travers tous les espaces de noms, √©vitant ainsi la n√©cessit√© de s'adresser individuellement √† chaque application en cours d'ex√©cution. Cependant, cette m√©thode est g√©n√©ralement moins pr√©f√©r√©e en raison de l'inconv√©nient du red√©marrage.

## R√©f√©rences

* [https://httptoolkit.com/blog/android-14-install-system-ca-certificate/](https://httptoolkit.com/blog/android-14-install-system-ca-certificate/)

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
