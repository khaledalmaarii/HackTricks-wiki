# Burp SertifikasÄ±nÄ± YÃ¼kle

<details>

<summary><strong>SÄ±fÄ±rdan ileri seviye AWS hackleme becerilerini Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> ile!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ±zÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuzu
* **KatÄ±lÄ±n** ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)'da **takip edin**.
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR'lar gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>

## Sanal Makinede

Ä°lk olarak, Burp'tan Der sertifikasÄ±nÄ± indirmeniz gerekmektedir. Bunun iÃ§in _**Proxy**_ --> _**Options**_ --> _**Import / Export CA certificate**_ adÄ±mlarÄ±nÄ± izleyebilirsiniz.

![](<../../.gitbook/assets/image (367).png>)

**SertifikayÄ± Der formatÄ±nda dÄ±ÅŸa aktarÄ±n** ve **Android'in anlayabileceÄŸi bir forma dÃ¶nÃ¼ÅŸtÃ¼relim.** **AVD'deki Android makinesinde burp sertifikasÄ±nÄ± yapÄ±landÄ±rmak iÃ§in** bu makineyi **`-writable-system`** seÃ§eneÄŸiyle **Ã§alÄ±ÅŸtÄ±rmanÄ±z gerekmektedir.**\
Ã–rneÄŸin ÅŸu ÅŸekilde Ã§alÄ±ÅŸtÄ±rabilirsiniz:

{% code overflow="wrap" %}
```bash
C:\Users\<UserName>\AppData\Local\Android\Sdk\tools\emulator.exe -avd "AVD9" -http-proxy 192.168.1.12:8080 -writable-system
```
{% endcode %}

ArdÄ±ndan, **burp sertifikasÄ±nÄ± yapÄ±landÄ±rmak iÃ§in ÅŸunlarÄ± yapÄ±n**:

{% code overflow="wrap" %}
```bash
openssl x509 -inform DER -in burp_cacert.der -out burp_cacert.pem
CERTHASHNAME="`openssl x509 -inform PEM -subject_hash_old -in burp_cacert.pem | head -1`.0"
mv burp_cacert.pem $CERTHASHNAME #Correct name
adb root && sleep 2 && adb remount #Allow to write on /syste
adb push $CERTHASHNAME /sdcard/ #Upload certificate
adb shell mv /sdcard/$CERTHASHNAME /system/etc/security/cacerts/ #Move to correct location
adb shell chmod 644 /system/etc/security/cacerts/$CERTHASHNAME #Assign privileges
adb reboot #Now, reboot the machine
```
{% endcode %}

**Makine yeniden baÅŸlatÄ±ldÄ±ÄŸÄ±nda**, burp sertifikasÄ± tarafÄ±ndan kullanÄ±lacaktÄ±r!

## Magisc KullanÄ±mÄ±

EÄŸer cihazÄ±nÄ±zÄ± Magisc ile rootladÄ±ysanÄ±z (belki bir emÃ¼latÃ¶r), ve **dosya sistemi salt okunur olduÄŸu iÃ§in** Burp sertifikasÄ±nÄ± yÃ¼klemek iÃ§in Ã¶nceki adÄ±mlarÄ± takip edemiyorsanÄ±z, baÅŸka bir yol bulunmaktadÄ±r.

[**Bu video**](https://www.youtube.com/watch?v=qQicUW0svB8)da aÃ§Ä±klandÄ±ÄŸÄ± gibi ÅŸunlarÄ± yapmanÄ±z gerekmektedir:

1. **Bir CA sertifikasÄ± yÃ¼kleyin**: DER Burp sertifikasÄ±nÄ± `.crt` uzantÄ±sÄ±na **deÄŸiÅŸtirerek** mobil cihaza sÃ¼rÃ¼kleyip bÄ±rakÄ±n, bÃ¶ylece Ä°ndirilenler klasÃ¶rÃ¼nde saklanÄ±r ve `Sertifika yÃ¼kle` -> `CA sertifikasÄ±`'na gidin

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" width="164"><figcaption></figcaption></figure>

* SertifikanÄ±n doÄŸru bir ÅŸekilde saklandÄ±ÄŸÄ±nÄ± kontrol edin, `GÃ¼venilir kimlik bilgileri` -> `KULLANICI`'ya gidin

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" width="334"><figcaption></figcaption></figure>

2. **Sistemde gÃ¼venilir hale getirin**: Magisc modÃ¼lÃ¼nÃ¼ [MagiskTrustUserCerts](https://github.com/NVISOsecurity/MagiskTrustUserCerts) (bir .zip dosyasÄ±) indirin, telefonunuza sÃ¼rÃ¼kleyip bÄ±rakÄ±n, telefonda **Magics uygulamasÄ±na** gidin, **`ModÃ¼ller`** bÃ¶lÃ¼mÃ¼ne gidin, **`Depodan yÃ¼kle`**'yi tÄ±klayÄ±n, `.zip` modÃ¼lÃ¼nÃ¼ seÃ§in ve kurulum tamamlandÄ±ktan sonra telefonu **yeniden baÅŸlatÄ±n**:

<figure><img src="../../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" width="345"><figcaption></figcaption></figure>

* Yeniden baÅŸlatÄ±ldÄ±ktan sonra, `GÃ¼venilir kimlik bilgileri` -> `SÄ°STEM`'e gidin ve Postswigger sertifikasÄ±nÄ±n orada olduÄŸunu kontrol edin

<figure><img src="../../.gitbook/assets/image (3) (1) (1) (1) (1) (1) (1) (1).png" alt="" width="314"><figcaption></figcaption></figure>

## Android 14 SonrasÄ±

En son Android 14 sÃ¼rÃ¼mÃ¼nde, sistem-gÃ¼venilir Sertifika Yetkilisi (CA) sertifikalarÄ±nÄ±n iÅŸleniÅŸinde Ã¶nemli bir deÄŸiÅŸiklik gÃ¶zlemlenmiÅŸtir. Ã–nceden, bu sertifikalar **`/system/etc/security/cacerts/`** dizininde bulunur ve kÃ¶k ayrÄ±calÄ±klarÄ±na sahip kullanÄ±cÄ±lar tarafÄ±ndan eriÅŸilebilir ve deÄŸiÅŸtirilebilirdi, bu da sisteme hemen uygulanmasÄ±na olanak tanÄ±rdÄ±. Ancak, Android 14 ile, depolama yeri **`/apex/com.android.conscrypt/cacerts`** olarak deÄŸiÅŸtirilmiÅŸtir, bu da doÄŸasÄ± gereÄŸi deÄŸiÅŸtirilemez olan **`/apex`** yolundaki bir dizindir.

**APEX cacerts yolunu** yazÄ±labilir hale getirmeye yÃ¶nelik giriÅŸimler baÅŸarÄ±sÄ±zlÄ±kla karÅŸÄ±laÅŸÄ±r, Ã§Ã¼nkÃ¼ sistem bu tÃ¼r iÅŸlemlere izin vermez. Dizin Ã¼zerine geÃ§ici bir dosya sistemi (tmpfs) ile aÅŸma veya kaldÄ±rma giriÅŸimleri bile deÄŸiÅŸtirilemezliÄŸi atlatmaz; uygulamalar, dosya sistemi seviyesinde yapÄ±lan deÄŸiÅŸikliklere raÄŸmen orijinal sertifika verilerine eriÅŸmeye devam eder. Bu direnÃ§, **`/apex`** baÄŸÄ±nÄ±n Ã–ZEL yayÄ±lma ile yapÄ±landÄ±rÄ±lmÄ±ÅŸ olmasÄ±ndan kaynaklanmaktadÄ±r, bu da **`/apex`** dizinindeki deÄŸiÅŸikliklerin diÄŸer iÅŸlemleri etkilememesini saÄŸlar.

Android'in baÅŸlatÄ±lmasÄ±, iÅŸletim sistemini baÅŸlatÄ±rken aynÄ± zamanda Zygote iÅŸlemini baÅŸlatan `init` iÅŸlemiyle baÅŸlar. Bu iÅŸlem, yeni bir baÄŸlama ad alanÄ± iÃ§eren Zygote iÅŸlemini baÅŸlatarak uygulama iÅŸlemlerini baÅŸlatma sorumluluÄŸunu Ã¼stlenir, bu da bu dizindeki deÄŸiÅŸiklikleri diÄŸer iÅŸlemlerden izole eder.

Yine de, **`/apex`** dizinindeki sistem-gÃ¼venilir CA sertifikalarÄ±nÄ± deÄŸiÅŸtirmek isteyenler iÃ§in bir Ã§Ã¶zÃ¼m bulunmaktadÄ±r. Bu, **`/apex`**'i Ã¶zel yayÄ±lmasÄ±nÄ± kaldÄ±rarak yazÄ±labilir hale getirmek iÃ§in manuel olarak yeniden baÄŸlamayÄ± iÃ§erir. Bu sÃ¼reÃ§, **`/apex/com.android.conscrypt`** iÃ§eriÄŸini baÅŸka bir konuma kopyalamayÄ±, **`/apex/com.android.conscrypt`** dizinini baÄŸlamayÄ± kaldÄ±rmayÄ± ve ardÄ±ndan iÃ§eriÄŸi orijinal konumlarÄ±na **`/apex`** iÃ§inde geri yÃ¼klemeyi gerektirir. Bu yaklaÅŸÄ±m, sistem Ã§Ã¶kmelerini Ã¶nlemek iÃ§in hÄ±zlÄ± bir ÅŸekilde hareket etmeyi gerektirir. Bu deÄŸiÅŸikliklerin sistem genelinde uygulanmasÄ±nÄ± saÄŸlamak iÃ§in `system_server`'Ä± yeniden baÅŸlatmanÄ±z Ã¶nerilir, bu da tÃ¼m uygulamalarÄ± yeniden baÅŸlatÄ±r ve sistemi tutarlÄ± bir duruma getirir.
```bash
# Create a separate temp directory, to hold the current certificates
# Otherwise, when we add the mount we can't read the current certs anymore.
mkdir -p -m 700 /data/local/tmp/tmp-ca-copy

# Copy out the existing certificates
cp /apex/com.android.conscrypt/cacerts/* /data/local/tmp/tmp-ca-copy/

# Create the in-memory mount on top of the system certs folder
mount -t tmpfs tmpfs /system/etc/security/cacerts

# Copy the existing certs back into the tmpfs, so we keep trusting them
mv /data/local/tmp/tmp-ca-copy/* /system/etc/security/cacerts/

# Copy our new cert in, so we trust that too
mv $CERTIFICATE_PATH /system/etc/security/cacerts/

# Update the perms & selinux context labels
chown root:root /system/etc/security/cacerts/*
chmod 644 /system/etc/security/cacerts/*
chcon u:object_r:system_file:s0 /system/etc/security/cacerts/*

# Deal with the APEX overrides, which need injecting into each namespace:

# First we get the Zygote process(es), which launch each app
ZYGOTE_PID=$(pidof zygote || true)
ZYGOTE64_PID=$(pidof zygote64 || true)
# N.b. some devices appear to have both!

# Apps inherit the Zygote's mounts at startup, so we inject here to ensure
# all newly started apps will see these certs straight away:
for Z_PID in "$ZYGOTE_PID" "$ZYGOTE64_PID"; do
if [ -n "$Z_PID" ]; then
nsenter --mount=/proc/$Z_PID/ns/mnt -- \
/bin/mount --bind /system/etc/security/cacerts /apex/com.android.conscrypt/cacerts
fi
done

# Then we inject the mount into all already running apps, so they
# too see these CA certs immediately:

# Get the PID of every process whose parent is one of the Zygotes:
APP_PIDS=$(
echo "$ZYGOTE_PID $ZYGOTE64_PID" | \
xargs -n1 ps -o 'PID' -P | \
grep -v PID
)

# Inject into the mount namespace of each of those apps:
for PID in $APP_PIDS; do
nsenter --mount=/proc/$PID/ns/mnt -- \
/bin/mount --bind /system/etc/security/cacerts /apex/com.android.conscrypt/cacerts &
done
wait # Launched in parallel - wait for completion here

echo "System certificate injected"
```
### NSEnter Ã¼zerinden Bind-mounting

1. **YazÄ±labilir Bir Dizin OluÅŸturma**: Ä°lk olarak, mevcut olmayan APEX olmayan sistem sertifika dizininin Ã¼zerine bir `tmpfs` baÄŸlanarak yazÄ±labilir bir dizin oluÅŸturulur. Bu, aÅŸaÄŸÄ±daki komutla gerÃ§ekleÅŸtirilir:
```bash
mount -t tmpfs tmpfs /system/etc/security/cacerts
```
2. **CA SertifikalarÄ±nÄ± HazÄ±rlama**: YazÄ±labilir dizinin kurulumunu takiben, kullanmayÄ± amaÃ§ladÄ±ÄŸÄ±nÄ±z CA sertifikalarÄ± bu dizine kopyalanmalÄ±dÄ±r. Bu, varsayÄ±lan sertifikalarÄ±n `/apex/com.android.conscrypt/cacerts/` dizininden kopyalanmasÄ±nÄ± gerektirebilir. Bu sertifikalarÄ±n izinleri ve SELinux etiketleri uygun ÅŸekilde ayarlanmasÄ± Ã¶nemlidir.
3. **Zygote Ä°Ã§in BaÄŸlama BaÄŸlama**: `nsenter` kullanÄ±larak, Zygote'un baÄŸlama ad alanÄ±na girilir. Android uygulamalarÄ±nÄ± baÅŸlatmakla sorumlu olan Zygote, bundan sonra baÅŸlatÄ±lan tÃ¼m uygulamalarÄ±n yeni yapÄ±landÄ±rÄ±lmÄ±ÅŸ CA sertifikalarÄ±nÄ± kullanmasÄ±nÄ± saÄŸlamak iÃ§in bu adÄ±mÄ± gerektirir. KullanÄ±lan komut ÅŸudur:
```bash
nsenter --mount=/proc/$ZYGOTE_PID/ns/mnt -- /bin/mount --bind /system/etc/security/cacerts /apex/com.android.conscrypt/cacerts
```
Bu, her yeni uygulamanÄ±n gÃ¼ncellenmiÅŸ CA sertifikalarÄ± kurulumuna uyacaÄŸÄ±nÄ± saÄŸlar.

4. **Ã‡alÄ±ÅŸan Uygulamalara DeÄŸiÅŸiklikler Uygulama**: Zaten Ã§alÄ±ÅŸan uygulamalara deÄŸiÅŸiklikleri uygulamak iÃ§in, `nsenter` tekrar kullanÄ±larak her uygulamanÄ±n ad alanÄ±na bireysel olarak girilir ve benzer bir baÄŸlama iÅŸlemi gerÃ§ekleÅŸtirilir. Gerekli komut ÅŸudur:
```bash
nsenter --mount=/proc/$APP_PID/ns/mnt -- /bin/mount --bind /system/etc/security/cacerts /apex/com.android.conscrypt/cacerts
```
5. **Alternatif YaklaÅŸÄ±m - YumuÅŸak Yeniden BaÅŸlatma**: Alternatif bir yÃ¶ntem, `init` iÅŸlemine (PID 1) baÄŸlama iÅŸlemini gerÃ§ekleÅŸtirmeyi ve iÅŸletim sistemini `stop && start` komutlarÄ±yla yumuÅŸak bir ÅŸekilde yeniden baÅŸlatmayÄ± iÃ§erir. Bu yaklaÅŸÄ±m, deÄŸiÅŸikliklerin tÃ¼m ad alanlarÄ±na yayÄ±lmasÄ±nÄ± saÄŸlayacak ve her Ã§alÄ±ÅŸan uygulamayÄ± tek tek ele almaya gerek kalmayacaktÄ±r. Bununla birlikte, bu yÃ¶ntem genellikle yeniden baÅŸlatmanÄ±n rahatsÄ±zlÄ±ÄŸÄ± nedeniyle tercih edilmemektedir.

## Referanslar

* [https://httptoolkit.com/blog/android-14-install-system-ca-certificate/](https://httptoolkit.com/blog/android-14-install-system-ca-certificate/)
