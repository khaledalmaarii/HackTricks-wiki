# å®‰è£… Burp è¯ä¹¦

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* å¦‚æœæ‚¨åœ¨**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œï¼Ÿæ‚¨æƒ³åœ¨**HackTricks**ä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…æ‚¨æƒ³è¦è®¿é—®**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½HackTricksçš„PDF**ï¼ŸæŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)ç³»åˆ—
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹å•†å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**telegramç¾¤ç»„**](https://t.me/peass)æˆ–åœ¨**Twitter**ä¸Š**å…³æ³¨**æˆ‘[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **é€šè¿‡å‘**[**hacktricksä»“åº“**](https://github.com/carlospolop/hacktricks) **å’Œ** [**hacktricks-cloudä»“åº“**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## åœ¨è™šæ‹Ÿæœºä¸Š

é¦–å…ˆï¼Œæ‚¨éœ€è¦ä»Burpä¸‹è½½Derè¯ä¹¦ã€‚æ‚¨å¯ä»¥åœ¨ _**Proxy**_ --> _**Options**_ --> _**Import / Export CA certificate**_ ä¸­è¿›è¡Œä¸‹è½½ã€‚

![](<../../.gitbook/assets/image (367).png>)

**ä»¥Deræ ¼å¼å¯¼å‡ºè¯ä¹¦**ï¼Œç„¶åå°†å…¶**è½¬æ¢**ä¸º**Android**èƒ½å¤Ÿ**ç†è§£**çš„æ ¼å¼ã€‚è¯·æ³¨æ„ï¼Œ**ä¸ºäº†åœ¨AVDä¸­çš„Androidæœºå™¨ä¸Šé…ç½®burpè¯ä¹¦**ï¼Œæ‚¨éœ€è¦ä½¿ç”¨**`-writable-system`**é€‰é¡¹**è¿è¡Œ**æ­¤æœºå™¨ã€‚\
ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥è¿™æ ·è¿è¡Œå®ƒï¼š

{% code overflow="wrap" %}
```bash
C:\Users\<UserName>\AppData\Local\Android\Sdk\tools\emulator.exe -avd "AVD9" -http-proxy 192.168.1.12:8080 -writable-system
```
{% endcode %}

ç„¶åï¼Œè¦**é…ç½® burp è¯ä¹¦ï¼Œè¯·æ‰§è¡Œ**ï¼š

{% code overflow="wrap" %}
```bash
openssl x509 -inform DER -in burp_cacert.der -out burp_cacert.pem
CERTHASHNAME="`openssl x509 -inform PEM -subject_hash_old -in burp_cacert.pem | head -1`.0"
mv burp_cacert.pem $CERTHASHNAME #Correct name
adb root && sleep 2 && adb remount #Allow to write on /syste
adb push $CERTHASHNAME /sdcard/ #Upload certificate
adb shell mv /sdcard/$CERTHASHNAME /system/etc/security/cacerts/ #Move to correct location
adb shell chmod 644 /system/etc/security/cacerts/$CERTHASHNAME #Assign privileges
adb reboot #Now, reboot the machine
```
{% endcode %}

ä¸€æ—¦**æœºå™¨å®Œæˆé‡å¯**ï¼Œburpè¯ä¹¦å°†è¢«å…¶ä½¿ç”¨ï¼

## ä½¿ç”¨Magisc

å¦‚æœæ‚¨**ä½¿ç”¨Magiscå¯¹è®¾å¤‡è¿›è¡Œäº†root**ï¼ˆå¯èƒ½æ˜¯æ¨¡æ‹Ÿå™¨ï¼‰ï¼Œå¹¶ä¸”æ‚¨**æ— æ³•æŒ‰ç…§**å‰é¢çš„**æ­¥éª¤**å®‰è£…Burpè¯ä¹¦ï¼Œå› ä¸º**æ–‡ä»¶ç³»ç»Ÿæ˜¯åªè¯»çš„**å¹¶ä¸”æ‚¨æ— æ³•é‡æ–°æŒ‚è½½ä¸ºå¯å†™ï¼Œè¿˜æœ‰å¦ä¸€ç§æ–¹æ³•ã€‚

å¦‚[**æ­¤è§†é¢‘**](https://www.youtube.com/watch?v=qQicUW0svB8)æ‰€è§£é‡Šï¼Œæ‚¨éœ€è¦ï¼š

1. **å®‰è£…CAè¯ä¹¦**ï¼šåªéœ€å°†DER Burpè¯ä¹¦**æ‹–æ”¾**å¹¶**æ›´æ”¹æ‰©å±•å**ä¸º`.crt`åˆ°æ‰‹æœºä¸­ï¼Œè¿™æ ·å®ƒå°±å­˜å‚¨åœ¨ä¸‹è½½æ–‡ä»¶å¤¹ä¸­ï¼Œç„¶åè½¬åˆ°`å®‰è£…è¯ä¹¦` -> `CAè¯ä¹¦`

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" width="164"><figcaption></figcaption></figure>

* æ£€æŸ¥è¯ä¹¦æ˜¯å¦å·²æ­£ç¡®å­˜å‚¨ï¼Œè½¬åˆ°`å—ä¿¡ä»»çš„å‡­æ®` -> `USER`

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" width="334"><figcaption></figcaption></figure>

2. **ä½¿å…¶æˆä¸ºç³»ç»Ÿä¿¡ä»»**ï¼šä¸‹è½½Magiscæ¨¡å—[MagiskTrustUserCerts](https://github.com/NVISOsecurity/MagiskTrustUserCerts)ï¼ˆä¸€ä¸ª.zipæ–‡ä»¶ï¼‰ï¼Œ**æ‹–æ”¾**åˆ°æ‰‹æœºä¸­ï¼Œè½¬åˆ°æ‰‹æœºä¸­çš„**Magicsåº”ç”¨**çš„**`Modules`**éƒ¨åˆ†ï¼Œç‚¹å‡»**`ä»å­˜å‚¨å®‰è£…`**ï¼Œé€‰æ‹©`.zip`æ¨¡å—å¹¶å®‰è£…å**é‡å¯**æ‰‹æœºï¼š

<figure><img src="../../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1) (1).png" alt="" width="345"><figcaption></figcaption></figure>

* é‡å¯åï¼Œè½¬åˆ°`å—ä¿¡ä»»çš„å‡­æ®` -> `SYSTEM`å¹¶æ£€æŸ¥Postswiggerè¯ä¹¦æ˜¯å¦åœ¨é‚£é‡Œ

<figure><img src="../../.gitbook/assets/image (3) (1) (1) (1).png" alt="" width="314"><figcaption></figcaption></figure>

## Android 14ä¹‹å

å˜åŒ–ï¼š

* ç›®å‰ä¸ºæ­¢ï¼Œç³»ç»Ÿä¿¡ä»»çš„CAè¯ä¹¦ä½äº**`/system/etc/security/cacerts/`**ã€‚åœ¨æ ‡å‡†çš„AOSPæ¨¡æ‹Ÿå™¨ä¸Šï¼Œè¿™äº›å¯ä»¥é€šè¿‡æœ€å°è®¾ç½®**ç›´æ¥é€šè¿‡rootè®¿é—®è¿›è¡Œä¿®æ”¹**ï¼Œç«‹å³åœ¨**æ‰€æœ‰åœ°æ–¹ç”Ÿæ•ˆ**ã€‚
* åœ¨Android 14ä¸­ï¼Œç³»ç»Ÿä¿¡ä»»çš„CAè¯ä¹¦é€šå¸¸ä½äº**`/apex/com.android.conscrypt/cacerts`**ï¼Œå¹¶ä¸”æ‰€æœ‰çš„**`/apex`éƒ½æ˜¯ä¸å¯å˜çš„**ã€‚
* **APEX cacertsè·¯å¾„æ— æ³•é‡æ–°æŒ‚è½½ä¸ºå¯å†™** - é‡æ–°æŒ‚è½½ç®€å•åœ°å¤±è´¥ã€‚å®é™…ä¸Šï¼Œå³ä½¿æ‚¨ä»root shellå¸è½½æ•´ä¸ªè·¯å¾„ï¼Œåº”ç”¨ç¨‹åºä»ç„¶å¯ä»¥å¾ˆå¥½åœ°è¯»å–æ‚¨çš„è¯ä¹¦ã€‚
* **åœ¨é¡¶éƒ¨æŒ‚è½½tmpfsç›®å½•çš„æ›¿ä»£æŠ€æœ¯ä¹Ÿä¸èµ·ä½œç”¨** - å³ä½¿è¿™æ„å‘³ç€`ls /apex/com.android.conscrypt/cacerts`å¯èƒ½ä»€ä¹ˆéƒ½ä¸è¿”å›ï¼ˆæˆ–è€…æ‚¨å–œæ¬¢çš„ä»»ä½•å…¶ä»–å†…å®¹ï¼‰ï¼Œåº”ç”¨ç¨‹åºä»ç„¶ä¼šçœ‹åˆ°ç›¸åŒçš„åŸå§‹æ•°æ®ã€‚
* å› ä¸º`/apex`æŒ‚è½½æ˜¯[æ˜ç¡®æŒ‚è½½](https://cs.android.com/android/platform/superproject/main/+/main:system/core/init/mount\_namespace.cpp;l=97;drc=566c65239f1cf3fcb0d8745715e5ef1083d4bd3a) **å…·æœ‰PRIVATEä¼ æ’­**ï¼Œä»¥ä¾¿åœ¨`/apex`è·¯å¾„å†…çš„æ‰€æœ‰æŒ‚è½½æ›´æ”¹éƒ½ä¸ä¼šåœ¨è¿›ç¨‹ä¹‹é—´å…±äº«ã€‚

è¿™æ˜¯ç”±å¯åŠ¨æ“ä½œç³»ç»Ÿçš„`init`è¿›ç¨‹å®Œæˆçš„ï¼Œç„¶åå®ƒå¯åŠ¨[Zygoteè¿›ç¨‹](https://en.wikipedia.org/wiki/Booting\_process\_of\_Android\_devices#Zygote)ï¼ˆä»çˆ¶è¿›ç¨‹å¤åˆ¶äº†ä¸€ä¸ªæ–°çš„æŒ‚è½½å‘½åç©ºé—´ï¼Œå› æ­¤åŒ…æ‹¬å…¶**è‡ªå·±çš„ç§æœ‰`/apex`æŒ‚è½½**ï¼‰ï¼Œç„¶ååè¿‡æ¥**å¯åŠ¨æ¯ä¸ªåº”ç”¨è¿›ç¨‹**ï¼Œæ¯å½“è®¾å¤‡ä¸Šå¯åŠ¨åº”ç”¨æ—¶ï¼ˆä»–ä»¬æ¯ä¸ªäººåè¿‡æ¥åˆ**å¤åˆ¶äº†åŒæ ·çš„ç§æœ‰`/apex`æŒ‚è½½**ï¼‰ã€‚

### é€’å½’é‡æ–°æŒ‚è½½æŒ‚è½½ç‚¹

* æ‚¨å¯ä»¥æ‰‹åŠ¨é‡æ–°æŒ‚è½½`/apex`ï¼Œç§»é™¤PRIVATEä¼ æ’­å¹¶ä½¿å…¶å¯å†™ï¼ˆè®½åˆºçš„æ˜¯ï¼Œå®Œå…¨ç§»é™¤ç§æœ‰ä¼ æ’­ä¼¼ä¹_ç¡®å®_åˆ°å¤„ä¼ æ’­ï¼‰
* æ‚¨å°†`/apex/com.android.conscrypt`çš„å…¨éƒ¨å†…å®¹å¤åˆ¶åˆ°å…¶ä»–åœ°æ–¹
* ç„¶åæ‚¨å®Œå…¨å¸è½½`/apex/com.android.conscrypt` - ç§»é™¤ä¸å¯å˜åœ°æä¾›æ­¤æ¨¡å—çš„åªè¯»æŒ‚è½½
* ç„¶åæ‚¨å°†å†…å®¹å¤åˆ¶å›æ¥ï¼Œä½¿å…¶ç›´æ¥ç”Ÿæ´»åœ¨`/apex`æŒ‚è½½ä¸­ï¼Œå¯ä»¥è¿›è¡Œä¿®æ”¹ï¼ˆæ‚¨éœ€è¦å¿«é€Ÿå®Œæˆæ­¤æ“ä½œï¼Œå› ä¸º[æ˜¾ç„¶](https://infosec.exchange/@g1a55er/111069489513139531)æ‚¨å¯ä»¥çœ‹åˆ°å´©æºƒï¼‰
* è¿™åº”è¯¥ç«‹å³ç”Ÿæ•ˆï¼Œä½†ä»–ä»¬å»ºè®®æ€æ­»`system_server`ï¼ˆé‡æ–°å¯åŠ¨æ‰€æœ‰åº”ç”¨ç¨‹åºï¼‰ä»¥ä½¿ä¸€åˆ‡æ¢å¤åˆ°ä¸€è‡´çŠ¶æ€
```bash
# Create a separate temp directory, to hold the current certificates
# Otherwise, when we add the mount we can't read the current certs anymore.
mkdir -p -m 700 /data/local/tmp/tmp-ca-copy

# Copy out the existing certificates
cp /apex/com.android.conscrypt/cacerts/* /data/local/tmp/tmp-ca-copy/

# Create the in-memory mount on top of the system certs folder
mount -t tmpfs tmpfs /system/etc/security/cacerts

# Copy the existing certs back into the tmpfs, so we keep trusting them
mv /data/local/tmp/tmp-ca-copy/* /system/etc/security/cacerts/

# Copy our new cert in, so we trust that too
mv $CERTIFICATE_PATH /system/etc/security/cacerts/

# Update the perms & selinux context labels
chown root:root /system/etc/security/cacerts/*
chmod 644 /system/etc/security/cacerts/*
chcon u:object_r:system_file:s0 /system/etc/security/cacerts/*

# Deal with the APEX overrides, which need injecting into each namespace:

# First we get the Zygote process(es), which launch each app
ZYGOTE_PID=$(pidof zygote || true)
ZYGOTE64_PID=$(pidof zygote64 || true)
# N.b. some devices appear to have both!

# Apps inherit the Zygote's mounts at startup, so we inject here to ensure
# all newly started apps will see these certs straight away:
for Z_PID in "$ZYGOTE_PID" "$ZYGOTE64_PID"; do
if [ -n "$Z_PID" ]; then
nsenter --mount=/proc/$Z_PID/ns/mnt -- \
/bin/mount --bind /system/etc/security/cacerts /apex/com.android.conscrypt/cacerts
fi
done

# Then we inject the mount into all already running apps, so they
# too see these CA certs immediately:

# Get the PID of every process whose parent is one of the Zygotes:
APP_PIDS=$(
echo "$ZYGOTE_PID $ZYGOTE64_PID" | \
xargs -n1 ps -o 'PID' -P | \
grep -v PID
)

# Inject into the mount namespace of each of those apps:
for PID in $APP_PIDS; do
nsenter --mount=/proc/$PID/ns/mnt -- \
/bin/mount --bind /system/etc/security/cacerts /apex/com.android.conscrypt/cacerts &
done
wait # Launched in parallel - wait for completion here

echo "System certificate injected"
```
### é€šè¿‡ NSEnter ç»‘å®šæŒ‚è½½

*   é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åœ¨æŸå¤„è®¾ç½®ä¸€ä¸ªå¯å†™ç›®å½•ã€‚ä¸ºäº†ä¸ç°æœ‰æ–¹æ³•å…¼å®¹ï¼Œæˆ‘ä½¿ç”¨ `tmpfs` æŒ‚è½½è¦†ç›–äº†ï¼ˆä»ç„¶å­˜åœ¨çš„ï¼‰é APEX ç³»ç»Ÿè¯ä¹¦ç›®å½•ï¼š

```bash
mount -t tmpfs tmpfs /system/etc/security/cacerts
```
* ç„¶åå°†æ‚¨æ„Ÿå…´è¶£çš„ CA è¯ä¹¦æ”¾å…¥æ­¤ç›®å½•ä¸­ï¼ˆä¾‹å¦‚ï¼Œæ‚¨å¯èƒ½æƒ³ä»ç°æœ‰çš„ `/apex/com.android.conscrypt/cacerts/` CA è¯ä¹¦ç›®å½•ä¸­å¤åˆ¶æ‰€æœ‰é»˜è®¤å€¼ï¼‰ï¼Œå¹¶é€‚å½“è®¾ç½®æƒé™å’Œ SELinux æ ‡ç­¾ã€‚
*   æ¥ç€ï¼Œä½¿ç”¨ `nsenter` è¿›å…¥ Zygote çš„æŒ‚è½½å‘½åç©ºé—´ï¼Œå¹¶å°†æ­¤ç›®å½•ç»‘å®šæŒ‚è½½åˆ° APEX ç›®å½•ä¸Šï¼š

```bash
nsenter --mount=/proc/$ZYGOTE_PID/ns/mnt -- \
/bin/mount --bind /system/etc/security/cacerts /apex/com.android.conscrypt/cacerts
```

Zygote è¿›ç¨‹ç”Ÿæˆæ¯ä¸ªåº”ç”¨ç¨‹åºï¼Œå¤åˆ¶å…¶æŒ‚è½½å‘½åç©ºé—´ä»¥æ­¤è¿›è¡Œï¼Œå› æ­¤è¿™ç¡®ä¿äº†æ‰€æœ‰æ–°å¯åŠ¨çš„åº”ç”¨ç¨‹åºï¼ˆä»ç°åœ¨å¼€å§‹å¯åŠ¨çš„æ‰€æœ‰åº”ç”¨ç¨‹åºï¼‰éƒ½å°†ä½¿ç”¨è¿™ä¸ªã€‚
*   ç„¶åï¼Œä½¿ç”¨ `nsenter` è¿›å…¥æ¯ä¸ªå·²ç»è¿è¡Œçš„åº”ç”¨ç¨‹åºçš„å‘½åç©ºé—´ï¼Œå¹¶æ‰§è¡Œç›¸åŒçš„æ“ä½œï¼š

```bash
nsenter --mount=/proc/$APP_PID/ns/mnt -- \
/bin/mount --bind /system/etc/security/cacerts /apex/com.android.conscrypt/cacerts
```

æˆ–è€…ï¼Œå¦‚æœæ‚¨ä¸ä»‹æ„ç¬¨æ‹™çš„ç”¨æˆ·ä½“éªŒï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿåœ¨ `init` æœ¬èº«ï¼ˆPID 1ï¼‰ä¸Šè¿›è¡Œç»‘å®šæŒ‚è½½ï¼Œç„¶åè¿è¡Œ `stop && start` æ¥è½¯é‡å¯æ“ä½œç³»ç»Ÿï¼Œé‡æ–°åˆ›å»ºæ‰€æœ‰å‘½åç©ºé—´å¹¶ä¼ æ’­æ‚¨çš„æ›´æ”¹åˆ°å¤„ï¼ˆä½†æˆ‘ä¸ªäººç¡®å®ä»‹æ„ç¬¨æ‹™çš„é‡å¯ï¼Œæ‰€ä»¥æˆ‘å®Œå…¨å¿½ç•¥äº†é‚£æ¡è·¯çº¿ï¼‰ã€‚

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* æ‚¨åœ¨**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿæ‚¨æƒ³åœ¨ **HackTricks** ä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…æ‚¨æƒ³è¦è®¿é—®**æœ€æ–°ç‰ˆæœ¬çš„ PEASS æˆ–ä¸‹è½½ HackTricks çš„ PDF**ï¼ŸæŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)ç³»åˆ—
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* **åŠ å…¥** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ä¸Š**å…³æ³¨**æˆ‘ [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* é€šè¿‡å‘ [**hacktricks ä»“åº“**](https://github.com/carlospolop/hacktricks) å’Œ [**hacktricks-cloud ä»“åº“**](https://github.com/carlospolop/hacktricks-cloud) æäº¤ PR æ¥**åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§**ã€‚

</details>
