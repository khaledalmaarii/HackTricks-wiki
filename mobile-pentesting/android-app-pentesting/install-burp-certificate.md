# Burp SertifikasÄ± YÃ¼kleme

<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan kahraman seviyesine Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **reklamÄ±nÄ±zÄ± gÃ¶rmek** veya **HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)'u **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na **PR gÃ¶ndererek paylaÅŸÄ±n**.

</details>

## Sanal Makine Ãœzerinde

Ä°lk olarak, Burp'tan Der sertifikasÄ±nÄ± indirmeniz gerekmektedir. Bunun iÃ§in _**Proxy**_ --> _**Options**_ --> _**Import / Export CA certificate**_ yolunu izleyebilirsiniz.

![](<../../.gitbook/assets/image (367).png>)

SertifikayÄ± **Der formatÄ±nda dÄ±ÅŸa aktarÄ±n** ve **Android'in anlayabileceÄŸi bir formata dÃ¶nÃ¼ÅŸtÃ¼relim**. **AVD'deki Android makinesinde burp sertifikasÄ±nÄ± yapÄ±landÄ±rmak iÃ§in** bu makineyi **`-writable-system`** seÃ§eneÄŸiyle **Ã§alÄ±ÅŸtÄ±rmanÄ±z gerekmektedir**. Ã–rneÄŸin, ÅŸu ÅŸekilde Ã§alÄ±ÅŸtÄ±rabilirsiniz:

{% code overflow="wrap" %}
```bash
C:\Users\<UserName>\AppData\Local\Android\Sdk\tools\emulator.exe -avd "AVD9" -http-proxy 192.168.1.12:8080 -writable-system
```
{% endcode %}

ArdÄ±ndan, **burp sertifikasÄ±nÄ± yapÄ±landÄ±rmak iÃ§in** ÅŸunlarÄ± yapÄ±n:

{% code overflow="wrap" %}
```bash
openssl x509 -inform DER -in burp_cacert.der -out burp_cacert.pem
CERTHASHNAME="`openssl x509 -inform PEM -subject_hash_old -in burp_cacert.pem | head -1`.0"
mv burp_cacert.pem $CERTHASHNAME #Correct name
adb root && sleep 2 && adb remount #Allow to write on /syste
adb push $CERTHASHNAME /sdcard/ #Upload certificate
adb shell mv /sdcard/$CERTHASHNAME /system/etc/security/cacerts/ #Move to correct location
adb shell chmod 644 /system/etc/security/cacerts/$CERTHASHNAME #Assign privileges
adb reboot #Now, reboot the machine
```
{% endcode %}

Makine yeniden baÅŸlatÄ±ldÄ±ÄŸÄ±nda burp sertifikasÄ± kullanÄ±mda olacak!

## Magisc Kullanma

EÄŸer cihazÄ±nÄ±zÄ± Magisc ile rootladÄ±ysanÄ±z (belki bir emÃ¼latÃ¶r), ve Ã¶nceki adÄ±mlarÄ± takip edemiyorsanÄ±z Ã§Ã¼nkÃ¼ dosya sistemi salt okunurdur ve yazÄ±labilir olarak yeniden baÄŸlanamaz, baÅŸka bir yol vardÄ±r.

[**Bu videoda**](https://www.youtube.com/watch?v=qQicUW0svB8) aÃ§Ä±klandÄ±ÄŸÄ± gibi yapmanÄ±z gerekenler:

1. **Bir CA sertifikasÄ± yÃ¼kleyin**: DER Burp sertifikasÄ±nÄ± `.crt` uzantÄ±sÄ±na dÃ¶nÃ¼ÅŸtÃ¼rerek mobil cihaza **sÃ¼rÃ¼kleyip bÄ±rakÄ±n**, bÃ¶ylece indirilenler klasÃ¶rÃ¼nde saklanÄ±r ve `Bir sertifika yÃ¼kle` -> `CA sertifikasÄ±`'na gidin.

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" width="164"><figcaption></figcaption></figure>

* SertifikanÄ±n doÄŸru bir ÅŸekilde saklandÄ±ÄŸÄ±nÄ± kontrol edin, `GÃ¼venilen kimlik bilgileri` -> `KULLANICI`'ya gidin.

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" width="334"><figcaption></figcaption></figure>

2. **Sistem gÃ¼venilir yapÄ±n**: Magisc modÃ¼lÃ¼nÃ¼ [MagiskTrustUserCerts](https://github.com/NVISOsecurity/MagiskTrustUserCerts) (bir .zip dosyasÄ±) indirin, telefonunuza **sÃ¼rÃ¼kleyip bÄ±rakÄ±n**, telefondaki **Magics uygulamasÄ±na** gidin, **`ModÃ¼ller`** bÃ¶lÃ¼mÃ¼ne gidin, **`Depodan yÃ¼kle`**'yi tÄ±klayÄ±n, `.zip` modÃ¼lÃ¼nÃ¼ seÃ§in ve kurulum tamamlandÄ±ktan sonra telefonu **yeniden baÅŸlatÄ±n**:

<figure><img src="../../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" width="345"><figcaption></figcaption></figure>

* Yeniden baÅŸlattÄ±ktan sonra, `GÃ¼venilen kimlik bilgileri` -> `SÄ°STEM`'e gidin ve Postswigger sertifikasÄ±nÄ±n orada olduÄŸunu kontrol edin.

<figure><img src="../../.gitbook/assets/image (3) (1) (1) (1) (1) (1).png" alt="" width="314"><figcaption></figcaption></figure>

## Android 14 SonrasÄ±

En son Android 14 sÃ¼rÃ¼mÃ¼nde, sistem tarafÄ±ndan gÃ¼venilen Sertifika Yetkilisi (CA) sertifikalarÄ±nÄ±n iÅŸlenmesinde Ã¶nemli bir deÄŸiÅŸiklik gÃ¶zlemlenmiÅŸtir. Ã–nceden, bu sertifikalar **`/system/etc/security/cacerts/`** dizininde bulunur ve kÃ¶k ayrÄ±calÄ±klarÄ±na sahip kullanÄ±cÄ±lar tarafÄ±ndan eriÅŸilebilir ve deÄŸiÅŸtirilebilirlerdi, bu da sisteme hemen uygulanmasÄ±na olanak saÄŸlardÄ±. Ancak, Android 14 ile birlikte depolama konumu **`/apex/com.android.conscrypt/cacerts`** olarak deÄŸiÅŸtirilmiÅŸtir, bu da doÄŸasÄ± gereÄŸi deÄŸiÅŸtirilemez olan **`/apex`** yolunun iÃ§indeki bir dizindir.

**APEX cacerts yolunu** yazÄ±labilir olarak yeniden baÄŸlama giriÅŸimleri baÅŸarÄ±sÄ±zlÄ±kla karÅŸÄ±lanÄ±r, Ã§Ã¼nkÃ¼ sistem bÃ¶yle iÅŸlemlere izin vermez. Hatta geÃ§ici bir dosya sistemi (tmpfs) ile dizini ayrÄ± baÄŸlamaya veya Ã¼zerine bindirmeye yÃ¶nelik giriÅŸimler bile deÄŸiÅŸtirilemezliÄŸi atlatmaz; uygulamalar, dosya sistemi dÃ¼zeyinde yapÄ±lan deÄŸiÅŸikliklere bakÄ±lmaksÄ±zÄ±n orijinal sertifika verilerine eriÅŸmeye devam eder. Bu direnÃ§, **`/apex`** baÄŸÄ±nÄ±n Ã–ZEL yayÄ±lÄ±m ile yapÄ±landÄ±rÄ±lmÄ±ÅŸ olmasÄ±ndan kaynaklanÄ±r, bu da **`/apex`** dizini iÃ§indeki deÄŸiÅŸikliklerin diÄŸer iÅŸlemleri etkilemediÄŸini saÄŸlar.

Android'in baÅŸlatÄ±lmasÄ±, iÅŸletim sistemini baÅŸlatan `init` iÅŸlemiyle baÅŸlar ve aynÄ± zamanda Zygote iÅŸlemini baÅŸlatÄ±r. Bu iÅŸlem, bu dizinin diÄŸer iÅŸlemlerden izole edilmesini saÄŸlayan yeni bir baÄŸlama ad alanÄ±yla uygulama iÅŸlemlerini baÅŸlatma sorumluluÄŸunu Ã¼stlenir.

Yine de, **`/apex`** dizini iÃ§indeki sistem tarafÄ±ndan gÃ¼venilen CA sertifikalarÄ±nÄ± deÄŸiÅŸtirmek isteyenler iÃ§in bir Ã§Ã¶zÃ¼m bulunmaktadÄ±r. Bu, **`/apex`**'i Ã¶zel yayÄ±lÄ±mÄ± kaldÄ±rmak iÃ§in manuel olarak yeniden baÄŸlamayÄ± iÃ§erir, bÃ¶ylece yazÄ±labilir hale getirilir. Bu sÃ¼reÃ§, **`/apex/com.android.conscrypt`** iÃ§eriÄŸini baÅŸka bir konuma kopyalamayÄ±, **`/apex/com.android.conscrypt`** dizinini salt okunur kÄ±sÄ±tlamasÄ±nÄ± kaldÄ±rmak iÃ§in baÄŸlantÄ±sÄ±nÄ± kesmeyi ve ardÄ±ndan iÃ§eriÄŸi **`/apex`** iÃ§indeki orijinal konumuna geri yÃ¼klemeyi iÃ§erir. Bu yaklaÅŸÄ±m, sistem Ã§Ã¶kmelerini Ã¶nlemek iÃ§in hÄ±zlÄ± hareket gerektirir. Bu deÄŸiÅŸikliklerin sistem genelinde uygulanmasÄ±nÄ± saÄŸlamak iÃ§in `system_server`'Ä± yeniden baÅŸlatmanÄ±z Ã¶nerilir, bu da tÃ¼m uygulamalarÄ± yeniden baÅŸlatÄ±r ve sistemi tutarlÄ± bir duruma getirir.
```bash
# Create a separate temp directory, to hold the current certificates
# Otherwise, when we add the mount we can't read the current certs anymore.
mkdir -p -m 700 /data/local/tmp/tmp-ca-copy

# Copy out the existing certificates
cp /apex/com.android.conscrypt/cacerts/* /data/local/tmp/tmp-ca-copy/

# Create the in-memory mount on top of the system certs folder
mount -t tmpfs tmpfs /system/etc/security/cacerts

# Copy the existing certs back into the tmpfs, so we keep trusting them
mv /data/local/tmp/tmp-ca-copy/* /system/etc/security/cacerts/

# Copy our new cert in, so we trust that too
mv $CERTIFICATE_PATH /system/etc/security/cacerts/

# Update the perms & selinux context labels
chown root:root /system/etc/security/cacerts/*
chmod 644 /system/etc/security/cacerts/*
chcon u:object_r:system_file:s0 /system/etc/security/cacerts/*

# Deal with the APEX overrides, which need injecting into each namespace:

# First we get the Zygote process(es), which launch each app
ZYGOTE_PID=$(pidof zygote || true)
ZYGOTE64_PID=$(pidof zygote64 || true)
# N.b. some devices appear to have both!

# Apps inherit the Zygote's mounts at startup, so we inject here to ensure
# all newly started apps will see these certs straight away:
for Z_PID in "$ZYGOTE_PID" "$ZYGOTE64_PID"; do
if [ -n "$Z_PID" ]; then
nsenter --mount=/proc/$Z_PID/ns/mnt -- \
/bin/mount --bind /system/etc/security/cacerts /apex/com.android.conscrypt/cacerts
fi
done

# Then we inject the mount into all already running apps, so they
# too see these CA certs immediately:

# Get the PID of every process whose parent is one of the Zygotes:
APP_PIDS=$(
echo "$ZYGOTE_PID $ZYGOTE64_PID" | \
xargs -n1 ps -o 'PID' -P | \
grep -v PID
)

# Inject into the mount namespace of each of those apps:
for PID in $APP_PIDS; do
nsenter --mount=/proc/$PID/ns/mnt -- \
/bin/mount --bind /system/etc/security/cacerts /apex/com.android.conscrypt/cacerts &
done
wait # Launched in parallel - wait for completion here

echo "System certificate injected"
```
### NSEnter ile Bind-mounting

1. **YazÄ±labilir Bir Dizin OluÅŸturma**: Ä°lk olarak, mevcut olmayan APEX olmayan sistem sertifika dizini Ã¼zerine bir `tmpfs` baÄŸlanarak yazÄ±labilir bir dizin oluÅŸturulur. Bu, aÅŸaÄŸÄ±daki komutla gerÃ§ekleÅŸtirilir:
```bash
mount -t tmpfs tmpfs /system/etc/security/cacerts
```
2. **CA SertifikalarÄ±nÄ± HazÄ±rlama**: YazÄ±labilir dizinin kurulumundan sonra, kullanmayÄ± planladÄ±ÄŸÄ±nÄ±z CA sertifikalarÄ±nÄ± bu dizine kopyalamalÄ±sÄ±nÄ±z. Bu, `/apex/com.android.conscrypt/cacerts/` dizininden varsayÄ±lan sertifikalarÄ±n kopyalanmasÄ±nÄ± gerektirebilir. Bu sertifikalarÄ±n izinlerini ve SELinux etiketlerini uygun ÅŸekilde ayarlamak Ã¶nemlidir.

3. **Zygote iÃ§in BaÄŸlama MontajÄ±**: `nsenter` kullanarak, Zygote'nin montaj ad alanÄ±na girilir. Android uygulamalarÄ±nÄ± baÅŸlatan sÃ¼reÃ§ olan Zygote, bundan sonra baÅŸlatÄ±lan tÃ¼m uygulamalarÄ±n yeni yapÄ±landÄ±rÄ±lmÄ±ÅŸ CA sertifikalarÄ±nÄ± kullanmasÄ±nÄ± saÄŸlamak iÃ§in bu adÄ±mÄ± gerektirir. KullanÄ±lan komut:
```bash
nsenter --mount=/proc/$ZYGOTE_PID/ns/mnt -- /bin/mount --bind /system/etc/security/cacerts /apex/com.android.conscrypt/cacerts
```
Bu, her yeni baÅŸlatÄ±lan uygulamanÄ±n gÃ¼ncellenmiÅŸ CA sertifikalarÄ± kurulumuna uymasÄ±nÄ± saÄŸlar.

4. **Ã‡alÄ±ÅŸan Uygulamalara DeÄŸiÅŸiklikleri Uygulama**: Zaten Ã§alÄ±ÅŸan uygulamalara deÄŸiÅŸiklikleri uygulamak iÃ§in, `nsenter` tekrar kullanÄ±lÄ±r ve her uygulamanÄ±n ad alanÄ±na bireysel olarak girilir ve benzer bir baÄŸlama noktasÄ± baÄŸlama iÅŸlemi gerÃ§ekleÅŸtirilir. Gerekli komut:
```bash
nsenter --mount=/proc/$APP_PID/ns/mnt -- /bin/mount --bind /system/etc/security/cacerts /apex/com.android.conscrypt/cacerts
```
5. **Alternatif YaklaÅŸÄ±m - YumuÅŸak Yeniden BaÅŸlatma**: Alternatif bir yÃ¶ntem, `init` iÅŸlemine (PID 1) bind mount iÅŸlemini gerÃ§ekleÅŸtirmek ve ardÄ±ndan iÅŸletim sistemini `stop && start` komutlarÄ±yla yumuÅŸak bir ÅŸekilde yeniden baÅŸlatmaktÄ±r. Bu yaklaÅŸÄ±m, deÄŸiÅŸiklikleri tÃ¼m ad alanlarÄ±na yayarak her bir Ã§alÄ±ÅŸan uygulamayÄ± ayrÄ± ayrÄ± ele almaya gerek olmamasÄ±nÄ± saÄŸlar. Bununla birlikte, bu yÃ¶ntem genellikle yeniden baÅŸlatmanÄ±n zahmetli olmasÄ± nedeniyle tercih edilmemektedir.

## Referanslar
* [https://httptoolkit.com/blog/android-14-install-system-ca-certificate/](https://httptoolkit.com/blog/android-14-install-system-ca-certificate/)

<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan kahramanla Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **reklamÄ±nÄ±zÄ± gÃ¶rmek** veya HackTricks'i **PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* Ã–zel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluÅŸan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'i keÅŸfedin
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)'u **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na **PR gÃ¶ndererek paylaÅŸÄ±n**.

</details>
