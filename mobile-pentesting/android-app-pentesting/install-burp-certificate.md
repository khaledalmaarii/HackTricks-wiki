# å®‰è£…Burpè¯ä¹¦

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricksäº‘ â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ æ¨ç‰¹ ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€å®¶**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿä½ æƒ³åœ¨HackTricksä¸­çœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…ä½ æƒ³è¦**è·å–PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“â€”â€”[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–è€…**å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **é€šè¿‡å‘**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **å’Œ**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## åœ¨è™šæ‹Ÿæœºä¸Š

é¦–å…ˆï¼Œä½ éœ€è¦ä»Burpä¸­ä¸‹è½½Derè¯ä¹¦ã€‚ä½ å¯ä»¥åœ¨_**Proxy**_ --> _**Options**_ --> _**Import / Export CA certificate**_ä¸­å®Œæˆæ­¤æ“ä½œã€‚

![](<../../.gitbook/assets/image (367).png>)

**ä»¥Deræ ¼å¼å¯¼å‡ºè¯ä¹¦**ï¼Œç„¶åå°†å…¶è½¬æ¢ä¸º**Android**èƒ½å¤Ÿ**ç†è§£çš„å½¢å¼**ã€‚è¯·æ³¨æ„ï¼Œ**ä¸ºäº†åœ¨AVDä¸­é…ç½®Burpè¯ä¹¦**ï¼Œä½ éœ€è¦**ä½¿ç”¨**`-writable-system`**é€‰é¡¹è¿è¡Œæ­¤è™šæ‹Ÿæœºã€‚\
ä¾‹å¦‚ï¼Œä½ å¯ä»¥è¿™æ ·è¿è¡Œå®ƒï¼š
```bash
C:\Users\<UserName>\AppData\Local\Android\Sdk\tools\emulator.exe -avd "AVD9" -http-proxy 192.168.1.12:8080 -writable-system
```
ç„¶åï¼Œè¦**é…ç½®Burpçš„è¯ä¹¦**ï¼Œè¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

{% code overflow="wrap" %}
```bash
openssl x509 -inform DER -in burp_cacert.der -out burp_cacert.pem
CERTHASHNAME="`openssl x509 -inform PEM -subject_hash_old -in burp_cacert.pem | head -1`.0"
mv burp_cacert.pem $CERTHASHNAME #Correct name
adb root && sleep 2 && adb remount #Allow to write on /syste
adb push $CERTHASHNAME /sdcard/ #Upload certificate
adb shell mv /sdcard/$CERTHASHNAME /system/etc/security/cacerts/ #Move to correct location
adb shell chmod 644 /system/etc/security/cacerts/$CERTHASHNAME #Assign privileges
adb reboot #Now, reboot the machine
```
{% endcode %}

ä¸€æ—¦æœºå™¨é‡æ–°å¯åŠ¨ï¼ŒBurpè¯ä¹¦å°†è¢«ä½¿ç”¨ï¼

## ä½¿ç”¨Magisc

å¦‚æœæ‚¨ä½¿ç”¨Magiscï¼ˆå¯èƒ½æ˜¯æ¨¡æ‹Ÿå™¨ï¼‰å¯¹è®¾å¤‡è¿›è¡Œäº†rootï¼Œè€Œä¸”ç”±äºæ–‡ä»¶ç³»ç»Ÿæ˜¯åªè¯»çš„ï¼Œæ‚¨æ— æ³•æŒ‰ç…§ä¹‹å‰çš„æ­¥éª¤å®‰è£…Burpè¯ä¹¦ï¼Œä¹Ÿæ— æ³•å°†å…¶é‡æ–°æŒ‚è½½ä¸ºå¯å†™ï¼Œè¯·ä½¿ç”¨å¦ä¸€ç§æ–¹æ³•ã€‚

åœ¨[**æ­¤è§†é¢‘**](https://www.youtube.com/watch?v=qQicUW0svB8)ä¸­è§£é‡Šäº†æ‚¨éœ€è¦ï¼š

1. **å®‰è£…CAè¯ä¹¦**ï¼šåªéœ€å°†DER Burpè¯ä¹¦æ‹–æ”¾åˆ°ç§»åŠ¨è®¾å¤‡ä¸Šï¼Œå°†æ‰©å±•åæ›´æ”¹ä¸º`.crt`ï¼Œä»¥ä¾¿å°†å…¶å­˜å‚¨åœ¨ä¸‹è½½æ–‡ä»¶å¤¹ä¸­ï¼Œç„¶åè½¬åˆ°â€œå®‰è£…è¯ä¹¦â€->â€œCAè¯ä¹¦â€

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1).png" alt="" width="164"><figcaption></figcaption></figure>

* æ£€æŸ¥è¯ä¹¦æ˜¯å¦æ­£ç¡®å­˜å‚¨ï¼Œè½¬åˆ°â€œå—ä¿¡ä»»çš„å‡­æ®â€->â€œç”¨æˆ·â€

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" width="334"><figcaption></figcaption></figure>

2. **ä½¿å…¶æˆä¸ºç³»ç»Ÿä¿¡ä»»çš„**ï¼šä¸‹è½½Magiscæ¨¡å—[MagiskTrustUserCerts](https://github.com/NVISOsecurity/MagiskTrustUserCerts)ï¼ˆä¸€ä¸ª.zipæ–‡ä»¶ï¼‰ï¼Œå°†å…¶æ‹–æ”¾åˆ°æ‰‹æœºä¸Šï¼Œè½¬åˆ°æ‰‹æœºä¸Šçš„Magicsåº”ç”¨ç¨‹åºï¼Œè½¬åˆ°â€œæ¨¡å—â€éƒ¨åˆ†ï¼Œç‚¹å‡»â€œä»å­˜å‚¨å®‰è£…â€ï¼Œé€‰æ‹©`.zip`æ¨¡å—ï¼Œå®‰è£…å**é‡æ–°å¯åŠ¨**æ‰‹æœºï¼š

<figure><img src="../../.gitbook/assets/image (2) (1) (1) (1) (1) (1).png" alt="" width="345"><figcaption></figcaption></figure>

* é‡æ–°å¯åŠ¨åï¼Œè½¬åˆ°â€œå—ä¿¡ä»»çš„å‡­æ®â€->â€œç³»ç»Ÿâ€ï¼Œæ£€æŸ¥Postswiggerè¯ä¹¦æ˜¯å¦å­˜åœ¨

<figure><img src="../../.gitbook/assets/image (3) (1) (1) (1).png" alt="" width="314"><figcaption></figcaption></figure>

## Android 14ä¹‹å

å˜æ›´ï¼š

* åˆ°ç›®å‰ä¸ºæ­¢ï¼Œç³»ç»Ÿä¿¡ä»»çš„CAè¯ä¹¦ä½äº**`/system/etc/security/cacerts/`**ã€‚åœ¨æ ‡å‡†çš„AOSPæ¨¡æ‹Ÿå™¨ä¸Šï¼Œå¯ä»¥ä½¿ç”¨æ ¹è®¿é—®ç›´æ¥ä¿®æ”¹è¿™äº›è¯ä¹¦ï¼Œç«‹å³åœ¨æ‰€æœ‰åœ°æ–¹ç”Ÿæ•ˆã€‚
* åœ¨Android 14ä¸­ï¼Œç³»ç»Ÿä¿¡ä»»çš„CAè¯ä¹¦é€šå¸¸ä½äº**`/apex/com.android.conscrypt/cacerts`**ï¼Œè€Œ**`/apex`çš„æ‰€æœ‰å†…å®¹éƒ½æ˜¯ä¸å¯å˜çš„**ã€‚
* æ— æ³•å°†**APEX cacertsè·¯å¾„é‡æ–°æŒ‚è½½ä¸ºå¯å†™** - é‡æ–°æŒ‚è½½ä¼šå¤±è´¥ã€‚å®é™…ä¸Šï¼Œå³ä½¿æ‚¨ä»æ ¹shellä¸­å¸è½½æ•´ä¸ªè·¯å¾„ï¼Œåº”ç”¨ç¨‹åºä»ç„¶å¯ä»¥æ­£å¸¸è¯»å–æ‚¨çš„è¯ä¹¦ã€‚
* å°†tmpfsç›®å½•æŒ‚è½½åˆ°é¡¶éƒ¨çš„æ›¿ä»£æŠ€æœ¯ä¹Ÿæ— æ³•å·¥ä½œ - å³ä½¿è¿™æ„å‘³ç€`ls /apex/com.android.conscrypt/cacerts`å¯èƒ½è¿”å›ç©ºï¼ˆæˆ–ä»»ä½•å…¶ä»–æ‚¨å–œæ¬¢çš„å†…å®¹ï¼‰ï¼Œåº”ç”¨ç¨‹åºä»ç„¶ä¼šçœ‹åˆ°ç›¸åŒçš„åŸå§‹æ•°æ®ã€‚
* å› ä¸º`/apex`æŒ‚è½½æ˜¯[æ˜¾å¼æŒ‚è½½](https://cs.android.com/android/platform/superproject/main/+/main:system/core/init/mount\_namespace.cpp;l=97;drc=566c65239f1cf3fcb0d8745715e5ef1083d4bd3a)ï¼Œä½¿ç”¨ç§æœ‰ä¼ æ’­ï¼Œå› æ­¤`/apex`è·¯å¾„å†…çš„æŒ‚è½½æ›´æ”¹æ°¸è¿œä¸ä¼šåœ¨è¿›ç¨‹ä¹‹é—´å…±äº«ã€‚

è¿™æ˜¯ç”±å¯åŠ¨æ“ä½œç³»ç»Ÿçš„`init`è¿›ç¨‹å®Œæˆçš„ï¼Œç„¶åå¯åŠ¨[Zygoteè¿›ç¨‹](https://en.wikipedia.org/wiki/Booting\_process\_of\_Android\_devices#Zygote)ï¼ˆä½¿ç”¨ä»çˆ¶è¿›ç¨‹å¤åˆ¶çš„æ–°æŒ‚è½½å‘½åç©ºé—´ï¼Œå› æ­¤åŒ…æ‹¬å…¶è‡ªå·±çš„ç§æœ‰`/apex`æŒ‚è½½ï¼‰ï¼Œç„¶åä¾æ¬¡å¯åŠ¨æ¯ä¸ªåº”ç”¨ç¨‹åºè¿›ç¨‹ï¼Œæ¯å½“åœ¨è®¾å¤‡ä¸Šå¯åŠ¨åº”ç”¨ç¨‹åºæ—¶ï¼ˆæ¯ä¸ªåº”ç”¨ç¨‹åºè¿›ç¨‹ç„¶åå¤åˆ¶ç›¸åŒçš„ç§æœ‰`/apex`æŒ‚è½½ï¼‰ã€‚

### é€’å½’é‡æ–°æŒ‚è½½æŒ‚è½½ç‚¹

* æ‚¨å¯ä»¥æ‰‹åŠ¨é‡æ–°æŒ‚è½½`/apex`ï¼Œåˆ é™¤ç§æœ‰ä¼ æ’­å¹¶ä½¿å…¶å¯å†™ï¼ˆå…·æœ‰è®½åˆºæ„å‘³çš„æ˜¯ï¼Œä¼¼ä¹å®Œå…¨åˆ é™¤ç§æœ‰ä¼ æ’­ç¡®å®åœ¨æ‰€æœ‰åœ°æ–¹ä¼ æ’­ï¼‰
* æ‚¨å°†æ•´ä¸ª`/apex/com.android.conscrypt`çš„å†…å®¹å¤åˆ¶åˆ°å…¶ä»–ä½ç½®
* ç„¶åå®Œå…¨å¸è½½`/apex/com.android.conscrypt` - åˆ é™¤ä¸å¯å˜åœ°æä¾›æ­¤æ¨¡å—çš„åªè¯»æŒ‚è½½
* ç„¶åå°†å†…å®¹å¤åˆ¶å›æ¥ï¼Œä½¿å…¶ç›´æ¥ä½äº`/apex`æŒ‚è½½ä¸­ï¼Œå¯ä»¥è¿›è¡Œä¿®æ”¹ï¼ˆæ‚¨éœ€è¦å¿«é€Ÿæ‰§è¡Œæ­¤æ“ä½œï¼Œå› ä¸º[æ˜¾ç„¶](https://infosec.exchange/@g1a55er/111069489513139531)å¦åˆ™å¯èƒ½ä¼šå¯¼è‡´å´©æºƒï¼‰
* è¿™åº”è¯¥ç«‹å³ç”Ÿæ•ˆï¼Œä½†ä»–ä»¬å»ºè®®æ€æ­»`system_server`ï¼ˆé‡æ–°å¯åŠ¨æ‰€æœ‰åº”ç”¨ç¨‹åºï¼‰ä»¥ä½¿ä¸€åˆ‡æ¢å¤åˆ°ä¸€è‡´çš„çŠ¶æ€
```bash
# Create a separate temp directory, to hold the current certificates
# Otherwise, when we add the mount we can't read the current certs anymore.
mkdir -p -m 700 /data/local/tmp/tmp-ca-copy

# Copy out the existing certificates
cp /apex/com.android.conscrypt/cacerts/* /data/local/tmp/tmp-ca-copy/

# Create the in-memory mount on top of the system certs folder
mount -t tmpfs tmpfs /system/etc/security/cacerts

# Copy the existing certs back into the tmpfs, so we keep trusting them
mv /data/local/tmp/tmp-ca-copy/* /system/etc/security/cacerts/

# Copy our new cert in, so we trust that too
mv $CERTIFICATE_PATH /system/etc/security/cacerts/

# Update the perms & selinux context labels
chown root:root /system/etc/security/cacerts/*
chmod 644 /system/etc/security/cacerts/*
chcon u:object_r:system_file:s0 /system/etc/security/cacerts/*

# Deal with the APEX overrides, which need injecting into each namespace:

# First we get the Zygote process(es), which launch each app
ZYGOTE_PID=$(pidof zygote || true)
ZYGOTE64_PID=$(pidof zygote64 || true)
# N.b. some devices appear to have both!

# Apps inherit the Zygote's mounts at startup, so we inject here to ensure
# all newly started apps will see these certs straight away:
for Z_PID in "$ZYGOTE_PID" "$ZYGOTE64_PID"; do
if [ -n "$Z_PID" ]; then
nsenter --mount=/proc/$Z_PID/ns/mnt -- \
/bin/mount --bind /system/etc/security/cacerts /apex/com.android.conscrypt/cacerts
fi
done

# Then we inject the mount into all already running apps, so they
# too see these CA certs immediately:

# Get the PID of every process whose parent is one of the Zygotes:
APP_PIDS=$(
echo "$ZYGOTE_PID $ZYGOTE64_PID" | \
xargs -n1 ps -o 'PID' -P | \
grep -v PID
)

# Inject into the mount namespace of each of those apps:
for PID in $APP_PIDS; do
nsenter --mount=/proc/$PID/ns/mnt -- \
/bin/mount --bind /system/etc/security/cacerts /apex/com.android.conscrypt/cacerts &
done
wait # Launched in parallel - wait for completion here

echo "System certificate injected"
```
### é€šè¿‡ NSEnter è¿›è¡Œç»‘å®šæŒ‚è½½

*   é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åœ¨æŸä¸ªåœ°æ–¹è®¾ç½®ä¸€ä¸ªå¯å†™ç›®å½•ã€‚ä¸ºäº†ä¸ç°æœ‰æ–¹æ³•è½»æ¾å…¼å®¹ï¼Œæˆ‘ä½¿ç”¨ `tmpfs` æŒ‚è½½åœ¨ï¼ˆä»ç„¶å­˜åœ¨çš„ï¼‰é APEX ç³»ç»Ÿè¯ä¹¦ç›®å½•ä¸Šï¼š

```bash
mount -t tmpfs tmpfs /system/etc/security/cacerts
```
* ç„¶åï¼Œå°†ä½ æ„Ÿå…´è¶£çš„ CA è¯ä¹¦æ”¾å…¥æ­¤ç›®å½•ä¸­ï¼ˆä¾‹å¦‚ï¼Œä½ å¯èƒ½æƒ³ä»ç°æœ‰çš„ `/apex/com.android.conscrypt/cacerts/` CA è¯ä¹¦ç›®å½•ä¸­å¤åˆ¶æ‰€æœ‰é»˜è®¤è¯ä¹¦ï¼‰ï¼Œå¹¶é€‚å½“è®¾ç½®æƒé™å’Œ SELinux æ ‡ç­¾ã€‚
*   ç„¶åï¼Œä½¿ç”¨ `nsenter` è¿›å…¥ Zygote çš„æŒ‚è½½å‘½åç©ºé—´ï¼Œå¹¶å°†æ­¤ç›®å½•ç»‘å®šåˆ° APEX ç›®å½•ä¸Šï¼š

```bash
nsenter --mount=/proc/$ZYGOTE_PID/ns/mnt -- \
/bin/mount --bind /system/etc/security/cacerts /apex/com.android.conscrypt/cacerts
```

Zygote è¿›ç¨‹ä¼šç”Ÿæˆæ¯ä¸ªåº”ç”¨ç¨‹åºï¼Œå¤åˆ¶å…¶æŒ‚è½½å‘½åç©ºé—´ä»¥å®Œæˆæ­¤æ“ä½œï¼Œå› æ­¤è¿™ç¡®ä¿äº†æ‰€æœ‰æ–°å¯åŠ¨çš„åº”ç”¨ç¨‹åºï¼ˆä»ç°åœ¨å¼€å§‹çš„æ‰€æœ‰å†…å®¹ï¼‰éƒ½å°†ä½¿ç”¨æ­¤ç›®å½•ã€‚
*   ç„¶åï¼Œä½¿ç”¨ `nsenter` è¿›å…¥æ¯ä¸ªå·²è¿è¡Œåº”ç”¨ç¨‹åºçš„å‘½åç©ºé—´ï¼Œå¹¶æ‰§è¡Œç›¸åŒçš„æ“ä½œï¼š

```bash
nsenter --mount=/proc/$APP_PID/ns/mnt -- \
/bin/mount --bind /system/etc/security/cacerts /apex/com.android.conscrypt/cacerts
```

æˆ–è€…ï¼Œå¦‚æœä½ ä¸ä»‹æ„ç¬¨æ‹™çš„ç”¨æˆ·ä½“éªŒï¼Œä½ åº”è¯¥èƒ½å¤Ÿåœ¨ `init` æœ¬èº«ï¼ˆPID 1ï¼‰ä¸Šè¿›è¡Œç»‘å®šæŒ‚è½½ï¼Œç„¶åè¿è¡Œ `stop && start` æ¥è½¯é‡å¯æ“ä½œç³»ç»Ÿï¼Œé‡æ–°åˆ›å»ºæ‰€æœ‰å‘½åç©ºé—´å¹¶ä¼ æ’­ä½ çš„æ›´æ”¹ï¼ˆä½†ä¸ªäººä¸Šæˆ‘ä¸ä»‹æ„ç¬¨æ‹™çš„é‡å¯ï¼Œæ‰€ä»¥æˆ‘å®Œå…¨å¿½ç•¥äº†è¿™æ¡è·¯çº¿ï¼‰ã€‚

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks äº‘ â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€å®¶ **ç½‘ç»œå®‰å…¨å…¬å¸** å·¥ä½œå—ï¼Ÿæƒ³è¦åœ¨ HackTricks ä¸­ **ä¸ºä½ çš„å…¬å¸åšå¹¿å‘Š** å—ï¼Ÿæˆ–è€…æƒ³è¦è®¿é—® **PEASS çš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½ PDF æ ¼å¼çš„ HackTricks** å—ï¼Ÿè¯·æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶ [**NFTs**](https://opensea.io/collection/the-peass-family) é›†åˆ - [**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å– [**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* **åŠ å…¥** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–åœ¨ **Twitter** ä¸Š **å…³æ³¨** æˆ‘ [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **é€šè¿‡å‘** [**hacktricks ä»“åº“**](https://github.com/carlospolop/hacktricks) **å’Œ** [**hacktricks-cloud ä»“åº“**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤ PR æ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
