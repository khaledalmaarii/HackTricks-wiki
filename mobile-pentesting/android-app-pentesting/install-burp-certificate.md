# å®‰è£… Burp è¯ä¹¦

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

## åœ¨è™šæ‹Ÿæœºä¸Š

é¦–å…ˆï¼Œæ‚¨éœ€è¦ä» Burp ä¸‹è½½ Der è¯ä¹¦ã€‚æ‚¨å¯ä»¥åœ¨ _**ä»£ç†**_ --> _**é€‰é¡¹**_ --> _**å¯¼å…¥ / å¯¼å‡º CA è¯ä¹¦**_ ä¸­å®Œæˆæ­¤æ“ä½œã€‚

![](<../../.gitbook/assets/image (367).png>)

**ä»¥ Der æ ¼å¼å¯¼å‡ºè¯ä¹¦**ï¼Œç„¶åè®©æˆ‘ä»¬**è½¬æ¢**å®ƒä¸º **Android** èƒ½å¤Ÿ **ç†è§£** çš„æ ¼å¼ã€‚è¯·æ³¨æ„ï¼Œ**ä¸ºäº†åœ¨ AVD çš„ Android æœºå™¨ä¸Šé…ç½® burp è¯ä¹¦**ï¼Œæ‚¨éœ€è¦ **ä½¿ç”¨** **`-writable-system`** é€‰é¡¹ **è¿è¡Œ** è¯¥æœºå™¨ã€‚\
ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥è¿™æ ·è¿è¡Œå®ƒï¼š

{% code overflow="wrap" %}
```bash
C:\Users\<UserName>\AppData\Local\Android\Sdk\tools\emulator.exe -avd "AVD9" -http-proxy 192.168.1.12:8080 -writable-system
```
{% endcode %}

ç„¶åï¼Œ**é…ç½® burp çš„è¯ä¹¦**ï¼š

{% code overflow="wrap" %}
```bash
openssl x509 -inform DER -in burp_cacert.der -out burp_cacert.pem
CERTHASHNAME="`openssl x509 -inform PEM -subject_hash_old -in burp_cacert.pem | head -1`.0"
mv burp_cacert.pem $CERTHASHNAME #Correct name
adb root && sleep 2 && adb remount #Allow to write on /syste
adb push $CERTHASHNAME /sdcard/ #Upload certificate
adb shell mv /sdcard/$CERTHASHNAME /system/etc/security/cacerts/ #Move to correct location
adb shell chmod 644 /system/etc/security/cacerts/$CERTHASHNAME #Assign privileges
adb reboot #Now, reboot the machine
```
{% endcode %}

ä¸€æ—¦**æœºå™¨å®Œæˆé‡å¯**ï¼Œburpè¯ä¹¦å°†è¢«ä½¿ç”¨ï¼

## ä½¿ç”¨Magisc

å¦‚æœä½ **ç”¨Magiscè·å–äº†è®¾å¤‡çš„rootæƒé™**ï¼ˆå¯èƒ½æ˜¯æ¨¡æ‹Ÿå™¨ï¼‰ï¼Œå¹¶ä¸”ä½ **æ— æ³•æŒ‰ç…§**ä¹‹å‰çš„**æ­¥éª¤**å®‰è£…Burpè¯ä¹¦ï¼Œå› ä¸º**æ–‡ä»¶ç³»ç»Ÿæ˜¯åªè¯»çš„**ï¼Œä½ æ— æ³•é‡æ–°æŒ‚è½½ä¸ºå¯å†™ï¼Œè¿˜æœ‰å¦ä¸€ç§æ–¹æ³•ã€‚

åœ¨[**è¿™ä¸ªè§†é¢‘**](https://www.youtube.com/watch?v=qQicUW0svB8)ä¸­è§£é‡Šï¼Œä½ éœ€è¦ï¼š

1. **å®‰è£…CAè¯ä¹¦**ï¼šåªéœ€**æ‹–æ”¾**DER Burpè¯ä¹¦ï¼Œ**æ›´æ”¹æ‰©å±•å**ä¸º`.crt`ï¼Œå­˜å‚¨åœ¨æ‰‹æœºçš„ä¸‹è½½æ–‡ä»¶å¤¹ä¸­ï¼Œç„¶åè½¬åˆ°`å®‰è£…è¯ä¹¦` -> `CAè¯ä¹¦`

<figure><img src="../../.gitbook/assets/image (53).png" alt="" width="164"><figcaption></figcaption></figure>

* æ£€æŸ¥è¯ä¹¦æ˜¯å¦æ­£ç¡®å­˜å‚¨ï¼Œè½¬åˆ°`å—ä¿¡ä»»çš„å‡­æ®` -> `ç”¨æˆ·`

<figure><img src="../../.gitbook/assets/image (54).png" alt="" width="334"><figcaption></figcaption></figure>

2. **ä½¿å…¶ç³»ç»Ÿä¿¡ä»»**ï¼šä¸‹è½½Magiscæ¨¡å—[MagiskTrustUserCerts](https://github.com/NVISOsecurity/MagiskTrustUserCerts)ï¼ˆä¸€ä¸ª.zipæ–‡ä»¶ï¼‰ï¼Œ**æ‹–æ”¾åˆ°**æ‰‹æœºä¸­ï¼Œè½¬åˆ°æ‰‹æœºä¸­çš„**Magicsåº”ç”¨**çš„**`æ¨¡å—`**éƒ¨åˆ†ï¼Œç‚¹å‡»**`ä»å­˜å‚¨å®‰è£…`**ï¼Œé€‰æ‹©`.zip`æ¨¡å—ï¼Œå®‰è£…å®Œæˆå**é‡å¯**æ‰‹æœºï¼š

<figure><img src="../../.gitbook/assets/image (55).png" alt="" width="345"><figcaption></figcaption></figure>

* é‡å¯åï¼Œè½¬åˆ°`å—ä¿¡ä»»çš„å‡­æ®` -> `ç³»ç»Ÿ`ï¼Œæ£€æŸ¥Postswiggerè¯ä¹¦æ˜¯å¦å­˜åœ¨

<figure><img src="../../.gitbook/assets/image (56).png" alt="" width="314"><figcaption></figcaption></figure>

## Android 14ä¹‹å

åœ¨æœ€æ–°çš„Android 14ç‰ˆæœ¬ä¸­ï¼Œç³»ç»Ÿä¿¡ä»»çš„è¯ä¹¦é¢å‘æœºæ„ï¼ˆCAï¼‰è¯ä¹¦çš„å¤„ç†æ–¹å¼å‘ç”Ÿäº†æ˜¾è‘—å˜åŒ–ã€‚ä»¥å‰ï¼Œè¿™äº›è¯ä¹¦å­˜æ”¾åœ¨**`/system/etc/security/cacerts/`**ä¸­ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡rootæƒé™è®¿é—®å’Œä¿®æ”¹ï¼Œä»è€Œç«‹å³åœ¨ç³»ç»Ÿä¸­åº”ç”¨ã€‚ç„¶è€Œï¼Œåœ¨Android 14ä¸­ï¼Œå­˜å‚¨ä½ç½®å·²ç§»è‡³**`/apex/com.android.conscrypt/cacerts`**ï¼Œè¿™æ˜¯**`/apex`**è·¯å¾„ä¸­çš„ä¸€ä¸ªç›®å½•ï¼Œå¤©ç”Ÿæ˜¯ä¸å¯å˜çš„ã€‚

å°è¯•å°†**APEX cacertsè·¯å¾„**é‡æ–°æŒ‚è½½ä¸ºå¯å†™æ—¶ä¼šå¤±è´¥ï¼Œå› ä¸ºç³»ç»Ÿä¸å…è®¸æ­¤ç±»æ“ä½œã€‚å³ä½¿å°è¯•å¸è½½æˆ–ç”¨ä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿï¼ˆtmpfsï¼‰è¦†ç›–è¯¥ç›®å½•ä¹Ÿæ— æ³•è§„é¿ä¸å¯å˜æ€§ï¼›åº”ç”¨ç¨‹åºç»§ç»­è®¿é—®åŸå§‹è¯ä¹¦æ•°æ®ï¼Œæ— è®ºæ–‡ä»¶ç³»ç»Ÿçº§åˆ«çš„æ›´æ”¹å¦‚ä½•ã€‚è¿™ç§éŸ§æ€§æ˜¯ç”±äº**`/apex`**æŒ‚è½½é…ç½®ä¸ºPRIVATEä¼ æ’­ï¼Œç¡®ä¿**`/apex`**ç›®å½•ä¸­çš„ä»»ä½•ä¿®æ”¹ä¸ä¼šå½±å“å…¶ä»–è¿›ç¨‹ã€‚

Androidçš„åˆå§‹åŒ–æ¶‰åŠ`init`è¿›ç¨‹ï¼Œè¯¥è¿›ç¨‹åœ¨å¯åŠ¨æ“ä½œç³»ç»Ÿæ—¶è¿˜ä¼šå¯åŠ¨Zygoteè¿›ç¨‹ã€‚è¯¥è¿›ç¨‹è´Ÿè´£ä»¥æ–°çš„æŒ‚è½½å‘½åç©ºé—´å¯åŠ¨åº”ç”¨ç¨‹åºè¿›ç¨‹ï¼Œå…¶ä¸­åŒ…æ‹¬ä¸€ä¸ªç§æœ‰çš„**`/apex`**æŒ‚è½½ï¼Œä»è€Œå°†å¯¹è¯¥ç›®å½•çš„æ›´æ”¹ä¸å…¶ä»–è¿›ç¨‹éš”ç¦»ã€‚

ç„¶è€Œï¼Œå¯¹äºéœ€è¦ä¿®æ”¹**`/apex`**ç›®å½•ä¸­ç³»ç»Ÿä¿¡ä»»çš„CAè¯ä¹¦çš„äººæ¥è¯´ï¼Œå­˜åœ¨ä¸€ç§è§£å†³æ–¹æ³•ã€‚è¿™æ¶‰åŠæ‰‹åŠ¨é‡æ–°æŒ‚è½½**`/apex`**ä»¥å»é™¤PRIVATEä¼ æ’­ï¼Œä»è€Œä½¿å…¶å¯å†™ã€‚è¯¥è¿‡ç¨‹åŒ…æ‹¬å°†**`/apex/com.android.conscrypt`**çš„å†…å®¹å¤åˆ¶åˆ°å¦ä¸€ä¸ªä½ç½®ï¼Œå¸è½½**`/apex/com.android.conscrypt`**ç›®å½•ä»¥æ¶ˆé™¤åªè¯»çº¦æŸï¼Œç„¶åå°†å†…å®¹æ¢å¤åˆ°**`/apex`**ä¸­çš„åŸå§‹ä½ç½®ã€‚æ­¤æ–¹æ³•éœ€è¦è¿…é€Ÿè¡ŒåŠ¨ä»¥é¿å…ç³»ç»Ÿå´©æºƒã€‚ä¸ºäº†ç¡®ä¿è¿™äº›æ›´æ”¹åœ¨ç³»ç»ŸèŒƒå›´å†…ç”Ÿæ•ˆï¼Œå»ºè®®é‡å¯`system_server`ï¼Œè¿™æœ‰æ•ˆåœ°é‡å¯æ‰€æœ‰åº”ç”¨ç¨‹åºå¹¶ä½¿ç³»ç»Ÿæ¢å¤åˆ°ä¸€è‡´çŠ¶æ€ã€‚
```bash
# Create a separate temp directory, to hold the current certificates
# Otherwise, when we add the mount we can't read the current certs anymore.
mkdir -p -m 700 /data/local/tmp/tmp-ca-copy

# Copy out the existing certificates
cp /apex/com.android.conscrypt/cacerts/* /data/local/tmp/tmp-ca-copy/

# Create the in-memory mount on top of the system certs folder
mount -t tmpfs tmpfs /system/etc/security/cacerts

# Copy the existing certs back into the tmpfs, so we keep trusting them
mv /data/local/tmp/tmp-ca-copy/* /system/etc/security/cacerts/

# Copy our new cert in, so we trust that too
mv $CERTIFICATE_PATH /system/etc/security/cacerts/

# Update the perms & selinux context labels
chown root:root /system/etc/security/cacerts/*
chmod 644 /system/etc/security/cacerts/*
chcon u:object_r:system_file:s0 /system/etc/security/cacerts/*

# Deal with the APEX overrides, which need injecting into each namespace:

# First we get the Zygote process(es), which launch each app
ZYGOTE_PID=$(pidof zygote || true)
ZYGOTE64_PID=$(pidof zygote64 || true)
# N.b. some devices appear to have both!

# Apps inherit the Zygote's mounts at startup, so we inject here to ensure
# all newly started apps will see these certs straight away:
for Z_PID in "$ZYGOTE_PID" "$ZYGOTE64_PID"; do
if [ -n "$Z_PID" ]; then
nsenter --mount=/proc/$Z_PID/ns/mnt -- \
/bin/mount --bind /system/etc/security/cacerts /apex/com.android.conscrypt/cacerts
fi
done

# Then we inject the mount into all already running apps, so they
# too see these CA certs immediately:

# Get the PID of every process whose parent is one of the Zygotes:
APP_PIDS=$(
echo "$ZYGOTE_PID $ZYGOTE64_PID" | \
xargs -n1 ps -o 'PID' -P | \
grep -v PID
)

# Inject into the mount namespace of each of those apps:
for PID in $APP_PIDS; do
nsenter --mount=/proc/$PID/ns/mnt -- \
/bin/mount --bind /system/etc/security/cacerts /apex/com.android.conscrypt/cacerts &
done
wait # Launched in parallel - wait for completion here

echo "System certificate injected"
```
### Bind-mounting through NSEnter

1. **è®¾ç½®å¯å†™ç›®å½•**: æœ€åˆï¼Œé€šè¿‡åœ¨ç°æœ‰çš„éAPEXç³»ç»Ÿè¯ä¹¦ç›®å½•ä¸ŠæŒ‚è½½ä¸€ä¸ª `tmpfs` æ¥å»ºç«‹ä¸€ä¸ªå¯å†™ç›®å½•ã€‚å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å®ç°ï¼š
```bash
mount -t tmpfs tmpfs /system/etc/security/cacerts
```
2. **å‡†å¤‡ CA è¯ä¹¦**ï¼šåœ¨è®¾ç½®å¯å†™ç›®å½•åï¼Œåº”è¯¥å°†æ‰“ç®—ä½¿ç”¨çš„ CA è¯ä¹¦å¤åˆ¶åˆ°è¯¥ç›®å½•ä¸­ã€‚è¿™å¯èƒ½æ¶‰åŠä» `/apex/com.android.conscrypt/cacerts/` å¤åˆ¶é»˜è®¤è¯ä¹¦ã€‚å¿…é¡»ç›¸åº”åœ°è°ƒæ•´è¿™äº›è¯ä¹¦çš„æƒé™å’Œ SELinux æ ‡ç­¾ã€‚
3. **ä¸º Zygote ç»‘å®šæŒ‚è½½**ï¼šåˆ©ç”¨ `nsenter`ï¼Œè¿›å…¥ Zygote çš„æŒ‚è½½å‘½åç©ºé—´ã€‚Zygote æ˜¯è´Ÿè´£å¯åŠ¨ Android åº”ç”¨ç¨‹åºçš„è¿›ç¨‹ï¼Œè¿™ä¸€æ­¥éª¤æ˜¯ç¡®ä¿æ‰€æœ‰éšåå¯åŠ¨çš„åº”ç”¨ç¨‹åºä½¿ç”¨æ–°é…ç½®çš„ CA è¯ä¹¦ã€‚ä½¿ç”¨çš„å‘½ä»¤æ˜¯ï¼š
```bash
nsenter --mount=/proc/$ZYGOTE_PID/ns/mnt -- /bin/mount --bind /system/etc/security/cacerts /apex/com.android.conscrypt/cacerts
```
è¿™ç¡®ä¿äº†æ¯ä¸ªæ–°å¯åŠ¨çš„åº”ç”¨ç¨‹åºå°†éµå¾ªæ›´æ–°çš„ CA è¯ä¹¦è®¾ç½®ã€‚

4. **å°†æ›´æ”¹åº”ç”¨äºæ­£åœ¨è¿è¡Œçš„åº”ç”¨ç¨‹åº**ï¼šè¦å°†æ›´æ”¹åº”ç”¨äºå·²ç»è¿è¡Œçš„åº”ç”¨ç¨‹åºï¼Œå†æ¬¡ä½¿ç”¨ `nsenter` é€ä¸ªè¿›å…¥æ¯ä¸ªåº”ç”¨ç¨‹åºçš„å‘½åç©ºé—´å¹¶æ‰§è¡Œç±»ä¼¼çš„ç»‘å®šæŒ‚è½½ã€‚å¿…è¦çš„å‘½ä»¤æ˜¯ï¼š
```bash
nsenter --mount=/proc/$APP_PID/ns/mnt -- /bin/mount --bind /system/etc/security/cacerts /apex/com.android.conscrypt/cacerts
```
5. **æ›¿ä»£æ–¹æ³• - è½¯ä»¶é‡å¯**ï¼šä¸€ç§æ›¿ä»£æ–¹æ³•æ¶‰åŠåœ¨ `init` è¿›ç¨‹ï¼ˆPID 1ï¼‰ä¸Šæ‰§è¡Œç»‘å®šæŒ‚è½½ï¼Œç„¶åä½¿ç”¨ `stop && start` å‘½ä»¤å¯¹æ“ä½œç³»ç»Ÿè¿›è¡Œè½¯ä»¶é‡å¯ã€‚æ­¤æ–¹æ³•å°†æ›´æ”¹ä¼ æ’­åˆ°æ‰€æœ‰å‘½åç©ºé—´ï¼Œé¿å…é€ä¸ªå¤„ç†æ¯ä¸ªæ­£åœ¨è¿è¡Œçš„åº”ç”¨ç¨‹åºã€‚ç„¶è€Œï¼Œç”±äºé‡å¯çš„ä¸ä¾¿ï¼Œè¿™ç§æ–¹æ³•é€šå¸¸ä¸å¤ªå—æ¬¢è¿ã€‚

## å‚è€ƒæ–‡çŒ®

* [https://httptoolkit.com/blog/android-14-install-system-ca-certificate/](https://httptoolkit.com/blog/android-14-install-system-ca-certificate/)

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
