# Smali - Decompile/\[DeÄŸiÅŸtirme]/Compile

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

Bazen, gizli bilgilere eriÅŸmek iÃ§in uygulama kodunu deÄŸiÅŸtirmek ilginÃ§ olabilir (belki iyi obfuscate edilmiÅŸ ÅŸifreler veya bayraklar). O zaman, apk'yÄ± decompile etmek, kodu deÄŸiÅŸtirmek ve yeniden compile etmek ilginÃ§ olabilir.

**Opcode referansÄ±:** [http://pallergabor.uw.hu/androidblog/dalvik\_opcodes.html](http://pallergabor.uw.hu/androidblog/dalvik\_opcodes.html)

## HÄ±zlÄ± Yol

**Visual Studio Code** ve [APKLab](https://github.com/APKLab/APKLab) uzantÄ±sÄ±nÄ± kullanarak, herhangi bir komut Ã§alÄ±ÅŸtÄ±rmadan uygulamayÄ± **otomatik olarak decompile**, deÄŸiÅŸtirebilir, **recompile**, imzalayabilir ve yÃ¼kleyebilirsiniz.

Bu gÃ¶revi oldukÃ§a kolaylaÅŸtÄ±ran baÅŸka bir **script** [**https://github.com/ax/apk.sh**](https://github.com/ax/apk.sh)

## APK'yÄ± Decompile Et

APKTool kullanarak **smali koduna ve kaynaklarÄ±na** eriÅŸebilirsiniz:
```bash
apktool d APP.apk
```
EÄŸer **apktool** herhangi bir hata veriyorsa, [**en son sÃ¼rÃ¼mÃ¼**](https://ibotpeaches.github.io/Apktool/install/) yÃ¼klemeyi deneyin.

**BakmanÄ±z gereken bazÄ± ilginÃ§ dosyalar**:

* _res/values/strings.xml_ (ve res/values/* iÃ§indeki tÃ¼m xml'ler)
* _AndroidManifest.xml_
* _.sqlite_ veya _.db_ uzantÄ±sÄ±na sahip herhangi bir dosya

EÄŸer `apktool` uygulamayÄ± **Ã§Ã¶zÃ¼mlerken sorunlar yaÅŸÄ±yorsa**, [https://ibotpeaches.github.io/Apktool/documentation/#framework-files](https://ibotpeaches.github.io/Apktool/documentation/#framework-files) adresine bakÄ±n veya **`-r`** argÃ¼manÄ±nÄ± kullanmayÄ± deneyin (KaynaklarÄ± Ã§Ã¶zÃ¼mleme). O zaman, eÄŸer sorun bir kaynakta ve kaynak kodunda deÄŸilse, bu sorunla karÅŸÄ±laÅŸmayacaksÄ±nÄ±z (kaynaklarÄ± da decompile etmeyeceksiniz).

## Smali kodunu deÄŸiÅŸtir

**TalimatlarÄ±** **deÄŸiÅŸtirebilir**, bazÄ± deÄŸiÅŸkenlerin **deÄŸerlerini** deÄŸiÅŸtirebilir veya **yeni talimatlar** ekleyebilirsiniz. Smali kodunu [**VS Code**](https://code.visualstudio.com) kullanarak deÄŸiÅŸtiriyorum, ardÄ±ndan **smalise eklentisini** yÃ¼kleyin ve editÃ¶r size herhangi bir **talimatÄ±n yanlÄ±ÅŸ olup olmadÄ±ÄŸÄ±nÄ±** sÃ¶yleyecektir.\
BazÄ± **Ã¶rnekler** burada bulunabilir:

* [Smali deÄŸiÅŸiklik Ã¶rnekleri](smali-changes.md)
* [Google CTF 2018 - Oyun OynayalÄ±m mÄ±?](google-ctf-2018-shall-we-play-a-game.md)

Ya da [**aÅŸaÄŸÄ±da bazÄ± Smali deÄŸiÅŸikliklerinin aÃ§Ä±klandÄ±ÄŸÄ±nÄ± kontrol edebilirsiniz**](smali-changes.md#modifying-smali).

## APK'yÄ± yeniden derle

Kodu deÄŸiÅŸtirdikten sonra kodu **yeniden derleyebilirsiniz**:
```bash
apktool b . #In the folder generated when you decompiled the application
```
Yeni APK'yÄ± _**dist**_ klasÃ¶rÃ¼nÃ¼n **iÃ§inde** **derleyecektir**.

EÄŸer **apktool** bir **hata** verirse, [**en son sÃ¼rÃ¼mÃ¼**](https://ibotpeaches.github.io/Apktool/install/) yÃ¼klemeyi deneyin.

### **Yeni APK'yÄ± imzala**

Sonra, bir **anahtar** **oluÅŸturmanÄ±z** gerekiyor (bir ÅŸifre ve rastgele doldurabileceÄŸiniz bazÄ± bilgiler istenecektir):
```bash
keytool -genkey -v -keystore key.jks -keyalg RSA -keysize 2048 -validity 10000 -alias <your-alias>
```
Son olarak, **imzala** yeni APK'yÄ±:
```bash
jarsigner -keystore key.jks path/to/dist/* <your-alias>
```
### Yeni uygulamayÄ± optimize et

**zipalign**, Android uygulama (APK) dosyalarÄ±na Ã¶nemli optimizasyonlar saÄŸlayan bir arÅŸiv hizalama aracÄ±dÄ±r. [Daha fazla bilgi burada](https://developer.android.com/studio/command-line/zipalign).
```bash
zipalign [-f] [-v] <alignment> infile.apk outfile.apk
zipalign -v 4 infile.apk
```
### **Yeni APK'yÄ± imzalayÄ±n (yine mi?)**

EÄŸer **apksigner** kullanmayÄ± **tercih ediyorsanÄ±z**, zipalign ile **optimizasyonu uyguladÄ±ktan sonra apk'yÄ± imzalamalÄ±sÄ±nÄ±z**. ANCAK DÄ°KKAT EDÄ°N, UYGULAMAYI SADECE BÄ°R KEZ **jarsigner ile** (zipalign'dan Ã¶nce) veya **aspsigner ile** (zipalign'dan sonra) Ä°MZALAMALISINIZ.
```bash
apksigner sign --ks key.jks ./dist/mycompiled.apk
```
## Smali'yi DeÄŸiÅŸtirme

AÅŸaÄŸÄ±daki Hello World Java kodu iÃ§in:
```java
public static void printHelloWorld() {
System.out.println("Hello World")
}
```
Smali kodu ÅŸÃ¶yle olacaktÄ±r:
```java
.method public static printHelloWorld()V
.registers 2
sget-object v0, Ljava/lang/System;->out:Ljava/io/PrintStream;
const-string v1, "Hello World"
invoke-virtual {v0,v1}, Ljava/io/PrintStream;->println(Ljava/lang/String;)V
return-void
.end method
```
Smali talimat seti [burada](https://source.android.com/devices/tech/dalvik/dalvik-bytecode#instructions) mevcuttur.

### Hafif DeÄŸiÅŸiklikler

### Bir fonksiyon iÃ§indeki bir deÄŸiÅŸkenin baÅŸlangÄ±Ã§ deÄŸerlerini deÄŸiÅŸtirin

BazÄ± deÄŸiÅŸkenler, _const_ opcode'u kullanÄ±larak fonksiyonun baÅŸÄ±nda tanÄ±mlanÄ±r, deÄŸerlerini deÄŸiÅŸtirebilir veya yenilerini tanÄ±mlayabilirsiniz:
```bash
#Number
const v9, 0xf4240
const/4 v8, 0x1
#Strings
const-string v5, "wins"
```
### Temel Ä°ÅŸlemler
```bash
#Math
add-int/lit8 v0, v2, 0x1 #v2 + 0x1 and save it in v0
mul-int v0,v2,0x2 #v2*0x2 and save in v0

#Move the value of one object into another
move v1,v2

#Condtions
if-ge #Greater or equals
if-le #Less or equals
if-eq #Equals

#Get/Save attributes of an object
iget v0, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Save this.o inside v0
iput v0, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Save v0 inside this.o

#goto
:goto_6 #Declare this where you want to start a loop
if-ne v0, v9, :goto_6 #If not equals, go to: :goto_6
goto :goto_6 #Always go to: :goto_6
```
### Daha BÃ¼yÃ¼k DeÄŸiÅŸiklikler

### GÃ¼nlÃ¼kleme
```bash
#Log win: <number>
iget v5, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Get this.o inside v5
invoke-static {v5}, Ljava/lang/String;->valueOf(I)Ljava/lang/String; #Transform number to String
move-result-object v1 #Move to v1
const-string v5, "wins" #Save "win" inside v5
invoke-static {v5, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I #Logging "Wins: <num>"
```
Recommendations:

* EÄŸer fonksiyon iÃ§inde tanÄ±mlÄ± deÄŸiÅŸkenleri kullanacaksanÄ±z (tanÄ±mlÄ± v0,v1,v2...) bu satÄ±rlarÄ± _.local \<number>_ ile deÄŸiÅŸkenlerin tanÄ±mlarÄ± (_const v0, 0x1_) arasÄ±nda koyun.
* EÄŸer bir fonksiyonun kodunun ortasÄ±na logging kodunu koymak istiyorsanÄ±z:
* TanÄ±mlÄ± deÄŸiÅŸkenlerin sayÄ±sÄ±na 2 ekleyin: Ã–rnek: _.locals 10_'dan _.locals 12_'ye.
* Yeni deÄŸiÅŸkenler, zaten tanÄ±mlÄ± deÄŸiÅŸkenlerin sonraki numaralarÄ± olmalÄ±dÄ±r (bu Ã¶rnekte _v10_ ve _v11_ olmalÄ±dÄ±r, v0'dan baÅŸladÄ±ÄŸÄ±nÄ± unutmayÄ±n).
* Logging fonksiyonunun kodunu deÄŸiÅŸtirin ve _v10_ ve _v11_ kullanÄ±n, _v5_ ve _v1_ yerine.

### Toasting

Fonksiyonun baÅŸÄ±nda _.locals_ sayÄ±sÄ±na 3 eklemeyi unutmayÄ±n.

Bu kod, **bir fonksiyonun ortasÄ±na** eklenmek Ã¼zere hazÄ±rlanmÄ±ÅŸtÄ±r (**deÄŸiÅŸtirin** **deÄŸiÅŸkenlerin** **sayÄ±sÄ±nÄ±** gerektiÄŸi gibi). **this.o**'nun **deÄŸerini** alacak, **String**'e **dÃ¶nÃ¼ÅŸtÃ¼recek** ve ardÄ±ndan **deÄŸerini** kullanarak bir **toast** yapacaktÄ±r.
```bash
const/4 v10, 0x1
const/4 v11, 0x1
const/4 v12, 0x1
iget v10, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I
invoke-static {v10}, Ljava/lang/String;->valueOf(I)Ljava/lang/String;
move-result-object v11
invoke-static {p0, v11, v12}, Landroid/widget/Toast;->makeText(Landroid/content/Context;Ljava/lang/CharSequence;I)Landroid/widget/Toast;
move-result-object v12
invoke-virtual {v12}, Landroid/widget/Toast;->show()V
```
{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
