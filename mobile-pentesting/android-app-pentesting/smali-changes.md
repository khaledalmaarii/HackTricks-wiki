# Smali - Decompiling/\[DeÄŸiÅŸtirme]/Derleme

<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan kahraman olmak iÃ§in Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ±zÄ± gÃ¶rmek veya HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARI'na**](https://github.com/sponsors/carlospolop) gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**'u** takip edin.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR gÃ¶ndererek** paylaÅŸÄ±n.

</details>

Bazen, sizin iÃ§in gizli bilgilere eriÅŸmek iÃ§in uygulama kodunu deÄŸiÅŸtirmek ilginÃ§ olabilir (belki iyi gizlenmiÅŸ ÅŸifreler veya bayraklar). ArdÄ±ndan, apk'yÄ± decompile etmek, kodu deÄŸiÅŸtirmek ve yeniden derlemek ilginÃ§ olabilir.

**Opcodes referansÄ±:** [http://pallergabor.uw.hu/androidblog/dalvik\_opcodes.html](http://pallergabor.uw.hu/androidblog/dalvik\_opcodes.html)

## HÄ±zlÄ± Yol

**Visual Studio Code** ve [APKLab](https://github.com/APKLab/APKLab) uzantÄ±sÄ± kullanarak, herhangi bir komut Ã§alÄ±ÅŸtÄ±rmadan uygulamayÄ± **otomatik olarak decompile edebilir**, kodu **deÄŸiÅŸtirebilir**, yeniden derleyebilir, imzalayabilir ve yÃ¼kleyebilirsiniz.

Bu gÃ¶revi Ã§ok kolaylaÅŸtÄ±ran baÅŸka bir **betik** de [**https://github.com/ax/apk.sh**](https://github.com/ax/apk.sh)

## APK'yÄ± decompile etme

APKTool kullanarak **smali koduna ve kaynaklara** eriÅŸebilirsiniz:
```bash
apktool d APP.apk
```
EÄŸer **apktool** herhangi bir hata verirse, [**en son sÃ¼rÃ¼mÃ¼**](https://ibotpeaches.github.io/Apktool/install/) kurmayÄ± deneyin.

BazÄ± **ilginÃ§ dosyalara bakmanÄ±z gerekiyor**:

* _res/values/strings.xml_ (ve res/values/\* iÃ§indeki tÃ¼m xml'ler)
* _AndroidManifest.xml_
* _.sqlite_ veya _.db_ uzantÄ±lÄ± herhangi bir dosya

EÄŸer `apktool` uygulamayÄ± **Ã§Ã¶zÃ¼mlemekte sorun yaÅŸÄ±yorsa**, [https://ibotpeaches.github.io/Apktool/documentation/#framework-files](https://ibotpeaches.github.io/Apktool/documentation/#framework-files) adresine bakabilir veya **`-r`** argÃ¼manÄ±nÄ± kullanmayÄ± deneyebilirsiniz (KaynaklarÄ± Ã§Ã¶zÃ¼mleme). ArdÄ±ndan, sorun kaynaÄŸÄ± kaynak kodunda deÄŸilse, sorununuz olmayacak (kaynaklarÄ± da decompile etmeyeceksiniz).

## Smali kodunu deÄŸiÅŸtirme

**KomutlarÄ± deÄŸiÅŸtirebilir**, bazÄ± deÄŸiÅŸkenlerin **deÄŸerini deÄŸiÅŸtirebilir** veya **yeni komutlar ekleyebilirsiniz**. Ben Smali kodunu [**VS Code**](https://code.visualstudio.com) kullanarak deÄŸiÅŸtiriyorum, ardÄ±ndan **smalise eklentisini** yÃ¼klersiniz ve dÃ¼zenleyici size herhangi bir **hatalÄ± komut olduÄŸunu** sÃ¶yler.\
BazÄ± **Ã¶rnekler** burada bulunabilir:

* [Smali deÄŸiÅŸiklik Ã¶rnekleri](smali-changes.md)
* [Google CTF 2018 - Shall We Play a Game?](google-ctf-2018-shall-we-play-a-game.md)

Veya [**aÅŸaÄŸÄ±da aÃ§Ä±klanan bazÄ± Smali deÄŸiÅŸikliklerini kontrol edebilirsiniz**](smali-changes.md#modifying-smali).

## APK'yi yeniden derleme

Kodu deÄŸiÅŸtirdikten sonra, kodu **yeniden derleyebilirsiniz**. Bunun iÃ§in ÅŸu komutu kullanabilirsiniz:
```bash
apktool b . #In the folder generated when you decompiled the application
```
Yeni APK'yi **dist** klasÃ¶rÃ¼nÃ¼n **iÃ§ine derleyecektir**.

EÄŸer **apktool** bir **hata** verirse, [**en son sÃ¼rÃ¼mÃ¼**](https://ibotpeaches.github.io/Apktool/install/) **yÃ¼klemeyi** deneyin.

### **Yeni APK'yi imzalayÄ±n**

ArdÄ±ndan, bir **anahtar oluÅŸturmanÄ±z** gerekecek (bir ÅŸifre ve rastgele doldurabileceÄŸiniz bazÄ± bilgiler istenecektir):
```bash
keytool -genkey -v -keystore key.jks -keyalg RSA -keysize 2048 -validity 10000 -alias <your-alias>
```
Son olarak, yeni APK'yi **imzala**:
```bash
jarsigner -keystore key.jks path/to/dist/* <your-alias>
```
### Yeni uygulamayÄ± optimize edin

**zipalign**, Android uygulama (APK) dosyalarÄ±na Ã¶nemli bir optimizasyon saÄŸlayan bir arÅŸiv hizalama aracÄ±dÄ±r. [Daha fazla bilgi iÃ§in buraya tÄ±klayÄ±n](https://developer.android.com/studio/command-line/zipalign).
```bash
zipalign [-f] [-v] <alignment> infile.apk outfile.apk
zipalign -v 4 infile.apk
```
### **Yeni APK'yi imzalayÄ±n (tekrar?)**

EÄŸer [apksigner](https://developer.android.com/studio/command-line/) kullanmayÄ± tercih ederseniz, zipalign ile optimizasyon uyguladÄ±ktan sonra APK'yi imzalamalÄ±sÄ±nÄ±z. ANCAK YALNIZCA jarsigner ile (zipalign'den Ã¶nce) veya aspsigner ile (zipalign'den sonra) UYGULAMAYI BÄ°R KEZ Ä°MZALAMANIZ GEREKTÄ°ÄÄ°NE DÄ°KKAT EDÄ°N.
```bash
apksigner sign --ks key.jks ./dist/mycompiled.apk
```
## Smali DeÄŸiÅŸtirme

AÅŸaÄŸÄ±daki Hello World Java kodu iÃ§in:
```java
public static void printHelloWorld() {
System.out.println("Hello World")
}
```
Smali kodu ÅŸu ÅŸekilde olacaktÄ±r:
```java
.method public static printHelloWorld()V
.registers 2
sget-object v0, Ljava/lang/System;->out:Ljava/io/PrintStream;
const-string v1, "Hello World"
invoke-virtual {v0,v1}, Ljava/io/PrintStream;->println(Ljava/lang/String;)V
return-void
.end method
```
Smali talimat seti [burada](https://source.android.com/devices/tech/dalvik/dalvik-bytecode#instructions) bulunabilir.

### Hafif DeÄŸiÅŸiklikler

### Bir fonksiyon iÃ§inde bir deÄŸiÅŸkenin baÅŸlangÄ±Ã§ deÄŸerlerini deÄŸiÅŸtirme

BazÄ± deÄŸiÅŸkenler, fonksiyonun baÅŸÄ±nda _const_ opcode'unu kullanarak tanÄ±mlanÄ±r, deÄŸerlerini deÄŸiÅŸtirebilir veya yeni tanÄ±mlayabilirsiniz:
```bash
#Number
const v9, 0xf4240
const/4 v8, 0x1
#Strings
const-string v5, "wins"
```
### Temel Ä°ÅŸlemler

#### Smali DosyalarÄ±nÄ± DeÄŸiÅŸtirmek

Smali dosyalarÄ±, Android uygulamalarÄ±nÄ±n derlenmiÅŸ DEX dosyalarÄ±nÄ±n insan tarafÄ±ndan okunabilir hali olan bir dildir. Smali dosyalarÄ±nÄ± deÄŸiÅŸtirerek uygulamanÄ±n davranÄ±ÅŸÄ±nÄ± deÄŸiÅŸtirebiliriz.

Smali dosyalarÄ±nÄ± deÄŸiÅŸtirmek iÃ§in aÅŸaÄŸÄ±daki adÄ±mlarÄ± izleyebilirsiniz:

1. Ä°lgili smali dosyasÄ±nÄ± bulun ve aÃ§Ä±n.
2. Ä°stediÄŸiniz deÄŸiÅŸiklikleri yapÄ±n.
3. DosyayÄ± kaydedin ve kapatÄ±n.

#### Smali DosyalarÄ±nÄ± BirleÅŸtirmek

BazÄ± durumlarda, uygulamanÄ±n performansÄ±nÄ± artÄ±rmak veya kodu daha dÃ¼zenli hale getirmek iÃ§in smali dosyalarÄ±nÄ± birleÅŸtirmek gerekebilir. Smali dosyalarÄ±nÄ± birleÅŸtirmek iÃ§in aÅŸaÄŸÄ±daki adÄ±mlarÄ± izleyebilirsiniz:

1. Ä°lgili smali dosyalarÄ±nÄ± bulun ve aÃ§Ä±n.
2. Ä°Ã§eriklerini birleÅŸtirin.
3. DosyayÄ± kaydedin ve kapatÄ±n.

#### Smali DosyalarÄ±nÄ± AyÄ±rmak

BazÄ± durumlarda, uygulamanÄ±n karmaÅŸÄ±klÄ±ÄŸÄ±nÄ± azaltmak veya kodu daha modÃ¼ler hale getirmek iÃ§in smali dosyalarÄ±nÄ± ayÄ±rmak gerekebilir. Smali dosyalarÄ±nÄ± ayÄ±rmak iÃ§in aÅŸaÄŸÄ±daki adÄ±mlarÄ± izleyebilirsiniz:

1. Ä°lgili smali dosyalarÄ±nÄ± bulun ve aÃ§Ä±n.
2. Ä°Ã§eriklerini ayÄ±rÄ±n.
3. DosyayÄ± kaydedin ve kapatÄ±n.

#### Smali DosyalarÄ±nÄ± Yeniden AdlandÄ±rmak

Smali dosyalarÄ±nÄ± yeniden adlandÄ±rarak, uygulamanÄ±n kodunu daha anlaÅŸÄ±lÄ±r hale getirebiliriz. Smali dosyalarÄ±nÄ± yeniden adlandÄ±rmak iÃ§in aÅŸaÄŸÄ±daki adÄ±mlarÄ± izleyebilirsiniz:

1. Ä°lgili smali dosyalarÄ±nÄ± bulun ve aÃ§Ä±n.
2. Dosya adÄ±nÄ± deÄŸiÅŸtirin.
3. DosyayÄ± kaydedin ve kapatÄ±n.

#### Smali DosyalarÄ±nÄ± Silmek

BazÄ± durumlarda, uygulamanÄ±n gereksiz kodlarÄ±nÄ± temizlemek iÃ§in smali dosyalarÄ±nÄ± silebiliriz. Smali dosyalarÄ±nÄ± silmek iÃ§in aÅŸaÄŸÄ±daki adÄ±mlarÄ± izleyebilirsiniz:

1. Ä°lgili smali dosyasÄ±nÄ± bulun ve silin.
2. DosyayÄ± kalÄ±cÄ± olarak silmek iÃ§in Ã§Ã¶p kutusundan silin.

#### Smali DosyalarÄ±nÄ± OluÅŸturmak

Smali dosyalarÄ±nÄ± oluÅŸturarak, yeni bir Android uygulamasÄ± geliÅŸtirebiliriz. Smali dosyalarÄ±nÄ± oluÅŸturmak iÃ§in aÅŸaÄŸÄ±daki adÄ±mlarÄ± izleyebilirsiniz:

1. Yeni bir smali dosyasÄ± oluÅŸturun.
2. Ä°Ã§eriÄŸi dÃ¼zenleyin.
3. DosyayÄ± kaydedin ve kapatÄ±n.
```bash
#Math
add-int/lit8 v0, v2, 0x1 #v2 + 0x1 and save it in v0
mul-int v0,v2,0x2 #v2*0x2 and save in v0

#Move the value of one object into another
move v1,v2

#Condtions
if-ge #Greater or equals
if-le #Less or equals
if-eq #Equals

#Get/Save attributes of an object
iget v0, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Save this.o inside v0
iput v0, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Save v0 inside this.o

#goto
:goto_6 #Declare this where you want to start a loop
if-ne v0, v9, :goto_6 #If not equals, go to: :goto_6
goto :goto_6 #Always go to: :goto_6
```
### BÃ¼yÃ¼k DeÄŸiÅŸiklikler

### GÃ¼nlÃ¼k KayÄ±t (Logging)
```bash
#Log win: <number>
iget v5, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Get this.o inside v5
invoke-static {v5}, Ljava/lang/String;->valueOf(I)Ljava/lang/String; #Transform number to String
move-result-object v1 #Move to v1
const-string v5, "wins" #Save "win" inside v5
invoke-static {v5, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I #Logging "Wins: <num>"
```
Ã–neriler:

* Fonksiyon iÃ§inde bildirilen deÄŸiÅŸkenleri kullanacaksanÄ±z (bildirilen v0,v1,v2...), bu satÄ±rlarÄ± _.local \<number>_ ve deÄŸiÅŸkenlerin bildirimleri (_const v0, 0x1_) arasÄ±na yerleÅŸtirin.
* Bir fonksiyonun kodunun ortasÄ±na gÃ¼nlÃ¼kleme kodunu yerleÅŸtirmek istiyorsanÄ±z:
* Bildirilen deÄŸiÅŸken sayÄ±sÄ±na 2 ekleyin: Ã–rnek: _.locals 10_ yerine _.locals 12_.
* Yeni deÄŸiÅŸkenler, zaten bildirilen deÄŸiÅŸkenlerin bir sonraki numaralarÄ± olmalÄ±dÄ±r (bu Ã¶rnekte _v10_ ve _v11_ olmalÄ±dÄ±r, hatÄ±rlayÄ±n ki v0'dan baÅŸlar).
* GÃ¼nlÃ¼kleme iÅŸlevinin kodunu deÄŸiÅŸtirin ve _v5_ ve _v1_ yerine _v10_ ve _v11_ kullanÄ±n.

### Toasting

Fonksiyonun baÅŸÄ±nda _.locals_ sayÄ±sÄ±na 3 eklemeyi unutmayÄ±n.

Bu kod, bir **fonksiyonun ortasÄ±na** yerleÅŸtirilmek Ã¼zere hazÄ±rlanmÄ±ÅŸtÄ±r (**deÄŸiÅŸkenlerin** sayÄ±sÄ±nÄ± gerektiÄŸi gibi **deÄŸiÅŸtirin**). Bu kod, **this.o** deÄŸerini **String**'e dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r ve deÄŸeriyle birlikte bir **toast** yapar.
```bash
const/4 v10, 0x1
const/4 v11, 0x1
const/4 v12, 0x1
iget v10, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I
invoke-static {v10}, Ljava/lang/String;->valueOf(I)Ljava/lang/String;
move-result-object v11
invoke-static {p0, v11, v12}, Landroid/widget/Toast;->makeText(Landroid/content/Context;Ljava/lang/CharSequence;I)Landroid/widget/Toast;
move-result-object v12
invoke-virtual {v12}, Landroid/widget/Toast;->show()V
```
<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan kahraman seviyesine Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek isterseniz** veya **HackTricks'i PDF olarak indirmek isterseniz** [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)'u **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na **PR gÃ¶ndererek paylaÅŸÄ±n**.

</details>
