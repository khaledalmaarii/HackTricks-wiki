# Smali - ãƒ‡ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«/\[å¤‰æ›´]/ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

æ™‚ã«ã¯ã€éš ã•ã‚ŒãŸæƒ…å ±ï¼ˆãŠãã‚‰ãã‚ˆãé›£èª­åŒ–ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚„ãƒ•ãƒ©ã‚°ï¼‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ãŒèˆˆå‘³æ·±ã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ãã®ãŸã‚ã€apkã‚’ãƒ‡ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã€ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¦å†ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã™ã‚‹ã“ã¨ãŒèˆˆå‘³æ·±ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

**Opcodes reference:** [http://pallergabor.uw.hu/androidblog/dalvik\_opcodes.html](http://pallergabor.uw.hu/androidblog/dalvik\_opcodes.html)

## ç°¡å˜ãªæ–¹æ³•

**Visual Studio Code**ã¨[APKLab](https://github.com/APKLab/APKLab)æ‹¡å¼µæ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãªãã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’**è‡ªå‹•çš„ã«ãƒ‡ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«**ã€å¤‰æ›´ã€**å†ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«**ã€ç½²åï¼†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¾ã™ã€‚

ã“ã®ä½œæ¥­ã‚’å¤§ã„ã«ç°¡ç´ åŒ–ã™ã‚‹**ã‚¹ã‚¯ãƒªãƒ—ãƒˆ**ã¯[**https://github.com/ax/apk.sh**](https://github.com/ax/apk.sh)ã§ã™ã€‚

## APKã‚’ãƒ‡ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã™ã‚‹

APKToolã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€**smaliã‚³ãƒ¼ãƒ‰ã¨ãƒªã‚½ãƒ¼ã‚¹**ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ï¼š
```bash
apktool d APP.apk
```
If **apktool**ãŒã‚¨ãƒ©ãƒ¼ã‚’å‡ºã—ãŸå ´åˆã¯ã€[**æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³**ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã¿ã¦ãã ã•ã„](https://ibotpeaches.github.io/Apktool/install/)

**èˆˆå‘³æ·±ã„ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™**:

* _res/values/strings.xml_ï¼ˆãŠã‚ˆã³res/values/*å†…ã®ã™ã¹ã¦ã®xmlï¼‰
* _AndroidManifest.xml_
* æ‹¡å¼µå­ãŒ_.sqlite_ã¾ãŸã¯_.db_ã®ãƒ•ã‚¡ã‚¤ãƒ«

`apktool`ãŒ**ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ã‚³ãƒ¼ãƒ‰ã«å•é¡ŒãŒã‚ã‚‹å ´åˆ**ã¯ã€[https://ibotpeaches.github.io/Apktool/documentation/#framework-files](https://ibotpeaches.github.io/Apktool/documentation/#framework-files)ã‚’ç¢ºèªã™ã‚‹ã‹ã€**`-r`**ï¼ˆãƒªã‚½ãƒ¼ã‚¹ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ãªã„ï¼‰ã¨ã„ã†å¼•æ•°ã‚’ä½¿ç”¨ã—ã¦ã¿ã¦ãã ã•ã„ã€‚ãã†ã™ã‚Œã°ã€å•é¡ŒãŒãƒªã‚½ãƒ¼ã‚¹ã«ã‚ã‚Šã€ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã«ãªã„å ´åˆã¯ã€å•é¡ŒãŒç™ºç”Ÿã—ã¾ã›ã‚“ï¼ˆãƒªã‚½ãƒ¼ã‚¹ã‚‚ãƒ‡ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚Œã¾ã›ã‚“ï¼‰ã€‚

## smaliã‚³ãƒ¼ãƒ‰ã®å¤‰æ›´

**å‘½ä»¤ã‚’å¤‰æ›´**ã—ãŸã‚Šã€ã„ãã¤ã‹ã®å¤‰æ•°ã®**å€¤ã‚’å¤‰æ›´**ã—ãŸã‚Šã€æ–°ã—ã„å‘½ä»¤ã‚’**è¿½åŠ **ã—ãŸã‚Šã§ãã¾ã™ã€‚ç§ã¯[**VS Code**](https://code.visualstudio.com)ã‚’ä½¿ç”¨ã—ã¦Smaliã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã™ã€‚ãã®å¾Œã€**smaliseæ‹¡å¼µæ©Ÿèƒ½**ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã¨ã€ã‚¨ãƒ‡ã‚£ã‚¿ãŒ**å‘½ä»¤ãŒä¸æ­£ã§ã‚ã‚‹ã‹ã©ã†ã‹**ã‚’æ•™ãˆã¦ãã‚Œã¾ã™ã€‚\
ã„ãã¤ã‹ã®**ä¾‹**ã¯ã“ã“ã«ã‚ã‚Šã¾ã™:

* [Smaliå¤‰æ›´ã®ä¾‹](smali-changes.md)
* [Google CTF 2018 - Shall We Play a Game?](google-ctf-2018-shall-we-play-a-game.md)

ã¾ãŸã¯ã€[**ä»¥ä¸‹ã®Smaliå¤‰æ›´ã®èª¬æ˜ã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™**](smali-changes.md#modifying-smali)ã€‚

## APKã®å†ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«

ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã—ãŸå¾Œã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦**å†ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«**ã§ãã¾ã™:
```bash
apktool b . #In the folder generated when you decompiled the application
```
æ–°ã—ã„APKã¯_**dist**_ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã®**å†…éƒ¨**ã§**ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«**ã•ã‚Œã¾ã™ã€‚

ã‚‚ã—**apktool**ãŒ**ã‚¨ãƒ©ãƒ¼**ã‚’æŠ•ã’ãŸå ´åˆã¯ã€[**æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³**ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«](https://ibotpeaches.github.io/Apktool/install/)ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

### **æ–°ã—ã„APKã«ç½²åã™ã‚‹**

æ¬¡ã«ã€**ã‚­ãƒ¼ã‚’ç”Ÿæˆ**ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¨ãƒ©ãƒ³ãƒ€ãƒ ã«å…¥åŠ›ã§ãã‚‹ã„ãã¤ã‹ã®æƒ…å ±ã‚’æ±‚ã‚ã‚‰ã‚Œã¾ã™ï¼‰ï¼š
```bash
keytool -genkey -v -keystore key.jks -keyalg RSA -keysize 2048 -validity 10000 -alias <your-alias>
```
æœ€å¾Œã«ã€æ–°ã—ã„APKã‚’**ç½²å**ã—ã¾ã™:
```bash
jarsigner -keystore key.jks path/to/dist/* <your-alias>
```
### æ–°ã—ã„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æœ€é©åŒ–

**zipalign** ã¯ã€Android ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ (APK) ãƒ•ã‚¡ã‚¤ãƒ«ã«é‡è¦ãªæœ€é©åŒ–ã‚’æä¾›ã™ã‚‹ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ•´åˆ—ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚[ã“ã¡ã‚‰ã«è©³ç´°æƒ…å ±ãŒã‚ã‚Šã¾ã™](https://developer.android.com/studio/command-line/zipalign)ã€‚
```bash
zipalign [-f] [-v] <alignment> infile.apk outfile.apk
zipalign -v 4 infile.apk
```
### **æ–°ã—ã„APKã«ç½²åã™ã‚‹ï¼ˆå†åº¦ï¼Ÿï¼‰**

ã‚‚ã—ã‚ãªãŸãŒ**jarsigner**ã®ä»£ã‚ã‚Šã«[**apksigner**](https://developer.android.com/studio/command-line/)ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’**å¥½ã‚€**ãªã‚‰ã€**zipalignã§æœ€é©åŒ–ã‚’é©ç”¨ã—ãŸå¾Œã«apkã«ç½²åã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™**ã€‚ã—ã‹ã—ã€**ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã¯ä¸€åº¦ã ã‘ç½²åã™ã‚Œã°ã‚ˆã„ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„**ï¼ˆzipalignã®å‰ã«jarsignerã§ï¼‰ã¾ãŸã¯ï¼ˆzipalignã®å¾Œã«aspsignerã§ï¼‰ã€‚
```bash
apksigner sign --ks key.jks ./dist/mycompiled.apk
```
## Smaliã®å¤‰æ›´

æ¬¡ã®Hello World Javaã‚³ãƒ¼ãƒ‰ã®å ´åˆï¼š
```java
public static void printHelloWorld() {
System.out.println("Hello World")
}
```
Smaliã‚³ãƒ¼ãƒ‰ã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼š
```java
.method public static printHelloWorld()V
.registers 2
sget-object v0, Ljava/lang/System;->out:Ljava/io/PrintStream;
const-string v1, "Hello World"
invoke-virtual {v0,v1}, Ljava/io/PrintStream;->println(Ljava/lang/String;)V
return-void
.end method
```
The Smali instruction set is available [here](https://source.android.com/devices/tech/dalvik/dalvik-bytecode#instructions).

### Light Changes

### é–¢æ•°å†…ã®å¤‰æ•°ã®åˆæœŸå€¤ã‚’å¤‰æ›´ã™ã‚‹

ã„ãã¤ã‹ã®å¤‰æ•°ã¯ã€ã‚ªãƒšã‚³ãƒ¼ãƒ‰ _const_ ã‚’ä½¿ç”¨ã—ã¦é–¢æ•°ã®æœ€åˆã«å®šç¾©ã•ã‚Œã¦ãŠã‚Šã€ãã®å€¤ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã¾ãŸã¯ã€æ–°ã—ã„å¤‰æ•°ã‚’å®šç¾©ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ï¼š
```bash
#Number
const v9, 0xf4240
const/4 v8, 0x1
#Strings
const-string v5, "wins"
```
### åŸºæœ¬æ“ä½œ
```bash
#Math
add-int/lit8 v0, v2, 0x1 #v2 + 0x1 and save it in v0
mul-int v0,v2,0x2 #v2*0x2 and save in v0

#Move the value of one object into another
move v1,v2

#Condtions
if-ge #Greater or equals
if-le #Less or equals
if-eq #Equals

#Get/Save attributes of an object
iget v0, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Save this.o inside v0
iput v0, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Save v0 inside this.o

#goto
:goto_6 #Declare this where you want to start a loop
if-ne v0, v9, :goto_6 #If not equals, go to: :goto_6
goto :goto_6 #Always go to: :goto_6
```
### å¤§ããªå¤‰æ›´

### ãƒ­ã‚®ãƒ³ã‚°
```bash
#Log win: <number>
iget v5, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Get this.o inside v5
invoke-static {v5}, Ljava/lang/String;->valueOf(I)Ljava/lang/String; #Transform number to String
move-result-object v1 #Move to v1
const-string v5, "wins" #Save "win" inside v5
invoke-static {v5, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I #Logging "Wins: <num>"
```
Recommendations:

* é–¢æ•°å†…ã§å®£è¨€ã•ã‚ŒãŸå¤‰æ•°ï¼ˆv0,v1,v2...ï¼‰ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã€ã“ã‚Œã‚‰ã®è¡Œã‚’ _.local \<number>_ ã¨å¤‰æ•°ã®å®£è¨€ (_const v0, 0x1_) ã®é–“ã«ç½®ã„ã¦ãã ã•ã„ã€‚
* é–¢æ•°ã®ã‚³ãƒ¼ãƒ‰ã®ä¸­é–“ã«ãƒ­ã‚°è¨˜éŒ²ã‚³ãƒ¼ãƒ‰ã‚’æŒ¿å…¥ã—ãŸã„å ´åˆï¼š
* å®£è¨€ã•ã‚ŒãŸå¤‰æ•°ã®æ•°ã«2ã‚’åŠ ãˆã¾ã™ï¼šä¾‹ï¼š_.locals 10_ ã‹ã‚‰ _.locals 12_ ã¸ã€‚
* æ–°ã—ã„å¤‰æ•°ã¯ã€ã™ã§ã«å®£è¨€ã•ã‚ŒãŸå¤‰æ•°ã®æ¬¡ã®ç•ªå·ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆã“ã®ä¾‹ã§ã¯ _v10_ ã¨ _v11_ ã§ã€v0ã‹ã‚‰å§‹ã¾ã‚‹ã“ã¨ã‚’å¿˜ã‚Œãªã„ã§ãã ã•ã„ï¼‰ã€‚
* ãƒ­ã‚°è¨˜éŒ²é–¢æ•°ã®ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã€_v5_ ã¨ _v1_ ã®ä»£ã‚ã‚Šã« _v10_ ã¨ _v11_ ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

### Toasting

é–¢æ•°ã®æœ€åˆã« _.locals_ ã®æ•°ã«3ã‚’åŠ ãˆã‚‹ã“ã¨ã‚’å¿˜ã‚Œãªã„ã§ãã ã•ã„ã€‚

ã“ã®ã‚³ãƒ¼ãƒ‰ã¯ **é–¢æ•°ã®ä¸­é–“ã«æŒ¿å…¥ã™ã‚‹** ãŸã‚ã«æº–å‚™ã•ã‚Œã¦ã„ã¾ã™ï¼ˆ**å¿…è¦ã«å¿œã˜ã¦** **å¤‰æ•°** ã® **æ•°** ã‚’ **å¤‰æ›´** ã—ã¦ãã ã•ã„ï¼‰ã€‚ã“ã‚Œã¯ **this.o** ã® **å€¤** ã‚’å–å¾—ã—ã€**String** ã« **å¤‰æ›** ã—ã€ãã®å€¤ã§ **ãƒˆãƒ¼ã‚¹ãƒˆ** ã‚’ **ä½œæˆ** ã—ã¾ã™ã€‚
```bash
const/4 v10, 0x1
const/4 v11, 0x1
const/4 v12, 0x1
iget v10, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I
invoke-static {v10}, Ljava/lang/String;->valueOf(I)Ljava/lang/String;
move-result-object v11
invoke-static {p0, v11, v12}, Landroid/widget/Toast;->makeText(Landroid/content/Context;Ljava/lang/CharSequence;I)Landroid/widget/Toast;
move-result-object v12
invoke-virtual {v12}, Landroid/widget/Toast;->show()V
```
{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**Telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}
