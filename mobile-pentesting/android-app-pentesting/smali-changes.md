# Smali - Decompiling/\[Modifying]/Compiling

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

Ponekad je zanimljivo modifikovati kod aplikacije kako biste pristupili skrivenim informacijama za vas (mo쬯a dobro obfuskovane lozinke ili zastavice). Tada bi moglo biti zanimljivo dekompilirati apk, modifikovati kod i rekompilirati ga.

**Opcodes reference:** [http://pallergabor.uw.hu/androidblog/dalvik\_opcodes.html](http://pallergabor.uw.hu/androidblog/dalvik\_opcodes.html)

## Fast Way

Kori코캖enjem **Visual Studio Code** i [APKLab](https://github.com/APKLab/APKLab) ekstenzije, mo쬰te **automatski dekompilirati**, modifikovati, **rekompilirati**, potpisati i instalirati aplikaciju bez izvr코avanja bilo koje komande.

Drugi **script** koji zna캜ajno olak코ava ovaj zadatak je [**https://github.com/ax/apk.sh**](https://github.com/ax/apk.sh)

## Decompile the APK

Kori코캖enjem APKTool-a mo쬰te pristupiti **smali kodu i resursima**:
```bash
apktool d APP.apk
```
Ako **apktool** daje bilo kakvu gre코ku, poku코ajte [da instalirate **najnoviju verziju**](https://ibotpeaches.github.io/Apktool/install/)

Neki **zanimljivi fajlovi koje treba da pogledate su**:

* _res/values/strings.xml_ (i svi xml-ovi unutar res/values/\*)
* _AndroidManifest.xml_
* Bilo koji fajl sa ekstenzijom _.sqlite_ ili _.db_

Ako `apktool` ima **problema sa dekodiranjem aplikacije**, pogledajte [https://ibotpeaches.github.io/Apktool/documentation/#framework-files](https://ibotpeaches.github.io/Apktool/documentation/#framework-files) ili poku코ajte da koristite argument **`-r`** (Ne dekodiraj resurse). Tada, ako je problem bio u resursu, a ne u izvor kodu, ne캖ete imati problem (tako캠e ne캖ete dekompilirati resurse).

## Promena smali koda

Mo쬰te **promeniti** **instrukcije**, promeniti **vrednost** nekih varijabli ili **dodati** nove instrukcije. Menjam Smali kod koriste캖i [**VS Code**](https://code.visualstudio.com), zatim instalirate **smalise ekstenziju** i editor 캖e vam re캖i ako je neka **instrukcija neta캜na**.\
Neki **primeri** se mogu na캖i ovde:

* [Primeri smali promena](smali-changes.md)
* [Google CTF 2018 - Da li da igramo igru?](google-ctf-2018-shall-we-play-a-game.md)

Ili mo쬰te [**proveriti ispod neke obja코njene smali promene**](smali-changes.md#modifying-smali).

## Rekompilacija APK-a

Nakon modifikacije koda mo쬰te **rekonstruisati** kod koriste캖i:
```bash
apktool b . #In the folder generated when you decompiled the application
```
To 캖e **kompajlirati** novi APK **unutar** _**dist**_ foldera.

Ako **apktool** izbaci **gre코ku**, poku코ajte[ instalirati **najnoviju verziju**](https://ibotpeaches.github.io/Apktool/install/)

### **Potpi코ite novi APK**

Zatim, potrebno je da **generi코ete klju캜** (bi캖ete upitani za lozinku i za neke informacije koje mo쬰te popuniti nasumi캜no):
```bash
keytool -genkey -v -keystore key.jks -keyalg RSA -keysize 2048 -validity 10000 -alias <your-alias>
```
Kona캜no, **potpi코ite** novi APK:
```bash
jarsigner -keystore key.jks path/to/dist/* <your-alias>
```
### Optimize new application

**zipalign** je alat za uskla캠ivanje arhiva koji pru쬬 va쬹u optimizaciju za Android aplikacije (APK) datoteke. [More information here](https://developer.android.com/studio/command-line/zipalign).
```bash
zipalign [-f] [-v] <alignment> infile.apk outfile.apk
zipalign -v 4 infile.apk
```
### **Potpi코ite novi APK (ponovo?)**

Ako **preferirate** da koristite [**apksigner**](https://developer.android.com/studio/command-line/) umesto jarsigner, **trebalo bi da potpi코ete apk** nakon primene **optimizacije sa** zipalign. ALI OBRAZITE PA콯NJU DA TREBA DA **POTPIETE APLIKACIJU SAMO JEDNOM** SA jarsigner (pre zipalign) ILI SA aspsigner (posle zipalign).
```bash
apksigner sign --ks key.jks ./dist/mycompiled.apk
```
## Modifying Smali

Za slede캖i Hello World Java kod:
```java
public static void printHelloWorld() {
System.out.println("Hello World")
}
```
Smali kod bi bio:
```java
.method public static printHelloWorld()V
.registers 2
sget-object v0, Ljava/lang/System;->out:Ljava/io/PrintStream;
const-string v1, "Hello World"
invoke-virtual {v0,v1}, Ljava/io/PrintStream;->println(Ljava/lang/String;)V
return-void
.end method
```
Skup instrukcija Smali je dostupan [ovde](https://source.android.com/devices/tech/dalvik/dalvik-bytecode#instructions).

### Laka promena

### Izmenite po캜etne vrednosti promenljive unutar funkcije

Neke promenljive su definisane na po캜etku funkcije koriste캖i opcode _const_, mo쬰te izmeniti njihove vrednosti, ili mo쬰te definisati nove:
```bash
#Number
const v9, 0xf4240
const/4 v8, 0x1
#Strings
const-string v5, "wins"
```
### Osnovne Operacije
```bash
#Math
add-int/lit8 v0, v2, 0x1 #v2 + 0x1 and save it in v0
mul-int v0,v2,0x2 #v2*0x2 and save in v0

#Move the value of one object into another
move v1,v2

#Condtions
if-ge #Greater or equals
if-le #Less or equals
if-eq #Equals

#Get/Save attributes of an object
iget v0, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Save this.o inside v0
iput v0, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Save v0 inside this.o

#goto
:goto_6 #Declare this where you want to start a loop
if-ne v0, v9, :goto_6 #If not equals, go to: :goto_6
goto :goto_6 #Always go to: :goto_6
```
### Ve캖e promene

### Zapisivanje
```bash
#Log win: <number>
iget v5, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Get this.o inside v5
invoke-static {v5}, Ljava/lang/String;->valueOf(I)Ljava/lang/String; #Transform number to String
move-result-object v1 #Move to v1
const-string v5, "wins" #Save "win" inside v5
invoke-static {v5, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I #Logging "Wins: <num>"
```
Preporuke:

* Ako planirate da koristite deklarisane promenljive unutar funkcije (deklarisane v0,v1,v2...) stavite ove linije izme캠u _.local \<broj>_ i deklaracija promenljivih (_const v0, 0x1_)
* Ako 쬰lite da stavite kod za logovanje u sredinu koda funkcije:
* Dodajte 2 broju deklarisanih promenljivih: npr: od _.locals 10_ do _.locals 12_
* Nove promenljive treba da budu slede캖i brojevi ve캖 deklarisanih promenljivih (u ovom primeru treba da budu _v10_ i _v11_, zapamtite da po캜inje od v0).
* Promenite kod funkcije za logovanje i koristite _v10_ i _v11_ umesto _v5_ i _v1_.

### Toasting

Zapamtite da dodate 3 broju _.locals_ na po캜etku funkcije.

Ovaj kod je pripremljen da bude umetnut u **sredinu funkcije** (**promenite** broj **promenljivih** po potrebi). Uze캖e **vrednost ovog.o**, **transformisa캖e** je u **String** i zatim **napraviti** **toast** sa njenom vredno코캖u.
```bash
const/4 v10, 0x1
const/4 v11, 0x1
const/4 v12, 0x1
iget v10, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I
invoke-static {v10}, Ljava/lang/String;->valueOf(I)Ljava/lang/String;
move-result-object v11
invoke-static {p0, v11, v12}, Landroid/widget/Toast;->makeText(Landroid/content/Context;Ljava/lang/CharSequence;I)Landroid/widget/Toast;
move-result-object v12
invoke-virtual {v12}, Landroid/widget/Toast;->show()V
```
{% hint style="success" %}
U캜ite i ve쬭ajte AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
U캜ite i ve쬭ajte GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr쬴te HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
