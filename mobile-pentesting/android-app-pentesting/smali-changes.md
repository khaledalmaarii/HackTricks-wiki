# Smali - åç¼–è¯‘/\[ä¿®æ”¹]/ç¼–è¯‘

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

æœ‰æ—¶ä¿®æ”¹åº”ç”¨ç¨‹åºä»£ç ä»¥è®¿é—®éšè—ä¿¡æ¯ï¼ˆå¯èƒ½æ˜¯ç»è¿‡è‰¯å¥½æ··æ·†çš„å¯†ç æˆ–æ ‡å¿—ï¼‰æ˜¯å¾ˆæœ‰è¶£çš„ã€‚ç„¶åï¼Œåç¼–è¯‘ apkã€ä¿®æ”¹ä»£ç å¹¶é‡æ–°ç¼–è¯‘å¯èƒ½ä¼šå¾ˆæœ‰è¶£ã€‚

**æ“ä½œç å‚è€ƒï¼š** [http://pallergabor.uw.hu/androidblog/dalvik\_opcodes.html](http://pallergabor.uw.hu/androidblog/dalvik\_opcodes.html)

## å¿«é€Ÿæ–¹æ³•

ä½¿ç”¨ **Visual Studio Code** å’Œ [APKLab](https://github.com/APKLab/APKLab) æ‰©å±•ï¼Œæ‚¨å¯ä»¥ **è‡ªåŠ¨åç¼–è¯‘**ã€ä¿®æ”¹ã€**é‡æ–°ç¼–è¯‘**ã€ç­¾åå¹¶å®‰è£…åº”ç”¨ç¨‹åºï¼Œè€Œæ— éœ€æ‰§è¡Œä»»ä½•å‘½ä»¤ã€‚

å¦ä¸€ä¸ªå¤§å¤§ç®€åŒ–æ­¤ä»»åŠ¡çš„ **è„šæœ¬** æ˜¯ [**https://github.com/ax/apk.sh**](https://github.com/ax/apk.sh)

## åç¼–è¯‘ APK

ä½¿ç”¨ APKToolï¼Œæ‚¨å¯ä»¥è®¿é—® **smali ä»£ç å’Œèµ„æº**ï¼š
```bash
apktool d APP.apk
```
å¦‚æœ **apktool** ç»™ä½ ä»»ä½•é”™è¯¯ï¼Œè¯·å°è¯•[å®‰è£… **æœ€æ–°ç‰ˆæœ¬**](https://ibotpeaches.github.io/Apktool/install/)

ä¸€äº› **ä½ åº”è¯¥æŸ¥çœ‹çš„æœ‰è¶£æ–‡ä»¶**ï¼š

* _res/values/strings.xml_ï¼ˆä»¥åŠ res/values/* ä¸­çš„æ‰€æœ‰ xmlï¼‰
* _AndroidManifest.xml_
* ä»»ä½•æ‰©å±•åä¸º _.sqlite_ æˆ– _.db_ çš„æ–‡ä»¶

å¦‚æœ `apktool` åœ¨ **è§£ç åº”ç”¨ç¨‹åºæ—¶é‡åˆ°é—®é¢˜**ï¼Œè¯·æŸ¥çœ‹ [https://ibotpeaches.github.io/Apktool/documentation/#framework-files](https://ibotpeaches.github.io/Apktool/documentation/#framework-files) æˆ–å°è¯•ä½¿ç”¨å‚æ•° **`-r`**ï¼ˆä¸è§£ç èµ„æºï¼‰ã€‚ç„¶åï¼Œå¦‚æœé—®é¢˜å‡ºåœ¨èµ„æºè€Œä¸æ˜¯æºä»£ç ä¸­ï¼Œä½ å°±ä¸ä¼šé‡åˆ°è¿™ä¸ªé—®é¢˜ï¼ˆä½ ä¹Ÿä¸ä¼šåç¼–è¯‘èµ„æºï¼‰ã€‚

## ä¿®æ”¹ smali ä»£ç 

ä½ å¯ä»¥ **æ›´æ”¹** **æŒ‡ä»¤**ï¼Œæ›´æ”¹æŸäº›å˜é‡çš„ **å€¼** æˆ– **æ·»åŠ ** æ–°æŒ‡ä»¤ã€‚æˆ‘ä½¿ç”¨ [**VS Code**](https://code.visualstudio.com) æ›´æ”¹ Smali ä»£ç ï¼Œç„¶åå®‰è£… **smalise æ‰©å±•**ï¼Œç¼–è¾‘å™¨ä¼šå‘Šè¯‰ä½ æ˜¯å¦æœ‰ä»»ä½• **æŒ‡ä»¤ä¸æ­£ç¡®**ã€‚\
ä¸€äº› **ç¤ºä¾‹** å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ï¼š

* [Smali æ›´æ”¹ç¤ºä¾‹](smali-changes.md)
* [Google CTF 2018 - Shall We Play a Game?](google-ctf-2018-shall-we-play-a-game.md)

æˆ–è€…ä½ å¯ä»¥ [**æŸ¥çœ‹ä¸‹é¢ä¸€äº› Smali æ›´æ”¹çš„è§£é‡Š**](smali-changes.md#modifying-smali)ã€‚

## é‡æ–°ç¼–è¯‘ APK

åœ¨ä¿®æ”¹ä»£ç åï¼Œä½ å¯ä»¥ä½¿ç”¨ **é‡æ–°ç¼–è¯‘** ä»£ç ï¼š
```bash
apktool b . #In the folder generated when you decompiled the application
```
å®ƒå°†**ç¼–è¯‘**æ–°çš„APK**åœ¨**_**dist**_æ–‡ä»¶å¤¹ä¸­ã€‚

å¦‚æœ**apktool**æŠ›å‡º**é”™è¯¯**ï¼Œè¯·å°è¯•[å®‰è£…**æœ€æ–°ç‰ˆæœ¬**](https://ibotpeaches.github.io/Apktool/install/)

### **ç­¾ç½²æ–°çš„APK**

ç„¶åï¼Œæ‚¨éœ€è¦**ç”Ÿæˆä¸€ä¸ªå¯†é’¥**ï¼ˆç³»ç»Ÿä¼šè¦æ±‚æ‚¨è¾“å…¥å¯†ç å’Œä¸€äº›æ‚¨å¯ä»¥éšæœºå¡«å†™çš„ä¿¡æ¯ï¼‰ï¼š
```bash
keytool -genkey -v -keystore key.jks -keyalg RSA -keysize 2048 -validity 10000 -alias <your-alias>
```
æœ€åï¼Œ**ç­¾å**æ–°çš„APKï¼š
```bash
jarsigner -keystore key.jks path/to/dist/* <your-alias>
```
### ä¼˜åŒ–æ–°åº”ç”¨ç¨‹åº

**zipalign** æ˜¯ä¸€ä¸ªå½’æ¡£å¯¹é½å·¥å…·ï¼Œä¸º Android åº”ç”¨ç¨‹åº (APK) æ–‡ä»¶æä¾›é‡è¦çš„ä¼˜åŒ–ã€‚[æ›´å¤šä¿¡æ¯åœ¨è¿™é‡Œ](https://developer.android.com/studio/command-line/zipalign).
```bash
zipalign [-f] [-v] <alignment> infile.apk outfile.apk
zipalign -v 4 infile.apk
```
### **å†æ¬¡ç­¾ç½²æ–°çš„APKï¼ˆï¼Ÿï¼‰**

å¦‚æœæ‚¨**æ›´å–œæ¬¢**ä½¿ç”¨ [**apksigner**](https://developer.android.com/studio/command-line/) è€Œä¸æ˜¯ jarsignerï¼Œ**æ‚¨åº”è¯¥åœ¨åº”ç”¨äº†** zipalign **çš„ä¼˜åŒ–åç­¾ç½²apk**ã€‚ä½†è¯·æ³¨æ„ï¼Œæ‚¨åªéœ€**ä½¿ç”¨jarsignerï¼ˆåœ¨zipalignä¹‹å‰ï¼‰æˆ–ä½¿ç”¨aspsignerï¼ˆåœ¨zipalignä¹‹åï¼‰ç­¾ç½²åº”ç”¨ç¨‹åºä¸€æ¬¡**ã€‚
```bash
apksigner sign --ks key.jks ./dist/mycompiled.apk
```
## ä¿®æ”¹ Smali

å¯¹äºä»¥ä¸‹ Hello World Java ä»£ç ï¼š
```java
public static void printHelloWorld() {
System.out.println("Hello World")
}
```
Smaliä»£ç å°†æ˜¯ï¼š
```java
.method public static printHelloWorld()V
.registers 2
sget-object v0, Ljava/lang/System;->out:Ljava/io/PrintStream;
const-string v1, "Hello World"
invoke-virtual {v0,v1}, Ljava/io/PrintStream;->println(Ljava/lang/String;)V
return-void
.end method
```
The Smali instruction set is available [here](https://source.android.com/devices/tech/dalvik/dalvik-bytecode#instructions).

### Light Changes

### ä¿®æ”¹å‡½æ•°å†…éƒ¨å˜é‡çš„åˆå§‹å€¼

ä¸€äº›å˜é‡åœ¨å‡½æ•°å¼€å§‹æ—¶ä½¿ç”¨æ“ä½œç  _const_ å®šä¹‰ï¼Œæ‚¨å¯ä»¥ä¿®æ”¹å…¶å€¼ï¼Œæˆ–è€…å¯ä»¥å®šä¹‰æ–°çš„å€¼ï¼š
```bash
#Number
const v9, 0xf4240
const/4 v8, 0x1
#Strings
const-string v5, "wins"
```
### åŸºæœ¬æ“ä½œ
```bash
#Math
add-int/lit8 v0, v2, 0x1 #v2 + 0x1 and save it in v0
mul-int v0,v2,0x2 #v2*0x2 and save in v0

#Move the value of one object into another
move v1,v2

#Condtions
if-ge #Greater or equals
if-le #Less or equals
if-eq #Equals

#Get/Save attributes of an object
iget v0, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Save this.o inside v0
iput v0, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Save v0 inside this.o

#goto
:goto_6 #Declare this where you want to start a loop
if-ne v0, v9, :goto_6 #If not equals, go to: :goto_6
goto :goto_6 #Always go to: :goto_6
```
### æ›´å¤§çš„å˜åŒ–

### æ—¥å¿—è®°å½•
```bash
#Log win: <number>
iget v5, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Get this.o inside v5
invoke-static {v5}, Ljava/lang/String;->valueOf(I)Ljava/lang/String; #Transform number to String
move-result-object v1 #Move to v1
const-string v5, "wins" #Save "win" inside v5
invoke-static {v5, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I #Logging "Wins: <num>"
```
æ¨èï¼š

* å¦‚æœæ‚¨æ‰“ç®—åœ¨å‡½æ•°å†…éƒ¨ä½¿ç”¨å£°æ˜çš„å˜é‡ï¼ˆå£°æ˜ v0,v1,v2...ï¼‰ï¼Œè¯·å°†è¿™äº›è¡Œæ”¾åœ¨ _.local \<number>_ å’Œå˜é‡å£°æ˜ (_const v0, 0x1_) ä¹‹é—´ã€‚
* å¦‚æœæ‚¨æƒ³åœ¨å‡½æ•°ä»£ç ä¸­é—´æ”¾ç½®æ—¥å¿—è®°å½•ä»£ç ï¼š
* å°†å£°æ˜çš„å˜é‡æ•°é‡åŠ  2ï¼šä¾‹å¦‚ï¼Œä» _.locals 10_ åˆ° _.locals 12_ã€‚
* æ–°å˜é‡åº”ä¸ºå·²å£°æ˜å˜é‡çš„ä¸‹ä¸€ä¸ªæ•°å­—ï¼ˆåœ¨æ­¤ç¤ºä¾‹ä¸­åº”ä¸º _v10_ å’Œ _v11_ï¼Œè¯·è®°ä½å®ƒä» v0 å¼€å§‹ï¼‰ã€‚
* æ›´æ”¹æ—¥å¿—è®°å½•å‡½æ•°çš„ä»£ç ï¼Œå¹¶ä½¿ç”¨ _v10_ å’Œ _v11_ æ›¿ä»£ _v5_ å’Œ _v1_ã€‚

### Toasting

è¯·è®°å¾—åœ¨å‡½æ•°å¼€å§‹æ—¶å°† _.locals çš„æ•°é‡åŠ  3ã€‚

æ­¤ä»£ç å‡†å¤‡æ’å…¥åˆ° **å‡½æ•°çš„ä¸­é—´**ï¼ˆ**æ ¹æ®éœ€è¦æ›´æ”¹** **å˜é‡** çš„ **æ•°é‡**ï¼‰ã€‚å®ƒå°†è·å– **this.o** çš„ **å€¼**ï¼Œ**è½¬æ¢** ä¸º **String**ï¼Œç„¶å **åˆ¶ä½œ** ä¸€ä¸ª **toast**ï¼Œå…¶å€¼ä¸ºã€‚
```bash
const/4 v10, 0x1
const/4 v11, 0x1
const/4 v12, 0x1
iget v10, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I
invoke-static {v10}, Ljava/lang/String;->valueOf(I)Ljava/lang/String;
move-result-object v11
invoke-static {p0, v11, v12}, Landroid/widget/Toast;->makeText(Landroid/content/Context;Ljava/lang/CharSequence;I)Landroid/widget/Toast;
move-result-object v12
invoke-virtual {v12}, Landroid/widget/Toast;->show()V
```
{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
