# Smali - Dekompilacija/\[Modifikacija]/Kompilacija

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

Ponekad je interesantno modifikovati kod aplikacije kako biste pristupili skrivenim informacijama (mo쬯a dobro obfuskirane lozinke ili zastavice). Zatim, mo쬰 biti interesantno dekompilirati apk, modifikovati kod i ponovo ga kompilirati.

**Referenca za opcode-ove:** [http://pallergabor.uw.hu/androidblog/dalvik\_opcodes.html](http://pallergabor.uw.hu/androidblog/dalvik\_opcodes.html)

## Brzi na캜in

Koriste캖i **Visual Studio Code** i ekstenziju [APKLab](https://github.com/APKLab/APKLab), mo쬰te **automatski dekompilirati**, modifikovati, **rekompilirati**, potpisati i instalirati aplikaciju bez izvr코avanja bilo koje komande.

Jo코 jedan **skript** koji olak코ava ovaj zadatak je [**https://github.com/ax/apk.sh**](https://github.com/ax/apk.sh)

## Dekompilacija APK-a

Kori코캖enjem APKTool-a mo쬰te pristupiti **smali kodu i resursima**:
```bash
apktool d APP.apk
```
Ako **apktool** prika쬰 bilo kakvu gre코ku, poku코ajte [instalirati **najnoviju verziju**](https://ibotpeaches.github.io/Apktool/install/).

Neki **zanimljivi fajlovi koje biste trebali pogledati su**:

* _res/values/strings.xml_ (i svi xml fajlovi unutar res/values/\*)
* _AndroidManifest.xml_
* Svaki fajl sa ekstenzijom _.sqlite_ ili _.db_

Ako `apktool` ima **problema sa dekodiranjem aplikacije**, pogledajte [https://ibotpeaches.github.io/Apktool/documentation/#framework-files](https://ibotpeaches.github.io/Apktool/documentation/#framework-files) ili poku코ajte koristiti argument **`-r`** (Ne dekodiraj resurse). Tada, ako je problem u resursu, a ne u izvornom kodu, ne캖ete imati problem (tako캠e ne캖ete dekompajlirati resurse).

## Promena smali koda

Mo쬰te **promeniti** **instrukcije**, promeniti **vrednost** nekih promenljivih ili **dodati** nove instrukcije. Ja menjam Smali kod koriste캖i [**VS Code**](https://code.visualstudio.com), zatim instalirate **smalise ekstenziju** i editor 캖e vam re캖i ako je neka **instrukcija neispravna**.\
Neki **primeri** mogu se na캖i ovde:

* [Primeri promena Smali koda](smali-changes.md)
* [Google CTF 2018 - Shall We Play a Game?](google-ctf-2018-shall-we-play-a-game.md)

Ili mo쬰te [**proveriti ispod obja코njenja nekih promena Smali koda**](smali-changes.md#modifying-smali).

## Rekompajliranje APK-a

Nakon 코to izmenite kod, mo쬰te **rekompajlirati** kod koriste캖i:
```bash
apktool b . #In the folder generated when you decompiled the application
```
Bi캖e **kompajliran** novi APK **unutar** fascikle _**dist**_.

Ako **apktool** prika쬰 **gre코ku**, poku코ajte [instalirati **najnoviju verziju**](https://ibotpeaches.github.io/Apktool/install/)

### **Potpi코ite novi APK**

Zatim, trebate **generisati klju캜** (bi캖e vam zatra쬰na lozinka i neke informacije koje mo쬰te popuniti nasumi캜no):
```bash
keytool -genkey -v -keystore key.jks -keyalg RSA -keysize 2048 -validity 10000 -alias <your-alias>
```
Na kraju, **potpi코ite** novi APK:
```bash
jarsigner -keystore key.jks path/to/dist/* <your-alias>
```
### Optimizujte novu aplikaciju

**zipalign** je alat za poravnanje arhive koji pru쬬 va쬹u optimizaciju Android aplikacija (APK) datotekama. [Vi코e informacija ovde](https://developer.android.com/studio/command-line/zipalign).
```bash
zipalign [-f] [-v] <alignment> infile.apk outfile.apk
zipalign -v 4 infile.apk
```
### **Potpi코ite novi APK (ponovo?)**

Ako **preferirate** da koristite [**apksigner**](https://developer.android.com/studio/command-line/) umesto jarsigner-a, **trebali biste potpisati apk** nakon primene **optimizacije sa** zipalingom. ALI OBRATITE PA콯NJU DA SAMO JEDNOM TREBA DA **POTPISUJETE APLIKACIJU** SA jarsigner-om (pre zipaligna) ILI SA apksigner-om (nakon zipalinga).
```bash
apksigner sign --ks key.jks ./dist/mycompiled.apk
```
## Modifikacija Smali koda

Za slede캖i Hello World Java kod:
```java
public static void printHelloWorld() {
System.out.println("Hello World")
}
```
Smali kod bi bio:
```java
.method public static printHelloWorld()V
.registers 2
sget-object v0, Ljava/lang/System;->out:Ljava/io/PrintStream;
const-string v1, "Hello World"
invoke-virtual {v0,v1}, Ljava/io/PrintStream;->println(Ljava/lang/String;)V
return-void
.end method
```
Smali instrukcioni set je dostupan [ovde](https://source.android.com/devices/tech/dalvik/dalvik-bytecode#instructions).

### Lagane promene

### Izmena po캜etnih vrednosti promenljive unutar funkcije

Neke promenljive su definisane na po캜etku funkcije koriste캖i opcode _const_, mo쬰te izmeniti njihove vrednosti ili definisati nove:
```bash
#Number
const v9, 0xf4240
const/4 v8, 0x1
#Strings
const-string v5, "wins"
```
### Osnovne operacije

#### Dodavanje instrukcija

Da biste dodali nove instrukcije u smali kod, pratite ove korake:

1. Prona캠ite mesto u kodu gde 쬰lite da dodate instrukciju.
2. Napi코ite smali kod za 쬰ljenu instrukciju.
3. Ubacite novu instrukciju na odgovaraju캖e mesto u smali kodu.

Na primer, ako 쬰lite da dodate instrukciju za ispisivanje teksta na ekranu, mo쬰te koristiti slede캖i smali kod:

```smali
const-string v0, "Hello, World!"
invoke-static {v0}, Landroid/util/Log;->i(Ljava/lang/String;)I
```

Ovaj kod 캖e ispisati "Hello, World!" u logu.

#### Izmena instrukcija

Da biste izmenili postoje캖u instrukciju u smali kodu, pratite ove korake:

1. Prona캠ite instrukciju koju 쬰lite da izmenite.
2. Izmenite odgovaraju캖i deo smali koda.
3. Sa캜uvajte izmene.

Na primer, ako 쬰lite da izmenite instrukciju koja proverava da li je broj ve캖i od nule, mo쬰te koristiti slede캖i smali kod:

```smali
const v0, 10
if-gt v0, v1, :greater_than_zero
```

Ovaj kod 캖e proveriti da li je vrednost u registru v0 ve캖a od nule.

#### Brisanje instrukcija

Da biste obrisali instrukciju iz smali koda, pratite ove korake:

1. Prona캠ite instrukciju koju 쬰lite da obri코ete.
2. Uklonite odgovaraju캖i deo smali koda.
3. Sa캜uvajte izmene.

Na primer, ako 쬰lite da obri코ete instrukciju koja postavlja vrednost registra na 0, mo쬰te koristiti slede캖i smali kod:

```smali
const v0, 0
```

Ovaj kod 캖e postaviti vrednost registra v0 na 0.

#### Zamena instrukcija

Da biste zamenili instrukciju u smali kodu, pratite ove korake:

1. Prona캠ite instrukciju koju 쬰lite da zamenite.
2. Napi코ite smali kod za 쬰ljenu instrukciju.
3. Zamenite postoje캖u instrukciju novom instrukcijom.
4. Sa캜uvajte izmene.

Na primer, ako 쬰lite da zamenite instrukciju koja proverava da li je broj jednak nuli, mo쬰te koristiti slede캖i smali kod:

```smali
const v0, 0
if-eqz v0, :equal_to_zero
```

Ovaj kod 캖e proveriti da li je vrednost u registru v0 jednaka nuli.
```bash
#Math
add-int/lit8 v0, v2, 0x1 #v2 + 0x1 and save it in v0
mul-int v0,v2,0x2 #v2*0x2 and save in v0

#Move the value of one object into another
move v1,v2

#Condtions
if-ge #Greater or equals
if-le #Less or equals
if-eq #Equals

#Get/Save attributes of an object
iget v0, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Save this.o inside v0
iput v0, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Save v0 inside this.o

#goto
:goto_6 #Declare this where you want to start a loop
if-ne v0, v9, :goto_6 #If not equals, go to: :goto_6
goto :goto_6 #Always go to: :goto_6
```
### Ve캖e promene

### Pisanje logova
```bash
#Log win: <number>
iget v5, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Get this.o inside v5
invoke-static {v5}, Ljava/lang/String;->valueOf(I)Ljava/lang/String; #Transform number to String
move-result-object v1 #Move to v1
const-string v5, "wins" #Save "win" inside v5
invoke-static {v5, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I #Logging "Wins: <num>"
```
Preporuke:

* Ako 캖ete koristiti deklarisane promenljive unutar funkcije (deklarisane v0,v1,v2...), stavite ove linije izme캠u _.local \<broj>_ i deklaracija promenljivih (_const v0, 0x1_)
* Ako 쬰lite da ubacite kod za bele쬰nje u sredinu koda funkcije:
* Dodajte 2 broju deklarisanih promenljivih: Na primer, od _.locals 10_ do _.locals 12_
* Nove promenljive treba da budu slede캖i brojevi ve캖 deklarisanih promenljivih (u ovom primeru bi trebalo da budu _v10_ i _v11_, zapamtite da po캜inje od v0).
* Promenite kod funkcije za bele쬰nje i koristite _v10_ i _v11_ umesto _v5_ i _v1_.

### Toastovanje

Ne zaboravite da dodate 3 broju _.locals_ na po캜etku funkcije.

Ovaj kod je pripremljen da se ubaci u **sredinu funkcije** (**promenite** broj **promenljivih** po potrebi). Uze캖e **vrednost this.o**, **pretvoriti** je u **String** i zatim **napraviti** toast sa njenom vredno코캖u.
```bash
const/4 v10, 0x1
const/4 v11, 0x1
const/4 v12, 0x1
iget v10, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I
invoke-static {v10}, Ljava/lang/String;->valueOf(I)Ljava/lang/String;
move-result-object v11
invoke-static {p0, v11, v12}, Landroid/widget/Toast;->makeText(Landroid/content/Context;Ljava/lang/CharSequence;I)Landroid/widget/Toast;
move-result-object v12
invoke-virtual {v12}, Landroid/widget/Toast;->show()V
```
<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRETPLATU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
