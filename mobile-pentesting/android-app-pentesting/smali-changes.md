# Smali - Decompiling/\[Modifying]/Compiling

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

ë•Œë•Œë¡œ ìˆ¨ê²¨ì§„ ì •ë³´ë¥¼ ì–»ê¸° ìœ„í•´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œë¥¼ ìˆ˜ì •í•˜ëŠ” ê²ƒì´ í¥ë¯¸ë¡œìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤(ì•„ë§ˆë„ ì˜ ë‚œë…í™”ëœ ë¹„ë°€ë²ˆí˜¸ë‚˜ í”Œë˜ê·¸). ê·¸ëŸ° ë‹¤ìŒ, apkë¥¼ ë””ì»´íŒŒì¼í•˜ê³  ì½”ë“œë¥¼ ìˆ˜ì •í•œ í›„ ë‹¤ì‹œ ì»´íŒŒì¼í•˜ëŠ” ê²ƒì´ í¥ë¯¸ë¡œìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**Opcodes reference:** [http://pallergabor.uw.hu/androidblog/dalvik\_opcodes.html](http://pallergabor.uw.hu/androidblog/dalvik\_opcodes.html)

## Fast Way

**Visual Studio Code**ì™€ [APKLab](https://github.com/APKLab/APKLab) í™•ì¥ì„ ì‚¬ìš©í•˜ë©´ **ìë™ìœ¼ë¡œ ë””ì»´íŒŒì¼**, ìˆ˜ì •, **ì¬ì»´íŒŒì¼**, ì„œëª… ë° ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì„¤ì¹˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì–´ë–¤ ëª…ë ¹ë„ ì‹¤í–‰í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.

ì´ ì‘ì—…ì„ ë§ì´ ìš©ì´í•˜ê²Œ í•˜ëŠ” ë˜ ë‹¤ë¥¸ **ìŠ¤í¬ë¦½íŠ¸**ëŠ” [**https://github.com/ax/apk.sh**](https://github.com/ax/apk.sh)ì…ë‹ˆë‹¤.

## Decompile the APK

APKToolì„ ì‚¬ìš©í•˜ë©´ **smali ì½”ë“œì™€ ë¦¬ì†ŒìŠ¤**ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
apktool d APP.apk
```
If **apktool** gives you any error, try[ installing the **latest version**](https://ibotpeaches.github.io/Apktool/install/)

Some **interesting files you should look are**:

* _res/values/strings.xml_ (and all xmls inside res/values/\*)
* _AndroidManifest.xml_
* Any file with extension _.sqlite_ or _.db_

If `apktool` has **problems decoding the application** take a look to [https://ibotpeaches.github.io/Apktool/documentation/#framework-files](https://ibotpeaches.github.io/Apktool/documentation/#framework-files) or try using the argument **`-r`** (Do not decode resources). Then, if the problem was in a resource and not in the source code, you won't have the problem (you won't also decompile the resources).

## Change smali code

You can **change** **instructions**, change the **value** of some variables or **add** new instructions. I change the Smali code using [**VS Code**](https://code.visualstudio.com), you then install the **smalise extension** and the editor will tell you if any **instruction is incorrect**.\
Some **examples** can be found here:

* [Smali changes examples](smali-changes.md)
* [Google CTF 2018 - Shall We Play a Game?](google-ctf-2018-shall-we-play-a-game.md)

Or you can [**check below some Smali changes explained**](smali-changes.md#modifying-smali).

## Recompile the APK

After modifying the code you can **recompile** the code using:
```bash
apktool b . #In the folder generated when you decompiled the application
```
ìƒˆ APKëŠ” _**dist**_ í´ë” **ë‚´ë¶€**ì— **ì»´íŒŒì¼**ë©ë‹ˆë‹¤.

ë§Œì•½ **apktool**ì´ **ì˜¤ë¥˜**ë¥¼ ë°œìƒì‹œí‚¤ë©´, [**ìµœì‹  ë²„ì „**](https://ibotpeaches.github.io/Apktool/install/)ì„ ì„¤ì¹˜í•´ ë³´ì„¸ìš”.

### **ìƒˆ APK ì„œëª…í•˜ê¸°**

ê·¸ ë‹¤ìŒ, **í‚¤ë¥¼ ìƒì„±**í•´ì•¼ í•©ë‹ˆë‹¤(ë¹„ë°€ë²ˆí˜¸ì™€ ë¬´ì‘ìœ„ë¡œ ì…ë ¥í•  ìˆ˜ ìˆëŠ” ëª‡ ê°€ì§€ ì •ë³´ê°€ ìš”ì²­ë©ë‹ˆë‹¤):
```bash
keytool -genkey -v -keystore key.jks -keyalg RSA -keysize 2048 -validity 10000 -alias <your-alias>
```
ë§ˆì§€ë§‰ìœ¼ë¡œ, **ì„œëª…**í•˜ì—¬ ìƒˆë¡œìš´ APKë¥¼ ë§Œë“­ë‹ˆë‹¤:
```bash
jarsigner -keystore key.jks path/to/dist/* <your-alias>
```
### ìƒˆë¡œìš´ ì• í”Œë¦¬ì¼€ì´ì…˜ ìµœì í™”

**zipalign**ì€ Android ì• í”Œë¦¬ì¼€ì´ì…˜ (APK) íŒŒì¼ì— ì¤‘ìš”í•œ ìµœì í™”ë¥¼ ì œê³µí•˜ëŠ” ì•„ì¹´ì´ë¸Œ ì •ë ¬ ë„êµ¬ì…ë‹ˆë‹¤. [ìì„¸í•œ ì •ë³´ëŠ” ì—¬ê¸°](https://developer.android.com/studio/command-line/zipalign)ì—ì„œ í™•ì¸í•˜ì„¸ìš”.
```bash
zipalign [-f] [-v] <alignment> infile.apk outfile.apk
zipalign -v 4 infile.apk
```
### **ìƒˆ APK ì„œëª…í•˜ê¸° (ë‹¤ì‹œ?)**

ë§Œì•½ **apksigner**ë¥¼ ì‚¬ìš©í•˜ê³  ì‹¶ë‹¤ë©´ [**apksigner**](https://developer.android.com/studio/command-line/) ëŒ€ì‹  jarsigner, **zipalignìœ¼ë¡œ ìµœì í™”ë¥¼ ì ìš©í•œ í›„ apkë¥¼ ì„œëª…í•´ì•¼ í•©ë‹ˆë‹¤**. í•˜ì§€ë§Œ **jarsignerë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ í•œ ë²ˆë§Œ ì„œëª…í•´ì•¼ í•œë‹¤ëŠ” ì ì— ìœ ì˜í•˜ì„¸ìš”** (zipalign ì´ì „) ë˜ëŠ” aspsignerë¡œ (zipalign ì´í›„).
```bash
apksigner sign --ks key.jks ./dist/mycompiled.apk
```
## Smali ìˆ˜ì •

ë‹¤ìŒ Hello World Java ì½”ë“œ:
```java
public static void printHelloWorld() {
System.out.println("Hello World")
}
```
ìŠ¤ë§ë¦¬ ì½”ë“œëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:
```java
.method public static printHelloWorld()V
.registers 2
sget-object v0, Ljava/lang/System;->out:Ljava/io/PrintStream;
const-string v1, "Hello World"
invoke-virtual {v0,v1}, Ljava/io/PrintStream;->println(Ljava/lang/String;)V
return-void
.end method
```
The Smali instruction set is available [here](https://source.android.com/devices/tech/dalvik/dalvik-bytecode#instructions).

### Light Changes

### í•¨ìˆ˜ ë‚´ ë³€ìˆ˜ì˜ ì´ˆê¸° ê°’ ìˆ˜ì •

ì¼ë¶€ ë³€ìˆ˜ëŠ” í•¨ìˆ˜ì˜ ì‹œì‘ ë¶€ë¶„ì—ì„œ _const_ opcodeë¥¼ ì‚¬ìš©í•˜ì—¬ ì •ì˜ë˜ë©°, í•´ë‹¹ ë³€ìˆ˜ì˜ ê°’ì„ ìˆ˜ì •í•˜ê±°ë‚˜ ìƒˆë¡œìš´ ê°’ì„ ì •ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
#Number
const v9, 0xf4240
const/4 v8, 0x1
#Strings
const-string v5, "wins"
```
### ê¸°ë³¸ ì‘ì—…
```bash
#Math
add-int/lit8 v0, v2, 0x1 #v2 + 0x1 and save it in v0
mul-int v0,v2,0x2 #v2*0x2 and save in v0

#Move the value of one object into another
move v1,v2

#Condtions
if-ge #Greater or equals
if-le #Less or equals
if-eq #Equals

#Get/Save attributes of an object
iget v0, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Save this.o inside v0
iput v0, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Save v0 inside this.o

#goto
:goto_6 #Declare this where you want to start a loop
if-ne v0, v9, :goto_6 #If not equals, go to: :goto_6
goto :goto_6 #Always go to: :goto_6
```
### ë” í° ë³€í™”

### ë¡œê¹…
```bash
#Log win: <number>
iget v5, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Get this.o inside v5
invoke-static {v5}, Ljava/lang/String;->valueOf(I)Ljava/lang/String; #Transform number to String
move-result-object v1 #Move to v1
const-string v5, "wins" #Save "win" inside v5
invoke-static {v5, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I #Logging "Wins: <num>"
```
Recommendations:

* í•¨ìˆ˜ ë‚´ì—ì„œ ì„ ì–¸ëœ ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•  ê²½ìš° (declared v0,v1,v2...) ì´ ì¤„ë“¤ì„ _.local \<number>_ê³¼ ë³€ìˆ˜ ì„ ì–¸(_const v0, 0x1_) ì‚¬ì´ì— ë„£ìœ¼ì„¸ìš”.
* í•¨ìˆ˜ ì½”ë“œ ì¤‘ê°„ì— ë¡œê¹… ì½”ë“œë¥¼ ë„£ê³  ì‹¶ë‹¤ë©´:
* ì„ ì–¸ëœ ë³€ìˆ˜ì˜ ìˆ˜ì— 2ë¥¼ ì¶”ê°€í•˜ì„¸ìš”: ì˜ˆ: _.locals 10_ì—ì„œ _.locals 12_ë¡œ.
* ìƒˆë¡œìš´ ë³€ìˆ˜ëŠ” ì´ë¯¸ ì„ ì–¸ëœ ë³€ìˆ˜ì˜ ë‹¤ìŒ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤ (ì´ ì˜ˆì—ì„œëŠ” _v10_ê³¼ _v11_ì´ì–´ì•¼ í•˜ë©°, v0ì—ì„œ ì‹œì‘í•œë‹¤ëŠ” ê²ƒì„ ê¸°ì–µí•˜ì„¸ìš”).
* ë¡œê¹… í•¨ìˆ˜ì˜ ì½”ë“œë¥¼ ë³€ê²½í•˜ê³  _v5_ì™€ _v1_ ëŒ€ì‹  _v10_ê³¼ _v11_ì„ ì‚¬ìš©í•˜ì„¸ìš”.

### Toasting

í•¨ìˆ˜ ì‹œì‘ ë¶€ë¶„ì—ì„œ _.locals_ì˜ ìˆ˜ì— 3ì„ ì¶”ê°€í•˜ëŠ” ê²ƒì„ ìŠì§€ ë§ˆì„¸ìš”.

ì´ ì½”ë“œëŠ” **í•¨ìˆ˜ì˜ ì¤‘ê°„ì—** ì‚½ì…ë˜ë„ë¡ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤ (**ë³€ìˆ˜**ì˜ **ìˆ«ì**ëŠ” í•„ìš”ì— ë”°ë¼ ë³€ê²½í•˜ì„¸ìš”). ì´ ì½”ë“œëŠ” **this.o**ì˜ **ê°’**ì„ ê°€ì ¸ì™€ **String**ìœ¼ë¡œ **ë³€í™˜**í•œ ë‹¤ìŒ **ê·¸ ê°’ìœ¼ë¡œ** **í† ìŠ¤íŠ¸**ë¥¼ **ë§Œë“¤** ê²ƒì…ë‹ˆë‹¤.
```bash
const/4 v10, 0x1
const/4 v11, 0x1
const/4 v12, 0x1
iget v10, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I
invoke-static {v10}, Ljava/lang/String;->valueOf(I)Ljava/lang/String;
move-result-object v11
invoke-static {p0, v11, v12}, Landroid/widget/Toast;->makeText(Landroid/content/Context;Ljava/lang/CharSequence;I)Landroid/widget/Toast;
move-result-object v12
invoke-virtual {v12}, Landroid/widget/Toast;->show()V
```
{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ë ¤ë©´** [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì„¸ìš”.

</details>
{% endhint %}
