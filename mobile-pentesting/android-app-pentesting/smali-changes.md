# Smali - åç¼–è¯‘/\[ä¿®æ”¹\]/ç¼–è¯‘

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWSçº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

æœ‰æ—¶ä¿®æ”¹åº”ç”¨ç¨‹åºä»£ç ä»¥è®¿é—®éšè—ä¿¡æ¯ï¼ˆä¾‹å¦‚æ··æ·†è‰¯å¥½çš„å¯†ç æˆ–æ ‡å¿—ï¼‰å¯èƒ½å¾ˆæœ‰è¶£ã€‚ç„¶åï¼Œåç¼–è¯‘apkï¼Œä¿®æ”¹ä»£ç ï¼Œç„¶åé‡æ–°ç¼–è¯‘å¯èƒ½ä¼šå¾ˆæœ‰è¶£ã€‚

**æ“ä½œç å‚è€ƒï¼š** [http://pallergabor.uw.hu/androidblog/dalvik\_opcodes.html](http://pallergabor.uw.hu/androidblog/dalvik\_opcodes.html)

## å¿«é€Ÿæ–¹å¼

ä½¿ç”¨**Visual Studio Code**å’Œ[APKLab](https://github.com/APKLab/APKLab)æ‰©å±•ï¼Œæ‚¨å¯ä»¥**è‡ªåŠ¨åç¼–è¯‘**ï¼Œä¿®æ”¹ï¼Œ**é‡æ–°ç¼–è¯‘**ï¼Œç­¾åå’Œå®‰è£…åº”ç”¨ç¨‹åºï¼Œè€Œæ— éœ€æ‰§è¡Œä»»ä½•å‘½ä»¤ã€‚

å¦ä¸€ä¸ª**è„šæœ¬**å¯ä»¥æå¤§åœ°ç®€åŒ–æ­¤ä»»åŠ¡ï¼š[**https://github.com/ax/apk.sh**](https://github.com/ax/apk.sh)

## åç¼–è¯‘APK

ä½¿ç”¨APKToolï¼Œæ‚¨å¯ä»¥è®¿é—®**smaliä»£ç å’Œèµ„æº**ï¼š
```bash
apktool d APP.apk
```
å¦‚æœ**apktool**å‡ºç°ä»»ä½•é”™è¯¯ï¼Œè¯·å°è¯•[å®‰è£…**æœ€æ–°ç‰ˆæœ¬**](https://ibotpeaches.github.io/Apktool/install/)

ä¸€äº›æ‚¨åº”è¯¥æŸ¥çœ‹çš„**æœ‰è¶£æ–‡ä»¶**åŒ…æ‹¬ï¼š

* _res/values/strings.xml_ï¼ˆä»¥åŠres/values/\*å†…çš„æ‰€æœ‰xmlæ–‡ä»¶ï¼‰
* _AndroidManifest.xml_
* ä»»ä½•æ‰©å±•åä¸º_.sqlite_æˆ–_.db_çš„æ–‡ä»¶

å¦‚æœ`apktool`åœ¨**è§£ç åº”ç”¨ç¨‹åº**æ—¶å‡ºç°é—®é¢˜ï¼Œè¯·æŸ¥çœ‹[https://ibotpeaches.github.io/Apktool/documentation/#framework-files](https://ibotpeaches.github.io/Apktool/documentation/#framework-files)æˆ–å°è¯•ä½¿ç”¨å‚æ•°**`-r`**ï¼ˆä¸è§£ç èµ„æºï¼‰ã€‚ç„¶åï¼Œå¦‚æœé—®é¢˜å‡ºç°åœ¨èµ„æºè€Œä¸æ˜¯æºä»£ç ä¸­ï¼Œæ‚¨å°†ä¸ä¼šé‡åˆ°é—®é¢˜ï¼ˆæ‚¨ä¹Ÿä¸ä¼šåç¼–è¯‘èµ„æºï¼‰ã€‚

## æ›´æ”¹smaliä»£ç 

æ‚¨å¯ä»¥æ›´æ”¹**æŒ‡ä»¤**ï¼Œæ›´æ”¹æŸäº›å˜é‡çš„**å€¼**æˆ–**æ·»åŠ **æ–°æŒ‡ä»¤ã€‚æˆ‘ä½¿ç”¨[**VS Code**](https://code.visualstudio.com)æ›´æ”¹Smaliä»£ç ï¼Œç„¶åå®‰è£…**smaliseæ‰©å±•**ï¼Œç¼–è¾‘å™¨å°†å‘Šè¯‰æ‚¨æ˜¯å¦æœ‰ä»»ä½•**ä¸æ­£ç¡®çš„æŒ‡ä»¤**ã€‚\
ä¸€äº›**ç¤ºä¾‹**å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ï¼š

* [Smaliæ›´æ”¹ç¤ºä¾‹](smali-changes.md)
* [Google CTF 2018 - æˆ‘ä»¬ç©ä¸ªæ¸¸æˆå§ï¼Ÿ](google-ctf-2018-shall-we-play-a-game.md)

æˆ–è€…æ‚¨å¯ä»¥[**æŸ¥çœ‹ä¸‹é¢ä¸€äº›è§£é‡Šçš„Smaliæ›´æ”¹**](smali-changes.md#modifying-smali)ã€‚

## é‡æ–°ç¼–è¯‘APK

åœ¨ä¿®æ”¹ä»£ç åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤**é‡æ–°ç¼–è¯‘**ä»£ç ï¼š
```bash
apktool b . #In the folder generated when you decompiled the application
```
å®ƒä¼š**åœ¨**_**dist**_æ–‡ä»¶å¤¹**å†…** **ç¼–è¯‘**æ–°çš„APKã€‚

å¦‚æœ**apktool**æŠ›å‡º**é”™è¯¯**ï¼Œè¯·[å®‰è£…**æœ€æ–°ç‰ˆæœ¬**](https://ibotpeaches.github.io/Apktool/install/)

### **ç­¾ç½²æ–°çš„APK**

ç„¶åï¼Œæ‚¨éœ€è¦**ç”Ÿæˆä¸€ä¸ªå¯†é’¥**ï¼ˆç³»ç»Ÿä¼šè¦æ±‚æ‚¨è¾“å…¥å¯†ç å’Œä¸€äº›ä¿¡æ¯ï¼Œæ‚¨å¯ä»¥éšæœºå¡«å†™ï¼‰:
```bash
keytool -genkey -v -keystore key.jks -keyalg RSA -keysize 2048 -validity 10000 -alias <your-alias>
```
æœ€åï¼Œ**å¯¹æ–°çš„APKè¿›è¡Œç­¾å**ï¼š
```bash
jarsigner -keystore key.jks path/to/dist/* <your-alias>
```
### ä¼˜åŒ–æ–°åº”ç”¨ç¨‹åº

**zipalign** æ˜¯ä¸€ä¸ªå­˜æ¡£å¯¹é½å·¥å…·ï¼Œä¸º Android åº”ç”¨ç¨‹åºï¼ˆAPKï¼‰æ–‡ä»¶æä¾›é‡è¦çš„ä¼˜åŒ–ã€‚[æ›´å¤šä¿¡æ¯è¯·ç‚¹å‡»è¿™é‡Œ](https://developer.android.com/studio/command-line/zipalign)ã€‚
```bash
zipalign [-f] [-v] <alignment> infile.apk outfile.apk
zipalign -v 4 infile.apk
```
### **ç­¾ç½²æ–°çš„ APKï¼ˆå†æ¬¡ï¼Ÿï¼‰**

å¦‚æœæ‚¨æ›´å–œæ¬¢ä½¿ç”¨[**apksigner**](https://developer.android.com/studio/command-line/)è€Œä¸æ˜¯jarsignerï¼Œé‚£ä¹ˆåœ¨åº”ç”¨zipalignä¼˜åŒ–åï¼Œæ‚¨åº”è¯¥å¯¹apkè¿›è¡Œç­¾åã€‚ä½†è¯·æ³¨æ„ï¼Œæ‚¨åªéœ€è¦ä½¿ç”¨jarsignerï¼ˆåœ¨zipalignä¹‹å‰ï¼‰æˆ–è€…aspsignerï¼ˆåœ¨zipalignä¹‹åï¼‰å¯¹åº”ç”¨è¿›è¡Œä¸€æ¬¡ç­¾åã€‚
```bash
apksigner sign --ks key.jks ./dist/mycompiled.apk
```
## ä¿®æ”¹ Smali

å¯¹äºä»¥ä¸‹çš„ Hello World Java ä»£ç ï¼š
```java
public static void printHelloWorld() {
System.out.println("Hello World")
}
```
Smali ä»£ç å°†æ˜¯ï¼š
```java
.method public static printHelloWorld()V
.registers 2
sget-object v0, Ljava/lang/System;->out:Ljava/io/PrintStream;
const-string v1, "Hello World"
invoke-virtual {v0,v1}, Ljava/io/PrintStream;->println(Ljava/lang/String;)V
return-void
.end method
```
### è½»å¾®æ›´æ”¹

### ä¿®æ”¹å‡½æ•°å†…å˜é‡çš„åˆå§‹å€¼

æœ‰äº›å˜é‡åœ¨å‡½æ•°å¼€å§‹æ—¶ä½¿ç”¨æ“ä½œç _const_å®šä¹‰ï¼Œæ‚¨å¯ä»¥ä¿®æ”¹å…¶å€¼ï¼Œæˆ–è€…å®šä¹‰æ–°å˜é‡ï¼š
```bash
#Number
const v9, 0xf4240
const/4 v8, 0x1
#Strings
const-string v5, "wins"
```
### åŸºæœ¬æ“ä½œ
```bash
#Math
add-int/lit8 v0, v2, 0x1 #v2 + 0x1 and save it in v0
mul-int v0,v2,0x2 #v2*0x2 and save in v0

#Move the value of one object into another
move v1,v2

#Condtions
if-ge #Greater or equals
if-le #Less or equals
if-eq #Equals

#Get/Save attributes of an object
iget v0, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Save this.o inside v0
iput v0, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Save v0 inside this.o

#goto
:goto_6 #Declare this where you want to start a loop
if-ne v0, v9, :goto_6 #If not equals, go to: :goto_6
goto :goto_6 #Always go to: :goto_6
```
### æ›´å¤§çš„å˜åŒ–

### æ—¥å¿—è®°å½•
```bash
#Log win: <number>
iget v5, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Get this.o inside v5
invoke-static {v5}, Ljava/lang/String;->valueOf(I)Ljava/lang/String; #Transform number to String
move-result-object v1 #Move to v1
const-string v5, "wins" #Save "win" inside v5
invoke-static {v5, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I #Logging "Wins: <num>"
```
Recommendations:

* å¦‚æœæ‚¨è¦åœ¨å‡½æ•°å†…éƒ¨ä½¿ç”¨å·²å£°æ˜çš„å˜é‡ï¼ˆå£°æ˜ä¸ºv0ã€v1ã€v2ç­‰ï¼‰ï¼Œè¯·å°†è¿™äº›è¡Œæ”¾åœ¨ _.local \<number>_ å’Œå˜é‡å£°æ˜ä¹‹é—´ï¼ˆ_const v0, 0x1_ï¼‰ã€‚
* å¦‚æœè¦åœ¨å‡½æ•°ä»£ç ä¸­é—´æ·»åŠ æ—¥å¿—è®°å½•ä»£ç ï¼š
  * å°†å£°æ˜å˜é‡çš„æ•°é‡åŠ 2ï¼šä¾‹å¦‚ï¼Œä» _.locals 10_ å˜ä¸º _.locals 12_ã€‚
  * æ–°å˜é‡åº”ä¸ºå·²å£°æ˜å˜é‡çš„ä¸‹ä¸€ä¸ªæ•°å­—ï¼ˆåœ¨æ­¤ç¤ºä¾‹ä¸­åº”ä¸º _v10_ å’Œ _v11_ï¼Œè¯·è®°ä½ä»v0å¼€å§‹ï¼‰ã€‚
  * æ›´æ”¹æ—¥å¿—è®°å½•å‡½æ•°çš„ä»£ç ï¼Œå¹¶ä½¿ç”¨ _v10_ å’Œ _v11_ æ›¿æ¢ _v5_ å’Œ _v1_ã€‚

### Toasting

è®°å¾—åœ¨å‡½æ•°å¼€å¤´çš„ _.locals_ æ•°é‡ä¸ŠåŠ 3ã€‚

æ­¤ä»£ç å‡†å¤‡å¥½æ’å…¥åˆ°**å‡½æ•°ä¸­é—´**ï¼ˆæ ¹æ®éœ€è¦**æ›´æ”¹**å˜é‡çš„**æ•°é‡**ï¼‰ã€‚å®ƒå°†è·å–**this.o**çš„**å€¼**ï¼Œå°†å…¶è½¬æ¢ä¸º**å­—ç¬¦ä¸²**ï¼Œç„¶å**åˆ¶ä½œ**ä¸€ä¸ª**toast**æ˜¾ç¤ºå…¶å€¼ã€‚
```bash
const/4 v10, 0x1
const/4 v11, 0x1
const/4 v12, 0x1
iget v10, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I
invoke-static {v10}, Ljava/lang/String;->valueOf(I)Ljava/lang/String;
move-result-object v11
invoke-static {p0, v11, v12}, Landroid/widget/Toast;->makeText(Landroid/content/Context;Ljava/lang/CharSequence;I)Landroid/widget/Toast;
move-result-object v12
invoke-virtual {v12}, Landroid/widget/Toast;->show()V
```
<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

å…¶ä»–æ”¯æŒHackTricksçš„æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
