# Smali - Dekompilowanie/[Modyfikowanie]/Kompilowanie

<details>

<summary><strong>Dowiedz si, jak hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

Czasami interesujce jest zmodyfikowanie kodu aplikacji, aby uzyska dostp do ukrytych informacji (mo偶e to by dobrze zaszyfrowane hasa lub flagi). W takim przypadku warto zdekompilowa plik apk, zmodyfikowa kod i ponownie go skompilowa.

**Odwoanie do instrukcji:** [http://pallergabor.uw.hu/androidblog/dalvik\_opcodes.html](http://pallergabor.uw.hu/androidblog/dalvik\_opcodes.html)

## Szybki spos贸b

Korzystajc z **Visual Studio Code** i rozszerzenia [APKLab](https://github.com/APKLab/APKLab), mo偶na **automatycznie dekompilowa**, modyfikowa, **rekompilowa**, podpisa i zainstalowa aplikacj bez wykonywania 偶adnych polece.

Innym **skryptem**, kt贸ry bardzo uatwia to zadanie, jest [**https://github.com/ax/apk.sh**](https://github.com/ax/apk.sh)

## Dekompilacja APK

Korzystajc z APKTool, mo偶na uzyska dostp do **kodu smali i zasob贸w**:
```bash
apktool d APP.apk
```
Jeli **apktool** wywietla jakikolwiek bd, spr贸buj [zainstalowa **najnowsz wersj**](https://ibotpeaches.github.io/Apktool/install/).

Niekt贸re **interesujce pliki, na kt贸re powiniene zwr贸ci uwag**, to:

* _res/values/strings.xml_ (oraz wszystkie xml-e wewntrz res/values/\*)
* _AndroidManifest.xml_
* Dowolny plik z rozszerzeniem _.sqlite_ lub _.db_

Jeli `apktool` **ma problemy z dekodowaniem aplikacji**, zajrzyj na stron [https://ibotpeaches.github.io/Apktool/documentation/#framework-files](https://ibotpeaches.github.io/Apktool/documentation/#framework-files) lub spr贸buj u偶y argumentu **`-r`** (Nie dekoduj zasob贸w). Wtedy, jeli problem wystpowa w zasobie, a nie w kodzie 藕r贸dowym, nie bdziesz mie tego problemu (nie zdekodujesz r贸wnie偶 zasob贸w).

## Zmiana kodu smali

Mo偶esz **zmienia** **instrukcje**, zmienia **warto** niekt贸rych zmiennych lub **dodawa** nowe instrukcje. Ja zmieniam kod Smali za pomoc [**VS Code**](https://code.visualstudio.com), nastpnie instalujesz **rozszerzenie smalise** i edytor powie Ci, czy kt贸ra **instrukcja jest niepoprawna**.\
Kilka **przykad贸w** mo偶na znale藕 tutaj:

* [Przykady zmian w Smali](smali-changes.md)
* [Google CTF 2018 - Shall We Play a Game?](google-ctf-2018-shall-we-play-a-game.md)

Mo偶esz r贸wnie偶 [**sprawdzi poni偶ej wyjanienia niekt贸rych zmian w Smali**](smali-changes.md#modifying-smali).

## Ponowne skompilowanie APK

Po zmodyfikowaniu kodu mo偶esz **ponownie skompilowa** kod za pomoc:
```bash
apktool b . #In the folder generated when you decompiled the application
```
Skompiluje nowy plik APK wewntrz folderu _**dist**_.

Jeli **apktool** wygeneruje **bd**, spr贸buj [zainstalowa **najnowsz wersj**](https://ibotpeaches.github.io/Apktool/install/).

### **Podpisz nowy plik APK**

Nastpnie musisz **wygenerowa klucz** (zostaniesz poproszony o haso i pewne informacje, kt贸re mo偶esz wypeni losowo):
```bash
keytool -genkey -v -keystore key.jks -keyalg RSA -keysize 2048 -validity 10000 -alias <your-alias>
```
W kocu, **podpisz** nowy plik APK:
```bash
jarsigner -keystore key.jks path/to/dist/* <your-alias>
```
### Optymalizacja nowej aplikacji

**zipalign** to narzdzie do wyr贸wnywania archiw贸w, kt贸re zapewnia wa偶ne optymalizacje plik贸w aplikacji Android (APK). [Wicej informacji tutaj](https://developer.android.com/studio/command-line/zipalign).
```bash
zipalign [-f] [-v] <alignment> infile.apk outfile.apk
zipalign -v 4 infile.apk
```
### **Podpisz nowy APK (ponownie?)**

Jeli wolisz u偶ywa [**apksigner**](https://developer.android.com/studio/command-line/) zamiast jarsigner, **powiniene podpisa apk** po zastosowaniu optymalizacji za pomoc zipalign. ALE ZWR UWAG, 呕E MUSISZ PODPISA APLIKACJ TYLKO RAZ Z jarsigner (przed zipalign) LUB Z aspsigner (po zipalign).
```bash
apksigner sign --ks key.jks ./dist/mycompiled.apk
```
## Modyfikowanie Smali

Dla nastpujcego kodu Hello World w jzyku Java:
```java
public static void printHelloWorld() {
System.out.println("Hello World")
}
```
Kod Smali bdzie wyglda nastpujco:
```java
.method public static printHelloWorld()V
.registers 2
sget-object v0, Ljava/lang/System;->out:Ljava/io/PrintStream;
const-string v1, "Hello World"
invoke-virtual {v0,v1}, Ljava/io/PrintStream;->println(Ljava/lang/String;)V
return-void
.end method
```
Zestaw instrukcji Smali jest dostpny [tutaj](https://source.android.com/devices/tech/dalvik/dalvik-bytecode#instructions).

### Lekkie zmiany

### Modyfikowanie pocztkowych wartoci zmiennej wewntrz funkcji

Niekt贸re zmienne s definiowane na pocztku funkcji za pomoc opcode'u _const_, mo偶esz zmienia ich wartoci lub definiowa nowe:
```bash
#Number
const v9, 0xf4240
const/4 v8, 0x1
#Strings
const-string v5, "wins"
```
### Podstawowe operacje

#### Tworzenie nowej klasy

Aby utworzy now klas w pliku Smali, nale偶y utworzy nowy plik o rozszerzeniu `.smali` i umieci go w odpowiednim katalogu zgodnie z hierarchi pakiet贸w. Nastpnie nale偶y zdefiniowa nazw klasy, u偶ywajc dyrektywy `.class` i okreli dziedziczenie, jeli jest to konieczne, za pomoc dyrektywy `.super`.

Przykad:

```smali
.class public Lcom/example/MyClass;
.super Ljava/lang/Object;
```

#### Dodawanie p贸l

Aby doda pole do klasy, nale偶y u偶y dyrektywy `.field` i okreli modyfikatory dostpu, typ pola oraz jego nazw.

Przykad:

```smali
.field private static myField:I
```

#### Dodawanie metod

Aby doda metod do klasy, nale偶y u偶y dyrektywy `.method` i okreli modyfikatory dostpu, typ zwracany, nazw metody oraz list argument贸w. Nastpnie nale偶y zdefiniowa ciao metody, u偶ywajc instrukcji Smali.

Przykad:

```smali
.method public static myMethod(II)I
    .registers 3
    add-int v0, p0, p1
    return v0
.end method
```

#### Dodawanie instrukcji

Aby doda instrukcj do metody, nale偶y u偶y odpowiedniej instrukcji Smali, takiej jak `move`, `add-int`, `invoke-static`, itp. Instrukcje Smali s podobne do instrukcji Javy, ale maj nieco inn skadni.

Przykad:

```smali
add-int v0, p0, p1
```

#### Modyfikowanie istniejcych instrukcji

Aby zmodyfikowa istniejc instrukcj w metodzie, nale偶y znale藕 odpowiedni instrukcj w pliku Smali i zmieni jej argumenty lub operacje. Mo偶na to zrobi, edytujc plik Smali rcznie lub za pomoc narzdzi do automatycznego modyfikowania plik贸w Smali.

Przykad:

```smali
invoke-static {p0}, Landroid/util/Log;->d(Ljava/lang/String;)I
```

#### Usuwanie instrukcji

Aby usun instrukcj z metody, nale偶y znale藕 odpowiedni instrukcj w pliku Smali i usun j. Mo偶na to zrobi, edytujc plik Smali rcznie lub za pomoc narzdzi do automatycznego modyfikowania plik贸w Smali.

Przykad:

```smali
return-void
```

#### Dodawanie adnotacji

Aby doda adnotacj do klasy, pola lub metody, nale偶y u偶y dyrektywy `.annotation` i okreli typ adnotacji oraz jej parametry.

Przykad:

```smali
.annotation system Ldalvik/annotation/EnclosingClass;
    value = Lcom/example/MyClass;
.end annotation
```
```bash
#Math
add-int/lit8 v0, v2, 0x1 #v2 + 0x1 and save it in v0
mul-int v0,v2,0x2 #v2*0x2 and save in v0

#Move the value of one object into another
move v1,v2

#Condtions
if-ge #Greater or equals
if-le #Less or equals
if-eq #Equals

#Get/Save attributes of an object
iget v0, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Save this.o inside v0
iput v0, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Save v0 inside this.o

#goto
:goto_6 #Declare this where you want to start a loop
if-ne v0, v9, :goto_6 #If not equals, go to: :goto_6
goto :goto_6 #Always go to: :goto_6
```
### Wiksze zmiany

### Rejestrowanie dziaa
```bash
#Log win: <number>
iget v5, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Get this.o inside v5
invoke-static {v5}, Ljava/lang/String;->valueOf(I)Ljava/lang/String; #Transform number to String
move-result-object v1 #Move to v1
const-string v5, "wins" #Save "win" inside v5
invoke-static {v5, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I #Logging "Wins: <num>"
```
Rekomendacje:

* Jeli zamierzasz u偶ywa zadeklarowanych zmiennych wewntrz funkcji (zadeklarowane v0,v1,v2...), umie te linie midzy _.local \<number>_ a deklaracjami zmiennych (_const v0, 0x1_)
* Jeli chcesz umieci kod logowania w rodku kodu funkcji:
* Dodaj 2 do liczby zadeklarowanych zmiennych: np. z _.locals 10_ na _.locals 12_
* Nowe zmienne powinny mie kolejne numery po ju偶 zadeklarowanych zmiennych (w tym przykadzie powinny to by _v10_ i _v11_, pamitaj, 偶e zaczynamy od v0).
* Zmie kod funkcji logowania i u偶yj _v10_ i _v11_ zamiast _v5_ i _v1_.

### Toastowanie

Pamitaj, aby doda 3 do liczby _.locals_ na pocztku funkcji.

Ten kod jest przygotowany do wstawienia w **rodku funkcji** (**zmie** liczb **zmiennych** wedug potrzeb). Bdzie on pobiera **warto this.o**, **przeksztaca** j na **String** i nastpnie **wywietla** tost z jej wartoci.
```bash
const/4 v10, 0x1
const/4 v11, 0x1
const/4 v12, 0x1
iget v10, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I
invoke-static {v10}, Ljava/lang/String;->valueOf(I)Ljava/lang/String;
move-result-object v11
invoke-static {p0, v11, v12}, Landroid/widget/Toast;->makeText(Landroid/content/Context;Ljava/lang/CharSequence;I)Landroid/widget/Toast;
move-result-object v12
invoke-virtual {v12}, Landroid/widget/Toast;->show()V
```
<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy **reklam swojej firmy w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na GitHubie.

</details>
