# Opera√ß√µes B√°sicas de Teste em iOS

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}

## **Resumo da Identifica√ß√£o e Acesso a Dispositivos iOS**

### **Identificando o UDID de um Dispositivo iOS**

Para identificar um dispositivo iOS de forma √∫nica, utiliza-se uma sequ√™ncia de 40 d√≠gitos conhecida como UDID. No macOS Catalina ou vers√µes mais recentes, isso pode ser encontrado no **aplicativo Finder**, j√° que o iTunes n√£o est√° mais presente. O dispositivo, uma vez conectado via USB e selecionado no Finder, revela seu UDID entre outras informa√ß√µes quando os detalhes sob seu nome s√£o clicados.

Para vers√µes do macOS anteriores ao Catalina, o iTunes facilita a descoberta do UDID. Instru√ß√µes detalhadas podem ser encontradas [aqui](http://www.iclarified.com/52179/how-to-find-your-iphones-udid).

Ferramentas de linha de comando oferecem m√©todos alternativos para recuperar o UDID:

* **Usando a ferramenta I/O Registry Explorer `ioreg`:**
```bash
$ ioreg -p IOUSB -l | grep "USB Serial"
```
* **Usando `ideviceinstaller` para macOS (e Linux):**
```bash
$ brew install ideviceinstaller
$ idevice_id -l
```
* **Utilizando `system_profiler`:**
```bash
$ system_profiler SPUSBDataType | sed -n -e '/iPad/,/Serial/p;/iPhone/,/Serial/p;/iPod/,/Serial/p' | grep "Serial Number:"
```
* **Usando `instruments` para listar dispositivos:**
```bash
$ instruments -s devices
```
### **Acessando o Shell do Dispositivo**

O **acesso SSH** √© habilitado instalando o **pacote OpenSSH** ap√≥s o jailbreak, permitindo conex√µes via `ssh root@<device_ip_address>`. √â crucial alterar as senhas padr√£o (`alpine`) para os usu√°rios `root` e `mobile` para proteger o dispositivo.

**SSH via USB** torna-se necess√°rio na aus√™ncia de Wi-Fi, usando `iproxy` para mapear portas do dispositivo para conex√µes SSH. Essa configura√ß√£o permite o acesso SSH atrav√©s de USB executando:
```bash
$ iproxy 2222 22
$ ssh -p 2222 root@localhost
```
**Aplicativos de shell no dispositivo**, como NewTerm 2, facilitam a intera√ß√£o direta com o dispositivo, especialmente √∫til para solu√ß√£o de problemas. **Shells SSH reversos** tamb√©m podem ser estabelecidos para acesso remoto a partir do computador host.

### **Redefinindo Senhas Esquecidas**

Para redefinir uma senha esquecida de volta ao padr√£o (`alpine`), √© necess√°rio editar o arquivo `/private/etc/master.passwd`. Isso envolve substituir o hash existente pelo hash para `alpine` ao lado das entradas de usu√°rio `root` e `mobile`.

## **T√©cnicas de Transfer√™ncia de Dados**

### **Transferindo Arquivos de Dados do App**

**Arquivamento e Recupera√ß√£o via SSH e SCP:** √â simples arquivar o diret√≥rio Data do aplicativo usando `tar` e, em seguida, transferi-lo usando `scp`. O comando abaixo arquiva o diret√≥rio Data em um arquivo .tgz, que √© ent√£o puxado do dispositivo:
```bash
tar czvf /tmp/data.tgz /private/var/mobile/Containers/Data/Application/8C8E7EB0-BC9B-435B-8EF8-8F5560EB0693
exit
scp -P 2222 root@localhost:/tmp/data.tgz .
```
### **Ferramentas de Interface Gr√°fica do Usu√°rio**

**Usando iFunbox e iExplorer:** Essas ferramentas GUI s√£o √∫teis para gerenciar arquivos em dispositivos iOS. No entanto, a partir do iOS 8.4, a Apple restringiu o acesso dessas ferramentas ao sandbox do aplicativo, a menos que o dispositivo esteja jailbroken.

### **Usando Objection para Gerenciamento de Arquivos**

**Shell Interativo com Objection:** Iniciar o objection fornece acesso ao diret√≥rio Bundle de um aplicativo. A partir daqui, voc√™ pode navegar at√© o diret√≥rio Documents do aplicativo e gerenciar arquivos, incluindo baixar e enviar arquivos para e do dispositivo iOS.
```bash
objection --gadget com.apple.mobilesafari explorer
cd /var/mobile/Containers/Data/Application/72C7AAFB-1D75-4FBA-9D83-D8B4A2D44133/Documents
file download <filename>
```
## **Obtendo e Extraindo Aplicativos**

### **Adquirindo o Arquivo IPA**

**Link de Distribui√ß√£o Over-The-Air (OTA):** Aplicativos distribu√≠dos para teste via OTA podem ser baixados usando a ferramenta de download de ativos dos servi√ßos ITMS, que √© instalada via npm e usada para salvar o arquivo IPA localmente.
```bash
npm install -g itms-services
itms-services -u "itms-services://?action=download-manifest&url=https://s3-ap-southeast-1.amazonaws.com/test-uat/manifest.plist" -o - > out.ipa
```
### **Extraindo o Bin√°rio do App**

1. **De um IPA:** Descompacte o IPA para acessar o bin√°rio do app descriptografado.
2. **De um Dispositivo Jailbroken:** Instale o app e extraia o bin√°rio descriptografado da mem√≥ria.

### **Processo de Descriptografia**

**Vis√£o Geral da Descriptografia Manual:** Os bin√°rios de apps iOS s√£o criptografados pela Apple usando FairPlay. Para fazer engenharia reversa, √© necess√°rio despejar o bin√°rio descriptografado da mem√≥ria. O processo de descriptografia envolve verificar a flag PIE, ajustar as flags de mem√≥ria, identificar a se√ß√£o criptografada e, em seguida, despejar e substituir essa se√ß√£o por sua forma descriptografada.

**Verificando e Modificando a Flag PIE:**
```bash
otool -Vh Original_App
python change_macho_flags.py --no-pie Original_App
otool -Vh Hello_World
```
**Identificando a Se√ß√£o Criptografada e Despejando a Mem√≥ria:**

Determine os endere√ßos de in√≠cio e fim da se√ß√£o criptografada usando `otool` e despeje a mem√≥ria do dispositivo com jailbreak usando gdb.
```bash
otool -l Original_App | grep -A 4 LC_ENCRYPTION_INFO
dump memory dump.bin 0x8000 0x10a4000
```
**Substituindo a Se√ß√£o Criptografada:**

Substitua a se√ß√£o criptografada no bin√°rio original do aplicativo pelo despejo descriptografado.
```bash
dd bs=1 seek=<starting_address> conv=notrunc if=dump.bin of=Original_App
```
**Finalizando a Descriptografia:** Modifique os metadados do bin√°rio para indicar a aus√™ncia de criptografia usando ferramentas como **MachOView**, definindo o `cryptid` como 0.

### **Descriptografia (Automaticamente)**

#### **frida-ios-dump**
A ferramenta [**frida-ios-dump**](https://github.com/AloneMonkey/frida-ios-dump) √© utilizada para **descriptografar e extrair aplicativos automaticamente** de dispositivos iOS. Inicialmente, √© necess√°rio configurar o `dump.py` para se conectar ao dispositivo iOS, o que pode ser feito atrav√©s do localhost na porta 2222 via **iproxy** ou diretamente pelo endere√ßo IP do dispositivo e porta.

Os aplicativos instalados no dispositivo podem ser listados com o comando:
```bash
$ python dump.py -l
```
Para despejar um aplicativo espec√≠fico, como o Telegram, o seguinte comando √© usado:
```bash
$ python3 dump.py -u "root" -p "<PASSWORD>" ph.telegra.Telegraph
```
Este comando inicia o despejo do aplicativo, resultando na cria√ß√£o de um arquivo `Telegram.ipa` no diret√≥rio atual. Este processo √© adequado para dispositivos com jailbreak, pois aplicativos n√£o assinados ou falsamente assinados podem ser reinstalados usando ferramentas como [**ios-deploy**](https://github.com/ios-control/ios-deploy).

#### **flexdecrypt**
A ferramenta [**flexdecrypt**](https://github.com/JohnCoates/flexdecrypt), junto com seu wrapper [**flexdump**](https://gist.github.com/defparam/71d67ee738341559c35c684d659d40ac), permite a extra√ß√£o de arquivos IPA de aplicativos instalados. Os comandos de instala√ß√£o para **flexdecrypt** no dispositivo incluem o download e a instala√ß√£o do pacote `.deb`. **flexdump** pode ser usado para listar e despejar aplicativos, conforme mostrado nos comandos abaixo:
```bash
apt install zip unzip
wget https://gist.githubusercontent.com/defparam/71d67ee738341559c35c684d659d40ac/raw/30c7612262f1faf7871ba8e32fbe29c0f3ef9e27/flexdump -P /usr/local/bin; chmod +x /usr/local/bin/flexdump
flexdump list
flexdump dump Twitter.app
```
#### **bagbak**
[**bagbak**](https://github.com/ChiChou/bagbak), outra ferramenta baseada em Frida, requer um dispositivo com jailbreak para a descriptografia de aplicativos:
```bash
bagbak --raw Chrome
```
#### **r2flutch**
**r2flutch**, utilizando tanto radare quanto frida, serve para descriptografar e despejar aplicativos. Mais informa√ß√µes podem ser encontradas na sua [**p√°gina do GitHub**](https://github.com/as0ler/r2flutch).

### **Instalando Aplicativos**

**Sideloading** refere-se √† instala√ß√£o de aplicativos fora da App Store oficial. Este processo √© gerenciado pelo **installd daemon** e requer que os aplicativos sejam assinados com um certificado emitido pela Apple. Dispositivos com jailbreak podem contornar isso atrav√©s do **AppSync**, permitindo a instala√ß√£o de pacotes IPA falsamente assinados.

#### **Ferramentas de Sideloading**

- **Cydia Impactor**: Uma ferramenta para assinar e instalar arquivos IPA no iOS e arquivos APK no Android. Guias e solu√ß√µes de problemas podem ser encontradas em [yalujailbreak.net](https://yalujailbreak.net/how-to-use-cydia-impactor/).

- **libimobiledevice**: Uma biblioteca para Linux e macOS para se comunicar com dispositivos iOS. Comandos de instala√ß√£o e exemplos de uso para ideviceinstaller s√£o fornecidos para instalar aplicativos via USB.

- **ipainstaller**: Esta ferramenta de linha de comando permite a instala√ß√£o direta de aplicativos em dispositivos iOS.

- **ios-deploy**: Para usu√°rios de macOS, ios-deploy instala aplicativos iOS a partir da linha de comando. Descompactar o IPA e usar a flag `-m` para lan√ßamento direto do aplicativo fazem parte do processo.

- **Xcode**: Utilize o Xcode para instalar aplicativos navegando at√© **Window/Devices and Simulators** e adicionando o aplicativo a **Installed Apps**.

#### **Permitir Instala√ß√£o de Aplicativos em Dispositivos que N√£o S√£o iPad**
Para instalar aplicativos espec√≠ficos para iPad em dispositivos iPhone ou iPod touch, o valor **UIDeviceFamily** no arquivo **Info.plist** precisa ser alterado para **1**. No entanto, essa modifica√ß√£o requer a re-assinatura do arquivo IPA devido √†s verifica√ß√µes de valida√ß√£o de assinatura.

**Nota**: Este m√©todo pode falhar se o aplicativo exigir capacidades exclusivas de modelos mais novos de iPad enquanto usa um iPhone ou iPod touch mais antigo.

## Refer√™ncias
* [https://mas.owasp.org/MASTG/iOS/0x06b-iOS-Security-Testing/](ttps://mas.owasp.org/MASTG/iOS/0x06b-iOS-Security-Testing/)
* [https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0052/](https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0052/)
* [https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0053/](https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0053/)
* [https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0054/](https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0054/)
* [https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0056/](https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0056/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
