# iOS Basic Testing Operations

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **R√©sum√© de l'identification et de l'acc√®s aux appareils iOS**

### **Identification du UDID d'un appareil iOS**

Pour identifier un appareil iOS de mani√®re unique, une s√©quence de 40 chiffres connue sous le nom de UDID est utilis√©e. Sur macOS Catalina ou une version plus r√©cente, cela peut √™tre trouv√© dans l'**application Finder**, car iTunes n'est plus pr√©sent. L'appareil, une fois connect√© via USB et s√©lectionn√© dans Finder, r√©v√®le son UDID parmi d'autres informations lorsque les d√©tails sous son nom sont consult√©s.

Pour les versions de macOS ant√©rieures √† Catalina, iTunes facilite la d√©couverte du UDID. Des instructions d√©taill√©es peuvent √™tre trouv√©es [ici](http://www.iclarified.com/52179/how-to-find-your-iphones-udid).

Les outils en ligne de commande offrent des m√©thodes alternatives pour r√©cup√©rer le UDID :

* **Utilisation de l'outil I/O Registry Explorer `ioreg`:**
```bash
$ ioreg -p IOUSB -l | grep "USB Serial"
```
* **Utilisation de `ideviceinstaller` pour macOS (et Linux) :**
```bash
$ brew install ideviceinstaller
$ idevice_id -l
```
* **Utilisation de `system_profiler` :**
```bash
$ system_profiler SPUSBDataType | sed -n -e '/iPad/,/Serial/p;/iPhone/,/Serial/p;/iPod/,/Serial/p' | grep "Serial Number:"
```
* **Utilisation de `instruments` pour lister les appareils :**
```bash
$ instruments -s devices
```
### **Acc√©der au Shell de l'Appareil**

L'acc√®s **SSH** est activ√© en installant le **package OpenSSH** apr√®s le jailbreak, permettant des connexions via `ssh root@<device_ip_address>`. Il est crucial de changer les mots de passe par d√©faut (`alpine`) pour les utilisateurs `root` et `mobile` afin de s√©curiser l'appareil.

**SSH sur USB** devient n√©cessaire en l'absence de Wi-Fi, en utilisant `iproxy` pour mapper les ports de l'appareil pour les connexions SSH. Cette configuration permet l'acc√®s SSH via USB en ex√©cutant :
```bash
$ iproxy 2222 22
$ ssh -p 2222 root@localhost
```
**Les applications de shell sur l'appareil**, comme NewTerm 2, facilitent l'interaction directe avec l'appareil, particuli√®rement utile pour le d√©pannage. **Des shells SSH invers√©s** peuvent √©galement √™tre √©tablis pour un acc√®s √† distance depuis l'ordinateur h√¥te.

### **R√©initialisation des mots de passe oubli√©s**

Pour r√©initialiser un mot de passe oubli√© √† la valeur par d√©faut (`alpine`), il est n√©cessaire de modifier le fichier `/private/etc/master.passwd`. Cela implique de remplacer le hash existant par le hash pour `alpine` √† c√¥t√© des entr√©es des utilisateurs `root` et `mobile`.

## **Techniques de transfert de donn√©es**

### **Transfert de fichiers de donn√©es d'application**

**Archivage et r√©cup√©ration via SSH et SCP :** Il est simple d'archiver le r√©pertoire Data de l'application en utilisant `tar` puis de le transf√©rer en utilisant `scp`. La commande ci-dessous archive le r√©pertoire Data dans un fichier .tgz, qui est ensuite r√©cup√©r√© depuis l'appareil :
```bash
tar czvf /tmp/data.tgz /private/var/mobile/Containers/Data/Application/8C8E7EB0-BC9B-435B-8EF8-8F5560EB0693
exit
scp -P 2222 root@localhost:/tmp/data.tgz .
```
### **Outils d'Interface Graphique**

**Utilisation d'iFunbox et d'iExplorer :** Ces outils GUI sont utiles pour g√©rer des fichiers sur des appareils iOS. Cependant, √† partir d'iOS 8.4, Apple a restreint l'acc√®s de ces outils au sandbox de l'application √† moins que l'appareil ne soit jailbreak√©.

### **Utilisation d'Objection pour la Gestion des Fichiers**

**Shell Interactif avec Objection :** Le lancement d'objection permet d'acc√©der au r√©pertoire Bundle d'une application. De l√†, vous pouvez naviguer vers le r√©pertoire Documents de l'application et g√©rer des fichiers, y compris les t√©l√©charger et les t√©l√©verser vers et depuis l'appareil iOS.
```bash
objection --gadget com.apple.mobilesafari explorer
cd /var/mobile/Containers/Data/Application/72C7AAFB-1D75-4FBA-9D83-D8B4A2D44133/Documents
file download <filename>
```
## **Obtention et Extraction des Applications**

### **Acquisition du Fichier IPA**

**Lien de Distribution Over-The-Air (OTA) :** Les applications distribu√©es pour les tests via OTA peuvent √™tre t√©l√©charg√©es √† l'aide de l'outil de t√©l√©chargement d'actifs des services ITMS, qui est install√© via npm et utilis√© pour enregistrer le fichier IPA localement.
```bash
npm install -g itms-services
itms-services -u "itms-services://?action=download-manifest&url=https://s3-ap-southeast-1.amazonaws.com/test-uat/manifest.plist" -o - > out.ipa
```
### **Extraction du binaire de l'application**

1. **Depuis un IPA :** D√©compressez l'IPA pour acc√©der au binaire de l'application d√©chiffr√©.
2. **Depuis un appareil jailbreak√© :** Installez l'application et extrayez le binaire d√©chiffr√© de la m√©moire.

### **Processus de d√©chiffrement**

**Aper√ßu du d√©chiffrement manuel :** Les binaires d'applications iOS sont chiffr√©s par Apple √† l'aide de FairPlay. Pour effectuer une r√©tro-ing√©nierie, il faut extraire le binaire d√©chiffr√© de la m√©moire. Le processus de d√©chiffrement implique de v√©rifier le drapeau PIE, d'ajuster les drapeaux de m√©moire, d'identifier la section chiffr√©e, puis de vider et de remplacer cette section par sa forme d√©chiffr√©e.

**V√©rification et modification du drapeau PIE :**
```bash
otool -Vh Original_App
python change_macho_flags.py --no-pie Original_App
otool -Vh Hello_World
```
**Identification de la section chiffr√©e et vidage de la m√©moire :**

D√©terminez les adresses de d√©but et de fin de la section chiffr√©e √† l'aide de `otool` et vidangez la m√©moire depuis le dispositif jailbreak√© en utilisant gdb.
```bash
otool -l Original_App | grep -A 4 LC_ENCRYPTION_INFO
dump memory dump.bin 0x8000 0x10a4000
```
**Surcharger la section chiffr√©e :**

Remplacez la section chiffr√©e dans le binaire de l'application originale par le dump d√©chiffr√©.
```bash
dd bs=1 seek=<starting_address> conv=notrunc if=dump.bin of=Original_App
```
**Finaliser le d√©chiffrement :** Modifiez les m√©tadonn√©es du binaire pour indiquer l'absence de chiffrement en utilisant des outils comme **MachOView**, en d√©finissant `cryptid` √† 0.

### **D√©chiffrement (Automatiquement)**

#### **frida-ios-dump**
L'outil [**frida-ios-dump**](https://github.com/AloneMonkey/frida-ios-dump) est utilis√© pour **d√©chiffrer et extraire automatiquement des applications** des appareils iOS. Au d√©part, il faut configurer `dump.py` pour se connecter √† l'appareil iOS, ce qui peut √™tre fait via localhost sur le port 2222 via **iproxy** ou directement via l'adresse IP de l'appareil et le port.

Les applications install√©es sur l'appareil peuvent √™tre list√©es avec la commande :
```bash
$ python dump.py -l
```
Pour extraire une application sp√©cifique, comme Telegram, la commande suivante est utilis√©e :
```bash
$ python3 dump.py -u "root" -p "<PASSWORD>" ph.telegra.Telegraph
```
Cette commande initie le dump de l'application, ce qui entra√Æne la cr√©ation d'un fichier `Telegram.ipa` dans le r√©pertoire actuel. Ce processus est adapt√© aux appareils jailbreak√©s, car les applications non sign√©es ou faussement sign√©es peuvent √™tre r√©install√©es √† l'aide d'outils comme [**ios-deploy**](https://github.com/ios-control/ios-deploy).

#### **flexdecrypt**
L'outil [**flexdecrypt**](https://github.com/JohnCoates/flexdecrypt), ainsi que son wrapper [**flexdump**](https://gist.github.com/defparam/71d67ee738341559c35c684d659d40ac), permet l'extraction de fichiers IPA √† partir des applications install√©es. Les commandes d'installation pour **flexdecrypt** sur l'appareil incluent le t√©l√©chargement et l'installation du package `.deb`. **flexdump** peut √™tre utilis√© pour lister et dumper des applications, comme le montrent les commandes ci-dessous :
```bash
apt install zip unzip
wget https://gist.githubusercontent.com/defparam/71d67ee738341559c35c684d659d40ac/raw/30c7612262f1faf7871ba8e32fbe29c0f3ef9e27/flexdump -P /usr/local/bin; chmod +x /usr/local/bin/flexdump
flexdump list
flexdump dump Twitter.app
```
#### **bagbak**
[**bagbak**](https://github.com/ChiChou/bagbak), un autre outil bas√© sur Frida, n√©cessite un appareil jailbreak√© pour le d√©cryptage des applications :
```bash
bagbak --raw Chrome
```
#### **r2flutch**
**r2flutch**, utilisant √† la fois radare et frida, sert √† la d√©cryption et au dumping d'applications. Plus d'informations peuvent √™tre trouv√©es sur sa [**page GitHub**](https://github.com/as0ler/r2flutch).

### **Installation d'Applications**

**Sideloading** fait r√©f√©rence √† l'installation d'applications en dehors de l'App Store officiel. Ce processus est g√©r√© par le **daemon installd** et n√©cessite que les applications soient sign√©es avec un certificat d√©livr√© par Apple. Les appareils jailbreak√©s peuvent contourner cela gr√¢ce √† **AppSync**, permettant l'installation de paquets IPA faussement sign√©s.

#### **Outils de Sideloading**

- **Cydia Impactor** : Un outil pour signer et installer des fichiers IPA sur iOS et des fichiers APK sur Android. Des guides et des solutions aux probl√®mes peuvent √™tre trouv√©s sur [yalujailbreak.net](https://yalujailbreak.net/how-to-use-cydia-impactor/).

- **libimobiledevice** : Une biblioth√®que pour Linux et macOS pour communiquer avec des appareils iOS. Des commandes d'installation et des exemples d'utilisation pour ideviceinstaller sont fournis pour installer des applications via USB.

- **ipainstaller** : Cet outil en ligne de commande permet l'installation directe d'applications sur des appareils iOS.

- **ios-deploy** : Pour les utilisateurs de macOS, ios-deploy installe des applications iOS depuis la ligne de commande. D√©compresser l'IPA et utiliser le drapeau `-m` pour un lancement direct de l'application font partie du processus.

- **Xcode** : Utilisez Xcode pour installer des applications en naviguant vers **Window/Devices and Simulators** et en ajoutant l'application √† **Installed Apps**.

#### **Autoriser l'Installation d'Applications sur des Appareils Non-iPad**
Pour installer des applications sp√©cifiques √† l'iPad sur des appareils iPhone ou iPod touch, la valeur **UIDeviceFamily** dans le fichier **Info.plist** doit √™tre chang√©e en **1**. Cette modification n√©cessite cependant de re-signer le fichier IPA en raison des v√©rifications de validation de signature.

**Note** : Cette m√©thode peut √©chouer si l'application exige des capacit√©s exclusives aux mod√®les d'iPad plus r√©cents tout en utilisant un ancien iPhone ou iPod touch.

## R√©f√©rences
* [https://mas.owasp.org/MASTG/iOS/0x06b-iOS-Security-Testing/](ttps://mas.owasp.org/MASTG/iOS/0x06b-iOS-Security-Testing/)
* [https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0052/](https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0052/)
* [https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0053/](https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0053/)
* [https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0054/](https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0054/)
* [https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0056/](https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0056/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
