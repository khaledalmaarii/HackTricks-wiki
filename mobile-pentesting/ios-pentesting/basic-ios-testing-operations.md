# iOS Podstawowe Operacje Testowe

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si sztuczkami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}

## **Podsumowanie Identyfikacji i Dostpu do Urzdze iOS**

### **Identyfikacja UDID Urzdzenia iOS**

Aby unikalnie zidentyfikowa urzdzenie iOS, u偶ywa si 40-cyfrowej sekwencji znanej jako UDID. W systemie macOS Catalina lub nowszym mo偶na to znale藕 w aplikacji **Finder**, poniewa偶 iTunes nie jest ju偶 obecny. Urzdzenie, po podczeniu przez USB i wybraniu w Finderze, ujawnia sw贸j UDID wr贸d innych informacji, gdy kliknie si na szczeg贸y pod jego nazw.

Dla wersji macOS przed Catalina, iTunes uatwia odkrycie UDID. Szczeg贸owe instrukcje mo偶na znale藕 [tutaj](http://www.iclarified.com/52179/how-to-find-your-iphones-udid).

Narzdzia wiersza polece oferuj alternatywne metody uzyskiwania UDID:

* **U偶ywajc narzdzia I/O Registry Explorer `ioreg`:**
```bash
$ ioreg -p IOUSB -l | grep "USB Serial"
```
* **U偶ywanie `ideviceinstaller` dla macOS (i Linux):**
```bash
$ brew install ideviceinstaller
$ idevice_id -l
```
* **Wykorzystanie `system_profiler`:**
```bash
$ system_profiler SPUSBDataType | sed -n -e '/iPad/,/Serial/p;/iPhone/,/Serial/p;/iPod/,/Serial/p' | grep "Serial Number:"
```
* **U偶ywanie `instruments` do wylistowania urzdze:**
```bash
$ instruments -s devices
```
### **Dostp do powoki urzdzenia**

**Dostp SSH** jest wczony poprzez zainstalowanie **pakietu OpenSSH** po jailbreaku, co umo偶liwia poczenia za pomoc `ssh root@<device_ip_address>`. Wa偶ne jest, aby zmieni domylne hasa (`alpine`) dla u偶ytkownik贸w `root` i `mobile`, aby zabezpieczy urzdzenie.

**SSH przez USB** staje si konieczne w przypadku braku Wi-Fi, u偶ywajc `iproxy` do mapowania port贸w urzdzenia dla pocze SSH. Ta konfiguracja umo偶liwia dostp SSH przez USB, uruchamiajc:
```bash
$ iproxy 2222 22
$ ssh -p 2222 root@localhost
```
**Aplikacje powoki na urzdzeniu**, takie jak NewTerm 2, uatwiaj bezporedni interakcj z urzdzeniem, co jest szczeg贸lnie przydatne w przypadku rozwizywania problem贸w. **Powoki Reverse SSH** mog by r贸wnie偶 ustanawiane w celu zdalnego dostpu z komputera hosta.

### **Resetowanie Zapomnianych Hase**

Aby zresetowa zapomniane haso do domylnego (`alpine`), konieczna jest edycja pliku `/private/etc/master.passwd`. Polega to na zastpieniu istniejcego hasha hashem dla `alpine` obok wpis贸w u偶ytkownik贸w `root` i `mobile`.

## **Techniki Transferu Danych**

### **Transferowanie Plik贸w Danych Aplikacji**

**Archiwizacja i Pobieranie za pomoc SSH i SCP:** atwo jest zarchiwizowa katalog Danych aplikacji za pomoc `tar`, a nastpnie przenie go za pomoc `scp`. Poni偶sze polecenie archiwizuje katalog Danych do pliku .tgz, kt贸ry jest nastpnie pobierany z urzdzenia:
```bash
tar czvf /tmp/data.tgz /private/var/mobile/Containers/Data/Application/8C8E7EB0-BC9B-435B-8EF8-8F5560EB0693
exit
scp -P 2222 root@localhost:/tmp/data.tgz .
```
### **Narzdzia interfejsu graficznego**

**U偶ywanie iFunbox i iExplorer:** Te narzdzia GUI s przydatne do zarzdzania plikami na urzdzeniach iOS. Jednak od iOS 8.4 Apple ograniczyo dostp tych narzdzi do piaskownicy aplikacji, chyba 偶e urzdzenie jest jailbreakowane.

### **U偶ywanie Objection do zarzdzania plikami**

**Interaktywna powoka z Objection:** Uruchomienie objection zapewnia dostp do katalogu Bundle aplikacji. Std mo偶na przej do katalogu Dokumenty aplikacji i zarzdza plikami, w tym pobiera i przesya je na i z urzdzenia iOS.
```bash
objection --gadget com.apple.mobilesafari explorer
cd /var/mobile/Containers/Data/Application/72C7AAFB-1D75-4FBA-9D83-D8B4A2D44133/Documents
file download <filename>
```
## **Uzyskiwanie i Ekstrakcja Aplikacji**

### **Pozyskiwanie Pliku IPA**

**Link do Dystrybucji Over-The-Air (OTA):** Aplikacje dystrybuowane do test贸w za pomoc OTA mo偶na pobra za pomoc narzdzia do pobierania zasob贸w ITMS, kt贸re jest instalowane za pomoc npm i su偶y do zapisywania pliku IPA lokalnie.
```bash
npm install -g itms-services
itms-services -u "itms-services://?action=download-manifest&url=https://s3-ap-southeast-1.amazonaws.com/test-uat/manifest.plist" -o - > out.ipa
```
### **Ekstrakcja binarnego pliku aplikacji**

1. **Z pliku IPA:** Rozpakuj plik IPA, aby uzyska dostp do odszyfrowanego binarnego pliku aplikacji.
2. **Z urzdzenia z jailbreakiem:** Zainstaluj aplikacj i wyodrbnij odszyfrowany plik binarny z pamici.

### **Proces odszyfrowania**

**Przegld rcznego odszyfrowania:** Binarne pliki aplikacji iOS s szyfrowane przez Apple za pomoc FairPlay. Aby przeprowadzi in偶ynieri wsteczn, nale偶y zrzuci odszyfrowany plik binarny z pamici. Proces odszyfrowania obejmuje sprawdzenie flagi PIE, dostosowanie flag pamici, zidentyfikowanie zaszyfrowanej sekcji, a nastpnie zrzucenie i zastpienie tej sekcji jej odszyfrowan form.

**Sprawdzanie i modyfikowanie flagi PIE:**
```bash
otool -Vh Original_App
python change_macho_flags.py --no-pie Original_App
otool -Vh Hello_World
```
**Identyfikacja zaszyfrowanej sekcji i zrzut pamici:**

Okrel adresy pocztku i koca zaszyfrowanej sekcji za pomoc `otool` i zrzutuj pami z urzdzenia z jailbreakiem za pomoc gdb.
```bash
otool -l Original_App | grep -A 4 LC_ENCRYPTION_INFO
dump memory dump.bin 0x8000 0x10a4000
```
**Nadpisywanie Zaszyfrowanej Sekcji:**

Zastp zaszyfrowan sekcj w oryginalnym pliku binarnym aplikacji zdekodowanym zrzutem.
```bash
dd bs=1 seek=<starting_address> conv=notrunc if=dump.bin of=Original_App
```
**Finalizing Decryption:** Zmodyfikuj metadane binari贸w, aby wskaza na brak szyfrowania, u偶ywajc narzdzi takich jak **MachOView**, ustawiajc `cryptid` na 0.

### **Decryption (Automatically)**

#### **frida-ios-dump**
Narzdzie [**frida-ios-dump**](https://github.com/AloneMonkey/frida-ios-dump) jest u偶ywane do **automatycznego deszyfrowania i ekstrakcji aplikacji** z urzdze iOS. Na pocztku nale偶y skonfigurowa `dump.py`, aby poczy si z urzdzeniem iOS, co mo偶na zrobi przez localhost na porcie 2222 za pomoc **iproxy** lub bezporednio przez adres IP urzdzenia i port.

Aplikacje zainstalowane na urzdzeniu mo偶na wylistowa za pomoc polecenia:
```bash
$ python dump.py -l
```
Aby zrzuci konkretn aplikacj, tak jak Telegram, u偶ywa si nastpujcego polecenia:
```bash
$ python3 dump.py -u "root" -p "<PASSWORD>" ph.telegra.Telegraph
```
To polecenie inicjuje zrzut aplikacji, co skutkuje utworzeniem pliku `Telegram.ipa` w bie偶cym katalogu. Proces ten jest odpowiedni dla urzdze z jailbreakiem, poniewa偶 aplikacje bez podpisu lub faszywie podpisane mog by ponownie zainstalowane za pomoc narzdzi takich jak [**ios-deploy**](https://github.com/ios-control/ios-deploy).

#### **flexdecrypt**
Narzdzie [**flexdecrypt**](https://github.com/JohnCoates/flexdecrypt), wraz ze swoim wrapperem [**flexdump**](https://gist.github.com/defparam/71d67ee738341559c35c684d659d40ac), umo偶liwia ekstrakcj plik贸w IPA z zainstalowanych aplikacji. Komendy instalacyjne dla **flexdecrypt** na urzdzeniu obejmuj pobranie i zainstalowanie pakietu `.deb`. **flexdump** mo偶e by u偶ywane do wylistowania i zrzutu aplikacji, jak pokazano w poni偶szych komendach:
```bash
apt install zip unzip
wget https://gist.githubusercontent.com/defparam/71d67ee738341559c35c684d659d40ac/raw/30c7612262f1faf7871ba8e32fbe29c0f3ef9e27/flexdump -P /usr/local/bin; chmod +x /usr/local/bin/flexdump
flexdump list
flexdump dump Twitter.app
```
#### **bagbak**
[**bagbak**](https://github.com/ChiChou/bagbak), inne narzdzie oparte na Frida, wymaga urzdzenia z jailbreakiem do deszyfrowania aplikacji:
```bash
bagbak --raw Chrome
```
#### **r2flutch**
**r2flutch**, wykorzystujc zar贸wno radare, jak i frida, su偶y do deszyfrowania i zrzucania aplikacji. Wicej informacji mo偶na znale藕 na jego [**stronie GitHub**](https://github.com/as0ler/r2flutch).

### **Instalacja aplikacji**

**Sideloading** odnosi si do instalacji aplikacji poza oficjalnym App Store. Proces ten jest obsugiwany przez **installd daemon** i wymaga, aby aplikacje byy podpisane certyfikatem wydanym przez Apple. Urzdzenia z jailbreakiem mog to obej za pomoc **AppSync**, co umo偶liwia instalacj faszywie podpisanych pakiet贸w IPA.

#### **Narzdzia do Sideloadingu**

- **Cydia Impactor**: Narzdzie do podpisywania i instalowania plik贸w IPA na iOS oraz plik贸w APK na Androida. Przewodniki i rozwizywanie problem贸w mo偶na znale藕 na [yalujailbreak.net](https://yalujailbreak.net/how-to-use-cydia-impactor/).

- **libimobiledevice**: Biblioteka dla system贸w Linux i macOS do komunikacji z urzdzeniami iOS. Komendy instalacyjne i przykady u偶ycia dla ideviceinstaller s dostarczane w celu instalacji aplikacji przez USB.

- **ipainstaller**: To narzdzie wiersza polece umo偶liwia bezporedni instalacj aplikacji na urzdzeniach iOS.

- **ios-deploy**: Dla u偶ytkownik贸w macOS, ios-deploy instaluje aplikacje iOS z wiersza polece. Rozpakowanie IPA i u偶ycie flagi `-m` do bezporedniego uruchomienia aplikacji s czci procesu.

- **Xcode**: Wykorzystaj Xcode do instalacji aplikacji, przechodzc do **Window/Devices and Simulators** i dodajc aplikacj do **Installed Apps**.

#### **Zezw贸l na instalacj aplikacji na urzdzeniach nie-iPad**
Aby zainstalowa aplikacje specyficzne dla iPada na urzdzeniach iPhone lub iPod touch, warto **UIDeviceFamily** w pliku **Info.plist** musi zosta zmieniona na **1**. Ta modyfikacja wymaga jednak ponownego podpisania pliku IPA z powodu kontroli walidacji podpisu.

**Uwaga**: Ta metoda mo偶e nie zadziaa, jeli aplikacja wymaga funkcji zarezerwowanych dla nowszych modeli iPada, podczas korzystania ze starszego iPhone'a lub iPoda touch.



## References
* [https://mas.owasp.org/MASTG/iOS/0x06b-iOS-Security-Testing/](ttps://mas.owasp.org/MASTG/iOS/0x06b-iOS-Security-Testing/)
* [https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0052/](https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0052/)
* [https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0053/](https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0053/)
* [https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0054/](https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0054/)
* [https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0056/](https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0056/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
