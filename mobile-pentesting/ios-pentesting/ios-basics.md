{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}

# Privilegien-Trennung und Sandbox

In iOS gibt es einen Unterschied in den Privilegien zwischen den benutzerzug√§nglichen Anwendungen und den Kernprozessen des Systems. Anwendungen laufen unter der **`mobile`** Benutzeridentit√§t, w√§hrend die entscheidenden Systemprozesse als **`root`** arbeiten. Diese Trennung wird durch einen Sandbox-Mechanismus verst√§rkt, der strenge Einschr√§nkungen daf√ºr auferlegt, welche Aktionen Anwendungen durchf√ºhren k√∂nnen. Zum Beispiel, selbst wenn Anwendungen dieselbe Benutzeridentit√§t teilen, ist es ihnen untersagt, auf die Daten anderer Anwendungen zuzugreifen oder diese zu √§ndern.

Anwendungen werden in einem bestimmten Verzeichnis (`private/var/mobile/Applications/{random ID}`) installiert und haben eingeschr√§nkten Lesezugriff auf bestimmte Systembereiche und Funktionen, wie SMS und Telefonanrufe. Der Zugriff auf gesch√ºtzte Bereiche l√∂st eine Pop-up-Anfrage zur Benutzererlaubnis aus.

# Datenschutz

iOS bietet Entwicklern die **Data Protection APIs**, die auf dem Secure Enclave Processor (SEP) basieren ‚Äî einem speziellen Co-Prozessor f√ºr kryptografische Operationen und Schl√ºsselmanagement. Der SEP gew√§hrleistet die Integrit√§t des Datenschutzes √ºber einen einzigartigen, ger√§tespezifischen Schl√ºssel, die Ger√§te-UID, die darin eingebettet ist.

Bei der Dateierstellung wird ein einzigartiger 256-Bit-AES-Verschl√ºsselungsschl√ºssel generiert, der den Inhalt der Datei verschl√ºsselt. Dieser Verschl√ºsselungsschl√ºssel wird zusammen mit einer Klassen-ID verschl√ºsselt, indem ein Klassenschl√ºssel verwendet und in den Metadaten der Datei gespeichert wird. Das Entschl√ºsseln einer Datei erfordert die Verwendung des Schl√ºssels des Systems, um auf die Metadaten zuzugreifen, die Klassen-ID abzurufen und dann den einzigartigen Verschl√ºsselungsschl√ºssel der Datei zu entschl√ºsseln.

iOS definiert **vier Schutzklassen** f√ºr die Datensicherheit, die bestimmen, wann und wie auf Daten zugegriffen werden kann:

- **Vollst√§ndiger Schutz (NSFileProtectionComplete)**: Daten sind unzug√§nglich, bis das Ger√§t mit dem Benutzerpasswort entsperrt wird.
- **Gesch√ºtzt, es sei denn, es ist ge√∂ffnet (NSFileProtectionCompleteUnlessOpen)**: Erm√∂glicht den Dateizugriff, selbst wenn das Ger√§t gesperrt ist, vorausgesetzt, die Datei wurde ge√∂ffnet, als das Ger√§t entsperrt war.
- **Gesch√ºtzt bis zur ersten Benutzerauthentifizierung (NSFileProtectionCompleteUntilFirstUserAuthentication)**: Daten sind nach der ersten Benutzerentsperrung nach dem Booten zug√§nglich und bleiben auch dann zug√§nglich, wenn das Ger√§t erneut gesperrt wird.
- **Kein Schutz (NSFileProtectionNone)**: Daten sind nur durch die Ger√§te-UID gesch√ºtzt, was ein schnelles L√∂schen von Daten aus der Ferne erm√∂glicht.

Die Verschl√ºsselung aller Klassen, mit Ausnahme von `NSFileProtectionNone`, erfolgt mit einem Schl√ºssel, der sowohl aus der Ger√§te-UID als auch aus dem Benutzerpasswort abgeleitet wird, was sicherstellt, dass die Entschl√ºsselung nur auf dem Ger√§t mit dem richtigen Passwort m√∂glich ist. Ab iOS 7 ist die Standard-Schutzklasse "Gesch√ºtzt bis zur ersten Benutzerauthentifizierung".

Entwickler k√∂nnen [**FileDP**](https://github.com/abjurato/FileDp-Source) verwenden, ein Tool zur √úberpr√ºfung der Datenschutzklasse von Dateien auf einem iPhone.
```python
# Example code to use FileDP for checking file protection class
# Note: Ensure your device is jailbroken and has Python installed to use FileDP.
# Installation and usage of FileDP:
git clone https://github.com/abjurato/FileDp-Source
cd FileDp-Source
python filedp.py /path/to/check
```
## **Der Schl√ºsselbund**

In iOS dient ein **Schl√ºsselbund** als sicheres **verschl√ºsseltes Container** zum Speichern von **sensiblen Informationen**, die nur von der Anwendung, die sie gespeichert hat, oder von ausdr√ºcklich autorisierten Anwendungen zug√§nglich sind. Diese Verschl√ºsselung wird durch ein einzigartiges **Passwort, das von iOS generiert wird**, verst√§rkt, das selbst mit **AES** verschl√ºsselt ist. Dieser Verschl√ºsselungsprozess nutzt eine **PBKDF2-Funktion**, die den Benutzer-Passcode mit einem Salt kombiniert, das aus der **UID** des Ger√§ts abgeleitet ist, einem Bestandteil, auf den nur der **Secure Enclave-Chip** zugreifen kann. Folglich bleiben die Inhalte des Schl√ºsselbunds selbst dann unzug√§nglich, wenn der Benutzer-Passcode bekannt ist, auf jedem anderen Ger√§t als dem, auf dem sie urspr√ºnglich verschl√ºsselt wurden.

**Verwaltung und Zugriff** auf die Schl√ºsselbunddaten werden vom **`securityd`-Daemon** verwaltet, basierend auf spezifischen App-Berechtigungen wie `Keychain-access-groups` und `application-identifier`.

### **Schl√ºsselbund-API-Operationen**

Die Schl√ºsselbund-API, die in der [Dokumentation zu den Schl√ºsselbunddiensten von Apple](https://developer.apple.com/library/content/documentation/Security/Conceptual/keychainServConcepts/02concepts/concepts.html) detailliert beschrieben ist, bietet wesentliche Funktionen f√ºr das Management der sicheren Speicherung:

- **`SecItemAdd`**: F√ºgt ein neues Element zum Schl√ºsselbund hinzu.
- **`SecItemUpdate`**: Aktualisiert ein vorhandenes Element im Schl√ºsselbund.
- **`SecItemCopyMatching`**: Ruft ein Element aus dem Schl√ºsselbund ab.
- **`SecItemDelete`**: Entfernt ein Element aus dem Schl√ºsselbund.

Das Brute-Forcing des Schl√ºsselbund-Passworts umfasst entweder den direkten Angriff auf den verschl√ºsselten Schl√ºssel oder den Versuch, den Passcode auf dem Ger√§t selbst zu erraten, was erheblich durch die Durchsetzung einer Verz√∂gerung zwischen fehlgeschlagenen Versuchen durch die Secure Enclave erschwert wird.

### **Konfiguration des Datenschutzes f√ºr Schl√ºsselbund-Elemente**

Die Datenschutzniveaus f√ºr Schl√ºsselbund-Elemente werden mit dem Attribut `kSecAttrAccessible` w√§hrend der Erstellung oder Aktualisierung des Elements festgelegt. Diese Niveaus, [wie von Apple angegeben](https://developer.apple.com/documentation/security/keychain_services/keychain_items/item_attribute_keys_and_values#1679100), bestimmen, wann und wie Schl√ºsselbund-Elemente zug√§nglich sind:

- **`kSecAttrAccessibleAlways`**: Jederzeit zug√§nglich, unabh√§ngig vom Ger√§tesperrstatus.
- **`kSecAttrAccessibleAlwaysThisDeviceOnly`**: Immer zug√§nglich, aber nicht in Backups enthalten.
- **`kSecAttrAccessibleAfterFirstUnlock`**: Zug√§nglich nach dem ersten Entsperren nach einem Neustart.
- **`kSecAttrAccessibleAfterFirstUnlockThisDeviceOnly`**: Dasselbe wie oben, aber nicht √ºbertragbar auf neue Ger√§te.
- **`kSecAttrAccessibleWhenUnlocked`**: Nur zug√§nglich, wenn das Ger√§t entsperrt ist.
- **`kSecAttrAccessibleWhenUnlockedThisDeviceOnly`**: Zug√§nglich, wenn entsperrt, nicht in Backups enthalten.
- **`kSecAttrAccessibleWhenPasscodeSetThisDeviceOnly`**: Erfordert den Ger√§tepincode, nicht in Backups enthalten.

**`AccessControlFlags`** verfeinern die Zugriffsarten weiter und erm√∂glichen biometrische Authentifizierung oder die Verwendung eines Passcodes.

### **Warnung vor jailbreakten Ger√§ten**

{% hint style="warning" %}
Auf **jailbroken Ger√§ten** sind die Schutzma√ünahmen des Schl√ºsselbunds kompromittiert, was ein erhebliches Sicherheitsrisiko darstellt.
{% endhint %}

### **Persistenz der Schl√ºsselbunddaten**

Im Gegensatz zu app-spezifischen Daten, die bei der Deinstallation der App gel√∂scht werden, **persistieren Schl√ºsselbunddaten** auf dem Ger√§t. Diese Eigenschaft k√∂nnte es neuen Besitzern eines gebrauchten Ger√§ts erm√∂glichen, auf die Anwendungsdaten des vorherigen Besitzers zuzugreifen, indem sie einfach die Apps neu installieren. Entwicklern wird geraten, proaktiv die Schl√ºsselbunddaten bei der Installation der App oder beim Abmelden zu l√∂schen, um dieses Risiko zu mindern. Hier ist ein Swift-Codebeispiel, das zeigt, wie man die Schl√ºsselbunddaten beim ersten Start der App l√∂scht:
```swift
let userDefaults = UserDefaults.standard

if userDefaults.bool(forKey: "hasRunBefore") == false {
// Remove Keychain items here

// Update the flag indicator
userDefaults.set(true, forKey: "hasRunBefore")
userDefaults.synchronize() // Forces the app to update UserDefaults
}
```
# **App-Funktionen**

Im Bereich der App-Entwicklung spielt **Sandboxing** eine entscheidende Rolle bei der Verbesserung der Sicherheit. Dieser Prozess stellt sicher, dass jede App in ihrem eigenen einzigartigen Home-Verzeichnis arbeitet, wodurch verhindert wird, dass sie auf Systemdateien oder Daten anderer Apps zugreift. Die Durchsetzung dieser Einschr√§nkungen erfolgt durch Sandbox-Richtlinien, die Teil des **Trusted BSD (MAC) Mandatory Access Control Framework** sind.

Entwickler haben die M√∂glichkeit, bestimmte **Funktionen oder Berechtigungen** f√ºr ihre Apps zu konfigurieren, wie z.B. **Datenschutz** oder **Keychain-Sharing**. Diese Berechtigungen werden sofort nach der Installation der App angewendet. Dennoch muss die App f√ºr den Zugriff auf bestimmte gesch√ºtzte Ressourcen die ausdr√ºckliche Zustimmung des Benutzers zum Zeitpunkt des ersten Versuchs einholen. Dies wird durch die Verwendung von _Zweck-Strings_ oder _Nutzungsbeschreibungs-Strings_ erreicht, die den Benutzern in einer Berechtigungsanfrage angezeigt werden.

F√ºr diejenigen mit Zugang zum Quellcode kann die √úberpr√ºfung der Berechtigungen, die in der `Info.plist`-Datei enthalten sind, wie folgt erfolgen:

1. √ñffnen Sie das Projekt in Xcode.
2. Suchen und √∂ffnen Sie die `Info.plist`-Datei.
3. Suchen Sie nach Schl√ºsseln, die mit `"Privacy -"` beginnen, mit der Option, rohe Schl√ºssel/Werte zur Klarheit anzuzeigen.

Beim Umgang mit einer IPA-Datei k√∂nnen die folgenden Schritte befolgt werden:

1. Entpacken Sie die IPA.
2. Suchen Sie die `Info.plist`-Datei innerhalb von `Payload/<appname>.app/`.
3. Konvertieren Sie die Datei bei Bedarf in das XML-Format, um eine einfachere Inspektion zu erm√∂glichen.

Zum Beispiel k√∂nnten die Zweck-Strings in der `Info.plist`-Datei so aussehen:
```xml
<plist version="1.0">
<dict>
<key>NSLocationWhenInUseUsageDescription</key>
<string>Your location is used to provide turn-by-turn directions to your destination.</string>
```
## Device Capabilities
Die `Info.plist`-Datei einer App gibt **Ger√§tef√§higkeiten** an, die dem App Store helfen, Apps nach Ger√§tekompatibilit√§t zu filtern. Diese sind unter dem **`UIRequiredDeviceCapabilities`**-Schl√ºssel definiert. Zum Beispiel:
```xml
<key>UIRequiredDeviceCapabilities</key>
<array>
<string>armv7</string>
</array>
```
Dieses Beispiel zeigt, dass die App mit dem armv7-Befehlssatz kompatibel ist. Entwickler k√∂nnen auch Funktionen wie nfc angeben, um sicherzustellen, dass ihre App nur auf Ger√§ten verf√ºgbar ist, die NFC unterst√ºtzen.

## Berechtigungen

**Berechtigungen** sind ein weiterer kritischer Aspekt der iOS-App-Entwicklung und dienen als Schl√ºssel-Wert-Paare, die Apps die Erlaubnis erteilen, bestimmte Operationen √ºber Laufzeitpr√ºfungen hinaus durchzuf√ºhren. Zum Beispiel beinhaltet das Aktivieren von **Datenschutz** in einer App das Hinzuf√ºgen einer spezifischen Berechtigung im Xcode-Projekt, die dann in der Berechtigungsdatei der App oder der eingebetteten mobilen Bereitstellungsdatei f√ºr IPAs reflektiert wird.


# Referenzen
* [https://mas.owasp.org/MASTG/iOS/0x06d-Testing-Data-Storage](https://mas.owasp.org/MASTG/iOS/0x06d-Testing-Data-Storage)
* [https://github.com/OWASP/owasp-mastg/blob/master/Document/0x06h-Testing-Platform-Interaction.md](https://github.com/OWASP/owasp-mastg/blob/master/Document/0x06h-Testing-Platform-Interaction.md)
* [https://mas.owasp.org/MASTG/tests/ios/MASVS-PLATFORM/MASTG-TEST-0069/](https://mas.owasp.org/MASTG/tests/ios/MASVS-PLATFORM/MASTG-TEST-0069/)
* [https://mas.owasp.org/MASTG/iOS/0x06h-Testing-Platform-Interaction/](https://mas.owasp.org/MASTG/iOS/0x06h-Testing-Platform-Interaction/)



{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
