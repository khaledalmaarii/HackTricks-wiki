{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

# Separa√ß√£o de Privil√©gios e Sandbox

No iOS, existe uma distin√ß√£o de privil√©gio entre os aplicativos acess√≠veis ao usu√°rio e os processos centrais do sistema. Os aplicativos s√£o executados sob a identidade do usu√°rio **`mobile`**, enquanto os processos cruciais do sistema operam como **`root`**. Essa separa√ß√£o √© aprimorada por um mecanismo de sandbox, que imp√µe limita√ß√µes rigorosas sobre quais a√ß√µes os aplicativos podem realizar. Por exemplo, mesmo que os aplicativos compartilhem a mesma identidade de usu√°rio, eles s√£o proibidos de acessar ou modificar os dados uns dos outros.

Os aplicativos s√£o instalados em um diret√≥rio espec√≠fico (`private/var/mobile/Applications/{random ID}`) e t√™m acesso de leitura restrito a certas √°reas e funcionalidades do sistema, como SMS e chamadas telef√¥nicas. O acesso a √°reas protegidas aciona um pedido de permiss√£o do usu√°rio.

# Prote√ß√£o de Dados

O iOS oferece aos desenvolvedores as **APIs de Prote√ß√£o de Dados**, constru√≠das sobre o Secure Enclave Processor (SEP) ‚Äî um coprocessador dedicado para opera√ß√µes criptogr√°ficas e gerenciamento de chaves. O SEP garante a integridade da prote√ß√£o de dados por meio de uma chave espec√≠fica do dispositivo, o UID do dispositivo, incorporada a ele.

Ao criar um arquivo, uma chave de criptografia AES de 256 bits √∫nica √© gerada, criptografando o conte√∫do do arquivo. Essa chave de criptografia, juntamente com um ID de classe, √© ent√£o criptografada usando uma chave de classe e armazenada nos metadados do arquivo. A descriptografia de um arquivo envolve o uso da chave do sistema para acessar os metadados, recuperando a chave de classe com o ID de classe e, em seguida, descriptografando a chave de criptografia √∫nica do arquivo.

O iOS define **quatro classes de prote√ß√£o** para seguran√ßa de dados, que determinam quando e como os dados podem ser acessados:

- **Prote√ß√£o Completa (NSFileProtectionComplete)**: Os dados s√£o inacess√≠veis at√© que o dispositivo seja desbloqueado usando o c√≥digo de acesso do usu√°rio.
- **Protegido, a Menos que Esteja Aberto (NSFileProtectionCompleteUnlessOpen)**: Permite o acesso ao arquivo mesmo ap√≥s o dispositivo estar bloqueado, desde que o arquivo tenha sido aberto quando o dispositivo foi desbloqueado.
- **Protegido At√© a Primeira Autentica√ß√£o do Usu√°rio (NSFileProtectionCompleteUntilFirstUserAuthentication)**: Os dados s√£o acess√≠veis ap√≥s a primeira desbloqueio do usu√°rio ap√≥s a inicializa√ß√£o, permanecendo acess√≠veis mesmo que o dispositivo seja bloqueado novamente.
- **Sem Prote√ß√£o (NSFileProtectionNone)**: Os dados s√£o protegidos apenas pelo UID do dispositivo, facilitando a exclus√£o remota r√°pida de dados.

A criptografia de todas as classes, exceto `NSFileProtectionNone`, envolve uma chave derivada tanto do UID do dispositivo quanto do c√≥digo de acesso do usu√°rio, garantindo que a descriptografia s√≥ seja poss√≠vel no dispositivo com o c√≥digo de acesso correto. A partir do iOS 7, a classe de prote√ß√£o padr√£o √© "Protegido At√© a Primeira Autentica√ß√£o do Usu√°rio".

Os desenvolvedores podem usar [**FileDP**](https://github.com/abjurato/FileDp-Source), uma ferramenta para inspecionar a classe de prote√ß√£o de dados de arquivos em um iPhone.
```python
# Example code to use FileDP for checking file protection class
# Note: Ensure your device is jailbroken and has Python installed to use FileDP.
# Installation and usage of FileDP:
git clone https://github.com/abjurato/FileDp-Source
cd FileDp-Source
python filedp.py /path/to/check
```
## **O Keychain**

No iOS, um **Keychain** serve como um **container criptografado seguro** para armazenar **informa√ß√µes sens√≠veis**, acess√≠vel apenas pelo aplicativo que o armazenou ou aqueles explicitamente autorizados. Essa criptografia √© refor√ßada por uma **senha √∫nica gerada pelo iOS**, que por sua vez √© criptografada com **AES**. Esse processo de criptografia utiliza uma **fun√ß√£o PBKDF2**, combinando o c√≥digo de acesso do usu√°rio com um sal derivado do **UID** do dispositivo, um componente que apenas o **chipset de enclave seguro** pode acessar. Consequentemente, mesmo que o c√≥digo de acesso do usu√°rio seja conhecido, o conte√∫do do Keychain permanece inacess√≠vel em qualquer dispositivo que n√£o seja aquele onde foi originalmente criptografado.

**Gerenciamento e acesso** aos dados do Keychain s√£o tratados pelo **daemon `securityd`**, com base em direitos espec√≠ficos do aplicativo, como `Keychain-access-groups` e `application-identifier`.

### **Opera√ß√µes da API do Keychain**

A API do Keychain, detalhada na [documenta√ß√£o dos Servi√ßos de Keychain da Apple](https://developer.apple.com/library/content/documentation/Security/Conceptual/keychainServConcepts/02concepts/concepts.html), fornece fun√ß√µes essenciais para gerenciamento seguro de armazenamento:

- **`SecItemAdd`**: Adiciona um novo item ao Keychain.
- **`SecItemUpdate`**: Atualiza um item existente no Keychain.
- **`SecItemCopyMatching`**: Recupera um item do Keychain.
- **`SecItemDelete`**: Remove um item do Keychain.

For√ßar a senha do Keychain envolve atacar a chave criptografada diretamente ou tentar adivinhar o c√≥digo de acesso no pr√≥prio dispositivo, dificultado significativamente pela aplica√ß√£o de um atraso entre tentativas falhas pelo enclave seguro.

### **Configurando a Prote√ß√£o de Dados do Item do Keychain**

Os n√≠veis de prote√ß√£o de dados para itens do Keychain s√£o definidos usando o atributo `kSecAttrAccessible` durante a cria√ß√£o ou atualiza√ß√£o do item. Esses n√≠veis, [conforme especificado pela Apple](https://developer.apple.com/documentation/security/keychain_services/keychain_items/item_attribute_keys_and_values#1679100), determinam quando e como os itens do Keychain s√£o acess√≠veis:

- **`kSecAttrAccessibleAlways`**: Acess√≠vel a qualquer momento, independentemente do status de bloqueio do dispositivo.
- **`kSecAttrAccessibleAlwaysThisDeviceOnly`**: Sempre acess√≠vel, mas n√£o inclu√≠do em backups.
- **`kSecAttrAccessibleAfterFirstUnlock`**: Acess√≠vel ap√≥s o primeiro desbloqueio ap√≥s a reinicializa√ß√£o.
- **`kSecAttrAccessibleAfterFirstUnlockThisDeviceOnly`**: Igual ao acima, mas n√£o transfer√≠vel para novos dispositivos.
- **`kSecAttrAccessibleWhenUnlocked`**: Apenas acess√≠vel quando o dispositivo est√° desbloqueado.
- **`kSecAttrAccessibleWhenUnlockedThisDeviceOnly`**: Acess√≠vel quando desbloqueado, n√£o inclu√≠do em backups.
- **`kSecAttrAccessibleWhenPasscodeSetThisDeviceOnly`**: Requer c√≥digo de acesso do dispositivo, n√£o inclu√≠do em backups.

**`AccessControlFlags`** refinam ainda mais os m√©todos de acesso, permitindo autentica√ß√£o biom√©trica ou uso de c√≥digo de acesso.

### **Aviso sobre Dispositivos Jailbroken**

{% hint style="warning" %}
Em **dispositivos jailbroken**, as prote√ß√µes do Keychain est√£o comprometidas, representando um risco significativo √† seguran√ßa.
{% endhint %}

### **Persist√™ncia dos Dados do Keychain**

Ao contr√°rio dos dados espec√≠ficos do aplicativo que s√£o exclu√≠dos ap√≥s a desinstala√ß√£o do aplicativo, os **dados do Keychain persistem** no dispositivo. Essa caracter√≠stica pode permitir que novos propriet√°rios de um dispositivo de segunda m√£o acessem os dados do aplicativo do propriet√°rio anterior simplesmente reinstalando os aplicativos. Os desenvolvedores s√£o aconselhados a limpar proativamente os dados do Keychain ao instalar o aplicativo ou durante o logout para mitigar esse risco. Aqui est√° um exemplo de c√≥digo Swift demonstrando como limpar os dados do Keychain na primeira execu√ß√£o do aplicativo:
```swift
let userDefaults = UserDefaults.standard

if userDefaults.bool(forKey: "hasRunBefore") == false {
// Remove Keychain items here

// Update the flag indicator
userDefaults.set(true, forKey: "hasRunBefore")
userDefaults.synchronize() // Forces the app to update UserDefaults
}
```
# **Capacidades do App**

No √¢mbito do desenvolvimento de aplicativos, **sandboxing** desempenha um papel crucial na melhoria da seguran√ßa. Este processo garante que cada aplicativo opere dentro de seu pr√≥prio diret√≥rio exclusivo, impedindo assim que acesse arquivos do sistema ou dados pertencentes a outros aplicativos. A aplica√ß√£o dessas restri√ß√µes √© realizada por meio de pol√≠ticas de sandbox, que fazem parte do **Trusted BSD (MAC) Mandatory Access Control Framework**.

Os desenvolvedores t√™m a capacidade de configurar certas **capacidades ou permiss√µes** para seus aplicativos, como **Data Protection** ou **Keychain Sharing**. Essas permiss√µes s√£o aplicadas imediatamente ap√≥s a instala√ß√£o do aplicativo. No entanto, para acessar certos recursos protegidos, o aplicativo deve obter consentimento expl√≠cito do usu√°rio no momento da primeira tentativa. Isso √© alcan√ßado por meio do uso de _purpose strings_ ou _usage description strings_, que s√£o apresentados aos usu√°rios em um alerta de solicita√ß√£o de permiss√£o.

Para aqueles com acesso ao c√≥digo-fonte, a verifica√ß√£o das permiss√µes inclu√≠das no arquivo `Info.plist` pode ser feita da seguinte forma:

1. Abrir o projeto no Xcode.
2. Localizar e abrir o arquivo `Info.plist`.
3. Procurar por chaves prefixadas com `"Privacy -"`, com a op√ß√£o de visualizar chaves/valores brutos para clareza.

Ao lidar com um arquivo IPA, os seguintes passos podem ser seguidos:

1. Descompactar o IPA.
2. Localizar o arquivo `Info.plist` dentro de `Payload/<appname>.app/`.
3. Converter o arquivo para o formato XML, se necess√°rio, para uma inspe√ß√£o mais f√°cil.

Por exemplo, as purpose strings no arquivo `Info.plist` podem parecer assim:
```xml
<plist version="1.0">
<dict>
<key>NSLocationWhenInUseUsageDescription</key>
<string>Your location is used to provide turn-by-turn directions to your destination.</string>
```
## Device Capabilities
O arquivo `Info.plist` de um aplicativo especifica **capacidades do dispositivo** que ajudam a App Store a filtrar aplicativos para compatibilidade com o dispositivo. Estas s√£o definidas sob a chave **`UIRequiredDeviceCapabilities`**. Por exemplo:
```xml
<key>UIRequiredDeviceCapabilities</key>
<array>
<string>armv7</string>
</array>
```
Este exemplo indica que o aplicativo √© compat√≠vel com o conjunto de instru√ß√µes armv7. Os desenvolvedores tamb√©m podem especificar capacidades como nfc para garantir que seu aplicativo esteja dispon√≠vel apenas para dispositivos que suportam NFC.

## Entitlements

**Entitlements** s√£o outro aspecto cr√≠tico do desenvolvimento de aplicativos iOS, servindo como pares chave-valor que concedem permiss√µes aos aplicativos para realizar certas opera√ß√µes al√©m das verifica√ß√µes em tempo de execu√ß√£o. Por exemplo, habilitar **Data Protection** em um aplicativo envolve adicionar um entitlement espec√≠fico no projeto Xcode, que √© ent√£o refletido no arquivo de entitlements do aplicativo ou no arquivo de provisionamento m√≥vel incorporado para IPAs.


# References
* [https://mas.owasp.org/MASTG/iOS/0x06d-Testing-Data-Storage](https://mas.owasp.org/MASTG/iOS/0x06d-Testing-Data-Storage)
* [https://github.com/OWASP/owasp-mastg/blob/master/Document/0x06h-Testing-Platform-Interaction.md](https://github.com/OWASP/owasp-mastg/blob/master/Document/0x06h-Testing-Platform-Interaction.md)
* [https://mas.owasp.org/MASTG/tests/ios/MASVS-PLATFORM/MASTG-TEST-0069/](https://mas.owasp.org/MASTG/tests/ios/MASVS-PLATFORM/MASTG-TEST-0069/)
* [https://mas.owasp.org/MASTG/iOS/0x06h-Testing-Platform-Interaction/](https://mas.owasp.org/MASTG/iOS/0x06h-Testing-Platform-Interaction/)



{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
