{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

# S√©paration des privil√®ges et Sandbox

Dans iOS, une distinction de privil√®ge existe entre les applications accessibles par l'utilisateur et les processus centraux du syst√®me. Les applications s'ex√©cutent sous l'identit√© utilisateur **`mobile`**, tandis que les processus syst√®me cruciaux fonctionnent en tant que **`root`**. Cette s√©paration est renforc√©e par un m√©canisme de sandbox, qui impose des limitations strictes sur les actions que les applications peuvent entreprendre. Par exemple, m√™me si les applications partagent la m√™me identit√© utilisateur, elles sont interdites d'acc√©der ou de modifier les donn√©es des autres.

Les applications sont install√©es dans un r√©pertoire sp√©cifique (`private/var/mobile/Applications/{random ID}`) et ont un acc√®s en lecture restreint √† certaines zones et fonctionnalit√©s du syst√®me, telles que les SMS et les appels t√©l√©phoniques. L'acc√®s aux zones prot√©g√©es d√©clenche une demande de permission de l'utilisateur.

# Protection des donn√©es

iOS offre aux d√©veloppeurs les **API de Protection des Donn√©es**, construites sur le Secure Enclave Processor (SEP) ‚Äî un coprocesseur d√©di√© aux op√©rations cryptographiques et √† la gestion des cl√©s. Le SEP garantit l'int√©grit√© de la protection des donn√©es via une cl√© unique sp√©cifique √† l'appareil, l'UID de l'appareil, int√©gr√©e en son sein.

Lors de la cr√©ation d'un fichier, une cl√© de chiffrement AES unique de 256 bits est g√©n√©r√©e, chiffrant le contenu du fichier. Cette cl√© de chiffrement, accompagn√©e d'un ID de classe, est ensuite chiffr√©e √† l'aide d'une cl√© de classe et stock√©e dans les m√©tadonn√©es du fichier. Le d√©chiffrement d'un fichier implique d'utiliser la cl√© du syst√®me pour acc√©der aux m√©tadonn√©es, de r√©cup√©rer la cl√© de classe avec l'ID de classe, puis de d√©chiffrer la cl√© de chiffrement unique du fichier.

iOS d√©finit **quatre classes de protection** pour la s√©curit√© des donn√©es, qui d√©terminent quand et comment les donn√©es peuvent √™tre accessibles :

- **Protection Compl√®te (NSFileProtectionComplete)** : Les donn√©es sont inaccessibles jusqu'√† ce que l'appareil soit d√©verrouill√© √† l'aide du code d'acc√®s de l'utilisateur.
- **Prot√©g√© Sauf Ouvert (NSFileProtectionCompleteUnlessOpen)** : Permet l'acc√®s au fichier m√™me apr√®s que l'appareil soit verrouill√©, √† condition que le fichier ait √©t√© ouvert lorsque l'appareil a √©t√© d√©verrouill√©.
- **Prot√©g√© Jusqu'√† la Premi√®re Authentification Utilisateur (NSFileProtectionCompleteUntilFirstUserAuthentication)** : Les donn√©es sont accessibles apr√®s le premier d√©verrouillage de l'utilisateur apr√®s le d√©marrage, restant accessibles m√™me si l'appareil est √† nouveau verrouill√©.
- **Aucune Protection (NSFileProtectionNone)** : Les donn√©es ne sont prot√©g√©es que par l'UID de l'appareil, facilitant l'effacement rapide des donn√©es √† distance.

Le chiffrement de toutes les classes, sauf pour `NSFileProtectionNone`, implique une cl√© d√©riv√©e √† la fois de l'UID de l'appareil et du code d'acc√®s de l'utilisateur, garantissant que le d√©chiffrement n'est possible que sur l'appareil avec le bon code d'acc√®s. √Ä partir d'iOS 7, la classe de protection par d√©faut est "Prot√©g√© Jusqu'√† la Premi√®re Authentification Utilisateur".

Les d√©veloppeurs peuvent utiliser [**FileDP**](https://github.com/abjurato/FileDp-Source), un outil pour inspecter la classe de protection des donn√©es des fichiers sur un iPhone.
```python
# Example code to use FileDP for checking file protection class
# Note: Ensure your device is jailbroken and has Python installed to use FileDP.
# Installation and usage of FileDP:
git clone https://github.com/abjurato/FileDp-Source
cd FileDp-Source
python filedp.py /path/to/check
```
## **Le Trousseau**

Dans iOS, un **Trousseau** sert de **conteneur chiffr√© s√©curis√©** pour stocker des **informations sensibles**, accessibles uniquement par l'application qui les a stock√©es ou celles explicitement autoris√©es. Ce chiffrement est renforc√© par un **mot de passe unique g√©n√©r√© par iOS**, qui lui-m√™me est chiffr√© avec **AES**. Ce processus de chiffrement utilise une **fonction PBKDF2**, combinant le code d'acc√®s de l'utilisateur avec un sel d√©riv√© de l'**UID** de l'appareil, un composant auquel seul le **chipset de l'enclave s√©curis√©e** peut acc√©der. Par cons√©quent, m√™me si le code d'acc√®s de l'utilisateur est connu, le contenu du Trousseau reste inaccessible sur tout appareil autre que celui o√π il a √©t√© initialement chiffr√©.

**La gestion et l'acc√®s** aux donn√©es du Trousseau sont g√©r√©s par le **d√©mon `securityd`**, bas√© sur des droits d'application sp√©cifiques comme `Keychain-access-groups` et `application-identifier`.

### **Op√©rations de l'API Trousseau**

L'API Trousseau, d√©taill√©e dans la [documentation des services Trousseau d'Apple](https://developer.apple.com/library/content/documentation/Security/Conceptual/keychainServConcepts/02concepts/concepts.html), fournit des fonctions essentielles pour la gestion du stockage s√©curis√© :

- **`SecItemAdd`** : Ajoute un nouvel √©l√©ment au Trousseau.
- **`SecItemUpdate`** : Met √† jour un √©l√©ment existant dans le Trousseau.
- **`SecItemCopyMatching`** : R√©cup√®re un √©l√©ment du Trousseau.
- **`SecItemDelete`** : Supprime un √©l√©ment du Trousseau.

La force brute du mot de passe du Trousseau implique soit d'attaquer directement la cl√© chiffr√©e, soit d'essayer de deviner le code d'acc√®s sur l'appareil lui-m√™me, ce qui est consid√©rablement entrav√© par l'application d'un d√©lai entre les tentatives √©chou√©es par l'enclave s√©curis√©e.

### **Configuration de la Protection des Donn√©es des √âl√©ments du Trousseau**

Les niveaux de protection des donn√©es pour les √©l√©ments du Trousseau sont d√©finis √† l'aide de l'attribut `kSecAttrAccessible` lors de la cr√©ation ou de la mise √† jour de l'√©l√©ment. Ces niveaux, [comme sp√©cifi√© par Apple](https://developer.apple.com/documentation/security/keychain_services/keychain_items/item_attribute_keys_and_values#1679100), d√©terminent quand et comment les √©l√©ments du Trousseau sont accessibles :

- **`kSecAttrAccessibleAlways`** : Accessible √† tout moment, ind√©pendamment de l'√©tat de verrouillage de l'appareil.
- **`kSecAttrAccessibleAlwaysThisDeviceOnly`** : Toujours accessible, mais non inclus dans les sauvegardes.
- **`kSecAttrAccessibleAfterFirstUnlock`** : Accessible apr√®s le premier d√©verrouillage apr√®s un red√©marrage.
- **`kSecAttrAccessibleAfterFirstUnlockThisDeviceOnly`** : M√™me que ci-dessus, mais non transf√©rable √† de nouveaux appareils.
- **`kSecAttrAccessibleWhenUnlocked`** : Accessible uniquement lorsque l'appareil est d√©verrouill√©.
- **`kSecAttrAccessibleWhenUnlockedThisDeviceOnly`** : Accessible lorsqu'il est d√©verrouill√©, non inclus dans les sauvegardes.
- **`kSecAttrAccessibleWhenPasscodeSetThisDeviceOnly`** : N√©cessite le code d'acc√®s de l'appareil, non inclus dans les sauvegardes.

**`AccessControlFlags`** affinent encore les m√©thodes d'acc√®s, permettant l'authentification biom√©trique ou l'utilisation du code d'acc√®s.

### **Avertissement sur les Appareils Jailbreak√©s**

{% hint style="warning" %}
Sur les **appareils jailbreak√©s**, les protections du Trousseau sont compromises, posant un risque de s√©curit√© significatif.
{% endhint %}

### **Persistance des Donn√©es du Trousseau**

Contrairement aux donn√©es sp√©cifiques √† l'application supprim√©es lors de la d√©sinstallation de l'application, **les donn√©es du Trousseau persistent** sur l'appareil. Cette caract√©ristique pourrait permettre aux nouveaux propri√©taires d'un appareil d'occasion d'acc√©der aux donn√©es d'application de l'ancien propri√©taire simplement en r√©installant les applications. Il est conseill√© aux d√©veloppeurs de nettoyer proactivement les donn√©es du Trousseau lors de l'installation de l'application ou lors de la d√©connexion pour att√©nuer ce risque. Voici un exemple de code Swift d√©montrant comment effacer les donn√©es du Trousseau lors du premier lancement de l'application :
```swift
let userDefaults = UserDefaults.standard

if userDefaults.bool(forKey: "hasRunBefore") == false {
// Remove Keychain items here

// Update the flag indicator
userDefaults.set(true, forKey: "hasRunBefore")
userDefaults.synchronize() // Forces the app to update UserDefaults
}
```
# **Capacit√©s de l'Application**

Dans le domaine du d√©veloppement d'applications, **sandboxing** joue un r√¥le crucial dans l'am√©lioration de la s√©curit√©. Ce processus garantit que chaque application fonctionne dans son propre r√©pertoire personnel unique, emp√™chant ainsi l'acc√®s aux fichiers syst√®me ou aux donn√©es appartenant √† d'autres applications. L'application de ces restrictions est effectu√©e par le biais de politiques de sandbox, qui font partie du **Trusted BSD (MAC) Mandatory Access Control Framework**.

Les d√©veloppeurs ont la possibilit√© de configurer certaines **capacit√©s ou autorisations** pour leurs applications, telles que **Data Protection** ou **Keychain Sharing**. Ces autorisations sont appliqu√©es imm√©diatement apr√®s l'installation de l'application. N√©anmoins, pour acc√©der √† certaines ressources prot√©g√©es, l'application doit obtenir le consentement explicite de l'utilisateur au moment de la premi√®re tentative. Cela se fait par l'utilisation de _purpose strings_ ou _usage description strings_, qui sont pr√©sent√©es aux utilisateurs dans une alerte de demande d'autorisation.

Pour ceux ayant acc√®s au code source, la v√©rification des autorisations incluses dans le fichier `Info.plist` peut √™tre effectu√©e en :

1. Ouvrant le projet dans Xcode.
2. Localisant et ouvrant le fichier `Info.plist`.
3. Cherchant des cl√©s pr√©fix√©es par `"Privacy -"`, avec l'option de visualiser les cl√©s/valeurs brutes pour plus de clart√©.

Lorsqu'il s'agit d'un fichier IPA, les √©tapes suivantes peuvent √™tre suivies :

1. D√©compresser l'IPA.
2. Localiser le fichier `Info.plist` dans `Payload/<appname>.app/`.
3. Convertir le fichier au format XML si n√©cessaire, pour une inspection plus facile.

Par exemple, les purpose strings dans le fichier `Info.plist` pourraient ressembler √† ceci :
```xml
<plist version="1.0">
<dict>
<key>NSLocationWhenInUseUsageDescription</key>
<string>Your location is used to provide turn-by-turn directions to your destination.</string>
```
## Capacit√©s de l'appareil
Le fichier `Info.plist` d'une application sp√©cifie les **capacit√©s de l'appareil** qui aident l'App Store √† filtrer les applications pour la compatibilit√© des appareils. Celles-ci sont d√©finies sous la cl√© **`UIRequiredDeviceCapabilities`**. Par exemple :
```xml
<key>UIRequiredDeviceCapabilities</key>
<array>
<string>armv7</string>
</array>
```
Cet exemple indique que l'application est compatible avec l'ensemble d'instructions armv7. Les d√©veloppeurs peuvent √©galement sp√©cifier des capacit√©s comme nfc pour s'assurer que leur application n'est disponible que sur des appareils prenant en charge NFC.

## Droits

Les **droits** sont un autre aspect critique du d√©veloppement d'applications iOS, servant de paires cl√©-valeur qui accordent aux applications la permission d'effectuer certaines op√©rations au-del√† des v√©rifications d'ex√©cution. Par exemple, activer la **protection des donn√©es** dans une application implique d'ajouter un droit sp√©cifique dans le projet Xcode, qui est ensuite refl√©t√© dans le fichier de droits de l'application ou le fichier de provisionnement mobile int√©gr√© pour les IPA.


# R√©f√©rences
* [https://mas.owasp.org/MASTG/iOS/0x06d-Testing-Data-Storage](https://mas.owasp.org/MASTG/iOS/0x06d-Testing-Data-Storage)
* [https://github.com/OWASP/owasp-mastg/blob/master/Document/0x06h-Testing-Platform-Interaction.md](https://github.com/OWASP/owasp-mastg/blob/master/Document/0x06h-Testing-Platform-Interaction.md)
* [https://mas.owasp.org/MASTG/tests/ios/MASVS-PLATFORM/MASTG-TEST-0069/](https://mas.owasp.org/MASTG/tests/ios/MASVS-PLATFORM/MASTG-TEST-0069/)
* [https://mas.owasp.org/MASTG/iOS/0x06h-Testing-Platform-Interaction/](https://mas.owasp.org/MASTG/iOS/0x06h-Testing-Platform-Interaction/)



{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
