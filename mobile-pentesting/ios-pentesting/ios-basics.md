<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

# Separacija privilegija i pesak

U iOS-u postoji razlika u privilegijama izmeÄ‘u aplikacija koje su dostupne korisniku i osnovnih procesa sistema. Aplikacije se izvrÅ¡avaju pod identitetom korisnika **`mobile`**, dok kljuÄni sistemski procesi rade kao **`root`**. Ova separacija je poboljÅ¡ana mehanizmom peska, koji nameÄ‡e stroga ograniÄenja na akcije koje aplikacije mogu preduzeti. Na primer, Äak i ako aplikacije dele isti korisniÄki identitet, zabranjeno im je pristupanje ili menjanje podataka drugih aplikacija.

Aplikacije se instaliraju u odreÄ‘eni direktorijum (`private/var/mobile/Applications/{random ID}`) i imaju ograniÄen pristup odreÄ‘enim sistemskim podruÄjima i funkcionalnostima, kao Å¡to su SMS poruke i telefonski pozivi. Pristup zaÅ¡tiÄ‡enim podruÄjima pokreÄ‡e zahtev za dozvolu korisnika.

# ZaÅ¡tita podataka

iOS nudi programerima **Data Protection APIs**, izgraÄ‘ene na Secure Enclave Processor (SEP) - posebnom koprocessoru za kriptografske operacije i upravljanje kljuÄevima. SEP obezbeÄ‘uje integritet zaÅ¡tite podataka putem jedinstvenog kljuÄa specifiÄnog za ureÄ‘aj, UID ureÄ‘aja, koji je ugraÄ‘en u njega.

Prilikom kreiranja datoteke, generiÅ¡e se jedinstveni 256-bitni AES kljuÄ za Å¡ifrovanje sadrÅ¾aja datoteke. Ovaj kljuÄ za Å¡ifrovanje, zajedno sa ID-em klase, zatim se Å¡ifruje pomoÄ‡u kljuÄa klase i Äuva unutar metapodataka datoteke. Dekripcija datoteke ukljuÄuje koriÅ¡Ä‡enje sistema kljuÄa za pristup metapodacima, dobijanje kljuÄa klase sa ID-em klase, a zatim dekripciju jedinstvenog kljuÄa za Å¡ifrovanje datoteke.

iOS definiÅ¡e **Äetiri klase zaÅ¡tite podataka**, koje odreÄ‘uju kada i kako se podaci mogu pristupiti:

- **Potpuna zaÅ¡tita (NSFileProtectionComplete)**: Podaci su nedostupni sve dok se ureÄ‘aj ne otkljuÄa korisnikovim Å¡ifrom.
- **ZaÅ¡tiÄ‡eno osim ako je otvoreno (NSFileProtectionCompleteUnlessOpen)**: OmoguÄ‡ava pristup datoteci Äak i nakon Å¡to je ureÄ‘aj zakljuÄan, pod uslovom da je datoteka otvorena kada je ureÄ‘aj otkljuÄan.
- **ZaÅ¡tiÄ‡eno do prve autentifikacije korisnika (NSFileProtectionCompleteUntilFirstUserAuthentication)**: Podaci su dostupni nakon prve otkljuÄane korisniÄke autentifikacije nakon pokretanja, i ostaju dostupni Äak i ako se ureÄ‘aj ponovo zakljuÄa.
- **Bez zaÅ¡tite (NSFileProtectionNone)**: Podaci su zaÅ¡tiÄ‡eni samo UID-om ureÄ‘aja, Å¡to omoguÄ‡ava brisanje podataka na daljinu.

Å ifrovanje svih klasa, osim `NSFileProtectionNone`, ukljuÄuje kljuÄ koji se dobija iz UID-a ureÄ‘aja i korisniÄke Å¡ifre, Äime se osigurava da se dekripcija moÅ¾e izvrÅ¡iti samo na ureÄ‘aju sa ispravnom Å¡ifrom. Od iOS 7, podrazumevana klasa zaÅ¡tite je "ZaÅ¡tiÄ‡eno do prve autentifikacije korisnika".

Programeri mogu koristiti [**FileDP**](https://github.com/abjurato/FileDp-Source), alat za pregledanje klase zaÅ¡tite podataka datoteka na iPhone-u.
```python
# Example code to use FileDP for checking file protection class
# Note: Ensure your device is jailbroken and has Python installed to use FileDP.
# Installation and usage of FileDP:
git clone https://github.com/abjurato/FileDp-Source
cd FileDp-Source
python filedp.py /path/to/check
```
## **Keychain**

U iOS-u, **Keychain** sluÅ¾i kao siguran **Å¡ifrovan kontejner** za skladiÅ¡tenje **osetljivih informacija**, koji je dostupan samo aplikaciji koja ga je skladiÅ¡tila ili onima koji su eksplicitno ovlaÅ¡Ä‡eni. Ova enkripcija je ojaÄana jedinstvenom **lozinkom generisanom od strane iOS-a**, koja je sama po sebi enkriptovana sa **AES-om**. Ovaj proces enkripcije koristi **PBKDF2 funkciju**, kombinujuÄ‡i korisnikovu lozinku sa solju izvedenom iz **UID-a** ureÄ‘aja, komponentom kojoj samo **bezbedni enklavni Äipset** moÅ¾e pristupiti. Kao rezultat toga, Äak i ako je korisnikova lozinka poznata, sadrÅ¾aj Keychain-a ostaje nedostupan na bilo kom ureÄ‘aju osim onog na kojem je originalno enkriptovan.

**Upravljanje i pristup** podacima Keychain-a se obavljaju putem **`securityd` demona**, na osnovu odreÄ‘enih privilegija aplikacije kao Å¡to su `Keychain-access-groups` i `application-identifier`.

### **Operacije Keychain API-ja**

Keychain API, detaljno opisan u [dokumentaciji Apple-ovih Keychain Services](https://developer.apple.com/library/content/documentation/Security/Conceptual/keychainServConcepts/02concepts/concepts.html), pruÅ¾a osnovne funkcije za upravljanje sigurnim skladiÅ¡tenjem:

- **`SecItemAdd`**: Dodaje novu stavku u Keychain.
- **`SecItemUpdate`**: AÅ¾urira postojeÄ‡u stavku u Keychain-u.
- **`SecItemCopyMatching`**: Preuzima stavku iz Keychain-a.
- **`SecItemDelete`**: Uklanja stavku iz Keychain-a.

Brute-forcing Keychain lozinke ukljuÄuje ili napad na enkriptovan kljuÄ direktno ili pokuÅ¡aj pogodjenja lozinke na samom ureÄ‘aju, Å¡to je znaÄajno oteÅ¾ano zbog bezbednog enklavnog sprovoÄ‘enja kaÅ¡njenja izmeÄ‘u neuspelih pokuÅ¡aja.

### **Konfigurisanje zaÅ¡tite podataka Keychain stavki**

Nivoi zaÅ¡tite podataka za Keychain stavke se postavljaju pomoÄ‡u atributa `kSecAttrAccessible` prilikom kreiranja ili aÅ¾uriranja stavke. Ovi nivoi, [kako je navedeno od strane Apple-a](https://developer.apple.com/documentation/security/keychain_services/keychain_items/item_attribute_keys_and_values#1679100), odreÄ‘uju kada i kako su Keychain stavke dostupne:

- **`kSecAttrAccessibleAlways`**: Uvek dostupno, bez obzira na status zakljuÄavanja ureÄ‘aja.
- **`kSecAttrAccessibleAlwaysThisDeviceOnly`**: Uvek dostupno, ali nije ukljuÄeno u rezervne kopije.
- **`kSecAttrAccessibleAfterFirstUnlock`**: Dostupno nakon prvog otkljuÄavanja nakon restarta.
- **`kSecAttrAccessibleAfterFirstUnlockThisDeviceOnly`**: Isto kao prethodno, ali nije prenosivo na nove ureÄ‘aje.
- **`kSecAttrAccessibleWhenUnlocked`**: Dostupno samo kada je ureÄ‘aj otkljuÄan.
- **`kSecAttrAccessibleWhenUnlockedThisDeviceOnly`**: Dostupno kada je otkljuÄano, nije ukljuÄeno u rezervne kopije.
- **`kSecAttrAccessibleWhenPasscodeSetThisDeviceOnly`**: Zahteva lozinku ureÄ‘aja, nije ukljuÄeno u rezervne kopije.

**`AccessControlFlags`** dodatno preciziraju metode pristupa, omoguÄ‡avajuÄ‡i biometrijsku autentifikaciju ili upotrebu lozinke.

### **Upozorenje za jailbroken ureÄ‘aje**

{% hint style="warning" %}
Na **jailbroken ureÄ‘ajima**, zaÅ¡tite Keychain-a su kompromitovane, Å¡to predstavlja znaÄajan sigurnosni rizik.
{% endhint %}

### **Trajnost Keychain podataka**

Za razliku od podataka specifiÄnih za aplikaciju koji se briÅ¡u prilikom deinstalacije aplikacije, **Keychain podaci persistiraju** na ureÄ‘aju. Ova karakteristika omoguÄ‡ava novim vlasnicima polovnog ureÄ‘aja da pristupe podacima prethodnog vlasnika aplikacije jednostavno reinstaliranjem aplikacija. Razvojni programeri se savetuju da proaktivno briÅ¡u Keychain podatke prilikom instalacije aplikacije ili tokom odjavljivanja kako bi umanjili ovaj rizik. Evo primera Swift koda koji demonstrira kako obrisati Keychain podatke prilikom prvog pokretanja aplikacije:
```swift
let userDefaults = UserDefaults.standard

if userDefaults.bool(forKey: "hasRunBefore") == false {
// Remove Keychain items here

// Update the flag indicator
userDefaults.set(true, forKey: "hasRunBefore")
userDefaults.synchronize() // Forces the app to update UserDefaults
}
```
# **MoguÄ‡nosti aplikacije**

U svetu razvoja aplikacija, **sandboxing** igra kljuÄnu ulogu u poboljÅ¡anju bezbednosti. Ovaj proces osigurava da svaka aplikacija radi unutar svog sopstvenog jedinstvenog direktorijuma, Äime se spreÄava pristup sistemskim fajlovima ili podacima drugih aplikacija. SprovoÄ‘enje ovih ograniÄenja vrÅ¡i se putem sandbox politika, koje su deo **Trusted BSD (MAC) Mandatory Access Control Framework**.

Razvojni programeri imaju moguÄ‡nost konfigurisanja odreÄ‘enih **moguÄ‡nosti ili dozvola** za svoje aplikacije, kao Å¡to su **ZaÅ¡tita podataka** ili **Deljenje kljuÄeva**. Ove dozvole se primenjuju odmah nakon instaliranja aplikacije. MeÄ‘utim, za pristup odreÄ‘enim zaÅ¡tiÄ‡enim resursima, aplikacija mora dobiti izriÄitu saglasnost korisnika prilikom prvog pokuÅ¡aja. To se postiÅ¾e kroz upotrebu _purpose strings_ ili _usage description strings_, koji se prikazuju korisnicima u zahtevu za dozvolu.

Za one koji imaju pristup izvornom kodu, provera dozvola koje su ukljuÄene u `Info.plist` fajl moÅ¾e se obaviti na sledeÄ‡i naÄin:

1. Otvorite projekat u Xcode-u.
2. PronaÄ‘ite i otvorite `Info.plist` fajl.
3. PretraÅ¾ite kljuÄeve sa prefiksom `"Privacy -"`, sa opcijom prikaza sirovih kljuÄeva/vrednosti radi jasnoÄ‡e.

Kada se radi sa IPA fajlom, mogu se pratiti sledeÄ‡i koraci:

1. Dekompresirajte IPA fajl.
2. PronaÄ‘ite `Info.plist` fajl unutar `Payload/<naziv_aplikacije>.app/`.
3. Konvertujte fajl u XML format ako je potrebno, radi lakÅ¡eg pregleda.

Na primer, purpose strings u `Info.plist` fajlu mogu izgledati ovako:
```xml
<plist version="1.0">
<dict>
<key>NSLocationWhenInUseUsageDescription</key>
<string>Your location is used to provide turn-by-turn directions to your destination.</string>
```
## MoguÄ‡nosti ureÄ‘aja
Fajl `Info.plist` aplikacije specificira **moguÄ‡nosti ureÄ‘aja** koje pomaÅ¾u App Store-u da filtrira aplikacije prema kompatibilnosti ureÄ‘aja. Ove moguÄ‡nosti su definisane pod kljuÄem **`UIRequiredDeviceCapabilities`**. Na primer:
```xml
<key>UIRequiredDeviceCapabilities</key>
<array>
<string>armv7</string>
</array>
```
Ovaj primer ukazuje da je aplikacija kompatibilna sa skupom instrukcija armv7. Razvojni programeri takoÄ‘e mogu specificirati moguÄ‡nosti kao Å¡to je nfc kako bi osigurali da njihova aplikacija bude dostupna samo ureÄ‘ajima koji podrÅ¾avaju NFC.

## OvlaÅ¡Ä‡enja

**OvlaÅ¡Ä‡enja** su joÅ¡ jedan kljuÄni aspekt razvoja iOS aplikacija, koji sluÅ¾e kao parovi kljuÄ-vrednost koji dodeljuju aplikacijama dozvole za obavljanje odreÄ‘enih operacija izvan vremena izvrÅ¡avanja. Na primer, omoguÄ‡avanje **ZaÅ¡tite podataka** u aplikaciji ukljuÄuje dodavanje odreÄ‘enog ovlaÅ¡Ä‡enja u Xcode projekat, koje se zatim odraÅ¾ava u datoteci ovlaÅ¡Ä‡enja aplikacije ili u ugraÄ‘enoj mobilnoj provizionoj datoteci za IPAs.

# Reference
* [https://mas.owasp.org/MASTG/iOS/0x06d-Testing-Data-Storage](https://mas.owasp.org/MASTG/iOS/0x06d-Testing-Data-Storage)
* [https://github.com/OWASP/owasp-mastg/blob/master/Document/0x06h-Testing-Platform-Interaction.md](https://github.com/OWASP/owasp-mastg/blob/master/Document/0x06h-Testing-Platform-Interaction.md)
* [https://mas.owasp.org/MASTG/tests/ios/MASVS-PLATFORM/MASTG-TEST-0069/](https://mas.owasp.org/MASTG/tests/ios/MASVS-PLATFORM/MASTG-TEST-0069/)
* [https://mas.owasp.org/MASTG/iOS/0x06h-Testing-Platform-Interaction/](https://mas.owasp.org/MASTG/iOS/0x06h-Testing-Platform-Interaction/)



<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **oglaÅ¡avanje vaÅ¡e kompanije u HackTricks-u** ili **preuzmete HackTricks u PDF formatu**, proverite [**PLANOVE ZA PRETPLATU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
