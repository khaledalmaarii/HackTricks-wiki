{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

# Separacja uprawnieÅ„ i piaskownica

W iOS istnieje rozrÃ³Å¼nienie w uprawnieniach miÄ™dzy aplikacjami dostÄ™pnymi dla uÅ¼ytkownika a podstawowymi procesami systemowymi. Aplikacje dziaÅ‚ajÄ… pod toÅ¼samoÅ›ciÄ… uÅ¼ytkownika **`mobile`**, podczas gdy kluczowe procesy systemowe dziaÅ‚ajÄ… jako **`root`**. To rozdzielenie jest wzmocnione mechanizmem piaskownicy, ktÃ³ry narzuca surowe ograniczenia dotyczÄ…ce dziaÅ‚aÅ„, jakie mogÄ… podejmowaÄ‡ aplikacje. Na przykÅ‚ad, nawet jeÅ›li aplikacje dzielÄ… tÄ™ samÄ… toÅ¼samoÅ›Ä‡ uÅ¼ytkownika, nie majÄ… prawa dostÄ™pu ani modyfikacji danych innych aplikacji.

Aplikacje sÄ… instalowane w okreÅ›lonym katalogu (`private/var/mobile/Applications/{random ID}`) i majÄ… ograniczony dostÄ™p do odczytu niektÃ³rych obszarÃ³w systemowych i funkcji, takich jak SMS i poÅ‚Ä…czenia telefoniczne. DostÄ™p do chronionych obszarÃ³w wywoÅ‚uje proÅ›bÄ™ o zgodÄ™ uÅ¼ytkownika.

# Ochrona danych

iOS oferuje deweloperom **API Ochrony Danych**, zbudowane na Secure Enclave Processor (SEP) â€” dedykowanym koprocesorze do operacji kryptograficznych i zarzÄ…dzania kluczami. SEP zapewnia integralnoÅ›Ä‡ ochrony danych za pomocÄ… unikalnego klucza specyficznego dla urzÄ…dzenia, UID urzÄ…dzenia, wbudowanego w niego.

Po utworzeniu pliku generowany jest unikalny klucz szyfrowania AES o dÅ‚ugoÅ›ci 256 bitÃ³w, ktÃ³ry szyfruje zawartoÅ›Ä‡ pliku. Ten klucz szyfrowania, wraz z identyfikatorem klasy, jest nastÄ™pnie szyfrowany za pomocÄ… klucza klasy i przechowywany w metadanych pliku. Odszyfrowanie pliku polega na uÅ¼yciu klucza systemowego do uzyskania dostÄ™pu do metadanych, odzyskaniu klucza klasy za pomocÄ… identyfikatora klasy, a nastÄ™pnie odszyfrowaniu unikalnego klucza szyfrowania pliku.

iOS definiuje **cztery klasy ochrony** dla bezpieczeÅ„stwa danych, ktÃ³re okreÅ›lajÄ…, kiedy i jak dane mogÄ… byÄ‡ dostÄ™pne:

- **PeÅ‚na ochrona (NSFileProtectionComplete)**: Dane sÄ… niedostÄ™pne, dopÃ³ki urzÄ…dzenie nie zostanie odblokowane za pomocÄ… kodu dostÄ™pu uÅ¼ytkownika.
- **Chronione, chyba Å¼e otwarte (NSFileProtectionCompleteUnlessOpen)**: UmoÅ¼liwia dostÄ™p do pliku nawet po zablokowaniu urzÄ…dzenia, pod warunkiem, Å¼e plik byÅ‚ otwarty, gdy urzÄ…dzenie zostaÅ‚o odblokowane.
- **Chronione do pierwszej autoryzacji uÅ¼ytkownika (NSFileProtectionCompleteUntilFirstUserAuthentication)**: Dane sÄ… dostÄ™pne po pierwszym odblokowaniu przez uÅ¼ytkownika po uruchomieniu, pozostajÄ…c dostÄ™pnymi nawet jeÅ›li urzÄ…dzenie zostanie zablokowane ponownie.
- **Brak ochrony (NSFileProtectionNone)**: Dane sÄ… chronione tylko przez UID urzÄ…dzenia, co uÅ‚atwia szybkie zdalne usuwanie danych.

Szyfrowanie wszystkich klas, z wyjÄ…tkiem `NSFileProtectionNone`, polega na kluczu pochodzÄ…cym zarÃ³wno z UID urzÄ…dzenia, jak i kodu dostÄ™pu uÅ¼ytkownika, co zapewnia, Å¼e odszyfrowanie jest moÅ¼liwe tylko na urzÄ…dzeniu z poprawnym kodem dostÄ™pu. Od iOS 7 domyÅ›lnÄ… klasÄ… ochrony jest "Chronione do pierwszej autoryzacji uÅ¼ytkownika".

Deweloperzy mogÄ… korzystaÄ‡ z [**FileDP**](https://github.com/abjurato/FileDp-Source), narzÄ™dzia do sprawdzania klasy ochrony danych plikÃ³w na iPhonie.
```python
# Example code to use FileDP for checking file protection class
# Note: Ensure your device is jailbroken and has Python installed to use FileDP.
# Installation and usage of FileDP:
git clone https://github.com/abjurato/FileDp-Source
cd FileDp-Source
python filedp.py /path/to/check
```
## **Keychain**

W iOS, **Keychain** sÅ‚uÅ¼y jako bezpieczny **szyfrowany kontener** do przechowywania **wraÅ¼liwych informacji**, dostÄ™pny tylko dla aplikacji, ktÃ³ra go przechowuje lub tych, ktÃ³re sÄ… wyraÅºnie autoryzowane. To szyfrowanie jest wzmacniane przez unikalne **hasÅ‚o generowane przez iOS**, ktÃ³re samo w sobie jest szyfrowane za pomocÄ… **AES**. Proces szyfrowania wykorzystuje funkcjÄ™ **PBKDF2**, Å‚Ä…czÄ…c kod dostÄ™pu uÅ¼ytkownika z solÄ… pochodzÄ…cÄ… z **UID** urzÄ…dzenia, komponentem, do ktÃ³rego dostÄ™p ma tylko **ukÅ‚ad scalony secure enclave**. W konsekwencji, nawet jeÅ›li kod dostÄ™pu uÅ¼ytkownika jest znany, zawartoÅ›Ä‡ Keychain pozostaje niedostÄ™pna na jakimkolwiek urzÄ…dzeniu innym niÅ¼ to, na ktÃ³rym pierwotnie zostaÅ‚a zaszyfrowana.

**ZarzÄ…dzanie i dostÄ™p** do danych Keychain sÄ… obsÅ‚ugiwane przez demona **`securityd`**, w oparciu o konkretne uprawnienia aplikacji, takie jak `Keychain-access-groups` i `application-identifier`.

### **Operacje API Keychain**

API Keychain, szczegÃ³Å‚owo opisane w [dokumentacji usÅ‚ug Keychain Apple](https://developer.apple.com/library/content/documentation/Security/Conceptual/keychainServConcepts/02concepts/concepts.html), zapewnia niezbÄ™dne funkcje do zarzÄ…dzania bezpiecznym przechowywaniem:

- **`SecItemAdd`**: Dodaje nowy element do Keychain.
- **`SecItemUpdate`**: Aktualizuje istniejÄ…cy element w Keychain.
- **`SecItemCopyMatching`**: Pobiera element z Keychain.
- **`SecItemDelete`**: Usuwa element z Keychain.

Brute-forcing hasÅ‚a Keychain polega na atakowaniu zaszyfrowanego klucza bezpoÅ›rednio lub prÃ³bie odgadniÄ™cia kodu dostÄ™pu na samym urzÄ…dzeniu, co jest znacznie utrudnione przez egzekwowanie opÃ³Åºnienia miÄ™dzy nieudanymi prÃ³bami przez secure enclave.

### **Konfigurowanie ochrony danych elementÃ³w Keychain**

Poziomy ochrony danych dla elementÃ³w Keychain sÄ… ustawiane za pomocÄ… atrybutu `kSecAttrAccessible` podczas tworzenia lub aktualizacji elementu. Poziomy te, [zgodnie z okreÅ›leniami Apple](https://developer.apple.com/documentation/security/keychain_services/keychain_items/item_attribute_keys_and_values#1679100), okreÅ›lajÄ…, kiedy i jak elementy Keychain sÄ… dostÄ™pne:

- **`kSecAttrAccessibleAlways`**: DostÄ™pne w kaÅ¼dej chwili, niezaleÅ¼nie od statusu blokady urzÄ…dzenia.
- **`kSecAttrAccessibleAlwaysThisDeviceOnly`**: Zawsze dostÄ™pne, ale nie wÅ‚Ä…czone do kopii zapasowych.
- **`kSecAttrAccessibleAfterFirstUnlock`**: DostÄ™pne po pierwszym odblokowaniu po restarcie.
- **`kSecAttrAccessibleAfterFirstUnlockThisDeviceOnly`**: To samo co powyÅ¼ej, ale nieprzenoszalne na nowe urzÄ…dzenia.
- **`kSecAttrAccessibleWhenUnlocked`**: DostÄ™pne tylko wtedy, gdy urzÄ…dzenie jest odblokowane.
- **`kSecAttrAccessibleWhenUnlockedThisDeviceOnly`**: DostÄ™pne po odblokowaniu, nie wÅ‚Ä…czone do kopii zapasowych.
- **`kSecAttrAccessibleWhenPasscodeSetThisDeviceOnly`**: Wymaga kodu dostÄ™pu do urzÄ…dzenia, nie wÅ‚Ä…czone do kopii zapasowych.

**`AccessControlFlags`** dodatkowo precyzujÄ… metody dostÄ™pu, umoÅ¼liwiajÄ…c uwierzytelnianie biometryczne lub uÅ¼ycie kodu dostÄ™pu.

### **OstrzeÅ¼enie o urzÄ…dzeniach z jailbreakiem**

{% hint style="warning" %}
Na **urzÄ…dzeniach z jailbreakiem**, ochrona Keychain jest naruszona, co stanowi znaczÄ…ce ryzyko bezpieczeÅ„stwa.
{% endhint %}

### **TrwaÅ‚oÅ›Ä‡ danych Keychain**

W przeciwieÅ„stwie do danych specyficznych dla aplikacji, ktÃ³re sÄ… usuwane po odinstalowaniu aplikacji, **dane Keychain pozostajÄ…** na urzÄ…dzeniu. Ta cecha moÅ¼e umoÅ¼liwiÄ‡ nowym wÅ‚aÅ›cicielom urzÄ…dzenia z drugiej rÄ™ki dostÄ™p do danych aplikacji poprzedniego wÅ‚aÅ›ciciela po prostu przez ponowne zainstalowanie aplikacji. ProgramiÅ›ci sÄ… zachÄ™cani do proaktywnego usuwania danych Keychain po instalacji aplikacji lub podczas wylogowywania, aby zminimalizowaÄ‡ to ryzyko. Oto przykÅ‚ad kodu Swift demonstrujÄ…cy, jak usunÄ…Ä‡ dane Keychain po pierwszym uruchomieniu aplikacji:
```swift
let userDefaults = UserDefaults.standard

if userDefaults.bool(forKey: "hasRunBefore") == false {
// Remove Keychain items here

// Update the flag indicator
userDefaults.set(true, forKey: "hasRunBefore")
userDefaults.synchronize() // Forces the app to update UserDefaults
}
```
# **MoÅ¼liwoÅ›ci aplikacji**

W dziedzinie rozwoju aplikacji, **sandboxing** odgrywa kluczowÄ… rolÄ™ w zwiÄ™kszaniu bezpieczeÅ„stwa. Proces ten zapewnia, Å¼e kaÅ¼da aplikacja dziaÅ‚a w swoim unikalnym katalogu domowym, co zapobiega jej dostÄ™powi do plikÃ³w systemowych lub danych naleÅ¼Ä…cych do innych aplikacji. Egzekwowanie tych ograniczeÅ„ odbywa siÄ™ poprzez polityki sandbox, ktÃ³re sÄ… czÄ™Å›ciÄ… **Trusted BSD (MAC) Mandatory Access Control Framework**.

ProgramiÅ›ci majÄ… moÅ¼liwoÅ›Ä‡ skonfigurowania okreÅ›lonych **moÅ¼liwoÅ›ci lub uprawnieÅ„** dla swoich aplikacji, takich jak **Ochrona danych** lub **UdostÄ™pnianie Keychain**. Te uprawnienia sÄ… stosowane natychmiast po zainstalowaniu aplikacji. Niemniej jednak, aby uzyskaÄ‡ dostÄ™p do niektÃ³rych chronionych zasobÃ³w, aplikacja musi uzyskaÄ‡ wyraÅºnÄ… zgodÄ™ od uÅ¼ytkownika w momencie pierwszej prÃ³by. OsiÄ…ga siÄ™ to poprzez uÅ¼ycie _ciÄ…gÃ³w celÃ³w_ lub _ciÄ…gÃ³w opisÃ³w uÅ¼ycia_, ktÃ³re sÄ… prezentowane uÅ¼ytkownikom w powiadomieniu o Å¼Ä…daniu uprawnieÅ„.

Dla tych, ktÃ³rzy majÄ… dostÄ™p do kodu ÅºrÃ³dÅ‚owego, weryfikacja uprawnieÅ„ zawartych w pliku `Info.plist` moÅ¼e byÄ‡ przeprowadzona poprzez:

1. Otworzenie projektu w Xcode.
2. Zlokalizowanie i otwarcie pliku `Info.plist`.
3. Wyszukiwanie kluczy z prefiksem `"Privacy -"`, z opcjÄ… wyÅ›wietlenia surowych kluczy/wartoÅ›ci dla jasnoÅ›ci.

W przypadku pliku IPA, moÅ¼na postÄ™powaÄ‡ wedÅ‚ug nastÄ™pujÄ…cych krokÃ³w:

1. Rozpakowanie IPA.
2. Zlokalizowanie pliku `Info.plist` w `Payload/<nazwa_aplikacji>.app/`.
3. Konwersja pliku do formatu XML, jeÅ›li to konieczne, dla Å‚atwiejszej inspekcji.

Na przykÅ‚ad, ciÄ…gi celÃ³w w pliku `Info.plist` mogÄ… wyglÄ…daÄ‡ nastÄ™pujÄ…co:
```xml
<plist version="1.0">
<dict>
<key>NSLocationWhenInUseUsageDescription</key>
<string>Your location is used to provide turn-by-turn directions to your destination.</string>
```
## Device Capabilities
Plik `Info.plist` aplikacji okreÅ›la **moÅ¼liwoÅ›ci urzÄ…dzenia**, ktÃ³re pomagajÄ… App Store filtrowaÄ‡ aplikacje pod kÄ…tem zgodnoÅ›ci z urzÄ…dzeniem. SÄ… one zdefiniowane pod kluczem **`UIRequiredDeviceCapabilities`**. Na przykÅ‚ad:
```xml
<key>UIRequiredDeviceCapabilities</key>
<array>
<string>armv7</string>
</array>
```
Ten przykÅ‚ad wskazuje, Å¼e aplikacja jest zgodna z zestawem instrukcji armv7. ProgramiÅ›ci mogÄ… rÃ³wnieÅ¼ okreÅ›liÄ‡ moÅ¼liwoÅ›ci, takie jak nfc, aby zapewniÄ‡, Å¼e ich aplikacja jest dostÄ™pna tylko dla urzÄ…dzeÅ„ obsÅ‚ugujÄ…cych NFC.

## Uprawnienia

**Uprawnienia** to kolejny kluczowy aspekt rozwoju aplikacji iOS, dziaÅ‚ajÄ…cy jako pary klucz-wartoÅ›Ä‡, ktÃ³re przyznajÄ… aplikacjom pozwolenie na wykonywanie okreÅ›lonych operacji wykraczajÄ…cych poza kontrole w czasie wykonywania. Na przykÅ‚ad, wÅ‚Ä…czenie **Ochrony Danych** w aplikacji polega na dodaniu konkretnego uprawnienia w projekcie Xcode, co jest nastÄ™pnie odzwierciedlane w pliku uprawnieÅ„ aplikacji lub w osadzonym pliku mobilnym dla IPA.

# Odniesienia
* [https://mas.owasp.org/MASTG/iOS/0x06d-Testing-Data-Storage](https://mas.owasp.org/MASTG/iOS/0x06d-Testing-Data-Storage)
* [https://github.com/OWASP/owasp-mastg/blob/master/Document/0x06h-Testing-Platform-Interaction.md](https://github.com/OWASP/owasp-mastg/blob/master/Document/0x06h-Testing-Platform-Interaction.md)
* [https://mas.owasp.org/MASTG/tests/ios/MASVS-PLATFORM/MASTG-TEST-0069/](https://mas.owasp.org/MASTG/tests/ios/MASVS-PLATFORM/MASTG-TEST-0069/)
* [https://mas.owasp.org/MASTG/iOS/0x06h-Testing-Platform-Interaction/](https://mas.owasp.org/MASTG/iOS/0x06h-Testing-Platform-Interaction/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
