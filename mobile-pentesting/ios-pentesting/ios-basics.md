{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

# Separaci√≥n de Privilegios y Sandbox

En iOS, existe una distinci√≥n en privilegios entre las aplicaciones accesibles para el usuario y los procesos centrales del sistema. Las aplicaciones se ejecutan bajo la identidad de usuario **`mobile`**, mientras que los procesos cruciales del sistema operan como **`root`**. Esta separaci√≥n se ve reforzada por un mecanismo de sandbox, que impone estrictas limitaciones sobre las acciones que pueden realizar las aplicaciones. Por ejemplo, incluso si las aplicaciones comparten la misma identidad de usuario, se les proh√≠be acceder o modificar los datos de otras.

Las aplicaciones se instalan en un directorio espec√≠fico (`private/var/mobile/Applications/{random ID}`) y tienen acceso de lectura restringido a ciertas √°reas y funcionalidades del sistema, como SMS y llamadas telef√≥nicas. El acceso a √°reas protegidas activa una solicitud emergente de permiso del usuario.

# Protecci√≥n de Datos

iOS ofrece a los desarrolladores las **APIs de Protecci√≥n de Datos**, construidas sobre el Procesador de Enclave Seguro (SEP) ‚Äî un coprocesador dedicado a operaciones criptogr√°ficas y gesti√≥n de claves. El SEP asegura la integridad de la protecci√≥n de datos a trav√©s de una clave √∫nica espec√≠fica del dispositivo, el UID del dispositivo, incrustada en √©l.

Al crear un archivo, se genera una clave de cifrado AES de 256 bits √∫nica, cifrando el contenido del archivo. Esta clave de cifrado, junto con un ID de clase, se cifra utilizando una clave de clase y se almacena dentro de los metadatos del archivo. Desencriptar un archivo implica usar la clave del sistema para acceder a los metadatos, recuperar la clave de clase con el ID de clase y luego desencriptar la clave de cifrado √∫nica del archivo.

iOS define **cuatro clases de protecci√≥n** para la seguridad de los datos, que determinan cu√°ndo y c√≥mo se puede acceder a los datos:

- **Protecci√≥n Completa (NSFileProtectionComplete)**: Los datos son inaccesibles hasta que el dispositivo se desbloquee usando el c√≥digo de acceso del usuario.
- **Protegido a Menos que Est√© Abierto (NSFileProtectionCompleteUnlessOpen)**: Permite el acceso al archivo incluso despu√©s de que el dispositivo est√© bloqueado, siempre que el archivo se haya abierto cuando el dispositivo fue desbloqueado.
- **Protegido Hasta la Primera Autenticaci√≥n del Usuario (NSFileProtectionCompleteUntilFirstUserAuthentication)**: Los datos son accesibles despu√©s de la primera desbloqueo del usuario tras el arranque, permaneciendo accesibles incluso si el dispositivo se bloquea nuevamente.
- **Sin Protecci√≥n (NSFileProtectionNone)**: Los datos est√°n protegidos solo por el UID del dispositivo, facilitando un borrado r√°pido de datos de forma remota.

El cifrado de todas las clases, excepto `NSFileProtectionNone`, implica una clave derivada tanto del UID del dispositivo como del c√≥digo de acceso del usuario, asegurando que la desencriptaci√≥n solo sea posible en el dispositivo con el c√≥digo de acceso correcto. A partir de iOS 7, la clase de protecci√≥n predeterminada es "Protegido Hasta la Primera Autenticaci√≥n del Usuario".

Los desarrolladores pueden usar [**FileDP**](https://github.com/abjurato/FileDp-Source), una herramienta para inspeccionar la clase de protecci√≥n de datos de los archivos en un iPhone.
```python
# Example code to use FileDP for checking file protection class
# Note: Ensure your device is jailbroken and has Python installed to use FileDP.
# Installation and usage of FileDP:
git clone https://github.com/abjurato/FileDp-Source
cd FileDp-Source
python filedp.py /path/to/check
```
## **El llavero**

En iOS, un **llavero** sirve como un **contenedor encriptado seguro** para almacenar **informaci√≥n sensible**, accesible solo por la aplicaci√≥n que lo almacen√≥ o aquellas expl√≠citamente autorizadas. Esta encriptaci√≥n se refuerza con una **contrase√±a √∫nica generada por iOS**, que a su vez est√° encriptada con **AES**. Este proceso de encriptaci√≥n utiliza una **funci√≥n PBKDF2**, combinando el c√≥digo de acceso del usuario con una sal derivada del **UID** del dispositivo, un componente al que solo puede acceder el **chipset de enclave seguro**. En consecuencia, incluso si se conoce el c√≥digo de acceso del usuario, el contenido del llavero permanece inaccesible en cualquier dispositivo que no sea aquel donde fueron encriptados originalmente.

**La gesti√≥n y el acceso** a los datos del llavero son manejados por el **demonio `securityd`**, basado en derechos espec√≠ficos de la aplicaci√≥n como `Keychain-access-groups` y `application-identifier`.

### **Operaciones de la API del Llavero**

La API del llavero, detallada en la [documentaci√≥n de servicios de llavero de Apple](https://developer.apple.com/library/content/documentation/Security/Conceptual/keychainServConcepts/02concepts/concepts.html), proporciona funciones esenciales para la gesti√≥n de almacenamiento seguro:

- **`SecItemAdd`**: Agrega un nuevo elemento al llavero.
- **`SecItemUpdate`**: Actualiza un elemento existente en el llavero.
- **`SecItemCopyMatching`**: Recupera un elemento del llavero.
- **`SecItemDelete`**: Elimina un elemento del llavero.

Forzar la contrase√±a del llavero implica atacar la clave encriptada directamente o intentar adivinar el c√≥digo de acceso en el dispositivo mismo, obstaculizado significativamente por la aplicaci√≥n de un retraso entre intentos fallidos por parte del enclave seguro.

### **Configuraci√≥n de la Protecci√≥n de Datos de Elementos del Llavero**

Los niveles de protecci√≥n de datos para los elementos del llavero se establecen utilizando el atributo `kSecAttrAccessible` durante la creaci√≥n o actualizaci√≥n del elemento. Estos niveles, [seg√∫n lo especificado por Apple](https://developer.apple.com/documentation/security/keychain_services/keychain_items/item_attribute_keys_and_values#1679100), determinan cu√°ndo y c√≥mo son accesibles los elementos del llavero:

- **`kSecAttrAccessibleAlways`**: Accesible en cualquier momento, independientemente del estado de bloqueo del dispositivo.
- **`kSecAttrAccessibleAlwaysThisDeviceOnly`**: Siempre accesible, pero no incluido en copias de seguridad.
- **`kSecAttrAccessibleAfterFirstUnlock`**: Accesible despu√©s del primer desbloqueo tras un reinicio.
- **`kSecAttrAccessibleAfterFirstUnlockThisDeviceOnly`**: Igual que lo anterior, pero no transferible a nuevos dispositivos.
- **`kSecAttrAccessibleWhenUnlocked`**: Solo accesible cuando el dispositivo est√° desbloqueado.
- **`kSecAttrAccessibleWhenUnlockedThisDeviceOnly`**: Accesible cuando est√° desbloqueado, no incluido en copias de seguridad.
- **`kSecAttrAccessibleWhenPasscodeSetThisDeviceOnly`**: Requiere el c√≥digo de acceso del dispositivo, no incluido en copias de seguridad.

**`AccessControlFlags`** refinan a√∫n m√°s los m√©todos de acceso, permitiendo la autenticaci√≥n biom√©trica o el uso de un c√≥digo de acceso.

### **Advertencia sobre Dispositivos Jailbroken**

{% hint style="warning" %}
En **dispositivos jailbroken**, las protecciones del llavero est√°n comprometidas, lo que representa un riesgo de seguridad significativo.
{% endhint %}

### **Persistencia de los Datos del Llavero**

A diferencia de los datos espec√≠ficos de la aplicaci√≥n que se eliminan al desinstalar la aplicaci√≥n, **los datos del llavero persisten** en el dispositivo. Esta caracter√≠stica podr√≠a permitir a los nuevos propietarios de un dispositivo de segunda mano acceder a los datos de la aplicaci√≥n del propietario anterior simplemente reinstalando las aplicaciones. Se aconseja a los desarrolladores que eliminen proactivamente los datos del llavero al instalar la aplicaci√≥n o durante el cierre de sesi√≥n para mitigar este riesgo. Aqu√≠ hay un ejemplo de c√≥digo Swift que demuestra c√≥mo limpiar los datos del llavero al primer lanzamiento de la aplicaci√≥n:
```swift
let userDefaults = UserDefaults.standard

if userDefaults.bool(forKey: "hasRunBefore") == false {
// Remove Keychain items here

// Update the flag indicator
userDefaults.set(true, forKey: "hasRunBefore")
userDefaults.synchronize() // Forces the app to update UserDefaults
}
```
# **Capacidades de la App**

En el √°mbito del desarrollo de aplicaciones, **sandboxing** juega un papel crucial en la mejora de la seguridad. Este proceso asegura que cada aplicaci√≥n opere dentro de su propio directorio de inicio √∫nico, evitando as√≠ que acceda a archivos del sistema o datos pertenecientes a otras aplicaciones. La aplicaci√≥n de estas restricciones se lleva a cabo a trav√©s de pol√≠ticas de sandbox, que son parte del **Trusted BSD (MAC) Mandatory Access Control Framework**.

Los desarrolladores tienen la capacidad de configurar ciertas **capacidades o permisos** para sus aplicaciones, como **Data Protection** o **Keychain Sharing**. Estos permisos se aplican inmediatamente despu√©s de que la aplicaci√≥n es instalada. No obstante, para acceder a ciertos recursos protegidos, la aplicaci√≥n debe obtener el consentimiento expl√≠cito del usuario en el momento del primer intento. Esto se logra mediante el uso de _purpose strings_ o _usage description strings_, que se presentan a los usuarios en una alerta de solicitud de permiso.

Para aquellos con acceso al c√≥digo fuente, la verificaci√≥n de permisos incluidos en el archivo `Info.plist` se puede hacer mediante:

1. Abrir el proyecto en Xcode.
2. Localizar y abrir el archivo `Info.plist`.
3. Buscar claves con el prefijo `"Privacy -"`, con la opci√≥n de ver claves/valores en bruto para mayor claridad.

Al tratar con un archivo IPA, se pueden seguir los siguientes pasos:

1. Descomprimir el IPA.
2. Localizar el archivo `Info.plist` dentro de `Payload/<appname>.app/`.
3. Convertir el archivo a formato XML si es necesario, para una inspecci√≥n m√°s f√°cil.

Por ejemplo, las purpose strings en el archivo `Info.plist` podr√≠an verse as√≠:
```xml
<plist version="1.0">
<dict>
<key>NSLocationWhenInUseUsageDescription</key>
<string>Your location is used to provide turn-by-turn directions to your destination.</string>
```
## Device Capabilities
El archivo `Info.plist` de una aplicaci√≥n especifica **capacidades del dispositivo** que ayudan a la App Store a filtrar aplicaciones para la compatibilidad del dispositivo. Estas se definen bajo la clave **`UIRequiredDeviceCapabilities`**. Por ejemplo:
```xml
<key>UIRequiredDeviceCapabilities</key>
<array>
<string>armv7</string>
</array>
```
Este ejemplo indica que la aplicaci√≥n es compatible con el conjunto de instrucciones armv7. Los desarrolladores tambi√©n pueden especificar capacidades como nfc para garantizar que su aplicaci√≥n solo est√© disponible para dispositivos que admiten NFC.

## Derechos

**Derechos** son otro aspecto cr√≠tico del desarrollo de aplicaciones iOS, sirviendo como pares clave-valor que otorgan a las aplicaciones permiso para realizar ciertas operaciones m√°s all√° de las verificaciones en tiempo de ejecuci√≥n. Por ejemplo, habilitar **Protecci√≥n de Datos** en una aplicaci√≥n implica agregar un derecho espec√≠fico en el proyecto de Xcode, que luego se refleja en el archivo de derechos de la aplicaci√≥n o en el archivo de provisi√≥n m√≥vil incrustado para IPAs.


# Referencias
* [https://mas.owasp.org/MASTG/iOS/0x06d-Testing-Data-Storage](https://mas.owasp.org/MASTG/iOS/0x06d-Testing-Data-Storage)
* [https://github.com/OWASP/owasp-mastg/blob/master/Document/0x06h-Testing-Platform-Interaction.md](https://github.com/OWASP/owasp-mastg/blob/master/Document/0x06h-Testing-Platform-Interaction.md)
* [https://mas.owasp.org/MASTG/tests/ios/MASVS-PLATFORM/MASTG-TEST-0069/](https://mas.owasp.org/MASTG/tests/ios/MASVS-PLATFORM/MASTG-TEST-0069/)
* [https://mas.owasp.org/MASTG/iOS/0x06h-Testing-Platform-Interaction/](https://mas.owasp.org/MASTG/iOS/0x06h-Testing-Platform-Interaction/)



{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
