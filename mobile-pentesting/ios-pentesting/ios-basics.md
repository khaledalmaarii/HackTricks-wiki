<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>

# Separacja uprawnie i piaskownica

W systemie iOS istnieje rozr贸偶nienie w uprawnieniach midzy aplikacjami dostpnymi dla u偶ytkownika a podstawowymi procesami systemu. Aplikacje dziaaj pod to偶samoci u偶ytkownika **`mobile`**, podczas gdy kluczowe procesy systemowe dziaaj jako **`root`**. Ta separacja jest wzmacniana przez mechanizm piaskownicy, kt贸ry narzuca cise ograniczenia na dziaania, jakie mog podj aplikacje. Na przykad, nawet jeli aplikacje maj t sam to偶samo u偶ytkownika, s zabronione przed dostpem lub modyfikacj danych innych aplikacji.

Aplikacje s instalowane w okrelonym katalogu (`private/var/mobile/Applications/{losowy ID}`) i maj ograniczony dostp do odczytu do okrelonych obszar贸w i funkcji systemowych, takich jak SMS-y i poczenia telefoniczne. Dostp do chronionych obszar贸w powoduje wywietlenie proby o zgod u偶ytkownika.

# Ochrona danych

iOS oferuje programistom interfejsy API ochrony danych, zbudowane na procesorze Secure Enclave (SEP) - dedykowanym koprocesorze do operacji kryptograficznych i zarzdzania kluczami. SEP zapewnia integralno ochrony danych za pomoc unikalnego klucza specyficznego dla urzdzenia, UID urzdzenia, wbudowanego w niego.

Podczas tworzenia pliku generowany jest unikalny klucz szyfrowania AES o dugoci 256 bit贸w, kt贸ry szyfruje zawarto pliku. Ten klucz szyfrowania, wraz z identyfikatorem klasy, jest nastpnie szyfrowany za pomoc klucza klasy i przechowywany w metadanych pliku. Deszyfrowanie pliku polega na u偶yciu klucza systemowego do uzyskania dostpu do metadanych, pobraniu klucza klasy z identyfikatorem klasy, a nastpnie deszyfrowaniu unikalnego klucza szyfrowania pliku.

iOS definiuje **cztery klasy ochrony** dla bezpieczestwa danych, kt贸re okrelaj, kiedy i w jaki spos贸b mo偶na uzyska dostp do danych:

- **Pena ochrona (NSFileProtectionComplete)**: Dane s niedostpne do momentu odblokowania urzdzenia za pomoc kodu dostpu u偶ytkownika.
- **Chronione, chyba 偶e otwarte (NSFileProtectionCompleteUnlessOpen)**: Umo偶liwia dostp do pliku nawet po zablokowaniu urzdzenia, pod warunkiem, 偶e plik zosta otwarty, gdy urzdzenie byo odblokowane.
- **Chronione do pierwszej autoryzacji u偶ytkownika (NSFileProtectionCompleteUntilFirstUserAuthentication)**: Dane s dostpne po pierwszym odblokowaniu przez u偶ytkownika po uruchomieniu, pozostajc dostpnymi nawet po ponownym zablokowaniu urzdzenia.
- **Brak ochrony (NSFileProtectionNone)**: Dane s chronione tylko przez UID urzdzenia, uatwiajc szybkie zdalne usuwanie danych.

Szyfrowanie wszystkich klas, z wyjtkiem `NSFileProtectionNone`, obejmuje klucz pochodzcy zar贸wno z UID urzdzenia, jak i z kodu dostpu u偶ytkownika, zapewniajc, 偶e deszyfrowanie jest mo偶liwe tylko na urzdzeniu z prawidowym kodem dostpu. Od wersji iOS 7 domyln klas ochrony jest "Chronione do pierwszej autoryzacji u偶ytkownika".

Programici mog u偶ywa [**FileDP**](https://github.com/abjurato/FileDp-Source), narzdzia do sprawdzania klasy ochrony danych plik贸w na iPhone'ie.
```python
# Example code to use FileDP for checking file protection class
# Note: Ensure your device is jailbroken and has Python installed to use FileDP.
# Installation and usage of FileDP:
git clone https://github.com/abjurato/FileDp-Source
cd FileDp-Source
python filedp.py /path/to/check
```
## **Keychain**

W systemie iOS **Keychain** su偶y jako bezpieczny **zaszyfrowany kontener** do przechowywania **wra偶liwych informacji**, dostpny tylko dla aplikacji, kt贸ra je przechowuje lub dla tych, kt贸re s wyra藕nie autoryzowane. Szyfrowanie to jest wzmacniane przez unikalne **haso generowane przez iOS**, kt贸re samo w sobie jest zaszyfrowane za pomoc **AES**. Proces szyfrowania wykorzystuje funkcj **PBKDF2**, czc kod dostpu u偶ytkownika z sol pochodzc z **UID** urzdzenia, do kt贸rego dostp ma tylko **bezpieczny chipset enklawy**. W rezultacie, nawet jeli kod dostpu u偶ytkownika jest znany, zawarto Keychain pozostaje niedostpna na jakimkolwiek innym urzdzeniu ni偶 to, na kt贸rym zostaa pierwotnie zaszyfrowana.

**Zarzdzanie i dostp** do danych Keychain s obsugiwane przez demon **`securityd`**, na podstawie okrelonych uprawnie aplikacji, takich jak `Keychain-access-groups` i `application-identifier`.

### **Operacje API Keychain**

API Keychain, szczeg贸owo opisane w [dokumentacji Apple dotyczcej usug Keychain](https://developer.apple.com/library/content/documentation/Security/Conceptual/keychainServConcepts/02concepts/concepts.html), zapewniaj podstawowe funkcje zarzdzania bezpiecznym przechowywaniem:

- **`SecItemAdd`**: Dodaje nowy element do Keychain.
- **`SecItemUpdate`**: Aktualizuje istniejcy element w Keychain.
- **`SecItemCopyMatching`**: Pobiera element z Keychain.
- **`SecItemDelete`**: Usuwa element z Keychain.

Atakowanie hasa Keychain polega na atakowaniu bezporednio zaszyfrowanego klucza lub pr贸bie odgadnicia kodu dostpu na samym urzdzeniu, co jest znacznie utrudnione przez wymuszenie przez bezpieczn enklaw op贸藕nienia midzy nieudanymi pr贸bami.

### **Konfigurowanie ochrony danych element贸w Keychain**

Poziomy ochrony danych dla element贸w Keychain s ustawiane za pomoc atrybutu `kSecAttrAccessible` podczas tworzenia lub aktualizacji elementu. Te poziomy, [zgodnie z wytycznymi Apple](https://developer.apple.com/documentation/security/keychain_services/keychain_items/item_attribute_keys_and_values#1679100), okrelaj, kiedy i w jaki spos贸b elementy Keychain s dostpne:

- **`kSecAttrAccessibleAlways`**: Dostpne zawsze, niezale偶nie od stanu blokady urzdzenia.
- **`kSecAttrAccessibleAlwaysThisDeviceOnly`**: Zawsze dostpne, ale nie uwzgldniane w kopii zapasowej.
- **`kSecAttrAccessibleAfterFirstUnlock`**: Dostpne po pierwszym odblokowaniu po restarcie.
- **`kSecAttrAccessibleAfterFirstUnlockThisDeviceOnly`**: To samo co powy偶ej, ale nieprzenone na nowe urzdzenia.
- **`kSecAttrAccessibleWhenUnlocked`**: Dostpne tylko po odblokowaniu urzdzenia.
- **`kSecAttrAccessibleWhenUnlockedThisDeviceOnly`**: Dostpne po odblokowaniu, nie uwzgldniane w kopii zapasowej.
- **`kSecAttrAccessibleWhenPasscodeSetThisDeviceOnly`**: Wymaga kodu dostpu do urzdzenia, nie uwzgldniane w kopii zapasowej.

**`AccessControlFlags`** dodatkowo precyzuj metody dostpu, umo偶liwiajc uwierzytelnianie biometryczne lub u偶ycie kodu dostpu.

### **Ostrze偶enie dotyczce urzdze z jailbreakiem**

{% hint style="warning" %}
Na **urzdzeniach z jailbreakiem**, ochrona Keychain jest naruszona, co stanowi znaczne ryzyko dla bezpieczestwa.
{% endhint %}

### **Trwao danych Keychain**

W przeciwiestwie do danych specyficznych dla aplikacji, kt贸re s usuwane po odinstalowaniu aplikacji, dane Keychain pozostaj na urzdzeniu. Ta cecha mo偶e umo偶liwi nowym wacicielom u偶ywanego urzdzenia dostp do danych aplikacji poprzedniego waciciela, po prostu ponownie instalujc aplikacje. Zaleca si, aby programici aktywnie usuwali dane Keychain podczas instalacji aplikacji lub podczas wylogowywania si, aby zminimalizowa to ryzyko. Oto przykad kodu Swift, kt贸ry pokazuje, jak usun dane Keychain podczas pierwszego uruchomienia aplikacji:
```swift
let userDefaults = UserDefaults.standard

if userDefaults.bool(forKey: "hasRunBefore") == false {
// Remove Keychain items here

// Update the flag indicator
userDefaults.set(true, forKey: "hasRunBefore")
userDefaults.synchronize() // Forces the app to update UserDefaults
}
```
# **Zdolnoci aplikacji**

W dziedzinie tworzenia aplikacji, **sandboxing** odgrywa kluczow rol w poprawie bezpieczestwa. Ten proces zapewnia, 偶e ka偶da aplikacja dziaa w swoim unikalnym katalogu domowym, co uniemo偶liwia jej dostp do plik贸w systemowych lub danych nale偶cych do innych aplikacji. Egzekucja tych ogranicze odbywa si poprzez polityki sandboxu, kt贸re s czci **Trusted BSD (MAC) Mandatory Access Control Framework**.

Deweloperzy maj mo偶liwo konfigurowania okrelonych **zdolnoci lub uprawnie** dla swoich aplikacji, takich jak **Ochrona danych** lub **Wsp贸dzielenie kluczy Keychain**. Te uprawnienia s stosowane natychmiast po zainstalowaniu aplikacji. Niemniej jednak, aby uzyska dostp do okrelonych chronionych zasob贸w, aplikacja musi uzyska wyra藕n zgod u偶ytkownika podczas pierwszej pr贸by. Jest to osigane poprzez u偶ycie _cig贸w celu_ lub _opis贸w u偶ycia_, kt贸re s prezentowane u偶ytkownikom w probie o zgod.

Dla os贸b majcych dostp do kodu 藕r贸dowego, weryfikacja uprawnie zawartych w pliku `Info.plist` mo偶e by wykonana poprzez:

1. Otwarcie projektu w Xcode.
2. Zlokalizowanie i otwarcie pliku `Info.plist`.
3. Wyszukiwanie kluczy z prefiksem `"Privacy -"`, z opcj wywietlania surowych kluczy/wartoci dla wikszej czytelnoci.

Przy pracy z plikiem IPA mo偶na postpowa wedug nastpujcych krok贸w:

1. Rozpakowanie pliku IPA.
2. Zlokalizowanie pliku `Info.plist` w folderze `Payload/<nazwa_aplikacji>.app/`.
3. Konwersja pliku do formatu XML, jeli jest to konieczne, dla atwiejszej inspekcji.

Na przykad, cigi celu w pliku `Info.plist` mog wyglda tak:
```xml
<plist version="1.0">
<dict>
<key>NSLocationWhenInUseUsageDescription</key>
<string>Your location is used to provide turn-by-turn directions to your destination.</string>
```
## Mo偶liwoci urzdzenia
Plik `Info.plist` aplikacji okrela **mo偶liwoci urzdzenia**, kt贸re pomagaj Sklepowi App w filtrowaniu aplikacji pod ktem kompatybilnoci urzdzenia. S one zdefiniowane w kluczu **`UIRequiredDeviceCapabilities`**. Na przykad:
```xml
<key>UIRequiredDeviceCapabilities</key>
<array>
<string>armv7</string>
</array>
```
Ten przykad wskazuje, 偶e aplikacja jest kompatybilna z zestawem instrukcji armv7. Deweloperzy mog r贸wnie偶 okreli mo偶liwoci, takie jak nfc, aby upewni si, 偶e ich aplikacja jest dostpna tylko na urzdzeniach obsugujcych NFC.

## Uprawnienia

**Uprawnienia** s kolejnym istotnym aspektem tworzenia aplikacji iOS i su偶 jako pary klucz-warto, kt贸re nadaj aplikacjom uprawnienia do wykonywania okrelonych operacji poza sprawdzaniem czasu wykonania. Na przykad, wczenie **Ochrony danych** w aplikacji polega na dodaniu okrelonego uprawnienia w projekcie Xcode, kt贸re jest nastpnie odzwierciedlane w pliku uprawnie aplikacji lub osadzonym pliku zabezpiecze mobilnych dla plik贸w IPA.


# Odwoania
* [https://mas.owasp.org/MASTG/iOS/0x06d-Testing-Data-Storage](https://mas.owasp.org/MASTG/iOS/0x06d-Testing-Data-Storage)
* [https://github.com/OWASP/owasp-mastg/blob/master/Document/0x06h-Testing-Platform-Interaction.md](https://github.com/OWASP/owasp-mastg/blob/master/Document/0x06h-Testing-Platform-Interaction.md)
* [https://mas.owasp.org/MASTG/tests/ios/MASVS-PLATFORM/MASTG-TEST-0069/](https://mas.owasp.org/MASTG/tests/ios/MASVS-PLATFORM/MASTG-TEST-0069/)
* [https://mas.owasp.org/MASTG/iOS/0x06h-Testing-Platform-Interaction/](https://mas.owasp.org/MASTG/iOS/0x06h-Testing-Platform-Interaction/)



<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
