{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

# Razdvajanje privilegija i Sandbox

U iOS-u, postoji razlika u privilegijama izmeÄ‘u aplikacija dostupnih korisnicima i osnovnih procesa sistema. Aplikacije se pokreÄ‡u pod identitetom korisnika **`mobile`**, dok kljuÄni sistemski procesi rade kao **`root`**. Ovo razdvajanje se dodatno pojaÄava mehanizmom sandbox-a, koji nameÄ‡e stroga ograniÄenja na to koje akcije aplikacije mogu preduzeti. Na primer, Äak i ako aplikacije dele isti identitet korisnika, zabranjeno im je pristupanje ili modifikovanje podataka jednih drugih.

Aplikacije se instaliraju u specifiÄnu direktoriju (`private/var/mobile/Applications/{random ID}`) i imaju ograniÄen pristup Äitanju odreÄ‘enih sistemskih oblasti i funkcionalnosti, kao Å¡to su SMS i telefonski pozivi. Pristup zaÅ¡tiÄ‡enim oblastima pokreÄ‡e iskaÄuÄ‡i zahtev za korisniÄku dozvolu.

# ZaÅ¡tita podataka

iOS nudi programerima **API-je za zaÅ¡titu podataka**, koji su izgraÄ‘eni na Secure Enclave Processor (SEP) â€” posveÄ‡enom koprocesoru za kriptografske operacije i upravljanje kljuÄevima. SEP osigurava integritet zaÅ¡tite podataka putem jedinstvenog kljuÄa specifiÄnog za ureÄ‘aj, UID ureÄ‘aja, ugraÄ‘enog u njega.

Pri kreiranju datoteke generiÅ¡e se jedinstveni 256-bitni AES enkripcioni kljuÄ, koji enkriptuje sadrÅ¾aj datoteke. Ovaj enkripcioni kljuÄ, zajedno sa ID-jem klase, zatim se enkriptuje koristeÄ‡i kljuÄ klase i Äuva unutar metapodataka datoteke. DeÅ¡ifrovanje datoteke ukljuÄuje koriÅ¡Ä‡enje sistemskog kljuÄa za pristup metapodacima, preuzimanje kljuÄa klase sa ID-jem klase, a zatim deÅ¡ifrovanje jedinstvenog enkripcionog kljuÄa datoteke.

iOS definiÅ¡e **Äetiri klase zaÅ¡tite** za bezbednost podataka, koje odreÄ‘uju kada i kako se podaci mogu pristupiti:

- **Potpuna zaÅ¡tita (NSFileProtectionComplete)**: Podaci su nedostupni dok se ureÄ‘aj ne otkljuÄa koriÅ¡Ä‡enjem korisniÄkog lozinke.
- **ZaÅ¡tiÄ‡eno osim ako je otvoreno (NSFileProtectionCompleteUnlessOpen)**: OmoguÄ‡ava pristup datoteci Äak i nakon Å¡to je ureÄ‘aj zakljuÄan, pod uslovom da je datoteka otvorena kada je ureÄ‘aj otkljuÄan.
- **ZaÅ¡tiÄ‡eno do prve korisniÄke autentifikacije (NSFileProtectionCompleteUntilFirstUserAuthentication)**: Podaci su dostupni nakon prve korisniÄke otkljuÄavanja posle pokretanja, ostajuÄ‡i dostupni Äak i ako se ureÄ‘aj ponovo zakljuÄa.
- **Bez zaÅ¡tite (NSFileProtectionNone)**: Podaci su zaÅ¡tiÄ‡eni samo UID-om ureÄ‘aja, olakÅ¡avajuÄ‡i brzo daljinsko brisanje podataka.

Enkripcija svih klasa, osim za `NSFileProtectionNone`, ukljuÄuje kljuÄ izveden iz UID-a ureÄ‘aja i korisniÄke lozinke, osiguravajuÄ‡i da je deÅ¡ifrovanje moguÄ‡e samo na ureÄ‘aju sa ispravnom lozinkom. Od iOS 7 nadalje, podrazumevana klasa zaÅ¡tite je "ZaÅ¡tiÄ‡eno do prve korisniÄke autentifikacije".

Programeri mogu koristiti [**FileDP**](https://github.com/abjurato/FileDp-Source), alat za inspekciju klase zaÅ¡tite podataka datoteka na iPhone-u.
```python
# Example code to use FileDP for checking file protection class
# Note: Ensure your device is jailbroken and has Python installed to use FileDP.
# Installation and usage of FileDP:
git clone https://github.com/abjurato/FileDp-Source
cd FileDp-Source
python filedp.py /path/to/check
```
## **Keychain**

U iOS-u, **Keychain** sluÅ¾i kao siguran **kriptovani kontejner** za Äuvanje **osetljivih informacija**, koji je dostupan samo aplikaciji koja ga je saÄuvala ili onima koji su izriÄito autorizovani. Ova enkripcija je ojaÄana jedinstvenom **lozinkom koju generiÅ¡e iOS**, koja je sama po sebi kriptovana sa **AES**. Ovaj proces enkripcije koristi **PBKDF2 funkciju**, kombinujuÄ‡i korisniÄki kod sa solju dobijenom iz **UID** ureÄ‘aja, komponentom kojoj moÅ¾e pristupiti samo **secure enclave chipset**. Kao rezultat, Äak i ako je korisniÄki kod poznat, sadrÅ¾aj Keychain-a ostaje nedostupan na bilo kom ureÄ‘aju osim onog na kojem je prvobitno kriptovan.

**Upravljanje i pristup** podacima Keychain-a obavlja **`securityd` daemon**, na osnovu specifiÄnih prava aplikacije kao Å¡to su `Keychain-access-groups` i `application-identifier`.

### **Operacije Keychain API-a**

Keychain API, detaljno opisan u [Apple-ovoj dokumentaciji o Keychain Services](https://developer.apple.com/library/content/documentation/Security/Conceptual/keychainServConcepts/02concepts/concepts.html), pruÅ¾a osnovne funkcije za upravljanje sigurnim skladiÅ¡tem:

- **`SecItemAdd`**: Dodaje novu stavku u Keychain.
- **`SecItemUpdate`**: AÅ¾urira postojeÄ‡u stavku u Keychain.
- **`SecItemCopyMatching`**: Preuzima stavku iz Keychain.
- **`SecItemDelete`**: Uklanja stavku iz Keychain.

Brute-forcing lozinke Keychain-a ukljuÄuje ili napad na kriptovani kljuÄ direktno ili pokuÅ¡aj pogaÄ‘anja lozinke na samom ureÄ‘aju, Å¡to je znaÄajno oteÅ¾ano primenom sigurnog enclave-a koji nameÄ‡e kaÅ¡njenje izmeÄ‘u neuspeÅ¡nih pokuÅ¡aja.

### **Konfigurisanje zaÅ¡tite podataka stavki Keychain-a**

Nivoi zaÅ¡tite podataka za stavke Keychain-a postavljaju se koriÅ¡Ä‡enjem atributa `kSecAttrAccessible` tokom kreiranja ili aÅ¾uriranja stavke. Ovi nivoi, [kako je navedeno od strane Apple-a](https://developer.apple.com/documentation/security/keychain_services/keychain_items/item_attribute_keys_and_values#1679100), odreÄ‘uju kada i kako su stavke Keychain-a dostupne:

- **`kSecAttrAccessibleAlways`**: Dostupno u bilo kojem trenutku, bez obzira na status zakljuÄavanja ureÄ‘aja.
- **`kSecAttrAccessibleAlwaysThisDeviceOnly`**: Uvek dostupno, ali nije ukljuÄeno u rezervne kopije.
- **`kSecAttrAccessibleAfterFirstUnlock`**: Dostupno nakon prvog otkljuÄavanja posle ponovnog pokretanja.
- **`kSecAttrAccessibleAfterFirstUnlockThisDeviceOnly`**: Isto kao i gore, ali nije prenosivo na nove ureÄ‘aje.
- **`kSecAttrAccessibleWhenUnlocked`**: Dostupno samo kada je ureÄ‘aj otkljuÄan.
- **`kSecAttrAccessibleWhenUnlockedThisDeviceOnly`**: Dostupno kada je otkljuÄano, nije ukljuÄeno u rezervne kopije.
- **`kSecAttrAccessibleWhenPasscodeSetThisDeviceOnly`**: Zahteva lozinku ureÄ‘aja, nije ukljuÄeno u rezervne kopije.

**`AccessControlFlags`** dodatno preciziraju metode pristupa, omoguÄ‡avajuÄ‡i biometrijsku autentifikaciju ili koriÅ¡Ä‡enje lozinke.

### **Upozorenje o Jailbroken ureÄ‘ajima**

{% hint style="warning" %}
Na **jailbroken ureÄ‘ajima**, zaÅ¡tite Keychain-a su kompromitovane, Å¡to predstavlja znaÄajan bezbednosni rizik.
{% endhint %}

### **Trajnost podataka Keychain-a**

Za razliku od podataka specifiÄnih za aplikaciju koji se briÅ¡u prilikom deinstalacije aplikacije, **podaci Keychain-a ostaju** na ureÄ‘aju. Ova karakteristika moÅ¾e omoguÄ‡iti novim vlasnicima polovnog ureÄ‘aja da pristupe podacima prethodnog vlasnika aplikacije jednostavno ponovnim instaliranjem aplikacija. Programerima se savetuje da proaktivno obriÅ¡u podatke Keychain-a prilikom instalacije aplikacije ili tokom odjave kako bi umanjili ovaj rizik. Evo primera Swift koda koji demonstrira kako da obriÅ¡ete podatke Keychain-a prilikom prvog pokretanja aplikacije:
```swift
let userDefaults = UserDefaults.standard

if userDefaults.bool(forKey: "hasRunBefore") == false {
// Remove Keychain items here

// Update the flag indicator
userDefaults.set(true, forKey: "hasRunBefore")
userDefaults.synchronize() // Forces the app to update UserDefaults
}
```
# **App Capabilities**

U oblasti razvoja aplikacija, **sandboxing** igra kljuÄnu ulogu u poboljÅ¡anju bezbednosti. Ovaj proces osigurava da svaka aplikacija funkcioniÅ¡e unutar svog jedinstvenog domaÄ‡eg direktorijuma, Äime se spreÄava pristup sistemskim datotekama ili podacima koji pripadaju drugim aplikacijama. SprovoÄ‘enje ovih ograniÄenja vrÅ¡i se kroz sandbox politike, koje su deo **Trusted BSD (MAC) Mandatory Access Control Framework**.

Programeri imaju moguÄ‡nost da konfiguriÅ¡u odreÄ‘ene **kapacitete ili dozvole** za svoje aplikacije, kao Å¡to su **Data Protection** ili **Keychain Sharing**. Ove dozvole se primenjuju odmah nakon instalacije aplikacije. Ipak, za pristup odreÄ‘enim zaÅ¡tiÄ‡enim resursima, aplikacija mora dobiti izriÄitu saglasnost od korisnika prilikom prvog pokuÅ¡aja. To se postiÅ¾e koriÅ¡Ä‡enjem _purpose strings_ ili _usage description strings_, koje se prikazuju korisnicima u alertu za zahtev za dozvolu.

Za one koji imaju pristup izvor kodu, verifikacija dozvola ukljuÄenih u `Info.plist` datoteku moÅ¾e se izvrÅ¡iti na sledeÄ‡i naÄin:

1. Otvorite projekat u Xcode-u.
2. PronaÄ‘ite i otvorite `Info.plist` datoteku.
3. PretraÅ¾ujte kljuÄeve koji poÄinju sa `"Privacy -"`, uz moguÄ‡nost pregleda sirovih kljuÄeva/vrednosti radi jasnoÄ‡e.

Kada se radi sa IPA datotekom, sledeÄ‡i koraci se mogu pratiti:

1. Raspakujte IPA.
2. PronaÄ‘ite `Info.plist` datoteku unutar `Payload/<appname>.app/`.
3. Konvertujte datoteku u XML format ako je potrebno, radi lakÅ¡eg pregleda.

Na primer, purpose strings u `Info.plist` datoteci mogu izgledati ovako:
```xml
<plist version="1.0">
<dict>
<key>NSLocationWhenInUseUsageDescription</key>
<string>Your location is used to provide turn-by-turn directions to your destination.</string>
```
## Device Capabilities
Datoteka `Info.plist` aplikacije specificira **moguÄ‡nosti ureÄ‘aja** koje pomaÅ¾u App Store-u da filtrira aplikacije prema kompatibilnosti sa ureÄ‘ajem. Ove su definisane pod kljuÄem **`UIRequiredDeviceCapabilities`**. Na primer:
```xml
<key>UIRequiredDeviceCapabilities</key>
<array>
<string>armv7</string>
</array>
```
Ovaj primer ukazuje da je aplikacija kompatibilna sa armv7 skupom instrukcija. Programeri takoÄ‘e mogu da specificiraju moguÄ‡nosti kao Å¡to je nfc kako bi osigurali da je njihova aplikacija dostupna samo ureÄ‘ajima koji podrÅ¾avaju NFC.

## OvlaÅ¡Ä‡enja

**OvlaÅ¡Ä‡enja** su joÅ¡ jedan kritiÄan aspekt razvoja iOS aplikacija, sluÅ¾eÄ‡i kao parovi kljuÄ-vrednost koji dodeljuju aplikacijama dozvolu da izvrÅ¡avaju odreÄ‘ene operacije van provere u vreme izvoÄ‘enja. Na primer, omoguÄ‡avanje **ZaÅ¡tite podataka** u aplikaciji podrazumeva dodavanje specifiÄnog ovlaÅ¡Ä‡enja u Xcode projektu, Å¡to se zatim odraÅ¾ava u datoteci ovlaÅ¡Ä‡enja aplikacije ili u ugraÄ‘enoj mobilnoj proviziji za IPA.

# Reference
* [https://mas.owasp.org/MASTG/iOS/0x06d-Testing-Data-Storage](https://mas.owasp.org/MASTG/iOS/0x06d-Testing-Data-Storage)
* [https://github.com/OWASP/owasp-mastg/blob/master/Document/0x06h-Testing-Platform-Interaction.md](https://github.com/OWASP/owasp-mastg/blob/master/Document/0x06h-Testing-Platform-Interaction.md)
* [https://mas.owasp.org/MASTG/tests/ios/MASVS-PLATFORM/MASTG-TEST-0069/](https://mas.owasp.org/MASTG/tests/ios/MASVS-PLATFORM/MASTG-TEST-0069/)
* [https://mas.owasp.org/MASTG/iOS/0x06h-Testing-Platform-Interaction/](https://mas.owasp.org/MASTG/iOS/0x06h-Testing-Platform-Interaction/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
