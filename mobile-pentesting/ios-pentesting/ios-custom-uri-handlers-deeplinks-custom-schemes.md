<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- Travaillez-vous dans une entreprise de **cybersÃ©curitÃ©** ? Voulez-vous voir votre **entreprise annoncÃ©e dans HackTricks** ? ou voulez-vous avoir accÃ¨s Ã  la **derniÃ¨re version de PEASS ou tÃ©lÃ©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !

- DÃ©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)

- **Rejoignez le** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Partagez vos astuces de piratage en soumettant des PR au [repo hacktricks](https://github.com/carlospolop/hacktricks) et au [repo hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>


Les schÃ©mas d'URL personnalisÃ©s [permettent aux applications de communiquer via un protocole personnalisÃ©](https://developer.apple.com/library/content/documentation/iPhone/Conceptual/iPhoneOSProgrammingGuide/Inter-AppCommunication/Inter-AppCommunication.html#//apple\_ref/doc/uid/TP40007072-CH6-SW1). Une application doit dÃ©clarer la prise en charge des schÃ©mas et gÃ©rer les URL entrantes qui utilisent ces schÃ©mas.

> Les schÃ©mas d'URL offrent un vecteur d'attaque potentiel dans votre application, alors assurez-vous de **valider tous les paramÃ¨tres d'URL** et de **rejeter tout URL malformÃ©**. De plus, limitez les **actions** disponibles Ã  celles qui ne risquent pas les donnÃ©es de l'utilisateur.

Par exemple, l'URI : `myapp://hostname?data=123876123` **dÃ©clenchera** l'**application** mydata (celle qui a **enregistrÃ©** le schÃ©ma `mydata`) pour l'**action** liÃ©e Ã  l'**hostname** `hostname` en envoyant le **paramÃ¨tre** `data` avec la valeur `123876123`.

Un exemple vulnÃ©rable est le [bug dans l'application mobile Skype](http://www.dhanjani.com/blog/2010/11/insecure-handling-of-url-schemes-in-apples-ios.html), dÃ©couvert en 2010 : l'application Skype a enregistrÃ© le gestionnaire de protocole `skype://`, ce qui a **permis Ã  d'autres applications de dÃ©clencher des appels vers d'autres utilisateurs Skype et des numÃ©ros de tÃ©lÃ©phone**. Malheureusement, Skype n'a pas demandÃ© la permission des utilisateurs avant de passer les appels, de sorte que n'importe quelle application pouvait appeler des numÃ©ros arbitraires sans la connaissance de l'utilisateur. Les attaquants ont exploitÃ© cette vulnÃ©rabilitÃ© en mettant en place un `<iframe src="skype://xxx?call"></iframe>` invisible (oÃ¹ `xxx` Ã©tait remplacÃ© par un numÃ©ro premium), de sorte que tout utilisateur Skype qui a visitÃ© involontairement un site Web malveillant a appelÃ© le numÃ©ro premium.

Vous pouvez trouver les **schÃ©mas enregistrÃ©s par une application** dans le fichier **`Info.plist`** de l'application en recherchant **`CFBundleURLTypes`** (exemple de [iGoat-Swift](https://github.com/OWASP/iGoat-Swift)) :
```markup
<key>CFBundleURLTypes</key>
<array>
    <dict>
        <key>CFBundleURLName</key>
        <string>com.iGoat.myCompany</string>
        <key>CFBundleURLSchemes</key>
        <array>
            <string>iGoat</string>
        </array>
    </dict>
</array>
```
Cependant, notez que les applications malveillantes peuvent rÃ©enregistrer des URI dÃ©jÃ  enregistrÃ©es par d'autres applications. Ainsi, si vous envoyez des informations sensibles via des URI (myapp://hostname?password=123456), une application malveillante peut intercepter l'URI avec les informations sensibles.

De plus, l'entrÃ©e de ces URI doit Ãªtre vÃ©rifiÃ©e et nettoyÃ©e, car elle peut provenir d'origines malveillantes cherchant Ã  exploiter des failles telles que les injections SQL, XSS, CSRF, les traversÃ©es de chemin ou d'autres vulnÃ©rabilitÃ©s possibles.

## Enregistrement des schÃ©mas de requÃªte d'application

Les applications peuvent appeler [`canOpenURL:`](https://developer.apple.com/documentation/uikit/uiapplication/1622952-canopenurl?language=objc) pour vÃ©rifier que l'application cible est disponible. Cependant, comme cette mÃ©thode Ã©tait utilisÃ©e par des applications malveillantes pour Ã©numÃ©rer les applications installÃ©es, [Ã  partir d'iOS 9.0, les schÃ©mas d'URL passÃ©s doivent Ã©galement Ãªtre dÃ©clarÃ©s](https://developer.apple.com/documentation/uikit/uiapplication/1622952-canopenurl?language=objc#discussion) en ajoutant la clÃ© `LSApplicationQueriesSchemes` au fichier `Info.plist` de l'application et un tableau d'**au plus 50 schÃ©mas d'URL**.
```markup
<key>LSApplicationQueriesSchemes</key>
    <array>
        <string>url_scheme1</string>
        <string>url_scheme2</string>
    </array>
```
`canOpenURL` renverra toujours `NO` pour les schÃ©mas non dÃ©clarÃ©s, que l'application appropriÃ©e soit installÃ©e ou non. Cependant, cette restriction ne s'applique qu'Ã  `canOpenURL`.

## Test de la gestion et de la validation des URL

Afin de dÃ©terminer comment un chemin d'URL est construit et validÃ©, si vous avez le code source original, vous pouvez **rechercher les mÃ©thodes suivantes** :

* MÃ©thode `application:didFinishLaunchingWithOptions:` ou `application:will-FinishLaunchingWithOptions:` : vÃ©rifiez comment la dÃ©cision est prise et comment les informations sur l'URL sont rÃ©cupÃ©rÃ©es.
* [`application:openURL:options:`](https://developer.apple.com/documentation/uikit/uiapplicationdelegate/1623112-application?language=objc) : vÃ©rifiez comment la ressource est ouverte, c'est-Ã -dire comment les donnÃ©es sont analysÃ©es, vÃ©rifiez les [options](https://developer.apple.com/documentation/uikit/uiapplication/openurloptionskey), en particulier si l'accÃ¨s par l'application appelante ([`sourceApplication`](https://developer.apple.com/documentation/uikit/uiapplication/openurloptionskey/1623128-sourceapplication)) doit Ãªtre autorisÃ© ou refusÃ©. L'application peut Ã©galement avoir besoin de l'autorisation de l'utilisateur lors de l'utilisation du schÃ©ma d'URL personnalisÃ©.

Dans Telegram, vous trouverez [quatre mÃ©thodes diffÃ©rentes utilisÃ©es](https://github.com/peter-iakovlev/Telegram-iOS/blob/87e0a33ac438c1d702f2a0b75bf21f26866e346f/Telegram-iOS/AppDelegate.swift#L1250) :
```swift
func application(_ application: UIApplication, open url: URL, sourceApplication: String?) -> Bool {
    self.openUrl(url: url)
    return true
}

func application(_ application: UIApplication, open url: URL, sourceApplication: String?,
annotation: Any) -> Bool {
    self.openUrl(url: url)
    return true
}

func application(_ app: UIApplication, open url: URL,
options: [UIApplicationOpenURLOptionsKey : Any] = [:]) -> Bool {
    self.openUrl(url: url)
    return true
}

func application(_ application: UIApplication, handleOpen url: URL) -> Bool {
    self.openUrl(url: url)
    return true
}
```
## Tester les requÃªtes d'URL vers d'autres applications

La mÃ©thode [`openURL:options:completionHandler:`](https://developer.apple.com/documentation/uikit/uiapplication/1648685-openurl?language=objc) et la mÃ©thode [`openURL:`](https://developer.apple.com/documentation/uikit/uiapplication/1622961-openurl?language=objc) de `UIApplication` (dÃ©prÃ©ciÃ©e) sont responsables de l'**ouverture d'URLs** (c'est-Ã -dire pour envoyer des requÃªtes / faire des requÃªtes Ã  d'autres applications) qui peuvent Ãªtre locales Ã  l'application actuelle ou qui doivent Ãªtre fournies par une autre application. Si vous avez le code source original, vous pouvez rechercher directement les utilisations de ces mÃ©thodes.

De plus, si vous Ãªtes intÃ©ressÃ© Ã  savoir si l'application interroge des services ou des applications spÃ©cifiques, et si l'application est bien connue, vous pouvez Ã©galement rechercher des schÃ©mas d'URL courants en ligne et les inclure dans vos **greps (liste des schÃ©mas d'applications iOS)**.
```bash
egrep -nr "open.*options.*completionHandler" ./Telegram-iOS/
egrep -nr "openURL\(" ./Telegram-iOS/
egrep -nr "mt-encrypted-file://" ./Telegram-iOS/
egrep -nr "://" ./Telegram-iOS/
```
## Test de mÃ©thodes obsolÃ¨tes

Recherchez des mÃ©thodes obsolÃ¨tes telles que :

* [`application:handleOpenURL:`](https://developer.apple.com/documentation/uikit/uiapplicationdelegate/1622964-application?language=objc)
* [`openURL:`](https://developer.apple.com/documentation/uikit/uiapplication/1622961-openurl?language=objc)
* [`application:openURL:sourceApplication:annotation:`](https://developer.apple.com/documentation/uikit/uiapplicationdelegate/1623073-application)

Par exemple, nous trouvons ces trois mÃ©thodes :
```bash
$ rabin2 -zzq Telegram\ X.app/Telegram\ X | grep -i "openurl"

0x1000d9e90 31 30 UIApplicationOpenURLOptionsKey
0x1000dee3f 50 49 application:openURL:sourceApplication:annotation:
0x1000dee71 29 28 application:openURL:options:
0x1000dee8e 27 26 application:handleOpenURL:
0x1000df2c9 9 8 openURL:
0x1000df766 12 11 canOpenURL:
0x1000df772 35 34 openURL:options:completionHandler:
...
```
## Appel d'URL arbitraires

* **Safari**: Pour tester rapidement un schÃ©ma d'URL, vous pouvez ouvrir les URL sur Safari et observer le comportement de l'application. Par exemple, si vous Ã©crivez `tel://123456789`, Safari essaiera de commencer l'appel du numÃ©ro.
* **Notes App**: Appuyez longuement sur les liens que vous avez Ã©crits pour tester les schÃ©mas d'URL personnalisÃ©s. N'oubliez pas de quitter le mode d'Ã©dition pour pouvoir les ouvrir. Notez que vous pouvez cliquer ou appuyer longuement sur des liens incluant des schÃ©mas d'URL personnalisÃ©s uniquement si l'application est installÃ©e, sinon ils ne seront pas mis en Ã©vidence en tant que _liens cliquables_.
* [**IDB**](https://github.com/facebook/idb):
  * DÃ©marrez IDB, connectez-vous Ã  votre appareil et sÃ©lectionnez l'application cible. Vous pouvez trouver des dÃ©tails dans la [documentation IDB](https://www.idbtool.com/documentation/setup.html).
  * Allez Ã  la section **URL Handlers**. Dans les **URL schemes**, cliquez sur **Refresh**, et sur la gauche, vous trouverez une liste de tous les schÃ©mas personnalisÃ©s dÃ©finis dans l'application testÃ©e. Vous pouvez charger ces schÃ©mas en cliquant sur **Open**, sur le cÃ´tÃ© droit. En ouvrant simplement un schÃ©ma d'URI vide (par exemple, en ouvrant `myURLscheme://`), vous pouvez dÃ©couvrir des fonctionnalitÃ©s cachÃ©es (par exemple, une fenÃªtre de dÃ©bogage) et contourner l'authentification locale.
*   **Frida**:

    Si vous voulez simplement ouvrir le schÃ©ma d'URL, vous pouvez le faire en utilisant Frida :

    ```javascript
    $ frida -U iGoat-Swift

    [iPhone::iGoat-Swift]-> function openURL(url) {
                                var UIApplication = ObjC.classes.UIApplication.sharedApplication();
                                var toOpen = ObjC.classes.NSURL.URLWithString_(url);
                                return UIApplication.openURL_(toOpen);
                            }
    [iPhone::iGoat-Swift]-> openURL("tel://234234234")
    true
    ```

    Dans cet exemple de [Frida CodeShare](https://codeshare.frida.re/@dki/ios-url-scheme-fuzzing/), l'auteur utilise l'API non publique `LSApplicationWorkspace.openSensitiveURL:withOptions:` pour ouvrir les URL (Ã  partir de l'application SpringBoard) :

    ```javascript
    function openURL(url) {
        var w = ObjC.classes.LSApplicationWorkspace.defaultWorkspace();
        var toOpen = ObjC.classes.NSURL.URLWithString_(url);
        return w.openSensitiveURL_withOptions_(toOpen, null);
    }
    ```

    > Notez que l'utilisation d'API non publiques n'est pas autorisÃ©e sur l'App Store, c'est pourquoi nous ne les testons mÃªme pas, mais nous sommes autorisÃ©s Ã  les utiliser pour notre analyse dynamique.

## Fuzzing des schÃ©mas d'URL

Si l'application analyse des parties de l'URL, vous pouvez Ã©galement effectuer un fuzzing d'entrÃ©e pour dÃ©tecter des bugs de corruption de mÃ©moire.

Ce que nous avons appris ci-dessus peut maintenant Ãªtre utilisÃ© pour construire votre propre fuzzer dans le langage de votre choix, par exemple en Python, et appeler `openURL` en utilisant [RPC de Frida](https://www.frida.re/docs/javascript-api/#rpc). Ce fuzzer doit faire ce qui suit :

* GÃ©nÃ©rer des charges utiles.
* Pour chacun d'eux, appeler `openURL`.
* VÃ©rifier si l'application gÃ©nÃ¨re un rapport de plantage (`.ips`) dans `/private/var/mobile/Library/Logs/CrashReporter`.

Le projet [FuzzDB](https://github.com/fuzzdb-project/fuzzdb) propose des dictionnaires de fuzzing que vous pouvez utiliser comme charges utiles.

## **Fuzzing avec Frida**

Faire cela avec Frida est assez facile, vous pouvez vous rÃ©fÃ©rer Ã  ce [blog post](https://grepharder.github.io/blog/0x03\_learning\_about\_universal\_links\_and\_fuzzing\_url\_schemes\_on\_ios\_with\_frida.html) pour voir un exemple qui fuzzes l'application iGoat-Swift (fonctionnant sur iOS 11.1.2).

Avant d'exÃ©cuter le fuzzer, nous avons besoin des schÃ©mas d'URL en tant qu'entrÃ©es. Ã€ partir de l'analyse statique, nous savons que l'application iGoat-Swift prend en charge le schÃ©ma d'URL et les paramÃ¨tres suivants : `iGoat://?contactNumber={0}&message={0}`.
```bash
$ frida -U SpringBoard -l ios-url-scheme-fuzzing.js
[iPhone::SpringBoard]-> fuzz("iGoat", "iGoat://?contactNumber={0}&message={0}")
Watching for crashes from iGoat...
No logs were moved.
Opened URL: iGoat://?contactNumber=0&message=0
```
# RÃ©fÃ©rences

{% embed url="https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06h-testing-platform-interaction#testing-object-persistence-mstg-platform-8" %}



<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- Travaillez-vous dans une entreprise de **cybersÃ©curitÃ©** ? Voulez-vous voir votre **entreprise annoncÃ©e dans HackTricks** ? ou voulez-vous avoir accÃ¨s Ã  la **derniÃ¨re version de PEASS ou tÃ©lÃ©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !

- DÃ©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)

- **Rejoignez le** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Partagez vos astuces de piratage en soumettant des PR au [repo hacktricks](https://github.com/carlospolop/hacktricks) et au [repo hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
