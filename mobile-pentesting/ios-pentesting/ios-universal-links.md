# iOS Universal Links


{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}


## Introducci칩n

Los enlaces universales ofrecen una **experiencia de redirecci칩n** fluida a los usuarios al abrir directamente el contenido en la aplicaci칩n, evitando la necesidad de redirecci칩n a Safari. Estos enlaces son **칰nicos** y seguros, ya que no pueden ser reclamados por otras aplicaciones. Esto se asegura al alojar un archivo JSON `apple-app-site-association` en el directorio ra칤z del sitio web, estableciendo un enlace verificable entre el sitio web y la aplicaci칩n. En los casos en que la aplicaci칩n no est치 instalada, Safari tomar치 el control y dirigir치 al usuario a la p치gina web, manteniendo la presencia de la aplicaci칩n.

Para los pentesters, el archivo `apple-app-site-association` es de particular inter칠s, ya que puede revelar **rutas sensibles**, potencialmente incluyendo aquellas relacionadas con caracter칤sticas no publicadas.

### **Analizando el derecho de dominios asociados**

Los desarrolladores habilitan los enlaces universales configurando los **Dominios Asociados** en la pesta침a Capacidades de Xcode o inspeccionando el archivo `.entitlements`. Cada dominio est치 precedido por `applinks:`. Por ejemplo, la configuraci칩n de Telegram podr칤a aparecer de la siguiente manera:
```xml
<key>com.apple.developer.associated-domains</key>
<array>
<string>applinks:telegram.me</string>
<string>applinks:t.me</string>
</array>
```
Para obtener informaci칩n m치s completa, consulta la [documentaci칩n de Apple Developer archivada](https://developer.apple.com/library/archive/documentation/General/Conceptual/AppSearch/UniversalLinks.html#//apple_ref/doc/uid/TP40016308-CH12-SW2).

Si trabajas con una aplicaci칩n compilada, los derechos pueden ser extra칤dos como se detalla en [esta gu칤a](extracting-entitlements-from-compiled-application.md).

### **Recuperando el archivo de asociaci칩n de sitios de aplicaciones de Apple**

El archivo `apple-app-site-association` debe ser recuperado del servidor utilizando los dominios especificados en los derechos. Aseg칰rate de que el archivo sea accesible a trav칠s de HTTPS directamente en `https://<domain>/apple-app-site-association`. Herramientas como el [validador de Apple App Site Association (AASA)](https://branch.io/resources/aasa-validator/) pueden ayudar en este proceso.

### **Manejando enlaces universales en la aplicaci칩n**

La aplicaci칩n debe implementar m칠todos espec칤ficos para manejar enlaces universales correctamente. El m칠todo principal a buscar es [`application:continueUserActivity:restorationHandler:`](https://developer.apple.com/documentation/uikit/uiapplicationdelegate/1623072-application). Es crucial que el esquema de las URL manejadas sea HTTP o HTTPS, ya que otros no ser치n soportados.

#### **Validando el m칠todo de manejo de datos**

Cuando un enlace universal abre una aplicaci칩n, se pasa un objeto `NSUserActivity` a la aplicaci칩n con la URL. Antes de procesar esta URL, es esencial validarla y sanearla para prevenir riesgos de seguridad. Aqu칤 hay un ejemplo en Swift que demuestra el proceso:
```swift
func application(_ application: UIApplication, continue userActivity: NSUserActivity,
restorationHandler: @escaping ([UIUserActivityRestoring]?) -> Void) -> Bool {
// Check for web browsing activity and valid URL
if userActivity.activityType == NSUserActivityTypeBrowsingWeb, let url = userActivity.webpageURL {
application.open(url, options: [:], completionHandler: nil)
}

return true
}
```
Las URL deben ser analizadas y validadas cuidadosamente, especialmente si incluyen par치metros, para protegerse contra posibles suplantaciones o datos mal formados. La API `NSURLComponents` es 칰til para este prop칩sito, como se demuestra a continuaci칩n:
```swift
func application(_ application: UIApplication,
continue userActivity: NSUserActivity,
restorationHandler: @escaping ([Any]?) -> Void) -> Bool {
guard userActivity.activityType == NSUserActivityTypeBrowsingWeb,
let incomingURL = userActivity.webpageURL,
let components = NSURLComponents(url: incomingURL, resolvingAgainstBaseURL: true),
let path = components.path,
let params = components.queryItems else {
return false
}

if let albumName = params.first(where: { $0.name == "albumname" })?.value,
let photoIndex = params.first(where: { $0.name == "index" })?.value {
// Process the URL with album name and photo index

return true

} else {
// Handle invalid or missing parameters

return false
}
}
```
A trav칠s de **una configuraci칩n y validaci칩n diligentes**, los desarrolladores pueden asegurarse de que los enlaces universales mejoren la experiencia del usuario mientras mantienen los est치ndares de seguridad y privacidad.

## Tools
* [GetUniversal.link](https://getuniversal.link/): Ayuda a simplificar la prueba y gesti칩n de los Enlaces Universales de tu aplicaci칩n y el archivo AASA. Simplemente ingresa tu dominio para verificar la integridad del archivo AASA o utiliza el panel personalizado para probar f치cilmente el comportamiento de los enlaces. Esta herramienta tambi칠n te ayuda a determinar cu치ndo Apple indexar치 nuevamente tu archivo AASA.

## References
* [https://mas.owasp.org/MASTG/tests/ios/MASVS-PLATFORM/MASTG-TEST-0070/#static-analysis](https://mas.owasp.org/MASTG/tests/ios/MASVS-PLATFORM/MASTG-TEST-0070/#static-analysis)
* [https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06h-testing-platform-interaction#testing-object-persistence-mstg-platform-8](https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06h-testing-platform-interaction#testing-object-persistence-mstg-platform-8)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
