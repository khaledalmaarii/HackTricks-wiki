# Applications Xamarin

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **Informations de base**

Xamarin est une plateforme open-source qui offre aux d√©veloppeurs un acc√®s √† une s√©lection compl√®te d'outils et d'extensions, leur permettant de **cr√©er des applications modernes pour iOS, Android et Windows en utilisant les frameworks .NET et C#**.

### Architecture Android Xamarin

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Xamarin propose des liaisons .NET aux espaces de noms Android.\* et Java.\*. Les applications Xamarin.

Android fonctionnent sous l'environnement d'ex√©cution Mono, avec la machine virtuelle Android Runtime (ART) qui fonctionne en parall√®le.

L'environnement d'ex√©cution Mono appelle ces espaces de noms via des Managed Callable Wrappers (MCW) et fournit des Android Callable Wrappers (ACW) √† l'ART.

Ces deux environnements fonctionnent sur le noyau Linux et invoquent diverses API pour le code utilisateur. L'arrangement permet aux d√©veloppeurs d'acc√©der au syst√®me sous-jacent.

### Projet Xamarin iOS

Les applications Xamarin.iOS fonctionnent sous l'environnement d'ex√©cution Mono et utilisent une compilation compl√®te Ahead of Time (AOT) pour compiler les codes C# .NET en langage d'assemblage ARM.

Elles fonctionnent conjointement avec le Runtime Objective-C. Les environnements d'ex√©cution fonctionnent sur un noyau de type UNIX et invoquent plusieurs API pour le code utilisateur, ce qui permet aux d√©veloppeurs d'acc√©der au syst√®me g√©r√© ou natif sous-jacent.

Le diagramme ci-dessous illustre cette architecture :

<figure><img src="../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Qu'est-ce que le Runtime .Net et le Framework Mono ?

**Le framework .Net est un ensemble d'assemblages, de classes et d'espaces de noms** que les d√©veloppeurs peuvent utiliser pour cr√©er des applications ; le Runtime .Net ex√©cute le code compil√©, et le processus est appel√© ex√©cution de code g√©r√©. Le Runtime .NET offre plusieurs fonctionnalit√©s qui garantissent l'ind√©pendance de la plateforme et sont compatibles avec les versions ant√©rieures du framework.

**Le Framework Mono** a √©t√© lanc√© en 2005 comme une impl√©mentation du Framework .NET pour Linux (Ximian/SuSe/Novell). Sponsoris√© par Microsoft et dirig√© par Xamarin, Mono est l'impl√©mentation open-source du framework .NET bas√©e sur les standards ECMA pour le Common Language Runtime et C#.

## Techniques de Reverse Engineering pour les Applications Xamarin

### D√©compilation des Assemblages Xamarin

La d√©compilation est le processus utilis√© pour produire du code source √† partir de code compil√©. Pour obtenir des informations sur les assemblages et les ex√©cutables actuellement en m√©moire, Windows est un excellent endroit.

Pour ouvrir la fen√™tre Modules, s√©lectionnez Debug > Windows > Modules. Une fois que vous d√©tectez le module qui n√©cessite une d√©compilation, faites un clic droit et s√©lectionnez "D√©compiler la source en fichier de symboles". Cette action **cr√©e un fichier de symboles contenant une source d√©compil√©e qui**, √† son tour, vous permet d'entrer directement dans le code tiers √† partir de votre code source.

**Visual Studio** d√©compile le code g√©r√©, m√™me en l'absence de symboles, vous permettant de regarder le code, d'inspecter les variables et de placer des points d'arr√™t. Pour extraire le code source sur le disque, faites un clic droit sur le module avec source int√©gr√©e et cliquez sur "Extraire la source int√©gr√©e". Cela exportera les fichiers source dans un dossier de fichiers divers pour une analyse plus approfondie.

### Compilation JIT vs AOT des Applications Xamarin

Ces deux options pour compiler le code Xamarin bas√© sur C# en une application, c'est-√†-dire, **la compilation Just in time et la compilation ahead of time**. La mani√®re de compilation affecte la mani√®re dont le code de l'application est livr√© dans le fichier apk ou ipa. Examinons cela rapidement ci-dessous :

\- **Android** : Xamarin vous permet de compiler en utilisant **√† la fois les drapeaux JIT et AOT pour android**. Il existe √©galement un moyen interm√©diaire pour obtenir la plus grande vitesse d'ex√©cution en utilisant le mode Hybrid AOT. Notez que le mode Full AOT est disponible uniquement pour la licence Enterprise.

\- **iOS** : Il n'y a qu'une seule option dans le cas d'iOS, **la compilation ahead-of-time**. Cela est d√ª aux politiques d'Apple qui interdisent l'ex√©cution de code g√©n√©r√© dynamiquement sur un appareil.

{% hint style="info" %}
Si vous rencontrez une application compil√©e Full AOT, et si les fichiers IL Assembly sont supprim√©s pour r√©duire la taille de construction par le d√©veloppeur, alors le reverse n√©cessite une √©tape suppl√©mentaire d'extraction des fichiers dll √† partir des fichiers .dll.so du dossier lib ou du fichier `libmonodroid_bundle_app.so`. Si c'est une application compil√©e Hybrid AOT, et que les fichiers IL sont toujours conserv√©s dans le paquet de l'application, nous pouvons les utiliser pour faire du reverse engineering de l'application.
{% endhint %}

## Obtenir les fichiers dll √† partir de l'APK/IPA

Il suffit de **d√©compresser le fichier apk/ipa** et de copier tous les fichiers pr√©sents sous le r√©pertoire des assemblages :

<figure><img src="../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Dans le cas des **APKs Android, ces fichiers dll sont compress√©s** et ne peuvent pas √™tre directement utilis√©s pour la d√©compilation. Heureusement, il existe des outils que nous pouvons utiliser pour **d√©compresser ces fichiers dll** comme [XamAsmUnZ](https://github.com/cihansol/XamAsmUnZ) et [xamarin-decompress](https://github.com/NickstaDB/xamarin-decompress).
```
python3 xamarin-decompress.py -o /path/to/decompressed/apk
```
Il est possible qu'au lieu de fichiers dll, vous verrez `assemblies.blob` et `assemblies.manifest` dans le r√©pertoire des assemblages. C'est un Xamarin AssemblyStore et la m√©thode actuellement recommand√©e pour empaqueter les dll dans une application Android. Le fichier `assemblies.manifest` est un fichier texte d√©crivant le contenu du fichier binaire `assemblies.blob`. Pour d√©compresser ces fichiers, vous devrez utiliser [pyxamstore](https://github.com/jakev/pyxamstore).
```
pyxamstore unpack -d /path/to/decompressed/apk/assemblies/
```
Dans le cas d'iOS, **les fichiers dll √† l'int√©rieur des fichiers IPA peuvent √™tre charg√©s directement** dans un d√©compilateur (pas besoin de d√©compresser quoi que ce soit).

**La plupart du code de l'application peut √™tre trouv√©e lorsque nous d√©compilons les fichiers dll.** Notez √©galement que les applications bas√©es sur le Xamarin Framework contiennent 90 % de code commun dans les builds de toutes les plateformes comme iOS et Android, etc.

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

D'apr√®s la capture d'√©cran ci-dessus listant les fichiers dll pr√©sents dans l'apk, nous pouvons confirmer qu'il s'agit d'une application Xamarin. Elle contient des fichiers dll sp√©cifiques √† l'application ainsi que les fichiers de biblioth√®que n√©cessaires au fonctionnement de l'application, tels que `Xamarin.Essentails.dll` ou `Mono.Security.dll`.

{% hint style="success" %}
Enfin, vous pouvez utiliser [**ces outils recommand√©s**](../reversing/reversing-tools-basic-methods/#net-decompiler) pour acc√©der au **code C#** √† partir des DLLs.
{% endhint %}

## Analyse Dynamique

Essayez de v√©rifier si l'application a une forme de SSL pinning en place. Si ce n'est pas le cas, utiliser Burp comme CA syst√®me devrait fonctionner pour intercepter les requ√™tes. **Frida avec Java ou ObjC runtime ne fonctionnera pas** ici, mais heureusement, il existe un outil qui peut √™tre utilis√© pour se brancher dans les m√©thodes.

[**Fridax**](https://github.com/NorthwaveSecurity/fridax) vous permet de **modifier facilement le binaire .NET √† l'int√©rieur d'une application Xamarin en temps r√©el**. L'analyse statique vous aidera √† identifier diff√©rentes m√©thodes pr√©sentes au sein de l'application, qui peuvent √™tre branch√©es plus tard pour l'analyse dynamique en utilisant Fridax. Voici quelques scripts Frida qui peuvent nous aider √† contourner la d√©tection de root ou le SSL-pinning :

* [**xamarin-antiroot**](https://codeshare.frida.re/@Gand3lf/xamarin-antiroot/)
* [**xamarin-root-detect-bypass**](https://codeshare.frida.re/@nuschpl/xamarin-root-detect-bypass/)
* [**Frida-xamarin-unpin**](https://github.com/GoSecure/frida-xamarin-unpin)

## R√©f√©rences

* [https://www.appknox.com/security/xamarin-reverse-engineering-a-guide-for-penetration-testers](https://www.appknox.com/security/xamarin-reverse-engineering-a-guide-for-penetration-testers)
* [https://thecobraden.com/posts/unpacking\_xamarin\_assembly\_stores/](https://thecobraden.com/posts/unpacking\_xamarin\_assembly\_stores/)

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
