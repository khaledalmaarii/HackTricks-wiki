# 11211 - Testowanie penetracyjne Memcache

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Informacje o protokole

Z [Wikipedii](https://en.wikipedia.org/wiki/Memcached):

> **Memcached** (wymowa: mem-cashed, mem-cash-dee) to og贸lnego przeznaczenia rozproszony [system buforowania pamici](https://en.wikipedia.org/wiki/Memory\_caching). Czsto jest u偶ywany do przyspieszania dynamicznych stron internetowych opartych na bazie danych poprzez buforowanie danych i obiekt贸w w pamici RAM w celu zmniejszenia liczby odczyt贸w zewntrznego 藕r贸da danych (takiego jak baza danych lub interfejs API).

Chocia偶 Memcached obsuguje SASL, wikszo instancji jest **nara偶ona bez uwierzytelnienia**.

**Domylny port:** 11211
```
PORT      STATE SERVICE
11211/tcp open  unknown
```
## Wyliczanie

### Rczne

Aby wydoby wszystkie informacje zapisane w instancji memcache, musisz:

1. Znale藕 **slaby** z **aktywnymi elementami**
2. Pobra **nazwy kluczy** wykrytych slab贸w
3. Wydoby **zapisane dane**, pobierajc nazwy kluczy

Pamitaj, 偶e ta usuga to tylko **pami podrczna**, wic **dane mog si pojawia i znika**.
```bash
echo "version" | nc -vn -w 1 <IP> 11211      #Get version
echo "stats" | nc -vn -w 1 <IP> 11211        #Get status
echo "stats slabs" | nc -vn -w 1 <IP> 11211  #Get slabs
echo "stats items" | nc -vn -w 1 <IP> 11211  #Get items of slabs with info
echo "stats cachedump <number> 0" | nc -vn -w 1 <IP> 11211  #Get key names (the 0 is for unlimited output size)
echo "get <item_name>" | nc -vn -w 1 <IP> 11211  #Get saved info

#This php will just dump the keys, you need to use "get <item_name> later"
sudo apt-get install php-memcached
php -r '$c = new Memcached(); $c->addServer("localhost", 11211); var_dump( $c->getAllKeys() );'
```
### Instrukcja2

Memcached jest rozproszonym systemem pamici podrcznej, kt贸ry jest szeroko stosowany w aplikacjach internetowych do przyspieszania dostpu do danych. Jednak偶e, niekt贸re konfiguracje Memcached mog prowadzi do powa偶nych luk w zabezpieczeniach, kt贸re mog by wykorzystane przez haker贸w do uzyskania nieautoryzowanego dostpu do danych.

#### Wykrywanie Memcached

Aby wykry, czy dana aplikacja korzysta z Memcached, mo偶na u偶y narzdzi takich jak `nmap` lub `masscan`. Przeskanuj porty 11211 i 11212, kt贸re s domylnie u偶ywane przez Memcached.

```bash
nmap -p 11211,11212 <adres_ip_aplikacji>
```

#### Ataki na Memcached

1. Atak DDoS: Memcached mo偶e by wykorzystany do przeprowadzenia ataku DDoS poprzez wysyanie zapyta UDP z faszywym adresem IP ofiary. Aby przeprowadzi taki atak, mo偶na u偶y narzdzi takich jak `memcrashed` lub `Memcrashed-DDoS-Exploit`.

2. Atak na wyciek danych: Jeli Memcached jest 藕le skonfigurowany, mo偶e wystpi wyciek danych. Mo偶na to wykorzysta, aby uzyska dostp do poufnych informacji. Aby przeprowadzi taki atak, mo偶na u偶y narzdzi takich jak `Memcached-Server-Scanner` lub `Memcached-Dumper`.

#### Zabezpieczanie Memcached

Aby zabezpieczy Memcached przed atakami, nale偶y podj nastpujce kroki:

1. Wyczanie nasuchu na publicznym interfejsie sieciowym i ograniczenie dostpu tylko do lokalnego interfejsu sieciowego.

2. Skonfiguruj Memcached, aby wymaga uwierzytelniania przy poczeniach.

3. Zaktualizuj Memcached do najnowszej wersji, aby unikn znanych luk w zabezpieczeniach.

4. Monitoruj Memcached, aby wykry ewentualne nieprawidowoci lub ataki.

#### Podsumowanie

Memcached jest pot偶nym narzdziem do przyspieszania dostpu do danych w aplikacjach internetowych. Jednak偶e, nale偶y pamita o odpowiednim zabezpieczeniu Memcached, aby unikn potencjalnych luk w zabezpieczeniach i atak贸w.
```bash
sudo apt install libmemcached-tools
memcstat --servers=127.0.0.1 #Get stats
memcdump --servers=127.0.0.1 #Get all items
memccat  --servers=127.0.0.1 <item1> <item2> <item3> #Get info inside the item(s)
```
### Automatyczne

Memcached jest popularnym systemem cache'owania, kt贸ry jest szeroko stosowany w aplikacjach internetowych. Jednak偶e, niekt贸re konfiguracje Memcached mog by podatne na ataki zewntrzne, co mo偶e prowadzi do wycieku poufnych danych. W tym rozdziale om贸wimy automatyczne narzdzia, kt贸re mog pom贸c w identyfikacji i eksploatacji takich podatnoci.

#### Memcrashed

Memcrashed to narzdzie napisane w jzyku Python, kt贸re automatyzuje ataki DDoS na serwery Memcached. Narzdzie to wykorzystuje protok贸 UDP, aby wysya zapytania do serwera Memcached, kt贸re s odpowiednio spreparowane, aby wywoa odpowied藕 o du偶ej objtoci. Atak DDoS za pomoc Memcrashed mo偶e spowodowa znaczne obci偶enie serwera i prowadzi do jego awarii.

Aby u偶y narzdzia Memcrashed, nale偶y wprowadzi adres IP docelowego serwera Memcached oraz port, na kt贸rym serwer nasuchuje. Narzdzie automatycznie wygeneruje i wyle odpowiednie zapytania, aby wywoa odpowied藕 o du偶ej objtoci.

```bash
python memcrashed.py <adres_IP_serwera_Memcached> <port_serwera>
```

#### Memcrashed Amplification Scanner

Memcrashed Amplification Scanner to narzdzie napisane w jzyku Python, kt贸re automatycznie skanuje sie w poszukiwaniu serwer贸w Memcached, kt贸re mog by wykorzystane do atak贸w DDoS za pomoc narzdzia Memcrashed. Narzdzie to wysya zapytania do wszystkich adres贸w IP w podanej podsieci, aby sprawdzi, czy serwer Memcached jest dostpny i czy mo偶na go wykorzysta do ataku.

Aby u偶y narzdzia Memcrashed Amplification Scanner, nale偶y wprowadzi adres IP podsieci, kt贸r chcemy zeskanowa, oraz port, na kt贸rym serwery Memcached nasuchuj. Narzdzie automatycznie skanuje wszystkie adresy IP w podsieci i wywietla wyniki.

```bash
python memcrashed_amplification_scanner.py <adres_IP_podsieci> <port_serwer贸w_Memcached>
```

#### Memcrashed Amplification Scanner (z wykorzystaniem Shodan)

Memcrashed Amplification Scanner (z wykorzystaniem Shodan) to rozszerzenie narzdzia Memcrashed Amplification Scanner, kt贸re wykorzystuje Shodan do automatycznego skanowania sieci w poszukiwaniu serwer贸w Memcached. Shodan to wyszukiwarka urzdze podczonych do Internetu, kt贸ra umo偶liwia identyfikacj publicznie dostpnych serwer贸w Memcached.

Aby u偶y narzdzia Memcrashed Amplification Scanner z wykorzystaniem Shodan, nale偶y wprowadzi klucz API Shodan oraz adres IP podsieci, kt贸r chcemy zeskanowa. Narzdzie automatycznie wykorzystuje Shodan do skanowania sieci i wywietla wyniki.

```bash
python memcrashed_amplification_scanner_shodan.py <klucz_API_Shodan> <adres_IP_podsieci>
```

#### Memcrashed Amplification Scanner (z wykorzystaniem Censys)

Memcrashed Amplification Scanner (z wykorzystaniem Censys) to rozszerzenie narzdzia Memcrashed Amplification Scanner, kt贸re wykorzystuje Censys do automatycznego skanowania sieci w poszukiwaniu serwer贸w Memcached. Censys to platforma do monitorowania i analizy danych zwizanych z infrastruktur internetow.

Aby u偶y narzdzia Memcrashed Amplification Scanner z wykorzystaniem Censys, nale偶y wprowadzi klucz API Censys oraz adres IP podsieci, kt贸r chcemy zeskanowa. Narzdzie automatycznie wykorzystuje Censys do skanowania sieci i wywietla wyniki.

```bash
python memcrashed_amplification_scanner_censys.py <klucz_API_Censys> <adres_IP_podsieci>
```

#### Memcrashed Amplification Scanner (z wykorzystaniem ZoomEye)

Memcrashed Amplification Scanner (z wykorzystaniem ZoomEye) to rozszerzenie narzdzia Memcrashed Amplification Scanner, kt贸re wykorzystuje ZoomEye do automatycznego skanowania sieci w poszukiwaniu serwer贸w Memcached. ZoomEye to wyszukiwarka urzdze podczonych do Internetu, kt贸ra umo偶liwia identyfikacj publicznie dostpnych serwer贸w Memcached.

Aby u偶y narzdzia Memcrashed Amplification Scanner z wykorzystaniem ZoomEye, nale偶y wprowadzi klucz API ZoomEye oraz adres IP podsieci, kt贸r chcemy zeskanowa. Narzdzie automatycznie wykorzystuje ZoomEye do skanowania sieci i wywietla wyniki.

```bash
python memcrashed_amplification_scanner_zoomeye.py <klucz_API_ZoomEye> <adres_IP_podsieci>
```
```bash
nmap -n -sV --script memcached-info -p 11211 <IP>   #Just gather info
msf > use auxiliary/gather/memcached_extractor      #Extracts saved data
msf > use auxiliary/scanner/memcached/memcached_amp #Check is UDP DDoS amplification attack is possible
```
## **Dumpowanie kluczy Memcache**

W wiecie memcache istniej specjalne polecenia umo偶liwiajce inspekcj przechowywanych danych, cho z pewnymi ograniczeniami:

1. Klucze mog by dumpowane tylko wedug klasy slab, grupujcej klucze o podobnym rozmiarze zawartoci.
2. Istnieje limit jednej strony na klas slab, co r贸wna si 1MB danych.
3. Ta funkcjonalno jest nieoficjalna i mo偶e zosta wycofana w dowolnym momencie, jak om贸wiono w [forum spoecznociowym](https://groups.google.com/forum/?fromgroups=#!topic/memcached/1-T8I-RVGKM).

Ograniczenie polegajce na mo偶liwoci dumpowania tylko 1MB danych spor贸d potencjalnie gigabajt贸w danych jest szczeg贸lnie istotne. Niemniej jednak, ta funkcjonalno mo偶e wci偶 dostarczy informacji na temat wzorc贸w u偶ywania kluczy, w zale偶noci od konkretnych potrzeb. Dla tych, kt贸rzy mniej interesuj si mechanik, w [sekcji narzdzi](https://lzone.de/cheat-sheet/memcached#tools) mo偶na znale藕 narzdzia do kompleksowego dumpowania. Alternatywnie, poni偶ej przedstawiono proces korzystania z telnetu do bezporedniej interakcji z konfiguracj memcached.

### **Jak to dziaa**

Organizacja pamici w memcache jest kluczowa. Uruchomienie memcache z opcj "-vv" ujawnia generowane przez niego klasy slab, jak pokazano poni偶ej:
```bash
$ memcached -vv
slab class   1: chunk size        96 perslab   10922
[...]
```
Aby wywietli wszystkie obecnie istniejce slaby, u偶ywa si nastpujcej komendy:
```bash
stats slabs
```
Dodanie pojedynczego klucza do memcached 1.4.13 ilustruje, jak s tworzone i zarzdzane klasy slab贸w. Na przykad:
```bash
set mykey 0 60 1
1
STORED
```
Wykonanie polecenia "stats slabs" po dodaniu klucza dostarcza szczeg贸owych statystyk dotyczcych wykorzystania slab贸w:
```bash
stats slabs
[...]
```
Ten wynik ujawnia aktywne typy slab贸w, wykorzystane fragmenty i statystyki operacyjne, dostarczajc informacji na temat efektywnoci operacji odczytu i zapisu.

Inne przydatne polecenie, "stats items", dostarcza danych dotyczcych usuwania, ogranicze pamiciowych i cykli 偶ycia element贸w:
```bash
stats items
[...]
```
Te statystyki te pozwalaj na przypuszczenia dotyczce zachowania pamici podrcznej aplikacji, w tym wydajnoci pamici podrcznej dla r贸偶nych rozmiar贸w zawartoci, alokacji pamici i pojemnoci do przechowywania du偶ych obiekt贸w.

### **Wyciek kluczy**

Wersje wczeniejsze ni偶 1.4.31 wyciekaj klucze wedug klasy slab za pomoc:
```bash
stats cachedump <slab class> <number of items to dump>
```
Na przykad, aby wydoby klucz w klasie #1:
```bash
stats cachedump 1 1000
ITEM mykey [1 b; 1350677968 s]
END
```
Ta metoda iteruje po klasach slab, wyodrbniajc i opcjonalnie zrzutujc wartoci kluczy.

### **ZRZUTOWANIE KLUCZY MEMCACHE (WERSJA 1.4.31+)**

Wersja memcache 1.4.31 i nowsze wprowadzaj now, bezpieczniejsz metod zrzutu kluczy w rodowisku produkcyjnym, wykorzystujc tryb nieblokujcy, jak szczeg贸owo opisano w [notatkach wydania](https://github.com/memcached/memcached/wiki/ReleaseNotes1431). Ten podejcie generuje obszerny wynik, dlatego zaleca si u偶ycie polecenia 'nc' dla efektywnoci. Przykady obejmuj:
```bash
echo 'lru_crawler metadump all' | nc 127.0.0.1 11211 | head -1
echo 'lru_crawler metadump all' | nc 127.0.0.1 11211 | grep ee6ba58566e234ccbbce13f9a24f9a28
```
### **NARZDZIA DO WYWIETLANIA DANYCH**

Tabela [std](https://lzone.de/blog).

| Jzyki programowania | Narzdzia                                                                                                                          | Funkcjonalno                                                                                          |                                                                             |         |
| -------------------- | ---------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------ | --------------------------------------------------------------------------- | ------- |
| PHP                  | [prosty skrypt](http://snipt.org/xtP)                                                                                              | Wywietla nazwy kluczy.                                                                                  |                                                                             |         |
| Perl                 | [prosty skrypt](https://wiki.jasig.org/download/attachments/13572172/memcached-clean.pl?version=1\&modificationDate=1229693957401) | Wywietla klucze i wartoci.                                                                             |                                                                             |         |
| Ruby                 | [prosty skrypt](https://gist.github.com/1365005)                                                                                   | Wywietla nazwy kluczy.                                                                                  |                                                                             |         |
| Perl                 | [memdump](https://search.cpan.org/\~dmaki/Memcached-libmemcached-0.4202/src/libmemcached/docs/memdump.pod)                         | Narzdzie w module CPAN                                                                                 | [Memcached-libmemcached](https://search.cpan.org/\~dmaki/Memcached-libmemc) | ached/) |
| PHP                  | [memcache.php](http://livebookmark.net/journal/2008/05/21/memcachephp-stats-like-apcphp/)                                          | GUI monitorujce Memcache, kt贸re umo偶liwia r贸wnie偶 wywietlanie kluczy.                                  |                                                                             |         |
| libmemcached         | [peep](http://blog.evanweaver.com/2009/04/20/peeping-into-memcached/)                                                              | **Zamra偶a proces memcached!!!** Bd藕 ostro偶ny podczas u偶ywania tego w produkcji. U偶ywajc go, mo偶na obej ograniczenie 1MB i naprawd wywietli **wszystkie** klucze. |                                                                             |         |

## Rozwizywanie problem贸w <a href="#troubleshooting" id="troubleshooting"></a>

### Ograniczenie danych do 1MB <a href="#1mb-data-limit" id="1mb-data-limit"></a>

Nale偶y pamita, 偶e przed wersj memcached 1.4 nie mo偶na przechowywa obiekt贸w wikszych ni偶 1MB ze wzgldu na domylny maksymalny rozmiar slabu.

### Nigdy nie ustawiaj limitu czasu na wicej ni偶 30 dni! <a href="#never-set-a-timeout--30-days" id="never-set-a-timeout--30-days"></a>

Jeli pr贸bujesz ustawi klucz z limitem czasu wikszym ni偶 dozwolony maksymalny, mo偶e si okaza, 偶e nie otrzymasz oczekiwanego rezultatu, poniewa偶 memcached traktuje warto jako znacznik czasu Unix. Jeli znacznik czasu jest w przeszoci, nie zostanie wykonana 偶adna operacja. Twoje polecenie zakoczy si bez 偶adnego komunikatu.

Jeli chcesz u偶y maksymalnego okresu wa偶noci, nale偶y poda warto 2592000. Przykad:
```
set my_key 0 2592000 1
1
```
### Znikajce klucze przy przepenieniu <a href="#disappearing-keys-on-overflow" id="disappearing-keys-on-overflow"></a>

Mimo 偶e dokumentacja m贸wi o owiniciu wartoci przy przepenieniu 64-bitowym za pomoc polecenia "incr", powoduje to zniknicie wartoci. Nale偶y j ponownie utworzy za pomoc polecenia "add"/"set".

### Replikacja <a href="#replication" id="replication"></a>

Sam memcached nie obsuguje replikacji. Jeli naprawd jej potrzebujesz, musisz skorzysta z rozwiza firm trzecich:

* [repcached](http://repcached.lab.klab.org/): wielomasterowa replikacja asynchroniczna (zestaw atek memcached 1.2)
* [Interfejs memcached Couchbase](http://www.couchbase.com/memcached): U偶yj CouchBase jako zamiennika memcached
* [yrmcds](https://cybozu.github.io/yrmcds/): kompatybilne z memcached, klucz-warto, magazyn Master-Slave
* [twemproxy](https://github.com/twitter/twemproxy) (znany r贸wnie偶 jako nutcracker): proxy obsugujce memcached

### Arkusz podpowiedzi polece

{% content-ref url="memcache-commands.md" %}
[memcache-commands.md](memcache-commands.md)
{% endcontent-ref %}

### **Shodan**

* `port:11211 "STAT pid"`
* `"STAT pid"`

## Odnoniki

* [https://lzone.de/cheat-sheet/memcached](https://lzone.de/cheat-sheet/memcached)

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
