# 11211 - Pentesting Memcache

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Protocol Information

From [wikipedia](https://en.wikipedia.org/wiki/Memcached):

> **Memcached** (prononciation : mem-cashed, mem-cash-dee) est un syst√®me de [mise en cache en m√©moire](https://en.wikipedia.org/wiki/Memory\_caching) distribu√© √† usage g√©n√©ral. Il est souvent utilis√© pour acc√©l√©rer les sites Web dynamiques bas√©s sur des bases de donn√©es en mettant en cache des donn√©es et des objets dans la RAM afin de r√©duire le nombre de fois qu'une source de donn√©es externe (comme une base de donn√©es ou une API) doit √™tre lue.

Bien que Memcached prenne en charge SASL, la plupart des instances sont **expos√©es sans authentification**.

**Port par d√©faut :** 11211
```
PORT      STATE SERVICE
11211/tcp open  unknown
```
## Enumeration

### Manual

Pour exfiltrer toutes les informations enregistr√©es dans une instance memcache, vous devez :

1. Trouver des **slabs** avec des **√©l√©ments actifs**
2. Obtenir les **noms de cl√©s** des slabs d√©tect√©s pr√©c√©demment
3. Exfiltrer les **donn√©es enregistr√©es** en **obtenant les noms de cl√©s**

N'oubliez pas que ce service n'est qu'un **cache**, donc **les donn√©es peuvent appara√Ætre et dispara√Ætre**.
```bash
echo "version" | nc -vn -w 1 <IP> 11211      #Get version
echo "stats" | nc -vn -w 1 <IP> 11211        #Get status
echo "stats slabs" | nc -vn -w 1 <IP> 11211  #Get slabs
echo "stats items" | nc -vn -w 1 <IP> 11211  #Get items of slabs with info
echo "stats cachedump <number> 0" | nc -vn -w 1 <IP> 11211  #Get key names (the 0 is for unlimited output size)
echo "get <item_name>" | nc -vn -w 1 <IP> 11211  #Get saved info

#This php will just dump the keys, you need to use "get <item_name> later"
sudo apt-get install php-memcached
php -r '$c = new Memcached(); $c->addServer("localhost", 11211); var_dump( $c->getAllKeys() );'
```
### Manuel2
```bash
sudo apt install libmemcached-tools
memcstat --servers=127.0.0.1 #Get stats
memcdump --servers=127.0.0.1 #Get all items
memccat  --servers=127.0.0.1 <item1> <item2> <item3> #Get info inside the item(s)
```
### Automatique
```bash
nmap -n -sV --script memcached-info -p 11211 <IP>   #Just gather info
msf > use auxiliary/gather/memcached_extractor      #Extracts saved data
msf > use auxiliary/scanner/memcached/memcached_amp #Check is UDP DDoS amplification attack is possible
```
## **Dumping Memcache Keys**

Dans le domaine de memcache, un protocole qui aide √† organiser les donn√©es par slabs, des commandes sp√©cifiques existent pour inspecter les donn√©es stock√©es, bien qu'avec des contraintes notables :

1. Les cl√©s ne peuvent √™tre extraites que par classe de slab, regroupant les cl√©s de taille de contenu similaire.
2. Une limite existe d'une page par classe de slab, √©quivalant √† 1 Mo de donn√©es.
3. Cette fonctionnalit√© est non officielle et peut √™tre interrompue √† tout moment, comme discut√© dans [les forums communautaires](https://groups.google.com/forum/?fromgroups=#!topic/memcached/1-T8I-RVGKM).

La limitation de ne pouvoir extraire que 1 Mo de donn√©es parmi potentiellement des gigaoctets de donn√©es est particuli√®rement significative. Cependant, cette fonctionnalit√© peut encore offrir des aper√ßus sur les mod√®les d'utilisation des cl√©s, selon les besoins sp√©cifiques. Pour ceux qui s'int√©ressent moins √† la m√©canique, une visite dans la [section outils](https://lzone.de/cheat-sheet/memcached#tools) r√©v√®le des utilitaires pour un dumping complet. Alternativement, le processus d'utilisation de telnet pour une interaction directe avec les configurations memcached est d√©crit ci-dessous.

### **How it Works**

L'organisation de la m√©moire de Memcache est essentielle. Lancer memcache avec l'option "-vv" r√©v√®le les classes de slab qu'il g√©n√®re, comme montr√© ci-dessous :
```bash
$ memcached -vv
slab class   1: chunk size        96 perslab   10922
[...]
```
Pour afficher tous les slabs actuellement existants, la commande suivante est utilis√©e :
```bash
stats slabs
```
Ajouter une seule cl√© √† memcached 1.4.13 illustre comment les classes de slab sont peupl√©es et g√©r√©es. Par exemple :
```bash
set mykey 0 60 1
1
STORED
```
Ex√©cuter la commande "stats slabs" apr√®s l'ajout de la cl√© fournit des statistiques d√©taill√©es sur l'utilisation des slabs :
```bash
stats slabs
[...]
```
Cette sortie r√©v√®le les types de slab actifs, les chunks utilis√©s et les statistiques op√©rationnelles, offrant des aper√ßus sur l'efficacit√© des op√©rations de lecture et d'√©criture.

Une autre commande utile, "stats items", fournit des donn√©es sur les √©victions, les contraintes de m√©moire et les cycles de vie des √©l√©ments :
```bash
stats items
[...]
```
Ces statistiques permettent de faire des hypoth√®ses √©clair√©es sur le comportement de mise en cache des applications, y compris l'efficacit√© du cache pour diff√©rentes tailles de contenu, l'allocation de m√©moire et la capacit√© de mise en cache d'objets volumineux.

### **Dumping Keys**

Pour les versions ant√©rieures √† 1.4.31, les cl√©s sont extraites par classe de slab en utilisant :
```bash
stats cachedump <slab class> <number of items to dump>
```
Par exemple, pour extraire une cl√© dans la classe #1 :
```bash
stats cachedump 1 1000
ITEM mykey [1 b; 1350677968 s]
END
```
Cette m√©thode it√®re sur les classes de slab, extrayant et optionnellement d√©versant les valeurs cl√©s.

### **DUMPING MEMCACHE KEYS (VER 1.4.31+)**

Avec la version memcache 1.4.31 et sup√©rieure, une nouvelle m√©thode plus s√ªre pour d√©verser les cl√©s dans un environnement de production est introduite, utilisant le mode non-bloquant comme d√©taill√© dans les [notes de version](https://github.com/memcached/memcached/wiki/ReleaseNotes1431). Cette approche g√©n√®re une sortie extensive, d'o√π la recommandation d'employer la commande 'nc' pour plus d'efficacit√©. Les exemples incluent :
```bash
echo 'lru_crawler metadump all' | nc 127.0.0.1 11211 | head -1
echo 'lru_crawler metadump all' | nc 127.0.0.1 11211 | grep ee6ba58566e234ccbbce13f9a24f9a28
```
### **OUTILS DE DUMPING**

Table [from here](https://lzone.de/blog).

| Langages de Programmation | Outils                                                                                                                              | Fonctionnalit√©                                                                                                                                                          |                                                                             |         |
| ------------------------- | ---------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------- | ------- |
| PHP                       | [simple script](http://snipt.org/xtP)                                                                                              | Imprime les noms de cl√©s.                                                                                                                                             |                                                                             |         |
| Perl                      | [simple script](https://wiki.jasig.org/download/attachments/13572172/memcached-clean.pl?version=1\&modificationDate=1229693957401) | Imprime les cl√©s et les valeurs                                                                                                                                      |                                                                             |         |
| Ruby                      | [simple script](https://gist.github.com/1365005)                                                                                   | Imprime les noms de cl√©s.                                                                                                                                             |                                                                             |         |
| Perl                      | [memdump](https://search.cpan.org/\~dmaki/Memcached-libmemcached-0.4202/src/libmemcached/docs/memdump.pod)                         | Outil dans le module CPAN                                                                                                                                             | [Memcached-libmemcached](https://search.cpan.org/\~dmaki/Memcached-libmemc) | ached/) |
| PHP                       | [memcache.php](http://livebookmark.net/journal/2008/05/21/memcachephp-stats-like-apcphp/)                                          | Interface de surveillance Memcache qui permet √©galement de dumper les cl√©s                                                                                           |                                                                             |         |
| libmemcached              | [peep](http://blog.evanweaver.com/2009/04/20/peeping-into-memcached/)                                                              | **Fait geler votre processus memcached !!!** Faites attention en l'utilisant en production. En l'utilisant, vous pouvez contourner la limitation de 1 Mo et vraiment dumper **toutes** les cl√©s. |                                                                             |         |

## D√©pannage <a href="#troubleshooting" id="troubleshooting"></a>

### Limite de Donn√©es de 1 Mo <a href="#1mb-data-limit" id="1mb-data-limit"></a>

Notez qu'avant memcached 1.4, vous ne pouvez pas stocker des objets plus grands que 1 Mo en raison de la taille maximale de slab par d√©faut.

### Ne Jamais D√©finir un D√©lai > 30 Jours ! <a href="#never-set-a-timeout--30-days" id="never-set-a-timeout--30-days"></a>

Si vous essayez de ‚Äúd√©finir‚Äù ou ‚Äúajouter‚Äù une cl√© avec un d√©lai sup√©rieur au maximum autoris√©, vous pourriez ne pas obtenir ce que vous attendez car memcached traite alors la valeur comme un horodatage Unix. De plus, si l'horodatage est dans le pass√©, il ne fera rien du tout. Votre commande √©chouera silencieusement.

Donc, si vous voulez utiliser la dur√©e de vie maximale, sp√©cifiez 2592000. Exemple :
```
set my_key 0 2592000 1
1
```
### Disappearing Keys on Overflow <a href="#disappearing-keys-on-overflow" id="disappearing-keys-on-overflow"></a>

Malgr√© la documentation disant quelque chose sur le fait que le d√©bordement d'une valeur 64 bits en utilisant ‚Äúincr‚Äù fait dispara√Ætre la valeur. Elle doit √™tre cr√©√©e √† nouveau en utilisant ‚Äúadd‚Äù/‚Äùset‚Äù.

### Replication <a href="#replication" id="replication"></a>

memcached lui-m√™me ne prend pas en charge la r√©plication. Si vous en avez vraiment besoin, vous devez utiliser des solutions tierces :

* [repcached](http://repcached.lab.klab.org/): R√©plication multi-ma√Ætre asynchrone (ensemble de correctifs memcached 1.2)
* [Couchbase memcached interface](http://www.couchbase.com/memcached): Utilisez CouchBase comme remplacement de memcached
* [yrmcds](https://cybozu.github.io/yrmcds/): magasin de valeurs cl√©s Master-Slave compatible memcached
* [twemproxy](https://github.com/twitter/twemproxy) (alias nutcracker): proxy avec support memcached

### Commands Cheat-Sheet

{% content-ref url="memcache-commands.md" %}
[memcache-commands.md](memcache-commands.md)
{% endcontent-ref %}

### **Shodan**

* `port:11211 "STAT pid"`
* `"STAT pid"`

## References

* [https://lzone.de/cheat-sheet/memcached](https://lzone.de/cheat-sheet/memcached)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
