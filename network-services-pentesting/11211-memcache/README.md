# 11211 - Pentesting Memcache

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Protocol Information

From [wikipedia](https://en.wikipedia.org/wiki/Memcached):

> **Memcached** (izgovor: mem-kesd, mem-keÅ¡-di) je sistem za keÅ¡iranje u memoriji opÅ¡te namene. ÄŒesto se koristi za ubrzavanje dinamiÄkih veb sajtova koji koriste baze podataka keÅ¡iranjem podataka i objekata u RAM-u kako bi se smanjio broj puta kada se mora Äitati spoljni izvor podataka (kao Å¡to su baza podataka ili API).

Iako Memcached podrÅ¾ava SASL, veÄ‡ina instanci je **izloÅ¾ena bez autentifikacije**.

**Podrazumevani port:** 11211
```
PORT      STATE SERVICE
11211/tcp open  unknown
```
## Enumeration

### Manual

Da biste ekfiltrirali sve informacije saÄuvane unutar memcache instance, potrebno je:

1. PronaÄ‡i **slabs** sa **aktivnim stavkama**
2. Dobiti **imena kljuÄeva** slabova otkrivenih ranije
3. Ekfiltrirati **saÄuvane podatke** dobijanjem **imena kljuÄeva**

Zapamtite da je ova usluga samo **cache**, tako da **podatci mogu da se pojavljuju i nestaju**.
```bash
echo "version" | nc -vn -w 1 <IP> 11211      #Get version
echo "stats" | nc -vn -w 1 <IP> 11211        #Get status
echo "stats slabs" | nc -vn -w 1 <IP> 11211  #Get slabs
echo "stats items" | nc -vn -w 1 <IP> 11211  #Get items of slabs with info
echo "stats cachedump <number> 0" | nc -vn -w 1 <IP> 11211  #Get key names (the 0 is for unlimited output size)
echo "get <item_name>" | nc -vn -w 1 <IP> 11211  #Get saved info

#This php will just dump the keys, you need to use "get <item_name> later"
sudo apt-get install php-memcached
php -r '$c = new Memcached(); $c->addServer("localhost", 11211); var_dump( $c->getAllKeys() );'
```
### Manual2
```bash
sudo apt install libmemcached-tools
memcstat --servers=127.0.0.1 #Get stats
memcdump --servers=127.0.0.1 #Get all items
memccat  --servers=127.0.0.1 <item1> <item2> <item3> #Get info inside the item(s)
```
### Automatski
```bash
nmap -n -sV --script memcached-info -p 11211 <IP>   #Just gather info
msf > use auxiliary/gather/memcached_extractor      #Extracts saved data
msf > use auxiliary/scanner/memcached/memcached_amp #Check is UDP DDoS amplification attack is possible
```
## **Dumping Memcache Keys**

U oblasti memcache, protokola koji pomaÅ¾e u organizovanju podataka po slabovima, postoje specifiÄne komande za inspekciju saÄuvanih podataka, iako sa znaÄajnim ograniÄenjima:

1. KljuÄevi se mogu dumpovati samo po slab klasi, grupiÅ¡uÄ‡i kljuÄeve sliÄne veliÄine sadrÅ¾aja.
2. Postoji ograniÄenje od jedne stranice po slab klasi, Å¡to odgovara 1MB podataka.
3. Ova funkcija je nesluÅ¾bena i moÅ¾e biti ukinuta u bilo kojem trenutku, kao Å¡to je raspravljeno na [forumima zajednice](https://groups.google.com/forum/?fromgroups=#!topic/memcached/1-T8I-RVGKM).

OgraniÄenje dumpovanja samo 1MB iz potencijalno gigabajta podataka je posebno znaÄajno. Ipak, ova funkcionalnost moÅ¾e pruÅ¾iti uvide u obrasce koriÅ¡Ä‡enja kljuÄeva, u zavisnosti od specifiÄnih potreba. Za one koji su manje zainteresovani za mehaniku, poseta [odeljku sa alatima](https://lzone.de/cheat-sheet/memcached#tools) otkriva alate za sveobuhvatan dump. Alternativno, proces koriÅ¡Ä‡enja telnet-a za direktnu interakciju sa memcached postavkama je opisan u nastavku.

### **How it Works**

Organizacija memorije u memcache-u je kljuÄna. Pokretanje memcache-a sa opcijom "-vv" otkriva slab klase koje generiÅ¡e, kao Å¡to je prikazano u nastavku:
```bash
$ memcached -vv
slab class   1: chunk size        96 perslab   10922
[...]
```
Da biste prikazali sve trenutno postojeÄ‡e slabove, koristi se sledeÄ‡a komanda:
```bash
stats slabs
```
Dodavanje jednog kljuÄa u memcached 1.4.13 ilustruje kako se slab klase popunjavaju i upravljaju. Na primer:
```bash
set mykey 0 60 1
1
STORED
```
IzvrÅ¡avanje komande "stats slabs" nakon dodavanja kljuÄa daje detaljnu statistiku o koriÅ¡Ä‡enju slabova:
```bash
stats slabs
[...]
```
Ovaj izlaz otkriva aktivne tipove slabova, koriÅ¡Ä‡ene delove i operativne statistike, pruÅ¾ajuÄ‡i uvide u efikasnost operacija Äitanja i pisanja.

JoÅ¡ jedna korisna komanda, "stats items", pruÅ¾a podatke o evikcijama, ograniÄenjima memorije i Å¾ivotnim ciklusima stavki:
```bash
stats items
[...]
```
Ove statistike omoguÄ‡avaju obrazloÅ¾ene pretpostavke o ponaÅ¡anju keÅ¡iranja aplikacija, ukljuÄujuÄ‡i efikasnost keÅ¡a za razliÄite veliÄine sadrÅ¾aja, alokaciju memorije i kapacitet za keÅ¡iranje velikih objekata.

### **Dumping Keys**

Za verzije pre 1.4.31, kljuÄevi se dumpuju po slab klasi koristeÄ‡i:
```bash
stats cachedump <slab class> <number of items to dump>
```
Na primer, da biste dumpovali kljuÄ u klasi #1:
```bash
stats cachedump 1 1000
ITEM mykey [1 b; 1350677968 s]
END
```
Ova metoda prolazi kroz slab klase, izvlaÄeÄ‡i i opcionalno dumpujuÄ‡i kljuÄne vrednosti.

### **DUMPING MEMCACHE KEYS (VER 1.4.31+)**

Sa verzijom memcache 1.4.31 i iznad, uvedena je nova, sigurnija metoda za dumpovanje kljuÄeva u produkcionom okruÅ¾enju, koristeÄ‡i neblokirajuÄ‡i reÅ¾im kao Å¡to je detaljno opisano u [release notes](https://github.com/memcached/memcached/wiki/ReleaseNotes1431). Ovaj pristup generiÅ¡e opseÅ¾an izlaz, stoga se preporuÄuje koriÅ¡Ä‡enje 'nc' komande za efikasnost. Primeri ukljuÄuju:
```bash
echo 'lru_crawler metadump all' | nc 127.0.0.1 11211 | head -1
echo 'lru_crawler metadump all' | nc 127.0.0.1 11211 | grep ee6ba58566e234ccbbce13f9a24f9a28
```
### **DUMPING TOOLS**

Table [from here](https://lzone.de/blog).

| Programming Languages | Tools                                                                                                                              | Functionality                                                                                                                                                          |                                                                             |         |
| --------------------- | ---------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------- | ------- |
| PHP                   | [simple script](http://snipt.org/xtP)                                                                                              | Å tampa imena kljuÄeva.                                                                                                                                               |                                                                             |         |
| Perl                  | [simple script](https://wiki.jasig.org/download/attachments/13572172/memcached-clean.pl?version=1\&modificationDate=1229693957401) | Å tampa kljuÄeve i vrednosti                                                                                                                                          |                                                                             |         |
| Ruby                  | [simple script](https://gist.github.com/1365005)                                                                                   | Å tampa imena kljuÄeva.                                                                                                                                               |                                                                             |         |
| Perl                  | [memdump](https://search.cpan.org/\~dmaki/Memcached-libmemcached-0.4202/src/libmemcached/docs/memdump.pod)                         | Alat u CPAN modulu                                                                                                                                                  | [Memcached-libmemcached](https://search.cpan.org/\~dmaki/Memcached-libmemc) | ached/) |
| PHP                   | [memcache.php](http://livebookmark.net/journal/2008/05/21/memcachephp-stats-like-apcphp/)                                          | Memcache Monitoring GUI koji takoÄ‘e omoguÄ‡ava dumpovanje kljuÄeva                                                                                                   |                                                                             |         |
| libmemcached          | [peep](http://blog.evanweaver.com/2009/04/20/peeping-into-memcached/)                                                              | **Zamrzava vaÅ¡ memcached proces!!!** Budite oprezni kada to koristite u produkciji. I dalje, koristeÄ‡i to moÅ¾ete zaobiÄ‡i ograniÄenje od 1MB i stvarno dumpovati **sve** kljuÄeve. |                                                                             |         |

## Troubleshooting <a href="#troubleshooting" id="troubleshooting"></a>

### 1MB Data Limit <a href="#1mb-data-limit" id="1mb-data-limit"></a>

Napomena da pre memcached 1.4 ne moÅ¾ete Äuvati objekte veÄ‡e od 1MB zbog podrazumevane maksimalne veliÄine slab.

### Never Set a Timeout > 30 Days! <a href="#never-set-a-timeout--30-days" id="never-set-a-timeout--30-days"></a>

Ako pokuÅ¡ate da â€œsetâ€ ili â€œaddâ€ kljuÄ sa vremenskim ograniÄenjem veÄ‡im od dozvoljenog maksimuma, moÅ¾da neÄ‡ete dobiti ono Å¡to oÄekujete jer memcached tada tretira vrednost kao Unix vremensku oznaku. TakoÄ‘e, ako je vremenska oznaka u proÅ¡losti, neÄ‡e uÄiniti niÅ¡ta. VaÅ¡a komanda Ä‡e tiho propasti.

Dakle, ako Å¾elite da koristite maksimalni vek, navedite 2592000. Primer:
```
set my_key 0 2592000 1
1
```
### Disappearing Keys on Overflow <a href="#disappearing-keys-on-overflow" id="disappearing-keys-on-overflow"></a>

Iako dokumentacija kaÅ¾e neÅ¡to o prebacivanju oko 64bit prelivanja vrednosti koristeÄ‡i â€œincrâ€, to uzrokuje da vrednost nestane. Potrebno je ponovo je kreirati koristeÄ‡i â€œaddâ€/â€setâ€.

### Replication <a href="#replication" id="replication"></a>

memcached sam ne podrÅ¾ava replikaciju. Ako vam je zaista potrebna, morate koristiti reÅ¡enja treÄ‡ih strana:

* [repcached](http://repcached.lab.klab.org/): Multi-master async replikacija (memcached 1.2 patch set)
* [Couchbase memcached interface](http://www.couchbase.com/memcached): Koristite CouchBase kao memcached drop-in
* [yrmcds](https://cybozu.github.io/yrmcds/): memcached kompatibilan Master-Slave key value store
* [twemproxy](https://github.com/twitter/twemproxy) (aka nutcracker): proxy sa memcached podrÅ¡kom

### Commands Cheat-Sheet

{% content-ref url="memcache-commands.md" %}
[memcache-commands.md](memcache-commands.md)
{% endcontent-ref %}

### **Shodan**

* `port:11211 "STAT pid"`
* `"STAT pid"`

## References

* [https://lzone.de/cheat-sheet/memcached](https://lzone.de/cheat-sheet/memcached)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
