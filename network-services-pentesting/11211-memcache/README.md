# 11211 - æ¸—é€æµ‹è¯• Memcache

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS çº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨ HackTricks ä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½ PDF ç‰ˆçš„ HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## åè®®ä¿¡æ¯

æ¥è‡ª [ç»´åŸºç™¾ç§‘](https://en.wikipedia.org/wiki/Memcached)ï¼š

> **Memcached**ï¼ˆå‘éŸ³ï¼šmem-cashedï¼Œmem-cash-deeï¼‰æ˜¯ä¸€ç§é€šç”¨çš„åˆ†å¸ƒå¼[å†…å­˜ç¼“å­˜](https://en.wikipedia.org/wiki/Memory\_caching)ç³»ç»Ÿã€‚é€šå¸¸ç”¨äºé€šè¿‡å°†æ•°æ®å’Œå¯¹è±¡ç¼“å­˜åœ¨ RAM ä¸­æ¥åŠ é€ŸåŠ¨æ€æ•°æ®åº“é©±åŠ¨çš„ç½‘ç«™ï¼Œä»¥å‡å°‘å¿…é¡»è¯»å–å¤–éƒ¨æ•°æ®æºï¼ˆå¦‚æ•°æ®åº“æˆ– APIï¼‰çš„æ¬¡æ•°ã€‚

å°½ç®¡ Memcached æ”¯æŒ SASLï¼Œä½†å¤§å¤šæ•°å®ä¾‹éƒ½**æ²¡æœ‰èº«ä»½éªŒè¯**ã€‚

**é»˜è®¤ç«¯å£ï¼š**11211
```
PORT      STATE SERVICE
11211/tcp open  unknown
```
## æšä¸¾

### æ‰‹åŠ¨

è¦æå–å­˜å‚¨åœ¨ memcache å®ä¾‹ä¸­çš„æ‰€æœ‰ä¿¡æ¯ï¼Œæ‚¨éœ€è¦æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

1. æŸ¥æ‰¾å…·æœ‰**æ´»åŠ¨é¡¹ç›®**çš„**slabs**
2. è·å–ä¹‹å‰æ£€æµ‹åˆ°çš„ slabs çš„**é”®å**
3. é€šè¿‡**è·å–é”®å**æ¥**æå–ä¿å­˜çš„æ•°æ®**

è¯·è®°ä½ï¼Œè¿™é¡¹æœåŠ¡åªæ˜¯ä¸€ä¸ª**ç¼“å­˜**ï¼Œå› æ­¤**æ•°æ®å¯èƒ½ä¼šå‡ºç°å’Œæ¶ˆå¤±**ã€‚
```bash
echo "version" | nc -vn -w 1 <IP> 11211      #Get version
echo "stats" | nc -vn -w 1 <IP> 11211        #Get status
echo "stats slabs" | nc -vn -w 1 <IP> 11211  #Get slabs
echo "stats items" | nc -vn -w 1 <IP> 11211  #Get items of slabs with info
echo "stats cachedump <number> 0" | nc -vn -w 1 <IP> 11211  #Get key names (the 0 is for unlimited output size)
echo "get <item_name>" | nc -vn -w 1 <IP> 11211  #Get saved info

#This php will just dump the keys, you need to use "get <item_name> later"
sudo apt-get install php-memcached
php -r '$c = new Memcached(); $c->addServer("localhost", 11211); var_dump( $c->getAllKeys() );'
```
### æ‰‹åŠ¨2
```bash
sudo apt install libmemcached-tools
memcstat --servers=127.0.0.1 #Get stats
memcdump --servers=127.0.0.1 #Get all items
memccat  --servers=127.0.0.1 <item1> <item2> <item3> #Get info inside the item(s)
```
### è‡ªåŠ¨åŒ–
```bash
nmap -n -sV --script memcached-info -p 11211 <IP>   #Just gather info
msf > use auxiliary/gather/memcached_extractor      #Extracts saved data
msf > use auxiliary/scanner/memcached/memcached_amp #Check is UDP DDoS amplification attack is possible
```
## **Dumping Memcache Keys**

åœ¨memcacheé¢†åŸŸï¼Œä¸€ç§é€šè¿‡slabsç»„ç»‡æ•°æ®çš„åè®®ï¼Œå­˜åœ¨ç”¨äºæ£€æŸ¥å­˜å‚¨æ•°æ®çš„ç‰¹å®šå‘½ä»¤ï¼Œå°½ç®¡å­˜åœ¨æ˜¾è‘—çš„é™åˆ¶ï¼š

1. åªèƒ½æŒ‰slabç±»åˆ«è½¬å‚¨å¯†é’¥ï¼Œå°†ç›¸ä¼¼å†…å®¹å¤§å°çš„å¯†é’¥åˆ†ç»„åœ¨ä¸€èµ·ã€‚
2. æ¯ä¸ªslabç±»åˆ«åªèƒ½è½¬å‚¨ä¸€é¡µæ•°æ®ï¼Œç›¸å½“äº1MBçš„æ•°æ®ã€‚
3. æ­¤åŠŸèƒ½æ˜¯éå®˜æ–¹çš„ï¼Œå¯èƒ½éšæ—¶åœæ­¢ä½¿ç”¨ï¼Œå¦‚[ç¤¾åŒºè®ºå›](https://groups.google.com/forum/?fromgroups=#!topic/memcached/1-T8I-RVGKM)ä¸­æ‰€è®¨è®ºçš„ã€‚

ä»…èƒ½ä»æ½œåœ¨çš„å‡ GBæ•°æ®ä¸­è½¬å‚¨1MBçš„é™åˆ¶å°¤ä¸ºé‡è¦ã€‚ç„¶è€Œï¼Œæ ¹æ®å…·ä½“éœ€æ±‚ï¼Œæ­¤åŠŸèƒ½ä»å¯æä¾›æœ‰å…³å¯†é’¥ä½¿ç”¨æ¨¡å¼çš„è§è§£ã€‚å¯¹äºé‚£äº›å¯¹æœºåˆ¶ä¸å¤ªæ„Ÿå…´è¶£çš„äººï¼Œè®¿é—®[å·¥å…·éƒ¨åˆ†](https://lzone.de/cheat-sheet/memcached#tools)å¯å‘ç°ç”¨äºå…¨é¢è½¬å‚¨çš„å®ç”¨ç¨‹åºã€‚æˆ–è€…ï¼Œä¸‹é¢æ¦‚è¿°äº†ä½¿ç”¨telnetç›´æ¥ä¸memcachedè®¾ç½®è¿›è¡Œäº¤äº’çš„è¿‡ç¨‹ã€‚

### **å·¥ä½œåŸç†**

Memcacheçš„å†…å­˜ç»„ç»‡è‡³å…³é‡è¦ã€‚ä½¿ç”¨"-vv"é€‰é¡¹å¯åŠ¨memcacheä¼šæ˜¾ç¤ºå…¶ç”Ÿæˆçš„slabç±»åˆ«ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
```bash
$ memcached -vv
slab class   1: chunk size        96 perslab   10922
[...]
```
è¦æ˜¾ç¤ºæ‰€æœ‰å½“å‰å­˜åœ¨çš„slabsï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š
```bash
stats slabs
```
å‘memcached 1.4.13æ·»åŠ ä¸€ä¸ªé”®å¯è¯´æ˜slabç±»æ˜¯å¦‚ä½•è¢«å¡«å……å’Œç®¡ç†çš„ã€‚ä¾‹å¦‚ï¼š
```bash
set mykey 0 60 1
1
STORED
```
æ‰§è¡Œ"stats slabs"å‘½ä»¤åæ·»åŠ å¯†é’¥ä¼šäº§ç”Ÿå…³äºslabåˆ©ç”¨ç‡çš„è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯ï¼š
```bash
stats slabs
[...]
```
è¿™ä¸ªè¾“å‡ºæ˜¾ç¤ºäº†æ´»è·ƒçš„slabç±»å‹ã€å·²ä½¿ç”¨çš„å—ä»¥åŠæ“ä½œç»Ÿè®¡æ•°æ®ï¼Œä¸ºè¯»å–å’Œå†™å…¥æ“ä½œçš„æ•ˆç‡æä¾›äº†è§è§£ã€‚

å¦ä¸€ä¸ªæœ‰ç”¨çš„å‘½ä»¤æ˜¯"stats items"ï¼Œå®ƒæä¾›äº†å…³äºé©±é€ã€å†…å­˜é™åˆ¶å’Œæ¡ç›®ç”Ÿå‘½å‘¨æœŸçš„æ•°æ®ï¼š
```bash
stats items
[...]
```
### **è½¬å‚¨å¯†é’¥**

å¯¹äº1.4.31ç‰ˆæœ¬ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æŒ‰slabç±»è½¬å‚¨å¯†é’¥ï¼š
```bash
stats cachedump <slab class> <number of items to dump>
```
ä¾‹å¦‚ï¼Œè¦åœ¨ç±»åˆ«ï¼ƒ1 ä¸­è½¬å‚¨ä¸€ä¸ªé”®ï¼š
```bash
stats cachedump 1 1000
ITEM mykey [1 b; 1350677968 s]
END
```
### **è½¬å‚¨ Memcache é”®ï¼ˆç‰ˆæœ¬ 1.4.31+ï¼‰**

ä» slab ç±»ä¸­æå–å¹¶å¯é€‰åœ°è½¬å‚¨é”®å€¼çš„æ–¹æ³•ã€‚

ä½¿ç”¨ memcache ç‰ˆæœ¬ 1.4.31 åŠä»¥ä¸Šï¼Œå¼•å…¥äº†ä¸€ç§æ–°çš„æ›´å®‰å…¨çš„åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è½¬å‚¨é”®çš„æ–¹æ³•ï¼Œåˆ©ç”¨éé˜»å¡æ¨¡å¼ï¼Œè¯¦ç»†ä¿¡æ¯è¯·å‚é˜…[å‘å¸ƒè¯´æ˜](https://github.com/memcached/memcached/wiki/ReleaseNotes1431)ã€‚è¿™ç§æ–¹æ³•ç”Ÿæˆäº†å¤§é‡è¾“å‡ºï¼Œå› æ­¤å»ºè®®ä½¿ç”¨ 'nc' å‘½ä»¤ä»¥æé«˜æ•ˆç‡ã€‚ç¤ºä¾‹åŒ…æ‹¬ï¼š
```bash
echo 'lru_crawler metadump all' | nc 127.0.0.1 11211 | head -1
echo 'lru_crawler metadump all' | nc 127.0.0.1 11211 | grep ee6ba58566e234ccbbce13f9a24f9a28
```
### **è½¬å‚¨å·¥å…·**

è¡¨æ ¼[æ¥è‡ªè¿™é‡Œ](https://lzone.de/blog)ã€‚

| ç¼–ç¨‹è¯­è¨€ | å·¥å…·                                                                                                                              | åŠŸèƒ½                                                                                                                                                                 |                                                                             |         |
| -------- | ---------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------- | ------- |
| PHP      | [ç®€å•è„šæœ¬](http://snipt.org/xtP)                                                                                              | æ‰“å°é”®åã€‚                                                                                                                                                      |                                                                             |         |
| Perl     | [ç®€å•è„šæœ¬](https://wiki.jasig.org/download/attachments/13572172/memcached-clean.pl?version=1\&modificationDate=1229693957401) | æ‰“å°é”®å’Œå€¼                                                                                                                                                 |                                                                             |         |
| Ruby     | [ç®€å•è„šæœ¬](https://gist.github.com/1365005)                                                                                   | æ‰“å°é”®åã€‚                                                                                                                                                      |                                                                             |         |
| Perl     | [memdump](https://search.cpan.org/\~dmaki/Memcached-libmemcached-0.4202/src/libmemcached/docs/memdump.pod)                         | CPANæ¨¡å—ä¸­çš„å·¥å…·                                                                                                                                                    | [Memcached-libmemcached](https://search.cpan.org/\~dmaki/Memcached-libmemc) | ached/) |
| PHP      | [memcache.php](http://livebookmark.net/journal/2008/05/21/memcachephp-stats-like-apcphp/)                                          | Memcacheç›‘æ§GUIï¼Œè¿˜å…è®¸è½¬å‚¨é”®                                                                                                                  |                                                                             |         |
| libmemcached          | [peep](http://blog.evanweaver.com/2009/04/20/peeping-into-memcached/)                                                              | **ä¼šå†»ç»“æ‚¨çš„memcachedè¿›ç¨‹ï¼** åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨æ—¶è¦å°å¿ƒã€‚å°½ç®¡å¦‚æ­¤ï¼Œæ‚¨å¯ä»¥ç»•è¿‡1MBé™åˆ¶ï¼ŒçœŸæ­£è½¬å‚¨**æ‰€æœ‰**é”®ã€‚ |                                                                             |         |

## æ•…éšœæ’é™¤ <a href="#troubleshooting" id="troubleshooting"></a>

### 1MB æ•°æ®é™åˆ¶ <a href="#1mb-data-limit" id="1mb-data-limit"></a>

è¯·æ³¨æ„ï¼Œåœ¨memcached 1.4ä¹‹å‰ï¼Œç”±äºé»˜è®¤æœ€å¤§slabå¤§å°ï¼Œæ‚¨æ— æ³•å­˜å‚¨å¤§äº1MBçš„å¯¹è±¡ã€‚

### æ°¸è¿œä¸è¦è®¾ç½®è¶…è¿‡30å¤©çš„è¶…æ—¶ï¼ <a href="#never-set-a-timeout--30-days" id="never-set-a-timeout--30-days"></a>

å¦‚æœæ‚¨å°è¯•ä½¿ç”¨è¶…è¿‡å…è®¸çš„æœ€å¤§å€¼çš„è¶…æ—¶â€œè®¾ç½®â€æˆ–â€œæ·»åŠ â€é”®ï¼Œåˆ™å¯èƒ½ä¸ä¼šå¾—åˆ°æ‚¨æœŸæœ›çš„ç»“æœï¼Œå› ä¸ºmemcachedä¼šå°†è¯¥å€¼è§†ä¸ºUnixæ—¶é—´æˆ³ã€‚æ­¤å¤–ï¼Œå¦‚æœæ—¶é—´æˆ³åœ¨è¿‡å»ï¼Œå®ƒå°†ä»€ä¹ˆä¹Ÿä¸åšã€‚æ‚¨çš„å‘½ä»¤å°†æ‚„æ— å£°æ¯åœ°å¤±è´¥ã€‚

å› æ­¤ï¼Œå¦‚æœè¦ä½¿ç”¨æœ€å¤§ç”Ÿå­˜æœŸï¼Œè¯·æŒ‡å®š2592000ã€‚ç¤ºä¾‹ï¼š
```
set my_key 0 2592000 1
1
```
### æº¢å‡ºæ—¶é”®å€¼æ¶ˆå¤± <a href="#disappearing-keys-on-overflow" id="disappearing-keys-on-overflow"></a>

å°½ç®¡æ–‡æ¡£ä¸­æåˆ°64ä½æº¢å‡ºå€¼ä¼šè¢«â€œincrâ€æ“ä½œå¯¼è‡´é”®å€¼æ¶ˆå¤±ï¼Œä½†éœ€è¦ä½¿ç”¨â€œaddâ€/â€œsetâ€é‡æ–°åˆ›å»ºé”®å€¼ã€‚

### å¤åˆ¶ <a href="#replication" id="replication"></a>

memcachedæœ¬èº«ä¸æ”¯æŒå¤åˆ¶ã€‚å¦‚æœç¡®å®éœ€è¦ï¼Œéœ€è¦ä½¿ç”¨ç¬¬ä¸‰æ–¹è§£å†³æ–¹æ¡ˆï¼š

* [repcached](http://repcached.lab.klab.org/): å¤šä¸»å¼‚æ­¥å¤åˆ¶ï¼ˆmemcached 1.2è¡¥ä¸é›†ï¼‰
* [Couchbase memcachedæ¥å£](http://www.couchbase.com/memcached): ä½¿ç”¨CouchBaseä½œä¸ºmemcachedçš„æ›¿ä»£
* [yrmcds](https://cybozu.github.io/yrmcds/): å…¼å®¹memcachedçš„ä¸»ä»é”®å€¼å­˜å‚¨
* [twemproxy](https://github.com/twitter/twemproxy)ï¼ˆåˆånutcrackerï¼‰: å…·æœ‰memcachedæ”¯æŒçš„ä»£ç†

### å‘½ä»¤é€ŸæŸ¥è¡¨

{% content-ref url="memcache-commands.md" %}
[memcache-commands.md](memcache-commands.md)
{% endcontent-ref %}

### **Shodan**

* `port:11211 "STAT pid"`
* `"STAT pid"`

## å‚è€ƒèµ„æ–™

* [https://lzone.de/cheat-sheet/memcached](https://lzone.de/cheat-sheet/memcached)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
