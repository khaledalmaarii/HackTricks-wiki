# 11211 - Pentestiranje Memcache

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Informacije o protokolu

Sa [wikipedia](https://en.wikipedia.org/wiki/Memcached):

> **Memcached** (izgovor: mem-ke코d, mem-ka코-di) je sistem za ke코iranje memorije op코te namene. 캛esto se koristi za ubrzavanje dinami캜kih veb sajtova koji koriste bazu podataka tako 코to ke코ira podatke i objekte u RAM-u kako bi se smanjio broj puta kada se mora 캜itati spoljni izvor podataka (kao 코to je baza podataka ili API).

Iako Memcached podr쬬va SASL, ve캖ina instanci je **izlo쬰na bez autentifikacije**.

**Podrazumevani port:** 11211
```
PORT      STATE SERVICE
11211/tcp open  unknown
```
## Enumeracija

### Ru캜no

Da biste izvukli sve informacije sa캜uvane unutar memcache instance, potrebno je:

1. Prona캖i **slabove** sa **aktivnim stavkama**
2. Dobiti **nazive klju캜eva** prona캠enih slabova
3. Izvu캖i **sa캜uvane podatke** dobijanjem naziva klju캜eva

Zapamtite da je ovaj servis samo **ke코**, pa se **podaci mogu pojavljivati i nestajati**.
```bash
echo "version" | nc -vn -w 1 <IP> 11211      #Get version
echo "stats" | nc -vn -w 1 <IP> 11211        #Get status
echo "stats slabs" | nc -vn -w 1 <IP> 11211  #Get slabs
echo "stats items" | nc -vn -w 1 <IP> 11211  #Get items of slabs with info
echo "stats cachedump <number> 0" | nc -vn -w 1 <IP> 11211  #Get key names (the 0 is for unlimited output size)
echo "get <item_name>" | nc -vn -w 1 <IP> 11211  #Get saved info

#This php will just dump the keys, you need to use "get <item_name> later"
sudo apt-get install php-memcached
php -r '$c = new Memcached(); $c->addServer("localhost", 11211); var_dump( $c->getAllKeys() );'
```
### Priru캜nik2

Memcached je distribuirani sistem ke코iranja podataka koji se 캜esto koristi za ubrzavanje performansi web aplikacija. Me캠utim, zbog svoje konfiguracije, Memcached mo쬰 biti podlo쬬n razli캜itim sigurnosnim ranjivostima koje mogu biti iskori코캖ene za neovla코캖eni pristup ili zloupotrebu podataka.

Ovaj priru캜nik 캖e vam pru쬴ti detaljan pregled Memcached-a, kao i nekoliko tehnika i alata koje mo쬰te koristiti za testiranje sigurnosti Memcached servera.

#### Sadr쬬j

1. [Uvod u Memcached](#uvod-u-memcached)
2. [Sigurnosne ranjivosti Memcached-a](#sigurnosne-ranjivosti-memcached-a)
3. [Testiranje sigurnosti Memcached servera](#testiranje-sigurnosti-memcached-servera)
4. [Za코tita Memcached servera](#za코tita-memcached-servera)

#### Uvod u Memcached

Memcached je open-source sistem ke코iranja podataka koji se koristi za ubrzavanje pristupa podacima u distribuiranim okru쬰njima. On funkcioni코e tako 코to podatke sme코ta u memoriju kako bi se smanjilo vreme pristupa bazi podataka. Memcached se 캜esto koristi u kombinaciji sa web aplikacijama kako bi se pobolj코ala njihova performansa.

#### Sigurnosne ranjivosti Memcached-a

Memcached mo쬰 biti podlo쬬n razli캜itim sigurnosnim ranjivostima, uklju캜uju캖i:

- Neovla코캖eni pristup: Ako Memcached server nije pravilno konfigurisan, mo쬰 biti dostupan javno i omogu캖iti neovla코캖enim korisnicima pristup osetljivim podacima.
- DoS napadi: Memcached server mo쬰 biti iskori코캖en za izvo캠enje napada uskra캖ivanja usluge (DoS) tako 코to 캖e biti preplavljen zahtevima i postati nedostupan za legitimne korisnike.
- Memcached Injection: Sli캜no SQL Injection-u, Memcached Injection se odnosi na ubacivanje zlonamernih komandi u Memcached zahtevima kako bi se izvr코ile neovla코tene operacije.

#### Testiranje sigurnosti Memcached servera

Da biste testirali sigurnost Memcached servera, mo쬰te koristiti razli캜ite tehnike i alate, uklju캜uju캖i:

- Memcrashed: Alat koji se koristi za izvo캠enje DoS napada na Memcached servere.
- Memcached Injection: Tehnika koja se koristi za ubacivanje zlonamernih komandi u Memcached zahtevima kako bi se izvr코ile neovla코tene operacije.
- Memcached sniffer: Alat koji se koristi za presretanje i analizu Memcached saobra캖aja kako bi se identifikovali potencijalni bezbednosni propusti.

#### Za코tita Memcached servera

Da biste za코titili Memcached server od sigurnosnih ranjivosti, mo쬰te preduzeti slede캖e mere:

- Konfiguracija pristupa: Ograni캜ite pristup Memcached serveru samo na autorizovane IP adrese.
- Enkripcija saobra캖aja: Koristite SSL/TLS enkripciju kako biste obezbedili siguran prenos podataka izme캠u Memcached servera i klijenata.
- Redovno a쬿riranje: Redovno a쬿rirajte Memcached server kako biste ispravili poznate sigurnosne ranjivosti i pobolj코ali bezbednost.

Napomena: Pre testiranja sigurnosti Memcached servera, uvek se pobrinite da imate dozvolu od vlasnika sistema i da se pridr쬬vate zakona i eti캜kih smernica.
```bash
sudo apt install libmemcached-tools
memcstat --servers=127.0.0.1 #Get stats
memcdump --servers=127.0.0.1 #Get all items
memccat  --servers=127.0.0.1 <item1> <item2> <item3> #Get info inside the item(s)
```
### Automatsko

---

#### Description

Memcached is an open-source, high-performance, distributed memory caching system that is commonly used to speed up dynamic web applications by caching data and objects in memory. However, misconfigurations or vulnerabilities in Memcached can lead to unauthorized access and potential data leaks.

This section provides information on how to perform automatic enumeration and exploitation of Memcached servers.

---

#### Automatic Enumeration

To automatically enumerate Memcached servers, you can use the `nmap` tool with the Memcached script:

```bash
nmap -p 11211 --script memcached-info <target>
```

This command will scan the specified target for open port 11211 and run the Memcached script to gather information about the server.

---

#### Automatic Exploitation

Once you have identified a Memcached server, you can use the `memcrashed` tool to launch a distributed denial-of-service (DDoS) attack against it. This tool takes advantage of the `stats` command in Memcached to amplify the attack traffic and overwhelm the target server.

To use `memcrashed`, follow these steps:

1. Install the tool by cloning the GitHub repository:

   ```bash
   git clone https://github.com/649/Memcrashed-DDoS-Exploit.git
   ```

2. Change into the tool's directory:

   ```bash
   cd Memcrashed-DDoS-Exploit
   ```

3. Launch the DDoS attack by specifying the target IP address and port:

   ```bash
   python3 memcrashed.py <target> <port>
   ```

   Replace `<target>` with the IP address of the Memcached server and `<port>` with the port number (usually 11211).

---

#### Mitigation

To protect your Memcached servers from enumeration and exploitation, consider the following mitigation measures:

- Disable external access to Memcached servers or restrict access to trusted IP addresses only.
- Implement strong authentication mechanisms, such as SASL, to prevent unauthorized access.
- Regularly update Memcached to the latest version to patch any known vulnerabilities.
- Monitor network traffic for any suspicious activity and implement intrusion detection and prevention systems.
- Implement rate limiting or traffic shaping to mitigate the impact of DDoS attacks.

---

#### References

- [Memcached Official Website](https://memcached.org/)
- [Memcrashed-DDoS-Exploit GitHub Repository](https://github.com/649/Memcrashed-DDoS-Exploit)
```bash
nmap -n -sV --script memcached-info -p 11211 <IP>   #Just gather info
msf > use auxiliary/gather/memcached_extractor      #Extracts saved data
msf > use auxiliary/scanner/memcached/memcached_amp #Check is UDP DDoS amplification attack is possible
```
## **Dumpiranje Memcache klju캜eva**

U svetu memcache-a, protokol koji poma쬰 u organizaciji podataka po slabs, postoje specifi캜ne komande za inspekciju sa캜uvanih podataka, iako uz primetna ograni캜enja:

1. Klju캜evi se mogu dumpovati samo po slab klasi, grupi코u캖i klju캜eve sli캜ne veli캜ine sadr쬬ja.
2. Postoji ograni캜enje od jedne stranice po slab klasi, 코to je ekvivalentno 1MB podataka.
3. Ova funkcionalnost je nezvani캜na i mo쬰 biti ukinuta u bilo kom trenutku, kako je diskutovano u [forumima zajednice](https://groups.google.com/forum/?fromgroups=#!topic/memcached/1-T8I-RVGKM).

Ograni캜enje da se mo쬰 dumpovati samo 1MB podataka iz potencijalno gigabajta podataka je posebno zna캜ajno. Me캠utim, ova funkcionalnost i dalje mo쬰 pru쬴ti uvid u obrasce kori코캖enja klju캜eva, u zavisnosti od specifi캜nih potreba. Za one manje zainteresovane za mehaniku, poseta [odeljku sa alatima](https://lzone.de/cheat-sheet/memcached#tools) otkriva alate za sveobuhvatno dumpovanje. Alternativno, postupak kori코캖enja telnet-a za direktnu interakciju sa memcached pode코avanjima je opisan u nastavku.

### **Kako radi**

Organizacija memorije u memcache-u je klju캜na. Pokretanje memcache-a sa opcijom "-vv" otkriva slab klase koje generi코e, kao 코to je prikazano ispod:
```bash
$ memcached -vv
slab class   1: chunk size        96 perslab   10922
[...]
```
Da biste prikazali sve trenutno postoje캖e slabe, koristi se slede캖a komanda:
```bash
stats slabs
```
Dodavanje jednog klju캜a u memcached 1.4.13 ilustruje kako se popunjavaju i upravljaju slab klase. Na primer:
```bash
set mykey 0 60 1
1
STORED
```
Izvr코avanje komande "stats slabs" nakon dodavanja klju캜a pru쬬 detaljne statistike o iskori코캖enosti slaba:
```bash
stats slabs
[...]
```
Ovaj izlaz otkriva aktivne tipove slaba, iskori코캖ene delove i operativnu statistiku, pru쬬ju캖i uvid u efikasnost operacija 캜itanja i pisanja.

Jo코 jedna korisna komanda, "stats items", pru쬬 podatke o izbacivanju, ograni캜enjima memorije i 쬴votnom ciklusu stavki:
```bash
stats items
[...]
```
Ove statistike omogu캖avaju obrazovane pretpostavke o pona코anju ke코iranja aplikacija, uklju캜uju캖i efikasnost ke코iranja za razli캜ite veli캜ine sadr쬬ja, alokaciju memorije i kapacitet za ke코iranje velikih objekata.

### **Izbacivanje klju캜eva**

Za verzije pre 1.4.31, klju캜evi se izbacuju po slaboj klasi koriste캖i:
```bash
stats cachedump <slab class> <number of items to dump>
```
Na primer, da biste izbacili klju캜 u klasi #1:
```bash
stats cachedump 1 1000
ITEM mykey [1 b; 1350677968 s]
END
```
Ova metoda prolazi kroz slab klase, izvla캜i i opciono ispisuje vrednosti klju캜eva.

### **ISPISIVANJE MEMCACHE KLJU캛EVA (VER 1.4.31+)**

Sa memcache verzijom 1.4.31 i novijom, uvedena je nova, sigurnija metoda za ispisivanje klju캜eva u produkcionom okru쬰nju, koriste캖i neblokiraju캖i re쬴m kako je detaljno opisano u [bele코kama o izdanju](https://github.com/memcached/memcached/wiki/ReleaseNotes1431). Ovaj pristup generi코e obimne rezultate, stoga se preporu캜uje kori코캖enje 'nc' komande radi efikasnosti. Primeri uklju캜uju:
```bash
echo 'lru_crawler metadump all' | nc 127.0.0.1 11211 | head -1
echo 'lru_crawler metadump all' | nc 127.0.0.1 11211 | grep ee6ba58566e234ccbbce13f9a24f9a28
```
### **ALATI ZA ISPISIVANJE**

Tabela [odavde](https://lzone.de/blog).

| Programski jezici | Alati                                                                                                                              | Funkcionalnost                                                                                                                                                          |                                                                             |         |
| ----------------- | ---------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------- | ------- |
| PHP               | [jednostavan skript](http://snipt.org/xtP)                                                                                              | Ispisuje nazive klju캜eva.                                                                                                                                                      |                                                                             |         |
| Perl              | [jednostavan skript](https://wiki.jasig.org/download/attachments/13572172/memcached-clean.pl?version=1\&modificationDate=1229693957401) | Ispisuje klju캜eve i vrednosti                                                                                                                                                 |                                                                             |         |
| Ruby              | [jednostavan skript](https://gist.github.com/1365005)                                                                                   | Ispisuje nazive klju캜eva.                                                                                                                                                      |                                                                             |         |
| Perl              | [memdump](https://search.cpan.org/\~dmaki/Memcached-libmemcached-0.4202/src/libmemcached/docs/memdump.pod)                         | Alat u CPAN modulu                                                                                                                                                    | [Memcached-libmemcached](https://search.cpan.org/\~dmaki/Memcached-libmemc) | ached/) |
| PHP               | [memcache.php](http://livebookmark.net/journal/2008/05/21/memcachephp-stats-like-apcphp/)                                          | Memcache Monitoring GUI koji tako캠e omogu캖ava ispisivanje klju캜eva                                                                                                                  |                                                                             |         |
| libmemcached      | [peep](http://blog.evanweaver.com/2009/04/20/peeping-into-memcached/)                                                              | **Zamrzava va코 memcached proces!!!** Budite oprezni prilikom kori코캖enja ovoga u produkciji. Ipak, koriste캖i ga, mo쬰te zaobi캖i ograni캜enje od 1MB i zaista ispisati **sve** klju캜eve. |                                                                             |         |

## Re코avanje problema <a href="#troubleshooting" id="troubleshooting"></a>

### Ograni캜enje podataka od 1MB <a href="#1mb-data-limit" id="1mb-data-limit"></a>

Imajte na umu da pre memcached verzije 1.4 ne mo쬰te skladi코titi objekte ve캖e od 1MB zbog podrazumevane maksimalne veli캜ine slota.

### Nikada ne postavljajte vremensko ograni캜enje ve캖e od 30 dana! <a href="#never-set-a-timeout--30-days" id="never-set-a-timeout--30-days"></a>

Ako poku코ate da "postavite" ili "dodate" klju캜 sa vremenskim ograni캜enjem ve캖im od dozvoljenog maksimuma, mo쬯a ne캖ete dobiti o캜ekivani rezultat jer memcached tada tretira vrednost kao Unix vremenski 쬴g. Tako캠e, ako je vremenski 쬴g u pro코losti, ne캖e se desiti ni코ta. Va코a komanda 캖e tiho neuspeti.

Dakle, ako 쬰lite koristiti maksimalno trajanje, specificirajte 2592000. Primer:
```
set my_key 0 2592000 1
1
```
### Nestaju캖i klju캜evi pri prekora캜enju <a href="#disappearing-keys-on-overflow" id="disappearing-keys-on-overflow"></a>

Iako dokumentacija ka쬰 ne코to o prekora캜enju vrednosti od 64 bita pomo캖u "incr" komande, to uzrokuje da vrednost nestane. Potrebno je ponovo je kreirati pomo캖u "add"/"set" komande.

### Repliciranje <a href="#replication" id="replication"></a>

memcached sam po sebi ne podr쬬va repliciranje. Ako vam zaista treba, morate koristiti re코enja tre캖ih strana:

* [repcached](http://repcached.lab.klab.org/): Asinhrono repliciranje vi코e mastera (memcached 1.2 set zakrpa)
* [Couchbase memcached interfejs](http://www.couchbase.com/memcached): Koristite CouchBase kao zamenu za memcached
* [yrmcds](https://cybozu.github.io/yrmcds/): memcached kompatibilno skladi코te klju캜-vrednost master-slave
* [twemproxy](https://github.com/twitter/twemproxy) (poznat i kao nutcracker): proxy sa podr코kom za memcached

### Cheat-Sheet Komande

{% content-ref url="memcache-commands.md" %}
[memcache-commands.md](memcache-commands.md)
{% endcontent-ref %}

### **Shodan**

* `port:11211 "STAT pid"`
* `"STAT pid"`

## Reference

* [https://lzone.de/cheat-sheet/memcached](https://lzone.de/cheat-sheet/memcached)

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
