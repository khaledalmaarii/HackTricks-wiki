# 11211 - Pentesting Memcache

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Protocol Information

From [wikipedia](https://en.wikipedia.org/wiki/Memcached):

> **Memcached** (pronunciaci√≥n: mem-cashed, mem-cash-dee) es un sistema de [cach√© de memoria](https://es.wikipedia.org/wiki/Cach%C3%A9_de_memoria) distribuido de prop√≥sito general. A menudo se utiliza para acelerar sitios web din√°micos impulsados por bases de datos al almacenar en cach√© datos y objetos en RAM para reducir la cantidad de veces que se debe leer una fuente de datos externa (como una base de datos o API).

Aunque Memcached admite SASL, la mayor√≠a de las instancias est√°n **expuestas sin autenticaci√≥n**.

**Puerto por defecto:** 11211
```
PORT      STATE SERVICE
11211/tcp open  unknown
```
## Enumeraci√≥n

### Manual

Para exfiltrar toda la informaci√≥n guardada dentro de una instancia de memcache, necesitas:

1. Encontrar **slabs** con **elementos activos**
2. Obtener los **nombres de las claves** de los slabs detectados anteriormente
3. Exfiltrar los **datos guardados** obteniendo los **nombres de las claves**

Recuerda que este servicio es solo un **cache**, por lo que **los datos pueden aparecer y desaparecer**.
```bash
echo "version" | nc -vn -w 1 <IP> 11211      #Get version
echo "stats" | nc -vn -w 1 <IP> 11211        #Get status
echo "stats slabs" | nc -vn -w 1 <IP> 11211  #Get slabs
echo "stats items" | nc -vn -w 1 <IP> 11211  #Get items of slabs with info
echo "stats cachedump <number> 0" | nc -vn -w 1 <IP> 11211  #Get key names (the 0 is for unlimited output size)
echo "get <item_name>" | nc -vn -w 1 <IP> 11211  #Get saved info

#This php will just dump the keys, you need to use "get <item_name> later"
sudo apt-get install php-memcached
php -r '$c = new Memcached(); $c->addServer("localhost", 11211); var_dump( $c->getAllKeys() );'
```
### Manual2
```bash
sudo apt install libmemcached-tools
memcstat --servers=127.0.0.1 #Get stats
memcdump --servers=127.0.0.1 #Get all items
memccat  --servers=127.0.0.1 <item1> <item2> <item3> #Get info inside the item(s)
```
### Autom√°tico
```bash
nmap -n -sV --script memcached-info -p 11211 <IP>   #Just gather info
msf > use auxiliary/gather/memcached_extractor      #Extracts saved data
msf > use auxiliary/scanner/memcached/memcached_amp #Check is UDP DDoS amplification attack is possible
```
## **Dumping Memcache Keys**

En el √°mbito de memcache, un protocolo que ayuda a organizar datos por slabs, existen comandos espec√≠ficos para inspeccionar los datos almacenados, aunque con notables limitaciones:

1. Las claves solo se pueden volcar por clase de slab, agrupando claves de tama√±o de contenido similar.
2. Existe un l√≠mite de una p√°gina por clase de slab, equivalente a 1MB de datos.
3. Esta funci√≥n es no oficial y puede ser descontinuada en cualquier momento, como se discute en [foros comunitarios](https://groups.google.com/forum/?fromgroups=#!topic/memcached/1-T8I-RVGKM).

La limitaci√≥n de poder volcar solo 1MB de potencialmente gigabytes de datos es particularmente significativa. Sin embargo, esta funcionalidad a√∫n puede ofrecer informaci√≥n sobre los patrones de uso de claves, dependiendo de las necesidades espec√≠ficas. Para aquellos menos interesados en la mec√°nica, una visita a la [secci√≥n de herramientas](https://lzone.de/cheat-sheet/memcached#tools) revela utilidades para un volcado completo. Alternativamente, el proceso de usar telnet para la interacci√≥n directa con configuraciones de memcached se describe a continuaci√≥n.

### **How it Works**

La organizaci√≥n de la memoria de Memcache es fundamental. Iniciar memcache con la opci√≥n "-vv" revela las clases de slab que genera, como se muestra a continuaci√≥n:
```bash
$ memcached -vv
slab class   1: chunk size        96 perslab   10922
[...]
```
Para mostrar todos los slabs existentes actualmente, se utiliza el siguiente comando:
```bash
stats slabs
```
Agregar una sola clave a memcached 1.4.13 ilustra c√≥mo se poblan y gestionan las clases de slab. Por ejemplo:
```bash
set mykey 0 60 1
1
STORED
```
Ejecutar el comando "stats slabs" despu√©s de la adici√≥n de la clave produce estad√≠sticas detalladas sobre la utilizaci√≥n de los slabs:
```bash
stats slabs
[...]
```
Este resultado revela los tipos de slab activos, los chunks utilizados y las estad√≠sticas operativas, ofreciendo informaci√≥n sobre la eficiencia de las operaciones de lectura y escritura.

Otro comando √∫til, "stats items", proporciona datos sobre desalojos, restricciones de memoria y ciclos de vida de los elementos:
```bash
stats items
[...]
```
Estas estad√≠sticas permiten hacer suposiciones fundamentadas sobre el comportamiento de cach√© de la aplicaci√≥n, incluida la eficiencia de la cach√© para diferentes tama√±os de contenido, la asignaci√≥n de memoria y la capacidad para almacenar en cach√© objetos grandes.

### **Volcando Claves**

Para versiones anteriores a 1.4.31, las claves se vierten por clase de slab usando:
```bash
stats cachedump <slab class> <number of items to dump>
```
Por ejemplo, para volcar una clave en la clase #1:
```bash
stats cachedump 1 1000
ITEM mykey [1 b; 1350677968 s]
END
```
Este m√©todo itera sobre las clases de slab, extrayendo y opcionalmente volcando valores clave.

### **VOLCANDO CLAVES DE MEMCACHE (VER 1.4.31+)**

Con la versi√≥n de memcache 1.4.31 y superiores, se introduce un nuevo m√©todo m√°s seguro para volcar claves en un entorno de producci√≥n, utilizando el modo no bloqueante como se detalla en las [notas de la versi√≥n](https://github.com/memcached/memcached/wiki/ReleaseNotes1431). Este enfoque genera una salida extensa, de ah√≠ la recomendaci√≥n de emplear el comando 'nc' para mayor eficiencia. Los ejemplos incluyen:
```bash
echo 'lru_crawler metadump all' | nc 127.0.0.1 11211 | head -1
echo 'lru_crawler metadump all' | nc 127.0.0.1 11211 | grep ee6ba58566e234ccbbce13f9a24f9a28
```
### **HERRAMIENTAS DE DUMPING**

Tabla [desde aqu√≠](https://lzone.de/blog).

| Lenguajes de Programaci√≥n | Herramientas                                                                                                                         | Funcionalidad                                                                                                                                                          |                                                                             |         |
| ------------------------- | ------------------------------------------------------------------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------- | ------- |
| PHP                       | [script simple](http://snipt.org/xtP)                                                                                               | Imprime nombres de claves.                                                                                                                                           |                                                                             |         |
| Perl                      | [script simple](https://wiki.jasig.org/download/attachments/13572172/memcached-clean.pl?version=1\&modificationDate=1229693957401) | Imprime claves y valores                                                                                                                                              |                                                                             |         |
| Ruby                      | [script simple](https://gist.github.com/1365005)                                                                                    | Imprime nombres de claves.                                                                                                                                           |                                                                             |         |
| Perl                      | [memdump](https://search.cpan.org/\~dmaki/Memcached-libmemcached-0.4202/src/libmemcached/docs/memdump.pod)                        | Herramienta en el m√≥dulo CPAN                                                                                                                                       | [Memcached-libmemcached](https://search.cpan.org/\~dmaki/Memcached-libmemc) | ached/) |
| PHP                       | [memcache.php](http://livebookmark.net/journal/2008/05/21/memcachephp-stats-like-apcphp/)                                         | Interfaz gr√°fica de monitoreo de Memcache que tambi√©n permite volcar claves                                                                                          |                                                                             |         |
| libmemcached              | [peep](http://blog.evanweaver.com/2009/04/20/peeping-into-memcached/)                                                             | **¬°Congela tu proceso de memcached!** Ten cuidado al usar esto en producci√≥n. A√∫n as√≠, puedes sortear la limitaci√≥n de 1MB y realmente volcar **todas** las claves. |                                                                             |         |

## Soluci√≥n de Problemas <a href="#troubleshooting" id="troubleshooting"></a>

### L√≠mite de Datos de 1MB <a href="#1mb-data-limit" id="1mb-data-limit"></a>

Ten en cuenta que antes de memcached 1.4 no puedes almacenar objetos m√°s grandes de 1MB debido al tama√±o m√°ximo de slab predeterminado.

### ¬°Nunca Establezcas un Tiempo de Espera > 30 D√≠as! <a href="#never-set-a-timeout--30-days" id="never-set-a-timeout--30-days"></a>

Si intentas ‚Äúestablecer‚Äù o ‚Äúagregar‚Äù una clave con un tiempo de espera mayor que el m√°ximo permitido, es posible que no obtengas lo que esperas porque memcached trata el valor como una marca de tiempo de Unix. Adem√°s, si la marca de tiempo est√° en el pasado, no har√° nada en absoluto. Tu comando fallar√° silenciosamente.

As√≠ que si deseas usar la vida √∫til m√°xima, especifica 2592000. Ejemplo:
```
set my_key 0 2592000 1
1
```
### Claves Desaparecidas en Desbordamiento <a href="#disappearing-keys-on-overflow" id="disappearing-keys-on-overflow"></a>

A pesar de que la documentaci√≥n dice algo sobre que el desbordamiento de un valor de 64 bits usando ‚Äúincr‚Äù hace que el valor desaparezca. Necesita ser creado nuevamente usando ‚Äúadd‚Äù/‚Äùset‚Äù.

### Replicaci√≥n <a href="#replication" id="replication"></a>

memcached no soporta replicaci√≥n. Si realmente lo necesitas, debes usar soluciones de terceros:

* [repcached](http://repcached.lab.klab.org/): Replicaci√≥n as√≠ncrona multi-maestro (conjunto de parches de memcached 1.2)
* [Interfaz memcached de Couchbase](http://www.couchbase.com/memcached): Usa CouchBase como reemplazo de memcached
* [yrmcds](https://cybozu.github.io/yrmcds/): Almacenamiento de clave-valor compatible con memcached Master-Slave
* [twemproxy](https://github.com/twitter/twemproxy) (tambi√©n conocido como nutcracker): proxy con soporte para memcached

### Hoja de Trucos de Comandos

{% content-ref url="memcache-commands.md" %}
[memcache-commands.md](memcache-commands.md)
{% endcontent-ref %}

### **Shodan**

* `port:11211 "STAT pid"`
* `"STAT pid"`

## Referencias

* [https://lzone.de/cheat-sheet/memcached](https://lzone.de/cheat-sheet/memcached)

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**repositorios de HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
