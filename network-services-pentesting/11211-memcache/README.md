# 11211 - Pentesting Memcache

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## åè®®ä¿¡æ¯

æ¥è‡ª [ç»´åŸºç™¾ç§‘](https://en.wikipedia.org/wiki/Memcached):

> **Memcached**ï¼ˆå‘éŸ³ï¼šmem-cashed, mem-cash-deeï¼‰æ˜¯ä¸€ä¸ªé€šç”¨çš„åˆ†å¸ƒå¼ [å†…å­˜ç¼“å­˜](https://en.wikipedia.org/wiki/Memory\_caching) ç³»ç»Ÿã€‚å®ƒé€šå¸¸ç”¨äºé€šè¿‡åœ¨ RAM ä¸­ç¼“å­˜æ•°æ®å’Œå¯¹è±¡æ¥åŠ é€ŸåŠ¨æ€æ•°æ®åº“é©±åŠ¨çš„ç½‘ç«™ï¼Œä»¥å‡å°‘è¯»å–å¤–éƒ¨æ•°æ®æºï¼ˆå¦‚æ•°æ®åº“æˆ– APIï¼‰çš„æ¬¡æ•°ã€‚

å°½ç®¡ Memcached æ”¯æŒ SASLï¼Œä½†å¤§å¤šæ•°å®ä¾‹æ˜¯ **æœªç»è¿‡èº«ä»½éªŒè¯** çš„ã€‚

**é»˜è®¤ç«¯å£ï¼š** 11211
```
PORT      STATE SERVICE
11211/tcp open  unknown
```
## Enumeration

### Manual

è¦æå– memcache å®ä¾‹ä¸­ä¿å­˜çš„æ‰€æœ‰ä¿¡æ¯ï¼Œæ‚¨éœ€è¦ï¼š

1. æ‰¾åˆ° **slabs** ä¸­çš„ **æ´»åŠ¨é¡¹**
2. è·å–ä¹‹å‰æ£€æµ‹åˆ°çš„ slabs çš„ **é”®å**
3. é€šè¿‡ **è·å–é”®å** æ¥æå– **ä¿å­˜çš„æ•°æ®**

è¯·è®°ä½ï¼Œè¿™é¡¹æœåŠ¡åªæ˜¯ä¸€ä¸ª **ç¼“å­˜**ï¼Œå› æ­¤ **æ•°æ®å¯èƒ½ä¼šå‡ºç°å’Œæ¶ˆå¤±**ã€‚
```bash
echo "version" | nc -vn -w 1 <IP> 11211      #Get version
echo "stats" | nc -vn -w 1 <IP> 11211        #Get status
echo "stats slabs" | nc -vn -w 1 <IP> 11211  #Get slabs
echo "stats items" | nc -vn -w 1 <IP> 11211  #Get items of slabs with info
echo "stats cachedump <number> 0" | nc -vn -w 1 <IP> 11211  #Get key names (the 0 is for unlimited output size)
echo "get <item_name>" | nc -vn -w 1 <IP> 11211  #Get saved info

#This php will just dump the keys, you need to use "get <item_name> later"
sudo apt-get install php-memcached
php -r '$c = new Memcached(); $c->addServer("localhost", 11211); var_dump( $c->getAllKeys() );'
```
### æ‰‹åŠ¨2
```bash
sudo apt install libmemcached-tools
memcstat --servers=127.0.0.1 #Get stats
memcdump --servers=127.0.0.1 #Get all items
memccat  --servers=127.0.0.1 <item1> <item2> <item3> #Get info inside the item(s)
```
### è‡ªåŠ¨
```bash
nmap -n -sV --script memcached-info -p 11211 <IP>   #Just gather info
msf > use auxiliary/gather/memcached_extractor      #Extracts saved data
msf > use auxiliary/scanner/memcached/memcached_amp #Check is UDP DDoS amplification attack is possible
```
## **Dumping Memcache Keys**

åœ¨memcacheé¢†åŸŸï¼Œä¸€ä¸ªé€šè¿‡slabå¸®åŠ©ç»„ç»‡æ•°æ®çš„åè®®ï¼Œå­˜åœ¨ç‰¹å®šçš„å‘½ä»¤ç”¨äºæ£€æŸ¥å­˜å‚¨çš„æ•°æ®ï¼Œå°½ç®¡æœ‰æ˜¾è‘—çš„é™åˆ¶ï¼š

1. åªèƒ½æŒ‰slabç±»è½¬å‚¨é”®ï¼Œå°†ç›¸ä¼¼å†…å®¹å¤§å°çš„é”®åˆ†ç»„ã€‚
2. æ¯ä¸ªslabç±»çš„é™åˆ¶ä¸ºä¸€é¡µï¼Œç›¸å½“äº1MBçš„æ•°æ®ã€‚
3. æ­¤åŠŸèƒ½æ˜¯éå®˜æ–¹çš„ï¼Œå¯èƒ½éšæ—¶è¢«å–æ¶ˆï¼Œå¦‚åœ¨[ç¤¾åŒºè®ºå›](https://groups.google.com/forum/?fromgroups=#!topic/memcached/1-T8I-RVGKM)ä¸­è®¨è®ºçš„é‚£æ ·ã€‚

åªèƒ½ä»æ½œåœ¨çš„åƒå…†å­—èŠ‚æ•°æ®ä¸­è½¬å‚¨1MBçš„é™åˆ¶å°¤å…¶æ˜¾è‘—ã€‚ç„¶è€Œï¼Œè¿™ä¸€åŠŸèƒ½ä»ç„¶å¯ä»¥æ ¹æ®ç‰¹å®šéœ€æ±‚æä¾›å¯¹é”®ä½¿ç”¨æ¨¡å¼çš„æ´å¯Ÿã€‚å¯¹äºé‚£äº›å¯¹æœºåˆ¶ä¸å¤ªæ„Ÿå…´è¶£çš„äººï¼Œå¯ä»¥è®¿é—®[å·¥å…·éƒ¨åˆ†](https://lzone.de/cheat-sheet/memcached#tools)ï¼ŒæŸ¥çœ‹å…¨é¢è½¬å‚¨çš„å®ç”¨å·¥å…·ã€‚æˆ–è€…ï¼Œä¸‹é¢æ¦‚è¿°äº†ä½¿ç”¨telnetä¸memcachedè®¾ç½®è¿›è¡Œç›´æ¥äº¤äº’çš„è¿‡ç¨‹ã€‚

### **How it Works**

Memcacheçš„å†…å­˜ç»„ç»‡è‡³å…³é‡è¦ã€‚ä½¿ç”¨"-vv"é€‰é¡¹å¯åŠ¨memcacheå¯ä»¥æ˜¾ç¤ºå®ƒç”Ÿæˆçš„slabç±»ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
```bash
$ memcached -vv
slab class   1: chunk size        96 perslab   10922
[...]
```
è¦æ˜¾ç¤ºæ‰€æœ‰å½“å‰å­˜åœ¨çš„ slabsï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š
```bash
stats slabs
```
æ·»åŠ å•ä¸ªé”®åˆ° memcached 1.4.13 æ¼”ç¤ºäº†å¦‚ä½•å¡«å……å’Œç®¡ç† slab ç±»ã€‚ä¾‹å¦‚ï¼š
```bash
set mykey 0 60 1
1
STORED
```
æ‰§è¡Œâ€œstats slabsâ€å‘½ä»¤åæ·»åŠ é”®ä¼šäº§ç”Ÿå…³äº slab åˆ©ç”¨ç‡çš„è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯ï¼š
```bash
stats slabs
[...]
```
æ­¤è¾“å‡ºæ˜¾ç¤ºäº†æ´»åŠ¨çš„ slab ç±»å‹ã€ä½¿ç”¨çš„å—å’Œæ“ä½œç»Ÿè®¡ä¿¡æ¯ï¼Œæä¾›äº†æœ‰å…³è¯»å†™æ“ä½œæ•ˆç‡çš„è§è§£ã€‚

å¦ä¸€ä¸ªæœ‰ç”¨çš„å‘½ä»¤ "stats items" æä¾›äº†å…³äºé©±é€ã€å†…å­˜é™åˆ¶å’Œé¡¹ç›®ç”Ÿå‘½å‘¨æœŸçš„æ•°æ®ï¼š
```bash
stats items
[...]
```
è¿™äº›ç»Ÿè®¡æ•°æ®å…è®¸å¯¹åº”ç”¨ç¨‹åºç¼“å­˜è¡Œä¸ºè¿›è¡Œæœ‰æ ¹æ®çš„å‡è®¾ï¼ŒåŒ…æ‹¬ä¸åŒå†…å®¹å¤§å°çš„ç¼“å­˜æ•ˆç‡ã€å†…å­˜åˆ†é…å’Œç¼“å­˜å¤§å¯¹è±¡çš„èƒ½åŠ›ã€‚

### **è½¬å‚¨é”®**

å¯¹äº1.4.31ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œé”®æ˜¯é€šè¿‡ slab ç±»è½¬å‚¨çš„ï¼Œä½¿ç”¨ï¼š
```bash
stats cachedump <slab class> <number of items to dump>
```
ä¾‹å¦‚ï¼Œè¦è½¬å‚¨ç±» #1 ä¸­çš„ä¸€ä¸ªé”®ï¼š
```bash
stats cachedump 1 1000
ITEM mykey [1 b; 1350677968 s]
END
```
æ­¤æ–¹æ³•éå† slab ç±»ï¼Œæå–å¹¶å¯é€‰åœ°è½¬å‚¨é”®å€¼ã€‚

### **è½¬å‚¨ MEMCACHE é”® (VER 1.4.31+)**

åœ¨ memcache ç‰ˆæœ¬ 1.4.31 åŠä»¥ä¸Šï¼Œå¼•å…¥äº†ä¸€ç§æ–°çš„ã€æ›´å®‰å…¨çš„æ–¹æ³•æ¥åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è½¬å‚¨é”®ï¼Œåˆ©ç”¨éé˜»å¡æ¨¡å¼ï¼Œå¦‚ [å‘å¸ƒè¯´æ˜](https://github.com/memcached/memcached/wiki/ReleaseNotes1431) ä¸­è¯¦ç»†è¯´æ˜ã€‚è¿™ç§æ–¹æ³•ç”Ÿæˆå¤§é‡è¾“å‡ºï¼Œå› æ­¤å»ºè®®ä½¿ç”¨ 'nc' å‘½ä»¤ä»¥æé«˜æ•ˆç‡ã€‚ç¤ºä¾‹åŒ…æ‹¬ï¼š
```bash
echo 'lru_crawler metadump all' | nc 127.0.0.1 11211 | head -1
echo 'lru_crawler metadump all' | nc 127.0.0.1 11211 | grep ee6ba58566e234ccbbce13f9a24f9a28
```
### **DUMPING TOOLS**

Table [from here](https://lzone.de/blog).

| Programming Languages | Tools                                                                                                                              | Functionality                                                                                                                                                          |                                                                             |         |
| --------------------- | ---------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------- | ------- |
| PHP                   | [simple script](http://snipt.org/xtP)                                                                                              | æ‰“å°é”®åã€‚                                                                                                                                                             |                                                                             |         |
| Perl                  | [simple script](https://wiki.jasig.org/download/attachments/13572172/memcached-clean.pl?version=1\&modificationDate=1229693957401) | æ‰“å°é”®å’Œå€¼                                                                                                                                                           |                                                                             |         |
| Ruby                  | [simple script](https://gist.github.com/1365005)                                                                                   | æ‰“å°é”®åã€‚                                                                                                                                                             |                                                                             |         |
| Perl                  | [memdump](https://search.cpan.org/\~dmaki/Memcached-libmemcached-0.4202/src/libmemcached/docs/memdump.pod)                         | CPANæ¨¡å—ä¸­çš„å·¥å…·                                                                                                                                                     | [Memcached-libmemcached](https://search.cpan.org/\~dmaki/Memcached-libmemc) | ached/) |
| PHP                   | [memcache.php](http://livebookmark.net/journal/2008/05/21/memcachephp-stats-like-apcphp/)                                          | Memcacheç›‘æ§GUIï¼Œä¹Ÿå…è®¸è½¬å‚¨é”®                                                                                                                                      |                                                                             |         |
| libmemcached          | [peep](http://blog.evanweaver.com/2009/04/20/peeping-into-memcached/)                                                              | **ä¼šå†»ç»“ä½ çš„memcachedè¿›ç¨‹!!!** ä½¿ç”¨æ—¶è¯·å°å¿ƒã€‚å¦‚æœä»ç„¶ä½¿ç”¨å®ƒï¼Œä½ å¯ä»¥ç»•è¿‡1MBé™åˆ¶ï¼ŒçœŸæ­£è½¬å‚¨**æ‰€æœ‰**é”®ã€‚                                                               |                                                                             |         |

## Troubleshooting <a href="#troubleshooting" id="troubleshooting"></a>

### 1MB Data Limit <a href="#1mb-data-limit" id="1mb-data-limit"></a>

è¯·æ³¨æ„ï¼Œåœ¨memcached 1.4ä¹‹å‰ï¼Œæ‚¨æ— æ³•å­˜å‚¨å¤§äº1MBçš„å¯¹è±¡ï¼Œå› ä¸ºé»˜è®¤çš„æœ€å¤§å—å¤§å°ã€‚

### Never Set a Timeout > 30 Days! <a href="#never-set-a-timeout--30-days" id="never-set-a-timeout--30-days"></a>

å¦‚æœæ‚¨å°è¯•â€œè®¾ç½®â€æˆ–â€œæ·»åŠ â€ä¸€ä¸ªè¶…æ—¶å¤§äºå…è®¸çš„æœ€å¤§å€¼çš„é”®ï¼Œæ‚¨å¯èƒ½ä¸ä¼šå¾—åˆ°é¢„æœŸçš„ç»“æœï¼Œå› ä¸ºmemcachedä¼šå°†è¯¥å€¼è§†ä¸ºUnixæ—¶é—´æˆ³ã€‚å¦‚æœæ—¶é—´æˆ³åœ¨è¿‡å»ï¼Œå®ƒå°†å®Œå…¨ä¸æ‰§è¡Œä»»ä½•æ“ä½œã€‚æ‚¨çš„å‘½ä»¤å°†é™é»˜å¤±è´¥ã€‚

å› æ­¤ï¼Œå¦‚æœæ‚¨æƒ³ä½¿ç”¨æœ€å¤§ç”Ÿå‘½å‘¨æœŸï¼Œè¯·æŒ‡å®š2592000ã€‚ç¤ºä¾‹ï¼š
```
set my_key 0 2592000 1
1
```
### æ¶ˆå¤±çš„é”®åœ¨æº¢å‡ºæ—¶ <a href="#disappearing-keys-on-overflow" id="disappearing-keys-on-overflow"></a>

å°½ç®¡æ–‡æ¡£æåˆ°ä½¿ç”¨â€œincrâ€å¯¼è‡´64ä½æº¢å‡ºå€¼çš„æƒ…å†µä¼šä½¿å€¼æ¶ˆå¤±ï¼Œä½†éœ€è¦ä½¿ç”¨â€œaddâ€/â€œsetâ€é‡æ–°åˆ›å»ºã€‚

### å¤åˆ¶ <a href="#replication" id="replication"></a>

memcachedæœ¬èº«ä¸æ”¯æŒå¤åˆ¶ã€‚å¦‚æœä½ çœŸçš„éœ€è¦å®ƒï¼Œä½ éœ€è¦ä½¿ç”¨ç¬¬ä¸‰æ–¹è§£å†³æ–¹æ¡ˆï¼š

* [repcached](http://repcached.lab.klab.org/): å¤šä¸»å¼‚æ­¥å¤åˆ¶ï¼ˆmemcached 1.2è¡¥ä¸é›†ï¼‰
* [Couchbase memcachedæ¥å£](http://www.couchbase.com/memcached): ä½¿ç”¨CouchBaseä½œä¸ºmemcachedçš„æ›¿ä»£
* [yrmcds](https://cybozu.github.io/yrmcds/): ä¸memcachedå…¼å®¹çš„ä¸»ä»é”®å€¼å­˜å‚¨
* [twemproxy](https://github.com/twitter/twemproxy)ï¼ˆåˆånutcrackerï¼‰ï¼šæ”¯æŒmemcachedçš„ä»£ç†

### å‘½ä»¤é€ŸæŸ¥è¡¨

{% content-ref url="memcache-commands.md" %}
[memcache-commands.md](memcache-commands.md)
{% endcontent-ref %}

### **Shodan**

* `port:11211 "STAT pid"`
* `"STAT pid"`

## å‚è€ƒæ–‡çŒ®

* [https://lzone.de/cheat-sheet/memcached](https://lzone.de/cheat-sheet/memcached)

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µAWSé»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricksåŸ¹è®­AWSçº¢é˜Ÿä¸“å®¶ï¼ˆARTEï¼‰**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µGCPé»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricksåŸ¹è®­GCPçº¢é˜Ÿä¸“å®¶ï¼ˆGRTEï¼‰**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)æˆ–**åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHubåº“æäº¤PRåˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
