# 11211 - Pentesting Memcache

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Informa√ß√µes do Protocolo

De [wikipedia](https://en.wikipedia.org/wiki/Memcached):

> **Memcached** (pron√∫ncia: mem-cashed, mem-cash-dee) √© um sistema de [cache de mem√≥ria](https://en.wikipedia.org/wiki/Memory\_caching) distribu√≠do de prop√≥sito geral. √â frequentemente usado para acelerar sites din√¢micos baseados em banco de dados, armazenando em cache dados e objetos na RAM para reduzir o n√∫mero de vezes que uma fonte de dados externa (como um banco de dados ou API) deve ser lida.

Embora o Memcached suporte SASL, a maioria das inst√¢ncias est√° **exposta sem autentica√ß√£o**.

**Porta padr√£o:** 11211
```
PORT      STATE SERVICE
11211/tcp open  unknown
```
## Enumera√ß√£o

### Manual

Para exfiltrar todas as informa√ß√µes salvas dentro de uma inst√¢ncia de memcache, voc√™ precisa:

1. Encontrar **slabs** com **itens ativos**
2. Obter os **nomes das chaves** dos slabs detectados anteriormente
3. Exfiltrar os **dados salvos** obtendo os **nomes das chaves**

Lembre-se de que este servi√ßo √© apenas um **cache**, ent√£o **os dados podem estar aparecendo e desaparecendo**.
```bash
echo "version" | nc -vn -w 1 <IP> 11211      #Get version
echo "stats" | nc -vn -w 1 <IP> 11211        #Get status
echo "stats slabs" | nc -vn -w 1 <IP> 11211  #Get slabs
echo "stats items" | nc -vn -w 1 <IP> 11211  #Get items of slabs with info
echo "stats cachedump <number> 0" | nc -vn -w 1 <IP> 11211  #Get key names (the 0 is for unlimited output size)
echo "get <item_name>" | nc -vn -w 1 <IP> 11211  #Get saved info

#This php will just dump the keys, you need to use "get <item_name> later"
sudo apt-get install php-memcached
php -r '$c = new Memcached(); $c->addServer("localhost", 11211); var_dump( $c->getAllKeys() );'
```
### Manual2
```bash
sudo apt install libmemcached-tools
memcstat --servers=127.0.0.1 #Get stats
memcdump --servers=127.0.0.1 #Get all items
memccat  --servers=127.0.0.1 <item1> <item2> <item3> #Get info inside the item(s)
```
### Autom√°tico
```bash
nmap -n -sV --script memcached-info -p 11211 <IP>   #Just gather info
msf > use auxiliary/gather/memcached_extractor      #Extracts saved data
msf > use auxiliary/scanner/memcached/memcached_amp #Check is UDP DDoS amplification attack is possible
```
## **Dumpando Chaves do Memcache**

No √¢mbito do memcache, um protocolo que ajuda a organizar dados por slabs, existem comandos espec√≠ficos para inspecionar os dados armazenados, embora com restri√ß√µes not√°veis:

1. As chaves s√≥ podem ser dumpadas por classe de slab, agrupando chaves de tamanho de conte√∫do semelhante.
2. Existe um limite de uma p√°gina por classe de slab, equivalente a 1MB de dados.
3. Este recurso √© n√£o oficial e pode ser descontinuado a qualquer momento, conforme discutido em [f√≥runs da comunidade](https://groups.google.com/forum/?fromgroups=#!topic/memcached/1-T8I-RVGKM).

A limita√ß√£o de poder dump apenas 1MB de dados que podem ser gigabytes √© particularmente significativa. No entanto, essa funcionalidade ainda pode oferecer insights sobre padr√µes de uso de chaves, dependendo das necessidades espec√≠ficas. Para aqueles menos interessados na mec√¢nica, uma visita √† [se√ß√£o de ferramentas](https://lzone.de/cheat-sheet/memcached#tools) revela utilit√°rios para dump abrangente. Alternativamente, o processo de usar telnet para intera√ß√£o direta com configura√ß√µes do memcached √© descrito abaixo.

### **Como Funciona**

A organiza√ß√£o da mem√≥ria do memcache √© fundamental. Iniciar o memcache com a op√ß√£o "-vv" revela as classes de slab que ele gera, como mostrado abaixo:
```bash
$ memcached -vv
slab class   1: chunk size        96 perslab   10922
[...]
```
Para exibir todos os slabs existentes atualmente, o seguinte comando √© usado:
```bash
stats slabs
```
Adicionar uma √∫nica chave ao memcached 1.4.13 ilustra como as classes de slab s√£o populadas e gerenciadas. Por exemplo:
```bash
set mykey 0 60 1
1
STORED
```
Executar o comando "stats slabs" ap√≥s a adi√ß√£o da chave gera estat√≠sticas detalhadas sobre a utiliza√ß√£o do slab:
```bash
stats slabs
[...]
```
Esta sa√≠da revela os tipos de slab ativos, os chunks utilizados e as estat√≠sticas operacionais, oferecendo insights sobre a efici√™ncia das opera√ß√µes de leitura e grava√ß√£o.

Outro comando √∫til, "stats items", fornece dados sobre despejos, restri√ß√µes de mem√≥ria e ciclos de vida dos itens:
```bash
stats items
[...]
```
Essas estat√≠sticas permitem suposi√ß√µes fundamentadas sobre o comportamento de cache da aplica√ß√£o, incluindo a efici√™ncia do cache para diferentes tamanhos de conte√∫do, aloca√ß√£o de mem√≥ria e capacidade para armazenar grandes objetos.

### **Dumping Keys**

Para vers√µes anteriores a 1.4.31, as chaves s√£o despejadas por classe de slab usando:
```bash
stats cachedump <slab class> <number of items to dump>
```
Por exemplo, para despejar uma chave na classe #1:
```bash
stats cachedump 1 1000
ITEM mykey [1 b; 1350677968 s]
END
```
Este m√©todo itera sobre classes de slab, extraindo e, opcionalmente, despejando valores de chave.

### **DESPEJANDO CHAVES DO MEMCACHE (VER 1.4.31+)**

Com a vers√£o 1.4.31 do memcache e acima, um novo m√©todo mais seguro para despejar chaves em um ambiente de produ√ß√£o √© introduzido, utilizando o modo n√£o bloqueante, conforme detalhado nas [notas de lan√ßamento](https://github.com/memcached/memcached/wiki/ReleaseNotes1431). Esta abordagem gera uma sa√≠da extensa, portanto, a recomenda√ß√£o √© empregar o comando 'nc' para efici√™ncia. Exemplos incluem:
```bash
echo 'lru_crawler metadump all' | nc 127.0.0.1 11211 | head -1
echo 'lru_crawler metadump all' | nc 127.0.0.1 11211 | grep ee6ba58566e234ccbbce13f9a24f9a28
```
### **DUMPING TOOLS**

Table [from here](https://lzone.de/blog).

| Linguagens de Programa√ß√£o | Ferramentas                                                                                                                         | Funcionalidade                                                                                                                                                          |                                                                             |         |
| ------------------------- | ----------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------- | ------- |
| PHP                       | [simple script](http://snipt.org/xtP)                                                                                               | Imprime nomes de chaves.                                                                                                                                              |                                                                             |         |
| Perl                      | [simple script](https://wiki.jasig.org/download/attachments/13572172/memcached-clean.pl?version=1\&modificationDate=1229693957401) | Imprime chaves e valores                                                                                                                                              |                                                                             |         |
| Ruby                      | [simple script](https://gist.github.com/1365005)                                                                                    | Imprime nomes de chaves.                                                                                                                                              |                                                                             |         |
| Perl                      | [memdump](https://search.cpan.org/\~dmaki/Memcached-libmemcached-0.4202/src/libmemcached/docs/memdump.pod)                        | Ferramenta no m√≥dulo CPAN                                                                                                                                             | [Memcached-libmemcached](https://search.cpan.org/\~dmaki/Memcached-libmemc) | ached/) |
| PHP                       | [memcache.php](http://livebookmark.net/journal/2008/05/21/memcachephp-stats-like-apcphp/)                                         | GUI de Monitoramento do Memcache que tamb√©m permite despejar chaves                                                                                                   |                                                                             |         |
| libmemcached              | [peep](http://blog.evanweaver.com/2009/04/20/peeping-into-memcached/)                                                             | **Congela seu processo memcached!!!** Tenha cuidado ao usar isso em produ√ß√£o. Ainda assim, voc√™ pode contornar a limita√ß√£o de 1MB e realmente despejar **todas** as chaves. |                                                                             |         |

## Troubleshooting <a href="#troubleshooting" id="troubleshooting"></a>

### Limite de Dados de 1MB <a href="#1mb-data-limit" id="1mb-data-limit"></a>

Observe que antes do memcached 1.4 voc√™ n√£o pode armazenar objetos maiores que 1MB devido ao tamanho m√°ximo de slab padr√£o.

### Nunca Defina um Timeout > 30 Dias! <a href="#never-set-a-timeout--30-days" id="never-set-a-timeout--30-days"></a>

Se voc√™ tentar ‚Äúdefinir‚Äù ou ‚Äúadicionar‚Äù uma chave com um timeout maior que o m√°ximo permitido, pode n√£o obter o que espera, pois o memcached trata o valor como um timestamp Unix. Al√©m disso, se o timestamp estiver no passado, n√£o far√° nada. Seu comando falhar√° silenciosamente.

Portanto, se voc√™ quiser usar a vida √∫til m√°xima, especifique 2592000. Exemplo:
```
set my_key 0 2592000 1
1
```
### Disappearing Keys on Overflow <a href="#disappearing-keys-on-overflow" id="disappearing-keys-on-overflow"></a>

Apesar da documenta√ß√£o dizer algo sobre o estouro de um valor de 64 bits usando ‚Äúincr‚Äù fazer o valor desaparecer. Ele precisa ser criado novamente usando ‚Äúadd‚Äù/‚Äùset‚Äù.

### Replication <a href="#replication" id="replication"></a>

memcached em si n√£o suporta replica√ß√£o. Se voc√™ realmente precisar, precisar√° usar solu√ß√µes de terceiros:

* [repcached](http://repcached.lab.klab.org/): Replica√ß√£o ass√≠ncrona multi-mestre (conjunto de patches do memcached 1.2)
* [Couchbase memcached interface](http://www.couchbase.com/memcached): Use CouchBase como substituto do memcached
* [yrmcds](https://cybozu.github.io/yrmcds/): Armazenamento de chave-valor compat√≠vel com memcached Master-Slave
* [twemproxy](https://github.com/twitter/twemproxy) (tamb√©m conhecido como nutcracker): proxy com suporte a memcached

### Commands Cheat-Sheet

{% content-ref url="memcache-commands.md" %}
[memcache-commands.md](memcache-commands.md)
{% endcontent-ref %}

### **Shodan**

* `port:11211 "STAT pid"`
* `"STAT pid"`

## References

* [https://lzone.de/cheat-sheet/memcached](https://lzone.de/cheat-sheet/memcached)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
