# 11211 - Pentesting Memcache

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}

## Protokollinformationen

Von [wikipedia](https://en.wikipedia.org/wiki/Memcached):

> **Memcached** (Aussprache: mem-cashed, mem-cash-dee) ist ein allgemeines verteiltes [Speichercaching](https://en.wikipedia.org/wiki/Memory\_caching) System. Es wird h√§ufig verwendet, um dynamische, datenbankgest√ºtzte Websites zu beschleunigen, indem Daten und Objekte im RAM zwischengespeichert werden, um die Anzahl der Lesevorg√§nge einer externen Datenquelle (wie einer Datenbank oder API) zu reduzieren.

Obwohl Memcached SASL unterst√ºtzt, sind die meisten Instanzen **ohne Authentifizierung exponiert**.

**Standardport:** 11211
```
PORT      STATE SERVICE
11211/tcp open  unknown
```
## Enumeration

### Manual

Um alle Informationen, die in einer Memcache-Instanz gespeichert sind, zu exfiltrieren, m√ºssen Sie:

1. **Slabs** mit **aktiven Elementen** finden
2. Die **Schl√ºsselnamen** der zuvor erkannten Slabs abrufen
3. Die **gespeicherten Daten** durch **Abrufen der Schl√ºsselnamen** exfiltrieren

Denken Sie daran, dass dieser Dienst nur ein **Cache** ist, sodass **Daten erscheinen und verschwinden k√∂nnen**.
```bash
echo "version" | nc -vn -w 1 <IP> 11211      #Get version
echo "stats" | nc -vn -w 1 <IP> 11211        #Get status
echo "stats slabs" | nc -vn -w 1 <IP> 11211  #Get slabs
echo "stats items" | nc -vn -w 1 <IP> 11211  #Get items of slabs with info
echo "stats cachedump <number> 0" | nc -vn -w 1 <IP> 11211  #Get key names (the 0 is for unlimited output size)
echo "get <item_name>" | nc -vn -w 1 <IP> 11211  #Get saved info

#This php will just dump the keys, you need to use "get <item_name> later"
sudo apt-get install php-memcached
php -r '$c = new Memcached(); $c->addServer("localhost", 11211); var_dump( $c->getAllKeys() );'
```
### Manual2
```bash
sudo apt install libmemcached-tools
memcstat --servers=127.0.0.1 #Get stats
memcdump --servers=127.0.0.1 #Get all items
memccat  --servers=127.0.0.1 <item1> <item2> <item3> #Get info inside the item(s)
```
### Automatisch
```bash
nmap -n -sV --script memcached-info -p 11211 <IP>   #Just gather info
msf > use auxiliary/gather/memcached_extractor      #Extracts saved data
msf > use auxiliary/scanner/memcached/memcached_amp #Check is UDP DDoS amplification attack is possible
```
## **Dumping Memcache Keys**

Im Bereich von memcache, einem Protokoll, das bei der Organisation von Daten durch Slabs hilft, gibt es spezifische Befehle zur Inspektion der gespeicherten Daten, jedoch mit bemerkenswerten Einschr√§nkungen:

1. Schl√ºssel k√∂nnen nur nach Slab-Klasse ausgegeben werden, wobei Schl√ºssel √§hnlicher Inhaltsgr√∂√üe gruppiert werden.
2. Es gibt eine Begrenzung von einer Seite pro Slab-Klasse, was 1 MB Daten entspricht.
3. Diese Funktion ist inoffiziell und kann jederzeit eingestellt werden, wie in [Community-Foren](https://groups.google.com/forum/?fromgroups=#!topic/memcached/1-T8I-RVGKM) besprochen.

Die Einschr√§nkung, nur 1 MB aus potenziell Gigabytes an Daten ausgeben zu k√∂nnen, ist besonders signifikant. Diese Funktionalit√§t kann jedoch dennoch Einblicke in die Nutzungsmuster der Schl√ºssel bieten, abh√§ngig von den spezifischen Bed√ºrfnissen. F√ºr diejenigen, die weniger an den Mechaniken interessiert sind, zeigt ein Besuch im [Tools-Bereich](https://lzone.de/cheat-sheet/memcached#tools) Hilfsmittel f√ºr umfassende Dumps. Alternativ wird der Prozess der Verwendung von telnet f√ºr die direkte Interaktion mit memcached-Setups im Folgenden beschrieben.

### **How it Works**

Die Speicherorganisation von Memcache ist entscheidend. Das Starten von memcache mit der Option "-vv" zeigt die Slab-Klassen, die es generiert, wie unten dargestellt:
```bash
$ memcached -vv
slab class   1: chunk size        96 perslab   10922
[...]
```
Um alle derzeit vorhandenen Slabs anzuzeigen, wird der folgende Befehl verwendet:
```bash
stats slabs
```
Hinzuf√ºgen eines einzelnen Schl√ºssels zu memcached 1.4.13 veranschaulicht, wie Slab-Klassen bef√ºllt und verwaltet werden. Zum Beispiel:
```bash
set mykey 0 60 1
1
STORED
```
Die Ausf√ºhrung des Befehls "stats slabs" nach der Schl√ºsseladdition liefert detaillierte Statistiken √ºber die Slab-Nutzung:
```bash
stats slabs
[...]
```
Dieser Output zeigt die aktiven Slab-Typen, genutzten Chunks und Betriebsstatistiken und bietet Einblicke in die Effizienz von Lese- und Schreiboperationen.

Ein weiterer n√ºtzlicher Befehl, "stats items", liefert Daten zu Eviktionen, Speicherbeschr√§nkungen und Lebenszyklen von Elementen:
```bash
stats items
[...]
```
Diese Statistiken erm√∂glichen fundierte Annahmen √ºber das Caching-Verhalten von Anwendungen, einschlie√ülich der Cache-Effizienz f√ºr verschiedene Inhaltsgr√∂√üen, der Speicherzuweisung und der Kapazit√§t zum Caching gro√üer Objekte.

### **Dumping Keys**

F√ºr Versionen vor 1.4.31 werden die Schl√ºssel nach Slab-Klasse mit folgendem Befehl ausgegeben:
```bash
stats cachedump <slab class> <number of items to dump>
```
Zum Beispiel, um einen Schl√ºssel in Klasse #1 zu dumpen:
```bash
stats cachedump 1 1000
ITEM mykey [1 b; 1350677968 s]
END
```
Diese Methode iteriert √ºber Slab-Klassen, extrahiert und optional Schl√ºsselwerte.

### **DUMPING MEMCACHE KEYS (VER 1.4.31+)**

Mit der memcache-Version 1.4.31 und h√∂her wird eine neue, sicherere Methode zum Dumpen von Schl√ºsseln in einer Produktionsumgebung eingef√ºhrt, die den nicht-blockierenden Modus nutzt, wie in den [Release-Notizen](https://github.com/memcached/memcached/wiki/ReleaseNotes1431) beschrieben. Dieser Ansatz erzeugt umfangreiche Ausgaben, daher wird empfohlen, den Befehl 'nc' zur Effizienz zu verwenden. Beispiele sind:
```bash
echo 'lru_crawler metadump all' | nc 127.0.0.1 11211 | head -1
echo 'lru_crawler metadump all' | nc 127.0.0.1 11211 | grep ee6ba58566e234ccbbce13f9a24f9a28
```
### **DUMPING TOOLS**

Table [from here](https://lzone.de/blog).

| Programmier¬≠sprachen | Werkzeuge                                                                                                                            | Funktionalit√§t                                                                                                                                                          |                                                                             |         |
| --------------------- | ------------------------------------------------------------------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------- | ------- |
| PHP                   | [einfaches Skript](http://snipt.org/xtP)                                                                                            | Gibt Schl√ºsselnamen aus.                                                                                                                                              |                                                                             |         |
| Perl                  | [einfaches Skript](https://wiki.jasig.org/download/attachments/13572172/memcached-clean.pl?version=1\&modificationDate=1229693957401) | Gibt Schl√ºssel und Werte aus                                                                                                                                         |                                                                             |         |
| Ruby                  | [einfaches Skript](https://gist.github.com/1365005)                                                                                 | Gibt Schl√ºsselnamen aus.                                                                                                                                              |                                                                             |         |
| Perl                  | [memdump](https://search.cpan.org/\~dmaki/Memcached-libmemcached-0.4202/src/libmemcached/docs/memdump.pod)                         | Tool im CPAN-Modul                                                                                                                                                    | [Memcached-libmemcached](https://search.cpan.org/\~dmaki/Memcached-libmemc) | ached/) |
| PHP                   | [memcache.php](http://livebookmark.net/journal/2008/05/21/memcachephp-stats-like-apcphp/)                                          | Memcache √úberwachungs-GUI, die auch das Dumpen von Schl√ºsseln erm√∂glicht                                                                                                |                                                                             |         |
| libmemcached          | [peep](http://blog.evanweaver.com/2009/04/20/peeping-into-memcached/)                                                              | **Friert Ihren Memcached-Prozess ein!!!** Seien Sie vorsichtig, wenn Sie dies in der Produktion verwenden. Dennoch k√∂nnen Sie damit die 1MB-Beschr√§nkung umgehen und wirklich **alle** Schl√ºssel dumpen. |                                                                             |         |

## Fehlerbehebung <a href="#troubleshooting" id="troubleshooting"></a>

### 1MB Datenlimit <a href="#1mb-data-limit" id="1mb-data-limit"></a>

Beachten Sie, dass vor memcached 1.4 Objekte, die gr√∂√üer als 1MB sind, aufgrund der standardm√§√üigen maximalen Slab-Gr√∂√üe nicht gespeichert werden k√∂nnen.

### Setzen Sie niemals ein Timeout > 30 Tage! <a href="#never-set-a-timeout--30-days" id="never-set-a-timeout--30-days"></a>

Wenn Sie versuchen, einen Schl√ºssel mit einem Timeout gr√∂√üer als das erlaubte Maximum zu ‚Äûsetzen‚Äú oder ‚Äûhinzuzuf√ºgen‚Äú, erhalten Sie m√∂glicherweise nicht das, was Sie erwarten, da memcached den Wert dann als Unix-Zeitstempel behandelt. Wenn der Zeitstempel auch in der Vergangenheit liegt, wird √ºberhaupt nichts getan. Ihr Befehl schl√§gt stillschweigend fehl.

Wenn Sie also die maximale Lebensdauer verwenden m√∂chten, geben Sie 2592000 an. Beispiel:
```
set my_key 0 2592000 1
1
```
### Verschwundene Schl√ºssel bei √úberlauf <a href="#disappearing-keys-on-overflow" id="disappearing-keys-on-overflow"></a>

Trotz der Dokumentation, die etwas √ºber das √úberlaufen eines Wertes mit 64 Bit sagt, f√ºhrt die Verwendung von ‚Äûincr‚Äú dazu, dass der Wert verschwindet. Er muss erneut mit ‚Äûadd‚Äú/‚Äûset‚Äú erstellt werden.

### Replikation <a href="#replication" id="replication"></a>

memcached selbst unterst√ºtzt keine Replikation. Wenn Sie es wirklich ben√∂tigen, m√ºssen Sie Drittanbieter-L√∂sungen verwenden:

* [repcached](http://repcached.lab.klab.org/): Multi-Master asynchrone Replikation (memcached 1.2 Patch-Set)
* [Couchbase memcached-Schnittstelle](http://www.couchbase.com/memcached): Verwenden Sie CouchBase als memcached Drop-in
* [yrmcds](https://cybozu.github.io/yrmcds/): memcached-kompatibler Master-Slave Key-Value-Speicher
* [twemproxy](https://github.com/twitter/twemproxy) (auch bekannt als nutcracker): Proxy mit memcached-Unterst√ºtzung

### Befehle Cheat-Sheet

{% content-ref url="memcache-commands.md" %}
[memcache-commands.md](memcache-commands.md)
{% endcontent-ref %}

### **Shodan**

* `port:11211 "STAT pid"`
* `"STAT pid"`

## Referenzen

* [https://lzone.de/cheat-sheet/memcached](https://lzone.de/cheat-sheet/memcached)

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
