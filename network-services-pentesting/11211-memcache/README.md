# 11211 - Pentesting Memcache

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Informacje o protokole

Z [wikipedia](https://en.wikipedia.org/wiki/Memcached):

> **Memcached** (wymowa: mem-cashed, mem-cash-dee) to ogÃ³lny system rozproszonego [cache'owania pamiÄ™ci](https://en.wikipedia.org/wiki/Memory\_caching). CzÄ™sto jest uÅ¼ywany do przyspieszania dynamicznych stron internetowych opartych na bazach danych poprzez cache'owanie danych i obiektÃ³w w RAM, aby zmniejszyÄ‡ liczbÄ™ odczytÃ³w z zewnÄ™trznego ÅºrÃ³dÅ‚a danych (takiego jak baza danych lub API).

ChociaÅ¼ Memcached obsÅ‚uguje SASL, wiÄ™kszoÅ›Ä‡ instancji jest **naraÅ¼ona bez uwierzytelnienia**.

**DomyÅ›lny port:** 11211
```
PORT      STATE SERVICE
11211/tcp open  unknown
```
## Enumeration

### Manual

Aby wyeksportowaÄ‡ wszystkie informacje zapisane w instancji memcache, musisz:

1. ZnaleÅºÄ‡ **slabs** z **aktywnymi elementami**
2. UzyskaÄ‡ **nazwy kluczy** z wczeÅ›niej wykrytych slabs
3. WyeksportowaÄ‡ **zapisane dane** poprzez **uzyskanie nazw kluczy**

PamiÄ™taj, Å¼e ta usÅ‚uga to tylko **cache**, wiÄ™c **dane mogÄ… siÄ™ pojawiaÄ‡ i znikaÄ‡**.
```bash
echo "version" | nc -vn -w 1 <IP> 11211      #Get version
echo "stats" | nc -vn -w 1 <IP> 11211        #Get status
echo "stats slabs" | nc -vn -w 1 <IP> 11211  #Get slabs
echo "stats items" | nc -vn -w 1 <IP> 11211  #Get items of slabs with info
echo "stats cachedump <number> 0" | nc -vn -w 1 <IP> 11211  #Get key names (the 0 is for unlimited output size)
echo "get <item_name>" | nc -vn -w 1 <IP> 11211  #Get saved info

#This php will just dump the keys, you need to use "get <item_name> later"
sudo apt-get install php-memcached
php -r '$c = new Memcached(); $c->addServer("localhost", 11211); var_dump( $c->getAllKeys() );'
```
### Manual2
```bash
sudo apt install libmemcached-tools
memcstat --servers=127.0.0.1 #Get stats
memcdump --servers=127.0.0.1 #Get all items
memccat  --servers=127.0.0.1 <item1> <item2> <item3> #Get info inside the item(s)
```
### Automatyczny
```bash
nmap -n -sV --script memcached-info -p 11211 <IP>   #Just gather info
msf > use auxiliary/gather/memcached_extractor      #Extracts saved data
msf > use auxiliary/scanner/memcached/memcached_amp #Check is UDP DDoS amplification attack is possible
```
## **Dumping Memcache Keys**

W obszarze memcache, protokoÅ‚u, ktÃ³ry pomaga w organizacji danych wedÅ‚ug slabÃ³w, istniejÄ… specyficzne polecenia do inspekcji przechowywanych danych, chociaÅ¼ z zauwaÅ¼alnymi ograniczeniami:

1. Klucze mogÄ… byÄ‡ dumpowane tylko wedÅ‚ug klasy slab, grupujÄ…c klucze o podobnym rozmiarze zawartoÅ›ci.
2. Istnieje limit jednej strony na klasÄ™ slab, co odpowiada 1MB danych.
3. Ta funkcjonalnoÅ›Ä‡ jest nieoficjalna i moÅ¼e zostaÄ‡ w kaÅ¼dej chwili wycofana, jak omÃ³wiono na [forum spoÅ‚ecznoÅ›ciowym](https://groups.google.com/forum/?fromgroups=#!topic/memcached/1-T8I-RVGKM).

Ograniczenie do dumpowania tylko 1MB z potencjalnie gigabajtÃ³w danych jest szczegÃ³lnie istotne. Niemniej jednak, ta funkcjonalnoÅ›Ä‡ moÅ¼e nadal oferowaÄ‡ wglÄ…d w wzorce uÅ¼ycia kluczy, w zaleÅ¼noÅ›ci od specyficznych potrzeb. Dla tych, ktÃ³rzy mniej interesujÄ… siÄ™ mechanikÄ…, wizyta w [sekcji narzÄ™dzi](https://lzone.de/cheat-sheet/memcached#tools) ujawnia narzÄ™dzia do kompleksowego dumpowania. Alternatywnie, proces uÅ¼ywania telnetu do bezpoÅ›redniej interakcji z konfiguracjami memcached jest opisany poniÅ¼ej.

### **How it Works**

Organizacja pamiÄ™ci memcache jest kluczowa. Inicjowanie memcache z opcjÄ… "-vv" ujawnia klasy slab, ktÃ³re generuje, jak pokazano poniÅ¼ej:
```bash
$ memcached -vv
slab class   1: chunk size        96 perslab   10922
[...]
```
Aby wyÅ›wietliÄ‡ wszystkie obecnie istniejÄ…ce slab, uÅ¼ywa siÄ™ nastÄ™pujÄ…cego polecenia:
```bash
stats slabs
```
Dodanie pojedynczego klucza do memcached 1.4.13 ilustruje, jak klasy slab sÄ… zapeÅ‚niane i zarzÄ…dzane. Na przykÅ‚ad:
```bash
set mykey 0 60 1
1
STORED
```
Wykonanie polecenia "stats slabs" po dodaniu klucza daje szczegÃ³Å‚owe statystyki dotyczÄ…ce wykorzystania slabÃ³w:
```bash
stats slabs
[...]
```
Ten wynik ujawnia aktywne typy slabÃ³w, wykorzystane kawaÅ‚ki oraz statystyki operacyjne, oferujÄ…c wglÄ…d w efektywnoÅ›Ä‡ operacji odczytu i zapisu.

Inna przydatna komenda, "stats items", dostarcza danych na temat usuniÄ™Ä‡, ograniczeÅ„ pamiÄ™ci oraz cykli Å¼ycia elementÃ³w:
```bash
stats items
[...]
```
Te statystyki pozwalajÄ… na wyciÄ…ganie wyedukowanych wnioskÃ³w na temat zachowania aplikacji w zakresie cache'owania, w tym efektywnoÅ›ci cache dla rÃ³Å¼nych rozmiarÃ³w treÅ›ci, alokacji pamiÄ™ci i pojemnoÅ›ci do cache'owania duÅ¼ych obiektÃ³w.

### **Dumping Keys**

Dla wersji wczeÅ›niejszych niÅ¼ 1.4.31, klucze sÄ… zrzucane wedÅ‚ug klasy slab za pomocÄ…:
```bash
stats cachedump <slab class> <number of items to dump>
```
Na przykÅ‚ad, aby zrzuciÄ‡ klucz w klasie #1:
```bash
stats cachedump 1 1000
ITEM mykey [1 b; 1350677968 s]
END
```
Ta metoda iteruje po klasach slab, ekstraktujÄ…c i opcjonalnie zrzucajÄ…c wartoÅ›ci kluczy.

### **Zrzucanie KLUCZY MEMCACHE (WERSJA 1.4.31+)**

W wersji memcache 1.4.31 i wyÅ¼szych wprowadzono nowÄ…, bezpieczniejszÄ… metodÄ™ zrzucania kluczy w Å›rodowisku produkcyjnym, wykorzystujÄ…c tryb non-blocking, jak szczegÃ³Å‚owo opisano w [notatkach wydania](https://github.com/memcached/memcached/wiki/ReleaseNotes1431). To podejÅ›cie generuje obszerne wyjÅ›cie, stÄ…d zalecenie uÅ¼ycia polecenia 'nc' dla efektywnoÅ›ci. PrzykÅ‚ady obejmujÄ…:
```bash
echo 'lru_crawler metadump all' | nc 127.0.0.1 11211 | head -1
echo 'lru_crawler metadump all' | nc 127.0.0.1 11211 | grep ee6ba58566e234ccbbce13f9a24f9a28
```
### **NARZÄ˜DZIA DO DUMPINGU**

Tabela [stÄ…d](https://lzone.de/blog).

| JÄ™zyki programowania | NarzÄ™dzia                                                                                                                            | FunkcjonalnoÅ›Ä‡                                                                                                                                                          |                                                                             |         |
| --------------------- | ------------------------------------------------------------------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------- | ------- |
| PHP                   | [prosty skrypt](http://snipt.org/xtP)                                                                                               | WyÅ›wietla nazwy kluczy.                                                                                                                                               |                                                                             |         |
| Perl                  | [prosty skrypt](https://wiki.jasig.org/download/attachments/13572172/memcached-clean.pl?version=1\&modificationDate=1229693957401) | WyÅ›wietla klucze i wartoÅ›ci                                                                                                                                          |                                                                             |         |
| Ruby                  | [prosty skrypt](https://gist.github.com/1365005)                                                                                    | WyÅ›wietla nazwy kluczy.                                                                                                                                               |                                                                             |         |
| Perl                  | [memdump](https://search.cpan.org/\~dmaki/Memcached-libmemcached-0.4202/src/libmemcached/docs/memdump.pod)                        | NarzÄ™dzie w module CPAN                                                                                                                                               | [Memcached-libmemcached](https://search.cpan.org/\~dmaki/Memcached-libmemc) | ached/) |
| PHP                   | [memcache.php](http://livebookmark.net/journal/2008/05/21/memcachephp-stats-like-apcphp/)                                         | GUI do monitorowania Memcache, ktÃ³ra rÃ³wnieÅ¼ pozwala na dumping kluczy                                                                                               |                                                                             |         |
| libmemcached          | [peep](http://blog.evanweaver.com/2009/04/20/peeping-into-memcached/)                                                             | **ZamraÅ¼a twÃ³j proces memcached!!!** UwaÅ¼aj przy uÅ¼ywaniu tego w produkcji. Mimo to, uÅ¼ywajÄ…c go, moÅ¼esz obejÅ›Ä‡ ograniczenie 1MB i naprawdÄ™ zrzuciÄ‡ **wszystkie** klucze. |                                                                             |         |

## RozwiÄ…zywanie problemÃ³w <a href="#troubleshooting" id="troubleshooting"></a>

### Limit danych 1MB <a href="#1mb-data-limit" id="1mb-data-limit"></a>

ZauwaÅ¼, Å¼e przed memcached 1.4 nie moÅ¼esz przechowywaÄ‡ obiektÃ³w wiÄ™kszych niÅ¼ 1MB z powodu domyÅ›lnego maksymalnego rozmiaru slab.

### Nigdy nie ustawiaj limitu czasu > 30 dni! <a href="#never-set-a-timeout--30-days" id="never-set-a-timeout--30-days"></a>

JeÅ›li sprÃ³bujesz â€ustawiÄ‡â€ lub â€dodaÄ‡â€ klucz z limitem czasu wiÄ™kszym niÅ¼ dozwolone maksimum, moÅ¼esz nie otrzymaÄ‡ tego, czego oczekujesz, poniewaÅ¼ memcached traktuje wartoÅ›Ä‡ jako znacznik czasu Unix. JeÅ›li znacznik czasu jest w przeszÅ‚oÅ›ci, nie zrobi nic. Twoje polecenie cicho siÄ™ nie powiedzie.

WiÄ™c jeÅ›li chcesz uÅ¼yÄ‡ maksymalnego czasu Å¼ycia, okreÅ›l 2592000. PrzykÅ‚ad:
```
set my_key 0 2592000 1
1
```
### ZnikajÄ…ce klucze przy przepeÅ‚nieniu <a href="#disappearing-keys-on-overflow" id="disappearing-keys-on-overflow"></a>

Pomimo dokumentacji mÃ³wiÄ…cej coÅ› o przepeÅ‚nieniu wartoÅ›ci 64bit przy uÅ¼yciu â€incrâ€, wartoÅ›Ä‡ znika. NaleÅ¼y jÄ… ponownie utworzyÄ‡ przy uÅ¼yciu â€addâ€/â€setâ€.

### Replikacja <a href="#replication" id="replication"></a>

memcached sam w sobie nie obsÅ‚uguje replikacji. JeÅ›li naprawdÄ™ jej potrzebujesz, musisz uÅ¼yÄ‡ rozwiÄ…zaÅ„ firm trzecich:

* [repcached](http://repcached.lab.klab.org/): Replikacja multi-master asynchroniczna (patch set memcached 1.2)
* [Couchbase memcached interface](http://www.couchbase.com/memcached): UÅ¼yj CouchBase jako zamiennika memcached
* [yrmcds](https://cybozu.github.io/yrmcds/): Zgodny z memcached magazyn kluczy-wartoÅ›ci Master-Slave
* [twemproxy](https://github.com/twitter/twemproxy) (znany rÃ³wnieÅ¼ jako nutcracker): proxy z obsÅ‚ugÄ… memcached

### Komendy Cheat-Sheet

{% content-ref url="memcache-commands.md" %}
[memcache-commands.md](memcache-commands.md)
{% endcontent-ref %}

### **Shodan**

* `port:11211 "STAT pid"`
* `"STAT pid"`

## Referencje

* [https://lzone.de/cheat-sheet/memcached](https://lzone.de/cheat-sheet/memcached)

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ sztuczkami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>
{% endhint %}
