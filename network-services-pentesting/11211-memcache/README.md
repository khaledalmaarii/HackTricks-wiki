# 11211 - Memcache Pentesting

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

## Protokol Bilgisi

[wikipedia](https://en.wikipedia.org/wiki/Memcached)'dan:

> **Memcached** (telaffuz: mem-cashed, mem-cash-dee), genel amaÃ§lÄ± daÄŸÄ±tÄ±k [bellek Ã¶nbellekleme](https://en.wikipedia.org/wiki/Memory\_caching) sistemidir. Genellikle, verileri ve nesneleri RAM'de Ã¶nbelleÄŸe alarak dinamik veritabanÄ± destekli web sitelerinin hÄ±zÄ±nÄ± artÄ±rmak iÃ§in kullanÄ±lÄ±r; bÃ¶ylece harici bir veri kaynaÄŸÄ±nÄ±n (Ã¶rneÄŸin bir veritabanÄ± veya API) okunma sayÄ±sÄ±nÄ± azaltÄ±r.

Memcached SASL'yi desteklese de, Ã§oÄŸu Ã¶rnek **kimlik doÄŸrulama olmadan aÃ§Ä±ÄŸa Ã§Ä±kar**.

**VarsayÄ±lan port:** 11211
```
PORT      STATE SERVICE
11211/tcp open  unknown
```
## Enumeration

### Manual

Bir memcache Ã¶rneÄŸinde kaydedilmiÅŸ tÃ¼m bilgileri dÄ±ÅŸarÄ± aktarmak iÃ§in ÅŸunlarÄ± yapmalÄ±sÄ±nÄ±z:

1. **Aktif Ã¶ÄŸeler** ile **slab'larÄ±** bulun
2. Daha Ã¶nce tespit edilen slab'larÄ±n **anahtar adlarÄ±nÄ±** alÄ±n
3. **Anahtar adlarÄ±nÄ±** alarak **kaydedilmiÅŸ veriyi** dÄ±ÅŸarÄ± aktarÄ±n

Bu hizmetin sadece bir **cache** olduÄŸunu unutmayÄ±n, bu nedenle **veri gÃ¶rÃ¼nebilir ve kaybolabilir**.
```bash
echo "version" | nc -vn -w 1 <IP> 11211      #Get version
echo "stats" | nc -vn -w 1 <IP> 11211        #Get status
echo "stats slabs" | nc -vn -w 1 <IP> 11211  #Get slabs
echo "stats items" | nc -vn -w 1 <IP> 11211  #Get items of slabs with info
echo "stats cachedump <number> 0" | nc -vn -w 1 <IP> 11211  #Get key names (the 0 is for unlimited output size)
echo "get <item_name>" | nc -vn -w 1 <IP> 11211  #Get saved info

#This php will just dump the keys, you need to use "get <item_name> later"
sudo apt-get install php-memcached
php -r '$c = new Memcached(); $c->addServer("localhost", 11211); var_dump( $c->getAllKeys() );'
```
### Manual2
```bash
sudo apt install libmemcached-tools
memcstat --servers=127.0.0.1 #Get stats
memcdump --servers=127.0.0.1 #Get all items
memccat  --servers=127.0.0.1 <item1> <item2> <item3> #Get info inside the item(s)
```
### Otomatik
```bash
nmap -n -sV --script memcached-info -p 11211 <IP>   #Just gather info
msf > use auxiliary/gather/memcached_extractor      #Extracts saved data
msf > use auxiliary/scanner/memcached/memcached_amp #Check is UDP DDoS amplification attack is possible
```
## **Memcache AnahtarlarÄ±nÄ± DÃ¶kme**

Memcache alanÄ±nda, verileri slab'lar aracÄ±lÄ±ÄŸÄ±yla dÃ¼zenlemeye yardÄ±mcÄ± olan bir protokolde, depolanan verileri incelemek iÃ§in belirli komutlar mevcuttur, ancak dikkate deÄŸer kÄ±sÄ±tlamalarla birlikte:

1. Anahtarlar yalnÄ±zca slab sÄ±nÄ±fÄ±na gÃ¶re dÃ¶kÃ¼lebilir, benzer iÃ§erik boyutuna sahip anahtarlarÄ± gruplar.
2. Her slab sÄ±nÄ±fÄ± iÃ§in bir sayfa limiti vardÄ±r, bu da 1MB veriye eÅŸdeÄŸerdir.
3. Bu Ã¶zellik resmi deÄŸildir ve [topluluk forumlarÄ±nda](https://groups.google.com/forum/?fromgroups=#!topic/memcached/1-T8I-RVGKM) tartÄ±ÅŸÄ±ldÄ±ÄŸÄ± gibi herhangi bir zamanda sona erdirilebilir.

Potansiyel olarak gigabaytlarca veriden yalnÄ±zca 1MB dÃ¶kme kÄ±sÄ±tlamasÄ± Ã¶zellikle Ã¶nemlidir. Ancak, bu iÅŸlevsellik belirli ihtiyaÃ§lara baÄŸlÄ± olarak anahtar kullanÄ±m desenleri hakkÄ±nda iÃ§gÃ¶rÃ¼ler sunabilir. Mekaniklerle daha az ilgilenenler iÃ§in, [araÃ§lar bÃ¶lÃ¼mÃ¼ne](https://lzone.de/cheat-sheet/memcached#tools) bir ziyaret, kapsamlÄ± dÃ¶kÃ¼m iÃ§in yardÄ±mcÄ± programlar sunmaktadÄ±r. Alternatif olarak, memcached kurulumlarÄ±yla doÄŸrudan etkileÅŸim iÃ§in telnet kullanma sÃ¼reci aÅŸaÄŸÄ±da aÃ§Ä±klanmÄ±ÅŸtÄ±r.

### **NasÄ±l Ã‡alÄ±ÅŸÄ±r**

Memcache'in bellek organizasyonu Ã§ok Ã¶nemlidir. Memcache'i "-vv" seÃ§eneÄŸiyle baÅŸlatmak, Ã¼rettiÄŸi slab sÄ±nÄ±flarÄ±nÄ± ortaya Ã§Ä±karÄ±r, aÅŸaÄŸÄ±da gÃ¶sterildiÄŸi gibi:
```bash
$ memcached -vv
slab class   1: chunk size        96 perslab   10922
[...]
```
TÃ¼m mevcut slab'larÄ± gÃ¶rÃ¼ntÃ¼lemek iÃ§in aÅŸaÄŸÄ±daki komut kullanÄ±lÄ±r:
```bash
stats slabs
```
Tek bir anahtarÄ±n memcached 1.4.13'e eklenmesi, slab sÄ±nÄ±flarÄ±nÄ±n nasÄ±l doldurulduÄŸunu ve yÃ¶netildiÄŸini gÃ¶sterir. Ã–rneÄŸin:
```bash
set mykey 0 60 1
1
STORED
```
"key" eklemeden sonra "stats slabs" komutunu Ã§alÄ±ÅŸtÄ±rmak, slab kullanÄ±mÄ±na dair ayrÄ±ntÄ±lÄ± istatistikler saÄŸlar:
```bash
stats slabs
[...]
```
Bu Ã§Ä±ktÄ±, aktif slab tÃ¼rlerini, kullanÄ±lan parÃ§alarÄ± ve operasyonel istatistikleri ortaya koyarak, okuma ve yazma iÅŸlemlerinin verimliliÄŸi hakkÄ±nda bilgiler sunar.

BaÅŸka bir yararlÄ± komut, "stats items", tahliyeler, bellek kÄ±sÄ±tlamalarÄ± ve Ã¶ÄŸe yaÅŸam dÃ¶ngÃ¼leri hakkÄ±nda veriler saÄŸlar:
```bash
stats items
[...]
```
Bu istatistikler, farklÄ± iÃ§erik boyutlarÄ± iÃ§in Ã¶nbellek verimliliÄŸi, bellek tahsisi ve bÃ¼yÃ¼k nesneleri Ã¶nbelleÄŸe alma kapasitesi dahil olmak Ã¼zere uygulama Ã¶nbellekleme davranÄ±ÅŸÄ± hakkÄ±nda eÄŸitimli varsayÄ±mlar yapÄ±lmasÄ±na olanak tanÄ±r.

### **AnahtarlarÄ± DÃ¶kme**

1.4.31'den Ã¶nceki sÃ¼rÃ¼mler iÃ§in, anahtarlar slab sÄ±nÄ±fÄ± tarafÄ±ndan dÃ¶kÃ¼lÃ¼r:
```bash
stats cachedump <slab class> <number of items to dump>
```
Ã–rneÄŸin, sÄ±nÄ±f #1'de bir anahtarÄ± dÃ¶kmek iÃ§in:
```bash
stats cachedump 1 1000
ITEM mykey [1 b; 1350677968 s]
END
```
Bu yÃ¶ntem, slab sÄ±nÄ±flarÄ± Ã¼zerinde yineleme yaparak anahtar deÄŸerlerini Ã§Ä±karÄ±r ve isteÄŸe baÄŸlÄ± olarak dÃ¶kÃ¼m yapar.

### **MEMCACHE ANAHTARLARINI DÃ–KME (VER 1.4.31+)**

Memcache sÃ¼rÃ¼mÃ¼ 1.4.31 ve Ã¼zeri ile, Ã¼retim ortamÄ±nda anahtarlarÄ± dÃ¶kmek iÃ§in yeni, daha gÃ¼venli bir yÃ¶ntem tanÄ±tÄ±lmÄ±ÅŸtÄ±r; bu yÃ¶ntem, [sÃ¼rÃ¼m notlarÄ±nda](https://github.com/memcached/memcached/wiki/ReleaseNotes1431) detaylandÄ±rÄ±ldÄ±ÄŸÄ± gibi, engellemeyen mod kullanmaktadÄ±r. Bu yaklaÅŸÄ±m geniÅŸ bir Ã§Ä±ktÄ± Ã¼retir, bu nedenle verimlilik iÃ§in 'nc' komutunun kullanÄ±lmasÄ±nÄ± Ã¶neririz. Ã–rnekler ÅŸunlardÄ±r:
```bash
echo 'lru_crawler metadump all' | nc 127.0.0.1 11211 | head -1
echo 'lru_crawler metadump all' | nc 127.0.0.1 11211 | grep ee6ba58566e234ccbbce13f9a24f9a28
```
### **DUMPING TOOLS**

Table [from here](https://lzone.de/blog).

| Programming Languages | Tools                                                                                                                              | Functionality                                                                                                                                                          |                                                                             |         |
| --------------------- | ---------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------- | ------- |
| PHP                   | [simple script](http://snipt.org/xtP)                                                                                              | Anahtar adlarÄ±nÄ± yazdÄ±rÄ±r.                                                                                                                                                      |                                                                             |         |
| Perl                  | [simple script](https://wiki.jasig.org/download/attachments/13572172/memcached-clean.pl?version=1\&modificationDate=1229693957401) | AnahtarlarÄ± ve deÄŸerleri yazdÄ±rÄ±r.                                                                                                                                                 |                                                                             |         |
| Ruby                  | [simple script](https://gist.github.com/1365005)                                                                                   | Anahtar adlarÄ±nÄ± yazdÄ±rÄ±r.                                                                                                                                                      |                                                                             |         |
| Perl                  | [memdump](https://search.cpan.org/\~dmaki/Memcached-libmemcached-0.4202/src/libmemcached/docs/memdump.pod)                         | CPAN modÃ¼lÃ¼ndeki araÃ§                                                                                                                                                    | [Memcached-libmemcached](https://search.cpan.org/\~dmaki/Memcached-libmemc) | ached/) |
| PHP                   | [memcache.php](http://livebookmark.net/journal/2008/05/21/memcachephp-stats-like-apcphp/)                                          | AnahtarlarÄ± dÃ¶kme imkanÄ± da sunan Memcache Ä°zleme GUI'si                                                                                                                  |                                                                             |         |
| libmemcached          | [peep](http://blog.evanweaver.com/2009/04/20/peeping-into-memcached/)                                                              | **Memcached iÅŸleminizi dondurur!!!** Ãœretimde kullanÄ±rken dikkatli olun. Yine de bunu kullanarak 1MB sÄ±nÄ±rlamasÄ±nÄ± aÅŸabilir ve gerÃ§ekten **tÃ¼m** anahtarlarÄ± dÃ¶kebilirsiniz. |                                                                             |         |

## Troubleshooting <a href="#troubleshooting" id="troubleshooting"></a>

### 1MB Data Limit <a href="#1mb-data-limit" id="1mb-data-limit"></a>

memcached 1.4'ten Ã¶nce, varsayÄ±lan maksimum slab boyutu nedeniyle 1MB'den bÃ¼yÃ¼k nesneleri depolayamazsÄ±nÄ±z.

### Never Set a Timeout > 30 Days! <a href="#never-set-a-timeout--30-days" id="never-set-a-timeout--30-days"></a>

EÄŸer izin verilen maksimumdan daha bÃ¼yÃ¼k bir zaman aÅŸÄ±mÄ± ile bir anahtar â€œsetâ€ veya â€œaddâ€ etmeye Ã§alÄ±ÅŸÄ±rsanÄ±z, memcached bu deÄŸeri bir Unix zaman damgasÄ± olarak deÄŸerlendireceÄŸi iÃ§in beklediÄŸiniz sonucu alamayabilirsiniz. AyrÄ±ca, zaman damgasÄ± geÃ§miÅŸte ise hiÃ§bir ÅŸey yapmaz. Komutunuz sessizce baÅŸarÄ±sÄ±z olur.

Bu nedenle, maksimum Ã¶mrÃ¼ kullanmak istiyorsanÄ±z 2592000 olarak belirtin. Ã–rnek:
```
set my_key 0 2592000 1
1
```
### Disappearing Keys on Overflow <a href="#disappearing-keys-on-overflow" id="disappearing-keys-on-overflow"></a>

DokÃ¼mantasyonda 64bit deÄŸerinin â€œincrâ€ kullanarak taÅŸmasÄ±nÄ±n deÄŸerin kaybolmasÄ±na neden olduÄŸu belirtilse de, bu deÄŸerin tekrar â€œaddâ€/â€setâ€ ile oluÅŸturulmasÄ± gerekir.

### Replication <a href="#replication" id="replication"></a>

memcached kendisi replikasyonu desteklemez. GerÃ§ekten ihtiyacÄ±nÄ±z varsa, 3. parti Ã§Ã¶zÃ¼mleri kullanmalÄ±sÄ±nÄ±z:

* [repcached](http://repcached.lab.klab.org/): Ã‡oklu-master asenkron replikasyon (memcached 1.2 yamanmasÄ±)
* [Couchbase memcached arayÃ¼zÃ¼](http://www.couchbase.com/memcached): CouchBase'i memcached yerine kullanÄ±n
* [yrmcds](https://cybozu.github.io/yrmcds/): memcached uyumlu Master-Slave anahtar-deÄŸer deposu
* [twemproxy](https://github.com/twitter/twemproxy) (aka nutcracker): memcached desteÄŸi olan proxy

### Commands Cheat-Sheet

{% content-ref url="memcache-commands.md" %}
[memcache-commands.md](memcache-commands.md)
{% endcontent-ref %}

### **Shodan**

* `port:11211 "STAT pid"`
* `"STAT pid"`

## References

* [https://lzone.de/cheat-sheet/memcached](https://lzone.de/cheat-sheet/memcached)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
