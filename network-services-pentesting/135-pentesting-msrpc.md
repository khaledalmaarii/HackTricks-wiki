# 135, 593 - Pentesting MSRPC

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

<figure><img src="../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

åŠ å…¥ [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) æœåŠ¡å™¨ï¼Œä¸ç»éªŒä¸°å¯Œçš„é»‘å®¢å’Œæ¼æ´èµé‡‘çŒäººäº¤æµï¼

**é»‘å®¢è§è§£**\
å‚ä¸æ·±å…¥æ¢è®¨é»‘å®¢çš„åˆºæ¿€ä¸æŒ‘æˆ˜çš„å†…å®¹

**å®æ—¶é»‘å®¢æ–°é—»**\
é€šè¿‡å®æ—¶æ–°é—»å’Œè§è§£ï¼Œè·Ÿä¸Šå¿«é€Ÿå˜åŒ–çš„é»‘å®¢ä¸–ç•Œ

**æœ€æ–°å…¬å‘Š**\
äº†è§£æœ€æ–°çš„æ¼æ´èµé‡‘è®¡åˆ’å’Œé‡è¦å¹³å°æ›´æ–°

**ä»Šå¤©å°±åŠ å…¥æˆ‘ä»¬çš„** [**Discord**](https://discord.com/invite/N3FrSbmwdy)ï¼Œä¸é¡¶å°–é»‘å®¢å¼€å§‹åˆä½œå§ï¼

## åŸºæœ¬ä¿¡æ¯

Microsoft è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ (MSRPC) åè®®æ˜¯ä¸€ç§å®¢æˆ·ç«¯-æœåŠ¡å™¨æ¨¡å‹ï¼Œä½¿ç¨‹åºèƒ½å¤Ÿè¯·æ±‚ä½äºå¦ä¸€å°è®¡ç®—æœºä¸Šçš„ç¨‹åºæä¾›æœåŠ¡ï¼Œè€Œæ— éœ€äº†è§£ç½‘ç»œçš„å…·ä½“æƒ…å†µã€‚è¯¥åè®®æœ€åˆæºäºå¼€æºè½¯ä»¶ï¼Œåæ¥ç”± Microsoft å¼€å‘å¹¶è·å¾—ç‰ˆæƒã€‚

RPC ç«¯ç‚¹æ˜ å°„å™¨å¯ä»¥é€šè¿‡ TCP å’Œ UDP ç«¯å£ 135 è®¿é—®ï¼ŒSMB åœ¨ TCP 139 å’Œ 445ï¼ˆä½¿ç”¨ç©ºä¼šè¯æˆ–ç»è¿‡èº«ä»½éªŒè¯çš„ä¼šè¯ï¼‰ä¸Šï¼Œä»¥åŠä½œä¸º Web æœåŠ¡åœ¨ TCP ç«¯å£ 593 ä¸Šè®¿é—®ã€‚
```
135/tcp   open     msrpc         Microsoft Windows RPC
```
## MSRPCæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ

ç”±å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºå‘èµ·ï¼ŒMSRPCè¿‡ç¨‹æ¶‰åŠè°ƒç”¨æœ¬åœ°å­˜æ ¹è¿‡ç¨‹ï¼Œç„¶åä¸å®¢æˆ·ç«¯è¿è¡Œæ—¶åº“äº¤äº’ï¼Œä»¥å‡†å¤‡å’Œä¼ è¾“è¯·æ±‚åˆ°æœåŠ¡å™¨ã€‚è¿™åŒ…æ‹¬å°†å‚æ•°è½¬æ¢ä¸ºæ ‡å‡†ç½‘ç»œæ•°æ®è¡¨ç¤ºæ ¼å¼ã€‚å¦‚æœæœåŠ¡å™¨æ˜¯è¿œç¨‹çš„ï¼Œä¼ è¾“åè®®çš„é€‰æ‹©ç”±è¿è¡Œæ—¶åº“å†³å®šï¼Œç¡®ä¿RPCé€šè¿‡ç½‘ç»œæ ˆä¼ é€’ã€‚

![https://0xffsec.com/handbook/images/msrpc.png](https://0xffsec.com/handbook/images/msrpc.png)

## **è¯†åˆ«æš´éœ²çš„RPCæœåŠ¡**

é€šè¿‡æŸ¥è¯¢RPCå®šä½æœåŠ¡å’Œå„ä¸ªç«¯ç‚¹ï¼Œå¯ä»¥ç¡®å®šé€šè¿‡TCPã€UDPã€HTTPå’ŒSMBæš´éœ²çš„RPCæœåŠ¡ã€‚å·¥å…·å¦‚rpcdumpæœ‰åŠ©äºè¯†åˆ«å”¯ä¸€çš„RPCæœåŠ¡ï¼Œä»¥**IFID**å€¼è¡¨ç¤ºï¼Œæ­ç¤ºæœåŠ¡ç»†èŠ‚å’Œé€šä¿¡ç»‘å®šï¼š
```
D:\rpctools> rpcdump [-p port] <IP>
**IFID**: 5a7b91f8-ff00-11d0-a9b2-00c04fb6e6fc version 1.0
Annotation: Messenger Service
UUID: 00000000-0000-0000-0000-000000000000
Binding: ncadg_ip_udp:<IP>[1028]
```
è®¿é—®RPCå®šä½æœåŠ¡æ˜¯é€šè¿‡ç‰¹å®šåè®®å¯ç”¨çš„ï¼šncacn\_ip\_tcpå’Œncadg\_ip\_udpç”¨äºé€šè¿‡ç«¯å£135è®¿é—®ï¼Œncacn\_npç”¨äºSMBè¿æ¥ï¼Œä»¥åŠncacn\_httpç”¨äºåŸºäºWebçš„RPCé€šä¿¡ã€‚ä»¥ä¸‹å‘½ä»¤ç¤ºä¾‹å±•ç¤ºäº†åˆ©ç”¨Metasploitæ¨¡å—å®¡è®¡å’Œä¸MSRPCæœåŠ¡äº¤äº’ï¼Œä¸»è¦é›†ä¸­åœ¨ç«¯å£135ï¼š
```bash
use auxiliary/scanner/dcerpc/endpoint_mapper
use auxiliary/scanner/dcerpc/hidden
use auxiliary/scanner/dcerpc/management
use auxiliary/scanner/dcerpc/tcp_dcerpc_auditor
rpcdump.py <IP> -p 135
```
æ‰€æœ‰é€‰é¡¹é™¤äº† `tcp_dcerpc_auditor` éƒ½æ˜¯ä¸“é—¨é’ˆå¯¹ç«¯å£ 135 ä¸Šçš„ MSRPC è¿›è¡Œæ”»å‡»è®¾è®¡çš„ã€‚

#### çŸ¥å RPC æ¥å£

* **IFID**: 12345778-1234-abcd-ef00-0123456789ab
* **å‘½åç®¡é“**: `\pipe\lsarpc`
* **æè¿°**: LSA æ¥å£ï¼Œç”¨äºæšä¸¾ç”¨æˆ·ã€‚
* **IFID**: 3919286a-b10c-11d0-9ba8-00c04fd92ef5
* **å‘½åç®¡é“**: `\pipe\lsarpc`
* **æè¿°**: LSA ç›®å½•æœåŠ¡ (DS) æ¥å£ï¼Œç”¨äºæšä¸¾åŸŸå’Œä¿¡ä»»å…³ç³»ã€‚
* **IFID**: 12345778-1234-abcd-ef00-0123456789ac
* **å‘½åç®¡é“**: `\pipe\samr`
* **æè¿°**: LSA SAMR æ¥å£ï¼Œç”¨äºè®¿é—®å…¬å…± SAM æ•°æ®åº“å…ƒç´ ï¼ˆä¾‹å¦‚ï¼Œç”¨æˆ·åï¼‰å¹¶å¼ºè¡Œç ´è§£ç”¨æˆ·å¯†ç ï¼Œæ— è®ºè´¦æˆ·é”å®šç­–ç•¥å¦‚ä½•ã€‚
* **IFID**: 1ff70682-0a51-30e8-076d-740be8cee98b
* **å‘½åç®¡é“**: `\pipe\atsvc`
* **æè¿°**: ä»»åŠ¡è°ƒåº¦ç¨‹åºï¼Œç”¨äºè¿œç¨‹æ‰§è¡Œå‘½ä»¤ã€‚
* **IFID**: 338cd001-2244-31f1-aaaa-900038001003
* **å‘½åç®¡é“**: `\pipe\winreg`
* **æè¿°**: è¿œç¨‹æ³¨å†Œè¡¨æœåŠ¡ï¼Œç”¨äºè®¿é—®å’Œä¿®æ”¹ç³»ç»Ÿæ³¨å†Œè¡¨ã€‚
* **IFID**: 367abb81-9844-35f1-ad32-98f038001003
* **å‘½åç®¡é“**: `\pipe\svcctl`
* **æè¿°**: æœåŠ¡æ§åˆ¶ç®¡ç†å™¨å’ŒæœåŠ¡å™¨æœåŠ¡ï¼Œç”¨äºè¿œç¨‹å¯åŠ¨å’Œåœæ­¢æœåŠ¡ä»¥åŠæ‰§è¡Œå‘½ä»¤ã€‚
* **IFID**: 4b324fc8-1670-01d3-1278-5a47bf6ee188
* **å‘½åç®¡é“**: `\pipe\srvsvc`
* **æè¿°**: æœåŠ¡æ§åˆ¶ç®¡ç†å™¨å’ŒæœåŠ¡å™¨æœåŠ¡ï¼Œç”¨äºè¿œç¨‹å¯åŠ¨å’Œåœæ­¢æœåŠ¡ä»¥åŠæ‰§è¡Œå‘½ä»¤ã€‚
* **IFID**: 4d9f4ab8-7d1c-11cf-861e-0020af6e7c57
* **å‘½åç®¡é“**: `\pipe\epmapper`
* **æè¿°**: DCOM æ¥å£ï¼Œç”¨äºå¼ºè¡Œç ´è§£å¯†ç å’Œé€šè¿‡ WM æ”¶é›†ä¿¡æ¯ã€‚

### è¯†åˆ« IP åœ°å€

ä½¿ç”¨ [https://github.com/mubix/IOXIDResolver](https://github.com/mubix/IOXIDResolver)ï¼Œæ¥è‡ª [Airbus research](https://www.cyber.airbus.com/the-oxid-resolver-part-1-remote-enumeration-of-network-interfaces-without-any-authentication/)ï¼Œå¯ä»¥æ»¥ç”¨ _**ServerAlive2**_ æ–¹æ³•åœ¨ _**IOXIDResolver**_ æ¥å£å†…ã€‚

è¯¥æ–¹æ³•å·²è¢«ç”¨äºä» HTB ç›’å­ _APT_ è·å–æ¥å£ä¿¡æ¯ï¼Œå¦‚ **IPv6** åœ°å€ã€‚æœ‰å…³ 0xdf APT çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§ [è¿™é‡Œ](https://0xdf.gitlab.io/2021/04/10/htb-apt.html)ï¼Œå…¶ä¸­åŒ…æ‹¬ä½¿ç”¨æ¥è‡ª [Impacket](https://github.com/SecureAuthCorp/impacket/) çš„ rpcmap.py å’Œ _stringbinding_ çš„æ›¿ä»£æ–¹æ³•ï¼ˆè§ä¸Šæ–‡ï¼‰ã€‚

### ä½¿ç”¨æœ‰æ•ˆå‡­æ®æ‰§è¡Œ RCE

å¦‚æœæœ‰æœ‰æ•ˆç”¨æˆ·çš„å‡­æ®ï¼Œå¯ä»¥ä½¿ç”¨æ¥è‡ª impacket æ¡†æ¶çš„ [dcomexec.py](https://github.com/fortra/impacket/blob/master/examples/dcomexec.py) åœ¨æœºå™¨ä¸Šæ‰§è¡Œè¿œç¨‹ä»£ç ã€‚

**è®°å¾—å°è¯•ä¸åŒçš„å¯ç”¨å¯¹è±¡**

* ShellWindows
* ShellBrowserWindow
* MMC20

## ç«¯å£ 593

æ¥è‡ª [rpctools](https://resources.oreilly.com/examples/9780596510305/tree/master/tools/rpctools) çš„ **rpcdump.exe** å¯ä»¥ä¸æ­¤ç«¯å£è¿›è¡Œäº¤äº’ã€‚

## å‚è€ƒæ–‡çŒ®

* [https://www.cyber.airbus.com/the-oxid-resolver-part-1-remote-enumeration-of-network-interfaces-without-any-authentication/](https://www.cyber.airbus.com/the-oxid-resolver-part-1-remote-enumeration-of-network-interfaces-without-any-authentication/)
* [https://www.cyber.airbus.com/the-oxid-resolver-part-2-accessing-a-remote-object-inside-dcom/](https://www.cyber.airbus.com/the-oxid-resolver-part-2-accessing-a-remote-object-inside-dcom/)
* [https://0xffsec.com/handbook/services/msrpc/](https://0xffsec.com/handbook/services/msrpc/)

<figure><img src="../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

åŠ å…¥ [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) æœåŠ¡å™¨ï¼Œä¸ç»éªŒä¸°å¯Œçš„é»‘å®¢å’Œæ¼æ´èµé‡‘çŒäººäº¤æµï¼

**é»‘å®¢è§è§£**\
å‚ä¸æ·±å…¥æ¢è®¨é»‘å®¢çš„åˆºæ¿€ä¸æŒ‘æˆ˜çš„å†…å®¹

**å®æ—¶é»‘å®¢æ–°é—»**\
é€šè¿‡å®æ—¶æ–°é—»å’Œè§è§£ï¼Œè·Ÿä¸Šå¿«é€Ÿå˜åŒ–çš„é»‘å®¢ä¸–ç•Œ

**æœ€æ–°å…¬å‘Š**\
åŠæ—¶äº†è§£æœ€æ–°çš„æ¼æ´èµé‡‘è®¡åˆ’å’Œé‡è¦å¹³å°æ›´æ–°

**åŠ å…¥æˆ‘ä»¬** [**Discord**](https://discord.com/invite/N3FrSbmwdy)ï¼Œä»Šå¤©å°±å¼€å§‹ä¸é¡¶çº§é»‘å®¢åˆä½œï¼

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
