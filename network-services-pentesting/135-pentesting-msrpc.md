# 135, 593 - Testowanie penetracyjne MSRPC

<details>

<summary><strong>Nauka hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakowania, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>

<figure><img src="../.gitbook/assets/image (377).png" alt=""><figcaption></figcaption></figure>

Docz do serwera [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy), aby komunikowa si z dowiadczonymi hakerami i owcami bd贸w!

**Spostrze偶enia dotyczce hakowania**\
Zajmij si treciami, kt贸re zagbiaj si w emocje i wyzwania hakowania

**Aktualnoci dotyczce hakowania w czasie rzeczywistym**\
Bd藕 na bie偶co z szybkim tempem wiata hakowania dziki aktualnociom i spostrze偶eniom w czasie rzeczywistym

**Najnowsze ogoszenia**\
Bd藕 na bie偶co z najnowszymi programami bug bounty i istotnymi aktualizacjami platform

**Docz do nas na** [**Discordzie**](https://discord.com/invite/N3FrSbmwdy) i zacznij wsp贸pracowa z najlepszymi hakerami ju偶 dzi!

## Podstawowe informacje

Protok贸 Microsoft Remote Procedure Call (MSRPC), model klient-serwer umo偶liwiajcy programowi 偶danie usugi od programu znajdujcego si na innym komputerze bez koniecznoci zrozumienia szczeg贸贸w sieci, pocztkowo pochodzi z oprogramowania open-source, a nastpnie zosta rozwinity i opatentowany przez firm Microsoft.

Mapper punkt贸w kocowych RPC mo偶na uzyska za porednictwem portu TCP i UDP 135, SMB na TCP 139 i 445 (z pust lub uwierzytelnion sesj) oraz jako usug sieciow na porcie TCP 593.
```
135/tcp   open     msrpc         Microsoft Windows RPC
```
## Jak dziaa MSRPC?

Zainicjowany przez aplikacj klienta, proces MSRPC polega na wywoaniu lokalnej procedury pomocniczej, kt贸ra nastpnie wsp贸dziaa z bibliotek czasu wykonania klienta, aby przygotowa i przesa 偶danie do serwera. Obejmuje to konwersj parametr贸w na standardowy format reprezentacji danych sieciowych. Wyb贸r protokou transportu jest okrelany przez bibliotek czasu wykonania, jeli serwer jest zdalny, zapewniajc dostarczenie RPC przez stos sieciowy.

![https://0xffsec.com/handbook/images/msrpc.png](https://0xffsec.com/handbook/images/msrpc.png)

## **Identyfikacja wystawionych usug RPC**

Wystawienie usug RPC poprzez TCP, UDP, HTTP i SMB mo偶na okreli poprzez zapytanie usugi lokalizatora RPC i poszczeg贸lnych punkt贸w kocowych. Narzdzia takie jak rpcdump uatwiaj identyfikacj unikalnych usug RPC, oznaczonych wartociami **IFID**, ujawniajc szczeg贸y usugi i powizania komunikacyjne:
```
D:\rpctools> rpcdump [-p port] <IP>
**IFID**: 5a7b91f8-ff00-11d0-a9b2-00c04fb6e6fc version 1.0
Annotation: Messenger Service
UUID: 00000000-0000-0000-0000-000000000000
Binding: ncadg_ip_udp:<IP>[1028]
```
Dostp do usugi lokalizatora RPC jest wczony poprzez okrelone protokoy: ncacn\_ip\_tcp i ncadg\_ip\_udp do dostpu za porednictwem portu 135, ncacn\_np do pocze SMB oraz ncacn\_http do komunikacji opartej na RPC w sieci webowej. Poni偶sze polecenia ilustruj wykorzystanie modu贸w Metasploit do audytu i interakcji z usugami MSRPC, skupiajc si g贸wnie na porcie 135:
```bash
use auxiliary/scanner/dcerpc/endpoint_mapper
use auxiliary/scanner/dcerpc/hidden
use auxiliary/scanner/dcerpc/management
use auxiliary/scanner/dcerpc/tcp_dcerpc_auditor
rpcdump.py <IP> -p 135
```
Wszystkie opcje opr贸cz `tcp_dcerpc_auditor` s specjalnie zaprojektowane do celowania w MSRPC na porcie 135.

#### Znaczce interfejsy RPC

* **IFID**: 12345778-1234-abcd-ef00-0123456789ab
* **Named Pipe**: `\pipe\lsarpc`
* **Opis**: Interfejs LSA, u偶ywany do wyliczania u偶ytkownik贸w.
* **IFID**: 3919286a-b10c-11d0-9ba8-00c04fd92ef5
* **Named Pipe**: `\pipe\lsarpc`
* **Opis**: Interfejs usug katalogowych LSA (DS), u偶ywany do wyliczania domen i relacji zaufania.
* **IFID**: 12345778-1234-abcd-ef00-0123456789ac
* **Named Pipe**: `\pipe\samr`
* **Opis**: Interfejs LSA SAMR, u偶ywany do dostpu do publicznych element贸w bazy danych SAM (np. nazwy u偶ytkownik贸w) i amania hase u偶ytkownik贸w bez wzgldu na polityk blokady konta.
* **IFID**: 1ff70682-0a51-30e8-076d-740be8cee98b
* **Named Pipe**: `\pipe\atsvc`
* **Opis**: Harmonogram zada, u偶ywany do zdalnego wykonywania polece.
* **IFID**: 338cd001-2244-31f1-aaaa-900038001003
* **Named Pipe**: `\pipe\winreg`
* **Opis**: Usuga rejestru zdalnego, u偶ywana do dostpu i modyfikacji rejestru systemowego.
* **IFID**: 367abb81-9844-35f1-ad32-98f038001003
* **Named Pipe**: `\pipe\svcctl`
* **Opis**: Mened偶er kontroli usug i usugi serwerowe, u偶ywane do zdalnego uruchamiania i zatrzymywania usug oraz wykonywania polece.
* **IFID**: 4b324fc8-1670-01d3-1278-5a47bf6ee188
* **Named Pipe**: `\pipe\srvsvc`
* **Opis**: Mened偶er kontroli usug i usugi serwerowe, u偶ywane do zdalnego uruchamiania i zatrzymywania usug oraz wykonywania polece.
* **IFID**: 4d9f4ab8-7d1c-11cf-861e-0020af6e7c57
* **Named Pipe**: `\pipe\epmapper`
* **Opis**: Interfejs DCOM, u偶ywany do amania hase metod brute-force i zbierania informacji za pomoc WM.

### Identyfikacja adres贸w IP

Korzystajc z [https://github.com/mubix/IOXIDResolver](https://github.com/mubix/IOXIDResolver), pochodzcego z [badania Airbusa](https://www.cyber.airbus.com/the-oxid-resolver-part-1-remote-enumeration-of-network-interfaces-without-any-authentication/), mo偶liwe jest nadu偶ycie metody _**ServerAlive2**_ wewntrz interfejsu _**IOXIDResolver**_.

Ta metoda zostaa wykorzystana do uzyskania informacji o interfejsie jako adres **IPv6** z boxa HTB _APT_. Zobacz [tutaj](https://0xdf.gitlab.io/2021/04/10/htb-apt.html) opis APT od 0xdf, zawiera on alternatywn metod korzystajc z rpcmap.py z [Impacket](https://github.com/SecureAuthCorp/impacket/) z _stringbinding_ (patrz powy偶ej).

### Wykonywanie RCE z prawidowymi danymi uwierzytelniajcymi

Mo偶liwe jest wykonanie zdalnego kodu na maszynie, jeli dostpne s dane uwierzytelniajce prawidowego u偶ytkownika, korzystajc z [dcomexec.py](https://github.com/fortra/impacket/blob/master/examples/dcomexec.py) z ramy impacket.

**Pamitaj, aby spr贸bowa z r贸偶nymi dostpnymi obiektami**

* ShellWindows
* ShellBrowserWindow
* MMC20

## Port 593

**rpcdump.exe** z [rpctools](https://resources.oreilly.com/examples/9780596510305/tree/master/tools/rpctools) mo偶e komunikowa si z tym portem.

## Referencje

* [https://www.cyber.airbus.com/the-oxid-resolver-part-1-remote-enumeration-of-network-interfaces-without-any-authentication/](https://www.cyber.airbus.com/the-oxid-resolver-part-1-remote-enumeration-of-network-interfaces-without-any-authentication/)
* [https://www.cyber.airbus.com/the-oxid-resolver-part-2-accessing-a-remote-object-inside-dcom/](https://www.cyber.airbus.com/the-oxid-resolver-part-2-accessing-a-remote-object-inside-dcom/)
* [https://0xffsec.com/handbook/services/msrpc/](https://0xffsec.com/handbook/services/msrpc/)

<figure><img src="../.gitbook/assets/image (377).png" alt=""><figcaption></figcaption></figure>

Docz do [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy), aby komunikowa si z dowiadczonymi hakerami i owcami bd贸w!

**Spostrze偶enia dotyczce hakerstwa**\
Zajmij si treciami, kt贸re zagbiaj si w emocje i wyzwania hakerstwa

**Aktualnoci dotyczce hakerstwa na 偶ywo**\
Bd藕 na bie偶co z szybkim tempem wiata hakerstwa dziki aktualnociom i spostrze偶eniom na 偶ywo

**Najnowsze ogoszenia**\
Bd藕 na bie偶co z najnowszymi programami nagr贸d za bdy i istotnymi aktualizacjami platformy

**Docz do nas na** [**Discordzie**](https://discord.com/invite/N3FrSbmwdy) i zacznij wsp贸pracowa z najlepszymi hakerami ju偶 dzi!

<details>

<summary><strong>Dowiedz si, jak hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na githubie.

</details>
