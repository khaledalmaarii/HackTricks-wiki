# 135, 593 - Pentesting MSRPC

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

Join [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) server to communicate with experienced hackers and bug bounty hunters!

**Hacking Insights**\
Engage with content that delves into the thrill and challenges of hacking

**Real-Time Hack News**\
Keep up-to-date with fast-paced hacking world through real-time news and insights

**Latest Announcements**\
Stay informed with the newest bug bounties launching and crucial platform updates

**Join us on** [**Discord**](https://discord.com/invite/N3FrSbmwdy) and start collaborating with top hackers today!

## Informations de base

Le protocole Microsoft Remote Procedure Call (MSRPC), un mod√®le client-serveur permettant √† un programme de demander un service √† un programme situ√© sur un autre ordinateur sans comprendre les sp√©cificit√©s du r√©seau, a √©t√© initialement d√©riv√© de logiciels open-source et d√©velopp√© et prot√©g√© par Microsoft.

Le mappage des points de terminaison RPC peut √™tre accessible via le port TCP et UDP 135, SMB sur TCP 139 et 445 (avec une session nulle ou authentifi√©e), et en tant que service web sur le port TCP 593.
```
135/tcp   open     msrpc         Microsoft Windows RPC
```
## Comment fonctionne MSRPC ?

Initi√© par l'application cliente, le processus MSRPC implique l'appel d'une proc√©dure stub locale qui interagit ensuite avec la biblioth√®que d'ex√©cution cliente pour pr√©parer et transmettre la demande au serveur. Cela inclut la conversion des param√®tres en un format standard de repr√©sentation des donn√©es r√©seau. Le choix du protocole de transport est d√©termin√© par la biblioth√®que d'ex√©cution si le serveur est distant, garantissant que le RPC est livr√© √† travers la pile r√©seau.

![https://0xffsec.com/handbook/images/msrpc.png](https://0xffsec.com/handbook/images/msrpc.png)

## **Identification des services RPC expos√©s**

L'exposition des services RPC √† travers TCP, UDP, HTTP et SMB peut √™tre d√©termin√©e en interrogeant le service de localisation RPC et les points de terminaison individuels. Des outils tels que rpcdump facilitent l'identification des services RPC uniques, d√©sign√©s par des valeurs **IFID**, r√©v√©lant des d√©tails sur le service et les liaisons de communication :
```
D:\rpctools> rpcdump [-p port] <IP>
**IFID**: 5a7b91f8-ff00-11d0-a9b2-00c04fb6e6fc version 1.0
Annotation: Messenger Service
UUID: 00000000-0000-0000-0000-000000000000
Binding: ncadg_ip_udp:<IP>[1028]
```
L'acc√®s au service de localisation RPC est activ√© via des protocoles sp√©cifiques : ncacn\_ip\_tcp et ncadg\_ip\_udp pour acc√©der via le port 135, ncacn\_np pour les connexions SMB, et ncacn\_http pour la communication RPC bas√©e sur le web. Les commandes suivantes illustrent l'utilisation des modules Metasploit pour auditer et interagir avec les services MSRPC, en se concentrant principalement sur le port 135 :
```bash
use auxiliary/scanner/dcerpc/endpoint_mapper
use auxiliary/scanner/dcerpc/hidden
use auxiliary/scanner/dcerpc/management
use auxiliary/scanner/dcerpc/tcp_dcerpc_auditor
rpcdump.py <IP> -p 135
```
Tous les options sauf `tcp_dcerpc_auditor` sont sp√©cifiquement con√ßues pour cibler MSRPC sur le port 135.

#### Interfaces RPC notables

* **IFID**: 12345778-1234-abcd-ef00-0123456789ab
* **Named Pipe**: `\pipe\lsarpc`
* **Description**: Interface LSA, utilis√©e pour √©num√©rer les utilisateurs.
* **IFID**: 3919286a-b10c-11d0-9ba8-00c04fd92ef5
* **Named Pipe**: `\pipe\lsarpc`
* **Description**: Interface LSA Directory Services (DS), utilis√©e pour √©num√©rer les domaines et les relations de confiance.
* **IFID**: 12345778-1234-abcd-ef00-0123456789ac
* **Named Pipe**: `\pipe\samr`
* **Description**: Interface LSA SAMR, utilis√©e pour acc√©der aux √©l√©ments de la base de donn√©es SAM publique (par exemple, les noms d'utilisateur) et pour forcer les mots de passe des utilisateurs, ind√©pendamment de la politique de verrouillage de compte.
* **IFID**: 1ff70682-0a51-30e8-076d-740be8cee98b
* **Named Pipe**: `\pipe\atsvc`
* **Description**: Planificateur de t√¢ches, utilis√© pour ex√©cuter des commandes √† distance.
* **IFID**: 338cd001-2244-31f1-aaaa-900038001003
* **Named Pipe**: `\pipe\winreg`
* **Description**: Service de registre √† distance, utilis√© pour acc√©der et modifier le registre syst√®me.
* **IFID**: 367abb81-9844-35f1-ad32-98f038001003
* **Named Pipe**: `\pipe\svcctl`
* **Description**: Gestionnaire de contr√¥le de service et services de serveur, utilis√©s pour d√©marrer et arr√™ter des services √† distance et ex√©cuter des commandes.
* **IFID**: 4b324fc8-1670-01d3-1278-5a47bf6ee188
* **Named Pipe**: `\pipe\srvsvc`
* **Description**: Gestionnaire de contr√¥le de service et services de serveur, utilis√©s pour d√©marrer et arr√™ter des services √† distance et ex√©cuter des commandes.
* **IFID**: 4d9f4ab8-7d1c-11cf-861e-0020af6e7c57
* **Named Pipe**: `\pipe\epmapper`
* **Description**: Interface DCOM, utilis√©e pour le craquage de mots de passe par force brute et la collecte d'informations via WM.

### Identification des adresses IP

En utilisant [https://github.com/mubix/IOXIDResolver](https://github.com/mubix/IOXIDResolver), provenant de [Airbus research](https://www.cyber.airbus.com/the-oxid-resolver-part-1-remote-enumeration-of-network-interfaces-without-any-authentication/), il est possible d'abuser de la m√©thode _**ServerAlive2**_ √† l'int√©rieur de l'interface _**IOXIDResolver**_.

Cette m√©thode a √©t√© utilis√©e pour obtenir des informations sur l'interface sous forme d'adresse **IPv6** de la bo√Æte HTB _APT_. Voir [ici](https://0xdf.gitlab.io/2021/04/10/htb-apt.html) pour le rapport 0xdf APT, il inclut une m√©thode alternative utilisant rpcmap.py de [Impacket](https://github.com/SecureAuthCorp/impacket/) avec _stringbinding_ (voir ci-dessus).

### Ex√©cution d'un RCE avec des identifiants valides

Il est possible d'ex√©cuter du code √† distance sur une machine, si les identifiants d'un utilisateur valide sont disponibles en utilisant [dcomexec.py](https://github.com/fortra/impacket/blob/master/examples/dcomexec.py) du framework impacket.

**N'oubliez pas d'essayer avec les diff√©rents objets disponibles**

* ShellWindows
* ShellBrowserWindow
* MMC20

## Port 593

Le **rpcdump.exe** de [rpctools](https://resources.oreilly.com/examples/9780596510305/tree/master/tools/rpctools) peut interagir avec ce port.

## R√©f√©rences

* [https://www.cyber.airbus.com/the-oxid-resolver-part-1-remote-enumeration-of-network-interfaces-without-any-authentication/](https://www.cyber.airbus.com/the-oxid-resolver-part-1-remote-enumeration-of-network-interfaces-without-any-authentication/)
* [https://www.cyber.airbus.com/the-oxid-resolver-part-2-accessing-a-remote-object-inside-dcom/](https://www.cyber.airbus.com/the-oxid-resolver-part-2-accessing-a-remote-object-inside-dcom/)
* [https://0xffsec.com/handbook/services/msrpc/](https://0xffsec.com/handbook/services/msrpc/)

<figure><img src="../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

Rejoignez le serveur [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) pour communiquer avec des hackers exp√©riment√©s et des chasseurs de bugs !

**Aper√ßus de Hacking**\
Engagez-vous avec du contenu qui explore le frisson et les d√©fis du hacking

**Actualit√©s de Hacking en Temps R√©el**\
Restez √† jour avec le monde du hacking en rapide √©volution gr√¢ce √† des nouvelles et des aper√ßus en temps r√©el

**Derni√®res Annonces**\
Restez inform√© des nouveaux programmes de bug bounty lanc√©s et des mises √† jour cruciales de la plateforme

**Rejoignez-nous sur** [**Discord**](https://discord.com/invite/N3FrSbmwdy) et commencez √† collaborer avec les meilleurs hackers aujourd'hui !

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux d√©p√¥ts github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
