# 135, 593 - Pentesting MSRPC

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

Join [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) server to communicate with experienced hackers and bug bounty hunters!

**Hacking Insights**\
Engage with content that delves into the thrill and challenges of hacking

**Real-Time Hack News**\
Keep up-to-date with fast-paced hacking world through real-time news and insights

**Latest Announcements**\
Stay informed with the newest bug bounties launching and crucial platform updates

**Join us on** [**Discord**](https://discord.com/invite/N3FrSbmwdy) and start collaborating with top hackers today!

## Informa√ß√µes B√°sicas

O protocolo Microsoft Remote Procedure Call (MSRPC), um modelo cliente-servidor que permite que um programa solicite um servi√ßo de um programa localizado em outro computador sem entender os detalhes da rede, foi inicialmente derivado de software de c√≥digo aberto e posteriormente desenvolvido e protegido por direitos autorais pela Microsoft.

O mapeador de endpoint RPC pode ser acessado via porta TCP e UDP 135, SMB na TCP 139 e 445 (com uma sess√£o nula ou autenticada), e como um servi√ßo web na porta TCP 593.
```
135/tcp   open     msrpc         Microsoft Windows RPC
```
## Como o MSRPC funciona?

Iniciado pela aplica√ß√£o cliente, o processo MSRPC envolve chamar um procedimento stub local que interage com a biblioteca de tempo de execu√ß√£o do cliente para preparar e transmitir a solicita√ß√£o ao servidor. Isso inclui converter par√¢metros em um formato padr√£o de Representa√ß√£o de Dados de Rede. A escolha do protocolo de transporte √© determinada pela biblioteca de tempo de execu√ß√£o se o servidor for remoto, garantindo que o RPC seja entregue atrav√©s da pilha de rede.

![https://0xffsec.com/handbook/images/msrpc.png](https://0xffsec.com/handbook/images/msrpc.png)

## **Identificando Servi√ßos RPC Expostos**

A exposi√ß√£o de servi√ßos RPC atrav√©s de TCP, UDP, HTTP e SMB pode ser determinada consultando o servi√ßo localizador de RPC e endpoints individuais. Ferramentas como rpcdump facilitam a identifica√ß√£o de servi√ßos RPC √∫nicos, denotados por valores **IFID**, revelando detalhes do servi√ßo e vincula√ß√µes de comunica√ß√£o:
```
D:\rpctools> rpcdump [-p port] <IP>
**IFID**: 5a7b91f8-ff00-11d0-a9b2-00c04fb6e6fc version 1.0
Annotation: Messenger Service
UUID: 00000000-0000-0000-0000-000000000000
Binding: ncadg_ip_udp:<IP>[1028]
```
O acesso ao servi√ßo de localizador RPC √© habilitado atrav√©s de protocolos espec√≠ficos: ncacn\_ip\_tcp e ncadg\_ip\_udp para acesso via porta 135, ncacn\_np para conex√µes SMB e ncacn\_http para comunica√ß√£o RPC baseada na web. Os seguintes comandos exemplificam a utiliza√ß√£o de m√≥dulos do Metasploit para auditar e interagir com servi√ßos MSRPC, focando principalmente na porta 135:
```bash
use auxiliary/scanner/dcerpc/endpoint_mapper
use auxiliary/scanner/dcerpc/hidden
use auxiliary/scanner/dcerpc/management
use auxiliary/scanner/dcerpc/tcp_dcerpc_auditor
rpcdump.py <IP> -p 135
```
Todas as op√ß√µes, exceto `tcp_dcerpc_auditor`, s√£o especificamente projetadas para direcionar o MSRPC na porta 135.

#### Interfaces RPC Not√°veis

* **IFID**: 12345778-1234-abcd-ef00-0123456789ab
* **Named Pipe**: `\pipe\lsarpc`
* **Descri√ß√£o**: Interface LSA, usada para enumerar usu√°rios.
* **IFID**: 3919286a-b10c-11d0-9ba8-00c04fd92ef5
* **Named Pipe**: `\pipe\lsarpc`
* **Descri√ß√£o**: Interface de Servi√ßos de Diret√≥rio LSA (DS), usada para enumerar dom√≠nios e rela√ß√µes de confian√ßa.
* **IFID**: 12345778-1234-abcd-ef00-0123456789ac
* **Named Pipe**: `\pipe\samr`
* **Descri√ß√£o**: Interface LSA SAMR, usada para acessar elementos p√∫blicos do banco de dados SAM (por exemplo, nomes de usu√°rio) e realizar for√ßa bruta em senhas de usu√°rios, independentemente da pol√≠tica de bloqueio de conta.
* **IFID**: 1ff70682-0a51-30e8-076d-740be8cee98b
* **Named Pipe**: `\pipe\atsvc`
* **Descri√ß√£o**: Agendador de tarefas, usado para executar comandos remotamente.
* **IFID**: 338cd001-2244-31f1-aaaa-900038001003
* **Named Pipe**: `\pipe\winreg`
* **Descri√ß√£o**: Servi√ßo de registro remoto, usado para acessar e modificar o registro do sistema.
* **IFID**: 367abb81-9844-35f1-ad32-98f038001003
* **Named Pipe**: `\pipe\svcctl`
* **Descri√ß√£o**: Gerenciador de controle de servi√ßos e servi√ßos de servidor, usado para iniciar e parar servi√ßos remotamente e executar comandos.
* **IFID**: 4b324fc8-1670-01d3-1278-5a47bf6ee188
* **Named Pipe**: `\pipe\srvsvc`
* **Descri√ß√£o**: Gerenciador de controle de servi√ßos e servi√ßos de servidor, usado para iniciar e parar servi√ßos remotamente e executar comandos.
* **IFID**: 4d9f4ab8-7d1c-11cf-861e-0020af6e7c57
* **Named Pipe**: `\pipe\epmapper`
* **Descri√ß√£o**: Interface DCOM, usada para for√ßa bruta em senhas e coleta de informa√ß√µes via WM.

### Identificando endere√ßos IP

Usando [https://github.com/mubix/IOXIDResolver](https://github.com/mubix/IOXIDResolver), que vem da [pesquisa da Airbus](https://www.cyber.airbus.com/the-oxid-resolver-part-1-remote-enumeration-of-network-interfaces-without-any-authentication/), √© poss√≠vel abusar do m√©todo _**ServerAlive2**_ dentro da interface _**IOXIDResolver**_.

Este m√©todo tem sido usado para obter informa√ß√µes da interface, como o endere√ßo **IPv6** da caixa HTB _APT_. Veja [aqui](https://0xdf.gitlab.io/2021/04/10/htb-apt.html) para o relat√≥rio APT de 0xdf, que inclui um m√©todo alternativo usando rpcmap.py do [Impacket](https://github.com/SecureAuthCorp/impacket/) com _stringbinding_ (veja acima).

### Executando um RCE com credenciais v√°lidas

√â poss√≠vel executar c√≥digo remoto em uma m√°quina, se as credenciais de um usu√°rio v√°lido estiverem dispon√≠veis usando [dcomexec.py](https://github.com/fortra/impacket/blob/master/examples/dcomexec.py) do framework impacket.

**Lembre-se de tentar com os diferentes objetos dispon√≠veis**

* ShellWindows
* ShellBrowserWindow
* MMC20

## Porta 593

O **rpcdump.exe** do [rpctools](https://resources.oreilly.com/examples/9780596510305/tree/master/tools/rpctools) pode interagir com esta porta.

## Refer√™ncias

* [https://www.cyber.airbus.com/the-oxid-resolver-part-1-remote-enumeration-of-network-interfaces-without-any-authentication/](https://www.cyber.airbus.com/the-oxid-resolver-part-1-remote-enumeration-of-network-interfaces-without-any-authentication/)
* [https://www.cyber.airbus.com/the-oxid-resolver-part-2-accessing-a-remote-object-inside-dcom/](https://www.cyber.airbus.com/the-oxid-resolver-part-2-accessing-a-remote-object-inside-dcom/)
* [https://0xffsec.com/handbook/services/msrpc/](https://0xffsec.com/handbook/services/msrpc/)

<figure><img src="../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

Junte-se ao servidor [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) para se comunicar com hackers experientes e ca√ßadores de bugs!

**Insights de Hacking**\
Engaje-se com conte√∫do que mergulha na emo√ß√£o e nos desafios do hacking

**Not√≠cias de Hack em Tempo Real**\
Mantenha-se atualizado com o mundo do hacking em ritmo acelerado atrav√©s de not√≠cias e insights em tempo real

**√öltimos An√∫ncios**\
Fique informado sobre os novos programas de recompensas por bugs lan√ßados e atualiza√ß√µes cruciais da plataforma

**Junte-se a n√≥s no** [**Discord**](https://discord.com/invite/N3FrSbmwdy) e comece a colaborar com os melhores hackers hoje!

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
