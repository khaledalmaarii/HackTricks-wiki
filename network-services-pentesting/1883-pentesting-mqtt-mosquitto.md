# 1883 - MQTTæ¸—é€æµ‹è¯•ï¼ˆMosquittoï¼‰

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ–åœ¨**Twitter**ä¸Šå…³æ³¨æˆ‘ä»¬ ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## åŸºæœ¬ä¿¡æ¯

**MQ Telemetry Transport (MQTT)** è¢«ç§°ä¸ºä¸€ç§**å‘å¸ƒ/è®¢é˜…æ¶ˆæ¯ä¼ è¾“åè®®**ï¼Œä»¥å…¶æç«¯ç®€å•å’Œè½»é‡è‘—ç§°ã€‚è¯¥åè®®ä¸“é—¨ä¸ºè®¾å¤‡èƒ½åŠ›æœ‰é™ã€è¿è¡Œåœ¨ä½å¸¦å®½ã€é«˜å»¶è¿Ÿæˆ–ä¸ç¨³å®šè¿æ¥ç‰¹å¾çš„ç½‘ç»œç¯å¢ƒè€Œè®¾è®¡ã€‚MQTTçš„æ ¸å¿ƒç›®æ ‡åŒ…æ‹¬å‡å°‘ç½‘ç»œå¸¦å®½çš„ä½¿ç”¨å’Œé™ä½å¯¹è®¾å¤‡èµ„æºçš„éœ€æ±‚ã€‚æ­¤å¤–ï¼Œå®ƒæ—¨åœ¨ä¿æŒå¯é çš„é€šä¿¡å¹¶æä¾›ä¸€å®šç¨‹åº¦çš„ä¼ é€’ä¿è¯ã€‚è¿™äº›ç›®æ ‡ä½¿MQTTéå¸¸é€‚ç”¨äºè“¬å‹ƒå‘å±•çš„**æœºå™¨å¯¹æœºå™¨ï¼ˆM2Mï¼‰é€šä¿¡**å’Œ**ç‰©è”ç½‘ï¼ˆIoTï¼‰**é¢†åŸŸï¼Œåœ¨è¿™äº›é¢†åŸŸä¸­ï¼Œé«˜æ•ˆè¿æ¥å¤§é‡è®¾å¤‡è‡³å…³é‡è¦ã€‚æ­¤å¤–ï¼ŒMQTTå¯¹äºç§»åŠ¨åº”ç”¨ç¨‹åºä¹Ÿéå¸¸æœ‰ç›Šï¼Œå…¶ä¸­èŠ‚çœå¸¦å®½å’Œç”µæ± å¯¿å‘½è‡³å…³é‡è¦ã€‚

**é»˜è®¤ç«¯å£ï¼š** 1883
```
PORT     STATE SERVICE                 REASON
1883/tcp open  mosquitto version 1.4.8 syn-ack
```
## æ£€æŸ¥æµé‡

å½“ MQTT ä»£ç†æ¥æ”¶åˆ° **CONNECT** æ•°æ®åŒ…æ—¶ï¼Œä¼šå‘é€å›ä¸€ä¸ª **CONNACK** æ•°æ®åŒ…ã€‚è¯¥æ•°æ®åŒ…åŒ…å«ä¸€ä¸ªè¿”å›ç ï¼Œå¯¹äºç†è§£è¿æ¥çŠ¶æ€è‡³å…³é‡è¦ã€‚è¿”å›ç  **0x00** è¡¨ç¤ºå‡­æ®å·²è¢«æ¥å—ï¼Œè¡¨æ˜è¿æ¥æˆåŠŸã€‚å¦ä¸€æ–¹é¢ï¼Œè¿”å›ç  **0x05** è¡¨ç¤ºå‡­æ®æ— æ•ˆï¼Œä»è€Œé˜»æ­¢è¿æ¥ã€‚

ä¾‹å¦‚ï¼Œå¦‚æœä»£ç†å› å‡­æ®æ— æ•ˆè€Œæ‹’ç»è¿æ¥ï¼Œåˆ™åœºæ™¯ä¼šå¦‚ä¸‹æ‰€ç¤ºï¼š
```
{
"returnCode": "0x05",
"description": "Connection Refused, not authorized"
}
```
![](<../.gitbook/assets/image (645) (1).png>)

### [**æš´åŠ›ç ´è§£ MQTT**](../generic-methodologies-and-resources/brute-force.md#mqtt)

## MQTT æ¸—é€æµ‹è¯•

**èº«ä»½éªŒè¯å®Œå…¨æ˜¯å¯é€‰çš„**ï¼Œå³ä½¿æ­£åœ¨æ‰§è¡Œèº«ä»½éªŒè¯ï¼Œ**é»˜è®¤æƒ…å†µä¸‹ä¸ä½¿ç”¨åŠ å¯†**ï¼ˆå‡­æ®ä»¥æ˜æ–‡å½¢å¼å‘é€ï¼‰ã€‚ä»ç„¶å¯ä»¥æ‰§è¡Œä¸­é—´äººæ”»å‡»æ¥çªƒå–å¯†ç ã€‚

è¦è¿æ¥åˆ° MQTT æœåŠ¡ï¼Œå¯ä»¥ä½¿ç”¨ï¼š[https://github.com/bapowell/python-mqtt-client-shell](https://github.com/bapowell/python-mqtt-client-shell) å¹¶è®¢é˜…æ‰€æœ‰ä¸»é¢˜ï¼š
```
> connect (NOTICE that you need to indicate before this the params of the connection, by default 127.0.0.1:1883)
> subscribe "#" 1
> subscribe "$SYS/#"
```
ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨[**https://github.com/akamai-threat-research/mqtt-pwn**](https://github.com/akamai-threat-research/mqtt-pwn)
```bash
apt-get install mosquitto mosquitto-clients
mosquitto_sub -t 'test/topic' -v #Subscriribe to 'test/topic'
```
æˆ–è€…æ‚¨å¯ä»¥**è¿è¡Œæ­¤ä»£ç å°è¯•è¿æ¥åˆ°ä¸€ä¸ªæ²¡æœ‰èº«ä»½éªŒè¯çš„MQTTæœåŠ¡ï¼Œè®¢é˜…æ¯ä¸ªä¸»é¢˜å¹¶ç›‘å¬å®ƒä»¬**ï¼š
```python
#This is a modified version of https://github.com/Warflop/IOT-MQTT-Exploit/blob/master/mqtt.py
import paho.mqtt.client as mqtt
import time
import os

HOST = "127.0.0.1"
PORT = 1883

def on_connect(client, userdata, flags, rc):
client.subscribe('#', qos=1)
client.subscribe('$SYS/#')

def on_message(client, userdata, message):
print('Topic: %s | QOS: %s  | Message: %s' % (message.topic, message.qos, message.payload))

def main():
client = mqtt.Client()
client.on_connect = on_connect
client.on_message = on_message
client.connect(HOST, PORT)
client.loop_start()
#time.sleep(10)
#client.loop_stop()

if __name__ == "__main__":
main()
```
## æ›´å¤šä¿¡æ¯

ä»è¿™é‡Œè·å–ï¼š[https://morphuslabs.com/hacking-the-iot-with-mqtt-8edaf0d07b9b](https://morphuslabs.com/hacking-the-iot-with-mqtt-8edaf0d07b9b)

### å‘å¸ƒ/è®¢é˜…æ¨¡å¼ <a href="#b667" id="b667"></a>

å‘å¸ƒ/è®¢é˜…æ¨¡å‹ç”±ä»¥ä¸‹ç»„æˆï¼š

- **å‘å¸ƒè€…**ï¼šå‘ä»£ç†å‘å¸ƒæ¶ˆæ¯åˆ°ä¸€ä¸ªï¼ˆæˆ–å¤šä¸ªï¼‰ä¸»é¢˜ã€‚
- **è®¢é˜…è€…**ï¼šè®¢é˜…ä¸€ä¸ªï¼ˆæˆ–å¤šä¸ªï¼‰ä¸»é¢˜åœ¨ä»£ç†ä¸­ï¼Œå¹¶æ¥æ”¶æ‰€æœ‰ä»å‘å¸ƒè€…å‘é€çš„æ¶ˆæ¯ã€‚
- **ä»£ç†**ï¼šå°†æ‰€æœ‰æ¥è‡ªå‘å¸ƒè€…çš„æ¶ˆæ¯è·¯ç”±åˆ°è®¢é˜…è€…ã€‚
- **ä¸»é¢˜**ï¼šç”±ä¸€ä¸ªæˆ–å¤šä¸ªçº§åˆ«ç»„æˆï¼Œçº§åˆ«ä¹‹é—´ç”¨æ–œæ åˆ†éš”ï¼ˆä¾‹å¦‚ï¼Œ/smartshouse/livingroom/temperatureï¼‰ã€‚

### æ•°æ®åŒ…æ ¼å¼ <a href="#f15a" id="f15a"></a>

æ¯ä¸ª MQTT æ•°æ®åŒ…åŒ…å«ä¸€ä¸ªå›ºå®šå¤´éƒ¨ï¼ˆå›¾ 02ï¼‰ã€‚å›¾ 02ï¼šå›ºå®šå¤´éƒ¨

![https://miro.medium.com/max/838/1\*k6RkAHEk0576geQGUcKSTA.png](https://miro.medium.com/max/838/1\*k6RkAHEk0576geQGUcKSTA.png)

### æ•°æ®åŒ…ç±»å‹

- CONNECTï¼ˆ1ï¼‰ï¼šç”±å®¢æˆ·ç«¯å‘èµ·ï¼Œè¯·æ±‚ä¸æœåŠ¡å™¨å»ºç«‹è¿æ¥ã€‚
- CONNACKï¼ˆ2ï¼‰ï¼šæœåŠ¡å™¨å¯¹æˆåŠŸè¿æ¥çš„ç¡®è®¤ã€‚
- PUBLISHï¼ˆ3ï¼‰ï¼šç”¨äºåœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´å‘é€æ¶ˆæ¯ã€‚
- PUBACKï¼ˆ4ï¼‰ï¼šå¯¹ PUBLISH æ•°æ®åŒ…çš„ç¡®è®¤ã€‚
- PUBRECï¼ˆ5ï¼‰ï¼šæ¶ˆæ¯ä¼ é€’åè®®çš„ä¸€éƒ¨åˆ†ï¼Œç¡®ä¿æ¶ˆæ¯å·²æ¥æ”¶ã€‚
- PUBRELï¼ˆ6ï¼‰ï¼šè¿›ä¸€æ­¥ç¡®ä¿æ¶ˆæ¯ä¼ é€’ï¼ŒæŒ‡ç¤ºæ¶ˆæ¯é‡Šæ”¾ã€‚
- PUBCOMPï¼ˆ7ï¼‰ï¼šæ¶ˆæ¯ä¼ é€’åè®®çš„æœ€åéƒ¨åˆ†ï¼ŒæŒ‡ç¤ºå®Œæˆã€‚
- SUBSCRIBEï¼ˆ8ï¼‰ï¼šå®¢æˆ·ç«¯è¯·æ±‚ä»ä¸»é¢˜æ¥æ”¶æ¶ˆæ¯ã€‚
- SUBACKï¼ˆ9ï¼‰ï¼šæœåŠ¡å™¨å¯¹ SUBSCRIBE è¯·æ±‚çš„ç¡®è®¤ã€‚
- UNSUBSCRIBEï¼ˆ10ï¼‰ï¼šå®¢æˆ·ç«¯è¯·æ±‚åœæ­¢ä»ä¸»é¢˜æ¥æ”¶æ¶ˆæ¯ã€‚
- UNSUBACKï¼ˆ11ï¼‰ï¼šæœåŠ¡å™¨å¯¹ UNSUBSCRIBE è¯·æ±‚çš„å“åº”ã€‚
- PINGREQï¼ˆ12ï¼‰ï¼šå®¢æˆ·ç«¯å‘é€çš„å¿ƒè·³æ¶ˆæ¯ã€‚
- PINGRESPï¼ˆ13ï¼‰ï¼šæœåŠ¡å™¨å¯¹å¿ƒè·³æ¶ˆæ¯çš„å“åº”ã€‚
- DISCONNECTï¼ˆ14ï¼‰ï¼šç”±å®¢æˆ·ç«¯å‘èµ·ï¼Œç»ˆæ­¢è¿æ¥ã€‚
- ä¸¤ä¸ªå€¼ï¼Œ0 å’Œ 15ï¼Œè¢«æ ‡è®°ä¸ºä¿ç•™ï¼Œç¦æ­¢ä½¿ç”¨ã€‚

## Shodan

- `port:1883 MQTT`

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS çº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

- å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨ HackTricks ä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½ PDF ç‰ˆæœ¬çš„ HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
- è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
- æ¢ç´¢[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
- **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live) ä¸Š**å…³æ³¨**æˆ‘ä»¬ã€‚
- é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
