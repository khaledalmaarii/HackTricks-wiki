# 1883 - Pentesting MQTT (Mosquitto)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}


## Grundinformationen

**MQ Telemetry Transport (MQTT)** ist bekannt als ein **Publish/Subscribe-Nachrichtenprotokoll**, das sich durch seine extreme Einfachheit und Leichtigkeit auszeichnet. Dieses Protokoll ist speziell f√ºr Umgebungen konzipiert, in denen Ger√§te √ºber begrenzte F√§higkeiten verf√ºgen und √ºber Netzwerke betrieben werden, die durch niedrige Bandbreite, hohe Latenz oder unzuverl√§ssige Verbindungen gekennzeichnet sind. Die Hauptziele von MQTT umfassen die Minimierung der Nutzung der Netzwerkbandbreite und die Reduzierung der Anforderungen an die Ressourcen der Ger√§te. Dar√ºber hinaus zielt es darauf ab, eine zuverl√§ssige Kommunikation aufrechtzuerhalten und ein gewisses Ma√ü an Zustellgarantie zu bieten. Diese Ziele machen MQTT besonders geeignet f√ºr das aufstrebende Feld der **Machine-to-Machine (M2M)-Kommunikation** und des **Internet der Dinge (IoT)**, wo es entscheidend ist, eine Vielzahl von Ger√§ten effizient zu verbinden. Dar√ºber hinaus ist MQTT √§u√üerst vorteilhaft f√ºr mobile Anwendungen, bei denen die Einsparung von Bandbreite und Akkulaufzeit von entscheidender Bedeutung ist.

**Standardport:** 1883
```
PORT     STATE SERVICE                 REASON
1883/tcp open  mosquitto version 1.4.8 syn-ack
```
## Inspecting the traffic

Wenn ein **CONNECT**-Paket von MQTT-Brokern empfangen wird, wird ein **CONNACK**-Paket zur√ºckgesendet. Dieses Paket enth√§lt einen R√ºckgabecode, der entscheidend f√ºr das Verst√§ndnis des Verbindungsstatus ist. Ein R√ºckgabecode von **0x00** bedeutet, dass die Anmeldeinformationen akzeptiert wurden, was eine erfolgreiche Verbindung signalisiert. Andererseits signalisiert ein R√ºckgabecode von **0x05**, dass die Anmeldeinformationen ung√ºltig sind, wodurch die Verbindung verhindert wird.

Zum Beispiel, wenn der Broker die Verbindung aufgrund ung√ºltiger Anmeldeinformationen ablehnt, w√ºrde das Szenario folgenderma√üen aussehen:
```
{
"returnCode": "0x05",
"description": "Connection Refused, not authorized"
}
```
![](<../.gitbook/assets/image (976).png>)

### [**Brute-Force MQTT**](../generic-methodologies-and-resources/brute-force.md#mqtt)

## Pentesting MQTT

**Die Authentifizierung ist v√∂llig optional** und selbst wenn eine Authentifizierung durchgef√ºhrt wird, **wird standardm√§√üig keine Verschl√ºsselung verwendet** (Anmeldeinformationen werden im Klartext gesendet). MITM-Angriffe k√∂nnen weiterhin ausgef√ºhrt werden, um Passw√∂rter zu stehlen.

Um eine Verbindung zu einem MQTT-Dienst herzustellen, k√∂nnen Sie verwenden: [https://github.com/bapowell/python-mqtt-client-shell](https://github.com/bapowell/python-mqtt-client-shell) und sich f√ºr alle Themen anmelden, indem Sie:
```
> connect (NOTICE that you need to indicate before this the params of the connection, by default 127.0.0.1:1883)
> subscribe "#" 1
> subscribe "$SYS/#"
```
Sie k√∂nnen auch verwenden:
```bash
apt-get install mosquitto mosquitto-clients
mosquitto_sub -t 'test/topic' -v #Subscribe to 'test/topic'
mosquitto_sub -h <host-ip> -t "#" -v #Subscribe to ALL topics.
```
Oder Sie k√∂nnten **diesen Code ausf√ºhren, um zu versuchen, sich ohne Authentifizierung mit einem MQTT-Dienst zu verbinden, sich f√ºr jedes Thema anzumelden und sie anzuh√∂ren**:
```python
#This is a modified version of https://github.com/Warflop/IOT-MQTT-Exploit/blob/master/mqtt.py
import paho.mqtt.client as mqtt
import time
import os

HOST = "127.0.0.1"
PORT = 1883

def on_connect(client, userdata, flags, rc):
client.subscribe('#', qos=1)
client.subscribe('$SYS/#')

def on_message(client, userdata, message):
print('Topic: %s | QOS: %s  | Message: %s' % (message.topic, message.qos, message.payload))

def main():
client = mqtt.Client()
client.on_connect = on_connect
client.on_message = on_message
client.connect(HOST, PORT)
client.loop_start()
#time.sleep(10)
#client.loop_stop()

if __name__ == "__main__":
main()
```
## Mehr Informationen

von hier: [https://morphuslabs.com/hacking-the-iot-with-mqtt-8edaf0d07b9b](https://morphuslabs.com/hacking-the-iot-with-mqtt-8edaf0d07b9b)

### Das Publish/Subscribe-Muster <a href="#b667" id="b667"></a>

Das Publish/Subscribe-Modell besteht aus:

* **Publisher**: ver√∂ffentlicht eine Nachricht an ein (oder mehrere) Themen im Broker.
* **Subscriber**: abonniert ein (oder mehrere) Themen im Broker und erh√§lt alle Nachrichten, die vom Publisher gesendet werden.
* **Broker**: leitet alle Nachrichten von den Publishern zu den Subscribern weiter.
* **Thema**: besteht aus einem oder mehreren Ebenen, die durch einen Schr√§gstrich (z. B. /smartshouse/livingroom/temperature) getrennt sind.

### Paketformat <a href="#f15a" id="f15a"></a>

Jedes MQTT-Paket enth√§lt einen festen Header (Abbildung 02). Abbildung 02: Fester Header

![https://miro.medium.com/max/838/1\*k6RkAHEk0576geQGUcKSTA.png](https://miro.medium.com/max/838/1\*k6RkAHEk0576geQGUcKSTA.png)

### Pakettypen

* CONNECT (1): Vom Client initiiert, um eine Verbindung zum Server anzufordern.
* CONNACK (2): Die Best√§tigung des Servers f√ºr eine erfolgreiche Verbindung.
* PUBLISH (3): Wird verwendet, um eine Nachricht vom Client an den Server oder umgekehrt zu senden.
* PUBACK (4): Best√§tigung eines PUBLISH-Pakets.
* PUBREC (5): Teil eines Nachrichten√ºbertragungsprotokolls, das sicherstellt, dass die Nachricht empfangen wird.
* PUBREL (6): Weitere Best√§tigung der Nachrichten√ºbertragung, die eine Nachrichtenfreigabe anzeigt.
* PUBCOMP (7): Letzter Teil des Nachrichten√ºbertragungsprotokolls, der den Abschluss anzeigt.
* SUBSCRIBE (8): Eine Anfrage des Clients, um Nachrichten von einem Thema zu empfangen.
* SUBACK (9): Die Best√§tigung des Servers f√ºr eine SUBSCRIBE-Anfrage.
* UNSUBSCRIBE (10): Eine Anfrage des Clients, um das Empfangen von Nachrichten von einem Thema zu stoppen.
* UNSUBACK (11): Die Antwort des Servers auf eine UNSUBSCRIBE-Anfrage.
* PINGREQ (12): Eine Herzschlagnachricht, die vom Client gesendet wird.
* PINGRESP (13): Die Antwort des Servers auf die Herzschlagnachricht.
* DISCONNECT (14): Vom Client initiiert, um die Verbindung zu beenden.
* Zwei Werte, 0 und 15, sind als reserviert gekennzeichnet und ihre Verwendung ist verboten.

## Shodan

* `port:1883 MQTT`


{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
