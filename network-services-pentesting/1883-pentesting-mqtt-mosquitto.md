# 1883 - Pentesting MQTT (Mosquitto)

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRETPLATU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## WhiteIntel

<figure><img src=".gitbook/assets/image (1224).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io) je **dark-web** pretraÅ¾ivaÄ koji nudi **besplatne** funkcionalnosti za proveru da li je kompanija ili njeni korisnici **kompromitovani** od strane **malvera za kraÄ‘u podataka**.

Primarni cilj WhiteIntel-a je borba protiv preuzimanja naloga i napada ransomware-a koji proizilaze iz malvera za kraÄ‘u informacija.

MoÅ¾ete posetiti njihovu veb lokaciju i isprobati njihovu maÅ¡inu za **besplatno** na:

{% embed url="https://whiteintel.io" %}

---

## Osnovne informacije

**MQ Telemetry Transport (MQTT)** poznat je kao **protokol za razmenu poruka putem objavljivanja/pretplate** koji se istiÄe po svojoj ekstremnoj jednostavnosti i laganoÄ‡i. Ovaj protokol je posebno prilagoÄ‘en za okruÅ¾enja u kojima ureÄ‘aji imaju ograniÄene moguÄ‡nosti i funkcioniÅ¡u preko mreÅ¾a koje se karakteriÅ¡u niskom propusnoÅ¡Ä‡u, visokom latencijom ili nepouzdanim vezama. Osnovni ciljevi MQTT-a ukljuÄuju minimiziranje koriÅ¡Ä‡enja mreÅ¾ne propusnosti i smanjenje zahteva na resurse ureÄ‘aja. Pored toga, cilj mu je odrÅ¾avanje pouzdane komunikacije i pruÅ¾anje odreÄ‘enog nivoa sigurnosti isporuke. Ovi ciljevi Äine MQTT izuzetno pogodnim za rastuÄ‡e polje **komunikacije maÅ¡ina sa maÅ¡inama (M2M)** i **Interneta stvari (IoT)**, gde je esencijalno efikasno povezivanje razliÄitih ureÄ‘aja. Osim toga, MQTT je veoma koristan za mobilne aplikacije, gde je Äuvanje propusnosti i trajanja baterije kljuÄno.

**Podrazumevani port:** 1883
```
PORT     STATE SERVICE                 REASON
1883/tcp open  mosquitto version 1.4.8 syn-ack
```
## Inspekcija saobraÄ‡aja

Kada MQTT posrednici prime paket **CONNECT**, Å¡alju nazad paket **CONNACK**. Ovaj paket sadrÅ¾i kod povratka koji je kljuÄan za razumevanje statusa veze. Kod povratka **0x00** znaÄi da su pristupni podaci prihvaÄ‡eni, Å¡to oznaÄava uspeÅ¡nu vezu. S druge strane, kod povratka **0x05** signalizira da su pristupni podaci nevaÅ¾eÄ‡i, Äime se spreÄava veza.

Na primer, ako posrednik odbije vezu zbog nevaÅ¾eÄ‡ih pristupnih podataka, scenario bi izgledao ovako:
```
{
"returnCode": "0x05",
"description": "Connection Refused, not authorized"
}
```
![](<../.gitbook/assets/image (973).png>)

### [**Brute-Force MQTT**](../generic-methodologies-and-resources/brute-force.md#mqtt)

## Pentesting MQTT

**Autentifikacija je potpuno opcionalna** i Äak i ako se vrÅ¡i autentifikacija, **podrazumevano se ne koristi Å¡ifrovanje** (kredencijali se Å¡alju u Äistom tekstu). MITM napadi i dalje mogu biti izvrÅ¡eni kako bi se ukrali lozinke.

Za povezivanje na MQTT servis moÅ¾ete koristiti: [https://github.com/bapowell/python-mqtt-client-shell](https://github.com/bapowell/python-mqtt-client-shell) i pretplatiti se na sve teme koristeÄ‡i:
```
> connect (NOTICE that you need to indicate before this the params of the connection, by default 127.0.0.1:1883)
> subscribe "#" 1
> subscribe "$SYS/#"
```
MoÅ¾ete koristiti [**https://github.com/akamai-threat-research/mqtt-pwn**](https://github.com/akamai-threat-research/mqtt-pwn)

MoÅ¾ete takoÄ‘e koristiti:
```bash
apt-get install mosquitto mosquitto-clients
mosquitto_sub -t 'test/topic' -v #Subscribe to 'test/topic'
mosquitto_sub -h <host-ip> -t "#" -v #Subscribe to ALL topics.
```
Ili moÅ¾ete **pokrenuti ovaj kod da biste pokuÅ¡ali da se poveÅ¾ete sa MQTT servisom bez autentifikacije, pretplatite se na svaku temu i sluÅ¡ate ih**:
```python
#This is a modified version of https://github.com/Warflop/IOT-MQTT-Exploit/blob/master/mqtt.py
import paho.mqtt.client as mqtt
import time
import os

HOST = "127.0.0.1"
PORT = 1883

def on_connect(client, userdata, flags, rc):
client.subscribe('#', qos=1)
client.subscribe('$SYS/#')

def on_message(client, userdata, message):
print('Topic: %s | QOS: %s  | Message: %s' % (message.topic, message.qos, message.payload))

def main():
client = mqtt.Client()
client.on_connect = on_connect
client.on_message = on_message
client.connect(HOST, PORT)
client.loop_start()
#time.sleep(10)
#client.loop_stop()

if __name__ == "__main__":
main()
```
## ViÅ¡e informacija

sa ovog linka: [https://morphuslabs.com/hacking-the-iot-with-mqtt-8edaf0d07b9b](https://morphuslabs.com/hacking-the-iot-with-mqtt-8edaf0d07b9b)

### Å ema objavljivanja/pretplate <a href="#b667" id="b667"></a>

Model objavljivanja/pretplate sastoji se od:

* **ObjavljivaÄ**: objavljuje poruku na jednu (ili viÅ¡e) temu(u) na brokeru.
* **Pretplatnik**: pretplaÄ‡uje se na jednu (ili viÅ¡e) temu(u) na brokeru i prima sve poruke poslate od objavljivaÄa.
* **Broker**: usmerava sve poruke od objavljivaÄa ka pretplatnicima.
* **Tema**: sastoji se od jednog ili viÅ¡e nivoa koji su odvojeni kosom crtom (npr. /pametna-kuÄ‡a/dnevna-soba/temperatura).

### Format paketa <a href="#f15a" id="f15a"></a>

Svaki MQTT paket sadrÅ¾i fiksni zaglavlje (Slika 02).Slika 02: Fiksno zaglavlje

![https://miro.medium.com/max/838/1\*k6RkAHEk0576geQGUcKSTA.png](https://miro.medium.com/max/838/1\*k6RkAHEk0576geQGUcKSTA.png)

### Vrste paketa

* CONNECT (1): Iniciran od strane klijenta zahtevajuÄ‡i vezu sa serverom.
* CONNACK (2): Potvrda servera o uspeÅ¡noj vezi.
* PUBLISH (3): Koristi se za slanje poruke od klijenta ka serveru ili obrnuto.
* PUBACK (4): Potvrda za PUBLISH paket.
* PUBREC (5): Deo protokola isporuke poruke koji osigurava da je poruka primljena.
* PUBREL (6): Dodatno osiguranje u isporuci poruke, ukazujuÄ‡i na oslobaÄ‘anje poruke.
* PUBCOMP (7): ZavrÅ¡ni deo protokola isporuke poruke, ukazujuÄ‡i na zavrÅ¡etak.
* SUBSCRIBE (8): Zahtev klijenta za sluÅ¡anje poruka sa odreÄ‘ene teme.
* SUBACK (9): Potvrda servera o SUBSCRIBE zahtevu.
* UNSUBSCRIBE (10): Zahtev klijenta za prestanak primanja poruka sa odreÄ‘ene teme.
* UNSUBACK (11): Odgovor servera na UNSUBSCRIBE zahtev.
* PINGREQ (12): Poruka o odrÅ¾avanju veze poslata od strane klijenta.
* PINGRESP (13): Odgovor servera na poruku o odrÅ¾avanju veze.
* DISCONNECT (14): Iniciran od strane klijenta za prekid veze.
* Dve vrednosti, 0 i 15, oznaÄene su kao rezervisane i njihova upotreba je zabranjena.

## Shodan

* `port:1883 MQTT`

## WhiteIntel

<figure><img src=".gitbook/assets/image (1224).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io) je pretraÅ¾ivaÄ na **dubokom webu** koji nudi **besplatne** funkcionalnosti za proveru da li je kompanija ili njeni korisnici **ugroÅ¾eni** od **malvera koji kradu podatke**.

Primarni cilj WhiteIntela je borba protiv preuzimanja naloga i napada ransomvera koji proizilaze iz malvera koji kradu informacije.

MoÅ¾ete posetiti njihovu veb lokaciju i isprobati njihovu maÅ¡inu za **besplatno** na:

{% embed url="https://whiteintel.io" %}

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRETPLATU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
