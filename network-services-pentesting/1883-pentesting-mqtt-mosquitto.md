# 1883 - Pentesting MQTT (Mosquitto)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}


## åŸºæœ¬æƒ…å ±

**MQ Telemetry Transport (MQTT)** ã¯ã€æ¥µã‚ã¦ã‚·ãƒ³ãƒ—ãƒ«ã§è»½é‡ãª**ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ¥/ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒ–ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°ãƒ—ãƒ­ãƒˆã‚³ãƒ«**ã¨ã—ã¦çŸ¥ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã¯ã€ãƒ‡ãƒã‚¤ã‚¹ã®èƒ½åŠ›ãŒé™ã‚‰ã‚Œã¦ã„ã‚‹ç’°å¢ƒã‚„ã€ä½å¸¯åŸŸå¹…ã€é«˜é…å»¶ã€ã¾ãŸã¯ä¿¡é ¼æ€§ã®ä½ã„æ¥ç¶šãŒç‰¹å¾´ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã§å‹•ä½œã™ã‚‹ã‚ˆã†ã«ç‰¹åˆ¥ã«è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚MQTTã®ä¸»ãªç›®çš„ã¯ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å¸¯åŸŸå¹…ã®ä½¿ç”¨ã‚’æœ€å°é™ã«æŠ‘ãˆã€ãƒ‡ãƒã‚¤ã‚¹ãƒªã‚½ãƒ¼ã‚¹ã¸ã®è¦æ±‚ã‚’æ¸›ã‚‰ã™ã“ã¨ã§ã™ã€‚ã•ã‚‰ã«ã€ä¿¡é ¼æ€§ã®ã‚ã‚‹é€šä¿¡ã‚’ç¶­æŒã—ã€ä¸€å®šã®é…ä¿¡ä¿è¨¼ã‚’æä¾›ã™ã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚‰ã®ç›®æ¨™ã«ã‚ˆã‚Šã€MQTTã¯æ€¥æˆé•·ã—ã¦ã„ã‚‹**æ©Ÿæ¢°é–“é€šä¿¡ (M2M)**ãŠã‚ˆã³**ãƒ¢ãƒã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ (IoT)**ã®åˆ†é‡ã«éå¸¸ã«é©ã—ã¦ã„ã¾ã™ã€‚ã“ã“ã§ã¯ã€å¤šæ•°ã®ãƒ‡ãƒã‚¤ã‚¹ã‚’åŠ¹ç‡çš„ã«æ¥ç¶šã™ã‚‹ã“ã¨ãŒä¸å¯æ¬ ã§ã™ã€‚ã•ã‚‰ã«ã€MQTTã¯ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚‚éå¸¸ã«æœ‰ç›Šã§ã‚ã‚Šã€å¸¯åŸŸå¹…ã¨ãƒãƒƒãƒ†ãƒªãƒ¼å¯¿å‘½ã‚’ç¯€ç´„ã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚

**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒ¼ãƒˆ:** 1883
```
PORT     STATE SERVICE                 REASON
1883/tcp open  mosquitto version 1.4.8 syn-ack
```
## ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã®æ¤œæŸ»

MQTTãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼ãŒ**CONNECT**ãƒ‘ã‚±ãƒƒãƒˆã‚’å—ä¿¡ã™ã‚‹ã¨ã€**CONNACK**ãƒ‘ã‚±ãƒƒãƒˆãŒè¿”é€ã•ã‚Œã¾ã™ã€‚ã“ã®ãƒ‘ã‚±ãƒƒãƒˆã«ã¯æ¥ç¶šçŠ¶æ³ã‚’ç†è§£ã™ã‚‹ãŸã‚ã«é‡è¦ãªãƒªã‚¿ãƒ¼ãƒ³ã‚³ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚ãƒªã‚¿ãƒ¼ãƒ³ã‚³ãƒ¼ãƒ‰ãŒ**0x00**ã®å ´åˆã€èªè¨¼æƒ…å ±ãŒå—ã‘å…¥ã‚Œã‚‰ã‚ŒãŸã“ã¨ã‚’æ„å‘³ã—ã€æ¥ç¶šãŒæˆåŠŸã—ãŸã“ã¨ã‚’ç¤ºã—ã¾ã™ã€‚ä¸€æ–¹ã€ãƒªã‚¿ãƒ¼ãƒ³ã‚³ãƒ¼ãƒ‰ãŒ**0x05**ã®å ´åˆã€èªè¨¼æƒ…å ±ãŒç„¡åŠ¹ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã—ã€æ¥ç¶šã‚’é˜²ãã¾ã™ã€‚

ä¾‹ãˆã°ã€ãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼ãŒç„¡åŠ¹ãªèªè¨¼æƒ…å ±ã®ãŸã‚ã«æ¥ç¶šã‚’æ‹’å¦ã—ãŸå ´åˆã€ã‚·ãƒŠãƒªã‚ªã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼š
```
{
"returnCode": "0x05",
"description": "Connection Refused, not authorized"
}
```
![](<../.gitbook/assets/image (976).png>)

### [**ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹MQTT**](../generic-methodologies-and-resources/brute-force.md#mqtt)

## MQTTã®ãƒšãƒ³ãƒ†ã‚¹ãƒˆ

**èªè¨¼ã¯å®Œå…¨ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã™** ãã—ã¦ã€èªè¨¼ãŒè¡Œã‚ã‚Œã¦ã„ã‚‹å ´åˆã§ã‚‚ã€**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯æš—å·åŒ–ã¯ä½¿ç”¨ã•ã‚Œã¾ã›ã‚“**ï¼ˆè³‡æ ¼æƒ…å ±ã¯å¹³æ–‡ã§é€ä¿¡ã•ã‚Œã¾ã™ï¼‰ã€‚MITMæ”»æ’ƒã¯ä¾ç„¶ã¨ã—ã¦å®Ÿè¡Œå¯èƒ½ã§ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç›—ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚

MQTTã‚µãƒ¼ãƒ“ã‚¹ã«æ¥ç¶šã™ã‚‹ã«ã¯ã€æ¬¡ã®ã‚‚ã®ã‚’ä½¿ç”¨ã§ãã¾ã™: [https://github.com/bapowell/python-mqtt-client-shell](https://github.com/bapowell/python-mqtt-client-shell) ãã—ã¦ã€æ¬¡ã®ã‚ˆã†ã«ã—ã¦ã™ã¹ã¦ã®ãƒˆãƒ”ãƒƒã‚¯ã«è‡ªåˆ†ã‚’è³¼èª­ã—ã¾ã™:
```
> connect (NOTICE that you need to indicate before this the params of the connection, by default 127.0.0.1:1883)
> subscribe "#" 1
> subscribe "$SYS/#"
```
ã‚ãªãŸã¯ã¾ãŸã€[**https://github.com/akamai-threat-research/mqtt-pwn**](https://github.com/akamai-threat-research/mqtt-pwn)ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã‚ãªãŸã¯ã¾ãŸã€ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š
```bash
apt-get install mosquitto mosquitto-clients
mosquitto_sub -t 'test/topic' -v #Subscribe to 'test/topic'
mosquitto_sub -h <host-ip> -t "#" -v #Subscribe to ALL topics.
```
ã¾ãŸã¯ã€**ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€èªè¨¼ãªã—ã§MQTTã‚µãƒ¼ãƒ“ã‚¹ã«æ¥ç¶šã—ã€ã™ã¹ã¦ã®ãƒˆãƒ”ãƒƒã‚¯ã«ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒ–ã—ã¦ãã‚Œã‚‰ã‚’ãƒªãƒƒã‚¹ãƒ³ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™**:
```python
#This is a modified version of https://github.com/Warflop/IOT-MQTT-Exploit/blob/master/mqtt.py
import paho.mqtt.client as mqtt
import time
import os

HOST = "127.0.0.1"
PORT = 1883

def on_connect(client, userdata, flags, rc):
client.subscribe('#', qos=1)
client.subscribe('$SYS/#')

def on_message(client, userdata, message):
print('Topic: %s | QOS: %s  | Message: %s' % (message.topic, message.qos, message.payload))

def main():
client = mqtt.Client()
client.on_connect = on_connect
client.on_message = on_message
client.connect(HOST, PORT)
client.loop_start()
#time.sleep(10)
#client.loop_stop()

if __name__ == "__main__":
main()
```
## More information

from here: [https://morphuslabs.com/hacking-the-iot-with-mqtt-8edaf0d07b9b](https://morphuslabs.com/hacking-the-iot-with-mqtt-8edaf0d07b9b)

### The Publish/Subscribe Pattern <a href="#b667" id="b667"></a>

ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ¥/ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒ–ãƒ¢ãƒ‡ãƒ«ã¯ä»¥ä¸‹ã§æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ï¼š

* **Publisher**: ãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼å†…ã®1ã¤ï¼ˆã¾ãŸã¯è¤‡æ•°ï¼‰ã®ãƒˆãƒ”ãƒƒã‚¯ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¬é–‹ã—ã¾ã™ã€‚
* **Subscriber**: ãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼å†…ã®1ã¤ï¼ˆã¾ãŸã¯è¤‡æ•°ï¼‰ã®ãƒˆãƒ”ãƒƒã‚¯ã«ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒ–ã—ã€ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ£ãƒ¼ã‹ã‚‰é€ä¿¡ã•ã‚ŒãŸã™ã¹ã¦ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã—ã¾ã™ã€‚
* **Broker**: ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ£ãƒ¼ã‹ã‚‰ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒãƒ¼ã¸ã®ã™ã¹ã¦ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã—ã¾ã™ã€‚
* **Topic**: ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ï¼ˆ/ï¼‰ã§åŒºåˆ‡ã‚‰ã‚ŒãŸ1ã¤ä»¥ä¸Šã®ãƒ¬ãƒ™ãƒ«ã§æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ï¼ˆä¾‹ï¼š/smartshouse/livingroom/temperatureï¼‰ã€‚

### Packet Format <a href="#f15a" id="f15a"></a>

ã™ã¹ã¦ã®MQTTãƒ‘ã‚±ãƒƒãƒˆã¯å›ºå®šãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å«ã¿ã¾ã™ï¼ˆå›³02ï¼‰ã€‚å›³02: å›ºå®šãƒ˜ãƒƒãƒ€ãƒ¼

![https://miro.medium.com/max/838/1\*k6RkAHEk0576geQGUcKSTA.png](https://miro.medium.com/max/838/1\*k6RkAHEk0576geQGUcKSTA.png)

### Packet Types

* CONNECT (1): ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒã‚µãƒ¼ãƒãƒ¼ã¸ã®æ¥ç¶šã‚’è¦æ±‚ã™ã‚‹ãŸã‚ã«é–‹å§‹ã—ã¾ã™ã€‚
* CONNACK (2): ã‚µãƒ¼ãƒãƒ¼ã®æˆåŠŸã—ãŸæ¥ç¶šã®ç¢ºèªã€‚
* PUBLISH (3): ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã‚µãƒ¼ãƒãƒ¼ã€ã¾ãŸã¯ãã®é€†ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
* PUBACK (4): PUBLISHãƒ‘ã‚±ãƒƒãƒˆã®ç¢ºèªã€‚
* PUBREC (5): ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå—ä¿¡ã•ã‚ŒãŸã“ã¨ã‚’ä¿è¨¼ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é…ä¿¡ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã®ä¸€éƒ¨ã€‚
* PUBREL (6): ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é…ä¿¡ã®ã•ã‚‰ãªã‚‹ä¿è¨¼ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒªãƒªãƒ¼ã‚¹ã‚’ç¤ºã—ã¾ã™ã€‚
* PUBCOMP (7): ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é…ä¿¡ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã®æœ€çµ‚éƒ¨åˆ†ã€å®Œäº†ã‚’ç¤ºã—ã¾ã™ã€‚
* SUBSCRIBE (8): ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒãƒˆãƒ”ãƒƒã‚¯ã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã™ã‚‹ãŸã‚ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã€‚
* SUBACK (9): ã‚µãƒ¼ãƒãƒ¼ã®SUBSCRIBEãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ç¢ºèªã€‚
* UNSUBSCRIBE (10): ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒãƒˆãƒ”ãƒƒã‚¯ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ã‚’åœæ­¢ã™ã‚‹ãŸã‚ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã€‚
* UNSUBACK (11): ã‚µãƒ¼ãƒãƒ¼ã®UNSUBSCRIBEãƒªã‚¯ã‚¨ã‚¹ãƒˆã¸ã®å¿œç­”ã€‚
* PINGREQ (12): ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ã‚ˆã£ã¦é€ä¿¡ã•ã‚Œã‚‹ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€‚
* PINGRESP (13): ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å¯¾ã™ã‚‹ã‚µãƒ¼ãƒãƒ¼ã®å¿œç­”ã€‚
* DISCONNECT (14): ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ã‚ˆã£ã¦æ¥ç¶šã‚’çµ‚äº†ã™ã‚‹ãŸã‚ã«é–‹å§‹ã•ã‚Œã¾ã™ã€‚
* 0ã¨15ã®2ã¤ã®å€¤ã¯äºˆç´„ã•ã‚Œã¦ãŠã‚Šã€ãã®ä½¿ç”¨ã¯ç¦ã˜ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚

## Shodan

* `port:1883 MQTT`


{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
