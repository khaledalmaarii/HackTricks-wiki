# 1883 - Pentesting MQTT (Mosquitto)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}


## åŸºæœ¬ä¿¡æ¯

**MQ Telemetry Transport (MQTT)** è¢«ç§°ä¸º **å‘å¸ƒ/è®¢é˜…æ¶ˆæ¯åè®®**ï¼Œä»¥å…¶æç«¯çš„ç®€å•æ€§å’Œè½»é‡æ€§è€Œè‘—ç§°ã€‚è¯¥åè®®ä¸“é—¨ä¸ºè®¾å¤‡èƒ½åŠ›æœ‰é™ä¸”åœ¨ä½å¸¦å®½ã€é«˜å»¶è¿Ÿæˆ–ä¸å¯é è¿æ¥çš„ç½‘ç»œä¸Šè¿è¡Œçš„ç¯å¢ƒé‡èº«å®šåˆ¶ã€‚MQTTçš„æ ¸å¿ƒç›®æ ‡åŒ…æ‹¬æœ€å°åŒ–ç½‘ç»œå¸¦å®½çš„ä½¿ç”¨å’Œå‡å°‘å¯¹è®¾å¤‡èµ„æºçš„éœ€æ±‚ã€‚æ­¤å¤–ï¼Œå®ƒæ—¨åœ¨ä¿æŒå¯é çš„é€šä¿¡å¹¶æä¾›ä¸€å®šç¨‹åº¦çš„äº¤ä»˜ä¿è¯ã€‚è¿™äº›ç›®æ ‡ä½¿å¾—MQTTç‰¹åˆ«é€‚åˆäºè“¬å‹ƒå‘å±•çš„ **æœºå™¨å¯¹æœºå™¨ (M2M) é€šä¿¡** å’Œ **ç‰©è”ç½‘ (IoT)** é¢†åŸŸï¼Œåœ¨è¿™äº›é¢†åŸŸä¸­ï¼Œé«˜æ•ˆè¿æ¥å¤§é‡è®¾å¤‡è‡³å…³é‡è¦ã€‚æ­¤å¤–ï¼ŒMQTTå¯¹ç§»åŠ¨åº”ç”¨ç¨‹åºä¹Ÿéå¸¸æœ‰åˆ©ï¼Œå› ä¸ºèŠ‚çœå¸¦å®½å’Œç”µæ± å¯¿å‘½è‡³å…³é‡è¦ã€‚

**é»˜è®¤ç«¯å£ï¼š** 1883
```
PORT     STATE SERVICE                 REASON
1883/tcp open  mosquitto version 1.4.8 syn-ack
```
## Inspecting the traffic

å½“ MQTT ä»£ç†æ”¶åˆ° **CONNECT** æ•°æ®åŒ…æ—¶ï¼Œä¼šå‘é€å› **CONNACK** æ•°æ®åŒ…ã€‚è¯¥æ•°æ®åŒ…åŒ…å«ä¸€ä¸ªè¿”å›ä»£ç ï¼Œè¿™å¯¹äºç†è§£è¿æ¥çŠ¶æ€è‡³å…³é‡è¦ã€‚è¿”å›ä»£ç  **0x00** è¡¨ç¤ºå‡­æ®å·²è¢«æ¥å—ï¼Œæ ‡å¿—ç€è¿æ¥æˆåŠŸã€‚å¦ä¸€æ–¹é¢ï¼Œè¿”å›ä»£ç  **0x05** è¡¨ç¤ºå‡­æ®æ— æ•ˆï¼Œä»è€Œé˜»æ­¢è¿æ¥ã€‚

ä¾‹å¦‚ï¼Œå¦‚æœä»£ç†å› å‡­æ®æ— æ•ˆè€Œæ‹’ç»è¿æ¥ï¼Œåˆ™åœºæ™¯å°†å¦‚ä¸‹æ‰€ç¤ºï¼š
```
{
"returnCode": "0x05",
"description": "Connection Refused, not authorized"
}
```
![](<../.gitbook/assets/image (976).png>)

### [**æš´åŠ›ç ´è§£ MQTT**](../generic-methodologies-and-resources/brute-force.md#mqtt)

## æ¸—é€æµ‹è¯• MQTT

**èº«ä»½éªŒè¯æ˜¯å®Œå…¨å¯é€‰çš„**ï¼Œå³ä½¿æ­£åœ¨è¿›è¡Œèº«ä»½éªŒè¯ï¼Œ**é»˜è®¤æƒ…å†µä¸‹ä¸ä½¿ç”¨åŠ å¯†**ï¼ˆå‡­æ®ä»¥æ˜æ–‡å‘é€ï¼‰ã€‚ä»ç„¶å¯ä»¥æ‰§è¡Œ MITM æ”»å‡»ä»¥çªƒå–å¯†ç ã€‚

è¦è¿æ¥åˆ° MQTT æœåŠ¡ï¼Œå¯ä»¥ä½¿ç”¨ï¼š[https://github.com/bapowell/python-mqtt-client-shell](https://github.com/bapowell/python-mqtt-client-shell) å¹¶é€šè¿‡ä»¥ä¸‹æ–¹å¼è®¢é˜…æ‰€æœ‰ä¸»é¢˜ï¼š
```
> connect (NOTICE that you need to indicate before this the params of the connection, by default 127.0.0.1:1883)
> subscribe "#" 1
> subscribe "$SYS/#"
```
æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ [**https://github.com/akamai-threat-research/mqtt-pwn**](https://github.com/akamai-threat-research/mqtt-pwn)

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ï¼š
```bash
apt-get install mosquitto mosquitto-clients
mosquitto_sub -t 'test/topic' -v #Subscribe to 'test/topic'
mosquitto_sub -h <host-ip> -t "#" -v #Subscribe to ALL topics.
```
æˆ–è€…ä½ å¯ä»¥**è¿è¡Œè¿™æ®µä»£ç å°è¯•è¿æ¥åˆ°ä¸€ä¸ªæ²¡æœ‰èº«ä»½éªŒè¯çš„MQTTæœåŠ¡ï¼Œè®¢é˜…æ‰€æœ‰ä¸»é¢˜å¹¶ç›‘å¬å®ƒä»¬**ï¼š
```python
#This is a modified version of https://github.com/Warflop/IOT-MQTT-Exploit/blob/master/mqtt.py
import paho.mqtt.client as mqtt
import time
import os

HOST = "127.0.0.1"
PORT = 1883

def on_connect(client, userdata, flags, rc):
client.subscribe('#', qos=1)
client.subscribe('$SYS/#')

def on_message(client, userdata, message):
print('Topic: %s | QOS: %s  | Message: %s' % (message.topic, message.qos, message.payload))

def main():
client = mqtt.Client()
client.on_connect = on_connect
client.on_message = on_message
client.connect(HOST, PORT)
client.loop_start()
#time.sleep(10)
#client.loop_stop()

if __name__ == "__main__":
main()
```
## æ›´å¤šä¿¡æ¯

æ¥è‡ªè¿™é‡Œ: [https://morphuslabs.com/hacking-the-iot-with-mqtt-8edaf0d07b9b](https://morphuslabs.com/hacking-the-iot-with-mqtt-8edaf0d07b9b)

### å‘å¸ƒ/è®¢é˜…æ¨¡å¼ <a href="#b667" id="b667"></a>

å‘å¸ƒ/è®¢é˜…æ¨¡å‹ç”±ä»¥ä¸‹éƒ¨åˆ†ç»„æˆï¼š

* **å‘å¸ƒè€…**ï¼šå‘ä»£ç†ä¸­çš„ä¸€ä¸ªï¼ˆæˆ–å¤šä¸ªï¼‰ä¸»é¢˜å‘å¸ƒæ¶ˆæ¯ã€‚
* **è®¢é˜…è€…**ï¼šè®¢é˜…ä»£ç†ä¸­çš„ä¸€ä¸ªï¼ˆæˆ–å¤šä¸ªï¼‰ä¸»é¢˜ï¼Œå¹¶æ¥æ”¶æ¥è‡ªå‘å¸ƒè€…çš„æ‰€æœ‰æ¶ˆæ¯ã€‚
* **ä»£ç†**ï¼šå°†æ‰€æœ‰æ¶ˆæ¯ä»å‘å¸ƒè€…è·¯ç”±åˆ°è®¢é˜…è€…ã€‚
* **ä¸»é¢˜**ï¼šç”±ä¸€ä¸ªæˆ–å¤šä¸ªçº§åˆ«ç»„æˆï¼Œçº§åˆ«ä¹‹é—´ç”¨æ–œæ åˆ†éš”ï¼ˆä¾‹å¦‚ï¼Œ/smartshouse/livingroom/temperatureï¼‰ã€‚

### æ•°æ®åŒ…æ ¼å¼ <a href="#f15a" id="f15a"></a>

æ¯ä¸ªMQTTæ•°æ®åŒ…åŒ…å«ä¸€ä¸ªå›ºå®šå¤´ï¼ˆå›¾02ï¼‰ã€‚å›¾02ï¼šå›ºå®šå¤´

![https://miro.medium.com/max/838/1\*k6RkAHEk0576geQGUcKSTA.png](https://miro.medium.com/max/838/1\*k6RkAHEk0576geQGUcKSTA.png)

### æ•°æ®åŒ…ç±»å‹

* CONNECT (1)ï¼šç”±å®¢æˆ·ç«¯å‘èµ·ä»¥è¯·æ±‚ä¸æœåŠ¡å™¨çš„è¿æ¥ã€‚
* CONNACK (2)ï¼šæœåŠ¡å™¨å¯¹æˆåŠŸè¿æ¥çš„ç¡®è®¤ã€‚
* PUBLISH (3)ï¼šç”¨äºå°†æ¶ˆæ¯ä»å®¢æˆ·ç«¯å‘é€åˆ°æœåŠ¡å™¨æˆ–åä¹‹äº¦ç„¶ã€‚
* PUBACK (4)ï¼šå¯¹PUBLISHæ•°æ®åŒ…çš„ç¡®è®¤ã€‚
* PUBREC (5)ï¼šæ¶ˆæ¯ä¼ é€’åè®®çš„ä¸€éƒ¨åˆ†ï¼Œç¡®ä¿æ¶ˆæ¯å·²è¢«æ¥æ”¶ã€‚
* PUBREL (6)ï¼šè¿›ä¸€æ­¥ç¡®ä¿æ¶ˆæ¯ä¼ é€’ï¼ŒæŒ‡ç¤ºæ¶ˆæ¯é‡Šæ”¾ã€‚
* PUBCOMP (7)ï¼šæ¶ˆæ¯ä¼ é€’åè®®çš„æœ€åéƒ¨åˆ†ï¼ŒæŒ‡ç¤ºå®Œæˆã€‚
* SUBSCRIBE (8)ï¼šå®¢æˆ·ç«¯è¯·æ±‚ç›‘å¬æ¥è‡ªæŸä¸ªä¸»é¢˜çš„æ¶ˆæ¯ã€‚
* SUBACK (9)ï¼šæœåŠ¡å™¨å¯¹SUBSCRIBEè¯·æ±‚çš„ç¡®è®¤ã€‚
* UNSUBSCRIBE (10)ï¼šå®¢æˆ·ç«¯è¯·æ±‚åœæ­¢æ¥æ”¶æ¥è‡ªæŸä¸ªä¸»é¢˜çš„æ¶ˆæ¯ã€‚
* UNSUBACK (11)ï¼šæœåŠ¡å™¨å¯¹UNSUBSCRIBEè¯·æ±‚çš„å“åº”ã€‚
* PINGREQ (12)ï¼šå®¢æˆ·ç«¯å‘é€çš„å¿ƒè·³æ¶ˆæ¯ã€‚
* PINGRESP (13)ï¼šæœåŠ¡å™¨å¯¹å¿ƒè·³æ¶ˆæ¯çš„å“åº”ã€‚
* DISCONNECT (14)ï¼šç”±å®¢æˆ·ç«¯å‘èµ·ä»¥ç»ˆæ­¢è¿æ¥ã€‚
* ä¸¤ä¸ªå€¼ï¼Œ0å’Œ15ï¼Œè¢«æ ‡è®°ä¸ºä¿ç•™ï¼Œç¦æ­¢ä½¿ç”¨ã€‚

## Shodan

* `port:1883 MQTT`


{% hint style="success" %}
å­¦ä¹ ä¸å®è·µAWSé»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricksåŸ¹è®­AWSçº¢é˜Ÿä¸“å®¶ï¼ˆARTEï¼‰**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µGCPé»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricksåŸ¹è®­GCPçº¢é˜Ÿä¸“å®¶ï¼ˆGRTEï¼‰**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)æˆ–**åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubåº“æäº¤PRåˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
