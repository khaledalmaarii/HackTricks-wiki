# 1883 - Pentesting MQTT (Mosquitto)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}


## Basic Information

**MQ Telemetry Transport (MQTT)**ëŠ” **ê²Œì‹œ/êµ¬ë… ë©”ì‹œì§• í”„ë¡œí† ì½œ**ë¡œ ì•Œë ¤ì ¸ ìˆìœ¼ë©°, ê·¹ë„ì˜ ë‹¨ìˆœì„±ê³¼ ê²½ëŸ‰ì„±ìœ¼ë¡œ ë‘ë“œëŸ¬ì§‘ë‹ˆë‹¤. ì´ í”„ë¡œí† ì½œì€ ì¥ì¹˜ì˜ ê¸°ëŠ¥ì´ ì œí•œì ì´ê³  ë‚®ì€ ëŒ€ì—­í­, ë†’ì€ ì§€ì—° ì‹œê°„ ë˜ëŠ” ë¶ˆì•ˆì •í•œ ì—°ê²°ì´ íŠ¹ì§•ì¸ ë„¤íŠ¸ì›Œí¬ì—ì„œ ì‘ë™í•˜ëŠ” í™˜ê²½ì— íŠ¹ë³„íˆ ë§ì¶°ì ¸ ìˆìŠµë‹ˆë‹¤. MQTTì˜ í•µì‹¬ ëª©í‘œëŠ” ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­í­ ì‚¬ìš©ì„ ìµœì†Œí™”í•˜ê³  ì¥ì¹˜ ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ìˆ˜ìš”ë¥¼ ì¤„ì´ëŠ” ê²ƒì…ë‹ˆë‹¤. ë˜í•œ, ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” í†µì‹ ì„ ìœ ì§€í•˜ê³  ì¼ì • ìˆ˜ì¤€ì˜ ì „ë‹¬ ë³´ì¥ì„ ì œê³µí•˜ëŠ” ê²ƒì„ ëª©í‘œë¡œ í•©ë‹ˆë‹¤. ì´ëŸ¬í•œ ëª©í‘œëŠ” MQTTë¥¼ **ê¸°ê³„ ê°„ í†µì‹  (M2M)** ë° **ì‚¬ë¬¼ì¸í„°ë„· (IoT)**ì˜ ê¸‰ì„±ì¥í•˜ëŠ” ë¶„ì•¼ì— íŠ¹íˆ ì í•©í•˜ê²Œ ë§Œë“­ë‹ˆë‹¤. ì—¬ê¸°ì„œ ìˆ˜ë§ì€ ì¥ì¹˜ë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ ì—°ê²°í•˜ëŠ” ê²ƒì´ í•„ìˆ˜ì ì…ë‹ˆë‹¤. ê²Œë‹¤ê°€, MQTTëŠ” ëŒ€ì—­í­ê³¼ ë°°í„°ë¦¬ ìˆ˜ëª…ì„ ì ˆì•½í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•œ ëª¨ë°”ì¼ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ë„ ë§¤ìš° ìœ ìš©í•©ë‹ˆë‹¤.

**ê¸°ë³¸ í¬íŠ¸:** 1883
```
PORT     STATE SERVICE                 REASON
1883/tcp open  mosquitto version 1.4.8 syn-ack
```
## íŠ¸ë˜í”½ ê²€ì‚¬

MQTT ë¸Œë¡œì»¤ê°€ **CONNECT** íŒ¨í‚·ì„ ìˆ˜ì‹ í•˜ë©´ **CONNACK** íŒ¨í‚·ì´ ë‹¤ì‹œ ì „ì†¡ë©ë‹ˆë‹¤. ì´ íŒ¨í‚·ì—ëŠ” ì—°ê²° ìƒíƒœë¥¼ ì´í•´í•˜ëŠ” ë° ì¤‘ìš”í•œ ë°˜í™˜ ì½”ë“œê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ë°˜í™˜ ì½”ë“œ **0x00**ì€ ìê²© ì¦ëª…ì´ ìˆ˜ë½ë˜ì—ˆìŒì„ ì˜ë¯¸í•˜ë©°, ì„±ê³µì ì¸ ì—°ê²°ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. ë°˜ë©´, ë°˜í™˜ ì½”ë“œ **0x05**ëŠ” ìê²© ì¦ëª…ì´ ìœ íš¨í•˜ì§€ ì•ŠìŒì„ ë‚˜íƒ€ë‚´ì–´ ì—°ê²°ì„ ë°©ì§€í•©ë‹ˆë‹¤.

ì˜ˆë¥¼ ë“¤ì–´, ë¸Œë¡œì»¤ê°€ ìœ íš¨í•˜ì§€ ì•Šì€ ìê²© ì¦ëª…ìœ¼ë¡œ ì¸í•´ ì—°ê²°ì„ ê±°ë¶€í•˜ëŠ” ê²½ìš°, ì‹œë‚˜ë¦¬ì˜¤ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ë³´ì¼ ê²ƒì…ë‹ˆë‹¤:
```
{
"returnCode": "0x05",
"description": "Connection Refused, not authorized"
}
```
![](<../.gitbook/assets/image (976).png>)

### [**ë¸Œë£¨íŠ¸ í¬ìŠ¤ MQTT**](../generic-methodologies-and-resources/brute-force.md#mqtt)

## MQTT íœí…ŒìŠ¤íŒ…

**ì¸ì¦ì€ ì™„ì „íˆ ì„ íƒ ì‚¬í•­ì…ë‹ˆë‹¤** ê·¸ë¦¬ê³  ì¸ì¦ì´ ìˆ˜í–‰ë˜ê³  ìˆë”ë¼ë„, **ê¸°ë³¸ì ìœ¼ë¡œ ì•”í˜¸í™”ê°€ ì‚¬ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤** (ìê²© ì¦ëª…ì´ í‰ë¬¸ìœ¼ë¡œ ì „ì†¡ë©ë‹ˆë‹¤). MITM ê³µê²©ì„ í†µí•´ ì—¬ì „íˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ í›”ì¹  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

MQTT ì„œë¹„ìŠ¤ì— ì—°ê²°í•˜ë ¤ë©´: [https://github.com/bapowell/python-mqtt-client-shell](https://github.com/bapowell/python-mqtt-client-shell)ì„ ì‚¬ìš©í•˜ê³  ë‹¤ìŒì„ ìˆ˜í–‰í•˜ì—¬ ëª¨ë“  ì£¼ì œì— êµ¬ë…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```
> connect (NOTICE that you need to indicate before this the params of the connection, by default 127.0.0.1:1883)
> subscribe "#" 1
> subscribe "$SYS/#"
```
ë‹¹ì‹ ì€ ë˜í•œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
apt-get install mosquitto mosquitto-clients
mosquitto_sub -t 'test/topic' -v #Subscribe to 'test/topic'
mosquitto_sub -h <host-ip> -t "#" -v #Subscribe to ALL topics.
```
ë˜ëŠ” **ì´ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ì—¬ ì¸ì¦ ì—†ì´ MQTT ì„œë¹„ìŠ¤ì— ì—°ê²°í•˜ê³  ëª¨ë“  ì£¼ì œë¥¼ êµ¬ë…í•˜ì—¬ ìˆ˜ì‹ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**:
```python
#This is a modified version of https://github.com/Warflop/IOT-MQTT-Exploit/blob/master/mqtt.py
import paho.mqtt.client as mqtt
import time
import os

HOST = "127.0.0.1"
PORT = 1883

def on_connect(client, userdata, flags, rc):
client.subscribe('#', qos=1)
client.subscribe('$SYS/#')

def on_message(client, userdata, message):
print('Topic: %s | QOS: %s  | Message: %s' % (message.topic, message.qos, message.payload))

def main():
client = mqtt.Client()
client.on_connect = on_connect
client.on_message = on_message
client.connect(HOST, PORT)
client.loop_start()
#time.sleep(10)
#client.loop_stop()

if __name__ == "__main__":
main()
```
## More information

from here: [https://morphuslabs.com/hacking-the-iot-with-mqtt-8edaf0d07b9b](https://morphuslabs.com/hacking-the-iot-with-mqtt-8edaf0d07b9b)

### The Publish/Subscribe Pattern <a href="#b667" id="b667"></a>

The publish/subscribe model is composed of:

* **Publisher**: ë¸Œë¡œì»¤ì˜ í•˜ë‚˜(ë˜ëŠ” ì—¬ëŸ¬ ê°œ) ì£¼ì œì— ë©”ì‹œì§€ë¥¼ ê²Œì‹œí•©ë‹ˆë‹¤.
* **Subscriber**: ë¸Œë¡œì»¤ì˜ í•˜ë‚˜(ë˜ëŠ” ì—¬ëŸ¬ ê°œ) ì£¼ì œë¥¼ êµ¬ë…í•˜ê³ , í¼ë¸”ë¦¬ì…”ë¡œë¶€í„° ì „ì†¡ëœ ëª¨ë“  ë©”ì‹œì§€ë¥¼ ìˆ˜ì‹ í•©ë‹ˆë‹¤.
* **Broker**: í¼ë¸”ë¦¬ì…”ë¡œë¶€í„° êµ¬ë…ìì—ê²Œ ëª¨ë“  ë©”ì‹œì§€ë¥¼ ë¼ìš°íŒ…í•©ë‹ˆë‹¤.
* **Topic**: ìŠ¬ë˜ì‹œë¡œ êµ¬ë¶„ëœ í•˜ë‚˜ ì´ìƒì˜ ë ˆë²¨ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤ (ì˜ˆ: /smartshouse/livingroom/temperature).

### Packet Format <a href="#f15a" id="f15a"></a>

Every MQTT packet contains a fixed header (Figure 02).Figure 02: Fixed Header

![https://miro.medium.com/max/838/1\*k6RkAHEk0576geQGUcKSTA.png](https://miro.medium.com/max/838/1\*k6RkAHEk0576geQGUcKSTA.png)

### Packet Types

* CONNECT (1): í´ë¼ì´ì–¸íŠ¸ê°€ ì„œë²„ì— ì—°ê²° ìš”ì²­ì„ ì‹œì‘í•©ë‹ˆë‹¤.
* CONNACK (2): ì„œë²„ì˜ ì„±ê³µì ì¸ ì—°ê²°ì— ëŒ€í•œ í™•ì¸ì…ë‹ˆë‹¤.
* PUBLISH (3): í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì„œë²„ë¡œ ë˜ëŠ” ê·¸ ë°˜ëŒ€ë¡œ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤.
* PUBACK (4): PUBLISH íŒ¨í‚·ì— ëŒ€í•œ í™•ì¸ì…ë‹ˆë‹¤.
* PUBREC (5): ë©”ì‹œì§€ê°€ ìˆ˜ì‹ ë˜ì—ˆìŒì„ ë³´ì¥í•˜ëŠ” ë©”ì‹œì§€ ì „ì†¡ í”„ë¡œí† ì½œì˜ ì¼ë¶€ì…ë‹ˆë‹¤.
* PUBREL (6): ë©”ì‹œì§€ ì „ì†¡ì— ëŒ€í•œ ì¶”ê°€ ë³´ì¦ìœ¼ë¡œ, ë©”ì‹œì§€ í•´ì œë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.
* PUBCOMP (7): ë©”ì‹œì§€ ì „ì†¡ í”„ë¡œí† ì½œì˜ ë§ˆì§€ë§‰ ë¶€ë¶„ìœ¼ë¡œ, ì™„ë£Œë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.
* SUBSCRIBE (8): í´ë¼ì´ì–¸íŠ¸ê°€ ì£¼ì œë¡œë¶€í„° ë©”ì‹œì§€ë¥¼ ìˆ˜ì‹ í•˜ê¸° ìœ„í•œ ìš”ì²­ì…ë‹ˆë‹¤.
* SUBACK (9): SUBSCRIBE ìš”ì²­ì— ëŒ€í•œ ì„œë²„ì˜ í™•ì¸ì…ë‹ˆë‹¤.
* UNSUBSCRIBE (10): í´ë¼ì´ì–¸íŠ¸ê°€ ì£¼ì œë¡œë¶€í„° ë©”ì‹œì§€ ìˆ˜ì‹ ì„ ì¤‘ë‹¨í•˜ê¸° ìœ„í•œ ìš”ì²­ì…ë‹ˆë‹¤.
* UNSUBACK (11): UNSUBSCRIBE ìš”ì²­ì— ëŒ€í•œ ì„œë²„ì˜ ì‘ë‹µì…ë‹ˆë‹¤.
* PINGREQ (12): í´ë¼ì´ì–¸íŠ¸ê°€ ì „ì†¡í•˜ëŠ” í•˜íŠ¸ë¹„íŠ¸ ë©”ì‹œì§€ì…ë‹ˆë‹¤.
* PINGRESP (13): í•˜íŠ¸ë¹„íŠ¸ ë©”ì‹œì§€ì— ëŒ€í•œ ì„œë²„ì˜ ì‘ë‹µì…ë‹ˆë‹¤.
* DISCONNECT (14): í´ë¼ì´ì–¸íŠ¸ê°€ ì—°ê²°ì„ ì¢…ë£Œí•˜ê¸° ìœ„í•´ ì‹œì‘í•©ë‹ˆë‹¤.
* ë‘ ê°’, 0ê³¼ 15ëŠ” ì˜ˆì•½ìœ¼ë¡œ í‘œì‹œë˜ë©° ì‚¬ìš©ì´ ê¸ˆì§€ë©ë‹ˆë‹¤.

## Shodan

* `port:1883 MQTT`


{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
