# 3260 - Testowanie penetracyjne protokou iSCSI

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Podstawowe informacje

Z [Wikipedii](https://en.wikipedia.org/wiki/ISCSI):

> W informatyce, **iSCSI** to skr贸t od **Internet Small Computer Systems Interface**, standard oparty na protokole Internet Protocol (IP) do sieciowego przechowywania danych, czcy obiekty przechowywania danych. Zapewnia dostp na poziomie bloku do urzdze przechowywania, przesyajc polecenia SCSI przez sie TCP/IP. iSCSI jest u偶ywane do transferu danych w sieciach lokalnych (LAN), sieciach rozlegych (WAN) lub w Internecie, umo偶liwiajc niezale偶ne od lokalizacji przechowywanie i pobieranie danych.
>
> Protok贸 umo偶liwia klientom (nazywanym inicjatorami) wysyanie polece SCSI (CDB) do urzdze przechowywania (cel贸w) na zdalnych serwerach. Jest to protok贸 sieciowej pamici masowej (SAN), kt贸ry umo偶liwia organizacjom konsolidacj pamici masowej w tablicach pamici, jednoczenie zapewniajc klientom (takim jak serwery baz danych i serwery internetowe) iluzj lokalnie podczonych dysk贸w SCSI. Konkuruje g贸wnie z Fibre Channel, ale w przeciwiestwie do tradycyjnego Fibre Channel, kt贸ry zwykle wymaga dedykowanego okablowania, iSCSI mo偶e by uruchamiane na du偶 odlego przy u偶yciu istniejcej infrastruktury sieciowej.

**Domylny port:** 3260
```
PORT     STATE SERVICE VERSION
3260/tcp open  iscsi?
```
## Wyliczanie

### iSCSI

iSCSI (Internet Small Computer System Interface) to protok贸 komunikacyjny, kt贸ry umo偶liwia przesyanie blok贸w danych midzy serwerem a urzdzeniem pamici masowej. Podczas testowania penetracyjnego, wyliczanie iSCSI mo偶e dostarczy cennych informacji na temat systemu docelowego.

#### Skanowanie port贸w

Aby rozpocz wyliczanie iSCSI, mo偶na rozpocz od skanowania port贸w, aby znale藕 otwarte porty iSCSI. Mo偶na to zrobi za pomoc narzdzi takich jak Nmap, skanujc porty 3260 (domylny port iSCSI).

```plaintext
nmap -p 3260 <adres_IP_docelowego_systemu>
```

#### Wykorzystanie iscsiadm

Po zidentyfikowaniu otwartego portu iSCSI, mo偶na u偶y narzdzia iscsiadm do nawizania poczenia z serwerem iSCSI i uzyskania informacji o dostpnych zasobach.

```plaintext
iscsiadm -m discovery -t sendtargets -p <adres_IP_docelowego_systemu>
```

#### Analiza odpowiedzi

Po wykonaniu powy偶szej komendy, otrzymamy odpowiedzi zawierajce informacje o dostpnych zasobach iSCSI. Mo偶emy przeanalizowa te odpowiedzi, aby uzyska informacje takie jak adresy IP, porty, identyfikatory iSCSI, nazwy zasob贸w itp.

#### Wykorzystanie iscsiadm do nawizania poczenia

Po zidentyfikowaniu interesujcego nas zasobu iSCSI, mo偶emy u偶y narzdzia iscsiadm do nawizania poczenia z tym zasobem.

```plaintext
iscsiadm -m node -T <identyfikator_iSCSI> -p <adres_IP_docelowego_systemu> -l
```

#### Montowanie zasobu iSCSI

Po nawizaniu poczenia z zasobem iSCSI, mo偶emy go zamontowa na naszym systemie operacyjnym.

```plaintext
mount /dev/sdX /mnt
```

Gdzie `/dev/sdX` to urzdzenie iSCSI, kt贸re zostao nawizane, a `/mnt` to cie偶ka montowania.

#### Analiza zasob贸w iSCSI

Po zamontowaniu zasobu iSCSI, mo偶emy przeglda i analizowa zawarto tego zasobu, aby znale藕 cenne informacje lub potencjalne luki w zabezpieczeniach.

### NFS

NFS (Network File System) to protok贸 umo偶liwiajcy udostpnianie plik贸w i katalog贸w midzy systemami operacyjnymi w sieci. Podczas testowania penetracyjnego, wyliczanie NFS mo偶e dostarczy informacji na temat dostpnych zasob贸w NFS i potencjalnych luk w zabezpieczeniach.

#### Skanowanie port贸w

Aby rozpocz wyliczanie NFS, mo偶na rozpocz od skanowania port贸w, aby znale藕 otwarte porty NFS. Mo偶na to zrobi za pomoc narzdzi takich jak Nmap, skanujc porty 111 i 2049 (domylne porty NFS).

```plaintext
nmap -p 111,2049 <adres_IP_docelowego_systemu>
```

#### Wykorzystanie showmount

Po zidentyfikowaniu otwartych port贸w NFS, mo偶na u偶y polecenia showmount, aby uzyska informacje na temat dostpnych zasob贸w NFS.

```plaintext
showmount -e <adres_IP_docelowego_systemu>
```

#### Analiza odpowiedzi

Po wykonaniu powy偶szej komendy, otrzymamy odpowiedzi zawierajce informacje o dostpnych zasobach NFS. Mo偶emy przeanalizowa te odpowiedzi, aby uzyska informacje takie jak cie偶ki dostpu, uprawnienia, nazwy zasob贸w itp.

#### Montowanie zasobu NFS

Po zidentyfikowaniu interesujcego nas zasobu NFS, mo偶emy go zamontowa na naszym systemie operacyjnym.

```plaintext
mount -t nfs <adres_IP_docelowego_systemu>:<cie偶ka_zasobu> /mnt
```

Gdzie `<adres_IP_docelowego_systemu>` to adres IP systemu docelowego, a `<cie偶ka_zasobu>` to cie偶ka dostpu do zasobu NFS.

#### Analiza zasob贸w NFS

Po zamontowaniu zasobu NFS, mo偶emy przeglda i analizowa zawarto tego zasobu, aby znale藕 cenne informacje lub potencjalne luki w zabezpieczeniach.
```
nmap -sV --script=iscsi-info -p 3260 192.168.xx.xx
```
Ten skrypt wska偶e, czy wymagane jest uwierzytelnienie.

### [Brute force](../generic-methodologies-and-resources/brute-force.md#iscsi)

### [Montowanie ISCSI w systemie Linux](https://www.synology.com/en-us/knowledgebase/DSM/tutorial/Virtualization/How\_to\_set\_up\_and\_use\_iSCSI\_target\_on\_Linux)

**Uwaga:** Mo偶e si zdarzy, 偶e gdy twoje cele zostan odkryte, zostan one wymienione pod innym adresem IP. Zdarza si to, gdy usuga iSCSI jest wystawiona przez NAT lub wirtualny adres IP. W takich przypadkach `iscsiadmin` nie bdzie w stanie si poczy. Wymaga to dw贸ch zmian: jednej w nazwie katalogu wza automatycznie utworzonego podczas dziaa odkrywania, oraz jednej w pliku `default` znajdujcym si w tym katalogu.

Na przykad, pr贸bujesz poczy si z docelowym iSCSI o adresie 123.123.123.123 na porcie 3260. Serwer wystawiajcy docelowy iSCSI jest faktycznie pod adresem 192.168.1.2, ale jest wystawiony przez NAT. isciadm zarejestruje adres _wewntrzny_ zamiast adresu _publicznego_:
```
iscsiadm -m discovery -t sendtargets -p 123.123.123.123:3260
192.168.1.2:3260,1 iqn.1992-05.com.emc:fl1001433000190000-3-vnxe
[...]
```
To polecenie utworzy katalog w systemie plik贸w w ten spos贸b:
```
/etc/iscsi/nodes/iqn.1992-05.com.emc:fl1001433000190000-3-vnxe/192.168.1.2\,3260\,1/
```
W katalogu znajduje si domylny plik z wszystkimi ustawieniami niezbdnymi do poczenia z celem.

1. Zmie nazw `/etc/iscsi/nodes/iqn.1992-05.com.emc:fl1001433000190000-3-vnxe/192.168.1.2\,3260\,1/` na `/etc/iscsi/nodes/iqn.1992-05.com.emc:fl1001433000190000-3-vnxe/123.123.123.123\,3260\,1/`
2. W pliku `/etc/iscsi/nodes/iqn.1992-05.com.emc:fl1001433000190000-3-vnxe/123.123.123.123\,3260\,1/default` zmie ustawienie `node.conn[0].address`, aby wskazywao na 123.123.123.123 zamiast 192.168.1.2. Mo偶na to zrobi za pomoc polecenia `sed -i 's/192.168.1.2/123.123.123.123/g' /etc/iscsi/nodes/iqn.1992-05.com.emc:fl1001433000190000-3-vnxe/123.123.123.123\,3260\,1/default`

Teraz mo偶na zamontowa cel zgodnie z instrukcjami pod linkiem.

### [Zamontuj ISCSI w systemie Windows](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/ee338476\(v=ws.10\)?redirectedfrom=MSDN)

## **Rczne wyliczanie**
```bash
sudo apt-get install open-iscsi
```
Przykad z [dokumentacj iscsiadm](https://ptestmethod.readthedocs.io/en/latest/LFF-IPS-P2-VulnerabilityAnalysis.html#iscsiadm):

Po pierwsze, musisz **odkry nazw celu** za pomoc adresu IP:
```bash
iscsiadm -m discovery -t sendtargets -p 123.123.123.123:3260
123.123.123.123:3260,1 iqn.1992-05.com.emc:fl1001433000190000-3-vnxe
[2a01:211:7b7:1223:211:32ff:fea9:fab9]:3260,1 iqn.2000-01.com.synology:asd3.Target-1.d0280fd382
[fe80::211:3232:fab9:1223]:3260,1 iqn.2000-01.com.synology:Oassdx.Target-1.d0280fd382
```
_Nale偶y zauwa偶y, 偶e zostan wywietlone I**P i porty interfejs贸w**, na kt贸rych mo偶na **osign** te **cele**. Mo偶e nawet **pokaza wewntrzne IP lub inne IP** ni偶 to, kt贸re zostao u偶yte._

Nastpnie **przechwytujesz drug cz wydrukowanego cigu znak贸w z ka偶dej linii** (_iqn.1992-05.com.emc:fl1001433000190000-3-vnxe_ z pierwszej linii) i **pr贸bujesz si zalogowa**:
```bash
iscsiadm -m node --targetname="iqn.1992-05.com.emc:fl1001433000190000-3-vnxe" -p 123.123.123.123:3260 --login
Logging in to [iface: default, target: iqn.1992-05.com.emc:fl1001433000190000-3-vnxe, portal: 123.123.123.123,3260] (multiple)
Login to [iface: default, target: iqn.1992-05.com.emc:fl1001433000190000-3-vnxe, portal: 123.123.123.123,3260] successful.
```
Nastpnie mo偶esz **wylogowa si** u偶ywajc `logout`
```bash
iscsiadm -m node --targetname="iqn.1992-05.com.emc:fl1001433000190000-3-vnxe" -p 123.123.123.123:3260 --logout
Logging out of session [sid: 6, target: iqn.1992-05.com.emc:fl1001433000190000-3-vnxe, portal: 123.123.123.123,3260]
Logout of [sid: 6, target: iqn.1992-05.com.emc:fl1001433000190000-3-vnxe, portal: 123.123.123.123,3260] successful.
```
Mo偶emy znale藕 **wicej informacji** na ten temat, u偶ywajc jedynie **bez** jakichkolwiek parametr贸w `--login`/`--logout`.
```bash
iscsiadm -m node --targetname="iqn.1992-05.com.emc:fl1001433000190000-3-vnxe" -p 123.123.123.123:3260
# BEGIN RECORD 2.0-873
node.name = iqn.1992-05.com.emc:fl1001433000190000-3-vnxe
node.tpgt = 1
node.startup = manual
node.leading_login = No
iface.hwaddress = <empty>
iface.ipaddress = <empty>
iface.iscsi_ifacename = default
iface.net_ifacename = <empty>
iface.transport_name = tcp
iface.initiatorname = <empty>
iface.bootproto = <empty>
iface.subnet_mask = <empty>
iface.gateway = <empty>
iface.ipv6_autocfg = <empty>
iface.linklocal_autocfg = <empty>
iface.router_autocfg = <empty>
iface.ipv6_linklocal = <empty>
iface.ipv6_router = <empty>
iface.state = <empty>
iface.vlan_id = 0
iface.vlan_priority = 0
iface.vlan_state = <empty>
iface.iface_num = 0
iface.mtu = 0
iface.port = 0
node.discovery_address = 192.168.xx.xx
node.discovery_port = 3260
node.discovery_type = send_targets
node.session.initial_cmdsn = 0
node.session.initial_login_retry_max = 8
node.session.xmit_thread_priority = -20
node.session.cmds_max = 128
node.session.queue_depth = 32
node.session.nr_sessions = 1
node.session.auth.authmethod = None
node.session.auth.username = <empty>
node.session.auth.password = <empty>
node.session.auth.username_in = <empty>
node.session.auth.password_in = <empty>
node.session.timeo.replacement_timeout = 120
node.session.err_timeo.abort_timeout = 15
node.session.err_timeo.lu_reset_timeout = 30
node.session.err_timeo.tgt_reset_timeout = 30
node.session.err_timeo.host_reset_timeout = 60
node.session.iscsi.FastAbort = Yes
node.session.iscsi.InitialR2T = No
node.session.iscsi.ImmediateData = Yes
node.session.iscsi.FirstBurstLength = 262144
node.session.iscsi.MaxBurstLength = 16776192
node.session.iscsi.DefaultTime2Retain = 0
node.session.iscsi.DefaultTime2Wait = 2
node.session.iscsi.MaxConnections = 1
node.session.iscsi.MaxOutstandingR2T = 1
node.session.iscsi.ERL = 0
node.conn[0].address = 192.168.xx.xx
node.conn[0].port = 3260
node.conn[0].startup = manual
node.conn[0].tcp.window_size = 524288
node.conn[0].tcp.type_of_service = 0
node.conn[0].timeo.logout_timeout = 15
node.conn[0].timeo.login_timeout = 15
node.conn[0].timeo.auth_timeout = 45
node.conn[0].timeo.noop_out_interval = 5
node.conn[0].timeo.noop_out_timeout = 5
node.conn[0].iscsi.MaxXmitDataSegmentLength = 0
node.conn[0].iscsi.MaxRecvDataSegmentLength = 262144
node.conn[0].iscsi.HeaderDigest = None
node.conn[0].iscsi.DataDigest = None
node.conn[0].iscsi.IFMarker = No
node.conn[0].iscsi.OFMarker = No
# END RECORD
```
**Istnieje skrypt do automatyzacji podstawowego procesu wyliczania podsieci dostpny na** [**iscsiadm**](https://github.com/bitvijays/Pentest-Scripts/tree/master/Vulnerability\_Analysis/isciadm)

## **Shodan**

* `port:3260 AuthMethod`

## **References**

* [https://bitvijays.github.io/LFF-IPS-P2-VulnerabilityAnalysis.html](https://bitvijays.github.io/LFF-IPS-P2-VulnerabilityAnalysis.html)
* [https://ptestmethod.readthedocs.io/en/latest/LFF-IPS-P2-VulnerabilityAnalysis.html#iscsiadm](https://ptestmethod.readthedocs.io/en/latest/LFF-IPS-P2-VulnerabilityAnalysis.html#iscsiadm)

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
