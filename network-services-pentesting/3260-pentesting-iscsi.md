# 3260 - Pentestiranje iSCSI

<details>

<summary><strong>Nauƒçite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naƒçini podr≈°ke HackTricks-u:

* Ako ≈æelite da vidite **va≈°u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniƒçni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na≈°u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru≈æite se** üí¨ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Osnovne informacije

Sa [Wikipedia](https://en.wikipedia.org/wiki/ISCSI):

> U raƒçunarstvu, **iSCSI** je akronim za **Internet Small Computer Systems Interface**, standard za umre≈æavanje skladi≈°ta zasnovan na Internet protokolu (IP) za povezivanje skladi≈°nih objekata. Pru≈æa pristup skladi≈°nim ureƒëajima na nivou bloka preko TCP/IP mre≈æe. iSCSI se koristi za olak≈°avanje prenosa podataka preko intraneta i upravljanje skladi≈°tem na velikim udaljenostima. Mo≈æe se koristiti za prenos podataka preko lokalnih mre≈æa (LAN), ≈°irokopojasnih mre≈æa (WAN) ili Interneta i omoguƒáava skladi≈°tenje i dohvat podataka nezavisno od lokacije.
>
> Protokol omoguƒáava klijentima (nazvanim inicijatorima) da ≈°alju SCSI komande (CDB) ureƒëajima za skladi≈°tenje (ciljevima) na udaljenim serverima. To je protokol za skladi≈°tenje na mre≈æi (SAN), koji omoguƒáava organizacijama da konsoliduju skladi≈°te u skladi≈°ne nizove, pru≈æajuƒái klijentima (kao ≈°to su baze podataka i veb serveri) iluziju lokalno povezanih SCSI diskova. Glavna konkurencija mu je Fibre Channel, ali za razliku od tradicionalnog Fibre Channel-a koji obiƒçno zahteva posebne kablove, iSCSI se mo≈æe pokretati na velikim udaljenostima koristeƒái postojeƒáu mre≈ænu infrastrukturu.

**Podrazumevani port:** 3260
```
PORT     STATE SERVICE VERSION
3260/tcp open  iscsi?
```
## Enumeracija

### iSCSI (Internet Small Computer System Interface)

iSCSI je standardni protokol za prenos blok podataka preko IP mre≈æe. Koristi se za povezivanje i upravljanje skladi≈°tima podataka na daljinu. Da biste zapoƒçeli proces penetracije iSCSI servisa, prvo morate izvr≈°iti enumeraciju kako biste identifikovali dostupne mete i otkrili potencijalne slabosti.

#### Portovi

iSCSI koristi dva glavna TCP/IP porta:

- Port 860: Standardni port za iSCSI servis
- Port 3260: Alternativni port za iSCSI servis

#### Identifikacija mete

Da biste identifikovali mete iSCSI servisa, mo≈æete koristiti razliƒçite metode:

- Skeniranje otvorenih portova: Skenirajte ciljnu IP adresu kako biste prona≈°li otvorene portove 860 i 3260.
- Snifiranje mre≈æe: Snimajte mre≈æni saobraƒáaj kako biste identifikovali iSCSI pakete koji se razmenjuju izmeƒëu klijenta i servera.

#### Otkrivanje servisa

Nakon identifikacije otvorenih portova iSCSI servisa, mo≈æete koristiti razliƒçite alate za otkrivanje servisa kako biste dobili vi≈°e informacija o meti:

- `nmap`: Koristite nmap sa opcijom `-p` da biste skenirali otvorene portove iSCSI servisa.
- `iscsiadm`: Koristite iscsiadm alat za otkrivanje iSCSI servisa i dobijanje informacija o njima.

#### Identifikacija metapodataka

Kada otkrijete iSCSI servis, mo≈æete koristiti razliƒçite metode za identifikaciju metapodataka:

- `iscsiadm`: Koristite iscsiadm alat za prikupljanje informacija o metapodacima iSCSI servisa.
- `Wireshark`: Snimajte mre≈æni saobraƒáaj i koristite Wireshark za analizu iSCSI paketa kako biste dobili informacije o metapodacima.

#### Identifikacija korisnika

Da biste identifikovali korisnike iSCSI servisa, mo≈æete koristiti razliƒçite metode:

- `iscsiadm`: Koristite iscsiadm alat za prikupljanje informacija o korisnicima iSCSI servisa.
- `Wireshark`: Snimajte mre≈æni saobraƒáaj i koristite Wireshark za analizu iSCSI paketa kako biste dobili informacije o korisnicima.

#### Identifikacija ciljeva

Da biste identifikovali ciljeve iSCSI servisa, mo≈æete koristiti razliƒçite metode:

- `iscsiadm`: Koristite iscsiadm alat za prikupljanje informacija o ciljevima iSCSI servisa.
- `Wireshark`: Snimajte mre≈æni saobraƒáaj i koristite Wireshark za analizu iSCSI paketa kako biste dobili informacije o ciljevima.

#### Identifikacija LUN-ova

Da biste identifikovali LUN-ove (Logical Unit Numbers) iSCSI servisa, mo≈æete koristiti razliƒçite metode:

- `iscsiadm`: Koristite iscsiadm alat za prikupljanje informacija o LUN-ovima iSCSI servisa.
- `Wireshark`: Snimajte mre≈æni saobraƒáaj i koristite Wireshark za analizu iSCSI paketa kako biste dobili informacije o LUN-ovima.

#### Identifikacija CHAP autentifikacije

Da biste identifikovali CHAP (Challenge-Handshake Authentication Protocol) autentifikaciju iSCSI servisa, mo≈æete koristiti razliƒçite metode:

- `iscsiadm`: Koristite iscsiadm alat za prikupljanje informacija o CHAP autentifikaciji iSCSI servisa.
- `Wireshark`: Snimajte mre≈æni saobraƒáaj i koristite Wireshark za analizu iSCSI paketa kako biste dobili informacije o CHAP autentifikaciji.

#### Identifikacija ACL-ova

Da biste identifikovali ACL-ove (Access Control Lists) iSCSI servisa, mo≈æete koristiti razliƒçite metode:

- `iscsiadm`: Koristite iscsiadm alat za prikupljanje informacija o ACL-ovima iSCSI servisa.
- `Wireshark`: Snimajte mre≈æni saobraƒáaj i koristite Wireshark za analizu iSCSI paketa kako biste dobili informacije o ACL-ovima.

#### Identifikacija servisnih parametara

Da biste identifikovali servisne parametre iSCSI servisa, mo≈æete koristiti razliƒçite metode:

- `iscsiadm`: Koristite iscsiadm alat za prikupljanje informacija o servisnim parametrima iSCSI servisa.
- `Wireshark`: Snimajte mre≈æni saobraƒáaj i koristite Wireshark za analizu iSCSI paketa kako biste dobili informacije o servisnim parametrima.
```
nmap -sV --script=iscsi-info -p 3260 192.168.xx.xx
```
Ovaj skript ƒáe pokazati da li je potrebna autentifikacija.

### [Brute force](../generic-methodologies-and-resources/brute-force.md#iscsi)

### [Montiranje ISCSI na Linuxu](https://www.synology.com/en-us/knowledgebase/DSM/tutorial/Virtualization/How\_to\_set\_up\_and\_use\_iSCSI\_target\_on\_Linux)

**Napomena:** Mo≈æe se desiti da kada se otkriju ciljevi, oni budu navedeni pod drugom IP adresom. Ovo se obiƒçno de≈°ava ako je iSCSI servis izlo≈æen putem NAT-a ili virtuelne IP adrese. U takvim sluƒçajevima, `iscsiadmin` neƒáe uspeti da se pove≈æe. Potrebne su dve izmene: jedna u imenu direktorijuma ƒçvorova koji su automatski kreirani tokom otkrivanja, i druga u `default` fajlu koji se nalazi unutar ovog direktorijuma.

Na primer, poku≈°avate da se pove≈æete sa iSCSI ciljem na adresi 123.123.123.123 na portu 3260. Server koji izla≈æe iSCSI cilj je zapravo na adresi 192.168.1.2, ali je izlo≈æen putem NAT-a. isciadm ƒáe registrovati _internu_ adresu umesto _javne_ adrese:
```
iscsiadm -m discovery -t sendtargets -p 123.123.123.123:3260
192.168.1.2:3260,1 iqn.1992-05.com.emc:fl1001433000190000-3-vnxe
[...]
```
Ova komanda ƒáe kreirati direktorijum u va≈°em fajl sistemu na sledeƒái naƒçin:
```
/etc/iscsi/nodes/iqn.1992-05.com.emc:fl1001433000190000-3-vnxe/192.168.1.2\,3260\,1/
```
Unutar direktorijuma se nalazi podrazumevani fajl sa svim pode≈°avanjima potrebnim za povezivanje sa ciljem.

1. Preimenuj `/etc/iscsi/nodes/iqn.1992-05.com.emc:fl1001433000190000-3-vnxe/192.168.1.2\,3260\,1/` u `/etc/iscsi/nodes/iqn.1992-05.com.emc:fl1001433000190000-3-vnxe/123.123.123.123\,3260\,1/`
2. U fajlu `/etc/iscsi/nodes/iqn.1992-05.com.emc:fl1001433000190000-3-vnxe/123.123.123.123\,3260\,1/default`, promenite pode≈°avanje `node.conn[0].address` tako da pokazuje na 123.123.123.123 umesto 192.168.1.2. Ovo se mo≈æe uraditi komandom poput `sed -i 's/192.168.1.2/123.123.123.123/g' /etc/iscsi/nodes/iqn.1992-05.com.emc:fl1001433000190000-3-vnxe/123.123.123.123\,3260\,1/default`

Sada mo≈æete montirati cilj prema uputstvima u linku.

### [Montiranje ISCSI na Windows-u](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/ee338476\(v=ws.10\)?redirectedfrom=MSDN)

## **Ruƒçno nabrojavanje**
```bash
sudo apt-get install open-iscsi
```
Prvo ≈°to trebate uraditi je **otkriti imena ciljeva** iza IP adrese:
```bash
iscsiadm -m discovery -t sendtargets -p 123.123.123.123:3260
123.123.123.123:3260,1 iqn.1992-05.com.emc:fl1001433000190000-3-vnxe
[2a01:211:7b7:1223:211:32ff:fea9:fab9]:3260,1 iqn.2000-01.com.synology:asd3.Target-1.d0280fd382
[fe80::211:3232:fab9:1223]:3260,1 iqn.2000-01.com.synology:Oassdx.Target-1.d0280fd382
```
_Napomena da ƒáe prikazati I**P i port interfejsa** na kojima mo≈æete **dostiƒái** te **mete**. Mo≈æe ƒçak prikazati i interne IP adrese ili razliƒçite IP adrese od one koju ste koristili._

Zatim **uhvatite drugi deo ispisane niske svake linije** (_iqn.1992-05.com.emc:fl1001433000190000-3-vnxe_ sa prve linije) i **poku≈°ajte se prijaviti**:
```bash
iscsiadm -m node --targetname="iqn.1992-05.com.emc:fl1001433000190000-3-vnxe" -p 123.123.123.123:3260 --login
Logging in to [iface: default, target: iqn.1992-05.com.emc:fl1001433000190000-3-vnxe, portal: 123.123.123.123,3260] (multiple)
Login to [iface: default, target: iqn.1992-05.com.emc:fl1001433000190000-3-vnxe, portal: 123.123.123.123,3260] successful.
```
Zatim, mo≈æete **odjaviti se** koristeƒái `‚Äìlogout`
```bash
iscsiadm -m node --targetname="iqn.1992-05.com.emc:fl1001433000190000-3-vnxe" -p 123.123.123.123:3260 --logout
Logging out of session [sid: 6, target: iqn.1992-05.com.emc:fl1001433000190000-3-vnxe, portal: 123.123.123.123,3260]
Logout of [sid: 6, target: iqn.1992-05.com.emc:fl1001433000190000-3-vnxe, portal: 123.123.123.123,3260] successful.
```
Mo≈æemo pronaƒái **vi≈°e informacija** o tome samo kori≈°ƒáenjem **bez** bilo kakvog parametra `--login`/`--logout`.
```bash
iscsiadm -m node --targetname="iqn.1992-05.com.emc:fl1001433000190000-3-vnxe" -p 123.123.123.123:3260
# BEGIN RECORD 2.0-873
node.name = iqn.1992-05.com.emc:fl1001433000190000-3-vnxe
node.tpgt = 1
node.startup = manual
node.leading_login = No
iface.hwaddress = <empty>
iface.ipaddress = <empty>
iface.iscsi_ifacename = default
iface.net_ifacename = <empty>
iface.transport_name = tcp
iface.initiatorname = <empty>
iface.bootproto = <empty>
iface.subnet_mask = <empty>
iface.gateway = <empty>
iface.ipv6_autocfg = <empty>
iface.linklocal_autocfg = <empty>
iface.router_autocfg = <empty>
iface.ipv6_linklocal = <empty>
iface.ipv6_router = <empty>
iface.state = <empty>
iface.vlan_id = 0
iface.vlan_priority = 0
iface.vlan_state = <empty>
iface.iface_num = 0
iface.mtu = 0
iface.port = 0
node.discovery_address = 192.168.xx.xx
node.discovery_port = 3260
node.discovery_type = send_targets
node.session.initial_cmdsn = 0
node.session.initial_login_retry_max = 8
node.session.xmit_thread_priority = -20
node.session.cmds_max = 128
node.session.queue_depth = 32
node.session.nr_sessions = 1
node.session.auth.authmethod = None
node.session.auth.username = <empty>
node.session.auth.password = <empty>
node.session.auth.username_in = <empty>
node.session.auth.password_in = <empty>
node.session.timeo.replacement_timeout = 120
node.session.err_timeo.abort_timeout = 15
node.session.err_timeo.lu_reset_timeout = 30
node.session.err_timeo.tgt_reset_timeout = 30
node.session.err_timeo.host_reset_timeout = 60
node.session.iscsi.FastAbort = Yes
node.session.iscsi.InitialR2T = No
node.session.iscsi.ImmediateData = Yes
node.session.iscsi.FirstBurstLength = 262144
node.session.iscsi.MaxBurstLength = 16776192
node.session.iscsi.DefaultTime2Retain = 0
node.session.iscsi.DefaultTime2Wait = 2
node.session.iscsi.MaxConnections = 1
node.session.iscsi.MaxOutstandingR2T = 1
node.session.iscsi.ERL = 0
node.conn[0].address = 192.168.xx.xx
node.conn[0].port = 3260
node.conn[0].startup = manual
node.conn[0].tcp.window_size = 524288
node.conn[0].tcp.type_of_service = 0
node.conn[0].timeo.logout_timeout = 15
node.conn[0].timeo.login_timeout = 15
node.conn[0].timeo.auth_timeout = 45
node.conn[0].timeo.noop_out_interval = 5
node.conn[0].timeo.noop_out_timeout = 5
node.conn[0].iscsi.MaxXmitDataSegmentLength = 0
node.conn[0].iscsi.MaxRecvDataSegmentLength = 262144
node.conn[0].iscsi.HeaderDigest = None
node.conn[0].iscsi.DataDigest = None
node.conn[0].iscsi.IFMarker = No
node.conn[0].iscsi.OFMarker = No
# END RECORD
```
**Postoji skripta za automatizaciju osnovnog procesa enumeracije podmre≈æe dostupna na** [**iscsiadm**](https://github.com/bitvijays/Pentest-Scripts/tree/master/Vulnerability\_Analysis/isciadm)

## **Shodan**

* `port:3260 AuthMethod`

## **Reference**

* [https://bitvijays.github.io/LFF-IPS-P2-VulnerabilityAnalysis.html](https://bitvijays.github.io/LFF-IPS-P2-VulnerabilityAnalysis.html)
* [https://ptestmethod.readthedocs.io/en/latest/LFF-IPS-P2-VulnerabilityAnalysis.html#iscsiadm](https://ptestmethod.readthedocs.io/en/latest/LFF-IPS-P2-VulnerabilityAnalysis.html#iscsiadm)

<details>

<summary><strong>Nauƒçite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naƒçini podr≈°ke HackTricks-u:

* Ako ≈æelite da vidite **va≈°u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniƒçni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na≈°u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru≈æite se** üí¨ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
