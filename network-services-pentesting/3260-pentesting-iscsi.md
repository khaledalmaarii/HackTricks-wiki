# 3260 - Pentesting ISCSI

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

æ¥è‡ª [ç»´åŸºç™¾ç§‘](https://en.wikipedia.org/wiki/ISCSI):

> åœ¨è®¡ç®—ä¸­ï¼Œ**iSCSI** æ˜¯ **äº’è”ç½‘å°å‹è®¡ç®—æœºç³»ç»Ÿæ¥å£** çš„ç¼©å†™ï¼Œæ˜¯ä¸€ç§åŸºäºäº’è”ç½‘åè®® (IP) çš„å­˜å‚¨ç½‘ç»œæ ‡å‡†ï¼Œç”¨äºè¿æ¥æ•°æ®å­˜å‚¨è®¾æ–½ã€‚å®ƒé€šè¿‡åœ¨ TCP/IP ç½‘ç»œä¸Šä¼ è¾“ SCSI å‘½ä»¤æä¾›å¯¹å­˜å‚¨è®¾å¤‡çš„å—çº§è®¿é—®ã€‚iSCSI ç”¨äºä¿ƒè¿›é€šè¿‡å†…éƒ¨ç½‘çš„æ•°æ®ä¼ è¾“ï¼Œå¹¶ç®¡ç†è¿œç¨‹å­˜å‚¨ã€‚å®ƒå¯ä»¥ç”¨äºåœ¨å±€åŸŸç½‘ (LAN)ã€å¹¿åŸŸç½‘ (WAN) æˆ–äº’è”ç½‘ä¸­ä¼ è¾“æ•°æ®ï¼Œå¹¶å¯ä»¥å®ç°ä½ç½®æ— å…³çš„æ•°æ®å­˜å‚¨å’Œæ£€ç´¢ã€‚
>
> è¯¥åè®®å…è®¸å®¢æˆ·ç«¯ï¼ˆç§°ä¸ºå‘èµ·è€…ï¼‰å‘è¿œç¨‹æœåŠ¡å™¨ä¸Šçš„å­˜å‚¨è®¾å¤‡ï¼ˆç›®æ ‡ï¼‰å‘é€ SCSI å‘½ä»¤ï¼ˆCDBï¼‰ã€‚å®ƒæ˜¯ä¸€ç§å­˜å‚¨åŒºåŸŸç½‘ç»œ (SAN) åè®®ï¼Œå…è®¸ç»„ç»‡å°†å­˜å‚¨æ•´åˆåˆ°å­˜å‚¨é˜µåˆ—ä¸­ï¼ŒåŒæ—¶ä¸ºå®¢æˆ·ç«¯ï¼ˆå¦‚æ•°æ®åº“å’Œ Web æœåŠ¡å™¨ï¼‰æä¾›æœ¬åœ°é™„åŠ  SCSI ç£ç›˜çš„å¹»è§‰ã€‚å®ƒä¸»è¦ä¸å…‰çº¤é€šé“ç«äº‰ï¼Œä½†ä¸é€šå¸¸éœ€è¦ä¸“ç”¨ç”µç¼†çš„ä¼ ç»Ÿå…‰çº¤é€šé“ä¸åŒï¼ŒiSCSI å¯ä»¥é€šè¿‡ç°æœ‰ç½‘ç»œåŸºç¡€è®¾æ–½åœ¨é•¿è·ç¦»ä¸Šè¿è¡Œã€‚

**é»˜è®¤ç«¯å£ï¼š** 3260
```
PORT     STATE SERVICE VERSION
3260/tcp open  iscsi?
```
## æšä¸¾
```
nmap -sV --script=iscsi-info -p 3260 192.168.xx.xx
```
è¿™ä¸ªè„šæœ¬å°†æŒ‡ç¤ºæ˜¯å¦éœ€è¦èº«ä»½éªŒè¯ã€‚

### [æš´åŠ›ç ´è§£](../generic-methodologies-and-resources/brute-force.md#iscsi)

### [åœ¨Linuxä¸ŠæŒ‚è½½ISCSI](https://www.synology.com/en-us/knowledgebase/DSM/tutorial/Virtualization/How\_to\_set\_up\_and\_use\_iSCSI\_target\_on\_Linux)

**æ³¨æ„ï¼š** ä½ å¯èƒ½ä¼šå‘ç°ï¼Œå½“å‘ç°ç›®æ ‡æ—¶ï¼Œå®ƒä»¬åœ¨ä¸åŒçš„IPåœ°å€ä¸‹åˆ—å‡ºã€‚å¦‚æœiSCSIæœåŠ¡é€šè¿‡NATæˆ–è™šæ‹ŸIPæš´éœ²ï¼Œé€šå¸¸ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ`iscsiadmin`å°†æ— æ³•è¿æ¥ã€‚è¿™éœ€è¦ä¸¤ä¸ªè°ƒæ•´ï¼šä¸€ä¸ªæ˜¯ç”±ä½ çš„å‘ç°æ´»åŠ¨è‡ªåŠ¨åˆ›å»ºçš„èŠ‚ç‚¹çš„ç›®å½•åç§°ï¼Œå¦ä¸€ä¸ªæ˜¯è¯¥ç›®å½•ä¸­åŒ…å«çš„`default`æ–‡ä»¶ã€‚

ä¾‹å¦‚ï¼Œä½ æ­£åœ¨å°è¯•è¿æ¥åˆ°ä½äº123.123.123.123çš„3260ç«¯å£çš„iSCSIç›®æ ‡ã€‚æš´éœ²iSCSIç›®æ ‡çš„æœåŠ¡å™¨å®é™…ä¸Šä½äº192.168.1.2ï¼Œä½†é€šè¿‡NATæš´éœ²ã€‚isciadmå°†æ³¨å†Œ_å†…éƒ¨_åœ°å€è€Œä¸æ˜¯_å…¬å…±_åœ°å€ï¼š
```
iscsiadm -m discovery -t sendtargets -p 123.123.123.123:3260
192.168.1.2:3260,1 iqn.1992-05.com.emc:fl1001433000190000-3-vnxe
[...]
```
æ­¤å‘½ä»¤å°†åœ¨æ‚¨çš„æ–‡ä»¶ç³»ç»Ÿä¸­åˆ›å»ºä¸€ä¸ªç›®å½•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
```
/etc/iscsi/nodes/iqn.1992-05.com.emc:fl1001433000190000-3-vnxe/192.168.1.2\,3260\,1/
```
åœ¨è¯¥ç›®å½•ä¸­ï¼Œæœ‰ä¸€ä¸ªé»˜è®¤æ–‡ä»¶ï¼ŒåŒ…å«è¿æ¥ç›®æ ‡æ‰€éœ€çš„æ‰€æœ‰è®¾ç½®ã€‚

1. å°† `/etc/iscsi/nodes/iqn.1992-05.com.emc:fl1001433000190000-3-vnxe/192.168.1.2\,3260\,1/` é‡å‘½åä¸º `/etc/iscsi/nodes/iqn.1992-05.com.emc:fl1001433000190000-3-vnxe/123.123.123.123\,3260\,1/`
2. åœ¨ `/etc/iscsi/nodes/iqn.1992-05.com.emc:fl1001433000190000-3-vnxe/123.123.123.123\,3260\,1/default` ä¸­ï¼Œå°† `node.conn[0].address` è®¾ç½®æ›´æ”¹ä¸ºæŒ‡å‘ 123.123.123.123ï¼Œè€Œä¸æ˜¯ 192.168.1.2ã€‚è¿™å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤å®Œæˆï¼š`sed -i 's/192.168.1.2/123.123.123.123/g' /etc/iscsi/nodes/iqn.1992-05.com.emc:fl1001433000190000-3-vnxe/123.123.123.123\,3260\,1/default`

æ‚¨ç°åœ¨å¯ä»¥æŒ‰ç…§é“¾æ¥ä¸­çš„è¯´æ˜æŒ‚è½½ç›®æ ‡ã€‚

### [åœ¨ Windows ä¸ŠæŒ‚è½½ ISCSI](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/ee338476\(v=ws.10\)?redirectedfrom=MSDN)

## **æ‰‹åŠ¨æšä¸¾**
```bash
sudo apt-get install open-iscsi
```
ç¤ºä¾‹æ¥è‡ª [iscsiadm docs](https://ptestmethod.readthedocs.io/en/latest/LFF-IPS-P2-VulnerabilityAnalysis.html#iscsiadm):

é¦–å…ˆï¼Œæ‚¨éœ€è¦ **å‘ç°ç›®æ ‡** åç§°èƒŒåçš„ IPï¼š
```bash
iscsiadm -m discovery -t sendtargets -p 123.123.123.123:3260
123.123.123.123:3260,1 iqn.1992-05.com.emc:fl1001433000190000-3-vnxe
[2a01:211:7b7:1223:211:32ff:fea9:fab9]:3260,1 iqn.2000-01.com.synology:asd3.Target-1.d0280fd382
[fe80::211:3232:fab9:1223]:3260,1 iqn.2000-01.com.synology:Oassdx.Target-1.d0280fd382
```
_æ³¨æ„ï¼Œå®ƒå°†æ˜¾ç¤ºæ‚¨å¯ä»¥**è®¿é—®**è¿™äº›**ç›®æ ‡**çš„æ¥å£çš„I**På’Œç«¯å£**ã€‚å®ƒç”šè‡³å¯ä»¥**æ˜¾ç¤ºå†…éƒ¨IPæˆ–ä¸æ‚¨ä½¿ç”¨çš„IPä¸åŒçš„IP**ã€‚_

ç„¶åæ‚¨**æ•è·æ¯è¡Œæ‰“å°å­—ç¬¦ä¸²çš„ç¬¬äºŒéƒ¨åˆ†**ï¼ˆ_iqn.1992-05.com.emc:fl1001433000190000-3-vnxe_æ¥è‡ªç¬¬ä¸€è¡Œï¼‰å¹¶**å°è¯•ç™»å½•**ï¼š
```bash
iscsiadm -m node --targetname="iqn.1992-05.com.emc:fl1001433000190000-3-vnxe" -p 123.123.123.123:3260 --login
Logging in to [iface: default, target: iqn.1992-05.com.emc:fl1001433000190000-3-vnxe, portal: 123.123.123.123,3260] (multiple)
Login to [iface: default, target: iqn.1992-05.com.emc:fl1001433000190000-3-vnxe, portal: 123.123.123.123,3260] successful.
```
ç„¶åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ `â€“logout` **æ³¨é”€**ã€‚
```bash
iscsiadm -m node --targetname="iqn.1992-05.com.emc:fl1001433000190000-3-vnxe" -p 123.123.123.123:3260 --logout
Logging out of session [sid: 6, target: iqn.1992-05.com.emc:fl1001433000190000-3-vnxe, portal: 123.123.123.123,3260]
Logout of [sid: 6, target: iqn.1992-05.com.emc:fl1001433000190000-3-vnxe, portal: 123.123.123.123,3260] successful.
```
æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»…ä½¿ç”¨ **without** ä»»ä½• `--login`/`--logout` å‚æ•°æ‰¾åˆ° **more information**ã€‚
```bash
iscsiadm -m node --targetname="iqn.1992-05.com.emc:fl1001433000190000-3-vnxe" -p 123.123.123.123:3260
# BEGIN RECORD 2.0-873
node.name = iqn.1992-05.com.emc:fl1001433000190000-3-vnxe
node.tpgt = 1
node.startup = manual
node.leading_login = No
iface.hwaddress = <empty>
iface.ipaddress = <empty>
iface.iscsi_ifacename = default
iface.net_ifacename = <empty>
iface.transport_name = tcp
iface.initiatorname = <empty>
iface.bootproto = <empty>
iface.subnet_mask = <empty>
iface.gateway = <empty>
iface.ipv6_autocfg = <empty>
iface.linklocal_autocfg = <empty>
iface.router_autocfg = <empty>
iface.ipv6_linklocal = <empty>
iface.ipv6_router = <empty>
iface.state = <empty>
iface.vlan_id = 0
iface.vlan_priority = 0
iface.vlan_state = <empty>
iface.iface_num = 0
iface.mtu = 0
iface.port = 0
node.discovery_address = 192.168.xx.xx
node.discovery_port = 3260
node.discovery_type = send_targets
node.session.initial_cmdsn = 0
node.session.initial_login_retry_max = 8
node.session.xmit_thread_priority = -20
node.session.cmds_max = 128
node.session.queue_depth = 32
node.session.nr_sessions = 1
node.session.auth.authmethod = None
node.session.auth.username = <empty>
node.session.auth.password = <empty>
node.session.auth.username_in = <empty>
node.session.auth.password_in = <empty>
node.session.timeo.replacement_timeout = 120
node.session.err_timeo.abort_timeout = 15
node.session.err_timeo.lu_reset_timeout = 30
node.session.err_timeo.tgt_reset_timeout = 30
node.session.err_timeo.host_reset_timeout = 60
node.session.iscsi.FastAbort = Yes
node.session.iscsi.InitialR2T = No
node.session.iscsi.ImmediateData = Yes
node.session.iscsi.FirstBurstLength = 262144
node.session.iscsi.MaxBurstLength = 16776192
node.session.iscsi.DefaultTime2Retain = 0
node.session.iscsi.DefaultTime2Wait = 2
node.session.iscsi.MaxConnections = 1
node.session.iscsi.MaxOutstandingR2T = 1
node.session.iscsi.ERL = 0
node.conn[0].address = 192.168.xx.xx
node.conn[0].port = 3260
node.conn[0].startup = manual
node.conn[0].tcp.window_size = 524288
node.conn[0].tcp.type_of_service = 0
node.conn[0].timeo.logout_timeout = 15
node.conn[0].timeo.login_timeout = 15
node.conn[0].timeo.auth_timeout = 45
node.conn[0].timeo.noop_out_interval = 5
node.conn[0].timeo.noop_out_timeout = 5
node.conn[0].iscsi.MaxXmitDataSegmentLength = 0
node.conn[0].iscsi.MaxRecvDataSegmentLength = 262144
node.conn[0].iscsi.HeaderDigest = None
node.conn[0].iscsi.DataDigest = None
node.conn[0].iscsi.IFMarker = No
node.conn[0].iscsi.OFMarker = No
# END RECORD
```
**æœ‰ä¸€ä¸ªè„šæœ¬å¯ä»¥è‡ªåŠ¨åŒ–åŸºæœ¬çš„å­ç½‘æšä¸¾è¿‡ç¨‹ï¼Œä½äº** [**iscsiadm**](https://github.com/bitvijays/Pentest-Scripts/tree/master/Vulnerability\_Analysis/isciadm)

## **Shodan**

* `port:3260 AuthMethod`

## **å‚è€ƒæ–‡çŒ®**

* [https://bitvijays.github.io/LFF-IPS-P2-VulnerabilityAnalysis.html](https://bitvijays.github.io/LFF-IPS-P2-VulnerabilityAnalysis.html)
* [https://ptestmethod.readthedocs.io/en/latest/LFF-IPS-P2-VulnerabilityAnalysis.html#iscsiadm](https://ptestmethod.readthedocs.io/en/latest/LFF-IPS-P2-VulnerabilityAnalysis.html#iscsiadm)

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ **ä¸Šå…³æ³¨æˆ‘ä»¬** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
