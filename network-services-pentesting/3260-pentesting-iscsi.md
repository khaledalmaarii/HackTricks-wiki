# 3260 - Pentesting ISCSI

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-moi** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informations de base

> En informatique, **iSCSI** est l'acronyme de **Internet Small Computer Systems Interface**, une norme de r√©seau de stockage bas√©e sur le protocole Internet (IP) pour relier des installations de stockage de donn√©es. Il fournit un acc√®s au niveau des blocs aux dispositifs de stockage en transmettant des commandes SCSI sur un r√©seau TCP/IP. L'iSCSI est utilis√© pour faciliter les transferts de donn√©es sur les intranets et pour g√©rer le stockage √† de longues distances. Il peut √™tre utilis√© pour transmettre des donn√©es sur des r√©seaux locaux (LAN), des r√©seaux √©tendus (WAN) ou Internet et peut permettre le stockage et la r√©cup√©ration de donn√©es ind√©pendamment de l'emplacement.
>
> Le protocole permet aux clients (appel√©s initiateurs) d'envoyer des commandes SCSI (CDBs) √† des dispositifs de stockage (cibles) sur des serveurs distants. C'est un protocole de r√©seau de zone de stockage (SAN), permettant aux organisations de consolider le stockage dans des tableaux de stockage tout en fournissant aux clients (tels que les serveurs de bases de donn√©es et web) l'illusion de disques SCSI attach√©s localement. Il est principalement en concurrence avec Fibre Channel, mais contrairement au Fibre Channel traditionnel qui n√©cessite g√©n√©ralement un c√¢blage d√©di√©, l'iSCSI peut √™tre ex√©cut√© sur de longues distances en utilisant l'infrastructure r√©seau existante.

**Port par d√©faut :** 3260
```
PORT     STATE SERVICE VERSION
3260/tcp open  iscsi?
```
## √ânum√©ration
```
nmap -sV --script=iscsi-info -p 3260 192.168.xx.xx
```
Ce script indiquera si une authentification est requise.

### [Force brute](../generic-methodologies-and-resources/brute-force.md#iscsi)

### [Monter ISCSI sur Linux](https://www.synology.com/en-us/knowledgebase/DSM/tutorial/Virtualization/How\_to\_set\_up\_and\_use\_iSCSI\_target\_on\_Linux)

**Note :** Vous pouvez constater que lorsque vos cibles sont d√©couvertes, elles sont r√©pertori√©es sous une adresse IP diff√©rente. Cela se produit souvent si le service iSCSI est expos√© via NAT ou une IP virtuelle. Dans des cas comme ceux-ci, `iscsiadmin` √©chouera √† se connecter. Cela n√©cessite deux ajustements : un pour le nom du r√©pertoire du n≈ìud automatiquement cr√©√© par vos activit√©s de d√©couverte, et un pour le fichier `default` contenu dans ce r√©pertoire.

Par exemple, vous essayez de vous connecter √† une cible iSCSI sur 123.123.123.123 au port 3260. Le serveur exposant la cible iSCSI est en r√©alit√© √† 192.168.1.2 mais expos√© via NAT. isciadm enregistrera l'adresse _interne_ plut√¥t que l'adresse _publique_ :
```
iscsiadm -m discovery -t sendtargets -p 123.123.123.123:3260
192.168.1.2:3260,1 iqn.1992-05.com.emc:fl1001433000190000-3-vnxe
[...]
```
Cette commande va cr√©er un r√©pertoire dans votre syst√®me de fichiers comme ceci :
```
/etc/iscsi/nodes/iqn.1992-05.com.emc:fl1001433000190000-3-vnxe/192.168.1.2\,3260\,1/
```
Dans le r√©pertoire, il y a un fichier par d√©faut avec tous les param√®tres n√©cessaires pour se connecter √† la cible.

1. Renommez `/etc/iscsi/nodes/iqn.1992-05.com.emc:fl1001433000190000-3-vnxe/192.168.1.2\,3260\,1/` en `/etc/iscsi/nodes/iqn.1992-05.com.emc:fl1001433000190000-3-vnxe/123.123.123.123\,3260\,1/`
2. Dans `/etc/iscsi/nodes/iqn.1992-05.com.emc:fl1001433000190000-3-vnxe/123.123.123.123\,3260\,1/default`, changez le param√®tre `node.conn[0].address` pour qu'il pointe vers 123.123.123.123 au lieu de 192.168.1.2. Cela peut √™tre fait avec une commande telle que `sed -i 's/192.168.1.2/123.123.123.123/g' /etc/iscsi/nodes/iqn.1992-05.com.emc:fl1001433000190000-3-vnxe/123.123.123.123\,3260\,1/default`

Vous pouvez maintenant monter la cible comme indiqu√© dans le lien.

### [Monter ISCSI sur Windows](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/ee338476\(v=ws.10\)?redirectedfrom=MSDN)

## **√ânum√©ration manuelle**
```bash
sudo apt-get install open-iscsi
```
Tout d'abord, vous devez **d√©couvrir le nom de la cible** derri√®re l'IP :
```
iscsiadm -m discovery -t sendtargets -p 123.123.123.123:3260
123.123.123.123:3260,1 iqn.1992-05.com.emc:fl1001433000190000-3-vnxe
[2a01:211:7b7:1223:211:32ff:fea9:fab9]:3260,1 iqn.2000-01.com.synology:asd3.Target-1.d0280fd382
[fe80::211:3232:fab9:1223]:3260,1 iqn.2000-01.com.synology:Oassdx.Target-1.d0280fd382
```
_Notez qu'il affichera l'**IP et le port des interfaces** o√π vous pouvez **atteindre** ces **cibles**. Il peut m√™me **afficher des IP internes ou diff√©rentes IP** de celle que vous avez utilis√©e._

Ensuite, vous **capturez la 2√®me partie de la cha√Æne imprim√©e de chaque ligne** (_iqn.1992-05.com.emc:fl1001433000190000-3-vnxe_ de la premi√®re ligne) et **essayez de vous connecter** :
```bash
iscsiadm -m node --targetname="iqn.1992-05.com.emc:fl1001433000190000-3-vnxe" -p 123.123.123.123:3260 --login
Logging in to [iface: default, target: iqn.1992-05.com.emc:fl1001433000190000-3-vnxe, portal: 123.123.123.123,3260] (multiple)
Login to [iface: default, target: iqn.1992-05.com.emc:fl1001433000190000-3-vnxe, portal: 123.123.123.123,3260] successful.
```
Ensuite, vous pouvez vous **d√©connecter** en utilisant `‚Äìlogout`
```bash
iscsiadm -m node --targetname="iqn.1992-05.com.emc:fl1001433000190000-3-vnxe" -p 123.123.123.123:3260 --logout
Logging out of session [sid: 6, target: iqn.1992-05.com.emc:fl1001433000190000-3-vnxe, portal: 123.123.123.123,3260]
Logout of [sid: 6, target: iqn.1992-05.com.emc:fl1001433000190000-3-vnxe, portal: 123.123.123.123,3260] successful.
```
Nous pouvons trouver **plus d'informations** √† ce sujet en utilisant simplement **sans** aucun param√®tre `--login`/`--logout`
```bash
iscsiadm -m node --targetname="iqn.1992-05.com.emc:fl1001433000190000-3-vnxe" -p 123.123.123.123:3260
# BEGIN RECORD 2.0-873
node.name = iqn.1992-05.com.emc:fl1001433000190000-3-vnxe
node.tpgt = 1
node.startup = manual
node.leading_login = No
iface.hwaddress = <empty>
iface.ipaddress = <empty>
iface.iscsi_ifacename = default
iface.net_ifacename = <empty>
iface.transport_name = tcp
iface.initiatorname = <empty>
iface.bootproto = <empty>
iface.subnet_mask = <empty>
iface.gateway = <empty>
iface.ipv6_autocfg = <empty>
iface.linklocal_autocfg = <empty>
iface.router_autocfg = <empty>
iface.ipv6_linklocal = <empty>
iface.ipv6_router = <empty>
iface.state = <empty>
iface.vlan_id = 0
iface.vlan_priority = 0
iface.vlan_state = <empty>
iface.iface_num = 0
iface.mtu = 0
iface.port = 0
node.discovery_address = 192.168.xx.xx
node.discovery_port = 3260
node.discovery_type = send_targets
node.session.initial_cmdsn = 0
node.session.initial_login_retry_max = 8
node.session.xmit_thread_priority = -20
node.session.cmds_max = 128
node.session.queue_depth = 32
node.session.nr_sessions = 1
node.session.auth.authmethod = None
node.session.auth.username = <empty>
node.session.auth.password = <empty>
node.session.auth.username_in = <empty>
node.session.auth.password_in = <empty>
node.session.timeo.replacement_timeout = 120
node.session.err_timeo.abort_timeout = 15
node.session.err_timeo.lu_reset_timeout = 30
node.session.err_timeo.tgt_reset_timeout = 30
node.session.err_timeo.host_reset_timeout = 60
node.session.iscsi.FastAbort = Yes
node.session.iscsi.InitialR2T = No
node.session.iscsi.ImmediateData = Yes
node.session.iscsi.FirstBurstLength = 262144
node.session.iscsi.MaxBurstLength = 16776192
node.session.iscsi.DefaultTime2Retain = 0
node.session.iscsi.DefaultTime2Wait = 2
node.session.iscsi.MaxConnections = 1
node.session.iscsi.MaxOutstandingR2T = 1
node.session.iscsi.ERL = 0
node.conn[0].address = 192.168.xx.xx
node.conn[0].port = 3260
node.conn[0].startup = manual
node.conn[0].tcp.window_size = 524288
node.conn[0].tcp.type_of_service = 0
node.conn[0].timeo.logout_timeout = 15
node.conn[0].timeo.login_timeout = 15
node.conn[0].timeo.auth_timeout = 45
node.conn[0].timeo.noop_out_interval = 5
node.conn[0].timeo.noop_out_timeout = 5
node.conn[0].iscsi.MaxXmitDataSegmentLength = 0
node.conn[0].iscsi.MaxRecvDataSegmentLength = 262144
node.conn[0].iscsi.HeaderDigest = None
node.conn[0].iscsi.DataDigest = None
node.conn[0].iscsi.IFMarker = No
node.conn[0].iscsi.OFMarker = No
# END RECORD
```
**Il existe un script pour automatiser le processus de base d'√©num√©ration de sous-r√©seaux disponible sur** [**iscsiadm**](https://github.com/bitvijays/Pentest-Scripts/tree/master/Vulnerability\_Analysis/isciadm)

## **Shodan**

* `port:3260 AuthMethod`

## **R√©f√©rences**

{% embed url="https://bitvijays.github.io/LFF-IPS-P2-VulnerabilityAnalysis.html" %}

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-moi** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
