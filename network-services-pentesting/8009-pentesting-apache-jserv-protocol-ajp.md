# 8009 - Pentesting Apache JServ Protocol (AJP)

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

<figure><img src="../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

åŠ å…¥ [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) æœåŠ¡å™¨ï¼Œä¸ç»éªŒä¸°å¯Œçš„é»‘å®¢å’Œæ¼æ´èµé‡‘çŒäººäº¤æµï¼

**é»‘å®¢è§è§£**\
å‚ä¸æ·±å…¥æ¢è®¨é»‘å®¢çš„åˆºæ¿€ä¸æŒ‘æˆ˜çš„å†…å®¹

**å®æ—¶é»‘å®¢æ–°é—»**\
é€šè¿‡å®æ—¶æ–°é—»å’Œè§è§£ï¼Œè·Ÿä¸Šå¿«é€Ÿå˜åŒ–çš„é»‘å®¢ä¸–ç•Œ

**æœ€æ–°å…¬å‘Š**\
äº†è§£æœ€æ–°çš„æ¼æ´èµé‡‘è®¡åˆ’å’Œé‡è¦å¹³å°æ›´æ–°

**ä»Šå¤©å°±åŠ å…¥æˆ‘ä»¬ï¼Œè¿›å…¥** [**Discord**](https://discord.com/invite/N3FrSbmwdy)ï¼Œä¸é¡¶å°–é»‘å®¢å¼€å§‹åˆä½œå§ï¼

## åŸºæœ¬ä¿¡æ¯

æ¥è‡ª: [https://diablohorn.com/2011/10/19/8009-the-forgotten-tomcat-port/](https://diablohorn.com/2011/10/19/8009-the-forgotten-tomcat-port/)

> AJP æ˜¯ä¸€ç§çº¿åè®®ã€‚å®ƒæ˜¯ HTTP åè®®çš„ä¼˜åŒ–ç‰ˆæœ¬ï¼Œå…è®¸ç‹¬ç«‹çš„ web æœåŠ¡å™¨å¦‚ [Apache](http://httpd.apache.org/) ä¸ Tomcat é€šä¿¡ã€‚å†å²ä¸Šï¼ŒApache åœ¨æä¾›é™æ€å†…å®¹æ–¹é¢æ¯” Tomcat å¿«å¾—å¤šã€‚å…¶æƒ³æ³•æ˜¯è®© Apache åœ¨å¯èƒ½çš„æƒ…å†µä¸‹æä¾›é™æ€å†…å®¹ï¼Œä½†å°†è¯·æ±‚ä»£ç†åˆ° Tomcat ä»¥è·å–ä¸ Tomcat ç›¸å…³çš„å†…å®¹ã€‚

ä¹Ÿå¾ˆæœ‰è¶£ï¼š

> ajp13 åè®®æ˜¯é¢å‘æ•°æ®åŒ…çš„ã€‚å‡ºäºæ€§èƒ½åŸå› ï¼Œæ˜¾ç„¶é€‰æ‹©äº†äºŒè¿›åˆ¶æ ¼å¼è€Œä¸æ˜¯æ›´æ˜“è¯»çš„çº¯æ–‡æœ¬ã€‚web æœåŠ¡å™¨é€šè¿‡ TCP è¿æ¥ä¸ servlet å®¹å™¨é€šä¿¡ã€‚ä¸ºäº†å‡å°‘åˆ›å»ºå¥—æ¥å­—çš„æ˜‚è´µè¿‡ç¨‹ï¼Œweb æœåŠ¡å™¨å°†å°è¯•ä¿æŒä¸ servlet å®¹å™¨çš„æŒä¹… TCP è¿æ¥ï¼Œå¹¶é‡ç”¨ä¸€ä¸ªè¿æ¥è¿›è¡Œå¤šä¸ªè¯·æ±‚/å“åº”å‘¨æœŸã€‚

**é»˜è®¤ç«¯å£ï¼š** 8009
```
PORT     STATE SERVICE
8009/tcp open  ajp13
```
## CVE-2020-1938 ['Ghostcat'](https://www.chaitin.cn/en/ghostcat)

å¦‚æœ AJP ç«¯å£æš´éœ²ï¼ŒTomcat å¯èƒ½ä¼šå—åˆ° Ghostcat æ¼æ´çš„å½±å“ã€‚è¿™é‡Œæœ‰ä¸€ä¸ª [exploit](https://www.exploit-db.com/exploits/48143) å¯ä»¥åˆ©ç”¨è¿™ä¸ªé—®é¢˜ã€‚

Ghostcat æ˜¯ä¸€ä¸ª LFI æ¼æ´ï¼Œä½†æœ‰äº›é™åˆ¶ï¼šåªèƒ½æå–æ¥è‡ªç‰¹å®šè·¯å¾„çš„æ–‡ä»¶ã€‚å°½ç®¡å¦‚æ­¤ï¼Œè¿™ä»ç„¶å¯ä»¥åŒ…æ‹¬åƒ `WEB-INF/web.xml` è¿™æ ·çš„æ–‡ä»¶ï¼Œè¿™å¯èƒ½ä¼šæ³„éœ²é‡è¦ä¿¡æ¯ï¼Œå¦‚ Tomcat æ¥å£çš„å‡­æ®ï¼Œå…·ä½“å–å†³äºæœåŠ¡å™¨è®¾ç½®ã€‚

åœ¨ 9.0.31ã€8.5.51 å’Œ 7.0.100 æˆ–æ›´é«˜ç‰ˆæœ¬ä¸­å·²ä¿®å¤æ­¤é—®é¢˜ã€‚

## Enumeration

### Automatic
```bash
nmap -sV --script ajp-auth,ajp-headers,ajp-methods,ajp-request -n -p 8009 <IP>
```
### [**æš´åŠ›ç ´è§£**](../generic-methodologies-and-resources/brute-force.md#ajp)

## AJP ä»£ç†

### Nginx åå‘ä»£ç†ä¸ AJP

[æŸ¥çœ‹ Docker åŒ–ç‰ˆæœ¬](8009-pentesting-apache-jserv-protocol-ajp.md#Dockerized-version)

å½“æˆ‘ä»¬é‡åˆ°ä¸€ä¸ªå¼€æ”¾çš„ AJP ä»£ç†ç«¯å£ï¼ˆ8009 TCPï¼‰æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¸¦æœ‰ `ajp_module` çš„ Nginx è®¿é—®â€œéšè—â€çš„ Tomcat ç®¡ç†å‘˜ã€‚è¿™å¯ä»¥é€šè¿‡ç¼–è¯‘ Nginx æºä»£ç å¹¶æ·»åŠ æ‰€éœ€æ¨¡å—æ¥å®Œæˆï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

* ä¸‹è½½ Nginx æºä»£ç 
* ä¸‹è½½æ‰€éœ€æ¨¡å—
* ä½¿ç”¨ `ajp_module` ç¼–è¯‘ Nginx æºä»£ç ã€‚
* åˆ›å»ºä¸€ä¸ªæŒ‡å‘ AJP ç«¯å£çš„é…ç½®æ–‡ä»¶
```bash
# Download Nginx code
wget https://nginx.org/download/nginx-1.21.3.tar.gz
tar -xzvf nginx-1.21.3.tar.gz

# Compile Nginx source code with the ajp module
git clone https://github.com/dvershinin/nginx_ajp_module.git
cd nginx-1.21.3
sudo apt install libpcre3-dev
./configure --add-module=`pwd`/../nginx_ajp_module --prefix=/etc/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib/nginx/modules
make
sudo make install
nginx -V
```
åœ¨`/etc/nginx/conf/nginx.conf`çš„`http`å—ä¸­æ³¨é‡Šæ‰æ•´ä¸ª`server`å—ï¼Œå¹¶åœ¨å…¶ä¸­æ·»åŠ ä»¥ä¸‹è¡Œã€‚
```shell-session
upstream tomcats {
server <TARGET_SERVER>:8009;
keepalive 10;
}
server {
listen 80;
location / {
ajp_keep_conn on;
ajp_pass tomcats;
}
}
```
å¯åŠ¨ Nginxï¼Œå¹¶é€šè¿‡å‘æœ¬åœ°ä¸»æœºå‘å‡º cURL è¯·æ±‚æ¥æ£€æŸ¥ä¸€åˆ‡æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚
```html
sudo nginx
curl http://127.0.0.1:80

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Apache Tomcat/X.X.XX</title>
<link href="favicon.ico" rel="icon" type="image/x-icon" />
<link href="favicon.ico" rel="shortcut icon" type="image/x-icon" />
<link href="tomcat.css" rel="stylesheet" type="text/css" />
</headas
<body>
<div id="wrapper">
<div id="navigation" class="curved container">
<span id="nav-home"><a href="https://tomcat.apache.org/">Home</a></span>
<span id="nav-hosts"><a href="/docs/">Documentation</a></span>
<span id="nav-config"><a href="/docs/config/">Configuration</a></span>
<span id="nav-examples"><a href="/examples/">Examples</a></span>
<span id="nav-wiki"><a href="https://wiki.apache.org/tomcat/FrontPage">Wiki</a></span>
<span id="nav-lists"><a href="https://tomcat.apache.org/lists.html">Mailing Lists</a></span>
<span id="nav-help"><a href="https://tomcat.apache.org/findhelp.html">Find Help</a></span>
<br class="separator" />
</div>
<div id="asf-box">
<h1>Apache Tomcat/X.X.XX</h1>
</div>
<div id="upper" class="curved container">
<div id="congrats" class="curved container">
<h2>If you're seeing this, you've successfully installed Tomcat. Congratulations!</h2>
<SNIP>
```
### Nginx DockeråŒ–ç‰ˆæœ¬
```bash
git clone https://github.com/ScribblerCoder/nginx-ajp-docker
cd nginx-ajp-docker
```
å°† `nginx.conf` ä¸­çš„ `TARGET-IP` æ›¿æ¢ä¸º AJP IPï¼Œç„¶åæ„å»ºå¹¶è¿è¡Œã€‚
```bash
docker build . -t nginx-ajp-proxy
docker run -it --rm -p 80:80 nginx-ajp-proxy
```
### Apache AJP Proxy

é‡åˆ°ä¸€ä¸ªå¼€æ”¾çš„8009ç«¯å£è€Œæ²¡æœ‰å…¶ä»–å¯è®¿é—®çš„ç½‘ç»œç«¯å£æ˜¯å¾ˆå°‘è§çš„ã€‚ç„¶è€Œï¼Œä»ç„¶å¯ä»¥ä½¿ç”¨**Metasploit**è¿›è¡Œåˆ©ç”¨ã€‚é€šè¿‡å°†**Apache**ä½œä¸ºä»£ç†ï¼Œå¯ä»¥å°†è¯·æ±‚é‡å®šå‘åˆ°8009ç«¯å£ä¸Šçš„**Tomcat**ã€‚
```bash
sudo apt-get install libapache2-mod-jk
sudo vim /etc/apache2/apache2.conf # append the following line to the config
Include ajp.conf
sudo vim /etc/apache2/ajp.conf     # create the following file, change HOST to the target address
ProxyRequests Off
<Proxy *>
Order deny,allow
Deny from all
Allow from localhost
</Proxy>
ProxyPass       / ajp://HOST:8009/
ProxyPassReverse    / ajp://HOST:8009/
sudo a2enmod proxy_http
sudo a2enmod proxy_ajp
sudo systemctl restart apache2
```
æ­¤è®¾ç½®æä¾›äº†ç»•è¿‡å…¥ä¾µæ£€æµ‹å’Œé˜²å¾¡ç³»ç»Ÿï¼ˆIDS/IPSï¼‰çš„æ½œåŠ›ï¼ŒåŸå› åœ¨äº**AJPåè®®çš„äºŒè¿›åˆ¶ç‰¹æ€§**ï¼Œå°½ç®¡è¿™ä¸€èƒ½åŠ›å°šæœªå¾—åˆ°éªŒè¯ã€‚é€šè¿‡å°†å¸¸è§„çš„Metasploit Tomcatæ¼æ´åˆ©ç”¨æŒ‡å‘`127.0.0.1:80`ï¼Œæ‚¨å¯ä»¥æœ‰æ•ˆåœ°æ§åˆ¶ç›®æ ‡ç³»ç»Ÿã€‚
```bash
msf  exploit(tomcat_mgr_deploy) > show options
```
## å‚è€ƒæ–‡çŒ®

* [https://github.com/yaoweibin/nginx\_ajp\_module](https://github.com/yaoweibin/nginx\_ajp\_module)
* [https://academy.hackthebox.com/module/145/section/1295](https://academy.hackthebox.com/module/145/section/1295)

<figure><img src="../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

åŠ å…¥ [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) æœåŠ¡å™¨ï¼Œä¸ç»éªŒä¸°å¯Œçš„é»‘å®¢å’Œæ¼æ´èµé‡‘çŒäººäº¤æµï¼

**é»‘å®¢è§è§£**\
å‚ä¸æ·±å…¥æ¢è®¨é»‘å®¢çš„åˆºæ¿€ä¸æŒ‘æˆ˜çš„å†…å®¹

**å®æ—¶é»‘å®¢æ–°é—»**\
é€šè¿‡å®æ—¶æ–°é—»å’Œè§è§£ï¼Œè·Ÿä¸Šå¿«é€Ÿå˜åŒ–çš„é»‘å®¢ä¸–ç•Œ

**æœ€æ–°å…¬å‘Š**\
äº†è§£æœ€æ–°çš„æ¼æ´èµé‡‘å‘å¸ƒå’Œé‡è¦å¹³å°æ›´æ–°

**åŠ å…¥æˆ‘ä»¬** [**Discord**](https://discord.com/invite/N3FrSbmwdy)ï¼Œä»Šå¤©å°±å¼€å§‹ä¸é¡¶çº§é»‘å®¢åˆä½œï¼

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
