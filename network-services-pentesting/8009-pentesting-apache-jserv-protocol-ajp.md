# 8009 - æ¸—é€æµ‹è¯• Apache JServ åè®® (AJP)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨ HackTricks ä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½ PDF ç‰ˆçš„ HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)** ä¸Šå…³æ³¨**æˆ‘ä»¬ã€‚
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

<figure><img src="../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

åŠ å…¥ [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) æœåŠ¡å™¨ï¼Œä¸ç»éªŒä¸°å¯Œçš„é»‘å®¢å’Œèµé‡‘çŒäººäº¤æµï¼

**é»‘å®¢è§è§£**\
å‚ä¸æ·±å…¥æ¢è®¨é»‘å®¢çš„åˆºæ¿€å’ŒæŒ‘æˆ˜çš„å†…å®¹

**å®æ—¶é»‘å®¢æ–°é—»**\
é€šè¿‡å®æ—¶æ–°é—»å’Œè§è§£åŠæ—¶äº†è§£å¿«èŠ‚å¥çš„é»‘å®¢ä¸–ç•Œ

**æœ€æ–°å…¬å‘Š**\
éšæ—¶äº†è§£æœ€æ–°çš„èµé‡‘è®¡åˆ’å‘å¸ƒå’Œé‡è¦å¹³å°æ›´æ–°

**åŠ å…¥æˆ‘ä»¬çš„** [**Discord**](https://discord.com/invite/N3FrSbmwdy)ï¼Œç«‹å³ä¸é¡¶å°–é»‘å®¢åˆä½œï¼

## åŸºæœ¬ä¿¡æ¯

æ¥æºï¼š[https://diablohorn.com/2011/10/19/8009-the-forgotten-tomcat-port/](https://diablohorn.com/2011/10/19/8009-the-forgotten-tomcat-port/)

> AJP æ˜¯ä¸€ç§ä¼ è¾“åè®®ã€‚å®ƒæ˜¯ HTTP åè®®çš„ä¼˜åŒ–ç‰ˆæœ¬ï¼Œå…è®¸ç‹¬ç«‹çš„ Web æœåŠ¡å™¨ï¼ˆå¦‚ [Apache](http://httpd.apache.org/)ï¼‰ä¸ Tomcat è¿›è¡Œé€šä¿¡ã€‚åœ¨å†å²ä¸Šï¼ŒApache åœ¨æä¾›é™æ€å†…å®¹æ–¹é¢æ¯” Tomcat å¿«å¾—å¤šã€‚å…¶æƒ³æ³•æ˜¯è®© Apache åœ¨å¯èƒ½çš„æƒ…å†µä¸‹æä¾›é™æ€å†…å®¹ï¼Œä½†å°†è¯·æ±‚ä»£ç†åˆ° Tomcat å¤„ç†ä¸ Tomcat ç›¸å…³çš„å†…å®¹ã€‚

å¦å¤–æœ‰è¶£çš„æ˜¯ï¼š

> ajp13 åè®®æ˜¯åŸºäºæ•°æ®åŒ…çš„ã€‚å‡ºäºæ€§èƒ½åŸå› ï¼ŒäºŒè¿›åˆ¶æ ¼å¼æ˜¾ç„¶ä¼˜äºæ›´æ˜“è¯»çš„çº¯æ–‡æœ¬ã€‚Web æœåŠ¡å™¨é€šè¿‡ TCP è¿æ¥ä¸ Servlet å®¹å™¨é€šä¿¡ã€‚ä¸ºäº†å‡å°‘æ˜‚è´µçš„å¥—æ¥å­—åˆ›å»ºè¿‡ç¨‹ï¼ŒWeb æœåŠ¡å™¨å°†å°è¯•ç»´æŠ¤æŒä¹…çš„ TCP è¿æ¥åˆ° Servlet å®¹å™¨ï¼Œå¹¶é‡ç”¨è¿æ¥è¿›è¡Œå¤šä¸ªè¯·æ±‚/å“åº”å‘¨æœŸã€‚

**é»˜è®¤ç«¯å£ï¼š** 8009
```
PORT     STATE SERVICE
8009/tcp open  ajp13
```
## CVE-2020-1938 ['Ghostcat'](https://www.chaitin.cn/en/ghostcat)

å¦‚æœAJPç«¯å£æš´éœ²ï¼ŒTomcatå¯èƒ½ä¼šå—åˆ°Ghostcatæ¼æ´çš„å½±å“ã€‚è¿™é‡Œæœ‰ä¸€ä¸ª[exploit](https://www.exploit-db.com/exploits/48143)å¯ä»¥åˆ©ç”¨è¿™ä¸ªé—®é¢˜ã€‚

Ghostcatæ˜¯ä¸€ä¸ªLFIæ¼æ´ï¼Œä½†å—åˆ°ä¸€å®šé™åˆ¶ï¼šåªèƒ½æå–ç‰¹å®šè·¯å¾„ä¸‹çš„æ–‡ä»¶ã€‚å°½ç®¡å¦‚æ­¤ï¼Œè¿™å¯èƒ½åŒ…æ‹¬è¯¸å¦‚`WEB-INF/web.xml`ä¹‹ç±»çš„æ–‡ä»¶ï¼Œè¿™äº›æ–‡ä»¶å¯èƒ½æ³„éœ²åƒTomcatæ¥å£çš„å‡­æ®è¿™æ ·çš„é‡è¦ä¿¡æ¯ï¼Œå…·ä½“å–å†³äºæœåŠ¡å™¨çš„è®¾ç½®ã€‚

ä¿®è¡¥ç‰ˆæœ¬ä¸º9.0.31æˆ–æ›´é«˜ç‰ˆæœ¬ï¼Œ8.5.51å’Œ7.0.100å·²è§£å†³äº†æ­¤é—®é¢˜ã€‚

## æšä¸¾

### è‡ªåŠ¨åŒ–
```bash
nmap -sV --script ajp-auth,ajp-headers,ajp-methods,ajp-request -n -p 8009 <IP>
```
### [**æš´åŠ›ç ´è§£**](../generic-methodologies-and-resources/brute-force.md#ajp)

## AJP ä»£ç†

### Nginx åå‘ä»£ç† & AJP

[æŸ¥çœ‹ Docker åŒ–ç‰ˆæœ¬](8009-pentesting-apache-jserv-protocol-ajp.md#Dockerized-version)

å½“æˆ‘ä»¬é‡åˆ°ä¸€ä¸ªå¼€æ”¾çš„ AJP ä»£ç†ç«¯å£ï¼ˆ8009 TCPï¼‰æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¸¦æœ‰ `ajp_module` çš„ Nginx æ¥è®¿é—®â€œéšè—â€çš„ Tomcat ç®¡ç†å™¨ã€‚è¿™å¯ä»¥é€šè¿‡ç¼–è¯‘ Nginx æºä»£ç å¹¶æ·»åŠ æ‰€éœ€çš„æ¨¡å—æ¥å®ç°ï¼Œå…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š

* ä¸‹è½½ Nginx æºä»£ç 
* ä¸‹è½½æ‰€éœ€çš„æ¨¡å—
* ä½¿ç”¨ `ajp_module` ç¼–è¯‘ Nginx æºä»£ç ã€‚
* åˆ›å»ºä¸€ä¸ªæŒ‡å‘ AJP ç«¯å£çš„é…ç½®æ–‡ä»¶
```bash
# Download Nginx code
wget https://nginx.org/download/nginx-1.21.3.tar.gz
tar -xzvf nginx-1.21.3.tar.gz

# Compile Nginx source code with the ajp module
git clone https://github.com/dvershinin/nginx_ajp_module.git
cd nginx-1.21.3
sudo apt install libpcre3-dev
./configure --add-module=`pwd`/../nginx_ajp_module --prefix=/etc/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib/nginx/modules
make
sudo make install
nginx -V
```
```diff
-# server {
-#     listen 80;
-#     server_name example.com;
-#     location / {
-#         proxy_pass http://127.0.0.1:8009;
-#     }
-# }
+#     server {
+#         listen 80;
+#         server_name example.com;
+#         location / {
+#             proxy_pass http://127.0.0.1:8009;
+#         }
+#     }
```
```shell-session
upstream tomcats {
server <TARGET_SERVER>:8009;
keepalive 10;
}
server {
listen 80;
location / {
ajp_keep_conn on;
ajp_pass tomcats;
}
}
```
å¯åŠ¨ Nginx å¹¶é€šè¿‡å‘æœ¬åœ°ä¸»æœºå‘å‡º cURL è¯·æ±‚æ¥æ£€æŸ¥ä¸€åˆ‡æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚
```html
sudo nginx
curl http://127.0.0.1:80

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Apache Tomcat/X.X.XX</title>
<link href="favicon.ico" rel="icon" type="image/x-icon" />
<link href="favicon.ico" rel="shortcut icon" type="image/x-icon" />
<link href="tomcat.css" rel="stylesheet" type="text/css" />
</headas
<body>
<div id="wrapper">
<div id="navigation" class="curved container">
<span id="nav-home"><a href="https://tomcat.apache.org/">Home</a></span>
<span id="nav-hosts"><a href="/docs/">Documentation</a></span>
<span id="nav-config"><a href="/docs/config/">Configuration</a></span>
<span id="nav-examples"><a href="/examples/">Examples</a></span>
<span id="nav-wiki"><a href="https://wiki.apache.org/tomcat/FrontPage">Wiki</a></span>
<span id="nav-lists"><a href="https://tomcat.apache.org/lists.html">Mailing Lists</a></span>
<span id="nav-help"><a href="https://tomcat.apache.org/findhelp.html">Find Help</a></span>
<br class="separator" />
</div>
<div id="asf-box">
<h1>Apache Tomcat/X.X.XX</h1>
</div>
<div id="upper" class="curved container">
<div id="congrats" class="curved container">
<h2>If you're seeing this, you've successfully installed Tomcat. Congratulations!</h2>
<SNIP>
```
### Nginx DockeråŒ–ç‰ˆæœ¬
```bash
git clone https://github.com/ScribblerCoder/nginx-ajp-docker
cd nginx-ajp-docker
```
æ›¿æ¢`nginx.conf`ä¸­çš„`TARGET-IP`ä¸ºAJP IPï¼Œç„¶åæ„å»ºå¹¶è¿è¡Œã€‚
```bash
docker build . -t nginx-ajp-proxy
docker run -it --rm -p 80:80 nginx-ajp-proxy
```
### Apache AJP ä»£ç†

é‡åˆ°åªæœ‰ 8009 ç«¯å£å¼€æ”¾è€Œæ²¡æœ‰å…¶ä»–å¯è®¿é—®çš„ web ç«¯å£æ˜¯ç½•è§çš„ã€‚ç„¶è€Œï¼Œä»ç„¶å¯ä»¥åˆ©ç”¨ **Metasploit** æ¥åˆ©ç”¨å®ƒã€‚é€šè¿‡åˆ©ç”¨ **Apache** ä½œä¸ºä»£ç†ï¼Œè¯·æ±‚å¯ä»¥è¢«é‡å®šå‘åˆ°ç«¯å£ 8009 ä¸Šçš„ **Tomcat**ã€‚
```bash
sudo apt-get install libapache2-mod-jk
sudo vim /etc/apache2/apache2.conf # append the following line to the config
Include ajp.conf
sudo vim /etc/apache2/ajp.conf     # create the following file, change HOST to the target address
ProxyRequests Off
<Proxy *>
Order deny,allow
Deny from all
Allow from localhost
</Proxy>
ProxyPass       / ajp://HOST:8009/
ProxyPassReverse    / ajp://HOST:8009/
sudo a2enmod proxy_http
sudo a2enmod proxy_ajp
sudo systemctl restart apache2
```
è¿™ç§è®¾ç½®å…·æœ‰ç»•è¿‡å…¥ä¾µæ£€æµ‹å’Œé˜²èŒƒç³»ç»Ÿï¼ˆIDS/IPSï¼‰çš„æ½œåŠ›ï¼Œè¿™æ˜¯ç”±äº**AJPåè®®çš„äºŒè¿›åˆ¶ç‰¹æ€§**ï¼Œå°½ç®¡è¿™ç§èƒ½åŠ›å°šæœªç»è¿‡éªŒè¯ã€‚é€šè¿‡å°†å¸¸è§„çš„Metasploit Tomcatæ¼æ´åˆ©ç”¨æŒ‡å‘`127.0.0.1:80`ï¼Œæ‚¨å¯ä»¥æœ‰æ•ˆåœ°æ§åˆ¶ç›®æ ‡ç³»ç»Ÿã€‚
```bash
msf  exploit(tomcat_mgr_deploy) > show options
```
## å‚è€ƒèµ„æ–™

* [https://github.com/yaoweibin/nginx\_ajp\_module](https://github.com/yaoweibin/nginx\_ajp\_module)
* [https://academy.hackthebox.com/module/145/section/1295](https://academy.hackthebox.com/module/145/section/1295)

<figure><img src="../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

åŠ å…¥ [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) æœåŠ¡å™¨ï¼Œä¸ç»éªŒä¸°å¯Œçš„é»‘å®¢å’Œèµé‡‘çŒäººäº¤æµï¼

**é»‘å®¢è§è§£**\
å‚ä¸æ·±å…¥æ¢è®¨é»‘å®¢æ´»åŠ¨çš„åˆºæ¿€å’ŒæŒ‘æˆ˜çš„å†…å®¹

**å®æ—¶é»‘å®¢æ–°é—»**\
é€šè¿‡å®æ—¶æ–°é—»å’Œè§è§£åŠæ—¶äº†è§£å¿«èŠ‚å¥çš„é»‘å®¢ä¸–ç•Œ

**æœ€æ–°å…¬å‘Š**\
äº†è§£æœ€æ–°çš„èµé‡‘ä»»åŠ¡å‘å¸ƒå’Œé‡è¦å¹³å°æ›´æ–°

**åŠ å…¥æˆ‘ä»¬çš„** [**Discord**](https://discord.com/invite/N3FrSbmwdy) å¹¶å¼€å§‹ä¸é¡¶å°–é»‘å®¢åˆä½œå§ï¼

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS çº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨ HackTricks ä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½ PDF ç‰ˆæœ¬çš„ HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)** ä¸Šå…³æ³¨æˆ‘ä»¬**ã€‚
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
