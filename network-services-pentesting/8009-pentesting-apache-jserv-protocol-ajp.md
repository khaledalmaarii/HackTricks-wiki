# 8009 - Pentestiranje Apache JServ protokola (AJP)

<details>

<summary><strong>Nauƒçite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naƒçini podr≈°ke HackTricks-u:

* Ako ≈æelite da vidite **va≈°u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniƒçni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na≈°u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru≈æite se** üí¨ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

Pridru≈æite se [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) serveru kako biste komunicirali sa iskusnim hakerima i lovcima na bagove!

**Hakerski uvidi**\
Ukljuƒçite se u sadr≈æaj koji istra≈æuje uzbuƒëenje i izazove hakovanja

**Hakerske vesti u realnom vremenu**\
Budite u toku sa brzim svetom hakovanja kroz vesti i uvide u realnom vremenu

**Najnovije objave**\
Budite informisani o najnovijim pokretanjima nagrada za pronala≈æenje bagova i va≈ænim a≈æuriranjima platforme

**Pridru≈æite nam se na** [**Discord-u**](https://discord.com/invite/N3FrSbmwdy) i poƒçnite da saraƒëujete sa vrhunskim hakerima danas!

## Osnovne informacije

Izvor: [https://diablohorn.com/2011/10/19/8009-the-forgotten-tomcat-port/](https://diablohorn.com/2011/10/19/8009-the-forgotten-tomcat-port/)

> AJP je ≈æiƒçani protokol. To je optimizovana verzija HTTP protokola koja omoguƒáava samostalnom veb serveru kao ≈°to je [Apache](http://httpd.apache.org/) da komunicira sa Tomcat-om. Istoriski gledano, Apache je bio mnogo br≈æi od Tomcat-a u slu≈æenju statiƒçkog sadr≈æaja. Ideja je da se Apache koristi za slu≈æenje statiƒçkog sadr≈æaja kada je to moguƒáe, ali da se za Tomcat-ov sadr≈æaj koristi proxy zahtev.

Takoƒëe interesantno:

> Protokol ajp13 je orijentisan prema paketima. Binarni format je verovatno izabran umesto ƒçitljivijeg obiƒçnog teksta iz razloga performansi. Veb server komunicira sa servlet kontejnerom preko TCP konekcija. Da bi se smanjio skup proces kreiranja soketa, veb server ƒáe poku≈°ati da odr≈æava trajne TCP konekcije sa servlet kontejnerom i da koristi istu konekciju za vi≈°e ciklusa zahteva/odgovora.

**Podrazumevani port:** 8009
```
PORT     STATE SERVICE
8009/tcp open  ajp13
```
## CVE-2020-1938 ['Ghostcat'](https://www.chaitin.cn/en/ghostcat)

Ako je AJP port izlo≈æen, Tomcat mo≈æe biti podlo≈æan Ghostcat ranjivosti. Ovde je [exploit](https://www.exploit-db.com/exploits/48143) koji radi sa ovim problemom.

Ghostcat je LFI ranjivost, ali ne≈°to ograniƒçena: samo se mogu izvuƒái fajlovi sa odreƒëene putanje. Ipak, to mo≈æe ukljuƒçivati fajlove poput `WEB-INF/web.xml` koji mogu otkriti va≈æne informacije poput akreditacija za Tomcat interfejs, u zavisnosti od pode≈°avanja servera.

Popravljene verzije 9.0.31, 8.5.51 i 7.0.100 su re≈°ile ovaj problem.

## Enumeracija

### Automatska
```bash
nmap -sV --script ajp-auth,ajp-headers,ajp-methods,ajp-request -n -p 8009 <IP>
```
### [**Brute force**](../generic-methodologies-and-resources/brute-force.md#ajp)

## AJP Proxy

### Nginx Reverse Proxy & AJP

[Proverite Docker verziju](#Dockerized-version)

Kada naiƒëemo na otvoren AJP proxy port (8009 TCP), mo≈æemo koristiti Nginx sa `ajp_module` da pristupimo "skrivenom" Tomcat Manager-u. To se mo≈æe postiƒái kompajliranjem izvornog koda Nginx-a i dodavanjem potrebnog modula na sledeƒái naƒçin:

* Preuzmite izvorni kod Nginx-a
* Preuzmite potrebni modul
* Kompajlirajte izvorni kod Nginx-a sa `ajp_module`.
* Kreirajte konfiguracioni fajl koji pokazuje na AJP Port
```bash
# Download Nginx code
wget https://nginx.org/download/nginx-1.21.3.tar.gz
tar -xzvf nginx-1.21.3.tar.gz

# Compile Nginx source code with the ajp module
git clone https://github.com/dvershinin/nginx_ajp_module.git
cd nginx-1.21.3
sudo apt install libpcre3-dev
./configure --add-module=`pwd`/../nginx_ajp_module --prefix=/etc/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib/nginx/modules
make
sudo make install
nginx -V
```
Komentari≈°ite ceo `server` blok i dodajte sledeƒáe linije unutar `http` bloka u `/etc/nginx/conf/nginx.conf` fajlu.
```shell-session
upstream tomcats {
server <TARGET_SERVER>:8009;
keepalive 10;
}
server {
listen 80;
location / {
ajp_keep_conn on;
ajp_pass tomcats;
}
}
```
Pokrenite Nginx i proverite da li sve radi ispravno izdavanjem cURL zahteva ka lokalnom hostu.
```html
sudo nginx
curl http://127.0.0.1:80

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Apache Tomcat/X.X.XX</title>
<link href="favicon.ico" rel="icon" type="image/x-icon" />
<link href="favicon.ico" rel="shortcut icon" type="image/x-icon" />
<link href="tomcat.css" rel="stylesheet" type="text/css" />
</headas
<body>
<div id="wrapper">
<div id="navigation" class="curved container">
<span id="nav-home"><a href="https://tomcat.apache.org/">Home</a></span>
<span id="nav-hosts"><a href="/docs/">Documentation</a></span>
<span id="nav-config"><a href="/docs/config/">Configuration</a></span>
<span id="nav-examples"><a href="/examples/">Examples</a></span>
<span id="nav-wiki"><a href="https://wiki.apache.org/tomcat/FrontPage">Wiki</a></span>
<span id="nav-lists"><a href="https://tomcat.apache.org/lists.html">Mailing Lists</a></span>
<span id="nav-help"><a href="https://tomcat.apache.org/findhelp.html">Find Help</a></span>
<br class="separator" />
</div>
<div id="asf-box">
<h1>Apache Tomcat/X.X.XX</h1>
</div>
<div id="upper" class="curved container">
<div id="congrats" class="curved container">
<h2>If you're seeing this, you've successfully installed Tomcat. Congratulations!</h2>
<SNIP>
```
### Nginx Dockerizovana verzija
```bash
git clone https://github.com/ScribblerCoder/nginx-ajp-docker
cd nginx-ajp-docker
```
Zamenite `TARGET-IP` u `nginx.conf` sa AJP IP adresom, zatim izgradite i pokrenite.
``` bash
docker build . -t nginx-ajp-proxy
docker run -it --rm -p 80:80 nginx-ajp-proxy
```
### Apache AJP Proxy

Nailazak otvorenog porta 8009 bez drugih dostupnih web portova je retka pojava. Meƒëutim, i dalje je moguƒáe iskoristiti ga pomoƒáu **Metasploita**. Kori≈°ƒáenjem **Apachea** kao proksija, zahtevi mogu biti preusmereni na **Tomcat** na portu 8009.
```bash
sudo apt-get install libapache2-mod-jk
sudo vim /etc/apache2/apache2.conf # append the following line to the config
Include ajp.conf
sudo vim /etc/apache2/ajp.conf     # create the following file, change HOST to the target address
ProxyRequests Off
<Proxy *>
Order deny,allow
Deny from all
Allow from localhost
</Proxy>
ProxyPass       / ajp://HOST:8009/
ProxyPassReverse    / ajp://HOST:8009/
sudo a2enmod proxy_http
sudo a2enmod proxy_ajp
sudo systemctl restart apache2
```
Ova konfiguracija pru≈æa moguƒánost zaobila≈æenja sistema za detekciju i prevenciju upada (IDS/IPS) zbog binarne prirode **AJP protokola**, iako ova sposobnost nije potvrƒëena. Usmeravanjem redovnog Metasploit Tomcat napada na `127.0.0.1:80`, mo≈æete efikasno preuzeti kontrolu nad ciljanim sistemom.
```bash
msf  exploit(tomcat_mgr_deploy) > show options
```
## Reference
* [https://github.com/yaoweibin/nginx_ajp_module](https://github.com/yaoweibin/nginx_ajp_module)
* [https://academy.hackthebox.com/module/145/section/1295](https://academy.hackthebox.com/module/145/section/1295)

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

Pridru≈æite se [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) serveru kako biste komunicirali sa iskusnim hakerima i lovcima na bagove!

**Hakerski uvidi**\
Ukljuƒçite se u sadr≈æaj koji istra≈æuje uzbuƒëenje i izazove hakovanja.

**Vesti o hakovanju u realnom vremenu**\
Budite u toku sa brzim svetom hakovanja kroz vesti i uvide u realnom vremenu.

**Najnovije obave≈°tenja**\
Budite informisani o najnovijim pokretanjima nagrada za pronala≈æenje bagova i va≈ænim a≈æuriranjima platforme.

**Pridru≈æite nam se na** [**Discord-u**](https://discord.com/invite/N3FrSbmwdy) i poƒçnite da saraƒëujete sa vrhunskim hakerima danas!

<details>

<summary><strong>Nauƒçite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naƒçini podr≈°ke HackTricks-u:

* Ako ≈æelite da vidite **ogla≈°avanje va≈°e kompanije u HackTricks-u** ili **preuzmete HackTricks u PDF formatu**, proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniƒçni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na≈°u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru≈æite se** üí¨ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje trikove hakovanja slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
