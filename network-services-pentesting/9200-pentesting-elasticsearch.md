# 9200 - Pentesting Elasticsearch

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju oglaÅ¡enu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Osnovne informacije

Elasticsearch je **distribuirani**, **open source** pretraÅ¾ivaÄ i analitiÄki sistem za **sve vrste podataka**. Poznat je po svojoj **brzini**, **Å¡alabilnosti** i **jednostavnim REST API-ima**. IzgraÄ‘en na Apache Lucene-u, prvi put je objavljen 2010. godine od strane Elasticsearch N.V. (sada poznat kao Elastic). Elasticsearch je osnovna komponenta Elastic Stack-a, kolekcije open source alata za unos, obogaÄ‡ivanje, skladiÅ¡tenje, analizu i vizualizaciju podataka. Ova kolekcija, Äesto nazvana ELK Stack, takoÄ‘e ukljuÄuje Logstash i Kibana, a sada ima i lagane agente za slanje podataka nazvane Beats.

### Å ta je Elasticsearch indeks?

Elasticsearch **indeks** je kolekcija **povezanih dokumenata** koji se Äuvaju kao **JSON**. Svaki dokument se sastoji od **kljuÄeva** i njihovih odgovarajuÄ‡ih **vrednosti** (stringovi, brojevi, boolean vrednosti, datumi, nizovi, geolokacije, itd.).

Elasticsearch koristi efikasnu strukturu podataka nazvanu **inverzni indeks** kako bi omoguÄ‡io brze pretrage celokupnog teksta. Ovaj indeks navodi svaku jedinstvenu reÄ u dokumentima i identifikuje dokumente u kojima se svaka reÄ pojavljuje.

Tokom procesa indeksiranja, Elasticsearch Äuva dokumente i konstruiÅ¡e inverzni indeks, Å¡to omoguÄ‡ava pretragu u gotovo realnom vremenu. **Index API** se koristi za dodavanje ili aÅ¾uriranje JSON dokumenata unutar odreÄ‘enog indeksa.

**Podrazumevani port**: 9200/tcp

## RuÄno nabrajanje

### Banner

Protokol koji se koristi za pristup Elasticsearch-u je **HTTP**. Kada pristupite preko HTTP-a, pronaÄ‡i Ä‡ete neke interesantne informacije: `http://10.10.10.115:9200/`

![](<../.gitbook/assets/image (264).png>)

Ako ne vidite tu odgovor pristupajuÄ‡i `/`, pogledajte sledeÄ‡i odeljak.

### Autentifikacija

**Podrazumevano Elasticsearch nema omoguÄ‡enu autentifikaciju**, tako da podrazumevano moÅ¾ete pristupiti svemu unutar baze podataka bez koriÅ¡Ä‡enja bilo kakvih akreditacija.

MoÅ¾ete proveriti da li je autentifikacija onemoguÄ‡ena zahtevom ka:
```bash
curl -X GET "ELASTICSEARCH-SERVER:9200/_xpack/security/user"
{"error":{"root_cause":[{"type":"exception","reason":"Security must be explicitly enabled when using a [basic] license. Enable security by setting [xpack.security.enabled] to [true] in the elasticsearch.yml file and restart the node."}],"type":"exception","reason":"Security must be explicitly enabled when using a [basic] license. Enable security by setting [xpack.security.enabled] to [true] in the elasticsearch.yml file and restart the node."},"status":500}
```
**MeÄ‘utim**, ako poÅ¡aljete zahtev na `/` i dobijete odgovor kao Å¡to je sledeÄ‡i:
```bash
{"error":{"root_cause":[{"type":"security_exception","reason":"missing authentication credentials for REST request [/]","header":{"WWW-Authenticate":"Basic realm=\"security\" charset=\"UTF-8\""}}],"type":"security_exception","reason":"missing authentication credentials for REST request [/]","header":{"WWW-Authenticate":"Basic realm=\"security\" charset=\"UTF-8\""}},"status":401}
```
To znaÄi da je konfigurisana autentifikacija i **potrebne su vam validne akreditacije** da biste dobili bilo kakve informacije iz Elasticsearch-a. Zatim, moÅ¾ete [**pokuÅ¡ati da izvrÅ¡ite brute force napad**](../generic-methodologies-and-resources/brute-force.md#elasticsearch) (koristi HTTP osnovnu autentifikaciju, pa se moÅ¾e koristiti bilo Å¡ta Å¡to moÅ¾e da izvrÅ¡i BF HTTP osnovne autentifikacije).\
Evo vam **lista podrazumevanih korisniÄkih imena**: _**elastic** (superkorisnik), remote\_monitoring\_user, beats\_system, logstash\_system, kibana, kibana\_system, apm\_system,_ \_anonymous\_.\_ Starije verzije Elasticsearch-a imaju podrazumevanu lozinku **changeme** za ovog korisnika.
```
curl -X GET http://user:password@IP:9200/
```
### Osnovno prebrojavanje korisnika

Kada se bavite pentestiranjem Elasticsearcha, prvi korak je da identifikujete postojeÄ‡e korisnike sistema. Ovo se moÅ¾e postiÄ‡i koriÅ¡Ä‡enjem razliÄitih metoda prebrojavanja korisnika.

#### 1. PretraÅ¾ivanje indeksa

Jedan od naÄina da se pronaÄ‘u korisnici je pretraÅ¾ivanje indeksa koji sadrÅ¾e informacije o korisnicima. MoÅ¾ete koristiti Elasticsearch API za pretragu indeksa i filtriranje rezultata kako biste pronaÅ¡li relevantne informacije o korisnicima.

```bash
GET /_search
{
  "query": {
    "match": {
      "field": "value"
    }
  }
}
```

#### 2. KoriÅ¡Ä‡enje API-ja za pretragu korisnika

Elasticsearch takoÄ‘e pruÅ¾a API za pretragu korisnika. MoÅ¾ete koristiti ovaj API za dobijanje informacija o postojeÄ‡im korisnicima.

```bash
GET /_security/user
```

#### 3. KoriÅ¡Ä‡enje alata za prebrojavanje korisnika

Postoje i alati koji vam mogu pomoÄ‡i da automatski prebrojite korisnike Elasticsearcha. Na primer, moÅ¾ete koristiti alat poput `esusers` za prebrojavanje korisnika.

```bash
esusers list
```

Kada prebrojite korisnike, moÅ¾ete koristiti ove informacije za dalje istraÅ¾ivanje i testiranje sistema.
```bash
#List all roles on the system:
curl -X GET "ELASTICSEARCH-SERVER:9200/_security/role"

#List all users on the system:
curl -X GET "ELASTICSEARCH-SERVER:9200/_security/user"

#Get more information about the rights of an user:
curl -X GET "ELASTICSEARCH-SERVER:9200/_security/user/<USERNAME>"
```
### Elastic Info

Evo nekih endpointa do kojih moÅ¾ete **pristupiti putem GET zahteva** kako biste **dobili** neke **informacije** o Elasticsearch-u:

| \_cat                           | /\_cluster                    | /\_security               |
| ------------------------------- | ----------------------------- | ------------------------- |
| /\_cat/segments                 | /\_cluster/allocation/explain | /\_security/user          |
| /\_cat/shards                   | /\_cluster/settings           | /\_security/privilege     |
| /\_cat/repositories             | /\_cluster/health             | /\_security/role\_mapping |
| /\_cat/recovery                 | /\_cluster/state              | /\_security/role          |
| /\_cat/plugins                  | /\_cluster/stats              | /\_security/api\_key      |
| /\_cat/pending\_tasks           | /\_cluster/pending\_tasks     |                           |
| /\_cat/nodes                    | /\_nodes                      |                           |
| /\_cat/tasks                    | /\_nodes/usage                |                           |
| /\_cat/templates                | /\_nodes/hot\_threads         |                           |
| /\_cat/thread\_pool             | /\_nodes/stats                |                           |
| /\_cat/ml/trained\_models       | /\_tasks                      |                           |
| /\_cat/transforms/\_all         | /\_remote/info                |                           |
| /\_cat/aliases                  |                               |                           |
| /\_cat/allocation               |                               |                           |
| /\_cat/ml/anomaly\_detectors    |                               |                           |
| /\_cat/count                    |                               |                           |
| /\_cat/ml/data\_frame/analytics |                               |                           |
| /\_cat/ml/datafeeds             |                               |                           |
| /\_cat/fielddata                |                               |                           |
| /\_cat/health                   |                               |                           |
| /\_cat/indices                  |                               |                           |
| /\_cat/master                   |                               |                           |
| /\_cat/nodeattrs                |                               |                           |
| /\_cat/nodes                    |                               |                           |

Ovi endpointi su [**preuzeti iz dokumentacije**](https://www.elastic.co/guide/en/elasticsearch/reference/current/rest-apis.html) gde moÅ¾ete **pronaÄ‡i viÅ¡e** informacija.\
TakoÄ‘e, ako pristupite `/_cat`, odgovor Ä‡e sadrÅ¾ati `/_cat/*` endpointe podrÅ¾ane od strane instance.

U `/_security/user` (ako je autentifikacija omoguÄ‡ena) moÅ¾ete videti koji korisnik ima ulogu `superuser`.

### Indeksi

MoÅ¾ete **prikupiti sve indekse** pristupanjem `http://10.10.10.115:9200/_cat/indices?v`
```
health status index   uuid                   pri rep docs.count docs.deleted store.size pri.store.size
green  open   .kibana 6tjAYZrgQ5CwwR0g6VOoRg   1   0          1            0        4kb            4kb
yellow open   quotes  ZG2D1IqkQNiNZmi2HRImnQ   5   1        253            0    262.7kb        262.7kb
yellow open   bank    eSVpNfCfREyYoVigNWcrMw   5   1       1000            0    483.2kb        483.2kb
```
Da biste dobili **informacije o vrsti podataka koji su spremljeni unutar indeksa**, moÅ¾ete pristupiti: `http://host:9200/<index>` na primer u ovom sluÄaju `http://10.10.10.115:9200/bank`

![](<../.gitbook/assets/image (265).png>)

### Dump indeksa

Ako Å¾elite **izbaciti sve sadrÅ¾aje** indeksa, moÅ¾ete pristupiti: `http://host:9200/<index>/_search?pretty=true` kao Å¡to je `http://10.10.10.115:9200/bank/_search?pretty=true`

![](<../.gitbook/assets/image (266).png>)

_Uzmite trenutak da uporedite sadrÅ¾aj svakog dokumenta (unosa) unutar bankovnog indeksa i polja ovog indeksa koje smo videli u prethodnom odeljku._

Dakle, u ovom trenutku moÅ¾ete primetiti da **postoji polje nazvano "total" unutar "hits"** koje ukazuje da je pronaÄ‘eno **1000 dokumenata** unutar ovog indeksa, ali je vraÄ‡eno samo 10. To je zato Å¡to **podrazumevano postoji ograniÄenje od 10 dokumenata**.\
Ali, sada kada znate da **ovaj indeks sadrÅ¾i 1000 dokumenata**, moÅ¾ete **izbaciti sve njih** navodeÄ‡i broj unosa koje Å¾elite izbaciti u parametru **`size`**: `http://10.10.10.115:9200/quotes/_search?pretty=true&size=1000`asd\
_Napomena: Ako navedete veÄ‡i broj, svi unosi Ä‡e biti izbaÄeni, na primer moÅ¾ete navesti `size=9999` i biÄ‡e Äudno ako ima viÅ¡e unosa (ali trebali biste proveriti)._

### Dump svega

Da biste izbacili sve, jednostavno idite na **isti put kao i prethodno, ali bez navoÄ‘enja bilo kojeg indeksa** `http://host:9200/_search?pretty=true` kao `http://10.10.10.115:9200/_search?pretty=true`\
Zapamtite da Ä‡e u ovom sluÄaju biti primenjen **podrazumevani limit od 10** rezultata. MoÅ¾ete koristiti parametar `size` da biste izbacili **veÄ‡i broj rezultata**. ProÄitajte prethodni odeljak za viÅ¡e informacija.

### Pretraga

Ako traÅ¾ite neke informacije, moÅ¾ete izvrÅ¡iti **sirovu pretragu svih indeksa** odlaskom na `http://host:9200/_search?pretty=true&q=<search_term>` kao u `http://10.10.10.115:9200/_search?pretty=true&q=Rockwell`

![](<../.gitbook/assets/image (267).png>)

Ako Å¾elite samo **pretraÅ¾ivati na jednom indeksu**, jednostavno ga **navedite** u **putanji**: `http://host:9200/<index>/_search?pretty=true&q=<search_term>`

_UoÄite da parametar q koji se koristi za pretragu sadrÅ¾aja **podrÅ¾ava regularne izraze**_

TakoÄ‘e moÅ¾ete koristiti neÅ¡to poput [https://github.com/misalabs/horuz](https://github.com/misalabs/horuz) za testiranje elasticsearch servisa.

### Dozvole za pisanje

MoÅ¾ete proveriti dozvole za pisanje pokuÅ¡avajuÄ‡i da kreirate novi dokument unutar novog indeksa pokretanjem neÄega poput sledeÄ‡eg:
```bash
curl -X POST '10.10.10.115:9200/bookindex/books' -H 'Content-Type: application/json' -d'
{
"bookId" : "A00-3",
"author" : "Sankaran",
"publisher" : "Mcgrahill",
"name" : "how to get a job"
}'
```
Ta komanda Ä‡e kreirati **novi indeks** nazvan `bookindex` sa dokumentom tipa `books` koji ima atribute "_bookId_", "_author_", "_publisher_" i "_name_"

Primetite kako se **novi indeks sada pojavljuje na listi**:

![](<../.gitbook/assets/image (268).png>)

I obratite paÅ¾nju na **automatski kreirane osobine**:

![](<../.gitbook/assets/image (269).png>)

## Automatsko nabrojavanje

Neki alati Ä‡e dobiti neke od prikazanih podataka prethodno:
```bash
msf > use auxiliary/scanner/elasticsearch/indices_enum
```
{% embed url="https://github.com/theMiddleBlue/nmap-elasticsearch-nse" %}

## Shodan

* `port:9200 elasticsearch`

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
