# 9200 - Testowanie penetracyjne Elasticsearch

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Podstawowe informacje

Elasticsearch to **rozproszony**, **open source'owy** silnik wyszukiwania i analizy dla **wszystkich typ贸w danych**. Jest znany ze swojej **szybkoci**, **skalowalnoci** i **prostych interfejs贸w REST**. Zbudowany na Apache Lucene, zosta po raz pierwszy wydany w 2010 roku przez Elasticsearch N.V. (obecnie znany jako Elastic). Elasticsearch jest podstawowym komponentem Elastic Stack, kolekcji narzdzi open source do pobierania, wzbogacania, przechowywania, analizy i wizualizacji danych. Ten stos, czsto nazywany stos ELK, obejmuje r贸wnie偶 Logstash i Kiban, a teraz ma lekkie agenty wysyajce dane o nazwie Beats.

### Co to jest indeks Elasticsearch?

Indeks Elasticsearch to kolekcja **powizanych dokument贸w** przechowywanych jako **JSON**. Ka偶dy dokument skada si z **kluczy** i odpowiadajcych im **wartoci** (cigi znak贸w, liczby, wartoci logiczne, daty, tablice, geolokacje, itp.).

Elasticsearch u偶ywa wydajnej struktury danych o nazwie **odwr贸cony indeks**, aby umo偶liwi szybkie wyszukiwanie penotekstowe. Ten indeks zawiera list ka偶dego unikalnego sowa w dokumentach i identyfikuje dokumenty, w kt贸rych wystpuje ka偶de sowo.

Podczas procesu indeksowania Elasticsearch przechowuje dokumenty i tworzy odwr贸cony indeks, umo偶liwiajc wyszukiwanie w czasie rzeczywistym. Interfejs API indeksu su偶y do dodawania lub aktualizowania dokument贸w JSON w okrelonym indeksie.

**Domylny port**: 9200/tcp

## Rczne wyliczanie

### Baner

Protok贸 u偶ywany do dostpu do Elasticsearch to **HTTP**. Gdy uzyskasz do niego dostp za pomoc HTTP, znajdziesz kilka interesujcych informacji: `http://10.10.10.115:9200/`

![](<../.gitbook/assets/image (264).png>)

Jeli nie widzisz takiej odpowiedzi podczas dostpu do `/`, zobacz nastpn sekcj.

### Autoryzacja

**Domylnie Elasticsearch nie ma wczonej autoryzacji**, wic domylnie mo偶na uzyska dostp do wszystkiego w bazie danych bez u偶ycia 偶adnych powiadcze.

Mo偶esz sprawdzi, czy autoryzacja jest wyczona, wysyajc 偶danie do:
```bash
curl -X GET "ELASTICSEARCH-SERVER:9200/_xpack/security/user"
{"error":{"root_cause":[{"type":"exception","reason":"Security must be explicitly enabled when using a [basic] license. Enable security by setting [xpack.security.enabled] to [true] in the elasticsearch.yml file and restart the node."}],"type":"exception","reason":"Security must be explicitly enabled when using a [basic] license. Enable security by setting [xpack.security.enabled] to [true] in the elasticsearch.yml file and restart the node."},"status":500}
```
**Jednak**, jeli wysyasz 偶danie do `/` i otrzymujesz odpowied藕 podobn do tej:
```bash
{"error":{"root_cause":[{"type":"security_exception","reason":"missing authentication credentials for REST request [/]","header":{"WWW-Authenticate":"Basic realm=\"security\" charset=\"UTF-8\""}}],"type":"security_exception","reason":"missing authentication credentials for REST request [/]","header":{"WWW-Authenticate":"Basic realm=\"security\" charset=\"UTF-8\""}},"status":401}
```
To oznacza, 偶e uwierzytelnianie jest skonfigurowane i **potrzebujesz prawidowych danych uwierzytelniajcych**, aby uzyska jakiekolwiek informacje z Elasticsearch. Nastpnie mo偶esz [**spr贸bowa przeprowadzi atak brutalnej siy**](../generic-methodologies-and-resources/brute-force.md#elasticsearch) (u偶ywa on uwierzytelniania HTTP basic, wic mo偶na u偶y czegokolwiek, co potrafi atakowa uwierzytelnianie HTTP basic).\
Oto **lista domylnych nazw u偶ytkownik贸w**: _**elastic** (superu偶ytkownik), remote\_monitoring\_user, beats\_system, logstash\_system, kibana, kibana\_system, apm\_system,_ \_anonymous\_.\_ Starsze wersje Elasticsearch maj domylne haso **changeme** dla tego u偶ytkownika.
```
curl -X GET http://user:password@IP:9200/
```
### Podstawowe wyliczanie u偶ytkownik贸w

Elasticsearch provides an API endpoint that allows users to retrieve information about the cluster, including the list of indices and their settings. This can be useful for an attacker to gather information about the target system.

Elasticsearch udostpnia punkt kocowy API, kt贸ry umo偶liwia u偶ytkownikom pobieranie informacji o klastrze, w tym listy indeks贸w i ich ustawie. Mo偶e to by przydatne dla atakujcego do zebrania informacji o docelowym systemie.

To enumerate the list of indices, you can send a GET request to the `/_cat/indices` endpoint. This will return a list of all indices along with their metadata.

Aby wyliczy list indeks贸w, mo偶esz wysa 偶danie GET do punktu kocowego `/_cat/indices`. Spowoduje to zwr贸cenie listy wszystkich indeks贸w wraz z ich metadanymi.

To enumerate the list of settings for a specific index, you can send a GET request to the `/_settings/<index>` endpoint. Replace `<index>` with the name of the index you want to enumerate.

Aby wyliczy list ustawie dla okrelonego indeksu, mo偶esz wysa 偶danie GET do punktu kocowego `/_settings/<index>`. Zastp `<index>` nazw indeksu, kt贸ry chcesz wyliczy.

By default, Elasticsearch does not require authentication for these API endpoints, so an attacker can easily retrieve this information without any credentials.

Domylnie Elasticsearch nie wymaga uwierzytelniania dla tych punkt贸w kocowych API, wic atakujcy mo偶e atwo pobra te informacje bez 偶adnych powiadcze.

### Default Credentials

Elasticsearch does not have default credentials set by default. However, if the administrator has set up authentication, it is important to try common default credentials such as `admin:admin`, `elastic:elastic`, or `admin:password`.

Domylnie Elasticsearch nie ma ustawionych domylnych powiadcze. Jednak jeli administrator skonfigurowa uwierzytelnianie, wa偶ne jest, aby spr贸bowa popularnych domylnych powiadcze, takich jak `admin:admin`, `elastic:elastic` lub `admin:password`.

### Anonymous Access

In some cases, Elasticsearch may be configured to allow anonymous access. This means that anyone can access the cluster and perform actions without providing any credentials. It is important to check if anonymous access is enabled and take appropriate measures to secure the cluster.

W niekt贸rych przypadkach Elasticsearch mo偶e by skonfigurowany tak, aby umo偶liwi anonimowy dostp. Oznacza to, 偶e ka偶dy mo偶e uzyska dostp do klastra i wykonywa dziaania bez podawania 偶adnych powiadcze. Wa偶ne jest sprawdzenie, czy anonimowy dostp jest wczony i podjcie odpowiednich dziaa w celu zabezpieczenia klastra.
```bash
#List all roles on the system:
curl -X GET "ELASTICSEARCH-SERVER:9200/_security/role"

#List all users on the system:
curl -X GET "ELASTICSEARCH-SERVER:9200/_security/user"

#Get more information about the rights of an user:
curl -X GET "ELASTICSEARCH-SERVER:9200/_security/user/<USERNAME>"
```
### Informacje o Elastic

Oto kilka punkt贸w kocowych, do kt贸rych mo偶na uzyska dostp za pomoc metody GET, aby uzyska informacje o Elasticsearch:

| \_cat                           | /\_cluster                    | /\_security               |
| ------------------------------- | ----------------------------- | ------------------------- |
| /\_cat/segments                 | /\_cluster/allocation/explain | /\_security/user          |
| /\_cat/shards                   | /\_cluster/settings           | /\_security/privilege     |
| /\_cat/repositories             | /\_cluster/health             | /\_security/role\_mapping |
| /\_cat/recovery                 | /\_cluster/state              | /\_security/role          |
| /\_cat/plugins                  | /\_cluster/stats              | /\_security/api\_key      |
| /\_cat/pending\_tasks           | /\_cluster/pending\_tasks     |                           |
| /\_cat/nodes                    | /\_nodes                      |                           |
| /\_cat/tasks                    | /\_nodes/usage                |                           |
| /\_cat/templates                | /\_nodes/hot\_threads         |                           |
| /\_cat/thread\_pool             | /\_nodes/stats                |                           |
| /\_cat/ml/trained\_models       | /\_tasks                      |                           |
| /\_cat/transforms/\_all         | /\_remote/info                |                           |
| /\_cat/aliases                  |                               |                           |
| /\_cat/allocation               |                               |                           |
| /\_cat/ml/anomaly\_detectors    |                               |                           |
| /\_cat/count                    |                               |                           |
| /\_cat/ml/data\_frame/analytics |                               |                           |
| /\_cat/ml/datafeeds             |                               |                           |
| /\_cat/fielddata                |                               |                           |
| /\_cat/health                   |                               |                           |
| /\_cat/indices                  |                               |                           |
| /\_cat/master                   |                               |                           |
| /\_cat/nodeattrs                |                               |                           |
| /\_cat/nodes                    |                               |                           |

Te punkty kocowe zostay [**pobrane z dokumentacji**](https://www.elastic.co/guide/en/elasticsearch/reference/current/rest-apis.html), gdzie mo偶na znale藕 wicej informacji.\
Dodatkowo, jeli uzyskasz dostp do `/_cat`, odpowied藕 bdzie zawiera punkty kocowe `/_cat/*` obsugiwane przez instancj.

W `/_security/user` (jeli uwierzytelnianie jest wczone), mo偶na zobaczy, kt贸ry u偶ytkownik ma rol `superuser`.

### Indeksy

Aby **uzyska wszystkie indeksy**, mo偶na uzyska dostp do `http://10.10.10.115:9200/_cat/indices?v`
```
health status index   uuid                   pri rep docs.count docs.deleted store.size pri.store.size
green  open   .kibana 6tjAYZrgQ5CwwR0g6VOoRg   1   0          1            0        4kb            4kb
yellow open   quotes  ZG2D1IqkQNiNZmi2HRImnQ   5   1        253            0    262.7kb        262.7kb
yellow open   bank    eSVpNfCfREyYoVigNWcrMw   5   1       1000            0    483.2kb        483.2kb
```
Aby uzyska **informacje na temat rodzaju danych przechowywanych w indeksie**, mo偶na uzyska dostp do: `http://host:9200/<index>`, na przykad w tym przypadku `http://10.10.10.115:9200/bank`

![](<../.gitbook/assets/image (265).png>)

### Wydrukuj indeks

Jeli chcesz **wydrukowa wszystkie zawartoci** indeksu, mo偶esz uzyska dostp do: `http://host:9200/<index>/_search?pretty=true`, na przykad `http://10.10.10.115:9200/bank/_search?pretty=true`

![](<../.gitbook/assets/image (266).png>)

_Zastan贸w si przez chwil nad por贸wnaniem zawartoci ka偶dego dokumentu (wpisu) wewntrz indeksu banku i p贸l tego indeksu, kt贸re widzielimy wczeniej._

W tym momencie mo偶esz zauwa偶y, 偶e **istnieje pole o nazwie "total" wewntrz "hits"**, kt贸re wskazuje, 偶e **znaleziono 1000 dokument贸w** wewntrz tego indeksu, ale pobrano tylko 10. Dzieje si tak, poniewa偶 **domylnie istnieje limit 10 dokument贸w**.\
Ale teraz, gdy wiesz, 偶e **ten indeks zawiera 1000 dokument贸w**, mo偶esz **wydrukowa je wszystkie**, okrelajc liczb wpis贸w, kt贸re chcesz wydrukowa w parametrze **`size`**: `http://10.10.10.115:9200/quotes/_search?pretty=true&size=1000`asd\
_Uwaga: Jeli podasz wiksz liczb, wszystkie wpisy zostan wydrukowane, na przykad mo偶esz poda `size=9999`, ale warto sprawdzi, czy istniej wicej wpis贸w._

### Wydrukuj wszystko

Aby wydrukowa wszystko, mo偶esz po prostu przej do **tej samej cie偶ki jak wczeniej, ale bez wskazywania 偶adnego indeksu** `http://host:9200/_search?pretty=true`, na przykad `http://10.10.10.115:9200/_search?pretty=true`\
Pamitaj, 偶e w tym przypadku zostanie zastosowany **domylny limit 10** wynik贸w. Mo偶esz u偶y parametru `size`, aby wydrukowa **wiksz ilo wynik贸w**. Przeczytaj poprzedni sekcj, aby uzyska wicej informacji.

### Wyszukiwanie

Jeli szukasz jakich informacji, mo偶esz przeprowadzi **surowe wyszukiwanie we wszystkich indeksach**, przechodzc do `http://host:9200/_search?pretty=true&q=<search_term>`, na przykad `http://10.10.10.115:9200/_search?pretty=true&q=Rockwell`

![](<../.gitbook/assets/image (267).png>)

Jeli chcesz **wyszuka tylko w jednym indeksie**, mo偶esz po prostu **okreli** go na **cie偶ce**: `http://host:9200/<index>/_search?pretty=true&q=<search_term>`

_Zauwa偶, 偶e parametr q u偶ywany do wyszukiwania zawartoci **obsuguje wyra偶enia regularne**_

Mo偶esz r贸wnie偶 u偶y czego takiego jak [https://github.com/misalabs/horuz](https://github.com/misalabs/horuz), aby przetestowa usug Elasticsearch.

### Uprawnienia do zapisu

Mo偶esz sprawdzi swoje uprawnienia do zapisu, pr贸bujc utworzy nowy dokument w nowym indeksie, uruchamiajc co takiego jak poni偶ej:
```bash
curl -X POST '10.10.10.115:9200/bookindex/books' -H 'Content-Type: application/json' -d'
{
"bookId" : "A00-3",
"author" : "Sankaran",
"publisher" : "Mcgrahill",
"name" : "how to get a job"
}'
```
To polecenie utworzy **nowy indeks** o nazwie `bookindex` z dokumentem o typie `books`, kt贸ry ma atrybuty "_bookId_", "_author_", "_publisher_" i "_name_".

Zauwa偶, jak **nowy indeks pojawi si teraz na licie**:

![](<../.gitbook/assets/image (268).png>)

Zwr贸 uwag na **automatycznie utworzone waciwoci**:

![](<../.gitbook/assets/image (269).png>)

## Automatyczne wyliczanie

Niekt贸re narzdzia uzyskaj cz przedstawionych wczeniej danych:
```bash
msf > use auxiliary/scanner/elasticsearch/indices_enum
```
{% embed url="https://github.com/theMiddleBlue/nmap-elasticsearch-nse" %}

## Shodan

* `port:9200 elasticsearch`

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
