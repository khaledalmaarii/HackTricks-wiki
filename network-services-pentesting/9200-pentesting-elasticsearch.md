# 9200 - Pentesting Elasticsearch

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Informations de base

Elasticsearch est un moteur de recherche et d'analyse **distribu√©**, **open source** pour **tous types de donn√©es**. Il est connu pour sa **rapidit√©**, sa **scalabilit√©** et ses **API REST simples**. Bas√© sur Apache Lucene, il a √©t√© publi√© pour la premi√®re fois en 2010 par Elasticsearch N.V. (aujourd'hui connu sous le nom d'Elastic). Elasticsearch est le composant central de l'Elastic Stack, une collection d'outils open source pour l'ingestion, l'enrichissement, le stockage, l'analyse et la visualisation des donn√©es. Ce stack, commun√©ment appel√© ELK Stack, comprend √©galement Logstash et Kibana, et dispose maintenant d'agents d'exp√©dition de donn√©es l√©gers appel√©s Beats.

### Qu'est-ce qu'un index Elasticsearch ?

Un **index** Elasticsearch est une collection de **documents li√©s** stock√©s sous forme de **JSON**. Chaque document se compose de **cl√©s** et de leurs **valeurs** correspondantes (cha√Ænes, nombres, bool√©ens, dates, tableaux, g√©olocalisations, etc.).

Elasticsearch utilise une structure de donn√©es efficace appel√©e **index invers√©** pour faciliter des recherches en texte int√©gral rapides. Cet index r√©pertorie chaque mot unique dans les documents et identifie les documents dans lesquels chaque mot appara√Æt.

Au cours du processus d'indexation, Elasticsearch stocke les documents et construit l'index invers√©, permettant des recherches quasi en temps r√©el. L'**API d'index** est utilis√©e pour ajouter ou mettre √† jour des documents JSON dans un index sp√©cifique.

**Port par d√©faut** : 9200/tcp

## √ânum√©ration manuelle

### Banni√®re

Le protocole utilis√© pour acc√©der √† Elasticsearch est **HTTP**. Lorsque vous y acc√©dez via HTTP, vous trouverez des informations int√©ressantes : `http://10.10.10.115:9200/`

![](<../.gitbook/assets/image (294).png>)

Si vous ne voyez pas cette r√©ponse en acc√©dant √† `/`, consultez la section suivante.

### Authentification

**Par d√©faut, Elasticsearch n'a pas d'authentification activ√©e**, donc par d√©faut, vous pouvez acc√©der √† tout √† l'int√©rieur de la base de donn√©es sans utiliser de credentials.

Vous pouvez v√©rifier que l'authentification est d√©sactiv√©e avec une requ√™te √† :
```bash
curl -X GET "ELASTICSEARCH-SERVER:9200/_xpack/security/user"
{"error":{"root_cause":[{"type":"exception","reason":"Security must be explicitly enabled when using a [basic] license. Enable security by setting [xpack.security.enabled] to [true] in the elasticsearch.yml file and restart the node."}],"type":"exception","reason":"Security must be explicitly enabled when using a [basic] license. Enable security by setting [xpack.security.enabled] to [true] in the elasticsearch.yml file and restart the node."},"status":500}
```
**Cependant**, si vous envoyez une requ√™te √† `/` et recevez une r√©ponse comme celle-ci :
```bash
{"error":{"root_cause":[{"type":"security_exception","reason":"missing authentication credentials for REST request [/]","header":{"WWW-Authenticate":"Basic realm=\"security\" charset=\"UTF-8\""}}],"type":"security_exception","reason":"missing authentication credentials for REST request [/]","header":{"WWW-Authenticate":"Basic realm=\"security\" charset=\"UTF-8\""}},"status":401}
```
Cela signifie que l'authentification est configur√©e et **vous avez besoin de credentials valides** pour obtenir des informations d'Elasticsearch. Ensuite, vous pouvez [**essayer de le bruteforcer**](../generic-methodologies-and-resources/brute-force.md#elasticsearch) (il utilise l'authentification HTTP basique, donc tout ce qui peut BF HTTP basic auth peut √™tre utilis√©).\
Voici une **liste des noms d'utilisateur par d√©faut** : _**elastic** (superutilisateur), remote\_monitoring\_user, beats\_system, logstash\_system, kibana, kibana\_system, apm\_system,_ \_anonymous\_._ Les anciennes versions d'Elasticsearch ont le mot de passe par d√©faut **changeme** pour cet utilisateur.
```
curl -X GET http://user:password@IP:9200/
```
### √ânum√©ration de base des utilisateurs
```bash
#List all roles on the system:
curl -X GET "ELASTICSEARCH-SERVER:9200/_security/role"

#List all users on the system:
curl -X GET "ELASTICSEARCH-SERVER:9200/_security/user"

#Get more information about the rights of an user:
curl -X GET "ELASTICSEARCH-SERVER:9200/_security/user/<USERNAME>"
```
### Elastic Info

Voici quelques points de terminaison que vous pouvez **acc√©der via GET** pour **obtenir** des **informations** sur elasticsearch :

| \_cat                           | /\_cluster                    | /\_security               |
| ------------------------------- | ----------------------------- | ------------------------- |
| /\_cat/segments                 | /\_cluster/allocation/explain | /\_security/user          |
| /\_cat/shards                   | /\_cluster/settings           | /\_security/privilege     |
| /\_cat/repositories             | /\_cluster/health             | /\_security/role\_mapping |
| /\_cat/recovery                 | /\_cluster/state              | /\_security/role          |
| /\_cat/plugins                  | /\_cluster/stats              | /\_security/api\_key      |
| /\_cat/pending\_tasks           | /\_cluster/pending\_tasks     |                           |
| /\_cat/nodes                    | /\_nodes                      |                           |
| /\_cat/tasks                    | /\_nodes/usage                |                           |
| /\_cat/templates                | /\_nodes/hot\_threads         |                           |
| /\_cat/thread\_pool             | /\_nodes/stats                |                           |
| /\_cat/ml/trained\_models       | /\_tasks                      |                           |
| /\_cat/transforms/\_all         | /\_remote/info                |                           |
| /\_cat/aliases                  |                               |                           |
| /\_cat/allocation               |                               |                           |
| /\_cat/ml/anomaly\_detectors    |                               |                           |
| /\_cat/count                    |                               |                           |
| /\_cat/ml/data\_frame/analytics |                               |                           |
| /\_cat/ml/datafeeds             |                               |                           |
| /\_cat/fielddata                |                               |                           |
| /\_cat/health                   |                               |                           |
| /\_cat/indices                  |                               |                           |
| /\_cat/master                   |                               |                           |
| /\_cat/nodeattrs                |                               |                           |
| /\_cat/nodes                    |                               |                           |

Ces points de terminaison ont √©t√© [**pris de la documentation**](https://www.elastic.co/guide/en/elasticsearch/reference/current/rest-apis.html) o√π vous pouvez **trouver plus**.\
De plus, si vous acc√©dez √† `/_cat`, la r√©ponse contiendra les points de terminaison `/_cat/*` pris en charge par l'instance.

Dans `/_security/user` (si l'authentification est activ√©e), vous pouvez voir quel utilisateur a le r√¥le `superuser`.

### Indices

Vous pouvez **rassembler tous les indices** en acc√©dant √† `http://10.10.10.115:9200/_cat/indices?v`
```
health status index   uuid                   pri rep docs.count docs.deleted store.size pri.store.size
green  open   .kibana 6tjAYZrgQ5CwwR0g6VOoRg   1   0          1            0        4kb            4kb
yellow open   quotes  ZG2D1IqkQNiNZmi2HRImnQ   5   1        253            0    262.7kb        262.7kb
yellow open   bank    eSVpNfCfREyYoVigNWcrMw   5   1       1000            0    483.2kb        483.2kb
```
Pour obtenir **des informations sur le type de donn√©es enregistr√©es dans un index**, vous pouvez acc√©der √† : `http://host:9200/<index>` par exemple dans ce cas `http://10.10.10.115:9200/bank`

![](<../.gitbook/assets/image (342).png>)

### Dump index

Si vous souhaitez **exporter tout le contenu** d'un index, vous pouvez acc√©der √† : `http://host:9200/<index>/_search?pretty=true` comme `http://10.10.10.115:9200/bank/_search?pretty=true`

![](<../.gitbook/assets/image (914).png>)

_Prenez un moment pour comparer le contenu de chaque document (entr√©e) dans l'index bank et les champs de cet index que nous avons vus dans la section pr√©c√©dente._

Donc, √† ce stade, vous pouvez remarquer qu'il **y a un champ appel√© "total" √† l'int√©rieur de "hits"** qui indique que **1000 documents ont √©t√© trouv√©s** dans cet index mais seulement 10 ont √©t√© r√©cup√©r√©s. Cela est d√ª au fait qu'il **y a par d√©faut une limite de 10 documents**.\
Mais maintenant que vous savez que **cet index contient 1000 documents**, vous pouvez **les exporter tous** en indiquant le nombre d'entr√©es que vous souhaitez exporter dans le param√®tre **`size`** : `http://10.10.10.115:9200/quotes/_search?pretty=true&size=1000`asd\
_Remarque : Si vous indiquez un nombre plus grand, toutes les entr√©es seront de toute fa√ßon export√©es, par exemple vous pourriez indiquer `size=9999` et il serait √©trange qu'il y ait plus d'entr√©es (mais vous devriez v√©rifier)._

### Dump all

Pour exporter tout, vous pouvez simplement aller au **m√™me chemin qu'auparavant mais sans indiquer d'index** `http://host:9200/_search?pretty=true` comme `http://10.10.10.115:9200/_search?pretty=true`\
N'oubliez pas que dans ce cas, la **limite par d√©faut de 10** r√©sultats sera appliqu√©e. Vous pouvez utiliser le param√®tre `size` pour exporter une **plus grande quantit√© de r√©sultats**. Lisez la section pr√©c√©dente pour plus d'informations.

### Search

Si vous recherchez des informations, vous pouvez faire une **recherche brute sur tous les indices** en allant √† `http://host:9200/_search?pretty=true&q=<search_term>` comme dans `http://10.10.10.115:9200/_search?pretty=true&q=Rockwell`

![](<../.gitbook/assets/image (335).png>)

Si vous souhaitez juste **rechercher dans un index**, vous pouvez simplement **le sp√©cifier** dans le **chemin** : `http://host:9200/<index>/_search?pretty=true&q=<search_term>`

_Remarque : le param√®tre q utilis√© pour rechercher du contenu **prend en charge les expressions r√©guli√®res**_

Vous pouvez √©galement utiliser quelque chose comme [https://github.com/misalabs/horuz](https://github.com/misalabs/horuz) pour fuzz un service elasticsearch.

### Write permissions

Vous pouvez v√©rifier vos permissions d'√©criture en essayant de cr√©er un nouveau document dans un nouvel index en ex√©cutant quelque chose comme ce qui suit :
```bash
curl -X POST '10.10.10.115:9200/bookindex/books' -H 'Content-Type: application/json' -d'
{
"bookId" : "A00-3",
"author" : "Sankaran",
"publisher" : "Mcgrahill",
"name" : "how to get a job"
}'
```
Cette commande cr√©era un **nouvel index** appel√© `bookindex` avec un document de type `books` qui a les attributs "_bookId_", "_author_", "_publisher_" et "_name_"

Remarquez comment le **nouvel index appara√Æt maintenant dans la liste** :

![](<../.gitbook/assets/image (130).png>)

Et notez les **propri√©t√©s cr√©√©es automatiquement** :

![](<../.gitbook/assets/image (434).png>)

## √ânum√©ration Automatique

Certains outils obtiendront certaines des donn√©es pr√©sent√©es pr√©c√©demment :
```bash
msf > use auxiliary/scanner/elasticsearch/indices_enum
```
{% embed url="https://github.com/theMiddleBlue/nmap-elasticsearch-nse" %}

## Shodan

* `port:9200 elasticsearch`

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Formation Expert Red Team AWS (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Formation Expert Red Team GCP (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
