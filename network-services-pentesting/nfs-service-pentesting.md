# 2049 - Pentesting NFS Service

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **Informations de base**

**NFS** est un syst√®me con√ßu pour le **client/serveur** qui permet aux utilisateurs d'acc√©der facilement √† des fichiers sur un r√©seau comme si ces fichiers √©taient situ√©s dans un r√©pertoire local.

Un aspect notable de ce protocole est son absence de **m√©canismes d'authentification** ou d'**autorisation** int√©gr√©s. Au lieu de cela, l'autorisation repose sur les **informations du syst√®me de fichiers**, le serveur √©tant charg√© de traduire avec pr√©cision les **informations utilisateur fournies par le client** dans le format d'**autorisation** requis par le syst√®me de fichiers, suivant principalement la **syntaxe UNIX**.

L'authentification repose g√©n√©ralement sur les **identifiants `UID`/`GID` UNIX et les appartenances √† des groupes**. Cependant, un d√©fi se pose en raison du potentiel d√©calage dans les **mappings `UID`/`GID`** entre les clients et les serveurs, ne laissant aucune place √† une v√©rification suppl√©mentaire par le serveur. Par cons√©quent, le protocole est mieux adapt√© √† une utilisation au sein de **r√©seaux de confiance**, √©tant donn√© sa d√©pendance √† cette m√©thode d'authentification.

**Port par d√©faut** : 2049/TCP/UDP (sauf la version 4, elle n√©cessite juste TCP ou UDP).&#x20;
```
2049/tcp open  nfs     2-3 (RPC #100003
```
### Versions

- **NFSv2** : Cette version est reconnue pour sa large compatibilit√© avec divers syst√®mes, marquant son importance avec des op√©rations initiales principalement sur UDP. √âtant le **plus ancien** de la s√©rie, il a jet√© les bases pour les d√©veloppements futurs.

- **NFSv3** : Introduit avec une gamme d'am√©liorations, NFSv3 s'est √©tendu par rapport √† son pr√©d√©cesseur en prenant en charge des tailles de fichiers variables et en offrant de meilleurs m√©canismes de rapport d'erreurs. Malgr√© ses avanc√©es, il a rencontr√© des limitations en mati√®re de compatibilit√© totale avec les clients NFSv2.

- **NFSv4** : Une version marquante de la s√©rie NFS, NFSv4 a apport√© un ensemble de fonctionnalit√©s con√ßues pour moderniser le partage de fichiers √† travers les r√©seaux. Les am√©liorations notables incluent l'int√©gration de Kerberos pour une **s√©curit√© √©lev√©e**, la capacit√© de traverser les pare-feu et de fonctionner sur Internet sans avoir besoin de portmappers, le support des listes de contr√¥le d'acc√®s (ACL), et l'introduction d'op√©rations bas√©es sur l'√©tat. Ses am√©liorations de performance et l'adoption d'un protocole orient√© √©tat distinguent NFSv4 comme une avanc√©e majeure dans les technologies de partage de fichiers en r√©seau.

Chaque version de NFS a √©t√© d√©velopp√©e dans le but de r√©pondre aux besoins √©volutifs des environnements r√©seau, am√©liorant progressivement la s√©curit√©, la compatibilit√© et la performance.

## Enumeration

### Useful nmap scripts
```bash
nfs-ls #List NFS exports and check permissions
nfs-showmount #Like showmount -e
nfs-statfs #Disk statistics and info from NFS share
```
### Modules Metasploit Utiles
```bash
scanner/nfs/nfsmount #Scan NFS mounts and list permissions
```
### Mounting

Pour savoir **quel dossier** le serveur a **disponible** pour le monter, vous pouvez lui demander en utilisant :
```bash
showmount -e <IP>
```
Puis montez-le en utilisant :
```bash
mount -t nfs [-o vers=2] <ip>:<remote_folder> <local_folder> -o nolock
```
Vous devez sp√©cifier d'**utiliser la version 2** car elle n'a **aucune** **authentification** ni **autorisation**.

**Exemple :**
```bash
mkdir /mnt/new_back
mount -t nfs [-o vers=2] 10.12.0.150:/backup /mnt/new_back -o nolock
```
## Permissions

Si vous montez un dossier qui contient **des fichiers ou des dossiers uniquement accessibles par certains utilisateurs** (par **UID**). Vous pouvez **cr√©er** **localement** un utilisateur avec cet **UID** et en utilisant cet **utilisateur**, vous pourrez **acc√©der** au fichier/dossier.

## NSFShell

Pour lister, monter et changer facilement l'UID et le GID afin d'acc√©der aux fichiers, vous pouvez utiliser [nfsshell](https://github.com/NetDirect/nfsshell).

[Tutoriel NFSShell int√©ressant.](https://www.pentestpartners.com/security-blog/using-nfsshell-to-compromise-older-environments/)

## Config files
```
/etc/exports
/etc/lib/nfs/etab
```
### Param√®tres dangereux

- **Permissions de lecture et d'√©criture (`rw`):** Ce param√®tre permet √† la fois la lecture et l'√©criture dans le syst√®me de fichiers. Il est essentiel de consid√©rer les implications de l'octroi d'un acc√®s aussi large.

- **Utilisation de ports non s√©curis√©s (`insecure`):** Lorsqu'il est activ√©, cela permet au syst√®me d'utiliser des ports au-dessus de 1024. La s√©curit√© des ports au-dessus de cette plage peut √™tre moins stricte, augmentant le risque.

- **Visibilit√© des syst√®mes de fichiers imbriqu√©s (`nohide`):** Cette configuration rend les r√©pertoires visibles m√™me si un autre syst√®me de fichiers est mont√© en dessous d'un r√©pertoire export√©. Chaque r√©pertoire n√©cessite sa propre entr√©e d'exportation pour une gestion appropri√©e.

- **Propri√©t√© des fichiers root (`no_root_squash`):** Avec ce param√®tre, les fichiers cr√©√©s par l'utilisateur root conservent leur UID/GID d'origine de 0, ignorant le principe du moindre privil√®ge et pouvant accorder des permissions excessives.

- **Non-squash de tous les utilisateurs (`no_all_squash`):** Cette option garantit que les identit√©s des utilisateurs sont pr√©serv√©es √† travers le syst√®me, ce qui pourrait entra√Æner des probl√®mes de permissions et de contr√¥le d'acc√®s si ce n'est pas correctement g√©r√©.

## Escalade de privil√®ges utilisant des mauvaises configurations NFS

[NFS no\_root\_squash et no\_all\_squash escalade de privil√®ges](../linux-hardening/privilege-escalation/nfs-no\_root\_squash-misconfiguration-pe.md)

## HackTricks Commandes automatiques
```
Protocol_Name: NFS    #Protocol Abbreviation if there is one.
Port_Number:  2049     #Comma separated if there is more than one.
Protocol_Description: Network File System         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for NFS
Note: |
NFS is a system designed for client/server that enables users to seamlessly access files over a network as though these files were located within a local directory.

#apt install nfs-common
showmount 10.10.10.180      ~or~showmount -e 10.10.10.180
should show you available shares (example /home)

mount -t nfs -o ver=2 10.10.10.180:/home /mnt/
cd /mnt
nano into /etc/passwd and change the uid (probably 1000 or 1001) to match the owner of the files if you are not able to get in

https://book.hacktricks.xyz/pentesting/nfs-service-pentesting

Entry_2:
Name: Nmap
Description: Nmap with NFS Scripts
Command: nmap --script=nfs-ls.nse,nfs-showmount.nse,nfs-statfs.nse -p 2049 {IP}
```
{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Formation Expert Red Team AWS (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Formation Expert Red Team GCP (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
