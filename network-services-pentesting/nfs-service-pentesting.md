# 2049 - Pentesting NFS Service

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **Podstawowe informacje**

**NFS** to system zaprojektowany dla **klient/serwer**, kt贸ry umo偶liwia u偶ytkownikom bezproblemowy dostp do plik贸w w sieci, jakby te pliki znajdoway si w lokalnym katalogu.

Ciekawym aspektem tego protokou jest brak wbudowanych **mechanizm贸w uwierzytelniania** lub **autoryzacji**. Zamiast tego, autoryzacja opiera si na **informacjach o systemie plik贸w**, a serwer ma za zadanie dokadnie przetumaczy **dostarczone przez klienta informacje o u偶ytkowniku** na wymagany przez system plik贸w **format autoryzacji**, g贸wnie zgodnie z **skadni UNIX**.

Uwierzytelnianie zazwyczaj opiera si na **identyfikatorach `UID`/`GID` UNIX i czonkostwie w grupach**. Jednak偶e, pojawia si problem z potencjalnym niedopasowaniem w **mapowaniach `UID`/`GID`** midzy klientami a serwerami, co nie pozostawia miejsca na dodatkow weryfikacj przez serwer. W zwizku z tym, protok贸 najlepiej nadaje si do u偶ycia w **zaufanych sieciach**, biorc pod uwag jego poleganie na tej metodzie uwierzytelniania.

**Domylny port**: 2049/TCP/UDP (z wyjtkiem wersji 4, potrzebuje tylko TCP lub UDP).&#x20;
```
2049/tcp open  nfs     2-3 (RPC #100003
```
### Wersje

- **NFSv2**: Ta wersja jest znana z szerokiej kompatybilnoci z r贸偶nymi systemami, co podkrela jej znaczenie w pocztkowych operacjach g贸wnie przez UDP. Jako **najstarsza** w serii, poo偶ya fundamenty pod przysze rozw贸j.

- **NFSv3**: Wprowadzona z szeregiem ulepsze, NFSv3 rozszerzya mo偶liwoci swojego poprzednika, wspierajc zmienne rozmiary plik贸w i oferujc ulepszone mechanizmy raportowania bd贸w. Pomimo swoich postp贸w, napotkaa ograniczenia w penej kompatybilnoci wstecznej z klientami NFSv2.

- **NFSv4**: Kamie milowy w serii NFS, NFSv4 wprowadzi zestaw funkcji zaprojektowanych w celu unowoczenienia udostpniania plik贸w w sieciach. Znaczce ulepszenia obejmuj integracj Kerberos dla **wysokiego bezpieczestwa**, zdolno do przechodzenia przez zapory i dziaania przez Internet bez potrzeby korzystania z portmapper贸w, wsparcie dla list kontroli dostpu (ACL) oraz wprowadzenie operacji opartych na stanie. Ulepszenia wydajnoci i przyjcie protokou opartego na stanie wyr贸偶niaj NFSv4 jako kluczowy postp w technologiach udostpniania plik贸w w sieci.

Ka偶da wersja NFS zostaa opracowana z zamiarem zaspokojenia ewoluujcych potrzeb rodowisk sieciowych, stopniowo poprawiajc bezpieczestwo, kompatybilno i wydajno.

## Enumeracja

### U偶yteczne skrypty nmap
```bash
nfs-ls #List NFS exports and check permissions
nfs-showmount #Like showmount -e
nfs-statfs #Disk statistics and info from NFS share
```
### Przydatne moduy metasploit
```bash
scanner/nfs/nfsmount #Scan NFS mounts and list permissions
```
### Montowanie

Aby dowiedzie si, **kt贸ry folder** jest **dostpny** na serwerze do zamontowania, mo偶esz zapyta go u偶ywajc:
```bash
showmount -e <IP>
```
Nastpnie zamontuj to u偶ywajc:
```bash
mount -t nfs [-o vers=2] <ip>:<remote_folder> <local_folder> -o nolock
```
Powiniene okreli, aby **u偶ywa wersji 2**, poniewa偶 nie ma **偶adnej** **autoryzacji** ani **uwierzytelniania**.

**Przykad:**
```bash
mkdir /mnt/new_back
mount -t nfs [-o vers=2] 10.12.0.150:/backup /mnt/new_back -o nolock
```
## Uprawnienia

Jeli zamontujesz folder, kt贸ry zawiera **pliki lub foldery dostpne tylko dla niekt贸rego u偶ytkownika** (wedug **UID**). Mo偶esz **utworzy** **lokalnie** u偶ytkownika z tym **UID** i u偶ywajc tego **u偶ytkownika** bdziesz m贸g **uzyska dostp** do pliku/folderu.

## NSFShell

Aby atwo wylistowa, zamontowa i zmieni UID oraz GID, aby uzyska dostp do plik贸w, mo偶esz u偶y [nfsshell](https://github.com/NetDirect/nfsshell).

[adny samouczek NFSShell.](https://www.pentestpartners.com/security-blog/using-nfsshell-to-compromise-older-environments/)

## Pliki konfiguracyjne
```
/etc/exports
/etc/lib/nfs/etab
```
### Niebezpieczne ustawienia

- **Uprawnienia do odczytu i zapisu (`rw`):** To ustawienie pozwala na zar贸wno odczyt, jak i zapis w systemie plik贸w. Wa偶ne jest, aby rozwa偶y konsekwencje przyznawania tak szerokiego dostpu.

- **U偶ycie niebezpiecznych port贸w (`insecure`):** Po wczeniu, to pozwala systemowi na korzystanie z port贸w powy偶ej 1024. Bezpieczestwo port贸w powy偶ej tego zakresu mo偶e by mniej rygorystyczne, co zwiksza ryzyko.

- **Widoczno zagnie偶d偶onych system贸w plik贸w (`nohide`):** Ta konfiguracja sprawia, 偶e katalogi s widoczne, nawet jeli inny system plik贸w jest zamontowany poni偶ej eksportowanego katalogu. Ka偶dy katalog wymaga wasnego wpisu eksportu dla prawidowego zarzdzania.

- **Wasno plik贸w root (`no_root_squash`):** Przy tym ustawieniu pliki tworzone przez u偶ytkownika root zachowuj sw贸j oryginalny UID/GID r贸wny 0, ignorujc zasad najmniejszych uprawnie i potencjalnie przyznajc nadmierne uprawnienia.

- **Brak zbijania wszystkich u偶ytkownik贸w (`no_all_squash`):** Ta opcja zapewnia, 偶e to偶samoci u偶ytkownik贸w s zachowywane w caym systemie, co mo偶e prowadzi do problem贸w z uprawnieniami i kontrol dostpu, jeli nie jest odpowiednio obsugiwane.

## Eskalacja uprawnie przy u偶yciu bdnych konfiguracji NFS

[NFS no\_root\_squash i no\_all\_squash eskalacja uprawnie](../linux-hardening/privilege-escalation/nfs-no\_root\_squash-misconfiguration-pe.md)

## HackTricks Automatyczne Komendy
```
Protocol_Name: NFS    #Protocol Abbreviation if there is one.
Port_Number:  2049     #Comma separated if there is more than one.
Protocol_Description: Network File System         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for NFS
Note: |
NFS is a system designed for client/server that enables users to seamlessly access files over a network as though these files were located within a local directory.

#apt install nfs-common
showmount 10.10.10.180      ~or~showmount -e 10.10.10.180
should show you available shares (example /home)

mount -t nfs -o ver=2 10.10.10.180:/home /mnt/
cd /mnt
nano into /etc/passwd and change the uid (probably 1000 or 1001) to match the owner of the files if you are not able to get in

https://book.hacktricks.xyz/pentesting/nfs-service-pentesting

Entry_2:
Name: Nmap
Description: Nmap with NFS Scripts
Command: nmap --script=nfs-ls.nse,nfs-showmount.nse,nfs-statfs.nse -p 2049 {IP}
```
{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na GitHubie.

</details>
{% endhint %}
