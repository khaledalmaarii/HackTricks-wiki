# 2049 - Pentesting NFS Service

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **Informa√ß√µes B√°sicas**

**NFS** √© um sistema projetado para **cliente/servidor** que permite aos usu√°rios acessar arquivos de forma cont√≠nua atrav√©s de uma rede como se esses arquivos estivessem localizados em um diret√≥rio local.

Um aspecto not√°vel deste protocolo √© a sua falta de **mecanismos de autentica√ß√£o** ou **autoriza√ß√£o** integrados. Em vez disso, a autoriza√ß√£o depende das **informa√ß√µes do sistema de arquivos**, com o servidor encarregado de traduzir com precis√£o as **informa√ß√µes do usu√°rio fornecidas pelo cliente** para o formato de **autoriza√ß√£o** exigido pelo sistema de arquivos, seguindo principalmente a **sintaxe UNIX**.

A autentica√ß√£o geralmente depende de **identificadores `UID`/`GID` do UNIX e associa√ß√µes de grupos**. No entanto, um desafio surge devido ao potencial descompasso nas **mapea√ß√µes `UID`/`GID`** entre clientes e servidores, n√£o deixando espa√ßo para verifica√ß√£o adicional pelo servidor. Consequentemente, o protocolo √© mais adequado para uso em **redes confi√°veis**, dado que depende desse m√©todo de autentica√ß√£o.

**Porta padr√£o**: 2049/TCP/UDP (exceto a vers√£o 4, que precisa apenas de TCP ou UDP).&#x20;
```
2049/tcp open  nfs     2-3 (RPC #100003
```
### Vers√µes

- **NFSv2**: Esta vers√£o √© reconhecida por sua ampla compatibilidade com v√°rios sistemas, marcando sua import√¢ncia com opera√ß√µes iniciais predominantemente sobre UDP. Sendo a **mais antiga** da s√©rie, ela lan√ßou as bases para desenvolvimentos futuros.

- **NFSv3**: Introduzido com uma s√©rie de melhorias, o NFSv3 expandiu seu predecessor ao suportar tamanhos de arquivo vari√°veis e oferecer mecanismos de relat√≥rios de erro aprimorados. Apesar de seus avan√ßos, enfrentou limita√ß√µes na compatibilidade total com clientes NFSv2.

- **NFSv4**: Uma vers√£o marcante na s√©rie NFS, o NFSv4 trouxe um conjunto de recursos projetados para modernizar o compartilhamento de arquivos em redes. Melhorias not√°veis incluem a integra√ß√£o do Kerberos para **alta seguran√ßa**, a capacidade de atravessar firewalls e operar pela Internet sem a necessidade de portmappers, suporte para Listas de Controle de Acesso (ACLs) e a introdu√ß√£o de opera√ß√µes baseadas em estado. Suas melhorias de desempenho e a ado√ß√£o de um protocolo com estado distinguem o NFSv4 como um avan√ßo crucial nas tecnologias de compartilhamento de arquivos em rede.

Cada vers√£o do NFS foi desenvolvida com a inten√ß√£o de atender √†s necessidades em evolu√ß√£o dos ambientes de rede, aprimorando progressivamente a seguran√ßa, compatibilidade e desempenho.

## Enumera√ß√£o

### Scripts nmap √∫teis
```bash
nfs-ls #List NFS exports and check permissions
nfs-showmount #Like showmount -e
nfs-statfs #Disk statistics and info from NFS share
```
### M√≥dulos √∫teis do metasploit
```bash
scanner/nfs/nfsmount #Scan NFS mounts and list permissions
```
### Montando

Para saber **qual pasta** o servidor tem **dispon√≠vel** para montar, voc√™ pode perguntar a ele usando:
```bash
showmount -e <IP>
```
Ent√£o monte-o usando:
```bash
mount -t nfs [-o vers=2] <ip>:<remote_folder> <local_folder> -o nolock
```
Voc√™ deve especificar para **usar a vers√£o 2** porque ela n√£o tem **nenhuma** **autentica√ß√£o** ou **autoriza√ß√£o**.

**Exemplo:**
```bash
mkdir /mnt/new_back
mount -t nfs [-o vers=2] 10.12.0.150:/backup /mnt/new_back -o nolock
```
## Permiss√µes

Se voc√™ montar uma pasta que cont√©m **arquivos ou pastas acess√≠veis apenas por algum usu√°rio** (por **UID**). Voc√™ pode **criar** **localmente** um usu√°rio com esse **UID** e usando esse **usu√°rio** voc√™ poder√° **acessar** o arquivo/pasta.

## NSFShell

Para listar, montar e mudar facilmente UID e GID para ter acesso a arquivos, voc√™ pode usar [nfsshell](https://github.com/NetDirect/nfsshell).

[√ìtimo tutorial sobre NFSShell.](https://www.pentestpartners.com/security-blog/using-nfsshell-to-compromise-older-environments/)

## Arquivos de configura√ß√£o
```
/etc/exports
/etc/lib/nfs/etab
```
### Configura√ß√µes Perigosas

- **Permiss√µes de Leitura e Escrita (`rw`):** Esta configura√ß√£o permite tanto a leitura quanto a escrita no sistema de arquivos. √â essencial considerar as implica√ß√µes de conceder acesso t√£o amplo.

- **Uso de Portas Inseguras (`insecure`):** Quando ativado, isso permite que o sistema utilize portas acima de 1024. A seguran√ßa das portas acima desse intervalo pode ser menos rigorosa, aumentando o risco.

- **Visibilidade de Sistemas de Arquivos Aninhados (`nohide`):** Esta configura√ß√£o torna diret√≥rios vis√≠veis mesmo que outro sistema de arquivos esteja montado abaixo de um diret√≥rio exportado. Cada diret√≥rio requer sua pr√≥pria entrada de exporta√ß√£o para gerenciamento adequado.

- **Propriedade de Arquivos do Root (`no_root_squash`):** Com esta configura√ß√£o, arquivos criados pelo usu√°rio root mant√™m seu UID/GID original de 0, desconsiderando o princ√≠pio do menor privil√©gio e potencialmente concedendo permiss√µes excessivas.

- **N√£o Squashing de Todos os Usu√°rios (`no_all_squash`):** Esta op√ß√£o garante que as identidades dos usu√°rios sejam preservadas em todo o sistema, o que pode levar a problemas de permiss√£o e controle de acesso se n√£o for tratado corretamente.

## Escalada de Privil√©gios usando configura√ß√µes incorretas do NFS

[NFS no\_root\_squash e no\_all\_squash escalada de privil√©gios](../linux-hardening/privilege-escalation/nfs-no\_root\_squash-misconfiguration-pe.md)

## HackTricks Comandos Autom√°ticos
```
Protocol_Name: NFS    #Protocol Abbreviation if there is one.
Port_Number:  2049     #Comma separated if there is more than one.
Protocol_Description: Network File System         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for NFS
Note: |
NFS is a system designed for client/server that enables users to seamlessly access files over a network as though these files were located within a local directory.

#apt install nfs-common
showmount 10.10.10.180      ~or~showmount -e 10.10.10.180
should show you available shares (example /home)

mount -t nfs -o ver=2 10.10.10.180:/home /mnt/
cd /mnt
nano into /etc/passwd and change the uid (probably 1000 or 1001) to match the owner of the files if you are not able to get in

https://book.hacktricks.xyz/pentesting/nfs-service-pentesting

Entry_2:
Name: Nmap
Description: Nmap with NFS Scripts
Command: nmap --script=nfs-ls.nse,nfs-showmount.nse,nfs-statfs.nse -p 2049 {IP}
```
{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
