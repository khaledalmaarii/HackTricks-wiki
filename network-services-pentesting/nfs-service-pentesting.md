# 2049 - Testowanie penetracyjne usugi NFS

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* Pracujesz w **firmie zajmujcej si cyberbezpieczestwem**? Chcesz zobaczy swoj **firm reklamowan w HackTricks**? A mo偶e chcesz mie dostp do **najnowszej wersji PEASS lub pobra HackTricks w formacie PDF**? Sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* **Docz do** [****](https://emojipedia.org/speech-balloon/) [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** mnie na **Twitterze** [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do repozytorium [hacktricks](https://github.com/carlospolop/hacktricks) i [hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

## **Podstawowe informacje**

**NFS** to system zaprojektowany dla **klient/serwer**, kt贸ry umo偶liwia u偶ytkownikom bezproblemowy dostp do plik贸w przez sie, tak jakby te pliki znajdoway si w lokalnym katalogu.

Nale偶y zauwa偶y, 偶e ten protok贸 nie posiada wbudowanych mechanizm贸w **uwierzytelniania** ani **autoryzacji**. Zamiast tego, autoryzacja opiera si na **informacjach o systemie plik贸w**, a serwer ma za zadanie dokadnie przetumaczy **informacje o u偶ytkowniku dostarczone przez klienta** na wymagany przez system plik贸w **format autoryzacji**, przede wszystkim zgodnie z **skadni UNIX**.

Uwierzytelnianie zwykle opiera si na **identyfikatorach `UID`/`GID` UNIX** i przynale偶noci do grup. Jednak pojawia si wyzwanie zwizane z potencjalnym niezgodnymi **mapowaniami `UID`/`GID`** midzy klientami a serwerami, nie pozostawiajc miejsca na dodatkow weryfikacj przez serwer. W rezultacie, protok贸 ten najlepiej sprawdza si w **zaufanych sieciach**, ze wzgldu na swoje poleganie na tej metodzie uwierzytelniania.

**Domylny port**: 2049/TCP/UDP (z wyjtkiem wersji 4, kt贸ra wymaga tylko TCP lub UDP).&#x20;
```
2049/tcp open  nfs     2-3 (RPC #100003
```
### Wersje

- **NFSv2**: Ta wersja jest znana ze swojej szerokiej kompatybilnoci z r贸偶nymi systemami, co potwierdza jej znaczenie dziki pocztkowym operacjom przewa偶nie realizowanym przez UDP. Jako **najstarsza** w serii, poo偶ya podwaliny pod przysze rozwinicia.

- **NFSv3**: Wprowadzona z szeregiem ulepsze, NFSv3 rozszerzya swojego poprzednika, obsugujc zmienne rozmiary plik贸w i oferujc ulepszone mechanizmy raportowania bd贸w. Pomimo swoich postp贸w, napotykaa ograniczenia w penej kompatybilnoci wstecznej z klientami NFSv2.

- **NFSv4**: Wersja przeomowa w serii NFS, NFSv4 przyniosa zestaw funkcji zaprojektowanych do nowoczesnego udostpniania plik贸w w sieciach. Znaczce ulepszenia obejmuj integracj Kerberosa dla **wysokiego poziomu bezpieczestwa**, zdolno do przekraczania zap贸r ogniowych i dziaania w Internecie bez potrzeby portmapper贸w, obsug list kontroli dostpu (ACL), oraz wprowadzenie operacji opartych na stanie. Jej ulepszenia wydajnociowe i przyjcie protokou stanowego wyr贸偶niaj NFSv4 jako przeomowy postp w technologiach udostpniania plik贸w w sieci.

Ka偶da wersja NFS zostaa opracowana w celu zaspokojenia zmieniajcych si potrzeb rodowisk sieciowych, stopniowo poprawiajc bezpieczestwo, kompatybilno i wydajno.

## Wyliczanie

### Przydatne skrypty nmap
```bash
nfs-ls #List NFS exports and check permissions
nfs-showmount #Like showmount -e
nfs-statfs #Disk statistics and info from NFS share
```
### Przydatne moduy metasploit

Metasploit to pot偶ne narzdzie do testowania penetracyjnego, kt贸re oferuje wiele modu贸w, kt贸re mog by u偶yteczne podczas testowania usug sieciowych. Oto kilka przykadowych modu贸w, kt贸re warto zna:

- `auxiliary/scanner/nfs/nfsmount` - Modu ten pozwala na skanowanie i montowanie udzia贸w NFS.
- `auxiliary/scanner/nfs/nfsenum` - Ten modu umo偶liwia wykonywanie enumeracji usug NFS, takich jak listowanie katalog贸w i plik贸w.
- `auxiliary/scanner/nfs/nfs_showmount` - Modu ten pozwala na wykonywanie zapyta showmount w celu uzyskania informacji o dostpnych udziaach NFS.
- `auxiliary/scanner/nfs/nfs_statfs` - Ten modu umo偶liwia pobieranie informacji statystycznych o udziaach NFS.
- `exploit/linux/nfs/nfsd` - Modu ten pozwala na zdalne wykonanie kodu na serwerze NFS poprzez wykorzystanie podatnoci w usudze nfsd.

Pamitaj, 偶e metasploit oferuje wiele innych modu贸w, kt贸re mog by przydatne podczas testowania penetracyjnego usug sieciowych.
```bash
scanner/nfs/nfsmount #Scan NFS mounts and list permissions
```
### Montowanie

Aby dowiedzie si, **kt贸ry folder** na serwerze jest **dostpny** do zamontowania, mo偶esz zapyta o to u偶ywajc:
```bash
showmount -e <IP>
```
Nastpnie zamontuj go za pomoc:
```bash
mount -t nfs [-o vers=2] <ip>:<remote_folder> <local_folder> -o nolock
```
Powiniene okreli, 偶eby **u偶ywa wersji 2**, poniewa偶 nie posiada **偶adnej** **autoryzacji** ani **uwierzytelniania**.

**Przykad:**
```bash
mkdir /mnt/new_back
mount -t nfs [-o vers=2] 10.12.0.150:/backup /mnt/new_back -o nolock
```
## Uprawnienia

Jeli zamontujesz folder, kt贸ry zawiera **pliki lub foldery dostpne tylko dla okrelonego u偶ytkownika** (za pomoc **UID**), mo偶esz **lokalnie utworzy** u偶ytkownika o tym **UID** i u偶ywajc tego u偶ytkownika bdziesz m贸g **uzyska dostp** do pliku/folderu.

## NSFShell

Aby atwo wywietla, montowa i zmienia UID i GID w celu uzyskania dostpu do plik贸w, mo偶esz u偶y [nfsshell](https://github.com/NetDirect/nfsshell).

[adny samouczek NFSShell.](https://www.pentestpartners.com/security-blog/using-nfsshell-to-compromise-older-environments/)

## Pliki konfiguracyjne
```
/etc/exports
/etc/lib/nfs/etab
```
### Niebezpieczne ustawienia

- **Uprawnienia do odczytu i zapisu (`rw`):** Ta opcja umo偶liwia zar贸wno odczyt, jak i zapis do systemu plik贸w. Nale偶y dokadnie rozwa偶y konsekwencje udzielenia tak szerokiego dostpu.

- **U偶ycie niezabezpieczonych port贸w (`insecure`):** Po wczeniu tej opcji system mo偶e korzysta z port贸w powy偶ej 1024. Bezpieczestwo port贸w powy偶ej tej wartoci mo偶e by mniejsze, co zwiksza ryzyko.

- **Widoczno zagnie偶d偶onych system贸w plik贸w (`nohide`):** Ta konfiguracja sprawia, 偶e katalogi s widoczne nawet wtedy, gdy inny system plik贸w jest zamontowany poni偶ej eksportowanego katalogu. Ka偶dy katalog wymaga wasnego wpisu eksportu dla prawidowego zarzdzania.

- **Wacicielstwo plik贸w roota (`no_root_squash`):** Ta opcja powoduje, 偶e pliki utworzone przez u偶ytkownika root zachowuj swoje pierwotne UID/GID r贸wna 0, ignorujc zasad najmniejszych uprawnie i potencjalnie nadajc nadmierne uprawnienia.

- **Brak tumienia wszystkich u偶ytkownik贸w (`no_all_squash`):** Ta opcja zapewnia zachowanie to偶samoci u偶ytkownik贸w w caym systemie, co mo偶e prowadzi do problem贸w z uprawnieniami i kontrol dostpu, jeli nie jest prawidowo obsugiwana.

## Eskalacja uprawnie przy u偶yciu bd贸w konfiguracji NFS

[Eskalacja uprawnie przy u偶yciu bd贸w konfiguracji NFS no\_root\_squash i no\_all\_squash](../linux-hardening/privilege-escalation/nfs-no\_root\_squash-misconfiguration-pe.md)

## Automatyczne polecenia HackTricks
```
Protocol_Name: NFS    #Protocol Abbreviation if there is one.
Port_Number:  2049     #Comma separated if there is more than one.
Protocol_Description: Network File System         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for NFS
Note: |
NFS is a system designed for client/server that enables users to seamlessly access files over a network as though these files were located within a local directory.

#apt install nfs-common
showmount 10.10.10.180      ~or~showmount -e 10.10.10.180
should show you available shares (example /home)

mount -t nfs -o ver=2 10.10.10.180:/home /mnt/
cd /mnt
nano into /etc/passwd and change the uid (probably 1000 or 1001) to match the owner of the files if you are not able to get in

https://book.hacktricks.xyz/pentesting/nfs-service-pentesting

Entry_2:
Name: Nmap
Description: Nmap with NFS Scripts
Command: nmap --script=nfs-ls.nse,nfs-showmount.nse,nfs-statfs.nse -p 2049 {IP}
```
<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* Pracujesz w **firmie zajmujcej si cyberbezpieczestwem**? Chcesz zobaczy swoj **firm reklamowan w HackTricks**? A mo偶e chcesz mie dostp do **najnowszej wersji PEASS lub pobra HackTricks w formacie PDF**? Sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* **Docz do** [****](https://emojipedia.org/speech-balloon/) [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** mnie na **Twitterze** [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do repozytorium [hacktricks](https://github.com/carlospolop/hacktricks) i [hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
