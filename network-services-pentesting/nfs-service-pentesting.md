# 2049 - Pentesting NFS Service

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **Informaci贸n B谩sica**

**NFS** es un sistema dise帽ado para **cliente/servidor** que permite a los usuarios acceder a archivos a trav茅s de una red como si estos archivos estuvieran ubicados dentro de un directorio local.

Un aspecto notable de este protocolo es su falta de **mecanismos de autenticaci贸n** o **autorizaci贸n** integrados. En su lugar, la autorizaci贸n se basa en la **informaci贸n del sistema de archivos**, siendo el servidor responsable de traducir con precisi贸n la **informaci贸n del usuario proporcionada por el cliente** al **formato de autorizaci贸n** requerido por el sistema de archivos, siguiendo principalmente la **sintaxis de UNIX**.

La autenticaci贸n com煤nmente se basa en **identificadores `UID`/`GID` de UNIX y membres铆as de grupo**. Sin embargo, surge un desaf铆o debido a la posible discrepancia en los **mapeos `UID`/`GID`** entre clientes y servidores, dejando sin espacio para una verificaci贸n adicional por parte del servidor. En consecuencia, el protocolo es m谩s adecuado para su uso dentro de **redes de confianza**, dado su dependencia de este m茅todo de autenticaci贸n.

**Puerto por defecto**: 2049/TCP/UDP (excepto la versi贸n 4, solo necesita TCP o UDP).&#x20;
```
2049/tcp open  nfs     2-3 (RPC #100003
```
### Versiones

- **NFSv2**: Esta versi贸n es reconocida por su amplia compatibilidad con varios sistemas, marcando su importancia con operaciones iniciales predominantemente sobre UDP. Siendo la **m谩s antigua** de la serie, sent贸 las bases para desarrollos futuros.

- **NFSv3**: Introducida con una serie de mejoras, NFSv3 se expandi贸 sobre su predecesora al soportar tama帽os de archivo variables y ofrecer mecanismos de reporte de errores mejorados. A pesar de sus avances, enfrent贸 limitaciones en la compatibilidad total hacia atr谩s con clientes NFSv2.

- **NFSv4**: Una versi贸n hist贸rica en la serie NFS, NFSv4 present贸 un conjunto de caracter铆sticas dise帽adas para modernizar el intercambio de archivos a trav茅s de redes. Las mejoras notables incluyen la integraci贸n de Kerberos para **alta seguridad**, la capacidad de atravesar firewalls y operar a trav茅s de Internet sin la necesidad de portmappers, soporte para Listas de Control de Acceso (ACLs), y la introducci贸n de operaciones basadas en estado. Sus mejoras de rendimiento y la adopci贸n de un protocolo con estado distinguen a NFSv4 como un avance fundamental en las tecnolog铆as de intercambio de archivos en red.

Cada versi贸n de NFS ha sido desarrollada con la intenci贸n de abordar las necesidades en evoluci贸n de los entornos de red, mejorando progresivamente la seguridad, compatibilidad y rendimiento.

## Enumeraci贸n

### Scripts 煤tiles de nmap
```bash
nfs-ls #List NFS exports and check permissions
nfs-showmount #Like showmount -e
nfs-statfs #Disk statistics and info from NFS share
```
### M贸dulos 煤tiles de metasploit
```bash
scanner/nfs/nfsmount #Scan NFS mounts and list permissions
```
### Montaje

Para saber **qu茅 carpeta** tiene el servidor **disponible** para montarte, puedes preguntarle usando:
```bash
showmount -e <IP>
```
Luego m贸ntalo usando:
```bash
mount -t nfs [-o vers=2] <ip>:<remote_folder> <local_folder> -o nolock
```
Deber铆as especificar **usar la versi贸n 2** porque no tiene **ninguna** **autenticaci贸n** ni **autorizaci贸n**.

**Ejemplo:**
```bash
mkdir /mnt/new_back
mount -t nfs [-o vers=2] 10.12.0.150:/backup /mnt/new_back -o nolock
```
## Permisos

Si montas una carpeta que contiene **archivos o carpetas solo accesibles por alg煤n usuario** (por **UID**). Puedes **crear** **localmente** un usuario con ese **UID** y usando ese **usuario** podr谩s **acceder** al archivo/carpeta.

## NSFShell

Para listar, montar y cambiar f谩cilmente el UID y GID para tener acceso a archivos, puedes usar [nfsshell](https://github.com/NetDirect/nfsshell).

[Bonito tutorial de NFSShell.](https://www.pentestpartners.com/security-blog/using-nfsshell-to-compromise-older-environments/)

## Archivos de configuraci贸n
```
/etc/exports
/etc/lib/nfs/etab
```
### Configuraciones peligrosas

- **Permisos de lectura y escritura (`rw`):** Esta configuraci贸n permite tanto la lectura como la escritura en el sistema de archivos. Es esencial considerar las implicaciones de otorgar un acceso tan amplio.

- **Uso de puertos inseguros (`insecure`):** Cuando est谩 habilitado, esto permite que el sistema utilice puertos por encima de 1024. La seguridad de los puertos por encima de este rango puede ser menos estricta, aumentando el riesgo.

- **Visibilidad de sistemas de archivos anidados (`nohide`):** Esta configuraci贸n hace que los directorios sean visibles incluso si otro sistema de archivos est谩 montado debajo de un directorio exportado. Cada directorio requiere su propia entrada de exportaci贸n para una gesti贸n adecuada.

- **Propiedad de archivos de root (`no_root_squash`):** Con esta configuraci贸n, los archivos creados por el usuario root mantienen su UID/GID original de 0, ignorando el principio de menor privilegio y potencialmente otorgando permisos excesivos.

- **No aplastamiento de todos los usuarios (`no_all_squash`):** Esta opci贸n asegura que las identidades de los usuarios se conserven en todo el sistema, lo que podr铆a llevar a problemas de permisos y control de acceso si no se maneja correctamente.

## Escalaci贸n de privilegios utilizando configuraciones incorrectas de NFS

[NFS no\_root\_squash y no\_all\_squash escalaci贸n de privilegios](../linux-hardening/privilege-escalation/nfs-no\_root\_squash-misconfiguration-pe.md)

## HackTricks Comandos autom谩ticos
```
Protocol_Name: NFS    #Protocol Abbreviation if there is one.
Port_Number:  2049     #Comma separated if there is more than one.
Protocol_Description: Network File System         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for NFS
Note: |
NFS is a system designed for client/server that enables users to seamlessly access files over a network as though these files were located within a local directory.

#apt install nfs-common
showmount 10.10.10.180      ~or~showmount -e 10.10.10.180
should show you available shares (example /home)

mount -t nfs -o ver=2 10.10.10.180:/home /mnt/
cd /mnt
nano into /etc/passwd and change the uid (probably 1000 or 1001) to match the owner of the files if you are not able to get in

https://book.hacktricks.xyz/pentesting/nfs-service-pentesting

Entry_2:
Name: Nmap
Description: Nmap with NFS Scripts
Command: nmap --script=nfs-ls.nse,nfs-showmount.nse,nfs-statfs.nse -p 2049 {IP}
```
{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci贸n**](https://github.com/sponsors/carlospolop)!
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
