# 53 - Pentesting DNS

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="/.gitbook/assets/image (14) (1).png" alt=""><figcaption></figcaption></figure>

**Configuraci贸n disponible instant谩neamente para evaluaci贸n de vulnerabilidades y pruebas de penetraci贸n**. Realiza un pentest completo desde cualquier lugar con m谩s de 20 herramientas y caracter铆sticas que van desde la recopilaci贸n de informaci贸n hasta la elaboraci贸n de informes. No reemplazamos a los pentesters; desarrollamos herramientas personalizadas, m贸dulos de detecci贸n y explotaci贸n para devolverles algo de tiempo para profundizar, ejecutar shells y divertirse.

{% embed url="https://pentest-tools.com/?utm_term=jul2024&utm_medium=link&utm_source=hacktricks&utm_campaign=spons" %}

## **Informaci贸n B谩sica**

El **Sistema de Nombres de Dominio (DNS)** sirve como el directorio de internet, permitiendo a los usuarios acceder a sitios web a trav茅s de **nombres de dominio f谩ciles de recordar** como google.com o facebook.com, en lugar de las direcciones num茅ricas de Protocolo de Internet (IP). Al traducir nombres de dominio en direcciones IP, el DNS asegura que los navegadores web puedan cargar r谩pidamente los recursos de internet, simplificando c贸mo navegamos por el mundo en l铆nea.

**Puerto por defecto:** 53
```
PORT     STATE SERVICE  REASON
53/tcp   open  domain  Microsoft DNS 6.1.7601 (1DB15D39) (Windows Server 2008 R2 SP1)
5353/udp open  zeroconf udp-response
53/udp   open  domain  Microsoft DNS 6.1.7601 (1DB15D39) (Windows Server 2008 R2 SP1)
```
### Diferentes Servidores DNS

* **Servidores Ra铆z DNS**: Estos est谩n en la parte superior de la jerarqu铆a DNS, gestionando los dominios de nivel superior y interviniendo solo si los servidores de nivel inferior no responden. La Corporaci贸n de Internet para Nombres y N煤meros Asignados (**ICANN**) supervisa su operaci贸n, con un conteo global de 13.
* **Servidores de Nombres Autorizados**: Estos servidores tienen la 煤ltima palabra para las consultas en sus zonas designadas, ofreciendo respuestas definitivas. Si no pueden proporcionar una respuesta, la consulta se eleva a los servidores ra铆z.
* **Servidores de Nombres No Autorizados**: Sin propiedad sobre las zonas DNS, estos servidores recopilan informaci贸n de dominio a trav茅s de consultas a otros servidores.
* **Servidor DNS de Cach茅**: Este tipo de servidor memoriza las respuestas a consultas anteriores durante un tiempo determinado para acelerar los tiempos de respuesta para solicitudes futuras, con la duraci贸n de la cach茅 dictada por el servidor autorizado.
* **Servidor de Reenv铆o**: Cumpliendo un papel sencillo, los servidores de reenv铆o simplemente retransmiten consultas a otro servidor.
* **Resolutor**: Integrados en computadoras o enrutadores, los resolutores ejecutan la resoluci贸n de nombres localmente y no se consideran autorizados.

## Enumeraci贸n

### **Captura de Banners**

No hay banners en DNS, pero puedes capturar la consulta m谩gica para `version.bind. CHAOS TXT`, que funcionar谩 en la mayor铆a de los servidores de nombres BIND.\
Puedes realizar esta consulta usando `dig`:
```bash
dig version.bind CHAOS TXT @DNS
```
Adem谩s, la herramienta [`fpdns`](https://github.com/kirei/fpdns) tambi茅n puede identificar el servidor.

Tambi茅n es posible obtener el banner con un script de **nmap**:
```
--script dns-nsid
```
### **Cualquier registro**

El registro **ANY** pedir谩 al servidor DNS que **devuelva** todas las **entradas** disponibles que **est茅 dispuesto a revelar**.
```bash
dig any victim.com @<DNS_IP>
```
### **Transferencia de Zona**

Este procedimiento se abrevia como `Asynchronous Full Transfer Zone` (`AXFR`).
```bash
dig axfr @<DNS_IP> #Try zone transfer without domain
dig axfr @<DNS_IP> <DOMAIN> #Try zone transfer guessing the domain
fierce --domain <DOMAIN> --dns-servers <DNS_IP> #Will try toperform a zone transfer against every authoritative name server and if this doesn'twork, will launch a dictionary attack
```
### M谩s informaci贸n
```bash
dig ANY @<DNS_IP> <DOMAIN>     #Any information
dig A @<DNS_IP> <DOMAIN>       #Regular DNS request
dig AAAA @<DNS_IP> <DOMAIN>    #IPv6 DNS request
dig TXT @<DNS_IP> <DOMAIN>     #Information
dig MX @<DNS_IP> <DOMAIN>      #Emails related
dig NS @<DNS_IP> <DOMAIN>      #DNS that resolves that name
dig -x 192.168.0.2 @<DNS_IP>   #Reverse lookup
dig -x 2a00:1450:400c:c06::93 @<DNS_IP> #reverse IPv6 lookup

#Use [-p PORT]  or  -6 (to use ivp6 address of dns)
```
#### Automatizaci贸n
```bash
for sub in $(cat <WORDLIST>);do dig $sub.<DOMAIN> @<DNS_IP> | grep -v ';\|SOA' | sed -r '/^\s*$/d' | grep $sub | tee -a subdomains.txt;done

dnsenum --dnsserver <DNS_IP> --enum -p 0 -s 0 -o subdomains.txt -f <WORDLIST> <DOMAIN>
```
#### Usando nslookup
```bash
nslookup
> SERVER <IP_DNS> #Select dns server
> 127.0.0.1 #Reverse lookup of 127.0.0.1, maybe...
> <IP_MACHINE> #Reverse lookup of a machine, maybe...
```
### M贸dulos 煤tiles de metasploit
```bash
auxiliary/gather/enum_dns #Perform enumeration actions
```
### Scripts de nmap 煤tiles
```bash
#Perform enumeration actions
nmap -n --script "(default and *dns*) or fcrdns or dns-srv-enum or dns-random-txid or dns-random-srcport" <IP>
```
### DNS - Reverse BF
```bash
dnsrecon -r 127.0.0.0/24 -n <IP_DNS>  #DNS reverse of all of the addresses
dnsrecon -r 127.0.1.0/24 -n <IP_DNS>  #DNS reverse of all of the addresses
dnsrecon -r <IP_DNS>/24 -n <IP_DNS>   #DNS reverse of all of the addresses
dnsrecon -d active.htb -a -n <IP_DNS> #Zone transfer
```
{% hint style="info" %}
Si puedes encontrar subdominios que resuelven a direcciones IP internas, deber铆as intentar realizar un BF de dns inverso a los NS del dominio solicitando ese rango de IP.
{% endhint %}

Otra herramienta para hacerlo: [https://github.com/amine7536/reverse-scan](https://github.com/amine7536/reverse-scan)

Puedes consultar rangos de IP inversos en [https://bgp.he.net/net/205.166.76.0/24#\_dns](https://bgp.he.net/net/205.166.76.0/24#\_dns) (esta herramienta tambi茅n es 煤til con BGP).

### DNS - Subdominios BF
```bash
dnsenum --dnsserver <IP_DNS> --enum -p 0 -s 0 -o subdomains.txt -f subdomains-1000.txt <DOMAIN>
dnsrecon -D subdomains-1000.txt -d <DOMAIN> -n <IP_DNS>
dnscan -d <domain> -r -w subdomains-1000.txt #Bruteforce subdomains in recursive way, https://github.com/rbsec/dnscan
```
### Servidores de Active Directory
```bash
dig -t _gc._tcp.lab.domain.com
dig -t _ldap._tcp.lab.domain.com
dig -t _kerberos._tcp.lab.domain.com
dig -t _kpasswd._tcp.lab.domain.com

nslookup -type=srv _kerberos._tcp.<CLIENT_DOMAIN>
nslookup -type=srv _kerberos._tcp.domain.com

nmap --script dns-srv-enum --script-args "dns-srv-enum.domain='domain.com'"
```
### DNSSec
```bash
#Query paypal subdomains to ns3.isc-sns.info
nmap -sSU -p53 --script dns-nsec-enum --script-args dns-nsec-enum.domains=paypal.com ns3.isc-sns.info
```
### IPv6

Fuerza bruta utilizando solicitudes "AAAA" para recopilar IPv6 de los subdominios.
```bash
dnsdict6 -s -t <domain>
```
Bruteforce reverse DNS utilizando direcciones IPv6
```bash
dnsrevenum6 pri.authdns.ripe.net 2001:67c:2e8::/48 #Will use the dns pri.authdns.ripe.net
```
### DNS Recursion DDoS

Si **la recursi贸n DNS est谩 habilitada**, un atacante podr铆a **suplantar** el **origen** en el paquete UDP para hacer que el **DNS env铆e la respuesta al servidor v铆ctima**. Un atacante podr铆a abusar de los tipos de registros **ANY** o **DNSSEC** ya que suelen tener las respuestas m谩s grandes.\
La forma de **verificar** si un DNS soporta **recursi贸n** es consultar un nombre de dominio y **comprobar** si la **bandera "ra"** (_recursi贸n disponible_) est谩 en la respuesta:
```bash
dig google.com A @<IP>
```
**No disponible**:

![](<../.gitbook/assets/image (123).png>)

**Disponible**:

![](<../.gitbook/assets/image (146).png>)

<figure><img src="/.gitbook/assets/image (14) (1).png" alt=""><figcaption></figcaption></figure>

**Configuraci贸n disponible al instante para evaluaci贸n de vulnerabilidades y pruebas de penetraci贸n**. Realiza un pentest completo desde cualquier lugar con m谩s de 20 herramientas y caracter铆sticas que van desde la recopilaci贸n hasta la elaboraci贸n de informes. No reemplazamos a los pentesters; desarrollamos herramientas personalizadas, m贸dulos de detecci贸n y explotaci贸n para devolverles algo de tiempo para profundizar, abrir shells y divertirse.

{% embed url="https://pentest-tools.com/?utm_term=jul2024&utm_medium=link&utm_source=hacktricks&utm_campaign=spons" %}

### Correo a cuenta inexistente

A trav茅s del examen de una notificaci贸n de no entrega (NDN) provocada por un correo electr贸nico enviado a una direcci贸n inv谩lida dentro de un dominio objetivo, a menudo se divulgan valiosos detalles de la red interna.

El informe de no entrega proporcionado incluye informaci贸n como:

* El servidor generador fue identificado como `server.example.com`.
* Se devolvi贸 un aviso de fallo para `user@example.com` con el c贸digo de error `#550 5.1.1 RESOLVER.ADR.RecipNotFound; no encontrado`.
* Se divulgaron direcciones IP internas y nombres de host en los encabezados del mensaje original.
```markdown
The original message headers were modified for anonymity and now present randomized data:

Generating server: server.example.com

user@example.com
#550 5.1.1 RESOLVER.ADR.RecipNotFound; not found ##

Original message headers:

Received: from MAILSERVER01.domain.example.com (192.168.1.1) by
mailserver02.domain.example.com (192.168.2.2) with Microsoft SMTP Server (TLS)
id 14.3.174.1; Mon, 25 May 2015 14:52:22 -0700
Received: from filter.example.com (203.0.113.1) by
MAILSERVER01.domain.example.com (192.168.1.1) with Microsoft SMTP Server (TLS)
id 14.3.174.1; Mon, 25 May 2015 14:51:22 -0700
X-ASG-Debug-ID: 1432576343-0614671716190e0d0001-zOQ9WJ
Received: from gateway.domainhost.com (gateway.domainhost.com [198.51.100.37]) by
filter.example.com with ESMTP id xVNPkwaqGgdyH5Ag for user@example.com; Mon,
25 May 2015 14:52:13 -0700 (PDT)
X-Envelope-From: sender@anotherdomain.org
X-Apparent-Source-IP: 198.51.100.37
```
## Archivos de configuraci贸n
```
host.conf
/etc/resolv.conf
/etc/bind/named.conf
/etc/bind/named.conf.local
/etc/bind/named.conf.options
/etc/bind/named.conf.log
/etc/bind/*
```
Peligrosos ajustes al configurar un servidor Bind:

| **Opci贸n**        | **Descripci贸n**                                                                |
| ----------------- | ------------------------------------------------------------------------------ |
| `allow-query`     | Define qu茅 hosts tienen permitido enviar solicitudes al servidor DNS.         |
| `allow-recursion` | Define qu茅 hosts tienen permitido enviar solicitudes recursivas al servidor DNS. |
| `allow-transfer`  | Define qu茅 hosts tienen permitido recibir transferencias de zona del servidor DNS. |
| `zone-statistics` | Recopila datos estad铆sticos de las zonas.                                     |

## Referencias

* [https://www.myrasecurity.com/en/knowledge-hub/dns/](https://www.myrasecurity.com/en/knowledge-hub/dns/)
* Libro: **Network Security Assessment 3rd edition**

## HackTricks Comandos Autom谩ticos
```
Protocol_Name: DNS    #Protocol Abbreviation if there is one.
Port_Number:  53     #Comma separated if there is more than one.
Protocol_Description: Domain Name Service        #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for DNS
Note: |
#These are the commands I run every time I see an open DNS port

dnsrecon -r 127.0.0.0/24 -n {IP} -d {Domain_Name}
dnsrecon -r 127.0.1.0/24 -n {IP} -d {Domain_Name}
dnsrecon -r {Network}{CIDR} -n {IP} -d {Domain_Name}
dig axfr @{IP}
dig axfr {Domain_Name} @{IP}
nslookup
SERVER {IP}
127.0.0.1
{IP}
Domain_Name
exit

https://book.hacktricks.xyz/pentesting/pentesting-dns

Entry_2:
Name: Banner Grab
Description: Grab DNS Banner
Command: dig version.bind CHAOS TXT @DNS

Entry_3:
Name: Nmap Vuln Scan
Description: Scan for Vulnerabilities with Nmap
Command: nmap -n --script "(default and *dns*) or fcrdns or dns-srv-enum or dns-random-txid or dns-random-srcport" {IP}

Entry_4:
Name: Zone Transfer
Description: Three attempts at forcing a zone transfer
Command: dig axfr @{IP} && dix axfr @{IP} {Domain_Name} && fierce --dns-servers {IP} --domain {Domain_Name}


Entry_5:
Name: Active Directory
Description: Eunuerate a DC via DNS
Command: dig -t _gc._{Domain_Name} && dig -t _ldap._{Domain_Name} && dig -t _kerberos._{Domain_Name} && dig -t _kpasswd._{Domain_Name} && nmap --script dns-srv-enum --script-args "dns-srv-enum.domain={Domain_Name}"

Entry_6:
Name: consolesless mfs enumeration
Description: DNS enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/dns/dns_amp; set RHOSTS {IP}; set RPORT 53; run; exit' && msfconsole -q -x 'use auxiliary/gather/enum_dns; set RHOSTS {IP}; set RPORT 53; run; exit'
```
<figure><img src="/.gitbook/assets/image (14) (1).png" alt=""><figcaption></figcaption></figure>

**Configuraci贸n disponible al instante para evaluaci贸n de vulnerabilidades y pruebas de penetraci贸n**. Realiza una prueba de penetraci贸n completa desde cualquier lugar con m谩s de 20 herramientas y caracter铆sticas que van desde la recopilaci贸n hasta la elaboraci贸n de informes. No reemplazamos a los pentesters; desarrollamos herramientas personalizadas, m贸dulos de detecci贸n y explotaci贸n para devolverles algo de tiempo para profundizar, ejecutar shells y divertirse.

{% embed url="https://pentest-tools.com/?utm_term=jul2024&utm_medium=link&utm_source=hacktricks&utm_campaign=spons" %}

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Consulta los [**planes de suscripci贸n**](https://github.com/sponsors/carlospolop)!
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
