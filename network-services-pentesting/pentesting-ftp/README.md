# 21 - Pentesting FTP

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Grundinformationen

Das **File Transfer Protocol (FTP)** dient als Standardprotokoll f√ºr den Dateitransfer √ºber ein Computernetzwerk zwischen einem Server und einem Client.\
Es ist ein **Klartext**-Protokoll, das als **neues Zeilenzeichen `0x0d 0x0a`** verwendet, sodass Sie manchmal **mit `telnet`** oder **`nc -C`** **verbinden m√ºssen**.

**Standardport:** 21
```
PORT   STATE SERVICE
21/tcp open  ftp
```
### Verbindungen Aktiv & Passiv

In **Aktivem FTP** initiiert der FTP **Client** zuerst die Steuerungs-**verbindung** von seinem Port N zum Befehlsport des FTP-Servers ‚Äì Port 21. Der **Client** h√∂rt dann auf Port **N+1** und sendet den Port N+1 an den FTP-Server. Der FTP-**Server** initiiert dann die Daten-**verbindung** von **seinem Port M zum Port N+1** des FTP-Clients.

Wenn der FTP-Client jedoch eine Firewall eingerichtet hat, die die eingehenden Datenverbindungen von au√üen kontrolliert, kann aktives FTP ein Problem darstellen. Eine praktikable L√∂sung daf√ºr ist passives FTP.

In **passivem FTP** initiiert der Client die Steuerungsverbindung von seinem Port N zum Port 21 des FTP-Servers. Danach gibt der Client einen **passv-Befehl** aus. Der Server sendet dann dem Client eine seiner Portnummern M. Und der **Client** **initiiert** die Daten-**verbindung** von **seinem Port P zum Port M** des FTP-Servers.

Quelle: [https://www.thesecuritybuddy.com/vulnerabilities/what-is-ftp-bounce-attack/](https://www.thesecuritybuddy.com/vulnerabilities/what-is-ftp-bounce-attack/)

### Verbindungs-Debugging

Die **FTP**-Befehle **`debug`** und **`trace`** k√∂nnen verwendet werden, um zu sehen, **wie die Kommunikation erfolgt**.

## Enumeration

### Banner-Grabbing
```bash
nc -vn <IP> 21
openssl s_client -connect crossfit.htb:21 -starttls ftp #Get certificate if any
```
### Mit StartTLS zu FTP verbinden
```
lftp
lftp :~> set ftp:ssl-force true
lftp :~> set ssl:verify-certificate no
lftp :~> connect 10.10.10.208
lftp 10.10.10.208:~> login
Usage: login <user|URL> [<pass>]
lftp 10.10.10.208:~> login username Password
```
### Unauth enum

Mit **nmap**
```bash
sudo nmap -sV -p21 -sC -A 10.10.10.10
```
Sie k√∂nnen die Befehle `HELP` und `FEAT` verwenden, um einige Informationen √ºber den FTP-Server zu erhalten:
```
HELP
214-The following commands are recognized (* =>'s unimplemented):
214-CWD     XCWD    CDUP    XCUP    SMNT*   QUIT    PORT    PASV
214-EPRT    EPSV    ALLO*   RNFR    RNTO    DELE    MDTM    RMD
214-XRMD    MKD     XMKD    PWD     XPWD    SIZE    SYST    HELP
214-NOOP    FEAT    OPTS    AUTH    CCC*    CONF*   ENC*    MIC*
214-PBSZ    PROT    TYPE    STRU    MODE    RETR    STOR    STOU
214-APPE    REST    ABOR    USER    PASS    ACCT*   REIN*   LIST
214-NLST    STAT    SITE    MLSD    MLST
214 Direct comments to root@drei.work

FEAT
211-Features:
PROT
CCC
PBSZ
AUTH TLS
MFF modify;UNIX.group;UNIX.mode;
REST STREAM
MLST modify*;perm*;size*;type*;unique*;UNIX.group*;UNIX.mode*;UNIX.owner*;
UTF8
EPRT
EPSV
LANG en-US
MDTM
SSCN
TVFS
MFMT
SIZE
211 End

STAT
#Info about the FTP server (version, configs, status...)
```
### Anonymer Login

_anonymous : anonymous_\
_anonymous :_\
_ftp : ftp_
```bash
ftp <IP>
>anonymous
>anonymous
>ls -a # List all files (even hidden) (yes, they could be hidden)
>binary #Set transmission to binary instead of ascii
>ascii #Set transmission to ascii instead of binary
>bye #exit
```
### [Brute force](../../generic-methodologies-and-resources/brute-force.md#ftp)

Hier finden Sie eine sch√∂ne Liste mit Standard-FTP-Anmeldeinformationen: [https://github.com/danielmiessler/SecLists/blob/master/Passwords/Default-Credentials/ftp-betterdefaultpasslist.txt](https://github.com/danielmiessler/SecLists/blob/master/Passwords/Default-Credentials/ftp-betterdefaultpasslist.txt)

### Automatisiert

Anonyme Anmeldungen und Bounce-FTP-√úberpr√ºfungen werden standardm√§√üig von nmap mit der **-sC**-Option durchgef√ºhrt oder:
```bash
nmap --script ftp-* -p 21 <ip>
```
## Browserverbindung

Sie k√∂nnen sich mit einem FTP-Server √ºber einen Browser (wie Firefox) mit einer URL wie:
```bash
ftp://anonymous:anonymous@10.10.10.98
```
Beachten Sie, dass wenn eine **Webanwendung** Daten, die von einem Benutzer kontrolliert werden, **direkt an einen FTP-Server** sendet, Sie doppelte URL-Codierung `%0d%0a` (in doppelter URL-Codierung ist dies `%250d%250a`) Bytes senden k√∂nnen und den **FTP-Server dazu bringen k√∂nnen, willk√ºrliche Aktionen** auszuf√ºhren. Eine dieser m√∂glichen willk√ºrlichen Aktionen besteht darin, Inhalte von einem vom Benutzer kontrollierten Server herunterzuladen, Port-Scans durchzuf√ºhren oder zu versuchen, mit anderen auf Klartext basierenden Diensten (wie http) zu kommunizieren.

## Alle Dateien vom FTP herunterladen
```bash
wget -m ftp://anonymous:anonymous@10.10.10.98 #Donwload all
wget -m --no-passive ftp://anonymous:anonymous@10.10.10.98 #Download all
```
Wenn Ihr Benutzername/Passwort Sonderzeichen enth√§lt, kann der [folgende Befehl](https://stackoverflow.com/a/113900/13647948) verwendet werden:
```bash
wget -r --user="USERNAME" --password="PASSWORD" ftp://server.com/
```
## Einige FTP-Befehle

* **`USER benutzername`**
* **`PASS passwort`**
* **`HELP`** Der Server zeigt an, welche Befehle unterst√ºtzt werden
* \*\*`PORT 127,0,0,1,0,80`\*\* Dies wird dem FTP-Server anzeigen, eine Verbindung mit der IP 127.0.0.1 an Port 80 herzustellen (_du musst das 5. Zeichen als "0" und das 6. als den Port im Dezimalformat angeben oder das 5. und 6. Zeichen verwenden, um den Port im Hexadezimalformat auszudr√ºcken_).
* \*\*`EPRT |2|127.0.0.1|80|`\*\* Dies wird dem FTP-Server anzeigen, eine TCP-Verbindung (_angezeigt durch "2"_) mit der IP 127.0.0.1 an Port 80 herzustellen. Dieser Befehl **unterst√ºtzt IPv6**.
* **`LIST`** Dies sendet die Liste der Dateien im aktuellen Ordner
* **`LIST -R`** Liste rekursiv (wenn vom Server erlaubt)
* **`APPE /path/something.txt`** Dies wird dem FTP anzeigen, die Daten, die von einer **passiven** Verbindung oder von einer **PORT/EPRT**-Verbindung empfangen wurden, in eine Datei zu speichern. Wenn der Dateiname existiert, werden die Daten angeh√§ngt.
* **`STOR /path/something.txt`** Wie `APPE`, aber es wird die Dateien √ºberschreiben
* **`STOU /path/something.txt`** Wie `APPE`, aber wenn sie existiert, wird nichts unternommen.
* **`RETR /path/to/file`** Eine passive oder eine Portverbindung muss hergestellt werden. Dann sendet der FTP-Server die angegebene Datei √ºber diese Verbindung
* **`REST 6`** Dies wird dem Server anzeigen, dass er beim n√§chsten Mal, wenn er etwas mit `RETR` sendet, im 6. Byte beginnen soll.
* **`TYPE i`** Setze den Transfer auf bin√§r
* **`PASV`** Dies √∂ffnet eine passive Verbindung und zeigt dem Benutzer, wo er sich verbinden kann
* **`PUT /tmp/file.txt`** Lade die angegebene Datei auf den FTP hoch

![](<../../.gitbook/assets/image (386).png>)

## FTPBounce-Angriff

Einige FTP-Server erlauben den Befehl PORT. Dieser Befehl kann verwendet werden, um dem Server anzuzeigen, dass du dich mit einem anderen FTP-Server an einem bestimmten Port verbinden m√∂chtest. Dann kannst du dies verwenden, um zu scannen, welche Ports eines Hosts √ºber einen FTP-Server offen sind.

[**Hier lernen, wie man einen FTP-Server missbraucht, um Ports zu scannen.**](ftp-bounce-attack.md)

Du k√∂nntest dieses Verhalten auch ausnutzen, um einen FTP-Server mit anderen Protokollen interagieren zu lassen. Du k√∂nntest **eine Datei hochladen, die eine HTTP-Anfrage enth√§lt** und den anf√§lligen FTP-Server **dazu bringen, sie an einen beliebigen HTTP-Server zu senden** (_vielleicht um einen neuen Admin-Benutzer hinzuzuf√ºgen?_) oder sogar eine FTP-Anfrage hochladen und den anf√§lligen FTP-Server dazu bringen, eine Datei von einem anderen FTP-Server herunterzuladen.\
Die Theorie ist einfach:

1. **Lade die Anfrage (in einer Textdatei) auf den anf√§lligen Server hoch.** Denk daran, dass du, wenn du mit einem anderen HTTP- oder FTP-Server kommunizieren m√∂chtest, die Zeilen mit `0x0d 0x0a` √§ndern musst.
2. **Verwende `REST X`, um das Senden der Zeichen zu vermeiden, die du nicht senden m√∂chtest** (vielleicht musstest du, um die Anfrage in die Datei hochzuladen, einige Bildheader am Anfang hinzuf√ºgen).
3. **Verwende `PORT`, um dich mit dem beliebigen Server und Dienst zu verbinden.**
4. **Verwende `RETR`, um die gespeicherte Anfrage an den Server zu senden.**

Es ist sehr wahrscheinlich, dass dies **einen Fehler wie** _**Socket nicht beschreibbar**_ **ausl√∂st, weil die Verbindung nicht lange genug dauert, um die Daten mit `RETR` zu senden**. Vorschl√§ge, um das zu vermeiden, sind:

* Wenn du eine HTTP-Anfrage sendest, **setze die gleiche Anfrage nacheinander** bis **\~0.5MB** mindestens. So:

{% file src="../../.gitbook/assets/posts.txt" %}
posts.txt
{% endfile %}

* Versuche, die Anfrage mit "M√ºll"-Daten, die sich auf das Protokoll beziehen, zu **f√ºllen** (wenn du mit FTP sprichst, vielleicht nur M√ºllbefehle oder wiederhole die `RETR`-Anweisung, um die Datei zu erhalten).
* F√ºlle die Anfrage einfach mit vielen Nullzeichen oder anderen **(getrennt in Zeilen oder nicht)**.

Wie auch immer, hier hast du ein [altes Beispiel, wie man dies missbrauchen kann, um einen FTP-Server eine Datei von einem anderen FTP-Server herunterladen zu lassen.](ftp-bounce-download-2oftp-file.md)

## Filezilla-Server-Sicherheitsanf√§lligkeit

**FileZilla** bindet normalerweise an **lokal** einen **Administrationsdienst** f√ºr den **FileZilla-Server** (Port 14147). Wenn du einen **Tunnel** von **deinem Rechner** zu diesem Port erstellen kannst, kannst du dich mit einem **leeren Passwort** verbinden und einen **neuen Benutzer** f√ºr den FTP-Dienst erstellen.

## Konfigurationsdateien
```
ftpusers
ftp.conf
proftpd.conf
vsftpd.conf
```
### Post-Exploitation

Die Standardkonfiguration von vsFTPd kann in `/etc/vsftpd.conf` gefunden werden. Hier k√∂nnten einige gef√§hrliche Einstellungen zu finden sein:

* `anonymous_enable=YES`
* `anon_upload_enable=YES`
* `anon_mkdir_write_enable=YES`
* `anon_root=/home/username/ftp` - Verzeichnis f√ºr anonym.
* `chown_uploads=YES` - √Ñndere den Eigent√ºmer von anonym hochgeladenen Dateien
* `chown_username=username` - Benutzer, der den Eigentum an anonym hochgeladenen Dateien erh√§lt
* `local_enable=YES` - Erlaube lokalen Benutzern, sich anzumelden
* `no_anon_password=YES` - Frage anonym nicht nach einem Passwort
* `write_enable=YES` - Erlaube Befehle: STOR, DELE, RNFR, RNTO, MKD, RMD, APPE und SITE

### Shodan

* `ftp`
* `port:21`


## HackTricks Automatische Befehle
```
Protocol_Name: FTP    #Protocol Abbreviation if there is one.
Port_Number:  21     #Comma separated if there is more than one.
Protocol_Description: File Transfer Protocol          #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for FTP
Note: |
Anonymous Login
-bi     <<< so that your put is done via binary

wget --mirror 'ftp://ftp_user:UTDRSCH53c"$6hys@10.10.10.59'
^^to download all dirs and files

wget --no-passive-ftp --mirror 'ftp://anonymous:anonymous@10.10.10.98'
if PASV transfer is disabled

https://book.hacktricks.xyz/pentesting/pentesting-ftp

Entry_2:
Name: Banner Grab
Description: Grab FTP Banner via telnet
Command: telnet -n {IP} 21

Entry_3:
Name: Cert Grab
Description: Grab FTP Certificate if existing
Command: openssl s_client -connect {IP}:21 -starttls ftp

Entry_4:
Name: nmap ftp
Description: Anon login and bounce FTP checks are performed
Command: nmap --script ftp-* -p 21 {IP}

Entry_5:
Name: Browser Connection
Description: Connect with Browser
Note: ftp://anonymous:anonymous@{IP}

Entry_6:
Name: Hydra Brute Force
Description: Need Username
Command: hydra -t 1 -l {Username} -P {Big_Passwordlist} -vV {IP} ftp

Entry_7:
Name: consolesless mfs enumeration ftp
Description: FTP enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/ftp/anonymous; set RHOSTS {IP}; set RPORT 21; run; exit' && msfconsole -q -x 'use auxiliary/scanner/ftp/ftp_version; set RHOSTS {IP}; set RPORT 21; run; exit' && msfconsole -q -x 'use auxiliary/scanner/ftp/bison_ftp_traversal; set RHOSTS {IP}; set RPORT 21; run; exit' && msfconsole -q -x 'use auxiliary/scanner/ftp/colorado_ftp_traversal; set RHOSTS {IP}; set RPORT 21; run; exit' &&  msfconsole -q -x 'use auxiliary/scanner/ftp/titanftp_xcrc_traversal; set RHOSTS {IP}; set RPORT 21; run; exit'
```
{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}
