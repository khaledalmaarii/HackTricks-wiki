# 21 - Pentesting FTP

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Informations de base

Le **File Transfer Protocol (FTP)** sert de protocole standard pour le transfert de fichiers √† travers un r√©seau informatique entre un serveur et un client.\
C'est un protocole **en texte clair** qui utilise comme **caract√®re de nouvelle ligne `0x0d 0x0a`** donc parfois vous devez **vous connecter en utilisant `telnet`** ou **`nc -C`**.

**Port par d√©faut :** 21
```
PORT   STATE SERVICE
21/tcp open  ftp
```
### Connexions Actives & Passives

Dans **Active FTP**, le **client** FTP initie d'abord la **connexion** de contr√¥le depuis son port N vers le port de commande du serveur FTP ‚Äì port 21. Le **client** √©coute ensuite le port **N+1** et envoie le port N+1 au serveur FTP. Le **serveur** FTP initie alors la **connexion** de donn√©es, depuis **son port M vers le port N+1** du client FTP.

Cependant, si le client FTP a un pare-feu configur√© qui contr√¥le les connexions de donn√©es entrantes de l'ext√©rieur, alors Active FTP peut poser probl√®me. Une solution envisageable est le Passive FTP.

Dans **Passive FTP**, le client initie la connexion de contr√¥le depuis son port N vers le port 21 du serveur FTP. Apr√®s cela, le client √©met une **commande passv**. Le serveur envoie alors au client l'un de ses num√©ros de port M. Et le **client** **initie** la **connexion** de donn√©es depuis **son port P vers le port M** du serveur FTP.

Source: [https://www.thesecuritybuddy.com/vulnerabilities/what-is-ftp-bounce-attack/](https://www.thesecuritybuddy.com/vulnerabilities/what-is-ftp-bounce-attack/)

### D√©bogage de connexion

Les commandes **FTP** **`debug`** et **`trace`** peuvent √™tre utilis√©es pour voir **comment la communication se d√©roule**.

## √ânum√©ration

### R√©cup√©ration de banni√®re
```bash
nc -vn <IP> 21
openssl s_client -connect crossfit.htb:21 -starttls ftp #Get certificate if any
```
### Se connecter √† FTP en utilisant starttls
```
lftp
lftp :~> set ftp:ssl-force true
lftp :~> set ssl:verify-certificate no
lftp :~> connect 10.10.10.208
lftp 10.10.10.208:~> login
Usage: login <user|URL> [<pass>]
lftp 10.10.10.208:~> login username Password
```
### Unauth enum

Avec **nmap**
```bash
sudo nmap -sV -p21 -sC -A 10.10.10.10
```
Vous pouvez utiliser les commandes `HELP` et `FEAT` pour obtenir des informations sur le serveur FTP :
```
HELP
214-The following commands are recognized (* =>'s unimplemented):
214-CWD     XCWD    CDUP    XCUP    SMNT*   QUIT    PORT    PASV
214-EPRT    EPSV    ALLO*   RNFR    RNTO    DELE    MDTM    RMD
214-XRMD    MKD     XMKD    PWD     XPWD    SIZE    SYST    HELP
214-NOOP    FEAT    OPTS    AUTH    CCC*    CONF*   ENC*    MIC*
214-PBSZ    PROT    TYPE    STRU    MODE    RETR    STOR    STOU
214-APPE    REST    ABOR    USER    PASS    ACCT*   REIN*   LIST
214-NLST    STAT    SITE    MLSD    MLST
214 Direct comments to root@drei.work

FEAT
211-Features:
PROT
CCC
PBSZ
AUTH TLS
MFF modify;UNIX.group;UNIX.mode;
REST STREAM
MLST modify*;perm*;size*;type*;unique*;UNIX.group*;UNIX.mode*;UNIX.owner*;
UTF8
EPRT
EPSV
LANG en-US
MDTM
SSCN
TVFS
MFMT
SIZE
211 End

STAT
#Info about the FTP server (version, configs, status...)
```
### Connexion anonyme

_anonymous : anonyme_\
_anonymous :_\
_ftp : ftp_
```bash
ftp <IP>
>anonymous
>anonymous
>ls -a # List all files (even hidden) (yes, they could be hidden)
>binary #Set transmission to binary instead of ascii
>ascii #Set transmission to ascii instead of binary
>bye #exit
```
### [Brute force](../../generic-methodologies-and-resources/brute-force.md#ftp)

Ici, vous pouvez trouver une belle liste avec des identifiants FTP par d√©faut : [https://github.com/danielmiessler/SecLists/blob/master/Passwords/Default-Credentials/ftp-betterdefaultpasslist.txt](https://github.com/danielmiessler/SecLists/blob/master/Passwords/Default-Credentials/ftp-betterdefaultpasslist.txt)

### Automatis√©

Les connexions anonymes et les v√©rifications de rebond FTP sont effectu√©es par d√©faut par nmap avec l'option **-sC** ou :
```bash
nmap --script ftp-* -p 21 <ip>
```
## Connexion par navigateur

Vous pouvez vous connecter √† un serveur FTP en utilisant un navigateur (comme Firefox) avec une URL comme :
```bash
ftp://anonymous:anonymous@10.10.10.98
```
Notez que si une **application web** envoie des donn√©es contr√¥l√©es par un utilisateur **directement √† un serveur FTP**, vous pouvez envoyer des octets doublement encod√©s en URL `%0d%0a` (dans un double encodage URL, c'est `%250d%250a`) et faire en sorte que le **serveur FTP effectue des actions arbitraires**. L'une de ces actions arbitraires possibles est de t√©l√©charger du contenu depuis un serveur contr√¥l√© par un utilisateur, d'effectuer un scan de ports ou d'essayer de communiquer avec d'autres services bas√©s sur du texte en clair (comme http).

## T√©l√©charger tous les fichiers depuis FTP
```bash
wget -m ftp://anonymous:anonymous@10.10.10.98 #Donwload all
wget -m --no-passive ftp://anonymous:anonymous@10.10.10.98 #Download all
```
Si votre nom d'utilisateur/mot de passe contient des caract√®res sp√©ciaux, la [commande suivante](https://stackoverflow.com/a/113900/13647948) peut √™tre utilis√©e :
```bash
wget -r --user="USERNAME" --password="PASSWORD" ftp://server.com/
```
## Quelques commandes FTP

* **`USER username`**
* **`PASS password`**
* **`HELP`** Le serveur indique quelles commandes sont support√©es
* \*\*`PORT 127,0,0,1,0,80`\*\*Cela indiquera au serveur FTP d'√©tablir une connexion avec l'IP 127.0.0.1 sur le port 80 (_vous devez mettre le 5√®me caract√®re comme "0" et le 6√®me comme le port en d√©cimal ou utiliser le 5√®me et 6√®me pour exprimer le port en hex_).
* \*\*`EPRT |2|127.0.0.1|80|`\*\*Cela indiquera au serveur FTP d'√©tablir une connexion TCP (_indiqu√©e par "2"_) avec l'IP 127.0.0.1 sur le port 80. Cette commande **supporte IPv6**.
* **`LIST`** Cela enverra la liste des fichiers dans le dossier actuel
* **`LIST -R`** Lister r√©cursivement (si autoris√© par le serveur)
* **`APPE /path/something.txt`** Cela indiquera au FTP de stocker les donn√©es re√ßues d'une **connexion passive** ou d'une connexion **PORT/EPRT** dans un fichier. Si le nom de fichier existe, il ajoutera les donn√©es.
* **`STOR /path/something.txt`** Comme `APPE` mais cela √©crasera les fichiers
* **`STOU /path/something.txt`** Comme `APPE`, mais si cela existe, cela ne fera rien.
* **`RETR /path/to/file`** Une connexion passive ou une connexion port doit √™tre √©tablie. Ensuite, le serveur FTP enverra le fichier indiqu√© via cette connexion
* **`REST 6`** Cela indiquera au serveur que la prochaine fois qu'il enverra quelque chose en utilisant `RETR`, il devrait commencer au 6√®me octet.
* **`TYPE i`** D√©finir le transfert en binaire
* **`PASV`** Cela ouvrira une connexion passive et indiquera √† l'utilisateur o√π il peut se connecter
* **`PUT /tmp/file.txt`** T√©l√©charger le fichier indiqu√© sur le FTP

![](<../../.gitbook/assets/image (386).png>)

## Attaque FTPBounce

Certains serveurs FTP permettent la commande PORT. Cette commande peut √™tre utilis√©e pour indiquer au serveur que vous souhaitez vous connecter √† un autre serveur FTP √† un certain port. Ensuite, vous pouvez l'utiliser pour scanner quels ports d'un h√¥te sont ouverts via un serveur FTP.

[**Apprenez ici comment abuser d'un serveur FTP pour scanner des ports.**](ftp-bounce-attack.md)

Vous pourriez √©galement abuser de ce comportement pour faire interagir un serveur FTP avec d'autres protocoles. Vous pourriez **t√©l√©charger un fichier contenant une requ√™te HTTP** et faire en sorte que le serveur FTP vuln√©rable **l'envoie √† un serveur HTTP arbitraire** (_peut-√™tre pour ajouter un nouvel utilisateur admin ?_) ou m√™me t√©l√©charger une requ√™te FTP et faire en sorte que le serveur FTP vuln√©rable t√©l√©charge un fichier pour un autre serveur FTP.\
La th√©orie est simple :

1. **T√©l√©chargez la requ√™te (dans un fichier texte) sur le serveur vuln√©rable.** N'oubliez pas que si vous souhaitez communiquer avec un autre serveur HTTP ou FTP, vous devez changer les lignes avec `0x0d 0x0a`
2. **Utilisez `REST X` pour √©viter d'envoyer les caract√®res que vous ne souhaitez pas envoyer** (peut-√™tre pour t√©l√©charger la requ√™te √† l'int√©rieur du fichier, vous deviez mettre un en-t√™te d'image au d√©but)
3. **Utilisez `PORT` pour vous connecter au serveur et au service arbitraires**
4. **Utilisez `RETR` pour envoyer la requ√™te sauvegard√©e au serveur.**

Il est tr√®s probable que cela **provoque une erreur comme** _**Socket not writable**_ **car la connexion ne dure pas assez longtemps pour envoyer les donn√©es avec `RETR`**. Des suggestions pour essayer d'√©viter cela sont :

* Si vous envoyez une requ√™te HTTP, **mettez la m√™me requ√™te l'une apr√®s l'autre** jusqu'√† **\~0.5MB** au moins. Comme ceci :

{% file src="../../.gitbook/assets/posts.txt" %}
posts.txt
{% endfile %}

* Essayez de **remplir la requ√™te avec des donn√©es "junk" relatives au protocole** (en parlant √† FTP, peut-√™tre juste des commandes junk ou r√©p√©ter l'instruction `RETR` pour obtenir le fichier)
* Juste **remplir la requ√™te avec beaucoup de caract√®res nuls ou autres** (divis√©s sur des lignes ou non)

Quoi qu'il en soit, voici un [ancien exemple sur la fa√ßon d'abuser de cela pour faire t√©l√©charger un fichier d'un serveur FTP diff√©rent.](ftp-bounce-download-2oftp-file.md)

## Vuln√©rabilit√© du serveur Filezilla

**FileZilla** lie g√©n√©ralement **localement** un **service administratif** pour le **FileZilla-Server** (port 14147). Si vous pouvez cr√©er un **tunnel** depuis **votre machine** pour acc√©der √† ce port, vous pouvez **vous connecter** √† **celui-ci** en utilisant un **mot de passe vide** et **cr√©er** un **nouvel utilisateur** pour le service FTP.

## Fichiers de configuration
```
ftpusers
ftp.conf
proftpd.conf
vsftpd.conf
```
### Post-Exploitation

La configuration par d√©faut de vsFTPd peut √™tre trouv√©e dans `/etc/vsftpd.conf`. Ici, vous pourriez trouver quelques param√®tres dangereux :

* `anonymous_enable=YES`
* `anon_upload_enable=YES`
* `anon_mkdir_write_enable=YES`
* `anon_root=/home/username/ftp` - R√©pertoire pour les utilisateurs anonymes.
* `chown_uploads=YES` - Changer la propri√©t√© des fichiers t√©l√©charg√©s anonymement
* `chown_username=username` - Utilisateur √† qui la propri√©t√© des fichiers t√©l√©charg√©s anonymement est attribu√©e
* `local_enable=YES` - Activer les utilisateurs locaux √† se connecter
* `no_anon_password=YES` - Ne pas demander de mot de passe aux utilisateurs anonymes
* `write_enable=YES` - Autoriser les commandes : STOR, DELE, RNFR, RNTO, MKD, RMD, APPE, et SITE

### Shodan

* `ftp`
* `port:21`


## HackTricks Automatic Commands
```
Protocol_Name: FTP    #Protocol Abbreviation if there is one.
Port_Number:  21     #Comma separated if there is more than one.
Protocol_Description: File Transfer Protocol          #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for FTP
Note: |
Anonymous Login
-bi     <<< so that your put is done via binary

wget --mirror 'ftp://ftp_user:UTDRSCH53c"$6hys@10.10.10.59'
^^to download all dirs and files

wget --no-passive-ftp --mirror 'ftp://anonymous:anonymous@10.10.10.98'
if PASV transfer is disabled

https://book.hacktricks.xyz/pentesting/pentesting-ftp

Entry_2:
Name: Banner Grab
Description: Grab FTP Banner via telnet
Command: telnet -n {IP} 21

Entry_3:
Name: Cert Grab
Description: Grab FTP Certificate if existing
Command: openssl s_client -connect {IP}:21 -starttls ftp

Entry_4:
Name: nmap ftp
Description: Anon login and bounce FTP checks are performed
Command: nmap --script ftp-* -p 21 {IP}

Entry_5:
Name: Browser Connection
Description: Connect with Browser
Note: ftp://anonymous:anonymous@{IP}

Entry_6:
Name: Hydra Brute Force
Description: Need Username
Command: hydra -t 1 -l {Username} -P {Big_Passwordlist} -vV {IP} ftp

Entry_7:
Name: consolesless mfs enumeration ftp
Description: FTP enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/ftp/anonymous; set RHOSTS {IP}; set RPORT 21; run; exit' && msfconsole -q -x 'use auxiliary/scanner/ftp/ftp_version; set RHOSTS {IP}; set RPORT 21; run; exit' && msfconsole -q -x 'use auxiliary/scanner/ftp/bison_ftp_traversal; set RHOSTS {IP}; set RPORT 21; run; exit' && msfconsole -q -x 'use auxiliary/scanner/ftp/colorado_ftp_traversal; set RHOSTS {IP}; set RPORT 21; run; exit' &&  msfconsole -q -x 'use auxiliary/scanner/ftp/titanftp_xcrc_traversal; set RHOSTS {IP}; set RPORT 21; run; exit'
```
{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Formation Expert Red Team AWS (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Formation Expert Red Team GCP (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
