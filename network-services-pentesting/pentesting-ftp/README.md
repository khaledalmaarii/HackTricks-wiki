# 21 - Pentesting FTP

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Podstawowe informacje

**ProtokÃ³Å‚ transferu plikÃ³w (FTP)** sÅ‚uÅ¼y jako standardowy protokÃ³Å‚ do transferu plikÃ³w w sieci komputerowej miÄ™dzy serwerem a klientem.\
Jest to **protokÃ³Å‚ w formacie tekstowym**, ktÃ³ry uÅ¼ywa jako **znaku nowej linii `0x0d 0x0a`**, wiÄ™c czasami musisz **poÅ‚Ä…czyÄ‡ siÄ™ uÅ¼ywajÄ…c `telnet`** lub **`nc -C`**.

**DomyÅ›lny port:** 21
```
PORT   STATE SERVICE
21/tcp open  ftp
```
### PoÅ‚Ä…czenia Aktywne i Pasywne

W **Aktywnym FTP** klient FTP najpierw **inicjuje** poÅ‚Ä…czenie kontrolne z portu N do portu komend serwera FTP â€“ port 21. Klient nastÄ™pnie **nasÅ‚uchuje** na porcie **N+1** i wysyÅ‚a port N+1 do serwera FTP. Serwer FTP nastÄ™pnie **inicjuje** poÅ‚Ä…czenie danych, z **jego portu M do portu N+1** klienta FTP.

Jednak, jeÅ›li klient FTP ma skonfigurowany zaporÄ™, ktÃ³ra kontroluje przychodzÄ…ce poÅ‚Ä…czenia danych z zewnÄ…trz, to aktywne FTP moÅ¼e stanowiÄ‡ problem. A wykonalnym rozwiÄ…zaniem jest Pasywne FTP.

W **Pasywnym FTP**, klient inicjuje poÅ‚Ä…czenie kontrolne z portu N do portu 21 serwera FTP. Po tym, klient wydaje **komendÄ™ passv**. Serwer nastÄ™pnie wysyÅ‚a klientowi jeden ze swoich numerÃ³w portu M. A **klient** **inicjuje** poÅ‚Ä…czenie **danych** z **jego portu P do portu M** serwera FTP.

Å¹rÃ³dÅ‚o: [https://www.thesecuritybuddy.com/vulnerabilities/what-is-ftp-bounce-attack/](https://www.thesecuritybuddy.com/vulnerabilities/what-is-ftp-bounce-attack/)

### Debugowanie poÅ‚Ä…czenia

Polecenia **FTP** **`debug`** i **`trace`** mogÄ… byÄ‡ uÅ¼ywane do zobaczenia **jak odbywa siÄ™ komunikacja**.

## Enumeracja

### Przechwytywanie banerÃ³w
```bash
nc -vn <IP> 21
openssl s_client -connect crossfit.htb:21 -starttls ftp #Get certificate if any
```
### PoÅ‚Ä…czenie z FTP za pomocÄ… starttls
```
lftp
lftp :~> set ftp:ssl-force true
lftp :~> set ssl:verify-certificate no
lftp :~> connect 10.10.10.208
lftp 10.10.10.208:~> login
Usage: login <user|URL> [<pass>]
lftp 10.10.10.208:~> login username Password
```
### Unauth enum

Z **nmap**
```bash
sudo nmap -sV -p21 -sC -A 10.10.10.10
```
MoÅ¼esz uÅ¼yÄ‡ poleceÅ„ `HELP` i `FEAT`, aby uzyskaÄ‡ informacje o serwerze FTP:
```
HELP
214-The following commands are recognized (* =>'s unimplemented):
214-CWD     XCWD    CDUP    XCUP    SMNT*   QUIT    PORT    PASV
214-EPRT    EPSV    ALLO*   RNFR    RNTO    DELE    MDTM    RMD
214-XRMD    MKD     XMKD    PWD     XPWD    SIZE    SYST    HELP
214-NOOP    FEAT    OPTS    AUTH    CCC*    CONF*   ENC*    MIC*
214-PBSZ    PROT    TYPE    STRU    MODE    RETR    STOR    STOU
214-APPE    REST    ABOR    USER    PASS    ACCT*   REIN*   LIST
214-NLST    STAT    SITE    MLSD    MLST
214 Direct comments to root@drei.work

FEAT
211-Features:
PROT
CCC
PBSZ
AUTH TLS
MFF modify;UNIX.group;UNIX.mode;
REST STREAM
MLST modify*;perm*;size*;type*;unique*;UNIX.group*;UNIX.mode*;UNIX.owner*;
UTF8
EPRT
EPSV
LANG en-US
MDTM
SSCN
TVFS
MFMT
SIZE
211 End

STAT
#Info about the FTP server (version, configs, status...)
```
### Logowanie anonimowe

_anonymous : anonimowy_\
_anonymous :_\
_ftp : ftp_
```bash
ftp <IP>
>anonymous
>anonymous
>ls -a # List all files (even hidden) (yes, they could be hidden)
>binary #Set transmission to binary instead of ascii
>ascii #Set transmission to ascii instead of binary
>bye #exit
```
### [Brute force](../../generic-methodologies-and-resources/brute-force.md#ftp)

Tutaj znajdziesz Å‚adnÄ… listÄ™ z domyÅ›lnymi danymi logowania do ftp: [https://github.com/danielmiessler/SecLists/blob/master/Passwords/Default-Credentials/ftp-betterdefaultpasslist.txt](https://github.com/danielmiessler/SecLists/blob/master/Passwords/Default-Credentials/ftp-betterdefaultpasslist.txt)

### Automated

Anonimowe logowanie i sprawdzenie bounce FTP sÄ… wykonywane domyÅ›lnie przez nmap z opcjÄ… **-sC** lub:
```bash
nmap --script ftp-* -p 21 <ip>
```
## PoÅ‚Ä…czenie przez przeglÄ…darkÄ™

MoÅ¼esz poÅ‚Ä…czyÄ‡ siÄ™ z serwerem FTP za pomocÄ… przeglÄ…darki (takiej jak Firefox) uÅ¼ywajÄ…c adresu URL takiego jak:
```bash
ftp://anonymous:anonymous@10.10.10.98
```
ZauwaÅ¼, Å¼e jeÅ›li **aplikacja webowa** wysyÅ‚a dane kontrolowane przez uÅ¼ytkownika **bezpoÅ›rednio do serwera FTP**, moÅ¼esz wysÅ‚aÄ‡ podwÃ³jne kodowanie URL `%0d%0a` (w podwÃ³jnym kodowaniu URL to `%250d%250a`) i sprawiÄ‡, Å¼e **serwer FTP wykona dowolne akcje**. JednÄ… z tych moÅ¼liwych dowolnych akcji jest pobranie zawartoÅ›ci z serwera kontrolowanego przez uÅ¼ytkownika, przeprowadzenie skanowania portÃ³w lub prÃ³ba komunikacji z innymi usÅ‚ugami opartymi na czystym tekÅ›cie (takimi jak http).

## Pobierz wszystkie pliki z FTP
```bash
wget -m ftp://anonymous:anonymous@10.10.10.98 #Donwload all
wget -m --no-passive ftp://anonymous:anonymous@10.10.10.98 #Download all
```
JeÅ›li twoja nazwa uÅ¼ytkownika/hasÅ‚o zawiera znaki specjalne, moÅ¼na uÅ¼yÄ‡ [nastÄ™pujÄ…cego polecenia](https://stackoverflow.com/a/113900/13647948):
```bash
wget -r --user="USERNAME" --password="PASSWORD" ftp://server.com/
```
## NiektÃ³re komendy FTP

* **`USER username`**
* **`PASS password`**
* **`HELP`** Serwer wskazuje, ktÃ³re komendy sÄ… obsÅ‚ugiwane
* \*\*`PORT 127,0,0,1,0,80`\*\*To wskaÅ¼e serwerowi FTP nawiÄ…zanie poÅ‚Ä…czenia z IP 127.0.0.1 na porcie 80 (_musisz wpisaÄ‡ 5-ty znak jako "0" i 6-ty jako port w systemie dziesiÄ™tnym lub uÅ¼yÄ‡ 5-tego i 6-tego do wyraÅ¼enia portu w systemie szesnastkowym_).
* \*\*`EPRT |2|127.0.0.1|80|`\*\*To wskaÅ¼e serwerowi FTP nawiÄ…zanie poÅ‚Ä…czenia TCP (_wskazane przez "2"_) z IP 127.0.0.1 na porcie 80. Ta komenda **obsÅ‚uguje IPv6**.
* **`LIST`** To wyÅ›le listÄ™ plikÃ³w w bieÅ¼Ä…cym folderze
* **`LIST -R`** Lista rekurencyjna (jeÅ›li dozwolone przez serwer)
* **`APPE /path/something.txt`** To wskaÅ¼e FTP na zapisanie danych otrzymanych z **pasywnego** poÅ‚Ä…czenia lub z poÅ‚Ä…czenia **PORT/EPRT** do pliku. JeÅ›li nazwa pliku istnieje, dane zostanÄ… doÅ‚Ä…czone.
* **`STOR /path/something.txt`** Jak `APPE`, ale nadpisze pliki
* **`STOU /path/something.txt`** Jak `APPE`, ale jeÅ›li istnieje, nie zrobi nic.
* **`RETR /path/to/file`** Musi byÄ‡ nawiÄ…zane pasywne lub portowe poÅ‚Ä…czenie. NastÄ™pnie serwer FTP wyÅ›le wskazany plik przez to poÅ‚Ä…czenie
* **`REST 6`** To wskaÅ¼e serwerowi, Å¼e nastÄ™pnym razem, gdy wyÅ›le coÅ› uÅ¼ywajÄ…c `RETR`, powinien zaczÄ…Ä‡ od 6. bajtu.
* **`TYPE i`** Ustaw transfer na binarny
* **`PASV`** To otworzy pasywne poÅ‚Ä…czenie i wskaÅ¼e uÅ¼ytkownikowi, gdzie moÅ¼e siÄ™ poÅ‚Ä…czyÄ‡
* **`PUT /tmp/file.txt`** PrzeÅ›lij wskazany plik do FTP

![](<../../.gitbook/assets/image (386).png>)

## Atak FTPBounce

NiektÃ³re serwery FTP pozwalajÄ… na komendÄ™ PORT. Ta komenda moÅ¼e byÄ‡ uÅ¼yta do wskazania serwerowi, Å¼e chcesz poÅ‚Ä…czyÄ‡ siÄ™ z innym serwerem FTP na pewnym porcie. NastÄ™pnie moÅ¼esz uÅ¼yÄ‡ tego do skanowania, ktÃ³re porty hosta sÄ… otwarte przez serwer FTP.

[**Dowiedz siÄ™ tutaj, jak naduÅ¼yÄ‡ serwera FTP do skanowania portÃ³w.**](ftp-bounce-attack.md)

MoÅ¼esz rÃ³wnieÅ¼ naduÅ¼yÄ‡ tego zachowania, aby sprawiÄ‡, Å¼e serwer FTP bÄ™dzie wspÃ³Å‚dziaÅ‚aÅ‚ z innymi protokoÅ‚ami. MoÅ¼esz **przesÅ‚aÄ‡ plik zawierajÄ…cy Å¼Ä…danie HTTP** i sprawiÄ‡, by podatny serwer FTP **wysÅ‚aÅ‚ je do dowolnego serwera HTTP** (_moÅ¼e, aby dodaÄ‡ nowego uÅ¼ytkownika admina?_) lub nawet przesÅ‚aÄ‡ Å¼Ä…danie FTP i sprawiÄ‡, by podatny serwer FTP pobraÅ‚ plik z innego serwera FTP.\
Teoria jest prosta:

1. **PrzeÅ›lij Å¼Ä…danie (w pliku tekstowym) do podatnego serwera.** PamiÄ™taj, Å¼e jeÅ›li chcesz rozmawiaÄ‡ z innym serwerem HTTP lub FTP, musisz zmieniÄ‡ linie na `0x0d 0x0a`
2. **UÅ¼yj `REST X`, aby uniknÄ…Ä‡ wysyÅ‚ania znakÃ³w, ktÃ³rych nie chcesz wysyÅ‚aÄ‡** (moÅ¼e, aby przesÅ‚aÄ‡ Å¼Ä…danie w pliku, musiaÅ‚eÅ› dodaÄ‡ nagÅ‚Ã³wek obrazu na poczÄ…tku)
3. **UÅ¼yj `PORT`, aby poÅ‚Ä…czyÄ‡ siÄ™ z dowolnym serwerem i usÅ‚ugÄ…**
4. **UÅ¼yj `RETR`, aby wysÅ‚aÄ‡ zapisane Å¼Ä…danie do serwera.**

Jest bardzo prawdopodobne, Å¼e **spowoduje to bÅ‚Ä…d taki jak** _**Socket not writable**_ **poniewaÅ¼ poÅ‚Ä…czenie nie trwa wystarczajÄ…co dÅ‚ugo, aby wysÅ‚aÄ‡ dane za pomocÄ… `RETR`**. Sugestie, aby sprÃ³bowaÄ‡ tego uniknÄ…Ä‡, to:

* JeÅ›li wysyÅ‚asz Å¼Ä…danie HTTP, **umieÅ›Ä‡ to samo Å¼Ä…danie jedno po drugim** aÅ¼ do **\~0.5MB** przynajmniej. Tak jak to:

{% file src="../../.gitbook/assets/posts.txt" %}
posts.txt
{% endfile %}

* SprÃ³buj **wypeÅ‚niÄ‡ Å¼Ä…danie "Å›mieciowymi" danymi zwiÄ…zanymi z protokoÅ‚em** (rozmawiajÄ…c z FTP, moÅ¼e po prostu Å›mieciowe komendy lub powtarzajÄ…c instrukcjÄ™ `RETR`, aby uzyskaÄ‡ plik)
* Po prostu **wypeÅ‚nij Å¼Ä…danie duÅ¼Ä… iloÅ›ciÄ… znakÃ³w null lub innych** (podzielonych na linie lub nie)

W kaÅ¼dym razie, oto [stary przykÅ‚ad, jak naduÅ¼yÄ‡ tego, aby sprawiÄ‡, Å¼e serwer FTP pobierze plik z innego serwera FTP.](ftp-bounce-download-2oftp-file.md)

## WraÅ¼liwoÅ›Ä‡ serwera Filezilla

**FileZilla** zazwyczaj **wiÄ…Å¼e** siÄ™ z **lokalnym** **serwisem administracyjnym** dla **FileZilla-Server** (port 14147). JeÅ›li moÅ¼esz stworzyÄ‡ **tunel** z **twojej maszyny** do dostÄ™pu do tego portu, moÅ¼esz **poÅ‚Ä…czyÄ‡ siÄ™** z **nim** uÅ¼ywajÄ…c **pustego hasÅ‚a** i **utworzyÄ‡** **nowego uÅ¼ytkownika** dla usÅ‚ugi FTP.

## Pliki konfiguracyjne
```
ftpusers
ftp.conf
proftpd.conf
vsftpd.conf
```
### Post-Exploitation

DomyÅ›lna konfiguracja vsFTPd znajduje siÄ™ w `/etc/vsftpd.conf`. MoÅ¼esz tutaj znaleÅºÄ‡ niebezpieczne ustawienia:

* `anonymous_enable=YES`
* `anon_upload_enable=YES`
* `anon_mkdir_write_enable=YES`
* `anon_root=/home/username/ftp` - Katalog dla anonimowych.
* `chown_uploads=YES` - ZmieÅ„ wÅ‚aÅ›ciciela anonimowo przesÅ‚anych plikÃ³w
* `chown_username=username` - UÅ¼ytkownik, ktÃ³ry otrzymuje wÅ‚asnoÅ›Ä‡ anonimowo przesÅ‚anych plikÃ³w
* `local_enable=YES` - ZezwÃ³l lokalnym uÅ¼ytkownikom na logowanie
* `no_anon_password=YES` - Nie pytaj anonimowych o hasÅ‚o
* `write_enable=YES` - ZezwÃ³l na polecenia: STOR, DELE, RNFR, RNTO, MKD, RMD, APPE i SITE

### Shodan

* `ftp`
* `port:21`


## HackTricks Automatic Commands
```
Protocol_Name: FTP    #Protocol Abbreviation if there is one.
Port_Number:  21     #Comma separated if there is more than one.
Protocol_Description: File Transfer Protocol          #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for FTP
Note: |
Anonymous Login
-bi     <<< so that your put is done via binary

wget --mirror 'ftp://ftp_user:UTDRSCH53c"$6hys@10.10.10.59'
^^to download all dirs and files

wget --no-passive-ftp --mirror 'ftp://anonymous:anonymous@10.10.10.98'
if PASV transfer is disabled

https://book.hacktricks.xyz/pentesting/pentesting-ftp

Entry_2:
Name: Banner Grab
Description: Grab FTP Banner via telnet
Command: telnet -n {IP} 21

Entry_3:
Name: Cert Grab
Description: Grab FTP Certificate if existing
Command: openssl s_client -connect {IP}:21 -starttls ftp

Entry_4:
Name: nmap ftp
Description: Anon login and bounce FTP checks are performed
Command: nmap --script ftp-* -p 21 {IP}

Entry_5:
Name: Browser Connection
Description: Connect with Browser
Note: ftp://anonymous:anonymous@{IP}

Entry_6:
Name: Hydra Brute Force
Description: Need Username
Command: hydra -t 1 -l {Username} -P {Big_Passwordlist} -vV {IP} ftp

Entry_7:
Name: consolesless mfs enumeration ftp
Description: FTP enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/ftp/anonymous; set RHOSTS {IP}; set RPORT 21; run; exit' && msfconsole -q -x 'use auxiliary/scanner/ftp/ftp_version; set RHOSTS {IP}; set RPORT 21; run; exit' && msfconsole -q -x 'use auxiliary/scanner/ftp/bison_ftp_traversal; set RHOSTS {IP}; set RPORT 21; run; exit' && msfconsole -q -x 'use auxiliary/scanner/ftp/colorado_ftp_traversal; set RHOSTS {IP}; set RPORT 21; run; exit' &&  msfconsole -q -x 'use auxiliary/scanner/ftp/titanftp_xcrc_traversal; set RHOSTS {IP}; set RPORT 21; run; exit'
```
{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel siÄ™ trikami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>
{% endhint %}
