# 21 - Pentesting FTP

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* Da li radite u **kompaniji za kiberneti캜ku bezbednost**? 콯elite li da vidite svoju **kompaniju reklamiranu na HackTricks**? ili 쬰lite pristup **najnovijoj verziji PEASS ili preuzimanje HackTricks u PDF formatu**? Proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* **Pridru쬴te se** [**游눫**](https://emojipedia.org/speech-balloon/) [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili me **pratite** na **Twitteru** 游냕[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova** [**hacktricks repozitorijumu**](https://github.com/carlospolop/hacktricks) **i** [**hacktricks-cloud repozitorijumu**](https://github.com/carlospolop/hacktricks-cloud).

</details>

**Try Hard Security Group**

<figure><img src="/.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

***

## Osnovne informacije

**Protokol za prenos fajlova (FTP)** slu쬴 kao standardni protokol za prenos fajlova preko ra캜unarske mre쬰 izme캠u servera i klijenta.\
To je **plain-text** protokol koji koristi **novi karakter za novi red `0x0d 0x0a`** pa ponekad morate **povezati se koriste캖i `telnet`** ili **`nc -C`**.

**Podrazumevani port:** 21
```
PORT   STATE SERVICE
21/tcp open  ftp
```
### Aktivne i pasivne veze

U **Aktivnom FTP-u** FTP **klijent** prvo **inicira** kontrolnu **vezu** sa svog porta N do FTP servera na komandnom portu - port 21. Klijent zatim **slu코a** na portu **N+1** i 코alje port N+1 FTP serveru. FTP **server** zatim **inicira** vezu za prenos podataka, sa **svog porta M do porta N+1** FTP klijenta.

Me캠utim, ako FTP klijent ima firewall postavljen koji kontroli코e dolazne veze za prenos podataka sa spoljnih lokacija, tada aktivni FTP mo쬰 predstavljati problem. I, izvodljivo re코enje za to je Pasivni FTP.

U **Pasivnom FTP-u**, klijent inicira kontrolnu vezu sa svog porta N do porta 21 FTP servera. Nakon toga, klijent izdaje **passv komandu**. Server zatim 코alje klijentu jedan od svojih brojeva porta M. I **klijent** **inicira** vezu za prenos podataka sa **svog porta P do porta M** FTP servera.

Izvor: [https://www.thesecuritybuddy.com/vulnerabilities/what-is-ftp-bounce-attack/](https://www.thesecuritybuddy.com/vulnerabilities/what-is-ftp-bounce-attack/)

### Debugiranje veze

**FTP** komande **`debug`** i **`trace`** mogu se koristiti da se vidi **kako se odvija komunikacija**.

## Enumeracija

### Preuzimanje banera
```bash
nc -vn <IP> 21
openssl s_client -connect crossfit.htb:21 -starttls ftp #Get certificate if any
```
### Pove쬴te se na FTP koriste캖i starttls
```
lftp
lftp :~> set ftp:ssl-force true
lftp :~> set ssl:verify-certificate no
lftp :~> connect 10.10.10.208
lftp 10.10.10.208:~> login
Usage: login <user|URL> [<pass>]
lftp 10.10.10.208:~> login username Password
```
### Neautorizovano nabrajanje

Kori코캖enjem **nmap**-a
```bash
sudo nmap -sV -p21 -sC -A 10.10.10.10
```
Mo쬰te koristiti komande `HELP` i `FEAT` da biste dobili informacije o FTP serveru:
```
HELP
214-The following commands are recognized (* =>'s unimplemented):
214-CWD     XCWD    CDUP    XCUP    SMNT*   QUIT    PORT    PASV
214-EPRT    EPSV    ALLO*   RNFR    RNTO    DELE    MDTM    RMD
214-XRMD    MKD     XMKD    PWD     XPWD    SIZE    SYST    HELP
214-NOOP    FEAT    OPTS    AUTH    CCC*    CONF*   ENC*    MIC*
214-PBSZ    PROT    TYPE    STRU    MODE    RETR    STOR    STOU
214-APPE    REST    ABOR    USER    PASS    ACCT*   REIN*   LIST
214-NLST    STAT    SITE    MLSD    MLST
214 Direct comments to root@drei.work

FEAT
211-Features:
PROT
CCC
PBSZ
AUTH TLS
MFF modify;UNIX.group;UNIX.mode;
REST STREAM
MLST modify*;perm*;size*;type*;unique*;UNIX.group*;UNIX.mode*;UNIX.owner*;
UTF8
EPRT
EPSV
LANG en-US
MDTM
SSCN
TVFS
MFMT
SIZE
211 End

STAT
#Info about the FTP server (version, configs, status...)
```
### Anonimna prijava

_anonymous : anonymous_\
_anonymous :_\
_ftp : ftp_
```bash
ftp <IP>
>anonymous
>anonymous
>ls -a # List all files (even hidden) (yes, they could be hidden)
>binary #Set transmission to binary instead of ascii
>ascii #Set transmission to ascii instead of binary
>bye #exit
```
### [Brute force](../../generic-methodologies-and-resources/brute-force.md#ftp)

Ovde mo쬰te prona캖i lepu listu sa podrazumevanim ftp kredencijalima: [https://github.com/danielmiessler/SecLists/blob/master/Passwords/Default-Credentials/ftp-betterdefaultpasslist.txt](https://github.com/danielmiessler/SecLists/blob/master/Passwords/Default-Credentials/ftp-betterdefaultpasslist.txt)

### Automatizovano

Provere anonimnog prijavljivanja i FTP provere se podrazumevano vr코e nmap-om sa opcijom **-sC** ili:
```bash
nmap --script ftp-* -p 21 <ip>
```
## Povezivanje pretra쬴va캜em

Mo쬰te se povezati sa FTP serverom koriste캖i pretra쬴va캜 (kao 코to je Firefox) koriste캖i URL adresu:
```bash
ftp://anonymous:anonymous@10.10.10.98
```
Imajte na umu da ako **veb aplikacija** 코alje podatke koje kontroli코e korisnik **direktno na FTP server**, mo쬰te poslati dvostruko URL enkodirane `%0d%0a` bajtove (u dvostrukom URL enkodiranju ovo je `%250d%250a`) i naterati **FTP server da izvr코i proizvoljne radnje**. Jedna od mogu캖ih proizvoljnih radnji je preuzimanje sadr쬬ja sa servera koji kontroli코e korisnik, vr코enje skeniranja portova ili poku코aj komunikacije sa drugim servisima zasnovanim na obi캜nom tekstu (kao 코to je http).

## Preuzmite sve fajlove sa FTP-a
```bash
wget -m ftp://anonymous:anonymous@10.10.10.98 #Donwload all
wget -m --no-passive ftp://anonymous:anonymous@10.10.10.98 #Download all
```
Ako va코 korisni캜ko ime/코ifra sadr쬴 specijalne karaktere, mo쬰 se koristiti [slede캖a komanda](https://stackoverflow.com/a/113900/13647948):
```bash
wget -r --user="USERNAME" --password="PASSWORD" ftp://server.com/
```
## Neke FTP komande

* **`USER korisni캜ko_ime`**
* **`PASS lozinka`**
* **`HELP`** Server pokazuje koje komande podr쬬va
* \*\*`PORT 127,0,0,1,0,80`\*\*Ovo 캖e pokazati FTP serveru da uspostavi vezu sa IP adresom 127.0.0.1 na portu 80 (_trebate postaviti 5. karakter kao "0" i 6. kao port u decimalnom obliku ili koristiti 5. i 6. za izra쬬vanje porta u heksadecimalnom obliku_).
* \*\*`EPRT |2|127.0.0.1|80|`\*\*Ovo 캖e pokazati FTP serveru da uspostavi TCP vezu (_ozna캜eno sa "2"_) sa IP adresom 127.0.0.1 na portu 80. Ova komanda **podr쬬va IPv6**.
* **`LIST`** Ovo 캖e poslati listu fajlova u trenutnom folderu
* **`LIST -R`** Rekurzivno listanje (ako je dozvoljeno od strane servera)
* **`APPE /putanja/ne코to.txt`** Ovo 캖e pokazati FTP-u da sa캜uva primljene podatke sa **pasivne** ili **PORT/EPRT** veze u fajl. Ako fajl ve캖 postoji, dodava캖e podatke.
* **`STOR /putanja/ne코to.txt`** Sli캜no kao `APPE` ali 캖e prebrisati fajlove
* **`STOU /putanja/ne코to.txt`** Sli캜no kao `APPE`, ali ako fajl ve캖 postoji, ne캖e uraditi ni코ta.
* **`RETR /putanja/do/fajla`** Mora se uspostaviti pasivna ili port konekcija. Zatim, FTP server 캖e poslati nazna캜eni fajl preko te veze
* **`REST 6`** Ovo 캖e pokazati serveru da slede캖i put kada 코alje ne코to koriste캖i `RETR` treba da po캜ne od 6. bajta.
* **`TYPE i`** Postavlja transfer u binarni mod
* **`PASV`** Ovo 캖e otvoriti pasivnu vezu i pokazati korisniku gde mo쬰 da se pove쬰
* **`PUT /tmp/fajl.txt`** Uploaduje nazna캜eni fajl na FTP

![](<../../.gitbook/assets/image (227).png>)

## FTPBounce napad

Neki FTP serveri dozvoljavaju komandu PORT. Ova komanda se mo쬰 koristiti da se poka쬰 serveru da 쬰lite da se pove쬰te sa drugim FTP serverom na odre캠enom portu. Zatim, mo쬰te koristiti ovo da skenirate koje portove na hostu su otvorene preko FTP servera.

[**Saznajte ovde kako zloupotrebiti FTP server za skeniranje portova.**](ftp-bounce-attack.md)

Tako캠e mo쬰te zloupotrebiti ovu funkcionalnost da naterate FTP server da interaguje sa drugim protokolima. Mo쬰te **uploadovati fajl koji sadr쬴 HTTP zahtev** i naterati ranjivi FTP server da ga **po코alje proizvoljnom HTTP serveru** (_mo쬯a da dodate novog admin korisnika?_) ili 캜ak uploadovati FTP zahtev i naterati ranjivi FTP server da preuzme fajl sa drugog FTP servera.\
Teorija je jednostavna:

1. **Uploadujte zahtev (unutar tekstualnog fajla) na ranjivi server.** Zapamtite da ako 쬰lite da komunicirate sa drugim HTTP ili FTP serverom, morate promeniti linije sa `0x0d 0x0a`
2. **Koristite `REST X` da biste izbegli slanje karaktera koje ne 쬰lite da po코aljete** (mo쬯a ste morali da stavite neki zaglavlje slike na po캜etak da biste uploadovali zahtev unutar fajla)
3. **Koristite `PORT` da se pove쬰te sa proizvoljnim serverom i servisom**
4. **Koristite `RETR` da po코aljete sa캜uvani zahtev serveru.**

Veoma je verovatno da 캖e ovo **izazvati gre코ku kao** _**Socket not writable**_ **jer veza ne traje dovoljno dugo da po코alje podatke sa `RETR`**. Predlozi za poku코aj izbegavanja toga su:

* Ako 코aljete HTTP zahtev, **stavite isti zahtev jedan za drugim** dok ne dostignete **\~0.5MB** barem. Na primer:

{% file src="../../.gitbook/assets/posts (1).txt" %}
posts.txt
{% endfile %}

* Poku코ajte da **popunite zahtev "junk" podacima relativnim za protokol** (razgovor sa FTP-om mo쬯a samo junk komande ili ponavljanje `RETR` instrukcije za dobijanje fajla)
* Jednostavno **popunite zahtev sa puno nula karaktera ili drugih** (podeljeno u linije ili ne)

U svakom slu캜aju, ovde imate [stari primer kako zloupotrebiti ovo da naterate FTP server da preuzme fajl sa drugog FTP servera.](ftp-bounce-download-2oftp-file.md)

## Filezilla Server Ranjivost

**FileZilla** obi캜no **vezuje** lokalnu **Administrativnu uslugu** za **FileZilla-Server** (port 14147). Ako mo쬰te napraviti **tunel** sa **va코e ma코ine** da pristupite ovom portu, mo쬰te se **povezati** na **njega** koriste캖i **praznu lozinku** i **kreirati** novog korisnika za FTP servis.

## Konfiguracioni fajlovi
```
ftpusers
ftp.conf
proftpd.conf
vsftpd.conf
```
### Post-Eksploatacija

Podrazumevana konfiguracija vsFTPd-a mo쬰 se prona캖i u `/etc/vsftpd.conf`. Ovde mo쬰te prona캖i neke opasne postavke:

* `anonymous_enable=YES`
* `anon_upload_enable=YES`
* `anon_mkdir_write_enable=YES`
* `anon_root=/home/username/ftp` - Direktorijum za anonimne korisnike.
* `chown_uploads=YES` - Promena vlasni코tva nad anonimno otpremljenim fajlovima
* `chown_username=username` - Korisnik koji dobija vlasni코tvo nad anonimno otpremljenim fajlovima
* `local_enable=YES` - Omogu캖ava lokalnim korisnicima prijavljivanje
* `no_anon_password=YES` - Ne tra쬴 anonimnog korisnika za lozinku
* `write_enable=YES` - Dozvoljava komande: STOR, DELE, RNFR, RNTO, MKD, RMD, APPE, i SITE

### Shodan

* `ftp`
* `port:21`

***

**Try Hard Security Group**

<figure><img src="/.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

***

## HackTricks Automatske Komande
```
Protocol_Name: FTP    #Protocol Abbreviation if there is one.
Port_Number:  21     #Comma separated if there is more than one.
Protocol_Description: File Transfer Protocol          #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for FTP
Note: |
Anonymous Login
-bi     <<< so that your put is done via binary

wget --mirror 'ftp://ftp_user:UTDRSCH53c"$6hys@10.10.10.59'
^^to download all dirs and files

wget --no-passive-ftp --mirror 'ftp://anonymous:anonymous@10.10.10.98'
if PASV transfer is disabled

https://book.hacktricks.xyz/pentesting/pentesting-ftp

Entry_2:
Name: Banner Grab
Description: Grab FTP Banner via telnet
Command: telnet -n {IP} 21

Entry_3:
Name: Cert Grab
Description: Grab FTP Certificate if existing
Command: openssl s_client -connect {IP}:21 -starttls ftp

Entry_4:
Name: nmap ftp
Description: Anon login and bounce FTP checks are performed
Command: nmap --script ftp-* -p 21 {IP}

Entry_5:
Name: Browser Connection
Description: Connect with Browser
Note: ftp://anonymous:anonymous@{IP}

Entry_6:
Name: Hydra Brute Force
Description: Need Username
Command: hydra -t 1 -l {Username} -P {Big_Passwordlist} -vV {IP} ftp

Entry_7:
Name: consolesless mfs enumeration ftp
Description: FTP enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/ftp/anonymous; set RHOSTS {IP}; set RPORT 21; run; exit' && msfconsole -q -x 'use auxiliary/scanner/ftp/ftp_version; set RHOSTS {IP}; set RPORT 21; run; exit' && msfconsole -q -x 'use auxiliary/scanner/ftp/bison_ftp_traversal; set RHOSTS {IP}; set RPORT 21; run; exit' && msfconsole -q -x 'use auxiliary/scanner/ftp/colorado_ftp_traversal; set RHOSTS {IP}; set RPORT 21; run; exit' &&  msfconsole -q -x 'use auxiliary/scanner/ftp/titanftp_xcrc_traversal; set RHOSTS {IP}; set RPORT 21; run; exit'
```
<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* Da li radite u **kompaniji za kiberneti캜ku bezbednost**? 콯elite li da vidite svoju **kompaniju reklamiranu na HackTricks**? ili 쬰lite pristupiti **najnovijoj verziji PEASS ili preuzeti HackTricks u PDF formatu**? Proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* **Pridru쬴te se** [**游눫**](https://emojipedia.org/speech-balloon/) [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili **telegram grupi** ili me **pratite** na **Twitteru** 游냕[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova u** [**hacktricks repozitorijum**](https://github.com/carlospolop/hacktricks) **i** [**hacktricks-cloud repozitorijum**](https://github.com/carlospolop/hacktricks-cloud).

</details>
