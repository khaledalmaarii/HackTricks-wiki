# 21 - Pentesting FTP

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Osnovne informacije

**File Transfer Protocol (FTP)** slu≈æi kao standardni protokol za prenos datoteka preko raƒçunarske mre≈æe izmeƒëu servera i klijenta.\
To je **protokol u obiƒçnom tekstu** koji koristi kao **karakter novog reda `0x0d 0x0a`** pa ponekad treba da se **pove≈æete koristeƒái `telnet`** ili **`nc -C`**.

**Podrazumevani port:** 21
```
PORT   STATE SERVICE
21/tcp open  ftp
```
### Connections Active & Passive

U **Aktivnom FTP-u** FTP **klijent** prvo **inicira** kontrolnu **vezu** sa svog porta N na komandni port FTP servera ‚Äì port 21. **Klijent** zatim **slu≈°a** port **N+1** i ≈°alje port N+1 FTP serveru. FTP **server** zatim **inicira** podatkovnu **vezu**, sa **svojeg porta M na port N+1** FTP klijenta.

Meƒëutim, ako FTP klijent ima pode≈°en firewall koji kontroli≈°e dolazne podatkovne veze sa spolja, tada aktivni FTP mo≈æe biti problem. A, izvodljivo re≈°enje za to je Pasivni FTP.

U **Pasivnom FTP-u**, klijent inicira kontrolnu vezu sa svog porta N na port 21 FTP servera. Nakon toga, klijent izdaje **passv komandu**. Server zatim ≈°alje klijentu jedan od svojih brojeva portova M. I **klijent** **inicira** podatkovnu **vezu** sa **svojeg porta P na port M** FTP servera.

Source: [https://www.thesecuritybuddy.com/vulnerabilities/what-is-ftp-bounce-attack/](https://www.thesecuritybuddy.com/vulnerabilities/what-is-ftp-bounce-attack/)

### Connection debugging

**FTP** komande **`debug`** i **`trace`** mogu se koristiti da se vidi **kako se komunikacija odvija**.

## Enumeration

### Banner Grabbing
```bash
nc -vn <IP> 21
openssl s_client -connect crossfit.htb:21 -starttls ftp #Get certificate if any
```
### Povezivanje na FTP koristeƒái starttls
```
lftp
lftp :~> set ftp:ssl-force true
lftp :~> set ssl:verify-certificate no
lftp :~> connect 10.10.10.208
lftp 10.10.10.208:~> login
Usage: login <user|URL> [<pass>]
lftp 10.10.10.208:~> login username Password
```
### Unauth enum

Sa **nmap**
```bash
sudo nmap -sV -p21 -sC -A 10.10.10.10
```
Mo≈æete koristiti komande `HELP` i `FEAT` da dobijete neke informacije o FTP serveru:
```
HELP
214-The following commands are recognized (* =>'s unimplemented):
214-CWD     XCWD    CDUP    XCUP    SMNT*   QUIT    PORT    PASV
214-EPRT    EPSV    ALLO*   RNFR    RNTO    DELE    MDTM    RMD
214-XRMD    MKD     XMKD    PWD     XPWD    SIZE    SYST    HELP
214-NOOP    FEAT    OPTS    AUTH    CCC*    CONF*   ENC*    MIC*
214-PBSZ    PROT    TYPE    STRU    MODE    RETR    STOR    STOU
214-APPE    REST    ABOR    USER    PASS    ACCT*   REIN*   LIST
214-NLST    STAT    SITE    MLSD    MLST
214 Direct comments to root@drei.work

FEAT
211-Features:
PROT
CCC
PBSZ
AUTH TLS
MFF modify;UNIX.group;UNIX.mode;
REST STREAM
MLST modify*;perm*;size*;type*;unique*;UNIX.group*;UNIX.mode*;UNIX.owner*;
UTF8
EPRT
EPSV
LANG en-US
MDTM
SSCN
TVFS
MFMT
SIZE
211 End

STAT
#Info about the FTP server (version, configs, status...)
```
### Anonymous login

_anonymous : –∞–Ω–æ–Ω–∏–º–∞–Ω_\
_anonymous :_\
_ftp : ftp_
```bash
ftp <IP>
>anonymous
>anonymous
>ls -a # List all files (even hidden) (yes, they could be hidden)
>binary #Set transmission to binary instead of ascii
>ascii #Set transmission to ascii instead of binary
>bye #exit
```
### [Brute force](../../generic-methodologies-and-resources/brute-force.md#ftp)

Ovde mo≈æete pronaƒái lepu listu sa podrazumevanim ftp akreditivima: [https://github.com/danielmiessler/SecLists/blob/master/Passwords/Default-Credentials/ftp-betterdefaultpasslist.txt](https://github.com/danielmiessler/SecLists/blob/master/Passwords/Default-Credentials/ftp-betterdefaultpasslist.txt)

### Automated

Anon login i bounce FTP provere se izvode podrazumevano od strane nmap-a sa **-sC** opcijom ili:
```bash
nmap --script ftp-* -p 21 <ip>
```
## Browser connection

Mo≈æete se povezati na FTP server koristeƒái pregledaƒç (kao ≈°to je Firefox) koristeƒái URL kao:
```bash
ftp://anonymous:anonymous@10.10.10.98
```
Napomena da ako **web aplikacija** ≈°alje podatke koje kontroli≈°e korisnik **direktno na FTP server**, mo≈æete poslati dvostruko URL kodirane `%0d%0a` (u dvostruko URL kodiranju ovo je `%250d%250a`) bajtove i naterati **FTP server da izvr≈°i proizvoljne radnje**. Jedna od ovih moguƒáih proizvoljnih radnji je preuzimanje sadr≈æaja sa servera koji kontroli≈°e korisnik, izvoƒëenje skeniranja portova ili poku≈°aj komunikacije sa drugim uslugama zasnovanim na obiƒçnom tekstu (kao ≈°to je http).

## Preuzmi sve fajlove sa FTP-a
```bash
wget -m ftp://anonymous:anonymous@10.10.10.98 #Donwload all
wget -m --no-passive ftp://anonymous:anonymous@10.10.10.98 #Download all
```
–ê–∫–æ –≤–∞—à –∫–æ—Ä–∏—Å–Ω–∏—á–∫–∏ –Ω–∞–ª–æ–≥/–ª–æ–∑–∏–Ω–∫–∞ –∏–º–∞ —Å–ø–µ—Ü–∏—ò–∞–ª–Ω–µ –∑–Ω–∞–∫–æ–≤–µ, [—Å–ª–µ–¥–µ—õ–∞ –∫–æ–º–∞–Ω–¥–∞](https://stackoverflow.com/a/113900/13647948) –º–æ–∂–µ –±–∏—Ç–∏ –∫–æ—Ä–∏—à—õ–µ–Ω–∞:
```bash
wget -r --user="USERNAME" --password="PASSWORD" ftp://server.com/
```
## Neki FTP komandi

* **`USER username`**
* **`PASS password`**
* **`HELP`** Server pokazuje koji su komandi podr≈æani
* \*\*`PORT 127,0,0,1,0,80`\*\*Ovo ƒáe oznaƒçiti FTP server da uspostavi vezu sa IP 127.0.0.1 na portu 80 (_morate staviti 5. karakter kao "0" i 6. kao port u decimalnom formatu ili koristiti 5. i 6. za izra≈æavanje porta u heksadecimalnom formatu_).
* \*\*`EPRT |2|127.0.0.1|80|`\*\*Ovo ƒáe oznaƒçiti FTP server da uspostavi TCP vezu (_oznaƒçeno sa "2"_) sa IP 127.0.0.1 na portu 80. Ova komanda **podr≈æava IPv6**.
* **`LIST`** Ovo ƒáe poslati listu fajlova u trenutnom folderu
* **`LIST -R`** Lista rekurzivno (ako je dozvoljeno od strane servera)
* **`APPE /path/something.txt`** Ovo ƒáe oznaƒçiti FTP da saƒçuva podatke primljene iz **pasivne** veze ili iz **PORT/EPRT** veze u fajl. Ako ime fajla postoji, podaci ƒáe se dodati.
* **`STOR /path/something.txt`** Kao `APPE` ali ƒáe prepisati fajlove
* **`STOU /path/something.txt`** Kao `APPE`, ali ako postoji, neƒáe uraditi ni≈°ta.
* **`RETR /path/to/file`** Mora se uspostaviti pasivna ili port veza. Tada ƒáe FTP server poslati oznaƒçeni fajl kroz tu vezu
* **`REST 6`** Ovo ƒáe oznaƒçiti server da sledeƒái put kada po≈°alje ne≈°to koristeƒái `RETR` treba da poƒçne od 6. bajta.
* **`TYPE i`** Postavi transfer na binarni
* **`PASV`** Ovo ƒáe otvoriti pasivnu vezu i oznaƒçiti korisnika gde mo≈æe da se pove≈æe
* **`PUT /tmp/file.txt`** Uƒçitaj oznaƒçeni fajl na FTP

![](<../../.gitbook/assets/image (386).png>)

## FTPBounce napad

Neki FTP serveri dozvoljavaju komandu PORT. Ova komanda se mo≈æe koristiti da oznaƒçi serveru da ≈æelite da se pove≈æete na drugi FTP server na nekom portu. Tada mo≈æete koristiti ovo da skenirate koji portovi na hostu su otvoreni preko FTP servera.

[**Saznajte ovde kako da zloupotrebite FTP server za skeniranje portova.**](ftp-bounce-attack.md)

Takoƒëe mo≈æete zloupotrebiti ovo pona≈°anje da naterate FTP server da komunicira sa drugim protokolima. Mo≈æete **uƒçitati fajl koji sadr≈æi HTTP zahtev** i naterati ranjivi FTP server da **po≈°alje na proizvoljni HTTP server** (_mo≈æda da dodate novog admin korisnika?_) ili ƒçak uƒçitati FTP zahtev i naterati ranjivi FTP server da preuzme fajl sa drugog FTP servera.\
Teorija je jednostavna:

1. **Uƒçitajte zahtev (unutar tekstualnog fajla) na ranjivi server.** Zapamtite da ako ≈æelite da komunicirate sa drugim HTTP ili FTP serverom morate promeniti linije sa `0x0d 0x0a`
2. **Koristite `REST X` da izbegnete slanje karaktera koje ne ≈æelite da po≈°aljete** (mo≈æda da biste uƒçitali zahtev unutar fajla morali ste da stavite neki zaglavlje slike na poƒçetku)
3. **Koristite `PORT` da se pove≈æete na proizvoljni server i uslugu**
4. **Koristite `RETR` da po≈°aljete saƒçuvani zahtev serveru.**

Veoma je verovatno da ƒáe ovo **izbaciti gre≈°ku kao** _**Socket not writable**_ **jer veza ne traje dovoljno dugo da po≈°alje podatke sa `RETR`**. Predlozi da poku≈°ate da izbegnete to su:

* Ako ≈°aljete HTTP zahtev, **stavite isti zahtev jedan za drugim** dok ne **\~0.5MB** barem. Ovako:

{% file src="../../.gitbook/assets/posts.txt" %}
posts.txt
{% endfile %}

* Poku≈°ajte da **napunite zahtev "junk" podacima vezanim za protokol** (govoreƒái o FTP-u mo≈æda samo junk komande ili ponavljajuƒái `RETR` instrukciju da dobijete fajl)
* Samo **napunite zahtev sa puno null karaktera ili drugih** (podeljenih na linije ili ne)

U svakom sluƒçaju, ovde imate [stari primer o tome kako zloupotrebiti ovo da naterate FTP server da preuzme fajl sa drugog FTP servera.](ftp-bounce-download-2oftp-file.md)

## Filezilla Server Ranjivost

**FileZilla** obiƒçno **vezuje** na **lokalno** **Administrativnu uslugu** za **FileZilla-Server** (port 14147). Ako mo≈æete da kreirate **tunel** sa **va≈°eg raƒçunara** da pristupite ovom portu, mo≈æete **povezati** na **njega** koristeƒái **praznu lozinku** i **kreirati** **novog korisnika** za FTP uslugu.

## Konfiguracione datoteke
```
ftpusers
ftp.conf
proftpd.conf
vsftpd.conf
```
### Post-Exploitation

Podrazumevana konfiguracija vsFTPd mo≈æe se naƒái u `/etc/vsftpd.conf`. Ovde mo≈æete pronaƒái neke opasne postavke:

* `anonymous_enable=YES`
* `anon_upload_enable=YES`
* `anon_mkdir_write_enable=YES`
* `anon_root=/home/username/ftp` - Direktorijum za anonimne korisnike.
* `chown_uploads=YES` - Promeni vlasni≈°tvo nad anonimno otpremljenim datotekama
* `chown_username=username` - Korisnik koji dobija vlasni≈°tvo nad anonimno otpremljenim datotekama
* `local_enable=YES` - Omoguƒái lokalnim korisnicima da se prijave
* `no_anon_password=YES` - Ne tra≈æi lozinku od anonimnih korisnika
* `write_enable=YES` - Dozvoli komande: STOR, DELE, RNFR, RNTO, MKD, RMD, APPE, i SITE

### Shodan

* `ftp`
* `port:21`


## HackTricks Automatic Commands
```
Protocol_Name: FTP    #Protocol Abbreviation if there is one.
Port_Number:  21     #Comma separated if there is more than one.
Protocol_Description: File Transfer Protocol          #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for FTP
Note: |
Anonymous Login
-bi     <<< so that your put is done via binary

wget --mirror 'ftp://ftp_user:UTDRSCH53c"$6hys@10.10.10.59'
^^to download all dirs and files

wget --no-passive-ftp --mirror 'ftp://anonymous:anonymous@10.10.10.98'
if PASV transfer is disabled

https://book.hacktricks.xyz/pentesting/pentesting-ftp

Entry_2:
Name: Banner Grab
Description: Grab FTP Banner via telnet
Command: telnet -n {IP} 21

Entry_3:
Name: Cert Grab
Description: Grab FTP Certificate if existing
Command: openssl s_client -connect {IP}:21 -starttls ftp

Entry_4:
Name: nmap ftp
Description: Anon login and bounce FTP checks are performed
Command: nmap --script ftp-* -p 21 {IP}

Entry_5:
Name: Browser Connection
Description: Connect with Browser
Note: ftp://anonymous:anonymous@{IP}

Entry_6:
Name: Hydra Brute Force
Description: Need Username
Command: hydra -t 1 -l {Username} -P {Big_Passwordlist} -vV {IP} ftp

Entry_7:
Name: consolesless mfs enumeration ftp
Description: FTP enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/ftp/anonymous; set RHOSTS {IP}; set RPORT 21; run; exit' && msfconsole -q -x 'use auxiliary/scanner/ftp/ftp_version; set RHOSTS {IP}; set RPORT 21; run; exit' && msfconsole -q -x 'use auxiliary/scanner/ftp/bison_ftp_traversal; set RHOSTS {IP}; set RPORT 21; run; exit' && msfconsole -q -x 'use auxiliary/scanner/ftp/colorado_ftp_traversal; set RHOSTS {IP}; set RPORT 21; run; exit' &&  msfconsole -q -x 'use auxiliary/scanner/ftp/titanftp_xcrc_traversal; set RHOSTS {IP}; set RPORT 21; run; exit'
```
{% hint style="success" %}
Uƒçite i ve≈æbajte AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Uƒçite i ve≈æbajte GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr≈æite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru≈æite se** üí¨ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
