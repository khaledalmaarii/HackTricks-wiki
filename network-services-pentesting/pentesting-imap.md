# 143,993 - Testowanie penetracyjne IMAP

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Znajd藕 najwa偶niejsze podatnoci, aby m贸c je szybko naprawi. Intruder ledzi powierzchni ataku, wykonuje proaktywne skanowanie zagro偶e, znajduje problemy w caym stosie technologicznym, od interfejs贸w API po aplikacje internetowe i systemy chmurowe. [**Wypr贸buj za darmo**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) ju偶 dzi.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Protok贸 dostpu do wiadomoci internetowych

**Protok贸 dostpu do wiadomoci internetowych (IMAP)** zosta zaprojektowany w celu umo偶liwienia u偶ytkownikom **dostpu do swoich wiadomoci e-mail z dowolnego miejsca**, g贸wnie za porednictwem poczenia internetowego. W zasadzie, wiadomoci e-mail s **przechowywane na serwerze**, a nie pobierane i przechowywane na urzdzeniu osobistym u偶ytkownika. Oznacza to, 偶e gdy wiadomo e-mail jest odczytywana lub przegldana, odbywa si to **bezporednio z serwera**. Ta funkcjonalno umo偶liwia wygodne sprawdzanie wiadomoci e-mail z **wielu urzdze**, zapewniajc, 偶e 偶adne wiadomoci nie zostan pominite, niezale偶nie od u偶ywanego urzdzenia.

Domylnie protok贸 IMAP dziaa na dw贸ch portach:

* **Port 143** - jest to domylny niezaszyfrowany port IMAP
* **Port 993** - jest to port, kt贸ry nale偶y u偶ywa, jeli chcesz poczy si z IMAP w spos贸b bezpieczny
```
PORT    STATE SERVICE REASON
143/tcp open  imap    syn-ack
```
## Pobieranie baneru

Banner grabbing to technika, kt贸ra polega na pobieraniu informacji o usudze IMAP z serwera docelowego. Pozwala to na identyfikacj wersji oprogramowania, kt贸ra jest u偶ywana, oraz innych szczeg贸贸w, kt贸re mog by przydatne podczas testowania penetracyjnego.

Aby przeprowadzi banner grabbing w usudze IMAP, mo偶na u偶y narzdzi takich jak `telnet` lub `nc`. Poni偶ej przedstawiono przykad u偶ycia `telnet`:

```plaintext
telnet <adres_serwera> 143
```

Po nawizaniu poczenia z serwerem IMAP, mo偶na wysa polecenie `CAPABILITY`, aby uzyska informacje o obsugiwanych funkcjach przez serwer. Przykad:

```plaintext
a001 CAPABILITY
```

Serwer odpowie list obsugiwanych funkcji, co mo偶e dostarczy cennych informacji dla testera penetracyjnego.

Banner grabbing jest przydatn technik, kt贸ra mo偶e pom贸c w identyfikacji potencjalnych podatnoci lub sabych punkt贸w w usudze IMAP.
```bash
nc -nv <IP> 143
openssl s_client -connect <IP>:993 -quiet
```
### NTLM Auth - Ujawnianie informacji

Jeli serwer obsuguje uwierzytelnianie NTLM (Windows), mo偶na uzyska wra偶liwe informacje (wersje):
```
root@kali: telnet example.com 143
* OK The Microsoft Exchange IMAP4 service is ready.
>> a1 AUTHENTICATE NTLM
+
>> TlRMTVNTUAABAAAAB4IIAAAAAAAAAAAAAAAAAAAAAAA=
+ TlRMTVNTUAACAAAACgAKADgAAAAFgooCBqqVKFrKPCMAAAAAAAAAAEgASABCAAAABgOAJQAAAA9JAEkAUwAwADEAAgAKAEkASQBTADAAMQABAAoASQBJAFMAMAAxAAQACgBJAEkAUwAwADEAAwAKAEkASQBTADAAMQAHAAgAHwMI0VPy1QEAAAAA
```
Lub **zautomatyzuj** to za pomoc wtyczki **nmap** `imap-ntlm-info.nse`

### [Brute Force IMAP](../generic-methodologies-and-resources/brute-force.md#imap)

## Skadnia


Przykady polece IMAP z [tutaj](https://donsutherland.org/crib/imap):
```
Login
A1 LOGIN username password
Values can be quoted to enclose spaces and special characters. A " must then be escape with a \
A1 LOGIN "username" "password"

List Folders/Mailboxes
A1 LIST "" *
A1 LIST INBOX *
A1 LIST "Archive" *

Create new Folder/Mailbox
A1 CREATE INBOX.Archive.2012
A1 CREATE "To Read"

Delete Folder/Mailbox
A1 DELETE INBOX.Archive.2012
A1 DELETE "To Read"

Rename Folder/Mailbox
A1 RENAME "INBOX.One" "INBOX.Two"

List Subscribed Mailboxes
A1 LSUB "" *

Status of Mailbox (There are more flags than the ones listed)
A1 STATUS INBOX (MESSAGES UNSEEN RECENT)

Select a mailbox
A1 SELECT INBOX

List messages
A1 FETCH 1:* (FLAGS)
A1 UID FETCH 1:* (FLAGS)

Retrieve Message Content
A1 FETCH 2 body[text]
A1 FETCH 2 all
A1 UID FETCH 102 (UID RFC822.SIZE BODY.PEEK[])

Close Mailbox
A1 CLOSE

Logout
A1 LOGOUT
```
### Ewolucja

IMAP (Internet Message Access Protocol) jest protokoem su偶cym do odbierania wiadomoci e-mail z serwera. Pierwsza wersja IMAP zostaa opublikowana w 1986 roku, a obecnie najpopularniejsz wersj jest IMAP4. Protok贸 ten ewoluowa wraz z rozwojem technologii i wprowadzaniem nowych funkcji. Poni偶ej przedstawiam kr贸tki przegld ewolucji IMAP:

- **IMAP2**: Wersja ta wprowadzia podstawowe funkcje, takie jak odbieranie i usuwanie wiadomoci e-mail z serwera. Bya to pierwsza wersja IMAP, kt贸ra umo偶liwiaa zarzdzanie wiadomociami bez koniecznoci pobierania ich na lokalny komputer.

- **IMAP2bis**: Ta wersja wprowadzia kilka ulepsze, takich jak mo偶liwo oznaczania wiadomoci jako przeczytanej lub nieprzeczytanej oraz mo偶liwo przenoszenia wiadomoci midzy folderami.

- **IMAP3**: Ta wersja wprowadzia obsug wielu folder贸w, co umo偶liwiao u偶ytkownikom organizowanie swoich wiadomoci w hierarchicznej strukturze folder贸w.

- **IMAP4**: Obecnie najpopularniejsza wersja IMAP, IMAP4, wprowadzia wiele nowych funkcji, takich jak mo偶liwo wyszukiwania wiadomoci, zarzdzania folderami, pobierania czci wiadomoci (np. tylko nag贸wka) oraz obsug rozszerze.

IMAP jest nadal u偶ywany jako jeden z g贸wnych protoko贸w do odbierania wiadomoci e-mail. Jego ewolucja umo偶liwia u偶ytkownikom bardziej zaawansowane zarzdzanie swoimi skrzynkami pocztowymi i dostp do wiadomoci z r贸偶nych urzdze.
```
apt install evolution
```
![](<../.gitbook/assets/image (528).png>)

### CURL

Podstawowa nawigacja jest mo偶liwa za pomoc [CURL](https://ec.haxx.se/usingcurl/usingcurl-reademail#imap), ale dokumentacja jest uboga w szczeg贸y, wic zaleca si sprawdzenie [藕r贸da](https://github.com/curl/curl/blob/master/lib/imap.c) dla precyzyjnych informacji.

1.  Wywietlanie skrzynek pocztowych (polecenie imap `LIST "" "*")
```bash
curl -k 'imaps://1.2.3.4/' --user user:pass
```
2.  Wywietlanie wiadomoci w skrzynce pocztowej (polecenie IMAP `SELECT INBOX`, a nastpnie `SEARCH ALL`)

```bash
curl -k 'imaps://1.2.3.4/INBOX?ALL' --user user:pass
```

The result of this search is a list of message indicies.

Its also possible to provide more complex search terms. e.g. searching for drafts with password in mail body:

```bash
curl -k 'imaps://1.2.3.4/Drafts?TEXT haso' --user u偶ytkownik:haso
```

A nice overview of the search terms possible is located [here](https://www.atmail.com/blog/imap-commands/).

3.  Downloading a message (imap command `SELECT Drafts` and then `FETCH 1 BODY[]`)

```bash
curl -k 'imaps://1.2.3.4/Drafts;MAILINDEX=1' --user user:pass
```

The mail index will be the same index returned from the search operation.

It is also possible to use `UID` (unique id) to access messages, however it is less conveniant as the search command needs to be manually formatted. E.g.

```bash
```bash
curl -k 'imaps://1.2.3.4/INBOX' -X 'UID SEARCH ALL' --user user:pass
curl -k 'imaps://1.2.3.4/INBOX;UID=1' --user user:pass
```

```bash
curl -k 'imaps://1.2.3.4/INBOX' -X 'UID SEARCH ALL' --user user:pass
curl -k 'imaps://1.2.3.4/INBOX;UID=1' --user user:pass
```

```bash
curl -k 'imaps://1.2.3.4/INBOX' -X 'UID SEARCH ALL' --user user:pass
curl -k 'imaps://1.2.3.4/INBOX;UID=1' --user user:pass
```
```

Also, possible to download just parts of a message, e.g. subject and sender of first 5 messages (the `-v` is required to see the subject and sender):

```bash
```bash
$ curl -k 'imaps://1.2.3.4/INBOX' -X 'FETCH 1:5 BODY[HEADER.FIELDS (SUBJECT FROM)]' --user user:pass -v 2>&1 | grep '^<'
```

Pobierz nag贸wki wiadomoci (SUBJECT FROM) z wiadomoci 1 do 5 z skrzynki odbiorczej na serwerze IMAP o adresie IP 1.2.3.4. U偶yj uwierzytelnienia u偶ytkownika i hasa. Wywietl tylko linie zaczynajce si od "<".
```

Although, its probably cleaner to just write a little for loop:

```bash
```bash
for m in {1..5}; do
echo $m
curl "imap://1.2.3.4/INBOX;MAILINDEX=$m;SECTION=HEADER.FIELDS%20(SUBJECT%20FROM)" --user user:pass
done
```

```bash
for m in {1..5}; do
echo $m
curl "imap://1.2.3.4/INBOX;MAILINDEX=$m;SECTION=HEADER.FIELDS%20(SUBJECT%20FROM)" --user user:pass
done
```

```bash
for m in {1..5}; do
echo $m
curl "imap://1.2.3.4/INBOX;MAILINDEX=$m;SECTION=HEADER.FIELDS%20(SUBJECT%20FROM)" --user user:pass
done
```

```bash
for m in {1..5}; do
echo $m
curl "imap://1.2.3.4/INBOX;MAILINDEX=$m;SECTION=HEADER.FIELDS%20(SUBJECT%20FROM)" --user user:pass
done
```

```bash
for m in {1..5}; do
echo $m
curl "imap://1.2.3.4/INBOX;MAILINDEX=$m;SECTION=HEADER.FIELDS%20(SUBJECT%20FROM)" --user user:pass
done
```
```

## Shodan

* `port:143 CAPABILITY`
* `port:993 CAPABILITY`

## HackTricks Automatic Commands

```
Nazwa_Protokou: IMAP    #Skr贸t Protokou jeli istnieje.
Numer_Portu:  143,993     #Oddzielone przecinkiem jeli jest wicej ni偶 jeden.
Opis_Protokou: Internet Message Access Protocol         #Opis Protokou zapisany pen nazw

Wpis_1:
Nazwa: Notatki
Opis: Notatki dotyczce WHOIS
Notatka: |
Internet Message Access Protocol (IMAP) zosta zaprojektowany w celu umo偶liwienia u偶ytkownikom dostpu do swoich wiadomoci e-mail z dowolnego miejsca, g贸wnie za porednictwem poczenia internetowego. W zasadzie, wiadomoci e-mail s przechowywane na serwerze, a nie pobierane i przechowywane na urzdzeniu osobistym u偶ytkownika. Oznacza to, 偶e gdy wiadomo e-mail jest odczytywana lub otwierana, odbywa si to bezporednio z serwera. Ta funkcjonalno umo偶liwia wygodne sprawdzanie wiadomoci e-mail z wielu urzdze, zapewniajc, 偶e 偶adne wiadomoci nie zostan pominite, niezale偶nie od u偶ywanego urzdzenia.

https://book.hacktricks.xyz/pentesting/pentesting-imap

Wpis_2:
Nazwa: Banner Grab
Opis: Banner Grab 143
Komenda: nc -nv {IP} 143

Wpis_3:
Nazwa: Bezpieczny Banner Grab
Opis: Banner Grab 993
Komenda: openssl s_client -connect {IP}:993 -quiet

Wpis_4:
Nazwa: Wyliczanie mfs bez konsoli
Opis: Wyliczanie IMAP bez koniecznoci uruchamiania msfconsole
Notatka: pobrane z https://github.com/carlospolop/legion
Komenda: msfconsole -q -x 'use auxiliary/scanner/imap/imap_version; set RHOSTS {IP}; set RPORT 143; run; exit'
```

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Find vulnerabilities that matter most so you can fix them faster. Intruder tracks your attack surface, runs proactive threat scans, finds issues across your whole tech stack, from APIs to web apps and cloud systems. [**Try it for free**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) today.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}


<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
