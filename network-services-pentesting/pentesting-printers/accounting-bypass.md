# **Introduction**

L'impression sans autorisation peut constituer un risque de sÃ©curitÃ© ou une violation de la politique de l'entreprise. Dans les environnements oÃ¹ les travaux d'impression sont facturÃ©s, un attaquant interne a une motivation pour contourner le systÃ¨me de comptabilitÃ©. De plus, Ãªtre capable d'imprimer est une condition prÃ©alable Ã  la plupart des attaques contre les imprimantes rÃ©seau.

Il existe deux approches majeures en ce qui concerne la comptabilitÃ© des travaux d'impression : soit **laisser l'imprimante le gÃ©rer directement, soit utiliser un serveur d'impression intermÃ©diaire**. La premiÃ¨re approche est spÃ©cifique au fournisseur, implique gÃ©nÃ©ralement une sorte de "pilote d'imprimante" spÃ©cial et n'est pas discutÃ©e ici. L'autre approche implique un serveur d'impression sÃ©parÃ© - gÃ©nÃ©ralement une implÃ©mentation logicielle comme [CUPS](https://en.wikipedia.org/wiki/CUPS) ou [LPRng](https://en.wikipedia.org/wiki/LPRng) - pour gÃ©rer la comptabilitÃ© et est assez courante dans les entreprises et les institutions. Le serveur d'impression peut parler LPD, IPP ou d'autres protocoles d'impression et transfÃ¨re les travaux Ã  l'imprimante rÃ©elle. **Il est important de noter que l'accÃ¨s rÃ©seau direct Ã  l'imprimante doit Ãªtre restreint**, sinon un attaquant peut **facilement contourner le serveur d'impression** et ses mÃ©canismes de comptabilitÃ©. Cela signifie filtrer l'accÃ¨s aux ports typiques et atypiques (LPD, IPP, brut, HTTP, SMB, FTP, SNMP).

Il existe essentiellement deux approches pour contourner les systÃ¨mes de comptabilitÃ© des travaux d'impression : soit **usurper l'identitÃ© d'un autre utilisateur, soit manipuler le compteur** de pages imprimÃ©es. Dans ce qui suit, les deux options sont discutÃ©es pour les installations LPRng (v3.8.B) et CUPS (v2.1.4) qui sont des systÃ¨mes d'impression open-source populaires utilisÃ©s dans les environnements acadÃ©miques et d'entreprise. Une comparaison des fonctionnalitÃ©s de sÃ©curitÃ© des deux systÃ¨mes est donnÃ©e ci-dessous.

| SystÃ¨me d'impression | Protocole | Chiffrement | Authentification | Compteur de pages |
| --------------- | -------- | ---------- | -------------- | ------------ |
| **LPRng**       | LPD      | SSL/TLS    | Kerberos, PGP  | matÃ©riel     |
| **CUPS**        | IPP      | SSL/TLS    | Kerberos, HTTP | logiciel     |

# Contournement de l'authentification

LPRng et CUPS offrent tous deux un chiffrement de canal basÃ© sur SSL et des schÃ©mas d'authentification sÃ©curisÃ©s tels que [Kerberos](https://en.wikipedia.org/wiki/Kerberos\_\(protocol\)), des travaux d'impression signÃ©s PGP ou une authentification HTTP [basique](https://en.wikipedia.org/wiki/Basic\_access\_authentication)/[digest](https://en.wikipedia.org/wiki/Digest\_access\_authentication). Si **configurÃ©s correctement** et si l'attaquant ne peut pas accÃ©der directement Ã  l'imprimante, elle ne pourra **pas usurper l'identitÃ© d'autres utilisateurs**. Cependant, ces fonctionnalitÃ©s de sÃ©curitÃ© sont **optionnelles et rarement appliquÃ©es** dans les serveurs d'impression du monde rÃ©el. Au lieu de cela, les **noms d'utilisateur donnÃ©s en tant que paramÃ¨tres LPD (LPRng) ou IPP (CUPS) sont enregistrÃ©s et comptabilisÃ©s** - ce qui peut Ãªtre dÃ©fini sur des valeurs arbitraires par le cÃ´tÃ© client. Les raisons de cela sont une considÃ©ration simple de coÃ»ts et avantages dans la plupart des institutions : Kerberos nÃ©cessite une configuration spÃ©ciale sur chaque client et l'authentification **HTTP** oblige les utilisateurs Ã  entrer un **mot de passe** chaque fois qu'ils veulent imprimer quelque chose, tandis que les coÃ»ts de quelques impressions non comptabilisÃ©es sont supportables.

Vous pouvez **vÃ©rifier l'authentification appropriÃ©e** en essayant d'imprimer avec un **nom d'utilisateur personnalisÃ©** comme ceci :
```
lp -U nobody test.ps
```
# Manipulation du compteur de pages

## Compteurs de pages matÃ©riels

Pour une comptabilitÃ© correcte, le **nombre de pages imprimÃ©es doit Ãªtre dÃ©terminÃ©** par le systÃ¨me d'impression, ce qui n'est pas une tÃ¢che facile. Les auteurs de **LPRng** _supposent que l'imprimante dispose d'un mÃ©canisme de compteur de pages non volatil fiable et insensible aux cycles de mise sous tension/hors tension_. Ces **compteurs de pages matÃ©riels** sont pris en charge par la plupart des imprimantes et **lus** par LPRng **en utilisant PJL aprÃ¨s** chaque **travail d'impression**. **HP** a mÃªme documentÃ© une fonctionnalitÃ© pour **Ã©crire** dans la variable de **compteur de pages** en mettant l'imprimante en mode service. De cette faÃ§on, le **compteur de pages** de l'_HP LaserJet 1200, HP LaserJet 4200N_ et _HP LaserJet 4250N_ **peut Ãªtre manipulÃ©** dans un travail d'impression. Ã€ la fin du document Ã  imprimer et sÃ©parÃ© par l'[UEL](./#uel), le compteur doit simplement Ãªtre rÃ©initialisÃ© Ã  sa valeur d'origine (par exemple, `2342`):
```
\x1b%-12345X@PJL JOB
This page was printed for free
\x1b%-12345X@PJL EOJ
\x1b%-12345X@PJL JOB
@PJL SET SERVICEMODE=HPBOISEID
@PJL SET PAGES=2342
\x1b%-12345X@PJL EOJ
```
Un attaquant pourrait dÃ©finir un nombre nÃ©gatif de pages imprimÃ©es. Notez que la rÃ©initialisation de l'appareil aux [paramÃ¨tres d'usine](factory-defaults.md) **rÃ©initialise Ã©galement le compteur de pages Ã  zÃ©ro sur certains** des appareils testÃ©s.\
La diminution du compteur de pages peut Ã©galement Ãªtre utilisÃ©e pour **vendre une imprimante Ã  un prix supÃ©rieur** car elle peut Ãªtre comparÃ©e Ã  l'odomÃ¨tre lors de l'achat d'une voiture d'occasion. Il convient cependant de souligner que **la rÃ©initialisation du compteur de pages n'est pas nÃ©cessairement Ã  des fins malveillantes** : il s'agit d'un modÃ¨le Ã©conomique bien connu consistant Ã  vendre de l'encre surÃ©valuÃ©e pour des dispositifs jet d'encre bon marchÃ© et Ã  bloquer les kits de recharge tiers en refusant d'imprimer aprÃ¨s un certain nombre de pages - pour gÃ©rer de telles pratiques non Ã©thiques, il est tout Ã  fait lÃ©gitime de rÃ©initialiser le compteur de pages.

Sur les anciennes imprimantes laser HP, la commande `pagecount` de [PRET](https://github.com/RUB-NDS/PRET) peut Ãªtre utilisÃ©e pour dÃ©finir facilement des compteurs de pages matÃ©riels :
```
./pret.py -q printer pjl
Connection to printer established

Welcome to the pret shell. Type help or ? to list commands.
printer:/> pagecount 10
Old pagecounter: 53214
New pagecounter: 10
```
## Compteurs de pages logiciels

**CUPS** utilise des **compteurs de pages logiciels** qui ont Ã©tÃ© implÃ©mentÃ©s pour tous les langages de description de pages majeurs. Pour PostScript, une faÃ§on facile de contourner la comptabilitÃ© est de vÃ©rifier si le paramÃ¨tre systÃ¨me PageCount existe - ce qui renverra faux lorsqu'il est interprÃ©tÃ© dans CUPS/Ghostscript - avant d'imprimer rÃ©ellement le document comme indiquÃ© ci-dessous.
```
currentsystemparams (PageCount) known {
  <@\textit{[...] code which is only executed on a printer device [...]}@>
} if
```
De cette maniÃ¨re, le logiciel de comptabilitÃ© utilisÃ© par CUPS rend un document diffÃ©rent de celui de l'imprimante. **CUPS ne tient compte que d'une seule page** - qui semble Ãªtre un **minimum codÃ© en dur** - alors que le **vrai** travail d'impression peut contenir **des centaines de pages**. Notez que l'utilisation de la file d'attente/option IPP "brute" est obligatoire, sinon CUPS analyse le code avec un filtre PostScript-to-PostScript (ps2write de Ghostscript) avant qu'il n'atteigne le compteur de pages.

**Comment tester cette attaque ?**

**Enveloppez** un **document PostScript multi-pages arbitraire** dans le **code ci-dessus** et imprimez-le. Ensuite, allez sur [`http://printserver:631/jobs?which_jobs=all`](http://printserver:631/jobs?which\_jobs=all) et vÃ©rifiez le compteur de pages de CUPS pour ce travail d'impression. Notez que vous devez Ã©tablir une file d'attente brute. C'est-Ã -dire une file d'attente oÃ¹ le systÃ¨me de filtrage n'est pas impliquÃ© et le travail d'impression va directement Ã  une imprimante. Pour CUPS, cela se fait en dÃ©finissant le type de contenu sur `application/vnd.cups-raw`. Si votre systÃ¨me est dÃ©jÃ  configurÃ© pour utiliser le serveur d'impression Ã  tester, utilisez simplement :
```
lp -o raw test.ps
```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- Travaillez-vous dans une entreprise de **cybersÃ©curitÃ©** ? Voulez-vous voir votre **entreprise annoncÃ©e dans HackTricks** ? ou voulez-vous avoir accÃ¨s Ã  la **derniÃ¨re version de PEASS ou tÃ©lÃ©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !

- DÃ©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)

- **Rejoignez le** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) **groupe Discord** ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Partagez vos astuces de piratage en soumettant des PR au [repo hacktricks](https://github.com/carlospolop/hacktricks) et au [repo hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
