<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- Travaillez-vous dans une **entreprise de cybersÃ©curitÃ©** ? Voulez-vous voir votre **entreprise annoncÃ©e dans HackTricks** ? ou voulez-vous avoir accÃ¨s Ã  la **derniÃ¨re version de PEASS ou tÃ©lÃ©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !

- DÃ©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)

- **Rejoignez le** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Partagez vos astuces de piratage en soumettant des PR au [repo hacktricks](https://github.com/carlospolop/hacktricks) et au [repo hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>


Vous pouvez faire envoyer une requÃªte HTTP POST Ã  plusieurs adresses IP pour essayer d'atteindre un port d'impression brute ouvert. Si trouvÃ©, l'en-tÃªte HTTP est soit imprimÃ© en texte brut, soit ignorÃ© en fonction des paramÃ¨tres de l'imprimante. Les donnÃ©es POST peuvent cependant contenir des travaux d'impression arbitraires tels que des commandes PostScript ou PJL Ã  interprÃ©ter.

### Impression croisÃ©e amÃ©liorÃ©e

Vous pouvez utiliser des objets JavaScript XMLHttpRequest (XHR) tels que dÃ©finis dans pour effectuer des requÃªtes HTTP POST vers des imprimantes internes. Une limitation de l'approche d'impression croisÃ©e discutÃ©e jusqu'Ã  prÃ©sent est que les donnÃ©es ne peuvent Ãªtre envoyÃ©es qu'au pÃ©riphÃ©rique, pas reÃ§ues en raison de la politique de mÃªme origine. Pour contourner les restrictions de la politique de mÃªme origine, vous pouvez faire en sorte que le serveur rÃ©ponde avec une fausse mais une rÃ©ponse HTTP valide permettant les demandes CORS (y compris `Access-Control-Allow-Origin=*`). Un aperÃ§u schÃ©matique de l'attaque est donnÃ© ci-dessous :

![Impression croisÃ©e avancÃ©e avec spoofing CORS](http://hacking-printers.net/wiki/images/thumb/c/ce/Cross-site-printing.png/900px-Cross-site-printing.png)

Dans une variante amÃ©liorÃ©e de XSP - combinÃ©e Ã  un spoofing CORS - un attaquant web a un accÃ¨s complet Ã  la rÃ©ponse HTTP, ce qui lui permet d'extraire des informations arbitraires telles que des travaux d'impression capturÃ©s Ã  partir du pÃ©riphÃ©rique d'impression. Un extrait de code JavaScript de preuve de concept est prÃ©sentÃ© ci-dessous :
```javascript
job = "\x1B%-12345X\r\n"
    + "%!\r\n"
    + "(HTTP/1.0 200 OK\\n) print\r\n"
    + "(Server: PostScript HTTPD\\n) print\r\n"
    + "(Access-Control-Allow-Origin: *\\n) print\r\n"
    + "(Connection: close\\n) print\r\n"
    + "(Content-Length: ) print\r\n"
    + "product dup length dup string cvs print\r\n"
    + "(\\n\\n) print\r\n"
    + "print\r\n"
    + "(\\n) print flush\r\n"
    + "\x1B%-12345X\r\n";

var x = new XMLHttpRequest();
x.open("POST", "http://printer:9100");
x.send(job);
x.onreadystatechange = function() {
  if (x.readyState == 4)
    alert(x.responseText);
};
```
### Limitations de l'impression inter-sites

Notez que **PCL** en tant que langage de description de page n'est **pas applicable pour le spoofing CORS** car il ne permet qu'un **seul nombre** Ã  Ãªtre **Ã©choÃ©**. **PJL ne peut pas** Ãªtre utilisÃ© car malheureusement il ajoute `@PJL ECHO` Ã  toutes les chaÃ®nes Ã©choÃ©es, ce qui rend impossible de simuler un en-tÃªte HTTP valide. Cela ne signifie cependant **pas** que les attaques XSP amÃ©liorÃ©es sont **limitÃ©es** aux travaux PostScript : PostScript peut Ãªtre utilisÃ© pour rÃ©pondre avec un en-tÃªte HTTP spoofÃ© et **l'** [**UEL** ](./#uel)**peut Ãªtre invoquÃ© pour changer la langue de l'imprimante**. De cette faÃ§on, un attaquant web peut Ã©galement obtenir les rÃ©sultats pour les commandes PJL. Deux piÃ¨ges d'implÃ©mentation existent et mÃ©ritent d'Ãªtre mentionnÃ©s : premiÃ¨rement, une `Content-Length` correcte pour les donnÃ©es Ã  rÃ©pondre doit Ãªtre dÃ©terminÃ©e avec PostScript. Si l'attaquant ne peut pas prÃ©dire la taille globale de la rÃ©ponse et que le codage par tronÃ§ons n'est pas une option, elle doit dÃ©finir une valeur trÃ¨s Ã©levÃ©e et utiliser un rembourrage. DeuxiÃ¨mement, l'ajout du champ d'en-tÃªte `Connection: close` est important, sinon les connexions HTTP/1.1 sont maintenues actives jusqu'Ã  ce que le client web ou le pÃ©riphÃ©rique d'impression dÃ©clenche une temporisation, ce qui signifie que l'imprimante ne sera pas accessible pendant un certain temps.

**Si** le pÃ©riphÃ©rique d'impression prend en charge l'**impression de texte brut**, l'en-tÃªte de la **requÃªte HTTP** de la XHR est imprimÃ© en dur - y compris le champ d'en-tÃªte `Origin` contenant l'URL qui a invoquÃ© le JavaScript malveillant, rendant ainsi difficile pour un attaquant de **rester silencieux**. Cela est inÃ©vitable, car nous ne prenons pas le contrÃ´le de l'imprimante - et dans certaines circonstances, nous pouvons dÃ©sactiver la fonctionnalitÃ© d'impression - jusqu'Ã  ce que le corps HTTP soit traitÃ© et que l'en-tÃªte HTTP ait dÃ©jÃ  Ã©tÃ© interprÃ©tÃ© en texte brut par le pÃ©riphÃ©rique d'impression. Si la rÃ©duction du bruit est une prioritÃ©, l'attaquant peut cependant **essayer de dÃ©sactiver d'abord la fonctionnalitÃ© d'impression** avec des commandes PJL propriÃ©taires comme proposÃ© dans [PJL jobmedia](http://hacking-printers.net/wiki/index.php/Document_processing#PJL_jobmedia) en utilisant d'autres canaux XSP potentiels comme IPP, LPD, FTP ou le serveur web intÃ©grÃ© de l'imprimante. Bien que tous les protocoles aient pu Ãªtre testÃ©s avec succÃ¨s pour dÃ©ployer des travaux d'impression en utilisant des variantes de scripting inter-protocoles, ils ont certains inconvÃ©nients au-delÃ  de ne pas fournir de commentaires en utilisant des en-tÃªtes CORS spoofÃ©s :

* L'accÃ¨s inter-protocole aux ports LPD et FTP est bloquÃ© par divers navigateurs web
* Les paramÃ¨tres pour l'impression directe sur le serveur web intÃ©grÃ© sont spÃ©cifiques au modÃ¨le
* La norme IPP exige que le `Content-type` pour les demandes HTTP POST soit dÃ©fini sur `application/ipp`, ce qui ne peut pas Ãªtre fait avec des objets XHR - il appartient cependant Ã  l'implÃ©mentation de se soucier rÃ©ellement des types incorrects

Une comparaison des canaux d'impression inter-sites est donnÃ©e ci-dessous :

| Canal | Port | Pas de commentaires | Impression non sollicitÃ©e | NormalisÃ© | BloquÃ© par |
| ----- | ---- | ----------------- | ------------------------ | --------- | ---------- |
| Brut  | 9100 | -                 | âœ”                        | âœ”         | -          |
| Web   | 80   | âœ”                 | -                        | -         | -          |
| IPP   | 631  | âœ”                 | -                        | âœ”         | -          |
| LPD   | 515  | âœ”                 | -                        | âœ”         | FF, Ch, Op |
| FTP   | 21   | âœ”                 | -                        | âœ”         | FF, Ch, Op, IE |

Un problÃ¨me majeur de XSP est de **trouver** l'**adresse** ou le nom d'hÃ´te **correct** de l'**imprimante**. Notre approche consiste Ã  **abuser de WebRTC** qui est implÃ©mentÃ© dans la plupart des navigateurs modernes et qui a la fonctionnalitÃ© d'Ã©numÃ©rer les adresses IP pour les interfaces de rÃ©seau local. Ã‰tant donnÃ© l'adresse IP locale, des objets XHR sont ensuite utilisÃ©s pour ouvrir des connexions au port **9100/tcp** pour les 253 adresses restantes afin de rÃ©cupÃ©rer le nom du produit de l'imprimante en utilisant PostScript et le spoofing CORS, ce qui ne prend que quelques secondes dans nos tests. Si l'imprimante est sur le mÃªme sous-rÃ©seau que l'hÃ´te de la victime, son adresse peut Ãªtre dÃ©tectÃ©e uniquement Ã  l'aide de JavaScript. WebRTC est en dÃ©veloppement pour Safari et est pris en charge par les versions actuelles de Firefox, Chrome et Microsoft Edge. Internet Explorer n'a pas de support WebRTC, mais VBScript et Java peuvent Ã©galement Ãªtre utilisÃ©s pour divulguer l'adresse IP locale. Si l'adresse de l'interface locale ne peut pas Ãªtre rÃ©cupÃ©rÃ©e, nous appliquons une approche de force brute intelligente : nous essayons de nous connecter au port 80 du routeur de la victime en utilisant des objets XHR. Pour cela, une liste de 115 adresses de routeur par dÃ©faut provenant de diverses ressources accessibles sur Internet a Ã©tÃ© compilÃ©e. Si un routeur est accessible, nous balayons le sous-rÃ©seau pour trouver des imprimantes comme dÃ©crit prÃ©cÃ©demment.

## Preuve de concept

Une implÃ©mentation de preuve de concept dÃ©montrant que les attaques avancÃ©es d'impression inter-sites sont pratiques et constituent une menace rÃ©elle pour les entreprises et les institutions est disponible sur [hacking-printers.net/xsp/](http://hacking-printers.net/xsp/)


<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- Travaillez-vous dans une **entreprise de cybersÃ©curitÃ©** ? Voulez-vous voir votre **entreprise annoncÃ©e dans HackTricks** ? ou voulez-vous avoir accÃ¨s Ã  la **derniÃ¨re version de PEASS ou tÃ©lÃ©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !

- DÃ©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)

- **Rejoignez le** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Partagez vos astuces de piratage en soumettant des PR au repo [hacktricks](https://github.com/carlospolop/hacktricks) et [hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
