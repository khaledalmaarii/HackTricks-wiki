# SMTP Smuggling

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Informa√ß√µes B√°sicas

Esse tipo de vulnerabilidade foi [**originalmente descoberto neste post**](https://sec-consult.com/blog/detail/smtp-smuggling-spoofing-e-mails-worldwide/) onde √© explicado que √© poss√≠vel **explorar discrep√¢ncias em como o protocolo SMTP √© interpretado** ao finalizar um e-mail, permitindo que um atacante contrabandeie mais e-mails no corpo do e-mail leg√≠timo, permitindo se passar por outros usu√°rios do dom√≠nio afetado (como admin@outlook.com) contornando defesas como SPF.

### Por que

Isso ocorre porque no protocolo SMTP, os **dados da mensagem** a ser enviada no e-mail s√£o controlados por um usu√°rio (atacante) que pode enviar dados especialmente elaborados abusando das diferen√ßas nos analisadores que contrabandeiam e-mails extras no receptor. Veja este exemplo ilustrado do post original:

<figure><img src="../../.gitbook/assets/image (8) (1).png" alt=""><figcaption><p><a href="https://sec-consult.com/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-Overview__09_.png">https://sec-consult.com/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-Overview__09_.png</a></p></figcaption></figure>

### Como

Para explorar essa vulnerabilidade, um atacante precisa enviar alguns dados que o **servidor SMTP de sa√≠da pensa que √© apenas 1 e-mail, mas o servidor SMTP de entrada pensa que h√° v√°rios e-mails**.

Os pesquisadores descobriram que diferentes **servidores de entrada consideram diferentes caracteres como o fim dos dados** da mensagem de e-mail que os servidores de sa√≠da n√£o consideram.\
Por exemplo, um fim regular dos dados √© `\r\n.\r`. Mas se o servidor SMTP de entrada tamb√©m suporta `\n.`, um atacante poderia simplesmente adicionar **esses dados em seu e-mail e come√ßar a indicar os comandos SMTP** de novos e-mails para contrabande√°-los, assim como na imagem anterior.

Claro, isso s√≥ funcionaria se o **servidor SMTP de sa√≠da n√£o tratar esses dados** como o fim dos dados da mensagem, porque nesse caso ele ver√° 2 e-mails em vez de apenas 1, ent√£o, no final, essa √© a desincroniza√ß√£o que est√° sendo abusada nessa vulnerabilidade.

Dados de desincroniza√ß√£o potenciais:

* `\n.`
* `\n.\r`

Al√©m disso, note que o SPF √© contornado porque se voc√™ contrabandear um e-mail de `admin@outlook.com` de um e-mail de `user@outlook.com`, **o remetente ainda √© `outlook.com`.**

## **Refer√™ncias**

* [https://sec-consult.com/blog/detail/smtp-smuggling-spoofing-e-mails-worldwide/](https://sec-consult.com/blog/detail/smtp-smuggling-spoofing-e-mails-worldwide/)

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
