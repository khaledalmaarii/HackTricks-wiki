# SMTP Smuggling

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si sztuczkami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}

## Podstawowe informacje

Ten typ podatnoci zosta [**pierwotnie odkryty w tym pocie**](https://sec-consult.com/blog/detail/smtp-smuggling-spoofing-e-mails-worldwide/), w kt贸rym wyjaniono, 偶e mo偶liwe jest **wykorzystanie r贸偶nic w interpretacji protokou SMTP** podczas finalizowania e-maila, co pozwala atakujcemu na przemycenie dodatkowych e-maili w treci legalnego, co umo偶liwia podszywanie si pod innych u偶ytkownik贸w dotknitej domeny (takich jak admin@outlook.com), omijajc zabezpieczenia takie jak SPF.

### Dlaczego

Dzieje si tak, poniewa偶 w protokole SMTP **dane wiadomoci** do wysania w e-mailu s kontrolowane przez u偶ytkownika (atakujcego), kt贸ry mo偶e wysa specjalnie przygotowane dane, wykorzystujc r贸偶nice w parserach, kt贸re przemyc dodatkowe e-maile do odbiorcy. Zobacz ten ilustrowany przykad z oryginalnego posta:

<figure><img src="../../.gitbook/assets/image (8) (1).png" alt=""><figcaption><p><a href="https://sec-consult.com/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-Overview__09_.png">https://sec-consult.com/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-Overview__09_.png</a></p></figcaption></figure>

### Jak

Aby wykorzysta t podatno, atakujcy musi wysa dane, kt贸re **serwer SMTP wychodzcy myli, 偶e to tylko 1 e-mail, ale serwer SMTP przychodzcy myli, 偶e jest kilka e-maili**.

Badacze odkryli, 偶e r贸偶ne **serwery przychodzce traktuj r贸偶ne znaki jako koniec danych** wiadomoci e-mail, kt贸rych serwery wychodzce nie traktuj.\
Na przykad, regularnym kocem danych jest `\r\n.\r`. Ale jeli serwer SMTP przychodzcy obsuguje r贸wnie偶 `\n.`, atakujcy mo偶e po prostu doda **te dane w swoim e-mailu i zacz wskazywa polecenia SMTP** nowych e-maili, aby je przemyci, tak jak na poprzednim obrazku.

Oczywicie, to mo偶e dziaa tylko wtedy, gdy **serwer SMTP wychodzcy nie traktuje r贸wnie偶 tych danych** jako koca danych wiadomoci, poniewa偶 w takim przypadku zobaczy 2 e-maile zamiast tylko 1, wic na kocu to jest desynchronizacja, kt贸ra jest wykorzystywana w tej podatnoci.

Potencjalne dane desynchronizacji:

* `\n.`
* `\n.\r`

Zauwa偶 r贸wnie偶, 偶e SPF jest omijany, poniewa偶 jeli przemycisz e-mail z `admin@outlook.com` z e-maila z `user@outlook.com`, **nadawca nadal jest `outlook.com`.**

## **Referencje**

* [https://sec-consult.com/blog/detail/smtp-smuggling-spoofing-e-mails-worldwide/](https://sec-consult.com/blog/detail/smtp-smuggling-spoofing-e-mails-worldwide/)

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si sztuczkami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
