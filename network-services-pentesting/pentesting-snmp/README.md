# 161,162,10161,10162/udp - Pentesting SNMP

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Se voc√™ est√° interessado em **carreira de hacking** e hackear o inhacke√°vel - **estamos contratando!** (_flu√™ncia em polon√™s escrita e falada √© necess√°ria_).

{% embed url="https://www.stmcyber.com/careers" %}

## Informa√ß√µes B√°sicas

**SNMP - Simple Network Management Protocol** √© um protocolo usado para monitorar diferentes dispositivos na rede (como roteadores, switches, impressoras, IoTs...).
```
PORT    STATE SERVICE REASON                 VERSION
161/udp open  snmp    udp-response ttl 244   ciscoSystems SNMPv3 server (public)
```
{% hint style="info" %}
O SNMP tamb√©m usa a porta **162/UDP** para **traps**. Estes s√£o pacotes de dados **enviados do servidor SNMP para o cliente sem serem explicitamente solicitados**.
{% endhint %}

### MIB

Para garantir que o acesso SNMP funcione entre fabricantes e com diferentes combina√ß√µes cliente-servidor, a **Management Information Base (MIB)** foi criada. MIB √© um **formato independente para armazenar informa√ß√µes de dispositivos**. Um MIB √© um **arquivo de texto** no qual todos os **objetos SNMP** consult√°veis de um dispositivo est√£o listados em uma hierarquia de √°rvore **padronizada**. Ele cont√©m pelo menos um **`Object Identifier` (`OID`)**, que, al√©m do **endere√ßo √∫nico** necess√°rio e um **nome**, tamb√©m fornece informa√ß√µes sobre o tipo, direitos de acesso e uma descri√ß√£o do respectivo objeto.\
Os arquivos MIB s√£o escritos no formato de texto ASCII baseado em `Abstract Syntax Notation One` (`ASN.1`). Os **MIBs n√£o cont√™m dados**, mas explicam **onde encontrar quais informa√ß√µes** e como elas se parecem, quais valores retornam para o OID espec√≠fico ou qual tipo de dado √© utilizado.

### OIDs

**Object Identifiers (OIDs)** desempenham um papel crucial. Esses identificadores √∫nicos s√£o projetados para gerenciar objetos dentro de uma **Management Information Base (MIB)**.

Os n√≠veis mais altos dos IDs de objetos MIB, ou OIDs, s√£o alocados a diversas organiza√ß√µes de padroniza√ß√£o. √â dentro desses n√≠veis superiores que a estrutura para pr√°ticas e padr√µes de gerenciamento global √© estabelecida.

Al√©m disso, os fornecedores t√™m a liberdade de estabelecer ramifica√ß√µes privadas. Dentro dessas ramifica√ß√µes, eles t√™m a **autonomia para incluir objetos gerenciados pertinentes √†s suas pr√≥prias linhas de produtos**. Este sistema garante que haja um m√©todo estruturado e organizado para identificar e gerenciar uma ampla gama de objetos entre diferentes fornecedores e padr√µes.

![](<../../.gitbook/assets/SNMP\_OID\_MIB\_Tree (1).png>)

Voc√™ pode **navegar** por uma **√°rvore OID** na web aqui: [http://www.oid-info.com/cgi-bin/display?tree=#focus](http://www.oid-info.com/cgi-bin/display?tree=#focus) ou **ver o que um OID significa** (como `1.3.6.1.2.1.1`) acessando [http://oid-info.com/get/1.3.6.1.2.1.1](http://oid-info.com/get/1.3.6.1.2.1.1).\
Existem alguns **OIDs bem conhecidos** como os que est√£o dentro de [1.3.6.1.2.1](http://oid-info.com/get/1.3.6.1.2.1) que referenciam vari√°veis do Simple Network Management Protocol (SNMP) definidas no MIB-2. E a partir dos **OIDs pendentes deste** voc√™ pode obter alguns dados interessantes do host (dados do sistema, dados da rede, dados de processos...)

### **Exemplo de OID**

[**Exemplo daqui**](https://www.netadmintools.com/snmp-mib-and-oids/):

**`1 . 3 . 6 . 1 . 4 . 1 . 1452 . 1 . 2 . 5 . 1 . 3. 21 . 1 . 4 . 7`**

Aqui est√° uma an√°lise deste endere√ßo.

* 1 ‚Äì isso √© chamado de ISO e estabelece que este √© um OID. √â por isso que todos os OIDs come√ßam com ‚Äú1‚Äù
* 3 ‚Äì isso √© chamado de ORG e √© usado para especificar a organiza√ß√£o que construiu o dispositivo.
* 6 ‚Äì isso √© o dod ou o Departamento de Defesa, que √© a organiza√ß√£o que estabeleceu a Internet primeiro.
* 1 ‚Äì este √© o valor da internet para denotar que todas as comunica√ß√µes ocorrer√£o atrav√©s da Internet.
* 4 ‚Äì este valor determina que este dispositivo √© feito por uma organiza√ß√£o privada e n√£o por uma governamental.
* 1 ‚Äì este valor denota que o dispositivo √© feito por uma empresa ou entidade comercial.

Esses primeiros seis valores tendem a ser os mesmos para todos os dispositivos e fornecem as informa√ß√µes b√°sicas sobre eles. Esta sequ√™ncia de n√∫meros ser√° a mesma para todos os OIDs, exceto quando o dispositivo √© feito pelo governo.

Passando para o pr√≥ximo conjunto de n√∫meros.

* 1452 ‚Äì d√° o nome da organiza√ß√£o que fabricou este dispositivo.
* 1 ‚Äì explica o tipo de dispositivo. Neste caso, √© um despertador.
* 2 ‚Äì determina que este dispositivo √© uma unidade terminal remota.

O restante dos valores fornece informa√ß√µes espec√≠ficas sobre o dispositivo.

* 5 ‚Äì denota um ponto de alarme discreto.
* 1 ‚Äì ponto espec√≠fico no dispositivo
* 3 ‚Äì porta
* 21 ‚Äì endere√ßo da porta
* 1 ‚Äì exibi√ß√£o para a porta
* 4 ‚Äì n√∫mero do ponto
* 7 ‚Äì estado do ponto

### Vers√µes SNMP

Existem 2 vers√µes importantes do SNMP:

* **SNMPv1**: Principal, ainda √© a mais frequente, a **autentica√ß√£o √© baseada em uma string** (community string) que viaja em **texto simples** (todas as informa√ß√µes viajam em texto simples). **Vers√£o 2 e 2c** tamb√©m enviam o **tr√°fego em texto simples** e usam uma **community string como autentica√ß√£o**.
* **SNMPv3**: Usa uma forma de **autentica√ß√£o** melhor e as informa√ß√µes viajam **criptografadas** (um **ataque de dicion√°rio** poderia ser realizado, mas seria muito mais dif√≠cil encontrar as credenciais corretas do que no SNMPv1 e v2).

### Community Strings

Como mencionado anteriormente, **para acessar as informa√ß√µes salvas no MIB voc√™ precisa conhecer a community string nas vers√µes 1 e 2/2c e as credenciais na vers√£o 3.**\
Existem **2 tipos de community strings**:

* **`public`** principalmente fun√ß√µes **somente leitura**
* **`private`** **Leitura/Grava√ß√£o** em geral

Note que **a capacidade de grava√ß√£o de um OID depende da community string utilizada**, ent√£o **mesmo** que voc√™ descubra que "**public**" est√° sendo usado, voc√™ pode ser capaz de **gravar alguns valores.** Al√©m disso, podem **existir** objetos que s√£o **sempre "Somente Leitura".**\
Se voc√™ tentar **gravar** um objeto, um erro **`noSuchName` ou `readOnly`** √© recebido\*\*.\*\*

Nas vers√µes 1 e 2/2c, se voc√™ usar uma **bad** community string, o servidor n√£o **responder√°**. Portanto, se ele responder, uma **community string v√°lida foi usada**.

## Portas

[Do Wikipedia](https://en.wikipedia.org/wiki/Simple\_Network\_Management\_Protocol):

* O agente SNMP recebe solicita√ß√µes na porta UDP **161**.
* O gerente recebe notifica√ß√µes ([Traps](https://en.wikipedia.org/wiki/Simple\_Network\_Management\_Protocol#Trap) e [InformRequests](https://en.wikipedia.org/wiki/Simple\_Network\_Management\_Protocol#InformRequest)) na porta **162**.
* Quando usado com [Transport Layer Security](https://en.wikipedia.org/wiki/Transport\_Layer\_Security) ou [Datagram Transport Layer Security](https://en.wikipedia.org/wiki/Datagram\_Transport\_Layer\_Security), as solicita√ß√µes s√£o recebidas na porta **10161** e as notifica√ß√µes s√£o enviadas para a porta **10162**.

## Brute-Force Community String (v1 e v2c)

Para **adivinhar a community string** voc√™ poderia realizar um ataque de dicion√°rio. Confira [aqui diferentes maneiras de realizar um ataque de for√ßa bruta contra SNMP](../../generic-methodologies-and-resources/brute-force.md#snmp). Uma community string frequentemente usada √© `public`.

## Enumerando SNMP

√â recomendado instalar o seguinte para ver o que significa **cada OID coletado** do dispositivo:
```bash
apt-get install snmp-mibs-downloader
download-mibs
# Finally comment the line saying "mibs :" in /etc/snmp/snmp.conf
sudo vi /etc/snmp/snmp.conf
```
Se voc√™ souber uma string de comunidade v√°lida, pode acessar os dados usando **SNMPWalk** ou **SNMP-Check**:
```bash
snmpbulkwalk -c [COMM_STRING] -v [VERSION] [IP] . #Don't forget the final dot
snmpbulkwalk -c public -v2c 10.10.11.136 .

snmpwalk -v [VERSION_SNMP] -c [COMM_STRING] [DIR_IP]
snmpwalk -v [VERSION_SNMP] -c [COMM_STRING] [DIR_IP] 1.3.6.1.2.1.4.34.1.3 #Get IPv6, needed dec2hex
snmpwalk -v [VERSION_SNMP] -c [COMM_STRING] [DIR_IP] NET-SNMP-EXTEND-MIB::nsExtendObjects #get extended
snmpwalk -v [VERSION_SNMP] -c [COMM_STRING] [DIR_IP] .1 #Enum all

snmp-check [DIR_IP] -p [PORT] -c [COMM_STRING]

nmap --script "snmp* and not snmp-brute" <target>

braa <community string>@<IP>:.1.3.6.* #Bruteforce specific OID
```
Gra√ßas √†s consultas estendidas (download-mibs), √© poss√≠vel enumerar ainda mais sobre o sistema com o seguinte comando :
```bash
snmpwalk -v X -c public <IP> NET-SNMP-EXTEND-MIB::nsExtendOutputFull
```
**SNMP** tem muitas informa√ß√µes sobre o host e coisas que voc√™ pode achar interessantes s√£o: **Interfaces de rede** (endere√ßo **IPv4** e **IPv6**), Nomes de usu√°rio, Tempo de atividade, Vers√£o do servidor/SO e **processos**

**em execu√ß√£o** (pode conter senhas)....

### **Configura√ß√µes Perigosas**

No √¢mbito da gest√£o de rede, certas configura√ß√µes e par√¢metros s√£o fundamentais para garantir monitoramento e controle abrangentes.

### Configura√ß√µes de Acesso

Duas configura√ß√µes principais permitem acesso √† **√°rvore OID completa**, que √© um componente crucial na gest√£o de rede:

1. **`rwuser noauth`** √© configurado para permitir acesso total √† √°rvore OID sem a necessidade de autentica√ß√£o. Esta configura√ß√£o √© direta e permite acesso irrestrito.
2. Para um controle mais espec√≠fico, o acesso pode ser concedido usando:
* **`rwcommunity`** para endere√ßos **IPv4**, e
* **`rwcommunity6`** para endere√ßos **IPv6**.

Ambos os comandos requerem uma **string de comunidade** e o endere√ßo IP relevante, oferecendo acesso total independentemente da origem da solicita√ß√£o.

### Par√¢metros SNMP para Microsoft Windows

Uma s√©rie de **valores de Base de Informa√ß√£o de Gerenciamento (MIB)** s√£o utilizados para monitorar v√°rios aspectos de um sistema Windows atrav√©s do SNMP:

* **Processos do Sistema**: Acessado via `1.3.6.1.2.1.25.1.6.0`, este par√¢metro permite o monitoramento de processos ativos dentro do sistema.
* **Programas em Execu√ß√£o**: O valor `1.3.6.1.2.1.25.4.2.1.2` √© designado para rastrear programas atualmente em execu√ß√£o.
* **Caminho dos Processos**: Para determinar de onde um processo est√° sendo executado, o valor MIB `1.3.6.1.2.1.25.4.2.1.4` √© utilizado.
* **Unidades de Armazenamento**: O monitoramento de unidades de armazenamento √© facilitado por `1.3.6.1.2.1.25.2.3.1.4`.
* **Nome do Software**: Para identificar o software instalado em um sistema, `1.3.6.1.2.1.25.6.3.1.2` √© empregado.
* **Contas de Usu√°rio**: O valor `1.3.6.1.4.1.77.1.2.25` permite o rastreamento de contas de usu√°rio.
* **Portas Locais TCP**: Finalmente, `1.3.6.1.2.1.6.13.1.3` √© designado para monitorar portas locais TCP, fornecendo insights sobre conex√µes de rede ativas.

### Cisco

D√™ uma olhada nesta p√°gina se voc√™ estiver usando equipamentos Cisco:

{% content-ref url="cisco-snmp.md" %}
[cisco-snmp.md](cisco-snmp.md)
{% endcontent-ref %}

## De SNMP a RCE

Se voc√™ tiver a **string** que permite que voc√™ **escreva valores** dentro do servi√ßo SNMP, pode ser capaz de abusar disso para **executar comandos**:

{% content-ref url="snmp-rce.md" %}
[snmp-rce.md](snmp-rce.md)
{% endcontent-ref %}

## **SNMP Massivo**

[Braa](https://github.com/mteg/braa) √© um scanner SNMP em massa. O uso pretendido de tal ferramenta √©, claro, fazer consultas SNMP ‚Äì mas ao contr√°rio do snmpwalk do net-snmp, ele √© capaz de consultar dezenas ou centenas de hosts simultaneamente, e em um √∫nico processo. Assim, consome muito poucos recursos do sistema e faz a varredura MUITO r√°pido.

Braa implementa sua pr√≥pria pilha SNMP, portanto, n√£o precisa de nenhuma biblioteca SNMP como net-snmp.

**Sintaxe:** braa \[String-comunidade]@\[IP do servidor SNMP]:\[id iso]
```bash
braa ignite123@192.168.1.125:.1.3.6.*
```
Isso pode extrair muitos MB de informa√ß√µes que voc√™ n√£o pode processar manualmente.

Ent√£o, vamos procurar as informa√ß√µes mais interessantes (de [https://blog.rapid7.com/2016/05/05/snmp-data-harvesting-during-penetration-testing/](https://blog.rapid7.com/2016/05/05/snmp-data-harvesting-during-penetration-testing/)):

### **Dispositivos**

O processo come√ßa com a extra√ß√£o de **sysDesc MIB data** (1.3.6.1.2.1.1.1.0) de cada arquivo para identificar os dispositivos. Isso √© realizado atrav√©s do uso de um **grep command**:
```bash
grep ".1.3.6.1.2.1.1.1.0" *.snmp
```
### **Identificar String Privada**

Um passo crucial envolve identificar a **string de comunidade privada** usada por organiza√ß√µes, particularmente em roteadores Cisco IOS. Essa string permite a extra√ß√£o de **configura√ß√µes em execu√ß√£o** dos roteadores. A identifica√ß√£o geralmente se baseia na an√°lise de dados de SNMP Trap em busca da palavra "trap" com um **comando grep**:
```bash
grep -i "trap" *.snmp
```
### **Nomes de Usu√°rio/Senhas**

Logs armazenados nas tabelas MIB s√£o examinados em busca de **tentativas de login falhadas**, que podem acidentalmente incluir senhas inseridas como nomes de usu√°rio. Palavras-chave como _fail_, _failed_ ou _login_ s√£o pesquisadas para encontrar dados valiosos:
```bash
grep -i "login\|fail" *.snmp
```
### **Emails**

Finalmente, para extrair **endere√ßos de email** dos dados, um **comando grep** com uma express√£o regular √© usado, focando em padr√µes que correspondem a formatos de email:
```bash
grep -E -o "\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,6}\b" *.snmp
```
## Modificando valores SNMP

Voc√™ pode usar _**NetScanTools**_ para **modificar valores**. Voc√™ precisar√° conhecer a **string privada** para fazer isso.

## Spoofing

Se houver uma ACL que permite apenas alguns IPs consultar o servi√ßo SNMP, voc√™ pode falsificar um desses endere√ßos dentro do pacote UDP e capturar o tr√°fego.

## Examinar arquivos de configura√ß√£o SNMP

* snmp.conf
* snmpd.conf
* snmp-config.xml

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Se voc√™ est√° interessado em **carreira em hacking** e hackear o inhacke√°vel - **estamos contratando!** (_flu√™ncia em polon√™s escrita e falada √© necess√°ria_).

{% embed url="https://www.stmcyber.com/careers" %}

## HackTricks Comandos Autom√°ticos
```
Protocol_Name: SNMP    #Protocol Abbreviation if there is one.
Port_Number:  161     #Comma separated if there is more than one.
Protocol_Description: Simple Network Managment Protocol         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for SNMP
Note: |
SNMP - Simple Network Management Protocol is a protocol used to monitor different devices in the network (like routers, switches, printers, IoTs...).

https://book.hacktricks.xyz/pentesting/pentesting-snmp

Entry_2:
Name: SNMP Check
Description: Enumerate SNMP
Command: snmp-check {IP}

Entry_3:
Name: OneSixtyOne
Description: Crack SNMP passwords
Command: onesixtyone -c /usr/share/seclists/Discovery/SNMP/common-snmp-community-strings-onesixtyone.txt {IP} -w 100

Entry_4:
Name: Nmap
Description: Nmap snmp (no brute)
Command: nmap --script "snmp* and not snmp-brute" {IP}

Entry_5:
Name: Hydra Brute Force
Description: Need Nothing
Command: hydra -P {Big_Passwordlist} -v {IP} snmp


```
{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}
