# SIP (Session Initiation Protocol)

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Podstawowe informacje

SIP (Session Initiation Protocol) to **protok贸 sygnalizacyjny i sterowania poczeniami** szeroko stosowany do nawizywania, modyfikowania i zamykania sesji multimedialnych, w tym gosowych, wideo i komunikacji natychmiastowej, w sieciach IP. Opracowany przez **Internet Engineering Task Force (IETF)**, SIP jest zdefiniowany w **RFC 3261** i sta si de facto standardem dla VoIP i komunikacji zintegrowanej.

Niekt贸re kluczowe cechy SIP to:

1. **Protok贸 oparty na tekcie**: SIP jest protokoem opartym na tekcie, co czyni go czytelnym dla czowieka i atwiejszym do debugowania. Opiera si na modelu 偶danie-odpowied藕, podobnym do HTTP, i u偶ywa metod takich jak INVITE, ACK, BYE i CANCEL do sterowania sesjami pocze.
2. **Skalowalno i elastyczno**: SIP jest wysoce skalowalny i mo偶e by stosowany zar贸wno w maych implementacjach, jak i w du偶ych rodowiskach przedsibiorstwowych i operatorskich. Mo偶e by atwo rozszerzany o nowe funkcje, co pozwala na dostosowanie go do r贸偶nych przypadk贸w u偶ycia i wymaga.
3. **Interoperacyjno**: Powszechne stosowanie i standaryzacja SIP zapewnia lepsz interoperacyjno midzy r贸偶nymi urzdzeniami, aplikacjami i dostawcami usug, promujc pynn komunikacj na r贸偶nych platformach.
4. **Modularna konstrukcja**: SIP wsp贸pracuje z innymi protokoami, takimi jak **RTP (Real-time Transport Protocol)** do transmisji multimedi贸w i **SDP (Session Description Protocol)** do opisu sesji multimedialnych. Ta modularna konstrukcja pozwala na wiksz elastyczno i kompatybilno z r贸偶nymi typami medi贸w i kodekami.
5. **Serwery proxy i przekierowania**: SIP mo偶e korzysta z serwer贸w proxy i przekierowa do uatwienia routingu pocze i dostarczania zaawansowanych funkcji, takich jak przekazywanie pocze, transfer pocze i usugi poczty gosowej.
6. **Obecno i komunikacja natychmiastowa**: SIP nie jest ograniczony do komunikacji gosowej i wideo. Obsuguje r贸wnie偶 obecno i komunikacj natychmiastow, umo偶liwiajc szeroki zakres zastosowa w komunikacji zintegrowanej.

Mimo wielu zalet, SIP mo偶e by skomplikowany w konfiguracji i zarzdzaniu, zwaszcza przy rozwizywaniu problem贸w z przekraczaniem NAT i zapory ogniowej. Jednak jego wszechstronno, skalowalno i szerokie wsparcie w caej bran偶y sprawiaj, 偶e jest popularnym wyborem dla VoIP i komunikacji multimedialnej.

### Metody SIP

Podstawowe metody SIP zdefiniowane w **RFC 3261** to:

1. **INVITE**: Su偶y do **inicjowania nowej sesji (poczenia)** lub modyfikowania istniejcej. Metoda INVITE przenosi opis sesji (zwykle za pomoc SDP), informujc odbiorc o szczeg贸ach proponowanej sesji, takich jak typy medi贸w, kodeki i protokoy transportowe.
2. **ACK**: Wysyane w celu **potwierdzenia otrzymania** ostatecznej odpowiedzi na 偶danie INVITE. Metoda ACK zapewnia niezawodno transakcji INVITE poprzez dostarczenie potwierdzenia od koca do koca.
3. **BYE**: Su偶y do **zakoczenia ustanowionej sesji (poczenia)**. Metoda BYE jest wysyana przez jedn ze stron w sesji, aby wskaza, 偶e chc zakoczy komunikacj.
4. **CANCEL**: Wysyane w celu **anulowania oczekujcego 偶dania INVITE** przed ustanowieniem sesji. Metoda CANCEL pozwala nadawcy przerwa transakcj INVITE, jeli zmieni zdanie lub jeli nie otrzyma odpowiedzi od odbiorcy.
5. **OPTIONS**: Su偶y do **zapytania o mo偶liwoci serwera SIP lub agenta u偶ytkownika**. Metoda OPTIONS mo偶e by wysana w celu uzyskania informacji o obsugiwanych metodach, typach medi贸w lub innych rozszerzeniach bez faktycznego ustanawiania sesji.
6. **REGISTER**: U偶ywane przez agenta u偶ytkownika do **zarejestrowania bie偶cego poo偶enia z rejestratorem SIP**. Metoda REGISTER pomaga w utrzymaniu aktualnego mapowania midzy SIP URI u偶ytkownika a jego bie偶cym adresem IP, umo偶liwiajc routowanie i dostarczanie pocze.

{% hint style="warning" %}
Nale偶y zauwa偶y, 偶e do wykonania poczenia **nie jest konieczne u偶ycie metody REGISTER**.\
Jednak mo偶liwe jest, 偶e w celu wykonania **INVITE** dzwonicy musi si **uwierzytelni** lub otrzyma odpowied藕 **`401 Unauthorized`**.
{% endhint %}

Opr贸cz tych podstawowych metod, istnieje **kilka rozszerze SIP** zdefiniowanych w innych RFC, takich jak:

1. **SUBSCRIBE**: Zdefiniowana w RFC 6665, metoda SUBSCRIBE su偶y do **偶dania powiadomie** o stanie okrelonego zasobu, takiego jak obecno u偶ytkownika lub status poczenia.
2. **NOTIFY**: R贸wnie偶 zdefiniowana w RFC 6665, metoda NOTIFY jest wysyana przez serwer, aby **poinformowa zarejestrowany agent u偶ytkownika** o zmianach w stanie monitorowanego zasobu.
3. **REFER**: Zdefiniowana w RFC 3515, metoda REFER su偶y do **偶dania, aby odbiorca przeprowadzi transfer lub skierowa do strony trzeciej**. Jest to zwy
## Przykady

### Przykad SIP INVITE
```
INVITE sip:jdoe@example.com SIP/2.0
Via: SIP/2.0/UDP pc33.example.com;branch=z9hG4bK776asdhds
Max-Forwards: 70
To: John Doe <sip:jdoe@example.com>
From: Jane Smith <sip:jsmith@example.org>;tag=1928301774
Call-ID: a84b4c76e66710
CSeq: 314159 INVITE
Contact: <sip:jsmith@pc33.example.com>
User-Agent: ExampleSIPClient/1.0
Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY, MESSAGE, SUBSCRIBE, INFO
Content-Type: application/sdp
Content-Length: 142

v=0
o=jsmith 2890844526 2890842807 IN IP4 pc33.example.com
s=-
c=IN IP4 pc33.example.com
t=0 0
m=audio 49170 RTP/AVP 0
a=rtpmap:0 PCMU/8000te
```
<details>

<summary>Wyjanienie ka偶dego parametru</summary>

1. **Request-Line**: `INVITE sip:jdoe@example.com SIP/2.0` - Ta linia wskazuje metod (INVITE), URI 偶dania (sip:[jdoe@example.com](mailto:jdoe@example.com)) i wersj SIP (SIP/2.0).
2. **Via**: `Via: SIP/2.0/UDP pc33.example.com;branch=z9hG4bK776asdhds` - Nag贸wek Via okrela protok贸 transportowy (UDP) i adres klienta (pc33.example.com). Parametr "branch" jest u偶ywany do wykrywania ptli i dopasowywania transakcji.
3. **Max-Forwards**: `Max-Forwards: 70` - To pole nag贸wka ogranicza liczb przekierowa 偶dania przez serwery poredniczce, aby unikn nieskoczonych ptli.
4. **To**: `To: John Doe <sip:jdoe@example.com>` - Nag贸wek To okrela odbiorc poczenia, w tym jego nazw wywietlan (John Doe) i URI SIP (sip:[jdoe@example.com](mailto:jdoe@example.com)).
5. **From**: `From: Jane Smith <sip:jsmith@example.org>;tag=1928301774` - Nag贸wek From okrela nadawc poczenia, w tym jego nazw wywietlan (Jane Smith) i URI SIP (sip:[jsmith@example.org](mailto:jsmith@example.org)). Parametr "tag" jest u偶ywany do jednoznacznego identyfikowania roli nadawcy w dialogu.
6. **Call-ID**: `Call-ID: a84b4c76e66710` - Nag贸wek Call-ID jednoznacznie identyfikuje sesj poczenia midzy dwoma agentami u偶ytkownika.
7. **CSeq**: `CSeq: 314159 INVITE` - Nag贸wek CSeq zawiera numer sekwencji i metod u偶ywan w 偶daniu. Su偶y do dopasowywania odpowiedzi do 偶da i wykrywania wiadomoci otrzymanych w niewaciwej kolejnoci.
8. **Contact**: `Contact: <sip:jsmith@pc33.example.com>` - Nag贸wek Contact zapewnia bezporedni tras do nadawcy, kt贸ra mo偶e by u偶ywana do kolejnych 偶da i odpowiedzi.
9. **User-Agent**: `User-Agent: ExampleSIPClient/1.0` - Nag贸wek User-Agent zawiera informacje o oprogramowaniu lub sprzcie nadawcy, w tym jego nazw i wersj.
10. **Allow**: `Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY, MESSAGE, SUBSCRIBE, INFO` - Nag贸wek Allow wymienia obsugiwane przez nadawc metody SIP. Pomaga odbiorcy zrozumie, kt贸re metody mog by u偶ywane podczas komunikacji.
11. **Content-Type**: `Content-Type: application/sdp` - Nag贸wek Content-Type okrela typ multimedi贸w treci wiadomoci, w tym przypadku SDP (Session Description Protocol).
12. **Content-Length**: `Content-Length: 142` - Nag贸wek Content-Length wskazuje rozmiar treci wiadomoci w bajtach.
13. **Tre wiadomoci**: Tre wiadomoci zawiera opis sesji SDP, kt贸ry zawiera informacje o typach multimedi贸w, kodekach i protokoach transportowych dla proponowanej sesji.

* `v=0` - Wersja protokou (0 dla SDP)
* `o=jsmith 2890844526 2890842807 IN IP4 pc33.example.com` - Identyfikator pochodzcego i sesji
* `s=-` - Nazwa sesji (pojedynczy mylnik oznacza brak nazwy sesji)
* `c=IN IP4 pc33.example.com` - Informacje o poczeniu (typ sieci, typ adresu i adres)
* `t=0 0` - Informacje o czasie (czasy rozpoczcia i zakoczenia, 0 0 oznacza, 偶e sesja nie jest ograniczona)
* `m=audio 49170 RTP/AVP 0` - Opis multimedi贸w (typ multimedi贸w, numer portu, protok贸 transportowy i lista format贸w). W tym przypadku okrela strumie audio za pomoc RTP/AVP (Real-time Transport Protocol / Audio Video Profile) i formatu 0 (PCMU/8000).
* `a=rtpmap:0 PCMU/8000` - Atrybut mapujcy format (0) na kodek (PCMU) i jego czstotliwo pr贸bkowania (8000 Hz).

</details>

### Przykad rejestracji SIP

Metoda REGISTER jest u偶ywana w protokole inicjacji sesji (SIP), aby umo偶liwi agentowi u偶ytkownika (UA), takiemu jak telefon VoIP lub softfon, **zarejestrowanie swojej lokalizacji w serwerze rejestracyjnym SIP**. Ten proces informuje serwer, **gdzie kierowa przychodzce 偶dania SIP przeznaczone dla zarejestrowanego u偶ytkownika**. Serwer rejestracyjny zwykle jest czci serwera poredniczcego SIP lub dedykowanego serwera rejestracji.

Oto szczeg贸owy przykad wiadomoci SIP zaanga偶owanych w proces uwierzytelniania rejestracji:

1. Pocztkowe 偶danie **REGISTER** od UA do serwera rejestracyjnego:
```yaml
REGISTER sip:example.com SIP/2.0
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
Max-Forwards: 70
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>
Call-ID: 1234567890@192.168.1.100
CSeq: 1 REGISTER
Contact: <sip:alice@192.168.1.100:5060>;expires=3600
Expires: 3600
Content-Length: 0
```
Ten pocztkowy komunikat REGISTER jest wysyany przez UA (Alice) do serwera rejestratora. Zawiera wa偶ne informacje, takie jak po偶dany czas trwania rejestracji (Expires), SIP URI u偶ytkownika (sip:[alice@example.com](mailto:alice@example.com)) oraz adres kontaktowy u偶ytkownika (sip:alice@192.168.1.100:5060).

2. Odpowied藕 **401 Unauthorized** od serwera rejestratora:
```css
cssCopy codeSIP/2.0 401 Unauthorized
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>;tag=7878744
Call-ID: 1234567890@192.168.1.100
CSeq: 1 REGISTER
WWW-Authenticate: Digest realm="example.com", nonce="abcdefghijk", algorithm=MD5, qop="auth"
Content-Length: 0
```
Serwer rejestratora odpowiada wiadomoci "401 Unauthorized", kt贸ra zawiera nag贸wek "WWW-Authenticate". Nag贸wek ten zawiera informacje wymagane do uwierzytelnienia UA, takie jak **obszar uwierzytelniania, nonce i algorytm**.

3. 呕danie REJESTRACJI **z danymi uwierzytelniajcymi**:
```vbnet
REGISTER sip:example.com SIP/2.0
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
Max-Forwards: 70
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>
Call-ID: 1234567890@192.168.1.100
CSeq: 2 REGISTER
Contact: <sip:alice@192.168.1.100:5060>;expires=3600
Expires: 3600
Authorization: Digest username="alice", realm="example.com", nonce="abcdefghijk", uri="sip:example.com", response="65a8e2285879283831b664bd8b7f14d4", algorithm=MD5, cnonce="lmnopqrst", qop=auth, nc=00000001
Content-Length: 0
```
UA wysya kolejne 偶danie REGISTER, tym razem zawierajce nag贸wek **"Authorization" z niezbdnymi danymi uwierzytelniajcymi, takimi jak nazwa u偶ytkownika, obszar, nonce i warto odpowiedzi** obliczona przy u偶yciu dostarczonych informacji i hasa u偶ytkownika.

Tak jest obliczana **odpowied藕 uwierzytelniajca (Authorization response)**:
```python
import hashlib

def calculate_sip_md5_response(username, password, realm, method, uri, nonce, nc, cnonce, qop):
# 1. Calculate HA1 (concatenation of username, realm, and password)
ha1_input = f"{username}:{realm}:{password}"
ha1 = hashlib.md5(ha1_input.encode()).hexdigest()

# 2. Calculate HA2 (concatenation of method and uri)
ha2_input = f"{method}:{uri}"
ha2 = hashlib.md5(ha2_input.encode()).hexdigest()

# 3. Calculate the final response value (concatenation of h1, stuff and h2)
response_input = f"{ha1}:{nonce}:{nc}:{cnonce}:{qop}:{ha2}"
response = hashlib.md5(response_input.encode()).hexdigest()

return response

# Example usage
username = "alice"
password = "mysecretpassword"
realm = "example.com"
method = "REGISTER"
uri = "sip:example.com"
nonce = "abcdefghijk"
nc = "00000001"
cnonce = "lmnopqrst"
qop = "auth"

response = calculate_sip_md5_response(username, password, realm, method, uri, nonce, nc, cnonce, qop)
print(f"MD5 response value: {response}")
```
4. **Pomylna rejestracja** odpowied藕 od serwera rejestracyjnego:
```yaml
SIP/2.0 200 OK
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>;tag=7878744
Call-ID: 1234567890@192.168.1.100
CSeq: 2 REGISTER
Contact: <sip:alice@192.168.1.100:5060>;expires=3600
Expires: 3600
Content-Length: 0
```
Po weryfikacji dostarczonych danych uwierzytelniajcych, **serwer rejestratora wysya odpowied藕 "200 OK" w celu potwierdzenia udanej rejestracji**. Odpowied藕 zawiera zarejestrowane informacje kontaktowe oraz czas wyganicia rejestracji. W tym momencie agent u偶ytkownika (Alice) jest pomylnie zarejestrowany w serwerze rejestratora SIP, a przychodzce 偶dania SIP dla Alice mog by kierowane na odpowiedni adres kontaktowy.

### Przykad poczenia

<figure><img src="../../../.gitbook/assets/image (666).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
Nie jest to wspomniane, ale U偶ytkownik B musi wysa **wiadomo REGISTER do Proxy 2**, zanim bdzie m贸g odbiera poczenia.
{% endhint %}

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) **i** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **repozytori贸w GitHub.**

</details>
