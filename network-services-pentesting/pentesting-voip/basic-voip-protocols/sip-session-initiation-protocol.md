# SIP (Session Initiation Protocol)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
{% endhint %}

## Podstawowe informacje

SIP (Session Initiation Protocol) to **protok贸 sygnalizacji i kontroli pocze**, szeroko stosowany do nawizywania, modyfikowania i koczenia sesji multimedialnych, w tym gosu, wideo i wiadomoci byskawicznych, w sieciach IP. Opracowany przez **Internet Engineering Task Force (IETF)**, SIP jest zdefiniowany w **RFC 3261** i sta si de facto standardem dla VoIP i zintegrowanej komunikacji.

Niekt贸re kluczowe cechy SIP to:

1. **Protok贸 oparty na tekcie**: SIP jest protokoem opartym na tekcie, co czyni go czytelnym dla ludzi i atwiejszym do debugowania. Opiera si na modelu 偶danie-odpowied藕, podobnym do HTTP, i u偶ywa metod takich jak INVITE, ACK, BYE i CANCEL do kontrolowania sesji pocze.
2. **Skalowalno i elastyczno**: SIP jest wysoce skalowalny i mo偶e by u偶ywany zar贸wno w maych wdro偶eniach, jak i w du偶ych rodowiskach przedsibiorstw i operator贸w. Mo偶e by atwo rozszerzany o nowe funkcje, co czyni go dostosowujcym si do r贸偶nych przypadk贸w u偶ycia i wymaga.
3. **Interoperacyjno**: Szerokie przyjcie i standaryzacja SIP zapewniaj lepsz interoperacyjno midzy r贸偶nymi urzdzeniami, aplikacjami i dostawcami usug, promujc pynn komunikacj na r贸偶nych platformach.
4. **Modularny design**: SIP wsp贸pracuje z innymi protokoami, takimi jak **RTP (Real-time Transport Protocol)** do transmisji medi贸w i **SDP (Session Description Protocol)** do opisywania sesji multimedialnych. Ten modularny design pozwala na wiksz elastyczno i kompatybilno z r贸偶nymi typami medi贸w i kodekami.
5. **Serwery proxy i przekierowujce**: SIP mo偶e u偶ywa serwer贸w proxy i przekierowujcych do uatwienia routingu pocze i zapewnienia zaawansowanych funkcji, takich jak przekazywanie pocze, transfer pocze i usugi poczty gosowej.
6. **Obecno i wiadomoci byskawiczne**: SIP nie ogranicza si tylko do komunikacji gosowej i wideo. Obsuguje r贸wnie偶 obecno i wiadomoci byskawiczne, umo偶liwiajc szeroki zakres aplikacji zintegrowanej komunikacji.

Pomimo wielu zalet, SIP mo偶e by skomplikowany do skonfigurowania i zarzdzania, szczeg贸lnie w przypadku problem贸w z przechodzeniem przez NAT i zapory. Jednak jego wszechstronno, skalowalno i szerokie wsparcie w bran偶y czyni go popularnym wyborem dla komunikacji VoIP i multimedialnej.

### Metody SIP

Podstawowe metody SIP zdefiniowane w **RFC 3261** obejmuj:

1. **INVITE**: U偶ywana do **nawizania nowej sesji (poczenia)** lub modyfikacji istniejcej. Metoda INVITE przenosi opis sesji (zwykle przy u偶yciu SDP), aby poinformowa odbiorc o szczeg贸ach proponowanej sesji, takich jak typy medi贸w, kodeki i protokoy transportowe.
2. **ACK**: Wysyana w celu **potwierdzenia odbioru** ostatecznej odpowiedzi na 偶danie INVITE. Metoda ACK zapewnia niezawodno transakcji INVITE, zapewniajc potwierdzenie end-to-end.
3. **BYE**: U偶ywana do **koczenia nawizanej sesji (poczenia)**. Metoda BYE jest wysyana przez kt贸rkolwiek ze stron w sesji, aby wskaza, 偶e chce zakoczy komunikacj.
4. **CANCEL**: Wysyana w celu **anulowania oczekujcego 偶dania INVITE** przed nawizaniem sesji. Metoda CANCEL pozwala nadawcy przerwa transakcj INVITE, jeli zmieni zdanie lub jeli nie ma odpowiedzi od odbiorcy.
5. **OPTIONS**: U偶ywana do **zapytania o mo偶liwoci serwera SIP lub agenta u偶ytkownika**. Metoda OPTIONS mo偶e by wysyana w celu uzyskania informacji o obsugiwanych metodach, typach medi贸w lub innych rozszerzeniach bez faktycznego nawizywania sesji.
6. **REGISTER**: U偶ywana przez agenta u偶ytkownika do **zarejestrowania swojej bie偶cej lokalizacji w serwerze rejestracyjnym SIP**. Metoda REGISTER pomaga w utrzymaniu aktualnej mapy midzy URI SIP u偶ytkownika a jego bie偶cym adresem IP, umo偶liwiajc routowanie i dostarczanie pocze.

{% hint style="warning" %}
Nale偶y pamita, 偶e aby zadzwoni do kogo, **nie jest konieczne u偶ywanie REGISTER** do czegokolwiek.\
Jednak mo偶liwe jest, 偶e aby wykona **INVITE**, dzwonicy musi najpierw **uwierzytelni si**, inaczej otrzyma odpowied藕 **`401 Unauthorized`**.
{% endhint %}

Opr贸cz tych podstawowych metod istnieje **kilka rozszerze metod SIP** zdefiniowanych w innych RFC, takich jak:

1. **SUBSCRIBE**: Zdefiniowana w RFC 6665, metoda SUBSCRIBE jest u偶ywana do **偶dania powiadomie** o stanie konkretnego zasobu, takiego jak obecno u偶ytkownika lub status poczenia.
2. **NOTIFY**: R贸wnie偶 zdefiniowana w RFC 6665, metoda NOTIFY jest wysyana przez serwer, aby **poinformowa subskrybowanego agenta u偶ytkownika** o zmianach w stanie monitorowanego zasobu.
3. **REFER**: Zdefiniowana w RFC 3515, metoda REFER jest u偶ywana do **偶dania, aby odbiorca wykona transfer lub odni贸s si do strony trzeciej**. Jest to zazwyczaj u偶ywane w scenariuszach **transferu pocze**.
4. **MESSAGE**: Zdefiniowana w RFC 3428, metoda MESSAGE jest u偶ywana do **wysyania wiadomoci byskawicznych midzy agentami u偶ytkownika SIP**, umo偶liwiajc komunikacj opart na tekcie w ramach SIP.
5. **UPDATE**: Zdefiniowana w RFC 3311, metoda UPDATE pozwala na **modyfikacj sesji bez wpywu na stan istniejcego dialogu**. Jest to przydatne do aktualizacji parametr贸w sesji, takich jak kodeki lub typy medi贸w, podczas trwajcego poczenia.
6. **PUBLISH**: Zdefiniowana w RFC 3903, metoda PUBLISH jest u偶ywana przez agenta u偶ytkownika do **publikowania informacji o stanie zdarze na serwerze**, udostpniajc je innym zainteresowanym stronom.

### Kody odpowiedzi SIP

* **1xx (Odpowiedzi tymczasowe)**: Te odpowiedzi wskazuj, 偶e 偶danie zostao odebrane, a serwer kontynuuje jego przetwarzanie.
* 100 Trying: 呕danie zostao odebrane, a serwer nad tym pracuje.
* 180 Ringing: Odbiorca jest informowany i podejmie poczenie.
* 183 Session Progress: Dostarcza informacje o postpie poczenia.
* **2xx (Odpowiedzi pomylne)**: Te odpowiedzi wskazuj, 偶e 偶danie zostao pomylnie odebrane, zrozumiane i zaakceptowane.
* 200 OK: 呕danie zakoczyo si sukcesem, a serwer je zrealizowa.
* 202 Accepted: 呕danie zostao zaakceptowane do przetwarzania, ale jeszcze nie zostao zakoczone.
* **3xx (Odpowiedzi przekierowujce)**: Te odpowiedzi wskazuj, 偶e dalsze dziaania s wymagane do zrealizowania 偶dania, zazwyczaj poprzez skontaktowanie si z alternatywnym zasobem.
* 300 Multiple Choices: Istnieje wiele dostpnych opcji, a u偶ytkownik lub klient musi wybra jedn.
* 301 Moved Permanently: 呕dany zas贸b zosta przypisany nowemu staemu URI.
* 302 Moved Temporarily: 呕dany zas贸b jest tymczasowo dostpny pod innym URI.
* 305 Use Proxy: 呕danie musi by wysane do okrelonego proxy.
* **4xx (Odpowiedzi bd贸w klienta)**: Te odpowiedzi wskazuj, 偶e 偶danie zawiera bdn skadni lub nie mo偶e by zrealizowane przez serwer.
* 400 Bad Request: 呕danie byo 藕le sformuowane lub nieprawidowe.
* 401 Unauthorized: 呕danie wymaga uwierzytelnienia u偶ytkownika.
* 403 Forbidden: Serwer zrozumia 偶danie, ale odmawia jego zrealizowania.
* 404 Not Found: 呕dany zas贸b nie zosta znaleziony na serwerze.
* 408 Request Timeout: Serwer nie otrzyma penego 偶dania w czasie, w kt贸rym by gotowy czeka.
* 486 Busy Here: Odbiorca jest obecnie zajty i nie mo偶e odebra poczenia.
* **5xx (Odpowiedzi bd贸w serwera)**: Te odpowiedzi wskazuj, 偶e serwer nie zdoa zrealizowa wa偶nego 偶dania.
* 500 Internal Server Error: Serwer napotka bd podczas przetwarzania 偶dania.
* 501 Not Implemented: Serwer nie obsuguje funkcjonalnoci wymaganej do zrealizowania 偶dania.
* 503 Service Unavailable: Serwer jest obecnie niezdolny do obsugi 偶dania z powodu konserwacji lub przeci偶enia.
* **6xx (Odpowiedzi globalnych bd贸w)**: Te odpowiedzi wskazuj, 偶e 偶danie nie mo偶e by zrealizowane przez 偶aden serwer.
* 600 Busy Everywhere: Wszystkie mo偶liwe miejsca docelowe dla poczenia s zajte.
* 603 Decline: Odbiorca nie chce uczestniczy w poczeniu.
* 604 Does Not Exist Anywhere: 呕dany zas贸b nie jest dostpny nigdzie w sieci.

## Przykady

### Przykad SIP INVITE
```
INVITE sip:jdoe@example.com SIP/2.0
Via: SIP/2.0/UDP pc33.example.com;branch=z9hG4bK776asdhds
Max-Forwards: 70
To: John Doe <sip:jdoe@example.com>
From: Jane Smith <sip:jsmith@example.org>;tag=1928301774
Call-ID: a84b4c76e66710
CSeq: 314159 INVITE
Contact: <sip:jsmith@pc33.example.com>
User-Agent: ExampleSIPClient/1.0
Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY, MESSAGE, SUBSCRIBE, INFO
Content-Type: application/sdp
Content-Length: 142

v=0
o=jsmith 2890844526 2890842807 IN IP4 pc33.example.com
s=-
c=IN IP4 pc33.example.com
t=0 0
m=audio 49170 RTP/AVP 0
a=rtpmap:0 PCMU/8000te
```
<details>

<summary>Ka偶dy parametr wyjaniony</summary>

1. **Request-Line**: `INVITE sip:jdoe@example.com SIP/2.0` - Ten wiersz wskazuje metod (INVITE), URI 偶dania (sip:[jdoe@example.com](mailto:jdoe@example.com)) oraz wersj SIP (SIP/2.0).
2. **Via**: `Via: SIP/2.0/UDP pc33.example.com;branch=z9hG4bK776asdhds` - Nag贸wek Via okrela protok贸 transportowy (UDP) oraz adres klienta (pc33.example.com). Parametr "branch" jest u偶ywany do wykrywania ptli i dopasowywania transakcji.
3. **Max-Forwards**: `Max-Forwards: 70` - To pole nag贸wka ogranicza liczb razy, kt贸re 偶danie mo偶e by przekazywane przez serwery proxy, aby unikn nieskoczonych ptli.
4. **To**: `To: John Doe <sip:jdoe@example.com>` - Nag贸wek To okrela odbiorc poczenia, w tym jego nazw wywietlan (John Doe) oraz URI SIP (sip:[jdoe@example.com](mailto:jdoe@example.com)).
5. **From**: `From: Jane Smith <sip:jsmith@example.org>;tag=1928301774` - Nag贸wek From okrela nadawc poczenia, w tym jego nazw wywietlan (Jane Smith) oraz URI SIP (sip:[jsmith@example.org](mailto:jsmith@example.org)). Parametr "tag" jest u偶ywany do unikalnej identyfikacji roli nadawcy w dialogu.
6. **Call-ID**: `Call-ID: a84b4c76e66710` - Nag贸wek Call-ID unikalnie identyfikuje sesj poczenia midzy dwoma agentami u偶ytkownika.
7. **CSeq**: `CSeq: 314159 INVITE` - Nag贸wek CSeq zawiera numer sekwencyjny oraz metod u偶ywan w 偶daniu. Jest u偶ywany do dopasowywania odpowiedzi do 偶da i wykrywania wiadomoci w zej kolejnoci.
8. **Contact**: `Contact: <sip:jsmith@pc33.example.com>` - Nag贸wek Contact zapewnia bezporedni tras do nadawcy, kt贸ra mo偶e by u偶ywana do kolejnych 偶da i odpowiedzi.
9. **User-Agent**: `User-Agent: ExampleSIPClient/1.0` - Nag贸wek User-Agent dostarcza informacji o oprogramowaniu lub sprzcie nadawcy, w tym jego nazwie i wersji.
10. **Allow**: `Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY, MESSAGE, SUBSCRIBE, INFO` - Nag贸wek Allow wymienia metody SIP wspierane przez nadawc. Pomaga to odbiorcy zrozumie, kt贸re metody mog by u偶ywane podczas komunikacji.
11. **Content-Type**: `Content-Type: application/sdp` - Nag贸wek Content-Type okrela typ medi贸w ciaa wiadomoci, w tym przypadku SDP (Session Description Protocol).
12. **Content-Length**: `Content-Length: 142` - Nag贸wek Content-Length wskazuje rozmiar ciaa wiadomoci w bajtach.
13. **Message Body**: Ciao wiadomoci zawiera opis sesji SDP, kt贸ry zawiera informacje o typach medi贸w, kodekach i protokoach transportowych dla proponowanej sesji.

* `v=0` - Wersja protokou (0 dla SDP)
* `o=jsmith 2890844526 2890842807 IN IP4 pc33.example.com` - Inicjator i identyfikator sesji
* `s=-` - Nazwa sesji (pojedynczy mylnik oznacza brak nazwy sesji)
* `c=IN IP4 pc33.example.com` - Informacje o poczeniu (typ sieci, typ adresu i adres)
* `t=0 0` - Informacje o czasie (czasy rozpoczcia i zakoczenia, 0 0 oznacza, 偶e sesja nie jest ograniczona)
* `m=audio 49170 RTP/AVP 0` - Opis medi贸w (typ medi贸w, numer portu, protok贸 transportowy i lista format贸w). W tym przypadku okrela strumie audio u偶ywajcy RTP/AVP (Real-time Transport Protocol / Audio Video Profile) i format 0 (PCMU/8000).
* `a=rtpmap:0 PCMU/8000` - Atrybut mapujcy format (0) do kodeka (PCMU) i jego czstotliwoci zegara (8000 Hz).

</details>

### Przykad SIP REGISTER

Metoda REGISTER jest u偶ywana w protokole inicjowania sesji (SIP), aby umo偶liwi agentowi u偶ytkownika (UA), takiemu jak telefon VoIP lub softphone, **zarejestrowanie swojej lokalizacji w serwerze rejestracyjnym SIP**. Proces ten informuje serwer **gdzie kierowa przychodzce 偶dania SIP przeznaczone dla zarejestrowanego u偶ytkownika**. Serwer rejestracyjny jest zazwyczaj czci serwera proxy SIP lub dedykowanego serwera rejestracyjnego.

Oto szczeg贸owy przykad wiadomoci SIP zaanga偶owanych w proces uwierzytelniania REGISTER: 

1. Pocztkowe **REGISTER** 偶danie od UA do serwera rejestracyjnego:
```yaml
REGISTER sip:example.com SIP/2.0
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
Max-Forwards: 70
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>
Call-ID: 1234567890@192.168.1.100
CSeq: 1 REGISTER
Contact: <sip:alice@192.168.1.100:5060>;expires=3600
Expires: 3600
Content-Length: 0
```
Ten pocztkowy komunikat REGISTER jest wysyany przez UA (Alice) do serwera rejestracji. Zawiera wa偶ne informacje, takie jak po偶dany czas rejestracji (Expires), URI SIP u偶ytkownika (sip:[alice@example.com](mailto:alice@example.com)) oraz adres kontaktowy u偶ytkownika (sip:alice@192.168.1.100:5060).

2. **401 Unauthorized** odpowied藕 od serwera rejestracji:
```css
cssCopy codeSIP/2.0 401 Unauthorized
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>;tag=7878744
Call-ID: 1234567890@192.168.1.100
CSeq: 1 REGISTER
WWW-Authenticate: Digest realm="example.com", nonce="abcdefghijk", algorithm=MD5, qop="auth"
Content-Length: 0
```
Serwer rejestracyjny odpowiada komunikatem "401 Unauthorized", kt贸ry zawiera nag贸wek "WWW-Authenticate". Ten nag贸wek zawiera informacje wymagane do uwierzytelnienia UA, takie jak **realm uwierzytelnienia, nonce i algorytm**.

3. 呕danie REGISTER **z danymi uwierzytelniajcymi**:
```vbnet
REGISTER sip:example.com SIP/2.0
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
Max-Forwards: 70
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>
Call-ID: 1234567890@192.168.1.100
CSeq: 2 REGISTER
Contact: <sip:alice@192.168.1.100:5060>;expires=3600
Expires: 3600
Authorization: Digest username="alice", realm="example.com", nonce="abcdefghijk", uri="sip:example.com", response="65a8e2285879283831b664bd8b7f14d4", algorithm=MD5, cnonce="lmnopqrst", qop=auth, nc=00000001
Content-Length: 0
```
UA wysya kolejne 偶danie REGISTER, tym razem zawierajce **nag贸wek "Authorization" z niezbdnymi powiadczeniami, takimi jak nazwa u偶ytkownika, realm, nonce i warto odpowiedzi** obliczon na podstawie podanych informacji oraz hasa u偶ytkownika.

W ten spos贸b obliczana jest **odpowied藕 Authorization**:
```python
import hashlib

def calculate_sip_md5_response(username, password, realm, method, uri, nonce, nc, cnonce, qop):
# 1. Calculate HA1 (concatenation of username, realm, and password)
ha1_input = f"{username}:{realm}:{password}"
ha1 = hashlib.md5(ha1_input.encode()).hexdigest()

# 2. Calculate HA2 (concatenation of method and uri)
ha2_input = f"{method}:{uri}"
ha2 = hashlib.md5(ha2_input.encode()).hexdigest()

# 3. Calculate the final response value (concatenation of h1, stuff and h2)
response_input = f"{ha1}:{nonce}:{nc}:{cnonce}:{qop}:{ha2}"
response = hashlib.md5(response_input.encode()).hexdigest()

return response

# Example usage
username = "alice"
password = "mysecretpassword"
realm = "example.com"
method = "REGISTER"
uri = "sip:example.com"
nonce = "abcdefghijk"
nc = "00000001"
cnonce = "lmnopqrst"
qop = "auth"

response = calculate_sip_md5_response(username, password, realm, method, uri, nonce, nc, cnonce, qop)
print(f"MD5 response value: {response}")
```
4. **Udana rejestracja** odpowied藕 z serwera rejestratora:
```yaml
SIP/2.0 200 OK
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>;tag=7878744
Call-ID: 1234567890@192.168.1.100
CSeq: 2 REGISTER
Contact: <sip:alice@192.168.1.100:5060>;expires=3600
Expires: 3600
Content-Length: 0
```
Po zweryfikowaniu podanych danych uwierzytelniajcych, **serwer rejestracyjny wysya odpowied藕 "200 OK", aby wskaza, 偶e rejestracja bya udana**. Odpowied藕 zawiera zarejestrowane informacje kontaktowe oraz czas wyganicia rejestracji. W tym momencie agent u偶ytkownika (Alice) jest pomylnie zarejestrowany w serwerze rejestracyjnym SIP, a przychodzce 偶dania SIP dla Alice mog by kierowane do odpowiedniego adresu kontaktowego.

### Przykad poczenia

<figure><img src="../../../.gitbook/assets/image (1101).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
Nie jest to wspomniane, ale U偶ytkownik B musi wysa **wiadomo REGISTER do Proxy 2**, zanim bdzie m贸g odbiera poczenia.
{% endhint %}
{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na GitHubie.

</details>
{% endhint %}
</details>
{% endhint %}
