# SIP (Session Initiation Protocol)

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** Proverite [**PLANOVE ZA PRIJEM**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Osnovne informacije

SIP (Session Initiation Protocol) je **signalizacioni i kontrolni protokol poziva** 코iroko kori코캖en za uspostavljanje, modifikaciju i prekidanje multimedijalnih sesija, uklju캜uju캖i glas, video i trenutne poruke, preko IP mre쬬. Razvijen od strane **Internet Engineering Task Force (IETF)**, SIP je definisan u **RFC 3261** i postao je de facto standard za VoIP i ujedinjene komunikacije.

Neke klju캜ne karakteristike SIP-a uklju캜uju:

1. **Tekstualni protokol**: SIP je tekstualni protokol, 코to ga 캜ini 캜itljivim za ljude i lak코im za otklanjanje gre코aka. Baziran je na modelu zahteva-odgovora, sli캜nom HTTP-u, i koristi metode poput INVITE, ACK, BYE i CANCEL za kontrolu poziva.
2. **Pove캖ana skalabilnost i fleksibilnost**: SIP je visoko skalabilan i mo쬰 se koristiti u malim implementacijama kao i u velikim preduze캖ima i nosa캜kim okru쬰njima. Mo쬰 se lako pro코iriti novim funkcijama, 코to ga 캜ini prilagodljivim razli캜itim slu캜ajevima upotrebe i zahtevima.
3. **Interoperabilnost**: 말roka upotreba i standardizacija SIP-a osiguravaju bolju interoperabilnost izme캠u razli캜itih ure캠aja, aplikacija i pru쬬laca usluga, promovi코u캖i besprekornu komunikaciju na razli캜itim platformama.
4. **Modularni dizajn**: SIP radi sa drugim protokolima poput **RTP (Real-time Transport Protocol)** za prenos medija i **SDP (Session Description Protocol)** za opisivanje multimedijalnih sesija. Ovaj modularni dizajn omogu캖ava ve캖u fleksibilnost i kompatibilnost sa razli캜itim tipovima medija i kodeka.
5. **Proxy i Redirect serveri**: SIP mo쬰 koristiti proxy i redirect servere za olak코avanje rutiranja poziva i pru쬬nje naprednih funkcija poput preusmeravanja poziva, transfera poziva i usluga glasovne po코te.
6. **Prisustvo i trenutne poruke**: SIP nije ograni캜en samo na glasovnu i video komunikaciju. Tako캠e podr쬬va prisustvo i trenutne poruke, omogu캖avaju캖i 코irok spektar aplikacija za ujedinjenu komunikaciju.

I pored mnogih prednosti, SIP mo쬰 biti kompleksan za konfigurisanje i upravljanje, posebno kada se suo캜avate sa problemima prolaska kroz NAT i sa firewall-om. Me캠utim, njegova svestranost, skalabilnost i obimna podr코ka u industriji 캜ine ga popularnim izborom za VoIP i multimedijalnu komunikaciju.

### SIP Metode

Osnovne SIP metode definisane u **RFC 3261** uklju캜uju:

1. **INVITE**: Koristi se za **iniciranje nove sesije (poziva)** ili modifikaciju postoje캖e. Metoda INVITE nosi opis sesije (obi캜no koriste캖i SDP) kako bi obavestila primaoca o detaljima predlo쬰ne sesije, poput tipova medija, kodeka i transportnih protokola.
2. **ACK**: Poslat da **potvrdi prijem** kona캜nog odgovora na zahtev INVITE. Metoda ACK osigurava pouzdanost INVITE transakcija pru쬬njem potvrde o kraju do kraja.
3. **BYE**: Koristi se za **prekidanje uspostavljene sesije (poziva)**. Metoda BYE se 코alje od strane bilo koje strane u sesiji kako bi nazna캜ila da 쬰le da zavr코e komunikaciju.
4. **CANCEL**: Poslat da **otka쬰 캜ekaju캖i INVITE** zahtev pre nego 코to sesija bude uspostavljena. Metoda CANCEL omogu캖ava po코iljaocu da prekine INVITE transakciju ako promeni mi코ljenje ili ako nema odgovora od primaoca.
5. **OPTIONS**: Koristi se za **upit o sposobnostima SIP servera ili korisni캜kog agenta**. Metoda OPTIONS mo쬰 biti poslata da zatra쬴 informacije o podr쬬nim metodama, tipovima medija ili drugim pro코irenjima bez stvarnog uspostavljanja sesije.
6. **REGISTER**: Koristi ga korisni캜ki agent da **registruje svoju trenutnu lokaciju sa SIP registrar serverom**. Metoda REGISTER poma쬰 u odr쬬vanju a쬿riranog mapiranja izme캠u korisnikovog SIP URI-ja i njegove trenutne IP adrese, omogu캖avaju캖i rutiranje i dostavu poziva.

{% hint style="warning" %}
Imajte na umu da za pozivanje nekoga **nije neophodno koristiti REGISTER** za bilo 코ta.\
Me캠utim, mogu캖e je da kako bi izvr코io **INVITE** poziva캜 mora **autentifikovati** prvo ili 캖e primiti **`401 Unauthorized`** odgovor.
{% endhint %}

Pored ovih osnovnih metoda, postoje **nekoliko SIP ekstenzija metoda** definisanih u drugim RFC-ovima, kao 코to su:

1. **SUBSCRIBE**: Definisana u RFC 6665, metoda SUBSCRIBE se koristi za **zahtevanje obave코tenja** o stanju odre캠enog resursa, poput prisustva korisnika ili statusa poziva.
2. **NOTIFY**: Tako캠e definisana u RFC 6665, metoda NOTIFY se 코alje od strane servera da **obavesti pretpla캖enog korisni캜kog agenta** o promenama u stanju pra캖enog resursa.
3. **REFER**: Definisana u RFC 3515, metoda REFER se koristi za **zahtev da primalac izvr코i transfer ili uputi na tre캖u stranu**. Ovo se obi캜no koristi za **scenarije transfera poziva**.
4. **MESSAGE**: Definisana u RFC 3428, metoda MESSAGE se koristi za **slanje trenutnih poruka izme캠u SIP korisni캜kih agenata**, omogu캖avaju캖i tekstualnu komunikaciju unutar SIP okvira.
5. **UPDATE**: Definisana u RFC 3311, metoda UPDATE omogu캖ava **modifikaciju sesije bez uticaja na stanje postoje캖eg dijaloga**. Ovo je korisno za a쬿riranje parametara sesije, poput kodeka ili tipova medija, tokom aktivnog poziva.
6. **PUBLISH**: Definisana u RFC 3903, metoda PUBLISH se koristi od strane korisni캜kog agenta da **objavi informacije o stanju doga캠aja serveru**, 캜ine캖i ih dostupnim drugim zainteresovanim stranama.

### Kodovi odgovora SIP-a

* **1xx (Provizorni odgovori)**: Ovi odgovori ukazuju da je zahtev primljen i da server nastavlja da ga obra캠uje.
* 100 Trying: Zahtev je primljen i server radi na njemu.
* 180 Ringing: Pozvani se obave코tava i preuze캖e poziv.
* 183 Session Progress: Pru쬬 informacije o napretku poziva.
* **2xx (Uspe코ni odgovori)**: Ovi odgovori ukazuju da je zahtev uspe코no primljen, razumljen i prihva캖en.
* 200 OK: Zahtev je uspe코an i server ga je ispunio.
* 202 Accepted: Zahtev je prihva캖en za obradu, ali jo코 nije zavr코en.
* **3xx (Odgovori preusmeravanja)**: Ovi odgovori ukazuju da je potrebna dalja akcija da bi se ispunio zahtev, obi캜no kontaktiranjem alternativnog resursa.
* 300 Multiple Choices: Postoje vi코e opcija dostupnih, i korisnik ili klijent mora odabrati jednu.
* 301 Moved Permanently: Tra쬰ni resurs je dodeljen novom trajnom URI-ju.
* 302 Moved Temporarily: Tra쬰ni resurs je privremeno dostupan na drugom URI-ju.
* 305 Use Proxy: Zahtev se mora poslati odre캠enom proksi serveru.
* **4xx (Odgovori gre코ke klijenta)**: Ovi odgovori ukazuju da zahtev sadr쬴 lo코u sintaksu ili ga server ne mo쬰 ispuniti.
* 400 Bad Request: Zahtev je lo코e formiran ili neva쬰캖i.
* 401 Unauthorized: Zahtev zahteva autentifikaciju korisnika.
* 403 Forbidden: Server je razumeo zahtev ali odbija da ga ispuni.
* 404 Not Found: Tra쬰ni resurs nije prona캠en na serveru.
* 408 Request Timeout: Server nije primio kompletan zahtev u vreme koje je bio spreman da 캜eka.
* 486 Busy Here: Pozvani je trenutno zauzet i nije u mogu캖nosti da preuzme poziv.
* **5xx (Odgovori gre코ke servera)**: Ovi odgovori ukazuju da server nije uspeo da ispuni validan zahtev.
* 500 Internal Server Error: Server je nai코ao na gre코ku prilikom obrade zahteva.
* 501 Not Implemented: Server ne podr쬬va funkcionalnost potrebnu za ispunjenje zahteva.
* 503 Service Unavailable: Server trenutno nije u mogu캖nosti da obradi zahtev zbog odr쬬vanja ili preoptere캖enosti.
* **6xx (Globalni odgovori neuspeha)**: Ovi odgovori ukazuju da zahtev ne mo쬰 biti ispunjen od strane bilo kog servera.
* 600 Busy Everywhere: Svi mogu캖i odredi코ta za poziv su zauzeta.
* 603 Decline: Pozvani ne 쬰li da u캜estvuje u pozivu.
* 604 Does Not Exist Anywhere: Tra쬰ni resurs nije dostupan nigde u mre쬴.
## Primeri

### Primer SIP INVITE-a
```
INVITE sip:jdoe@example.com SIP/2.0
Via: SIP/2.0/UDP pc33.example.com;branch=z9hG4bK776asdhds
Max-Forwards: 70
To: John Doe <sip:jdoe@example.com>
From: Jane Smith <sip:jsmith@example.org>;tag=1928301774
Call-ID: a84b4c76e66710
CSeq: 314159 INVITE
Contact: <sip:jsmith@pc33.example.com>
User-Agent: ExampleSIPClient/1.0
Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY, MESSAGE, SUBSCRIBE, INFO
Content-Type: application/sdp
Content-Length: 142

v=0
o=jsmith 2890844526 2890842807 IN IP4 pc33.example.com
s=-
c=IN IP4 pc33.example.com
t=0 0
m=audio 49170 RTP/AVP 0
a=rtpmap:0 PCMU/8000te
```
<details>

<summary>Obja코njenje svakog parametra</summary>

1. **Request-Line**: `INVITE sip:jdoe@example.com SIP/2.0` - Ova linija ozna캜ava metod (INVITE), URI zahteva (sip:[jdoe@example.com](mailto:jdoe@example.com)), i verziju SIP protokola (SIP/2.0).
2. **Via**: `Via: SIP/2.0/UDP pc33.example.com;branch=z9hG4bK776asdhds` - Via zaglavlje specificira transportni protokol (UDP) i adresu klijenta (pc33.example.com). Parametar "branch" se koristi za detekciju petlji i uparivanje transakcija.
3. **Max-Forwards**: `Max-Forwards: 70` - Ovo zaglavlje ograni캜ava broj puta koliko zahtev mo쬰 biti prosle캠en od strane proxy servera kako bi se izbegle beskona캜ne petlje.
4. **To**: `To: John Doe <sip:jdoe@example.com>` - To zaglavlje specificira primaoca poziva, uklju캜uju캖i njihovo prikazano ime (John Doe) i SIP URI (sip:[jdoe@example.com](mailto:jdoe@example.com)).
5. **From**: `From: Jane Smith <sip:jsmith@example.org>;tag=1928301774` - From zaglavlje specificira po코iljaoca poziva, uklju캜uju캖i njihovo prikazano ime (Jane Smith) i SIP URI (sip:[jsmith@example.org](mailto:jsmith@example.org)). Parametar "tag" se koristi za jedinstveno identifikovanje uloge po코iljaoca u dijalogu.
6. **Call-ID**: `Call-ID: a84b4c76e66710` - Call-ID zaglavlje jedinstveno identifikuje sesiju poziva izme캠u dva korisni캜ka agenta.
7. **CSeq**: `CSeq: 314159 INVITE` - CSeq zaglavlje sadr쬴 broj sekvence i metod kori코캖en u zahtevu. Koristi se za uparivanje odgovora na zahteve i detekciju poruka van redosleda.
8. **Contact**: `Contact: <sip:jsmith@pc33.example.com>` - Contact zaglavlje pru쬬 direktnu rutu do po코iljaoca, koja se mo쬰 koristiti za naknadne zahteve i odgovore.
9. **User-Agent**: `User-Agent: ExampleSIPClient/1.0` - User-Agent zaglavlje pru쬬 informacije o softveru ili hardveru po코iljaoca, uklju캜uju캖i njegovo ime i verziju.
10. **Allow**: `Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY, MESSAGE, SUBSCRIBE, INFO` - Allow zaglavlje navodi SIP metode podr쬬ne od strane po코iljaoca. Ovo poma쬰 primaocu da razume koje metode mogu biti kori코캖ene tokom komunikacije.
11. **Content-Type**: `Content-Type: application/sdp` - Content-Type zaglavlje specificira medijum tip poruke, u ovom slu캜aju, SDP (Session Description Protocol).
12. **Content-Length**: `Content-Length: 142` - Content-Length zaglavlje ozna캜ava veli캜inu tela poruke u bajtovima.
13. **Telo poruke**: Telo poruke sadr쬴 SDP opis sesije, koji uklju캜uje informacije o tipovima medija, codec-ima i transportnim protokolima za predlo쬰nu sesiju.

* `v=0` - Verzija protokola (0 za SDP)
* `o=jsmith 2890844526 2890842807 IN IP4 pc33.example.com` - Inicijator i identifikator sesije
* `s=-` - Ime sesije (jedna crtica ozna캜ava da nema imena sesije)
* `c=IN IP4 pc33.example.com` - Informacije o konekciji (tip mre쬰, tip adrese i adresa)
* `t=0 0` - Informacije o vremenu (po캜etak i kraj vremena, 0 0 zna캜i da sesija nije ograni캜ena)
* `m=audio 49170 RTP/AVP 0` - Opis medija (tip medija, broj porta, transportni protokol i lista formata). U ovom slu캜aju, specificira se audio strim kori코캖enjem RTP/AVP (Real-time Transport Protocol / Audio Video Profile) i format 0 (PCMU/8000).
* `a=rtpmap:0 PCMU/8000` - Atribut mapiranja formata (0) na codec (PCMU) i njegovu brzinu takta (8000 Hz).

</details>

### Primer SIP REGISTRACIJE

Metod REGISTER se koristi u Protokolu za inicijaciju sesije (SIP) kako bi omogu캖io korisni캜kom agentu (UA), kao 코to je VoIP telefon ili softver za telefoniranje, da **registruje svoju lokaciju sa SIP registrar serverom**. Ovaj proces omogu캖ava serveru da zna **gde da usmeri dolazne SIP zahteve namenjene registrovanom korisniku**. Registrar server obi캜no 캜ini deo SIP proxy servera ili posebnog serverskog registra.

Evo detaljnog primera SIP poruka uklju캜enih u proces autentifikacije REGISTRACIJE:

1. Po캜etni **REGISTER** zahtev od UA ka registrar serveru:
```yaml
REGISTER sip:example.com SIP/2.0
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
Max-Forwards: 70
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>
Call-ID: 1234567890@192.168.1.100
CSeq: 1 REGISTER
Contact: <sip:alice@192.168.1.100:5060>;expires=3600
Expires: 3600
Content-Length: 0
```
Ova po캜etna REGISTER poruka se 코alje od strane UA (Alice) registrar serveru. Uklju캜uje va쬹e informacije poput 쬰ljenog trajanja registracije (Expires), SIP URI korisnika (sip:[alice@example.com](mailto:alice@example.com)), i korisni캜ku kontakt adresu (sip:alice@192.168.1.100:5060).

2. Odgovor **401 Unauthorized** od registrar servera:
```css
cssCopy codeSIP/2.0 401 Unauthorized
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>;tag=7878744
Call-ID: 1234567890@192.168.1.100
CSeq: 1 REGISTER
WWW-Authenticate: Digest realm="example.com", nonce="abcdefghijk", algorithm=MD5, qop="auth"
Content-Length: 0
```
Registrar server odgovara sa porukom "401 Unauthorized", koja uklju캜uje zaglavlje "WWW-Authenticate". Ovo zaglavlje sadr쬴 informacije potrebne UA da se autentifikuje, kao 코to su **realm autentikacije, nonce i algoritam**.

3. REGISTER zahtev **sa autentifikacionim podacima**:
```vbnet
REGISTER sip:example.com SIP/2.0
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
Max-Forwards: 70
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>
Call-ID: 1234567890@192.168.1.100
CSeq: 2 REGISTER
Contact: <sip:alice@192.168.1.100:5060>;expires=3600
Expires: 3600
Authorization: Digest username="alice", realm="example.com", nonce="abcdefghijk", uri="sip:example.com", response="65a8e2285879283831b664bd8b7f14d4", algorithm=MD5, cnonce="lmnopqrst", qop=auth, nc=00000001
Content-Length: 0
```
UA 코alje jo코 jedan REGISTER zahtev, ovog puta uklju캜uju캖i **"Authorization" zaglavlje sa potrebnim pristupnim podacima, kao 코to su korisni캜ko ime, realm, nonce, i vrednost odgovora** izra캜unata koriste캖i pru쬰ne informacije i korisnikovu lozinku.

Ovako se ra캜una **Authorization odgovor**:
```python
import hashlib

def calculate_sip_md5_response(username, password, realm, method, uri, nonce, nc, cnonce, qop):
# 1. Calculate HA1 (concatenation of username, realm, and password)
ha1_input = f"{username}:{realm}:{password}"
ha1 = hashlib.md5(ha1_input.encode()).hexdigest()

# 2. Calculate HA2 (concatenation of method and uri)
ha2_input = f"{method}:{uri}"
ha2 = hashlib.md5(ha2_input.encode()).hexdigest()

# 3. Calculate the final response value (concatenation of h1, stuff and h2)
response_input = f"{ha1}:{nonce}:{nc}:{cnonce}:{qop}:{ha2}"
response = hashlib.md5(response_input.encode()).hexdigest()

return response

# Example usage
username = "alice"
password = "mysecretpassword"
realm = "example.com"
method = "REGISTER"
uri = "sip:example.com"
nonce = "abcdefghijk"
nc = "00000001"
cnonce = "lmnopqrst"
qop = "auth"

response = calculate_sip_md5_response(username, password, realm, method, uri, nonce, nc, cnonce, qop)
print(f"MD5 response value: {response}")
```
4. **Uspe코an odgovor** na registraciju od servera registrar:
```yaml
SIP/2.0 200 OK
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>;tag=7878744
Call-ID: 1234567890@192.168.1.100
CSeq: 2 REGISTER
Contact: <sip:alice@192.168.1.100:5060>;expires=3600
Expires: 3600
Content-Length: 0
```
Nakon 코to registrar server proveri pru쬰ne akreditive, **코alje "200 OK" odgovor da ozna캜i da je registracija uspe코na**. Odgovor uklju캜uje registrovane kontakt informacije i vreme isteka registracije. U ovom trenutku, korisni캜ki agent (Alice) je uspe코no registrovan sa SIP registrar serverom, i dolazni SIP zahtevi za Alice mogu biti usmereni ka odgovaraju캖oj kontakt adresi.

### Primer poziva

<figure><img src="../../../.gitbook/assets/image (1101).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
Nije pomenuto, ali korisnik B mora da po코alje **REGISTER poruku ka Proxy 2** pre nego 코to mo쬰 primati pozive.
{% endhint %}
