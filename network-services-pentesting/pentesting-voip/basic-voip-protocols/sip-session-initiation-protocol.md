# SIP (Session Initiation Protocol)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
{% endhint %}

## Basic Information

SIP (Session Initiation Protocol) √© um **protocolo de sinaliza√ß√£o e controle de chamadas** amplamente utilizado para estabelecer, modificar e encerrar sess√µes multim√≠dia, incluindo voz, v√≠deo e mensagens instant√¢neas, sobre redes IP. Desenvolvido pelo **Internet Engineering Task Force (IETF)**, o SIP √© definido na **RFC 3261** e se tornou o padr√£o de fato para VoIP e comunica√ß√µes unificadas.

Alguns recursos principais do SIP incluem:

1. **Protocolo Baseado em Texto**: O SIP √© um protocolo baseado em texto, o que o torna leg√≠vel por humanos e mais f√°cil de depurar. Ele √© baseado em um modelo de solicita√ß√£o-resposta, semelhante ao HTTP, e usa m√©todos como INVITE, ACK, BYE e CANCEL para controlar sess√µes de chamadas.
2. **Escalabilidade e Flexibilidade**: O SIP √© altamente escal√°vel e pode ser usado em implanta√ß√µes de pequeno porte, bem como em ambientes empresariais e de operadoras de grande porte. Ele pode ser facilmente estendido com novos recursos, tornando-o adapt√°vel a v√°rios casos de uso e requisitos.
3. **Interoperabilidade**: A ampla ado√ß√£o e padroniza√ß√£o do SIP garantem melhor interoperabilidade entre diferentes dispositivos, aplicativos e provedores de servi√ßos, promovendo comunica√ß√£o sem interrup√ß√µes em v√°rias plataformas.
4. **Design Modular**: O SIP funciona com outros protocolos como **RTP (Real-time Transport Protocol)** para transmiss√£o de m√≠dia e **SDP (Session Description Protocol)** para descrever sess√µes multim√≠dia. Esse design modular permite maior flexibilidade e compatibilidade com diferentes tipos de m√≠dia e codecs.
5. **Servidores Proxy e de Redirecionamento**: O SIP pode usar servidores proxy e de redirecionamento para facilitar o roteamento de chamadas e fornecer recursos avan√ßados como encaminhamento de chamadas, transfer√™ncia de chamadas e servi√ßos de correio de voz.
6. **Presen√ßa e Mensagens Instant√¢neas**: O SIP n√£o se limita √† comunica√ß√£o de voz e v√≠deo. Ele tamb√©m suporta presen√ßa e mensagens instant√¢neas, permitindo uma ampla gama de aplicativos de comunica√ß√£o unificada.

Apesar de suas muitas vantagens, o SIP pode ser complexo de configurar e gerenciar, especialmente ao lidar com problemas de travessia de NAT e firewall. No entanto, sua versatilidade, escalabilidade e amplo suporte na ind√∫stria o tornam uma escolha popular para comunica√ß√£o VoIP e multim√≠dia.

### SIP Methods

Os m√©todos principais do SIP definidos na **RFC 3261** incluem:

1. **INVITE**: Usado para **iniciar uma nova sess√£o (chamada)** ou modificar uma existente. O m√©todo INVITE carrega a descri√ß√£o da sess√£o (tipicamente usando SDP) para informar o destinat√°rio sobre os detalhes da sess√£o proposta, como tipos de m√≠dia, codecs e protocolos de transporte.
2. **ACK**: Enviado para **confirmar o recebimento** de uma resposta final a uma solicita√ß√£o INVITE. O m√©todo ACK garante a confiabilidade das transa√ß√µes INVITE, fornecendo reconhecimento de ponta a ponta.
3. **BYE**: Usado para **encerrar uma sess√£o estabelecida (chamada)**. O m√©todo BYE √© enviado por qualquer uma das partes na sess√£o para indicar que deseja encerrar a comunica√ß√£o.
4. **CANCEL**: Enviado para **cancelar uma solicita√ß√£o INVITE pendente** antes que a sess√£o seja estabelecida. O m√©todo CANCEL permite que o remetente cancele uma transa√ß√£o INVITE se mudar de ideia ou se n√£o houver resposta do destinat√°rio.
5. **OPTIONS**: Usado para **consultar as capacidades de um servidor SIP ou agente de usu√°rio**. O m√©todo OPTIONS pode ser enviado para solicitar informa√ß√µes sobre m√©todos suportados, tipos de m√≠dia ou outras extens√µes sem realmente estabelecer uma sess√£o.
6. **REGISTER**: Usado por um agente de usu√°rio para **registrar sua localiza√ß√£o atual com um servidor registrador SIP**. O m√©todo REGISTER ajuda a manter um mapeamento atualizado entre o URI SIP de um usu√°rio e seu endere√ßo IP atual, permitindo o roteamento e a entrega de chamadas.

{% hint style="warning" %}
Note que para chamar algu√©m **n√£o √© necess√°rio usar o REGISTER** para nada.\
No entanto, √© poss√≠vel que para realizar um **INVITE** o chamador precise **se autenticar** primeiro ou receber√° uma resposta **`401 Unauthorized`**.
{% endhint %}

Al√©m desses m√©todos principais, existem **v√°rios m√©todos de extens√£o SIP** definidos em outras RFCs, como:

1. **SUBSCRIBE**: Definido na RFC 6665, o m√©todo SUBSCRIBE √© usado para **solicitar notifica√ß√µes** sobre o estado de um recurso espec√≠fico, como a presen√ßa ou status de chamada de um usu√°rio.
2. **NOTIFY**: Tamb√©m definido na RFC 6665, o m√©todo NOTIFY √© enviado por um servidor para **informar um agente de usu√°rio inscrito** sobre mudan√ßas no estado de um recurso monitorado.
3. **REFER**: Definido na RFC 3515, o m√©todo REFER √© usado para **solicitar que o destinat√°rio realize uma transfer√™ncia ou se refira a um terceiro**. Isso √© tipicamente usado para cen√°rios de **transfer√™ncia de chamadas**.
4. **MESSAGE**: Definido na RFC 3428, o m√©todo MESSAGE √© usado para **enviar mensagens instant√¢neas entre agentes de usu√°rio SIP**, permitindo comunica√ß√£o baseada em texto dentro da estrutura SIP.
5. **UPDATE**: Definido na RFC 3311, o m√©todo UPDATE permite **modificar uma sess√£o sem afetar o estado do di√°logo existente**. Isso √© √∫til para atualizar par√¢metros de sess√£o, como codecs ou tipos de m√≠dia, durante uma chamada em andamento.
6. **PUBLISH**: Definido na RFC 3903, o m√©todo PUBLISH √© usado por um agente de usu√°rio para **publicar informa√ß√µes de estado de eventos em um servidor**, tornando-as dispon√≠veis para outras partes interessadas.

### SIP Response Codes

* **1xx (Respostas Provis√≥rias)**: Essas respostas indicam que a solicita√ß√£o foi recebida e o servidor est√° continuando a process√°-la.
* 100 Trying: A solicita√ß√£o foi recebida e o servidor est√° trabalhando nela.
* 180 Ringing: O chamado est√° sendo alertado e atender√° a chamada.
* 183 Session Progress: Fornece informa√ß√µes sobre o progresso da chamada.
* **2xx (Respostas de Sucesso)**: Essas respostas indicam que a solicita√ß√£o foi recebida, compreendida e aceita com sucesso.
* 200 OK: A solicita√ß√£o foi bem-sucedida e o servidor a atendeu.
* 202 Accepted: A solicita√ß√£o foi aceita para processamento, mas ainda n√£o foi conclu√≠da.
* **3xx (Respostas de Redirecionamento)**: Essas respostas indicam que mais a√ß√µes s√£o necess√°rias para atender √† solicita√ß√£o, normalmente contatando um recurso alternativo.
* 300 Multiple Choices: Existem v√°rias op√ß√µes dispon√≠veis, e o usu√°rio ou cliente deve escolher uma.
* 301 Moved Permanently: O recurso solicitado foi atribu√≠do a um novo URI permanente.
* 302 Moved Temporarily: O recurso solicitado est√° temporariamente dispon√≠vel em um URI diferente.
* 305 Use Proxy: A solicita√ß√£o deve ser enviada a um proxy especificado.
* **4xx (Respostas de Erro do Cliente)**: Essas respostas indicam que a solicita√ß√£o cont√©m uma sintaxe incorreta ou n√£o pode ser atendida pelo servidor.
* 400 Bad Request: A solicita√ß√£o estava malformada ou inv√°lida.
* 401 Unauthorized: A solicita√ß√£o requer autentica√ß√£o do usu√°rio.
* 403 Forbidden: O servidor entendeu a solicita√ß√£o, mas se recusa a atend√™-la.
* 404 Not Found: O recurso solicitado n√£o foi encontrado no servidor.
* 408 Request Timeout: O servidor n√£o recebeu uma solicita√ß√£o completa dentro do tempo que estava preparado para esperar.
* 486 Busy Here: O chamado est√° atualmente ocupado e n√£o pode atender a chamada.
* **5xx (Respostas de Erro do Servidor)**: Essas respostas indicam que o servidor falhou em atender a uma solicita√ß√£o v√°lida.
* 500 Internal Server Error: O servidor encontrou um erro ao processar a solicita√ß√£o.
* 501 Not Implemented: O servidor n√£o suporta a funcionalidade necess√°ria para atender √† solicita√ß√£o.
* 503 Service Unavailable: O servidor est√° atualmente incapaz de lidar com a solicita√ß√£o devido a manuten√ß√£o ou sobrecarga.
* **6xx (Respostas de Falha Global)**: Essas respostas indicam que a solicita√ß√£o n√£o pode ser atendida por nenhum servidor.
* 600 Busy Everywhere: Todos os destinos poss√≠veis para a chamada est√£o ocupados.
* 603 Decline: O chamado n√£o deseja participar da chamada.
* 604 Does Not Exist Anywhere: O recurso solicitado n√£o est√° dispon√≠vel em nenhum lugar da rede.

## Examples

### SIP INVITE Example
```
INVITE sip:jdoe@example.com SIP/2.0
Via: SIP/2.0/UDP pc33.example.com;branch=z9hG4bK776asdhds
Max-Forwards: 70
To: John Doe <sip:jdoe@example.com>
From: Jane Smith <sip:jsmith@example.org>;tag=1928301774
Call-ID: a84b4c76e66710
CSeq: 314159 INVITE
Contact: <sip:jsmith@pc33.example.com>
User-Agent: ExampleSIPClient/1.0
Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY, MESSAGE, SUBSCRIBE, INFO
Content-Type: application/sdp
Content-Length: 142

v=0
o=jsmith 2890844526 2890842807 IN IP4 pc33.example.com
s=-
c=IN IP4 pc33.example.com
t=0 0
m=audio 49170 RTP/AVP 0
a=rtpmap:0 PCMU/8000te
```
<details>

<summary>Cada Par√¢metro Explicado</summary>

1. **Request-Line**: `INVITE sip:jdoe@example.com SIP/2.0` - Esta linha indica o m√©todo (INVITE), o URI de solicita√ß√£o (sip:[jdoe@example.com](mailto:jdoe@example.com)) e a vers√£o SIP (SIP/2.0).
2. **Via**: `Via: SIP/2.0/UDP pc33.example.com;branch=z9hG4bK776asdhds` - O cabe√ßalho Via especifica o protocolo de transporte (UDP) e o endere√ßo do cliente (pc33.example.com). O par√¢metro "branch" √© usado para detec√ß√£o de loops e correspond√™ncia de transa√ß√µes.
3. **Max-Forwards**: `Max-Forwards: 70` - Este campo de cabe√ßalho limita o n√∫mero de vezes que a solicita√ß√£o pode ser encaminhada por proxies para evitar loops infinitos.
4. **To**: `To: John Doe <sip:jdoe@example.com>` - O cabe√ßalho To especifica o destinat√°rio da chamada, incluindo seu nome de exibi√ß√£o (John Doe) e URI SIP (sip:[jdoe@example.com](mailto:jdoe@example.com)).
5. **From**: `From: Jane Smith <sip:jsmith@example.org>;tag=1928301774` - O cabe√ßalho From especifica o remetente da chamada, incluindo seu nome de exibi√ß√£o (Jane Smith) e URI SIP (sip:[jsmith@example.org](mailto:jsmith@example.org)). O par√¢metro "tag" √© usado para identificar exclusivamente o papel do remetente no di√°logo.
6. **Call-ID**: `Call-ID: a84b4c76e66710` - O cabe√ßalho Call-ID identifica exclusivamente uma sess√£o de chamada entre dois agentes de usu√°rio.
7. **CSeq**: `CSeq: 314159 INVITE` - O cabe√ßalho CSeq cont√©m um n√∫mero de sequ√™ncia e o m√©todo usado na solicita√ß√£o. √â usado para corresponder respostas a solicita√ß√µes e detectar mensagens fora de ordem.
8. **Contact**: `Contact: <sip:jsmith@pc33.example.com>` - O cabe√ßalho Contact fornece uma rota direta para o remetente, que pode ser usada para solicita√ß√µes e respostas subsequentes.
9. **User-Agent**: `User-Agent: ExampleSIPClient/1.0` - O cabe√ßalho User-Agent fornece informa√ß√µes sobre o software ou hardware do remetente, incluindo seu nome e vers√£o.
10. **Allow**: `Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY, MESSAGE, SUBSCRIBE, INFO` - O cabe√ßalho Allow lista os m√©todos SIP suportados pelo remetente. Isso ajuda o destinat√°rio a entender quais m√©todos podem ser usados durante a comunica√ß√£o.
11. **Content-Type**: `Content-Type: application/sdp` - O cabe√ßalho Content-Type especifica o tipo de m√≠dia do corpo da mensagem, neste caso, SDP (Session Description Protocol).
12. **Content-Length**: `Content-Length: 142` - O cabe√ßalho Content-Length indica o tamanho do corpo da mensagem em bytes.
13. **Message Body**: O corpo da mensagem cont√©m a descri√ß√£o da sess√£o SDP, que inclui informa√ß√µes sobre os tipos de m√≠dia, codecs e protocolos de transporte para a sess√£o proposta.

* `v=0` - Vers√£o do protocolo (0 para SDP)
* `o=jsmith 2890844526 2890842807 IN IP4 pc33.example.com` - Originador e identificador da sess√£o
* `s=-` - Nome da sess√£o (um √∫nico h√≠fen indica que n√£o h√° nome de sess√£o)
* `c=IN IP4 pc33.example.com` - Informa√ß√µes de conex√£o (tipo de rede, tipo de endere√ßo e endere√ßo)
* `t=0 0` - Informa√ß√µes de tempo (hor√°rios de in√≠cio e parada, 0 0 significa que a sess√£o n√£o est√° limitada)
* `m=audio 49170 RTP/AVP 0` - Descri√ß√£o da m√≠dia (tipo de m√≠dia, n√∫mero da porta, protocolo de transporte e lista de formatos). Neste caso, especifica um fluxo de √°udio usando RTP/AVP (Real-time Transport Protocol / Audio Video Profile) e formato 0 (PCMU/8000).
* `a=rtpmap:0 PCMU/8000` - Mapeamento de atributo do formato (0) para o codec (PCMU) e sua taxa de clock (8000 Hz).

</details>

### Exemplo de SIP REGISTER

O m√©todo REGISTER √© usado no Protocolo de Inicia√ß√£o de Sess√£o (SIP) para permitir que um agente de usu√°rio (UA), como um telefone VoIP ou um softphone, **registre sua localiza√ß√£o em um servidor registrador SIP**. Este processo informa ao servidor **onde encaminhar as solicita√ß√µes SIP recebidas destinadas ao usu√°rio registrado**. O servidor registrador geralmente faz parte de um servidor proxy SIP ou de um servidor de registro dedicado.

Aqui est√° um exemplo detalhado das mensagens SIP envolvidas em um processo de autentica√ß√£o REGISTER:

1. Solicita√ß√£o inicial **REGISTER** do UA para o servidor registrador:
```yaml
REGISTER sip:example.com SIP/2.0
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
Max-Forwards: 70
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>
Call-ID: 1234567890@192.168.1.100
CSeq: 1 REGISTER
Contact: <sip:alice@192.168.1.100:5060>;expires=3600
Expires: 3600
Content-Length: 0
```
Esta mensagem inicial de REGISTER √© enviada pelo UA (Alice) para o servidor registrador. Ela inclui informa√ß√µes importantes, como a dura√ß√£o de registro desejada (Expires), o URI SIP do usu√°rio (sip:[alice@example.com](mailto:alice@example.com)) e o endere√ßo de contato do usu√°rio (sip:alice@192.168.1.100:5060).

2. **401 Unauthorized** resposta do servidor registrador:
```css
cssCopy codeSIP/2.0 401 Unauthorized
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>;tag=7878744
Call-ID: 1234567890@192.168.1.100
CSeq: 1 REGISTER
WWW-Authenticate: Digest realm="example.com", nonce="abcdefghijk", algorithm=MD5, qop="auth"
Content-Length: 0
```
O servidor registrador responde com uma mensagem "401 Unauthorized", que inclui um cabe√ßalho "WWW-Authenticate". Este cabe√ßalho cont√©m informa√ß√µes necess√°rias para que o UA se autentique, como o **dom√≠nio de autentica√ß√£o, nonce e algoritmo**.

3. Solicita√ß√£o REGISTER **com credenciais de autentica√ß√£o**:
```vbnet
REGISTER sip:example.com SIP/2.0
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
Max-Forwards: 70
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>
Call-ID: 1234567890@192.168.1.100
CSeq: 2 REGISTER
Contact: <sip:alice@192.168.1.100:5060>;expires=3600
Expires: 3600
Authorization: Digest username="alice", realm="example.com", nonce="abcdefghijk", uri="sip:example.com", response="65a8e2285879283831b664bd8b7f14d4", algorithm=MD5, cnonce="lmnopqrst", qop=auth, nc=00000001
Content-Length: 0
```
O UA envia outra solicita√ß√£o REGISTER, desta vez incluindo o **cabe√ßalho "Authorization" com as credenciais necess√°rias, como o nome de usu√°rio, realm, nonce e um valor de resposta** calculado usando as informa√ß√µes fornecidas e a senha do usu√°rio.

√â assim que a **resposta de Authorization** √© calculada:
```python
import hashlib

def calculate_sip_md5_response(username, password, realm, method, uri, nonce, nc, cnonce, qop):
# 1. Calculate HA1 (concatenation of username, realm, and password)
ha1_input = f"{username}:{realm}:{password}"
ha1 = hashlib.md5(ha1_input.encode()).hexdigest()

# 2. Calculate HA2 (concatenation of method and uri)
ha2_input = f"{method}:{uri}"
ha2 = hashlib.md5(ha2_input.encode()).hexdigest()

# 3. Calculate the final response value (concatenation of h1, stuff and h2)
response_input = f"{ha1}:{nonce}:{nc}:{cnonce}:{qop}:{ha2}"
response = hashlib.md5(response_input.encode()).hexdigest()

return response

# Example usage
username = "alice"
password = "mysecretpassword"
realm = "example.com"
method = "REGISTER"
uri = "sip:example.com"
nonce = "abcdefghijk"
nc = "00000001"
cnonce = "lmnopqrst"
qop = "auth"

response = calculate_sip_md5_response(username, password, realm, method, uri, nonce, nc, cnonce, qop)
print(f"MD5 response value: {response}")
```
4. **Resposta de registro bem-sucedido** do servidor registrador:
```yaml
SIP/2.0 200 OK
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>;tag=7878744
Call-ID: 1234567890@192.168.1.100
CSeq: 2 REGISTER
Contact: <sip:alice@192.168.1.100:5060>;expires=3600
Expires: 3600
Content-Length: 0
```
Ap√≥s o servidor registrador verificar as credenciais fornecidas, **ele envia uma resposta "200 OK" para indicar que o registro foi bem-sucedido**. A resposta inclui as informa√ß√µes de contato registradas e o tempo de expira√ß√£o para o registro. Neste ponto, o agente do usu√°rio (Alice) est√° registrado com sucesso no servidor registrador SIP, e as solicita√ß√µes SIP recebidas para Alice podem ser roteadas para o endere√ßo de contato apropriado.

### Exemplo de Chamada

<figure><img src="../../../.gitbook/assets/image (1101).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
N√£o √© mencionado, mas o Usu√°rio B precisa ter enviado uma **mensagem REGISTER para o Proxy 2** antes de poder receber chamadas.
{% endhint %}
{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
</details>
{% endhint %}
