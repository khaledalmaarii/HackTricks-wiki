# Nginx

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="../../.gitbook/assets/image (14) (1).png" alt=""><figcaption></figcaption></figure>

**рдХрдордЬреЛрд░реА рдореВрд▓реНрдпрд╛рдВрдХрди рдФрд░ рдкреЗрдирдЯреЗрд╕реНрдЯрд┐рдВрдЧ рдХреЗ рд▓рд┐рдП рддреБрд░рдВрдд рдЙрдкрд▓рдмреНрдз рд╕реЗрдЯрдЕрдк**ред рдХрд╣реАрдВ рд╕реЗ рднреА 20+ рдЙрдкрдХрд░рдгреЛрдВ рдФрд░ рд╕реБрд╡рд┐рдзрд╛рдУрдВ рдХреЗ рд╕рд╛рде рдПрдХ рдкреВрд░реНрдг рдкреЗрдВрдЯреЗрд╕реНрдЯ рдЪрд▓рд╛рдПрдБ рдЬреЛ рдкреБрдирдГ рдЦреЛрдЬ рд╕реЗ рд░рд┐рдкреЛрд░реНрдЯрд┐рдВрдЧ рддрдХ рдЬрд╛рддреЗ рд╣реИрдВред рд╣рдо рдкреЗрдВрдЯреЗрд╕реНрдЯрд░реНрд╕ рдХрд╛ рд╕реНрдерд╛рди рдирд╣реАрдВ рд▓реЗрддреЗ - рд╣рдо рдХрд╕реНрдЯрдо рдЙрдкрдХрд░рдг, рдкрд╣рдЪрд╛рди рдФрд░ рд╢реЛрд╖рдг рдореЙрдбреНрдпреВрд▓ рд╡рд┐рдХрд╕рд┐рдд рдХрд░рддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рдЙрдиреНрд╣реЗрдВ рдЧрд╣рд░рд╛рдИ рд╕реЗ рдЦреБрджрд╛рдИ рдХрд░рдиреЗ, рд╢реЗрд▓ рдкреЙрдк рдХрд░рдиреЗ рдФрд░ рдордЬрд╝реЗ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреБрдЫ рд╕рдордп рд╡рд╛рдкрд╕ рдорд┐рд▓ рд╕рдХреЗред

{% embed url="https://pentest-tools.com/?utm_term=jul2024&utm_medium=link&utm_source=hacktricks&utm_campaign=spons" %}

## Missing root location <a href="#missing-root-location" id="missing-root-location"></a>

рдЬрдм Nginx рд╕рд░реНрд╡рд░ рдХреЛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ **рд░реВрдЯ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛** рдПрдХ рдорд╣рддреНрд╡рдкреВрд░реНрдг рднреВрдорд┐рдХрд╛ рдирд┐рднрд╛рддреА рд╣реИ, рдЬреЛ рдЙрд╕ рдореВрд▓ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдХреЛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░рддреА рд╣реИ рдЬрд┐рд╕рд╕реЗ рдлрд╝рд╛рдЗрд▓реЗрдВ рд╕рд░реНрд╡ рдХреА рдЬрд╛рддреА рд╣реИрдВред рдиреАрдЪреЗ рджрд┐рдП рдЧрдП рдЙрджрд╛рд╣рд░рдг рдкрд░ рд╡рд┐рдЪрд╛рд░ рдХрд░реЗрдВ:
```bash
server {
root /etc/nginx;

location /hello.txt {
try_files $uri $uri/ =404;
proxy_pass http://127.0.0.1:8080/;
}
}
```
рдЗрд╕ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдореЗрдВ, `/etc/nginx` рдХреЛ рд░реВрдЯ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдХреЗ рд░реВрдк рдореЗрдВ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред рдпрд╣ рд╕реЗрдЯрдЕрдк рдирд┐рд░реНрджрд┐рд╖реНрдЯ рд░реВрдЯ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдХреЗ рднреАрддрд░ рдлрд╝рд╛рдЗрд▓реЛрдВ рддрдХ рдкрд╣реБрдБрдЪ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рдЬреИрд╕реЗ рдХрд┐ `/hello.txt`ред рд╣рд╛рд▓рд╛рдБрдХрд┐, рдпрд╣ рдзреНрдпрд╛рди рд░рдЦрдирд╛ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИ рдХрд┐ рдХреЗрд╡рд▓ рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ рд╕реНрдерд╛рди (`/hello.txt`) рдХреЛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред рд░реВрдЯ рд╕реНрдерд╛рди (`location / {...}`) рдХреЗ рд▓рд┐рдП рдХреЛрдИ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдирд╣реАрдВ рд╣реИред рдЗрд╕ рдЪреВрдХ рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рд░реВрдЯ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рд╡реИрд╢реНрд╡рд┐рдХ рд░реВрдк рд╕реЗ рд▓рд╛рдЧреВ рд╣реЛрддреА рд╣реИ, рдЬрд┐рд╕рд╕реЗ рд░реВрдЯ рдкрде `/` рдкрд░ рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЛ `/etc/nginx` рдХреЗ рддрд╣рдд рдлрд╝рд╛рдЗрд▓реЛрдВ рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдорд┐рд▓рддреА рд╣реИред

рдЗрд╕ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рд╕реЗ рдПрдХ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╕реБрд░рдХреНрд╖рд╛ рд╡рд┐рдЪрд╛рд░ рдЙрддреНрдкрдиреНрди рд╣реЛрддрд╛ рд╣реИред рдПрдХ рд╕рд╛рдзрд╛рд░рдг `GET` рдЕрдиреБрд░реЛрдз, рдЬреИрд╕реЗ `GET /nginx.conf`, рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдЬрд╛рдирдХрд╛рд░реА рдХреЛ рдЙрдЬрд╛рдЧрд░ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ `/etc/nginx/nginx.conf` рдореЗрдВ рд╕реНрдерд┐рдд Nginx рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдлрд╝рд╛рдЗрд▓ рдХреЛ рд╕рд░реНрд╡ рдХрд░рддрд╛ рд╣реИред рд░реВрдЯ рдХреЛ рдХрдо рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛, рдЬреИрд╕реЗ `/etc`, рдкрд░ рд╕реЗрдЯ рдХрд░рдирд╛ рдЗрд╕ рдЬреЛрдЦрд┐рдо рдХреЛ рдХрдо рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рдлрд┐рд░ рднреА рдпрд╣ рдЕрдиреНрдп рдорд╣рддреНрд╡рдкреВрд░реНрдг рдлрд╝рд╛рдЗрд▓реЛрдВ, рдЬрд┐рд╕рдореЗрдВ рдЕрдиреНрдп рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдлрд╝рд╛рдЗрд▓реЗрдВ, рдПрдХреНрд╕реЗрд╕ рд▓реЙрдЧ, рдФрд░ рдпрд╣рд╛рдВ рддрдХ рдХрд┐ HTTP рдмреЗрд╕рд┐рдХ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХреА рдЬрд╛рдиреЗ рд╡рд╛рд▓реА рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рддрдХ рдЕрдирдкреЗрдХреНрд╖рд┐рдд рдкрд╣реБрдБрдЪ рдХреА рдЕрдиреБрдорддрд┐ рджреЗ рд╕рдХрддрд╛ рд╣реИред

## Alias LFI Misconfiguration <a href="#alias-lfi-misconfiguration" id="alias-lfi-misconfiguration"></a>

Nginx рдХреЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдлрд╝рд╛рдЗрд▓реЛрдВ рдореЗрдВ, "location" рдирд┐рд░реНрджреЗрд╢реЛрдВ рдХреЗ рд▓рд┐рдП рдПрдХ рдХрд░реАрдмреА рдирд┐рд░реАрдХреНрд╖рдг рдЖрд╡рд╢реНрдпрдХ рд╣реИред рдПрдХ рднреЗрджреНрдпрддрд╛ рдЬрд┐рд╕реЗ рд▓реЛрдХрд▓ рдлрд╝рд╛рдЗрд▓ рд╕рдорд╛рд╡реЗрд╢рди (LFI) рдХреЗ рд░реВрдк рдореЗрдВ рдЬрд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИ, рдПрдХ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЕрдирдЬрд╛рдиреЗ рдореЗрдВ рдкреЗрд╢ рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИ рдЬреЛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЗ рд╕рдорд╛рди рд╣реИ:
```
location /imgs {
alias /path/images/;
}
```
рдпрд╣ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди LFI рд╣рдорд▓реЛрдВ рдХреЗ рдкреНрд░рддрд┐ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рд╕рд░реНрд╡рд░ `/imgs../flag.txt` рдЬреИрд╕реЗ рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЛ рд▓рдХреНрд╖рд┐рдд рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдХреЗ рдмрд╛рд╣рд░ рдлрд╝рд╛рдЗрд▓реЛрдВ рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХреЗ рдкреНрд░рдпрд╛рд╕ рдХреЗ рд░реВрдк рдореЗрдВ рд╡реНрдпрд╛рдЦреНрдпрд╛ рдХрд░рддрд╛ рд╣реИ, рдЬреЛ рдкреНрд░рднрд╛рд╡реА рд░реВрдк рд╕реЗ `/path/images/../flag.txt` рдореЗрдВ рд╣рд▓ рд╣реЛрддрд╛ рд╣реИред рдпрд╣ рджреЛрд╖ рд╣рдорд▓рд╛рд╡рд░реЛрдВ рдХреЛ рд╕рд░реНрд╡рд░ рдХреА рдлрд╝рд╛рдЗрд▓ рдкреНрд░рдгрд╛рд▓реА рд╕реЗ рдлрд╝рд╛рдЗрд▓реЗрдВ рдкреБрдирдГ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ рдЬреЛ рд╡реЗрдм рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╕реБрд▓рдн рдирд╣реАрдВ рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдПред

рдЗрд╕ рднреЗрджреНрдпрддрд╛ рдХреЛ рдХрдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЛ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рд╕рдорд╛рдпреЛрдЬрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП:
```
location /imgs/ {
alias /path/images/;
}
```
рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА: [https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/](https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/)

Accunetix рдкрд░реАрдХреНрд╖рдг:
```
alias../ => HTTP status code 403
alias.../ => HTTP status code 404
alias../../ => HTTP status code 403
alias../../../../../../../../../../../ => HTTP status code 400
alias../ => HTTP status code 403
```
## Unsafe path restriction <a href="#unsafe-variable-use" id="unsafe-variable-use"></a>

рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдкреГрд╖реНрда рдкрд░ рдЬрд╛рдПрдВ рдпрд╣ рдЬрд╛рдирдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐ рдирд┐рд░реНрджреЗрд╢реЛрдВ рдХреЛ рдХреИрд╕реЗ рдмрд╛рдпрдкрд╛рд╕ рдХрд┐рдпрд╛ рдЬрд╛рдП рдЬреИрд╕реЗ:
```plaintext
location = /admin {
deny all;
}

location = /admin/ {
deny all;
}
```
{% content-ref url="../../pentesting-web/proxy-waf-protections-bypass.md" %}
[proxy-waf-protections-bypass.md](../../pentesting-web/proxy-waf-protections-bypass.md)
{% endcontent-ref %}

## рдЕрд╕реБрд░рдХреНрд╖рд┐рдд рд╡реЗрд░рд┐рдПрдмрд▓ рдЙрдкрдпреЛрдЧ / HTTP рдЕрдиреБрд░реЛрдз рд╡рд┐рднрд╛рдЬрди <a href="#unsafe-variable-use" id="unsafe-variable-use"></a>

{% hint style="danger" %}
рдХрдордЬреЛрд░ рд╡реЗрд░рд┐рдПрдмрд▓ `$uri` рдФрд░ `$document_uri` рд╣реИрдВ рдФрд░ рдЗрд╕реЗ `$request_uri` рдХреЗ рд╕рд╛рде рдмрджрд▓рдХрд░ рдареАрдХ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

рдПрдХ regex рднреА рдХрдордЬреЛрд░ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ рдЬреИрд╕реЗ:

`location ~ /docs/([^/])? { тАж $1 тАж }` - рдХрдордЬреЛрд░&#x20;

`location ~ /docs/([^/\s])? { тАж $1 тАж }` - рдХрдордЬреЛрд░ рдирд╣реАрдВ (рд╕реНрдкреЗрд╕ рдХреА рдЬрд╛рдВрдЪ рдХрд░ рд░рд╣рд╛ рд╣реИ)

`location ~ /docs/(.*)? { тАж $1 тАж }`  - рдХрдордЬреЛрд░ рдирд╣реАрдВ
{% endhint %}

Nginx рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдореЗрдВ рдПрдХ рдХрдордЬреЛрд░реА рдиреАрдЪреЗ рджрд┐рдП рдЧрдП рдЙрджрд╛рд╣рд░рдг рджреНрд╡рд╛рд░рд╛ рдкреНрд░рджрд░реНрд╢рд┐рдд рдХреА рдЧрдИ рд╣реИ:
```
location / {
return 302 https://example.com$uri;
}
```
HTTP рдЕрдиреБрд░реЛрдзреЛрдВ рдореЗрдВ \r (Carriage Return) рдФрд░ \n (Line Feed) рдирдП рд▓рд╛рдЗрди рд╡рд░реНрдгреЛрдВ рдХрд╛ рд╕рдВрдХреЗрдд рджреЗрддреЗ рд╣реИрдВ, рдФрд░ рдЙрдирдХреЗ URL-рдХреЛрдбрд┐рдд рд░реВрдк `%0d%0a` рдХреЗ рд░реВрдк рдореЗрдВ рджрд░реНрд╢рд╛рдП рдЬрд╛рддреЗ рд╣реИрдВред рдПрдХ рдЕрдиреБрд░реЛрдз рдореЗрдВ рдЗрди рд╡рд░реНрдгреЛрдВ рдХреЛ рд╢рд╛рдорд┐рд▓ рдХрд░рдиреЗ рд╕реЗ (рдЬреИрд╕реЗ, `http://localhost/%0d%0aDetectify:%20clrf`) рдПрдХ рдЧрд▓рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдП рдЧрдП рд╕рд░реНрд╡рд░ рдкрд░ рд╕рд░реНрд╡рд░ рдПрдХ рдирдП рд╣реЗрдбрд░ рдХрд╛ рдирд╛рдо `Detectify` рдЬрд╛рд░реА рдХрд░рддрд╛ рд╣реИред рдпрд╣ рдЗрд╕рд▓рд┐рдП рд╣реЛрддрд╛ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ $uri рд╡реЗрд░рд┐рдПрдмрд▓ URL-рдХреЛрдбрд┐рдд рдирдП рд▓рд╛рдЗрди рд╡рд░реНрдгреЛрдВ рдХреЛ рдбрд┐рдХреЛрдб рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдореЗрдВ рдПрдХ рдЕрдкреНрд░рддреНрдпрд╛рд╢рд┐рдд рд╣реЗрдбрд░ рдЙрддреНрдкрдиреНрди рд╣реЛрддрд╛ рд╣реИ:
```
HTTP/1.1 302 Moved Temporarily
Server: nginx/1.19.3
Content-Type: text/html
Content-Length: 145
Connection: keep-alive
Location: https://example.com/
Detectify: clrf
```
CRLF рдЗрдВрдЬреЗрдХреНрд╢рди рдФрд░ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рд╡рд┐рднрд╛рдЬрди рдХреЗ рдЬреЛрдЦрд┐рдореЛрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдиреЗрдВ [https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/](https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/) рдкрд░ред

рдпрд╣ рддрдХрдиреАрдХ [**рдЗрд╕ рд╡рд╛рд░реНрддрд╛ рдореЗрдВ рд╕рдордЭрд╛рдИ рдЧрдИ рд╣реИ**](https://www.youtube.com/watch?v=gWQyWdZbdoY\&list=PL0xCSYnG\_iTtJe2V6PQqamBF73n7-f1Nr\&index=77) рдЬрд┐рд╕рдореЗрдВ рдХреБрдЫ рдХрдордЬреЛрд░ рдЙрджрд╛рд╣рд░рдг рдФрд░ рдкрд╣рдЪрд╛рди рддрдВрддреНрд░ рд╣реИрдВред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдПрдХ рдмреНрд▓реИрдХрдмреЙрдХреНрд╕ рдкрд░рд┐рдкреНрд░реЗрдХреНрд╖реНрдп рд╕реЗ рдЗрд╕ рдЧрд▓рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдк рдпреЗ рдЕрдиреБрд░реЛрдз рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

* `https://example.com/%20X` - рдХреЛрдИ рднреА HTTP рдХреЛрдб
* `https://example.com/%20H` - 400 рдЦрд░рд╛рдм рдЕрдиреБрд░реЛрдз

рдпрджрд┐ рдХрдордЬреЛрд░ рд╣реИ, рддреЛ рдкрд╣рд▓рд╛ "X" рдХреЗ рд░реВрдк рдореЗрдВ рд▓реМрдЯреЗрдЧрд╛ рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рдХреЛрдИ рднреА HTTP рд╡рд┐рдзрд┐ рд╣реИ рдФрд░ рджреВрд╕рд░рд╛ рдПрдХ рддреНрд░реБрдЯрд┐ рд▓реМрдЯрд╛рдПрдЧрд╛ рдХреНрдпреЛрдВрдХрд┐ H рдПрдХ рдорд╛рдиреНрдп рд╡рд┐рдзрд┐ рдирд╣реАрдВ рд╣реИред рдЗрд╕рд▓рд┐рдП рд╕рд░реНрд╡рд░ рдХреЛ рдХреБрдЫ рдЗрд╕ рддрд░рд╣ рдкреНрд░рд╛рдкреНрдд рд╣реЛрдЧрд╛: `GET / H HTTP/1.1` рдФрд░ рдпрд╣ рддреНрд░реБрдЯрд┐ рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд░реЗрдЧрд╛ред

рдЕрдиреНрдп рдкрд╣рдЪрд╛рди рдЙрджрд╛рд╣рд░рдг рд╣реЛрдВрдЧреЗ:

* `http://company.tld/%20HTTP/1.1%0D%0AXXXX:%20x` - рдХреЛрдИ рднреА HTTP рдХреЛрдб
* `http://company.tld/%20HTTP/1.1%0D%0AHost:%20x` - 400 рдЦрд░рд╛рдм рдЕрдиреБрд░реЛрдз

рдЙрд╕ рд╡рд╛рд░реНрддрд╛ рдореЗрдВ рдкреНрд░рд╕реНрддреБрдд рдХреБрдЫ рдХрдордЬреЛрд░ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдереЗ:

* рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ **`$uri`** рдЕрдВрддрд┐рдо URL рдореЗрдВ рдЬреИрд╕рд╛ рд╣реИ рд╡реИрд╕рд╛ рд╣реА рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ
```
location ^~ /lite/api/ {
proxy_pass http://lite-backend$uri$is_args$args;
}
```
* рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдлрд┐рд░ рд╕реЗ **`$uri`** URL рдореЗрдВ рд╣реИ (рдЗрд╕ рдмрд╛рд░ рдПрдХ рдкреИрд░рд╛рдореАрдЯрд░ рдХреЗ рдЕрдВрджрд░)
```
location ~ ^/dna/payment {
rewrite ^/dna/([^/]+) /registered/main.pl?cmd=unifiedPayment&context=$1&native_uri=$uri break;
proxy_pass http://$back;
```
* рдЕрдм AWS S3 рдореЗрдВ
```
location /s3/ {
proxy_pass https://company-bucket.s3.amazonaws.com$uri;
}
```
### Any variable

рдпрд╣ рдкрд╛рдпрд╛ рдЧрдпрд╛ рдХрд┐ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛-рдкреНрд░рджрддреНрдд рдбреЗрдЯрд╛** рдХреБрдЫ рдкрд░рд┐рд╕реНрдерд┐рддрд┐рдпреЛрдВ рдореЗрдВ **Nginx рд╡реЗрд░рд┐рдПрдмрд▓** рдХреЗ рд░реВрдк рдореЗрдВ рдорд╛рдирд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдЗрд╕ рд╡реНрдпрд╡рд╣рд╛рд░ рдХрд╛ рдХрд╛рд░рдг рдХреБрдЫ рд╣рдж рддрдХ рдЕрд╕реНрдкрд╖реНрдЯ рд╣реИ, рдлрд┐рд░ рднреА рдпрд╣ рди рддреЛ рджреБрд░реНрд▓рдн рд╣реИ рдФрд░ рди рд╣реА рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░рдирд╛ рд╕реАрдзрд╛ рд╣реИред рдЗрд╕ рд╡рд┐рд╕рдВрдЧрддрд┐ рдХреЛ HackerOne рдкрд░ рдПрдХ рд╕реБрд░рдХреНрд╖рд╛ рд░рд┐рдкреЛрд░реНрдЯ рдореЗрдВ рдЙрдЬрд╛рдЧрд░ рдХрд┐рдпрд╛ рдЧрдпрд╛, рдЬрд┐рд╕реЗ [рдпрд╣рд╛рдБ](https://hackerone.com/reports/370094) рджреЗрдЦрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рддреНрд░реБрдЯрд┐ рд╕рдВрджреЗрд╢ рдХреА рдЖрдЧреЗ рдХреА рдЬрд╛рдВрдЪ рдиреЗ [Nginx рдХреЗ рдХреЛрдбрдмреЗрд╕ рдХреЗ SSI рдлрд╝рд┐рд▓реНрдЯрд░ рдореЙрдбреНрдпреВрд▓](https://github.com/nginx/nginx/blob/2187586207e1465d289ae64cedc829719a048a39/src/http/modules/ngx_http_ssi_filter_module.c#L365) рдХреЗ рднреАрддрд░ рдЗрд╕рдХреА рдЙрдкрд╕реНрдерд┐рддрд┐ рдХреА рдкрд╣рдЪрд╛рди рдХреА, рдЬрд┐рд╕рд╕реЗ рд╕рд░реНрд╡рд░ рд╕рд╛рдЗрдб рдЗрдирдХреНрд▓реВрдбреНрд╕ (SSI) рдХреЛ рдореВрд▓ рдХрд╛рд░рдг рдХреЗ рд░реВрдк рдореЗрдВ рдЗрдВрдЧрд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ред

рдЗрд╕ **рдЧрд▓рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рдиреЗ** рдХреЗ рд▓рд┐рдП, рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрдорд╛рдВрдб рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИ, рдЬрд┐рд╕рдореЗрдВ рд╡реЗрд░рд┐рдПрдмрд▓ рдкреНрд░рд┐рдВрдЯрд┐рдВрдЧ рдХреЗ рд▓рд┐рдП рдПрдХ рд░реЗрдлрд░рд░ рд╣реЗрдбрд░ рд╕реЗрдЯ рдХрд░рдирд╛ рд╢рд╛рдорд┐рд▓ рд╣реИ:
```bash
$ curl -H тАШReferer: barтАЩ http://localhost/foo$http_referer | grep тАШfoobarтАЩ
```
рдЗрд╕ misconfiguration рдХреЗ рд▓рд┐рдП рд╕рд┐рд╕реНрдЯрдореЛрдВ рдореЗрдВ рд╕реНрдХреИрди рдХрд░рдиреЗ рдкрд░ рдХрдИ рдЙрджрд╛рд╣рд░рдг рд╕рд╛рдордиреЗ рдЖрдП рдЬрд╣рд╛рдБ Nginx рд╡реЗрд░рд┐рдПрдмрд▓реНрд╕ рдХреЛ рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рджреНрд╡рд╛рд░рд╛ рдкреНрд░рд┐рдВрдЯ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рдерд╛ред рд╣рд╛рд▓рд╛рдБрдХрд┐, рдХрдордЬреЛрд░ рдЙрджрд╛рд╣рд░рдгреЛрдВ рдХреА рд╕рдВрдЦреНрдпрд╛ рдореЗрдВ рдХрдореА рдпрд╣ рд╕реБрдЭрд╛рд╡ рджреЗрддреА рд╣реИ рдХрд┐ рдЗрд╕ рд╕рдорд╕реНрдпрд╛ рдХреЛ рдкреИрдЪ рдХрд░рдиреЗ рдХреЗ рдкреНрд░рдпрд╛рд╕ рдХреБрдЫ рд╣рдж рддрдХ рд╕рдлрд▓ рд░рд╣реЗ рд╣реИрдВред

## рдХрдЪреНрдЪреЗ рдмреИрдХрдПрдВрдб рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдкрдврд╝рдирд╛

Nginx рдПрдХ рдлреАрдЪрд░ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ `proxy_pass` рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЬреЛ рдмреИрдХрдПрдВрдб рджреНрд╡рд╛рд░рд╛ рдЙрддреНрдкрдиреНрди рддреНрд░реБрдЯрд┐рдпреЛрдВ рдФрд░ HTTP рд╣реЗрдбрд░ рдХреЗ рдЗрдВрдЯрд░рд╕реЗрдкреНрд╢рди рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рдЬрд┐рд╕рдХрд╛ рдЙрджреНрджреЗрд╢реНрдп рдЖрдВрддрд░рд┐рдХ рддреНрд░реБрдЯрд┐ рд╕рдВрджреЗрд╢реЛрдВ рдФрд░ рд╣реЗрдбрд░ рдХреЛ рдЫрд┐рдкрд╛рдирд╛ рд╣реИред рдпрд╣ Nginx рджреНрд╡рд╛рд░рд╛ рдмреИрдХрдПрдВрдб рддреНрд░реБрдЯрд┐рдпреЛрдВ рдХреЗ рдЬрд╡рд╛рдм рдореЗрдВ рдХрд╕реНрдЯрдо рддреНрд░реБрдЯрд┐ рдкреГрд╖реНрдареЛрдВ рдХреЛ рд╕рд░реНрд╡ рдХрд░рдХреЗ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рд╣рд╛рд▓рд╛рдБрдХрд┐, рдЬрдм Nginx рдПрдХ рдЕрдорд╛рдиреНрдп HTTP рдЕрдиреБрд░реЛрдз рдХрд╛ рд╕рд╛рдордирд╛ рдХрд░рддрд╛ рд╣реИ, рддреЛ рдЪреБрдиреМрддрд┐рдпрд╛рдБ рдЙрддреНрдкрдиреНрди рд╣реЛрддреА рд╣реИрдВред рдРрд╕рд╛ рдЕрдиреБрд░реЛрдз рдмреИрдХрдПрдВрдб рдХреЛ рдкреНрд░рд╛рдкреНрдд рд░реВрдк рдореЗрдВ рдЕрдЧреНрд░реЗрд╖рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдФрд░ рдмреИрдХрдПрдВрдб рдХреА рдХрдЪреНрдЪреА рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рд╕реАрдзреЗ рдЧреНрд░рд╛рд╣рдХ рдХреЛ Nginx рдХреЗ рд╣рд╕реНрддрдХреНрд╖реЗрдк рдХреЗ рдмрд┐рдирд╛ рднреЗрдЬреА рдЬрд╛рддреА рд╣реИред

рдПрдХ рдЙрджрд╛рд╣рд░рдг рдкрд░рд┐рджреГрд╢реНрдп рдкрд░ рд╡рд┐рдЪрд╛рд░ рдХрд░реЗрдВ рдЬрд┐рд╕рдореЗрдВ рдПрдХ uWSGI рдПрдкреНрд▓рд┐рдХреЗрд╢рди рд╢рд╛рдорд┐рд▓ рд╣реИ:
```python
def application(environ, start_response):
start_response('500 Error', [('Content-Type', 'text/html'), ('Secret-Header', 'secret-info')])
return [b"Secret info, should not be visible!"]
```
рдЗрд╕рдХрд╛ рдкреНрд░рдмрдВрдзрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, Nginx рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдореЗрдВ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдирд┐рд░реНрджреЗрд╢реЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ:
```
http {
error_page 500 /html/error.html;
proxy_intercept_errors on;
proxy_hide_header Secret-Header;
}
```
* [**proxy\_intercept\_errors**](http://nginx.org/en/docs/http/ngx\_http\_proxy\_module.html#proxy\_intercept\_errors): рдпрд╣ рдирд┐рд░реНрджреЗрд╢ Nginx рдХреЛ 300 рд╕реЗ рдЕрдзрд┐рдХ рд╕реНрдерд┐рддрд┐ рдХреЛрдб рд╡рд╛рд▓реЗ рдмреИрдХрдПрдВрдб рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЗ рд▓рд┐рдП рдПрдХ рдХрд╕реНрдЯрдо рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рджреЗрдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рдмрдирд╛рддрд╛ рд╣реИред рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐, рд╣рдорд╛рд░реЗ рдЙрджрд╛рд╣рд░рдг uWSGI рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЗ рд▓рд┐рдП, рдПрдХ `500 Error` рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХреЛ Nginx рджреНрд╡рд╛рд░рд╛ рд░реЛрдХрд╛ рдФрд░ рд╕рдВрднрд╛рд▓рд╛ рдЬрд╛рддрд╛ рд╣реИред
* [**proxy\_hide\_header**](http://nginx.org/en/docs/http/ngx\_http\_proxy\_module.html#proxy\_hide\_header): рдЬреИрд╕рд╛ рдХрд┐ рдирд╛рдо рд╕реЗ рдкрддрд╛ рдЪрд▓рддрд╛ рд╣реИ, рдпрд╣ рдирд┐рд░реНрджреЗрд╢ рдирд┐рд░реНрджрд┐рд╖реНрдЯ HTTP рд╣реЗрдбрд░ рдХреЛ рдХреНрд▓рд╛рдЗрдВрдЯ рд╕реЗ рдЫреБрдкрд╛рддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдЧреЛрдкрдиреАрдпрддрд╛ рдФрд░ рд╕реБрд░рдХреНрд╖рд╛ рдмрдврд╝рддреА рд╣реИред

рдЬрдм рдПрдХ рдорд╛рдиреНрдп `GET` рдЕрдиреБрд░реЛрдз рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ Nginx рдЗрд╕реЗ рд╕рд╛рдорд╛рдиреНрдп рд░реВрдк рд╕реЗ рд╕рдВрд╕рд╛рдзрд┐рдд рдХрд░рддрд╛ рд╣реИ, рдмрд┐рдирд╛ рдХрд┐рд╕реА рдЧреБрдкреНрдд рд╣реЗрдбрд░ рдХреЛ рдкреНрд░рдХрдЯ рдХрд┐рдП рдПрдХ рдорд╛рдирдХ рддреНрд░реБрдЯрд┐ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рд▓реМрдЯрд╛рддрд╛ рд╣реИред рд╣рд╛рд▓рд╛рдБрдХрд┐, рдПрдХ рдЕрдорд╛рдиреНрдп HTTP рдЕрдиреБрд░реЛрдз рдЗрд╕ рддрдВрддреНрд░ рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдХрдЪреНрдЪреА рдмреИрдХрдПрдВрдб рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛рдПрдБ, рдЬрд┐рд╕рдореЗрдВ рдЧреБрдкреНрдд рд╣реЗрдбрд░ рдФрд░ рддреНрд░реБрдЯрд┐ рд╕рдВрджреЗрд╢ рд╢рд╛рдорд┐рд▓ рд╣реИрдВ, рдЙрдЬрд╛рдЧрд░ рд╣реЛрддреА рд╣реИрдВред

## merge\_slashes рдХреЛ рдмрдВрдж рдХрд░рдирд╛

рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ, Nginx рдХрд╛ **`merge_slashes` рдирд┐рд░реНрджреЗрд╢** **`on`** рдкрд░ рд╕реЗрдЯ рд╣реЛрддрд╛ рд╣реИ, рдЬреЛ рдПрдХ URL рдореЗрдВ рдХрдИ рдлреЙрд░рд╡рд░реНрдб рд╕реНрд▓реИрд╢ рдХреЛ рдПрдХрд▓ рд╕реНрд▓реИрд╢ рдореЗрдВ рд╕рдВрдХреБрдЪрд┐рдд рдХрд░рддрд╛ рд╣реИред рдпрд╣ рд╕реБрд╡рд┐рдзрд╛, рдЬрдмрдХрд┐ URL рдкреНрд░рд╕рдВрд╕реНрдХрд░рдг рдХреЛ рд╕рд░рд▓ рдмрдирд╛рддреА рд╣реИ, Nginx рдХреЗ рдкреАрдЫреЗ рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ рдореЗрдВ рдХрдордЬреЛрд░рд┐рдпреЛрдВ рдХреЛ рдЕрдирдЬрд╛рдиреЗ рдореЗрдВ рдЫрд┐рдкрд╛ рд╕рдХрддреА рд╣реИ, рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рд╕реНрдерд╛рдиреАрдп рдлрд╝рд╛рдЗрд▓ рд╕рдорд╛рд╡реЗрд╢ (LFI) рд╣рдорд▓реЛрдВ рдХреЗ рдкреНрд░рддрд┐ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ред рд╕реБрд░рдХреНрд╖рд╛ рд╡рд┐рд╢реЗрд╖рдЬреНрдЮ **Danny Robinson рдФрд░ Rotem Bar** рдиреЗ рдЗрд╕ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд╡реНрдпрд╡рд╣рд╛рд░ рд╕реЗ рдЬреБрдбрд╝реЗ рд╕рдВрднрд╛рд╡рд┐рдд рдЬреЛрдЦрд┐рдореЛрдВ рдХреЛ рдЙрдЬрд╛рдЧрд░ рдХрд┐рдпрд╛ рд╣реИ, рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рдЬрдм Nginx рдПрдХ рд░рд┐рд╡рд░реНрд╕-рдкреНрд░реЙрдХреНрд╕реА рдХреЗ рд░реВрдк рдореЗрдВ рдХрд╛рд░реНрдп рдХрд░рддрд╛ рд╣реИред

рдРрд╕реЗ рдЬреЛрдЦрд┐рдореЛрдВ рдХреЛ рдХрдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдпрд╣ рдЕрдиреБрд╢рдВрд╕рд╛ рдХреА рдЬрд╛рддреА рд╣реИ рдХрд┐ **рдЗрди рдХрдордЬреЛрд░рд┐рдпреЛрдВ рдХреЗ рдкреНрд░рддрд┐ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ рдХреЗ рд▓рд┐рдП `merge_slashes` рдирд┐рд░реНрджреЗрд╢ рдХреЛ рдмрдВрдж рдХрд░ рджреЗрдВ**ред рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ Nginx рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЛ рдЕрдиреБрдкреНрд░рдпреЛрдЧ рдХреА рдУрд░ рдмрд┐рдирд╛ URL рд╕рдВрд░рдЪрдирд╛ рдХреЛ рдмрджрд▓реЗ рдЕрдЧреНрд░реЗрд╖рд┐рдд рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдХрд┐рд╕реА рднреА рдЕрдВрддрд░реНрдирд┐рд╣рд┐рдд рд╕реБрд░рдХреНрд╖рд╛ рдореБрджреНрджреЛрдВ рдХреЛ рдЫрд┐рдкрд╛рдпрд╛ рдирд╣реАрдВ рдЬрд╛рддрд╛ рд╣реИред

рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП [Danny Robinson рдФрд░ Rotem Bar](https://medium.com/appsflyer/nginx-may-be-protecting-your-applications-from-traversal-attacks-without-you-even-knowing-b08f882fd43d) рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВред

### **Maclicious Response Headers**

рдЬреИрд╕рд╛ рдХрд┐ [**рдЗрд╕ рд▓реЗрдЦ**](https://mizu.re/post/cors-playground) рдореЗрдВ рджрд┐рдЦрд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдХреБрдЫ рд╣реЗрдбрд░ рд╣реИрдВ рдЬреЛ рдпрджрд┐ рд╡реЗ рд╡реЗрдм рд╕рд░реНрд╡рд░ рд╕реЗ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдореЗрдВ рдореМрдЬреВрдж рд╣реИрдВ рддреЛ рд╡реЗ Nginx рдкреНрд░реЙрдХреНрд╕реА рдХреЗ рд╡реНрдпрд╡рд╣рд╛рд░ рдХреЛ рдмрджрд▓ рджреЗрдВрдЧреЗред рдЖрдк рдЙрдиреНрд╣реЗрдВ [**рджрд╕реНрддрд╛рд╡реЗрдЬрд╝реЛрдВ рдореЗрдВ**](https://www.nginx.com/resources/wiki/start/topics/examples/x-accel/) рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ:

* `X-Accel-Redirect`: Nginx рдХреЛ рдПрдХ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рд╕реНрдерд╛рди рдкрд░ рдЕрдиреБрд░реЛрдз рдХреЛ рдЖрдВрддрд░рд┐рдХ рд░реВрдк рд╕реЗ рдкреБрдирд░реНрдирд┐рд░реНрджреЗрд╢рд┐рдд рдХрд░рдиреЗ рдХрд╛ рд╕рдВрдХреЗрдд рджреЗрддрд╛ рд╣реИред
* `X-Accel-Buffering`: рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдХреНрдпрд╛ Nginx рдХреЛ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХреЛ рдмрдлрд░ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП рдпрд╛ рдирд╣реАрдВред
* `X-Accel-Charset`: X-Accel-Redirect рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╕рдордп рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХреЗ рд▓рд┐рдП рд╡рд░реНрдг рд╕реЗрдЯ рд╕реЗрдЯ рдХрд░рддрд╛ рд╣реИред
* `X-Accel-Expires`: X-Accel-Redirect рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╕рдордп рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХреЗ рд▓рд┐рдП рд╕рдорд╛рдкреНрддрд┐ рд╕рдордп рд╕реЗрдЯ рдХрд░рддрд╛ рд╣реИред
* `X-Accel-Limit-Rate`: X-Accel-Redirect рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╕рдордп рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЗ рд▓рд┐рдП рд╕реНрдерд╛рдирд╛рдВрддрд░рдг рдХреА рджрд░ рдХреЛ рд╕реАрдорд┐рдд рдХрд░рддрд╛ рд╣реИред

рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рд╣реЗрдбрд░ **`X-Accel-Redirect`** Nginx рдореЗрдВ рдПрдХ рдЖрдВрддрд░рд┐рдХ **рдкреБрдирд░реНрдирд┐рд░реНрджреЗрд╢** рдХрд╛ рдХрд╛рд░рдг рдмрдиреЗрдЧрд╛ред рдЗрд╕рд▓рд┐рдП, рдпрджрд┐ Nginx рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдореЗрдВ рдХреБрдЫ рдРрд╕рд╛ рд╣реИ рдЬреИрд╕реЗ **`root /`** рдФрд░ рд╡реЗрдм рд╕рд░реНрд╡рд░ рд╕реЗ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдореЗрдВ **`X-Accel-Redirect: .env`** рд╣реИ, рддреЛ Nginx **`/.env`** рдХреА рд╕рд╛рдордЧреНрд░реА рднреЗрдЬреЗрдЧрд╛ (рдкрде рдпрд╛рддреНрд░рд╛)ред

### **Map Directive рдореЗрдВ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдорд╛рди**

**Nginx рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди** рдореЗрдВ, `map` рдирд┐рд░реНрджреЗрд╢ рдЕрдХреНрд╕рд░ **рдЕрдзрд┐рдХрд╛рд░ рдирд┐рдпрдВрддреНрд░рдг** рдореЗрдВ рднреВрдорд┐рдХрд╛ рдирд┐рднрд╛рддрд╛ рд╣реИред рдПрдХ рд╕рд╛рдорд╛рдиреНрдп рдЧрд▓рддреА **рдбрд┐рдлрд╝реЙрд▓реНрдЯ** рдорд╛рди рдирд┐рд░реНрджрд┐рд╖реНрдЯ рди рдХрд░рдирд╛ рд╣реИ, рдЬреЛ рдЕрдирдзрд┐рдХреГрдд рдкрд╣реБрдВрдЪ рдХрд╛ рдХрд╛рд░рдг рдмрди рд╕рдХрддрд╛ рд╣реИред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП:
```yaml
http {
map $uri $mappocallow {
/map-poc/private 0;
/map-poc/secret 0;
/map-poc/public 1;
}
}
```

```yaml
server {
location /map-poc {
if ($mappocallow = 0) {return 403;}
return 200 "Hello. It is private area: $mappocallow";
}
}
```
рдмрд┐рдирд╛ `default` рдХреЗ, рдПрдХ **рджреБрд╖реНрдЯ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛** `/map-poc` рдХреЗ рднреАрддрд░ рдПрдХ **рдЕрдкрд░рд┐рднрд╛рд╖рд┐рдд URI** рддрдХ рдкрд╣реБрдБрдЪрдХрд░ рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░ рд╕рдХрддрд╛ рд╣реИред [Nginx рдореИрдиреБрдЕрд▓](https://nginx.org/en/docs/http/ngx\_http\_map\_module.html) рдРрд╕реЗ рдореБрджреНрджреЛрдВ рд╕реЗ рдмрдЪрдиреЗ рдХреЗ рд▓рд┐рдП **рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдорд╛рди** рд╕реЗрдЯ рдХрд░рдиреЗ рдХреА рд╕рд▓рд╛рд╣ рджреЗрддрд╛ рд╣реИред

### **DNS рд╕реНрдкреВрдлрд┐рдВрдЧ рднреЗрджреНрдпрддрд╛**

Nginx рдХреЗ рдЦрд┐рд▓рд╛рдл DNS рд╕реНрдкреВрдлрд┐рдВрдЧ рдХреБрдЫ рд╢рд░реНрддреЛрдВ рдХреЗ рддрд╣рдд рд╕рдВрднрд╡ рд╣реИред рдпрджрд┐ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдХреЛ Nginx рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛рдиреЗ рд╡рд╛рд▓реЗ **DNS рд╕рд░реНрд╡рд░** рдХрд╛ рдЬреНрдЮрд╛рди рд╣реИ рдФрд░ рд╡рд╣ рдЗрд╕рдХреЗ DNS рдкреНрд░рд╢реНрдиреЛрдВ рдХреЛ рдЗрдВрдЯрд░рд╕реЗрдкреНрдЯ рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рддреЛ рд╡рд╣ DNS рд░рд┐рдХреЙрд░реНрдб рдХреЛ рд╕реНрдкреВрдл рдХрд░ рд╕рдХрддрд╛ рд╣реИред рд╣рд╛рд▓рд╛рдБрдХрд┐, рдпрд╣ рд╡рд┐рдзрд┐ рддрдм рдкреНрд░рднрд╛рд╡реА рдирд╣реАрдВ рд╣реИ рдЬрдм Nginx рдХреЛ DNS рд╕рдорд╛рдзрд╛рди рдХреЗ рд▓рд┐рдП **localhost (127.0.0.1)** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реЛред Nginx рдПрдХ DNS рд╕рд░реНрд╡рд░ рдХреЛ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ:
```yaml
resolver 8.8.8.8;
```
### **`proxy_pass` рдФрд░ `internal` рдирд┐рд░реНрджреЗрд╢**

**`proxy_pass`** рдирд┐рд░реНрджреЗрд╢ рдХрд╛ рдЙрдкрдпреЛрдЧ рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЛ рдЕрдиреНрдп рд╕рд░реНрд╡рд░реЛрдВ рдХреА рдУрд░ рдкреБрдирд░реНрдирд┐рд░реНрджреЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЪрд╛рд╣реЗ рд╡рд╣ рдЖрдВрддрд░рд┐рдХ рд╣реЛ рдпрд╛ рдмрд╛рд╣рд░реАред **`internal`** рдирд┐рд░реНрджреЗрд╢ рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдХреБрдЫ рд╕реНрдерд╛рди рдХреЗрд╡рд▓ Nginx рдХреЗ рднреАрддрд░ рд╣реА рд╕реБрд▓рдн рд╣реИрдВред рдЬрдмрдХрд┐ рдпреЗ рдирд┐рд░реНрджреЗрд╢ рдЕрдкрдиреЗ рдЖрдк рдореЗрдВ рдХрдордЬреЛрд░рд┐рдпрд╛рдБ рдирд╣реАрдВ рд╣реИрдВ, рдЙрдирдХреА рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреА рд╕рд╛рд╡рдзрд╛рдиреАрдкреВрд░реНрд╡рдХ рдЬрд╛рдВрдЪ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ рддрд╛рдХрд┐ рд╕реБрд░рдХреНрд╖рд╛ рдореЗрдВ рдЪреВрдХ рди рд╣реЛред

## proxy\_set\_header Upgrade & Connection

рдпрджрд┐ nginx рд╕рд░реНрд╡рд░ рдХреЛ Upgrade рдФрд░ Connection рд╣реЗрдбрд░ рдкрд╛рд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рддреЛ рдПрдХ [**h2c Smuggling рд╣рдорд▓рд╛**](../../pentesting-web/h2c-smuggling.md) рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рддрд╛рдХрд┐ рд╕рдВрд░рдХреНрд╖рд┐рдд/рдЖрдВрддрд░рд┐рдХ рдПрдВрдбрдкреЙрдЗрдВрдЯреНрд╕ рддрдХ рдкрд╣реБрдБрдЪ рдкреНрд░рд╛рдкреНрдд рдХреА рдЬрд╛ рд╕рдХреЗред

{% hint style="danger" %}
рдпрд╣ рдХрдордЬреЛрд░реА рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдХреЛ **`proxy_pass` рдПрдВрдбрдкреЙрдЗрдВрдЯ рдХреЗ рд╕рд╛рде рдПрдХ рд╕реАрдзрд╛ рдХрдиреЗрдХреНрд╢рди рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдиреЗ** рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдЧреА (`http://backend:9999` рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ) рдЬрд┐рд╕рдХрд╛ рд╕рд╛рдордЧреНрд░реА nginx рджреНрд╡рд╛рд░рд╛ рдЬрд╛рдВрдЪрд╛ рдирд╣реАрдВ рдЬрд╛рдПрдЧрд╛ред
{% endhint %}

`/flag` рдХреЛ рдЪреБрд░рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдХрдордЬреЛрд░ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХрд╛ рдЙрджрд╛рд╣рд░рдг [рдпрд╣рд╛рдБ](https://bishopfox.com/blog/h2c-smuggling-request) рд╣реИ:
```
server {
listen       443 ssl;
server_name  localhost;

ssl_certificate       /usr/local/nginx/conf/cert.pem;
ssl_certificate_key   /usr/local/nginx/conf/privkey.pem;

location / {
proxy_pass http://backend:9999;
proxy_http_version 1.1;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection $http_connection;
}

location /flag {
deny all;
}
```
{% hint style="warning" %}
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рднрд▓реЗ рд╣реА `proxy_pass` рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ **рдкрде** рдХреА рдУрд░ рдЗрд╢рд╛рд░рд╛ рдХрд░ рд░рд╣рд╛ рд╣реЛ рдЬреИрд╕реЗ `http://backend:9999/socket.io`, рдХрдиреЗрдХреНрд╢рди `http://backend:9999` рдХреЗ рд╕рд╛рде рд╕реНрдерд╛рдкрд┐рдд рд╣реЛрдЧрд╛, рдЗрд╕рд▓рд┐рдП рдЖрдк рдЙрд╕ рдЖрдВрддрд░рд┐рдХ рдПрдВрдбрдкреЙрдЗрдВрдЯ рдХреЗ рдЕрдВрджрд░ **рдХрд┐рд╕реА рдЕрдиреНрдп рдкрде рд╕реЗ рд╕рдВрдкрд░реНрдХ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЗрд╕рд▓рд┐рдП рдпрд╣ рдорд╛рдпрдиреЗ рдирд╣реАрдВ рд░рдЦрддрд╛ рдХрд┐ proxy_pass рдХреЗ URL рдореЗрдВ рдХреЛрдИ рдкрде рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред**
{% endhint %}

## рдЦреБрдж рдХреЛрд╢рд┐рд╢ рдХрд░реЗрдВ

Detectify рдиреЗ рдПрдХ GitHub рд░рд┐рдкреЙрдЬрд┐рдЯрд░реА рдмрдирд╛рдИ рд╣реИ рдЬрд╣рд╛рдБ рдЖрдк Docker рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЕрдкрдиреЗ рд╕реНрд╡рдпрдВ рдХреЗ рдХрдордЬреЛрд░ Nginx рдкрд░реАрдХреНрд╖рдг рд╕рд░реНрд╡рд░ рдХреЛ рд╕реНрдерд╛рдкрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд┐рд╕рдореЗрдВ рдЗрд╕ рд▓реЗрдЦ рдореЗрдВ рдЪрд░реНрдЪрд╛ рдХреА рдЧрдИ рдХреБрдЫ рдЧрд▓рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рд╣реИрдВ рдФрд░ рдЙрдиреНрд╣реЗрдВ рд╕реНрд╡рдпрдВ рдЦреЛрдЬрдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ!

[https://github.com/detectify/vulnerable-nginx](https://github.com/detectify/vulnerable-nginx)

## рд╕реНрдерд┐рд░ рд╡рд┐рд╢реНрд▓реЗрд╖рдХ рдЙрдкрдХрд░рдг

### [GIXY](https://github.com/yandex/gixy)

Gixy рдПрдХ рдЙрдкрдХрд░рдг рд╣реИ рдЬреЛ Nginx рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХрд╛ рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХрд░рддрд╛ рд╣реИред Gixy рдХрд╛ рдореБрдЦреНрдп рд▓рдХреНрд╖реНрдп рд╕реБрд░рдХреНрд╖рд╛ рдЧрд▓рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЛ рд░реЛрдХрдирд╛ рдФрд░ рджреЛрд╖ рдкрд╣рдЪрд╛рди рдХреЛ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдХрд░рдирд╛ рд╣реИред

### [Nginxpwner](https://github.com/stark0de/nginxpwner)

Nginxpwner рдПрдХ рд╕рд░рд▓ рдЙрдкрдХрд░рдг рд╣реИ рдЬреЛ рд╕рд╛рдорд╛рдиреНрдп Nginx рдЧрд▓рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдФрд░ рдХрдордЬреЛрд░рд┐рдпреЛрдВ рдХреА рдЦреЛрдЬ рдХрд░рддрд╛ рд╣реИред

## рд╕рдВрджрд░реНрдн

* [**https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/**](https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/)
* [**http://blog.zorinaq.com/nginx-resolver-vulns/**](http://blog.zorinaq.com/nginx-resolver-vulns/)
* [**https://github.com/yandex/gixy/issues/115**](https://github.com/yandex/gixy/issues/115)

<figure><img src="../../.gitbook/assets/image (14) (1).png" alt=""><figcaption></figcaption></figure>

**рдХрдордЬреЛрд░реА рдореВрд▓реНрдпрд╛рдВрдХрди рдФрд░ рдкреЗрдирдЯреЗрд╕реНрдЯрд┐рдВрдЧ рдХреЗ рд▓рд┐рдП рддреБрд░рдВрдд рдЙрдкрд▓рдмреНрдз рд╕реЗрдЯрдЕрдк**ред рдХрд╣реАрдВ рд╕реЗ рднреА 20+ рдЙрдкрдХрд░рдгреЛрдВ рдФрд░ рд╕реБрд╡рд┐рдзрд╛рдУрдВ рдХреЗ рд╕рд╛рде рдПрдХ рдкреВрд░реНрдг рдкреЗрдВрдЯреЗрд╕реНрдЯ рдЪрд▓рд╛рдПрдБ рдЬреЛ рдкреБрдирдГ рдЦреЛрдЬ рд╕реЗ рд░рд┐рдкреЛрд░реНрдЯрд┐рдВрдЧ рддрдХ рдЬрд╛рддреЗ рд╣реИрдВред рд╣рдо рдкреЗрдВрдЯреЗрд╕реНрдЯрд░реНрд╕ рдХреЛ рдкреНрд░рддрд┐рд╕реНрдерд╛рдкрд┐рдд рдирд╣реАрдВ рдХрд░рддреЗ - рд╣рдо рдЙрдиреНрд╣реЗрдВ рдЧрд╣рд░рд╛рдИ рд╕реЗ рдЦреБрджрд╛рдИ рдХрд░рдиреЗ, рд╢реЗрд▓ рдкреЙрдк рдХрд░рдиреЗ рдФрд░ рдордЬрд╝реЗ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреБрдЫ рд╕рдордп рд╡рд╛рдкрд╕ рджреЗрдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╕реНрдЯрдо рдЙрдкрдХрд░рдг, рдкрд╣рдЪрд╛рди рдФрд░ рд╢реЛрд╖рдг рдореЙрдбреНрдпреВрд▓ рд╡рд┐рдХрд╕рд┐рдд рдХрд░рддреЗ рд╣реИрдВред

{% embed url="https://pentest-tools.com/?utm_term=jul2024&utm_medium=link&utm_source=hacktricks&utm_campaign=spons" %}

{% hint style="success" %}
AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдБ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* **рд╣рдорд╛рд░реЗ** ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ **Twitter** ЁЯРж рдкрд░ рд╣рдореЗрдВ **рдлреЙрд▓реЛ рдХрд░реЗрдВ** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ рдФрд░** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub рд░рд┐рдкреЙрдЬрд┐рдЯрд░реА рдореЗрдВ PR рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВред

</details>
{% endhint %}
