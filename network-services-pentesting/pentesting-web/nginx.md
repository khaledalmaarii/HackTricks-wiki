# Nginx

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

<figure><img src="../../.gitbook/assets/image (14) (1).png" alt=""><figcaption></figcaption></figure>

**Configura√ß√£o instantaneamente dispon√≠vel para avalia√ß√£o de vulnerabilidades e teste de penetra√ß√£o**. Execute um pentest completo de qualquer lugar com mais de 20 ferramentas e recursos que v√£o desde reconhecimento at√© relat√≥rios. N√£o substitu√≠mos pentesters - desenvolvemos ferramentas personalizadas, m√≥dulos de detec√ß√£o e explora√ß√£o para dar a eles mais tempo para aprofundar, abrir shells e se divertir.

{% embed url="https://pentest-tools.com/" %}

## Localiza√ß√£o raiz ausente <a href="#missing-root-location" id="missing-root-location"></a>

Ao configurar o servidor Nginx, a **diretiva root** desempenha um papel cr√≠tico ao definir o diret√≥rio base a partir do qual os arquivos s√£o servidos. Considere o exemplo abaixo:
```bash
server {
root /etc/nginx;

location /hello.txt {
try_files $uri $uri/ =404;
proxy_pass http://127.0.0.1:8080/;
}
}
```
Nesta configura√ß√£o, `/etc/nginx` √© designado como o diret√≥rio raiz. Esta configura√ß√£o permite o acesso a arquivos dentro do diret√≥rio raiz especificado, como `/hello.txt`. No entanto, √© crucial notar que apenas uma localiza√ß√£o espec√≠fica (`/hello.txt`) est√° definida. N√£o h√° configura√ß√£o para a localiza√ß√£o raiz (`location / {...}`). Esta omiss√£o significa que a diretiva raiz se aplica globalmente, permitindo que solicita√ß√µes ao caminho raiz `/` acessem arquivos em `/etc/nginx`.

Uma considera√ß√£o de seguran√ßa cr√≠tica surge desta configura√ß√£o. Uma simples solicita√ß√£o `GET`, como `GET /nginx.conf`, poderia expor informa√ß√µes sens√≠veis ao servir o arquivo de configura√ß√£o do Nginx localizado em `/etc/nginx/nginx.conf`. Definir a raiz para um diret√≥rio menos sens√≠vel, como `/etc`, poderia mitigar esse risco, no entanto, ainda poderia permitir acesso n√£o intencional a outros arquivos cr√≠ticos, incluindo outros arquivos de configura√ß√£o, logs de acesso e at√© credenciais criptografadas usadas para autentica√ß√£o b√°sica HTTP.

## Configura√ß√£o Incorreta de LFI com Alias <a href="#alias-lfi-misconfiguration" id="alias-lfi-misconfiguration"></a>

Nos arquivos de configura√ß√£o do Nginx, uma inspe√ß√£o minuciosa √© necess√°ria para as diretivas "location". Uma vulnerabilidade conhecida como Inclus√£o Local de Arquivos (LFI) pode ser inadvertidamente introduzida atrav√©s de uma configura√ß√£o que se assemelha √† seguinte:
```
location /imgs {
alias /path/images/;
}
```
Esta configura√ß√£o √© propensa a ataques de LFI devido ao servidor interpretar solicita√ß√µes como `/imgs../flag.txt` como uma tentativa de acessar arquivos fora do diret√≥rio pretendido, efetivamente resolvendo para `/caminho/imagens/../flag.txt`. Essa falha permite que atacantes recuperem arquivos do sistema de arquivos do servidor que n√£o deveriam ser acess√≠veis via web.

Para mitigar essa vulnerabilidade, a configura√ß√£o deve ser ajustada para:
```
location /imgs/ {
alias /path/images/;
}
```
Mais informa√ß√µes: [https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/](https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/)

Testes do Acunetix:
```
alias../ => HTTP status code 403
alias.../ => HTTP status code 404
alias../../ => HTTP status code 403
alias../../../../../../../../../../../ => HTTP status code 400
alias../ => HTTP status code 403
```
## Restri√ß√£o de caminho insegura <a href="#uso-de-variavel-insegura" id="uso-de-variavel-insegura"></a>

Verifique a p√°gina a seguir para aprender como contornar diretivas como:
```plaintext
location = /admin {
deny all;
}

location = /admin/ {
deny all;
}
```
## Uso de vari√°veis inseguras / Divis√£o de Requisi√ß√µes HTTP <a href="#uso-de-variaveis-inseguras" id="uso-de-variaveis-inseguras"></a>

{% hint style="danger" %}
As vari√°veis vulner√°veis `$uri` e `$document_uri` podem ser corrigidas substituindo-as por `$request_uri`.

Uma express√£o regular tamb√©m pode ser vulner√°vel, como:

`location ~ /docs/([^/])? { ‚Ä¶ $1 ‚Ä¶ }` - Vulner√°vel

`location ~ /docs/([^/\s])? { ‚Ä¶ $1 ‚Ä¶ }` - N√£o vulner√°vel (verificando espa√ßos)

`location ~ /docs/(.*)? { ‚Ä¶ $1 ‚Ä¶ }`  - N√£o vulner√°vel
{% endhint %}

Uma vulnerabilidade na configura√ß√£o do Nginx √© demonstrada pelo exemplo abaixo:
```
location / {
return 302 https://example.com$uri;
}
```
Os caracteres \r (retorno de carro) e \n (avan√ßo de linha) significam novos caracteres de linha em solicita√ß√µes HTTP, e suas formas codificadas em URL s√£o representadas como `%0d%0a`. Incluir esses caracteres em uma solicita√ß√£o (por exemplo, `http://localhost/%0d%0aDetectify:%20clrf`) para um servidor mal configurado resulta no servidor emitindo um novo cabe√ßalho chamado `Detectify`. Isso ocorre porque a vari√°vel $uri decodifica os caracteres de nova linha codificados em URL, resultando em um cabe√ßalho inesperado na resposta:
```
HTTP/1.1 302 Moved Temporarily
Server: nginx/1.19.3
Content-Type: text/html
Content-Length: 145
Connection: keep-alive
Location: https://example.com/
Detectify: clrf
```
Saiba mais sobre os riscos de inje√ß√£o de CRLF e divis√£o de resposta em [https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/](https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/).

Tamb√©m essa t√©cnica √© [**explicada nesta palestra**](https://www.youtube.com/watch?v=gWQyWdZbdoY\&list=PL0xCSYnG\_iTtJe2V6PQqamBF73n7-f1Nr\&index=77) com alguns exemplos vulner√°veis e mecanismos de detec√ß√£o. Por exemplo, Para detectar essa m√° configura√ß√£o de uma perspectiva de caixa-preta, voc√™ poderia usar essas solicita√ß√µes:

* `https://example.com/%20X` - Qualquer c√≥digo HTTP
* `https://example.com/%20H` - 400 Solicita√ß√£o Inv√°lida

Se vulner√°vel, o primeiro retornar√° como "X" √© qualquer m√©todo HTTP e o segundo retornar√° um erro, pois H n√£o √© um m√©todo v√°lido. Assim, o servidor receber√° algo como: `GET / H HTTP/1.1` e isso acionar√° o erro.

Outros exemplos de detec√ß√£o seriam:

* `http://company.tld/%20HTTP/1.1%0D%0AXXXX:%20x` - Qualquer c√≥digo HTTP
* `http://company.tld/%20HTTP/1.1%0D%0AHost:%20x` - 400 Solicita√ß√£o Inv√°lida

Algumas configura√ß√µes vulner√°veis encontradas apresentadas nessa palestra foram:

* Observe como **`$uri`** √© definido como est√° na URL final
```
location ^~ /lite/api/ {
proxy_pass http://lite-backend$uri$is_args$args;
}
```
* Observe como novamente **`$uri`** est√° na URL (desta vez dentro de um par√¢metro)
```
location ~ ^/dna/payment {
rewrite ^/dna/([^/]+) /registered/main.pl?cmd=unifiedPayment&context=$1&native_uri=$uri break;
proxy_pass http://$back;
```
* Agora no AWS S3
```
location /s3/ {
proxy_pass https://company-bucket.s3.amazonaws.com$uri;
}
```
### Qualquer vari√°vel

Foi descoberto que os **dados fornecidos pelo usu√°rio** podem ser tratados como uma **vari√°vel Nginx** em certas circunst√¢ncias. A causa desse comportamento ainda √© um pouco elusiva, mas n√£o √© rara nem simples de verificar. Essa anomalia foi destacada em um relat√≥rio de seguran√ßa no HackerOne, que pode ser visualizado [aqui](https://hackerone.com/reports/370094). Uma investiga√ß√£o mais aprofundada sobre a mensagem de erro levou √† identifica√ß√£o de sua ocorr√™ncia dentro do [m√≥dulo de filtro SSI do c√≥digo-fonte do Nginx](https://github.com/nginx/nginx/blob/2187586207e1465d289ae64cedc829719a048a39/src/http/modules/ngx\_http\_ssi\_filter\_module.c#L365), apontando os Includes do Lado do Servidor (SSI) como a causa raiz.

Para **detectar essa configura√ß√£o incorreta**, o seguinte comando pode ser executado, que envolve definir um cabe√ßalho de refer√™ncia para testar a impress√£o da vari√°vel:
```bash
$ curl -H ‚ÄòReferer: bar‚Äô http://localhost/foo$http_referer | grep ‚Äòfoobar‚Äô
```
Varreduras para essa configura√ß√£o incorreta em sistemas revelaram v√°rias inst√¢ncias onde vari√°veis do Nginx poderiam ser impressas por um usu√°rio. No entanto, uma diminui√ß√£o no n√∫mero de inst√¢ncias vulner√°veis sugere que os esfor√ßos para corrigir esse problema foram em parte bem-sucedidos.

## Leitura bruta da resposta do backend

O Nginx oferece um recurso atrav√©s do `proxy_pass` que permite a intercepta√ß√£o de erros e cabe√ßalhos HTTP produzidos pelo backend, com o objetivo de ocultar mensagens de erro e cabe√ßalhos internos. Isso √© realizado pelo Nginx servindo p√°ginas de erro personalizadas em resposta a erros do backend. No entanto, surgem desafios quando o Nginx encontra uma solicita√ß√£o HTTP inv√°lida. Tal solicita√ß√£o √© encaminhada para o backend conforme recebida, e a resposta bruta do backend √© ent√£o enviada diretamente para o cliente sem interven√ß√£o do Nginx.

Considere um cen√°rio de exemplo envolvendo uma aplica√ß√£o uWSGI:
```python
def application(environ, start_response):
start_response('500 Error', [('Content-Type', 'text/html'), ('Secret-Header', 'secret-info')])
return [b"Secret info, should not be visible!"]
```
Para gerenciar isso, s√£o utilizadas diretivas espec√≠ficas na configura√ß√£o do Nginx:
```
http {
error_page 500 /html/error.html;
proxy_intercept_errors on;
proxy_hide_header Secret-Header;
}
```
* [**proxy\_intercept\_errors**](http://nginx.org/en/docs/http/ngx\_http\_proxy\_module.html#proxy\_intercept\_errors): Esta diretiva permite ao Nginx servir uma resposta personalizada para respostas do backend com um c√≥digo de status maior que 300. Garante que, para o nosso exemplo de aplica√ß√£o uWSGI, uma resposta de `Erro 500` seja interceptada e tratada pelo Nginx.
* [**proxy\_hide\_header**](http://nginx.org/en/docs/http/ngx\_http\_proxy\_module.html#proxy\_hide\_header): Como o nome sugere, esta diretiva oculta cabe√ßalhos HTTP especificados do cliente, aumentando a privacidade e seguran√ßa.

Quando uma solicita√ß√£o `GET` v√°lida √© feita, o Nginx a processa normalmente, retornando uma resposta de erro padr√£o sem revelar quaisquer cabe√ßalhos secretos. No entanto, uma solicita√ß√£o HTTP inv√°lida contorna esse mecanismo, resultando na exposi√ß√£o de respostas do backend em bruto, incluindo cabe√ßalhos secretos e mensagens de erro.

## merge\_slashes definido como off

Por padr√£o, a diretiva **`merge_slashes` do Nginx** √© definida como **`on`**, o que comprime m√∫ltiplas barras inclinadas em uma URL em uma √∫nica barra. Essa funcionalidade, enquanto simplifica o processamento de URLs, pode inadvertidamente ocultar vulnerabilidades em aplica√ß√µes atr√°s do Nginx, especialmente aquelas propensas a ataques de inclus√£o de arquivos locais (LFI). Os especialistas em seguran√ßa **Danny Robinson e Rotem Bar** destacaram os riscos potenciais associados a esse comportamento padr√£o, especialmente quando o Nginx atua como um proxy reverso.

Para mitigar tais riscos, √© recomendado **desativar a diretiva `merge_slashes`** para aplica√ß√µes suscet√≠veis a essas vulnerabilidades. Isso garante que o Nginx encaminhe as solicita√ß√µes para a aplica√ß√£o sem alterar a estrutura da URL, n√£o mascarando assim quaisquer problemas de seguran√ßa subjacentes.

Para mais informa√ß√µes, consulte [Danny Robinson e Rotem Bar](https://medium.com/appsflyer/nginx-may-be-protecting-your-applications-from-traversal-attacks-without-you-even-knowing-b08f882fd43d).

### **Cabe√ßalhos de Resposta Maliciosos**

Conforme mostrado neste [**artigo**](https://mizu.re/post/cors-playground), existem certos cabe√ßalhos que, se presentes na resposta do servidor web, alterar√£o o comportamento do proxy Nginx. Voc√™ pode verific√°-los [**na documenta√ß√£o**](https://www.nginx.com/resources/wiki/start/topics/examples/x-accel/):

* `X-Accel-Redirect`: Indica ao Nginx para redirecionar internamente uma solicita√ß√£o para uma localiza√ß√£o especificada.
* `X-Accel-Buffering`: Controla se o Nginx deve ou n√£o armazenar em buffer a resposta.
* `X-Accel-Charset`: Define o conjunto de caracteres para a resposta ao usar X-Accel-Redirect.
* `X-Accel-Expires`: Define o tempo de expira√ß√£o para a resposta ao usar X-Accel-Redirect.
* `X-Accel-Limit-Rate`: Limita a taxa de transfer√™ncia para respostas ao usar X-Accel-Redirect.

Por exemplo, o cabe√ßalho **`X-Accel-Redirect`** causar√° um **redirecionamento interno** no nginx. Portanto, ter uma configura√ß√£o nginx com algo como **`root /`** e uma resposta do servidor web com **`X-Accel-Redirect: .env`** far√° com que o nginx envie o conte√∫do de **`/.env`** (Travessia de Caminho).

### **Valor Padr√£o na Diretiva Map**

Na **configura√ß√£o do Nginx**, a diretiva `map` frequentemente desempenha um papel no **controle de autoriza√ß√£o**. Um erro comum √© n√£o especificar um **valor padr√£o**, o que poderia resultar em acesso n√£o autorizado. Por exemplo:
```yaml
http {
map $uri $mappocallow {
/map-poc/private 0;
/map-poc/secret 0;
/map-poc/public 1;
}
}
```

```yaml
server {
location /map-poc {
if ($mappocallow = 0) {return 403;}
return 200 "Hello. It is private area: $mappocallow";
}
}
```
Sem um `default`, um **usu√°rio malicioso** pode contornar a seguran√ßa acessando um **URI indefinido** dentro de `/map-poc`. [O manual do Nginx](https://nginx.org/en/docs/http/ngx\_http\_map\_module.html) recomenda definir um **valor padr√£o** para evitar tais problemas.

### **Vulnerabilidade de Spoofing de DNS**

O spoofing de DNS contra o Nginx √© vi√°vel sob certas condi√ß√µes. Se um atacante conhece o **servidor DNS** usado pelo Nginx e consegue interceptar suas consultas DNS, eles podem falsificar registros DNS. No entanto, esse m√©todo √© ineficaz se o Nginx estiver configurado para usar **localhost (127.0.0.1)** para resolu√ß√£o de DNS. O Nginx permite especificar um servidor DNS da seguinte forma:
```yaml
resolver 8.8.8.8;
```
### **Diretivas `proxy_pass` e `internal`**

A diretiva **`proxy_pass`** √© utilizada para redirecionar solicita√ß√µes para outros servidores, interna ou externamente. A diretiva **`internal`** garante que determinadas localiza√ß√µes sejam acess√≠veis apenas dentro do Nginx. Embora essas diretivas n√£o sejam vulnerabilidades por si s√≥, sua configura√ß√£o requer uma an√°lise cuidadosa para evitar lapsos de seguran√ßa.

## proxy\_set\_header Upgrade & Connection

Se o servidor nginx estiver configurado para passar os cabe√ßalhos Upgrade e Connection, um [**ataque de Smuggling h2c**](../../pentesting-web/h2c-smuggling.md) poderia ser realizado para acessar endpoints protegidos/internos.

{% hint style="danger" %}
Essa vulnerabilidade permitiria que um atacante **estabelecesse uma conex√£o direta com o endpoint `proxy_pass`** (`http://backend:9999` neste caso) cujo conte√∫do n√£o ser√° verificado pelo nginx.
{% endhint %}

Exemplo de configura√ß√£o vulner√°vel para roubar `/flag` de [aqui](https://bishopfox.com/blog/h2c-smuggling-request):
```
server {
listen       443 ssl;
server_name  localhost;

ssl_certificate       /usr/local/nginx/conf/cert.pem;
ssl_certificate_key   /usr/local/nginx/conf/privkey.pem;

location / {
proxy_pass http://backend:9999;
proxy_http_version 1.1;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection $http_connection;
}

location /flag {
deny all;
}
```
{% hint style="warning" %}
Note que mesmo que o `proxy_pass` estivesse apontando para um **caminho** espec√≠fico, como `http://backend:9999/socket.io`, a conex√£o ser√° estabelecida com `http://backend:9999`, ent√£o voc√™ pode **acessar qualquer outro caminho dentro desse endpoint interno. Portanto, n√£o importa se um caminho √© especificado na URL do proxy\_pass.**
{% endhint %}

## Experimente por si mesmo

A Detectify criou um reposit√≥rio no GitHub onde voc√™ pode usar o Docker para configurar seu pr√≥prio servidor de teste Nginx vulner√°vel com algumas das configura√ß√µes incorretas discutidas neste artigo e tentar encontr√°-las por si mesmo!

[https://github.com/detectify/vulnerable-nginx](https://github.com/detectify/vulnerable-nginx)

## Ferramentas de An√°lise Est√°tica

### [GIXY](https://github.com/yandex/gixy)

Gixy √© uma ferramenta para analisar a configura√ß√£o do Nginx. O principal objetivo do Gixy √© prevenir configura√ß√µes de seguran√ßa incorretas e automatizar a detec√ß√£o de falhas.

### [Nginxpwner](https://github.com/stark0de/nginxpwner)

Nginxpwner √© uma ferramenta simples para procurar por configura√ß√µes incorretas e vulnerabilidades comuns no Nginx.

## Refer√™ncias

* [**https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/**](https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/)
* [**http://blog.zorinaq.com/nginx-resolver-vulns/**](http://blog.zorinaq.com/nginx-resolver-vulns/)
* [**https://github.com/yandex/gixy/issues/115**](https://github.com/yandex/gixy/issues/115)

<figure><img src="../../.gitbook/assets/image (14) (1).png" alt=""><figcaption></figcaption></figure>

**Configura√ß√£o instantaneamente dispon√≠vel para avalia√ß√£o de vulnerabilidades e teste de penetra√ß√£o**. Execute um pentest completo de qualquer lugar com mais de 20 ferramentas e recursos que v√£o desde a reconstru√ß√£o at√© a gera√ß√£o de relat√≥rios. N√£o substitu√≠mos os pentesters - desenvolvemos ferramentas personalizadas, m√≥dulos de detec√ß√£o e explora√ß√£o para dar a eles mais tempo para aprofundar, abrir shells e se divertir.

{% embed url="https://pentest-tools.com/" %}

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
