# Nginx

<details>

<summary><strong>Nauƒçite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naƒçini podr≈°ke HackTricks-u:

* Ako ≈æelite da vidite **va≈°u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniƒçni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na≈°u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru≈æite se** üí¨ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

<figure><img src="/.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

**Trenutno dostupna postavka za procenu ranjivosti i testiranje penetracije**. Pokrenite puni pentest sa bilo kog mesta sa preko 20 alata i funkcija koje idu od rekonstrukcije do izve≈°tavanja. Ne zamenjujemo pentestere - razvijamo prilagoƒëene alate, module za detekciju i eksploataciju kako bismo im vratili neko vreme da dublje kopaju, otvaraju ljuske i zabavljaju se.

{% embed url="https://pentest-tools.com/" %}

## Nedostajuƒáa korenska lokacija <a href="#missing-root-location" id="missing-root-location"></a>

## **Osnove konfigurisanja Nginx korenskog direktorijuma**

Prilikom konfigurisanja Nginx servera, **root direktiva** igra kljuƒçnu ulogu definisanjem osnovnog direktorijuma iz kojeg se serviraju fajlovi. Razmotrite sledeƒái primer:
```bash
server {
root /etc/nginx;

location /hello.txt {
try_files $uri $uri/ =404;
proxy_pass http://127.0.0.1:8080/;
}
}
```
U ovoj konfiguraciji, `/etc/nginx` je odreƒëen kao koreni direktorijum. Ova postavka omoguƒáava pristup fajlovima unutar odreƒëenog korenskog direktorijuma, kao ≈°to je `/hello.txt`. Meƒëutim, va≈æno je napomenuti da je definirana samo odreƒëena lokacija (`/hello.txt`). Nema konfiguracije za korenu lokaciju (`location / {...}`). Ova izostavljena konfiguracija znaƒçi da se direktiva korena primenjuje globalno, omoguƒáavajuƒái zahteve za korenskom putanjom `/` da pristupaju fajlovima u direktorijumu `/etc/nginx`.

Iz ove konfiguracije proizlazi kritiƒçno sigurnosno pitanje. Jednostavan `GET` zahtev, poput `GET /nginx.conf`, mo≈æe otkriti osetljive informacije tako ≈°to ƒáe poslu≈æiti Nginx konfiguracioni fajl koji se nalazi na lokaciji `/etc/nginx/nginx.conf`. Postavljanje korena na manje osetljiv direktorijum, poput `/etc`, mo≈æe umanjiti ovaj rizik, ali i dalje mo≈æe omoguƒáiti ne≈æeljen pristup drugim kritiƒçnim fajlovima, ukljuƒçujuƒái druge konfiguracione fajlove, pristupne logove, pa ƒçak i ≈°ifrovane akreditive koji se koriste za HTTP osnovnu autentifikaciju.

## Konfiguracija Alias LFI <a href="#alias-lfi-misconfiguration" id="alias-lfi-misconfiguration"></a>

U konfiguracionim fajlovima Nginx-a, potrebno je pa≈æljivo pregledati "location" direktive. Ranjivost poznata kao Local File Inclusion (LFI) mo≈æe se nenamerno uneti kroz konfiguraciju koja liƒçi na sledeƒáu:
```
location /imgs {
alias /path/images/;
}
```
Ova konfiguracija je podlo≈æna LFI napadima zbog toga ≈°to server tumaƒçi zahteve poput `/imgs../flag.txt` kao poku≈°aj pristupa datotekama van namenjenog direktorijuma, efektivno rezultirajuƒái u `/putanja/slike/../flag.txt`. Ova slabost omoguƒáava napadaƒçima da povrate datoteke sa serverskog fajl sistema koje ne bi trebalo da budu dostupne preko veba.

Da bi se umanjila ova ranjivost, konfiguracija treba da bude prilagoƒëena na sledeƒái naƒçin:
```
location /imgs/ {
alias /path/images/;
}
```
Vi≈°e informacija: [https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/](https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/)

Accunetix testovi:
```
alias../ => HTTP status code 403
alias.../ => HTTP status code 404
alias../../ => HTTP status code 403
alias../../../../../../../../../../../ => HTTP status code 400
alias../ => HTTP status code 403
```
## Nesigurno ograniƒçenje putanje <a href="#nesigurna-upotreba-promenljive" id="nesigurna-upotreba-promenljive"></a>

Proverite sledeƒáu stranicu da biste saznali kako zaobiƒái direktive poput:
```plaintext
location = /admin {
deny all;
}

location = /admin/ {
deny all;
}
```
{% content-ref url="../../pentesting-web/proxy-waf-protections-bypass.md" %}
[proxy-waf-protections-bypass.md](../../pentesting-web/proxy-waf-protections-bypass.md)
{% endcontent-ref %}

## Nebezbedna upotreba promenljive <a href="#unsafe-variable-use" id="unsafe-variable-use"></a>

Ranjivost u konfiguraciji Nginx-a je prikazana u sledeƒáem primeru:
```
location / {
return 302 https://example.com$uri;
}
```
Karakteri \r (Carriage Return) i \n (Line Feed) oznaƒçavaju nove linije u HTTP zahtevima, a njihove URL-kodirane forme se predstavljaju kao `%0d%0a`. Ukljuƒçivanje ovih karaktera u zahtev (npr. `http://localhost/%0d%0aDetectify:%20clrf`) ka serveru sa lo≈°om konfiguracijom rezultuje izdavanjem novog zaglavlja sa nazivom `Detectify`. Ovo se de≈°ava jer promenljiva $uri dekodira URL-kodirane nove linije, ≈°to dovodi do neoƒçekivanog zaglavlja u odgovoru:
```
HTTP/1.1 302 Moved Temporarily
Server: nginx/1.19.3
Content-Type: text/html
Content-Length: 145
Connection: keep-alive
Location: https://example.com/
Detectify: clrf
```
Saznajte vi≈°e o rizicima CRLF ubacivanja i razdvajanja odgovora na [https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/](https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/).

### Bilo koja promenljiva

Otkriveno je da se **podaci koje korisnik dostavlja** mogu tretirati kao **Nginx promenljiva** u odreƒëenim okolnostima. Uzrok ovog pona≈°anja ostaje delimiƒçno nejasan, ali nije retko niti jednostavno proveriti. Ova anomalija je istaknuta u izve≈°taju o bezbednosti na HackerOne, koji mo≈æete pogledati [ovde](https://hackerone.com/reports/370094). Dalje istra≈æivanje gre≈°ke je dovelo do identifikacije njenog pojavljivanja unutar [SSI filter modula Nginx-ovog koda](https://github.com/nginx/nginx/blob/2187586207e1465d289ae64cedc829719a048a39/src/http/modules/ngx_http_ssi_filter_module.c#L365), pri ƒçemu su Server Side Includes (SSI) identifikovani kao osnovni uzrok.

Da biste **otkrili ovu lo≈°u konfiguraciju**, mo≈æete izvr≈°iti sledeƒáu komandu, koja ukljuƒçuje postavljanje referer zaglavlja kako biste testirali ispis promenljive:
```bash
$ curl -H ‚ÄòReferer: bar‚Äô http://localhost/foo$http_referer | grep ‚Äòfoobar‚Äô
```
Skeniranja za ovu konfiguraciju na sistemima otkrila su vi≈°estruke instance gde korisnik mo≈æe da prika≈æe Nginx promenljive. Meƒëutim, smanjenje broja ranjivih instanci ukazuje da su napori za popravku ovog problema donekle uspe≈°ni.

## ƒåitanje sirove odgovora sa servera

Nginx nudi moguƒánost kori≈°ƒáenja `proxy_pass` funkcije koja omoguƒáava presretanje gre≈°aka i HTTP zaglavlja koja generi≈°e server, sa ciljem sakrivanja internih poruka o gre≈°kama i zaglavlja. Ovo se posti≈æe tako ≈°to Nginx servira prilagoƒëene stranice sa gre≈°kama kao odgovor na gre≈°ke servera. Meƒëutim, javljaju se izazovi kada Nginx naiƒëe na neva≈æeƒái HTTP zahtev. Takav zahtev se prosleƒëuje serveru onakav kakav je primljen, a sirovi odgovor servera se direktno ≈°alje klijentu bez intervencije Nginxa.

Razmotrimo primer scenarija koji ukljuƒçuje uWSGI aplikaciju:
```python
def application(environ, start_response):
start_response('500 Error', [('Content-Type', 'text/html'), ('Secret-Header', 'secret-info')])
return [b"Secret info, should not be visible!"]
```
Da biste to upravljali, koriste se specifiƒçne direktive u Nginx konfiguraciji:
```
http {
error_page 500 /html/error.html;
proxy_intercept_errors on;
proxy_hide_header Secret-Header;
}
```
- **[proxy_intercept_errors](http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_intercept_errors)**: Ova direktiva omoguƒáava Nginx-u da poslu≈æi prilagoƒëeni odgovor za odgovore sa statusnim kodom veƒáim od 300. Ona osigurava da, za na≈° primer aplikacije uWSGI, odgovor `500 Error` bude presretnut i obraƒëen od strane Nginx-a.
- **[proxy_hide_header](http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_hide_header)**: Kao ≈°to naziv sugeri≈°e, ova direktiva sakriva odreƒëene HTTP zaglavlja od klijenta, pobolj≈°avajuƒái privatnost i bezbednost.

Kada se napravi validan `GET` zahtev, Nginx ga normalno obraƒëuje, vraƒáajuƒái standardni odgovor o gre≈°ci bez otkrivanja bilo kakvih tajnih zaglavlja. Meƒëutim, neva≈æeƒái HTTP zahtev zaobilazi ovaj mehanizam, ≈°to rezultira otkrivanjem sirovih odgovora sa servera, ukljuƒçujuƒái tajna zaglavlja i poruke o gre≈°kama.


## merge\_slashes postavljen na off

Podrazumevano, Nginx-ova direktiva **`merge_slashes`** je postavljena na **`on`**, ≈°to komprimuje vi≈°estruke kosine u URL-u u jednu kosu. Ova funkcionalnost, iako olak≈°ava obradu URL-ova, mo≈æe nenamerno sakriti ranjivosti u aplikacijama iza Nginx-a, posebno one podlo≈æne napadima lokalnog ukljuƒçivanja fajlova (LFI). Bezbednosni struƒçnjaci **Danny Robinson i Rotem Bar** su istakli potencijalne rizike povezane sa ovim podrazumevanim pona≈°anjem, posebno kada Nginx deluje kao reverzni proxy.

Da bi se umanjili takvi rizici, preporuƒçuje se **iskljuƒçivanje direktive `merge_slashes`** za aplikacije koje su podlo≈æne ovim ranjivostima. Ovo osigurava da Nginx prosleƒëuje zahteve aplikaciji bez izmena strukture URL-a, ƒçime se ne prikrivaju eventualni bezbednosni problemi.

Za vi≈°e informacija pogledajte [Danny Robinson i Rotem Bar](https://medium.com/appsflyer/nginx-may-be-protecting-your-applications-from-traversal-attacks-without-you-even-knowing-b08f882fd43d).

### **Podrazumevana vrednost u Map direktivi**

U **Nginx konfiguraciji**, direktiva `map` ƒçesto ima ulogu u **kontroli autorizacije**. ƒåest propust je nedostatak navoƒëenja **podrazumevane** vrednosti, ≈°to mo≈æe dovesti do neovla≈°ƒáenog pristupa. Na primer:
```yaml
http {
map $uri $mappocallow {
/map-poc/private 0;
/map-poc/secret 0;
/map-poc/public 1;
}
}
```

```yaml
server {
location /map-poc {
if ($mappocallow = 0) {return 403;}
return 200 "Hello. It is private area: $mappocallow";
}
}
```
Bez `default`, **zlonamerni korisnik** mo≈æe zaobiƒái sigurnost pristupanjem **nedefinisanom URI-ju** unutar `/map-poc`. [Nginx priruƒçnik](https://nginx.org/en/docs/http/ngx_http_map_module.html) savetuje postavljanje **podrazumevane vrednosti** kako bi se izbegli takvi problemi.

### **Ranjivost DNS prevara**

DNS prevara protiv Nginx-a je izvodljiva u odreƒëenim uslovima. Ako napadaƒç zna **DNS server** koji koristi Nginx i mo≈æe presresti njegove DNS upite, mo≈æe falsifikovati DNS zapise. Meƒëutim, ova metoda nije efikasna ako je Nginx konfigurisan da koristi **localhost (127.0.0.1)** za DNS razre≈°avanje. Nginx omoguƒáava specificiranje DNS servera na sledeƒái naƒçin:
```yaml
resolver 8.8.8.8;
```
### **`proxy_pass` –∏ `internal` –î–∏—Ä–µ–∫—Ç–∏–≤–µ**

–î–∏—Ä–µ–∫—Ç–∏–≤–∞ **`proxy_pass`** —Å–µ –∫–æ—Ä–∏—Å—Ç–∏ –∑–∞ –ø—Ä–µ—É—Å–º–µ—Ä–∞–≤–∞—ö–µ –∑–∞—Ö—Ç–µ–≤–∞ –Ω–∞ –¥—Ä—É–≥–µ —Å–µ—Ä–≤–µ—Ä–µ, –±–∏–ª–æ –∏–Ω—Ç–µ—Ä–Ω–æ –∏–ª–∏ –µ–∫—Å—Ç–µ—Ä–Ω–æ. –î–∏—Ä–µ–∫—Ç–∏–≤–∞ **`internal`** –æ—Å–∏–≥—É—Ä–∞–≤–∞ –¥–∞ —Å–µ –æ–¥—Ä–µ—í–µ–Ω–∏ –ª–æ–∫–∞—Ü–∏—ò–µ –º–æ–≥—É –ø—Ä–∏—Å—Ç—É–ø–∏—Ç–∏ —Å–∞–º–æ —É–Ω—É—Ç–∞—Ä Nginx-–∞. –ò–∞–∫–æ –æ–≤–µ –¥–∏—Ä–µ–∫—Ç–∏–≤–µ —Å–∞–º–µ –ø–æ —Å–µ–±–∏ –Ω–∏—Å—É —É–≥—Ä–æ–∑–µ, —ö–∏—Ö–æ–≤–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—ò–∞ –∑–∞—Ö—Ç–µ–≤–∞ –ø–∞–∂—ô–∏–≤ –ø—Ä–µ–≥–ª–µ–¥ –¥–∞ –±–∏ —Å–µ —Å–ø—Ä–µ—á–∏–ª–∏ –±–µ–∑–±–µ–¥–Ω–æ—Å–Ω–∏ –ø—Ä–æ–ø—É—Å—Ç–∏.

## proxy\_set\_header Upgrade & Connection

–ê–∫–æ —ò–µ nginx —Å–µ—Ä–≤–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Å–∞–Ω –¥–∞ –ø—Ä–æ—Å–ª–µ—í—É—ò–µ –∑–∞–≥–ª–∞–≤—ô–∞ Upgrade –∏ Connection, –º–æ–∂–µ —Å–µ –∏–∑–≤—Ä—à–∏—Ç–∏ [**h2c Smuggling attack**](../../pentesting-web/h2c-smuggling.md) –¥–∞ –±–∏ —Å–µ –ø—Ä–∏—Å—Ç—É–ø–∏–ª–æ –∑–∞—à—Ç–∏—õ–µ–Ω–∏–º/–∏–Ω—Ç–µ—Ä–Ω–∏–º –µ–Ω–¥–ø–æ–∏–Ω—Ç–∏–º–∞.

{% hint style="danger" %}
–û–≤–∞ —É–≥—Ä–æ–∑–∞ –±–∏ –æ–º–æ–≥—É—õ–∏–ª–∞ –Ω–∞–ø–∞–¥–∞—á—É –¥–∞ **—É—Å—Ç–∞–Ω–æ–≤–∏ –¥–∏—Ä–µ–∫—Ç–Ω—É –≤–µ–∑—É —Å–∞ `proxy_pass` –µ–Ω–¥–ø–æ–∏–Ω—Ç–æ–º** (`http://backend:9999` —É –æ–≤–æ–º —Å–ª—É—á–∞—ò—É) —á–∏—ò–∏ —Å–∞–¥—Ä–∂–∞—ò –Ω–µ—õ–µ –±–∏—Ç–∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω –æ–¥ —Å—Ç—Ä–∞–Ω–µ nginx-–∞.
{% endhint %}

–ü—Ä–∏–º–µ—Ä —É–≥—Ä–æ–∂–µ–Ω–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—ò–µ –∑–∞ –∫—Ä–∞—í—É `/flag` —Å–∞ [–æ–≤–¥–µ](https://bishopfox.com/blog/h2c-smuggling-request):
```
server {
listen       443 ssl;
server_name  localhost;

ssl_certificate       /usr/local/nginx/conf/cert.pem;
ssl_certificate_key   /usr/local/nginx/conf/privkey.pem;

location / {
proxy_pass http://backend:9999;
proxy_http_version 1.1;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection $http_connection;
}

location /flag {
deny all;
}
```
{% hint style="warning" %}
Imajte na umu da ƒçak i ako je `proxy_pass` upuƒáivao na odreƒëenu **putanju** kao ≈°to je `http://backend:9999/socket.io`, veza ƒáe biti uspostavljena sa `http://backend:9999`, tako da mo≈æete **kontaktirati bilo koju drugu putanju unutar tog internog odredi≈°ta. Dakle, nije va≈æno da li je putanja navedena u URL-u proxy\_pass.**
{% endhint %}

## Isprobajte sami

Detectify je kreirao GitHub repozitorijum gde mo≈æete koristiti Docker da biste postavili svoj vlastiti ranjivi Nginx test server sa nekim od konfiguracija koje su opisane u ovom ƒçlanku i poku≈°ati da ih pronaƒëete sami!

[https://github.com/detectify/vulnerable-nginx](https://github.com/detectify/vulnerable-nginx)

## Alati za statiƒçku analizu

### [GIXY](https://github.com/yandex/gixy)

Gixy je alat za analizu Nginx konfiguracije. Glavni cilj Gixy-ja je spreƒçavanje neispravne konfiguracije bezbednosti i automatizacija otkrivanja slabosti.

### [Nginxpwner](https://github.com/stark0de/nginxpwner)

Nginxpwner je jednostavan alat za pronala≈æenje uobiƒçajenih Nginx konfiguracija i ranjivosti.

## Reference

* [**https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/**](https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/)
* [**http://blog.zorinaq.com/nginx-resolver-vulns/**](http://blog.zorinaq.com/nginx-resolver-vulns/)
* [**https://github.com/yandex/gixy/issues/115**](https://github.com/yandex/gixy/issues/115)

<figure><img src="/.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

**Trenutno dostupna postavka za procenu ranjivosti i testiranje penetracije**. Pokrenite potpuni pentest sa bilo kog mesta sa vi≈°e od 20 alata i funkcija koje idu od prikupljanja informacija do izve≈°tavanja. Mi ne zamenjujemo pentestere - mi razvijamo prilagoƒëene alate, module za otkrivanje i eksploataciju kako bismo im vratili neko vreme da dublje kopaju, otvaraju ljuske i zabavljaju se.

{% embed url="https://pentest-tools.com/" %}

<details>

<summary><strong>Nauƒçite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naƒçini podr≈°ke HackTricks-u:

* Ako ≈æelite da vidite **va≈°u kompaniju reklamiranu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** Pogledajte [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniƒçni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na≈°u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru≈æite se** üí¨ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
