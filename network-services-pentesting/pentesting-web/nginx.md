# Nginx

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJATELJSTVO**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

<figure><img src="../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

**Instantno dostupno podeÅ¡avanje za procenu ranjivosti i testiranje proboja**. Pokrenite kompletan pentest od bilo kog mesta sa 20+ alata i funkcija koje idu od rekonstrukcije do izveÅ¡tavanja. Mi ne zamenjujemo pentestere - mi razvijamo prilagoÄ‘ene alate, module za detekciju i eksploataciju kako bismo im vratili neko vreme da dublje kopaju, otvaraju ljuske i zabavljaju se.

{% embed url="https://pentest-tools.com/" %}

## NedostajuÄ‡i root lokacija <a href="#missing-root-location" id="missing-root-location"></a>

## **Osnove konfigurisanja Nginx Root direktorijuma**

Prilikom konfigurisanja Nginx servera, **root direktiva** igra kljuÄnu ulogu definisanjem osnovnog direktorijuma iz kog se serviraju fajlovi. Razmotrite primer ispod:
```bash
server {
root /etc/nginx;

location /hello.txt {
try_files $uri $uri/ =404;
proxy_pass http://127.0.0.1:8080/;
}
}
```
U ovoj konfiguraciji, `/etc/nginx` je odreÄ‘en kao korenski direktorijum. Ova postavka omoguÄ‡ava pristup fajlovima unutar odreÄ‘enog korenskog direktorijuma, poput `/hello.txt`. MeÄ‘utim, vaÅ¾no je napomenuti da je definisana samo odreÄ‘ena lokacija (`/hello.txt`). Ne postoji konfiguracija za korensku lokaciju (`location / {...}`). Ova izostavljena stavka znaÄi da se direktiva korena primenjuje globalno, omoguÄ‡avajuÄ‡i zahteve za korensku putanju `/` da pristupe fajlovima pod `/etc/nginx`.

Iz ove konfiguracije proizilazi kljuÄno sigurnosno pitanje. Jednostavan `GET` zahtev, poput `GET /nginx.conf`, mogao bi otkriti osetljive informacije serviranjem Nginx konfiguracionog fajla koji se nalazi na lokaciji `/etc/nginx/nginx.conf`. Postavljanje korena na manje osetljiv direktorijum, poput `/etc`, moglo bi umanjiti ovaj rizik, ali i dalje moÅ¾e dozvoliti nenamerno pristupanje drugim kritiÄnim fajlovima, ukljuÄujuÄ‡i druge konfiguracione fajlove, pristupne logove, pa Äak i Å¡ifrovane akreditive koriÅ¡Ä‡ene za HTTP osnovnu autentifikaciju.

## Alias LFI Misconfiguracija <a href="#alias-lfi-misconfiguration" id="alias-lfi-misconfiguration"></a>

U konfiguracionim fajlovima Nginx-a, potrebno je paÅ¾ljivo pregledati "location" direktive. Ranjivost poznata kao Lokalno UkljuÄivanje Fajlova (LFI) moÅ¾e se nenamerno uneti kroz konfiguraciju koja liÄi na sledeÄ‡u:
```
location /imgs {
alias /path/images/;
}
```
Ova konfiguracija je podloÅ¾na LFI napadima zbog servera koji tumaÄi zahteve poput `/imgs../flag.txt` kao pokuÅ¡aj pristupa datotekama van namenjenog direktorijuma, efektivno se reÅ¡avajuÄ‡i u `/path/images/../flag.txt`. Ova greÅ¡ka omoguÄ‡ava napadaÄima da povrate datoteke sa serverskog fajl sistema koje ne bi trebalo da budu dostupne preko veba.

Da bi se ublaÅ¾ila ova ranjivost, konfiguracija treba da bude prilagoÄ‘ena:
```
location /imgs/ {
alias /path/images/;
}
```
ViÅ¡e informacija: [https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/](https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/)

Accunetix testovi:
```
alias../ => HTTP status code 403
alias.../ => HTTP status code 404
alias../../ => HTTP status code 403
alias../../../../../../../../../../../ => HTTP status code 400
alias../ => HTTP status code 403
```
## Nebezbedno ograniÄenje putanje <a href="#unsafe-variable-use" id="unsafe-variable-use"></a>

Proverite sledeÄ‡u stranicu da biste saznali kako zaobiÄ‡i direktive poput:
```plaintext
location = /admin {
deny all;
}

location = /admin/ {
deny all;
}
```
## Nebezbedna upotreba promenljivih / Razdvajanje HTTP zahteva <a href="#unsafe-variable-use" id="unsafe-variable-use"></a>

{% hint style="danger" %}
Ranjive promenljive `$uri` i `$document_uri` mogu se popraviti zamenom sa `$request_uri`.

Regex takoÄ‘e moÅ¾e biti ranjiv, na primer:

`location ~ /docs/([^/])? { â€¦ $1 â€¦ }` - Ranjivo&#x20;

`location ~ /docs/([^/\s])? { â€¦ $1 â€¦ }` - Nije ranjivo (provera razmaka)

`location ~ /docs/(.*)? { â€¦ $1 â€¦ }`  - Nije ranjivo
{% endhint %}

Ranjivost u Nginx konfiguraciji demonstrirana je u primeru ispod:
```
location / {
return 302 https://example.com$uri;
}
```
Karakteri \r (Carriage Return) i \n (Line Feed) oznaÄavaju nove linije u HTTP zahtevima, a njihove URL-kodirane forme su predstavljene kao `%0d%0a`. UkljuÄivanje ovih karaktera u zahtev (npr. `http://localhost/%0d%0aDetectify:%20clrf`) ka neispravno konfigurisanom serveru rezultuje serveru izdavanjem novog zaglavlja nazvanog `Detectify`. Do ovoga dolazi jer promenljiva $uri dekodira URL-kodirane nove linije, Å¡to dovodi do neoÄekivanog zaglavlja u odgovoru:
```
HTTP/1.1 302 Moved Temporarily
Server: nginx/1.19.3
Content-Type: text/html
Content-Length: 145
Connection: keep-alive
Location: https://example.com/
Detectify: clrf
```
Saznajte viÅ¡e o rizicima CRLF ubacivanja i razdvajanja odgovora na [https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/](https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/).

TakoÄ‘e, ovu tehniku je **objaÅ¡njena u ovom govoru** sa nekim ranjivim primerima i mehanizmima detekcije. Na primer, kako biste otkrili ovu loÅ¡u konfiguraciju iz crne kutije, moÅ¾ete koristiti ove zahteve:

- `https://example.com/%20X` - Bilo koji HTTP kod
- `https://example.com/%20H` - 400 Bad Request

Ako je ranjiv, prvi Ä‡e vratiti "X" jer je X bilo koji HTTP metod, a drugi Ä‡e vratiti greÅ¡ku jer H nije validan metod. Dakle, server Ä‡e primiti neÅ¡to poput: `GET / H HTTP/1.1` i to Ä‡e izazvati greÅ¡ku.

JoÅ¡ neki primeri detekcije bi bili:

- `http://company.tld/%20HTTP/1.1%0D%0AXXXX:%20x` - Bilo koji HTTP kod
- `http://company.tld/%20HTTP/1.1%0D%0AHost:%20x` - 400 Bad Request

Neki pronaÄ‘eni ranjivi konfiguracije prikazani u tom govoru su:

- Primetite kako je **`$uri`** postavljen kao Å¡to je u konaÄnom URL-u
```
location ^~ /lite/api/ {
proxy_pass http://lite-backend$uri$is_args$args;
}
```
* Obratite paÅ¾nju kako je ponovo **`$uri`** u URL-u (ovaj put unutar parametra)
```
location ~ ^/dna/payment {
rewrite ^/dna/([^/]+) /registered/main.pl?cmd=unifiedPayment&context=$1&native_uri=$uri break;
proxy_pass http://$back;
```
* Sada u AWS S3
```
location /s3/ {
proxy_pass https://company-bucket.s3.amazonaws.com$uri;
}
```
### Bilo koja promenljiva

Otkriveno je da se **podaci koje je korisnik dostavio** mogu tretirati kao **Nginx promenljiva** u odreÄ‘enim okolnostima. Uzrok ovog ponaÅ¡anja ostaje donekle nejasan, ali nije retko niti jednostavno proveriti. Ova anomalija je istaknuta u izveÅ¡taju o bezbednosti na HackerOne platformi, koji moÅ¾ete pogledati [ovde](https://hackerone.com/reports/370094). Dalje istraÅ¾ivanje poruke o greÅ¡ci dovelo je do identifikacije njenog pojavljivanja unutar [SSI filter modula Nginx-ove baze koda](https://github.com/nginx/nginx/blob/2187586207e1465d289ae64cedc829719a048a39/src/http/modules/ngx\_http\_ssi\_filter\_module.c#L365), oznaÄavajuÄ‡i Server Side Includes (SSI) kao koreni uzrok.

Da biste **otkrili ovu loÅ¡u konfiguraciju**, moÅ¾e se izvrÅ¡iti sledeÄ‡a komanda, koja ukljuÄuje postavljanje referer zaglavlja radi testiranja ispisivanja promenljive:
```bash
$ curl -H â€˜Referer: barâ€™ http://localhost/foo$http_referer | grep â€˜foobarâ€™
```
Skenovi za ovu konfiguraciju na razliÄitim sistemima otkrili su viÅ¡e sluÄajeva gde Nginx promenljive mogu biti prikazane od strane korisnika. MeÄ‘utim, smanjenje broja ranjivih instanci sugeriÅ¡e da su napori za popravku ovog problema donekle uspeÅ¡ni.

## ÄŒitanje sirovog odgovora sa serverske strane

Nginx nudi funkciju putem `proxy_pass` koja omoguÄ‡ava presretanje greÅ¡aka i HTTP zaglavlja proizvedenih od strane serverske strane, sa ciljem skrivanja internih poruka o greÅ¡kama i zaglavlja. Ovo se postiÅ¾e tako Å¡to Nginx servira prilagoÄ‘ene stranice greÅ¡aka kao odgovor na greÅ¡ke serverske strane. MeÄ‘utim, javljaju se izazovi kada Nginx naiÄ‘e na nevaÅ¾eÄ‡i HTTP zahtev. Takav zahtev se prosleÄ‘uje serverskoj strani onako kako je primljen, i sirovi odgovor serverske strane se zatim direktno Å¡alje klijentu bez posredovanja Nginxa.

Razmotrimo primer scenarija koji ukljuÄuje uWSGI aplikaciju:
```python
def application(environ, start_response):
start_response('500 Error', [('Content-Type', 'text/html'), ('Secret-Header', 'secret-info')])
return [b"Secret info, should not be visible!"]
```
Da biste upravljali ovim, koriste se specifiÄne direktive u Nginx konfiguraciji:
```
http {
error_page 500 /html/error.html;
proxy_intercept_errors on;
proxy_hide_header Secret-Header;
}
```
* [**proxy\_intercept\_errors**](http://nginx.org/en/docs/http/ngx\_http\_proxy\_module.html#proxy\_intercept\_errors): Ova direktiva omoguÄ‡ava Nginx-u da posluÅ¾i prilagoÄ‘eni odgovor za odgovore sa servera sa statusnim kodom veÄ‡im od 300. To osigurava da, za naÅ¡ primer aplikacije uWSGI, odgovor `500 Error` bude presretnut i obraÄ‘en od strane Nginx-a.
* [**proxy\_hide\_header**](http://nginx.org/en/docs/http/ngx\_http\_proxy\_module.html#proxy\_hide\_header): Kao Å¡to naziv sugeriÅ¡e, ova direktiva skriva odreÄ‘ene HTTP zaglavlja od klijenta, poboljÅ¡avajuÄ‡i privatnost i bezbednost.

Kada se napravi validan `GET` zahtev, Nginx ga obraÄ‘uje na uobiÄajen naÄin, vraÄ‡ajuÄ‡i standardni greÅ¡ni odgovor ne otkrivajuÄ‡i nikakva tajna zaglavlja. MeÄ‘utim, nevaÅ¾eÄ‡i HTTP zahtev zaobilazi ovaj mehanizam, rezultirajuÄ‡i izlaganjem sirovih odgovora sa servera, ukljuÄujuÄ‡i tajna zaglavlja i poruke o greÅ¡kama.

## merge\_slashes postavljen na off

Podrazumevano, **`merge_slashes` direktiva** u Nginx-u je postavljena na **`on`**, Å¡to komprimuje viÅ¡estruke kosine kose u URL-u u jednu kosu. Ova funkcija, dok olakÅ¡ava obradu URL-ova, moÅ¾e nenamerno prikriti ranjivosti u aplikacijama iza Nginx-a, posebno onima sklonim napadima lokalnog ukljuÄivanja fajlova (LFI). Bezbednosni struÄnjaci **Danny Robinson i Rotem Bar** su istakli potencijalne rizike povezane sa ovim podrazumevanim ponaÅ¡anjem, posebno kada Nginx deluje kao reverzni proxy.

Da bi se umanjili takvi rizici, preporuÄuje se **iskljuÄivanje `merge_slashes` direktive** za aplikacije koje su podloÅ¾ne ovim ranjivostima. Ovo osigurava da Nginx prosleÄ‘uje zahteve aplikaciji bez menjanja strukture URL-a, Äime se ne prikrivaju potencijalni sigurnosni problemi.

Za viÅ¡e informacija pogledajte [Danny Robinson i Rotem Bar](https://medium.com/appsflyer/nginx-may-be-protecting-your-applications-from-traversal-attacks-without-you-even-knowing-b08f882fd43d).

### **Podrazumevana vrednost u Map Direktivi**

U **Nginx konfiguraciji**, `map` direktiva Äesto igra ulogu u **kontroli autorizacije**. ÄŒesta greÅ¡ka je ne navoÄ‘enje **podrazumevane** vrednosti, Å¡to moÅ¾e dovesti do neovlaÅ¡Ä‡enog pristupa. Na primer:
```yaml
http {
map $uri $mappocallow {
/map-poc/private 0;
/map-poc/secret 0;
/map-poc/public 1;
}
}
```

```yaml
server {
location /map-poc {
if ($mappocallow = 0) {return 403;}
return 200 "Hello. It is private area: $mappocallow";
}
}
```
Bez `default`, **zlonamerni korisnik** moÅ¾e zaobiÄ‡i sigurnost pristupanjem **nedefinisanom URI** unutar `/map-poc`. [Nginx priruÄnik](https://nginx.org/en/docs/http/ngx\_http\_map\_module.html) savetuje postavljanje **podrazumevane vrednosti** kako bi se izbegli takvi problemi.

### **Ranjivost DNS prevara**

DNS prevara protiv Nginxa je izvodljiva u odreÄ‘enim uslovima. Ako napadaÄ zna **DNS server** koji koristi Nginx i moÅ¾e presresti njegove DNS upite, moÅ¾e falsifikovati DNS zapise. MeÄ‘utim, ovaj metod nije efikasan ako je Nginx konfigurisan da koristi **localhost (127.0.0.1)** za DNS razreÅ¡avanje. Nginx omoguÄ‡ava specificiranje DNS servera na sledeÄ‡i naÄin:
```yaml
resolver 8.8.8.8;
```
### **`proxy_pass` Ğ¸ `internal` Ğ”Ğ¸Ñ€ĞµĞºÑ‚Ğ¸Ğ²Ğµ**

Ğ”Ğ¸Ñ€ĞµĞºÑ‚Ğ¸Ğ²Ğ° **`proxy_pass`** ÑĞµ koristi za preusmeravanje zahteva ka drugim serverima, bilo interno ili eksterno. **`internal`** dirlketiva osigurava da odreÄ‘ene lokacije budu dostupne samo unutar Nginx-a. Iako same po sebi ove dirlketive nisu ranjivosti, njihova konfiguracija zahteva paÅ¾ljivu analizu kako bi se spreÄile bezbednosne propuste.

## proxy\_set\_header Upgrade & Connection

Ako je nginx server konfigurisan da prosleÄ‘uje zaglavlja Upgrade i Connection, moÅ¾e se izvesti [**h2c Smuggling napad**](../../pentesting-web/h2c-smuggling.md) kako bi se pristupilo zaÅ¡tiÄ‡enim/internim krajnjim taÄkama.

{% hint style="danger" %}
Ova ranjivost bi omoguÄ‡ila napadaÄu da **uspostavi direktnu vezu sa krajnjom taÄkom `proxy_pass`** (`http://backend:9999` u ovom sluÄaju) Äiji sadrÅ¾aj neÄ‡e biti proveren od strane nginx-a.
{% endhint %}

Primer ranjive konfiguracije za kraÄ‘u `/flag` moÅ¾ete pronaÄ‡i [ovde](https://bishopfox.com/blog/h2c-smuggling-request):
```
server {
listen       443 ssl;
server_name  localhost;

ssl_certificate       /usr/local/nginx/conf/cert.pem;
ssl_certificate_key   /usr/local/nginx/conf/privkey.pem;

location / {
proxy_pass http://backend:9999;
proxy_http_version 1.1;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection $http_connection;
}

location /flag {
deny all;
}
```
{% hint style="warning" %}
Imajte na umu da Äak i ako je `proxy_pass` usmeren ka odreÄ‘enom **putanji** poput `http://backend:9999/socket.io` veza Ä‡e biti uspostavljena sa `http://backend:9999` tako da moÅ¾ete **kontaktirati bilo koju drugu putanju unutar tog internog krajnjeg taÄke. Dakle, nije vaÅ¾no da li je putanja navedena u URL-u proxy\_pass.**
{% endhint %}

## Probajte sami

Detectify je kreirao GitHub repozitorijum gde moÅ¾ete koristiti Docker da postavite svoj ranjivi Nginx test server sa nekim od konfiguracionih greÅ¡aka koje su diskutovane u ovom Älanku i pokuÅ¡ati da ih pronaÄ‘ete sami!

[https://github.com/detectify/vulnerable-nginx](https://github.com/detectify/vulnerable-nginx)

## Alati za statiÄku analizu

### [GIXY](https://github.com/yandex/gixy)

Gixy je alat za analizu Nginx konfiguracije. Glavni cilj Gixy-ja je spreÄavanje bezbednosnih konfiguracionih greÅ¡aka i automatizacija otkrivanja propusta.

### [Nginxpwner](https://github.com/stark0de/nginxpwner)

Nginxpwner je jednostavan alat za traÅ¾enje uobiÄajenih Nginx konfiguracionih greÅ¡aka i ranjivosti.

## Reference

* [**https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/**](https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/)
* [**http://blog.zorinaq.com/nginx-resolver-vulns/**](http://blog.zorinaq.com/nginx-resolver-vulns/)
* [**https://github.com/yandex/gixy/issues/115**](https://github.com/yandex/gixy/issues/115)

<figure><img src="../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

**Instantno dostupna postavka za procenu ranjivosti & testiranje proboja**. Pokrenite pun pentest od bilo kog mesta sa 20+ alata i funkcija koje idu od rekonstrukcije do izveÅ¡tavanja. Mi ne zamenjujemo pentestere - mi razvijamo prilagoÄ‘ene alate, module za otkrivanje & eksploataciju kako bismo im vratili neko vreme da dublje kopaju, otvaraju ljuske i zabavljaju se.

{% embed url="https://pentest-tools.com/" %}

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** Proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
