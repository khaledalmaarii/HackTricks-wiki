# Nginx

<details>

<summary><strong>ä»é›¶åˆ°è‹±é›„å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œé€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

<figure><img src="../../.gitbook/assets/image (1) (1) (2) (4).png" alt=""><figcaption></figcaption></figure>

[**DragonJAR Security Conferenceæ˜¯ä¸€ä¸ªå›½é™…ç½‘ç»œå®‰å…¨äº‹ä»¶**](https://www.dragonjarcon.org/)ï¼Œå·²ç»æœ‰åå¤šå¹´çš„å†å²ï¼Œå°†äº2023å¹´9æœˆ7æ—¥å’Œ8æ—¥åœ¨å“¥ä¼¦æ¯”äºšæ³¢å“¥å¤§ä¸¾è¡Œã€‚è¿™æ˜¯ä¸€ä¸ªæŠ€æœ¯å†…å®¹ä¸°å¯Œçš„æ´»åŠ¨ï¼Œä¼šå±•ç¤ºæœ€æ–°çš„è¥¿ç­ç‰™è¯­ç ”ç©¶ï¼Œå¸å¼•äº†æ¥è‡ªä¸–ç•Œå„åœ°çš„é»‘å®¢å’Œç ”ç©¶äººå‘˜ã€‚\
ç°åœ¨å°±åœ¨ä»¥ä¸‹é“¾æ¥æ³¨å†Œï¼Œä¸è¦é”™è¿‡è¿™ä¸ªç››å¤§çš„ä¼šè®®ï¼:

{% embed url="https://www.dragonjarcon.org/" %}

## ç¼ºå¤±çš„æ ¹ä½ç½® <a href="#missing-root-location" id="missing-root-location"></a>
```
server {
root /etc/nginx;

location /hello.txt {
try_files $uri $uri/ =404;
proxy_pass http://127.0.0.1:8080/;
}
}
```
`root` æŒ‡ä»¤æŒ‡å®šäº† Nginx çš„æ ¹æ–‡ä»¶å¤¹ã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæ ¹æ–‡ä»¶å¤¹æ˜¯ `/etc/nginx`ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥è®¿é—®è¯¥æ–‡ä»¶å¤¹å†…çš„æ–‡ä»¶ã€‚ä¸Šè¿°é…ç½®æ²¡æœ‰ä¸º `/ (location / {...})` è®¾ç½®ä½ç½®ï¼Œåªä¸º `/hello.txt` è®¾ç½®äº†ä½ç½®ã€‚å› æ­¤ï¼Œ`root` æŒ‡ä»¤å°†è¢«å…¨å±€è®¾ç½®ï¼Œè¿™æ„å‘³ç€å¯¹ `/` çš„è¯·æ±‚å°†å¯¼èˆªåˆ°æœ¬åœ°è·¯å¾„ `/etc/nginx`ã€‚

ä¸€ä¸ªç®€å•çš„ `GET /nginx.conf` è¯·æ±‚å°†æ­ç¤ºå­˜å‚¨åœ¨ `/etc/nginx/nginx.conf` ä¸­çš„ Nginx é…ç½®æ–‡ä»¶çš„å†…å®¹ã€‚å¦‚æœæ ¹ç›®å½•è®¾ç½®ä¸º `/etc`ï¼Œå¯¹ `/nginx/nginx.conf` çš„ `GET` è¯·æ±‚å°†æ­ç¤ºé…ç½®æ–‡ä»¶ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šè®¿é—®åˆ°å…¶ä»–é…ç½®æ–‡ä»¶ã€è®¿é—®æ—¥å¿—ï¼Œç”šè‡³æ˜¯ HTTP åŸºæœ¬è®¤è¯çš„åŠ å¯†å‡­æ®ã€‚

## åˆ«å LFI é…ç½®é”™è¯¯ <a href="#alias-lfi-misconfiguration" id="alias-lfi-misconfiguration"></a>

åœ¨ Nginx é…ç½®ä¸­æŸ¥çœ‹ "location" è¯­å¥ï¼Œå¦‚æœæœ‰äººçœ‹èµ·æ¥åƒï¼š
```
location /imgs {
alias /path/images/;
}
```
å­˜åœ¨LFIæ¼æ´ï¼Œå› ä¸ºï¼š
```
/imgs../flag.txt
```
```markdown
# Nginx ç½‘ç»œæœåŠ¡æ¸—é€æµ‹è¯•

## ä¿¡æ¯æ”¶é›†

### Nginx ç‰ˆæœ¬

é»˜è®¤æƒ…å†µä¸‹ï¼ŒNginx ä¼šåœ¨é”™è¯¯é¡µé¢å’Œå“åº”å¤´ä¸­æ³„éœ²å…¶ç‰ˆæœ¬ä¿¡æ¯ã€‚è¿™å¯ä»¥é€šè¿‡å‘é€ä¸€ä¸ªé”™è¯¯è¯·æ±‚æ¥æ£€æµ‹ï¼Œä¾‹å¦‚è¯·æ±‚ä¸€ä¸ªä¸å­˜åœ¨çš„é¡µé¢ã€‚

```bash
curl -I http://example.com/nonexistentpage
```

å¦‚æœæœåŠ¡å™¨é…ç½®ä¸å½“ï¼Œå“åº”å¤´ `Server` å­—æ®µå¯èƒ½ä¼šæ˜¾ç¤º Nginx ç‰ˆæœ¬ï¼Œå¦‚ `Server: nginx/1.16.1`ã€‚

### é…ç½®æ–‡ä»¶æ³„éœ²

Nginx é…ç½®æ–‡ä»¶ï¼ˆé€šå¸¸æ˜¯ `/etc/nginx/nginx.conf`ï¼‰åŒ…å«é‡è¦ä¿¡æ¯ï¼Œå¦‚æœæ³„éœ²ï¼Œå¯èƒ½ä¼šå¯¼è‡´å®‰å…¨é£é™©ã€‚æ”»å‡»è€…å¯ä»¥å°è¯•ç›´æ¥è®¿é—®è¿™äº›æ–‡ä»¶ï¼Œçœ‹æ˜¯å¦å¯ä»¥ä» web æœåŠ¡å™¨ä¸‹è½½ã€‚

```bash
curl http://example.com/nginx.conf
```

### ç›®å½•éå†

å¦‚æœ Nginx é…ç½®ä¸å½“ï¼Œæ”»å‡»è€…å¯èƒ½èƒ½å¤Ÿé€šè¿‡ç›®å½•éå†æ¼æ´è®¿é—®æ•æ„Ÿæ–‡ä»¶ã€‚ä¾‹å¦‚ï¼Œé€šè¿‡ä½¿ç”¨ `../` æ¥å°è¯•è®¿é—®çˆ¶ç›®å½•ä¸­çš„æ–‡ä»¶ã€‚

```bash
curl http://example.com/../etc/passwd
```

## æ¼æ´åˆ©ç”¨

### é»˜è®¤æ–‡ä»¶å’Œç›®å½•

Nginx æœåŠ¡å™¨å¯èƒ½åŒ…å«é»˜è®¤æ–‡ä»¶å’Œç›®å½•ï¼Œè¿™äº›å¯èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯ã€‚æ”»å‡»è€…åº”è¯¥æ£€æŸ¥è¿™äº›èµ„æºï¼Œä¾‹å¦‚é»˜è®¤çš„ `50x.html` é”™è¯¯é¡µé¢ã€‚

```bash
curl http://example.com/50x.html
```

### æœåŠ¡å™¨ç«¯è¯·æ±‚ä¼ªé€ ï¼ˆSSRFï¼‰

SSRF æ¼æ´å…è®¸æ”»å‡»è€…é€šè¿‡å—å½±å“çš„æœåŠ¡å™¨å‘é€åˆ›å»ºçš„è¯·æ±‚ã€‚åœ¨ Nginx ä¸­ï¼Œå¦‚æœ `resolver` é…ç½®ä¸å½“ï¼Œå¯èƒ½ä¼šå¯¼è‡´ SSRFã€‚

### è¿œç¨‹ä»£ç æ‰§è¡Œï¼ˆRCEï¼‰

å¦‚æœ Nginx ä¸å…¶ä»–æœåŠ¡ï¼ˆå¦‚ PHP-FPMï¼‰é›†æˆä¸å½“ï¼Œå¯èƒ½ä¼šå¯¼è‡´ RCE æ¼æ´ã€‚æ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¿™äº›æ¼æ´æ‰§è¡Œæ¶æ„ä»£ç ã€‚

## å®‰å…¨åŠ å›º

### ç‰ˆæœ¬éšè—

ä¸ºäº†é˜²æ­¢ç‰ˆæœ¬ä¿¡æ¯æ³„éœ²ï¼Œåº”è¯¥åœ¨ Nginx é…ç½®ä¸­è®¾ç½® `server_tokens off;`ã€‚

### æœ€å°åŒ–æƒé™

ç¡®ä¿ Nginx è¿›ç¨‹ä»¥æœ€å°æƒé™è¿è¡Œï¼Œä¾‹å¦‚ä½¿ç”¨ä¸“ç”¨çš„ä½æƒé™ç”¨æˆ·è´¦æˆ·ã€‚

### å®šæœŸæ›´æ–°

å®šæœŸæ›´æ–° Nginx ä»¥ä¿®å¤å·²çŸ¥æ¼æ´ã€‚

### ä½¿ç”¨å®‰å…¨æ¨¡å—

ä½¿ç”¨å¦‚ ModSecurity ç­‰å®‰å…¨æ¨¡å—å¯ä»¥å¢å¼º Nginx çš„å®‰å…¨æ€§ã€‚

## ç»“è®º

Nginx æ˜¯ä¸€ä¸ªå¼ºå¤§çš„ web æœåŠ¡å™¨ï¼Œä½†å¦‚æœé…ç½®ä¸å½“ï¼Œå¯èƒ½ä¼šæš´éœ²äºå¤šç§å®‰å…¨é£é™©ã€‚é€šè¿‡é€‚å½“çš„ä¿¡æ¯æ”¶é›†ã€æ¼æ´åˆ©ç”¨å’Œå®‰å…¨åŠ å›ºï¼Œå¯ä»¥æ˜¾è‘—é™ä½è¿™äº›é£é™©ã€‚
```
```
/path/images/../flag.txt
```
æ­£ç¡®çš„é…ç½®å°†æ˜¯ï¼š
```
location /imgs/ {
alias /path/images/;
}
```
**å› æ­¤ï¼Œå¦‚æœæ‚¨å‘ç°æŸä¸ªNginxæœåŠ¡å™¨ï¼Œæ‚¨åº”è¯¥æ£€æŸ¥è¿™ä¸ªæ¼æ´ã€‚åŒæ—¶ï¼Œå¦‚æœæ‚¨å‘ç°æ–‡ä»¶/ç›®å½•æš´åŠ›ç ´è§£è¡Œä¸ºå¼‚å¸¸ï¼Œä¹Ÿå¯ä»¥å‘ç°å®ƒã€‚**

æ›´å¤šä¿¡æ¯ï¼š[https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/](https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/)

Accunetix æµ‹è¯•ï¼š
```
alias../ => HTTP status code 403
alias.../ => HTTP status code 404
alias../../ => HTTP status code 403
alias../../../../../../../../../../../ => HTTP status code 400
alias../ => HTTP status code 403
```
## ä¸å®‰å…¨çš„è·¯å¾„é™åˆ¶ <a href="#unsafe-variable-use" id="unsafe-variable-use"></a>

æŸ¥çœ‹ä»¥ä¸‹é¡µé¢ï¼Œäº†è§£å¦‚ä½•ç»•è¿‡åƒè¿™æ ·çš„æŒ‡ä»¤ï¼š
```plaintext
location = /admin {
deny all;
}

location = /admin/ {
deny all;
}
```
{% content-ref url="../../pentesting-web/proxy-waf-protections-bypass.md" %}
[proxy-waf-protections-bypass.md](../../pentesting-web/proxy-waf-protections-bypass.md)
{% endcontent-ref %}

## ä¸å®‰å…¨å˜é‡ä½¿ç”¨ <a href="#unsafe-variable-use" id="unsafe-variable-use"></a>

ä¸€ä¸ªå­˜åœ¨æ¼æ´çš„ Nginx é…ç½®ç¤ºä¾‹æ˜¯ï¼š
```
location / {
return 302 https://example.com$uri;
}
```
HTTPè¯·æ±‚çš„æ–°è¡Œå­—ç¬¦æ˜¯`\r`ï¼ˆå›è½¦ï¼‰å’Œ`\n`ï¼ˆæ¢è¡Œï¼‰ã€‚URLç¼–ç æ–°è¡Œå­—ç¬¦ä¼šå¾—åˆ°å­—ç¬¦çš„ä»¥ä¸‹è¡¨ç¤º`%0d%0a`ã€‚å½“è¿™äº›å­—ç¬¦è¢«åŒ…å«åœ¨åƒ`http://localhost/%0d%0aDetectify:%20clrf`è¿™æ ·çš„è¯·æ±‚ä¸­å‘é€åˆ°é…ç½®é”™è¯¯çš„æœåŠ¡å™¨æ—¶ï¼ŒæœåŠ¡å™¨ä¼šå“åº”ä¸€ä¸ªåä¸º`Detectify`çš„æ–°å¤´éƒ¨ï¼Œå› ä¸º$uriå˜é‡åŒ…å«äº†URLè§£ç çš„æ–°è¡Œå­—ç¬¦ã€‚
```
HTTP/1.1 302 Moved Temporarily
Server: nginx/1.19.3
Content-Type: text/html
Content-Length: 145
Connection: keep-alive
Location: https://example.com/
Detectify: clrf
```
äº†è§£æ›´å¤šå…³äºCRLFæ³¨å…¥å’Œå“åº”æ‹†åˆ†çš„é£é™©ï¼Œè¯·è®¿é—® [https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/](https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/)ã€‚

### ä»»æ„å˜é‡

åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œç”¨æˆ·æä¾›çš„æ•°æ®å¯èƒ½ä¼šè¢«å½“ä½œNginxå˜é‡å¤„ç†ã€‚ä¸ºä»€ä¹ˆä¼šè¿™æ ·å‘ç”Ÿå°šä¸æ¸…æ¥šï¼Œä½†è¿™å¹¶ä¸ç½•è§ï¼Œä¹Ÿä¸å®¹æ˜“æµ‹è¯•ï¼Œæ­£å¦‚è¿™ä¸ª [H1æŠ¥å‘Š](https://hackerone.com/reports/370094)ä¸­æ‰€è§ã€‚å¦‚æœæˆ‘ä»¬æœç´¢é”™è¯¯ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°å®ƒå‡ºç°åœ¨ [SSIè¿‡æ»¤æ¨¡å—](https://github.com/nginx/nginx/blob/2187586207e1465d289ae64cedc829719a048a39/src/http/modules/ngx_http_ssi_filter_module.c#L365)ï¼Œå› æ­¤æ­ç¤ºäº†è¿™æ˜¯ç”±äºSSIé€ æˆçš„ã€‚

æµ‹è¯•è¿™ä¸€ç‚¹çš„ä¸€ç§æ–¹æ³•æ˜¯è®¾ç½®ä¸€ä¸ªrefererå¤´çš„å€¼ï¼š
```
$ curl -H â€˜Referer: barâ€™ http://localhost/foo$http_referer | grep â€˜foobarâ€™
```
æˆ‘ä»¬æ‰«æäº†è¿™ç§é”™è¯¯é…ç½®ï¼Œå¹¶å‘ç°äº†å‡ ä¸ªå®ä¾‹ï¼Œç”¨æˆ·å¯ä»¥æ‰“å°Nginxå˜é‡çš„å€¼ã€‚å‘ç°çš„æ˜“å—æ”»å‡»å®ä¾‹æ•°é‡æœ‰æ‰€ä¸‹é™ï¼Œè¿™å¯èƒ½è¡¨æ˜å·²ç»è¿›è¡Œäº†ä¿®è¡¥ã€‚

## åŸå§‹åç«¯å“åº”è¯»å–

ä½¿ç”¨Nginxçš„`proxy_pass`ï¼Œæœ‰å¯èƒ½æ‹¦æˆªåç«¯åˆ›å»ºçš„é”™è¯¯å’ŒHTTPå¤´ã€‚å¦‚æœä½ æƒ³éšè—å†…éƒ¨é”™è¯¯æ¶ˆæ¯å’Œå¤´ï¼Œä»¥ä¾¿å®ƒä»¬ç”±Nginxå¤„ç†ï¼Œè¿™éå¸¸æœ‰ç”¨ã€‚å¦‚æœåç«¯å›ç­”é”™è¯¯é¡µé¢ï¼ŒNginxå°†è‡ªåŠ¨æä¾›è‡ªå®šä¹‰é”™è¯¯é¡µé¢ã€‚ä½†å¦‚æœNginxä¸ç†è§£è¿™æ˜¯ä¸€ä¸ªHTTPå“åº”æ€ä¹ˆåŠï¼Ÿ

å¦‚æœå®¢æˆ·ç«¯å‘Nginxå‘é€æ— æ•ˆçš„HTTPè¯·æ±‚ï¼Œè¯¥è¯·æ±‚å°†åŸæ ·è½¬å‘ç»™åç«¯ï¼Œåç«¯å°†ä»¥å…¶åŸå§‹å†…å®¹å›ç­”ã€‚ç„¶åï¼ŒNginxä¸ä¼šç†è§£æ— æ•ˆçš„HTTPå“åº”ï¼Œåªæ˜¯å°†å…¶è½¬å‘ç»™å®¢æˆ·ç«¯ã€‚æƒ³è±¡ä¸€ä¸‹è¿™æ ·çš„uWSGIåº”ç”¨ç¨‹åºï¼š
```python
def application(environ, start_response):
start_response('500 Error', [('Content-Type',
'text/html'),('Secret-Header','secret-info')])
return [b"Secret info, should not be visible!"]
```
ä»¥ä¸‹æ˜¯Nginxä¸­çš„æŒ‡ä»¤ï¼š
```
http {
error_page 500 /html/error.html;
proxy_intercept_errors on;
proxy_hide_header Secret-Header;
}
```
[proxy\_intercept\_errors](http://nginx.org/en/docs/http/ngx\_http\_proxy\_module.html#proxy\_intercept\_errors) å¦‚æœåç«¯çš„å“åº”çŠ¶æ€ç å¤§äº300ï¼Œå°†æä¾›è‡ªå®šä¹‰å“åº”ã€‚åœ¨æˆ‘ä»¬ä¸Šé¢çš„uWSGIåº”ç”¨ç¨‹åºä¸­ï¼Œæˆ‘ä»¬å°†å‘é€ä¸€ä¸ª`500 Error`ï¼Œè¿™å°†è¢«Nginxæ‹¦æˆªã€‚

[proxy\_hide\_header](http://nginx.org/en/docs/http/ngx\_http\_proxy\_module.html#proxy\_hide\_header) çš„å«ä¹‰éå¸¸ç›´æ¥ï¼›å®ƒå°†éšè—å®¢æˆ·ç«¯æŒ‡å®šçš„ä»»ä½•HTTPå¤´ã€‚

å¦‚æœæˆ‘ä»¬å‘é€ä¸€ä¸ªæ­£å¸¸çš„`GET`è¯·æ±‚ï¼ŒNginxå°†è¿”å›ï¼š
```
HTTP/1.1 500 Internal Server Error
Server: nginx/1.10.3
Content-Type: text/html
Content-Length: 34
Connection: close
```
ä½†å¦‚æœæˆ‘ä»¬å‘é€ä¸€ä¸ªæ— æ•ˆçš„HTTPè¯·æ±‚ï¼Œä¾‹å¦‚ï¼š
```
GET /? XTTP/1.1
Host: 127.0.0.1
Connection: close
```
æˆ‘ä»¬å°†å¾—åˆ°ä»¥ä¸‹å“åº”ï¼š
```
XTTP/1.1 500 Error
Content-Type: text/html
Secret-Header: secret-info

Secret info, should not be visible!
```
## merge\_slashes è®¾ç½®ä¸º off

[merge\_slashes](http://nginx.org/en/docs/http/ngx\_http\_core\_module.html#merge\_slashes) æŒ‡ä»¤é»˜è®¤è®¾ç½®ä¸ºâ€œonâ€ï¼Œè¿™æ˜¯ä¸€ç§æœºåˆ¶ï¼Œç”¨äºå°†ä¸¤ä¸ªæˆ–æ›´å¤šçš„æ­£æ–œæ å‹ç¼©æˆä¸€ä¸ªï¼Œå› æ­¤ `///` ä¼šå˜æˆ `/`ã€‚å¦‚æœ Nginx è¢«ç”¨ä½œåå‘ä»£ç†ï¼Œå¹¶ä¸”è¢«ä»£ç†çš„åº”ç”¨ç¨‹åºå®¹æ˜“å—åˆ°æœ¬åœ°æ–‡ä»¶åŒ…å«çš„æ”»å‡»ï¼Œé‚£ä¹ˆåœ¨è¯·æ±‚ä¸­ä½¿ç”¨é¢å¤–çš„æ–œæ å¯èƒ½ä¼šç•™ä¸‹å¯ä¾›åˆ©ç”¨çš„ç©ºé—´ã€‚è¿™ä¸€ç‚¹ç”± [Danny Robinson å’Œ Rotem Bar](https://medium.com/appsflyer/nginx-may-be-protecting-your-applications-from-traversal-attacks-without-you-even-knowing-b08f882fd43d) è¯¦ç»†æè¿°ã€‚

æˆ‘ä»¬å‘ç°äº† 33 ä¸ª Nginx é…ç½®æ–‡ä»¶å°† `merge_slashes` è®¾ç½®ä¸º â€œoffâ€ã€‚

## map æŒ‡ä»¤æœªæŒ‡å®šé»˜è®¤å€¼

å½“**`map` è¢«ç”¨äºæŸç§æˆæƒæ§åˆ¶**æ—¶ï¼Œè¿™ä¼¼ä¹æ˜¯ä¸€ä¸ªå¸¸è§çš„æƒ…å†µã€‚ç®€åŒ–çš„ä¾‹å­å¯èƒ½çœ‹èµ·æ¥åƒï¼š
```
http {
...
map $uri $mappocallow {
/map-poc/private 0;
/map-poc/secret 0;
/map-poc/public 1;
}
...
}
```

```
server {
...
location /map-poc {
if ($mappocallow = 0) {return 403;}
return 200 "Hello. It is private area: $mappocallow";
}
...
}
```
[æ ¹æ®æ‰‹å†Œ](https://nginx.org/en/docs/http/ngx_http_map_module.html)ï¼š

> é»˜è®¤å€¼\
> å¦‚æœæºå€¼ä¸æŒ‡å®šçš„å˜ä½“éƒ½ä¸åŒ¹é…ï¼Œåˆ™è®¾ç½®ç»“æœå€¼ã€‚å½“æœªæŒ‡å®šé»˜è®¤å€¼æ—¶ï¼Œ\
> é»˜è®¤çš„ç»“æœå€¼å°†æ˜¯ä¸€ä¸ªç©ºå­—ç¬¦ä¸²ã€‚

å¾ˆå®¹æ˜“å¿˜è®°`default`å€¼ã€‚å› æ­¤ï¼Œ**æ”»å‡»è€…å¯ä»¥é€šè¿‡ç®€å•åœ°è®¿é—®`/map-poc`ä¸­çš„ä¸€ä¸ª**ä¸å­˜åœ¨çš„æƒ…å†µæ¥ç»•è¿‡è¿™ç§â€œæˆæƒæ§åˆ¶â€ï¼Œä¾‹å¦‚`https://targethost.com/map-poc/another-private-area`ã€‚

## DNS Spoofing Nginx

æ ¹æ®è¿™ç¯‡æ–‡ç« ï¼š[http://blog.zorinaq.com/nginx-resolver-vulns/](http://blog.zorinaq.com/nginx-resolver-vulns/) **å¯èƒ½å¯ä»¥å¯¹Nginxè¿›è¡ŒDNSè®°å½•æ¬ºéª—**ï¼Œå¦‚æœä½ **çŸ¥é“Nginxæ­£åœ¨ä½¿ç”¨çš„DNSæœåŠ¡å™¨**ï¼ˆå¹¶ä¸”ä½ å¯ä»¥ä»¥æŸç§æ–¹å¼æ‹¦æˆªé€šä¿¡ï¼Œæ‰€ä»¥å¦‚æœä½¿ç”¨çš„æ˜¯127.0.0.1ï¼Œè¿™**ä¸é€‚ç”¨ï¼‰ä»¥åŠå®ƒ**æ­£åœ¨è¯¢é—®çš„åŸŸå**ã€‚

Nginxå¯ä»¥æŒ‡å®šä½¿ç”¨çš„DNSæœåŠ¡å™¨ï¼š
```
resolver     8.8.8.8;
```
## `proxy_pass` å’Œ `internal` æŒ‡ä»¤

**`proxy_pass`** æŒ‡ä»¤å¯ä»¥ç”¨æ¥**å°†è¯·æ±‚å†…éƒ¨é‡å®šå‘åˆ°å…¶ä»–æœåŠ¡å™¨**ï¼Œæ— è®ºæ˜¯å†…éƒ¨çš„è¿˜æ˜¯å¤–éƒ¨çš„ã€‚\
**`internal`** æŒ‡ä»¤ç”¨äºæ˜ç¡®å‘Šè¯‰ Nginxï¼Œ**ä½ç½®åªèƒ½å†…éƒ¨è®¿é—®**ã€‚

è¿™äº›æŒ‡ä»¤çš„ä½¿ç”¨**ä¸æ˜¯ä¸€ä¸ªæ¼æ´ï¼Œä½†ä½ åº”è¯¥æ£€æŸ¥å®ƒä»¬æ˜¯å¦‚ä½•é…ç½®çš„**ã€‚

## proxy\_set\_header Upgrade & Connection

å¦‚æœ nginx æœåŠ¡å™¨é…ç½®ä¸ºä¼ é€’ Upgrade å’Œ Connection å¤´ï¼Œé‚£ä¹ˆå¯ä»¥æ‰§è¡Œ [**h2c Smuggling æ”»å‡»**](../../pentesting-web/h2c-smuggling.md) æ¥è®¿é—®å—ä¿æŠ¤çš„/å†…éƒ¨ç«¯ç‚¹ã€‚

{% hint style="danger" %}
è¿™ä¸ªæ¼æ´å°†å…è®¸æ”»å‡»è€…**ä¸ `proxy_pass` ç«¯ç‚¹å»ºç«‹ç›´æ¥è¿æ¥**ï¼ˆåœ¨è¿™ä¸ªä¾‹å­ä¸­æ˜¯ `http://backend:9999`ï¼‰ï¼Œå…¶å†…å®¹ä¸ä¼šè¢« nginx æ£€æŸ¥ã€‚
{% endhint %}

ä»¥ä¸‹æ˜¯ä¸€ä¸ªæ˜“å—æ”»å‡»çš„é…ç½®ç¤ºä¾‹ï¼Œç”¨äºä»[è¿™é‡Œ](https://bishopfox.com/blog/h2c-smuggling-request)çªƒå– `/flag`ï¼š
```
server {
listen       443 ssl;
server_name  localhost;

ssl_certificate       /usr/local/nginx/conf/cert.pem;
ssl_certificate_key   /usr/local/nginx/conf/privkey.pem;

location / {
proxy_pass http://backend:9999;
proxy_http_version 1.1;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection $http_connection;
}

location /flag {
deny all;
}
```
{% hint style="warning" %}
è¯·æ³¨æ„ï¼Œå³ä½¿ `proxy_pass` æŒ‡å‘ä¸€ä¸ªç‰¹å®šçš„**è·¯å¾„**ï¼Œå¦‚ `http://backend:9999/socket.io`ï¼Œè¿æ¥ä¹Ÿä¼šä¸ `http://backend:9999` å»ºç«‹ï¼Œæ‰€ä»¥ä½ å¯ä»¥**è”ç³»è¯¥å†…éƒ¨ç«¯ç‚¹å†…çš„ä»»ä½•å…¶ä»–è·¯å¾„ã€‚å› æ­¤ï¼Œproxy\_pass çš„ URL ä¸­æŒ‡å®šçš„è·¯å¾„å¹¶ä¸é‡è¦ã€‚**
{% endhint %}

## äº²è‡ªå°è¯•

Detectify åˆ›å»ºäº†ä¸€ä¸ª GitHub ä»“åº“ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ Docker åœ¨è‡ªå·±çš„ç”µè„‘ä¸Šæ­å»ºä¸€ä¸ªå­˜åœ¨æœ¬æ–‡è®¨è®ºçš„ä¸€äº›é…ç½®é”™è¯¯çš„æ˜“å—æ”»å‡»çš„ Nginx æµ‹è¯•æœåŠ¡å™¨ï¼Œå¹¶å°è¯•è‡ªå·±æ‰¾å‡ºè¿™äº›é—®é¢˜ï¼

[https://github.com/detectify/vulnerable-nginx](https://github.com/detectify/vulnerable-nginx)

## é™æ€åˆ†æå·¥å…·

### [GIXY](https://github.com/yandex/gixy)

Gixy æ˜¯ä¸€ä¸ªç”¨äºåˆ†æ Nginx é…ç½®çš„å·¥å…·ã€‚Gixy çš„ä¸»è¦ç›®æ ‡æ˜¯é˜²æ­¢å®‰å…¨é…ç½®é”™è¯¯å¹¶è‡ªåŠ¨æ£€æµ‹ç¼ºé™·ã€‚

### [Nginxpwner](https://github.com/stark0de/nginxpwner)

Nginxpwner æ˜¯ä¸€ä¸ªç”¨äºå¯»æ‰¾å¸¸è§ Nginx é…ç½®é”™è¯¯å’Œæ¼æ´çš„ç®€å•å·¥å…·ã€‚

## å‚è€ƒèµ„æ–™

* [**https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/**](https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/)
* [**http://blog.zorinaq.com/nginx-resolver-vulns/**](http://blog.zorinaq.com/nginx-resolver-vulns/)
* [**https://github.com/yandex/gixy/issues/115**](https://github.com/yandex/gixy/issues/115)

<figure><img src="../../.gitbook/assets/image (1) (1) (2) (4).png" alt=""><figcaption></figcaption></figure>

[**DragonJAR Security Conference æ˜¯ä¸€ä¸ªå›½é™…æ€§çš„ç½‘ç»œå®‰å…¨äº‹ä»¶**](https://www.dragonjarcon.org/)ï¼Œå·²ç»ä¸¾åŠäº†åå¤šå¹´ï¼Œå°†äº 2023 å¹´ 9 æœˆ 7 æ—¥å’Œ 8 æ—¥åœ¨å“¥ä¼¦æ¯”äºšçš„æ³¢å“¥å¤§ä¸¾è¡Œã€‚è¿™æ˜¯ä¸€ä¸ªæŠ€æœ¯å†…å®¹ä¸°å¯Œçš„æ´»åŠ¨ï¼Œä¼šå±•ç¤ºæœ€æ–°çš„è¥¿ç­ç‰™è¯­ç ”ç©¶æˆæœï¼Œå¸å¼•äº†æ¥è‡ªä¸–ç•Œå„åœ°çš„é»‘å®¢å’Œç ”ç©¶äººå‘˜ã€‚
ç«‹å³åœ¨ä»¥ä¸‹é“¾æ¥æ³¨å†Œï¼Œä¸è¦é”™è¿‡è¿™ä¸ªé‡è¦çš„ä¼šè®®ï¼:

{% embed url="https://www.dragonjarcon.org/" %}

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸º</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨å¸Œæœ›åœ¨ **HackTricks** ä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½ HackTricks çš„ PDF ç‰ˆæœ¬**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTs é›†åˆ**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥**åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
