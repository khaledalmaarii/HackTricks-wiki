# Nginx

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="../../.gitbook/assets/image (14) (1).png" alt=""><figcaption></figcaption></figure>

**Odmah dostupna postavka za procenu ranjivosti i penetraciono testiranje**. Pokrenite potpuno pentestiranje sa bilo kog mesta uz 20+ alata i funkcija koje se kreÄ‡u od rekognosciranja do izveÅ¡tavanja. Ne zamenjujemo pentestere - razvijamo prilagoÄ‘ene alate, module za detekciju i eksploataciju kako bismo im vratili malo vremena da dublje istraÅ¾e, otvore shell-ove i zabave se.

{% embed url="https://pentest-tools.com/" %}

## NedostajuÄ‡i root direktorijum <a href="#missing-root-location" id="missing-root-location"></a>

Kada konfiguriÅ¡ete Nginx server, **root direktiva** igra kljuÄnu ulogu definiÅ¡uÄ‡i osnovni direktorijum iz kojeg se serviraju fajlovi. Razmotrite primer ispod:
```bash
server {
root /etc/nginx;

location /hello.txt {
try_files $uri $uri/ =404;
proxy_pass http://127.0.0.1:8080/;
}
}
```
U ovoj konfiguraciji, `/etc/nginx` je oznaÄen kao korenski direktorijum. Ova postavka omoguÄ‡ava pristup datotekama unutar specificiranog korenskog direktorijuma, kao Å¡to je `/hello.txt`. MeÄ‘utim, vaÅ¾no je napomenuti da je definisana samo specifiÄna lokacija (`/hello.txt`). Nema konfiguracije za korensku lokaciju (`location / {...}`). Ova propuÅ¡tena konfiguracija znaÄi da se korenska direktiva primenjuje globalno, omoguÄ‡avajuÄ‡i zahteve za korenskim putem `/` da pristupe datotekama pod `/etc/nginx`.

KritiÄna bezbednosna razmatranja proizilaze iz ove konfiguracije. Jednostavan `GET` zahtev, poput `GET /nginx.conf`, mogao bi otkriti osetljive informacije tako Å¡to bi posluÅ¾io Nginx konfiguracionu datoteku smeÅ¡tenu na `/etc/nginx/nginx.conf`. Postavljanje korena na manje osetljiv direktorijum, poput `/etc`, moglo bi smanjiti ovaj rizik, ali i dalje moÅ¾e omoguÄ‡iti nepredviÄ‘eni pristup drugim kritiÄnim datotekama, ukljuÄujuÄ‡i druge konfiguracione datoteke, logove pristupa, pa Äak i enkriptovane akreditive koriÅ¡Ä‡ene za HTTP osnovnu autentifikaciju.

## Alias LFI Misconfiguration <a href="#alias-lfi-misconfiguration" id="alias-lfi-misconfiguration"></a>

U konfiguracionim datotekama Nginx-a, bliska inspekcija je neophodna za "location" direktive. Ranljivost poznata kao Local File Inclusion (LFI) moÅ¾e biti nenamerno uvedena kroz konfiguraciju koja podseÄ‡a na sledeÄ‡u:
```
location /imgs {
alias /path/images/;
}
```
Ova konfiguracija je podloÅ¾na LFI napadima zbog toga Å¡to server interpretira zahteve poput `/imgs../flag.txt` kao pokuÅ¡aj pristupa datotekama van predviÄ‘ene direktorijuma, Å¡to se efektivno reÅ¡ava na `/path/images/../flag.txt`. Ova greÅ¡ka omoguÄ‡ava napadaÄima da preuzmu datoteke iz datoteÄnog sistema servera koje ne bi trebale biti dostupne putem veba.

Da bi se ublaÅ¾ila ova ranjivost, konfiguracija bi trebala biti prilagoÄ‘ena na:
```
location /imgs/ {
alias /path/images/;
}
```
ViÅ¡e informacija: [https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/](https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/)

Accunetix testovi:
```
alias../ => HTTP status code 403
alias.../ => HTTP status code 404
alias../../ => HTTP status code 403
alias../../../../../../../../../../../ => HTTP status code 400
alias../ => HTTP status code 403
```
## Unsafe path restriction <a href="#unsafe-variable-use" id="unsafe-variable-use"></a>

Proverite sledeÄ‡u stranicu da biste saznali kako da zaobiÄ‘ete direktive kao Å¡to su:
```plaintext
location = /admin {
deny all;
}

location = /admin/ {
deny all;
}
```
{% content-ref url="../../pentesting-web/proxy-waf-protections-bypass.md" %}
[proxy-waf-protections-bypass.md](../../pentesting-web/proxy-waf-protections-bypass.md)
{% endcontent-ref %}

## Nepravilna upotreba varijabli / Deljenje HTTP zahteva <a href="#unsafe-variable-use" id="unsafe-variable-use"></a>

{% hint style="danger" %}
Ranljive varijable `$uri` i `$document_uri` i ovo se moÅ¾e ispraviti zamenom sa `$request_uri`.

Regex moÅ¾e takoÄ‘e biti ranjiv kao:

`location ~ /docs/([^/])? { â€¦ $1 â€¦ }` - Ranljivo&#x20;

`location ~ /docs/([^/\s])? { â€¦ $1 â€¦ }` - Nije ranjivo (proverava razmake)

`location ~ /docs/(.*)? { â€¦ $1 â€¦ }`  - Nije ranjivo
{% endhint %}

Ranjivost u Nginx konfiguraciji je prikazana u sledeÄ‡em primeru:
```
location / {
return 302 https://example.com$uri;
}
```
Karakteri \r (Carriage Return) i \n (Line Feed) oznaÄavaju nove linije u HTTP zahtevima, a njihovi URL-enkodirani oblici predstavljeni su kao `%0d%0a`. UkljuÄivanje ovih karaktera u zahtev (npr., `http://localhost/%0d%0aDetectify:%20clrf`) na pogreÅ¡no konfigurisanoj serveru rezultira time da server izdaje novi header pod nazivom `Detectify`. To se deÅ¡ava zato Å¡to $uri varijabla dekodira URL-enkodirane nove linije, Å¡to dovodi do neoÄekivanog headera u odgovoru:
```
HTTP/1.1 302 Moved Temporarily
Server: nginx/1.19.3
Content-Type: text/html
Content-Length: 145
Connection: keep-alive
Location: https://example.com/
Detectify: clrf
```
Saznajte viÅ¡e o rizicima CRLF injekcije i deljenja odgovora na [https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/](https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/).

TakoÄ‘e, ova tehnika je [**objaÅ¡njena u ovom predavanju**](https://www.youtube.com/watch?v=gWQyWdZbdoY\&list=PL0xCSYnG\_iTtJe2V6PQqamBF73n7-f1Nr\&index=77) sa nekim ranjivim primerima i mehanizmima detekcije. Na primer, da biste otkrili ovu pogreÅ¡nu konfiguraciju iz perspektive crne kutije, mogli biste koristiti ove zahteve:

* `https://example.com/%20X` - Bilo koji HTTP kod
* `https://example.com/%20H` - 400 Bad Request

Ako je ranjiv, prvi Ä‡e se vratiti kao "X" je bilo koja HTTP metoda, a drugi Ä‡e vratiti greÅ¡ku jer H nije vaÅ¾eÄ‡a metoda. Tako Ä‡e server primiti neÅ¡to poput: `GET / H HTTP/1.1` i to Ä‡e izazvati greÅ¡ku.

Drugi primeri detekcije bi bili:

* `http://company.tld/%20HTTP/1.1%0D%0AXXXX:%20x` - Bilo koji HTTP kod
* `http://company.tld/%20HTTP/1.1%0D%0AHost:%20x` - 400 Bad Request

Neke pronaÄ‘ene ranjive konfiguracije predstavljene u tom predavanju su:

* Obratite paÅ¾nju kako je **`$uri`** postavljen kao Å¡to jeste u konaÄnom URL-u.
```
location ^~ /lite/api/ {
proxy_pass http://lite-backend$uri$is_args$args;
}
```
* Obratite paÅ¾nju kako je ponovo **`$uri`** u URL-u (ovog puta unutar parametra)
```
location ~ ^/dna/payment {
rewrite ^/dna/([^/]+) /registered/main.pl?cmd=unifiedPayment&context=$1&native_uri=$uri break;
proxy_pass http://$back;
```
* Sada u AWS S3
```
location /s3/ {
proxy_pass https://company-bucket.s3.amazonaws.com$uri;
}
```
### Any variable

Otkriveno je da **podaci koje unosi korisnik** mogu biti tretirani kao **Nginx varijabla** pod odreÄ‘enim okolnostima. Uzrok ovog ponaÅ¡anja ostaje donekle nejasan, ali nije retko niti jednostavno za verifikaciju. Ova anomalija je istaknuta u bezbednosnom izveÅ¡taju na HackerOne, koji se moÅ¾e pogledati [ovde](https://hackerone.com/reports/370094). Dalja istraga o poruci greÅ¡ke dovela je do identifikacije njenog pojavljivanja unutar [SSI filter modula Nginx-ove kodne baze](https://github.com/nginx/nginx/blob/2187586207e1465d289ae64cedc829719a048a39/src/http/modules/ngx\_http\_ssi\_filter\_module.c#L365), ukazujuÄ‡i na Server Side Includes (SSI) kao osnovni uzrok.

Da bi se **otkrila ova pogreÅ¡na konfiguracija**, moÅ¾e se izvrÅ¡iti sledeÄ‡a komanda, koja ukljuÄuje postavljanje referer zaglavlja za testiranje Å¡tampanja varijable:
```bash
$ curl -H â€˜Referer: barâ€™ http://localhost/foo$http_referer | grep â€˜foobarâ€™
```
Skeneri za ovu pogreÅ¡nu konfiguraciju Å¡irom sistema otkrili su viÅ¡e instanci gde su Nginx varijable mogle biti prikazane od strane korisnika. MeÄ‘utim, smanjenje broja ranjivih instanci sugeriÅ¡e da su napori za ispravku ovog problema bili donekle uspeÅ¡ni.

## ÄŒitanje sirovog odgovora backend-a

Nginx nudi funkciju putem `proxy_pass` koja omoguÄ‡ava presretanje greÅ¡aka i HTTP zaglavlja koja proizvodi backend, sa ciljem da sakrije interne poruke o greÅ¡kama i zaglavlja. To se postiÅ¾e tako Å¡to Nginx sluÅ¾i prilagoÄ‘ene stranice greÅ¡aka kao odgovor na greÅ¡ke backend-a. MeÄ‘utim, izazovi se javljaju kada Nginx naiÄ‘e na nevaÅ¾eÄ‡i HTTP zahtev. Takav zahtev se prosleÄ‘uje backend-u onako kako je primljen, a sirovi odgovor backend-a se zatim direktno Å¡alje klijentu bez intervencije Nginx-a.

Razmotrite primer scenarija koji ukljuÄuje uWSGI aplikaciju:
```python
def application(environ, start_response):
start_response('500 Error', [('Content-Type', 'text/html'), ('Secret-Header', 'secret-info')])
return [b"Secret info, should not be visible!"]
```
Da bi se to upravljalo, koriste se specifiÄne direktive u Nginx konfiguraciji:
```
http {
error_page 500 /html/error.html;
proxy_intercept_errors on;
proxy_hide_header Secret-Header;
}
```
* [**proxy\_intercept\_errors**](http://nginx.org/en/docs/http/ngx\_http\_proxy\_module.html#proxy\_intercept\_errors): Ova direktiva omoguÄ‡ava Nginxu da posluÅ¾uje prilagoÄ‘eni odgovor za pozadinske odgovore sa status kodom veÄ‡im od 300. Osigurava da, za naÅ¡ primer uWSGI aplikacije, `500 Error` odgovor bude presretnut i obraÄ‘en od strane Nginxa.
* [**proxy\_hide\_header**](http://nginx.org/en/docs/http/ngx\_http\_proxy\_module.html#proxy\_hide\_header): Kao Å¡to ime sugeriÅ¡e, ova direktiva skriva odreÄ‘ene HTTP zaglavlja od klijenta, poboljÅ¡avajuÄ‡i privatnost i sigurnost.

Kada se izvrÅ¡i vaÅ¾eÄ‡i `GET` zahtev, Nginx ga obraÄ‘uje normalno, vraÄ‡ajuÄ‡i standardni odgovor o greÅ¡ci bez otkrivanja bilo kakvih tajnih zaglavlja. MeÄ‘utim, nevaÅ¾eÄ‡i HTTP zahtev zaobilazi ovaj mehanizam, Å¡to rezultira izlaganjem sirovih pozadinskih odgovora, ukljuÄujuÄ‡i tajna zaglavlja i poruke o greÅ¡ci.

## merge\_slashes postavljeno na off

Podrazumevano, Nginxova **`merge_slashes` direktiva** je postavljena na **`on`**, Å¡to kompresuje viÅ¡e uzastopnih kose crte u URL-u u jednu kosu crtu. Ova funkcija, iako pojednostavljuje obradu URL-a, moÅ¾e nenamerno prikriti ranjivosti u aplikacijama iza Nginxa, posebno onima koje su podloÅ¾ne napadima lokalnog ukljuÄivanja datoteka (LFI). StruÄnjaci za bezbednost **Danny Robinson i Rotem Bar** su istakli potencijalne rizike povezane sa ovim podrazumevanim ponaÅ¡anjem, posebno kada Nginx deluje kao obrnuti proxy.

Da bi se umanjili takvi rizici, preporuÄuje se **iskljuÄivanje `merge_slashes` direktive** za aplikacije koje su podloÅ¾ne ovim ranjivostima. Ovo osigurava da Nginx prosledi zahteve aplikaciji bez izmene strukture URL-a, Äime se ne prikrivaju nikakvi osnovni bezbednosni problemi.

Za viÅ¡e informacija pogledajte [Danny Robinson i Rotem Bar](https://medium.com/appsflyer/nginx-may-be-protecting-your-applications-from-traversal-attacks-without-you-even-knowing-b08f882fd43d).

### **Maclicious Response Headers**

Kao Å¡to je prikazano u [**ovoj analizi**](https://mizu.re/post/cors-playground), postoje odreÄ‘ena zaglavlja koja, ako su prisutna u odgovoru sa web servera, menjaju ponaÅ¡anje Nginx proxy-a. MoÅ¾ete ih proveriti [**u dokumentaciji**](https://www.nginx.com/resources/wiki/start/topics/examples/x-accel/):

* `X-Accel-Redirect`: Ukazuje Nginxu da interno preusmeri zahtev na odreÄ‘enu lokaciju.
* `X-Accel-Buffering`: KontroliÅ¡e da li Nginx treba da keÅ¡ira odgovor ili ne.
* `X-Accel-Charset`: Postavlja karakter set za odgovor kada se koristi X-Accel-Redirect.
* `X-Accel-Expires`: Postavlja vreme isteka za odgovor kada se koristi X-Accel-Redirect.
* `X-Accel-Limit-Rate`: OgraniÄava brzinu prenosa za odgovore kada se koristi X-Accel-Redirect.

Na primer, zaglavlje **`X-Accel-Redirect`** Ä‡e izazvati interno **preusmeravanje** u Nginxu. Tako da imati Nginx konfiguraciju sa neÄim poput **`root /`** i odgovorom sa web servera sa **`X-Accel-Redirect: .env`** Ä‡e nagnati Nginx da poÅ¡alje sadrÅ¾aj **`/.env`** (Path Traversal).

### **Default Value in Map Directive**

U **Nginx konfiguraciji**, `map` direktiva Äesto igra ulogu u **kontroli autorizacije**. UobiÄajena greÅ¡ka je neodreÄ‘ivanje **podrazumevane** vrednosti, Å¡to moÅ¾e dovesti do neovlaÅ¡Ä‡enog pristupa. Na primer:
```yaml
http {
map $uri $mappocallow {
/map-poc/private 0;
/map-poc/secret 0;
/map-poc/public 1;
}
}
```

```yaml
server {
location /map-poc {
if ($mappocallow = 0) {return 403;}
return 200 "Hello. It is private area: $mappocallow";
}
}
```
Bez `default`, **zlonameran korisnik** moÅ¾e zaobiÄ‡i sigurnost pristupajuÄ‡i **neodreÄ‘enom URI** unutar `/map-poc`. [Nginx priruÄnik](https://nginx.org/en/docs/http/ngx\_http\_map\_module.html) savetuje postavljanje **podrazumevane vrednosti** kako bi se izbegli takvi problemi.

### **DNS Spoofing Ranljivost**

DNS spoofing protiv Nginx-a je izvodljiv pod odreÄ‘enim uslovima. Ako napadaÄ zna koji **DNS server** koristi Nginx i moÅ¾e presresti njegove DNS upite, moÅ¾e falsifikovati DNS zapise. Ova metoda, meÄ‘utim, nije efikasna ako je Nginx konfigurisan da koristi **localhost (127.0.0.1)** za DNS rezoluciju. Nginx omoguÄ‡ava specificiranje DNS servera na sledeÄ‡i naÄin:
```yaml
resolver 8.8.8.8;
```
### **`proxy_pass` i `internal` Direktive**

Direktiva **`proxy_pass`** se koristi za preusmeravanje zahteva na druge servere, bilo interno ili eksterno. Direktiva **`internal`** osigurava da su odreÄ‘ene lokacije dostupne samo unutar Nginx-a. Iako ove direktive same po sebi nisu ranjivosti, njihova konfiguracija zahteva paÅ¾ljivo ispitivanje kako bi se spreÄili sigurnosni propusti.

## proxy\_set\_header Upgrade & Connection

Ako je nginx server konfigurisan da prosledi Upgrade i Connection zaglavlja, moÅ¾e se izvesti [**h2c Smuggling napad**](../../pentesting-web/h2c-smuggling.md) kako bi se pristupilo zaÅ¡tiÄ‡enim/internim krajnjim taÄkama.

{% hint style="danger" %}
Ova ranjivost bi omoguÄ‡ila napadaÄu da **uspostavi direktnu vezu sa `proxy_pass` krajnjom taÄkom** (`http://backend:9999` u ovom sluÄaju) Äiji sadrÅ¾aj neÄ‡e biti proveravan od strane nginx-a.
{% endhint %}

Primer ranjive konfiguracije za kraÄ‘u `/flag` sa [ovde](https://bishopfox.com/blog/h2c-smuggling-request):
```
server {
listen       443 ssl;
server_name  localhost;

ssl_certificate       /usr/local/nginx/conf/cert.pem;
ssl_certificate_key   /usr/local/nginx/conf/privkey.pem;

location / {
proxy_pass http://backend:9999;
proxy_http_version 1.1;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection $http_connection;
}

location /flag {
deny all;
}
```
{% hint style="warning" %}
Napomena da Äak i ako je `proxy_pass` usmeren na odreÄ‘eni **put** kao Å¡to je `http://backend:9999/socket.io`, veza Ä‡e biti uspostavljena sa `http://backend:9999`, tako da moÅ¾ete **kontaktirati bilo koji drugi put unutar tog internog krajnjeg taÄke. Tako da nije vaÅ¾no da li je put specificiran u URL-u proxy_pass.**
{% endhint %}

## PokuÅ¡ajte sami

Detectify je kreirao GitHub repozitorijum gde moÅ¾ete koristiti Docker da postavite svoj vlastiti ranjivi Nginx test server sa nekim od pogreÅ¡nih konfiguracija o kojima se govori u ovom Älanku i pokuÅ¡ate da ih pronaÄ‘ete sami!

[https://github.com/detectify/vulnerable-nginx](https://github.com/detectify/vulnerable-nginx)

## Alati za statiÄku analizu

### [GIXY](https://github.com/yandex/gixy)

Gixy je alat za analizu Nginx konfiguracije. Glavni cilj Gixy je spreÄavanje sigurnosnih pogreÅ¡nih konfiguracija i automatizacija otkrivanja greÅ¡aka.

### [Nginxpwner](https://github.com/stark0de/nginxpwner)

Nginxpwner je jednostavan alat za traÅ¾enje uobiÄajenih Nginx pogreÅ¡nih konfiguracija i ranjivosti.

## Reference

* [**https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/**](https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/)
* [**http://blog.zorinaq.com/nginx-resolver-vulns/**](http://blog.zorinaq.com/nginx-resolver-vulns/)
* [**https://github.com/yandex/gixy/issues/115**](https://github.com/yandex/gixy/issues/115)

<figure><img src="../../.gitbook/assets/image (14) (1).png" alt=""><figcaption></figcaption></figure>

**Odmah dostupna postavka za procenu ranjivosti i penetraciono testiranje**. IzvrÅ¡ite potpuni pentest sa bilo kog mesta sa 20+ alata i funkcija koje idu od rekona do izveÅ¡tavanja. Ne zamenjujemo pentestere - razvijamo prilagoÄ‘ene alate, module za detekciju i eksploataciju kako bismo im vratili malo vremena da dublje istraÅ¾e, otvore shell-ove i zabave se.

{% embed url="https://pentest-tools.com/" %}

{% hint style="success" %}
UÄite i veÅ¾bajte AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
UÄite i veÅ¾bajte GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
