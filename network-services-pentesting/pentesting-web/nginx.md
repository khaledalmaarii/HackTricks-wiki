# Nginx

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="/.gitbook/assets/pentest-tools.svg" alt=""><figcaption></figcaption></figure>

**Configura√ß√£o instantaneamente dispon√≠vel para avalia√ß√£o de vulnerabilidades e testes de penetra√ß√£o**. Execute um pentest completo de qualquer lugar com mais de 20 ferramentas e recursos que v√£o de reconhecimento a relat√≥rios. N√£o substitu√≠mos os pentesters - desenvolvemos ferramentas personalizadas, m√≥dulos de detec√ß√£o e explora√ß√£o para dar a eles mais tempo para investigar mais a fundo, explorar vulnerabilidades e se divertir.

{% embed url="https://pentest-tools.com/?utm_term=jul2024&utm_medium=link&utm_source=hacktricks&utm_campaign=spons" %}

## Missing root location <a href="#missing-root-location" id="missing-root-location"></a>

Ao configurar o servidor Nginx, a **diretiva root** desempenha um papel cr√≠tico ao definir o diret√≥rio base a partir do qual os arquivos s√£o servidos. Considere o exemplo abaixo:
```bash
server {
root /etc/nginx;

location /hello.txt {
try_files $uri $uri/ =404;
proxy_pass http://127.0.0.1:8080/;
}
}
```
Nesta configura√ß√£o, `/etc/nginx` √© designado como o diret√≥rio raiz. Essa configura√ß√£o permite o acesso a arquivos dentro do diret√≥rio raiz especificado, como `/hello.txt`. No entanto, √© crucial notar que apenas uma localiza√ß√£o espec√≠fica (`/hello.txt`) √© definida. N√£o h√° configura√ß√£o para a localiza√ß√£o raiz (`location / {...}`). Essa omiss√£o significa que a diretiva raiz se aplica globalmente, permitindo que solicita√ß√µes para o caminho raiz `/` acessem arquivos sob `/etc/nginx`.

Uma considera√ß√£o cr√≠tica de seguran√ßa surge dessa configura√ß√£o. Uma simples solicita√ß√£o `GET`, como `GET /nginx.conf`, poderia expor informa√ß√µes sens√≠veis ao servir o arquivo de configura√ß√£o do Nginx localizado em `/etc/nginx/nginx.conf`. Definir a raiz para um diret√≥rio menos sens√≠vel, como `/etc`, poderia mitigar esse risco, mas ainda pode permitir acesso n√£o intencional a outros arquivos cr√≠ticos, incluindo outros arquivos de configura√ß√£o, logs de acesso e at√© mesmo credenciais criptografadas usadas para autentica√ß√£o b√°sica HTTP.

## Alias LFI Misconfiguration <a href="#alias-lfi-misconfiguration" id="alias-lfi-misconfiguration"></a>

Nos arquivos de configura√ß√£o do Nginx, uma inspe√ß√£o cuidadosa √© necess√°ria para as diretivas "location". Uma vulnerabilidade conhecida como Local File Inclusion (LFI) pode ser inadvertidamente introduzida atrav√©s de uma configura√ß√£o que se assemelha ao seguinte:
```
location /imgs {
alias /path/images/;
}
```
Esta configura√ß√£o √© suscet√≠vel a ataques LFI devido ao servidor interpretar solicita√ß√µes como `/imgs../flag.txt` como uma tentativa de acessar arquivos fora do diret√≥rio pretendido, resolvendo efetivamente para `/path/images/../flag.txt`. Essa falha permite que atacantes recuperem arquivos do sistema de arquivos do servidor que n√£o deveriam ser acess√≠veis via web.

Para mitigar essa vulnerabilidade, a configura√ß√£o deve ser ajustada para:
```
location /imgs/ {
alias /path/images/;
}
```
Mais informa√ß√µes: [https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/](https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/)

Testes da Accunetix:
```
alias../ => HTTP status code 403
alias.../ => HTTP status code 404
alias../../ => HTTP status code 403
alias../../../../../../../../../../../ => HTTP status code 400
alias../ => HTTP status code 403
```
## Restri√ß√£o de caminho inseguro <a href="#unsafe-variable-use" id="unsafe-variable-use"></a>

Verifique a p√°gina a seguir para aprender como contornar diretivas como:
```plaintext
location = /admin {
deny all;
}

location = /admin/ {
deny all;
}
```
{% content-ref url="../../pentesting-web/proxy-waf-protections-bypass.md" %}
[proxy-waf-protections-bypass.md](../../pentesting-web/proxy-waf-protections-bypass.md)
{% endcontent-ref %}

## Uso inseguro de vari√°veis / Divis√£o de Requisi√ß√µes HTTP <a href="#unsafe-variable-use" id="unsafe-variable-use"></a>

{% hint style="danger" %}
Vari√°veis vulner√°veis `$uri` e `$document_uri` e isso pode ser corrigido substituindo-as por `$request_uri`.

Uma regex tamb√©m pode ser vulner√°vel como:

`location ~ /docs/([^/])? { ‚Ä¶ $1 ‚Ä¶ }` - Vulner√°vel&#x20;

`location ~ /docs/([^/\s])? { ‚Ä¶ $1 ‚Ä¶ }` - N√£o vulner√°vel (verificando espa√ßos)

`location ~ /docs/(.*)? { ‚Ä¶ $1 ‚Ä¶ }`  - N√£o vulner√°vel
{% endhint %}

Uma vulnerabilidade na configura√ß√£o do Nginx √© demonstrada pelo exemplo abaixo:
```
location / {
return 302 https://example.com$uri;
}
```
Os caracteres \r (Carriage Return) e \n (Line Feed) significam caracteres de nova linha em solicita√ß√µes HTTP, e suas formas codificadas em URL s√£o representadas como `%0d%0a`. Incluir esses caracteres em uma solicita√ß√£o (por exemplo, `http://localhost/%0d%0aDetectify:%20clrf`) para um servidor mal configurado resulta no servidor emitindo um novo cabe√ßalho chamado `Detectify`. Isso acontece porque a vari√°vel $uri decodifica os caracteres de nova linha codificados em URL, levando a um cabe√ßalho inesperado na resposta:
```
HTTP/1.1 302 Moved Temporarily
Server: nginx/1.19.3
Content-Type: text/html
Content-Length: 145
Connection: keep-alive
Location: https://example.com/
Detectify: clrf
```
Saiba mais sobre os riscos da inje√ß√£o CRLF e divis√£o de resposta em [https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/](https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/).

Al√©m disso, essa t√©cnica √© [**explicada nesta palestra**](https://www.youtube.com/watch?v=gWQyWdZbdoY\&list=PL0xCSYnG\_iTtJe2V6PQqamBF73n7-f1Nr\&index=77) com alguns exemplos vulner√°veis e mecanismos de detec√ß√£o. Por exemplo, para detectar essa m√° configura√ß√£o a partir de uma perspectiva de caixa preta, voc√™ poderia usar essas requisi√ß√µes:

* `https://example.com/%20X` - Qualquer c√≥digo HTTP
* `https://example.com/%20H` - 400 Bad Request

Se vulner√°vel, o primeiro retornar√° como "X" √© qualquer m√©todo HTTP e o segundo retornar√° um erro, pois H n√£o √© um m√©todo v√°lido. Assim, o servidor receber√° algo como: `GET / H HTTP/1.1` e isso acionar√° o erro.

Outros exemplos de detec√ß√£o seriam:

* `http://company.tld/%20HTTP/1.1%0D%0AXXXX:%20x` - Qualquer c√≥digo HTTP
* `http://company.tld/%20HTTP/1.1%0D%0AHost:%20x` - 400 Bad Request

Algumas configura√ß√µes vulner√°veis encontradas apresentadas nessa palestra foram:

* Note como **`$uri`** √© definido como est√° na URL final.
```
location ^~ /lite/api/ {
proxy_pass http://lite-backend$uri$is_args$args;
}
```
* Note como novamente **`$uri`** est√° na URL (desta vez dentro de um par√¢metro)
```
location ~ ^/dna/payment {
rewrite ^/dna/([^/]+) /registered/main.pl?cmd=unifiedPayment&context=$1&native_uri=$uri break;
proxy_pass http://$back;
```
* Agora no AWS S3
```
location /s3/ {
proxy_pass https://company-bucket.s3.amazonaws.com$uri;
}
```
### Any variable

Foi descoberto que **dados fornecidos pelo usu√°rio** podem ser tratados como uma **vari√°vel Nginx** sob certas circunst√¢ncias. A causa desse comportamento permanece um tanto elusiva, mas n√£o √© rara nem f√°cil de verificar. Essa anomalia foi destacada em um relat√≥rio de seguran√ßa no HackerOne, que pode ser visualizado [aqui](https://hackerone.com/reports/370094). Uma investiga√ß√£o mais aprofundada na mensagem de erro levou √† identifica√ß√£o de sua ocorr√™ncia dentro do [m√≥dulo de filtro SSI do c√≥digo-fonte do Nginx](https://github.com/nginx/nginx/blob/2187586207e1465d289ae64cedc829719a048a39/src/http/modules/ngx_http_ssi_filter_module.c#L365), apontando Server Side Includes (SSI) como a causa raiz.

Para **detectar essa m√° configura√ß√£o**, o seguinte comando pode ser executado, que envolve definir um cabe√ßalho referer para testar a impress√£o de vari√°veis:
```bash
$ curl -H ‚ÄòReferer: bar‚Äô http://localhost/foo$http_referer | grep ‚Äòfoobar‚Äô
```
Scans for this misconfiguration across systems revealed multiple instances where Nginx variables could be printed by a user. However, a decrease in the number of vulnerable instances suggests that efforts to patch this issue have been somewhat successful.

## Leitura da resposta bruta do backend

Nginx oferece um recurso atrav√©s de `proxy_pass` que permite a intercepta√ß√£o de erros e cabe√ßalhos HTTP produzidos pelo backend, visando ocultar mensagens de erro internas e cabe√ßalhos. Isso √© realizado pelo Nginx servindo p√°ginas de erro personalizadas em resposta a erros do backend. No entanto, desafios surgem quando o Nginx encontra uma solicita√ß√£o HTTP inv√°lida. Tal solicita√ß√£o √© encaminhada para o backend como recebida, e a resposta bruta do backend √© ent√£o enviada diretamente ao cliente sem a interven√ß√£o do Nginx.

Considere um cen√°rio de exemplo envolvendo uma aplica√ß√£o uWSGI:
```python
def application(environ, start_response):
start_response('500 Error', [('Content-Type', 'text/html'), ('Secret-Header', 'secret-info')])
return [b"Secret info, should not be visible!"]
```
Para gerenciar isso, diretivas espec√≠ficas na configura√ß√£o do Nginx s√£o usadas:
```
http {
error_page 500 /html/error.html;
proxy_intercept_errors on;
proxy_hide_header Secret-Header;
}
```
* [**proxy\_intercept\_errors**](http://nginx.org/en/docs/http/ngx\_http\_proxy\_module.html#proxy\_intercept\_errors): Esta diretiva permite que o Nginx sirva uma resposta personalizada para respostas de backend com um c√≥digo de status maior que 300. Isso garante que, para nosso exemplo de aplica√ß√£o uWSGI, uma resposta de `500 Error` seja interceptada e tratada pelo Nginx.
* [**proxy\_hide\_header**](http://nginx.org/en/docs/http/ngx\_http\_proxy\_module.html#proxy\_hide\_header): Como o nome sugere, esta diretiva oculta cabe√ßalhos HTTP especificados do cliente, melhorando a privacidade e a seguran√ßa.

Quando uma solicita√ß√£o `GET` v√°lida √© feita, o Nginx a processa normalmente, retornando uma resposta de erro padr√£o sem revelar cabe√ßalhos secretos. No entanto, uma solicita√ß√£o HTTP inv√°lida contorna esse mecanismo, resultando na exposi√ß√£o de respostas brutas do backend, incluindo cabe√ßalhos secretos e mensagens de erro.

## merge\_slashes definido como off

Por padr√£o, a **diretiva `merge_slashes` do Nginx** est√° definida como **`on`**, o que comprime m√∫ltiplas barras (slashes) em uma URL em uma √∫nica barra. Este recurso, embora simplifique o processamento de URLs, pode inadvertidamente ocultar vulnerabilidades em aplica√ß√µes atr√°s do Nginx, particularmente aquelas suscet√≠veis a ataques de inclus√£o de arquivos locais (LFI). Especialistas em seguran√ßa **Danny Robinson e Rotem Bar** destacaram os riscos potenciais associados a esse comportamento padr√£o, especialmente quando o Nginx atua como um reverse-proxy.

Para mitigar tais riscos, √© recomendado **desativar a diretiva `merge_slashes`** para aplica√ß√µes suscet√≠veis a essas vulnerabilidades. Isso garante que o Nginx encaminhe solicita√ß√µes para a aplica√ß√£o sem alterar a estrutura da URL, n√£o mascarando assim quaisquer problemas de seguran√ßa subjacentes.

Para mais informa√ß√µes, consulte [Danny Robinson e Rotem Bar](https://medium.com/appsflyer/nginx-may-be-protecting-your-applications-from-traversal-attacks-without-you-even-knowing-b08f882fd43d).

### **Cabe√ßalhos de Resposta Maclicious**

Como mostrado em [**este artigo**](https://mizu.re/post/cors-playground), existem certos cabe√ßalhos que, se presentes na resposta do servidor web, mudar√£o o comportamento do proxy Nginx. Voc√™ pode verific√°-los [**na documenta√ß√£o**](https://www.nginx.com/resources/wiki/start/topics/examples/x-accel/):

* `X-Accel-Redirect`: Indica ao Nginx para redirecionar internamente uma solicita√ß√£o para um local especificado.
* `X-Accel-Buffering`: Controla se o Nginx deve ou n√£o armazenar em buffer a resposta.
* `X-Accel-Charset`: Define o conjunto de caracteres para a resposta ao usar X-Accel-Redirect.
* `X-Accel-Expires`: Define o tempo de expira√ß√£o para a resposta ao usar X-Accel-Redirect.
* `X-Accel-Limit-Rate`: Limita a taxa de transfer√™ncia para respostas ao usar X-Accel-Redirect.

Por exemplo, o cabe√ßalho **`X-Accel-Redirect`** causar√° um **redirecionamento** interno no Nginx. Portanto, ter uma configura√ß√£o do Nginx com algo como **`root /`** e uma resposta do servidor web com **`X-Accel-Redirect: .env`** far√° com que o Nginx envie o conte√∫do de **`/.env`** (Path Traversal).

### **Valor Padr√£o na Diretiva Map**

Na **configura√ß√£o do Nginx**, a diretiva `map` frequentemente desempenha um papel no **controle de autoriza√ß√£o**. Um erro comum √© n√£o especificar um valor **padr√£o**, o que pode levar a acessos n√£o autorizados. Por exemplo:
```yaml
http {
map $uri $mappocallow {
/map-poc/private 0;
/map-poc/secret 0;
/map-poc/public 1;
}
}
```

```yaml
server {
location /map-poc {
if ($mappocallow = 0) {return 403;}
return 200 "Hello. It is private area: $mappocallow";
}
}
```
Sem um `default`, um **usu√°rio malicioso** pode contornar a seguran√ßa acessando uma **URI indefinida** dentro de `/map-poc`. [O manual do Nginx](https://nginx.org/en/docs/http/ngx\_http\_map\_module.html) aconselha definir um **valor padr√£o** para evitar tais problemas.

### **Vulnerabilidade de Spoofing de DNS**

O spoofing de DNS contra o Nginx √© vi√°vel sob certas condi√ß√µes. Se um atacante souber o **servidor DNS** usado pelo Nginx e puder interceptar suas consultas DNS, ele pode falsificar registros DNS. No entanto, esse m√©todo √© ineficaz se o Nginx estiver configurado para usar **localhost (127.0.0.1)** para resolu√ß√£o de DNS. O Nginx permite especificar um servidor DNS da seguinte forma:
```yaml
resolver 8.8.8.8;
```
### **`proxy_pass` e Diretrizes `internal`**

A diretriz **`proxy_pass`** √© utilizada para redirecionar solicita√ß√µes para outros servidores, seja internamente ou externamente. A diretriz **`internal`** garante que certos locais sejam acess√≠veis apenas dentro do Nginx. Embora essas diretrizes n√£o sejam vulnerabilidades por si mesmas, sua configura√ß√£o requer uma an√°lise cuidadosa para evitar falhas de seguran√ßa.

## proxy\_set\_header Upgrade & Connection

Se o servidor nginx estiver configurado para passar os cabe√ßalhos Upgrade e Connection, um [**ataque de h2c Smuggling**](../../pentesting-web/h2c-smuggling.md) poderia ser realizado para acessar endpoints protegidos/internos.

{% hint style="danger" %}
Essa vulnerabilidade permitiria que um atacante **estabelecesse uma conex√£o direta com o endpoint `proxy_pass`** (`http://backend:9999` neste caso) cujo conte√∫do n√£o ser√° verificado pelo nginx.
{% endhint %}

Exemplo de configura√ß√£o vulner√°vel para roubar `/flag` de [aqui](https://bishopfox.com/blog/h2c-smuggling-request):
```
server {
listen       443 ssl;
server_name  localhost;

ssl_certificate       /usr/local/nginx/conf/cert.pem;
ssl_certificate_key   /usr/local/nginx/conf/privkey.pem;

location / {
proxy_pass http://backend:9999;
proxy_http_version 1.1;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection $http_connection;
}

location /flag {
deny all;
}
```
{% hint style="warning" %}
Note que mesmo que o `proxy_pass` esteja apontando para um **caminho** espec√≠fico como `http://backend:9999/socket.io`, a conex√£o ser√° estabelecida com `http://backend:9999`, ent√£o voc√™ pode **contatar qualquer outro caminho dentro desse endpoint interno. Portanto, n√£o importa se um caminho √© especificado na URL do proxy_pass.**
{% endhint %}

## Tente voc√™ mesmo

A Detectify criou um reposit√≥rio no GitHub onde voc√™ pode usar o Docker para configurar seu pr√≥prio servidor de teste Nginx vulner√°vel com algumas das configura√ß√µes incorretas discutidas neste artigo e tentar encontr√°-las voc√™ mesmo!

[https://github.com/detectify/vulnerable-nginx](https://github.com/detectify/vulnerable-nginx)

## Ferramentas de An√°lise Est√°tica

### [GIXY](https://github.com/yandex/gixy)

Gixy √© uma ferramenta para analisar a configura√ß√£o do Nginx. O principal objetivo do Gixy √© prevenir configura√ß√µes de seguran√ßa incorretas e automatizar a detec√ß√£o de falhas.

### [Nginxpwner](https://github.com/stark0de/nginxpwner)

Nginxpwner √© uma ferramenta simples para procurar configura√ß√µes incorretas e vulnerabilidades comuns do Nginx.

## Refer√™ncias

* [**https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/**](https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/)
* [**http://blog.zorinaq.com/nginx-resolver-vulns/**](http://blog.zorinaq.com/nginx-resolver-vulns/)
* [**https://github.com/yandex/gixy/issues/115**](https://github.com/yandex/gixy/issues/115)

<figure><img src="/.gitbook/assets/pentest-tools.svg" alt=""><figcaption></figcaption></figure>

**Configura√ß√£o instantaneamente dispon√≠vel para avalia√ß√£o de vulnerabilidades & pentesting**. Execute um pentest completo de qualquer lugar com mais de 20 ferramentas e recursos que v√£o de reconhecimento a relat√≥rios. N√£o substitu√≠mos os pentesters - desenvolvemos ferramentas personalizadas, m√≥dulos de detec√ß√£o e explora√ß√£o para dar a eles mais tempo para investigar mais a fundo, explorar e se divertir.

{% embed url="https://pentest-tools.com/?utm_term=jul2024&utm_medium=link&utm_source=hacktricks&utm_campaign=spons" %}

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte ao HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}
