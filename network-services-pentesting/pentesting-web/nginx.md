# Nginx

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

<figure><img src="../../.gitbook/assets/image (14) (1).png" alt=""><figcaption></figcaption></figure>

**å³æ—¶å¯ç”¨çš„æ¼æ´è¯„ä¼°ä¸æ¸—é€æµ‹è¯•è®¾ç½®**ã€‚ä»ä»»ä½•åœ°æ–¹è¿è¡Œå®Œæ•´çš„æ¸—é€æµ‹è¯•ï¼Œä½¿ç”¨ 20 å¤šç§å·¥å…·å’ŒåŠŸèƒ½ï¼Œä»ä¾¦å¯Ÿåˆ°æŠ¥å‘Šã€‚æˆ‘ä»¬ä¸æ›¿ä»£æ¸—é€æµ‹è¯•äººå‘˜ - æˆ‘ä»¬å¼€å‘è‡ªå®šä¹‰å·¥å…·ã€æ£€æµ‹å’Œåˆ©ç”¨æ¨¡å—ï¼Œä»¥ä¾¿è®©ä»–ä»¬æœ‰æ›´å¤šæ—¶é—´æ·±å…¥æŒ–æ˜ã€è·å– shell å¹¶äº«å—ä¹è¶£ã€‚

{% embed url="https://pentest-tools.com/" %}

## ç¼ºå¤±çš„æ ¹ç›®å½• <a href="#missing-root-location" id="missing-root-location"></a>

åœ¨é…ç½® Nginx æœåŠ¡å™¨æ—¶ï¼Œ**root æŒ‡ä»¤**é€šè¿‡å®šä¹‰æ–‡ä»¶æä¾›çš„åŸºç¡€ç›®å½•å‘æŒ¥ç€å…³é”®ä½œç”¨ã€‚è€ƒè™‘ä¸‹é¢çš„ç¤ºä¾‹ï¼š
```bash
server {
root /etc/nginx;

location /hello.txt {
try_files $uri $uri/ =404;
proxy_pass http://127.0.0.1:8080/;
}
}
```
åœ¨æ­¤é…ç½®ä¸­ï¼Œ`/etc/nginx` è¢«æŒ‡å®šä¸ºæ ¹ç›®å½•ã€‚æ­¤è®¾ç½®å…è®¸è®¿é—®æŒ‡å®šæ ¹ç›®å½•ä¸­çš„æ–‡ä»¶ï¼Œä¾‹å¦‚ `/hello.txt`ã€‚ç„¶è€Œï¼Œé‡è¦çš„æ˜¯è¦æ³¨æ„ï¼Œä»…å®šä¹‰äº†ä¸€ä¸ªç‰¹å®šä½ç½®ï¼ˆ`/hello.txt`ï¼‰ã€‚æ ¹ä½ç½®ï¼ˆ`location / {...}`ï¼‰æ²¡æœ‰é…ç½®ã€‚è¿™ä¸€é—æ¼æ„å‘³ç€æ ¹æŒ‡ä»¤é€‚ç”¨äºå…¨å±€ï¼Œä½¿å¾—å¯¹æ ¹è·¯å¾„ `/` çš„è¯·æ±‚èƒ½å¤Ÿè®¿é—® `/etc/nginx` ä¸‹çš„æ–‡ä»¶ã€‚

æ­¤é…ç½®å¼•å‘äº†ä¸€ä¸ªå…³é”®çš„å®‰å…¨è€ƒè™‘ã€‚ä¸€ä¸ªç®€å•çš„ `GET` è¯·æ±‚ï¼Œä¾‹å¦‚ `GET /nginx.conf`ï¼Œå¯èƒ½ä¼šé€šè¿‡æä¾›ä½äº `/etc/nginx/nginx.conf` çš„ Nginx é…ç½®æ–‡ä»¶æ¥æš´éœ²æ•æ„Ÿä¿¡æ¯ã€‚å°†æ ¹ç›®å½•è®¾ç½®ä¸ºä¸é‚£ä¹ˆæ•æ„Ÿçš„ç›®å½•ï¼Œä¾‹å¦‚ `/etc`ï¼Œå¯ä»¥å‡è½»æ­¤é£é™©ï¼Œä½†ä»å¯èƒ½å…è®¸æ„å¤–è®¿é—®å…¶ä»–å…³é”®æ–‡ä»¶ï¼ŒåŒ…æ‹¬å…¶ä»–é…ç½®æ–‡ä»¶ã€è®¿é—®æ—¥å¿—ï¼Œç”šè‡³ç”¨äº HTTP åŸºæœ¬èº«ä»½éªŒè¯çš„åŠ å¯†å‡­æ®ã€‚

## Alias LFI Misconfiguration <a href="#alias-lfi-misconfiguration" id="alias-lfi-misconfiguration"></a>

åœ¨ Nginx çš„é…ç½®æ–‡ä»¶ä¸­ï¼Œ"location" æŒ‡ä»¤éœ€è¦ä»”ç»†æ£€æŸ¥ã€‚é€šè¿‡ç±»ä¼¼ä»¥ä¸‹çš„é…ç½®ï¼Œå¯èƒ½ä¼šæ— æ„ä¸­å¼•å…¥ä¸€ç§ç§°ä¸ºæœ¬åœ°æ–‡ä»¶åŒ…å«ï¼ˆLFIï¼‰çš„æ¼æ´ï¼š
```
location /imgs {
alias /path/images/;
}
```
æ­¤é…ç½®å®¹æ˜“å—åˆ°LFIæ”»å‡»ï¼Œå› ä¸ºæœåŠ¡å™¨å°†è¯·æ±‚å¦‚`/imgs../flag.txt`è§£é‡Šä¸ºå°è¯•è®¿é—®æ„å›¾ä¹‹å¤–çš„æ–‡ä»¶ï¼Œæœ‰æ•ˆåœ°è§£æä¸º`/path/images/../flag.txt`ã€‚æ­¤ç¼ºé™·å…è®¸æ”»å‡»è€…ä»æœåŠ¡å™¨çš„æ–‡ä»¶ç³»ç»Ÿä¸­æ£€ç´¢ä¸åº”é€šè¿‡ç½‘ç»œè®¿é—®çš„æ–‡ä»¶ã€‚

ä¸ºäº†å‡è½»æ­¤æ¼æ´ï¼Œåº”è°ƒæ•´é…ç½®ä¸ºï¼š
```
location /imgs/ {
alias /path/images/;
}
```
æ›´å¤šä¿¡æ¯: [https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/](https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/)

Accunetix æµ‹è¯•:
```
alias../ => HTTP status code 403
alias.../ => HTTP status code 404
alias../../ => HTTP status code 403
alias../../../../../../../../../../../ => HTTP status code 400
alias../ => HTTP status code 403
```
## ä¸å®‰å…¨çš„è·¯å¾„é™åˆ¶ <a href="#unsafe-variable-use" id="unsafe-variable-use"></a>

æŸ¥çœ‹ä»¥ä¸‹é¡µé¢ä»¥äº†è§£å¦‚ä½•ç»•è¿‡æŒ‡ä»¤ï¼Œä¾‹å¦‚ï¼š
```plaintext
location = /admin {
deny all;
}

location = /admin/ {
deny all;
}
```
{% content-ref url="../../pentesting-web/proxy-waf-protections-bypass.md" %}
[proxy-waf-protections-bypass.md](../../pentesting-web/proxy-waf-protections-bypass.md)
{% endcontent-ref %}

## ä¸å®‰å…¨çš„å˜é‡ä½¿ç”¨ / HTTP è¯·æ±‚æ‹†åˆ† <a href="#unsafe-variable-use" id="unsafe-variable-use"></a>

{% hint style="danger" %}
æ˜“å—æ”»å‡»çš„å˜é‡ `$uri` å’Œ `$document_uri`ï¼Œå¯ä»¥é€šè¿‡å°†å®ƒä»¬æ›¿æ¢ä¸º `$request_uri` æ¥ä¿®å¤ã€‚

æ­£åˆ™è¡¨è¾¾å¼ä¹Ÿå¯èƒ½å­˜åœ¨æ¼æ´ï¼Œä¾‹å¦‚ï¼š

`location ~ /docs/([^/])? { â€¦ $1 â€¦ }` - æ˜“å—æ”»å‡»&#x20;

`location ~ /docs/([^/\s])? { â€¦ $1 â€¦ }` - ä¸æ˜“å—æ”»å‡»ï¼ˆæ£€æŸ¥ç©ºæ ¼ï¼‰

`location ~ /docs/(.*)? { â€¦ $1 â€¦ }`  - ä¸æ˜“å—æ”»å‡»
{% endhint %}

Nginx é…ç½®ä¸­çš„ä¸€ä¸ªæ¼æ´é€šè¿‡ä»¥ä¸‹ç¤ºä¾‹æ¼”ç¤ºï¼š
```
location / {
return 302 https://example.com$uri;
}
```
åœ¨HTTPè¯·æ±‚ä¸­ï¼Œå­—ç¬¦\rï¼ˆå›è½¦ï¼‰å’Œ\nï¼ˆæ¢è¡Œï¼‰è¡¨ç¤ºæ–°è¡Œå­—ç¬¦ï¼Œå®ƒä»¬çš„URLç¼–ç å½¢å¼è¡¨ç¤ºä¸º`%0d%0a`ã€‚åœ¨è¯·æ±‚ä¸­åŒ…å«è¿™äº›å­—ç¬¦ï¼ˆä¾‹å¦‚ï¼Œ`http://localhost/%0d%0aDetectify:%20clrf`ï¼‰åˆ°ä¸€ä¸ªé…ç½®é”™è¯¯çš„æœåŠ¡å™¨ï¼Œä¼šå¯¼è‡´æœåŠ¡å™¨å‘å‡ºä¸€ä¸ªåä¸º`Detectify`çš„æ–°å¤´ã€‚è¿™æ˜¯å› ä¸º$uriå˜é‡è§£ç äº†URLç¼–ç çš„æ–°è¡Œå­—ç¬¦ï¼Œä»è€Œå¯¼è‡´å“åº”ä¸­å‡ºç°æ„å¤–çš„å¤´ï¼š
```
HTTP/1.1 302 Moved Temporarily
Server: nginx/1.19.3
Content-Type: text/html
Content-Length: 145
Connection: keep-alive
Location: https://example.com/
Detectify: clrf
```
äº†è§£æœ‰å…³ CRLF æ³¨å…¥å’Œå“åº”æ‹†åˆ†é£é™©çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·è®¿é—® [https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/](https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/)ã€‚

æ­¤å¤–ï¼Œè¿™ç§æŠ€æœ¯åœ¨ [**è¿™ä¸ªæ¼”è®²ä¸­è§£é‡Š**](https://www.youtube.com/watch?v=gWQyWdZbdoY\&list=PL0xCSYnG\_iTtJe2V6PQqamBF73n7-f1Nr\&index=77) ä¸­æœ‰ä¸€äº›è„†å¼±çš„ç¤ºä¾‹å’Œæ£€æµ‹æœºåˆ¶ã€‚ä¾‹å¦‚ï¼Œä¸ºäº†ä»é»‘ç®±çš„è§’åº¦æ£€æµ‹è¿™ç§é”™è¯¯é…ç½®ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹è¯·æ±‚ï¼š

* `https://example.com/%20X` - ä»»ä½• HTTP ä»£ç 
* `https://example.com/%20H` - 400 é”™è¯¯è¯·æ±‚

å¦‚æœå­˜åœ¨æ¼æ´ï¼Œç¬¬ä¸€ä¸ªå°†è¿”å›ï¼Œå› ä¸º "X" æ˜¯ä»»ä½• HTTP æ–¹æ³•ï¼Œç¬¬äºŒä¸ªå°†è¿”å›é”™è¯¯ï¼Œå› ä¸º H ä¸æ˜¯æœ‰æ•ˆçš„æ–¹æ³•ã€‚å› æ­¤ï¼ŒæœåŠ¡å™¨å°†æ¥æ”¶åˆ°ç±»ä¼¼äº `GET / H HTTP/1.1` çš„å†…å®¹ï¼Œè¿™å°†è§¦å‘é”™è¯¯ã€‚

å¦ä¸€ä¸ªæ£€æµ‹ç¤ºä¾‹æ˜¯ï¼š

* `http://company.tld/%20HTTP/1.1%0D%0AXXXX:%20x` - ä»»ä½• HTTP ä»£ç 
* `http://company.tld/%20HTTP/1.1%0D%0AHost:%20x` - 400 é”™è¯¯è¯·æ±‚

åœ¨è¯¥æ¼”è®²ä¸­å‘ç°çš„ä¸€äº›è„†å¼±é…ç½®æ˜¯ï¼š

* æ³¨æ„ **`$uri`** åœ¨æœ€ç»ˆ URL ä¸­æ˜¯å¦‚ä½•è®¾ç½®çš„
```
location ^~ /lite/api/ {
proxy_pass http://lite-backend$uri$is_args$args;
}
```
* æ³¨æ„**`$uri`**å†æ¬¡å‡ºç°åœ¨URLä¸­ï¼ˆè¿™æ¬¡åœ¨ä¸€ä¸ªå‚æ•°å†…ï¼‰
```
location ~ ^/dna/payment {
rewrite ^/dna/([^/]+) /registered/main.pl?cmd=unifiedPayment&context=$1&native_uri=$uri break;
proxy_pass http://$back;
```
* ç°åœ¨åœ¨ AWS S3
```
location /s3/ {
proxy_pass https://company-bucket.s3.amazonaws.com$uri;
}
```
### Any variable

å‘ç°**ç”¨æˆ·æä¾›çš„æ•°æ®**åœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½è¢«è§†ä¸º**Nginx å˜é‡**ã€‚è¿™ç§è¡Œä¸ºçš„åŸå› ä»ç„¶æœ‰äº›æ¨¡ç³Šï¼Œä½†å¹¶ä¸ç½•è§ï¼Œä¹Ÿä¸å®¹æ˜“éªŒè¯ã€‚è¿™ä¸ªå¼‚å¸¸åœ¨HackerOneçš„å®‰å…¨æŠ¥å‘Šä¸­å¾—åˆ°äº†å¼ºè°ƒï¼Œå¯ä»¥åœ¨[è¿™é‡Œ](https://hackerone.com/reports/370094)æŸ¥çœ‹ã€‚å¯¹é”™è¯¯æ¶ˆæ¯çš„è¿›ä¸€æ­¥è°ƒæŸ¥å¯¼è‡´è¯†åˆ«å‡ºå®ƒåœ¨[Nginxä»£ç åº“çš„SSIè¿‡æ»¤æ¨¡å—](https://github.com/nginx/nginx/blob/2187586207e1465d289ae64cedc829719a048a39/src/http/modules/ngx_http_ssi_filter_module.c#L365)ä¸­çš„å‘ç”Ÿï¼Œç¡®å®šæœåŠ¡å™¨ç«¯åŒ…å«ï¼ˆSSIï¼‰æ˜¯æ ¹æœ¬åŸå› ã€‚

è¦**æ£€æµ‹æ­¤é”™è¯¯é…ç½®**ï¼Œå¯ä»¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œè¯¥å‘½ä»¤æ¶‰åŠè®¾ç½®å¼•ç”¨å¤´ä»¥æµ‹è¯•å˜é‡æ‰“å°ï¼š
```bash
$ curl -H â€˜Referer: barâ€™ http://localhost/foo$http_referer | grep â€˜foobarâ€™
```
æ‰«ææ­¤é…ç½®é”™è¯¯çš„ç³»ç»Ÿæ­ç¤ºäº†å¤šä¸ªå®ä¾‹ï¼Œå…¶ä¸­ç”¨æˆ·å¯ä»¥æ‰“å°Nginxå˜é‡ã€‚ç„¶è€Œï¼Œæ˜“å—æ”»å‡»å®ä¾‹æ•°é‡çš„å‡å°‘è¡¨æ˜ä¿®è¡¥æ­¤é—®é¢˜çš„åŠªåŠ›å·²å–å¾—ä¸€å®šæˆåŠŸã€‚

## åŸå§‹åç«¯å“åº”è¯»å–

Nginxé€šè¿‡`proxy_pass`æä¾›äº†ä¸€é¡¹åŠŸèƒ½ï¼Œå…è®¸æ‹¦æˆªåç«¯äº§ç”Ÿçš„é”™è¯¯å’ŒHTTPå¤´ï¼Œæ—¨åœ¨éšè—å†…éƒ¨é”™è¯¯æ¶ˆæ¯å’Œå¤´ã€‚è¿™æ˜¯é€šè¿‡Nginxåœ¨å“åº”åç«¯é”™è¯¯æ—¶æä¾›è‡ªå®šä¹‰é”™è¯¯é¡µé¢æ¥å®ç°çš„ã€‚ç„¶è€Œï¼Œå½“Nginxé‡åˆ°æ— æ•ˆçš„HTTPè¯·æ±‚æ—¶ï¼Œä¼šå‡ºç°æŒ‘æˆ˜ã€‚è¿™æ ·çš„è¯·æ±‚ä¼šæŒ‰åŸæ ·è½¬å‘åˆ°åç«¯ï¼Œåç«¯çš„åŸå§‹å“åº”éšåç›´æ¥å‘é€ç»™å®¢æˆ·ç«¯ï¼Œè€Œä¸ç»è¿‡Nginxçš„å¹²é¢„ã€‚

è€ƒè™‘ä¸€ä¸ªæ¶‰åŠuWSGIåº”ç”¨çš„ç¤ºä¾‹åœºæ™¯ï¼š
```python
def application(environ, start_response):
start_response('500 Error', [('Content-Type', 'text/html'), ('Secret-Header', 'secret-info')])
return [b"Secret info, should not be visible!"]
```
ä¸ºäº†ç®¡ç†è¿™ä¸€ç‚¹ï¼Œåœ¨ Nginx é…ç½®ä¸­ä½¿ç”¨äº†ç‰¹å®šçš„æŒ‡ä»¤ï¼š
```
http {
error_page 500 /html/error.html;
proxy_intercept_errors on;
proxy_hide_header Secret-Header;
}
```
* [**proxy\_intercept\_errors**](http://nginx.org/en/docs/http/ngx\_http\_proxy\_module.html#proxy\_intercept\_errors): æ­¤æŒ‡ä»¤ä½¿ Nginx èƒ½å¤Ÿä¸ºçŠ¶æ€ç å¤§äº 300 çš„åç«¯å“åº”æä¾›è‡ªå®šä¹‰å“åº”ã€‚å®ƒç¡®ä¿å¯¹äºæˆ‘ä»¬çš„ç¤ºä¾‹ uWSGI åº”ç”¨ç¨‹åºï¼Œ`500 é”™è¯¯` å“åº”è¢« Nginx æ‹¦æˆªå¹¶å¤„ç†ã€‚
* [**proxy\_hide\_header**](http://nginx.org/en/docs/http/ngx\_http\_proxy\_module.html#proxy\_hide\_header): æ­£å¦‚å…¶åç§°æ‰€ç¤ºï¼Œæ­¤æŒ‡ä»¤ä»å®¢æˆ·ç«¯éšè—æŒ‡å®šçš„ HTTP å¤´ï¼Œå¢å¼ºéšç§å’Œå®‰å…¨æ€§ã€‚

å½“å‘å‡ºæœ‰æ•ˆçš„ `GET` è¯·æ±‚æ—¶ï¼ŒNginx æ­£å¸¸å¤„ç†ï¼Œè¿”å›æ ‡å‡†é”™è¯¯å“åº”è€Œä¸æ³„éœ²ä»»ä½•ç§˜å¯†å¤´ã€‚ç„¶è€Œï¼Œæ— æ•ˆçš„ HTTP è¯·æ±‚ç»•è¿‡æ­¤æœºåˆ¶ï¼Œå¯¼è‡´åŸå§‹åç«¯å“åº”çš„æš´éœ²ï¼ŒåŒ…æ‹¬ç§˜å¯†å¤´å’Œé”™è¯¯æ¶ˆæ¯ã€‚

## merge\_slashes è®¾ç½®ä¸º off

é»˜è®¤æƒ…å†µä¸‹ï¼ŒNginx çš„ **`merge_slashes` æŒ‡ä»¤** è®¾ç½®ä¸º **`on`**ï¼Œè¿™ä¼šå°† URL ä¸­çš„å¤šä¸ªæ­£æ–œæ å‹ç¼©ä¸ºä¸€ä¸ªæ–œæ ã€‚æ­¤åŠŸèƒ½è™½ç„¶ç®€åŒ–äº† URL å¤„ç†ï¼Œä½†å¯èƒ½æ— æ„ä¸­æ©ç›–äº† Nginx åé¢åº”ç”¨ç¨‹åºä¸­çš„æ¼æ´ï¼Œç‰¹åˆ«æ˜¯é‚£äº›å®¹æ˜“å—åˆ°æœ¬åœ°æ–‡ä»¶åŒ…å« (LFI) æ”»å‡»çš„åº”ç”¨ç¨‹åºã€‚å®‰å…¨ä¸“å®¶ **Danny Robinson å’Œ Rotem Bar** å¼ºè°ƒäº†è¿™ç§é»˜è®¤è¡Œä¸ºå¯èƒ½å¸¦æ¥çš„é£é™©ï¼Œå°¤å…¶æ˜¯å½“ Nginx ä½œä¸ºåå‘ä»£ç†æ—¶ã€‚

ä¸ºäº†å‡è½»æ­¤ç±»é£é™©ï¼Œå»ºè®®å¯¹æ˜“å—è¿™äº›æ¼æ´å½±å“çš„åº”ç”¨ç¨‹åº **å…³é—­ `merge_slashes` æŒ‡ä»¤**ã€‚è¿™ç¡®ä¿ Nginx åœ¨ä¸æ”¹å˜ URL ç»“æ„çš„æƒ…å†µä¸‹å°†è¯·æ±‚è½¬å‘åˆ°åº”ç”¨ç¨‹åºï¼Œä»è€Œä¸æ©ç›–ä»»ä½•æ½œåœ¨çš„å®‰å…¨é—®é¢˜ã€‚

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ [Danny Robinson å’Œ Rotem Bar](https://medium.com/appsflyer/nginx-may-be-protecting-your-applications-from-traversal-attacks-without-you-even-knowing-b08f882fd43d)ã€‚

### **æ¶æ„å“åº”å¤´**

å¦‚ [**æ­¤æ–‡**](https://mizu.re/post/cors-playground) æ‰€ç¤ºï¼Œå¦‚æœåœ¨ Web æœåŠ¡å™¨çš„å“åº”ä¸­å­˜åœ¨æŸäº›å¤´ï¼Œå®ƒä»¬å°†æ”¹å˜ Nginx ä»£ç†çš„è¡Œä¸ºã€‚æ‚¨å¯ä»¥åœ¨ [**æ–‡æ¡£ä¸­æŸ¥çœ‹**](https://www.nginx.com/resources/wiki/start/topics/examples/x-accel/)ï¼š

* `X-Accel-Redirect`: æŒ‡ç¤º Nginx å°†è¯·æ±‚å†…éƒ¨é‡å®šå‘åˆ°æŒ‡å®šä½ç½®ã€‚
* `X-Accel-Buffering`: æ§åˆ¶ Nginx æ˜¯å¦åº”ç¼“å†²å“åº”ã€‚
* `X-Accel-Charset`: åœ¨ä½¿ç”¨ X-Accel-Redirect æ—¶è®¾ç½®å“åº”çš„å­—ç¬¦é›†ã€‚
* `X-Accel-Expires`: åœ¨ä½¿ç”¨ X-Accel-Redirect æ—¶è®¾ç½®å“åº”çš„è¿‡æœŸæ—¶é—´ã€‚
* `X-Accel-Limit-Rate`: åœ¨ä½¿ç”¨ X-Accel-Redirect æ—¶é™åˆ¶å“åº”çš„ä¼ è¾“é€Ÿç‡ã€‚

ä¾‹å¦‚ï¼Œå¤´ **`X-Accel-Redirect`** å°†å¯¼è‡´ Nginx å†…éƒ¨ **é‡å®šå‘**ã€‚å› æ­¤ï¼Œå…·æœ‰ç±»ä¼¼ **`root /`** çš„ Nginx é…ç½®å’Œæ¥è‡ª Web æœåŠ¡å™¨çš„å“åº” **`X-Accel-Redirect: .env`** å°†ä½¿ Nginx å‘é€ **`/.env`** çš„å†…å®¹ï¼ˆè·¯å¾„éå†ï¼‰ã€‚

### **æ˜ å°„æŒ‡ä»¤ä¸­çš„é»˜è®¤å€¼**

åœ¨ **Nginx é…ç½®**ä¸­ï¼Œ`map` æŒ‡ä»¤é€šå¸¸åœ¨ **æˆæƒæ§åˆ¶** ä¸­å‘æŒ¥ä½œç”¨ã€‚ä¸€ä¸ªå¸¸è§çš„é”™è¯¯æ˜¯æœªæŒ‡å®š **é»˜è®¤** å€¼ï¼Œè¿™å¯èƒ½å¯¼è‡´æœªç»æˆæƒçš„è®¿é—®ã€‚ä¾‹å¦‚ï¼š
```yaml
http {
map $uri $mappocallow {
/map-poc/private 0;
/map-poc/secret 0;
/map-poc/public 1;
}
}
```

```yaml
server {
location /map-poc {
if ($mappocallow = 0) {return 403;}
return 200 "Hello. It is private area: $mappocallow";
}
}
```
æ²¡æœ‰ `default`ï¼Œ**æ¶æ„ç”¨æˆ·**å¯ä»¥é€šè¿‡è®¿é—® `/map-poc` ä¸­çš„ **æœªå®šä¹‰ URI** æ¥ç»•è¿‡å®‰å…¨æ€§ã€‚[Nginx æ‰‹å†Œ](https://nginx.org/en/docs/http/ngx\_http\_map\_module.html) å»ºè®®è®¾ç½® **é»˜è®¤å€¼** ä»¥é¿å…æ­¤ç±»é—®é¢˜ã€‚

### **DNS æ¬ºéª—æ¼æ´**

åœ¨æŸäº›æ¡ä»¶ä¸‹ï¼Œå¯¹ Nginx è¿›è¡Œ DNS æ¬ºéª—æ˜¯å¯è¡Œçš„ã€‚å¦‚æœæ”»å‡»è€…çŸ¥é“ Nginx ä½¿ç”¨çš„ **DNS æœåŠ¡å™¨** å¹¶ä¸”èƒ½å¤Ÿæ‹¦æˆªå…¶ DNS æŸ¥è¯¢ï¼Œä»–ä»¬å¯ä»¥ä¼ªé€  DNS è®°å½•ã€‚ç„¶è€Œï¼Œå¦‚æœ Nginx é…ç½®ä¸ºä½¿ç”¨ **localhost (127.0.0.1)** è¿›è¡Œ DNS è§£æï¼Œåˆ™æ­¤æ–¹æ³•æ— æ•ˆã€‚Nginx å…è®¸å¦‚ä¸‹æŒ‡å®š DNS æœåŠ¡å™¨ï¼š
```yaml
resolver 8.8.8.8;
```
### **`proxy_pass` å’Œ `internal` æŒ‡ä»¤**

**`proxy_pass`** æŒ‡ä»¤ç”¨äºå°†è¯·æ±‚é‡å®šå‘åˆ°å…¶ä»–æœåŠ¡å™¨ï¼Œæ— è®ºæ˜¯å†…éƒ¨è¿˜æ˜¯å¤–éƒ¨ã€‚**`internal`** æŒ‡ä»¤ç¡®ä¿æŸäº›ä½ç½®ä»…åœ¨ Nginx å†…éƒ¨å¯è®¿é—®ã€‚è™½ç„¶è¿™äº›æŒ‡ä»¤æœ¬èº«å¹¶ä¸æ˜¯æ¼æ´ï¼Œä½†å…¶é…ç½®éœ€è¦ä»”ç»†æ£€æŸ¥ä»¥é˜²æ­¢å®‰å…¨æ¼æ´ã€‚

## proxy\_set\_header Upgrade & Connection

å¦‚æœ nginx æœåŠ¡å™¨é…ç½®ä¸ºä¼ é€’ Upgrade å’Œ Connection å¤´ï¼Œåˆ™å¯ä»¥æ‰§è¡Œ [**h2c Smuggling attack**](../../pentesting-web/h2c-smuggling.md) æ¥è®¿é—®å—ä¿æŠ¤çš„/å†…éƒ¨ç«¯ç‚¹ã€‚

{% hint style="danger" %}
æ­¤æ¼æ´å°†å…è®¸æ”»å‡»è€… **ä¸ `proxy_pass` ç«¯ç‚¹å»ºç«‹ç›´æ¥è¿æ¥**ï¼ˆåœ¨æ­¤æƒ…å†µä¸‹ä¸º `http://backend:9999`ï¼‰ï¼Œå…¶å†…å®¹ä¸ä¼šè¢« nginx æ£€æŸ¥ã€‚
{% endhint %}

ä» [è¿™é‡Œ](https://bishopfox.com/blog/h2c-smuggling-request) å·å– `/flag` çš„è„†å¼±é…ç½®ç¤ºä¾‹ï¼š
```
server {
listen       443 ssl;
server_name  localhost;

ssl_certificate       /usr/local/nginx/conf/cert.pem;
ssl_certificate_key   /usr/local/nginx/conf/privkey.pem;

location / {
proxy_pass http://backend:9999;
proxy_http_version 1.1;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection $http_connection;
}

location /flag {
deny all;
}
```
{% hint style="warning" %}
è¯·æ³¨æ„ï¼Œå³ä½¿ `proxy_pass` æŒ‡å‘ç‰¹å®šçš„ **è·¯å¾„**ï¼Œä¾‹å¦‚ `http://backend:9999/socket.io`ï¼Œè¿æ¥ä»å°†ä¸ `http://backend:9999` å»ºç«‹ï¼Œå› æ­¤æ‚¨å¯ä»¥ **è”ç³»è¯¥å†…éƒ¨ç«¯ç‚¹å†…çš„ä»»ä½•å…¶ä»–è·¯å¾„ã€‚å› æ­¤ï¼Œproxy_pass çš„ URL ä¸­æŒ‡å®šè·¯å¾„å¹¶ä¸é‡è¦ã€‚**
{% endhint %}

## å°è¯•ä¸€ä¸‹

Detectify åˆ›å»ºäº†ä¸€ä¸ª GitHub ä»“åº“ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ Docker è®¾ç½®è‡ªå·±çš„æ˜“å—æ”»å‡»çš„ Nginx æµ‹è¯•æœåŠ¡å™¨ï¼ŒåŒ…å«æœ¬æ–‡è®¨è®ºçš„ä¸€äº›é”™è¯¯é…ç½®ï¼Œå¹¶å°è¯•è‡ªå·±æ‰¾åˆ°å®ƒä»¬ï¼

[https://github.com/detectify/vulnerable-nginx](https://github.com/detectify/vulnerable-nginx)

## é™æ€åˆ†æå·¥å…·

### [GIXY](https://github.com/yandex/gixy)

Gixy æ˜¯ä¸€ä¸ªåˆ†æ Nginx é…ç½®çš„å·¥å…·ã€‚Gixy çš„ä¸»è¦ç›®æ ‡æ˜¯é˜²æ­¢å®‰å…¨é”™è¯¯é…ç½®å¹¶è‡ªåŠ¨æ£€æµ‹ç¼ºé™·ã€‚

### [Nginxpwner](https://github.com/stark0de/nginxpwner)

Nginxpwner æ˜¯ä¸€ä¸ªç®€å•çš„å·¥å…·ï¼Œç”¨äºæŸ¥æ‰¾å¸¸è§çš„ Nginx é”™è¯¯é…ç½®å’Œæ¼æ´ã€‚

## å‚è€ƒèµ„æ–™

* [**https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/**](https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/)
* [**http://blog.zorinaq.com/nginx-resolver-vulns/**](http://blog.zorinaq.com/nginx-resolver-vulns/)
* [**https://github.com/yandex/gixy/issues/115**](https://github.com/yandex/gixy/issues/115)

<figure><img src="../../.gitbook/assets/image (14) (1).png" alt=""><figcaption></figcaption></figure>

**å³æ—¶å¯ç”¨çš„æ¼æ´è¯„ä¼°å’Œæ¸—é€æµ‹è¯•è®¾ç½®**ã€‚ä»ä»»ä½•åœ°æ–¹è¿è¡Œå®Œæ•´çš„æ¸—é€æµ‹è¯•ï¼Œä½¿ç”¨ 20 å¤šç§å·¥å…·å’ŒåŠŸèƒ½ï¼Œä»ä¾¦å¯Ÿåˆ°æŠ¥å‘Šã€‚æˆ‘ä»¬ä¸æ›¿ä»£æ¸—é€æµ‹è¯•äººå‘˜ - æˆ‘ä»¬å¼€å‘è‡ªå®šä¹‰å·¥å…·ã€æ£€æµ‹å’Œåˆ©ç”¨æ¨¡å—ï¼Œä»¥ä¾¿è®©ä»–ä»¬æœ‰æ›´å¤šæ—¶é—´æ·±å…¥æŒ–æ˜ã€è·å– shell å¹¶äº«å—ä¹è¶£ã€‚

{% embed url="https://pentest-tools.com/" %}

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æ”»å‡»ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æ”»å‡»ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨ Twitter ä¸Šå…³æ³¨** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
