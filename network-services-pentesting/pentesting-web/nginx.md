# Nginx

<details>

<summary><strong>AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рд╢реВрдиреНрдп рд╕реЗ рд▓реЗрдХрд░ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ**, рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ**](https://peass.creator-spring.com)
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram group**](https://t.me/peass) рдореЗрдВ рдпрд╛ **Twitter** рдкрд░ ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm) рдХреЛ **рдлреЙрд▓реЛ рдХрд░реЗрдВ**.
* **HackTricks** рдХреЗ [**github repos**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ.

</details>

<figure><img src="/.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

**рддрддреНрдХрд╛рд▓ рдЙрдкрд▓рдмреНрдз рд╕реЗрдЯрдЕрдк рд╡рд▓реНрдиреЗрд░реЗрдмрд┐рд▓рд┐рдЯреА рдЕрд╕реЗрд╕рдореЗрдВрдЯ рдФрд░ рдкреЗрдиреЗрдЯреНрд░реЗрд╢рди рдЯреЗрд╕реНрдЯрд┐рдВрдЧ рдХреЗ рд▓рд┐рдП**. рдХрд╣реАрдВ рд╕реЗ рднреА рдкреВрд░рд╛ рдкреЗрдирдЯреЗрд╕реНрдЯ рдЪрд▓рд╛рдПрдВ 20+ рдЯреВрд▓реНрд╕ рдФрд░ рдлреАрдЪрд░реНрд╕ рдХреЗ рд╕рд╛рде рдЬреЛ рд░реЗрдХреЙрди рд╕реЗ рд▓реЗрдХрд░ рд░рд┐рдкреЛрд░реНрдЯрд┐рдВрдЧ рддрдХ рдЬрд╛рддреЗ рд╣реИрдВ. рд╣рдо рдкреЗрдирдЯреЗрд╕реНрдЯрд░реНрд╕ рдХреА рдЬрдЧрд╣ рдирд╣реАрдВ рд▓реЗрддреЗ - рд╣рдо рдХрд╕реНрдЯрдо рдЯреВрд▓реНрд╕, рдбрд┐рдЯреЗрдХреНрд╢рди рдФрд░ рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯреЗрд╢рди рдореЙрдбреНрдпреВрд▓реНрд╕ рд╡рд┐рдХрд╕рд┐рдд рдХрд░рддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рдЙрдиреНрд╣реЗрдВ рдФрд░ рдЧрд╣рд░рд╛рдИ рд╕реЗ рдЦреЛрдЬрдиреЗ, рд╢реЗрд▓реНрд╕ рдкреЙрдк рдХрд░рдиреЗ рдФрд░ рдордЬреЗ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреБрдЫ рд╕рдордп рд╡рд╛рдкрд╕ рдорд┐рд▓ рд╕рдХреЗ.

{% embed url="https://pentest-tools.com/" %}

## рдЧреБрдо рд░реВрдЯ рд▓реЛрдХреЗрд╢рди <a href="#missing-root-location" id="missing-root-location"></a>
```
server {
root /etc/nginx;

location /hello.txt {
try_files $uri $uri/ =404;
proxy_pass http://127.0.0.1:8080/;
}
}
```
`root` рдирд┐рд░реНрджреЗрд╢ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рддрд╛ рд╣реИ рдХрд┐ Nginx рдХреЗ рд▓рд┐рдП рдореВрд▓ рдлрд╝реЛрд▓реНрдбрд░ рдХреМрди рд╕рд╛ рд╣реИред рдКрдкрд░ рджрд┐рдП рдЧрдП рдЙрджрд╛рд╣рд░рдг рдореЗрдВ, рдореВрд▓ рдлрд╝реЛрд▓реНрдбрд░ `/etc/nginx` рд╣реИ, рдЬрд┐рд╕рдХрд╛ рдЕрд░реНрде рд╣реИ рдХрд┐ рд╣рдо рдЙрд╕ рдлрд╝реЛрд▓реНрдбрд░ рдХреЗ рднреАрддрд░ рдХреА рдлрд╝рд╛рдЗрд▓реЛрдВ рддрдХ рдкрд╣реБрдБрдЪ рд╕рдХрддреЗ рд╣реИрдВред рдКрдкрд░ рджрд┐рдП рдЧрдП рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдореЗрдВ `/ (location / {...})` рдХреЗ рд▓рд┐рдП рдХреЛрдИ рд╕реНрдерд╛рди рдирд╣реАрдВ рд╣реИ, рдХреЗрд╡рд▓ `/hello.txt` рдХреЗ рд▓рд┐рдП рд╣реИред рдЗрд╕ рдХрд╛рд░рдг рд╕реЗ, `root` рдирд┐рд░реНрджреЗрд╢ рд╡реИрд╢реНрд╡рд┐рдХ рд░реВрдк рд╕реЗ рд╕реЗрдЯ рд╣реЛ рдЬрд╛рдПрдЧрд╛, рдпрд╛рдиреА `/` рдХреЗ рд▓рд┐рдП рдЕрдиреБрд░реЛрдз рдЖрдкрдХреЛ рд╕реНрдерд╛рдиреАрдп рдкрде `/etc/nginx` рдкрд░ рд▓реЗ рдЬрд╛рдПрдЧрд╛ред

`GET /nginx.conf` рдЬрд┐рддрдирд╛ рд╕рд░рд▓ рдЕрдиреБрд░реЛрдз `/etc/nginx/nginx.conf` рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд Nginx рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдлрд╝рд╛рдЗрд▓ рдХреА рд╕рд╛рдордЧреНрд░реА рдХреЛ рдкреНрд░рдХрдЯ рдХрд░ рджреЗрдЧрд╛ред рдпрджрд┐ рдореВрд▓ `/etc` рдкрд░ рд╕реЗрдЯ рд╣реИ, рддреЛ `/nginx/nginx.conf` рдХреЗ рд▓рд┐рдП `GET` рдЕрдиреБрд░реЛрдз рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдлрд╝рд╛рдЗрд▓ рдХреЛ рдкреНрд░рдХрдЯ рдХрд░ рджреЗрдЧрд╛ред рдХреБрдЫ рдорд╛рдорд▓реЛрдВ рдореЗрдВ рдЕрдиреНрдп рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдлрд╝рд╛рдЗрд▓реЛрдВ, рдПрдХреНрд╕реЗрд╕-рд▓реЙрдЧреНрд╕ рдФрд░ рдпрд╣рд╛рдВ рддрдХ рдХрд┐ HTTP рдмреЗрд╕рд┐рдХ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рд▓рд┐рдП рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рддрдХ рдкрд╣реБрдБрдЪрдирд╛ рд╕рдВрднрд╡ рд╣реИред

## Alias LFI Misconfiguration <a href="#alias-lfi-misconfiguration" id="alias-lfi-misconfiguration"></a>

Nginx рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЗ рднреАрддрд░ "location" рд╡рдХреНрддрд╡реНрдпреЛрдВ рдХреЛ рджреЗрдЦреЗрдВ, рдпрджрд┐ рдХреЛрдИ рдЗрд╕ рддрд░рд╣ рджрд┐рдЦрддрд╛ рд╣реИ:
```
location /imgs {
alias /path/images/;
}
```
рдЗрд╕рдореЗрдВ LFI рд╕рдВрд╡реЗрджрдирд╢реАрд▓рддрд╛ рд╣реИ рдХреНрдпреЛрдВрдХрд┐:
```
/imgs../flag.txt
```
```markdown
# NGINX рдкреЗрдВрдЯреЗрд╕реНрдЯрд┐рдВрдЧ

## рд╕рд╛рдорд╛рдиреНрдп рдЬрд╛рдирдХрд╛рд░реА

NGINX рдПрдХ рд▓реЛрдХрдкреНрд░рд┐рдп рд╡реЗрдм рд╕рд░реНрд╡рд░ рд╣реИ рдЬреЛ рдЕрдкрд╛рдЪреЗ рдХреЗ рд╡рд┐рдХрд▓реНрдк рдХреЗ рд░реВрдк рдореЗрдВ рдЙрднрд░рд╛ рд╣реИред рдпрд╣ рдЙрдЪреНрдЪ рдкреНрд░рджрд░реНрд╢рди, рд╕реНрдерд┐рд░рддрд╛, рд╕рд░рд▓ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди, рдФрд░ рдХрдо рд╕рдВрд╕рд╛рдзрди рдХреА рдЦрдкрдд рдХреЗ рд▓рд┐рдП рдЬрд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИред

## рд╕реБрд░рдХреНрд╖рд╛ рдЬрд╛рдВрдЪ

### рд╕рдВрд╕реНрдХрд░рдг рдЬрд╛рдирдХрд╛рд░реА

рд╕рд░реНрд╡рд░ рдХреЗ рд╕рдВрд╕реНрдХрд░рдг рдХреА рдЬрд╛рдирдХрд╛рд░реА рдЕрдХреНрд╕рд░ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдкреЗрдЬреЛрдВ рдФрд░ рдПрд░рд░ рдкреЗрдЬреЛрдВ рдкрд░ рджрд┐рдЦрд╛рдИ рджреЗрддреА рд╣реИред рдЗрд╕ рдЬрд╛рдирдХрд╛рд░реА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ, рд╣рдорд▓рд╛рд╡рд░ рд╕рдВрднрд╛рд╡рд┐рдд рдХрдордЬреЛрд░рд┐рдпреЛрдВ рдХреА рдкрд╣рдЪрд╛рди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

### HTTP рдореЗрдердбреНрд╕

NGINX рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдореЗрдВ рдЕрдиреБрдордд HTTP рдореЗрдердбреНрд╕ рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВред рдЕрдирд╛рд╡рд╢реНрдпрдХ рдореЗрдердбреНрд╕ рдЬреИрд╕реЗ рдХрд┐ `PUT`, `DELETE`, рдпрд╛ `TRACE` рдХреЛ рдЕрдХреНрд╖рдо рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдПред

### рд╕рд░реНрд╡рд░ рд╣реЗрдбрд░реНрд╕

`Server` рд╣реЗрдбрд░ рд╕реЗ рд╕рдВрд╕реНрдХрд░рдг рдЬрд╛рдирдХрд╛рд░реА рдХреЛ рд╣рдЯрд╛рдирд╛ рдпрд╛ рдЫрд┐рдкрд╛рдирд╛ рдЪрд╛рд╣рд┐рдПред рдпрд╣ рд╕рд░реНрд╡рд░ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдирд╛рд╡рд╢реНрдпрдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЛ рд▓реАрдХ рд╣реЛрдиреЗ рд╕реЗ рд░реЛрдХрддрд╛ рд╣реИред

### рдПрд░рд░ рдкреЗрдЬ

рдХрд╕реНрдЯрдо рдПрд░рд░ рдкреЗрдЬ рдмрдирд╛рдПрдВ рдЬреЛ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдЬрд╛рдирдХрд╛рд░реА рди рджрд┐рдЦрд╛рдПрдВред рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдПрд░рд░ рдкреЗрдЬ рд╕рд░реНрд╡рд░ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдирдХрд╛рд░реА рджреЗ рд╕рдХрддреЗ рд╣реИрдВред

### SSL/TLS рд╕реЗрдЯрд┐рдВрдЧреНрд╕

рд╕реБрд░рдХреНрд╖рд┐рдд рдПрдиреНрдХреНрд░рд┐рдкреНрд╢рди рдХреЗ рд▓рд┐рдП рдордЬрдмреВрдд SSL/TLS рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВред рдЕрд╕реБрд░рдХреНрд╖рд┐рдд рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдФрд░ рд╕рд╛рдЗрдлрд░реНрд╕ рдХреЛ рдЕрдХреНрд╖рдо рдХрд░реЗрдВред

### рдПрдкреНрд▓рд┐рдХреЗрд╢рди рд╕реБрд░рдХреНрд╖рд╛

рд╡реЗрдм рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдлрд╝рд╛рдпрд░рд╡реЙрд▓ (WAF) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ рдФрд░ рд╕реБрд░рдХреНрд╖рд╛ рд╣реЗрдбрд░реНрд╕ рдЬреИрд╕реЗ рдХрд┐ `X-Frame-Options`, `X-Content-Type-Options`, рдФрд░ `Content-Security-Policy` рдХреЛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░реЗрдВред

### рдПрдХреНрд╕реЗрд╕ рдХрдВрдЯреНрд░реЛрд▓

рдЕрдирд╛рд╡рд╢реНрдпрдХ рдПрдХреНрд╕реЗрд╕ рдХреЛ рд░реЛрдХрдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдЪрд┐рдд рдПрдХреНрд╕реЗрд╕ рдХрдВрдЯреНрд░реЛрд▓ рд╕реЗрдЯ рдХрд░реЗрдВред IP рдЖрдзрд╛рд░рд┐рдд рдкреНрд░рддрд┐рдмрдВрдз рдФрд░ рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдкрд░рдорд┐рд╢рдиреНрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВред

### рд▓реЙрдЧрд┐рдВрдЧ

рдЙрдЪрд┐рдд рд▓реЙрдЧрд┐рдВрдЧ рд╕реЗрдЯ рдХрд░реЗрдВ рддрд╛рдХрд┐ рд╕рднреА рдЕрдиреБрд░реЛрдзреЛрдВ рдФрд░ рдПрд░рд░реНрд╕ рдХрд╛ рдЯреНрд░реИрдХ рд░рдЦрд╛ рдЬрд╛ рд╕рдХреЗред рд▓реЙрдЧ рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЛ рд╕реБрд░рдХреНрд╖рд┐рдд рд░рдЦреЗрдВ рдФрд░ рдирд┐рдпрдорд┐рдд рд░реВрдк рд╕реЗ рдЙрдирдХреА рд╕рдореАрдХреНрд╖рд╛ рдХрд░реЗрдВред

## рдЙрдкрдХрд░рдг рдФрд░ рддрдХрдиреАрдХреЗрдВ

### nikto

`nikto` рдПрдХ рдУрдкрди рд╕реЛрд░реНрд╕ рд╡реЗрдм рд╕рд░реНрд╡рд░ рд╕реНрдХреИрдирд░ рд╣реИ рдЬреЛ рд╡рд┐рднрд┐рдиреНрди рдкреНрд░рдХрд╛рд░ рдХреА рд╕реБрд░рдХреНрд╖рд╛ рдЬрд╛рдВрдЪ рдХрд░рддрд╛ рд╣реИред

### Nmap

`Nmap` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ NGINX рд╕рд░реНрд╡рд░ рдХреЗ рдЦреБрд▓реЗ рдкреЛрд░реНрдЯреНрд╕ рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВред

### Metasploit

`Metasploit` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЬреНрдЮрд╛рдд рдХрдордЬреЛрд░рд┐рдпреЛрдВ рдХрд╛ рд╢реЛрд╖рдг рдХрд░реЗрдВред

### Curl

`curl` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ HTTP рдЕрдиреБрд░реЛрдз рднреЗрдЬреЗрдВ рдФрд░ рд╕рд░реНрд╡рд░ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВред

## рд╕рдВрджрд░реНрдн

- [NGINX Documentation](https://nginx.org/en/docs/)
- [OWASP Testing Guide](https://owasp.org/www-project-web-security-testing-guide/)
```
```
/path/images/../flag.txt
```
рд╕рд╣реА рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рд╣реЛрдЧрд╛:
```
location /imgs/ {
alias /path/images/;
}
```
**рдпрджрд┐ рдЖрдкрдХреЛ рдХреЛрдИ Nginx рд╕рд░реНрд╡рд░ рдорд┐рд▓рддрд╛ рд╣реИ, рддреЛ рдЖрдкрдХреЛ рдЗрд╕ рд╕рдВрд╡реЗрджрдирд╢реАрд▓рддрд╛ рдХреА рдЬрд╛рдВрдЪ рдХрд░рдиреА рдЪрд╛рд╣рд┐рдПред рд╕рд╛рде рд╣реА, рдпрджрд┐ рдЖрдк рдкрд╛рддреЗ рд╣реИрдВ рдХрд┐ рдлрд╛рдЗрд▓/рдбрд╛рдпрд░реЗрдХреНрдЯрд░реАрдЬрд╝ рдХреА рдмреНрд░реВрдЯ рдлреЛрд░реНрд╕ рдЕрдЬреАрдм рддрд░рд╣ рд╕реЗ рд╡реНрдпрд╡рд╣рд╛рд░ рдХрд░ рд░рд╣реА рд╣реИ, рддреЛ рдЖрдк рдЗрд╕реЗ рдЦреЛрдЬ рд╕рдХрддреЗ рд╣реИрдВред**

рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА: [https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/](https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/)

Accunetix рдкрд░реАрдХреНрд╖рдг:
```
alias../ => HTTP status code 403
alias.../ => HTTP status code 404
alias../../ => HTTP status code 403
alias../../../../../../../../../../../ => HTTP status code 400
alias../ => HTTP status code 403
```
## рдЕрд╕реБрд░рдХреНрд╖рд┐рдд рдкрде рдкреНрд░рддрд┐рдмрдВрдз <a href="#unsafe-variable-use" id="unsafe-variable-use"></a>

рдирд┐рд░реНрджреЗрд╢реЛрдВ рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдХреЗ рддрд░реАрдХреЗ рдЬрд╛рдирдиреЗ рдХреЗ рд▓рд┐рдП рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдкреГрд╖реНрда рджреЗрдЦреЗрдВ:
```plaintext
location = /admin {
deny all;
}

location = /admin/ {
deny all;
}
```
{% content-ref url="../../pentesting-web/proxy-waf-protections-bypass.md" %}
[proxy-waf-protections-bypass.md](../../pentesting-web/proxy-waf-protections-bypass.md)
{% endcontent-ref %}

## рдЕрд╕реБрд░рдХреНрд╖рд┐рдд рд╡реЗрд░рд┐рдПрдмрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ <a href="#unsafe-variable-use" id="unsafe-variable-use"></a>

рдПрдХ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ Nginx рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХрд╛ рдЙрджрд╛рд╣рд░рдг рд╣реИ:
```
location / {
return 302 https://example.com$uri;
}
```
HTTP рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЗ рд▓рд┐рдП рдирдИ рдкрдВрдХреНрддрд┐ рд╡рд░реНрдг \r (Carriage Return) рдФрд░ \n (Line Feed) рд╣реИрдВред рдирдИ рдкрдВрдХреНрддрд┐ рд╡рд░реНрдгреЛрдВ рдХреЛ URL-encoding рдХрд░рдиреЗ рд╕реЗ рд╡рд░реНрдгреЛрдВ рдХрд╛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдкреНрд░рддрд┐рдирд┐рдзрд┐рддреНрд╡ `%0d%0a` рд╣реЛрддрд╛ рд╣реИред рдЬрдм рдЗрди рд╡рд░реНрдгреЛрдВ рдХреЛ `http://localhost/%0d%0aDetectify:%20clrf` рдЬреИрд╕реЗ рдЕрдиреБрд░реЛрдз рдореЗрдВ рдЧрд▓рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рд╡рд╛рд▓реЗ рд╕рд░реНрд╡рд░ рдХреЛ рднреЗрдЬрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рд╕рд░реНрд╡рд░ `Detectify` рдирд╛рдордХ рдПрдХ рдирдпрд╛ рд╣реЗрдбрд░ рдХреЗ рд╕рд╛рде рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рджреЗрдЧрд╛ рдХреНрдпреЛрдВрдХрд┐ $uri рд╡реЗрд░рд┐рдПрдмрд▓ рдореЗрдВ URL-decoded рдирдИ рдкрдВрдХреНрддрд┐ рд╡рд░реНрдг рд╣реЛрддреЗ рд╣реИрдВред
```
HTTP/1.1 302 Moved Temporarily
Server: nginx/1.19.3
Content-Type: text/html
Content-Length: 145
Connection: keep-alive
Location: https://example.com/
Detectify: clrf
```
CRLF рдЗрдВрдЬреЗрдХреНрд╢рди рдФрд░ рд░рд┐рд╕реНрдкреЙрдиреНрд╕ рд╕реНрдкреНрд▓рд┐рдЯрд┐рдВрдЧ рдХреЗ рдЬреЛрдЦрд┐рдореЛрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдФрд░ рдЬрд╛рдиреЗрдВ [https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/](https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/) рдкрд░ред

### рдХреЛрдИ рднреА рд╡реЗрд░рд┐рдПрдмрд▓

рдХреБрдЫ рдорд╛рдорд▓реЛрдВ рдореЗрдВ, рдпреВрдЬрд░-рд╕рдкреНрд▓рд╛рдИрдб рдбреЗрдЯрд╛ рдХреЛ Nginx рд╡реЗрд░рд┐рдПрдмрд▓ рдХреЗ рд░реВрдк рдореЗрдВ рдорд╛рдирд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдпрд╣ рдЕрд╕реНрдкрд╖реНрдЯ рд╣реИ рдХрд┐ рдРрд╕рд╛ рдХреНрдпреЛрдВ рд╣реЛ рд░рд╣рд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдпрд╣ рдЗрддрдирд╛ рдЕрд╕рд╛рдорд╛рдиреНрдп рдирд╣реАрдВ рд╣реИ рдФрд░ рдЗрд╕рдХрд╛ рдкрд░реАрдХреНрд╖рдг рдХрд░рдирд╛ рдЖрд╕рд╛рди рдирд╣реАрдВ рд╣реИ, рдЬреИрд╕рд╛ рдХрд┐ рдЗрд╕ [H1 рд░рд┐рдкреЛрд░реНрдЯ](https://hackerone.com/reports/370094) рдореЗрдВ рджреЗрдЦрд╛ рдЧрдпрд╛ рд╣реИред рдпрджрд┐ рд╣рдо рддреНрд░реБрдЯрд┐ рд╕рдВрджреЗрд╢ рдХреА рдЦреЛрдЬ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рд╣рдо рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдпрд╣ [SSI рдлрд┐рд▓реНрдЯрд░ рдореЙрдбреНрдпреВрд▓](https://github.com/nginx/nginx/blob/2187586207e1465d289ae64cedc829719a048a39/src/http/modules/ngx_http_ssi_filter_module.c#L365) рдореЗрдВ рдкрд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдкрддрд╛ рдЪрд▓рддрд╛ рд╣реИ рдХрд┐ рдпрд╣ SSI рдХреЗ рдХрд╛рд░рдг рд╣реИред

рдЗрд╕рдХрд╛ рдкрд░реАрдХреНрд╖рдг рдХрд░рдиреЗ рдХрд╛ рдПрдХ рддрд░реАрдХрд╛ рд╣реИ рд░реЗрдлреЗрд░рд░ рд╣реЗрдбрд░ рдорд╛рди рд╕реЗрдЯ рдХрд░рдирд╛:
```
$ curl -H тАШReferer: barтАЩ http://localhost/foo$http_referer | grep тАШfoobarтАЩ
```
рд╣рдордиреЗ рдЗрд╕ рдЧрд▓рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЗ рд▓рд┐рдП рд╕реНрдХреИрди рдХрд┐рдпрд╛ рдФрд░ рдХрдИ рдЙрджрд╛рд╣рд░рдг рдкрд╛рдП рдЬрд╣рд╛рдВ рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ Nginx рд╡реЗрд░рд┐рдПрдмрд▓реНрд╕ рдХрд╛ рдореВрд▓реНрдп рдкреНрд░рд┐рдВрдЯ рдХрд░ рд╕рдХрддрд╛ рдерд╛ред рдкрд╛рдП рдЧрдП рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдЙрджрд╛рд╣рд░рдгреЛрдВ рдХреА рд╕рдВрдЦреНрдпрд╛ рдореЗрдВ рдХрдореА рдЖрдИ рд╣реИ рдЬреЛ рдЗрдВрдЧрд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдЗрд╕реЗ рдкреИрдЪ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реЛ рд╕рдХрддрд╛ рд╣реИред

## рдХрдЪреНрдЪреЗ рдмреИрдХрдПрдВрдб рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдкрдврд╝рдирд╛

Nginx рдХреЗ `proxy_pass` рдХреЗ рд╕рд╛рде, рдмреИрдХрдПрдВрдб рджреНрд╡рд╛рд░рд╛ рдмрдирд╛рдИ рдЧрдИ рддреНрд░реБрдЯрд┐рдпреЛрдВ рдФрд░ HTTP рд╣реЗрдбрд░реНрд╕ рдХреЛ рдЗрдВрдЯрд░рд╕реЗрдкреНрдЯ рдХрд░рдиреЗ рдХреА рд╕рдВрднрд╛рд╡рдирд╛ рд╣реЛрддреА рд╣реИред рдпрд╣ рдмрд╣реБрдд рдЙрдкрдпреЛрдЧреА рд╣реИ рдпрджрд┐ рдЖрдк рдЖрдВрддрд░рд┐рдХ рддреНрд░реБрдЯрд┐ рд╕рдВрджреЗрд╢реЛрдВ рдФрд░ рд╣реЗрдбрд░реНрд╕ рдХреЛ рдЫрд┐рдкрд╛рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рд╡реЗ рдЗрд╕рдХреЗ рдмрдЬрд╛рдп Nginx рджреНрд╡рд╛рд░рд╛ рд╕рдВрднрд╛рд▓реЗ рдЬрд╛рдПрдВред рдпрджрд┐ рдмреИрдХрдПрдВрдб рдПрдХ рддреНрд░реБрдЯрд┐ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХреЗ рд╕рд╛рде рдЙрддреНрддрд░ рджреЗрддрд╛ рд╣реИ, рддреЛ Nginx рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рдПрдХ рдХрд╕реНрдЯрдо рддреНрд░реБрдЯрд┐ рдкреГрд╖реНрда рдкреНрд░рджрд╛рди рдХрд░реЗрдЧрд╛ред рд▓реЗрдХрд┐рди рдХреНрдпрд╛ рд╣реЛрдЧрд╛ рдпрджрд┐ Nginx рдХреЛ рд╕рдордЭ рдореЗрдВ рдирд╣реАрдВ рдЖрддрд╛ рдХрд┐ рдпрд╣ рдПрдХ HTTP рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рд╣реИ?

рдпрджрд┐ рдПрдХ рдХреНрд▓рд╛рдЗрдВрдЯ Nginx рдХреЛ рдПрдХ рдЕрдорд╛рдиреНрдп HTTP рдЕрдиреБрд░реЛрдз рднреЗрдЬрддрд╛ рд╣реИ, рддреЛ рд╡рд╣ рдЕрдиреБрд░реЛрдз рдЬреИрд╕рд╛ рд╣реИ рд╡реИрд╕рд╛ рд╣реА рдмреИрдХрдПрдВрдб рдХреЛ рдлреЙрд░рд╡рд░реНрдб рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛, рдФрд░ рдмреИрдХрдПрдВрдб рдЕрдкрдиреА рдХрдЪреНрдЪреА рд╕рд╛рдордЧреНрд░реА рдХреЗ рд╕рд╛рде рдЙрддреНрддрд░ рджреЗрдЧрд╛ред рдлрд┐рд░, Nginx рдЕрдорд╛рдиреНрдп HTTP рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХреЛ рд╕рдордЭ рдирд╣реАрдВ рдкрд╛рдПрдЧрд╛ рдФрд░ рдмрд╕ рдЗрд╕реЗ рдХреНрд▓рд╛рдЗрдВрдЯ рдХреЛ рдлреЙрд░рд╡рд░реНрдб рдХрд░ рджреЗрдЧрд╛ред рдХрд▓реНрдкрдирд╛ рдХреАрдЬрд┐рдП рдХрд┐ рдПрдХ uWSGI рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдЗрд╕ рддрд░рд╣ рд╣реЛ:
```python
def application(environ, start_response):
start_response('500 Error', [('Content-Type',
'text/html'),('Secret-Header','secret-info')])
return [b"Secret info, should not be visible!"]
```
рдФрд░ Nginx рдореЗрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдирд┐рд░реНрджреЗрд╢реЛрдВ рдХреЗ рд╕рд╛рде:
```
http {
error_page 500 /html/error.html;
proxy_intercept_errors on;
proxy_hide_header Secret-Header;
}
```
[proxy\_intercept\_errors](http://nginx.org/en/docs/http/ngx\_http\_proxy\_module.html#proxy\_intercept\_errors) рдХрд╛ рдЙрдкрдпреЛрдЧ рддрдм рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬрдм рдмреИрдХрдПрдВрдб рдХрд╛ рд░рд┐рд╕реНрдкреЙрдиреНрд╕ рд╕реНрдЯреЗрдЯрд╕ 300 рд╕реЗ рдЕрдзрд┐рдХ рд╣реЛред рд╣рдорд╛рд░реЗ uWSGI рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдореЗрдВ, рд╣рдо `500 Error` рднреЗрдЬреЗрдВрдЧреЗ рдЬрд┐рд╕реЗ Nginx рджреНрд╡рд╛рд░рд╛ рдЗрдВрдЯрд░рд╕реЗрдкреНрдЯ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред

[proxy\_hide\_header](http://nginx.org/en/docs/http/ngx\_http\_proxy\_module.html#proxy\_hide\_header) рдХрд╛ рдЕрд░реНрде рд╕реНрдкрд╖реНрдЯ рд╣реИ; рдпрд╣ рдХреНрд▓рд╛рдЗрдВрдЯ рд╕реЗ рдХрд┐рд╕реА рднреА рдирд┐рд░реНрджрд┐рд╖реНрдЯ HTTP рд╣реЗрдбрд░ рдХреЛ рдЫрд┐рдкрд╛рдПрдЧрд╛ред

рдпрджрд┐ рд╣рдо рдПрдХ рд╕рд╛рдорд╛рдиреНрдп `GET` рдЕрдиреБрд░реЛрдз рднреЗрдЬрддреЗ рд╣реИрдВ, рддреЛ Nginx рд╡рд╛рдкрд╕ рдХрд░реЗрдЧрд╛:
```
HTTP/1.1 500 Internal Server Error
Server: nginx/1.10.3
Content-Type: text/html
Content-Length: 34
Connection: close
```
рд▓реЗрдХрд┐рди рдЕрдЧрд░ рд╣рдо рдПрдХ рдЕрдорд╛рдиреНрдп HTTP рдЕрдиреБрд░реЛрдз рднреЗрдЬрддреЗ рд╣реИрдВ, рдЬреИрд╕реЗ рдХрд┐:
```
GET /? XTTP/1.1
Host: 127.0.0.1
Connection: close
```
рд╣рдореЗрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдорд┐рд▓реЗрдЧреА:
```
XTTP/1.1 500 Error
Content-Type: text/html
Secret-Header: secret-info

Secret info, should not be visible!
```
## merge\_slashes рдХреЛ off рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ

[merge\_slashes](http://nginx.org/en/docs/http/ngx\_http\_core\_module.html#merge\_slashes) рдбрд╛рдпрд░реЗрдХреНрдЯрд┐рд╡ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ "on" рдкрд░ рд╕реЗрдЯ рд╣реЛрддрд╛ рд╣реИ, рдЬреЛ рджреЛ рдпрд╛ рдЕрдзрд┐рдХ рдлреЙрд░рд╡рд░реНрдб рд╕реНрд▓реИрд╢реЗрд╕ рдХреЛ рдПрдХ рдореЗрдВ рд╕рдВрдкреАрдбрд╝рд┐рдд рдХрд░рдиреЗ рдХреА рдПрдХ рддрдВрддреНрд░ рд╣реИ, рдЗрд╕рд▓рд┐рдП `///` `/` рдмрди рдЬрд╛рдПрдЧрд╛ред рдпрджрд┐ Nginx рдХрд╛ рдЙрдкрдпреЛрдЧ рд░рд┐рд╡рд░реНрд╕-рдкреНрд░реЙрдХреНрд╕реА рдХреЗ рд░реВрдк рдореЗрдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рдкреНрд░реЙрдХреНрд╕реА рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рд╕реНрдерд╛рдиреАрдп рдлрд╝рд╛рдЗрд▓ рд╕рдорд╛рд╡реЗрд╢рди рдХреЗ рд▓рд┐рдП рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рд╣реИ, рддреЛ рдЕрдиреБрд░реЛрдз рдореЗрдВ рдЕрддрд┐рд░рд┐рдХреНрдд рд╕реНрд▓реИрд╢реЗрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдЗрд╕рдХрд╛ рд╢реЛрд╖рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЬрдЧрд╣ рдЫреЛрдбрд╝ рд╕рдХрддрд╛ рд╣реИред рдЗрд╕реЗ [Danny Robinson рдФрд░ Rotem Bar](https://medium.com/appsflyer/nginx-may-be-protecting-your-applications-from-traversal-attacks-without-you-even-knowing-b08f882fd43d) рджреНрд╡рд╛рд░рд╛ рд╡рд┐рд╕реНрддрд╛рд░ рд╕реЗ рд╡рд░реНрдгрд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред

рд╣рдореЗрдВ 33 Nginx рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдлрд╝рд╛рдЗрд▓реЗрдВ рдорд┐рд▓реАрдВ рдЬрд┐рдирдореЗрдВ `merge_slashes` рдХреЛ "off" рдкрд░ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред

## map рдбрд╛рдпрд░реЗрдХреНрдЯрд┐рд╡ рдХреЗ рд▓рд┐рдП default рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдирд╣реАрдВ рд╣реИ

рдпрд╣ рдПрдХ рд╕рд╛рдорд╛рдиреНрдп рдорд╛рдорд▓рд╛ рдкреНрд░рддреАрдд рд╣реЛрддрд╛ рд╣реИ рдЬрдм **`map` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рд╕реА рдкреНрд░рдХрд╛рд░ рдХреЗ рдкреНрд░рд╛рдзрд┐рдХрд░рдг рдирд┐рдпрдВрддреНрд░рдг рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ**ред рд╕рд░рд▓реАрдХреГрдд рдЙрджрд╛рд╣рд░рдг рдЗрд╕ рдкреНрд░рдХрд╛рд░ рджрд┐рдЦ рд╕рдХрддрд╛ рд╣реИ:
```
http {
...
map $uri $mappocallow {
/map-poc/private 0;
/map-poc/secret 0;
/map-poc/public 1;
}
...
}
```

```
server {
...
location /map-poc {
if ($mappocallow = 0) {return 403;}
return 200 "Hello. It is private area: $mappocallow";
}
...
}
```
[рдореИрдиреБрдЕрд▓ рдХреЗ рдЕрдиреБрд╕рд╛рд░](https://nginx.org/en/docs/http/ngx_http_map_module.html):

> рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдорд╛рди\
> рдпрджрд┐ рд╕реНрд░реЛрдд рдорд╛рди рдирд┐рд░реНрджрд┐рд╖реНрдЯ рд╡реЗрд░рд┐рдПрдВрдЯреНрд╕ рдореЗрдВ рд╕реЗ рдХрд┐рд╕реА рд╕реЗ рднреА рдореЗрд▓ рдирд╣реАрдВ рдЦрд╛рддрд╛ рд╣реИ рддреЛ рдкрд░рд┐рдгрд╛рдореА рдорд╛рди рд╕реЗрдЯ рдХрд░рддрд╛ рд╣реИред рдЬрдм рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдирд╣реАрдВ рд╣реЛрддрд╛ рд╣реИ, рддреЛ рдбрд┐рдлрд╝реЙрд▓реНрдЯ\
> рдкрд░рд┐рдгрд╛рдореА рдорд╛рди рдПрдХ рдЦрд╛рд▓реА рд╕реНрдЯреНрд░рд┐рдВрдЧ рд╣реЛрдЧрд╛ред

`default` рдорд╛рди рдХреЛ рднреВрд▓рдирд╛ рдЖрд╕рд╛рди рд╣реИред рдЗрд╕рд▓рд┐рдП **рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг рд╡реНрдпрдХреНрддрд┐ "рдкреНрд░рд╛рдзрд┐рдХрд░рдг рдирд┐рдпрдВрддреНрд░рдг" рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░ рд╕рдХрддрд╛ рд╣реИ** рдмрд╕ `/map-poc` рдХреЗ рдЕрдВрджрд░ рдПрдХ **рдЕрд╕реНрддрд┐рддреНрд╡рд╣реАрди рдорд╛рдорд▓реЗ рддрдХ рдкрд╣реБрдБрдЪрдХрд░** рдЬреИрд╕реЗ рдХрд┐ `https://targethost.com/map-poc/another-private-area`.

## DNS Spoofing Nginx

рдЗрд╕ рдкреЛрд╕реНрдЯ рдХреЗ рдЕрдиреБрд╕рд╛рд░: [http://blog.zorinaq.com/nginx-resolver-vulns/](http://blog.zorinaq.com/nginx-resolver-vulns/) **DNS рд░рд┐рдХреЙрд░реНрдбреНрд╕ рдХреЛ рд╕реНрдкреВрдл рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ** Nginx рдХреЗ рд▓рд┐рдП рдпрджрд┐ рдЖрдк **DNS рд╕рд░реНрд╡рд░ рдХреЛ рдЬрд╛рдирддреЗ рд╣реИрдВ рдЬрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ Nginx рдХрд░ рд░рд╣рд╛ рд╣реИ** (рдФрд░ рдЖрдк рдХрд┐рд╕реА рддрд░рд╣ рд╕реЗ рд╕рдВрдЪрд╛рд░ рдХреЛ рдЗрдВрдЯрд░рд╕реЗрдкреНрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП рдпрд╣ **рдорд╛рдиреНрдп рдирд╣реАрдВ рд╣реИ рдЕрдЧрд░ 127.0.0.1** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИ) рдФрд░ **рдбреЛрдореЗрди рдЬрд┐рд╕реЗ рдпрд╣ рдкреВрдЫ рд░рд╣рд╛ рд╣реИ**ред

Nginx рдЗрд╕рдХреЗ рд╕рд╛рде DNS рд╕рд░реНрд╡рд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░ рд╕рдХрддрд╛ рд╣реИ:
```
resolver     8.8.8.8;
```
## `proxy_pass` рдФрд░ `internal` рдирд┐рд░реНрджреЗрд╢

**`proxy_pass`** рдирд┐рд░реНрджреЗрд╢ рдХрд╛ рдЙрдкрдпреЛрдЧ **рдЕрдиреНрдп рд╕рд░реНрд╡рд░реЛрдВ рдХреЛ рдЖрдВрддрд░рд┐рдХ рд░реВрдк рд╕реЗ рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЛ рдкреБрдирд░реНрдирд┐рд░реНрджреЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП** рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЪрд╛рд╣реЗ рд╡реЗ рдЖрдВрддрд░рд┐рдХ рд╣реЛрдВ рдпрд╛ рдмрд╛рд╣рд░реАред\
**`internal`** рдирд┐рд░реНрджреЗрд╢ рдХрд╛ рдЙрдкрдпреЛрдЧ Nginx рдХреЛ рдпрд╣ рд╕реНрдкрд╖реНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдХрд┐ **рд╕реНрдерд╛рди рдХреЗрд╡рд▓ рдЖрдВрддрд░рд┐рдХ рд░реВрдк рд╕реЗ рд╣реА рдкрд╣реБрдБрдЪрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ**ред

рдЗрди рдирд┐рд░реНрджреЗрд╢реЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ **рдПрдХ рд╕реБрд░рдХреНрд╖рд╛ рджреЛрд╖ рдирд╣реАрдВ рд╣реИ рд▓реЗрдХрд┐рди рдЖрдкрдХреЛ рдЬрд╛рдВрдЪрдирд╛ рдЪрд╛рд╣рд┐рдП рдХрд┐ рд╡реЗ рдХреИрд╕реЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдП рдЧрдП рд╣реИрдВ**ред

## proxy\_set\_header Upgrade & Connection

рдпрджрд┐ nginx рд╕рд░реНрд╡рд░ Upgrade рдФрд░ Connection рд╣реЗрдбрд░реНрд╕ рдХреЛ рдкрд╛рд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рддреЛ рд╕рдВрд░рдХреНрд╖рд┐рдд/рдЖрдВрддрд░рд┐рдХ рдПрдВрдбрдкреЙрдЗрдВрдЯреНрд╕ рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХреЗ рд▓рд┐рдП [**h2c Smuggling attack**](../../pentesting-web/h2c-smuggling.md) рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

{% hint style="danger" %}
рдпрд╣ рд╕реБрд░рдХреНрд╖рд╛ рджреЛрд╖ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдХреЛ **`proxy_pass` рдПрдВрдбрдкреЙрдЗрдВрдЯ рдХреЗ рд╕рд╛рде рд╕реАрдзрд╛ рд╕рдВрдмрдВрдз рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдЧрд╛** (`http://backend:9999` рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ) рдЬрд┐рд╕рдХреА рд╕рд╛рдордЧреНрд░реА рдХреА рдЬрд╛рдВрдЪ nginx рджреНрд╡рд╛рд░рд╛ рдирд╣реАрдВ рдХреА рдЬрд╛рдПрдЧреАред
{% endhint %}

рдпрд╣рд╛рдБ [рдпрд╣рд╛рдБ](https://bishopfox.com/blog/h2c-smuggling-request) рд╕реЗ `/flag` рдЪреБрд░рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХрд╛ рдЙрджрд╛рд╣рд░рдг рд╣реИ:
```
server {
listen       443 ssl;
server_name  localhost;

ssl_certificate       /usr/local/nginx/conf/cert.pem;
ssl_certificate_key   /usr/local/nginx/conf/privkey.pem;

location / {
proxy_pass http://backend:9999;
proxy_http_version 1.1;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection $http_connection;
}

location /flag {
deny all;
}
```
{% hint style="warning" %}
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдпрджрд┐ `proxy_pass` рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ **path** рдЬреИрд╕реЗ рдХрд┐ `http://backend:9999/socket.io` рдХреА рдУрд░ рдЗрдВрдЧрд┐рдд рдХрд░ рд░рд╣рд╛ рдерд╛, рддреЛ рднреА рдХрдиреЗрдХреНрд╢рди `http://backend:9999` рдХреЗ рд╕рд╛рде рд╕реНрдерд╛рдкрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ рдЗрд╕рд▓рд┐рдП рдЖрдк **рдЙрд╕ рдЖрдВрддрд░рд┐рдХ endpoint рдХреЗ рдЕрдВрджрд░ рдХрд┐рд╕реА рднреА рдЕрдиреНрдп path рд╕реЗ рд╕рдВрдкрд░реНрдХ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЗрд╕рд▓рд┐рдП proxy_pass рдХреЗ URL рдореЗрдВ рдПрдХ path рдирд┐рд░реНрджрд┐рд╖реНрдЯ рд╣реЛрдирд╛ рдорд╛рдпрдиреЗ рдирд╣реАрдВ рд░рдЦрддрд╛ред**
{% endhint %}

## рдЦреБрдж рд╕реЗ рдХреЛрд╢рд┐рд╢ рдХрд░реЗрдВ

Detectify рдиреЗ рдПрдХ GitHub рд░рд┐рдкреЙрдЬрд┐рдЯрд░реА рдмрдирд╛рдИ рд╣реИ рдЬрд╣рд╛рдБ рдЖрдк Docker рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЕрдкрдирд╛ рдЦреБрдж рдХрд╛ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ Nginx рдЯреЗрд╕реНрдЯ рд╕рд░реНрд╡рд░ рд╕реЗрдЯрдЕрдк рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд┐рд╕рдореЗрдВ рдЗрд╕ рд▓реЗрдЦ рдореЗрдВ рдЪрд░реНрдЪрд╛ рдХреА рдЧрдИ рдХреБрдЫ misconfigurations рд╣реИрдВ рдФрд░ рдЦреБрдж рд╕реЗ рдЙрдиреНрд╣реЗрдВ рдЦреЛрдЬрдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ!

[https://github.com/detectify/vulnerable-nginx](https://github.com/detectify/vulnerable-nginx)

## Static Analyzer tools

### [GIXY](https://github.com/yandex/gixy)

Gixy Nginx рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХрд╛ рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдЙрдкрдХрд░рдг рд╣реИред Gixy рдХрд╛ рдореБрдЦреНрдп рдЙрджреНрджреЗрд╢реНрдп рд╕реБрд░рдХреНрд╖рд╛ misconfiguration рдХреЛ рд░реЛрдХрдирд╛ рдФрд░ рджреЛрд╖ рдкрддрд╛ рд▓рдЧрд╛рдиреЗ рдХреЛ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдХрд░рдирд╛ рд╣реИред

### [Nginxpwner](https://github.com/stark0de/nginxpwner)

Nginxpwner рдПрдХ рд╕рд░рд▓ рдЙрдкрдХрд░рдг рд╣реИ рдЬреЛ рд╕рд╛рдорд╛рдиреНрдп Nginx misconfigurations рдФрд░ vulnerabilities рдХреА рдЦреЛрдЬ рдХрд░рддрд╛ рд╣реИред

## рд╕рдВрджрд░реНрдн

* [**https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/**](https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/)
* [**http://blog.zorinaq.com/nginx-resolver-vulns/**](http://blog.zorinaq.com/nginx-resolver-vulns/)
* [**https://github.com/yandex/gixy/issues/115**](https://github.com/yandex/gixy/issues/115)

<figure><img src="/.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

**рддрддреНрдХрд╛рд▓ рдЙрдкрд▓рдмреНрдз рд╕реЗрдЯрдЕрдк рд╡рд▓реНрдирд░реЗрдмрд┐рд▓рд┐рдЯреА рдЖрдХрд▓рди рдФрд░ рдкреЗрдирдЯреЗрд╕реНрдЯрд┐рдВрдЧ рдХреЗ рд▓рд┐рдП**ред рдХрд╣реАрдВ рд╕реЗ рднреА рдкреВрд░реНрдг рдкреЗрдирдЯреЗрд╕реНрдЯ рдЪрд▓рд╛рдПрдВ 20+ рдЙрдкрдХрд░рдгреЛрдВ рдФрд░ рд╕реБрд╡рд┐рдзрд╛рдУрдВ рдХреЗ рд╕рд╛рде рдЬреЛ recon рд╕реЗ рд▓реЗрдХрд░ рд░рд┐рдкреЛрд░реНрдЯрд┐рдВрдЧ рддрдХ рдЬрд╛рддреЗ рд╣реИрдВред рд╣рдо рдкреЗрдирдЯреЗрд╕реНрдЯрд░реНрд╕ рдХреА рдЬрдЧрд╣ рдирд╣реАрдВ рд▓реЗрддреЗ - рд╣рдо рдЙрдиреНрд╣реЗрдВ рдЧрд╣рд░рд╛рдИ рд╕реЗ рдЦреЛрдЬрдиреЗ, shells рдкреЙрдк рдХрд░рдиреЗ рдФрд░ рдордЬрд╝реЗ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреБрдЫ рд╕рдордп рд╡рд╛рдкрд╕ рджреЗрдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╕реНрдЯрдо рдЙрдкрдХрд░рдг, рдкрддрд╛ рд▓рдЧрд╛рдиреЗ рдФрд░ рд╢реЛрд╖рдг рдореЙрдбреНрдпреВрд▓ рд╡рд┐рдХрд╕рд┐рдд рдХрд░рддреЗ рд╣реИрдВред

{% embed url="https://pentest-tools.com/" %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) рдХреЗ рд╕рд╛рде AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рд╢реВрдиреНрдп рд╕реЗ рдирд╛рдпрдХ рддрдХ</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХреЛ HackTricks рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд** рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб** рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рддреЛ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рдПрдХреНрд╕рдХреНрд▓реВрд╕рд┐рд╡ [**NFTs**](https://opensea.io/collection/the-peass-family) рдХрд╛ рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram group**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ рдореБрдЭреЗ **Twitter** ЁЯРж рдкрд░ **рдлреЙрд▓реЛ** рдХрд░реЗрдВ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **HackTricks** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВред

</details>
