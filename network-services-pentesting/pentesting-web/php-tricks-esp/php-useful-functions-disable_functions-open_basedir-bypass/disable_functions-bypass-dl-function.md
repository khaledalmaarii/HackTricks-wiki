{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

**Nota importante:**

![image](https://user-images.githubusercontent.com/84577967/174675487-a4c4ca06-194f-4725-85af-231a2f35d56c.png)

**`dl`** √© uma fun√ß√£o PHP que pode ser usada para carregar extens√µes PHP. Se a fun√ß√£o n√£o estiver desativada, pode ser abusada para **contornar `disable_functions` e executar comandos arbitr√°rios**.\
No entanto, possui algumas limita√ß√µes rigorosas:

* A fun√ß√£o `dl` deve estar **presente** no **ambiente** e **n√£o desativada**
* A extens√£o PHP **deve ser compilada com a mesma vers√£o principal** (vers√£o da API PHP) que o servidor est√° usando (voc√™ pode ver essa informa√ß√£o na sa√≠da do phpinfo)
* A extens√£o PHP deve estar **localizada no diret√≥rio** que √© **definido** pela diretiva **`extension_dir`** (voc√™ pode v√™-la na sa√≠da do phpinfo). √â muito improv√°vel que um atacante tentando abusar do servidor tenha acesso de grava√ß√£o a esse diret√≥rio, ent√£o esse requisito provavelmente impedir√° que voc√™ abuse dessa t√©cnica).

**Se voc√™ atender a esses requisitos, continue lendo o post** [**https://antichat.com/threads/70763/**](https://antichat.com/threads/70763/) **para aprender como contornar disable\_functions**. Aqui est√° um resumo:

A [fun√ß√£o dl](http://www.php.net/manual/en/function.dl.php) √© usada para carregar extens√µes PHP dinamicamente durante a execu√ß√£o do script. Extens√µes PHP, tipicamente escritas em C/C++, aprimoram a funcionalidade do PHP. O atacante, ao notar que a fun√ß√£o `dl` n√£o est√° desativada, decide criar uma extens√£o PHP personalizada para executar comandos do sistema.

### Passos Tomados pelo Atacante:

1. **Identifica√ß√£o da Vers√£o PHP:**
- O atacante determina a vers√£o PHP usando um script (`<?php echo 'PHP Version is '.PHP_VERSION; ?>`).

2. **Aquisi√ß√£o do C√≥digo Fonte PHP:**
- Baixa o c√≥digo fonte PHP do [site oficial](http://www.php.net/downloads.php) ou do [arquivo](http://museum.php.net) se a vers√£o for mais antiga.

3. **Configura√ß√£o Local do PHP:**
- Extrai e instala a vers√£o espec√≠fica do PHP em seu sistema.

4. **Cria√ß√£o da Extens√£o:**
- Estuda [como criar extens√µes PHP](http://www.php.net/manual/en/zend.creating.php) e inspeciona o c√≥digo fonte do PHP.
- Foca em duplicar a funcionalidade da [fun√ß√£o exec](http://www.php.net/manual/en/function.exec.php) localizada em `ext/standard/exec.c`.

### Notas para Compilar a Extens√£o Personalizada:

1. **ZEND_MODULE_API_NO:**
- O `ZEND_MODULE_API_NO` em `bypass.c` deve corresponder √† vers√£o atual da Zend Extension Build, recuper√°vel com:
```bash
php -i | grep "Zend Extension Build" |awk -F"API4" '{print $2}' | awk -F"," '{print $1}'
```

2. **Modifica√ß√£o de PHP_FUNCTION:**
- Para vers√µes recentes do PHP (5, 7, 8), `PHP_FUNCTION(bypass_exec)` pode precisar de ajuste. O trecho de c√≥digo fornecido detalha essa modifica√ß√£o.

### Arquivos da Extens√£o Personalizada:

- **bypass.c**:
- Implementa a funcionalidade principal da extens√£o personalizada.
- **php_bypass.h**:
- Arquivo de cabe√ßalho, definindo propriedades da extens√£o.
- **config.m4**:
- Usado pelo `phpize` para configurar o ambiente de constru√ß√£o da extens√£o personalizada.

### Construindo a Extens√£o:

1. **Comandos de Compila√ß√£o:**
- Usa `phpize`, `./configure` e `make` para compilar a extens√£o.
- O resultado `bypass.so` √© ent√£o localizado no subdiret√≥rio de m√≥dulos.

2. **Limpeza:**
- Executa `make clean` e `phpize --clean` ap√≥s a compila√ß√£o.

### Carregando e Executando no Host da V√≠tima:

1. **Compatibilidade de Vers√£o:**
- Garante que as vers√µes da API PHP correspondam entre os sistemas do atacante e da v√≠tima.

2. **Carregamento da Extens√£o:**
- Utiliza a fun√ß√£o `dl`, contornando restri√ß√µes usando caminhos relativos ou um script para automatizar o processo.

3. **Execu√ß√£o do Script:**
- O atacante faz o upload de `bypass.so` e um script PHP para o servidor da v√≠tima.
- O script usa a fun√ß√£o `dl_local` para carregar dinamicamente `bypass.so` e ent√£o chama `bypass_exec` com um comando passado via o par√¢metro de consulta `cmd`.

### Execu√ß√£o de Comandos:

- O atacante agora pode executar comandos acessando: `http://www.example.com/script.php?cmd=<command>`


Este detalhado passo a passo descreve o processo de cria√ß√£o e implanta√ß√£o de uma extens√£o PHP para executar comandos do sistema, explorando a fun√ß√£o `dl`, que idealmente deve ser desativada para prevenir tais brechas de seguran√ßa.


{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
