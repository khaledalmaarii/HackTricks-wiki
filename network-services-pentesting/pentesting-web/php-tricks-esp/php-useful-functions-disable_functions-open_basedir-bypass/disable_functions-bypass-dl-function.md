{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

**Important note:**

![image](https://user-images.githubusercontent.com/84577967/174675487-a4c4ca06-194f-4725-85af-231a2f35d56c.png)

**`dl`** je PHP funkcija koja se moÅ¾e koristiti za uÄitavanje PHP ekstenzija. Ako funkcija nije onemoguÄ‡ena, moÅ¾e se zloupotrebiti da **obiÄ‘e `disable_functions` i izvrÅ¡i proizvoljne komande**.\
MeÄ‘utim, ima neka stroga ograniÄenja:

* `dl` funkcija mora biti **prisutna** u **okruÅ¾enju** i **nije onemoguÄ‡ena**
* PHP ekstenzija **mora biti kompajlirana sa istom glavnom verzijom** (PHP API verzija) koju server koristi (ovaj podatak moÅ¾ete videti u izlazu phpinfo)
* PHP ekstenzija mora biti **smeÅ¡tena u direktorijumu** koji je **definisan** direktivom **`extension_dir`** (moÅ¾ete ga videti u izlazu phpinfo). Veoma je malo verovatno da Ä‡e napadaÄ koji pokuÅ¡ava da zloupotrebi server imati pristup za pisanje u ovaj direktorijum, tako da Ä‡e ovo zahtevati verovatno spreÄiti zloupotrebu ove tehnike).

**Ako ispunjavate ove zahteve, nastavite sa Äitanjem posta** [**https://antichat.com/threads/70763/**](https://antichat.com/threads/70763/) **da biste saznali kako da obiÄ‘ete disable\_functions**. Evo saÅ¾etak:

[dl funkcija](http://www.php.net/manual/en/function.dl.php) se koristi za dinamiÄko uÄitavanje PHP ekstenzija tokom izvrÅ¡avanja skripte. PHP ekstenzije, obiÄno napisane u C/C++, poboljÅ¡avaju funkcionalnost PHP-a. NapadaÄ, primetivÅ¡i da `dl` funkcija nije onemoguÄ‡ena, odluÄuje da kreira prilagoÄ‘enu PHP ekstenziju za izvrÅ¡avanje sistemskih komandi.

### Koraci koje je preduzeo napadaÄ:

1. **Identifikacija PHP verzije:**
- NapadaÄ odreÄ‘uje PHP verziju koristeÄ‡i skriptu (`<?php echo 'PHP Version is '.PHP_VERSION; ?>`).

2. **Nabavka PHP izvora:**
- Preuzima PHP izvor sa zvaniÄne [PHP veb stranice](http://www.php.net/downloads.php) ili iz [arhive](http://museum.php.net) ako je verzija starija.

3. **Lokalna PHP postavka:**
- Ekstrahuje i instalira specifiÄnu PHP verziju na svom sistemu.

4. **Kreiranje ekstenzije:**
- ProuÄava [kako se kreiraju PHP ekstenzije](http://www.php.net/manual/en/zend.creating.php) i ispituje PHP izvorni kod.
- Fokusira se na dupliciranje funkcionalnosti [exec funkcije](http://www.php.net/manual/en/function.exec.php) koja se nalazi u `ext/standard/exec.c`.

### Napomene za kompajliranje prilagoÄ‘ene ekstenzije:

1. **ZEND_MODULE_API_NO:**
- `ZEND_MODULE_API_NO` u `bypass.c` mora odgovarati trenutnoj Zend Extension Build, koju moÅ¾ete dobiti sa:
```bash
php -i | grep "Zend Extension Build" |awk -F"API4" '{print $2}' | awk -F"," '{print $1}'
```

2. **PHP_FUNCTION modifikacija:**
- Za novije PHP verzije (5, 7, 8), `PHP_FUNCTION(bypass_exec)` moÅ¾e zahtevati prilagoÄ‘avanje. PruÅ¾eni kodni isjeÄak detaljno opisuje ovu modifikaciju.

### Datoteke prilagoÄ‘ene ekstenzije:

- **bypass.c**:
- Implementira osnovnu funkcionalnost prilagoÄ‘ene ekstenzije.
- **php_bypass.h**:
- Header datoteka, definiÅ¡uÄ‡i osobine ekstenzije.
- **config.m4**:
- Koristi se od strane `phpize` za konfiguraciju okruÅ¾enja za izgradnju prilagoÄ‘ene ekstenzije.

### Izgradnja ekstenzije:

1. **Komande za kompajliranje:**
- Koristi `phpize`, `./configure` i `make` za kompajliranje ekstenzije.
- Rezultantni `bypass.so` se zatim nalazi u poddirektorijumu modula.

2. **ÄŒiÅ¡Ä‡enje:**
- PokreÄ‡e `make clean` i `phpize --clean` nakon kompajliranja.

### UÄitavanje i izvrÅ¡avanje na Å¾rtvovanoj maÅ¡ini:

1. **Kompatibilnost verzija:**
- Osigurava da se PHP API verzije poklapaju izmeÄ‘u napadaÄeve i Å¾rtvine maÅ¡ine.

2. **UÄitavanje ekstenzije:**
- Koristi `dl` funkciju, zaobilazeÄ‡i ograniÄenja koriÅ¡Ä‡enjem relativnih putanja ili skripte za automatizaciju procesa.

3. **IzvrÅ¡avanje skripte:**
- NapadaÄ uÄitava `bypass.so` i PHP skriptu na server Å¾rtve.
- Skripta koristi `dl_local` funkciju za dinamiÄko uÄitavanje `bypass.so` i zatim poziva `bypass_exec` sa komandom prosleÄ‘enom putem `cmd` upitnog parametra.

### IzvrÅ¡avanje komandi:

- NapadaÄ sada moÅ¾e izvrÅ¡avati komande pristupom: `http://www.example.com/script.php?cmd=<command>`


Ovaj detaljan vodiÄ opisuje proces kreiranja i implementacije PHP ekstenzije za izvrÅ¡avanje sistemskih komandi, koristeÄ‡i `dl` funkciju, koja bi idealno trebala biti onemoguÄ‡ena kako bi se spreÄile ovakve sigurnosne povrede.


{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
