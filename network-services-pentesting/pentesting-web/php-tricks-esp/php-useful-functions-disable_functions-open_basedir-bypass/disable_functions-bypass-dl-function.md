{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

**Important note:**

![image](https://user-images.githubusercontent.com/84577967/174675487-a4c4ca06-194f-4725-85af-231a2f35d56c.png)

**`dl`** est une fonction PHP qui peut √™tre utilis√©e pour charger des extensions PHP. Si la fonction n'est pas d√©sactiv√©e, elle pourrait √™tre abus√©e pour **contourner `disable_functions` et ex√©cuter des commandes arbitraires**.\
Cependant, elle a certaines limitations strictes :

* La fonction `dl` doit √™tre **pr√©sente** dans l'**environnement** et **non d√©sactiv√©e**
* L'extension PHP **doit √™tre compil√©e avec la m√™me version majeure** (version API PHP) que celle utilis√©e par le serveur (vous pouvez voir cette information dans la sortie de phpinfo)
* L'extension PHP doit √™tre **situ√©e dans le r√©pertoire** qui est **d√©fini** par la directive **`extension_dir`** (vous pouvez le voir dans la sortie de phpinfo). Il est tr√®s peu probable qu'un attaquant essayant d'abuser du serveur ait un acc√®s en √©criture sur ce r√©pertoire, donc cette exigence emp√™chera probablement d'abuser de cette technique.

**Si vous remplissez ces conditions, continuez √† lire le post** [**https://antichat.com/threads/70763/**](https://antichat.com/threads/70763/) **pour apprendre √† contourner disable_functions**. Voici un r√©sum√© :

La [fonction dl](http://www.php.net/manual/en/function.dl.php) est utilis√©e pour charger des extensions PHP dynamiquement pendant l'ex√©cution du script. Les extensions PHP, g√©n√©ralement √©crites en C/C++, am√©liorent la fonctionnalit√© de PHP. L'attaquant, en remarquant que la fonction `dl` n'est pas d√©sactiv√©e, d√©cide de cr√©er une extension PHP personnalis√©e pour ex√©cuter des commandes syst√®me.

### √âtapes suivies par l'attaquant :

1. **Identification de la version PHP :**
- L'attaquant d√©termine la version PHP √† l'aide d'un script (`<?php echo 'PHP Version is '.PHP_VERSION; ?>`).

2. **Acquisition du code source PHP :**
- T√©l√©charge le code source PHP depuis le [site officiel de PHP](http://www.php.net/downloads.php) ou l'[archive](http://museum.php.net) si la version est plus ancienne.

3. **Configuration locale de PHP :**
- Extrait et installe la version PHP sp√©cifique sur son syst√®me.

4. **Cr√©ation de l'extension :**
- √âtudie [la cr√©ation d'extensions PHP](http://www.php.net/manual/en/zend.creating.php) et inspecte le code source PHP.
- Se concentre sur la duplication de la fonctionnalit√© de la [fonction exec](http://www.php.net/manual/en/function.exec.php) situ√©e dans `ext/standard/exec.c`.

### Remarques pour la compilation de l'extension personnalis√©e :

1. **ZEND_MODULE_API_NO :**
- Le `ZEND_MODULE_API_NO` dans `bypass.c` doit correspondre √† la version actuelle de la construction de l'extension Zend, r√©cup√©rable avec :
```bash
php -i | grep "Zend Extension Build" |awk -F"API4" '{print $2}' | awk -F"," '{print $1}'
```

2. **Modification de PHP_FUNCTION :**
- Pour les versions r√©centes de PHP (5, 7, 8), `PHP_FUNCTION(bypass_exec)` peut n√©cessiter un ajustement. L'extrait de code fourni d√©taille cette modification.

### Fichiers d'extension personnalis√©s :

- **bypass.c** :
- Impl√©mente la fonctionnalit√© principale de l'extension personnalis√©e.
- **php_bypass.h** :
- Fichier d'en-t√™te, d√©finissant les propri√©t√©s de l'extension.
- **config.m4** :
- Utilis√© par `phpize` pour configurer l'environnement de construction pour l'extension personnalis√©e.

### Construction de l'extension :

1. **Commandes de compilation :**
- Utilise `phpize`, `./configure`, et `make` pour compiler l'extension.
- Le r√©sultat `bypass.so` est ensuite situ√© dans le sous-r√©pertoire des modules.

2. **Nettoyage :**
- Ex√©cute `make clean` et `phpize --clean` apr√®s la compilation.

### T√©l√©chargement et ex√©cution sur l'h√¥te victime :

1. **Compatibilit√© des versions :**
- S'assure que les versions API PHP correspondent entre les syst√®mes de l'attaquant et de la victime.

2. **Chargement de l'extension :**
- Utilise la fonction `dl`, contournant les restrictions en utilisant des chemins relatifs ou un script pour automatiser le processus.

3. **Ex√©cution du script :**
- L'attaquant t√©l√©charge `bypass.so` et un script PHP sur le serveur de la victime.
- Le script utilise la fonction `dl_local` pour charger dynamiquement `bypass.so` et appelle ensuite `bypass_exec` avec une commande pass√©e via le param√®tre de requ√™te `cmd`.

### Ex√©cution de commandes :

- L'attaquant peut maintenant ex√©cuter des commandes en acc√©dant √† : `http://www.example.com/script.php?cmd=<command>`


Ce guide d√©taill√© d√©crit le processus de cr√©ation et de d√©ploiement d'une extension PHP pour ex√©cuter des commandes syst√®me, exploitant la fonction `dl`, qui devrait id√©alement √™tre d√©sactiv√©e pour pr√©venir de telles violations de s√©curit√©.


{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
