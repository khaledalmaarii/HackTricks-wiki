{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

**Important note:**

![image](https://user-images.githubusercontent.com/84577967/174675487-a4c4ca06-194f-4725-85af-231a2f35d56c.png)

**`dl`** to funkcja PHP, kt贸ra mo偶e by u偶ywana do adowania rozszerze PHP. Jeli funkcja nie jest wyczona, mo偶e by nadu偶ywana do **obejcia `disable_functions` i wykonywania dowolnych polece**.\
Jednak ma pewne surowe ograniczenia:

* Funkcja `dl` musi by **obecna** w **rodowisku** i **nie wyczona**
* Rozszerzenie PHP **musi by skompilowane z t sam g贸wn wersj** (wersja API PHP), kt贸r u偶ywa serwer (mo偶esz zobaczy te informacje w wynikach phpinfo)
* Rozszerzenie PHP musi by **znajdowa si w katalogu**, kt贸ry jest **zdefiniowany** przez dyrektyw **`extension_dir`** (mo偶esz to zobaczy w wynikach phpinfo). Jest bardzo mao prawdopodobne, 偶e atakujcy pr贸bujcy nadu偶y serwera bdzie mia dostp do zapisu w tym katalogu, wic ten wym贸g prawdopodobnie uniemo偶liwi Ci nadu偶ycie tej techniki).

**Jeli speniasz te wymagania, kontynuuj czytanie posta** [**https://antichat.com/threads/70763/**](https://antichat.com/threads/70763/) **aby dowiedzie si, jak obej disable\_functions**. Oto podsumowanie:

Funkcja [dl](http://www.php.net/manual/en/function.dl.php) jest u偶ywana do dynamicznego adowania rozszerze PHP podczas wykonywania skryptu. Rozszerzenia PHP, zazwyczaj napisane w C/C++, zwikszaj funkcjonalno PHP. Atakujcy, zauwa偶ajc, 偶e funkcja `dl` nie jest wyczona, postanawia stworzy niestandardowe rozszerzenie PHP do wykonywania polece systemowych.

### Kroki podejmowane przez atakujcego:

1. **Identyfikacja wersji PHP:**
- Atakujcy okrela wersj PHP za pomoc skryptu (`<?php echo 'PHP Version is '.PHP_VERSION; ?>`).

2. **Pozyskanie 藕r贸da PHP:**
- Pobiera 藕r贸do PHP z oficjalnej [strony PHP](http://www.php.net/downloads.php) lub z [archiwum](http://museum.php.net), jeli wersja jest starsza.

3. **Lokalna konfiguracja PHP:**
- Wydobywa i instaluje konkretn wersj PHP na swoim systemie.

4. **Tworzenie rozszerzenia:**
- Studiuje [tworzenie rozszerze PHP](http://www.php.net/manual/en/zend.creating.php) i bada kod 藕r贸dowy PHP.
- Skupia si na powieleniu funkcjonalnoci funkcji [exec](http://www.php.net/manual/en/function.exec.php) znajdujcej si w `ext/standard/exec.c`.

### Uwagi dotyczce kompilacji niestandardowego rozszerzenia:

1. **ZEND_MODULE_API_NO:**
- `ZEND_MODULE_API_NO` w `bypass.c` musi odpowiada bie偶cej wersji budowy rozszerzenia Zend, kt贸r mo偶na uzyska za pomoc:
```bash
php -i | grep "Zend Extension Build" |awk -F"API4" '{print $2}' | awk -F"," '{print $1}'
```

2. **Modyfikacja PHP_FUNCTION:**
- Dla nowszych wersji PHP (5, 7, 8), `PHP_FUNCTION(bypass_exec)` mo偶e wymaga dostosowania. Podany fragment kodu szczeg贸owo opisuje t modyfikacj.

### Pliki niestandardowego rozszerzenia:

- **bypass.c**:
- Implementuje podstawow funkcjonalno niestandardowego rozszerzenia.
- **php_bypass.h**:
- Plik nag贸wkowy, definiujcy waciwoci rozszerzenia.
- **config.m4**:
- U偶ywany przez `phpize` do skonfigurowania rodowiska budowy dla niestandardowego rozszerzenia.

### Budowanie rozszerzenia:

1. **Polecenia kompilacji:**
- U偶ywa `phpize`, `./configure` i `make` do skompilowania rozszerzenia.
- Powstay `bypass.so` znajduje si w podkatalogu modu贸w.

2. **Czyszczenie:**
- Uruchamia `make clean` i `phpize --clean` po kompilacji.

### Przesyanie i wykonywanie na zainfekowanym hocie:

1. **Kompatybilno wersji:**
- Upewnia si, 偶e wersje API PHP s zgodne midzy systemami atakujcego a ofiary.

2. **adowanie rozszerzenia:**
- Wykorzystuje funkcj `dl`, omijajc ograniczenia, u偶ywajc cie偶ek wzgldnych lub skryptu do automatyzacji procesu.

3. **Wykonywanie skryptu:**
- Atakujcy przesya `bypass.so` i skrypt PHP na serwer ofiary.
- Skrypt u偶ywa funkcji `dl_local`, aby dynamicznie zaadowa `bypass.so`, a nastpnie wywouje `bypass_exec` z poleceniem przekazanym przez parametr zapytania `cmd`.

### Wykonywanie polece:

- Atakujcy mo偶e teraz wykonywa polecenia, uzyskujc dostp do: `http://www.example.com/script.php?cmd=<command>`


Ten szczeg贸owy przewodnik opisuje proces tworzenia i wdra偶ania rozszerzenia PHP do wykonywania polece systemowych, wykorzystujc funkcj `dl`, kt贸ra powinna by idealnie wyczona, aby zapobiec takim naruszeniom bezpieczestwa.


{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
