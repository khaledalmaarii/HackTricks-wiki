<details>

<summary><strong>Dowiedz siÄ™, jak hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

**WaÅ¼na uwaga:**

![image](https://user-images.githubusercontent.com/84577967/174675487-a4c4ca06-194f-4725-85af-231a2f35d56c.png)

**`dl`** to funkcja PHP, ktÃ³ra moÅ¼e byÄ‡ uÅ¼ywana do Å‚adowania rozszerzeÅ„ PHP. JeÅ›li funkcja nie jest wyÅ‚Ä…czona, moÅ¼e byÄ‡ naduÅ¼yta do **ominiÄ™cia `disable_functions` i wykonania dowolnych poleceÅ„**.\
Jednak ma pewne ograniczenia:

* Funkcja `dl` musi byÄ‡ **obecna** w **Å›rodowisku** i **nie wyÅ‚Ä…czona**
* Rozszerzenie PHP musi byÄ‡ **skompilowane z tÄ… samÄ… gÅ‚Ã³wnÄ… wersjÄ…** (wersjÄ… interfejsu API PHP), ktÃ³rÄ… uÅ¼ywa serwer (moÅ¼na to sprawdziÄ‡ w wyniku phpinfo)
* Rozszerzenie PHP musi byÄ‡ **znajdowaÄ‡ siÄ™ w katalogu**, ktÃ³ry jest **okreÅ›lony** przez dyrektywÄ™ **`extension_dir`** (moÅ¼na to zobaczyÄ‡ w wyniku phpinfo). Bardzo maÅ‚o prawdopodobne, Å¼e atakujÄ…cy prÃ³bujÄ…cy naduÅ¼yÄ‡ serwera bÄ™dzie miaÅ‚ dostÄ™p do zapisu w tym katalogu, wiÄ™c to wymaganie prawdopodobnie uniemoÅ¼liwi naduÅ¼ycie tej techniki.

**JeÅ›li speÅ‚niasz te wymagania, kontynuuj czytanie posta** [**https://antichat.com/threads/70763/**](https://antichat.com/threads/70763/) **, aby dowiedzieÄ‡ siÄ™, jak ominÄ…Ä‡ disable\_functions**. Oto podsumowanie:

[Funkcja dl](http://www.php.net/manual/en/function.dl.php) jest uÅ¼ywana do dynamicznego Å‚adowania rozszerzeÅ„ PHP podczas wykonywania skryptu. Rozszerzenia PHP, zwykle napisane w C/C++, rozszerzajÄ… funkcjonalnoÅ›Ä‡ PHP. AtakujÄ…cy, zauwaÅ¼ajÄ…c, Å¼e funkcja `dl` nie jest wyÅ‚Ä…czona, postanawia stworzyÄ‡ niestandardowe rozszerzenie PHP do wykonania poleceÅ„ systemowych.

### Kroki podjÄ™te przez atakujÄ…cego:

1. **Identyfikacja wersji PHP:**
- AtakujÄ…cy okreÅ›la wersjÄ™ PHP za pomocÄ… skryptu (`<?php echo 'Wersja PHP to '.PHP_VERSION; ?>`).

2. **Pobieranie ÅºrÃ³dÅ‚a PHP:**
- Pobiera ÅºrÃ³dÅ‚o PHP ze oficjalnej [strony PHP](http://www.php.net/downloads.php) lub [archiwum](http://museum.php.net), jeÅ›li wersja jest starsza.

3. **Lokalna konfiguracja PHP:**
- Rozpakowuje i instaluje konkretnÄ… wersjÄ™ PHP na swoim systemie.

4. **Tworzenie rozszerzenia:**
- Studiuje [tworzenie rozszerzeÅ„ PHP](http://www.php.net/manual/en/zend.creating.php) i analizuje kod ÅºrÃ³dÅ‚owy PHP.
- Skupia siÄ™ na duplikowaniu funkcjonalnoÅ›ci funkcji [exec](http://www.php.net/manual/en/function.exec.php) znajdujÄ…cej siÄ™ w `ext/standard/exec.c`.

### Uwagi dotyczÄ…ce kompilacji niestandardowego rozszerzenia:

1. **ZEND_MODULE_API_NO:**
- `ZEND_MODULE_API_NO` w `bypass.c` musi pasowaÄ‡ do bieÅ¼Ä…cej kompilacji rozszerzenia Zend, ktÃ³rÄ… moÅ¼na uzyskaÄ‡ za pomocÄ…:
```bash
php -i | grep "Zend Extension Build" |awk -F"API4" '{print $2}' | awk -F"," '{print $1}'
```

2. **Modyfikacja PHP_FUNCTION:**
- Dla nowszych wersji PHP (5, 7, 8), `PHP_FUNCTION(bypass_exec)` moÅ¼e wymagaÄ‡ dostosowania. Podany fragment kodu szczegÃ³Å‚owo opisuje tÄ™ modyfikacjÄ™.

### Pliki niestandardowego rozszerzenia:

- **bypass.c**:
- Implementuje podstawowÄ… funkcjonalnoÅ›Ä‡ niestandardowego rozszerzenia.
- **php_bypass.h**:
- Plik nagÅ‚Ã³wkowy, definiujÄ…cy wÅ‚aÅ›ciwoÅ›ci rozszerzenia.
- **config.m4**:
- UÅ¼ywane przez `phpize` do konfiguracji Å›rodowiska kompilacji niestandardowego rozszerzenia.

### Budowanie rozszerzenia:

1. **Polecenia kompilacji:**
- UÅ¼ywa `phpize`, `./configure` i `make` do skompilowania rozszerzenia.
- Otrzymany plik `bypass.so` znajduje siÄ™ w podkatalogu modules.

2. **Czyszczenie:**
- Wykonuje `make clean` i `phpize --clean` po kompilacji.

### PrzesyÅ‚anie i wykonanie na hostingu ofiary:

1. **ZgodnoÅ›Ä‡ wersji:**
- Zapewnia zgodnoÅ›Ä‡ wersji interfejsu API PHP miÄ™dzy systemami atakujÄ…cego i ofiary.

2. **Åadowanie rozszerzenia:**
- Wykorzystuje funkcjÄ™ `dl`, obejÅ›cie ograniczeÅ„ za pomocÄ… Å›cieÅ¼ek wzglÄ™dnych lub skryptu automatyzujÄ…cego ten proces.

3. **Wykonanie skryptu:**
- AtakujÄ…cy przesyÅ‚a `bypass.so` i skrypt PHP na serwer ofiary.
- Skrypt uÅ¼ywa funkcji `dl_local` do dynamicznego Å‚adowania `bypass.so`, a nastÄ™pnie wywoÅ‚uje `bypass_exec` z poleceniem przekazanym za pomocÄ… parametru zapytania `cmd`.

### Wykonanie polecenia:

- AtakujÄ…cy moÅ¼e teraz wykonywaÄ‡ polecenia, uzyskujÄ…c dostÄ™p do: `http://www.example.com/script.php?cmd=<polecenie>`


Ten szczegÃ³Å‚owy przewodnik przedstawia proces tworzenia i wdraÅ¼ania rozszerzenia PHP do wykonywania poleceÅ„ systemowych, wykorzystujÄ…c funkcjÄ™ `dl`, ktÃ³ra idealnie powinna byÄ‡ wyÅ‚Ä…czona, aby zapobiec takim naruszeniom bezpieczeÅ„stwa.


<details>

<summary><strong>Dowiedz siÄ™, jak hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos
