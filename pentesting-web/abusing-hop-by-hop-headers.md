# En-tÃªtes hop-by-hop

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybersÃ©curitÃ©** ? Voulez-vous voir votre **entreprise annoncÃ©e dans HackTricks** ? ou voulez-vous avoir accÃ¨s Ã  la **derniÃ¨re version de PEASS ou tÃ©lÃ©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* DÃ©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au [repo hacktricks](https://github.com/carlospolop/hacktricks) et au [repo hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

â€‹â€‹â€‹[**RootedCON**](https://www.rootedcon.com/) est l'Ã©vÃ©nement de cybersÃ©curitÃ© le plus important en **Espagne** et l'un des plus importants en **Europe**. Avec **pour mission de promouvoir les connaissances techniques**, ce congrÃ¨s est un point de rencontre bouillonnant pour les professionnels de la technologie et de la cybersÃ©curitÃ© dans toutes les disciplines.

{% embed url="https://www.rootedcon.com/" %}

## Qu'est-ce qu'un en-tÃªte hop-by-hop ?

Un en-tÃªte hop-by-hop est un en-tÃªte conÃ§u pour Ãªtre traitÃ© et consommÃ© par le proxy qui traite actuellement la requÃªte, par opposition Ã  un en-tÃªte de bout en bout.

Selon [RFC 2616](https://tools.ietf.org/html/rfc2616#section-13.5.1), la spÃ©cification HTTP/1.1 traite par dÃ©faut les en-tÃªtes suivants comme hop-by-hop : `Keep-Alive`, `Transfer-Encoding`, `TE`, `Connection`, `Trailer`, `Upgrade`, `Proxy-Authorization` et `Proxy-Authenticate`. Lorsqu'il rencontre ces en-tÃªtes dans une requÃªte, un proxy conforme doit traiter ou exÃ©cuter ce que ces en-tÃªtes indiquent, et ne pas les transmettre Ã  l'Ã©tape suivante.

En plus de ces valeurs par dÃ©faut, une requÃªte [peut Ã©galement dÃ©finir un ensemble personnalisÃ© d'en-tÃªtes Ã  traiter comme hop-by-hop](https://tools.ietf.org/html/rfc2616#section-14.10) en les ajoutant Ã  l'en-tÃªte `Connection`, comme ceci :
```
Connection: close, X-Foo, X-Bar
```
## La thÃ©orie de l'abus des en-tÃªtes hop-by-hop

En thÃ©orie, les mandataires devraient supprimer les en-tÃªtes hop-by-hop reÃ§us avant de les envoyer Ã  la prochaine adresse. Mais vous pouvez constater dans la nature que cela est fait par certains mandataires et que d'autres envoient simplement tous les en-tÃªtes en ajoutant leur propre en-tÃªte `Connection`.

![](<../.gitbook/assets/image (138).png>)

## Test de suppression hop-by-hop

Si vous trouvez un en-tÃªte qui modifie la rÃ©ponse du serveur s'il est dÃ©fini ou non, vous pouvez rechercher des suppressions hop-by-hop. Par exemple, l'en-tÃªte de cookie fera en sorte que la rÃ©ponse du serveur soit radicalement diffÃ©rente si elle est dÃ©finie (avec un contenu valide) ou non.

Ainsi, envoyez une demande avec un en-tÃªte valide et avec cette valeur de l'en-tÃªte Connection `Connection: close, Cookie` si la rÃ©ponse est la mÃªme que si le cookie n'Ã©tait pas envoyÃ©, alors il y a un mandataire qui supprime les en-tÃªtes.

Vous pouvez trouver si la rÃ©ponse du serveur est diffÃ©rente si un en-tÃªte est supprimÃ© en utilisant cette technique en utilisant [ce script](https://gist.github.com/ndavison/298d11b3a77b97c908d63a345d3c624d). Ensuite, si vous passez une liste d'en-tÃªtes connus, tels que [celle-ci](https://github.com/danielmiessler/SecLists/blob/master/Discovery/Web-Content/BurpSuite-ParamMiner/lowercase-headers), vous pouvez observer quels en-tÃªtes causent des effets malgrÃ© le fait qu'ils ne soient pas dans votre demande initiale :
```
for HEADER in $(cat headers.txt); do python poison-test.py -u "https://target" -x "$HEADER"; sleep 1; done
```
Cela va parcourir toute la liste des en-tÃªtes et afficher si sa prÃ©sence dans la liste hop-by-hop a crÃ©Ã© un code d'Ã©tat diffÃ©rent ou une taille de corps de rÃ©ponse diffÃ©rente.

## Abus de X-Forwarded-For

En gÃ©nÃ©ral, les mandataires ajouteront les adresses IP des clients Ã  l'intÃ©rieur de l'en-tÃªte `X-Forwarded-For` afin que le prochain saut sache d'oÃ¹ vient la demande. Cependant, si un attaquant envoie une valeur de connexion telle que `Connection: close, X-Forwarded-For` et que le premier mandataire envoie les en-tÃªtes hop-by-hop avec leurs valeurs (il envoie la valeur de connexion spÃ©ciale), alors la deuxiÃ¨me valeur peut supprimer l'en-tÃªte X-Forward-For.\
Ã€ la fin, l'application finale ne saura pas qui a envoyÃ© la demande et peut penser que c'Ã©tait le dernier mandataire, et dans ce scÃ©nario, un attaquant peut Ãªtre en mesure d'accÃ©der Ã  des ressources protÃ©gÃ©es par une liste blanche d'adresses IP (peut-Ãªtre certains `/admin` ?).

Selon le systÃ¨me ciblÃ©, vous pouvez Ã©galement avoir `Forwarded`, `X-Real-IP` et une multitude d'autres qui sont moins courants.

## DÃ©tection de mandataires et empreinte des services

Cette technique peut Ãªtre utile pour dÃ©tecter les mandataires (en utilisant la technique des cookies) ou mÃªme pour dÃ©tecter les services. Par exemple, si vous abusez de cette technique pour supprimer l'en-tÃªte `X-BLUECOAT-VIA` et qu'une erreur est gÃ©nÃ©rÃ©e, alors vous avez dÃ©couvert que Bluecoat Ã©tait utilisÃ©.

## Autres attaques

* Pour un possible empoisonnement de cache DoS en abusant de cette technique, lisez le lien original
* Cela pourrait Ãªtre utile dans des attaques qui pourraient vous permettre d'insÃ©rer de nouveaux en-tÃªtes (faible probabilitÃ©)
* Aussi, cela pourrait Ãªtre utile pour contourner les fonctionnalitÃ©s de dÃ©fense. Par exemple, si l'absence d'un en-tÃªte signifie qu'une demande ne doit pas Ãªtre traitÃ©e par un WAF, vous pourriez contourner un WAF avec cette technique.

## RÃ©fÃ©rences

{% embed url="https://nathandavison.com/blog/abusing-http-hop-by-hop-request-headers" %}

â€‹

<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

[**RootedCON**](https://www.rootedcon.com/) est l'Ã©vÃ©nement le plus pertinent en matiÃ¨re de cybersÃ©curitÃ© en **Espagne** et l'un des plus importants en **Europe**. Avec **la mission de promouvoir les connaissances techniques**, ce congrÃ¨s est un point de rencontre bouillonnant pour les professionnels de la technologie et de la cybersÃ©curitÃ© dans chaque discipline.\


{% embed url="https://www.rootedcon.com/" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* Travaillez-vous dans une entreprise de **cybersÃ©curitÃ©** ? Voulez-vous voir votre **entreprise annoncÃ©e dans HackTricks** ? ou voulez-vous avoir accÃ¨s Ã  la **derniÃ¨re version de PEASS ou tÃ©lÃ©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* DÃ©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au repo [hacktricks](https://github.com/carlospolop/hacktricks) et [hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
