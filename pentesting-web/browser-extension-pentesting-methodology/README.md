# æµè§ˆå™¨æ‰©å±•æ¸—é€æµ‹è¯•æ–¹æ³•è®º

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWSçº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ–åœ¨**Twitter**ä¸Šå…³æ³¨æˆ‘ä»¬ ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## åŸºæœ¬ä¿¡æ¯

æµè§ˆå™¨æ‰©å±•æ˜¯ç”¨JavaScriptç¼–å†™çš„ï¼Œå¹¶ç”±æµè§ˆå™¨åœ¨åå°åŠ è½½ã€‚å®ƒæœ‰è‡ªå·±çš„[DOM](https://www.w3schools.com/js/js\_htmldom.asp)ï¼Œä½†å¯ä»¥ä¸å…¶ä»–ç½‘ç«™çš„DOMè¿›è¡Œäº¤äº’ã€‚è¿™æ„å‘³ç€å®ƒå¯èƒ½ä¼šå±åŠå…¶ä»–ç½‘ç«™çš„æœºå¯†æ€§ã€å®Œæ•´æ€§å’Œå¯ç”¨æ€§ï¼ˆCIAï¼‰ã€‚

## ä¸»è¦ç»„ä»¶

æ‰©å±•å¸ƒå±€åœ¨å¯è§†åŒ–æ—¶æ•ˆæœæœ€ä½³ï¼Œç”±ä¸‰ä¸ªç»„ä»¶ç»„æˆã€‚è®©æˆ‘ä»¬æ·±å…¥äº†è§£æ¯ä¸ªç»„ä»¶ã€‚

<figure><img src="../../.gitbook/assets/image (4) (1).png" alt=""><figcaption><p><a href="http://webblaze.cs.berkeley.edu/papers/Extensions.pdf">http://webblaze.cs.berkeley.edu/papers/Extensions.pdf</a></p></figcaption></figure>

### **å†…å®¹è„šæœ¬**

æ¯ä¸ªå†…å®¹è„šæœ¬ç›´æ¥è®¿é—®**å•ä¸ªç½‘é¡µçš„DOM**ï¼Œå› æ­¤å®¹æ˜“å—åˆ°**æ½œåœ¨æ¶æ„è¾“å…¥**çš„å½±å“ã€‚ä½†æ˜¯ï¼Œå†…å®¹è„šæœ¬é™¤äº†èƒ½å¤Ÿå‘æ‰©å±•æ ¸å¿ƒå‘é€æ¶ˆæ¯å¤–ï¼Œæ²¡æœ‰å…¶ä»–æƒé™ã€‚

### **æ‰©å±•æ ¸å¿ƒ**

æ‰©å±•æ ¸å¿ƒåŒ…å«å¤§éƒ¨åˆ†æ‰©å±•çš„æƒé™/è®¿é—®ï¼Œä½†æ‰©å±•æ ¸å¿ƒåªèƒ½é€šè¿‡[XMLHttpRequest](https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest)å’Œå†…å®¹è„šæœ¬ä¸Webå†…å®¹è¿›è¡Œäº¤äº’ã€‚æ­¤å¤–ï¼Œæ‰©å±•æ ¸å¿ƒæ— æ³•ç›´æ¥è®¿é—®ä¸»æœºæœºå™¨ã€‚

### **æœ¬åœ°äºŒè¿›åˆ¶**

æ‰©å±•å…è®¸æœ¬åœ°äºŒè¿›åˆ¶æ–‡ä»¶ä»¥ç”¨æˆ·å®Œæ•´æƒé™è®¿é—®ä¸»æœºæœºå™¨ã€‚æœ¬åœ°äºŒè¿›åˆ¶é€šè¿‡æ ‡å‡†çš„Netscapeæ’ä»¶åº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£ï¼ˆ[NPAPI](https://en.wikipedia.org/wiki/NPAPI)ï¼‰ä¸æ‰©å±•æ ¸å¿ƒè¿›è¡Œäº¤äº’ï¼Œè¯¥æ¥å£è¢«Flashå’Œå…¶ä»–æµè§ˆå™¨æ’ä»¶ä½¿ç”¨ã€‚

### è¾¹ç•Œ

{% hint style="danger" %}
è¦è·å–ç”¨æˆ·çš„å®Œæ•´æƒé™ï¼Œæ”»å‡»è€…å¿…é¡»è¯´æœæ‰©å±•å°†å†…å®¹è„šæœ¬ä¸­çš„æ¶æ„è¾“å…¥ä¼ é€’ç»™æ‰©å±•æ ¸å¿ƒï¼Œå†ä»æ‰©å±•æ ¸å¿ƒä¼ é€’ç»™æœ¬åœ°äºŒè¿›åˆ¶æ–‡ä»¶ã€‚
{% endhint %}

æ‰©å±•çš„æ¯ä¸ªç»„ä»¶ä¹‹é—´ç”±**å¼ºå¤§çš„ä¿æŠ¤è¾¹ç•Œ**åˆ†éš”ã€‚æ¯ä¸ªç»„ä»¶åœ¨**å•ç‹¬çš„æ“ä½œç³»ç»Ÿè¿›ç¨‹**ä¸­è¿è¡Œã€‚å†…å®¹è„šæœ¬å’Œæ‰©å±•æ ¸å¿ƒåœ¨**æ²™ç›’è¿›ç¨‹**ä¸­è¿è¡Œï¼Œæ— æ³•è®¿é—®å¤§å¤šæ•°æ“ä½œç³»ç»ŸæœåŠ¡ã€‚

æ­¤å¤–ï¼Œå†…å®¹è„šæœ¬é€šè¿‡**åœ¨å•ç‹¬çš„JavaScriptå †ä¸­è¿è¡Œ**ä¸å…¶å…³è”çš„ç½‘é¡µåˆ†ç¦»ã€‚å†…å®¹è„šæœ¬å’Œç½‘é¡µå…·æœ‰**è®¿é—®ç›¸åŒåº•å±‚DOM**çš„æƒé™ï¼Œä½†ä¸¤è€…**ä¸ä¼šäº¤æ¢JavaScriptæŒ‡é’ˆ**ï¼Œä»è€Œé˜²æ­¢JavaScriptåŠŸèƒ½çš„æ³„æ¼ã€‚

## **`manifest.json`**

Chromeæ‰©å±•åªæ˜¯ä¸€ä¸ªå¸¦æœ‰[.crxæ–‡ä»¶æ‰©å±•å](https://www.lifewire.com/crx-file-2620391)çš„ZIPæ–‡ä»¶å¤¹ã€‚æ‰©å±•çš„æ ¸å¿ƒæ˜¯ä½äºæ–‡ä»¶å¤¹æ ¹ç›®å½•ä¸‹çš„**`manifest.json`**æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶æŒ‡å®šäº†å¸ƒå±€ã€æƒé™å’Œå…¶ä»–é…ç½®é€‰é¡¹ã€‚

ç¤ºä¾‹ï¼š
```json
{
"manifest_version": 2,
"name": "My extension",
"version": "1.0",
"permissions": [
"storage"
],
"content_scripts": [
{
"js": [
"script.js"
],
"matches": [
"https://example.com/*",
"https://www.example.com/*"
],
"exclude_matches": ["*://*/*business*"],
}
],
"background": {
"scripts": [
"background.js"
]
},
"options_ui": {
"page": "options.html"
}
}
```
### `content_scripts`

å†…å®¹è„šæœ¬åœ¨ç”¨æˆ·å¯¼èˆªåˆ°åŒ¹é…é¡µé¢æ—¶åŠ è½½ï¼Œå¯¹äºæˆ‘ä»¬çš„æƒ…å†µæ˜¯ä»»ä½•åŒ¹é… **`https://example.com/*`** è¡¨è¾¾å¼çš„é¡µé¢ï¼Œä½†ä¸åŒ¹é… **`*://*/*/business*`** æ­£åˆ™è¡¨è¾¾å¼çš„é¡µé¢ã€‚å®ƒä»¬åƒé¡µé¢è‡ªå·±çš„è„šæœ¬ä¸€æ ·æ‰§è¡Œï¼Œå¹¶ä¸”å¯ä»¥ä»»æ„è®¿é—®é¡µé¢çš„[æ–‡æ¡£å¯¹è±¡æ¨¡å‹ï¼ˆDOMï¼‰](https://developer.mozilla.org/en-US/docs/Web/API/Document_Object_Model)ã€‚
```json
"content_scripts": [
{
"js": [
"script.js"
],
"matches": [
"https://example.com/*",
"https://www.example.com/*"
],
"exclude_matches": ["*://*/*business*"],
}
],
```
ä¸ºäº†åŒ…å«æˆ–æ’é™¤æ›´å¤šçš„URLï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨**`include_globs`**å’Œ**`exclude_globs`**ã€‚

è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹å†…å®¹è„šæœ¬ï¼Œå½“ä½¿ç”¨[å­˜å‚¨API](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/storage)ä»æ‰©å±•çš„å­˜å‚¨ä¸­æ£€ç´¢`message`å€¼æ—¶ï¼Œå°†åœ¨é¡µé¢ä¸Šæ·»åŠ ä¸€ä¸ªè§£é‡ŠæŒ‰é’®ã€‚
```js
chrome.storage.local.get("message", result =>
{
let div = document.createElement("div");
div.innerHTML = result.message + " <button>Explain</button>";
div.querySelector("button").addEventListener("click", () =>
{
chrome.runtime.sendMessage("explain");
});
document.body.appendChild(div);
});
```
<figure><img src="../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

å½“å•å‡»æ­¤æŒ‰é’®æ—¶ï¼Œå†…å®¹è„šæœ¬é€šè¿‡åˆ©ç”¨[runtime.sendMessage() API](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/runtime/sendMessage)å‘æ‰©å±•é¡µé¢å‘é€æ¶ˆæ¯ã€‚è¿™æ˜¯å› ä¸ºå†…å®¹è„šæœ¬åœ¨ç›´æ¥è®¿é—®APIæ–¹é¢å­˜åœ¨é™åˆ¶ï¼Œ`storage`æ˜¯å°‘æ•°ä¾‹å¤–ä¹‹ä¸€ã€‚å¯¹äºè¶…å‡ºè¿™äº›ä¾‹å¤–çš„åŠŸèƒ½ï¼Œæ¶ˆæ¯å°†å‘é€åˆ°å†…å®¹è„šæœ¬å¯ä»¥ä¸ä¹‹é€šä¿¡çš„æ‰©å±•é¡µé¢ã€‚

{% hint style="warning" %}
æ ¹æ®æµè§ˆå™¨çš„ä¸åŒï¼Œå†…å®¹è„šæœ¬çš„åŠŸèƒ½å¯èƒ½ç•¥æœ‰ä¸åŒã€‚å¯¹äºåŸºäºChromiumçš„æµè§ˆå™¨ï¼ŒåŠŸèƒ½åˆ—è¡¨å¯åœ¨[Chromeå¼€å‘è€…æ–‡æ¡£](https://developer.chrome.com/docs/extensions/mv3/content_scripts/#capabilities)ä¸­æ‰¾åˆ°ï¼Œè€Œå¯¹äºFirefoxï¼Œ[MDN](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/Content_scripts#webextension_apis)æ˜¯ä¸»è¦æ¥æºã€‚\
å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå†…å®¹è„šæœ¬å…·æœ‰ä¸åå°è„šæœ¬é€šä¿¡çš„èƒ½åŠ›ï¼Œä½¿å…¶èƒ½å¤Ÿæ‰§è¡Œæ“ä½œå¹¶ä¼ é€’å“åº”ã€‚
{% endhint %}

è¦åœ¨Chromeä¸­æŸ¥çœ‹å’Œè°ƒè¯•å†…å®¹è„šæœ¬ï¼Œå¯ä»¥ä»â€œé€‰é¡¹â€>â€œæ›´å¤šå·¥å…·â€>â€œå¼€å‘è€…å·¥å…·â€æˆ–æŒ‰Ctrl + Shift + Iæ‰“å¼€Chromeå¼€å‘è€…å·¥å…·èœå•ã€‚

åœ¨æ˜¾ç¤ºå¼€å‘è€…å·¥å…·åï¼Œåº”å•å‡»**æºæ ‡ç­¾**ï¼Œç„¶åå•å‡»**å†…å®¹è„šæœ¬**æ ‡ç­¾ã€‚è¿™æ ·å¯ä»¥è§‚å¯Ÿæ¥è‡ªå„ç§æ‰©å±•çš„è¿è¡Œå†…å®¹è„šæœ¬ï¼Œå¹¶è®¾ç½®æ–­ç‚¹ä»¥è·Ÿè¸ªæ‰§è¡Œæµç¨‹ã€‚

### æ³¨å…¥çš„å†…å®¹è„šæœ¬

{% hint style="success" %}
è¯·æ³¨æ„**å†…å®¹è„šæœ¬ä¸æ˜¯å¼ºåˆ¶æ€§çš„**ï¼Œä¹Ÿå¯ä»¥é€šè¿‡**`tabs.executeScript`**åœ¨ç½‘é¡µä¸­**åŠ¨æ€æ³¨å…¥**è„šæœ¬å¹¶**ä»¥ç¼–ç¨‹æ–¹å¼æ³¨å…¥**å®ƒä»¬ã€‚è¿™å®é™…ä¸Šæä¾›äº†æ›´å¤š**ç»†ç²’åº¦çš„æ§åˆ¶**ã€‚
{% endhint %}

è¦ä»¥ç¼–ç¨‹æ–¹å¼æ³¨å…¥å†…å®¹è„šæœ¬ï¼Œæ‰©å±•éœ€è¦å…·æœ‰[ä¸»æœºæƒé™](https://developer.chrome.com/docs/extensions/reference/permissions)ï¼Œä»¥ä¾¿å°†è„šæœ¬æ³¨å…¥åˆ°å…¶ä¸­çš„é¡µé¢ã€‚è¿™äº›æƒé™å¯ä»¥é€šè¿‡åœ¨æ‰©å±•çš„æ¸…å•ä¸­**è¯·æ±‚**å®ƒä»¬æˆ–é€šè¿‡[**activeTab**](https://developer.chrome.com/docs/extensions/reference/manifest/activeTab)åœ¨ä¸´æ—¶åŸºç¡€ä¸Šè·å¾—ã€‚

#### ç¤ºä¾‹åŸºäºactiveTabçš„æ‰©å±•

{% code title="manifest.json" %}
```json
{
"name": "My extension",
...
"permissions": [
"activeTab",
"scripting"
],
"background": {
"service_worker": "background.js"
},
"action": {
"default_title": "Action Button"
}
}
```
{% endcode %}

* **ç‚¹å‡»æ—¶æ³¨å…¥JSæ–‡ä»¶ï¼š**
```javascript
// content-script.js
document.body.style.backgroundColor = "orange";

//service-worker.js - Inject the JS file
chrome.action.onClicked.addListener((tab) => {
chrome.scripting.executeScript({
target: { tabId: tab.id },
files: ["content-script.js"]
});
});
```
* **ç‚¹å‡»æ—¶æ³¨å…¥å‡½æ•°**ï¼š
```javascript
//service-worker.js - Inject a function
function injectedFunction() {
document.body.style.backgroundColor = "orange";
}

chrome.action.onClicked.addListener((tab) => {
chrome.scripting.executeScript({
target : {tabId : tab.id},
func : injectedFunction,
});
});
```
#### å…·æœ‰è„šæœ¬æƒé™çš„ç¤ºä¾‹
```javascript
// service-workser.js
chrome.scripting.registerContentScripts([{
id : "test",
matches : [ "https://*.example.com/*" ],
excludeMatches : [ "*://*/*business*" ],
js : [ "contentScript.js" ],
}]);

// Another example
chrome.tabs.executeScript(tabId, { file: "content_script.js" });
```
ä¸ºäº†åŒ…å«æˆ–æ’é™¤æ›´å¤šçš„URLï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨**`include_globs`**å’Œ**`exclude_globs`**ã€‚

### å†…å®¹è„šæœ¬ `run_at`

`run_at`å­—æ®µæ§åˆ¶**ä½•æ—¶å°†JavaScriptæ–‡ä»¶æ³¨å…¥åˆ°ç½‘é¡µä¸­**ã€‚é¦–é€‰å’Œé»˜è®¤å€¼æ˜¯`"document_idle"`ã€‚

å¯èƒ½çš„å€¼åŒ…æ‹¬ï¼š

- **`document_idle`**ï¼šå°½å¯èƒ½å¿«åœ°
- **`document_start`**ï¼šåœ¨`css`æ–‡ä»¶ä¹‹åï¼Œä½†åœ¨æ„å»ºä»»ä½•å…¶ä»–DOMæˆ–è¿è¡Œä»»ä½•å…¶ä»–è„šæœ¬ä¹‹å‰ã€‚
- **`document_end`**ï¼šåœ¨DOMå®Œæˆåç«‹å³ï¼Œä½†åœ¨åŠ è½½å›¾åƒå’Œæ¡†æ¶ç­‰å­èµ„æºä¹‹å‰ã€‚

#### é€šè¿‡`manifest.json`
```json
{
"name": "My extension",
...
"content_scripts": [
{
"matches": ["https://*.example.com/*"],
"run_at": "document_idle",
"js": ["contentScript.js"]
}
],
...
}

```
é€šè¿‡ **`service-worker.js`**
```javascript
chrome.scripting.registerContentScripts([{
id : "test",
matches : [ "https://*.example.com/*" ],
runAt : "document_idle",
js : [ "contentScript.js" ],
}]);
```
### `èƒŒæ™¯`

å†…å®¹è„šæœ¬å‘é€çš„æ¶ˆæ¯ä¼šè¢«**èƒŒæ™¯é¡µ**æ¥æ”¶ï¼ŒèƒŒæ™¯é¡µåœ¨åè°ƒæ‰©å±•ç»„ä»¶æ–¹é¢èµ·ç€ä¸­å¿ƒä½œç”¨ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒèƒŒæ™¯é¡µåœ¨æ•´ä¸ªæ‰©å±•çš„ç”Ÿå‘½å‘¨æœŸä¸­æŒç»­å­˜åœ¨ï¼Œä¸éœ€è¦ç›´æ¥ç”¨æˆ·äº¤äº’ã€‚å®ƒæ‹¥æœ‰è‡ªå·±çš„æ–‡æ¡£å¯¹è±¡æ¨¡å‹ï¼ˆDOMï¼‰ï¼Œå¯ä»¥å®ç°å¤æ‚çš„äº¤äº’å’ŒçŠ¶æ€ç®¡ç†ã€‚

**å…³é”®è¦ç‚¹**ï¼š

* **èƒŒæ™¯é¡µè§’è‰²ï¼š** å……å½“æ‰©å±•çš„ç¥ç»ä¸­æ¢ï¼Œç¡®ä¿æ‰©å±•å„éƒ¨åˆ†ä¹‹é—´çš„é€šä¿¡å’Œåè°ƒã€‚
* **æŒä¹…æ€§ï¼š** å®ƒæ˜¯ä¸€ä¸ªå§‹ç»ˆå­˜åœ¨çš„å®ä½“ï¼Œå¯¹ç”¨æˆ·ä¸å¯è§ä½†å¯¹æ‰©å±•åŠŸèƒ½è‡³å…³é‡è¦ã€‚
* **è‡ªåŠ¨ç”Ÿæˆï¼š** å¦‚æœæœªæ˜ç¡®å®šä¹‰ï¼Œæµè§ˆå™¨å°†è‡ªåŠ¨åˆ›å»ºä¸€ä¸ªèƒŒæ™¯é¡µã€‚è¿™ä¸ªè‡ªåŠ¨ç”Ÿæˆçš„é¡µé¢å°†åŒ…æ‹¬æ‰©å±•æ¸…å•ä¸­æŒ‡å®šçš„æ‰€æœ‰èƒŒæ™¯è„šæœ¬ï¼Œç¡®ä¿æ‰©å±•çš„åå°ä»»åŠ¡æ— ç¼è¿è¡Œã€‚

{% hint style="success" %}
æµè§ˆå™¨è‡ªåŠ¨ç”ŸæˆèƒŒæ™¯é¡µï¼ˆæœªæ˜ç¡®å£°æ˜æ—¶ï¼‰çš„ä¾¿åˆ©æ€§ç¡®ä¿äº†æ‰€æœ‰å¿…è¦çš„èƒŒæ™¯è„šæœ¬è¢«é›†æˆå’Œè¿è¡Œï¼Œç®€åŒ–äº†æ‰©å±•çš„è®¾ç½®è¿‡ç¨‹ã€‚
{% endhint %}

ç¤ºä¾‹èƒŒæ™¯è„šæœ¬ï¼š
```js
chrome.runtime.onMessage.addListener((request, sender, sendResponse) =>
{
if (request == "explain")
{
chrome.tabs.create({ url: "https://example.net/explanation" });
}
})
```
å®ƒä½¿ç”¨[runtime.onMessage API](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/runtime/onMessage)æ¥ç›‘å¬æ¶ˆæ¯ã€‚å½“æ”¶åˆ°ä¸€ä¸ª`"explain"`æ¶ˆæ¯æ—¶ï¼Œå®ƒä½¿ç”¨[tabs API](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs)åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€ä¸€ä¸ªé¡µé¢ã€‚

è¦è°ƒè¯•åå°è„šæœ¬ï¼Œæ‚¨å¯ä»¥è½¬åˆ°**æ‰©å±•è¯¦ç»†ä¿¡æ¯å¹¶æ£€æŸ¥æœåŠ¡å·¥ä½œè€…**ï¼Œè¿™å°†ä½¿ç”¨åå°è„šæœ¬æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼š

<figure><img src="broken-reference" alt=""><figcaption></figcaption></figure>

### é€‰é¡¹é¡µé¢å’Œå…¶ä»–

æµè§ˆå™¨æ‰©å±•å¯ä»¥åŒ…å«å„ç§ç±»å‹çš„é¡µé¢ï¼š

* **æ“ä½œé¡µé¢**åœ¨å•å‡»æ‰©å±•å›¾æ ‡æ—¶æ˜¾ç¤ºåœ¨**ä¸‹æ‹‰èœå•**ä¸­ã€‚
* æ‰©å±•å°†åœ¨**æ–°æ ‡ç­¾é¡µä¸­åŠ è½½çš„é¡µé¢**ã€‚
* **é€‰é¡¹é¡µé¢**ï¼šå•å‡»æ—¶æ˜¾ç¤ºåœ¨æ‰©å±•é¡¶éƒ¨çš„é¡µé¢ã€‚åœ¨æˆ‘çš„æƒ…å†µä¸‹ï¼Œæˆ‘å¯ä»¥åœ¨`chrome://extensions/?options=fadlhnelkbeojnebcbkacjilhnbjfjca`ä¸­è®¿é—®æ­¤é¡µé¢æˆ–å•å‡»ï¼š

<figure><img src="../../.gitbook/assets/image (8).png" alt="" width="375"><figcaption></figcaption></figure>

è¯·æ³¨æ„ï¼Œè¿™äº›é¡µé¢ä¸åƒåå°é¡µé¢é‚£æ ·æŒä¹…ï¼Œå› ä¸ºå®ƒä»¬æ ¹æ®éœ€è¦åŠ¨æ€åŠ è½½å†…å®¹ã€‚å°½ç®¡å¦‚æ­¤ï¼Œå®ƒä»¬ä¸åå°é¡µé¢å…±äº«æŸäº›åŠŸèƒ½ï¼š

* **ä¸å†…å®¹è„šæœ¬é€šä¿¡ï¼š**ä¸åå°é¡µé¢ç±»ä¼¼ï¼Œè¿™äº›é¡µé¢å¯ä»¥ä»å†…å®¹è„šæœ¬æ¥æ”¶æ¶ˆæ¯ï¼Œä¿ƒè¿›æ‰©å±•å†…çš„äº¤äº’ã€‚
* **è®¿é—®æ‰©å±•ç‰¹å®šçš„APIï¼š**è¿™äº›é¡µé¢å¯ä»¥å…¨é¢è®¿é—®æ‰©å±•ç‰¹å®šçš„APIï¼Œå–å†³äºä¸ºæ‰©å±•å®šä¹‰çš„æƒé™ã€‚

### `permissions`å’Œ`host_permissions`

**`permissions`**å’Œ**`host_permissions`**æ˜¯`manifest.json`ä¸­çš„æ¡ç›®ï¼Œå°†æŒ‡ç¤ºæµè§ˆå™¨æ‰©å±•å…·æœ‰å“ªäº›æƒé™ï¼ˆå­˜å‚¨ã€ä½ç½®...ï¼‰ä»¥åŠåœ¨**å“ªäº›ç½‘é¡µ**ä¸­ã€‚

ç”±äºæµè§ˆå™¨æ‰©å±•å¯èƒ½å…·æœ‰å¦‚æ­¤**ç‰¹æƒ**ï¼Œä¸€ä¸ªæ¶æ„çš„æ‰©å±•æˆ–è¢«å…¥ä¾µçš„æ‰©å±•å¯èƒ½å…è®¸æ”»å‡»è€…**ä»¥ä¸åŒæ–¹å¼çªƒå–æ•æ„Ÿä¿¡æ¯å¹¶ç›‘è§†ç”¨æˆ·**ã€‚

æŸ¥çœ‹è¿™äº›è®¾ç½®å¦‚ä½•å·¥ä½œä»¥åŠå®ƒä»¬å¦‚ä½•å¯èƒ½åœ¨ä»¥ä¸‹æƒ…å†µä¸­è¢«æ»¥ç”¨ï¼š

{% content-ref url="browext-permissions-and-host_permissions.md" %}
[browext-permissions-and-host\_permissions.md](browext-permissions-and-host\_permissions.md)
{% endcontent-ref %}

### `content_security_policy`

**å†…å®¹å®‰å…¨ç­–ç•¥**ä¹Ÿå¯ä»¥åœ¨`manifest.json`ä¸­å£°æ˜ã€‚å¦‚æœå®šä¹‰äº†ä¸€ä¸ªï¼Œå®ƒå¯èƒ½ä¼š**å­˜åœ¨æ¼æ´**ã€‚

æµè§ˆå™¨æ‰©å±•é¡µé¢çš„é»˜è®¤è®¾ç½®ç›¸å½“ä¸¥æ ¼ï¼š
```bash
script-src 'self'; object-src 'self';
```
æœ‰å…³CSPå’Œæ½œåœ¨ç»•è¿‡æ–¹æ³•çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../content-security-policy-csp-bypass/" %}
[content-security-policy-csp-bypass](../content-security-policy-csp-bypass/)
{% endcontent-ref %}

### `web_accessible_resources`

ä¸ºäº†è®©ç½‘é¡µè®¿é—®æµè§ˆå™¨æ‰©å±•çš„é¡µé¢ï¼Œä¾‹å¦‚ä¸€ä¸ª`.html`é¡µé¢ï¼Œè¿™ä¸ªé¡µé¢éœ€è¦åœ¨`manifest.json`çš„**`web_accessible_resources`**å­—æ®µä¸­æåŠã€‚\
ä¾‹å¦‚ï¼š
```javascript
{
...
"web_accessible_resources": [
{
"resources": [ "images/*.png" ],
"matches": [ "https://example.com/*" ]
},
{
"resources": [ "fonts/*.woff" ],
"matches": [ "https://example.com/*" ]
}
],
...
}
```
è¿™äº›é¡µé¢å¯ä»¥é€šè¿‡ä»¥ä¸‹URLè®¿é—®ï¼š
```
chrome-extension://<extension-id>/message.html
```
åœ¨å…¬å…±æ‰©å±•ä¸­ï¼Œ**æ‰©å±•IDæ˜¯å¯è®¿é—®çš„**ï¼š

<figure><img src="../../.gitbook/assets/image (722).png" alt="" width="375"><figcaption></figcaption></figure>

å°½ç®¡å¦‚æ­¤ï¼Œå¦‚æœä½¿ç”¨`manifest.json`å‚æ•°**`use_dynamic_url`**ï¼Œåˆ™æ­¤**IDå¯ä»¥æ˜¯åŠ¨æ€çš„**ã€‚

å…è®¸è®¿é—®è¿™äº›é¡µé¢ä½¿è¿™äº›é¡µé¢**æ½œåœ¨æ˜“å— ClickJacking æ”»å‡»**ï¼š

{% content-ref url="browext-clickjacking.md" %}
[browext-clickjacking.md](browext-clickjacking.md)
{% endcontent-ref %}

{% hint style="success" %}
åªå…è®¸è¿™äº›é¡µé¢ç”±æ‰©å±•åŠ è½½ï¼Œè€Œä¸æ˜¯ç”±éšæœºURLåŠ è½½ï¼Œå¯ä»¥é˜²æ­¢ ClickJacking æ”»å‡»ã€‚
{% endhint %}

### `externally_connectable`

æ ¹æ®[**æ–‡æ¡£**](https://developer.chrome.com/docs/extensions/reference/manifest/externally-connectable)ï¼Œ`"externally_connectable"`æ¸…å•å±æ€§å£°æ˜äº†**å“ªäº›æ‰©å±•å’Œç½‘é¡µå¯ä»¥é€šè¿‡[runtime.connect](https://developer.chrome.com/docs/extensions/reference/runtime#method-connect)å’Œ[runtime.sendMessage](https://developer.chrome.com/docs/extensions/reference/runtime#method-sendMessage)è¿æ¥åˆ°æ‚¨çš„æ‰©å±•**ã€‚

* å¦‚æœåœ¨æ‚¨çš„æ‰©å±•æ¸…å•ä¸­**æœª**å£°æ˜**`externally_connectable`**é”®ï¼Œæˆ–è€…å£°æ˜ä¸º**`"ids": ["*"]`**ï¼Œ**æ‰€æœ‰æ‰©å±•éƒ½å¯ä»¥è¿æ¥ï¼Œä½†æ²¡æœ‰ç½‘é¡µå¯ä»¥è¿æ¥**ã€‚
* å¦‚æœæŒ‡å®šäº†**ç‰¹å®šçš„ID**ï¼Œä¾‹å¦‚`"ids": ["aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"]`ï¼Œ**åªæœ‰è¿™äº›åº”ç”¨ç¨‹åº**å¯ä»¥è¿æ¥ã€‚
* å¦‚æœæŒ‡å®šäº†**åŒ¹é…é¡¹**ï¼Œè¿™äº›Webåº”ç”¨ç¨‹åºå°†èƒ½å¤Ÿè¿æ¥ï¼š
```json
"matches": [
"https://*.google.com/*",
"*://*.chromium.org/*",
```
* å¦‚æœæŒ‡å®šä¸ºç©ºï¼š**`"externally_connectable": {}`**ï¼Œåˆ™æ²¡æœ‰åº”ç”¨ç¨‹åºæˆ–ç½‘é¡µèƒ½å¤Ÿè¿æ¥ã€‚

åœ¨æ­¤å¤„æŒ‡å®šçš„**æ‰©å±•å’Œ URL è¶Šå°‘**ï¼Œæ”»å‡»é¢å°±ä¼š**è¶Šå°**ã€‚

{% hint style="danger" %}
å¦‚æœä¸€ä¸ªæ˜“å— XSS æˆ–æ¥ç®¡æ”»å‡»çš„ç½‘é¡µåœ¨ **`externally_connectable`** ä¸­æŒ‡å®šï¼Œæ”»å‡»è€…å°†èƒ½å¤Ÿ**ç›´æ¥å‘åå°è„šæœ¬å‘é€æ¶ˆæ¯**ï¼Œå®Œå…¨ç»•è¿‡å†…å®¹è„šæœ¬åŠå…¶ CSPã€‚

å› æ­¤ï¼Œè¿™æ˜¯ä¸€ä¸ª**éå¸¸å¼ºå¤§çš„ç»•è¿‡æ–¹å¼**ã€‚

æ­¤å¤–ï¼Œå¦‚æœå®¢æˆ·ç«¯å®‰è£…äº†ä¸€ä¸ªæ¶æ„æ‰©å±•ï¼Œå³ä½¿å®ƒæ²¡æœ‰è¢«å…è®¸ä¸æ˜“å—æ”»å‡»çš„æ‰©å±•é€šä¿¡ï¼Œå®ƒä¹Ÿå¯ä»¥åœ¨å…è®¸çš„ç½‘é¡µä¸­æ³¨å…¥**XSS æ•°æ®**ï¼Œæˆ–è€…æ»¥ç”¨**`WebRequest`**æˆ–**`DeclarativeNetRequest`** API æ¥æ“çºµé’ˆå¯¹ç‰¹å®šåŸŸçš„è¯·æ±‚ï¼Œæ”¹å˜é¡µé¢å¯¹**JavaScript æ–‡ä»¶**çš„è¯·æ±‚ã€‚ï¼ˆè¯·æ³¨æ„ï¼Œç›®æ ‡é¡µé¢ä¸Šçš„ CSP å¯èƒ½ä¼šé˜»æ­¢è¿™äº›æ”»å‡»ï¼‰ã€‚è¿™ä¸ªæƒ³æ³•æ¥è‡ª[**è¿™ç¯‡æ–‡ç« **](https://www.darkrelay.com/post/opera-zero-day-rce-vulnerability)ã€‚
{% endhint %}

##

## Web **â†”ï¸** å†…å®¹è„šæœ¬é€šä¿¡

**å†…å®¹è„šæœ¬**è¿è¡Œçš„ç¯å¢ƒå’Œä¸»æœºé¡µé¢å­˜åœ¨çš„ç¯å¢ƒæ˜¯**åˆ†ç¦»**çš„ï¼Œç¡®ä¿äº†**éš”ç¦»**ã€‚å°½ç®¡å­˜åœ¨è¿™ç§éš”ç¦»ï¼Œä½†ä¸¤è€…éƒ½å¯ä»¥ä¸é¡µé¢çš„**æ–‡æ¡£å¯¹è±¡æ¨¡å‹ï¼ˆDOMï¼‰**è¿›è¡Œäº¤äº’ï¼Œè¿™æ˜¯ä¸€ä¸ªå…±äº«èµ„æºã€‚ä¸ºäº†ä½¿ä¸»æœºé¡µé¢ä¸**å†…å®¹è„šæœ¬**è¿›è¡Œé€šä¿¡ï¼Œæˆ–è€…é—´æ¥åœ°é€šè¿‡å†…å®¹è„šæœ¬ä¸æ‰©å±•è¿›è¡Œé€šä¿¡ï¼Œéœ€è¦åˆ©ç”¨åŒæ–¹éƒ½å¯ä»¥è®¿é—®çš„**DOM**ä½œä¸ºé€šä¿¡æ¸ é“ã€‚

### å‘é€æ¶ˆæ¯

{% code title="content-script.js" %}
```javascript
var port = chrome.runtime.connect();

window.addEventListener("message", (event) => {
// We only accept messages from ourselves
if (event.source !== window) {
return;
}

if (event.data.type && (event.data.type === "FROM_PAGE")) {
console.log("Content script received: " + event.data.text);
port.postMessage(event.data.text);
}
}, false);
```
{% endcode %}

{% code title="example.js" %}
```javascript
document.getElementById("theButton").addEventListener("click", () => {
window.postMessage(
{type : "FROM_PAGE", text : "Hello from the webpage!"}, "*");
}, false);
```
{% endcode %}

å®‰å…¨çš„Post Messageé€šä¿¡åº”è¯¥æ£€æŸ¥æ¥æ”¶åˆ°çš„æ¶ˆæ¯çš„çœŸå®æ€§ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è¿›è¡Œæ£€æŸ¥ï¼š

- **`event.isTrusted`**ï¼šä»…å½“äº‹ä»¶ç”±ç”¨æˆ·æ“ä½œè§¦å‘æ—¶ä¸ºTrue
- å†…å®¹è„šæœ¬å¯èƒ½åªæœŸæœ›åœ¨ç”¨æˆ·æ‰§è¡ŒæŸäº›æ“ä½œæ—¶æ¥æ”¶æ¶ˆæ¯
- **æ¥æºåŸŸ**ï¼šå¯èƒ½åªå…è®¸ç™½åå•ä¸­çš„åŸŸå‘é€æ¶ˆæ¯
- å¦‚æœä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼Œè¯·éå¸¸å°å¿ƒ
- **æ¥æº**ï¼š`received_message.source !== window`å¯ç”¨äºæ£€æŸ¥æ¶ˆæ¯æ˜¯å¦æ¥è‡ªå†…å®¹è„šæœ¬æ­£åœ¨ç›‘å¬çš„**åŒä¸€çª—å£**ã€‚

å³ä½¿æ‰§è¡Œäº†ä¸Šè¿°æ£€æŸ¥ï¼Œä»å¯èƒ½å­˜åœ¨æ¼æ´ï¼Œè¯·åœ¨ä»¥ä¸‹é¡µé¢æ£€æŸ¥**æ½œåœ¨çš„Post Messageç»•è¿‡**ï¼š

{% content-ref url="../postmessage-vulnerabilities/" %}
[postmessage-vulnerabilities](../postmessage-vulnerabilities/)
{% endcontent-ref %}

### Iframe

å¦ä¸€ç§å¯èƒ½çš„é€šä¿¡æ–¹å¼å¯èƒ½æ˜¯é€šè¿‡**Iframe URLs**ï¼Œæ‚¨å¯ä»¥åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­æ‰¾åˆ°ï¼š

{% content-ref url="browext-xss-example.md" %}
[browext-xss-example.md](browext-xss-example.md)
{% endcontent-ref %}

### DOM

è¿™å¹¶ä¸æ˜¯â€œç¡®åˆ‡åœ°â€ä¸€ç§é€šä¿¡æ–¹å¼ï¼Œä½†æ˜¯**webå’Œå†…å®¹è„šæœ¬å°†å¯ä»¥è®¿é—®web DOM**ã€‚å› æ­¤ï¼Œå¦‚æœ**å†…å®¹è„šæœ¬**ä»ä¸­è¯»å–ä¸€äº›ä¿¡æ¯ï¼Œ**ä¿¡ä»»web DOM**ï¼Œåˆ™webå¯èƒ½ä¼š**ä¿®æ”¹è¿™äº›æ•°æ®**ï¼ˆå› ä¸ºä¸åº”ä¿¡ä»»webï¼Œæˆ–è€…å› ä¸ºwebå®¹æ˜“å—åˆ°XSSæ”»å‡»ï¼‰ï¼Œä»è€Œ**å±åŠå†…å®¹è„šæœ¬**ã€‚

æ‚¨è¿˜å¯ä»¥åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­æ‰¾åˆ°ä¸€ä¸ª**åŸºäºDOMçš„XSSç¤ºä¾‹æ¥å±åŠæµè§ˆå™¨æ‰©å±•**ï¼š

{% content-ref url="browext-xss-example.md" %}
[browext-xss-example.md](browext-xss-example.md)
{% endcontent-ref %}

## å†…å­˜/ä»£ç ä¸­çš„æ•æ„Ÿä¿¡æ¯

å¦‚æœæµè§ˆå™¨æ‰©å±•åœ¨å…¶å†…å­˜ä¸­å­˜å‚¨**æ•æ„Ÿä¿¡æ¯**ï¼Œè¿™äº›ä¿¡æ¯å¯èƒ½ä¼šè¢«**è½¬å‚¨**ï¼ˆç‰¹åˆ«æ˜¯åœ¨Windowsæœºå™¨ä¸Šï¼‰ï¼Œå¹¶ä¸”å¯ä»¥å¯¹è¿™äº›ä¿¡æ¯è¿›è¡Œ**æœç´¢**ã€‚

å› æ­¤ï¼Œæµè§ˆå™¨æ‰©å±•çš„å†…å­˜**ä¸åº”è¢«è§†ä¸ºå®‰å…¨**ï¼Œ**æ•æ„Ÿä¿¡æ¯**ï¼ˆå¦‚å‡­æ®æˆ–åŠ©è®°è¯çŸ­è¯­ï¼‰**ä¸åº”å­˜å‚¨**ã€‚

å½“ç„¶ï¼Œ**ä¸è¦å°†æ•æ„Ÿä¿¡æ¯æ”¾åœ¨ä»£ç ä¸­**ï¼Œå› ä¸ºè¿™å°†æ˜¯**å…¬å¼€çš„**ã€‚

## å†…å®¹è„šæœ¬**â†”ï¸** åå°è„šæœ¬é€šä¿¡

å†…å®¹è„šæœ¬å¯ä»¥ä½¿ç”¨å‡½æ•°[**runtime.sendMessage()**](https://developer.chrome.com/docs/extensions/reference/runtime#method-sendMessage) **æˆ–** [**tabs.sendMessage()**](https://developer.chrome.com/docs/extensions/reference/tabs#method-sendMessage)å‘é€**ä¸€æ¬¡æ€§å¯åºåˆ—åŒ–ä¸ºJSON**çš„æ¶ˆæ¯ã€‚

è¦å¤„ç†**å“åº”**ï¼Œè¯·ä½¿ç”¨è¿”å›çš„**Promise**ã€‚å°½ç®¡å‡ºäºå‘åå…¼å®¹æ€§è€ƒè™‘ï¼Œä»ç„¶å¯ä»¥å°†**å›è°ƒå‡½æ•°**ä½œä¸ºæœ€åä¸€ä¸ªå‚æ•°ä¼ é€’ã€‚

ä»**å†…å®¹è„šæœ¬**å‘é€è¯·æ±‚å¦‚ä¸‹æ‰€ç¤ºï¼š
```javascript
(async () => {
const response = await chrome.runtime.sendMessage({greeting: "hello"});
// do something with response here, not outside the function
console.log(response);
})();
```
ä»**æ‰©å±•ç¨‹åº**ï¼ˆé€šå¸¸æ˜¯**åå°è„šæœ¬**ï¼‰å‘é€è¯·æ±‚ã€‚å†…å®¹è„šæœ¬å¯ä»¥ä½¿ç”¨è¿™äº›å‡½æ•°ï¼Œåªæ˜¯éœ€è¦æŒ‡å®šè¦å‘é€åˆ°å“ªä¸ªæ ‡ç­¾é¡µã€‚å‘é€æ¶ˆæ¯åˆ°æ‰€é€‰æ ‡ç­¾é¡µä¸­çš„å†…å®¹è„šæœ¬çš„ç¤ºä¾‹ï¼š
```javascript
// From https://stackoverflow.com/questions/36153999/how-to-send-a-message-between-chrome-extension-popup-and-content-script
(async () => {
const [tab] = await chrome.tabs.query({active: true, lastFocusedWindow: true});
const response = await chrome.tabs.sendMessage(tab.id, {greeting: "hello"});
// do something with response here, not outside the function
console.log(response);
})();
```
åœ¨**æ¥æ”¶ç«¯**ï¼Œæ‚¨éœ€è¦è®¾ç½®ä¸€ä¸ª[**runtime.onMessage**](https://developer.chrome.com/docs/extensions/reference/runtime#event-onMessage) **äº‹ä»¶ç›‘å¬å™¨**æ¥å¤„ç†æ¶ˆæ¯ã€‚è¿™åœ¨å†…å®¹è„šæœ¬æˆ–æ‰©å±•é¡µé¢ä¸­çœ‹èµ·æ¥æ˜¯ä¸€æ ·çš„ã€‚
```javascript
// From https://stackoverflow.com/questions/70406787/javascript-send-message-from-content-js-to-background-js
chrome.runtime.onMessage.addListener(
function(request, sender, sendResponse) {
console.log(sender.tab ?
"from a content script:" + sender.tab.url :
"from the extension");
if (request.greeting === "hello")
sendResponse({farewell: "goodbye"});
}
);
```
åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œ**`sendResponse()`** ä»¥åŒæ­¥æ–¹å¼æ‰§è¡Œã€‚è¦ä¿®æ”¹`onMessage`äº‹ä»¶å¤„ç†ç¨‹åºä»¥å¼‚æ­¥æ‰§è¡Œ`sendResponse()`ï¼Œå¿…é¡»åŠ å…¥`return true;`ã€‚

ä¸€ä¸ªé‡è¦çš„è€ƒè™‘å› ç´ æ˜¯ï¼Œåœ¨è®¾ç½®å¤šä¸ªé¡µé¢æ¥æ”¶`onMessage`äº‹ä»¶çš„æƒ…å†µä¸‹ï¼Œ**ç¬¬ä¸€ä¸ªæ‰§è¡Œ`sendResponse()`** çš„é¡µé¢å°†æ˜¯å”¯ä¸€èƒ½å¤Ÿæœ‰æ•ˆä¼ é€’å“åº”çš„é¡µé¢ã€‚å¯¹äºåŒä¸€äº‹ä»¶çš„ä»»ä½•åç»­å“åº”å°†ä¸äºˆè€ƒè™‘ã€‚

åœ¨ç¼–å†™æ–°æ‰©å±•æ—¶ï¼Œåº”ä¼˜å…ˆé€‰æ‹©ä½¿ç”¨ promises è€Œä¸æ˜¯å›è°ƒã€‚å…³äºå›è°ƒçš„ä½¿ç”¨ï¼Œ`sendResponse()` å‡½æ•°ä»…åœ¨ç›´æ¥åœ¨åŒæ­¥ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œæ—¶è¢«è§†ä¸ºæœ‰æ•ˆï¼Œæˆ–è€…å¦‚æœäº‹ä»¶å¤„ç†ç¨‹åºé€šè¿‡è¿”å›`true`æŒ‡ç¤ºå¼‚æ­¥æ“ä½œã€‚å¦‚æœæ²¡æœ‰å¤„ç†ç¨‹åºè¿”å›`true`ï¼Œæˆ–è€…å¦‚æœ`sendResponse()`å‡½æ•°è¢«ç§»é™¤ï¼ˆåƒåœ¾å›æ”¶ï¼‰ï¼Œåˆ™ä¸`sendMessage()`å‡½æ•°å…³è”çš„å›è°ƒå°†é»˜è®¤è§¦å‘ã€‚

## åœ¨æµè§ˆå™¨ä¸­åŠ è½½æ‰©å±•

1. **ä¸‹è½½**æµè§ˆå™¨æ‰©å±•å¹¶è§£å‹ç¼©
2. è½¬åˆ°**`chrome://extensions/`**å¹¶**å¯ç”¨**`å¼€å‘è€…æ¨¡å¼`
3. ç‚¹å‡»**`åŠ è½½å·²è§£å‹çš„æ‰©å±•`**æŒ‰é’®

åœ¨**Firefox**ä¸­ï¼Œè½¬åˆ°**`about:debugging#/runtime/this-firefox`**ï¼Œç„¶åç‚¹å‡»**`åŠ è½½ä¸´æ—¶é™„åŠ ç»„ä»¶`**æŒ‰é’®ã€‚

## ä»å•†åº—è·å–æºä»£ç 

Chromeæ‰©å±•çš„æºä»£ç å¯ä»¥é€šè¿‡å„ç§æ–¹æ³•è·å–ã€‚ä»¥ä¸‹æ˜¯æ¯ç§é€‰é¡¹çš„è¯¦ç»†è¯´æ˜å’Œè¯´æ˜ã€‚

### é€šè¿‡å‘½ä»¤è¡Œä¸‹è½½ZIPæ ¼å¼çš„æ‰©å±•

å¯ä»¥ä½¿ç”¨å‘½ä»¤è¡Œå°†Chromeæ‰©å±•çš„æºä»£ç ä¸‹è½½ä¸ºZIPæ–‡ä»¶ã€‚è¿™æ¶‰åŠä½¿ç”¨`curl`ä»ç‰¹å®šURLè·å–ZIPæ–‡ä»¶ï¼Œç„¶åå°†ZIPæ–‡ä»¶çš„å†…å®¹æå–åˆ°ä¸€ä¸ªç›®å½•ä¸­ã€‚ä»¥ä¸‹æ˜¯æ­¥éª¤ï¼š

1. ç”¨å®é™…çš„æ‰©å±•IDæ›¿æ¢`"extension_id"`ã€‚
2. æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š
```bash
extension_id=your_extension_id   # Replace with the actual extension ID
curl -L -o "$extension_id.zip" "https://clients2.google.com/service/update2/crx?response=redirect&os=mac&arch=x86-64&nacl_arch=x86-64&prod=chromecrx&prodchannel=stable&prodversion=44.0.2403.130&x=id%3D$extension_id%26uc"
unzip -d "$extension_id-source" "$extension_id.zip"
```
### ä½¿ç”¨CRX Viewerç½‘ç«™

[https://robwu.nl/crxviewer/](https://robwu.nl/crxviewer/)

### ä½¿ç”¨CRX Vieweræ‰©å±•

å¦ä¸€ç§æ–¹ä¾¿çš„æ–¹æ³•æ˜¯ä½¿ç”¨Chromeæ‰©å±•æºä»£ç æŸ¥çœ‹å™¨ï¼Œè¿™æ˜¯ä¸€ä¸ªå¼€æºé¡¹ç›®ã€‚å¯ä»¥ä»[Chrome Webå•†åº—](https://chrome.google.com/webstore/detail/chrome-extension-source-v/jifpbeccnghkjeaalbbjmodiffmgedin?hl=en)å®‰è£…ã€‚æŸ¥çœ‹å™¨çš„æºä»£ç å¯åœ¨å…¶[GitHubå­˜å‚¨åº“](https://github.com/Rob--W/crxviewer)ä¸­æ‰¾åˆ°ã€‚

### æŸ¥çœ‹æœ¬åœ°å®‰è£…æ‰©å±•çš„æºä»£ç 

ä¹Ÿå¯ä»¥æ£€æŸ¥æœ¬åœ°å®‰è£…çš„Chromeæ‰©å±•ã€‚æ“ä½œæ­¥éª¤å¦‚ä¸‹ï¼š

1. è®¿é—®`chrome://version/`ä»¥æŸ¥æ‰¾â€œProfile Pathâ€å­—æ®µï¼Œè¿›å…¥Chromeæœ¬åœ°é…ç½®æ–‡ä»¶ç›®å½•ã€‚
2. è½¬åˆ°é…ç½®æ–‡ä»¶ç›®å½•ä¸­çš„`Extensions/`å­æ–‡ä»¶å¤¹ã€‚
3. è¯¥æ–‡ä»¶å¤¹åŒ…å«æ‰€æœ‰å·²å®‰è£…çš„æ‰©å±•ï¼Œé€šå¸¸ä»¥å¯è¯»æ ¼å¼æ˜¾ç¤ºå…¶æºä»£ç ã€‚

è¦è¯†åˆ«æ‰©å±•ï¼Œå¯ä»¥å°†å…¶IDæ˜ å°„åˆ°åç§°ï¼š

* åœ¨`about:extensions`é¡µé¢ä¸Šå¯ç”¨å¼€å‘è€…æ¨¡å¼ï¼Œä»¥æŸ¥çœ‹æ¯ä¸ªæ‰©å±•çš„IDã€‚
* åœ¨æ¯ä¸ªæ‰©å±•çš„æ–‡ä»¶å¤¹ä¸­ï¼Œ`manifest.json`æ–‡ä»¶åŒ…å«ä¸€ä¸ªå¯è¯»çš„`name`å­—æ®µï¼Œå¸®åŠ©æ‚¨è¯†åˆ«æ‰©å±•ã€‚

### ä½¿ç”¨æ–‡ä»¶å‹ç¼©å·¥å…·æˆ–è§£åŒ…å·¥å…·

å‰å¾€Chrome Webå•†åº—å¹¶ä¸‹è½½æ‰©å±•ã€‚æ–‡ä»¶å°†å…·æœ‰`.crx`æ‰©å±•åã€‚å°†æ–‡ä»¶æ‰©å±•åä»`.crx`æ›´æ”¹ä¸º`.zip`ã€‚ä½¿ç”¨ä»»ä½•æ–‡ä»¶å‹ç¼©å·¥å…·ï¼ˆå¦‚WinRARã€7-Zipç­‰ï¼‰æ¥æå–ZIPæ–‡ä»¶çš„å†…å®¹ã€‚

### åœ¨Chromeä¸­ä½¿ç”¨å¼€å‘è€…æ¨¡å¼

æ‰“å¼€Chromeå¹¶è½¬åˆ°`chrome://extensions/`ã€‚åœ¨å³ä¸Šè§’å¯ç”¨â€œå¼€å‘è€…æ¨¡å¼â€ã€‚å•å‡»â€œåŠ è½½å·²è§£å‹çš„æ‰©å±•...â€ã€‚å¯¼èˆªåˆ°æ‰©å±•çš„ç›®å½•ã€‚è¿™ä¸ä¼šä¸‹è½½æºä»£ç ï¼Œä½†å¯¹äºæŸ¥çœ‹å’Œä¿®æ”¹å·²ä¸‹è½½æˆ–å¼€å‘çš„æ‰©å±•çš„ä»£ç å¾ˆæœ‰ç”¨ã€‚

## å®‰å…¨å®¡è®¡æ£€æŸ¥æ¸…å•

å°½ç®¡æµè§ˆå™¨æ‰©å±•å…·æœ‰**æœ‰é™çš„æ”»å‡»é¢**ï¼Œä½†å…¶ä¸­ä¸€äº›å¯èƒ½åŒ…å«**æ¼æ´**æˆ–**æ½œåœ¨çš„åŠ å›ºæ”¹è¿›**ã€‚ä»¥ä¸‹æ˜¯æœ€å¸¸è§çš„ï¼š

* [ ] **å°½å¯èƒ½é™åˆ¶**è¯·æ±‚çš„**`æƒé™`**
* [ ] **å°½å¯èƒ½é™åˆ¶**`host_permissions`**
* ä½¿ç”¨**å¼ºå¤§çš„** **`content_security_policy`**
* [ ] **å°½å¯èƒ½é™åˆ¶**`externally_connectable`ï¼Œå¦‚æœä¸éœ€è¦å¹¶ä¸”å¯èƒ½çš„è¯ï¼Œä¸è¦é»˜è®¤ç•™ä¸‹ï¼ŒæŒ‡å®š**`{}`**
* å¦‚æœæ­¤å¤„æåˆ°**æ˜“å—XSSæ”»å‡»æˆ–æ¥ç®¡**çš„URLï¼Œåˆ™æ”»å‡»è€…å°†èƒ½å¤Ÿ**ç›´æ¥å‘åå°è„šæœ¬å‘é€æ¶ˆæ¯**ã€‚éå¸¸å¼ºå¤§çš„ç»•è¿‡æ–¹å¼ã€‚
* [ ] **å°½å¯èƒ½é™åˆ¶**`web_accessible_resources`ï¼Œå¦‚æœå¯èƒ½ï¼Œç”šè‡³ä¸ºç©ºã€‚
* å¦‚æœ**`web_accessible_resources`**ä¸æ˜¯noneï¼Œè¯·æ£€æŸ¥[**ClickJacking**](browext-clickjacking.md)
* å¦‚æœä»**æ‰©å±•**åˆ°**ç½‘é¡µ**æœ‰ä»»ä½•**é€šä¿¡**ï¼Œè¯·æ£€æŸ¥ç”±é€šä¿¡å¼•èµ·çš„[**XSSæ¼æ´**](browext-xss-example.md)
* å¦‚æœä½¿ç”¨Post Messagesï¼Œè¯·æ£€æŸ¥[**Post Messageæ¼æ´**](../postmessage-vulnerabilities/)**ã€‚**
* å¦‚æœ**å†…å®¹è„šæœ¬è®¿é—®DOMè¯¦ç»†ä¿¡æ¯**ï¼Œè¯·æ£€æŸ¥å®ƒä»¬æ˜¯å¦åœ¨è¢«ç½‘é¡µ**ä¿®æ”¹**æ—¶å¼•å…¥äº†XSS
* ç‰¹åˆ«å¼ºè°ƒå¦‚æœæ­¤é€šä¿¡è¿˜æ¶‰åŠ**å†…å®¹è„šæœ¬ -> åå°è„šæœ¬é€šä¿¡**
* **æ•æ„Ÿä¿¡æ¯ä¸åº”å­˜å‚¨**åœ¨æµè§ˆå™¨æ‰©å±•**ä»£ç **ä¸­
* **æ•æ„Ÿä¿¡æ¯ä¸åº”å­˜å‚¨**åœ¨æµè§ˆå™¨æ‰©å±•**å†…å­˜**ä¸­

## å·¥å…·

### [**Tarnish**](https://thehackerblog.com/tarnish/)

* ä»æä¾›çš„Chrome Webå•†åº—é“¾æ¥ä¸­æå–ä»»ä½•Chromeæ‰©å±•ã€‚
* [**manifest.json**](https://developer.chrome.com/extensions/manifest) **æŸ¥çœ‹å™¨**ï¼šç®€å•æ˜¾ç¤ºæ‰©å±•æ¸…å•çš„JSONæ ¼å¼åŒ–ç‰ˆæœ¬ã€‚
* **æŒ‡çº¹åˆ†æ**ï¼šæ£€æµ‹[web\_accessible\_resources](https://developer.chrome.com/extensions/manifest/web\_accessible\_resources)å¹¶è‡ªåŠ¨ç”ŸæˆChromeæ‰©å±•æŒ‡çº¹è¯†åˆ«JavaScriptã€‚
* **æ½œåœ¨çš„Clickjackingåˆ†æ**ï¼šæ£€æµ‹å…·æœ‰è®¾ç½®äº†[web\_accessible\_resources](https://developer.chrome.com/extensions/manifest/web\_accessible\_resources)æŒ‡ä»¤çš„æ‰©å±•HTMLé¡µé¢ã€‚æ ¹æ®é¡µé¢ç”¨é€”ï¼Œè¿™äº›é¡µé¢å¯èƒ½å®¹æ˜“å—åˆ°ç‚¹å‡»åŠ«æŒæ”»å‡»ã€‚
* **æƒé™è­¦å‘ŠæŸ¥çœ‹å™¨**ï¼šæ˜¾ç¤ºç”¨æˆ·å°è¯•å®‰è£…æ‰©å±•æ—¶å°†æ˜¾ç¤ºçš„æ‰€æœ‰Chromeæƒé™æç¤ºè­¦å‘Šåˆ—è¡¨ã€‚
* **å±é™©åŠŸèƒ½**ï¼šæ˜¾ç¤ºå¯èƒ½è¢«æ”»å‡»è€…åˆ©ç”¨çš„å±é™©åŠŸèƒ½ä½ç½®ï¼ˆä¾‹å¦‚innerHTMLã€chrome.tabs.executeScriptç­‰åŠŸèƒ½ï¼‰ã€‚
* **å…¥å£ç‚¹**ï¼šæ˜¾ç¤ºæ‰©å±•æ¥å—ç”¨æˆ·/å¤–éƒ¨è¾“å…¥çš„ä½ç½®ã€‚è¿™å¯¹äºäº†è§£æ‰©å±•çš„è¡¨é¢ç§¯å¹¶å¯»æ‰¾æ½œåœ¨çš„å‘é€æ¶æ„æ•°æ®åˆ°æ‰©å±•çš„ç‚¹å¾ˆæœ‰ç”¨ã€‚
* ç”Ÿæˆçš„è­¦æŠ¥åŒ…æ‹¬ä»¥ä¸‹å†…å®¹ï¼š
* å¼•å‘è­¦æŠ¥çš„ç›¸å…³ä»£ç ç‰‡æ®µå’Œè¡Œã€‚
* é—®é¢˜æè¿°ã€‚
* â€œæŸ¥çœ‹æ–‡ä»¶â€æŒ‰é’®ï¼Œå¯æŸ¥çœ‹åŒ…å«ä»£ç çš„å®Œæ•´æºæ–‡ä»¶ã€‚
* è­¦æŠ¥æ–‡ä»¶çš„è·¯å¾„ã€‚
* è­¦æŠ¥æ–‡ä»¶çš„å®Œæ•´Chromeæ‰©å±•URIã€‚
* æ–‡ä»¶ç±»å‹ï¼Œå¦‚åå°é¡µé¢è„šæœ¬ã€å†…å®¹è„šæœ¬ã€æµè§ˆå™¨æ“ä½œç­‰ã€‚
* å¦‚æœæ˜“å—æ”»å‡»çš„è¡Œåœ¨JavaScriptæ–‡ä»¶ä¸­ï¼Œåˆ™åŒ…æ‹¬å…¶åŒ…å«çš„æ‰€æœ‰é¡µé¢çš„è·¯å¾„ä»¥åŠè¿™äº›é¡µé¢çš„ç±»å‹ï¼Œä»¥åŠ[web\_accessible\_resource](https://developer.chrome.com/extensions/manifest/web\_accessible\_resources)çŠ¶æ€ã€‚
* **å†…å®¹å®‰å…¨ç­–ç•¥ï¼ˆCSPï¼‰åˆ†æå™¨å’Œç»•è¿‡æ£€æŸ¥å™¨**ï¼šæŒ‡å‡ºæ‰©å±•CSPä¸­çš„å¼±ç‚¹ï¼Œå¹¶é˜æ˜ç”±äºç™½åå•CDNç­‰åŸå› ç»•è¿‡CSPçš„æ½œåœ¨æ–¹æ³•ã€‚
* **å·²çŸ¥çš„æ˜“å—æ”»å‡»åº“**ï¼šä½¿ç”¨[Retire.js](https://retirejs.github.io/retire.js/)æ£€æŸ¥å·²çŸ¥æ˜“å—æ”»å‡»çš„JavaScriptåº“çš„ä½¿ç”¨æƒ…å†µã€‚
* ä¸‹è½½æ‰©å±•å’Œæ ¼å¼åŒ–ç‰ˆæœ¬ã€‚
* ä¸‹è½½åŸå§‹æ‰©å±•ã€‚
* ä¸‹è½½æ‰©å±•çš„ç¾åŒ–ç‰ˆæœ¬ï¼ˆè‡ªåŠ¨ç¾åŒ–çš„HTMLå’ŒJavaScriptï¼‰ã€‚
* è‡ªåŠ¨ç¼“å­˜æ‰«æç»“æœï¼Œç¬¬ä¸€æ¬¡è¿è¡Œæ‰©å±•æ‰«æå°†èŠ±è´¹å¤§é‡æ—¶é—´ã€‚ä½†ç¬¬äºŒæ¬¡è¿è¡Œï¼Œå‡è®¾æ‰©å±•æœªæ›´æ–°ï¼Œå°†å‡ ä¹ç¬é—´å®Œæˆï¼Œå› ä¸ºç»“æœå·²è¢«ç¼“å­˜ã€‚
* å¯é“¾æ¥çš„æŠ¥å‘ŠURLï¼Œè½»æ¾åœ°å°†å…¶ä»–äººé“¾æ¥åˆ°Tarnishç”Ÿæˆçš„æ‰©å±•æŠ¥å‘Šã€‚

### [Neto](https://github.com/elevenpaths/neto)

Netoé¡¹ç›®æ˜¯ä¸€ä¸ªPython 3åŒ…ï¼Œæ—¨åœ¨åˆ†æå’Œæ­ç¤ºæµè§ˆå™¨æ’ä»¶å’Œæ‰©å±•çš„éšè—åŠŸèƒ½ï¼Œé€‚ç”¨äºFirefoxå’ŒChromeç­‰çŸ¥åæµè§ˆå™¨ã€‚å®ƒè‡ªåŠ¨è§£å‹æ‰“åŒ…æ–‡ä»¶ï¼Œä»æ‰©å±•çš„ç›¸å…³èµ„æºä¸­æå–è¿™äº›åŠŸèƒ½ï¼Œå¦‚`manifest.json`ã€æœ¬åœ°åŒ–æ–‡ä»¶å¤¹æˆ–JavaScriptå’ŒHTMLæºæ–‡ä»¶ã€‚

## å‚è€ƒèµ„æ–™

* **æ„Ÿè°¢**[**@naivenom**](https://twitter.com/naivenom)**å¯¹æœ¬æ–¹æ³•è®ºçš„å¸®åŠ©**
* [https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing](https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing)
* [https://palant.info/2022/08/10/anatomy-of-a-basic-extension/](https://palant.info/2022/08/10/anatomy-of-a-basic-extension/)
* [https://palant.info/2022/08/24/attack-surface-of-extension-pages/](https://palant.info/2022/08/24/attack-surface-of-extension-pages/)
* [https://palant.info/2022/08/31/when-extension-pages-are-web-accessible/](https://palant.info/2022/08/31/when-extension-pages-are-web-accessible/)
* [https://help.passbolt.com/assets/files/PBL-02-report.pdf](https://help.passbolt.com/assets/files/PBL-02-report.pdf)
* [https://developer.chrome.com/docs/extensions/develop/concepts/content-scripts](https://developer.chrome.com/docs/extensions/develop/concepts/content-scripts)
* [https://developer.chrome.com/docs/extensions/mv2/background-pages](https://developer.chrome.com/docs/extensions/mv2/background-pages)
* [https://thehackerblog.com/kicking-the-rims-a-guide-for-securely-writing-and-auditing-chrome-extensions/](https://thehackerblog.com/kicking-the-rims-a-guide-for-securely-writing-and-auditing-chrome-extensions/)
* [https://gist.github.com/LongJohnCoder/9ddf5735df3a4f2e9559665fb864eac0](https://gist.github.com/LongJohnCoder/9ddf5735df3a4f2e9559665fb864eac0)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼:
* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨**Twitter**ä¸Š**å…³æ³¨**æˆ‘ä»¬ ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚
