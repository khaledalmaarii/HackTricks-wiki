# Metodologia Pentestingu Rozszerze Przegldarki

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na GitHubie.

</details>
{% endhint %}

## Podstawowe Informacje

Rozszerzenia przegldarki s napisane w JavaScript i adowane przez przegldark w tle. Maj sw贸j [DOM](https://www.w3schools.com/js/js\_htmldom.asp), ale mog wchodzi w interakcje z DOM-ami innych stron. Oznacza to, 偶e mog narusza poufno, integralno i dostpno (CIA) innych stron.

## G贸wne Komponenty

Ukady rozszerze wygldaj najlepiej, gdy s wizualizowane i skadaj si z trzech komponent贸w. Przyjrzyjmy si ka偶demu komponentowi dokadniej.

<figure><img src="../../.gitbook/assets/image (16) (1).png" alt=""><figcaption><p><a href="http://webblaze.cs.berkeley.edu/papers/Extensions.pdf">http://webblaze.cs.berkeley.edu/papers/Extensions.pdf</a></p></figcaption></figure>

### **Skrypty Treci**

Ka偶dy skrypt treci ma bezporedni dostp do DOM **pojedynczej strony internetowej** i jest tym samym nara偶ony na **potencjalnie zoliwe dane wejciowe**. Jednak skrypt treci nie zawiera 偶adnych uprawnie poza mo偶liwoci wysyania wiadomoci do rdzenia rozszerzenia.

### **Rdze Rozszerzenia**

Rdze rozszerzenia zawiera wikszo uprawnie/dostpu rozszerzenia, ale rdze rozszerzenia mo偶e wchodzi w interakcje z treci internetow tylko za porednictwem [XMLHttpRequest](https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest) i skrypt贸w treci. Ponadto rdze rozszerzenia nie ma bezporedniego dostpu do maszyny gospodarza.

### **Natychmiastowy Plik Binarny**

Rozszerzenie pozwala na natychmiastowy plik binarny, kt贸ry mo偶e **uzyska dostp do maszyny gospodarza z penymi uprawnieniami u偶ytkownika.** Natychmiastowy plik binarny wchodzi w interakcje z rdzeniem rozszerzenia za porednictwem standardowego interfejsu programowania aplikacji Netscape Plugin ([NPAPI](https://en.wikipedia.org/wiki/NPAPI)), u偶ywanego przez Flash i inne wtyczki przegldarki.

### Granice

{% hint style="danger" %}
Aby uzyska pene uprawnienia u偶ytkownika, atakujcy musi przekona rozszerzenie do przekazania zoliwych danych wejciowych ze skryptu treci do rdzenia rozszerzenia i z rdzenia rozszerzenia do natychmiastowego pliku binarnego.
{% endhint %}

Ka偶dy komponent rozszerzenia jest oddzielony od siebie przez **silne granice ochronne**. Ka偶dy komponent dziaa w **osobnym procesie systemu operacyjnego**. Skrypty treci i rdzenie rozszerze dziaaj w **procesach piaskownicy**, niedostpnych dla wikszoci usug systemu operacyjnego.

Co wicej, skrypty treci s oddzielone od swoich powizanych stron internetowych przez **dziaanie w osobnym stosie JavaScript**. Skrypt treci i strona internetowa maj **dostp do tego samego podstawowego DOM**, ale obie **nigdy nie wymieniaj wska藕nik贸w JavaScript**, co zapobiega wyciekowi funkcjonalnoci JavaScript.

## **`manifest.json`**

Rozszerzenie Chrome to po prostu folder ZIP z [.crx file extension](https://www.lifewire.com/crx-file-2620391). Rdze rozszerzenia to plik **`manifest.json`** w katalogu g贸wnym folderu, kt贸ry okrela ukad, uprawnienia i inne opcje konfiguracyjne.

Przykad:
```json
{
"manifest_version": 2,
"name": "My extension",
"version": "1.0",
"permissions": [
"storage"
],
"content_scripts": [
{
"js": [
"script.js"
],
"matches": [
"https://example.com/*",
"https://www.example.com/*"
],
"exclude_matches": ["*://*/*business*"],
}
],
"background": {
"scripts": [
"background.js"
]
},
"options_ui": {
"page": "options.html"
}
}
```
### `content_scripts`

Skrypty zawartoci s **adowane** za ka偶dym razem, gdy u偶ytkownik **nawiguj do pasujcej strony**, w naszym przypadku ka偶da strona pasujca do wyra偶enia **`https://example.com/*`** i niepasujca do wyra偶enia regex **`*://*/*/business*`**. Wykonuj si **jak wasne skrypty strony** i maj dowolny dostp do [Modelu Obiekt贸w Dokumentu (DOM)](https://developer.mozilla.org/en-US/docs/Web/API/Document\_Object\_Model) strony.
```json
"content_scripts": [
{
"js": [
"script.js"
],
"matches": [
"https://example.com/*",
"https://www.example.com/*"
],
"exclude_matches": ["*://*/*business*"],
}
],
```
Aby doda lub wykluczy wicej adres贸w URL, mo偶na r贸wnie偶 u偶y **`include_globs`** i **`exclude_globs`**.

To jest przykad skryptu zawartoci, kt贸ry doda przycisk wyjanienia do strony, gdy [API storage](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/storage) zostanie u偶yte do pobrania wartoci `message` z pamici rozszerzenia.
```js
chrome.storage.local.get("message", result =>
{
let div = document.createElement("div");
div.innerHTML = result.message + " <button>Explain</button>";
div.querySelector("button").addEventListener("click", () =>
{
chrome.runtime.sendMessage("explain");
});
document.body.appendChild(div);
});
```
<figure><img src="../../.gitbook/assets/image (23).png" alt=""><figcaption></figcaption></figure>

Wiadomo jest wysyana do stron rozszerzenia przez skrypt treci, gdy ten przycisk jest klikany, poprzez wykorzystanie [**runtime.sendMessage() API**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/runtime/sendMessage). Wynika to z ograniczenia skryptu treci w bezporednim dostpie do API, przy czym `storage` jest jednym z nielicznych wyjtk贸w. Dla funkcjonalnoci wykraczajcych poza te wyjtki, wiadomoci s wysyane do stron rozszerzenia, z kt贸rymi skrypty treci mog komunikowa si.

{% hint style="warning" %}
W zale偶noci od przegldarki, mo偶liwoci skryptu treci mog si nieco r贸偶ni. Dla przegldarek opartych na Chromium, lista mo偶liwoci jest dostpna w [dokumentacji Chrome Developers](https://developer.chrome.com/docs/extensions/mv3/content\_scripts/#capabilities), a dla Firefox, [MDN](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/Content\_scripts#webextension\_apis) su偶y jako g贸wne 藕r贸do.\
Warto r贸wnie偶 zauwa偶y, 偶e skrypty treci maj mo偶liwo komunikacji z skryptami w tle, co umo偶liwia im wykonywanie dziaa i przekazywanie odpowiedzi z powrotem.
{% endhint %}

Aby wywietli i debugowa skrypty treci w Chrome, menu narzdzi dewelopera mo偶na otworzy z Opcje > Wicej narzdzi > Narzdzia dewelopera LUB naciskajc Ctrl + Shift + I.

Po wywietleniu narzdzi dewelopera, nale偶y klikn zakadk **殴r贸do**, a nastpnie zakadk **Skrypty treci**. Umo偶liwia to obserwacj dziaajcych skrypt贸w treci z r贸偶nych rozszerze oraz ustawienie punkt贸w przerwania w celu ledzenia przepywu wykonania.

### Wstrzyknite skrypty treci

{% hint style="success" %}
Zauwa偶, 偶e **Skrypty Treci nie s obowizkowe**, poniewa偶 mo偶liwe jest r贸wnie偶 **dynamiczne** **wstrzykiwanie** skrypt贸w oraz **programowe wstrzykiwanie ich** na stronach internetowych za pomoc **`tabs.executeScript`**. To w rzeczywistoci zapewnia bardziej **szczeg贸ow kontrol**.
{% endhint %}

Aby programowo wstrzykn skrypt treci, rozszerzenie musi mie [uprawnienia hosta](https://developer.chrome.com/docs/extensions/reference/permissions) dla strony, do kt贸rej skrypty maj by wstrzyknite. Uprawnienia te mog by zabezpieczone albo przez **za偶danie ich** w manifecie rozszerzenia, albo tymczasowo poprzez [**activeTab**](https://developer.chrome.com/docs/extensions/reference/manifest/activeTab).

#### Przykad rozszerzenia opartego na activeTab

{% code title="manifest.json" %}
```json
{
"name": "My extension",
...
"permissions": [
"activeTab",
"scripting"
],
"background": {
"service_worker": "background.js"
},
"action": {
"default_title": "Action Button"
}
}
```
{% endcode %}

* **Wstrzyknij plik JS po klikniciu:**
```javascript
// content-script.js
document.body.style.backgroundColor = "orange";

//service-worker.js - Inject the JS file
chrome.action.onClicked.addListener((tab) => {
chrome.scripting.executeScript({
target: { tabId: tab.id },
files: ["content-script.js"]
});
});
```
* **Wstrzyknij funkcj** po klikniciu:
```javascript
//service-worker.js - Inject a function
function injectedFunction() {
document.body.style.backgroundColor = "orange";
}

chrome.action.onClicked.addListener((tab) => {
chrome.scripting.executeScript({
target : {tabId : tab.id},
func : injectedFunction,
});
});
```
#### Przykad z uprawnieniami skrypt贸w
```javascript
// service-workser.js
chrome.scripting.registerContentScripts([{
id : "test",
matches : [ "https://*.example.com/*" ],
excludeMatches : [ "*://*/*business*" ],
js : [ "contentScript.js" ],
}]);

// Another example
chrome.tabs.executeScript(tabId, { file: "content_script.js" });
```
Aby doda lub wykluczy wicej adres贸w URL, mo偶na r贸wnie偶 u偶y **`include_globs`** i **`exclude_globs`**.

### Skrypty zawartoci `run_at`

Pole `run_at` kontroluje **kiedy pliki JavaScript s wstrzykiwane do strony internetowej**. Preferowana i domylna warto to `"document_idle"`.

Mo偶liwe wartoci to:

* **`document_idle`**: Kiedy tylko to mo偶liwe
* **`document_start`**: Po zaadowaniu jakichkolwiek plik贸w z `css`, ale przed skonstruowaniem jakiegokolwiek innego DOM lub uruchomieniem jakiegokolwiek innego skryptu.
* **`document_end`**: Natychmiast po zakoczeniu DOM, ale przed zaadowaniem subzasob贸w, takich jak obrazy i ramki.

#### Poprzez `manifest.json`
```json
{
"name": "My extension",
...
"content_scripts": [
{
"matches": ["https://*.example.com/*"],
"run_at": "document_idle",
"js": ["contentScript.js"]
}
],
...
}

```
Via **`service-worker.js`**
```javascript
chrome.scripting.registerContentScripts([{
id : "test",
matches : [ "https://*.example.com/*" ],
runAt : "document_idle",
js : [ "contentScript.js" ],
}]);
```
### `background`

Wiadomoci wysyane przez skrypty treci s odbierane przez **stron w tle**, kt贸ra odgrywa centraln rol w koordynowaniu komponent贸w rozszerzenia. Co wa偶ne, strona w tle utrzymuje si przez cay czas trwania rozszerzenia, dziaajc dyskretnie bez bezporedniej interakcji u偶ytkownika. Posiada wasny Model Obiekt贸w Dokumentu (DOM), co umo偶liwia zo偶one interakcje i zarzdzanie stanem.

**Kluczowe punkty**:

* **Rola strony w tle:** Dziaa jako centrum nerwowe dla rozszerzenia, zapewniajc komunikacj i koordynacj midzy r贸偶nymi czciami rozszerzenia.
* **Trwao:** To zawsze obecny byt, niewidoczny dla u偶ytkownika, ale integralny dla funkcjonalnoci rozszerzenia.
* **Automatyczne generowanie:** Jeli nie jest wyra藕nie zdefiniowane, przegldarka automatycznie utworzy stron w tle. Ta automatycznie generowana strona bdzie zawiera wszystkie skrypty w tle okrelone w manifecie rozszerzenia, zapewniajc pynne dziaanie zada w tle rozszerzenia.

{% hint style="success" %}
Wygoda zapewniana przez przegldark w automatycznym generowaniu strony w tle (gdy nie jest wyra藕nie zadeklarowana) zapewnia, 偶e wszystkie niezbdne skrypty w tle s zintegrowane i dziaaj, upraszczajc proces konfiguracji rozszerzenia.
{% endhint %}

Przykadowy skrypt w tle:
```js
chrome.runtime.onMessage.addListener((request, sender, sendResponse) =>
{
if (request == "explain")
{
chrome.tabs.create({ url: "https://example.net/explanation" });
}
})
```
U偶ywa [runtime.onMessage API](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/runtime/onMessage) do nasuchiwania wiadomoci. Gdy otrzymana zostanie wiadomo `"explain"`, u偶ywa [tabs API](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs) do otwarcia strony w nowej karcie.

Aby debugowa skrypt w tle, mo偶esz przej do **szczeg贸贸w rozszerzenia i zbada serwis worker,** co otworzy narzdzia deweloperskie z skryptem w tle:

<figure><img src="https://github.com/carlospolop/hacktricks/blob/master/pentesting-web/browser-extension-pentesting-methodology/broken-reference" alt=""><figcaption></figcaption></figure>

### Strony opcji i inne

Rozszerzenia przegldarki mog zawiera r贸偶ne rodzaje stron:

* **Strony akcji** s wywietlane w **rozwijanym menu po klikniciu na ikon rozszerzenia.**
* Strony, kt贸re rozszerzenie **zaaduje w nowej karcie.**
* **Strony opcji**: Ta strona wywietla si na g贸rze rozszerzenia po klikniciu. W poprzednim manifecie w moim przypadku mogem uzyska dostp do tej strony w `chrome://extensions/?options=fadlhnelkbeojnebcbkacjilhnbjfjca` lub klikajc:

<figure><img src="../../.gitbook/assets/image (24).png" alt="" width="375"><figcaption></figcaption></figure>

Zauwa偶, 偶e te strony nie s trwae jak strony w tle, poniewa偶 aduj dynamicznie treci w zale偶noci od potrzeb. Mimo to, dziel pewne mo偶liwoci z stron w tle:

* **Komunikacja z skryptami treci:** Podobnie jak strona w tle, te strony mog otrzymywa wiadomoci od skrypt贸w treci, co uatwia interakcj w ramach rozszerzenia.
* **Dostp do specyficznych dla rozszerzenia API:** Te strony maj peny dostp do specyficznych dla rozszerzenia API, zgodnie z uprawnieniami zdefiniowanymi dla rozszerzenia.

### `permissions` & `host_permissions`

**`permissions`** i **`host_permissions`** to wpisy z `manifest.json`, kt贸re wskazuj **jakie uprawnienia** ma rozszerzenie przegldarki (przechowywanie, lokalizacja...) oraz **na jakich stronach internetowych**.

Poniewa偶 rozszerzenia przegldarki mog by tak **uprzywilejowane**, zoliwe lub skompromitowane mogyby umo偶liwi atakujcemu **r贸偶ne sposoby kradzie偶y wra偶liwych informacji i szpiegowania u偶ytkownika**.

Sprawd藕, jak te ustawienia dziaaj i jak mog by nadu偶ywane w:

{% content-ref url="browext-permissions-and-host_permissions.md" %}
[browext-permissions-and-host\_permissions.md](browext-permissions-and-host\_permissions.md)
{% endcontent-ref %}

### `content_security_policy`

**Polityka bezpieczestwa treci** mo偶e by r贸wnie偶 zadeklarowana w `manifest.json`. Jeli jest zdefiniowana, mo偶e by **vulnerybilna**.

Domylne ustawienie dla stron rozszerze przegldarki jest do restrykcyjne:
```bash
script-src 'self'; object-src 'self';
```
Aby strona internetowa moga uzyska dostp do strony rozszerzenia przegldarki, na przykad strony `.html`, ta strona musi by wymieniona w polu **`web_accessible_resources`** w pliku `manifest.json`.\
Na przykad:
```javascript
{
...
"web_accessible_resources": [
{
"resources": [ "images/*.png" ],
"matches": [ "https://example.com/*" ]
},
{
"resources": [ "fonts/*.woff" ],
"matches": [ "https://example.com/*" ]
}
],
...
}
```
Te strony s dostpne pod adresem URL takim jak:
```
chrome-extension://<extension-id>/message.html
```
W publicznych rozszerzeniach **identyfikator rozszerzenia jest dostpny**:

<figure><img src="../../.gitbook/assets/image (1194).png" alt="" width="375"><figcaption></figcaption></figure>

Jednak偶e, jeli parametr `manifest.json` **`use_dynamic_url`** jest u偶ywany, ten **identyfikator mo偶e by dynamiczny**.

{% hint style="success" %}
Zauwa偶, 偶e nawet jeli strona jest tutaj wymieniona, mo偶e by **chroniona przed ClickJacking** dziki **Polityce Bezpieczestwa Treci**. Dlatego musisz to r贸wnie偶 sprawdzi (sekcja frame-ancestors), zanim potwierdzisz, 偶e atak ClickJacking jest mo偶liwy.
{% endhint %}

Dopuszczenie dostpu do tych stron sprawia, 偶e s one **potencjalnie podatne na ClickJacking**:

{% content-ref url="browext-clickjacking.md" %}
[browext-clickjacking.md](browext-clickjacking.md)
{% endcontent-ref %}

{% hint style="success" %}
Zezwolenie na adowanie tych stron tylko przez rozszerzenie, a nie przez losowe adresy URL, mo偶e zapobiec atakom ClickJacking.
{% endhint %}

{% hint style="danger" %}
Zauwa偶, 偶e strony z **`web_accessible_resources`** oraz inne strony rozszerzenia s r贸wnie偶 zdolne do **kontaktowania si z skryptami w tle**. Jeli jedna z tych stron jest podatna na **XSS**, mo偶e to otworzy wiksz luk.

Ponadto, zauwa偶, 偶e mo偶esz otworzy tylko strony wskazane w **`web_accessible_resources`** wewntrz iframe, ale z nowej karty mo偶liwe jest uzyskanie dostpu do dowolnej strony w rozszerzeniu, znajc identyfikator rozszerzenia. Dlatego, jeli znajdziesz XSS wykorzystujce te same parametry, mo偶e to by nadu偶ywane, nawet jeli strona nie jest skonfigurowana w **`web_accessible_resources`**.
{% endhint %}

### `externally_connectable`

Zgodnie z [**dokumentacj**](https://developer.chrome.com/docs/extensions/reference/manifest/externally-connectable), waciwo manifestu `"externally_connectable"` deklaruje **kt贸re rozszerzenia i strony internetowe mog czy si** z Twoim rozszerzeniem za pomoc [runtime.connect](https://developer.chrome.com/docs/extensions/reference/runtime#method-connect) i [runtime.sendMessage](https://developer.chrome.com/docs/extensions/reference/runtime#method-sendMessage).

* Jeli klucz **`externally_connectable`** **nie** jest zadeklarowany w manifecie Twojego rozszerzenia lub jest zadeklarowany jako **`"ids": ["*"]`**, **wszystkie rozszerzenia mog si czy, ale 偶adne strony internetowe nie mog si czy**.
* Jeli **okrelone identyfikatory s podane**, jak w `"ids": ["aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"]`, **tylko te aplikacje** mog si czy.
* Jeli **okrelone wzory** s podane, te aplikacje webowe bd mogy si czy:
```json
"matches": [
"https://*.google.com/*",
"*://*.chromium.org/*",
```
* Jeli jest okrelone jako puste: **`"externally_connectable": {}`**, 偶adna aplikacja ani strona internetowa nie bd mogy si poczy.

Im **mniej rozszerze i adres贸w URL** wskazanych tutaj, tym **mniejsza powierzchnia ataku**.

{% hint style="danger" %}
Jeli strona internetowa **wra偶liwa na XSS lub przejcie** jest wskazana w **`externally_connectable`**, atakujcy bdzie m贸g **wysya wiadomoci bezporednio do skryptu w tle**, cakowicie omijajc skrypt treci i jego CSP.

Dlatego jest to **bardzo pot偶ne obejcie**.

Co wicej, jeli klient zainstaluje zoliwe rozszerzenie, nawet jeli nie jest dozwolone do komunikacji z wra偶liwym rozszerzeniem, mo偶e wstrzykn **dane XSS w dozwolonej stronie internetowej** lub nadu偶y **`WebRequest`** lub **`DeclarativeNetRequest`** API, aby manipulowa 偶daniami na docelowej domenie, zmieniajc 偶danie strony dla **pliku JavaScript**. (Zauwa偶, 偶e CSP na docelowej stronie mo偶e zapobiec tym atakom). Ten pomys pochodzi [**z tego opisu**](https://www.darkrelay.com/post/opera-zero-day-rce-vulnerability).
{% endhint %}

## Podsumowanie komunikacji

### Rozszerzenie <--> WebApp

Aby komunikowa si midzy skryptem treci a stron internetow, zazwyczaj u偶ywane s wiadomoci post. Dlatego w aplikacji internetowej zazwyczaj znajdziesz wywoania funkcji **`window.postMessage`** oraz w skrypcie treci nasuchiwacze, takie jak **`window.addEventListener`**. Nale偶y jednak pamita, 偶e rozszerzenie mo偶e r贸wnie偶 **komunikowa si z aplikacj internetow, wysyajc wiadomo Post** (a zatem strona powinna si tego spodziewa) lub po prostu sprawi, by strona zaadowaa nowy skrypt.

### Wewntrz rozszerzenia

Zazwyczaj funkcja **`chrome.runtime.sendMessage`** jest u偶ywana do wysyania wiadomoci wewntrz rozszerzenia (zazwyczaj obsugiwana przez skrypt `background`), a aby j odebra i obsu偶y, deklarowany jest nasuchiwacz wywoujcy **`chrome.runtime.onMessage.addListener`**.

Mo偶liwe jest r贸wnie偶 u偶ycie **`chrome.runtime.connect()`** do nawizania trwaego poczenia zamiast wysyania pojedynczych wiadomoci, mo偶na go u偶y do **wysyania** i **odbierania** **wiadomoci**, jak w poni偶szym przykadzie:

<details>

<summary><code>chrome.runtime.connect()</code> przykad</summary>
```javascript
var port = chrome.runtime.connect();

// Listen for messages from the web page
window.addEventListener("message", (event) => {
// Only accept messages from the same window
if (event.source !== window) {
return;
}

// Check if the message type is "FROM_PAGE"
if (event.data.type && (event.data.type === "FROM_PAGE")) {
console.log("Content script received: " + event.data.text);
// Forward the message to the background script
port.postMessage({ type: 'FROM_PAGE', text: event.data.text });
}
}, false);

// Listen for messages from the background script
port.onMessage.addListener(function(msg) {
console.log("Content script received message from background script:", msg);
// Handle the response message from the background script
});
```
</details>

Mo偶liwe jest r贸wnie偶 wysyanie wiadomoci z skryptu w tle do skryptu treci znajdujcego si w okrelonej karcie, wywoujc **`chrome.tabs.sendMessage`**, gdzie bdziesz musia wskaza **ID karty**, do kt贸rej chcesz wysa wiadomo.

### Z dozwolonego `externally_connectable` do rozszerzenia

**Aplikacje internetowe i zewntrzne rozszerzenia przegldarki dozwolone** w konfiguracji `externally_connectable` mog wysya 偶dania za pomoc:
```javascript
chrome.runtime.sendMessage(extensionId, ...
```
Gdzie to konieczne, aby wspomnie o **identyfikatorze rozszerzenia**.

## Komunikacja Web **锔** Skrypt贸w Treci

rodowiska, w kt贸rych dziaaj **skrypty treci** oraz gdzie istniej strony hosta, s **oddzielone** od siebie, zapewniajc **izolacj**. Pomimo tej izolacji, obie strony maj mo偶liwo interakcji z **Model Obiekt贸w Dokumentu (DOM)** strony, wsp贸lnym zasobem. Aby strona hosta moga nawiza komunikacj z **skryptem treci**, lub porednio z rozszerzeniem przez skrypt treci, konieczne jest wykorzystanie **DOM**, kt贸ry jest dostpny dla obu stron jako kana komunikacyjny.

### Wiadomoci Post

{% code title="content-script.js" %}
```javascript
// This is like "chrome.runtime.sendMessage" but to maintain the connection
var port = chrome.runtime.connect();

window.addEventListener("message", (event) => {
// We only accept messages from ourselves
if (event.source !== window) {
return;
}

if (event.data.type && (event.data.type === "FROM_PAGE")) {
console.log("Content script received: " + event.data.text);
// Forward the message to the background script
port.postMessage(event.data.text);
}
}, false);
```
{% endcode %}

{% code title="example.js" %}
```javascript
document.getElementById("theButton").addEventListener("click", () => {
window.postMessage(
{type : "FROM_PAGE", text : "Hello from the webpage!"}, "*");
}, false);
```
{% endcode %}

Bezpieczna komunikacja Post Message powinna sprawdza autentyczno otrzymanej wiadomoci, co mo偶na zrobi, sprawdzajc:

* **`event.isTrusted`**: To jest True tylko wtedy, gdy zdarzenie zostao wywoane przez akcj u偶ytkownika
* Skrypt treci mo偶e oczekiwa wiadomoci tylko wtedy, gdy u偶ytkownik wykona jak akcj
* **domena 藕r贸dowa**: mo偶e oczekiwa wiadomoci tylko z dozwolonej listy domen.
* Jeli u偶ywana jest wyra偶enie regularne, bd藕 bardzo ostro偶ny
* **殴r贸do**: `received_message.source !== window` mo偶e by u偶yte do sprawdzenia, czy wiadomo bya **z tej samej okna**, w kt贸rym skrypt treci nasuchuje.

Poprzednie kontrole, nawet jeli s przeprowadzane, mog by podatne, wic sprawd藕 na nastpujcej stronie **potencjalne obejcia Post Message**:

{% content-ref url="../postmessage-vulnerabilities/" %}
[postmessage-vulnerabilities](../postmessage-vulnerabilities/)
{% endcontent-ref %}

### Iframe

Innym mo偶liwym sposobem komunikacji mog by **adresy URL Iframe**, przykad mo偶na znale藕 w:

{% content-ref url="browext-xss-example.md" %}
[browext-xss-example.md](browext-xss-example.md)
{% endcontent-ref %}

### DOM

To nie jest "dokadnie" spos贸b komunikacji, ale **sie i skrypt treci bd miay dostp do DOM sieci**. Wic, jeli **skrypt treci** odczytuje jakie informacje z niego, **ufajc DOM sieci**, sie mogaby **zmodyfikowa te dane** (poniewa偶 sie nie powinna by ufana, lub poniewa偶 sie jest podatna na XSS) i **skompromentowa skrypt treci**.

Mo偶esz r贸wnie偶 znale藕 przykad **XSS opartego na DOM, aby skompromitowa rozszerzenie przegldarki** w:

{% content-ref url="browext-xss-example.md" %}
[browext-xss-example.md](browext-xss-example.md)
{% endcontent-ref %}

## Komunikacja Skryptu Treci **锔** Skryptu Ta

Skrypt treci mo偶e u偶ywa funkcji [**runtime.sendMessage()**](https://developer.chrome.com/docs/extensions/reference/runtime#method-sendMessage) **lub** [**tabs.sendMessage()**](https://developer.chrome.com/docs/extensions/reference/tabs#method-sendMessage) do wysyania **jednorazowej wiadomoci w formacie JSON**.

Aby obsu偶y **odpowied藕**, u偶yj zwr贸conego **Promise**. Chocia偶, dla zachowania zgodnoci wstecznej, nadal mo偶esz przekaza **callback** jako ostatni argument.

Wysyanie 偶dania z **skryptu treci** wyglda tak:
```javascript
(async () => {
const response = await chrome.runtime.sendMessage({greeting: "hello"});
// do something with response here, not outside the function
console.log(response);
})();
```
Wysyanie 偶dania z **rozszerzenia** (zwykle **skryptu w tle**). Przykad, jak wysa wiadomo do skryptu treci w wybranej karcie:
```javascript
// From https://stackoverflow.com/questions/36153999/how-to-send-a-message-between-chrome-extension-popup-and-content-script
(async () => {
const [tab] = await chrome.tabs.query({active: true, lastFocusedWindow: true});
const response = await chrome.tabs.sendMessage(tab.id, {greeting: "hello"});
// do something with response here, not outside the function
console.log(response);
})();
```
Na **odbiorze** musisz ustawi [**runtime.onMessage**](https://developer.chrome.com/docs/extensions/reference/runtime#event-onMessage) **nasuchiwacz zdarze**, aby obsu偶y wiadomo. Wyglda to tak samo z poziomu skryptu treci lub strony rozszerzenia.
```javascript
// From https://stackoverflow.com/questions/70406787/javascript-send-message-from-content-js-to-background-js
chrome.runtime.onMessage.addListener(
function(request, sender, sendResponse) {
console.log(sender.tab ?
"from a content script:" + sender.tab.url :
"from the extension");
if (request.greeting === "hello")
sendResponse({farewell: "goodbye"});
}
);
```
W wyr贸偶nionym przykadzie, **`sendResponse()`** zosta wykonany w spos贸b synchroniczny. Aby zmodyfikowa obsug zdarzenia `onMessage` do asynchronicznego wykonania `sendResponse()`, konieczne jest dodanie `return true;`.

Wa偶nym rozwa偶aniem jest to, 偶e w scenariuszach, w kt贸rych wiele stron jest ustawionych do odbierania zdarze `onMessage`, **pierwsza strona, kt贸ra wykona `sendResponse()`** dla konkretnego zdarzenia, bdzie jedyn, kt贸ra skutecznie dostarczy odpowied藕. Jakiekolwiek kolejne odpowiedzi na to samo zdarzenie nie bd brane pod uwag.

Podczas tworzenia nowych rozszerze preferencje powinny by skierowane ku obietnicom zamiast do wywoa zwrotnych. W odniesieniu do u偶ycia wywoa zwrotnych, funkcja `sendResponse()` jest uznawana za wa偶n tylko wtedy, gdy jest wykonywana bezporednio w kontekcie synchronicznym lub jeli obsuga zdarzenia wskazuje na operacj asynchroniczn, zwracajc `true`. Jeli 偶aden z handler贸w nie zwr贸ci `true` lub jeli funkcja `sendResponse()` zostanie usunita z pamici (zbierana przez garbage collector), wywoanie zwrotne zwizane z funkcj `sendMessage()` zostanie wywoane domylnie.

## Wra偶liwe informacje w pamici/kodzie/clipboard

Jeli Rozszerzenie Przegldarki przechowuje **wra偶liwe informacje w swojej pamici**, mog one by **zrzucane** (szczeg贸lnie na maszynach z systemem Windows) i **przeszukiwane** w poszukiwaniu tych informacji.

Dlatego pami Rozszerzenia Przegldarki **nie powinna by uwa偶ana za bezpieczn** i **wra偶liwe informacje** takie jak dane logowania czy frazy mnemoniczne **nie powinny by przechowywane**.

Oczywicie, **nie umieszczaj wra偶liwych informacji w kodzie**, poniewa偶 bd one **publiczne**.

Aby zrzuci pami z przegldarki, mo偶esz **zrzuci pami procesu** lub przej do **ustawie** rozszerzenia przegldarki, klikajc **`Inspect pop-up`** -> W sekcji **`Memory`** -> **`Take a snapshot`** i **`CTRL+F`** aby przeszuka zrzut w poszukiwaniu wra偶liwych informacji.

Ponadto, wysoce wra偶liwe informacje, takie jak klucze mnemoniczne czy hasa, **nie powinny mie mo偶liwoci kopiowania do schowka** (lub przynajmniej powinny by usuwane ze schowka w cigu kilku sekund), poniewa偶 wtedy procesy monitorujce schowek bd mogy je uzyska.

## adowanie rozszerzenia w przegldarce

1. **Pobierz** Rozszerzenie Przegldarki i rozpakuj
2. Przejd藕 do **`chrome://extensions/`** i **wcz** `Tryb dewelopera`
3. Kliknij przycisk **`Zaaduj rozpakowane`**

W **Firefoxie** przejd藕 do **`about:debugging#/runtime/this-firefox`** i kliknij przycisk **`Zaaduj tymczasowy dodatek`**.

## Uzyskiwanie kodu 藕r贸dowego ze sklepu

Kod 藕r贸dowy rozszerzenia Chrome mo偶na uzyska na r贸偶ne sposoby. Poni偶ej znajduj si szczeg贸owe wyjanienia i instrukcje dla ka偶dej opcji.

### Pobierz rozszerzenie jako ZIP za pomoc wiersza polece

Kod 藕r贸dowy rozszerzenia Chrome mo偶na pobra jako plik ZIP za pomoc wiersza polece. Wymaga to u偶ycia `curl` do pobrania pliku ZIP z okrelonego adresu URL, a nastpnie wyodrbnienia zawartoci pliku ZIP do katalogu. Oto kroki:

1. Zastp `"extension_id"` rzeczywistym ID rozszerzenia.
2. Wykonaj nastpujce polecenia:
```bash
extension_id=your_extension_id   # Replace with the actual extension ID
curl -L -o "$extension_id.zip" "https://clients2.google.com/service/update2/crx?response=redirect&os=mac&arch=x86-64&nacl_arch=x86-64&prod=chromecrx&prodchannel=stable&prodversion=44.0.2403.130&x=id%3D$extension_id%26uc"
unzip -d "$extension_id-source" "$extension_id.zip"
```
### U偶yj strony CRX Viewer

[https://robwu.nl/crxviewer/](https://robwu.nl/crxviewer/)

### U偶yj rozszerzenia CRX Viewer

Inn wygodn metod jest u偶ycie Chrome Extension Source Viewer, kt贸ry jest projektem open-source. Mo偶na go zainstalowa z [Chrome Web Store](https://chrome.google.com/webstore/detail/chrome-extension-source-v/jifpbeccnghkjeaalbbjmodiffmgedin?hl=en). Kod 藕r贸dowy widoku jest dostpny w jego [repozytorium GitHub](https://github.com/Rob--W/crxviewer).

### Wywietl 藕r贸do lokalnie zainstalowanego rozszerzenia

Rozszerzenia Chrome zainstalowane lokalnie mo偶na r贸wnie偶 sprawdzi. Oto jak:

1. Uzyskaj dostp do lokalnego katalogu profilu Chrome, odwiedzajc `chrome://version/` i lokalizujc pole "Profile Path".
2. Przejd藕 do podfolderu `Extensions/` w katalogu profilu.
3. Ten folder zawiera wszystkie zainstalowane rozszerzenia, zazwyczaj z ich kodem 藕r贸dowym w czytelnym formacie.

Aby zidentyfikowa rozszerzenia, mo偶esz powiza ich identyfikatory z nazwami:

* Wcz tryb dewelopera na stronie `about:extensions`, aby zobaczy identyfikatory ka偶dego rozszerzenia.
* W folderze ka偶dego rozszerzenia plik `manifest.json` zawiera czytelne pole `name`, co pomaga w identyfikacji rozszerzenia.

### U偶yj archiwizera plik贸w lub dekompresora

Przejd藕 do Chrome Web Store i pobierz rozszerzenie. Plik bdzie mia rozszerzenie `.crx`. Zmie rozszerzenie pliku z `.crx` na `.zip`. U偶yj dowolnego archiwizera plik贸w (takiego jak WinRAR, 7-Zip itp.), aby wyodrbni zawarto pliku ZIP.

### U偶yj trybu dewelopera w Chrome

Otw贸rz Chrome i przejd藕 do `chrome://extensions/`. Wcz "Tryb dewelopera" w prawym g贸rnym rogu. Kliknij "Zaaduj rozpakowane rozszerzenie...". Przejd藕 do katalogu swojego rozszerzenia. To nie pobiera kodu 藕r贸dowego, ale jest przydatne do przegldania i modyfikowania kodu ju偶 pobranego lub opracowanego rozszerzenia.

## Lista kontrolna audytu bezpieczestwa

Chocia偶 rozszerzenia przegldarki maj **ograniczon powierzchni ataku**, niekt贸re z nich mog zawiera **luki** lub **potencjalne poprawki wzmocnienia**. Oto najczstsze z nich:

* [ ] **Ogranicz** tak bardzo, jak to mo偶liwe, 偶dane **`permissions`**
* [ ] **Ogranicz** tak bardzo, jak to mo偶liwe **`host_permissions`**
* [ ] U偶yj **silnej** **`content_security_policy`**
* [ ] **Ogranicz** tak bardzo, jak to mo偶liwe **`externally_connectable`**, jeli nie jest potrzebne i mo偶liwe, nie zostawiaj go domylnie, okrel **`{}`**
* [ ] Jeli **URL podatny na XSS lub przejcie** jest tutaj wymieniony, atakujcy bdzie m贸g **wysya wiadomoci do skrypt贸w w tle bezporednio**. Bardzo pot偶ne obejcie.
* [ ] **Ogranicz** tak bardzo, jak to mo偶liwe **`web_accessible_resources`**, nawet puste, jeli to mo偶liwe.
* [ ] Jeli **`web_accessible_resources`** nie jest puste, sprawd藕 [**ClickJacking**](browext-clickjacking.md)
* [ ] Jeli jakakolwiek **komunikacja** zachodzi z **rozszerzenia** do **strony internetowej**, [**sprawd藕 XSS**](browext-xss-example.md) **luki** spowodowane w komunikacji.
* [ ] Jeli u偶ywane s Post Messages, sprawd藕 [**luki w Post Message**](../postmessage-vulnerabilities/)**.**
* [ ] Jeli **Content Script ma dostp do szczeg贸贸w DOM**, sprawd藕, czy **nie wprowadza XSS**, jeli zostanie **zmodyfikowany** przez stron internetow.
* [ ] Zwr贸 szczeg贸ln uwag, jeli ta komunikacja jest r贸wnie偶 zaanga偶owana w **komunikacj Content Script -> Background script**
* [ ] **Wra偶liwe informacje nie powinny by przechowywane** wewntrz kodu rozszerzenia przegldarki
* [ ] **Wra偶liwe informacje nie powinny by przechowywane** w pamici rozszerzenia przegldarki

## Narzdzia

### [**Tarnish**](https://thehackerblog.com/tarnish/)

* Pobiera dowolne rozszerzenie Chrome z podanego linku do Chrome Webstore.
* [**manifest.json**](https://developer.chrome.com/extensions/manifest) **widok**: po prostu wywietla wersj JSON w formacie prettified manifestu rozszerzenia.
* **Analiza odcisk贸w palc贸w**: Wykrywanie [web\_accessible\_resources](https://developer.chrome.com/extensions/manifest/web\_accessible\_resources) i automatyczne generowanie JavaScript do odcisk贸w palc贸w rozszerzenia Chrome.
* **Potencjalna analiza Clickjacking**: Wykrywanie stron HTML rozszerzenia z ustawion dyrektyw [web\_accessible\_resources](https://developer.chrome.com/extensions/manifest/web\_accessible\_resources). Mog by potencjalnie podatne na clickjacking w zale偶noci od celu stron.
* **Widok ostrze偶e o uprawnieniach**: kt贸ry pokazuje list wszystkich ostrze偶e o uprawnieniach Chrome, kt贸re bd wywietlane, gdy u偶ytkownik spr贸buje zainstalowa rozszerzenie.
* **Niebezpieczna funkcja**: pokazuje lokalizacj niebezpiecznych funkcji, kt贸re mog by potencjalnie wykorzystywane przez atakujcego (np. funkcje takie jak innerHTML, chrome.tabs.executeScript).
* **Punkty wejcia**: pokazuje, gdzie rozszerzenie przyjmuje dane wejciowe od u偶ytkownika/zewntrzne. To jest przydatne do zrozumienia powierzchni rozszerzenia i szukania potencjalnych punkt贸w do wysyania zoliwie skonstruowanych danych do rozszerzenia.
* Zar贸wno skanery Niebezpiecznych Funkcji, jak i Punkt贸w Wejcia maj nastpujce dla swoich wygenerowanych alert贸w:
* Odpowiedni fragment kodu i linia, kt贸ra spowodowaa alert.
* Opis problemu.
* Przycisk "Zobacz plik", aby zobaczy peny plik 藕r贸dowy zawierajcy kod.
* cie偶ka alertowanego pliku.
* Peny URI rozszerzenia Chrome alertowanego pliku.
* Typ pliku, taki jak skrypt strony w tle, skrypt treci, akcja przegldarki itp.
* Jeli podatna linia znajduje si w pliku JavaScript, cie偶ki wszystkich stron, na kt贸rych jest zawarta, a tak偶e typ tych stron oraz status [web\_accessible\_resource](https://developer.chrome.com/extensions/manifest/web\_accessible\_resources).
* **Analizator polityki bezpieczestwa treci (CSP) i sprawdzacz obej**: Wska偶e saboci w CSP twojego rozszerzenia i r贸wnie偶 owietli wszelkie potencjalne sposoby obejcia twojego CSP z powodu biaych list CDN itp.
* **Znane podatne biblioteki**: U偶ywa [Retire.js](https://retirejs.github.io/retire.js/), aby sprawdzi, czy u偶ywane s znane podatne biblioteki JavaScript.
* Pobierz rozszerzenie i sformatowane wersje.
* Pobierz oryginalne rozszerzenie.
* Pobierz wersj rozszerzenia w formacie beautified (automatycznie sformatowany HTML i JavaScript).
* Automatyczne buforowanie wynik贸w skanowania, uruchomienie skanowania rozszerzenia zajmie sporo czasu przy pierwszym uruchomieniu. Jednak przy drugim uruchomieniu, zakadajc, 偶e rozszerzenie nie zostao zaktualizowane, bdzie prawie natychmiastowe dziki buforowanym wynikom.
* Linkowalne adresy URL raport贸w, atwo linkuj kogo do raportu rozszerzenia wygenerowanego przez tarnish.

### [Neto](https://github.com/elevenpaths/neto)

Projekt Neto to pakiet Pythona 3 stworzony do analizy i odkrywania ukrytych funkcji wtyczek i rozszerze przegldarek dla znanych przegldarek, takich jak Firefox i Chrome. Automatyzuje proces rozpakowywania spakowanych plik贸w, aby wyodrbni te funkcje z odpowiednich zasob贸w w rozszerzeniu, takich jak `manifest.json`, foldery lokalizacyjne lub pliki 藕r贸dowe JavaScript i HTML.

## Odniesienia

* **Dziki** [**@naivenom**](https://twitter.com/naivenom) **za pomoc w tej metodologii**
* [https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing](https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing)
* [https://palant.info/2022/08/10/anatomy-of-a-basic-extension/](https://palant.info/2022/08/10/anatomy-of-a-basic-extension/)
* [https://palant.info/2022/08/24/attack-surface-of-extension-pages/](https://palant.info/2022/08/24/attack-surface-of-extension-pages/)
* [https://palant.info/2022/08/31/when-extension-pages-are-web-accessible/](https://palant.info/2022/08/31/when-extension-pages-are-web-accessible/)
* [https://help.passbolt.com/assets/files/PBL-02-report.pdf](https://help.passbolt.com/assets/files/PBL-02-report.pdf)
* [https://developer.chrome.com/docs/extensions/develop/concepts/content-scripts](https://developer.chrome.com/docs/extensions/develop/concepts/content-scripts)
* [https://developer.chrome.com/docs/extensions/mv2/background-pages](https://developer.chrome.com/docs/extensions/mv2/background-pages)
* [https://thehackerblog.com/kicking-the-rims-a-guide-for-securely-writing-and-auditing-chrome-extensions/](https://thehackerblog.com/kicking-the-rims-a-guide-for-securely-writing-and-auditing-chrome-extensions/)
* [https://gist.github.com/LongJohnCoder/9ddf5735df3a4f2e9559665fb864eac0](https://gist.github.com/LongJohnCoder/9ddf5735df3a4f2e9559665fb864eac0)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si sztuczkami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
