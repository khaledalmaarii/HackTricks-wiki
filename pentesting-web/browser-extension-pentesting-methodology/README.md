# Metodologia testowania penetracyjnego rozszerze przegldarki

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Podstawowe informacje

Rozszerzenia przegldarki s napisane w jzyku JavaScript i s adowane przez przegldark w tle. Posiadaj sw贸j [DOM](https://www.w3schools.com/js/js\_htmldom.asp), ale mog wsp贸dziaa z DOM innego serwisu. Oznacza to, 偶e mog narusza poufno, integralno i dostpno (CIA) innych serwis贸w.

## G贸wne komponenty

Wygld rozszerzenia prezentuje si najlepiej, gdy jest wizualizowany i skada si z trzech komponent贸w. Przyjrzyjmy si ka偶demu z nich dokadniej.

<figure><img src="../../.gitbook/assets/image (4).png" alt=""><figcaption><p><a href="http://webblaze.cs.berkeley.edu/papers/Extensions.pdf">http://webblaze.cs.berkeley.edu/papers/Extensions.pdf</a></p></figcaption></figure>

### **Skrypty treci**

Ka偶dy skrypt treci ma bezporedni dostp do DOM **jednej strony internetowej** i jest tym samym nara偶ony na **potencjalnie zoliwe dane wejciowe**. Jednak skrypt treci nie posiada 偶adnych uprawnie poza mo偶liwoci wysyania wiadomoci do rdzenia rozszerzenia.

### **Rdze rozszerzenia**

Rdze rozszerzenia zawiera wikszo uprawnie/dostp贸w rozszerzenia, ale rdze rozszerzenia mo偶e jedynie wsp贸dziaa z treci internetow za pomoc [XMLHttpRequest](https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest) i skrypt贸w treci. Ponadto, rdze rozszerzenia nie ma bezporedniego dostpu do maszyny hosta.

### **Binarny plik natywny**

Rozszerzenie umo偶liwia u偶ycie binarnego pliku natywnego, kt贸ry mo偶e **uzyska dostp do maszyny hosta z penymi uprawnieniami u偶ytkownika**. Binarny plik natywny wsp贸dziaa z rdzeniem rozszerzenia za pomoc standardowego interfejsu programowania aplikacji Netscape Plugin ([NPAPI](https://en.wikipedia.org/wiki/NPAPI)), u偶ywanego przez Flash i inne wtyczki przegldarkowe.

### Granice

{% hint style="danger" %}
Aby uzyska pene uprawnienia u偶ytkownika, atakujcy musi przekona rozszerzenie do przekazywania zoliwych danych wejciowych ze skryptu treci do rdzenia rozszerzenia oraz z rdzenia rozszerzenia do binarnego pliku natywnego.
{% endhint %}

Ka偶dy komponent rozszerzenia jest odseparowany od siebie za pomoc **silnych granic ochronnych**. Ka偶dy komponent dziaa w **oddzielnym procesie systemu operacyjnego**. Skrypty treci i rdzenie rozszerze dziaaj w **procesach piaskownicy**, niedostpnych dla wikszoci usug systemu operacyjnego.

Ponadto, skrypty treci oddzielone s od powizanych z nimi stron internetowych przez **dziaanie w oddzielnej stercie JavaScript**. Skrypt treci i strona internetowa maj **dostp do tego samego DOM**, ale **nigdy nie wymieniaj wska藕nik贸w JavaScript**, co zapobiega wyciekom funkcjonalnoci JavaScript. 

## **`manifest.json`**

Rozszerzenie Chrome to po prostu folder ZIP z rozszerzeniem [.crx](https://www.lifewire.com/crx-file-2620391). G贸wnym komponentem rozszerzenia jest plik **`manifest.json`** znajdujcy si w g贸wnym katalogu folderu, kt贸ry okrela ukad, uprawnienia i inne opcje konfiguracyjne.

Przykad:
```json
{
"manifest_version": 2,
"name": "My extension",
"version": "1.0",
"permissions": [
"storage"
],
"content_scripts": [
{
"js": [
"script.js"
],
"matches": [
"https://example.com/*",
"https://www.example.com/*"
],
"exclude_matches": ["*://*/*business*"],
}
],
"background": {
"scripts": [
"background.js"
]
},
"options_ui": {
"page": "options.html"
}
}
```
### `content_scripts`

Skrypty zawartoci s **adowane** za ka偶dym razem, gdy u偶ytkownik **przechodzi do pasujcej strony**, w naszym przypadku do dowolnej strony pasujcej do wyra偶enia **`https://example.com/*`** i nie pasujcej do wyra偶enia regularnego **`*://*/*/business*`**. Wykonuj si **jak wasne skrypty strony** i maj dowolny dostp do [Modelu Obiektowego Dokumentu (DOM)](https://developer.mozilla.org/en-US/docs/Web/API/Document\_Object\_Model) strony.
```json
"content_scripts": [
{
"js": [
"script.js"
],
"matches": [
"https://example.com/*",
"https://www.example.com/*"
],
"exclude_matches": ["*://*/*business*"],
}
],
```
Aby uwzgldni lub wykluczy wicej adres贸w URL, mo偶na r贸wnie偶 u偶y **`include_globs`** i **`exclude_globs`**.

Oto przykadowy skrypt zawartoci, kt贸ry doda przycisk "Wyjanij" na stronie, korzystajc z [interfejsu API przechowywania](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/storage) do pobrania wartoci `message` z pamici podrcznej rozszerzenia.
```js
chrome.storage.local.get("message", result =>
{
let div = document.createElement("div");
div.innerHTML = result.message + " <button>Explain</button>";
div.querySelector("button").addEventListener("click", () =>
{
chrome.runtime.sendMessage("explain");
});
document.body.appendChild(div);
});
```
<figure><img src="../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

Wiadomo jest wysyana do stron rozszerzenia przez skrypt zawartoci, gdy ten przycisk jest kliknity, poprzez wykorzystanie [**API runtime.sendMessage()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/runtime/sendMessage). Wynika to z ogranicze skryptu zawartoci w bezporednim dostpie do interfejs贸w API, z wyjtkiem `storage`, kt贸ry jest jednym z niewielu wyjtk贸w. Dla funkcji poza tymi wyjtkami, wiadomoci s wysyane do stron rozszerzenia, z kt贸rymi skrypty zawartoci mog si komunikowa.

{% hint style="warning" %}
W zale偶noci od przegldarki, mo偶liwoci skryptu zawartoci mog si nieznacznie r贸偶ni. Dla przegldarek opartych na Chromium, lista mo偶liwoci jest dostpna w [dokumentacji Chrome Developers](https://developer.chrome.com/docs/extensions/mv3/content_scripts/#capabilities), a dla przegldarki Firefox, [MDN](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/Content_scripts#webextension_apis) jest g贸wnym 藕r贸dem informacji.\
Warto r贸wnie偶 zauwa偶y, 偶e skrypty zawartoci maj mo偶liwo komunikacji z skryptami ta, co pozwala im wykonywa dziaania i przekazywa odpowiedzi.
{% endhint %}

Aby wywietli i debugowa skrypty zawartoci w Chrome, mo偶na uzyska dostp do menu narzdzi deweloperskich Chrome, przechodzc do Opcje > Wicej narzdzi > Narzdzia dla deweloper贸w LUB naciskajc Ctrl + Shift + I.

Po wywietleniu narzdzi deweloperskich nale偶y klikn zakadk **Source**, a nastpnie zakadk **Content Scripts**. Pozwala to na obserwacj dziaajcych skrypt贸w zawartoci z r贸偶nych rozszerze oraz ustawianie punkt贸w przerwania w celu ledzenia przepywu wykonania.

### Wstrzykiwane skrypty zawartoci

{% hint style="success" %}
Nale偶y zauwa偶y, 偶e **skrypty zawartoci nie s obowizkowe**, poniewa偶 mo偶liwe jest r贸wnie偶 **dynamiczne wstrzykiwanie** skrypt贸w i **programowe wstrzykiwanie** ich na strony internetowe za pomoc **`tabs.executeScript`**. Zapewnia to wiksz **kontrol szczeg贸ow**.
{% endhint %}

Aby programowo wstrzykn skrypt zawartoci, rozszerzenie musi mie [uprawnienia hosta](https://developer.chrome.com/docs/extensions/reference/permissions) dla strony, do kt贸rej maj by wstrzykiwane skrypty. Uprawnienia te mo偶na zabezpieczy poprzez **偶danie ich** w manifecie rozszerzenia lub tymczasowo za pomoc [**activeTab**](https://developer.chrome.com/docs/extensions/reference/manifest/activeTab).

#### Przykad rozszerzenia opartego na activeTab

{% code title="manifest.json" %}
```json
{
"name": "My extension",
...
"permissions": [
"activeTab",
"scripting"
],
"background": {
"service_worker": "background.js"
},
"action": {
"default_title": "Action Button"
}
}
```
{% endcode %}

* **Wstrzyknicie pliku JS po klikniciu:**
```javascript
// content-script.js
document.body.style.backgroundColor = "orange";

//service-worker.js - Inject the JS file
chrome.action.onClicked.addListener((tab) => {
chrome.scripting.executeScript({
target: { tabId: tab.id },
files: ["content-script.js"]
});
});
```
* **Wstrzyknicie funkcji** po klikniciu:
```javascript
//service-worker.js - Inject a function
function injectedFunction() {
document.body.style.backgroundColor = "orange";
}

chrome.action.onClicked.addListener((tab) => {
chrome.scripting.executeScript({
target : {tabId : tab.id},
func : injectedFunction,
});
});
```
#### Przykad z uprawnieniami skryptowymi

In some cases, browser extensions may have scripting permissions that allow them to execute arbitrary code on web pages. This can be a potential security risk as malicious extensions can abuse these permissions to perform unauthorized actions.

W niekt贸rych przypadkach rozszerzenia przegldarki mog mie uprawnienia skryptowe, kt贸re pozwalaj im wykonywa dowolny kod na stronach internetowych. Mo偶e to stanowi potencjalne zagro偶enie dla bezpieczestwa, poniewa偶 zoliwe rozszerzenia mog wykorzysta te uprawnienia do wykonania nieautoryzowanych dziaa.

To identify if a browser extension has scripting permissions, you can inspect its manifest file. Look for the "permissions" field and check if it includes the "scripting" permission.

Aby sprawdzi, czy rozszerzenie przegldarki ma uprawnienia skryptowe, mo偶na sprawdzi plik manifestu. Szukaj pola "permissions" i sprawd藕, czy zawiera uprawnienie "scripting".

If the extension has scripting permissions, you can analyze its source code to understand how it interacts with web pages. Look for functions or event listeners that are executed on specific events, such as page load or button clicks.

Jeli rozszerzenie ma uprawnienia skryptowe, mo偶na przeanalizowa jego kod 藕r贸dowy, aby zrozumie, jak wsp贸dziaa z stronami internetowymi. Szukaj funkcji lub nasuchiwaczy zdarze, kt贸re s wykonywane w okrelonych momentach, takich jak zaadowanie strony lub kliknicie przycisku.

Once you have identified the code responsible for executing on web pages, you can analyze its functionality and look for any potential security vulnerabilities. Pay attention to how the extension interacts with user input and external resources.

Po zidentyfikowaniu kodu odpowiedzialnego za wykonanie na stronach internetowych, mo偶na przeanalizowa jego funkcjonalno i szuka potencjalnych podatnoci bezpieczestwa. Zwr贸 uwag na to, w jaki spos贸b rozszerzenie wsp贸dziaa z danymi wprowadzanymi przez u偶ytkownika i zewntrznymi zasobami.

It is also important to review the permissions requested by the extension. If the extension requests excessive permissions that are not necessary for its intended functionality, it may indicate a potential security risk.

Wa偶ne jest r贸wnie偶 przejrzenie 偶danych uprawnie przez rozszerzenie. Jeli rozszerzenie 偶da nadmiernych uprawnie, kt贸re nie s niezbdne do jego zamierzonej funkcjonalnoci, mo偶e to wskazywa na potencjalne zagro偶enie dla bezpieczestwa.

Regularly updating and reviewing the browser extensions installed on your system is crucial to ensure that you are not exposed to any security risks. Remove any unnecessary or suspicious extensions and only install those from trusted sources.

Regularne aktualizowanie i przegldanie zainstalowanych rozszerze przegldarki na Twoim systemie jest kluczowe, aby upewni si, 偶e nie jeste nara偶ony na 偶adne zagro偶enia dla bezpieczestwa. Usu wszelkie niepotrzebne lub podejrzane rozszerzenia i instaluj tylko te pochodzce z zaufanych 藕r贸de.
```javascript
// service-workser.js
chrome.scripting.registerContentScripts([{
id : "test",
matches : [ "https://*.example.com/*" ],
excludeMatches : [ "*://*/*business*" ],
js : [ "contentScript.js" ],
}]);

// Another example
chrome.tabs.executeScript(tabId, { file: "content_script.js" });
```
Aby uwzgldni lub wykluczy wicej adres贸w URL, mo偶na r贸wnie偶 u偶y **`include_globs`** i **`exclude_globs`**.

### Skrypty zawartoci `run_at`

Pole `run_at` kontroluje **kiedy pliki JavaScript s wstrzykiwane do strony internetowej**. Preferowana i domylna warto to `"document_idle"`.

Mo偶liwe wartoci to:

* **`document_idle`**: Kiedykolwiek to mo偶liwe
* **`document_start`**: Po plikach `css`, ale przed konstrukcj jakiegokolwiek innego DOM-u lub uruchomieniem jakiegokolwiek innego skryptu.
* **`document_end`**: Bezporednio po zakoczeniu konstrukcji DOM-u, ale przed zaadowaniem zasob贸w podrzdnych, takich jak obrazy i ramki.

#### Przez `manifest.json`
```json
{
"name": "My extension",
...
"content_scripts": [
{
"matches": ["https://*.example.com/*"],
"run_at": "document_idle",
"js": ["contentScript.js"]
}
],
...
}

```
Poprzez **`service-worker.js`**
```javascript
chrome.scripting.registerContentScripts([{
id : "test",
matches : [ "https://*.example.com/*" ],
runAt : "document_idle",
js : [ "contentScript.js" ],
}]);
```
### `to`

Wiadomoci wysyane przez skrypty zawartoci s odbierane przez **stron ta**, kt贸ra peni centraln rol w koordynacji komponent贸w rozszerzenia. Strona ta dziaa niezauwa偶alnie i bezporedniej interakcji u偶ytkownika, a tak偶e posiada wasny Model Obiektowy Dokumentu (DOM), umo偶liwiajcy kompleksowe interakcje i zarzdzanie stanem.

**Kluczowe punkty**:

- **Rola strony ta:** Peni funkcj centrum nerwowego rozszerzenia, zapewniajc komunikacj i koordynacj midzy r贸偶nymi czciami rozszerzenia.
- **Trwao:** Jest obecna przez cay czas istnienia rozszerzenia, niewidoczna dla u偶ytkownika, ale integralna dla funkcjonalnoci rozszerzenia.
- **Automatyczne generowanie:** Jeli nie jest jawnie zdefiniowana, przegldarka automatycznie utworzy stron ta. Ta automatycznie wygenerowana strona bdzie zawiera wszystkie skrypty ta okrelone w manifecie rozszerzenia, zapewniajc bezproblemowe dziaanie zada ta rozszerzenia.

{% hint style="success" %}
Wygodne automatyczne generowanie strony ta przez przegldark (jeli nie jest jawnie zadeklarowane) zapewnia, 偶e wszystkie niezbdne skrypty ta s zintegrowane i dziaajce, usprawniajc proces konfiguracji rozszerzenia.
{% endhint %}

Przykadowy skrypt ta:
```js
chrome.runtime.onMessage.addListener((request, sender, sendResponse) =>
{
if (request == "explain")
{
chrome.tabs.create({ url: "https://example.net/explanation" });
}
})
```
Wykorzystuje [API runtime.onMessage](https://developer.mozilla.org/pl/docs/Mozilla/Add-ons/WebExtensions/API/runtime/onMessage) do nasuchiwania wiadomoci. Gdy otrzyma wiadomo "explain", u偶ywa [API tabs](https://developer.mozilla.org/pl/docs/Mozilla/Add-ons/WebExtensions/API/tabs) do otwarcia strony w nowej karcie.

Aby debugowa skrypt ta, mo偶esz przej do **szczeg贸贸w rozszerzenia i sprawdzi serwis workera**, co spowoduje otwarcie narzdzi developerskich z skryptem ta:

<figure><img src="broken-reference" alt=""><figcaption></figcaption></figure>

### Strony opcji i inne

Rozszerzenia przegldarki mog zawiera r贸偶ne rodzaje stron:

* **Strony akcji** s wywietlane w **rozwijanym menu po klikniciu na ikon rozszerzenia**.
* Strony, kt贸re rozszerzenie **zaaduje w nowej karcie**.
* **Strony opcji**: Ta strona wywietla si na g贸rze rozszerzenia po klikniciu. W poprzednim manifecie w moim przypadku mogem uzyska dostp do tej strony pod adresem `chrome://extensions/?options=fadlhnelkbeojnebcbkacjilhnbjfjca` lub klikajc:

<figure><img src="../../.gitbook/assets/image (8).png" alt="" width="375"><figcaption></figcaption></figure>

Nale偶y zauwa偶y, 偶e te strony nie s trwae, tak jak strony ta, poniewa偶 dynamicznie adowane s tylko w razie potrzeby. Mimo to, maj pewne mo偶liwoci wsp贸lne z stron ta:

- **Komunikacja z skryptami zawartoci:** Podobnie jak strona ta, te strony mog otrzymywa wiadomoci od skrypt贸w zawartoci, uatwiajc interakcj w obrbie rozszerzenia.
- **Dostp do specyficznych dla rozszerzenia API:** Te strony maj peny dostp do specyficznych dla rozszerzenia API, zgodnie z uprawnieniami zdefiniowanymi dla rozszerzenia.

### `permissions` i `host_permissions`

**`permissions`** i **`host_permissions`** to wpisy w pliku `manifest.json`, kt贸re wskazuj, jakie uprawnienia ma rozszerzenie przegldarki (np. dostp do pamici, lokalizacji...) i na jakich stronach internetowych.

Poniewa偶 rozszerzenia przegldarki mog by tak **uprzywilejowane**, zoliwe lub skompromitowane rozszerzenie mo偶e umo偶liwi atakujcemu r贸偶ne sposoby kradzie偶y poufnych informacji i szpiegowania u偶ytkownika.

Sprawd藕, jak dziaaj te ustawienia i jak mog by nadu偶ywane w:

{% content-ref url="browext-permissions-and-host_permissions.md" %}
[browext-permissions-and-host\_permissions.md](browext-permissions-and-host\_permissions.md)
{% endcontent-ref %}

### `content_security_policy`

Polityka bezpieczestwa zawartoci mo偶e by r贸wnie偶 zadeklarowana w pliku `manifest.json`. Jeli jest zdefiniowana, mo偶e by **podatna**.

Domylne ustawienie dla stron rozszerzenia przegldarki jest do restrykcyjne:
```bash
script-src 'self'; object-src 'self';
```
Aby uzyska wicej informacji na temat CSP i potencjalnych sposob贸w obejcia, sprawd藕:

{% content-ref url="../content-security-policy-csp-bypass/" %}
[content-security-policy-csp-bypass](../content-security-policy-csp-bypass/)
{% endcontent-ref %}

### `web_accessible_resources`

Aby strona internetowa moga uzyska dostp do strony rozszerzenia przegldarki, na przykad do pliku `.html`, ta strona musi by wymieniona w polu **`web_accessible_resources`** w pliku `manifest.json`.\
Na przykad:
```javascript
{
...
"web_accessible_resources": [
{
"resources": [ "images/*.png" ],
"matches": [ "https://example.com/*" ]
},
{
"resources": [ "fonts/*.woff" ],
"matches": [ "https://example.com/*" ]
}
],
...
}
```
Te strony s dostpne pod adresem URL, takim jak:
```
chrome-extension://<extension-id>/message.html
```
W publicznych rozszerzeniach **identyfikator rozszerzenia jest dostpny**:

<figure><img src="../../.gitbook/assets/image (722).png" alt="" width="375"><figcaption></figcaption></figure>

Jednak偶e, jeli u偶ywany jest parametr `use_dynamic_url` w pliku `manifest.json`, to **ten identyfikator mo偶e by dynamiczny**.

Dostp do tych stron mo偶e sprawi, 偶e s one **potencjalnie podatne na ataki ClickJacking**:

{% content-ref url="browext-clickjacking.md" %}
[browext-clickjacking.md](browext-clickjacking.md)
{% endcontent-ref %}

{% hint style="success" %}
Ograniczenie adowania tych stron tylko przez rozszerzenie, a nie przez losowe adresy URL, mo偶e zapobiec atakom ClickJacking.
{% endhint %}

### `externally_connectable`

Zgodnie z [**dokumentacj**](https://developer.chrome.com/docs/extensions/reference/manifest/externally-connectable), waciwo manifestu `"externally_connectable"` deklaruje, **kt贸re rozszerzenia i strony internetowe mog si poczy** z Twoim rozszerzeniem za pomoc [runtime.connect](https://developer.chrome.com/docs/extensions/reference/runtime#method-connect) i [runtime.sendMessage](https://developer.chrome.com/docs/extensions/reference/runtime#method-sendMessage).

* Jeli klucz **`externally_connectable`** nie jest zadeklarowany w manifestie Twojego rozszerzenia lub jest zadeklarowany jako **`"ids": ["*"]`**, **wszystkie rozszerzenia mog si poczy, ale 偶adne strony internetowe nie mog**.
* Jeli s okrelone **konkretne identyfikatory**, jak w `"ids": ["aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"]`, **tylko te aplikacje** mog si poczy.
* Jeli s okrelone **dopasowania**, te aplikacje internetowe bd mogy si poczy:
```json
"matches": [
"https://*.google.com/*",
"*://*.chromium.org/*",
```
* Jeli jest okrelone jako puste: **`"externally_connectable": {}`**, 偶adna aplikacja ani strona internetowa nie bdzie moga si poczy.

Im **mniej rozszerze i adres贸w URL** tutaj wskazanych, tym **mniejsza powierzchnia ataku**.

{% hint style="danger" %}
Jeli na stronie internetowej podatnej na XSS lub przejcie jest wskazane **`externally_connectable`**, atakujcy bdzie m贸g **wysya wiadomoci bezporednio do skryptu w tle**, cakowicie omijajc Skrypt Zawartoci i jego CSP.

Jest to wic **bardzo pot偶ne obejcie**.
{% endhint %}

## Komunikacja midzy stron internetow **锔** Skryptem Zawartoci

rodowiska, w kt贸rych dziaaj **skrypty zawartoci** i w kt贸rych istniej strony hosta, s od siebie **oddzielone**, zapewniajc **izolacj**. Pomimo tej izolacji, oba maj mo偶liwo interakcji z **Model Obiektowy Dokumentu (DOM)** strony, kt贸ry jest wsp贸lnym zasobem. Aby strona hosta moga komunikowa si ze **skryptem zawartoci**, lub porednio z rozszerzeniem poprzez skrypt zawartoci, konieczne jest wykorzystanie **DOM** dostpnego dla obu stron jako kanau komunikacji.

### Wiadomoci Post

{% code title="content-script.js" %}
```javascript
var port = chrome.runtime.connect();

window.addEventListener("message", (event) => {
// We only accept messages from ourselves
if (event.source !== window) {
return;
}

if (event.data.type && (event.data.type === "FROM_PAGE")) {
console.log("Content script received: " + event.data.text);
port.postMessage(event.data.text);
}
}, false);
```
{% code title="example.js" %}
```javascript
document.getElementById("theButton").addEventListener("click", () => {
window.postMessage(
{type : "FROM_PAGE", text : "Hello from the webpage!"}, "*");
}, false);
```
{% endcode %}

Bezpieczna komunikacja Post Message powinna sprawdza autentyczno otrzymanej wiadomoci, mo偶na to zrobi sprawdzajc:

* **`event.isTrusted`**: Jest to prawdziwe tylko wtedy, gdy zdarzenie zostao wywoane przez dziaanie u偶ytkownika.
* Skrypt zawartoci mo偶e oczekiwa wiadomoci tylko wtedy, gdy u偶ytkownik wykonuje jakie dziaanie.
* **Domena pochodzenia**: mo偶e oczekiwa wiadomoci tylko z listy zaufanych domen.
* Jeli u偶ywane jest wyra偶enie regularne, nale偶y by bardzo ostro偶nym.
* **殴r贸do**: `received_message.source !== window` mo偶na u偶y do sprawdzenia, czy wiadomo pochodzi z **tego samego okna**, w kt贸rym nasuchuje skrypt zawartoci.

Wczeniejsze sprawdzenia, nawet jeli s wykonywane, mog by podatne na ataki, dlatego sprawd藕 na nastpnej stronie **potencjalne sposoby obejcia Post Message**:

{% content-ref url="../postmessage-vulnerabilities/" %}
[postmessage-vulnerabilities](../postmessage-vulnerabilities/)
{% endcontent-ref %}

### Iframe

Inn mo偶liw metod komunikacji mo偶e by za pomoc **adres贸w URL Iframe**, przykad mo偶na znale藕 tutaj:

{% content-ref url="browext-xss-example.md" %}
[browext-xss-example.md](browext-xss-example.md)
{% endcontent-ref %}

### DOM

To nie jest "dokadnie" spos贸b komunikacji, ale **strona internetowa i skrypt zawartoci bd miay dostp do DOM strony internetowej**. Jeli **skrypt zawartoci** odczytuje pewne informacje z niego, **ufajc DOM strony internetowej**, strona internetowa mo偶e **modyfikowa te dane** (poniewa偶 strona internetowa nie powinna by ufa, lub poniewa偶 strona internetowa jest podatna na XSS) i **narusza bezpieczestwo skryptu zawartoci**.

Przykad **DOM based XSS do naruszenia rozszerzenia przegldarki** mo偶na r贸wnie偶 znale藕 tutaj:

{% content-ref url="browext-xss-example.md" %}
[browext-xss-example.md](browext-xss-example.md)
{% endcontent-ref %}

## Wra偶liwe informacje w pamici/kodzie

Jeli rozszerzenie przegldarki przechowuje **wra偶liwe informacje w pamici**, mog one zosta **wydobyte** (szczeg贸lnie na maszynach z systemem Windows) i **przeszukane** w celu znalezienia tych informacji.

Dlatego pami rozszerzenia przegldarki **nie powinna by uwa偶ana za bezpieczn**, a **wra偶liwe informacje**, takie jak powiadczenia lub frazy mnemotechniczne, **nie powinny by przechowywane**.

Oczywicie **nie umieszczaj wra偶liwych informacji w kodzie**, poniewa偶 bd one **publiczne**.

## Komunikacja midzy skryptem zawartoci a skryptem ta

Skrypt zawartoci mo偶e u偶ywa funkcji [**runtime.sendMessage()**](https://developer.chrome.com/docs/extensions/reference/runtime#method-sendMessage) **lub** [**tabs.sendMessage()**](https://developer.chrome.com/docs/extensions/reference/tabs#method-sendMessage) do wysyania **jednorazowej wiadomoci w formacie JSON**.

Aby obsu偶y **odpowied藕**, u偶yj zwr贸conego **Promise**. Jednak dla zachowania kompatybilnoci wstecznej, nadal mo偶na przekaza **callback** jako ostatni argument.

Wysanie 偶dania z **skryptu zawartoci** wyglda tak:
```javascript
(async () => {
const response = await chrome.runtime.sendMessage({greeting: "hello"});
// do something with response here, not outside the function
console.log(response);
})();
```
Wysyanie 偶dania z **rozszerzenia** (zazwyczaj z **skryptu ta**) Skrypt zawartoci mo偶e korzysta z funkcji, z tym 偶e musisz okreli, do kt贸rego zakadki ma zosta wysane. Przykad wysania wiadomoci do skryptu zawartoci w wybranej zakadce:
```javascript
// From https://stackoverflow.com/questions/36153999/how-to-send-a-message-between-chrome-extension-popup-and-content-script
(async () => {
const [tab] = await chrome.tabs.query({active: true, lastFocusedWindow: true});
const response = await chrome.tabs.sendMessage(tab.id, {greeting: "hello"});
// do something with response here, not outside the function
console.log(response);
})();
```
Na **stronie odbiorczej** musisz skonfigurowa [**runtime.onMessage**](https://developer.chrome.com/docs/extensions/reference/runtime#event-onMessage) **suchacz zdarze**, aby obsu偶y wiadomo. Wyglda to tak samo zar贸wno w skrypcie treci, jak i na stronie rozszerzenia.
```javascript
// From https://stackoverflow.com/questions/70406787/javascript-send-message-from-content-js-to-background-js
chrome.runtime.onMessage.addListener(
function(request, sender, sendResponse) {
console.log(sender.tab ?
"from a content script:" + sender.tab.url :
"from the extension");
if (request.greeting === "hello")
sendResponse({farewell: "goodbye"});
}
);
```
W podanym przykadzie funkcja **`sendResponse()`** zostaa wykonana synchronicznie. Aby zmodyfikowa obsug zdarzenia `onMessage` w celu asynchronicznego wykonania funkcji `sendResponse()`, konieczne jest dodanie instrukcji `return true;`.

Wa偶nym czynnikiem jest to, 偶e w przypadku, gdy wiele stron ma odbiera zdarzenia `onMessage`, **pierwsza strona, kt贸ra wykonuje funkcj `sendResponse()`** dla danego zdarzenia, bdzie jedyn, kt贸ra skutecznie dostarczy odpowied藕. Wszelkie kolejne odpowiedzi na to samo zdarzenie nie bd brane pod uwag.

Tworzc nowe rozszerzenia, nale偶y preferowa u偶ycie obietnic zamiast wywoa zwrotnych. Jeli chodzi o u偶ycie wywoa zwrotnych, funkcja `sendResponse()` jest uwa偶ana za wa偶n tylko wtedy, gdy jest wykonywana bezporednio w kontekcie synchronicznym lub gdy obsuga zdarzenia wskazuje na operacj asynchroniczn przez zwr贸cenie wartoci `true`. Jeli 偶adna z obsug nie zwraca wartoci `true` lub jeli funkcja `sendResponse()` zostanie usunita z pamici (zebrana przez garbage collector), wywoanie zwrotne powizane z funkcj `sendMessage()` zostanie domylnie uruchomione.


## adowanie rozszerzenia w przegldarce

1. **Pobierz** rozszerzenie przegldarki i rozpakuj je
2. Przejd藕 do **`chrome://extensions/`** i **wcz** tryb `Developer Mode`
3. Kliknij przycisk **`Load unpacked`**

W **Firefoxie** przejd藕 do **`about:debugging#/runtime/this-firefox`** i kliknij przycisk **`Load Temporary Add-on`**.

## Pobieranie kodu 藕r贸dowego z sklepu

Kod 藕r贸dowy rozszerzenia Chrome mo偶na uzyska za pomoc r贸偶nych metod. Poni偶ej znajduj si szczeg贸owe wyjanienia i instrukcje dla ka偶dej opcji.

### Pobieranie rozszerzenia jako pliku ZIP za pomoc wiersza polece

Kod 藕r贸dowy rozszerzenia Chrome mo偶na pobra jako plik ZIP za pomoc wiersza polece. Wymaga to u偶ycia polecenia `curl`, aby pobra plik ZIP z okrelonego adresu URL, a nastpnie rozpakowania zawartoci pliku ZIP do katalogu. Oto kroki do wykonania: 

1. Zastp `"extension_id"` rzeczywistym identyfikatorem rozszerzenia.
2. Wykonaj nastpujce polecenia:
```bash
extension_id=your_extension_id   # Replace with the actual extension ID
curl -L -o "$extension_id.zip" "https://clients2.google.com/service/update2/crx?response=redirect&os=mac&arch=x86-64&nacl_arch=x86-64&prod=chromecrx&prodchannel=stable&prodversion=44.0.2403.130&x=id%3D$extension_id%26uc"
unzip -d "$extension_id-source" "$extension_id.zip"
```
### U偶yj strony internetowej CRX Viewer

[https://robwu.nl/crxviewer/](https://robwu.nl/crxviewer/)

### U偶yj rozszerzenia CRX Viewer

Inn wygodn metod jest u偶ycie rozszerzenia Chrome Extension Source Viewer, kt贸re jest projektem open-source. Mo偶na je zainstalowa ze [Sklepu Chrome Web Store](https://chrome.google.com/webstore/detail/chrome-extension-source-v/jifpbeccnghkjeaalbbjmodiffmgedin?hl=en). Kod 藕r贸dowy przegldarki jest dostpny w [repozytorium GitHub](https://github.com/Rob--W/crxviewer).

### Wywietlanie 藕r贸da lokalnie zainstalowanego rozszerzenia

Lokalnie zainstalowane rozszerzenia Chrome mo偶na r贸wnie偶 sprawdzi. Oto jak to zrobi:

1. Otw贸rz folder lokalnego profilu Chrome, odwiedzajc `chrome://version/` i znajdujc pole "Profile Path".
2. Przejd藕 do podfolderu `Extensions/` w folderze profilu.
3. Ten folder zawiera wszystkie zainstalowane rozszerzenia, zazwyczaj z kodem 藕r贸dowym w czytelnej formie.

Aby zidentyfikowa rozszerzenia, mo偶na przyporzdkowa ich identyfikatory do nazw:

- Wcz tryb dewelopera na stronie `about:extensions`, aby zobaczy identyfikatory ka偶dego rozszerzenia.
- W folderze ka偶dego rozszerzenia plik `manifest.json` zawiera czyteln sekcj `name`, kt贸ra pomaga zidentyfikowa rozszerzenie.

### U偶yj programu do archiwizacji lub rozpakowywania plik贸w
Przejd藕 do Sklepu Chrome Web Store i pobierz rozszerzenie. Plik bdzie mia rozszerzenie `.crx`.
Zmie rozszerzenie pliku z `.crx` na `.zip`.
U偶yj dowolnego programu do archiwizacji plik贸w (np. WinRAR, 7-Zip itp.), aby rozpakowa zawarto pliku ZIP.

### U偶yj trybu dewelopera w Chrome
Otw贸rz Chrome i przejd藕 do `chrome://extensions/`.
Wcz "Tryb dewelopera" w prawym g贸rnym rogu.
Kliknij "Zaaduj rozszerzenie bez pakietu...".
Przejd藕 do katalogu z rozszerzeniem.
To nie pobiera kodu 藕r贸dowego, ale jest przydatne do przegldania i modyfikowania kodu ju偶 pobranego lub opracowanego rozszerzenia.

## Lista kontrolna audytu bezpieczestwa

Mimo 偶e rozszerzenia przegldarki maj **ograniczon powierzchni ataku**, niekt贸re z nich mog zawiera **luki bezpieczestwa** lub **potencjalne ulepszenia zabezpiecze**. Oto najczstsze z nich:

* [ ] **Ograniczaj** jak najbardziej 偶dane **`permissions`**
* [ ] **Ograniczaj** jak najbardziej **`host_permissions`**
* [ ] U偶yj **silnej** **`content_security_policy`**
* [ ] **Ograniczaj** jak najbardziej **`externally_connectable`**, jeli nie jest to konieczne i mo偶liwe, nie pozostawiaj go domylnie, okrel **`{}`**
* [ ] Jeli tutaj wymieniony jest **URL podatny na XSS lub przejcie**, atakujcy bdzie m贸g **wysya wiadomoci bezporednio do skrypt贸w w tle**. Bardzo pot偶ne obejcie.
* [ ] **Ograniczaj** jak najbardziej **`web_accessible_resources`**, nawet jeli jest to mo偶liwe, pozostaw puste.
* [ ] Jeli **`web_accessible_resources`** nie jest puste, sprawd藕 [**ClickJacking**](browext-clickjacking.md)
* [ ] Jeli wystpuje jakakolwiek **komunikacja** z **strony internetowej** do **rozszerzenia**, sprawd藕 pod ktem podatnoci na [**XSS**](browext-xss-example.md) spowodowanej w komunikacji.
* [ ] Jeli u偶ywane s wiadomoci POST, sprawd藕 pod ktem [**podatnoci na wiadomoci POST**](../postmessage-vulnerabilities/)**.**
* [ ] Jeli **Skrypt zawartoci ma dostp do szczeg贸贸w DOM**, sprawd藕, czy nie wprowadza XSS, jeli zostan **zmodyfikowane** przez stron internetow
* [ ] Zwr贸 szczeg贸ln uwag, jeli ta komunikacja jest r贸wnie偶 zaanga偶owana w **komunikacj Skryptu zawartoci -> Skryptu w tle**
* [ ] **Wra偶liwe informacje nie powinny by przechowywane** w kodzie rozszerzenia przegldarki
* [ ] **Wra偶liwe informacje nie powinny by przechowywane** w pamici rozszerzenia przegldarki

## Narzdzia

### [**Tarnish**](https://thehackerblog.com/tarnish/)

* Pobiera dowolne rozszerzenie Chrome z podanego linku do sklepu Chrome.
* Przegldarka [**manifest.json**](https://developer.chrome.com/extensions/manifest): wywietla wersj JSON w czytelnej formie manifestu rozszerzenia.
* Analiza odcisk贸w palc贸w: Wykrywanie [web\_accessible\_resources](https://developer.chrome.com/extensions/manifest/web\_accessible\_resources) i automatyczne generowanie JavaScriptu do odcisk贸w palc贸w rozszerzenia Chrome.
* Analiza potencjalnego Clickjackingu: Wykrywanie stron HTML rozszerzenia z dyrektyw [web\_accessible\_resources](https://developer.chrome.com/extensions/manifest/web\_accessible\_resources). S one potencjalnie podatne na clickjacking w zale偶noci od celu stron.
* Przegldarka ostrze偶e o uprawnieniach: wywietla list wszystkich ostrze偶e dotyczcych uprawnie Chrome, kt贸re zostan wywietlone po pr贸bie zainstalowania rozszerzenia przez u偶ytkownika.
* Niebezpieczne funkcje: pokazuje lokalizacj niebezpiecznych funkcji, kt贸re mog by potencjalnie wykorzystane przez atakujcego (np. funkcje takie jak innerHTML, chrome.tabs.executeScript).
* Punkty wejcia: pokazuje, gdzie rozszerzenie przyjmuje dane od u偶ytkownika/zewntrznych 藕r贸de. Jest to przydatne do zrozumienia powierzchni ataku rozszerzenia i poszukiwania potencjalnych punkt贸w do przesyania zoliwie spreparowanych danych do rozszerzenia.
* Zar贸wno skanery Niebezpiecznych funkcji, jak i Punkty wejcia maj nastpujce funkcje dla wygenerowanych alert贸w:
* Istotny fragment kodu i linia, kt贸ra spowodowaa alert.
* Opis problemu.
* Przycisk "Wywietl plik", aby wywietli peny plik 藕r贸dowy zawierajcy kod.
* cie偶ka pliku, kt贸ry wywoa alert.
* Peny URI rozszerzenia Chrome dla pliku, kt贸ry wywoa alert.
* Rodzaj pliku, taki jak skrypt strony w tle, skrypt zawartoci, akcja przegldarki itp.
* Jeli podatna linia znajduje si w pliku JavaScript, cie偶ki wszystkich stron, na kt贸rych jest ona doczona, oraz status [web\_accessible\_resource](https://developer.chrome.com/extensions/manifest/web\_accessible\_resources) tych stron.
* Analizator i sprawdzark
* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi trikami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.
