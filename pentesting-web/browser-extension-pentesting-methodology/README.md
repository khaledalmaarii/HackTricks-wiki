# Browser Extension Pentesting Methodology

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

Ekstenzije pregledaÄa su napisane u JavaScript-u i uÄitavaju se u pozadini od strane pregledaÄa. Ima svoj [DOM](https://www.w3schools.com/js/js\_htmldom.asp) ali moÅ¾e da komunicira sa DOM-ovima drugih sajtova. To znaÄi da moÅ¾e ugroziti poverljivost, integritet i dostupnost (CIA) drugih sajtova.

## Main Components

Izgledi ekstenzija izgledaju najbolje kada su vizualizovani i sastoje se od tri komponente. Pogledajmo svaku komponentu detaljno.

<figure><img src="../../.gitbook/assets/image (16) (1).png" alt=""><figcaption><p><a href="http://webblaze.cs.berkeley.edu/papers/Extensions.pdf">http://webblaze.cs.berkeley.edu/papers/Extensions.pdf</a></p></figcaption></figure>

### **Content Scripts**

Svaki sadrÅ¾ajni skript ima direktan pristup DOM-u **jedne web stranice** i time je izloÅ¾en **potencijalno zloÄ‡udnom unosu**. MeÄ‘utim, sadrÅ¾ajni skript ne sadrÅ¾i dozvole osim sposobnosti slanja poruka jezgru ekstenzije.

### **Extension Core**

Jezgro ekstenzije sadrÅ¾i veÄ‡inu privilegija/pristupa ekstenzije, ali jezgro ekstenzije moÅ¾e da komunicira sa web sadrÅ¾ajem samo putem [XMLHttpRequest](https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest) i sadrÅ¾ajnih skripti. TakoÄ‘e, jezgro ekstenzije nema direktan pristup host maÅ¡ini.

### **Native Binary**

Ekstenzija omoguÄ‡ava nativni binarni fajl koji moÅ¾e **pristupiti host maÅ¡ini sa punim privilegijama korisnika.** Nativni binarni fajl komunicira sa jezgrom ekstenzije putem standardnog Netscape Plugin Application Programming Interface ([NPAPI](https://en.wikipedia.org/wiki/NPAPI)) koji koriste Flash i drugi pregledaÄki dodaci.

### Boundaries

{% hint style="danger" %}
Da bi dobio pune privilegije korisnika, napadaÄ mora ubediti ekstenziju da prenese zloÄ‡udni unos iz sadrÅ¾ajnog skripta u jezgro ekstenzije i iz jezgra ekstenzije u nativni binarni fajl.
{% endhint %}

Svaka komponenta ekstenzije je odvojena jedna od druge **jakim zaÅ¡titnim granicama**. Svaka komponenta se izvrÅ¡ava u **odvojenom procesu operativnog sistema**. SadrÅ¾ajni skripti i jezgra ekstenzija se izvrÅ¡avaju u **sandbox procesima** koji nisu dostupni veÄ‡ini usluga operativnog sistema.

Å taviÅ¡e, sadrÅ¾ajni skripti su odvojeni od svojih povezanih web stranica **izvrÅ¡avanjem u odvojenom JavaScript heap-u**. SadrÅ¾ajni skript i web stranica imaju **pristup istom osnovnom DOM-u**, ali se njih dvoje **nikada ne razmenjuju JavaScript pokazivaÄe**, spreÄavajuÄ‡i curenje JavaScript funkcionalnosti.

## **`manifest.json`**

Chrome ekstenzija je samo ZIP folder sa [.crx ekstenzijom fajla](https://www.lifewire.com/crx-file-2620391). Jezgro ekstenzije je **`manifest.json`** fajl u korenu foldera, koji specificira raspored, dozvole i druge opcije konfiguracije.

Example:
```json
{
"manifest_version": 2,
"name": "My extension",
"version": "1.0",
"permissions": [
"storage"
],
"content_scripts": [
{
"js": [
"script.js"
],
"matches": [
"https://example.com/*",
"https://www.example.com/*"
],
"exclude_matches": ["*://*/*business*"],
}
],
"background": {
"scripts": [
"background.js"
]
},
"options_ui": {
"page": "options.html"
}
}
```
### `content_scripts`

Skripte sadrÅ¾aja se **uÄitavaju** svaki put kada korisnik **navigira na odgovarajuÄ‡u stranicu**, u naÅ¡em sluÄaju bilo koja stranica koja odgovara **`https://example.com/*`** izrazu i ne odgovara **`*://*/*/business*`** regex-u. IzvrÅ¡avaju se **kao sopstveni skripti stranice** i imaju proizvoljan pristup [Modelu objekta dokumenta (DOM)](https://developer.mozilla.org/en-US/docs/Web/API/Document\_Object\_Model) stranice.
```json
"content_scripts": [
{
"js": [
"script.js"
],
"matches": [
"https://example.com/*",
"https://www.example.com/*"
],
"exclude_matches": ["*://*/*business*"],
}
],
```
Da bi se ukljuÄilo ili iskljuÄilo viÅ¡e URL-ova, takoÄ‘e je moguÄ‡e koristiti **`include_globs`** i **`exclude_globs`**.

Ovo je primer sadrÅ¾ajnog skripta koji Ä‡e dodati dugme za objaÅ¡njenje na stranicu kada [API za skladiÅ¡tenje](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/storage) preuzme `message` vrednost iz skladiÅ¡ta ekstenzije.
```js
chrome.storage.local.get("message", result =>
{
let div = document.createElement("div");
div.innerHTML = result.message + " <button>Explain</button>";
div.querySelector("button").addEventListener("click", () =>
{
chrome.runtime.sendMessage("explain");
});
document.body.appendChild(div);
});
```
<figure><img src="../../.gitbook/assets/image (23).png" alt=""><figcaption></figcaption></figure>

Poruka se Å¡alje na stranice ekstenzije putem sadrÅ¾ajnog skripta kada se pritisne ovaj dugme, koriÅ¡Ä‡enjem [**runtime.sendMessage() API**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/runtime/sendMessage). To je zbog ograniÄenja sadrÅ¾ajnog skripta u direktnom pristupu API-ima, pri Äemu je `storage` jedan od retkih izuzetaka. Za funkcionalnosti izvan ovih izuzetaka, poruke se Å¡alju na stranice ekstenzije sa kojima sadrÅ¾ajni skripti mogu komunicirati.

{% hint style="warning" %}
U zavisnosti od pretraÅ¾ivaÄa, moguÄ‡nosti sadrÅ¾ajnog skripta mogu se malo razlikovati. Za pretraÅ¾ivaÄe zasnovane na Chromium-u, lista moguÄ‡nosti je dostupna u [Chrome Developers dokumentaciji](https://developer.chrome.com/docs/extensions/mv3/content\_scripts/#capabilities), a za Firefox, [MDN](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/Content\_scripts#webextension\_apis) sluÅ¾i kao primarni izvor.\
TakoÄ‘e je vaÅ¾no napomenuti da sadrÅ¾ajni skripti imaju sposobnost da komuniciraju sa pozadinskim skriptima, omoguÄ‡avajuÄ‡i im da izvrÅ¡avaju radnje i prenose odgovore nazad.
{% endhint %}

Za pregledanje i debagovanje sadrÅ¾ajnih skripti u Chrome-u, meni alata za programere moÅ¾e se pristupiti iz Opcije > ViÅ¡e alata > Alati za programere ili pritiskom na Ctrl + Shift + I.

Kada se prikaÅ¾u alati za programere, treba kliknuti na **Source tab**, a zatim na **Content Scripts** tab. Ovo omoguÄ‡ava posmatranje aktivnih sadrÅ¾ajnih skripti iz razliÄitih ekstenzija i postavljanje taÄaka prekida za praÄ‡enje toka izvrÅ¡enja.

### Umetnuti sadrÅ¾ajni skripti

{% hint style="success" %}
Napomena: **SadrÅ¾ajni skripti nisu obavezni** jer je takoÄ‘e moguÄ‡e **dinamiÄki** **umetati** skripte i **programatski ih umetati** na web stranice putem **`tabs.executeScript`**. Ovo zapravo pruÅ¾a viÅ¡e **granularnih kontrola**.
{% endhint %}

Za programatsko umetanje sadrÅ¾ajnog skripta, ekstenzija mora imati [dozvole za host](https://developer.chrome.com/docs/extensions/reference/permissions) za stranicu u koju se skripte treba umetnuti. Ove dozvole mogu se obezbediti ili **zahtevom** unutar manifest fajla ekstenzije ili privremeno putem [**activeTab**](https://developer.chrome.com/docs/extensions/reference/manifest/activeTab).

#### Primer ekstenzije zasnovane na activeTab

{% code title="manifest.json" %}
```json
{
"name": "My extension",
...
"permissions": [
"activeTab",
"scripting"
],
"background": {
"service_worker": "background.js"
},
"action": {
"default_title": "Action Button"
}
}
```
{% endcode %}

* **Umetnite JS datoteku na klik:**
```javascript
// content-script.js
document.body.style.backgroundColor = "orange";

//service-worker.js - Inject the JS file
chrome.action.onClicked.addListener((tab) => {
chrome.scripting.executeScript({
target: { tabId: tab.id },
files: ["content-script.js"]
});
});
```
* **Umetnite funkciju** na klik:
```javascript
//service-worker.js - Inject a function
function injectedFunction() {
document.body.style.backgroundColor = "orange";
}

chrome.action.onClicked.addListener((tab) => {
chrome.scripting.executeScript({
target : {tabId : tab.id},
func : injectedFunction,
});
});
```
#### Primer sa dozvolama za skripting
```javascript
// service-workser.js
chrome.scripting.registerContentScripts([{
id : "test",
matches : [ "https://*.example.com/*" ],
excludeMatches : [ "*://*/*business*" ],
js : [ "contentScript.js" ],
}]);

// Another example
chrome.tabs.executeScript(tabId, { file: "content_script.js" });
```
Da bi se ukljuÄilo ili iskljuÄilo viÅ¡e URL-ova, takoÄ‘e je moguÄ‡e koristiti **`include_globs`** i **`exclude_globs`**.

### Content Scripts `run_at`

Polje `run_at` kontroliÅ¡e **kada se JavaScript datoteke ubacuju u web stranicu**. Preferirana i podrazumevana vrednost je `"document_idle"`.

MoguÄ‡e vrednosti su:

* **`document_idle`**: Kada god je to moguÄ‡e
* **`document_start`**: Nakon bilo kojih datoteka iz `css`, ali pre nego Å¡to se konstruira bilo koji drugi DOM ili se pokrene bilo koji drugi skript.
* **`document_end`**: Odmah nakon Å¡to je DOM zavrÅ¡en, ali pre nego Å¡to se uÄitaju podresursi poput slika i okvira.

#### Via `manifest.json`
```json
{
"name": "My extension",
...
"content_scripts": [
{
"matches": ["https://*.example.com/*"],
"run_at": "document_idle",
"js": ["contentScript.js"]
}
],
...
}

```
Via **`service-worker.js`**
```javascript
chrome.scripting.registerContentScripts([{
id : "test",
matches : [ "https://*.example.com/*" ],
runAt : "document_idle",
js : [ "contentScript.js" ],
}]);
```
### `background`

Poruke koje Å¡alju sadrÅ¾ajni skripti primaju **pozadinske stranice**, koje imaju centralnu ulogu u koordinaciji komponenti ekstenzije. VaÅ¾no je napomenuti da pozadinska stranica opstaje tokom celog trajanja ekstenzije, delujuÄ‡i diskretno bez direktne interakcije korisnika. Ima svoj vlastiti Model Objekta Dokumenta (DOM), Å¡to omoguÄ‡ava sloÅ¾ene interakcije i upravljanje stanjem.

**KljuÄne taÄke**:

* **Uloga pozadinske stranice:** Deluje kao nervni centar za ekstenziju, obezbeÄ‘ujuÄ‡i komunikaciju i koordinaciju meÄ‘u razliÄitim delovima ekstenzije.
* **Postojanost:** To je uvek prisutna entitet, nevidljiva korisniku, ali integralna za funkcionalnost ekstenzije.
* **Automatska generacija:** Ako nije eksplicitno definisana, pretraÅ¾ivaÄ Ä‡e automatski kreirati pozadinsku stranicu. Ova automatski generisana stranica Ä‡e ukljuÄivati sve pozadinske skripte navedene u manifestu ekstenzije, obezbeÄ‘ujuÄ‡i nesmetano funkcionisanje pozadinskih zadataka ekstenzije.

{% hint style="success" %}
Pogodnost koju pretraÅ¾ivaÄ pruÅ¾a automatskim generisanjem pozadinske stranice (kada nije eksplicitno deklarisana) osigurava da su sve potrebne pozadinske skripte integrisane i operativne, pojednostavljujuÄ‡i proces postavljanja ekstenzije.
{% endhint %}

Primer pozadinske skripte:
```js
chrome.runtime.onMessage.addListener((request, sender, sendResponse) =>
{
if (request == "explain")
{
chrome.tabs.create({ url: "https://example.net/explanation" });
}
})
```
Koristi [runtime.onMessage API](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/runtime/onMessage) za sluÅ¡anje poruka. Kada se primi poruka `"explain"`, koristi [tabs API](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs) da otvori stranicu u novoj kartici.

Da biste debagovali pozadinski skript, moÅ¾ete otiÄ‡i na **detalje ekstenzije i inspektovati servisnog radnika,** ovo Ä‡e otvoriti alate za programere sa pozadinskim skriptom:

<figure><img src="https://github.com/carlospolop/hacktricks/blob/master/pentesting-web/browser-extension-pentesting-methodology/broken-reference" alt=""><figcaption></figcaption></figure>

### Opcione stranice i druge

Ekstenzije pretraÅ¾ivaÄa mogu sadrÅ¾ati razne vrste stranica:

* **Akcione stranice** se prikazuju u **ispod padajuÄ‡eg menija kada se klikne na ikonu ekstenzije**.
* Stranice koje Ä‡e ekstenzija **uÄitati u novoj kartici**.
* **Opcione stranice**: Ova stranica se prikazuje na vrhu ekstenzije kada se klikne. U prethodnom manifestu, u mom sluÄaju, mogao sam da pristupim ovoj stranici na `chrome://extensions/?options=fadlhnelkbeojnebcbkacjilhnbjfjca` ili klikom:

<figure><img src="../../.gitbook/assets/image (24).png" alt="" width="375"><figcaption></figcaption></figure>

Napomena da ove stranice nisu trajne kao pozadinske stranice jer dinamiÄki uÄitavaju sadrÅ¾aj po potrebi. I pored toga, dele odreÄ‘ene moguÄ‡nosti sa pozadinskom stranicom:

* **Komunikacija sa sadrÅ¾ajnim skriptama:** SliÄno pozadinskoj stranici, ove stranice mogu primati poruke od sadrÅ¾ajnih skripti, olakÅ¡avajuÄ‡i interakciju unutar ekstenzije.
* **Pristup API-ima specifiÄnim za ekstenziju:** Ove stranice uÅ¾ivaju sveobuhvatan pristup API-ima specifiÄnim za ekstenziju, podloÅ¾nim dozvolama definisanim za ekstenziju.

### `permissions` & `host_permissions`

**`permissions`** i **`host_permissions`** su unosi iz `manifest.json` koji Ä‡e oznaÄiti **koje dozvole** ekstenzija pretraÅ¾ivaÄa ima (smeÅ¡taj, lokacija...) i u **koje web stranice**.

Kako ekstenzije pretraÅ¾ivaÄa mogu biti tako **privilegovane**, zlonamerna ili kompromitovana ekstenzija mogla bi omoguÄ‡iti napadaÄu **razliÄite naÄine da ukrade osetljive informacije i Å¡pijunira korisnika**.

Proverite kako ove postavke funkcioniÅ¡u i kako bi mogle biti zloupotrebljene u:

{% content-ref url="browext-permissions-and-host_permissions.md" %}
[browext-permissions-and-host\_permissions.md](browext-permissions-and-host\_permissions.md)
{% endcontent-ref %}

### `content_security_policy`

**Politika bezbednosti sadrÅ¾aja** moÅ¾e biti deklarisana i unutar `manifest.json`. Ako postoji definisana, mogla bi biti **ranjiva**.

Podrazumevana postavka za stranice ekstenzije pretraÅ¾ivaÄa je priliÄno restriktivna:
```bash
script-src 'self'; object-src 'self';
```
Za viÅ¡e informacija o CSP-u i potencijalnim zaobilaÅ¾enjima, proverite:

{% content-ref url="../content-security-policy-csp-bypass/" %}
[content-security-policy-csp-bypass](../content-security-policy-csp-bypass/)
{% endcontent-ref %}

### `web_accessible_resources`

Da bi veb stranica imala pristup stranici ekstenzije pregledaÄa, na primer, `.html` stranici, ova stranica mora biti pomenuta u **`web_accessible_resources`** polju `manifest.json`.\
Na primer:
```javascript
{
...
"web_accessible_resources": [
{
"resources": [ "images/*.png" ],
"matches": [ "https://example.com/*" ]
},
{
"resources": [ "fonts/*.woff" ],
"matches": [ "https://example.com/*" ]
}
],
...
}
```
Ove stranice su dostupne na URL-u kao:
```
chrome-extension://<extension-id>/message.html
```
U javnim ekstenzijama **extension-id je dostupan**:

<figure><img src="../../.gitbook/assets/image (1194).png" alt="" width="375"><figcaption></figcaption></figure>

MeÄ‘utim, ako se koristi parametar `manifest.json` **`use_dynamic_url`**, ovaj **id moÅ¾e biti dinamiÄan**.

{% hint style="success" %}
Imajte na umu da Äak i ako je stranica ovde pomenuta, moÅ¾e biti **zaÅ¡tiÄ‡ena od ClickJacking** zahvaljujuÄ‡i **Content Security Policy**. TakoÄ‘e treba da proverite (odeljak frame-ancestors) pre nego Å¡to potvrdite da je ClickJacking napad moguÄ‡.
{% endhint %}

MoguÄ‡nost pristupa ovim stranicama Äini ih **potencijalno ranjivim na ClickJacking**:

{% content-ref url="browext-clickjacking.md" %}
[browext-clickjacking.md](browext-clickjacking.md)
{% endcontent-ref %}

{% hint style="success" %}
Dozvoljavanje da se ove stranice uÄitavaju samo putem ekstenzije, a ne putem nasumiÄnih URL-ova, moglo bi spreÄiti ClickJacking napade.
{% endhint %}

{% hint style="danger" %}
Imajte na umu da stranice iz **`web_accessible_resources`** i druge stranice ekstenzije takoÄ‘e mogu **kontaktirati pozadinske skripte**. Dakle, ako je jedna od ovih stranica ranjiva na **XSS**, to bi moglo otvoriti veÄ‡u ranjivost.

Pored toga, imajte na umu da moÅ¾ete otvoriti samo stranice navedene u **`web_accessible_resources`** unutar iframe-ova, ali iz nove kartice je moguÄ‡e pristupiti bilo kojoj stranici u ekstenziji poznavajuÄ‡i ID ekstenzije. Stoga, ako se pronaÄ‘e XSS koji zloupotrebljava iste parametre, moÅ¾e se zloupotrebiti Äak i ako stranica nije konfigurisana u **`web_accessible_resources`**.
{% endhint %}

### `externally_connectable`

Prema [**docs**](https://developer.chrome.com/docs/extensions/reference/manifest/externally-connectable), `"externally_connectable"` manifest svojstvo deklarira **koje ekstenzije i web stranice mogu da se poveÅ¾u** sa vaÅ¡om ekstenzijom putem [runtime.connect](https://developer.chrome.com/docs/extensions/reference/runtime#method-connect) i [runtime.sendMessage](https://developer.chrome.com/docs/extensions/reference/runtime#method-sendMessage).

* Ako **`externally_connectable`** kljuÄ **nije** deklarisan u manifestu vaÅ¡e ekstenzije ili je deklarisan kao **`"ids": ["*"]`**, **sve ekstenzije mogu da se poveÅ¾u, ali nijedna web stranica ne moÅ¾e da se poveÅ¾e**.
* Ako su **specifiÄni ID-ovi navedeni**, kao u `"ids": ["aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"]`, **samo te aplikacije** mogu da se poveÅ¾u.
* Ako su **match-ovi** navedeni, te web aplikacije Ä‡e moÄ‡i da se poveÅ¾u:
```json
"matches": [
"https://*.google.com/*",
"*://*.chromium.org/*",
```
* Ako je navedeno kao prazno: **`"externally_connectable": {}`**, nijedna aplikacija ili veb neÄ‡e moÄ‡i da se poveÅ¾e.

Å to je **manje ekstenzija i URL-ova** ovde navedeno, to Ä‡e biti **manja povrÅ¡ina napada**.

{% hint style="danger" %}
Ako je veb stranica **ranjiva na XSS ili preuzimanje** navedena u **`externally_connectable`**, napadaÄ Ä‡e moÄ‡i da **poÅ¡alje poruke direktno u pozadinski skript**, potpuno zaobilazeÄ‡i Content Script i njegov CSP.

Stoga, ovo je **veoma moÄ‡an zaobilazni naÄin**.

Å taviÅ¡e, ako klijent instalira laÅ¾nu ekstenziju, Äak i ako nije dozvoljeno da komunicira sa ranjivom ekstenzijom, mogla bi da ubrizga **XSS podatke u dozvoljenu veb stranicu** ili zloupotrebi **`WebRequest`** ili **`DeclarativeNetRequest`** API-je da manipuliÅ¡e zahtevima na ciljanom domenu menjajuÄ‡i zahtev stranice za **JavaScript datoteku**. (Imajte na umu da CSP na ciljnoj stranici moÅ¾e spreÄiti ove napade). Ova ideja dolazi [**iz ovog izveÅ¡taja**](https://www.darkrelay.com/post/opera-zero-day-rce-vulnerability).
{% endhint %}

## SaÅ¾etak komunikacije

### Ekstenzija <--> WebApp

Za komunikaciju izmeÄ‘u sadrÅ¾ajnog skripta i veb stranice obiÄno se koriste post poruke. Stoga, u veb aplikaciji obiÄno Ä‡ete pronaÄ‡i pozive funkciji **`window.postMessage`** i u sadrÅ¾ajnom skriptu sluÅ¡aoce poput **`window.addEventListener`**. Imajte na umu, meÄ‘utim, da ekstenzija takoÄ‘e moÅ¾e **komunicirati sa veb aplikacijom slanjem Post Poruke** (i stoga bi veb trebao to oÄekivati) ili jednostavno uÄiniti da veb uÄita novi skript.

### Unutar ekstenzije

ObiÄno se funkcija **`chrome.runtime.sendMessage`** koristi za slanje poruke unutar ekstenzije (obiÄno obraÄ‘uje `background` skript) i da bi je primila i obradila, deklarisan je sluÅ¡alac koji poziva **`chrome.runtime.onMessage.addListener`**.

TakoÄ‘e je moguÄ‡e koristiti **`chrome.runtime.connect()`** da se uspostavi postojana veza umesto slanja pojedinaÄnih poruka, moguÄ‡e je koristiti je za **slanje** i **prijem** **poruka** kao u sledeÄ‡em primeru:

<details>

<summary><code>chrome.runtime.connect()</code> primer</summary>
```javascript
var port = chrome.runtime.connect();

// Listen for messages from the web page
window.addEventListener("message", (event) => {
// Only accept messages from the same window
if (event.source !== window) {
return;
}

// Check if the message type is "FROM_PAGE"
if (event.data.type && (event.data.type === "FROM_PAGE")) {
console.log("Content script received: " + event.data.text);
// Forward the message to the background script
port.postMessage({ type: 'FROM_PAGE', text: event.data.text });
}
}, false);

// Listen for messages from the background script
port.onMessage.addListener(function(msg) {
console.log("Content script received message from background script:", msg);
// Handle the response message from the background script
});
```
</details>

TakoÄ‘e je moguÄ‡e slati poruke iz pozadinskog skripta u sadrÅ¾ajni skript smeÅ¡ten u odreÄ‘enoj kartici pozivajuÄ‡i **`chrome.tabs.sendMessage`** gde Ä‡ete morati da navedete **ID kartice** kojoj Å¡aljete poruku.

### Od dozvoljenog `externally_connectable` do ekstenzije

**Web aplikacije i eksternalni pregledaÄki dodaci koji su dozvoljeni** u `externally_connectable` konfiguraciji mogu slati zahteve koristeÄ‡i :
```javascript
chrome.runtime.sendMessage(extensionId, ...
```
Gde je potrebno pomenuti **ID ekstenzije**.

## Web **â†”ï¸** Komunikacija sa sadrÅ¾ajnim skriptama

OkruÅ¾enja u kojima **sadrÅ¾ajni skripti** funkcioniÅ¡u i gde postoje host stranice su **odvojena** jedno od drugog, obezbeÄ‘ujuÄ‡i **izolaciju**. I pored ove izolacije, oba imaju sposobnost da interaguju sa **Modelom objekata dokumenta (DOM)** stranice, zajedniÄkim resursom. Da bi host stranica mogla da komunicira sa **sadrÅ¾ajnim skriptom**, ili indirektno sa ekstenzijom putem sadrÅ¾ajnog skripta, potrebno je koristiti **DOM** koji je dostupan za obe strane kao komunikacioni kanal.

### Post poruke

{% code title="content-script.js" %}
```javascript
// This is like "chrome.runtime.sendMessage" but to maintain the connection
var port = chrome.runtime.connect();

window.addEventListener("message", (event) => {
// We only accept messages from ourselves
if (event.source !== window) {
return;
}

if (event.data.type && (event.data.type === "FROM_PAGE")) {
console.log("Content script received: " + event.data.text);
// Forward the message to the background script
port.postMessage(event.data.text);
}
}, false);
```
{% endcode %}

{% code title="example.js" %}
```javascript
document.getElementById("theButton").addEventListener("click", () => {
window.postMessage(
{type : "FROM_PAGE", text : "Hello from the webpage!"}, "*");
}, false);
```
{% endcode %}

Sigurna Post Message komunikacija treba da proveri autentiÄnost primljene poruke, to se moÅ¾e uraditi proverom:

* **`event.isTrusted`**: Ovo je TaÄno samo ako je dogaÄ‘aj pokrenut akcijom korisnika
* SadrÅ¾ajni skript moÅ¾e oÄekivati poruku samo ako korisnik izvrÅ¡i neku akciju
* **izvorna domena**: moÅ¾e oÄekivati poruku samo sa dozvoljene liste domena.
* Ako se koristi regex, budite veoma oprezni
* **Izvor**: `received_message.source !== window` moÅ¾e se koristiti za proveru da li je poruka **iz iste prozora** gde SadrÅ¾ajni Skript sluÅ¡a.

Prethodne provere, Äak i ako su izvrÅ¡ene, mogu biti ranjive, pa proverite na sledeÄ‡oj stranici **potencijalne Post Message zaobilaÅ¾enja**:

{% content-ref url="../postmessage-vulnerabilities/" %}
[postmessage-vulnerabilities](../postmessage-vulnerabilities/)
{% endcontent-ref %}

### Iframe

JoÅ¡ jedan moguÄ‡i naÄin komunikacije moÅ¾e biti kroz **Iframe URL-ove**, moÅ¾ete pronaÄ‡i primer u:

{% content-ref url="browext-xss-example.md" %}
[browext-xss-example.md](browext-xss-example.md)
{% endcontent-ref %}

### DOM

Ovo nije "taÄno" naÄin komunikacije, ali **web i sadrÅ¾ajni skript Ä‡e imati pristup web DOM-u**. Dakle, ako **sadrÅ¾ajni skript** Äita neke informacije iz njega, **verujuÄ‡i web DOM-u**, web bi mogao **modifikovati ove podatke** (jer web ne bi trebao biti poverljiv, ili zato Å¡to je web ranjiv na XSS) i **kompromitovati SadrÅ¾ajni Skript**.

TakoÄ‘e moÅ¾ete pronaÄ‡i primer **DOM baziranog XSS-a za kompromitovanje ekstenzije pretraÅ¾ivaÄa** u:

{% content-ref url="browext-xss-example.md" %}
[browext-xss-example.md](browext-xss-example.md)
{% endcontent-ref %}

## Komunikacija SadrÅ¾ajnog Skripta **â†”ï¸** Pozadinskog Skripta

SadrÅ¾ajni Skript moÅ¾e koristiti funkcije [**runtime.sendMessage()**](https://developer.chrome.com/docs/extensions/reference/runtime#method-sendMessage) **ili** [**tabs.sendMessage()**](https://developer.chrome.com/docs/extensions/reference/tabs#method-sendMessage) za slanje **jednokratne JSON-serializovane** poruke.

Da biste obradili **odgovor**, koristite vraÄ‡eni **Promise**. Iako, za unazadnu kompatibilnost, joÅ¡ uvek moÅ¾ete proslediti **callback** kao poslednji argument.

Slanje zahteva iz **sadrÅ¾ajnog skripta** izgleda ovako:
```javascript
(async () => {
const response = await chrome.runtime.sendMessage({greeting: "hello"});
// do something with response here, not outside the function
console.log(response);
})();
```
Slanje zahteva iz **ekstenzije** (obiÄno **pozadinskog skripta**). Primer kako poslati poruku sadrÅ¾ajnom skriptu u odabranom tabu:
```javascript
// From https://stackoverflow.com/questions/36153999/how-to-send-a-message-between-chrome-extension-popup-and-content-script
(async () => {
const [tab] = await chrome.tabs.query({active: true, lastFocusedWindow: true});
const response = await chrome.tabs.sendMessage(tab.id, {greeting: "hello"});
// do something with response here, not outside the function
console.log(response);
})();
```
Na **prijemnoj strani**, potrebno je postaviti [**runtime.onMessage**](https://developer.chrome.com/docs/extensions/reference/runtime#event-onMessage) **sluÅ¡aÄ dogaÄ‘aja** da bi se obradila poruka. Ovo izgleda isto iz skripte sadrÅ¾aja ili stranice ekstenzije.
```javascript
// From https://stackoverflow.com/questions/70406787/javascript-send-message-from-content-js-to-background-js
chrome.runtime.onMessage.addListener(
function(request, sender, sendResponse) {
console.log(sender.tab ?
"from a content script:" + sender.tab.url :
"from the extension");
if (request.greeting === "hello")
sendResponse({farewell: "goodbye"});
}
);
```
U istaknutom primeru, **`sendResponse()`** je izvrÅ¡en na sinhroni naÄin. Da bi se modifikovao `onMessage` handler za asinhrono izvrÅ¡avanje `sendResponse()`, neophodno je ukljuÄiti `return true;`.

VaÅ¾na stvar koju treba uzeti u obzir je da u scenarijima gde viÅ¡e stranica treba da prime `onMessage` dogaÄ‘aje, **prva stranica koja izvrÅ¡i `sendResponse()`** za odreÄ‘eni dogaÄ‘aj Ä‡e biti jedina koja moÅ¾e efikasno dostaviti odgovor. Svi naredni odgovori na isti dogaÄ‘aj neÄ‡e biti uzeti u obzir.

Kada se kreiraju nove ekstenzije, prednost bi trebala biti na promenama umesto na povratnim pozivima. Å to se tiÄe koriÅ¡Ä‡enja povratnih poziva, `sendResponse()` funkcija se smatra validnom samo ako se izvrÅ¡ava direktno unutar sinhronog konteksta, ili ako handler dogaÄ‘aja oznaÄava asinhronu operaciju vraÄ‡anjem `true`. Ako nijedan od handlera ne vrati `true` ili ako je funkcija `sendResponse()` uklonjena iz memorije (garbage-collected), povratni poziv povezan sa `sendMessage()` funkcijom Ä‡e se podrazumevano aktivirati.

## Osetljive informacije u memoriji/kodu/clipboard-u

Ako Browser Extension Äuva **osetljive informacije unutar svoje memorije**, to moÅ¾e biti **izbaÄeno** (posebno na Windows maÅ¡inama) i **pretraÅ¾eno** za te informacije.

Stoga, memorija Browser Extension **ne bi trebala biti smatrana sigurnom** i **osetljive informacije** kao Å¡to su akreditivi ili mnemoniÄke fraze **ne bi trebale biti Äuvane**.

Naravno, **ne stavljajte osetljive informacije u kod**, jer Ä‡e biti **javne**.

Da biste izbacili memoriju iz browser-a, moÅ¾ete **izbaciti memoriju procesa** ili otiÄ‡i na **podeÅ¡avanja** browser ekstenzije, kliknuti na **`Inspect pop-up`** -> U **`Memory`** sekciji -> **`Take a snapshot`** i **`CTRL+F`** da pretraÅ¾ujete unutar snimka za osetljive informacije.

Å taviÅ¡e, veoma osetljive informacije kao Å¡to su mnemoniÄke kljuÄeve ili lozinke **ne bi trebale biti dozvoljene da se kopiraju u clipboard** (ili barem ih uklonite iz clipboard-a za nekoliko sekundi) jer Ä‡e tada procesi koji prate clipboard moÄ‡i da ih dobiju.

## UÄitavanje ekstenzije u browser

1. **Preuzmite** Browser Extension & raspakujte
2. Idite na **`chrome://extensions/`** i **omoguÄ‡ite** `Developer Mode`
3. Kliknite na **`Load unpacked`** dugme

U **Firefox-u** idite na **`about:debugging#/runtime/this-firefox`** i kliknite na **`Load Temporary Add-on`** dugme.

## Dobijanje izvornog koda iz prodavnice

Izvorni kod Chrome ekstenzije moÅ¾e se dobiti kroz razliÄite metode. U nastavku su detaljna objaÅ¡njenja i uputstva za svaku opciju.

### Preuzimanje ekstenzije kao ZIP putem komandne linije

Izvorni kod Chrome ekstenzije moÅ¾e se preuzeti kao ZIP fajl koristeÄ‡i komandnu liniju. Ovo ukljuÄuje koriÅ¡Ä‡enje `curl` za preuzimanje ZIP fajla sa specifiÄne URL adrese i zatim ekstrakciju sadrÅ¾aja ZIP fajla u direktorijum. Evo koraka:

1. Zamenite `"extension_id"` sa stvarnim ID-jem ekstenzije.
2. IzvrÅ¡ite sledeÄ‡e komande:
```bash
extension_id=your_extension_id   # Replace with the actual extension ID
curl -L -o "$extension_id.zip" "https://clients2.google.com/service/update2/crx?response=redirect&os=mac&arch=x86-64&nacl_arch=x86-64&prod=chromecrx&prodchannel=stable&prodversion=44.0.2403.130&x=id%3D$extension_id%26uc"
unzip -d "$extension_id-source" "$extension_id.zip"
```
### Koristite CRX Viewer veb sajt

[https://robwu.nl/crxviewer/](https://robwu.nl/crxviewer/)

### Koristite CRX Viewer ekstenziju

JoÅ¡ jedna pogodna metoda je koriÅ¡Ä‡enje Chrome Extension Source Viewer, koji je open-source projekat. MoÅ¾e se instalirati iz [Chrome Web Store](https://chrome.google.com/webstore/detail/chrome-extension-source-v/jifpbeccnghkjeaalbbjmodiffmgedin?hl=en). Izvorni kod pregledaÄa je dostupan u njegovom [GitHub repozitorijumu](https://github.com/Rob--W/crxviewer).

### Pregledajte izvor lokalno instalirane ekstenzije

Chrome ekstenzije instalirane lokalno takoÄ‘e se mogu pregledati. Evo kako:

1. Pristupite svom Chrome lokalnom profilu tako Å¡to Ä‡ete posetiti `chrome://version/` i pronaÄ‡i polje "Profile Path".
2. Idite u podfolder `Extensions/` unutar direktorijuma profila.
3. Ovaj folder sadrÅ¾i sve instalirane ekstenzije, obiÄno sa njihovim izvorom u Äitljivom formatu.

Da biste identifikovali ekstenzije, moÅ¾ete mapirati njihove ID-ove na imena:

* OmoguÄ‡ite Developer Mode na stranici `about:extensions` da biste videli ID-eve svake ekstenzije.
* Unutar foldera svake ekstenzije, datoteka `manifest.json` sadrÅ¾i Äitljivo polje `name`, Å¡to pomaÅ¾e u identifikaciji ekstenzije.

### Koristite arhivator ili raspakivaÄ

Idite na Chrome Web Store i preuzmite ekstenziju. Datoteka Ä‡e imati ekstenziju `.crx`. Promenite ekstenziju datoteke sa `.crx` na `.zip`. Koristite bilo koji arhivator (kao Å¡to su WinRAR, 7-Zip, itd.) da biste raspakovali sadrÅ¾aj ZIP datoteke.

### Koristite Developer Mode u Chrome-u

Otvorite Chrome i idite na `chrome://extensions/`. OmoguÄ‡ite "Developer mode" u gornjem desnom uglu. Kliknite na "Load unpacked extension...". Idite do direktorijuma vaÅ¡e ekstenzije. Ovo ne preuzima izvorni kod, ali je korisno za pregledanje i modifikovanje koda veÄ‡ preuzete ili razvijene ekstenzije.

## Lista za bezbednosnu reviziju

Iako ekstenzije pretraÅ¾ivaÄa imaju **ograniÄenu povrÅ¡inu napada**, neke od njih mogu sadrÅ¾ati **ranjivosti** ili **potencijalna poboljÅ¡anja sigurnosti**. SledeÄ‡e su najÄeÅ¡Ä‡e:

* [ ] **OgraniÄite** koliko je moguÄ‡e traÅ¾ene **`permissions`**
* [ ] **OgraniÄite** koliko je moguÄ‡e **`host_permissions`**
* [ ] Koristite **jaku** **`content_security_policy`**
* [ ] **OgraniÄite** koliko je moguÄ‡e **`externally_connectable`**, ako nije potrebno i moguÄ‡e, ne ostavljajte ga po defaultu, navedite **`{}`**
* [ ] Ako je ovde navedena **URL ranjiva na XSS ili preuzimanje**, napadaÄ Ä‡e moÄ‡i da **Å¡alje poruke pozadinskim skriptama direktno**. Veoma moÄ‡an zaobilaÅ¾enje.
* [ ] **OgraniÄite** koliko je moguÄ‡e **`web_accessible_resources`**, Äak i prazne ako je moguÄ‡e.
* [ ] Ako **`web_accessible_resources`** nije nijedna, proverite za [**ClickJacking**](browext-clickjacking.md)
* [ ] Ako se bilo koja **komunikacija** deÅ¡ava od **ekstenzije** do **web stranice**, [**proverite za XSS**](browext-xss-example.md) **ranjivosti** uzrokovane u komunikaciji.
* [ ] Ako se koriste Post Messages, proverite za [**Post Message ranjivosti**](../postmessage-vulnerabilities/)**.**
* [ ] Ako **Content Script pristupa DOM detaljima**, proverite da li **ne uvode XSS** ako ih **modifikuje** web
* [ ] Posebno naglasite ako je ova komunikacija takoÄ‘e ukljuÄena u **Content Script -> komunikaciju pozadinske skripte**
* [ ] **Osetljive informacije ne bi trebale biti pohranjene** unutar koda ekstenzije pretraÅ¾ivaÄa
* [ ] **Osetljive informacije ne bi trebale biti pohranjene** unutar memorije ekstenzije pretraÅ¾ivaÄa

## Alati

### [**Tarnish**](https://thehackerblog.com/tarnish/)

* Preuzima bilo koju Chrome ekstenziju sa datog linka Chrome veb prodavnice.
* [**manifest.json**](https://developer.chrome.com/extensions/manifest) **pregledaÄ**: jednostavno prikazuje JSON-formatiranu verziju manifest datoteke ekstenzije.
* **Analiza otiska**: Detekcija [web\_accessible\_resources](https://developer.chrome.com/extensions/manifest/web\_accessible\_resources) i automatska generacija JavaScript-a za otiskivanje Chrome ekstenzije.
* **Potencijalna analiza Clickjacking-a**: Detekcija HTML stranica ekstenzije sa postavljenom direktivom [web\_accessible\_resources](https://developer.chrome.com/extensions/manifest/web\_accessible\_resources). Ove su potencijalno ranjive na clickjacking u zavisnosti od svrhe stranica.
* **PregledaÄ upozorenja o dozvolama**: koji prikazuje listu svih upozorenja o dozvolama Chrome-a koja Ä‡e biti prikazana kada korisnik pokuÅ¡a da instalira ekstenziju.
* **Opasne funkcije**: prikazuje lokaciju opasnih funkcija koje bi potencijalno mogle biti iskoriÅ¡Ä‡ene od strane napadaÄa (npr. funkcije kao Å¡to su innerHTML, chrome.tabs.executeScript).
* **Ulazne taÄke**: prikazuje gde ekstenzija prima korisniÄki/eksterni ulaz. Ovo je korisno za razumevanje povrÅ¡ine ekstenzije i traÅ¾enje potencijalnih taÄaka za slanje zlonamerno oblikovanih podataka ekstenziji.
* I Dangerous Function(s) i Entry Point(s) skeneri imaju sledeÄ‡e za svoje generisane alarme:
* Relevantni deo koda i linija koja je izazvala alarm.
* Opis problema.
* Dugme "Pogledaj datoteku" za pregled celokupne izvorne datoteke koja sadrÅ¾i kod.
* Putanja alarmirane datoteke.
* Potpuni URI Chrome ekstenzije alarmirane datoteke.
* Tip datoteke, kao Å¡to su skripta pozadinske stranice, sadrÅ¾ajna skripta, akcija pretraÅ¾ivaÄa, itd.
* Ako je ranjiva linija u JavaScript datoteci, putanje svih stranica gde je ukljuÄena kao i tip ovih stranica, i status [web\_accessible\_resource](https://developer.chrome.com/extensions/manifest/web\_accessible\_resources).
* **Analizator politike sigurnosti sadrÅ¾aja (CSP) i proveravaÄ zaobilaÅ¾enja**: Ovo Ä‡e ukazati na slabosti u CSP-u vaÅ¡e ekstenzije i takoÄ‘e Ä‡e osvetliti sve potencijalne naÄine zaobilaÅ¾enja vaÅ¡eg CSP-a zbog belih lista CDN-ova, itd.
* **Poznate ranjive biblioteke**: Ovo koristi [Retire.js](https://retirejs.github.io/retire.js/) da proveri da li se koriste poznate ranjive JavaScript biblioteke.
* Preuzmite ekstenziju i formatirane verzije.
* Preuzmite originalnu ekstenziju.
* Preuzmite ulepÅ¡anu verziju ekstenzije (automatski formatirani HTML i JavaScript).
* Automatsko keÅ¡iranje rezultata skeniranja, pokretanje skeniranja ekstenzije Ä‡e potrajati neko vreme prvi put kada ga pokrenete. MeÄ‘utim, drugi put, pod pretpostavkom da ekstenzija nije aÅ¾urirana, biÄ‡e gotovo instant zbog keÅ¡iranih rezultata.
* Linkabilni URL-ovi izveÅ¡taja, lako poveÅ¾ite nekoga sa izveÅ¡tajem o ekstenziji generisanim od strane tarnish.

### [Neto](https://github.com/elevenpaths/neto)

Projekat Neto je Python 3 paket osmiÅ¡ljen za analizu i otkrivanje skrivenih funkcija ekstenzija i dodataka za poznate pretraÅ¾ivaÄe kao Å¡to su Firefox i Chrome. Automatizuje proces raspakivanja pakovanih datoteka kako bi izvukao ove funkcije iz relevantnih resursa u ekstenziji kao Å¡to su `manifest.json`, folderi za lokalizaciju ili JavaScript i HTML izvorne datoteke.

## Reference

* **ZahvaljujuÄ‡i** [**@naivenom**](https://twitter.com/naivenom) **za pomoÄ‡ sa ovom metodologijom**
* [https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing](https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing)
* [https://palant.info/2022/08/10/anatomy-of-a-basic-extension/](https://palant.info/2022/08/10/anatomy-of-a-basic-extension/)
* [https://palant.info/2022/08/24/attack-surface-of-extension-pages/](https://palant.info/2022/08/24/attack-surface-of-extension-pages/)
* [https://palant.info/2022/08/31/when-extension-pages-are-web-accessible/](https://palant.info/2022/08/31/when-extension-pages-are-web-accessible/)
* [https://help.passbolt.com/assets/files/PBL-02-report.pdf](https://help.passbolt.com/assets/files/PBL-02-report.pdf)
* [https://developer.chrome.com/docs/extensions/develop/concepts/content-scripts](https://developer.chrome.com/docs/extensions/develop/concepts/content-scripts)
* [https://developer.chrome.com/docs/extensions/mv2/background-pages](https://developer.chrome.com/docs/extensions/mv2/background-pages)
* [https://thehackerblog.com/kicking-the-rims-a-guide-for-securely-writing-and-auditing-chrome-extensions/](https://thehackerblog.com/kicking-the-rims-a-guide-for-securely-writing-and-auditing-chrome-extensions/)
* [https://gist.github.com/LongJohnCoder/9ddf5735df3a4f2e9559665fb864eac0](https://gist.github.com/LongJohnCoder/9ddf5735df3a4f2e9559665fb864eac0)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
