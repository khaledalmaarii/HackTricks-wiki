# Browser Extension Pentesting Methodology

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Osnovne informacije

ProÅ¡irenja pregledaÄa su napisana u JavaScript-u i uÄitavaju se od strane pregledaÄa u pozadini. Imaju svoj [DOM](https://www.w3schools.com/js/js\_htmldom.asp) ali mogu da interaguju sa DOM-ovima drugih sajtova. To znaÄi da mogu ugroziti poverljivost, integritet i dostupnost (CIA) drugih sajtova.

## Glavne komponente

Dizajn proÅ¡irenja izgleda najbolje kada je vizualizovan i sastoji se od tri komponente. Pogledajmo svaku komponentu detaljnije.

<figure><img src="../../.gitbook/assets/image (4) (1).png" alt=""><figcaption><p><a href="http://webblaze.cs.berkeley.edu/papers/Extensions.pdf">http://webblaze.cs.berkeley.edu/papers/Extensions.pdf</a></p></figcaption></figure>

### **Skripte sadrÅ¾aja**

Svaka skripta sadrÅ¾aja ima direktni pristup DOM-u **jedne veb stranice** i time je izloÅ¾ena **potencijalno zlonamernom unosu**. MeÄ‘utim, skripta sadrÅ¾aja ne sadrÅ¾i dozvole osim moguÄ‡nosti slanja poruka jezgru proÅ¡irenja.

### **Jezgro proÅ¡irenja**

Jezgro proÅ¡irenja sadrÅ¾i veÄ‡inu privilegija/pristupa proÅ¡irenja, ali jezgro proÅ¡irenja moÅ¾e interagovati sa veb sadrÅ¾ajem samo putem [XMLHttpRequest](https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest) i skripti sadrÅ¾aja. TakoÄ‘e, jezgro proÅ¡irenja nema direktni pristup host maÅ¡ini.

### **Nativni binarni fajl**

ProÅ¡irenje omoguÄ‡ava nativni binarni fajl koji moÅ¾e **pristupiti host maÅ¡ini sa punim privilegijama korisnika.** Nativni binarni fajl interaguje sa jezgrom proÅ¡irenja putem standardnog Netscape Plugin Application Programming Interface ([NPAPI](https://en.wikipedia.org/wiki/NPAPI)) koji koristi Flash i druge dodatke pregledaÄa.

### Granice

{% hint style="danger" %}
Da bi dobio puna korisniÄka prava, napadaÄ mora ubediti proÅ¡irenje da prosledi zlonamerni unos iz skripte sadrÅ¾aja jezgru proÅ¡irenja i iz jezgra proÅ¡irenja nativnom binarnom fajlu.
{% endhint %}

Svaka komponenta proÅ¡irenja je odvojena jedna od druge **jakim zaÅ¡titnim granicama**. Svaka komponenta se izvrÅ¡ava u **zasebnom operativnom procesu**. Skripte sadrÅ¾aja i jezgra proÅ¡irenja se izvrÅ¡avaju u **peskovitim procesima** nedostupnim veÄ‡ini usluga operativnog sistema.

Pored toga, skripte sadrÅ¾aja su odvojene od svojih povezanih veb stranica **izvrÅ¡avanjem u zasebnom JavaScript hipu**. Skripta sadrÅ¾aja i veb stranica imaju **pristup istom osnovnom DOM-u**, ali se **nikada ne razmenjuju JavaScript pokazivaÄi**, Äime se spreÄava curenje JavaScript funkcionalnosti.

## **`manifest.json`**

Chrome proÅ¡irenje je samo ZIP folder sa [.crx ekstenzijom fajla](https://www.lifewire.com/crx-file-2620391). Jezgro proÅ¡irenja je **`manifest.json`** fajl u korenu foldera, koji specificira dizajn, dozvole i druge konfiguracione opcije.

Primer:

```json
{
"manifest_version": 2,
"name": "My extension",
"version": "1.0",
"permissions": [
"storage"
],
"content_scripts": [
{
"js": [
"script.js"
],
"matches": [
"https://example.com/*",
"https://www.example.com/*"
],
"exclude_matches": ["*://*/*business*"],
}
],
"background": {
"scripts": [
"background.js"
]
},
"options_ui": {
"page": "options.html"
}
}
```

### `content_scripts`

Content skripte se **uÄitavaju** svaki put kada korisnik **navigira na odgovarajuÄ‡u stranicu**, u naÅ¡em sluÄaju bilo koju stranicu koja se podudara sa izrazom **`https://example.com/*`** i ne podudara se sa **`*://*/*/business*`** regexom. Oni se izvrÅ¡avaju **kao skripte same stranice** i imaju proizvoljan pristup [Document Object Model (DOM)](https://developer.mozilla.org/en-US/docs/Web/API/Document\_Object\_Model) stranice.

```json
"content_scripts": [
{
"js": [
"script.js"
],
"matches": [
"https://example.com/*",
"https://www.example.com/*"
],
"exclude_matches": ["*://*/*business*"],
}
],
```

Da biste ukljuÄili ili iskljuÄili viÅ¡e URL-ova, takoÄ‘e je moguÄ‡e koristiti **`include_globs`** i **`exclude_globs`**.

Ovo je primer skripte sadrÅ¾aja koja Ä‡e dodati dugme za objaÅ¡njenje na stranici kada [API za skladiÅ¡tenje](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/storage) koristi se za dobijanje vrednosti `message` iz skladiÅ¡ta proÅ¡irenja.

```js
chrome.storage.local.get("message", result =>
{
let div = document.createElement("div");
div.innerHTML = result.message + " <button>Explain</button>";
div.querySelector("button").addEventListener("click", () =>
{
chrome.runtime.sendMessage("explain");
});
document.body.appendChild(div);
});
```

<figure><img src="../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

Kada se klikne na ovaj dugme, sadrÅ¾ajni skript Å¡alje poruku stranicama proÅ¡irenja, koriÅ¡Ä‡enjem [**API-ja runtime.sendMessage()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/runtime/sendMessage). Ovo je zbog ograniÄenja sadrÅ¾ajnog skripta u direktnom pristupu API-ima, pri Äemu je `storage` meÄ‘u retkim izuzecima. Za funkcionalnosti van ovih izuzetaka, poruke se Å¡alju stranicama proÅ¡irenja sa kojima sadrÅ¾ajni skriptovi mogu komunicirati.

{% hint style="warning" %}
Zavisno od pretraÅ¾ivaÄa, moguÄ‡nosti sadrÅ¾ajnog skripta mogu se malo razlikovati. Za pretraÅ¾ivaÄe zasnovane na Chromium-u, lista moguÄ‡nosti dostupna je u [Chrome Developers dokumentaciji](https://developer.chrome.com/docs/extensions/mv3/content\_scripts/#capabilities), a za Firefox, [MDN](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/Content\_scripts#webextension\_apis) sluÅ¾i kao primarni izvor.\
TakoÄ‘e je vaÅ¾no napomenuti da sadrÅ¾ajni skriptovi imaju moguÄ‡nost komunikacije sa pozadinskim skriptovima, omoguÄ‡avajuÄ‡i im da izvrÅ¡e radnje i prenesu odgovore nazad.
{% endhint %}

Za pregledanje i debagovanje sadrÅ¾ajnih skriptova u Chrome-u, meni Chrome developer alatki moÅ¾e se pristupiti putem Opcije > ViÅ¡e alatki > Developer alatke ILI pritiskom na Ctrl + Shift + I.

Kada se prikaÅ¾u developer alatke, treba kliknuti na **Tab izvora**, a zatim na **Tab sadrÅ¾ajnih skriptova**. Ovo omoguÄ‡ava posmatranje pokrenutih sadrÅ¾ajnih skriptova iz razliÄitih proÅ¡irenja i postavljanje taÄaka prekida za praÄ‡enje toka izvrÅ¡enja.

### Ubaceni sadrÅ¾ajni skriptovi

{% hint style="success" %}
Imajte na umu da **SadrÅ¾ajni skriptovi nisu obavezni** jer je takoÄ‘e moguÄ‡e **dinamiÄki** **ubaciti** skripte i **programatski ih ubaciti** na web stranice putem **`tabs.executeScript`**. Ovo zapravo pruÅ¾a viÅ¡e **granularnih kontrola**.
{% endhint %}

Za programatsko ubacivanje sadrÅ¾ajnog skripta, proÅ¡irenju je potrebno imati [dozvole domaÄ‡ina](https://developer.chrome.com/docs/extensions/reference/permissions) za stranicu u koju se skriptovi ubacuju. Ove dozvole mogu se obezbediti ili **zahtevanjem** u manifestu proÅ¡irenja ili privremeno putem [**activeTab**](https://developer.chrome.com/docs/extensions/reference/manifest/activeTab).

#### Primer proÅ¡irenja zasnovanog na activeTab-u

{% code title="manifest.json" %}
```json
{
"name": "My extension",
...
"permissions": [
"activeTab",
"scripting"
],
"background": {
"service_worker": "background.js"
},
"action": {
"default_title": "Action Button"
}
}
```
{% endcode %}

* **Ubacivanje JS datoteke prilikom klika:**

```javascript
// content-script.js
document.body.style.backgroundColor = "orange";

//service-worker.js - Inject the JS file
chrome.action.onClicked.addListener((tab) => {
chrome.scripting.executeScript({
target: { tabId: tab.id },
files: ["content-script.js"]
});
});
```

* **Umetni funkciju** prilikom klika:

```javascript
//service-worker.js - Inject a function
function injectedFunction() {
document.body.style.backgroundColor = "orange";
}

chrome.action.onClicked.addListener((tab) => {
chrome.scripting.executeScript({
target : {tabId : tab.id},
func : injectedFunction,
});
});
```

#### Primer sa dozvolama za skriptovanje

```javascript
// service-workser.js
chrome.scripting.registerContentScripts([{
id : "test",
matches : [ "https://*.example.com/*" ],
excludeMatches : [ "*://*/*business*" ],
js : [ "contentScript.js" ],
}]);

// Another example
chrome.tabs.executeScript(tabId, { file: "content_script.js" });
```

### UkljuÄivanje ili iskljuÄivanje dodatnih URL-ova takoÄ‘e je moguÄ‡e koristiti **`include_globs`** i **`exclude_globs`**.

### Skripte sadrÅ¾aja `run_at`

Polje `run_at` kontroliÅ¡e **kada se JavaScript fajlovi ubacuju u web stranicu**. Preferirana i podrazumevana vrednost je `"document_idle"`.

MoguÄ‡e vrednosti su:

* **`document_idle`**: Kada god je moguÄ‡e
* **`document_start`**: Nakon bilo kojih fajlova iz `css`, ali pre nego Å¡to je konstruisan bilo koji drugi DOM ili pokrenut bilo koji drugi skript.
* **`document_end`**: Odmah nakon Å¡to je DOM kompletiran, ali pre nego Å¡to su se uÄitali podresursi poput slika i frejmova.

#### Putem `manifest.json`

```json
{
"name": "My extension",
...
"content_scripts": [
{
"matches": ["https://*.example.com/*"],
"run_at": "document_idle",
"js": ["contentScript.js"]
}
],
...
}

```

Preko **`service-worker.js`**

```javascript
chrome.scripting.registerContentScripts([{
id : "test",
matches : [ "https://*.example.com/*" ],
runAt : "document_idle",
js : [ "contentScript.js" ],
}]);
```

### `pozadina`

Poruke poslate od strane skriptova sadrÅ¾aja primaju se od strane **pozadinske stranice**, koja ima centralnu ulogu u koordinaciji komponenti proÅ¡irenja. Posebno, pozadinska stranica perzistira tokom trajanja proÅ¡irenja, delujuÄ‡i diskretno bez direktnog korisniÄkog interakcije. Poseduje svoj Document Object Model (DOM), omoguÄ‡avajuÄ‡i kompleksne interakcije i upravljanje stanjem.

**KljuÄne taÄke**:

* **Uloga pozadinske stranice:** Deluje kao nervni centar proÅ¡irenja, osiguravajuÄ‡i komunikaciju i koordinaciju meÄ‘u razliÄitim delovima proÅ¡irenja.
* **Perzistencija:** Predstavlja stalnu entitet, nevidljiv korisniku ali integralan za funkcionalnost proÅ¡irenja.
* **Automatsko generisanje:** Ako nije eksplicitno definisana, pretraÅ¾ivaÄ Ä‡e automatski kreirati pozadinsku stranicu. Ova automatski generisana stranica Ä‡e ukljuÄiti sve pozadinske skripte navedene u manifestu proÅ¡irenja, osiguravajuÄ‡i besprekorno funkcionisanje pozadinskih zadataka proÅ¡irenja.

{% hint style="success" %}
PraktiÄnost koju pruÅ¾a pretraÅ¾ivaÄ u automatskom generisanju pozadinske stranice (kada nije eksplicitno navedeno) osigurava da su sve neophodne pozadinske skripte integrisane i operativne, olakÅ¡avajuÄ‡i proces postavljanja proÅ¡irenja.
{% endhint %}

Primer pozadinske skripte:

```js
chrome.runtime.onMessage.addListener((request, sender, sendResponse) =>
{
if (request == "explain")
{
chrome.tabs.create({ url: "https://example.net/explanation" });
}
})
```

Koristi [runtime.onMessage API](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/runtime/onMessage) da bi osluÅ¡kivao poruke. Kada primi poruku `"explain"`, koristi [tabs API](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs) da otvori stranicu u novom tabu.

Za debagovanje pozadinskog skripta moÅ¾ete otvoriti **detalje proÅ¡irenja i inspekciju servisnog radnika**, Å¡to Ä‡e otvoriti alatke za razvoj sa pozadinskim skriptom:

<figure><img src="https://github.com/carlospolop/hacktricks/blob/rs/pentesting-web/browser-extension-pentesting-methodology/broken-reference" alt=""><figcaption></figcaption></figure>

### Stranice sa opcijama i ostalo

Browser proÅ¡irenja mogu sadrÅ¾ati razliÄite vrste stranica:

* **Stranice akcija** se prikazuju u **padajuÄ‡em meniju kada se klikne ikona proÅ¡irenja**.
* Stranice koje Ä‡e se **uÄitati u novom tabu**.
* **Stranice opcija**: Ova stranica se prikazuje iznad proÅ¡irenja kada se klikne. U prethodnom manifestu u mom sluÄaju mogao sam pristupiti ovoj stranici na `chrome://extensions/?options=fadlhnelkbeojnebcbkacjilhnbjfjca` ili klikom na:

<figure><img src="../../.gitbook/assets/image (8).png" alt="" width="375"><figcaption></figcaption></figure>

Imajte na umu da ove stranice nisu trajne poput pozadinskih stranica jer dinamiÄki uÄitavaju sadrÅ¾aj po potrebi. Ipak, dele odreÄ‘ene moguÄ‡nosti sa pozadinskom stranicom:

* **Komunikacija sa skriptovima sadrÅ¾aja:** SliÄno kao pozadinska stranica, ove stranice mogu primati poruke od skriptova sadrÅ¾aja, olakÅ¡avajuÄ‡i interakciju unutar proÅ¡irenja.
* **Pristup API-jima specifiÄnim za proÅ¡irenje:** Ove stranice imaju sveobuhvatan pristup API-jima specifiÄnim za proÅ¡irenje, podloÅ¾an dozvolama definisanim za proÅ¡irenje.

### `permissions` & `host_permissions`

**`permissions`** i **`host_permissions`** su unosi iz `manifest.json` koji Ä‡e ukazati na **koje dozvole** browser proÅ¡irenje ima (skladiÅ¡te, lokacija...) i na **kojim veb stranicama**.

Kako browser proÅ¡irenja mogu biti tako **privilegovana**, zlonamerno proÅ¡irenje ili ono koje je kompromitovano moÅ¾e omoguÄ‡iti napadaÄu **razliÄite naÄine za kraÄ‘u osetljivih informacija i Å¡pijuniranje korisnika**.

Proverite kako ove postavke funkcioniÅ¡u i kako mogu biti zloupotrebljene u:

{% content-ref url="browext-permissions-and-host_permissions.md" %}
[browext-permissions-and-host\_permissions.md](browext-permissions-and-host\_permissions.md)
{% endcontent-ref %}

### `content_security_policy`

**Politika bezbednosti sadrÅ¾aja** takoÄ‘e moÅ¾e biti deklarisana unutar `manifest.json`. Ako je definisana, moÅ¾e biti **ranjiva**.

Podrazumevana postavka za stranice browser proÅ¡irenja je priliÄno restriktivna:

```bash
script-src 'self'; object-src 'self';
```

Za viÅ¡e informacija o CSP i potencijalnim obilascima proverite:

{% content-ref url="../content-security-policy-csp-bypass/" %}
[content-security-policy-csp-bypass](../content-security-policy-csp-bypass/)
{% endcontent-ref %}

### `web_accessible_resources`

da bi veb stranica mogla da pristupi stranici Browser Extension-a, na primer `.html` stranici, ova stranica mora biti navedena u polju **`web_accessible_resources`** u `manifest.json` fajlu.\
Na primer:

```javascript
{
...
"web_accessible_resources": [
{
"resources": [ "images/*.png" ],
"matches": [ "https://example.com/*" ]
},
{
"resources": [ "fonts/*.woff" ],
"matches": [ "https://example.com/*" ]
}
],
...
}
```

Ove stranice su dostupne na URL-u poput:

```
chrome-extension://<extension-id>/message.html
```

U javnim proÅ¡irenjima **id proÅ¡irenja je dostupno**:

<figure><img src="../../.gitbook/assets/image (722).png" alt="" width="375"><figcaption></figcaption></figure>

MeÄ‘utim, ako se koristi parametar `manifest.json` **`use_dynamic_url`**, ovaj **id moÅ¾e biti dinamiÄan**.

Dozvola pristupa ovim stranicama Äini ih **potencijalno ranjivim na ClickJacking**:

{% content-ref url="browext-clickjacking.md" %}
[browext-clickjacking.md](browext-clickjacking.md)
{% endcontent-ref %}

{% hint style="success" %}
Dozvoljavanje uÄitavanja ovih stranica samo od strane proÅ¡irenja, a ne od nasumiÄnih URL-ova, moglo bi spreÄiti CLickJacking napade.
{% endhint %}

### `externally_connectable`

Prema [**dokumentaciji**](https://developer.chrome.com/docs/extensions/reference/manifest/externally-connectable), manifest svojstvo `"externally_connectable"` deklariÅ¡e **koja proÅ¡irenja i web stranice mogu da se poveÅ¾u** sa vaÅ¡im proÅ¡irenjem putem [runtime.connect](https://developer.chrome.com/docs/extensions/reference/runtime#method-connect) i [runtime.sendMessage](https://developer.chrome.com/docs/extensions/reference/runtime#method-sendMessage).

* Ako **kljuÄ `externally_connectable`** nije deklarisan u manifestu vaÅ¡eg proÅ¡irenja ili je deklarisan kao **`"ids": ["*"]`**, **sva proÅ¡irenja mogu da se poveÅ¾u, ali nijedna web stranica ne moÅ¾e da se poveÅ¾e**.
* Ako su navedeni **specifiÄni ID-jevi**, kao u `"ids": ["aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"]`, **samo te aplikacije** mogu da se poveÅ¾u.
* Ako su navedeni **odgovarajuÄ‡i uslovi**, te veb aplikacije Ä‡e moÄ‡i da se poveÅ¾u:

```json
"matches": [
"https://*.google.com/*",
"*://*.chromium.org/*",
```

* Ako je navedeno kao prazno: **`"externally_connectable": {}`**, nijedna aplikacija ili veb stranica neÄ‡e moÄ‡i da se poveÅ¾e.

Å to je manje ekstenzija i URL-ova navedeno ovde, to Ä‡e povrÅ¡ina napada biti manja.

{% hint style="danger" %}
Ako je veb stranica ranjiva na XSS ili preuzimanje kontrole navedena u **`externally_connectable`**, napadaÄ Ä‡e moÄ‡i da Å¡alje poruke direktno skripti pozadine, potpuno zaobilazeÄ‡i Skriptu sadrÅ¾aja i njegovu CSP.

Stoga, ovo je veoma moÄ‡na zaobilaznica.

Å taviÅ¡e, ako klijent instalira zlonamernu ekstenziju, Äak i ako mu nije dozvoljeno da komunicira sa ranjivom ekstenzijom, mogla bi da ubaci XSS podatke na dozvoljenu veb stranicu ili zloupotrebi `WebRequest` ili `DeclarativeNetRequest` API-jeve da manipuliÅ¡e zahtevima na ciljanoj domeni menjajuÄ‡i zahtev za JavaScript fajl na stranici. (Imajte na umu da CSP na ciljanoj stranici moÅ¾e da spreÄi ove napade). Ova ideja potiÄe [**iz ovog teksta**](https://www.darkrelay.com/post/opera-zero-day-rce-vulnerability).
{% endhint %}

##

## Komunikacija izmeÄ‘u veb stranice **â†”ï¸** Skripte sadrÅ¾aja

OkruÅ¾enja u kojima **skripte sadrÅ¾aja** funkcioniÅ¡u i gde postoje stranice domaÄ‡ini su **odvojena** jedno od drugog, obezbeÄ‘ujuÄ‡i **izolaciju**. Uprkos ovoj izolaciji, oba imaju moguÄ‡nost da interaguju sa **Document Object Model (DOM)** stranice, deljenim resursom. Da bi stranica domaÄ‡in stupila u komunikaciju sa **skriptom sadrÅ¾aja**, ili indirektno sa ekstenzijom preko skripte sadrÅ¾aja, potrebno je koristiti **DOM** koji je dostupan obema stranama kao kanal komunikacije.

### Poruke Post

{% code title="content-script.js" %}
```javascript
var port = chrome.runtime.connect();

window.addEventListener("message", (event) => {
// We only accept messages from ourselves
if (event.source !== window) {
return;
}

if (event.data.type && (event.data.type === "FROM_PAGE")) {
console.log("Content script received: " + event.data.text);
port.postMessage(event.data.text);
}
}, false);
```
{% endcode %}

{% code title="primer.js" %}
```javascript
document.getElementById("theButton").addEventListener("click", () => {
window.postMessage(
{type : "FROM_PAGE", text : "Hello from the webpage!"}, "*");
}, false);
```
{% endcode %}

Bezbedna komunikacija putem Post Message-a treba da proveri autentiÄnost primljene poruke, ovo se moÅ¾e uraditi proverom:

* **`event.isTrusted`**: Ovo je taÄno samo ako je dogaÄ‘aj pokrenut akcijom korisnika
* Content skript moÅ¾e oÄekivati poruku samo ako korisnik izvrÅ¡i neku akciju
* **Poreklo domena**: moÅ¾e oÄekivati poruku samo od liste odobrenih domena.
* Ako se koristi regex, budite veoma oprezni
* **Izvor**: `received_message.source !== window` moÅ¾e se koristiti da se proveri da li je poruka **sa istog prozora** gde Content skripta sluÅ¡a.

Prethodne provere, Äak i ako su izvrÅ¡ene, mogu biti ranjive, pa proverite na sledeÄ‡oj stranici **potencijalne Post Message obilaske**:

{% content-ref url="../postmessage-vulnerabilities/" %}
[postmessage-vulnerabilities](../postmessage-vulnerabilities/)
{% endcontent-ref %}

### Iframe

JoÅ¡ jedan moguÄ‡i naÄin komunikacije moÅ¾e biti putem **Iframe URL-ova**, moÅ¾ete pronaÄ‡i primer u:

{% content-ref url="browext-xss-example.md" %}
[browext-xss-example.md](browext-xss-example.md)
{% endcontent-ref %}

### DOM

Ovo nije "taÄno" naÄin komunikacije, ali **web i content skripta Ä‡e imati pristup web DOM-u**. Dakle, ako **content skripta** Äita neke informacije iz njega, **verujuÄ‡i web DOM-u**, web bi mogao **modifikovati te podatke** (jer web ne bi trebalo da se veruje, ili jer je web ranjiv na XSS) i **ugroziti Content skriptu**.

TakoÄ‘e moÅ¾ete pronaÄ‡i primer **DOM baziranog XSS-a za ugroÅ¾avanje browser ekstenzije** u:

{% content-ref url="browext-xss-example.md" %}
[browext-xss-example.md](browext-xss-example.md)
{% endcontent-ref %}

## Osetljive informacije u memoriji/kodu

Ako Browser ekstenzija Äuva **osetljive informacije unutar svoje memorije**, ovo bi moglo biti **izloÅ¾eno** (posebno na Windows maÅ¡inama) i **pretraÅ¾eno** za ovim informacijama.

Stoga, memorija Browser ekstenzije **ne bi trebalo da se smatra bezbednom** i **osetljive informacije** kao Å¡to su kredencijali ili mnemoniÄke fraze **ne bi trebalo da se Äuvaju**.

Naravno, **ne stavljajte osetljive informacije u kod**, jer Ä‡e biti **javne**.

## Komunikacija Content skripte **â†”ï¸** Background skripta

Content skripta moÅ¾e koristiti funkcije [**runtime.sendMessage()**](https://developer.chrome.com/docs/extensions/reference/runtime#method-sendMessage) **ili** [**tabs.sendMessage()**](https://developer.chrome.com/docs/extensions/reference/tabs#method-sendMessage) da poÅ¡alje **jednokratnu JSON-serializabilnu** poruku.

Za rukovanje **odgovorom**, koristite vraÄ‡eni **Promise**. Iako, radi kompatibilnosti unazad, i dalje moÅ¾ete proslediti **callback** kao poslednji argument.

Slanje zahteva iz **content skripte** izgleda ovako:

```javascript
(async () => {
const response = await chrome.runtime.sendMessage({greeting: "hello"});
// do something with response here, not outside the function
console.log(response);
})();
```

Slanje zahteva iz **proÅ¡irenja** (obiÄno **pozadinskog skripta**) Skript sadrÅ¾aja moÅ¾e koristiti funkcije, osim Å¡to morate navesti na koji tab da ga poÅ¡aljete. Primer kako poslati poruku skriptu sadrÅ¾aja na izabranom tabu:

```javascript
// From https://stackoverflow.com/questions/36153999/how-to-send-a-message-between-chrome-extension-popup-and-content-script
(async () => {
const [tab] = await chrome.tabs.query({active: true, lastFocusedWindow: true});
const response = await chrome.tabs.sendMessage(tab.id, {greeting: "hello"});
// do something with response here, not outside the function
console.log(response);
})();
```

Na **primalacu**, treba da postavite [**runtime.onMessage**](https://developer.chrome.com/docs/extensions/reference/runtime#event-onMessage) **sluÅ¡aoca dogaÄ‘aja** da biste obradili poruku. Ovo izgleda isto iz sadrÅ¾ajnog skripta ili stranice proÅ¡irenja.

```javascript
// From https://stackoverflow.com/questions/70406787/javascript-send-message-from-content-js-to-background-js
chrome.runtime.onMessage.addListener(
function(request, sender, sendResponse) {
console.log(sender.tab ?
"from a content script:" + sender.tab.url :
"from the extension");
if (request.greeting === "hello")
sendResponse({farewell: "goodbye"});
}
);
```

U prikazanom primeru, **`sendResponse()`** je izvrÅ¡en sinhrono. Da biste izmenili `onMessage` dogaÄ‘ajni rukovalac za asinhrono izvrÅ¡avanje `sendResponse()`, imperativno je ukljuÄiti `return true;`.

VaÅ¾no je imati na umu da u scenarijima gde je viÅ¡e stranica postavljeno da primaju `onMessage` dogaÄ‘aje, **prva stranica koja izvrÅ¡i `sendResponse()`** za odreÄ‘eni dogaÄ‘aj Ä‡e biti jedina sposobna da efikasno dostavi odgovor. Svi naknadni odgovori na isti dogaÄ‘aj neÄ‡e biti uzeti u obzir.

Prilikom kreiranja novih proÅ¡irenja, prednost treba dati promisima umesto povratnim pozivima. Å to se tiÄe koriÅ¡Ä‡enja povratnih poziva, funkcija `sendResponse()` se smatra validnom samo ako se izvrÅ¡ava direktno unutar sinhronog konteksta, ili ako rukovalac dogaÄ‘aja oznaÄava asinhronu operaciju vraÄ‡anjem `true`. Ukoliko nijedan od rukovalaca ne vrati `true` ili ako se funkcija `sendResponse()` ukloni iz memorije (sakupljena od smeÄ‡a), podrazumevano Ä‡e biti pokrenut povratni poziv povezan sa funkcijom `sendMessage()`.

## UÄitavanje proÅ¡irenja u pregledaÄu

1. **Preuzmite** Browser Extension & raspakujte
2. Idite na **`chrome://extensions/`** i **omoguÄ‡ite** `Developer Mode`
3. Kliknite na dugme **`Load unpacked`**

U **Firefox-u** idite na **`about:debugging#/runtime/this-firefox`** i kliknite na dugme **`Load Temporary Add-on`**.

## Dobijanje izvornog koda iz prodavnice

Izvorni kod Chrome proÅ¡irenja moÅ¾e se dobiti putem razliÄitih metoda. U nastavku su detaljna objaÅ¡njenja i uputstva za svaku opciju.

### Preuzimanje proÅ¡irenja kao ZIP putem komandne linije

Izvorni kod Chrome proÅ¡irenja moÅ¾e se preuzeti kao ZIP datoteka koriÅ¡Ä‡enjem komandne linije. To ukljuÄuje koriÅ¡Ä‡enje `curl`-a za preuzimanje ZIP datoteke sa odreÄ‘enog URL-a, a zatim izvlaÄenje sadrÅ¾aja ZIP datoteke u direktorijum. Evo koraka:

1. Zamenite `"extension_id"` sa stvarnim ID-om proÅ¡irenja.
2. IzvrÅ¡ite sledeÄ‡e komande:

```bash
extension_id=your_extension_id   # Replace with the actual extension ID
curl -L -o "$extension_id.zip" "https://clients2.google.com/service/update2/crx?response=redirect&os=mac&arch=x86-64&nacl_arch=x86-64&prod=chromecrx&prodchannel=stable&prodversion=44.0.2403.130&x=id%3D$extension_id%26uc"
unzip -d "$extension_id-source" "$extension_id.zip"
```

### Koristite veb sajt CRX Viewer

[https://robwu.nl/crxviewer/](https://robwu.nl/crxviewer/)

### Koristite CRX Viewer ekstenziju

JoÅ¡ jedan praktiÄan metod je koriÅ¡Ä‡enje Chrome Extension Source Viewer, koji je open-source projekat. MoÅ¾e se instalirati sa [Chrome Web prodavnice](https://chrome.google.com/webstore/detail/chrome-extension-source-v/jifpbeccnghkjeaalbbjmodiffmgedin?hl=en). Izvorni kod pregledaÄa je dostupan u njegovom [GitHub repozitorijumu](https://github.com/Rob--W/crxviewer).

### Pregled izvora lokalno instalirane ekstenzije

Chrome ekstenzije instalirane lokalno takoÄ‘e mogu biti pregledane. Evo kako:

1. Pristupite svom Chrome lokalnom profilu posetom `chrome://version/` i pronalaÅ¾enjem polja "Profile Path".
2. Navigirajte do `Extensions/` podfoldera unutar profila.
3. Ovaj folder sadrÅ¾i sve instalirane ekstenzije, obiÄno sa njihovim izvornim kodom u Äitljivom formatu.

Da biste identifikovali ekstenzije, moÅ¾ete mapirati njihove ID-jeve sa imenima:

* OmoguÄ‡ite Developer Mode na stranici `about:extensions` da biste videli ID-jeve svake ekstenzije.
* Unutar svakog foldera ekstenzije, fajl `manifest.json` sadrÅ¾i Äitljivo polje `name`, Å¡to vam pomaÅ¾e da identifikujete ekstenziju.

### Koristite Arhiver ili Dekompresor fajlova

Idite na Chrome Web prodavnicu i preuzmite ekstenziju. Fajl Ä‡e imati ekstenziju `.crx`. Promenite ekstenziju fajla sa `.crx` na `.zip`. Koristite bilo koji arhiver fajlova (kao Å¡to su WinRAR, 7-Zip, itd.) da biste izvukli sadrÅ¾aj ZIP fajla.

### Koristite Developer Mode u Chrome-u

Otvorite Chrome i idite na `chrome://extensions/`. OmoguÄ‡ite "Developer mode" u gornjem desnom uglu. Kliknite na "Load unpacked extension...". Navigirajte do direktorijuma vaÅ¡e ekstenzije. Ovo ne preuzima izvorni kod, ali je korisno za pregledanje i modifikaciju koda veÄ‡ preuzete ili razvijene ekstenzije.

## Lista za proveru bezbednosti

Iako Browser ekstenzije imaju **ograniÄenu povrÅ¡inu napada**, neke od njih mogu sadrÅ¾ati **ranjivosti** ili **potencijalna poboljÅ¡anja uÄvrÅ¡Ä‡ivanja**. SledeÄ‡e su najÄeÅ¡Ä‡e:

* [ ] **OgraniÄite** Å¡to je viÅ¡e moguÄ‡e traÅ¾ene **`dozvole`**
* [ ] **OgraniÄite** Å¡to je viÅ¡e moguÄ‡e **`host_permissions`**
* [ ] Koristite **jak** **`content_security_policy`**
* [ ] **OgraniÄite** Å¡to je viÅ¡e moguÄ‡e **`externally_connectable`**, ako nije potrebno i moguÄ‡e, ne ostavljajte ga podrazumevano, specificirajte **`{}`**
* [ ] Ako je ovde naveden **URL ranjiv na XSS ili preuzimanje kontrole**, napadaÄ Ä‡e moÄ‡i **slati poruke direktno skriptovima pozadine**. Veoma moÄ‡an zaobilazak.
* [ ] **OgraniÄite** Å¡to je viÅ¡e moguÄ‡e **`web_accessible_resources`**, Äak i prazno ako je moguÄ‡e.
* [ ] Ako **`web_accessible_resources`** nije niÅ¡ta, proverite [**ClickJacking**](browext-clickjacking.md)
* [ ] Ako se vrÅ¡i bilo kakva **komunikacija** izmeÄ‘u **ekstenzije** i **veb stranice**, [**proverite XSS**](browext-xss-example.md) **ranjivosti** izazvane u komunikaciji.
* [ ] Ako se koriste Post poruke, proverite [**Post Message ranjivosti**](../postmessage-vulnerabilities/)**.**
* [ ] Ako **Content Script pristupa detaljima DOM-a**, proverite da li oni **ne uvode XSS** ako ih veb **modifikuje**
* [ ] Posebno obratite paÅ¾nju ako je ova komunikacija takoÄ‘e ukljuÄena u **komunikaciju Content Script -> Skripta pozadine**
* [ ] **Osetljive informacije ne bi trebalo da se Äuvaju** unutar koda Browser Ekstenzije
* [ ] **Osetljive informacije ne bi trebalo da se Äuvaju** unutar memorije Browser Ekstenzije

## Alati

### [**Tarnish**](https://thehackerblog.com/tarnish/)

* IzvlaÄi bilo koju Chrome ekstenziju sa pruÅ¾enog Chrome web prodavnice linka.
* [**manifest.json**](https://developer.chrome.com/extensions/manifest) **pregledaÄ**: jednostavno prikazuje JSON-oblikovanu verziju manifesta ekstenzije.
* **Analiza otiska prsta**: Detekcija [web\_accessible\_resources](https://developer.chrome.com/extensions/manifest/web\_accessible\_resources) i automatsko generisanje JavaScript otiska prsta Chrome ekstenzije.
* **Potencijalna analiza Clickjacking-a**: Detekcija HTML stranica ekstenzije sa direktivom [web\_accessible\_resources](https://developer.chrome.com/extensions/manifest/web\_accessible\_resources). Ove stranice su potencijalno ranjive na clickjacking u zavisnosti od svrhe stranica.
* **Pregled upozorenja dozvola**: koji prikazuje listu svih upozorenja dozvola Chrome-a koja Ä‡e biti prikazana prilikom pokuÅ¡aja korisnika da instalira ekstenziju.
* **Opasne funkcije**: prikazuje lokaciju opasnih funkcija koje bi mogle biti iskoriÅ¡Ä‡ene od strane napadaÄa (npr. funkcije poput innerHTML, chrome.tabs.executeScript).
* **Ulazne taÄke**: pokazuje gde ekstenzija prima korisniÄki/spoljni unos. Ovo je korisno za razumevanje povrÅ¡ine ekstenzije i traÅ¾enje potencijalnih taÄaka za slanje zlonamerno oblikovanih podataka ekstenziji.
* I skeneri Opasnih funkcija i Ulaznih taÄaka imaju sledeÄ‡e za njihove generisane upozorenja:
* Relevantan odlomak koda i linija koja je izazvala upozorenje.
* Opis problema.
* Dugme "PrikaÅ¾i fajl" za pregled celog izvornog fajla koji sadrÅ¾i kod.
* Putanja upozorenog fajla.
* Potpuna URI Chrome ekstenzije upozorenog fajla.
* Tip fajla, kao Å¡to je skripta pozadine, skripta sadrÅ¾aja, akcija pregledaÄa, itd.
* Ako je ranjiva linija u JavaScript fajlu, putanje svih stranica gde je ukljuÄena kao i status [web\_accessible\_resource](https://developer.chrome.com/extensions/manifest/web\_accessible\_resources) ovih stranica.
* **Analizator i provera zaobilaÅ¾enja Politike bezbednosti sadrÅ¾aja (CSP)**: Ovo Ä‡e ukazati na slabosti u CSP vaÅ¡e ekstenzije i takoÄ‘e osvetliti bilo koje potencijalne naÄine zaobilaÅ¾enja vaÅ¡eg CSP-a zbog belih CDN-ova, itd.
* **Poznate ranjive biblioteke**: Koristi [Retire.js](https://retirejs.github.io/retire.js/) da proveri da li se koristi poznate ranjive JavaScript biblioteke.
* Preuzmite ekstenziju i formatirane verzije.
* Preuzmite originalnu ekstenziju.
* Preuzmite prelepu verziju ekstenzije (automatski oblikovan HTML i JavaScript).
* Automatsko keÅ¡iranje rezultata skeniranja, pokretanje skeniranja ekstenzije Ä‡e trajati dosta vremena prvi put kada ga pokrenete. MeÄ‘utim, drugi put, pod uslovom da ekstenzija nije aÅ¾urirana, biÄ‡e gotovo trenutno zbog keÅ¡iranja rezultata.
* Linkabilni URL-ovi izveÅ¡taja, lako poveÅ¾ite nekoga sa izveÅ¡tajem o ekstenziji generisanim od strane tarnish-a.

### [Neto](https://github.com/elevenpaths/neto)

Projekat Neto je Python 3 paket osmiÅ¡ljen za analizu i otkrivanje skrivenih funkcija browser dodataka i ekstenzija za poznate pregledaÄe poput Firefox-a i Chrome-a. Automatizuje proces otpakivanja zapakovanih fajlova kako bi izvukao ove funkcije iz relevantnih resursa u ekstenziji poput `manifest.json`, lokalizacionih foldera ili JavaScript i HTML izvornih fajlova.

## Reference

* **Hvala** [**@naivenom**](https://twitter.com/naivenom) **na pomoÄ‡i sa ovom metodologijom**
* [https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing](https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing)
* [https://palant.info/2022/08/10/anatomy-of-a-basic-extension/](https://palant.info/2022/08/10/anatomy-of-a-basic-extension/)
* [https://palant.info/2022/08/24/attack-surface-of-extension-pages/](https://palant.info/2022/08/24/attack-surface-of-extension-pages/)
* [https://palant.info/2022/08/31/when-extension-pages-are-web-accessible/](https://palant.info/2022/08/31/when-extension-pages-are-web-accessible/)
* [https://help.passbolt.com/assets/files/PBL-02-report.pdf](https://help.passbolt.com/assets/files/PBL-02-report.pdf)
* [https://developer.chrome.com/docs/extensions/develop/concepts/content-scripts](https://developer.chrome.com/docs/extensions/develop/concepts/content-scripts)
* [https://developer.chrome.com/docs/extensions/mv2/background-pages](https://developer.chrome.com/docs/extensions/mv2/background-pages)
* [https://thehackerblog.com/kicking-the-rims-a-guide-for-securely-writing-and-auditing-chrome-extensions/](https://thehackerblog.com/kicking-the-rims-a-guide-for-securely-writing-and-auditing-chrome-extensions/)
* [https://gist.github.com/LongJohnCoder/9ddf5735df3a4f2e9559665fb864eac0](https://gist.github.com/LongJohnCoder/9ddf5735df3a4f2e9559665fb864eac0)

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Druge naÄine podrÅ¡ke HackTricks-a:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu na HackTricks** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJEM**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks suvenir**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
