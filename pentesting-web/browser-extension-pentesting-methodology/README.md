# Browser Extension Pentesting Methodology

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

æµè§ˆå™¨æ‰©å±•æ˜¯ç”¨ JavaScript ç¼–å†™çš„ï¼Œå¹¶ç”±æµè§ˆå™¨åœ¨åå°åŠ è½½ã€‚å®ƒæœ‰è‡ªå·±çš„ [DOM](https://www.w3schools.com/js/js\_htmldom.asp)ï¼Œä½†å¯ä»¥ä¸å…¶ä»–ç½‘ç«™çš„ DOM è¿›è¡Œäº¤äº’ã€‚è¿™æ„å‘³ç€å®ƒå¯èƒ½ä¼šå±å®³å…¶ä»–ç½‘ç«™çš„æœºå¯†æ€§ã€å®Œæ•´æ€§å’Œå¯ç”¨æ€§ï¼ˆCIAï¼‰ã€‚

## ä¸»è¦ç»„ä»¶

æ‰©å±•å¸ƒå±€åœ¨å¯è§†åŒ–æ—¶æ•ˆæœæœ€ä½³ï¼Œç”±ä¸‰ä¸ªç»„ä»¶ç»„æˆã€‚è®©æˆ‘ä»¬æ·±å…¥äº†è§£æ¯ä¸ªç»„ä»¶ã€‚

<figure><img src="../../.gitbook/assets/image (16) (1).png" alt=""><figcaption><p><a href="http://webblaze.cs.berkeley.edu/papers/Extensions.pdf">http://webblaze.cs.berkeley.edu/papers/Extensions.pdf</a></p></figcaption></figure>

### **å†…å®¹è„šæœ¬**

æ¯ä¸ªå†…å®¹è„šæœ¬å¯ä»¥ç›´æ¥è®¿é—® **å•ä¸ªç½‘é¡µ** çš„ DOMï¼Œå› æ­¤æš´éœ²äº **æ½œåœ¨çš„æ¶æ„è¾“å…¥**ã€‚ç„¶è€Œï¼Œå†…å®¹è„šæœ¬é™¤äº†èƒ½å¤Ÿå‘æ‰©å±•æ ¸å¿ƒå‘é€æ¶ˆæ¯å¤–ï¼Œæ²¡æœ‰å…¶ä»–æƒé™ã€‚

### **æ‰©å±•æ ¸å¿ƒ**

æ‰©å±•æ ¸å¿ƒåŒ…å«å¤§éƒ¨åˆ†æ‰©å±•æƒé™/è®¿é—®ï¼Œä½†æ‰©å±•æ ¸å¿ƒåªèƒ½é€šè¿‡ [XMLHttpRequest](https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest) å’Œå†…å®¹è„šæœ¬ä¸ç½‘é¡µå†…å®¹è¿›è¡Œäº¤äº’ã€‚æ­¤å¤–ï¼Œæ‰©å±•æ ¸å¿ƒæ— æ³•ç›´æ¥è®¿é—®ä¸»æœºæœºå™¨ã€‚

### **æœ¬åœ°äºŒè¿›åˆ¶**

æ‰©å±•å…è®¸ä¸€ä¸ªæœ¬åœ°äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¯ä»¥ **ä»¥ç”¨æˆ·çš„å®Œå…¨æƒé™è®¿é—®ä¸»æœºæœºå™¨ã€‚** æœ¬åœ°äºŒè¿›åˆ¶é€šè¿‡ Flash å’Œå…¶ä»–æµè§ˆå™¨æ’ä»¶ä½¿ç”¨çš„æ ‡å‡† Netscape æ’ä»¶åº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£ ([NPAPI](https://en.wikipedia.org/wiki/NPAPI)) ä¸æ‰©å±•æ ¸å¿ƒè¿›è¡Œäº¤äº’ã€‚

### è¾¹ç•Œ

{% hint style="danger" %}
è¦è·å¾—ç”¨æˆ·çš„å®Œå…¨æƒé™ï¼Œæ”»å‡»è€…å¿…é¡»è¯´æœæ‰©å±•å°†æ¶æ„è¾“å…¥ä»å†…å®¹è„šæœ¬ä¼ é€’åˆ°æ‰©å±•çš„æ ¸å¿ƒï¼Œå†ä»æ‰©å±•çš„æ ¸å¿ƒä¼ é€’åˆ°æœ¬åœ°äºŒè¿›åˆ¶ã€‚
{% endhint %}

æ‰©å±•çš„æ¯ä¸ªç»„ä»¶ä¹‹é—´ç”± **å¼ºä¿æŠ¤è¾¹ç•Œ** éš”å¼€ã€‚æ¯ä¸ªç»„ä»¶åœ¨ **å•ç‹¬çš„æ“ä½œç³»ç»Ÿè¿›ç¨‹** ä¸­è¿è¡Œã€‚å†…å®¹è„šæœ¬å’Œæ‰©å±•æ ¸å¿ƒåœ¨ **æ²™ç®±è¿›ç¨‹** ä¸­è¿è¡Œï¼Œè¿™äº›è¿›ç¨‹å¯¹å¤§å¤šæ•°æ“ä½œç³»ç»ŸæœåŠ¡ä¸å¯ç”¨ã€‚

æ­¤å¤–ï¼Œå†…å®¹è„šæœ¬é€šè¿‡ **åœ¨å•ç‹¬çš„ JavaScript å †ä¸­è¿è¡Œ** ä¸å…¶å…³è”çš„ç½‘é¡µåˆ†å¼€ã€‚å†…å®¹è„šæœ¬å’Œç½‘é¡µå¯ä»¥ **è®¿é—®ç›¸åŒçš„åº•å±‚ DOM**ï¼Œä½†ä¸¤è€… **ä»ä¸äº¤æ¢ JavaScript æŒ‡é’ˆ**ï¼Œé˜²æ­¢ JavaScript åŠŸèƒ½çš„æ³„éœ²ã€‚

## **`manifest.json`**

Chrome æ‰©å±•åªæ˜¯ä¸€ä¸ªå¸¦æœ‰ [.crx æ–‡ä»¶æ‰©å±•å](https://www.lifewire.com/crx-file-2620391) çš„ ZIP æ–‡ä»¶å¤¹ã€‚æ‰©å±•çš„æ ¸å¿ƒæ˜¯ä½äºæ–‡ä»¶å¤¹æ ¹éƒ¨çš„ **`manifest.json`** æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶æŒ‡å®šå¸ƒå±€ã€æƒé™å’Œå…¶ä»–é…ç½®é€‰é¡¹ã€‚

ç¤ºä¾‹ï¼š
```json
{
"manifest_version": 2,
"name": "My extension",
"version": "1.0",
"permissions": [
"storage"
],
"content_scripts": [
{
"js": [
"script.js"
],
"matches": [
"https://example.com/*",
"https://www.example.com/*"
],
"exclude_matches": ["*://*/*business*"],
}
],
"background": {
"scripts": [
"background.js"
]
},
"options_ui": {
"page": "options.html"
}
}
```
### `content_scripts`

å†…å®¹è„šæœ¬åœ¨ç”¨æˆ·**å¯¼èˆªåˆ°åŒ¹é…é¡µé¢**æ—¶**åŠ è½½**ï¼Œåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œä»»ä½•åŒ¹é…**`https://example.com/*`**è¡¨è¾¾å¼ä¸”ä¸åŒ¹é…**`*://*/*/business*`**æ­£åˆ™è¡¨è¾¾å¼çš„é¡µé¢ã€‚å®ƒä»¬**åƒé¡µé¢è‡ªå·±çš„è„šæœ¬**ä¸€æ ·æ‰§è¡Œï¼Œå¹¶ä¸”å¯¹é¡µé¢çš„[æ–‡æ¡£å¯¹è±¡æ¨¡å‹ (DOM)](https://developer.mozilla.org/en-US/docs/Web/API/Document\_Object\_Model)å…·æœ‰ä»»æ„è®¿é—®æƒé™ã€‚
```json
"content_scripts": [
{
"js": [
"script.js"
],
"matches": [
"https://example.com/*",
"https://www.example.com/*"
],
"exclude_matches": ["*://*/*business*"],
}
],
```
ä¸ºäº†åŒ…å«æˆ–æ’é™¤æ›´å¤šçš„ URLï¼Œæ‚¨è¿˜å¯ä»¥ä½¿ç”¨ **`include_globs`** å’Œ **`exclude_globs`**ã€‚

è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹å†…å®¹è„šæœ¬ï¼Œå½“ä½¿ç”¨ [å­˜å‚¨ API](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/storage) ä»æ‰©å±•çš„å­˜å‚¨ä¸­æ£€ç´¢ `message` å€¼æ—¶ï¼Œå°†å‘é¡µé¢æ·»åŠ ä¸€ä¸ªè§£é‡ŠæŒ‰é’®ã€‚
```js
chrome.storage.local.get("message", result =>
{
let div = document.createElement("div");
div.innerHTML = result.message + " <button>Explain</button>";
div.querySelector("button").addEventListener("click", () =>
{
chrome.runtime.sendMessage("explain");
});
document.body.appendChild(div);
});
```
<figure><img src="../../.gitbook/assets/image (23).png" alt=""><figcaption></figcaption></figure>

å½“ç‚¹å‡»æ­¤æŒ‰é’®æ—¶ï¼Œé€šè¿‡åˆ©ç”¨[**runtime.sendMessage() API**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/runtime/sendMessage)ï¼Œå†…å®¹è„šæœ¬å‘æ‰©å±•é¡µé¢å‘é€æ¶ˆæ¯ã€‚è¿™æ˜¯ç”±äºå†…å®¹è„šæœ¬åœ¨ç›´æ¥è®¿é—®APIæ–¹é¢çš„é™åˆ¶ï¼Œ`storage`æ˜¯å°‘æ•°ä¾‹å¤–ä¹‹ä¸€ã€‚å¯¹äºè¶…å‡ºè¿™äº›ä¾‹å¤–çš„åŠŸèƒ½ï¼Œæ¶ˆæ¯è¢«å‘é€åˆ°æ‰©å±•é¡µé¢ï¼Œå†…å®¹è„šæœ¬å¯ä»¥ä¸ä¹‹é€šä¿¡ã€‚

{% hint style="warning" %}
æ ¹æ®æµè§ˆå™¨çš„ä¸åŒï¼Œå†…å®¹è„šæœ¬çš„èƒ½åŠ›å¯èƒ½ä¼šç•¥æœ‰ä¸åŒã€‚å¯¹äºåŸºäºChromiumçš„æµè§ˆå™¨ï¼Œèƒ½åŠ›åˆ—è¡¨å¯åœ¨[Chrome Developers documentation](https://developer.chrome.com/docs/extensions/mv3/content\_scripts/#capabilities)ä¸­æ‰¾åˆ°ï¼Œè€Œå¯¹äºFirefoxï¼Œ[MDN](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/Content\_scripts#webextension\_apis)æ˜¯ä¸»è¦æ¥æºã€‚\
å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå†…å®¹è„šæœ¬èƒ½å¤Ÿä¸åå°è„šæœ¬è¿›è¡Œé€šä¿¡ï¼Œä½¿å…¶èƒ½å¤Ÿæ‰§è¡Œæ“ä½œå¹¶ä¼ é€’å“åº”ã€‚
{% endhint %}

è¦åœ¨Chromeä¸­æŸ¥çœ‹å’Œè°ƒè¯•å†…å®¹è„šæœ¬ï¼Œå¯ä»¥é€šè¿‡é€‰é¡¹ > æ›´å¤šå·¥å…· > å¼€å‘è€…å·¥å…·è®¿é—®Chromeå¼€å‘è€…å·¥å…·èœå•ï¼Œæˆ–æŒ‰Ctrl + Shift + Iã€‚

å½“å¼€å‘è€…å·¥å…·æ˜¾ç¤ºåï¼Œç‚¹å‡»**æº**é€‰é¡¹å¡ï¼Œç„¶åç‚¹å‡»**å†…å®¹è„šæœ¬**é€‰é¡¹å¡ã€‚è¿™å…è®¸è§‚å¯Ÿæ¥è‡ªå„ç§æ‰©å±•çš„è¿è¡Œå†…å®¹è„šæœ¬ï¼Œå¹¶è®¾ç½®æ–­ç‚¹ä»¥è·Ÿè¸ªæ‰§è¡Œæµç¨‹ã€‚

### æ³¨å…¥çš„å†…å®¹è„šæœ¬

{% hint style="success" %}
è¯·æ³¨æ„ï¼Œ**å†…å®¹è„šæœ¬ä¸æ˜¯å¼ºåˆ¶æ€§çš„**ï¼Œä¹Ÿå¯ä»¥é€šè¿‡**`tabs.executeScript`** **åŠ¨æ€** **æ³¨å…¥**è„šæœ¬å¹¶åœ¨ç½‘é¡µä¸­**ä»¥ç¼–ç¨‹æ–¹å¼æ³¨å…¥**ã€‚è¿™å®é™…ä¸Šæä¾›äº†æ›´**ç»†ç²’åº¦çš„æ§åˆ¶**ã€‚
{% endhint %}

å¯¹äºå†…å®¹è„šæœ¬çš„ç¨‹åºåŒ–æ³¨å…¥ï¼Œæ‰©å±•éœ€è¦å¯¹è¦æ³¨å…¥è„šæœ¬çš„é¡µé¢å…·æœ‰[ä¸»æœºæƒé™](https://developer.chrome.com/docs/extensions/reference/permissions)ã€‚è¿™äº›æƒé™å¯ä»¥é€šè¿‡åœ¨æ‰©å±•çš„æ¸…å•ä¸­**è¯·æ±‚å®ƒä»¬**æˆ–é€šè¿‡[**activeTab**](https://developer.chrome.com/docs/extensions/reference/manifest/activeTab)ä¸´æ—¶è·å–ã€‚

#### ç¤ºä¾‹ activeTab åŸºç¡€æ‰©å±•

{% code title="manifest.json" %}
```json
{
"name": "My extension",
...
"permissions": [
"activeTab",
"scripting"
],
"background": {
"service_worker": "background.js"
},
"action": {
"default_title": "Action Button"
}
}
```
{% endcode %}

* **ç‚¹å‡»æ—¶æ³¨å…¥ä¸€ä¸ªJSæ–‡ä»¶ï¼š**
```javascript
// content-script.js
document.body.style.backgroundColor = "orange";

//service-worker.js - Inject the JS file
chrome.action.onClicked.addListener((tab) => {
chrome.scripting.executeScript({
target: { tabId: tab.id },
files: ["content-script.js"]
});
});
```
* **åœ¨ç‚¹å‡»æ—¶æ³¨å…¥ä¸€ä¸ªå‡½æ•°**:
```javascript
//service-worker.js - Inject a function
function injectedFunction() {
document.body.style.backgroundColor = "orange";
}

chrome.action.onClicked.addListener((tab) => {
chrome.scripting.executeScript({
target : {tabId : tab.id},
func : injectedFunction,
});
});
```
#### ç¤ºä¾‹ä¸è„šæœ¬æƒé™
```javascript
// service-workser.js
chrome.scripting.registerContentScripts([{
id : "test",
matches : [ "https://*.example.com/*" ],
excludeMatches : [ "*://*/*business*" ],
js : [ "contentScript.js" ],
}]);

// Another example
chrome.tabs.executeScript(tabId, { file: "content_script.js" });
```
ä¸ºäº†åŒ…å«æˆ–æ’é™¤æ›´å¤šçš„ URLï¼Œæ‚¨è¿˜å¯ä»¥ä½¿ç”¨ **`include_globs`** å’Œ **`exclude_globs`**ã€‚

### å†…å®¹è„šæœ¬ `run_at`

`run_at` å­—æ®µæ§åˆ¶ **JavaScript æ–‡ä»¶ä½•æ—¶æ³¨å…¥åˆ°ç½‘é¡µä¸­**ã€‚é¦–é€‰å’Œé»˜è®¤å€¼æ˜¯ `"document_idle"`ã€‚

å¯èƒ½çš„å€¼æœ‰ï¼š

* **`document_idle`**ï¼šå°½å¯èƒ½åœ°
* **`document_start`**ï¼šåœ¨ä»»ä½• `css` æ–‡ä»¶ä¹‹åï¼Œä½†åœ¨æ„å»ºä»»ä½•å…¶ä»– DOM æˆ–è¿è¡Œä»»ä½•å…¶ä»–è„šæœ¬ä¹‹å‰ã€‚
* **`document_end`**ï¼šåœ¨ DOM å®Œæˆåç«‹å³ï¼Œä½†åœ¨å­èµ„æºï¼ˆå¦‚å›¾åƒå’Œæ¡†æ¶ï¼‰åŠ è½½ä¹‹å‰ã€‚

#### é€šè¿‡ `manifest.json`
```json
{
"name": "My extension",
...
"content_scripts": [
{
"matches": ["https://*.example.com/*"],
"run_at": "document_idle",
"js": ["contentScript.js"]
}
],
...
}

```
é€šè¿‡ **`service-worker.js`**
```javascript
chrome.scripting.registerContentScripts([{
id : "test",
matches : [ "https://*.example.com/*" ],
runAt : "document_idle",
js : [ "contentScript.js" ],
}]);
```
### `background`

ç”±å†…å®¹è„šæœ¬å‘é€çš„æ¶ˆæ¯ç”±**èƒŒæ™¯é¡µé¢**æ¥æ”¶ï¼ŒèƒŒæ™¯é¡µé¢åœ¨åè°ƒæ‰©å±•çš„ç»„ä»¶ä¸­å‘æŒ¥ç€æ ¸å¿ƒä½œç”¨ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒèƒŒæ™¯é¡µé¢åœ¨æ‰©å±•çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­æŒç»­å­˜åœ¨ï¼Œé»˜é»˜è¿è¡Œè€Œæ— éœ€ç›´æ¥ç”¨æˆ·äº¤äº’ã€‚å®ƒæ‹¥æœ‰è‡ªå·±çš„æ–‡æ¡£å¯¹è±¡æ¨¡å‹ï¼ˆDOMï¼‰ï¼Œèƒ½å¤Ÿå®ç°å¤æ‚çš„äº¤äº’å’ŒçŠ¶æ€ç®¡ç†ã€‚

**å…³é”®ç‚¹**ï¼š

* **èƒŒæ™¯é¡µé¢è§’è‰²ï¼š** ä½œä¸ºæ‰©å±•çš„ç¥ç»ä¸­æ¢ï¼Œç¡®ä¿æ‰©å±•å„éƒ¨åˆ†ä¹‹é—´çš„é€šä¿¡å’Œåè°ƒã€‚
* **æŒä¹…æ€§ï¼š** å®ƒæ˜¯ä¸€ä¸ªå§‹ç»ˆå­˜åœ¨çš„å®ä½“ï¼Œå¯¹ç”¨æˆ·ä¸å¯è§ï¼Œä½†å¯¹æ‰©å±•çš„åŠŸèƒ½è‡³å…³é‡è¦ã€‚
* **è‡ªåŠ¨ç”Ÿæˆï¼š** å¦‚æœæœªæ˜ç¡®å®šä¹‰ï¼Œæµè§ˆå™¨å°†è‡ªåŠ¨åˆ›å»ºä¸€ä¸ªèƒŒæ™¯é¡µé¢ã€‚è¿™ä¸ªè‡ªåŠ¨ç”Ÿæˆçš„é¡µé¢å°†åŒ…å«æ‰©å±•æ¸…å•ä¸­æŒ‡å®šçš„æ‰€æœ‰èƒŒæ™¯è„šæœ¬ï¼Œç¡®ä¿æ‰©å±•çš„åå°ä»»åŠ¡æ— ç¼è¿è¡Œã€‚

{% hint style="success" %}
æµè§ˆå™¨åœ¨è‡ªåŠ¨ç”ŸæˆèƒŒæ™¯é¡µé¢ï¼ˆå½“æœªæ˜ç¡®å£°æ˜æ—¶ï¼‰æ‰€æä¾›çš„ä¾¿åˆ©ï¼Œç¡®ä¿æ‰€æœ‰å¿…è¦çš„èƒŒæ™¯è„šæœ¬éƒ½è¢«é›†æˆå¹¶æ­£å¸¸è¿è¡Œï¼Œä»è€Œç®€åŒ–äº†æ‰©å±•çš„è®¾ç½®è¿‡ç¨‹ã€‚
{% endhint %}

ç¤ºä¾‹èƒŒæ™¯è„šæœ¬ï¼š
```js
chrome.runtime.onMessage.addListener((request, sender, sendResponse) =>
{
if (request == "explain")
{
chrome.tabs.create({ url: "https://example.net/explanation" });
}
})
```
å®ƒä½¿ç”¨ [runtime.onMessage API](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/runtime/onMessage) æ¥ç›‘å¬æ¶ˆæ¯ã€‚å½“æ¥æ”¶åˆ° `"explain"` æ¶ˆæ¯æ—¶ï¼Œå®ƒä½¿ç”¨ [tabs API](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs) åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€ä¸€ä¸ªé¡µé¢ã€‚

è¦è°ƒè¯•åå°è„šæœ¬ï¼Œæ‚¨å¯ä»¥è½¬åˆ° **æ‰©å±•è¯¦ç»†ä¿¡æ¯å¹¶æ£€æŸ¥æœåŠ¡å·¥ä½œè€…ï¼Œ** è¿™å°†æ‰“å¼€å¸¦æœ‰åå°è„šæœ¬çš„å¼€å‘è€…å·¥å…·ï¼š

<figure><img src="https://github.com/carlospolop/hacktricks/blob/master/pentesting-web/browser-extension-pentesting-methodology/broken-reference" alt=""><figcaption></figcaption></figure>

### é€‰é¡¹é¡µé¢å’Œå…¶ä»–

æµè§ˆå™¨æ‰©å±•å¯ä»¥åŒ…å«å„ç§ç±»å‹çš„é¡µé¢ï¼š

* **æ“ä½œé¡µé¢** åœ¨ç‚¹å‡»æ‰©å±•å›¾æ ‡æ—¶æ˜¾ç¤ºåœ¨ **ä¸‹æ‹‰èœå•ä¸­**ã€‚
* æ‰©å±•å°† **åœ¨æ–°æ ‡ç­¾é¡µä¸­åŠ è½½çš„é¡µé¢**ã€‚
* **é€‰é¡¹é¡µé¢**ï¼šæ­¤é¡µé¢åœ¨ç‚¹å‡»æ—¶æ˜¾ç¤ºåœ¨æ‰©å±•é¡¶éƒ¨ã€‚åœ¨ä¹‹å‰çš„æ¸…å•ä¸­ï¼Œæˆ‘èƒ½å¤Ÿé€šè¿‡ `chrome://extensions/?options=fadlhnelkbeojnebcbkacjilhnbjfjca` è®¿é—®æ­¤é¡µé¢ï¼Œæˆ–ç‚¹å‡»ï¼š

<figure><img src="../../.gitbook/assets/image (24).png" alt="" width="375"><figcaption></figcaption></figure>

è¯·æ³¨æ„ï¼Œè¿™äº›é¡µé¢ä¸åƒåå°é¡µé¢é‚£æ ·æŒä¹…ï¼Œå› ä¸ºå®ƒä»¬æ ¹æ®éœ€è¦åŠ¨æ€åŠ è½½å†…å®¹ã€‚å°½ç®¡å¦‚æ­¤ï¼Œå®ƒä»¬ä¸åå°é¡µé¢å…±äº«æŸäº›åŠŸèƒ½ï¼š

* **ä¸å†…å®¹è„šæœ¬çš„é€šä¿¡ï¼š** ç±»ä¼¼äºåå°é¡µé¢ï¼Œè¿™äº›é¡µé¢å¯ä»¥æ¥æ”¶æ¥è‡ªå†…å®¹è„šæœ¬çš„æ¶ˆæ¯ï¼Œä¿ƒè¿›æ‰©å±•å†…çš„äº¤äº’ã€‚
* **è®¿é—®æ‰©å±•ç‰¹å®šçš„ APIï¼š** è¿™äº›é¡µé¢äº«æœ‰å¯¹æ‰©å±•ç‰¹å®š API çš„å…¨é¢è®¿é—®ï¼Œå—æ‰©å±•å®šä¹‰çš„æƒé™é™åˆ¶ã€‚

### `permissions` & `host_permissions`

**`permissions`** å’Œ **`host_permissions`** æ˜¯ `manifest.json` ä¸­çš„æ¡ç›®ï¼ŒæŒ‡ç¤º **æµè§ˆå™¨æ‰©å±•å…·æœ‰å“ªäº›æƒé™**ï¼ˆå­˜å‚¨ã€ä½ç½®ç­‰ï¼‰ä»¥åŠ **åœ¨å“ªäº›ç½‘é¡µä¸Š**ã€‚

ç”±äºæµè§ˆå™¨æ‰©å±•å¯èƒ½å…·æœ‰å¦‚æ­¤ **ç‰¹æƒ**ï¼Œæ¶æ„æ‰©å±•æˆ–è¢«æ”»å‡»çš„æ‰©å±•å¯èƒ½å…è®¸æ”»å‡»è€… **ä»¥ä¸åŒæ–¹å¼çªƒå–æ•æ„Ÿä¿¡æ¯å¹¶ç›‘è§†ç”¨æˆ·**ã€‚

æ£€æŸ¥è¿™äº›è®¾ç½®å¦‚ä½•å·¥ä½œä»¥åŠå®ƒä»¬å¦‚ä½•è¢«æ»¥ç”¨ï¼š

{% content-ref url="browext-permissions-and-host_permissions.md" %}
[browext-permissions-and-host\_permissions.md](browext-permissions-and-host\_permissions.md)
{% endcontent-ref %}

### `content_security_policy`

**å†…å®¹å®‰å…¨ç­–ç•¥** ä¹Ÿå¯ä»¥åœ¨ `manifest.json` ä¸­å£°æ˜ã€‚å¦‚æœå®šä¹‰äº†å†…å®¹å®‰å…¨ç­–ç•¥ï¼Œå®ƒå¯èƒ½æ˜¯ **è„†å¼±çš„**ã€‚

æµè§ˆå™¨æ‰©å±•é¡µé¢çš„é»˜è®¤è®¾ç½®ç›¸å½“ä¸¥æ ¼ï¼š
```bash
script-src 'self'; object-src 'self';
```
æœ‰å…³CSPå’Œæ½œåœ¨ç»•è¿‡çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../content-security-policy-csp-bypass/" %}
[content-security-policy-csp-bypass](../content-security-policy-csp-bypass/)
{% endcontent-ref %}

### `web_accessible_resources`

ä¸ºäº†è®©ç½‘é¡µè®¿é—®æµè§ˆå™¨æ‰©å±•çš„é¡µé¢ï¼Œä¾‹å¦‚ä¸€ä¸ª`.html`é¡µé¢ï¼Œè¯¥é¡µé¢éœ€è¦åœ¨`manifest.json`çš„**`web_accessible_resources`**å­—æ®µä¸­æåˆ°ã€‚\
ä¾‹å¦‚ï¼š
```javascript
{
...
"web_accessible_resources": [
{
"resources": [ "images/*.png" ],
"matches": [ "https://example.com/*" ]
},
{
"resources": [ "fonts/*.woff" ],
"matches": [ "https://example.com/*" ]
}
],
...
}
```
è¿™äº›é¡µé¢å¯ä»¥é€šè¿‡ä»¥ä¸‹URLè®¿é—®ï¼š
```
chrome-extension://<extension-id>/message.html
```
åœ¨å…¬å…±æ‰©å±•ä¸­ï¼Œ**extension-id æ˜¯å¯è®¿é—®çš„**ï¼š

<figure><img src="../../.gitbook/assets/image (1194).png" alt="" width="375"><figcaption></figcaption></figure>

ä¸è¿‡ï¼Œå¦‚æœä½¿ç”¨ `manifest.json` å‚æ•° **`use_dynamic_url`**ï¼Œåˆ™è¯¥ **id å¯èƒ½æ˜¯åŠ¨æ€çš„**ã€‚

{% hint style="success" %}
è¯·æ³¨æ„ï¼Œå³ä½¿æ­¤å¤„æåˆ°æŸä¸ªé¡µé¢ï¼Œå®ƒä¹Ÿå¯èƒ½ç”±äº **å†…å®¹å®‰å…¨ç­–ç•¥** è€Œ **å—åˆ° ClickJacking ä¿æŠ¤**ã€‚å› æ­¤ï¼Œåœ¨ç¡®è®¤ ClickJacking æ”»å‡»æ˜¯å¦å¯èƒ½ä¹‹å‰ï¼Œæ‚¨è¿˜éœ€è¦æ£€æŸ¥å®ƒï¼ˆframe-ancestors éƒ¨åˆ†ï¼‰ã€‚
{% endhint %}

å…è®¸è®¿é—®è¿™äº›é¡µé¢ä½¿è¿™äº›é¡µé¢ **å¯èƒ½å®¹æ˜“å—åˆ° ClickJacking æ”»å‡»**ï¼š

{% content-ref url="browext-clickjacking.md" %}
[browext-clickjacking.md](browext-clickjacking.md)
{% endcontent-ref %}

{% hint style="success" %}
ä»…å…è®¸è¿™äº›é¡µé¢ç”±æ‰©å±•åŠ è½½ï¼Œè€Œä¸æ˜¯ç”±éšæœº URL åŠ è½½ï¼Œå¯ä»¥é˜²æ­¢ ClickJacking æ”»å‡»ã€‚
{% endhint %}

{% hint style="danger" %}
è¯·æ³¨æ„ï¼Œ**`web_accessible_resources`** ä¸­çš„é¡µé¢å’Œæ‰©å±•çš„å…¶ä»–é¡µé¢ä¹Ÿèƒ½å¤Ÿ **è”ç³»åå°è„šæœ¬**ã€‚å› æ­¤ï¼Œå¦‚æœè¿™äº›é¡µé¢ä¸­çš„ä¸€ä¸ªå®¹æ˜“å—åˆ° **XSS** æ”»å‡»ï¼Œå®ƒå¯èƒ½ä¼šæ‰“å¼€æ›´å¤§çš„æ¼æ´ã€‚

æ­¤å¤–ï¼Œè¯·æ³¨æ„ï¼Œæ‚¨åªèƒ½åœ¨ iframe ä¸­æ‰“å¼€ **`web_accessible_resources`** ä¸­æŒ‡ç¤ºçš„é¡µé¢ï¼Œä½†ä»æ–°æ ‡ç­¾é¡µå¯ä»¥è®¿é—®æ‰©å±•ä¸­çš„ä»»ä½•é¡µé¢ï¼Œåªéœ€çŸ¥é“æ‰©å±• IDã€‚å› æ­¤ï¼Œå¦‚æœå‘ç° XSS åˆ©ç”¨ç›¸åŒå‚æ•°ï¼Œå³ä½¿é¡µé¢æœªåœ¨ **`web_accessible_resources`** ä¸­é…ç½®ï¼Œä¹Ÿå¯èƒ½è¢«åˆ©ç”¨ã€‚
{% endhint %}

### `externally_connectable`

æ ¹æ® [**æ–‡æ¡£**](https://developer.chrome.com/docs/extensions/reference/manifest/externally-connectable)ï¼Œ`"externally_connectable"` æ¸…å•å±æ€§å£°æ˜ **å“ªäº›æ‰©å±•å’Œç½‘é¡µå¯ä»¥é€šè¿‡** [runtime.connect](https://developer.chrome.com/docs/extensions/reference/runtime#method-connect) å’Œ [runtime.sendMessage](https://developer.chrome.com/docs/extensions/reference/runtime#method-sendMessage) è¿æ¥åˆ°æ‚¨çš„æ‰©å±•ã€‚

* å¦‚æœåœ¨æ‰©å±•çš„æ¸…å•ä¸­ **æœªå£°æ˜ `externally_connectable`** é”®æˆ–å£°æ˜ä¸º **`"ids": ["*"]`**ï¼Œ**æ‰€æœ‰æ‰©å±•éƒ½å¯ä»¥è¿æ¥ï¼Œä½†æ²¡æœ‰ç½‘é¡µå¯ä»¥è¿æ¥**ã€‚
* å¦‚æœæŒ‡å®šäº† **ç‰¹å®š ID**ï¼Œå¦‚ `"ids": ["aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"]`ï¼Œ**åªæœ‰è¿™äº›åº”ç”¨ç¨‹åº**å¯ä»¥è¿æ¥ã€‚
* å¦‚æœæŒ‡å®šäº† **åŒ¹é…é¡¹**ï¼Œè¿™äº›ç½‘é¡µåº”ç”¨ç¨‹åºå°†èƒ½å¤Ÿè¿æ¥ï¼š
```json
"matches": [
"https://*.google.com/*",
"*://*.chromium.org/*",
```
* å¦‚æœæŒ‡å®šä¸ºç©ºï¼š**`"externally_connectable": {}`**ï¼Œåˆ™æ²¡æœ‰åº”ç”¨ç¨‹åºæˆ–ç½‘é¡µèƒ½å¤Ÿè¿æ¥ã€‚

è¿™é‡ŒæŒ‡ç¤ºçš„**æ‰©å±•å’ŒURLè¶Šå°‘**ï¼Œ**æ”»å‡»é¢å°±è¶Šå°**ã€‚

{% hint style="danger" %}
å¦‚æœåœ¨**`externally_connectable`**ä¸­æŒ‡ç¤ºäº†**æ˜“å—XSSæˆ–æ¥ç®¡æ”»å‡»çš„ç½‘é¡µ**ï¼Œæ”»å‡»è€…å°†èƒ½å¤Ÿ**ç›´æ¥å‘åå°è„šæœ¬å‘é€æ¶ˆæ¯**ï¼Œå®Œå…¨ç»•è¿‡å†…å®¹è„šæœ¬åŠå…¶CSPã€‚

å› æ­¤ï¼Œè¿™æ˜¯ä¸€ä¸ª**éå¸¸å¼ºå¤§çš„ç»•è¿‡**ã€‚

æ­¤å¤–ï¼Œå¦‚æœå®¢æˆ·ç«¯å®‰è£…äº†ä¸€ä¸ªæ¶æ„æ‰©å±•ï¼Œå³ä½¿å®ƒä¸è¢«å…è®¸ä¸æ˜“å—æ”»å‡»çš„æ‰©å±•é€šä¿¡ï¼Œå®ƒä¹Ÿå¯èƒ½åœ¨**å…è®¸çš„ç½‘é¡µä¸­æ³¨å…¥XSSæ•°æ®**ï¼Œæˆ–æ»¥ç”¨**`WebRequest`**æˆ–**`DeclarativeNetRequest`** APIæ¥æ“çºµç›®æ ‡åŸŸä¸Šçš„è¯·æ±‚ï¼Œæ”¹å˜é¡µé¢å¯¹**JavaScriptæ–‡ä»¶**çš„è¯·æ±‚ã€‚ï¼ˆè¯·æ³¨æ„ï¼Œç›®æ ‡é¡µé¢ä¸Šçš„CSPå¯èƒ½ä¼šé˜»æ­¢è¿™äº›æ”»å‡»ï¼‰ã€‚è¿™ä¸ªæƒ³æ³•æ¥è‡ª[**è¿™ç¯‡æ–‡ç« **](https://www.darkrelay.com/post/opera-zero-day-rce-vulnerability)ã€‚
{% endhint %}

## é€šä¿¡æ€»ç»“

### æ‰©å±• <--> WebApp

åœ¨å†…å®¹è„šæœ¬å’Œç½‘é¡µä¹‹é—´ï¼Œé€šå¸¸ä½¿ç”¨åç»­æ¶ˆæ¯è¿›è¡Œé€šä¿¡ã€‚å› æ­¤ï¼Œåœ¨ç½‘é¡µåº”ç”¨ç¨‹åºä¸­ï¼Œæ‚¨é€šå¸¸ä¼šæ‰¾åˆ°å¯¹å‡½æ•°**`window.postMessage`**çš„è°ƒç”¨ï¼Œè€Œåœ¨å†…å®¹è„šæœ¬ä¸­åˆ™æœ‰åƒ**`window.addEventListener`**è¿™æ ·çš„ç›‘å¬å™¨ã€‚ç„¶è€Œï¼Œè¯·æ³¨æ„ï¼Œæ‰©å±•ä¹Ÿå¯ä»¥**é€šè¿‡å‘é€Post Messageä¸ç½‘é¡µåº”ç”¨ç¨‹åºé€šä¿¡**ï¼ˆå› æ­¤ç½‘é¡µåº”è¯¥é¢„æœŸæ­¤æƒ…å†µï¼‰ï¼Œæˆ–è€…ä»…ä½¿ç½‘é¡µåŠ è½½ä¸€ä¸ªæ–°è„šæœ¬ã€‚

### åœ¨æ‰©å±•å†…éƒ¨

é€šå¸¸ä½¿ç”¨å‡½æ•°**`chrome.runtime.sendMessage`**åœ¨æ‰©å±•å†…éƒ¨å‘é€æ¶ˆæ¯ï¼ˆé€šå¸¸ç”±`background`è„šæœ¬å¤„ç†ï¼‰ï¼Œä¸ºäº†æ¥æ”¶å’Œå¤„ç†å®ƒï¼Œå£°æ˜ä¸€ä¸ªç›‘å¬å™¨è°ƒç”¨**`chrome.runtime.onMessage.addListener`**ã€‚

ä¹Ÿå¯ä»¥ä½¿ç”¨**`chrome.runtime.connect()`**æ¥å»ºç«‹æŒä¹…è¿æ¥ï¼Œè€Œä¸æ˜¯å‘é€å•ä¸ªæ¶ˆæ¯ï¼Œå¯ä»¥ä½¿ç”¨å®ƒæ¥**å‘é€**å’Œ**æ¥æ”¶****æ¶ˆæ¯**ï¼Œå¦‚ä¸‹ä¾‹æ‰€ç¤ºï¼š

<details>

<summary><code>chrome.runtime.connect()</code> ç¤ºä¾‹</summary>
```javascript
var port = chrome.runtime.connect();

// Listen for messages from the web page
window.addEventListener("message", (event) => {
// Only accept messages from the same window
if (event.source !== window) {
return;
}

// Check if the message type is "FROM_PAGE"
if (event.data.type && (event.data.type === "FROM_PAGE")) {
console.log("Content script received: " + event.data.text);
// Forward the message to the background script
port.postMessage({ type: 'FROM_PAGE', text: event.data.text });
}
}, false);

// Listen for messages from the background script
port.onMessage.addListener(function(msg) {
console.log("Content script received message from background script:", msg);
// Handle the response message from the background script
});
```
</details>

ä¹Ÿå¯ä»¥ä»åå°è„šæœ¬å‘ä½äºç‰¹å®šæ ‡ç­¾é¡µä¸­çš„å†…å®¹è„šæœ¬å‘é€æ¶ˆæ¯ï¼Œè°ƒç”¨ **`chrome.tabs.sendMessage`**ï¼Œåœ¨æ­¤æ‚¨éœ€è¦æŒ‡æ˜è¦å‘é€æ¶ˆæ¯çš„ **æ ‡ç­¾é¡µ ID**ã€‚

### ä»å…è®¸çš„ `externally_connectable` åˆ°æ‰©å±•

åœ¨ `externally_connectable` é…ç½®ä¸­å…è®¸çš„ **Web åº”ç”¨ç¨‹åºå’Œå¤–éƒ¨æµè§ˆå™¨æ‰©å±•** å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼å‘é€è¯·æ±‚ï¼š
```javascript
chrome.runtime.sendMessage(extensionId, ...
```
éœ€è¦æåˆ° **extension ID** çš„åœ°æ–¹ã€‚

### æœ¬åœ°æ¶ˆæ¯ä¼ é€’

èƒŒæ™¯è„šæœ¬å¯ä»¥ä¸ç³»ç»Ÿå†…çš„äºŒè¿›åˆ¶æ–‡ä»¶è¿›è¡Œé€šä¿¡ï¼Œå¦‚æœè¿™ç§é€šä¿¡æ²¡æœ‰å¾—åˆ°å¦¥å–„ä¿æŠ¤ï¼Œå¯èƒ½ä¼š **å®¹æ˜“å—åˆ°è¯¸å¦‚ RCEs çš„å…³é”®æ¼æ´**ã€‚ [ç¨åä¼šè¯¦ç»†ä»‹ç»](./#native-messaging)ã€‚
```javascript
chrome.runtime.sendNativeMessage(
'com.my_company.my_application',
{text: 'Hello'},
function (response) {
console.log('Received ' + response);
}
);
```
## Web **â†”ï¸** å†…å®¹è„šæœ¬é€šä¿¡

**å†…å®¹è„šæœ¬** æ“ä½œçš„ç¯å¢ƒä¸ä¸»æœºé¡µé¢å­˜åœ¨çš„ç¯å¢ƒæ˜¯ **åˆ†å¼€çš„**ï¼Œç¡®ä¿äº† **éš”ç¦»**ã€‚å°½ç®¡å­˜åœ¨è¿™ç§éš”ç¦»ï¼ŒåŒæ–¹éƒ½èƒ½å¤Ÿä¸é¡µé¢çš„ **æ–‡æ¡£å¯¹è±¡æ¨¡å‹ (DOM)** è¿›è¡Œäº¤äº’ï¼Œè¿™æ˜¯ä¸€ä¸ªå…±äº«èµ„æºã€‚ä¸ºäº†ä½¿ä¸»æœºé¡µé¢èƒ½å¤Ÿä¸ **å†…å®¹è„šæœ¬** è¿›è¡Œé€šä¿¡ï¼Œæˆ–é€šè¿‡å†…å®¹è„šæœ¬é—´æ¥ä¸æ‰©å±•è¿›è¡Œé€šä¿¡ï¼Œå¿…é¡»åˆ©ç”¨åŒæ–¹éƒ½å¯ä»¥è®¿é—®çš„ **DOM** ä½œä¸ºé€šä¿¡é€šé“ã€‚

### å‘é€æ¶ˆæ¯

{% code title="content-script.js" %}
```javascript
// This is like "chrome.runtime.sendMessage" but to maintain the connection
var port = chrome.runtime.connect();

window.addEventListener("message", (event) => {
// We only accept messages from ourselves
if (event.source !== window) {
return;
}

if (event.data.type && (event.data.type === "FROM_PAGE")) {
console.log("Content script received: " + event.data.text);
// Forward the message to the background script
port.postMessage(event.data.text);
}
}, false);
```
{% endcode %}

{% code title="example.js" %}
```javascript
document.getElementById("theButton").addEventListener("click", () => {
window.postMessage(
{type : "FROM_PAGE", text : "Hello from the webpage!"}, "*");
}, false);
```
{% endcode %}

å®‰å…¨çš„ Post Message é€šä¿¡åº”æ£€æŸ¥æ¥æ”¶æ¶ˆæ¯çš„çœŸå®æ€§ï¼Œè¿™å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è¿›è¡Œæ£€æŸ¥ï¼š

* **`event.isTrusted`**ï¼šåªæœ‰å½“äº‹ä»¶æ˜¯ç”±ç”¨æˆ·æ“ä½œè§¦å‘æ—¶ï¼Œè¿™ä¸ªå€¼æ‰ä¸º True
* å†…å®¹è„šæœ¬å¯èƒ½åªåœ¨ç”¨æˆ·æ‰§è¡ŒæŸäº›æ“ä½œæ—¶æ‰æœŸå¾…æ¥æ”¶åˆ°æ¶ˆæ¯
* **origin domain**ï¼šå¯èƒ½åªå…è®¸ç™½åå•ä¸­çš„åŸŸåæ¥æ”¶æ¶ˆæ¯ã€‚
* å¦‚æœä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼Œè¯·éå¸¸å°å¿ƒ
* **Source**ï¼š`received_message.source !== window` å¯ç”¨äºæ£€æŸ¥æ¶ˆæ¯æ˜¯å¦æ¥è‡ª **åŒä¸€çª—å£**ï¼Œå³å†…å®¹è„šæœ¬æ­£åœ¨ç›‘å¬çš„çª—å£ã€‚

å³ä½¿æ‰§è¡Œäº†ä¸Šè¿°æ£€æŸ¥ï¼Œä»å¯èƒ½å­˜åœ¨æ¼æ´ï¼Œå› æ­¤è¯·æŸ¥çœ‹ä»¥ä¸‹é¡µé¢ **æ½œåœ¨çš„ Post Message ç»•è¿‡**ï¼š

{% content-ref url="../postmessage-vulnerabilities/" %}
[postmessage-vulnerabilities](../postmessage-vulnerabilities/)
{% endcontent-ref %}

### Iframe

å¦ä¸€ç§å¯èƒ½çš„é€šä¿¡æ–¹å¼å¯èƒ½æ˜¯é€šè¿‡ **Iframe URLs**ï¼Œæ‚¨å¯ä»¥åœ¨ä»¥ä¸‹ä½ç½®æ‰¾åˆ°ç¤ºä¾‹ï¼š

{% content-ref url="browext-xss-example.md" %}
[browext-xss-example.md](browext-xss-example.md)
{% endcontent-ref %}

### DOM

è¿™å¹¶ä¸æ˜¯â€œç¡®åˆ‡çš„â€é€šä¿¡æ–¹å¼ï¼Œä½† **ç½‘é¡µå’Œå†…å®¹è„šæœ¬å°†å¯ä»¥è®¿é—®ç½‘é¡µ DOM**ã€‚å› æ­¤ï¼Œå¦‚æœ **å†…å®¹è„šæœ¬** ä»ä¸­è¯»å–æŸäº›ä¿¡æ¯ï¼Œ**ä¿¡ä»»ç½‘é¡µ DOM**ï¼Œç½‘é¡µå¯èƒ½ä¼š **ä¿®æ”¹è¿™äº›æ•°æ®**ï¼ˆå› ä¸ºç½‘é¡µä¸åº”è¢«ä¿¡ä»»ï¼Œæˆ–å› ä¸ºç½‘é¡µæ˜“å— XSS æ”»å‡»ï¼‰å¹¶ **å±å®³å†…å®¹è„šæœ¬**ã€‚

æ‚¨è¿˜å¯ä»¥åœ¨ä»¥ä¸‹ä½ç½®æ‰¾åˆ°ä¸€ä¸ª **åŸºäº DOM çš„ XSS ä»¥å±å®³æµè§ˆå™¨æ‰©å±•** çš„ç¤ºä¾‹ï¼š

{% content-ref url="browext-xss-example.md" %}
[browext-xss-example.md](browext-xss-example.md)
{% endcontent-ref %}

## å†…å®¹è„šæœ¬ **â†”ï¸** åå°è„šæœ¬é€šä¿¡

å†…å®¹è„šæœ¬å¯ä»¥ä½¿ç”¨ [**runtime.sendMessage()**](https://developer.chrome.com/docs/extensions/reference/runtime#method-sendMessage) **æˆ–** [**tabs.sendMessage()**](https://developer.chrome.com/docs/extensions/reference/tabs#method-sendMessage) å‘é€ **ä¸€æ¬¡æ€§ JSON å¯åºåˆ—åŒ–** æ¶ˆæ¯ã€‚

è¦å¤„ç† **å“åº”**ï¼Œè¯·ä½¿ç”¨è¿”å›çš„ **Promise**ã€‚å°½ç®¡ä¸ºäº†å‘åå…¼å®¹ï¼Œæ‚¨ä»ç„¶å¯ä»¥å°† **å›è°ƒ** ä½œä¸ºæœ€åä¸€ä¸ªå‚æ•°ä¼ é€’ã€‚

ä» **å†…å®¹è„šæœ¬** å‘é€è¯·æ±‚çš„æ–¹å¼å¦‚ä¸‹ï¼š
```javascript
(async () => {
const response = await chrome.runtime.sendMessage({greeting: "hello"});
// do something with response here, not outside the function
console.log(response);
})();
```
ä»**æ‰©å±•**ï¼ˆé€šå¸¸æ˜¯**åå°è„šæœ¬**ï¼‰å‘é€è¯·æ±‚ã€‚ä»¥ä¸‹æ˜¯å¦‚ä½•å‘é€‰å®šæ ‡ç­¾é¡µä¸­çš„å†…å®¹è„šæœ¬å‘é€æ¶ˆæ¯çš„ç¤ºä¾‹ï¼š
```javascript
// From https://stackoverflow.com/questions/36153999/how-to-send-a-message-between-chrome-extension-popup-and-content-script
(async () => {
const [tab] = await chrome.tabs.query({active: true, lastFocusedWindow: true});
const response = await chrome.tabs.sendMessage(tab.id, {greeting: "hello"});
// do something with response here, not outside the function
console.log(response);
})();
```
åœ¨**æ¥æ”¶ç«¯**ï¼Œæ‚¨éœ€è¦è®¾ç½®ä¸€ä¸ª [**runtime.onMessage**](https://developer.chrome.com/docs/extensions/reference/runtime#event-onMessage) **äº‹ä»¶ç›‘å¬å™¨** æ¥å¤„ç†æ¶ˆæ¯ã€‚è¿™åœ¨å†…å®¹è„šæœ¬æˆ–æ‰©å±•é¡µé¢ä¸­çœ‹èµ·æ¥æ˜¯ä¸€æ ·çš„ã€‚
```javascript
// From https://stackoverflow.com/questions/70406787/javascript-send-message-from-content-js-to-background-js
chrome.runtime.onMessage.addListener(
function(request, sender, sendResponse) {
console.log(sender.tab ?
"from a content script:" + sender.tab.url :
"from the extension");
if (request.greeting === "hello")
sendResponse({farewell: "goodbye"});
}
);
```
åœ¨çªå‡ºæ˜¾ç¤ºçš„ç¤ºä¾‹ä¸­ï¼Œ**`sendResponse()`** æ˜¯ä»¥åŒæ­¥æ–¹å¼æ‰§è¡Œçš„ã€‚è¦ä¿®æ”¹ `onMessage` äº‹ä»¶å¤„ç†ç¨‹åºä»¥å¼‚æ­¥æ‰§è¡Œ `sendResponse()`ï¼Œå¿…é¡»åŠ å…¥ `return true;`ã€‚

ä¸€ä¸ªé‡è¦çš„è€ƒè™‘æ˜¯ï¼Œåœ¨å¤šä¸ªé¡µé¢è®¾ç½®ä¸ºæ¥æ”¶ `onMessage` äº‹ä»¶çš„æƒ…å†µä¸‹ï¼Œ**ç¬¬ä¸€ä¸ªæ‰§è¡Œ `sendResponse()`** çš„é¡µé¢å°†æ˜¯å”¯ä¸€èƒ½å¤Ÿæœ‰æ•ˆä¼ é€’å“åº”çš„é¡µé¢ã€‚å¯¹åŒä¸€äº‹ä»¶çš„ä»»ä½•åç»­å“åº”å°†ä¸è¢«è€ƒè™‘ã€‚

åœ¨åˆ›å»ºæ–°æ‰©å±•æ—¶ï¼Œåº”è¯¥ä¼˜å…ˆä½¿ç”¨ promises è€Œä¸æ˜¯å›è°ƒã€‚å…³äºå›è°ƒçš„ä½¿ç”¨ï¼Œåªæœ‰åœ¨åŒæ­¥ä¸Šä¸‹æ–‡ä¸­ç›´æ¥æ‰§è¡Œ `sendResponse()` å‡½æ•°ï¼Œæˆ–è€…äº‹ä»¶å¤„ç†ç¨‹åºé€šè¿‡è¿”å› `true` è¡¨ç¤ºå¼‚æ­¥æ“ä½œæ—¶ï¼Œ`sendResponse()` å‡½æ•°æ‰è¢«è§†ä¸ºæœ‰æ•ˆã€‚å¦‚æœæ²¡æœ‰ä»»ä½•å¤„ç†ç¨‹åºè¿”å› `true`ï¼Œæˆ–è€… `sendResponse()` å‡½æ•°ä»å†…å­˜ä¸­ç§»é™¤ï¼ˆè¢«åƒåœ¾å›æ”¶ï¼‰ï¼Œåˆ™ä¸ `sendMessage()` å‡½æ•°å…³è”çš„å›è°ƒå°†é»˜è®¤è¢«è§¦å‘ã€‚

## Native Messaging

æµè§ˆå™¨æ‰©å±•è¿˜å…è®¸é€šè¿‡ **stdin** ä¸ç³»ç»Ÿä¸­çš„ **äºŒè¿›åˆ¶æ–‡ä»¶** è¿›è¡Œé€šä¿¡ã€‚åº”ç”¨ç¨‹åºå¿…é¡»å®‰è£…ä¸€ä¸ª json æ¥æŒ‡ç¤ºè¿™ä¸€ç‚¹ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
```json
{
"name": "com.my_company.my_application",
"description": "My Application",
"path": "C:\\Program Files\\My Application\\chrome_native_messaging_host.exe",
"type": "stdio",
"allowed_origins": ["chrome-extension://knldjmfmopnpolahpmmgbagdohdnhkik/"]
}
```
```markdown
å…¶ä¸­ `name` æ˜¯ä¼ é€’ç»™ [`runtime.connectNative()`](https://developer.chrome.com/docs/extensions/reference/api/runtime#method-connectNative) æˆ– [`runtime.sendNativeMessage()`](https://developer.chrome.com/docs/extensions/reference/api/runtime#method-sendNativeMessage) çš„å­—ç¬¦ä¸²ï¼Œç”¨äºä»æµè§ˆå™¨æ‰©å±•çš„åå°è„šæœ¬ä¸åº”ç”¨ç¨‹åºè¿›è¡Œé€šä¿¡ã€‚`path` æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶çš„è·¯å¾„ï¼Œåªæœ‰ 1 ä¸ªæœ‰æ•ˆçš„ `type`ï¼Œå³ stdioï¼ˆä½¿ç”¨ stdin å’Œ stdoutï¼‰ï¼Œè€Œ `allowed_origins` è¡¨ç¤ºå¯ä»¥è®¿é—®å®ƒçš„æ‰©å±•ï¼ˆä¸èƒ½ä½¿ç”¨é€šé…ç¬¦ï¼‰ã€‚

Chrome/Chromium ä¼šåœ¨æŸäº› Windows æ³¨å†Œè¡¨å’Œ macOS å’Œ Linux çš„æŸäº›è·¯å¾„ä¸­æœç´¢æ­¤ jsonï¼ˆæ›´å¤šä¿¡æ¯è¯·å‚è§ [**docs**](https://developer.chrome.com/docs/extensions/develop/concepts/native-messaging)ï¼‰ã€‚

{% hint style="success" %}
æµè§ˆå™¨æ‰©å±•è¿˜éœ€è¦å£°æ˜ `nativeMessaing` æƒé™ï¼Œä»¥ä¾¿èƒ½å¤Ÿä½¿ç”¨æ­¤é€šä¿¡ã€‚
{% endhint %}

è¿™å°±æ˜¯ä¸€äº›åå°è„šæœ¬ä»£ç å‘æœ¬åœ°åº”ç”¨ç¨‹åºå‘é€æ¶ˆæ¯çš„æ ·å­ï¼š
```
```javascript
chrome.runtime.sendNativeMessage(
'com.my_company.my_application',
{text: 'Hello'},
function (response) {
console.log('Received ' + response);
}
);
```
åœ¨[**è¿™ç¯‡åšå®¢æ–‡ç« **](https://spaceraccoon.dev/universal-code-execution-browser-extensions/)ä¸­ï¼Œæå‡ºäº†ä¸€ç§åˆ©ç”¨æœ¬æœºæ¶ˆæ¯çš„è„†å¼±æ¨¡å¼ï¼š

1. æµè§ˆå™¨æ‰©å±•å¯¹å†…å®¹è„šæœ¬æœ‰ä¸€ä¸ªé€šé…ç¬¦æ¨¡å¼ã€‚
2. å†…å®¹è„šæœ¬ä½¿ç”¨`sendMessage`å°†`postMessage`æ¶ˆæ¯ä¼ é€’ç»™åå°è„šæœ¬ã€‚
3. åå°è„šæœ¬ä½¿ç”¨`sendNativeMessage`å°†æ¶ˆæ¯ä¼ é€’ç»™æœ¬æœºåº”ç”¨ç¨‹åºã€‚
4. æœ¬æœºåº”ç”¨ç¨‹åºä»¥å±é™©çš„æ–¹å¼å¤„ç†æ¶ˆæ¯ï¼Œå¯¼è‡´ä»£ç æ‰§è¡Œã€‚

åœ¨å…¶ä¸­ï¼Œ**è§£é‡Šäº†å¦‚ä½•ä»ä»»ä½•é¡µé¢åˆ©ç”¨æµè§ˆå™¨æ‰©å±•è¿›è¡ŒRCE**çš„ç¤ºä¾‹ã€‚

## å†…å­˜/ä»£ç /å‰ªè´´æ¿ä¸­çš„æ•æ„Ÿä¿¡æ¯

å¦‚æœæµè§ˆå™¨æ‰©å±•å°†**æ•æ„Ÿä¿¡æ¯å­˜å‚¨åœ¨å…¶å†…å­˜ä¸­**ï¼Œåˆ™å¯èƒ½ä¼šè¢«**è½¬å‚¨**ï¼ˆç‰¹åˆ«æ˜¯åœ¨Windowsæœºå™¨ä¸Šï¼‰å¹¶**æœç´¢**è¿™äº›ä¿¡æ¯ã€‚

å› æ­¤ï¼Œæµè§ˆå™¨æ‰©å±•çš„å†…å­˜**ä¸åº”è¢«è§†ä¸ºå®‰å…¨**ï¼Œå¹¶ä¸”**æ•æ„Ÿä¿¡æ¯**å¦‚å‡­æ®æˆ–åŠ©è®°çŸ­è¯­**ä¸åº”å­˜å‚¨**ã€‚

å½“ç„¶ï¼Œ**ä¸è¦å°†æ•æ„Ÿä¿¡æ¯æ”¾å…¥ä»£ç ä¸­**ï¼Œå› ä¸ºå®ƒå°†æ˜¯**å…¬å¼€çš„**ã€‚

è¦ä»æµè§ˆå™¨è½¬å‚¨å†…å­˜ï¼Œæ‚¨å¯ä»¥**è½¬å‚¨è¿›ç¨‹å†…å­˜**ï¼Œæˆ–è€…è¦è¿›å…¥æµè§ˆå™¨æ‰©å±•çš„**è®¾ç½®**ï¼Œç‚¹å‡»**`Inspect pop-up`** -> åœ¨**`Memory`**éƒ¨åˆ† -> **`Take a snapshot`**ï¼Œç„¶åä½¿ç”¨**`CTRL+F`**åœ¨å¿«ç…§ä¸­æœç´¢æ•æ„Ÿä¿¡æ¯ã€‚

æ­¤å¤–ï¼ŒåƒåŠ©è®°å¯†é’¥æˆ–å¯†ç è¿™æ ·çš„é«˜åº¦æ•æ„Ÿä¿¡æ¯**ä¸åº”å…è®¸å¤åˆ¶åˆ°å‰ªè´´æ¿**ï¼ˆæˆ–è‡³å°‘åœ¨å‡ ç§’é’Ÿå†…å°†å…¶ä»å‰ªè´´æ¿ä¸­ç§»é™¤ï¼‰ï¼Œå› ä¸ºè¿™æ ·ç›‘æ§å‰ªè´´æ¿çš„è¿›ç¨‹å°†èƒ½å¤Ÿè·å–å®ƒä»¬ã€‚

## åœ¨æµè§ˆå™¨ä¸­åŠ è½½æ‰©å±•

1. **ä¸‹è½½**æµè§ˆå™¨æ‰©å±•å¹¶è§£å‹
2. è½¬åˆ°**`chrome://extensions/`**å¹¶**å¯ç”¨**`å¼€å‘è€…æ¨¡å¼`
3. ç‚¹å‡»**`åŠ è½½å·²è§£å‹çš„æ‰©å±•`**æŒ‰é’®

åœ¨**Firefox**ä¸­ï¼Œæ‚¨è½¬åˆ°**`about:debugging#/runtime/this-firefox`**å¹¶ç‚¹å‡»**`åŠ è½½ä¸´æ—¶é™„åŠ ç»„ä»¶`**æŒ‰é’®ã€‚

## ä»å•†åº—è·å–æºä»£ç 

Chromeæ‰©å±•çš„æºä»£ç å¯ä»¥é€šè¿‡å¤šç§æ–¹æ³•è·å¾—ã€‚ä»¥ä¸‹æ˜¯æ¯ä¸ªé€‰é¡¹çš„è¯¦ç»†è¯´æ˜å’ŒæŒ‡ç¤ºã€‚

### é€šè¿‡å‘½ä»¤è¡Œå°†æ‰©å±•ä¸‹è½½ä¸ºZIP

Chromeæ‰©å±•çš„æºä»£ç å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œä¸‹è½½ä¸ºZIPæ–‡ä»¶ã€‚è¿™æ¶‰åŠä½¿ç”¨`curl`ä»ç‰¹å®šURLè·å–ZIPæ–‡ä»¶ï¼Œç„¶åå°†ZIPæ–‡ä»¶çš„å†…å®¹æå–åˆ°ä¸€ä¸ªç›®å½•ä¸­ã€‚ä»¥ä¸‹æ˜¯æ­¥éª¤ï¼š

1. å°†`"extension_id"`æ›¿æ¢ä¸ºæ‰©å±•çš„å®é™…IDã€‚
2. æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š
```bash
extension_id=your_extension_id   # Replace with the actual extension ID
curl -L -o "$extension_id.zip" "https://clients2.google.com/service/update2/crx?response=redirect&os=mac&arch=x86-64&nacl_arch=x86-64&prod=chromecrx&prodchannel=stable&prodversion=44.0.2403.130&x=id%3D$extension_id%26uc"
unzip -d "$extension_id-source" "$extension_id.zip"
```
### ä½¿ç”¨ CRX Viewer ç½‘ç«™

[https://robwu.nl/crxviewer/](https://robwu.nl/crxviewer/)

### ä½¿ç”¨ CRX Viewer æ‰©å±•

å¦ä¸€ç§æ–¹ä¾¿çš„æ–¹æ³•æ˜¯ä½¿ç”¨ Chrome æ‰©å±•æºæŸ¥çœ‹å™¨ï¼Œè¿™æ˜¯ä¸€ä¸ªå¼€æºé¡¹ç›®ã€‚å¯ä»¥ä» [Chrome Web Store](https://chrome.google.com/webstore/detail/chrome-extension-source-v/jifpbeccnghkjeaalbbjmodiffmgedin?hl=en) å®‰è£…ã€‚æŸ¥çœ‹å™¨çš„æºä»£ç å¯åœ¨å…¶ [GitHub ä»“åº“](https://github.com/Rob--W/crxviewer) ä¸­æ‰¾åˆ°ã€‚

### æŸ¥çœ‹æœ¬åœ°å®‰è£…çš„æ‰©å±•çš„æºä»£ç 

æœ¬åœ°å®‰è£…çš„ Chrome æ‰©å±•ä¹Ÿå¯ä»¥è¿›è¡Œæ£€æŸ¥ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š

1. é€šè¿‡è®¿é—® `chrome://version/` å¹¶æ‰¾åˆ°â€œProfile Pathâ€å­—æ®µæ¥è®¿é—®æ‚¨çš„ Chrome æœ¬åœ°é…ç½®æ–‡ä»¶ç›®å½•ã€‚
2. åœ¨é…ç½®æ–‡ä»¶ç›®å½•ä¸­å¯¼èˆªåˆ° `Extensions/` å­æ–‡ä»¶å¤¹ã€‚
3. æ­¤æ–‡ä»¶å¤¹åŒ…å«æ‰€æœ‰å·²å®‰è£…çš„æ‰©å±•ï¼Œé€šå¸¸å…¶æºä»£ç ä»¥å¯è¯»æ ¼å¼å­˜æ”¾ã€‚

è¦è¯†åˆ«æ‰©å±•ï¼Œæ‚¨å¯ä»¥å°†å…¶ ID æ˜ å°„åˆ°åç§°ï¼š

* åœ¨ `about:extensions` é¡µé¢ä¸Šå¯ç”¨å¼€å‘è€…æ¨¡å¼ï¼Œä»¥æŸ¥çœ‹æ¯ä¸ªæ‰©å±•çš„ IDã€‚
* åœ¨æ¯ä¸ªæ‰©å±•çš„æ–‡ä»¶å¤¹ä¸­ï¼Œ`manifest.json` æ–‡ä»¶åŒ…å«ä¸€ä¸ªå¯è¯»çš„ `name` å­—æ®µï¼Œå¸®åŠ©æ‚¨è¯†åˆ«æ‰©å±•ã€‚

### ä½¿ç”¨æ–‡ä»¶å½’æ¡£ç¨‹åºæˆ–è§£å‹ç¼©å·¥å…·

å‰å¾€ Chrome Web Store ä¸‹è½½æ‰©å±•ã€‚æ–‡ä»¶å°†å…·æœ‰ `.crx` æ‰©å±•åã€‚å°†æ–‡ä»¶æ‰©å±•åä» `.crx` æ›´æ”¹ä¸º `.zip`ã€‚ä½¿ç”¨ä»»ä½•æ–‡ä»¶å½’æ¡£ç¨‹åºï¼ˆå¦‚ WinRARã€7-Zip ç­‰ï¼‰æå– ZIP æ–‡ä»¶çš„å†…å®¹ã€‚

### åœ¨ Chrome ä¸­ä½¿ç”¨å¼€å‘è€…æ¨¡å¼

æ‰“å¼€ Chrome å¹¶è½¬åˆ° `chrome://extensions/`ã€‚åœ¨å³ä¸Šè§’å¯ç”¨â€œå¼€å‘è€…æ¨¡å¼â€ã€‚ç‚¹å‡»â€œåŠ è½½å·²è§£å‹çš„æ‰©å±•...â€ã€‚å¯¼èˆªåˆ°æ‚¨çš„æ‰©å±•ç›®å½•ã€‚è¿™ä¸ä¼šä¸‹è½½æºä»£ç ï¼Œä½†å¯¹äºæŸ¥çœ‹å’Œä¿®æ”¹å·²ä¸‹è½½æˆ–å¼€å‘çš„æ‰©å±•çš„ä»£ç éå¸¸æœ‰ç”¨ã€‚

## Chrome æ‰©å±•æ¸…å•æ•°æ®é›†

ä¸ºäº†å°è¯•å‘ç°æ˜“å—æ”»å‡»çš„æµè§ˆå™¨æ‰©å±•ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ [https://github.com/palant/chrome-extension-manifests-dataset](https://github.com/palant/chrome-extension-manifests-dataset) å¹¶æ£€æŸ¥å…¶æ¸…å•æ–‡ä»¶ä»¥å¯»æ‰¾æ½œåœ¨çš„è„†å¼±è¿¹è±¡ã€‚ä¾‹å¦‚ï¼Œæ£€æŸ¥ç”¨æˆ·è¶…è¿‡ 25000 çš„æ‰©å±•ï¼Œ`content_scripts` å’Œæƒé™ `nativeMessaing`ï¼š

{% code overflow="wrap" %}
```bash
# Query example from https://spaceraccoon.dev/universal-code-execution-browser-extensions/
node query.js -f "metadata.user_count > 250000" "manifest.content_scripts?.length > 0 && manifest.permissions?.includes('nativeMessaging')"
```
{% endcode %}

## å®‰å…¨å®¡è®¡æ£€æŸ¥æ¸…å•

å°½ç®¡æµè§ˆå™¨æ‰©å±•å…·æœ‰**æœ‰é™çš„æ”»å‡»é¢**ï¼Œä½†å…¶ä¸­ä¸€äº›å¯èƒ½åŒ…å«**æ¼æ´**æˆ–**æ½œåœ¨çš„åŠ å›ºæ”¹è¿›**ã€‚ä»¥ä¸‹æ˜¯æœ€å¸¸è§çš„ï¼š

* [ ] å°½å¯èƒ½**é™åˆ¶**è¯·æ±‚çš„**`permissions`**
* [ ] å°½å¯èƒ½**é™åˆ¶****`host_permissions`**
* [ ] ä½¿ç”¨**å¼º**çš„**`content_security_policy`**
* [ ] å°½å¯èƒ½**é™åˆ¶****`externally_connectable`**ï¼Œå¦‚æœä¸éœ€è¦ä¸”å¯èƒ½ï¼Œè¯·ä¸è¦é»˜è®¤ç•™ç©ºï¼ŒæŒ‡å®š**`{}`**
* [ ] å¦‚æœè¿™é‡Œæåˆ°çš„**URLæ˜“å—XSSæˆ–æ¥ç®¡æ”»å‡»**ï¼Œæ”»å‡»è€…å°†èƒ½å¤Ÿ**ç›´æ¥å‘åå°è„šæœ¬å‘é€æ¶ˆæ¯**ã€‚éå¸¸å¼ºå¤§çš„ç»•è¿‡æ–¹å¼ã€‚
* [ ] å°½å¯èƒ½**é™åˆ¶****`web_accessible_resources`**ï¼Œå¦‚æœå¯èƒ½ï¼Œç”šè‡³ç•™ç©ºã€‚
* [ ] å¦‚æœ**`web_accessible_resources`**ä¸ä¸ºç©ºï¼Œè¯·æ£€æŸ¥[**ClickJacking**](browext-clickjacking.md)
* [ ] å¦‚æœ**æ‰©å±•**ä¸**ç½‘é¡µ**ä¹‹é—´å‘ç”Ÿä»»ä½•**é€šä¿¡**ï¼Œè¯·[**æ£€æŸ¥XSS**](browext-xss-example.md) **æ¼æ´**ã€‚
* [ ] å¦‚æœä½¿ç”¨äº†Post Messagesï¼Œè¯·æ£€æŸ¥[**Post Messageæ¼æ´**](../postmessage-vulnerabilities/)**ã€‚**
* [ ] å¦‚æœ**å†…å®¹è„šæœ¬è®¿é—®DOMç»†èŠ‚**ï¼Œè¯·æ£€æŸ¥å®ƒä»¬æ˜¯å¦åœ¨è¢«ç½‘é¡µ**ä¿®æ”¹**æ—¶**å¼•å…¥XSS**ã€‚
* [ ] å¦‚æœæ­¤é€šä¿¡ä¹Ÿæ¶‰åŠ**å†…å®¹è„šæœ¬ -> åå°è„šæœ¬é€šä¿¡**ï¼Œè¯·ç‰¹åˆ«å¼ºè°ƒã€‚
* [ ] å¦‚æœåå°è„šæœ¬é€šè¿‡**æœ¬æœºæ¶ˆæ¯ä¼ é€’**è¿›è¡Œé€šä¿¡ï¼Œè¯·æ£€æŸ¥é€šä¿¡æ˜¯å¦å®‰å…¨ä¸”ç»è¿‡æ¸…ç†ã€‚
* [ ] **æ•æ„Ÿä¿¡æ¯ä¸åº”å­˜å‚¨**åœ¨æµè§ˆå™¨æ‰©å±•**ä»£ç **ä¸­ã€‚
* [ ] **æ•æ„Ÿä¿¡æ¯ä¸åº”å­˜å‚¨**åœ¨æµè§ˆå™¨æ‰©å±•**å†…å­˜**ä¸­ã€‚
* [ ] **æ•æ„Ÿä¿¡æ¯ä¸åº”å­˜å‚¨**åœ¨**æ–‡ä»¶ç³»ç»Ÿä¸­æœªåŠ ä¿æŠ¤**ã€‚

## å·¥å…·

### [**Tarnish**](https://thehackerblog.com/tarnish/)

* ä»æä¾›çš„Chromeç½‘ä¸Šåº”ç”¨åº—é“¾æ¥ä¸­æå–ä»»ä½•Chromeæ‰©å±•ã€‚
* [**manifest.json**](https://developer.chrome.com/extensions/manifest) **æŸ¥çœ‹å™¨**ï¼šç®€å•åœ°æ˜¾ç¤ºæ‰©å±•çš„manifestçš„JSONç¾åŒ–ç‰ˆæœ¬ã€‚
* **æŒ‡çº¹åˆ†æ**ï¼šæ£€æµ‹[web\_accessible\_resources](https://developer.chrome.com/extensions/manifest/web\_accessible\_resources)å¹¶è‡ªåŠ¨ç”ŸæˆChromeæ‰©å±•æŒ‡çº¹JavaScriptã€‚
* **æ½œåœ¨çš„Clickjackingåˆ†æ**ï¼šæ£€æµ‹è®¾ç½®äº†[web\_accessible\_resources](https://developer.chrome.com/extensions/manifest/web\_accessible\_resources)æŒ‡ä»¤çš„æ‰©å±•HTMLé¡µé¢ã€‚è¿™äº›é¡µé¢å¯èƒ½ä¼šå—åˆ°Clickjackingçš„æ”»å‡»ï¼Œå…·ä½“å–å†³äºé¡µé¢çš„ç›®çš„ã€‚
* **æƒé™è­¦å‘ŠæŸ¥çœ‹å™¨**ï¼šæ˜¾ç¤ºç”¨æˆ·å°è¯•å®‰è£…æ‰©å±•æ—¶å°†æ˜¾ç¤ºçš„æ‰€æœ‰Chromeæƒé™æç¤ºè­¦å‘Šçš„åˆ—è¡¨ã€‚
* **å±é™©å‡½æ•°**ï¼šæ˜¾ç¤ºå¯èƒ½è¢«æ”»å‡»è€…åˆ©ç”¨çš„å±é™©å‡½æ•°çš„ä½ç½®ï¼ˆä¾‹å¦‚ï¼ŒinnerHTMLã€chrome.tabs.executeScriptç­‰å‡½æ•°ï¼‰ã€‚
* **å…¥å£ç‚¹**ï¼šæ˜¾ç¤ºæ‰©å±•æ¥æ”¶ç”¨æˆ·/å¤–éƒ¨è¾“å…¥çš„ä½ç½®ã€‚è¿™å¯¹äºç†è§£æ‰©å±•çš„è¡¨é¢åŒºåŸŸå’Œå¯»æ‰¾æ½œåœ¨çš„æ¶æ„æ•°æ®å‘é€ç‚¹éå¸¸æœ‰ç”¨ã€‚
* å±é™©å‡½æ•°å’Œå…¥å£ç‚¹æ‰«æå™¨ç”Ÿæˆçš„è­¦æŠ¥åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š
* ç›¸å…³ä»£ç ç‰‡æ®µå’Œå¯¼è‡´è­¦æŠ¥çš„è¡Œã€‚
* é—®é¢˜æè¿°ã€‚
* â€œæŸ¥çœ‹æ–‡ä»¶â€æŒ‰é’®ä»¥æŸ¥çœ‹åŒ…å«ä»£ç çš„å®Œæ•´æºæ–‡ä»¶ã€‚
* è­¦æŠ¥æ–‡ä»¶çš„è·¯å¾„ã€‚
* è­¦æŠ¥æ–‡ä»¶çš„å®Œæ•´Chromeæ‰©å±•URIã€‚
* æ–‡ä»¶ç±»å‹ï¼Œä¾‹å¦‚åå°é¡µé¢è„šæœ¬ã€å†…å®¹è„šæœ¬ã€æµè§ˆå™¨æ“ä½œç­‰ã€‚
* å¦‚æœæ˜“å—æ”»å‡»çš„è¡Œåœ¨JavaScriptæ–‡ä»¶ä¸­ï¼ŒåŒ…å«æ‰€æœ‰åŒ…å«è¯¥è¡Œçš„é¡µé¢çš„è·¯å¾„ä»¥åŠè¿™äº›é¡µé¢çš„ç±»å‹å’Œ[web\_accessible\_resource](https://developer.chrome.com/extensions/manifest/web\_accessible\_resources)çŠ¶æ€ã€‚
* **å†…å®¹å®‰å…¨ç­–ç•¥ï¼ˆCSPï¼‰åˆ†æå™¨å’Œç»•è¿‡æ£€æŸ¥å™¨**ï¼šè¿™å°†æŒ‡å‡ºæ‰©å±•CSPä¸­çš„å¼±ç‚¹ï¼Œå¹¶å°†æ­ç¤ºç”±äºç™½åå•CDNç­‰åŸå› ç»•è¿‡CSPçš„æ½œåœ¨æ–¹æ³•ã€‚
* **å·²çŸ¥æ¼æ´åº“**ï¼šä½¿ç”¨[Retire.js](https://retirejs.github.io/retire.js/)æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†å·²çŸ¥æ¼æ´çš„JavaScriptåº“ã€‚
* ä¸‹è½½æ‰©å±•å’Œæ ¼å¼åŒ–ç‰ˆæœ¬ã€‚
* ä¸‹è½½åŸå§‹æ‰©å±•ã€‚
* ä¸‹è½½ç¾åŒ–ç‰ˆæœ¬çš„æ‰©å±•ï¼ˆè‡ªåŠ¨ç¾åŒ–çš„HTMLå’ŒJavaScriptï¼‰ã€‚
* æ‰«æç»“æœçš„è‡ªåŠ¨ç¼“å­˜ï¼Œç¬¬ä¸€æ¬¡è¿è¡Œæ‰©å±•æ‰«æå°†èŠ±è´¹ç›¸å½“å¤šçš„æ—¶é—´ã€‚ç„¶è€Œï¼Œç¬¬äºŒæ¬¡è¿è¡Œæ—¶ï¼Œå‡è®¾æ‰©å±•æ²¡æœ‰æ›´æ–°ï¼Œå°†å‡ ä¹æ˜¯ç¬æ—¶çš„ï¼Œå› ä¸ºç»“æœè¢«ç¼“å­˜ã€‚
* å¯é“¾æ¥çš„æŠ¥å‘ŠURLï¼Œè½»æ¾å°†å…¶ä»–äººé“¾æ¥åˆ°ç”±Tarnishç”Ÿæˆçš„æ‰©å±•æŠ¥å‘Šã€‚

### [Neto](https://github.com/elevenpaths/neto)

é¡¹ç›®Netoæ˜¯ä¸€ä¸ªPython 3åŒ…ï¼Œæ—¨åœ¨åˆ†æå’Œæ­ç¤ºçŸ¥åæµè§ˆå™¨ï¼ˆå¦‚Firefoxå’ŒChromeï¼‰æµè§ˆå™¨æ’ä»¶å’Œæ‰©å±•çš„éšè—åŠŸèƒ½ã€‚å®ƒè‡ªåŠ¨è§£å‹æ‰“åŒ…æ–‡ä»¶ï¼Œä»¥ä»æ‰©å±•çš„ç›¸å…³èµ„æºä¸­æå–è¿™äº›åŠŸèƒ½ï¼Œå¦‚`manifest.json`ã€æœ¬åœ°åŒ–æ–‡ä»¶å¤¹æˆ–JavaScriptå’ŒHTMLæºæ–‡ä»¶ã€‚

## å‚è€ƒæ–‡çŒ®

* **æ„Ÿè°¢** [**@naivenom**](https://twitter.com/naivenom) **å¯¹æœ¬æ–¹æ³•çš„å¸®åŠ©**
* [https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing](https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing)
* [https://palant.info/2022/08/10/anatomy-of-a-basic-extension/](https://palant.info/2022/08/10/anatomy-of-a-basic-extension/)
* [https://palant.info/2022/08/24/attack-surface-of-extension-pages/](https://palant.info/2022/08/24/attack-surface-of-extension-pages/)
* [https://palant.info/2022/08/31/when-extension-pages-are-web-accessible/](https://palant.info/2022/08/31/when-extension-pages-are-web-accessible/)
* [https://help.passbolt.com/assets/files/PBL-02-report.pdf](https://help.passbolt.com/assets/files/PBL-02-report.pdf)
* [https://developer.chrome.com/docs/extensions/develop/concepts/content-scripts](https://developer.chrome.com/docs/extensions/develop/concepts/content-scripts)
* [https://developer.chrome.com/docs/extensions/mv2/background-pages](https://developer.chrome.com/docs/extensions/mv2/background-pages)
* [https://thehackerblog.com/kicking-the-rims-a-guide-for-securely-writing-and-auditing-chrome-extensions/](https://thehackerblog.com/kicking-the-rims-a-guide-for-securely-writing-and-auditing-chrome-extensions/)
* [https://gist.github.com/LongJohnCoder/9ddf5735df3a4f2e9559665fb864eac0](https://gist.github.com/LongJohnCoder/9ddf5735df3a4f2e9559665fb864eac0)

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µAWSé»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricksåŸ¹è®­AWSçº¢é˜Ÿä¸“å®¶ï¼ˆARTEï¼‰**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µGCPé»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricksåŸ¹è®­GCPçº¢é˜Ÿä¸“å®¶ï¼ˆGRTEï¼‰**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordå°ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥å°ç»„**](https://t.me/peass)æˆ–**åœ¨Twitterä¸Šå…³æ³¨** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHubåº“æäº¤PRåˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
