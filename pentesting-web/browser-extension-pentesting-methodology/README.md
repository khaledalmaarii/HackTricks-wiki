# Metodologia Pentestingu RozszerzeÅ„ PrzeglÄ…darki

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ trikami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w na GitHubie.

</details>
{% endhint %}

## Podstawowe Informacje

Rozszerzenia przeglÄ…darki sÄ… napisane w JavaScript i Å‚adowane przez przeglÄ…darkÄ™ w tle. MajÄ… swÃ³j [DOM](https://www.w3schools.com/js/js\_htmldom.asp), ale mogÄ… wchodziÄ‡ w interakcje z DOM-ami innych stron. Oznacza to, Å¼e mogÄ… naruszaÄ‡ poufnoÅ›Ä‡, integralnoÅ›Ä‡ i dostÄ™pnoÅ›Ä‡ (CIA) innych stron.

## GÅ‚Ã³wne Komponenty

UkÅ‚ady rozszerzeÅ„ wyglÄ…dajÄ… najlepiej, gdy sÄ… wizualizowane i skÅ‚adajÄ… siÄ™ z trzech komponentÃ³w. Przyjrzyjmy siÄ™ kaÅ¼demu komponentowi dokÅ‚adniej.

<figure><img src="../../.gitbook/assets/image (16) (1).png" alt=""><figcaption><p><a href="http://webblaze.cs.berkeley.edu/papers/Extensions.pdf">http://webblaze.cs.berkeley.edu/papers/Extensions.pdf</a></p></figcaption></figure>

### **Skrypty TreÅ›ci**

KaÅ¼dy skrypt treÅ›ci ma bezpoÅ›redni dostÄ™p do DOM **jednej strony internetowej** i jest tym samym naraÅ¼ony na **potencjalnie zÅ‚oÅ›liwe dane wejÅ›ciowe**. Jednak skrypt treÅ›ci nie zawiera Å¼adnych uprawnieÅ„ poza moÅ¼liwoÅ›ciÄ… wysyÅ‚ania wiadomoÅ›ci do rdzenia rozszerzenia.

### **RdzeÅ„ Rozszerzenia**

RdzeÅ„ rozszerzenia zawiera wiÄ™kszoÅ›Ä‡ uprawnieÅ„/dostÄ™pu rozszerzenia, ale rdzeÅ„ rozszerzenia moÅ¼e wchodziÄ‡ w interakcje z treÅ›ciÄ… internetowÄ… tylko za poÅ›rednictwem [XMLHttpRequest](https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest) i skryptÃ³w treÅ›ci. Ponadto rdzeÅ„ rozszerzenia nie ma bezpoÅ›redniego dostÄ™pu do maszyny gospodarza.

### **Natychmiastowy Plik Binarny**

Rozszerzenie pozwala na natychmiastowy plik binarny, ktÃ³ry moÅ¼e **uzyskaÄ‡ dostÄ™p do maszyny gospodarza z peÅ‚nymi uprawnieniami uÅ¼ytkownika.** Natychmiastowy plik binarny wchodzi w interakcje z rdzeniem rozszerzenia za poÅ›rednictwem standardowego interfejsu programowania aplikacji Netscape Plugin ([NPAPI](https://en.wikipedia.org/wiki/NPAPI)), uÅ¼ywanego przez Flash i inne wtyczki przeglÄ…darki.

### Granice

{% hint style="danger" %}
Aby uzyskaÄ‡ peÅ‚ne uprawnienia uÅ¼ytkownika, atakujÄ…cy musi przekonaÄ‡ rozszerzenie do przekazania zÅ‚oÅ›liwych danych wejÅ›ciowych ze skryptu treÅ›ci do rdzenia rozszerzenia, a nastÄ™pnie z rdzenia rozszerzenia do natychmiastowego pliku binarnego.
{% endhint %}

KaÅ¼dy komponent rozszerzenia jest oddzielony od siebie przez **silne granice ochronne**. KaÅ¼dy komponent dziaÅ‚a w **osobnym procesie systemu operacyjnego**. Skrypty treÅ›ci i rdzenie rozszerzeÅ„ dziaÅ‚ajÄ… w **procesach piaskownicy**, niedostÄ™pnych dla wiÄ™kszoÅ›ci usÅ‚ug systemu operacyjnego.

Co wiÄ™cej, skrypty treÅ›ci sÄ… oddzielone od swoich powiÄ…zanych stron internetowych przez **dziaÅ‚anie w osobnym stosie JavaScript**. Skrypt treÅ›ci i strona internetowa majÄ… **dostÄ™p do tego samego podstawowego DOM**, ale obie **nigdy nie wymieniajÄ… wskaÅºnikÃ³w JavaScript**, co zapobiega wyciekowi funkcjonalnoÅ›ci JavaScript.

## **`manifest.json`**

Rozszerzenie Chrome to po prostu folder ZIP z rozszerzeniem [.crx](https://www.lifewire.com/crx-file-2620391). RdzeÅ„ rozszerzenia to plik **`manifest.json`** w katalogu gÅ‚Ã³wnym folderu, ktÃ³ry okreÅ›la ukÅ‚ad, uprawnienia i inne opcje konfiguracyjne.

PrzykÅ‚ad:
```json
{
"manifest_version": 2,
"name": "My extension",
"version": "1.0",
"permissions": [
"storage"
],
"content_scripts": [
{
"js": [
"script.js"
],
"matches": [
"https://example.com/*",
"https://www.example.com/*"
],
"exclude_matches": ["*://*/*business*"],
}
],
"background": {
"scripts": [
"background.js"
]
},
"options_ui": {
"page": "options.html"
}
}
```
### `content_scripts`

Skrypty zawartoÅ›ci sÄ… **Å‚adowane** za kaÅ¼dym razem, gdy uÅ¼ytkownik **nawiguje do pasujÄ…cej strony**, w naszym przypadku kaÅ¼da strona pasujÄ…ca do wyraÅ¼enia **`https://example.com/*`** i niepasujÄ…ca do wyraÅ¼enia regex **`*://*/*/business*`**. WykonujÄ… siÄ™ **jak wÅ‚asne skrypty strony** i majÄ… dowolny dostÄ™p do [Modelu Obiektu Dokumentu (DOM)](https://developer.mozilla.org/en-US/docs/Web/API/Document\_Object\_Model) strony.
```json
"content_scripts": [
{
"js": [
"script.js"
],
"matches": [
"https://example.com/*",
"https://www.example.com/*"
],
"exclude_matches": ["*://*/*business*"],
}
],
```
Aby dodaÄ‡ lub wykluczyÄ‡ wiÄ™cej adresÃ³w URL, moÅ¼na rÃ³wnieÅ¼ uÅ¼yÄ‡ **`include_globs`** i **`exclude_globs`**.

To jest przykÅ‚ad skryptu zawartoÅ›ci, ktÃ³ry doda przycisk wyjaÅ›nienia do strony, gdy [API storage](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/storage) zostanie uÅ¼yte do pobrania wartoÅ›ci `message` z pamiÄ™ci rozszerzenia.
```js
chrome.storage.local.get("message", result =>
{
let div = document.createElement("div");
div.innerHTML = result.message + " <button>Explain</button>";
div.querySelector("button").addEventListener("click", () =>
{
chrome.runtime.sendMessage("explain");
});
document.body.appendChild(div);
});
```
<figure><img src="../../.gitbook/assets/image (23).png" alt=""><figcaption></figcaption></figure>

WiadomoÅ›Ä‡ jest wysyÅ‚ana do stron rozszerzenia przez skrypt treÅ›ci, gdy ten przycisk jest klikany, poprzez wykorzystanie [**runtime.sendMessage() API**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/runtime/sendMessage). Wynika to z ograniczenia skryptu treÅ›ci w bezpoÅ›rednim dostÄ™pie do API, przy czym `storage` jest jednym z nielicznych wyjÄ…tkÃ³w. Dla funkcjonalnoÅ›ci wykraczajÄ…cych poza te wyjÄ…tki, wiadomoÅ›ci sÄ… wysyÅ‚ane do stron rozszerzenia, z ktÃ³rymi skrypty treÅ›ci mogÄ… komunikowaÄ‡ siÄ™.

{% hint style="warning" %}
W zaleÅ¼noÅ›ci od przeglÄ…darki, moÅ¼liwoÅ›ci skryptu treÅ›ci mogÄ… siÄ™ nieco rÃ³Å¼niÄ‡. Dla przeglÄ…darek opartych na Chromium, lista moÅ¼liwoÅ›ci jest dostÄ™pna w [dokumentacji Chrome Developers](https://developer.chrome.com/docs/extensions/mv3/content\_scripts/#capabilities), a dla Firefox, [MDN](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/Content\_scripts#webextension\_apis) sÅ‚uÅ¼y jako gÅ‚Ã³wne ÅºrÃ³dÅ‚o.\
Warto rÃ³wnieÅ¼ zauwaÅ¼yÄ‡, Å¼e skrypty treÅ›ci majÄ… moÅ¼liwoÅ›Ä‡ komunikacji z skryptami w tle, co umoÅ¼liwia im wykonywanie dziaÅ‚aÅ„ i przekazywanie odpowiedzi z powrotem.
{% endhint %}

Aby wyÅ›wietliÄ‡ i debugowaÄ‡ skrypty treÅ›ci w Chrome, menu narzÄ™dzi dewelopera moÅ¼na otworzyÄ‡ z Opcje > WiÄ™cej narzÄ™dzi > NarzÄ™dzia dewelopera LUB naciskajÄ…c Ctrl + Shift + I.

Po wyÅ›wietleniu narzÄ™dzi dewelopera, naleÅ¼y kliknÄ…Ä‡ na zakÅ‚adkÄ™ **Å¹rÃ³dÅ‚o**, a nastÄ™pnie na zakÅ‚adkÄ™ **Skrypty treÅ›ci**. UmoÅ¼liwia to obserwacjÄ™ dziaÅ‚ajÄ…cych skryptÃ³w treÅ›ci z rÃ³Å¼nych rozszerzeÅ„ oraz ustawienie punktÃ³w przerwania w celu Å›ledzenia przepÅ‚ywu wykonania.

### WstrzykniÄ™te skrypty treÅ›ci

{% hint style="success" %}
ZauwaÅ¼, Å¼e **Skrypty TreÅ›ci nie sÄ… obowiÄ…zkowe**, poniewaÅ¼ moÅ¼liwe jest rÃ³wnieÅ¼ **dynamiczne** **wstrzykiwanie** skryptÃ³w oraz **programowe wstrzykiwanie ich** na stronach internetowych za pomocÄ… **`tabs.executeScript`**. To w rzeczywistoÅ›ci zapewnia bardziej **szczegÃ³Å‚owÄ… kontrolÄ™**.
{% endhint %}

Aby programowo wstrzyknÄ…Ä‡ skrypt treÅ›ci, rozszerzenie musi mieÄ‡ [uprawnienia hosta](https://developer.chrome.com/docs/extensions/reference/permissions) dla strony, do ktÃ³rej skrypty majÄ… byÄ‡ wstrzykniÄ™te. Uprawnienia te mogÄ… byÄ‡ zabezpieczone albo przez **zaÅ¼Ä…danie ich** w manifeÅ›cie rozszerzenia, albo tymczasowo poprzez [**activeTab**](https://developer.chrome.com/docs/extensions/reference/manifest/activeTab).

#### PrzykÅ‚ad rozszerzenia opartego na activeTab

{% code title="manifest.json" %}
```json
{
"name": "My extension",
...
"permissions": [
"activeTab",
"scripting"
],
"background": {
"service_worker": "background.js"
},
"action": {
"default_title": "Action Button"
}
}
```
{% endcode %}

* **Wstrzyknij plik JS po klikniÄ™ciu:**
```javascript
// content-script.js
document.body.style.backgroundColor = "orange";

//service-worker.js - Inject the JS file
chrome.action.onClicked.addListener((tab) => {
chrome.scripting.executeScript({
target: { tabId: tab.id },
files: ["content-script.js"]
});
});
```
* **Wstrzyknij funkcjÄ™** po klikniÄ™ciu:
```javascript
//service-worker.js - Inject a function
function injectedFunction() {
document.body.style.backgroundColor = "orange";
}

chrome.action.onClicked.addListener((tab) => {
chrome.scripting.executeScript({
target : {tabId : tab.id},
func : injectedFunction,
});
});
```
#### PrzykÅ‚ad z uprawnieniami skryptÃ³w
```javascript
// service-workser.js
chrome.scripting.registerContentScripts([{
id : "test",
matches : [ "https://*.example.com/*" ],
excludeMatches : [ "*://*/*business*" ],
js : [ "contentScript.js" ],
}]);

// Another example
chrome.tabs.executeScript(tabId, { file: "content_script.js" });
```
Aby dodaÄ‡ lub wykluczyÄ‡ wiÄ™cej adresÃ³w URL, moÅ¼na rÃ³wnieÅ¼ uÅ¼yÄ‡ **`include_globs`** i **`exclude_globs`**.

### Skrypty zawartoÅ›ci `run_at`

Pole `run_at` kontroluje **kiedy pliki JavaScript sÄ… wstrzykiwane do strony internetowej**. Preferowana i domyÅ›lna wartoÅ›Ä‡ to `"document_idle"`.

MoÅ¼liwe wartoÅ›ci to:

* **`document_idle`**: Kiedy tylko to moÅ¼liwe
* **`document_start`**: Po zaÅ‚adowaniu jakichkolwiek plikÃ³w z `css`, ale przed skonstruowaniem jakiegokolwiek innego DOM lub uruchomieniem jakiegokolwiek innego skryptu.
* **`document_end`**: Natychmiast po zakoÅ„czeniu DOM, ale przed zaÅ‚adowaniem subzasobÃ³w, takich jak obrazy i ramki.

#### Poprzez `manifest.json`
```json
{
"name": "My extension",
...
"content_scripts": [
{
"matches": ["https://*.example.com/*"],
"run_at": "document_idle",
"js": ["contentScript.js"]
}
],
...
}

```
Via **`service-worker.js`**
```javascript
chrome.scripting.registerContentScripts([{
id : "test",
matches : [ "https://*.example.com/*" ],
runAt : "document_idle",
js : [ "contentScript.js" ],
}]);
```
### `background`

WiadomoÅ›ci wysyÅ‚ane przez skrypty treÅ›ci sÄ… odbierane przez **stronÄ™ tÅ‚a**, ktÃ³ra odgrywa centralnÄ… rolÄ™ w koordynowaniu komponentÃ³w rozszerzenia. Co waÅ¼ne, strona tÅ‚a utrzymuje siÄ™ przez caÅ‚y czas trwania rozszerzenia, dziaÅ‚ajÄ…c dyskretnie bez bezpoÅ›redniej interakcji uÅ¼ytkownika. Posiada wÅ‚asny Model ObiektÃ³w Dokumentu (DOM), co umoÅ¼liwia zÅ‚oÅ¼one interakcje i zarzÄ…dzanie stanem.

**Kluczowe punkty**:

* **Rola Strony TÅ‚a:** DziaÅ‚a jako centrum nerwowe dla rozszerzenia, zapewniajÄ…c komunikacjÄ™ i koordynacjÄ™ miÄ™dzy rÃ³Å¼nymi czÄ™Å›ciami rozszerzenia.
* **TrwaÅ‚oÅ›Ä‡:** To zawsze obecny byt, niewidoczny dla uÅ¼ytkownika, ale integralny dla funkcjonalnoÅ›ci rozszerzenia.
* **Automatyczne Generowanie:** JeÅ›li nie jest wyraÅºnie zdefiniowane, przeglÄ…darka automatycznie utworzy stronÄ™ tÅ‚a. Ta automatycznie generowana strona bÄ™dzie zawieraÄ‡ wszystkie skrypty tÅ‚a okreÅ›lone w manifeÅ›cie rozszerzenia, zapewniajÄ…c pÅ‚ynne dziaÅ‚anie zadaÅ„ tÅ‚a rozszerzenia.

{% hint style="success" %}
Wygoda zapewniana przez przeglÄ…darkÄ™ w automatycznym generowaniu strony tÅ‚a (gdy nie jest wyraÅºnie zadeklarowana) zapewnia, Å¼e wszystkie niezbÄ™dne skrypty tÅ‚a sÄ… zintegrowane i dziaÅ‚ajÄ…, upraszczajÄ…c proces konfiguracji rozszerzenia.
{% endhint %}

PrzykÅ‚ad skryptu tÅ‚a:
```js
chrome.runtime.onMessage.addListener((request, sender, sendResponse) =>
{
if (request == "explain")
{
chrome.tabs.create({ url: "https://example.net/explanation" });
}
})
```
UÅ¼ywa [runtime.onMessage API](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/runtime/onMessage) do nasÅ‚uchiwania wiadomoÅ›ci. Gdy otrzymana zostanie wiadomoÅ›Ä‡ `"explain"`, uÅ¼ywa [tabs API](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs) do otwarcia strony w nowej karcie.

Aby debugowaÄ‡ skrypt w tle, moÅ¼esz przejÅ›Ä‡ do **szczegÃ³Å‚Ã³w rozszerzenia i sprawdziÄ‡ serwis worker,** co otworzy narzÄ™dzia deweloperskie z skryptem w tle:

<figure><img src="https://github.com/carlospolop/hacktricks/blob/master/pentesting-web/browser-extension-pentesting-methodology/broken-reference" alt=""><figcaption></figcaption></figure>

### Strony opcji i inne

Rozszerzenia przeglÄ…darki mogÄ… zawieraÄ‡ rÃ³Å¼ne rodzaje stron:

* **Strony akcji** sÄ… wyÅ›wietlane w **rozwijanym menu po klikniÄ™ciu na ikonÄ™ rozszerzenia.**
* Strony, ktÃ³re rozszerzenie **zaÅ‚aduje w nowej karcie.**
* **Strony opcji**: Ta strona wyÅ›wietla siÄ™ na gÃ³rze rozszerzenia po klikniÄ™ciu. W poprzednim manifeÅ›cie w moim przypadku mogÅ‚em uzyskaÄ‡ dostÄ™p do tej strony w `chrome://extensions/?options=fadlhnelkbeojnebcbkacjilhnbjfjca` lub klikajÄ…c:

<figure><img src="../../.gitbook/assets/image (24).png" alt="" width="375"><figcaption></figcaption></figure>

ZauwaÅ¼, Å¼e te strony nie sÄ… trwaÅ‚e jak strony w tle, poniewaÅ¼ Å‚adujÄ… dynamicznie treÅ›ci w zaleÅ¼noÅ›ci od potrzeb. Mimo to, dzielÄ… pewne moÅ¼liwoÅ›ci z stronÄ… w tle:

* **Komunikacja z skryptami treÅ›ci:** Podobnie jak strona w tle, te strony mogÄ… odbieraÄ‡ wiadomoÅ›ci od skryptÃ³w treÅ›ci, uÅ‚atwiajÄ…c interakcjÄ™ w ramach rozszerzenia.
* **DostÄ™p do specyficznych API rozszerzenia:** Te strony majÄ… peÅ‚ny dostÄ™p do specyficznych API rozszerzenia, zgodnie z uprawnieniami zdefiniowanymi dla rozszerzenia.

### `permissions` & `host_permissions`

**`permissions`** i **`host_permissions`** to wpisy z `manifest.json`, ktÃ³re wskaÅ¼Ä… **jakie uprawnienia** ma rozszerzenie przeglÄ…darki (przechowywanie, lokalizacja...) oraz **na jakich stronach internetowych**.

PoniewaÅ¼ rozszerzenia przeglÄ…darki mogÄ… byÄ‡ tak **uprzywilejowane**, zÅ‚oÅ›liwe lub skompromitowane mogÅ‚yby umoÅ¼liwiÄ‡ atakujÄ…cemu **rÃ³Å¼ne sposoby kradzieÅ¼y wraÅ¼liwych informacji i szpiegowania uÅ¼ytkownika**.

SprawdÅº, jak te ustawienia dziaÅ‚ajÄ… i jak mogÄ… byÄ‡ naduÅ¼ywane w:

{% content-ref url="browext-permissions-and-host_permissions.md" %}
[browext-permissions-and-host\_permissions.md](browext-permissions-and-host\_permissions.md)
{% endcontent-ref %}

### `content_security_policy`

**Polityka bezpieczeÅ„stwa treÅ›ci** moÅ¼e byÄ‡ rÃ³wnieÅ¼ zadeklarowana wewnÄ…trz `manifest.json`. JeÅ›li jest zdefiniowana, moÅ¼e byÄ‡ **wraÅ¼liwa**.

DomyÅ›lne ustawienie dla stron rozszerzeÅ„ przeglÄ…darki jest doÅ›Ä‡ restrykcyjne:
```bash
script-src 'self'; object-src 'self';
```
Aby strona internetowa mogÅ‚a uzyskaÄ‡ dostÄ™p do strony rozszerzenia przeglÄ…darki, na przykÅ‚ad strony `.html`, ta strona musi byÄ‡ wymieniona w polu **`web_accessible_resources`** pliku `manifest.json`.\
Na przykÅ‚ad:
```javascript
{
...
"web_accessible_resources": [
{
"resources": [ "images/*.png" ],
"matches": [ "https://example.com/*" ]
},
{
"resources": [ "fonts/*.woff" ],
"matches": [ "https://example.com/*" ]
}
],
...
}
```
Te strony sÄ… dostÄ™pne pod adresem URL takim jak:
```
chrome-extension://<extension-id>/message.html
```
W publicznych rozszerzeniach **identyfikator rozszerzenia jest dostÄ™pny**:

<figure><img src="../../.gitbook/assets/image (1194).png" alt="" width="375"><figcaption></figcaption></figure>

JednakÅ¼e, jeÅ›li parametr `manifest.json` **`use_dynamic_url`** jest uÅ¼ywany, ten **identyfikator moÅ¼e byÄ‡ dynamiczny**.

{% hint style="success" %}
ZauwaÅ¼, Å¼e nawet jeÅ›li strona jest tutaj wymieniona, moÅ¼e byÄ‡ **chroniona przed ClickJacking** dziÄ™ki **Polityce BezpieczeÅ„stwa TreÅ›ci**. Dlatego musisz rÃ³wnieÅ¼ to sprawdziÄ‡ (sekcja frame-ancestors) przed potwierdzeniem, Å¼e atak ClickJacking jest moÅ¼liwy.
{% endhint %}

Dopuszczenie dostÄ™pu do tych stron sprawia, Å¼e sÄ… one **potencjalnie podatne na ClickJacking**:

{% content-ref url="browext-clickjacking.md" %}
[browext-clickjacking.md](browext-clickjacking.md)
{% endcontent-ref %}

{% hint style="success" %}
Zezwolenie na Å‚adowanie tych stron tylko przez rozszerzenie, a nie przez losowe adresy URL, moÅ¼e zapobiec atakom ClickJacking.
{% endhint %}

{% hint style="danger" %}
ZauwaÅ¼, Å¼e strony z **`web_accessible_resources`** oraz inne strony rozszerzenia sÄ… rÃ³wnieÅ¼ zdolne do **kontaktowania siÄ™ z skryptami w tle**. JeÅ›li jedna z tych stron jest podatna na **XSS**, moÅ¼e to otworzyÄ‡ wiÄ™kszÄ… lukÄ™.

Ponadto, zauwaÅ¼, Å¼e moÅ¼esz otworzyÄ‡ tylko strony wskazane w **`web_accessible_resources`** wewnÄ…trz iframe, ale z nowej karty moÅ¼liwe jest uzyskanie dostÄ™pu do dowolnej strony w rozszerzeniu, znajÄ…c identyfikator rozszerzenia. Dlatego, jeÅ›li znajdziesz XSS wykorzystujÄ…ce te same parametry, moÅ¼e to byÄ‡ naduÅ¼ywane, nawet jeÅ›li strona nie jest skonfigurowana w **`web_accessible_resources`**.
{% endhint %}

### `externally_connectable`

Zgodnie z [**dokumentacjÄ…**](https://developer.chrome.com/docs/extensions/reference/manifest/externally-connectable), wÅ‚aÅ›ciwoÅ›Ä‡ manifestu `"externally_connectable"` deklaruje **ktÃ³re rozszerzenia i strony internetowe mogÄ… Å‚Ä…czyÄ‡ siÄ™** z Twoim rozszerzeniem za pomocÄ… [runtime.connect](https://developer.chrome.com/docs/extensions/reference/runtime#method-connect) i [runtime.sendMessage](https://developer.chrome.com/docs/extensions/reference/runtime#method-sendMessage).

* JeÅ›li klucz **`externally_connectable`** **nie** jest zadeklarowany w manifeÅ›cie Twojego rozszerzenia lub jest zadeklarowany jako **`"ids": ["*"]`**, **wszystkie rozszerzenia mogÄ… siÄ™ Å‚Ä…czyÄ‡, ale Å¼adne strony internetowe nie mogÄ… siÄ™ Å‚Ä…czyÄ‡**.
* JeÅ›li **okreÅ›lone identyfikatory sÄ… podane**, jak w `"ids": ["aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"]`, **tylko te aplikacje** mogÄ… siÄ™ Å‚Ä…czyÄ‡.
* JeÅ›li **okreÅ›lone wzory** sÄ… podane, te aplikacje internetowe bÄ™dÄ… mogÅ‚y siÄ™ Å‚Ä…czyÄ‡:
```json
"matches": [
"https://*.google.com/*",
"*://*.chromium.org/*",
```
* JeÅ›li jest okreÅ›lone jako puste: **`"externally_connectable": {}`**, Å¼adna aplikacja ani strona internetowa nie bÄ™dÄ… mogÅ‚y siÄ™ poÅ‚Ä…czyÄ‡.

Im **mniej rozszerzeÅ„ i adresÃ³w URL** wskazanych tutaj, tym **mniejsza powierzchnia ataku**.

{% hint style="danger" %}
JeÅ›li strona internetowa **wraÅ¼liwa na XSS lub przejÄ™cie** jest wskazana w **`externally_connectable`**, atakujÄ…cy bÄ™dzie mÃ³gÅ‚ **wysyÅ‚aÄ‡ wiadomoÅ›ci bezpoÅ›rednio do skryptu w tle**, caÅ‚kowicie omijajÄ…c skrypt treÅ›ci i jego CSP.

Dlatego jest to **bardzo potÄ™Å¼ne obejÅ›cie**.

Co wiÄ™cej, jeÅ›li klient zainstaluje zÅ‚oÅ›liwe rozszerzenie, nawet jeÅ›li nie jest dozwolone do komunikacji z wraÅ¼liwym rozszerzeniem, moÅ¼e wstrzyknÄ…Ä‡ **dane XSS w dozwolonej stronie internetowej** lub naduÅ¼yÄ‡ **`WebRequest`** lub **`DeclarativeNetRequest`** API, aby manipulowaÄ‡ Å¼Ä…daniami na docelowej domenie, zmieniajÄ…c Å¼Ä…danie strony dla **pliku JavaScript**. (ZauwaÅ¼, Å¼e CSP na docelowej stronie moÅ¼e zapobiec tym atakom). Ten pomysÅ‚ pochodzi [**z tego opisu**](https://www.darkrelay.com/post/opera-zero-day-rce-vulnerability).
{% endhint %}

## Podsumowanie komunikacji

### Rozszerzenie <--> WebApp

Aby komunikowaÄ‡ siÄ™ miÄ™dzy skryptem treÅ›ci a stronÄ… internetowÄ…, zazwyczaj uÅ¼ywane sÄ… wiadomoÅ›ci post. Dlatego w aplikacji internetowej zazwyczaj znajdziesz wywoÅ‚ania funkcji **`window.postMessage`** oraz w skrypcie treÅ›ci nasÅ‚uchiwacze, takie jak **`window.addEventListener`**. NaleÅ¼y jednak zauwaÅ¼yÄ‡, Å¼e rozszerzenie moÅ¼e rÃ³wnieÅ¼ **komunikowaÄ‡ siÄ™ z aplikacjÄ… internetowÄ…, wysyÅ‚ajÄ…c wiadomoÅ›Ä‡ Post** (a zatem strona internetowa powinna siÄ™ tego spodziewaÄ‡) lub po prostu sprawiÄ‡, Å¼e strona zaÅ‚aduje nowy skrypt.

### WewnÄ…trz rozszerzenia

Zazwyczaj funkcja **`chrome.runtime.sendMessage`** jest uÅ¼ywana do wysyÅ‚ania wiadomoÅ›ci wewnÄ…trz rozszerzenia (zazwyczaj obsÅ‚ugiwana przez skrypt `background`), a aby jÄ… odebraÄ‡ i obsÅ‚uÅ¼yÄ‡, deklarowany jest nasÅ‚uchiwacz wywoÅ‚ujÄ…cy **`chrome.runtime.onMessage.addListener`**.

MoÅ¼liwe jest rÃ³wnieÅ¼ uÅ¼ycie **`chrome.runtime.connect()`**, aby mieÄ‡ staÅ‚e poÅ‚Ä…czenie zamiast wysyÅ‚ania pojedynczych wiadomoÅ›ci, moÅ¼na go uÅ¼yÄ‡ do **wysyÅ‚ania** i **odbierania** **wiadomoÅ›ci**, jak w poniÅ¼szym przykÅ‚adzie:

<details>

<summary><code>chrome.runtime.connect()</code> przykÅ‚ad</summary>
```javascript
var port = chrome.runtime.connect();

// Listen for messages from the web page
window.addEventListener("message", (event) => {
// Only accept messages from the same window
if (event.source !== window) {
return;
}

// Check if the message type is "FROM_PAGE"
if (event.data.type && (event.data.type === "FROM_PAGE")) {
console.log("Content script received: " + event.data.text);
// Forward the message to the background script
port.postMessage({ type: 'FROM_PAGE', text: event.data.text });
}
}, false);

// Listen for messages from the background script
port.onMessage.addListener(function(msg) {
console.log("Content script received message from background script:", msg);
// Handle the response message from the background script
});
```
</details>

MoÅ¼liwe jest rÃ³wnieÅ¼ wysyÅ‚anie wiadomoÅ›ci z skryptu w tle do skryptu treÅ›ci znajdujÄ…cego siÄ™ w okreÅ›lonej karcie, wywoÅ‚ujÄ…c **`chrome.tabs.sendMessage`**, gdzie bÄ™dziesz musiaÅ‚ wskazaÄ‡ **ID karty**, do ktÃ³rej chcesz wysÅ‚aÄ‡ wiadomoÅ›Ä‡.

### Z dozwolonego `externally_connectable` do rozszerzenia

**Aplikacje internetowe i zewnÄ™trzne rozszerzenia przeglÄ…darki dozwolone** w konfiguracji `externally_connectable` mogÄ… wysyÅ‚aÄ‡ Å¼Ä…dania za pomocÄ…:
```javascript
chrome.runtime.sendMessage(extensionId, ...
```
Gdzie to konieczne, aby wspomnieÄ‡ o **identyfikatorze rozszerzenia**.

### Native Messaging

MoÅ¼liwe jest, aby skrypty w tle komunikowaÅ‚y siÄ™ z binariami w systemie, ktÃ³re mogÄ… byÄ‡ **naraÅ¼one na krytyczne luki, takie jak RCE** jeÅ›li ta komunikacja nie jest odpowiednio zabezpieczona. [WiÄ™cej na ten temat pÃ³Åºniej](./#native-messaging).
```javascript
chrome.runtime.sendNativeMessage(
'com.my_company.my_application',
{text: 'Hello'},
function (response) {
console.log('Received ' + response);
}
);
```
## Web **â†”ï¸** Komunikacja SkryptÃ³w TreÅ›ci

Åšrodowiska, w ktÃ³rych dziaÅ‚ajÄ… **skrypty treÅ›ci**, oraz miejsca hosta sÄ… **oddzielone** od siebie, co zapewnia **izolacjÄ™**. Pomimo tej izolacji, oba majÄ… moÅ¼liwoÅ›Ä‡ interakcji z **Model ObiektÃ³w Dokumentu (DOM)** strony, wspÃ³lnym zasobem. Aby strona hosta mogÅ‚a nawiÄ…zaÄ‡ komunikacjÄ™ z **skryptem treÅ›ci**, lub poÅ›rednio z rozszerzeniem przez skrypt treÅ›ci, konieczne jest wykorzystanie **DOM**, ktÃ³ry jest dostÄ™pny dla obu stron jako kanaÅ‚ komunikacyjny.

### WiadomoÅ›ci Post

{% code title="content-script.js" %}
```javascript
// This is like "chrome.runtime.sendMessage" but to maintain the connection
var port = chrome.runtime.connect();

window.addEventListener("message", (event) => {
// We only accept messages from ourselves
if (event.source !== window) {
return;
}

if (event.data.type && (event.data.type === "FROM_PAGE")) {
console.log("Content script received: " + event.data.text);
// Forward the message to the background script
port.postMessage(event.data.text);
}
}, false);
```
{% endcode %}

{% code title="example.js" %}
```javascript
document.getElementById("theButton").addEventListener("click", () => {
window.postMessage(
{type : "FROM_PAGE", text : "Hello from the webpage!"}, "*");
}, false);
```
{% endcode %}

Bezpieczna komunikacja Post Message powinna sprawdzaÄ‡ autentycznoÅ›Ä‡ otrzymanej wiadomoÅ›ci, co moÅ¼na zrobiÄ‡, sprawdzajÄ…c:

* **`event.isTrusted`**: To jest True tylko wtedy, gdy zdarzenie zostaÅ‚o wywoÅ‚ane przez akcjÄ™ uÅ¼ytkownika
* Skrypt treÅ›ci moÅ¼e oczekiwaÄ‡ wiadomoÅ›ci tylko wtedy, gdy uÅ¼ytkownik wykona jakÄ…Å› akcjÄ™
* **domena ÅºrÃ³dÅ‚owa**: moÅ¼e oczekiwaÄ‡ wiadomoÅ›ci tylko z dozwolonej listy domen.
* JeÅ›li uÅ¼ywana jest wyraÅ¼enie regularne, bÄ…dÅº bardzo ostroÅ¼ny
* **Å¹rÃ³dÅ‚o**: `received_message.source !== window` moÅ¼e byÄ‡ uÅ¼yte do sprawdzenia, czy wiadomoÅ›Ä‡ byÅ‚a **z tego samego okna**, w ktÃ³rym skrypt treÅ›ci nasÅ‚uchuje.

Poprzednie kontrole, nawet jeÅ›li sÄ… przeprowadzane, mogÄ… byÄ‡ podatne, wiÄ™c sprawdÅº na nastÄ™pujÄ…cej stronie **potencjalne obejÅ›cia Post Message**:

{% content-ref url="../postmessage-vulnerabilities/" %}
[postmessage-vulnerabilities](../postmessage-vulnerabilities/)
{% endcontent-ref %}

### Iframe

Innym moÅ¼liwym sposobem komunikacji mogÄ… byÄ‡ **adresy URL Iframe**, przykÅ‚ad moÅ¼na znaleÅºÄ‡ w:

{% content-ref url="browext-xss-example.md" %}
[browext-xss-example.md](browext-xss-example.md)
{% endcontent-ref %}

### DOM

To nie jest "dokÅ‚adnie" sposÃ³b komunikacji, ale **sieÄ‡ i skrypt treÅ›ci bÄ™dÄ… miaÅ‚y dostÄ™p do DOM sieci**. WiÄ™c, jeÅ›li **skrypt treÅ›ci** odczytuje jakieÅ› informacje z niego, **ufajÄ…c DOM sieci**, sieÄ‡ mogÅ‚aby **zmodyfikowaÄ‡ te dane** (poniewaÅ¼ sieÄ‡ nie powinna byÄ‡ ufana, lub poniewaÅ¼ sieÄ‡ jest podatna na XSS) i **skompromentowaÄ‡ skrypt treÅ›ci**.

MoÅ¼esz rÃ³wnieÅ¼ znaleÅºÄ‡ przykÅ‚ad **XSS opartego na DOM, aby skompromitowaÄ‡ rozszerzenie przeglÄ…darki** w:

{% content-ref url="browext-xss-example.md" %}
[browext-xss-example.md](browext-xss-example.md)
{% endcontent-ref %}

## Komunikacja Skryptu TreÅ›ci **â†”ï¸** Skryptu TÅ‚a

Skrypt treÅ›ci moÅ¼e uÅ¼ywaÄ‡ funkcji [**runtime.sendMessage()**](https://developer.chrome.com/docs/extensions/reference/runtime#method-sendMessage) **lub** [**tabs.sendMessage()**](https://developer.chrome.com/docs/extensions/reference/tabs#method-sendMessage), aby wysÅ‚aÄ‡ **jednorazowÄ… wiadomoÅ›Ä‡ serializowalnÄ… w formacie JSON**.

Aby obsÅ‚uÅ¼yÄ‡ **odpowiedÅº**, uÅ¼yj zwrÃ³conego **Promise**. ChociaÅ¼, dla zachowania zgodnoÅ›ci wstecznej, nadal moÅ¼esz przekazaÄ‡ **callback** jako ostatni argument.

WysyÅ‚anie Å¼Ä…dania z **skryptu treÅ›ci** wyglÄ…da tak:
```javascript
(async () => {
const response = await chrome.runtime.sendMessage({greeting: "hello"});
// do something with response here, not outside the function
console.log(response);
})();
```
WysyÅ‚anie Å¼Ä…dania z **rozszerzenia** (zwykle **skryptu w tle**). PrzykÅ‚ad, jak wysÅ‚aÄ‡ wiadomoÅ›Ä‡ do skryptu treÅ›ci w wybranej karcie:
```javascript
// From https://stackoverflow.com/questions/36153999/how-to-send-a-message-between-chrome-extension-popup-and-content-script
(async () => {
const [tab] = await chrome.tabs.query({active: true, lastFocusedWindow: true});
const response = await chrome.tabs.sendMessage(tab.id, {greeting: "hello"});
// do something with response here, not outside the function
console.log(response);
})();
```
Na **odbierajÄ…cej stronie** musisz ustawiÄ‡ [**runtime.onMessage**](https://developer.chrome.com/docs/extensions/reference/runtime#event-onMessage) **nasÅ‚uchiwacz zdarzeÅ„**, aby obsÅ‚uÅ¼yÄ‡ wiadomoÅ›Ä‡. WyglÄ…da to tak samo z poziomu skryptu treÅ›ci lub strony rozszerzenia.
```javascript
// From https://stackoverflow.com/questions/70406787/javascript-send-message-from-content-js-to-background-js
chrome.runtime.onMessage.addListener(
function(request, sender, sendResponse) {
console.log(sender.tab ?
"from a content script:" + sender.tab.url :
"from the extension");
if (request.greeting === "hello")
sendResponse({farewell: "goodbye"});
}
);
```
W wyrÃ³Å¼nionym przykÅ‚adzie, **`sendResponse()`** zostaÅ‚ wykonany w sposÃ³b synchroniczny. Aby zmodyfikowaÄ‡ obsÅ‚ugÄ™ zdarzenia `onMessage` do asynchronicznego wykonania `sendResponse()`, konieczne jest dodanie `return true;`.

WaÅ¼nym rozwaÅ¼eniem jest to, Å¼e w scenariuszach, w ktÃ³rych wiele stron jest ustawionych do odbierania zdarzeÅ„ `onMessage`, **pierwsza strona, ktÃ³ra wykona `sendResponse()`** dla konkretnego zdarzenia, bÄ™dzie jedynÄ…, ktÃ³ra skutecznie dostarczy odpowiedÅº. Jakiekolwiek kolejne odpowiedzi na to samo zdarzenie nie bÄ™dÄ… brane pod uwagÄ™.

Podczas tworzenia nowych rozszerzeÅ„ preferencje powinny byÄ‡ skierowane ku obietnicom zamiast do callbackÃ³w. W odniesieniu do uÅ¼ycia callbackÃ³w, funkcja `sendResponse()` jest uznawana za waÅ¼nÄ… tylko wtedy, gdy jest wykonywana bezpoÅ›rednio w kontekÅ›cie synchronicznym lub gdy obsÅ‚uga zdarzenia wskazuje na operacjÄ™ asynchronicznÄ…, zwracajÄ…c `true`. JeÅ›li Å¼aden z handlerÃ³w nie zwrÃ³ci `true` lub jeÅ›li funkcja `sendResponse()` zostanie usuniÄ™ta z pamiÄ™ci (zbierana przez garbage collector), callback zwiÄ…zany z funkcjÄ… `sendMessage()` zostanie wywoÅ‚any domyÅ›lnie.

## Native Messaging

Rozszerzenia przeglÄ…darki umoÅ¼liwiajÄ… rÃ³wnieÅ¼ komunikacjÄ™ z **binariami w systemie za pomocÄ… stdin**. Aplikacja musi zainstalowaÄ‡ plik json wskazujÄ…cy to w formacie json, jak:
```json
{
"name": "com.my_company.my_application",
"description": "My Application",
"path": "C:\\Program Files\\My Application\\chrome_native_messaging_host.exe",
"type": "stdio",
"allowed_origins": ["chrome-extension://knldjmfmopnpolahpmmgbagdohdnhkik/"]
}
```
Gdzie `name` to ciÄ…g przekazywany do [`runtime.connectNative()`](https://developer.chrome.com/docs/extensions/reference/api/runtime#method-connectNative) lub [`runtime.sendNativeMessage()`](https://developer.chrome.com/docs/extensions/reference/api/runtime#method-sendNativeMessage) w celu komunikacji z aplikacjÄ… z tÅ‚a skryptÃ³w rozszerzenia przeglÄ…darki. `path` to Å›cieÅ¼ka do pliku binarnego, istnieje tylko 1 waÅ¼ny `type`, ktÃ³rym jest stdio (uÅ¼yj stdin i stdout), a `allowed_origins` wskazuje rozszerzenia, ktÃ³re mogÄ… uzyskaÄ‡ do niego dostÄ™p (i nie mogÄ… mieÄ‡ znaku wieloznacznego).

Chrome/Chromium bÄ™dzie szukaÄ‡ tego json w niektÃ³rych rejestrach systemu Windows oraz w niektÃ³rych Å›cieÅ¼kach w macOS i Linux (wiÄ™cej informacji w [**docs**](https://developer.chrome.com/docs/extensions/develop/concepts/native-messaging)).

{% hint style="success" %}
Rozszerzenie przeglÄ…darki rÃ³wnieÅ¼ potrzebuje uprawnienia `nativeMessaing` zadeklarowanego, aby mÃ³c korzystaÄ‡ z tej komunikacji.
{% endhint %}

Tak wyglÄ…da kod niektÃ³rego skryptu tÅ‚a wysyÅ‚ajÄ…cego wiadomoÅ›ci do aplikacji natywnej:
```javascript
chrome.runtime.sendNativeMessage(
'com.my_company.my_application',
{text: 'Hello'},
function (response) {
console.log('Received ' + response);
}
);
```
W [**tym wpisie na blogu**](https://spaceraccoon.dev/universal-code-execution-browser-extensions/) zaproponowano podatny wzÃ³r wykorzystujÄ…cy natywne wiadomoÅ›ci:

1. Rozszerzenie przeglÄ…darki ma wzÃ³r z uÅ¼yciem symbolu wieloznacznego dla skryptu treÅ›ci.
2. Skrypt treÅ›ci przesyÅ‚a wiadomoÅ›ci `postMessage` do skryptu w tle za pomocÄ… `sendMessage`.
3. Skrypt w tle przesyÅ‚a wiadomoÅ›Ä‡ do aplikacji natywnej za pomocÄ… `sendNativeMessage`.
4. Aplikacja natywna niebezpiecznie obsÅ‚uguje wiadomoÅ›Ä‡, co prowadzi do wykonania kodu.

A w jego wnÄ™trzu wyjaÅ›niono przykÅ‚ad **przechodzenia z dowolnej strony do RCE wykorzystujÄ…c rozszerzenie przeglÄ…darki**.

## WraÅ¼liwe informacje w pamiÄ™ci/kodzie/clipboard

JeÅ›li Rozszerzenie PrzeglÄ…darki przechowuje **wraÅ¼liwe informacje w swojej pamiÄ™ci**, mogÄ… one byÄ‡ **zrzucane** (szczegÃ³lnie na maszynach z systemem Windows) i **wyszukiwane** w celu uzyskania tych informacji.

Dlatego pamiÄ™Ä‡ Rozszerzenia PrzeglÄ…darki **nie powinna byÄ‡ uwaÅ¼ana za bezpiecznÄ…**, a **wraÅ¼liwe informacje**, takie jak dane logowania czy frazy mnemoniczne, **nie powinny byÄ‡ przechowywane**.

OczywiÅ›cie, **nie umieszczaj wraÅ¼liwych informacji w kodzie**, poniewaÅ¼ bÄ™dÄ… one **publiczne**.

Aby zrzuciÄ‡ pamiÄ™Ä‡ z przeglÄ…darki, moÅ¼esz **zrzuciÄ‡ pamiÄ™Ä‡ procesu** lub przejÅ›Ä‡ do **ustawieÅ„** rozszerzenia przeglÄ…darki, klikajÄ…c **`Inspect pop-up`** -> W sekcji **`Memory`** -> **`Take a snapshot`** i **`CTRL+F`**, aby wyszukaÄ‡ w zrzucie wraÅ¼liwe informacje.

Ponadto, wysoce wraÅ¼liwe informacje, takie jak klucze mnemoniczne czy hasÅ‚a, **nie powinny mieÄ‡ moÅ¼liwoÅ›ci kopiowania do schowka** (lub przynajmniej powinny byÄ‡ usuwane ze schowka w ciÄ…gu kilku sekund), poniewaÅ¼ wtedy procesy monitorujÄ…ce schowek bÄ™dÄ… mogÅ‚y je uzyskaÄ‡.

## Åadowanie rozszerzenia w przeglÄ…darce

1. **Pobierz** Rozszerzenie PrzeglÄ…darki i rozpakuj je.
2. PrzejdÅº do **`chrome://extensions/`** i **wÅ‚Ä…cz** `Tryb dewelopera`.
3. Kliknij przycisk **`Load unpacked`**.

W **Firefoxie** przejdÅº do **`about:debugging#/runtime/this-firefox`** i kliknij przycisk **`Load Temporary Add-on`**.

## Uzyskiwanie kodu ÅºrÃ³dÅ‚owego ze sklepu

Kod ÅºrÃ³dÅ‚owy rozszerzenia Chrome moÅ¼na uzyskaÄ‡ na rÃ³Å¼ne sposoby. PoniÅ¼ej znajdujÄ… siÄ™ szczegÃ³Å‚owe wyjaÅ›nienia i instrukcje dla kaÅ¼dej opcji.

### Pobierz rozszerzenie jako ZIP za pomocÄ… wiersza poleceÅ„

Kod ÅºrÃ³dÅ‚owy rozszerzenia Chrome moÅ¼na pobraÄ‡ jako plik ZIP za pomocÄ… wiersza poleceÅ„. Wymaga to uÅ¼ycia `curl`, aby pobraÄ‡ plik ZIP z okreÅ›lonego adresu URL, a nastÄ™pnie wyodrÄ™bniÄ‡ zawartoÅ›Ä‡ pliku ZIP do katalogu. Oto kroki:

1. ZastÄ…p `"extension_id"` rzeczywistym ID rozszerzenia.
2. Wykonaj nastÄ™pujÄ…ce polecenia:
```bash
extension_id=your_extension_id   # Replace with the actual extension ID
curl -L -o "$extension_id.zip" "https://clients2.google.com/service/update2/crx?response=redirect&os=mac&arch=x86-64&nacl_arch=x86-64&prod=chromecrx&prodchannel=stable&prodversion=44.0.2403.130&x=id%3D$extension_id%26uc"
unzip -d "$extension_id-source" "$extension_id.zip"
```
### UÅ¼yj strony CRX Viewer

[https://robwu.nl/crxviewer/](https://robwu.nl/crxviewer/)

### UÅ¼yj rozszerzenia CRX Viewer

InnÄ… wygodnÄ… metodÄ… jest uÅ¼ycie Chrome Extension Source Viewer, ktÃ³ry jest projektem open-source. MoÅ¼na go zainstalowaÄ‡ z [Chrome Web Store](https://chrome.google.com/webstore/detail/chrome-extension-source-v/jifpbeccnghkjeaalbbjmodiffmgedin?hl=en). Kod ÅºrÃ³dÅ‚owy przeglÄ…darki jest dostÄ™pny w jej [repozytorium GitHub](https://github.com/Rob--W/crxviewer).

### WyÅ›wietl ÅºrÃ³dÅ‚o lokalnie zainstalowanego rozszerzenia

Rozszerzenia Chrome zainstalowane lokalnie moÅ¼na rÃ³wnieÅ¼ sprawdziÄ‡. Oto jak:

1. Uzyskaj dostÄ™p do lokalnego katalogu profilu Chrome, odwiedzajÄ…c `chrome://version/` i lokalizujÄ…c pole "Profile Path".
2. PrzejdÅº do podfolderu `Extensions/` w katalogu profilu.
3. Ten folder zawiera wszystkie zainstalowane rozszerzenia, zazwyczaj z ich kodem ÅºrÃ³dÅ‚owym w czytelnym formacie.

Aby zidentyfikowaÄ‡ rozszerzenia, moÅ¼esz powiÄ…zaÄ‡ ich identyfikatory z nazwami:

* WÅ‚Ä…cz tryb dewelopera na stronie `about:extensions`, aby zobaczyÄ‡ identyfikatory kaÅ¼dego rozszerzenia.
* W folderze kaÅ¼dego rozszerzenia plik `manifest.json` zawiera czytelne pole `name`, co pomaga w identyfikacji rozszerzenia.

### UÅ¼yj archiwizera plikÃ³w lub dekompresora

PrzejdÅº do Chrome Web Store i pobierz rozszerzenie. Plik bÄ™dzie miaÅ‚ rozszerzenie `.crx`. ZmieÅ„ rozszerzenie pliku z `.crx` na `.zip`. UÅ¼yj dowolnego archiwizera plikÃ³w (takiego jak WinRAR, 7-Zip itp.), aby wyodrÄ™bniÄ‡ zawartoÅ›Ä‡ pliku ZIP.

### UÅ¼yj trybu dewelopera w Chrome

OtwÃ³rz Chrome i przejdÅº do `chrome://extensions/`. WÅ‚Ä…cz "Tryb dewelopera" w prawym gÃ³rnym rogu. Kliknij "ZaÅ‚aduj rozpakowane rozszerzenie...". PrzejdÅº do katalogu swojego rozszerzenia. To nie pobiera kodu ÅºrÃ³dÅ‚owego, ale jest przydatne do przeglÄ…dania i modyfikowania kodu juÅ¼ pobranego lub opracowanego rozszerzenia.

## ZbiÃ³r manifestÃ³w rozszerzeÅ„ Chrome

Aby sprÃ³bowaÄ‡ zidentyfikowaÄ‡ podatne rozszerzenia przeglÄ…darki, moÅ¼esz uÅ¼yÄ‡ [https://github.com/palant/chrome-extension-manifests-dataset](https://github.com/palant/chrome-extension-manifests-dataset) i sprawdziÄ‡ ich pliki manifestÃ³w pod kÄ…tem potencjalnych oznak podatnoÅ›ci. Na przykÅ‚ad, aby sprawdziÄ‡ rozszerzenia z wiÄ™cej niÅ¼ 25000 uÅ¼ytkownikÃ³w, `content_scripts` i uprawnienie `nativeMessaging`:

{% code overflow="wrap" %}
```bash
# Query example from https://spaceraccoon.dev/universal-code-execution-browser-extensions/
node query.js -f "metadata.user_count > 250000" "manifest.content_scripts?.length > 0 && manifest.permissions?.includes('nativeMessaging')"
```
{% endcode %}

## Lista kontrolna audytu bezpieczeÅ„stwa

Mimo Å¼e rozszerzenia przeglÄ…darki majÄ… **ograniczonÄ… powierzchniÄ™ ataku**, niektÃ³re z nich mogÄ… zawieraÄ‡ **luki** lub **moÅ¼liwoÅ›ci wzmocnienia**. Oto najczÄ™stsze z nich:

* [ ] **Ogranicz** jak najbardziej wymagane **`permissions`**
* [ ] **Ogranicz** jak najbardziej **`host_permissions`**
* [ ] UÅ¼yj **silnej** **`content_security_policy`**
* [ ] **Ogranicz** jak najbardziej **`externally_connectable`**, jeÅ›li nie jest potrzebne i moÅ¼liwe, nie zostawiaj domyÅ›lnie, okreÅ›l **`{}`**
* [ ] JeÅ›li **URL podatny na XSS lub przejÄ™cie** jest tutaj wymieniony, atakujÄ…cy bÄ™dzie mÃ³gÅ‚ **wysyÅ‚aÄ‡ wiadomoÅ›ci do skryptÃ³w w tle bezpoÅ›rednio**. Bardzo potÄ™Å¼ne obejÅ›cie.
* [ ] **Ogranicz** jak najbardziej **`web_accessible_resources`**, nawet puste, jeÅ›li to moÅ¼liwe.
* [ ] JeÅ›li **`web_accessible_resources`** nie jest puste, sprawdÅº [**ClickJacking**](browext-clickjacking.md)
* [ ] JeÅ›li jakakolwiek **komunikacja** zachodzi z **rozszerzenia** do **strony internetowej**, [**sprawdÅº XSS**](browext-xss-example.md) **luki** spowodowane w komunikacji.
* [ ] JeÅ›li uÅ¼ywane sÄ… Post Messages, sprawdÅº [**luki w Post Message**](../postmessage-vulnerabilities/)**.**
* [ ] JeÅ›li **Content Script ma dostÄ™p do szczegÃ³Å‚Ã³w DOM**, sprawdÅº, czy **nie wprowadza XSS**, jeÅ›li zostanie **zmodyfikowany** przez stronÄ™ internetowÄ….
* [ ] ZwrÃ³Ä‡ szczegÃ³lnÄ… uwagÄ™, jeÅ›li ta komunikacja jest rÃ³wnieÅ¼ zaangaÅ¼owana w **komunikacjÄ™ Content Script -> skrypt w tle**
* [ ] JeÅ›li skrypt w tle komunikuje siÄ™ za pomocÄ… **native messaging**, sprawdÅº, czy komunikacja jest bezpieczna i oczyszczona
* [ ] **WraÅ¼liwe informacje nie powinny byÄ‡ przechowywane** wewnÄ…trz kodu rozszerzenia przeglÄ…darki
* [ ] **WraÅ¼liwe informacje nie powinny byÄ‡ przechowywane** wewnÄ…trz pamiÄ™ci rozszerzenia przeglÄ…darki
* [ ] **WraÅ¼liwe informacje nie powinny byÄ‡ przechowywane** w **systemie plikÃ³w bez ochrony**

## NarzÄ™dzia

### [**Tarnish**](https://thehackerblog.com/tarnish/)

* Pobiera dowolne rozszerzenie Chrome z podanego linku do sklepu Chrome.
* [**manifest.json**](https://developer.chrome.com/extensions/manifest) **widok**: po prostu wyÅ›wietla wersjÄ™ JSON w formacie prettified manifestu rozszerzenia.
* **Analiza odciskÃ³w palcÃ³w**: Wykrywanie [web\_accessible\_resources](https://developer.chrome.com/extensions/manifest/web\_accessible\_resources) i automatyczne generowanie JavaScript do odciskÃ³w palcÃ³w rozszerzenia Chrome.
* **Potencjalna analiza Clickjacking**: Wykrywanie stron HTML rozszerzenia z ustawionym dyrektywÄ… [web\_accessible\_resources](https://developer.chrome.com/extensions/manifest/web\_accessible\_resources). Te mogÄ… byÄ‡ potencjalnie podatne na clickjacking w zaleÅ¼noÅ›ci od celu stron.
* **Widok ostrzeÅ¼eÅ„ o uprawnieniach**: ktÃ³ry pokazuje listÄ™ wszystkich ostrzeÅ¼eÅ„ o uprawnieniach Chrome, ktÃ³re bÄ™dÄ… wyÅ›wietlane po prÃ³bie zainstalowania rozszerzenia przez uÅ¼ytkownika.
* **Niebezpieczna funkcja**: pokazuje lokalizacjÄ™ niebezpiecznych funkcji, ktÃ³re mogÄ… byÄ‡ potencjalnie wykorzystywane przez atakujÄ…cego (np. funkcje takie jak innerHTML, chrome.tabs.executeScript).
* **Punkty wejÅ›cia**: pokazuje, gdzie rozszerzenie przyjmuje dane wejÅ›ciowe od uÅ¼ytkownika/zewnÄ™trzne. To jest przydatne do zrozumienia powierzchni rozszerzenia i szukania potencjalnych punktÃ³w do wysyÅ‚ania zÅ‚oÅ›liwie skonstruowanych danych do rozszerzenia.
* ZarÃ³wno skanery Niebezpiecznych Funkcji, jak i PunktÃ³w WejÅ›cia majÄ… nastÄ™pujÄ…ce dla swoich wygenerowanych alertÃ³w:
* Odpowiedni fragment kodu i linia, ktÃ³ra spowodowaÅ‚a alert.
* Opis problemu.
* Przycisk â€Zobacz plikâ€, aby zobaczyÄ‡ peÅ‚ny plik ÅºrÃ³dÅ‚owy zawierajÄ…cy kod.
* ÅšcieÅ¼ka alertowanego pliku.
* PeÅ‚ny URI rozszerzenia Chrome alertowanego pliku.
* Typ pliku, taki jak skrypt strony w tle, skrypt treÅ›ci, akcja przeglÄ…darki itp.
* JeÅ›li podatna linia znajduje siÄ™ w pliku JavaScript, Å›cieÅ¼ki wszystkich stron, w ktÃ³rych jest zawarta, a takÅ¼e typ tych stron oraz status [web\_accessible\_resource](https://developer.chrome.com/extensions/manifest/web\_accessible\_resources).
* **Analizator polityki bezpieczeÅ„stwa treÅ›ci (CSP) i sprawdzacz obejÅ›Ä‡**: To wskaÅ¼e sÅ‚aboÅ›ci w CSP twojego rozszerzenia i rÃ³wnieÅ¼ oÅ›wietli wszelkie potencjalne sposoby obejÅ›cia twojego CSP z powodu biaÅ‚ych list CDN itp.
* **Znane podatne biblioteki**: To wykorzystuje [Retire.js](https://retirejs.github.io/retire.js/) do sprawdzenia jakiegokolwiek uÅ¼ycia znanych podatnych bibliotek JavaScript.
* Pobierz rozszerzenie i sformatowane wersje.
* Pobierz oryginalne rozszerzenie.
* Pobierz wersjÄ™ rozszerzenia w formacie beautified (automatycznie sformatowany HTML i JavaScript).
* Automatyczne buforowanie wynikÃ³w skanowania, uruchomienie skanowania rozszerzenia zajmie sporo czasu przy pierwszym uruchomieniu. Jednak przy drugim uruchomieniu, zakÅ‚adajÄ…c, Å¼e rozszerzenie nie zostaÅ‚o zaktualizowane, bÄ™dzie prawie natychmiastowe dziÄ™ki buforowanym wynikom.
* Linkowalne adresy URL raportÃ³w, Å‚atwo linkuj kogoÅ› do raportu rozszerzenia wygenerowanego przez tarnish.

### [Neto](https://github.com/elevenpaths/neto)

Projekt Neto to pakiet Pythona 3 stworzony do analizy i odkrywania ukrytych funkcji wtyczek i rozszerzeÅ„ przeglÄ…darek dla znanych przeglÄ…darek, takich jak Firefox i Chrome. Automatyzuje proces rozpakowywania spakowanych plikÃ³w, aby wydobyÄ‡ te funkcje z odpowiednich zasobÃ³w w rozszerzeniu, takich jak `manifest.json`, foldery lokalizacyjne lub pliki ÅºrÃ³dÅ‚owe JavaScript i HTML.

## Odniesienia

* **DziÄ™ki** [**@naivenom**](https://twitter.com/naivenom) **za pomoc w tej metodologii**
* [https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing](https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing)
* [https://palant.info/2022/08/10/anatomy-of-a-basic-extension/](https://palant.info/2022/08/10/anatomy-of-a-basic-extension/)
* [https://palant.info/2022/08/24/attack-surface-of-extension-pages/](https://palant.info/2022/08/24/attack-surface-of-extension-pages/)
* [https://palant.info/2022/08/31/when-extension-pages-are-web-accessible/](https://palant.info/2022/08/31/when-extension-pages-are-web-accessible/)
* [https://help.passbolt.com/assets/files/PBL-02-report.pdf](https://help.passbolt.com/assets/files/PBL-02-report.pdf)
* [https://developer.chrome.com/docs/extensions/develop/concepts/content-scripts](https://developer.chrome.com/docs/extensions/develop/concepts/content-scripts)
* [https://developer.chrome.com/docs/extensions/mv2/background-pages](https://developer.chrome.com/docs/extensions/mv2/background-pages)
* [https://thehackerblog.com/kicking-the-rims-a-guide-for-securely-writing-and-auditing-chrome-extensions/](https://thehackerblog.com/kicking-the-rims-a-guide-for-securely-writing-and-auditing-chrome-extensions/)
* [https://gist.github.com/LongJohnCoder/9ddf5735df3a4f2e9559665fb864eac0](https://gist.github.com/LongJohnCoder/9ddf5735df3a4f2e9559665fb864eac0)

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ sztuczkami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>
{% endhint %}
