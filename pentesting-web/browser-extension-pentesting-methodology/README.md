# Metodologija testiranja bezbednosti pregledaÄkih dodataka

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Osnovne informacije

PregledaÄki dodaci su napisani u JavaScript-u i uÄitavaju se od strane pregledaÄa u pozadini. Ima svoj [DOM](https://www.w3schools.com/js/js\_htmldom.asp), ali moÅ¾e da interaguje sa DOM-om drugih sajtova. To znaÄi da moÅ¾e ugroziti poverljivost, integritet i dostupnost (CIA) drugih sajtova.

## Glavne komponente

Dizajn pregledaÄkih dodataka izgleda najbolje kada se vizualizuje i sastoji se od tri komponente. Pogledajmo svaku komponentu detaljnije.

<figure><img src="../../.gitbook/assets/image (4).png" alt=""><figcaption><p><a href="http://webblaze.cs.berkeley.edu/papers/Extensions.pdf">http://webblaze.cs.berkeley.edu/papers/Extensions.pdf</a></p></figcaption></figure>

### **Content Scripts**

Svaki content script ima direktni pristup DOM-u **jedne veb stranice** i time je izloÅ¾en **potencijalno zlonamernom unosu**. MeÄ‘utim, content script nema dozvole osim moguÄ‡nosti slanja poruka jezgru dodatka.

### **Jezgro dodatka**

Jezgro dodatka sadrÅ¾i veÄ‡inu privilegija/pristupa dodatka, ali jezgro dodatka moÅ¾e samo da komunicira sa veb sadrÅ¾ajem putem [XMLHttpRequest](https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest) i content scriptova. TakoÄ‘e, jezgro dodatka nema direktni pristup host maÅ¡ini.

### **Nativni binarni fajl**

Dodatak omoguÄ‡ava upotrebu nativnog binarnog fajla koji moÅ¾e **pristupiti host maÅ¡ini sa punim privilegijama korisnika**. Nativni binarni fajl komunicira sa jezgrom dodatka putem standardnog Netscape Plugin Application Programming Interface ([NPAPI](https://en.wikipedia.org/wiki/NPAPI)) koji se koristi za Flash i druge pregledaÄke dodatke.

### Granice

{% hint style="danger" %}
Da bi dobio puna ovlaÅ¡Ä‡enja korisnika, napadaÄ mora ubediti dodatak da prosledi zlonameran unos iz content scripta jezgru dodatka i iz jezgra dodatka nativnom binarnom fajlu.
{% endhint %}

Svaka komponenta dodatka je odvojena jedna od druge **jakim zaÅ¡titnim granicama**. Svaka komponenta se izvrÅ¡ava u **odvojenom operativnom sistemu**. Content scriptovi i jezgra dodatka se izvrÅ¡avaju u **peskovitim procesima** koji nisu dostupni veÄ‡ini usluga operativnog sistema.

Osim toga, content scriptovi se odvajaju od svojih povezanih veb stranica **izvrÅ¡avanjem u odvojenoj JavaScript memoriji**. Content script i veb stranica imaju **pristup istom osnovnom DOM-u**, ali se dve komponente **nikada ne razmenjuju JavaScript pokazivaÄe**, Äime se spreÄava curenje JavaScript funkcionalnosti.

## **`manifest.json`**

Chrome dodatak je samo ZIP folder sa [.crx ekstenzijom fajla](https://www.lifewire.com/crx-file-2620391). Jezgro dodatka je **`manifest.json`** fajl koji se nalazi u korenu foldera i koji definiÅ¡e izgled, dozvole i druge konfiguracione opcije.

Primer:
```json
{
"manifest_version": 2,
"name": "My extension",
"version": "1.0",
"permissions": [
"storage"
],
"content_scripts": [
{
"js": [
"script.js"
],
"matches": [
"https://example.com/*",
"https://www.example.com/*"
],
"exclude_matches": ["*://*/*business*"],
}
],
"background": {
"scripts": [
"background.js"
]
},
"options_ui": {
"page": "options.html"
}
}
```
### `content_scripts`

Content skripte se **uÄitavaju** svaki put kada korisnik **navigira na odgovarajuÄ‡u stranicu**, u naÅ¡em sluÄaju bilo koju stranicu koja odgovara izrazu **`https://example.com/*`** i ne odgovara regularnom izrazu **`*://*/*/business*`**. Oni se izvrÅ¡avaju **kao skripte same stranice** i imaju proizvoljan pristup [Document Object Model (DOM)](https://developer.mozilla.org/en-US/docs/Web/API/Document\_Object\_Model) stranice.
```json
"content_scripts": [
{
"js": [
"script.js"
],
"matches": [
"https://example.com/*",
"https://www.example.com/*"
],
"exclude_matches": ["*://*/*business*"],
}
],
```
Da biste ukljuÄili ili iskljuÄili viÅ¡e URL-ova, takoÄ‘e je moguÄ‡e koristiti **`include_globs`** i **`exclude_globs`**.

Ovo je primer skripte sadrÅ¾aja koja Ä‡e dodati dugme za objaÅ¡njenje na stranici kada [API za skladiÅ¡tenje](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/storage) koristi se za dobijanje vrednosti `message` iz skladiÅ¡ta proÅ¡irenja.
```js
chrome.storage.local.get("message", result =>
{
let div = document.createElement("div");
div.innerHTML = result.message + " <button>Explain</button>";
div.querySelector("button").addEventListener("click", () =>
{
chrome.runtime.sendMessage("explain");
});
document.body.appendChild(div);
});
```
<figure><img src="../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

Kada se klikne na dugme, poruka se Å¡alje stranicama ekstenzije putem skripte sadrÅ¾aja, koriÅ¡Ä‡enjem [**runtime.sendMessage() API-ja**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/runtime/sendMessage). Ovo je zbog ograniÄenja skripte sadrÅ¾aja u direktnom pristupu API-ima, pri Äemu je `storage` meÄ‘u retkim izuzecima. Za funkcionalnosti izvan ovih izuzetaka, poruke se Å¡alju stranicama ekstenzije sa kojima skripte sadrÅ¾aja mogu komunicirati.

{% hint style="warning" %}
Zavisno od pregledaÄa, moguÄ‡nosti skripte sadrÅ¾aja mogu se malo razlikovati. Za pregledaÄe zasnovane na Chromiumu, lista moguÄ‡nosti je dostupna u [Chrome Developers dokumentaciji](https://developer.chrome.com/docs/extensions/mv3/content_scripts/#capabilities), a za Firefox, [MDN](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/Content_scripts#webextension_apis) sluÅ¾i kao primarni izvor.\
TakoÄ‘e je vaÅ¾no napomenuti da skripte sadrÅ¾aja imaju moguÄ‡nost komunikacije sa pozadinskim skriptama, omoguÄ‡avajuÄ‡i im da izvrÅ¡e radnje i prenesu odgovore nazad.
{% endhint %}

Za pregledanje i otklanjanje greÅ¡aka u skriptama sadrÅ¾aja u Chromeu, meni za razvojne alate moÅ¾e se pristupiti putem Opcije > ViÅ¡e alata > Razvojni alati ILI pritiskom na Ctrl + Shift + I.

Kada se prikaÅ¾u razvojni alati, treba kliknuti na **Kartica izvora**, a zatim na **Kartica skripti sadrÅ¾aja**. To omoguÄ‡ava posmatranje pokrenutih skripti sadrÅ¾aja iz razliÄitih ekstenzija i postavljanje taÄaka prekida kako bi se pratilo izvrÅ¡avanje.

### UbaÄene skripte sadrÅ¾aja

{% hint style="success" %}
Imajte na umu da **skripte sadrÅ¾aja nisu obavezne**, jer je takoÄ‘e moguÄ‡e **dinamiÄki** **ubaciti** skripte i **programski ih ubaciti** na veb stranice putem **`tabs.executeScript`**. Ovo zapravo pruÅ¾a viÅ¡e **granularne kontrole**.
{% endhint %}

Za programsko ubacivanje skripte sadrÅ¾aja, ekstenzija mora imati [dozvole za host](https://developer.chrome.com/docs/extensions/reference/permissions) za stranicu u koju Ä‡e skripte biti ubaÄene. Ove dozvole mogu se obezbediti ili **zahtevanjem** u manifestu ekstenzije ili privremeno putem [**activeTab**](https://developer.chrome.com/docs/extensions/reference/manifest/activeTab).

#### Primer ekstenzije zasnovane na activeTab-u

{% code title="manifest.json" %}
```json
{
"name": "My extension",
...
"permissions": [
"activeTab",
"scripting"
],
"background": {
"service_worker": "background.js"
},
"action": {
"default_title": "Action Button"
}
}
```
{% endcode %}

* **Ubacivanje JS fajla na klik:**
```javascript
// content-script.js
document.body.style.backgroundColor = "orange";

//service-worker.js - Inject the JS file
chrome.action.onClicked.addListener((tab) => {
chrome.scripting.executeScript({
target: { tabId: tab.id },
files: ["content-script.js"]
});
});
```
* **Ubacivanje funkcije** na klik:
```javascript
//service-worker.js - Inject a function
function injectedFunction() {
document.body.style.backgroundColor = "orange";
}

chrome.action.onClicked.addListener((tab) => {
chrome.scripting.executeScript({
target : {tabId : tab.id},
func : injectedFunction,
});
});
```
#### Primer sa dozvolama za skriptovanje

In order to test the security of a browser extension, it is important to understand the permissions granted to the extension. One common permission is the ability to execute scripts on web pages. This permission allows the extension to interact with the content of the web page and potentially perform malicious actions.

Da biste testirali sigurnost browser ekstenzije, vaÅ¾no je razumeti dozvole koje su dodeljene ekstenziji. Jedna od uobiÄajenih dozvola je moguÄ‡nost izvrÅ¡avanja skripti na veb stranicama. Ova dozvola omoguÄ‡ava ekstenziji da interaguje sa sadrÅ¾ajem veb stranice i potencijalno izvrÅ¡ava zlonamerne radnje.

To test the scripting permissions of a browser extension, follow these steps:

Da biste testirali dozvole za skriptovanje browser ekstenzije, pratite ove korake:

1. Install the browser extension on your testing environment.

   Instalirajte browser ekstenziju na vaÅ¡em testnom okruÅ¾enju.

2. Open a web page that allows user-generated content or has a form input field.

   Otvorite veb stranicu koja omoguÄ‡ava korisniÄki generisani sadrÅ¾aj ili ima polje za unos forme.

3. Right-click on the web page and select "Inspect" or "Inspect Element" to open the browser developer tools.

   Desnim klikom na veb stranicu izaberite "Inspect" ili "Inspect Element" da biste otvorili alatke za razvoj browsera.

4. In the developer tools, navigate to the "Console" tab.

   U alatkama za razvoj, preÄ‘ite na karticu "Console".

5. Type `document.body.contentEditable = true` in the console and press Enter.

   Ukucajte `document.body.contentEditable = true` u konzolu i pritisnite Enter.

6. Now, you can edit the content of the web page by clicking on it and making changes.

   Sada moÅ¾ete izmeniti sadrÅ¾aj veb stranice tako Å¡to Ä‡ete na nju kliknuti i napraviti promene.

By enabling the `contentEditable` property of the web page's body element, you gain the ability to modify the content of the page. This demonstrates the scripting permissions of the browser extension.

OmoguÄ‡avanjem `contentEditable` svojstva elementa body veb stranice, dobijate moguÄ‡nost da izmenite sadrÅ¾aj stranice. Ovo demonstrira dozvole za skriptovanje browser ekstenzije.
```javascript
// service-workser.js
chrome.scripting.registerContentScripts([{
id : "test",
matches : [ "https://*.example.com/*" ],
excludeMatches : [ "*://*/*business*" ],
js : [ "contentScript.js" ],
}]);

// Another example
chrome.tabs.executeScript(tabId, { file: "content_script.js" });
```
Da biste ukljuÄili ili iskljuÄili viÅ¡e URL-ova, takoÄ‘e je moguÄ‡e koristiti **`include_globs`** i **`exclude_globs`**.

### Skripte sadrÅ¾aja `run_at`

Polje `run_at` kontroliÅ¡e **kada se JavaScript fajlovi ubacuju u veb stranicu**. Preferirana i podrazumevana vrednost je `"document_idle"`.

MoguÄ‡e vrednosti su:

* **`document_idle`**: Kada god je moguÄ‡e
* **`document_start`**: Nakon svih fajlova iz `css`, ali pre konstrukcije bilo kog drugog DOM-a ili pokretanja bilo kog drugog skripta.
* **`document_end`**: Neposredno nakon zavrÅ¡etka DOM-a, ali pre uÄitavanja podresursa poput slika i frejmova.

#### Putem `manifest.json`
```json
{
"name": "My extension",
...
"content_scripts": [
{
"matches": ["https://*.example.com/*"],
"run_at": "document_idle",
"js": ["contentScript.js"]
}
],
...
}

```
Preko **`service-worker.js`**
```javascript
chrome.scripting.registerContentScripts([{
id : "test",
matches : [ "https://*.example.com/*" ],
runAt : "document_idle",
js : [ "contentScript.js" ],
}]);
```
### `pozadina`

Poruke poslate od strane sadrÅ¾ajnih skripti se primaju od strane **pozadinske stranice**, koja ima centralnu ulogu u koordinaciji komponenti proÅ¡irenja. Posebno, pozadinska stranica ostaje aktivna tokom trajanja proÅ¡irenja, neprimetno funkcioniÅ¡uÄ‡i bez direktnog korisniÄkog interakcije. Ona poseduje svoj Document Object Model (DOM), omoguÄ‡avajuÄ‡i kompleksne interakcije i upravljanje stanjem.

**KljuÄne taÄke**:

- **Uloga pozadinske stranice:** Deluje kao nervni centar proÅ¡irenja, obezbeÄ‘ujuÄ‡i komunikaciju i koordinaciju izmeÄ‘u razliÄitih delova proÅ¡irenja.
- **Postojanost:** Ona je stalno prisutna entitet, nevidljiva korisniku ali integralna za funkcionalnost proÅ¡irenja.
- **Automatsko generisanje:** Ako nije eksplicitno definisana, pregledaÄ Ä‡e automatski kreirati pozadinsku stranicu. Ova automatski generisana stranica Ä‡e ukljuÄiti sve pozadinske skripte navedene u manifestu proÅ¡irenja, obezbeÄ‘ujuÄ‡i besprekorno funkcionisanje pozadinskih zadataka proÅ¡irenja.

{% hint style="success" %}
PraktiÄnost koju pregledaÄ pruÅ¾a automatskim generisanjem pozadinske stranice (kada nije eksplicitno deklarisana) obezbeÄ‘uje da su sve neophodne pozadinske skripte integrisane i operativne, pojednostavljujuÄ‡i proces podeÅ¡avanja proÅ¡irenja.
{% endhint %}

Primer pozadinske skripte:
```js
chrome.runtime.onMessage.addListener((request, sender, sendResponse) =>
{
if (request == "explain")
{
chrome.tabs.create({ url: "https://example.net/explanation" });
}
})
```
Koristi [runtime.onMessage API](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/runtime/onMessage) da bi osluÅ¡kivao poruke. Kada primi poruku "explain", koristi [tabs API](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs) da otvori stranicu u novom tabu.

Da biste debagovali pozadinski skript, moÅ¾ete otiÄ‡i na **detalje proÅ¡irenja i inspekciju servisnog radnika**, Å¡to Ä‡e otvoriti alate za razvoj sa pozadinskim skriptom:

<figure><img src="broken-reference" alt=""><figcaption></figcaption></figure>

### Stranice opcija i ostalo

Browser proÅ¡irenja mogu sadrÅ¾avati razliÄite vrste stranica:

* **Stranice akcija** se prikazuju u **padajuÄ‡em meniju kada se klikne ikona proÅ¡irenja**.
* Stranice koje proÅ¡irenje Ä‡e **uÄitati u novom tabu**.
* **Stranice opcija**: Ova stranica se prikazuje iznad proÅ¡irenja kada se klikne. U prethodnom manifestu, u mom sluÄaju, mogao sam pristupiti ovoj stranici na `chrome://extensions/?options=fadlhnelkbeojnebcbkacjilhnbjfjca` ili klikom na:

<figure><img src="../../.gitbook/assets/image (8).png" alt="" width="375"><figcaption></figcaption></figure>

Imajte na umu da ove stranice nisu trajne kao pozadinske stranice jer dinamiÄki uÄitavaju sadrÅ¾aj po potrebi. Ipak, deljenje odreÄ‘enih moguÄ‡nosti sa pozadinskom stranicom:

- **Komunikacija sa skriptama sadrÅ¾aja:** SliÄno kao pozadinska stranica, ove stranice mogu primati poruke od skripti sadrÅ¾aja, olakÅ¡avajuÄ‡i interakciju unutar proÅ¡irenja.
- **Pristup API-ju specifiÄnom za proÅ¡irenje:** Ove stranice imaju sveobuhvatan pristup API-ju specifiÄnom za proÅ¡irenje, u skladu sa dozvolama definisanim za proÅ¡irenje.

### `permissions` i `host_permissions`

**`permissions`** i **`host_permissions`** su unosi iz `manifest.json` koji Ä‡e ukazivati na **koje dozvole** browser proÅ¡irenje ima (skladiÅ¡te, lokacija...) i na **kojim veb stranicama**.

Kako browser proÅ¡irenja mogu biti tako **privilegovana**, zlonamerno proÅ¡irenje ili proÅ¡irenje koje je kompromitovano moÅ¾e omoguÄ‡iti napadaÄu **razliÄite naÄine za kraÄ‘u osetljivih informacija i Å¡pijuniranje korisnika**.

Pogledajte kako ove postavke funkcioniÅ¡u i kako mogu biti zloupotrebljene u:

{% content-ref url="browext-permissions-and-host_permissions.md" %}
[browext-permissions-and-host\_permissions.md](browext-permissions-and-host\_permissions.md)
{% endcontent-ref %}

### `content_security_policy`

Politika bezbednosti sadrÅ¾aja se takoÄ‘e moÅ¾e deklarisati unutar `manifest.json`. Ako je definisana, moÅ¾e biti **ranjiva**.

Podrazumevana postavka za stranice browser proÅ¡irenja je priliÄno restriktivna:
```bash
script-src 'self'; object-src 'self';
```
Za viÅ¡e informacija o CSP i moguÄ‡im zaobilaznicama pogledajte:

{% content-ref url="../content-security-policy-csp-bypass/" %}
[content-security-policy-csp-bypass](../content-security-policy-csp-bypass/)
{% endcontent-ref %}

### `web_accessible_resources`

da bi veb stranica mogla pristupiti stranici Browser Extension-a, na primer `.html` stranici, ova stranica mora biti navedena u polju **`web_accessible_resources`** u `manifest.json` fajlu.\
Na primer:
```javascript
{
...
"web_accessible_resources": [
{
"resources": [ "images/*.png" ],
"matches": [ "https://example.com/*" ]
},
{
"resources": [ "fonts/*.woff" ],
"matches": [ "https://example.com/*" ]
}
],
...
}
```
Ove stranice su dostupne na URL-u kao:
```
chrome-extension://<extension-id>/message.html
```
U javnim ekstenzijama **id ekstenzije je dostupno**:

<figure><img src="../../.gitbook/assets/image (722).png" alt="" width="375"><figcaption></figcaption></figure>

MeÄ‘utim, ako se koristi parametar `use_dynamic_url` u `manifest.json` datoteci, ovo **id moÅ¾e biti dinamiÄko**.

Dozvoljavanje pristupa ovim stranicama Äini ih **potencijalno ranjivim na ClickJacking**:

{% content-ref url="browext-clickjacking.md" %}
[browext-clickjacking.md](browext-clickjacking.md)
{% endcontent-ref %}

{% hint style="success" %}
Dozvoljavanje uÄitavanja ovih stranica samo od strane ekstenzije, a ne od nasumiÄnih URL-ova, moÅ¾e spreÄiti napade ClickJacking-a.
{% endhint %}

### `externally_connectable`

Prema [**dokumentaciji**](https://developer.chrome.com/docs/extensions/reference/manifest/externally-connectable), manifest svojstvo `"externally_connectable"` deklariÅ¡e **koje ekstenzije i web stranice mogu se povezati** sa vaÅ¡om ekstenzijom putem [runtime.connect](https://developer.chrome.com/docs/extensions/reference/runtime#method-connect) i [runtime.sendMessage](https://developer.chrome.com/docs/extensions/reference/runtime#method-sendMessage).

* Ako kljuÄ **`externally_connectable`** nije deklarisan u manifestu vaÅ¡e ekstenzije ili je deklarisan kao **`"ids": ["*"]`**, **sve ekstenzije mogu se povezati, ali nijedna web stranica ne moÅ¾e**.
* Ako su navedeni **specifiÄni ID-ovi**, kao u `"ids": ["aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"]`, **samo te aplikacije** mogu se povezati.
* Ako su navedeni **poklapanja (matches)**, te web aplikacije Ä‡e moÄ‡i da se poveÅ¾u:
```json
"matches": [
"https://*.google.com/*",
"*://*.chromium.org/*",
```
* Ako je navedeno kao prazno: **`"externally_connectable": {}`**, nijedna aplikacija ili veb stranica neÄ‡e moÄ‡i da se poveÅ¾e.

Å to je manje ekstenzija i URL-ova navedeno ovde, to Ä‡e povrÅ¡ina napada biti manja.

{% hint style="danger" %}
Ako je veb stranica koja je ranjiva na XSS ili preuzimanje navedena u **`externally_connectable`**, napadaÄ Ä‡e moÄ‡i da Å¡alje poruke direktno skripti pozadine, potpuno zaobilazeÄ‡i Content Script i njegov CSP.

Ovo je veoma moÄ‡an naÄin zaobilaÅ¾enja.
{% endhint %}

## Komunikacija izmeÄ‘u veba **â†”ï¸** Content Script

OkruÅ¾enja u kojima rade **content script**-ovi i u kojima postoje stranice domaÄ‡ini su **odvojena** jedna od druge, Å¡to osigurava **izolaciju**. Uprkos ovoj izolaciji, oba imaju moguÄ‡nost da komuniciraju sa **Document Object Model (DOM)** stranice, koji je zajedniÄki resurs. Da bi stranica domaÄ‡in mogla da komunicira sa **content script**-om, ili indirektno sa ekstenzijom preko content script-a, potrebno je koristiti DOM koji je dostupan obema stranama kao kanal komunikacije.

### Slanje poruka

{% code title="content-script.js" %}
```javascript
var port = chrome.runtime.connect();

window.addEventListener("message", (event) => {
// We only accept messages from ourselves
if (event.source !== window) {
return;
}

if (event.data.type && (event.data.type === "FROM_PAGE")) {
console.log("Content script received: " + event.data.text);
port.postMessage(event.data.text);
}
}, false);
```
{% code title="primer.js" %}
```javascript
document.getElementById("theButton").addEventListener("click", () => {
window.postMessage(
{type : "FROM_PAGE", text : "Hello from the webpage!"}, "*");
}, false);
```
{% endcode %}

Sigurna komunikacija putem Post Message-a treba da proveri autentiÄnost primljene poruke, to se moÅ¾e uraditi proverom:

* **`event.isTrusted`**: Ovo je taÄno samo ako je dogaÄ‘aj pokrenut korisniÄkom akcijom
* Skripta sadrÅ¾aja moÅ¾e oÄekivati poruku samo ako korisnik izvrÅ¡i odreÄ‘enu akciju
* **Izvorni domen**: moÅ¾e se oÄekivati poruka samo od liste dozvoljenih domena.
* Ako se koristi regex, treba biti veoma oprezan
* **Izvor**: `received_message.source !== window` se moÅ¾e koristiti da se proveri da li je poruka **iz istog prozora** gde Skripta sadrÅ¾aja sluÅ¡a.

Prethodne provere, Äak i ako su izvrÅ¡ene, mogu biti ranjive, pa proverite na sledeÄ‡oj stranici **potencijalne zaobilaÅ¾enja Post Message-a**:

{% content-ref url="../postmessage-vulnerabilities/" %}
[postmessage-vulnerabilities](../postmessage-vulnerabilities/)
{% endcontent-ref %}

### Iframe

JoÅ¡ jedan moguÄ‡i naÄin komunikacije moÅ¾e biti putem **URL-ova Iframe-a**, primer moÅ¾ete pronaÄ‡i u:

{% content-ref url="browext-xss-example.md" %}
[browext-xss-example.md](browext-xss-example.md)
{% endcontent-ref %}

### DOM

Ovo nije "taÄno" naÄin komunikacije, ali **veb i skripta sadrÅ¾aja Ä‡e imati pristup DOM-u veba**. Dakle, ako **skripta sadrÅ¾aja** Äita neke informacije iz njega, **verujuÄ‡i DOM-u veba**, veb moÅ¾e **izmeniti te podatke** (jer vebu ne treba verovati, ili jer je veb ranjiv na XSS) i **ugroziti Skriptu sadrÅ¾aja**.

TakoÄ‘e moÅ¾ete pronaÄ‡i primer **DOM baziranog XSS-a za ugroÅ¾avanje proÅ¡irenja pregledaÄa** u:

{% content-ref url="browext-xss-example.md" %}
[browext-xss-example.md](browext-xss-example.md)
{% endcontent-ref %}

## Osetljive informacije u memoriji/kodu

Ako ProÅ¡irenje pregledaÄa Äuva **osetljive informacije unutar svoje memorije**, to moÅ¾e biti **izvuÄeno** (posebno na Windows maÅ¡inama) i **pretraÅ¾eno** u potrazi za tim informacijama.

Stoga, memorija ProÅ¡irenja pregledaÄa **ne bi trebala biti smatrana sigurnom** i **osetljive informacije** kao Å¡to su akreditivi ili mnemoniÄke fraze **ne bi trebale biti Äuvane**.

Naravno, **ne stavljajte osetljive informacije u kod**, jer Ä‡e biti **javno dostupne**.

## Komunikacija izmeÄ‘u Skripte sadrÅ¾aja **â†”ï¸** Pozadinske skripte

Skripta sadrÅ¾aja moÅ¾e koristiti funkcije [**runtime.sendMessage()**](https://developer.chrome.com/docs/extensions/reference/runtime#method-sendMessage) **ili** [**tabs.sendMessage()**](https://developer.chrome.com/docs/extensions/reference/tabs#method-sendMessage) da poÅ¡alje **jednokratnu JSON-serializable** poruku.

Za rukovanje **odgovorom**, koristite vraÄ‡eni **Promise**. Ipak, radi kompatibilnosti unazad, i dalje moÅ¾ete proslediti **callback** kao poslednji argument.

Slanje zahteva iz **skripte sadrÅ¾aja** izgleda ovako:
```javascript
(async () => {
const response = await chrome.runtime.sendMessage({greeting: "hello"});
// do something with response here, not outside the function
console.log(response);
})();
```
Slanje zahteva iz **ekstenzije** (obiÄno iz **pozadinskog skripta**) MoÅ¾e se koristiti Content skript funkcije, samo je potrebno specificirati na koju karticu ga poslati. Primer kako poslati poruku content skriptu na izabranoj kartici:
```javascript
// From https://stackoverflow.com/questions/36153999/how-to-send-a-message-between-chrome-extension-popup-and-content-script
(async () => {
const [tab] = await chrome.tabs.query({active: true, lastFocusedWindow: true});
const response = await chrome.tabs.sendMessage(tab.id, {greeting: "hello"});
// do something with response here, not outside the function
console.log(response);
})();
```
Na **primajuÄ‡oj strani**, trebate postaviti [**runtime.onMessage**](https://developer.chrome.com/docs/extensions/reference/runtime#event-onMessage) **sluÅ¡aÄ dogaÄ‘aja** da biste obradili poruku. Ovo izgleda isto iz sadrÅ¾ajnog skripta ili stranice proÅ¡irenja.
```javascript
// From https://stackoverflow.com/questions/70406787/javascript-send-message-from-content-js-to-background-js
chrome.runtime.onMessage.addListener(
function(request, sender, sendResponse) {
console.log(sender.tab ?
"from a content script:" + sender.tab.url :
"from the extension");
if (request.greeting === "hello")
sendResponse({farewell: "goodbye"});
}
);
```
U prikazanom primeru, **`sendResponse()`** je izvrÅ¡en sinhrono. Da biste izmenili `onMessage` dogaÄ‘ajni rukovalac za asinhrono izvrÅ¡avanje `sendResponse()`, neophodno je ukljuÄiti `return true;`.

VaÅ¾no je napomenuti da u scenarijima gde je viÅ¡e stranica postavljeno da primaju `onMessage` dogaÄ‘aje, **prva stranica koja izvrÅ¡i `sendResponse()`** za odreÄ‘eni dogaÄ‘aj Ä‡e biti jedina koja moÅ¾e efikasno dostaviti odgovor. Svi naknadni odgovori na isti dogaÄ‘aj neÄ‡e biti uzeti u obzir.

Prilikom kreiranja novih ekstenzija, trebalo bi koristiti promisi umesto povratnih poziva. Å to se tiÄe koriÅ¡Ä‡enja povratnih poziva, funkcija `sendResponse()` se smatra validnom samo ako se izvrÅ¡ava direktno unutar sinhronog konteksta ili ako rukovalac dogaÄ‘aja ukazuje na asinhronu operaciju vraÄ‡anjem `true`. Ukoliko nijedan rukovalac ne vrati `true` ili ako se funkcija `sendResponse()` ukloni iz memorije (garbage-collected), podrazumevano Ä‡e biti pokrenut povratni poziv povezan sa funkcijom `sendMessage()`.

## UÄitavanje ekstenzije u pregledaÄu

1. **Preuzmite** Browser Extension i raspakujte ga
2. Idite na **`chrome://extensions/`** i **omoguÄ‡ite** `Developer Mode` (ReÅ¾im za razvoj)
3. Kliknite na dugme **`Load unpacked`** (UÄitaj raspakovano)

U **Firefox-u** idite na **`about:debugging#/runtime/this-firefox`** i kliknite na dugme **`Load Temporary Add-on`** (UÄitaj privremeni dodatak).

## Dobijanje izvornog koda sa prodavnice

Izvorni kod Chrome ekstenzije moÅ¾e se dobiti na razliÄite naÄine. U nastavku su detaljno objaÅ¡njene i date instrukcije za svaku opciju.

### Preuzimanje ekstenzije kao ZIP putem komandne linije

Izvorni kod Chrome ekstenzije moÅ¾e se preuzeti kao ZIP fajl koristeÄ‡i komandnu liniju. To ukljuÄuje koriÅ¡Ä‡enje `curl`-a za preuzimanje ZIP fajla sa odreÄ‘ene URL adrese, a zatim izdvajanje sadrÅ¾aja ZIP fajla u odreÄ‘eni direktorijum. Evo koraka:

1. Zamenite `"extension_id"` sa stvarnim ID-em ekstenzije.
2. IzvrÅ¡ite sledeÄ‡e komande:
```bash
extension_id=your_extension_id   # Replace with the actual extension ID
curl -L -o "$extension_id.zip" "https://clients2.google.com/service/update2/crx?response=redirect&os=mac&arch=x86-64&nacl_arch=x86-64&prod=chromecrx&prodchannel=stable&prodversion=44.0.2403.130&x=id%3D$extension_id%26uc"
unzip -d "$extension_id-source" "$extension_id.zip"
```
### Koristite veb sajt CRX Viewer

[https://robwu.nl/crxviewer/](https://robwu.nl/crxviewer/)

### Koristite CRX Viewer ekstenziju

JoÅ¡ jedan praktiÄan naÄin je koriÅ¡Ä‡enje Chrome Extension Source Viewer-a, koji je open-source projekat. MoÅ¾e se instalirati sa [Chrome Web Store](https://chrome.google.com/webstore/detail/chrome-extension-source-v/jifpbeccnghkjeaalbbjmodiffmgedin?hl=en). Izvorni kod viewer-a je dostupan u njegovom [GitHub repozitorijumu](https://github.com/Rob--W/crxviewer).

### Pregledajte izvor lokalno instalirane ekstenzije

Lokalno instalirane Chrome ekstenzije takoÄ‘e mogu biti pregledane. Evo kako:

1. Pristupite Chrome lokalnom profil direktorijumu tako Å¡to Ä‡ete posetiti `chrome://version/` i pronaÄ‡i polje "Profile Path".
2. Idite na podfolder `Extensions/` unutar profil direktorijuma.
3. Ovaj folder sadrÅ¾i sve instalirane ekstenzije, obiÄno sa njihovim izvornim kodom u Äitljivom formatu.

Da biste identifikovali ekstenzije, moÅ¾ete mapirati njihove ID-jeve na imena:

- OmoguÄ‡ite Developer Mode na stranici `about:extensions` da biste videli ID-jeve svake ekstenzije.
- U okviru svakog foldera ekstenzije, fajl `manifest.json` sadrÅ¾i Äitljivo polje `name`, Å¡to vam pomaÅ¾e da identifikujete ekstenziju.

### Koristite Arhiver ili Unpacker fajlova
Idite na Chrome Web Store i preuzmite ekstenziju. Fajl Ä‡e imati ekstenziju `.crx`.
Promenite ekstenziju fajla iz `.crx` u `.zip`.
Koristite bilo koji arhiver fajlova (kao Å¡to su WinRAR, 7-Zip, itd.) da biste izvukli sadrÅ¾aj ZIP fajla.

### Koristite Developer Mode u Chrome-u
Otvorite Chrome i idite na `chrome://extensions/`.
OmoguÄ‡ite "Developer mode" u gornjem desnom uglu.
Kliknite na "Load unpacked extension...".
Navigirajte do direktorijuma vaÅ¡e ekstenzije.
Ovo ne preuzima izvorni kod, ali je korisno za pregledanje i izmenu koda veÄ‡ preuzete ili razvijene ekstenzije.

## Lista za proveru bezbednosti

Iako Browser ekstenzije imaju **ograniÄenu povrÅ¡inu napada**, neke od njih mogu sadrÅ¾ati **ranjivosti** ili **potencijalna poboljÅ¡anja uÄvrÅ¡Ä‡ivanja**. SledeÄ‡e su najÄeÅ¡Ä‡e:

* [ ] **OgraniÄite** Å¡to je viÅ¡e moguÄ‡e zahtevane **`permissions`**
* [ ] **OgraniÄite** Å¡to je viÅ¡e moguÄ‡e **`host_permissions`**
* [ ] Koristite **jaku** **`content_security_policy`**
* [ ] **OgraniÄite** Å¡to je viÅ¡e moguÄ‡e **`externally_connectable`**, ako nije potrebno i moguÄ‡e, ne ostavljajte ga po defaultu, specificirajte **`{}`**
* [ ] Ako je ovde naveden URL koji je ranjiv na XSS ili preuzimanje kontrole, napadaÄ Ä‡e moÄ‡i da **Å¡alje poruke direktno background skriptama**. Veoma moÄ‡an zaobilazak.
* [ ] **OgraniÄite** Å¡to je viÅ¡e moguÄ‡e **`web_accessible_resources`**, Äak i prazno ako je moguÄ‡e.
* [ ] Ako **`web_accessible_resources`** nije prazno, proverite [**ClickJacking**](browext-clickjacking.md)
* [ ] Ako se vrÅ¡i bilo kakva **komunikacija** izmeÄ‘u **ekstenzije** i **veb stranice**, proverite da li postoje ranjivosti na [**XSS**](browext-xss-example.md) koje su izazvane tom komunikacijom.
* [ ] Ako se koriste Post poruke, proverite [**Post Message ranjivosti**](../postmessage-vulnerabilities/)**.**
* [ ] Ako **Content Script pristupa detaljima DOM-a**, proverite da li oni **ne uvode XSS** ako ih veb stranica **menja**
* [ ] Posebno obratite paÅ¾nju ako je ova komunikacija takoÄ‘e ukljuÄena u **komunikaciju Content Script -> Background skripta**
* [ ] **Osetljive informacije ne bi trebalo da budu smeÅ¡tene** unutar koda Browser ekstenzije
* [ ] **Osetljive informacije ne bi trebalo da budu smeÅ¡tene** unutar memorije Browser ekstenzije

## Alati

### [**Tarnish**](https://thehackerblog.com/tarnish/)

* Preuzima bilo koju Chrome ekstenziju sa datog Chrome webstore linka.
* **manifest.json** preglednik: jednostavno prikazuje JSON-oblikovanu verziju manifesta ekstenzije.
* Analiza otiska prsta: Detekcija [web\_accessible\_resources](https://developer.chrome.com/extensions/manifest/web\_accessible\_resources) i automatsko generisanje JavaScripta za otiskivanje Chrome ekstenzija.
* Analiza potencijalnog Clickjacking-a: Detekcija HTML stranica ekstenzije sa postavljenom direktivom [web\_accessible\_resources](https://developer.chrome.com/extensions/manifest/web\_accessible\_resources). Ove stranice su potencijalno ranjive na clickjacking u zavisnosti od svrhe stranica.
* Preglednik upozorenja o dozvolama: prikazuje listu svih upozorenja o dozvolama u Chrome-u koja Ä‡e biti prikazana prilikom pokuÅ¡aja korisnika da instalira ekstenziju.
* Opasne funkcije: prikazuje lokaciju opasnih funkcija koje bi mogle biti iskoriÅ¡Ä‡ene od strane napadaÄa (npr. funkcije poput innerHTML, chrome.tabs.executeScript).
* Ulazne taÄke: prikazuje gde ekstenzija prima korisniÄke/spoljne ulazne podatke. Ovo je korisno za razumevanje povrÅ¡ine ekstenzije i traÅ¾enje potencijalnih taÄaka za slanje zlonamerno kreiranih podataka ekstenziji.
* Oba skenera, Opasne funkcije i Ulazne taÄke, imaju sledeÄ‡e za generisana upozorenja:
* Relevantan iseÄak koda i linija koja je izazvala upozorenje.
* Opis problema.
* Dugme "PrikaÅ¾i fajl" za pregled celog izvornog fajla koji sadrÅ¾i kod.
* Putanja upozorenog fajla.
* Potpuna Chrome ekstenzija URI upozorenog fajla.
* Vrsta fajla, kao Å¡to je Background Page skripta, Content Script, Browser Action, itd.
* Ako je ranjiva linija u JavaScript fajlu, putanje svih stranica gde je ukljuÄena, kao i status [web\_accessible\_resource](https://developer.chrome.com/extensions/manifest/web\_accessible\_resources) tih stranica.
* Analizator i provera Content Security Policy (CSP): Ovo Ä‡e ukazati na slabosti u CSP vaÅ¡e ekstenzije i takoÄ‘e Ä‡e osvetliti moguÄ‡e naÄine zaobilaÅ¾enja CSP-a zbog belih lista CDN-ova, itd.
* Poznate ranjive biblioteke: Ovo koristi [Retire.js](https://retirejs.github.io/retire.js/) da proveri da li se koristi neka poznata ranjiva JavaScript
* Ako Å¾elite da vidite svoju **kompaniju reklamiranu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu**, pogledajte [**PLANOVE PRETPLATE**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks suveniri**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
