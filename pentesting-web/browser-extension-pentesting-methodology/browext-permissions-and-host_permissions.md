# BrowExt - permiss√µes & host\_permissions

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Informa√ß√µes B√°sicas

### **`permissions`**

As permiss√µes s√£o definidas no arquivo **`manifest.json`** da extens√£o usando a propriedade **`permissions`** e permitem acesso a quase tudo que um navegador pode acessar (Cookies ou Armazenamento F√≠sico):

O manifesto anterior declara que a extens√£o requer a permiss√£o `storage`. Isso significa que ela pode usar [a API de armazenamento](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/storage) para armazenar seus dados de forma persistente. Ao contr√°rio dos cookies ou das APIs `localStorage`, que d√£o aos usu√°rios algum n√≠vel de controle, **o armazenamento da extens√£o normalmente s√≥ pode ser limpo desinstalando a extens√£o**.

Uma extens√£o solicitar√° as permiss√µes indicadas em seu arquivo **`manifest.json`** e, ap√≥s instalar a extens√£o, voc√™ pode **sempre verificar suas permiss√µes no seu navegador**, como mostrado nesta imagem:

<figure><img src="../../.gitbook/assets/image (18).png" alt=""><figcaption></figcaption></figure>

Voc√™ pode encontrar a [**lista completa de permiss√µes que uma Extens√£o do Navegador Chromium pode solicitar aqui**](https://developer.chrome.com/docs/extensions/develop/concepts/declare-permissions#permissions) e uma [**lista completa para extens√µes do Firefox aqui**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#api\_permissions)**.**

### `host_permissions`

A configura√ß√£o opcional, mas poderosa, **`host_permissions`** indica com quais hosts a extens√£o poder√° interagir por meio de APIs como [`cookies`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/cookies), [`webRequest`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/webRequest) e [`tabs`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs).

As seguintes `host_permissions` basicamente permitem todos os web:
```json
"host_permissions": [
"*://*/*"
]

// Or:
"host_permissions": [
"http://*/*",
"https://*/*"
]

// Or:
"host_permissions": [
"<all_urls>"
]
```
Estes s√£o os hosts que a extens√£o do navegador pode acessar livremente. Isso ocorre porque, quando uma extens√£o do navegador chama **`fetch("https://gmail.com/")`**, n√£o est√° restrita pelo CORS.

## Abusando `permissions` e `host_permissions`

### Abas

Al√©m disso, **`host_permissions`** tamb√©m desbloqueia a funcionalidade ‚Äúavan√ßada‚Äù da [**API de abas**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs). Elas permitem que a extens√£o chame [tabs.query()](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/query) e n√£o apenas obtenha uma **lista das abas do navegador do usu√°rio**, mas tamb√©m descubra qual **p√°gina da web (ou seja, endere√ßo e t√≠tulo) est√° carregada**.

{% hint style="danger" %}
N√£o s√≥ isso, ouvintes como [**tabs.onUpdated**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/onUpdated) **se tornam muito mais √∫teis tamb√©m**. Eles ser√£o notificados sempre que uma nova p√°gina for carregada em uma aba.
{% endhint %}

### Executando scripts de conte√∫do <a href="#running-content-scripts" id="running-content-scripts"></a>

Scripts de conte√∫do n√£o precisam ser necessariamente escritos estaticamente no manifesto da extens√£o. Dadas permiss√µes **`host_permissions`** suficientes, **as extens√µes tamb√©m podem carreg√°-los dinamicamente chamando** [**tabs.executeScript()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/executeScript) **ou** [**scripting.executeScript()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/scripting/executeScript).

Ambas as APIs permitem executar n√£o apenas arquivos contidos nas extens√µes como scripts de conte√∫do, mas tamb√©m **c√≥digo arbitr√°rio**. A primeira permite passar c√≥digo JavaScript como uma string, enquanto a √∫ltima espera uma fun√ß√£o JavaScript, que √© menos propensa a vulnerabilidades de inje√ß√£o. No entanto, ambas as APIs causar√£o estragos se forem mal utilizadas.

{% hint style="danger" %}
Al√©m das capacidades acima, scripts de conte√∫do poderiam, por exemplo, **interceptar credenciais** √† medida que s√£o inseridas em p√°ginas da web. Outra maneira cl√°ssica de abusar delas √© **injetar publicidade** em cada site. Adicionar **mensagens de golpe** para abusar da credibilidade de sites de not√≠cias tamb√©m √© poss√≠vel. Finalmente, eles poderiam **manipular sites banc√°rios** para redirecionar transfer√™ncias de dinheiro.
{% endhint %}

### Privil√©gios impl√≠citos <a href="#implicit-privileges" id="implicit-privileges"></a>

Alguns privil√©gios de extens√£o **n√£o precisam ser declarados explicitamente**. Um exemplo √© a [API de abas](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs): sua funcionalidade b√°sica √© acess√≠vel sem quaisquer privil√©gios. Qualquer extens√£o pode ser notificada quando voc√™ abre e fecha abas, mas n√£o saber√° quais sites essas abas correspondem.

Parece inofensivo? A [API tabs.create()](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/create) √© um pouco menos. Ela pode ser usada para **criar uma nova aba**, essencialmente a mesma que [window.open()](https://developer.mozilla.org/en-US/docs/Web/API/Window/open), que pode ser chamada por qualquer site. No entanto, enquanto `window.open()` est√° sujeito ao **bloqueador de pop-ups, `tabs.create()` n√£o est√°**.

{% hint style="danger" %}
Uma extens√£o pode criar qualquer n√∫mero de abas sempre que quiser.
{% endhint %}

Se voc√™ olhar os poss√≠veis par√¢metros de `tabs.create()`, tamb√©m notar√° que suas capacidades v√£o muito al√©m do que `window.open()` pode controlar. E enquanto o Firefox n√£o permite que URIs `data:` sejam usados com esta API, o Chrome n√£o tem tal prote√ß√£o. **O uso de tais URIs no n√≠vel superior foi** [**proibido devido a abusos para phishing**](https://bugzilla.mozilla.org/show\_bug.cgi?id=1331351)**.**

[**tabs.update()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/update) √© muito semelhante a `tabs.create()`, mas **modificar√° uma aba existente**. Assim, uma extens√£o maliciosa pode, por exemplo, carregar arbitrariamente uma p√°gina de publicidade em uma de suas abas e pode ativar a aba correspondente tamb√©m.

### Webcam, geolocaliza√ß√£o e amigos <a href="#webcam-geolocation-and-friends" id="webcam-geolocation-and-friends"></a>

Voc√™ provavelmente sabe que os sites podem solicitar permiss√µes especiais, por exemplo, para acessar sua webcam (ferramentas de videoconfer√™ncia) ou localiza√ß√£o geogr√°fica (mapas). S√£o recursos com consider√°vel potencial para abuso, ent√£o os usu√°rios t√™m que confirmar a cada vez que ainda desejam isso.

{% hint style="danger" %}
N√£o √© assim com extens√µes de navegador. **Se uma extens√£o de navegador** [**quiser acesso √† sua webcam ou microfone**](https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia)**, ela s√≥ precisa pedir permiss√£o uma vez**
{% endhint %}

Normalmente, uma extens√£o far√° isso imediatamente ap√≥s ser instalada. Uma vez que este aviso √© aceito, **o acesso √† webcam √© poss√≠vel a qualquer momento**, mesmo que o usu√°rio n√£o esteja interagindo com a extens√£o neste momento. Sim, um usu√°rio s√≥ aceitar√° este aviso se a extens√£o realmente precisar de acesso √† webcam. Mas depois disso, eles t√™m que confiar na extens√£o para n√£o gravar nada secretamente.

Com acesso √† [sua localiza√ß√£o geogr√°fica exata](https://developer.mozilla.org/en-US/docs/Web/API/Geolocation) ou [conte√∫dos da sua √°rea de transfer√™ncia](https://developer.mozilla.org/en-US/docs/Web/API/Clipboard\_API), conceder permiss√£o explicitamente √© desnecess√°rio. **Uma extens√£o simplesmente adiciona `geolocation` ou `clipboard` √†** [**entrada de permiss√µes**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions) **de seu manifesto**. Esses privil√©gios de acesso s√£o ent√£o concedidos implicitamente quando a extens√£o √© instalada. Assim, uma extens√£o maliciosa ou comprometida com esses privil√©gios pode criar seu perfil de movimento ou monitorar sua √°rea de transfer√™ncia para senhas copiadas sem que voc√™ perceba nada.

Adicionar a palavra-chave **`history`** √† [entrada de permiss√µes](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions) do manifesto da extens√£o concede **acesso √†** [**API de hist√≥rico**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/history). Ela permite recuperar todo o hist√≥rico de navega√ß√£o do usu√°rio de uma s√≥ vez, sem esperar que o usu√°rio visite esses sites novamente.

A **permiss√£o `bookmarks`** tem um potencial de abuso semelhante, pois permite **ler todos os favoritos via a** [**API de favoritos**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/bookmarks).

### Permiss√£o de armazenamento <a href="#the-storage-permission" id="the-storage-permission"></a>

O armazenamento da extens√£o √© apenas uma cole√ß√£o de chave-valor, muito semelhante ao [localStorage](https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage) que qualquer site poderia usar. Portanto, nenhuma informa√ß√£o sens√≠vel deve ser armazenada aqui.

No entanto, empresas de publicidade tamb√©m poderiam abusar desse armazenamento.

### Mais permiss√µes

Voc√™ pode encontrar a [**lista completa de permiss√µes que uma Extens√£o de Navegador Chromium pode solicitar aqui**](https://developer.chrome.com/docs/extensions/develop/concepts/declare-permissions#permissions) e uma [**lista completa para extens√µes Firefox aqui**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#api\_permissions)**.**

## Preven√ß√£o <a href="#why-not-restrict-extension-privileges" id="why-not-restrict-extension-privileges"></a>

A pol√≠tica do desenvolvedor do Google pro√≠be explicitamente extens√µes de solicitar mais privil√©gios do que o necess√°rio para sua funcionalidade, mitigando efetivamente solicita√ß√µes excessivas de permiss√µes. Um exemplo onde uma extens√£o de navegador ultrapassou esse limite envolveu sua distribui√ß√£o com o pr√≥prio navegador, em vez de atrav√©s de uma loja de complementos.

Os navegadores poderiam ainda restringir o uso indevido de privil√©gios de extens√£o. Por exemplo, as APIs [tabCapture](https://developer.chrome.com/docs/extensions/reference/tabCapture/) e [desktopCapture](https://developer.chrome.com/docs/extensions/reference/desktopCapture/) do Chrome, usadas para grava√ß√£o de tela, s√£o projetadas para minimizar abusos. A API tabCapture s√≥ pode ser ativada atrav√©s da intera√ß√£o direta do usu√°rio, como clicar no √≠cone da extens√£o, enquanto desktopCapture requer confirma√ß√£o do usu√°rio para a janela ser gravada, prevenindo atividades de grava√ß√£o clandestina.

No entanto, o endurecimento das medidas de seguran√ßa muitas vezes resulta em menor flexibilidade e facilidade de uso das extens√µes. A [permiss√£o activeTab](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#activetab\_permission) ilustra essa troca. Ela foi introduzida para eliminar a necessidade de extens√µes solicitarem privil√©gios de host em toda a internet, permitindo que extens√µes acessem apenas a aba atual mediante ativa√ß√£o expl√≠cita pelo usu√°rio. Este modelo √© eficaz para extens√µes que requerem a√ß√µes iniciadas pelo usu√°rio, mas falha para aquelas que requerem a√ß√µes autom√°ticas ou preventivas, comprometendo assim a conveni√™ncia e a capacidade de resposta imediata.

## **Refer√™ncias**

* [https://palant.info/2022/08/17/impact-of-extension-privileges/](https://palant.info/2022/08/17/impact-of-extension-privileges/)
* [https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing](https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing)

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-nos no** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}
