# BrowExt - Berechtigungen & host\_permissions

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}

## Grundinformationen

### **`permissions`**

Berechtigungen werden in der **`manifest.json`**-Datei der Erweiterung mit der **`permissions`**-Eigenschaft definiert und erlauben den Zugriff auf fast alles, was ein Browser zugreifen kann (Cookies oder Physischer Speicher):

Das vorherige Manifest erkl√§rt, dass die Erweiterung die `storage`-Berechtigung ben√∂tigt. Das bedeutet, dass sie [die Storage-API](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/storage) verwenden kann, um ihre Daten dauerhaft zu speichern. Im Gegensatz zu Cookies oder `localStorage`-APIs, die den Benutzern ein gewisses Ma√ü an Kontrolle geben, **kann der Erweiterungsspeicher normalerweise nur durch Deinstallieren der Erweiterung gel√∂scht werden**.

Eine Erweiterung wird die in ihrer **`manifest.json`**-Datei angegebenen Berechtigungen anfordern und nach der Installation der Erweiterung kannst du **immer ihre Berechtigungen in deinem Browser √ºberpr√ºfen**, wie in diesem Bild gezeigt:

<figure><img src="../../.gitbook/assets/image (18).png" alt=""><figcaption></figcaption></figure>

Du kannst die [**vollst√§ndige Liste der Berechtigungen, die eine Chromium-Browsererweiterung anfordern kann, hier finden**](https://developer.chrome.com/docs/extensions/develop/concepts/declare-permissions#permissions) und eine [**vollst√§ndige Liste f√ºr Firefox-Erweiterungen hier**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#api\_permissions)**.**

### `host_permissions`

Die optionale, aber leistungsstarke Einstellung **`host_permissions`** gibt an, mit welchen Hosts die Erweiterung √ºber APIs wie [`cookies`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/cookies), [`webRequest`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/webRequest) und [`tabs`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs) interagieren kann.

Die folgenden `host_permissions` erlauben im Grunde genommen jeden Web:
```json
"host_permissions": [
"*://*/*"
]

// Or:
"host_permissions": [
"http://*/*",
"https://*/*"
]

// Or:
"host_permissions": [
"<all_urls>"
]
```
Diese sind die Hosts, auf die die Browsererweiterung frei zugreifen kann. Das liegt daran, dass eine Browsererweiterung, wenn sie **`fetch("https://gmail.com/")`** aufruft, nicht durch CORS eingeschr√§nkt ist.

## Missbrauch von `permissions` und `host_permissions`

### Tabs

Dar√ºber hinaus schaltet **`host_permissions`** auch ‚Äûerweiterte‚Äú [**tabs API**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs) **Funktionalit√§ten frei.** Sie erm√∂glichen es der Erweiterung, [tabs.query()](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/query) aufzurufen und nicht nur eine **Liste der Browser-Tabs des Benutzers** zur√ºckzubekommen, sondern auch zu erfahren, welche **Webseite (d.h. Adresse und Titel) geladen ist**.

{% hint style="danger" %}
Nicht nur das, Listener wie [**tabs.onUpdated**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/onUpdated) **werden ebenfalls viel n√ºtzlicher.** Diese werden benachrichtigt, wann immer eine neue Seite in einen Tab geladen wird.
{% endhint %}

### Ausf√ºhren von Inhalts-Skripten <a href="#running-content-scripts" id="running-content-scripts"></a>

Inhalts-Skripte sind nicht unbedingt statisch im Manifest der Erweiterung geschrieben. Bei ausreichenden **`host_permissions`** k√∂nnen **Erweiterungen sie auch dynamisch laden, indem sie** [**tabs.executeScript()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/executeScript) **oder** [**scripting.executeScript()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/scripting/executeScript) **aufrufen.**

Beide APIs erm√∂glichen das Ausf√ºhren nicht nur von in den Erweiterungen enthaltenen Dateien als Inhalts-Skripte, sondern auch von **beliebigem Code**. Die erste erlaubt das √úbergeben von JavaScript-Code als String, w√§hrend die zweite eine JavaScript-Funktion erwartet, die weniger anf√§llig f√ºr Injektionsanf√§lligkeiten ist. Dennoch k√∂nnen beide APIs Chaos anrichten, wenn sie missbraucht werden.

{% hint style="danger" %}
Zus√§tzlich zu den oben genannten F√§higkeiten k√∂nnten Inhalts-Skripte beispielsweise **Anmeldeinformationen abfangen**, w√§hrend diese in Webseiten eingegeben werden. Eine weitere klassische M√∂glichkeit, sie zu missbrauchen, besteht darin, **Werbung** auf jeder einzelnen Webseite einzuf√ºgen. Das Hinzuf√ºgen von **Betrugsnachrichten**, um die Glaubw√ºrdigkeit von Nachrichtenwebseiten zu missbrauchen, ist ebenfalls m√∂glich. Schlie√ülich k√∂nnten sie **Bank-Webseiten manipulieren**, um Geldtransfers umzuleiten.
{% endhint %}

### Implizite Berechtigungen <a href="#implicit-privileges" id="implicit-privileges"></a>

Einige Erweiterungsberechtigungen **m√ºssen nicht ausdr√ºcklich deklariert werden**. Ein Beispiel ist die [tabs API](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs): Ihre grundlegende Funktionalit√§t ist ohne jegliche Berechtigungen zug√§nglich. Jede Erweiterung kann benachrichtigt werden, wenn Sie Tabs √∂ffnen und schlie√üen, sie wird jedoch nicht wissen, mit welcher Webseite diese Tabs √ºbereinstimmen.

Klingt zu harmlos? Die [tabs.create() API](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/create) ist etwas weniger harmlos. Sie kann verwendet werden, um **einen neuen Tab zu erstellen**, was im Wesentlichen dasselbe ist wie [window.open()](https://developer.mozilla.org/en-US/docs/Web/API/Window/open), das von jeder Webseite aufgerufen werden kann. W√§hrend `window.open()` jedoch dem **Pop-up-Blocker unterliegt, tut dies `tabs.create()` nicht**.

{% hint style="danger" %}
Eine Erweiterung kann jederzeit beliebig viele Tabs erstellen.
{% endhint %}

Wenn Sie sich die m√∂glichen `tabs.create()`-Parameter ansehen, werden Sie auch feststellen, dass ihre F√§higkeiten weit √ºber das hinausgehen, was `window.open()` kontrollieren darf. Und w√§hrend Firefox die Verwendung von `data:` URIs mit dieser API nicht zul√§sst, hat Chrome keinen solchen Schutz. **Die Verwendung solcher URIs auf der obersten Ebene wurde** [**wegen Missbrauchs f√ºr Phishing**](https://bugzilla.mozilla.org/show\_bug.cgi?id=1331351)**verboten.**

[**tabs.update()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/update) ist sehr √§hnlich wie `tabs.create()`, wird jedoch **einen bestehenden Tab modifizieren**. Eine b√∂sartige Erweiterung kann beispielsweise willk√ºrlich eine Werbeseite in einen Ihrer Tabs laden und den entsprechenden Tab ebenfalls aktivieren.

### Webcam, Geolokalisierung und Freunde <a href="#webcam-geolocation-and-friends" id="webcam-geolocation-and-friends"></a>

Sie wissen wahrscheinlich, dass Webseiten spezielle Berechtigungen anfordern k√∂nnen, z.B. um auf Ihre Webcam (Videokonferenz-Tools) oder geografische Lage (Karten) zuzugreifen. Es sind Funktionen mit erheblichem Missbrauchspotenzial, sodass die Benutzer jedes Mal best√§tigen m√ºssen, dass sie dies weiterhin m√∂chten.

{% hint style="danger" %}
Nicht so bei Browsererweiterungen. **Wenn eine Browsererweiterung** [**Zugriff auf Ihre Webcam oder Ihr Mikrofon**](https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia)**w√ºnscht, muss sie nur einmal um Erlaubnis fragen.**
{% endhint %}

Typischerweise wird eine Erweiterung dies sofort nach der Installation tun. Sobald diese Aufforderung akzeptiert wird, **ist der Webcam-Zugriff jederzeit m√∂glich**, selbst wenn der Benutzer zu diesem Zeitpunkt nicht mit der Erweiterung interagiert. Ja, ein Benutzer wird diese Aufforderung nur akzeptieren, wenn die Erweiterung wirklich auf die Webcam zugreifen muss. Aber danach m√ºssen sie der Erweiterung vertrauen, dass sie nichts heimlich aufzeichnet.

Mit Zugriff auf [Ihren genauen geografischen Standort](https://developer.mozilla.org/en-US/docs/Web/API/Geolocation) oder [Inhalte Ihrer Zwischenablage](https://developer.mozilla.org/en-US/docs/Web/API/Clipboard\_API) ist es √ºberhaupt nicht notwendig, die Erlaubnis ausdr√ºcklich zu erteilen. **Eine Erweiterung f√ºgt einfach `geolocation` oder `clipboard` zu dem** [**permissions entry**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions) **ihres Manifests hinzu.** Diese Zugriffsberechtigungen werden dann implizit gew√§hrt, wenn die Erweiterung installiert wird. Eine b√∂sartige oder kompromittierte Erweiterung mit diesen Berechtigungen kann Ihr Bewegungsprofil erstellen oder Ihre Zwischenablage auf kopierte Passw√∂rter √ºberwachen, ohne dass Sie etwas bemerken.

Das Hinzuf√ºgen des **`history`**-Schl√ºsselworts zum [permissions entry](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions) des Erweiterungsmanifests gew√§hrt **Zugriff auf die** [**history API**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/history). Es erm√∂glicht das Abrufen des gesamten Browserverlaufs des Benutzers auf einmal, ohne darauf zu warten, dass der Benutzer diese Webseiten erneut besucht.

Die **`bookmarks`** **Berechtigung** hat ein √§hnliches Missbrauchspotenzial, da sie **das Auslesen aller Lesezeichen √ºber die** [**bookmarks API**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/bookmarks) erm√∂glicht.

### Speicherberechtigung <a href="#the-storage-permission" id="the-storage-permission"></a>

Der Erweiterungsspeicher ist lediglich eine Schl√ºssel-Wert-Sammlung, sehr √§hnlich wie [localStorage](https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage), die jede Webseite verwenden k√∂nnte. Daher sollten hier keine sensiblen Informationen gespeichert werden.

Allerdings k√∂nnten Werbefirmen auch diesen Speicher missbrauchen.

### Weitere Berechtigungen

Sie finden die [**vollst√§ndige Liste der Berechtigungen, die eine Chromium-Browsererweiterung anfordern kann, hier**](https://developer.chrome.com/docs/extensions/develop/concepts/declare-permissions#permissions) und eine [**vollst√§ndige Liste f√ºr Firefox-Erweiterungen hier**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#api\_permissions)**.**

## Pr√§vention <a href="#why-not-restrict-extension-privileges" id="why-not-restrict-extension-privileges"></a>

Die Richtlinie von Googles Entwickler verbietet ausdr√ºcklich, dass Erweiterungen mehr Berechtigungen anfordern, als f√ºr ihre Funktionalit√§t erforderlich sind, wodurch √ºberm√§√üige Berechtigungsanfragen effektiv gemildert werden. Ein Beispiel, bei dem eine Browsererweiterung diese Grenze √ºberschritt, war ihre Verteilung mit dem Browser selbst anstelle √ºber einen Add-On-Store.

Browser k√∂nnten den Missbrauch von Erweiterungsberechtigungen weiter eind√§mmen. Beispielsweise sind die [tabCapture](https://developer.chrome.com/docs/extensions/reference/tabCapture/)- und [desktopCapture](https://developer.chrome.com/docs/extensions/reference/desktopCapture/)-APIs von Chrome, die f√ºr die Bildschirmaufnahme verwendet werden, darauf ausgelegt, Missbrauch zu minimieren. Die tabCapture-API kann nur durch direkte Benutzerinteraktion aktiviert werden, z.B. durch Klicken auf das Erweiterungssymbol, w√§hrend desktopCapture die Best√§tigung des Benutzers f√ºr das Aufzeichnen des Fensters erfordert, um heimliche Aufnahmeaktivit√§ten zu verhindern.

Allerdings f√ºhren striktere Sicherheitsma√ünahmen oft zu einer verringerten Flexibilit√§t und Benutzerfreundlichkeit von Erweiterungen. Die [activeTab-Berechtigung](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#activetab\_permission) veranschaulicht diesen Kompromiss. Sie wurde eingef√ºhrt, um die Notwendigkeit zu beseitigen, dass Erweiterungen Hostberechtigungen im gesamten Internet anfordern, sodass Erweiterungen nur auf den aktuellen Tab zugreifen k√∂nnen, wenn der Benutzer dies ausdr√ºcklich aktiviert. Dieses Modell ist effektiv f√ºr Erweiterungen, die benutzerinitiierte Aktionen erfordern, versagt jedoch bei denen, die automatische oder pr√§ventive Aktionen ben√∂tigen, wodurch Bequemlichkeit und sofortige Reaktionsf√§higkeit beeintr√§chtigt werden.

## **Referenzen**

* [https://palant.info/2022/08/17/impact-of-extension-privileges/](https://palant.info/2022/08/17/impact-of-extension-privileges/)
* [https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing](https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing)

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
