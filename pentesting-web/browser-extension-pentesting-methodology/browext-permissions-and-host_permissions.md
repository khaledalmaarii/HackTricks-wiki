# BrowExt - uprawnienia i host\_permissions

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na githubie.

</details>

## Podstawowe informacje

### **`permissions`**

Uprawnienia sÄ… okreÅ›lane w pliku **`manifest.json`** rozszerzenia za pomocÄ… wÅ‚aÅ›ciwoÅ›ci **`permissions`** i pozwalajÄ… na dostÄ™p do praktycznie wszystkiego, do czego moÅ¼e uzyskaÄ‡ dostÄ™p przeglÄ…darka (Ciasteczka lub PamiÄ™Ä‡ fizycznÄ…):

Poprzedni manifest deklaruje, Å¼e rozszerzenie wymaga uprawnienia `storage`. Oznacza to, Å¼e moÅ¼e korzystaÄ‡ z [API pamiÄ™ci](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/storage), aby przechowywaÄ‡ swoje dane trwale. W przeciwieÅ„stwie do ciasteczek lub API `localStorage`, ktÃ³re dajÄ… uÅ¼ytkownikom pewien poziom kontroli, **pamiÄ™Ä‡ rozszerzenia zazwyczaj moÅ¼na wyczyÅ›ciÄ‡ tylko poprzez odinstalowanie rozszerzenia**.

Rozszerzenie bÄ™dzie prosiÄ‡ o uprawnienia wskazane w swoim pliku **`manifest.json`** i Po zainstalowaniu rozszerzenia, zawsze moÅ¼esz **sprawdziÄ‡ jego uprawnienia w przeglÄ…darce**, jak pokazano na tym obrazie:

<figure><img src="../../.gitbook/assets/image (15).png" alt=""><figcaption></figcaption></figure>

MoÅ¼esz znaleÅºÄ‡ [**peÅ‚nÄ… listÄ™ uprawnieÅ„, ktÃ³re rozszerzenie przeglÄ…darki Chromium moÅ¼e zaÅ¼Ä…daÄ‡ tutaj**](https://developer.chrome.com/docs/extensions/develop/concepts/declare-permissions#permissions) oraz [**peÅ‚nÄ… listÄ™ dla rozszerzeÅ„ Firefox tutaj**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#api\_permissions)**.**

### `host_permissions`

Opcjonalne, ale potÄ™Å¼ne ustawienie **`host_permissions`** wskazuje, z ktÃ³rymi hostami rozszerzenie bÄ™dzie mogÅ‚o wspÃ³Å‚dziaÅ‚aÄ‡ za pomocÄ… interfejsÃ³w takich jak [`cookies`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/cookies), [`webRequest`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/webRequest) i [`tabs`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs).

NastÄ™pujÄ…ce `host_permissions` zasadniczo pozwalajÄ… na kaÅ¼dÄ… stronÄ™ internetowÄ…:
```json
"host_permissions": [
"*://*/*"
]

// Or:
"host_permissions": [
"http://*/*",
"https://*/*"
]

// Or:
"host_permissions": [
"<all_urls>"
]
```
To sÄ… hosty, do ktÃ³rych rozszerzenie przeglÄ…darki moÅ¼e uzyskaÄ‡ swobodny dostÄ™p. Dzieje siÄ™ tak, poniewaÅ¼ gdy rozszerzenie przeglÄ…darki wywoÅ‚uje **`fetch("https://gmail.com/")`**, nie jest ograniczone przez CORS.

## NaduÅ¼ywanie `permissions` i `host_permissions`

### Karty

Ponadto **`host_permissions`** odblokowujÄ… rÃ³wnieÅ¼ "zaawansowane" [**API kart**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs). PozwalajÄ… one rozszerzeniu wywoÅ‚aÄ‡ [tabs.query()](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/query) i nie tylko otrzymaÄ‡ z powrotem **listÄ™ kart przeglÄ…darki uÅ¼ytkownika**, ale takÅ¼e dowiedzieÄ‡ siÄ™, ktÃ³ra **strona internetowa (oznaczajÄ…ca adres i tytuÅ‚) jest zaÅ‚adowana**.

{% hint style="danger" %}
Nie tylko to, sÅ‚uchacze takie jak [**tabs.onUpdated**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/onUpdated) **stajÄ… siÄ™ rÃ³wnieÅ¼ znacznie bardziej uÅ¼yteczne**. ZostanÄ… powiadomieni za kaÅ¼dym razem, gdy nowa strona zostanie zaÅ‚adowana do karty.
{% endhint %}

### Uruchamianie skryptÃ³w zawartoÅ›ci <a href="#running-content-scripts" id="running-content-scripts"></a>

Skrypty zawartoÅ›ci nie muszÄ… byÄ‡ pisane statycznie w manifeÅ›cie rozszerzenia. DziÄ™ki wystarczajÄ…cym **`host_permissions`**, **rozszerzenia mogÄ… rÃ³wnieÅ¼ Å‚adowaÄ‡ je dynamicznie, wywoÅ‚ujÄ…c** [**tabs.executeScript()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/executeScript) **lub** [**scripting.executeScript()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/scripting/executeScript).

Oba interfejsy API pozwalajÄ… na wykonanie nie tylko plikÃ³w zawartych w rozszerzeniach jako skrypty zawartoÅ›ci, ale takÅ¼e **dowolnego kodu**. Pierwszy pozwala na przekazywanie kodu JavaScript jako ciÄ…gu znakÃ³w, podczas gdy drugi oczekuje funkcji JavaScript, ktÃ³ra jest mniej podatna na podatnoÅ›ci zwiÄ…zane z wstrzykiwaniem. Niemniej jednak, oba interfejsy API spowodujÄ… spustoszenie w przypadku niewÅ‚aÅ›ciwego uÅ¼ycia.

{% hint style="danger" %}
OprÃ³cz powyÅ¼szych moÅ¼liwoÅ›ci, skrypty zawartoÅ›ci mogÄ… na przykÅ‚ad **przechwytywaÄ‡ dane uwierzytelniajÄ…ce**, gdy sÄ… wprowadzane na strony internetowe. Inny klasyczny sposÃ³b naduÅ¼ycia polega na **wstrzykiwaniu reklam** na kaÅ¼dej stronie internetowej. Dodawanie **oszukaÅ„czych wiadomoÅ›ci** w celu naduÅ¼ycia wiarygodnoÅ›ci stron informacyjnych jest rÃ³wnieÅ¼ moÅ¼liwe. Wreszcie, mogÄ… **manipulowaÄ‡ stronami bankowymi**, aby przekierowaÄ‡ transfery pieniÄ™Å¼ne.
{% endhint %}

### Impliityczne uprawnienia <a href="#implicit-privileges" id="implicit-privileges"></a>

NiektÃ³re uprawnienia rozszerzenia **nie muszÄ… byÄ‡ wyraÅºnie deklarowane**. PrzykÅ‚adem jest [API kart](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs): jego podstawowa funkcjonalnoÅ›Ä‡ jest dostÄ™pna bez Å¼adnych uprawnieÅ„. KaÅ¼de rozszerzenie moÅ¼e byÄ‡ powiadamiane, gdy otwierasz i zamykasz karty, po prostu nie bÄ™dzie wiedzieÄ‡, z jakÄ… stronÄ… internetowÄ… te karty siÄ™ wiÄ…Å¼Ä….

Brzmi zbyt niewinnie? [API tabs.create()](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/create) jest nieco mniej niewinne. MoÅ¼e byÄ‡ uÅ¼ywane do **utworzenia nowej karty**, zasadniczo to samo co [window.open()](https://developer.mozilla.org/en-US/docs/Web/API/Window/open), ktÃ³re moÅ¼e byÄ‡ wywoÅ‚ywane przez dowolnÄ… stronÄ™ internetowÄ…. Jednak podczas gdy `window.open()` podlega **blokerowi wyskakujÄ…cych okien, `tabs.create()` nie**.

{% hint style="danger" %}
Rozszerzenie moÅ¼e tworzyÄ‡ dowolnÄ… liczbÄ™ kart w dowolnym momencie.
{% endhint %}

JeÅ›li przejrzysz moÅ¼liwe parametry `tabs.create()`, zauwaÅ¼ysz rÃ³wnieÅ¼, Å¼e jego moÅ¼liwoÅ›ci wykraczajÄ… daleko poza to, co moÅ¼e kontrolowaÄ‡ `window.open()`. I podczas gdy Firefox nie zezwala na uÅ¼ycie adresÃ³w `data:` URI z tym interfejsem API, Chrome nie ma takiej ochrony. **UÅ¼ycie takich URI na najwyÅ¼szym poziomie zostaÅ‚o** [**zakazane ze wzglÄ™du na naduÅ¼ycia w celu phishingu**](https://bugzilla.mozilla.org/show\_bug.cgi?id=1331351)**.**

[**tabs.update()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/update) jest bardzo podobne do `tabs.create()`, ale **zmodyfikuje istniejÄ…cÄ… kartÄ™**. ZÅ‚oÅ›liwe rozszerzenie moÅ¼e na przykÅ‚ad dowolnie zaÅ‚adowaÄ‡ stronÄ™ z reklamami do jednej z twoich kart i aktywowaÄ‡ odpowiedniÄ… kartÄ™.

### Kamera internetowa, geolokalizacja i przyjaciele <a href="#webcam-geolocation-and-friends" id="webcam-geolocation-and-friends"></a>

Prawdopodobnie wiesz, Å¼e strony internetowe mogÄ… prosiÄ‡ o specjalne uprawnienia, np. w celu uzyskania dostÄ™pu do kamery internetowej (narzÄ™dzia do wideokonferencji) lub lokalizacji geograficznej (mapy). SÄ… to funkcje z duÅ¼ym potencjaÅ‚em naduÅ¼yÄ‡, dlatego uÅ¼ytkownicy muszÄ… za kaÅ¼dym razem potwierdzaÄ‡, czy nadal chcÄ… to zrobiÄ‡.

{% hint style="danger" %}
Nie w przypadku rozszerzeÅ„ przeglÄ…darki. **JeÅ›li rozszerzenie przeglÄ…darki** [**chce uzyskaÄ‡ dostÄ™p do twojej kamery internetowej lub mikrofonu**](https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia)**, musi poprosiÄ‡ o zgodÄ™ tylko raz**
{% endhint %}

Zazwyczaj rozszerzenie zrobi to natychmiast po zainstalowaniu. Po zaakceptowaniu tego monitu, **dostÄ™p do kamery internetowej jest moÅ¼liwy w dowolnym momencie**, nawet jeÅ›li uÅ¼ytkownik nie korzysta w tym momencie z rozszerzenia. Tak, uÅ¼ytkownik zaakceptuje ten monit tylko wtedy, gdy rozszerzenie naprawdÄ™ potrzebuje dostÄ™pu do kamery internetowej. Ale potem muszÄ… zaufaÄ‡ rozszerzeniu, Å¼e nie bÄ™dzie nagrywaÄ‡ niczego w tajemnicy.

DziÄ™ki dostÄ™powi do [twojej dokÅ‚adnej lokalizacji geograficznej](https://developer.mozilla.org/en-US/docs/Web/API/Geolocation) lub [zawartoÅ›ci schowka](https://developer.mozilla.org/en-US/docs/Web/API/Clipboard\_API), udzielenie zgody jest caÅ‚kowicie zbÄ™dne. **Rozszerzenie po prostu dodaje `geolocation` lub `clipboard` do** [**wpisu uprawnieÅ„**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions) **w swoim manifeÅ›cie**. Te uprawnienia dostÄ™pu sÄ… udzielane w sposÃ³b domyÅ›lny podczas instalacji rozszerzenia. Dlatego zÅ‚oÅ›liwe lub skompromitowane rozszerzenie z tymi uprawnieniami moÅ¼e tworzyÄ‡ twÃ³j profil ruchu lub monitorowaÄ‡ schowek w poszukiwaniu skopiowanych haseÅ‚ bez twojej wiedzy.

Dodanie sÅ‚owa kluczowego **`history`** do [wpisu uprawnieÅ„](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions) w manifeÅ›cie rozszerzenia udziela dostÄ™pu do [API historii](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/history). Pozwala to na pobranie caÅ‚ej historii przeglÄ…dania uÅ¼ytkownika od razu, bez koniecznoÅ›ci oczekiwania, aÅ¼ uÅ¼ytkownik odwiedzi te strony internetowe ponownie.

Uprawnienie **`bookmarks`** ma podobny potencjaÅ‚ naduÅ¼ycia, umoÅ¼liwia ono **odczytywanie wszystkich zakÅ‚adek za pomocÄ…** [**API zakÅ‚adek**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/bookmarks).

### Uprawnienie do przechowywania <a href="#the-storage-permission" id="the-storage-permission"></a>

Przechowywanie rozszerzenia to zbiÃ³r kluczy i wartoÅ›ci, bardzo podobny do [localStorage](https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage), ktÃ³rego mogÅ‚aby uÅ¼yÄ‡ dowolna strona internetowa. Dlatego tutaj nie powinny byÄ‡ przechowywane Å¼adne poufne informacje.

Jednak firmy reklamowe mogÄ… rÃ³wnieÅ¼ naduÅ¼ywaÄ‡ tego przechowywania.

### WiÄ™cej uprawnieÅ„

MoÅ¼esz znaleÅºÄ‡ [**peÅ‚nÄ… listÄ™ uprawnieÅ„, ktÃ³re rozszerzenie przeglÄ…darki Chromium moÅ¼e Å¼Ä…daÄ‡ tutaj**](https://developer.chrome.com/docs/extensions/develop/concepts/declare-permissions#permissions) oraz [**peÅ‚nÄ… listÄ™ dla rozszerzeÅ„ Firefox tutaj**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#api\_permissions)**.**

## Zapobieganie <a href="#why-not-restrict-extension-privileges" id="why-not-restrict-extension-privileges"></a>

Polityka dewelopera Google wyraÅºnie zabrania rozszerzeniom Å¼Ä…dania wiÄ™kszej liczby uprawnieÅ„ niÅ¼ jest to konieczne dla ich funkcjonalnoÅ›ci, skutecznie ograniczajÄ…c nadmierne Å¼Ä…dania uprawnieÅ„. PrzykÅ‚adem, gdzie rozszerzenie przeglÄ…darki przekroczyÅ‚o tÄ™ granicÄ™, byÅ‚o jego dystrybuowanie razem z przeglÄ…darkÄ…, a nie poprzez sklep z dodatkami.

PrzeglÄ…darki mogÅ‚yby dalej ograniczyÄ‡ naduÅ¼ycia uprawnieÅ„ rozszerzeÅ„. Na przykÅ‚ad API [tabCapture](https://developer.chrome.com/docs/extensions/reference/tabCapture/) i [desktopCapture](https://developer.chrome.com/docs/extensions/reference/desktopCapture/) w Chrome, uÅ¼ywane do nagrywania ekranu, zostaÅ‚y zaprojektowane w taki sposÃ³b, aby minimalizowaÄ‡ naduÅ¼ycia. API tabCapture moÅ¼e byÄ‡ aktywowane tylko poprzez bezpoÅ›redniÄ… interakcjÄ™ uÅ¼ytkownika, takÄ… jak klikniÄ™cie w ikonÄ™ rozszerzenia, podczas gdy desktopCapture wymaga potwierdzenia uÅ¼ytkownika, aby okno zostaÅ‚o nagrane, zapobiegajÄ…c tajnemu nagrywaniu dziaÅ‚aÅ„.

JednakÅ¼e, zaostrzenie Å›rodkÃ³w bezpieczeÅ„stwa czÄ™sto prowadzi do zmniejszenia elastycznoÅ›ci i przyjaznoÅ›ci dla uÅ¼ytkownika rozszerzeÅ„. [Uprawnienie activeTab](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#activetab\_permission) ilustruje ten kompromis. ZostaÅ‚o wprowadzone, aby wyeliminowaÄ‡ koniecznoÅ›Ä‡ Å¼Ä…dania uprawnieÅ„ hosta w caÅ‚ym internecie przez rozszerzenia, pozwalajÄ…c rozszerzeniom uzyskaÄ‡ dostÄ™p tylko do bieÅ¼Ä…cej karty po wyraÅºnym aktywowaniu przez uÅ¼ytkownika. Ten model jest skuteczny dla rozszerzeÅ„ wymagajÄ…cych dziaÅ‚aÅ„ inicjowanych przez uÅ¼ytkownika, ale nie wystarcza dla tych wymagajÄ…cych dziaÅ‚aÅ„ automatycznych lub prewencyjnych, co kompromituje wygodÄ™ i natychmiastowÄ… reakcjÄ™.
## **Referencje**

* [https://palant.info/2022/08/17/impact-of-extension-privileges/](https://palant.info/2022/08/17/impact-of-extension-privileges/)
* [https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing](https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing)

<details>

<summary><strong>Zacznij od zera i zostaÅ„ mistrzem hakowania AWS dziÄ™ki</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
