# BrowExt - permissions & host\_permissions

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

### **`permissions`**

Les permissions sont d√©finies dans le fichier **`manifest.json`** de l'extension en utilisant la propri√©t√© **`permissions`** et permettent l'acc√®s √† presque tout ce qu'un navigateur peut acc√©der (Cookies ou Stockage Physique) :

Le manifeste pr√©c√©dent d√©clare que l'extension n√©cessite la permission `storage`. Cela signifie qu'elle peut utiliser [l'API de stockage](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/storage) pour stocker ses donn√©es de mani√®re persistante. Contrairement aux cookies ou aux APIs `localStorage` qui donnent aux utilisateurs un certain niveau de contr√¥le, **le stockage des extensions ne peut normalement √™tre effac√© qu'en d√©sinstallant l'extension**.

Une extension demandera les permissions indiqu√©es dans son fichier **`manifest.json`** et apr√®s l'installation de l'extension, vous pouvez **toujours v√©rifier ses permissions dans votre navigateur**, comme le montre cette image :

<figure><img src="../../.gitbook/assets/image (18).png" alt=""><figcaption></figcaption></figure>

Vous pouvez trouver la [**liste compl√®te des permissions qu'une extension de navigateur Chromium peut demander ici**](https://developer.chrome.com/docs/extensions/develop/concepts/declare-permissions#permissions) et une [**liste compl√®te pour les extensions Firefox ici**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#api\_permissions)**.**

### `host_permissions`

Le param√®tre optionnel mais puissant **`host_permissions`** indique avec quels h√¥tes l'extension pourra interagir via des APIs telles que [`cookies`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/cookies), [`webRequest`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/webRequest), et [`tabs`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs).

Les `host_permissions` suivants permettent essentiellement d'acc√©der √† tous les sites web :
```json
"host_permissions": [
"*://*/*"
]

// Or:
"host_permissions": [
"http://*/*",
"https://*/*"
]

// Or:
"host_permissions": [
"<all_urls>"
]
```
Ces h√¥tes sont ceux auxquels l'extension de navigateur peut acc√©der librement. Cela est d√ª au fait qu'une extension de navigateur qui appelle **`fetch("https://gmail.com/")`** n'est pas restreinte par CORS.

## Abus de `permissions` et `host_permissions`

### Onglets

De plus, **`host_permissions`** d√©verrouille √©galement la fonctionnalit√© "avanc√©e" de l'[**API tabs**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs). Elles permettent √† l'extension d'appeler [tabs.query()](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/query) et non seulement d'obtenir une **liste des onglets du navigateur de l'utilisateur**, mais aussi de savoir quelle **page web (c'est-√†-dire l'adresse et le titre) est charg√©e**.

{% hint style="danger" %}
Non seulement cela, mais des √©couteurs comme [**tabs.onUpdated**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/onUpdated) **deviendront √©galement beaucoup plus utiles**. Ceux-ci seront notifi√©s chaque fois qu'une nouvelle page se charge dans un onglet.
{% endhint %}

### Ex√©cution de scripts de contenu <a href="#running-content-scripts" id="running-content-scripts"></a>

Les scripts de contenu ne sont pas n√©cessairement √©crits statiquement dans le manifeste de l'extension. Avec des **`host_permissions`** suffisants, **les extensions peuvent √©galement les charger dynamiquement en appelant** [**tabs.executeScript()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/executeScript) **ou** [**scripting.executeScript()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/scripting/executeScript).

Les deux API permettent d'ex√©cuter non seulement des fichiers contenus dans les extensions en tant que scripts de contenu, mais aussi **du code arbitraire**. La premi√®re permet de passer du code JavaScript sous forme de cha√Æne, tandis que la seconde attend une fonction JavaScript qui est moins sujette aux vuln√©rabilit√©s d'injection. Cependant, les deux API peuvent causer des ravages si elles sont mal utilis√©es.

{% hint style="danger" %}
En plus des capacit√©s ci-dessus, les scripts de contenu pourraient par exemple **intercepter des identifiants** au fur et √† mesure qu'ils sont saisis sur des pages web. Une autre fa√ßon classique de les abuser est **d'injecter de la publicit√©** sur chaque site web. Ajouter des **messages d'escroquerie** pour abuser de la cr√©dibilit√© des sites d'actualit√©s est √©galement possible. Enfin, ils pourraient **manipuler des sites bancaires** pour rediriger des transferts d'argent.
{% endhint %}

### Privil√®ges implicites <a href="#implicit-privileges" id="implicit-privileges"></a>

Certains privil√®ges d'extension **n'ont pas besoin d'√™tre d√©clar√©s explicitement**. Un exemple est l'[API tabs](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs) : sa fonctionnalit√© de base est accessible sans aucun privil√®ge. Toute extension peut √™tre notifi√©e lorsque vous ouvrez et fermez des onglets, elle ne saura simplement pas avec quel site web ces onglets correspondent.

Cela semble trop inoffensif ? L'[API tabs.create()](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/create) l'est un peu moins. Elle peut √™tre utilis√©e pour **cr√©er un nouvel onglet**, essentiellement la m√™me chose que [window.open()](https://developer.mozilla.org/en-US/docs/Web/API/Window/open) qui peut √™tre appel√©e par n'importe quel site web. Pourtant, alors que `window.open()` est soumis au **bloqueur de pop-ups, `tabs.create()` ne l'est pas**.

{% hint style="danger" %}
Une extension peut cr√©er n'importe quel nombre d'onglets quand elle le souhaite.
{% endhint %}

Si vous examinez les param√®tres possibles de `tabs.create()`, vous remarquerez √©galement que ses capacit√©s vont bien au-del√† de ce que `window.open()` est autoris√© √† contr√¥ler. Et bien que Firefox n'autorise pas l'utilisation de URI `data:` avec cette API, Chrome n'a pas cette protection. **L'utilisation de telles URI au niveau sup√©rieur a √©t√©** [**interdite en raison d'abus pour le phishing**](https://bugzilla.mozilla.org/show\_bug.cgi?id=1331351)**.**

[**tabs.update()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/update) est tr√®s similaire √† `tabs.create()` mais va **modifier un onglet existant**. Ainsi, une extension malveillante peut par exemple charger arbitrairement une page publicitaire dans l'un de vos onglets, et elle peut √©galement activer l'onglet correspondant.

### Webcam, g√©olocalisation et amis <a href="#webcam-geolocation-and-friends" id="webcam-geolocation-and-friends"></a>

Vous savez probablement que les sites web peuvent demander des autorisations sp√©ciales, par exemple pour acc√©der √† votre webcam (outils de visioconf√©rence) ou √† votre localisation g√©ographique (cartes). Ce sont des fonctionnalit√©s avec un potentiel d'abus consid√©rable, donc les utilisateurs doivent chaque fois confirmer qu'ils souhaitent toujours cela.

{% hint style="danger" %}
Ce n'est pas le cas avec les extensions de navigateur. **Si une extension de navigateur** [**veut acc√©der √† votre webcam ou microphone**](https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia)**, elle n'a besoin de demander la permission qu'une seule fois**
{% endhint %}

Typiquement, une extension le fera imm√©diatement apr√®s son installation. Une fois cette invite accept√©e, **l'acc√®s √† la webcam est possible √† tout moment**, m√™me si l'utilisateur n'interagit pas avec l'extension √† ce moment-l√†. Oui, un utilisateur n'acceptera cette invite que si l'extension a vraiment besoin d'acc√©der √† la webcam. Mais apr√®s cela, il doit faire confiance √† l'extension pour ne rien enregistrer secr√®tement.

Avec l'acc√®s √† [votre localisation g√©ographique exacte](https://developer.mozilla.org/en-US/docs/Web/API/Geolocation) ou [au contenu de votre presse-papiers](https://developer.mozilla.org/en-US/docs/Web/API/Clipboard\_API), accorder la permission explicitement est totalement inutile. **Une extension ajoute simplement `geolocation` ou `clipboard` √† l'** [**entr√©e de permissions**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions) **de son manifeste**. Ces privil√®ges d'acc√®s sont ensuite accord√©s implicitement lorsque l'extension est install√©e. Ainsi, une extension malveillante ou compromise avec ces privil√®ges peut cr√©er votre profil de mouvement ou surveiller votre presse-papiers pour des mots de passe copi√©s sans que vous ne remarquiez quoi que ce soit.

Ajouter le mot-cl√© **`history`** √† l'[entr√©e de permissions](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions) du manifeste de l'extension accorde **l'acc√®s √† l'** [**API history**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/history). Cela permet de r√©cup√©rer l'historique de navigation complet de l'utilisateur d'un seul coup, sans attendre que l'utilisateur visite √† nouveau ces sites web.

La **permission `bookmarks`** a un potentiel d'abus similaire, celle-ci permet **de lire tous les signets via l'** [**API bookmarks**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/bookmarks).

### Permission de stockage <a href="#the-storage-permission" id="the-storage-permission"></a>

Le stockage de l'extension est simplement une collection cl√©-valeur, tr√®s similaire √† [localStorage](https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage) que n'importe quel site web pourrait utiliser. Donc, aucune information sensible ne devrait y √™tre stock√©e.

Cependant, les entreprises de publicit√© pourraient √©galement abuser de ce stockage.

### Plus de permissions

Vous pouvez trouver la [**liste compl√®te des permissions qu'une extension de navigateur Chromium peut demander ici**](https://developer.chrome.com/docs/extensions/develop/concepts/declare-permissions#permissions) et une [**liste compl√®te pour les extensions Firefox ici**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#api\_permissions)**.**

## Pr√©vention <a href="#why-not-restrict-extension-privileges" id="why-not-restrict-extension-privileges"></a>

La politique des d√©veloppeurs de Google interdit explicitement aux extensions de demander plus de privil√®ges que n√©cessaire pour leur fonctionnalit√©, att√©nuant ainsi efficacement les demandes de permissions excessives. Un exemple o√π une extension de navigateur a d√©pass√© cette limite impliquait sa distribution avec le navigateur lui-m√™me plut√¥t que par le biais d'un magasin d'add-ons.

Les navigateurs pourraient √©galement limiter davantage l'abus des privil√®ges d'extension. Par exemple, les [tabCapture](https://developer.chrome.com/docs/extensions/reference/tabCapture/) et [desktopCapture](https://developer.chrome.com/docs/extensions/reference/desktopCapture/) APIs de Chrome, utilis√©es pour l'enregistrement d'√©cran, sont con√ßues pour minimiser les abus. L'API tabCapture ne peut √™tre activ√©e que par une interaction directe de l'utilisateur, comme cliquer sur l'ic√¥ne de l'extension, tandis que desktopCapture n√©cessite la confirmation de l'utilisateur pour que la fen√™tre soit enregistr√©e, emp√™chant ainsi les activit√©s d'enregistrement clandestin.

Cependant, le renforcement des mesures de s√©curit√© entra√Æne souvent une diminution de la flexibilit√© et de la convivialit√© des extensions. La [permission activeTab](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#activetab\_permission) illustre ce compromis. Elle a √©t√© introduite pour √©liminer la n√©cessit√© pour les extensions de demander des privil√®ges d'h√¥te sur l'ensemble d'Internet, permettant aux extensions d'acc√©der uniquement √† l'onglet actuel sur activation explicite par l'utilisateur. Ce mod√®le est efficace pour les extensions n√©cessitant des actions initi√©es par l'utilisateur, mais est insuffisant pour celles n√©cessitant des actions automatiques ou pr√©ventives, compromettant ainsi la commodit√© et la r√©activit√© imm√©diate.

## **R√©f√©rences**

* [https://palant.info/2022/08/17/impact-of-extension-privileges/](https://palant.info/2022/08/17/impact-of-extension-privileges/)
* [https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing](https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing)

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
{% endhint %}
