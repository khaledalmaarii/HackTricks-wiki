# BrowExt - permissions & host\_permissions

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

### **`permissions`**

Dozvole su definisane u **`manifest.json`** datoteci ekstenzije koristeÄ‡i **`permissions`** svojstvo i omoguÄ‡avaju pristup gotovo svemu Å¡to pretraÅ¾ivaÄ moÅ¾e da pristupi (KolaÄiÄ‡i ili FiziÄka pohrana):

Prethodni manifest obaveÅ¡tava da ekstenzija zahteva `storage` dozvolu. To znaÄi da moÅ¾e koristiti [API za pohranu](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/storage) za trajno Äuvanje svojih podataka. Za razliku od kolaÄiÄ‡a ili `localStorage` API-ja koji korisnicima daju odreÄ‘eni nivo kontrole, **pohrana ekstenzije se obiÄno moÅ¾e obrisati samo deinstaliranjem ekstenzije**.

Ekstenzija Ä‡e zatraÅ¾iti dozvole navedene u svojoj **`manifest.json`** datoteci, a nakon instalacije ekstenzije, moÅ¾ete **uvek proveriti njene dozvole u svom pretraÅ¾ivaÄu**, kao Å¡to je prikazano na ovoj slici:

<figure><img src="../../.gitbook/assets/image (18).png" alt=""><figcaption></figcaption></figure>

MoÅ¾ete pronaÄ‡i [**potpunu listu dozvola koje Chromium Browser Extension moÅ¾e zatraÅ¾iti ovde**](https://developer.chrome.com/docs/extensions/develop/concepts/declare-permissions#permissions) i [**potpunu listu za Firefox ekstenzije ovde**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#api\_permissions)**.**

### `host_permissions`

Opciona, ali moÄ‡na postavka **`host_permissions`** oznaÄava sa kojim hostovima Ä‡e ekstenzija moÄ‡i da komunicira putem API-ja kao Å¡to su [`cookies`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/cookies), [`webRequest`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/webRequest), i [`tabs`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs).

SledeÄ‡e `host_permissions` u suÅ¡tini omoguÄ‡avaju svaki web:
```json
"host_permissions": [
"*://*/*"
]

// Or:
"host_permissions": [
"http://*/*",
"https://*/*"
]

// Or:
"host_permissions": [
"<all_urls>"
]
```
Ovo su hostovi kojima ekstenzija pregledaÄa moÅ¾e slobodno pristupiti. To je zato Å¡to kada ekstenzija pregledaÄa pozove **`fetch("https://gmail.com/")`**, nije ograniÄena CORS-om.

## Zloupotreba `permissions` i `host_permissions`

### Tabs

Pored toga, **`host_permissions`** takoÄ‘e otkljuÄava â€œnaprednuâ€ [**tabs API**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs) **funkcionalnost.** OmoguÄ‡avaju ekstenziji da pozove [tabs.query()](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/query) i ne samo da dobije **listu korisnikovih kartica pregledaÄa** nazad, veÄ‡ i da sazna koja **web stranica (Å¡to znaÄi adresa i naslov) je uÄitana**.

{% hint style="danger" %}
Ne samo to, sluÅ¡aoci poput [**tabs.onUpdated**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/onUpdated) **postaju mnogo korisniji.** BiÄ‡e obaveÅ¡teni svaki put kada se nova stranica uÄita u karticu.
{% endhint %}

### Pokretanje sadrÅ¾ajnih skripti <a href="#running-content-scripts" id="running-content-scripts"></a>

SadrÅ¾ajne skripte nisu nuÅ¾no napisane statiÄki u manifestu ekstenzije. Uz dovoljno **`host_permissions`**, **ekstenzije mogu takoÄ‘e dinamiÄki uÄitati skripte pozivajuÄ‡i** [**tabs.executeScript()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/executeScript) **ili** [**scripting.executeScript()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/scripting/executeScript).

Oba API-ja omoguÄ‡avaju izvrÅ¡avanje ne samo datoteka sadrÅ¾anih u ekstenzijama kao sadrÅ¾ajnih skripti, veÄ‡ i **arbitrarnih kodova**. Prvi omoguÄ‡ava prosleÄ‘ivanje JavaScript koda kao stringa, dok drugi oÄekuje JavaScript funkciju koja je manje podloÅ¾na ranjivostima od injekcija. Ipak, oba API-ja Ä‡e napraviti haos ako se zloupotrebe.

{% hint style="danger" %}
Pored moguÄ‡nosti navedenih iznad, sadrÅ¾ajne skripte mogu na primer **presresti kredencijale** dok se unose na web stranicama. JoÅ¡ jedan klasiÄan naÄin zloupotrebe je **ubacivanje reklama** na svakoj web stranici. Dodavanje **prevara** za zloupotrebu kredibiliteta vesti takoÄ‘e je moguÄ‡e. Na kraju, mogu **manipulisati bankarskim** web stranicama kako bi preusmerili novÄane transfere.
{% endhint %}

### Implicitne privilegije <a href="#implicit-privileges" id="implicit-privileges"></a>

Neke privilegije ekstenzije **ne moraju biti eksplicitno deklarisane**. Jedan primer je [tabs API](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs): njena osnovna funkcionalnost je dostupna bez ikakvih privilegija. Svaka ekstenzija moÅ¾e biti obaveÅ¡tena kada otvorite i zatvorite kartice, samo neÄ‡e znati kojoj web stranici te kartice odgovaraju.

ZvuÄi previÅ¡e bezopasno? [tabs.create() API](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/create) je donekle manje tako. MoÅ¾e se koristiti za **kreiranje nove kartice**, suÅ¡tinski isto kao [window.open()](https://developer.mozilla.org/en-US/docs/Web/API/Window/open) koji moÅ¾e pozvati svaka web stranica. Ipak, dok je `window.open()` podloÅ¾an **blokatoru iskaÄuÄ‡ih prozora, `tabs.create()` nije**.

{% hint style="danger" %}
Ekstenzija moÅ¾e kreirati bilo koji broj kartica kad god Å¾eli.
{% endhint %}

Ako pogledate moguÄ‡e `tabs.create()` parametre, takoÄ‘e Ä‡ete primetiti da njene moguÄ‡nosti daleko prevazilaze ono Å¡to `window.open()` moÅ¾e kontrolisati. I dok Firefox ne dozvoljava koriÅ¡Ä‡enje `data:` URI sa ovim API-jem, Chrome nema takvu zaÅ¡titu. **KoriÅ¡Ä‡enje takvih URI na najviÅ¡em nivou je** [**zabranjeno zbog zloupotrebe za phishing**](https://bugzilla.mozilla.org/show\_bug.cgi?id=1331351)**.**

[**tabs.update()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/update) je vrlo sliÄan `tabs.create()`, ali Ä‡e **modifikovati postojeÄ‡u karticu**. Tako moÅ¾e zla ekstenzija na primer proizvoljno uÄitati stranicu sa reklamama u jednu od vaÅ¡ih kartica, i moÅ¾e aktivirati odgovarajuÄ‡u karticu.

### Webcam, geolokacija i prijatelji <a href="#webcam-geolocation-and-friends" id="webcam-geolocation-and-friends"></a>

Verovatno znate da web stranice mogu traÅ¾iti posebne dozvole, npr. da pristupe vaÅ¡oj web kameri (alatke za video konferencije) ili geografskoj lokaciji (mape). To su funkcije sa znaÄajnim potencijalom za zloupotrebu, tako da korisnici svaki put moraju potvrditi da to joÅ¡ uvek Å¾ele.

{% hint style="danger" %}
Ne tako sa ekstenzijama pregledaÄa. **Ako ekstenzija pregledaÄa** [**Å¾eli pristup vaÅ¡oj web kameri ili mikrofonu**](https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia)**, potrebno je da zatraÅ¾i dozvolu samo jednom**
{% endhint %}

ObiÄno, ekstenzija to Äini odmah nakon instalacije. Kada se ova poruka prihvati, **pristup web kameri je moguÄ‡ u bilo kojem trenutku**, Äak i ako korisnik u tom trenutku ne interaguje sa ekstenzijom. Da, korisnik Ä‡e prihvatiti ovu poruku samo ako ekstenzija zaista treba pristup web kameri. Ali nakon toga, moraju verovati ekstenziji da neÄ‡e tajno snimati niÅ¡ta.

Sa pristupom [vaÅ¡oj taÄnoj geografskoj lokaciji](https://developer.mozilla.org/en-US/docs/Web/API/Geolocation) ili [sadrÅ¾aju vaÅ¡eg clipboard-a](https://developer.mozilla.org/en-US/docs/Web/API/Clipboard\_API), eksplicitno davanje dozvole je potpuno nepotrebno. **Ekstenzija jednostavno dodaje `geolocation` ili `clipboard` u** [**permissions entry**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions) **svojeg manifesta**. Ove privilegije pristupa se zatim implicitno dodeljuju kada se ekstenzija instalira. Tako zla ili kompromitovana ekstenzija sa ovim privilegijama moÅ¾e stvoriti vaÅ¡ profil kretanja ili pratiti vaÅ¡ clipboard za kopirane lozinke bez da primetite bilo Å¡ta.

Dodavanje **`history`** kljuÄne reÄi u [permissions entry](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions) manifesta ekstenzije dodeljuje **pristup** [**history API**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/history). OmoguÄ‡ava preuzimanje celokupne istorije pretraÅ¾ivanja korisnika odjednom, bez Äekanja da korisnik ponovo poseti te web stranice.

**`bookmarks`** **dozvola** ima sliÄan potencijal za zloupotrebu, ova dozvola omoguÄ‡ava **Äitanje svih oznaka putem** [**bookmarks API**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/bookmarks).

### Dozvola za skladiÅ¡tenje <a href="#the-storage-permission" id="the-storage-permission"></a>

SkladiÅ¡tenje ekstenzije je samo kolekcija kljuÄ-vrednost, vrlo sliÄna [localStorage](https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage) koju bi svaka web stranica mogla koristiti. Tako da ovde ne bi trebalo da se Äuvaju osetljive informacije.

MeÄ‘utim, reklamne kompanije takoÄ‘e mogu zloupotrebiti ovo skladiÅ¡te.

### ViÅ¡e dozvola

MoÅ¾ete pronaÄ‡i [**potpunu listu dozvola koje Chromium Browser Extension moÅ¾e zatraÅ¾iti ovde**](https://developer.chrome.com/docs/extensions/develop/concepts/declare-permissions#permissions) i [**potpunu listu za Firefox ekstenzije ovde**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#api\_permissions)**.**

## Prevencija <a href="#why-not-restrict-extension-privileges" id="why-not-restrict-extension-privileges"></a>

Politika Google-ovih developera izriÄito zabranjuje ekstenzijama da traÅ¾e viÅ¡e privilegija nego Å¡to je potrebno za njihovu funkcionalnost, efikasno smanjujuÄ‡i prekomerne zahteve za dozvolama. Primer gde je ekstenzija pregledaÄa preÅ¡la ovu granicu ukljuÄivao je njenu distribuciju sa samim pregledaÄem umesto putem prodavnice dodataka.

PregledaÄi bi mogli dalje ograniÄiti zloupotrebu privilegija ekstenzija. Na primer, Chrome-ovi [tabCapture](https://developer.chrome.com/docs/extensions/reference/tabCapture/) i [desktopCapture](https://developer.chrome.com/docs/extensions/reference/desktopCapture/) API, koriÅ¡Ä‡eni za snimanje ekrana, dizajnirani su da minimiziraju zloupotrebu. tabCapture API moÅ¾e se aktivirati samo kroz direktnu interakciju korisnika, kao Å¡to je klik na ikonu ekstenzije, dok desktopCapture zahteva potvrdu korisnika za prozor koji treba snimiti, spreÄavajuÄ‡i tajne aktivnosti snimanja.

MeÄ‘utim, pooÅ¡travanje mera bezbednosti Äesto rezultira smanjenjem fleksibilnosti i korisniÄke prijateljskosti ekstenzija. [activeTab dozvola](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#activetab\_permission) ilustruje ovu trgovinu. Uvedena je da eliminiÅ¡e potrebu za ekstenzijama da traÅ¾e privilegije hosta Å¡irom interneta, omoguÄ‡avajuÄ‡i ekstenzijama da pristupaju samo trenutnoj kartici na eksplicitnu aktivaciju od strane korisnika. Ovaj model je efikasan za ekstenzije koje zahtevaju akcije inicirane od strane korisnika, ali nije dovoljan za one koje zahtevaju automatske ili preventivne akcije, Äime se kompromituje pogodnost i trenutna reakcija.

## **Reference**

* [https://palant.info/2022/08/17/impact-of-extension-privileges/](https://palant.info/2022/08/17/impact-of-extension-privileges/)
* [https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing](https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
