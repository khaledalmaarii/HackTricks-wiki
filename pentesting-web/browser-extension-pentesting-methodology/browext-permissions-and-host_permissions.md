# BrowExt - permisos & host\_permissions

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Informaci√≥n B√°sica

### **`permissions`**

Los permisos se definen en el archivo **`manifest.json`** de la extensi√≥n utilizando la propiedad **`permissions`** y permiten el acceso a casi cualquier cosa a la que un navegador puede acceder (Cookies o Almacenamiento F√≠sico):

El manifiesto anterior declara que la extensi√≥n requiere el permiso `storage`. Esto significa que puede usar [la API de almacenamiento](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/storage) para almacenar sus datos de manera persistente. A diferencia de las cookies o las APIs de `localStorage` que dan a los usuarios cierto nivel de control, **el almacenamiento de la extensi√≥n normalmente solo puede ser borrado desinstalando la extensi√≥n**.

Una extensi√≥n solicitar√° los permisos indicados en su archivo **`manifest.json`** y despu√©s de instalar la extensi√≥n, siempre puedes **verificar sus permisos en tu navegador**, como se muestra en esta imagen:

<figure><img src="../../.gitbook/assets/image (18).png" alt=""><figcaption></figcaption></figure>

Puedes encontrar la [**lista completa de permisos que una extensi√≥n de navegador Chromium puede solicitar aqu√≠**](https://developer.chrome.com/docs/extensions/develop/concepts/declare-permissions#permissions) y una [**lista completa para extensiones de Firefox aqu√≠**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#api\_permissions)**.**

### `host_permissions`

La configuraci√≥n opcional pero poderosa **`host_permissions`** indica con qu√© hosts la extensi√≥n podr√° interactuar a trav√©s de APIs como [`cookies`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/cookies), [`webRequest`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/webRequest), y [`tabs`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs).

Los siguientes `host_permissions` permiten b√°sicamente cada web:
```json
"host_permissions": [
"*://*/*"
]

// Or:
"host_permissions": [
"http://*/*",
"https://*/*"
]

// Or:
"host_permissions": [
"<all_urls>"
]
```
Estos son los hosts a los que la extensi√≥n del navegador puede acceder libremente. Esto se debe a que cuando una extensi√≥n del navegador llama a **`fetch("https://gmail.com/")`**, no est√° restringida por CORS.

## Abusando de `permissions` y `host_permissions`

### Tabs

Adem√°s, **`host_permissions`** tambi√©n desbloquea la funcionalidad ‚Äúavanzada‚Äù de la [**API de tabs**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs). Permiten que la extensi√≥n llame a [tabs.query()](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/query) y no solo obtenga una **lista de las pesta√±as del navegador del usuario**, sino que tambi√©n aprenda qu√© **p√°gina web (es decir, direcci√≥n y t√≠tulo) est√° cargada**.

{% hint style="danger" %}
No solo eso, los oyentes como [**tabs.onUpdated**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/onUpdated) **tambi√©n se vuelven mucho m√°s √∫tiles**. Estos ser√°n notificados cada vez que se cargue una nueva p√°gina en una pesta√±a.
{% endhint %}

### Ejecutando scripts de contenido <a href="#running-content-scripts" id="running-content-scripts"></a>

Los scripts de contenido no necesariamente est√°n escritos de forma est√°tica en el manifiesto de la extensi√≥n. Dadas suficientes **`host_permissions`**, **las extensiones tambi√©n pueden cargarlos din√°micamente llamando a** [**tabs.executeScript()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/executeScript) **o** [**scripting.executeScript()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/scripting/executeScript).

Ambas API permiten ejecutar no solo archivos contenidos en las extensiones como scripts de contenido, sino tambi√©n **c√≥digo arbitrario**. La primera permite pasar c√≥digo JavaScript como una cadena, mientras que la segunda espera una funci√≥n de JavaScript que es menos propensa a vulnerabilidades de inyecci√≥n. A√∫n as√≠, ambas API causar√°n estragos si se usan incorrectamente.

{% hint style="danger" %}
Adem√°s de las capacidades anteriores, los scripts de contenido podr√≠an, por ejemplo, **interceptar credenciales** a medida que se ingresan en las p√°ginas web. Otra forma cl√°sica de abusar de ellos es **inyectar publicidad** en cada sitio web. Tambi√©n es posible agregar **mensajes de estafa** para abusar de la credibilidad de los sitios web de noticias. Finalmente, podr√≠an **manipular sitios web bancarios** para redirigir transferencias de dinero.
{% endhint %}

### Privilegios impl√≠citos <a href="#implicit-privileges" id="implicit-privileges"></a>

Algunos privilegios de la extensi√≥n **no tienen que ser declarados expl√≠citamente**. Un ejemplo es la [API de tabs](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs): su funcionalidad b√°sica es accesible sin ning√∫n privilegio. Cualquier extensi√≥n puede ser notificada cuando abres y cierras pesta√±as, simplemente no sabr√° a qu√© sitio web corresponden estas pesta√±as.

¬øSuena demasiado inofensivo? La [API tabs.create()](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/create) es algo menos inofensiva. Puede ser utilizada para **crear una nueva pesta√±a**, esencialmente lo mismo que [window.open()](https://developer.mozilla.org/en-US/docs/Web/API/Window/open) que puede ser llamado por cualquier sitio web. Sin embargo, mientras que `window.open()` est√° sujeto al **bloqueador de ventanas emergentes, `tabs.create()` no lo est√°**.

{% hint style="danger" %}
Una extensi√≥n puede crear cualquier n√∫mero de pesta√±as cuando quiera.
{% endhint %}

Si revisas los posibles par√°metros de `tabs.create()`, tambi√©n notar√°s que sus capacidades van mucho m√°s all√° de lo que `window.open()` puede controlar. Y aunque Firefox no permite que se usen URIs `data:` con esta API, Chrome no tiene tal protecci√≥n. **El uso de tales URIs en el nivel superior ha sido** [**prohibido debido a su abuso para phishing**](https://bugzilla.mozilla.org/show\_bug.cgi?id=1331351)**.**

[**tabs.update()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/update) es muy similar a `tabs.create()` pero **modificar√° una pesta√±a existente**. As√≠ que una extensi√≥n maliciosa puede, por ejemplo, cargar arbitrariamente una p√°gina de publicidad en una de tus pesta√±as, y tambi√©n puede activar la pesta√±a correspondiente.

### Webcam, geolocalizaci√≥n y amigos <a href="#webcam-geolocation-and-friends" id="webcam-geolocation-and-friends"></a>

Probablemente sepas que los sitios web pueden solicitar permisos especiales, por ejemplo, para acceder a tu c√°mara web (herramientas de videoconferencia) o ubicaci√≥n geogr√°fica (mapas). Son caracter√≠sticas con un considerable potencial de abuso, por lo que los usuarios deben confirmar cada vez que a√∫n desean esto.

{% hint style="danger" %}
No es as√≠ con las extensiones del navegador. **Si una extensi√≥n del navegador** [**quiere acceso a tu c√°mara web o micr√≥fono**](https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia)**, solo necesita pedir permiso una vez**
{% endhint %}

T√≠picamente, una extensi√≥n lo har√° inmediatamente despu√©s de ser instalada. Una vez que se acepta este aviso, **el acceso a la c√°mara web es posible en cualquier momento**, incluso si el usuario no est√° interactuando con la extensi√≥n en ese momento. S√≠, un usuario solo aceptar√° este aviso si la extensi√≥n realmente necesita acceso a la c√°mara web. Pero despu√©s de eso, deben confiar en que la extensi√≥n no grabar√° nada en secreto.

Con acceso a [tu ubicaci√≥n geogr√°fica exacta](https://developer.mozilla.org/en-US/docs/Web/API/Geolocation) o [contenido de tu portapapeles](https://developer.mozilla.org/en-US/docs/Web/API/Clipboard\_API), otorgar permiso expl√≠citamente es innecesario por completo. **Una extensi√≥n simplemente agrega `geolocation` o `clipboard` a la** [**entrada de permisos**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions) **de su manifiesto**. Estos privilegios de acceso se otorgan impl√≠citamente cuando se instala la extensi√≥n. As√≠ que una extensi√≥n maliciosa o comprometida con estos privilegios puede crear tu perfil de movimiento o monitorear tu portapapeles en busca de contrase√±as copiadas sin que te des cuenta.

Agregar la palabra clave **`history`** a la [entrada de permisos](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions) del manifiesto de la extensi√≥n otorga **acceso a la** [**API de history**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/history). Permite recuperar todo el historial de navegaci√≥n del usuario de una vez, sin esperar a que el usuario visite estos sitios web nuevamente.

El **permiso `bookmarks`** tiene un potencial de abuso similar, este permite **leer todos los marcadores a trav√©s de la** [**API de bookmarks**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/bookmarks).

### Permiso de almacenamiento <a href="#the-storage-permission" id="the-storage-permission"></a>

El almacenamiento de la extensi√≥n es simplemente una colecci√≥n de clave-valor, muy similar a [localStorage](https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage) que cualquier sitio web podr√≠a usar. Por lo tanto, no se debe almacenar informaci√≥n sensible aqu√≠.

Sin embargo, las empresas de publicidad tambi√©n podr√≠an abusar de este almacenamiento.

### M√°s permisos

Puedes encontrar la [**lista completa de permisos que una extensi√≥n de navegador Chromium puede solicitar aqu√≠**](https://developer.chrome.com/docs/extensions/develop/concepts/declare-permissions#permissions) y una [**lista completa para extensiones de Firefox aqu√≠**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#api\_permissions)**.**

## Prevenci√≥n <a href="#why-not-restrict-extension-privileges" id="why-not-restrict-extension-privileges"></a>

La pol√≠tica del desarrollador de Google proh√≠be expl√≠citamente a las extensiones solicitar m√°s privilegios de los necesarios para su funcionalidad, mitigando efectivamente las solicitudes excesivas de permisos. Un caso en el que una extensi√≥n del navegador sobrepas√≥ este l√≠mite involucr√≥ su distribuci√≥n con el propio navegador en lugar de a trav√©s de una tienda de complementos.

Los navegadores podr√≠an limitar a√∫n m√°s el abuso de los privilegios de las extensiones. Por ejemplo, las API [tabCapture](https://developer.chrome.com/docs/extensions/reference/tabCapture/) y [desktopCapture](https://developer.chrome.com/docs/extensions/reference/desktopCapture/) de Chrome, utilizadas para la grabaci√≥n de pantalla, est√°n dise√±adas para minimizar el abuso. La API tabCapture solo puede ser activada a trav√©s de la interacci√≥n directa del usuario, como hacer clic en el √≠cono de la extensi√≥n, mientras que desktopCapture requiere confirmaci√≥n del usuario para que la ventana sea grabada, previniendo actividades de grabaci√≥n clandestinas.

Sin embargo, endurecer las medidas de seguridad a menudo resulta en una disminuci√≥n de la flexibilidad y la facilidad de uso de las extensiones. El [permiso activeTab](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#activetab\_permission) ilustra este compromiso. Se introdujo para eliminar la necesidad de que las extensiones solicitaran privilegios de host en toda la internet, permitiendo que las extensiones accedan solo a la pesta√±a actual tras la activaci√≥n expl√≠cita por parte del usuario. Este modelo es efectivo para extensiones que requieren acciones iniciadas por el usuario, pero no es suficiente para aquellas que requieren acciones autom√°ticas o preventivas, comprometiendo as√≠ la conveniencia y la capacidad de respuesta inmediata.

## **Referencias**

* [https://palant.info/2022/08/17/impact-of-extension-privileges/](https://palant.info/2022/08/17/impact-of-extension-privileges/)
* [https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing](https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
