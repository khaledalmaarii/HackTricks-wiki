# Envenenamento de Cache e Engano de Cache

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="/.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

\
Use [**Trickest**](https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks) para construir e **automatizar fluxos de trabalho** com as ferramentas comunit√°rias mais avan√ßadas do mundo.\
Acesse hoje:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## A diferen√ßa

> **Qual √© a diferen√ßa entre envenenamento de cache web e engano de cache web?**
>
> * No **envenenamento de cache web**, o atacante faz com que a aplica√ß√£o armazene algum conte√∫do malicioso no cache, e esse conte√∫do √© servido do cache para outros usu√°rios da aplica√ß√£o.
> * No **engano de cache web**, o atacante faz com que a aplica√ß√£o armazene algum conte√∫do sens√≠vel pertencente a outro usu√°rio no cache, e o atacante ent√£o recupera esse conte√∫do do cache.

## Envenenamento de Cache

O objetivo do envenenamento de cache √© fazer com que os **clientes carreguem recursos inesperados parcialmente ou controlados pelo atacante**.\
A resposta envenenada ser√° servida apenas aos usu√°rios que visitarem a p√°gina afetada enquanto o cache estiver envenenado. Como resultado, o impacto pode variar de inexistente a massivo, dependendo se a p√°gina √© popular ou n√£o.

Para realizar um ataque de envenenamento de cache, voc√™ precisa primeiro **identificar entradas n√£o indexadas** (par√¢metros que n√£o precisam aparecer na solicita√ß√£o em cache, mas que alteram a p√°gina retornada), ver **como abusar** desse par√¢metro e **obter a resposta em cache**.

### Descoberta: Verificar cabe√ßalhos HTTP

Normalmente, quando uma resposta foi **armazenada em cache**, haver√° um **cabe√ßalho indicando isso**, voc√™ pode verificar quais cabe√ßalhos voc√™ deve prestar aten√ß√£o neste post: [**Cabe√ßalhos de cache HTTP**](../network-services-pentesting/pentesting-web/special-http-headers.md#cache-headers).

### Descoberta: Armazenamento de c√≥digo 400 em cache

Se voc√™ suspeitar que a resposta est√° sendo armazenada em cache, voc√™ pode tentar **enviar solicita√ß√µes com um cabe√ßalho ruim**, que deve ser respondido com um **c√≥digo de status 400**. Em seguida, tente acessar a solicita√ß√£o normalmente e se a **resposta for um c√≥digo de status 400**, voc√™ sabe que est√° vulner√°vel (e at√© mesmo pode realizar um DoS).\
Um cabe√ßalho mal configurado pode ser apenas `\:` como um cabe√ßalho.\
_Observa√ß√£o: √†s vezes, esses tipos de c√≥digos de status n√£o s√£o armazenados em cache, ent√£o esse teste ser√° in√∫til._

### Descoberta: Identificar e avaliar entradas n√£o indexadas

Voc√™ pode usar o [**Param Miner**](https://portswigger.net/bappstore/17d2949a985c4b7ca092728dba871943) para **for√ßar par√¢metros e cabe√ßalhos** que podem estar **alterando a resposta da p√°gina**. Por exemplo, uma p√°gina pode estar usando o cabe√ßalho `X-Forwarded-For` para indicar ao cliente que carregue o script de l√°:
```markup
<script type="text/javascript" src="//<X-Forwarded-For_value>/resources/js/tracking.js"></script>
```
### Elicitar uma resposta prejudicial do servidor back-end

Com o par√¢metro/cabe√ßalho identificado, verifique como ele est√° sendo **sanitizado** e **onde** ele est√° **sendo refletido** ou afetando a resposta do cabe√ßalho. √â poss√≠vel abusar dele de alguma forma (realizar um XSS ou carregar um c√≥digo JS controlado por voc√™? realizar um DoS?...)

### Obter a resposta em cache

Uma vez que voc√™ tenha **identificado** a **p√°gina** que pode ser abusada, qual **par√¢metro**/**cabe√ßalho** usar e **como** abus√°-lo, voc√™ precisa obter a p√°gina em cache. Dependendo do recurso que voc√™ est√° tentando obter em cache, isso pode levar algum tempo, talvez seja necess√°rio tentar por v√°rios segundos.\
O cabe√ßalho **`X-Cache`** na resposta pode ser muito √∫til, pois pode ter o valor **`miss`** quando a solicita√ß√£o n√£o foi armazenada em cache e o valor **`hit`** quando est√° em cache.\
O cabe√ßalho **`Cache-Control`** tamb√©m √© interessante para saber se um recurso est√° sendo armazenado em cache e quando ser√° a pr√≥xima vez que o recurso ser√° armazenado em cache novamente: `Cache-Control: public, max-age=1800`\
Outro cabe√ßalho interessante √© o **`Vary`**. Esse cabe√ßalho √© frequentemente usado para **indicar cabe√ßalhos adicionais** que s√£o tratados como **parte da chave de cache**, mesmo que normalmente n√£o sejam chaveados. Portanto, se o usu√°rio conhece o `User-Agent` da v√≠tima que est√° visando, ele pode envenenar o cache para os usu√°rios que usam esse `User-Agent` espec√≠fico.\
Mais um cabe√ßalho relacionado ao cache √© o **`Age`**. Ele define o tempo em segundos que o objeto est√° no cache do proxy.

Ao armazenar em cache uma solicita√ß√£o, tenha **cuidado com os cabe√ßalhos que voc√™ usa**, pois alguns deles podem ser **usados de forma inesperada** como **chave** e a **v√≠tima precisar√° usar o mesmo cabe√ßalho**. Sempre **teste** um Envenenamento de Cache com **diferentes navegadores** para verificar se est√° funcionando.

## Exemplos de explora√ß√£o

### Exemplo mais f√°cil

Um cabe√ßalho como `X-Forwarded-For` est√° sendo refletido na resposta sem ser sanitizado.\
Voc√™ pode enviar uma carga √∫til b√°sica de XSS e envenenar o cache para que todos que acessem a p√°gina sejam afetados pelo XSS:
```markup
GET /en?region=uk HTTP/1.1
Host: innocent-website.com
X-Forwarded-Host: a."><script>alert(1)</script>"
```
_Nota que isso ir√° envenenar uma requisi√ß√£o para `/en?region=uk` e n√£o para `/en`_

### Usando envenenamento de cache web para explorar vulnerabilidades de manipula√ß√£o de cookies

Os cookies tamb√©m podem ser refletidos na resposta de uma p√°gina. Se voc√™ puder abusar disso para causar um XSS, por exemplo, voc√™ poder√° explorar o XSS em v√°rios clientes que carregam a resposta de cache maliciosa.
```markup
GET / HTTP/1.1
Host: vulnerable.com
Cookie: session=VftzO7ZtiBj5zNLRAuFpXpSQLjS4lBmU; fehost=asd"%2balert(1)%2b"
```
### Usando v√°rios cabe√ßalhos para explorar vulnerabilidades de envenenamento de cache web <a href="#using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities" id="using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities"></a>

√Äs vezes, voc√™ precisar√° **explorar v√°rias entradas n√£o indexadas** para poder abusar de um cache. Por exemplo, voc√™ pode encontrar um **redirecionamento aberto** se definir `X-Forwarded-Host` para um dom√≠nio controlado por voc√™ e `X-Forwarded-Scheme` para `http`. **Se** o **servidor** estiver **redirecionando** todas as solicita√ß√µes **HTTP** para **HTTPS** e usando o cabe√ßalho `X-Forwarded-Scheme` como o nome de dom√≠nio para o redirecionamento. Voc√™ pode controlar para onde a p√°gina √© redirecionada.
```markup
GET /resources/js/tracking.js HTTP/1.1
Host: acc11fe01f16f89c80556c2b0056002e.web-security-academy.net
X-Forwarded-Host: ac8e1f8f1fb1f8cb80586c1d01d500d3.web-security-academy.net/
X-Forwarded-Scheme: http
```
### Explorando com o cabe√ßalho `Vary` limitado

Se voc√™ descobrir que o cabe√ßalho **`X-Host`** est√° sendo usado como **nome de dom√≠nio para carregar um recurso JS**, mas o cabe√ßalho **`Vary`** na resposta est√° indicando **`User-Agent`**, ent√£o voc√™ precisa encontrar uma maneira de extrair o User-Agent da v√≠tima e envenenar o cache usando esse user agent:
```markup
GET / HTTP/1.1
Host: vulnerbale.net
User-Agent: THE SPECIAL USER-AGENT OF THE VICTIM
X-Host: attacker.com
```
### Explorando a Cria√ß√£o de Cache HTTP ao abusar do Contrabando de Requisi√ß√µes HTTP

Aprenda aqui como realizar ataques de Cria√ß√£o de Cache ao abusar do Contrabando de Requisi√ß√µes HTTP.

### Teste automatizado para Cria√ß√£o de Cache na Web

O [Web Cache Vulnerability Scanner](https://github.com/Hackmanit/Web-Cache-Vulnerability-Scanner) pode ser usado para testar automaticamente a cria√ß√£o de cache na web. Ele suporta muitas t√©cnicas diferentes e √© altamente personaliz√°vel.

Exemplo de uso: `wcvs -u example.com`

<figure><img src="/.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

\
Use [**Trickest**](https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks) para construir e automatizar facilmente fluxos de trabalho com as ferramentas comunit√°rias mais avan√ßadas do mundo.\
Acesse hoje mesmo:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## Exemplos de Vulnerabilidades

### Apache Traffic Server ([CVE-2021-27577](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-27577))

O ATS encaminhava o fragmento dentro da URL sem remov√™-lo e gerava a chave de cache usando apenas o host, o caminho e a consulta (ignorando o fragmento). Portanto, a solicita√ß√£o `/#/../?r=javascript:alert(1)` era enviada ao backend como `/#/../?r=javascript:alert(1)` e a chave de cache n√£o continha a carga √∫til, apenas o host, o caminho e a consulta.

### GitHub CP-DoS

O envio de um valor inv√°lido no cabe√ßalho de tipo de conte√∫do acionava uma resposta em cache 405. A chave de cache continha o cookie, portanto, era poss√≠vel atacar apenas usu√°rios n√£o autenticados.

### GitLab + GCP CP-DoS

O GitLab usa buckets do GCP para armazenar conte√∫do est√°tico. Os **buckets do GCP** suportam o cabe√ßalho `x-http-method-override`. Portanto, era poss√≠vel enviar o cabe√ßalho `x-http-method-override: HEAD` e corromper o cache para retornar um corpo de resposta vazio. Tamb√©m poderia suportar o m√©todo `PURGE`.

### Rack Middleware (Ruby on Rails)

Aplicativos Ruby on Rails s√£o frequentemente implantados junto com o middleware Rack. O c√≥digo Rack abaixo pega o valor do **`x-forwarded-scheme` e o usa como o esquema da solicita√ß√£o**.

![](<../.gitbook/assets/image (159) (2).png>)

O envio do cabe√ßalho `x-forwarded-scheme: http` resultaria em um redirecionamento 301 para a mesma localiza√ß√£o, o que causaria uma nega√ß√£o de servi√ßo (DoS) nesse recurso, como neste exemplo:

![](<../.gitbook/assets/image (166).png>)

O aplicativo tamb√©m pode suportar o cabe√ßalho `X-forwarded-host` e redirecionar o usu√°rio para esse host, permitindo carregar arquivos JavaScript do servidor do atacante:

![](<../.gitbook/assets/image (157) (2).png>)

### 403 e Storage Buckets

Anteriormente, o **Cloudflare** costumava **armazenar em cache** as respostas **403**, portanto, o envio de **cabe√ßalhos de Autoriza√ß√£o inv√°lidos** tentando acessar **S3** ou **Azure Storage Blobs** expostos retornaria um 403 que seria armazenado em cache. O Cloudflare n√£o armazena mais respostas 403, mas isso pode funcionar com outros proxies.

![](<../.gitbook/assets/image (171).png>)

### Inje√ß√£o de Par√¢metros Chaveados

Com frequ√™ncia, os caches s√£o configurados para **incluir apenas par√¢metros GET espec√≠ficos na chave de cache**.

Por exemplo, o Fastly usando o Varnish **armazenava em cache o par√¢metro `size`** na solicita√ß√£o, mas se voc√™ tamb√©m enviasse o par√¢metro **`siz%65`** com um valor inv√°lido, a **chave de cache** seria constru√≠da com o **par√¢metro size bem escrito**, mas o **backend** usaria o **valor dentro do par√¢metro codificado na URL**.

![](<../.gitbook/assets/image (180).png>)

Codificar a segunda ocorr√™ncia do par√¢metro `size` fazia com que ele fosse ignorado pelo cache, mas usado pelo backend. Dar ao par√¢metro um valor de 0 resultaria em uma solicita√ß√£o inv√°lida 400 cache√°vel.

### Regras de Agente de Usu√°rio

Devido √† grande quantidade de tr√°fego gerado por ferramentas como FFUF ou Nuclei, alguns desenvolvedores decidiram bloquear solicita√ß√µes que correspondem aos seus agentes de usu√°rio. Ironicamente, esses ajustes podem introduzir oportunidades indesejadas de cria√ß√£o de cache e DoS.

![](<../.gitbook/assets/image (167) (2).png>)

Descobri que isso funcionava em v√°rios alvos, com agentes de usu√°rio de diferentes ferramentas ou scanners.

### Campos de Cabe√ßalho Ilegais

O formato do nome do cabe√ßalho √© definido em [RFC7230](https://datatracker.ietf.mrg/doc/html/rfc7230) da seguinte forma:

![](<../.gitbook/assets/image (175) (2).png>)

Em teoria, se um nome de cabe√ßalho contiver caracteres diferentes dos listados em **tchar**, ele deveria ser rejeitado com uma solicita√ß√£o inv√°lida 400. Na pr√°tica, no entanto, os servidores nem sempre respeitam o RFC. A maneira mais f√°cil de explorar essa nuance era direcionando o Akamai, que n√£o rejeita cabe√ßalhos inv√°lidos, mas os encaminha e armazena em cache qualquer erro 400 desde que o cabe√ßalho cache-control n√£o esteja presente.

![](<../.gitbook/assets/image (163).png>)

O envio de um cabe√ßalho contendo um caractere ilegal, `\`, causaria um erro de solicita√ß√£o inv√°lida 400 cache√°vel. Esse foi um dos padr√µes mais comumente identificados durante meus testes.

### Encontrando novos cabe√ßalhos

[https://gist.github.com/iustin24/92a5ba76ee436c85716f003dda8eecc6](https://gist.github.com/iustin24/92a5ba76ee436c85716f003dda8eecc6)

## Engano de Cache

O objetivo do Engano de Cache √© fazer com que os clientes **carreguem recursos que ser√£o salvos pelo cache com suas informa√ß√µes confidenciais**.

Em primeiro lugar, observe que **extens√µes** como `.css`, `.js`, `.png`, etc., geralmente s√£o **configuradas** para serem **salvas** no **cache**. Portanto, se voc√™ acessar `www.example.com/profile.php/nonexistent.js`, o cache provavelmente armazenar√° a resposta porque ele reconhece a extens√£o `.js`. No entanto, se o **aplicativo** estiver **reproduzindo** com o **conte√∫do sens√≠vel** do usu√°rio armazenado em _www.example.com/profile.php_, voc√™ pode **roubar** esse conte√∫do de outros usu√°rios.

Outras coisas para testar:

* _www.example.com/profile.php/.js_
* _www.example.com/profile.php/.css_
* _www.example.com/profile.php/test.js_
* _www.example.com/profile.php/../test.js_
* _www.example.com/profile.php/%2e%2e/test.js_
* _Use extens√µes menos conhecidas como_ `.avif`

Outro exemplo muito claro pode ser encontrado neste relat√≥rio: [https://hackerone.com/reports/593712](https://hackerone.com/reports/593712).\
No exemplo, √© explicado que se voc√™ carregar uma p√°gina inexistente como _http://www.example.com/home.php/non-existent.css_, o conte√∫do de _http://www.example.com/home.php_ (**com as informa√ß√µes confidenciais do usu√°rio**) ser√° retornado e o servidor de cache salvar√° o resultado.\
Em seguida, o **atacante** pode acessar _http://www.example.com/home.php/non-existent.css_ em seu pr√≥prio navegador e observar as **informa√ß√µes confidenciais** dos usu√°rios que acessaram anteriormente.

Observe que o **proxy de cache** deve ser **configurado** para **armazenar em cache** arquivos **com base na extens√£o** do arquivo (_.css_) e n√£o com base no tipo de conte√∫do. No exemplo, _http://www.example.com/home.php/non-existent.css_ ter√° um tipo de conte√∫do `text/html` em vez de um tipo MIME `text/css` (que √© o esperado para um arquivo _.css_).

Aprenda aqui como realizar ataques de Engano de Cache ao abusar do Contrabando de Requisi√ß√µes HTTP.
## Refer√™ncias

* [https://portswigger.net/web-security/web-cache-poisoning](https://portswigger.net/web-security/web-cache-poisoning)
* [https://portswigger.net/web-security/web-cache-poisoning/exploiting#using-web-cache-poisoning-to-exploit-cookie-handling-vulnerabilities](https://portswigger.net/web-security/web-cache-poisoning/exploiting#using-web-cache-poisoning-to-exploit-cookie-handling-vulnerabilities)
* [https://hackerone.com/reports/593712](https://hackerone.com/reports/593712)
* [https://youst.in/posts/cache-poisoning-at-scale/](https://youst.in/posts/cache-poisoning-at-scale/)
* [https://bxmbn.medium.com/how-i-test-for-web-cache-vulnerabilities-tips-and-tricks-9b138da08ff9](https://bxmbn.medium.com/how-i-test-for-web-cache-vulnerabilities-tips-and-tricks-9b138da08ff9)

<figure><img src="/.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

\
Use [**Trickest**](https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks) para construir e **automatizar fluxos de trabalho** com facilidade, utilizando as ferramentas comunit√°rias mais avan√ßadas do mundo.\
Acesse hoje mesmo:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Gostaria de ver sua **empresa anunciada no HackTricks**? Ou gostaria de ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo Telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
