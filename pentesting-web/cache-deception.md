# Trovanje ke코a i prevara ke코a

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodi캜nu PEASS**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

<figure><img src="../.gitbook/assets/image (45).png" alt=""><figcaption></figcaption></figure>

\
Koristite [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) da biste lako izgradili i **automatizovali tokove rada** pokretane najnaprednijim alatima zajednice na svetu.\
Dobijte pristup danas:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## Razlika

> **Koja je razlika izme캠u trovanja ke코a na vebu i prevare ke코a na vebu?**
>
> * U **trovanju ke코a na vebu**, napada캜 uzrokuje da aplikacija sa캜uva zlonamerni sadr쬬j u ke코u, a ovaj sadr쬬j se servira iz ke코a drugim korisnicima aplikacije.
> * U **prevari ke코a na vebu**, napada캜 uzrokuje da aplikacija sa캜uva osetljiv sadr쬬j koji pripada drugom korisniku u ke코u, a zatim napada캜 preuzima taj sadr쬬j iz ke코a.

## Trovanje ke코a

Trovanje ke코a ima za cilj manipulisanje ke코om na strani klijenta kako bi se naterali klijenti da u캜itavaju resurse koji su neo캜ekivani, delimi캜ni ili pod kontrolom napada캜a. Obim uticaja zavisi od popularnosti pogo캠ene stranice, jer zaga캠eni odgovor se servira isklju캜ivo korisnicima koji pose캖uju stranicu tokom perioda zaga캠enja ke코a.

Izvo캠enje napada trovanja ke코a uklju캜uje nekoliko koraka:

1. **Identifikacija neindeksiranih ulaza**: To su parametri koji, iako nisu potrebni da bi zahtev bio ke코iran, mogu promeniti odgovor koji vra캖a server. Identifikacija ovih ulaza je klju캜na jer ih je mogu캖e iskoristiti za manipulaciju ke코om.
2. **Iskori코캖avanje neindeksiranih ulaza**: Nakon identifikacije neindeksiranih ulaza, slede캖i korak je otkriti kako iskoristiti ove parametre da se izmeni odgovor servera na na캜in koji koristi napada캜u.
3. **Osiguravanje da je zaga캠eni odgovor ke코iran**: Poslednji korak je osigurati da je manipulisani odgovor sme코ten u ke코u. Na ovaj na캜in, svaki korisnik koji pristupa pogo캠enoj stranici dok je ke코 zaga캠en 캖e dobiti zaga캠eni odgovor.

### Otkrivanje: Provera HTTP zaglavlja

Obi캜no, kada je odgovor **sa캜uvan u ke코u**, postoji **zaglavlje koje to pokazuje**, mo쬰te proveriti na koja zaglavlja treba da obratite pa쬹ju u ovom postu: [**HTTP zaglavlja ke코a**](../network-services-pentesting/pentesting-web/special-http-headers.md#cache-headers).

### Otkrivanje: Ke코iranje koda 400

Ako sumnjate da se odgovor 캜uva u ke코u, mo쬰te poku코ati **slati zahteve sa lo코im zaglavljima**, na koje bi trebalo da se odgovori **status kodom 400**. Zatim poku코ajte da pristupite zahtevu na uobi캜ajen na캜in i ako je **odgovor status kod 400**, znate da je ranjiv (i 캜ak mo쬰te izvesti DoS).\
Lo코e konfigurisano zaglavlje mo쬰 biti samo `\:` kao zaglavlje.\
_Napomena da se ponekad ovi tipovi statusnih kodova ne ke코iraju pa 캖e ovaj test biti beskoristan._

### Otkrivanje: Identifikacija i procena neindeksiranih ulaza

Mo쬰te koristiti [**Param Miner**](https://portswigger.net/bappstore/17d2949a985c4b7ca092728dba871943) da **bruteforce-ujete parametre i zaglavlja** koji mogu **promeniti odgovor stranice**. Na primer, stranica mo쬰 koristiti zaglavlje `X-Forwarded-For` da bi pokazala klijentu da u캜ita skriptu odatle:
```markup
<script type="text/javascript" src="//<X-Forwarded-For_value>/resources/js/tracking.js"></script>
```
### Izazovite 코tetan odgovor sa serverske strane

Sa identifikovanim parametrom/headerom proverite kako se **filtrira** i **gde** se **odra쬬va** ili uti캜e na odgovor iz headera. Mo쬰te li ga zloupotrebiti na bilo koji na캜in (izvr코iti XSS ili u캜itati kontrolisani JS kod? izvr코iti DoS?...)

### Dobijanje ke코iranog odgovora

Kada ste **identifikovali** **stranicu** koja mo쬰 biti zloupotrebljena, koji **parametar**/**header** koristiti i **kako** ga zloupotrebiti, trebate dobiti ke코iranu stranicu. Zavisno od resursa koji poku코avate dobiti u ke코u, ovo mo쬰 potrajati neko vreme, mo쬯a 캖ete morati poku코avati nekoliko sekundi.\
Header **`X-Cache`** u odgovoru mo쬰 biti veoma koristan jer mo쬰 imati vrednost **`miss`** kada zahtev nije bio ke코iran i vrednost **`hit`** kada je ke코iran.\
Header **`Cache-Control`** je tako캠e interesantan kako biste znali da li se resurs ke코ira i kada 캖e slede캖i put resurs ponovo biti ke코iran: `Cache-Control: public, max-age=1800`\
Jo코 jedan interesantan header je **`Vary`**. Ovaj header se 캜esto koristi da **ukazuje na dodatne headere** koji se tretiraju kao **deo klju캜a ke코a** 캜ak i ako obi캜no nisu klju캜ni. Stoga, ako korisnik zna `User-Agent` rtve koju cilja, mo쬰 otrovati ke코 za korisnike koji koriste taj specifi캜an `User-Agent`.\
Jo코 jedan header koji se odnosi na ke코 je **`Age`**. Defini코e vreme u sekundama koliko je objekat bio u ke코u proxy servera.

Prilikom ke코iranja zahteva, budite **oprezni sa headerima koje koristite** jer neki od njih mogu biti **neo캜ekivano kori코캖eni** kao **klju캜ni** i **rtva 캖e morati koristiti isti header**. Uvek **testirajte** Trovanje Ke코a sa **razli캜itim pregleda캜ima** da biste proverili da li radi.

## Primeri eksploatacije

### Najjednostavniji primer

Header poput `X-Forwarded-For` se nefiltrira u odgovoru.\
Mo쬰te poslati osnovni XSS payload i otrovati ke코 tako da 캖e svako ko pristupi stranici biti izlo쬰n XSS napadu:
```markup
GET /en?region=uk HTTP/1.1
Host: innocent-website.com
X-Forwarded-Host: a."><script>alert(1)</script>"
```
### Kori코캖enje trovanja ke코a veb stranica za iskori코캖avanje ranjivosti u rukovanju kola캜i캖ima

Kola캜i캖i tako캠e mogu biti reflektovani u odgovoru stranice. Ako mo쬰te zloupotrebiti to da izazovete XSS na primer, mo쬰te iskoristiti XSS u nekoliko klijenata koji u캜itavaju zlonamerni ke코 odgovor.
```markup
GET / HTTP/1.1
Host: vulnerable.com
Cookie: session=VftzO7ZtiBj5zNLRAuFpXpSQLjS4lBmU; fehost=asd"%2balert(1)%2b"
```
### Trovanje ke코a sa prolazom putanje za kra캠u API klju캜a <a href="#using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities" id="using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities"></a>

[**Ovaj tekst obja코njava**](https://nokline.github.io/bugbounty/2024/02/04/ChatGPT-ATO.html) kako je bilo mogu캖e ukrasti OpenAI API klju캜 sa URL-om poput `https://chat.openai.com/share/%2F..%2Fapi/auth/session?cachebuster=123` jer 캖e sve 코to odgovara `/share/*` biti ke코irano bez normalizacije URL-a od strane Cloudflare-a, 코to je ura캠eno kada je zahtev stigao do veb servera.

### Kori코캖enje vi코e zaglavlja za iskori코캖avanje ranjivosti trovanja ke코a na vebu <a href="#using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities" id="using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities"></a>

Ponekad 캖e vam biti potrebno **iskoristiti nekoliko neindeksiranih unosa** kako biste mogli zloupotrebiti ke코. Na primer, mo쬰te prona캖i **Otvoreno preusmeravanje** ako postavite `X-Forwarded-Host` na domen koji kontroli코ete i `X-Forwarded-Scheme` na `http`. **Ako** je **server** **preusmeravao** sve **HTTP** zahteve **na HTTPS** i koristio zaglavlje `X-Forwarded-Scheme` kao ime domena za preusmeravanje. Mo쬰te kontrolisati gde 캖e stranica biti usmerena preusmeravanjem.
```markup
GET /resources/js/tracking.js HTTP/1.1
Host: acc11fe01f16f89c80556c2b0056002e.web-security-academy.net
X-Forwarded-Host: ac8e1f8f1fb1f8cb80586c1d01d500d3.web-security-academy.net/
X-Forwarded-Scheme: http
```
### Iskori코캖avanje sa ograni캜enim `Vary` zaglavljem

Ako ste otkrili da se zaglavlje **`X-Host`** koristi kao **ime domena za u캜itavanje JS resursa** ali da **`Vary`** zaglavlje u odgovoru ukazuje na **`User-Agent`**. Zatim, trebate prona캖i na캜in da eksfiltrirate User-Agent rtve i otrovate ke코 koriste캖i taj korisni캜ki agent:
```markup
GET / HTTP/1.1
Host: vulnerbale.net
User-Agent: THE SPECIAL USER-AGENT OF THE VICTIM
X-Host: attacker.com
```
### Iskori코캖avanje HTTP Cache Trovanja zloupotrebom HTTP Zahteva Smuggling

Saznajte kako izvesti [Napade Cache Trovanja zloupotrebom HTTP Zahteva Smuggling](http-request-smuggling/#using-http-request-smuggling-to-perform-web-cache-poisoning).

### Automatizovano testiranje za Web Cache Trovanje

[Skener ranjivosti Web Cache-a](https://github.com/Hackmanit/Web-Cache-Vulnerability-Scanner) mo쬰 se koristiti za automatsko testiranje web cache trovanja. Podr쬬va mnoge razli캜ite tehnike i visoko je prilagodljiv.

Primer kori코캖enja: `wcvs -u example.com`

<figure><img src="../.gitbook/assets/image (45).png" alt=""><figcaption></figcaption></figure>

\
Koristite [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) da lako izgradite i **automatizujete radne tokove** pokretane najnaprednijim alatima zajednice na svetu.\
Pristupite danas:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## Ranjivi Primeri

### Apache Traffic Server ([CVE-2021-27577](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-27577))

ATS je prosle캠ivao fragment unutar URL-a bez uklanjanja i generisao klju캜 ke코a koriste캖i samo host, putanju i upit (ignori코u캖i fragment). Dakle, zahtev `/#/../?r=javascript:alert(1)` je poslat backend-u kao `/#/../?r=javascript:alert(1)` i klju캜 ke코a nije sadr쬬vao payload unutar njega, samo host, putanju i upit.

### GitHub CP-DoS

Slanje lo코e vrednosti u zaglavlju content-type izazvalo je ke코iran odgovor 405. Klju캜 ke코a je sadr쬬vao kola캜i캖 tako da je bilo mogu캖e napasti samo neautentifikovane korisnike.

### GitLab + GCP CP-DoS

GitLab koristi GCP bucket-e za skladi코tenje stati캜kog sadr쬬ja. **GCP Bucket-i** podr쬬vaju **zaglavlje `x-http-method-override`**. Tako je bilo mogu캖e poslati zaglavlje `x-http-method-override: HEAD` i otrovati ke코 tako da vrati prazno telo odgovora. Tako캠e je mogao podr쬬vati metod `PURGE`.

### Rack Middleware (Ruby on Rails)

U Ruby on Rails aplikacijama 캜esto se koristi Rack middleware. Svrsishodnost Rack koda je da uzme vrednost zaglavlja **`x-forwarded-scheme`** i postavi je kao 코emu zahteva. Kada se po코alje zaglavlje `x-forwarded-scheme: http`, dolazi do 301 preusmerenja na istu lokaciju, 코to potencijalno mo쬰 izazvati DoS na tom resursu. Dodatno, aplikacija mo쬰 prepoznati zaglavlje `X-forwarded-host` i preusmeriti korisnike na odre캠eni host. Ovo pona코anje mo쬰 dovesti do u캜itavanja JavaScript fajlova sa servera napada캜a, predstavljaju캖i sigurnosni rizik.

### 403 i Skladi코ni Bucket-i

Cloudflare je ranije ke코irao 403 odgovore. Poku코aj pristupa S3 ili Azure Storage Blobs sa neispravnim Autorizacijskim zaglavljima rezultovao bi 403 odgovorom koji bi bio ke코iran. Iako je Cloudflare prestao sa ke코iranjem 403 odgovora, ovo pona코anje mo쬰 jo코 uvek biti prisutno u drugim proxy uslugama.

### Umetanje Klju캜nih Parametara

Ke코ovi 캜esto uklju캜uju odre캠ene GET parametre u klju캜 ke코a. Na primer, Fastly-jev Varnish je ke코irao `size` parametar u zahtevima. Me캠utim, ako je URL-kodirana verzija parametra (npr. `siz%65`) tako캠e poslata sa pogre코nom vredno코캖u, klju캜 ke코a bi bio konstruisan koriste캖i ispravan `size` parametar. Ipak, backend bi obradio vrednost u URL-kodiranom parametru. URL-kodiranje drugog `size` parametra dovelo je do njegovog izostavljanja iz ke코a, ali njegovo kori코캖enje od strane backend-a. Dodeljivanje vrednosti 0 ovom parametru rezultiralo je ke코iranjem gre코ke 400 Bad Request.

### Pravila Korisni캜kog Agent

Neki programeri blokiraju zahteve sa korisni캜kim agentima koji se podudaraju sa onima visokoprometnih alata poput FFUF-a ili Nuclei-a radi upravljanja optere캖enjem servera. Ironi캜no, ovaj pristup mo쬰 uvesti ranjivosti poput ke코 trovanja i DoS-a.

### Nezakonita Polja Zaglavlja

[RFC7230](https://datatracker.ietf.mrg/doc/html/rfc7230) specificira prihvatljive karaktere u imenima zaglavlja. Zaglavlja koja sadr쬰 karaktere van navedenog opsega **tchar** bi idealno trebala izazvati odgovor 400 Bad Request. U praksi, serveri se ne pridr쬬vaju uvek ovog standarda. Zna캜ajan primer je Akamai, koji prosle캠uje zaglavlja sa neva쬰캖im karakterima i ke코ira bilo koju gre코ku 400, sve dok zaglavlje `cache-control` nije prisutno. Identifikovan je iskoristiv obrazac gde slanje zaglavlja sa neva쬰캖im karakterom, poput `\`, rezultuje ke코iranjem gre코ke 400 Bad Request.

### Pronala쬰nje novih zaglavlja

[https://gist.github.com/iustin24/92a5ba76ee436c85716f003dda8eecc6](https://gist.github.com/iustin24/92a5ba76ee436c85716f003dda8eecc6)

## Cache Prevara

Cilj Cache Prevara je da natera klijente da **u캜itavaju resurse koji 캖e biti sa캜uvani u ke코u sa njihovim osetljivim informacijama**.

Pre svega, napomenimo da su **ekstenzije** poput `.css`, `.js`, `.png` itd. obi캜no **konfigurisane** da se **sa캜uvaju** u **ke코u**. Stoga, ako pristupite `www.example.com/profile.php/nonexistent.js`, ke코 캖e verovatno sa캜uvati odgovor jer vidi ekstenziju `.js`. Me캠utim, ako **aplikacija** ponavlja sa **osetljivim** korisni캜kim sadr쬬jima sa캜uvanim u _www.example.com/profile.php_, mo쬰te **ukrasti** te sadr쬬je od drugih korisnika.

Drugi testovi:

* _www.example.com/profile.php/.js_
* _www.example.com/profile.php/.css_
* _www.example.com/profile.php/test.js_
* _www.example.com/profile.php/../test.js_
* _www.example.com/profile.php/%2e%2e/test.js_
* _Koristite manje poznate ekstenzije poput_ `.avif`

Jo코 jedan veoma jasan primer mo쬰 se na캖i u ovom opisu: [https://hackerone.com/reports/593712](https://hackerone.com/reports/593712).\
U primeru je obja코njeno da ako u캜itate nepostoje캖u stranicu poput _http://www.example.com/home.php/non-existent.css_ sadr쬬j _http://www.example.com/home.php_ (**sa osetljivim informacijama korisnika**) 캖e biti vra캖en i ke코 server 캖e sa캜uvati rezultat.\
Zatim, **napada캜** mo쬰 pristupiti _http://www.example.com/home.php/non-existent.css_ u svom pregleda캜u i posmatrati **poverljive informacije** korisnika koji su pristupili pre toga.

Napomena je da bi **ke코 proxy** trebalo da bude **konfigurisan** da **ke코ira** fajlove **na osnovu** ekstenzije fajla (_.css_) a ne na osnovu tipa sadr쬬ja. U primeru _http://www.example.com/home.php/non-existent.css_ 캖e imati `text/html` tip sadr쬬ja umesto `text/css` mime tipa (코to se o캜ekuje za _.css_ fajl).

Saznajte kako izvesti [Napade Cache Prevara zloupotrebom HTTP Zahteva Smuggling](http-request-smuggling/#using-http-request-smuggling-to-perform-web-cache-deception).

## Automatski Alati

* [**toxicache**](https://github.com/xhzeem/toxicache): Golang skener za pronala쬰nje ranjivosti web cache trovanja na listi URL-ova i testiranje vi코e tehnika ubacivanja.

## Reference

* [https://portswigger.net/web-security/web-cache-poisoning](https://portswigger.net/web-security/web-cache-poisoning)
* [https://portswigger.net/web-security/web-cache-poisoning/exploiting#using-web-cache-poisoning-to-exploit-cookie-handling-vulnerabilities](https://portswigger.net/web-security/web-cache-poisoning/exploiting#using-web-cache-poisoning-to-exploit-cookie-handling-vulnerabilities)
* [https://hackerone.com/reports/593712](https://hackerone.com/reports/593712)
* [https://youst.in/posts/cache-poisoning-at-scale/](https://youst.in/posts/cache-poisoning-at-scale/)
* [https://bxmbn.medium.com/how-i-test-for-web-cache-vulnerabilities-tips-and-tricks-9b138da08ff9](https://bxmbn.medium.com/how-i-test-for-web-cache-vulnerabilities-tips-and-tricks-9b138da08ff9)
* [https://www.linkedin.com/pulse/how-i-hacked-all-zendesk-sites-265000-site-one-line-abdalhfaz/](https://www.linkedin.com/pulse/how-i-hacked-all-zendesk-sites-265000-site-one-line-abdalhfaz/)

<figure><img src="../.gitbook/assets/image (45).png" alt=""><figcaption></figcaption></figure>

\
Koristite [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) da lako izgradite i **automatizujete radne tokove** pokretane najnaprednijim alatima zajednice na svetu.\
Pristupite danas:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>
<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJATELJE**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.
