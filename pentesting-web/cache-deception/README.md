# Cache Poisoning and Cache Deception

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

<figure><img src="../../.gitbook/assets/image (48).png" alt=""><figcaption></figcaption></figure>

\
ä½¿ç”¨ [**Trickest**](https://trickest.com/?utm\_source=hacktricks\&utm\_medium=text\&utm\_campaign=ppc\&utm\_term=trickest\&utm\_content=cache-deception) è½»æ¾æ„å»ºå’Œ **è‡ªåŠ¨åŒ–å·¥ä½œæµ**ï¼Œç”±ä¸–ç•Œä¸Š **æœ€å…ˆè¿›** çš„ç¤¾åŒºå·¥å…·æä¾›æ”¯æŒã€‚\
ä»Šå¤©å°±è·å–è®¿é—®æƒé™ï¼š

{% embed url="https://trickest.com/?utm_source=hacktricks&utm_medium=banner&utm_campaign=ppc&utm_content=cache-deception" %}

## The difference

> **Web ç¼“å­˜ä¸­æ¯’å’Œ Web ç¼“å­˜æ¬ºéª—ä¹‹é—´æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**
>
> * åœ¨ **Web ç¼“å­˜ä¸­æ¯’** ä¸­ï¼Œæ”»å‡»è€…ä½¿åº”ç”¨ç¨‹åºåœ¨ç¼“å­˜ä¸­å­˜å‚¨ä¸€äº›æ¶æ„å†…å®¹ï¼Œå¹¶ä¸”è¿™äº›å†…å®¹ä»ç¼“å­˜ä¸­æä¾›ç»™å…¶ä»–åº”ç”¨ç¨‹åºç”¨æˆ·ã€‚
> * åœ¨ **Web ç¼“å­˜æ¬ºéª—** ä¸­ï¼Œæ”»å‡»è€…ä½¿åº”ç”¨ç¨‹åºåœ¨ç¼“å­˜ä¸­å­˜å‚¨å±äºå¦ä¸€ä¸ªç”¨æˆ·çš„ä¸€äº›æ•æ„Ÿå†…å®¹ï¼Œç„¶åæ”»å‡»è€…ä»ç¼“å­˜ä¸­æ£€ç´¢è¿™äº›å†…å®¹ã€‚

## Cache Poisoning

ç¼“å­˜ä¸­æ¯’æ—¨åœ¨æ“çºµå®¢æˆ·ç«¯ç¼“å­˜ï¼Œå¼ºè¿«å®¢æˆ·ç«¯åŠ è½½æ„å¤–ã€éƒ¨åˆ†æˆ–ç”±æ”»å‡»è€…æ§åˆ¶çš„èµ„æºã€‚å½±å“çš„ç¨‹åº¦å–å†³äºå—å½±å“é¡µé¢çš„å—æ¬¢è¿ç¨‹åº¦ï¼Œå› ä¸ºè¢«æ±¡æŸ“çš„å“åº”ä»…åœ¨ç¼“å­˜æ±¡æŸ“æœŸé—´æä¾›ç»™è®¿é—®è¯¥é¡µé¢çš„ç”¨æˆ·ã€‚

æ‰§è¡Œç¼“å­˜ä¸­æ¯’æ”»å‡»æ¶‰åŠå‡ ä¸ªæ­¥éª¤ï¼š

1. **è¯†åˆ«æ— é”®è¾“å…¥**ï¼šè¿™äº›æ˜¯å‚æ•°ï¼Œå°½ç®¡ä¸æ˜¯ç¼“å­˜è¯·æ±‚æ‰€å¿…éœ€çš„ï¼Œä½†å¯ä»¥æ”¹å˜æœåŠ¡å™¨è¿”å›çš„å“åº”ã€‚è¯†åˆ«è¿™äº›è¾“å…¥è‡³å…³é‡è¦ï¼Œå› ä¸ºå®ƒä»¬å¯ä»¥è¢«åˆ©ç”¨æ¥æ“çºµç¼“å­˜ã€‚
2. **åˆ©ç”¨æ— é”®è¾“å…¥**ï¼šåœ¨è¯†åˆ«æ— é”®è¾“å…¥åï¼Œä¸‹ä¸€æ­¥æ˜¯å¼„æ¸…æ¥šå¦‚ä½•æ»¥ç”¨è¿™äº›å‚æ•°ï¼Œä»¥ä¿®æ”¹æœåŠ¡å™¨çš„å“åº”ï¼Œä»è€Œä½¿æ”»å‡»è€…å—ç›Šã€‚
3. **ç¡®ä¿è¢«æ±¡æŸ“çš„å“åº”è¢«ç¼“å­˜**ï¼šæœ€åä¸€æ­¥æ˜¯ç¡®ä¿è¢«æ“çºµçš„å“åº”è¢«å­˜å‚¨åœ¨ç¼“å­˜ä¸­ã€‚è¿™æ ·ï¼Œä»»ä½•åœ¨ç¼“å­˜è¢«æ±¡æŸ“æ—¶è®¿é—®å—å½±å“é¡µé¢çš„ç”¨æˆ·å°†æ”¶åˆ°è¢«æ±¡æŸ“çš„å“åº”ã€‚

### Discovery: Check HTTP headers

é€šå¸¸ï¼Œå½“å“åº”è¢« **å­˜å‚¨åœ¨ç¼“å­˜ä¸­** æ—¶ï¼Œä¼šæœ‰ä¸€ä¸ª **æŒ‡ç¤ºçš„å¤´éƒ¨**ï¼Œæ‚¨å¯ä»¥åœ¨æ­¤å¸–å­ä¸­æ£€æŸ¥æ‚¨åº”è¯¥å…³æ³¨å“ªäº›å¤´éƒ¨ï¼š[**HTTP ç¼“å­˜å¤´éƒ¨**](../../network-services-pentesting/pentesting-web/special-http-headers.md#cache-headers)ã€‚

### Discovery: Caching error codes

å¦‚æœæ‚¨è®¤ä¸ºå“åº”æ­£åœ¨è¢«å­˜å‚¨åœ¨ç¼“å­˜ä¸­ï¼Œæ‚¨å¯ä»¥å°è¯• **å‘é€å¸¦æœ‰é”™è¯¯å¤´éƒ¨çš„è¯·æ±‚**ï¼Œè¿™åº”è¯¥ä¼šä»¥ **çŠ¶æ€ç  400** å“åº”ã€‚ç„¶åå°è¯•æ­£å¸¸è®¿é—®è¯·æ±‚ï¼Œå¦‚æœ **å“åº”æ˜¯ 400 çŠ¶æ€ç **ï¼Œæ‚¨å°±çŸ¥é“å®ƒæ˜¯è„†å¼±çš„ï¼ˆæ‚¨ç”šè‡³å¯ä»¥æ‰§è¡Œ DoSï¼‰ã€‚

æ‚¨å¯ä»¥åœ¨ä»¥ä¸‹ä½ç½®æ‰¾åˆ°æ›´å¤šé€‰é¡¹ï¼š

{% content-ref url="cache-poisoning-to-dos.md" %}
[cache-poisoning-to-dos.md](cache-poisoning-to-dos.md)
{% endcontent-ref %}

ä½†æ˜¯ï¼Œè¯·æ³¨æ„ **æœ‰æ—¶è¿™äº›çŠ¶æ€ç ä¸ä¼šè¢«ç¼“å­˜**ï¼Œå› æ­¤æ­¤æµ‹è¯•å¯èƒ½ä¸å¯é ã€‚

### Discovery: Identify and evaluate unkeyed inputs

æ‚¨å¯ä»¥ä½¿ç”¨ [**Param Miner**](https://portswigger.net/bappstore/17d2949a985c4b7ca092728dba871943) æ¥ **æš´åŠ›ç ´è§£å¯èƒ½ **æ”¹å˜é¡µé¢å“åº”** çš„å‚æ•°å’Œå¤´éƒ¨ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªé¡µé¢å¯èƒ½ä½¿ç”¨å¤´éƒ¨ `X-Forwarded-For` æ¥æŒ‡ç¤ºå®¢æˆ·ç«¯ä»é‚£é‡ŒåŠ è½½è„šæœ¬ï¼š
```markup
<script type="text/javascript" src="//<X-Forwarded-For_value>/resources/js/tracking.js"></script>
```
### å¼•å‘åç«¯æœåŠ¡å™¨çš„æœ‰å®³å“åº”

é€šè¿‡è¯†åˆ«çš„å‚æ•°/å¤´éƒ¨æ£€æŸ¥å®ƒæ˜¯å¦‚ä½•è¢«**æ¸…ç†**çš„ï¼Œä»¥åŠ**åœ¨å“ªé‡Œ**å®ƒ**è¢«åæ˜ **æˆ–å½±å“å¤´éƒ¨çš„å“åº”ã€‚ä½ èƒ½ä»¥ä»»ä½•æ–¹å¼æ»¥ç”¨å®ƒå—ï¼ˆæ‰§è¡ŒXSSæˆ–åŠ è½½ä½ æ§åˆ¶çš„JSä»£ç ï¼Ÿæ‰§è¡ŒDoSï¼Ÿ...ï¼‰

### è·å–å“åº”ç¼“å­˜

ä¸€æ—¦ä½ **è¯†åˆ«**äº†å¯ä»¥è¢«æ»¥ç”¨çš„**é¡µé¢**ï¼Œä½¿ç”¨å“ªä¸ª**å‚æ•°**/**å¤´éƒ¨**ä»¥åŠ**å¦‚ä½•**æ»¥ç”¨å®ƒï¼Œä½ éœ€è¦è®©é¡µé¢è¢«ç¼“å­˜ã€‚æ ¹æ®ä½ å°è¯•ç¼“å­˜çš„èµ„æºï¼Œè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ï¼Œä½ å¯èƒ½éœ€è¦å°è¯•å‡ ç§’é’Ÿã€‚

å“åº”ä¸­çš„å¤´éƒ¨**`X-Cache`**å¯èƒ½éå¸¸æœ‰ç”¨ï¼Œå› ä¸ºå½“è¯·æ±‚æœªè¢«ç¼“å­˜æ—¶ï¼Œå®ƒçš„å€¼å¯èƒ½æ˜¯**`miss`**ï¼Œè€Œå½“å®ƒè¢«ç¼“å­˜æ—¶ï¼Œå€¼ä¸º**`hit`**ã€‚\
å¤´éƒ¨**`Cache-Control`**ä¹Ÿå¾ˆæœ‰è¶£ï¼Œå¯ä»¥çŸ¥é“èµ„æºæ˜¯å¦è¢«ç¼“å­˜ï¼Œä»¥åŠä¸‹æ¬¡èµ„æºå°†ä½•æ—¶å†æ¬¡è¢«ç¼“å­˜ï¼š`Cache-Control: public, max-age=1800`

å¦ä¸€ä¸ªæœ‰è¶£çš„å¤´éƒ¨æ˜¯**`Vary`**ã€‚è¿™ä¸ªå¤´éƒ¨é€šå¸¸ç”¨äº**æŒ‡ç¤ºé¢å¤–çš„å¤´éƒ¨**ï¼Œè¿™äº›å¤´éƒ¨è¢«è§†ä¸º**ç¼“å­˜é”®çš„ä¸€éƒ¨åˆ†**ï¼Œå³ä½¿å®ƒä»¬é€šå¸¸æ²¡æœ‰é”®ã€‚å› æ­¤ï¼Œå¦‚æœç”¨æˆ·çŸ¥é“ä»–æ‰€é’ˆå¯¹çš„å—å®³è€…çš„`User-Agent`ï¼Œä»–å¯ä»¥ä¸ºä½¿ç”¨è¯¥ç‰¹å®š`User-Agent`çš„ç”¨æˆ·æ¯’åŒ–ç¼“å­˜ã€‚

ä¸ç¼“å­˜ç›¸å…³çš„å¦ä¸€ä¸ªå¤´éƒ¨æ˜¯**`Age`**ã€‚å®ƒå®šä¹‰äº†å¯¹è±¡åœ¨ä»£ç†ç¼“å­˜ä¸­å­˜åœ¨çš„æ—¶é—´ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ã€‚

åœ¨ç¼“å­˜è¯·æ±‚æ—¶ï¼Œè¦**å°å¿ƒä½¿ç”¨çš„å¤´éƒ¨**ï¼Œå› ä¸ºå…¶ä¸­ä¸€äº›å¯èƒ½ä¼šè¢«**æ„å¤–ä½¿ç”¨**ä¸º**é”®**ï¼Œè€Œ**å—å®³è€…éœ€è¦ä½¿ç”¨ç›¸åŒçš„å¤´éƒ¨**ã€‚å§‹ç»ˆä½¿ç”¨**ä¸åŒçš„æµè§ˆå™¨æµ‹è¯•**ç¼“å­˜ä¸­æ¯’æ˜¯å¦æœ‰æ•ˆã€‚

## åˆ©ç”¨ç¤ºä¾‹

### æœ€ç®€å•çš„ç¤ºä¾‹

åƒ`X-Forwarded-For`è¿™æ ·çš„å¤´éƒ¨åœ¨å“åº”ä¸­æœªç»è¿‡æ¸…ç†åœ°è¢«åæ˜ ã€‚\
ä½ å¯ä»¥å‘é€ä¸€ä¸ªåŸºæœ¬çš„XSSæœ‰æ•ˆè´Ÿè½½å¹¶æ¯’åŒ–ç¼“å­˜ï¼Œè¿™æ ·æ¯ä¸ªè®¿é—®è¯¥é¡µé¢çš„äººéƒ½ä¼šå—åˆ°XSSæ”»å‡»ï¼š
```markup
GET /en?region=uk HTTP/1.1
Host: innocent-website.com
X-Forwarded-Host: a."><script>alert(1)</script>"
```
_Note that this will poison a request to `/en?region=uk` not to `/en`_

### Cache poisoning to DoS

{% content-ref url="cache-poisoning-to-dos.md" %}
[cache-poisoning-to-dos.md](cache-poisoning-to-dos.md)
{% endcontent-ref %}

### ä½¿ç”¨ç½‘ç»œç¼“å­˜ä¸­æ¯’æ¥åˆ©ç”¨ cookie å¤„ç†æ¼æ´

Cookies ä¹Ÿå¯èƒ½åœ¨é¡µé¢çš„å“åº”ä¸­è¢«åå°„ã€‚å¦‚æœä½ èƒ½åˆ©ç”¨å®ƒé€ æˆ XSSï¼Œä¾‹å¦‚ï¼Œä½ å¯èƒ½èƒ½å¤Ÿåœ¨åŠ è½½æ¶æ„ç¼“å­˜å“åº”çš„å¤šä¸ªå®¢æˆ·ç«¯ä¸­åˆ©ç”¨ XSSã€‚
```markup
GET / HTTP/1.1
Host: vulnerable.com
Cookie: session=VftzO7ZtiBj5zNLRAuFpXpSQLjS4lBmU; fehost=asd"%2balert(1)%2b"
```
æ³¨æ„ï¼Œå¦‚æœæ˜“å—æ”»å‡»çš„ cookie è¢«ç”¨æˆ·é¢‘ç¹ä½¿ç”¨ï¼Œå¸¸è§„è¯·æ±‚å°†æ¸…é™¤ç¼“å­˜ã€‚

### ä½¿ç”¨åˆ†éš”ç¬¦ã€è§„èŒƒåŒ–å’Œç‚¹ç”Ÿæˆå·®å¼‚ <a href="#using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities" id="using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities"></a>

æ£€æŸ¥ï¼š

{% content-ref url="cache-poisoning-via-url-discrepancies.md" %}
[cache-poisoning-via-url-discrepancies.md](cache-poisoning-via-url-discrepancies.md)
{% endcontent-ref %}

### é€šè¿‡è·¯å¾„éå†è¿›è¡Œç¼“å­˜ä¸­æ¯’ä»¥çªƒå– API å¯†é’¥ <a href="#using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities" id="using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities"></a>

[**è¿™ç¯‡æ–‡ç« è§£é‡Šäº†**](https://nokline.github.io/bugbounty/2024/02/04/ChatGPT-ATO.html) å¦‚ä½•é€šè¿‡ä¸€ä¸ªåƒ `https://chat.openai.com/share/%2F..%2Fapi/auth/session?cachebuster=123` çš„ URL çªƒå– OpenAI API å¯†é’¥ï¼Œå› ä¸ºä»»ä½•åŒ¹é… `/share/*` çš„å†…å®¹éƒ½ä¼šè¢«ç¼“å­˜ï¼Œè€Œ Cloudflare ä¸ä¼šå¯¹ URL è¿›è¡Œè§„èŒƒåŒ–ï¼Œè¿™åœ¨è¯·æ±‚åˆ°è¾¾ web æœåŠ¡å™¨æ—¶å®Œæˆã€‚

è¿™åœ¨ä»¥ä¸‹å†…å®¹ä¸­ä¹Ÿæœ‰æ›´å¥½çš„è§£é‡Šï¼š

{% content-ref url="cache-poisoning-via-url-discrepancies.md" %}
[cache-poisoning-via-url-discrepancies.md](cache-poisoning-via-url-discrepancies.md)
{% endcontent-ref %}

### ä½¿ç”¨å¤šä¸ªå¤´éƒ¨æ¥åˆ©ç”¨ web ç¼“å­˜ä¸­æ¯’æ¼æ´ <a href="#using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities" id="using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities"></a>

æœ‰æ—¶æ‚¨éœ€è¦ **åˆ©ç”¨å¤šä¸ªæœªé”®å…¥çš„è¾“å…¥** æ¥æ»¥ç”¨ç¼“å­˜ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨å°† `X-Forwarded-Host` è®¾ç½®ä¸ºæ‚¨æ§åˆ¶çš„åŸŸåï¼Œå¹¶å°† `X-Forwarded-Scheme` è®¾ç½®ä¸º `http`ï¼Œæ‚¨å¯èƒ½ä¼šå‘ç°ä¸€ä¸ª **å¼€æ”¾é‡å®šå‘**ã€‚**å¦‚æœ** æœåŠ¡å™¨ **å°†æ‰€æœ‰ HTTP è¯·æ±‚è½¬å‘åˆ° HTTPS** å¹¶ä½¿ç”¨å¤´éƒ¨ `X-Forwarded-Scheme` ä½œä¸ºé‡å®šå‘çš„åŸŸåã€‚æ‚¨å¯ä»¥æ§åˆ¶é‡å®šå‘æŒ‡å‘çš„é¡µé¢ã€‚
```markup
GET /resources/js/tracking.js HTTP/1.1
Host: acc11fe01f16f89c80556c2b0056002e.web-security-academy.net
X-Forwarded-Host: ac8e1f8f1fb1f8cb80586c1d01d500d3.web-security-academy.net/
X-Forwarded-Scheme: http
```
### åˆ©ç”¨æœ‰é™çš„ `Vary`å¤´

å¦‚æœä½ å‘ç° **`X-Host`** å¤´è¢«ç”¨ä½œ **åŠ è½½ JS èµ„æºçš„åŸŸå**ï¼Œä½†å“åº”ä¸­çš„ **`Vary`** å¤´æŒ‡ç¤º **`User-Agent`**ã€‚é‚£ä¹ˆï¼Œä½ éœ€è¦æ‰¾åˆ°ä¸€ç§æ–¹æ³•æ¥æå–å—å®³è€…çš„ User-Agentï¼Œå¹¶ä½¿ç”¨è¯¥ç”¨æˆ·ä»£ç†æ¥æ±¡æŸ“ç¼“å­˜ï¼š
```markup
GET / HTTP/1.1
Host: vulnerbale.net
User-Agent: THE SPECIAL USER-AGENT OF THE VICTIM
X-Host: attacker.com
```
### Fat Get

å‘é€ä¸€ä¸ªå¸¦æœ‰è¯·æ±‚çš„ GET è¯·æ±‚ï¼ŒURL å’Œè¯·æ±‚ä½“ä¸­éƒ½åŒ…å«è¯¥è¯·æ±‚ã€‚å¦‚æœ web æœåŠ¡å™¨ä½¿ç”¨è¯·æ±‚ä½“ä¸­çš„å†…å®¹ï¼Œä½†ç¼“å­˜æœåŠ¡å™¨ç¼“å­˜äº† URL ä¸­çš„å†…å®¹ï¼Œé‚£ä¹ˆä»»ä½•è®¿é—®è¯¥ URL çš„äººå®é™…ä¸Šå°†ä½¿ç”¨è¯·æ±‚ä½“ä¸­çš„å‚æ•°ã€‚å°±åƒ James Kettle åœ¨ Github ç½‘ç«™ä¸Šå‘ç°çš„æ¼æ´ï¼š
```
GET /contact/report-abuse?report=albinowax HTTP/1.1
Host: github.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 22

report=innocent-victim
```
There it a portswigger lab about this: [https://portswigger.net/web-security/web-cache-poisoning/exploiting-implementation-flaws/lab-web-cache-poisoning-fat-get](https://portswigger.net/web-security/web-cache-poisoning/exploiting-implementation-flaws/lab-web-cache-poisoning-fat-get)

### å‚æ•°ä¼ªè£…

ä¾‹å¦‚ï¼Œåœ¨ ruby æœåŠ¡å™¨ä¸­ï¼Œå¯ä»¥ä½¿ç”¨å­—ç¬¦ **`;`** æ¥åˆ†éš” **å‚æ•°**ï¼Œè€Œä¸æ˜¯ **`&`**ã€‚è¿™å¯ä»¥ç”¨æ¥å°†æ— é”®å‚æ•°å€¼æ”¾å…¥æœ‰é”®å‚æ•°ä¸­å¹¶åŠ ä»¥åˆ©ç”¨ã€‚

Portswigger lab: [https://portswigger.net/web-security/web-cache-poisoning/exploiting-implementation-flaws/lab-web-cache-poisoning-param-cloaking](https://portswigger.net/web-security/web-cache-poisoning/exploiting-implementation-flaws/lab-web-cache-poisoning-param-cloaking)

### é€šè¿‡æ»¥ç”¨ HTTP è¯·æ±‚èµ°ç§æ¥åˆ©ç”¨ HTTP ç¼“å­˜ä¸­æ¯’

åœ¨è¿™é‡Œäº†è§£å¦‚ä½•é€šè¿‡æ»¥ç”¨ [HTTP è¯·æ±‚èµ°ç§è¿›è¡Œç¼“å­˜ä¸­æ¯’æ”»å‡»](../http-request-smuggling/#using-http-request-smuggling-to-perform-web-cache-poisoning)ã€‚

### Web ç¼“å­˜ä¸­æ¯’çš„è‡ªåŠ¨åŒ–æµ‹è¯•

[Web Cache Vulnerability Scanner](https://github.com/Hackmanit/Web-Cache-Vulnerability-Scanner) å¯ç”¨äºè‡ªåŠ¨æµ‹è¯• Web ç¼“å­˜ä¸­æ¯’ã€‚å®ƒæ”¯æŒå¤šç§ä¸åŒçš„æŠ€æœ¯ï¼Œå¹¶ä¸”é«˜åº¦å¯å®šåˆ¶ã€‚

ç¤ºä¾‹ç”¨æ³•: `wcvs -u example.com`

## æ¼æ´ç¤ºä¾‹

### Apache Traffic Server ([CVE-2021-27577](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-27577))

ATS åœ¨ URL ä¸­è½¬å‘äº†ç‰‡æ®µè€Œæ²¡æœ‰å»æ‰å®ƒï¼Œå¹¶ä»…ä½¿ç”¨ä¸»æœºã€è·¯å¾„å’ŒæŸ¥è¯¢ç”Ÿæˆç¼“å­˜é”®ï¼ˆå¿½ç•¥ç‰‡æ®µï¼‰ã€‚å› æ­¤ï¼Œè¯·æ±‚ `/#/../?r=javascript:alert(1)` è¢«å‘é€åˆ°åç«¯ä¸º `/#/../?r=javascript:alert(1)`ï¼Œè€Œç¼“å­˜é”®ä¸­æ²¡æœ‰è´Ÿè½½ï¼Œåªæœ‰ä¸»æœºã€è·¯å¾„å’ŒæŸ¥è¯¢ã€‚

### GitHub CP-DoS

åœ¨å†…å®¹ç±»å‹å¤´ä¸­å‘é€é”™è¯¯å€¼è§¦å‘äº† 405 ç¼“å­˜å“åº”ã€‚ç¼“å­˜é”®åŒ…å« cookieï¼Œå› æ­¤åªèƒ½æ”»å‡»æœªæˆæƒç”¨æˆ·ã€‚

### GitLab + GCP CP-DoS

GitLab ä½¿ç”¨ GCP å­˜å‚¨æ¡¶æ¥å­˜å‚¨é™æ€å†…å®¹ã€‚**GCP å­˜å‚¨æ¡¶** æ”¯æŒ **å¤´éƒ¨ `x-http-method-override`**ã€‚å› æ­¤ï¼Œå¯ä»¥å‘é€å¤´éƒ¨ `x-http-method-override: HEAD` å¹¶ä½¿ç¼“å­˜è¿”å›ç©ºå“åº”ä½“ã€‚å®ƒè¿˜å¯ä»¥æ”¯æŒ `PURGE` æ–¹æ³•ã€‚

### Rack ä¸­é—´ä»¶ (Ruby on Rails)

åœ¨ Ruby on Rails åº”ç”¨ç¨‹åºä¸­ï¼Œé€šå¸¸ä½¿ç”¨ Rack ä¸­é—´ä»¶ã€‚Rack ä»£ç çš„ç›®çš„æ˜¯è·å– **`x-forwarded-scheme`** å¤´çš„å€¼å¹¶å°†å…¶è®¾ç½®ä¸ºè¯·æ±‚çš„æ–¹æ¡ˆã€‚å½“å‘é€å¤´ `x-forwarded-scheme: http` æ—¶ï¼Œä¼šå‘ç”Ÿ 301 é‡å®šå‘åˆ°ç›¸åŒä½ç½®ï¼Œå¯èƒ½å¯¼è‡´è¯¥èµ„æºçš„æ‹’ç»æœåŠ¡ (DoS)ã€‚æ­¤å¤–ï¼Œåº”ç”¨ç¨‹åºå¯èƒ½ä¼šè¯†åˆ« `X-forwarded-host` å¤´å¹¶å°†ç”¨æˆ·é‡å®šå‘åˆ°æŒ‡å®šä¸»æœºã€‚è¿™ç§è¡Œä¸ºå¯èƒ½å¯¼è‡´ä»æ”»å‡»è€…çš„æœåŠ¡å™¨åŠ è½½ JavaScript æ–‡ä»¶ï¼Œæ„æˆå®‰å…¨é£é™©ã€‚

### 403 å’Œå­˜å‚¨æ¡¶

Cloudflare ä¹‹å‰ç¼“å­˜äº† 403 å“åº”ã€‚å°è¯•ä½¿ç”¨é”™è¯¯çš„æˆæƒå¤´è®¿é—® S3 æˆ– Azure å­˜å‚¨ Blob ä¼šå¯¼è‡´ 403 å“åº”è¢«ç¼“å­˜ã€‚å°½ç®¡ Cloudflare å·²åœæ­¢ç¼“å­˜ 403 å“åº”ï¼Œä½†è¿™ç§è¡Œä¸ºå¯èƒ½ä»ç„¶å­˜åœ¨äºå…¶ä»–ä»£ç†æœåŠ¡ä¸­ã€‚

### æ³¨å…¥é”®å‚æ•°

ç¼“å­˜é€šå¸¸åœ¨ç¼“å­˜é”®ä¸­åŒ…å«ç‰¹å®šçš„ GET å‚æ•°ã€‚ä¾‹å¦‚ï¼ŒFastly çš„ Varnish åœ¨è¯·æ±‚ä¸­ç¼“å­˜äº† `size` å‚æ•°ã€‚ç„¶è€Œï¼Œå¦‚æœå‘é€äº† URL ç¼–ç ç‰ˆæœ¬çš„å‚æ•°ï¼ˆä¾‹å¦‚ï¼Œ`siz%65`ï¼‰å¹¶ä¸”å€¼é”™è¯¯ï¼Œç¼“å­˜é”®å°†ä½¿ç”¨æ­£ç¡®çš„ `size` å‚æ•°æ„å»ºã€‚ç„¶è€Œï¼Œåç«¯å°†å¤„ç† URL ç¼–ç å‚æ•°ä¸­çš„å€¼ã€‚å¯¹ç¬¬äºŒä¸ª `size` å‚æ•°è¿›è¡Œ URL ç¼–ç å¯¼è‡´ç¼“å­˜çœç•¥äº†å®ƒï¼Œä½†åç«¯ä½¿ç”¨äº†å®ƒã€‚å°†è¯¥å‚æ•°çš„å€¼è®¾ç½®ä¸º 0 ä¼šå¯¼è‡´å¯ç¼“å­˜çš„ 400 é”™è¯¯è¯·æ±‚ã€‚

### ç”¨æˆ·ä»£ç†è§„åˆ™

ä¸€äº›å¼€å‘äººå‘˜é˜»æ­¢ä¸é«˜æµé‡å·¥å…·ï¼ˆå¦‚ FFUF æˆ– Nucleiï¼‰åŒ¹é…çš„ç”¨æˆ·ä»£ç†çš„è¯·æ±‚ï¼Œä»¥ç®¡ç†æœåŠ¡å™¨è´Ÿè½½ã€‚è®½åˆºçš„æ˜¯ï¼Œè¿™ç§æ–¹æ³•å¯èƒ½å¼•å…¥æ¼æ´ï¼Œä¾‹å¦‚ç¼“å­˜ä¸­æ¯’å’Œ DoSã€‚

### éæ³•å¤´å­—æ®µ

[RFC7230](https://datatracker.ietf.mrg/doc/html/rfc7230) æŒ‡å®šäº†å¤´åç§°ä¸­å¯æ¥å—çš„å­—ç¬¦ã€‚åŒ…å«è¶…å‡ºæŒ‡å®š **tchar** èŒƒå›´çš„å­—ç¬¦çš„å¤´ç†æƒ³æƒ…å†µä¸‹åº”è§¦å‘ 400 é”™è¯¯è¯·æ±‚å“åº”ã€‚åœ¨å®è·µä¸­ï¼ŒæœåŠ¡å™¨å¹¶ä¸æ€»æ˜¯éµå¾ªæ­¤æ ‡å‡†ã€‚ä¸€ä¸ªæ˜¾è‘—çš„ä¾‹å­æ˜¯ Akamaiï¼Œå®ƒè½¬å‘åŒ…å«æ— æ•ˆå­—ç¬¦çš„å¤´ï¼Œå¹¶ç¼“å­˜ä»»ä½• 400 é”™è¯¯ï¼Œåªè¦ `cache-control` å¤´ä¸å­˜åœ¨ã€‚å‘ç°äº†ä¸€ç§å¯åˆ©ç”¨çš„æ¨¡å¼ï¼Œå‘é€å¸¦æœ‰éæ³•å­—ç¬¦ï¼ˆå¦‚ `\`ï¼‰çš„å¤´ä¼šå¯¼è‡´å¯ç¼“å­˜çš„ 400 é”™è¯¯è¯·æ±‚ã€‚

### æŸ¥æ‰¾æ–°å¤´

[https://gist.github.com/iustin24/92a5ba76ee436c85716f003dda8eecc6](https://gist.github.com/iustin24/92a5ba76ee436c85716f003dda8eecc6)

## ç¼“å­˜æ¬ºéª—

ç¼“å­˜æ¬ºéª—çš„ç›®æ ‡æ˜¯ä½¿å®¢æˆ·ç«¯ **åŠ è½½å°†è¢«ç¼“å­˜ä¿å­˜çš„æ•æ„Ÿä¿¡æ¯èµ„æº**ã€‚

é¦–å…ˆè¦æ³¨æ„çš„æ˜¯ï¼Œ**æ‰©å±•å**å¦‚ `.css`ã€`.js`ã€`.png` ç­‰é€šå¸¸è¢« **é…ç½®** ä¸º **ä¿å­˜** åœ¨ **ç¼“å­˜** ä¸­ã€‚å› æ­¤ï¼Œå¦‚æœæ‚¨è®¿é—® `www.example.com/profile.php/nonexistent.js`ï¼Œç¼“å­˜å¯èƒ½ä¼šå­˜å‚¨å“åº”ï¼Œå› ä¸ºå®ƒçœ‹åˆ° `.js` **æ‰©å±•å**ã€‚ä½†æ˜¯ï¼Œå¦‚æœ **åº”ç”¨ç¨‹åº** æ­£åœ¨ **é‡æ”¾** å­˜å‚¨åœ¨ _www.example.com/profile.php_ ä¸­çš„ **æ•æ„Ÿ** ç”¨æˆ·å†…å®¹ï¼Œæ‚¨å¯ä»¥ **çªƒå–** å…¶ä»–ç”¨æˆ·çš„è¿™äº›å†…å®¹ã€‚

å…¶ä»–æµ‹è¯•å†…å®¹ï¼š

* _www.example.com/profile.php/.js_
* _www.example.com/profile.php/.css_
* _www.example.com/profile.php/test.js_
* _www.example.com/profile.php/../test.js_
* _www.example.com/profile.php/%2e%2e/test.js_
* _ä½¿ç”¨ä¸å¤ªå¸¸è§çš„æ‰©å±•åï¼Œå¦‚_ `.avif`

å¦ä¸€ä¸ªéå¸¸æ¸…æ™°çš„ä¾‹å­å¯ä»¥åœ¨è¿™ä¸ªå†™ä½œä¸­æ‰¾åˆ°: [https://hackerone.com/reports/593712](https://hackerone.com/reports/593712)ã€‚\
åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œè§£é‡Šäº†å¦‚æœæ‚¨åŠ è½½ä¸€ä¸ªä¸å­˜åœ¨çš„é¡µé¢ï¼Œå¦‚ _http://www.example.com/home.php/non-existent.css_ï¼Œå°†è¿”å› _http://www.example.com/home.php_ çš„å†…å®¹ï¼ˆ**åŒ…å«ç”¨æˆ·çš„æ•æ„Ÿä¿¡æ¯**ï¼‰ï¼Œå¹¶ä¸”ç¼“å­˜æœåŠ¡å™¨å°†ä¿å­˜ç»“æœã€‚\
ç„¶åï¼Œ**æ”»å‡»è€…**å¯ä»¥åœ¨è‡ªå·±çš„æµè§ˆå™¨ä¸­è®¿é—® _http://www.example.com/home.php/non-existent.css_ å¹¶è§‚å¯Ÿä¹‹å‰è®¿é—®è¿‡çš„ç”¨æˆ·çš„ **æœºå¯†ä¿¡æ¯**ã€‚

è¯·æ³¨æ„ï¼Œ**ç¼“å­˜ä»£ç†** åº”è¯¥ **é…ç½®** ä¸º **åŸºäº** æ–‡ä»¶çš„ **æ‰©å±•å** (_ .css_) è€Œä¸æ˜¯åŸºäºå†…å®¹ç±»å‹ã€‚åœ¨ç¤ºä¾‹ _http://www.example.com/home.php/non-existent.css_ ä¸­ï¼Œå°†å…·æœ‰ `text/html` å†…å®¹ç±»å‹ï¼Œè€Œä¸æ˜¯ `text/css` MIME ç±»å‹ï¼ˆè¿™æ˜¯ _ .css_ æ–‡ä»¶çš„é¢„æœŸï¼‰ã€‚

åœ¨è¿™é‡Œäº†è§£å¦‚ä½•é€šè¿‡æ»¥ç”¨ HTTP è¯·æ±‚èµ°ç§è¿›è¡Œ [ç¼“å­˜æ¬ºéª—æ”»å‡»](../http-request-smuggling/#using-http-request-smuggling-to-perform-web-cache-deception)ã€‚

## è‡ªåŠ¨åŒ–å·¥å…·

* [**toxicache**](https://github.com/xhzeem/toxicache): Golang æ‰«æå™¨ï¼Œç”¨äºåœ¨ URL åˆ—è¡¨ä¸­æŸ¥æ‰¾ Web ç¼“å­˜ä¸­æ¯’æ¼æ´å¹¶æµ‹è¯•å¤šç§æ³¨å…¥æŠ€æœ¯ã€‚

## å‚è€ƒæ–‡çŒ®

* [https://portswigger.net/web-security/web-cache-poisoning](https://portswigger.net/web-security/web-cache-poisoning)
* [https://portswigger.net/web-security/web-cache-poisoning/exploiting#using-web-cache-poisoning-to-exploit-cookie-handling-vulnerabilities](https://portswigger.net/web-security/web-cache-poisoning/exploiting#using-web-cache-poisoning-to-exploit-cookie-handling-vulnerabilities)
* [https://hackerone.com/reports/593712](https://hackerone.com/reports/593712)
* [https://youst.in/posts/cache-poisoning-at-scale/](https://youst.in/posts/cache-poisoning-at-scale/)
* [https://bxmbn.medium.com/how-i-test-for-web-cache-vulnerabilities-tips-and-tricks-9b138da08ff9](https://bxmbn.medium.com/how-i-test-for-web-cache-vulnerabilities-tips-and-tricks-9b138da08ff9)
* [https://www.linkedin.com/pulse/how-i-hacked-all-zendesk-sites-265000-site-one-line-abdalhfaz/](https://www.linkedin.com/pulse/how-i-hacked-all-zendesk-sites-265000-site-one-line-abdalhfaz/)

<figure><img src="../../.gitbook/assets/image (48).png" alt=""><figcaption></figcaption></figure>

\
Use [**Trickest**](https://trickest.com/?utm\_source=hacktricks\&utm\_medium=text\&utm\_campaign=ppc\&utm\_term=trickest\&utm\_content=cache-deception) to easily build and **automate workflows** powered by the world's **most advanced** community tools.\
Get Access Today:

{% embed url="https://trickest.com/?utm_source=hacktricks&utm_medium=banner&utm_campaign=ppc&utm_content=cache-deception" %}

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
