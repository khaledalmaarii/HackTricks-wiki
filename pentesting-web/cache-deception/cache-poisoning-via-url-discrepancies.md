# Cache Poisoning via URL discrepancies

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

Ovo je saÅ¾etak tehnika predloÅ¾enih u postu [https://portswigger.net/research/gotta-cache-em-all](https://portswigger.net/research/gotta-cache-em-all) kako bi se izvrÅ¡ili napadi na trovanje keÅ¡om **zloupotrebom razlika izmeÄ‘u keÅ¡ proxy servera i web servera.**

{% hint style="info" %}
Cilj ovog napada je da **natera keÅ¡ server da pomisli da se uÄitava statiÄki resurs** tako da ga keÅ¡ira dok keÅ¡ server Äuva deo putanje kao kljuÄ keÅ¡a, ali web server odgovara reÅ¡avajuÄ‡i drugu putanju. Web server Ä‡e reÅ¡iti pravu putanju koja Ä‡e uÄitavati dinamiÄku stranicu (koja moÅ¾e Äuvati osetljive informacije o korisniku, zlonamerni payload poput XSS ili preusmeravanje za uÄitavanje JS datoteke sa napadaÄeve veb stranice, na primer).
{% endhint %}

## Delimiters

**URL delimiters** se razlikuju u zavisnosti od okvira i servera, utiÄuÄ‡i na to kako se zahtevi usmeravaju i kako se odgovori obraÄ‘uju. Neki uobiÄajeni delimiters su:

* **TaÄka i zarez**: Koristi se u Spring-u za matriÄne promenljive (npr. `/hello;var=a/world;var1=b;var2=c` â†’ `/hello/world`).
* **TaÄka**: Specifikuje format odgovora u Ruby on Rails (npr. `/MyAccount.css` â†’ `/MyAccount`).
* **Null Byte**: SkraÄ‡uje putanje u OpenLiteSpeed (npr. `/MyAccount%00aaa` â†’ `/MyAccount`).
* **Nov red**: Razdvaja komponente URL-a u Nginx-u (npr. `/users/MyAccount%0aaaa` â†’ `/account/MyAccount`).

Drugi specifiÄni delimiters mogu se naÄ‡i prateÄ‡i ovaj proces:

* **Korak 1**: Identifikovati ne-keÅ¡abilne zahteve i koristiti ih za praÄ‡enje kako se URL-ovi sa potencijalnim delimiterima obraÄ‘uju.
* **Korak 2**: Dodati nasumiÄne sufikse putanjama i uporediti odgovor servera kako bi se utvrdilo da li karakter funkcioniÅ¡e kao delimiter.
* **Korak 3**: Uvesti potencijalne delimiters pre nasumiÄnog sufiksa da se vidi da li se odgovor menja, Å¡to ukazuje na koriÅ¡Ä‡enje delimiter-a.

## Normalization & Encodings

* **Svrha**: URL parseri u keÅ¡ i izvor serverima normalizuju URL-ove kako bi izvukli putanje za mapiranje krajnjih taÄaka i kljuÄeve keÅ¡a.
* **Proces**: Identifikuje delimitere putanje, izvlaÄi i normalizuje putanju dekodiranjem karaktera i uklanjanjem taÄaka-segmenta.

### **Encodings**

RazliÄiti HTTP serveri i proxy serveri poput Nginx-a, Node-a i CloudFront-a dekodiraju delimitere na razliÄite naÄine, Å¡to dovodi do nedoslednosti meÄ‘u CDN-ima i izvor serverima koje bi mogle biti iskoriÅ¡Ä‡ene. Na primer, ako web server izvrÅ¡i ovu transformaciju `/myAccount%3Fparam` â†’ `/myAccount?param`, ali keÅ¡ server zadrÅ¾i kao kljuÄ putanju `/myAccount%3Fparam`, postoji nedoslednost. 

NaÄin da se proveri za ove nedoslednosti je slanje zahteva URL kodirajuÄ‡i razliÄite karaktere nakon uÄitavanja putanje bez ikakvog kodiranja i provera da li je odgovor kodirane putanje doÅ¡ao iz keÅ¡iranog odgovora.

### Dot segment

Normalizacija putanje gde su ukljuÄene taÄke je takoÄ‘e veoma zanimljiva za napade na trovanje keÅ¡om. Na primer, `/static/../home/index` ili `/aaa..\home/index`, neki keÅ¡ serveri Ä‡e keÅ¡irati ove putanje sa samima sobom kao kljuÄevima dok drugi mogu reÅ¡iti putanju i koristiti `/home/index` kao kljuÄ keÅ¡a.\
BaÅ¡ kao i ranije, slanje ovakvih zahteva i provera da li je odgovor prikupljen iz keÅ¡a pomaÅ¾e u identifikaciji da li je odgovor na `/home/index` odgovor koji je poslat kada su te putanje zatraÅ¾ene.

## Static Resources

Nekoliko keÅ¡ servera Ä‡e uvek keÅ¡irati odgovor ako je identifikovan kao statiÄki. Ovo moÅ¾e biti zbog:

* **Ekstenzije**: Cloudflare Ä‡e uvek keÅ¡irati datoteke sa sledeÄ‡im ekstenzijama: 7z, csv, gif, midi, png, tif, zip, avi, doc, gz, mkv, ppt, tiff, zst, avif, docx, ico, mp3, pptx, ttf, apk, dmg, iso, mp4, ps, webm, bin, ejs, jar, ogg, rar, webp, bmp, eot, jpg, otf, svg, woff, bz2, eps, jpeg, pdf, svgz, woff2, class, exe, js, pict, swf, xls, css, flac, mid, pls, tar, xlsx
* MoguÄ‡e je naterati keÅ¡ da Äuva dinamiÄki odgovor koristeÄ‡i delimiter i statiÄku ekstenziju kao Å¡to je zahtev za `/home$image.png` koji Ä‡e keÅ¡irati `/home$image.png`, a izvor server Ä‡e odgovoriti sa `/home`
* **Poznate statiÄke direktorijume**: SledeÄ‡i direktorijumi sadrÅ¾e statiÄke datoteke i stoga bi njihov odgovor trebao biti keÅ¡iran: /static, /assets, /wp-content, /media, /templates, /public, /shared
* MoguÄ‡e je naterati keÅ¡ da Äuva dinamiÄki odgovor koristeÄ‡i delimiter, statiÄki direktorijum i taÄke kao: `/home/..%2fstatic/something` Ä‡e keÅ¡irati `/static/something`, a odgovor Ä‡e biti `/home`
* **StatiÄke direktorijume + taÄke**: Zahtev za `/static/..%2Fhome` ili za `/static/..%5Chome` moÅ¾e biti keÅ¡iran kao takav, ali odgovor moÅ¾e biti `/home`
* **StatiÄke datoteke:** Neke specifiÄne datoteke se uvek keÅ¡iraju kao Å¡to su `/robots.txt`, `/favicon.ico`, i `/index.html`. Å to se moÅ¾e zloupotrebiti kao `/home/..%2Frobots.txt` gde keÅ¡ moÅ¾e Äuvati `/robots.txt`, a izvor server odgovara na `/home`.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
