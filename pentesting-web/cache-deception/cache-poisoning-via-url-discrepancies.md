# Cache Poisoning via URL discrepancies

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}

Este √© um resumo das t√©cnicas propostas no post [https://portswigger.net/research/gotta-cache-em-all](https://portswigger.net/research/gotta-cache-em-all) para realizar ataques de cache poisoning **abusando das discrep√¢ncias entre proxies de cache e servidores web.**

{% hint style="info" %}
O objetivo deste ataque √© **fazer o servidor de cache pensar que um recurso est√°tico est√° sendo carregado** para que ele o armazene em cache, enquanto o servidor de cache armazena como chave de cache parte do caminho, mas o servidor web responde resolvendo outro caminho. O servidor web resolver√° o caminho real, que estar√° carregando uma p√°gina din√¢mica (que pode armazenar informa√ß√µes sens√≠veis sobre o usu√°rio, um payload malicioso como XSS ou redirecionar para carregar um arquivo JS do site do atacante, por exemplo).
{% endhint %}

## Delimitadores

**Delimitadores de URL** variam de acordo com o framework e o servidor, impactando como as requisi√ß√µes s√£o roteadas e as respostas s√£o tratadas. Alguns delimitadores de origem comuns s√£o:

* **Ponto e v√≠rgula**: Usado no Spring para vari√°veis de matriz (por exemplo, `/hello;var=a/world;var1=b;var2=c` ‚Üí `/hello/world`).
* **Ponto**: Especifica o formato da resposta no Ruby on Rails (por exemplo, `/MyAccount.css` ‚Üí `/MyAccount`).
* **Byte nulo**: Trunca caminhos no OpenLiteSpeed (por exemplo, `/MyAccount%00aaa` ‚Üí `/MyAccount`).
* **Byte de nova linha**: Separa componentes de URL no Nginx (por exemplo, `/users/MyAccount%0aaaa` ‚Üí `/account/MyAccount`).

Outros delimitadores espec√≠ficos podem ser encontrados seguindo este processo:

* **Passo 1**: Identificar requisi√ß√µes n√£o cache√°veis e us√°-las para monitorar como URLs com potenciais delimitadores s√£o tratadas.
* **Passo 2**: Anexar sufixos aleat√≥rios aos caminhos e comparar a resposta do servidor para determinar se um caractere funciona como delimitador.
* **Passo 3**: Introduzir potenciais delimitadores antes do sufixo aleat√≥rio para ver se a resposta muda, indicando o uso de delimitador.

## Normaliza√ß√£o e Codifica√ß√µes

* **Prop√≥sito**: Parsers de URL em servidores de cache e de origem normalizam URLs para extrair caminhos para mapeamento de endpoints e chaves de cache.
* **Processo**: Identifica delimitadores de caminho, extrai e normaliza o caminho decodificando caracteres e removendo segmentos de ponto.

### **Codifica√ß√µes**

Diferentes servidores HTTP e proxies como Nginx, Node e CloudFront decodificam delimitadores de maneira diferente, levando a inconsist√™ncias entre CDNs e servidores de origem que podem ser exploradas. Por exemplo, se o servidor web realizar esta transforma√ß√£o `/myAccount%3Fparam` ‚Üí `/myAccount?param`, mas o servidor de cache mantiver como chave o caminho `/myAccount%3Fparam`, h√° uma inconsist√™ncia. 

Uma maneira de verificar essas inconsist√™ncias √© enviar requisi√ß√µes codificando diferentes caracteres ap√≥s carregar o caminho sem nenhuma codifica√ß√£o e verificar se a resposta do caminho codificado veio da resposta em cache.

### Segmento de ponto

A normaliza√ß√£o de caminho onde pontos est√£o envolvidos tamb√©m √© muito interessante para ataques de cache poisoning. Por exemplo, `/static/../home/index` ou `/aaa..\home/index`, alguns servidores de cache ir√£o armazenar esses caminhos com eles mesmos como chaves, enquanto outros podem resolver o caminho e usar `/home/index` como a chave de cache.\
Assim como antes, enviar esse tipo de requisi√ß√µes e verificar se a resposta foi obtida do cache ajuda a identificar se a resposta para `/home/index` √© a resposta enviada quando esses caminhos s√£o solicitados.

## Recursos Est√°ticos

V√°rios servidores de cache sempre armazenar√£o uma resposta se ela for identificada como est√°tica. Isso pode ser devido a:

* **A extens√£o**: O Cloudflare sempre armazenar√° em cache arquivos com as seguintes extens√µes: 7z, csv, gif, midi, png, tif, zip, avi, doc, gz, mkv, ppt, tiff, zst, avif, docx, ico, mp3, pptx, ttf, apk, dmg, iso, mp4, ps, webm, bin, ejs, jar, ogg, rar, webp, bmp, eot, jpg, otf, svg, woff, bz2, eps, jpeg, pdf, svgz, woff2, class, exe, js, pict, swf, xls, css, flac, mid, pls, tar, xlsx
* √â poss√≠vel for√ßar um cache a armazenar uma resposta din√¢mica usando um delimitador e uma extens√£o est√°tica, como uma requisi√ß√£o para `/home$image.png` que armazenar√° em cache `/home$image.png` e o servidor de origem responder√° com `/home`
* **Diret√≥rios est√°ticos bem conhecidos**: Os seguintes diret√≥rios cont√™m arquivos est√°ticos e, portanto, suas respostas devem ser armazenadas em cache: /static, /assets, /wp-content, /media, /templates, /public, /shared
* √â poss√≠vel for√ßar um cache a armazenar uma resposta din√¢mica usando um delimitador, um diret√≥rio est√°tico e pontos, como: `/home/..%2fstatic/something` armazenar√° em cache `/static/something` e a resposta ser√° `/home`
* **Diret√≥rios est√°ticos + pontos**: Uma requisi√ß√£o para `/static/..%2Fhome` ou para `/static/..%5Chome` pode ser armazenada em cache como est√°, mas a resposta pode ser `/home`
* **Arquivos est√°ticos:** Alguns arquivos espec√≠ficos s√£o sempre armazenados em cache, como `/robots.txt`, `/favicon.ico` e `/index.html`. O que pode ser abusado como `/home/..%2Frobots.txt`, onde o cache pode armazenar `/robots.txt` e o servidor de origem responder√° para `/home`.

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}
