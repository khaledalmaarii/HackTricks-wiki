# Cache Poisoning via URL discrepancies

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}

Dies ist eine Zusammenfassung der Techniken, die in dem Beitrag [https://portswigger.net/research/gotta-cache-em-all](https://portswigger.net/research/gotta-cache-em-all) vorgeschlagen werden, um Cache-Poisoning-Angriffe **unter Ausnutzung von Diskrepanzen zwischen Cache-Proxys und Webservern** durchzuf√ºhren.

{% hint style="info" %}
Das Ziel dieses Angriffs ist es, **den Cache-Server glauben zu lassen, dass eine statische Ressource geladen wird**, sodass er sie cached, w√§hrend der Cache-Server als Cache-Schl√ºssel einen Teil des Pfades speichert, aber der Webserver auf einen anderen Pfad antwortet. Der Webserver wird den echten Pfad aufl√∂sen, der eine dynamische Seite l√§dt (die m√∂glicherweise sensible Informationen √ºber den Benutzer, eine b√∂sartige Payload wie XSS oder eine Umleitung zum Laden einer JS-Datei von der Website des Angreifers enth√§lt).
{% endhint %}

## Delimiter

**URL-Delimiter** variieren je nach Framework und Server, was sich darauf auswirkt, wie Anfragen geroutet und Antworten behandelt werden. Einige g√§ngige Ursprung-Delimiter sind:

* **Semikolon**: Wird in Spring f√ºr Matrixvariablen verwendet (z.B. `/hello;var=a/world;var1=b;var2=c` ‚Üí `/hello/world`).
* **Punkt**: Gibt das Antwortformat in Ruby on Rails an (z.B. `/MyAccount.css` ‚Üí `/MyAccount`).
* **Null-Byte**: K√ºrzt Pfade in OpenLiteSpeed (z.B. `/MyAccount%00aaa` ‚Üí `/MyAccount`).
* **Newline-Byte**: Trennt URL-Komponenten in Nginx (z.B. `/users/MyAccount%0aaaa` ‚Üí `/account/MyAccount`).

Andere spezifische Delimiter k√∂nnten in diesem Prozess gefunden werden:

* **Schritt 1**: Identifiziere nicht-cachebare Anfragen und verwende sie, um zu √ºberwachen, wie URLs mit potenziellen Delimitern behandelt werden.
* **Schritt 2**: F√ºge zuf√§llige Suffixe zu Pfaden hinzu und vergleiche die Antwort des Servers, um festzustellen, ob ein Zeichen als Delimiter fungiert.
* **Schritt 3**: F√ºhre potenzielle Delimiter vor dem zuf√§lligen Suffix ein, um zu sehen, ob sich die Antwort √§ndert, was auf die Verwendung des Delimiters hinweist.

## Normalisierung & Kodierungen

* **Zweck**: URL-Parser in sowohl Cache- als auch Ursprungsservern normalisieren URLs, um Pfade f√ºr die Endpunktzuordnung und Cache-Schl√ºssel zu extrahieren.
* **Prozess**: Identifiziert Pfad-Delimiter, extrahiert und normalisiert den Pfad, indem Zeichen dekodiert und Punktsegmente entfernt werden.

### **Kodierungen**

Verschiedene HTTP-Server und Proxys wie Nginx, Node und CloudFront dekodieren Delimiter unterschiedlich, was zu Inkonsistenzen zwischen CDNs und Ursprungsservern f√ºhren kann, die ausgenutzt werden k√∂nnten. Zum Beispiel, wenn der Webserver diese Transformation durchf√ºhrt `/myAccount%3Fparam` ‚Üí `/myAccount?param`, aber der Cache-Server den Pfad `/myAccount%3Fparam` als Schl√ºssel beh√§lt, gibt es eine Inkonsistenz. 

Eine M√∂glichkeit, diese Inkonsistenzen zu √ºberpr√ºfen, besteht darin, Anfragen mit URL-Kodierung verschiedener Zeichen zu senden, nachdem der Pfad ohne Kodierung geladen wurde, und zu √ºberpr√ºfen, ob die kodierte Pfadantwort von der zwischengespeicherten Antwort stammt.

### Punktsegment

Die Pfadnormalisierung, bei der Punkte beteiligt sind, ist auch sehr interessant f√ºr Cache-Poisoning-Angriffe. Zum Beispiel, `/static/../home/index` oder `/aaa..\home/index`, einige Cache-Server werden diese Pfade mit sich selbst als Schl√ºssel cachen, w√§hrend andere den Pfad aufl√∂sen und `/home/index` als Cache-Schl√ºssel verwenden.\
Wie zuvor hilft das Senden dieser Art von Anfragen und das √úberpr√ºfen, ob die Antwort aus dem Cache gesammelt wurde, zu identifizieren, ob die Antwort auf `/home/index` die Antwort ist, die gesendet wurde, wenn diese Pfade angefordert werden.

## Statische Ressourcen

Einige Cache-Server werden immer eine Antwort cachen, wenn sie als statisch identifiziert wird. Dies k√∂nnte daran liegen:

* **Die Erweiterung**: Cloudflare wird immer Dateien mit den folgenden Erweiterungen cachen: 7z, csv, gif, midi, png, tif, zip, avi, doc, gz, mkv, ppt, tiff, zst, avif, docx, ico, mp3, pptx, ttf, apk, dmg, iso, mp4, ps, webm, bin, ejs, jar, ogg, rar, webp, bmp, eot, jpg, otf, svg, woff, bz2, eps, jpeg, pdf, svgz, woff2, class, exe, js, pict, swf, xls, css, flac, mid, pls, tar, xlsx
* Es ist m√∂glich, einen Cache zu zwingen, eine dynamische Antwort zu speichern, indem man einen Delimiter und eine statische Erweiterung verwendet, wie eine Anfrage an `/home$image.png`, die `/home$image.png` cachen wird und der Ursprungsserver mit `/home` antwortet.
* **Bekannte statische Verzeichnisse**: Die folgenden Verzeichnisse enthalten statische Dateien und daher sollte ihre Antwort zwischengespeichert werden: /static, /assets, /wp-content, /media, /templates, /public, /shared
* Es ist m√∂glich, einen Cache zu zwingen, eine dynamische Antwort zu speichern, indem man einen Delimiter, ein statisches Verzeichnis und Punkte verwendet, wie: `/home/..%2fstatic/something`, das `/static/something` cachen wird und die Antwort wird `/home` sein.
* **Statische Verzeichnisse + Punkte**: Eine Anfrage an `/static/..%2Fhome` oder an `/static/..%5Chome` k√∂nnte so zwischengespeichert werden, wie sie ist, aber die Antwort k√∂nnte `/home` sein.
* **Statische Dateien:** Einige spezifische Dateien werden immer zwischengespeichert, wie `/robots.txt`, `/favicon.ico` und `/index.html`. Diese k√∂nnen missbraucht werden, wie `/home/..%2Frobots.txt`, wo der Cache m√∂glicherweise `/robots.txt` speichert und der Ursprungsserver auf `/home` antwortet.

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}
