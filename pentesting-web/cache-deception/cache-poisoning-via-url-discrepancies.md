# Cache Poisoning via URL discrepancies

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

Este es un resumen de las t√©cnicas propuestas en el post [https://portswigger.net/research/gotta-cache-em-all](https://portswigger.net/research/gotta-cache-em-all) para realizar ataques de cache poisoning **abusando de las discrepancias entre los proxies de cach√© y los servidores web.**

{% hint style="info" %}
El objetivo de este ataque es **hacer que el servidor de cach√© piense que se est√° cargando un recurso est√°tico** para que lo almacene en cach√©, mientras que el servidor de cach√© almacena como clave de cach√© parte de la ruta, pero el servidor web responde resolviendo otra ruta. El servidor web resolver√° la ruta real que cargar√° una p√°gina din√°mica (que podr√≠a almacenar informaci√≥n sensible sobre el usuario, una carga maliciosa como XSS o redirigir para cargar un archivo JS desde el sitio web del atacante, por ejemplo).
{% endhint %}

## Delimitadores

**Los delimitadores de URL** var√≠an seg√∫n el marco y el servidor, lo que impacta c√≥mo se enrutan las solicitudes y se manejan las respuestas. Algunos delimitadores de origen comunes son:

* **Punto y coma**: Usado en Spring para variables de matriz (por ejemplo, `/hello;var=a/world;var1=b;var2=c` ‚Üí `/hello/world`).
* **Punto**: Especifica el formato de respuesta en Ruby on Rails (por ejemplo, `/MyAccount.css` ‚Üí `/MyAccount`).
* **Byte nulo**: Trunca rutas en OpenLiteSpeed (por ejemplo, `/MyAccount%00aaa` ‚Üí `/MyAccount`).
* **Byte de nueva l√≠nea**: Separa componentes de URL en Nginx (por ejemplo, `/users/MyAccount%0aaaa` ‚Üí `/account/MyAccount`).

Otros delimitadores espec√≠ficos pueden encontrarse siguiendo este proceso:

* **Paso 1**: Identificar solicitudes no cacheables y usarlas para monitorear c√≥mo se manejan las URL con posibles delimitadores.
* **Paso 2**: Agregar sufijos aleatorios a las rutas y comparar la respuesta del servidor para determinar si un car√°cter funciona como delimitador.
* **Paso 3**: Introducir posibles delimitadores antes del sufijo aleatorio para ver si la respuesta cambia, indicando el uso de delimitadores.

## Normalizaci√≥n y codificaciones

* **Prop√≥sito**: Los analizadores de URL en los servidores de cach√© y de origen normalizan las URL para extraer rutas para el mapeo de puntos finales y claves de cach√©.
* **Proceso**: Identifica los delimitadores de ruta, extrae y normaliza la ruta decodificando caracteres y eliminando segmentos de punto.

### **Codificaciones**

Diferentes servidores HTTP y proxies como Nginx, Node y CloudFront decodifican los delimitadores de manera diferente, lo que lleva a inconsistencias entre CDNs y servidores de origen que podr√≠an ser explotadas. Por ejemplo, si el servidor web realiza esta transformaci√≥n `/myAccount%3Fparam` ‚Üí `/myAccount?param` pero el servidor de cach√© mantiene como clave la ruta `/myAccount%3Fparam`, hay una inconsistencia. 

Una forma de verificar estas inconsistencias es enviar solicitudes codificando diferentes caracteres despu√©s de cargar la ruta sin ninguna codificaci√≥n y verificar si la respuesta de la ruta codificada provino de la respuesta en cach√©.

### Segmento de punto

La normalizaci√≥n de la ruta donde est√°n involucrados los puntos tambi√©n es muy interesante para los ataques de cache poisoning. Por ejemplo, `/static/../home/index` o `/aaa..\home/index`, algunos servidores de cach√© almacenar√°n en cach√© estas rutas con ellas mismas como claves, mientras que otros podr√≠an resolver la ruta y usar `/home/index` como la clave de cach√©.\
Al igual que antes, enviar este tipo de solicitudes y verificar si la respuesta se obtuvo de la cach√© ayuda a identificar si la respuesta a `/home/index` es la respuesta enviada cuando se solicitan esas rutas.

## Recursos est√°ticos

Varios servidores de cach√© siempre almacenar√°n en cach√© una respuesta si se identifica como est√°tica. Esto puede ser porque:

* **La extensi√≥n**: Cloudflare siempre almacenar√° en cach√© archivos con las siguientes extensiones: 7z, csv, gif, midi, png, tif, zip, avi, doc, gz, mkv, ppt, tiff, zst, avif, docx, ico, mp3, pptx, ttf, apk, dmg, iso, mp4, ps, webm, bin, ejs, jar, ogg, rar, webp, bmp, eot, jpg, otf, svg, woff, bz2, eps, jpeg, pdf, svgz, woff2, class, exe, js, pict, swf, xls, css, flac, mid, pls, tar, xlsx.
* Es posible forzar a una cach√© a almacenar una respuesta din√°mica utilizando un delimitador y una extensi√≥n est√°tica, como una solicitud a `/home$image.png` que almacenar√° en cach√© `/home$image.png` y el servidor de origen responder√° con `/home`.
* **Directorios est√°ticos bien conocidos**: Los siguientes directorios contienen archivos est√°ticos y, por lo tanto, su respuesta deber√≠a ser almacenada en cach√©: /static, /assets, /wp-content, /media, /templates, /public, /shared.
* Es posible forzar a una cach√© a almacenar una respuesta din√°mica utilizando un delimitador, un directorio est√°tico y puntos como: `/home/..%2fstatic/something` almacenar√° en cach√© `/static/something` y la respuesta ser√° `/home`.
* **Directorios est√°ticos + puntos**: Una solicitud a `/static/..%2Fhome` o a `/static/..%5Chome` podr√≠a ser almacenada en cach√© tal cual, pero la respuesta podr√≠a ser `/home`.
* **Archivos est√°ticos:** Algunos archivos espec√≠ficos siempre se almacenan en cach√©, como `/robots.txt`, `/favicon.ico` y `/index.html`. Lo que se puede abusar como `/home/..%2Frobots.txt` donde la cach√© podr√≠a almacenar `/robots.txt` y el servidor de origen responder a `/home`.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
