# Cache Poisoning via URL discrepancies

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ sztuczkami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>
{% endhint %}

To jest podsumowanie technik zaproponowanych w poÅ›cie [https://portswigger.net/research/gotta-cache-em-all](https://portswigger.net/research/gotta-cache-em-all) w celu przeprowadzenia atakÃ³w na cache **wykorzystujÄ…cych rozbieÅ¼noÅ›ci miÄ™dzy proxy cache a serwerami webowymi.**

{% hint style="info" %}
Celem tego ataku jest **sprawienie, aby serwer cache myÅ›laÅ‚, Å¼e Å‚adowany jest zasÃ³b statyczny**, wiÄ™c go buforuje, podczas gdy serwer cache przechowuje jako klucz cache czÄ™Å›Ä‡ Å›cieÅ¼ki, ale serwer webowy odpowiada, rozwiÄ…zujÄ…c innÄ… Å›cieÅ¼kÄ™. Serwer webowy rozwiÄ…Å¼e rzeczywistÄ… Å›cieÅ¼kÄ™, ktÃ³ra bÄ™dzie Å‚adowaÄ‡ dynamicznÄ… stronÄ™ (ktÃ³ra moÅ¼e przechowywaÄ‡ wraÅ¼liwe informacje o uÅ¼ytkowniku, zÅ‚oÅ›liwy Å‚adunek, taki jak XSS lub przekierowywaÄ‡ do zaÅ‚adowania pliku JS z witryny atakujÄ…cego, na przykÅ‚ad).
{% endhint %}

## Delimitery

**Delimitery URL** rÃ³Å¼niÄ… siÄ™ w zaleÅ¼noÅ›ci od frameworka i serwera, co wpÅ‚ywa na to, jak Å¼Ä…dania sÄ… kierowane i jak obsÅ‚ugiwane sÄ… odpowiedzi. NiektÃ³re powszechne delimitery pochodzenia to:

* **Åšrednik**: UÅ¼ywany w Spring do zmiennych macierzowych (np. `/hello;var=a/world;var1=b;var2=c` â†’ `/hello/world`).
* **Kropka**: OkreÅ›la format odpowiedzi w Ruby on Rails (np. `/MyAccount.css` â†’ `/MyAccount`).
* **Bajt null**: Skraca Å›cieÅ¼ki w OpenLiteSpeed (np. `/MyAccount%00aaa` â†’ `/MyAccount`).
* **Bajt nowej linii**: Oddziela komponenty URL w Nginx (np. `/users/MyAccount%0aaaa` â†’ `/account/MyAccount`).

Inne specyficzne delimitery mogÄ… byÄ‡ znalezione w trakcie tego procesu:

* **Krok 1**: Zidentyfikuj Å¼Ä…dania, ktÃ³re nie mogÄ… byÄ‡ buforowane, i uÅ¼yj ich do monitorowania, jak obsÅ‚ugiwane sÄ… URL-e z potencjalnymi delimiterami.
* **Krok 2**: Dodaj losowe sufiksy do Å›cieÅ¼ek i porÃ³wnaj odpowiedÅº serwera, aby okreÅ›liÄ‡, czy znak dziaÅ‚a jako delimiter.
* **Krok 3**: WprowadÅº potencjalne delimitery przed losowym sufiksem, aby sprawdziÄ‡, czy odpowiedÅº siÄ™ zmienia, co wskazuje na uÅ¼ycie delimitera.

## Normalizacja i kodowania

* **Cel**: Parsery URL w serwerach cache i serwerach pochodzenia normalizujÄ… URL-e, aby wyodrÄ™bniÄ‡ Å›cieÅ¼ki do mapowania punktÃ³w koÅ„cowych i kluczy cache.
* **Proces**: Identyfikuje delimitery Å›cieÅ¼ek, wyodrÄ™bnia i normalizuje Å›cieÅ¼kÄ™, dekodujÄ…c znaki i usuwajÄ…c segmenty kropkowe.

### **Kodowania**

RÃ³Å¼ne serwery HTTP i proxy, takie jak Nginx, Node i CloudFront, dekodujÄ… delimitery w rÃ³Å¼ny sposÃ³b, co prowadzi do niespÃ³jnoÅ›ci w rÃ³Å¼nych CDN-ach i serwerach pochodzenia, ktÃ³re mogÄ… byÄ‡ wykorzystane. Na przykÅ‚ad, jeÅ›li serwer webowy wykonuje tÄ™ transformacjÄ™ `/myAccount%3Fparam` â†’ `/myAccount?param`, ale serwer cache zachowuje jako klucz Å›cieÅ¼kÄ™ `/myAccount%3Fparam`, wystÄ™puje niespÃ³jnoÅ›Ä‡. 

Sposobem na sprawdzenie tych niespÃ³jnoÅ›ci jest wysyÅ‚anie Å¼Ä…daÅ„ URL kodujÄ…cych rÃ³Å¼ne znaki po zaÅ‚adowaniu Å›cieÅ¼ki bez Å¼adnego kodowania i sprawdzenie, czy odpowiedÅº zakodowanej Å›cieÅ¼ki pochodzi z odpowiedzi buforowanej.

### Segment kropkowy

Normalizacja Å›cieÅ¼ek, w ktÃ³rych zaangaÅ¼owane sÄ… kropki, jest rÃ³wnieÅ¼ bardzo interesujÄ…ca dla atakÃ³w na cache. Na przykÅ‚ad, `/static/../home/index` lub `/aaa..\home/index`, niektÃ³re serwery cache bÄ™dÄ… buforowaÄ‡ te Å›cieÅ¼ki jako klucze, podczas gdy inne mogÄ… rozwiÄ…zaÄ‡ Å›cieÅ¼kÄ™ i uÅ¼yÄ‡ `/home/index` jako klucza cache.\
Podobnie jak wczeÅ›niej, wysyÅ‚anie tego rodzaju Å¼Ä…daÅ„ i sprawdzanie, czy odpowiedÅº zostaÅ‚a zebrana z cache, pomaga zidentyfikowaÄ‡, czy odpowiedÅº na `/home/index` jest odpowiedziÄ… wysÅ‚anÄ…, gdy te Å›cieÅ¼ki sÄ… Å¼Ä…dane.

## Zasoby statyczne

Kilka serwerÃ³w cache zawsze bÄ™dzie buforowaÄ‡ odpowiedÅº, jeÅ›li zostanie zidentyfikowana jako statyczna. MoÅ¼e to byÄ‡ spowodowane:

* **Rozszerzeniem**: Cloudflare zawsze bÄ™dzie buforowaÄ‡ pliki z nastÄ™pujÄ…cymi rozszerzeniami: 7z, csv, gif, midi, png, tif, zip, avi, doc, gz, mkv, ppt, tiff, zst, avif, docx, ico, mp3, pptx, ttf, apk, dmg, iso, mp4, ps, webm, bin, ejs, jar, ogg, rar, webp, bmp, eot, jpg, otf, svg, woff, bz2, eps, jpeg, pdf, svgz, woff2, class, exe, js, pict, swf, xls, css, flac, mid, pls, tar, xlsx
* MoÅ¼liwe jest wymuszenie buforowania dynamicznej odpowiedzi, uÅ¼ywajÄ…c delimitera i statycznego rozszerzenia, jak Å¼Ä…danie do `/home$image.png`, ktÃ³re buforuje `/home$image.png`, a serwer pochodzenia odpowiada `/home`
* **Znane statyczne katalogi**: NastÄ™pujÄ…ce katalogi zawierajÄ… pliki statyczne, a zatem ich odpowiedzi powinny byÄ‡ buforowane: /static, /assets, /wp-content, /media, /templates, /public, /shared
* MoÅ¼liwe jest wymuszenie buforowania dynamicznej odpowiedzi, uÅ¼ywajÄ…c delimitera, statycznego katalogu i kropek, jak: `/home/..%2fstatic/something` buforuje `/static/something`, a odpowiedÅº bÄ™dzie `/home`
* **Statyczne katalogi + kropki**: Å»Ä…danie do `/static/..%2Fhome` lub do `/static/..%5Chome` moÅ¼e byÄ‡ buforowane tak, jak jest, ale odpowiedÅº moÅ¼e byÄ‡ `/home`
* **Statyczne pliki:** NiektÃ³re konkretne pliki sÄ… zawsze buforowane, takie jak `/robots.txt`, `/favicon.ico` i `/index.html`. Co moÅ¼na wykorzystaÄ‡, jak `/home/..%2Frobots.txt`, gdzie cache moÅ¼e przechowywaÄ‡ `/robots.txt`, a serwer pochodzenia odpowiada na `/home`.

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ sztuczkami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>
{% endhint %}
