# Cache Poisoning via URL discrepancies

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
{% endhint %}

Ceci est un r√©sum√© des techniques propos√©es dans le post [https://portswigger.net/research/gotta-cache-em-all](https://portswigger.net/research/gotta-cache-em-all) afin d'effectuer des attaques de cache poisoning **en abusant des diff√©rences entre les proxies de cache et les serveurs web.**

{% hint style="info" %}
L'objectif de cette attaque est de **faire croire au serveur de cache qu'une ressource statique est en cours de chargement** afin qu'il la mette en cache, tandis que le serveur de cache stocke comme cl√© de cache une partie du chemin, mais le serveur web r√©pond en r√©solvant un autre chemin. Le serveur web r√©soudra le chemin r√©el qui chargera une page dynamique (qui pourrait stocker des informations sensibles sur l'utilisateur, un payload malveillant comme XSS ou rediriger pour charger un fichier JS depuis le site de l'attaquant par exemple).
{% endhint %}

## Delimiters

**Les d√©limiteurs d'URL** varient selon le framework et le serveur, impactant la fa√ßon dont les requ√™tes sont rout√©es et les r√©ponses sont g√©r√©es. Certains d√©limiteurs d'origine courants sont :

* **Point-virgule** : Utilis√© dans Spring pour les variables de matrice (par exemple, `/hello;var=a/world;var1=b;var2=c` ‚Üí `/hello/world`).
* **Point** : Sp√©cifie le format de r√©ponse dans Ruby on Rails (par exemple, `/MyAccount.css` ‚Üí `/MyAccount`).
* **Octet nul** : Tronque les chemins dans OpenLiteSpeed (par exemple, `/MyAccount%00aaa` ‚Üí `/MyAccount`).
* **Octet de nouvelle ligne** : S√©pare les composants d'URL dans Nginx (par exemple, `/users/MyAccount%0aaaa` ‚Üí `/account/MyAccount`).

D'autres d√©limiteurs sp√©cifiques peuvent √™tre trouv√©s en suivant ce processus :

* **√âtape 1** : Identifier les requ√™tes non mises en cache et les utiliser pour surveiller comment les URL avec des d√©limiteurs potentiels sont g√©r√©es.
* **√âtape 2** : Ajouter des suffixes al√©atoires aux chemins et comparer la r√©ponse du serveur pour d√©terminer si un caract√®re fonctionne comme un d√©limiteur.
* **√âtape 3** : Introduire des d√©limiteurs potentiels avant le suffixe al√©atoire pour voir si la r√©ponse change, indiquant l'utilisation d'un d√©limiteur.

## Normalization & Encodings

* **Objectif** : Les analyseurs d'URL dans les serveurs de cache et d'origine normalisent les URL pour extraire les chemins pour le mappage des points de terminaison et les cl√©s de cache.
* **Processus** : Identifie les d√©limiteurs de chemin, extrait et normalise le chemin en d√©codant les caract√®res et en supprimant les segments de points.

### **Encodings**

Diff√©rents serveurs HTTP et proxies comme Nginx, Node et CloudFront d√©codent les d√©limiteurs diff√©remment, ce qui entra√Æne des incoh√©rences entre les CDN et les serveurs d'origine qui pourraient √™tre exploit√©es. Par exemple, si le serveur web effectue cette transformation `/myAccount%3Fparam` ‚Üí `/myAccount?param` mais que le serveur de cache conserve comme cl√© le chemin `/myAccount%3Fparam`, il y a une incoh√©rence. 

Une fa√ßon de v√©rifier ces incoh√©rences est d'envoyer des requ√™tes URL en encodant diff√©rents caract√®res apr√®s avoir charg√© le chemin sans aucun encodage et de v√©rifier si la r√©ponse du chemin encod√© provient de la r√©ponse mise en cache.

### Dot segment

La normalisation des chemins o√π des points sont impliqu√©s est √©galement tr√®s int√©ressante pour les attaques de cache poisoning. Par exemple, `/static/../home/index` ou `/aaa..\home/index`, certains serveurs de cache mettront en cache ces chemins avec eux-m√™mes comme cl√©s tandis que d'autres pourraient r√©soudre le chemin et utiliser `/home/index` comme cl√© de cache.\
Tout comme pr√©c√©demment, envoyer ce type de requ√™tes et v√©rifier si la r√©ponse a √©t√© obtenue √† partir du cache aide √† identifier si la r√©ponse √† `/home/index` est la r√©ponse envoy√©e lorsque ces chemins sont demand√©s.

## Static Resources

Plusieurs serveurs de cache mettront toujours en cache une r√©ponse si elle est identifi√©e comme statique. Cela peut √™tre d√ª √† :

* **L'extension** : Cloudflare mettra toujours en cache les fichiers avec les extensions suivantes : 7z, csv, gif, midi, png, tif, zip, avi, doc, gz, mkv, ppt, tiff, zst, avif, docx, ico, mp3, pptx, ttf, apk, dmg, iso, mp4, ps, webm, bin, ejs, jar, ogg, rar, webp, bmp, eot, jpg, otf, svg, woff, bz2, eps, jpeg, pdf, svgz, woff2, class, exe, js, pict, swf, xls, css, flac, mid, pls, tar, xlsx
* Il est possible de forcer un cache √† stocker une r√©ponse dynamique en utilisant un d√©limiteur et une extension statique comme une requ√™te √† `/home$image.png` qui mettra en cache `/home$image.png` et le serveur d'origine r√©pondra avec `/home`
* **R√©pertoires statiques bien connus** : Les r√©pertoires suivants contiennent des fichiers statiques et donc leur r√©ponse devrait √™tre mise en cache : /static, /assets, /wp-content, /media, /templates, /public, /shared
* Il est possible de forcer un cache √† stocker une r√©ponse dynamique en utilisant un d√©limiteur, un r√©pertoire statique et des points comme : `/home/..%2fstatic/something` mettra en cache `/static/something` et la r√©ponse sera `/home`
* **Dossiers statiques + points** : Une requ√™te √† `/static/..%2Fhome` ou √† `/static/..%5Chome` pourrait √™tre mise en cache telle quelle mais la r√©ponse pourrait √™tre `/home`
* **Fichiers statiques :** Certains fichiers sp√©cifiques sont toujours mis en cache comme `/robots.txt`, `/favicon.ico`, et `/index.html`. Ce qui peut √™tre abus√© comme `/home/..%2Frobots.txt` o√π le cache pourrait stocker `/robots.txt` et le serveur d'origine r√©pond √† `/home`.

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
{% endhint %}
