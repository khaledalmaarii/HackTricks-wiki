# Injections d'e-mails

<figure><img src="/.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

Utilisez [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) pour crÃ©er facilement et **automatiser des flux de travail** alimentÃ©s par les outils communautaires les plus avancÃ©s au monde.\
Obtenez un accÃ¨s aujourd'hui :

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybersÃ©curitÃ©** ? Voulez-vous voir votre **entreprise annoncÃ©e dans HackTricks** ? Ou voulez-vous avoir accÃ¨s Ã  la **derniÃ¨re version de PEASS ou tÃ©lÃ©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* DÃ©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Injecter dans l'e-mail envoyÃ©

### Injecter Cc et Bcc aprÃ¨s l'argument de l'expÃ©diteur
```
From:sender@domain.com%0ACc:recipient@domain.co,%0ABcc:recipient1@domain.com
```
### Injecter un argument

L'argument sera injectÃ© dans les comptes du destinataire et du destinataire1.
```
From:sender@domain.com%0ATo:attacker@domain.com
```
Le message sera envoyÃ© au destinataire d'origine ainsi qu'au compte de l'attaquant.

### Injecter l'argument Sujet
```
From:sender@domain.com%0ASubject:This is%20Fake%20Subject
```
Le sujet factice sera ajoutÃ© au sujet original et dans certains cas, le remplacera. Cela dÃ©pend du comportement du service de messagerie.

### Modifier le corps du message

Injectez un saut de ligne Ã  deux lignes, puis Ã©crivez votre message pour modifier le corps du message.
```
From:sender@domain.com%0A%0AMy%20New%20%0Fake%20Message.
```
### Exploitation de la fonction mail() de PHP

L'exploitation de la fonction mail() de PHP est une technique couramment utilisÃ©e pour effectuer des injections d'e-mails malveillantes. Cette vulnÃ©rabilitÃ© se produit lorsque les donnÃ©es utilisateur ne sont pas correctement filtrÃ©es ou validÃ©es avant d'Ãªtre utilisÃ©es comme arguments dans la fonction mail().

#### Injection d'e-mails

L'injection d'e-mails se produit lorsque des donnÃ©es non fiables sont insÃ©rÃ©es dans les en-tÃªtes de l'e-mail, permettant ainsi Ã  un attaquant d'exÃ©cuter du code malveillant ou de manipuler le contenu de l'e-mail. Les injections d'e-mails peuvent Ãªtre utilisÃ©es pour diverses attaques, telles que le phishing, le vol d'informations sensibles ou l'exÃ©cution de commandes Ã  distance.

#### Exemple d'exploitation

Voici un exemple de code vulnÃ©rable utilisant la fonction mail() de PHP :

```php
<?php
$to = $_POST['to'];
$subject = $_POST['subject'];
$message = $_POST['message'];

$headers = "From: " . $_POST['from'] . "\r\n";
$headers .= "Reply-To: " . $_POST['reply-to'] . "\r\n";

mail($to, $subject, $message, $headers);
?>
```

Dans cet exemple, les donnÃ©es utilisateur sont directement utilisÃ©es dans les en-tÃªtes de l'e-mail sans aucune validation ou filtrage. Cela permet Ã  un attaquant d'injecter des en-tÃªtes malveillants en exploitant les caractÃ¨res spÃ©ciaux tels que les retours Ã  la ligne.

#### PrÃ©vention

Pour prÃ©venir les injections d'e-mails, il est essentiel de filtrer et de valider toutes les donnÃ©es utilisateur avant de les utiliser dans la fonction mail(). Voici quelques bonnes pratiques Ã  suivre :

- Utilisez des fonctions de validation pour vÃ©rifier les adresses e-mail, les sujets et les autres champs pertinents.
- Ã‰chappez correctement les caractÃ¨res spÃ©ciaux dans les en-tÃªtes de l'e-mail.
- Limitez les caractÃ¨res autorisÃ©s dans les champs de saisie utilisateur.
- Utilisez des bibliothÃ¨ques ou des frameworks sÃ©curisÃ©s pour gÃ©rer l'envoi d'e-mails.

En suivant ces bonnes pratiques, vous pouvez rÃ©duire considÃ©rablement les risques d'exploitation de la fonction mail() de PHP.
```bash
# The function has the following definition:

php --rf mail

Function [ <internal:standard> function mail ] {
- Parameters [5] {
Parameter #0 [ <required> $to ]
Parameter #1 [ <required> $subject ]
Parameter #2 [ <required> $message ]
Parameter #3 [ <optional> $additional_headers ]
Parameter #4 [ <optional> $additional_parameters ]
}
}
```
#### Le 5Ã¨me paramÃ¨tre ($additional\_parameters)

Cette section va se baser sur **comment exploiter ce paramÃ¨tre en supposant qu'un attaquant le contrÃ´le**.

Ce paramÃ¨tre va Ãªtre ajoutÃ© Ã  la ligne de commande que PHP va utiliser pour invoquer le binaire sendmail. Cependant, il sera nettoyÃ© avec la fonction `escapeshellcmd($additional_parameters)`.

Un attaquant peut **injecter des paramÃ¨tres supplÃ©mentaires pour sendmail** dans ce cas.

#### DiffÃ©rences dans la mise en Å“uvre de /usr/sbin/sendmail

L'interface **sendmail** est **fournie par le logiciel de messagerie MTA** (Sendmail, Postfix, Exim, etc.) installÃ© sur le systÃ¨me. Bien que la **fonctionnalitÃ© de base** (comme les paramÃ¨tres -t -i -f) reste **la mÃªme** pour des raisons de compatibilitÃ©, **d'autres fonctions et paramÃ¨tres** varient considÃ©rablement en fonction du MTA installÃ©.

Voici quelques exemples de diffÃ©rentes pages de manuel de la commande/interface sendmail :

* Sendmail MTA : http://www.sendmail.org/\~ca/email/man/sendmail.html
* Postfix MTA : http://www.postfix.org/mailq.1.html
* Exim MTA : https://linux.die.net/man/8/eximReferences

Selon l'**origine du binaire sendmail**, diffÃ©rentes options ont Ã©tÃ© dÃ©couvertes pour les exploiter et **exfiltrer des fichiers ou mÃªme exÃ©cuter des commandes arbitraires**. DÃ©couvrez comment dans [**https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html**](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)

## Injection dans le nom de l'e-mail

### Parties ignorÃ©es d'un e-mail

Les symboles : **+, -** et **{}** peuvent parfois Ãªtre utilisÃ©s pour le marquage et ignorÃ©s par la plupart des serveurs de messagerie

* Par exemple : john.doe+intigriti@example.com â†’ john.doe@example.com

Les **commentaires entre parenthÃ¨ses ()** au dÃ©but ou Ã  la fin seront Ã©galement ignorÃ©s

* Par exemple : john.doe(intigriti)@example.com â†’ john.doe@example.com

### Contournement de la liste blanche

<figure><img src="../.gitbook/assets/image (4) (6).png" alt=""><figcaption></figcaption></figure>

### Guillemets

<figure><img src="../.gitbook/assets/image (6) (4).png" alt=""><figcaption></figcaption></figure>

### Adresses IP

Vous pouvez Ã©galement utiliser des adresses IP comme noms de domaine entre crochets :

* john.doe@\[127.0.0.1]
* john.doe@\[IPv6:2001:db8::1]

### Autres vulnÃ©rabilitÃ©s

![](<../.gitbook/assets/image (296).png>)

## SSO tiers

### XSS

Certains services comme **github** ou **salesforce vous permettent de crÃ©er une **adresse e-mail avec des charges XSS**. Si vous pouvez **utiliser ces fournisseurs pour vous connecter Ã  d'autres services** et que ces services ne **nettoient pas correctement** l'e-mail, vous pourriez provoquer une **XSS**.

### Prise de contrÃ´le de compte

Si un **service SSO** vous permet de **crÃ©er un compte sans vÃ©rifier l'adresse e-mail fournie** (comme **salesforce**) et que vous pouvez ensuite utiliser ce compte pour **vous connecter Ã  un autre service** qui **fait confiance** Ã  salesforce, vous pourriez accÃ©der Ã  n'importe quel compte.\
Notez que salesforce indique si l'e-mail fourni a Ã©tÃ© vÃ©rifiÃ© ou non, mais l'application devrait tenir compte de cette information.

## RÃ©pondre Ã 

Vous pouvez envoyer un e-mail en utilisant _**From: company.com**_\*\* \*\* et _**Replay-To: attacker.com**_ et si une **rÃ©ponse automatique** est envoyÃ©e en raison de l'envoi de l'e-mail **Ã  partir** d'une **adresse interne**, l'**attaquant** pourrait Ãªtre en mesure de **recevoir** cette **rÃ©ponse**.

## Taux de rebond Ã©levÃ©

Certaines applications comme AWS ont un **taux de rebond Ã©levÃ©** (chez AWS, il est de 10%), ce qui signifie que lorsque le service de messagerie est surchargÃ©, le service d'e-mails est bloquÃ©.

Un **rebond dur** est un **e-mail** qui n'a pas pu Ãªtre livrÃ© pour des raisons permanentes. Peut-Ãªtre que l'**adresse e-mail** est fausse, peut-Ãªtre que le domaine de l'**e-mail** n'est pas un vrai domaine, ou peut-Ãªtre que le serveur du destinataire de l'**e-mail** n'accepte pas les **e-mails**), cela signifie que sur un total de 1000 e-mails, si 100 d'entre eux Ã©taient faux ou invalides et ont tous rebondi, **AWS SES** bloquera votre service.

Ainsi, si vous Ãªtes capable d'**envoyer des e-mails (peut-Ãªtre des invitations)** depuis l'application web vers n'importe quelle adresse e-mail, vous pourriez provoquer ce blocage en envoyant des centaines d'invitations Ã  des utilisateurs et des domaines inexistants : **DÃ©ni de service du service de messagerie**.

## RÃ©fÃ©rences

* [https://resources.infosecinstitute.com/email-injection/](https://resources.infosecinstitute.com/email-injection/)
* [https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)
* [https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view](https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view)
* [https://www.youtube.com/watch?app=desktop\&v=4ZsTKvfP1g0](https://www.youtube.com/watch?app=desktop\&v=4ZsTKvfP1g0)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* Vous travaillez dans une **entreprise de cybersÃ©curitÃ©** ? Vous voulez voir votre **entreprise annoncÃ©e dans HackTricks** ? ou voulez-vous avoir accÃ¨s Ã  la **derniÃ¨re version de PEASS ou tÃ©lÃ©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* DÃ©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="/.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>
Utilisez [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) pour construire et **automatiser les flux de travail** en utilisant les outils communautaires les plus avancÃ©s au monde.\
AccÃ©dez dÃ¨s aujourd'hui :

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}
